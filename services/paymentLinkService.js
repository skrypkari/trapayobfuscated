'use strict';function a45_0x3094(){const _0x560af2=['__esModule','ONCE','rapyd','KLYME\x20EU','./gateways/coinToPayService','map','klymeService','update','282451AcSgSP','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','toString','\x20enabled\x20gateways:','üá¨üáß\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','validateKlymeCurrency','\x20\x20\x20üíæ\x20DB\x20Fail\x20URL:\x20','checkGatewayPermission','\x20(8digits-8digits\x20format)','convertToUSDT','../types/gateway','PaymentLinkService','language','\x20\x20\x20üåê\x20Gateway\x20Success\x20URL:\x20','Unsupported\x20gateway:\x20','initiatePaymentFromLink','paymentLink','üîó\x20Rapyd\x20payment\x20URL:\x20','join','üìà\x20Payment\x20','getPublicPaymentLinkData','error','Payment\x20link\x20has\x20expired','currentPayments','\x20already\x20at\x20max\x20payments\x20(','noda','nodaService','sourceCurrency','generateGatewayOrderId','\x22\x20is\x20allowed\x20for\x20shop\x20','coinToPayService','EUR','PENDING','Anonymous','invoice_total_sum','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','toLowerCase','shopId','\x20(8digits-8digits\x20format\x20for\x20','\x20not\x20found','currencyService','count','10072638rIDLWw','failUrl','gateway','insensitive','Payment\x20','payment_url','\x22\x20is\x20in\x20enabled\x20gateways:','expiresAt','maxPayments','shop','toISOString','\x20status\x20is\x20','üîó\x20Noda\x20payment\x20URL:\x20','‚úÖ\x20Gateway\x20\x22','224MxLITH','deletePaymentLink','includes','rapydService','https://tesoft.uk/gateway/payment.php?id=','status','no\x20email','__importDefault','https://tesoft.uk','Invalid\x20gateway\x20ID:\x20','Payment\x20link\x20','üíæ\x20DB\x20Success\x20URL:\x20','https://app.trapay.uk/payment/','temp','\x20payment\x20link','all','FAILED','üîó\x20Plisio\x20payment\x20URL:\x20','üí∞\x20Amount:\x20','PAID','payment','https://tesoft.uk/gateways/noda/webhook','cointopay','createPaymentLink','amount','üîê\x20Checking\x20if\x20\x22','1357098WNgqOP','createPayment','üîê\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','‚úÖ\x20DB\x20Success\x20URL:\x20','COMPLETED','env','üîó\x20Generated\x20URLs\x20for\x20','round','getKlymeRegionFromGatewayName','\x20completed\x20(reached\x20max\x20payments:\x20','‚úÖ\x20Payment\x20link\x20created:\x20','üîó\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','floor','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','paymentGateways','üí∞\x20Plisio\x20payment\x20link\x20mapping:','üí≥\x20Creating\x20KLYME\x20','2725thzTMz','üìà\x20Payment\x20link\x20','delete','Unsupported\x20KLYME\x20region:\x20','paidAt','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','Gateway\x20error:\x20','‚ùå\x20Gateway\x20\x22','currency','toUpperCase','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','formatPaymentLinkResponse','qr_code','üîó\x20Link\x20URL:\x20https://app.trapay.uk/link/','\x20payment\x20URL:\x20','log','ACTIVE','getPaymentLinkById','getGatewayNameById','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','length','paymentLinkId','https://app.trapay.uk/payment/success?id=','‚ùå\x20Enabled\x20gateways:\x20','./gateways/klymeService','KLYME\x20DE','PlisioService','startsWith','üèÅ\x20Payment\x20link\x20','CoinToPay','country','üîê\x20Shop\x20','ü™ô\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','getGatewayDisplayName','payments','qr_code_url','Enabled\x20gateways:\x20','findUnique','GBP','Plisio','username','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','ceil','KLYME\x20GB','create','updatePaymentLink','default','Error\x20parsing\x20payment\x20gateways:','üí≥\x20Initiating\x20payment\x20from\x20link\x20','plisioService','./gateways/nodaService','Rapyd','USD','amount\x20is\x20required\x20and\x20must\x20be\x20positive','findMany','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','üìà\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','getPaymentLinkStatistics','getPaymentLinks','üéØ\x20Generated\x20gateway\x20order_id:\x20','CoinToPayService','random','NodaService','gateway_payment_id','klyme_','Gateway\x20not\x20found\x20for\x20ID:\x20','generateGatewayUrls','Payment\x20link\x20is\x20not\x20active','Noda','https://app.trapay.uk/payment/pending?id=','isValidGatewayId','Shop\x20is\x20not\x20active','desc','\x20\x20\x20üåê\x20Gateway\x20Fail\x20URL:\x20',',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','/gateway/pending.php?id=','plisio','/gateway/success.php?id=','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','./gateways/plisioService','209128HkWaEu','üîó\x20KLYME\x20','\x20\x20\x20üíæ\x20DB\x20Success\x20URL:\x20','147114gmlzWe','Payment\x20link\x20has\x20reached\x20maximum\x20payments','BASE_URL','1328hDKWcW','\x20using\x20default\x20gateways:','RapydService','\x20counter\x20updated:\x20','‚ùå\x20DB\x20Fail\x20URL:\x20','3561216znLaPO','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','successUrl'];a45_0x3094=function(){return _0x560af2;};return a45_0x3094();}const a45_0x359300=a45_0x106e;(function(_0x401e47,_0x2b5147){const _0x56b2df=a45_0x106e,_0x2ef6a1=_0x401e47();while(!![]){try{const _0x390208=parseInt(_0x56b2df(0x141))/0x1+-parseInt(_0x56b2df(0x12e))/0x2+parseInt(_0x56b2df(0xc9))/0x3+-parseInt(_0x56b2df(0x131))/0x4*(-parseInt(_0x56b2df(0xdb))/0x5)+-parseInt(_0x56b2df(0x136))/0x6+-parseInt(_0x56b2df(0xaf))/0x7*(parseInt(_0x56b2df(0x12b))/0x8)+parseInt(_0x56b2df(0x16b))/0x9;if(_0x390208===_0x2b5147)break;else _0x2ef6a1['push'](_0x2ef6a1['shift']());}catch(_0x396f83){_0x2ef6a1['push'](_0x2ef6a1['shift']());}}}(a45_0x3094,0x81b86));var __importDefault=this&&this[a45_0x359300(0xb6)]||function(_0x399927){const _0x162203=a45_0x359300;return _0x399927&&_0x399927[_0x162203(0x139)]?_0x399927:{'default':_0x399927};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a45_0x359300(0x12a)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a45_0x359300(0x10d)),coinToPayService_1=require(a45_0x359300(0x13d)),klymeService_1=require(a45_0x359300(0xf3)),gateway_1=require(a45_0x359300(0x14b)),currencyService_1=require('./currencyService');function a45_0x106e(_0x28a10b,_0x106a83){const _0x3094a8=a45_0x3094();return a45_0x106e=function(_0x106e07,_0x5dab08){_0x106e07=_0x106e07-0xa3;let _0x26e66f=_0x3094a8[_0x106e07];return _0x26e66f;},a45_0x106e(_0x28a10b,_0x106a83);}class PaymentLinkService{constructor(){const _0x525340=a45_0x359300;this[_0x525340(0x10c)]=new plisioService_1[(_0x525340(0xf5))](),this[_0x525340(0xb2)]=new rapydService_1[(_0x525340(0x133))](),this[_0x525340(0x15b)]=new nodaService_1[(_0x525340(0x119))](),this[_0x525340(0x15f)]=new coinToPayService_1[(_0x525340(0x117))](),this[_0x525340(0x13f)]=new klymeService_1['KlymeService']();}['generateGatewayOrderId'](){const _0x5d3cd8=()=>{const _0x210a28=a45_0x106e;return Math[_0x210a28(0xd6)](Math[_0x210a28(0x118)]()*0x5f5e100)[_0x210a28(0x143)]()['padStart'](0x8,'0');};return _0x5d3cd8()+'-'+_0x5d3cd8();}[a45_0x359300(0x11d)](_0x4760d6,_0x51856d,_0x3b228f,_0x591ab0,_0x56ed50){const _0x1a90a4=a45_0x359300;if(_0x591ab0&&_0x56ed50)return{'finalSuccessUrl':_0x591ab0,'finalFailUrl':_0x56ed50,'dbSuccessUrl':_0x591ab0,'dbFailUrl':_0x56ed50};let _0xf54fa5,_0x31c9fe,_0x4d47a2,_0x63aaf9;return _0x4760d6===_0x1a90a4(0x15a)||_0x4760d6[_0x1a90a4(0xf6)]('klyme_')?(_0xf54fa5=_0x3b228f+_0x1a90a4(0x126)+_0x51856d,_0x4d47a2=_0x1a90a4(0x120)+_0x51856d):(_0xf54fa5=_0x3b228f+_0x1a90a4(0x128)+_0x51856d,_0x4d47a2=_0x1a90a4(0xf1)+_0x51856d),_0x31c9fe=_0x3b228f+'/gateway/fail.php?id='+_0x51856d,_0x63aaf9='https://app.trapay.uk/payment/fail?id='+_0x51856d,console['log'](_0x1a90a4(0xd0)+_0x4760d6+':'),console['log'](_0x1a90a4(0x14e)+_0xf54fa5),console[_0x1a90a4(0xea)](_0x1a90a4(0x124)+_0x31c9fe),console['log'](_0x1a90a4(0x12d)+_0x4d47a2),console[_0x1a90a4(0xea)](_0x1a90a4(0x147)+_0x63aaf9),{'finalSuccessUrl':_0xf54fa5,'finalFailUrl':_0x31c9fe,'dbSuccessUrl':_0x4d47a2,'dbFailUrl':_0x63aaf9};}[a45_0x359300(0x146)](_0x2555cf,_0x27be0e){const _0x2f8974=a45_0x359300;if(!_0x2555cf[_0x2f8974(0xf6)](_0x2f8974(0x11b)))return;const _0x19fc79=(0x0,gateway_1[_0x2f8974(0xd2)])(_0x2555cf),_0x1f6fff=_0x27be0e[_0x2f8974(0xe4)]();switch(_0x19fc79){case'EU':if(_0x1f6fff!==_0x2f8974(0x160))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x1f6fff);break;case'GB':if(_0x1f6fff!==_0x2f8974(0x101))throw new Error(_0x2f8974(0x142)+_0x1f6fff);break;case'DE':if(_0x1f6fff!==_0x2f8974(0x160))throw new Error(_0x2f8974(0x104)+_0x1f6fff);break;default:throw new Error(_0x2f8974(0xde)+_0x19fc79);}}async[a45_0x359300(0x148)](_0x10173a,_0x39b73f){const _0x59c8a3=a45_0x359300;console[_0x59c8a3(0xea)](_0x59c8a3(0xcb)+_0x10173a+':\x20'+_0x39b73f);const _0x122594=await database_1[_0x59c8a3(0x109)][_0x59c8a3(0xaa)][_0x59c8a3(0x100)]({'where':{'id':_0x10173a},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x122594)throw new Error('Shop\x20not\x20found');let _0xa0edb7=[];if(_0x122594[_0x59c8a3(0xd8)])try{_0xa0edb7=JSON['parse'](_0x122594[_0x59c8a3(0xd8)]),console[_0x59c8a3(0xea)]('üîê\x20Shop\x20'+_0x122594['username']+_0x59c8a3(0x144),_0xa0edb7);}catch(_0x2e4800){console[_0x59c8a3(0x156)](_0x59c8a3(0x10a),_0x2e4800),_0xa0edb7=[_0x59c8a3(0x102)];}else _0xa0edb7=[_0x59c8a3(0x102)],console[_0x59c8a3(0xea)](_0x59c8a3(0xfa)+_0x122594[_0x59c8a3(0x103)]+_0x59c8a3(0x132),_0xa0edb7);const _0xc6b1e4=this[_0x59c8a3(0xfc)](_0x39b73f);console['log'](_0x59c8a3(0xc8)+_0xc6b1e4+_0x59c8a3(0xa7),_0xa0edb7);if(!_0xa0edb7[_0x59c8a3(0xb1)](_0xc6b1e4)){console[_0x59c8a3(0x156)](_0x59c8a3(0xe2)+_0xc6b1e4+'\x22\x20not\x20allowed\x20for\x20shop\x20'+_0x122594['username']),console[_0x59c8a3(0x156)](_0x59c8a3(0xf2)+_0xa0edb7[_0x59c8a3(0x153)](',\x20'));throw new Error('Gateway\x20\x22'+_0xc6b1e4+_0x59c8a3(0xe5)+(_0x59c8a3(0xff)+_0xa0edb7[_0x59c8a3(0x153)](',\x20')+'.\x20')+'Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.');}console[_0x59c8a3(0xea)](_0x59c8a3(0xae)+_0xc6b1e4+_0x59c8a3(0x15e)+_0x122594['username']);}[a45_0x359300(0xfc)](_0x271c85){const _0x297535=a45_0x359300,_0x48db99={'plisio':_0x297535(0x102),'rapyd':_0x297535(0x10e),'noda':_0x297535(0x11f),'cointopay':_0x297535(0xf8),'klyme_eu':_0x297535(0x13c),'klyme_gb':_0x297535(0x106),'klyme_de':_0x297535(0xf4)};return _0x48db99[_0x271c85]||_0x271c85;}async[a45_0x359300(0xc6)](_0x59ade6,_0x440ea6){const _0x23ea56=a45_0x359300;if(!(0x0,gateway_1[_0x23ea56(0x121)])(_0x440ea6[_0x23ea56(0xa3)]))throw new Error(_0x23ea56(0xb8)+_0x440ea6[_0x23ea56(0xa3)]+_0x23ea56(0x137));const _0x2a21e4=(0x0,gateway_1[_0x23ea56(0xed)])(_0x440ea6[_0x23ea56(0xa3)]);if(!_0x2a21e4)throw new Error(_0x23ea56(0x11c)+_0x440ea6[_0x23ea56(0xa3)]);console[_0x23ea56(0xea)](_0x23ea56(0xd5)+_0x2a21e4),await this[_0x23ea56(0x148)](_0x59ade6,_0x2a21e4);if(_0x2a21e4===_0x23ea56(0x127)&&!_0x440ea6[_0x23ea56(0x15c)])throw new Error(_0x23ea56(0xd7));if(_0x2a21e4[_0x23ea56(0xf6)](_0x23ea56(0x11b))){const _0x10fd0f=(0x0,gateway_1[_0x23ea56(0xd2)])(_0x2a21e4);console[_0x23ea56(0xea)](_0x23ea56(0xda)+_0x10fd0f+_0x23ea56(0xbd));}let _0x1a42f4=_0x440ea6[_0x23ea56(0xf9)];_0x2a21e4===_0x23ea56(0x13b)&&(_0x1a42f4='GB',console[_0x23ea56(0xea)](_0x23ea56(0x145)));if(!_0x440ea6[_0x23ea56(0xc7)]||_0x440ea6[_0x23ea56(0xc7)]<=0x0)throw new Error(_0x23ea56(0x110));let _0x2bc478=_0x440ea6[_0x23ea56(0xe3)]||_0x23ea56(0x10f);_0x2a21e4===_0x23ea56(0xc5)&&(_0x2bc478='EUR',console['log'](_0x23ea56(0xfb)));this[_0x23ea56(0x146)](_0x2a21e4,_0x2bc478);const _0x97c533=await database_1['default'][_0x23ea56(0x151)]['create']({'data':{'shopId':_0x59ade6,'amount':_0x440ea6['amount'],'currency':_0x2bc478,'sourceCurrency':_0x440ea6[_0x23ea56(0x15c)]||undefined,'gateway':_0x2a21e4,'maxPayments':_0x440ea6[_0x23ea56(0xa9)]||0x1,'currentPayments':0x0,'status':_0x23ea56(0xeb),'expiresAt':_0x440ea6[_0x23ea56(0xa8)]?new Date(_0x440ea6['expiresAt']):undefined,'successUrl':_0x23ea56(0xbc),'failUrl':'temp','country':_0x1a42f4,'language':_0x440ea6[_0x23ea56(0x14d)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x5742e2=process['env']['BASE_URL']||_0x23ea56(0xb7),{finalSuccessUrl:_0x33dd77,finalFailUrl:_0x54366a,dbSuccessUrl:_0x35877d,dbFailUrl:_0x207ee6}=this[_0x23ea56(0x11d)](_0x2a21e4,_0x97c533['id'],_0x5742e2,_0x440ea6[_0x23ea56(0x138)],_0x440ea6[_0x23ea56(0x16c)]),_0x1ad45b=await database_1['default'][_0x23ea56(0x151)][_0x23ea56(0x140)]({'where':{'id':_0x97c533['id']},'data':{'successUrl':_0x35877d,'failUrl':_0x207ee6},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x23ea56(0xea)](_0x23ea56(0xd4)+_0x1ad45b['id']+'\x20('+_0x2a21e4+')'),console[_0x23ea56(0xea)]('üí∞\x20Fixed\x20amount:\x20'+_0x1ad45b['amount']+'\x20'+_0x1ad45b['currency']),console[_0x23ea56(0xea)](_0x23ea56(0xe8)+_0x1ad45b['id']),console['log'](_0x23ea56(0xcd)+_0x1ad45b[_0x23ea56(0x138)]),console[_0x23ea56(0xea)](_0x23ea56(0x135)+_0x1ad45b['failUrl']),this[_0x23ea56(0xe6)](_0x1ad45b);}async[a45_0x359300(0x115)](_0x2cfe67,_0x2f9819){const _0x2c1c69=a45_0x359300,{page:_0x178b2d,limit:_0x276712,status:_0x138bbe,gateway:_0x14844a,search:_0x57cbe2}=_0x2f9819,_0x13289d=(_0x178b2d-0x1)*_0x276712,_0xe7e1f2={'shopId':_0x2cfe67};_0x138bbe&&(_0xe7e1f2[_0x2c1c69(0xb4)]=_0x138bbe[_0x2c1c69(0xe4)]());if(_0x14844a){if((0x0,gateway_1['isValidGatewayId'])(_0x14844a)){const _0x269931=(0x0,gateway_1[_0x2c1c69(0xed)])(_0x14844a);_0x269931&&(_0xe7e1f2['gateway']=_0x269931);}else _0xe7e1f2[_0x2c1c69(0xa3)]=_0x14844a[_0x2c1c69(0x165)]();}_0x57cbe2&&(_0xe7e1f2['OR']=[{'gateway':{'contains':_0x57cbe2,'mode':_0x2c1c69(0xa4)}},{'currency':{'contains':_0x57cbe2,'mode':_0x2c1c69(0xa4)}}]);const [_0x27264e,_0x5ac615]=await Promise['all']([database_1[_0x2c1c69(0x109)][_0x2c1c69(0x151)][_0x2c1c69(0x111)]({'where':_0xe7e1f2,'skip':_0x13289d,'take':_0x276712,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x2c1c69(0x123)},'take':0xa}}}),database_1['default'][_0x2c1c69(0x151)][_0x2c1c69(0x16a)]({'where':_0xe7e1f2})]);return{'links':_0x27264e[_0x2c1c69(0x13e)](_0x354d6d=>this['formatPaymentLinkResponse'](_0x354d6d)),'pagination':{'page':_0x178b2d,'limit':_0x276712,'total':_0x5ac615,'totalPages':Math[_0x2c1c69(0x105)](_0x5ac615/_0x276712)}};}async[a45_0x359300(0xec)](_0x9ffaaf,_0x4a1154){const _0x2b02b5=a45_0x359300,_0x352649=await database_1['default']['paymentLink']['findFirst']({'where':{'id':_0x4a1154,'shopId':_0x9ffaaf},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x2b02b5(0x123)}}}});if(!_0x352649)return null;return this[_0x2b02b5(0xe6)](_0x352649);}async[a45_0x359300(0x108)](_0x203c39,_0x38db35,_0x3308bb){const _0x371bd1=a45_0x359300,_0x499a2b={..._0x3308bb};if(_0x3308bb[_0x371bd1(0xa3)]){if((0x0,gateway_1[_0x371bd1(0x121)])(_0x3308bb[_0x371bd1(0xa3)])){const _0x152b84=(0x0,gateway_1[_0x371bd1(0xed)])(_0x3308bb[_0x371bd1(0xa3)]);_0x152b84&&(await this[_0x371bd1(0x148)](_0x203c39,_0x152b84),_0x499a2b[_0x371bd1(0xa3)]=_0x152b84);}else _0x499a2b[_0x371bd1(0xa3)]=_0x3308bb[_0x371bd1(0xa3)]['toLowerCase']();}(_0x499a2b[_0x371bd1(0xa3)]===_0x371bd1(0x13b)||_0x3308bb['country']&&_0x499a2b[_0x371bd1(0xa3)]!=='rapyd')&&(_0x499a2b[_0x371bd1(0xa3)]===_0x371bd1(0x13b)&&(_0x499a2b['country']='GB',console[_0x371bd1(0xea)]('üá¨üáß\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update')));_0x499a2b['gateway']==='cointopay'&&(_0x499a2b[_0x371bd1(0xe3)]=_0x371bd1(0x160),console[_0x371bd1(0xea)]('ü™ô\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update'));_0x499a2b[_0x371bd1(0xa3)]&&_0x499a2b[_0x371bd1(0xe3)]&&this[_0x371bd1(0x146)](_0x499a2b[_0x371bd1(0xa3)],_0x499a2b[_0x371bd1(0xe3)]);_0x3308bb[_0x371bd1(0xa8)]&&(_0x499a2b['expiresAt']=new Date(_0x3308bb[_0x371bd1(0xa8)]));const _0xa216ee=await database_1[_0x371bd1(0x109)][_0x371bd1(0x151)]['update']({'where':{'id':_0x38db35,'shopId':_0x203c39},'data':_0x499a2b,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x371bd1(0x123)},'take':0xa}}});return this[_0x371bd1(0xe6)](_0xa216ee);}async[a45_0x359300(0xb0)](_0x43d07d,_0x343631){const _0x3570a9=a45_0x359300;await database_1[_0x3570a9(0x109)][_0x3570a9(0x151)][_0x3570a9(0xdd)]({'where':{'id':_0x343631,'shopId':_0x43d07d}});}async[a45_0x359300(0x155)](_0x531a9f){const _0x3c79c4=a45_0x359300,_0x16f0db=await database_1['default'][_0x3c79c4(0x151)][_0x3c79c4(0x100)]({'where':{'id':_0x531a9f},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x16f0db)return null;const _0x5a70ba=_0x16f0db[_0x3c79c4(0xa8)]&&_0x16f0db[_0x3c79c4(0xa8)]<new Date(),_0x22a368=_0x16f0db[_0x3c79c4(0x158)]>=_0x16f0db[_0x3c79c4(0xa9)],_0x8a5e0e=_0x16f0db[_0x3c79c4(0xaa)][_0x3c79c4(0xb4)]===_0x3c79c4(0xeb),_0x3f6c30=_0x16f0db[_0x3c79c4(0xb4)]===_0x3c79c4(0xeb),_0x56d673=!_0x5a70ba&&!_0x22a368&&_0x8a5e0e&&_0x3f6c30,_0x8aaa62=Math['max'](0x0,_0x16f0db[_0x3c79c4(0xa9)]-_0x16f0db[_0x3c79c4(0x158)]);return{'id':_0x16f0db['id'],'amount':_0x16f0db[_0x3c79c4(0xc7)],'currency':_0x16f0db[_0x3c79c4(0xe3)],'sourceCurrency':_0x16f0db[_0x3c79c4(0x15c)]||undefined,'gateway':_0x16f0db[_0x3c79c4(0xa3)],'maxPayments':_0x16f0db[_0x3c79c4(0xa9)],'currentPayments':_0x16f0db[_0x3c79c4(0x158)],'status':_0x16f0db[_0x3c79c4(0xb4)],'expiresAt':_0x16f0db[_0x3c79c4(0xa8)]||undefined,'shopName':_0x16f0db['shop']['name'],'isAvailable':_0x56d673,'remainingPayments':_0x8aaa62};}async[a45_0x359300(0x150)](_0x23819f){const _0x533ab1=a45_0x359300,{linkId:_0x5c3754,customerEmail:_0x1bc554,customerName:_0x14443f}=_0x23819f,_0x1206d2=await database_1['default']['paymentLink'][_0x533ab1(0x100)]({'where':{'id':_0x5c3754},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x1206d2)throw new Error('Payment\x20link\x20not\x20found');const _0x15e877=_0x1206d2[_0x533ab1(0xa8)]&&_0x1206d2['expiresAt']<new Date(),_0x1624df=_0x1206d2[_0x533ab1(0x158)]>=_0x1206d2[_0x533ab1(0xa9)],_0x413edb=_0x1206d2[_0x533ab1(0xaa)][_0x533ab1(0xb4)]===_0x533ab1(0xeb),_0x31a9bb=_0x1206d2[_0x533ab1(0xb4)]===_0x533ab1(0xeb);if(_0x15e877)throw new Error(_0x533ab1(0x157));if(_0x1624df)throw new Error(_0x533ab1(0x12f));if(!_0x413edb)throw new Error(_0x533ab1(0x122));if(!_0x31a9bb)throw new Error(_0x533ab1(0x11e));await this[_0x533ab1(0x148)](_0x1206d2[_0x533ab1(0x166)],_0x1206d2[_0x533ab1(0xa3)]);const _0x3480d1=_0x1206d2['amount'];console[_0x533ab1(0xea)](_0x533ab1(0x10b)+_0x5c3754+':\x20'+_0x3480d1+'\x20'+_0x1206d2[_0x533ab1(0xe3)]),console[_0x533ab1(0xea)]('üë§\x20Customer:\x20'+(_0x14443f||_0x533ab1(0x162))+'\x20('+(_0x1bc554||_0x533ab1(0xb5))+')'),this['validateKlymeCurrency'](_0x1206d2[_0x533ab1(0xa3)],_0x1206d2[_0x533ab1(0xe3)]);const _0x222295=this[_0x533ab1(0x15d)]();console[_0x533ab1(0xea)](_0x533ab1(0x116)+_0x222295+_0x533ab1(0x167)+_0x1206d2[_0x533ab1(0xa3)]+')');const _0x11f787=process[_0x533ab1(0xcf)][_0x533ab1(0x130)]||_0x533ab1(0xb7),{finalSuccessUrl:_0xd6366c,finalFailUrl:_0x48e0eb,dbSuccessUrl:_0x31dee9,dbFailUrl:_0x4a6880}=this[_0x533ab1(0x11d)](_0x1206d2[_0x533ab1(0xa3)],_0x222295,_0x11f787,_0x1206d2[_0x533ab1(0x138)]||undefined,_0x1206d2[_0x533ab1(0x16c)]||undefined),_0x5567f2=await database_1['default'][_0x533ab1(0xc3)][_0x533ab1(0x107)]({'data':{'shopId':_0x1206d2[_0x533ab1(0x166)],'paymentLinkId':_0x1206d2['id'],'gateway':_0x1206d2[_0x533ab1(0xa3)],'amount':_0x3480d1,'currency':_0x1206d2[_0x533ab1(0xe3)],'sourceCurrency':_0x1206d2[_0x533ab1(0x15c)]||undefined,'usage':_0x533ab1(0x13a),'expiresAt':_0x1206d2[_0x533ab1(0xa8)]||undefined,'successUrl':_0x31dee9,'failUrl':_0x4a6880,'status':_0x533ab1(0x161),'orderId':null,'gatewayOrderId':_0x222295,'customerEmail':_0x1bc554||undefined,'customerName':_0x14443f||undefined,'country':_0x1206d2['country']||undefined,'language':_0x1206d2[_0x533ab1(0x14d)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x533ab1(0xea)]('üíæ\x20Payment\x20created\x20from\x20link:\x20'+_0x5567f2['id']),console['log'](_0x533ab1(0xc1)+_0x3480d1+'\x20'+_0x1206d2['currency']),console['log']('üë§\x20Customer:\x20'+(_0x14443f||_0x533ab1(0x162))+'\x20('+(_0x1bc554||_0x533ab1(0xb5))+')'),console[_0x533ab1(0xea)](_0x533ab1(0xba)+_0x31dee9),console['log']('üíæ\x20DB\x20Fail\x20URL:\x20'+_0x4a6880);let _0x2a552d,_0x11661d;try{if(_0x1206d2[_0x533ab1(0xa3)]===_0x533ab1(0x127)){console['log'](_0x533ab1(0xd9)),console['log'](_0x533ab1(0x112)+_0x1206d2[_0x533ab1(0xe3)]),console['log'](_0x533ab1(0xee)+_0x1206d2[_0x533ab1(0x15c)]);const _0x40abb6=await this[_0x533ab1(0x10c)][_0x533ab1(0xca)]({'paymentId':_0x5567f2['id'],'orderId':_0x222295,'amount':_0x3480d1,'currency':_0x1206d2['currency'],'productName':_0x533ab1(0xa5)+_0x3480d1+'\x20'+_0x1206d2['currency'],'description':'Payment\x20'+_0x3480d1+'\x20'+_0x1206d2[_0x533ab1(0xe3)],'successUrl':_0xd6366c,'failUrl':_0x48e0eb,'customerEmail':_0x1bc554||undefined,'customerName':_0x14443f||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x1206d2[_0x533ab1(0x15c)]||undefined});_0x2a552d=_0x40abb6[_0x533ab1(0x11a)],_0x11661d=_0x40abb6[_0x533ab1(0xa6)],await database_1[_0x533ab1(0x109)][_0x533ab1(0xc3)][_0x533ab1(0x140)]({'where':{'id':_0x5567f2['id']},'data':{'externalPaymentUrl':_0x11661d,'gatewayPaymentId':_0x2a552d,'invoiceTotalSum':Number(_0x40abb6[_0x533ab1(0x163)]),'qrCode':_0x40abb6[_0x533ab1(0xe7)],'qrUrl':_0x40abb6['qr_url']}});const _0x11b245=_0x533ab1(0xbb)+_0x5567f2['id'];return console['log'](_0x533ab1(0xc0)+_0x11b245),{'paymentId':_0x5567f2['id'],'paymentUrl':_0x11b245,'expiresAt':_0x5567f2[_0x533ab1(0xa8)]||undefined};}else{if(_0x1206d2[_0x533ab1(0xa3)]===_0x533ab1(0x13b)){const _0x574fe7=await this[_0x533ab1(0xb2)]['createPaymentLink']({'paymentId':_0x5567f2['id'],'orderId':_0x222295,'orderName':_0x533ab1(0xa5)+_0x3480d1+'\x20'+_0x1206d2[_0x533ab1(0xe3)],'amount':_0x3480d1,'currency':_0x1206d2['currency'],'country':_0x1206d2[_0x533ab1(0xf9)],'language':_0x1206d2['language']||'EN','amountIsEditable':![],'usage':_0x533ab1(0x13a),'maxPayments':0x1,'successUrl':_0xd6366c,'failUrl':_0x48e0eb});_0x2a552d=_0x574fe7[_0x533ab1(0x11a)],_0x11661d=_0x574fe7[_0x533ab1(0xa6)],await database_1['default']['payment']['update']({'where':{'id':_0x5567f2['id']},'data':{'externalPaymentUrl':_0x11661d,'gatewayPaymentId':_0x2a552d}});const _0x36775a=_0x533ab1(0xb3)+_0x5567f2['id'];return console[_0x533ab1(0xea)](_0x533ab1(0x152)+_0x36775a),{'paymentId':_0x5567f2['id'],'paymentUrl':_0x36775a,'expiresAt':_0x5567f2[_0x533ab1(0xa8)]||undefined};}else{if(_0x1206d2[_0x533ab1(0xa3)]===_0x533ab1(0x15a)){const _0x2ac1fe=await this[_0x533ab1(0x15b)][_0x533ab1(0xc6)]({'paymentId':_0x5567f2['id'],'orderId':_0x222295,'name':_0x533ab1(0xa5)+_0x3480d1+'\x20'+_0x1206d2[_0x533ab1(0xe3)],'paymentDescription':'Payment\x20'+_0x3480d1+'\x20'+_0x1206d2[_0x533ab1(0xe3)],'amount':_0x3480d1,'currency':_0x1206d2[_0x533ab1(0xe3)],'webhookUrl':_0x533ab1(0xc4),'returnUrl':_0xd6366c,'expiryDate':_0x1206d2[_0x533ab1(0xa8)]?.[_0x533ab1(0xab)]()});_0x2a552d=_0x2ac1fe[_0x533ab1(0x11a)],_0x11661d=_0x2ac1fe['payment_url'],await database_1[_0x533ab1(0x109)]['payment'][_0x533ab1(0x140)]({'where':{'id':_0x5567f2['id']},'data':{'externalPaymentUrl':_0x11661d,'gatewayPaymentId':_0x2a552d,'qrUrl':_0x2ac1fe[_0x533ab1(0xfe)]}});const _0x12e35a=_0x533ab1(0xb3)+_0x5567f2['id'];return console[_0x533ab1(0xea)](_0x533ab1(0xad)+_0x12e35a),{'paymentId':_0x5567f2['id'],'paymentUrl':_0x12e35a,'expiresAt':_0x5567f2[_0x533ab1(0xa8)]||undefined};}else{if(_0x1206d2[_0x533ab1(0xa3)]==='cointopay'){console['log']('ü™ô\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x222295+'\x20(8digits-8digits\x20format)'),console[_0x533ab1(0xea)]('üí∞\x20Amount:\x20'+_0x3480d1+_0x533ab1(0xcc));const _0x3ac3d5=await this[_0x533ab1(0x15f)]['createPaymentLink']({'paymentId':_0x5567f2['id'],'orderId':_0x222295,'amount':_0x3480d1});_0x2a552d=_0x3ac3d5['gateway_payment_id'],_0x11661d=_0x3ac3d5['payment_url'],await database_1['default'][_0x533ab1(0xc3)]['update']({'where':{'id':_0x5567f2['id']},'data':{'externalPaymentUrl':_0x11661d,'gatewayPaymentId':_0x2a552d}});const _0x4fbef5=_0x533ab1(0xb3)+_0x5567f2['id'];return console['log']('üîó\x20CoinToPay\x20payment\x20URL:\x20'+_0x4fbef5),{'paymentId':_0x5567f2['id'],'paymentUrl':_0x4fbef5,'expiresAt':_0x5567f2[_0x533ab1(0xa8)]||undefined};}else{if(_0x1206d2[_0x533ab1(0xa3)]['startsWith'](_0x533ab1(0x11b))){const _0x4f6f6c=(0x0,gateway_1[_0x533ab1(0xd2)])(_0x1206d2['gateway']);if(!_0x4f6f6c)throw new Error('Invalid\x20KLYME\x20gateway:\x20'+_0x1206d2[_0x533ab1(0xa3)]);console['log']('üí≥\x20Creating\x20KLYME\x20'+_0x4f6f6c+_0x533ab1(0x129)+_0x222295+_0x533ab1(0x149)),console['log'](_0x533ab1(0xc1)+_0x3480d1+'\x20'+_0x1206d2[_0x533ab1(0xe3)]+'\x20(validated\x20for\x20'+_0x4f6f6c+')');const _0x583d13=await this['klymeService'][_0x533ab1(0xc6)]({'paymentId':_0x5567f2['id'],'orderId':_0x222295,'amount':_0x3480d1,'currency':_0x1206d2[_0x533ab1(0xe3)],'region':_0x4f6f6c,'redirectUrl':_0xd6366c});_0x2a552d=_0x583d13[_0x533ab1(0x11a)],_0x11661d=_0x583d13['payment_url'],await database_1[_0x533ab1(0x109)][_0x533ab1(0xc3)]['update']({'where':{'id':_0x5567f2['id']},'data':{'externalPaymentUrl':_0x11661d,'gatewayPaymentId':_0x2a552d}});const _0x31f20b=_0x533ab1(0xbb)+_0x5567f2['id'];return console[_0x533ab1(0xea)]('‚úÖ\x20KLYME\x20'+_0x4f6f6c+_0x533ab1(0xe0)+_0x222295),console[_0x533ab1(0xea)](_0x533ab1(0x12c)+_0x4f6f6c+_0x533ab1(0xe9)+_0x31f20b),{'paymentId':_0x5567f2['id'],'paymentUrl':_0x31f20b,'expiresAt':_0x5567f2['expiresAt']||undefined};}else throw new Error(_0x533ab1(0x14f)+_0x1206d2[_0x533ab1(0xa3)]);}}}}}catch(_0x5058f2){await database_1[_0x533ab1(0x109)][_0x533ab1(0xc3)][_0x533ab1(0x140)]({'where':{'id':_0x5567f2['id']},'data':{'status':_0x533ab1(0xbf)}});throw new Error(_0x533ab1(0xe1)+(_0x5058f2 instanceof Error?_0x5058f2['message']:'Unknown\x20error'));}}async['handleSuccessfulPayment'](_0x576b0e){const _0xbaaa2a=a45_0x359300;console['log'](_0xbaaa2a(0x113)+_0x576b0e);const _0x3eaa99=await database_1[_0xbaaa2a(0x109)]['payment']['findUnique']({'where':{'id':_0x576b0e},'include':{'paymentLink':!![]}});if(!_0x3eaa99||!_0x3eaa99['paymentLink']){console[_0xbaaa2a(0xea)](_0xbaaa2a(0x154)+_0x576b0e+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update');return;}if(_0x3eaa99[_0xbaaa2a(0xb4)]!=='PAID'){console[_0xbaaa2a(0xea)](_0xbaaa2a(0x154)+_0x576b0e+_0xbaaa2a(0xac)+_0x3eaa99[_0xbaaa2a(0xb4)]+_0xbaaa2a(0x125));return;}if(!_0x3eaa99[_0xbaaa2a(0xdf)]){console[_0xbaaa2a(0xea)](_0xbaaa2a(0x154)+_0x576b0e+_0xbaaa2a(0x164));return;}try{const _0x4e0f5e=await database_1[_0xbaaa2a(0x109)]['$transaction'](async _0x52f0ad=>{const _0x23d7e3=_0xbaaa2a,_0xbd34a1=await _0x52f0ad[_0x23d7e3(0x151)]['findUnique']({'where':{'id':_0x3eaa99['paymentLinkId']},'select':{'id':!![],'currentPayments':!![],'maxPayments':!![],'status':!![]}});if(!_0xbd34a1)throw new Error(_0x23d7e3(0xb9)+_0x3eaa99[_0x23d7e3(0xf0)]+_0x23d7e3(0x168));if(_0xbd34a1[_0x23d7e3(0x158)]>=_0xbd34a1[_0x23d7e3(0xa9)])return console[_0x23d7e3(0xea)](_0x23d7e3(0xdc)+_0x3eaa99[_0x23d7e3(0xf0)]+_0x23d7e3(0x159)+_0xbd34a1[_0x23d7e3(0x158)]+'/'+_0xbd34a1['maxPayments']+'),\x20skipping\x20increment'),_0xbd34a1;const _0x3f1e61=await _0x52f0ad[_0x23d7e3(0xc3)][_0x23d7e3(0x16a)]({'where':{'paymentLinkId':_0x3eaa99[_0x23d7e3(0xf0)],'status':_0x23d7e3(0xc2),'paidAt':{'not':null},'id':{'not':_0x576b0e}}}),_0x10d5b8=_0x3f1e61+0x1,_0x42b7a7=await _0x52f0ad[_0x23d7e3(0x151)]['update']({'where':{'id':_0x3eaa99[_0x23d7e3(0xf0)]},'data':{'currentPayments':_0x10d5b8,'status':_0x10d5b8>=_0xbd34a1[_0x23d7e3(0xa9)]?_0x23d7e3(0xce):_0xbd34a1['status']}});return console[_0x23d7e3(0xea)](_0x23d7e3(0xdc)+_0x3eaa99['paymentLinkId']+_0x23d7e3(0x134)+_0xbd34a1[_0x23d7e3(0x158)]+'\x20->\x20'+_0x10d5b8+'/'+_0xbd34a1[_0x23d7e3(0xa9)]),_0x42b7a7;});_0x4e0f5e[_0xbaaa2a(0xb4)]==='COMPLETED'&&console[_0xbaaa2a(0xea)](_0xbaaa2a(0xf7)+_0x3eaa99[_0xbaaa2a(0xf0)]+_0xbaaa2a(0xd3)+_0x4e0f5e[_0xbaaa2a(0x158)]+'/'+_0x4e0f5e['maxPayments']+')');}catch(_0x399f1a){console[_0xbaaa2a(0x156)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20'+_0x576b0e+':',_0x399f1a);}}async[a45_0x359300(0x114)](_0x26fd33){const _0x216133=a45_0x359300,[_0x8eda68,_0x32fd6f,_0x314bbe,_0xb6ca62]=await Promise[_0x216133(0xbe)]([database_1[_0x216133(0x109)][_0x216133(0x151)]['count']({'where':{'shopId':_0x26fd33}}),database_1['default'][_0x216133(0x151)][_0x216133(0x16a)]({'where':{'shopId':_0x26fd33,'status':_0x216133(0xeb)}}),database_1[_0x216133(0x109)][_0x216133(0xc3)]['count']({'where':{'shopId':_0x26fd33,'paymentLinkId':{'not':null}}}),database_1['default'][_0x216133(0xc3)]['findMany']({'where':{'shopId':_0x26fd33,'paymentLinkId':{'not':null},'status':_0x216133(0xc2)},'select':{'amount':!![],'currency':!![]}})]);let _0xfef1b0=0x0;for(const _0x3ab964 of _0xb6ca62){const _0x45812b=await currencyService_1[_0x216133(0x169)][_0x216133(0x14a)](_0x3ab964[_0x216133(0xc7)],_0x3ab964[_0x216133(0xe3)]);_0xfef1b0+=_0x45812b;}const _0x5f3cb8=_0x314bbe>0x0?_0xb6ca62[_0x216133(0xef)]/_0x314bbe*0x64:0x0;return{'totalLinks':_0x8eda68,'activeLinks':_0x32fd6f,'totalPayments':_0x314bbe,'totalRevenue':Math[_0x216133(0xd1)](_0xfef1b0*0x64)/0x64,'conversionRate':Math['round'](_0x5f3cb8*0x64)/0x64};}[a45_0x359300(0xe6)](_0x55b881){const _0x5e6764=a45_0x359300;return{'id':_0x55b881['id'],'shopId':_0x55b881[_0x5e6764(0x166)],'amount':_0x55b881[_0x5e6764(0xc7)],'currency':_0x55b881[_0x5e6764(0xe3)],'sourceCurrency':_0x55b881[_0x5e6764(0x15c)]||undefined,'gateway':_0x55b881[_0x5e6764(0xa3)],'maxPayments':_0x55b881[_0x5e6764(0xa9)],'currentPayments':_0x55b881[_0x5e6764(0x158)],'status':_0x55b881['status'],'expiresAt':_0x55b881[_0x5e6764(0xa8)]||undefined,'successUrl':_0x55b881['successUrl']||undefined,'failUrl':_0x55b881[_0x5e6764(0x16c)]||undefined,'country':_0x55b881[_0x5e6764(0xf9)]||undefined,'language':_0x55b881[_0x5e6764(0x14d)]||undefined,'linkUrl':'https://app.trapay.uk/link/'+_0x55b881['id'],'createdAt':_0x55b881['createdAt'],'updatedAt':_0x55b881['updatedAt'],'shop':_0x55b881[_0x5e6764(0xaa)],'payments':_0x55b881[_0x5e6764(0xfd)]};}}exports[a45_0x359300(0x14c)]=PaymentLinkService;