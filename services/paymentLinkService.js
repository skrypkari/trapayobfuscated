'use strict';const a45_0xcae7c0=a45_0xdbaa;function a45_0xdbaa(_0x593d62,_0x444145){const _0x12032b=a45_0x1203();return a45_0xdbaa=function(_0xdbaad9,_0x54031f){_0xdbaad9=_0xdbaad9-0x147;let _0x122638=_0x12032b[_0xdbaad9];return _0x122638;},a45_0xdbaa(_0x593d62,_0x444145);}(function(_0x5d4f60,_0x50d271){const _0x5e570f=a45_0xdbaa,_0x1d0565=_0x5d4f60();while(!![]){try{const _0x2fd39c=parseInt(_0x5e570f(0x190))/0x1+parseInt(_0x5e570f(0x157))/0x2+parseInt(_0x5e570f(0x1de))/0x3*(parseInt(_0x5e570f(0x198))/0x4)+-parseInt(_0x5e570f(0x1cd))/0x5*(-parseInt(_0x5e570f(0x1a6))/0x6)+-parseInt(_0x5e570f(0x156))/0x7+parseInt(_0x5e570f(0x154))/0x8*(parseInt(_0x5e570f(0x168))/0x9)+-parseInt(_0x5e570f(0x194))/0xa;if(_0x2fd39c===_0x50d271)break;else _0x1d0565['push'](_0x1d0565['shift']());}catch(_0x55d8f1){_0x1d0565['push'](_0x1d0565['shift']());}}}(a45_0x1203,0x1b9f3));var __importDefault=this&&this[a45_0xcae7c0(0x1a3)]||function(_0x4df5b6){const _0x4a40ce=a45_0xcae7c0;return _0x4df5b6&&_0x4df5b6[_0x4a40ce(0x14b)]?_0x4df5b6:{'default':_0x4df5b6};};function a45_0x1203(){const _0x474240=['126GOULXM','./gateways/plisioService','\x20(8digits-8digits\x20format)','ACTIVE','https://tesoft.uk/gateway/payment.php?id=','findUnique','currency','updatePaymentLink','✅\x20DB\x20Success\x20URL:\x20','round','\x20payment\x20URL:\x20','klymeService','getPaymentLinkById','../config/database','📈\x20Payment\x20link\x20','\x20completed\x20(reached\x20max\x20payments)','map','💰\x20Fixed\x20amount:\x20','🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','createPaymentLink','sourceCurrency','PENDING','💰\x20Plisio\x20payment\x20link\x20mapping:','GBP','💳\x20Creating\x20KLYME\x20','default','\x20(validated\x20for\x20','max','insensitive','toString','all','Payment\x20link\x20has\x20expired','Payment\x20link\x20has\x20reached\x20maximum\x20payments','findMany','status','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','plisioService','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','paymentLinkId','107868liPHxF','no\x20email','noda','createdAt','3245430UkregA','convertToUSDT','generateGatewayOrderId','💾\x20DB\x20Success\x20URL:\x20','12cFRaHZ','currencyService','shopId','❌\x20DB\x20Fail\x20URL:\x20','PLACEHOLDER','toISOString','💾\x20Payment\x20created\x20from\x20link:\x20','nodaService','expiresAt','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','💳\x20Initiating\x20payment\x20from\x20link\x20','__importDefault','isValidGatewayId','/gateway/fail.php?id=','18UuoPJo','validateKlymeCurrency','count','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/','coinToPayService','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','desc','Payment\x20','generateGatewayUrls','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','payment','https://app.trapay.uk/payment/pending','Invalid\x20gateway\x20ID:\x20','paymentLink','USD','amount','💾\x20DB\x20Fail\x20URL:\x20','🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','Unsupported\x20gateway:\x20','padStart','getKlymeRegionFromGatewayName','gateway_payment_id','rapyd','toLowerCase','./currencyService','../types/gateway','plisio','log','PaymentLinkService','BASE_URL','getGatewayNameById','PlisioService','✅\x20Payment\x20link\x20created:\x20','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','./gateways/nodaService','rapydService','🏁\x20Payment\x20link\x20','create','297015gFQNAP','🔗\x20Noda\x20payment\x20URL:\x20','👤\x20Customer:\x20','🎯\x20Generated\x20gateway\x20order_id:\x20','findFirst','currentPayments','ceil','Unsupported\x20KLYME\x20region:\x20','Anonymous','gateway','./gateways/klymeService','country','payment_url','maxPayments','getPaymentLinks','klyme_','floor','64707mHKRlX','\x20payment\x20link','delete','\x20(8digits-8digits\x20format\x20for\x20','https://app.trapay.uk/payment/success','cointopay','🔗\x20CoinToPay\x20payment\x20URL:\x20','language','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','startsWith','https://app.trapay.uk/payment/','successUrl','amount\x20is\x20required\x20and\x20must\x20be\x20positive','failUrl','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','handleSuccessfulPayment','/gateway/success.php?id=','createPayment','__esModule','PAID','update','\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','EUR','66184UEJsFi','COMPLETED','1047277gUfDeG','241374ZGdWjV','RapydService','deletePaymentLink','payments','shop','invoice_total_sum','env','/gateway/pending.php?id=','qr_url','💰\x20Amount:\x20','https://app.trapay.uk/link/','🔗\x20KLYME\x20','https://tesoft.uk','message','🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','qr_code','🔗\x20Rapyd\x20payment\x20URL:\x20'];a45_0x1203=function(){return _0x474240;};return a45_0x1203();}Object['defineProperty'](exports,a45_0xcae7c0(0x14b),{'value':!![]}),exports[a45_0xcae7c0(0x1c3)]=void 0x0;const database_1=__importDefault(require(a45_0xcae7c0(0x175))),plisioService_1=require(a45_0xcae7c0(0x169)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a45_0xcae7c0(0x1c9)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require(a45_0xcae7c0(0x1d7)),gateway_1=require(a45_0xcae7c0(0x1c0)),currencyService_1=require(a45_0xcae7c0(0x1bf));class PaymentLinkService{constructor(){const _0x2ea6f0=a45_0xcae7c0;this['plisioService']=new plisioService_1[(_0x2ea6f0(0x1c6))](),this[_0x2ea6f0(0x1ca)]=new rapydService_1[(_0x2ea6f0(0x158))](),this[_0x2ea6f0(0x19f)]=new nodaService_1['NodaService'](),this['coinToPayService']=new coinToPayService_1['CoinToPayService'](),this['klymeService']=new klymeService_1['KlymeService']();}[a45_0xcae7c0(0x196)](){const _0x5166d4=()=>{const _0x4714fc=a45_0xdbaa;return Math[_0x4714fc(0x1dd)](Math['random']()*0x5f5e100)[_0x4714fc(0x185)]()[_0x4714fc(0x1ba)](0x8,'0');};return _0x5166d4()+'-'+_0x5166d4();}['generateGatewayUrls'](_0x4aa294,_0x2d8d23,_0x289d97,_0x3cc282,_0x425521){const _0x345941=a45_0xcae7c0;if(_0x3cc282&&_0x425521)return{'finalSuccessUrl':_0x3cc282,'finalFailUrl':_0x425521,'dbSuccessUrl':_0x3cc282,'dbFailUrl':_0x425521};let _0x2c8f74,_0xad8726,_0x113be7,_0x42f25f;return _0x4aa294===_0x345941(0x192)||_0x4aa294[_0x345941(0x1e7)](_0x345941(0x1dc))?(_0x2c8f74=_0x289d97+_0x345941(0x15e)+_0x2d8d23,_0x113be7=_0x345941(0x1b2)):(_0x2c8f74=_0x289d97+_0x345941(0x149)+_0x2d8d23,_0x113be7=_0x345941(0x1e2)),_0xad8726=_0x289d97+_0x345941(0x1a5)+_0x2d8d23,_0x42f25f='https://app.trapay.uk/payment/fail',console[_0x345941(0x1c2)]('🔗\x20Generated\x20URLs\x20for\x20'+_0x4aa294+':'),console[_0x345941(0x1c2)](_0x345941(0x152)+_0x2c8f74),console[_0x345941(0x1c2)](_0x345941(0x150)+_0xad8726),console[_0x345941(0x1c2)](_0x345941(0x1a9)+_0x113be7),console[_0x345941(0x1c2)](_0x345941(0x14e)+_0x42f25f),{'finalSuccessUrl':_0x2c8f74,'finalFailUrl':_0xad8726,'dbSuccessUrl':_0x113be7,'dbFailUrl':_0x42f25f};}[a45_0xcae7c0(0x1a7)](_0x4fd75b,_0xb90163){const _0x2936ea=a45_0xcae7c0;if(!_0x4fd75b[_0x2936ea(0x1e7)](_0x2936ea(0x1dc)))return;const _0x1944d3=(0x0,gateway_1[_0x2936ea(0x1bb)])(_0x4fd75b),_0x4c734e=_0xb90163['toUpperCase']();switch(_0x1944d3){case'EU':if(_0x4c734e!=='EUR')throw new Error(_0x2936ea(0x1a1)+_0x4c734e);break;case'GB':if(_0x4c734e!==_0x2936ea(0x17f))throw new Error(_0x2936ea(0x1ac)+_0x4c734e);break;case'DE':if(_0x4c734e!==_0x2936ea(0x153))throw new Error(_0x2936ea(0x151)+_0x4c734e);break;default:throw new Error(_0x2936ea(0x1d4)+_0x1944d3);}}async[a45_0xcae7c0(0x17b)](_0x47b995,_0x1f4cde){const _0x5003ce=a45_0xcae7c0;if(!(0x0,gateway_1[_0x5003ce(0x1a4)])(_0x1f4cde['gateway']))throw new Error(_0x5003ce(0x1b3)+_0x1f4cde['gateway']+_0x5003ce(0x18e));const _0x3a7f1e=(0x0,gateway_1[_0x5003ce(0x1c5)])(_0x1f4cde['gateway']);if(!_0x3a7f1e)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x1f4cde[_0x5003ce(0x1d6)]);console[_0x5003ce(0x1c2)](_0x5003ce(0x17a)+_0x3a7f1e);if(_0x3a7f1e===_0x5003ce(0x1c1)&&!_0x1f4cde[_0x5003ce(0x17c)])throw new Error('sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links');if(_0x3a7f1e[_0x5003ce(0x1e7)](_0x5003ce(0x1dc))){const _0x2d9dcd=(0x0,gateway_1[_0x5003ce(0x1bb)])(_0x3a7f1e);console[_0x5003ce(0x1c2)](_0x5003ce(0x180)+_0x2d9dcd+_0x5003ce(0x1df));}let _0x33bbf2=_0x1f4cde[_0x5003ce(0x1d8)];_0x3a7f1e==='rapyd'&&(_0x33bbf2='GB',console['log'](_0x5003ce(0x1e6)));if(!_0x1f4cde[_0x5003ce(0x1b6)]||_0x1f4cde[_0x5003ce(0x1b6)]<=0x0)throw new Error(_0x5003ce(0x1ea));let _0x1d0a80=_0x1f4cde[_0x5003ce(0x16e)]||_0x5003ce(0x1b5);_0x3a7f1e==='cointopay'&&(_0x1d0a80=_0x5003ce(0x153),console[_0x5003ce(0x1c2)](_0x5003ce(0x1b8)));this[_0x5003ce(0x1a7)](_0x3a7f1e,_0x1d0a80);const _0xc8572e=process[_0x5003ce(0x15d)][_0x5003ce(0x1c4)]||_0x5003ce(0x163),{finalSuccessUrl:_0x713205,finalFailUrl:_0x1767c4,dbSuccessUrl:_0x55c22a,dbFailUrl:_0x302280}=this[_0x5003ce(0x1af)](_0x3a7f1e,_0x5003ce(0x19c),_0xc8572e,_0x1f4cde['successUrl'],_0x1f4cde['failUrl']),_0x2615ad=await database_1[_0x5003ce(0x181)][_0x5003ce(0x1b4)][_0x5003ce(0x1cc)]({'data':{'shopId':_0x47b995,'amount':_0x1f4cde[_0x5003ce(0x1b6)],'currency':_0x1d0a80,'sourceCurrency':_0x1f4cde[_0x5003ce(0x17c)]||undefined,'gateway':_0x3a7f1e,'maxPayments':_0x1f4cde['maxPayments']||0x1,'currentPayments':0x0,'status':_0x5003ce(0x16b),'expiresAt':_0x1f4cde[_0x5003ce(0x1a0)]?new Date(_0x1f4cde['expiresAt']):undefined,'successUrl':_0x55c22a,'failUrl':_0x302280,'country':_0x33bbf2,'language':_0x1f4cde['language']||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x5003ce(0x1c2)](_0x5003ce(0x1c7)+_0x2615ad['id']+'\x20('+_0x3a7f1e+')'),console[_0x5003ce(0x1c2)](_0x5003ce(0x179)+_0x2615ad[_0x5003ce(0x1b6)]+'\x20'+_0x2615ad[_0x5003ce(0x16e)]),console[_0x5003ce(0x1c2)](_0x5003ce(0x1aa)+_0x2615ad['id']),console['log'](_0x5003ce(0x170)+_0x2615ad['successUrl']),console[_0x5003ce(0x1c2)](_0x5003ce(0x19b)+_0x2615ad[_0x5003ce(0x1eb)]),this['formatPaymentLinkResponse'](_0x2615ad);}async[a45_0xcae7c0(0x1db)](_0x4f68cc,_0x1985c2){const _0x6e97a6=a45_0xcae7c0,{page:_0x587819,limit:_0xa341b9,status:_0x31096d,gateway:_0x316904,search:_0x40d6b0}=_0x1985c2,_0x5d823b=(_0x587819-0x1)*_0xa341b9,_0x36daf7={'shopId':_0x4f68cc};_0x31096d&&(_0x36daf7[_0x6e97a6(0x18a)]=_0x31096d['toUpperCase']());if(_0x316904){if((0x0,gateway_1['isValidGatewayId'])(_0x316904)){const _0x1975fe=(0x0,gateway_1['getGatewayNameById'])(_0x316904);_0x1975fe&&(_0x36daf7['gateway']=_0x1975fe);}else _0x36daf7[_0x6e97a6(0x1d6)]=_0x316904['toLowerCase']();}_0x40d6b0&&(_0x36daf7['OR']=[{'gateway':{'contains':_0x40d6b0,'mode':_0x6e97a6(0x184)}},{'currency':{'contains':_0x40d6b0,'mode':_0x6e97a6(0x184)}}]);const [_0x2cc11a,_0x2d752e]=await Promise[_0x6e97a6(0x186)]([database_1[_0x6e97a6(0x181)][_0x6e97a6(0x1b4)][_0x6e97a6(0x189)]({'where':_0x36daf7,'skip':_0x5d823b,'take':_0xa341b9,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}}),database_1['default'][_0x6e97a6(0x1b4)]['count']({'where':_0x36daf7})]);return{'links':_0x2cc11a[_0x6e97a6(0x178)](_0x1e4584=>this['formatPaymentLinkResponse'](_0x1e4584)),'pagination':{'page':_0x587819,'limit':_0xa341b9,'total':_0x2d752e,'totalPages':Math[_0x6e97a6(0x1d3)](_0x2d752e/_0xa341b9)}};}async[a45_0xcae7c0(0x174)](_0x52b062,_0x3d0ae6){const _0x550306=a45_0xcae7c0,_0xa19f4a=await database_1[_0x550306(0x181)][_0x550306(0x1b4)][_0x550306(0x1d1)]({'where':{'id':_0x3d0ae6,'shopId':_0x52b062},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x550306(0x1ad)}}}});if(!_0xa19f4a)return null;return this['formatPaymentLinkResponse'](_0xa19f4a);}async[a45_0xcae7c0(0x16f)](_0x6fcac0,_0x278fa0,_0x2bd066){const _0x108b0f=a45_0xcae7c0,_0x1c1fc2={..._0x2bd066};if(_0x2bd066[_0x108b0f(0x1d6)]){if((0x0,gateway_1[_0x108b0f(0x1a4)])(_0x2bd066['gateway'])){const _0x2ce864=(0x0,gateway_1[_0x108b0f(0x1c5)])(_0x2bd066['gateway']);_0x2ce864&&(_0x1c1fc2[_0x108b0f(0x1d6)]=_0x2ce864);}else _0x1c1fc2[_0x108b0f(0x1d6)]=_0x2bd066['gateway'][_0x108b0f(0x1be)]();}(_0x1c1fc2['gateway']===_0x108b0f(0x1bd)||_0x2bd066[_0x108b0f(0x1d8)]&&_0x1c1fc2[_0x108b0f(0x1d6)]!==_0x108b0f(0x1bd))&&(_0x1c1fc2[_0x108b0f(0x1d6)]==='rapyd'&&(_0x1c1fc2[_0x108b0f(0x1d8)]='GB',console[_0x108b0f(0x1c2)]('🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update')));_0x1c1fc2[_0x108b0f(0x1d6)]==='cointopay'&&(_0x1c1fc2['currency']=_0x108b0f(0x153),console[_0x108b0f(0x1c2)](_0x108b0f(0x1c8)));_0x1c1fc2[_0x108b0f(0x1d6)]&&_0x1c1fc2[_0x108b0f(0x16e)]&&this[_0x108b0f(0x1a7)](_0x1c1fc2['gateway'],_0x1c1fc2[_0x108b0f(0x16e)]);_0x2bd066['expiresAt']&&(_0x1c1fc2[_0x108b0f(0x1a0)]=new Date(_0x2bd066[_0x108b0f(0x1a0)]));const _0x4295b1=await database_1[_0x108b0f(0x181)][_0x108b0f(0x1b4)]['update']({'where':{'id':_0x278fa0,'shopId':_0x6fcac0},'data':_0x1c1fc2,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x108b0f(0x1ad)},'take':0xa}}});return this['formatPaymentLinkResponse'](_0x4295b1);}async[a45_0xcae7c0(0x159)](_0x542de5,_0x54e657){const _0x596b7b=a45_0xcae7c0;await database_1[_0x596b7b(0x181)][_0x596b7b(0x1b4)][_0x596b7b(0x1e0)]({'where':{'id':_0x54e657,'shopId':_0x542de5}});}async['getPublicPaymentLinkData'](_0x45cba7){const _0x50c8c0=a45_0xcae7c0,_0x76e07e=await database_1[_0x50c8c0(0x181)]['paymentLink']['findUnique']({'where':{'id':_0x45cba7},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x76e07e)return null;const _0x6018aa=_0x76e07e[_0x50c8c0(0x1a0)]&&_0x76e07e['expiresAt']<new Date(),_0x5329a6=_0x76e07e['currentPayments']>=_0x76e07e[_0x50c8c0(0x1da)],_0x300515=_0x76e07e[_0x50c8c0(0x15b)][_0x50c8c0(0x18a)]===_0x50c8c0(0x16b),_0x1fd457=_0x76e07e[_0x50c8c0(0x18a)]==='ACTIVE',_0x22eced=!_0x6018aa&&!_0x5329a6&&_0x300515&&_0x1fd457,_0x25279b=Math[_0x50c8c0(0x183)](0x0,_0x76e07e[_0x50c8c0(0x1da)]-_0x76e07e['currentPayments']);return{'id':_0x76e07e['id'],'amount':_0x76e07e['amount'],'currency':_0x76e07e[_0x50c8c0(0x16e)],'sourceCurrency':_0x76e07e[_0x50c8c0(0x17c)]||undefined,'gateway':_0x76e07e[_0x50c8c0(0x1d6)],'maxPayments':_0x76e07e[_0x50c8c0(0x1da)],'currentPayments':_0x76e07e[_0x50c8c0(0x1d2)],'status':_0x76e07e[_0x50c8c0(0x18a)],'expiresAt':_0x76e07e['expiresAt']||undefined,'shopName':_0x76e07e[_0x50c8c0(0x15b)]['name'],'isAvailable':_0x22eced,'remainingPayments':_0x25279b};}async['initiatePaymentFromLink'](_0x4bc6d2){const _0x1edd63=a45_0xcae7c0,{linkId:_0xda7970,customerEmail:_0x3d282d,customerName:_0x56e654}=_0x4bc6d2,_0x40bd0d=await database_1[_0x1edd63(0x181)][_0x1edd63(0x1b4)][_0x1edd63(0x16d)]({'where':{'id':_0xda7970},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![]}}}});if(!_0x40bd0d)throw new Error('Payment\x20link\x20not\x20found');const _0x4d7d77=_0x40bd0d['expiresAt']&&_0x40bd0d[_0x1edd63(0x1a0)]<new Date(),_0x2e0234=_0x40bd0d['currentPayments']>=_0x40bd0d[_0x1edd63(0x1da)],_0x24aa2a=_0x40bd0d['shop'][_0x1edd63(0x18a)]==='ACTIVE',_0x2bb313=_0x40bd0d[_0x1edd63(0x18a)]==='ACTIVE';if(_0x4d7d77)throw new Error(_0x1edd63(0x187));if(_0x2e0234)throw new Error(_0x1edd63(0x188));if(!_0x24aa2a)throw new Error('Shop\x20is\x20not\x20active');if(!_0x2bb313)throw new Error('Payment\x20link\x20is\x20not\x20active');const _0x3b110a=_0x40bd0d[_0x1edd63(0x1b6)];console['log'](_0x1edd63(0x1a2)+_0xda7970+':\x20'+_0x3b110a+'\x20'+_0x40bd0d['currency']),console[_0x1edd63(0x1c2)](_0x1edd63(0x1cf)+(_0x56e654||'Anonymous')+'\x20('+(_0x3d282d||_0x1edd63(0x191))+')'),this['validateKlymeCurrency'](_0x40bd0d[_0x1edd63(0x1d6)],_0x40bd0d[_0x1edd63(0x16e)]);const _0x19e779=this[_0x1edd63(0x196)]();console[_0x1edd63(0x1c2)](_0x1edd63(0x1d0)+_0x19e779+_0x1edd63(0x1e1)+_0x40bd0d[_0x1edd63(0x1d6)]+')');const _0x40f956=process[_0x1edd63(0x15d)]['BASE_URL']||_0x1edd63(0x163),{finalSuccessUrl:_0x481302,finalFailUrl:_0x13f283,dbSuccessUrl:_0xdc5658,dbFailUrl:_0x253be0}=this['generateGatewayUrls'](_0x40bd0d[_0x1edd63(0x1d6)],_0x19e779,_0x40f956,_0x40bd0d[_0x1edd63(0x1e9)]||undefined,_0x40bd0d[_0x1edd63(0x1eb)]||undefined),_0x55616c=await database_1['default'][_0x1edd63(0x1b1)][_0x1edd63(0x1cc)]({'data':{'shopId':_0x40bd0d[_0x1edd63(0x19a)],'paymentLinkId':_0x40bd0d['id'],'gateway':_0x40bd0d[_0x1edd63(0x1d6)],'amount':_0x3b110a,'currency':_0x40bd0d[_0x1edd63(0x16e)],'sourceCurrency':_0x40bd0d['sourceCurrency']||undefined,'usage':'ONCE','expiresAt':_0x40bd0d[_0x1edd63(0x1a0)]||undefined,'successUrl':_0xdc5658,'failUrl':_0x253be0,'status':_0x1edd63(0x17d),'orderId':null,'gatewayOrderId':_0x19e779,'customerEmail':_0x3d282d||undefined,'customerName':_0x56e654||undefined,'country':_0x40bd0d[_0x1edd63(0x1d8)]||undefined,'language':_0x40bd0d['language']||undefined,'amountIsEditable':![],'maxPayments':0x1}});console['log'](_0x1edd63(0x19e)+_0x55616c['id']),console[_0x1edd63(0x1c2)]('💰\x20Amount:\x20'+_0x3b110a+'\x20'+_0x40bd0d[_0x1edd63(0x16e)]),console[_0x1edd63(0x1c2)](_0x1edd63(0x1cf)+(_0x56e654||_0x1edd63(0x1d5))+'\x20('+(_0x3d282d||'no\x20email')+')'),console['log'](_0x1edd63(0x197)+_0xdc5658),console[_0x1edd63(0x1c2)](_0x1edd63(0x1b7)+_0x253be0);let _0x29a90b,_0x2f979b;try{if(_0x40bd0d[_0x1edd63(0x1d6)]===_0x1edd63(0x1c1)){console[_0x1edd63(0x1c2)](_0x1edd63(0x17e)),console[_0x1edd63(0x1c2)](_0x1edd63(0x14f)+_0x40bd0d[_0x1edd63(0x16e)]),console[_0x1edd63(0x1c2)](_0x1edd63(0x18b)+_0x40bd0d[_0x1edd63(0x17c)]);const _0x291883=await this[_0x1edd63(0x18d)][_0x1edd63(0x14a)]({'paymentId':_0x55616c['id'],'orderId':_0x19e779,'amount':_0x3b110a,'currency':_0x40bd0d[_0x1edd63(0x16e)],'productName':_0x1edd63(0x1ae)+_0x3b110a+'\x20'+_0x40bd0d[_0x1edd63(0x16e)],'description':_0x1edd63(0x1ae)+_0x3b110a+'\x20'+_0x40bd0d[_0x1edd63(0x16e)],'successUrl':_0x481302,'failUrl':_0x13f283,'customerEmail':_0x3d282d||undefined,'customerName':_0x56e654||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x40bd0d[_0x1edd63(0x17c)]||undefined});_0x29a90b=_0x291883[_0x1edd63(0x1bc)],_0x2f979b=_0x291883['payment_url'],await database_1[_0x1edd63(0x181)][_0x1edd63(0x1b1)][_0x1edd63(0x14d)]({'where':{'id':_0x55616c['id']},'data':{'externalPaymentUrl':_0x2f979b,'gatewayPaymentId':_0x29a90b,'invoiceTotalSum':Number(_0x291883[_0x1edd63(0x15c)]),'qrCode':_0x291883[_0x1edd63(0x166)],'qrUrl':_0x291883[_0x1edd63(0x15f)]}});const _0x21e60a=_0x1edd63(0x1e8)+_0x55616c['id'];return console['log']('🔗\x20Plisio\x20payment\x20URL:\x20'+_0x21e60a),{'paymentId':_0x55616c['id'],'paymentUrl':_0x21e60a,'expiresAt':_0x55616c['expiresAt']||undefined};}else{if(_0x40bd0d[_0x1edd63(0x1d6)]===_0x1edd63(0x1bd)){const _0x52d2cf=await this['rapydService']['createPaymentLink']({'paymentId':_0x55616c['id'],'orderId':_0x19e779,'orderName':_0x1edd63(0x1ae)+_0x3b110a+'\x20'+_0x40bd0d[_0x1edd63(0x16e)],'amount':_0x3b110a,'currency':_0x40bd0d[_0x1edd63(0x16e)],'country':_0x40bd0d[_0x1edd63(0x1d8)],'language':_0x40bd0d[_0x1edd63(0x1e5)]||'EN','amountIsEditable':![],'usage':'ONCE','maxPayments':0x1,'successUrl':_0x481302,'failUrl':_0x13f283});_0x29a90b=_0x52d2cf[_0x1edd63(0x1bc)],_0x2f979b=_0x52d2cf[_0x1edd63(0x1d9)],await database_1[_0x1edd63(0x181)][_0x1edd63(0x1b1)]['update']({'where':{'id':_0x55616c['id']},'data':{'externalPaymentUrl':_0x2f979b,'gatewayPaymentId':_0x29a90b}});const _0x53ce63=_0x1edd63(0x16c)+_0x55616c['id'];return console[_0x1edd63(0x1c2)](_0x1edd63(0x167)+_0x53ce63),{'paymentId':_0x55616c['id'],'paymentUrl':_0x53ce63,'expiresAt':_0x55616c[_0x1edd63(0x1a0)]||undefined};}else{if(_0x40bd0d['gateway']===_0x1edd63(0x192)){const _0x307083=await this[_0x1edd63(0x19f)][_0x1edd63(0x17b)]({'paymentId':_0x55616c['id'],'orderId':_0x19e779,'name':_0x1edd63(0x1ae)+_0x3b110a+'\x20'+_0x40bd0d['currency'],'paymentDescription':_0x1edd63(0x1ae)+_0x3b110a+'\x20'+_0x40bd0d['currency'],'amount':_0x3b110a,'currency':_0x40bd0d['currency'],'webhookUrl':'https://tesoft.uk/gateways/noda/webhook','returnUrl':_0x481302,'expiryDate':_0x40bd0d[_0x1edd63(0x1a0)]?.[_0x1edd63(0x19d)]()});_0x29a90b=_0x307083[_0x1edd63(0x1bc)],_0x2f979b=_0x307083['payment_url'],await database_1[_0x1edd63(0x181)]['payment']['update']({'where':{'id':_0x55616c['id']},'data':{'externalPaymentUrl':_0x2f979b,'gatewayPaymentId':_0x29a90b,'qrUrl':_0x307083['qr_code_url']}});const _0x4307b8='https://tesoft.uk/gateway/payment.php?id='+_0x55616c['id'];return console[_0x1edd63(0x1c2)](_0x1edd63(0x1ce)+_0x4307b8),{'paymentId':_0x55616c['id'],'paymentUrl':_0x4307b8,'expiresAt':_0x55616c['expiresAt']||undefined};}else{if(_0x40bd0d['gateway']===_0x1edd63(0x1e3)){console[_0x1edd63(0x1c2)](_0x1edd63(0x165)+_0x19e779+_0x1edd63(0x16a)),console[_0x1edd63(0x1c2)]('💰\x20Amount:\x20'+_0x3b110a+_0x1edd63(0x147));const _0xa56a80=await this[_0x1edd63(0x1ab)]['createPaymentLink']({'paymentId':_0x55616c['id'],'orderId':_0x19e779,'amount':_0x3b110a});_0x29a90b=_0xa56a80[_0x1edd63(0x1bc)],_0x2f979b=_0xa56a80[_0x1edd63(0x1d9)],await database_1[_0x1edd63(0x181)][_0x1edd63(0x1b1)][_0x1edd63(0x14d)]({'where':{'id':_0x55616c['id']},'data':{'externalPaymentUrl':_0x2f979b,'gatewayPaymentId':_0x29a90b}});const _0x43affe=_0x1edd63(0x16c)+_0x55616c['id'];return console[_0x1edd63(0x1c2)](_0x1edd63(0x1e4)+_0x43affe),{'paymentId':_0x55616c['id'],'paymentUrl':_0x43affe,'expiresAt':_0x55616c['expiresAt']||undefined};}else{if(_0x40bd0d[_0x1edd63(0x1d6)][_0x1edd63(0x1e7)](_0x1edd63(0x1dc))){const _0x5cb24d=(0x0,gateway_1[_0x1edd63(0x1bb)])(_0x40bd0d[_0x1edd63(0x1d6)]);if(!_0x5cb24d)throw new Error('Invalid\x20KLYME\x20gateway:\x20'+_0x40bd0d[_0x1edd63(0x1d6)]);console[_0x1edd63(0x1c2)](_0x1edd63(0x180)+_0x5cb24d+_0x1edd63(0x18c)+_0x19e779+'\x20(8digits-8digits\x20format)'),console[_0x1edd63(0x1c2)](_0x1edd63(0x160)+_0x3b110a+'\x20'+_0x40bd0d[_0x1edd63(0x16e)]+_0x1edd63(0x182)+_0x5cb24d+')');const _0x4f1049=await this[_0x1edd63(0x173)][_0x1edd63(0x17b)]({'paymentId':_0x55616c['id'],'orderId':_0x19e779,'amount':_0x3b110a,'currency':_0x40bd0d['currency'],'region':_0x5cb24d,'redirectUrl':_0x481302});_0x29a90b=_0x4f1049['gateway_payment_id'],_0x2f979b=_0x4f1049['payment_url'],await database_1[_0x1edd63(0x181)][_0x1edd63(0x1b1)][_0x1edd63(0x14d)]({'where':{'id':_0x55616c['id']},'data':{'externalPaymentUrl':_0x2f979b,'gatewayPaymentId':_0x29a90b}});const _0x1b9b79='https://app.trapay.uk/payment/'+_0x55616c['id'];return console[_0x1edd63(0x1c2)]('✅\x20KLYME\x20'+_0x5cb24d+_0x1edd63(0x1b0)+_0x19e779),console['log'](_0x1edd63(0x162)+_0x5cb24d+_0x1edd63(0x172)+_0x1b9b79),{'paymentId':_0x55616c['id'],'paymentUrl':_0x1b9b79,'expiresAt':_0x55616c['expiresAt']||undefined};}else throw new Error(_0x1edd63(0x1b9)+_0x40bd0d[_0x1edd63(0x1d6)]);}}}}}catch(_0x1ad820){await database_1[_0x1edd63(0x181)][_0x1edd63(0x1b1)][_0x1edd63(0x14d)]({'where':{'id':_0x55616c['id']},'data':{'status':'FAILED'}});throw new Error('Gateway\x20error:\x20'+(_0x1ad820 instanceof Error?_0x1ad820[_0x1edd63(0x164)]:'Unknown\x20error'));}}async[a45_0xcae7c0(0x148)](_0x56fa23){const _0x59d687=a45_0xcae7c0,_0x2a58af=await database_1['default'][_0x59d687(0x1b1)][_0x59d687(0x16d)]({'where':{'id':_0x56fa23},'include':{'paymentLink':!![]}});if(!_0x2a58af||!_0x2a58af[_0x59d687(0x1b4)])return;const _0x8f49b5=await database_1[_0x59d687(0x181)][_0x59d687(0x1b4)][_0x59d687(0x14d)]({'where':{'id':_0x2a58af[_0x59d687(0x18f)]},'data':{'currentPayments':{'increment':0x1}}});console[_0x59d687(0x1c2)](_0x59d687(0x176)+_0x2a58af[_0x59d687(0x18f)]+'\x20payments:\x20'+_0x8f49b5[_0x59d687(0x1d2)]+'/'+_0x8f49b5[_0x59d687(0x1da)]),_0x8f49b5[_0x59d687(0x1d2)]>=_0x8f49b5['maxPayments']&&(await database_1[_0x59d687(0x181)]['paymentLink'][_0x59d687(0x14d)]({'where':{'id':_0x2a58af['paymentLinkId']},'data':{'status':_0x59d687(0x155)}}),console[_0x59d687(0x1c2)](_0x59d687(0x1cb)+_0x2a58af[_0x59d687(0x18f)]+_0x59d687(0x177)));}async['getPaymentLinkStatistics'](_0x4610ac){const _0x1b1916=a45_0xcae7c0,[_0x61b2e5,_0xf980dd,_0x46dd74,_0x56fae3]=await Promise['all']([database_1['default'][_0x1b1916(0x1b4)][_0x1b1916(0x1a8)]({'where':{'shopId':_0x4610ac}}),database_1['default']['paymentLink'][_0x1b1916(0x1a8)]({'where':{'shopId':_0x4610ac,'status':_0x1b1916(0x16b)}}),database_1[_0x1b1916(0x181)]['payment'][_0x1b1916(0x1a8)]({'where':{'shopId':_0x4610ac,'paymentLinkId':{'not':null}}}),database_1[_0x1b1916(0x181)][_0x1b1916(0x1b1)][_0x1b1916(0x189)]({'where':{'shopId':_0x4610ac,'paymentLinkId':{'not':null},'status':_0x1b1916(0x14c)},'select':{'amount':!![],'currency':!![]}})]);let _0x49cb5c=0x0;for(const _0x1f9f1f of _0x56fae3){const _0x1f30ed=await currencyService_1[_0x1b1916(0x199)][_0x1b1916(0x195)](_0x1f9f1f[_0x1b1916(0x1b6)],_0x1f9f1f['currency']);_0x49cb5c+=_0x1f30ed;}const _0x3e6564=_0x46dd74>0x0?_0x56fae3['length']/_0x46dd74*0x64:0x0;return{'totalLinks':_0x61b2e5,'activeLinks':_0xf980dd,'totalPayments':_0x46dd74,'totalRevenue':Math[_0x1b1916(0x171)](_0x49cb5c*0x64)/0x64,'conversionRate':Math[_0x1b1916(0x171)](_0x3e6564*0x64)/0x64};}['formatPaymentLinkResponse'](_0x577ca1){const _0x30e62f=a45_0xcae7c0;return{'id':_0x577ca1['id'],'shopId':_0x577ca1[_0x30e62f(0x19a)],'amount':_0x577ca1[_0x30e62f(0x1b6)],'currency':_0x577ca1['currency'],'sourceCurrency':_0x577ca1[_0x30e62f(0x17c)]||undefined,'gateway':_0x577ca1[_0x30e62f(0x1d6)],'maxPayments':_0x577ca1['maxPayments'],'currentPayments':_0x577ca1[_0x30e62f(0x1d2)],'status':_0x577ca1[_0x30e62f(0x18a)],'expiresAt':_0x577ca1[_0x30e62f(0x1a0)]||undefined,'successUrl':_0x577ca1['successUrl']||undefined,'failUrl':_0x577ca1[_0x30e62f(0x1eb)]||undefined,'country':_0x577ca1[_0x30e62f(0x1d8)]||undefined,'language':_0x577ca1[_0x30e62f(0x1e5)]||undefined,'linkUrl':_0x30e62f(0x161)+_0x577ca1['id'],'createdAt':_0x577ca1[_0x30e62f(0x193)],'updatedAt':_0x577ca1['updatedAt'],'shop':_0x577ca1[_0x30e62f(0x15b)],'payments':_0x577ca1[_0x30e62f(0x15a)]};}}exports[a45_0xcae7c0(0x1c3)]=PaymentLinkService;