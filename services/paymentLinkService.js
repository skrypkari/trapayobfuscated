'use strict';const a50_0x495f13=a50_0x3956;function a50_0x3956(_0x1539e4,_0x2aa8fd){const _0x41f7eb=a50_0x41f7();return a50_0x3956=function(_0x39562f,_0x3148ea){_0x39562f=_0x39562f-0x192;let _0xb6b409=_0x41f7eb[_0x39562f];return _0xb6b409;},a50_0x3956(_0x1539e4,_0x2aa8fd);}(function(_0x550bee,_0x383382){const _0x47fbdf=a50_0x3956,_0x3a0e53=_0x550bee();while(!![]){try{const _0x111b22=parseInt(_0x47fbdf(0x23e))/0x1+parseInt(_0x47fbdf(0x27e))/0x2+parseInt(_0x47fbdf(0x22c))/0x3*(-parseInt(_0x47fbdf(0x26d))/0x4)+-parseInt(_0x47fbdf(0x198))/0x5+-parseInt(_0x47fbdf(0x20d))/0x6*(-parseInt(_0x47fbdf(0x268))/0x7)+-parseInt(_0x47fbdf(0x207))/0x8+-parseInt(_0x47fbdf(0x227))/0x9*(-parseInt(_0x47fbdf(0x295))/0xa);if(_0x111b22===_0x383382)break;else _0x3a0e53['push'](_0x3a0e53['shift']());}catch(_0x23cc40){_0x3a0e53['push'](_0x3a0e53['shift']());}}}(a50_0x41f7,0x2b6be));function a50_0x41f7(){const _0x4a835d=['Rapyd','1495136csaUFc','klyme_','startsWith','\x20\x20\x20💾\x20DB\x20Pending\x20URL:\x20','expiresAt','minAmount','6GnPOPD','country','no\x20email','./gateways/plisioService','insensitive','💰\x20No\x20minimum\x20amount\x20set\x20for\x20gateway\x20','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','\x20USDT)\x20exceeds\x20the\x20maximum\x20allowed\x20amount\x20of\x20','schedulePaymentChecks','\x20(8digits-8digits\x20format)','error','https://tesoft.uk/gateways/noda/webhook','initiatePaymentFromLink','🔗\x20Creating\x20','💳\x20Creating\x20MasterCard\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','💾\x20Payment\x20created:\x20','currentPayments','\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20','paymentGateways','multi-use','CoinToPay','noda','qr_url','\x20payments),\x20skipping\x20increment','KlymeService','/gateway/payment.php?id=','396RkunsW','plisioService','traffer.uk','MAX_SAFE_INTEGER','💰\x20Checking\x20amount\x20limits\x20for\x20gateway:\x20','942069SHIVnD','convertToUSDT','\x20USDT\x20for\x20gateway\x20','🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','🔐\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','deletePaymentLink','__importDefault','\x20USDT\x20for\x20','none','✅\x20Gateway\x20\x22','toUpperCase','🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','floor','Payment\x20link\x20not\x20found','plisio','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','Shop\x20not\x20found','\x20minimum\x20amount:\x20','205747ezhIaU','\x20USDT\x20meets\x20minimum\x20requirement\x20of\x20','append','random','\x20USDT\x20meets\x20maximum\x20requirement\x20of\x20','👤\x20Customer:\x20','✅\x20KLYME\x20','paidAt','gatewaySettings','\x20USDT\x20for\x20limit\x20checking','username','\x20with\x20payment\x20ID\x20','GBP','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','FAILED','maxAmount','\x20(validated\x20for\x20','🔗\x20No\x20whiteUrl\x20for\x20',',\x20amount:\x20','🔐\x20Checking\x20if\x20\x22','test_gateway','coinToPayService','coinToPay2Service','./gateways/nodaService','gateway','\x22\x20not\x20allowed\x20for\x20shop\x20','create','🔗\x20White\x20URL:\x20','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','temp','paymentLink','findUnique','\x22\x20is\x20allowed\x20for\x20shop\x20','💰\x20Shop\x20','✅\x20Payment\x20link\x20created:\x20','count','🔗\x20Noda\x20payment\x20URL:\x20','map','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','\x20link\x20','\x20payment\x20link','getPublicPaymentLinkData','1604393AYDZga','KLYME\x20GB','createdAt','log','Error\x20parsing\x20gateway\x20settings:','4dsWSxg','getPaymentLinks','Unsupported\x20gateway:\x20','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20','createPayment','\x20USDT','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','__esModule','checkGatewayPermission','amount','Open\x20Banking\x202','🏁\x20Payment\x20link\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update',',\x20gateway\x20','Payment\x20amount\x20','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','&payment_id=','28852UbqGPv','🔗\x20CoinToPay\x20payment\x20URL:\x20','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','padStart','CoinToPayService','Anonymous','📈\x20Payment\x20','Error\x20parsing\x20payment\x20gateways:',')\x20counter\x20updated:\x20','https://app.trapay.uk/payment/','mastercard','qr_code','❌\x20Gateway\x20\x22','Please\x20reduce\x20the\x20amount.','cointopay','currency','nodaService','gateway_payment_id','💰\x20No\x20maximum\x20amount\x20set\x20for\x20gateway\x20','PAID','https://tesoft.uk','\x20gateway.\x20','toString','70970ScLiLT','💾\x20DB\x20Pending\x20URL:\x20','paymentLinkId','isValidGatewayId','https://app.trapay.uk/payment/success?id=','amount\x20is\x20required\x20and\x20must\x20be\x20positive','Test\x20Gateway','findFirst','payment','getPaymentLinkStatistics','update','EUR','formatPaymentLinkResponse','CoinToPay2Service','Plisio','invoice_total_sum','Payment\x20','shop','\x20completed\x20(','414355VTEqHv','getPaymentLinkById','\x20payments)','📝\x20Note:\x20Success/Fail/Pending\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created','🔐\x20Shop\x20','currencyService','findMany','getKlymeRegionFromGatewayName','getGatewayNameById','💳\x20MasterCard\x20form\x20URL:\x20','validateKlymeCurrency','Gateway\x20error:\x20','../types/gateway','checkAmountLimits','all','/gateway/pending.php?id=','rapyd','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','Noda','💾\x20DB\x20Success\x20URL:\x20','name','language','join','PlisioService','Payment\x20link\x20is\x20not\x20active','cointopay2','🧪\x20Creating\x20Test\x20Gateway\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','generateGatewayUrls','📈\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','\x20\x20\x20🌐\x20Gateway\x20Pending\x20URL:\x20','🪙\x20Creating\x20CoinToPay2\x20(Open\x20Banking\x202)\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','pendingUrl','SINGLE','toFixed','updatedAt','❌\x20Amount\x20','💳\x20Creating\x20KLYME\x20','💱\x20Converted\x20','failUrl','./currencyService','\x20USDT)\x20is\x20below\x20the\x20minimum\x20required\x20amount\x20of\x20','handleSuccessfulPayment','./gateways/coinToPayService','🔗\x20Plisio\x20payment\x20URL:\x20','sourceCurrency','COMPLETED','./gateways/rapydService','\x20USDT\x20is\x20below\x20minimum\x20','payment_url','🔗\x20MasterCard\x20payment\x20URL:\x20','Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay2\x20payment:\x20','klymeService','$transaction','\x20(domain:\x20','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','📧\x20URL\x20параметры:','./gateways/klymeService','type','coinToPayStatusService','❌\x20Enabled\x20gateways:\x20','USD','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','🔗\x20CoinToPay2\x20(Open\x20Banking\x202)\x20payment\x20URL:\x20','NodaService','env','updatePaymentLink','\x20USDT\x20exceeds\x20maximum\x20','\x20to\x20','getGatewayDisplayName','status','successUrl','https://','default','\x20payment\x20link\x20update','ONCE','ACTIVE','\x20gateway\x20settings:','\x20not\x20found','💰\x20Gateway\x20','\x20status\x20is\x20','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','\x20->\x20','message','\x20using\x20default\x20gateways:','qr_code_url','createPaymentLink','💰\x20Plisio\x20payment\x20link\x20mapping:','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','desc','defineProperty','🔗\x20Rapyd\x20payment\x20URL:\x20','📈\x20Single\x20payment\x20link\x20','💰\x20Amount:\x20','Invalid\x20gateway\x20ID:\x20','./gateways/coinToPay2Service','PaymentLinkService','BASE_URL','payments','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20','✅\x20Amount\x20','Unsupported\x20KLYME\x20region:\x20','./coinToPayStatusService','generateGatewayOrderId','🔗\x20Generated\x20whiteUrl\x20for\x20','Invalid\x20KLYME\x20gateway:\x20','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','shopId'];a50_0x41f7=function(){return _0x4a835d;};return a50_0x41f7();}var __importDefault=this&&this[a50_0x495f13(0x232)]||function(_0x1ed2b1){const _0x38ab98=a50_0x495f13;return _0x1ed2b1&&_0x1ed2b1[_0x38ab98(0x274)]?_0x1ed2b1:{'default':_0x1ed2b1};};Object[a50_0x495f13(0x1f4)](exports,a50_0x495f13(0x274),{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a50_0x495f13(0x210)),rapydService_1=require(a50_0x495f13(0x1c7)),nodaService_1=require(a50_0x495f13(0x255)),coinToPayService_1=require(a50_0x495f13(0x1c3)),coinToPay2Service_1=require(a50_0x495f13(0x1f9)),klymeService_1=require(a50_0x495f13(0x1d3)),coinToPayStatusService_1=require(a50_0x495f13(0x200)),gateway_1=require(a50_0x495f13(0x1a4)),currencyService_1=require(a50_0x495f13(0x1c0));class PaymentLinkService{constructor(){const _0x488dc9=a50_0x495f13;this[_0x488dc9(0x228)]=new plisioService_1[(_0x488dc9(0x1b0))](),this['rapydService']=new rapydService_1['RapydService'](),this['nodaService']=new nodaService_1[(_0x488dc9(0x1da))](),this[_0x488dc9(0x253)]=new coinToPayService_1[(_0x488dc9(0x282))](),this[_0x488dc9(0x254)]=new coinToPay2Service_1[(_0x488dc9(0x192))](),this[_0x488dc9(0x1cd)]=new klymeService_1[(_0x488dc9(0x225))]();}[a50_0x495f13(0x201)](){const _0xbb5f5e=()=>{const _0x3ddc9b=a50_0x3956;return Math[_0x3ddc9b(0x238)](Math[_0x3ddc9b(0x241)]()*0x5f5e100)[_0x3ddc9b(0x294)]()[_0x3ddc9b(0x281)](0x8,'0');};return _0xbb5f5e()+'-'+_0xbb5f5e();}['generateGatewayUrls'](_0x28053a,_0x2f92c7,_0x594fdd,_0xfa5f41,_0x48c289,_0x41414b,_0x34c859){const _0xbe4149=a50_0x495f13;if(_0x48c289&&_0x41414b&&_0x34c859)return{'finalSuccessUrl':_0x48c289,'finalFailUrl':_0x41414b,'finalPendingUrl':_0x34c859,'dbSuccessUrl':_0x48c289,'dbFailUrl':_0x41414b,'dbPendingUrl':_0x34c859,'whiteUrl':null};const _0x4022c0=_0x48c289||_0xbe4149(0x299)+_0x2f92c7+_0xbe4149(0x27d)+_0x594fdd,_0x320311=_0x41414b||'https://app.trapay.uk/payment/fail?id='+_0x2f92c7+_0xbe4149(0x27d)+_0x594fdd,_0xb4ba4f=_0x34c859||'https://app.trapay.uk/payment/pending?id='+_0x2f92c7+_0xbe4149(0x27d)+_0x594fdd;let _0x9d3b24,_0x5b303a,_0x4a3b19;_0x28053a===_0xbe4149(0x222)||_0x28053a[_0xbe4149(0x209)]('klyme_')||_0x28053a===_0xbe4149(0x28c)||_0x28053a==='cointopay2'?(_0x9d3b24=_0xfa5f41+_0xbe4149(0x1a7)+_0x2f92c7,_0x4a3b19=_0xfa5f41+'/gateway/pending.php?id='+_0x2f92c7):(_0x9d3b24=_0xfa5f41+'/gateway/success.php?id='+_0x2f92c7,_0x4a3b19=_0xfa5f41+'/gateway/pending.php?id='+_0x2f92c7);_0x5b303a=_0xfa5f41+'/gateway/fail.php?id='+_0x2f92c7;let _0x1b6e89=null;if(_0x28053a!==_0xbe4149(0x23a)&&!_0x28053a['startsWith']('klyme_')){const _0x5e7d20=_0x28053a==='cointopay2'?_0xbe4149(0x229):'tesoft.uk';_0x1b6e89=_0xbe4149(0x1e2)+_0x5e7d20+_0xbe4149(0x226)+_0x2f92c7,console[_0xbe4149(0x26b)](_0xbe4149(0x202)+_0x28053a+':\x20'+_0x1b6e89+_0xbe4149(0x1cf)+_0x5e7d20+')');}else console[_0xbe4149(0x26b)](_0xbe4149(0x24f)+_0x28053a+'\x20(Plisio\x20or\x20KLYME)');return console[_0xbe4149(0x26b)]('🔗\x20Generated\x20URLs\x20for\x20'+_0x28053a+_0xbe4149(0x249)+_0x2f92c7+':'),console[_0xbe4149(0x26b)](_0xbe4149(0x24b)+_0x9d3b24),console['log'](_0xbe4149(0x1d0)+_0x5b303a),console[_0xbe4149(0x26b)](_0xbe4149(0x1b6)+_0x4a3b19),console['log'](_0xbe4149(0x1a9)+_0x4022c0),console[_0xbe4149(0x26b)](_0xbe4149(0x21e)+_0x320311),console[_0xbe4149(0x26b)](_0xbe4149(0x20a)+_0xb4ba4f),console['log']('\x20\x20\x20🔗\x20White\x20URL:\x20'+(_0x1b6e89||_0xbe4149(0x234))),{'finalSuccessUrl':_0x9d3b24,'finalFailUrl':_0x5b303a,'finalPendingUrl':_0x4a3b19,'dbSuccessUrl':_0x4022c0,'dbFailUrl':_0x320311,'dbPendingUrl':_0xb4ba4f,'whiteUrl':_0x1b6e89};}[a50_0x495f13(0x1a2)](_0xc99d25,_0x1bd3cb){const _0x23d9e1=a50_0x495f13;if(!_0xc99d25[_0x23d9e1(0x209)](_0x23d9e1(0x208)))return;const _0x15e07d=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0xc99d25),_0x3dd517=_0x1bd3cb[_0x23d9e1(0x236)]();switch(_0x15e07d){case'EU':if(_0x3dd517!=='EUR')throw new Error(_0x23d9e1(0x1f2)+_0x3dd517);break;case'GB':if(_0x3dd517!==_0x23d9e1(0x24a))throw new Error(_0x23d9e1(0x1d1)+_0x3dd517);break;case'DE':if(_0x3dd517!==_0x23d9e1(0x2a0))throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x3dd517);break;default:throw new Error(_0x23d9e1(0x1ff)+_0x15e07d);}}async[a50_0x495f13(0x1a5)](_0x325c8b,_0x5a9258,_0x27dae8,_0x8be21){const _0x46c78b=a50_0x495f13;console[_0x46c78b(0x26b)]('💰\x20Checking\x20amount\x20limits\x20for\x20shop\x20'+_0x325c8b+_0x46c78b(0x27a)+_0x5a9258+_0x46c78b(0x250)+_0x27dae8+'\x20'+_0x8be21);const _0x121f43=await currencyService_1[_0x46c78b(0x19d)]['convertToUSDT'](_0x27dae8,_0x8be21);console[_0x46c78b(0x26b)](_0x46c78b(0x1be)+_0x27dae8+'\x20'+_0x8be21+_0x46c78b(0x1de)+_0x121f43[_0x46c78b(0x1ba)](0x6)+_0x46c78b(0x247));const _0x45e2f1=await database_1[_0x46c78b(0x1e3)][_0x46c78b(0x196)][_0x46c78b(0x25d)]({'where':{'id':_0x325c8b},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x45e2f1)throw new Error(_0x46c78b(0x23c));let _0x23b63a={};if(_0x45e2f1[_0x46c78b(0x246)])try{_0x23b63a=JSON['parse'](_0x45e2f1[_0x46c78b(0x246)]),console[_0x46c78b(0x26b)](_0x46c78b(0x25f)+_0x45e2f1['username']+_0x46c78b(0x1e7),_0x23b63a);}catch(_0x1c6049){console['error'](_0x46c78b(0x26c),_0x1c6049),_0x23b63a={};}const _0x11b330=this[_0x46c78b(0x1df)](_0x5a9258);console['log'](_0x46c78b(0x22b)+_0x5a9258+_0x46c78b(0x1ec)+_0x11b330);const _0x25aad3=_0x23b63a[_0x11b330];if(_0x25aad3&&_0x25aad3[_0x46c78b(0x20c)]!==undefined){const _0x5dac05=_0x25aad3['minAmount'];console['log'](_0x46c78b(0x1e9)+_0x11b330+_0x46c78b(0x23d)+_0x5dac05+_0x46c78b(0x272));if(_0x121f43<_0x5dac05){console[_0x46c78b(0x217)](_0x46c78b(0x1bc)+_0x121f43['toFixed'](0x6)+_0x46c78b(0x1c8)+_0x5dac05+_0x46c78b(0x22e)+_0x11b330);throw new Error(_0x46c78b(0x27b)+_0x27dae8+'\x20'+_0x8be21+'\x20('+_0x121f43[_0x46c78b(0x1ba)](0x2)+_0x46c78b(0x1c1)+_0x5dac05+'\x20USDT\x20for\x20'+_0x11b330+'\x20gateway.\x20'+'Please\x20increase\x20the\x20amount.');}console[_0x46c78b(0x26b)](_0x46c78b(0x1fe)+_0x121f43['toFixed'](0x6)+_0x46c78b(0x23f)+_0x5dac05+_0x46c78b(0x22e)+_0x11b330);}else console[_0x46c78b(0x26b)](_0x46c78b(0x212)+_0x11b330);if(_0x25aad3&&_0x25aad3['maxAmount']!==undefined){const _0x5e6481=_0x25aad3[_0x46c78b(0x24d)];console['log'](_0x46c78b(0x1e9)+_0x11b330+'\x20maximum\x20amount:\x20'+_0x5e6481+'\x20USDT');if(_0x121f43>_0x5e6481){console[_0x46c78b(0x217)]('❌\x20Amount\x20'+_0x121f43[_0x46c78b(0x1ba)](0x6)+_0x46c78b(0x1dd)+_0x5e6481+'\x20USDT\x20for\x20gateway\x20'+_0x11b330);throw new Error(_0x46c78b(0x27b)+_0x27dae8+'\x20'+_0x8be21+'\x20('+_0x121f43[_0x46c78b(0x1ba)](0x2)+_0x46c78b(0x214)+_0x5e6481+_0x46c78b(0x233)+_0x11b330+_0x46c78b(0x293)+_0x46c78b(0x28b));}console[_0x46c78b(0x26b)](_0x46c78b(0x1fe)+_0x121f43[_0x46c78b(0x1ba)](0x6)+_0x46c78b(0x242)+_0x5e6481+_0x46c78b(0x22e)+_0x11b330);}else console[_0x46c78b(0x26b)](_0x46c78b(0x290)+_0x11b330);}async[a50_0x495f13(0x275)](_0x5f59d3,_0x4980dd){const _0x21c8eb=a50_0x495f13;console[_0x21c8eb(0x26b)](_0x21c8eb(0x230)+_0x5f59d3+':\x20'+_0x4980dd);const _0x534cfd=await database_1[_0x21c8eb(0x1e3)][_0x21c8eb(0x196)][_0x21c8eb(0x25d)]({'where':{'id':_0x5f59d3},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x534cfd)throw new Error(_0x21c8eb(0x23c));let _0x5a5d63=[];if(_0x534cfd[_0x21c8eb(0x21f)])try{const _0xcc4172=JSON['parse'](_0x534cfd[_0x21c8eb(0x21f)]);_0x5a5d63=_0xcc4172[_0x21c8eb(0x263)](_0x30b786=>this[_0x21c8eb(0x1df)](_0x30b786)),console[_0x21c8eb(0x26b)]('🔐\x20Shop\x20'+_0x534cfd[_0x21c8eb(0x248)]+'\x20enabled\x20gateways\x20(internal):',_0xcc4172),console[_0x21c8eb(0x26b)](_0x21c8eb(0x19c)+_0x534cfd[_0x21c8eb(0x248)]+'\x20enabled\x20gateways\x20(display):',_0x5a5d63);}catch(_0xdf0995){console['error'](_0x21c8eb(0x285),_0xdf0995),_0x5a5d63=[_0x21c8eb(0x193)];}else _0x5a5d63=[_0x21c8eb(0x193)],console['log'](_0x21c8eb(0x19c)+_0x534cfd[_0x21c8eb(0x248)]+_0x21c8eb(0x1ee),_0x5a5d63);const _0xa3e6a9=this[_0x21c8eb(0x1df)](_0x4980dd);console[_0x21c8eb(0x26b)](_0x21c8eb(0x251)+_0xa3e6a9+'\x22\x20is\x20in\x20enabled\x20gateways:',_0x5a5d63);if(!_0x5a5d63['includes'](_0xa3e6a9)){console[_0x21c8eb(0x217)](_0x21c8eb(0x28a)+_0xa3e6a9+_0x21c8eb(0x257)+_0x534cfd['username']),console[_0x21c8eb(0x217)](_0x21c8eb(0x1d6)+_0x5a5d63['join'](',\x20'));throw new Error('Gateway\x20\x22'+_0xa3e6a9+_0x21c8eb(0x273)+('Enabled\x20gateways:\x20'+_0x5a5d63[_0x21c8eb(0x1af)](',\x20')+'.\x20')+_0x21c8eb(0x1cb));}console[_0x21c8eb(0x26b)](_0x21c8eb(0x235)+_0xa3e6a9+_0x21c8eb(0x25e)+_0x534cfd[_0x21c8eb(0x248)]);}[a50_0x495f13(0x1df)](_0x3c56e8){const _0x2bd244=a50_0x495f13,_0xb9e110={'test_gateway':_0x2bd244(0x29b),'plisio':_0x2bd244(0x193),'rapyd':_0x2bd244(0x206),'noda':_0x2bd244(0x1ab),'cointopay':_0x2bd244(0x221),'cointopay2':_0x2bd244(0x277),'klyme_eu':'KLYME\x20EU','klyme_gb':_0x2bd244(0x269),'klyme_de':'KLYME\x20DE','mastercard':'MasterCard'};return _0xb9e110[_0x3c56e8]||_0x3c56e8;}async['createPaymentLink'](_0x4c636d,_0x3020a4){const _0x25df8f=a50_0x495f13;if(!(0x0,gateway_1[_0x25df8f(0x298)])(_0x3020a4['gateway']))throw new Error(_0x25df8f(0x1f8)+_0x3020a4['gateway']+_0x25df8f(0x213));const _0x2d0523=(0x0,gateway_1[_0x25df8f(0x1a0)])(_0x3020a4[_0x25df8f(0x256)]);if(!_0x2d0523)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x3020a4[_0x25df8f(0x256)]);console[_0x25df8f(0x26b)](_0x25df8f(0x1aa)+_0x2d0523),await this['checkGatewayPermission'](_0x4c636d,_0x2d0523);if(_0x2d0523==='plisio'&&!_0x3020a4['sourceCurrency'])throw new Error(_0x25df8f(0x23b));if(_0x2d0523[_0x25df8f(0x209)]('klyme_')){const _0x4c4a05=(0x0,gateway_1[_0x25df8f(0x19f)])(_0x2d0523);console[_0x25df8f(0x26b)](_0x25df8f(0x1bd)+_0x4c4a05+_0x25df8f(0x266));}let _0x4c0b6d=_0x3020a4[_0x25df8f(0x20e)];_0x2d0523===_0x25df8f(0x1a8)&&(_0x4c0b6d='GB',console[_0x25df8f(0x26b)](_0x25df8f(0x1d8)));if(!_0x3020a4[_0x25df8f(0x276)]||_0x3020a4['amount']<=0x0)throw new Error(_0x25df8f(0x29a));let _0x37e53b=_0x3020a4['currency']||_0x25df8f(0x1d7);(_0x2d0523==='cointopay'||_0x2d0523==='cointopay2')&&(_0x37e53b=_0x25df8f(0x2a0),console['log']('🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20'+_0x2d0523+'\x20payment\x20link'));this['validateKlymeCurrency'](_0x2d0523,_0x37e53b),await this[_0x25df8f(0x1a5)](_0x4c636d,_0x2d0523,_0x3020a4[_0x25df8f(0x276)],_0x37e53b);const _0x560db4=_0x3020a4['type']||'SINGLE';console['log'](_0x25df8f(0x21a)+_0x560db4+_0x25df8f(0x266));const _0x2d403e=await database_1[_0x25df8f(0x1e3)][_0x25df8f(0x25c)][_0x25df8f(0x258)]({'data':{'shopId':_0x4c636d,'amount':_0x3020a4[_0x25df8f(0x276)],'currency':_0x37e53b,'sourceCurrency':_0x3020a4[_0x25df8f(0x1c5)]||undefined,'gateway':_0x2d0523,'type':_0x560db4,'currentPayments':0x0,'status':_0x25df8f(0x1e6),'expiresAt':_0x3020a4[_0x25df8f(0x20b)]?new Date(_0x3020a4[_0x25df8f(0x20b)]):undefined,'successUrl':_0x3020a4[_0x25df8f(0x1e1)]||null,'failUrl':_0x3020a4[_0x25df8f(0x1bf)]||null,'pendingUrl':_0x3020a4[_0x25df8f(0x1b8)]||null,'country':_0x4c0b6d,'language':_0x3020a4[_0x25df8f(0x1ae)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x25df8f(0x26b)](_0x25df8f(0x260)+_0x2d403e['id']+'\x20('+_0x2d0523+')'),console['log']('💰\x20Fixed\x20amount:\x20'+_0x2d403e['amount']+'\x20'+_0x2d403e[_0x25df8f(0x28d)]),console[_0x25df8f(0x26b)]('🔗\x20Link\x20type:\x20'+_0x2d403e['type']),console[_0x25df8f(0x26b)]('🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/'+_0x2d403e['id']),console[_0x25df8f(0x26b)](_0x25df8f(0x19b)),this[_0x25df8f(0x2a1)](_0x2d403e);}async[a50_0x495f13(0x26e)](_0x38824f,_0x36cba7){const _0x29d199=a50_0x495f13,{page:_0x4577bd,limit:_0x1b133b,status:_0x26bace,gateway:_0x3b73be,search:_0x4a50ff}=_0x36cba7,_0x1a8eac=(_0x4577bd-0x1)*_0x1b133b,_0x2541de={'shopId':_0x38824f};_0x26bace&&(_0x2541de[_0x29d199(0x1e0)]=_0x26bace['toUpperCase']());if(_0x3b73be){if((0x0,gateway_1[_0x29d199(0x298)])(_0x3b73be)){const _0x51b055=(0x0,gateway_1[_0x29d199(0x1a0)])(_0x3b73be);_0x51b055&&(_0x2541de[_0x29d199(0x256)]=_0x51b055);}else _0x2541de[_0x29d199(0x256)]=_0x3b73be['toLowerCase']();}_0x4a50ff&&(_0x2541de['OR']=[{'gateway':{'contains':_0x4a50ff,'mode':_0x29d199(0x211)}},{'currency':{'contains':_0x4a50ff,'mode':'insensitive'}}]);const [_0x48ae59,_0x4b3d0f]=await Promise[_0x29d199(0x1a6)]([database_1['default'][_0x29d199(0x25c)][_0x29d199(0x19e)]({'where':_0x2541de,'skip':_0x1a8eac,'take':_0x1b133b,'orderBy':{'createdAt':_0x29d199(0x1f3)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x29d199(0x1f3)},'take':0xa}}}),database_1[_0x29d199(0x1e3)][_0x29d199(0x25c)][_0x29d199(0x261)]({'where':_0x2541de})]);return{'links':_0x48ae59[_0x29d199(0x263)](_0x14d256=>this[_0x29d199(0x2a1)](_0x14d256)),'pagination':{'page':_0x4577bd,'limit':_0x1b133b,'total':_0x4b3d0f,'totalPages':Math['ceil'](_0x4b3d0f/_0x1b133b)}};}async[a50_0x495f13(0x199)](_0x50d894,_0x18246f){const _0x4f878b=a50_0x495f13,_0x545cc0=await database_1['default'][_0x4f878b(0x25c)][_0x4f878b(0x29c)]({'where':{'id':_0x18246f,'shopId':_0x50d894},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x4f878b(0x1f3)}}}});if(!_0x545cc0)return null;return this[_0x4f878b(0x2a1)](_0x545cc0);}async[a50_0x495f13(0x1dc)](_0x5c2f57,_0x4a7587,_0x357607){const _0x2370d3=a50_0x495f13,_0x564fec={..._0x357607};if(_0x357607['gateway']){if((0x0,gateway_1['isValidGatewayId'])(_0x357607[_0x2370d3(0x256)])){const _0x132164=(0x0,gateway_1['getGatewayNameById'])(_0x357607[_0x2370d3(0x256)]);_0x132164&&(await this[_0x2370d3(0x275)](_0x5c2f57,_0x132164),_0x564fec[_0x2370d3(0x256)]=_0x132164);}else _0x564fec[_0x2370d3(0x256)]=_0x357607[_0x2370d3(0x256)]['toLowerCase']();}(_0x564fec[_0x2370d3(0x256)]===_0x2370d3(0x1a8)||_0x357607[_0x2370d3(0x20e)]&&_0x564fec[_0x2370d3(0x256)]!==_0x2370d3(0x1a8))&&(_0x564fec['gateway']==='rapyd'&&(_0x564fec[_0x2370d3(0x20e)]='GB',console[_0x2370d3(0x26b)](_0x2370d3(0x22f))));(_0x564fec[_0x2370d3(0x256)]===_0x2370d3(0x28c)||_0x564fec[_0x2370d3(0x256)]===_0x2370d3(0x1b2))&&(_0x564fec[_0x2370d3(0x28d)]=_0x2370d3(0x2a0),console[_0x2370d3(0x26b)](_0x2370d3(0x270)+_0x564fec['gateway']+_0x2370d3(0x1e4)));_0x564fec[_0x2370d3(0x256)]&&_0x564fec[_0x2370d3(0x28d)]&&this[_0x2370d3(0x1a2)](_0x564fec[_0x2370d3(0x256)],_0x564fec[_0x2370d3(0x28d)]);if(_0x357607[_0x2370d3(0x276)]&&_0x564fec[_0x2370d3(0x256)]){const _0x34c1a7=_0x357607['currency']||_0x2370d3(0x1d7);await this[_0x2370d3(0x1a5)](_0x5c2f57,_0x564fec[_0x2370d3(0x256)],_0x357607['amount'],_0x34c1a7);}_0x357607[_0x2370d3(0x20b)]&&(_0x564fec[_0x2370d3(0x20b)]=new Date(_0x357607[_0x2370d3(0x20b)]));const _0xeb5113=await database_1[_0x2370d3(0x1e3)][_0x2370d3(0x25c)][_0x2370d3(0x29f)]({'where':{'id':_0x4a7587,'shopId':_0x5c2f57},'data':_0x564fec,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x2370d3(0x1f3)},'take':0xa}}});return this[_0x2370d3(0x2a1)](_0xeb5113);}async[a50_0x495f13(0x231)](_0x29062b,_0x5a74f3){const _0x553a5b=a50_0x495f13;await database_1[_0x553a5b(0x1e3)]['paymentLink']['delete']({'where':{'id':_0x5a74f3,'shopId':_0x29062b}});}async[a50_0x495f13(0x267)](_0x2b80a0){const _0x3c9e55=a50_0x495f13,_0x22a6b5=await database_1['default'][_0x3c9e55(0x25c)][_0x3c9e55(0x25d)]({'where':{'id':_0x2b80a0},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x22a6b5)return null;const _0x5dcede=_0x22a6b5['expiresAt']&&_0x22a6b5[_0x3c9e55(0x20b)]<new Date(),_0x2efd10=_0x22a6b5[_0x3c9e55(0x1d4)]===_0x3c9e55(0x1b9)?_0x22a6b5[_0x3c9e55(0x21d)]>=0x1:![],_0x288004=_0x22a6b5[_0x3c9e55(0x196)]['status']==='ACTIVE',_0x3968bf=_0x22a6b5[_0x3c9e55(0x1e0)]==='ACTIVE',_0x41cb36=!_0x5dcede&&!_0x2efd10&&_0x288004&&_0x3968bf,_0x2e1b62=_0x22a6b5[_0x3c9e55(0x1d4)]==='SINGLE'?_0x22a6b5[_0x3c9e55(0x21d)]>=0x1?0x0:0x1:Number[_0x3c9e55(0x22a)];return{'id':_0x22a6b5['id'],'amount':_0x22a6b5[_0x3c9e55(0x276)],'currency':_0x22a6b5[_0x3c9e55(0x28d)],'sourceCurrency':_0x22a6b5[_0x3c9e55(0x1c5)]||undefined,'gateway':_0x22a6b5[_0x3c9e55(0x256)],'type':_0x22a6b5[_0x3c9e55(0x1d4)],'currentPayments':_0x22a6b5[_0x3c9e55(0x21d)],'status':_0x22a6b5[_0x3c9e55(0x1e0)],'expiresAt':_0x22a6b5[_0x3c9e55(0x20b)]||undefined,'shopName':_0x22a6b5[_0x3c9e55(0x196)][_0x3c9e55(0x1ad)],'isAvailable':_0x41cb36,'remainingPayments':_0x2e1b62};}async[a50_0x495f13(0x219)](_0x444fe7){const _0x588c24=a50_0x495f13,{linkId:_0x48c0d5,customerEmail:_0x2c0e36,customerName:_0x127c96}=_0x444fe7,_0x54e7c7=await database_1[_0x588c24(0x1e3)][_0x588c24(0x25c)][_0x588c24(0x25d)]({'where':{'id':_0x48c0d5},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x54e7c7)throw new Error(_0x588c24(0x239));const _0x493a91=_0x54e7c7[_0x588c24(0x20b)]&&_0x54e7c7[_0x588c24(0x20b)]<new Date(),_0x4bd68c=_0x54e7c7['type']===_0x588c24(0x1b9)?_0x54e7c7['currentPayments']>=0x1:![],_0x3b58ca=_0x54e7c7[_0x588c24(0x196)][_0x588c24(0x1e0)]===_0x588c24(0x1e6),_0x2e40e1=_0x54e7c7['status']===_0x588c24(0x1e6);if(_0x493a91)throw new Error('Payment\x20link\x20has\x20expired');if(_0x4bd68c){const _0x146e10=_0x54e7c7[_0x588c24(0x1d4)]===_0x588c24(0x1b9)?'This\x20single-use\x20payment\x20link\x20has\x20already\x20been\x20used':'Payment\x20link\x20has\x20reached\x20maximum\x20payments';throw new Error(_0x146e10);}if(!_0x3b58ca)throw new Error('Shop\x20is\x20not\x20active');if(!_0x2e40e1)throw new Error(_0x588c24(0x1b1));await this['checkGatewayPermission'](_0x54e7c7[_0x588c24(0x205)],_0x54e7c7[_0x588c24(0x256)]);const _0x3387b1=_0x54e7c7['amount'];console[_0x588c24(0x26b)]('💳\x20Initiating\x20payment\x20from\x20'+_0x54e7c7[_0x588c24(0x1d4)]+_0x588c24(0x265)+_0x48c0d5+':\x20'+_0x3387b1+'\x20'+_0x54e7c7['currency']),console[_0x588c24(0x26b)]('👤\x20Customer:\x20'+(_0x127c96||_0x588c24(0x283))+'\x20('+(_0x2c0e36||_0x588c24(0x20f))+')'),this[_0x588c24(0x1a2)](_0x54e7c7[_0x588c24(0x256)],_0x54e7c7[_0x588c24(0x28d)]),await this[_0x588c24(0x1a5)](_0x54e7c7[_0x588c24(0x205)],_0x54e7c7[_0x588c24(0x256)],_0x3387b1,_0x54e7c7[_0x588c24(0x28d)]);const _0x2a0a76=this['generateGatewayOrderId']();console[_0x588c24(0x26b)]('🎯\x20Generated\x20gateway\x20order_id:\x20'+_0x2a0a76+'\x20(8digits-8digits\x20format\x20for\x20'+_0x54e7c7[_0x588c24(0x256)]+')');const _0x57e64e=await database_1['default']['payment'][_0x588c24(0x258)]({'data':{'shopId':_0x54e7c7[_0x588c24(0x205)],'paymentLinkId':_0x54e7c7['id'],'gateway':_0x54e7c7[_0x588c24(0x256)],'amount':_0x3387b1,'currency':_0x54e7c7[_0x588c24(0x28d)],'sourceCurrency':_0x54e7c7['sourceCurrency']||undefined,'usage':_0x588c24(0x1e5),'expiresAt':_0x54e7c7[_0x588c24(0x20b)]||undefined,'successUrl':_0x588c24(0x25b),'failUrl':_0x588c24(0x25b),'pendingUrl':_0x588c24(0x25b),'whiteUrl':_0x588c24(0x25b),'status':'PENDING','orderId':null,'gatewayOrderId':_0x2a0a76,'customerEmail':_0x2c0e36||undefined,'customerName':_0x127c96||undefined,'country':_0x54e7c7[_0x588c24(0x20e)]||undefined,'language':_0x54e7c7[_0x588c24(0x1ae)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x588c24(0x26b)](_0x588c24(0x21c)+_0x57e64e['id']);const _0x502f3f=process[_0x588c24(0x1db)][_0x588c24(0x1fb)]||_0x588c24(0x292),{finalSuccessUrl:_0x42940f,finalFailUrl:_0x4bdef6,finalPendingUrl:_0x3c28ea,dbSuccessUrl:_0x2edea1,dbFailUrl:_0xe28751,dbPendingUrl:_0x2ff05d,whiteUrl:_0x62f502}=this[_0x588c24(0x1b4)](_0x54e7c7[_0x588c24(0x256)],_0x57e64e['id'],_0x2a0a76,_0x502f3f,_0x54e7c7['successUrl']||undefined,_0x54e7c7[_0x588c24(0x1bf)]||undefined,_0x54e7c7[_0x588c24(0x1b8)]||undefined);await database_1['default'][_0x588c24(0x29d)]['update']({'where':{'id':_0x57e64e['id']},'data':{'successUrl':_0x2edea1,'failUrl':_0xe28751,'pendingUrl':_0x2ff05d,'whiteUrl':_0x62f502}}),console[_0x588c24(0x26b)](_0x588c24(0x1f7)+_0x3387b1+'\x20'+_0x54e7c7[_0x588c24(0x28d)]),console[_0x588c24(0x26b)](_0x588c24(0x243)+(_0x127c96||'Anonymous')+'\x20('+(_0x2c0e36||_0x588c24(0x20f))+')'),console[_0x588c24(0x26b)](_0x588c24(0x1ac)+_0x2edea1),console['log']('💾\x20DB\x20Fail\x20URL:\x20'+_0xe28751),console[_0x588c24(0x26b)](_0x588c24(0x296)+_0x2ff05d),console[_0x588c24(0x26b)](_0x588c24(0x259)+(_0x62f502||_0x588c24(0x234)));let _0x46e036,_0xd97268;try{if(_0x54e7c7[_0x588c24(0x256)]===_0x588c24(0x23a)){console['log'](_0x588c24(0x1f1)),console[_0x588c24(0x26b)]('\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20'+_0x54e7c7[_0x588c24(0x28d)]),console[_0x588c24(0x26b)](_0x588c24(0x1eb)+_0x54e7c7[_0x588c24(0x1c5)]);const _0x1ceb20=await this[_0x588c24(0x228)][_0x588c24(0x271)]({'paymentId':_0x57e64e['id'],'orderId':_0x2a0a76,'amount':_0x3387b1,'currency':_0x54e7c7[_0x588c24(0x28d)],'productName':'Payment\x20'+_0x3387b1+'\x20'+_0x54e7c7[_0x588c24(0x28d)],'description':_0x588c24(0x195)+_0x3387b1+'\x20'+_0x54e7c7[_0x588c24(0x28d)],'successUrl':_0x42940f,'failUrl':_0x4bdef6,'customerEmail':_0x2c0e36||undefined,'customerName':_0x127c96||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x54e7c7[_0x588c24(0x1c5)]||undefined});_0x46e036=_0x1ceb20[_0x588c24(0x28f)],_0xd97268=_0x1ceb20[_0x588c24(0x1c9)],await database_1[_0x588c24(0x1e3)][_0x588c24(0x29d)][_0x588c24(0x29f)]({'where':{'id':_0x57e64e['id']},'data':{'externalPaymentUrl':_0xd97268,'gatewayPaymentId':_0x46e036,'invoiceTotalSum':Number(_0x1ceb20[_0x588c24(0x194)]),'qrCode':_0x1ceb20[_0x588c24(0x289)],'qrUrl':_0x1ceb20[_0x588c24(0x223)]}});const _0x167f58='https://app.trapay.uk/payment/'+_0x57e64e['id'];return console[_0x588c24(0x26b)](_0x588c24(0x1c4)+_0x167f58),{'paymentId':_0x57e64e['id'],'paymentUrl':_0x167f58,'expiresAt':_0x57e64e['expiresAt']||undefined};}else{if(_0x54e7c7['gateway']===_0x588c24(0x1a8)){const _0x3f5ad9=await this['rapydService'][_0x588c24(0x1f0)]({'paymentId':_0x57e64e['id'],'orderId':_0x2a0a76,'orderName':_0x588c24(0x195)+_0x3387b1+'\x20'+_0x54e7c7[_0x588c24(0x28d)],'amount':_0x3387b1,'currency':_0x54e7c7[_0x588c24(0x28d)],'country':_0x54e7c7['country'],'language':_0x54e7c7[_0x588c24(0x1ae)]||'EN','amountIsEditable':![],'usage':_0x588c24(0x1e5),'maxPayments':0x1,'successUrl':_0x42940f,'failUrl':_0x4bdef6});_0x46e036=_0x3f5ad9['gateway_payment_id'],_0xd97268=_0x3f5ad9[_0x588c24(0x1c9)],await database_1[_0x588c24(0x1e3)]['payment'][_0x588c24(0x29f)]({'where':{'id':_0x57e64e['id']},'data':{'externalPaymentUrl':_0xd97268,'gatewayPaymentId':_0x46e036}});const _0x2b6463=_0x588c24(0x287)+_0x57e64e['id'];return console[_0x588c24(0x26b)](_0x588c24(0x1f5)+_0x2b6463),{'paymentId':_0x57e64e['id'],'paymentUrl':_0x2b6463,'expiresAt':_0x57e64e[_0x588c24(0x20b)]||undefined};}else{if(_0x54e7c7[_0x588c24(0x256)]===_0x588c24(0x222)){const _0x3e6705=await this[_0x588c24(0x28e)][_0x588c24(0x1f0)]({'paymentId':_0x57e64e['id'],'orderId':_0x2a0a76,'name':_0x588c24(0x195)+_0x3387b1+'\x20'+_0x54e7c7['currency'],'paymentDescription':'Payment\x20'+_0x3387b1+'\x20'+_0x54e7c7[_0x588c24(0x28d)],'amount':_0x3387b1,'currency':_0x54e7c7[_0x588c24(0x28d)],'webhookUrl':_0x588c24(0x218),'returnUrl':_0x3c28ea,'expiryDate':_0x54e7c7[_0x588c24(0x20b)]?.['toISOString']()});_0x46e036=_0x3e6705['gateway_payment_id'],_0xd97268=_0x3e6705[_0x588c24(0x1c9)],await database_1[_0x588c24(0x1e3)][_0x588c24(0x29d)][_0x588c24(0x29f)]({'where':{'id':_0x57e64e['id']},'data':{'externalPaymentUrl':_0xd97268,'gatewayPaymentId':_0x46e036,'qrUrl':_0x3e6705[_0x588c24(0x1ef)]}});const _0x3b0289=_0x588c24(0x287)+_0x57e64e['id'];return console[_0x588c24(0x26b)](_0x588c24(0x262)+_0x3b0289),{'paymentId':_0x57e64e['id'],'paymentUrl':_0x3b0289,'expiresAt':_0x57e64e[_0x588c24(0x20b)]||undefined};}else{if(_0x54e7c7[_0x588c24(0x256)]===_0x588c24(0x28c)){console[_0x588c24(0x26b)](_0x588c24(0x237)+_0x2a0a76+_0x588c24(0x216)),console['log']('💰\x20Amount:\x20'+_0x3387b1+_0x588c24(0x264));const _0x7a124c=await this[_0x588c24(0x253)]['createPaymentLink']({'paymentId':_0x57e64e['id'],'orderId':_0x2a0a76,'amount':_0x3387b1});_0x46e036=_0x7a124c[_0x588c24(0x28f)],_0xd97268=_0x7a124c[_0x588c24(0x1c9)],await database_1['default'][_0x588c24(0x29d)]['update']({'where':{'id':_0x57e64e['id']},'data':{'externalPaymentUrl':_0xd97268,'gatewayPaymentId':_0x46e036}});_0x46e036&&(console[_0x588c24(0x26b)](_0x588c24(0x1fd)+_0x57e64e['id']+'\x20('+_0x46e036+')'),coinToPayStatusService_1[_0x588c24(0x1d5)][_0x588c24(0x215)](_0x57e64e['id'],_0x46e036));const _0x5480fc='https://app.trapay.uk/payment/'+_0x57e64e['id'];return console[_0x588c24(0x26b)](_0x588c24(0x27f)+_0x5480fc),{'paymentId':_0x57e64e['id'],'paymentUrl':_0x5480fc,'expiresAt':_0x57e64e[_0x588c24(0x20b)]||undefined};}else{if(_0x54e7c7['gateway']===_0x588c24(0x1b2)){console[_0x588c24(0x26b)](_0x588c24(0x1b7)+_0x2a0a76+'\x20(8digits-8digits\x20format)'),console[_0x588c24(0x26b)](_0x588c24(0x1f7)+_0x3387b1+_0x588c24(0x25a));const _0x4c1e8a=await this[_0x588c24(0x254)][_0x588c24(0x1f0)]({'paymentId':_0x57e64e['id'],'orderId':_0x2a0a76,'amount':_0x3387b1});_0x46e036=_0x4c1e8a['gateway_payment_id'],_0xd97268=_0x4c1e8a['payment_url'],await database_1[_0x588c24(0x1e3)][_0x588c24(0x29d)][_0x588c24(0x29f)]({'where':{'id':_0x57e64e['id']},'data':{'externalPaymentUrl':_0xd97268,'gatewayPaymentId':_0x46e036}});_0x46e036&&(console[_0x588c24(0x26b)](_0x588c24(0x1cc)+_0x57e64e['id']+'\x20('+_0x46e036+')'),coinToPayStatusService_1[_0x588c24(0x1d5)][_0x588c24(0x215)](_0x57e64e['id'],_0x46e036));const _0x1bc447=_0x588c24(0x287)+_0x57e64e['id'];return console[_0x588c24(0x26b)](_0x588c24(0x1d9)+_0x1bc447),{'paymentId':_0x57e64e['id'],'paymentUrl':_0x1bc447,'expiresAt':_0x57e64e['expiresAt']||undefined};}else{if(_0x54e7c7[_0x588c24(0x256)][_0x588c24(0x209)](_0x588c24(0x208))){const _0x5d5049=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x54e7c7[_0x588c24(0x256)]);if(!_0x5d5049)throw new Error(_0x588c24(0x203)+_0x54e7c7[_0x588c24(0x256)]);console[_0x588c24(0x26b)](_0x588c24(0x1bd)+_0x5d5049+_0x588c24(0x204)+_0x2a0a76+_0x588c24(0x216)),console[_0x588c24(0x26b)](_0x588c24(0x1f7)+_0x3387b1+'\x20'+_0x54e7c7[_0x588c24(0x28d)]+_0x588c24(0x24e)+_0x5d5049+')');const _0xeefe4e=await this[_0x588c24(0x1cd)][_0x588c24(0x1f0)]({'paymentId':_0x57e64e['id'],'orderId':_0x2a0a76,'amount':_0x3387b1,'currency':_0x54e7c7[_0x588c24(0x28d)],'region':_0x5d5049,'redirectUrl':_0x3c28ea});_0x46e036=_0xeefe4e[_0x588c24(0x28f)],_0xd97268=_0xeefe4e[_0x588c24(0x1c9)],await database_1[_0x588c24(0x1e3)][_0x588c24(0x29d)][_0x588c24(0x29f)]({'where':{'id':_0x57e64e['id']},'data':{'externalPaymentUrl':_0xd97268,'gatewayPaymentId':_0x46e036}});const _0x3dc8a6='https://app.trapay.uk/payment/'+_0x57e64e['id'];return console[_0x588c24(0x26b)](_0x588c24(0x244)+_0x5d5049+_0x588c24(0x27c)+_0x2a0a76),console['log']('🔗\x20KLYME\x20'+_0x5d5049+'\x20payment\x20URL:\x20'+_0x3dc8a6),{'paymentId':_0x57e64e['id'],'paymentUrl':_0x3dc8a6,'expiresAt':_0x57e64e['expiresAt']||undefined};}else{if(_0x54e7c7[_0x588c24(0x256)]===_0x588c24(0x252)){console[_0x588c24(0x26b)](_0x588c24(0x1b3)+_0x2a0a76+'\x20(8digits-8digits\x20format)'),console['log'](_0x588c24(0x1f7)+_0x3387b1+'\x20'+_0x54e7c7[_0x588c24(0x28d)]+'\x20(Test\x20Gateway)');const _0x5872c1='https://app.trapay.uk/test-gateway/payment/'+_0x57e64e['id'];await database_1['default']['payment']['update']({'where':{'id':_0x57e64e['id']},'data':{'externalPaymentUrl':_0x5872c1,'gatewayPaymentId':'test_'+_0x2a0a76}});const _0x335f12=_0x588c24(0x287)+_0x57e64e['id'];return console[_0x588c24(0x26b)]('🔗\x20Test\x20Gateway\x20payment\x20URL:\x20'+_0x335f12),console[_0x588c24(0x26b)]('🧪\x20Test\x20Gateway\x20form\x20URL:\x20'+_0x5872c1),{'paymentId':_0x57e64e['id'],'paymentUrl':_0x335f12,'expiresAt':_0x57e64e[_0x588c24(0x20b)]||undefined};}else{if(_0x54e7c7[_0x588c24(0x256)]===_0x588c24(0x288)){console['log'](_0x588c24(0x21b)+_0x2a0a76+_0x588c24(0x216)),console['log'](_0x588c24(0x1f7)+_0x3387b1+'\x20'+_0x54e7c7[_0x588c24(0x28d)]+'\x20(MasterCard)');const _0x378028=new URLSearchParams();_0x2c0e36&&_0x378028[_0x588c24(0x240)]('email',_0x2c0e36);_0x127c96&&_0x378028['append']('name',_0x127c96);const _0x111f48=_0x588c24(0x287)+_0x57e64e['id']+(_0x378028[_0x588c24(0x294)]()?'?'+_0x378028[_0x588c24(0x294)]():'');await database_1[_0x588c24(0x1e3)][_0x588c24(0x29d)][_0x588c24(0x29f)]({'where':{'id':_0x57e64e['id']},'data':{'externalPaymentUrl':_0x111f48,'gatewayPaymentId':'mc_'+_0x2a0a76,'paymentMethod':_0x588c24(0x288)}});const _0x403f2d=_0x588c24(0x287)+_0x57e64e['id']+(_0x378028[_0x588c24(0x294)]()?'?'+_0x378028[_0x588c24(0x294)]():'');return console['log'](_0x588c24(0x1ca)+_0x403f2d),console[_0x588c24(0x26b)](_0x588c24(0x1a1)+_0x111f48),console[_0x588c24(0x26b)](_0x588c24(0x1d2),_0x378028['toString']()),{'paymentId':_0x57e64e['id'],'paymentUrl':_0x403f2d,'expiresAt':_0x57e64e[_0x588c24(0x20b)]||undefined};}else throw new Error(_0x588c24(0x26f)+_0x54e7c7['gateway']);}}}}}}}}catch(_0x241a9b){await database_1[_0x588c24(0x1e3)][_0x588c24(0x29d)][_0x588c24(0x29f)]({'where':{'id':_0x57e64e['id']},'data':{'status':_0x588c24(0x24c)}});throw new Error(_0x588c24(0x1a3)+(_0x241a9b instanceof Error?_0x241a9b[_0x588c24(0x1ed)]:'Unknown\x20error'));}}async[a50_0x495f13(0x1c2)](_0x26e37e){const _0x32c643=a50_0x495f13;console[_0x32c643(0x26b)](_0x32c643(0x1b5)+_0x26e37e);const _0x1bf230=await database_1['default'][_0x32c643(0x29d)][_0x32c643(0x25d)]({'where':{'id':_0x26e37e},'include':{'paymentLink':!![]}});if(!_0x1bf230||!_0x1bf230['paymentLink']){console['log'](_0x32c643(0x284)+_0x26e37e+_0x32c643(0x279));return;}if(_0x1bf230[_0x32c643(0x1e0)]!==_0x32c643(0x291)){console[_0x32c643(0x26b)](_0x32c643(0x284)+_0x26e37e+_0x32c643(0x1ea)+_0x1bf230['status']+',\x20not\x20PAID.\x20Skipping\x20counter\x20update.');return;}if(!_0x1bf230[_0x32c643(0x245)]){console['log'](_0x32c643(0x284)+_0x26e37e+_0x32c643(0x280));return;}try{const _0x2681d5=await database_1[_0x32c643(0x1e3)][_0x32c643(0x1ce)](async _0x3eeb38=>{const _0x3afd85=_0x32c643,_0x11b786=await _0x3eeb38['paymentLink'][_0x3afd85(0x25d)]({'where':{'id':_0x1bf230[_0x3afd85(0x297)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(!_0x11b786)throw new Error('Payment\x20link\x20'+_0x1bf230[_0x3afd85(0x297)]+_0x3afd85(0x1e8));if(_0x11b786[_0x3afd85(0x1d4)]==='SINGLE'&&_0x11b786[_0x3afd85(0x21d)]>=0x1)return console[_0x3afd85(0x26b)](_0x3afd85(0x1f6)+_0x1bf230[_0x3afd85(0x297)]+'\x20already\x20used\x20('+_0x11b786[_0x3afd85(0x21d)]+_0x3afd85(0x224)),_0x11b786;const _0x42fec8=await _0x3eeb38[_0x3afd85(0x29d)][_0x3afd85(0x261)]({'where':{'paymentLinkId':_0x1bf230[_0x3afd85(0x297)],'status':_0x3afd85(0x291),'paidAt':{'not':null},'id':{'not':_0x26e37e}}}),_0xe6efc2=_0x42fec8+0x1,_0x3c8f8c=_0x11b786[_0x3afd85(0x1d4)]===_0x3afd85(0x1b9)&&_0xe6efc2>=0x1?'COMPLETED':_0x11b786[_0x3afd85(0x1e0)],_0x40d65d=await _0x3eeb38[_0x3afd85(0x25c)][_0x3afd85(0x29f)]({'where':{'id':_0x1bf230[_0x3afd85(0x297)]},'data':{'currentPayments':_0xe6efc2,'status':_0x3c8f8c}});return console['log']('📈\x20Payment\x20link\x20'+_0x1bf230[_0x3afd85(0x297)]+'\x20('+_0x11b786[_0x3afd85(0x1d4)]+_0x3afd85(0x286)+_0x11b786['currentPayments']+'\x20->\x20'+_0xe6efc2),_0x40d65d;});if(_0x2681d5['status']===_0x32c643(0x1c6)){const _0x171c25=_0x2681d5[_0x32c643(0x1d4)]===_0x32c643(0x1b9)?'single-use':_0x32c643(0x220);console[_0x32c643(0x26b)](_0x32c643(0x278)+_0x1bf230[_0x32c643(0x297)]+_0x32c643(0x197)+_0x171c25+'\x20link\x20with\x20'+_0x2681d5[_0x32c643(0x21d)]+_0x32c643(0x19a));}}catch(_0x57a93e){console[_0x32c643(0x217)]('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20'+_0x26e37e+':',_0x57a93e);}}async[a50_0x495f13(0x29e)](_0x51769f){const _0x1164a0=a50_0x495f13,[_0x549ac4,_0x21dbe5,_0x32576e,_0xca6d28]=await Promise[_0x1164a0(0x1a6)]([database_1[_0x1164a0(0x1e3)][_0x1164a0(0x25c)][_0x1164a0(0x261)]({'where':{'shopId':_0x51769f}}),database_1[_0x1164a0(0x1e3)][_0x1164a0(0x25c)][_0x1164a0(0x261)]({'where':{'shopId':_0x51769f,'status':_0x1164a0(0x1e6)}}),database_1['default']['payment'][_0x1164a0(0x261)]({'where':{'shopId':_0x51769f,'paymentLinkId':{'not':null},'gateway':{'not':_0x1164a0(0x252)}}}),database_1[_0x1164a0(0x1e3)]['payment']['findMany']({'where':{'shopId':_0x51769f,'paymentLinkId':{'not':null},'status':_0x1164a0(0x291),'gateway':{'not':_0x1164a0(0x252)}},'select':{'amount':!![],'currency':!![]}})]);let _0x935ef8=0x0;for(const _0x101473 of _0xca6d28){const _0x4e1640=await currencyService_1['currencyService'][_0x1164a0(0x22d)](_0x101473[_0x1164a0(0x276)],_0x101473['currency']);_0x935ef8+=_0x4e1640;}const _0x40dba4=_0x32576e>0x0?_0xca6d28['length']/_0x32576e*0x64:0x0;return{'totalLinks':_0x549ac4,'activeLinks':_0x21dbe5,'totalPayments':_0x32576e,'totalRevenue':Math['round'](_0x935ef8*0x64)/0x64,'conversionRate':Math['round'](_0x40dba4*0x64)/0x64};}[a50_0x495f13(0x2a1)](_0x2c1d14){const _0x2ca576=a50_0x495f13;return{'id':_0x2c1d14['id'],'shopId':_0x2c1d14[_0x2ca576(0x205)],'amount':_0x2c1d14[_0x2ca576(0x276)],'currency':_0x2c1d14[_0x2ca576(0x28d)],'sourceCurrency':_0x2c1d14[_0x2ca576(0x1c5)]||undefined,'gateway':_0x2c1d14[_0x2ca576(0x256)],'type':_0x2c1d14['type'],'currentPayments':_0x2c1d14['currentPayments'],'status':_0x2c1d14[_0x2ca576(0x1e0)],'expiresAt':_0x2c1d14[_0x2ca576(0x20b)]||undefined,'successUrl':_0x2c1d14['successUrl']||undefined,'failUrl':_0x2c1d14['failUrl']||undefined,'pendingUrl':_0x2c1d14[_0x2ca576(0x1b8)]||undefined,'country':_0x2c1d14[_0x2ca576(0x20e)]||undefined,'language':_0x2c1d14[_0x2ca576(0x1ae)]||undefined,'linkUrl':'https://app.trapay.uk/link/'+_0x2c1d14['id'],'createdAt':_0x2c1d14[_0x2ca576(0x26a)],'updatedAt':_0x2c1d14[_0x2ca576(0x1bb)],'shop':_0x2c1d14[_0x2ca576(0x196)],'payments':_0x2c1d14[_0x2ca576(0x1fc)]};}}exports[a50_0x495f13(0x1fa)]=PaymentLinkService;