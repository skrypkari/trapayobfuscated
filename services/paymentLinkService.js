'use strict';const a45_0x38c571=a45_0xa517;(function(_0x1b8523,_0x40fc5a){const _0x500a6d=a45_0xa517,_0x404f7e=_0x1b8523();while(!![]){try{const _0x23972d=parseInt(_0x500a6d(0x1f2))/0x1*(parseInt(_0x500a6d(0x198))/0x2)+-parseInt(_0x500a6d(0x1e7))/0x3*(-parseInt(_0x500a6d(0x1ce))/0x4)+-parseInt(_0x500a6d(0x1fd))/0x5+-parseInt(_0x500a6d(0x1ba))/0x6*(-parseInt(_0x500a6d(0x150))/0x7)+parseInt(_0x500a6d(0x164))/0x8*(parseInt(_0x500a6d(0x185))/0x9)+parseInt(_0x500a6d(0x1cc))/0xa+-parseInt(_0x500a6d(0x151))/0xb;if(_0x23972d===_0x40fc5a)break;else _0x404f7e['push'](_0x404f7e['shift']());}catch(_0x4d231b){_0x404f7e['push'](_0x404f7e['shift']());}}}(a45_0x4f5c,0xe978a));function a45_0xa517(_0x8ebb1c,_0x4ebb9d){const _0x4f5cb9=a45_0x4f5c();return a45_0xa517=function(_0xa5179a,_0x2b7719){_0xa5179a=_0xa5179a-0x13d;let _0xca5a1b=_0x4f5cb9[_0xa5179a];return _0xca5a1b;},a45_0xa517(_0x8ebb1c,_0x4ebb9d);}var __importDefault=this&&this[a45_0x38c571(0x1c3)]||function(_0x5b4289){const _0x438b2c=a45_0x38c571;return _0x5b4289&&_0x5b4289[_0x438b2c(0x173)]?_0x5b4289:{'default':_0x5b4289};};Object[a45_0x38c571(0x16e)](exports,a45_0x38c571(0x173),{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a45_0x38c571(0x1ec)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a45_0x38c571(0x184)),coinToPayService_1=require(a45_0x38c571(0x1da)),klymeService_1=require(a45_0x38c571(0x1b4)),gateway_1=require(a45_0x38c571(0x194)),currencyService_1=require(a45_0x38c571(0x1b8));class PaymentLinkService{constructor(){const _0x1c22d9=a45_0x38c571;this['plisioService']=new plisioService_1[(_0x1c22d9(0x1fe))](),this[_0x1c22d9(0x1bb)]=new rapydService_1[(_0x1c22d9(0x171))](),this[_0x1c22d9(0x180)]=new nodaService_1['NodaService'](),this[_0x1c22d9(0x17f)]=new coinToPayService_1[(_0x1c22d9(0x208))](),this[_0x1c22d9(0x1be)]=new klymeService_1[(_0x1c22d9(0x1dc))]();}[a45_0x38c571(0x18a)](){const _0x163444=()=>{const _0x5748d9=a45_0xa517;return Math['floor'](Math[_0x5748d9(0x1a8)]()*0x5f5e100)[_0x5748d9(0x143)]()[_0x5748d9(0x203)](0x8,'0');};return _0x163444()+'-'+_0x163444();}[a45_0x38c571(0x154)](_0x3d0602,_0x4d91ce,_0x1e1587,_0x4cb49e,_0x36cb01){const _0x115b96=a45_0x38c571;if(_0x4cb49e&&_0x36cb01)return{'finalSuccessUrl':_0x4cb49e,'finalFailUrl':_0x36cb01,'dbSuccessUrl':_0x4cb49e,'dbFailUrl':_0x36cb01};let _0x1a0f43,_0x3cfd44,_0x5441d5,_0x15c739;return _0x3d0602===_0x115b96(0x20b)||_0x3d0602[_0x115b96(0x206)](_0x115b96(0x157))?(_0x1a0f43=_0x1e1587+_0x115b96(0x16d)+_0x4d91ce,_0x5441d5=_0x115b96(0x15f)+_0x4d91ce):(_0x1a0f43=_0x1e1587+_0x115b96(0x166)+_0x4d91ce,_0x5441d5=_0x115b96(0x147)+_0x4d91ce),_0x3cfd44=_0x1e1587+_0x115b96(0x1d1)+_0x4d91ce,_0x15c739=_0x115b96(0x1f9)+_0x4d91ce,console[_0x115b96(0x1e8)](_0x115b96(0x1af)+_0x3d0602+':'),console[_0x115b96(0x1e8)](_0x115b96(0x15a)+_0x1a0f43),console['log']('\x20\x20\x20üåê\x20Gateway\x20Fail\x20URL:\x20'+_0x3cfd44),console[_0x115b96(0x1e8)]('\x20\x20\x20üíæ\x20DB\x20Success\x20URL:\x20'+_0x5441d5),console[_0x115b96(0x1e8)]('\x20\x20\x20üíæ\x20DB\x20Fail\x20URL:\x20'+_0x15c739),{'finalSuccessUrl':_0x1a0f43,'finalFailUrl':_0x3cfd44,'dbSuccessUrl':_0x5441d5,'dbFailUrl':_0x15c739};}[a45_0x38c571(0x14e)](_0x3e44e8,_0x4e6614){const _0x4634f1=a45_0x38c571;if(!_0x3e44e8[_0x4634f1(0x206)]('klyme_'))return;const _0x5d7746=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x3e44e8),_0x2f44a8=_0x4e6614[_0x4634f1(0x188)]();switch(_0x5d7746){case'EU':if(_0x2f44a8!==_0x4634f1(0x152))throw new Error(_0x4634f1(0x1e5)+_0x2f44a8);break;case'GB':if(_0x2f44a8!==_0x4634f1(0x1d6))throw new Error(_0x4634f1(0x177)+_0x2f44a8);break;case'DE':if(_0x2f44a8!==_0x4634f1(0x152))throw new Error(_0x4634f1(0x161)+_0x2f44a8);break;default:throw new Error(_0x4634f1(0x156)+_0x5d7746);}}async['checkGatewayPermission'](_0x46be12,_0x98a531){const _0x1234a4=a45_0x38c571;console[_0x1234a4(0x1e8)](_0x1234a4(0x20e)+_0x46be12+':\x20'+_0x98a531);const _0x1d8cf1=await database_1['default']['shop'][_0x1234a4(0x1a7)]({'where':{'id':_0x46be12},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x1d8cf1)throw new Error(_0x1234a4(0x17c));let _0x16c3fe=[];if(_0x1d8cf1[_0x1234a4(0x1f6)])try{_0x16c3fe=JSON[_0x1234a4(0x18e)](_0x1d8cf1[_0x1234a4(0x1f6)]),console[_0x1234a4(0x1e8)](_0x1234a4(0x1c6)+_0x1d8cf1[_0x1234a4(0x1f8)]+_0x1234a4(0x16b),_0x16c3fe);}catch(_0x1132b4){console[_0x1234a4(0x160)](_0x1234a4(0x1ad),_0x1132b4),_0x16c3fe=[_0x1234a4(0x1dd)];}else _0x16c3fe=[_0x1234a4(0x1dd)],console[_0x1234a4(0x1e8)](_0x1234a4(0x1c6)+_0x1d8cf1[_0x1234a4(0x1f8)]+_0x1234a4(0x1f3),_0x16c3fe);const _0x226977=this[_0x1234a4(0x1a6)](_0x98a531);console[_0x1234a4(0x1e8)](_0x1234a4(0x174)+_0x226977+_0x1234a4(0x162),_0x16c3fe);if(!_0x16c3fe['includes'](_0x226977)){console['error'](_0x1234a4(0x201)+_0x226977+_0x1234a4(0x158)+_0x1d8cf1[_0x1234a4(0x1f8)]),console['error'](_0x1234a4(0x1b5)+_0x16c3fe['join'](',\x20'));throw new Error(_0x1234a4(0x165)+_0x226977+_0x1234a4(0x20d)+(_0x1234a4(0x145)+_0x16c3fe[_0x1234a4(0x1c0)](',\x20')+'.\x20')+_0x1234a4(0x17b));}console[_0x1234a4(0x1e8)](_0x1234a4(0x191)+_0x226977+_0x1234a4(0x1b6)+_0x1d8cf1['username']);}[a45_0x38c571(0x1a6)](_0x53848d){const _0x288e95=a45_0x38c571,_0x434095={'plisio':_0x288e95(0x1dd),'rapyd':_0x288e95(0x18f),'noda':_0x288e95(0x1de),'cointopay':_0x288e95(0x1ed),'klyme_eu':_0x288e95(0x1bf),'klyme_gb':_0x288e95(0x1db),'klyme_de':_0x288e95(0x1ca)};return _0x434095[_0x53848d]||_0x53848d;}async[a45_0x38c571(0x1ab)](_0x171418,_0x2274b2){const _0x16391d=a45_0x38c571;if(!(0x0,gateway_1['isValidGatewayId'])(_0x2274b2['gateway']))throw new Error('Invalid\x20gateway\x20ID:\x20'+_0x2274b2['gateway']+_0x16391d(0x163));const _0x22d8e2=(0x0,gateway_1['getGatewayNameById'])(_0x2274b2[_0x16391d(0x172)]);if(!_0x22d8e2)throw new Error(_0x16391d(0x20c)+_0x2274b2[_0x16391d(0x172)]);console['log'](_0x16391d(0x13d)+_0x22d8e2),await this[_0x16391d(0x20a)](_0x171418,_0x22d8e2);if(_0x22d8e2===_0x16391d(0x209)&&!_0x2274b2[_0x16391d(0x1d0)])throw new Error(_0x16391d(0x1cf));if(_0x22d8e2['startsWith']('klyme_')){const _0x5f53ce=(0x0,gateway_1[_0x16391d(0x1d4)])(_0x22d8e2);console[_0x16391d(0x1e8)](_0x16391d(0x199)+_0x5f53ce+_0x16391d(0x1f4));}let _0x257332=_0x2274b2[_0x16391d(0x19a)];_0x22d8e2===_0x16391d(0x1c7)&&(_0x257332='GB',console[_0x16391d(0x1e8)](_0x16391d(0x1e4)));if(!_0x2274b2['amount']||_0x2274b2[_0x16391d(0x13f)]<=0x0)throw new Error(_0x16391d(0x1e9));let _0x3cb99e=_0x2274b2[_0x16391d(0x178)]||'USD';_0x22d8e2===_0x16391d(0x159)&&(_0x3cb99e=_0x16391d(0x152),console[_0x16391d(0x1e8)](_0x16391d(0x1cd)));this['validateKlymeCurrency'](_0x22d8e2,_0x3cb99e);const _0xf6140e=await database_1[_0x16391d(0x16c)][_0x16391d(0x19b)][_0x16391d(0x1f1)]({'data':{'shopId':_0x171418,'amount':_0x2274b2[_0x16391d(0x13f)],'currency':_0x3cb99e,'sourceCurrency':_0x2274b2['sourceCurrency']||undefined,'gateway':_0x22d8e2,'maxPayments':_0x2274b2[_0x16391d(0x155)]||0x1,'currentPayments':0x0,'status':_0x16391d(0x1ff),'expiresAt':_0x2274b2['expiresAt']?new Date(_0x2274b2[_0x16391d(0x17e)]):undefined,'successUrl':_0x16391d(0x1e2),'failUrl':'temp','country':_0x257332,'language':_0x2274b2[_0x16391d(0x1c5)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x2155d4=process[_0x16391d(0x197)][_0x16391d(0x1b2)]||'https://tesoft.uk',{finalSuccessUrl:_0x2d22b3,finalFailUrl:_0x2d79db,dbSuccessUrl:_0x1471c9,dbFailUrl:_0x1cc147}=this[_0x16391d(0x154)](_0x22d8e2,_0xf6140e['id'],_0x2155d4,_0x2274b2[_0x16391d(0x1f5)],_0x2274b2[_0x16391d(0x1c9)]),_0x28dd60=await database_1[_0x16391d(0x16c)]['paymentLink'][_0x16391d(0x144)]({'where':{'id':_0xf6140e['id']},'data':{'successUrl':_0x1471c9,'failUrl':_0x1cc147},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x16391d(0x1e8)](_0x16391d(0x189)+_0x28dd60['id']+'\x20('+_0x22d8e2+')'),console[_0x16391d(0x1e8)]('üí∞\x20Fixed\x20amount:\x20'+_0x28dd60[_0x16391d(0x13f)]+'\x20'+_0x28dd60[_0x16391d(0x178)]),console[_0x16391d(0x1e8)](_0x16391d(0x1fc)+_0x28dd60['id']),console['log'](_0x16391d(0x1ef)+_0x28dd60[_0x16391d(0x1f5)]),console[_0x16391d(0x1e8)](_0x16391d(0x1ac)+_0x28dd60[_0x16391d(0x1c9)]),this[_0x16391d(0x1b7)](_0x28dd60);}async['getPaymentLinks'](_0x443568,_0x119239){const _0x38aab6=a45_0x38c571,{page:_0x3d6732,limit:_0x7a48f3,status:_0x18fb85,gateway:_0x55f983,search:_0x29aa44}=_0x119239,_0x381004=(_0x3d6732-0x1)*_0x7a48f3,_0x5f3ca2={'shopId':_0x443568};_0x18fb85&&(_0x5f3ca2['status']=_0x18fb85['toUpperCase']());if(_0x55f983){if((0x0,gateway_1[_0x38aab6(0x1f0)])(_0x55f983)){const _0x376019=(0x0,gateway_1[_0x38aab6(0x1b1)])(_0x55f983);_0x376019&&(_0x5f3ca2[_0x38aab6(0x172)]=_0x376019);}else _0x5f3ca2[_0x38aab6(0x172)]=_0x55f983[_0x38aab6(0x14c)]();}_0x29aa44&&(_0x5f3ca2['OR']=[{'gateway':{'contains':_0x29aa44,'mode':'insensitive'}},{'currency':{'contains':_0x29aa44,'mode':_0x38aab6(0x15c)}}]);const [_0x390259,_0x4b90a9]=await Promise['all']([database_1['default'][_0x38aab6(0x19b)]['findMany']({'where':_0x5f3ca2,'skip':_0x381004,'take':_0x7a48f3,'orderBy':{'createdAt':_0x38aab6(0x170)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x38aab6(0x170)},'take':0xa}}}),database_1['default'][_0x38aab6(0x19b)]['count']({'where':_0x5f3ca2})]);return{'links':_0x390259['map'](_0x5431cc=>this[_0x38aab6(0x1b7)](_0x5431cc)),'pagination':{'page':_0x3d6732,'limit':_0x7a48f3,'total':_0x4b90a9,'totalPages':Math[_0x38aab6(0x1c8)](_0x4b90a9/_0x7a48f3)}};}async[a45_0x38c571(0x167)](_0x514cea,_0x2d1cbc){const _0x4e42e9=a45_0x38c571,_0x14044f=await database_1[_0x4e42e9(0x16c)][_0x4e42e9(0x19b)][_0x4e42e9(0x1c1)]({'where':{'id':_0x2d1cbc,'shopId':_0x514cea},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x4e42e9(0x170)}}}});if(!_0x14044f)return null;return this['formatPaymentLinkResponse'](_0x14044f);}async[a45_0x38c571(0x19f)](_0x482982,_0x1d5726,_0x2995e1){const _0x3b13a4=a45_0x38c571,_0xbde5b={..._0x2995e1};if(_0x2995e1[_0x3b13a4(0x172)]){if((0x0,gateway_1[_0x3b13a4(0x1f0)])(_0x2995e1[_0x3b13a4(0x172)])){const _0x44f7e6=(0x0,gateway_1[_0x3b13a4(0x1b1)])(_0x2995e1[_0x3b13a4(0x172)]);_0x44f7e6&&(await this[_0x3b13a4(0x20a)](_0x482982,_0x44f7e6),_0xbde5b['gateway']=_0x44f7e6);}else _0xbde5b['gateway']=_0x2995e1[_0x3b13a4(0x172)]['toLowerCase']();}(_0xbde5b[_0x3b13a4(0x172)]==='rapyd'||_0x2995e1[_0x3b13a4(0x19a)]&&_0xbde5b['gateway']!==_0x3b13a4(0x1c7))&&(_0xbde5b[_0x3b13a4(0x172)]==='rapyd'&&(_0xbde5b['country']='GB',console[_0x3b13a4(0x1e8)](_0x3b13a4(0x14a))));_0xbde5b[_0x3b13a4(0x172)]===_0x3b13a4(0x159)&&(_0xbde5b[_0x3b13a4(0x178)]=_0x3b13a4(0x152),console[_0x3b13a4(0x1e8)]('ü™ô\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update'));_0xbde5b[_0x3b13a4(0x172)]&&_0xbde5b[_0x3b13a4(0x178)]&&this[_0x3b13a4(0x14e)](_0xbde5b[_0x3b13a4(0x172)],_0xbde5b['currency']);_0x2995e1[_0x3b13a4(0x17e)]&&(_0xbde5b['expiresAt']=new Date(_0x2995e1[_0x3b13a4(0x17e)]));const _0x382d25=await database_1[_0x3b13a4(0x16c)][_0x3b13a4(0x19b)][_0x3b13a4(0x144)]({'where':{'id':_0x1d5726,'shopId':_0x482982},'data':_0xbde5b,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x3b13a4(0x170)},'take':0xa}}});return this[_0x3b13a4(0x1b7)](_0x382d25);}async[a45_0x38c571(0x1d2)](_0x5a3657,_0x15364c){await database_1['default']['paymentLink']['delete']({'where':{'id':_0x15364c,'shopId':_0x5a3657}});}async['getPublicPaymentLinkData'](_0x31879c){const _0x44e9e5=a45_0x38c571,_0x518663=await database_1['default']['paymentLink'][_0x44e9e5(0x1a7)]({'where':{'id':_0x31879c},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x518663)return null;const _0x2d063f=_0x518663[_0x44e9e5(0x17e)]&&_0x518663[_0x44e9e5(0x17e)]<new Date(),_0x2af521=_0x518663[_0x44e9e5(0x1ea)]>=_0x518663[_0x44e9e5(0x155)],_0x412af3=_0x518663[_0x44e9e5(0x1e3)][_0x44e9e5(0x179)]===_0x44e9e5(0x1ff),_0x1ffe2e=_0x518663['status']===_0x44e9e5(0x1ff),_0x42f933=!_0x2d063f&&!_0x2af521&&_0x412af3&&_0x1ffe2e,_0x1dde0e=Math[_0x44e9e5(0x1e0)](0x0,_0x518663['maxPayments']-_0x518663[_0x44e9e5(0x1ea)]);return{'id':_0x518663['id'],'amount':_0x518663[_0x44e9e5(0x13f)],'currency':_0x518663['currency'],'sourceCurrency':_0x518663[_0x44e9e5(0x1d0)]||undefined,'gateway':_0x518663[_0x44e9e5(0x172)],'maxPayments':_0x518663[_0x44e9e5(0x155)],'currentPayments':_0x518663[_0x44e9e5(0x1ea)],'status':_0x518663[_0x44e9e5(0x179)],'expiresAt':_0x518663[_0x44e9e5(0x17e)]||undefined,'shopName':_0x518663[_0x44e9e5(0x1e3)][_0x44e9e5(0x141)],'isAvailable':_0x42f933,'remainingPayments':_0x1dde0e};}async[a45_0x38c571(0x195)](_0x26d4fb){const _0x55f45f=a45_0x38c571,{linkId:_0x1fd2ef,customerEmail:_0x3c508f,customerName:_0x405619}=_0x26d4fb,_0x76f591=await database_1[_0x55f45f(0x16c)][_0x55f45f(0x19b)]['findUnique']({'where':{'id':_0x1fd2ef},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x76f591)throw new Error(_0x55f45f(0x190));const _0x3e14b7=_0x76f591['expiresAt']&&_0x76f591[_0x55f45f(0x17e)]<new Date(),_0x532e92=_0x76f591['currentPayments']>=_0x76f591[_0x55f45f(0x155)],_0x13934c=_0x76f591['shop']['status']===_0x55f45f(0x1ff),_0x19f895=_0x76f591[_0x55f45f(0x179)]==='ACTIVE';if(_0x3e14b7)throw new Error(_0x55f45f(0x17d));if(_0x532e92)throw new Error(_0x55f45f(0x1c4));if(!_0x13934c)throw new Error(_0x55f45f(0x1d7));if(!_0x19f895)throw new Error(_0x55f45f(0x153));await this[_0x55f45f(0x20a)](_0x76f591['shopId'],_0x76f591[_0x55f45f(0x172)]);const _0x27ce07=_0x76f591[_0x55f45f(0x13f)];console[_0x55f45f(0x1e8)](_0x55f45f(0x149)+_0x1fd2ef+':\x20'+_0x27ce07+'\x20'+_0x76f591[_0x55f45f(0x178)]),console[_0x55f45f(0x1e8)]('üë§\x20Customer:\x20'+(_0x405619||_0x55f45f(0x14b))+'\x20('+(_0x3c508f||_0x55f45f(0x1df))+')'),this[_0x55f45f(0x14e)](_0x76f591[_0x55f45f(0x172)],_0x76f591['currency']);const _0x4e1649=this[_0x55f45f(0x18a)]();console[_0x55f45f(0x1e8)]('üéØ\x20Generated\x20gateway\x20order_id:\x20'+_0x4e1649+_0x55f45f(0x176)+_0x76f591[_0x55f45f(0x172)]+')');const _0xfe5ec3=process[_0x55f45f(0x197)][_0x55f45f(0x1b2)]||'https://tesoft.uk',{finalSuccessUrl:_0x333843,finalFailUrl:_0x217311,dbSuccessUrl:_0x1ac4b0,dbFailUrl:_0x23f5d0}=this[_0x55f45f(0x154)](_0x76f591[_0x55f45f(0x172)],_0x4e1649,_0xfe5ec3,_0x76f591[_0x55f45f(0x1f5)]||undefined,_0x76f591[_0x55f45f(0x1c9)]||undefined),_0x5d4ac1=await database_1[_0x55f45f(0x16c)][_0x55f45f(0x168)][_0x55f45f(0x1f1)]({'data':{'shopId':_0x76f591['shopId'],'paymentLinkId':_0x76f591['id'],'gateway':_0x76f591[_0x55f45f(0x172)],'amount':_0x27ce07,'currency':_0x76f591[_0x55f45f(0x178)],'sourceCurrency':_0x76f591[_0x55f45f(0x1d0)]||undefined,'usage':_0x55f45f(0x202),'expiresAt':_0x76f591[_0x55f45f(0x17e)]||undefined,'successUrl':_0x1ac4b0,'failUrl':_0x23f5d0,'status':_0x55f45f(0x1fb),'orderId':null,'gatewayOrderId':_0x4e1649,'customerEmail':_0x3c508f||undefined,'customerName':_0x405619||undefined,'country':_0x76f591[_0x55f45f(0x19a)]||undefined,'language':_0x76f591[_0x55f45f(0x1c5)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x55f45f(0x1e8)](_0x55f45f(0x187)+_0x5d4ac1['id']),console[_0x55f45f(0x1e8)](_0x55f45f(0x204)+_0x27ce07+'\x20'+_0x76f591['currency']),console[_0x55f45f(0x1e8)](_0x55f45f(0x1d3)+(_0x405619||_0x55f45f(0x14b))+'\x20('+(_0x3c508f||'no\x20email')+')'),console[_0x55f45f(0x1e8)](_0x55f45f(0x169)+_0x1ac4b0),console['log']('üíæ\x20DB\x20Fail\x20URL:\x20'+_0x23f5d0);let _0x121b2a,_0x196ea6;try{if(_0x76f591[_0x55f45f(0x172)]==='plisio'){console[_0x55f45f(0x1e8)]('üí∞\x20Plisio\x20payment\x20link\x20mapping:'),console[_0x55f45f(0x1e8)](_0x55f45f(0x200)+_0x76f591['currency']),console[_0x55f45f(0x1e8)](_0x55f45f(0x1a5)+_0x76f591[_0x55f45f(0x1d0)]);const _0xbad74e=await this[_0x55f45f(0x1bd)][_0x55f45f(0x1eb)]({'paymentId':_0x5d4ac1['id'],'orderId':_0x4e1649,'amount':_0x27ce07,'currency':_0x76f591[_0x55f45f(0x178)],'productName':_0x55f45f(0x146)+_0x27ce07+'\x20'+_0x76f591[_0x55f45f(0x178)],'description':_0x55f45f(0x146)+_0x27ce07+'\x20'+_0x76f591[_0x55f45f(0x178)],'successUrl':_0x333843,'failUrl':_0x217311,'customerEmail':_0x3c508f||undefined,'customerName':_0x405619||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x76f591['sourceCurrency']||undefined});_0x121b2a=_0xbad74e[_0x55f45f(0x140)],_0x196ea6=_0xbad74e['payment_url'],await database_1[_0x55f45f(0x16c)][_0x55f45f(0x168)]['update']({'where':{'id':_0x5d4ac1['id']},'data':{'externalPaymentUrl':_0x196ea6,'gatewayPaymentId':_0x121b2a,'invoiceTotalSum':Number(_0xbad74e[_0x55f45f(0x1fa)]),'qrCode':_0xbad74e[_0x55f45f(0x1a9)],'qrUrl':_0xbad74e[_0x55f45f(0x1e6)]}});const _0x39337e='https://app.trapay.uk/payment/'+_0x5d4ac1['id'];return console[_0x55f45f(0x1e8)]('üîó\x20Plisio\x20payment\x20URL:\x20'+_0x39337e),{'paymentId':_0x5d4ac1['id'],'paymentUrl':_0x39337e,'expiresAt':_0x5d4ac1[_0x55f45f(0x17e)]||undefined};}else{if(_0x76f591[_0x55f45f(0x172)]===_0x55f45f(0x1c7)){const _0x1cbbd4=await this[_0x55f45f(0x1bb)][_0x55f45f(0x1ab)]({'paymentId':_0x5d4ac1['id'],'orderId':_0x4e1649,'orderName':'Payment\x20'+_0x27ce07+'\x20'+_0x76f591[_0x55f45f(0x178)],'amount':_0x27ce07,'currency':_0x76f591[_0x55f45f(0x178)],'country':_0x76f591[_0x55f45f(0x19a)],'language':_0x76f591[_0x55f45f(0x1c5)]||'EN','amountIsEditable':![],'usage':_0x55f45f(0x202),'maxPayments':0x1,'successUrl':_0x333843,'failUrl':_0x217311});_0x121b2a=_0x1cbbd4[_0x55f45f(0x140)],_0x196ea6=_0x1cbbd4[_0x55f45f(0x1a2)],await database_1[_0x55f45f(0x16c)]['payment']['update']({'where':{'id':_0x5d4ac1['id']},'data':{'externalPaymentUrl':_0x196ea6,'gatewayPaymentId':_0x121b2a}});const _0x3aa008=_0x55f45f(0x1b0)+_0x5d4ac1['id'];return console[_0x55f45f(0x1e8)](_0x55f45f(0x207)+_0x3aa008),{'paymentId':_0x5d4ac1['id'],'paymentUrl':_0x3aa008,'expiresAt':_0x5d4ac1[_0x55f45f(0x17e)]||undefined};}else{if(_0x76f591[_0x55f45f(0x172)]===_0x55f45f(0x20b)){const _0x144250=await this['nodaService']['createPaymentLink']({'paymentId':_0x5d4ac1['id'],'orderId':_0x4e1649,'name':_0x55f45f(0x146)+_0x27ce07+'\x20'+_0x76f591['currency'],'paymentDescription':_0x55f45f(0x146)+_0x27ce07+'\x20'+_0x76f591[_0x55f45f(0x178)],'amount':_0x27ce07,'currency':_0x76f591[_0x55f45f(0x178)],'webhookUrl':_0x55f45f(0x196),'returnUrl':_0x333843,'expiryDate':_0x76f591[_0x55f45f(0x17e)]?.[_0x55f45f(0x19e)]()});_0x121b2a=_0x144250[_0x55f45f(0x140)],_0x196ea6=_0x144250[_0x55f45f(0x1a2)],await database_1['default']['payment'][_0x55f45f(0x144)]({'where':{'id':_0x5d4ac1['id']},'data':{'externalPaymentUrl':_0x196ea6,'gatewayPaymentId':_0x121b2a,'qrUrl':_0x144250[_0x55f45f(0x14f)]}});const _0x5b1938=_0x55f45f(0x1b0)+_0x5d4ac1['id'];return console[_0x55f45f(0x1e8)](_0x55f45f(0x1bc)+_0x5b1938),{'paymentId':_0x5d4ac1['id'],'paymentUrl':_0x5b1938,'expiresAt':_0x5d4ac1[_0x55f45f(0x17e)]||undefined};}else{if(_0x76f591[_0x55f45f(0x172)]===_0x55f45f(0x159)){console[_0x55f45f(0x1e8)](_0x55f45f(0x1f7)+_0x4e1649+_0x55f45f(0x16a)),console[_0x55f45f(0x1e8)](_0x55f45f(0x204)+_0x27ce07+_0x55f45f(0x18d));const _0x391226=await this[_0x55f45f(0x17f)]['createPaymentLink']({'paymentId':_0x5d4ac1['id'],'orderId':_0x4e1649,'amount':_0x27ce07});_0x121b2a=_0x391226[_0x55f45f(0x140)],_0x196ea6=_0x391226[_0x55f45f(0x1a2)],await database_1[_0x55f45f(0x16c)][_0x55f45f(0x168)][_0x55f45f(0x144)]({'where':{'id':_0x5d4ac1['id']},'data':{'externalPaymentUrl':_0x196ea6,'gatewayPaymentId':_0x121b2a}});const _0x1fc4cb='https://tesoft.uk/gateway/payment.php?id='+_0x5d4ac1['id'];return console[_0x55f45f(0x1e8)]('üîó\x20CoinToPay\x20payment\x20URL:\x20'+_0x1fc4cb),{'paymentId':_0x5d4ac1['id'],'paymentUrl':_0x1fc4cb,'expiresAt':_0x5d4ac1['expiresAt']||undefined};}else{if(_0x76f591[_0x55f45f(0x172)]['startsWith']('klyme_')){const _0xab56bd=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x76f591[_0x55f45f(0x172)]);if(!_0xab56bd)throw new Error('Invalid\x20KLYME\x20gateway:\x20'+_0x76f591[_0x55f45f(0x172)]);console[_0x55f45f(0x1e8)]('üí≥\x20Creating\x20KLYME\x20'+_0xab56bd+_0x55f45f(0x1b9)+_0x4e1649+_0x55f45f(0x16a)),console[_0x55f45f(0x1e8)]('üí∞\x20Amount:\x20'+_0x27ce07+'\x20'+_0x76f591[_0x55f45f(0x178)]+'\x20(validated\x20for\x20'+_0xab56bd+')');const _0x1a11b5=await this[_0x55f45f(0x1be)][_0x55f45f(0x1ab)]({'paymentId':_0x5d4ac1['id'],'orderId':_0x4e1649,'amount':_0x27ce07,'currency':_0x76f591['currency'],'region':_0xab56bd,'redirectUrl':_0x333843});_0x121b2a=_0x1a11b5[_0x55f45f(0x140)],_0x196ea6=_0x1a11b5[_0x55f45f(0x1a2)],await database_1[_0x55f45f(0x16c)][_0x55f45f(0x168)]['update']({'where':{'id':_0x5d4ac1['id']},'data':{'externalPaymentUrl':_0x196ea6,'gatewayPaymentId':_0x121b2a}});const _0x3a2be=_0x55f45f(0x192)+_0x5d4ac1['id'];return console['log'](_0x55f45f(0x13e)+_0xab56bd+_0x55f45f(0x175)+_0x4e1649),console[_0x55f45f(0x1e8)](_0x55f45f(0x1a3)+_0xab56bd+'\x20payment\x20URL:\x20'+_0x3a2be),{'paymentId':_0x5d4ac1['id'],'paymentUrl':_0x3a2be,'expiresAt':_0x5d4ac1[_0x55f45f(0x17e)]||undefined};}else throw new Error('Unsupported\x20gateway:\x20'+_0x76f591['gateway']);}}}}}catch(_0x50a722){await database_1[_0x55f45f(0x16c)][_0x55f45f(0x168)][_0x55f45f(0x144)]({'where':{'id':_0x5d4ac1['id']},'data':{'status':_0x55f45f(0x183)}});throw new Error(_0x55f45f(0x1a4)+(_0x50a722 instanceof Error?_0x50a722[_0x55f45f(0x1d8)]:'Unknown\x20error'));}}async[a45_0x38c571(0x1a1)](_0x5b5b87){const _0x56c2ea=a45_0x38c571;console[_0x56c2ea(0x1e8)](_0x56c2ea(0x18c)+_0x5b5b87);const _0x2709ae=await database_1[_0x56c2ea(0x16c)][_0x56c2ea(0x168)]['findUnique']({'where':{'id':_0x5b5b87},'include':{'paymentLink':!![]}});if(!_0x2709ae||!_0x2709ae[_0x56c2ea(0x19b)]){console[_0x56c2ea(0x1e8)](_0x56c2ea(0x1e1)+_0x5b5b87+_0x56c2ea(0x1cb));return;}if(_0x2709ae[_0x56c2ea(0x179)]!==_0x56c2ea(0x15d)){console[_0x56c2ea(0x1e8)](_0x56c2ea(0x1e1)+_0x5b5b87+_0x56c2ea(0x15e)+_0x2709ae[_0x56c2ea(0x179)]+_0x56c2ea(0x186));return;}if(!_0x2709ae[_0x56c2ea(0x142)]){console[_0x56c2ea(0x1e8)](_0x56c2ea(0x1e1)+_0x5b5b87+_0x56c2ea(0x1ee));return;}try{const _0x2e6e8b=await database_1[_0x56c2ea(0x16c)]['$transaction'](async _0x1420ca=>{const _0x288817=_0x56c2ea,_0x4db8fc=await _0x1420ca[_0x288817(0x19b)][_0x288817(0x1a7)]({'where':{'id':_0x2709ae[_0x288817(0x14d)]},'select':{'id':!![],'currentPayments':!![],'maxPayments':!![],'status':!![]}});if(!_0x4db8fc)throw new Error(_0x288817(0x1c2)+_0x2709ae[_0x288817(0x14d)]+'\x20not\x20found');if(_0x4db8fc[_0x288817(0x1ea)]>=_0x4db8fc[_0x288817(0x155)])return console[_0x288817(0x1e8)](_0x288817(0x16f)+_0x2709ae[_0x288817(0x14d)]+'\x20already\x20at\x20max\x20payments\x20('+_0x4db8fc[_0x288817(0x1ea)]+'/'+_0x4db8fc[_0x288817(0x155)]+'),\x20skipping\x20increment'),_0x4db8fc;const _0x254de0=await _0x1420ca[_0x288817(0x168)][_0x288817(0x1d5)]({'where':{'paymentLinkId':_0x2709ae[_0x288817(0x14d)],'status':'PAID','paidAt':{'not':null},'id':{'not':_0x5b5b87}}}),_0x4a4d44=_0x254de0+0x1,_0x1edf18=await _0x1420ca[_0x288817(0x19b)][_0x288817(0x144)]({'where':{'id':_0x2709ae['paymentLinkId']},'data':{'currentPayments':_0x4a4d44,'status':_0x4a4d44>=_0x4db8fc[_0x288817(0x155)]?_0x288817(0x148):_0x4db8fc['status']}});return console[_0x288817(0x1e8)]('üìà\x20Payment\x20link\x20'+_0x2709ae[_0x288817(0x14d)]+_0x288817(0x18b)+_0x4db8fc[_0x288817(0x1ea)]+'\x20->\x20'+_0x4a4d44+'/'+_0x4db8fc[_0x288817(0x155)]),_0x1edf18;});_0x2e6e8b['status']===_0x56c2ea(0x148)&&console['log']('üèÅ\x20Payment\x20link\x20'+_0x2709ae[_0x56c2ea(0x14d)]+_0x56c2ea(0x1a0)+_0x2e6e8b[_0x56c2ea(0x1ea)]+'/'+_0x2e6e8b[_0x56c2ea(0x155)]+')');}catch(_0x57eb0f){console['error'](_0x56c2ea(0x19d)+_0x5b5b87+':',_0x57eb0f);}}async[a45_0x38c571(0x182)](_0xdcfd88){const _0x2d7d67=a45_0x38c571,[_0x52ab2d,_0x259a84,_0x50316f,_0x4a72de]=await Promise[_0x2d7d67(0x1aa)]([database_1['default'][_0x2d7d67(0x19b)]['count']({'where':{'shopId':_0xdcfd88}}),database_1[_0x2d7d67(0x16c)]['paymentLink'][_0x2d7d67(0x1d5)]({'where':{'shopId':_0xdcfd88,'status':_0x2d7d67(0x1ff)}}),database_1[_0x2d7d67(0x16c)]['payment']['count']({'where':{'shopId':_0xdcfd88,'paymentLinkId':{'not':null}}}),database_1['default']['payment']['findMany']({'where':{'shopId':_0xdcfd88,'paymentLinkId':{'not':null},'status':_0x2d7d67(0x15d)},'select':{'amount':!![],'currency':!![]}})]);let _0x23d88e=0x0;for(const _0x509c40 of _0x4a72de){const _0x5b6665=await currencyService_1['currencyService'][_0x2d7d67(0x1ae)](_0x509c40[_0x2d7d67(0x13f)],_0x509c40[_0x2d7d67(0x178)]);_0x23d88e+=_0x5b6665;}const _0x306554=_0x50316f>0x0?_0x4a72de[_0x2d7d67(0x17a)]/_0x50316f*0x64:0x0;return{'totalLinks':_0x52ab2d,'activeLinks':_0x259a84,'totalPayments':_0x50316f,'totalRevenue':Math[_0x2d7d67(0x15b)](_0x23d88e*0x64)/0x64,'conversionRate':Math[_0x2d7d67(0x15b)](_0x306554*0x64)/0x64};}[a45_0x38c571(0x1b7)](_0x5acdb5){const _0x6f34f8=a45_0x38c571;return{'id':_0x5acdb5['id'],'shopId':_0x5acdb5[_0x6f34f8(0x205)],'amount':_0x5acdb5['amount'],'currency':_0x5acdb5[_0x6f34f8(0x178)],'sourceCurrency':_0x5acdb5[_0x6f34f8(0x1d0)]||undefined,'gateway':_0x5acdb5[_0x6f34f8(0x172)],'maxPayments':_0x5acdb5[_0x6f34f8(0x155)],'currentPayments':_0x5acdb5[_0x6f34f8(0x1ea)],'status':_0x5acdb5['status'],'expiresAt':_0x5acdb5[_0x6f34f8(0x17e)]||undefined,'successUrl':_0x5acdb5[_0x6f34f8(0x1f5)]||undefined,'failUrl':_0x5acdb5[_0x6f34f8(0x1c9)]||undefined,'country':_0x5acdb5['country']||undefined,'language':_0x5acdb5[_0x6f34f8(0x1c5)]||undefined,'linkUrl':_0x6f34f8(0x193)+_0x5acdb5['id'],'createdAt':_0x5acdb5[_0x6f34f8(0x19c)],'updatedAt':_0x5acdb5[_0x6f34f8(0x1d9)],'shop':_0x5acdb5[_0x6f34f8(0x1e3)],'payments':_0x5acdb5[_0x6f34f8(0x181)]};}}exports[a45_0x38c571(0x1b3)]=PaymentLinkService;function a45_0x4f5c(){const _0x5ab650=[',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','üíæ\x20Payment\x20created\x20from\x20link:\x20','toUpperCase','‚úÖ\x20Payment\x20link\x20created:\x20','generateGatewayOrderId','\x20counter\x20updated:\x20','üìà\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','parse','Rapyd','Payment\x20link\x20not\x20found','‚úÖ\x20Gateway\x20\x22','https://app.trapay.uk/payment/','https://app.trapay.uk/link/','../types/gateway','initiatePaymentFromLink','https://tesoft.uk/gateways/noda/webhook','env','2wVYbaS','üí≥\x20Creating\x20KLYME\x20','country','paymentLink','createdAt','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','toISOString','updatePaymentLink','\x20completed\x20(reached\x20max\x20payments:\x20','handleSuccessfulPayment','payment_url','üîó\x20KLYME\x20','Gateway\x20error:\x20','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','getGatewayDisplayName','findUnique','random','qr_code','all','createPaymentLink','‚ùå\x20DB\x20Fail\x20URL:\x20','Error\x20parsing\x20payment\x20gateways:','convertToUSDT','üîó\x20Generated\x20URLs\x20for\x20','https://tesoft.uk/gateway/payment.php?id=','getGatewayNameById','BASE_URL','PaymentLinkService','./gateways/klymeService','‚ùå\x20Enabled\x20gateways:\x20','\x22\x20is\x20allowed\x20for\x20shop\x20','formatPaymentLinkResponse','./currencyService','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','18jTnfvp','rapydService','üîó\x20Noda\x20payment\x20URL:\x20','plisioService','klymeService','KLYME\x20EU','join','findFirst','Payment\x20link\x20','__importDefault','Payment\x20link\x20has\x20reached\x20maximum\x20payments','language','üîê\x20Shop\x20','rapyd','ceil','failUrl','KLYME\x20DE','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','1050650pyNlDg','ü™ô\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','4JgcWWB','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','sourceCurrency','/gateway/fail.php?id=','deletePaymentLink','üë§\x20Customer:\x20','getKlymeRegionFromGatewayName','count','GBP','Shop\x20is\x20not\x20active','message','updatedAt','./gateways/coinToPayService','KLYME\x20GB','KlymeService','Plisio','Noda','no\x20email','max','üìà\x20Payment\x20','temp','shop','üá¨üáß\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','qr_url','4626561ASdwVp','log','amount\x20is\x20required\x20and\x20must\x20be\x20positive','currentPayments','createPayment','./gateways/plisioService','CoinToPay','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','‚úÖ\x20DB\x20Success\x20URL:\x20','isValidGatewayId','create','357711WOKqSy','\x20using\x20default\x20gateways:','\x20payment\x20link','successUrl','paymentGateways','ü™ô\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','username','https://app.trapay.uk/payment/fail?id=','invoice_total_sum','PENDING','üîó\x20Link\x20URL:\x20https://app.trapay.uk/link/','3565820bqIcoa','PlisioService','ACTIVE','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','‚ùå\x20Gateway\x20\x22','ONCE','padStart','üí∞\x20Amount:\x20','shopId','startsWith','üîó\x20Rapyd\x20payment\x20URL:\x20','CoinToPayService','plisio','checkGatewayPermission','noda','Gateway\x20not\x20found\x20for\x20ID:\x20','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','üîê\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','üîó\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','‚úÖ\x20KLYME\x20','amount','gateway_payment_id','name','paidAt','toString','update','Enabled\x20gateways:\x20','Payment\x20','https://app.trapay.uk/payment/success?id=','COMPLETED','üí≥\x20Initiating\x20payment\x20from\x20link\x20','üá¨üáß\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','Anonymous','toLowerCase','paymentLinkId','validateKlymeCurrency','qr_code_url','4229785QYyxOF','40106033jNAXcu','EUR','Payment\x20link\x20is\x20not\x20active','generateGatewayUrls','maxPayments','Unsupported\x20KLYME\x20region:\x20','klyme_','\x22\x20not\x20allowed\x20for\x20shop\x20','cointopay','\x20\x20\x20üåê\x20Gateway\x20Success\x20URL:\x20','round','insensitive','PAID','\x20status\x20is\x20','https://app.trapay.uk/payment/pending?id=','error','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x22\x20is\x20in\x20enabled\x20gateways:','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','520952KrUAEU','Gateway\x20\x22','/gateway/success.php?id=','getPaymentLinkById','payment','üíæ\x20DB\x20Success\x20URL:\x20','\x20(8digits-8digits\x20format)','\x20enabled\x20gateways:','default','/gateway/pending.php?id=','defineProperty','üìà\x20Payment\x20link\x20','desc','RapydService','gateway','__esModule','üîê\x20Checking\x20if\x20\x22','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','\x20(8digits-8digits\x20format\x20for\x20','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','currency','status','length','Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.','Shop\x20not\x20found','Payment\x20link\x20has\x20expired','expiresAt','coinToPayService','nodaService','payments','getPaymentLinkStatistics','FAILED','./gateways/nodaService','207gpZxMG'];a45_0x4f5c=function(){return _0x5ab650;};return a45_0x4f5c();}