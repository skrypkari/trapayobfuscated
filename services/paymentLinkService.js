'use strict';function a52_0x1914(_0x1681d8,_0x4ab83b){const _0x31b0a7=a52_0x31b0();return a52_0x1914=function(_0x19140d,_0x163c1c){_0x19140d=_0x19140d-0x7c;let _0x5e41b6=_0x31b0a7[_0x19140d];return _0x5e41b6;},a52_0x1914(_0x1681d8,_0x4ab83b);}const a52_0x3c31ec=a52_0x1914;(function(_0x36ce40,_0x5b1fff){const _0x2645d2=a52_0x1914,_0x38aaf3=_0x36ce40();while(!![]){try{const _0x39045e=parseInt(_0x2645d2(0x87))/0x1*(-parseInt(_0x2645d2(0x187))/0x2)+-parseInt(_0x2645d2(0x162))/0x3*(parseInt(_0x2645d2(0x125))/0x4)+-parseInt(_0x2645d2(0x16c))/0x5+-parseInt(_0x2645d2(0x1a6))/0x6+-parseInt(_0x2645d2(0xf8))/0x7*(parseInt(_0x2645d2(0x171))/0x8)+-parseInt(_0x2645d2(0xd3))/0x9+parseInt(_0x2645d2(0x80))/0xa;if(_0x39045e===_0x5b1fff)break;else _0x38aaf3['push'](_0x38aaf3['shift']());}catch(_0x4b4462){_0x38aaf3['push'](_0x38aaf3['shift']());}}}(a52_0x31b0,0x82a36));var __importDefault=this&&this['__importDefault']||function(_0x9bcb6a){const _0x380b58=a52_0x1914;return _0x9bcb6a&&_0x9bcb6a[_0x380b58(0xbf)]?_0x9bcb6a:{'default':_0x9bcb6a};};function a52_0x31b0(){const _0x2227d2=['💰\x20Gateway\x20','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','🔗\x20Plisio\x20payment\x20URL:\x20','noda','klyme_','🔗\x20Test\x20Gateway\x20payment\x20URL:\x20','Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.','🔗\x20MasterCard\x20payment\x20URL:\x20','validateKlymeCurrency','35280290YqeBiY','\x20USDT\x20for\x20','https://app.trapay.uk/payment/fail?id=','\x20(domain:\x20','defineProperty','\x20USDT','Payment\x20','53569sDYMTM','\x20completed\x20(','./gateways/coinToPay2Service','toString','./coinToPayStatusService','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','📈\x20Current\x20payment\x20link\x20state:','\x20with\x20payment\x20ID\x20','paymentLinkId','\x20->\x20','\x20USDT\x20meets\x20minimum\x20requirement\x20of\x20','length','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','💰\x20No\x20minimum\x20amount\x20set\x20for\x20gateway\x20','amount','🔗\x20Generated\x20URLs\x20for\x20','updatedAt','🔗\x20Rapyd\x20payment\x20URL:\x20','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','checkGatewayPermission','currentPayments','\x20gateway.\x20','\x20enabled\x20gateways\x20(internal):','\x20payment\x20link','KlymeService','payment_url','\x20to\x20','PaymentLinkService','🔗\x20No\x20whiteUrl\x20for\x20','SINGLE','🔐\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20','Noda','EUR','plisio','coinToPay2Service','💳\x20Creating\x20KLYME\x20','handleSuccessfulPayment','currency','📝\x20Note:\x20Success/Fail/Pending\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created','&payment_id=','createPaymentLink','\x20already\x20used\x20(','Gateway\x20\x22','Payment\x20not\x20found','successUrl','\x20\x20\x20-\x20Is\x20expired:\x20','GBP','RapydService','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20','startsWith','insensitive','\x20USDT)\x20is\x20below\x20the\x20minimum\x20required\x20amount\x20of\x20','parse','test_','\x20(Plisio\x20or\x20KLYME)','__esModule','./gateways/rapydService','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','paidAt','expiresAt','convertToUSDT','pendingUrl','cointopay','/gateway/fail.php?id=','\x22\x20is\x20allowed\x20for\x20shop\x20','currencyService','🔗\x20White\x20URL:\x20','\x20payments),\x20skipping\x20increment','./gateways/klymeService','getPaymentLinkStatistics','test_gateway','./currencyService','✅\x20Payment\x20link\x20created:\x20','desc','Rapyd','6826167DqfidZ','\x20\x20\x20🌐\x20Gateway\x20Pending\x20URL:\x20','💾\x20Payment\x20created:\x20','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','💰\x20Checking\x20amount\x20limits\x20for\x20gateway:\x20','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','error','\x20payment\x20URL:\x20','Please\x20increase\x20the\x20amount.','schedulePaymentChecks','createdAt','🔗\x20Public\x20link\x20','🔗\x20Noda\x20payment\x20URL:\x20','https://app.trapay.uk/payment/','\x20gateway\x20settings:','💰\x20Amount:\x20','initiatePaymentFromLink','PENDING','paymentGateways','\x20link\x20with\x20','payment','maxAmount','coinToPayService','name','type','\x20USDT\x20for\x20limit\x20checking','📈\x20All\x20conditions\x20met\x20for\x20payment\x20','PlisioService','\x20not\x20found','paymentLink','💳\x20Initiating\x20payment\x20from\x20','🏁\x20Payment\x20link\x20','floor','❌\x20Amount\x20','KLYME\x20EU','\x20\x20\x20-\x20Current\x20payments:\x20','\x20\x20\x20-\x20Type:\x20','1960donQcQ','💰\x20Fixed\x20amount:\x20','nodaService','ACTIVE','🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/','\x20payment\x20link\x20update','/gateway/payment.php?id=','update','amer_','log','https://app.trapay.uk/test-gateway/payment/','./gateways/plisioService','getGatewayDisplayName','toUpperCase','multi-use','\x20status\x20calculation:','status','📈\x20Single\x20payment\x20link\x20','\x20\x20\x20-\x20Effective\x20status:\x20','\x20\x20\x20-\x20Status:\x20','delete','Payment\x20amount\x20','\x22\x20is\x20in\x20enabled\x20gateways:','getKlymeRegionFromGatewayName','Payment\x20link\x20','\x20\x20\x20🔗\x20White\x20URL:\x20','\x20USDT\x20for\x20gateway\x20','📈\x20Existing\x20successful\x20payments\x20for\x20link\x20','rapyd','\x20link\x20','/gateway/pending.php?id=','gateway','plisioService','💱\x20Converted\x20','EXPIRED','🧪\x20Creating\x20Test\x20Gateway\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','📈\x20Payment\x20found:','❌\x20Gateway\x20\x22','sourceCurrency','Shop\x20is\x20not\x20active','🔗\x20KLYME\x20','💰\x20Checking\x20amount\x20limits\x20for\x20shop\x20','FAILED','📈\x20Updating\x20payment\x20link\x20','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','292JPHFNG','createPayment','invoice_total_sum','qr_code_url','Payment\x20link\x20has\x20reached\x20maximum\x20payments','payments','default','📧\x20URL\x20параметры:','findFirst','🔗\x20CoinToPay\x20payment\x20URL:\x20','count','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE),\x201111\x20(MasterCard),\x201110\x20(Amer)','../types/gateway','https://app.trapay.uk/payment/pending?id=','💰\x20No\x20maximum\x20amount\x20set\x20for\x20gateway\x20','round','rapydService','💳\x20Creating\x20Amer\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','failUrl','padStart','\x20using\x20default\x20gateways:','message','random','traffer.uk','Test\x20Gateway','\x20minimum\x20amount:\x20','KLYME\x20DE','amer','none','map','Shop\x20not\x20found','This\x20single-use\x20payment\x20link\x20has\x20already\x20been\x20used','MAX_SAFE_INTEGER','Payment\x20link\x20not\x20found','payment_id','deletePaymentLink','all','NodaService','\x20\x20\x20-\x20Database\x20status:\x20','includes','language','gatewaySettings','coinToPayStatusService','shopId','https://app.trapay.uk/link/','💾\x20DB\x20Pending\x20URL:\x20','generateGatewayUrls','create','shop','email','generateGatewayOrderId','cointopay2','checkAmountLimits','isValidGatewayId','findUnique','Unknown\x20error','PAID','🔗\x20Generated\x20whiteUrl\x20for\x20','📈\x20Payment\x20link\x20','gateway_payment_id','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','29433UxMiKU','join','findMany','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20','\x20(Test\x20Gateway)',',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','📈\x20Payment\x20','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','Unsupported\x20gateway:\x20','\x20enabled\x20gateways\x20(display):','2766430SoHyvS','🔐\x20Checking\x20if\x20\x22','getPublicPaymentLinkData','Error\x20parsing\x20payment\x20gateways:','\x20payments)','12264RLphKd','Anonymous','\x20(8digits-8digits\x20format)','Open\x20Banking\x202','amount\x20is\x20required\x20and\x20must\x20be\x20positive',')\x20counter\x20updated:\x20','Invalid\x20gateway\x20ID:\x20',',\x20proceeding\x20with\x20payment\x20link\x20counter\x20update','Unsupported\x20KLYME\x20region:\x20','./gateways/amerService','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','mastercard','Plisio','no\x20email','\x20(validated\x20for\x20','toFixed','💳\x20MasterCard\x20form\x20URL:\x20','env','minAmount','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','🔗\x20Amer\x20payment\x20URL:\x20','2ZaSTXQ','COMPLETED','\x22\x20not\x20allowed\x20for\x20shop\x20','\x20\x20\x20💾\x20DB\x20Pending\x20URL:\x20','klymeService','temp','USD','👤\x20Customer:\x20','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','🔗\x20Creating\x20','🧪\x20Test\x20Gateway\x20form\x20URL:\x20','✅\x20Amount\x20','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','https://api2.trapay.uk/payment.php?','country','BASE_URL','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','🔐\x20Shop\x20','append','Enabled\x20gateways:\x20','Payment\x20link\x20has\x20expired','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','getGatewayNameById','https://tesoft.uk/gateways/noda/webhook','getPaymentLinkById','Gateway\x20error:\x20','/gateway/success.php?id=','$transaction','\x20USDT\x20meets\x20maximum\x20requirement\x20of\x20','formatPaymentLinkResponse','username','2893044rbkawx','./gateways/nodaService','toLowerCase'];a52_0x31b0=function(){return _0x2227d2;};return a52_0x31b0();}Object[a52_0x3c31ec(0x84)](exports,a52_0x3c31ec(0xbf),{'value':!![]}),exports[a52_0x3c31ec(0xa2)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a52_0x3c31ec(0x103)),rapydService_1=require(a52_0x3c31ec(0xc0)),nodaService_1=require(a52_0x3c31ec(0x1a7)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a52_0x3c31ec(0x89)),klymeService_1=require(a52_0x3c31ec(0xcc)),amerService_1=require(a52_0x3c31ec(0x17a)),coinToPayStatusService_1=require(a52_0x3c31ec(0x8b)),gateway_1=require(a52_0x3c31ec(0x131)),currencyService_1=require(a52_0x3c31ec(0xcf));class PaymentLinkService{constructor(){const _0x35db14=a52_0x3c31ec;this[_0x35db14(0x118)]=new plisioService_1[(_0x35db14(0xee))](),this[_0x35db14(0x135)]=new rapydService_1[(_0x35db14(0xb7))](),this[_0x35db14(0xfa)]=new nodaService_1[(_0x35db14(0x14a))](),this[_0x35db14(0xe9)]=new coinToPayService_1['CoinToPayService'](),this[_0x35db14(0xaa)]=new coinToPay2Service_1['CoinToPay2Service'](),this[_0x35db14(0x18b)]=new klymeService_1[(_0x35db14(0x9f))](),this['amerService']=new amerService_1['AmerService']();}[a52_0x3c31ec(0x157)](){const _0x305124=()=>{const _0x256b55=a52_0x1914;return Math[_0x256b55(0xf3)](Math[_0x256b55(0x13b)]()*0x5f5e100)[_0x256b55(0x8a)]()[_0x256b55(0x138)](0x8,'0');};return _0x305124()+'-'+_0x305124();}['generateGatewayUrls'](_0x2b03db,_0x21b0c9,_0x24757f,_0x214ac7,_0x35d25d,_0xa80662,_0x36c483){const _0x59d78d=a52_0x3c31ec;if(_0x35d25d&&_0xa80662&&_0x36c483)return{'finalSuccessUrl':_0x35d25d,'finalFailUrl':_0xa80662,'finalPendingUrl':_0x36c483,'dbSuccessUrl':_0x35d25d,'dbFailUrl':_0xa80662,'dbPendingUrl':_0x36c483,'whiteUrl':null};const _0x232f5b=_0x35d25d||'https://app.trapay.uk/payment/success?id='+_0x21b0c9+_0x59d78d(0xaf)+_0x24757f,_0x425930=_0xa80662||_0x59d78d(0x82)+_0x21b0c9+'&payment_id='+_0x24757f,_0x2d7b62=_0x36c483||_0x59d78d(0x132)+_0x21b0c9+_0x59d78d(0xaf)+_0x24757f;let _0x5a34cb,_0x8a3cfe,_0x133745;_0x2b03db==='noda'||_0x2b03db[_0x59d78d(0xb9)]('klyme_')||_0x2b03db===_0x59d78d(0xc6)||_0x2b03db===_0x59d78d(0x158)?(_0x5a34cb=_0x214ac7+_0x59d78d(0x116)+_0x21b0c9,_0x133745=_0x214ac7+_0x59d78d(0x116)+_0x21b0c9):(_0x5a34cb=_0x214ac7+_0x59d78d(0x1a1)+_0x21b0c9,_0x133745=_0x214ac7+_0x59d78d(0x116)+_0x21b0c9);_0x8a3cfe=_0x214ac7+_0x59d78d(0xc7)+_0x21b0c9;let _0x311f23=null;if(_0x2b03db!==_0x59d78d(0xa9)&&!_0x2b03db[_0x59d78d(0xb9)](_0x59d78d(0x1ad))){const _0xd905b3=_0x2b03db===_0x59d78d(0x158)?_0x59d78d(0x13c):'tesoft.uk';_0x311f23='https://'+_0xd905b3+_0x59d78d(0xfe)+_0x21b0c9,console[_0x59d78d(0x101)](_0x59d78d(0x15e)+_0x2b03db+':\x20'+_0x311f23+_0x59d78d(0x83)+_0xd905b3+')');}else console[_0x59d78d(0x101)](_0x59d78d(0xa3)+_0x2b03db+_0x59d78d(0xbe));return console[_0x59d78d(0x101)](_0x59d78d(0x96)+_0x2b03db+_0x59d78d(0x8e)+_0x21b0c9+':'),console[_0x59d78d(0x101)](_0x59d78d(0x18f)+_0x5a34cb),console[_0x59d78d(0x101)](_0x59d78d(0xd8)+_0x8a3cfe),console[_0x59d78d(0x101)](_0x59d78d(0xd4)+_0x133745),console[_0x59d78d(0x101)](_0x59d78d(0xc1)+_0x232f5b),console[_0x59d78d(0x101)]('\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20'+_0x425930),console[_0x59d78d(0x101)](_0x59d78d(0x18a)+_0x2d7b62),console['log'](_0x59d78d(0x111)+(_0x311f23||_0x59d78d(0x141))),{'finalSuccessUrl':_0x5a34cb,'finalFailUrl':_0x8a3cfe,'finalPendingUrl':_0x133745,'dbSuccessUrl':_0x232f5b,'dbFailUrl':_0x425930,'dbPendingUrl':_0x2d7b62,'whiteUrl':_0x311f23};}[a52_0x3c31ec(0x7f)](_0x4fe6f8,_0x56df4c){const _0x1753de=a52_0x3c31ec;if(!_0x4fe6f8[_0x1753de(0xb9)]('klyme_'))return;const _0x378e36=(0x0,gateway_1[_0x1753de(0x10f)])(_0x4fe6f8),_0x54214d=_0x56df4c[_0x1753de(0x105)]();switch(_0x378e36){case'EU':if(_0x54214d!==_0x1753de(0xa8))throw new Error(_0x1753de(0x185)+_0x54214d);break;case'GB':if(_0x54214d!==_0x1753de(0xb6))throw new Error(_0x1753de(0x1aa)+_0x54214d);break;case'DE':if(_0x54214d!==_0x1753de(0xa8))throw new Error(_0x1753de(0x161)+_0x54214d);break;default:throw new Error(_0x1753de(0x179)+_0x378e36);}}async[a52_0x3c31ec(0x159)](_0x35a5d3,_0x5871b3,_0x4bfb52,_0x10d8d0){const _0x45ad93=a52_0x3c31ec;console[_0x45ad93(0x101)](_0x45ad93(0x121)+_0x35a5d3+',\x20gateway\x20'+_0x5871b3+',\x20amount:\x20'+_0x4bfb52+'\x20'+_0x10d8d0);const _0x3ad5a5=await currencyService_1[_0x45ad93(0xc9)][_0x45ad93(0xc4)](_0x4bfb52,_0x10d8d0);console[_0x45ad93(0x101)](_0x45ad93(0x119)+_0x4bfb52+'\x20'+_0x10d8d0+_0x45ad93(0xa1)+_0x3ad5a5[_0x45ad93(0x181)](0x6)+_0x45ad93(0xec));const _0x24c46b=await database_1[_0x45ad93(0x12b)]['shop'][_0x45ad93(0x15b)]({'where':{'id':_0x35a5d3},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x24c46b)throw new Error(_0x45ad93(0x143));let _0x36eef9={};if(_0x24c46b[_0x45ad93(0x14e)])try{_0x36eef9=JSON[_0x45ad93(0xbc)](_0x24c46b[_0x45ad93(0x14e)]),console['log']('💰\x20Shop\x20'+_0x24c46b[_0x45ad93(0x1a5)]+_0x45ad93(0xe1),_0x36eef9);}catch(_0x5ae5c9){console['error']('Error\x20parsing\x20gateway\x20settings:',_0x5ae5c9),_0x36eef9={};}const _0x50a32e=this[_0x45ad93(0x104)](_0x5871b3);console[_0x45ad93(0x101)](_0x45ad93(0xd7)+_0x5871b3+_0x45ad93(0x90)+_0x50a32e);const _0x2ed24=_0x36eef9[_0x50a32e];if(_0x2ed24&&_0x2ed24[_0x45ad93(0x184)]!==undefined){const _0x43fa63=_0x2ed24[_0x45ad93(0x184)];console[_0x45ad93(0x101)]('💰\x20Gateway\x20'+_0x50a32e+_0x45ad93(0x13e)+_0x43fa63+_0x45ad93(0x85));if(_0x3ad5a5<_0x43fa63){console[_0x45ad93(0xd9)]('❌\x20Amount\x20'+_0x3ad5a5[_0x45ad93(0x181)](0x6)+'\x20USDT\x20is\x20below\x20minimum\x20'+_0x43fa63+_0x45ad93(0x112)+_0x50a32e);throw new Error(_0x45ad93(0x10d)+_0x4bfb52+'\x20'+_0x10d8d0+'\x20('+_0x3ad5a5[_0x45ad93(0x181)](0x2)+_0x45ad93(0xbb)+_0x43fa63+_0x45ad93(0x81)+_0x50a32e+_0x45ad93(0x9c)+_0x45ad93(0xdb));}console[_0x45ad93(0x101)](_0x45ad93(0x192)+_0x3ad5a5['toFixed'](0x6)+_0x45ad93(0x91)+_0x43fa63+'\x20USDT\x20for\x20gateway\x20'+_0x50a32e);}else console[_0x45ad93(0x101)](_0x45ad93(0x94)+_0x50a32e);if(_0x2ed24&&_0x2ed24[_0x45ad93(0xe8)]!==undefined){const _0x266699=_0x2ed24['maxAmount'];console[_0x45ad93(0x101)](_0x45ad93(0x1a9)+_0x50a32e+'\x20maximum\x20amount:\x20'+_0x266699+_0x45ad93(0x85));if(_0x3ad5a5>_0x266699){console['error'](_0x45ad93(0xf4)+_0x3ad5a5[_0x45ad93(0x181)](0x6)+'\x20USDT\x20exceeds\x20maximum\x20'+_0x266699+'\x20USDT\x20for\x20gateway\x20'+_0x50a32e);throw new Error(_0x45ad93(0x10d)+_0x4bfb52+'\x20'+_0x10d8d0+'\x20('+_0x3ad5a5[_0x45ad93(0x181)](0x2)+'\x20USDT)\x20exceeds\x20the\x20maximum\x20allowed\x20amount\x20of\x20'+_0x266699+_0x45ad93(0x81)+_0x50a32e+'\x20gateway.\x20'+'Please\x20reduce\x20the\x20amount.');}console[_0x45ad93(0x101)](_0x45ad93(0x192)+_0x3ad5a5['toFixed'](0x6)+_0x45ad93(0x1a3)+_0x266699+_0x45ad93(0x112)+_0x50a32e);}else console[_0x45ad93(0x101)](_0x45ad93(0x133)+_0x50a32e);}async[a52_0x3c31ec(0x9a)](_0x17c242,_0x369af9){const _0x402dff=a52_0x3c31ec;console[_0x402dff(0x101)](_0x402dff(0xa5)+_0x17c242+':\x20'+_0x369af9);const _0x525945=await database_1[_0x402dff(0x12b)][_0x402dff(0x155)]['findUnique']({'where':{'id':_0x17c242},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x525945)throw new Error(_0x402dff(0x143));let _0x2db5f3=[];if(_0x525945[_0x402dff(0xe5)])try{const _0x5340a7=JSON['parse'](_0x525945[_0x402dff(0xe5)]);_0x2db5f3=_0x5340a7[_0x402dff(0x142)](_0x40971c=>this[_0x402dff(0x104)](_0x40971c)),console[_0x402dff(0x101)](_0x402dff(0x198)+_0x525945[_0x402dff(0x1a5)]+_0x402dff(0x9d),_0x5340a7),console[_0x402dff(0x101)](_0x402dff(0x198)+_0x525945[_0x402dff(0x1a5)]+_0x402dff(0x16b),_0x2db5f3);}catch(_0x2c5222){console[_0x402dff(0xd9)](_0x402dff(0x16f),_0x2c5222),_0x2db5f3=['Plisio'];}else _0x2db5f3=[_0x402dff(0x17e)],console['log'](_0x402dff(0x198)+_0x525945[_0x402dff(0x1a5)]+_0x402dff(0x139),_0x2db5f3);const _0xdb4c54=this['getGatewayDisplayName'](_0x369af9);console[_0x402dff(0x101)](_0x402dff(0x16d)+_0xdb4c54+_0x402dff(0x10e),_0x2db5f3);if(!_0x2db5f3[_0x402dff(0x14c)](_0xdb4c54)){console['error'](_0x402dff(0x11d)+_0xdb4c54+_0x402dff(0x189)+_0x525945[_0x402dff(0x1a5)]),console[_0x402dff(0xd9)]('❌\x20Enabled\x20gateways:\x20'+_0x2db5f3[_0x402dff(0x163)](',\x20'));throw new Error(_0x402dff(0xb2)+_0xdb4c54+'\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20'+(_0x402dff(0x19a)+_0x2db5f3['join'](',\x20')+'.\x20')+_0x402dff(0x7d));}console[_0x402dff(0x101)]('✅\x20Gateway\x20\x22'+_0xdb4c54+_0x402dff(0xc8)+_0x525945[_0x402dff(0x1a5)]);}['getGatewayDisplayName'](_0x3eb042){const _0x2052e6=a52_0x3c31ec,_0x3d4250={'test_gateway':_0x2052e6(0x13d),'plisio':'Plisio','rapyd':_0x2052e6(0xd2),'noda':_0x2052e6(0xa7),'cointopay':'CoinToPay','cointopay2':_0x2052e6(0x174),'klyme_eu':_0x2052e6(0xf5),'klyme_gb':'KLYME\x20GB','klyme_de':_0x2052e6(0x13f),'mastercard':'MasterCard','amer':'Amer'};return _0x3d4250[_0x3eb042]||_0x3eb042;}async[a52_0x3c31ec(0xb0)](_0x30d5d7,_0x15eb53){const _0x121a43=a52_0x3c31ec;if(!(0x0,gateway_1[_0x121a43(0x15a)])(_0x15eb53[_0x121a43(0x117)]))throw new Error(_0x121a43(0x177)+_0x15eb53[_0x121a43(0x117)]+_0x121a43(0x130));const _0x35e1d9=(0x0,gateway_1[_0x121a43(0x19d)])(_0x15eb53[_0x121a43(0x117)]);if(!_0x35e1d9)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x15eb53[_0x121a43(0x117)]);console[_0x121a43(0x101)]('🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20'+_0x35e1d9),await this[_0x121a43(0x9a)](_0x30d5d7,_0x35e1d9);if(_0x35e1d9===_0x121a43(0xa9)&&!_0x15eb53['sourceCurrency'])throw new Error(_0x121a43(0x193));if(_0x35e1d9[_0x121a43(0xb9)](_0x121a43(0x1ad))){const _0x242229=(0x0,gateway_1[_0x121a43(0x10f)])(_0x35e1d9);console[_0x121a43(0x101)](_0x121a43(0xab)+_0x242229+'\x20payment\x20link');}let _0x324a4d=_0x15eb53[_0x121a43(0x195)];_0x35e1d9===_0x121a43(0x114)&&(_0x324a4d='GB',console['log'](_0x121a43(0x124)));if(!_0x15eb53['amount']||_0x15eb53['amount']<=0x0)throw new Error(_0x121a43(0x175));let _0x29e9f8=_0x15eb53[_0x121a43(0xad)]||_0x121a43(0x18d);(_0x35e1d9==='cointopay'||_0x35e1d9===_0x121a43(0x158))&&(_0x29e9f8=_0x121a43(0xa8),console[_0x121a43(0x101)](_0x121a43(0xa6)+_0x35e1d9+_0x121a43(0x9e)));this[_0x121a43(0x7f)](_0x35e1d9,_0x29e9f8),await this['checkAmountLimits'](_0x30d5d7,_0x35e1d9,_0x15eb53[_0x121a43(0x95)],_0x29e9f8);const _0x8f4fdc=_0x15eb53[_0x121a43(0xeb)]||_0x121a43(0xa4);console[_0x121a43(0x101)](_0x121a43(0x190)+_0x8f4fdc+_0x121a43(0x9e));const _0x171a49=await database_1[_0x121a43(0x12b)][_0x121a43(0xf0)][_0x121a43(0x154)]({'data':{'shopId':_0x30d5d7,'amount':_0x15eb53['amount'],'currency':_0x29e9f8,'sourceCurrency':_0x15eb53['sourceCurrency']||undefined,'gateway':_0x35e1d9,'type':_0x8f4fdc,'currentPayments':0x0,'status':_0x121a43(0xfb),'expiresAt':_0x15eb53[_0x121a43(0xc3)]?new Date(_0x15eb53['expiresAt']):undefined,'successUrl':_0x15eb53['successUrl']||null,'failUrl':_0x15eb53[_0x121a43(0x137)]||null,'pendingUrl':_0x15eb53[_0x121a43(0xc5)]||null,'country':_0x324a4d,'language':_0x15eb53[_0x121a43(0x14d)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x121a43(0x101)](_0x121a43(0xd0)+_0x171a49['id']+'\x20('+_0x35e1d9+')'),console['log'](_0x121a43(0xf9)+_0x171a49[_0x121a43(0x95)]+'\x20'+_0x171a49['currency']),console[_0x121a43(0x101)]('🔗\x20Link\x20type:\x20'+_0x171a49[_0x121a43(0xeb)]),console[_0x121a43(0x101)](_0x121a43(0xfc)+_0x171a49['id']),console['log'](_0x121a43(0xae)),this[_0x121a43(0x1a4)](_0x171a49);}async['getPaymentLinks'](_0x57fe8a,_0x24aaa8){const _0x5686b8=a52_0x3c31ec,{page:_0x10339d,limit:_0x4c4c77,status:_0x46cfe0,gateway:_0x88282c,search:_0x76d23c}=_0x24aaa8,_0x5d734a=(_0x10339d-0x1)*_0x4c4c77,_0x523b91={'shopId':_0x57fe8a};_0x46cfe0&&(_0x523b91['status']=_0x46cfe0[_0x5686b8(0x105)]());if(_0x88282c){if((0x0,gateway_1[_0x5686b8(0x15a)])(_0x88282c)){const _0x55cb7b=(0x0,gateway_1['getGatewayNameById'])(_0x88282c);_0x55cb7b&&(_0x523b91[_0x5686b8(0x117)]=_0x55cb7b);}else _0x523b91[_0x5686b8(0x117)]=_0x88282c['toLowerCase']();}_0x76d23c&&(_0x523b91['OR']=[{'gateway':{'contains':_0x76d23c,'mode':_0x5686b8(0xba)}},{'currency':{'contains':_0x76d23c,'mode':_0x5686b8(0xba)}}]);const [_0x462ab9,_0x23b5e9]=await Promise['all']([database_1['default'][_0x5686b8(0xf0)][_0x5686b8(0x164)]({'where':_0x523b91,'skip':_0x5d734a,'take':_0x4c4c77,'orderBy':{'createdAt':_0x5686b8(0xd1)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x5686b8(0xd1)},'take':0xa}}}),database_1['default'][_0x5686b8(0xf0)][_0x5686b8(0x12f)]({'where':_0x523b91})]);return{'links':_0x462ab9[_0x5686b8(0x142)](_0x2a2fdd=>this[_0x5686b8(0x1a4)](_0x2a2fdd)),'pagination':{'page':_0x10339d,'limit':_0x4c4c77,'total':_0x23b5e9,'totalPages':Math['ceil'](_0x23b5e9/_0x4c4c77)}};}async[a52_0x3c31ec(0x19f)](_0x4bd638,_0x4d4a0d){const _0x15e549=a52_0x3c31ec,_0x5be401=await database_1[_0x15e549(0x12b)][_0x15e549(0xf0)][_0x15e549(0x12d)]({'where':{'id':_0x4d4a0d,'shopId':_0x4bd638},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x15e549(0xd1)}}}});if(!_0x5be401)return null;return this[_0x15e549(0x1a4)](_0x5be401);}async['updatePaymentLink'](_0x11bd34,_0x57877b,_0x1ab6fe){const _0xfde036=a52_0x3c31ec,_0x1d5abb={..._0x1ab6fe};if(_0x1ab6fe['gateway']){if((0x0,gateway_1[_0xfde036(0x15a)])(_0x1ab6fe[_0xfde036(0x117)])){const _0x5c16c7=(0x0,gateway_1['getGatewayNameById'])(_0x1ab6fe['gateway']);_0x5c16c7&&(await this['checkGatewayPermission'](_0x11bd34,_0x5c16c7),_0x1d5abb[_0xfde036(0x117)]=_0x5c16c7);}else _0x1d5abb['gateway']=_0x1ab6fe[_0xfde036(0x117)][_0xfde036(0x1a8)]();}(_0x1d5abb[_0xfde036(0x117)]===_0xfde036(0x114)||_0x1ab6fe['country']&&_0x1d5abb[_0xfde036(0x117)]!==_0xfde036(0x114))&&(_0x1d5abb[_0xfde036(0x117)]==='rapyd'&&(_0x1d5abb['country']='GB',console[_0xfde036(0x101)]('🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update')));(_0x1d5abb[_0xfde036(0x117)]===_0xfde036(0xc6)||_0x1d5abb[_0xfde036(0x117)]===_0xfde036(0x158))&&(_0x1d5abb[_0xfde036(0xad)]='EUR',console[_0xfde036(0x101)](_0xfde036(0xb8)+_0x1d5abb['gateway']+_0xfde036(0xfd)));_0x1d5abb[_0xfde036(0x117)]&&_0x1d5abb[_0xfde036(0xad)]&&this[_0xfde036(0x7f)](_0x1d5abb[_0xfde036(0x117)],_0x1d5abb[_0xfde036(0xad)]);if(_0x1ab6fe['amount']&&_0x1d5abb['gateway']){const _0x456558=_0x1ab6fe['currency']||_0xfde036(0x18d);await this[_0xfde036(0x159)](_0x11bd34,_0x1d5abb[_0xfde036(0x117)],_0x1ab6fe[_0xfde036(0x95)],_0x456558);}_0x1ab6fe[_0xfde036(0xc3)]&&(_0x1d5abb[_0xfde036(0xc3)]=new Date(_0x1ab6fe[_0xfde036(0xc3)]));const _0x3cbcfd=await database_1[_0xfde036(0x12b)][_0xfde036(0xf0)][_0xfde036(0xff)]({'where':{'id':_0x57877b,'shopId':_0x11bd34},'data':_0x1d5abb,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0xfde036(0xd1)},'take':0xa}}});return this[_0xfde036(0x1a4)](_0x3cbcfd);}async[a52_0x3c31ec(0x148)](_0x4a3440,_0x58711d){const _0x149f3c=a52_0x3c31ec;await database_1[_0x149f3c(0x12b)][_0x149f3c(0xf0)][_0x149f3c(0x10c)]({'where':{'id':_0x58711d,'shopId':_0x4a3440}});}async[a52_0x3c31ec(0x16e)](_0x493bdb){const _0x1b531e=a52_0x3c31ec,_0x56fd3c=await database_1['default'][_0x1b531e(0xf0)][_0x1b531e(0x15b)]({'where':{'id':_0x493bdb},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x56fd3c)return null;const _0x1a357e=_0x56fd3c[_0x1b531e(0xc3)]&&_0x56fd3c[_0x1b531e(0xc3)]<new Date(),_0x242dca=_0x56fd3c[_0x1b531e(0xeb)]===_0x1b531e(0xa4)?_0x56fd3c['currentPayments']>=0x1:![],_0x5fad5f=_0x56fd3c[_0x1b531e(0x155)]['status']==='ACTIVE',_0x5857ce=_0x56fd3c[_0x1b531e(0x108)]==='ACTIVE',_0x884b4c=!_0x1a357e&&!_0x242dca&&_0x5fad5f&&_0x5857ce,_0x3e7aea=_0x56fd3c[_0x1b531e(0xeb)]===_0x1b531e(0xa4)?_0x56fd3c[_0x1b531e(0x9b)]>=0x1?0x0:0x1:Number[_0x1b531e(0x145)];let _0x55eee6=_0x56fd3c['status'];if(_0x242dca)_0x55eee6='COMPLETED';else _0x1a357e&&(_0x55eee6=_0x1b531e(0x11a));return console['log'](_0x1b531e(0xde)+_0x493bdb+_0x1b531e(0x107)),console[_0x1b531e(0x101)](_0x1b531e(0x14b)+_0x56fd3c[_0x1b531e(0x108)]),console[_0x1b531e(0x101)](_0x1b531e(0xf7)+_0x56fd3c['type']),console[_0x1b531e(0x101)](_0x1b531e(0xf6)+_0x56fd3c[_0x1b531e(0x9b)]),console[_0x1b531e(0x101)]('\x20\x20\x20-\x20Is\x20completed:\x20'+_0x242dca),console[_0x1b531e(0x101)](_0x1b531e(0xb5)+_0x1a357e),console[_0x1b531e(0x101)](_0x1b531e(0x10a)+_0x55eee6),{'id':_0x56fd3c['id'],'amount':_0x56fd3c[_0x1b531e(0x95)],'currency':_0x56fd3c[_0x1b531e(0xad)],'sourceCurrency':_0x56fd3c[_0x1b531e(0x11e)]||undefined,'gateway':_0x56fd3c[_0x1b531e(0x117)],'type':_0x56fd3c[_0x1b531e(0xeb)],'currentPayments':_0x56fd3c[_0x1b531e(0x9b)],'status':_0x55eee6,'expiresAt':_0x56fd3c['expiresAt']||undefined,'shopName':_0x56fd3c[_0x1b531e(0x155)][_0x1b531e(0xea)],'isAvailable':_0x884b4c,'remainingPayments':_0x3e7aea};}async[a52_0x3c31ec(0xe3)](_0x197831){const _0x30aaec=a52_0x3c31ec,{linkId:_0x19bf25,customerEmail:_0x5bf98a,customerName:_0x58807f}=_0x197831,_0x320d10=await database_1[_0x30aaec(0x12b)][_0x30aaec(0xf0)][_0x30aaec(0x15b)]({'where':{'id':_0x19bf25},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x320d10)throw new Error(_0x30aaec(0x146));const _0x488ea3=_0x320d10['expiresAt']&&_0x320d10['expiresAt']<new Date(),_0x4ae925=_0x320d10[_0x30aaec(0xeb)]===_0x30aaec(0xa4)?_0x320d10[_0x30aaec(0x9b)]>=0x1:![],_0xa9ee60=_0x320d10[_0x30aaec(0x155)]['status']===_0x30aaec(0xfb),_0x18bc25=_0x320d10[_0x30aaec(0x108)]===_0x30aaec(0xfb);if(_0x488ea3)throw new Error(_0x30aaec(0x19b));if(_0x4ae925){const _0x45d986=_0x320d10[_0x30aaec(0xeb)]===_0x30aaec(0xa4)?_0x30aaec(0x144):_0x30aaec(0x129);throw new Error(_0x45d986);}if(!_0xa9ee60)throw new Error(_0x30aaec(0x11f));if(!_0x18bc25)throw new Error('Payment\x20link\x20is\x20not\x20active');await this['checkGatewayPermission'](_0x320d10[_0x30aaec(0x150)],_0x320d10[_0x30aaec(0x117)]);const _0x2832db=_0x320d10[_0x30aaec(0x95)];console[_0x30aaec(0x101)](_0x30aaec(0xf1)+_0x320d10[_0x30aaec(0xeb)]+_0x30aaec(0x115)+_0x19bf25+':\x20'+_0x2832db+'\x20'+_0x320d10[_0x30aaec(0xad)]),console[_0x30aaec(0x101)](_0x30aaec(0x18e)+(_0x58807f||_0x30aaec(0x172))+'\x20('+(_0x5bf98a||_0x30aaec(0x17f))+')'),this['validateKlymeCurrency'](_0x320d10['gateway'],_0x320d10[_0x30aaec(0xad)]),await this[_0x30aaec(0x159)](_0x320d10[_0x30aaec(0x150)],_0x320d10['gateway'],_0x2832db,_0x320d10[_0x30aaec(0xad)]);const _0x477585=this['generateGatewayOrderId']();console[_0x30aaec(0x101)]('🎯\x20Generated\x20gateway\x20order_id:\x20'+_0x477585+'\x20(8digits-8digits\x20format\x20for\x20'+_0x320d10[_0x30aaec(0x117)]+')');const _0x4ae8da=await database_1['default']['payment'][_0x30aaec(0x154)]({'data':{'shopId':_0x320d10[_0x30aaec(0x150)],'paymentLinkId':_0x320d10['id'],'gateway':_0x320d10['gateway'],'amount':_0x2832db,'currency':_0x320d10[_0x30aaec(0xad)],'sourceCurrency':_0x320d10[_0x30aaec(0x11e)]||undefined,'usage':'ONCE','expiresAt':_0x320d10['expiresAt']||undefined,'successUrl':_0x30aaec(0x18c),'failUrl':_0x30aaec(0x18c),'pendingUrl':'temp','whiteUrl':_0x30aaec(0x18c),'status':_0x30aaec(0xe4),'orderId':null,'gatewayOrderId':_0x477585,'customerEmail':_0x5bf98a||undefined,'customerName':_0x58807f||undefined,'country':_0x320d10[_0x30aaec(0x195)]||undefined,'language':_0x320d10['language']||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x30aaec(0x101)](_0x30aaec(0xd5)+_0x4ae8da['id']);const _0x3eadbe=process[_0x30aaec(0x183)][_0x30aaec(0x196)]||'https://tesoft.uk',{finalSuccessUrl:_0x595f0c,finalFailUrl:_0x3632b5,finalPendingUrl:_0x5417f6,dbSuccessUrl:_0xdc0a35,dbFailUrl:_0x53416d,dbPendingUrl:_0x1b96ea,whiteUrl:_0x23aaf5}=this[_0x30aaec(0x153)](_0x320d10[_0x30aaec(0x117)],_0x4ae8da['id'],_0x477585,_0x3eadbe,_0x320d10[_0x30aaec(0xb4)]||undefined,_0x320d10[_0x30aaec(0x137)]||undefined,_0x320d10[_0x30aaec(0xc5)]||undefined);await database_1[_0x30aaec(0x12b)][_0x30aaec(0xe7)][_0x30aaec(0xff)]({'where':{'id':_0x4ae8da['id']},'data':{'successUrl':_0xdc0a35,'failUrl':_0x53416d,'pendingUrl':_0x1b96ea,'whiteUrl':_0x23aaf5}}),console[_0x30aaec(0x101)](_0x30aaec(0xe2)+_0x2832db+'\x20'+_0x320d10[_0x30aaec(0xad)]),console[_0x30aaec(0x101)](_0x30aaec(0x18e)+(_0x58807f||_0x30aaec(0x172))+'\x20('+(_0x5bf98a||'no\x20email')+')'),console[_0x30aaec(0x101)]('💾\x20DB\x20Success\x20URL:\x20'+_0xdc0a35),console[_0x30aaec(0x101)]('💾\x20DB\x20Fail\x20URL:\x20'+_0x53416d),console[_0x30aaec(0x101)](_0x30aaec(0x152)+_0x1b96ea),console[_0x30aaec(0x101)](_0x30aaec(0xca)+(_0x23aaf5||'none'));let _0x69ea61,_0x90c75d;try{if(_0x320d10[_0x30aaec(0x117)]===_0x30aaec(0xa9)){console['log']('💰\x20Plisio\x20payment\x20link\x20mapping:'),console[_0x30aaec(0x101)](_0x30aaec(0x197)+_0x320d10[_0x30aaec(0xad)]),console[_0x30aaec(0x101)](_0x30aaec(0x19c)+_0x320d10[_0x30aaec(0x11e)]);const _0x82c955=await this['plisioService'][_0x30aaec(0x126)]({'paymentId':_0x4ae8da['id'],'orderId':_0x477585,'amount':_0x2832db,'currency':_0x320d10[_0x30aaec(0xad)],'productName':_0x30aaec(0x86)+_0x2832db+'\x20'+_0x320d10[_0x30aaec(0xad)],'description':'Payment\x20'+_0x2832db+'\x20'+_0x320d10[_0x30aaec(0xad)],'successUrl':_0x595f0c,'failUrl':_0x3632b5,'customerEmail':_0x5bf98a||undefined,'customerName':_0x58807f||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x320d10[_0x30aaec(0x11e)]||undefined});_0x69ea61=_0x82c955[_0x30aaec(0x160)],_0x90c75d=_0x82c955[_0x30aaec(0xa0)],await database_1['default']['payment']['update']({'where':{'id':_0x4ae8da['id']},'data':{'externalPaymentUrl':_0x90c75d,'gatewayPaymentId':_0x69ea61,'invoiceTotalSum':Number(_0x82c955[_0x30aaec(0x127)]),'qrCode':_0x82c955['qr_code'],'qrUrl':_0x82c955['qr_url']}});const _0x564524='https://app.trapay.uk/payment/'+_0x4ae8da['id'];return console['log'](_0x30aaec(0x1ab)+_0x564524),{'paymentId':_0x4ae8da['id'],'paymentUrl':_0x564524,'expiresAt':_0x4ae8da['expiresAt']||undefined};}else{if(_0x320d10[_0x30aaec(0x117)]==='rapyd'){const _0x2a94ab=await this[_0x30aaec(0x135)][_0x30aaec(0xb0)]({'paymentId':_0x4ae8da['id'],'orderId':_0x477585,'orderName':_0x30aaec(0x86)+_0x2832db+'\x20'+_0x320d10['currency'],'amount':_0x2832db,'currency':_0x320d10[_0x30aaec(0xad)],'country':_0x320d10[_0x30aaec(0x195)],'language':_0x320d10[_0x30aaec(0x14d)]||'EN','amountIsEditable':![],'usage':'ONCE','maxPayments':0x1,'successUrl':_0x595f0c,'failUrl':_0x3632b5});_0x69ea61=_0x2a94ab[_0x30aaec(0x160)],_0x90c75d=_0x2a94ab[_0x30aaec(0xa0)],await database_1[_0x30aaec(0x12b)][_0x30aaec(0xe7)][_0x30aaec(0xff)]({'where':{'id':_0x4ae8da['id']},'data':{'externalPaymentUrl':_0x90c75d,'gatewayPaymentId':_0x69ea61}});const _0x5c312a=_0x90c75d;return console[_0x30aaec(0x101)](_0x30aaec(0x98)+_0x5c312a),{'paymentId':_0x4ae8da['id'],'paymentUrl':_0x5c312a,'expiresAt':_0x4ae8da[_0x30aaec(0xc3)]||undefined};}else{if(_0x320d10['gateway']===_0x30aaec(0x1ac)){const _0xba6924=await this[_0x30aaec(0xfa)]['createPaymentLink']({'paymentId':_0x4ae8da['id'],'orderId':_0x477585,'name':'Payment\x20'+_0x2832db+'\x20'+_0x320d10[_0x30aaec(0xad)],'paymentDescription':_0x30aaec(0x86)+_0x2832db+'\x20'+_0x320d10[_0x30aaec(0xad)],'amount':_0x2832db,'currency':_0x320d10[_0x30aaec(0xad)],'webhookUrl':_0x30aaec(0x19e),'returnUrl':_0x5417f6,'expiryDate':_0x320d10[_0x30aaec(0xc3)]?.['toISOString']()});_0x69ea61=_0xba6924[_0x30aaec(0x160)],_0x90c75d=_0xba6924[_0x30aaec(0xa0)],await database_1[_0x30aaec(0x12b)][_0x30aaec(0xe7)]['update']({'where':{'id':_0x4ae8da['id']},'data':{'externalPaymentUrl':_0x90c75d,'gatewayPaymentId':_0x69ea61,'qrUrl':_0xba6924[_0x30aaec(0x128)]}});const _0x548dda=_0x90c75d;return console[_0x30aaec(0x101)](_0x30aaec(0xdf)+_0x548dda),{'paymentId':_0x4ae8da['id'],'paymentUrl':_0x548dda,'expiresAt':_0x4ae8da['expiresAt']||undefined};}else{if(_0x320d10[_0x30aaec(0x117)]==='cointopay'){console[_0x30aaec(0x101)]('🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x477585+'\x20(8digits-8digits\x20format)'),console[_0x30aaec(0x101)]('💰\x20Amount:\x20'+_0x2832db+_0x30aaec(0x8c));const _0x4af804=await this[_0x30aaec(0xe9)][_0x30aaec(0xb0)]({'paymentId':_0x4ae8da['id'],'orderId':_0x477585,'amount':_0x2832db});_0x69ea61=_0x4af804['gateway_payment_id'],_0x90c75d=_0x4af804[_0x30aaec(0xa0)],await database_1['default'][_0x30aaec(0xe7)][_0x30aaec(0xff)]({'where':{'id':_0x4ae8da['id']},'data':{'externalPaymentUrl':_0x90c75d,'gatewayPaymentId':_0x69ea61}});_0x69ea61&&(console['log'](_0x30aaec(0x165)+_0x4ae8da['id']+'\x20('+_0x69ea61+')'),coinToPayStatusService_1['coinToPayStatusService'][_0x30aaec(0xdc)](_0x4ae8da['id'],_0x69ea61));const _0x513f8b=_0x90c75d;return console[_0x30aaec(0x101)](_0x30aaec(0x12e)+_0x513f8b),{'paymentId':_0x4ae8da['id'],'paymentUrl':_0x513f8b,'expiresAt':_0x4ae8da[_0x30aaec(0xc3)]||undefined};}else{if(_0x320d10[_0x30aaec(0x117)]===_0x30aaec(0x158)){console[_0x30aaec(0x101)]('🪙\x20Creating\x20CoinToPay2\x20(Open\x20Banking\x202)\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x477585+_0x30aaec(0x173)),console[_0x30aaec(0x101)](_0x30aaec(0xe2)+_0x2832db+_0x30aaec(0x169));const _0x16f1e1=await this['coinToPay2Service']['createPaymentLink']({'paymentId':_0x4ae8da['id'],'orderId':_0x477585,'amount':_0x2832db});_0x69ea61=_0x16f1e1[_0x30aaec(0x160)],_0x90c75d=_0x16f1e1['payment_url'],await database_1[_0x30aaec(0x12b)][_0x30aaec(0xe7)]['update']({'where':{'id':_0x4ae8da['id']},'data':{'externalPaymentUrl':_0x90c75d,'gatewayPaymentId':_0x69ea61}});_0x69ea61&&(console[_0x30aaec(0x101)]('🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay2\x20payment:\x20'+_0x4ae8da['id']+'\x20('+_0x69ea61+')'),coinToPayStatusService_1[_0x30aaec(0x14f)]['schedulePaymentChecks'](_0x4ae8da['id'],_0x69ea61));const _0x146efc=_0x90c75d;return console['log']('🔗\x20CoinToPay2\x20(Open\x20Banking\x202)\x20payment\x20URL:\x20'+_0x146efc),{'paymentId':_0x4ae8da['id'],'paymentUrl':_0x146efc,'expiresAt':_0x4ae8da[_0x30aaec(0xc3)]||undefined};}else{if(_0x320d10[_0x30aaec(0x117)][_0x30aaec(0xb9)](_0x30aaec(0x1ad))){const _0x37cb9a=(0x0,gateway_1[_0x30aaec(0x10f)])(_0x320d10[_0x30aaec(0x117)]);if(!_0x37cb9a)throw new Error('Invalid\x20KLYME\x20gateway:\x20'+_0x320d10['gateway']);console[_0x30aaec(0x101)](_0x30aaec(0xab)+_0x37cb9a+_0x30aaec(0x99)+_0x477585+_0x30aaec(0x173)),console[_0x30aaec(0x101)](_0x30aaec(0xe2)+_0x2832db+'\x20'+_0x320d10[_0x30aaec(0xad)]+_0x30aaec(0x180)+_0x37cb9a+')');const _0x333e92=await this[_0x30aaec(0x18b)][_0x30aaec(0xb0)]({'paymentId':_0x4ae8da['id'],'orderId':_0x477585,'amount':_0x2832db,'currency':_0x320d10['currency'],'region':_0x37cb9a,'redirectUrl':_0x5417f6});_0x69ea61=_0x333e92[_0x30aaec(0x160)],_0x90c75d=_0x333e92[_0x30aaec(0xa0)],await database_1['default'][_0x30aaec(0xe7)]['update']({'where':{'id':_0x4ae8da['id']},'data':{'externalPaymentUrl':_0x90c75d,'gatewayPaymentId':_0x69ea61}});const _0x409291=_0x90c75d;return console[_0x30aaec(0x101)]('✅\x20KLYME\x20'+_0x37cb9a+_0x30aaec(0xd6)+_0x477585),console[_0x30aaec(0x101)](_0x30aaec(0x120)+_0x37cb9a+_0x30aaec(0xda)+_0x409291),{'paymentId':_0x4ae8da['id'],'paymentUrl':_0x409291,'expiresAt':_0x4ae8da[_0x30aaec(0xc3)]||undefined};}else{if(_0x320d10['gateway']===_0x30aaec(0xce)){console[_0x30aaec(0x101)](_0x30aaec(0x11b)+_0x477585+_0x30aaec(0x173)),console[_0x30aaec(0x101)](_0x30aaec(0xe2)+_0x2832db+'\x20'+_0x320d10[_0x30aaec(0xad)]+_0x30aaec(0x166));const _0x16ab13=_0x30aaec(0x102)+_0x4ae8da['id'];await database_1[_0x30aaec(0x12b)][_0x30aaec(0xe7)][_0x30aaec(0xff)]({'where':{'id':_0x4ae8da['id']},'data':{'externalPaymentUrl':_0x16ab13,'gatewayPaymentId':_0x30aaec(0xbd)+_0x477585}});const _0x524e52=_0x30aaec(0xe0)+_0x4ae8da['id'];return console[_0x30aaec(0x101)](_0x30aaec(0x7c)+_0x524e52),console[_0x30aaec(0x101)](_0x30aaec(0x191)+_0x16ab13),{'paymentId':_0x4ae8da['id'],'paymentUrl':_0x524e52,'expiresAt':_0x4ae8da[_0x30aaec(0xc3)]||undefined};}else{if(_0x320d10['gateway']===_0x30aaec(0x17d)){console[_0x30aaec(0x101)]('💳\x20Creating\x20MasterCard\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x477585+_0x30aaec(0x173)),console['log'](_0x30aaec(0xe2)+_0x2832db+'\x20'+_0x320d10[_0x30aaec(0xad)]+'\x20(MasterCard)');const _0x145903=new URLSearchParams();_0x5bf98a&&_0x145903['append']('email',_0x5bf98a);_0x58807f&&_0x145903[_0x30aaec(0x199)](_0x30aaec(0xea),_0x58807f);const _0x23f157=_0x30aaec(0xe0)+_0x4ae8da['id']+(_0x145903[_0x30aaec(0x8a)]()?'?'+_0x145903[_0x30aaec(0x8a)]():'');await database_1[_0x30aaec(0x12b)][_0x30aaec(0xe7)][_0x30aaec(0xff)]({'where':{'id':_0x4ae8da['id']},'data':{'externalPaymentUrl':_0x23f157,'gatewayPaymentId':'mc_'+_0x477585,'paymentMethod':_0x30aaec(0x17d)}});const _0x1da782='https://app.trapay.uk/payment/'+_0x4ae8da['id']+(_0x145903[_0x30aaec(0x8a)]()?'?'+_0x145903[_0x30aaec(0x8a)]():'');return console[_0x30aaec(0x101)](_0x30aaec(0x7e)+_0x1da782),console[_0x30aaec(0x101)](_0x30aaec(0x182)+_0x23f157),console[_0x30aaec(0x101)](_0x30aaec(0x12c),_0x145903[_0x30aaec(0x8a)]()),{'paymentId':_0x4ae8da['id'],'paymentUrl':_0x1da782,'expiresAt':_0x4ae8da[_0x30aaec(0xc3)]||undefined};}else{if(_0x320d10[_0x30aaec(0x117)]==='amer'){console[_0x30aaec(0x101)](_0x30aaec(0x136)+_0x477585),console[_0x30aaec(0x101)](_0x30aaec(0xe2)+_0x2832db+'\x20'+_0x320d10[_0x30aaec(0xad)]+'\x20(Amer)');const _0x258d65=new URLSearchParams();_0x258d65[_0x30aaec(0x199)](_0x30aaec(0x147),_0x4ae8da['id']),_0x258d65[_0x30aaec(0x199)](_0x30aaec(0x95),_0x2832db['toString']()),_0x258d65['append'](_0x30aaec(0xad),_0x320d10[_0x30aaec(0xad)]);_0x5bf98a&&_0x258d65[_0x30aaec(0x199)](_0x30aaec(0x156),_0x5bf98a);_0x58807f&&_0x258d65[_0x30aaec(0x199)](_0x30aaec(0xea),_0x58807f);const _0x181996=_0x30aaec(0x194)+_0x258d65[_0x30aaec(0x8a)]();return await database_1['default'][_0x30aaec(0xe7)][_0x30aaec(0xff)]({'where':{'id':_0x4ae8da['id']},'data':{'externalPaymentUrl':_0x181996,'gatewayPaymentId':_0x30aaec(0x100)+_0x477585,'paymentMethod':_0x30aaec(0x140)}}),console[_0x30aaec(0x101)](_0x30aaec(0x186)+_0x181996),{'paymentId':_0x4ae8da['id'],'paymentUrl':_0x181996,'expiresAt':_0x4ae8da[_0x30aaec(0xc3)]||undefined};}else throw new Error(_0x30aaec(0x16a)+_0x320d10[_0x30aaec(0x117)]);}}}}}}}}}catch(_0x222974){await database_1[_0x30aaec(0x12b)][_0x30aaec(0xe7)][_0x30aaec(0xff)]({'where':{'id':_0x4ae8da['id']},'data':{'status':_0x30aaec(0x122)}});throw new Error(_0x30aaec(0x1a0)+(_0x222974 instanceof Error?_0x222974[_0x30aaec(0x13a)]:_0x30aaec(0x15c)));}}async[a52_0x3c31ec(0xac)](_0x10c8d6){const _0x4eada3=a52_0x3c31ec;console[_0x4eada3(0x101)]('📈\x20handleSuccessfulPayment\x20called\x20for\x20payment:\x20'+_0x10c8d6);const _0x31ea1b=await database_1[_0x4eada3(0x12b)][_0x4eada3(0xe7)][_0x4eada3(0x15b)]({'where':{'id':_0x10c8d6},'include':{'paymentLink':!![]}});console[_0x4eada3(0x101)](_0x4eada3(0x11c),_0x31ea1b?{'id':_0x31ea1b['id'],'status':_0x31ea1b[_0x4eada3(0x108)],'paidAt':_0x31ea1b[_0x4eada3(0xc2)],'paymentLinkId':_0x31ea1b[_0x4eada3(0x8f)],'paymentLink':_0x31ea1b[_0x4eada3(0xf0)]?{'id':_0x31ea1b[_0x4eada3(0xf0)]['id'],'type':_0x31ea1b[_0x4eada3(0xf0)][_0x4eada3(0xeb)],'currentPayments':_0x31ea1b[_0x4eada3(0xf0)][_0x4eada3(0x9b)],'status':_0x31ea1b['paymentLink'][_0x4eada3(0x108)]}:null}:_0x4eada3(0xb3));if(!_0x31ea1b||!_0x31ea1b[_0x4eada3(0xf0)]){console[_0x4eada3(0x101)](_0x4eada3(0x168)+_0x10c8d6+_0x4eada3(0x93));return;}if(_0x31ea1b[_0x4eada3(0x108)]!==_0x4eada3(0x15d)){console['log'](_0x4eada3(0x168)+_0x10c8d6+'\x20status\x20is\x20'+_0x31ea1b['status']+_0x4eada3(0x167));return;}if(!_0x31ea1b[_0x4eada3(0xc2)]){console[_0x4eada3(0x101)](_0x4eada3(0x168)+_0x10c8d6+_0x4eada3(0x17b));return;}console[_0x4eada3(0x101)](_0x4eada3(0xed)+_0x10c8d6+_0x4eada3(0x178));try{const _0x388269=await database_1[_0x4eada3(0x12b)][_0x4eada3(0x1a2)](async _0x44d313=>{const _0x2268ec=_0x4eada3,_0x563bfc=await _0x44d313[_0x2268ec(0xf0)][_0x2268ec(0x15b)]({'where':{'id':_0x31ea1b['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(!_0x563bfc)throw new Error(_0x2268ec(0x110)+_0x31ea1b[_0x2268ec(0x8f)]+_0x2268ec(0xef));console[_0x2268ec(0x101)](_0x2268ec(0x8d),_0x563bfc);if(_0x563bfc[_0x2268ec(0xeb)]===_0x2268ec(0xa4)&&_0x563bfc[_0x2268ec(0x9b)]>=0x1)return console[_0x2268ec(0x101)](_0x2268ec(0x109)+_0x31ea1b[_0x2268ec(0x8f)]+_0x2268ec(0xb1)+_0x563bfc['currentPayments']+_0x2268ec(0xcb)),_0x563bfc;const _0xad258c=await _0x44d313[_0x2268ec(0xe7)][_0x2268ec(0x12f)]({'where':{'paymentLinkId':_0x31ea1b['paymentLinkId'],'status':'PAID','paidAt':{'not':null},'id':{'not':_0x10c8d6}}});console[_0x2268ec(0x101)](_0x2268ec(0x113)+_0x31ea1b['paymentLinkId']+':\x20'+_0xad258c);const _0x585e4d=_0xad258c+0x1,_0x9d7608=_0x563bfc['type']===_0x2268ec(0xa4)&&_0x585e4d>=0x1?_0x2268ec(0x188):_0x563bfc['status'];console[_0x2268ec(0x101)](_0x2268ec(0x123)+_0x31ea1b[_0x2268ec(0x8f)]+':'),console[_0x2268ec(0x101)]('\x20\x20\x20-\x20Type:\x20'+_0x563bfc['type']),console[_0x2268ec(0x101)](_0x2268ec(0xf6)+_0x563bfc[_0x2268ec(0x9b)]+_0x2268ec(0x90)+_0x585e4d),console['log'](_0x2268ec(0x10b)+_0x563bfc[_0x2268ec(0x108)]+'\x20->\x20'+_0x9d7608);const _0xbf42c8=await _0x44d313['paymentLink']['update']({'where':{'id':_0x31ea1b[_0x2268ec(0x8f)]},'data':{'currentPayments':_0x585e4d,'status':_0x9d7608}});return console[_0x2268ec(0x101)](_0x2268ec(0x15f)+_0x31ea1b[_0x2268ec(0x8f)]+'\x20('+_0x563bfc[_0x2268ec(0xeb)]+_0x2268ec(0x176)+_0x563bfc[_0x2268ec(0x9b)]+'\x20->\x20'+_0x585e4d),_0xbf42c8;});if(_0x388269[_0x4eada3(0x108)]===_0x4eada3(0x188)){const _0x5215ee=_0x388269[_0x4eada3(0xeb)]==='SINGLE'?'single-use':_0x4eada3(0x106);console[_0x4eada3(0x101)](_0x4eada3(0xf2)+_0x31ea1b[_0x4eada3(0x8f)]+_0x4eada3(0x88)+_0x5215ee+_0x4eada3(0xe6)+_0x388269[_0x4eada3(0x9b)]+_0x4eada3(0x170));}}catch(_0x453cce){console['error'](_0x4eada3(0x17c)+_0x10c8d6+':',_0x453cce);throw _0x453cce;}}async[a52_0x3c31ec(0xcd)](_0x58d5db){const _0x28c6f0=a52_0x3c31ec,[_0x46bef1,_0x440ab4,_0x10769d,_0x52d31c]=await Promise[_0x28c6f0(0x149)]([database_1[_0x28c6f0(0x12b)]['paymentLink'][_0x28c6f0(0x12f)]({'where':{'shopId':_0x58d5db}}),database_1[_0x28c6f0(0x12b)][_0x28c6f0(0xf0)][_0x28c6f0(0x12f)]({'where':{'shopId':_0x58d5db,'status':_0x28c6f0(0xfb)}}),database_1[_0x28c6f0(0x12b)][_0x28c6f0(0xe7)]['count']({'where':{'shopId':_0x58d5db,'paymentLinkId':{'not':null},'gateway':{'not':_0x28c6f0(0xce)}}}),database_1[_0x28c6f0(0x12b)][_0x28c6f0(0xe7)][_0x28c6f0(0x164)]({'where':{'shopId':_0x58d5db,'paymentLinkId':{'not':null},'status':'PAID','gateway':{'not':_0x28c6f0(0xce)}},'select':{'amount':!![],'currency':!![]}})]);let _0x9ff8c9=0x0;for(const _0x518b04 of _0x52d31c){const _0x18e505=await currencyService_1[_0x28c6f0(0xc9)]['convertToUSDT'](_0x518b04[_0x28c6f0(0x95)],_0x518b04[_0x28c6f0(0xad)]);_0x9ff8c9+=_0x18e505;}const _0x12e86f=_0x10769d>0x0?_0x52d31c[_0x28c6f0(0x92)]/_0x10769d*0x64:0x0;return{'totalLinks':_0x46bef1,'activeLinks':_0x440ab4,'totalPayments':_0x10769d,'totalRevenue':Math[_0x28c6f0(0x134)](_0x9ff8c9*0x64)/0x64,'conversionRate':Math['round'](_0x12e86f*0x64)/0x64};}[a52_0x3c31ec(0x1a4)](_0x4130b2){const _0x1c0e3e=a52_0x3c31ec;return{'id':_0x4130b2['id'],'shopId':_0x4130b2['shopId'],'amount':_0x4130b2[_0x1c0e3e(0x95)],'currency':_0x4130b2['currency'],'sourceCurrency':_0x4130b2[_0x1c0e3e(0x11e)]||undefined,'gateway':_0x4130b2[_0x1c0e3e(0x117)],'type':_0x4130b2[_0x1c0e3e(0xeb)],'currentPayments':_0x4130b2[_0x1c0e3e(0x9b)],'status':_0x4130b2['status'],'expiresAt':_0x4130b2[_0x1c0e3e(0xc3)]||undefined,'successUrl':_0x4130b2[_0x1c0e3e(0xb4)]||undefined,'failUrl':_0x4130b2['failUrl']||undefined,'pendingUrl':_0x4130b2[_0x1c0e3e(0xc5)]||undefined,'country':_0x4130b2[_0x1c0e3e(0x195)]||undefined,'language':_0x4130b2[_0x1c0e3e(0x14d)]||undefined,'linkUrl':_0x1c0e3e(0x151)+_0x4130b2['id'],'createdAt':_0x4130b2[_0x1c0e3e(0xdd)],'updatedAt':_0x4130b2[_0x1c0e3e(0x97)],'shop':_0x4130b2[_0x1c0e3e(0x155)],'payments':_0x4130b2[_0x1c0e3e(0x12a)]};}}exports[a52_0x3c31ec(0xa2)]=PaymentLinkService;