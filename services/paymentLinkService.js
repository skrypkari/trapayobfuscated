'use strict';const a50_0x5c81dd=a50_0x3497;(function(_0x200544,_0x3f7f81){const _0x1f3a78=a50_0x3497,_0x399cce=_0x200544();while(!![]){try{const _0x1942f2=parseInt(_0x1f3a78(0x250))/0x1*(parseInt(_0x1f3a78(0x24f))/0x2)+parseInt(_0x1f3a78(0x23e))/0x3+parseInt(_0x1f3a78(0x20f))/0x4*(-parseInt(_0x1f3a78(0x175))/0x5)+parseInt(_0x1f3a78(0x15f))/0x6*(-parseInt(_0x1f3a78(0x172))/0x7)+parseInt(_0x1f3a78(0x211))/0x8+-parseInt(_0x1f3a78(0x235))/0x9+-parseInt(_0x1f3a78(0x25c))/0xa;if(_0x1942f2===_0x3f7f81)break;else _0x399cce['push'](_0x399cce['shift']());}catch(_0x30f248){_0x399cce['push'](_0x399cce['shift']());}}}(a50_0x1979,0xe8da1));var __importDefault=this&&this['__importDefault']||function(_0xd1afb){const _0x166b3e=a50_0x3497;return _0xd1afb&&_0xd1afb[_0x166b3e(0x179)]?_0xd1afb:{'default':_0xd1afb};};function a50_0x1979(){const _0x12ac8b=['KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','type','mastercard','findFirst','floor','📈\x20Single\x20payment\x20link\x20','Invalid\x20gateway\x20ID:\x20','\x20\x20\x20🌐\x20Gateway\x20Pending\x20URL:\x20','\x20USDT)\x20is\x20below\x20the\x20minimum\x20required\x20amount\x20of\x20','🔗\x20Rapyd\x20payment\x20URL:\x20','&payment_id=','NodaService','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x20gateway\x20settings:','generateGatewayUrls','\x20(8digits-8digits\x20format\x20for\x20','\x20link\x20','single-use','💰\x20Gateway\x20','count','ceil','coinToPayStatusService','shop','💳\x20Creating\x20KLYME\x20','none','country','createPayment','../config/database','nodaService','log','maxAmount','getGatewayNameById','\x22\x20is\x20allowed\x20for\x20shop\x20','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','Test\x20Gateway','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Rapyd','./gateways/plisioService','📈\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','Plisio','MasterCard','status','schedulePaymentChecks','klymeService','expiresAt','getGatewayDisplayName','payments','currentPayments','\x20USDT)\x20exceeds\x20the\x20maximum\x20allowed\x20amount\x20of\x20','🧪\x20Test\x20Gateway\x20form\x20URL:\x20','❌\x20Gateway\x20\x22','💰\x20Fixed\x20amount:\x20','🔗\x20No\x20whiteUrl\x20for\x20','checkGatewayPermission','isValidGatewayId','🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','\x20gateway.\x20','checkAmountLimits','failUrl','\x20maximum\x20amount:\x20','RapydService','validateKlymeCurrency','Shop\x20is\x20not\x20active','💳\x20Creating\x20MasterCard\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','💾\x20DB\x20Success\x20URL:\x20','generateGatewayOrderId','test_','Payment\x20link\x20is\x20not\x20active','💱\x20Converted\x20','\x20(8digits-8digits\x20format)','CoinToPay','https://app.trapay.uk/link/','cointopay','qr_code','💰\x20Shop\x20','findMany','toLowerCase','minAmount','Please\x20reduce\x20the\x20amount.','✅\x20Gateway\x20\x22','🔗\x20MasterCard\x20payment\x20URL:\x20','GBP','defineProperty','https://tesoft.uk/gateway/payment.php?id=','$transaction','PaymentLinkService','💳\x20MasterCard\x20form\x20URL:\x20','/gateway/fail.php?id=','paidAt','FAILED','getKlymeRegionFromGatewayName','random','getPublicPaymentLinkData','../types/gateway','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','🔗\x20KLYME\x20','\x20USDT','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','/gateway/pending.php?id=','\x20completed\x20(','\x20(Plisio\x20or\x20KLYME)','test_gateway','coinToPayService','handleSuccessfulPayment','username','plisio','🔗\x20Creating\x20','Gateway\x20\x22','PlisioService','klyme_','USD','join','ONCE','temp','gateway_payment_id','pendingUrl','🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/','\x20USDT\x20is\x20below\x20minimum\x20','\x20USDT\x20for\x20','Error\x20parsing\x20payment\x20gateways:','Invalid\x20KLYME\x20gateway:\x20','Enabled\x20gateways:\x20','65864XuKDjV','rapydService','10732536TBHEqz','default','findUnique','💰\x20Amount:\x20','plisioService','🔐\x20Checking\x20if\x20\x22','toFixed','invoice_total_sum','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','\x22\x20not\x20allowed\x20for\x20shop\x20','💰\x20No\x20minimum\x20amount\x20set\x20for\x20gateway\x20','amount','✅\x20Amount\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','\x20USDT\x20for\x20limit\x20checking','\x20USDT\x20for\x20gateway\x20','\x20payment\x20link','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','https://app.trapay.uk/payment/success?id=','🔐\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','Payment\x20amount\x20','🔗\x20Generated\x20whiteUrl\x20for\x20','sourceCurrency','gatewaySettings','toString','KLYME\x20DE','\x20payment\x20URL:\x20','🔗\x20Link\x20type:\x20','language','parse','https://tesoft.uk','EUR','paymentLinkId','round','Anonymous','formatPaymentLinkResponse','528453epCDbf','\x20USDT\x20exceeds\x20maximum\x20','create','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','BASE_URL','\x20enabled\x20gateways\x20(internal):','👤\x20Customer:\x20','padStart','./currencyService','1375524lyptPA','currency','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','https://app.trapay.uk/payment/','https://app.trapay.uk/payment/fail?id=','🔗\x20CoinToPay\x20payment\x20URL:\x20','payment_url','❌\x20Enabled\x20gateways:\x20','getPaymentLinkStatistics','🎯\x20Generated\x20gateway\x20order_id:\x20','./gateways/rapydService','desc','map','\x20using\x20default\x20gateways:','length','💰\x20Plisio\x20payment\x20link\x20mapping:','paymentLink','1412854effvNu','1OplRie','\x20already\x20used\x20(','💾\x20DB\x20Fail\x20URL:\x20','successUrl','KlymeService','COMPLETED','\x20(MasterCard)',',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','\x20minimum\x20amount:\x20','🔗\x20Noda\x20payment\x20URL:\x20','🏁\x20Payment\x20link\x20','payment','1798160JwrGiO','🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','delete',',\x20gateway\x20','🧪\x20Creating\x20Test\x20Gateway\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','shopId','name','💰\x20No\x20maximum\x20amount\x20set\x20for\x20gateway\x20','\x20with\x20payment\x20ID\x20','message','12OdBDcZ','insensitive','convertToUSDT','PAID','noda','📧\x20URL\x20параметры:','update','\x20to\x20','KLYME\x20GB','\x20(Test\x20Gateway)','📈\x20Payment\x20','env','🔗\x20Generated\x20URLs\x20for\x20','CoinToPayService','Payment\x20link\x20','append','currencyService','This\x20single-use\x20payment\x20link\x20has\x20already\x20been\x20used','\x22\x20is\x20in\x20enabled\x20gateways:','1199499wOwCQc','MAX_SAFE_INTEGER','\x20link\x20with\x20','295rHtqXg','Payment\x20','amount\x20is\x20required\x20and\x20must\x20be\x20positive','SINGLE','__esModule','./gateways/klymeService','rapyd','\x20->\x20','qr_code_url','\x20enabled\x20gateways\x20(display):','https://app.trapay.uk/payment/pending?id=','\x20\x20\x20🔗\x20White\x20URL:\x20','/gateway/success.php?id=','🔐\x20Shop\x20','gateway','Open\x20Banking\x202','PENDING','startsWith','multi-use','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','paymentGateways','no\x20email','Payment\x20link\x20not\x20found','✅\x20KLYME\x20',',\x20amount:\x20','🔗\x20Plisio\x20payment\x20URL:\x20','error','Payment\x20link\x20has\x20reached\x20maximum\x20payments','createPaymentLink','ACTIVE','📝\x20Note:\x20Success/Fail/Pending\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created','💳\x20Initiating\x20payment\x20from\x20'];a50_0x1979=function(){return _0x12ac8b;};return a50_0x1979();}Object[a50_0x5c81dd(0x1e7)](exports,a50_0x5c81dd(0x179),{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require(a50_0x5c81dd(0x1b0))),plisioService_1=require(a50_0x5c81dd(0x1ba)),rapydService_1=require(a50_0x5c81dd(0x248)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require(a50_0x5c81dd(0x17a)),coinToPayStatusService_1=require('./coinToPayStatusService'),gateway_1=require(a50_0x5c81dd(0x1f2)),currencyService_1=require(a50_0x5c81dd(0x23d));class PaymentLinkService{constructor(){const _0x5e5007=a50_0x5c81dd;this[_0x5e5007(0x215)]=new plisioService_1[(_0x5e5007(0x201))](),this['rapydService']=new rapydService_1[(_0x5e5007(0x1d1))](),this['nodaService']=new nodaService_1[(_0x5e5007(0x1a0))](),this[_0x5e5007(0x1fb)]=new coinToPayService_1[(_0x5e5007(0x16c))](),this[_0x5e5007(0x1c0)]=new klymeService_1[(_0x5e5007(0x254))]();}[a50_0x5c81dd(0x1d6)](){const _0x47b0ee=()=>{const _0x17c7ac=a50_0x3497;return Math[_0x17c7ac(0x199)](Math[_0x17c7ac(0x1f0)]()*0x5f5e100)[_0x17c7ac(0x229)]()[_0x17c7ac(0x23c)](0x8,'0');};return _0x47b0ee()+'-'+_0x47b0ee();}[a50_0x5c81dd(0x1a3)](_0x59f688,_0x83b60b,_0x5b31f6,_0x372969,_0x197d3a,_0x3d0632,_0x4f4d57){const _0x23fae3=a50_0x5c81dd;if(_0x197d3a&&_0x3d0632&&_0x4f4d57)return{'finalSuccessUrl':_0x197d3a,'finalFailUrl':_0x3d0632,'finalPendingUrl':_0x4f4d57,'dbSuccessUrl':_0x197d3a,'dbFailUrl':_0x3d0632,'dbPendingUrl':_0x4f4d57,'whiteUrl':null};const _0x414eb4=_0x197d3a||_0x23fae3(0x223)+_0x83b60b+_0x23fae3(0x19f)+_0x5b31f6,_0x51ee52=_0x3d0632||_0x23fae3(0x242)+_0x83b60b+'&payment_id='+_0x5b31f6,_0x3ab7ab=_0x4f4d57||_0x23fae3(0x17f)+_0x83b60b+_0x23fae3(0x19f)+_0x5b31f6;let _0x429996,_0x4be295,_0x1f4823;_0x59f688==='noda'||_0x59f688[_0x23fae3(0x186)](_0x23fae3(0x202))||_0x59f688===_0x23fae3(0x1dd)?(_0x429996=_0x372969+_0x23fae3(0x1f7)+_0x83b60b,_0x1f4823=_0x372969+'/gateway/pending.php?id='+_0x83b60b):(_0x429996=_0x372969+_0x23fae3(0x181)+_0x83b60b,_0x1f4823=_0x372969+_0x23fae3(0x1f7)+_0x83b60b);_0x4be295=_0x372969+_0x23fae3(0x1ec)+_0x83b60b;let _0x35c656=null;return _0x59f688!==_0x23fae3(0x1fe)&&!_0x59f688[_0x23fae3(0x186)](_0x23fae3(0x202))?(_0x35c656=_0x23fae3(0x1e8)+_0x83b60b,console[_0x23fae3(0x1b2)](_0x23fae3(0x226)+_0x59f688+':\x20'+_0x35c656)):console[_0x23fae3(0x1b2)](_0x23fae3(0x1c9)+_0x59f688+_0x23fae3(0x1f9)),console[_0x23fae3(0x1b2)](_0x23fae3(0x16b)+_0x59f688+_0x23fae3(0x15d)+_0x83b60b+':'),console[_0x23fae3(0x1b2)](_0x23fae3(0x1f3)+_0x429996),console[_0x23fae3(0x1b2)]('\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20'+_0x4be295),console[_0x23fae3(0x1b2)](_0x23fae3(0x19c)+_0x1f4823),console[_0x23fae3(0x1b2)](_0x23fae3(0x219)+_0x414eb4),console[_0x23fae3(0x1b2)]('\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20'+_0x51ee52),console[_0x23fae3(0x1b2)]('\x20\x20\x20💾\x20DB\x20Pending\x20URL:\x20'+_0x3ab7ab),console[_0x23fae3(0x1b2)](_0x23fae3(0x180)+(_0x35c656||_0x23fae3(0x1ad))),{'finalSuccessUrl':_0x429996,'finalFailUrl':_0x4be295,'finalPendingUrl':_0x1f4823,'dbSuccessUrl':_0x414eb4,'dbFailUrl':_0x51ee52,'dbPendingUrl':_0x3ab7ab,'whiteUrl':_0x35c656};}[a50_0x5c81dd(0x1d2)](_0xe09b82,_0x2ea9be){const _0x61a1a6=a50_0x5c81dd;if(!_0xe09b82[_0x61a1a6(0x186)]('klyme_'))return;const _0x19d1e5=(0x0,gateway_1[_0x61a1a6(0x1ef)])(_0xe09b82),_0xadc014=_0x2ea9be['toUpperCase']();switch(_0x19d1e5){case'EU':if(_0xadc014!=='EUR')throw new Error(_0x61a1a6(0x1a1)+_0xadc014);break;case'GB':if(_0xadc014!==_0x61a1a6(0x1e6))throw new Error(_0x61a1a6(0x195)+_0xadc014);break;case'DE':if(_0xadc014!==_0x61a1a6(0x230))throw new Error(_0x61a1a6(0x1b8)+_0xadc014);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x19d1e5);}}async[a50_0x5c81dd(0x1ce)](_0x4534d6,_0x3adff0,_0x2b3a71,_0x42de6d){const _0x5df51f=a50_0x5c81dd;console[_0x5df51f(0x1b2)]('💰\x20Checking\x20amount\x20limits\x20for\x20shop\x20'+_0x4534d6+_0x5df51f(0x25f)+_0x3adff0+_0x5df51f(0x18d)+_0x2b3a71+'\x20'+_0x42de6d);const _0x1628b6=await currencyService_1[_0x5df51f(0x16f)]['convertToUSDT'](_0x2b3a71,_0x42de6d);console[_0x5df51f(0x1b2)](_0x5df51f(0x1d9)+_0x2b3a71+'\x20'+_0x42de6d+_0x5df51f(0x166)+_0x1628b6[_0x5df51f(0x217)](0x6)+_0x5df51f(0x21f));const _0x588b5a=await database_1[_0x5df51f(0x212)][_0x5df51f(0x1ab)][_0x5df51f(0x213)]({'where':{'id':_0x4534d6},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x588b5a)throw new Error('Shop\x20not\x20found');let _0x11d585={};if(_0x588b5a[_0x5df51f(0x228)])try{_0x11d585=JSON[_0x5df51f(0x22e)](_0x588b5a[_0x5df51f(0x228)]),console['log'](_0x5df51f(0x1df)+_0x588b5a['username']+_0x5df51f(0x1a2),_0x11d585);}catch(_0x5af020){console[_0x5df51f(0x18f)]('Error\x20parsing\x20gateway\x20settings:',_0x5af020),_0x11d585={};}const _0x2a6003=this[_0x5df51f(0x1c2)](_0x3adff0);console[_0x5df51f(0x1b2)]('💰\x20Checking\x20amount\x20limits\x20for\x20gateway:\x20'+_0x3adff0+_0x5df51f(0x17c)+_0x2a6003);const _0x191ee3=_0x11d585[_0x2a6003];if(_0x191ee3&&_0x191ee3[_0x5df51f(0x1e2)]!==undefined){const _0x4e1d2f=_0x191ee3[_0x5df51f(0x1e2)];console[_0x5df51f(0x1b2)](_0x5df51f(0x1a7)+_0x2a6003+_0x5df51f(0x258)+_0x4e1d2f+_0x5df51f(0x1f5));if(_0x1628b6<_0x4e1d2f){console[_0x5df51f(0x18f)]('❌\x20Amount\x20'+_0x1628b6['toFixed'](0x6)+_0x5df51f(0x20a)+_0x4e1d2f+'\x20USDT\x20for\x20gateway\x20'+_0x2a6003);throw new Error(_0x5df51f(0x225)+_0x2b3a71+'\x20'+_0x42de6d+'\x20('+_0x1628b6['toFixed'](0x2)+_0x5df51f(0x19d)+_0x4e1d2f+_0x5df51f(0x20b)+_0x2a6003+_0x5df51f(0x1cd)+'Please\x20increase\x20the\x20amount.');}console['log'](_0x5df51f(0x21d)+_0x1628b6[_0x5df51f(0x217)](0x6)+'\x20USDT\x20meets\x20minimum\x20requirement\x20of\x20'+_0x4e1d2f+_0x5df51f(0x220)+_0x2a6003);}else console[_0x5df51f(0x1b2)](_0x5df51f(0x21b)+_0x2a6003);if(_0x191ee3&&_0x191ee3[_0x5df51f(0x1b3)]!==undefined){const _0x42f6ef=_0x191ee3[_0x5df51f(0x1b3)];console[_0x5df51f(0x1b2)]('💰\x20Gateway\x20'+_0x2a6003+_0x5df51f(0x1d0)+_0x42f6ef+'\x20USDT');if(_0x1628b6>_0x42f6ef){console['error']('❌\x20Amount\x20'+_0x1628b6[_0x5df51f(0x217)](0x6)+_0x5df51f(0x236)+_0x42f6ef+_0x5df51f(0x220)+_0x2a6003);throw new Error(_0x5df51f(0x225)+_0x2b3a71+'\x20'+_0x42de6d+'\x20('+_0x1628b6[_0x5df51f(0x217)](0x2)+_0x5df51f(0x1c5)+_0x42f6ef+_0x5df51f(0x20b)+_0x2a6003+'\x20gateway.\x20'+_0x5df51f(0x1e3));}console[_0x5df51f(0x1b2)](_0x5df51f(0x21d)+_0x1628b6[_0x5df51f(0x217)](0x6)+'\x20USDT\x20meets\x20maximum\x20requirement\x20of\x20'+_0x42f6ef+_0x5df51f(0x220)+_0x2a6003);}else console[_0x5df51f(0x1b2)](_0x5df51f(0x263)+_0x2a6003);}async[a50_0x5c81dd(0x1ca)](_0x299bd5,_0x393414){const _0x535332=a50_0x5c81dd;console[_0x535332(0x1b2)](_0x535332(0x224)+_0x299bd5+':\x20'+_0x393414);const _0x50cc6e=await database_1['default'][_0x535332(0x1ab)][_0x535332(0x213)]({'where':{'id':_0x299bd5},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x50cc6e)throw new Error('Shop\x20not\x20found');let _0xe4e7d1=[];if(_0x50cc6e[_0x535332(0x189)])try{const _0x5f2c6b=JSON[_0x535332(0x22e)](_0x50cc6e[_0x535332(0x189)]);_0xe4e7d1=_0x5f2c6b[_0x535332(0x24a)](_0x2fb2ac=>this['getGatewayDisplayName'](_0x2fb2ac)),console['log'](_0x535332(0x182)+_0x50cc6e['username']+_0x535332(0x23a),_0x5f2c6b),console[_0x535332(0x1b2)](_0x535332(0x182)+_0x50cc6e[_0x535332(0x1fd)]+_0x535332(0x17e),_0xe4e7d1);}catch(_0xbb39eb){console[_0x535332(0x18f)](_0x535332(0x20c),_0xbb39eb),_0xe4e7d1=[_0x535332(0x1bc)];}else _0xe4e7d1=[_0x535332(0x1bc)],console[_0x535332(0x1b2)](_0x535332(0x182)+_0x50cc6e[_0x535332(0x1fd)]+_0x535332(0x24b),_0xe4e7d1);const _0x1b55f3=this[_0x535332(0x1c2)](_0x393414);console['log'](_0x535332(0x216)+_0x1b55f3+_0x535332(0x171),_0xe4e7d1);if(!_0xe4e7d1['includes'](_0x1b55f3)){console[_0x535332(0x18f)](_0x535332(0x1c7)+_0x1b55f3+_0x535332(0x21a)+_0x50cc6e[_0x535332(0x1fd)]),console[_0x535332(0x18f)](_0x535332(0x245)+_0xe4e7d1[_0x535332(0x204)](',\x20'));throw new Error(_0x535332(0x200)+_0x1b55f3+'\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20'+(_0x535332(0x20e)+_0xe4e7d1['join'](',\x20')+'.\x20')+'Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.');}console[_0x535332(0x1b2)](_0x535332(0x1e4)+_0x1b55f3+_0x535332(0x1b5)+_0x50cc6e[_0x535332(0x1fd)]);}[a50_0x5c81dd(0x1c2)](_0xe55969){const _0x40f19b=a50_0x5c81dd,_0x4c4571={'test_gateway':_0x40f19b(0x1b7),'plisio':_0x40f19b(0x1bc),'rapyd':_0x40f19b(0x1b9),'noda':'Noda','cointopay':_0x40f19b(0x1db),'cointopay2':_0x40f19b(0x184),'klyme_eu':'KLYME\x20EU','klyme_gb':_0x40f19b(0x167),'klyme_de':_0x40f19b(0x22a),'mastercard':_0x40f19b(0x1bd)};return _0x4c4571[_0xe55969]||_0xe55969;}async['createPaymentLink'](_0x45c755,_0x3ea6e2){const _0x326b1a=a50_0x5c81dd;if(!(0x0,gateway_1[_0x326b1a(0x1cb)])(_0x3ea6e2['gateway']))throw new Error(_0x326b1a(0x19b)+_0x3ea6e2['gateway']+_0x326b1a(0x1f6));const _0xda38fd=(0x0,gateway_1[_0x326b1a(0x1b4)])(_0x3ea6e2['gateway']);if(!_0xda38fd)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x3ea6e2['gateway']);console[_0x326b1a(0x1b2)]('🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20'+_0xda38fd),await this[_0x326b1a(0x1ca)](_0x45c755,_0xda38fd);if(_0xda38fd===_0x326b1a(0x1fe)&&!_0x3ea6e2[_0x326b1a(0x227)])throw new Error(_0x326b1a(0x240));if(_0xda38fd[_0x326b1a(0x186)](_0x326b1a(0x202))){const _0x3fbd46=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0xda38fd);console['log'](_0x326b1a(0x1ac)+_0x3fbd46+_0x326b1a(0x221));}let _0x58401a=_0x3ea6e2[_0x326b1a(0x1ae)];_0xda38fd===_0x326b1a(0x17b)&&(_0x58401a='GB',console[_0x326b1a(0x1b2)](_0x326b1a(0x1b6)));if(!_0x3ea6e2[_0x326b1a(0x21c)]||_0x3ea6e2['amount']<=0x0)throw new Error(_0x326b1a(0x177));let _0x4cd3f3=_0x3ea6e2[_0x326b1a(0x23f)]||_0x326b1a(0x203);_0xda38fd===_0x326b1a(0x1dd)&&(_0x4cd3f3=_0x326b1a(0x230),console[_0x326b1a(0x1b2)](_0x326b1a(0x1cc)));this[_0x326b1a(0x1d2)](_0xda38fd,_0x4cd3f3),await this[_0x326b1a(0x1ce)](_0x45c755,_0xda38fd,_0x3ea6e2['amount'],_0x4cd3f3);const _0x2c7b05=_0x3ea6e2['type']||_0x326b1a(0x178);console['log'](_0x326b1a(0x1ff)+_0x2c7b05+_0x326b1a(0x221));const _0x1c8c33=await database_1[_0x326b1a(0x212)]['paymentLink']['create']({'data':{'shopId':_0x45c755,'amount':_0x3ea6e2[_0x326b1a(0x21c)],'currency':_0x4cd3f3,'sourceCurrency':_0x3ea6e2[_0x326b1a(0x227)]||undefined,'gateway':_0xda38fd,'type':_0x2c7b05,'currentPayments':0x0,'status':'ACTIVE','expiresAt':_0x3ea6e2['expiresAt']?new Date(_0x3ea6e2[_0x326b1a(0x1c1)]):undefined,'successUrl':_0x3ea6e2[_0x326b1a(0x253)]||null,'failUrl':_0x3ea6e2[_0x326b1a(0x1cf)]||null,'pendingUrl':_0x3ea6e2['pendingUrl']||null,'country':_0x58401a,'language':_0x3ea6e2['language']||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x326b1a(0x1b2)]('✅\x20Payment\x20link\x20created:\x20'+_0x1c8c33['id']+'\x20('+_0xda38fd+')'),console[_0x326b1a(0x1b2)](_0x326b1a(0x1c8)+_0x1c8c33[_0x326b1a(0x21c)]+'\x20'+_0x1c8c33[_0x326b1a(0x23f)]),console[_0x326b1a(0x1b2)](_0x326b1a(0x22c)+_0x1c8c33[_0x326b1a(0x196)]),console[_0x326b1a(0x1b2)](_0x326b1a(0x209)+_0x1c8c33['id']),console[_0x326b1a(0x1b2)](_0x326b1a(0x193)),this[_0x326b1a(0x234)](_0x1c8c33);}async['getPaymentLinks'](_0x134408,_0x2c89cf){const _0x1c4a02=a50_0x5c81dd,{page:_0x2db8fa,limit:_0x2c1e23,status:_0x2c1ffb,gateway:_0x4351bb,search:_0x32380a}=_0x2c89cf,_0x4cd0e8=(_0x2db8fa-0x1)*_0x2c1e23,_0x1e3f1e={'shopId':_0x134408};_0x2c1ffb&&(_0x1e3f1e[_0x1c4a02(0x1be)]=_0x2c1ffb['toUpperCase']());if(_0x4351bb){if((0x0,gateway_1['isValidGatewayId'])(_0x4351bb)){const _0x380a5f=(0x0,gateway_1[_0x1c4a02(0x1b4)])(_0x4351bb);_0x380a5f&&(_0x1e3f1e[_0x1c4a02(0x183)]=_0x380a5f);}else _0x1e3f1e[_0x1c4a02(0x183)]=_0x4351bb[_0x1c4a02(0x1e1)]();}_0x32380a&&(_0x1e3f1e['OR']=[{'gateway':{'contains':_0x32380a,'mode':_0x1c4a02(0x160)}},{'currency':{'contains':_0x32380a,'mode':_0x1c4a02(0x160)}}]);const [_0x394142,_0x9d2b9a]=await Promise['all']([database_1[_0x1c4a02(0x212)][_0x1c4a02(0x24e)][_0x1c4a02(0x1e0)]({'where':_0x1e3f1e,'skip':_0x4cd0e8,'take':_0x2c1e23,'orderBy':{'createdAt':_0x1c4a02(0x249)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}}),database_1['default'][_0x1c4a02(0x24e)]['count']({'where':_0x1e3f1e})]);return{'links':_0x394142['map'](_0x42277f=>this[_0x1c4a02(0x234)](_0x42277f)),'pagination':{'page':_0x2db8fa,'limit':_0x2c1e23,'total':_0x9d2b9a,'totalPages':Math[_0x1c4a02(0x1a9)](_0x9d2b9a/_0x2c1e23)}};}async['getPaymentLinkById'](_0x1917f1,_0x364a0f){const _0x4574b3=a50_0x5c81dd,_0x40665a=await database_1['default']['paymentLink'][_0x4574b3(0x198)]({'where':{'id':_0x364a0f,'shopId':_0x1917f1},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x4574b3(0x249)}}}});if(!_0x40665a)return null;return this['formatPaymentLinkResponse'](_0x40665a);}async['updatePaymentLink'](_0x189c80,_0x58dbb9,_0x2bcec1){const _0x80d1a4=a50_0x5c81dd,_0x101bb6={..._0x2bcec1};if(_0x2bcec1['gateway']){if((0x0,gateway_1['isValidGatewayId'])(_0x2bcec1[_0x80d1a4(0x183)])){const _0xcb3cc5=(0x0,gateway_1[_0x80d1a4(0x1b4)])(_0x2bcec1[_0x80d1a4(0x183)]);_0xcb3cc5&&(await this['checkGatewayPermission'](_0x189c80,_0xcb3cc5),_0x101bb6['gateway']=_0xcb3cc5);}else _0x101bb6[_0x80d1a4(0x183)]=_0x2bcec1['gateway'][_0x80d1a4(0x1e1)]();}(_0x101bb6[_0x80d1a4(0x183)]===_0x80d1a4(0x17b)||_0x2bcec1[_0x80d1a4(0x1ae)]&&_0x101bb6[_0x80d1a4(0x183)]!==_0x80d1a4(0x17b))&&(_0x101bb6['gateway']===_0x80d1a4(0x17b)&&(_0x101bb6['country']='GB',console[_0x80d1a4(0x1b2)]('🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update')));_0x101bb6[_0x80d1a4(0x183)]===_0x80d1a4(0x1dd)&&(_0x101bb6[_0x80d1a4(0x23f)]='EUR',console[_0x80d1a4(0x1b2)]('🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update'));_0x101bb6[_0x80d1a4(0x183)]&&_0x101bb6[_0x80d1a4(0x23f)]&&this[_0x80d1a4(0x1d2)](_0x101bb6[_0x80d1a4(0x183)],_0x101bb6[_0x80d1a4(0x23f)]);if(_0x2bcec1[_0x80d1a4(0x21c)]&&_0x101bb6[_0x80d1a4(0x183)]){const _0x181efc=_0x2bcec1[_0x80d1a4(0x23f)]||_0x80d1a4(0x203);await this[_0x80d1a4(0x1ce)](_0x189c80,_0x101bb6[_0x80d1a4(0x183)],_0x2bcec1[_0x80d1a4(0x21c)],_0x181efc);}_0x2bcec1[_0x80d1a4(0x1c1)]&&(_0x101bb6['expiresAt']=new Date(_0x2bcec1[_0x80d1a4(0x1c1)]));const _0x55a306=await database_1[_0x80d1a4(0x212)]['paymentLink']['update']({'where':{'id':_0x58dbb9,'shopId':_0x189c80},'data':_0x101bb6,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x80d1a4(0x249)},'take':0xa}}});return this[_0x80d1a4(0x234)](_0x55a306);}async['deletePaymentLink'](_0xb6455e,_0x5db719){const _0x30b5ec=a50_0x5c81dd;await database_1[_0x30b5ec(0x212)]['paymentLink'][_0x30b5ec(0x25e)]({'where':{'id':_0x5db719,'shopId':_0xb6455e}});}async[a50_0x5c81dd(0x1f1)](_0xa68167){const _0x4ddbdf=a50_0x5c81dd,_0x174857=await database_1[_0x4ddbdf(0x212)]['paymentLink'][_0x4ddbdf(0x213)]({'where':{'id':_0xa68167},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x174857)return null;const _0x1202a3=_0x174857[_0x4ddbdf(0x1c1)]&&_0x174857[_0x4ddbdf(0x1c1)]<new Date(),_0x507bba=_0x174857[_0x4ddbdf(0x196)]===_0x4ddbdf(0x178)?_0x174857[_0x4ddbdf(0x1c4)]>=0x1:![],_0x4db288=_0x174857['shop'][_0x4ddbdf(0x1be)]==='ACTIVE',_0x16b6a1=_0x174857[_0x4ddbdf(0x1be)]===_0x4ddbdf(0x192),_0x813c44=!_0x1202a3&&!_0x507bba&&_0x4db288&&_0x16b6a1,_0xc4af47=_0x174857['type']===_0x4ddbdf(0x178)?_0x174857[_0x4ddbdf(0x1c4)]>=0x1?0x0:0x1:Number[_0x4ddbdf(0x173)];return{'id':_0x174857['id'],'amount':_0x174857[_0x4ddbdf(0x21c)],'currency':_0x174857['currency'],'sourceCurrency':_0x174857['sourceCurrency']||undefined,'gateway':_0x174857[_0x4ddbdf(0x183)],'type':_0x174857['type'],'currentPayments':_0x174857['currentPayments'],'status':_0x174857['status'],'expiresAt':_0x174857[_0x4ddbdf(0x1c1)]||undefined,'shopName':_0x174857[_0x4ddbdf(0x1ab)][_0x4ddbdf(0x262)],'isAvailable':_0x813c44,'remainingPayments':_0xc4af47};}async['initiatePaymentFromLink'](_0x77de6f){const _0x4905a5=a50_0x5c81dd,{linkId:_0x1b6cb5,customerEmail:_0x1b0d96,customerName:_0x11fcf3}=_0x77de6f,_0x593803=await database_1[_0x4905a5(0x212)][_0x4905a5(0x24e)]['findUnique']({'where':{'id':_0x1b6cb5},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x593803)throw new Error(_0x4905a5(0x18b));const _0x107193=_0x593803[_0x4905a5(0x1c1)]&&_0x593803['expiresAt']<new Date(),_0x38bf4e=_0x593803[_0x4905a5(0x196)]===_0x4905a5(0x178)?_0x593803[_0x4905a5(0x1c4)]>=0x1:![],_0x1b256d=_0x593803['shop'][_0x4905a5(0x1be)]===_0x4905a5(0x192),_0x54a0ef=_0x593803[_0x4905a5(0x1be)]===_0x4905a5(0x192);if(_0x107193)throw new Error('Payment\x20link\x20has\x20expired');if(_0x38bf4e){const _0x478f85=_0x593803[_0x4905a5(0x196)]===_0x4905a5(0x178)?_0x4905a5(0x170):_0x4905a5(0x190);throw new Error(_0x478f85);}if(!_0x1b256d)throw new Error(_0x4905a5(0x1d3));if(!_0x54a0ef)throw new Error(_0x4905a5(0x1d8));await this[_0x4905a5(0x1ca)](_0x593803[_0x4905a5(0x261)],_0x593803[_0x4905a5(0x183)]);const _0x395245=_0x593803['amount'];console[_0x4905a5(0x1b2)](_0x4905a5(0x194)+_0x593803[_0x4905a5(0x196)]+_0x4905a5(0x1a5)+_0x1b6cb5+':\x20'+_0x395245+'\x20'+_0x593803['currency']),console[_0x4905a5(0x1b2)](_0x4905a5(0x23b)+(_0x11fcf3||_0x4905a5(0x233))+'\x20('+(_0x1b0d96||'no\x20email')+')'),this['validateKlymeCurrency'](_0x593803[_0x4905a5(0x183)],_0x593803[_0x4905a5(0x23f)]),await this[_0x4905a5(0x1ce)](_0x593803[_0x4905a5(0x261)],_0x593803[_0x4905a5(0x183)],_0x395245,_0x593803[_0x4905a5(0x23f)]);const _0x48ce44=this[_0x4905a5(0x1d6)]();console[_0x4905a5(0x1b2)](_0x4905a5(0x247)+_0x48ce44+_0x4905a5(0x1a4)+_0x593803[_0x4905a5(0x183)]+')');const _0x45cec1=await database_1[_0x4905a5(0x212)]['payment'][_0x4905a5(0x237)]({'data':{'shopId':_0x593803[_0x4905a5(0x261)],'paymentLinkId':_0x593803['id'],'gateway':_0x593803['gateway'],'amount':_0x395245,'currency':_0x593803[_0x4905a5(0x23f)],'sourceCurrency':_0x593803[_0x4905a5(0x227)]||undefined,'usage':_0x4905a5(0x205),'expiresAt':_0x593803[_0x4905a5(0x1c1)]||undefined,'successUrl':_0x4905a5(0x206),'failUrl':'temp','pendingUrl':_0x4905a5(0x206),'whiteUrl':'temp','status':_0x4905a5(0x185),'orderId':null,'gatewayOrderId':_0x48ce44,'customerEmail':_0x1b0d96||undefined,'customerName':_0x11fcf3||undefined,'country':_0x593803['country']||undefined,'language':_0x593803[_0x4905a5(0x22d)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console['log']('💾\x20Payment\x20created:\x20'+_0x45cec1['id']);const _0x25236e=process[_0x4905a5(0x16a)][_0x4905a5(0x239)]||_0x4905a5(0x22f),{finalSuccessUrl:_0x518574,finalFailUrl:_0x445639,finalPendingUrl:_0x173567,dbSuccessUrl:_0x98990a,dbFailUrl:_0x39f53d,dbPendingUrl:_0x2e87e4,whiteUrl:_0x5bebb4}=this[_0x4905a5(0x1a3)](_0x593803[_0x4905a5(0x183)],_0x45cec1['id'],_0x48ce44,_0x25236e,_0x593803['successUrl']||undefined,_0x593803[_0x4905a5(0x1cf)]||undefined,_0x593803[_0x4905a5(0x208)]||undefined);await database_1[_0x4905a5(0x212)][_0x4905a5(0x25b)][_0x4905a5(0x165)]({'where':{'id':_0x45cec1['id']},'data':{'successUrl':_0x98990a,'failUrl':_0x39f53d,'pendingUrl':_0x2e87e4,'whiteUrl':_0x5bebb4}}),console[_0x4905a5(0x1b2)](_0x4905a5(0x214)+_0x395245+'\x20'+_0x593803[_0x4905a5(0x23f)]),console[_0x4905a5(0x1b2)](_0x4905a5(0x23b)+(_0x11fcf3||_0x4905a5(0x233))+'\x20('+(_0x1b0d96||_0x4905a5(0x18a))+')'),console[_0x4905a5(0x1b2)](_0x4905a5(0x1d5)+_0x98990a),console[_0x4905a5(0x1b2)](_0x4905a5(0x252)+_0x39f53d),console[_0x4905a5(0x1b2)]('💾\x20DB\x20Pending\x20URL:\x20'+_0x2e87e4),console['log']('🔗\x20White\x20URL:\x20'+(_0x5bebb4||_0x4905a5(0x1ad)));let _0x1bd639,_0x133cbb;try{if(_0x593803[_0x4905a5(0x183)]===_0x4905a5(0x1fe)){console[_0x4905a5(0x1b2)](_0x4905a5(0x24d)),console['log']('\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20'+_0x593803[_0x4905a5(0x23f)]),console[_0x4905a5(0x1b2)](_0x4905a5(0x188)+_0x593803[_0x4905a5(0x227)]);const _0x48a442=await this[_0x4905a5(0x215)][_0x4905a5(0x1af)]({'paymentId':_0x45cec1['id'],'orderId':_0x48ce44,'amount':_0x395245,'currency':_0x593803['currency'],'productName':_0x4905a5(0x176)+_0x395245+'\x20'+_0x593803['currency'],'description':_0x4905a5(0x176)+_0x395245+'\x20'+_0x593803['currency'],'successUrl':_0x518574,'failUrl':_0x445639,'customerEmail':_0x1b0d96||undefined,'customerName':_0x11fcf3||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x593803[_0x4905a5(0x227)]||undefined});_0x1bd639=_0x48a442['gateway_payment_id'],_0x133cbb=_0x48a442[_0x4905a5(0x244)],await database_1['default'][_0x4905a5(0x25b)][_0x4905a5(0x165)]({'where':{'id':_0x45cec1['id']},'data':{'externalPaymentUrl':_0x133cbb,'gatewayPaymentId':_0x1bd639,'invoiceTotalSum':Number(_0x48a442[_0x4905a5(0x218)]),'qrCode':_0x48a442[_0x4905a5(0x1de)],'qrUrl':_0x48a442['qr_url']}});const _0x234240=_0x4905a5(0x241)+_0x45cec1['id'];return console[_0x4905a5(0x1b2)](_0x4905a5(0x18e)+_0x234240),{'paymentId':_0x45cec1['id'],'paymentUrl':_0x234240,'expiresAt':_0x45cec1['expiresAt']||undefined};}else{if(_0x593803[_0x4905a5(0x183)]===_0x4905a5(0x17b)){const _0x3b880e=await this[_0x4905a5(0x210)][_0x4905a5(0x191)]({'paymentId':_0x45cec1['id'],'orderId':_0x48ce44,'orderName':'Payment\x20'+_0x395245+'\x20'+_0x593803['currency'],'amount':_0x395245,'currency':_0x593803[_0x4905a5(0x23f)],'country':_0x593803[_0x4905a5(0x1ae)],'language':_0x593803[_0x4905a5(0x22d)]||'EN','amountIsEditable':![],'usage':'ONCE','maxPayments':0x1,'successUrl':_0x518574,'failUrl':_0x445639});_0x1bd639=_0x3b880e['gateway_payment_id'],_0x133cbb=_0x3b880e[_0x4905a5(0x244)],await database_1[_0x4905a5(0x212)]['payment'][_0x4905a5(0x165)]({'where':{'id':_0x45cec1['id']},'data':{'externalPaymentUrl':_0x133cbb,'gatewayPaymentId':_0x1bd639}});const _0x280b6d=_0x4905a5(0x241)+_0x45cec1['id'];return console['log'](_0x4905a5(0x19e)+_0x280b6d),{'paymentId':_0x45cec1['id'],'paymentUrl':_0x280b6d,'expiresAt':_0x45cec1['expiresAt']||undefined};}else{if(_0x593803[_0x4905a5(0x183)]===_0x4905a5(0x163)){const _0x3d1954=await this[_0x4905a5(0x1b1)][_0x4905a5(0x191)]({'paymentId':_0x45cec1['id'],'orderId':_0x48ce44,'name':'Payment\x20'+_0x395245+'\x20'+_0x593803[_0x4905a5(0x23f)],'paymentDescription':'Payment\x20'+_0x395245+'\x20'+_0x593803['currency'],'amount':_0x395245,'currency':_0x593803[_0x4905a5(0x23f)],'webhookUrl':'https://tesoft.uk/gateways/noda/webhook','returnUrl':_0x173567,'expiryDate':_0x593803[_0x4905a5(0x1c1)]?.['toISOString']()});_0x1bd639=_0x3d1954['gateway_payment_id'],_0x133cbb=_0x3d1954['payment_url'],await database_1['default'][_0x4905a5(0x25b)][_0x4905a5(0x165)]({'where':{'id':_0x45cec1['id']},'data':{'externalPaymentUrl':_0x133cbb,'gatewayPaymentId':_0x1bd639,'qrUrl':_0x3d1954[_0x4905a5(0x17d)]}});const _0x29584e='https://app.trapay.uk/payment/'+_0x45cec1['id'];return console['log'](_0x4905a5(0x259)+_0x29584e),{'paymentId':_0x45cec1['id'],'paymentUrl':_0x29584e,'expiresAt':_0x45cec1[_0x4905a5(0x1c1)]||undefined};}else{if(_0x593803[_0x4905a5(0x183)]===_0x4905a5(0x1dd)){console[_0x4905a5(0x1b2)](_0x4905a5(0x25d)+_0x48ce44+_0x4905a5(0x1da)),console[_0x4905a5(0x1b2)]('💰\x20Amount:\x20'+_0x395245+'\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)');const _0x16d2e0=await this[_0x4905a5(0x1fb)][_0x4905a5(0x191)]({'paymentId':_0x45cec1['id'],'orderId':_0x48ce44,'amount':_0x395245});_0x1bd639=_0x16d2e0[_0x4905a5(0x207)],_0x133cbb=_0x16d2e0[_0x4905a5(0x244)],await database_1[_0x4905a5(0x212)][_0x4905a5(0x25b)][_0x4905a5(0x165)]({'where':{'id':_0x45cec1['id']},'data':{'externalPaymentUrl':_0x133cbb,'gatewayPaymentId':_0x1bd639}});_0x1bd639&&(console['log']('🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20'+_0x45cec1['id']+'\x20('+_0x1bd639+')'),coinToPayStatusService_1[_0x4905a5(0x1aa)][_0x4905a5(0x1bf)](_0x45cec1['id'],_0x1bd639));const _0x5e0bb2=_0x4905a5(0x241)+_0x45cec1['id'];return console[_0x4905a5(0x1b2)](_0x4905a5(0x243)+_0x5e0bb2),{'paymentId':_0x45cec1['id'],'paymentUrl':_0x5e0bb2,'expiresAt':_0x45cec1[_0x4905a5(0x1c1)]||undefined};}else{if(_0x593803[_0x4905a5(0x183)]['startsWith'](_0x4905a5(0x202))){const _0x111f8c=(0x0,gateway_1[_0x4905a5(0x1ef)])(_0x593803[_0x4905a5(0x183)]);if(!_0x111f8c)throw new Error(_0x4905a5(0x20d)+_0x593803[_0x4905a5(0x183)]);console[_0x4905a5(0x1b2)](_0x4905a5(0x1ac)+_0x111f8c+'\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x48ce44+'\x20(8digits-8digits\x20format)'),console[_0x4905a5(0x1b2)]('💰\x20Amount:\x20'+_0x395245+'\x20'+_0x593803[_0x4905a5(0x23f)]+'\x20(validated\x20for\x20'+_0x111f8c+')');const _0x3b88e3=await this[_0x4905a5(0x1c0)][_0x4905a5(0x191)]({'paymentId':_0x45cec1['id'],'orderId':_0x48ce44,'amount':_0x395245,'currency':_0x593803[_0x4905a5(0x23f)],'region':_0x111f8c,'redirectUrl':_0x173567});_0x1bd639=_0x3b88e3['gateway_payment_id'],_0x133cbb=_0x3b88e3[_0x4905a5(0x244)],await database_1[_0x4905a5(0x212)][_0x4905a5(0x25b)][_0x4905a5(0x165)]({'where':{'id':_0x45cec1['id']},'data':{'externalPaymentUrl':_0x133cbb,'gatewayPaymentId':_0x1bd639}});const _0x21ee89='https://app.trapay.uk/payment/'+_0x45cec1['id'];return console[_0x4905a5(0x1b2)](_0x4905a5(0x18c)+_0x111f8c+_0x4905a5(0x238)+_0x48ce44),console['log'](_0x4905a5(0x1f4)+_0x111f8c+_0x4905a5(0x22b)+_0x21ee89),{'paymentId':_0x45cec1['id'],'paymentUrl':_0x21ee89,'expiresAt':_0x45cec1[_0x4905a5(0x1c1)]||undefined};}else{if(_0x593803[_0x4905a5(0x183)]===_0x4905a5(0x1fa)){console[_0x4905a5(0x1b2)](_0x4905a5(0x260)+_0x48ce44+'\x20(8digits-8digits\x20format)'),console[_0x4905a5(0x1b2)](_0x4905a5(0x214)+_0x395245+'\x20'+_0x593803[_0x4905a5(0x23f)]+_0x4905a5(0x168));const _0x2eb016='https://app.trapay.uk/test-gateway/payment/'+_0x45cec1['id'];await database_1[_0x4905a5(0x212)][_0x4905a5(0x25b)][_0x4905a5(0x165)]({'where':{'id':_0x45cec1['id']},'data':{'externalPaymentUrl':_0x2eb016,'gatewayPaymentId':_0x4905a5(0x1d7)+_0x48ce44}});const _0x8e4c24=_0x4905a5(0x241)+_0x45cec1['id'];return console[_0x4905a5(0x1b2)]('🔗\x20Test\x20Gateway\x20payment\x20URL:\x20'+_0x8e4c24),console[_0x4905a5(0x1b2)](_0x4905a5(0x1c6)+_0x2eb016),{'paymentId':_0x45cec1['id'],'paymentUrl':_0x8e4c24,'expiresAt':_0x45cec1[_0x4905a5(0x1c1)]||undefined};}else{if(_0x593803['gateway']===_0x4905a5(0x197)){console[_0x4905a5(0x1b2)](_0x4905a5(0x1d4)+_0x48ce44+_0x4905a5(0x1da)),console['log'](_0x4905a5(0x214)+_0x395245+'\x20'+_0x593803[_0x4905a5(0x23f)]+_0x4905a5(0x256));const _0x1fd32d=new URLSearchParams();_0x1b0d96&&_0x1fd32d[_0x4905a5(0x16e)]('email',_0x1b0d96);_0x11fcf3&&_0x1fd32d['append'](_0x4905a5(0x262),_0x11fcf3);const _0x1ba3a9=_0x4905a5(0x241)+_0x45cec1['id']+(_0x1fd32d['toString']()?'?'+_0x1fd32d['toString']():'');await database_1[_0x4905a5(0x212)][_0x4905a5(0x25b)][_0x4905a5(0x165)]({'where':{'id':_0x45cec1['id']},'data':{'externalPaymentUrl':_0x1ba3a9,'gatewayPaymentId':'mc_'+_0x48ce44,'paymentMethod':_0x4905a5(0x197)}});const _0x4d93a4=_0x4905a5(0x241)+_0x45cec1['id']+(_0x1fd32d[_0x4905a5(0x229)]()?'?'+_0x1fd32d[_0x4905a5(0x229)]():'');return console['log'](_0x4905a5(0x1e5)+_0x4d93a4),console[_0x4905a5(0x1b2)](_0x4905a5(0x1eb)+_0x1ba3a9),console[_0x4905a5(0x1b2)](_0x4905a5(0x164),_0x1fd32d[_0x4905a5(0x229)]()),{'paymentId':_0x45cec1['id'],'paymentUrl':_0x4d93a4,'expiresAt':_0x45cec1[_0x4905a5(0x1c1)]||undefined};}else throw new Error('Unsupported\x20gateway:\x20'+_0x593803[_0x4905a5(0x183)]);}}}}}}}catch(_0x442cb1){await database_1['default'][_0x4905a5(0x25b)][_0x4905a5(0x165)]({'where':{'id':_0x45cec1['id']},'data':{'status':_0x4905a5(0x1ee)}});throw new Error('Gateway\x20error:\x20'+(_0x442cb1 instanceof Error?_0x442cb1[_0x4905a5(0x15e)]:'Unknown\x20error'));}}async[a50_0x5c81dd(0x1fc)](_0x343f71){const _0x54231d=a50_0x5c81dd;console[_0x54231d(0x1b2)](_0x54231d(0x1bb)+_0x343f71);const _0x65b058=await database_1['default'][_0x54231d(0x25b)]['findUnique']({'where':{'id':_0x343f71},'include':{'paymentLink':!![]}});if(!_0x65b058||!_0x65b058[_0x54231d(0x24e)]){console[_0x54231d(0x1b2)](_0x54231d(0x169)+_0x343f71+_0x54231d(0x21e));return;}if(_0x65b058[_0x54231d(0x1be)]!==_0x54231d(0x162)){console[_0x54231d(0x1b2)](_0x54231d(0x169)+_0x343f71+'\x20status\x20is\x20'+_0x65b058[_0x54231d(0x1be)]+_0x54231d(0x257));return;}if(!_0x65b058[_0x54231d(0x1ed)]){console[_0x54231d(0x1b2)]('📈\x20Payment\x20'+_0x343f71+_0x54231d(0x222));return;}try{const _0x4a56f1=await database_1['default'][_0x54231d(0x1e9)](async _0xe97666=>{const _0x29a508=_0x54231d,_0x1c9f67=await _0xe97666['paymentLink']['findUnique']({'where':{'id':_0x65b058[_0x29a508(0x231)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(!_0x1c9f67)throw new Error(_0x29a508(0x16d)+_0x65b058[_0x29a508(0x231)]+'\x20not\x20found');if(_0x1c9f67[_0x29a508(0x196)]==='SINGLE'&&_0x1c9f67[_0x29a508(0x1c4)]>=0x1)return console[_0x29a508(0x1b2)](_0x29a508(0x19a)+_0x65b058[_0x29a508(0x231)]+_0x29a508(0x251)+_0x1c9f67['currentPayments']+'\x20payments),\x20skipping\x20increment'),_0x1c9f67;const _0x172b31=await _0xe97666[_0x29a508(0x25b)]['count']({'where':{'paymentLinkId':_0x65b058['paymentLinkId'],'status':_0x29a508(0x162),'paidAt':{'not':null},'id':{'not':_0x343f71}}}),_0x28802c=_0x172b31+0x1,_0x3d9d90=_0x1c9f67[_0x29a508(0x196)]==='SINGLE'&&_0x28802c>=0x1?_0x29a508(0x255):_0x1c9f67[_0x29a508(0x1be)],_0x3b6a93=await _0xe97666[_0x29a508(0x24e)]['update']({'where':{'id':_0x65b058[_0x29a508(0x231)]},'data':{'currentPayments':_0x28802c,'status':_0x3d9d90}});return console[_0x29a508(0x1b2)]('📈\x20Payment\x20link\x20'+_0x65b058['paymentLinkId']+'\x20('+_0x1c9f67[_0x29a508(0x196)]+')\x20counter\x20updated:\x20'+_0x1c9f67[_0x29a508(0x1c4)]+_0x29a508(0x17c)+_0x28802c),_0x3b6a93;});if(_0x4a56f1['status']===_0x54231d(0x255)){const _0x2bfcde=_0x4a56f1['type']===_0x54231d(0x178)?_0x54231d(0x1a6):_0x54231d(0x187);console[_0x54231d(0x1b2)](_0x54231d(0x25a)+_0x65b058[_0x54231d(0x231)]+_0x54231d(0x1f8)+_0x2bfcde+_0x54231d(0x174)+_0x4a56f1[_0x54231d(0x1c4)]+'\x20payments)');}}catch(_0x27e31d){console[_0x54231d(0x18f)]('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20'+_0x343f71+':',_0x27e31d);}}async[a50_0x5c81dd(0x246)](_0x52e047){const _0x56a6e9=a50_0x5c81dd,[_0x47d0fa,_0x1be66d,_0x2b3b9c,_0xd08cef]=await Promise['all']([database_1['default']['paymentLink'][_0x56a6e9(0x1a8)]({'where':{'shopId':_0x52e047}}),database_1[_0x56a6e9(0x212)][_0x56a6e9(0x24e)][_0x56a6e9(0x1a8)]({'where':{'shopId':_0x52e047,'status':_0x56a6e9(0x192)}}),database_1[_0x56a6e9(0x212)][_0x56a6e9(0x25b)][_0x56a6e9(0x1a8)]({'where':{'shopId':_0x52e047,'paymentLinkId':{'not':null},'gateway':{'not':_0x56a6e9(0x1fa)}}}),database_1['default'][_0x56a6e9(0x25b)][_0x56a6e9(0x1e0)]({'where':{'shopId':_0x52e047,'paymentLinkId':{'not':null},'status':_0x56a6e9(0x162),'gateway':{'not':_0x56a6e9(0x1fa)}},'select':{'amount':!![],'currency':!![]}})]);let _0x260f22=0x0;for(const _0x1ed69f of _0xd08cef){const _0xee9a9a=await currencyService_1[_0x56a6e9(0x16f)][_0x56a6e9(0x161)](_0x1ed69f[_0x56a6e9(0x21c)],_0x1ed69f[_0x56a6e9(0x23f)]);_0x260f22+=_0xee9a9a;}const _0x361b25=_0x2b3b9c>0x0?_0xd08cef[_0x56a6e9(0x24c)]/_0x2b3b9c*0x64:0x0;return{'totalLinks':_0x47d0fa,'activeLinks':_0x1be66d,'totalPayments':_0x2b3b9c,'totalRevenue':Math[_0x56a6e9(0x232)](_0x260f22*0x64)/0x64,'conversionRate':Math[_0x56a6e9(0x232)](_0x361b25*0x64)/0x64};}[a50_0x5c81dd(0x234)](_0x321649){const _0x5643ad=a50_0x5c81dd;return{'id':_0x321649['id'],'shopId':_0x321649[_0x5643ad(0x261)],'amount':_0x321649[_0x5643ad(0x21c)],'currency':_0x321649[_0x5643ad(0x23f)],'sourceCurrency':_0x321649[_0x5643ad(0x227)]||undefined,'gateway':_0x321649[_0x5643ad(0x183)],'type':_0x321649[_0x5643ad(0x196)],'currentPayments':_0x321649[_0x5643ad(0x1c4)],'status':_0x321649[_0x5643ad(0x1be)],'expiresAt':_0x321649[_0x5643ad(0x1c1)]||undefined,'successUrl':_0x321649[_0x5643ad(0x253)]||undefined,'failUrl':_0x321649[_0x5643ad(0x1cf)]||undefined,'pendingUrl':_0x321649[_0x5643ad(0x208)]||undefined,'country':_0x321649[_0x5643ad(0x1ae)]||undefined,'language':_0x321649[_0x5643ad(0x22d)]||undefined,'linkUrl':_0x5643ad(0x1dc)+_0x321649['id'],'createdAt':_0x321649['createdAt'],'updatedAt':_0x321649['updatedAt'],'shop':_0x321649[_0x5643ad(0x1ab)],'payments':_0x321649[_0x5643ad(0x1c3)]};}}function a50_0x3497(_0x559069,_0x5992b9){const _0x19799d=a50_0x1979();return a50_0x3497=function(_0x3497fd,_0xe75680){_0x3497fd=_0x3497fd-0x15d;let _0x5df929=_0x19799d[_0x3497fd];return _0x5df929;},a50_0x3497(_0x559069,_0x5992b9);}exports[a50_0x5c81dd(0x1ea)]=PaymentLinkService;