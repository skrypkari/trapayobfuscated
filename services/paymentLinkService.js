'use strict';const a44_0x40cb4a=a44_0x114a;(function(_0x1cdb54,_0x2434cf){const _0x2ba1d3=a44_0x114a,_0x19b299=_0x1cdb54();while(!![]){try{const _0x106148=-parseInt(_0x2ba1d3(0x18b))/0x1*(-parseInt(_0x2ba1d3(0x14b))/0x2)+-parseInt(_0x2ba1d3(0x190))/0x3+parseInt(_0x2ba1d3(0x154))/0x4+parseInt(_0x2ba1d3(0x103))/0x5+parseInt(_0x2ba1d3(0x134))/0x6+parseInt(_0x2ba1d3(0xf6))/0x7+-parseInt(_0x2ba1d3(0x114))/0x8;if(_0x106148===_0x2434cf)break;else _0x19b299['push'](_0x19b299['shift']());}catch(_0x473bd2){_0x19b299['push'](_0x19b299['shift']());}}}(a44_0x3dca,0x67f8d));var __importDefault=this&&this['__importDefault']||function(_0x57aa43){const _0x37425d=a44_0x114a;return _0x57aa43&&_0x57aa43[_0x37425d(0xfc)]?_0x57aa43:{'default':_0x57aa43};};Object[a44_0x40cb4a(0x16c)](exports,a44_0x40cb4a(0xfc),{'value':!![]}),exports[a44_0x40cb4a(0x125)]=void 0x0;function a44_0x114a(_0x43d68,_0x4ec17c){const _0x3dca31=a44_0x3dca();return a44_0x114a=function(_0x114a9d,_0x5066b1){_0x114a9d=_0x114a9d-0xe5;let _0x3dd71d=_0x3dca31[_0x114a9d];return _0x3dd71d;},a44_0x114a(_0x43d68,_0x4ec17c);}const database_1=__importDefault(require(a44_0x40cb4a(0x17c))),plisioService_1=require(a44_0x40cb4a(0x164)),rapydService_1=require(a44_0x40cb4a(0x133)),nodaService_1=require(a44_0x40cb4a(0x16e)),coinToPayService_1=require(a44_0x40cb4a(0xee)),klymeService_1=require('./gateways/klymeService'),gateway_1=require(a44_0x40cb4a(0x116)),currencyService_1=require(a44_0x40cb4a(0xe6));class PaymentLinkService{constructor(){const _0x2d95c4=a44_0x40cb4a;this[_0x2d95c4(0x11c)]=new plisioService_1[(_0x2d95c4(0x159))](),this[_0x2d95c4(0x171)]=new rapydService_1[(_0x2d95c4(0x124))](),this[_0x2d95c4(0x10a)]=new nodaService_1[(_0x2d95c4(0x115))](),this['coinToPayService']=new coinToPayService_1[(_0x2d95c4(0x146))](),this[_0x2d95c4(0x143)]=new klymeService_1[(_0x2d95c4(0x102))]();}[a44_0x40cb4a(0xfb)](){const _0x4790a1=()=>{const _0x323f04=a44_0x114a;return Math[_0x323f04(0x14d)](Math[_0x323f04(0x107)]()*0x5f5e100)[_0x323f04(0x18f)]()[_0x323f04(0x181)](0x8,'0');};return _0x4790a1()+'-'+_0x4790a1();}['generateGatewayUrls'](_0x5685f3,_0x1f7fb6,_0x16eb60,_0x16815e,_0x21bf71){const _0x410936=a44_0x40cb4a;if(_0x16815e&&_0x21bf71)return{'finalSuccessUrl':_0x16815e,'finalFailUrl':_0x21bf71,'dbSuccessUrl':_0x16815e,'dbFailUrl':_0x21bf71};let _0x50932a,_0x2f60f3,_0x10751a,_0x34736c;return _0x5685f3===_0x410936(0x170)||_0x5685f3[_0x410936(0x119)](_0x410936(0x14e))?(_0x50932a=_0x16eb60+_0x410936(0x117)+_0x1f7fb6,_0x10751a=_0x410936(0x15a)):(_0x50932a=_0x16eb60+'/gateway/success.php?id='+_0x1f7fb6,_0x10751a='https://app.trapay.uk/payment/success'),_0x2f60f3=_0x16eb60+_0x410936(0x16f)+_0x1f7fb6,_0x34736c='https://app.trapay.uk/payment/fail',console[_0x410936(0xf7)](_0x410936(0x148)+_0x5685f3+':'),console[_0x410936(0xf7)](_0x410936(0x13a)+_0x50932a),console[_0x410936(0xf7)](_0x410936(0x136)+_0x2f60f3),console['log']('\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20'+_0x10751a),console[_0x410936(0xf7)](_0x410936(0x165)+_0x34736c),{'finalSuccessUrl':_0x50932a,'finalFailUrl':_0x2f60f3,'dbSuccessUrl':_0x10751a,'dbFailUrl':_0x34736c};}[a44_0x40cb4a(0x13f)](_0x3d281f,_0x379f4d){const _0x201bf3=a44_0x40cb4a;if(!_0x3d281f[_0x201bf3(0x119)](_0x201bf3(0x14e)))return;const _0x55726d=(0x0,gateway_1[_0x201bf3(0x130)])(_0x3d281f),_0x2c1978=_0x379f4d[_0x201bf3(0x162)]();switch(_0x55726d){case'EU':if(_0x2c1978!=='EUR')throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x2c1978);break;case'GB':if(_0x2c1978!==_0x201bf3(0x160))throw new Error(_0x201bf3(0x11f)+_0x2c1978);break;case'DE':if(_0x2c1978!==_0x201bf3(0x12d))throw new Error(_0x201bf3(0x188)+_0x2c1978);break;default:throw new Error(_0x201bf3(0x131)+_0x55726d);}}async[a44_0x40cb4a(0x132)](_0x2320aa,_0x589a50){const _0x55da7e=a44_0x40cb4a;if(!(0x0,gateway_1[_0x55da7e(0x147)])(_0x589a50[_0x55da7e(0x120)]))throw new Error(_0x55da7e(0x15f)+_0x589a50[_0x55da7e(0x120)]+_0x55da7e(0xef));const _0x3a0dbd=(0x0,gateway_1[_0x55da7e(0xed)])(_0x589a50[_0x55da7e(0x120)]);if(!_0x3a0dbd)throw new Error(_0x55da7e(0x16a)+_0x589a50['gateway']);console[_0x55da7e(0xf7)]('🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20'+_0x3a0dbd);if(_0x3a0dbd==='plisio'&&!_0x589a50['sourceCurrency'])throw new Error(_0x55da7e(0x128));if(_0x3a0dbd[_0x55da7e(0x119)](_0x55da7e(0x14e))){const _0x376899=(0x0,gateway_1[_0x55da7e(0x130)])(_0x3a0dbd);if(_0x376899!=='EU'&&_0x376899!=='GB')throw new Error(_0x55da7e(0x174)+_0x376899);}let _0x2d033b=_0x589a50[_0x55da7e(0x182)];_0x3a0dbd===_0x55da7e(0x109)&&(_0x2d033b='GB',console[_0x55da7e(0xf7)](_0x55da7e(0x177)));if(!_0x589a50[_0x55da7e(0x166)]||_0x589a50['amount']<=0x0)throw new Error(_0x55da7e(0x18c));let _0x23cf2d=_0x589a50['currency']||_0x55da7e(0xe9);_0x3a0dbd===_0x55da7e(0x11d)&&(_0x23cf2d='EUR',console['log']('🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link'));this[_0x55da7e(0x13f)](_0x3a0dbd,_0x23cf2d);const _0x4c5121=process[_0x55da7e(0x13d)][_0x55da7e(0x153)]||_0x55da7e(0x16d),{finalSuccessUrl:_0x22091c,finalFailUrl:_0x54f953,dbSuccessUrl:_0x568b08,dbFailUrl:_0xb336f8}=this['generateGatewayUrls'](_0x3a0dbd,_0x55da7e(0x192),_0x4c5121,_0x589a50[_0x55da7e(0x169)],_0x589a50[_0x55da7e(0x104)]),_0x3f184b=await database_1['default'][_0x55da7e(0x14c)][_0x55da7e(0xfa)]({'data':{'shopId':_0x2320aa,'amount':_0x589a50[_0x55da7e(0x166)],'currency':_0x23cf2d,'sourceCurrency':_0x589a50[_0x55da7e(0xf9)]||undefined,'gateway':_0x3a0dbd,'maxPayments':_0x589a50['maxPayments']||0x1,'currentPayments':0x0,'status':_0x55da7e(0x15e),'expiresAt':_0x589a50[_0x55da7e(0x111)]?new Date(_0x589a50[_0x55da7e(0x111)]):undefined,'successUrl':_0x568b08,'failUrl':_0xb336f8,'country':_0x2d033b,'language':_0x589a50['language']||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x55da7e(0xf7)]('✅\x20Payment\x20link\x20created:\x20'+_0x3f184b['id']+'\x20('+_0x3a0dbd+')'),console[_0x55da7e(0xf7)](_0x55da7e(0xfe)+_0x3f184b[_0x55da7e(0x166)]+'\x20'+_0x3f184b[_0x55da7e(0x129)]),console[_0x55da7e(0xf7)](_0x55da7e(0x152)+_0x3f184b['id']),console[_0x55da7e(0xf7)](_0x55da7e(0xf1)+_0x3f184b['successUrl']),console[_0x55da7e(0xf7)](_0x55da7e(0x12e)+_0x3f184b['failUrl']),this[_0x55da7e(0x14a)](_0x3f184b);}async['getPaymentLinks'](_0x26582c,_0x456d7a){const _0xc9bb8f=a44_0x40cb4a,{page:_0x504fad,limit:_0x531f12,status:_0x341de6,gateway:_0x5f1cb7,search:_0x77db63}=_0x456d7a,_0x59a4fb=(_0x504fad-0x1)*_0x531f12,_0x335adf={'shopId':_0x26582c};_0x341de6&&(_0x335adf[_0xc9bb8f(0x113)]=_0x341de6[_0xc9bb8f(0x162)]());if(_0x5f1cb7){if((0x0,gateway_1[_0xc9bb8f(0x147)])(_0x5f1cb7)){const _0x579887=(0x0,gateway_1['getGatewayNameById'])(_0x5f1cb7);_0x579887&&(_0x335adf[_0xc9bb8f(0x120)]=_0x579887);}else _0x335adf[_0xc9bb8f(0x120)]=_0x5f1cb7['toLowerCase']();}_0x77db63&&(_0x335adf['OR']=[{'gateway':{'contains':_0x77db63,'mode':'insensitive'}},{'currency':{'contains':_0x77db63,'mode':_0xc9bb8f(0x112)}}]);const [_0x2240e5,_0x3bbcf3]=await Promise[_0xc9bb8f(0x157)]([database_1[_0xc9bb8f(0x141)][_0xc9bb8f(0x14c)][_0xc9bb8f(0x161)]({'where':_0x335adf,'skip':_0x59a4fb,'take':_0x531f12,'orderBy':{'createdAt':_0xc9bb8f(0x14f)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}}),database_1['default'][_0xc9bb8f(0x14c)][_0xc9bb8f(0x110)]({'where':_0x335adf})]);return{'links':_0x2240e5[_0xc9bb8f(0x17b)](_0xce0579=>this[_0xc9bb8f(0x14a)](_0xce0579)),'pagination':{'page':_0x504fad,'limit':_0x531f12,'total':_0x3bbcf3,'totalPages':Math[_0xc9bb8f(0xf4)](_0x3bbcf3/_0x531f12)}};}async[a44_0x40cb4a(0xe7)](_0x55ea48,_0x569fb3){const _0x39c661=a44_0x40cb4a,_0x454f38=await database_1[_0x39c661(0x141)][_0x39c661(0x14c)][_0x39c661(0x121)]({'where':{'id':_0x569fb3,'shopId':_0x55ea48},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x39c661(0x14f)}}}});if(!_0x454f38)return null;return this[_0x39c661(0x14a)](_0x454f38);}async['updatePaymentLink'](_0x50dd09,_0x107390,_0x2d0e73){const _0x3b92d9=a44_0x40cb4a,_0x3463e3={..._0x2d0e73};if(_0x2d0e73[_0x3b92d9(0x120)]){if((0x0,gateway_1[_0x3b92d9(0x147)])(_0x2d0e73[_0x3b92d9(0x120)])){const _0x18cbeb=(0x0,gateway_1[_0x3b92d9(0xed)])(_0x2d0e73[_0x3b92d9(0x120)]);_0x18cbeb&&(_0x3463e3[_0x3b92d9(0x120)]=_0x18cbeb);}else _0x3463e3['gateway']=_0x2d0e73[_0x3b92d9(0x120)][_0x3b92d9(0x139)]();}(_0x3463e3[_0x3b92d9(0x120)]===_0x3b92d9(0x109)||_0x2d0e73[_0x3b92d9(0x182)]&&_0x3463e3[_0x3b92d9(0x120)]!==_0x3b92d9(0x109))&&(_0x3463e3[_0x3b92d9(0x120)]===_0x3b92d9(0x109)&&(_0x3463e3[_0x3b92d9(0x182)]='GB',console['log']('🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update')));_0x3463e3[_0x3b92d9(0x120)]===_0x3b92d9(0x11d)&&(_0x3463e3[_0x3b92d9(0x129)]=_0x3b92d9(0x12d),console[_0x3b92d9(0xf7)](_0x3b92d9(0x10c)));_0x3463e3[_0x3b92d9(0x120)]&&_0x3463e3[_0x3b92d9(0x129)]&&this[_0x3b92d9(0x13f)](_0x3463e3['gateway'],_0x3463e3[_0x3b92d9(0x129)]);_0x2d0e73[_0x3b92d9(0x111)]&&(_0x3463e3[_0x3b92d9(0x111)]=new Date(_0x2d0e73[_0x3b92d9(0x111)]));const _0x3489e0=await database_1[_0x3b92d9(0x141)][_0x3b92d9(0x14c)][_0x3b92d9(0xf3)]({'where':{'id':_0x107390,'shopId':_0x50dd09},'data':_0x3463e3,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x3b92d9(0x14f)},'take':0xa}}});return this['formatPaymentLinkResponse'](_0x3489e0);}async[a44_0x40cb4a(0x180)](_0x5dadcd,_0x27bf77){const _0x1bf3fa=a44_0x40cb4a;await database_1['default'][_0x1bf3fa(0x14c)][_0x1bf3fa(0x12c)]({'where':{'id':_0x27bf77,'shopId':_0x5dadcd}});}async[a44_0x40cb4a(0x189)](_0x5a45d7){const _0x45d07b=a44_0x40cb4a,_0x5753e4=await database_1[_0x45d07b(0x141)][_0x45d07b(0x14c)][_0x45d07b(0x11a)]({'where':{'id':_0x5a45d7},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x5753e4)return null;const _0x3f9fb7=_0x5753e4[_0x45d07b(0x111)]&&_0x5753e4['expiresAt']<new Date(),_0x360b81=_0x5753e4['currentPayments']>=_0x5753e4[_0x45d07b(0x15d)],_0x557cc3=_0x5753e4[_0x45d07b(0xfd)][_0x45d07b(0x113)]===_0x45d07b(0x15e),_0x3de0a4=_0x5753e4['status']==='ACTIVE',_0x149905=!_0x3f9fb7&&!_0x360b81&&_0x557cc3&&_0x3de0a4,_0x107890=Math[_0x45d07b(0x175)](0x0,_0x5753e4[_0x45d07b(0x15d)]-_0x5753e4[_0x45d07b(0x100)]);return{'id':_0x5753e4['id'],'amount':_0x5753e4['amount'],'currency':_0x5753e4['currency'],'sourceCurrency':_0x5753e4[_0x45d07b(0xf9)]||undefined,'gateway':_0x5753e4[_0x45d07b(0x120)],'maxPayments':_0x5753e4['maxPayments'],'currentPayments':_0x5753e4['currentPayments'],'status':_0x5753e4[_0x45d07b(0x113)],'expiresAt':_0x5753e4[_0x45d07b(0x111)]||undefined,'shopName':_0x5753e4['shop'][_0x45d07b(0x184)],'isAvailable':_0x149905,'remainingPayments':_0x107890};}async[a44_0x40cb4a(0x144)](_0xd48954){const _0x3d1c83=a44_0x40cb4a,{linkId:_0xcb1a4f,customerEmail:_0x195834,customerName:_0x2d6667}=_0xd48954,_0x120e5e=await database_1['default']['paymentLink'][_0x3d1c83(0x11a)]({'where':{'id':_0xcb1a4f},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![]}}}});if(!_0x120e5e)throw new Error('Payment\x20link\x20not\x20found');const _0x300b93=_0x120e5e[_0x3d1c83(0x111)]&&_0x120e5e[_0x3d1c83(0x111)]<new Date(),_0x23fb68=_0x120e5e[_0x3d1c83(0x100)]>=_0x120e5e[_0x3d1c83(0x15d)],_0x2f8163=_0x120e5e[_0x3d1c83(0xfd)][_0x3d1c83(0x113)]===_0x3d1c83(0x15e),_0x20a4da=_0x120e5e[_0x3d1c83(0x113)]==='ACTIVE';if(_0x300b93)throw new Error(_0x3d1c83(0x150));if(_0x23fb68)throw new Error(_0x3d1c83(0x142));if(!_0x2f8163)throw new Error(_0x3d1c83(0x12a));if(!_0x20a4da)throw new Error(_0x3d1c83(0x18a));const _0x2cf4d9=_0x120e5e['amount'];console['log'](_0x3d1c83(0xe8)+_0xcb1a4f+':\x20'+_0x2cf4d9+'\x20'+_0x120e5e[_0x3d1c83(0x129)]),console[_0x3d1c83(0xf7)](_0x3d1c83(0xe5)+(_0x2d6667||_0x3d1c83(0xf8))+'\x20('+(_0x195834||_0x3d1c83(0x17d))+')'),this[_0x3d1c83(0x13f)](_0x120e5e[_0x3d1c83(0x120)],_0x120e5e[_0x3d1c83(0x129)]);const _0x5455a9=this[_0x3d1c83(0xfb)]();console[_0x3d1c83(0xf7)](_0x3d1c83(0x137)+_0x5455a9+_0x3d1c83(0xf0)+_0x120e5e[_0x3d1c83(0x120)]+')');const _0x25d8e9=process[_0x3d1c83(0x13d)][_0x3d1c83(0x153)]||_0x3d1c83(0x16d),{finalSuccessUrl:_0x3fec7a,finalFailUrl:_0x58b02e,dbSuccessUrl:_0x1e0ed4,dbFailUrl:_0x224800}=this[_0x3d1c83(0x179)](_0x120e5e[_0x3d1c83(0x120)],_0x5455a9,_0x25d8e9,_0x120e5e[_0x3d1c83(0x169)]||undefined,_0x120e5e[_0x3d1c83(0x104)]||undefined),_0x4a45c5=await database_1[_0x3d1c83(0x141)][_0x3d1c83(0x155)][_0x3d1c83(0xfa)]({'data':{'shopId':_0x120e5e['shopId'],'paymentLinkId':_0x120e5e['id'],'gateway':_0x120e5e[_0x3d1c83(0x120)],'amount':_0x2cf4d9,'currency':_0x120e5e[_0x3d1c83(0x129)],'sourceCurrency':_0x120e5e[_0x3d1c83(0xf9)]||undefined,'usage':'ONCE','expiresAt':_0x120e5e['expiresAt']||undefined,'successUrl':_0x1e0ed4,'failUrl':_0x224800,'status':'PENDING','orderId':null,'gatewayOrderId':_0x5455a9,'customerEmail':_0x195834||undefined,'customerName':_0x2d6667||undefined,'country':_0x120e5e[_0x3d1c83(0x182)]||undefined,'language':_0x120e5e[_0x3d1c83(0x183)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x3d1c83(0xf7)](_0x3d1c83(0x11b)+_0x4a45c5['id']),console['log'](_0x3d1c83(0x106)+_0x2cf4d9+'\x20'+_0x120e5e[_0x3d1c83(0x129)]),console[_0x3d1c83(0xf7)]('👤\x20Customer:\x20'+(_0x2d6667||_0x3d1c83(0xf8))+'\x20('+(_0x195834||_0x3d1c83(0x17d))+')'),console[_0x3d1c83(0xf7)]('💾\x20DB\x20Success\x20URL:\x20'+_0x1e0ed4),console['log'](_0x3d1c83(0xec)+_0x224800);let _0x163397,_0x79a4ea;try{if(_0x120e5e[_0x3d1c83(0x120)]===_0x3d1c83(0x17a)){console['log'](_0x3d1c83(0x167)),console[_0x3d1c83(0xf7)](_0x3d1c83(0x138)+_0x120e5e[_0x3d1c83(0x129)]),console[_0x3d1c83(0xf7)](_0x3d1c83(0x186)+_0x120e5e[_0x3d1c83(0xf9)]);const _0x3fba7a=await this[_0x3d1c83(0x11c)][_0x3d1c83(0xeb)]({'paymentId':_0x4a45c5['id'],'orderId':_0x5455a9,'amount':_0x2cf4d9,'currency':_0x120e5e[_0x3d1c83(0x129)],'productName':'Payment\x20'+_0x2cf4d9+'\x20'+_0x120e5e['currency'],'description':_0x3d1c83(0x173)+_0x2cf4d9+'\x20'+_0x120e5e[_0x3d1c83(0x129)],'successUrl':_0x3fec7a,'failUrl':_0x58b02e,'customerEmail':_0x195834||undefined,'customerName':_0x2d6667||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x120e5e['sourceCurrency']||undefined});_0x163397=_0x3fba7a['gateway_payment_id'],_0x79a4ea=_0x3fba7a[_0x3d1c83(0x17e)],await database_1['default'][_0x3d1c83(0x155)][_0x3d1c83(0xf3)]({'where':{'id':_0x4a45c5['id']},'data':{'externalPaymentUrl':_0x79a4ea,'gatewayPaymentId':_0x163397,'invoiceTotalSum':_0x3fba7a[_0x3d1c83(0x15b)],'qrCode':_0x3fba7a[_0x3d1c83(0x10f)],'qrUrl':_0x3fba7a[_0x3d1c83(0x149)]}});const _0x34dca4=_0x3d1c83(0x13b)+_0x4a45c5['id'];return console[_0x3d1c83(0xf7)]('🔗\x20Plisio\x20payment\x20URL:\x20'+_0x34dca4),{'paymentId':_0x4a45c5['id'],'paymentUrl':_0x34dca4,'expiresAt':_0x4a45c5['expiresAt']||undefined};}else{if(_0x120e5e[_0x3d1c83(0x120)]==='rapyd'){const _0x8d2567=await this['rapydService']['createPaymentLink']({'paymentId':_0x4a45c5['id'],'orderId':_0x5455a9,'orderName':_0x3d1c83(0x173)+_0x2cf4d9+'\x20'+_0x120e5e[_0x3d1c83(0x129)],'amount':_0x2cf4d9,'currency':_0x120e5e[_0x3d1c83(0x129)],'country':_0x120e5e[_0x3d1c83(0x182)],'language':_0x120e5e[_0x3d1c83(0x183)]||'EN','amountIsEditable':![],'usage':_0x3d1c83(0x11e),'maxPayments':0x1,'successUrl':_0x3fec7a,'failUrl':_0x58b02e});_0x163397=_0x8d2567[_0x3d1c83(0xff)],_0x79a4ea=_0x8d2567[_0x3d1c83(0x17e)],await database_1[_0x3d1c83(0x141)][_0x3d1c83(0x155)][_0x3d1c83(0xf3)]({'where':{'id':_0x4a45c5['id']},'data':{'externalPaymentUrl':_0x79a4ea,'gatewayPaymentId':_0x163397}});const _0x1f6d12=_0x3d1c83(0x145)+_0x4a45c5['id'];return console[_0x3d1c83(0xf7)](_0x3d1c83(0x17f)+_0x1f6d12),{'paymentId':_0x4a45c5['id'],'paymentUrl':_0x1f6d12,'expiresAt':_0x4a45c5[_0x3d1c83(0x111)]||undefined};}else{if(_0x120e5e['gateway']==='noda'){const _0x224cbe=await this[_0x3d1c83(0x10a)]['createPaymentLink']({'paymentId':_0x4a45c5['id'],'orderId':_0x5455a9,'name':_0x3d1c83(0x173)+_0x2cf4d9+'\x20'+_0x120e5e['currency'],'paymentDescription':_0x3d1c83(0x173)+_0x2cf4d9+'\x20'+_0x120e5e[_0x3d1c83(0x129)],'amount':_0x2cf4d9,'currency':_0x120e5e['currency'],'webhookUrl':_0x3d1c83(0x18e),'returnUrl':_0x3fec7a,'expiryDate':_0x120e5e[_0x3d1c83(0x111)]?.[_0x3d1c83(0x158)]()});_0x163397=_0x224cbe[_0x3d1c83(0xff)],_0x79a4ea=_0x224cbe[_0x3d1c83(0x17e)],await database_1[_0x3d1c83(0x141)][_0x3d1c83(0x155)][_0x3d1c83(0xf3)]({'where':{'id':_0x4a45c5['id']},'data':{'externalPaymentUrl':_0x79a4ea,'gatewayPaymentId':_0x163397,'qrUrl':_0x224cbe['qr_code_url']}});const _0x44203d=_0x3d1c83(0x145)+_0x4a45c5['id'];return console['log'](_0x3d1c83(0x122)+_0x44203d),{'paymentId':_0x4a45c5['id'],'paymentUrl':_0x44203d,'expiresAt':_0x4a45c5['expiresAt']||undefined};}else{if(_0x120e5e['gateway']===_0x3d1c83(0x11d)){console[_0x3d1c83(0xf7)](_0x3d1c83(0x163)+_0x5455a9+_0x3d1c83(0x18d)),console[_0x3d1c83(0xf7)](_0x3d1c83(0x106)+_0x2cf4d9+_0x3d1c83(0x187));const _0x40cd48=await this[_0x3d1c83(0x15c)][_0x3d1c83(0x132)]({'paymentId':_0x4a45c5['id'],'orderId':_0x5455a9,'amount':_0x2cf4d9});_0x163397=_0x40cd48['gateway_payment_id'],_0x79a4ea=_0x40cd48[_0x3d1c83(0x17e)],await database_1[_0x3d1c83(0x141)][_0x3d1c83(0x155)][_0x3d1c83(0xf3)]({'where':{'id':_0x4a45c5['id']},'data':{'externalPaymentUrl':_0x79a4ea,'gatewayPaymentId':_0x163397}});const _0xbc5b17=_0x3d1c83(0x145)+_0x4a45c5['id'];return console[_0x3d1c83(0xf7)](_0x3d1c83(0x101)+_0xbc5b17),{'paymentId':_0x4a45c5['id'],'paymentUrl':_0xbc5b17,'expiresAt':_0x4a45c5['expiresAt']||undefined};}else{if(_0x120e5e[_0x3d1c83(0x120)][_0x3d1c83(0x119)](_0x3d1c83(0x14e))){const _0x38af9c=(0x0,gateway_1[_0x3d1c83(0x130)])(_0x120e5e['gateway']);if(!_0x38af9c)throw new Error(_0x3d1c83(0x178)+_0x120e5e['gateway']);if(_0x38af9c!=='EU'&&_0x38af9c!=='GB')throw new Error(_0x3d1c83(0x156)+_0x38af9c);console[_0x3d1c83(0xf7)](_0x3d1c83(0x140)+_0x38af9c+_0x3d1c83(0xf5)+_0x5455a9+_0x3d1c83(0x18d)),console[_0x3d1c83(0xf7)]('💰\x20Amount:\x20'+_0x2cf4d9+'\x20'+_0x120e5e[_0x3d1c83(0x129)]+_0x3d1c83(0x191)+_0x38af9c+')');const _0x29404b=await this['klymeService']['createPaymentLink']({'paymentId':_0x4a45c5['id'],'orderId':_0x5455a9,'amount':_0x2cf4d9,'currency':_0x120e5e[_0x3d1c83(0x129)],'region':_0x38af9c,'redirectUrl':_0x3fec7a});_0x163397=_0x29404b[_0x3d1c83(0xff)],_0x79a4ea=_0x29404b[_0x3d1c83(0x17e)],await database_1[_0x3d1c83(0x141)][_0x3d1c83(0x155)][_0x3d1c83(0xf3)]({'where':{'id':_0x4a45c5['id']},'data':{'externalPaymentUrl':_0x79a4ea,'gatewayPaymentId':_0x163397}});const _0x4986cc=_0x3d1c83(0x13b)+_0x4a45c5['id'];return console[_0x3d1c83(0xf7)](_0x3d1c83(0x118)+_0x38af9c+_0x3d1c83(0x12b)+_0x5455a9),console[_0x3d1c83(0xf7)](_0x3d1c83(0x10d)+_0x38af9c+'\x20payment\x20URL:\x20'+_0x4986cc),{'paymentId':_0x4a45c5['id'],'paymentUrl':_0x4986cc,'expiresAt':_0x4a45c5[_0x3d1c83(0x111)]||undefined};}else throw new Error('Unsupported\x20gateway:\x20'+_0x120e5e[_0x3d1c83(0x120)]);}}}}}catch(_0x1f49d6){await database_1[_0x3d1c83(0x141)][_0x3d1c83(0x155)][_0x3d1c83(0xf3)]({'where':{'id':_0x4a45c5['id']},'data':{'status':_0x3d1c83(0x168)}});throw new Error(_0x3d1c83(0x127)+(_0x1f49d6 instanceof Error?_0x1f49d6[_0x3d1c83(0x10b)]:_0x3d1c83(0x13e)));}}async[a44_0x40cb4a(0x185)](_0x25f0fb){const _0xea9a67=a44_0x40cb4a,_0x4ede5c=await database_1[_0xea9a67(0x141)][_0xea9a67(0x155)][_0xea9a67(0x11a)]({'where':{'id':_0x25f0fb},'include':{'paymentLink':!![]}});if(!_0x4ede5c||!_0x4ede5c['paymentLink'])return;const _0x586e0b=await database_1[_0xea9a67(0x141)]['paymentLink'][_0xea9a67(0xf3)]({'where':{'id':_0x4ede5c[_0xea9a67(0x108)]},'data':{'currentPayments':{'increment':0x1}}});console[_0xea9a67(0xf7)](_0xea9a67(0x12f)+_0x4ede5c[_0xea9a67(0x108)]+'\x20payments:\x20'+_0x586e0b[_0xea9a67(0x100)]+'/'+_0x586e0b[_0xea9a67(0x15d)]),_0x586e0b[_0xea9a67(0x100)]>=_0x586e0b[_0xea9a67(0x15d)]&&(await database_1[_0xea9a67(0x141)][_0xea9a67(0x14c)][_0xea9a67(0xf3)]({'where':{'id':_0x4ede5c['paymentLinkId']},'data':{'status':_0xea9a67(0x10e)}}),console[_0xea9a67(0xf7)](_0xea9a67(0x176)+_0x4ede5c[_0xea9a67(0x108)]+_0xea9a67(0x16b)));}async[a44_0x40cb4a(0x151)](_0x4d78ed){const _0x37fb8c=a44_0x40cb4a,[_0x30bfbb,_0x3b2bd6,_0x3e7090,_0x5f0b27]=await Promise['all']([database_1[_0x37fb8c(0x141)][_0x37fb8c(0x14c)][_0x37fb8c(0x110)]({'where':{'shopId':_0x4d78ed}}),database_1['default'][_0x37fb8c(0x14c)][_0x37fb8c(0x110)]({'where':{'shopId':_0x4d78ed,'status':_0x37fb8c(0x15e)}}),database_1[_0x37fb8c(0x141)][_0x37fb8c(0x155)][_0x37fb8c(0x110)]({'where':{'shopId':_0x4d78ed,'paymentLinkId':{'not':null}}}),database_1[_0x37fb8c(0x141)][_0x37fb8c(0x155)]['findMany']({'where':{'shopId':_0x4d78ed,'paymentLinkId':{'not':null},'status':_0x37fb8c(0x105)},'select':{'amount':!![],'currency':!![]}})]);let _0x1276f5=0x0;for(const _0x42c4f5 of _0x5f0b27){const _0x1901a1=await currencyService_1[_0x37fb8c(0x135)][_0x37fb8c(0xea)](_0x42c4f5[_0x37fb8c(0x166)],_0x42c4f5['currency']);_0x1276f5+=_0x1901a1;}const _0x2136e3=_0x3e7090>0x0?_0x5f0b27[_0x37fb8c(0x123)]/_0x3e7090*0x64:0x0;return{'totalLinks':_0x30bfbb,'activeLinks':_0x3b2bd6,'totalPayments':_0x3e7090,'totalRevenue':Math[_0x37fb8c(0x126)](_0x1276f5*0x64)/0x64,'conversionRate':Math[_0x37fb8c(0x126)](_0x2136e3*0x64)/0x64};}[a44_0x40cb4a(0x14a)](_0x3af6bf){const _0x6971c8=a44_0x40cb4a;return{'id':_0x3af6bf['id'],'shopId':_0x3af6bf[_0x6971c8(0x13c)],'amount':_0x3af6bf[_0x6971c8(0x166)],'currency':_0x3af6bf[_0x6971c8(0x129)],'sourceCurrency':_0x3af6bf['sourceCurrency']||undefined,'gateway':_0x3af6bf[_0x6971c8(0x120)],'maxPayments':_0x3af6bf[_0x6971c8(0x15d)],'currentPayments':_0x3af6bf[_0x6971c8(0x100)],'status':_0x3af6bf[_0x6971c8(0x113)],'expiresAt':_0x3af6bf['expiresAt']||undefined,'successUrl':_0x3af6bf['successUrl']||undefined,'failUrl':_0x3af6bf[_0x6971c8(0x104)]||undefined,'country':_0x3af6bf[_0x6971c8(0x182)]||undefined,'language':_0x3af6bf['language']||undefined,'linkUrl':'https://app.trapay.uk/link/'+_0x3af6bf['id'],'createdAt':_0x3af6bf[_0x6971c8(0x172)],'updatedAt':_0x3af6bf[_0x6971c8(0xf2)],'shop':_0x3af6bf[_0x6971c8(0xfd)],'payments':_0x3af6bf['payments']};}}function a44_0x3dca(){const _0x282c76=['🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/','BASE_URL','1991908cvcIrX','payment','KLYME\x20payment\x20creation\x20is\x20only\x20supported\x20for\x20EU\x20and\x20GB\x20regions,\x20got:\x20','all','toISOString','PlisioService','https://app.trapay.uk/payment/pending','invoice_total_sum','coinToPayService','maxPayments','ACTIVE','Invalid\x20gateway\x20ID:\x20','GBP','findMany','toUpperCase','🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','./gateways/plisioService','\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20','amount','💰\x20Plisio\x20payment\x20link\x20mapping:','FAILED','successUrl','Gateway\x20not\x20found\x20for\x20ID:\x20','\x20completed\x20(reached\x20max\x20payments)','defineProperty','https://tesoft.uk','./gateways/nodaService','/gateway/fail.php?id=','noda','rapydService','createdAt','Payment\x20','KLYME\x20payment\x20links\x20are\x20only\x20supported\x20for\x20EU\x20and\x20GB\x20regions,\x20got:\x20','max','🏁\x20Payment\x20link\x20','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','Invalid\x20KLYME\x20gateway:\x20','generateGatewayUrls','plisio','map','../config/database','no\x20email','payment_url','🔗\x20Rapyd\x20payment\x20URL:\x20','deletePaymentLink','padStart','country','language','name','handleSuccessfulPayment','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','getPublicPaymentLinkData','Payment\x20link\x20is\x20not\x20active','1KTSvFC','amount\x20is\x20required\x20and\x20must\x20be\x20positive','\x20(8digits-8digits\x20format)','https://tesoft.uk/gateways/noda/webhook','toString','978516dBLzSc','\x20(validated\x20for\x20','PLACEHOLDER','👤\x20Customer:\x20','./currencyService','getPaymentLinkById','💳\x20Initiating\x20payment\x20from\x20link\x20','USD','convertToUSDT','createPayment','💾\x20DB\x20Fail\x20URL:\x20','getGatewayNameById','./gateways/coinToPayService','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','\x20(8digits-8digits\x20format\x20for\x20','✅\x20DB\x20Success\x20URL:\x20','updatedAt','update','ceil','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','2893786bVjcRi','log','Anonymous','sourceCurrency','create','generateGatewayOrderId','__esModule','shop','💰\x20Fixed\x20amount:\x20','gateway_payment_id','currentPayments','🔗\x20CoinToPay\x20payment\x20URL:\x20','KlymeService','821000gAJIdr','failUrl','PAID','💰\x20Amount:\x20','random','paymentLinkId','rapyd','nodaService','message','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','🔗\x20KLYME\x20','COMPLETED','qr_code','count','expiresAt','insensitive','status','8683960kSvwei','NodaService','../types/gateway','/gateway/pending.php?id=','✅\x20KLYME\x20','startsWith','findUnique','💾\x20Payment\x20created\x20from\x20link:\x20','plisioService','cointopay','ONCE','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','gateway','findFirst','🔗\x20Noda\x20payment\x20URL:\x20','length','RapydService','PaymentLinkService','round','Gateway\x20error:\x20','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','currency','Shop\x20is\x20not\x20active','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','delete','EUR','❌\x20DB\x20Fail\x20URL:\x20','📈\x20Payment\x20link\x20','getKlymeRegionFromGatewayName','Unsupported\x20KLYME\x20region:\x20','createPaymentLink','./gateways/rapydService','2601120zbBYhI','currencyService','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','🎯\x20Generated\x20gateway\x20order_id:\x20','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','toLowerCase','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','https://app.trapay.uk/payment/','shopId','env','Unknown\x20error','validateKlymeCurrency','💳\x20Creating\x20KLYME\x20','default','Payment\x20link\x20has\x20reached\x20maximum\x20payments','klymeService','initiatePaymentFromLink','https://tesoft.uk/gateway/payment.php?id=','CoinToPayService','isValidGatewayId','🔗\x20Generated\x20URLs\x20for\x20','qr_url','formatPaymentLinkResponse','656882WVdqdT','paymentLink','floor','klyme_','desc','Payment\x20link\x20has\x20expired','getPaymentLinkStatistics'];a44_0x3dca=function(){return _0x282c76;};return a44_0x3dca();}exports[a44_0x40cb4a(0x125)]=PaymentLinkService;