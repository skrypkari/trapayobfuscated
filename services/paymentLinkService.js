'use strict';const a49_0x2086ab=a49_0x16ac;(function(_0x2c828a,_0x2fdbfd){const _0x3f6169=a49_0x16ac,_0x324aad=_0x2c828a();while(!![]){try{const _0x365fa3=parseInt(_0x3f6169(0x29d))/0x1*(parseInt(_0x3f6169(0x21f))/0x2)+-parseInt(_0x3f6169(0x1af))/0x3*(parseInt(_0x3f6169(0x27d))/0x4)+parseInt(_0x3f6169(0x286))/0x5*(parseInt(_0x3f6169(0x1f1))/0x6)+parseInt(_0x3f6169(0x294))/0x7*(parseInt(_0x3f6169(0x28e))/0x8)+-parseInt(_0x3f6169(0x219))/0x9*(parseInt(_0x3f6169(0x1bf))/0xa)+parseInt(_0x3f6169(0x27c))/0xb+-parseInt(_0x3f6169(0x25c))/0xc*(parseInt(_0x3f6169(0x1e6))/0xd);if(_0x365fa3===_0x2fdbfd)break;else _0x324aad['push'](_0x324aad['shift']());}catch(_0x63a5f4){_0x324aad['push'](_0x324aad['shift']());}}}(a49_0x3488,0xc4310));var __importDefault=this&&this[a49_0x2086ab(0x21d)]||function(_0x2bc37a){return _0x2bc37a&&_0x2bc37a['__esModule']?_0x2bc37a:{'default':_0x2bc37a};};function a49_0x16ac(_0xecd640,_0x2311d1){const _0x348887=a49_0x3488();return a49_0x16ac=function(_0x16acd6,_0x296921){_0x16acd6=_0x16acd6-0x1a5;let _0x464eff=_0x348887[_0x16acd6];return _0x464eff;},a49_0x16ac(_0xecd640,_0x2311d1);}Object[a49_0x2086ab(0x1e8)](exports,a49_0x2086ab(0x21e),{'value':!![]}),exports[a49_0x2086ab(0x1df)]=void 0x0;const database_1=__importDefault(require(a49_0x2086ab(0x1c2))),plisioService_1=require(a49_0x2086ab(0x1fd)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a49_0x2086ab(0x1f8)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require(a49_0x2086ab(0x1f2)),coinToPayStatusService_1=require(a49_0x2086ab(0x284)),gateway_1=require(a49_0x2086ab(0x226)),currencyService_1=require(a49_0x2086ab(0x260));function a49_0x3488(){const _0x1e5858=['Error\x20parsing\x20payment\x20gateways:','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','KlymeService','https://app.trapay.uk/test-gateway/payment/','minAmount','Payment\x20link\x20has\x20expired','map','ACTIVE','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','\x22\x20not\x20allowed\x20for\x20shop\x20','\x20->\x20','Shop\x20not\x20found','failUrl','\x20USDT\x20meets\x20minimum\x20requirement\x20of\x20','schedulePaymentChecks','💰\x20Checking\x20amount\x20limits\x20for\x20shop\x20','cointopay','✅\x20Payment\x20link\x20created:\x20','🎯\x20Generated\x20gateway\x20order_id:\x20','toLowerCase','12ablebh','✅\x20Amount\x20','Payment\x20','error','./currencyService','https://app.trapay.uk/payment/success?id=','amount','✅\x20KLYME\x20','https://app.trapay.uk/payment/','Please\x20reduce\x20the\x20amount.','\x20(MasterCard)','KLYME\x20GB','no\x20email','💳\x20Initiating\x20payment\x20from\x20','\x20USDT\x20for\x20gateway\x20','\x20gateway.\x20','🔐\x20Shop\x20','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','create','qr_code','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20','test_gateway','includes','isValidGatewayId','🔗\x20No\x20whiteUrl\x20for\x20','Unknown\x20error','\x20USDT\x20meets\x20maximum\x20requirement\x20of\x20','https://app.trapay.uk/payment/fail?id=','KLYME\x20EU','💱\x20Converted\x20','gateway_payment_id','🧪\x20Creating\x20Test\x20Gateway\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','10320915rWqems','381068GJmAep','count','👤\x20Customer:\x20','/gateway/fail.php?id=','successUrl','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','\x20using\x20default\x20gateways:','./coinToPayStatusService','Gateway\x20\x22','5DwoTNF','Invalid\x20gateway\x20ID:\x20','\x20USDT)\x20exceeds\x20the\x20maximum\x20allowed\x20amount\x20of\x20','shopId','🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','\x20USDT\x20for\x20','💰\x20Gateway\x20','\x20USDT)\x20is\x20below\x20the\x20minimum\x20required\x20amount\x20of\x20','368zWyWEb','🔗\x20Noda\x20payment\x20URL:\x20','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20',',\x20amount:\x20','Noda','142436fdVdhV','MasterCard','💾\x20Payment\x20created:\x20','sourceCurrency','paymentGateways','paymentLinkId','username','\x22\x20is\x20in\x20enabled\x20gateways:','gatewaySettings','1qkuuny','deletePaymentLink','toUpperCase','gateway','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','klymeService','paidAt','status','Payment\x20link\x20has\x20reached\x20maximum\x20payments','&payment_id=','coinToPayService','💾\x20DB\x20Success\x20URL:\x20','amount\x20is\x20required\x20and\x20must\x20be\x20positive','\x20USDT\x20is\x20below\x20minimum\x20','🔗\x20Plisio\x20payment\x20URL:\x20','🔗\x20White\x20URL:\x20','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','startsWith','currency','\x20(Test\x20Gateway)','📈\x20Payment\x20link\x20','formatPaymentLinkResponse','getPublicPaymentLinkData','15ZqqtPW','BASE_URL','single-use','Error\x20parsing\x20gateway\x20settings:','plisioService','🔐\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','getKlymeRegionFromGatewayName','validateKlymeCurrency','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','https://tesoft.uk/gateways/noda/webhook','parse','\x20status\x20is\x20','createdAt','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','convertToUSDT','klyme_','10lfYmNz','mastercard','nodaService','../config/database','ONCE','💰\x20Amount:\x20','EUR','checkGatewayPermission','PlisioService','🔗\x20MasterCard\x20payment\x20URL:\x20','COMPLETED','getGatewayDisplayName','FAILED','pendingUrl',',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','all','\x20payment\x20link','temp','\x20(Plisio\x20or\x20KLYME)','💰\x20Checking\x20amount\x20limits\x20for\x20gateway:\x20','Shop\x20is\x20not\x20active','Test\x20Gateway','createPaymentLink','round','📈\x20Payment\x20','🔗\x20KLYME\x20','initiatePaymentFromLink','\x20minimum\x20amount:\x20','type','shop','MAX_SAFE_INTEGER','createPayment','PaymentLinkService','🔗\x20Generated\x20URLs\x20for\x20','payments','\x20maximum\x20amount:\x20','SINGLE','paymentLink','rapydService','11591593jQBfCP','ceil','defineProperty','\x20(8digits-8digits\x20format)','maxAmount','\x20completed\x20(','$transaction','Enabled\x20gateways:\x20','\x20gateway\x20settings:','RapydService','random','5978070vDqhvY','./gateways/klymeService','\x20\x20\x20💾\x20DB\x20Pending\x20URL:\x20','toFixed','log','Unsupported\x20KLYME\x20region:\x20','💾\x20DB\x20Pending\x20URL:\x20','./gateways/nodaService','generateGatewayOrderId','Plisio','🧪\x20Test\x20Gateway\x20form\x20URL:\x20','Unsupported\x20gateway:\x20','./gateways/plisioService','country','Payment\x20amount\x20','rapyd','\x20USDT\x20for\x20limit\x20checking','Anonymous','\x20(validated\x20for\x20','NodaService','update','invoice_total_sum','currencyService','default','findFirst','🏁\x20Payment\x20link\x20','\x20USDT','USD','expiresAt','🔗\x20Rapyd\x20payment\x20URL:\x20','🔗\x20Test\x20Gateway\x20payment\x20URL:\x20','🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','/gateway/pending.php?id=','insensitive','❌\x20Amount\x20','/gateway/success.php?id=','CoinToPayService','\x20payments)','14323014GgONRm','payment','checkAmountLimits','💳\x20Creating\x20MasterCard\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','__importDefault','__esModule','1784848nXVHIk','CoinToPay','getGatewayNameById','🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','Invalid\x20KLYME\x20gateway:\x20','noda','none','../types/gateway','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','qr_url','getPaymentLinkStatistics','qr_code_url',',\x20gateway\x20','PAID','https://tesoft.uk/gateway/payment.php?id=','Payment\x20link\x20not\x20found','📝\x20Note:\x20Success/Fail/Pending\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created','Rapyd','findUnique','\x20\x20\x20🔗\x20White\x20URL:\x20','\x20payments),\x20skipping\x20increment','findMany','Payment\x20link\x20','💳\x20Creating\x20KLYME\x20','payment_url','Gateway\x20not\x20found\x20for\x20ID:\x20','💰\x20Fixed\x20amount:\x20','multi-use','desc',')\x20counter\x20updated:\x20','padStart','generateGatewayUrls','🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','currentPayments','language','\x20already\x20used\x20(','getPaymentLinkById','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','getPaymentLinks','\x22\x20is\x20allowed\x20for\x20shop\x20','📈\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20'];a49_0x3488=function(){return _0x1e5858;};return a49_0x3488();}class PaymentLinkService{constructor(){const _0x1d2c3a=a49_0x2086ab;this[_0x1d2c3a(0x1b3)]=new plisioService_1[(_0x1d2c3a(0x1c7))](),this[_0x1d2c3a(0x1e5)]=new rapydService_1[(_0x1d2c3a(0x1ef))](),this[_0x1d2c3a(0x1c1)]=new nodaService_1[(_0x1d2c3a(0x204))](),this[_0x1d2c3a(0x2a7)]=new coinToPayService_1[(_0x1d2c3a(0x217))](),this[_0x1d2c3a(0x2a2)]=new klymeService_1[(_0x1d2c3a(0x24a))]();}[a49_0x2086ab(0x1f9)](){const _0x3225c7=()=>{const _0x253173=a49_0x16ac;return Math['floor'](Math[_0x253173(0x1f0)]()*0x5f5e100)['toString']()[_0x253173(0x23d)](0x8,'0');};return _0x3225c7()+'-'+_0x3225c7();}['generateGatewayUrls'](_0x7cff5a,_0x2b7789,_0x3496ae,_0x150632,_0x4b64bf,_0x4fd70c,_0x4c4c7b){const _0x8cda53=a49_0x2086ab;if(_0x4b64bf&&_0x4fd70c&&_0x4c4c7b)return{'finalSuccessUrl':_0x4b64bf,'finalFailUrl':_0x4fd70c,'finalPendingUrl':_0x4c4c7b,'dbSuccessUrl':_0x4b64bf,'dbFailUrl':_0x4fd70c,'dbPendingUrl':_0x4c4c7b,'whiteUrl':null};const _0x4d5a83=_0x4b64bf||_0x8cda53(0x261)+_0x2b7789+'&payment_id='+_0x3496ae,_0x394f82=_0x4fd70c||_0x8cda53(0x277)+_0x2b7789+_0x8cda53(0x2a6)+_0x3496ae,_0x457b37=_0x4c4c7b||'https://app.trapay.uk/payment/pending?id='+_0x2b7789+'&payment_id='+_0x3496ae;let _0x818859,_0x47b72b,_0x2cb54c;_0x7cff5a==='noda'||_0x7cff5a[_0x8cda53(0x1a9)]('klyme_')||_0x7cff5a===_0x8cda53(0x258)?(_0x818859=_0x150632+'/gateway/pending.php?id='+_0x2b7789,_0x2cb54c=_0x150632+_0x8cda53(0x213)+_0x2b7789):(_0x818859=_0x150632+_0x8cda53(0x216)+_0x2b7789,_0x2cb54c=_0x150632+_0x8cda53(0x213)+_0x2b7789);_0x47b72b=_0x150632+_0x8cda53(0x280)+_0x2b7789;let _0x1611b1=null;return _0x7cff5a!=='plisio'&&!_0x7cff5a[_0x8cda53(0x1a9)](_0x8cda53(0x1be))?(_0x1611b1=_0x8cda53(0x22d)+_0x2b7789,console[_0x8cda53(0x1f5)]('🔗\x20Generated\x20whiteUrl\x20for\x20'+_0x7cff5a+':\x20'+_0x1611b1)):console[_0x8cda53(0x1f5)](_0x8cda53(0x274)+_0x7cff5a+_0x8cda53(0x1d1)),console[_0x8cda53(0x1f5)](_0x8cda53(0x1e0)+_0x7cff5a+'\x20with\x20payment\x20ID\x20'+_0x2b7789+':'),console[_0x8cda53(0x1f5)](_0x8cda53(0x26d)+_0x818859),console['log']('\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20'+_0x47b72b),console[_0x8cda53(0x1f5)]('\x20\x20\x20🌐\x20Gateway\x20Pending\x20URL:\x20'+_0x2cb54c),console['log'](_0x8cda53(0x250)+_0x4d5a83),console['log']('\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20'+_0x394f82),console[_0x8cda53(0x1f5)](_0x8cda53(0x1f3)+_0x457b37),console[_0x8cda53(0x1f5)](_0x8cda53(0x232)+(_0x1611b1||_0x8cda53(0x225))),{'finalSuccessUrl':_0x818859,'finalFailUrl':_0x47b72b,'finalPendingUrl':_0x2cb54c,'dbSuccessUrl':_0x4d5a83,'dbFailUrl':_0x394f82,'dbPendingUrl':_0x457b37,'whiteUrl':_0x1611b1};}[a49_0x2086ab(0x1b6)](_0x5c3b66,_0x586d60){const _0x3ce2d8=a49_0x2086ab;if(!_0x5c3b66['startsWith'](_0x3ce2d8(0x1be)))return;const _0x303345=(0x0,gateway_1[_0x3ce2d8(0x1b5)])(_0x5c3b66),_0x3ab648=_0x586d60[_0x3ce2d8(0x29f)]();switch(_0x303345){case'EU':if(_0x3ab648!==_0x3ce2d8(0x1c5))throw new Error(_0x3ce2d8(0x1bc)+_0x3ab648);break;case'GB':if(_0x3ab648!=='GBP')throw new Error(_0x3ce2d8(0x2a1)+_0x3ab648);break;case'DE':if(_0x3ab648!==_0x3ce2d8(0x1c5))throw new Error(_0x3ce2d8(0x1b7)+_0x3ab648);break;default:throw new Error(_0x3ce2d8(0x1f6)+_0x303345);}}async['checkAmountLimits'](_0x43b05e,_0x3ee15a,_0x271cd1,_0x1781b2){const _0xd44033=a49_0x2086ab;console[_0xd44033(0x1f5)](_0xd44033(0x257)+_0x43b05e+_0xd44033(0x22b)+_0x3ee15a+_0xd44033(0x292)+_0x271cd1+'\x20'+_0x1781b2);const _0x2b6888=await currencyService_1[_0xd44033(0x207)][_0xd44033(0x1bd)](_0x271cd1,_0x1781b2);console[_0xd44033(0x1f5)](_0xd44033(0x279)+_0x271cd1+'\x20'+_0x1781b2+'\x20to\x20'+_0x2b6888['toFixed'](0x6)+_0xd44033(0x201));const _0xc97940=await database_1[_0xd44033(0x208)][_0xd44033(0x1dc)]['findUnique']({'where':{'id':_0x43b05e},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0xc97940)throw new Error(_0xd44033(0x253));let _0x5e03bf={};if(_0xc97940[_0xd44033(0x29c)])try{_0x5e03bf=JSON[_0xd44033(0x1b9)](_0xc97940[_0xd44033(0x29c)]),console['log']('💰\x20Shop\x20'+_0xc97940[_0xd44033(0x29a)]+_0xd44033(0x1ee),_0x5e03bf);}catch(_0x317f94){console[_0xd44033(0x25f)](_0xd44033(0x1b2),_0x317f94),_0x5e03bf={};}const _0x369e09=this[_0xd44033(0x1ca)](_0x3ee15a);console[_0xd44033(0x1f5)](_0xd44033(0x1d2)+_0x3ee15a+_0xd44033(0x252)+_0x369e09);const _0x50e45d=_0x5e03bf[_0x369e09];if(_0x50e45d&&_0x50e45d['minAmount']!==undefined){const _0x19952d=_0x50e45d[_0xd44033(0x24c)];console[_0xd44033(0x1f5)]('💰\x20Gateway\x20'+_0x369e09+_0xd44033(0x1da)+_0x19952d+_0xd44033(0x20b));if(_0x2b6888<_0x19952d){console['error'](_0xd44033(0x215)+_0x2b6888[_0xd44033(0x1f4)](0x6)+_0xd44033(0x1a5)+_0x19952d+_0xd44033(0x26a)+_0x369e09);throw new Error(_0xd44033(0x1ff)+_0x271cd1+'\x20'+_0x1781b2+'\x20('+_0x2b6888[_0xd44033(0x1f4)](0x2)+_0xd44033(0x28d)+_0x19952d+_0xd44033(0x28b)+_0x369e09+_0xd44033(0x26b)+'Please\x20increase\x20the\x20amount.');}console[_0xd44033(0x1f5)]('✅\x20Amount\x20'+_0x2b6888[_0xd44033(0x1f4)](0x6)+_0xd44033(0x255)+_0x19952d+_0xd44033(0x26a)+_0x369e09);}else console[_0xd44033(0x1f5)]('💰\x20No\x20minimum\x20amount\x20set\x20for\x20gateway\x20'+_0x369e09);if(_0x50e45d&&_0x50e45d[_0xd44033(0x1ea)]!==undefined){const _0x41b0da=_0x50e45d['maxAmount'];console[_0xd44033(0x1f5)](_0xd44033(0x28c)+_0x369e09+_0xd44033(0x1e2)+_0x41b0da+_0xd44033(0x20b));if(_0x2b6888>_0x41b0da){console[_0xd44033(0x25f)](_0xd44033(0x215)+_0x2b6888['toFixed'](0x6)+'\x20USDT\x20exceeds\x20maximum\x20'+_0x41b0da+'\x20USDT\x20for\x20gateway\x20'+_0x369e09);throw new Error(_0xd44033(0x1ff)+_0x271cd1+'\x20'+_0x1781b2+'\x20('+_0x2b6888[_0xd44033(0x1f4)](0x2)+_0xd44033(0x288)+_0x41b0da+'\x20USDT\x20for\x20'+_0x369e09+_0xd44033(0x26b)+_0xd44033(0x265));}console[_0xd44033(0x1f5)](_0xd44033(0x25d)+_0x2b6888[_0xd44033(0x1f4)](0x6)+_0xd44033(0x276)+_0x41b0da+_0xd44033(0x26a)+_0x369e09);}else console[_0xd44033(0x1f5)]('💰\x20No\x20maximum\x20amount\x20set\x20for\x20gateway\x20'+_0x369e09);}async[a49_0x2086ab(0x1c6)](_0x3f51a6,_0x2facb1){const _0x196e98=a49_0x2086ab;console['log'](_0x196e98(0x1b4)+_0x3f51a6+':\x20'+_0x2facb1);const _0x2d880b=await database_1[_0x196e98(0x208)][_0x196e98(0x1dc)][_0x196e98(0x231)]({'where':{'id':_0x3f51a6},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x2d880b)throw new Error(_0x196e98(0x253));let _0x457d0d=[];if(_0x2d880b['paymentGateways'])try{_0x457d0d=JSON[_0x196e98(0x1b9)](_0x2d880b[_0x196e98(0x298)]),console[_0x196e98(0x1f5)]('🔐\x20Shop\x20'+_0x2d880b[_0x196e98(0x29a)]+'\x20enabled\x20gateways:',_0x457d0d);}catch(_0x397134){console['error'](_0x196e98(0x248),_0x397134),_0x457d0d=[_0x196e98(0x1fa)];}else _0x457d0d=[_0x196e98(0x1fa)],console[_0x196e98(0x1f5)](_0x196e98(0x26c)+_0x2d880b[_0x196e98(0x29a)]+_0x196e98(0x283),_0x457d0d);const _0x4cb62d=this['getGatewayDisplayName'](_0x2facb1);console['log']('🔐\x20Checking\x20if\x20\x22'+_0x4cb62d+_0x196e98(0x29b),_0x457d0d);if(!_0x457d0d[_0x196e98(0x272)](_0x4cb62d)){console[_0x196e98(0x25f)]('❌\x20Gateway\x20\x22'+_0x4cb62d+_0x196e98(0x251)+_0x2d880b[_0x196e98(0x29a)]),console['error']('❌\x20Enabled\x20gateways:\x20'+_0x457d0d['join'](',\x20'));throw new Error(_0x196e98(0x285)+_0x4cb62d+_0x196e98(0x244)+(_0x196e98(0x1ed)+_0x457d0d['join'](',\x20')+'.\x20')+'Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.');}console[_0x196e98(0x1f5)]('✅\x20Gateway\x20\x22'+_0x4cb62d+_0x196e98(0x246)+_0x2d880b[_0x196e98(0x29a)]);}['getGatewayDisplayName'](_0x2f4409){const _0x1f51ca=a49_0x2086ab,_0x52f1cd={'test_gateway':_0x1f51ca(0x1d4),'plisio':_0x1f51ca(0x1fa),'rapyd':_0x1f51ca(0x230),'noda':_0x1f51ca(0x293),'cointopay':_0x1f51ca(0x220),'klyme_eu':_0x1f51ca(0x278),'klyme_gb':_0x1f51ca(0x267),'klyme_de':'KLYME\x20DE','mastercard':_0x1f51ca(0x295)};return _0x52f1cd[_0x2f4409]||_0x2f4409;}async['createPaymentLink'](_0x1df0a9,_0x27400c){const _0x5f4fa8=a49_0x2086ab;if(!(0x0,gateway_1[_0x5f4fa8(0x273)])(_0x27400c[_0x5f4fa8(0x2a0)]))throw new Error(_0x5f4fa8(0x287)+_0x27400c[_0x5f4fa8(0x2a0)]+'.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)');const _0x5bfd05=(0x0,gateway_1[_0x5f4fa8(0x221)])(_0x27400c[_0x5f4fa8(0x2a0)]);if(!_0x5bfd05)throw new Error(_0x5f4fa8(0x238)+_0x27400c[_0x5f4fa8(0x2a0)]);console[_0x5f4fa8(0x1f5)](_0x5f4fa8(0x222)+_0x5bfd05),await this[_0x5f4fa8(0x1c6)](_0x1df0a9,_0x5bfd05);if(_0x5bfd05==='plisio'&&!_0x27400c[_0x5f4fa8(0x297)])throw new Error(_0x5f4fa8(0x290));if(_0x5bfd05[_0x5f4fa8(0x1a9)](_0x5f4fa8(0x1be))){const _0x62ef7f=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x5bfd05);console['log'](_0x5f4fa8(0x236)+_0x62ef7f+_0x5f4fa8(0x1cf));}let _0x5829ab=_0x27400c[_0x5f4fa8(0x1fe)];_0x5bfd05===_0x5f4fa8(0x200)&&(_0x5829ab='GB',console['log']('🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link'));if(!_0x27400c[_0x5f4fa8(0x262)]||_0x27400c[_0x5f4fa8(0x262)]<=0x0)throw new Error(_0x5f4fa8(0x2a9));let _0x5f3031=_0x27400c[_0x5f4fa8(0x1aa)]||_0x5f4fa8(0x20c);_0x5bfd05===_0x5f4fa8(0x258)&&(_0x5f3031='EUR',console[_0x5f4fa8(0x1f5)](_0x5f4fa8(0x28a)));this[_0x5f4fa8(0x1b6)](_0x5bfd05,_0x5f3031),await this['checkAmountLimits'](_0x1df0a9,_0x5bfd05,_0x27400c[_0x5f4fa8(0x262)],_0x5f3031);const _0x59eeab=_0x27400c['type']||'SINGLE';console[_0x5f4fa8(0x1f5)]('🔗\x20Creating\x20'+_0x59eeab+_0x5f4fa8(0x1cf));const _0x291640=await database_1[_0x5f4fa8(0x208)][_0x5f4fa8(0x1e4)][_0x5f4fa8(0x26e)]({'data':{'shopId':_0x1df0a9,'amount':_0x27400c['amount'],'currency':_0x5f3031,'sourceCurrency':_0x27400c[_0x5f4fa8(0x297)]||undefined,'gateway':_0x5bfd05,'type':_0x59eeab,'currentPayments':0x0,'status':_0x5f4fa8(0x24f),'expiresAt':_0x27400c['expiresAt']?new Date(_0x27400c[_0x5f4fa8(0x20d)]):undefined,'successUrl':_0x27400c['successUrl']||null,'failUrl':_0x27400c[_0x5f4fa8(0x254)]||null,'pendingUrl':_0x27400c[_0x5f4fa8(0x1cc)]||null,'country':_0x5829ab,'language':_0x27400c[_0x5f4fa8(0x241)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x5f4fa8(0x1f5)](_0x5f4fa8(0x259)+_0x291640['id']+'\x20('+_0x5bfd05+')'),console[_0x5f4fa8(0x1f5)](_0x5f4fa8(0x239)+_0x291640[_0x5f4fa8(0x262)]+'\x20'+_0x291640[_0x5f4fa8(0x1aa)]),console[_0x5f4fa8(0x1f5)]('🔗\x20Link\x20type:\x20'+_0x291640['type']),console['log']('🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/'+_0x291640['id']),console[_0x5f4fa8(0x1f5)](_0x5f4fa8(0x22f)),this['formatPaymentLinkResponse'](_0x291640);}async[a49_0x2086ab(0x245)](_0x4a7263,_0x1f6616){const _0x21c8aa=a49_0x2086ab,{page:_0x26df7b,limit:_0x2515aa,status:_0x24e3f8,gateway:_0x5ed413,search:_0x5b5360}=_0x1f6616,_0x541720=(_0x26df7b-0x1)*_0x2515aa,_0x29657e={'shopId':_0x4a7263};_0x24e3f8&&(_0x29657e[_0x21c8aa(0x2a4)]=_0x24e3f8[_0x21c8aa(0x29f)]());if(_0x5ed413){if((0x0,gateway_1[_0x21c8aa(0x273)])(_0x5ed413)){const _0x16f3bb=(0x0,gateway_1['getGatewayNameById'])(_0x5ed413);_0x16f3bb&&(_0x29657e['gateway']=_0x16f3bb);}else _0x29657e[_0x21c8aa(0x2a0)]=_0x5ed413['toLowerCase']();}_0x5b5360&&(_0x29657e['OR']=[{'gateway':{'contains':_0x5b5360,'mode':'insensitive'}},{'currency':{'contains':_0x5b5360,'mode':_0x21c8aa(0x214)}}]);const [_0x12f2bc,_0x25a12f]=await Promise[_0x21c8aa(0x1ce)]([database_1[_0x21c8aa(0x208)][_0x21c8aa(0x1e4)][_0x21c8aa(0x234)]({'where':_0x29657e,'skip':_0x541720,'take':_0x2515aa,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}}),database_1[_0x21c8aa(0x208)]['paymentLink'][_0x21c8aa(0x27e)]({'where':_0x29657e})]);return{'links':_0x12f2bc[_0x21c8aa(0x24e)](_0x4549c7=>this[_0x21c8aa(0x1ad)](_0x4549c7)),'pagination':{'page':_0x26df7b,'limit':_0x2515aa,'total':_0x25a12f,'totalPages':Math[_0x21c8aa(0x1e7)](_0x25a12f/_0x2515aa)}};}async[a49_0x2086ab(0x243)](_0x2fa0ed,_0x31a78){const _0x3b0615=a49_0x2086ab,_0x5b8dd6=await database_1[_0x3b0615(0x208)][_0x3b0615(0x1e4)][_0x3b0615(0x209)]({'where':{'id':_0x31a78,'shopId':_0x2fa0ed},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x3b0615(0x23b)}}}});if(!_0x5b8dd6)return null;return this[_0x3b0615(0x1ad)](_0x5b8dd6);}async['updatePaymentLink'](_0x4d0e66,_0x5770f7,_0x45193e){const _0x461cf3=a49_0x2086ab,_0x5d467a={..._0x45193e};if(_0x45193e[_0x461cf3(0x2a0)]){if((0x0,gateway_1[_0x461cf3(0x273)])(_0x45193e[_0x461cf3(0x2a0)])){const _0x9414fa=(0x0,gateway_1[_0x461cf3(0x221)])(_0x45193e[_0x461cf3(0x2a0)]);_0x9414fa&&(await this[_0x461cf3(0x1c6)](_0x4d0e66,_0x9414fa),_0x5d467a['gateway']=_0x9414fa);}else _0x5d467a[_0x461cf3(0x2a0)]=_0x45193e['gateway'][_0x461cf3(0x25b)]();}(_0x5d467a[_0x461cf3(0x2a0)]===_0x461cf3(0x200)||_0x45193e[_0x461cf3(0x1fe)]&&_0x5d467a[_0x461cf3(0x2a0)]!=='rapyd')&&(_0x5d467a[_0x461cf3(0x2a0)]===_0x461cf3(0x200)&&(_0x5d467a['country']='GB',console['log'](_0x461cf3(0x210))));_0x5d467a[_0x461cf3(0x2a0)]===_0x461cf3(0x258)&&(_0x5d467a[_0x461cf3(0x1aa)]=_0x461cf3(0x1c5),console[_0x461cf3(0x1f5)](_0x461cf3(0x1a8)));_0x5d467a['gateway']&&_0x5d467a[_0x461cf3(0x1aa)]&&this[_0x461cf3(0x1b6)](_0x5d467a['gateway'],_0x5d467a[_0x461cf3(0x1aa)]);if(_0x45193e['amount']&&_0x5d467a[_0x461cf3(0x2a0)]){const _0x2ee78c=_0x45193e[_0x461cf3(0x1aa)]||_0x461cf3(0x20c);await this[_0x461cf3(0x21b)](_0x4d0e66,_0x5d467a[_0x461cf3(0x2a0)],_0x45193e[_0x461cf3(0x262)],_0x2ee78c);}_0x45193e[_0x461cf3(0x20d)]&&(_0x5d467a['expiresAt']=new Date(_0x45193e[_0x461cf3(0x20d)]));const _0x5be3d4=await database_1[_0x461cf3(0x208)][_0x461cf3(0x1e4)][_0x461cf3(0x205)]({'where':{'id':_0x5770f7,'shopId':_0x4d0e66},'data':_0x5d467a,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x461cf3(0x23b)},'take':0xa}}});return this[_0x461cf3(0x1ad)](_0x5be3d4);}async[a49_0x2086ab(0x29e)](_0x461cc3,_0x39992){const _0x4a9aaf=a49_0x2086ab;await database_1['default'][_0x4a9aaf(0x1e4)]['delete']({'where':{'id':_0x39992,'shopId':_0x461cc3}});}async[a49_0x2086ab(0x1ae)](_0x45e89a){const _0x2fc601=a49_0x2086ab,_0xa263cc=await database_1[_0x2fc601(0x208)][_0x2fc601(0x1e4)][_0x2fc601(0x231)]({'where':{'id':_0x45e89a},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0xa263cc)return null;const _0x4c3d89=_0xa263cc['expiresAt']&&_0xa263cc[_0x2fc601(0x20d)]<new Date(),_0x5b0ffd=_0xa263cc[_0x2fc601(0x1db)]==='SINGLE'?_0xa263cc[_0x2fc601(0x240)]>=0x1:![],_0x16cbb6=_0xa263cc[_0x2fc601(0x1dc)]['status']===_0x2fc601(0x24f),_0x58d99a=_0xa263cc[_0x2fc601(0x2a4)]===_0x2fc601(0x24f),_0x29ab8a=!_0x4c3d89&&!_0x5b0ffd&&_0x16cbb6&&_0x58d99a,_0xd4258a=_0xa263cc[_0x2fc601(0x1db)]==='SINGLE'?_0xa263cc[_0x2fc601(0x240)]>=0x1?0x0:0x1:Number[_0x2fc601(0x1dd)];return{'id':_0xa263cc['id'],'amount':_0xa263cc[_0x2fc601(0x262)],'currency':_0xa263cc[_0x2fc601(0x1aa)],'sourceCurrency':_0xa263cc[_0x2fc601(0x297)]||undefined,'gateway':_0xa263cc[_0x2fc601(0x2a0)],'type':_0xa263cc[_0x2fc601(0x1db)],'currentPayments':_0xa263cc[_0x2fc601(0x240)],'status':_0xa263cc['status'],'expiresAt':_0xa263cc[_0x2fc601(0x20d)]||undefined,'shopName':_0xa263cc[_0x2fc601(0x1dc)]['name'],'isAvailable':_0x29ab8a,'remainingPayments':_0xd4258a};}async[a49_0x2086ab(0x1d9)](_0x3b0c15){const _0x58b8d5=a49_0x2086ab,{linkId:_0x3f3b86,customerEmail:_0xa59462,customerName:_0x1488f8}=_0x3b0c15,_0x270330=await database_1[_0x58b8d5(0x208)][_0x58b8d5(0x1e4)][_0x58b8d5(0x231)]({'where':{'id':_0x3f3b86},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x270330)throw new Error(_0x58b8d5(0x22e));const _0x1ea1b8=_0x270330[_0x58b8d5(0x20d)]&&_0x270330[_0x58b8d5(0x20d)]<new Date(),_0x5c8acb=_0x270330[_0x58b8d5(0x1db)]===_0x58b8d5(0x1e3)?_0x270330['currentPayments']>=0x1:![],_0x162ac1=_0x270330[_0x58b8d5(0x1dc)]['status']===_0x58b8d5(0x24f),_0x40d085=_0x270330[_0x58b8d5(0x2a4)]===_0x58b8d5(0x24f);if(_0x1ea1b8)throw new Error(_0x58b8d5(0x24d));if(_0x5c8acb){const _0x33c422=_0x270330[_0x58b8d5(0x1db)]==='SINGLE'?'This\x20single-use\x20payment\x20link\x20has\x20already\x20been\x20used':_0x58b8d5(0x2a5);throw new Error(_0x33c422);}if(!_0x162ac1)throw new Error(_0x58b8d5(0x1d3));if(!_0x40d085)throw new Error('Payment\x20link\x20is\x20not\x20active');await this['checkGatewayPermission'](_0x270330[_0x58b8d5(0x289)],_0x270330[_0x58b8d5(0x2a0)]);const _0x23a1a2=_0x270330[_0x58b8d5(0x262)];console['log'](_0x58b8d5(0x269)+_0x270330[_0x58b8d5(0x1db)]+'\x20link\x20'+_0x3f3b86+':\x20'+_0x23a1a2+'\x20'+_0x270330[_0x58b8d5(0x1aa)]),console['log'](_0x58b8d5(0x27f)+(_0x1488f8||_0x58b8d5(0x202))+'\x20('+(_0xa59462||_0x58b8d5(0x268))+')'),this[_0x58b8d5(0x1b6)](_0x270330[_0x58b8d5(0x2a0)],_0x270330[_0x58b8d5(0x1aa)]),await this[_0x58b8d5(0x21b)](_0x270330[_0x58b8d5(0x289)],_0x270330[_0x58b8d5(0x2a0)],_0x23a1a2,_0x270330[_0x58b8d5(0x1aa)]);const _0x9600ac=this[_0x58b8d5(0x1f9)]();console[_0x58b8d5(0x1f5)](_0x58b8d5(0x25a)+_0x9600ac+'\x20(8digits-8digits\x20format\x20for\x20'+_0x270330['gateway']+')');const _0x2bb3a9=await database_1[_0x58b8d5(0x208)][_0x58b8d5(0x21a)][_0x58b8d5(0x26e)]({'data':{'shopId':_0x270330['shopId'],'paymentLinkId':_0x270330['id'],'gateway':_0x270330[_0x58b8d5(0x2a0)],'amount':_0x23a1a2,'currency':_0x270330[_0x58b8d5(0x1aa)],'sourceCurrency':_0x270330[_0x58b8d5(0x297)]||undefined,'usage':_0x58b8d5(0x1c3),'expiresAt':_0x270330['expiresAt']||undefined,'successUrl':_0x58b8d5(0x1d0),'failUrl':'temp','pendingUrl':_0x58b8d5(0x1d0),'whiteUrl':_0x58b8d5(0x1d0),'status':'PENDING','orderId':null,'gatewayOrderId':_0x9600ac,'customerEmail':_0xa59462||undefined,'customerName':_0x1488f8||undefined,'country':_0x270330[_0x58b8d5(0x1fe)]||undefined,'language':_0x270330[_0x58b8d5(0x241)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x58b8d5(0x1f5)](_0x58b8d5(0x296)+_0x2bb3a9['id']);const _0x1d8f83=process['env'][_0x58b8d5(0x1b0)]||'https://tesoft.uk',{finalSuccessUrl:_0x5b4644,finalFailUrl:_0x1a5648,finalPendingUrl:_0x17a649,dbSuccessUrl:_0x5a77a9,dbFailUrl:_0x36755e,dbPendingUrl:_0x5c0205,whiteUrl:_0x1e7983}=this[_0x58b8d5(0x23e)](_0x270330[_0x58b8d5(0x2a0)],_0x2bb3a9['id'],_0x9600ac,_0x1d8f83,_0x270330[_0x58b8d5(0x281)]||undefined,_0x270330[_0x58b8d5(0x254)]||undefined,_0x270330[_0x58b8d5(0x1cc)]||undefined);await database_1[_0x58b8d5(0x208)][_0x58b8d5(0x21a)][_0x58b8d5(0x205)]({'where':{'id':_0x2bb3a9['id']},'data':{'successUrl':_0x5a77a9,'failUrl':_0x36755e,'pendingUrl':_0x5c0205,'whiteUrl':_0x1e7983}}),console[_0x58b8d5(0x1f5)]('💰\x20Amount:\x20'+_0x23a1a2+'\x20'+_0x270330['currency']),console[_0x58b8d5(0x1f5)](_0x58b8d5(0x27f)+(_0x1488f8||_0x58b8d5(0x202))+'\x20('+(_0xa59462||'no\x20email')+')'),console[_0x58b8d5(0x1f5)](_0x58b8d5(0x2a8)+_0x5a77a9),console[_0x58b8d5(0x1f5)]('💾\x20DB\x20Fail\x20URL:\x20'+_0x36755e),console[_0x58b8d5(0x1f5)](_0x58b8d5(0x1f7)+_0x5c0205),console[_0x58b8d5(0x1f5)](_0x58b8d5(0x1a7)+(_0x1e7983||_0x58b8d5(0x225)));let _0x398a2a,_0x2aa8cc;try{if(_0x270330[_0x58b8d5(0x2a0)]==='plisio'){console[_0x58b8d5(0x1f5)]('💰\x20Plisio\x20payment\x20link\x20mapping:'),console[_0x58b8d5(0x1f5)]('\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20'+_0x270330[_0x58b8d5(0x1aa)]),console['log'](_0x58b8d5(0x291)+_0x270330['sourceCurrency']);const _0x2b62ad=await this[_0x58b8d5(0x1b3)][_0x58b8d5(0x1de)]({'paymentId':_0x2bb3a9['id'],'orderId':_0x9600ac,'amount':_0x23a1a2,'currency':_0x270330[_0x58b8d5(0x1aa)],'productName':'Payment\x20'+_0x23a1a2+'\x20'+_0x270330['currency'],'description':'Payment\x20'+_0x23a1a2+'\x20'+_0x270330[_0x58b8d5(0x1aa)],'successUrl':_0x5b4644,'failUrl':_0x1a5648,'customerEmail':_0xa59462||undefined,'customerName':_0x1488f8||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x270330[_0x58b8d5(0x297)]||undefined});_0x398a2a=_0x2b62ad[_0x58b8d5(0x27a)],_0x2aa8cc=_0x2b62ad['payment_url'],await database_1['default']['payment'][_0x58b8d5(0x205)]({'where':{'id':_0x2bb3a9['id']},'data':{'externalPaymentUrl':_0x2aa8cc,'gatewayPaymentId':_0x398a2a,'invoiceTotalSum':Number(_0x2b62ad[_0x58b8d5(0x206)]),'qrCode':_0x2b62ad[_0x58b8d5(0x26f)],'qrUrl':_0x2b62ad[_0x58b8d5(0x228)]}});const _0x5ee33e=_0x58b8d5(0x264)+_0x2bb3a9['id'];return console[_0x58b8d5(0x1f5)](_0x58b8d5(0x1a6)+_0x5ee33e),{'paymentId':_0x2bb3a9['id'],'paymentUrl':_0x5ee33e,'expiresAt':_0x2bb3a9[_0x58b8d5(0x20d)]||undefined};}else{if(_0x270330[_0x58b8d5(0x2a0)]===_0x58b8d5(0x200)){const _0x3230ac=await this[_0x58b8d5(0x1e5)][_0x58b8d5(0x1d5)]({'paymentId':_0x2bb3a9['id'],'orderId':_0x9600ac,'orderName':_0x58b8d5(0x25e)+_0x23a1a2+'\x20'+_0x270330['currency'],'amount':_0x23a1a2,'currency':_0x270330[_0x58b8d5(0x1aa)],'country':_0x270330[_0x58b8d5(0x1fe)],'language':_0x270330[_0x58b8d5(0x241)]||'EN','amountIsEditable':![],'usage':_0x58b8d5(0x1c3),'maxPayments':0x1,'successUrl':_0x5b4644,'failUrl':_0x1a5648});_0x398a2a=_0x3230ac[_0x58b8d5(0x27a)],_0x2aa8cc=_0x3230ac['payment_url'],await database_1[_0x58b8d5(0x208)][_0x58b8d5(0x21a)][_0x58b8d5(0x205)]({'where':{'id':_0x2bb3a9['id']},'data':{'externalPaymentUrl':_0x2aa8cc,'gatewayPaymentId':_0x398a2a}});const _0x156bfa=_0x58b8d5(0x264)+_0x2bb3a9['id'];return console[_0x58b8d5(0x1f5)](_0x58b8d5(0x20e)+_0x156bfa),{'paymentId':_0x2bb3a9['id'],'paymentUrl':_0x156bfa,'expiresAt':_0x2bb3a9['expiresAt']||undefined};}else{if(_0x270330[_0x58b8d5(0x2a0)]===_0x58b8d5(0x224)){const _0x2100bc=await this[_0x58b8d5(0x1c1)][_0x58b8d5(0x1d5)]({'paymentId':_0x2bb3a9['id'],'orderId':_0x9600ac,'name':'Payment\x20'+_0x23a1a2+'\x20'+_0x270330[_0x58b8d5(0x1aa)],'paymentDescription':_0x58b8d5(0x25e)+_0x23a1a2+'\x20'+_0x270330[_0x58b8d5(0x1aa)],'amount':_0x23a1a2,'currency':_0x270330[_0x58b8d5(0x1aa)],'webhookUrl':_0x58b8d5(0x1b8),'returnUrl':_0x17a649,'expiryDate':_0x270330[_0x58b8d5(0x20d)]?.['toISOString']()});_0x398a2a=_0x2100bc['gateway_payment_id'],_0x2aa8cc=_0x2100bc[_0x58b8d5(0x237)],await database_1[_0x58b8d5(0x208)][_0x58b8d5(0x21a)][_0x58b8d5(0x205)]({'where':{'id':_0x2bb3a9['id']},'data':{'externalPaymentUrl':_0x2aa8cc,'gatewayPaymentId':_0x398a2a,'qrUrl':_0x2100bc[_0x58b8d5(0x22a)]}});const _0x3827c2='https://app.trapay.uk/payment/'+_0x2bb3a9['id'];return console['log'](_0x58b8d5(0x28f)+_0x3827c2),{'paymentId':_0x2bb3a9['id'],'paymentUrl':_0x3827c2,'expiresAt':_0x2bb3a9[_0x58b8d5(0x20d)]||undefined};}else{if(_0x270330[_0x58b8d5(0x2a0)]===_0x58b8d5(0x258)){console[_0x58b8d5(0x1f5)](_0x58b8d5(0x23f)+_0x9600ac+'\x20(8digits-8digits\x20format)'),console['log']('💰\x20Amount:\x20'+_0x23a1a2+_0x58b8d5(0x211));const _0x5e6317=await this[_0x58b8d5(0x2a7)]['createPaymentLink']({'paymentId':_0x2bb3a9['id'],'orderId':_0x9600ac,'amount':_0x23a1a2});_0x398a2a=_0x5e6317[_0x58b8d5(0x27a)],_0x2aa8cc=_0x5e6317[_0x58b8d5(0x237)],await database_1[_0x58b8d5(0x208)][_0x58b8d5(0x21a)][_0x58b8d5(0x205)]({'where':{'id':_0x2bb3a9['id']},'data':{'externalPaymentUrl':_0x2aa8cc,'gatewayPaymentId':_0x398a2a}});_0x398a2a&&(console[_0x58b8d5(0x1f5)](_0x58b8d5(0x270)+_0x2bb3a9['id']+'\x20('+_0x398a2a+')'),coinToPayStatusService_1['coinToPayStatusService'][_0x58b8d5(0x256)](_0x2bb3a9['id'],_0x398a2a));const _0x20facd='https://app.trapay.uk/payment/'+_0x2bb3a9['id'];return console[_0x58b8d5(0x1f5)]('🔗\x20CoinToPay\x20payment\x20URL:\x20'+_0x20facd),{'paymentId':_0x2bb3a9['id'],'paymentUrl':_0x20facd,'expiresAt':_0x2bb3a9[_0x58b8d5(0x20d)]||undefined};}else{if(_0x270330[_0x58b8d5(0x2a0)][_0x58b8d5(0x1a9)](_0x58b8d5(0x1be))){const _0x409fe5=(0x0,gateway_1[_0x58b8d5(0x1b5)])(_0x270330[_0x58b8d5(0x2a0)]);if(!_0x409fe5)throw new Error(_0x58b8d5(0x223)+_0x270330[_0x58b8d5(0x2a0)]);console[_0x58b8d5(0x1f5)](_0x58b8d5(0x236)+_0x409fe5+_0x58b8d5(0x227)+_0x9600ac+_0x58b8d5(0x1e9)),console[_0x58b8d5(0x1f5)](_0x58b8d5(0x1c4)+_0x23a1a2+'\x20'+_0x270330[_0x58b8d5(0x1aa)]+_0x58b8d5(0x203)+_0x409fe5+')');const _0x4e69c5=await this[_0x58b8d5(0x2a2)][_0x58b8d5(0x1d5)]({'paymentId':_0x2bb3a9['id'],'orderId':_0x9600ac,'amount':_0x23a1a2,'currency':_0x270330[_0x58b8d5(0x1aa)],'region':_0x409fe5,'redirectUrl':_0x17a649});_0x398a2a=_0x4e69c5['gateway_payment_id'],_0x2aa8cc=_0x4e69c5[_0x58b8d5(0x237)],await database_1[_0x58b8d5(0x208)][_0x58b8d5(0x21a)][_0x58b8d5(0x205)]({'where':{'id':_0x2bb3a9['id']},'data':{'externalPaymentUrl':_0x2aa8cc,'gatewayPaymentId':_0x398a2a}});const _0x5f525a='https://app.trapay.uk/payment/'+_0x2bb3a9['id'];return console[_0x58b8d5(0x1f5)](_0x58b8d5(0x263)+_0x409fe5+_0x58b8d5(0x282)+_0x9600ac),console[_0x58b8d5(0x1f5)](_0x58b8d5(0x1d8)+_0x409fe5+'\x20payment\x20URL:\x20'+_0x5f525a),{'paymentId':_0x2bb3a9['id'],'paymentUrl':_0x5f525a,'expiresAt':_0x2bb3a9[_0x58b8d5(0x20d)]||undefined};}else{if(_0x270330[_0x58b8d5(0x2a0)]===_0x58b8d5(0x271)){console['log'](_0x58b8d5(0x27b)+_0x9600ac+_0x58b8d5(0x1e9)),console[_0x58b8d5(0x1f5)](_0x58b8d5(0x1c4)+_0x23a1a2+'\x20'+_0x270330[_0x58b8d5(0x1aa)]+_0x58b8d5(0x1ab));const _0xac5e0f=_0x58b8d5(0x24b)+_0x2bb3a9['id'];await database_1[_0x58b8d5(0x208)][_0x58b8d5(0x21a)][_0x58b8d5(0x205)]({'where':{'id':_0x2bb3a9['id']},'data':{'externalPaymentUrl':_0xac5e0f,'gatewayPaymentId':'test_'+_0x9600ac}});const _0x46d1cc='https://app.trapay.uk/payment/'+_0x2bb3a9['id'];return console[_0x58b8d5(0x1f5)](_0x58b8d5(0x20f)+_0x46d1cc),console[_0x58b8d5(0x1f5)](_0x58b8d5(0x1fb)+_0xac5e0f),{'paymentId':_0x2bb3a9['id'],'paymentUrl':_0x46d1cc,'expiresAt':_0x2bb3a9[_0x58b8d5(0x20d)]||undefined};}else{if(_0x270330['gateway']===_0x58b8d5(0x1c0)){console['log'](_0x58b8d5(0x21c)+_0x9600ac+_0x58b8d5(0x1e9)),console[_0x58b8d5(0x1f5)](_0x58b8d5(0x1c4)+_0x23a1a2+'\x20'+_0x270330[_0x58b8d5(0x1aa)]+_0x58b8d5(0x266));const _0x468568=_0x58b8d5(0x264)+_0x2bb3a9['id'];await database_1[_0x58b8d5(0x208)]['payment'][_0x58b8d5(0x205)]({'where':{'id':_0x2bb3a9['id']},'data':{'externalPaymentUrl':_0x468568,'gatewayPaymentId':'mc_'+_0x9600ac,'paymentMethod':_0x58b8d5(0x1c0)}});const _0x5394cd=_0x58b8d5(0x264)+_0x2bb3a9['id'];return console[_0x58b8d5(0x1f5)](_0x58b8d5(0x1c8)+_0x5394cd),console[_0x58b8d5(0x1f5)]('💳\x20MasterCard\x20form\x20URL:\x20'+_0x468568),{'paymentId':_0x2bb3a9['id'],'paymentUrl':_0x5394cd,'expiresAt':_0x2bb3a9[_0x58b8d5(0x20d)]||undefined};}else throw new Error(_0x58b8d5(0x1fc)+_0x270330[_0x58b8d5(0x2a0)]);}}}}}}}catch(_0x3233e5){await database_1[_0x58b8d5(0x208)][_0x58b8d5(0x21a)][_0x58b8d5(0x205)]({'where':{'id':_0x2bb3a9['id']},'data':{'status':_0x58b8d5(0x1cb)}});throw new Error('Gateway\x20error:\x20'+(_0x3233e5 instanceof Error?_0x3233e5['message']:_0x58b8d5(0x275)));}}async['handleSuccessfulPayment'](_0x3aa572){const _0x583e62=a49_0x2086ab;console[_0x583e62(0x1f5)](_0x583e62(0x247)+_0x3aa572);const _0x3249c1=await database_1['default']['payment'][_0x583e62(0x231)]({'where':{'id':_0x3aa572},'include':{'paymentLink':!![]}});if(!_0x3249c1||!_0x3249c1[_0x583e62(0x1e4)]){console[_0x583e62(0x1f5)](_0x583e62(0x1d7)+_0x3aa572+_0x583e62(0x212));return;}if(_0x3249c1[_0x583e62(0x2a4)]!=='PAID'){console[_0x583e62(0x1f5)](_0x583e62(0x1d7)+_0x3aa572+_0x583e62(0x1ba)+_0x3249c1['status']+_0x583e62(0x1cd));return;}if(!_0x3249c1[_0x583e62(0x2a3)]){console['log']('📈\x20Payment\x20'+_0x3aa572+'\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.');return;}try{const _0x3395ca=await database_1[_0x583e62(0x208)][_0x583e62(0x1ec)](async _0x5b0859=>{const _0x55d9eb=_0x583e62,_0x204ab7=await _0x5b0859[_0x55d9eb(0x1e4)][_0x55d9eb(0x231)]({'where':{'id':_0x3249c1['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(!_0x204ab7)throw new Error(_0x55d9eb(0x235)+_0x3249c1[_0x55d9eb(0x299)]+'\x20not\x20found');if(_0x204ab7[_0x55d9eb(0x1db)]===_0x55d9eb(0x1e3)&&_0x204ab7[_0x55d9eb(0x240)]>=0x1)return console['log']('📈\x20Single\x20payment\x20link\x20'+_0x3249c1[_0x55d9eb(0x299)]+_0x55d9eb(0x242)+_0x204ab7[_0x55d9eb(0x240)]+_0x55d9eb(0x233)),_0x204ab7;const _0x7e2991=await _0x5b0859[_0x55d9eb(0x21a)][_0x55d9eb(0x27e)]({'where':{'paymentLinkId':_0x3249c1[_0x55d9eb(0x299)],'status':_0x55d9eb(0x22c),'paidAt':{'not':null},'id':{'not':_0x3aa572}}}),_0x4ffcfd=_0x7e2991+0x1,_0x514422=_0x204ab7['type']==='SINGLE'&&_0x4ffcfd>=0x1?_0x55d9eb(0x1c9):_0x204ab7[_0x55d9eb(0x2a4)],_0x7ff6de=await _0x5b0859[_0x55d9eb(0x1e4)][_0x55d9eb(0x205)]({'where':{'id':_0x3249c1[_0x55d9eb(0x299)]},'data':{'currentPayments':_0x4ffcfd,'status':_0x514422}});return console[_0x55d9eb(0x1f5)](_0x55d9eb(0x1ac)+_0x3249c1[_0x55d9eb(0x299)]+'\x20('+_0x204ab7[_0x55d9eb(0x1db)]+_0x55d9eb(0x23c)+_0x204ab7[_0x55d9eb(0x240)]+_0x55d9eb(0x252)+_0x4ffcfd),_0x7ff6de;});if(_0x3395ca[_0x583e62(0x2a4)]===_0x583e62(0x1c9)){const _0x10ef94=_0x3395ca[_0x583e62(0x1db)]===_0x583e62(0x1e3)?_0x583e62(0x1b1):_0x583e62(0x23a);console[_0x583e62(0x1f5)](_0x583e62(0x20a)+_0x3249c1[_0x583e62(0x299)]+_0x583e62(0x1eb)+_0x10ef94+'\x20link\x20with\x20'+_0x3395ca[_0x583e62(0x240)]+_0x583e62(0x218));}}catch(_0x307be9){console[_0x583e62(0x25f)](_0x583e62(0x249)+_0x3aa572+':',_0x307be9);}}async[a49_0x2086ab(0x229)](_0xf7c4a5){const _0x50adfb=a49_0x2086ab,[_0x1885e1,_0x17caeb,_0xcca189,_0x1d293b]=await Promise['all']([database_1['default']['paymentLink']['count']({'where':{'shopId':_0xf7c4a5}}),database_1[_0x50adfb(0x208)][_0x50adfb(0x1e4)][_0x50adfb(0x27e)]({'where':{'shopId':_0xf7c4a5,'status':'ACTIVE'}}),database_1['default']['payment'][_0x50adfb(0x27e)]({'where':{'shopId':_0xf7c4a5,'paymentLinkId':{'not':null},'gateway':{'not':_0x50adfb(0x271)}}}),database_1[_0x50adfb(0x208)][_0x50adfb(0x21a)][_0x50adfb(0x234)]({'where':{'shopId':_0xf7c4a5,'paymentLinkId':{'not':null},'status':_0x50adfb(0x22c),'gateway':{'not':_0x50adfb(0x271)}},'select':{'amount':!![],'currency':!![]}})]);let _0x23bc27=0x0;for(const _0x3d604b of _0x1d293b){const _0x925aff=await currencyService_1[_0x50adfb(0x207)]['convertToUSDT'](_0x3d604b[_0x50adfb(0x262)],_0x3d604b['currency']);_0x23bc27+=_0x925aff;}const _0x3182d8=_0xcca189>0x0?_0x1d293b['length']/_0xcca189*0x64:0x0;return{'totalLinks':_0x1885e1,'activeLinks':_0x17caeb,'totalPayments':_0xcca189,'totalRevenue':Math['round'](_0x23bc27*0x64)/0x64,'conversionRate':Math[_0x50adfb(0x1d6)](_0x3182d8*0x64)/0x64};}[a49_0x2086ab(0x1ad)](_0x115d3b){const _0x4951a6=a49_0x2086ab;return{'id':_0x115d3b['id'],'shopId':_0x115d3b[_0x4951a6(0x289)],'amount':_0x115d3b[_0x4951a6(0x262)],'currency':_0x115d3b[_0x4951a6(0x1aa)],'sourceCurrency':_0x115d3b[_0x4951a6(0x297)]||undefined,'gateway':_0x115d3b['gateway'],'type':_0x115d3b['type'],'currentPayments':_0x115d3b['currentPayments'],'status':_0x115d3b['status'],'expiresAt':_0x115d3b[_0x4951a6(0x20d)]||undefined,'successUrl':_0x115d3b['successUrl']||undefined,'failUrl':_0x115d3b[_0x4951a6(0x254)]||undefined,'pendingUrl':_0x115d3b[_0x4951a6(0x1cc)]||undefined,'country':_0x115d3b[_0x4951a6(0x1fe)]||undefined,'language':_0x115d3b[_0x4951a6(0x241)]||undefined,'linkUrl':'https://app.trapay.uk/link/'+_0x115d3b['id'],'createdAt':_0x115d3b[_0x4951a6(0x1bb)],'updatedAt':_0x115d3b['updatedAt'],'shop':_0x115d3b[_0x4951a6(0x1dc)],'payments':_0x115d3b[_0x4951a6(0x1e1)]};}}exports[a49_0x2086ab(0x1df)]=PaymentLinkService;