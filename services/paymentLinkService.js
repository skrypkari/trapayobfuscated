'use strict';const a49_0x30d5a4=a49_0x5873;(function(_0x5b8d17,_0x2d097e){const _0xe6da01=a49_0x5873,_0x40b925=_0x5b8d17();while(!![]){try{const _0x399b6c=-parseInt(_0xe6da01(0x187))/0x1*(parseInt(_0xe6da01(0x155))/0x2)+-parseInt(_0xe6da01(0x153))/0x3*(parseInt(_0xe6da01(0x176))/0x4)+-parseInt(_0xe6da01(0x119))/0x5+parseInt(_0xe6da01(0x14d))/0x6*(-parseInt(_0xe6da01(0x169))/0x7)+parseInt(_0xe6da01(0x16d))/0x8*(parseInt(_0xe6da01(0x16c))/0x9)+-parseInt(_0xe6da01(0x10a))/0xa+parseInt(_0xe6da01(0x148))/0xb;if(_0x399b6c===_0x2d097e)break;else _0x40b925['push'](_0x40b925['shift']());}catch(_0x270a3a){_0x40b925['push'](_0x40b925['shift']());}}}(a49_0x54a4,0x567da));function a49_0x5873(_0x2db4aa,_0xce0afb){const _0x54a4d6=a49_0x54a4();return a49_0x5873=function(_0x5873da,_0x64c689){_0x5873da=_0x5873da-0xca;let _0x5e906c=_0x54a4d6[_0x5873da];return _0x5e906c;},a49_0x5873(_0x2db4aa,_0xce0afb);}function a49_0x54a4(){const _0x14736a=['💾\x20DB\x20Fail\x20URL:\x20','\x20gateway.\x20','desc','\x20\x20\x20🔗\x20White\x20URL:\x20','toLowerCase','\x20payments),\x20skipping\x20increment','\x20USDT)\x20exceeds\x20the\x20maximum\x20allowed\x20amount\x20of\x20','&payment_id=','currentPayments','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','no\x20email','test_','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','\x20payment\x20link','Please\x20reduce\x20the\x20amount.','length','\x22\x20is\x20in\x20enabled\x20gateways:','Test\x20Gateway','toString',',\x20gateway\x20','temp','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','ACTIVE','\x20(8digits-8digits\x20format)','🔗\x20CoinToPay\x20payment\x20URL:\x20','payment_url','map','KLYME\x20EU','\x20USDT\x20meets\x20minimum\x20requirement\x20of\x20','klyme_','findUnique','\x20link\x20','💰\x20Amount:\x20','PlisioService','19322765kWOYWw','\x20already\x20used\x20(','💰\x20Fixed\x20amount:\x20','../types/gateway','type','267402OVGoLR','startsWith','https://apptest.trapay.uk/payment/fail?id=','amount','generateGatewayUrls','plisio','3JmPAdk','none','6ZZTXYE','./gateways/rapydService','https://tesoft.uk/gateway/payment.php?id=','defineProperty','💰\x20Plisio\x20payment\x20link\x20mapping:','pendingUrl','ONCE','update','paymentGateways','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','💳\x20Creating\x20MasterCard\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','\x20(validated\x20for\x20','\x20USDT','getGatewayNameById','minAmount','\x20with\x20payment\x20ID\x20','gatewaySettings','BASE_URL','💰\x20No\x20maximum\x20amount\x20set\x20for\x20gateway\x20','insensitive','105OgXfnL','🔗\x20Generated\x20whiteUrl\x20for\x20','isValidGatewayId','117GJXtVt','300408mIxVLO','✅\x20Payment\x20link\x20created:\x20','🔗\x20KLYME\x20',',\x20amount:\x20','/gateway/pending.php?id=','qr_code_url','language','checkGatewayPermission','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','32212ILrvXT','Noda','\x20minimum\x20amount:\x20','updatedAt','findMany','EUR','successUrl','toUpperCase','Payment\x20','maxAmount','nodaService','https://apptest.trapay.uk/link/','klymeService','payment','log','convertToUSDT','\x20gateway\x20settings:','156973JnjyRh','error','paymentLinkId','KLYME\x20DE','\x20USDT\x20for\x20limit\x20checking','SINGLE','\x20(Plisio\x20or\x20KLYME)','default','🔗\x20Generated\x20URLs\x20for\x20','💾\x20Payment\x20created:\x20','\x20payment\x20URL:\x20','\x20USDT\x20for\x20gateway\x20','/gateway/fail.php?id=','count','__esModule','\x20using\x20default\x20gateways:','💰\x20Checking\x20amount\x20limits\x20for\x20shop\x20','updatePaymentLink','test_gateway','\x20USDT\x20meets\x20maximum\x20requirement\x20of\x20','schedulePaymentChecks','../config/database','👤\x20Customer:\x20','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','Shop\x20not\x20found','qr_url','getPaymentLinkStatistics','\x20maximum\x20amount:\x20','\x20(Test\x20Gateway)','\x20USDT\x20exceeds\x20maximum\x20','deletePaymentLink','🔗\x20Noda\x20payment\x20URL:\x20','all','https://apptest.trapay.uk/payment/success?id=','country','\x20USDT\x20for\x20','💳\x20Creating\x20KLYME\x20','createPayment','🔗\x20Creating\x20','❌\x20Amount\x20','noda','🔐\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','PaymentLinkService','amount\x20is\x20required\x20and\x20must\x20be\x20positive','KLYME\x20GB','✅\x20Amount\x20','📈\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','💳\x20MasterCard\x20form\x20URL:\x20','padStart','join','\x20payments)','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','💰\x20Checking\x20amount\x20limits\x20for\x20gateway:\x20','Shop\x20is\x20not\x20active','✅\x20Gateway\x20\x22','rapyd','📈\x20Single\x20payment\x20link\x20','./gateways/klymeService','status','💾\x20DB\x20Success\x20URL:\x20','Payment\x20amount\x20','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20','./gateways/nodaService','currencyService','sourceCurrency','gateway','rapydService','floor','📈\x20Payment\x20','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','🔗\x20Test\x20Gateway\x20payment\x20URL:\x20','Gateway\x20\x22','gateway_payment_id','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','shop','multi-use','💰\x20Gateway\x20','validateKlymeCurrency','getPaymentLinkById','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','USD','🔗\x20Link\x20type:\x20','\x20\x20\x20💾\x20DB\x20Pending\x20URL:\x20','🔗\x20Link\x20URL:\x20https://apptest.trapay.uk/link/','formatPaymentLinkResponse','GBP','generateGatewayOrderId','💾\x20DB\x20Pending\x20URL:\x20','Invalid\x20KLYME\x20gateway:\x20','parse','🔐\x20Shop\x20','\x20completed\x20(','https://tesoft.uk','Payment\x20link\x20is\x20not\x20active','COMPLETED','\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','paymentLink','📈\x20Payment\x20link\x20','./coinToPayStatusService','Payment\x20link\x20has\x20reached\x20maximum\x20payments','https://tesoft.uk/gateways/noda/webhook','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','Rapyd','checkAmountLimits','PAID','🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','getPublicPaymentLinkData','Invalid\x20gateway\x20ID:\x20','createdAt','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','\x20->\x20','username','getGatewayDisplayName','expiresAt','Error\x20parsing\x20payment\x20gateways:','🎯\x20Generated\x20gateway\x20order_id:\x20','qr_code','toFixed','mastercard','PENDING','cointopay','https://apptest.trapay.uk/test-gateway/payment/','🔐\x20Checking\x20if\x20\x22','🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','mc_','6927290gSIURW','Gateway\x20not\x20found\x20for\x20ID:\x20','currency','create','Payment\x20link\x20','failUrl','https://apptest.trapay.uk/payment/','invoice_total_sum','Plisio','paidAt','Payment\x20link\x20has\x20expired','💱\x20Converted\x20','❌\x20Gateway\x20\x22','🏁\x20Payment\x20link\x20','shopId','251530QFwCgU','Anonymous','Gateway\x20error:\x20','createPaymentLink','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','getKlymeRegionFromGatewayName','payments','https://apptest.trapay.uk/payment/pending?id=','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','🔗\x20Plisio\x20payment\x20URL:\x20','RapydService','🔗\x20No\x20whiteUrl\x20for\x20','FAILED'];a49_0x54a4=function(){return _0x14736a;};return a49_0x54a4();}var __importDefault=this&&this['__importDefault']||function(_0x5cc605){const _0x4112e4=a49_0x5873;return _0x5cc605&&_0x5cc605[_0x4112e4(0x195)]?_0x5cc605:{'default':_0x5cc605};};Object[a49_0x30d5a4(0x158)](exports,a49_0x30d5a4(0x195),{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require(a49_0x30d5a4(0x19c))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a49_0x30d5a4(0x156)),nodaService_1=require(a49_0x30d5a4(0x1c5)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require(a49_0x30d5a4(0x1c0)),coinToPayStatusService_1=require(a49_0x30d5a4(0xef)),gateway_1=require(a49_0x30d5a4(0x14b)),currencyService_1=require('./currencyService');class PaymentLinkService{constructor(){const _0x3825a9=a49_0x30d5a4;this['plisioService']=new plisioService_1[(_0x3825a9(0x147))](),this[_0x3825a9(0xcd)]=new rapydService_1[(_0x3825a9(0x123))](),this['nodaService']=new nodaService_1['NodaService'](),this['coinToPayService']=new coinToPayService_1['CoinToPayService'](),this['klymeService']=new klymeService_1['KlymeService']();}[a49_0x30d5a4(0xe1)](){const _0x4de34f=()=>{const _0x28bc8f=a49_0x5873;return Math[_0x28bc8f(0xce)](Math['random']()*0x5f5e100)[_0x28bc8f(0x138)]()[_0x28bc8f(0x1b7)](0x8,'0');};return _0x4de34f()+'-'+_0x4de34f();}[a49_0x30d5a4(0x151)](_0x3313c1,_0x59d7da,_0x3088d6,_0x453882,_0xd82124,_0x26791f,_0x5dac3a){const _0xc88201=a49_0x30d5a4;if(_0xd82124&&_0x26791f&&_0x5dac3a)return{'finalSuccessUrl':_0xd82124,'finalFailUrl':_0x26791f,'finalPendingUrl':_0x5dac3a,'dbSuccessUrl':_0xd82124,'dbFailUrl':_0x26791f,'dbPendingUrl':_0x5dac3a,'whiteUrl':null};const _0x2661c8=_0xd82124||_0xc88201(0x1a8)+_0x59d7da+_0xc88201(0x12d)+_0x3088d6,_0x33c44a=_0x26791f||_0xc88201(0x14f)+_0x59d7da+_0xc88201(0x12d)+_0x3088d6,_0x5a35e2=_0x5dac3a||_0xc88201(0x120)+_0x59d7da+_0xc88201(0x12d)+_0x3088d6;let _0x3d16a1,_0x397760,_0xcba3d7;_0x3313c1===_0xc88201(0x1af)||_0x3313c1[_0xc88201(0x14e)](_0xc88201(0x143))||_0x3313c1===_0xc88201(0x105)?(_0x3d16a1=_0x453882+'/gateway/pending.php?id='+_0x59d7da,_0xcba3d7=_0x453882+_0xc88201(0x171)+_0x59d7da):(_0x3d16a1=_0x453882+'/gateway/success.php?id='+_0x59d7da,_0xcba3d7=_0x453882+_0xc88201(0x171)+_0x59d7da);_0x397760=_0x453882+_0xc88201(0x193)+_0x59d7da;let _0x29524d=null;return _0x3313c1!=='plisio'&&!_0x3313c1['startsWith'](_0xc88201(0x143))?(_0x29524d=_0xc88201(0x157)+_0x59d7da,console[_0xc88201(0x184)](_0xc88201(0x16a)+_0x3313c1+':\x20'+_0x29524d)):console['log'](_0xc88201(0x124)+_0x3313c1+_0xc88201(0x18d)),console[_0xc88201(0x184)](_0xc88201(0x18f)+_0x3313c1+_0xc88201(0x164)+_0x59d7da+':'),console[_0xc88201(0x184)](_0xc88201(0x1ba)+_0x3d16a1),console['log'](_0xc88201(0xd4)+_0x397760),console['log']('\x20\x20\x20🌐\x20Gateway\x20Pending\x20URL:\x20'+_0xcba3d7),console[_0xc88201(0x184)](_0xc88201(0x13b)+_0x2661c8),console[_0xc88201(0x184)](_0xc88201(0xea)+_0x33c44a),console[_0xc88201(0x184)](_0xc88201(0xdd)+_0x5a35e2),console[_0xc88201(0x184)](_0xc88201(0x129)+(_0x29524d||'none')),{'finalSuccessUrl':_0x3d16a1,'finalFailUrl':_0x397760,'finalPendingUrl':_0xcba3d7,'dbSuccessUrl':_0x2661c8,'dbFailUrl':_0x33c44a,'dbPendingUrl':_0x5a35e2,'whiteUrl':_0x29524d};}[a49_0x30d5a4(0xd8)](_0x18ca60,_0x274f7d){const _0x11a3be=a49_0x30d5a4;if(!_0x18ca60['startsWith'](_0x11a3be(0x143)))return;const _0x25b92e=(0x0,gateway_1[_0x11a3be(0x11e)])(_0x18ca60),_0x92c083=_0x274f7d[_0x11a3be(0x17d)]();switch(_0x25b92e){case'EU':if(_0x92c083!==_0x11a3be(0x17b))throw new Error(_0x11a3be(0x12f)+_0x92c083);break;case'GB':if(_0x92c083!==_0x11a3be(0xe0))throw new Error(_0x11a3be(0xfa)+_0x92c083);break;case'DE':if(_0x92c083!=='EUR')throw new Error(_0x11a3be(0xd0)+_0x92c083);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x25b92e);}}async['checkAmountLimits'](_0x292dff,_0x28a940,_0x65b36c,_0x53b440){const _0x49dcb1=a49_0x30d5a4;console[_0x49dcb1(0x184)](_0x49dcb1(0x197)+_0x292dff+_0x49dcb1(0x139)+_0x28a940+_0x49dcb1(0x170)+_0x65b36c+'\x20'+_0x53b440);const _0x4973a6=await currencyService_1[_0x49dcb1(0xca)][_0x49dcb1(0x185)](_0x65b36c,_0x53b440);console[_0x49dcb1(0x184)](_0x49dcb1(0x115)+_0x65b36c+'\x20'+_0x53b440+'\x20to\x20'+_0x4973a6['toFixed'](0x6)+_0x49dcb1(0x18b));const _0x9ef942=await database_1[_0x49dcb1(0x18e)][_0x49dcb1(0xd5)][_0x49dcb1(0x144)]({'where':{'id':_0x292dff},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x9ef942)throw new Error(_0x49dcb1(0x19f));let _0x7707d9={};if(_0x9ef942[_0x49dcb1(0x165)])try{_0x7707d9=JSON[_0x49dcb1(0xe4)](_0x9ef942[_0x49dcb1(0x165)]),console[_0x49dcb1(0x184)]('💰\x20Shop\x20'+_0x9ef942['username']+_0x49dcb1(0x186),_0x7707d9);}catch(_0x59c2eb){console['error']('Error\x20parsing\x20gateway\x20settings:',_0x59c2eb),_0x7707d9={};}const _0x14d337=this[_0x49dcb1(0xfd)](_0x28a940);console[_0x49dcb1(0x184)](_0x49dcb1(0x1bb)+_0x28a940+_0x49dcb1(0xfb)+_0x14d337);const _0x4b976c=_0x7707d9[_0x14d337];if(_0x4b976c&&_0x4b976c[_0x49dcb1(0x163)]!==undefined){const _0x3043ea=_0x4b976c[_0x49dcb1(0x163)];console[_0x49dcb1(0x184)](_0x49dcb1(0xd7)+_0x14d337+_0x49dcb1(0x178)+_0x3043ea+_0x49dcb1(0x161));if(_0x4973a6<_0x3043ea){console[_0x49dcb1(0x188)](_0x49dcb1(0x1ae)+_0x4973a6['toFixed'](0x6)+'\x20USDT\x20is\x20below\x20minimum\x20'+_0x3043ea+_0x49dcb1(0x192)+_0x14d337);throw new Error(_0x49dcb1(0x1c3)+_0x65b36c+'\x20'+_0x53b440+'\x20('+_0x4973a6[_0x49dcb1(0x102)](0x2)+'\x20USDT)\x20is\x20below\x20the\x20minimum\x20required\x20amount\x20of\x20'+_0x3043ea+_0x49dcb1(0x1aa)+_0x14d337+'\x20gateway.\x20'+'Please\x20increase\x20the\x20amount.');}console[_0x49dcb1(0x184)](_0x49dcb1(0x1b4)+_0x4973a6[_0x49dcb1(0x102)](0x6)+_0x49dcb1(0x142)+_0x3043ea+_0x49dcb1(0x192)+_0x14d337);}else console[_0x49dcb1(0x184)]('💰\x20No\x20minimum\x20amount\x20set\x20for\x20gateway\x20'+_0x14d337);if(_0x4b976c&&_0x4b976c['maxAmount']!==undefined){const _0x127fea=_0x4b976c[_0x49dcb1(0x17f)];console[_0x49dcb1(0x184)]('💰\x20Gateway\x20'+_0x14d337+_0x49dcb1(0x1a2)+_0x127fea+_0x49dcb1(0x161));if(_0x4973a6>_0x127fea){console[_0x49dcb1(0x188)](_0x49dcb1(0x1ae)+_0x4973a6[_0x49dcb1(0x102)](0x6)+_0x49dcb1(0x1a4)+_0x127fea+_0x49dcb1(0x192)+_0x14d337);throw new Error(_0x49dcb1(0x1c3)+_0x65b36c+'\x20'+_0x53b440+'\x20('+_0x4973a6[_0x49dcb1(0x102)](0x2)+_0x49dcb1(0x12c)+_0x127fea+_0x49dcb1(0x1aa)+_0x14d337+_0x49dcb1(0x127)+_0x49dcb1(0x134));}console[_0x49dcb1(0x184)](_0x49dcb1(0x1b4)+_0x4973a6[_0x49dcb1(0x102)](0x6)+_0x49dcb1(0x19a)+_0x127fea+_0x49dcb1(0x192)+_0x14d337);}else console[_0x49dcb1(0x184)](_0x49dcb1(0x167)+_0x14d337);}async[a49_0x30d5a4(0x174)](_0x571edf,_0xd7ccfb){const _0x543ed4=a49_0x30d5a4;console[_0x543ed4(0x184)](_0x543ed4(0x1b0)+_0x571edf+':\x20'+_0xd7ccfb);const _0x116e82=await database_1[_0x543ed4(0x18e)]['shop'][_0x543ed4(0x144)]({'where':{'id':_0x571edf},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x116e82)throw new Error(_0x543ed4(0x19f));let _0x5820ae=[];if(_0x116e82[_0x543ed4(0x15d)])try{_0x5820ae=JSON[_0x543ed4(0xe4)](_0x116e82[_0x543ed4(0x15d)]),console[_0x543ed4(0x184)](_0x543ed4(0xe5)+_0x116e82[_0x543ed4(0xfc)]+'\x20enabled\x20gateways:',_0x5820ae);}catch(_0xa84985){console[_0x543ed4(0x188)](_0x543ed4(0xff),_0xa84985),_0x5820ae=[_0x543ed4(0x112)];}else _0x5820ae=[_0x543ed4(0x112)],console[_0x543ed4(0x184)](_0x543ed4(0xe5)+_0x116e82[_0x543ed4(0xfc)]+_0x543ed4(0x196),_0x5820ae);const _0x770114=this[_0x543ed4(0xfd)](_0xd7ccfb);console[_0x543ed4(0x184)](_0x543ed4(0x107)+_0x770114+_0x543ed4(0x136),_0x5820ae);if(!_0x5820ae['includes'](_0x770114)){console[_0x543ed4(0x188)](_0x543ed4(0x116)+_0x770114+'\x22\x20not\x20allowed\x20for\x20shop\x20'+_0x116e82['username']),console[_0x543ed4(0x188)]('❌\x20Enabled\x20gateways:\x20'+_0x5820ae[_0x543ed4(0x1b8)](',\x20'));throw new Error(_0x543ed4(0xd2)+_0x770114+_0x543ed4(0xda)+('Enabled\x20gateways:\x20'+_0x5820ae[_0x543ed4(0x1b8)](',\x20')+'.\x20')+'Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.');}console[_0x543ed4(0x184)](_0x543ed4(0x1bd)+_0x770114+'\x22\x20is\x20allowed\x20for\x20shop\x20'+_0x116e82[_0x543ed4(0xfc)]);}[a49_0x30d5a4(0xfd)](_0x4102f4){const _0x599145=a49_0x30d5a4,_0x55dbd6={'test_gateway':_0x599145(0x137),'plisio':'Plisio','rapyd':_0x599145(0xf3),'noda':_0x599145(0x177),'cointopay':'CoinToPay','klyme_eu':_0x599145(0x141),'klyme_gb':_0x599145(0x1b3),'klyme_de':_0x599145(0x18a),'mastercard':'MasterCard'};return _0x55dbd6[_0x4102f4]||_0x4102f4;}async[a49_0x30d5a4(0x11c)](_0x52a6b7,_0x17c7f2){const _0x4c7856=a49_0x30d5a4;if(!(0x0,gateway_1['isValidGatewayId'])(_0x17c7f2[_0x4c7856(0xcc)]))throw new Error(_0x4c7856(0xf8)+_0x17c7f2['gateway']+'.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)');const _0x143bc2=(0x0,gateway_1[_0x4c7856(0x162)])(_0x17c7f2[_0x4c7856(0xcc)]);if(!_0x143bc2)throw new Error(_0x4c7856(0x10b)+_0x17c7f2[_0x4c7856(0xcc)]);console['log']('🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20'+_0x143bc2),await this[_0x4c7856(0x174)](_0x52a6b7,_0x143bc2);if(_0x143bc2===_0x4c7856(0x152)&&!_0x17c7f2['sourceCurrency'])throw new Error(_0x4c7856(0x19e));if(_0x143bc2[_0x4c7856(0x14e)](_0x4c7856(0x143))){const _0x19c716=(0x0,gateway_1[_0x4c7856(0x11e)])(_0x143bc2);console[_0x4c7856(0x184)](_0x4c7856(0x1ab)+_0x19c716+'\x20payment\x20link');}let _0x5eadb4=_0x17c7f2['country'];_0x143bc2===_0x4c7856(0x1be)&&(_0x5eadb4='GB',console[_0x4c7856(0x184)](_0x4c7856(0x121)));if(!_0x17c7f2[_0x4c7856(0x150)]||_0x17c7f2[_0x4c7856(0x150)]<=0x0)throw new Error(_0x4c7856(0x1b2));let _0x1ef4a9=_0x17c7f2[_0x4c7856(0x10c)]||'USD';_0x143bc2===_0x4c7856(0x105)&&(_0x1ef4a9='EUR',console[_0x4c7856(0x184)](_0x4c7856(0xf6)));this[_0x4c7856(0xd8)](_0x143bc2,_0x1ef4a9),await this['checkAmountLimits'](_0x52a6b7,_0x143bc2,_0x17c7f2[_0x4c7856(0x150)],_0x1ef4a9);const _0x540415=_0x17c7f2[_0x4c7856(0x14c)]||_0x4c7856(0x18c);console[_0x4c7856(0x184)](_0x4c7856(0x1ad)+_0x540415+_0x4c7856(0x133));const _0x196b0c=await database_1[_0x4c7856(0x18e)][_0x4c7856(0xed)][_0x4c7856(0x10d)]({'data':{'shopId':_0x52a6b7,'amount':_0x17c7f2[_0x4c7856(0x150)],'currency':_0x1ef4a9,'sourceCurrency':_0x17c7f2['sourceCurrency']||undefined,'gateway':_0x143bc2,'type':_0x540415,'currentPayments':0x0,'status':_0x4c7856(0x13c),'expiresAt':_0x17c7f2['expiresAt']?new Date(_0x17c7f2['expiresAt']):undefined,'successUrl':_0x17c7f2['successUrl']||null,'failUrl':_0x17c7f2[_0x4c7856(0x10f)]||null,'pendingUrl':_0x17c7f2['pendingUrl']||null,'country':_0x5eadb4,'language':_0x17c7f2[_0x4c7856(0x173)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x4c7856(0x184)](_0x4c7856(0x16e)+_0x196b0c['id']+'\x20('+_0x143bc2+')'),console[_0x4c7856(0x184)](_0x4c7856(0x14a)+_0x196b0c[_0x4c7856(0x150)]+'\x20'+_0x196b0c[_0x4c7856(0x10c)]),console[_0x4c7856(0x184)](_0x4c7856(0xdc)+_0x196b0c['type']),console['log'](_0x4c7856(0xde)+_0x196b0c['id']),console['log']('📝\x20Note:\x20Success/Fail/Pending\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created'),this[_0x4c7856(0xdf)](_0x196b0c);}async['getPaymentLinks'](_0x132f7f,_0x29eaa8){const _0x16673d=a49_0x30d5a4,{page:_0x1f9b03,limit:_0x5080ac,status:_0x202759,gateway:_0x1520f1,search:_0x227115}=_0x29eaa8,_0x5da6fd=(_0x1f9b03-0x1)*_0x5080ac,_0x4e0b2f={'shopId':_0x132f7f};_0x202759&&(_0x4e0b2f['status']=_0x202759[_0x16673d(0x17d)]());if(_0x1520f1){if((0x0,gateway_1[_0x16673d(0x16b)])(_0x1520f1)){const _0xac4856=(0x0,gateway_1[_0x16673d(0x162)])(_0x1520f1);_0xac4856&&(_0x4e0b2f[_0x16673d(0xcc)]=_0xac4856);}else _0x4e0b2f[_0x16673d(0xcc)]=_0x1520f1[_0x16673d(0x12a)]();}_0x227115&&(_0x4e0b2f['OR']=[{'gateway':{'contains':_0x227115,'mode':_0x16673d(0x168)}},{'currency':{'contains':_0x227115,'mode':_0x16673d(0x168)}}]);const [_0x5e79d6,_0x4f2ffa]=await Promise[_0x16673d(0x1a7)]([database_1[_0x16673d(0x18e)][_0x16673d(0xed)][_0x16673d(0x17a)]({'where':_0x4e0b2f,'skip':_0x5da6fd,'take':_0x5080ac,'orderBy':{'createdAt':_0x16673d(0x128)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x16673d(0x128)},'take':0xa}}}),database_1[_0x16673d(0x18e)][_0x16673d(0xed)]['count']({'where':_0x4e0b2f})]);return{'links':_0x5e79d6[_0x16673d(0x140)](_0x11b679=>this[_0x16673d(0xdf)](_0x11b679)),'pagination':{'page':_0x1f9b03,'limit':_0x5080ac,'total':_0x4f2ffa,'totalPages':Math['ceil'](_0x4f2ffa/_0x5080ac)}};}async[a49_0x30d5a4(0xd9)](_0x5da2b9,_0x417c62){const _0x30005b=a49_0x30d5a4,_0x1efb68=await database_1[_0x30005b(0x18e)][_0x30005b(0xed)]['findFirst']({'where':{'id':_0x417c62,'shopId':_0x5da2b9},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x30005b(0x128)}}}});if(!_0x1efb68)return null;return this['formatPaymentLinkResponse'](_0x1efb68);}async[a49_0x30d5a4(0x198)](_0x20c7f6,_0x5d5443,_0xe1e740){const _0x254e88=a49_0x30d5a4,_0x2b7198={..._0xe1e740};if(_0xe1e740['gateway']){if((0x0,gateway_1[_0x254e88(0x16b)])(_0xe1e740[_0x254e88(0xcc)])){const _0x413abf=(0x0,gateway_1[_0x254e88(0x162)])(_0xe1e740[_0x254e88(0xcc)]);_0x413abf&&(await this['checkGatewayPermission'](_0x20c7f6,_0x413abf),_0x2b7198['gateway']=_0x413abf);}else _0x2b7198['gateway']=_0xe1e740[_0x254e88(0xcc)][_0x254e88(0x12a)]();}(_0x2b7198[_0x254e88(0xcc)]===_0x254e88(0x1be)||_0xe1e740['country']&&_0x2b7198[_0x254e88(0xcc)]!==_0x254e88(0x1be))&&(_0x2b7198[_0x254e88(0xcc)]===_0x254e88(0x1be)&&(_0x2b7198['country']='GB',console[_0x254e88(0x184)](_0x254e88(0x108))));_0x2b7198[_0x254e88(0xcc)]==='cointopay'&&(_0x2b7198[_0x254e88(0x10c)]=_0x254e88(0x17b),console['log'](_0x254e88(0x15e)));_0x2b7198['gateway']&&_0x2b7198[_0x254e88(0x10c)]&&this[_0x254e88(0xd8)](_0x2b7198['gateway'],_0x2b7198['currency']);if(_0xe1e740[_0x254e88(0x150)]&&_0x2b7198[_0x254e88(0xcc)]){const _0x3ca0ec=_0xe1e740['currency']||_0x254e88(0xdb);await this['checkAmountLimits'](_0x20c7f6,_0x2b7198[_0x254e88(0xcc)],_0xe1e740['amount'],_0x3ca0ec);}_0xe1e740['expiresAt']&&(_0x2b7198[_0x254e88(0xfe)]=new Date(_0xe1e740[_0x254e88(0xfe)]));const _0x4a11d8=await database_1[_0x254e88(0x18e)][_0x254e88(0xed)]['update']({'where':{'id':_0x5d5443,'shopId':_0x20c7f6},'data':_0x2b7198,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x254e88(0x128)},'take':0xa}}});return this[_0x254e88(0xdf)](_0x4a11d8);}async[a49_0x30d5a4(0x1a5)](_0x424d79,_0x10063b){await database_1['default']['paymentLink']['delete']({'where':{'id':_0x10063b,'shopId':_0x424d79}});}async[a49_0x30d5a4(0xf7)](_0x177b69){const _0x5b540f=a49_0x30d5a4,_0x6e3f67=await database_1[_0x5b540f(0x18e)][_0x5b540f(0xed)][_0x5b540f(0x144)]({'where':{'id':_0x177b69},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x6e3f67)return null;const _0x376938=_0x6e3f67[_0x5b540f(0xfe)]&&_0x6e3f67['expiresAt']<new Date(),_0x2c934a=_0x6e3f67[_0x5b540f(0x14c)]===_0x5b540f(0x18c)?_0x6e3f67[_0x5b540f(0x12e)]>=0x1:![],_0x528c2e=_0x6e3f67['shop'][_0x5b540f(0x1c1)]===_0x5b540f(0x13c),_0x53101e=_0x6e3f67['status']===_0x5b540f(0x13c),_0x149229=!_0x376938&&!_0x2c934a&&_0x528c2e&&_0x53101e,_0x308caa=_0x6e3f67[_0x5b540f(0x14c)]===_0x5b540f(0x18c)?_0x6e3f67[_0x5b540f(0x12e)]>=0x1?0x0:0x1:Number['MAX_SAFE_INTEGER'];return{'id':_0x6e3f67['id'],'amount':_0x6e3f67[_0x5b540f(0x150)],'currency':_0x6e3f67[_0x5b540f(0x10c)],'sourceCurrency':_0x6e3f67[_0x5b540f(0xcb)]||undefined,'gateway':_0x6e3f67['gateway'],'type':_0x6e3f67[_0x5b540f(0x14c)],'currentPayments':_0x6e3f67[_0x5b540f(0x12e)],'status':_0x6e3f67[_0x5b540f(0x1c1)],'expiresAt':_0x6e3f67['expiresAt']||undefined,'shopName':_0x6e3f67[_0x5b540f(0xd5)]['name'],'isAvailable':_0x149229,'remainingPayments':_0x308caa};}async['initiatePaymentFromLink'](_0x20511f){const _0xb18fc9=a49_0x30d5a4,{linkId:_0x5681ce,customerEmail:_0x170c35,customerName:_0x112e59}=_0x20511f,_0x2fb617=await database_1[_0xb18fc9(0x18e)]['paymentLink']['findUnique']({'where':{'id':_0x5681ce},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x2fb617)throw new Error('Payment\x20link\x20not\x20found');const _0x39dbcf=_0x2fb617[_0xb18fc9(0xfe)]&&_0x2fb617[_0xb18fc9(0xfe)]<new Date(),_0x4e4c7f=_0x2fb617['type']===_0xb18fc9(0x18c)?_0x2fb617[_0xb18fc9(0x12e)]>=0x1:![],_0x48d4e5=_0x2fb617['shop']['status']==='ACTIVE',_0xdde789=_0x2fb617[_0xb18fc9(0x1c1)]===_0xb18fc9(0x13c);if(_0x39dbcf)throw new Error(_0xb18fc9(0x114));if(_0x4e4c7f){const _0x54e582=_0x2fb617['type']===_0xb18fc9(0x18c)?'This\x20single-use\x20payment\x20link\x20has\x20already\x20been\x20used':_0xb18fc9(0xf0);throw new Error(_0x54e582);}if(!_0x48d4e5)throw new Error(_0xb18fc9(0x1bc));if(!_0xdde789)throw new Error(_0xb18fc9(0xe8));await this['checkGatewayPermission'](_0x2fb617['shopId'],_0x2fb617['gateway']);const _0x470ee4=_0x2fb617['amount'];console[_0xb18fc9(0x184)]('💳\x20Initiating\x20payment\x20from\x20'+_0x2fb617[_0xb18fc9(0x14c)]+_0xb18fc9(0x145)+_0x5681ce+':\x20'+_0x470ee4+'\x20'+_0x2fb617[_0xb18fc9(0x10c)]),console[_0xb18fc9(0x184)](_0xb18fc9(0x19d)+(_0x112e59||_0xb18fc9(0x11a))+'\x20('+(_0x170c35||_0xb18fc9(0x130))+')'),this[_0xb18fc9(0xd8)](_0x2fb617[_0xb18fc9(0xcc)],_0x2fb617[_0xb18fc9(0x10c)]),await this[_0xb18fc9(0xf4)](_0x2fb617['shopId'],_0x2fb617['gateway'],_0x470ee4,_0x2fb617[_0xb18fc9(0x10c)]);const _0x3dc333=this['generateGatewayOrderId']();console[_0xb18fc9(0x184)](_0xb18fc9(0x100)+_0x3dc333+'\x20(8digits-8digits\x20format\x20for\x20'+_0x2fb617[_0xb18fc9(0xcc)]+')');const _0x46d50c=await database_1[_0xb18fc9(0x18e)][_0xb18fc9(0x183)]['create']({'data':{'shopId':_0x2fb617[_0xb18fc9(0x118)],'paymentLinkId':_0x2fb617['id'],'gateway':_0x2fb617['gateway'],'amount':_0x470ee4,'currency':_0x2fb617[_0xb18fc9(0x10c)],'sourceCurrency':_0x2fb617[_0xb18fc9(0xcb)]||undefined,'usage':_0xb18fc9(0x15b),'expiresAt':_0x2fb617[_0xb18fc9(0xfe)]||undefined,'successUrl':_0xb18fc9(0x13a),'failUrl':'temp','pendingUrl':_0xb18fc9(0x13a),'whiteUrl':_0xb18fc9(0x13a),'status':_0xb18fc9(0x104),'orderId':null,'gatewayOrderId':_0x3dc333,'customerEmail':_0x170c35||undefined,'customerName':_0x112e59||undefined,'country':_0x2fb617[_0xb18fc9(0x1a9)]||undefined,'language':_0x2fb617[_0xb18fc9(0x173)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console['log'](_0xb18fc9(0x190)+_0x46d50c['id']);const _0xe814ae=process['env'][_0xb18fc9(0x166)]||_0xb18fc9(0xe7),{finalSuccessUrl:_0x2deeb0,finalFailUrl:_0x2268f9,finalPendingUrl:_0x2702a0,dbSuccessUrl:_0x358712,dbFailUrl:_0x3f7bd2,dbPendingUrl:_0x1489e3,whiteUrl:_0x4697cb}=this['generateGatewayUrls'](_0x2fb617[_0xb18fc9(0xcc)],_0x46d50c['id'],_0x3dc333,_0xe814ae,_0x2fb617[_0xb18fc9(0x17c)]||undefined,_0x2fb617['failUrl']||undefined,_0x2fb617[_0xb18fc9(0x15a)]||undefined);await database_1['default'][_0xb18fc9(0x183)][_0xb18fc9(0x15c)]({'where':{'id':_0x46d50c['id']},'data':{'successUrl':_0x358712,'failUrl':_0x3f7bd2,'pendingUrl':_0x1489e3,'whiteUrl':_0x4697cb}}),console[_0xb18fc9(0x184)](_0xb18fc9(0x146)+_0x470ee4+'\x20'+_0x2fb617[_0xb18fc9(0x10c)]),console['log']('👤\x20Customer:\x20'+(_0x112e59||_0xb18fc9(0x11a))+'\x20('+(_0x170c35||_0xb18fc9(0x130))+')'),console[_0xb18fc9(0x184)](_0xb18fc9(0x1c2)+_0x358712),console['log'](_0xb18fc9(0x126)+_0x3f7bd2),console[_0xb18fc9(0x184)](_0xb18fc9(0xe2)+_0x1489e3),console[_0xb18fc9(0x184)]('🔗\x20White\x20URL:\x20'+(_0x4697cb||_0xb18fc9(0x154)));let _0x2f6a21,_0x557de6;try{if(_0x2fb617['gateway']===_0xb18fc9(0x152)){console['log'](_0xb18fc9(0x159)),console[_0xb18fc9(0x184)](_0xb18fc9(0x132)+_0x2fb617[_0xb18fc9(0x10c)]),console[_0xb18fc9(0x184)]('\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20'+_0x2fb617[_0xb18fc9(0xcb)]);const _0x23fa63=await this['plisioService'][_0xb18fc9(0x1ac)]({'paymentId':_0x46d50c['id'],'orderId':_0x3dc333,'amount':_0x470ee4,'currency':_0x2fb617[_0xb18fc9(0x10c)],'productName':_0xb18fc9(0x17e)+_0x470ee4+'\x20'+_0x2fb617[_0xb18fc9(0x10c)],'description':'Payment\x20'+_0x470ee4+'\x20'+_0x2fb617[_0xb18fc9(0x10c)],'successUrl':_0x2deeb0,'failUrl':_0x2268f9,'customerEmail':_0x170c35||undefined,'customerName':_0x112e59||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x2fb617[_0xb18fc9(0xcb)]||undefined});_0x2f6a21=_0x23fa63[_0xb18fc9(0xd3)],_0x557de6=_0x23fa63[_0xb18fc9(0x13f)],await database_1['default'][_0xb18fc9(0x183)]['update']({'where':{'id':_0x46d50c['id']},'data':{'externalPaymentUrl':_0x557de6,'gatewayPaymentId':_0x2f6a21,'invoiceTotalSum':Number(_0x23fa63[_0xb18fc9(0x111)]),'qrCode':_0x23fa63[_0xb18fc9(0x101)],'qrUrl':_0x23fa63[_0xb18fc9(0x1a0)]}});const _0x3a4747='https://apptest.trapay.uk/payment/'+_0x46d50c['id'];return console[_0xb18fc9(0x184)](_0xb18fc9(0x122)+_0x3a4747),{'paymentId':_0x46d50c['id'],'paymentUrl':_0x3a4747,'expiresAt':_0x46d50c[_0xb18fc9(0xfe)]||undefined};}else{if(_0x2fb617['gateway']==='rapyd'){const _0x2a58ac=await this[_0xb18fc9(0xcd)][_0xb18fc9(0x11c)]({'paymentId':_0x46d50c['id'],'orderId':_0x3dc333,'orderName':_0xb18fc9(0x17e)+_0x470ee4+'\x20'+_0x2fb617[_0xb18fc9(0x10c)],'amount':_0x470ee4,'currency':_0x2fb617[_0xb18fc9(0x10c)],'country':_0x2fb617[_0xb18fc9(0x1a9)],'language':_0x2fb617[_0xb18fc9(0x173)]||'EN','amountIsEditable':![],'usage':_0xb18fc9(0x15b),'maxPayments':0x1,'successUrl':_0x2deeb0,'failUrl':_0x2268f9});_0x2f6a21=_0x2a58ac[_0xb18fc9(0xd3)],_0x557de6=_0x2a58ac['payment_url'],await database_1[_0xb18fc9(0x18e)][_0xb18fc9(0x183)]['update']({'where':{'id':_0x46d50c['id']},'data':{'externalPaymentUrl':_0x557de6,'gatewayPaymentId':_0x2f6a21}});const _0x301085=_0xb18fc9(0x110)+_0x46d50c['id'];return console[_0xb18fc9(0x184)]('🔗\x20Rapyd\x20payment\x20URL:\x20'+_0x301085),{'paymentId':_0x46d50c['id'],'paymentUrl':_0x301085,'expiresAt':_0x46d50c[_0xb18fc9(0xfe)]||undefined};}else{if(_0x2fb617[_0xb18fc9(0xcc)]===_0xb18fc9(0x1af)){const _0x5bac53=await this[_0xb18fc9(0x180)][_0xb18fc9(0x11c)]({'paymentId':_0x46d50c['id'],'orderId':_0x3dc333,'name':_0xb18fc9(0x17e)+_0x470ee4+'\x20'+_0x2fb617[_0xb18fc9(0x10c)],'paymentDescription':'Payment\x20'+_0x470ee4+'\x20'+_0x2fb617[_0xb18fc9(0x10c)],'amount':_0x470ee4,'currency':_0x2fb617['currency'],'webhookUrl':_0xb18fc9(0xf1),'returnUrl':_0x2702a0,'expiryDate':_0x2fb617[_0xb18fc9(0xfe)]?.['toISOString']()});_0x2f6a21=_0x5bac53[_0xb18fc9(0xd3)],_0x557de6=_0x5bac53[_0xb18fc9(0x13f)],await database_1[_0xb18fc9(0x18e)][_0xb18fc9(0x183)][_0xb18fc9(0x15c)]({'where':{'id':_0x46d50c['id']},'data':{'externalPaymentUrl':_0x557de6,'gatewayPaymentId':_0x2f6a21,'qrUrl':_0x5bac53[_0xb18fc9(0x172)]}});const _0x23094d=_0xb18fc9(0x110)+_0x46d50c['id'];return console['log'](_0xb18fc9(0x1a6)+_0x23094d),{'paymentId':_0x46d50c['id'],'paymentUrl':_0x23094d,'expiresAt':_0x46d50c['expiresAt']||undefined};}else{if(_0x2fb617[_0xb18fc9(0xcc)]===_0xb18fc9(0x105)){console[_0xb18fc9(0x184)]('🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x3dc333+_0xb18fc9(0x13d)),console[_0xb18fc9(0x184)]('💰\x20Amount:\x20'+_0x470ee4+_0xb18fc9(0x11d));const _0x1166c0=await this['coinToPayService']['createPaymentLink']({'paymentId':_0x46d50c['id'],'orderId':_0x3dc333,'amount':_0x470ee4});_0x2f6a21=_0x1166c0[_0xb18fc9(0xd3)],_0x557de6=_0x1166c0['payment_url'],await database_1[_0xb18fc9(0x18e)][_0xb18fc9(0x183)][_0xb18fc9(0x15c)]({'where':{'id':_0x46d50c['id']},'data':{'externalPaymentUrl':_0x557de6,'gatewayPaymentId':_0x2f6a21}});_0x2f6a21&&(console[_0xb18fc9(0x184)](_0xb18fc9(0x1c4)+_0x46d50c['id']+'\x20('+_0x2f6a21+')'),coinToPayStatusService_1['coinToPayStatusService'][_0xb18fc9(0x19b)](_0x46d50c['id'],_0x2f6a21));const _0x14f261='https://apptest.trapay.uk/payment/'+_0x46d50c['id'];return console[_0xb18fc9(0x184)](_0xb18fc9(0x13e)+_0x14f261),{'paymentId':_0x46d50c['id'],'paymentUrl':_0x14f261,'expiresAt':_0x46d50c[_0xb18fc9(0xfe)]||undefined};}else{if(_0x2fb617['gateway'][_0xb18fc9(0x14e)](_0xb18fc9(0x143))){const _0x1150aa=(0x0,gateway_1[_0xb18fc9(0x11e)])(_0x2fb617[_0xb18fc9(0xcc)]);if(!_0x1150aa)throw new Error(_0xb18fc9(0xe3)+_0x2fb617[_0xb18fc9(0xcc)]);console[_0xb18fc9(0x184)](_0xb18fc9(0x1ab)+_0x1150aa+'\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x3dc333+_0xb18fc9(0x13d)),console[_0xb18fc9(0x184)]('💰\x20Amount:\x20'+_0x470ee4+'\x20'+_0x2fb617[_0xb18fc9(0x10c)]+_0xb18fc9(0x160)+_0x1150aa+')');const _0x20c93a=await this[_0xb18fc9(0x182)][_0xb18fc9(0x11c)]({'paymentId':_0x46d50c['id'],'orderId':_0x3dc333,'amount':_0x470ee4,'currency':_0x2fb617[_0xb18fc9(0x10c)],'region':_0x1150aa,'redirectUrl':_0x2702a0});_0x2f6a21=_0x20c93a[_0xb18fc9(0xd3)],_0x557de6=_0x20c93a[_0xb18fc9(0x13f)],await database_1[_0xb18fc9(0x18e)]['payment'][_0xb18fc9(0x15c)]({'where':{'id':_0x46d50c['id']},'data':{'externalPaymentUrl':_0x557de6,'gatewayPaymentId':_0x2f6a21}});const _0x54d500='https://apptest.trapay.uk/payment/'+_0x46d50c['id'];return console['log']('✅\x20KLYME\x20'+_0x1150aa+_0xb18fc9(0xeb)+_0x3dc333),console[_0xb18fc9(0x184)](_0xb18fc9(0x16f)+_0x1150aa+_0xb18fc9(0x191)+_0x54d500),{'paymentId':_0x46d50c['id'],'paymentUrl':_0x54d500,'expiresAt':_0x46d50c[_0xb18fc9(0xfe)]||undefined};}else{if(_0x2fb617['gateway']===_0xb18fc9(0x199)){console['log']('🧪\x20Creating\x20Test\x20Gateway\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x3dc333+'\x20(8digits-8digits\x20format)'),console[_0xb18fc9(0x184)](_0xb18fc9(0x146)+_0x470ee4+'\x20'+_0x2fb617['currency']+_0xb18fc9(0x1a3));const _0x4572fa=_0xb18fc9(0x106)+_0x46d50c['id'];await database_1['default'][_0xb18fc9(0x183)][_0xb18fc9(0x15c)]({'where':{'id':_0x46d50c['id']},'data':{'externalPaymentUrl':_0x4572fa,'gatewayPaymentId':_0xb18fc9(0x131)+_0x3dc333}});const _0x431b62='https://apptest.trapay.uk/payment/'+_0x46d50c['id'];return console[_0xb18fc9(0x184)](_0xb18fc9(0xd1)+_0x431b62),console[_0xb18fc9(0x184)]('🧪\x20Test\x20Gateway\x20form\x20URL:\x20'+_0x4572fa),{'paymentId':_0x46d50c['id'],'paymentUrl':_0x431b62,'expiresAt':_0x46d50c[_0xb18fc9(0xfe)]||undefined};}else{if(_0x2fb617[_0xb18fc9(0xcc)]===_0xb18fc9(0x103)){console['log'](_0xb18fc9(0x15f)+_0x3dc333+'\x20(8digits-8digits\x20format)'),console[_0xb18fc9(0x184)](_0xb18fc9(0x146)+_0x470ee4+'\x20'+_0x2fb617['currency']+'\x20(MasterCard)');const _0x28d82e=_0xb18fc9(0x110)+_0x46d50c['id'];await database_1['default'][_0xb18fc9(0x183)][_0xb18fc9(0x15c)]({'where':{'id':_0x46d50c['id']},'data':{'externalPaymentUrl':_0x28d82e,'gatewayPaymentId':_0xb18fc9(0x109)+_0x3dc333,'paymentMethod':'mastercard'}});const _0xfdef5b=_0xb18fc9(0x110)+_0x46d50c['id'];return console[_0xb18fc9(0x184)]('🔗\x20MasterCard\x20payment\x20URL:\x20'+_0xfdef5b),console[_0xb18fc9(0x184)](_0xb18fc9(0x1b6)+_0x28d82e),{'paymentId':_0x46d50c['id'],'paymentUrl':_0xfdef5b,'expiresAt':_0x46d50c['expiresAt']||undefined};}else throw new Error('Unsupported\x20gateway:\x20'+_0x2fb617[_0xb18fc9(0xcc)]);}}}}}}}catch(_0x4ca072){await database_1['default'][_0xb18fc9(0x183)][_0xb18fc9(0x15c)]({'where':{'id':_0x46d50c['id']},'data':{'status':_0xb18fc9(0x125)}});throw new Error(_0xb18fc9(0x11b)+(_0x4ca072 instanceof Error?_0x4ca072['message']:'Unknown\x20error'));}}async['handleSuccessfulPayment'](_0x16e918){const _0xfe1bab=a49_0x30d5a4;console['log'](_0xfe1bab(0x1b5)+_0x16e918);const _0x42cbfc=await database_1[_0xfe1bab(0x18e)][_0xfe1bab(0x183)][_0xfe1bab(0x144)]({'where':{'id':_0x16e918},'include':{'paymentLink':!![]}});if(!_0x42cbfc||!_0x42cbfc[_0xfe1bab(0xed)]){console['log'](_0xfe1bab(0xcf)+_0x16e918+_0xfe1bab(0xec));return;}if(_0x42cbfc['status']!==_0xfe1bab(0xf5)){console[_0xfe1bab(0x184)](_0xfe1bab(0xcf)+_0x16e918+'\x20status\x20is\x20'+_0x42cbfc[_0xfe1bab(0x1c1)]+',\x20not\x20PAID.\x20Skipping\x20counter\x20update.');return;}if(!_0x42cbfc[_0xfe1bab(0x113)]){console['log'](_0xfe1bab(0xcf)+_0x16e918+_0xfe1bab(0x175));return;}try{const _0x271d29=await database_1[_0xfe1bab(0x18e)]['$transaction'](async _0x348e3d=>{const _0x12648e=_0xfe1bab,_0x3a33f5=await _0x348e3d['paymentLink'][_0x12648e(0x144)]({'where':{'id':_0x42cbfc[_0x12648e(0x189)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(!_0x3a33f5)throw new Error(_0x12648e(0x10e)+_0x42cbfc['paymentLinkId']+'\x20not\x20found');if(_0x3a33f5[_0x12648e(0x14c)]===_0x12648e(0x18c)&&_0x3a33f5['currentPayments']>=0x1)return console[_0x12648e(0x184)](_0x12648e(0x1bf)+_0x42cbfc['paymentLinkId']+_0x12648e(0x149)+_0x3a33f5[_0x12648e(0x12e)]+_0x12648e(0x12b)),_0x3a33f5;const _0x12eb17=await _0x348e3d['payment']['count']({'where':{'paymentLinkId':_0x42cbfc['paymentLinkId'],'status':_0x12648e(0xf5),'paidAt':{'not':null},'id':{'not':_0x16e918}}}),_0x15c2d2=_0x12eb17+0x1,_0x225fcc=_0x3a33f5['type']===_0x12648e(0x18c)&&_0x15c2d2>=0x1?_0x12648e(0xe9):_0x3a33f5[_0x12648e(0x1c1)],_0x29da3e=await _0x348e3d[_0x12648e(0xed)][_0x12648e(0x15c)]({'where':{'id':_0x42cbfc[_0x12648e(0x189)]},'data':{'currentPayments':_0x15c2d2,'status':_0x225fcc}});return console[_0x12648e(0x184)](_0x12648e(0xee)+_0x42cbfc[_0x12648e(0x189)]+'\x20('+_0x3a33f5[_0x12648e(0x14c)]+')\x20counter\x20updated:\x20'+_0x3a33f5[_0x12648e(0x12e)]+'\x20->\x20'+_0x15c2d2),_0x29da3e;});if(_0x271d29[_0xfe1bab(0x1c1)]===_0xfe1bab(0xe9)){const _0x1aa737=_0x271d29[_0xfe1bab(0x14c)]===_0xfe1bab(0x18c)?'single-use':_0xfe1bab(0xd6);console[_0xfe1bab(0x184)](_0xfe1bab(0x117)+_0x42cbfc[_0xfe1bab(0x189)]+_0xfe1bab(0xe6)+_0x1aa737+'\x20link\x20with\x20'+_0x271d29[_0xfe1bab(0x12e)]+_0xfe1bab(0x1b9));}}catch(_0x4c1549){console[_0xfe1bab(0x188)](_0xfe1bab(0xf2)+_0x16e918+':',_0x4c1549);}}async[a49_0x30d5a4(0x1a1)](_0xe5479b){const _0x1c1194=a49_0x30d5a4,[_0x238d06,_0x326cf1,_0xb848c5,_0x4d17a4]=await Promise[_0x1c1194(0x1a7)]([database_1[_0x1c1194(0x18e)][_0x1c1194(0xed)][_0x1c1194(0x194)]({'where':{'shopId':_0xe5479b}}),database_1[_0x1c1194(0x18e)][_0x1c1194(0xed)][_0x1c1194(0x194)]({'where':{'shopId':_0xe5479b,'status':_0x1c1194(0x13c)}}),database_1['default']['payment'][_0x1c1194(0x194)]({'where':{'shopId':_0xe5479b,'paymentLinkId':{'not':null},'gateway':{'not':_0x1c1194(0x199)}}}),database_1[_0x1c1194(0x18e)][_0x1c1194(0x183)]['findMany']({'where':{'shopId':_0xe5479b,'paymentLinkId':{'not':null},'status':'PAID','gateway':{'not':'test_gateway'}},'select':{'amount':!![],'currency':!![]}})]);let _0x543d54=0x0;for(const _0x4139fb of _0x4d17a4){const _0x25a5b9=await currencyService_1[_0x1c1194(0xca)]['convertToUSDT'](_0x4139fb[_0x1c1194(0x150)],_0x4139fb['currency']);_0x543d54+=_0x25a5b9;}const _0x3ec148=_0xb848c5>0x0?_0x4d17a4[_0x1c1194(0x135)]/_0xb848c5*0x64:0x0;return{'totalLinks':_0x238d06,'activeLinks':_0x326cf1,'totalPayments':_0xb848c5,'totalRevenue':Math['round'](_0x543d54*0x64)/0x64,'conversionRate':Math['round'](_0x3ec148*0x64)/0x64};}[a49_0x30d5a4(0xdf)](_0x3119ca){const _0x165fdc=a49_0x30d5a4;return{'id':_0x3119ca['id'],'shopId':_0x3119ca[_0x165fdc(0x118)],'amount':_0x3119ca['amount'],'currency':_0x3119ca[_0x165fdc(0x10c)],'sourceCurrency':_0x3119ca[_0x165fdc(0xcb)]||undefined,'gateway':_0x3119ca[_0x165fdc(0xcc)],'type':_0x3119ca[_0x165fdc(0x14c)],'currentPayments':_0x3119ca[_0x165fdc(0x12e)],'status':_0x3119ca['status'],'expiresAt':_0x3119ca[_0x165fdc(0xfe)]||undefined,'successUrl':_0x3119ca['successUrl']||undefined,'failUrl':_0x3119ca[_0x165fdc(0x10f)]||undefined,'pendingUrl':_0x3119ca[_0x165fdc(0x15a)]||undefined,'country':_0x3119ca['country']||undefined,'language':_0x3119ca['language']||undefined,'linkUrl':_0x165fdc(0x181)+_0x3119ca['id'],'createdAt':_0x3119ca[_0x165fdc(0xf9)],'updatedAt':_0x3119ca[_0x165fdc(0x179)],'shop':_0x3119ca['shop'],'payments':_0x3119ca[_0x165fdc(0x11f)]};}}exports[a49_0x30d5a4(0x1b1)]=PaymentLinkService;