'use strict';const a45_0x6f0378=a45_0xc217;(function(_0x420c1d,_0x598ba2){const _0x4f40b6=a45_0xc217,_0x1d82af=_0x420c1d();while(!![]){try{const _0x45eb23=-parseInt(_0x4f40b6(0x178))/0x1+parseInt(_0x4f40b6(0x1ae))/0x2+-parseInt(_0x4f40b6(0x1bd))/0x3+parseInt(_0x4f40b6(0x1aa))/0x4*(parseInt(_0x4f40b6(0x1c1))/0x5)+parseInt(_0x4f40b6(0x182))/0x6*(parseInt(_0x4f40b6(0x1f9))/0x7)+-parseInt(_0x4f40b6(0x1e5))/0x8+-parseInt(_0x4f40b6(0x1ee))/0x9*(-parseInt(_0x4f40b6(0x19d))/0xa);if(_0x45eb23===_0x598ba2)break;else _0x1d82af['push'](_0x1d82af['shift']());}catch(_0x25b715){_0x1d82af['push'](_0x1d82af['shift']());}}}(a45_0x5ba3,0x1a31b));function a45_0xc217(_0xdb4d20,_0x52301f){const _0x5ba3ca=a45_0x5ba3();return a45_0xc217=function(_0xc21741,_0x3a902b){_0xc21741=_0xc21741-0x157;let _0x44e6e3=_0x5ba3ca[_0xc21741];return _0x44e6e3;},a45_0xc217(_0xdb4d20,_0x52301f);}var __importDefault=this&&this['__importDefault']||function(_0x467dfa){return _0x467dfa&&_0x467dfa['__esModule']?_0x467dfa:{'default':_0x467dfa};};Object[a45_0x6f0378(0x1a1)](exports,a45_0x6f0378(0x1ba),{'value':!![]}),exports[a45_0x6f0378(0x15e)]=void 0x0;function a45_0x5ba3(){const _0x42ec8d=['https://tesoft.uk/gateways/noda/webhook','payment','findFirst','isValidGatewayId','gateway','handleSuccessfulPayment','toString','üîó\x20Noda\x20payment\x20URL:\x20','desc','üîó\x20Plisio\x20payment\x20URL:\x20','Unsupported\x20KLYME\x20region:\x20','Shop\x20is\x20not\x20active','findMany','https://app.trapay.uk/payment/pending?payment_id=','coinToPayService','ONCE','env','CoinToPayService','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','../types/gateway','Payment\x20','BASE_URL','count','PLACEHOLDER','maxPayments','3310810fJksrB','GBP','qr_code_url','PlisioService','defineProperty','getKlymeRegionFromGatewayName','status','üîó\x20Link\x20URL:\x20https://app.trapay.uk/link/','gateway_payment_id','insensitive','EUR','createdAt','Payment\x20link\x20not\x20found','96108QLUHHk','all','üéØ\x20Generated\x20gateway\x20order_id:\x20','\x20\x20\x20üíæ\x20DB\x20Fail\x20URL:\x20','257114MqBVFS','üí∞\x20Amount:\x20','ü™ô\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','üîó\x20Rapyd\x20payment\x20URL:\x20','‚úÖ\x20KLYME\x20','https://tesoft.uk','./gateways/coinToPayService','payment_url','\x20payment\x20URL:\x20','paymentLink','üìà\x20Payment\x20link\x20','createPaymentLink','__esModule','Unsupported\x20gateway:\x20','üîó\x20CoinToPay\x20payment\x20URL:\x20','534642kFmbio','qr_code','üí≥\x20Initiating\x20payment\x20from\x20link\x20','\x20(validated\x20for\x20','35eCdGti','https://app.trapay.uk/payment/','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','random','currency','createPayment','https://app.trapay.uk/payment/success?payment_id=','formatPaymentLinkResponse','üèÅ\x20Payment\x20link\x20','successUrl','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','Invalid\x20gateway\x20ID:\x20','üá¨üáß\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','payments','‚úÖ\x20DB\x20Success\x20URL:\x20','sourceCurrency','deletePaymentLink','country','Order\x20ID:\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','log','/gateway/pending.php?id=','Gateway\x20error:\x20','KlymeService','padStart','FAILED','create','getGatewayNameById','map','/gateway/fail.php?id=','expiresAt','language','plisio','üí≥\x20Creating\x20KLYME\x20','amount','NodaService','1355664fOQRCe','ceil','Invalid\x20KLYME\x20gateway:\x20','klymeService','\x20payments:\x20','shopId','ACTIVE','Anonymous','default','9pbtbUh','generateGatewayOrderId','no\x20email','üîó\x20KLYME\x20','Unknown\x20error','ü™ô\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','COMPLETED','update','üá¨üáß\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','shop','amount\x20is\x20required\x20and\x20must\x20be\x20positive','413rthgnu','plisioService','\x20completed\x20(reached\x20max\x20payments)','üîó\x20Generated\x20URLs\x20for\x20','üí∞\x20Fixed\x20amount:\x20','getPaymentLinkStatistics','rapyd','noda','PaymentLinkService','‚ùå\x20DB\x20Fail\x20URL:\x20','getPaymentLinkById','getPaymentLinks','nodaService','currentPayments','validateKlymeCurrency','round','\x20(8digits-8digits\x20format\x20for\x20','Payment\x20link\x20is\x20not\x20active','üë§\x20Customer:\x20','toUpperCase','name','./currencyService','./gateways/plisioService','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','klyme_','üîó\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','rapydService','\x20payment\x20link','startsWith','https://tesoft.uk/gateway/payment.php?id=','\x20\x20\x20üåê\x20Gateway\x20Success\x20URL:\x20','message','‚úÖ\x20Payment\x20link\x20created:\x20','\x20(8digits-8digits\x20format)','189561gIqDgg','floor','Gateway\x20not\x20found\x20for\x20ID:\x20','cointopay','ü™ô\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','failUrl','generateGatewayUrls','findUnique','toLowerCase','paymentLinkId','1698SvjYhh','üí∞\x20Plisio\x20payment\x20link\x20mapping:'];a45_0x5ba3=function(){return _0x42ec8d;};return a45_0x5ba3();}const database_1=__importDefault(require('../config/database')),plisioService_1=require(a45_0x6f0378(0x16c)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a45_0x6f0378(0x1b4)),klymeService_1=require('./gateways/klymeService'),gateway_1=require(a45_0x6f0378(0x197)),currencyService_1=require(a45_0x6f0378(0x16b));class PaymentLinkService{constructor(){const _0x2ef398=a45_0x6f0378;this[_0x2ef398(0x157)]=new plisioService_1[(_0x2ef398(0x1a0))](),this[_0x2ef398(0x170)]=new rapydService_1['RapydService'](),this[_0x2ef398(0x162)]=new nodaService_1[(_0x2ef398(0x1e4))](),this['coinToPayService']=new coinToPayService_1[(_0x2ef398(0x195))](),this[_0x2ef398(0x1e8)]=new klymeService_1[(_0x2ef398(0x1d8))]();}[a45_0x6f0378(0x1ef)](){const _0x471383=()=>{const _0x287e79=a45_0xc217;return Math[_0x287e79(0x179)](Math[_0x287e79(0x1c4)]()*0x5f5e100)[_0x287e79(0x18a)]()[_0x287e79(0x1d9)](0x8,'0');};return _0x471383()+'-'+_0x471383();}[a45_0x6f0378(0x17e)](_0x439af2,_0x442697,_0x57e89c,_0x255603,_0x258c78){const _0x104bd4=a45_0x6f0378;if(_0x255603&&_0x258c78)return{'finalSuccessUrl':_0x255603,'finalFailUrl':_0x258c78,'dbSuccessUrl':_0x255603,'dbFailUrl':_0x258c78};let _0x3f97b8,_0x3e4b4d,_0x1b5233,_0x149170;return _0x439af2===_0x104bd4(0x15d)||_0x439af2[_0x104bd4(0x172)](_0x104bd4(0x16e))||_0x439af2===_0x104bd4(0x17b)?(_0x3f97b8=_0x57e89c+_0x104bd4(0x1d6)+_0x442697,_0x1b5233=_0x104bd4(0x191)+_0x442697):(_0x3f97b8=_0x57e89c+'/gateway/success.php?id='+_0x442697,_0x1b5233=_0x104bd4(0x1c7)+_0x442697),_0x3e4b4d=_0x57e89c+_0x104bd4(0x1de)+_0x442697,_0x149170='https://app.trapay.uk/payment/fail?payment_id='+_0x442697,console[_0x104bd4(0x1d5)](_0x104bd4(0x159)+_0x439af2+':'),console[_0x104bd4(0x1d5)](_0x104bd4(0x174)+_0x3f97b8),console[_0x104bd4(0x1d5)]('\x20\x20\x20üåê\x20Gateway\x20Fail\x20URL:\x20'+_0x3e4b4d),console[_0x104bd4(0x1d5)]('\x20\x20\x20üíæ\x20DB\x20Success\x20URL:\x20'+_0x1b5233),console[_0x104bd4(0x1d5)](_0x104bd4(0x1ad)+_0x149170),{'finalSuccessUrl':_0x3f97b8,'finalFailUrl':_0x3e4b4d,'dbSuccessUrl':_0x1b5233,'dbFailUrl':_0x149170};}['validateKlymeCurrency'](_0x498b1b,_0x55b7c4){const _0x5c6dc7=a45_0x6f0378;if(!_0x498b1b['startsWith'](_0x5c6dc7(0x16e)))return;const _0x5d1a23=(0x0,gateway_1[_0x5c6dc7(0x1a2)])(_0x498b1b),_0xb6c9f2=_0x55b7c4[_0x5c6dc7(0x169)]();switch(_0x5d1a23){case'EU':if(_0xb6c9f2!==_0x5c6dc7(0x1a7))throw new Error(_0x5c6dc7(0x1d4)+_0xb6c9f2);break;case'GB':if(_0xb6c9f2!==_0x5c6dc7(0x19e))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0xb6c9f2);break;case'DE':if(_0xb6c9f2!==_0x5c6dc7(0x1a7))throw new Error(_0x5c6dc7(0x196)+_0xb6c9f2);break;default:throw new Error(_0x5c6dc7(0x18e)+_0x5d1a23);}}async['createPaymentLink'](_0x47c8ce,_0xf354f8){const _0x5c81fe=a45_0x6f0378;if(!(0x0,gateway_1[_0x5c81fe(0x187)])(_0xf354f8[_0x5c81fe(0x188)]))throw new Error(_0x5c81fe(0x1cc)+_0xf354f8[_0x5c81fe(0x188)]+_0x5c81fe(0x1c3));const _0x33e2ce=(0x0,gateway_1[_0x5c81fe(0x1dc)])(_0xf354f8[_0x5c81fe(0x188)]);if(!_0x33e2ce)throw new Error(_0x5c81fe(0x17a)+_0xf354f8[_0x5c81fe(0x188)]);console[_0x5c81fe(0x1d5)](_0x5c81fe(0x16f)+_0x33e2ce);if(_0x33e2ce==='plisio'&&!_0xf354f8[_0x5c81fe(0x1d0)])throw new Error(_0x5c81fe(0x16d));if(_0x33e2ce[_0x5c81fe(0x172)]('klyme_')){const _0x3b2468=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x33e2ce);console[_0x5c81fe(0x1d5)](_0x5c81fe(0x1e2)+_0x3b2468+_0x5c81fe(0x171));}let _0x38d8b3=_0xf354f8['country'];_0x33e2ce===_0x5c81fe(0x15c)&&(_0x38d8b3='GB',console[_0x5c81fe(0x1d5)](_0x5c81fe(0x1cd)));if(!_0xf354f8[_0x5c81fe(0x1e3)]||_0xf354f8[_0x5c81fe(0x1e3)]<=0x0)throw new Error(_0x5c81fe(0x1f8));let _0x595662=_0xf354f8['currency']||'USD';_0x33e2ce===_0x5c81fe(0x17b)&&(_0x595662=_0x5c81fe(0x1a7),console['log'](_0x5c81fe(0x17c)));this['validateKlymeCurrency'](_0x33e2ce,_0x595662);const _0x4934b2=process[_0x5c81fe(0x194)][_0x5c81fe(0x199)]||_0x5c81fe(0x1b3),{finalSuccessUrl:_0x466f3e,finalFailUrl:_0x590d26,dbSuccessUrl:_0x211d06,dbFailUrl:_0x5de12a}=this['generateGatewayUrls'](_0x33e2ce,_0x5c81fe(0x19b),_0x4934b2,_0xf354f8[_0x5c81fe(0x1ca)],_0xf354f8['failUrl']),_0x309459=await database_1[_0x5c81fe(0x1ed)][_0x5c81fe(0x1b7)]['create']({'data':{'shopId':_0x47c8ce,'amount':_0xf354f8[_0x5c81fe(0x1e3)],'currency':_0x595662,'sourceCurrency':_0xf354f8[_0x5c81fe(0x1d0)]||undefined,'gateway':_0x33e2ce,'maxPayments':_0xf354f8['maxPayments']||0x1,'currentPayments':0x0,'status':_0x5c81fe(0x1eb),'expiresAt':_0xf354f8[_0x5c81fe(0x1df)]?new Date(_0xf354f8['expiresAt']):undefined,'successUrl':_0x211d06,'failUrl':_0x5de12a,'country':_0x38d8b3,'language':_0xf354f8[_0x5c81fe(0x1e0)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x5c81fe(0x1d5)](_0x5c81fe(0x176)+_0x309459['id']+'\x20('+_0x33e2ce+')'),console[_0x5c81fe(0x1d5)](_0x5c81fe(0x15a)+_0x309459['amount']+'\x20'+_0x309459[_0x5c81fe(0x1c5)]),console[_0x5c81fe(0x1d5)](_0x5c81fe(0x1a4)+_0x309459['id']),console[_0x5c81fe(0x1d5)](_0x5c81fe(0x1cf)+_0x309459[_0x5c81fe(0x1ca)]),console[_0x5c81fe(0x1d5)](_0x5c81fe(0x15f)+_0x309459[_0x5c81fe(0x17d)]),this[_0x5c81fe(0x1c8)](_0x309459);}async[a45_0x6f0378(0x161)](_0x956da2,_0x209d8b){const _0x3f9f6e=a45_0x6f0378,{page:_0x583b1d,limit:_0x59283d,status:_0x366545,gateway:_0x1d9aa7,search:_0x1ffb98}=_0x209d8b,_0x14a0b4=(_0x583b1d-0x1)*_0x59283d,_0xac00ae={'shopId':_0x956da2};_0x366545&&(_0xac00ae[_0x3f9f6e(0x1a3)]=_0x366545[_0x3f9f6e(0x169)]());if(_0x1d9aa7){if((0x0,gateway_1[_0x3f9f6e(0x187)])(_0x1d9aa7)){const _0x3df2e5=(0x0,gateway_1[_0x3f9f6e(0x1dc)])(_0x1d9aa7);_0x3df2e5&&(_0xac00ae['gateway']=_0x3df2e5);}else _0xac00ae['gateway']=_0x1d9aa7[_0x3f9f6e(0x180)]();}_0x1ffb98&&(_0xac00ae['OR']=[{'gateway':{'contains':_0x1ffb98,'mode':_0x3f9f6e(0x1a6)}},{'currency':{'contains':_0x1ffb98,'mode':_0x3f9f6e(0x1a6)}}]);const [_0xef97f3,_0x5d0d7d]=await Promise[_0x3f9f6e(0x1ab)]([database_1[_0x3f9f6e(0x1ed)][_0x3f9f6e(0x1b7)]['findMany']({'where':_0xac00ae,'skip':_0x14a0b4,'take':_0x59283d,'orderBy':{'createdAt':_0x3f9f6e(0x18c)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}}),database_1['default']['paymentLink'][_0x3f9f6e(0x19a)]({'where':_0xac00ae})]);return{'links':_0xef97f3[_0x3f9f6e(0x1dd)](_0x17f9f5=>this[_0x3f9f6e(0x1c8)](_0x17f9f5)),'pagination':{'page':_0x583b1d,'limit':_0x59283d,'total':_0x5d0d7d,'totalPages':Math[_0x3f9f6e(0x1e6)](_0x5d0d7d/_0x59283d)}};}async[a45_0x6f0378(0x160)](_0x386a99,_0x721995){const _0x240b7d=a45_0x6f0378,_0xf35fc5=await database_1[_0x240b7d(0x1ed)]['paymentLink'][_0x240b7d(0x186)]({'where':{'id':_0x721995,'shopId':_0x386a99},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x240b7d(0x18c)}}}});if(!_0xf35fc5)return null;return this[_0x240b7d(0x1c8)](_0xf35fc5);}async['updatePaymentLink'](_0x476a41,_0x57b0c6,_0x55eaa7){const _0x362ec6=a45_0x6f0378,_0x26564c={..._0x55eaa7};if(_0x55eaa7[_0x362ec6(0x188)]){if((0x0,gateway_1[_0x362ec6(0x187)])(_0x55eaa7[_0x362ec6(0x188)])){const _0x212d84=(0x0,gateway_1[_0x362ec6(0x1dc)])(_0x55eaa7['gateway']);_0x212d84&&(_0x26564c[_0x362ec6(0x188)]=_0x212d84);}else _0x26564c[_0x362ec6(0x188)]=_0x55eaa7[_0x362ec6(0x188)]['toLowerCase']();}(_0x26564c['gateway']==='rapyd'||_0x55eaa7[_0x362ec6(0x1d2)]&&_0x26564c['gateway']!==_0x362ec6(0x15c))&&(_0x26564c['gateway']===_0x362ec6(0x15c)&&(_0x26564c[_0x362ec6(0x1d2)]='GB',console[_0x362ec6(0x1d5)](_0x362ec6(0x1f6))));_0x26564c[_0x362ec6(0x188)]===_0x362ec6(0x17b)&&(_0x26564c[_0x362ec6(0x1c5)]=_0x362ec6(0x1a7),console[_0x362ec6(0x1d5)](_0x362ec6(0x1f3)));_0x26564c[_0x362ec6(0x188)]&&_0x26564c[_0x362ec6(0x1c5)]&&this[_0x362ec6(0x164)](_0x26564c[_0x362ec6(0x188)],_0x26564c[_0x362ec6(0x1c5)]);_0x55eaa7[_0x362ec6(0x1df)]&&(_0x26564c[_0x362ec6(0x1df)]=new Date(_0x55eaa7[_0x362ec6(0x1df)]));const _0x5526db=await database_1[_0x362ec6(0x1ed)][_0x362ec6(0x1b7)]['update']({'where':{'id':_0x57b0c6,'shopId':_0x476a41},'data':_0x26564c,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x362ec6(0x18c)},'take':0xa}}});return this[_0x362ec6(0x1c8)](_0x5526db);}async[a45_0x6f0378(0x1d1)](_0x3a6ea4,_0x4bb00e){const _0x56908e=a45_0x6f0378;await database_1[_0x56908e(0x1ed)][_0x56908e(0x1b7)]['delete']({'where':{'id':_0x4bb00e,'shopId':_0x3a6ea4}});}async['getPublicPaymentLinkData'](_0x11cadb){const _0x1e0571=a45_0x6f0378,_0x16eb2a=await database_1[_0x1e0571(0x1ed)][_0x1e0571(0x1b7)]['findUnique']({'where':{'id':_0x11cadb},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x16eb2a)return null;const _0x44cd03=_0x16eb2a[_0x1e0571(0x1df)]&&_0x16eb2a[_0x1e0571(0x1df)]<new Date(),_0x2d6c23=_0x16eb2a[_0x1e0571(0x163)]>=_0x16eb2a[_0x1e0571(0x19c)],_0xc624c=_0x16eb2a['shop'][_0x1e0571(0x1a3)]===_0x1e0571(0x1eb),_0x454352=_0x16eb2a[_0x1e0571(0x1a3)]==='ACTIVE',_0x2d510c=!_0x44cd03&&!_0x2d6c23&&_0xc624c&&_0x454352,_0x16ee73=Math['max'](0x0,_0x16eb2a['maxPayments']-_0x16eb2a[_0x1e0571(0x163)]);return{'id':_0x16eb2a['id'],'amount':_0x16eb2a[_0x1e0571(0x1e3)],'currency':_0x16eb2a[_0x1e0571(0x1c5)],'sourceCurrency':_0x16eb2a['sourceCurrency']||undefined,'gateway':_0x16eb2a[_0x1e0571(0x188)],'maxPayments':_0x16eb2a[_0x1e0571(0x19c)],'currentPayments':_0x16eb2a[_0x1e0571(0x163)],'status':_0x16eb2a[_0x1e0571(0x1a3)],'expiresAt':_0x16eb2a[_0x1e0571(0x1df)]||undefined,'shopName':_0x16eb2a[_0x1e0571(0x1f7)][_0x1e0571(0x16a)],'isAvailable':_0x2d510c,'remainingPayments':_0x16ee73};}async['initiatePaymentFromLink'](_0x1dde88){const _0x43e100=a45_0x6f0378,{linkId:_0x518e90,customerEmail:_0x539fe0,customerName:_0x42d6b9}=_0x1dde88,_0xe785e=await database_1[_0x43e100(0x1ed)][_0x43e100(0x1b7)][_0x43e100(0x17f)]({'where':{'id':_0x518e90},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![]}}}});if(!_0xe785e)throw new Error(_0x43e100(0x1a9));const _0x303dfc=_0xe785e[_0x43e100(0x1df)]&&_0xe785e[_0x43e100(0x1df)]<new Date(),_0x53cc3c=_0xe785e['currentPayments']>=_0xe785e['maxPayments'],_0x2a73e0=_0xe785e[_0x43e100(0x1f7)]['status']===_0x43e100(0x1eb),_0x3d9ede=_0xe785e['status']===_0x43e100(0x1eb);if(_0x303dfc)throw new Error('Payment\x20link\x20has\x20expired');if(_0x53cc3c)throw new Error('Payment\x20link\x20has\x20reached\x20maximum\x20payments');if(!_0x2a73e0)throw new Error(_0x43e100(0x18f));if(!_0x3d9ede)throw new Error(_0x43e100(0x167));const _0x245805=_0xe785e[_0x43e100(0x1e3)];console[_0x43e100(0x1d5)](_0x43e100(0x1bf)+_0x518e90+':\x20'+_0x245805+'\x20'+_0xe785e['currency']),console[_0x43e100(0x1d5)]('üë§\x20Customer:\x20'+(_0x42d6b9||'Anonymous')+'\x20('+(_0x539fe0||_0x43e100(0x1f0))+')'),this[_0x43e100(0x164)](_0xe785e[_0x43e100(0x188)],_0xe785e[_0x43e100(0x1c5)]);const _0xabc646=this['generateGatewayOrderId']();console['log'](_0x43e100(0x1ac)+_0xabc646+_0x43e100(0x166)+_0xe785e[_0x43e100(0x188)]+')');const _0x45f5a2=process[_0x43e100(0x194)]['BASE_URL']||'https://tesoft.uk',{finalSuccessUrl:_0xe4461d,finalFailUrl:_0x4801b0,dbSuccessUrl:_0x39e0ea,dbFailUrl:_0x4c76c9}=this[_0x43e100(0x17e)](_0xe785e['gateway'],_0xabc646,_0x45f5a2,_0xe785e[_0x43e100(0x1ca)]||undefined,_0xe785e[_0x43e100(0x17d)]||undefined),_0x3a078e=await database_1[_0x43e100(0x1ed)]['payment'][_0x43e100(0x1db)]({'data':{'shopId':_0xe785e[_0x43e100(0x1ea)],'paymentLinkId':_0xe785e['id'],'gateway':_0xe785e[_0x43e100(0x188)],'amount':_0x245805,'currency':_0xe785e['currency'],'sourceCurrency':_0xe785e[_0x43e100(0x1d0)]||undefined,'usage':_0x43e100(0x193),'expiresAt':_0xe785e[_0x43e100(0x1df)]||undefined,'successUrl':_0x39e0ea,'failUrl':_0x4c76c9,'status':'PENDING','orderId':null,'gatewayOrderId':_0xabc646,'customerEmail':_0x539fe0||undefined,'customerName':_0x42d6b9||undefined,'country':_0xe785e['country']||undefined,'language':_0xe785e[_0x43e100(0x1e0)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x43e100(0x1d5)]('üíæ\x20Payment\x20created\x20from\x20link:\x20'+_0x3a078e['id']),console[_0x43e100(0x1d5)](_0x43e100(0x1af)+_0x245805+'\x20'+_0xe785e[_0x43e100(0x1c5)]),console[_0x43e100(0x1d5)](_0x43e100(0x168)+(_0x42d6b9||_0x43e100(0x1ec))+'\x20('+(_0x539fe0||'no\x20email')+')'),console[_0x43e100(0x1d5)]('üíæ\x20DB\x20Success\x20URL:\x20'+_0x39e0ea),console[_0x43e100(0x1d5)]('üíæ\x20DB\x20Fail\x20URL:\x20'+_0x4c76c9);let _0x5d17b2,_0x5470a8;try{if(_0xe785e['gateway']===_0x43e100(0x1e1)){console[_0x43e100(0x1d5)](_0x43e100(0x183)),console[_0x43e100(0x1d5)](_0x43e100(0x1cb)+_0xe785e['currency']),console[_0x43e100(0x1d5)]('\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20'+_0xe785e[_0x43e100(0x1d0)]);const _0x1fc122=await this['plisioService'][_0x43e100(0x1c6)]({'paymentId':_0x3a078e['id'],'orderId':_0xabc646,'amount':_0x245805,'currency':_0xe785e[_0x43e100(0x1c5)],'productName':_0x43e100(0x198)+_0x245805+'\x20'+_0xe785e[_0x43e100(0x1c5)],'description':_0x43e100(0x198)+_0x245805+'\x20'+_0xe785e[_0x43e100(0x1c5)],'successUrl':_0xe4461d,'failUrl':_0x4801b0,'customerEmail':_0x539fe0||undefined,'customerName':_0x42d6b9||undefined,'isSourceCurrency':!![],'sourceCurrency':_0xe785e[_0x43e100(0x1d0)]||undefined});_0x5d17b2=_0x1fc122['gateway_payment_id'],_0x5470a8=_0x1fc122['payment_url'],await database_1[_0x43e100(0x1ed)]['payment']['update']({'where':{'id':_0x3a078e['id']},'data':{'externalPaymentUrl':_0x5470a8,'gatewayPaymentId':_0x5d17b2,'invoiceTotalSum':Number(_0x1fc122['invoice_total_sum']),'qrCode':_0x1fc122[_0x43e100(0x1be)],'qrUrl':_0x1fc122['qr_url']}});const _0x2b352e=_0x43e100(0x1c2)+_0x3a078e['id'];return console['log'](_0x43e100(0x18d)+_0x2b352e),{'paymentId':_0x3a078e['id'],'paymentUrl':_0x2b352e,'expiresAt':_0x3a078e['expiresAt']||undefined};}else{if(_0xe785e['gateway']===_0x43e100(0x15c)){const _0x428a1b=await this[_0x43e100(0x170)][_0x43e100(0x1b9)]({'paymentId':_0x3a078e['id'],'orderId':_0xabc646,'orderName':'Payment\x20'+_0x245805+'\x20'+_0xe785e[_0x43e100(0x1c5)],'amount':_0x245805,'currency':_0xe785e[_0x43e100(0x1c5)],'country':_0xe785e['country'],'language':_0xe785e[_0x43e100(0x1e0)]||'EN','amountIsEditable':![],'usage':_0x43e100(0x193),'maxPayments':0x1,'successUrl':_0xe4461d,'failUrl':_0x4801b0});_0x5d17b2=_0x428a1b[_0x43e100(0x1a5)],_0x5470a8=_0x428a1b['payment_url'],await database_1[_0x43e100(0x1ed)][_0x43e100(0x185)]['update']({'where':{'id':_0x3a078e['id']},'data':{'externalPaymentUrl':_0x5470a8,'gatewayPaymentId':_0x5d17b2}});const _0x51abf7=_0x43e100(0x173)+_0x3a078e['id'];return console['log'](_0x43e100(0x1b1)+_0x51abf7),{'paymentId':_0x3a078e['id'],'paymentUrl':_0x51abf7,'expiresAt':_0x3a078e['expiresAt']||undefined};}else{if(_0xe785e[_0x43e100(0x188)]===_0x43e100(0x15d)){const _0x21976b=await this['nodaService'][_0x43e100(0x1b9)]({'paymentId':_0x3a078e['id'],'orderId':_0xabc646,'name':'Order\x20ID:\x20'+_0xabc646,'paymentDescription':_0x43e100(0x1d3)+_0xabc646,'amount':_0x245805,'currency':_0xe785e[_0x43e100(0x1c5)],'webhookUrl':_0x43e100(0x184),'returnUrl':_0xe4461d,'expiryDate':_0xe785e[_0x43e100(0x1df)]?.['toISOString']()});_0x5d17b2=_0x21976b[_0x43e100(0x1a5)],_0x5470a8=_0x21976b['payment_url'],await database_1[_0x43e100(0x1ed)][_0x43e100(0x185)][_0x43e100(0x1f5)]({'where':{'id':_0x3a078e['id']},'data':{'externalPaymentUrl':_0x5470a8,'gatewayPaymentId':_0x5d17b2,'qrUrl':_0x21976b[_0x43e100(0x19f)]}});const _0x111547=_0x43e100(0x173)+_0x3a078e['id'];return console[_0x43e100(0x1d5)](_0x43e100(0x18b)+_0x111547),{'paymentId':_0x3a078e['id'],'paymentUrl':_0x111547,'expiresAt':_0x3a078e[_0x43e100(0x1df)]||undefined};}else{if(_0xe785e[_0x43e100(0x188)]===_0x43e100(0x17b)){console[_0x43e100(0x1d5)](_0x43e100(0x1b0)+_0xabc646+_0x43e100(0x177)),console['log'](_0x43e100(0x1af)+_0x245805+'\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)');const _0xd8a78b=await this[_0x43e100(0x192)][_0x43e100(0x1b9)]({'paymentId':_0x3a078e['id'],'orderId':_0xabc646,'amount':_0x245805});_0x5d17b2=_0xd8a78b[_0x43e100(0x1a5)],_0x5470a8=_0xd8a78b[_0x43e100(0x1b5)],await database_1[_0x43e100(0x1ed)][_0x43e100(0x185)]['update']({'where':{'id':_0x3a078e['id']},'data':{'externalPaymentUrl':_0x5470a8,'gatewayPaymentId':_0x5d17b2}});const _0x1e9a7a='https://tesoft.uk/gateway/payment.php?id='+_0x3a078e['id'];return console[_0x43e100(0x1d5)](_0x43e100(0x1bc)+_0x1e9a7a),{'paymentId':_0x3a078e['id'],'paymentUrl':_0x1e9a7a,'expiresAt':_0x3a078e[_0x43e100(0x1df)]||undefined};}else{if(_0xe785e['gateway'][_0x43e100(0x172)](_0x43e100(0x16e))){const _0x4ae60e=(0x0,gateway_1[_0x43e100(0x1a2)])(_0xe785e[_0x43e100(0x188)]);if(!_0x4ae60e)throw new Error(_0x43e100(0x1e7)+_0xe785e['gateway']);console[_0x43e100(0x1d5)](_0x43e100(0x1e2)+_0x4ae60e+'\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0xabc646+_0x43e100(0x177)),console['log'](_0x43e100(0x1af)+_0x245805+'\x20'+_0xe785e[_0x43e100(0x1c5)]+_0x43e100(0x1c0)+_0x4ae60e+')');const _0x3cd356=await this['klymeService'][_0x43e100(0x1b9)]({'paymentId':_0x3a078e['id'],'orderId':_0xabc646,'amount':_0x245805,'currency':_0xe785e[_0x43e100(0x1c5)],'region':_0x4ae60e,'redirectUrl':_0xe4461d});_0x5d17b2=_0x3cd356[_0x43e100(0x1a5)],_0x5470a8=_0x3cd356[_0x43e100(0x1b5)],await database_1[_0x43e100(0x1ed)][_0x43e100(0x185)][_0x43e100(0x1f5)]({'where':{'id':_0x3a078e['id']},'data':{'externalPaymentUrl':_0x5470a8,'gatewayPaymentId':_0x5d17b2}});const _0x271066=_0x43e100(0x1c2)+_0x3a078e['id'];return console[_0x43e100(0x1d5)](_0x43e100(0x1b2)+_0x4ae60e+'\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20'+_0xabc646),console['log'](_0x43e100(0x1f1)+_0x4ae60e+_0x43e100(0x1b6)+_0x271066),{'paymentId':_0x3a078e['id'],'paymentUrl':_0x271066,'expiresAt':_0x3a078e[_0x43e100(0x1df)]||undefined};}else throw new Error(_0x43e100(0x1bb)+_0xe785e[_0x43e100(0x188)]);}}}}}catch(_0x35970d){await database_1[_0x43e100(0x1ed)][_0x43e100(0x185)][_0x43e100(0x1f5)]({'where':{'id':_0x3a078e['id']},'data':{'status':_0x43e100(0x1da)}});throw new Error(_0x43e100(0x1d7)+(_0x35970d instanceof Error?_0x35970d[_0x43e100(0x175)]:_0x43e100(0x1f2)));}}async[a45_0x6f0378(0x189)](_0xcbe7f4){const _0x37eeb9=a45_0x6f0378,_0x24ef68=await database_1[_0x37eeb9(0x1ed)][_0x37eeb9(0x185)]['findUnique']({'where':{'id':_0xcbe7f4},'include':{'paymentLink':!![]}});if(!_0x24ef68||!_0x24ef68[_0x37eeb9(0x1b7)])return;const _0x4d7cac=await database_1[_0x37eeb9(0x1ed)][_0x37eeb9(0x1b7)][_0x37eeb9(0x1f5)]({'where':{'id':_0x24ef68['paymentLinkId']},'data':{'currentPayments':{'increment':0x1}}});console['log'](_0x37eeb9(0x1b8)+_0x24ef68['paymentLinkId']+_0x37eeb9(0x1e9)+_0x4d7cac[_0x37eeb9(0x163)]+'/'+_0x4d7cac[_0x37eeb9(0x19c)]),_0x4d7cac[_0x37eeb9(0x163)]>=_0x4d7cac['maxPayments']&&(await database_1['default'][_0x37eeb9(0x1b7)][_0x37eeb9(0x1f5)]({'where':{'id':_0x24ef68['paymentLinkId']},'data':{'status':_0x37eeb9(0x1f4)}}),console['log'](_0x37eeb9(0x1c9)+_0x24ef68[_0x37eeb9(0x181)]+_0x37eeb9(0x158)));}async[a45_0x6f0378(0x15b)](_0x2d5df3){const _0x106556=a45_0x6f0378,[_0x390044,_0x3c3f7c,_0x4e52ce,_0x381485]=await Promise[_0x106556(0x1ab)]([database_1[_0x106556(0x1ed)][_0x106556(0x1b7)][_0x106556(0x19a)]({'where':{'shopId':_0x2d5df3}}),database_1[_0x106556(0x1ed)][_0x106556(0x1b7)]['count']({'where':{'shopId':_0x2d5df3,'status':_0x106556(0x1eb)}}),database_1['default'][_0x106556(0x185)]['count']({'where':{'shopId':_0x2d5df3,'paymentLinkId':{'not':null}}}),database_1['default'][_0x106556(0x185)][_0x106556(0x190)]({'where':{'shopId':_0x2d5df3,'paymentLinkId':{'not':null},'status':'PAID'},'select':{'amount':!![],'currency':!![]}})]);let _0x3e067d=0x0;for(const _0x396d16 of _0x381485){const _0x458a26=await currencyService_1['currencyService']['convertToUSDT'](_0x396d16[_0x106556(0x1e3)],_0x396d16['currency']);_0x3e067d+=_0x458a26;}const _0x333722=_0x4e52ce>0x0?_0x381485['length']/_0x4e52ce*0x64:0x0;return{'totalLinks':_0x390044,'activeLinks':_0x3c3f7c,'totalPayments':_0x4e52ce,'totalRevenue':Math[_0x106556(0x165)](_0x3e067d*0x64)/0x64,'conversionRate':Math[_0x106556(0x165)](_0x333722*0x64)/0x64};}[a45_0x6f0378(0x1c8)](_0x171abe){const _0x10075d=a45_0x6f0378;return{'id':_0x171abe['id'],'shopId':_0x171abe[_0x10075d(0x1ea)],'amount':_0x171abe[_0x10075d(0x1e3)],'currency':_0x171abe[_0x10075d(0x1c5)],'sourceCurrency':_0x171abe[_0x10075d(0x1d0)]||undefined,'gateway':_0x171abe[_0x10075d(0x188)],'maxPayments':_0x171abe[_0x10075d(0x19c)],'currentPayments':_0x171abe['currentPayments'],'status':_0x171abe[_0x10075d(0x1a3)],'expiresAt':_0x171abe['expiresAt']||undefined,'successUrl':_0x171abe[_0x10075d(0x1ca)]||undefined,'failUrl':_0x171abe['failUrl']||undefined,'country':_0x171abe[_0x10075d(0x1d2)]||undefined,'language':_0x171abe[_0x10075d(0x1e0)]||undefined,'linkUrl':'https://app.trapay.uk/link/'+_0x171abe['id'],'createdAt':_0x171abe[_0x10075d(0x1a8)],'updatedAt':_0x171abe['updatedAt'],'shop':_0x171abe[_0x10075d(0x1f7)],'payments':_0x171abe[_0x10075d(0x1ce)]};}}exports['PaymentLinkService']=PaymentLinkService;