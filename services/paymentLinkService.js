'use strict';const a44_0x43acf3=a44_0x2dc2;(function(_0x1bf294,_0x482cfc){const _0x1772e6=a44_0x2dc2,_0x597546=_0x1bf294();while(!![]){try{const _0x40df73=-parseInt(_0x1772e6(0x23b))/0x1*(parseInt(_0x1772e6(0x1ef))/0x2)+-parseInt(_0x1772e6(0x235))/0x3+parseInt(_0x1772e6(0x25b))/0x4*(-parseInt(_0x1772e6(0x25c))/0x5)+parseInt(_0x1772e6(0x216))/0x6+parseInt(_0x1772e6(0x242))/0x7+parseInt(_0x1772e6(0x237))/0x8+-parseInt(_0x1772e6(0x212))/0x9;if(_0x40df73===_0x482cfc)break;else _0x597546['push'](_0x597546['shift']());}catch(_0x21bacd){_0x597546['push'](_0x597546['shift']());}}}(a44_0x28ba,0x2d144));function a44_0x2dc2(_0x30cda3,_0x4e43d1){const _0x28ba89=a44_0x28ba();return a44_0x2dc2=function(_0x2dc247,_0x35cd9c){_0x2dc247=_0x2dc247-0x1d8;let _0x40f967=_0x28ba89[_0x2dc247];return _0x40f967;},a44_0x2dc2(_0x30cda3,_0x4e43d1);}function a44_0x28ba(){const _0xbb38a=['payments','❌\x20DB\x20Fail\x20URL:\x20','🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/','update','country','rapyd','\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20','findUnique','\x20completed\x20(reached\x20max\x20payments)','delete','insensitive','\x20payment\x20URL:\x20','👤\x20Customer:\x20','🔗\x20Rapyd\x20payment\x20URL:\x20','__esModule','qr_code','\x20(8digits-8digits\x20format\x20for\x20','https://app.trapay.uk/payment/success','Unsupported\x20KLYME\x20region:\x20','log','🔗\x20Generated\x20URLs\x20for\x20','noda','1830420ARZLca','toUpperCase','💾\x20DB\x20Success\x20URL:\x20','handleSuccessfulPayment','1385922TDBRnV','🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','sourceCurrency','RapydService','https://tesoft.uk/gateway/payment.php?id=','getGatewayNameById','PLACEHOLDER','failUrl','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','generateGatewayUrls','createPayment','/gateway/success.php?id=','currencyService','toISOString','Payment\x20','cointopay','💰\x20Fixed\x20amount:\x20','💰\x20Amount:\x20','🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','payment','getKlymeRegionFromGatewayName','USD','https://app.trapay.uk/payment/pending','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','FAILED','Unsupported\x20gateway:\x20','PlisioService','gateway_payment_id','__importDefault','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','amount\x20is\x20required\x20and\x20must\x20be\x20positive','136374wZBHNg','message','1523544LLSUQl','✅\x20Payment\x20link\x20created:\x20','./gateways/rapydService','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','1326dteuGg','maxPayments','https://app.trapay.uk/payment/fail','Invalid\x20KLYME\x20gateway:\x20','paymentLink','count','CoinToPayService','1777167PHeTrF','🎯\x20Generated\x20gateway\x20order_id:\x20','https://app.trapay.uk/payment/','desc','https://tesoft.uk','findMany','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Payment\x20link\x20has\x20expired','padStart','expiresAt','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','💰\x20Plisio\x20payment\x20link\x20mapping:','paymentLinkId','Anonymous','https://app.trapay.uk/link/','no\x20email','qr_code_url','KLYME\x20payment\x20creation\x20is\x20only\x20supported\x20for\x20EU\x20and\x20GB\x20regions,\x20got:\x20','plisioService','currentPayments','shop','../types/gateway','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','getPaymentLinkById','klyme_','24796sPhXGj','25nFKuDE','successUrl','EUR','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','plisio','KLYME\x20payment\x20links\x20are\x20only\x20supported\x20for\x20EU\x20and\x20GB\x20regions,\x20got:\x20','validateKlymeCurrency','rapydService','defineProperty','/gateway/fail.php?id=','Unknown\x20error','createdAt','ACTIVE','/gateway/pending.php?id=','formatPaymentLinkResponse','updatePaymentLink','GBP','COMPLETED','updatedAt','getPublicPaymentLinkData','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','./gateways/nodaService','nodaService','🔗\x20Plisio\x20payment\x20URL:\x20','💳\x20Creating\x20KLYME\x20','📈\x20Payment\x20link\x20','round','startsWith','🔗\x20CoinToPay\x20payment\x20URL:\x20','toLowerCase','../config/database','default','shopId','payment_url','currency','Payment\x20link\x20is\x20not\x20active','convertToUSDT','language','\x20payments:\x20','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','findFirst','https://tesoft.uk/gateways/noda/webhook','ONCE','max','createPaymentLink','isValidGatewayId','length','Gateway\x20error:\x20','amount','318bsvgiK','BASE_URL','Payment\x20link\x20has\x20reached\x20maximum\x20payments','ceil','💾\x20Payment\x20created\x20from\x20link:\x20','\x20(8digits-8digits\x20format)','coinToPayService','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','status','NodaService','gateway','PENDING','./gateways/coinToPayService'];a44_0x28ba=function(){return _0xbb38a;};return a44_0x28ba();}var __importDefault=this&&this[a44_0x43acf3(0x232)]||function(_0x4e9ae7){const _0x2112e3=a44_0x43acf3;return _0x4e9ae7&&_0x4e9ae7[_0x2112e3(0x20a)]?_0x4e9ae7:{'default':_0x4e9ae7};};Object[a44_0x43acf3(0x264)](exports,a44_0x43acf3(0x20a),{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require(a44_0x43acf3(0x1dc))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a44_0x43acf3(0x239)),nodaService_1=require(a44_0x43acf3(0x272)),coinToPayService_1=require(a44_0x43acf3(0x1fb)),klymeService_1=require('./gateways/klymeService'),gateway_1=require(a44_0x43acf3(0x257)),currencyService_1=require('./currencyService');class PaymentLinkService{constructor(){const _0x4c88a6=a44_0x43acf3;this[_0x4c88a6(0x254)]=new plisioService_1[(_0x4c88a6(0x230))](),this[_0x4c88a6(0x263)]=new rapydService_1[(_0x4c88a6(0x219))](),this[_0x4c88a6(0x273)]=new nodaService_1[(_0x4c88a6(0x1f8))](),this['coinToPayService']=new coinToPayService_1[(_0x4c88a6(0x241))](),this['klymeService']=new klymeService_1['KlymeService']();}['generateGatewayOrderId'](){const _0x4e7d23=()=>{const _0x23c939=a44_0x2dc2;return Math['floor'](Math['random']()*0x5f5e100)['toString']()[_0x23c939(0x24a)](0x8,'0');};return _0x4e7d23()+'-'+_0x4e7d23();}[a44_0x43acf3(0x21f)](_0x4fe7db,_0x26470,_0x13c6a7,_0x21c4b0,_0x3207c0){const _0x3c2246=a44_0x43acf3;if(_0x21c4b0&&_0x3207c0)return{'finalSuccessUrl':_0x21c4b0,'finalFailUrl':_0x3207c0,'dbSuccessUrl':_0x21c4b0,'dbFailUrl':_0x3207c0};let _0x48d8c9,_0x3a9aac,_0xdc143,_0x5858f3;return _0x4fe7db==='noda'||_0x4fe7db[_0x3c2246(0x1d9)](_0x3c2246(0x25a))?(_0x48d8c9=_0x13c6a7+_0x3c2246(0x269)+_0x26470,_0xdc143=_0x3c2246(0x22c)):(_0x48d8c9=_0x13c6a7+_0x3c2246(0x221)+_0x26470,_0xdc143=_0x3c2246(0x20d)),_0x3a9aac=_0x13c6a7+_0x3c2246(0x265)+_0x26470,_0x5858f3=_0x3c2246(0x23d),console[_0x3c2246(0x20f)](_0x3c2246(0x210)+_0x4fe7db+':'),console[_0x3c2246(0x20f)](_0x3c2246(0x21e)+_0x48d8c9),console['log'](_0x3c2246(0x270)+_0x3a9aac),console[_0x3c2246(0x20f)]('\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20'+_0xdc143),console[_0x3c2246(0x20f)](_0x3c2246(0x202)+_0x5858f3),{'finalSuccessUrl':_0x48d8c9,'finalFailUrl':_0x3a9aac,'dbSuccessUrl':_0xdc143,'dbFailUrl':_0x5858f3};}[a44_0x43acf3(0x262)](_0x4ee504,_0x36aede){const _0x5e86bb=a44_0x43acf3;if(!_0x4ee504[_0x5e86bb(0x1d9)](_0x5e86bb(0x25a)))return;const _0x2ec294=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x4ee504),_0x41ac51=_0x36aede[_0x5e86bb(0x213)]();switch(_0x2ec294){case'EU':if(_0x41ac51!==_0x5e86bb(0x25e))throw new Error(_0x5e86bb(0x248)+_0x41ac51);break;case'GB':if(_0x41ac51!==_0x5e86bb(0x26c))throw new Error(_0x5e86bb(0x1f6)+_0x41ac51);break;case'DE':if(_0x41ac51!==_0x5e86bb(0x25e))throw new Error(_0x5e86bb(0x23a)+_0x41ac51);break;default:throw new Error(_0x5e86bb(0x20e)+_0x2ec294);}}async['createPaymentLink'](_0x3206a8,_0x30ef6b){const _0x468d2a=a44_0x43acf3;if(!(0x0,gateway_1[_0x468d2a(0x1eb)])(_0x30ef6b[_0x468d2a(0x1f9)]))throw new Error('Invalid\x20gateway\x20ID:\x20'+_0x30ef6b['gateway']+_0x468d2a(0x258));const _0x281b19=(0x0,gateway_1['getGatewayNameById'])(_0x30ef6b[_0x468d2a(0x1f9)]);if(!_0x281b19)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x30ef6b[_0x468d2a(0x1f9)]);console['log'](_0x468d2a(0x228)+_0x281b19);if(_0x281b19===_0x468d2a(0x260)&&!_0x30ef6b['sourceCurrency'])throw new Error(_0x468d2a(0x24c));if(_0x281b19[_0x468d2a(0x1d9)](_0x468d2a(0x25a))){const _0x4cf2bc=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x281b19);if(_0x4cf2bc!=='EU'&&_0x4cf2bc!=='GB')throw new Error(_0x468d2a(0x261)+_0x4cf2bc);}let _0x3d21f7=_0x30ef6b[_0x468d2a(0x200)];_0x281b19===_0x468d2a(0x201)&&(_0x3d21f7='GB',console[_0x468d2a(0x20f)](_0x468d2a(0x233)));if(!_0x30ef6b[_0x468d2a(0x1ee)]||_0x30ef6b[_0x468d2a(0x1ee)]<=0x0)throw new Error(_0x468d2a(0x234));let _0xffe69=_0x30ef6b[_0x468d2a(0x1e0)]||_0x468d2a(0x22b);_0x281b19===_0x468d2a(0x225)&&(_0xffe69=_0x468d2a(0x25e),console[_0x468d2a(0x20f)](_0x468d2a(0x217)));this[_0x468d2a(0x262)](_0x281b19,_0xffe69);const _0xb0bb64=process['env']['BASE_URL']||'https://tesoft.uk',{finalSuccessUrl:_0x109dc3,finalFailUrl:_0x2fd841,dbSuccessUrl:_0x3e0653,dbFailUrl:_0x3a33fa}=this[_0x468d2a(0x21f)](_0x281b19,_0x468d2a(0x21c),_0xb0bb64,_0x30ef6b[_0x468d2a(0x25d)],_0x30ef6b['failUrl']),_0xda70c4=await database_1[_0x468d2a(0x1dd)][_0x468d2a(0x23f)]['create']({'data':{'shopId':_0x3206a8,'amount':_0x30ef6b['amount'],'currency':_0xffe69,'sourceCurrency':_0x30ef6b[_0x468d2a(0x218)]||undefined,'gateway':_0x281b19,'maxPayments':_0x30ef6b[_0x468d2a(0x23c)]||0x1,'currentPayments':0x0,'status':_0x468d2a(0x268),'expiresAt':_0x30ef6b[_0x468d2a(0x24b)]?new Date(_0x30ef6b['expiresAt']):undefined,'successUrl':_0x3e0653,'failUrl':_0x3a33fa,'country':_0x3d21f7,'language':_0x30ef6b[_0x468d2a(0x1e3)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x468d2a(0x20f)](_0x468d2a(0x238)+_0xda70c4['id']+'\x20('+_0x281b19+')'),console[_0x468d2a(0x20f)](_0x468d2a(0x226)+_0xda70c4[_0x468d2a(0x1ee)]+'\x20'+_0xda70c4[_0x468d2a(0x1e0)]),console[_0x468d2a(0x20f)](_0x468d2a(0x1fe)+_0xda70c4['id']),console[_0x468d2a(0x20f)]('✅\x20DB\x20Success\x20URL:\x20'+_0xda70c4['successUrl']),console['log'](_0x468d2a(0x1fd)+_0xda70c4['failUrl']),this[_0x468d2a(0x26a)](_0xda70c4);}async['getPaymentLinks'](_0x222e65,_0x266c19){const _0x1b437e=a44_0x43acf3,{page:_0x33a78a,limit:_0xa7b807,status:_0x34d2ca,gateway:_0x409ffc,search:_0x57f618}=_0x266c19,_0x570854=(_0x33a78a-0x1)*_0xa7b807,_0x188d68={'shopId':_0x222e65};_0x34d2ca&&(_0x188d68[_0x1b437e(0x1f7)]=_0x34d2ca[_0x1b437e(0x213)]());if(_0x409ffc){if((0x0,gateway_1[_0x1b437e(0x1eb)])(_0x409ffc)){const _0x273a3e=(0x0,gateway_1[_0x1b437e(0x21b)])(_0x409ffc);_0x273a3e&&(_0x188d68[_0x1b437e(0x1f9)]=_0x273a3e);}else _0x188d68[_0x1b437e(0x1f9)]=_0x409ffc[_0x1b437e(0x1db)]();}_0x57f618&&(_0x188d68['OR']=[{'gateway':{'contains':_0x57f618,'mode':_0x1b437e(0x206)}},{'currency':{'contains':_0x57f618,'mode':_0x1b437e(0x206)}}]);const [_0x27c378,_0x3889c9]=await Promise['all']([database_1[_0x1b437e(0x1dd)][_0x1b437e(0x23f)][_0x1b437e(0x247)]({'where':_0x188d68,'skip':_0x570854,'take':_0xa7b807,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x1b437e(0x245)},'take':0xa}}}),database_1[_0x1b437e(0x1dd)][_0x1b437e(0x23f)][_0x1b437e(0x240)]({'where':_0x188d68})]);return{'links':_0x27c378['map'](_0x668465=>this[_0x1b437e(0x26a)](_0x668465)),'pagination':{'page':_0x33a78a,'limit':_0xa7b807,'total':_0x3889c9,'totalPages':Math[_0x1b437e(0x1f2)](_0x3889c9/_0xa7b807)}};}async[a44_0x43acf3(0x259)](_0x60a121,_0x3fef40){const _0x372fd1=a44_0x43acf3,_0x4616cf=await database_1[_0x372fd1(0x1dd)][_0x372fd1(0x23f)][_0x372fd1(0x1e6)]({'where':{'id':_0x3fef40,'shopId':_0x60a121},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x372fd1(0x245)}}}});if(!_0x4616cf)return null;return this[_0x372fd1(0x26a)](_0x4616cf);}async[a44_0x43acf3(0x26b)](_0x4ac963,_0x428250,_0x130dea){const _0x56c4bd=a44_0x43acf3,_0x5bf278={..._0x130dea};if(_0x130dea[_0x56c4bd(0x1f9)]){if((0x0,gateway_1['isValidGatewayId'])(_0x130dea['gateway'])){const _0x4b4a3b=(0x0,gateway_1[_0x56c4bd(0x21b)])(_0x130dea[_0x56c4bd(0x1f9)]);_0x4b4a3b&&(_0x5bf278[_0x56c4bd(0x1f9)]=_0x4b4a3b);}else _0x5bf278[_0x56c4bd(0x1f9)]=_0x130dea[_0x56c4bd(0x1f9)][_0x56c4bd(0x1db)]();}(_0x5bf278[_0x56c4bd(0x1f9)]==='rapyd'||_0x130dea[_0x56c4bd(0x200)]&&_0x5bf278[_0x56c4bd(0x1f9)]!==_0x56c4bd(0x201))&&(_0x5bf278[_0x56c4bd(0x1f9)]==='rapyd'&&(_0x5bf278[_0x56c4bd(0x200)]='GB',console[_0x56c4bd(0x20f)]('🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update')));_0x5bf278[_0x56c4bd(0x1f9)]==='cointopay'&&(_0x5bf278[_0x56c4bd(0x1e0)]='EUR',console[_0x56c4bd(0x20f)](_0x56c4bd(0x271)));_0x5bf278[_0x56c4bd(0x1f9)]&&_0x5bf278['currency']&&this[_0x56c4bd(0x262)](_0x5bf278[_0x56c4bd(0x1f9)],_0x5bf278[_0x56c4bd(0x1e0)]);_0x130dea['expiresAt']&&(_0x5bf278['expiresAt']=new Date(_0x130dea[_0x56c4bd(0x24b)]));const _0x15be4f=await database_1[_0x56c4bd(0x1dd)][_0x56c4bd(0x23f)][_0x56c4bd(0x1ff)]({'where':{'id':_0x428250,'shopId':_0x4ac963},'data':_0x5bf278,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x56c4bd(0x245)},'take':0xa}}});return this[_0x56c4bd(0x26a)](_0x15be4f);}async['deletePaymentLink'](_0x1c0b0c,_0x57eb96){const _0x629faa=a44_0x43acf3;await database_1[_0x629faa(0x1dd)][_0x629faa(0x23f)][_0x629faa(0x205)]({'where':{'id':_0x57eb96,'shopId':_0x1c0b0c}});}async[a44_0x43acf3(0x26f)](_0x3a32c7){const _0x3e0813=a44_0x43acf3,_0x1cb50e=await database_1['default']['paymentLink'][_0x3e0813(0x203)]({'where':{'id':_0x3a32c7},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x1cb50e)return null;const _0x235a34=_0x1cb50e[_0x3e0813(0x24b)]&&_0x1cb50e[_0x3e0813(0x24b)]<new Date(),_0x516abf=_0x1cb50e[_0x3e0813(0x255)]>=_0x1cb50e[_0x3e0813(0x23c)],_0x573b8f=_0x1cb50e[_0x3e0813(0x256)]['status']===_0x3e0813(0x268),_0x50cbb9=_0x1cb50e[_0x3e0813(0x1f7)]===_0x3e0813(0x268),_0x32130e=!_0x235a34&&!_0x516abf&&_0x573b8f&&_0x50cbb9,_0x1bb38b=Math[_0x3e0813(0x1e9)](0x0,_0x1cb50e[_0x3e0813(0x23c)]-_0x1cb50e[_0x3e0813(0x255)]);return{'id':_0x1cb50e['id'],'amount':_0x1cb50e['amount'],'currency':_0x1cb50e['currency'],'sourceCurrency':_0x1cb50e['sourceCurrency']||undefined,'gateway':_0x1cb50e['gateway'],'maxPayments':_0x1cb50e[_0x3e0813(0x23c)],'currentPayments':_0x1cb50e[_0x3e0813(0x255)],'status':_0x1cb50e[_0x3e0813(0x1f7)],'expiresAt':_0x1cb50e[_0x3e0813(0x24b)]||undefined,'shopName':_0x1cb50e['shop']['name'],'isAvailable':_0x32130e,'remainingPayments':_0x1bb38b};}async['initiatePaymentFromLink'](_0x5d1ddc){const _0x346815=a44_0x43acf3,{linkId:_0x3af228,customerEmail:_0x3b2ea4,customerName:_0xc2d48e}=_0x5d1ddc,_0x1fdab8=await database_1[_0x346815(0x1dd)][_0x346815(0x23f)][_0x346815(0x203)]({'where':{'id':_0x3af228},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![]}}}});if(!_0x1fdab8)throw new Error('Payment\x20link\x20not\x20found');const _0x29dbd9=_0x1fdab8[_0x346815(0x24b)]&&_0x1fdab8[_0x346815(0x24b)]<new Date(),_0x1e3d68=_0x1fdab8[_0x346815(0x255)]>=_0x1fdab8['maxPayments'],_0x1d4b0c=_0x1fdab8[_0x346815(0x256)][_0x346815(0x1f7)]===_0x346815(0x268),_0x4b98b5=_0x1fdab8[_0x346815(0x1f7)]===_0x346815(0x268);if(_0x29dbd9)throw new Error(_0x346815(0x249));if(_0x1e3d68)throw new Error(_0x346815(0x1f1));if(!_0x1d4b0c)throw new Error('Shop\x20is\x20not\x20active');if(!_0x4b98b5)throw new Error(_0x346815(0x1e1));const _0x174557=_0x1fdab8[_0x346815(0x1ee)];console[_0x346815(0x20f)]('💳\x20Initiating\x20payment\x20from\x20link\x20'+_0x3af228+':\x20'+_0x174557+'\x20'+_0x1fdab8[_0x346815(0x1e0)]),console[_0x346815(0x20f)](_0x346815(0x208)+(_0xc2d48e||'Anonymous')+'\x20('+(_0x3b2ea4||'no\x20email')+')'),this[_0x346815(0x262)](_0x1fdab8[_0x346815(0x1f9)],_0x1fdab8[_0x346815(0x1e0)]);const _0x328abb=this['generateGatewayOrderId']();console[_0x346815(0x20f)](_0x346815(0x243)+_0x328abb+_0x346815(0x20c)+_0x1fdab8[_0x346815(0x1f9)]+')');const _0x4ece87=process['env'][_0x346815(0x1f0)]||_0x346815(0x246),{finalSuccessUrl:_0x3425ba,finalFailUrl:_0x490864,dbSuccessUrl:_0x2ab25b,dbFailUrl:_0x30f9b9}=this[_0x346815(0x21f)](_0x1fdab8[_0x346815(0x1f9)],_0x328abb,_0x4ece87,_0x1fdab8['successUrl']||undefined,_0x1fdab8[_0x346815(0x21d)]||undefined),_0x274c3a=await database_1['default'][_0x346815(0x229)]['create']({'data':{'shopId':_0x1fdab8['shopId'],'paymentLinkId':_0x1fdab8['id'],'gateway':_0x1fdab8[_0x346815(0x1f9)],'amount':_0x174557,'currency':_0x1fdab8[_0x346815(0x1e0)],'sourceCurrency':_0x1fdab8[_0x346815(0x218)]||undefined,'usage':_0x346815(0x1e8),'expiresAt':_0x1fdab8[_0x346815(0x24b)]||undefined,'successUrl':_0x2ab25b,'failUrl':_0x30f9b9,'status':_0x346815(0x1fa),'orderId':null,'gatewayOrderId':_0x328abb,'customerEmail':_0x3b2ea4||undefined,'customerName':_0xc2d48e||undefined,'country':_0x1fdab8[_0x346815(0x200)]||undefined,'language':_0x1fdab8['language']||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x346815(0x20f)](_0x346815(0x1f3)+_0x274c3a['id']),console[_0x346815(0x20f)](_0x346815(0x227)+_0x174557+'\x20'+_0x1fdab8[_0x346815(0x1e0)]),console[_0x346815(0x20f)]('👤\x20Customer:\x20'+(_0xc2d48e||_0x346815(0x24f))+'\x20('+(_0x3b2ea4||_0x346815(0x251))+')'),console[_0x346815(0x20f)](_0x346815(0x214)+_0x2ab25b),console[_0x346815(0x20f)]('💾\x20DB\x20Fail\x20URL:\x20'+_0x30f9b9);let _0x5a1737,_0x53d24b;try{if(_0x1fdab8[_0x346815(0x1f9)]===_0x346815(0x260)){console['log'](_0x346815(0x24d)),console[_0x346815(0x20f)]('\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20'+_0x1fdab8['currency']),console['log'](_0x346815(0x1e5)+_0x1fdab8[_0x346815(0x218)]);const _0x54f0a3=await this['plisioService'][_0x346815(0x220)]({'paymentId':_0x274c3a['id'],'orderId':_0x328abb,'amount':_0x174557,'currency':_0x1fdab8[_0x346815(0x1e0)],'productName':_0x346815(0x224)+_0x174557+'\x20'+_0x1fdab8[_0x346815(0x1e0)],'description':_0x346815(0x224)+_0x174557+'\x20'+_0x1fdab8['currency'],'successUrl':_0x3425ba,'failUrl':_0x490864,'customerEmail':_0x3b2ea4||undefined,'customerName':_0xc2d48e||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x1fdab8[_0x346815(0x218)]||undefined});_0x5a1737=_0x54f0a3[_0x346815(0x231)],_0x53d24b=_0x54f0a3[_0x346815(0x1df)],await database_1[_0x346815(0x1dd)][_0x346815(0x229)][_0x346815(0x1ff)]({'where':{'id':_0x274c3a['id']},'data':{'externalPaymentUrl':_0x53d24b,'gatewayPaymentId':_0x5a1737,'invoiceTotalSum':_0x54f0a3['invoice_total_sum'],'qrCode':_0x54f0a3[_0x346815(0x20b)],'qrUrl':_0x54f0a3['qr_url']}});const _0x158412=_0x346815(0x244)+_0x274c3a['id'];return console[_0x346815(0x20f)](_0x346815(0x274)+_0x158412),{'paymentId':_0x274c3a['id'],'paymentUrl':_0x158412,'expiresAt':_0x274c3a[_0x346815(0x24b)]||undefined};}else{if(_0x1fdab8[_0x346815(0x1f9)]===_0x346815(0x201)){const _0x47c99e=await this['rapydService'][_0x346815(0x1ea)]({'paymentId':_0x274c3a['id'],'orderId':_0x328abb,'orderName':_0x346815(0x224)+_0x174557+'\x20'+_0x1fdab8['currency'],'amount':_0x174557,'currency':_0x1fdab8[_0x346815(0x1e0)],'country':_0x1fdab8[_0x346815(0x200)],'language':_0x1fdab8[_0x346815(0x1e3)]||'EN','amountIsEditable':![],'usage':_0x346815(0x1e8),'maxPayments':0x1,'successUrl':_0x3425ba,'failUrl':_0x490864});_0x5a1737=_0x47c99e[_0x346815(0x231)],_0x53d24b=_0x47c99e[_0x346815(0x1df)],await database_1[_0x346815(0x1dd)]['payment'][_0x346815(0x1ff)]({'where':{'id':_0x274c3a['id']},'data':{'externalPaymentUrl':_0x53d24b,'gatewayPaymentId':_0x5a1737}});const _0x4eb004=_0x346815(0x21a)+_0x274c3a['id'];return console[_0x346815(0x20f)](_0x346815(0x209)+_0x4eb004),{'paymentId':_0x274c3a['id'],'paymentUrl':_0x4eb004,'expiresAt':_0x274c3a['expiresAt']||undefined};}else{if(_0x1fdab8[_0x346815(0x1f9)]===_0x346815(0x211)){const _0x2cea02=await this[_0x346815(0x273)]['createPaymentLink']({'paymentId':_0x274c3a['id'],'orderId':_0x328abb,'name':_0x346815(0x224)+_0x174557+'\x20'+_0x1fdab8[_0x346815(0x1e0)],'paymentDescription':_0x346815(0x224)+_0x174557+'\x20'+_0x1fdab8[_0x346815(0x1e0)],'amount':_0x174557,'currency':_0x1fdab8[_0x346815(0x1e0)],'webhookUrl':_0x346815(0x1e7),'returnUrl':_0x3425ba,'expiryDate':_0x1fdab8[_0x346815(0x24b)]?.[_0x346815(0x223)]()});_0x5a1737=_0x2cea02[_0x346815(0x231)],_0x53d24b=_0x2cea02[_0x346815(0x1df)],await database_1['default'][_0x346815(0x229)][_0x346815(0x1ff)]({'where':{'id':_0x274c3a['id']},'data':{'externalPaymentUrl':_0x53d24b,'gatewayPaymentId':_0x5a1737,'qrUrl':_0x2cea02[_0x346815(0x252)]}});const _0x15e593=_0x346815(0x21a)+_0x274c3a['id'];return console[_0x346815(0x20f)]('🔗\x20Noda\x20payment\x20URL:\x20'+_0x15e593),{'paymentId':_0x274c3a['id'],'paymentUrl':_0x15e593,'expiresAt':_0x274c3a[_0x346815(0x24b)]||undefined};}else{if(_0x1fdab8[_0x346815(0x1f9)]===_0x346815(0x225)){console[_0x346815(0x20f)]('🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x328abb+_0x346815(0x1f4)),console[_0x346815(0x20f)]('💰\x20Amount:\x20'+_0x174557+'\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)');const _0x27506d=await this[_0x346815(0x1f5)][_0x346815(0x1ea)]({'paymentId':_0x274c3a['id'],'orderId':_0x328abb,'amount':_0x174557});_0x5a1737=_0x27506d[_0x346815(0x231)],_0x53d24b=_0x27506d[_0x346815(0x1df)],await database_1[_0x346815(0x1dd)][_0x346815(0x229)][_0x346815(0x1ff)]({'where':{'id':_0x274c3a['id']},'data':{'externalPaymentUrl':_0x53d24b,'gatewayPaymentId':_0x5a1737}});const _0x236a84='https://tesoft.uk/gateway/payment.php?id='+_0x274c3a['id'];return console[_0x346815(0x20f)](_0x346815(0x1da)+_0x236a84),{'paymentId':_0x274c3a['id'],'paymentUrl':_0x236a84,'expiresAt':_0x274c3a[_0x346815(0x24b)]||undefined};}else{if(_0x1fdab8[_0x346815(0x1f9)][_0x346815(0x1d9)](_0x346815(0x25a))){const _0x46a6cc=(0x0,gateway_1[_0x346815(0x22a)])(_0x1fdab8[_0x346815(0x1f9)]);if(!_0x46a6cc)throw new Error(_0x346815(0x23e)+_0x1fdab8['gateway']);if(_0x46a6cc!=='EU'&&_0x46a6cc!=='GB')throw new Error(_0x346815(0x253)+_0x46a6cc);console[_0x346815(0x20f)](_0x346815(0x275)+_0x46a6cc+_0x346815(0x25f)+_0x328abb+'\x20(8digits-8digits\x20format)'),console[_0x346815(0x20f)](_0x346815(0x227)+_0x174557+'\x20'+_0x1fdab8[_0x346815(0x1e0)]+'\x20(validated\x20for\x20'+_0x46a6cc+')');const _0x4ccd39=await this['klymeService'][_0x346815(0x1ea)]({'paymentId':_0x274c3a['id'],'orderId':_0x328abb,'amount':_0x174557,'currency':_0x1fdab8['currency'],'region':_0x46a6cc,'redirectUrl':_0x3425ba});_0x5a1737=_0x4ccd39[_0x346815(0x231)],_0x53d24b=_0x4ccd39[_0x346815(0x1df)],await database_1[_0x346815(0x1dd)]['payment'][_0x346815(0x1ff)]({'where':{'id':_0x274c3a['id']},'data':{'externalPaymentUrl':_0x53d24b,'gatewayPaymentId':_0x5a1737}});const _0xa33b40=_0x346815(0x244)+_0x274c3a['id'];return console[_0x346815(0x20f)]('✅\x20KLYME\x20'+_0x46a6cc+_0x346815(0x22d)+_0x328abb),console['log']('🔗\x20KLYME\x20'+_0x46a6cc+_0x346815(0x207)+_0xa33b40),{'paymentId':_0x274c3a['id'],'paymentUrl':_0xa33b40,'expiresAt':_0x274c3a[_0x346815(0x24b)]||undefined};}else throw new Error(_0x346815(0x22f)+_0x1fdab8[_0x346815(0x1f9)]);}}}}}catch(_0x274554){await database_1[_0x346815(0x1dd)][_0x346815(0x229)][_0x346815(0x1ff)]({'where':{'id':_0x274c3a['id']},'data':{'status':_0x346815(0x22e)}});throw new Error(_0x346815(0x1ed)+(_0x274554 instanceof Error?_0x274554[_0x346815(0x236)]:_0x346815(0x266)));}}async[a44_0x43acf3(0x215)](_0x277394){const _0x52563=a44_0x43acf3,_0x3575c7=await database_1['default'][_0x52563(0x229)][_0x52563(0x203)]({'where':{'id':_0x277394},'include':{'paymentLink':!![]}});if(!_0x3575c7||!_0x3575c7[_0x52563(0x23f)])return;const _0x434e24=await database_1[_0x52563(0x1dd)][_0x52563(0x23f)]['update']({'where':{'id':_0x3575c7[_0x52563(0x24e)]},'data':{'currentPayments':{'increment':0x1}}});console[_0x52563(0x20f)](_0x52563(0x276)+_0x3575c7[_0x52563(0x24e)]+_0x52563(0x1e4)+_0x434e24['currentPayments']+'/'+_0x434e24[_0x52563(0x23c)]),_0x434e24[_0x52563(0x255)]>=_0x434e24[_0x52563(0x23c)]&&(await database_1[_0x52563(0x1dd)][_0x52563(0x23f)][_0x52563(0x1ff)]({'where':{'id':_0x3575c7[_0x52563(0x24e)]},'data':{'status':_0x52563(0x26d)}}),console['log']('🏁\x20Payment\x20link\x20'+_0x3575c7[_0x52563(0x24e)]+_0x52563(0x204)));}async['getPaymentLinkStatistics'](_0x22ef83){const _0x59909b=a44_0x43acf3,[_0x5ac3c6,_0x22e6a8,_0x127994,_0x546463]=await Promise['all']([database_1['default'][_0x59909b(0x23f)][_0x59909b(0x240)]({'where':{'shopId':_0x22ef83}}),database_1[_0x59909b(0x1dd)]['paymentLink'][_0x59909b(0x240)]({'where':{'shopId':_0x22ef83,'status':_0x59909b(0x268)}}),database_1[_0x59909b(0x1dd)][_0x59909b(0x229)]['count']({'where':{'shopId':_0x22ef83,'paymentLinkId':{'not':null}}}),database_1[_0x59909b(0x1dd)][_0x59909b(0x229)][_0x59909b(0x247)]({'where':{'shopId':_0x22ef83,'paymentLinkId':{'not':null},'status':'PAID'},'select':{'amount':!![],'currency':!![]}})]);let _0x3576e0=0x0;for(const _0x14a490 of _0x546463){const _0xf47826=await currencyService_1[_0x59909b(0x222)][_0x59909b(0x1e2)](_0x14a490[_0x59909b(0x1ee)],_0x14a490[_0x59909b(0x1e0)]);_0x3576e0+=_0xf47826;}const _0x526d60=_0x127994>0x0?_0x546463[_0x59909b(0x1ec)]/_0x127994*0x64:0x0;return{'totalLinks':_0x5ac3c6,'activeLinks':_0x22e6a8,'totalPayments':_0x127994,'totalRevenue':Math[_0x59909b(0x1d8)](_0x3576e0*0x64)/0x64,'conversionRate':Math['round'](_0x526d60*0x64)/0x64};}[a44_0x43acf3(0x26a)](_0x374c10){const _0x29450a=a44_0x43acf3;return{'id':_0x374c10['id'],'shopId':_0x374c10[_0x29450a(0x1de)],'amount':_0x374c10['amount'],'currency':_0x374c10[_0x29450a(0x1e0)],'sourceCurrency':_0x374c10[_0x29450a(0x218)]||undefined,'gateway':_0x374c10[_0x29450a(0x1f9)],'maxPayments':_0x374c10[_0x29450a(0x23c)],'currentPayments':_0x374c10[_0x29450a(0x255)],'status':_0x374c10[_0x29450a(0x1f7)],'expiresAt':_0x374c10[_0x29450a(0x24b)]||undefined,'successUrl':_0x374c10[_0x29450a(0x25d)]||undefined,'failUrl':_0x374c10[_0x29450a(0x21d)]||undefined,'country':_0x374c10[_0x29450a(0x200)]||undefined,'language':_0x374c10[_0x29450a(0x1e3)]||undefined,'linkUrl':_0x29450a(0x250)+_0x374c10['id'],'createdAt':_0x374c10[_0x29450a(0x267)],'updatedAt':_0x374c10[_0x29450a(0x26e)],'shop':_0x374c10[_0x29450a(0x256)],'payments':_0x374c10[_0x29450a(0x1fc)]};}}exports['PaymentLinkService']=PaymentLinkService;