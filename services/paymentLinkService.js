'use strict';const a45_0x5f2d6a=a45_0x1bca;function a45_0x2da5(){const _0x4db0d4=['üá¨üáß\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','./gateways/coinToPayService','ACTIVE','generateGatewayOrderId','https://app.trapay.uk/payment/fail?id=','/gateway/success.php?id=','RapydService','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','toISOString','cointopay','\x20already\x20at\x20max\x20payments\x20(','üìù\x20Note:\x20Success/Fail\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created','sourceCurrency','paymentGateways','469284TGGGGc','generateGatewayUrls','gateway_payment_id','all','184566XVFwVN','deletePaymentLink','convertToUSDT','Shop\x20is\x20not\x20active','getPaymentLinkById','PAID','üíæ\x20Payment\x20created:\x20','$transaction','klyme_','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','shop','ü™ô\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','./gateways/klymeService','\x20\x20\x20üíæ\x20DB\x20Success\x20URL:\x20','./gateways/rapydService','\x22\x20is\x20allowed\x20for\x20shop\x20','successUrl','nodaService','‚ùå\x20Enabled\x20gateways:\x20','PlisioService','Rapyd','toString','üîó\x20Rapyd\x20payment\x20URL:\x20','currencyService','payments','Plisio','getPaymentLinks','https://tesoft.uk','45618480LcOuAm','coinToPayService','Error\x20parsing\x20payment\x20gateways:','__esModule',',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','../types/gateway','updatePaymentLink','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','rapyd','Payment\x20link\x20not\x20found','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','default','plisio','invoice_total_sum','https://tesoft.uk/gateway/payment.php?id=','gateway','plisioService','country','ceil','FAILED','findFirst','\x20with\x20payment\x20ID\x20','round','maxPayments','KLYME\x20EU','üîó\x20Plisio\x20payment\x20URL:\x20','ü™ô\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','isValidGatewayId','username','language','https://tesoft.uk/gateways/noda/webhook','COMPLETED','noda','CoinToPayService','Payment\x20link\x20is\x20not\x20active','üìà\x20Payment\x20link\x20','amount','üí∞\x20Amount:\x20','Payment\x20','shopId','getPaymentLinkStatistics','checkGatewayPermission','error','üîê\x20Checking\x20if\x20\x22','Anonymous','GBP','\x20using\x20default\x20gateways:','Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','payment_url','‚úÖ\x20KLYME\x20','),\x20skipping\x20increment','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Invalid\x20gateway\x20ID:\x20','log','PENDING','EUR','Gateway\x20error:\x20','status','Payment\x20link\x20has\x20expired','\x22\x20not\x20allowed\x20for\x20shop\x20','payment','./currencyService','üí∞\x20Plisio\x20payment\x20link\x20mapping:','ONCE','\x20not\x20found','startsWith','üèÅ\x20Payment\x20link\x20','Unsupported\x20KLYME\x20region:\x20','paymentLinkId','update','NodaService','rapydService','‚úÖ\x20Gateway\x20\x22','findMany','üìà\x20Payment\x20','getKlymeRegionFromGatewayName','length','createPayment','https://app.trapay.uk/link/','updatedAt','\x20payment\x20URL:\x20','BASE_URL','üîó\x20CoinToPay\x20payment\x20URL:\x20','1969048VECIDA','\x20counter\x20updated:\x20','\x20\x20\x20üåê\x20Gateway\x20Success\x20URL:\x20','\x20(validated\x20for\x20','paymentLink','üë§\x20Customer:\x20','üìà\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','expiresAt','currency','10581025fPJwNo','padStart','amount\x20is\x20required\x20and\x20must\x20be\x20positive','formatPaymentLinkResponse','Gateway\x20not\x20found\x20for\x20ID:\x20','https://app.trapay.uk/payment/success?id=','PaymentLinkService','paidAt','toUpperCase','CoinToPay','üîó\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','7318ahDeGv','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','getGatewayDisplayName','\x20payment\x20link','\x20(8digits-8digits\x20format)','üá¨üáß\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','üîê\x20Shop\x20','name','\x20status\x20is\x20','Invalid\x20KLYME\x20gateway:\x20','Unsupported\x20gateway:\x20','33uWUjKJ','ü™ô\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','random','./gateways/plisioService','parse','join','insensitive','56kbBAyA','floor','findUnique','Unknown\x20error','createPaymentLink','üîó\x20KLYME\x20','\x20(8digits-8digits\x20format\x20for\x20','getGatewayNameById','klymeService','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','KLYME\x20GB','Enabled\x20gateways:\x20','max','message','7389500YuCLda','üîó\x20Noda\x20payment\x20URL:\x20','KLYME\x20DE','https://app.trapay.uk/payment/pending?id=','desc','üíæ\x20DB\x20Success\x20URL:\x20','/gateway/pending.php?id=','https://app.trapay.uk/payment/','count','no\x20email','üí≥\x20Initiating\x20payment\x20from\x20link\x20','temp','/gateway/fail.php?id=','validateKlymeCurrency','currentPayments'];a45_0x2da5=function(){return _0x4db0d4;};return a45_0x2da5();}(function(_0x400d51,_0x612e5b){const _0x14acb3=a45_0x1bca,_0x3cb3a2=_0x400d51();while(!![]){try{const _0x12e84f=-parseInt(_0x14acb3(0x1b3))/0x1*(-parseInt(_0x14acb3(0x1c5))/0x2)+parseInt(_0x14acb3(0x1be))/0x3*(-parseInt(_0x14acb3(0x1f1))/0x4)+-parseInt(_0x14acb3(0x1d3))/0x5+parseInt(_0x14acb3(0x1f5))/0x6+-parseInt(_0x14acb3(0x1a8))/0x7+-parseInt(_0x14acb3(0x19f))/0x8+parseInt(_0x14acb3(0x211))/0x9;if(_0x12e84f===_0x612e5b)break;else _0x3cb3a2['push'](_0x3cb3a2['shift']());}catch(_0x468ba1){_0x3cb3a2['push'](_0x3cb3a2['shift']());}}}(a45_0x2da5,0xbe008));function a45_0x1bca(_0x5a7095,_0x5363f2){const _0x2da565=a45_0x2da5();return a45_0x1bca=function(_0x1bca94,_0x4a80fe){_0x1bca94=_0x1bca94-0x155;let _0x835c49=_0x2da565[_0x1bca94];return _0x835c49;},a45_0x1bca(_0x5a7095,_0x5363f2);}var __importDefault=this&&this['__importDefault']||function(_0x5521e5){const _0x3d7b6d=a45_0x1bca;return _0x5521e5&&_0x5521e5[_0x3d7b6d(0x214)]?_0x5521e5:{'default':_0x5521e5};};Object['defineProperty'](exports,a45_0x5f2d6a(0x214),{'value':!![]}),exports[a45_0x5f2d6a(0x1ae)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a45_0x5f2d6a(0x1c1)),rapydService_1=require(a45_0x5f2d6a(0x203)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a45_0x5f2d6a(0x1e3)),klymeService_1=require(a45_0x5f2d6a(0x201)),gateway_1=require(a45_0x5f2d6a(0x216)),currencyService_1=require(a45_0x5f2d6a(0x189));class PaymentLinkService{constructor(){const _0x13db47=a45_0x5f2d6a;this['plisioService']=new plisioService_1[(_0x13db47(0x208))](),this[_0x13db47(0x193)]=new rapydService_1[(_0x13db47(0x1e8))](),this[_0x13db47(0x206)]=new nodaService_1[(_0x13db47(0x192))](),this[_0x13db47(0x212)]=new coinToPayService_1[(_0x13db47(0x16c))](),this[_0x13db47(0x1cd)]=new klymeService_1['KlymeService']();}[a45_0x5f2d6a(0x1e5)](){const _0x415af0=()=>{const _0x34b8c4=a45_0x1bca;return Math[_0x34b8c4(0x1c6)](Math[_0x34b8c4(0x1c0)]()*0x5f5e100)[_0x34b8c4(0x20a)]()[_0x34b8c4(0x1a9)](0x8,'0');};return _0x415af0()+'-'+_0x415af0();}[a45_0x5f2d6a(0x1f2)](_0x1a68da,_0x116f8f,_0x5476a2,_0x2c87b5,_0x344030){const _0x47d4f1=a45_0x5f2d6a;if(_0x2c87b5&&_0x344030)return{'finalSuccessUrl':_0x2c87b5,'finalFailUrl':_0x344030,'dbSuccessUrl':_0x2c87b5,'dbFailUrl':_0x344030};let _0x5bcd34,_0x501b88,_0x49f942,_0x306274;return _0x1a68da==='noda'||_0x1a68da[_0x47d4f1(0x18d)](_0x47d4f1(0x1fd))?(_0x5bcd34=_0x5476a2+_0x47d4f1(0x1d9)+_0x116f8f,_0x49f942=_0x47d4f1(0x1d6)+_0x116f8f):(_0x5bcd34=_0x5476a2+_0x47d4f1(0x1e7)+_0x116f8f,_0x49f942=_0x47d4f1(0x1ad)+_0x116f8f),_0x501b88=_0x5476a2+_0x47d4f1(0x1df)+_0x116f8f,_0x306274=_0x47d4f1(0x1e6)+_0x116f8f,console[_0x47d4f1(0x181)]('üîó\x20Generated\x20URLs\x20for\x20'+_0x1a68da+_0x47d4f1(0x160)+_0x116f8f+':'),console['log'](_0x47d4f1(0x1a1)+_0x5bcd34),console[_0x47d4f1(0x181)]('\x20\x20\x20üåê\x20Gateway\x20Fail\x20URL:\x20'+_0x501b88),console['log'](_0x47d4f1(0x202)+_0x49f942),console[_0x47d4f1(0x181)]('\x20\x20\x20üíæ\x20DB\x20Fail\x20URL:\x20'+_0x306274),{'finalSuccessUrl':_0x5bcd34,'finalFailUrl':_0x501b88,'dbSuccessUrl':_0x49f942,'dbFailUrl':_0x306274};}[a45_0x5f2d6a(0x1e0)](_0x2a5764,_0xa369a4){const _0x5e8a07=a45_0x5f2d6a;if(!_0x2a5764[_0x5e8a07(0x18d)](_0x5e8a07(0x1fd)))return;const _0x5f412e=(0x0,gateway_1[_0x5e8a07(0x197)])(_0x2a5764),_0x29fb7e=_0xa369a4[_0x5e8a07(0x1b0)]();switch(_0x5f412e){case'EU':if(_0x29fb7e!=='EUR')throw new Error(_0x5e8a07(0x1ce)+_0x29fb7e);break;case'GB':if(_0x29fb7e!==_0x5e8a07(0x178))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x29fb7e);break;case'DE':if(_0x29fb7e!==_0x5e8a07(0x183))throw new Error(_0x5e8a07(0x17f)+_0x29fb7e);break;default:throw new Error(_0x5e8a07(0x18f)+_0x5f412e);}}async[a45_0x5f2d6a(0x174)](_0x49b1e2,_0x245e30){const _0x5deb19=a45_0x5f2d6a;console['log']('üîê\x20Checking\x20gateway\x20permission\x20for\x20shop\x20'+_0x49b1e2+':\x20'+_0x245e30);const _0x4ad31a=await database_1['default'][_0x5deb19(0x1ff)]['findUnique']({'where':{'id':_0x49b1e2},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x4ad31a)throw new Error('Shop\x20not\x20found');let _0x4a58e7=[];if(_0x4ad31a[_0x5deb19(0x1f0)])try{_0x4a58e7=JSON[_0x5deb19(0x1c2)](_0x4ad31a[_0x5deb19(0x1f0)]),console[_0x5deb19(0x181)]('üîê\x20Shop\x20'+_0x4ad31a[_0x5deb19(0x167)]+'\x20enabled\x20gateways:',_0x4a58e7);}catch(_0x46878a){console['error'](_0x5deb19(0x213),_0x46878a),_0x4a58e7=[_0x5deb19(0x20e)];}else _0x4a58e7=[_0x5deb19(0x20e)],console[_0x5deb19(0x181)](_0x5deb19(0x1b9)+_0x4ad31a[_0x5deb19(0x167)]+_0x5deb19(0x179),_0x4a58e7);const _0x59d135=this['getGatewayDisplayName'](_0x245e30);console[_0x5deb19(0x181)](_0x5deb19(0x176)+_0x59d135+'\x22\x20is\x20in\x20enabled\x20gateways:',_0x4a58e7);if(!_0x4a58e7['includes'](_0x59d135)){console[_0x5deb19(0x175)]('‚ùå\x20Gateway\x20\x22'+_0x59d135+_0x5deb19(0x187)+_0x4ad31a[_0x5deb19(0x167)]),console['error'](_0x5deb19(0x207)+_0x4a58e7[_0x5deb19(0x1c3)](',\x20'));throw new Error('Gateway\x20\x22'+_0x59d135+_0x5deb19(0x218)+(_0x5deb19(0x1d0)+_0x4a58e7['join'](',\x20')+'.\x20')+_0x5deb19(0x17a));}console[_0x5deb19(0x181)](_0x5deb19(0x194)+_0x59d135+_0x5deb19(0x204)+_0x4ad31a[_0x5deb19(0x167)]);}[a45_0x5f2d6a(0x1b5)](_0xa8ede){const _0x1a902c=a45_0x5f2d6a,_0x411478={'plisio':'Plisio','rapyd':_0x1a902c(0x209),'noda':'Noda','cointopay':_0x1a902c(0x1b1),'klyme_eu':_0x1a902c(0x163),'klyme_gb':_0x1a902c(0x1cf),'klyme_de':_0x1a902c(0x1d5)};return _0x411478[_0xa8ede]||_0xa8ede;}async[a45_0x5f2d6a(0x1c9)](_0x42b9da,_0xac3356){const _0x54984d=a45_0x5f2d6a;if(!(0x0,gateway_1[_0x54984d(0x166)])(_0xac3356[_0x54984d(0x15a)]))throw new Error(_0x54984d(0x180)+_0xac3356[_0x54984d(0x15a)]+_0x54984d(0x1e9));const _0x3ce913=(0x0,gateway_1['getGatewayNameById'])(_0xac3356['gateway']);if(!_0x3ce913)throw new Error(_0x54984d(0x1ac)+_0xac3356['gateway']);console[_0x54984d(0x181)](_0x54984d(0x1b2)+_0x3ce913),await this['checkGatewayPermission'](_0x42b9da,_0x3ce913);if(_0x3ce913===_0x54984d(0x157)&&!_0xac3356['sourceCurrency'])throw new Error(_0x54984d(0x155));if(_0x3ce913[_0x54984d(0x18d)]('klyme_')){const _0x47cdce=(0x0,gateway_1[_0x54984d(0x197)])(_0x3ce913);console[_0x54984d(0x181)]('üí≥\x20Creating\x20KLYME\x20'+_0x47cdce+_0x54984d(0x1b6));}let _0x4253ad=_0xac3356['country'];_0x3ce913==='rapyd'&&(_0x4253ad='GB',console[_0x54984d(0x181)](_0x54984d(0x1b8)));if(!_0xac3356[_0x54984d(0x16f)]||_0xac3356[_0x54984d(0x16f)]<=0x0)throw new Error(_0x54984d(0x1aa));let _0x1edebd=_0xac3356[_0x54984d(0x1a7)]||'USD';_0x3ce913===_0x54984d(0x1ec)&&(_0x1edebd=_0x54984d(0x183),console[_0x54984d(0x181)](_0x54984d(0x165)));this[_0x54984d(0x1e0)](_0x3ce913,_0x1edebd);const _0x55ca6b=await database_1[_0x54984d(0x156)][_0x54984d(0x1a3)]['create']({'data':{'shopId':_0x42b9da,'amount':_0xac3356[_0x54984d(0x16f)],'currency':_0x1edebd,'sourceCurrency':_0xac3356[_0x54984d(0x1ef)]||undefined,'gateway':_0x3ce913,'maxPayments':_0xac3356['maxPayments']||0x1,'currentPayments':0x0,'status':_0x54984d(0x1e4),'expiresAt':_0xac3356['expiresAt']?new Date(_0xac3356[_0x54984d(0x1a6)]):undefined,'successUrl':_0xac3356[_0x54984d(0x205)]||null,'failUrl':_0xac3356['failUrl']||null,'country':_0x4253ad,'language':_0xac3356[_0x54984d(0x168)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x54984d(0x181)]('‚úÖ\x20Payment\x20link\x20created:\x20'+_0x55ca6b['id']+'\x20('+_0x3ce913+')'),console[_0x54984d(0x181)]('üí∞\x20Fixed\x20amount:\x20'+_0x55ca6b['amount']+'\x20'+_0x55ca6b[_0x54984d(0x1a7)]),console[_0x54984d(0x181)]('üîó\x20Link\x20URL:\x20https://app.trapay.uk/link/'+_0x55ca6b['id']),console[_0x54984d(0x181)](_0x54984d(0x1ee)),this[_0x54984d(0x1ab)](_0x55ca6b);}async[a45_0x5f2d6a(0x20f)](_0x33482f,_0x475f4f){const _0x36a44b=a45_0x5f2d6a,{page:_0x703ba3,limit:_0x43ff75,status:_0x33a178,gateway:_0x1436e5,search:_0x5c6d46}=_0x475f4f,_0x1114a2=(_0x703ba3-0x1)*_0x43ff75,_0x33bbc0={'shopId':_0x33482f};_0x33a178&&(_0x33bbc0['status']=_0x33a178[_0x36a44b(0x1b0)]());if(_0x1436e5){if((0x0,gateway_1[_0x36a44b(0x166)])(_0x1436e5)){const _0x3510d7=(0x0,gateway_1['getGatewayNameById'])(_0x1436e5);_0x3510d7&&(_0x33bbc0['gateway']=_0x3510d7);}else _0x33bbc0[_0x36a44b(0x15a)]=_0x1436e5['toLowerCase']();}_0x5c6d46&&(_0x33bbc0['OR']=[{'gateway':{'contains':_0x5c6d46,'mode':_0x36a44b(0x1c4)}},{'currency':{'contains':_0x5c6d46,'mode':_0x36a44b(0x1c4)}}]);const [_0x2ffe99,_0x11b22f]=await Promise[_0x36a44b(0x1f4)]([database_1[_0x36a44b(0x156)][_0x36a44b(0x1a3)][_0x36a44b(0x195)]({'where':_0x33bbc0,'skip':_0x1114a2,'take':_0x43ff75,'orderBy':{'createdAt':_0x36a44b(0x1d7)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}}),database_1[_0x36a44b(0x156)][_0x36a44b(0x1a3)][_0x36a44b(0x1db)]({'where':_0x33bbc0})]);return{'links':_0x2ffe99['map'](_0x5a3704=>this['formatPaymentLinkResponse'](_0x5a3704)),'pagination':{'page':_0x703ba3,'limit':_0x43ff75,'total':_0x11b22f,'totalPages':Math[_0x36a44b(0x15d)](_0x11b22f/_0x43ff75)}};}async[a45_0x5f2d6a(0x1f9)](_0x2c0e74,_0x121e4a){const _0x47a75e=a45_0x5f2d6a,_0x70c0fc=await database_1[_0x47a75e(0x156)]['paymentLink'][_0x47a75e(0x15f)]({'where':{'id':_0x121e4a,'shopId':_0x2c0e74},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x47a75e(0x1d7)}}}});if(!_0x70c0fc)return null;return this[_0x47a75e(0x1ab)](_0x70c0fc);}async[a45_0x5f2d6a(0x217)](_0x14dbe3,_0x4dc362,_0x50c6b7){const _0x5edbe3=a45_0x5f2d6a,_0x501f79={..._0x50c6b7};if(_0x50c6b7[_0x5edbe3(0x15a)]){if((0x0,gateway_1['isValidGatewayId'])(_0x50c6b7[_0x5edbe3(0x15a)])){const _0x362f14=(0x0,gateway_1[_0x5edbe3(0x1cc)])(_0x50c6b7[_0x5edbe3(0x15a)]);_0x362f14&&(await this[_0x5edbe3(0x174)](_0x14dbe3,_0x362f14),_0x501f79[_0x5edbe3(0x15a)]=_0x362f14);}else _0x501f79[_0x5edbe3(0x15a)]=_0x50c6b7['gateway']['toLowerCase']();}(_0x501f79['gateway']===_0x5edbe3(0x219)||_0x50c6b7[_0x5edbe3(0x15c)]&&_0x501f79[_0x5edbe3(0x15a)]!==_0x5edbe3(0x219))&&(_0x501f79[_0x5edbe3(0x15a)]===_0x5edbe3(0x219)&&(_0x501f79[_0x5edbe3(0x15c)]='GB',console[_0x5edbe3(0x181)](_0x5edbe3(0x1e2))));_0x501f79[_0x5edbe3(0x15a)]===_0x5edbe3(0x1ec)&&(_0x501f79[_0x5edbe3(0x1a7)]=_0x5edbe3(0x183),console[_0x5edbe3(0x181)](_0x5edbe3(0x1bf)));_0x501f79[_0x5edbe3(0x15a)]&&_0x501f79[_0x5edbe3(0x1a7)]&&this[_0x5edbe3(0x1e0)](_0x501f79[_0x5edbe3(0x15a)],_0x501f79['currency']);_0x50c6b7[_0x5edbe3(0x1a6)]&&(_0x501f79['expiresAt']=new Date(_0x50c6b7[_0x5edbe3(0x1a6)]));const _0x1c8364=await database_1[_0x5edbe3(0x156)][_0x5edbe3(0x1a3)]['update']({'where':{'id':_0x4dc362,'shopId':_0x14dbe3},'data':_0x501f79,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x5edbe3(0x1d7)},'take':0xa}}});return this['formatPaymentLinkResponse'](_0x1c8364);}async[a45_0x5f2d6a(0x1f6)](_0x3c41aa,_0xca3a7a){const _0x154650=a45_0x5f2d6a;await database_1[_0x154650(0x156)]['paymentLink']['delete']({'where':{'id':_0xca3a7a,'shopId':_0x3c41aa}});}async['getPublicPaymentLinkData'](_0x1a6bae){const _0x3ebbea=a45_0x5f2d6a,_0x2178f7=await database_1[_0x3ebbea(0x156)]['paymentLink'][_0x3ebbea(0x1c7)]({'where':{'id':_0x1a6bae},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x2178f7)return null;const _0x5c77d9=_0x2178f7[_0x3ebbea(0x1a6)]&&_0x2178f7[_0x3ebbea(0x1a6)]<new Date(),_0x105b41=_0x2178f7[_0x3ebbea(0x1e1)]>=_0x2178f7[_0x3ebbea(0x162)],_0x1b4ebc=_0x2178f7['shop'][_0x3ebbea(0x185)]==='ACTIVE',_0x29ad6b=_0x2178f7[_0x3ebbea(0x185)]===_0x3ebbea(0x1e4),_0x1e9e01=!_0x5c77d9&&!_0x105b41&&_0x1b4ebc&&_0x29ad6b,_0x45fd0f=Math[_0x3ebbea(0x1d1)](0x0,_0x2178f7[_0x3ebbea(0x162)]-_0x2178f7[_0x3ebbea(0x1e1)]);return{'id':_0x2178f7['id'],'amount':_0x2178f7[_0x3ebbea(0x16f)],'currency':_0x2178f7['currency'],'sourceCurrency':_0x2178f7[_0x3ebbea(0x1ef)]||undefined,'gateway':_0x2178f7[_0x3ebbea(0x15a)],'maxPayments':_0x2178f7['maxPayments'],'currentPayments':_0x2178f7[_0x3ebbea(0x1e1)],'status':_0x2178f7[_0x3ebbea(0x185)],'expiresAt':_0x2178f7['expiresAt']||undefined,'shopName':_0x2178f7['shop'][_0x3ebbea(0x1ba)],'isAvailable':_0x1e9e01,'remainingPayments':_0x45fd0f};}async['initiatePaymentFromLink'](_0x3d48ba){const _0x3f893c=a45_0x5f2d6a,{linkId:_0xba9022,customerEmail:_0x487449,customerName:_0x453cfc}=_0x3d48ba,_0x498def=await database_1['default'][_0x3f893c(0x1a3)]['findUnique']({'where':{'id':_0xba9022},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x498def)throw new Error(_0x3f893c(0x21a));const _0x3b3b06=_0x498def[_0x3f893c(0x1a6)]&&_0x498def[_0x3f893c(0x1a6)]<new Date(),_0x19367e=_0x498def[_0x3f893c(0x1e1)]>=_0x498def['maxPayments'],_0x2927c9=_0x498def[_0x3f893c(0x1ff)][_0x3f893c(0x185)]==='ACTIVE',_0x1d545d=_0x498def[_0x3f893c(0x185)]==='ACTIVE';if(_0x3b3b06)throw new Error(_0x3f893c(0x186));if(_0x19367e)throw new Error('Payment\x20link\x20has\x20reached\x20maximum\x20payments');if(!_0x2927c9)throw new Error(_0x3f893c(0x1f8));if(!_0x1d545d)throw new Error(_0x3f893c(0x16d));await this[_0x3f893c(0x174)](_0x498def['shopId'],_0x498def[_0x3f893c(0x15a)]);const _0x36e49a=_0x498def[_0x3f893c(0x16f)];console['log'](_0x3f893c(0x1dd)+_0xba9022+':\x20'+_0x36e49a+'\x20'+_0x498def['currency']),console[_0x3f893c(0x181)](_0x3f893c(0x1a4)+(_0x453cfc||'Anonymous')+'\x20('+(_0x487449||_0x3f893c(0x1dc))+')'),this['validateKlymeCurrency'](_0x498def[_0x3f893c(0x15a)],_0x498def[_0x3f893c(0x1a7)]);const _0x3dddf5=this[_0x3f893c(0x1e5)]();console[_0x3f893c(0x181)]('üéØ\x20Generated\x20gateway\x20order_id:\x20'+_0x3dddf5+_0x3f893c(0x1cb)+_0x498def[_0x3f893c(0x15a)]+')');const _0xa03c6c=await database_1['default'][_0x3f893c(0x188)]['create']({'data':{'shopId':_0x498def[_0x3f893c(0x172)],'paymentLinkId':_0x498def['id'],'gateway':_0x498def[_0x3f893c(0x15a)],'amount':_0x36e49a,'currency':_0x498def['currency'],'sourceCurrency':_0x498def[_0x3f893c(0x1ef)]||undefined,'usage':_0x3f893c(0x18b),'expiresAt':_0x498def[_0x3f893c(0x1a6)]||undefined,'successUrl':_0x3f893c(0x1de),'failUrl':_0x3f893c(0x1de),'status':_0x3f893c(0x182),'orderId':null,'gatewayOrderId':_0x3dddf5,'customerEmail':_0x487449||undefined,'customerName':_0x453cfc||undefined,'country':_0x498def[_0x3f893c(0x15c)]||undefined,'language':_0x498def[_0x3f893c(0x168)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console['log'](_0x3f893c(0x1fb)+_0xa03c6c['id']);const _0x1119e3=process['env'][_0x3f893c(0x19d)]||_0x3f893c(0x210),{finalSuccessUrl:_0x315876,finalFailUrl:_0x597d40,dbSuccessUrl:_0x879ded,dbFailUrl:_0x5e8eca}=this[_0x3f893c(0x1f2)](_0x498def[_0x3f893c(0x15a)],_0xa03c6c['id'],_0x1119e3,_0x498def[_0x3f893c(0x205)]||undefined,_0x498def['failUrl']||undefined);await database_1[_0x3f893c(0x156)][_0x3f893c(0x188)][_0x3f893c(0x191)]({'where':{'id':_0xa03c6c['id']},'data':{'successUrl':_0x879ded,'failUrl':_0x5e8eca}}),console['log'](_0x3f893c(0x170)+_0x36e49a+'\x20'+_0x498def[_0x3f893c(0x1a7)]),console[_0x3f893c(0x181)](_0x3f893c(0x1a4)+(_0x453cfc||_0x3f893c(0x177))+'\x20('+(_0x487449||'no\x20email')+')'),console[_0x3f893c(0x181)](_0x3f893c(0x1d8)+_0x879ded),console[_0x3f893c(0x181)]('üíæ\x20DB\x20Fail\x20URL:\x20'+_0x5e8eca);let _0x230d5c,_0x15836d;try{if(_0x498def[_0x3f893c(0x15a)]==='plisio'){console[_0x3f893c(0x181)](_0x3f893c(0x18a)),console[_0x3f893c(0x181)]('\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20'+_0x498def[_0x3f893c(0x1a7)]),console[_0x3f893c(0x181)]('\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20'+_0x498def[_0x3f893c(0x1ef)]);const _0x135230=await this[_0x3f893c(0x15b)][_0x3f893c(0x199)]({'paymentId':_0xa03c6c['id'],'orderId':_0x3dddf5,'amount':_0x36e49a,'currency':_0x498def['currency'],'productName':_0x3f893c(0x171)+_0x36e49a+'\x20'+_0x498def['currency'],'description':_0x3f893c(0x171)+_0x36e49a+'\x20'+_0x498def[_0x3f893c(0x1a7)],'successUrl':_0x315876,'failUrl':_0x597d40,'customerEmail':_0x487449||undefined,'customerName':_0x453cfc||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x498def[_0x3f893c(0x1ef)]||undefined});_0x230d5c=_0x135230[_0x3f893c(0x1f3)],_0x15836d=_0x135230[_0x3f893c(0x17c)],await database_1[_0x3f893c(0x156)][_0x3f893c(0x188)][_0x3f893c(0x191)]({'where':{'id':_0xa03c6c['id']},'data':{'externalPaymentUrl':_0x15836d,'gatewayPaymentId':_0x230d5c,'invoiceTotalSum':Number(_0x135230[_0x3f893c(0x158)]),'qrCode':_0x135230['qr_code'],'qrUrl':_0x135230['qr_url']}});const _0x2ad4de='https://app.trapay.uk/payment/'+_0xa03c6c['id'];return console[_0x3f893c(0x181)](_0x3f893c(0x164)+_0x2ad4de),{'paymentId':_0xa03c6c['id'],'paymentUrl':_0x2ad4de,'expiresAt':_0xa03c6c[_0x3f893c(0x1a6)]||undefined};}else{if(_0x498def[_0x3f893c(0x15a)]===_0x3f893c(0x219)){const _0xcf91b7=await this[_0x3f893c(0x193)][_0x3f893c(0x1c9)]({'paymentId':_0xa03c6c['id'],'orderId':_0x3dddf5,'orderName':_0x3f893c(0x171)+_0x36e49a+'\x20'+_0x498def[_0x3f893c(0x1a7)],'amount':_0x36e49a,'currency':_0x498def[_0x3f893c(0x1a7)],'country':_0x498def[_0x3f893c(0x15c)],'language':_0x498def[_0x3f893c(0x168)]||'EN','amountIsEditable':![],'usage':_0x3f893c(0x18b),'maxPayments':0x1,'successUrl':_0x315876,'failUrl':_0x597d40});_0x230d5c=_0xcf91b7[_0x3f893c(0x1f3)],_0x15836d=_0xcf91b7[_0x3f893c(0x17c)],await database_1['default'][_0x3f893c(0x188)][_0x3f893c(0x191)]({'where':{'id':_0xa03c6c['id']},'data':{'externalPaymentUrl':_0x15836d,'gatewayPaymentId':_0x230d5c}});const _0x49d5e4=_0x3f893c(0x159)+_0xa03c6c['id'];return console[_0x3f893c(0x181)](_0x3f893c(0x20b)+_0x49d5e4),{'paymentId':_0xa03c6c['id'],'paymentUrl':_0x49d5e4,'expiresAt':_0xa03c6c[_0x3f893c(0x1a6)]||undefined};}else{if(_0x498def[_0x3f893c(0x15a)]===_0x3f893c(0x16b)){const _0x20d25b=await this[_0x3f893c(0x206)][_0x3f893c(0x1c9)]({'paymentId':_0xa03c6c['id'],'orderId':_0x3dddf5,'name':'Payment\x20'+_0x36e49a+'\x20'+_0x498def[_0x3f893c(0x1a7)],'paymentDescription':'Payment\x20'+_0x36e49a+'\x20'+_0x498def[_0x3f893c(0x1a7)],'amount':_0x36e49a,'currency':_0x498def[_0x3f893c(0x1a7)],'webhookUrl':_0x3f893c(0x169),'returnUrl':_0x315876,'expiryDate':_0x498def[_0x3f893c(0x1a6)]?.[_0x3f893c(0x1eb)]()});_0x230d5c=_0x20d25b[_0x3f893c(0x1f3)],_0x15836d=_0x20d25b[_0x3f893c(0x17c)],await database_1[_0x3f893c(0x156)]['payment'][_0x3f893c(0x191)]({'where':{'id':_0xa03c6c['id']},'data':{'externalPaymentUrl':_0x15836d,'gatewayPaymentId':_0x230d5c,'qrUrl':_0x20d25b['qr_code_url']}});const _0x14bb74=_0x3f893c(0x159)+_0xa03c6c['id'];return console[_0x3f893c(0x181)](_0x3f893c(0x1d4)+_0x14bb74),{'paymentId':_0xa03c6c['id'],'paymentUrl':_0x14bb74,'expiresAt':_0xa03c6c[_0x3f893c(0x1a6)]||undefined};}else{if(_0x498def['gateway']===_0x3f893c(0x1ec)){console[_0x3f893c(0x181)](_0x3f893c(0x200)+_0x3dddf5+_0x3f893c(0x1b7)),console[_0x3f893c(0x181)](_0x3f893c(0x170)+_0x36e49a+'\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)');const _0x3c48ae=await this[_0x3f893c(0x212)]['createPaymentLink']({'paymentId':_0xa03c6c['id'],'orderId':_0x3dddf5,'amount':_0x36e49a});_0x230d5c=_0x3c48ae[_0x3f893c(0x1f3)],_0x15836d=_0x3c48ae['payment_url'],await database_1[_0x3f893c(0x156)][_0x3f893c(0x188)][_0x3f893c(0x191)]({'where':{'id':_0xa03c6c['id']},'data':{'externalPaymentUrl':_0x15836d,'gatewayPaymentId':_0x230d5c}});const _0x4d43f2=_0x3f893c(0x159)+_0xa03c6c['id'];return console[_0x3f893c(0x181)](_0x3f893c(0x19e)+_0x4d43f2),{'paymentId':_0xa03c6c['id'],'paymentUrl':_0x4d43f2,'expiresAt':_0xa03c6c[_0x3f893c(0x1a6)]||undefined};}else{if(_0x498def[_0x3f893c(0x15a)][_0x3f893c(0x18d)](_0x3f893c(0x1fd))){const _0x4b059a=(0x0,gateway_1[_0x3f893c(0x197)])(_0x498def[_0x3f893c(0x15a)]);if(!_0x4b059a)throw new Error(_0x3f893c(0x1bc)+_0x498def[_0x3f893c(0x15a)]);console['log']('üí≥\x20Creating\x20KLYME\x20'+_0x4b059a+_0x3f893c(0x1b4)+_0x3dddf5+_0x3f893c(0x1b7)),console['log']('üí∞\x20Amount:\x20'+_0x36e49a+'\x20'+_0x498def[_0x3f893c(0x1a7)]+_0x3f893c(0x1a2)+_0x4b059a+')');const _0x48c14c=await this[_0x3f893c(0x1cd)][_0x3f893c(0x1c9)]({'paymentId':_0xa03c6c['id'],'orderId':_0x3dddf5,'amount':_0x36e49a,'currency':_0x498def[_0x3f893c(0x1a7)],'region':_0x4b059a,'redirectUrl':_0x315876});_0x230d5c=_0x48c14c['gateway_payment_id'],_0x15836d=_0x48c14c[_0x3f893c(0x17c)],await database_1['default'][_0x3f893c(0x188)][_0x3f893c(0x191)]({'where':{'id':_0xa03c6c['id']},'data':{'externalPaymentUrl':_0x15836d,'gatewayPaymentId':_0x230d5c}});const _0x5f1d3d=_0x3f893c(0x1da)+_0xa03c6c['id'];return console[_0x3f893c(0x181)](_0x3f893c(0x17d)+_0x4b059a+'\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20'+_0x3dddf5),console[_0x3f893c(0x181)](_0x3f893c(0x1ca)+_0x4b059a+_0x3f893c(0x19c)+_0x5f1d3d),{'paymentId':_0xa03c6c['id'],'paymentUrl':_0x5f1d3d,'expiresAt':_0xa03c6c[_0x3f893c(0x1a6)]||undefined};}else throw new Error(_0x3f893c(0x1bd)+_0x498def[_0x3f893c(0x15a)]);}}}}}catch(_0x44bf81){await database_1[_0x3f893c(0x156)][_0x3f893c(0x188)][_0x3f893c(0x191)]({'where':{'id':_0xa03c6c['id']},'data':{'status':_0x3f893c(0x15e)}});throw new Error(_0x3f893c(0x184)+(_0x44bf81 instanceof Error?_0x44bf81[_0x3f893c(0x1d2)]:_0x3f893c(0x1c8)));}}async['handleSuccessfulPayment'](_0x2da25b){const _0x1abe78=a45_0x5f2d6a;console[_0x1abe78(0x181)](_0x1abe78(0x1a5)+_0x2da25b);const _0xc2a7c4=await database_1[_0x1abe78(0x156)]['payment'][_0x1abe78(0x1c7)]({'where':{'id':_0x2da25b},'include':{'paymentLink':!![]}});if(!_0xc2a7c4||!_0xc2a7c4[_0x1abe78(0x1a3)]){console[_0x1abe78(0x181)](_0x1abe78(0x196)+_0x2da25b+_0x1abe78(0x17b));return;}if(_0xc2a7c4[_0x1abe78(0x185)]!==_0x1abe78(0x1fa)){console['log']('üìà\x20Payment\x20'+_0x2da25b+_0x1abe78(0x1bb)+_0xc2a7c4[_0x1abe78(0x185)]+_0x1abe78(0x215));return;}if(!_0xc2a7c4[_0x1abe78(0x1af)]){console['log'](_0x1abe78(0x196)+_0x2da25b+_0x1abe78(0x1fe));return;}try{const _0x2311ee=await database_1[_0x1abe78(0x156)][_0x1abe78(0x1fc)](async _0x46964f=>{const _0xe9d124=_0x1abe78,_0x5afc1a=await _0x46964f[_0xe9d124(0x1a3)][_0xe9d124(0x1c7)]({'where':{'id':_0xc2a7c4['paymentLinkId']},'select':{'id':!![],'currentPayments':!![],'maxPayments':!![],'status':!![]}});if(!_0x5afc1a)throw new Error('Payment\x20link\x20'+_0xc2a7c4['paymentLinkId']+_0xe9d124(0x18c));if(_0x5afc1a[_0xe9d124(0x1e1)]>=_0x5afc1a[_0xe9d124(0x162)])return console[_0xe9d124(0x181)](_0xe9d124(0x16e)+_0xc2a7c4[_0xe9d124(0x190)]+_0xe9d124(0x1ed)+_0x5afc1a[_0xe9d124(0x1e1)]+'/'+_0x5afc1a[_0xe9d124(0x162)]+_0xe9d124(0x17e)),_0x5afc1a;const _0x329e41=await _0x46964f[_0xe9d124(0x188)][_0xe9d124(0x1db)]({'where':{'paymentLinkId':_0xc2a7c4[_0xe9d124(0x190)],'status':_0xe9d124(0x1fa),'paidAt':{'not':null},'id':{'not':_0x2da25b}}}),_0x2a89fe=_0x329e41+0x1,_0x404e36=await _0x46964f[_0xe9d124(0x1a3)]['update']({'where':{'id':_0xc2a7c4[_0xe9d124(0x190)]},'data':{'currentPayments':_0x2a89fe,'status':_0x2a89fe>=_0x5afc1a[_0xe9d124(0x162)]?'COMPLETED':_0x5afc1a[_0xe9d124(0x185)]}});return console[_0xe9d124(0x181)](_0xe9d124(0x16e)+_0xc2a7c4[_0xe9d124(0x190)]+_0xe9d124(0x1a0)+_0x5afc1a[_0xe9d124(0x1e1)]+'\x20->\x20'+_0x2a89fe+'/'+_0x5afc1a[_0xe9d124(0x162)]),_0x404e36;});_0x2311ee[_0x1abe78(0x185)]===_0x1abe78(0x16a)&&console[_0x1abe78(0x181)](_0x1abe78(0x18e)+_0xc2a7c4['paymentLinkId']+'\x20completed\x20(reached\x20max\x20payments:\x20'+_0x2311ee[_0x1abe78(0x1e1)]+'/'+_0x2311ee[_0x1abe78(0x162)]+')');}catch(_0x172f19){console[_0x1abe78(0x175)](_0x1abe78(0x1ea)+_0x2da25b+':',_0x172f19);}}async[a45_0x5f2d6a(0x173)](_0x4f45ca){const _0x4c0d5a=a45_0x5f2d6a,[_0x220e8c,_0x5c3ee6,_0x36b98d,_0x37c496]=await Promise[_0x4c0d5a(0x1f4)]([database_1[_0x4c0d5a(0x156)][_0x4c0d5a(0x1a3)]['count']({'where':{'shopId':_0x4f45ca}}),database_1[_0x4c0d5a(0x156)]['paymentLink'][_0x4c0d5a(0x1db)]({'where':{'shopId':_0x4f45ca,'status':'ACTIVE'}}),database_1['default']['payment'][_0x4c0d5a(0x1db)]({'where':{'shopId':_0x4f45ca,'paymentLinkId':{'not':null}}}),database_1[_0x4c0d5a(0x156)][_0x4c0d5a(0x188)][_0x4c0d5a(0x195)]({'where':{'shopId':_0x4f45ca,'paymentLinkId':{'not':null},'status':_0x4c0d5a(0x1fa)},'select':{'amount':!![],'currency':!![]}})]);let _0x351f9f=0x0;for(const _0xeb4c85 of _0x37c496){const _0x414ca3=await currencyService_1[_0x4c0d5a(0x20c)][_0x4c0d5a(0x1f7)](_0xeb4c85[_0x4c0d5a(0x16f)],_0xeb4c85[_0x4c0d5a(0x1a7)]);_0x351f9f+=_0x414ca3;}const _0x3760fb=_0x36b98d>0x0?_0x37c496[_0x4c0d5a(0x198)]/_0x36b98d*0x64:0x0;return{'totalLinks':_0x220e8c,'activeLinks':_0x5c3ee6,'totalPayments':_0x36b98d,'totalRevenue':Math[_0x4c0d5a(0x161)](_0x351f9f*0x64)/0x64,'conversionRate':Math[_0x4c0d5a(0x161)](_0x3760fb*0x64)/0x64};}[a45_0x5f2d6a(0x1ab)](_0x4431c0){const _0xef5455=a45_0x5f2d6a;return{'id':_0x4431c0['id'],'shopId':_0x4431c0[_0xef5455(0x172)],'amount':_0x4431c0[_0xef5455(0x16f)],'currency':_0x4431c0['currency'],'sourceCurrency':_0x4431c0[_0xef5455(0x1ef)]||undefined,'gateway':_0x4431c0['gateway'],'maxPayments':_0x4431c0[_0xef5455(0x162)],'currentPayments':_0x4431c0[_0xef5455(0x1e1)],'status':_0x4431c0[_0xef5455(0x185)],'expiresAt':_0x4431c0[_0xef5455(0x1a6)]||undefined,'successUrl':_0x4431c0['successUrl']||undefined,'failUrl':_0x4431c0['failUrl']||undefined,'country':_0x4431c0[_0xef5455(0x15c)]||undefined,'language':_0x4431c0[_0xef5455(0x168)]||undefined,'linkUrl':_0xef5455(0x19a)+_0x4431c0['id'],'createdAt':_0x4431c0['createdAt'],'updatedAt':_0x4431c0[_0xef5455(0x19b)],'shop':_0x4431c0[_0xef5455(0x1ff)],'payments':_0x4431c0[_0xef5455(0x20d)]};}}exports[a45_0x5f2d6a(0x1ae)]=PaymentLinkService;