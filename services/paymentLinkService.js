'use strict';const a45_0x5c8668=a45_0x298a;function a45_0x2d77(){const _0x1e6409=['getGatewayNameById','formatPaymentLinkResponse','count','desc','./currencyService','findMany','createPaymentLink','EUR','\x20\x20\x20ðŸŒ\x20Gateway\x20Fail\x20URL:\x20','ðŸ”—\x20KLYME\x20','getPaymentLinks','ðŸ’°\x20Amount:\x20','successUrl','Shop\x20is\x20not\x20active','ðŸª™\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','createPayment','ðŸ”—\x20Rapyd\x20payment\x20URL:\x20','141846MQmQBv','\x20\x20\x20ðŸŒ\x20Gateway\x20Success\x20URL:\x20','no\x20email','Anonymous','43371iIiTbp','invoice_total_sum','maxPayments','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','ðŸ”—\x20Noda\x20payment\x20URL:\x20','PAID','Payment\x20','1207468BbfENG','shopId','language','\x20(8digits-8digits\x20format\x20for\x20','/gateway/success.php?id=','Gateway\x20not\x20found\x20for\x20ID:\x20','toUpperCase','__esModule','startsWith','./gateways/nodaService','handleSuccessfulPayment','generateGatewayUrls','insensitive','qr_code_url','\x20payment\x20URL:\x20','GBP','Invalid\x20KLYME\x20gateway:\x20','ðŸ\x20Payment\x20link\x20','currency','\x20(validated\x20for\x20','BASE_URL','update','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','/gateway/fail.php?id=','111pAqctb','./gateways/rapydService','\x20\x20\x20ðŸ’¾\x20DB\x20Success\x20URL:\x20','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','FAILED','Payment\x20link\x20has\x20reached\x20maximum\x20payments','deletePaymentLink','ðŸŽ¯\x20Generated\x20gateway\x20order_id:\x20','./gateways/coinToPayService','message','__importDefault','ðŸª™\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','\x20completed\x20(reached\x20max\x20payments)','paymentLink','ðŸ’¾\x20DB\x20Fail\x20URL:\x20','424JSyDrX','gateway','klyme_','ðŸ’³\x20Creating\x20KLYME\x20','defineProperty','ðŸ”—\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','payments','96026EoVasS','KlymeService','create','amount','Payment\x20link\x20has\x20expired','ðŸ”—\x20CoinToPay\x20payment\x20URL:\x20','updatePaymentLink','getKlymeRegionFromGatewayName','amount\x20is\x20required\x20and\x20must\x20be\x20positive','ðŸ‡¬ðŸ‡§\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','ðŸ‡¬ðŸ‡§\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','https://tesoft.uk/gateway/payment.php?id=','./gateways/plisioService','RapydService','CoinToPayService','\x20(8digits-8digits\x20format)','isValidGatewayId','âœ…\x20Payment\x20link\x20created:\x20','payment_url','failUrl','plisio','Unsupported\x20gateway:\x20','round','toLowerCase','toString','getPublicPaymentLinkData','sourceCurrency','getPaymentLinkStatistics','1486dCJOOt','https://app.trapay.uk/link/','length','noda','ðŸ’¾\x20DB\x20Success\x20URL:\x20','1744050UfPrpj','ðŸ’°\x20Plisio\x20payment\x20link\x20mapping:','rapydService','currentPayments','ðŸ‘¤\x20Customer:\x20','\x20payment\x20link','ðŸ”—\x20Plisio\x20payment\x20URL:\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','991040EXHvJD','paymentLinkId','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','rapyd','all','Gateway\x20error:\x20','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','Unsupported\x20KLYME\x20region:\x20','nodaService','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','default','shop','ðŸ“ˆ\x20Payment\x20link\x20','expiresAt','getPaymentLinkById','name','gateway_payment_id','validateKlymeCurrency','âŒ\x20DB\x20Fail\x20URL:\x20','findUnique','ACTIVE','âœ…\x20KLYME\x20','ceil','cointopay','PaymentLinkService','ONCE','floor','updatedAt','log','ðŸª™\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','PENDING','coinToPayService','Invalid\x20gateway\x20ID:\x20','../config/database','findFirst','klymeService','status','country','plisioService','random','\x20\x20\x20ðŸ’¾\x20DB\x20Fail\x20URL:\x20','delete','PlisioService','COMPLETED','Payment\x20link\x20is\x20not\x20active','payment','max','/gateway/pending.php?id=','ðŸ’¾\x20Payment\x20created\x20from\x20link:\x20','initiatePaymentFromLink','createdAt','https://app.trapay.uk/payment/','https://app.trapay.uk/payment/fail'];a45_0x2d77=function(){return _0x1e6409;};return a45_0x2d77();}(function(_0x858b52,_0x5ac0fb){const _0x957326=a45_0x298a,_0x3e105e=_0x858b52();while(!![]){try{const _0x53e82e=parseInt(_0x957326(0x1a8))/0x1+parseInt(_0x957326(0x1fd))/0x2*(-parseInt(_0x957326(0x1cb))/0x3)+parseInt(_0x957326(0x1b3))/0x4+-parseInt(_0x957326(0x20a))/0x5+parseInt(_0x957326(0x202))/0x6+-parseInt(_0x957326(0x1e1))/0x7+parseInt(_0x957326(0x1da))/0x8*(-parseInt(_0x957326(0x1ac))/0x9);if(_0x53e82e===_0x5ac0fb)break;else _0x3e105e['push'](_0x3e105e['shift']());}catch(_0x4ef42a){_0x3e105e['push'](_0x3e105e['shift']());}}}(a45_0x2d77,0x3a7cc));var __importDefault=this&&this[a45_0x5c8668(0x1d5)]||function(_0x3c4a81){const _0x211355=a45_0x5c8668;return _0x3c4a81&&_0x3c4a81[_0x211355(0x1ba)]?_0x3c4a81:{'default':_0x3c4a81};};Object[a45_0x5c8668(0x1de)](exports,a45_0x5c8668(0x1ba),{'value':!![]}),exports[a45_0x5c8668(0x222)]=void 0x0;const database_1=__importDefault(require(a45_0x5c8668(0x183))),plisioService_1=require(a45_0x5c8668(0x1ed)),rapydService_1=require(a45_0x5c8668(0x1cc)),nodaService_1=require(a45_0x5c8668(0x1bc)),coinToPayService_1=require(a45_0x5c8668(0x1d3)),klymeService_1=require('./gateways/klymeService'),gateway_1=require('../types/gateway'),currencyService_1=require(a45_0x5c8668(0x19b));class PaymentLinkService{constructor(){const _0x22420d=a45_0x5c8668;this[_0x22420d(0x188)]=new plisioService_1[(_0x22420d(0x18c))](),this[_0x22420d(0x204)]=new rapydService_1[(_0x22420d(0x1ee))](),this[_0x22420d(0x212)]=new nodaService_1['NodaService'](),this[_0x22420d(0x181)]=new coinToPayService_1[(_0x22420d(0x1ef))](),this[_0x22420d(0x185)]=new klymeService_1[(_0x22420d(0x1e2))]();}['generateGatewayOrderId'](){const _0x60257c=()=>{const _0x401f26=a45_0x298a;return Math[_0x401f26(0x17c)](Math[_0x401f26(0x189)]()*0x5f5e100)[_0x401f26(0x1f9)]()['padStart'](0x8,'0');};return _0x60257c()+'-'+_0x60257c();}[a45_0x5c8668(0x1be)](_0x2f60da,_0x21637a,_0xe75c74,_0x49af6b,_0x373297){const _0x19a04e=a45_0x5c8668;if(_0x49af6b&&_0x373297)return{'finalSuccessUrl':_0x49af6b,'finalFailUrl':_0x373297,'dbSuccessUrl':_0x49af6b,'dbFailUrl':_0x373297};let _0x500327,_0x3a671a,_0x1af793,_0x14d3d4;return _0x2f60da===_0x19a04e(0x200)||_0x2f60da[_0x19a04e(0x1bb)](_0x19a04e(0x1dc))?(_0x500327=_0xe75c74+_0x19a04e(0x191)+_0x21637a,_0x1af793='https://app.trapay.uk/payment/pending'):(_0x500327=_0xe75c74+_0x19a04e(0x1b7)+_0x21637a,_0x1af793='https://app.trapay.uk/payment/success'),_0x3a671a=_0xe75c74+_0x19a04e(0x1ca)+_0x21637a,_0x14d3d4=_0x19a04e(0x196),console[_0x19a04e(0x17e)]('ðŸ”—\x20Generated\x20URLs\x20for\x20'+_0x2f60da+':'),console[_0x19a04e(0x17e)](_0x19a04e(0x1a9)+_0x500327),console[_0x19a04e(0x17e)](_0x19a04e(0x19f)+_0x3a671a),console['log'](_0x19a04e(0x1cd)+_0x1af793),console[_0x19a04e(0x17e)](_0x19a04e(0x18a)+_0x14d3d4),{'finalSuccessUrl':_0x500327,'finalFailUrl':_0x3a671a,'dbSuccessUrl':_0x1af793,'dbFailUrl':_0x14d3d4};}['validateKlymeCurrency'](_0x216619,_0x244109){const _0x3cb9ab=a45_0x5c8668;if(!_0x216619[_0x3cb9ab(0x1bb)]('klyme_'))return;const _0x232d80=(0x0,gateway_1[_0x3cb9ab(0x1e8)])(_0x216619),_0x277b2e=_0x244109[_0x3cb9ab(0x1b9)]();switch(_0x232d80){case'EU':if(_0x277b2e!==_0x3cb9ab(0x19e))throw new Error(_0x3cb9ab(0x209)+_0x277b2e);break;case'GB':if(_0x277b2e!==_0x3cb9ab(0x1c2))throw new Error(_0x3cb9ab(0x20c)+_0x277b2e);break;case'DE':if(_0x277b2e!==_0x3cb9ab(0x19e))throw new Error(_0x3cb9ab(0x1af)+_0x277b2e);break;default:throw new Error(_0x3cb9ab(0x211)+_0x232d80);}}async[a45_0x5c8668(0x19d)](_0x2e0d7c,_0x596b81){const _0x38fc7e=a45_0x5c8668;if(!(0x0,gateway_1['isValidGatewayId'])(_0x596b81['gateway']))throw new Error(_0x38fc7e(0x182)+_0x596b81[_0x38fc7e(0x1db)]+_0x38fc7e(0x1c9));const _0x255e82=(0x0,gateway_1[_0x38fc7e(0x197)])(_0x596b81[_0x38fc7e(0x1db)]);if(!_0x255e82)throw new Error(_0x38fc7e(0x1b8)+_0x596b81[_0x38fc7e(0x1db)]);console[_0x38fc7e(0x17e)](_0x38fc7e(0x1df)+_0x255e82);if(_0x255e82==='plisio'&&!_0x596b81[_0x38fc7e(0x1fb)])throw new Error('sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links');if(_0x255e82['startsWith'](_0x38fc7e(0x1dc))){const _0x263e5f=(0x0,gateway_1[_0x38fc7e(0x1e8)])(_0x255e82);console[_0x38fc7e(0x17e)](_0x38fc7e(0x1dd)+_0x263e5f+_0x38fc7e(0x207));}let _0x3aa0ac=_0x596b81[_0x38fc7e(0x187)];_0x255e82===_0x38fc7e(0x20d)&&(_0x3aa0ac='GB',console[_0x38fc7e(0x17e)](_0x38fc7e(0x1eb)));if(!_0x596b81[_0x38fc7e(0x1e4)]||_0x596b81[_0x38fc7e(0x1e4)]<=0x0)throw new Error(_0x38fc7e(0x1e9));let _0x55e342=_0x596b81['currency']||'USD';_0x255e82==='cointopay'&&(_0x55e342=_0x38fc7e(0x19e),console[_0x38fc7e(0x17e)](_0x38fc7e(0x17f)));this[_0x38fc7e(0x21b)](_0x255e82,_0x55e342);const _0x5593bf=process['env'][_0x38fc7e(0x1c7)]||'https://tesoft.uk',{finalSuccessUrl:_0x4c9150,finalFailUrl:_0x49c4ce,dbSuccessUrl:_0x1699f8,dbFailUrl:_0x5e9f2a}=this['generateGatewayUrls'](_0x255e82,'PLACEHOLDER',_0x5593bf,_0x596b81[_0x38fc7e(0x1a3)],_0x596b81['failUrl']),_0x58c7a3=await database_1[_0x38fc7e(0x214)][_0x38fc7e(0x1d8)][_0x38fc7e(0x1e3)]({'data':{'shopId':_0x2e0d7c,'amount':_0x596b81['amount'],'currency':_0x55e342,'sourceCurrency':_0x596b81[_0x38fc7e(0x1fb)]||undefined,'gateway':_0x255e82,'maxPayments':_0x596b81[_0x38fc7e(0x1ae)]||0x1,'currentPayments':0x0,'status':'ACTIVE','expiresAt':_0x596b81[_0x38fc7e(0x217)]?new Date(_0x596b81[_0x38fc7e(0x217)]):undefined,'successUrl':_0x1699f8,'failUrl':_0x5e9f2a,'country':_0x3aa0ac,'language':_0x596b81[_0x38fc7e(0x1b5)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x38fc7e(0x17e)](_0x38fc7e(0x1f2)+_0x58c7a3['id']+'\x20('+_0x255e82+')'),console[_0x38fc7e(0x17e)]('ðŸ’°\x20Fixed\x20amount:\x20'+_0x58c7a3['amount']+'\x20'+_0x58c7a3[_0x38fc7e(0x1c5)]),console[_0x38fc7e(0x17e)]('ðŸ”—\x20Link\x20URL:\x20https://app.trapay.uk/link/'+_0x58c7a3['id']),console[_0x38fc7e(0x17e)]('âœ…\x20DB\x20Success\x20URL:\x20'+_0x58c7a3[_0x38fc7e(0x1a3)]),console[_0x38fc7e(0x17e)](_0x38fc7e(0x21c)+_0x58c7a3[_0x38fc7e(0x1f4)]),this[_0x38fc7e(0x198)](_0x58c7a3);}async[a45_0x5c8668(0x1a1)](_0x27fb1f,_0x2781d4){const _0x373708=a45_0x5c8668,{page:_0x2beea7,limit:_0x296425,status:_0x405d88,gateway:_0x214da2,search:_0x5072a8}=_0x2781d4,_0xa66faa=(_0x2beea7-0x1)*_0x296425,_0x215cd6={'shopId':_0x27fb1f};_0x405d88&&(_0x215cd6[_0x373708(0x186)]=_0x405d88['toUpperCase']());if(_0x214da2){if((0x0,gateway_1[_0x373708(0x1f1)])(_0x214da2)){const _0x4e3651=(0x0,gateway_1[_0x373708(0x197)])(_0x214da2);_0x4e3651&&(_0x215cd6['gateway']=_0x4e3651);}else _0x215cd6['gateway']=_0x214da2['toLowerCase']();}_0x5072a8&&(_0x215cd6['OR']=[{'gateway':{'contains':_0x5072a8,'mode':_0x373708(0x1bf)}},{'currency':{'contains':_0x5072a8,'mode':_0x373708(0x1bf)}}]);const [_0x25a825,_0x208c2d]=await Promise['all']([database_1[_0x373708(0x214)][_0x373708(0x1d8)][_0x373708(0x19c)]({'where':_0x215cd6,'skip':_0xa66faa,'take':_0x296425,'orderBy':{'createdAt':_0x373708(0x19a)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}}),database_1[_0x373708(0x214)][_0x373708(0x1d8)]['count']({'where':_0x215cd6})]);return{'links':_0x25a825['map'](_0x5bc35d=>this['formatPaymentLinkResponse'](_0x5bc35d)),'pagination':{'page':_0x2beea7,'limit':_0x296425,'total':_0x208c2d,'totalPages':Math[_0x373708(0x220)](_0x208c2d/_0x296425)}};}async[a45_0x5c8668(0x218)](_0x2b2b56,_0x358d07){const _0x42c7d7=a45_0x5c8668,_0x41d167=await database_1[_0x42c7d7(0x214)][_0x42c7d7(0x1d8)][_0x42c7d7(0x184)]({'where':{'id':_0x358d07,'shopId':_0x2b2b56},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x42c7d7(0x19a)}}}});if(!_0x41d167)return null;return this[_0x42c7d7(0x198)](_0x41d167);}async[a45_0x5c8668(0x1e7)](_0x23212d,_0x934545,_0x59ff18){const _0x4bc010=a45_0x5c8668,_0x3444c1={..._0x59ff18};if(_0x59ff18['gateway']){if((0x0,gateway_1[_0x4bc010(0x1f1)])(_0x59ff18[_0x4bc010(0x1db)])){const _0x43c496=(0x0,gateway_1['getGatewayNameById'])(_0x59ff18[_0x4bc010(0x1db)]);_0x43c496&&(_0x3444c1['gateway']=_0x43c496);}else _0x3444c1[_0x4bc010(0x1db)]=_0x59ff18[_0x4bc010(0x1db)][_0x4bc010(0x1f8)]();}(_0x3444c1[_0x4bc010(0x1db)]===_0x4bc010(0x20d)||_0x59ff18[_0x4bc010(0x187)]&&_0x3444c1['gateway']!=='rapyd')&&(_0x3444c1[_0x4bc010(0x1db)]===_0x4bc010(0x20d)&&(_0x3444c1[_0x4bc010(0x187)]='GB',console[_0x4bc010(0x17e)](_0x4bc010(0x1ea))));_0x3444c1[_0x4bc010(0x1db)]===_0x4bc010(0x221)&&(_0x3444c1[_0x4bc010(0x1c5)]=_0x4bc010(0x19e),console[_0x4bc010(0x17e)](_0x4bc010(0x1a5)));_0x3444c1['gateway']&&_0x3444c1['currency']&&this[_0x4bc010(0x21b)](_0x3444c1[_0x4bc010(0x1db)],_0x3444c1[_0x4bc010(0x1c5)]);_0x59ff18[_0x4bc010(0x217)]&&(_0x3444c1[_0x4bc010(0x217)]=new Date(_0x59ff18['expiresAt']));const _0x49fb5f=await database_1[_0x4bc010(0x214)]['paymentLink'][_0x4bc010(0x1c8)]({'where':{'id':_0x934545,'shopId':_0x23212d},'data':_0x3444c1,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x4bc010(0x19a)},'take':0xa}}});return this[_0x4bc010(0x198)](_0x49fb5f);}async[a45_0x5c8668(0x1d1)](_0x583a06,_0x2a89d4){const _0x990840=a45_0x5c8668;await database_1[_0x990840(0x214)][_0x990840(0x1d8)][_0x990840(0x18b)]({'where':{'id':_0x2a89d4,'shopId':_0x583a06}});}async[a45_0x5c8668(0x1fa)](_0x350898){const _0x3d44a0=a45_0x5c8668,_0xe7d8fb=await database_1[_0x3d44a0(0x214)][_0x3d44a0(0x1d8)][_0x3d44a0(0x21d)]({'where':{'id':_0x350898},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0xe7d8fb)return null;const _0x47ba6b=_0xe7d8fb['expiresAt']&&_0xe7d8fb[_0x3d44a0(0x217)]<new Date(),_0x26bf3a=_0xe7d8fb['currentPayments']>=_0xe7d8fb[_0x3d44a0(0x1ae)],_0x362215=_0xe7d8fb[_0x3d44a0(0x215)][_0x3d44a0(0x186)]===_0x3d44a0(0x21e),_0x43e842=_0xe7d8fb[_0x3d44a0(0x186)]===_0x3d44a0(0x21e),_0x10c5d1=!_0x47ba6b&&!_0x26bf3a&&_0x362215&&_0x43e842,_0x809738=Math[_0x3d44a0(0x190)](0x0,_0xe7d8fb[_0x3d44a0(0x1ae)]-_0xe7d8fb[_0x3d44a0(0x205)]);return{'id':_0xe7d8fb['id'],'amount':_0xe7d8fb[_0x3d44a0(0x1e4)],'currency':_0xe7d8fb[_0x3d44a0(0x1c5)],'sourceCurrency':_0xe7d8fb[_0x3d44a0(0x1fb)]||undefined,'gateway':_0xe7d8fb[_0x3d44a0(0x1db)],'maxPayments':_0xe7d8fb[_0x3d44a0(0x1ae)],'currentPayments':_0xe7d8fb['currentPayments'],'status':_0xe7d8fb[_0x3d44a0(0x186)],'expiresAt':_0xe7d8fb[_0x3d44a0(0x217)]||undefined,'shopName':_0xe7d8fb[_0x3d44a0(0x215)][_0x3d44a0(0x219)],'isAvailable':_0x10c5d1,'remainingPayments':_0x809738};}async[a45_0x5c8668(0x193)](_0x4e5236){const _0x4502aa=a45_0x5c8668,{linkId:_0x7363d7,customerEmail:_0x51c324,customerName:_0x3a1e8a}=_0x4e5236,_0x2e2013=await database_1['default'][_0x4502aa(0x1d8)][_0x4502aa(0x21d)]({'where':{'id':_0x7363d7},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![]}}}});if(!_0x2e2013)throw new Error('Payment\x20link\x20not\x20found');const _0x5e1d08=_0x2e2013['expiresAt']&&_0x2e2013['expiresAt']<new Date(),_0x399e25=_0x2e2013[_0x4502aa(0x205)]>=_0x2e2013[_0x4502aa(0x1ae)],_0x483235=_0x2e2013[_0x4502aa(0x215)][_0x4502aa(0x186)]===_0x4502aa(0x21e),_0x10cffa=_0x2e2013[_0x4502aa(0x186)]===_0x4502aa(0x21e);if(_0x5e1d08)throw new Error(_0x4502aa(0x1e5));if(_0x399e25)throw new Error(_0x4502aa(0x1d0));if(!_0x483235)throw new Error(_0x4502aa(0x1a4));if(!_0x10cffa)throw new Error(_0x4502aa(0x18e));const _0x1a7975=_0x2e2013[_0x4502aa(0x1e4)];console[_0x4502aa(0x17e)]('ðŸ’³\x20Initiating\x20payment\x20from\x20link\x20'+_0x7363d7+':\x20'+_0x1a7975+'\x20'+_0x2e2013[_0x4502aa(0x1c5)]),console[_0x4502aa(0x17e)](_0x4502aa(0x206)+(_0x3a1e8a||_0x4502aa(0x1ab))+'\x20('+(_0x51c324||_0x4502aa(0x1aa))+')'),this['validateKlymeCurrency'](_0x2e2013[_0x4502aa(0x1db)],_0x2e2013[_0x4502aa(0x1c5)]);const _0x51718e=this['generateGatewayOrderId']();console[_0x4502aa(0x17e)](_0x4502aa(0x1d2)+_0x51718e+_0x4502aa(0x1b6)+_0x2e2013[_0x4502aa(0x1db)]+')');const _0x27cc9a=process['env'][_0x4502aa(0x1c7)]||'https://tesoft.uk',{finalSuccessUrl:_0x142f09,finalFailUrl:_0x13bd31,dbSuccessUrl:_0x33e1f5,dbFailUrl:_0x350ef1}=this[_0x4502aa(0x1be)](_0x2e2013[_0x4502aa(0x1db)],_0x51718e,_0x27cc9a,_0x2e2013[_0x4502aa(0x1a3)]||undefined,_0x2e2013[_0x4502aa(0x1f4)]||undefined),_0x1d123c=await database_1[_0x4502aa(0x214)]['payment'][_0x4502aa(0x1e3)]({'data':{'shopId':_0x2e2013[_0x4502aa(0x1b4)],'paymentLinkId':_0x2e2013['id'],'gateway':_0x2e2013[_0x4502aa(0x1db)],'amount':_0x1a7975,'currency':_0x2e2013[_0x4502aa(0x1c5)],'sourceCurrency':_0x2e2013[_0x4502aa(0x1fb)]||undefined,'usage':'ONCE','expiresAt':_0x2e2013[_0x4502aa(0x217)]||undefined,'successUrl':_0x33e1f5,'failUrl':_0x350ef1,'status':_0x4502aa(0x180),'orderId':null,'gatewayOrderId':_0x51718e,'customerEmail':_0x51c324||undefined,'customerName':_0x3a1e8a||undefined,'country':_0x2e2013[_0x4502aa(0x187)]||undefined,'language':_0x2e2013[_0x4502aa(0x1b5)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x4502aa(0x17e)](_0x4502aa(0x192)+_0x1d123c['id']),console[_0x4502aa(0x17e)](_0x4502aa(0x1a2)+_0x1a7975+'\x20'+_0x2e2013[_0x4502aa(0x1c5)]),console[_0x4502aa(0x17e)]('ðŸ‘¤\x20Customer:\x20'+(_0x3a1e8a||'Anonymous')+'\x20('+(_0x51c324||'no\x20email')+')'),console[_0x4502aa(0x17e)](_0x4502aa(0x201)+_0x33e1f5),console[_0x4502aa(0x17e)](_0x4502aa(0x1d9)+_0x350ef1);let _0x56ba2f,_0xde0aff;try{if(_0x2e2013[_0x4502aa(0x1db)]===_0x4502aa(0x1f5)){console[_0x4502aa(0x17e)](_0x4502aa(0x203)),console[_0x4502aa(0x17e)]('\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20'+_0x2e2013['currency']),console[_0x4502aa(0x17e)]('\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20'+_0x2e2013[_0x4502aa(0x1fb)]);const _0x3d28bf=await this[_0x4502aa(0x188)][_0x4502aa(0x1a6)]({'paymentId':_0x1d123c['id'],'orderId':_0x51718e,'amount':_0x1a7975,'currency':_0x2e2013[_0x4502aa(0x1c5)],'productName':'Payment\x20'+_0x1a7975+'\x20'+_0x2e2013[_0x4502aa(0x1c5)],'description':_0x4502aa(0x1b2)+_0x1a7975+'\x20'+_0x2e2013[_0x4502aa(0x1c5)],'successUrl':_0x142f09,'failUrl':_0x13bd31,'customerEmail':_0x51c324||undefined,'customerName':_0x3a1e8a||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x2e2013['sourceCurrency']||undefined});_0x56ba2f=_0x3d28bf[_0x4502aa(0x21a)],_0xde0aff=_0x3d28bf['payment_url'],await database_1[_0x4502aa(0x214)][_0x4502aa(0x18f)][_0x4502aa(0x1c8)]({'where':{'id':_0x1d123c['id']},'data':{'externalPaymentUrl':_0xde0aff,'gatewayPaymentId':_0x56ba2f,'invoiceTotalSum':Number(_0x3d28bf[_0x4502aa(0x1ad)]),'qrCode':_0x3d28bf['qr_code'],'qrUrl':_0x3d28bf['qr_url']}});const _0x2f4533=_0x4502aa(0x195)+_0x1d123c['id'];return console[_0x4502aa(0x17e)](_0x4502aa(0x208)+_0x2f4533),{'paymentId':_0x1d123c['id'],'paymentUrl':_0x2f4533,'expiresAt':_0x1d123c[_0x4502aa(0x217)]||undefined};}else{if(_0x2e2013[_0x4502aa(0x1db)]==='rapyd'){const _0x5e5da9=await this[_0x4502aa(0x204)][_0x4502aa(0x19d)]({'paymentId':_0x1d123c['id'],'orderId':_0x51718e,'orderName':_0x4502aa(0x1b2)+_0x1a7975+'\x20'+_0x2e2013[_0x4502aa(0x1c5)],'amount':_0x1a7975,'currency':_0x2e2013[_0x4502aa(0x1c5)],'country':_0x2e2013[_0x4502aa(0x187)],'language':_0x2e2013[_0x4502aa(0x1b5)]||'EN','amountIsEditable':![],'usage':_0x4502aa(0x17b),'maxPayments':0x1,'successUrl':_0x142f09,'failUrl':_0x13bd31});_0x56ba2f=_0x5e5da9[_0x4502aa(0x21a)],_0xde0aff=_0x5e5da9[_0x4502aa(0x1f3)],await database_1[_0x4502aa(0x214)][_0x4502aa(0x18f)][_0x4502aa(0x1c8)]({'where':{'id':_0x1d123c['id']},'data':{'externalPaymentUrl':_0xde0aff,'gatewayPaymentId':_0x56ba2f}});const _0x4d1e95=_0x4502aa(0x1ec)+_0x1d123c['id'];return console['log'](_0x4502aa(0x1a7)+_0x4d1e95),{'paymentId':_0x1d123c['id'],'paymentUrl':_0x4d1e95,'expiresAt':_0x1d123c[_0x4502aa(0x217)]||undefined};}else{if(_0x2e2013[_0x4502aa(0x1db)]===_0x4502aa(0x200)){const _0x355d2d=await this[_0x4502aa(0x212)][_0x4502aa(0x19d)]({'paymentId':_0x1d123c['id'],'orderId':_0x51718e,'name':_0x4502aa(0x1b2)+_0x1a7975+'\x20'+_0x2e2013['currency'],'paymentDescription':_0x4502aa(0x1b2)+_0x1a7975+'\x20'+_0x2e2013[_0x4502aa(0x1c5)],'amount':_0x1a7975,'currency':_0x2e2013[_0x4502aa(0x1c5)],'webhookUrl':'https://tesoft.uk/gateways/noda/webhook','returnUrl':_0x142f09,'expiryDate':_0x2e2013['expiresAt']?.['toISOString']()});_0x56ba2f=_0x355d2d[_0x4502aa(0x21a)],_0xde0aff=_0x355d2d[_0x4502aa(0x1f3)],await database_1['default'][_0x4502aa(0x18f)][_0x4502aa(0x1c8)]({'where':{'id':_0x1d123c['id']},'data':{'externalPaymentUrl':_0xde0aff,'gatewayPaymentId':_0x56ba2f,'qrUrl':_0x355d2d[_0x4502aa(0x1c0)]}});const _0x9f62af=_0x4502aa(0x1ec)+_0x1d123c['id'];return console[_0x4502aa(0x17e)](_0x4502aa(0x1b0)+_0x9f62af),{'paymentId':_0x1d123c['id'],'paymentUrl':_0x9f62af,'expiresAt':_0x1d123c[_0x4502aa(0x217)]||undefined};}else{if(_0x2e2013[_0x4502aa(0x1db)]==='cointopay'){console[_0x4502aa(0x17e)](_0x4502aa(0x1d6)+_0x51718e+_0x4502aa(0x1f0)),console[_0x4502aa(0x17e)](_0x4502aa(0x1a2)+_0x1a7975+_0x4502aa(0x213));const _0x7c6308=await this[_0x4502aa(0x181)][_0x4502aa(0x19d)]({'paymentId':_0x1d123c['id'],'orderId':_0x51718e,'amount':_0x1a7975});_0x56ba2f=_0x7c6308[_0x4502aa(0x21a)],_0xde0aff=_0x7c6308[_0x4502aa(0x1f3)],await database_1['default'][_0x4502aa(0x18f)][_0x4502aa(0x1c8)]({'where':{'id':_0x1d123c['id']},'data':{'externalPaymentUrl':_0xde0aff,'gatewayPaymentId':_0x56ba2f}});const _0xa655ec=_0x4502aa(0x1ec)+_0x1d123c['id'];return console[_0x4502aa(0x17e)](_0x4502aa(0x1e6)+_0xa655ec),{'paymentId':_0x1d123c['id'],'paymentUrl':_0xa655ec,'expiresAt':_0x1d123c[_0x4502aa(0x217)]||undefined};}else{if(_0x2e2013['gateway']['startsWith']('klyme_')){const _0x55b782=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x2e2013[_0x4502aa(0x1db)]);if(!_0x55b782)throw new Error(_0x4502aa(0x1c3)+_0x2e2013[_0x4502aa(0x1db)]);console[_0x4502aa(0x17e)](_0x4502aa(0x1dd)+_0x55b782+_0x4502aa(0x210)+_0x51718e+'\x20(8digits-8digits\x20format)'),console[_0x4502aa(0x17e)](_0x4502aa(0x1a2)+_0x1a7975+'\x20'+_0x2e2013['currency']+_0x4502aa(0x1c6)+_0x55b782+')');const _0x27ed90=await this[_0x4502aa(0x185)][_0x4502aa(0x19d)]({'paymentId':_0x1d123c['id'],'orderId':_0x51718e,'amount':_0x1a7975,'currency':_0x2e2013[_0x4502aa(0x1c5)],'region':_0x55b782,'redirectUrl':_0x142f09});_0x56ba2f=_0x27ed90[_0x4502aa(0x21a)],_0xde0aff=_0x27ed90[_0x4502aa(0x1f3)],await database_1['default'][_0x4502aa(0x18f)][_0x4502aa(0x1c8)]({'where':{'id':_0x1d123c['id']},'data':{'externalPaymentUrl':_0xde0aff,'gatewayPaymentId':_0x56ba2f}});const _0x199905=_0x4502aa(0x195)+_0x1d123c['id'];return console[_0x4502aa(0x17e)](_0x4502aa(0x21f)+_0x55b782+_0x4502aa(0x1ce)+_0x51718e),console['log'](_0x4502aa(0x1a0)+_0x55b782+_0x4502aa(0x1c1)+_0x199905),{'paymentId':_0x1d123c['id'],'paymentUrl':_0x199905,'expiresAt':_0x1d123c['expiresAt']||undefined};}else throw new Error(_0x4502aa(0x1f6)+_0x2e2013[_0x4502aa(0x1db)]);}}}}}catch(_0x5889a7){await database_1[_0x4502aa(0x214)][_0x4502aa(0x18f)]['update']({'where':{'id':_0x1d123c['id']},'data':{'status':_0x4502aa(0x1cf)}});throw new Error(_0x4502aa(0x20f)+(_0x5889a7 instanceof Error?_0x5889a7[_0x4502aa(0x1d4)]:'Unknown\x20error'));}}async[a45_0x5c8668(0x1bd)](_0x4aa5ae){const _0x2da799=a45_0x5c8668,_0x18f693=await database_1[_0x2da799(0x214)][_0x2da799(0x18f)][_0x2da799(0x21d)]({'where':{'id':_0x4aa5ae},'include':{'paymentLink':!![]}});if(!_0x18f693||!_0x18f693[_0x2da799(0x1d8)])return;const _0x4629fc=await database_1[_0x2da799(0x214)]['paymentLink'][_0x2da799(0x1c8)]({'where':{'id':_0x18f693[_0x2da799(0x20b)]},'data':{'currentPayments':{'increment':0x1}}});console[_0x2da799(0x17e)](_0x2da799(0x216)+_0x18f693['paymentLinkId']+'\x20payments:\x20'+_0x4629fc['currentPayments']+'/'+_0x4629fc[_0x2da799(0x1ae)]),_0x4629fc[_0x2da799(0x205)]>=_0x4629fc['maxPayments']&&(await database_1[_0x2da799(0x214)][_0x2da799(0x1d8)][_0x2da799(0x1c8)]({'where':{'id':_0x18f693['paymentLinkId']},'data':{'status':_0x2da799(0x18d)}}),console[_0x2da799(0x17e)](_0x2da799(0x1c4)+_0x18f693['paymentLinkId']+_0x2da799(0x1d7)));}async[a45_0x5c8668(0x1fc)](_0x1e15e2){const _0x1607e3=a45_0x5c8668,[_0x6104af,_0x1a340a,_0x5a7b82,_0x45864c]=await Promise[_0x1607e3(0x20e)]([database_1[_0x1607e3(0x214)][_0x1607e3(0x1d8)][_0x1607e3(0x199)]({'where':{'shopId':_0x1e15e2}}),database_1[_0x1607e3(0x214)]['paymentLink'][_0x1607e3(0x199)]({'where':{'shopId':_0x1e15e2,'status':_0x1607e3(0x21e)}}),database_1[_0x1607e3(0x214)][_0x1607e3(0x18f)][_0x1607e3(0x199)]({'where':{'shopId':_0x1e15e2,'paymentLinkId':{'not':null}}}),database_1[_0x1607e3(0x214)][_0x1607e3(0x18f)]['findMany']({'where':{'shopId':_0x1e15e2,'paymentLinkId':{'not':null},'status':_0x1607e3(0x1b1)},'select':{'amount':!![],'currency':!![]}})]);let _0x312ff3=0x0;for(const _0xa42854 of _0x45864c){const _0xfa8927=await currencyService_1['currencyService']['convertToUSDT'](_0xa42854[_0x1607e3(0x1e4)],_0xa42854[_0x1607e3(0x1c5)]);_0x312ff3+=_0xfa8927;}const _0x4fb312=_0x5a7b82>0x0?_0x45864c[_0x1607e3(0x1ff)]/_0x5a7b82*0x64:0x0;return{'totalLinks':_0x6104af,'activeLinks':_0x1a340a,'totalPayments':_0x5a7b82,'totalRevenue':Math[_0x1607e3(0x1f7)](_0x312ff3*0x64)/0x64,'conversionRate':Math[_0x1607e3(0x1f7)](_0x4fb312*0x64)/0x64};}['formatPaymentLinkResponse'](_0x254dab){const _0x54e3a5=a45_0x5c8668;return{'id':_0x254dab['id'],'shopId':_0x254dab[_0x54e3a5(0x1b4)],'amount':_0x254dab[_0x54e3a5(0x1e4)],'currency':_0x254dab['currency'],'sourceCurrency':_0x254dab[_0x54e3a5(0x1fb)]||undefined,'gateway':_0x254dab['gateway'],'maxPayments':_0x254dab[_0x54e3a5(0x1ae)],'currentPayments':_0x254dab[_0x54e3a5(0x205)],'status':_0x254dab['status'],'expiresAt':_0x254dab[_0x54e3a5(0x217)]||undefined,'successUrl':_0x254dab[_0x54e3a5(0x1a3)]||undefined,'failUrl':_0x254dab['failUrl']||undefined,'country':_0x254dab[_0x54e3a5(0x187)]||undefined,'language':_0x254dab[_0x54e3a5(0x1b5)]||undefined,'linkUrl':_0x54e3a5(0x1fe)+_0x254dab['id'],'createdAt':_0x254dab[_0x54e3a5(0x194)],'updatedAt':_0x254dab[_0x54e3a5(0x17d)],'shop':_0x254dab['shop'],'payments':_0x254dab[_0x54e3a5(0x1e0)]};}}function a45_0x298a(_0x4ba92f,_0x183ed0){const _0x2d77e3=a45_0x2d77();return a45_0x298a=function(_0x298a99,_0xec78e0){_0x298a99=_0x298a99-0x17b;let _0x4ccdb0=_0x2d77e3[_0x298a99];return _0x4ccdb0;},a45_0x298a(_0x4ba92f,_0x183ed0);}exports[a45_0x5c8668(0x222)]=PaymentLinkService;