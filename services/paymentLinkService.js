'use strict';const a45_0x3fe590=a45_0x3f10;(function(_0x5053ef,_0x2ec285){const _0x4c42c9=a45_0x3f10,_0x56817a=_0x5053ef();while(!![]){try{const _0x5d0d22=parseInt(_0x4c42c9(0x163))/0x1+parseInt(_0x4c42c9(0x17f))/0x2*(-parseInt(_0x4c42c9(0x14b))/0x3)+-parseInt(_0x4c42c9(0x16d))/0x4*(-parseInt(_0x4c42c9(0x140))/0x5)+parseInt(_0x4c42c9(0x157))/0x6+parseInt(_0x4c42c9(0x161))/0x7*(parseInt(_0x4c42c9(0x18c))/0x8)+parseInt(_0x4c42c9(0x18e))/0x9+-parseInt(_0x4c42c9(0x15a))/0xa;if(_0x5d0d22===_0x2ec285)break;else _0x56817a['push'](_0x56817a['shift']());}catch(_0x176e44){_0x56817a['push'](_0x56817a['shift']());}}}(a45_0x3703,0x2041f));var __importDefault=this&&this['__importDefault']||function(_0x59c865){const _0x3ace03=a45_0x3f10;return _0x59c865&&_0x59c865[_0x3ace03(0x187)]?_0x59c865:{'default':_0x59c865};};Object[a45_0x3fe590(0x13d)](exports,a45_0x3fe590(0x187),{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require(a45_0x3fe590(0x175))),plisioService_1=require(a45_0x3fe590(0x195)),rapydService_1=require(a45_0x3fe590(0x14e)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a45_0x3fe590(0x18b)),klymeService_1=require(a45_0x3fe590(0x194)),gateway_1=require(a45_0x3fe590(0x188)),currencyService_1=require(a45_0x3fe590(0x159));class PaymentLinkService{constructor(){const _0x58bba8=a45_0x3fe590;this[_0x58bba8(0x14f)]=new plisioService_1['PlisioService'](),this['rapydService']=new rapydService_1['RapydService'](),this[_0x58bba8(0x179)]=new nodaService_1[(_0x58bba8(0x141))](),this[_0x58bba8(0x154)]=new coinToPayService_1['CoinToPayService'](),this[_0x58bba8(0x142)]=new klymeService_1['KlymeService']();}[a45_0x3fe590(0x1cc)](){const _0x549947=()=>{const _0xfc349d=a45_0x3f10;return Math[_0xfc349d(0x1ca)](Math[_0xfc349d(0x170)]()*0x5f5e100)[_0xfc349d(0x1a5)]()['padStart'](0x8,'0');};return _0x549947()+'-'+_0x549947();}[a45_0x3fe590(0x1c9)](_0x3e8c90,_0x233240,_0x13627b,_0x11e7f2,_0x1908bb){const _0x34957c=a45_0x3fe590;if(_0x11e7f2&&_0x1908bb)return{'finalSuccessUrl':_0x11e7f2,'finalFailUrl':_0x1908bb,'dbSuccessUrl':_0x11e7f2,'dbFailUrl':_0x1908bb};let _0x5f1686,_0x25cbb6,_0x3eb2c2,_0x5b7ad6;return _0x3e8c90==='noda'||_0x3e8c90[_0x34957c(0x15f)](_0x34957c(0x1a0))?(_0x5f1686=_0x13627b+'/gateway/pending.php?id='+_0x233240,_0x3eb2c2=_0x34957c(0x1c4)):(_0x5f1686=_0x13627b+'/gateway/success.php?id='+_0x233240,_0x3eb2c2=_0x34957c(0x178)),_0x25cbb6=_0x13627b+'/gateway/fail.php?id='+_0x233240,_0x5b7ad6=_0x34957c(0x14a),console[_0x34957c(0x1a6)](_0x34957c(0x1c7)+_0x3e8c90+':'),console[_0x34957c(0x1a6)](_0x34957c(0x18a)+_0x5f1686),console[_0x34957c(0x1a6)](_0x34957c(0x1ce)+_0x25cbb6),console[_0x34957c(0x1a6)](_0x34957c(0x171)+_0x3eb2c2),console[_0x34957c(0x1a6)]('\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20'+_0x5b7ad6),{'finalSuccessUrl':_0x5f1686,'finalFailUrl':_0x25cbb6,'dbSuccessUrl':_0x3eb2c2,'dbFailUrl':_0x5b7ad6};}[a45_0x3fe590(0x1d2)](_0x5190e8,_0x1c3f30){const _0x28fe39=a45_0x3fe590;if(!_0x5190e8['startsWith'](_0x28fe39(0x1a0)))return;const _0x31e36b=(0x0,gateway_1[_0x28fe39(0x14c)])(_0x5190e8),_0x3112fe=_0x1c3f30[_0x28fe39(0x1a8)]();switch(_0x31e36b){case'EU':if(_0x3112fe!==_0x28fe39(0x1b3))throw new Error(_0x28fe39(0x13e)+_0x3112fe);break;case'GB':if(_0x3112fe!==_0x28fe39(0x1dc))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x3112fe);break;case'DE':if(_0x3112fe!==_0x28fe39(0x1b3))throw new Error(_0x28fe39(0x1a2)+_0x3112fe);break;default:throw new Error(_0x28fe39(0x1d1)+_0x31e36b);}}async[a45_0x3fe590(0x185)](_0x244855,_0x55942d){const _0x982a87=a45_0x3fe590;if(!(0x0,gateway_1[_0x982a87(0x180)])(_0x55942d['gateway']))throw new Error(_0x982a87(0x1d0)+_0x55942d[_0x982a87(0x198)]+'.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)');const _0x1d87b0=(0x0,gateway_1[_0x982a87(0x1a7)])(_0x55942d[_0x982a87(0x198)]);if(!_0x1d87b0)throw new Error(_0x982a87(0x162)+_0x55942d[_0x982a87(0x198)]);console[_0x982a87(0x1a6)](_0x982a87(0x1c8)+_0x1d87b0);if(_0x1d87b0===_0x982a87(0x17a)&&!_0x55942d['sourceCurrency'])throw new Error(_0x982a87(0x1b9));if(_0x1d87b0[_0x982a87(0x15f)](_0x982a87(0x1a0))){const _0x50e386=(0x0,gateway_1[_0x982a87(0x14c)])(_0x1d87b0);console[_0x982a87(0x1a6)](_0x982a87(0x19f)+_0x50e386+_0x982a87(0x1c0));}let _0x3b4ce0=_0x55942d['country'];_0x1d87b0===_0x982a87(0x1bf)&&(_0x3b4ce0='GB',console[_0x982a87(0x1a6)](_0x982a87(0x19d)));if(!_0x55942d[_0x982a87(0x1a9)]||_0x55942d[_0x982a87(0x1a9)]<=0x0)throw new Error(_0x982a87(0x1cd));let _0x2702dd=_0x55942d[_0x982a87(0x158)]||_0x982a87(0x1d9);_0x1d87b0===_0x982a87(0x174)&&(_0x2702dd=_0x982a87(0x1b3),console[_0x982a87(0x1a6)](_0x982a87(0x16c)));this[_0x982a87(0x1d2)](_0x1d87b0,_0x2702dd);const _0x221004=process['env']['BASE_URL']||_0x982a87(0x167),{finalSuccessUrl:_0x3418fd,finalFailUrl:_0x464d21,dbSuccessUrl:_0x28a924,dbFailUrl:_0x45f767}=this[_0x982a87(0x1c9)](_0x1d87b0,_0x982a87(0x176),_0x221004,_0x55942d['successUrl'],_0x55942d[_0x982a87(0x1be)]),_0x4ade8d=await database_1[_0x982a87(0x151)]['paymentLink'][_0x982a87(0x1a1)]({'data':{'shopId':_0x244855,'amount':_0x55942d[_0x982a87(0x1a9)],'currency':_0x2702dd,'sourceCurrency':_0x55942d['sourceCurrency']||undefined,'gateway':_0x1d87b0,'maxPayments':_0x55942d[_0x982a87(0x1c3)]||0x1,'currentPayments':0x0,'status':'ACTIVE','expiresAt':_0x55942d[_0x982a87(0x173)]?new Date(_0x55942d[_0x982a87(0x173)]):undefined,'successUrl':_0x28a924,'failUrl':_0x45f767,'country':_0x3b4ce0,'language':_0x55942d[_0x982a87(0x1b2)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x982a87(0x1a6)]('✅\x20Payment\x20link\x20created:\x20'+_0x4ade8d['id']+'\x20('+_0x1d87b0+')'),console[_0x982a87(0x1a6)]('💰\x20Fixed\x20amount:\x20'+_0x4ade8d[_0x982a87(0x1a9)]+'\x20'+_0x4ade8d[_0x982a87(0x158)]),console[_0x982a87(0x1a6)](_0x982a87(0x1db)+_0x4ade8d['id']),console['log'](_0x982a87(0x1bb)+_0x4ade8d[_0x982a87(0x1b6)]),console[_0x982a87(0x1a6)](_0x982a87(0x193)+_0x4ade8d[_0x982a87(0x1be)]),this[_0x982a87(0x1ad)](_0x4ade8d);}async[a45_0x3fe590(0x1b8)](_0xc028d3,_0x388658){const _0x1d0248=a45_0x3fe590,{page:_0x5348ae,limit:_0x236c72,status:_0x7bef1f,gateway:_0xed80c,search:_0x2531e4}=_0x388658,_0x2e4d22=(_0x5348ae-0x1)*_0x236c72,_0x159d60={'shopId':_0xc028d3};_0x7bef1f&&(_0x159d60[_0x1d0248(0x17b)]=_0x7bef1f['toUpperCase']());if(_0xed80c){if((0x0,gateway_1[_0x1d0248(0x180)])(_0xed80c)){const _0x4fe0fb=(0x0,gateway_1[_0x1d0248(0x1a7)])(_0xed80c);_0x4fe0fb&&(_0x159d60['gateway']=_0x4fe0fb);}else _0x159d60['gateway']=_0xed80c[_0x1d0248(0x147)]();}_0x2531e4&&(_0x159d60['OR']=[{'gateway':{'contains':_0x2531e4,'mode':'insensitive'}},{'currency':{'contains':_0x2531e4,'mode':_0x1d0248(0x18f)}}]);const [_0x3650f3,_0x83835b]=await Promise[_0x1d0248(0x19a)]([database_1[_0x1d0248(0x151)][_0x1d0248(0x166)]['findMany']({'where':_0x159d60,'skip':_0x2e4d22,'take':_0x236c72,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}}),database_1['default'][_0x1d0248(0x166)][_0x1d0248(0x1d4)]({'where':_0x159d60})]);return{'links':_0x3650f3[_0x1d0248(0x1da)](_0x8aac93=>this['formatPaymentLinkResponse'](_0x8aac93)),'pagination':{'page':_0x5348ae,'limit':_0x236c72,'total':_0x83835b,'totalPages':Math[_0x1d0248(0x149)](_0x83835b/_0x236c72)}};}async[a45_0x3fe590(0x1ae)](_0x2bd1a0,_0x5dba27){const _0x4ff5e3=a45_0x3fe590,_0x3ca432=await database_1[_0x4ff5e3(0x151)][_0x4ff5e3(0x166)][_0x4ff5e3(0x186)]({'where':{'id':_0x5dba27,'shopId':_0x2bd1a0},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x4ff5e3(0x1d7)}}}});if(!_0x3ca432)return null;return this[_0x4ff5e3(0x1ad)](_0x3ca432);}async['updatePaymentLink'](_0x114c67,_0x33e2dd,_0x7d4ed2){const _0xa0ce8d=a45_0x3fe590,_0x308b51={..._0x7d4ed2};if(_0x7d4ed2[_0xa0ce8d(0x198)]){if((0x0,gateway_1['isValidGatewayId'])(_0x7d4ed2[_0xa0ce8d(0x198)])){const _0x26d4d8=(0x0,gateway_1[_0xa0ce8d(0x1a7)])(_0x7d4ed2[_0xa0ce8d(0x198)]);_0x26d4d8&&(_0x308b51['gateway']=_0x26d4d8);}else _0x308b51[_0xa0ce8d(0x198)]=_0x7d4ed2[_0xa0ce8d(0x198)][_0xa0ce8d(0x147)]();}(_0x308b51[_0xa0ce8d(0x198)]===_0xa0ce8d(0x1bf)||_0x7d4ed2['country']&&_0x308b51[_0xa0ce8d(0x198)]!==_0xa0ce8d(0x1bf))&&(_0x308b51['gateway']===_0xa0ce8d(0x1bf)&&(_0x308b51[_0xa0ce8d(0x16e)]='GB',console['log']('🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update')));_0x308b51[_0xa0ce8d(0x198)]===_0xa0ce8d(0x174)&&(_0x308b51[_0xa0ce8d(0x158)]=_0xa0ce8d(0x1b3),console['log'](_0xa0ce8d(0x13f)));_0x308b51['gateway']&&_0x308b51[_0xa0ce8d(0x158)]&&this[_0xa0ce8d(0x1d2)](_0x308b51[_0xa0ce8d(0x198)],_0x308b51[_0xa0ce8d(0x158)]);_0x7d4ed2['expiresAt']&&(_0x308b51[_0xa0ce8d(0x173)]=new Date(_0x7d4ed2['expiresAt']));const _0x5e14fa=await database_1[_0xa0ce8d(0x151)][_0xa0ce8d(0x166)][_0xa0ce8d(0x1b7)]({'where':{'id':_0x33e2dd,'shopId':_0x114c67},'data':_0x308b51,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}});return this['formatPaymentLinkResponse'](_0x5e14fa);}async[a45_0x3fe590(0x1a3)](_0x59022a,_0x42e240){const _0x4b6df5=a45_0x3fe590;await database_1['default']['paymentLink'][_0x4b6df5(0x182)]({'where':{'id':_0x42e240,'shopId':_0x59022a}});}async[a45_0x3fe590(0x1dd)](_0x224d8d){const _0x2928cc=a45_0x3fe590,_0xb61e79=await database_1[_0x2928cc(0x151)]['paymentLink'][_0x2928cc(0x17e)]({'where':{'id':_0x224d8d},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0xb61e79)return null;const _0x27baa6=_0xb61e79['expiresAt']&&_0xb61e79['expiresAt']<new Date(),_0x5f5c9d=_0xb61e79[_0x2928cc(0x1d5)]>=_0xb61e79[_0x2928cc(0x1c3)],_0x31c86a=_0xb61e79[_0x2928cc(0x150)]['status']==='ACTIVE',_0x2937c0=_0xb61e79[_0x2928cc(0x17b)]===_0x2928cc(0x192),_0x1afb69=!_0x27baa6&&!_0x5f5c9d&&_0x31c86a&&_0x2937c0,_0x55563f=Math[_0x2928cc(0x19b)](0x0,_0xb61e79[_0x2928cc(0x1c3)]-_0xb61e79[_0x2928cc(0x1d5)]);return{'id':_0xb61e79['id'],'amount':_0xb61e79[_0x2928cc(0x1a9)],'currency':_0xb61e79[_0x2928cc(0x158)],'sourceCurrency':_0xb61e79[_0x2928cc(0x18d)]||undefined,'gateway':_0xb61e79[_0x2928cc(0x198)],'maxPayments':_0xb61e79[_0x2928cc(0x1c3)],'currentPayments':_0xb61e79['currentPayments'],'status':_0xb61e79[_0x2928cc(0x17b)],'expiresAt':_0xb61e79[_0x2928cc(0x173)]||undefined,'shopName':_0xb61e79['shop']['name'],'isAvailable':_0x1afb69,'remainingPayments':_0x55563f};}async[a45_0x3fe590(0x155)](_0x5be362){const _0x2e0c51=a45_0x3fe590,{linkId:_0x3ff4c0,customerEmail:_0x4f216c,customerName:_0x3cdf14}=_0x5be362,_0x20b49f=await database_1[_0x2e0c51(0x151)]['paymentLink'][_0x2e0c51(0x17e)]({'where':{'id':_0x3ff4c0},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![]}}}});if(!_0x20b49f)throw new Error('Payment\x20link\x20not\x20found');const _0x5bab30=_0x20b49f[_0x2e0c51(0x173)]&&_0x20b49f['expiresAt']<new Date(),_0x44a1ab=_0x20b49f[_0x2e0c51(0x1d5)]>=_0x20b49f[_0x2e0c51(0x1c3)],_0x35d2af=_0x20b49f[_0x2e0c51(0x150)][_0x2e0c51(0x17b)]==='ACTIVE',_0x746f92=_0x20b49f[_0x2e0c51(0x17b)]===_0x2e0c51(0x192);if(_0x5bab30)throw new Error(_0x2e0c51(0x15d));if(_0x44a1ab)throw new Error(_0x2e0c51(0x164));if(!_0x35d2af)throw new Error(_0x2e0c51(0x181));if(!_0x746f92)throw new Error('Payment\x20link\x20is\x20not\x20active');const _0x8cda23=_0x20b49f[_0x2e0c51(0x1a9)];console['log']('💳\x20Initiating\x20payment\x20from\x20link\x20'+_0x3ff4c0+':\x20'+_0x8cda23+'\x20'+_0x20b49f[_0x2e0c51(0x158)]),console['log'](_0x2e0c51(0x1af)+(_0x3cdf14||_0x2e0c51(0x153))+'\x20('+(_0x4f216c||_0x2e0c51(0x145))+')'),this[_0x2e0c51(0x1d2)](_0x20b49f[_0x2e0c51(0x198)],_0x20b49f[_0x2e0c51(0x158)]);const _0x194255=this[_0x2e0c51(0x1cc)]();console[_0x2e0c51(0x1a6)]('🎯\x20Generated\x20gateway\x20order_id:\x20'+_0x194255+'\x20(8digits-8digits\x20format\x20for\x20'+_0x20b49f['gateway']+')');const _0x53f293=process[_0x2e0c51(0x1ac)][_0x2e0c51(0x16b)]||'https://tesoft.uk',{finalSuccessUrl:_0x1c7c10,finalFailUrl:_0x2e3b57,dbSuccessUrl:_0x3c98a0,dbFailUrl:_0x19af21}=this['generateGatewayUrls'](_0x20b49f['gateway'],_0x194255,_0x53f293,_0x20b49f[_0x2e0c51(0x1b6)]||undefined,_0x20b49f['failUrl']||undefined),_0x1724f0=await database_1[_0x2e0c51(0x151)][_0x2e0c51(0x1cb)][_0x2e0c51(0x1a1)]({'data':{'shopId':_0x20b49f[_0x2e0c51(0x143)],'paymentLinkId':_0x20b49f['id'],'gateway':_0x20b49f[_0x2e0c51(0x198)],'amount':_0x8cda23,'currency':_0x20b49f[_0x2e0c51(0x158)],'sourceCurrency':_0x20b49f['sourceCurrency']||undefined,'usage':_0x2e0c51(0x15e),'expiresAt':_0x20b49f[_0x2e0c51(0x173)]||undefined,'successUrl':_0x3c98a0,'failUrl':_0x19af21,'status':_0x2e0c51(0x1c5),'orderId':null,'gatewayOrderId':_0x194255,'customerEmail':_0x4f216c||undefined,'customerName':_0x3cdf14||undefined,'country':_0x20b49f[_0x2e0c51(0x16e)]||undefined,'language':_0x20b49f[_0x2e0c51(0x1b2)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console['log']('💾\x20Payment\x20created\x20from\x20link:\x20'+_0x1724f0['id']),console[_0x2e0c51(0x1a6)](_0x2e0c51(0x17c)+_0x8cda23+'\x20'+_0x20b49f[_0x2e0c51(0x158)]),console[_0x2e0c51(0x1a6)]('👤\x20Customer:\x20'+(_0x3cdf14||_0x2e0c51(0x153))+'\x20('+(_0x4f216c||_0x2e0c51(0x145))+')'),console[_0x2e0c51(0x1a6)]('💾\x20DB\x20Success\x20URL:\x20'+_0x3c98a0),console['log']('💾\x20DB\x20Fail\x20URL:\x20'+_0x19af21);let _0x42ba9c,_0x1536e4;try{if(_0x20b49f['gateway']==='plisio'){console[_0x2e0c51(0x1a6)](_0x2e0c51(0x1a4)),console[_0x2e0c51(0x1a6)](_0x2e0c51(0x16f)+_0x20b49f[_0x2e0c51(0x158)]),console['log'](_0x2e0c51(0x199)+_0x20b49f[_0x2e0c51(0x18d)]);const _0x25f60a=await this[_0x2e0c51(0x14f)]['createPayment']({'paymentId':_0x1724f0['id'],'orderId':_0x194255,'amount':_0x8cda23,'currency':_0x20b49f[_0x2e0c51(0x158)],'productName':'Payment\x20'+_0x8cda23+'\x20'+_0x20b49f[_0x2e0c51(0x158)],'description':_0x2e0c51(0x190)+_0x8cda23+'\x20'+_0x20b49f[_0x2e0c51(0x158)],'successUrl':_0x1c7c10,'failUrl':_0x2e3b57,'customerEmail':_0x4f216c||undefined,'customerName':_0x3cdf14||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x20b49f['sourceCurrency']||undefined});_0x42ba9c=_0x25f60a[_0x2e0c51(0x17d)],_0x1536e4=_0x25f60a[_0x2e0c51(0x1bc)],await database_1[_0x2e0c51(0x151)]['payment'][_0x2e0c51(0x1b7)]({'where':{'id':_0x1724f0['id']},'data':{'externalPaymentUrl':_0x1536e4,'gatewayPaymentId':_0x42ba9c,'invoiceTotalSum':Number(_0x25f60a[_0x2e0c51(0x165)]),'qrCode':_0x25f60a[_0x2e0c51(0x1b0)],'qrUrl':_0x25f60a[_0x2e0c51(0x172)]}});const _0x3b767d=_0x2e0c51(0x156)+_0x1724f0['id'];return console[_0x2e0c51(0x1a6)](_0x2e0c51(0x1bd)+_0x3b767d),{'paymentId':_0x1724f0['id'],'paymentUrl':_0x3b767d,'expiresAt':_0x1724f0[_0x2e0c51(0x173)]||undefined};}else{if(_0x20b49f['gateway']===_0x2e0c51(0x1bf)){const _0x677204=await this[_0x2e0c51(0x1b1)][_0x2e0c51(0x185)]({'paymentId':_0x1724f0['id'],'orderId':_0x194255,'orderName':_0x2e0c51(0x190)+_0x8cda23+'\x20'+_0x20b49f[_0x2e0c51(0x158)],'amount':_0x8cda23,'currency':_0x20b49f[_0x2e0c51(0x158)],'country':_0x20b49f['country'],'language':_0x20b49f[_0x2e0c51(0x1b2)]||'EN','amountIsEditable':![],'usage':'ONCE','maxPayments':0x1,'successUrl':_0x1c7c10,'failUrl':_0x2e3b57});_0x42ba9c=_0x677204['gateway_payment_id'],_0x1536e4=_0x677204['payment_url'],await database_1['default'][_0x2e0c51(0x1cb)][_0x2e0c51(0x1b7)]({'where':{'id':_0x1724f0['id']},'data':{'externalPaymentUrl':_0x1536e4,'gatewayPaymentId':_0x42ba9c}});const _0x375421=_0x2e0c51(0x177)+_0x1724f0['id'];return console[_0x2e0c51(0x1a6)](_0x2e0c51(0x146)+_0x375421),{'paymentId':_0x1724f0['id'],'paymentUrl':_0x375421,'expiresAt':_0x1724f0[_0x2e0c51(0x173)]||undefined};}else{if(_0x20b49f['gateway']==='noda'){const _0x6363fc=await this[_0x2e0c51(0x179)][_0x2e0c51(0x185)]({'paymentId':_0x1724f0['id'],'orderId':_0x194255,'name':_0x2e0c51(0x190)+_0x8cda23+'\x20'+_0x20b49f['currency'],'paymentDescription':_0x2e0c51(0x190)+_0x8cda23+'\x20'+_0x20b49f[_0x2e0c51(0x158)],'amount':_0x8cda23,'currency':_0x20b49f['currency'],'webhookUrl':_0x2e0c51(0x189),'returnUrl':_0x1c7c10,'expiryDate':_0x20b49f['expiresAt']?.[_0x2e0c51(0x196)]()});_0x42ba9c=_0x6363fc['gateway_payment_id'],_0x1536e4=_0x6363fc[_0x2e0c51(0x1bc)],await database_1[_0x2e0c51(0x151)][_0x2e0c51(0x1cb)]['update']({'where':{'id':_0x1724f0['id']},'data':{'externalPaymentUrl':_0x1536e4,'gatewayPaymentId':_0x42ba9c,'qrUrl':_0x6363fc[_0x2e0c51(0x1c2)]}});const _0x5aaf67='https://tesoft.uk/gateway/payment.php?id='+_0x1724f0['id'];return console[_0x2e0c51(0x1a6)](_0x2e0c51(0x1d8)+_0x5aaf67),{'paymentId':_0x1724f0['id'],'paymentUrl':_0x5aaf67,'expiresAt':_0x1724f0[_0x2e0c51(0x173)]||undefined};}else{if(_0x20b49f[_0x2e0c51(0x198)]==='cointopay'){console[_0x2e0c51(0x1a6)](_0x2e0c51(0x168)+_0x194255+'\x20(8digits-8digits\x20format)'),console[_0x2e0c51(0x1a6)](_0x2e0c51(0x17c)+_0x8cda23+_0x2e0c51(0x1d6));const _0x23739f=await this[_0x2e0c51(0x154)][_0x2e0c51(0x185)]({'paymentId':_0x1724f0['id'],'orderId':_0x194255,'amount':_0x8cda23});_0x42ba9c=_0x23739f[_0x2e0c51(0x17d)],_0x1536e4=_0x23739f['payment_url'],await database_1[_0x2e0c51(0x151)][_0x2e0c51(0x1cb)][_0x2e0c51(0x1b7)]({'where':{'id':_0x1724f0['id']},'data':{'externalPaymentUrl':_0x1536e4,'gatewayPaymentId':_0x42ba9c}});const _0x11e168=_0x2e0c51(0x177)+_0x1724f0['id'];return console[_0x2e0c51(0x1a6)]('🔗\x20CoinToPay\x20payment\x20URL:\x20'+_0x11e168),{'paymentId':_0x1724f0['id'],'paymentUrl':_0x11e168,'expiresAt':_0x1724f0['expiresAt']||undefined};}else{if(_0x20b49f[_0x2e0c51(0x198)][_0x2e0c51(0x15f)]('klyme_')){const _0x11121b=(0x0,gateway_1[_0x2e0c51(0x14c)])(_0x20b49f[_0x2e0c51(0x198)]);if(!_0x11121b)throw new Error(_0x2e0c51(0x15c)+_0x20b49f[_0x2e0c51(0x198)]);console[_0x2e0c51(0x1a6)](_0x2e0c51(0x19f)+_0x11121b+_0x2e0c51(0x197)+_0x194255+_0x2e0c51(0x16a)),console['log']('💰\x20Amount:\x20'+_0x8cda23+'\x20'+_0x20b49f['currency']+_0x2e0c51(0x1b5)+_0x11121b+')');const _0x144b33=await this[_0x2e0c51(0x142)]['createPaymentLink']({'paymentId':_0x1724f0['id'],'orderId':_0x194255,'amount':_0x8cda23,'currency':_0x20b49f['currency'],'region':_0x11121b,'redirectUrl':_0x1c7c10});_0x42ba9c=_0x144b33[_0x2e0c51(0x17d)],_0x1536e4=_0x144b33[_0x2e0c51(0x1bc)],await database_1[_0x2e0c51(0x151)][_0x2e0c51(0x1cb)][_0x2e0c51(0x1b7)]({'where':{'id':_0x1724f0['id']},'data':{'externalPaymentUrl':_0x1536e4,'gatewayPaymentId':_0x42ba9c}});const _0x580309=_0x2e0c51(0x156)+_0x1724f0['id'];return console['log']('✅\x20KLYME\x20'+_0x11121b+_0x2e0c51(0x19c)+_0x194255),console[_0x2e0c51(0x1a6)](_0x2e0c51(0x191)+_0x11121b+'\x20payment\x20URL:\x20'+_0x580309),{'paymentId':_0x1724f0['id'],'paymentUrl':_0x580309,'expiresAt':_0x1724f0[_0x2e0c51(0x173)]||undefined};}else throw new Error(_0x2e0c51(0x1b4)+_0x20b49f[_0x2e0c51(0x198)]);}}}}}catch(_0xd711d1){await database_1[_0x2e0c51(0x151)][_0x2e0c51(0x1cb)]['update']({'where':{'id':_0x1724f0['id']},'data':{'status':_0x2e0c51(0x1ba)}});throw new Error(_0x2e0c51(0x1de)+(_0xd711d1 instanceof Error?_0xd711d1[_0x2e0c51(0x15b)]:_0x2e0c51(0x1cf)));}}async['handleSuccessfulPayment'](_0x41a1ff){const _0x2b138d=a45_0x3fe590,_0x59d530=await database_1['default'][_0x2b138d(0x1cb)]['findUnique']({'where':{'id':_0x41a1ff},'include':{'paymentLink':!![]}});if(!_0x59d530||!_0x59d530[_0x2b138d(0x166)])return;const _0x1dce54=await database_1[_0x2b138d(0x151)][_0x2b138d(0x166)][_0x2b138d(0x1b7)]({'where':{'id':_0x59d530[_0x2b138d(0x148)]},'data':{'currentPayments':{'increment':0x1}}});console[_0x2b138d(0x1a6)]('📈\x20Payment\x20link\x20'+_0x59d530[_0x2b138d(0x148)]+_0x2b138d(0x152)+_0x1dce54[_0x2b138d(0x1d5)]+'/'+_0x1dce54['maxPayments']),_0x1dce54[_0x2b138d(0x1d5)]>=_0x1dce54[_0x2b138d(0x1c3)]&&(await database_1[_0x2b138d(0x151)]['paymentLink'][_0x2b138d(0x1b7)]({'where':{'id':_0x59d530[_0x2b138d(0x148)]},'data':{'status':_0x2b138d(0x160)}}),console[_0x2b138d(0x1a6)](_0x2b138d(0x1d3)+_0x59d530[_0x2b138d(0x148)]+'\x20completed\x20(reached\x20max\x20payments)'));}async[a45_0x3fe590(0x144)](_0x43d147){const _0x4fb536=a45_0x3fe590,[_0x1b5bfe,_0x153b56,_0x22b34a,_0x4f13ac]=await Promise['all']([database_1[_0x4fb536(0x151)][_0x4fb536(0x166)]['count']({'where':{'shopId':_0x43d147}}),database_1[_0x4fb536(0x151)]['paymentLink'][_0x4fb536(0x1d4)]({'where':{'shopId':_0x43d147,'status':'ACTIVE'}}),database_1[_0x4fb536(0x151)]['payment'][_0x4fb536(0x1d4)]({'where':{'shopId':_0x43d147,'paymentLinkId':{'not':null}}}),database_1['default'][_0x4fb536(0x1cb)]['findMany']({'where':{'shopId':_0x43d147,'paymentLinkId':{'not':null},'status':_0x4fb536(0x14d)},'select':{'amount':!![],'currency':!![]}})]);let _0x4df892=0x0;for(const _0x270d32 of _0x4f13ac){const _0x36d39e=await currencyService_1[_0x4fb536(0x1c6)][_0x4fb536(0x184)](_0x270d32['amount'],_0x270d32[_0x4fb536(0x158)]);_0x4df892+=_0x36d39e;}const _0x307bb8=_0x22b34a>0x0?_0x4f13ac[_0x4fb536(0x183)]/_0x22b34a*0x64:0x0;return{'totalLinks':_0x1b5bfe,'activeLinks':_0x153b56,'totalPayments':_0x22b34a,'totalRevenue':Math[_0x4fb536(0x19e)](_0x4df892*0x64)/0x64,'conversionRate':Math[_0x4fb536(0x19e)](_0x307bb8*0x64)/0x64};}[a45_0x3fe590(0x1ad)](_0x3af6fd){const _0x677a30=a45_0x3fe590;return{'id':_0x3af6fd['id'],'shopId':_0x3af6fd[_0x677a30(0x143)],'amount':_0x3af6fd['amount'],'currency':_0x3af6fd[_0x677a30(0x158)],'sourceCurrency':_0x3af6fd['sourceCurrency']||undefined,'gateway':_0x3af6fd[_0x677a30(0x198)],'maxPayments':_0x3af6fd[_0x677a30(0x1c3)],'currentPayments':_0x3af6fd[_0x677a30(0x1d5)],'status':_0x3af6fd[_0x677a30(0x17b)],'expiresAt':_0x3af6fd[_0x677a30(0x173)]||undefined,'successUrl':_0x3af6fd['successUrl']||undefined,'failUrl':_0x3af6fd[_0x677a30(0x1be)]||undefined,'country':_0x3af6fd[_0x677a30(0x16e)]||undefined,'language':_0x3af6fd[_0x677a30(0x1b2)]||undefined,'linkUrl':_0x677a30(0x1aa)+_0x3af6fd['id'],'createdAt':_0x3af6fd[_0x677a30(0x1ab)],'updatedAt':_0x3af6fd[_0x677a30(0x169)],'shop':_0x3af6fd[_0x677a30(0x150)],'payments':_0x3af6fd[_0x677a30(0x1c1)]};}}function a45_0x3703(){const _0x15282f=['Anonymous','coinToPayService','initiatePaymentFromLink','https://app.trapay.uk/payment/','404610OXQoJF','currency','./currencyService','4156660XnYKyZ','message','Invalid\x20KLYME\x20gateway:\x20','Payment\x20link\x20has\x20expired','ONCE','startsWith','COMPLETED','161uPiPEw','Gateway\x20not\x20found\x20for\x20ID:\x20','134026AKcTUo','Payment\x20link\x20has\x20reached\x20maximum\x20payments','invoice_total_sum','paymentLink','https://tesoft.uk','🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','updatedAt','\x20(8digits-8digits\x20format)','BASE_URL','🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','20KKqIVd','country','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','random','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','qr_url','expiresAt','cointopay','../config/database','PLACEHOLDER','https://tesoft.uk/gateway/payment.php?id=','https://app.trapay.uk/payment/success','nodaService','plisio','status','💰\x20Amount:\x20','gateway_payment_id','findUnique','2WIWyhk','isValidGatewayId','Shop\x20is\x20not\x20active','delete','length','convertToUSDT','createPaymentLink','findFirst','__esModule','../types/gateway','https://tesoft.uk/gateways/noda/webhook','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','./gateways/coinToPayService','88664muOtrP','sourceCurrency','526068UXIECb','insensitive','Payment\x20','🔗\x20KLYME\x20','ACTIVE','❌\x20DB\x20Fail\x20URL:\x20','./gateways/klymeService','./gateways/plisioService','toISOString','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','gateway','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','all','max','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','round','💳\x20Creating\x20KLYME\x20','klyme_','create','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','deletePaymentLink','💰\x20Plisio\x20payment\x20link\x20mapping:','toString','log','getGatewayNameById','toUpperCase','amount','https://app.trapay.uk/link/','createdAt','env','formatPaymentLinkResponse','getPaymentLinkById','👤\x20Customer:\x20','qr_code','rapydService','language','EUR','Unsupported\x20gateway:\x20','\x20(validated\x20for\x20','successUrl','update','getPaymentLinks','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','FAILED','✅\x20DB\x20Success\x20URL:\x20','payment_url','🔗\x20Plisio\x20payment\x20URL:\x20','failUrl','rapyd','\x20payment\x20link','payments','qr_code_url','maxPayments','https://app.trapay.uk/payment/pending','PENDING','currencyService','🔗\x20Generated\x20URLs\x20for\x20','🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','generateGatewayUrls','floor','payment','generateGatewayOrderId','amount\x20is\x20required\x20and\x20must\x20be\x20positive','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','Unknown\x20error','Invalid\x20gateway\x20ID:\x20','Unsupported\x20KLYME\x20region:\x20','validateKlymeCurrency','🏁\x20Payment\x20link\x20','count','currentPayments','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','desc','🔗\x20Noda\x20payment\x20URL:\x20','USD','map','🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/','GBP','getPublicPaymentLinkData','Gateway\x20error:\x20','PaymentLinkService','defineProperty','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','178830LWHTGP','NodaService','klymeService','shopId','getPaymentLinkStatistics','no\x20email','🔗\x20Rapyd\x20payment\x20URL:\x20','toLowerCase','paymentLinkId','ceil','https://app.trapay.uk/payment/fail','437577XeyScl','getKlymeRegionFromGatewayName','PAID','./gateways/rapydService','plisioService','shop','default','\x20payments:\x20'];a45_0x3703=function(){return _0x15282f;};return a45_0x3703();}function a45_0x3f10(_0x259128,_0x1b9a9f){const _0x370363=a45_0x3703();return a45_0x3f10=function(_0x3f1052,_0x3ccecf){_0x3f1052=_0x3f1052-0x13d;let _0x52f10e=_0x370363[_0x3f1052];return _0x52f10e;},a45_0x3f10(_0x259128,_0x1b9a9f);}exports[a45_0x3fe590(0x1df)]=PaymentLinkService;