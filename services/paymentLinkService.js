'use strict';const a45_0x235534=a45_0x41f7;(function(_0x31501e,_0x216a83){const _0x4c8dd3=a45_0x41f7,_0xd60774=_0x31501e();while(!![]){try{const _0x5ebdc2=-parseInt(_0x4c8dd3(0x19d))/0x1*(parseInt(_0x4c8dd3(0x155))/0x2)+parseInt(_0x4c8dd3(0x171))/0x3+-parseInt(_0x4c8dd3(0x16c))/0x4+parseInt(_0x4c8dd3(0x153))/0x5*(parseInt(_0x4c8dd3(0x156))/0x6)+parseInt(_0x4c8dd3(0x131))/0x7+parseInt(_0x4c8dd3(0x119))/0x8+-parseInt(_0x4c8dd3(0x136))/0x9*(parseInt(_0x4c8dd3(0x121))/0xa);if(_0x5ebdc2===_0x216a83)break;else _0xd60774['push'](_0xd60774['shift']());}catch(_0xc1d3e2){_0xd60774['push'](_0xd60774['shift']());}}}(a45_0x280d,0x340ac));function a45_0x280d(){const _0x41b7ff=['formatPaymentLinkResponse','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','__importDefault','failUrl','rapyd','üîó\x20KLYME\x20','ceil','getKlymeRegionFromGatewayName','Invalid\x20gateway\x20ID:\x20','COMPLETED','üí∞\x20Amount:\x20','FAILED','createdAt','desc','toString','265424qzvRPp','üíæ\x20DB\x20Success\x20URL:\x20','Payment\x20link\x20has\x20reached\x20maximum\x20payments','/gateway/fail.php?id=','invoice_total_sum','767403Npcwli','Payment\x20','PENDING','map','GBP','gateway','üë§\x20Customer:\x20','deletePaymentLink','isValidGatewayId','status','startsWith','https://app.trapay.uk/payment/pending','qr_url','\x20payment\x20URL:\x20','initiatePaymentFromLink','https://tesoft.uk','üîó\x20CoinToPay\x20payment\x20URL:\x20','generateGatewayUrls','üíæ\x20Payment\x20created\x20from\x20link:\x20','üí≥\x20Creating\x20KLYME\x20','Payment\x20link\x20has\x20expired','all','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','NodaService','Invalid\x20KLYME\x20gateway:\x20','Gateway\x20error:\x20','./gateways/coinToPayService','ONCE','/gateway/success.php?id=','https://app.trapay.uk/payment/','default','üá¨üáß\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','getPaymentLinkStatistics','coinToPayService','rapydService','noda','count','BASE_URL','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','toLowerCase','/gateway/pending.php?id=','cointopay','\x20payment\x20link','findFirst','6pfDysr','gateway_payment_id','validateKlymeCurrency','PaymentLinkService','currency','updatedAt','no\x20email','amount','maxPayments','üí≥\x20Initiating\x20payment\x20from\x20link\x20','qr_code_url','payment','\x20(validated\x20for\x20','../types/gateway','PlisioService','Payment\x20link\x20not\x20found','EUR','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','‚úÖ\x20KLYME\x20','insensitive','findUnique','ü™ô\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','qr_code','padStart','./gateways/plisioService','üîó\x20Plisio\x20payment\x20URL:\x20','currencyService','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','üîó\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','plisio','successUrl','üîó\x20Generated\x20URLs\x20for\x20','createPaymentLink','‚úÖ\x20DB\x20Success\x20URL:\x20','./gateways/rapydService','nodaService','PLACEHOLDER','getPaymentLinks','‚ùå\x20DB\x20Fail\x20URL:\x20','2374520FTcEED','https://app.trapay.uk/payment/fail','ü™ô\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','https://app.trapay.uk/link/','üîó\x20Noda\x20payment\x20URL:\x20','üí∞\x20Plisio\x20payment\x20link\x20mapping:','https://tesoft.uk/gateway/payment.php?id=','convertToUSDT','451690Rndjbw','‚úÖ\x20Payment\x20link\x20created:\x20','round','üéØ\x20Generated\x20gateway\x20order_id:\x20','expiresAt','env','KlymeService','message','üá¨üáß\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','\x20\x20\x20üíæ\x20DB\x20Fail\x20URL:\x20','payments','country','max','paymentLink','currentPayments','generateGatewayOrderId','54054thYFZX','klyme_','Unsupported\x20gateway:\x20','getPaymentLinkById','getGatewayNameById','54lDnLxZ','floor','toUpperCase','create','USD','update','üìà\x20Payment\x20link\x20','length','\x20(8digits-8digits\x20format\x20for\x20','shopId','payment_url','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','./gateways/klymeService','Gateway\x20not\x20found\x20for\x20ID:\x20','plisioService','log','\x20payments:\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','toISOString','\x20\x20\x20üåê\x20Gateway\x20Success\x20URL:\x20','ACTIVE','getPublicPaymentLinkData','\x20completed\x20(reached\x20max\x20payments)','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','paymentLinkId','sourceCurrency','amount\x20is\x20required\x20and\x20must\x20be\x20positive','shop','üîó\x20Rapyd\x20payment\x20URL:\x20','5aMzsUf','language','119624RGyRYj','2094408NNEnIu','PAID','Unknown\x20error','Unsupported\x20KLYME\x20region:\x20','\x20\x20\x20üíæ\x20DB\x20Success\x20URL:\x20','__esModule','findMany'];a45_0x280d=function(){return _0x41b7ff;};return a45_0x280d();}var __importDefault=this&&this[a45_0x235534(0x15f)]||function(_0x3cf859){const _0x563a32=a45_0x235534;return _0x3cf859&&_0x3cf859[_0x563a32(0x15b)]?_0x3cf859:{'default':_0x3cf859};};Object['defineProperty'](exports,a45_0x235534(0x15b),{'value':!![]}),exports[a45_0x235534(0x1a0)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a45_0x235534(0x109)),rapydService_1=require(a45_0x235534(0x114)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a45_0x235534(0x18b)),klymeService_1=require(a45_0x235534(0x142)),gateway_1=require(a45_0x235534(0x1aa)),currencyService_1=require('./currencyService');function a45_0x41f7(_0x465951,_0x3e563a){const _0x280d14=a45_0x280d();return a45_0x41f7=function(_0x41f746,_0x56d999){_0x41f746=_0x41f746-0xff;let _0x139e12=_0x280d14[_0x41f746];return _0x139e12;},a45_0x41f7(_0x465951,_0x3e563a);}class PaymentLinkService{constructor(){const _0x1775dc=a45_0x235534;this[_0x1775dc(0x144)]=new plisioService_1[(_0x1775dc(0xff))](),this[_0x1775dc(0x193)]=new rapydService_1['RapydService'](),this['nodaService']=new nodaService_1[(_0x1775dc(0x188))](),this[_0x1775dc(0x192)]=new coinToPayService_1['CoinToPayService'](),this['klymeService']=new klymeService_1[(_0x1775dc(0x127))]();}[a45_0x235534(0x130)](){const _0x5722f7=()=>{const _0x5e8a8e=a45_0x41f7;return Math[_0x5e8a8e(0x137)](Math['random']()*0x5f5e100)[_0x5e8a8e(0x16b)]()[_0x5e8a8e(0x108)](0x8,'0');};return _0x5722f7()+'-'+_0x5722f7();}['generateGatewayUrls'](_0x509cb3,_0x7405e8,_0x21966e,_0x2b94eb,_0x1aea2a){const _0xefa9a4=a45_0x235534;if(_0x2b94eb&&_0x1aea2a)return{'finalSuccessUrl':_0x2b94eb,'finalFailUrl':_0x1aea2a,'dbSuccessUrl':_0x2b94eb,'dbFailUrl':_0x1aea2a};let _0x10b541,_0xee6224,_0x2e7dbf,_0x4d03e3;return _0x509cb3===_0xefa9a4(0x194)||_0x509cb3[_0xefa9a4(0x17b)](_0xefa9a4(0x132))?(_0x10b541=_0x21966e+_0xefa9a4(0x199)+_0x7405e8,_0x2e7dbf=_0xefa9a4(0x17c)):(_0x10b541=_0x21966e+_0xefa9a4(0x18d)+_0x7405e8,_0x2e7dbf='https://app.trapay.uk/payment/success'),_0xee6224=_0x21966e+_0xefa9a4(0x16f)+_0x7405e8,_0x4d03e3=_0xefa9a4(0x11a),console[_0xefa9a4(0x145)](_0xefa9a4(0x111)+_0x509cb3+':'),console['log'](_0xefa9a4(0x149)+_0x10b541),console[_0xefa9a4(0x145)]('\x20\x20\x20üåê\x20Gateway\x20Fail\x20URL:\x20'+_0xee6224),console[_0xefa9a4(0x145)](_0xefa9a4(0x15a)+_0x2e7dbf),console['log'](_0xefa9a4(0x12a)+_0x4d03e3),{'finalSuccessUrl':_0x10b541,'finalFailUrl':_0xee6224,'dbSuccessUrl':_0x2e7dbf,'dbFailUrl':_0x4d03e3};}['validateKlymeCurrency'](_0x141045,_0x5c2118){const _0x1e05bd=a45_0x235534;if(!_0x141045[_0x1e05bd(0x17b)](_0x1e05bd(0x132)))return;const _0x5569fa=(0x0,gateway_1[_0x1e05bd(0x164)])(_0x141045),_0x151021=_0x5c2118['toUpperCase']();switch(_0x5569fa){case'EU':if(_0x151021!==_0x1e05bd(0x101))throw new Error(_0x1e05bd(0x147)+_0x151021);break;case'GB':if(_0x151021!==_0x1e05bd(0x175))throw new Error(_0x1e05bd(0x10d)+_0x151021);break;case'DE':if(_0x151021!=='EUR')throw new Error(_0x1e05bd(0x15e)+_0x151021);break;default:throw new Error(_0x1e05bd(0x159)+_0x5569fa);}}async[a45_0x235534(0x112)](_0x23c351,_0x1f2251){const _0x6df6db=a45_0x235534;if(!(0x0,gateway_1[_0x6df6db(0x179)])(_0x1f2251[_0x6df6db(0x176)]))throw new Error(_0x6df6db(0x165)+_0x1f2251['gateway']+'.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)');const _0x4c6992=(0x0,gateway_1[_0x6df6db(0x135)])(_0x1f2251['gateway']);if(!_0x4c6992)throw new Error(_0x6df6db(0x143)+_0x1f2251[_0x6df6db(0x176)]);console[_0x6df6db(0x145)](_0x6df6db(0x10e)+_0x4c6992);if(_0x4c6992===_0x6df6db(0x10f)&&!_0x1f2251[_0x6df6db(0x14f)])throw new Error(_0x6df6db(0x10c));if(_0x4c6992[_0x6df6db(0x17b)]('klyme_')){const _0xe5b5fb=(0x0,gateway_1[_0x6df6db(0x164)])(_0x4c6992);console[_0x6df6db(0x145)](_0x6df6db(0x184)+_0xe5b5fb+_0x6df6db(0x19b));}let _0x456acd=_0x1f2251[_0x6df6db(0x12c)];_0x4c6992===_0x6df6db(0x161)&&(_0x456acd='GB',console[_0x6df6db(0x145)](_0x6df6db(0x190)));if(!_0x1f2251[_0x6df6db(0x1a4)]||_0x1f2251['amount']<=0x0)throw new Error(_0x6df6db(0x150));let _0x24961e=_0x1f2251[_0x6df6db(0x1a1)]||_0x6df6db(0x13a);_0x4c6992===_0x6df6db(0x19a)&&(_0x24961e=_0x6df6db(0x101),console[_0x6df6db(0x145)]('ü™ô\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link'));this['validateKlymeCurrency'](_0x4c6992,_0x24961e);const _0xa101fd=process[_0x6df6db(0x126)][_0x6df6db(0x196)]||_0x6df6db(0x180),{finalSuccessUrl:_0x487f94,finalFailUrl:_0x1a08e5,dbSuccessUrl:_0x382fda,dbFailUrl:_0x1e3182}=this[_0x6df6db(0x182)](_0x4c6992,_0x6df6db(0x116),_0xa101fd,_0x1f2251['successUrl'],_0x1f2251[_0x6df6db(0x160)]),_0x22067c=await database_1[_0x6df6db(0x18f)][_0x6df6db(0x12e)][_0x6df6db(0x139)]({'data':{'shopId':_0x23c351,'amount':_0x1f2251[_0x6df6db(0x1a4)],'currency':_0x24961e,'sourceCurrency':_0x1f2251['sourceCurrency']||undefined,'gateway':_0x4c6992,'maxPayments':_0x1f2251[_0x6df6db(0x1a5)]||0x1,'currentPayments':0x0,'status':_0x6df6db(0x14a),'expiresAt':_0x1f2251[_0x6df6db(0x125)]?new Date(_0x1f2251[_0x6df6db(0x125)]):undefined,'successUrl':_0x382fda,'failUrl':_0x1e3182,'country':_0x456acd,'language':_0x1f2251[_0x6df6db(0x154)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x6df6db(0x145)](_0x6df6db(0x122)+_0x22067c['id']+'\x20('+_0x4c6992+')'),console[_0x6df6db(0x145)]('üí∞\x20Fixed\x20amount:\x20'+_0x22067c[_0x6df6db(0x1a4)]+'\x20'+_0x22067c[_0x6df6db(0x1a1)]),console[_0x6df6db(0x145)]('üîó\x20Link\x20URL:\x20https://app.trapay.uk/link/'+_0x22067c['id']),console[_0x6df6db(0x145)](_0x6df6db(0x113)+_0x22067c[_0x6df6db(0x110)]),console[_0x6df6db(0x145)](_0x6df6db(0x118)+_0x22067c[_0x6df6db(0x160)]),this['formatPaymentLinkResponse'](_0x22067c);}async[a45_0x235534(0x117)](_0x4bcad3,_0x2b6a86){const _0x207b2f=a45_0x235534,{page:_0x548925,limit:_0x437e65,status:_0x41ba00,gateway:_0x594129,search:_0x716546}=_0x2b6a86,_0x2d063d=(_0x548925-0x1)*_0x437e65,_0x20275f={'shopId':_0x4bcad3};_0x41ba00&&(_0x20275f[_0x207b2f(0x17a)]=_0x41ba00[_0x207b2f(0x138)]());if(_0x594129){if((0x0,gateway_1[_0x207b2f(0x179)])(_0x594129)){const _0x328376=(0x0,gateway_1[_0x207b2f(0x135)])(_0x594129);_0x328376&&(_0x20275f['gateway']=_0x328376);}else _0x20275f[_0x207b2f(0x176)]=_0x594129[_0x207b2f(0x198)]();}_0x716546&&(_0x20275f['OR']=[{'gateway':{'contains':_0x716546,'mode':_0x207b2f(0x104)}},{'currency':{'contains':_0x716546,'mode':_0x207b2f(0x104)}}]);const [_0x4f463a,_0x1cc935]=await Promise[_0x207b2f(0x186)]([database_1[_0x207b2f(0x18f)]['paymentLink'][_0x207b2f(0x15c)]({'where':_0x20275f,'skip':_0x2d063d,'take':_0x437e65,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}}),database_1['default']['paymentLink'][_0x207b2f(0x195)]({'where':_0x20275f})]);return{'links':_0x4f463a[_0x207b2f(0x174)](_0x537da1=>this[_0x207b2f(0x15d)](_0x537da1)),'pagination':{'page':_0x548925,'limit':_0x437e65,'total':_0x1cc935,'totalPages':Math[_0x207b2f(0x163)](_0x1cc935/_0x437e65)}};}async[a45_0x235534(0x134)](_0x4ec771,_0x418bed){const _0x138d4f=a45_0x235534,_0x37d4f0=await database_1[_0x138d4f(0x18f)][_0x138d4f(0x12e)][_0x138d4f(0x19c)]({'where':{'id':_0x418bed,'shopId':_0x4ec771},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'}}}});if(!_0x37d4f0)return null;return this[_0x138d4f(0x15d)](_0x37d4f0);}async['updatePaymentLink'](_0x109ab3,_0x1b96bb,_0x27c8c8){const _0xfc9155=a45_0x235534,_0x3c4d21={..._0x27c8c8};if(_0x27c8c8[_0xfc9155(0x176)]){if((0x0,gateway_1[_0xfc9155(0x179)])(_0x27c8c8[_0xfc9155(0x176)])){const _0x384fa0=(0x0,gateway_1[_0xfc9155(0x135)])(_0x27c8c8[_0xfc9155(0x176)]);_0x384fa0&&(_0x3c4d21[_0xfc9155(0x176)]=_0x384fa0);}else _0x3c4d21['gateway']=_0x27c8c8['gateway'][_0xfc9155(0x198)]();}(_0x3c4d21[_0xfc9155(0x176)]===_0xfc9155(0x161)||_0x27c8c8[_0xfc9155(0x12c)]&&_0x3c4d21[_0xfc9155(0x176)]!==_0xfc9155(0x161))&&(_0x3c4d21[_0xfc9155(0x176)]===_0xfc9155(0x161)&&(_0x3c4d21[_0xfc9155(0x12c)]='GB',console[_0xfc9155(0x145)](_0xfc9155(0x129))));_0x3c4d21[_0xfc9155(0x176)]===_0xfc9155(0x19a)&&(_0x3c4d21[_0xfc9155(0x1a1)]='EUR',console['log'](_0xfc9155(0x11b)));_0x3c4d21[_0xfc9155(0x176)]&&_0x3c4d21['currency']&&this[_0xfc9155(0x19f)](_0x3c4d21[_0xfc9155(0x176)],_0x3c4d21[_0xfc9155(0x1a1)]);_0x27c8c8[_0xfc9155(0x125)]&&(_0x3c4d21[_0xfc9155(0x125)]=new Date(_0x27c8c8['expiresAt']));const _0x183add=await database_1[_0xfc9155(0x18f)][_0xfc9155(0x12e)][_0xfc9155(0x13b)]({'where':{'id':_0x1b96bb,'shopId':_0x109ab3},'data':_0x3c4d21,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0xfc9155(0x16a)},'take':0xa}}});return this[_0xfc9155(0x15d)](_0x183add);}async[a45_0x235534(0x178)](_0x1bb6f0,_0x4bdb4d){const _0x5dada0=a45_0x235534;await database_1[_0x5dada0(0x18f)][_0x5dada0(0x12e)]['delete']({'where':{'id':_0x4bdb4d,'shopId':_0x1bb6f0}});}async[a45_0x235534(0x14b)](_0x1fe38d){const _0x56e48d=a45_0x235534,_0x16ed80=await database_1['default'][_0x56e48d(0x12e)]['findUnique']({'where':{'id':_0x1fe38d},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x16ed80)return null;const _0x172670=_0x16ed80[_0x56e48d(0x125)]&&_0x16ed80[_0x56e48d(0x125)]<new Date(),_0x3c89f0=_0x16ed80[_0x56e48d(0x12f)]>=_0x16ed80[_0x56e48d(0x1a5)],_0x4ad3d3=_0x16ed80['shop'][_0x56e48d(0x17a)]===_0x56e48d(0x14a),_0x4f1aad=_0x16ed80[_0x56e48d(0x17a)]===_0x56e48d(0x14a),_0x578a69=!_0x172670&&!_0x3c89f0&&_0x4ad3d3&&_0x4f1aad,_0x93e6ac=Math[_0x56e48d(0x12d)](0x0,_0x16ed80['maxPayments']-_0x16ed80[_0x56e48d(0x12f)]);return{'id':_0x16ed80['id'],'amount':_0x16ed80['amount'],'currency':_0x16ed80[_0x56e48d(0x1a1)],'sourceCurrency':_0x16ed80[_0x56e48d(0x14f)]||undefined,'gateway':_0x16ed80[_0x56e48d(0x176)],'maxPayments':_0x16ed80[_0x56e48d(0x1a5)],'currentPayments':_0x16ed80[_0x56e48d(0x12f)],'status':_0x16ed80['status'],'expiresAt':_0x16ed80[_0x56e48d(0x125)]||undefined,'shopName':_0x16ed80[_0x56e48d(0x151)]['name'],'isAvailable':_0x578a69,'remainingPayments':_0x93e6ac};}async[a45_0x235534(0x17f)](_0x12f3d6){const _0x11a942=a45_0x235534,{linkId:_0x24b67e,customerEmail:_0x2667a0,customerName:_0x1a93cb}=_0x12f3d6,_0x45a92f=await database_1['default'][_0x11a942(0x12e)]['findUnique']({'where':{'id':_0x24b67e},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![]}}}});if(!_0x45a92f)throw new Error(_0x11a942(0x100));const _0x2eac34=_0x45a92f[_0x11a942(0x125)]&&_0x45a92f['expiresAt']<new Date(),_0x4095a4=_0x45a92f[_0x11a942(0x12f)]>=_0x45a92f[_0x11a942(0x1a5)],_0x3d69a0=_0x45a92f['shop']['status']===_0x11a942(0x14a),_0xb2961=_0x45a92f['status']==='ACTIVE';if(_0x2eac34)throw new Error(_0x11a942(0x185));if(_0x4095a4)throw new Error(_0x11a942(0x16e));if(!_0x3d69a0)throw new Error('Shop\x20is\x20not\x20active');if(!_0xb2961)throw new Error('Payment\x20link\x20is\x20not\x20active');const _0xe88f74=_0x45a92f['amount'];console[_0x11a942(0x145)](_0x11a942(0x1a6)+_0x24b67e+':\x20'+_0xe88f74+'\x20'+_0x45a92f[_0x11a942(0x1a1)]),console[_0x11a942(0x145)](_0x11a942(0x177)+(_0x1a93cb||'Anonymous')+'\x20('+(_0x2667a0||_0x11a942(0x1a3))+')'),this[_0x11a942(0x19f)](_0x45a92f['gateway'],_0x45a92f['currency']);const _0x3ea767=this['generateGatewayOrderId']();console[_0x11a942(0x145)](_0x11a942(0x124)+_0x3ea767+_0x11a942(0x13e)+_0x45a92f[_0x11a942(0x176)]+')');const _0xbf7143=process['env'][_0x11a942(0x196)]||_0x11a942(0x180),{finalSuccessUrl:_0x1de2d3,finalFailUrl:_0x5327c0,dbSuccessUrl:_0x3b7207,dbFailUrl:_0x46f171}=this[_0x11a942(0x182)](_0x45a92f[_0x11a942(0x176)],_0x3ea767,_0xbf7143,_0x45a92f[_0x11a942(0x110)]||undefined,_0x45a92f['failUrl']||undefined),_0x46e168=await database_1['default']['payment'][_0x11a942(0x139)]({'data':{'shopId':_0x45a92f[_0x11a942(0x13f)],'paymentLinkId':_0x45a92f['id'],'gateway':_0x45a92f['gateway'],'amount':_0xe88f74,'currency':_0x45a92f['currency'],'sourceCurrency':_0x45a92f[_0x11a942(0x14f)]||undefined,'usage':'ONCE','expiresAt':_0x45a92f[_0x11a942(0x125)]||undefined,'successUrl':_0x3b7207,'failUrl':_0x46f171,'status':_0x11a942(0x173),'orderId':null,'gatewayOrderId':_0x3ea767,'customerEmail':_0x2667a0||undefined,'customerName':_0x1a93cb||undefined,'country':_0x45a92f['country']||undefined,'language':_0x45a92f['language']||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x11a942(0x145)](_0x11a942(0x183)+_0x46e168['id']),console[_0x11a942(0x145)](_0x11a942(0x167)+_0xe88f74+'\x20'+_0x45a92f[_0x11a942(0x1a1)]),console[_0x11a942(0x145)](_0x11a942(0x177)+(_0x1a93cb||'Anonymous')+'\x20('+(_0x2667a0||_0x11a942(0x1a3))+')'),console['log'](_0x11a942(0x16d)+_0x3b7207),console['log']('üíæ\x20DB\x20Fail\x20URL:\x20'+_0x46f171);let _0x3654f8,_0x5205f2;try{if(_0x45a92f[_0x11a942(0x176)]==='plisio'){console[_0x11a942(0x145)](_0x11a942(0x11e)),console['log'](_0x11a942(0x102)+_0x45a92f['currency']),console['log'](_0x11a942(0x141)+_0x45a92f[_0x11a942(0x14f)]);const _0x3b5711=await this[_0x11a942(0x144)]['createPayment']({'paymentId':_0x46e168['id'],'orderId':_0x3ea767,'amount':_0xe88f74,'currency':_0x45a92f['currency'],'productName':_0x11a942(0x172)+_0xe88f74+'\x20'+_0x45a92f['currency'],'description':'Payment\x20'+_0xe88f74+'\x20'+_0x45a92f[_0x11a942(0x1a1)],'successUrl':_0x1de2d3,'failUrl':_0x5327c0,'customerEmail':_0x2667a0||undefined,'customerName':_0x1a93cb||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x45a92f[_0x11a942(0x14f)]||undefined});_0x3654f8=_0x3b5711['gateway_payment_id'],_0x5205f2=_0x3b5711['payment_url'],await database_1[_0x11a942(0x18f)][_0x11a942(0x1a8)][_0x11a942(0x13b)]({'where':{'id':_0x46e168['id']},'data':{'externalPaymentUrl':_0x5205f2,'gatewayPaymentId':_0x3654f8,'invoiceTotalSum':Number(_0x3b5711[_0x11a942(0x170)]),'qrCode':_0x3b5711[_0x11a942(0x107)],'qrUrl':_0x3b5711[_0x11a942(0x17d)]}});const _0x16b6ee=_0x11a942(0x18e)+_0x46e168['id'];return console[_0x11a942(0x145)](_0x11a942(0x10a)+_0x16b6ee),{'paymentId':_0x46e168['id'],'paymentUrl':_0x16b6ee,'expiresAt':_0x46e168[_0x11a942(0x125)]||undefined};}else{if(_0x45a92f['gateway']===_0x11a942(0x161)){const _0x14d60e=await this[_0x11a942(0x193)][_0x11a942(0x112)]({'paymentId':_0x46e168['id'],'orderId':_0x3ea767,'orderName':_0x11a942(0x172)+_0xe88f74+'\x20'+_0x45a92f[_0x11a942(0x1a1)],'amount':_0xe88f74,'currency':_0x45a92f[_0x11a942(0x1a1)],'country':_0x45a92f[_0x11a942(0x12c)],'language':_0x45a92f['language']||'EN','amountIsEditable':![],'usage':_0x11a942(0x18c),'maxPayments':0x1,'successUrl':_0x1de2d3,'failUrl':_0x5327c0});_0x3654f8=_0x14d60e[_0x11a942(0x19e)],_0x5205f2=_0x14d60e[_0x11a942(0x140)],await database_1['default']['payment']['update']({'where':{'id':_0x46e168['id']},'data':{'externalPaymentUrl':_0x5205f2,'gatewayPaymentId':_0x3654f8}});const _0x10d076=_0x11a942(0x11f)+_0x46e168['id'];return console[_0x11a942(0x145)](_0x11a942(0x152)+_0x10d076),{'paymentId':_0x46e168['id'],'paymentUrl':_0x10d076,'expiresAt':_0x46e168[_0x11a942(0x125)]||undefined};}else{if(_0x45a92f['gateway']===_0x11a942(0x194)){const _0x58cd88=await this[_0x11a942(0x115)][_0x11a942(0x112)]({'paymentId':_0x46e168['id'],'orderId':_0x3ea767,'name':_0x11a942(0x172)+_0xe88f74+'\x20'+_0x45a92f[_0x11a942(0x1a1)],'paymentDescription':'Payment\x20'+_0xe88f74+'\x20'+_0x45a92f[_0x11a942(0x1a1)],'amount':_0xe88f74,'currency':_0x45a92f[_0x11a942(0x1a1)],'webhookUrl':'https://tesoft.uk/gateways/noda/webhook','returnUrl':_0x1de2d3,'expiryDate':_0x45a92f[_0x11a942(0x125)]?.[_0x11a942(0x148)]()});_0x3654f8=_0x58cd88[_0x11a942(0x19e)],_0x5205f2=_0x58cd88['payment_url'],await database_1[_0x11a942(0x18f)][_0x11a942(0x1a8)]['update']({'where':{'id':_0x46e168['id']},'data':{'externalPaymentUrl':_0x5205f2,'gatewayPaymentId':_0x3654f8,'qrUrl':_0x58cd88[_0x11a942(0x1a7)]}});const _0x3bfe1c=_0x11a942(0x11f)+_0x46e168['id'];return console[_0x11a942(0x145)](_0x11a942(0x11d)+_0x3bfe1c),{'paymentId':_0x46e168['id'],'paymentUrl':_0x3bfe1c,'expiresAt':_0x46e168[_0x11a942(0x125)]||undefined};}else{if(_0x45a92f['gateway']===_0x11a942(0x19a)){console['log'](_0x11a942(0x106)+_0x3ea767+'\x20(8digits-8digits\x20format)'),console[_0x11a942(0x145)]('üí∞\x20Amount:\x20'+_0xe88f74+_0x11a942(0x197));const _0x222a08=await this[_0x11a942(0x192)][_0x11a942(0x112)]({'paymentId':_0x46e168['id'],'orderId':_0x3ea767,'amount':_0xe88f74});_0x3654f8=_0x222a08[_0x11a942(0x19e)],_0x5205f2=_0x222a08['payment_url'],await database_1[_0x11a942(0x18f)][_0x11a942(0x1a8)][_0x11a942(0x13b)]({'where':{'id':_0x46e168['id']},'data':{'externalPaymentUrl':_0x5205f2,'gatewayPaymentId':_0x3654f8}});const _0x3a9adc=_0x11a942(0x11f)+_0x46e168['id'];return console[_0x11a942(0x145)](_0x11a942(0x181)+_0x3a9adc),{'paymentId':_0x46e168['id'],'paymentUrl':_0x3a9adc,'expiresAt':_0x46e168[_0x11a942(0x125)]||undefined};}else{if(_0x45a92f[_0x11a942(0x176)][_0x11a942(0x17b)]('klyme_')){const _0x4639ca=(0x0,gateway_1[_0x11a942(0x164)])(_0x45a92f[_0x11a942(0x176)]);if(!_0x4639ca)throw new Error(_0x11a942(0x189)+_0x45a92f[_0x11a942(0x176)]);console['log'](_0x11a942(0x184)+_0x4639ca+_0x11a942(0x14d)+_0x3ea767+'\x20(8digits-8digits\x20format)'),console[_0x11a942(0x145)](_0x11a942(0x167)+_0xe88f74+'\x20'+_0x45a92f[_0x11a942(0x1a1)]+_0x11a942(0x1a9)+_0x4639ca+')');const _0x174051=await this['klymeService'][_0x11a942(0x112)]({'paymentId':_0x46e168['id'],'orderId':_0x3ea767,'amount':_0xe88f74,'currency':_0x45a92f[_0x11a942(0x1a1)],'region':_0x4639ca,'redirectUrl':_0x1de2d3});_0x3654f8=_0x174051[_0x11a942(0x19e)],_0x5205f2=_0x174051[_0x11a942(0x140)],await database_1[_0x11a942(0x18f)]['payment'][_0x11a942(0x13b)]({'where':{'id':_0x46e168['id']},'data':{'externalPaymentUrl':_0x5205f2,'gatewayPaymentId':_0x3654f8}});const _0x2cf8de=_0x11a942(0x18e)+_0x46e168['id'];return console['log'](_0x11a942(0x103)+_0x4639ca+_0x11a942(0x187)+_0x3ea767),console['log'](_0x11a942(0x162)+_0x4639ca+_0x11a942(0x17e)+_0x2cf8de),{'paymentId':_0x46e168['id'],'paymentUrl':_0x2cf8de,'expiresAt':_0x46e168[_0x11a942(0x125)]||undefined};}else throw new Error(_0x11a942(0x133)+_0x45a92f[_0x11a942(0x176)]);}}}}}catch(_0x1af4a7){await database_1[_0x11a942(0x18f)]['payment'][_0x11a942(0x13b)]({'where':{'id':_0x46e168['id']},'data':{'status':_0x11a942(0x168)}});throw new Error(_0x11a942(0x18a)+(_0x1af4a7 instanceof Error?_0x1af4a7[_0x11a942(0x128)]:_0x11a942(0x158)));}}async['handleSuccessfulPayment'](_0x2d6fa6){const _0x4f93e2=a45_0x235534,_0x2c505a=await database_1[_0x4f93e2(0x18f)][_0x4f93e2(0x1a8)][_0x4f93e2(0x105)]({'where':{'id':_0x2d6fa6},'include':{'paymentLink':!![]}});if(!_0x2c505a||!_0x2c505a[_0x4f93e2(0x12e)])return;const _0x164829=await database_1[_0x4f93e2(0x18f)][_0x4f93e2(0x12e)][_0x4f93e2(0x13b)]({'where':{'id':_0x2c505a[_0x4f93e2(0x14e)]},'data':{'currentPayments':{'increment':0x1}}});console[_0x4f93e2(0x145)](_0x4f93e2(0x13c)+_0x2c505a['paymentLinkId']+_0x4f93e2(0x146)+_0x164829[_0x4f93e2(0x12f)]+'/'+_0x164829[_0x4f93e2(0x1a5)]),_0x164829[_0x4f93e2(0x12f)]>=_0x164829['maxPayments']&&(await database_1[_0x4f93e2(0x18f)][_0x4f93e2(0x12e)][_0x4f93e2(0x13b)]({'where':{'id':_0x2c505a['paymentLinkId']},'data':{'status':_0x4f93e2(0x166)}}),console[_0x4f93e2(0x145)]('üèÅ\x20Payment\x20link\x20'+_0x2c505a[_0x4f93e2(0x14e)]+_0x4f93e2(0x14c)));}async[a45_0x235534(0x191)](_0x1cc686){const _0x26cce5=a45_0x235534,[_0x5ee419,_0x2a3372,_0x4193e2,_0x238457]=await Promise[_0x26cce5(0x186)]([database_1['default'][_0x26cce5(0x12e)][_0x26cce5(0x195)]({'where':{'shopId':_0x1cc686}}),database_1['default'][_0x26cce5(0x12e)][_0x26cce5(0x195)]({'where':{'shopId':_0x1cc686,'status':_0x26cce5(0x14a)}}),database_1[_0x26cce5(0x18f)][_0x26cce5(0x1a8)][_0x26cce5(0x195)]({'where':{'shopId':_0x1cc686,'paymentLinkId':{'not':null}}}),database_1[_0x26cce5(0x18f)][_0x26cce5(0x1a8)][_0x26cce5(0x15c)]({'where':{'shopId':_0x1cc686,'paymentLinkId':{'not':null},'status':_0x26cce5(0x157)},'select':{'amount':!![],'currency':!![]}})]);let _0x178058=0x0;for(const _0x357b64 of _0x238457){const _0xa60fd8=await currencyService_1[_0x26cce5(0x10b)][_0x26cce5(0x120)](_0x357b64[_0x26cce5(0x1a4)],_0x357b64[_0x26cce5(0x1a1)]);_0x178058+=_0xa60fd8;}const _0x4f201b=_0x4193e2>0x0?_0x238457[_0x26cce5(0x13d)]/_0x4193e2*0x64:0x0;return{'totalLinks':_0x5ee419,'activeLinks':_0x2a3372,'totalPayments':_0x4193e2,'totalRevenue':Math[_0x26cce5(0x123)](_0x178058*0x64)/0x64,'conversionRate':Math[_0x26cce5(0x123)](_0x4f201b*0x64)/0x64};}['formatPaymentLinkResponse'](_0x1473a6){const _0x589b1b=a45_0x235534;return{'id':_0x1473a6['id'],'shopId':_0x1473a6[_0x589b1b(0x13f)],'amount':_0x1473a6[_0x589b1b(0x1a4)],'currency':_0x1473a6[_0x589b1b(0x1a1)],'sourceCurrency':_0x1473a6[_0x589b1b(0x14f)]||undefined,'gateway':_0x1473a6[_0x589b1b(0x176)],'maxPayments':_0x1473a6[_0x589b1b(0x1a5)],'currentPayments':_0x1473a6['currentPayments'],'status':_0x1473a6[_0x589b1b(0x17a)],'expiresAt':_0x1473a6[_0x589b1b(0x125)]||undefined,'successUrl':_0x1473a6[_0x589b1b(0x110)]||undefined,'failUrl':_0x1473a6['failUrl']||undefined,'country':_0x1473a6[_0x589b1b(0x12c)]||undefined,'language':_0x1473a6[_0x589b1b(0x154)]||undefined,'linkUrl':_0x589b1b(0x11c)+_0x1473a6['id'],'createdAt':_0x1473a6[_0x589b1b(0x169)],'updatedAt':_0x1473a6[_0x589b1b(0x1a2)],'shop':_0x1473a6[_0x589b1b(0x151)],'payments':_0x1473a6[_0x589b1b(0x12b)]};}}exports[a45_0x235534(0x1a0)]=PaymentLinkService;