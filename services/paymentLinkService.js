'use strict';function a45_0x54aa(_0x27dda6,_0x5d039e){const _0x8ce38a=a45_0x8ce3();return a45_0x54aa=function(_0x54aa86,_0x3b8833){_0x54aa86=_0x54aa86-0x131;let _0x1c979d=_0x8ce38a[_0x54aa86];return _0x1c979d;},a45_0x54aa(_0x27dda6,_0x5d039e);}const a45_0x2457f0=a45_0x54aa;(function(_0x4fce14,_0x14753e){const _0x1e3393=a45_0x54aa,_0x2b6b37=_0x4fce14();while(!![]){try{const _0x42a43f=-parseInt(_0x1e3393(0x1ad))/0x1+-parseInt(_0x1e3393(0x157))/0x2*(parseInt(_0x1e3393(0x141))/0x3)+parseInt(_0x1e3393(0x1e9))/0x4*(parseInt(_0x1e3393(0x1c0))/0x5)+-parseInt(_0x1e3393(0x1b3))/0x6+parseInt(_0x1e3393(0x1ed))/0x7+parseInt(_0x1e3393(0x15d))/0x8+-parseInt(_0x1e3393(0x160))/0x9*(-parseInt(_0x1e3393(0x18c))/0xa);if(_0x42a43f===_0x14753e)break;else _0x2b6b37['push'](_0x2b6b37['shift']());}catch(_0x9ff8ce){_0x2b6b37['push'](_0x2b6b37['shift']());}}}(a45_0x8ce3,0x71ac3));var __importDefault=this&&this[a45_0x2457f0(0x186)]||function(_0x547a8f){const _0x3e7c11=a45_0x2457f0;return _0x547a8f&&_0x547a8f[_0x3e7c11(0x14c)]?_0x547a8f:{'default':_0x547a8f};};Object[a45_0x2457f0(0x1c1)](exports,a45_0x2457f0(0x14c),{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require(a45_0x2457f0(0x1f2))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a45_0x2457f0(0x1ae)),nodaService_1=require(a45_0x2457f0(0x14f)),coinToPayService_1=require(a45_0x2457f0(0x1cd)),klymeService_1=require(a45_0x2457f0(0x1d9)),gateway_1=require('../types/gateway'),currencyService_1=require('./currencyService');class PaymentLinkService{constructor(){const _0x57eb60=a45_0x2457f0;this[_0x57eb60(0x1b9)]=new plisioService_1[(_0x57eb60(0x1c4))](),this[_0x57eb60(0x197)]=new rapydService_1[(_0x57eb60(0x1e0))](),this['nodaService']=new nodaService_1[(_0x57eb60(0x196))](),this[_0x57eb60(0x1e3)]=new coinToPayService_1[(_0x57eb60(0x19d))](),this['klymeService']=new klymeService_1[(_0x57eb60(0x147))]();}[a45_0x2457f0(0x153)](){const _0x30b18c=()=>{const _0x594cc6=a45_0x54aa;return Math['floor'](Math[_0x594cc6(0x1ce)]()*0x5f5e100)['toString']()[_0x594cc6(0x1da)](0x8,'0');};return _0x30b18c()+'-'+_0x30b18c();}[a45_0x2457f0(0x1b4)](_0x353981,_0x4a95af,_0x3a1a0a,_0x1a94ba,_0x35dc96){const _0x5aa8ca=a45_0x2457f0;if(_0x1a94ba&&_0x35dc96)return{'finalSuccessUrl':_0x1a94ba,'finalFailUrl':_0x35dc96,'dbSuccessUrl':_0x1a94ba,'dbFailUrl':_0x35dc96};let _0x26612d,_0x43ffb7,_0x26d489,_0x270801;return _0x353981==='noda'||_0x353981[_0x5aa8ca(0x162)](_0x5aa8ca(0x15e))?(_0x26612d=_0x3a1a0a+_0x5aa8ca(0x13f)+_0x4a95af,_0x26d489=_0x5aa8ca(0x145)):(_0x26612d=_0x3a1a0a+_0x5aa8ca(0x144)+_0x4a95af,_0x26d489='https://app.trapay.uk/payment/success'),_0x43ffb7=_0x3a1a0a+'/gateway/fail.php?id='+_0x4a95af,_0x270801=_0x5aa8ca(0x1af),console[_0x5aa8ca(0x172)]('üîó\x20Generated\x20URLs\x20for\x20'+_0x353981+':'),console[_0x5aa8ca(0x172)](_0x5aa8ca(0x1a5)+_0x26612d),console[_0x5aa8ca(0x172)]('\x20\x20\x20üåê\x20Gateway\x20Fail\x20URL:\x20'+_0x43ffb7),console[_0x5aa8ca(0x172)]('\x20\x20\x20üíæ\x20DB\x20Success\x20URL:\x20'+_0x26d489),console[_0x5aa8ca(0x172)](_0x5aa8ca(0x1a0)+_0x270801),{'finalSuccessUrl':_0x26612d,'finalFailUrl':_0x43ffb7,'dbSuccessUrl':_0x26d489,'dbFailUrl':_0x270801};}[a45_0x2457f0(0x17f)](_0x5e0224,_0x5b5927){const _0x24d7d9=a45_0x2457f0;if(!_0x5e0224['startsWith'](_0x24d7d9(0x15e)))return;const _0x48564a=(0x0,gateway_1[_0x24d7d9(0x193)])(_0x5e0224),_0x1c6371=_0x5b5927['toUpperCase']();switch(_0x48564a){case'EU':if(_0x1c6371!==_0x24d7d9(0x184))throw new Error(_0x24d7d9(0x1f5)+_0x1c6371);break;case'GB':if(_0x1c6371!==_0x24d7d9(0x1c8))throw new Error(_0x24d7d9(0x14b)+_0x1c6371);break;case'DE':if(_0x1c6371!==_0x24d7d9(0x184))throw new Error(_0x24d7d9(0x140)+_0x1c6371);break;default:throw new Error(_0x24d7d9(0x133)+_0x48564a);}}async[a45_0x2457f0(0x1d3)](_0x5f3a00,_0x5b8f53){const _0x56ea8e=a45_0x2457f0;console['log'](_0x56ea8e(0x1f7)+_0x5f3a00+':\x20'+_0x5b8f53);const _0x305650=await database_1['default'][_0x56ea8e(0x16f)][_0x56ea8e(0x1ee)]({'where':{'id':_0x5f3a00},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x305650)throw new Error('Shop\x20not\x20found');let _0x49201f=[];if(_0x305650[_0x56ea8e(0x1d1)])try{_0x49201f=JSON[_0x56ea8e(0x185)](_0x305650[_0x56ea8e(0x1d1)]),console[_0x56ea8e(0x172)](_0x56ea8e(0x1df)+_0x305650['username']+_0x56ea8e(0x182),_0x49201f);}catch(_0x3daf24){console['error'](_0x56ea8e(0x15f),_0x3daf24),_0x49201f=[_0x56ea8e(0x137)];}else _0x49201f=[_0x56ea8e(0x137)],console[_0x56ea8e(0x172)](_0x56ea8e(0x1df)+_0x305650[_0x56ea8e(0x150)]+_0x56ea8e(0x16d),_0x49201f);const _0x261329=this[_0x56ea8e(0x15b)](_0x5b8f53);console[_0x56ea8e(0x172)]('üîê\x20Checking\x20if\x20\x22'+_0x261329+'\x22\x20is\x20in\x20enabled\x20gateways:',_0x49201f);if(!_0x49201f[_0x56ea8e(0x1e2)](_0x261329)){console[_0x56ea8e(0x164)]('‚ùå\x20Gateway\x20\x22'+_0x261329+'\x22\x20not\x20allowed\x20for\x20shop\x20'+_0x305650[_0x56ea8e(0x150)]),console[_0x56ea8e(0x164)](_0x56ea8e(0x1f0)+_0x49201f[_0x56ea8e(0x1f1)](',\x20'));throw new Error(_0x56ea8e(0x18b)+_0x261329+_0x56ea8e(0x19f)+(_0x56ea8e(0x169)+_0x49201f[_0x56ea8e(0x1f1)](',\x20')+'.\x20')+_0x56ea8e(0x195));}console[_0x56ea8e(0x172)]('‚úÖ\x20Gateway\x20\x22'+_0x261329+_0x56ea8e(0x1a9)+_0x305650[_0x56ea8e(0x150)]);}['getGatewayDisplayName'](_0x5d8a76){const _0xa2cd73=a45_0x2457f0,_0x327ecc={'plisio':'Plisio','rapyd':'Rapyd','noda':_0xa2cd73(0x156),'cointopay':'CoinToPay','klyme_eu':_0xa2cd73(0x176),'klyme_gb':_0xa2cd73(0x1e5),'klyme_de':_0xa2cd73(0x1bf)};return _0x327ecc[_0x5d8a76]||_0x5d8a76;}async['createPaymentLink'](_0x3cf3cb,_0x525f2b){const _0x39339c=a45_0x2457f0;if(!(0x0,gateway_1['isValidGatewayId'])(_0x525f2b[_0x39339c(0x13d)]))throw new Error(_0x39339c(0x18e)+_0x525f2b['gateway']+_0x39339c(0x187));const _0x25b45e=(0x0,gateway_1['getGatewayNameById'])(_0x525f2b[_0x39339c(0x13d)]);if(!_0x25b45e)throw new Error(_0x39339c(0x1e7)+_0x525f2b['gateway']);console[_0x39339c(0x172)]('üîó\x20Creating\x20payment\x20link\x20for\x20gateway:\x20'+_0x25b45e),await this['checkGatewayPermission'](_0x3cf3cb,_0x25b45e);if(_0x25b45e==='plisio'&&!_0x525f2b[_0x39339c(0x146)])throw new Error('sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links');if(_0x25b45e[_0x39339c(0x162)](_0x39339c(0x15e))){const _0x2c9781=(0x0,gateway_1[_0x39339c(0x193)])(_0x25b45e);console[_0x39339c(0x172)](_0x39339c(0x19b)+_0x2c9781+_0x39339c(0x166));}let _0x1615ef=_0x525f2b[_0x39339c(0x19e)];_0x25b45e==='rapyd'&&(_0x1615ef='GB',console['log'](_0x39339c(0x1ba)));if(!_0x525f2b[_0x39339c(0x155)]||_0x525f2b[_0x39339c(0x155)]<=0x0)throw new Error(_0x39339c(0x189));let _0x213bc1=_0x525f2b[_0x39339c(0x16c)]||'USD';_0x25b45e===_0x39339c(0x14e)&&(_0x213bc1=_0x39339c(0x184),console[_0x39339c(0x172)]('ü™ô\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link'));this[_0x39339c(0x17f)](_0x25b45e,_0x213bc1);const _0x15cedd=await database_1['default'][_0x39339c(0x1b8)][_0x39339c(0x191)]({'data':{'shopId':_0x3cf3cb,'amount':_0x525f2b[_0x39339c(0x155)],'currency':_0x213bc1,'sourceCurrency':_0x525f2b[_0x39339c(0x146)]||undefined,'gateway':_0x25b45e,'maxPayments':_0x525f2b[_0x39339c(0x154)]||0x1,'currentPayments':0x0,'status':_0x39339c(0x1f4),'expiresAt':_0x525f2b[_0x39339c(0x171)]?new Date(_0x525f2b['expiresAt']):undefined,'successUrl':_0x39339c(0x1eb),'failUrl':_0x39339c(0x1eb),'country':_0x1615ef,'language':_0x525f2b[_0x39339c(0x18f)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x39ee2e=process[_0x39339c(0x1c2)]['BASE_URL']||_0x39339c(0x1b1),{finalSuccessUrl:_0x214c4f,finalFailUrl:_0x11e971,dbSuccessUrl:_0x2369cf,dbFailUrl:_0x10d932}=this[_0x39339c(0x1b4)](_0x25b45e,_0x15cedd['id'],_0x39ee2e,_0x525f2b[_0x39339c(0x1d2)],_0x525f2b[_0x39339c(0x142)]),_0x4c7833=await database_1[_0x39339c(0x1bb)][_0x39339c(0x1b8)][_0x39339c(0x1ec)]({'where':{'id':_0x15cedd['id']},'data':{'successUrl':_0x2369cf,'failUrl':_0x10d932},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x39339c(0x172)]('‚úÖ\x20Payment\x20link\x20created:\x20'+_0x4c7833['id']+'\x20('+_0x25b45e+')'),console[_0x39339c(0x172)](_0x39339c(0x1b5)+_0x4c7833[_0x39339c(0x155)]+'\x20'+_0x4c7833[_0x39339c(0x16c)]),console[_0x39339c(0x172)](_0x39339c(0x19a)+_0x4c7833['id']),console['log']('‚úÖ\x20DB\x20Success\x20URL:\x20'+_0x4c7833[_0x39339c(0x1d2)]),console['log'](_0x39339c(0x149)+_0x4c7833['failUrl']),this[_0x39339c(0x1a2)](_0x4c7833);}async[a45_0x2457f0(0x13e)](_0x18ba61,_0x58130e){const _0x300705=a45_0x2457f0,{page:_0xb99a0e,limit:_0x48910,status:_0x93eae3,gateway:_0x2ec161,search:_0x11567a}=_0x58130e,_0x4fb9b5=(_0xb99a0e-0x1)*_0x48910,_0x359dbb={'shopId':_0x18ba61};_0x93eae3&&(_0x359dbb[_0x300705(0x138)]=_0x93eae3['toUpperCase']());if(_0x2ec161){if((0x0,gateway_1[_0x300705(0x1c7)])(_0x2ec161)){const _0x2799a9=(0x0,gateway_1[_0x300705(0x17e)])(_0x2ec161);_0x2799a9&&(_0x359dbb[_0x300705(0x13d)]=_0x2799a9);}else _0x359dbb[_0x300705(0x13d)]=_0x2ec161[_0x300705(0x175)]();}_0x11567a&&(_0x359dbb['OR']=[{'gateway':{'contains':_0x11567a,'mode':_0x300705(0x1e1)}},{'currency':{'contains':_0x11567a,'mode':_0x300705(0x1e1)}}]);const [_0x531b3b,_0x2728cc]=await Promise[_0x300705(0x174)]([database_1[_0x300705(0x1bb)][_0x300705(0x1b8)][_0x300705(0x148)]({'where':_0x359dbb,'skip':_0x4fb9b5,'take':_0x48910,'orderBy':{'createdAt':_0x300705(0x15c)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x300705(0x15c)},'take':0xa}}}),database_1[_0x300705(0x1bb)]['paymentLink'][_0x300705(0x1c6)]({'where':_0x359dbb})]);return{'links':_0x531b3b[_0x300705(0x188)](_0xa552cd=>this[_0x300705(0x1a2)](_0xa552cd)),'pagination':{'page':_0xb99a0e,'limit':_0x48910,'total':_0x2728cc,'totalPages':Math[_0x300705(0x1d0)](_0x2728cc/_0x48910)}};}async[a45_0x2457f0(0x1a7)](_0x1ac538,_0x299a23){const _0x24425f=a45_0x2457f0,_0x1a45b4=await database_1[_0x24425f(0x1bb)][_0x24425f(0x1b8)][_0x24425f(0x194)]({'where':{'id':_0x299a23,'shopId':_0x1ac538},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x24425f(0x15c)}}}});if(!_0x1a45b4)return null;return this['formatPaymentLinkResponse'](_0x1a45b4);}async[a45_0x2457f0(0x1a6)](_0x3f6c81,_0x45ea37,_0x3488f0){const _0x59aac5=a45_0x2457f0,_0x2d35c6={..._0x3488f0};if(_0x3488f0[_0x59aac5(0x13d)]){if((0x0,gateway_1[_0x59aac5(0x1c7)])(_0x3488f0[_0x59aac5(0x13d)])){const _0x23e702=(0x0,gateway_1['getGatewayNameById'])(_0x3488f0[_0x59aac5(0x13d)]);_0x23e702&&(await this[_0x59aac5(0x1d3)](_0x3f6c81,_0x23e702),_0x2d35c6[_0x59aac5(0x13d)]=_0x23e702);}else _0x2d35c6[_0x59aac5(0x13d)]=_0x3488f0['gateway'][_0x59aac5(0x175)]();}(_0x2d35c6[_0x59aac5(0x13d)]===_0x59aac5(0x163)||_0x3488f0[_0x59aac5(0x19e)]&&_0x2d35c6[_0x59aac5(0x13d)]!==_0x59aac5(0x163))&&(_0x2d35c6['gateway']===_0x59aac5(0x163)&&(_0x2d35c6[_0x59aac5(0x19e)]='GB',console[_0x59aac5(0x172)](_0x59aac5(0x168))));_0x2d35c6[_0x59aac5(0x13d)]==='cointopay'&&(_0x2d35c6[_0x59aac5(0x16c)]='EUR',console[_0x59aac5(0x172)]('ü™ô\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update'));_0x2d35c6[_0x59aac5(0x13d)]&&_0x2d35c6[_0x59aac5(0x16c)]&&this[_0x59aac5(0x17f)](_0x2d35c6['gateway'],_0x2d35c6['currency']);_0x3488f0[_0x59aac5(0x171)]&&(_0x2d35c6[_0x59aac5(0x171)]=new Date(_0x3488f0[_0x59aac5(0x171)]));const _0x571779=await database_1['default']['paymentLink'][_0x59aac5(0x1ec)]({'where':{'id':_0x45ea37,'shopId':_0x3f6c81},'data':_0x2d35c6,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x59aac5(0x15c)},'take':0xa}}});return this[_0x59aac5(0x1a2)](_0x571779);}async[a45_0x2457f0(0x198)](_0x3304dd,_0x487ce5){const _0x69141c=a45_0x2457f0;await database_1[_0x69141c(0x1bb)][_0x69141c(0x1b8)][_0x69141c(0x14a)]({'where':{'id':_0x487ce5,'shopId':_0x3304dd}});}async[a45_0x2457f0(0x158)](_0xb4b3b3){const _0x16040=a45_0x2457f0,_0x4c45f1=await database_1['default'][_0x16040(0x1b8)][_0x16040(0x1ee)]({'where':{'id':_0xb4b3b3},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x4c45f1)return null;const _0x4f5786=_0x4c45f1[_0x16040(0x171)]&&_0x4c45f1[_0x16040(0x171)]<new Date(),_0x5c5907=_0x4c45f1[_0x16040(0x1d6)]>=_0x4c45f1[_0x16040(0x154)],_0x550c0a=_0x4c45f1[_0x16040(0x16f)]['status']==='ACTIVE',_0x248086=_0x4c45f1[_0x16040(0x138)]==='ACTIVE',_0x5a4611=!_0x4f5786&&!_0x5c5907&&_0x550c0a&&_0x248086,_0x4b6a58=Math[_0x16040(0x1a4)](0x0,_0x4c45f1['maxPayments']-_0x4c45f1[_0x16040(0x1d6)]);return{'id':_0x4c45f1['id'],'amount':_0x4c45f1[_0x16040(0x155)],'currency':_0x4c45f1['currency'],'sourceCurrency':_0x4c45f1['sourceCurrency']||undefined,'gateway':_0x4c45f1[_0x16040(0x13d)],'maxPayments':_0x4c45f1['maxPayments'],'currentPayments':_0x4c45f1[_0x16040(0x1d6)],'status':_0x4c45f1[_0x16040(0x138)],'expiresAt':_0x4c45f1['expiresAt']||undefined,'shopName':_0x4c45f1[_0x16040(0x16f)][_0x16040(0x180)],'isAvailable':_0x5a4611,'remainingPayments':_0x4b6a58};}async[a45_0x2457f0(0x1c3)](_0x47f484){const _0x4c1961=a45_0x2457f0,{linkId:_0x231543,customerEmail:_0x174b8c,customerName:_0x3e356a}=_0x47f484,_0x284b15=await database_1[_0x4c1961(0x1bb)][_0x4c1961(0x1b8)]['findUnique']({'where':{'id':_0x231543},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x284b15)throw new Error(_0x4c1961(0x1de));const _0x5ce6ae=_0x284b15[_0x4c1961(0x171)]&&_0x284b15[_0x4c1961(0x171)]<new Date(),_0x39029c=_0x284b15[_0x4c1961(0x1d6)]>=_0x284b15['maxPayments'],_0x49b875=_0x284b15[_0x4c1961(0x16f)][_0x4c1961(0x138)]===_0x4c1961(0x1f4),_0x21b504=_0x284b15[_0x4c1961(0x138)]===_0x4c1961(0x1f4);if(_0x5ce6ae)throw new Error(_0x4c1961(0x18d));if(_0x39029c)throw new Error(_0x4c1961(0x16e));if(!_0x49b875)throw new Error('Shop\x20is\x20not\x20active');if(!_0x21b504)throw new Error(_0x4c1961(0x1b7));await this['checkGatewayPermission'](_0x284b15[_0x4c1961(0x1bd)],_0x284b15[_0x4c1961(0x13d)]);const _0xb8830=_0x284b15[_0x4c1961(0x155)];console[_0x4c1961(0x172)](_0x4c1961(0x1a3)+_0x231543+':\x20'+_0xb8830+'\x20'+_0x284b15[_0x4c1961(0x16c)]),console[_0x4c1961(0x172)](_0x4c1961(0x1b0)+(_0x3e356a||_0x4c1961(0x19c))+'\x20('+(_0x174b8c||_0x4c1961(0x16b))+')'),this['validateKlymeCurrency'](_0x284b15[_0x4c1961(0x13d)],_0x284b15[_0x4c1961(0x16c)]);const _0x1ea4e1=this[_0x4c1961(0x153)]();console[_0x4c1961(0x172)](_0x4c1961(0x1ef)+_0x1ea4e1+_0x4c1961(0x181)+_0x284b15[_0x4c1961(0x13d)]+')');const _0xba393=process[_0x4c1961(0x1c2)][_0x4c1961(0x1e6)]||'https://tesoft.uk',{finalSuccessUrl:_0x2ce0bb,finalFailUrl:_0x3c1c9b,dbSuccessUrl:_0x16c9e7,dbFailUrl:_0x49e467}=this[_0x4c1961(0x1b4)](_0x284b15[_0x4c1961(0x13d)],_0x1ea4e1,_0xba393,_0x284b15[_0x4c1961(0x1d2)]||undefined,_0x284b15[_0x4c1961(0x142)]||undefined),_0x335072=await database_1[_0x4c1961(0x1bb)][_0x4c1961(0x132)][_0x4c1961(0x191)]({'data':{'shopId':_0x284b15[_0x4c1961(0x1bd)],'paymentLinkId':_0x284b15['id'],'gateway':_0x284b15[_0x4c1961(0x13d)],'amount':_0xb8830,'currency':_0x284b15[_0x4c1961(0x16c)],'sourceCurrency':_0x284b15['sourceCurrency']||undefined,'usage':_0x4c1961(0x1cf),'expiresAt':_0x284b15['expiresAt']||undefined,'successUrl':_0x16c9e7,'failUrl':_0x49e467,'status':_0x4c1961(0x136),'orderId':null,'gatewayOrderId':_0x1ea4e1,'customerEmail':_0x174b8c||undefined,'customerName':_0x3e356a||undefined,'country':_0x284b15[_0x4c1961(0x19e)]||undefined,'language':_0x284b15['language']||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x4c1961(0x172)](_0x4c1961(0x177)+_0x335072['id']),console[_0x4c1961(0x172)]('üí∞\x20Amount:\x20'+_0xb8830+'\x20'+_0x284b15[_0x4c1961(0x16c)]),console[_0x4c1961(0x172)]('üë§\x20Customer:\x20'+(_0x3e356a||_0x4c1961(0x19c))+'\x20('+(_0x174b8c||_0x4c1961(0x16b))+')'),console['log'](_0x4c1961(0x1e4)+_0x16c9e7),console[_0x4c1961(0x172)]('üíæ\x20DB\x20Fail\x20URL:\x20'+_0x49e467);let _0x50ff89,_0x1e95c3;try{if(_0x284b15[_0x4c1961(0x13d)]===_0x4c1961(0x1c9)){console[_0x4c1961(0x172)](_0x4c1961(0x1a8)),console['log']('\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20'+_0x284b15[_0x4c1961(0x16c)]),console[_0x4c1961(0x172)](_0x4c1961(0x178)+_0x284b15[_0x4c1961(0x146)]);const _0x1a4ff5=await this[_0x4c1961(0x1b9)][_0x4c1961(0x1aa)]({'paymentId':_0x335072['id'],'orderId':_0x1ea4e1,'amount':_0xb8830,'currency':_0x284b15[_0x4c1961(0x16c)],'productName':'Payment\x20'+_0xb8830+'\x20'+_0x284b15[_0x4c1961(0x16c)],'description':_0x4c1961(0x17c)+_0xb8830+'\x20'+_0x284b15[_0x4c1961(0x16c)],'successUrl':_0x2ce0bb,'failUrl':_0x3c1c9b,'customerEmail':_0x174b8c||undefined,'customerName':_0x3e356a||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x284b15[_0x4c1961(0x146)]||undefined});_0x50ff89=_0x1a4ff5[_0x4c1961(0x1dc)],_0x1e95c3=_0x1a4ff5[_0x4c1961(0x167)],await database_1['default'][_0x4c1961(0x132)][_0x4c1961(0x1ec)]({'where':{'id':_0x335072['id']},'data':{'externalPaymentUrl':_0x1e95c3,'gatewayPaymentId':_0x50ff89,'invoiceTotalSum':Number(_0x1a4ff5[_0x4c1961(0x1ac)]),'qrCode':_0x1a4ff5['qr_code'],'qrUrl':_0x1a4ff5[_0x4c1961(0x1f3)]}});const _0x51cf59=_0x4c1961(0x173)+_0x335072['id'];return console[_0x4c1961(0x172)](_0x4c1961(0x135)+_0x51cf59),{'paymentId':_0x335072['id'],'paymentUrl':_0x51cf59,'expiresAt':_0x335072[_0x4c1961(0x171)]||undefined};}else{if(_0x284b15[_0x4c1961(0x13d)]===_0x4c1961(0x163)){const _0x371e1e=await this[_0x4c1961(0x197)][_0x4c1961(0x1f6)]({'paymentId':_0x335072['id'],'orderId':_0x1ea4e1,'orderName':_0x4c1961(0x17c)+_0xb8830+'\x20'+_0x284b15[_0x4c1961(0x16c)],'amount':_0xb8830,'currency':_0x284b15[_0x4c1961(0x16c)],'country':_0x284b15[_0x4c1961(0x19e)],'language':_0x284b15[_0x4c1961(0x18f)]||'EN','amountIsEditable':![],'usage':_0x4c1961(0x1cf),'maxPayments':0x1,'successUrl':_0x2ce0bb,'failUrl':_0x3c1c9b});_0x50ff89=_0x371e1e[_0x4c1961(0x1dc)],_0x1e95c3=_0x371e1e['payment_url'],await database_1[_0x4c1961(0x1bb)][_0x4c1961(0x132)][_0x4c1961(0x1ec)]({'where':{'id':_0x335072['id']},'data':{'externalPaymentUrl':_0x1e95c3,'gatewayPaymentId':_0x50ff89}});const _0x2a6a0f=_0x4c1961(0x1d8)+_0x335072['id'];return console[_0x4c1961(0x172)](_0x4c1961(0x1cb)+_0x2a6a0f),{'paymentId':_0x335072['id'],'paymentUrl':_0x2a6a0f,'expiresAt':_0x335072[_0x4c1961(0x171)]||undefined};}else{if(_0x284b15[_0x4c1961(0x13d)]===_0x4c1961(0x134)){const _0x4269a9=await this['nodaService'][_0x4c1961(0x1f6)]({'paymentId':_0x335072['id'],'orderId':_0x1ea4e1,'name':_0x4c1961(0x17c)+_0xb8830+'\x20'+_0x284b15[_0x4c1961(0x16c)],'paymentDescription':_0x4c1961(0x17c)+_0xb8830+'\x20'+_0x284b15[_0x4c1961(0x16c)],'amount':_0xb8830,'currency':_0x284b15[_0x4c1961(0x16c)],'webhookUrl':_0x4c1961(0x152),'returnUrl':_0x2ce0bb,'expiryDate':_0x284b15[_0x4c1961(0x171)]?.['toISOString']()});_0x50ff89=_0x4269a9[_0x4c1961(0x1dc)],_0x1e95c3=_0x4269a9[_0x4c1961(0x167)],await database_1[_0x4c1961(0x1bb)][_0x4c1961(0x132)][_0x4c1961(0x1ec)]({'where':{'id':_0x335072['id']},'data':{'externalPaymentUrl':_0x1e95c3,'gatewayPaymentId':_0x50ff89,'qrUrl':_0x4269a9[_0x4c1961(0x151)]}});const _0x51fd09='https://tesoft.uk/gateway/payment.php?id='+_0x335072['id'];return console['log'](_0x4c1961(0x17a)+_0x51fd09),{'paymentId':_0x335072['id'],'paymentUrl':_0x51fd09,'expiresAt':_0x335072['expiresAt']||undefined};}else{if(_0x284b15[_0x4c1961(0x13d)]===_0x4c1961(0x14e)){console['log'](_0x4c1961(0x1e8)+_0x1ea4e1+_0x4c1961(0x1bc)),console[_0x4c1961(0x172)](_0x4c1961(0x1be)+_0xb8830+_0x4c1961(0x1d5));const _0x3c9651=await this['coinToPayService']['createPaymentLink']({'paymentId':_0x335072['id'],'orderId':_0x1ea4e1,'amount':_0xb8830});_0x50ff89=_0x3c9651[_0x4c1961(0x1dc)],_0x1e95c3=_0x3c9651[_0x4c1961(0x167)],await database_1[_0x4c1961(0x1bb)]['payment']['update']({'where':{'id':_0x335072['id']},'data':{'externalPaymentUrl':_0x1e95c3,'gatewayPaymentId':_0x50ff89}});const _0xbf48f0='https://tesoft.uk/gateway/payment.php?id='+_0x335072['id'];return console[_0x4c1961(0x172)](_0x4c1961(0x16a)+_0xbf48f0),{'paymentId':_0x335072['id'],'paymentUrl':_0xbf48f0,'expiresAt':_0x335072[_0x4c1961(0x171)]||undefined};}else{if(_0x284b15['gateway']['startsWith'](_0x4c1961(0x15e))){const _0x3ee18a=(0x0,gateway_1[_0x4c1961(0x193)])(_0x284b15[_0x4c1961(0x13d)]);if(!_0x3ee18a)throw new Error(_0x4c1961(0x1ab)+_0x284b15[_0x4c1961(0x13d)]);console[_0x4c1961(0x172)]('üí≥\x20Creating\x20KLYME\x20'+_0x3ee18a+_0x4c1961(0x13c)+_0x1ea4e1+_0x4c1961(0x1bc)),console['log']('üí∞\x20Amount:\x20'+_0xb8830+'\x20'+_0x284b15[_0x4c1961(0x16c)]+_0x4c1961(0x17b)+_0x3ee18a+')');const _0x46f9c7=await this[_0x4c1961(0x161)]['createPaymentLink']({'paymentId':_0x335072['id'],'orderId':_0x1ea4e1,'amount':_0xb8830,'currency':_0x284b15[_0x4c1961(0x16c)],'region':_0x3ee18a,'redirectUrl':_0x2ce0bb});_0x50ff89=_0x46f9c7[_0x4c1961(0x1dc)],_0x1e95c3=_0x46f9c7['payment_url'],await database_1[_0x4c1961(0x1bb)][_0x4c1961(0x132)]['update']({'where':{'id':_0x335072['id']},'data':{'externalPaymentUrl':_0x1e95c3,'gatewayPaymentId':_0x50ff89}});const _0xb31d3b=_0x4c1961(0x173)+_0x335072['id'];return console['log'](_0x4c1961(0x131)+_0x3ee18a+_0x4c1961(0x1db)+_0x1ea4e1),console[_0x4c1961(0x172)](_0x4c1961(0x1d4)+_0x3ee18a+_0x4c1961(0x1c5)+_0xb31d3b),{'paymentId':_0x335072['id'],'paymentUrl':_0xb31d3b,'expiresAt':_0x335072[_0x4c1961(0x171)]||undefined};}else throw new Error('Unsupported\x20gateway:\x20'+_0x284b15[_0x4c1961(0x13d)]);}}}}}catch(_0x1d2d04){await database_1[_0x4c1961(0x1bb)][_0x4c1961(0x132)][_0x4c1961(0x1ec)]({'where':{'id':_0x335072['id']},'data':{'status':_0x4c1961(0x159)}});throw new Error('Gateway\x20error:\x20'+(_0x1d2d04 instanceof Error?_0x1d2d04[_0x4c1961(0x199)]:'Unknown\x20error'));}}async['handleSuccessfulPayment'](_0x416cbc){const _0x377858=a45_0x2457f0;console[_0x377858(0x172)]('üìà\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20'+_0x416cbc);const _0x2cb488=await database_1[_0x377858(0x1bb)][_0x377858(0x132)]['findUnique']({'where':{'id':_0x416cbc},'include':{'paymentLink':!![]}});if(!_0x2cb488||!_0x2cb488[_0x377858(0x1b8)]){console[_0x377858(0x172)](_0x377858(0x1cc)+_0x416cbc+_0x377858(0x13a));return;}if(_0x2cb488[_0x377858(0x138)]!=='PAID'){console[_0x377858(0x172)](_0x377858(0x1cc)+_0x416cbc+_0x377858(0x1d7)+_0x2cb488[_0x377858(0x138)]+',\x20not\x20PAID.\x20Skipping\x20counter\x20update.');return;}if(!_0x2cb488[_0x377858(0x170)]){console[_0x377858(0x172)](_0x377858(0x1cc)+_0x416cbc+_0x377858(0x1b2));return;}try{const _0x41f315=await database_1['default'][_0x377858(0x179)](async _0x280204=>{const _0x416787=_0x377858,_0x49ae1b=await _0x280204[_0x416787(0x1b8)][_0x416787(0x1ee)]({'where':{'id':_0x2cb488[_0x416787(0x183)]},'select':{'id':!![],'currentPayments':!![],'maxPayments':!![],'status':!![]}});if(!_0x49ae1b)throw new Error(_0x416787(0x1b6)+_0x2cb488[_0x416787(0x183)]+_0x416787(0x139));if(_0x49ae1b[_0x416787(0x1d6)]>=_0x49ae1b[_0x416787(0x154)])return console[_0x416787(0x172)](_0x416787(0x14d)+_0x2cb488[_0x416787(0x183)]+_0x416787(0x1a1)+_0x49ae1b[_0x416787(0x1d6)]+'/'+_0x49ae1b[_0x416787(0x154)]+_0x416787(0x1ca)),_0x49ae1b;const _0x1e4199=await _0x280204[_0x416787(0x132)][_0x416787(0x1c6)]({'where':{'paymentLinkId':_0x2cb488[_0x416787(0x183)],'status':'PAID','paidAt':{'not':null},'id':{'not':_0x416cbc}}}),_0x38a22a=_0x1e4199+0x1,_0x15f634=await _0x280204['paymentLink'][_0x416787(0x1ec)]({'where':{'id':_0x2cb488[_0x416787(0x183)]},'data':{'currentPayments':_0x38a22a,'status':_0x38a22a>=_0x49ae1b[_0x416787(0x154)]?_0x416787(0x17d):_0x49ae1b[_0x416787(0x138)]}});return console[_0x416787(0x172)](_0x416787(0x14d)+_0x2cb488[_0x416787(0x183)]+_0x416787(0x1dd)+_0x49ae1b['currentPayments']+'\x20->\x20'+_0x38a22a+'/'+_0x49ae1b[_0x416787(0x154)]),_0x15f634;});_0x41f315[_0x377858(0x138)]==='COMPLETED'&&console[_0x377858(0x172)](_0x377858(0x190)+_0x2cb488[_0x377858(0x183)]+'\x20completed\x20(reached\x20max\x20payments:\x20'+_0x41f315[_0x377858(0x1d6)]+'/'+_0x41f315[_0x377858(0x154)]+')');}catch(_0x306a93){console[_0x377858(0x164)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20'+_0x416cbc+':',_0x306a93);}}async['getPaymentLinkStatistics'](_0xf60b49){const _0x1d9057=a45_0x2457f0,[_0x1658d5,_0x4156ce,_0x6e57e2,_0x642d48]=await Promise['all']([database_1['default'][_0x1d9057(0x1b8)]['count']({'where':{'shopId':_0xf60b49}}),database_1[_0x1d9057(0x1bb)][_0x1d9057(0x1b8)]['count']({'where':{'shopId':_0xf60b49,'status':_0x1d9057(0x1f4)}}),database_1[_0x1d9057(0x1bb)][_0x1d9057(0x132)][_0x1d9057(0x1c6)]({'where':{'shopId':_0xf60b49,'paymentLinkId':{'not':null}}}),database_1[_0x1d9057(0x1bb)][_0x1d9057(0x132)][_0x1d9057(0x148)]({'where':{'shopId':_0xf60b49,'paymentLinkId':{'not':null},'status':_0x1d9057(0x18a)},'select':{'amount':!![],'currency':!![]}})]);let _0x1568d1=0x0;for(const _0x274de1 of _0x642d48){const _0x287629=await currencyService_1[_0x1d9057(0x143)][_0x1d9057(0x13b)](_0x274de1['amount'],_0x274de1[_0x1d9057(0x16c)]);_0x1568d1+=_0x287629;}const _0x350570=_0x6e57e2>0x0?_0x642d48[_0x1d9057(0x1ea)]/_0x6e57e2*0x64:0x0;return{'totalLinks':_0x1658d5,'activeLinks':_0x4156ce,'totalPayments':_0x6e57e2,'totalRevenue':Math[_0x1d9057(0x15a)](_0x1568d1*0x64)/0x64,'conversionRate':Math['round'](_0x350570*0x64)/0x64};}['formatPaymentLinkResponse'](_0x1c4561){const _0xea941a=a45_0x2457f0;return{'id':_0x1c4561['id'],'shopId':_0x1c4561[_0xea941a(0x1bd)],'amount':_0x1c4561['amount'],'currency':_0x1c4561[_0xea941a(0x16c)],'sourceCurrency':_0x1c4561[_0xea941a(0x146)]||undefined,'gateway':_0x1c4561[_0xea941a(0x13d)],'maxPayments':_0x1c4561[_0xea941a(0x154)],'currentPayments':_0x1c4561[_0xea941a(0x1d6)],'status':_0x1c4561[_0xea941a(0x138)],'expiresAt':_0x1c4561[_0xea941a(0x171)]||undefined,'successUrl':_0x1c4561[_0xea941a(0x1d2)]||undefined,'failUrl':_0x1c4561[_0xea941a(0x142)]||undefined,'country':_0x1c4561['country']||undefined,'language':_0x1c4561[_0xea941a(0x18f)]||undefined,'linkUrl':_0xea941a(0x165)+_0x1c4561['id'],'createdAt':_0x1c4561['createdAt'],'updatedAt':_0x1c4561['updatedAt'],'shop':_0x1c4561['shop'],'payments':_0x1c4561['payments']};}}function a45_0x8ce3(){const _0x30fa13=['Payment\x20link\x20has\x20expired','Invalid\x20gateway\x20ID:\x20','language','üèÅ\x20Payment\x20link\x20','create','PaymentLinkService','getKlymeRegionFromGatewayName','findFirst','Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.','NodaService','rapydService','deletePaymentLink','message','üîó\x20Link\x20URL:\x20https://app.trapay.uk/link/','üí≥\x20Creating\x20KLYME\x20','Anonymous','CoinToPayService','country','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','\x20\x20\x20üíæ\x20DB\x20Fail\x20URL:\x20','\x20already\x20at\x20max\x20payments\x20(','formatPaymentLinkResponse','üí≥\x20Initiating\x20payment\x20from\x20link\x20','max','\x20\x20\x20üåê\x20Gateway\x20Success\x20URL:\x20','updatePaymentLink','getPaymentLinkById','üí∞\x20Plisio\x20payment\x20link\x20mapping:','\x22\x20is\x20allowed\x20for\x20shop\x20','createPayment','Invalid\x20KLYME\x20gateway:\x20','invoice_total_sum','518378sYGAkR','./gateways/rapydService','https://app.trapay.uk/payment/fail','üë§\x20Customer:\x20','https://tesoft.uk','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','1975158rKGFYW','generateGatewayUrls','üí∞\x20Fixed\x20amount:\x20','Payment\x20link\x20','Payment\x20link\x20is\x20not\x20active','paymentLink','plisioService','üá¨üáß\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','default','\x20(8digits-8digits\x20format)','shopId','üí∞\x20Amount:\x20','KLYME\x20DE','125mmKvKW','defineProperty','env','initiatePaymentFromLink','PlisioService','\x20payment\x20URL:\x20','count','isValidGatewayId','GBP','plisio','),\x20skipping\x20increment','üîó\x20Rapyd\x20payment\x20URL:\x20','üìà\x20Payment\x20','./gateways/coinToPayService','random','ONCE','ceil','paymentGateways','successUrl','checkGatewayPermission','üîó\x20KLYME\x20','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','currentPayments','\x20status\x20is\x20','https://tesoft.uk/gateway/payment.php?id=','./gateways/klymeService','padStart','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','gateway_payment_id','\x20counter\x20updated:\x20','Payment\x20link\x20not\x20found','üîê\x20Shop\x20','RapydService','insensitive','includes','coinToPayService','üíæ\x20DB\x20Success\x20URL:\x20','KLYME\x20GB','BASE_URL','Gateway\x20not\x20found\x20for\x20ID:\x20','ü™ô\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','91612sOjVzY','length','temp','update','1973930ueGCSB','findUnique','üéØ\x20Generated\x20gateway\x20order_id:\x20','‚ùå\x20Enabled\x20gateways:\x20','join','../config/database','qr_url','ACTIVE','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','createPaymentLink','üîê\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','‚úÖ\x20KLYME\x20','payment','Unsupported\x20KLYME\x20region:\x20','noda','üîó\x20Plisio\x20payment\x20URL:\x20','PENDING','Plisio','status','\x20not\x20found','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','convertToUSDT','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','gateway','getPaymentLinks','/gateway/pending.php?id=','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','637836OaoxDG','failUrl','currencyService','/gateway/success.php?id=','https://app.trapay.uk/payment/pending','sourceCurrency','KlymeService','findMany','‚ùå\x20DB\x20Fail\x20URL:\x20','delete','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','__esModule','üìà\x20Payment\x20link\x20','cointopay','./gateways/nodaService','username','qr_code_url','https://tesoft.uk/gateways/noda/webhook','generateGatewayOrderId','maxPayments','amount','Noda','8ylLKuO','getPublicPaymentLinkData','FAILED','round','getGatewayDisplayName','desc','252648nymXoy','klyme_','Error\x20parsing\x20payment\x20gateways:','9hGjXXJ','klymeService','startsWith','rapyd','error','https://app.trapay.uk/link/','\x20payment\x20link','payment_url','üá¨üáß\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','Enabled\x20gateways:\x20','üîó\x20CoinToPay\x20payment\x20URL:\x20','no\x20email','currency','\x20using\x20default\x20gateways:','Payment\x20link\x20has\x20reached\x20maximum\x20payments','shop','paidAt','expiresAt','log','https://app.trapay.uk/payment/','all','toLowerCase','KLYME\x20EU','üíæ\x20Payment\x20created\x20from\x20link:\x20','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','$transaction','üîó\x20Noda\x20payment\x20URL:\x20','\x20(validated\x20for\x20','Payment\x20','COMPLETED','getGatewayNameById','validateKlymeCurrency','name','\x20(8digits-8digits\x20format\x20for\x20','\x20enabled\x20gateways:','paymentLinkId','EUR','parse','__importDefault','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','map','amount\x20is\x20required\x20and\x20must\x20be\x20positive','PAID','Gateway\x20\x22','12774760BMXxdJ'];a45_0x8ce3=function(){return _0x30fa13;};return a45_0x8ce3();}exports[a45_0x2457f0(0x192)]=PaymentLinkService;