'use strict';const a45_0x8ca45c=a45_0x3b4a;(function(_0x115d31,_0x48db9a){const _0x1f48eb=a45_0x3b4a,_0x49c40f=_0x115d31();while(!![]){try{const _0x1e8031=-parseInt(_0x1f48eb(0x162))/0x1*(parseInt(_0x1f48eb(0x1b2))/0x2)+parseInt(_0x1f48eb(0x1b5))/0x3*(parseInt(_0x1f48eb(0x191))/0x4)+parseInt(_0x1f48eb(0x19c))/0x5+parseInt(_0x1f48eb(0x17d))/0x6*(parseInt(_0x1f48eb(0x134))/0x7)+-parseInt(_0x1f48eb(0x14b))/0x8+-parseInt(_0x1f48eb(0x18f))/0x9+parseInt(_0x1f48eb(0xfb))/0xa;if(_0x1e8031===_0x48db9a)break;else _0x49c40f['push'](_0x49c40f['shift']());}catch(_0x3f41fd){_0x49c40f['push'](_0x49c40f['shift']());}}}(a45_0x1ddf,0x6634d));function a45_0x1ddf(){const _0x2be0ee=['defineProperty','‚úÖ\x20Payment\x20link\x20created:\x20','__importDefault','currency','KlymeService','üîó\x20Rapyd\x20payment\x20URL:\x20','getGatewayNameById','Error\x20parsing\x20payment\x20gateways:','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','\x20\x20\x20üåê\x20Gateway\x20Fail\x20URL:\x20','üîó\x20CoinToPay\x20payment\x20URL:\x20','30onCPGd','shopId','Rapyd','Gateway\x20error:\x20','klymeService','ü™ô\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20','shop','createdAt','\x20status\x20is\x20','Invalid\x20gateway\x20ID:\x20','paymentLinkId','/gateway/success.php?id=','desc','checkGatewayPermission','üîó\x20KLYME\x20','üîó\x20Generated\x20URLs\x20for\x20','paymentGateways','üèÅ\x20Payment\x20link\x20','3820707PkHLIx','username','152TqLyBq','findUnique','join','delete','message','NodaService','insensitive','toUpperCase','üîê\x20Checking\x20if\x20\x22','status','üíæ\x20DB\x20Fail\x20URL:\x20','2510095wEHyfM','https://app.trapay.uk/payment/success?id=','\x20not\x20found','getPaymentLinkStatistics','startsWith','isValidGatewayId','Plisio','https://tesoft.uk/gateways/noda/webhook','expiresAt','üîó\x20Plisio\x20payment\x20URL:\x20','getGatewayDisplayName','currencyService','update','üîó\x20Link\x20URL:\x20https://app.trapay.uk/link/','findMany','floor','payments','Noda','paymentLink','env','üîê\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','Gateway\x20not\x20found\x20for\x20ID:\x20','58YMekkj','üí≥\x20Initiating\x20payment\x20from\x20link\x20','‚úÖ\x20Gateway\x20\x22','13413jirFEv','gateway_payment_id','üîê\x20Shop\x20','üíæ\x20Payment\x20created:\x20','üìà\x20Payment\x20','ACTIVE','__esModule','getPaymentLinks','amount','/gateway/pending.php?id=','count','Payment\x20link\x20has\x20expired','validateKlymeCurrency','üíæ\x20DB\x20Success\x20URL:\x20','CoinToPay','deletePaymentLink','Unsupported\x20gateway:\x20','CoinToPayService','formatPaymentLinkResponse','/gateway/fail.php?id=','no\x20email','padStart','11011580YakNrE','getKlymeRegionFromGatewayName','\x20enabled\x20gateways:','üîó\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','KLYME\x20GB','name','Payment\x20','\x20(8digits-8digits\x20format\x20for\x20','üìà\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','payment_url','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','plisioService','rapyd','updatedAt','KLYME\x20DE','https://app.trapay.uk/payment/','RapydService','\x20payment\x20link','paidAt','currentPayments','\x22\x20is\x20in\x20enabled\x20gateways:','üá¨üáß\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','./gateways/klymeService','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','createPaymentLink','‚ùå\x20Gateway\x20\x22','üí∞\x20Amount:\x20','rapydService','https://app.trapay.uk/link/','PENDING','./gateways/coinToPayService','EUR','failUrl','\x20with\x20payment\x20ID\x20','\x20\x20\x20üíæ\x20DB\x20Fail\x20URL:\x20','Unsupported\x20KLYME\x20region:\x20','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','ceil','üìà\x20Payment\x20link\x20','Payment\x20link\x20','./gateways/nodaService','round','includes','coinToPayStatusService','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','qr_code_url','ü™ô\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','ü™ô\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','max','\x20(validated\x20for\x20','error','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update',',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','./coinToPayStatusService','qr_url','./gateways/plisioService','COMPLETED','168161RPXAdo','ONCE','\x20completed\x20(reached\x20max\x20payments:\x20','klyme_','convertToUSDT','Gateway\x20\x22','random','üìù\x20Note:\x20Success/Fail\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created','‚úÖ\x20KLYME\x20','),\x20skipping\x20increment','Invalid\x20KLYME\x20gateway:\x20','country','log','Anonymous','maxPayments','USD','schedulePaymentChecks','Payment\x20link\x20has\x20reached\x20maximum\x20payments','generateGatewayOrderId','$transaction','PlisioService','default','handleSuccessfulPayment','6241016sRdSqi','parse','üë§\x20Customer:\x20','sourceCurrency','Payment\x20link\x20not\x20found','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','\x20using\x20default\x20gateways:','generateGatewayUrls','\x20counter\x20updated:\x20','getPublicPaymentLinkData','all','gateway','PaymentLinkService','üí∞\x20Plisio\x20payment\x20link\x20mapping:','\x20\x20\x20üíæ\x20DB\x20Success\x20URL:\x20','toLowerCase','ü™ô\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','./currencyService','https://app.trapay.uk/payment/fail?id=','BASE_URL','üîó\x20Noda\x20payment\x20URL:\x20','Shop\x20not\x20found','payment','9307VRAdXH','successUrl','language','create','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','noda','https://tesoft.uk/gateway/payment.php?id=','cointopay','getPaymentLinkById','initiatePaymentFromLink','updatePaymentLink','plisio','\x20(8digits-8digits\x20format)','coinToPayService','nodaService','KLYME\x20EU'];a45_0x1ddf=function(){return _0x2be0ee;};return a45_0x1ddf();}var __importDefault=this&&this[a45_0x8ca45c(0x174)]||function(_0x2ffcf1){const _0x556e32=a45_0x8ca45c;return _0x2ffcf1&&_0x2ffcf1[_0x556e32(0x1bb)]?_0x2ffcf1:{'default':_0x2ffcf1};};function a45_0x3b4a(_0x25acc2,_0x5bb419){const _0x1ddf38=a45_0x1ddf();return a45_0x3b4a=function(_0x3b4a69,_0x3bfb94){_0x3b4a69=_0x3b4a69-0xf5;let _0x141c74=_0x1ddf38[_0x3b4a69];return _0x141c74;},a45_0x3b4a(_0x25acc2,_0x5bb419);}Object[a45_0x8ca45c(0x172)](exports,a45_0x8ca45c(0x1bb),{'value':!![]}),exports[a45_0x8ca45c(0x157)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a45_0x8ca45c(0x132)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a45_0x8ca45c(0x123)),coinToPayService_1=require(a45_0x8ca45c(0x119)),klymeService_1=require(a45_0x8ca45c(0x111)),coinToPayStatusService_1=require(a45_0x8ca45c(0x130)),gateway_1=require('../types/gateway'),currencyService_1=require(a45_0x8ca45c(0x15c));class PaymentLinkService{constructor(){const _0x1b6637=a45_0x8ca45c;this[_0x1b6637(0x106)]=new plisioService_1[(_0x1b6637(0x148))](),this[_0x1b6637(0x116)]=new rapydService_1[(_0x1b6637(0x10b))](),this[_0x1b6637(0x170)]=new nodaService_1[(_0x1b6637(0x196))](),this[_0x1b6637(0x16f)]=new coinToPayService_1[(_0x1b6637(0xf6))](),this[_0x1b6637(0x181)]=new klymeService_1[(_0x1b6637(0x176))]();}[a45_0x8ca45c(0x146)](){const _0x12df3d=()=>{const _0x2f05e4=a45_0x3b4a;return Math[_0x2f05e4(0x1ab)](Math[_0x2f05e4(0x13a)]()*0x5f5e100)['toString']()[_0x2f05e4(0xfa)](0x8,'0');};return _0x12df3d()+'-'+_0x12df3d();}['generateGatewayUrls'](_0xccdad8,_0xbc6576,_0x44ce34,_0x48168a,_0x473cb0){const _0x15dfb9=a45_0x8ca45c;if(_0x48168a&&_0x473cb0)return{'finalSuccessUrl':_0x48168a,'finalFailUrl':_0x473cb0,'dbSuccessUrl':_0x48168a,'dbFailUrl':_0x473cb0};let _0x4893fe,_0x463c0e,_0x43dd2a,_0x42e5f6;return _0xccdad8===_0x15dfb9(0x167)||_0xccdad8['startsWith'](_0x15dfb9(0x137))||_0xccdad8===_0x15dfb9(0x169)?(_0x4893fe=_0x44ce34+_0x15dfb9(0x1be)+_0xbc6576,_0x43dd2a='https://app.trapay.uk/payment/pending?id='+_0xbc6576):(_0x4893fe=_0x44ce34+_0x15dfb9(0x188)+_0xbc6576,_0x43dd2a=_0x15dfb9(0x19d)+_0xbc6576),_0x463c0e=_0x44ce34+_0x15dfb9(0xf8)+_0xbc6576,_0x42e5f6=_0x15dfb9(0x15d)+_0xbc6576,console[_0x15dfb9(0x140)](_0x15dfb9(0x18c)+_0xccdad8+_0x15dfb9(0x11c)+_0xbc6576+':'),console[_0x15dfb9(0x140)]('\x20\x20\x20üåê\x20Gateway\x20Success\x20URL:\x20'+_0x4893fe),console[_0x15dfb9(0x140)](_0x15dfb9(0x17b)+_0x463c0e),console[_0x15dfb9(0x140)](_0x15dfb9(0x159)+_0x43dd2a),console['log'](_0x15dfb9(0x11d)+_0x42e5f6),{'finalSuccessUrl':_0x4893fe,'finalFailUrl':_0x463c0e,'dbSuccessUrl':_0x43dd2a,'dbFailUrl':_0x42e5f6};}[a45_0x8ca45c(0x1c1)](_0x5cc7d0,_0x4630a7){const _0x3560c9=a45_0x8ca45c;if(!_0x5cc7d0['startsWith'](_0x3560c9(0x137)))return;const _0x206dbc=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x5cc7d0),_0x139101=_0x4630a7['toUpperCase']();switch(_0x206dbc){case'EU':if(_0x139101!==_0x3560c9(0x11a))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x139101);break;case'GB':if(_0x139101!=='GBP')throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x139101);break;case'DE':if(_0x139101!==_0x3560c9(0x11a))throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x139101);break;default:throw new Error(_0x3560c9(0x11e)+_0x206dbc);}}async[a45_0x8ca45c(0x18a)](_0x40b501,_0x4a5b88){const _0x50076c=a45_0x8ca45c;console[_0x50076c(0x140)](_0x50076c(0x1b0)+_0x40b501+':\x20'+_0x4a5b88);const _0x1c166d=await database_1[_0x50076c(0x149)][_0x50076c(0x183)]['findUnique']({'where':{'id':_0x40b501},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x1c166d)throw new Error(_0x50076c(0x160));let _0x367847=[];if(_0x1c166d[_0x50076c(0x18d)])try{_0x367847=JSON[_0x50076c(0x14c)](_0x1c166d['paymentGateways']),console[_0x50076c(0x140)](_0x50076c(0x1b7)+_0x1c166d[_0x50076c(0x190)]+_0x50076c(0xfd),_0x367847);}catch(_0x383e53){console[_0x50076c(0x12d)](_0x50076c(0x179),_0x383e53),_0x367847=['Plisio'];}else _0x367847=['Plisio'],console['log'](_0x50076c(0x1b7)+_0x1c166d['username']+_0x50076c(0x151),_0x367847);const _0x5c59fc=this[_0x50076c(0x1a6)](_0x4a5b88);console[_0x50076c(0x140)](_0x50076c(0x199)+_0x5c59fc+_0x50076c(0x10f),_0x367847);if(!_0x367847[_0x50076c(0x125)](_0x5c59fc)){console[_0x50076c(0x12d)](_0x50076c(0x114)+_0x5c59fc+'\x22\x20not\x20allowed\x20for\x20shop\x20'+_0x1c166d[_0x50076c(0x190)]),console[_0x50076c(0x12d)]('‚ùå\x20Enabled\x20gateways:\x20'+_0x367847[_0x50076c(0x193)](',\x20'));throw new Error(_0x50076c(0x139)+_0x5c59fc+_0x50076c(0x105)+('Enabled\x20gateways:\x20'+_0x367847[_0x50076c(0x193)](',\x20')+'.\x20')+'Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.');}console['log'](_0x50076c(0x1b4)+_0x5c59fc+'\x22\x20is\x20allowed\x20for\x20shop\x20'+_0x1c166d[_0x50076c(0x190)]);}[a45_0x8ca45c(0x1a6)](_0x1eee48){const _0x2722df=a45_0x8ca45c,_0x13e898={'plisio':_0x2722df(0x1a2),'rapyd':_0x2722df(0x17f),'noda':_0x2722df(0x1ad),'cointopay':_0x2722df(0x1c3),'klyme_eu':_0x2722df(0x171),'klyme_gb':_0x2722df(0xff),'klyme_de':_0x2722df(0x109)};return _0x13e898[_0x1eee48]||_0x1eee48;}async[a45_0x8ca45c(0x113)](_0x24d1ff,_0x5a2906){const _0x29632d=a45_0x8ca45c;if(!(0x0,gateway_1[_0x29632d(0x1a1)])(_0x5a2906[_0x29632d(0x156)]))throw new Error(_0x29632d(0x186)+_0x5a2906[_0x29632d(0x156)]+'.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)');const _0x28bf5c=(0x0,gateway_1[_0x29632d(0x178)])(_0x5a2906[_0x29632d(0x156)]);if(!_0x28bf5c)throw new Error(_0x29632d(0x1b1)+_0x5a2906[_0x29632d(0x156)]);console[_0x29632d(0x140)](_0x29632d(0xfe)+_0x28bf5c),await this[_0x29632d(0x18a)](_0x24d1ff,_0x28bf5c);if(_0x28bf5c===_0x29632d(0x16d)&&!_0x5a2906['sourceCurrency'])throw new Error(_0x29632d(0x127));if(_0x28bf5c[_0x29632d(0x1a0)]('klyme_')){const _0x2e4941=(0x0,gateway_1[_0x29632d(0xfc)])(_0x28bf5c);console['log']('üí≥\x20Creating\x20KLYME\x20'+_0x2e4941+_0x29632d(0x10c));}let _0x5d23a9=_0x5a2906[_0x29632d(0x13f)];_0x28bf5c===_0x29632d(0x107)&&(_0x5d23a9='GB',console['log'](_0x29632d(0x110)));if(!_0x5a2906[_0x29632d(0x1bd)]||_0x5a2906[_0x29632d(0x1bd)]<=0x0)throw new Error('amount\x20is\x20required\x20and\x20must\x20be\x20positive');let _0x2c174b=_0x5a2906[_0x29632d(0x175)]||_0x29632d(0x143);_0x28bf5c===_0x29632d(0x169)&&(_0x2c174b='EUR',console[_0x29632d(0x140)](_0x29632d(0x12a)));this[_0x29632d(0x1c1)](_0x28bf5c,_0x2c174b);const _0x59a288=await database_1[_0x29632d(0x149)][_0x29632d(0x1ae)][_0x29632d(0x165)]({'data':{'shopId':_0x24d1ff,'amount':_0x5a2906[_0x29632d(0x1bd)],'currency':_0x2c174b,'sourceCurrency':_0x5a2906[_0x29632d(0x14e)]||undefined,'gateway':_0x28bf5c,'maxPayments':_0x5a2906[_0x29632d(0x142)]||0x1,'currentPayments':0x0,'status':'ACTIVE','expiresAt':_0x5a2906[_0x29632d(0x1a4)]?new Date(_0x5a2906[_0x29632d(0x1a4)]):undefined,'successUrl':_0x5a2906['successUrl']||null,'failUrl':_0x5a2906[_0x29632d(0x11b)]||null,'country':_0x5d23a9,'language':_0x5a2906[_0x29632d(0x164)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console['log'](_0x29632d(0x173)+_0x59a288['id']+'\x20('+_0x28bf5c+')'),console[_0x29632d(0x140)]('üí∞\x20Fixed\x20amount:\x20'+_0x59a288[_0x29632d(0x1bd)]+'\x20'+_0x59a288[_0x29632d(0x175)]),console[_0x29632d(0x140)](_0x29632d(0x1a9)+_0x59a288['id']),console[_0x29632d(0x140)](_0x29632d(0x13b)),this[_0x29632d(0xf7)](_0x59a288);}async[a45_0x8ca45c(0x1bc)](_0x18ba38,_0x380fb8){const _0xafd499=a45_0x8ca45c,{page:_0x54c627,limit:_0x1938f7,status:_0x187ade,gateway:_0x3689d8,search:_0x2ab2ae}=_0x380fb8,_0x362eb1=(_0x54c627-0x1)*_0x1938f7,_0x19ee76={'shopId':_0x18ba38};_0x187ade&&(_0x19ee76[_0xafd499(0x19a)]=_0x187ade[_0xafd499(0x198)]());if(_0x3689d8){if((0x0,gateway_1[_0xafd499(0x1a1)])(_0x3689d8)){const _0x5a904d=(0x0,gateway_1[_0xafd499(0x178)])(_0x3689d8);_0x5a904d&&(_0x19ee76[_0xafd499(0x156)]=_0x5a904d);}else _0x19ee76['gateway']=_0x3689d8[_0xafd499(0x15a)]();}_0x2ab2ae&&(_0x19ee76['OR']=[{'gateway':{'contains':_0x2ab2ae,'mode':_0xafd499(0x197)}},{'currency':{'contains':_0x2ab2ae,'mode':'insensitive'}}]);const [_0xd71ba2,_0x359a08]=await Promise[_0xafd499(0x155)]([database_1['default'][_0xafd499(0x1ae)]['findMany']({'where':_0x19ee76,'skip':_0x362eb1,'take':_0x1938f7,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0xafd499(0x189)},'take':0xa}}}),database_1[_0xafd499(0x149)][_0xafd499(0x1ae)]['count']({'where':_0x19ee76})]);return{'links':_0xd71ba2['map'](_0xd6f5a0=>this[_0xafd499(0xf7)](_0xd6f5a0)),'pagination':{'page':_0x54c627,'limit':_0x1938f7,'total':_0x359a08,'totalPages':Math[_0xafd499(0x120)](_0x359a08/_0x1938f7)}};}async[a45_0x8ca45c(0x16a)](_0x3c4016,_0x103bea){const _0x8cfdca=a45_0x8ca45c,_0x201461=await database_1[_0x8cfdca(0x149)][_0x8cfdca(0x1ae)]['findFirst']({'where':{'id':_0x103bea,'shopId':_0x3c4016},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x8cfdca(0x189)}}}});if(!_0x201461)return null;return this['formatPaymentLinkResponse'](_0x201461);}async[a45_0x8ca45c(0x16c)](_0x1f085b,_0x4980b9,_0x2c5778){const _0x1f201a=a45_0x8ca45c,_0x350022={..._0x2c5778};if(_0x2c5778[_0x1f201a(0x156)]){if((0x0,gateway_1[_0x1f201a(0x1a1)])(_0x2c5778[_0x1f201a(0x156)])){const _0x2c2520=(0x0,gateway_1[_0x1f201a(0x178)])(_0x2c5778['gateway']);_0x2c2520&&(await this[_0x1f201a(0x18a)](_0x1f085b,_0x2c2520),_0x350022['gateway']=_0x2c2520);}else _0x350022[_0x1f201a(0x156)]=_0x2c5778[_0x1f201a(0x156)][_0x1f201a(0x15a)]();}(_0x350022[_0x1f201a(0x156)]===_0x1f201a(0x107)||_0x2c5778['country']&&_0x350022['gateway']!==_0x1f201a(0x107))&&(_0x350022[_0x1f201a(0x156)]===_0x1f201a(0x107)&&(_0x350022[_0x1f201a(0x13f)]='GB',console[_0x1f201a(0x140)]('üá¨üáß\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update')));_0x350022['gateway']===_0x1f201a(0x169)&&(_0x350022[_0x1f201a(0x175)]=_0x1f201a(0x11a),console['log'](_0x1f201a(0x129)));_0x350022[_0x1f201a(0x156)]&&_0x350022[_0x1f201a(0x175)]&&this[_0x1f201a(0x1c1)](_0x350022[_0x1f201a(0x156)],_0x350022['currency']);_0x2c5778['expiresAt']&&(_0x350022['expiresAt']=new Date(_0x2c5778[_0x1f201a(0x1a4)]));const _0x3b277c=await database_1[_0x1f201a(0x149)]['paymentLink'][_0x1f201a(0x1a8)]({'where':{'id':_0x4980b9,'shopId':_0x1f085b},'data':_0x350022,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x1f201a(0x189)},'take':0xa}}});return this[_0x1f201a(0xf7)](_0x3b277c);}async[a45_0x8ca45c(0x1c4)](_0x35898f,_0x1e217c){const _0x50d3c1=a45_0x8ca45c;await database_1['default'][_0x50d3c1(0x1ae)][_0x50d3c1(0x194)]({'where':{'id':_0x1e217c,'shopId':_0x35898f}});}async[a45_0x8ca45c(0x154)](_0x33e938){const _0x501969=a45_0x8ca45c,_0x15502a=await database_1[_0x501969(0x149)]['paymentLink'][_0x501969(0x192)]({'where':{'id':_0x33e938},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x15502a)return null;const _0x1ae4d7=_0x15502a[_0x501969(0x1a4)]&&_0x15502a['expiresAt']<new Date(),_0x527d90=_0x15502a[_0x501969(0x10e)]>=_0x15502a[_0x501969(0x142)],_0x168229=_0x15502a[_0x501969(0x183)][_0x501969(0x19a)]==='ACTIVE',_0x4537cc=_0x15502a[_0x501969(0x19a)]===_0x501969(0x1ba),_0x2e36ea=!_0x1ae4d7&&!_0x527d90&&_0x168229&&_0x4537cc,_0x153102=Math[_0x501969(0x12b)](0x0,_0x15502a[_0x501969(0x142)]-_0x15502a[_0x501969(0x10e)]);return{'id':_0x15502a['id'],'amount':_0x15502a[_0x501969(0x1bd)],'currency':_0x15502a[_0x501969(0x175)],'sourceCurrency':_0x15502a[_0x501969(0x14e)]||undefined,'gateway':_0x15502a[_0x501969(0x156)],'maxPayments':_0x15502a[_0x501969(0x142)],'currentPayments':_0x15502a[_0x501969(0x10e)],'status':_0x15502a[_0x501969(0x19a)],'expiresAt':_0x15502a['expiresAt']||undefined,'shopName':_0x15502a[_0x501969(0x183)][_0x501969(0x100)],'isAvailable':_0x2e36ea,'remainingPayments':_0x153102};}async[a45_0x8ca45c(0x16b)](_0x2d1093){const _0x349614=a45_0x8ca45c,{linkId:_0x115210,customerEmail:_0x39c8fa,customerName:_0x480e45}=_0x2d1093,_0x84b7b3=await database_1['default'][_0x349614(0x1ae)][_0x349614(0x192)]({'where':{'id':_0x115210},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x84b7b3)throw new Error(_0x349614(0x14f));const _0x5d049a=_0x84b7b3[_0x349614(0x1a4)]&&_0x84b7b3[_0x349614(0x1a4)]<new Date(),_0x1b649d=_0x84b7b3[_0x349614(0x10e)]>=_0x84b7b3[_0x349614(0x142)],_0x186690=_0x84b7b3[_0x349614(0x183)]['status']==='ACTIVE',_0xcb866d=_0x84b7b3['status']==='ACTIVE';if(_0x5d049a)throw new Error(_0x349614(0x1c0));if(_0x1b649d)throw new Error(_0x349614(0x145));if(!_0x186690)throw new Error('Shop\x20is\x20not\x20active');if(!_0xcb866d)throw new Error('Payment\x20link\x20is\x20not\x20active');await this[_0x349614(0x18a)](_0x84b7b3[_0x349614(0x17e)],_0x84b7b3[_0x349614(0x156)]);const _0xafef67=_0x84b7b3[_0x349614(0x1bd)];console[_0x349614(0x140)](_0x349614(0x1b3)+_0x115210+':\x20'+_0xafef67+'\x20'+_0x84b7b3['currency']),console[_0x349614(0x140)]('üë§\x20Customer:\x20'+(_0x480e45||_0x349614(0x141))+'\x20('+(_0x39c8fa||_0x349614(0xf9))+')'),this['validateKlymeCurrency'](_0x84b7b3[_0x349614(0x156)],_0x84b7b3['currency']);const _0x203be9=this['generateGatewayOrderId']();console[_0x349614(0x140)]('üéØ\x20Generated\x20gateway\x20order_id:\x20'+_0x203be9+_0x349614(0x102)+_0x84b7b3['gateway']+')');const _0x565eb1=await database_1['default'][_0x349614(0x161)][_0x349614(0x165)]({'data':{'shopId':_0x84b7b3['shopId'],'paymentLinkId':_0x84b7b3['id'],'gateway':_0x84b7b3['gateway'],'amount':_0xafef67,'currency':_0x84b7b3[_0x349614(0x175)],'sourceCurrency':_0x84b7b3[_0x349614(0x14e)]||undefined,'usage':'ONCE','expiresAt':_0x84b7b3[_0x349614(0x1a4)]||undefined,'successUrl':'temp','failUrl':'temp','status':_0x349614(0x118),'orderId':null,'gatewayOrderId':_0x203be9,'customerEmail':_0x39c8fa||undefined,'customerName':_0x480e45||undefined,'country':_0x84b7b3[_0x349614(0x13f)]||undefined,'language':_0x84b7b3[_0x349614(0x164)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x349614(0x140)](_0x349614(0x1b8)+_0x565eb1['id']);const _0x55b1e9=process[_0x349614(0x1af)][_0x349614(0x15e)]||'https://tesoft.uk',{finalSuccessUrl:_0x11a046,finalFailUrl:_0x4ab90c,dbSuccessUrl:_0x3f14a4,dbFailUrl:_0x3f2ec1}=this[_0x349614(0x152)](_0x84b7b3['gateway'],_0x565eb1['id'],_0x55b1e9,_0x84b7b3['successUrl']||undefined,_0x84b7b3[_0x349614(0x11b)]||undefined);await database_1[_0x349614(0x149)][_0x349614(0x161)][_0x349614(0x1a8)]({'where':{'id':_0x565eb1['id']},'data':{'successUrl':_0x3f14a4,'failUrl':_0x3f2ec1}}),console[_0x349614(0x140)](_0x349614(0x115)+_0xafef67+'\x20'+_0x84b7b3['currency']),console[_0x349614(0x140)](_0x349614(0x14d)+(_0x480e45||_0x349614(0x141))+'\x20('+(_0x39c8fa||_0x349614(0xf9))+')'),console[_0x349614(0x140)](_0x349614(0x1c2)+_0x3f14a4),console['log'](_0x349614(0x19b)+_0x3f2ec1);let _0x5364e9,_0x360c3c;try{if(_0x84b7b3[_0x349614(0x156)]===_0x349614(0x16d)){console[_0x349614(0x140)](_0x349614(0x158)),console[_0x349614(0x140)](_0x349614(0x166)+_0x84b7b3['currency']),console[_0x349614(0x140)]('\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20'+_0x84b7b3[_0x349614(0x14e)]);const _0x49b87c=await this[_0x349614(0x106)]['createPayment']({'paymentId':_0x565eb1['id'],'orderId':_0x203be9,'amount':_0xafef67,'currency':_0x84b7b3[_0x349614(0x175)],'productName':_0x349614(0x101)+_0xafef67+'\x20'+_0x84b7b3['currency'],'description':_0x349614(0x101)+_0xafef67+'\x20'+_0x84b7b3['currency'],'successUrl':_0x11a046,'failUrl':_0x4ab90c,'customerEmail':_0x39c8fa||undefined,'customerName':_0x480e45||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x84b7b3[_0x349614(0x14e)]||undefined});_0x5364e9=_0x49b87c[_0x349614(0x1b6)],_0x360c3c=_0x49b87c[_0x349614(0x104)],await database_1['default'][_0x349614(0x161)][_0x349614(0x1a8)]({'where':{'id':_0x565eb1['id']},'data':{'externalPaymentUrl':_0x360c3c,'gatewayPaymentId':_0x5364e9,'invoiceTotalSum':Number(_0x49b87c['invoice_total_sum']),'qrCode':_0x49b87c['qr_code'],'qrUrl':_0x49b87c[_0x349614(0x131)]}});const _0xe69201='https://app.trapay.uk/payment/'+_0x565eb1['id'];return console[_0x349614(0x140)](_0x349614(0x1a5)+_0xe69201),{'paymentId':_0x565eb1['id'],'paymentUrl':_0xe69201,'expiresAt':_0x565eb1[_0x349614(0x1a4)]||undefined};}else{if(_0x84b7b3[_0x349614(0x156)]===_0x349614(0x107)){const _0x12aa7a=await this['rapydService']['createPaymentLink']({'paymentId':_0x565eb1['id'],'orderId':_0x203be9,'orderName':_0x349614(0x101)+_0xafef67+'\x20'+_0x84b7b3['currency'],'amount':_0xafef67,'currency':_0x84b7b3['currency'],'country':_0x84b7b3['country'],'language':_0x84b7b3[_0x349614(0x164)]||'EN','amountIsEditable':![],'usage':_0x349614(0x135),'maxPayments':0x1,'successUrl':_0x11a046,'failUrl':_0x4ab90c});_0x5364e9=_0x12aa7a[_0x349614(0x1b6)],_0x360c3c=_0x12aa7a[_0x349614(0x104)],await database_1['default']['payment'][_0x349614(0x1a8)]({'where':{'id':_0x565eb1['id']},'data':{'externalPaymentUrl':_0x360c3c,'gatewayPaymentId':_0x5364e9}});const _0x315e62=_0x349614(0x168)+_0x565eb1['id'];return console['log'](_0x349614(0x177)+_0x315e62),{'paymentId':_0x565eb1['id'],'paymentUrl':_0x315e62,'expiresAt':_0x565eb1[_0x349614(0x1a4)]||undefined};}else{if(_0x84b7b3[_0x349614(0x156)]==='noda'){const _0xf99960=await this[_0x349614(0x170)][_0x349614(0x113)]({'paymentId':_0x565eb1['id'],'orderId':_0x203be9,'name':'Payment\x20'+_0xafef67+'\x20'+_0x84b7b3[_0x349614(0x175)],'paymentDescription':_0x349614(0x101)+_0xafef67+'\x20'+_0x84b7b3[_0x349614(0x175)],'amount':_0xafef67,'currency':_0x84b7b3[_0x349614(0x175)],'webhookUrl':_0x349614(0x1a3),'returnUrl':_0x11a046,'expiryDate':_0x84b7b3[_0x349614(0x1a4)]?.['toISOString']()});_0x5364e9=_0xf99960[_0x349614(0x1b6)],_0x360c3c=_0xf99960[_0x349614(0x104)],await database_1[_0x349614(0x149)][_0x349614(0x161)][_0x349614(0x1a8)]({'where':{'id':_0x565eb1['id']},'data':{'externalPaymentUrl':_0x360c3c,'gatewayPaymentId':_0x5364e9,'qrUrl':_0xf99960[_0x349614(0x128)]}});const _0x132711=_0x349614(0x168)+_0x565eb1['id'];return console[_0x349614(0x140)](_0x349614(0x15f)+_0x132711),{'paymentId':_0x565eb1['id'],'paymentUrl':_0x132711,'expiresAt':_0x565eb1[_0x349614(0x1a4)]||undefined};}else{if(_0x84b7b3[_0x349614(0x156)]===_0x349614(0x169)){console[_0x349614(0x140)](_0x349614(0x15b)+_0x203be9+_0x349614(0x16e)),console[_0x349614(0x140)](_0x349614(0x115)+_0xafef67+_0x349614(0x112));const _0x3cd19e=await this[_0x349614(0x16f)]['createPaymentLink']({'paymentId':_0x565eb1['id'],'orderId':_0x203be9,'amount':_0xafef67});_0x5364e9=_0x3cd19e['gateway_payment_id'],_0x360c3c=_0x3cd19e[_0x349614(0x104)],await database_1[_0x349614(0x149)][_0x349614(0x161)]['update']({'where':{'id':_0x565eb1['id']},'data':{'externalPaymentUrl':_0x360c3c,'gatewayPaymentId':_0x5364e9}});_0x5364e9&&(console[_0x349614(0x140)](_0x349614(0x182)+_0x565eb1['id']+'\x20('+_0x5364e9+')'),coinToPayStatusService_1[_0x349614(0x126)][_0x349614(0x144)](_0x565eb1['id'],_0x5364e9));const _0x227255=_0x349614(0x168)+_0x565eb1['id'];return console[_0x349614(0x140)](_0x349614(0x17c)+_0x227255),{'paymentId':_0x565eb1['id'],'paymentUrl':_0x227255,'expiresAt':_0x565eb1[_0x349614(0x1a4)]||undefined};}else{if(_0x84b7b3[_0x349614(0x156)][_0x349614(0x1a0)](_0x349614(0x137))){const _0x34b78e=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x84b7b3['gateway']);if(!_0x34b78e)throw new Error(_0x349614(0x13e)+_0x84b7b3[_0x349614(0x156)]);console[_0x349614(0x140)]('üí≥\x20Creating\x20KLYME\x20'+_0x34b78e+_0x349614(0x11f)+_0x203be9+_0x349614(0x16e)),console['log'](_0x349614(0x115)+_0xafef67+'\x20'+_0x84b7b3['currency']+_0x349614(0x12c)+_0x34b78e+')');const _0x2035dc=await this[_0x349614(0x181)]['createPaymentLink']({'paymentId':_0x565eb1['id'],'orderId':_0x203be9,'amount':_0xafef67,'currency':_0x84b7b3['currency'],'region':_0x34b78e,'redirectUrl':_0x11a046});_0x5364e9=_0x2035dc[_0x349614(0x1b6)],_0x360c3c=_0x2035dc[_0x349614(0x104)],await database_1[_0x349614(0x149)][_0x349614(0x161)][_0x349614(0x1a8)]({'where':{'id':_0x565eb1['id']},'data':{'externalPaymentUrl':_0x360c3c,'gatewayPaymentId':_0x5364e9}});const _0xb8829b=_0x349614(0x10a)+_0x565eb1['id'];return console['log'](_0x349614(0x13c)+_0x34b78e+_0x349614(0x150)+_0x203be9),console[_0x349614(0x140)](_0x349614(0x18b)+_0x34b78e+'\x20payment\x20URL:\x20'+_0xb8829b),{'paymentId':_0x565eb1['id'],'paymentUrl':_0xb8829b,'expiresAt':_0x565eb1[_0x349614(0x1a4)]||undefined};}else throw new Error(_0x349614(0xf5)+_0x84b7b3[_0x349614(0x156)]);}}}}}catch(_0x4681e6){await database_1[_0x349614(0x149)]['payment']['update']({'where':{'id':_0x565eb1['id']},'data':{'status':'FAILED'}});throw new Error(_0x349614(0x180)+(_0x4681e6 instanceof Error?_0x4681e6[_0x349614(0x195)]:'Unknown\x20error'));}}async[a45_0x8ca45c(0x14a)](_0x1caa9d){const _0x22e386=a45_0x8ca45c;console[_0x22e386(0x140)](_0x22e386(0x103)+_0x1caa9d);const _0x2911fc=await database_1[_0x22e386(0x149)][_0x22e386(0x161)]['findUnique']({'where':{'id':_0x1caa9d},'include':{'paymentLink':!![]}});if(!_0x2911fc||!_0x2911fc[_0x22e386(0x1ae)]){console[_0x22e386(0x140)](_0x22e386(0x1b9)+_0x1caa9d+_0x22e386(0x12e));return;}if(_0x2911fc['status']!=='PAID'){console[_0x22e386(0x140)](_0x22e386(0x1b9)+_0x1caa9d+_0x22e386(0x185)+_0x2911fc[_0x22e386(0x19a)]+_0x22e386(0x12f));return;}if(!_0x2911fc[_0x22e386(0x10d)]){console[_0x22e386(0x140)]('üìà\x20Payment\x20'+_0x1caa9d+'\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.');return;}try{const _0x1488f5=await database_1[_0x22e386(0x149)][_0x22e386(0x147)](async _0x2f96b3=>{const _0xfd53a8=_0x22e386,_0x4736a6=await _0x2f96b3[_0xfd53a8(0x1ae)][_0xfd53a8(0x192)]({'where':{'id':_0x2911fc[_0xfd53a8(0x187)]},'select':{'id':!![],'currentPayments':!![],'maxPayments':!![],'status':!![]}});if(!_0x4736a6)throw new Error(_0xfd53a8(0x122)+_0x2911fc[_0xfd53a8(0x187)]+_0xfd53a8(0x19e));if(_0x4736a6[_0xfd53a8(0x10e)]>=_0x4736a6[_0xfd53a8(0x142)])return console['log'](_0xfd53a8(0x121)+_0x2911fc[_0xfd53a8(0x187)]+'\x20already\x20at\x20max\x20payments\x20('+_0x4736a6[_0xfd53a8(0x10e)]+'/'+_0x4736a6['maxPayments']+_0xfd53a8(0x13d)),_0x4736a6;const _0x3bdec6=await _0x2f96b3['payment'][_0xfd53a8(0x1bf)]({'where':{'paymentLinkId':_0x2911fc[_0xfd53a8(0x187)],'status':'PAID','paidAt':{'not':null},'id':{'not':_0x1caa9d}}}),_0x30d4cd=_0x3bdec6+0x1,_0x2a6b9c=await _0x2f96b3[_0xfd53a8(0x1ae)][_0xfd53a8(0x1a8)]({'where':{'id':_0x2911fc['paymentLinkId']},'data':{'currentPayments':_0x30d4cd,'status':_0x30d4cd>=_0x4736a6[_0xfd53a8(0x142)]?_0xfd53a8(0x133):_0x4736a6[_0xfd53a8(0x19a)]}});return console[_0xfd53a8(0x140)](_0xfd53a8(0x121)+_0x2911fc[_0xfd53a8(0x187)]+_0xfd53a8(0x153)+_0x4736a6[_0xfd53a8(0x10e)]+'\x20->\x20'+_0x30d4cd+'/'+_0x4736a6[_0xfd53a8(0x142)]),_0x2a6b9c;});_0x1488f5[_0x22e386(0x19a)]===_0x22e386(0x133)&&console[_0x22e386(0x140)](_0x22e386(0x18e)+_0x2911fc['paymentLinkId']+_0x22e386(0x136)+_0x1488f5[_0x22e386(0x10e)]+'/'+_0x1488f5[_0x22e386(0x142)]+')');}catch(_0x84a23c){console[_0x22e386(0x12d)](_0x22e386(0x17a)+_0x1caa9d+':',_0x84a23c);}}async[a45_0x8ca45c(0x19f)](_0xdfe8ca){const _0x38a099=a45_0x8ca45c,[_0x3d6673,_0x4f96d9,_0x4329f5,_0x12a974]=await Promise[_0x38a099(0x155)]([database_1[_0x38a099(0x149)][_0x38a099(0x1ae)]['count']({'where':{'shopId':_0xdfe8ca}}),database_1[_0x38a099(0x149)][_0x38a099(0x1ae)][_0x38a099(0x1bf)]({'where':{'shopId':_0xdfe8ca,'status':_0x38a099(0x1ba)}}),database_1[_0x38a099(0x149)][_0x38a099(0x161)][_0x38a099(0x1bf)]({'where':{'shopId':_0xdfe8ca,'paymentLinkId':{'not':null}}}),database_1[_0x38a099(0x149)][_0x38a099(0x161)][_0x38a099(0x1aa)]({'where':{'shopId':_0xdfe8ca,'paymentLinkId':{'not':null},'status':'PAID'},'select':{'amount':!![],'currency':!![]}})]);let _0x27b778=0x0;for(const _0x560385 of _0x12a974){const _0x408ada=await currencyService_1[_0x38a099(0x1a7)][_0x38a099(0x138)](_0x560385[_0x38a099(0x1bd)],_0x560385[_0x38a099(0x175)]);_0x27b778+=_0x408ada;}const _0x790f17=_0x4329f5>0x0?_0x12a974['length']/_0x4329f5*0x64:0x0;return{'totalLinks':_0x3d6673,'activeLinks':_0x4f96d9,'totalPayments':_0x4329f5,'totalRevenue':Math[_0x38a099(0x124)](_0x27b778*0x64)/0x64,'conversionRate':Math['round'](_0x790f17*0x64)/0x64};}[a45_0x8ca45c(0xf7)](_0xc0ac48){const _0x1d41ce=a45_0x8ca45c;return{'id':_0xc0ac48['id'],'shopId':_0xc0ac48[_0x1d41ce(0x17e)],'amount':_0xc0ac48['amount'],'currency':_0xc0ac48['currency'],'sourceCurrency':_0xc0ac48[_0x1d41ce(0x14e)]||undefined,'gateway':_0xc0ac48[_0x1d41ce(0x156)],'maxPayments':_0xc0ac48[_0x1d41ce(0x142)],'currentPayments':_0xc0ac48[_0x1d41ce(0x10e)],'status':_0xc0ac48[_0x1d41ce(0x19a)],'expiresAt':_0xc0ac48['expiresAt']||undefined,'successUrl':_0xc0ac48[_0x1d41ce(0x163)]||undefined,'failUrl':_0xc0ac48[_0x1d41ce(0x11b)]||undefined,'country':_0xc0ac48[_0x1d41ce(0x13f)]||undefined,'language':_0xc0ac48[_0x1d41ce(0x164)]||undefined,'linkUrl':_0x1d41ce(0x117)+_0xc0ac48['id'],'createdAt':_0xc0ac48[_0x1d41ce(0x184)],'updatedAt':_0xc0ac48[_0x1d41ce(0x108)],'shop':_0xc0ac48['shop'],'payments':_0xc0ac48[_0x1d41ce(0x1ac)]};}}exports['PaymentLinkService']=PaymentLinkService;