'use strict';const a49_0x339e7e=a49_0x296e;(function(_0xda6fae,_0x3c12d0){const _0x4ce2ab=a49_0x296e,_0x1d5014=_0xda6fae();while(!![]){try{const _0x1e28c4=-parseInt(_0x4ce2ab(0x209))/0x1+parseInt(_0x4ce2ab(0x177))/0x2*(-parseInt(_0x4ce2ab(0x201))/0x3)+parseInt(_0x4ce2ab(0x154))/0x4*(-parseInt(_0x4ce2ab(0x13e))/0x5)+-parseInt(_0x4ce2ab(0x181))/0x6*(-parseInt(_0x4ce2ab(0x1a8))/0x7)+parseInt(_0x4ce2ab(0x174))/0x8+-parseInt(_0x4ce2ab(0x175))/0x9*(-parseInt(_0x4ce2ab(0x1cf))/0xa)+parseInt(_0x4ce2ab(0x224))/0xb*(parseInt(_0x4ce2ab(0x210))/0xc);if(_0x1e28c4===_0x3c12d0)break;else _0x1d5014['push'](_0x1d5014['shift']());}catch(_0x38c0bc){_0x1d5014['push'](_0x1d5014['shift']());}}}(a49_0x18ff,0x6ae1e));var __importDefault=this&&this[a49_0x339e7e(0x1e8)]||function(_0x2107de){const _0x2a4fe1=a49_0x339e7e;return _0x2107de&&_0x2107de[_0x2a4fe1(0x14a)]?_0x2107de:{'default':_0x2107de};};Object[a49_0x339e7e(0x127)](exports,a49_0x339e7e(0x14a),{'value':!![]}),exports[a49_0x339e7e(0x1a9)]=void 0x0;function a49_0x18ff(){const _0x4979bf=['klymeService','./gateways/nodaService','padStart','findFirst','📈\x20Payment\x20','Payment\x20link\x20has\x20expired','gateway','plisio','invoice_total_sum','📈\x20Payment\x20link\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','amount\x20is\x20required\x20and\x20must\x20be\x20positive','\x22\x20not\x20allowed\x20for\x20shop\x20','Payment\x20link\x20has\x20reached\x20maximum\x20payments','\x20USDT)\x20exceeds\x20the\x20maximum\x20allowed\x20amount\x20of\x20','https://app.trapay.uk/payment/success?id=','error','nodaService',')\x20counter\x20updated:\x20','coinToPayService','payment','https://app.trapay.uk/link/','\x20gateway.\x20','getGatewayNameById','COMPLETED','schedulePaymentChecks','\x20link\x20with\x20','30980udCRkJ','🔗\x20No\x20whiteUrl\x20for\x20','no\x20email','\x20payments)','shopId','\x20USDT','\x20(MasterCard)','validateKlymeCurrency','klyme_','noda','paymentLinkId','currentPayments','expiresAt','length',',\x20gateway\x20','📝\x20Note:\x20Success/Fail/Pending\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created','getGatewayDisplayName','test_gateway','CoinToPay','🔗\x20Generated\x20whiteUrl\x20for\x20','pendingUrl','KLYME\x20DE','\x20USDT\x20for\x20limit\x20checking','amount','shop','__importDefault','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','SINGLE','rapydService','payment_url','Unsupported\x20gateway:\x20','Anonymous','checkGatewayPermission','👤\x20Customer:\x20','getPublicPaymentLinkData','Payment\x20amount\x20','🔗\x20Rapyd\x20payment\x20URL:\x20','💰\x20Fixed\x20amount:\x20','qr_code','./coinToPayStatusService','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','📈\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','\x20(Plisio\x20or\x20KLYME)','./currencyService','language','Enabled\x20gateways:\x20','generateGatewayUrls','../config/database','sourceCurrency','💾\x20DB\x20Success\x20URL:\x20','1977447pMYNdS','mastercard','https://tesoft.uk/gateways/noda/webhook','insensitive','handleSuccessfulPayment','Payment\x20','💾\x20Payment\x20created:\x20','createPaymentLink','340932wwlDgk','\x20USDT\x20is\x20below\x20minimum\x20','payments','failUrl','PAID','generateGatewayOrderId','/gateway/pending.php?id=','355788ulQoXf','./gateways/plisioService','checkAmountLimits','temp','paymentGateways','FAILED','\x20(Test\x20Gateway)','Unknown\x20error','rapyd','\x20status\x20is\x20','🔗\x20Plisio\x20payment\x20URL:\x20','\x22\x20is\x20allowed\x20for\x20shop\x20','getKlymeRegionFromGatewayName','💰\x20Amount:\x20',',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','🎯\x20Generated\x20gateway\x20order_id:\x20','\x20\x20\x20🔗\x20White\x20URL:\x20','Please\x20increase\x20the\x20amount.','🔗\x20Generated\x20URLs\x20for\x20','ceil','154rEVNVb','minAmount','🔗\x20Creating\x20','🔗\x20Test\x20Gateway\x20payment\x20URL:\x20','toLowerCase','defineProperty','formatPaymentLinkResponse','status','currency','map','paymentLink','\x20payment\x20link','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','gateway_payment_id','Payment\x20link\x20','createPayment','\x20->\x20','currencyService','PlisioService','https://app.trapay.uk/payment/fail?id=','\x20USDT\x20meets\x20minimum\x20requirement\x20of\x20','create','mc_','getPaymentLinks','none','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20','Please\x20reduce\x20the\x20amount.','\x20USDT\x20for\x20gateway\x20','119870Cegkfe','Shop\x20not\x20found','parse','BASE_URL','convertToUSDT','https://app.trapay.uk/payment/','ACTIVE','plisioService','Plisio','ONCE','MAX_SAFE_INTEGER','type','__esModule','coinToPayStatusService','🔗\x20Link\x20type:\x20','https://tesoft.uk/gateway/payment.php?id=','delete','Invalid\x20gateway\x20ID:\x20','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','env',',\x20amount:\x20','toString','20hEREPc','count','💰\x20Shop\x20','💾\x20DB\x20Pending\x20URL:\x20','isValidGatewayId','\x20already\x20used\x20(','\x20\x20\x20🌐\x20Gateway\x20Pending\x20URL:\x20','includes','USD','https://app.trapay.uk/test-gateway/payment/','\x20with\x20payment\x20ID\x20','successUrl','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','single-use','desc','random','💳\x20Creating\x20KLYME\x20','✅\x20Gateway\x20\x22','Error\x20parsing\x20payment\x20gateways:','🧪\x20Creating\x20Test\x20Gateway\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','\x20not\x20found','📈\x20Single\x20payment\x20link\x20','update','EUR','country','🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','\x20\x20\x20💾\x20DB\x20Pending\x20URL:\x20','\x20gateway\x20settings:','CoinToPayService','❌\x20Gateway\x20\x22','682440Lwygsi','2511kOywgn','updatedAt','2XjeLRV','all','🔗\x20CoinToPay\x20payment\x20URL:\x20','getPaymentLinkStatistics','Unsupported\x20KLYME\x20region:\x20','\x22\x20is\x20in\x20enabled\x20gateways:','Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.','updatePaymentLink','username','🔐\x20Checking\x20if\x20\x22','6zyjtHU','🏁\x20Payment\x20link\x20','✅\x20Payment\x20link\x20created:\x20','💳\x20Creating\x20MasterCard\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','❌\x20Enabled\x20gateways:\x20','💱\x20Converted\x20','💳\x20MasterCard\x20form\x20URL:\x20','✅\x20KLYME\x20','🔗\x20Noda\x20payment\x20URL:\x20','findMany','$transaction','\x20USDT\x20exceeds\x20maximum\x20','join','Payment\x20link\x20is\x20not\x20active','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','✅\x20Amount\x20','💰\x20Checking\x20amount\x20limits\x20for\x20shop\x20','gatewaySettings','/gateway/fail.php?id=','Noda','\x20USDT\x20for\x20','toUpperCase','createdAt','\x20to\x20','deletePaymentLink','💳\x20Initiating\x20payment\x20from\x20','\x20USDT)\x20is\x20below\x20the\x20minimum\x20required\x20amount\x20of\x20','startsWith','\x20(8digits-8digits\x20format)','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','findUnique','default','Shop\x20is\x20not\x20active','🔗\x20MasterCard\x20payment\x20URL:\x20','💾\x20DB\x20Fail\x20URL:\x20','message','\x20payments),\x20skipping\x20increment','floor','\x20USDT\x20meets\x20maximum\x20requirement\x20of\x20','1351056tYMbNm','PaymentLinkService','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','toFixed','KLYME\x20EU','RapydService','🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','&payment_id=','Gateway\x20not\x20found\x20for\x20ID:\x20','💰\x20Plisio\x20payment\x20link\x20mapping:','log','cointopay'];a49_0x18ff=function(){return _0x4979bf;};return a49_0x18ff();}function a49_0x296e(_0x18ee83,_0x151b48){const _0x18ff2c=a49_0x18ff();return a49_0x296e=function(_0x296e0d,_0x162f9e){_0x296e0d=_0x296e0d-0x123;let _0x58a366=_0x18ff2c[_0x296e0d];return _0x58a366;},a49_0x296e(_0x18ee83,_0x151b48);}const database_1=__importDefault(require(a49_0x339e7e(0x1fe))),plisioService_1=require(a49_0x339e7e(0x211)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a49_0x339e7e(0x1b5)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require('./gateways/klymeService'),coinToPayStatusService_1=require(a49_0x339e7e(0x1f6)),gateway_1=require('../types/gateway'),currencyService_1=require(a49_0x339e7e(0x1fa));class PaymentLinkService{constructor(){const _0x5c690d=a49_0x339e7e;this['plisioService']=new plisioService_1[(_0x5c690d(0x134))](),this[_0x5c690d(0x1eb)]=new rapydService_1[(_0x5c690d(0x1ad))](),this[_0x5c690d(0x1c5)]=new nodaService_1['NodaService'](),this['coinToPayService']=new coinToPayService_1[(_0x5c690d(0x172))](),this[_0x5c690d(0x1b4)]=new klymeService_1['KlymeService']();}[a49_0x339e7e(0x20e)](){const _0x4243d6=()=>{const _0x948fea=a49_0x296e;return Math[_0x948fea(0x1a6)](Math[_0x948fea(0x163)]()*0x5f5e100)[_0x948fea(0x153)]()[_0x948fea(0x1b6)](0x8,'0');};return _0x4243d6()+'-'+_0x4243d6();}[a49_0x339e7e(0x1fd)](_0x2614e6,_0x5dda26,_0x2a15a1,_0x5ba8d1,_0xcaf549,_0x151878,_0x54f755){const _0x23528f=a49_0x339e7e;if(_0xcaf549&&_0x151878&&_0x54f755)return{'finalSuccessUrl':_0xcaf549,'finalFailUrl':_0x151878,'finalPendingUrl':_0x54f755,'dbSuccessUrl':_0xcaf549,'dbFailUrl':_0x151878,'dbPendingUrl':_0x54f755,'whiteUrl':null};const _0x2d9339=_0xcaf549||_0x23528f(0x1c3)+_0x5dda26+_0x23528f(0x1af)+_0x2a15a1,_0x3ff50d=_0x151878||_0x23528f(0x135)+_0x5dda26+_0x23528f(0x1af)+_0x2a15a1,_0x2d6440=_0x54f755||'https://app.trapay.uk/payment/pending?id='+_0x5dda26+_0x23528f(0x1af)+_0x2a15a1;let _0x203b69,_0x24b14d,_0x17de20;_0x2614e6===_0x23528f(0x1d8)||_0x2614e6[_0x23528f(0x19c)](_0x23528f(0x1d7))||_0x2614e6===_0x23528f(0x1b3)?(_0x203b69=_0x5ba8d1+_0x23528f(0x20f)+_0x5dda26,_0x17de20=_0x5ba8d1+_0x23528f(0x20f)+_0x5dda26):(_0x203b69=_0x5ba8d1+'/gateway/success.php?id='+_0x5dda26,_0x17de20=_0x5ba8d1+'/gateway/pending.php?id='+_0x5dda26);_0x24b14d=_0x5ba8d1+_0x23528f(0x193)+_0x5dda26;let _0x2cd945=null;return _0x2614e6!==_0x23528f(0x1bb)&&!_0x2614e6[_0x23528f(0x19c)](_0x23528f(0x1d7))?(_0x2cd945=_0x23528f(0x14d)+_0x5dda26,console[_0x23528f(0x1b2)](_0x23528f(0x1e2)+_0x2614e6+':\x20'+_0x2cd945)):console[_0x23528f(0x1b2)](_0x23528f(0x1d0)+_0x2614e6+_0x23528f(0x1f9)),console[_0x23528f(0x1b2)](_0x23528f(0x222)+_0x2614e6+_0x23528f(0x15e)+_0x5dda26+':'),console[_0x23528f(0x1b2)]('\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20'+_0x203b69),console[_0x23528f(0x1b2)](_0x23528f(0x150)+_0x24b14d),console[_0x23528f(0x1b2)](_0x23528f(0x15a)+_0x17de20),console[_0x23528f(0x1b2)](_0x23528f(0x19e)+_0x2d9339),console['log']('\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20'+_0x3ff50d),console['log'](_0x23528f(0x170)+_0x2d6440),console[_0x23528f(0x1b2)](_0x23528f(0x220)+(_0x2cd945||_0x23528f(0x13a))),{'finalSuccessUrl':_0x203b69,'finalFailUrl':_0x24b14d,'finalPendingUrl':_0x17de20,'dbSuccessUrl':_0x2d9339,'dbFailUrl':_0x3ff50d,'dbPendingUrl':_0x2d6440,'whiteUrl':_0x2cd945};}['validateKlymeCurrency'](_0x33e030,_0x22d35c){const _0x54d3b9=a49_0x339e7e;if(!_0x33e030[_0x54d3b9(0x19c)](_0x54d3b9(0x1d7)))return;const _0x5c5d60=(0x0,gateway_1[_0x54d3b9(0x21c)])(_0x33e030),_0x2bf925=_0x22d35c[_0x54d3b9(0x196)]();switch(_0x5c5d60){case'EU':if(_0x2bf925!==_0x54d3b9(0x16c))throw new Error(_0x54d3b9(0x1be)+_0x2bf925);break;case'GB':if(_0x2bf925!=='GBP')throw new Error(_0x54d3b9(0x160)+_0x2bf925);break;case'DE':if(_0x2bf925!=='EUR')throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x2bf925);break;default:throw new Error(_0x54d3b9(0x17b)+_0x5c5d60);}}async[a49_0x339e7e(0x212)](_0x3d787a,_0x22106f,_0x32c08d,_0x1360cf){const _0x29f797=a49_0x339e7e;console['log'](_0x29f797(0x191)+_0x3d787a+_0x29f797(0x1dd)+_0x22106f+_0x29f797(0x152)+_0x32c08d+'\x20'+_0x1360cf);const _0x121166=await currencyService_1['currencyService'][_0x29f797(0x142)](_0x32c08d,_0x1360cf);console[_0x29f797(0x1b2)](_0x29f797(0x186)+_0x32c08d+'\x20'+_0x1360cf+_0x29f797(0x198)+_0x121166[_0x29f797(0x1ab)](0x6)+_0x29f797(0x1e5));const _0x514029=await database_1[_0x29f797(0x1a0)][_0x29f797(0x1e7)][_0x29f797(0x19f)]({'where':{'id':_0x3d787a},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x514029)throw new Error(_0x29f797(0x13f));let _0x12a239={};if(_0x514029[_0x29f797(0x192)])try{_0x12a239=JSON[_0x29f797(0x140)](_0x514029[_0x29f797(0x192)]),console[_0x29f797(0x1b2)](_0x29f797(0x156)+_0x514029[_0x29f797(0x17f)]+_0x29f797(0x171),_0x12a239);}catch(_0x4d95d6){console[_0x29f797(0x1c4)]('Error\x20parsing\x20gateway\x20settings:',_0x4d95d6),_0x12a239={};}const _0x3d0207=this[_0x29f797(0x1df)](_0x22106f);console[_0x29f797(0x1b2)]('💰\x20Checking\x20amount\x20limits\x20for\x20gateway:\x20'+_0x22106f+_0x29f797(0x132)+_0x3d0207);const _0x103968=_0x12a239[_0x3d0207];if(_0x103968&&_0x103968[_0x29f797(0x123)]!==undefined){const _0x1b9174=_0x103968[_0x29f797(0x123)];console[_0x29f797(0x1b2)]('💰\x20Gateway\x20'+_0x3d0207+'\x20minimum\x20amount:\x20'+_0x1b9174+_0x29f797(0x1d4));if(_0x121166<_0x1b9174){console['error']('❌\x20Amount\x20'+_0x121166['toFixed'](0x6)+_0x29f797(0x20a)+_0x1b9174+_0x29f797(0x13d)+_0x3d0207);throw new Error(_0x29f797(0x1f2)+_0x32c08d+'\x20'+_0x1360cf+'\x20('+_0x121166[_0x29f797(0x1ab)](0x2)+_0x29f797(0x19b)+_0x1b9174+_0x29f797(0x195)+_0x3d0207+_0x29f797(0x1ca)+_0x29f797(0x221));}console[_0x29f797(0x1b2)](_0x29f797(0x190)+_0x121166['toFixed'](0x6)+_0x29f797(0x136)+_0x1b9174+_0x29f797(0x13d)+_0x3d0207);}else console[_0x29f797(0x1b2)]('💰\x20No\x20minimum\x20amount\x20set\x20for\x20gateway\x20'+_0x3d0207);if(_0x103968&&_0x103968['maxAmount']!==undefined){const _0x1f093c=_0x103968['maxAmount'];console[_0x29f797(0x1b2)]('💰\x20Gateway\x20'+_0x3d0207+'\x20maximum\x20amount:\x20'+_0x1f093c+_0x29f797(0x1d4));if(_0x121166>_0x1f093c){console[_0x29f797(0x1c4)]('❌\x20Amount\x20'+_0x121166[_0x29f797(0x1ab)](0x6)+_0x29f797(0x18c)+_0x1f093c+_0x29f797(0x13d)+_0x3d0207);throw new Error(_0x29f797(0x1f2)+_0x32c08d+'\x20'+_0x1360cf+'\x20('+_0x121166[_0x29f797(0x1ab)](0x2)+_0x29f797(0x1c2)+_0x1f093c+'\x20USDT\x20for\x20'+_0x3d0207+_0x29f797(0x1ca)+_0x29f797(0x13c));}console[_0x29f797(0x1b2)](_0x29f797(0x190)+_0x121166[_0x29f797(0x1ab)](0x6)+_0x29f797(0x1a7)+_0x1f093c+_0x29f797(0x13d)+_0x3d0207);}else console[_0x29f797(0x1b2)]('💰\x20No\x20maximum\x20amount\x20set\x20for\x20gateway\x20'+_0x3d0207);}async[a49_0x339e7e(0x1ef)](_0x9b3daa,_0x4b1f05){const _0x57a055=a49_0x339e7e;console['log']('🔐\x20Checking\x20gateway\x20permission\x20for\x20shop\x20'+_0x9b3daa+':\x20'+_0x4b1f05);const _0x3be88e=await database_1[_0x57a055(0x1a0)][_0x57a055(0x1e7)][_0x57a055(0x19f)]({'where':{'id':_0x9b3daa},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x3be88e)throw new Error('Shop\x20not\x20found');let _0x525714=[];if(_0x3be88e[_0x57a055(0x214)])try{_0x525714=JSON[_0x57a055(0x140)](_0x3be88e['paymentGateways']),console['log']('🔐\x20Shop\x20'+_0x3be88e[_0x57a055(0x17f)]+'\x20enabled\x20gateways:',_0x525714);}catch(_0x1364d7){console['error'](_0x57a055(0x166),_0x1364d7),_0x525714=[_0x57a055(0x146)];}else _0x525714=[_0x57a055(0x146)],console['log']('🔐\x20Shop\x20'+_0x3be88e[_0x57a055(0x17f)]+'\x20using\x20default\x20gateways:',_0x525714);const _0x342ab2=this[_0x57a055(0x1df)](_0x4b1f05);console['log'](_0x57a055(0x180)+_0x342ab2+_0x57a055(0x17c),_0x525714);if(!_0x525714[_0x57a055(0x15b)](_0x342ab2)){console[_0x57a055(0x1c4)](_0x57a055(0x173)+_0x342ab2+_0x57a055(0x1c0)+_0x3be88e[_0x57a055(0x17f)]),console[_0x57a055(0x1c4)](_0x57a055(0x185)+_0x525714[_0x57a055(0x18d)](',\x20'));throw new Error('Gateway\x20\x22'+_0x342ab2+'\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20'+(_0x57a055(0x1fc)+_0x525714[_0x57a055(0x18d)](',\x20')+'.\x20')+_0x57a055(0x17d));}console[_0x57a055(0x1b2)](_0x57a055(0x165)+_0x342ab2+_0x57a055(0x21b)+_0x3be88e[_0x57a055(0x17f)]);}[a49_0x339e7e(0x1df)](_0x3ea17d){const _0x859a35=a49_0x339e7e,_0x4b2a5e={'test_gateway':'Test\x20Gateway','plisio':_0x859a35(0x146),'rapyd':'Rapyd','noda':_0x859a35(0x194),'cointopay':_0x859a35(0x1e1),'klyme_eu':_0x859a35(0x1ac),'klyme_gb':'KLYME\x20GB','klyme_de':_0x859a35(0x1e4),'mastercard':'MasterCard'};return _0x4b2a5e[_0x3ea17d]||_0x3ea17d;}async[a49_0x339e7e(0x208)](_0x176147,_0x5eb801){const _0x25e849=a49_0x339e7e;if(!(0x0,gateway_1[_0x25e849(0x158)])(_0x5eb801[_0x25e849(0x1ba)]))throw new Error(_0x25e849(0x14f)+_0x5eb801[_0x25e849(0x1ba)]+'.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)');const _0x284cbb=(0x0,gateway_1['getGatewayNameById'])(_0x5eb801[_0x25e849(0x1ba)]);if(!_0x284cbb)throw new Error(_0x25e849(0x1b0)+_0x5eb801['gateway']);console[_0x25e849(0x1b2)]('🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20'+_0x284cbb),await this[_0x25e849(0x1ef)](_0x176147,_0x284cbb);if(_0x284cbb===_0x25e849(0x1bb)&&!_0x5eb801[_0x25e849(0x1ff)])throw new Error(_0x25e849(0x18f));if(_0x284cbb[_0x25e849(0x19c)](_0x25e849(0x1d7))){const _0x21b2cd=(0x0,gateway_1[_0x25e849(0x21c)])(_0x284cbb);console[_0x25e849(0x1b2)](_0x25e849(0x164)+_0x21b2cd+_0x25e849(0x12d));}let _0x184ed3=_0x5eb801['country'];_0x284cbb===_0x25e849(0x218)&&(_0x184ed3='GB',console['log']('🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link'));if(!_0x5eb801[_0x25e849(0x1e6)]||_0x5eb801['amount']<=0x0)throw new Error(_0x25e849(0x1bf));let _0x32b664=_0x5eb801[_0x25e849(0x12a)]||_0x25e849(0x15c);_0x284cbb===_0x25e849(0x1b3)&&(_0x32b664=_0x25e849(0x16c),console[_0x25e849(0x1b2)](_0x25e849(0x1ae)));this[_0x25e849(0x1d6)](_0x284cbb,_0x32b664),await this[_0x25e849(0x212)](_0x176147,_0x284cbb,_0x5eb801['amount'],_0x32b664);const _0xf8e52a=_0x5eb801[_0x25e849(0x149)]||_0x25e849(0x1ea);console[_0x25e849(0x1b2)](_0x25e849(0x124)+_0xf8e52a+'\x20payment\x20link');const _0x3002ee=await database_1[_0x25e849(0x1a0)]['paymentLink'][_0x25e849(0x137)]({'data':{'shopId':_0x176147,'amount':_0x5eb801[_0x25e849(0x1e6)],'currency':_0x32b664,'sourceCurrency':_0x5eb801[_0x25e849(0x1ff)]||undefined,'gateway':_0x284cbb,'type':_0xf8e52a,'currentPayments':0x0,'status':_0x25e849(0x144),'expiresAt':_0x5eb801[_0x25e849(0x1db)]?new Date(_0x5eb801['expiresAt']):undefined,'successUrl':_0x5eb801[_0x25e849(0x15f)]||null,'failUrl':_0x5eb801[_0x25e849(0x20c)]||null,'pendingUrl':_0x5eb801['pendingUrl']||null,'country':_0x184ed3,'language':_0x5eb801[_0x25e849(0x1fb)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console['log'](_0x25e849(0x183)+_0x3002ee['id']+'\x20('+_0x284cbb+')'),console['log'](_0x25e849(0x1f4)+_0x3002ee[_0x25e849(0x1e6)]+'\x20'+_0x3002ee['currency']),console[_0x25e849(0x1b2)](_0x25e849(0x14c)+_0x3002ee[_0x25e849(0x149)]),console['log']('🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/'+_0x3002ee['id']),console[_0x25e849(0x1b2)](_0x25e849(0x1de)),this[_0x25e849(0x128)](_0x3002ee);}async[a49_0x339e7e(0x139)](_0x4e9767,_0x1bd8e4){const _0x2a90e5=a49_0x339e7e,{page:_0x4fba48,limit:_0x3f5438,status:_0x558429,gateway:_0x2bf8b3,search:_0xe6cf7b}=_0x1bd8e4,_0x102b78=(_0x4fba48-0x1)*_0x3f5438,_0x433655={'shopId':_0x4e9767};_0x558429&&(_0x433655['status']=_0x558429[_0x2a90e5(0x196)]());if(_0x2bf8b3){if((0x0,gateway_1[_0x2a90e5(0x158)])(_0x2bf8b3)){const _0x573087=(0x0,gateway_1[_0x2a90e5(0x1cb)])(_0x2bf8b3);_0x573087&&(_0x433655[_0x2a90e5(0x1ba)]=_0x573087);}else _0x433655[_0x2a90e5(0x1ba)]=_0x2bf8b3[_0x2a90e5(0x126)]();}_0xe6cf7b&&(_0x433655['OR']=[{'gateway':{'contains':_0xe6cf7b,'mode':_0x2a90e5(0x204)}},{'currency':{'contains':_0xe6cf7b,'mode':'insensitive'}}]);const [_0xbb602f,_0x2e4af7]=await Promise[_0x2a90e5(0x178)]([database_1[_0x2a90e5(0x1a0)]['paymentLink'][_0x2a90e5(0x18a)]({'where':_0x433655,'skip':_0x102b78,'take':_0x3f5438,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x2a90e5(0x162)},'take':0xa}}}),database_1[_0x2a90e5(0x1a0)]['paymentLink'][_0x2a90e5(0x155)]({'where':_0x433655})]);return{'links':_0xbb602f[_0x2a90e5(0x12b)](_0x4eaf38=>this[_0x2a90e5(0x128)](_0x4eaf38)),'pagination':{'page':_0x4fba48,'limit':_0x3f5438,'total':_0x2e4af7,'totalPages':Math[_0x2a90e5(0x223)](_0x2e4af7/_0x3f5438)}};}async['getPaymentLinkById'](_0x4f3180,_0x582895){const _0x36b024=a49_0x339e7e,_0x563e94=await database_1[_0x36b024(0x1a0)][_0x36b024(0x12c)][_0x36b024(0x1b7)]({'where':{'id':_0x582895,'shopId':_0x4f3180},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'}}}});if(!_0x563e94)return null;return this[_0x36b024(0x128)](_0x563e94);}async[a49_0x339e7e(0x17e)](_0x4434d2,_0x2615c2,_0x2116ba){const _0x4f2446=a49_0x339e7e,_0x1c1488={..._0x2116ba};if(_0x2116ba['gateway']){if((0x0,gateway_1[_0x4f2446(0x158)])(_0x2116ba[_0x4f2446(0x1ba)])){const _0x1064e8=(0x0,gateway_1[_0x4f2446(0x1cb)])(_0x2116ba['gateway']);_0x1064e8&&(await this['checkGatewayPermission'](_0x4434d2,_0x1064e8),_0x1c1488[_0x4f2446(0x1ba)]=_0x1064e8);}else _0x1c1488[_0x4f2446(0x1ba)]=_0x2116ba[_0x4f2446(0x1ba)][_0x4f2446(0x126)]();}(_0x1c1488[_0x4f2446(0x1ba)]===_0x4f2446(0x218)||_0x2116ba[_0x4f2446(0x16d)]&&_0x1c1488[_0x4f2446(0x1ba)]!==_0x4f2446(0x218))&&(_0x1c1488['gateway']===_0x4f2446(0x218)&&(_0x1c1488[_0x4f2446(0x16d)]='GB',console[_0x4f2446(0x1b2)](_0x4f2446(0x16e))));_0x1c1488['gateway']===_0x4f2446(0x1b3)&&(_0x1c1488['currency']=_0x4f2446(0x16c),console['log'](_0x4f2446(0x1aa)));_0x1c1488[_0x4f2446(0x1ba)]&&_0x1c1488['currency']&&this['validateKlymeCurrency'](_0x1c1488[_0x4f2446(0x1ba)],_0x1c1488[_0x4f2446(0x12a)]);if(_0x2116ba[_0x4f2446(0x1e6)]&&_0x1c1488[_0x4f2446(0x1ba)]){const _0x1c46c3=_0x2116ba['currency']||_0x4f2446(0x15c);await this['checkAmountLimits'](_0x4434d2,_0x1c1488[_0x4f2446(0x1ba)],_0x2116ba['amount'],_0x1c46c3);}_0x2116ba['expiresAt']&&(_0x1c1488[_0x4f2446(0x1db)]=new Date(_0x2116ba[_0x4f2446(0x1db)]));const _0x5351a0=await database_1['default']['paymentLink']['update']({'where':{'id':_0x2615c2,'shopId':_0x4434d2},'data':_0x1c1488,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x4f2446(0x162)},'take':0xa}}});return this[_0x4f2446(0x128)](_0x5351a0);}async[a49_0x339e7e(0x199)](_0x5e67c7,_0x2bf38a){const _0x3f749e=a49_0x339e7e;await database_1['default']['paymentLink'][_0x3f749e(0x14e)]({'where':{'id':_0x2bf38a,'shopId':_0x5e67c7}});}async[a49_0x339e7e(0x1f1)](_0x5a8903){const _0x3de560=a49_0x339e7e,_0x3f1366=await database_1[_0x3de560(0x1a0)][_0x3de560(0x12c)]['findUnique']({'where':{'id':_0x5a8903},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x3f1366)return null;const _0x81e1a3=_0x3f1366[_0x3de560(0x1db)]&&_0x3f1366['expiresAt']<new Date(),_0x422829=_0x3f1366['type']===_0x3de560(0x1ea)?_0x3f1366[_0x3de560(0x1da)]>=0x1:![],_0x204d70=_0x3f1366[_0x3de560(0x1e7)][_0x3de560(0x129)]===_0x3de560(0x144),_0x4cefb1=_0x3f1366[_0x3de560(0x129)]===_0x3de560(0x144),_0xdd8ecc=!_0x81e1a3&&!_0x422829&&_0x204d70&&_0x4cefb1,_0x1900c9=_0x3f1366[_0x3de560(0x149)]==='SINGLE'?_0x3f1366[_0x3de560(0x1da)]>=0x1?0x0:0x1:Number[_0x3de560(0x148)];return{'id':_0x3f1366['id'],'amount':_0x3f1366[_0x3de560(0x1e6)],'currency':_0x3f1366['currency'],'sourceCurrency':_0x3f1366['sourceCurrency']||undefined,'gateway':_0x3f1366[_0x3de560(0x1ba)],'type':_0x3f1366[_0x3de560(0x149)],'currentPayments':_0x3f1366[_0x3de560(0x1da)],'status':_0x3f1366[_0x3de560(0x129)],'expiresAt':_0x3f1366['expiresAt']||undefined,'shopName':_0x3f1366[_0x3de560(0x1e7)]['name'],'isAvailable':_0xdd8ecc,'remainingPayments':_0x1900c9};}async['initiatePaymentFromLink'](_0x1ff826){const _0x1395ba=a49_0x339e7e,{linkId:_0x4026de,customerEmail:_0x4fb101,customerName:_0x4ec4dc}=_0x1ff826,_0x13d0c4=await database_1['default'][_0x1395ba(0x12c)][_0x1395ba(0x19f)]({'where':{'id':_0x4026de},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x13d0c4)throw new Error('Payment\x20link\x20not\x20found');const _0x192b95=_0x13d0c4['expiresAt']&&_0x13d0c4[_0x1395ba(0x1db)]<new Date(),_0x41f9b5=_0x13d0c4[_0x1395ba(0x149)]===_0x1395ba(0x1ea)?_0x13d0c4[_0x1395ba(0x1da)]>=0x1:![],_0x25e4c7=_0x13d0c4[_0x1395ba(0x1e7)][_0x1395ba(0x129)]==='ACTIVE',_0x238ec9=_0x13d0c4[_0x1395ba(0x129)]===_0x1395ba(0x144);if(_0x192b95)throw new Error(_0x1395ba(0x1b9));if(_0x41f9b5){const _0x122a9f=_0x13d0c4[_0x1395ba(0x149)]===_0x1395ba(0x1ea)?'This\x20single-use\x20payment\x20link\x20has\x20already\x20been\x20used':_0x1395ba(0x1c1);throw new Error(_0x122a9f);}if(!_0x25e4c7)throw new Error(_0x1395ba(0x1a1));if(!_0x238ec9)throw new Error(_0x1395ba(0x18e));await this['checkGatewayPermission'](_0x13d0c4[_0x1395ba(0x1d3)],_0x13d0c4['gateway']);const _0x35e1bc=_0x13d0c4[_0x1395ba(0x1e6)];console['log'](_0x1395ba(0x19a)+_0x13d0c4['type']+'\x20link\x20'+_0x4026de+':\x20'+_0x35e1bc+'\x20'+_0x13d0c4[_0x1395ba(0x12a)]),console[_0x1395ba(0x1b2)](_0x1395ba(0x1f0)+(_0x4ec4dc||_0x1395ba(0x1ee))+'\x20('+(_0x4fb101||_0x1395ba(0x1d1))+')'),this['validateKlymeCurrency'](_0x13d0c4[_0x1395ba(0x1ba)],_0x13d0c4[_0x1395ba(0x12a)]),await this['checkAmountLimits'](_0x13d0c4[_0x1395ba(0x1d3)],_0x13d0c4[_0x1395ba(0x1ba)],_0x35e1bc,_0x13d0c4[_0x1395ba(0x12a)]);const _0x50a488=this[_0x1395ba(0x20e)]();console[_0x1395ba(0x1b2)](_0x1395ba(0x21f)+_0x50a488+'\x20(8digits-8digits\x20format\x20for\x20'+_0x13d0c4[_0x1395ba(0x1ba)]+')');const _0x401291=await database_1[_0x1395ba(0x1a0)]['payment'][_0x1395ba(0x137)]({'data':{'shopId':_0x13d0c4['shopId'],'paymentLinkId':_0x13d0c4['id'],'gateway':_0x13d0c4[_0x1395ba(0x1ba)],'amount':_0x35e1bc,'currency':_0x13d0c4[_0x1395ba(0x12a)],'sourceCurrency':_0x13d0c4[_0x1395ba(0x1ff)]||undefined,'usage':_0x1395ba(0x147),'expiresAt':_0x13d0c4[_0x1395ba(0x1db)]||undefined,'successUrl':_0x1395ba(0x213),'failUrl':_0x1395ba(0x213),'pendingUrl':_0x1395ba(0x213),'whiteUrl':'temp','status':'PENDING','orderId':null,'gatewayOrderId':_0x50a488,'customerEmail':_0x4fb101||undefined,'customerName':_0x4ec4dc||undefined,'country':_0x13d0c4[_0x1395ba(0x16d)]||undefined,'language':_0x13d0c4[_0x1395ba(0x1fb)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x1395ba(0x1b2)](_0x1395ba(0x207)+_0x401291['id']);const _0xd56185=process[_0x1395ba(0x151)][_0x1395ba(0x141)]||'https://tesoft.uk',{finalSuccessUrl:_0x1c363d,finalFailUrl:_0x5a5820,finalPendingUrl:_0xd404ad,dbSuccessUrl:_0x31e70d,dbFailUrl:_0x2bd1dd,dbPendingUrl:_0x2fe3f9,whiteUrl:_0x2e7ffc}=this[_0x1395ba(0x1fd)](_0x13d0c4[_0x1395ba(0x1ba)],_0x401291['id'],_0x50a488,_0xd56185,_0x13d0c4[_0x1395ba(0x15f)]||undefined,_0x13d0c4['failUrl']||undefined,_0x13d0c4[_0x1395ba(0x1e3)]||undefined);await database_1['default'][_0x1395ba(0x1c8)][_0x1395ba(0x16b)]({'where':{'id':_0x401291['id']},'data':{'successUrl':_0x31e70d,'failUrl':_0x2bd1dd,'pendingUrl':_0x2fe3f9,'whiteUrl':_0x2e7ffc}}),console[_0x1395ba(0x1b2)](_0x1395ba(0x21d)+_0x35e1bc+'\x20'+_0x13d0c4[_0x1395ba(0x12a)]),console[_0x1395ba(0x1b2)]('👤\x20Customer:\x20'+(_0x4ec4dc||_0x1395ba(0x1ee))+'\x20('+(_0x4fb101||_0x1395ba(0x1d1))+')'),console[_0x1395ba(0x1b2)](_0x1395ba(0x200)+_0x31e70d),console[_0x1395ba(0x1b2)](_0x1395ba(0x1a3)+_0x2bd1dd),console['log'](_0x1395ba(0x157)+_0x2fe3f9),console['log']('🔗\x20White\x20URL:\x20'+(_0x2e7ffc||'none'));let _0x345577,_0x2749e2;try{if(_0x13d0c4['gateway']===_0x1395ba(0x1bb)){console[_0x1395ba(0x1b2)](_0x1395ba(0x1b1)),console['log'](_0x1395ba(0x1e9)+_0x13d0c4[_0x1395ba(0x12a)]),console[_0x1395ba(0x1b2)]('\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20'+_0x13d0c4[_0x1395ba(0x1ff)]);const _0x1222d5=await this[_0x1395ba(0x145)][_0x1395ba(0x131)]({'paymentId':_0x401291['id'],'orderId':_0x50a488,'amount':_0x35e1bc,'currency':_0x13d0c4[_0x1395ba(0x12a)],'productName':_0x1395ba(0x206)+_0x35e1bc+'\x20'+_0x13d0c4[_0x1395ba(0x12a)],'description':_0x1395ba(0x206)+_0x35e1bc+'\x20'+_0x13d0c4['currency'],'successUrl':_0x1c363d,'failUrl':_0x5a5820,'customerEmail':_0x4fb101||undefined,'customerName':_0x4ec4dc||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x13d0c4['sourceCurrency']||undefined});_0x345577=_0x1222d5[_0x1395ba(0x12f)],_0x2749e2=_0x1222d5['payment_url'],await database_1[_0x1395ba(0x1a0)][_0x1395ba(0x1c8)][_0x1395ba(0x16b)]({'where':{'id':_0x401291['id']},'data':{'externalPaymentUrl':_0x2749e2,'gatewayPaymentId':_0x345577,'invoiceTotalSum':Number(_0x1222d5[_0x1395ba(0x1bc)]),'qrCode':_0x1222d5[_0x1395ba(0x1f5)],'qrUrl':_0x1222d5['qr_url']}});const _0x5a11d7='https://app.trapay.uk/payment/'+_0x401291['id'];return console[_0x1395ba(0x1b2)](_0x1395ba(0x21a)+_0x5a11d7),{'paymentId':_0x401291['id'],'paymentUrl':_0x5a11d7,'expiresAt':_0x401291['expiresAt']||undefined};}else{if(_0x13d0c4[_0x1395ba(0x1ba)]===_0x1395ba(0x218)){const _0x133d46=await this[_0x1395ba(0x1eb)]['createPaymentLink']({'paymentId':_0x401291['id'],'orderId':_0x50a488,'orderName':_0x1395ba(0x206)+_0x35e1bc+'\x20'+_0x13d0c4[_0x1395ba(0x12a)],'amount':_0x35e1bc,'currency':_0x13d0c4[_0x1395ba(0x12a)],'country':_0x13d0c4[_0x1395ba(0x16d)],'language':_0x13d0c4[_0x1395ba(0x1fb)]||'EN','amountIsEditable':![],'usage':_0x1395ba(0x147),'maxPayments':0x1,'successUrl':_0x1c363d,'failUrl':_0x5a5820});_0x345577=_0x133d46[_0x1395ba(0x12f)],_0x2749e2=_0x133d46[_0x1395ba(0x1ec)],await database_1[_0x1395ba(0x1a0)]['payment'][_0x1395ba(0x16b)]({'where':{'id':_0x401291['id']},'data':{'externalPaymentUrl':_0x2749e2,'gatewayPaymentId':_0x345577}});const _0x11e878=_0x1395ba(0x143)+_0x401291['id'];return console[_0x1395ba(0x1b2)](_0x1395ba(0x1f3)+_0x11e878),{'paymentId':_0x401291['id'],'paymentUrl':_0x11e878,'expiresAt':_0x401291[_0x1395ba(0x1db)]||undefined};}else{if(_0x13d0c4[_0x1395ba(0x1ba)]===_0x1395ba(0x1d8)){const _0x48fbf1=await this[_0x1395ba(0x1c5)]['createPaymentLink']({'paymentId':_0x401291['id'],'orderId':_0x50a488,'name':_0x1395ba(0x206)+_0x35e1bc+'\x20'+_0x13d0c4[_0x1395ba(0x12a)],'paymentDescription':_0x1395ba(0x206)+_0x35e1bc+'\x20'+_0x13d0c4[_0x1395ba(0x12a)],'amount':_0x35e1bc,'currency':_0x13d0c4[_0x1395ba(0x12a)],'webhookUrl':_0x1395ba(0x203),'returnUrl':_0xd404ad,'expiryDate':_0x13d0c4[_0x1395ba(0x1db)]?.['toISOString']()});_0x345577=_0x48fbf1[_0x1395ba(0x12f)],_0x2749e2=_0x48fbf1[_0x1395ba(0x1ec)],await database_1[_0x1395ba(0x1a0)]['payment'][_0x1395ba(0x16b)]({'where':{'id':_0x401291['id']},'data':{'externalPaymentUrl':_0x2749e2,'gatewayPaymentId':_0x345577,'qrUrl':_0x48fbf1['qr_code_url']}});const _0x50ed94=_0x1395ba(0x143)+_0x401291['id'];return console[_0x1395ba(0x1b2)](_0x1395ba(0x189)+_0x50ed94),{'paymentId':_0x401291['id'],'paymentUrl':_0x50ed94,'expiresAt':_0x401291[_0x1395ba(0x1db)]||undefined};}else{if(_0x13d0c4[_0x1395ba(0x1ba)]===_0x1395ba(0x1b3)){console[_0x1395ba(0x1b2)]('🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x50a488+_0x1395ba(0x19d)),console[_0x1395ba(0x1b2)](_0x1395ba(0x21d)+_0x35e1bc+_0x1395ba(0x1f7));const _0x3f24d9=await this[_0x1395ba(0x1c7)][_0x1395ba(0x208)]({'paymentId':_0x401291['id'],'orderId':_0x50a488,'amount':_0x35e1bc});_0x345577=_0x3f24d9['gateway_payment_id'],_0x2749e2=_0x3f24d9[_0x1395ba(0x1ec)],await database_1[_0x1395ba(0x1a0)]['payment']['update']({'where':{'id':_0x401291['id']},'data':{'externalPaymentUrl':_0x2749e2,'gatewayPaymentId':_0x345577}});_0x345577&&(console[_0x1395ba(0x1b2)](_0x1395ba(0x13b)+_0x401291['id']+'\x20('+_0x345577+')'),coinToPayStatusService_1[_0x1395ba(0x14b)][_0x1395ba(0x1cd)](_0x401291['id'],_0x345577));const _0x4fcca4=_0x1395ba(0x143)+_0x401291['id'];return console[_0x1395ba(0x1b2)](_0x1395ba(0x179)+_0x4fcca4),{'paymentId':_0x401291['id'],'paymentUrl':_0x4fcca4,'expiresAt':_0x401291[_0x1395ba(0x1db)]||undefined};}else{if(_0x13d0c4[_0x1395ba(0x1ba)][_0x1395ba(0x19c)](_0x1395ba(0x1d7))){const _0x52aeef=(0x0,gateway_1[_0x1395ba(0x21c)])(_0x13d0c4[_0x1395ba(0x1ba)]);if(!_0x52aeef)throw new Error('Invalid\x20KLYME\x20gateway:\x20'+_0x13d0c4[_0x1395ba(0x1ba)]);console[_0x1395ba(0x1b2)](_0x1395ba(0x164)+_0x52aeef+_0x1395ba(0x168)+_0x50a488+_0x1395ba(0x19d)),console[_0x1395ba(0x1b2)](_0x1395ba(0x21d)+_0x35e1bc+'\x20'+_0x13d0c4[_0x1395ba(0x12a)]+'\x20(validated\x20for\x20'+_0x52aeef+')');const _0x57b461=await this[_0x1395ba(0x1b4)][_0x1395ba(0x208)]({'paymentId':_0x401291['id'],'orderId':_0x50a488,'amount':_0x35e1bc,'currency':_0x13d0c4['currency'],'region':_0x52aeef,'redirectUrl':_0xd404ad});_0x345577=_0x57b461[_0x1395ba(0x12f)],_0x2749e2=_0x57b461['payment_url'],await database_1['default'][_0x1395ba(0x1c8)][_0x1395ba(0x16b)]({'where':{'id':_0x401291['id']},'data':{'externalPaymentUrl':_0x2749e2,'gatewayPaymentId':_0x345577}});const _0x3ba334=_0x1395ba(0x143)+_0x401291['id'];return console[_0x1395ba(0x1b2)](_0x1395ba(0x188)+_0x52aeef+'\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20'+_0x50a488),console[_0x1395ba(0x1b2)]('🔗\x20KLYME\x20'+_0x52aeef+'\x20payment\x20URL:\x20'+_0x3ba334),{'paymentId':_0x401291['id'],'paymentUrl':_0x3ba334,'expiresAt':_0x401291[_0x1395ba(0x1db)]||undefined};}else{if(_0x13d0c4[_0x1395ba(0x1ba)]===_0x1395ba(0x1e0)){console[_0x1395ba(0x1b2)](_0x1395ba(0x167)+_0x50a488+'\x20(8digits-8digits\x20format)'),console[_0x1395ba(0x1b2)]('💰\x20Amount:\x20'+_0x35e1bc+'\x20'+_0x13d0c4[_0x1395ba(0x12a)]+_0x1395ba(0x216));const _0x23bcdc=_0x1395ba(0x15d)+_0x401291['id'];await database_1[_0x1395ba(0x1a0)][_0x1395ba(0x1c8)][_0x1395ba(0x16b)]({'where':{'id':_0x401291['id']},'data':{'externalPaymentUrl':_0x23bcdc,'gatewayPaymentId':'test_'+_0x50a488}});const _0x1cdb59=_0x1395ba(0x143)+_0x401291['id'];return console[_0x1395ba(0x1b2)](_0x1395ba(0x125)+_0x1cdb59),console[_0x1395ba(0x1b2)]('🧪\x20Test\x20Gateway\x20form\x20URL:\x20'+_0x23bcdc),{'paymentId':_0x401291['id'],'paymentUrl':_0x1cdb59,'expiresAt':_0x401291[_0x1395ba(0x1db)]||undefined};}else{if(_0x13d0c4[_0x1395ba(0x1ba)]===_0x1395ba(0x202)){console[_0x1395ba(0x1b2)](_0x1395ba(0x184)+_0x50a488+_0x1395ba(0x19d)),console['log']('💰\x20Amount:\x20'+_0x35e1bc+'\x20'+_0x13d0c4[_0x1395ba(0x12a)]+_0x1395ba(0x1d5));const _0xd9169=_0x1395ba(0x143)+_0x401291['id'];await database_1['default']['payment']['update']({'where':{'id':_0x401291['id']},'data':{'externalPaymentUrl':_0xd9169,'gatewayPaymentId':_0x1395ba(0x138)+_0x50a488,'paymentMethod':_0x1395ba(0x202)}});const _0x292321='https://app.trapay.uk/payment/'+_0x401291['id'];return console[_0x1395ba(0x1b2)](_0x1395ba(0x1a2)+_0x292321),console[_0x1395ba(0x1b2)](_0x1395ba(0x187)+_0xd9169),{'paymentId':_0x401291['id'],'paymentUrl':_0x292321,'expiresAt':_0x401291['expiresAt']||undefined};}else throw new Error(_0x1395ba(0x1ed)+_0x13d0c4[_0x1395ba(0x1ba)]);}}}}}}}catch(_0x21e9b4){await database_1[_0x1395ba(0x1a0)]['payment'][_0x1395ba(0x16b)]({'where':{'id':_0x401291['id']},'data':{'status':_0x1395ba(0x215)}});throw new Error('Gateway\x20error:\x20'+(_0x21e9b4 instanceof Error?_0x21e9b4[_0x1395ba(0x1a4)]:_0x1395ba(0x217)));}}async[a49_0x339e7e(0x205)](_0x985b3c){const _0x2113cc=a49_0x339e7e;console['log'](_0x2113cc(0x1f8)+_0x985b3c);const _0x3c1fb3=await database_1[_0x2113cc(0x1a0)][_0x2113cc(0x1c8)][_0x2113cc(0x19f)]({'where':{'id':_0x985b3c},'include':{'paymentLink':!![]}});if(!_0x3c1fb3||!_0x3c1fb3[_0x2113cc(0x12c)]){console['log'](_0x2113cc(0x1b8)+_0x985b3c+_0x2113cc(0x12e));return;}if(_0x3c1fb3[_0x2113cc(0x129)]!==_0x2113cc(0x20d)){console[_0x2113cc(0x1b2)](_0x2113cc(0x1b8)+_0x985b3c+_0x2113cc(0x219)+_0x3c1fb3[_0x2113cc(0x129)]+_0x2113cc(0x21e));return;}if(!_0x3c1fb3['paidAt']){console[_0x2113cc(0x1b2)](_0x2113cc(0x1b8)+_0x985b3c+_0x2113cc(0x16f));return;}try{const _0x228edd=await database_1['default'][_0x2113cc(0x18b)](async _0x125a1c=>{const _0x4d115a=_0x2113cc,_0x3dbb4b=await _0x125a1c['paymentLink']['findUnique']({'where':{'id':_0x3c1fb3[_0x4d115a(0x1d9)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(!_0x3dbb4b)throw new Error(_0x4d115a(0x130)+_0x3c1fb3[_0x4d115a(0x1d9)]+_0x4d115a(0x169));if(_0x3dbb4b[_0x4d115a(0x149)]===_0x4d115a(0x1ea)&&_0x3dbb4b[_0x4d115a(0x1da)]>=0x1)return console['log'](_0x4d115a(0x16a)+_0x3c1fb3[_0x4d115a(0x1d9)]+_0x4d115a(0x159)+_0x3dbb4b[_0x4d115a(0x1da)]+_0x4d115a(0x1a5)),_0x3dbb4b;const _0x524826=await _0x125a1c[_0x4d115a(0x1c8)][_0x4d115a(0x155)]({'where':{'paymentLinkId':_0x3c1fb3[_0x4d115a(0x1d9)],'status':_0x4d115a(0x20d),'paidAt':{'not':null},'id':{'not':_0x985b3c}}}),_0x3119ef=_0x524826+0x1,_0x2ac406=_0x3dbb4b[_0x4d115a(0x149)]===_0x4d115a(0x1ea)&&_0x3119ef>=0x1?_0x4d115a(0x1cc):_0x3dbb4b[_0x4d115a(0x129)],_0x2a7ed8=await _0x125a1c[_0x4d115a(0x12c)][_0x4d115a(0x16b)]({'where':{'id':_0x3c1fb3[_0x4d115a(0x1d9)]},'data':{'currentPayments':_0x3119ef,'status':_0x2ac406}});return console['log'](_0x4d115a(0x1bd)+_0x3c1fb3['paymentLinkId']+'\x20('+_0x3dbb4b[_0x4d115a(0x149)]+_0x4d115a(0x1c6)+_0x3dbb4b[_0x4d115a(0x1da)]+'\x20->\x20'+_0x3119ef),_0x2a7ed8;});if(_0x228edd[_0x2113cc(0x129)]===_0x2113cc(0x1cc)){const _0x3ff7a9=_0x228edd['type']===_0x2113cc(0x1ea)?_0x2113cc(0x161):'multi-use';console[_0x2113cc(0x1b2)](_0x2113cc(0x182)+_0x3c1fb3[_0x2113cc(0x1d9)]+'\x20completed\x20('+_0x3ff7a9+_0x2113cc(0x1ce)+_0x228edd['currentPayments']+_0x2113cc(0x1d2));}}catch(_0xbdf819){console['error']('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20'+_0x985b3c+':',_0xbdf819);}}async[a49_0x339e7e(0x17a)](_0x523802){const _0x20f814=a49_0x339e7e,[_0x18f459,_0x25cd14,_0x3e61e7,_0xdd57bb]=await Promise['all']([database_1[_0x20f814(0x1a0)][_0x20f814(0x12c)][_0x20f814(0x155)]({'where':{'shopId':_0x523802}}),database_1[_0x20f814(0x1a0)][_0x20f814(0x12c)][_0x20f814(0x155)]({'where':{'shopId':_0x523802,'status':'ACTIVE'}}),database_1[_0x20f814(0x1a0)][_0x20f814(0x1c8)][_0x20f814(0x155)]({'where':{'shopId':_0x523802,'paymentLinkId':{'not':null},'gateway':{'not':'test_gateway'}}}),database_1[_0x20f814(0x1a0)][_0x20f814(0x1c8)][_0x20f814(0x18a)]({'where':{'shopId':_0x523802,'paymentLinkId':{'not':null},'status':_0x20f814(0x20d),'gateway':{'not':_0x20f814(0x1e0)}},'select':{'amount':!![],'currency':!![]}})]);let _0x39f21f=0x0;for(const _0x53e4d2 of _0xdd57bb){const _0x2ecd0e=await currencyService_1[_0x20f814(0x133)][_0x20f814(0x142)](_0x53e4d2[_0x20f814(0x1e6)],_0x53e4d2[_0x20f814(0x12a)]);_0x39f21f+=_0x2ecd0e;}const _0x515bd2=_0x3e61e7>0x0?_0xdd57bb[_0x20f814(0x1dc)]/_0x3e61e7*0x64:0x0;return{'totalLinks':_0x18f459,'activeLinks':_0x25cd14,'totalPayments':_0x3e61e7,'totalRevenue':Math['round'](_0x39f21f*0x64)/0x64,'conversionRate':Math['round'](_0x515bd2*0x64)/0x64};}[a49_0x339e7e(0x128)](_0x42db00){const _0x278092=a49_0x339e7e;return{'id':_0x42db00['id'],'shopId':_0x42db00[_0x278092(0x1d3)],'amount':_0x42db00[_0x278092(0x1e6)],'currency':_0x42db00[_0x278092(0x12a)],'sourceCurrency':_0x42db00['sourceCurrency']||undefined,'gateway':_0x42db00['gateway'],'type':_0x42db00['type'],'currentPayments':_0x42db00['currentPayments'],'status':_0x42db00[_0x278092(0x129)],'expiresAt':_0x42db00[_0x278092(0x1db)]||undefined,'successUrl':_0x42db00['successUrl']||undefined,'failUrl':_0x42db00[_0x278092(0x20c)]||undefined,'pendingUrl':_0x42db00['pendingUrl']||undefined,'country':_0x42db00[_0x278092(0x16d)]||undefined,'language':_0x42db00[_0x278092(0x1fb)]||undefined,'linkUrl':_0x278092(0x1c9)+_0x42db00['id'],'createdAt':_0x42db00[_0x278092(0x197)],'updatedAt':_0x42db00[_0x278092(0x176)],'shop':_0x42db00[_0x278092(0x1e7)],'payments':_0x42db00[_0x278092(0x20b)]};}}exports[a49_0x339e7e(0x1a9)]=PaymentLinkService;