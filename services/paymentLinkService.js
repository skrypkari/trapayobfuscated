'use strict';const a45_0x28974c=a45_0x2afc;(function(_0x5e4aa6,_0x176ac8){const _0x3a230b=a45_0x2afc,_0x1f6ae8=_0x5e4aa6();while(!![]){try{const _0x518f76=-parseInt(_0x3a230b(0x228))/0x1*(parseInt(_0x3a230b(0x243))/0x2)+-parseInt(_0x3a230b(0x1bb))/0x3+parseInt(_0x3a230b(0x234))/0x4+-parseInt(_0x3a230b(0x1f0))/0x5+parseInt(_0x3a230b(0x239))/0x6*(-parseInt(_0x3a230b(0x232))/0x7)+-parseInt(_0x3a230b(0x23f))/0x8+-parseInt(_0x3a230b(0x23a))/0x9*(-parseInt(_0x3a230b(0x1cc))/0xa);if(_0x518f76===_0x176ac8)break;else _0x1f6ae8['push'](_0x1f6ae8['shift']());}catch(_0x4702c7){_0x1f6ae8['push'](_0x1f6ae8['shift']());}}}(a45_0x33ee,0x7fdc0));function a45_0x2afc(_0x1ae039,_0x3ea5bb){const _0x33ee75=a45_0x33ee();return a45_0x2afc=function(_0x2afcbc,_0x391ae1){_0x2afcbc=_0x2afcbc-0x1b7;let _0x2a3eb4=_0x33ee75[_0x2afcbc];return _0x2a3eb4;},a45_0x2afc(_0x1ae039,_0x3ea5bb);}var __importDefault=this&&this['__importDefault']||function(_0x38af5d){const _0xeb80ae=a45_0x2afc;return _0x38af5d&&_0x38af5d[_0xeb80ae(0x21d)]?_0x38af5d:{'default':_0x38af5d};};function a45_0x33ee(){const _0x52839c=['deletePaymentLink','invoice_total_sum','klymeService','findUnique','‚ùå\x20DB\x20Fail\x20URL:\x20','https://app.trapay.uk/payment/pending','gateway_payment_id','NodaService','shop','nodaService','map','üîó\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','convertToUSDT','Payment\x20link\x20has\x20reached\x20maximum\x20payments','Gateway\x20not\x20found\x20for\x20ID:\x20','./gateways/nodaService','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','./gateways/rapydService','paymentLink','RapydService','Payment\x20link\x20is\x20not\x20active','üíæ\x20Payment\x20created\x20from\x20link:\x20','754530PzJNCH','status','ü™ô\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','https://tesoft.uk/gateway/payment.php?id=','noda','no\x20email','amount','getKlymeRegionFromGatewayName','coinToPayService','Unsupported\x20KLYME\x20region:\x20','PaymentLinkService','‚úÖ\x20Payment\x20link\x20created:\x20','Payment\x20','ACTIVE','currentPayments','Invalid\x20gateway\x20ID:\x20','\x20(8digits-8digits\x20format)','726870lwobKp','expiresAt','toUpperCase','./gateways/klymeService','currencyService','all','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','https://tesoft.uk','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','getPublicPaymentLinkData','getGatewayNameById','/gateway/pending.php?id=','üîó\x20CoinToPay\x20payment\x20URL:\x20','updatePaymentLink','Gateway\x20error:\x20','startsWith','paymentLinkId','initiatePaymentFromLink','\x20\x20\x20üíæ\x20DB\x20Fail\x20URL:\x20','findMany','count','../config/database','rapydService','Shop\x20is\x20not\x20active','floor','qr_code_url','Invalid\x20KLYME\x20gateway:\x20','payment','\x20completed\x20(reached\x20max\x20payments)','max','isValidGatewayId','createdAt','ONCE','Payment\x20link\x20has\x20expired','üîó\x20KLYME\x20','üá¨üáß\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','2378515qOYUtU','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','ü™ô\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','payment_url','rapyd','https://app.trapay.uk/link/','üîó\x20Noda\x20payment\x20URL:\x20','üë§\x20Customer:\x20','PENDING','delete','log','https://tesoft.uk/gateways/noda/webhook','maxPayments','‚úÖ\x20KLYME\x20','handleSuccessfulPayment','PlisioService','üí≥\x20Initiating\x20payment\x20from\x20link\x20','ü™ô\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','./currencyService','language','cointopay','üìà\x20Payment\x20link\x20','üí∞\x20Amount:\x20','üíæ\x20DB\x20Success\x20URL:\x20','EUR','generateGatewayUrls','shopId','round','gateway','formatPaymentLinkResponse','üèÅ\x20Payment\x20link\x20','PAID','default','padStart','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x20payments:\x20','create','üîó\x20Rapyd\x20payment\x20URL:\x20','klyme_','üîó\x20Plisio\x20payment\x20URL:\x20','sourceCurrency','name','BASE_URL','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','createPaymentLink','__esModule','successUrl','üîó\x20Link\x20URL:\x20https://app.trapay.uk/link/','/gateway/fail.php?id=','random','plisioService','üí∞\x20Fixed\x20amount:\x20','./gateways/plisioService','../types/gateway','üí≥\x20Creating\x20KLYME\x20','update','61599VDsOOD','ceil','env','toISOString','desc','findFirst','currency','defineProperty','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','7vMCKbR','country','2297404cXHICL','toLowerCase','‚úÖ\x20DB\x20Success\x20URL:\x20','getPaymentLinkById','insensitive','2538294qaozXN','279ySGWpU','generateGatewayOrderId','validateKlymeCurrency','failUrl','\x20payment\x20URL:\x20','8243808AIbabL','GBP','createPayment','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','4GyrzCS','Anonymous'];a45_0x33ee=function(){return _0x52839c;};return a45_0x33ee();}Object[a45_0x28974c(0x22f)](exports,a45_0x28974c(0x21d),{'value':!![]}),exports[a45_0x28974c(0x1c5)]=void 0x0;const database_1=__importDefault(require(a45_0x28974c(0x1e1))),plisioService_1=require(a45_0x28974c(0x224)),rapydService_1=require(a45_0x28974c(0x257)),nodaService_1=require(a45_0x28974c(0x254)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require(a45_0x28974c(0x1cf)),gateway_1=require(a45_0x28974c(0x225)),currencyService_1=require(a45_0x28974c(0x202));class PaymentLinkService{constructor(){const _0x526660=a45_0x28974c;this[_0x526660(0x222)]=new plisioService_1[(_0x526660(0x1ff))](),this[_0x526660(0x1e2)]=new rapydService_1[(_0x526660(0x1b8))](),this[_0x526660(0x24e)]=new nodaService_1[(_0x526660(0x24c))](),this[_0x526660(0x1c3)]=new coinToPayService_1['CoinToPayService'](),this[_0x526660(0x247)]=new klymeService_1['KlymeService']();}[a45_0x28974c(0x23b)](){const _0x2fb57e=()=>{const _0x1a9b37=a45_0x2afc;return Math[_0x1a9b37(0x1e4)](Math[_0x1a9b37(0x221)]()*0x5f5e100)['toString']()[_0x1a9b37(0x211)](0x8,'0');};return _0x2fb57e()+'-'+_0x2fb57e();}['generateGatewayUrls'](_0x3d0cc9,_0xd2e7ba,_0x4dc5f2,_0x5dbc86,_0x2c0dcd){const _0x15d10c=a45_0x28974c;if(_0x5dbc86&&_0x2c0dcd)return{'finalSuccessUrl':_0x5dbc86,'finalFailUrl':_0x2c0dcd,'dbSuccessUrl':_0x5dbc86,'dbFailUrl':_0x2c0dcd};let _0x2842db,_0x15f23d,_0x5a1588,_0xe9a9b2;return _0x3d0cc9===_0x15d10c(0x1bf)||_0x3d0cc9[_0x15d10c(0x1db)]('klyme_')?(_0x2842db=_0x4dc5f2+_0x15d10c(0x1d7)+_0xd2e7ba,_0x5a1588=_0x15d10c(0x24a)):(_0x2842db=_0x4dc5f2+'/gateway/success.php?id='+_0xd2e7ba,_0x5a1588='https://app.trapay.uk/payment/success'),_0x15f23d=_0x4dc5f2+_0x15d10c(0x220)+_0xd2e7ba,_0xe9a9b2='https://app.trapay.uk/payment/fail',console[_0x15d10c(0x1fa)]('üîó\x20Generated\x20URLs\x20for\x20'+_0x3d0cc9+':'),console['log']('\x20\x20\x20üåê\x20Gateway\x20Success\x20URL:\x20'+_0x2842db),console[_0x15d10c(0x1fa)]('\x20\x20\x20üåê\x20Gateway\x20Fail\x20URL:\x20'+_0x15f23d),console['log']('\x20\x20\x20üíæ\x20DB\x20Success\x20URL:\x20'+_0x5a1588),console[_0x15d10c(0x1fa)](_0x15d10c(0x1de)+_0xe9a9b2),{'finalSuccessUrl':_0x2842db,'finalFailUrl':_0x15f23d,'dbSuccessUrl':_0x5a1588,'dbFailUrl':_0xe9a9b2};}[a45_0x28974c(0x23c)](_0x2a2104,_0xc4ddc2){const _0x51ad42=a45_0x28974c;if(!_0x2a2104[_0x51ad42(0x1db)](_0x51ad42(0x216)))return;const _0x20082c=(0x0,gateway_1[_0x51ad42(0x1c2)])(_0x2a2104),_0x15494e=_0xc4ddc2[_0x51ad42(0x1ce)]();switch(_0x20082c){case'EU':if(_0x15494e!=='EUR')throw new Error(_0x51ad42(0x255)+_0x15494e);break;case'GB':if(_0x15494e!==_0x51ad42(0x240))throw new Error(_0x51ad42(0x231)+_0x15494e);break;case'DE':if(_0x15494e!==_0x51ad42(0x208))throw new Error(_0x51ad42(0x212)+_0x15494e);break;default:throw new Error(_0x51ad42(0x1c4)+_0x20082c);}}async[a45_0x28974c(0x21c)](_0x5de218,_0xdc135){const _0x321647=a45_0x28974c;if(!(0x0,gateway_1[_0x321647(0x1ea)])(_0xdc135[_0x321647(0x20c)]))throw new Error(_0x321647(0x1ca)+_0xdc135[_0x321647(0x20c)]+_0x321647(0x242));const _0x28ca9a=(0x0,gateway_1[_0x321647(0x1d6)])(_0xdc135[_0x321647(0x20c)]);if(!_0x28ca9a)throw new Error(_0x321647(0x253)+_0xdc135[_0x321647(0x20c)]);console[_0x321647(0x1fa)](_0x321647(0x250)+_0x28ca9a);if(_0x28ca9a==='plisio'&&!_0xdc135[_0x321647(0x218)])throw new Error(_0x321647(0x1d4));if(_0x28ca9a['startsWith']('klyme_')){const _0x281aed=(0x0,gateway_1[_0x321647(0x1c2)])(_0x28ca9a);console['log'](_0x321647(0x226)+_0x281aed+'\x20payment\x20link');}let _0x19e861=_0xdc135[_0x321647(0x233)];_0x28ca9a==='rapyd'&&(_0x19e861='GB',console['log'](_0x321647(0x1ef)));if(!_0xdc135[_0x321647(0x1c1)]||_0xdc135[_0x321647(0x1c1)]<=0x0)throw new Error('amount\x20is\x20required\x20and\x20must\x20be\x20positive');let _0xc12f99=_0xdc135['currency']||'USD';_0x28ca9a==='cointopay'&&(_0xc12f99='EUR',console[_0x321647(0x1fa)](_0x321647(0x201)));this[_0x321647(0x23c)](_0x28ca9a,_0xc12f99);const _0x3e4208=process[_0x321647(0x22a)][_0x321647(0x21a)]||_0x321647(0x1d3),{finalSuccessUrl:_0xaeaa43,finalFailUrl:_0x8748f4,dbSuccessUrl:_0x113724,dbFailUrl:_0x2b4869}=this['generateGatewayUrls'](_0x28ca9a,'PLACEHOLDER',_0x3e4208,_0xdc135['successUrl'],_0xdc135[_0x321647(0x23d)]),_0x2ef498=await database_1[_0x321647(0x210)][_0x321647(0x1b7)][_0x321647(0x214)]({'data':{'shopId':_0x5de218,'amount':_0xdc135[_0x321647(0x1c1)],'currency':_0xc12f99,'sourceCurrency':_0xdc135['sourceCurrency']||undefined,'gateway':_0x28ca9a,'maxPayments':_0xdc135[_0x321647(0x1fc)]||0x1,'currentPayments':0x0,'status':_0x321647(0x1c8),'expiresAt':_0xdc135[_0x321647(0x1cd)]?new Date(_0xdc135['expiresAt']):undefined,'successUrl':_0x113724,'failUrl':_0x2b4869,'country':_0x19e861,'language':_0xdc135[_0x321647(0x203)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x321647(0x1fa)](_0x321647(0x1c6)+_0x2ef498['id']+'\x20('+_0x28ca9a+')'),console[_0x321647(0x1fa)](_0x321647(0x223)+_0x2ef498[_0x321647(0x1c1)]+'\x20'+_0x2ef498[_0x321647(0x22e)]),console[_0x321647(0x1fa)](_0x321647(0x21f)+_0x2ef498['id']),console[_0x321647(0x1fa)](_0x321647(0x236)+_0x2ef498[_0x321647(0x21e)]),console[_0x321647(0x1fa)](_0x321647(0x249)+_0x2ef498[_0x321647(0x23d)]),this[_0x321647(0x20d)](_0x2ef498);}async['getPaymentLinks'](_0x344e04,_0x450618){const _0x466bda=a45_0x28974c,{page:_0xa2374,limit:_0x350ad1,status:_0x361557,gateway:_0x294742,search:_0x42f1c0}=_0x450618,_0x5852fa=(_0xa2374-0x1)*_0x350ad1,_0x29b623={'shopId':_0x344e04};_0x361557&&(_0x29b623[_0x466bda(0x1bc)]=_0x361557[_0x466bda(0x1ce)]());if(_0x294742){if((0x0,gateway_1[_0x466bda(0x1ea)])(_0x294742)){const _0x8adf65=(0x0,gateway_1[_0x466bda(0x1d6)])(_0x294742);_0x8adf65&&(_0x29b623['gateway']=_0x8adf65);}else _0x29b623['gateway']=_0x294742['toLowerCase']();}_0x42f1c0&&(_0x29b623['OR']=[{'gateway':{'contains':_0x42f1c0,'mode':_0x466bda(0x238)}},{'currency':{'contains':_0x42f1c0,'mode':_0x466bda(0x238)}}]);const [_0x4bbda5,_0x515e3e]=await Promise['all']([database_1[_0x466bda(0x210)][_0x466bda(0x1b7)]['findMany']({'where':_0x29b623,'skip':_0x5852fa,'take':_0x350ad1,'orderBy':{'createdAt':_0x466bda(0x22c)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x466bda(0x22c)},'take':0xa}}}),database_1[_0x466bda(0x210)][_0x466bda(0x1b7)][_0x466bda(0x1e0)]({'where':_0x29b623})]);return{'links':_0x4bbda5[_0x466bda(0x24f)](_0x2c44cc=>this['formatPaymentLinkResponse'](_0x2c44cc)),'pagination':{'page':_0xa2374,'limit':_0x350ad1,'total':_0x515e3e,'totalPages':Math[_0x466bda(0x229)](_0x515e3e/_0x350ad1)}};}async[a45_0x28974c(0x237)](_0x596b5e,_0x869d36){const _0x4c31d2=a45_0x28974c,_0x49e02f=await database_1[_0x4c31d2(0x210)][_0x4c31d2(0x1b7)][_0x4c31d2(0x22d)]({'where':{'id':_0x869d36,'shopId':_0x596b5e},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x4c31d2(0x22c)}}}});if(!_0x49e02f)return null;return this[_0x4c31d2(0x20d)](_0x49e02f);}async[a45_0x28974c(0x1d9)](_0x13bea7,_0x380a78,_0x2044a3){const _0x1fee69=a45_0x28974c,_0x5ac0a5={..._0x2044a3};if(_0x2044a3[_0x1fee69(0x20c)]){if((0x0,gateway_1[_0x1fee69(0x1ea)])(_0x2044a3['gateway'])){const _0x260727=(0x0,gateway_1[_0x1fee69(0x1d6)])(_0x2044a3[_0x1fee69(0x20c)]);_0x260727&&(_0x5ac0a5[_0x1fee69(0x20c)]=_0x260727);}else _0x5ac0a5[_0x1fee69(0x20c)]=_0x2044a3[_0x1fee69(0x20c)][_0x1fee69(0x235)]();}(_0x5ac0a5[_0x1fee69(0x20c)]===_0x1fee69(0x1f4)||_0x2044a3[_0x1fee69(0x233)]&&_0x5ac0a5[_0x1fee69(0x20c)]!==_0x1fee69(0x1f4))&&(_0x5ac0a5['gateway']===_0x1fee69(0x1f4)&&(_0x5ac0a5[_0x1fee69(0x233)]='GB',console[_0x1fee69(0x1fa)]('üá¨üáß\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update')));_0x5ac0a5['gateway']===_0x1fee69(0x204)&&(_0x5ac0a5[_0x1fee69(0x22e)]=_0x1fee69(0x208),console[_0x1fee69(0x1fa)](_0x1fee69(0x1bd)));_0x5ac0a5[_0x1fee69(0x20c)]&&_0x5ac0a5[_0x1fee69(0x22e)]&&this[_0x1fee69(0x23c)](_0x5ac0a5[_0x1fee69(0x20c)],_0x5ac0a5[_0x1fee69(0x22e)]);_0x2044a3[_0x1fee69(0x1cd)]&&(_0x5ac0a5['expiresAt']=new Date(_0x2044a3[_0x1fee69(0x1cd)]));const _0x203b3d=await database_1[_0x1fee69(0x210)][_0x1fee69(0x1b7)][_0x1fee69(0x227)]({'where':{'id':_0x380a78,'shopId':_0x13bea7},'data':_0x5ac0a5,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}});return this['formatPaymentLinkResponse'](_0x203b3d);}async[a45_0x28974c(0x245)](_0x24461b,_0x391258){const _0x53446a=a45_0x28974c;await database_1[_0x53446a(0x210)]['paymentLink'][_0x53446a(0x1f9)]({'where':{'id':_0x391258,'shopId':_0x24461b}});}async[a45_0x28974c(0x1d5)](_0x3b02aa){const _0x5575b4=a45_0x28974c,_0x98efa4=await database_1[_0x5575b4(0x210)][_0x5575b4(0x1b7)][_0x5575b4(0x248)]({'where':{'id':_0x3b02aa},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x98efa4)return null;const _0x211e12=_0x98efa4[_0x5575b4(0x1cd)]&&_0x98efa4[_0x5575b4(0x1cd)]<new Date(),_0x13bb06=_0x98efa4[_0x5575b4(0x1c9)]>=_0x98efa4[_0x5575b4(0x1fc)],_0x355194=_0x98efa4[_0x5575b4(0x24d)]['status']===_0x5575b4(0x1c8),_0xb5a4e5=_0x98efa4[_0x5575b4(0x1bc)]===_0x5575b4(0x1c8),_0xdf2532=!_0x211e12&&!_0x13bb06&&_0x355194&&_0xb5a4e5,_0xabc92=Math[_0x5575b4(0x1e9)](0x0,_0x98efa4['maxPayments']-_0x98efa4[_0x5575b4(0x1c9)]);return{'id':_0x98efa4['id'],'amount':_0x98efa4[_0x5575b4(0x1c1)],'currency':_0x98efa4[_0x5575b4(0x22e)],'sourceCurrency':_0x98efa4['sourceCurrency']||undefined,'gateway':_0x98efa4[_0x5575b4(0x20c)],'maxPayments':_0x98efa4[_0x5575b4(0x1fc)],'currentPayments':_0x98efa4['currentPayments'],'status':_0x98efa4[_0x5575b4(0x1bc)],'expiresAt':_0x98efa4[_0x5575b4(0x1cd)]||undefined,'shopName':_0x98efa4[_0x5575b4(0x24d)][_0x5575b4(0x219)],'isAvailable':_0xdf2532,'remainingPayments':_0xabc92};}async[a45_0x28974c(0x1dd)](_0x3ddb43){const _0x3f118a=a45_0x28974c,{linkId:_0x4fe94c,customerEmail:_0x54fb68,customerName:_0x5c3eb3}=_0x3ddb43,_0x5c5533=await database_1[_0x3f118a(0x210)][_0x3f118a(0x1b7)][_0x3f118a(0x248)]({'where':{'id':_0x4fe94c},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![]}}}});if(!_0x5c5533)throw new Error('Payment\x20link\x20not\x20found');const _0x1a8781=_0x5c5533[_0x3f118a(0x1cd)]&&_0x5c5533[_0x3f118a(0x1cd)]<new Date(),_0x3c26fe=_0x5c5533[_0x3f118a(0x1c9)]>=_0x5c5533[_0x3f118a(0x1fc)],_0x406969=_0x5c5533['shop'][_0x3f118a(0x1bc)]===_0x3f118a(0x1c8),_0x456785=_0x5c5533['status']===_0x3f118a(0x1c8);if(_0x1a8781)throw new Error(_0x3f118a(0x1ed));if(_0x3c26fe)throw new Error(_0x3f118a(0x252));if(!_0x406969)throw new Error(_0x3f118a(0x1e3));if(!_0x456785)throw new Error(_0x3f118a(0x1b9));const _0x2525bb=_0x5c5533[_0x3f118a(0x1c1)];console[_0x3f118a(0x1fa)](_0x3f118a(0x200)+_0x4fe94c+':\x20'+_0x2525bb+'\x20'+_0x5c5533[_0x3f118a(0x22e)]),console[_0x3f118a(0x1fa)](_0x3f118a(0x1f7)+(_0x5c3eb3||_0x3f118a(0x244))+'\x20('+(_0x54fb68||_0x3f118a(0x1c0))+')'),this[_0x3f118a(0x23c)](_0x5c5533[_0x3f118a(0x20c)],_0x5c5533[_0x3f118a(0x22e)]);const _0x757d68=this[_0x3f118a(0x23b)]();console[_0x3f118a(0x1fa)]('üéØ\x20Generated\x20gateway\x20order_id:\x20'+_0x757d68+'\x20(8digits-8digits\x20format\x20for\x20'+_0x5c5533[_0x3f118a(0x20c)]+')');const _0x2198a7=process['env'][_0x3f118a(0x21a)]||_0x3f118a(0x1d3),{finalSuccessUrl:_0x58924b,finalFailUrl:_0x3f2749,dbSuccessUrl:_0x3bc82b,dbFailUrl:_0x41c9cb}=this[_0x3f118a(0x209)](_0x5c5533[_0x3f118a(0x20c)],_0x757d68,_0x2198a7,_0x5c5533[_0x3f118a(0x21e)]||undefined,_0x5c5533[_0x3f118a(0x23d)]||undefined),_0x5af6ef=await database_1[_0x3f118a(0x210)][_0x3f118a(0x1e7)][_0x3f118a(0x214)]({'data':{'shopId':_0x5c5533[_0x3f118a(0x20a)],'paymentLinkId':_0x5c5533['id'],'gateway':_0x5c5533[_0x3f118a(0x20c)],'amount':_0x2525bb,'currency':_0x5c5533[_0x3f118a(0x22e)],'sourceCurrency':_0x5c5533[_0x3f118a(0x218)]||undefined,'usage':'ONCE','expiresAt':_0x5c5533[_0x3f118a(0x1cd)]||undefined,'successUrl':_0x3bc82b,'failUrl':_0x41c9cb,'status':_0x3f118a(0x1f8),'orderId':null,'gatewayOrderId':_0x757d68,'customerEmail':_0x54fb68||undefined,'customerName':_0x5c3eb3||undefined,'country':_0x5c5533[_0x3f118a(0x233)]||undefined,'language':_0x5c5533[_0x3f118a(0x203)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x3f118a(0x1fa)](_0x3f118a(0x1ba)+_0x5af6ef['id']),console[_0x3f118a(0x1fa)]('üí∞\x20Amount:\x20'+_0x2525bb+'\x20'+_0x5c5533[_0x3f118a(0x22e)]),console['log']('üë§\x20Customer:\x20'+(_0x5c3eb3||'Anonymous')+'\x20('+(_0x54fb68||_0x3f118a(0x1c0))+')'),console[_0x3f118a(0x1fa)](_0x3f118a(0x207)+_0x3bc82b),console[_0x3f118a(0x1fa)]('üíæ\x20DB\x20Fail\x20URL:\x20'+_0x41c9cb);let _0x4995cb,_0xba18ac;try{if(_0x5c5533[_0x3f118a(0x20c)]==='plisio'){console[_0x3f118a(0x1fa)]('üí∞\x20Plisio\x20payment\x20link\x20mapping:'),console[_0x3f118a(0x1fa)](_0x3f118a(0x1d2)+_0x5c5533[_0x3f118a(0x22e)]),console[_0x3f118a(0x1fa)](_0x3f118a(0x1f1)+_0x5c5533[_0x3f118a(0x218)]);const _0x2445a6=await this[_0x3f118a(0x222)][_0x3f118a(0x241)]({'paymentId':_0x5af6ef['id'],'orderId':_0x757d68,'amount':_0x2525bb,'currency':_0x5c5533['currency'],'productName':_0x3f118a(0x1c7)+_0x2525bb+'\x20'+_0x5c5533[_0x3f118a(0x22e)],'description':_0x3f118a(0x1c7)+_0x2525bb+'\x20'+_0x5c5533[_0x3f118a(0x22e)],'successUrl':_0x58924b,'failUrl':_0x3f2749,'customerEmail':_0x54fb68||undefined,'customerName':_0x5c3eb3||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x5c5533[_0x3f118a(0x218)]||undefined});_0x4995cb=_0x2445a6['gateway_payment_id'],_0xba18ac=_0x2445a6['payment_url'],await database_1['default']['payment'][_0x3f118a(0x227)]({'where':{'id':_0x5af6ef['id']},'data':{'externalPaymentUrl':_0xba18ac,'gatewayPaymentId':_0x4995cb,'invoiceTotalSum':Number(_0x2445a6[_0x3f118a(0x246)]),'qrCode':_0x2445a6['qr_code'],'qrUrl':_0x2445a6['qr_url']}});const _0xa41554='https://app.trapay.uk/payment/'+_0x5af6ef['id'];return console['log'](_0x3f118a(0x217)+_0xa41554),{'paymentId':_0x5af6ef['id'],'paymentUrl':_0xa41554,'expiresAt':_0x5af6ef[_0x3f118a(0x1cd)]||undefined};}else{if(_0x5c5533['gateway']==='rapyd'){const _0x998752=await this[_0x3f118a(0x1e2)][_0x3f118a(0x21c)]({'paymentId':_0x5af6ef['id'],'orderId':_0x757d68,'orderName':'Payment\x20'+_0x2525bb+'\x20'+_0x5c5533[_0x3f118a(0x22e)],'amount':_0x2525bb,'currency':_0x5c5533['currency'],'country':_0x5c5533[_0x3f118a(0x233)],'language':_0x5c5533[_0x3f118a(0x203)]||'EN','amountIsEditable':![],'usage':_0x3f118a(0x1ec),'maxPayments':0x1,'successUrl':_0x58924b,'failUrl':_0x3f2749});_0x4995cb=_0x998752['gateway_payment_id'],_0xba18ac=_0x998752['payment_url'],await database_1[_0x3f118a(0x210)][_0x3f118a(0x1e7)][_0x3f118a(0x227)]({'where':{'id':_0x5af6ef['id']},'data':{'externalPaymentUrl':_0xba18ac,'gatewayPaymentId':_0x4995cb}});const _0x303189=_0x3f118a(0x1be)+_0x5af6ef['id'];return console[_0x3f118a(0x1fa)](_0x3f118a(0x215)+_0x303189),{'paymentId':_0x5af6ef['id'],'paymentUrl':_0x303189,'expiresAt':_0x5af6ef[_0x3f118a(0x1cd)]||undefined};}else{if(_0x5c5533['gateway']===_0x3f118a(0x1bf)){const _0x4ff998=await this[_0x3f118a(0x24e)][_0x3f118a(0x21c)]({'paymentId':_0x5af6ef['id'],'orderId':_0x757d68,'name':'Payment\x20'+_0x2525bb+'\x20'+_0x5c5533[_0x3f118a(0x22e)],'paymentDescription':_0x3f118a(0x1c7)+_0x2525bb+'\x20'+_0x5c5533[_0x3f118a(0x22e)],'amount':_0x2525bb,'currency':_0x5c5533[_0x3f118a(0x22e)],'webhookUrl':_0x3f118a(0x1fb),'returnUrl':_0x58924b,'expiryDate':_0x5c5533['expiresAt']?.[_0x3f118a(0x22b)]()});_0x4995cb=_0x4ff998[_0x3f118a(0x24b)],_0xba18ac=_0x4ff998[_0x3f118a(0x1f3)],await database_1[_0x3f118a(0x210)][_0x3f118a(0x1e7)][_0x3f118a(0x227)]({'where':{'id':_0x5af6ef['id']},'data':{'externalPaymentUrl':_0xba18ac,'gatewayPaymentId':_0x4995cb,'qrUrl':_0x4ff998[_0x3f118a(0x1e5)]}});const _0x571f58=_0x3f118a(0x1be)+_0x5af6ef['id'];return console['log'](_0x3f118a(0x1f6)+_0x571f58),{'paymentId':_0x5af6ef['id'],'paymentUrl':_0x571f58,'expiresAt':_0x5af6ef[_0x3f118a(0x1cd)]||undefined};}else{if(_0x5c5533[_0x3f118a(0x20c)]===_0x3f118a(0x204)){console[_0x3f118a(0x1fa)](_0x3f118a(0x1f2)+_0x757d68+_0x3f118a(0x1cb)),console[_0x3f118a(0x1fa)](_0x3f118a(0x206)+_0x2525bb+_0x3f118a(0x21b));const _0x3f340f=await this[_0x3f118a(0x1c3)][_0x3f118a(0x21c)]({'paymentId':_0x5af6ef['id'],'orderId':_0x757d68,'amount':_0x2525bb});_0x4995cb=_0x3f340f[_0x3f118a(0x24b)],_0xba18ac=_0x3f340f[_0x3f118a(0x1f3)],await database_1[_0x3f118a(0x210)][_0x3f118a(0x1e7)][_0x3f118a(0x227)]({'where':{'id':_0x5af6ef['id']},'data':{'externalPaymentUrl':_0xba18ac,'gatewayPaymentId':_0x4995cb}});const _0x31db64=_0x3f118a(0x1be)+_0x5af6ef['id'];return console[_0x3f118a(0x1fa)](_0x3f118a(0x1d8)+_0x31db64),{'paymentId':_0x5af6ef['id'],'paymentUrl':_0x31db64,'expiresAt':_0x5af6ef[_0x3f118a(0x1cd)]||undefined};}else{if(_0x5c5533['gateway']['startsWith'](_0x3f118a(0x216))){const _0x3e6609=(0x0,gateway_1[_0x3f118a(0x1c2)])(_0x5c5533[_0x3f118a(0x20c)]);if(!_0x3e6609)throw new Error(_0x3f118a(0x1e6)+_0x5c5533[_0x3f118a(0x20c)]);console[_0x3f118a(0x1fa)](_0x3f118a(0x226)+_0x3e6609+_0x3f118a(0x230)+_0x757d68+'\x20(8digits-8digits\x20format)'),console[_0x3f118a(0x1fa)](_0x3f118a(0x206)+_0x2525bb+'\x20'+_0x5c5533[_0x3f118a(0x22e)]+'\x20(validated\x20for\x20'+_0x3e6609+')');const _0x49e4ee=await this[_0x3f118a(0x247)][_0x3f118a(0x21c)]({'paymentId':_0x5af6ef['id'],'orderId':_0x757d68,'amount':_0x2525bb,'currency':_0x5c5533['currency'],'region':_0x3e6609,'redirectUrl':_0x58924b});_0x4995cb=_0x49e4ee['gateway_payment_id'],_0xba18ac=_0x49e4ee[_0x3f118a(0x1f3)],await database_1['default']['payment'][_0x3f118a(0x227)]({'where':{'id':_0x5af6ef['id']},'data':{'externalPaymentUrl':_0xba18ac,'gatewayPaymentId':_0x4995cb}});const _0x4bcb50='https://app.trapay.uk/payment/'+_0x5af6ef['id'];return console[_0x3f118a(0x1fa)](_0x3f118a(0x1fd)+_0x3e6609+_0x3f118a(0x256)+_0x757d68),console[_0x3f118a(0x1fa)](_0x3f118a(0x1ee)+_0x3e6609+_0x3f118a(0x23e)+_0x4bcb50),{'paymentId':_0x5af6ef['id'],'paymentUrl':_0x4bcb50,'expiresAt':_0x5af6ef[_0x3f118a(0x1cd)]||undefined};}else throw new Error('Unsupported\x20gateway:\x20'+_0x5c5533[_0x3f118a(0x20c)]);}}}}}catch(_0x479f67){await database_1[_0x3f118a(0x210)][_0x3f118a(0x1e7)]['update']({'where':{'id':_0x5af6ef['id']},'data':{'status':'FAILED'}});throw new Error(_0x3f118a(0x1da)+(_0x479f67 instanceof Error?_0x479f67['message']:'Unknown\x20error'));}}async[a45_0x28974c(0x1fe)](_0xbc397e){const _0x533b91=a45_0x28974c,_0x26b76a=await database_1['default'][_0x533b91(0x1e7)][_0x533b91(0x248)]({'where':{'id':_0xbc397e},'include':{'paymentLink':!![]}});if(!_0x26b76a||!_0x26b76a[_0x533b91(0x1b7)])return;const _0xf891cb=await database_1[_0x533b91(0x210)]['paymentLink'][_0x533b91(0x227)]({'where':{'id':_0x26b76a[_0x533b91(0x1dc)]},'data':{'currentPayments':{'increment':0x1}}});console['log'](_0x533b91(0x205)+_0x26b76a[_0x533b91(0x1dc)]+_0x533b91(0x213)+_0xf891cb[_0x533b91(0x1c9)]+'/'+_0xf891cb[_0x533b91(0x1fc)]),_0xf891cb['currentPayments']>=_0xf891cb['maxPayments']&&(await database_1[_0x533b91(0x210)]['paymentLink'][_0x533b91(0x227)]({'where':{'id':_0x26b76a[_0x533b91(0x1dc)]},'data':{'status':'COMPLETED'}}),console[_0x533b91(0x1fa)](_0x533b91(0x20e)+_0x26b76a[_0x533b91(0x1dc)]+_0x533b91(0x1e8)));}async['getPaymentLinkStatistics'](_0x51080a){const _0x4f178e=a45_0x28974c,[_0x3d86d5,_0x3248ff,_0x506ac1,_0x13fde4]=await Promise[_0x4f178e(0x1d1)]([database_1[_0x4f178e(0x210)][_0x4f178e(0x1b7)][_0x4f178e(0x1e0)]({'where':{'shopId':_0x51080a}}),database_1[_0x4f178e(0x210)]['paymentLink'][_0x4f178e(0x1e0)]({'where':{'shopId':_0x51080a,'status':_0x4f178e(0x1c8)}}),database_1[_0x4f178e(0x210)]['payment'][_0x4f178e(0x1e0)]({'where':{'shopId':_0x51080a,'paymentLinkId':{'not':null}}}),database_1['default'][_0x4f178e(0x1e7)][_0x4f178e(0x1df)]({'where':{'shopId':_0x51080a,'paymentLinkId':{'not':null},'status':_0x4f178e(0x20f)},'select':{'amount':!![],'currency':!![]}})]);let _0x3d551e=0x0;for(const _0x855433 of _0x13fde4){const _0x536164=await currencyService_1[_0x4f178e(0x1d0)][_0x4f178e(0x251)](_0x855433[_0x4f178e(0x1c1)],_0x855433[_0x4f178e(0x22e)]);_0x3d551e+=_0x536164;}const _0x539f37=_0x506ac1>0x0?_0x13fde4['length']/_0x506ac1*0x64:0x0;return{'totalLinks':_0x3d86d5,'activeLinks':_0x3248ff,'totalPayments':_0x506ac1,'totalRevenue':Math[_0x4f178e(0x20b)](_0x3d551e*0x64)/0x64,'conversionRate':Math[_0x4f178e(0x20b)](_0x539f37*0x64)/0x64};}['formatPaymentLinkResponse'](_0x372c22){const _0x247339=a45_0x28974c;return{'id':_0x372c22['id'],'shopId':_0x372c22['shopId'],'amount':_0x372c22[_0x247339(0x1c1)],'currency':_0x372c22[_0x247339(0x22e)],'sourceCurrency':_0x372c22[_0x247339(0x218)]||undefined,'gateway':_0x372c22[_0x247339(0x20c)],'maxPayments':_0x372c22[_0x247339(0x1fc)],'currentPayments':_0x372c22['currentPayments'],'status':_0x372c22[_0x247339(0x1bc)],'expiresAt':_0x372c22[_0x247339(0x1cd)]||undefined,'successUrl':_0x372c22['successUrl']||undefined,'failUrl':_0x372c22[_0x247339(0x23d)]||undefined,'country':_0x372c22[_0x247339(0x233)]||undefined,'language':_0x372c22[_0x247339(0x203)]||undefined,'linkUrl':_0x247339(0x1f5)+_0x372c22['id'],'createdAt':_0x372c22[_0x247339(0x1eb)],'updatedAt':_0x372c22['updatedAt'],'shop':_0x372c22[_0x247339(0x24d)],'payments':_0x372c22['payments']};}}exports['PaymentLinkService']=PaymentLinkService;