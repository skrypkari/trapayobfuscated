'use strict';function a45_0x24c1(){const _0x1d83bc=['RapydService','/gateway/fail.php?id=','getGatewayNameById','createdAt','validateKlymeCurrency','updatePaymentLink','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','update','CoinToPayService','\x20(8digits-8digits\x20format)','startsWith','padStart','2520477PejHGF','currentPayments','random','KlymeService','shop','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','Anonymous','PLACEHOLDER','📈\x20Payment\x20link\x20','603090tecsPC','397075hOZayN','Payment\x20','❌\x20DB\x20Fail\x20URL:\x20','failUrl','./gateways/plisioService','✅\x20KLYME\x20','269096LQgrhw','cointopay','handleSuccessfulPayment','currency','toISOString','count','1004346CwfUsz','10mtvnup','initiatePaymentFromLink','Unknown\x20error','Gateway\x20not\x20found\x20for\x20ID:\x20','round','🔗\x20Plisio\x20payment\x20URL:\x20','toString','expiresAt','findFirst','🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','toUpperCase','env','getPaymentLinkStatistics','💳\x20Initiating\x20payment\x20from\x20link\x20','payment_url','successUrl','COMPLETED','https://tesoft.uk','💰\x20Fixed\x20amount:\x20','currencyService','🔗\x20CoinToPay\x20payment\x20URL:\x20','../types/gateway','PENDING','🏁\x20Payment\x20link\x20','Payment\x20link\x20is\x20not\x20active','defineProperty','convertToUSDT','USD','💰\x20Amount:\x20','https://tesoft.uk/gateway/payment.php?id=','getPublicPaymentLinkData','updatedAt','amount\x20is\x20required\x20and\x20must\x20be\x20positive','create','💰\x20Plisio\x20payment\x20link\x20mapping:','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','💳\x20Creating\x20KLYME\x20','3tjoRtP','klymeService','insensitive','💾\x20DB\x20Fail\x20URL:\x20','amount','ONCE','generateGatewayUrls','noda','getKlymeRegionFromGatewayName','2622641JmzLDy','12coespj','BASE_URL','getPaymentLinkById','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','payments','plisioService','log','ceil','all','./currencyService','Order\x20ID:\x20','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','toLowerCase','💾\x20DB\x20Success\x20URL:\x20','country','paymentLinkId','GBP','createPaymentLink','qr_code','EUR','PaymentLinkService','isValidGatewayId','map','invoice_total_sum','qr_code_url','formatPaymentLinkResponse','./gateways/coinToPayService','sourceCurrency','name','shopId','PAID','Payment\x20link\x20not\x20found','nodaService','no\x20email','Invalid\x20KLYME\x20gateway:\x20','https://app.trapay.uk/payment/','maxPayments','default','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','https://app.trapay.uk/link/','\x20payments:\x20','rapydService','https://app.trapay.uk/payment/pending?payment_id=','🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','klyme_','floor','👤\x20Customer:\x20','🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','generateGatewayOrderId','✅\x20DB\x20Success\x20URL:\x20','findUnique','length','\x20completed\x20(reached\x20max\x20payments)','PlisioService','language','Payment\x20link\x20has\x20reached\x20maximum\x20payments','desc','Unsupported\x20gateway:\x20','9186353fFUazq','gateway','plisio','https://app.trapay.uk/payment/fail?payment_id=','🔗\x20Noda\x20payment\x20URL:\x20','status','createPayment','payment','\x20(8digits-8digits\x20format\x20for\x20','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','NodaService','coinToPayService','\x20payment\x20link','/gateway/pending.php?id=','findMany','paymentLink','🔗\x20KLYME\x20','getPaymentLinks','rapyd','8wtJUre','Shop\x20is\x20not\x20active','gateway_payment_id','✅\x20Payment\x20link\x20created:\x20','ACTIVE','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','__esModule','\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20'];a45_0x24c1=function(){return _0x1d83bc;};return a45_0x24c1();}const a45_0x39692d=a45_0x4c1b;(function(_0xbe7b92,_0x59dd6f){const _0x4b2d0e=a45_0x4c1b,_0x2a438d=_0xbe7b92();while(!![]){try{const _0x417d47=-parseInt(_0x4b2d0e(0x143))/0x1*(parseInt(_0x4b2d0e(0x115))/0x2)+parseInt(_0x4b2d0e(0x11b))/0x3+parseInt(_0x4b2d0e(0x14d))/0x4*(parseInt(_0x4b2d0e(0x10f))/0x5)+-parseInt(_0x4b2d0e(0x10e))/0x6+-parseInt(_0x4b2d0e(0x14c))/0x7+-parseInt(_0x4b2d0e(0xf1))/0x8*(parseInt(_0x4b2d0e(0x105))/0x9)+-parseInt(_0x4b2d0e(0x11c))/0xa*(-parseInt(_0x4b2d0e(0xde))/0xb);if(_0x417d47===_0x59dd6f)break;else _0x2a438d['push'](_0x2a438d['shift']());}catch(_0x30a87c){_0x2a438d['push'](_0x2a438d['shift']());}}}(a45_0x24c1,0x3cdbb));function a45_0x4c1b(_0x52ad14,_0x5837c8){const _0x24c121=a45_0x24c1();return a45_0x4c1b=function(_0x4c1b46,_0x25bac2){_0x4c1b46=_0x4c1b46-0xb0;let _0x3ff62f=_0x24c121[_0x4c1b46];return _0x3ff62f;},a45_0x4c1b(_0x52ad14,_0x5837c8);}var __importDefault=this&&this['__importDefault']||function(_0x1b2187){const _0x3e76e0=a45_0x4c1b;return _0x1b2187&&_0x1b2187[_0x3e76e0(0xf7)]?_0x1b2187:{'default':_0x1b2187};};Object[a45_0x39692d(0x136)](exports,a45_0x39692d(0xf7),{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a45_0x39692d(0x113)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a45_0x39692d(0xbe)),klymeService_1=require('./gateways/klymeService'),gateway_1=require(a45_0x39692d(0x132)),currencyService_1=require(a45_0x39692d(0x156));class PaymentLinkService{constructor(){const _0x3333c3=a45_0x39692d;this[_0x3333c3(0x152)]=new plisioService_1[(_0x3333c3(0xd9))](),this[_0x3333c3(0xcd)]=new rapydService_1[(_0x3333c3(0xf9))](),this[_0x3333c3(0xc4)]=new nodaService_1[(_0x3333c3(0xe8))](),this[_0x3333c3(0xe9)]=new coinToPayService_1[(_0x3333c3(0x101))](),this[_0x3333c3(0x144)]=new klymeService_1[(_0x3333c3(0x108))]();}[a45_0x39692d(0xd4)](){const _0x4ccdbd=()=>{const _0x3957e0=a45_0x4c1b;return Math[_0x3957e0(0xd1)](Math[_0x3957e0(0x107)]()*0x5f5e100)[_0x3957e0(0x122)]()[_0x3957e0(0x104)](0x8,'0');};return _0x4ccdbd()+'-'+_0x4ccdbd();}[a45_0x39692d(0x149)](_0xb1f70c,_0x3fb3f0,_0x378b09,_0x56875d,_0x39d575){const _0x2f56a2=a45_0x39692d;if(_0x56875d&&_0x39d575)return{'finalSuccessUrl':_0x56875d,'finalFailUrl':_0x39d575,'dbSuccessUrl':_0x56875d,'dbFailUrl':_0x39d575};let _0x54f709,_0x24b10e,_0x377b4b,_0x16fa75;return _0xb1f70c===_0x2f56a2(0x14a)||_0xb1f70c['startsWith'](_0x2f56a2(0xd0))||_0xb1f70c===_0x2f56a2(0x116)?(_0x54f709=_0x378b09+_0x2f56a2(0xeb)+_0x3fb3f0,_0x377b4b=_0x2f56a2(0xce)+_0x3fb3f0):(_0x54f709=_0x378b09+'/gateway/success.php?id='+_0x3fb3f0,_0x377b4b='https://app.trapay.uk/payment/success?payment_id='+_0x3fb3f0),_0x24b10e=_0x378b09+_0x2f56a2(0xfa)+_0x3fb3f0,_0x16fa75=_0x2f56a2(0xe1)+_0x3fb3f0,console[_0x2f56a2(0x153)]('🔗\x20Generated\x20URLs\x20for\x20'+_0xb1f70c+':'),console[_0x2f56a2(0x153)](_0x2f56a2(0xff)+_0x54f709),console[_0x2f56a2(0x153)](_0x2f56a2(0xe7)+_0x24b10e),console['log']('\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20'+_0x377b4b),console['log'](_0x2f56a2(0xf8)+_0x16fa75),{'finalSuccessUrl':_0x54f709,'finalFailUrl':_0x24b10e,'dbSuccessUrl':_0x377b4b,'dbFailUrl':_0x16fa75};}[a45_0x39692d(0xfd)](_0x1c4cb2,_0x3a57f1){const _0x2d4a3c=a45_0x39692d;if(!_0x1c4cb2[_0x2d4a3c(0x103)]('klyme_'))return;const _0xaac4d0=(0x0,gateway_1[_0x2d4a3c(0x14b)])(_0x1c4cb2),_0x406489=_0x3a57f1[_0x2d4a3c(0x127)]();switch(_0xaac4d0){case'EU':if(_0x406489!==_0x2d4a3c(0xb7))throw new Error(_0x2d4a3c(0x141)+_0x406489);break;case'GB':if(_0x406489!==_0x2d4a3c(0xb4))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x406489);break;case'DE':if(_0x406489!==_0x2d4a3c(0xb7))throw new Error(_0x2d4a3c(0x140)+_0x406489);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0xaac4d0);}}async[a45_0x39692d(0xb5)](_0x17fb58,_0x568ae8){const _0x125bc8=a45_0x39692d;if(!(0x0,gateway_1[_0x125bc8(0xb9)])(_0x568ae8[_0x125bc8(0xdf)]))throw new Error('Invalid\x20gateway\x20ID:\x20'+_0x568ae8[_0x125bc8(0xdf)]+_0x125bc8(0x150));const _0x16cc63=(0x0,gateway_1[_0x125bc8(0xfb)])(_0x568ae8[_0x125bc8(0xdf)]);if(!_0x16cc63)throw new Error(_0x125bc8(0x11f)+_0x568ae8[_0x125bc8(0xdf)]);console[_0x125bc8(0x153)](_0x125bc8(0x125)+_0x16cc63);if(_0x16cc63===_0x125bc8(0xe0)&&!_0x568ae8[_0x125bc8(0xbf)])throw new Error(_0x125bc8(0xca));if(_0x16cc63['startsWith']('klyme_')){const _0x36ef54=(0x0,gateway_1[_0x125bc8(0x14b)])(_0x16cc63);console[_0x125bc8(0x153)](_0x125bc8(0x142)+_0x36ef54+_0x125bc8(0xea));}let _0x3879ce=_0x568ae8['country'];_0x16cc63===_0x125bc8(0xf0)&&(_0x3879ce='GB',console['log'](_0x125bc8(0x126)));if(!_0x568ae8[_0x125bc8(0x147)]||_0x568ae8[_0x125bc8(0x147)]<=0x0)throw new Error(_0x125bc8(0x13d));let _0x4316ec=_0x568ae8[_0x125bc8(0x118)]||_0x125bc8(0x138);_0x16cc63===_0x125bc8(0x116)&&(_0x4316ec=_0x125bc8(0xb7),console[_0x125bc8(0x153)]('🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link'));this[_0x125bc8(0xfd)](_0x16cc63,_0x4316ec);const _0x2c7f72=process[_0x125bc8(0x128)][_0x125bc8(0x14e)]||_0x125bc8(0x12e),{finalSuccessUrl:_0x547b80,finalFailUrl:_0x41ae92,dbSuccessUrl:_0x4b215e,dbFailUrl:_0x520fe1}=this[_0x125bc8(0x149)](_0x16cc63,_0x125bc8(0x10c),_0x2c7f72,_0x568ae8[_0x125bc8(0x12c)],_0x568ae8[_0x125bc8(0x112)]),_0x4d1a80=await database_1['default']['paymentLink'][_0x125bc8(0x13e)]({'data':{'shopId':_0x17fb58,'amount':_0x568ae8[_0x125bc8(0x147)],'currency':_0x4316ec,'sourceCurrency':_0x568ae8[_0x125bc8(0xbf)]||undefined,'gateway':_0x16cc63,'maxPayments':_0x568ae8[_0x125bc8(0xc8)]||0x1,'currentPayments':0x0,'status':'ACTIVE','expiresAt':_0x568ae8['expiresAt']?new Date(_0x568ae8[_0x125bc8(0x123)]):undefined,'successUrl':_0x4b215e,'failUrl':_0x520fe1,'country':_0x3879ce,'language':_0x568ae8['language']||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x125bc8(0x153)](_0x125bc8(0xf4)+_0x4d1a80['id']+'\x20('+_0x16cc63+')'),console[_0x125bc8(0x153)](_0x125bc8(0x12f)+_0x4d1a80[_0x125bc8(0x147)]+'\x20'+_0x4d1a80[_0x125bc8(0x118)]),console[_0x125bc8(0x153)]('🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/'+_0x4d1a80['id']),console[_0x125bc8(0x153)](_0x125bc8(0xd5)+_0x4d1a80[_0x125bc8(0x12c)]),console[_0x125bc8(0x153)](_0x125bc8(0x111)+_0x4d1a80[_0x125bc8(0x112)]),this['formatPaymentLinkResponse'](_0x4d1a80);}async[a45_0x39692d(0xef)](_0xd07b83,_0x4a0c55){const _0x185580=a45_0x39692d,{page:_0x363d3a,limit:_0x2f4b12,status:_0x5426b3,gateway:_0x57dddf,search:_0x104f99}=_0x4a0c55,_0x3e9696=(_0x363d3a-0x1)*_0x2f4b12,_0x2aa488={'shopId':_0xd07b83};_0x5426b3&&(_0x2aa488['status']=_0x5426b3[_0x185580(0x127)]());if(_0x57dddf){if((0x0,gateway_1['isValidGatewayId'])(_0x57dddf)){const _0x189dc7=(0x0,gateway_1[_0x185580(0xfb)])(_0x57dddf);_0x189dc7&&(_0x2aa488[_0x185580(0xdf)]=_0x189dc7);}else _0x2aa488['gateway']=_0x57dddf[_0x185580(0xb0)]();}_0x104f99&&(_0x2aa488['OR']=[{'gateway':{'contains':_0x104f99,'mode':_0x185580(0x145)}},{'currency':{'contains':_0x104f99,'mode':_0x185580(0x145)}}]);const [_0x13fa85,_0x463bf1]=await Promise['all']([database_1[_0x185580(0xc9)]['paymentLink']['findMany']({'where':_0x2aa488,'skip':_0x3e9696,'take':_0x2f4b12,'orderBy':{'createdAt':_0x185580(0xdc)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}}),database_1[_0x185580(0xc9)]['paymentLink'][_0x185580(0x11a)]({'where':_0x2aa488})]);return{'links':_0x13fa85[_0x185580(0xba)](_0x84aedc=>this[_0x185580(0xbd)](_0x84aedc)),'pagination':{'page':_0x363d3a,'limit':_0x2f4b12,'total':_0x463bf1,'totalPages':Math[_0x185580(0x154)](_0x463bf1/_0x2f4b12)}};}async[a45_0x39692d(0x14f)](_0x4d856a,_0x696d30){const _0x7162d6=a45_0x39692d,_0x31ee50=await database_1['default'][_0x7162d6(0xed)][_0x7162d6(0x124)]({'where':{'id':_0x696d30,'shopId':_0x4d856a},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x7162d6(0xdc)}}}});if(!_0x31ee50)return null;return this[_0x7162d6(0xbd)](_0x31ee50);}async[a45_0x39692d(0xfe)](_0x38be46,_0x1e767f,_0xcb9d02){const _0x4ba4e4=a45_0x39692d,_0x33e133={..._0xcb9d02};if(_0xcb9d02['gateway']){if((0x0,gateway_1[_0x4ba4e4(0xb9)])(_0xcb9d02[_0x4ba4e4(0xdf)])){const _0x4ce2dd=(0x0,gateway_1[_0x4ba4e4(0xfb)])(_0xcb9d02['gateway']);_0x4ce2dd&&(_0x33e133[_0x4ba4e4(0xdf)]=_0x4ce2dd);}else _0x33e133['gateway']=_0xcb9d02[_0x4ba4e4(0xdf)][_0x4ba4e4(0xb0)]();}(_0x33e133[_0x4ba4e4(0xdf)]===_0x4ba4e4(0xf0)||_0xcb9d02[_0x4ba4e4(0xb2)]&&_0x33e133['gateway']!==_0x4ba4e4(0xf0))&&(_0x33e133[_0x4ba4e4(0xdf)]==='rapyd'&&(_0x33e133[_0x4ba4e4(0xb2)]='GB',console[_0x4ba4e4(0x153)](_0x4ba4e4(0xd3))));_0x33e133[_0x4ba4e4(0xdf)]==='cointopay'&&(_0x33e133['currency']=_0x4ba4e4(0xb7),console[_0x4ba4e4(0x153)]('🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update'));_0x33e133[_0x4ba4e4(0xdf)]&&_0x33e133[_0x4ba4e4(0x118)]&&this[_0x4ba4e4(0xfd)](_0x33e133[_0x4ba4e4(0xdf)],_0x33e133[_0x4ba4e4(0x118)]);_0xcb9d02['expiresAt']&&(_0x33e133[_0x4ba4e4(0x123)]=new Date(_0xcb9d02['expiresAt']));const _0x2f2262=await database_1[_0x4ba4e4(0xc9)][_0x4ba4e4(0xed)][_0x4ba4e4(0x100)]({'where':{'id':_0x1e767f,'shopId':_0x38be46},'data':_0x33e133,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x4ba4e4(0xdc)},'take':0xa}}});return this[_0x4ba4e4(0xbd)](_0x2f2262);}async['deletePaymentLink'](_0xe1b927,_0x16cd64){const _0x34c66b=a45_0x39692d;await database_1[_0x34c66b(0xc9)][_0x34c66b(0xed)]['delete']({'where':{'id':_0x16cd64,'shopId':_0xe1b927}});}async[a45_0x39692d(0x13b)](_0x1bde10){const _0x29d261=a45_0x39692d,_0x5ed7ce=await database_1[_0x29d261(0xc9)][_0x29d261(0xed)][_0x29d261(0xd6)]({'where':{'id':_0x1bde10},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x5ed7ce)return null;const _0x551215=_0x5ed7ce['expiresAt']&&_0x5ed7ce[_0x29d261(0x123)]<new Date(),_0x551740=_0x5ed7ce['currentPayments']>=_0x5ed7ce[_0x29d261(0xc8)],_0x1bae6f=_0x5ed7ce['shop'][_0x29d261(0xe3)]===_0x29d261(0xf5),_0x3331e9=_0x5ed7ce[_0x29d261(0xe3)]===_0x29d261(0xf5),_0x27cec2=!_0x551215&&!_0x551740&&_0x1bae6f&&_0x3331e9,_0x4d0492=Math['max'](0x0,_0x5ed7ce[_0x29d261(0xc8)]-_0x5ed7ce[_0x29d261(0x106)]);return{'id':_0x5ed7ce['id'],'amount':_0x5ed7ce[_0x29d261(0x147)],'currency':_0x5ed7ce[_0x29d261(0x118)],'sourceCurrency':_0x5ed7ce[_0x29d261(0xbf)]||undefined,'gateway':_0x5ed7ce[_0x29d261(0xdf)],'maxPayments':_0x5ed7ce[_0x29d261(0xc8)],'currentPayments':_0x5ed7ce[_0x29d261(0x106)],'status':_0x5ed7ce['status'],'expiresAt':_0x5ed7ce[_0x29d261(0x123)]||undefined,'shopName':_0x5ed7ce[_0x29d261(0x109)][_0x29d261(0xc0)],'isAvailable':_0x27cec2,'remainingPayments':_0x4d0492};}async[a45_0x39692d(0x11d)](_0x44a34e){const _0x334908=a45_0x39692d,{linkId:_0x5bdeb1,customerEmail:_0x2e1a42,customerName:_0x8717d8}=_0x44a34e,_0x3aa6f8=await database_1[_0x334908(0xc9)][_0x334908(0xed)]['findUnique']({'where':{'id':_0x5bdeb1},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![]}}}});if(!_0x3aa6f8)throw new Error(_0x334908(0xc3));const _0x2dd9a6=_0x3aa6f8[_0x334908(0x123)]&&_0x3aa6f8['expiresAt']<new Date(),_0x326a49=_0x3aa6f8[_0x334908(0x106)]>=_0x3aa6f8[_0x334908(0xc8)],_0x2ea49d=_0x3aa6f8[_0x334908(0x109)]['status']===_0x334908(0xf5),_0x379c41=_0x3aa6f8[_0x334908(0xe3)]===_0x334908(0xf5);if(_0x2dd9a6)throw new Error('Payment\x20link\x20has\x20expired');if(_0x326a49)throw new Error(_0x334908(0xdb));if(!_0x2ea49d)throw new Error(_0x334908(0xf2));if(!_0x379c41)throw new Error(_0x334908(0x135));const _0x3f35ad=_0x3aa6f8['amount'];console[_0x334908(0x153)](_0x334908(0x12a)+_0x5bdeb1+':\x20'+_0x3f35ad+'\x20'+_0x3aa6f8[_0x334908(0x118)]),console[_0x334908(0x153)](_0x334908(0xd2)+(_0x8717d8||_0x334908(0x10b))+'\x20('+(_0x2e1a42||'no\x20email')+')'),this[_0x334908(0xfd)](_0x3aa6f8[_0x334908(0xdf)],_0x3aa6f8[_0x334908(0x118)]);const _0x29c60a=this[_0x334908(0xd4)]();console[_0x334908(0x153)]('🎯\x20Generated\x20gateway\x20order_id:\x20'+_0x29c60a+_0x334908(0xe6)+_0x3aa6f8[_0x334908(0xdf)]+')');const _0x575ddf=process[_0x334908(0x128)][_0x334908(0x14e)]||_0x334908(0x12e),{finalSuccessUrl:_0x346548,finalFailUrl:_0x3416f0,dbSuccessUrl:_0x2da5d5,dbFailUrl:_0x25ad3e}=this[_0x334908(0x149)](_0x3aa6f8[_0x334908(0xdf)],_0x29c60a,_0x575ddf,_0x3aa6f8[_0x334908(0x12c)]||undefined,_0x3aa6f8[_0x334908(0x112)]||undefined),_0x47739b=await database_1[_0x334908(0xc9)][_0x334908(0xe5)]['create']({'data':{'shopId':_0x3aa6f8[_0x334908(0xc1)],'paymentLinkId':_0x3aa6f8['id'],'gateway':_0x3aa6f8['gateway'],'amount':_0x3f35ad,'currency':_0x3aa6f8['currency'],'sourceCurrency':_0x3aa6f8[_0x334908(0xbf)]||undefined,'usage':'ONCE','expiresAt':_0x3aa6f8[_0x334908(0x123)]||undefined,'successUrl':_0x2da5d5,'failUrl':_0x25ad3e,'status':_0x334908(0x133),'orderId':null,'gatewayOrderId':_0x29c60a,'customerEmail':_0x2e1a42||undefined,'customerName':_0x8717d8||undefined,'country':_0x3aa6f8[_0x334908(0xb2)]||undefined,'language':_0x3aa6f8[_0x334908(0xda)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x334908(0x153)]('💾\x20Payment\x20created\x20from\x20link:\x20'+_0x47739b['id']),console[_0x334908(0x153)](_0x334908(0x139)+_0x3f35ad+'\x20'+_0x3aa6f8['currency']),console[_0x334908(0x153)](_0x334908(0xd2)+(_0x8717d8||_0x334908(0x10b))+'\x20('+(_0x2e1a42||_0x334908(0xc5))+')'),console[_0x334908(0x153)](_0x334908(0xb1)+_0x2da5d5),console['log'](_0x334908(0x146)+_0x25ad3e);let _0x47ca73,_0x5035fa;try{if(_0x3aa6f8[_0x334908(0xdf)]===_0x334908(0xe0)){console[_0x334908(0x153)](_0x334908(0x13f)),console[_0x334908(0x153)]('\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20'+_0x3aa6f8[_0x334908(0x118)]),console[_0x334908(0x153)]('\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20'+_0x3aa6f8[_0x334908(0xbf)]);const _0x3bfec7=await this['plisioService'][_0x334908(0xe4)]({'paymentId':_0x47739b['id'],'orderId':_0x29c60a,'amount':_0x3f35ad,'currency':_0x3aa6f8[_0x334908(0x118)],'productName':_0x334908(0x110)+_0x3f35ad+'\x20'+_0x3aa6f8[_0x334908(0x118)],'description':_0x334908(0x110)+_0x3f35ad+'\x20'+_0x3aa6f8[_0x334908(0x118)],'successUrl':_0x346548,'failUrl':_0x3416f0,'customerEmail':_0x2e1a42||undefined,'customerName':_0x8717d8||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x3aa6f8[_0x334908(0xbf)]||undefined});_0x47ca73=_0x3bfec7['gateway_payment_id'],_0x5035fa=_0x3bfec7[_0x334908(0x12b)],await database_1[_0x334908(0xc9)][_0x334908(0xe5)][_0x334908(0x100)]({'where':{'id':_0x47739b['id']},'data':{'externalPaymentUrl':_0x5035fa,'gatewayPaymentId':_0x47ca73,'invoiceTotalSum':Number(_0x3bfec7[_0x334908(0xbb)]),'qrCode':_0x3bfec7[_0x334908(0xb6)],'qrUrl':_0x3bfec7['qr_url']}});const _0x137ab6='https://app.trapay.uk/payment/'+_0x47739b['id'];return console['log'](_0x334908(0x121)+_0x137ab6),{'paymentId':_0x47739b['id'],'paymentUrl':_0x137ab6,'expiresAt':_0x47739b[_0x334908(0x123)]||undefined};}else{if(_0x3aa6f8[_0x334908(0xdf)]===_0x334908(0xf0)){const _0x5c78a6=await this[_0x334908(0xcd)]['createPaymentLink']({'paymentId':_0x47739b['id'],'orderId':_0x29c60a,'orderName':_0x334908(0x110)+_0x3f35ad+'\x20'+_0x3aa6f8[_0x334908(0x118)],'amount':_0x3f35ad,'currency':_0x3aa6f8[_0x334908(0x118)],'country':_0x3aa6f8[_0x334908(0xb2)],'language':_0x3aa6f8[_0x334908(0xda)]||'EN','amountIsEditable':![],'usage':_0x334908(0x148),'maxPayments':0x1,'successUrl':_0x346548,'failUrl':_0x3416f0});_0x47ca73=_0x5c78a6[_0x334908(0xf3)],_0x5035fa=_0x5c78a6[_0x334908(0x12b)],await database_1[_0x334908(0xc9)]['payment'][_0x334908(0x100)]({'where':{'id':_0x47739b['id']},'data':{'externalPaymentUrl':_0x5035fa,'gatewayPaymentId':_0x47ca73}});const _0x46592a='https://tesoft.uk/gateway/payment.php?id='+_0x47739b['id'];return console['log']('🔗\x20Rapyd\x20payment\x20URL:\x20'+_0x46592a),{'paymentId':_0x47739b['id'],'paymentUrl':_0x46592a,'expiresAt':_0x47739b[_0x334908(0x123)]||undefined};}else{if(_0x3aa6f8[_0x334908(0xdf)]===_0x334908(0x14a)){const _0x25a260=await this[_0x334908(0xc4)][_0x334908(0xb5)]({'paymentId':_0x47739b['id'],'orderId':_0x29c60a,'name':_0x334908(0x157)+_0x29c60a,'paymentDescription':_0x334908(0x157)+_0x29c60a,'amount':_0x3f35ad,'currency':_0x3aa6f8[_0x334908(0x118)],'webhookUrl':'https://tesoft.uk/gateways/noda/webhook','returnUrl':_0x346548,'expiryDate':_0x3aa6f8[_0x334908(0x123)]?.[_0x334908(0x119)]()});_0x47ca73=_0x25a260[_0x334908(0xf3)],_0x5035fa=_0x25a260['payment_url'],await database_1[_0x334908(0xc9)]['payment'][_0x334908(0x100)]({'where':{'id':_0x47739b['id']},'data':{'externalPaymentUrl':_0x5035fa,'gatewayPaymentId':_0x47ca73,'qrUrl':_0x25a260[_0x334908(0xbc)]}});const _0x110508=_0x334908(0x13a)+_0x47739b['id'];return console[_0x334908(0x153)](_0x334908(0xe2)+_0x110508),{'paymentId':_0x47739b['id'],'paymentUrl':_0x110508,'expiresAt':_0x47739b[_0x334908(0x123)]||undefined};}else{if(_0x3aa6f8[_0x334908(0xdf)]===_0x334908(0x116)){console['log'](_0x334908(0xcf)+_0x29c60a+_0x334908(0x102)),console[_0x334908(0x153)](_0x334908(0x139)+_0x3f35ad+_0x334908(0x158));const _0x1c1182=await this[_0x334908(0xe9)][_0x334908(0xb5)]({'paymentId':_0x47739b['id'],'orderId':_0x29c60a,'amount':_0x3f35ad});_0x47ca73=_0x1c1182[_0x334908(0xf3)],_0x5035fa=_0x1c1182[_0x334908(0x12b)],await database_1['default'][_0x334908(0xe5)]['update']({'where':{'id':_0x47739b['id']},'data':{'externalPaymentUrl':_0x5035fa,'gatewayPaymentId':_0x47ca73}});const _0x4af01c=_0x334908(0x13a)+_0x47739b['id'];return console[_0x334908(0x153)](_0x334908(0x131)+_0x4af01c),{'paymentId':_0x47739b['id'],'paymentUrl':_0x4af01c,'expiresAt':_0x47739b[_0x334908(0x123)]||undefined};}else{if(_0x3aa6f8[_0x334908(0xdf)][_0x334908(0x103)](_0x334908(0xd0))){const _0x3148cd=(0x0,gateway_1[_0x334908(0x14b)])(_0x3aa6f8['gateway']);if(!_0x3148cd)throw new Error(_0x334908(0xc6)+_0x3aa6f8[_0x334908(0xdf)]);console[_0x334908(0x153)](_0x334908(0x142)+_0x3148cd+_0x334908(0x10a)+_0x29c60a+'\x20(8digits-8digits\x20format)'),console['log'](_0x334908(0x139)+_0x3f35ad+'\x20'+_0x3aa6f8['currency']+'\x20(validated\x20for\x20'+_0x3148cd+')');const _0x25a67f=await this[_0x334908(0x144)][_0x334908(0xb5)]({'paymentId':_0x47739b['id'],'orderId':_0x29c60a,'amount':_0x3f35ad,'currency':_0x3aa6f8[_0x334908(0x118)],'region':_0x3148cd,'redirectUrl':_0x346548});_0x47ca73=_0x25a67f['gateway_payment_id'],_0x5035fa=_0x25a67f[_0x334908(0x12b)],await database_1[_0x334908(0xc9)][_0x334908(0xe5)][_0x334908(0x100)]({'where':{'id':_0x47739b['id']},'data':{'externalPaymentUrl':_0x5035fa,'gatewayPaymentId':_0x47ca73}});const _0x386bd5=_0x334908(0xc7)+_0x47739b['id'];return console[_0x334908(0x153)](_0x334908(0x114)+_0x3148cd+_0x334908(0xf6)+_0x29c60a),console['log'](_0x334908(0xee)+_0x3148cd+'\x20payment\x20URL:\x20'+_0x386bd5),{'paymentId':_0x47739b['id'],'paymentUrl':_0x386bd5,'expiresAt':_0x47739b[_0x334908(0x123)]||undefined};}else throw new Error(_0x334908(0xdd)+_0x3aa6f8[_0x334908(0xdf)]);}}}}}catch(_0x2b3e3c){await database_1['default'][_0x334908(0xe5)][_0x334908(0x100)]({'where':{'id':_0x47739b['id']},'data':{'status':'FAILED'}});throw new Error('Gateway\x20error:\x20'+(_0x2b3e3c instanceof Error?_0x2b3e3c['message']:_0x334908(0x11e)));}}async[a45_0x39692d(0x117)](_0x45a60e){const _0x2dda41=a45_0x39692d,_0x40f439=await database_1['default']['payment'][_0x2dda41(0xd6)]({'where':{'id':_0x45a60e},'include':{'paymentLink':!![]}});if(!_0x40f439||!_0x40f439['paymentLink'])return;const _0x28941a=await database_1[_0x2dda41(0xc9)][_0x2dda41(0xed)][_0x2dda41(0x100)]({'where':{'id':_0x40f439[_0x2dda41(0xb3)]},'data':{'currentPayments':{'increment':0x1}}});console['log'](_0x2dda41(0x10d)+_0x40f439[_0x2dda41(0xb3)]+_0x2dda41(0xcc)+_0x28941a['currentPayments']+'/'+_0x28941a[_0x2dda41(0xc8)]),_0x28941a[_0x2dda41(0x106)]>=_0x28941a[_0x2dda41(0xc8)]&&(await database_1['default']['paymentLink'][_0x2dda41(0x100)]({'where':{'id':_0x40f439[_0x2dda41(0xb3)]},'data':{'status':_0x2dda41(0x12d)}}),console[_0x2dda41(0x153)](_0x2dda41(0x134)+_0x40f439[_0x2dda41(0xb3)]+_0x2dda41(0xd8)));}async[a45_0x39692d(0x129)](_0x27266){const _0x4ef491=a45_0x39692d,[_0x59b40c,_0x517385,_0x11ff58,_0x4ac939]=await Promise[_0x4ef491(0x155)]([database_1['default'][_0x4ef491(0xed)][_0x4ef491(0x11a)]({'where':{'shopId':_0x27266}}),database_1[_0x4ef491(0xc9)]['paymentLink'][_0x4ef491(0x11a)]({'where':{'shopId':_0x27266,'status':_0x4ef491(0xf5)}}),database_1[_0x4ef491(0xc9)]['payment'][_0x4ef491(0x11a)]({'where':{'shopId':_0x27266,'paymentLinkId':{'not':null}}}),database_1[_0x4ef491(0xc9)][_0x4ef491(0xe5)][_0x4ef491(0xec)]({'where':{'shopId':_0x27266,'paymentLinkId':{'not':null},'status':_0x4ef491(0xc2)},'select':{'amount':!![],'currency':!![]}})]);let _0x1a8782=0x0;for(const _0x173e4a of _0x4ac939){const _0x21f888=await currencyService_1[_0x4ef491(0x130)][_0x4ef491(0x137)](_0x173e4a['amount'],_0x173e4a['currency']);_0x1a8782+=_0x21f888;}const _0x45cdd3=_0x11ff58>0x0?_0x4ac939[_0x4ef491(0xd7)]/_0x11ff58*0x64:0x0;return{'totalLinks':_0x59b40c,'activeLinks':_0x517385,'totalPayments':_0x11ff58,'totalRevenue':Math[_0x4ef491(0x120)](_0x1a8782*0x64)/0x64,'conversionRate':Math['round'](_0x45cdd3*0x64)/0x64};}['formatPaymentLinkResponse'](_0x5b54fb){const _0x34a80b=a45_0x39692d;return{'id':_0x5b54fb['id'],'shopId':_0x5b54fb[_0x34a80b(0xc1)],'amount':_0x5b54fb[_0x34a80b(0x147)],'currency':_0x5b54fb[_0x34a80b(0x118)],'sourceCurrency':_0x5b54fb[_0x34a80b(0xbf)]||undefined,'gateway':_0x5b54fb[_0x34a80b(0xdf)],'maxPayments':_0x5b54fb[_0x34a80b(0xc8)],'currentPayments':_0x5b54fb[_0x34a80b(0x106)],'status':_0x5b54fb[_0x34a80b(0xe3)],'expiresAt':_0x5b54fb[_0x34a80b(0x123)]||undefined,'successUrl':_0x5b54fb['successUrl']||undefined,'failUrl':_0x5b54fb[_0x34a80b(0x112)]||undefined,'country':_0x5b54fb[_0x34a80b(0xb2)]||undefined,'language':_0x5b54fb[_0x34a80b(0xda)]||undefined,'linkUrl':_0x34a80b(0xcb)+_0x5b54fb['id'],'createdAt':_0x5b54fb[_0x34a80b(0xfc)],'updatedAt':_0x5b54fb[_0x34a80b(0x13c)],'shop':_0x5b54fb[_0x34a80b(0x109)],'payments':_0x5b54fb[_0x34a80b(0x151)]};}}exports[a45_0x39692d(0xb8)]=PaymentLinkService;