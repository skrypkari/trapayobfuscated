'use strict';const a45_0x51eebe=a45_0x3aaa;(function(_0x44f81e,_0x5385de){const _0x4d07a3=a45_0x3aaa,_0x2318d8=_0x44f81e();while(!![]){try{const _0x4ea49e=parseInt(_0x4d07a3(0x224))/0x1*(-parseInt(_0x4d07a3(0x1fe))/0x2)+parseInt(_0x4d07a3(0x1ff))/0x3+-parseInt(_0x4d07a3(0x1bf))/0x4*(-parseInt(_0x4d07a3(0x214))/0x5)+-parseInt(_0x4d07a3(0x226))/0x6+parseInt(_0x4d07a3(0x211))/0x7+parseInt(_0x4d07a3(0x1ac))/0x8+-parseInt(_0x4d07a3(0x240))/0x9;if(_0x4ea49e===_0x5385de)break;else _0x2318d8['push'](_0x2318d8['shift']());}catch(_0x349a5f){_0x2318d8['push'](_0x2318d8['shift']());}}}(a45_0x5a16,0x84bed));var __importDefault=this&&this['__importDefault']||function(_0x3ee5a7){const _0x2bf380=a45_0x3aaa;return _0x3ee5a7&&_0x3ee5a7[_0x2bf380(0x1c4)]?_0x3ee5a7:{'default':_0x3ee5a7};};Object[a45_0x51eebe(0x260)](exports,a45_0x51eebe(0x1c4),{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require(a45_0x51eebe(0x1c1))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a45_0x51eebe(0x1f7)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require('./gateways/klymeService'),gateway_1=require(a45_0x51eebe(0x1f9)),currencyService_1=require(a45_0x51eebe(0x1b1));function a45_0x3aaa(_0x717049,_0x5dbac8){const _0x5a1640=a45_0x5a16();return a45_0x3aaa=function(_0x3aaaeb,_0x194b4a){_0x3aaaeb=_0x3aaaeb-0x1a4;let _0x163e71=_0x5a1640[_0x3aaaeb];return _0x163e71;},a45_0x3aaa(_0x717049,_0x5dbac8);}class PaymentLinkService{constructor(){const _0x2fcb95=a45_0x51eebe;this[_0x2fcb95(0x1db)]=new plisioService_1[(_0x2fcb95(0x231))](),this['rapydService']=new rapydService_1[(_0x2fcb95(0x213))](),this['nodaService']=new nodaService_1[(_0x2fcb95(0x1f5))](),this[_0x2fcb95(0x23a)]=new coinToPayService_1[(_0x2fcb95(0x262))](),this[_0x2fcb95(0x1d5)]=new klymeService_1[(_0x2fcb95(0x263))]();}['generateGatewayOrderId'](){const _0x23b31a=()=>{const _0x162332=a45_0x3aaa;return Math['floor'](Math[_0x162332(0x252)]()*0x5f5e100)['toString']()[_0x162332(0x1d9)](0x8,'0');};return _0x23b31a()+'-'+_0x23b31a();}['generateGatewayUrls'](_0x4ddbd8,_0x1c3ad0,_0x3bc54f,_0x299873,_0x1e9511){const _0x493853=a45_0x51eebe;if(_0x299873&&_0x1e9511)return{'finalSuccessUrl':_0x299873,'finalFailUrl':_0x1e9511,'dbSuccessUrl':_0x299873,'dbFailUrl':_0x1e9511};let _0x23610d,_0x1111c7,_0x1907bd,_0xad28a8;return _0x4ddbd8===_0x493853(0x1d0)||_0x4ddbd8[_0x493853(0x1e1)](_0x493853(0x1f0))||_0x4ddbd8===_0x493853(0x249)?(_0x23610d=_0x3bc54f+'/gateway/pending.php?id='+_0x1c3ad0,_0x1907bd='https://app.trapay.uk/payment/pending?id='+_0x1c3ad0):(_0x23610d=_0x3bc54f+_0x493853(0x24c)+_0x1c3ad0,_0x1907bd='https://app.trapay.uk/payment/success?id='+_0x1c3ad0),_0x1111c7=_0x3bc54f+_0x493853(0x1bd)+_0x1c3ad0,_0xad28a8=_0x493853(0x1ad)+_0x1c3ad0,console[_0x493853(0x1bc)](_0x493853(0x20a)+_0x4ddbd8+_0x493853(0x216)+_0x1c3ad0+':'),console[_0x493853(0x1bc)](_0x493853(0x219)+_0x23610d),console[_0x493853(0x1bc)](_0x493853(0x21e)+_0x1111c7),console[_0x493853(0x1bc)]('\x20\x20\x20üíæ\x20DB\x20Success\x20URL:\x20'+_0x1907bd),console['log'](_0x493853(0x239)+_0xad28a8),{'finalSuccessUrl':_0x23610d,'finalFailUrl':_0x1111c7,'dbSuccessUrl':_0x1907bd,'dbFailUrl':_0xad28a8};}[a45_0x51eebe(0x1a6)](_0x2e79f0,_0x2cd2b2){const _0x4eca5f=a45_0x51eebe;if(!_0x2e79f0[_0x4eca5f(0x1e1)](_0x4eca5f(0x1f0)))return;const _0x1806c6=(0x0,gateway_1[_0x4eca5f(0x1e2)])(_0x2e79f0),_0x5325ce=_0x2cd2b2[_0x4eca5f(0x1c6)]();switch(_0x1806c6){case'EU':if(_0x5325ce!=='EUR')throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x5325ce);break;case'GB':if(_0x5325ce!==_0x4eca5f(0x217))throw new Error(_0x4eca5f(0x1b0)+_0x5325ce);break;case'DE':if(_0x5325ce!==_0x4eca5f(0x242))throw new Error(_0x4eca5f(0x1e0)+_0x5325ce);break;default:throw new Error(_0x4eca5f(0x1ce)+_0x1806c6);}}async[a45_0x51eebe(0x235)](_0x3d680a,_0x30792d){const _0x5d518b=a45_0x51eebe;console[_0x5d518b(0x1bc)](_0x5d518b(0x1e8)+_0x3d680a+':\x20'+_0x30792d);const _0xd8c07b=await database_1[_0x5d518b(0x1a4)][_0x5d518b(0x233)][_0x5d518b(0x23e)]({'where':{'id':_0x3d680a},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0xd8c07b)throw new Error(_0x5d518b(0x257));let _0x576417=[];if(_0xd8c07b[_0x5d518b(0x1cc)])try{_0x576417=JSON[_0x5d518b(0x25b)](_0xd8c07b[_0x5d518b(0x1cc)]),console['log'](_0x5d518b(0x1e6)+_0xd8c07b['username']+_0x5d518b(0x241),_0x576417);}catch(_0x5e15d4){console[_0x5d518b(0x24a)](_0x5d518b(0x1c9),_0x5e15d4),_0x576417=[_0x5d518b(0x1ee)];}else _0x576417=[_0x5d518b(0x1ee)],console[_0x5d518b(0x1bc)](_0x5d518b(0x1e6)+_0xd8c07b[_0x5d518b(0x1bb)]+_0x5d518b(0x1f3),_0x576417);const _0x27f2ae=this[_0x5d518b(0x218)](_0x30792d);console[_0x5d518b(0x1bc)]('üîê\x20Checking\x20if\x20\x22'+_0x27f2ae+'\x22\x20is\x20in\x20enabled\x20gateways:',_0x576417);if(!_0x576417[_0x5d518b(0x20b)](_0x27f2ae)){console[_0x5d518b(0x24a)](_0x5d518b(0x209)+_0x27f2ae+_0x5d518b(0x206)+_0xd8c07b['username']),console[_0x5d518b(0x24a)]('‚ùå\x20Enabled\x20gateways:\x20'+_0x576417[_0x5d518b(0x1b9)](',\x20'));throw new Error('Gateway\x20\x22'+_0x27f2ae+'\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20'+(_0x5d518b(0x1cd)+_0x576417[_0x5d518b(0x1b9)](',\x20')+'.\x20')+'Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.');}console[_0x5d518b(0x1bc)](_0x5d518b(0x264)+_0x27f2ae+'\x22\x20is\x20allowed\x20for\x20shop\x20'+_0xd8c07b[_0x5d518b(0x1bb)]);}[a45_0x51eebe(0x218)](_0x57cfab){const _0x5e1014=a45_0x51eebe,_0x534f43={'plisio':_0x5e1014(0x1ee),'rapyd':'Rapyd','noda':'Noda','cointopay':'CoinToPay','klyme_eu':_0x5e1014(0x25e),'klyme_gb':'KLYME\x20GB','klyme_de':'KLYME\x20DE'};return _0x534f43[_0x57cfab]||_0x57cfab;}async[a45_0x51eebe(0x1f8)](_0x7da0b9,_0x700074){const _0x22e96e=a45_0x51eebe;if(!(0x0,gateway_1[_0x22e96e(0x201)])(_0x700074[_0x22e96e(0x243)]))throw new Error(_0x22e96e(0x24b)+_0x700074[_0x22e96e(0x243)]+_0x22e96e(0x1d6));const _0x4facce=(0x0,gateway_1[_0x22e96e(0x1aa)])(_0x700074[_0x22e96e(0x243)]);if(!_0x4facce)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x700074[_0x22e96e(0x243)]);console[_0x22e96e(0x1bc)](_0x22e96e(0x1de)+_0x4facce),await this[_0x22e96e(0x235)](_0x7da0b9,_0x4facce);if(_0x4facce==='plisio'&&!_0x700074[_0x22e96e(0x1fa)])throw new Error(_0x22e96e(0x237));if(_0x4facce['startsWith'](_0x22e96e(0x1f0))){const _0x2c6a04=(0x0,gateway_1[_0x22e96e(0x1e2)])(_0x4facce);console[_0x22e96e(0x1bc)](_0x22e96e(0x1fc)+_0x2c6a04+'\x20payment\x20link');}let _0x3e8903=_0x700074['country'];_0x4facce==='rapyd'&&(_0x3e8903='GB',console[_0x22e96e(0x1bc)]('üá¨üáß\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link'));if(!_0x700074['amount']||_0x700074[_0x22e96e(0x212)]<=0x0)throw new Error(_0x22e96e(0x1d7));let _0x125870=_0x700074[_0x22e96e(0x1e9)]||_0x22e96e(0x236);_0x4facce===_0x22e96e(0x249)&&(_0x125870=_0x22e96e(0x242),console[_0x22e96e(0x1bc)](_0x22e96e(0x23f)));this[_0x22e96e(0x1a6)](_0x4facce,_0x125870);const _0x571020=await database_1[_0x22e96e(0x1a4)][_0x22e96e(0x203)][_0x22e96e(0x205)]({'data':{'shopId':_0x7da0b9,'amount':_0x700074[_0x22e96e(0x212)],'currency':_0x125870,'sourceCurrency':_0x700074[_0x22e96e(0x1fa)]||undefined,'gateway':_0x4facce,'maxPayments':_0x700074[_0x22e96e(0x1f1)]||0x1,'currentPayments':0x0,'status':_0x22e96e(0x24f),'expiresAt':_0x700074[_0x22e96e(0x1da)]?new Date(_0x700074[_0x22e96e(0x1da)]):undefined,'successUrl':_0x700074[_0x22e96e(0x21a)]||null,'failUrl':_0x700074[_0x22e96e(0x261)]||null,'country':_0x3e8903,'language':_0x700074['language']||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console['log'](_0x22e96e(0x255)+_0x571020['id']+'\x20('+_0x4facce+')'),console[_0x22e96e(0x1bc)](_0x22e96e(0x215)+_0x571020[_0x22e96e(0x212)]+'\x20'+_0x571020[_0x22e96e(0x1e9)]),console[_0x22e96e(0x1bc)]('üîó\x20Link\x20URL:\x20https://app.trapay.uk/link/'+_0x571020['id']),console[_0x22e96e(0x1bc)](_0x22e96e(0x1a5)),this[_0x22e96e(0x24d)](_0x571020);}async[a45_0x51eebe(0x1a9)](_0x19624a,_0x316b63){const _0x3786ec=a45_0x51eebe,{page:_0x206818,limit:_0x4b411c,status:_0x397970,gateway:_0x4a0e2e,search:_0x46b1c8}=_0x316b63,_0x526994=(_0x206818-0x1)*_0x4b411c,_0x523212={'shopId':_0x19624a};_0x397970&&(_0x523212[_0x3786ec(0x20e)]=_0x397970['toUpperCase']());if(_0x4a0e2e){if((0x0,gateway_1[_0x3786ec(0x201)])(_0x4a0e2e)){const _0x2438ff=(0x0,gateway_1[_0x3786ec(0x1aa)])(_0x4a0e2e);_0x2438ff&&(_0x523212[_0x3786ec(0x243)]=_0x2438ff);}else _0x523212['gateway']=_0x4a0e2e[_0x3786ec(0x1b5)]();}_0x46b1c8&&(_0x523212['OR']=[{'gateway':{'contains':_0x46b1c8,'mode':_0x3786ec(0x1ec)}},{'currency':{'contains':_0x46b1c8,'mode':_0x3786ec(0x1ec)}}]);const [_0x1555b,_0x8d1ec1]=await Promise['all']([database_1['default'][_0x3786ec(0x203)]['findMany']({'where':_0x523212,'skip':_0x526994,'take':_0x4b411c,'orderBy':{'createdAt':_0x3786ec(0x208)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x3786ec(0x208)},'take':0xa}}}),database_1[_0x3786ec(0x1a4)][_0x3786ec(0x203)]['count']({'where':_0x523212})]);return{'links':_0x1555b[_0x3786ec(0x1ca)](_0x234366=>this[_0x3786ec(0x24d)](_0x234366)),'pagination':{'page':_0x206818,'limit':_0x4b411c,'total':_0x8d1ec1,'totalPages':Math[_0x3786ec(0x1cf)](_0x8d1ec1/_0x4b411c)}};}async[a45_0x51eebe(0x254)](_0x5e0bbc,_0x407fbc){const _0x3e8078=a45_0x51eebe,_0x5b1da3=await database_1[_0x3e8078(0x1a4)][_0x3e8078(0x203)][_0x3e8078(0x1d1)]({'where':{'id':_0x407fbc,'shopId':_0x5e0bbc},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x3e8078(0x208)}}}});if(!_0x5b1da3)return null;return this[_0x3e8078(0x24d)](_0x5b1da3);}async[a45_0x51eebe(0x1b3)](_0x4196f7,_0x5911f9,_0x7f4337){const _0xf6812d=a45_0x51eebe,_0x3682cc={..._0x7f4337};if(_0x7f4337[_0xf6812d(0x243)]){if((0x0,gateway_1['isValidGatewayId'])(_0x7f4337[_0xf6812d(0x243)])){const _0x5c231c=(0x0,gateway_1['getGatewayNameById'])(_0x7f4337[_0xf6812d(0x243)]);_0x5c231c&&(await this[_0xf6812d(0x235)](_0x4196f7,_0x5c231c),_0x3682cc[_0xf6812d(0x243)]=_0x5c231c);}else _0x3682cc[_0xf6812d(0x243)]=_0x7f4337['gateway'][_0xf6812d(0x1b5)]();}(_0x3682cc[_0xf6812d(0x243)]===_0xf6812d(0x1b7)||_0x7f4337['country']&&_0x3682cc[_0xf6812d(0x243)]!==_0xf6812d(0x1b7))&&(_0x3682cc[_0xf6812d(0x243)]===_0xf6812d(0x1b7)&&(_0x3682cc[_0xf6812d(0x1f2)]='GB',console[_0xf6812d(0x1bc)](_0xf6812d(0x222))));_0x3682cc[_0xf6812d(0x243)]===_0xf6812d(0x249)&&(_0x3682cc[_0xf6812d(0x1e9)]=_0xf6812d(0x242),console['log']('ü™ô\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update'));_0x3682cc[_0xf6812d(0x243)]&&_0x3682cc[_0xf6812d(0x1e9)]&&this['validateKlymeCurrency'](_0x3682cc[_0xf6812d(0x243)],_0x3682cc[_0xf6812d(0x1e9)]);_0x7f4337['expiresAt']&&(_0x3682cc[_0xf6812d(0x1da)]=new Date(_0x7f4337['expiresAt']));const _0x22f35f=await database_1[_0xf6812d(0x1a4)]['paymentLink']['update']({'where':{'id':_0x5911f9,'shopId':_0x4196f7},'data':_0x3682cc,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0xf6812d(0x208)},'take':0xa}}});return this[_0xf6812d(0x24d)](_0x22f35f);}async[a45_0x51eebe(0x246)](_0x27af9e,_0x16b23b){const _0x3d574f=a45_0x51eebe;await database_1[_0x3d574f(0x1a4)][_0x3d574f(0x203)]['delete']({'where':{'id':_0x16b23b,'shopId':_0x27af9e}});}async[a45_0x51eebe(0x258)](_0x1cb200){const _0x31b66b=a45_0x51eebe,_0x6c4b82=await database_1[_0x31b66b(0x1a4)][_0x31b66b(0x203)][_0x31b66b(0x23e)]({'where':{'id':_0x1cb200},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x6c4b82)return null;const _0x119620=_0x6c4b82[_0x31b66b(0x1da)]&&_0x6c4b82[_0x31b66b(0x1da)]<new Date(),_0x196362=_0x6c4b82[_0x31b66b(0x1df)]>=_0x6c4b82[_0x31b66b(0x1f1)],_0x55b2f1=_0x6c4b82[_0x31b66b(0x233)]['status']===_0x31b66b(0x24f),_0x11308d=_0x6c4b82['status']===_0x31b66b(0x24f),_0x2f3b35=!_0x119620&&!_0x196362&&_0x55b2f1&&_0x11308d,_0x16f8c9=Math['max'](0x0,_0x6c4b82['maxPayments']-_0x6c4b82[_0x31b66b(0x1df)]);return{'id':_0x6c4b82['id'],'amount':_0x6c4b82['amount'],'currency':_0x6c4b82[_0x31b66b(0x1e9)],'sourceCurrency':_0x6c4b82[_0x31b66b(0x1fa)]||undefined,'gateway':_0x6c4b82[_0x31b66b(0x243)],'maxPayments':_0x6c4b82['maxPayments'],'currentPayments':_0x6c4b82['currentPayments'],'status':_0x6c4b82[_0x31b66b(0x20e)],'expiresAt':_0x6c4b82['expiresAt']||undefined,'shopName':_0x6c4b82['shop'][_0x31b66b(0x266)],'isAvailable':_0x2f3b35,'remainingPayments':_0x16f8c9};}async[a45_0x51eebe(0x21d)](_0x24bc5f){const _0x57dafd=a45_0x51eebe,{linkId:_0x56730e,customerEmail:_0x30a7de,customerName:_0x23880b}=_0x24bc5f,_0x52a9d5=await database_1[_0x57dafd(0x1a4)]['paymentLink'][_0x57dafd(0x23e)]({'where':{'id':_0x56730e},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x52a9d5)throw new Error(_0x57dafd(0x256));const _0x367488=_0x52a9d5['expiresAt']&&_0x52a9d5[_0x57dafd(0x1da)]<new Date(),_0x2cf745=_0x52a9d5['currentPayments']>=_0x52a9d5[_0x57dafd(0x1f1)],_0x2c2b67=_0x52a9d5[_0x57dafd(0x233)]['status']===_0x57dafd(0x24f),_0x5d60ce=_0x52a9d5['status']===_0x57dafd(0x24f);if(_0x367488)throw new Error(_0x57dafd(0x20d));if(_0x2cf745)throw new Error(_0x57dafd(0x20f));if(!_0x2c2b67)throw new Error(_0x57dafd(0x1a7));if(!_0x5d60ce)throw new Error(_0x57dafd(0x22b));await this['checkGatewayPermission'](_0x52a9d5[_0x57dafd(0x1fb)],_0x52a9d5[_0x57dafd(0x243)]);const _0x513030=_0x52a9d5['amount'];console[_0x57dafd(0x1bc)](_0x57dafd(0x1ba)+_0x56730e+':\x20'+_0x513030+'\x20'+_0x52a9d5['currency']),console[_0x57dafd(0x1bc)](_0x57dafd(0x20c)+(_0x23880b||'Anonymous')+'\x20('+(_0x30a7de||_0x57dafd(0x230))+')'),this[_0x57dafd(0x1a6)](_0x52a9d5[_0x57dafd(0x243)],_0x52a9d5['currency']);const _0x3fc53c=this[_0x57dafd(0x210)]();console[_0x57dafd(0x1bc)]('üéØ\x20Generated\x20gateway\x20order_id:\x20'+_0x3fc53c+_0x57dafd(0x1b6)+_0x52a9d5[_0x57dafd(0x243)]+')');const _0x2af376=await database_1[_0x57dafd(0x1a4)]['payment'][_0x57dafd(0x205)]({'data':{'shopId':_0x52a9d5[_0x57dafd(0x1fb)],'paymentLinkId':_0x52a9d5['id'],'gateway':_0x52a9d5[_0x57dafd(0x243)],'amount':_0x513030,'currency':_0x52a9d5['currency'],'sourceCurrency':_0x52a9d5['sourceCurrency']||undefined,'usage':_0x57dafd(0x1c2),'expiresAt':_0x52a9d5['expiresAt']||undefined,'successUrl':_0x57dafd(0x25a),'failUrl':_0x57dafd(0x25a),'status':_0x57dafd(0x221),'orderId':null,'gatewayOrderId':_0x3fc53c,'customerEmail':_0x30a7de||undefined,'customerName':_0x23880b||undefined,'country':_0x52a9d5[_0x57dafd(0x1f2)]||undefined,'language':_0x52a9d5[_0x57dafd(0x23d)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x57dafd(0x1bc)](_0x57dafd(0x1c3)+_0x2af376['id']);const _0x4a90c6=process[_0x57dafd(0x253)][_0x57dafd(0x200)]||'https://tesoft.uk',{finalSuccessUrl:_0x2159ad,finalFailUrl:_0x2c4f8e,dbSuccessUrl:_0x30a5b5,dbFailUrl:_0x3ccee2}=this[_0x57dafd(0x207)](_0x52a9d5['gateway'],_0x2af376['id'],_0x4a90c6,_0x52a9d5['successUrl']||undefined,_0x52a9d5[_0x57dafd(0x261)]||undefined);await database_1[_0x57dafd(0x1a4)][_0x57dafd(0x25f)][_0x57dafd(0x1af)]({'where':{'id':_0x2af376['id']},'data':{'successUrl':_0x30a5b5,'failUrl':_0x3ccee2}}),console[_0x57dafd(0x1bc)](_0x57dafd(0x22f)+_0x513030+'\x20'+_0x52a9d5[_0x57dafd(0x1e9)]),console[_0x57dafd(0x1bc)]('üë§\x20Customer:\x20'+(_0x23880b||_0x57dafd(0x1c0))+'\x20('+(_0x30a7de||'no\x20email')+')'),console[_0x57dafd(0x1bc)]('üíæ\x20DB\x20Success\x20URL:\x20'+_0x30a5b5),console[_0x57dafd(0x1bc)]('üíæ\x20DB\x20Fail\x20URL:\x20'+_0x3ccee2);let _0x589481,_0x55906c;try{if(_0x52a9d5['gateway']===_0x57dafd(0x1b2)){console[_0x57dafd(0x1bc)](_0x57dafd(0x24e)),console[_0x57dafd(0x1bc)](_0x57dafd(0x202)+_0x52a9d5[_0x57dafd(0x1e9)]),console[_0x57dafd(0x1bc)]('\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20'+_0x52a9d5[_0x57dafd(0x1fa)]);const _0x3de3de=await this[_0x57dafd(0x1db)][_0x57dafd(0x1f6)]({'paymentId':_0x2af376['id'],'orderId':_0x3fc53c,'amount':_0x513030,'currency':_0x52a9d5[_0x57dafd(0x1e9)],'productName':'Payment\x20'+_0x513030+'\x20'+_0x52a9d5[_0x57dafd(0x1e9)],'description':'Payment\x20'+_0x513030+'\x20'+_0x52a9d5['currency'],'successUrl':_0x2159ad,'failUrl':_0x2c4f8e,'customerEmail':_0x30a7de||undefined,'customerName':_0x23880b||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x52a9d5[_0x57dafd(0x1fa)]||undefined});_0x589481=_0x3de3de[_0x57dafd(0x1d4)],_0x55906c=_0x3de3de['payment_url'],await database_1['default'][_0x57dafd(0x25f)][_0x57dafd(0x1af)]({'where':{'id':_0x2af376['id']},'data':{'externalPaymentUrl':_0x55906c,'gatewayPaymentId':_0x589481,'invoiceTotalSum':Number(_0x3de3de[_0x57dafd(0x244)]),'qrCode':_0x3de3de[_0x57dafd(0x238)],'qrUrl':_0x3de3de[_0x57dafd(0x228)]}});const _0x4456ea=_0x57dafd(0x225)+_0x2af376['id'];return console[_0x57dafd(0x1bc)](_0x57dafd(0x22d)+_0x4456ea),{'paymentId':_0x2af376['id'],'paymentUrl':_0x4456ea,'expiresAt':_0x2af376['expiresAt']||undefined};}else{if(_0x52a9d5[_0x57dafd(0x243)]===_0x57dafd(0x1b7)){const _0x348509=await this[_0x57dafd(0x1d8)][_0x57dafd(0x1f8)]({'paymentId':_0x2af376['id'],'orderId':_0x3fc53c,'orderName':_0x57dafd(0x232)+_0x513030+'\x20'+_0x52a9d5['currency'],'amount':_0x513030,'currency':_0x52a9d5[_0x57dafd(0x1e9)],'country':_0x52a9d5[_0x57dafd(0x1f2)],'language':_0x52a9d5[_0x57dafd(0x23d)]||'EN','amountIsEditable':![],'usage':'ONCE','maxPayments':0x1,'successUrl':_0x2159ad,'failUrl':_0x2c4f8e});_0x589481=_0x348509[_0x57dafd(0x1d4)],_0x55906c=_0x348509[_0x57dafd(0x21f)],await database_1['default'][_0x57dafd(0x25f)][_0x57dafd(0x1af)]({'where':{'id':_0x2af376['id']},'data':{'externalPaymentUrl':_0x55906c,'gatewayPaymentId':_0x589481}});const _0x291889='https://tesoft.uk/gateway/payment.php?id='+_0x2af376['id'];return console[_0x57dafd(0x1bc)](_0x57dafd(0x248)+_0x291889),{'paymentId':_0x2af376['id'],'paymentUrl':_0x291889,'expiresAt':_0x2af376[_0x57dafd(0x1da)]||undefined};}else{if(_0x52a9d5[_0x57dafd(0x243)]===_0x57dafd(0x1d0)){const _0x5b919e=await this[_0x57dafd(0x229)][_0x57dafd(0x1f8)]({'paymentId':_0x2af376['id'],'orderId':_0x3fc53c,'name':_0x57dafd(0x232)+_0x513030+'\x20'+_0x52a9d5[_0x57dafd(0x1e9)],'paymentDescription':_0x57dafd(0x232)+_0x513030+'\x20'+_0x52a9d5[_0x57dafd(0x1e9)],'amount':_0x513030,'currency':_0x52a9d5[_0x57dafd(0x1e9)],'webhookUrl':_0x57dafd(0x1dd),'returnUrl':_0x2159ad,'expiryDate':_0x52a9d5[_0x57dafd(0x1da)]?.['toISOString']()});_0x589481=_0x5b919e[_0x57dafd(0x1d4)],_0x55906c=_0x5b919e[_0x57dafd(0x21f)],await database_1['default']['payment']['update']({'where':{'id':_0x2af376['id']},'data':{'externalPaymentUrl':_0x55906c,'gatewayPaymentId':_0x589481,'qrUrl':_0x5b919e[_0x57dafd(0x1fd)]}});const _0x3aa607=_0x57dafd(0x259)+_0x2af376['id'];return console[_0x57dafd(0x1bc)]('üîó\x20Noda\x20payment\x20URL:\x20'+_0x3aa607),{'paymentId':_0x2af376['id'],'paymentUrl':_0x3aa607,'expiresAt':_0x2af376[_0x57dafd(0x1da)]||undefined};}else{if(_0x52a9d5[_0x57dafd(0x243)]==='cointopay'){console[_0x57dafd(0x1bc)](_0x57dafd(0x25c)+_0x3fc53c+'\x20(8digits-8digits\x20format)'),console[_0x57dafd(0x1bc)](_0x57dafd(0x22f)+_0x513030+_0x57dafd(0x1a8));const _0x55068e=await this[_0x57dafd(0x23a)]['createPaymentLink']({'paymentId':_0x2af376['id'],'orderId':_0x3fc53c,'amount':_0x513030});_0x589481=_0x55068e['gateway_payment_id'],_0x55906c=_0x55068e['payment_url'],await database_1[_0x57dafd(0x1a4)][_0x57dafd(0x25f)][_0x57dafd(0x1af)]({'where':{'id':_0x2af376['id']},'data':{'externalPaymentUrl':_0x55906c,'gatewayPaymentId':_0x589481}});const _0x40c900='https://tesoft.uk/gateway/payment.php?id='+_0x2af376['id'];return console[_0x57dafd(0x1bc)](_0x57dafd(0x1ea)+_0x40c900),{'paymentId':_0x2af376['id'],'paymentUrl':_0x40c900,'expiresAt':_0x2af376[_0x57dafd(0x1da)]||undefined};}else{if(_0x52a9d5['gateway'][_0x57dafd(0x1e1)](_0x57dafd(0x1f0))){const _0x470172=(0x0,gateway_1[_0x57dafd(0x1e2)])(_0x52a9d5[_0x57dafd(0x243)]);if(!_0x470172)throw new Error(_0x57dafd(0x1e4)+_0x52a9d5[_0x57dafd(0x243)]);console[_0x57dafd(0x1bc)](_0x57dafd(0x1fc)+_0x470172+_0x57dafd(0x234)+_0x3fc53c+_0x57dafd(0x1ae)),console[_0x57dafd(0x1bc)](_0x57dafd(0x22f)+_0x513030+'\x20'+_0x52a9d5['currency']+_0x57dafd(0x227)+_0x470172+')');const _0x1ce7c9=await this[_0x57dafd(0x1d5)][_0x57dafd(0x1f8)]({'paymentId':_0x2af376['id'],'orderId':_0x3fc53c,'amount':_0x513030,'currency':_0x52a9d5[_0x57dafd(0x1e9)],'region':_0x470172,'redirectUrl':_0x2159ad});_0x589481=_0x1ce7c9[_0x57dafd(0x1d4)],_0x55906c=_0x1ce7c9[_0x57dafd(0x21f)],await database_1[_0x57dafd(0x1a4)][_0x57dafd(0x25f)][_0x57dafd(0x1af)]({'where':{'id':_0x2af376['id']},'data':{'externalPaymentUrl':_0x55906c,'gatewayPaymentId':_0x589481}});const _0x3245c0=_0x57dafd(0x225)+_0x2af376['id'];return console[_0x57dafd(0x1bc)]('‚úÖ\x20KLYME\x20'+_0x470172+'\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20'+_0x3fc53c),console[_0x57dafd(0x1bc)]('üîó\x20KLYME\x20'+_0x470172+_0x57dafd(0x1d2)+_0x3245c0),{'paymentId':_0x2af376['id'],'paymentUrl':_0x3245c0,'expiresAt':_0x2af376[_0x57dafd(0x1da)]||undefined};}else throw new Error(_0x57dafd(0x23c)+_0x52a9d5[_0x57dafd(0x243)]);}}}}}catch(_0x425e7b){await database_1[_0x57dafd(0x1a4)][_0x57dafd(0x25f)]['update']({'where':{'id':_0x2af376['id']},'data':{'status':_0x57dafd(0x1c7)}});throw new Error('Gateway\x20error:\x20'+(_0x425e7b instanceof Error?_0x425e7b['message']:_0x57dafd(0x1c8)));}}async[a45_0x51eebe(0x1be)](_0x1b3f0d){const _0x3e825d=a45_0x51eebe;console[_0x3e825d(0x1bc)](_0x3e825d(0x251)+_0x1b3f0d);const _0x4d9b25=await database_1[_0x3e825d(0x1a4)][_0x3e825d(0x25f)]['findUnique']({'where':{'id':_0x1b3f0d},'include':{'paymentLink':!![]}});if(!_0x4d9b25||!_0x4d9b25[_0x3e825d(0x203)]){console[_0x3e825d(0x1bc)]('üìà\x20Payment\x20'+_0x1b3f0d+_0x3e825d(0x1e3));return;}if(_0x4d9b25[_0x3e825d(0x20e)]!==_0x3e825d(0x1b4)){console['log'](_0x3e825d(0x21c)+_0x1b3f0d+'\x20status\x20is\x20'+_0x4d9b25[_0x3e825d(0x20e)]+_0x3e825d(0x23b));return;}if(!_0x4d9b25[_0x3e825d(0x204)]){console[_0x3e825d(0x1bc)](_0x3e825d(0x21c)+_0x1b3f0d+_0x3e825d(0x1eb));return;}try{const _0x1e2b02=await database_1[_0x3e825d(0x1a4)][_0x3e825d(0x1f4)](async _0x12cf7b=>{const _0x272b52=_0x3e825d,_0x106b79=await _0x12cf7b[_0x272b52(0x203)][_0x272b52(0x23e)]({'where':{'id':_0x4d9b25[_0x272b52(0x21b)]},'select':{'id':!![],'currentPayments':!![],'maxPayments':!![],'status':!![]}});if(!_0x106b79)throw new Error('Payment\x20link\x20'+_0x4d9b25[_0x272b52(0x21b)]+_0x272b52(0x1b8));if(_0x106b79[_0x272b52(0x1df)]>=_0x106b79[_0x272b52(0x1f1)])return console[_0x272b52(0x1bc)](_0x272b52(0x220)+_0x4d9b25[_0x272b52(0x21b)]+'\x20already\x20at\x20max\x20payments\x20('+_0x106b79['currentPayments']+'/'+_0x106b79[_0x272b52(0x1f1)]+_0x272b52(0x250)),_0x106b79;const _0x354716=await _0x12cf7b['payment']['count']({'where':{'paymentLinkId':_0x4d9b25[_0x272b52(0x21b)],'status':_0x272b52(0x1b4),'paidAt':{'not':null},'id':{'not':_0x1b3f0d}}}),_0x4c676c=_0x354716+0x1,_0x14b6c6=await _0x12cf7b[_0x272b52(0x203)][_0x272b52(0x1af)]({'where':{'id':_0x4d9b25[_0x272b52(0x21b)]},'data':{'currentPayments':_0x4c676c,'status':_0x4c676c>=_0x106b79[_0x272b52(0x1f1)]?'COMPLETED':_0x106b79['status']}});return console[_0x272b52(0x1bc)](_0x272b52(0x220)+_0x4d9b25['paymentLinkId']+_0x272b52(0x22a)+_0x106b79['currentPayments']+_0x272b52(0x25d)+_0x4c676c+'/'+_0x106b79[_0x272b52(0x1f1)]),_0x14b6c6;});_0x1e2b02['status']===_0x3e825d(0x245)&&console['log'](_0x3e825d(0x22c)+_0x4d9b25[_0x3e825d(0x21b)]+_0x3e825d(0x265)+_0x1e2b02['currentPayments']+'/'+_0x1e2b02[_0x3e825d(0x1f1)]+')');}catch(_0x160554){console['error'](_0x3e825d(0x1cb)+_0x1b3f0d+':',_0x160554);}}async[a45_0x51eebe(0x223)](_0x53b559){const _0x202c22=a45_0x51eebe,[_0x176895,_0x390a75,_0xcf1afc,_0x45762a]=await Promise[_0x202c22(0x1d3)]([database_1[_0x202c22(0x1a4)][_0x202c22(0x203)][_0x202c22(0x1ab)]({'where':{'shopId':_0x53b559}}),database_1[_0x202c22(0x1a4)][_0x202c22(0x203)][_0x202c22(0x1ab)]({'where':{'shopId':_0x53b559,'status':_0x202c22(0x24f)}}),database_1[_0x202c22(0x1a4)][_0x202c22(0x25f)][_0x202c22(0x1ab)]({'where':{'shopId':_0x53b559,'paymentLinkId':{'not':null}}}),database_1[_0x202c22(0x1a4)][_0x202c22(0x25f)][_0x202c22(0x1ed)]({'where':{'shopId':_0x53b559,'paymentLinkId':{'not':null},'status':'PAID'},'select':{'amount':!![],'currency':!![]}})]);let _0x195ca2=0x0;for(const _0x1d36a2 of _0x45762a){const _0x5c18da=await currencyService_1[_0x202c22(0x1ef)]['convertToUSDT'](_0x1d36a2['amount'],_0x1d36a2[_0x202c22(0x1e9)]);_0x195ca2+=_0x5c18da;}const _0x31d6d9=_0xcf1afc>0x0?_0x45762a[_0x202c22(0x1e7)]/_0xcf1afc*0x64:0x0;return{'totalLinks':_0x176895,'activeLinks':_0x390a75,'totalPayments':_0xcf1afc,'totalRevenue':Math['round'](_0x195ca2*0x64)/0x64,'conversionRate':Math[_0x202c22(0x1dc)](_0x31d6d9*0x64)/0x64};}[a45_0x51eebe(0x24d)](_0x6b8474){const _0x421b32=a45_0x51eebe;return{'id':_0x6b8474['id'],'shopId':_0x6b8474['shopId'],'amount':_0x6b8474['amount'],'currency':_0x6b8474[_0x421b32(0x1e9)],'sourceCurrency':_0x6b8474['sourceCurrency']||undefined,'gateway':_0x6b8474['gateway'],'maxPayments':_0x6b8474[_0x421b32(0x1f1)],'currentPayments':_0x6b8474[_0x421b32(0x1df)],'status':_0x6b8474[_0x421b32(0x20e)],'expiresAt':_0x6b8474[_0x421b32(0x1da)]||undefined,'successUrl':_0x6b8474[_0x421b32(0x21a)]||undefined,'failUrl':_0x6b8474[_0x421b32(0x261)]||undefined,'country':_0x6b8474['country']||undefined,'language':_0x6b8474[_0x421b32(0x23d)]||undefined,'linkUrl':_0x421b32(0x1c5)+_0x6b8474['id'],'createdAt':_0x6b8474['createdAt'],'updatedAt':_0x6b8474[_0x421b32(0x247)],'shop':_0x6b8474[_0x421b32(0x233)],'payments':_0x6b8474[_0x421b32(0x22e)]};}}exports[a45_0x51eebe(0x1e5)]=PaymentLinkService;function a45_0x5a16(){const _0x2ff2d2=['ü™ô\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','\x20->\x20','KLYME\x20EU','payment','defineProperty','failUrl','CoinToPayService','KlymeService','‚úÖ\x20Gateway\x20\x22','\x20completed\x20(reached\x20max\x20payments:\x20','name','default','üìù\x20Note:\x20Success/Fail\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created','validateKlymeCurrency','Shop\x20is\x20not\x20active','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','getPaymentLinks','getGatewayNameById','count','4086888ZVIFJU','https://app.trapay.uk/payment/fail?id=','\x20(8digits-8digits\x20format)','update','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','./currencyService','plisio','updatePaymentLink','PAID','toLowerCase','\x20(8digits-8digits\x20format\x20for\x20','rapyd','\x20not\x20found','join','üí≥\x20Initiating\x20payment\x20from\x20link\x20','username','log','/gateway/fail.php?id=','handleSuccessfulPayment','28GtPnMG','Anonymous','../config/database','ONCE','üíæ\x20Payment\x20created:\x20','__esModule','https://app.trapay.uk/link/','toUpperCase','FAILED','Unknown\x20error','Error\x20parsing\x20payment\x20gateways:','map','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','paymentGateways','Enabled\x20gateways:\x20','Unsupported\x20KLYME\x20region:\x20','ceil','noda','findFirst','\x20payment\x20URL:\x20','all','gateway_payment_id','klymeService','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','amount\x20is\x20required\x20and\x20must\x20be\x20positive','rapydService','padStart','expiresAt','plisioService','round','https://tesoft.uk/gateways/noda/webhook','üîó\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','currentPayments','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','startsWith','getKlymeRegionFromGatewayName','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','Invalid\x20KLYME\x20gateway:\x20','PaymentLinkService','üîê\x20Shop\x20','length','üîê\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','currency','üîó\x20CoinToPay\x20payment\x20URL:\x20','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','insensitive','findMany','Plisio','currencyService','klyme_','maxPayments','country','\x20using\x20default\x20gateways:','$transaction','NodaService','createPayment','./gateways/nodaService','createPaymentLink','../types/gateway','sourceCurrency','shopId','üí≥\x20Creating\x20KLYME\x20','qr_code_url','964930yglyeN','399390LqRgFP','BASE_URL','isValidGatewayId','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','paymentLink','paidAt','create','\x22\x20not\x20allowed\x20for\x20shop\x20','generateGatewayUrls','desc','‚ùå\x20Gateway\x20\x22','üîó\x20Generated\x20URLs\x20for\x20','includes','üë§\x20Customer:\x20','Payment\x20link\x20has\x20expired','status','Payment\x20link\x20has\x20reached\x20maximum\x20payments','generateGatewayOrderId','1320326qlqDzw','amount','RapydService','692690GbnyvU','üí∞\x20Fixed\x20amount:\x20','\x20with\x20payment\x20ID\x20','GBP','getGatewayDisplayName','\x20\x20\x20üåê\x20Gateway\x20Success\x20URL:\x20','successUrl','paymentLinkId','üìà\x20Payment\x20','initiatePaymentFromLink','\x20\x20\x20üåê\x20Gateway\x20Fail\x20URL:\x20','payment_url','üìà\x20Payment\x20link\x20','PENDING','üá¨üáß\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','getPaymentLinkStatistics','1ocAfwB','https://app.trapay.uk/payment/','700848RFuNfu','\x20(validated\x20for\x20','qr_url','nodaService','\x20counter\x20updated:\x20','Payment\x20link\x20is\x20not\x20active','üèÅ\x20Payment\x20link\x20','üîó\x20Plisio\x20payment\x20URL:\x20','payments','üí∞\x20Amount:\x20','no\x20email','PlisioService','Payment\x20','shop','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','checkGatewayPermission','USD','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','qr_code','\x20\x20\x20üíæ\x20DB\x20Fail\x20URL:\x20','coinToPayService',',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','Unsupported\x20gateway:\x20','language','findUnique','ü™ô\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','5934393QDAQid','\x20enabled\x20gateways:','EUR','gateway','invoice_total_sum','COMPLETED','deletePaymentLink','updatedAt','üîó\x20Rapyd\x20payment\x20URL:\x20','cointopay','error','Invalid\x20gateway\x20ID:\x20','/gateway/success.php?id=','formatPaymentLinkResponse','üí∞\x20Plisio\x20payment\x20link\x20mapping:','ACTIVE','),\x20skipping\x20increment','üìà\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','random','env','getPaymentLinkById','‚úÖ\x20Payment\x20link\x20created:\x20','Payment\x20link\x20not\x20found','Shop\x20not\x20found','getPublicPaymentLinkData','https://tesoft.uk/gateway/payment.php?id=','temp','parse'];a45_0x5a16=function(){return _0x2ff2d2;};return a45_0x5a16();}