'use strict';const a50_0x207e4d=a50_0xa988;(function(_0x1f4386,_0x403899){const _0x1c20fa=a50_0xa988,_0x5af3a8=_0x1f4386();while(!![]){try{const _0x3cd114=-parseInt(_0x1c20fa(0x24f))/0x1*(-parseInt(_0x1c20fa(0x21e))/0x2)+-parseInt(_0x1c20fa(0x174))/0x3*(parseInt(_0x1c20fa(0x1e5))/0x4)+-parseInt(_0x1c20fa(0x20d))/0x5*(-parseInt(_0x1c20fa(0x241))/0x6)+parseInt(_0x1c20fa(0x222))/0x7*(parseInt(_0x1c20fa(0x227))/0x8)+-parseInt(_0x1c20fa(0x17b))/0x9+-parseInt(_0x1c20fa(0x17d))/0xa*(parseInt(_0x1c20fa(0x1ae))/0xb)+parseInt(_0x1c20fa(0x173))/0xc*(parseInt(_0x1c20fa(0x1c2))/0xd);if(_0x3cd114===_0x403899)break;else _0x5af3a8['push'](_0x5af3a8['shift']());}catch(_0x1195f4){_0x5af3a8['push'](_0x5af3a8['shift']());}}}(a50_0x1b86,0x469fe));var __importDefault=this&&this['__importDefault']||function(_0x44817a){const _0x54d757=a50_0xa988;return _0x44817a&&_0x44817a[_0x54d757(0x23e)]?_0x44817a:{'default':_0x44817a};};Object['defineProperty'](exports,a50_0x207e4d(0x23e),{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a50_0x207e4d(0x207)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a50_0x207e4d(0x1f7)),coinToPay2Service_1=require(a50_0x207e4d(0x22f)),klymeService_1=require('./gateways/klymeService'),coinToPayStatusService_1=require(a50_0x207e4d(0x191)),gateway_1=require(a50_0x207e4d(0x1ca)),currencyService_1=require('./currencyService');function a50_0x1b86(){const _0x153e03=['Anonymous','PAID','random','Invalid\x20KLYME\x20gateway:\x20','ONCE','Noda','deletePaymentLink','coinToPay2Service','Payment\x20link\x20has\x20reached\x20maximum\x20payments','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','sourceCurrency','EUR','rapyd','🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/','language','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','mastercard','💰\x20Gateway\x20','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','Payment\x20amount\x20','coinToPayService','🔗\x20Noda\x20payment\x20URL:\x20','FAILED','\x20\x20\x20-\x20Status:\x20','\x20using\x20default\x20gateways:','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay2\x20payment:\x20','Error\x20parsing\x20gateway\x20settings:','🔗\x20White\x20URL:\x20','single-use','🔗\x20Plisio\x20payment\x20URL:\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','CoinToPay','checkGatewayPermission','\x20(8digits-8digits\x20format)','createdAt','SINGLE','gateway','payment','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','test_','📈\x20Payment\x20found:','\x22\x20is\x20in\x20enabled\x20gateways:','paymentLinkId','padStart','findUnique','payment_url','\x20gateway\x20settings:','getPublicPaymentLinkData','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','🏁\x20Payment\x20link\x20','🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20','312allWEq','27amPxOG','💰\x20Amount:\x20','https://app.trapay.uk/payment/','none','🔐\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','\x20status\x20calculation:','\x20USDT\x20meets\x20maximum\x20requirement\x20of\x20','4667049xdTKoA','PlisioService','50080HOeLAd','/gateway/pending.php?id=','KLYME\x20EU','\x20\x20\x20-\x20Type:\x20','updatedAt','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','ACTIVE','toString','validateKlymeCurrency','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','\x20enabled\x20gateways\x20(internal):','\x20already\x20used\x20(','qr_url','successUrl','pendingUrl','Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.','Plisio','currentPayments','minAmount','KLYME\x20GB','./coinToPayStatusService','schedulePaymentChecks','klymeService','env','desc','klyme_','\x20USDT\x20exceeds\x20maximum\x20','💳\x20Initiating\x20payment\x20from\x20',',\x20proceeding\x20with\x20payment\x20link\x20counter\x20update','\x20USDT','qr_code','noda','type','username','📈\x20Updating\x20payment\x20link\x20','Unknown\x20error','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20','getPaymentLinks','getPaymentLinkById','RapydService','📧\x20URL\x20параметры:','\x22\x20is\x20allowed\x20for\x20shop\x20','\x20USDT\x20for\x20gateway\x20','Payment\x20link\x20is\x20not\x20active','nodaService','💳\x20MasterCard\x20form\x20URL:\x20','🔗\x20KLYME\x20','\x20link\x20with\x20','\x20(Plisio\x20or\x20KLYME)','22gGFObC','🪙\x20Creating\x20CoinToPay2\x20(Open\x20Banking\x202)\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','paymentLink','getGatewayDisplayName','https://tesoft.uk/gateways/noda/webhook','Rapyd','join','💰\x20No\x20maximum\x20amount\x20set\x20for\x20gateway\x20','startsWith','cointopay2','\x20\x20\x20-\x20Database\x20status:\x20','🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','count','/gateway/success.php?id=','name','✅\x20KLYME\x20','log','generateGatewayUrls','KlymeService','\x20with\x20payment\x20ID\x20','160706qBGufn','📈\x20handleSuccessfulPayment\x20called\x20for\x20payment:\x20','traffer.uk','getKlymeRegionFromGatewayName','EXPIRED','cointopay','currencyService','findMany','../types/gateway','Gateway\x20\x22','status','createPayment','🔐\x20Shop\x20','append','paymentGateways','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','test_gateway','\x20USDT)\x20is\x20below\x20the\x20minimum\x20required\x20amount\x20of\x20','updatePaymentLink','🔗\x20Public\x20link\x20','qr_code_url','gatewaySettings','\x20link\x20','👤\x20Customer:\x20','🎯\x20Generated\x20gateway\x20order_id:\x20','✅\x20Payment\x20link\x20created:\x20','\x20(MasterCard)','💾\x20DB\x20Fail\x20URL:\x20','🔗\x20Link\x20type:\x20','no\x20email','plisioService','💾\x20DB\x20Pending\x20URL:\x20','💰\x20Fixed\x20amount:\x20','✅\x20Gateway\x20\x22','53744smvcbQ',',\x20gateway\x20','createPaymentLink','https://app.trapay.uk/test-gateway/payment/','paidAt','toFixed','USD','🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','https://app.trapay.uk/payment/fail?id=','\x20payment\x20link\x20update','💰\x20Checking\x20amount\x20limits\x20for\x20gateway:\x20','failUrl','📝\x20Note:\x20Success/Fail/Pending\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created','https://','Payment\x20','Unsupported\x20gateway:\x20','❌\x20Enabled\x20gateways:\x20','💰\x20Plisio\x20payment\x20link\x20mapping:','./gateways/coinToPayService','shop','checkAmountLimits','BASE_URL','coinToPayStatusService','multi-use','📈\x20Payment\x20link\x20','💾\x20DB\x20Success\x20URL:\x20','💳\x20Creating\x20KLYME\x20','getGatewayNameById','currency','rapydService','includes','NodaService','map','amount\x20is\x20required\x20and\x20must\x20be\x20positive','./gateways/plisioService','Gateway\x20not\x20found\x20for\x20ID:\x20','MasterCard','\x20completed\x20(','\x20\x20\x20-\x20Current\x20payments:\x20','\x20USDT\x20for\x20','1910010QGlMgV','ceil','\x20payments),\x20skipping\x20increment','🔗\x20No\x20whiteUrl\x20for\x20',')\x20counter\x20updated:\x20','CoinToPayService','🔗\x20CoinToPay2\x20(Open\x20Banking\x202)\x20payment\x20URL:\x20','convertToUSDT','This\x20single-use\x20payment\x20link\x20has\x20already\x20been\x20used','toUpperCase','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','🧪\x20Test\x20Gateway\x20form\x20URL:\x20','temp','expiresAt','length','&payment_id=','56150ArOLqC','invoice_total_sum','🧪\x20Creating\x20Test\x20Gateway\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','📈\x20Existing\x20successful\x20payments\x20for\x20link\x20','7TmyWvE','floor','\x20payment\x20link','toLowerCase','shopId','310720oXqDER','formatPaymentLinkResponse','message','✅\x20Amount\x20','KLYME\x20DE','isValidGatewayId','parse','country','./gateways/coinToPay2Service','\x20minimum\x20amount:\x20','update','Please\x20reduce\x20the\x20amount.','\x20USDT)\x20exceeds\x20the\x20maximum\x20allowed\x20amount\x20of\x20','COMPLETED','🔗\x20Creating\x20','gateway_payment_id','\x20->\x20','generateGatewayOrderId','/gateway/payment.php?id=','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x20\x20\x20-\x20Is\x20expired:\x20','\x20(domain:\x20','📈\x20Payment\x20','__esModule','error','💰\x20Shop\x20','6YPIGWK','Shop\x20not\x20found','initiatePaymentFromLink','Invalid\x20gateway\x20ID:\x20','\x22\x20not\x20allowed\x20for\x20shop\x20','\x20\x20\x20💾\x20DB\x20Pending\x20URL:\x20','\x20payments)','maxAmount','amount','🔐\x20Checking\x20if\x20\x22','🔗\x20Rapyd\x20payment\x20URL:\x20','\x20USDT\x20is\x20below\x20minimum\x20','round','\x20USDT\x20meets\x20minimum\x20requirement\x20of\x20','7PdfFBf','\x20to\x20','default','insensitive','getPaymentLinkStatistics','\x20gateway.\x20','📈\x20All\x20conditions\x20met\x20for\x20payment\x20','💰\x20No\x20minimum\x20amount\x20set\x20for\x20gateway\x20','delete'];a50_0x1b86=function(){return _0x153e03;};return a50_0x1b86();}class PaymentLinkService{constructor(){const _0xe44a45=a50_0x207e4d;this[_0xe44a45(0x1e1)]=new plisioService_1[(_0xe44a45(0x17c))](),this[_0xe44a45(0x202)]=new rapydService_1[(_0xe44a45(0x1a4))](),this[_0xe44a45(0x1a9)]=new nodaService_1[(_0xe44a45(0x204))](),this[_0xe44a45(0x26e)]=new coinToPayService_1[(_0xe44a45(0x212))](),this[_0xe44a45(0x25f)]=new coinToPay2Service_1['CoinToPay2Service'](),this[_0xe44a45(0x193)]=new klymeService_1[(_0xe44a45(0x1c0))]();}[a50_0x207e4d(0x238)](){const _0xac7c84=()=>{const _0x365778=a50_0xa988;return Math[_0x365778(0x223)](Math[_0x365778(0x25a)]()*0x5f5e100)[_0x365778(0x184)]()[_0x365778(0x16b)](0x8,'0');};return _0xac7c84()+'-'+_0xac7c84();}[a50_0x207e4d(0x1bf)](_0xa5527d,_0x47be4a,_0x3e24bc,_0x15fe0f,_0x403cab,_0x56d0bc,_0x3aaefa){const _0x2f82e1=a50_0x207e4d;if(_0x403cab&&_0x56d0bc&&_0x3aaefa)return{'finalSuccessUrl':_0x403cab,'finalFailUrl':_0x56d0bc,'finalPendingUrl':_0x3aaefa,'dbSuccessUrl':_0x403cab,'dbFailUrl':_0x56d0bc,'dbPendingUrl':_0x3aaefa,'whiteUrl':null};const _0x33bfd7=_0x403cab||'https://app.trapay.uk/payment/success?id='+_0x47be4a+'&payment_id='+_0x3e24bc,_0x2cc1dc=_0x56d0bc||_0x2f82e1(0x1ed)+_0x47be4a+_0x2f82e1(0x21d)+_0x3e24bc,_0x2f6df3=_0x3aaefa||'https://app.trapay.uk/payment/pending?id='+_0x47be4a+'&payment_id='+_0x3e24bc;let _0x1dd90f,_0x5369b8,_0xd0c42;_0xa5527d==='noda'||_0xa5527d[_0x2f82e1(0x1b6)]('klyme_')||_0xa5527d==='cointopay'||_0xa5527d===_0x2f82e1(0x1b7)?(_0x1dd90f=_0x15fe0f+_0x2f82e1(0x17e)+_0x47be4a,_0xd0c42=_0x15fe0f+_0x2f82e1(0x17e)+_0x47be4a):(_0x1dd90f=_0x15fe0f+_0x2f82e1(0x1bb)+_0x47be4a,_0xd0c42=_0x15fe0f+'/gateway/pending.php?id='+_0x47be4a);_0x5369b8=_0x15fe0f+'/gateway/fail.php?id='+_0x47be4a;let _0x503bf4=null;if(_0xa5527d!=='plisio'&&!_0xa5527d[_0x2f82e1(0x1b6)](_0x2f82e1(0x196))){const _0x199d00=_0xa5527d===_0x2f82e1(0x1b7)?_0x2f82e1(0x1c4):'tesoft.uk';_0x503bf4=_0x2f82e1(0x1f2)+_0x199d00+_0x2f82e1(0x239)+_0x47be4a,console['log']('🔗\x20Generated\x20whiteUrl\x20for\x20'+_0xa5527d+':\x20'+_0x503bf4+_0x2f82e1(0x23c)+_0x199d00+')');}else console[_0x2f82e1(0x1be)](_0x2f82e1(0x210)+_0xa5527d+_0x2f82e1(0x1ad));return console[_0x2f82e1(0x1be)]('🔗\x20Generated\x20URLs\x20for\x20'+_0xa5527d+_0x2f82e1(0x1c1)+_0x47be4a+':'),console[_0x2f82e1(0x1be)](_0x2f82e1(0x170)+_0x1dd90f),console[_0x2f82e1(0x1be)](_0x2f82e1(0x218)+_0x5369b8),console['log']('\x20\x20\x20🌐\x20Gateway\x20Pending\x20URL:\x20'+_0xd0c42),console[_0x2f82e1(0x1be)](_0x2f82e1(0x269)+_0x33bfd7),console[_0x2f82e1(0x1be)]('\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20'+_0x2cc1dc),console[_0x2f82e1(0x1be)](_0x2f82e1(0x246)+_0x2f6df3),console[_0x2f82e1(0x1be)]('\x20\x20\x20🔗\x20White\x20URL:\x20'+(_0x503bf4||_0x2f82e1(0x177))),{'finalSuccessUrl':_0x1dd90f,'finalFailUrl':_0x5369b8,'finalPendingUrl':_0xd0c42,'dbSuccessUrl':_0x33bfd7,'dbFailUrl':_0x2cc1dc,'dbPendingUrl':_0x2f6df3,'whiteUrl':_0x503bf4};}[a50_0x207e4d(0x185)](_0x4ba0cd,_0x36e92f){const _0x56b2f8=a50_0x207e4d;if(!_0x4ba0cd[_0x56b2f8(0x1b6)](_0x56b2f8(0x196)))return;const _0x11d92b=(0x0,gateway_1[_0x56b2f8(0x1c5)])(_0x4ba0cd),_0x53e936=_0x36e92f[_0x56b2f8(0x216)]();switch(_0x11d92b){case'EU':if(_0x53e936!=='EUR')throw new Error(_0x56b2f8(0x261)+_0x53e936);break;case'GB':if(_0x53e936!=='GBP')throw new Error(_0x56b2f8(0x280)+_0x53e936);break;case'DE':if(_0x53e936!==_0x56b2f8(0x264))throw new Error(_0x56b2f8(0x23a)+_0x53e936);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x11d92b);}}async['checkAmountLimits'](_0x2902b2,_0x347d39,_0xdab997,_0x224516){const _0x5b2ca4=a50_0x207e4d;console[_0x5b2ca4(0x1be)]('💰\x20Checking\x20amount\x20limits\x20for\x20shop\x20'+_0x2902b2+_0x5b2ca4(0x1e6)+_0x347d39+',\x20amount:\x20'+_0xdab997+'\x20'+_0x224516);const _0x9b02b6=await currencyService_1[_0x5b2ca4(0x1c8)][_0x5b2ca4(0x214)](_0xdab997,_0x224516);console[_0x5b2ca4(0x1be)]('💱\x20Converted\x20'+_0xdab997+'\x20'+_0x224516+_0x5b2ca4(0x250)+_0x9b02b6[_0x5b2ca4(0x1ea)](0x6)+'\x20USDT\x20for\x20limit\x20checking');const _0x21a4cb=await database_1[_0x5b2ca4(0x251)][_0x5b2ca4(0x1f8)][_0x5b2ca4(0x16c)]({'where':{'id':_0x2902b2},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x21a4cb)throw new Error(_0x5b2ca4(0x242));let _0x1ad2b5={};if(_0x21a4cb[_0x5b2ca4(0x1d8)])try{_0x1ad2b5=JSON[_0x5b2ca4(0x22d)](_0x21a4cb[_0x5b2ca4(0x1d8)]),console[_0x5b2ca4(0x1be)](_0x5b2ca4(0x240)+_0x21a4cb[_0x5b2ca4(0x19e)]+_0x5b2ca4(0x16e),_0x1ad2b5);}catch(_0x2cf005){console[_0x5b2ca4(0x23f)](_0x5b2ca4(0x274),_0x2cf005),_0x1ad2b5={};}const _0x194606=this[_0x5b2ca4(0x1b1)](_0x347d39);console['log'](_0x5b2ca4(0x1ef)+_0x347d39+_0x5b2ca4(0x237)+_0x194606);const _0x14bab2=_0x1ad2b5[_0x194606];if(_0x14bab2&&_0x14bab2[_0x5b2ca4(0x18f)]!==undefined){const _0x5dc5c4=_0x14bab2['minAmount'];console[_0x5b2ca4(0x1be)](_0x5b2ca4(0x26b)+_0x194606+_0x5b2ca4(0x230)+_0x5dc5c4+_0x5b2ca4(0x19a));if(_0x9b02b6<_0x5dc5c4){console[_0x5b2ca4(0x23f)]('❌\x20Amount\x20'+_0x9b02b6[_0x5b2ca4(0x1ea)](0x6)+_0x5b2ca4(0x24c)+_0x5dc5c4+_0x5b2ca4(0x1a7)+_0x194606);throw new Error(_0x5b2ca4(0x26d)+_0xdab997+'\x20'+_0x224516+'\x20('+_0x9b02b6[_0x5b2ca4(0x1ea)](0x2)+_0x5b2ca4(0x1d4)+_0x5dc5c4+_0x5b2ca4(0x20c)+_0x194606+'\x20gateway.\x20'+'Please\x20increase\x20the\x20amount.');}console[_0x5b2ca4(0x1be)](_0x5b2ca4(0x22a)+_0x9b02b6[_0x5b2ca4(0x1ea)](0x6)+_0x5b2ca4(0x24e)+_0x5dc5c4+_0x5b2ca4(0x1a7)+_0x194606);}else console[_0x5b2ca4(0x1be)](_0x5b2ca4(0x256)+_0x194606);if(_0x14bab2&&_0x14bab2[_0x5b2ca4(0x248)]!==undefined){const _0x2c79b0=_0x14bab2[_0x5b2ca4(0x248)];console[_0x5b2ca4(0x1be)]('💰\x20Gateway\x20'+_0x194606+'\x20maximum\x20amount:\x20'+_0x2c79b0+_0x5b2ca4(0x19a));if(_0x9b02b6>_0x2c79b0){console[_0x5b2ca4(0x23f)]('❌\x20Amount\x20'+_0x9b02b6[_0x5b2ca4(0x1ea)](0x6)+_0x5b2ca4(0x197)+_0x2c79b0+_0x5b2ca4(0x1a7)+_0x194606);throw new Error('Payment\x20amount\x20'+_0xdab997+'\x20'+_0x224516+'\x20('+_0x9b02b6[_0x5b2ca4(0x1ea)](0x2)+_0x5b2ca4(0x233)+_0x2c79b0+_0x5b2ca4(0x20c)+_0x194606+_0x5b2ca4(0x254)+_0x5b2ca4(0x232));}console[_0x5b2ca4(0x1be)]('✅\x20Amount\x20'+_0x9b02b6[_0x5b2ca4(0x1ea)](0x6)+_0x5b2ca4(0x17a)+_0x2c79b0+_0x5b2ca4(0x1a7)+_0x194606);}else console[_0x5b2ca4(0x1be)](_0x5b2ca4(0x1b5)+_0x194606);}async[a50_0x207e4d(0x27a)](_0x22121b,_0x26f314){const _0x3e66de=a50_0x207e4d;console['log'](_0x3e66de(0x178)+_0x22121b+':\x20'+_0x26f314);const _0x360fef=await database_1[_0x3e66de(0x251)][_0x3e66de(0x1f8)][_0x3e66de(0x16c)]({'where':{'id':_0x22121b},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x360fef)throw new Error(_0x3e66de(0x242));let _0x49089d=[];if(_0x360fef['paymentGateways'])try{const _0x244072=JSON[_0x3e66de(0x22d)](_0x360fef[_0x3e66de(0x1d0)]);_0x49089d=_0x244072[_0x3e66de(0x205)](_0x308cee=>this[_0x3e66de(0x1b1)](_0x308cee)),console[_0x3e66de(0x1be)](_0x3e66de(0x1ce)+_0x360fef['username']+_0x3e66de(0x187),_0x244072),console['log'](_0x3e66de(0x1ce)+_0x360fef[_0x3e66de(0x19e)]+'\x20enabled\x20gateways\x20(display):',_0x49089d);}catch(_0x29b852){console[_0x3e66de(0x23f)]('Error\x20parsing\x20payment\x20gateways:',_0x29b852),_0x49089d=[_0x3e66de(0x18d)];}else _0x49089d=[_0x3e66de(0x18d)],console[_0x3e66de(0x1be)]('🔐\x20Shop\x20'+_0x360fef[_0x3e66de(0x19e)]+_0x3e66de(0x272),_0x49089d);const _0x2953a9=this['getGatewayDisplayName'](_0x26f314);console[_0x3e66de(0x1be)](_0x3e66de(0x24a)+_0x2953a9+_0x3e66de(0x169),_0x49089d);if(!_0x49089d[_0x3e66de(0x203)](_0x2953a9)){console[_0x3e66de(0x23f)]('❌\x20Gateway\x20\x22'+_0x2953a9+_0x3e66de(0x245)+_0x360fef[_0x3e66de(0x19e)]),console['error'](_0x3e66de(0x1f5)+_0x49089d[_0x3e66de(0x1b4)](',\x20'));throw new Error(_0x3e66de(0x1cb)+_0x2953a9+_0x3e66de(0x262)+('Enabled\x20gateways:\x20'+_0x49089d[_0x3e66de(0x1b4)](',\x20')+'.\x20')+_0x3e66de(0x18c));}console[_0x3e66de(0x1be)](_0x3e66de(0x1e4)+_0x2953a9+_0x3e66de(0x1a6)+_0x360fef[_0x3e66de(0x19e)]);}['getGatewayDisplayName'](_0x1c31b9){const _0xba2533=a50_0x207e4d,_0x280955={'test_gateway':'Test\x20Gateway','plisio':_0xba2533(0x18d),'rapyd':_0xba2533(0x1b3),'noda':_0xba2533(0x25d),'cointopay':_0xba2533(0x279),'cointopay2':'Open\x20Banking\x202','klyme_eu':_0xba2533(0x17f),'klyme_gb':_0xba2533(0x190),'klyme_de':_0xba2533(0x22b),'mastercard':_0xba2533(0x209)};return _0x280955[_0x1c31b9]||_0x1c31b9;}async[a50_0x207e4d(0x1e7)](_0x140242,_0x4672e7){const _0x113b32=a50_0x207e4d;if(!(0x0,gateway_1[_0x113b32(0x22c)])(_0x4672e7[_0x113b32(0x27e)]))throw new Error(_0x113b32(0x244)+_0x4672e7['gateway']+_0x113b32(0x1d1));const _0x42dad2=(0x0,gateway_1[_0x113b32(0x200)])(_0x4672e7['gateway']);if(!_0x42dad2)throw new Error(_0x113b32(0x208)+_0x4672e7[_0x113b32(0x27e)]);console['log']('🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20'+_0x42dad2),await this['checkGatewayPermission'](_0x140242,_0x42dad2);if(_0x42dad2==='plisio'&&!_0x4672e7[_0x113b32(0x263)])throw new Error(_0x113b32(0x268));if(_0x42dad2[_0x113b32(0x1b6)](_0x113b32(0x196))){const _0x5f11b0=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x42dad2);console[_0x113b32(0x1be)]('💳\x20Creating\x20KLYME\x20'+_0x5f11b0+'\x20payment\x20link');}let _0x48da17=_0x4672e7[_0x113b32(0x22e)];_0x42dad2===_0x113b32(0x265)&&(_0x48da17='GB',console[_0x113b32(0x1be)]('🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link'));if(!_0x4672e7[_0x113b32(0x249)]||_0x4672e7[_0x113b32(0x249)]<=0x0)throw new Error(_0x113b32(0x206));let _0xd6f5db=_0x4672e7[_0x113b32(0x201)]||_0x113b32(0x1eb);(_0x42dad2===_0x113b32(0x1c7)||_0x42dad2===_0x113b32(0x1b7))&&(_0xd6f5db=_0x113b32(0x264),console[_0x113b32(0x1be)](_0x113b32(0x172)+_0x42dad2+_0x113b32(0x224)));this[_0x113b32(0x185)](_0x42dad2,_0xd6f5db),await this[_0x113b32(0x1f9)](_0x140242,_0x42dad2,_0x4672e7[_0x113b32(0x249)],_0xd6f5db);const _0xb27c88=_0x4672e7[_0x113b32(0x19d)]||_0x113b32(0x27d);console['log'](_0x113b32(0x235)+_0xb27c88+_0x113b32(0x224));const _0x2eb35f=await database_1[_0x113b32(0x251)]['paymentLink']['create']({'data':{'shopId':_0x140242,'amount':_0x4672e7[_0x113b32(0x249)],'currency':_0xd6f5db,'sourceCurrency':_0x4672e7[_0x113b32(0x263)]||undefined,'gateway':_0x42dad2,'type':_0xb27c88,'currentPayments':0x0,'status':_0x113b32(0x183),'expiresAt':_0x4672e7[_0x113b32(0x21b)]?new Date(_0x4672e7['expiresAt']):undefined,'successUrl':_0x4672e7[_0x113b32(0x18a)]||null,'failUrl':_0x4672e7[_0x113b32(0x1f0)]||null,'pendingUrl':_0x4672e7['pendingUrl']||null,'country':_0x48da17,'language':_0x4672e7[_0x113b32(0x267)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x113b32(0x1be)](_0x113b32(0x1dc)+_0x2eb35f['id']+'\x20('+_0x42dad2+')'),console['log'](_0x113b32(0x1e3)+_0x2eb35f[_0x113b32(0x249)]+'\x20'+_0x2eb35f[_0x113b32(0x201)]),console['log'](_0x113b32(0x1df)+_0x2eb35f[_0x113b32(0x19d)]),console['log'](_0x113b32(0x266)+_0x2eb35f['id']),console['log'](_0x113b32(0x1f1)),this['formatPaymentLinkResponse'](_0x2eb35f);}async[a50_0x207e4d(0x1a2)](_0xa5dde6,_0x55a1ff){const _0x5dfdcf=a50_0x207e4d,{page:_0x356f8f,limit:_0x56a0be,status:_0x580828,gateway:_0x544393,search:_0x5f2ff2}=_0x55a1ff,_0x5589eb=(_0x356f8f-0x1)*_0x56a0be,_0x1048ee={'shopId':_0xa5dde6};_0x580828&&(_0x1048ee[_0x5dfdcf(0x1cc)]=_0x580828['toUpperCase']());if(_0x544393){if((0x0,gateway_1['isValidGatewayId'])(_0x544393)){const _0x162feb=(0x0,gateway_1[_0x5dfdcf(0x200)])(_0x544393);_0x162feb&&(_0x1048ee[_0x5dfdcf(0x27e)]=_0x162feb);}else _0x1048ee['gateway']=_0x544393[_0x5dfdcf(0x225)]();}_0x5f2ff2&&(_0x1048ee['OR']=[{'gateway':{'contains':_0x5f2ff2,'mode':_0x5dfdcf(0x252)}},{'currency':{'contains':_0x5f2ff2,'mode':_0x5dfdcf(0x252)}}]);const [_0x32f668,_0x5d632f]=await Promise['all']([database_1[_0x5dfdcf(0x251)][_0x5dfdcf(0x1b0)][_0x5dfdcf(0x1c9)]({'where':_0x1048ee,'skip':_0x5589eb,'take':_0x56a0be,'orderBy':{'createdAt':_0x5dfdcf(0x195)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x5dfdcf(0x195)},'take':0xa}}}),database_1[_0x5dfdcf(0x251)][_0x5dfdcf(0x1b0)][_0x5dfdcf(0x1ba)]({'where':_0x1048ee})]);return{'links':_0x32f668[_0x5dfdcf(0x205)](_0x59ccc2=>this[_0x5dfdcf(0x228)](_0x59ccc2)),'pagination':{'page':_0x356f8f,'limit':_0x56a0be,'total':_0x5d632f,'totalPages':Math[_0x5dfdcf(0x20e)](_0x5d632f/_0x56a0be)}};}async[a50_0x207e4d(0x1a3)](_0x2b533f,_0x5c30ee){const _0x1cc11b=a50_0x207e4d,_0x24bfea=await database_1[_0x1cc11b(0x251)][_0x1cc11b(0x1b0)]['findFirst']({'where':{'id':_0x5c30ee,'shopId':_0x2b533f},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x1cc11b(0x195)}}}});if(!_0x24bfea)return null;return this['formatPaymentLinkResponse'](_0x24bfea);}async[a50_0x207e4d(0x1d5)](_0x34baa8,_0x19c52e,_0x14f125){const _0x5bb368=a50_0x207e4d,_0x7cdc73={..._0x14f125};if(_0x14f125[_0x5bb368(0x27e)]){if((0x0,gateway_1[_0x5bb368(0x22c)])(_0x14f125[_0x5bb368(0x27e)])){const _0x33574b=(0x0,gateway_1[_0x5bb368(0x200)])(_0x14f125[_0x5bb368(0x27e)]);_0x33574b&&(await this[_0x5bb368(0x27a)](_0x34baa8,_0x33574b),_0x7cdc73[_0x5bb368(0x27e)]=_0x33574b);}else _0x7cdc73['gateway']=_0x14f125[_0x5bb368(0x27e)]['toLowerCase']();}(_0x7cdc73[_0x5bb368(0x27e)]==='rapyd'||_0x14f125[_0x5bb368(0x22e)]&&_0x7cdc73['gateway']!=='rapyd')&&(_0x7cdc73[_0x5bb368(0x27e)]===_0x5bb368(0x265)&&(_0x7cdc73[_0x5bb368(0x22e)]='GB',console[_0x5bb368(0x1be)](_0x5bb368(0x1b9))));(_0x7cdc73['gateway']===_0x5bb368(0x1c7)||_0x7cdc73[_0x5bb368(0x27e)]===_0x5bb368(0x1b7))&&(_0x7cdc73['currency']=_0x5bb368(0x264),console[_0x5bb368(0x1be)]('🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20'+_0x7cdc73[_0x5bb368(0x27e)]+_0x5bb368(0x1ee)));_0x7cdc73[_0x5bb368(0x27e)]&&_0x7cdc73[_0x5bb368(0x201)]&&this[_0x5bb368(0x185)](_0x7cdc73[_0x5bb368(0x27e)],_0x7cdc73[_0x5bb368(0x201)]);if(_0x14f125['amount']&&_0x7cdc73[_0x5bb368(0x27e)]){const _0x275f7e=_0x14f125[_0x5bb368(0x201)]||_0x5bb368(0x1eb);await this[_0x5bb368(0x1f9)](_0x34baa8,_0x7cdc73[_0x5bb368(0x27e)],_0x14f125['amount'],_0x275f7e);}_0x14f125['expiresAt']&&(_0x7cdc73[_0x5bb368(0x21b)]=new Date(_0x14f125[_0x5bb368(0x21b)]));const _0x22e29f=await database_1[_0x5bb368(0x251)][_0x5bb368(0x1b0)]['update']({'where':{'id':_0x19c52e,'shopId':_0x34baa8},'data':_0x7cdc73,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x5bb368(0x195)},'take':0xa}}});return this[_0x5bb368(0x228)](_0x22e29f);}async[a50_0x207e4d(0x25e)](_0xa9f92,_0x27ba72){const _0x203a03=a50_0x207e4d;await database_1[_0x203a03(0x251)][_0x203a03(0x1b0)][_0x203a03(0x257)]({'where':{'id':_0x27ba72,'shopId':_0xa9f92}});}async[a50_0x207e4d(0x16f)](_0x2105d5){const _0x1981fc=a50_0x207e4d,_0x510683=await database_1[_0x1981fc(0x251)][_0x1981fc(0x1b0)][_0x1981fc(0x16c)]({'where':{'id':_0x2105d5},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x510683)return null;const _0x5ab949=_0x510683[_0x1981fc(0x21b)]&&_0x510683[_0x1981fc(0x21b)]<new Date(),_0x378e04=_0x510683['type']==='SINGLE'?_0x510683[_0x1981fc(0x18e)]>=0x1:![],_0x578db3=_0x510683[_0x1981fc(0x1f8)][_0x1981fc(0x1cc)]===_0x1981fc(0x183),_0x13e515=_0x510683[_0x1981fc(0x1cc)]===_0x1981fc(0x183),_0x2e666e=!_0x5ab949&&!_0x378e04&&_0x578db3&&_0x13e515,_0x1be99f=_0x510683[_0x1981fc(0x19d)]===_0x1981fc(0x27d)?_0x510683[_0x1981fc(0x18e)]>=0x1?0x0:0x1:Number['MAX_SAFE_INTEGER'];let _0x1df947=_0x510683[_0x1981fc(0x1cc)];if(_0x378e04)_0x1df947=_0x1981fc(0x234);else _0x5ab949&&(_0x1df947=_0x1981fc(0x1c6));return console[_0x1981fc(0x1be)](_0x1981fc(0x1d6)+_0x2105d5+_0x1981fc(0x179)),console[_0x1981fc(0x1be)](_0x1981fc(0x1b8)+_0x510683[_0x1981fc(0x1cc)]),console['log']('\x20\x20\x20-\x20Type:\x20'+_0x510683[_0x1981fc(0x19d)]),console[_0x1981fc(0x1be)](_0x1981fc(0x20b)+_0x510683[_0x1981fc(0x18e)]),console[_0x1981fc(0x1be)]('\x20\x20\x20-\x20Is\x20completed:\x20'+_0x378e04),console[_0x1981fc(0x1be)](_0x1981fc(0x23b)+_0x5ab949),console['log']('\x20\x20\x20-\x20Effective\x20status:\x20'+_0x1df947),{'id':_0x510683['id'],'amount':_0x510683[_0x1981fc(0x249)],'currency':_0x510683[_0x1981fc(0x201)],'sourceCurrency':_0x510683[_0x1981fc(0x263)]||undefined,'gateway':_0x510683[_0x1981fc(0x27e)],'type':_0x510683[_0x1981fc(0x19d)],'currentPayments':_0x510683[_0x1981fc(0x18e)],'status':_0x1df947,'expiresAt':_0x510683[_0x1981fc(0x21b)]||undefined,'shopName':_0x510683[_0x1981fc(0x1f8)]['name'],'isAvailable':_0x2e666e,'remainingPayments':_0x1be99f};}async[a50_0x207e4d(0x243)](_0x2a55ee){const _0x143b3b=a50_0x207e4d,{linkId:_0x1cb42c,customerEmail:_0x5e7373,customerName:_0x3d6eb8}=_0x2a55ee,_0x22bdf6=await database_1[_0x143b3b(0x251)][_0x143b3b(0x1b0)][_0x143b3b(0x16c)]({'where':{'id':_0x1cb42c},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x22bdf6)throw new Error('Payment\x20link\x20not\x20found');const _0xfcf36a=_0x22bdf6[_0x143b3b(0x21b)]&&_0x22bdf6[_0x143b3b(0x21b)]<new Date(),_0x314b4d=_0x22bdf6[_0x143b3b(0x19d)]===_0x143b3b(0x27d)?_0x22bdf6[_0x143b3b(0x18e)]>=0x1:![],_0x27bf40=_0x22bdf6[_0x143b3b(0x1f8)][_0x143b3b(0x1cc)]===_0x143b3b(0x183),_0x4a12bc=_0x22bdf6[_0x143b3b(0x1cc)]==='ACTIVE';if(_0xfcf36a)throw new Error('Payment\x20link\x20has\x20expired');if(_0x314b4d){const _0x2ac258=_0x22bdf6[_0x143b3b(0x19d)]==='SINGLE'?_0x143b3b(0x215):_0x143b3b(0x260);throw new Error(_0x2ac258);}if(!_0x27bf40)throw new Error('Shop\x20is\x20not\x20active');if(!_0x4a12bc)throw new Error(_0x143b3b(0x1a8));await this['checkGatewayPermission'](_0x22bdf6[_0x143b3b(0x226)],_0x22bdf6['gateway']);const _0x22c0f4=_0x22bdf6['amount'];console[_0x143b3b(0x1be)](_0x143b3b(0x198)+_0x22bdf6[_0x143b3b(0x19d)]+_0x143b3b(0x1d9)+_0x1cb42c+':\x20'+_0x22c0f4+'\x20'+_0x22bdf6[_0x143b3b(0x201)]),console[_0x143b3b(0x1be)](_0x143b3b(0x1da)+(_0x3d6eb8||'Anonymous')+'\x20('+(_0x5e7373||_0x143b3b(0x1e0))+')'),this[_0x143b3b(0x185)](_0x22bdf6[_0x143b3b(0x27e)],_0x22bdf6[_0x143b3b(0x201)]),await this['checkAmountLimits'](_0x22bdf6[_0x143b3b(0x226)],_0x22bdf6['gateway'],_0x22c0f4,_0x22bdf6[_0x143b3b(0x201)]);const _0x51d014=this[_0x143b3b(0x238)]();console[_0x143b3b(0x1be)](_0x143b3b(0x1db)+_0x51d014+'\x20(8digits-8digits\x20format\x20for\x20'+_0x22bdf6['gateway']+')');const _0x53becb=await database_1[_0x143b3b(0x251)][_0x143b3b(0x27f)]['create']({'data':{'shopId':_0x22bdf6['shopId'],'paymentLinkId':_0x22bdf6['id'],'gateway':_0x22bdf6[_0x143b3b(0x27e)],'amount':_0x22c0f4,'currency':_0x22bdf6[_0x143b3b(0x201)],'sourceCurrency':_0x22bdf6[_0x143b3b(0x263)]||undefined,'usage':_0x143b3b(0x25c),'expiresAt':_0x22bdf6[_0x143b3b(0x21b)]||undefined,'successUrl':'temp','failUrl':_0x143b3b(0x21a),'pendingUrl':'temp','whiteUrl':'temp','status':'PENDING','orderId':null,'gatewayOrderId':_0x51d014,'customerEmail':_0x5e7373||undefined,'customerName':_0x3d6eb8||undefined,'country':_0x22bdf6[_0x143b3b(0x22e)]||undefined,'language':_0x22bdf6[_0x143b3b(0x267)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console['log']('💾\x20Payment\x20created:\x20'+_0x53becb['id']);const _0x132c90=process[_0x143b3b(0x194)][_0x143b3b(0x1fa)]||'https://tesoft.uk',{finalSuccessUrl:_0x5d1bc9,finalFailUrl:_0x53f911,finalPendingUrl:_0x1a1746,dbSuccessUrl:_0x10fade,dbFailUrl:_0x1b346d,dbPendingUrl:_0x4cef71,whiteUrl:_0x2db585}=this[_0x143b3b(0x1bf)](_0x22bdf6[_0x143b3b(0x27e)],_0x53becb['id'],_0x51d014,_0x132c90,_0x22bdf6[_0x143b3b(0x18a)]||undefined,_0x22bdf6[_0x143b3b(0x1f0)]||undefined,_0x22bdf6['pendingUrl']||undefined);await database_1[_0x143b3b(0x251)]['payment'][_0x143b3b(0x231)]({'where':{'id':_0x53becb['id']},'data':{'successUrl':_0x10fade,'failUrl':_0x1b346d,'pendingUrl':_0x4cef71,'whiteUrl':_0x2db585}}),console['log'](_0x143b3b(0x175)+_0x22c0f4+'\x20'+_0x22bdf6[_0x143b3b(0x201)]),console['log'](_0x143b3b(0x1da)+(_0x3d6eb8||_0x143b3b(0x258))+'\x20('+(_0x5e7373||_0x143b3b(0x1e0))+')'),console['log'](_0x143b3b(0x1fe)+_0x10fade),console[_0x143b3b(0x1be)](_0x143b3b(0x1de)+_0x1b346d),console[_0x143b3b(0x1be)](_0x143b3b(0x1e2)+_0x4cef71),console[_0x143b3b(0x1be)](_0x143b3b(0x275)+(_0x2db585||_0x143b3b(0x177)));let _0x3603e9,_0x2636fd;try{if(_0x22bdf6['gateway']==='plisio'){console[_0x143b3b(0x1be)](_0x143b3b(0x1f6)),console[_0x143b3b(0x1be)]('\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20'+_0x22bdf6[_0x143b3b(0x201)]),console['log'](_0x143b3b(0x26c)+_0x22bdf6[_0x143b3b(0x263)]);const _0x4ee0c6=await this[_0x143b3b(0x1e1)][_0x143b3b(0x1cd)]({'paymentId':_0x53becb['id'],'orderId':_0x51d014,'amount':_0x22c0f4,'currency':_0x22bdf6['currency'],'productName':_0x143b3b(0x1f3)+_0x22c0f4+'\x20'+_0x22bdf6[_0x143b3b(0x201)],'description':_0x143b3b(0x1f3)+_0x22c0f4+'\x20'+_0x22bdf6[_0x143b3b(0x201)],'successUrl':_0x5d1bc9,'failUrl':_0x53f911,'customerEmail':_0x5e7373||undefined,'customerName':_0x3d6eb8||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x22bdf6['sourceCurrency']||undefined});_0x3603e9=_0x4ee0c6[_0x143b3b(0x236)],_0x2636fd=_0x4ee0c6[_0x143b3b(0x16d)],await database_1[_0x143b3b(0x251)]['payment'][_0x143b3b(0x231)]({'where':{'id':_0x53becb['id']},'data':{'externalPaymentUrl':_0x2636fd,'gatewayPaymentId':_0x3603e9,'invoiceTotalSum':Number(_0x4ee0c6[_0x143b3b(0x21f)]),'qrCode':_0x4ee0c6[_0x143b3b(0x19b)],'qrUrl':_0x4ee0c6[_0x143b3b(0x189)]}});const _0x379319=_0x143b3b(0x176)+_0x53becb['id'];return console['log'](_0x143b3b(0x277)+_0x379319),{'paymentId':_0x53becb['id'],'paymentUrl':_0x379319,'expiresAt':_0x53becb['expiresAt']||undefined};}else{if(_0x22bdf6[_0x143b3b(0x27e)]===_0x143b3b(0x265)){const _0x299c9e=await this[_0x143b3b(0x202)]['createPaymentLink']({'paymentId':_0x53becb['id'],'orderId':_0x51d014,'orderName':_0x143b3b(0x1f3)+_0x22c0f4+'\x20'+_0x22bdf6[_0x143b3b(0x201)],'amount':_0x22c0f4,'currency':_0x22bdf6[_0x143b3b(0x201)],'country':_0x22bdf6[_0x143b3b(0x22e)],'language':_0x22bdf6[_0x143b3b(0x267)]||'EN','amountIsEditable':![],'usage':'ONCE','maxPayments':0x1,'successUrl':_0x5d1bc9,'failUrl':_0x53f911});_0x3603e9=_0x299c9e['gateway_payment_id'],_0x2636fd=_0x299c9e[_0x143b3b(0x16d)],await database_1[_0x143b3b(0x251)][_0x143b3b(0x27f)][_0x143b3b(0x231)]({'where':{'id':_0x53becb['id']},'data':{'externalPaymentUrl':_0x2636fd,'gatewayPaymentId':_0x3603e9}});const _0x24e6f8='https://app.trapay.uk/payment/'+_0x53becb['id'];return console[_0x143b3b(0x1be)](_0x143b3b(0x24b)+_0x24e6f8),{'paymentId':_0x53becb['id'],'paymentUrl':_0x24e6f8,'expiresAt':_0x53becb['expiresAt']||undefined};}else{if(_0x22bdf6[_0x143b3b(0x27e)]===_0x143b3b(0x19c)){const _0x18a6f8=await this[_0x143b3b(0x1a9)]['createPaymentLink']({'paymentId':_0x53becb['id'],'orderId':_0x51d014,'name':'Payment\x20'+_0x22c0f4+'\x20'+_0x22bdf6[_0x143b3b(0x201)],'paymentDescription':_0x143b3b(0x1f3)+_0x22c0f4+'\x20'+_0x22bdf6[_0x143b3b(0x201)],'amount':_0x22c0f4,'currency':_0x22bdf6['currency'],'webhookUrl':_0x143b3b(0x1b2),'returnUrl':_0x1a1746,'expiryDate':_0x22bdf6[_0x143b3b(0x21b)]?.['toISOString']()});_0x3603e9=_0x18a6f8[_0x143b3b(0x236)],_0x2636fd=_0x18a6f8[_0x143b3b(0x16d)],await database_1[_0x143b3b(0x251)][_0x143b3b(0x27f)][_0x143b3b(0x231)]({'where':{'id':_0x53becb['id']},'data':{'externalPaymentUrl':_0x2636fd,'gatewayPaymentId':_0x3603e9,'qrUrl':_0x18a6f8[_0x143b3b(0x1d7)]}});const _0xd38283='https://app.trapay.uk/payment/'+_0x53becb['id'];return console[_0x143b3b(0x1be)](_0x143b3b(0x26f)+_0xd38283),{'paymentId':_0x53becb['id'],'paymentUrl':_0xd38283,'expiresAt':_0x53becb[_0x143b3b(0x21b)]||undefined};}else{if(_0x22bdf6['gateway']===_0x143b3b(0x1c7)){console[_0x143b3b(0x1be)](_0x143b3b(0x1ec)+_0x51d014+'\x20(8digits-8digits\x20format)'),console[_0x143b3b(0x1be)](_0x143b3b(0x175)+_0x22c0f4+_0x143b3b(0x1d2));const _0x54ca69=await this['coinToPayService']['createPaymentLink']({'paymentId':_0x53becb['id'],'orderId':_0x51d014,'amount':_0x22c0f4});_0x3603e9=_0x54ca69[_0x143b3b(0x236)],_0x2636fd=_0x54ca69[_0x143b3b(0x16d)],await database_1[_0x143b3b(0x251)][_0x143b3b(0x27f)][_0x143b3b(0x231)]({'where':{'id':_0x53becb['id']},'data':{'externalPaymentUrl':_0x2636fd,'gatewayPaymentId':_0x3603e9}});_0x3603e9&&(console[_0x143b3b(0x1be)](_0x143b3b(0x1a1)+_0x53becb['id']+'\x20('+_0x3603e9+')'),coinToPayStatusService_1[_0x143b3b(0x1fb)][_0x143b3b(0x192)](_0x53becb['id'],_0x3603e9));const _0x5945aa=_0x143b3b(0x176)+_0x53becb['id'];return console[_0x143b3b(0x1be)]('🔗\x20CoinToPay\x20payment\x20URL:\x20'+_0x5945aa),{'paymentId':_0x53becb['id'],'paymentUrl':_0x5945aa,'expiresAt':_0x53becb['expiresAt']||undefined};}else{if(_0x22bdf6[_0x143b3b(0x27e)]==='cointopay2'){console['log'](_0x143b3b(0x1af)+_0x51d014+_0x143b3b(0x27b)),console[_0x143b3b(0x1be)]('💰\x20Amount:\x20'+_0x22c0f4+'\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay2)');const _0x427507=await this[_0x143b3b(0x25f)]['createPaymentLink']({'paymentId':_0x53becb['id'],'orderId':_0x51d014,'amount':_0x22c0f4});_0x3603e9=_0x427507[_0x143b3b(0x236)],_0x2636fd=_0x427507['payment_url'],await database_1[_0x143b3b(0x251)][_0x143b3b(0x27f)][_0x143b3b(0x231)]({'where':{'id':_0x53becb['id']},'data':{'externalPaymentUrl':_0x2636fd,'gatewayPaymentId':_0x3603e9}});_0x3603e9&&(console[_0x143b3b(0x1be)](_0x143b3b(0x273)+_0x53becb['id']+'\x20('+_0x3603e9+')'),coinToPayStatusService_1[_0x143b3b(0x1fb)][_0x143b3b(0x192)](_0x53becb['id'],_0x3603e9));const _0x1aa10b=_0x143b3b(0x176)+_0x53becb['id'];return console[_0x143b3b(0x1be)](_0x143b3b(0x213)+_0x1aa10b),{'paymentId':_0x53becb['id'],'paymentUrl':_0x1aa10b,'expiresAt':_0x53becb[_0x143b3b(0x21b)]||undefined};}else{if(_0x22bdf6['gateway'][_0x143b3b(0x1b6)](_0x143b3b(0x196))){const _0x5dc2de=(0x0,gateway_1[_0x143b3b(0x1c5)])(_0x22bdf6[_0x143b3b(0x27e)]);if(!_0x5dc2de)throw new Error(_0x143b3b(0x25b)+_0x22bdf6[_0x143b3b(0x27e)]);console[_0x143b3b(0x1be)](_0x143b3b(0x1ff)+_0x5dc2de+_0x143b3b(0x182)+_0x51d014+_0x143b3b(0x27b)),console[_0x143b3b(0x1be)]('💰\x20Amount:\x20'+_0x22c0f4+'\x20'+_0x22bdf6[_0x143b3b(0x201)]+'\x20(validated\x20for\x20'+_0x5dc2de+')');const _0xffca81=await this[_0x143b3b(0x193)][_0x143b3b(0x1e7)]({'paymentId':_0x53becb['id'],'orderId':_0x51d014,'amount':_0x22c0f4,'currency':_0x22bdf6[_0x143b3b(0x201)],'region':_0x5dc2de,'redirectUrl':_0x1a1746});_0x3603e9=_0xffca81['gateway_payment_id'],_0x2636fd=_0xffca81[_0x143b3b(0x16d)],await database_1[_0x143b3b(0x251)][_0x143b3b(0x27f)][_0x143b3b(0x231)]({'where':{'id':_0x53becb['id']},'data':{'externalPaymentUrl':_0x2636fd,'gatewayPaymentId':_0x3603e9}});const _0x1a9100=_0x143b3b(0x176)+_0x53becb['id'];return console[_0x143b3b(0x1be)](_0x143b3b(0x1bd)+_0x5dc2de+_0x143b3b(0x186)+_0x51d014),console[_0x143b3b(0x1be)](_0x143b3b(0x1ab)+_0x5dc2de+'\x20payment\x20URL:\x20'+_0x1a9100),{'paymentId':_0x53becb['id'],'paymentUrl':_0x1a9100,'expiresAt':_0x53becb[_0x143b3b(0x21b)]||undefined};}else{if(_0x22bdf6['gateway']===_0x143b3b(0x1d3)){console[_0x143b3b(0x1be)](_0x143b3b(0x220)+_0x51d014+_0x143b3b(0x27b)),console[_0x143b3b(0x1be)](_0x143b3b(0x175)+_0x22c0f4+'\x20'+_0x22bdf6['currency']+'\x20(Test\x20Gateway)');const _0x3bf29b=_0x143b3b(0x1e8)+_0x53becb['id'];await database_1[_0x143b3b(0x251)]['payment'][_0x143b3b(0x231)]({'where':{'id':_0x53becb['id']},'data':{'externalPaymentUrl':_0x3bf29b,'gatewayPaymentId':_0x143b3b(0x167)+_0x51d014}});const _0x3474d7=_0x143b3b(0x176)+_0x53becb['id'];return console[_0x143b3b(0x1be)]('🔗\x20Test\x20Gateway\x20payment\x20URL:\x20'+_0x3474d7),console['log'](_0x143b3b(0x219)+_0x3bf29b),{'paymentId':_0x53becb['id'],'paymentUrl':_0x3474d7,'expiresAt':_0x53becb['expiresAt']||undefined};}else{if(_0x22bdf6[_0x143b3b(0x27e)]===_0x143b3b(0x26a)){console[_0x143b3b(0x1be)]('💳\x20Creating\x20MasterCard\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x51d014+'\x20(8digits-8digits\x20format)'),console[_0x143b3b(0x1be)]('💰\x20Amount:\x20'+_0x22c0f4+'\x20'+_0x22bdf6[_0x143b3b(0x201)]+_0x143b3b(0x1dd));const _0x41612a=new URLSearchParams();_0x5e7373&&_0x41612a[_0x143b3b(0x1cf)]('email',_0x5e7373);_0x3d6eb8&&_0x41612a[_0x143b3b(0x1cf)](_0x143b3b(0x1bc),_0x3d6eb8);const _0x5b10b9=_0x143b3b(0x176)+_0x53becb['id']+(_0x41612a['toString']()?'?'+_0x41612a[_0x143b3b(0x184)]():'');await database_1[_0x143b3b(0x251)][_0x143b3b(0x27f)][_0x143b3b(0x231)]({'where':{'id':_0x53becb['id']},'data':{'externalPaymentUrl':_0x5b10b9,'gatewayPaymentId':'mc_'+_0x51d014,'paymentMethod':'mastercard'}});const _0x2fedb8=_0x143b3b(0x176)+_0x53becb['id']+(_0x41612a[_0x143b3b(0x184)]()?'?'+_0x41612a[_0x143b3b(0x184)]():'');return console[_0x143b3b(0x1be)]('🔗\x20MasterCard\x20payment\x20URL:\x20'+_0x2fedb8),console['log'](_0x143b3b(0x1aa)+_0x5b10b9),console[_0x143b3b(0x1be)](_0x143b3b(0x1a5),_0x41612a['toString']()),{'paymentId':_0x53becb['id'],'paymentUrl':_0x2fedb8,'expiresAt':_0x53becb[_0x143b3b(0x21b)]||undefined};}else throw new Error(_0x143b3b(0x1f4)+_0x22bdf6[_0x143b3b(0x27e)]);}}}}}}}}catch(_0x29b23c){await database_1['default'][_0x143b3b(0x27f)][_0x143b3b(0x231)]({'where':{'id':_0x53becb['id']},'data':{'status':_0x143b3b(0x270)}});throw new Error('Gateway\x20error:\x20'+(_0x29b23c instanceof Error?_0x29b23c[_0x143b3b(0x229)]:_0x143b3b(0x1a0)));}}async['handleSuccessfulPayment'](_0x15e9f1){const _0xb817d3=a50_0x207e4d;console['log'](_0xb817d3(0x1c3)+_0x15e9f1);const _0x390dbb=await database_1['default']['payment'][_0xb817d3(0x16c)]({'where':{'id':_0x15e9f1},'include':{'paymentLink':!![]}});console[_0xb817d3(0x1be)](_0xb817d3(0x168),_0x390dbb?{'id':_0x390dbb['id'],'status':_0x390dbb[_0xb817d3(0x1cc)],'paidAt':_0x390dbb['paidAt'],'paymentLinkId':_0x390dbb[_0xb817d3(0x16a)],'paymentLink':_0x390dbb[_0xb817d3(0x1b0)]?{'id':_0x390dbb['paymentLink']['id'],'type':_0x390dbb['paymentLink'][_0xb817d3(0x19d)],'currentPayments':_0x390dbb[_0xb817d3(0x1b0)][_0xb817d3(0x18e)],'status':_0x390dbb['paymentLink'][_0xb817d3(0x1cc)]}:null}:'Payment\x20not\x20found');if(!_0x390dbb||!_0x390dbb['paymentLink']){console[_0xb817d3(0x1be)](_0xb817d3(0x23d)+_0x15e9f1+_0xb817d3(0x217));return;}if(_0x390dbb[_0xb817d3(0x1cc)]!==_0xb817d3(0x259)){console['log']('📈\x20Payment\x20'+_0x15e9f1+'\x20status\x20is\x20'+_0x390dbb[_0xb817d3(0x1cc)]+',\x20not\x20PAID.\x20Skipping\x20counter\x20update.');return;}if(!_0x390dbb[_0xb817d3(0x1e9)]){console[_0xb817d3(0x1be)](_0xb817d3(0x23d)+_0x15e9f1+'\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.');return;}console[_0xb817d3(0x1be)](_0xb817d3(0x255)+_0x15e9f1+_0xb817d3(0x199));try{const _0x5474a6=await database_1[_0xb817d3(0x251)]['$transaction'](async _0x3a497e=>{const _0x555369=_0xb817d3,_0x4fd471=await _0x3a497e[_0x555369(0x1b0)][_0x555369(0x16c)]({'where':{'id':_0x390dbb['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(!_0x4fd471)throw new Error('Payment\x20link\x20'+_0x390dbb['paymentLinkId']+'\x20not\x20found');console['log']('📈\x20Current\x20payment\x20link\x20state:',_0x4fd471);if(_0x4fd471[_0x555369(0x19d)]===_0x555369(0x27d)&&_0x4fd471[_0x555369(0x18e)]>=0x1)return console[_0x555369(0x1be)]('📈\x20Single\x20payment\x20link\x20'+_0x390dbb[_0x555369(0x16a)]+_0x555369(0x188)+_0x4fd471[_0x555369(0x18e)]+_0x555369(0x20f)),_0x4fd471;const _0x538997=await _0x3a497e['payment'][_0x555369(0x1ba)]({'where':{'paymentLinkId':_0x390dbb[_0x555369(0x16a)],'status':_0x555369(0x259),'paidAt':{'not':null},'id':{'not':_0x15e9f1}}});console['log'](_0x555369(0x221)+_0x390dbb[_0x555369(0x16a)]+':\x20'+_0x538997);const _0x2addb9=_0x538997+0x1,_0x38daaf=_0x4fd471[_0x555369(0x19d)]===_0x555369(0x27d)&&_0x2addb9>=0x1?_0x555369(0x234):_0x4fd471[_0x555369(0x1cc)];console['log'](_0x555369(0x19f)+_0x390dbb['paymentLinkId']+':'),console[_0x555369(0x1be)](_0x555369(0x180)+_0x4fd471[_0x555369(0x19d)]),console[_0x555369(0x1be)](_0x555369(0x20b)+_0x4fd471[_0x555369(0x18e)]+_0x555369(0x237)+_0x2addb9),console[_0x555369(0x1be)](_0x555369(0x271)+_0x4fd471[_0x555369(0x1cc)]+_0x555369(0x237)+_0x38daaf);const _0x3c2eee=await _0x3a497e[_0x555369(0x1b0)][_0x555369(0x231)]({'where':{'id':_0x390dbb['paymentLinkId']},'data':{'currentPayments':_0x2addb9,'status':_0x38daaf}});return console[_0x555369(0x1be)](_0x555369(0x1fd)+_0x390dbb[_0x555369(0x16a)]+'\x20('+_0x4fd471['type']+_0x555369(0x211)+_0x4fd471[_0x555369(0x18e)]+_0x555369(0x237)+_0x2addb9),_0x3c2eee;});if(_0x5474a6[_0xb817d3(0x1cc)]==='COMPLETED'){const _0x52429=_0x5474a6[_0xb817d3(0x19d)]===_0xb817d3(0x27d)?_0xb817d3(0x276):_0xb817d3(0x1fc);console[_0xb817d3(0x1be)](_0xb817d3(0x171)+_0x390dbb['paymentLinkId']+_0xb817d3(0x20a)+_0x52429+_0xb817d3(0x1ac)+_0x5474a6[_0xb817d3(0x18e)]+_0xb817d3(0x247));}}catch(_0x13ac4f){console[_0xb817d3(0x23f)](_0xb817d3(0x278)+_0x15e9f1+':',_0x13ac4f);throw _0x13ac4f;}}async[a50_0x207e4d(0x253)](_0x4f98de){const _0x58fab9=a50_0x207e4d,[_0x27e666,_0x2849bc,_0x1cd4dd,_0x520b2e]=await Promise['all']([database_1[_0x58fab9(0x251)][_0x58fab9(0x1b0)][_0x58fab9(0x1ba)]({'where':{'shopId':_0x4f98de}}),database_1[_0x58fab9(0x251)][_0x58fab9(0x1b0)][_0x58fab9(0x1ba)]({'where':{'shopId':_0x4f98de,'status':_0x58fab9(0x183)}}),database_1[_0x58fab9(0x251)]['payment'][_0x58fab9(0x1ba)]({'where':{'shopId':_0x4f98de,'paymentLinkId':{'not':null},'gateway':{'not':_0x58fab9(0x1d3)}}}),database_1[_0x58fab9(0x251)][_0x58fab9(0x27f)][_0x58fab9(0x1c9)]({'where':{'shopId':_0x4f98de,'paymentLinkId':{'not':null},'status':_0x58fab9(0x259),'gateway':{'not':_0x58fab9(0x1d3)}},'select':{'amount':!![],'currency':!![]}})]);let _0x4ac3e1=0x0;for(const _0x265a8d of _0x520b2e){const _0x176f0e=await currencyService_1[_0x58fab9(0x1c8)][_0x58fab9(0x214)](_0x265a8d['amount'],_0x265a8d[_0x58fab9(0x201)]);_0x4ac3e1+=_0x176f0e;}const _0x5de3f4=_0x1cd4dd>0x0?_0x520b2e[_0x58fab9(0x21c)]/_0x1cd4dd*0x64:0x0;return{'totalLinks':_0x27e666,'activeLinks':_0x2849bc,'totalPayments':_0x1cd4dd,'totalRevenue':Math[_0x58fab9(0x24d)](_0x4ac3e1*0x64)/0x64,'conversionRate':Math[_0x58fab9(0x24d)](_0x5de3f4*0x64)/0x64};}[a50_0x207e4d(0x228)](_0x243508){const _0x470cc6=a50_0x207e4d;return{'id':_0x243508['id'],'shopId':_0x243508['shopId'],'amount':_0x243508['amount'],'currency':_0x243508[_0x470cc6(0x201)],'sourceCurrency':_0x243508[_0x470cc6(0x263)]||undefined,'gateway':_0x243508[_0x470cc6(0x27e)],'type':_0x243508['type'],'currentPayments':_0x243508['currentPayments'],'status':_0x243508[_0x470cc6(0x1cc)],'expiresAt':_0x243508[_0x470cc6(0x21b)]||undefined,'successUrl':_0x243508['successUrl']||undefined,'failUrl':_0x243508[_0x470cc6(0x1f0)]||undefined,'pendingUrl':_0x243508[_0x470cc6(0x18b)]||undefined,'country':_0x243508['country']||undefined,'language':_0x243508[_0x470cc6(0x267)]||undefined,'linkUrl':'https://app.trapay.uk/link/'+_0x243508['id'],'createdAt':_0x243508[_0x470cc6(0x27c)],'updatedAt':_0x243508[_0x470cc6(0x181)],'shop':_0x243508[_0x470cc6(0x1f8)],'payments':_0x243508['payments']};}}function a50_0xa988(_0x48e6fd,_0x4c49cf){const _0x1b8637=a50_0x1b86();return a50_0xa988=function(_0xa9886d,_0x9e1d03){_0xa9886d=_0xa9886d-0x167;let _0x4e5d57=_0x1b8637[_0xa9886d];return _0x4e5d57;},a50_0xa988(_0x48e6fd,_0x4c49cf);}exports['PaymentLinkService']=PaymentLinkService;