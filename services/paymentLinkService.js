'use strict';const a49_0x5e9bd7=a49_0x5691;(function(_0x4d3f1b,_0x5465f3){const _0x1261c0=a49_0x5691,_0x213417=_0x4d3f1b();while(!![]){try{const _0x44dc7b=parseInt(_0x1261c0(0x1a4))/0x1*(-parseInt(_0x1261c0(0x25e))/0x2)+parseInt(_0x1261c0(0x24a))/0x3*(parseInt(_0x1261c0(0x1b6))/0x4)+-parseInt(_0x1261c0(0x267))/0x5+-parseInt(_0x1261c0(0x1da))/0x6*(-parseInt(_0x1261c0(0x18b))/0x7)+parseInt(_0x1261c0(0x18a))/0x8+-parseInt(_0x1261c0(0x219))/0x9+-parseInt(_0x1261c0(0x22a))/0xa*(-parseInt(_0x1261c0(0x268))/0xb);if(_0x44dc7b===_0x5465f3)break;else _0x213417['push'](_0x213417['shift']());}catch(_0x2acf13){_0x213417['push'](_0x213417['shift']());}}}(a49_0x328c,0xbee06));var __importDefault=this&&this['__importDefault']||function(_0x451682){const _0x60960b=a49_0x5691;return _0x451682&&_0x451682[_0x60960b(0x17a)]?_0x451682:{'default':_0x451682};};Object['defineProperty'](exports,a49_0x5e9bd7(0x17a),{'value':!![]}),exports[a49_0x5e9bd7(0x1f1)]=void 0x0;function a49_0x5691(_0x204b6c,_0x59fc9e){const _0x328c06=a49_0x328c();return a49_0x5691=function(_0x569121,_0x5cdc2a){_0x569121=_0x569121-0x16b;let _0x5d860b=_0x328c06[_0x569121];return _0x5d860b;},a49_0x5691(_0x204b6c,_0x59fc9e);}function a49_0x328c(){const _0x10f183=['💰\x20Amount:\x20','nodaService','🧪\x20Test\x20Gateway\x20form\x20URL:\x20','toISOString','\x20completed\x20(','cointopay','\x20(Plisio\x20or\x20KLYME)','getPaymentLinkById','Shop\x20not\x20found','4391496GlyvpT','Payment\x20link\x20not\x20found','🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','status','🔐\x20Shop\x20','https://tesoft.uk/gateways/noda/webhook','payment','GBP','Payment\x20link\x20has\x20reached\x20maximum\x20payments','🧪\x20Creating\x20Test\x20Gateway\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','../types/gateway','\x20using\x20default\x20gateways:','🎯\x20Generated\x20gateway\x20order_id:\x20','✅\x20Amount\x20','\x20payment\x20URL:\x20','\x20with\x20payment\x20ID\x20','none','\x20\x20\x20💾\x20DB\x20Pending\x20URL:\x20','\x20(Test\x20Gateway)','💱\x20Converted\x20','\x20link\x20','Anonymous','desc','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20','💾\x20DB\x20Pending\x20URL:\x20','Payment\x20link\x20','toFixed','startsWith','length','join','\x20(8digits-8digits\x20format\x20for\x20','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','Payment\x20link\x20has\x20expired','klymeService','2208DdPHrB','Payment\x20','gatewaySettings','currencyService','RapydService','💰\x20Checking\x20amount\x20limits\x20for\x20gateway:\x20','handleSuccessfulPayment','paymentLinkId','\x20USDT','getGatewayDisplayName','📈\x20Single\x20payment\x20link\x20','getGatewayNameById','🏁\x20Payment\x20link\x20','currentPayments','qr_url','🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','💳\x20Initiating\x20payment\x20from\x20','insensitive','🔗\x20MasterCard\x20payment\x20URL:\x20','temp','\x22\x20not\x20allowed\x20for\x20shop\x20','currency','validateKlymeCurrency','PaymentLinkService','count','sourceCurrency','\x20status\x20is\x20','\x20USDT)\x20is\x20below\x20the\x20minimum\x20required\x20amount\x20of\x20','getPaymentLinks','shopId','error','failUrl',')\x20counter\x20updated:\x20','\x20payments)','checkAmountLimits','padStart','\x20payments),\x20skipping\x20increment','qr_code','update','env','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','SINGLE','gateway','🔗\x20Noda\x20payment\x20URL:\x20','\x20(MasterCard)','./coinToPayStatusService','💰\x20Shop\x20','\x20already\x20used\x20(','rapydService','coinToPayStatusService','getPaymentLinkStatistics','👤\x20Customer:\x20','delete','noda','Gateway\x20not\x20found\x20for\x20ID:\x20','parse','./gateways/rapydService','ONCE','🔗\x20Link\x20type:\x20','includes','\x20USDT\x20for\x20limit\x20checking','\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20','💰\x20No\x20maximum\x20amount\x20set\x20for\x20gateway\x20','6822657LOvpvH','create','KlymeService','random','\x20USDT)\x20exceeds\x20the\x20maximum\x20allowed\x20amount\x20of\x20','PlisioService',',\x20amount:\x20','./gateways/coinToPayService','paymentGateways','mc_','getKlymeRegionFromGatewayName','\x20payment\x20link','📝\x20Note:\x20Success/Fail/Pending\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created','https://app.trapay.uk/payment/success?id=','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','&payment_id=','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','10984580tqMYih','🔗\x20Test\x20Gateway\x20payment\x20URL:\x20','$transaction','Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','Payment\x20amount\x20','🔐\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','https://app.trapay.uk/payment/','./gateways/klymeService','test_gateway','toUpperCase','💰\x20Gateway\x20','plisio','\x20(8digits-8digits\x20format)','https://tesoft.uk','🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','PAID','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','https://app.trapay.uk/link/','\x20(validated\x20for\x20','no\x20email','getPublicPaymentLinkData','generateGatewayOrderId','https://app.trapay.uk/payment/pending?id=','Shop\x20is\x20not\x20active','ceil','multi-use','\x20USDT\x20is\x20below\x20minimum\x20','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','checkGatewayPermission','Gateway\x20\x22','\x20\x20\x20🌐\x20Gateway\x20Pending\x20URL:\x20','3dBzfDD','🔗\x20Plisio\x20payment\x20URL:\x20','COMPLETED','country','Test\x20Gateway','updatePaymentLink','findFirst','payment_url','updatedAt','all','type','❌\x20Amount\x20','default','This\x20single-use\x20payment\x20link\x20has\x20already\x20been\x20used','💳\x20Creating\x20MasterCard\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','NodaService','Please\x20reduce\x20the\x20amount.','EUR','Plisio','📈\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','908CpeYLP','floor','🔐\x20Checking\x20if\x20\x22','klyme_','\x20not\x20found','💳\x20Creating\x20KLYME\x20','\x20USDT\x20for\x20gateway\x20','shop','KLYME\x20DE','284045tGHadY','11bPfeuB','🔗\x20KLYME\x20','gateway_payment_id','message','BASE_URL','expiresAt','\x20gateway.\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/','successUrl','createPayment','🔗\x20No\x20whiteUrl\x20for\x20','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','paidAt','deletePaymentLink','\x20USDT\x20for\x20','\x20USDT\x20meets\x20maximum\x20requirement\x20of\x20','plisioService','MAX_SAFE_INTEGER','pendingUrl','qr_code_url','formatPaymentLinkResponse','minAmount','__esModule','createPaymentLink','/gateway/pending.php?id=','amount\x20is\x20required\x20and\x20must\x20be\x20positive','name','✅\x20Gateway\x20\x22','username','findMany','🔗\x20Creating\x20','USD','FAILED','Invalid\x20KLYME\x20gateway:\x20','🔗\x20Generated\x20whiteUrl\x20for\x20','✅\x20Payment\x20link\x20created:\x20','📈\x20Payment\x20','MasterCard','335248wYPnJe','14266CrHJVU','/gateway/fail.php?id=','isValidGatewayId','Payment\x20link\x20is\x20not\x20active','convertToUSDT','./gateways/plisioService','invoice_total_sum','toString','maxAmount','PENDING','toLowerCase','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','\x20link\x20with\x20','Error\x20parsing\x20gateway\x20settings:','findUnique','/gateway/success.php?id=','\x20gateway\x20settings:','ACTIVE','amount','💾\x20DB\x20Success\x20URL:\x20','initiatePaymentFromLink','map','\x20\x20\x20🔗\x20White\x20URL:\x20','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','log','3065phlqOt','CoinToPay','test_','💳\x20MasterCard\x20form\x20URL:\x20','📈\x20Payment\x20link\x20','generateGatewayUrls','paymentLink','rapyd','coinToPayService'];a49_0x328c=function(){return _0x10f183;};return a49_0x328c();}const database_1=__importDefault(require('../config/database')),plisioService_1=require(a49_0x5e9bd7(0x190)),rapydService_1=require(a49_0x5e9bd7(0x212)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a49_0x5e9bd7(0x220)),klymeService_1=require(a49_0x5e9bd7(0x232)),coinToPayStatusService_1=require(a49_0x5e9bd7(0x207)),gateway_1=require(a49_0x5e9bd7(0x1c0)),currencyService_1=require('./currencyService');class PaymentLinkService{constructor(){const _0x2c22b1=a49_0x5e9bd7;this['plisioService']=new plisioService_1[(_0x2c22b1(0x21e))](),this[_0x2c22b1(0x20a)]=new rapydService_1[(_0x2c22b1(0x1de))](),this[_0x2c22b1(0x1ae)]=new nodaService_1[(_0x2c22b1(0x259))](),this[_0x2c22b1(0x1ac)]=new coinToPayService_1['CoinToPayService'](),this[_0x2c22b1(0x1d9)]=new klymeService_1[(_0x2c22b1(0x21b))]();}['generateGatewayOrderId'](){const _0x4e2354=()=>{const _0x585e11=a49_0x5691;return Math[_0x585e11(0x25f)](Math[_0x585e11(0x21c)]()*0x5f5e100)[_0x585e11(0x192)]()[_0x585e11(0x1fd)](0x8,'0');};return _0x4e2354()+'-'+_0x4e2354();}[a49_0x5e9bd7(0x1a9)](_0x4aa18f,_0x1b1f34,_0x59d645,_0x3ed81a,_0x155639,_0x19cca1,_0x58e00d){const _0x2f53d0=a49_0x5e9bd7;if(_0x155639&&_0x19cca1&&_0x58e00d)return{'finalSuccessUrl':_0x155639,'finalFailUrl':_0x19cca1,'finalPendingUrl':_0x58e00d,'dbSuccessUrl':_0x155639,'dbFailUrl':_0x19cca1,'dbPendingUrl':_0x58e00d,'whiteUrl':null};const _0x5edadb=_0x155639||_0x2f53d0(0x226)+_0x1b1f34+_0x2f53d0(0x228)+_0x59d645,_0x4ae9d4=_0x19cca1||'https://app.trapay.uk/payment/fail?id='+_0x1b1f34+_0x2f53d0(0x228)+_0x59d645,_0x538e51=_0x58e00d||_0x2f53d0(0x241)+_0x1b1f34+'&payment_id='+_0x59d645;let _0x11ce81,_0x22050c,_0x461080;_0x4aa18f===_0x2f53d0(0x20f)||_0x4aa18f['startsWith'](_0x2f53d0(0x261))||_0x4aa18f===_0x2f53d0(0x1b2)?(_0x11ce81=_0x3ed81a+'/gateway/pending.php?id='+_0x1b1f34,_0x461080=_0x3ed81a+_0x2f53d0(0x17c)+_0x1b1f34):(_0x11ce81=_0x3ed81a+_0x2f53d0(0x19a)+_0x1b1f34,_0x461080=_0x3ed81a+_0x2f53d0(0x17c)+_0x1b1f34);_0x22050c=_0x3ed81a+_0x2f53d0(0x18c)+_0x1b1f34;let _0x357604=null;return _0x4aa18f!=='plisio'&&!_0x4aa18f[_0x2f53d0(0x1d1)]('klyme_')?(_0x357604='https://tesoft.uk/gateway/payment.php?id='+_0x1b1f34,console[_0x2f53d0(0x1a3)](_0x2f53d0(0x186)+_0x4aa18f+':\x20'+_0x357604)):console[_0x2f53d0(0x1a3)](_0x2f53d0(0x16e)+_0x4aa18f+_0x2f53d0(0x1b3)),console[_0x2f53d0(0x1a3)]('🔗\x20Generated\x20URLs\x20for\x20'+_0x4aa18f+_0x2f53d0(0x1c5)+_0x1b1f34+':'),console[_0x2f53d0(0x1a3)](_0x2f53d0(0x246)+_0x11ce81),console[_0x2f53d0(0x1a3)](_0x2f53d0(0x196)+_0x22050c),console[_0x2f53d0(0x1a3)](_0x2f53d0(0x249)+_0x461080),console[_0x2f53d0(0x1a3)](_0x2f53d0(0x227)+_0x5edadb),console[_0x2f53d0(0x1a3)](_0x2f53d0(0x217)+_0x4ae9d4),console[_0x2f53d0(0x1a3)](_0x2f53d0(0x1c7)+_0x538e51),console[_0x2f53d0(0x1a3)](_0x2f53d0(0x1a1)+(_0x357604||_0x2f53d0(0x1c6))),{'finalSuccessUrl':_0x11ce81,'finalFailUrl':_0x22050c,'finalPendingUrl':_0x461080,'dbSuccessUrl':_0x5edadb,'dbFailUrl':_0x4ae9d4,'dbPendingUrl':_0x538e51,'whiteUrl':_0x357604};}[a49_0x5e9bd7(0x1f0)](_0x4ebd9a,_0x42c757){const _0x5129ad=a49_0x5e9bd7;if(!_0x4ebd9a[_0x5129ad(0x1d1)](_0x5129ad(0x261)))return;const _0x5e05c4=(0x0,gateway_1[_0x5129ad(0x223)])(_0x4ebd9a),_0xa48830=_0x42c757[_0x5129ad(0x234)]();switch(_0x5e05c4){case'EU':if(_0xa48830!==_0x5129ad(0x25b))throw new Error(_0x5129ad(0x202)+_0xa48830);break;case'GB':if(_0xa48830!==_0x5129ad(0x1bd))throw new Error(_0x5129ad(0x16f)+_0xa48830);break;case'DE':if(_0xa48830!=='EUR')throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0xa48830);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x5e05c4);}}async['checkAmountLimits'](_0x58d896,_0x5af3c2,_0x5f3b4b,_0xa79dc5){const _0x50f0de=a49_0x5e9bd7;console[_0x50f0de(0x1a3)]('💰\x20Checking\x20amount\x20limits\x20for\x20shop\x20'+_0x58d896+',\x20gateway\x20'+_0x5af3c2+_0x50f0de(0x21f)+_0x5f3b4b+'\x20'+_0xa79dc5);const _0x2b166b=await currencyService_1[_0x50f0de(0x1dd)][_0x50f0de(0x18f)](_0x5f3b4b,_0xa79dc5);console['log'](_0x50f0de(0x1c9)+_0x5f3b4b+'\x20'+_0xa79dc5+'\x20to\x20'+_0x2b166b[_0x50f0de(0x1d0)](0x6)+_0x50f0de(0x216));const _0x41b977=await database_1['default'][_0x50f0de(0x265)][_0x50f0de(0x199)]({'where':{'id':_0x58d896},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x41b977)throw new Error(_0x50f0de(0x1b5));let _0x5137f9={};if(_0x41b977[_0x50f0de(0x1dc)])try{_0x5137f9=JSON['parse'](_0x41b977[_0x50f0de(0x1dc)]),console[_0x50f0de(0x1a3)](_0x50f0de(0x208)+_0x41b977['username']+_0x50f0de(0x19b),_0x5137f9);}catch(_0x40b9f9){console[_0x50f0de(0x1f8)](_0x50f0de(0x198),_0x40b9f9),_0x5137f9={};}const _0x26ac72=this[_0x50f0de(0x1e3)](_0x5af3c2);console[_0x50f0de(0x1a3)](_0x50f0de(0x1df)+_0x5af3c2+'\x20->\x20'+_0x26ac72);const _0x2f0e97=_0x5137f9[_0x26ac72];if(_0x2f0e97&&_0x2f0e97[_0x50f0de(0x179)]!==undefined){const _0x54606f=_0x2f0e97[_0x50f0de(0x179)];console[_0x50f0de(0x1a3)](_0x50f0de(0x235)+_0x26ac72+'\x20minimum\x20amount:\x20'+_0x54606f+_0x50f0de(0x1e2));if(_0x2b166b<_0x54606f){console[_0x50f0de(0x1f8)](_0x50f0de(0x255)+_0x2b166b[_0x50f0de(0x1d0)](0x6)+_0x50f0de(0x245)+_0x54606f+'\x20USDT\x20for\x20gateway\x20'+_0x26ac72);throw new Error(_0x50f0de(0x22f)+_0x5f3b4b+'\x20'+_0xa79dc5+'\x20('+_0x2b166b['toFixed'](0x2)+_0x50f0de(0x1f5)+_0x54606f+_0x50f0de(0x172)+_0x26ac72+_0x50f0de(0x26e)+'Please\x20increase\x20the\x20amount.');}console['log']('✅\x20Amount\x20'+_0x2b166b[_0x50f0de(0x1d0)](0x6)+'\x20USDT\x20meets\x20minimum\x20requirement\x20of\x20'+_0x54606f+_0x50f0de(0x264)+_0x26ac72);}else console[_0x50f0de(0x1a3)]('💰\x20No\x20minimum\x20amount\x20set\x20for\x20gateway\x20'+_0x26ac72);if(_0x2f0e97&&_0x2f0e97[_0x50f0de(0x193)]!==undefined){const _0x2fa3b1=_0x2f0e97[_0x50f0de(0x193)];console[_0x50f0de(0x1a3)]('💰\x20Gateway\x20'+_0x26ac72+'\x20maximum\x20amount:\x20'+_0x2fa3b1+'\x20USDT');if(_0x2b166b>_0x2fa3b1){console[_0x50f0de(0x1f8)](_0x50f0de(0x255)+_0x2b166b[_0x50f0de(0x1d0)](0x6)+'\x20USDT\x20exceeds\x20maximum\x20'+_0x2fa3b1+'\x20USDT\x20for\x20gateway\x20'+_0x26ac72);throw new Error(_0x50f0de(0x22f)+_0x5f3b4b+'\x20'+_0xa79dc5+'\x20('+_0x2b166b[_0x50f0de(0x1d0)](0x2)+_0x50f0de(0x21d)+_0x2fa3b1+_0x50f0de(0x172)+_0x26ac72+'\x20gateway.\x20'+_0x50f0de(0x25a));}console['log'](_0x50f0de(0x1c3)+_0x2b166b[_0x50f0de(0x1d0)](0x6)+_0x50f0de(0x173)+_0x2fa3b1+'\x20USDT\x20for\x20gateway\x20'+_0x26ac72);}else console[_0x50f0de(0x1a3)](_0x50f0de(0x218)+_0x26ac72);}async[a49_0x5e9bd7(0x247)](_0x3f8098,_0x4338a8){const _0x5371be=a49_0x5e9bd7;console[_0x5371be(0x1a3)](_0x5371be(0x230)+_0x3f8098+':\x20'+_0x4338a8);const _0x3e2ad9=await database_1[_0x5371be(0x256)][_0x5371be(0x265)]['findUnique']({'where':{'id':_0x3f8098},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x3e2ad9)throw new Error(_0x5371be(0x1b5));let _0x4a0d8f=[];if(_0x3e2ad9[_0x5371be(0x221)])try{_0x4a0d8f=JSON[_0x5371be(0x211)](_0x3e2ad9['paymentGateways']),console['log']('🔐\x20Shop\x20'+_0x3e2ad9[_0x5371be(0x180)]+'\x20enabled\x20gateways:',_0x4a0d8f);}catch(_0x7cb369){console[_0x5371be(0x1f8)]('Error\x20parsing\x20payment\x20gateways:',_0x7cb369),_0x4a0d8f=['Plisio'];}else _0x4a0d8f=['Plisio'],console[_0x5371be(0x1a3)](_0x5371be(0x1ba)+_0x3e2ad9[_0x5371be(0x180)]+_0x5371be(0x1c1),_0x4a0d8f);const _0x3198a6=this[_0x5371be(0x1e3)](_0x4338a8);console[_0x5371be(0x1a3)](_0x5371be(0x260)+_0x3198a6+'\x22\x20is\x20in\x20enabled\x20gateways:',_0x4a0d8f);if(!_0x4a0d8f[_0x5371be(0x215)](_0x3198a6)){console['error']('❌\x20Gateway\x20\x22'+_0x3198a6+_0x5371be(0x1ee)+_0x3e2ad9[_0x5371be(0x180)]),console['error']('❌\x20Enabled\x20gateways:\x20'+_0x4a0d8f[_0x5371be(0x1d3)](',\x20'));throw new Error(_0x5371be(0x248)+_0x3198a6+_0x5371be(0x23b)+('Enabled\x20gateways:\x20'+_0x4a0d8f[_0x5371be(0x1d3)](',\x20')+'.\x20')+_0x5371be(0x22d));}console[_0x5371be(0x1a3)](_0x5371be(0x17f)+_0x3198a6+'\x22\x20is\x20allowed\x20for\x20shop\x20'+_0x3e2ad9[_0x5371be(0x180)]);}[a49_0x5e9bd7(0x1e3)](_0x4e2679){const _0x3a5d59=a49_0x5e9bd7,_0x559134={'test_gateway':_0x3a5d59(0x24e),'plisio':_0x3a5d59(0x25c),'rapyd':'Rapyd','noda':'Noda','cointopay':_0x3a5d59(0x1a5),'klyme_eu':'KLYME\x20EU','klyme_gb':'KLYME\x20GB','klyme_de':_0x3a5d59(0x266),'mastercard':_0x3a5d59(0x189)};return _0x559134[_0x4e2679]||_0x4e2679;}async[a49_0x5e9bd7(0x17b)](_0x23f8ad,_0x451f7b){const _0x46a216=a49_0x5e9bd7;if(!(0x0,gateway_1[_0x46a216(0x18d)])(_0x451f7b[_0x46a216(0x204)]))throw new Error('Invalid\x20gateway\x20ID:\x20'+_0x451f7b[_0x46a216(0x204)]+'.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)');const _0x195f3e=(0x0,gateway_1['getGatewayNameById'])(_0x451f7b['gateway']);if(!_0x195f3e)throw new Error(_0x46a216(0x210)+_0x451f7b['gateway']);console[_0x46a216(0x1a3)](_0x46a216(0x1e9)+_0x195f3e),await this[_0x46a216(0x247)](_0x23f8ad,_0x195f3e);if(_0x195f3e==='plisio'&&!_0x451f7b[_0x46a216(0x1f3)])throw new Error(_0x46a216(0x1d5));if(_0x195f3e['startsWith'](_0x46a216(0x261))){const _0x378810=(0x0,gateway_1[_0x46a216(0x223)])(_0x195f3e);console[_0x46a216(0x1a3)](_0x46a216(0x263)+_0x378810+_0x46a216(0x224));}let _0xffcb9=_0x451f7b[_0x46a216(0x24d)];_0x195f3e===_0x46a216(0x1ab)&&(_0xffcb9='GB',console[_0x46a216(0x1a3)](_0x46a216(0x22e)));if(!_0x451f7b['amount']||_0x451f7b[_0x46a216(0x19d)]<=0x0)throw new Error(_0x46a216(0x17d));let _0x373e8c=_0x451f7b[_0x46a216(0x1ef)]||_0x46a216(0x183);_0x195f3e===_0x46a216(0x1b2)&&(_0x373e8c=_0x46a216(0x25b),console[_0x46a216(0x1a3)](_0x46a216(0x239)));this[_0x46a216(0x1f0)](_0x195f3e,_0x373e8c),await this[_0x46a216(0x1fc)](_0x23f8ad,_0x195f3e,_0x451f7b[_0x46a216(0x19d)],_0x373e8c);const _0x3840bb=_0x451f7b[_0x46a216(0x254)]||_0x46a216(0x203);console[_0x46a216(0x1a3)](_0x46a216(0x182)+_0x3840bb+_0x46a216(0x224));const _0x4fa75f=await database_1[_0x46a216(0x256)][_0x46a216(0x1aa)][_0x46a216(0x21a)]({'data':{'shopId':_0x23f8ad,'amount':_0x451f7b['amount'],'currency':_0x373e8c,'sourceCurrency':_0x451f7b[_0x46a216(0x1f3)]||undefined,'gateway':_0x195f3e,'type':_0x3840bb,'currentPayments':0x0,'status':_0x46a216(0x19c),'expiresAt':_0x451f7b[_0x46a216(0x26d)]?new Date(_0x451f7b[_0x46a216(0x26d)]):undefined,'successUrl':_0x451f7b[_0x46a216(0x16c)]||null,'failUrl':_0x451f7b['failUrl']||null,'pendingUrl':_0x451f7b[_0x46a216(0x176)]||null,'country':_0xffcb9,'language':_0x451f7b['language']||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console['log'](_0x46a216(0x187)+_0x4fa75f['id']+'\x20('+_0x195f3e+')'),console[_0x46a216(0x1a3)]('💰\x20Fixed\x20amount:\x20'+_0x4fa75f[_0x46a216(0x19d)]+'\x20'+_0x4fa75f[_0x46a216(0x1ef)]),console[_0x46a216(0x1a3)](_0x46a216(0x214)+_0x4fa75f[_0x46a216(0x254)]),console['log'](_0x46a216(0x16b)+_0x4fa75f['id']),console['log'](_0x46a216(0x225)),this['formatPaymentLinkResponse'](_0x4fa75f);}async[a49_0x5e9bd7(0x1f6)](_0x270089,_0x281355){const _0x68b36a=a49_0x5e9bd7,{page:_0xe8c546,limit:_0x1d432d,status:_0x4d1c88,gateway:_0x15d9c7,search:_0xc6e4c3}=_0x281355,_0x3e83fe=(_0xe8c546-0x1)*_0x1d432d,_0x46448c={'shopId':_0x270089};_0x4d1c88&&(_0x46448c[_0x68b36a(0x1b9)]=_0x4d1c88['toUpperCase']());if(_0x15d9c7){if((0x0,gateway_1[_0x68b36a(0x18d)])(_0x15d9c7)){const _0x3a4fd6=(0x0,gateway_1[_0x68b36a(0x1e5)])(_0x15d9c7);_0x3a4fd6&&(_0x46448c[_0x68b36a(0x204)]=_0x3a4fd6);}else _0x46448c[_0x68b36a(0x204)]=_0x15d9c7[_0x68b36a(0x195)]();}_0xc6e4c3&&(_0x46448c['OR']=[{'gateway':{'contains':_0xc6e4c3,'mode':'insensitive'}},{'currency':{'contains':_0xc6e4c3,'mode':_0x68b36a(0x1eb)}}]);const [_0x573f44,_0x4f48b5]=await Promise[_0x68b36a(0x253)]([database_1[_0x68b36a(0x256)][_0x68b36a(0x1aa)][_0x68b36a(0x181)]({'where':_0x46448c,'skip':_0x3e83fe,'take':_0x1d432d,'orderBy':{'createdAt':_0x68b36a(0x1cc)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x68b36a(0x1cc)},'take':0xa}}}),database_1[_0x68b36a(0x256)]['paymentLink'][_0x68b36a(0x1f2)]({'where':_0x46448c})]);return{'links':_0x573f44[_0x68b36a(0x1a0)](_0x406598=>this[_0x68b36a(0x178)](_0x406598)),'pagination':{'page':_0xe8c546,'limit':_0x1d432d,'total':_0x4f48b5,'totalPages':Math[_0x68b36a(0x243)](_0x4f48b5/_0x1d432d)}};}async[a49_0x5e9bd7(0x1b4)](_0x397c2d,_0x48cb4d){const _0x2dbec8=a49_0x5e9bd7,_0x437c36=await database_1[_0x2dbec8(0x256)][_0x2dbec8(0x1aa)][_0x2dbec8(0x250)]({'where':{'id':_0x48cb4d,'shopId':_0x397c2d},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'}}}});if(!_0x437c36)return null;return this[_0x2dbec8(0x178)](_0x437c36);}async[a49_0x5e9bd7(0x24f)](_0x43f030,_0x44dc5a,_0x4edc8e){const _0xd86992=a49_0x5e9bd7,_0x327738={..._0x4edc8e};if(_0x4edc8e['gateway']){if((0x0,gateway_1[_0xd86992(0x18d)])(_0x4edc8e[_0xd86992(0x204)])){const _0x588311=(0x0,gateway_1['getGatewayNameById'])(_0x4edc8e[_0xd86992(0x204)]);_0x588311&&(await this[_0xd86992(0x247)](_0x43f030,_0x588311),_0x327738[_0xd86992(0x204)]=_0x588311);}else _0x327738[_0xd86992(0x204)]=_0x4edc8e['gateway'][_0xd86992(0x195)]();}(_0x327738[_0xd86992(0x204)]==='rapyd'||_0x4edc8e[_0xd86992(0x24d)]&&_0x327738[_0xd86992(0x204)]!==_0xd86992(0x1ab))&&(_0x327738[_0xd86992(0x204)]==='rapyd'&&(_0x327738[_0xd86992(0x24d)]='GB',console['log']('🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update')));_0x327738[_0xd86992(0x204)]===_0xd86992(0x1b2)&&(_0x327738[_0xd86992(0x1ef)]=_0xd86992(0x25b),console['log'](_0xd86992(0x1a2)));_0x327738[_0xd86992(0x204)]&&_0x327738[_0xd86992(0x1ef)]&&this[_0xd86992(0x1f0)](_0x327738['gateway'],_0x327738[_0xd86992(0x1ef)]);if(_0x4edc8e[_0xd86992(0x19d)]&&_0x327738['gateway']){const _0x288b44=_0x4edc8e['currency']||_0xd86992(0x183);await this['checkAmountLimits'](_0x43f030,_0x327738[_0xd86992(0x204)],_0x4edc8e['amount'],_0x288b44);}_0x4edc8e[_0xd86992(0x26d)]&&(_0x327738[_0xd86992(0x26d)]=new Date(_0x4edc8e[_0xd86992(0x26d)]));const _0x5e7f48=await database_1[_0xd86992(0x256)]['paymentLink'][_0xd86992(0x200)]({'where':{'id':_0x44dc5a,'shopId':_0x43f030},'data':_0x327738,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0xd86992(0x1cc)},'take':0xa}}});return this['formatPaymentLinkResponse'](_0x5e7f48);}async[a49_0x5e9bd7(0x171)](_0x56ce11,_0x761899){const _0x215ccd=a49_0x5e9bd7;await database_1[_0x215ccd(0x256)][_0x215ccd(0x1aa)][_0x215ccd(0x20e)]({'where':{'id':_0x761899,'shopId':_0x56ce11}});}async[a49_0x5e9bd7(0x23f)](_0x413c27){const _0x49ce23=a49_0x5e9bd7,_0x8ac53b=await database_1[_0x49ce23(0x256)][_0x49ce23(0x1aa)][_0x49ce23(0x199)]({'where':{'id':_0x413c27},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x8ac53b)return null;const _0x5b8ed8=_0x8ac53b[_0x49ce23(0x26d)]&&_0x8ac53b[_0x49ce23(0x26d)]<new Date(),_0x2dbfc6=_0x8ac53b[_0x49ce23(0x254)]===_0x49ce23(0x203)?_0x8ac53b['currentPayments']>=0x1:![],_0x37e72b=_0x8ac53b[_0x49ce23(0x265)]['status']===_0x49ce23(0x19c),_0x40d6c9=_0x8ac53b[_0x49ce23(0x1b9)]===_0x49ce23(0x19c),_0x259b99=!_0x5b8ed8&&!_0x2dbfc6&&_0x37e72b&&_0x40d6c9,_0x30a620=_0x8ac53b['type']===_0x49ce23(0x203)?_0x8ac53b['currentPayments']>=0x1?0x0:0x1:Number[_0x49ce23(0x175)];return{'id':_0x8ac53b['id'],'amount':_0x8ac53b[_0x49ce23(0x19d)],'currency':_0x8ac53b[_0x49ce23(0x1ef)],'sourceCurrency':_0x8ac53b[_0x49ce23(0x1f3)]||undefined,'gateway':_0x8ac53b['gateway'],'type':_0x8ac53b[_0x49ce23(0x254)],'currentPayments':_0x8ac53b[_0x49ce23(0x1e7)],'status':_0x8ac53b['status'],'expiresAt':_0x8ac53b['expiresAt']||undefined,'shopName':_0x8ac53b[_0x49ce23(0x265)][_0x49ce23(0x17e)],'isAvailable':_0x259b99,'remainingPayments':_0x30a620};}async[a49_0x5e9bd7(0x19f)](_0x190c69){const _0x3ef73d=a49_0x5e9bd7,{linkId:_0xc51c8f,customerEmail:_0xd5c847,customerName:_0x2d0e6b}=_0x190c69,_0x477c2b=await database_1['default'][_0x3ef73d(0x1aa)]['findUnique']({'where':{'id':_0xc51c8f},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x477c2b)throw new Error(_0x3ef73d(0x1b7));const _0x30ab48=_0x477c2b[_0x3ef73d(0x26d)]&&_0x477c2b['expiresAt']<new Date(),_0x43df9c=_0x477c2b[_0x3ef73d(0x254)]===_0x3ef73d(0x203)?_0x477c2b[_0x3ef73d(0x1e7)]>=0x1:![],_0x49f001=_0x477c2b[_0x3ef73d(0x265)]['status']===_0x3ef73d(0x19c),_0x388e59=_0x477c2b[_0x3ef73d(0x1b9)]===_0x3ef73d(0x19c);if(_0x30ab48)throw new Error(_0x3ef73d(0x1d8));if(_0x43df9c){const _0x4371dc=_0x477c2b[_0x3ef73d(0x254)]===_0x3ef73d(0x203)?_0x3ef73d(0x257):_0x3ef73d(0x1be);throw new Error(_0x4371dc);}if(!_0x49f001)throw new Error(_0x3ef73d(0x242));if(!_0x388e59)throw new Error(_0x3ef73d(0x18e));await this['checkGatewayPermission'](_0x477c2b[_0x3ef73d(0x1f7)],_0x477c2b[_0x3ef73d(0x204)]);const _0xda92d1=_0x477c2b[_0x3ef73d(0x19d)];console[_0x3ef73d(0x1a3)](_0x3ef73d(0x1ea)+_0x477c2b[_0x3ef73d(0x254)]+_0x3ef73d(0x1ca)+_0xc51c8f+':\x20'+_0xda92d1+'\x20'+_0x477c2b['currency']),console[_0x3ef73d(0x1a3)]('👤\x20Customer:\x20'+(_0x2d0e6b||_0x3ef73d(0x1cb))+'\x20('+(_0xd5c847||_0x3ef73d(0x23e))+')'),this['validateKlymeCurrency'](_0x477c2b[_0x3ef73d(0x204)],_0x477c2b[_0x3ef73d(0x1ef)]),await this['checkAmountLimits'](_0x477c2b['shopId'],_0x477c2b[_0x3ef73d(0x204)],_0xda92d1,_0x477c2b[_0x3ef73d(0x1ef)]);const _0x235a77=this[_0x3ef73d(0x240)]();console['log'](_0x3ef73d(0x1c2)+_0x235a77+_0x3ef73d(0x1d4)+_0x477c2b['gateway']+')');const _0x3705b7=await database_1[_0x3ef73d(0x256)]['payment']['create']({'data':{'shopId':_0x477c2b[_0x3ef73d(0x1f7)],'paymentLinkId':_0x477c2b['id'],'gateway':_0x477c2b[_0x3ef73d(0x204)],'amount':_0xda92d1,'currency':_0x477c2b['currency'],'sourceCurrency':_0x477c2b['sourceCurrency']||undefined,'usage':_0x3ef73d(0x213),'expiresAt':_0x477c2b['expiresAt']||undefined,'successUrl':_0x3ef73d(0x1ed),'failUrl':'temp','pendingUrl':_0x3ef73d(0x1ed),'whiteUrl':'temp','status':_0x3ef73d(0x194),'orderId':null,'gatewayOrderId':_0x235a77,'customerEmail':_0xd5c847||undefined,'customerName':_0x2d0e6b||undefined,'country':_0x477c2b[_0x3ef73d(0x24d)]||undefined,'language':_0x477c2b['language']||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x3ef73d(0x1a3)]('💾\x20Payment\x20created:\x20'+_0x3705b7['id']);const _0x444450=process[_0x3ef73d(0x201)][_0x3ef73d(0x26c)]||_0x3ef73d(0x238),{finalSuccessUrl:_0x57bdc0,finalFailUrl:_0xf304fd,finalPendingUrl:_0x383d52,dbSuccessUrl:_0x48cf61,dbFailUrl:_0x35d5e9,dbPendingUrl:_0x5c6e74,whiteUrl:_0x18de87}=this['generateGatewayUrls'](_0x477c2b[_0x3ef73d(0x204)],_0x3705b7['id'],_0x235a77,_0x444450,_0x477c2b['successUrl']||undefined,_0x477c2b[_0x3ef73d(0x1f9)]||undefined,_0x477c2b[_0x3ef73d(0x176)]||undefined);await database_1[_0x3ef73d(0x256)][_0x3ef73d(0x1bc)]['update']({'where':{'id':_0x3705b7['id']},'data':{'successUrl':_0x48cf61,'failUrl':_0x35d5e9,'pendingUrl':_0x5c6e74,'whiteUrl':_0x18de87}}),console[_0x3ef73d(0x1a3)](_0x3ef73d(0x1ad)+_0xda92d1+'\x20'+_0x477c2b[_0x3ef73d(0x1ef)]),console[_0x3ef73d(0x1a3)](_0x3ef73d(0x20d)+(_0x2d0e6b||_0x3ef73d(0x1cb))+'\x20('+(_0xd5c847||'no\x20email')+')'),console['log'](_0x3ef73d(0x19e)+_0x48cf61),console[_0x3ef73d(0x1a3)]('💾\x20DB\x20Fail\x20URL:\x20'+_0x35d5e9),console[_0x3ef73d(0x1a3)](_0x3ef73d(0x1ce)+_0x5c6e74),console['log']('🔗\x20White\x20URL:\x20'+(_0x18de87||'none'));let _0x25ceaa,_0xfa15d4;try{if(_0x477c2b['gateway']===_0x3ef73d(0x236)){console[_0x3ef73d(0x1a3)]('💰\x20Plisio\x20payment\x20link\x20mapping:'),console[_0x3ef73d(0x1a3)]('\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20'+_0x477c2b['currency']),console[_0x3ef73d(0x1a3)]('\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20'+_0x477c2b[_0x3ef73d(0x1f3)]);const _0x7f54b5=await this[_0x3ef73d(0x174)][_0x3ef73d(0x16d)]({'paymentId':_0x3705b7['id'],'orderId':_0x235a77,'amount':_0xda92d1,'currency':_0x477c2b[_0x3ef73d(0x1ef)],'productName':'Payment\x20'+_0xda92d1+'\x20'+_0x477c2b[_0x3ef73d(0x1ef)],'description':_0x3ef73d(0x1db)+_0xda92d1+'\x20'+_0x477c2b['currency'],'successUrl':_0x57bdc0,'failUrl':_0xf304fd,'customerEmail':_0xd5c847||undefined,'customerName':_0x2d0e6b||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x477c2b[_0x3ef73d(0x1f3)]||undefined});_0x25ceaa=_0x7f54b5[_0x3ef73d(0x26a)],_0xfa15d4=_0x7f54b5[_0x3ef73d(0x251)],await database_1[_0x3ef73d(0x256)][_0x3ef73d(0x1bc)][_0x3ef73d(0x200)]({'where':{'id':_0x3705b7['id']},'data':{'externalPaymentUrl':_0xfa15d4,'gatewayPaymentId':_0x25ceaa,'invoiceTotalSum':Number(_0x7f54b5[_0x3ef73d(0x191)]),'qrCode':_0x7f54b5[_0x3ef73d(0x1ff)],'qrUrl':_0x7f54b5[_0x3ef73d(0x1e8)]}});const _0x245bf3='https://app.trapay.uk/payment/'+_0x3705b7['id'];return console[_0x3ef73d(0x1a3)](_0x3ef73d(0x24b)+_0x245bf3),{'paymentId':_0x3705b7['id'],'paymentUrl':_0x245bf3,'expiresAt':_0x3705b7[_0x3ef73d(0x26d)]||undefined};}else{if(_0x477c2b[_0x3ef73d(0x204)]===_0x3ef73d(0x1ab)){const _0x3972f9=await this[_0x3ef73d(0x20a)][_0x3ef73d(0x17b)]({'paymentId':_0x3705b7['id'],'orderId':_0x235a77,'orderName':'Payment\x20'+_0xda92d1+'\x20'+_0x477c2b[_0x3ef73d(0x1ef)],'amount':_0xda92d1,'currency':_0x477c2b[_0x3ef73d(0x1ef)],'country':_0x477c2b[_0x3ef73d(0x24d)],'language':_0x477c2b['language']||'EN','amountIsEditable':![],'usage':_0x3ef73d(0x213),'maxPayments':0x1,'successUrl':_0x57bdc0,'failUrl':_0xf304fd});_0x25ceaa=_0x3972f9[_0x3ef73d(0x26a)],_0xfa15d4=_0x3972f9['payment_url'],await database_1['default'][_0x3ef73d(0x1bc)]['update']({'where':{'id':_0x3705b7['id']},'data':{'externalPaymentUrl':_0xfa15d4,'gatewayPaymentId':_0x25ceaa}});const _0x1f3633=_0x3ef73d(0x231)+_0x3705b7['id'];return console['log']('🔗\x20Rapyd\x20payment\x20URL:\x20'+_0x1f3633),{'paymentId':_0x3705b7['id'],'paymentUrl':_0x1f3633,'expiresAt':_0x3705b7['expiresAt']||undefined};}else{if(_0x477c2b[_0x3ef73d(0x204)]===_0x3ef73d(0x20f)){const _0x14de39=await this[_0x3ef73d(0x1ae)][_0x3ef73d(0x17b)]({'paymentId':_0x3705b7['id'],'orderId':_0x235a77,'name':_0x3ef73d(0x1db)+_0xda92d1+'\x20'+_0x477c2b[_0x3ef73d(0x1ef)],'paymentDescription':'Payment\x20'+_0xda92d1+'\x20'+_0x477c2b[_0x3ef73d(0x1ef)],'amount':_0xda92d1,'currency':_0x477c2b[_0x3ef73d(0x1ef)],'webhookUrl':_0x3ef73d(0x1bb),'returnUrl':_0x383d52,'expiryDate':_0x477c2b['expiresAt']?.[_0x3ef73d(0x1b0)]()});_0x25ceaa=_0x14de39[_0x3ef73d(0x26a)],_0xfa15d4=_0x14de39[_0x3ef73d(0x251)],await database_1[_0x3ef73d(0x256)][_0x3ef73d(0x1bc)][_0x3ef73d(0x200)]({'where':{'id':_0x3705b7['id']},'data':{'externalPaymentUrl':_0xfa15d4,'gatewayPaymentId':_0x25ceaa,'qrUrl':_0x14de39[_0x3ef73d(0x177)]}});const _0x364fae=_0x3ef73d(0x231)+_0x3705b7['id'];return console[_0x3ef73d(0x1a3)](_0x3ef73d(0x205)+_0x364fae),{'paymentId':_0x3705b7['id'],'paymentUrl':_0x364fae,'expiresAt':_0x3705b7[_0x3ef73d(0x26d)]||undefined};}else{if(_0x477c2b[_0x3ef73d(0x204)]===_0x3ef73d(0x1b2)){console[_0x3ef73d(0x1a3)](_0x3ef73d(0x1b8)+_0x235a77+'\x20(8digits-8digits\x20format)'),console[_0x3ef73d(0x1a3)](_0x3ef73d(0x1ad)+_0xda92d1+'\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)');const _0x3b4595=await this[_0x3ef73d(0x1ac)][_0x3ef73d(0x17b)]({'paymentId':_0x3705b7['id'],'orderId':_0x235a77,'amount':_0xda92d1});_0x25ceaa=_0x3b4595['gateway_payment_id'],_0xfa15d4=_0x3b4595[_0x3ef73d(0x251)],await database_1[_0x3ef73d(0x256)][_0x3ef73d(0x1bc)]['update']({'where':{'id':_0x3705b7['id']},'data':{'externalPaymentUrl':_0xfa15d4,'gatewayPaymentId':_0x25ceaa}});_0x25ceaa&&(console[_0x3ef73d(0x1a3)](_0x3ef73d(0x1cd)+_0x3705b7['id']+'\x20('+_0x25ceaa+')'),coinToPayStatusService_1[_0x3ef73d(0x20b)]['schedulePaymentChecks'](_0x3705b7['id'],_0x25ceaa));const _0x1dd93c=_0x3ef73d(0x231)+_0x3705b7['id'];return console['log']('🔗\x20CoinToPay\x20payment\x20URL:\x20'+_0x1dd93c),{'paymentId':_0x3705b7['id'],'paymentUrl':_0x1dd93c,'expiresAt':_0x3705b7[_0x3ef73d(0x26d)]||undefined};}else{if(_0x477c2b[_0x3ef73d(0x204)][_0x3ef73d(0x1d1)](_0x3ef73d(0x261))){const _0x321470=(0x0,gateway_1[_0x3ef73d(0x223)])(_0x477c2b['gateway']);if(!_0x321470)throw new Error(_0x3ef73d(0x185)+_0x477c2b[_0x3ef73d(0x204)]);console[_0x3ef73d(0x1a3)]('💳\x20Creating\x20KLYME\x20'+_0x321470+'\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x235a77+_0x3ef73d(0x237)),console[_0x3ef73d(0x1a3)](_0x3ef73d(0x1ad)+_0xda92d1+'\x20'+_0x477c2b['currency']+_0x3ef73d(0x23d)+_0x321470+')');const _0x2c898b=await this['klymeService'][_0x3ef73d(0x17b)]({'paymentId':_0x3705b7['id'],'orderId':_0x235a77,'amount':_0xda92d1,'currency':_0x477c2b[_0x3ef73d(0x1ef)],'region':_0x321470,'redirectUrl':_0x383d52});_0x25ceaa=_0x2c898b[_0x3ef73d(0x26a)],_0xfa15d4=_0x2c898b[_0x3ef73d(0x251)],await database_1[_0x3ef73d(0x256)]['payment'][_0x3ef73d(0x200)]({'where':{'id':_0x3705b7['id']},'data':{'externalPaymentUrl':_0xfa15d4,'gatewayPaymentId':_0x25ceaa}});const _0x3e1b63=_0x3ef73d(0x231)+_0x3705b7['id'];return console[_0x3ef73d(0x1a3)]('✅\x20KLYME\x20'+_0x321470+_0x3ef73d(0x229)+_0x235a77),console['log'](_0x3ef73d(0x269)+_0x321470+_0x3ef73d(0x1c4)+_0x3e1b63),{'paymentId':_0x3705b7['id'],'paymentUrl':_0x3e1b63,'expiresAt':_0x3705b7[_0x3ef73d(0x26d)]||undefined};}else{if(_0x477c2b['gateway']==='test_gateway'){console[_0x3ef73d(0x1a3)](_0x3ef73d(0x1bf)+_0x235a77+_0x3ef73d(0x237)),console['log'](_0x3ef73d(0x1ad)+_0xda92d1+'\x20'+_0x477c2b[_0x3ef73d(0x1ef)]+_0x3ef73d(0x1c8));const _0x1fc21b='https://app.trapay.uk/test-gateway/payment/'+_0x3705b7['id'];await database_1[_0x3ef73d(0x256)][_0x3ef73d(0x1bc)]['update']({'where':{'id':_0x3705b7['id']},'data':{'externalPaymentUrl':_0x1fc21b,'gatewayPaymentId':_0x3ef73d(0x1a6)+_0x235a77}});const _0x5a3581='https://app.trapay.uk/payment/'+_0x3705b7['id'];return console[_0x3ef73d(0x1a3)](_0x3ef73d(0x22b)+_0x5a3581),console[_0x3ef73d(0x1a3)](_0x3ef73d(0x1af)+_0x1fc21b),{'paymentId':_0x3705b7['id'],'paymentUrl':_0x5a3581,'expiresAt':_0x3705b7['expiresAt']||undefined};}else{if(_0x477c2b[_0x3ef73d(0x204)]==='mastercard'){console[_0x3ef73d(0x1a3)](_0x3ef73d(0x258)+_0x235a77+_0x3ef73d(0x237)),console[_0x3ef73d(0x1a3)]('💰\x20Amount:\x20'+_0xda92d1+'\x20'+_0x477c2b[_0x3ef73d(0x1ef)]+_0x3ef73d(0x206));const _0x1a63af=_0x3ef73d(0x231)+_0x3705b7['id'];await database_1['default'][_0x3ef73d(0x1bc)][_0x3ef73d(0x200)]({'where':{'id':_0x3705b7['id']},'data':{'externalPaymentUrl':_0x1a63af,'gatewayPaymentId':_0x3ef73d(0x222)+_0x235a77,'paymentMethod':'mastercard'}});const _0x115410=_0x3ef73d(0x231)+_0x3705b7['id'];return console['log'](_0x3ef73d(0x1ec)+_0x115410),console['log'](_0x3ef73d(0x1a7)+_0x1a63af),{'paymentId':_0x3705b7['id'],'paymentUrl':_0x115410,'expiresAt':_0x3705b7[_0x3ef73d(0x26d)]||undefined};}else throw new Error('Unsupported\x20gateway:\x20'+_0x477c2b[_0x3ef73d(0x204)]);}}}}}}}catch(_0x2d0400){await database_1[_0x3ef73d(0x256)][_0x3ef73d(0x1bc)][_0x3ef73d(0x200)]({'where':{'id':_0x3705b7['id']},'data':{'status':_0x3ef73d(0x184)}});throw new Error('Gateway\x20error:\x20'+(_0x2d0400 instanceof Error?_0x2d0400[_0x3ef73d(0x26b)]:'Unknown\x20error'));}}async[a49_0x5e9bd7(0x1e0)](_0x50ac3a){const _0x3c8e34=a49_0x5e9bd7;console[_0x3c8e34(0x1a3)](_0x3c8e34(0x25d)+_0x50ac3a);const _0x1eced0=await database_1[_0x3c8e34(0x256)][_0x3c8e34(0x1bc)][_0x3c8e34(0x199)]({'where':{'id':_0x50ac3a},'include':{'paymentLink':!![]}});if(!_0x1eced0||!_0x1eced0['paymentLink']){console['log'](_0x3c8e34(0x188)+_0x50ac3a+_0x3c8e34(0x1d6));return;}if(_0x1eced0[_0x3c8e34(0x1b9)]!==_0x3c8e34(0x23a)){console[_0x3c8e34(0x1a3)]('📈\x20Payment\x20'+_0x50ac3a+_0x3c8e34(0x1f4)+_0x1eced0[_0x3c8e34(0x1b9)]+',\x20not\x20PAID.\x20Skipping\x20counter\x20update.');return;}if(!_0x1eced0[_0x3c8e34(0x170)]){console[_0x3c8e34(0x1a3)](_0x3c8e34(0x188)+_0x50ac3a+_0x3c8e34(0x1d7));return;}try{const _0xc326a=await database_1['default'][_0x3c8e34(0x22c)](async _0x513ba4=>{const _0x553c52=_0x3c8e34,_0x37c46e=await _0x513ba4[_0x553c52(0x1aa)]['findUnique']({'where':{'id':_0x1eced0['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(!_0x37c46e)throw new Error(_0x553c52(0x1cf)+_0x1eced0[_0x553c52(0x1e1)]+_0x553c52(0x262));if(_0x37c46e['type']==='SINGLE'&&_0x37c46e[_0x553c52(0x1e7)]>=0x1)return console['log'](_0x553c52(0x1e4)+_0x1eced0[_0x553c52(0x1e1)]+_0x553c52(0x209)+_0x37c46e[_0x553c52(0x1e7)]+_0x553c52(0x1fe)),_0x37c46e;const _0xca0481=await _0x513ba4['payment'][_0x553c52(0x1f2)]({'where':{'paymentLinkId':_0x1eced0[_0x553c52(0x1e1)],'status':_0x553c52(0x23a),'paidAt':{'not':null},'id':{'not':_0x50ac3a}}}),_0x54860b=_0xca0481+0x1,_0x4ff5c7=_0x37c46e[_0x553c52(0x254)]===_0x553c52(0x203)&&_0x54860b>=0x1?'COMPLETED':_0x37c46e['status'],_0x12f22e=await _0x513ba4['paymentLink'][_0x553c52(0x200)]({'where':{'id':_0x1eced0[_0x553c52(0x1e1)]},'data':{'currentPayments':_0x54860b,'status':_0x4ff5c7}});return console[_0x553c52(0x1a3)](_0x553c52(0x1a8)+_0x1eced0[_0x553c52(0x1e1)]+'\x20('+_0x37c46e['type']+_0x553c52(0x1fa)+_0x37c46e[_0x553c52(0x1e7)]+'\x20->\x20'+_0x54860b),_0x12f22e;});if(_0xc326a[_0x3c8e34(0x1b9)]===_0x3c8e34(0x24c)){const _0x39c1d5=_0xc326a[_0x3c8e34(0x254)]===_0x3c8e34(0x203)?'single-use':_0x3c8e34(0x244);console[_0x3c8e34(0x1a3)](_0x3c8e34(0x1e6)+_0x1eced0[_0x3c8e34(0x1e1)]+_0x3c8e34(0x1b1)+_0x39c1d5+_0x3c8e34(0x197)+_0xc326a['currentPayments']+_0x3c8e34(0x1fb));}}catch(_0x5b77e7){console['error'](_0x3c8e34(0x26f)+_0x50ac3a+':',_0x5b77e7);}}async[a49_0x5e9bd7(0x20c)](_0x41ce7a){const _0x43a644=a49_0x5e9bd7,[_0x5baf6a,_0x445df3,_0x5683d1,_0x25aa44]=await Promise[_0x43a644(0x253)]([database_1['default'][_0x43a644(0x1aa)][_0x43a644(0x1f2)]({'where':{'shopId':_0x41ce7a}}),database_1[_0x43a644(0x256)][_0x43a644(0x1aa)][_0x43a644(0x1f2)]({'where':{'shopId':_0x41ce7a,'status':_0x43a644(0x19c)}}),database_1['default'][_0x43a644(0x1bc)][_0x43a644(0x1f2)]({'where':{'shopId':_0x41ce7a,'paymentLinkId':{'not':null},'gateway':{'not':'test_gateway'}}}),database_1['default'][_0x43a644(0x1bc)][_0x43a644(0x181)]({'where':{'shopId':_0x41ce7a,'paymentLinkId':{'not':null},'status':_0x43a644(0x23a),'gateway':{'not':_0x43a644(0x233)}},'select':{'amount':!![],'currency':!![]}})]);let _0x22ba6e=0x0;for(const _0x447bf3 of _0x25aa44){const _0x3bc781=await currencyService_1[_0x43a644(0x1dd)]['convertToUSDT'](_0x447bf3[_0x43a644(0x19d)],_0x447bf3[_0x43a644(0x1ef)]);_0x22ba6e+=_0x3bc781;}const _0x41919e=_0x5683d1>0x0?_0x25aa44[_0x43a644(0x1d2)]/_0x5683d1*0x64:0x0;return{'totalLinks':_0x5baf6a,'activeLinks':_0x445df3,'totalPayments':_0x5683d1,'totalRevenue':Math['round'](_0x22ba6e*0x64)/0x64,'conversionRate':Math['round'](_0x41919e*0x64)/0x64};}['formatPaymentLinkResponse'](_0x228a1a){const _0x3aca7c=a49_0x5e9bd7;return{'id':_0x228a1a['id'],'shopId':_0x228a1a[_0x3aca7c(0x1f7)],'amount':_0x228a1a[_0x3aca7c(0x19d)],'currency':_0x228a1a[_0x3aca7c(0x1ef)],'sourceCurrency':_0x228a1a[_0x3aca7c(0x1f3)]||undefined,'gateway':_0x228a1a[_0x3aca7c(0x204)],'type':_0x228a1a[_0x3aca7c(0x254)],'currentPayments':_0x228a1a[_0x3aca7c(0x1e7)],'status':_0x228a1a[_0x3aca7c(0x1b9)],'expiresAt':_0x228a1a[_0x3aca7c(0x26d)]||undefined,'successUrl':_0x228a1a[_0x3aca7c(0x16c)]||undefined,'failUrl':_0x228a1a[_0x3aca7c(0x1f9)]||undefined,'pendingUrl':_0x228a1a[_0x3aca7c(0x176)]||undefined,'country':_0x228a1a[_0x3aca7c(0x24d)]||undefined,'language':_0x228a1a['language']||undefined,'linkUrl':_0x3aca7c(0x23c)+_0x228a1a['id'],'createdAt':_0x228a1a['createdAt'],'updatedAt':_0x228a1a[_0x3aca7c(0x252)],'shop':_0x228a1a[_0x3aca7c(0x265)],'payments':_0x228a1a['payments']};}}exports[a49_0x5e9bd7(0x1f1)]=PaymentLinkService;