'use strict';const a45_0x45f4e6=a45_0x5add;(function(_0x1c5f58,_0x5ddf72){const _0x409a3d=a45_0x5add,_0x228c5c=_0x1c5f58();while(!![]){try{const _0x11db63=parseInt(_0x409a3d(0xca))/0x1+parseInt(_0x409a3d(0x12d))/0x2+parseInt(_0x409a3d(0x139))/0x3+parseInt(_0x409a3d(0x130))/0x4+parseInt(_0x409a3d(0x11c))/0x5+parseInt(_0x409a3d(0xb0))/0x6*(parseInt(_0x409a3d(0xc0))/0x7)+parseInt(_0x409a3d(0xe4))/0x8*(-parseInt(_0x409a3d(0xe9))/0x9);if(_0x11db63===_0x5ddf72)break;else _0x228c5c['push'](_0x228c5c['shift']());}catch(_0x1f7cb6){_0x228c5c['push'](_0x228c5c['shift']());}}}(a45_0x3084,0x6a692));function a45_0x3084(){const _0x25d2ac=['getKlymeRegionFromGatewayName','max','checkGatewayPermission','\x20already\x20at\x20max\x20payments\x20(','klyme_','toUpperCase','❌\x20Gateway\x20\x22','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','initiatePaymentFromLink','BASE_URL','expiresAt','../types/gateway','PENDING','findMany','$transaction','deletePaymentLink','https://tesoft.uk/gateways/noda/webhook','Rapyd','🏁\x20Payment\x20link\x20','6680VcZqBd','temp','Shop\x20not\x20found','🔐\x20Checking\x20if\x20\x22','💾\x20DB\x20Pending\x20URL:\x20','24561GFsfXa','COMPLETED','includes','padStart','FAILED','Payment\x20','payment','getPaymentLinkById','Plisio','getGatewayDisplayName','klymeService','schedulePaymentChecks','Anonymous','update','\x20(Plisio\x20or\x20KLYME)','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','\x20(validated\x20for\x20','✅\x20Gateway\x20\x22','desc','map','getGatewayNameById','Unsupported\x20gateway:\x20','findUnique','ceil','log','updatedAt','isValidGatewayId','shop','create','💰\x20Amount:\x20','CoinToPayService','formatPaymentLinkResponse','failUrl','pendingUrl','paymentLinkId','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','nodaService','🔗\x20No\x20whiteUrl\x20for\x20','length','KlymeService','\x20status\x20is\x20','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','CoinToPay','join','💰\x20Plisio\x20payment\x20link\x20mapping:','🔗\x20Generated\x20whiteUrl\x20for\x20','createPaymentLink','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','./gateways/nodaService','Unknown\x20error','plisioService','4064030HWxLsa','error','./gateways/rapydService','/gateway/pending.php?id=','🔗\x20Rapyd\x20payment\x20URL:\x20','🔐\x20Shop\x20','ACTIVE','🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/','shopId','Shop\x20is\x20not\x20active','convertToUSDT','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','/gateway/fail.php?id=','👤\x20Customer:\x20','📈\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','default','sourceCurrency','216504ziMsCT','\x20payment\x20URL:\x20','Enabled\x20gateways:\x20','1826064ZHJxdT','KLYME\x20DE','none','\x20with\x20payment\x20ID\x20','\x20not\x20found','🎯\x20Generated\x20gateway\x20order_id:\x20','ONCE','count','username','1781079iYbnEF','rapydService','https://tesoft.uk/gateway/payment.php?id=','&payment_id=','Payment\x20link\x20has\x20expired','toLowerCase','🔐\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','successUrl','\x20counter\x20updated:\x20','amount','payments','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','https://app.trapay.uk/payment/fail?id=','currencyService','env','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','no\x20email','generateGatewayOrderId','paidAt','🔗\x20KLYME\x20','RapydService','generateGatewayUrls','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','\x20using\x20default\x20gateways:','random','__esModule','Payment\x20link\x20is\x20not\x20active','currency','https://app.trapay.uk/payment/','❌\x20Enabled\x20gateways:\x20','paymentGateways','✅\x20Payment\x20link\x20created:\x20','🔗\x20Generated\x20URLs\x20for\x20','getPaymentLinks','Payment\x20link\x20has\x20reached\x20maximum\x20payments','\x20payment\x20link','coinToPayService','Payment\x20link\x20not\x20found','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20','handleSuccessfulPayment','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','Error\x20parsing\x20payment\x20gateways:','toISOString','🔗\x20Noda\x20payment\x20URL:\x20','🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','Noda','payment_url','./gateways/coinToPayService','./gateways/klymeService','/gateway/success.php?id=','gateway','\x20enabled\x20gateways:','all','status','gateway_payment_id','🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','PAID','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','cointopay','insensitive','../config/database','💳\x20Initiating\x20payment\x20from\x20link\x20','https://app.trapay.uk/payment/success?id=','💾\x20DB\x20Success\x20URL:\x20','delete','maxPayments','\x20\x20\x20🌐\x20Gateway\x20Pending\x20URL:\x20','💳\x20Creating\x20KLYME\x20','💾\x20Payment\x20created:\x20','validateKlymeCurrency','EUR','\x22\x20is\x20allowed\x20for\x20shop\x20','📈\x20Payment\x20link\x20','rapyd','Gateway\x20error:\x20','Invalid\x20KLYME\x20gateway:\x20','updatePaymentLink','3342uhXFYR','PaymentLinkService','Invalid\x20gateway\x20ID:\x20','\x20(8digits-8digits\x20format)','https://tesoft.uk','✅\x20KLYME\x20','round','qr_code_url','parse','Unsupported\x20KLYME\x20region:\x20','language','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','./gateways/plisioService','paymentLink',',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','startsWith','2569hZdeNg','plisio','\x20completed\x20(reached\x20max\x20payments:\x20','floor','\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20','\x20\x20\x20🔗\x20White\x20URL:\x20','currentPayments','🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','🔗\x20Plisio\x20payment\x20URL:\x20','🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','538887XRXACv','noda','findFirst','name','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','📈\x20Payment\x20'];a45_0x3084=function(){return _0x25d2ac;};return a45_0x3084();}var __importDefault=this&&this['__importDefault']||function(_0x4753f2){const _0x2ef0a4=a45_0x5add;return _0x4753f2&&_0x4753f2[_0x2ef0a4(0x152)]?_0x4753f2:{'default':_0x4753f2};};function a45_0x5add(_0x4de590,_0x308d38){const _0x3084b6=a45_0x3084();return a45_0x5add=function(_0x5addd2,_0x262922){_0x5addd2=_0x5addd2-0x9f;let _0x3fb6a7=_0x3084b6[_0x5addd2];return _0x3fb6a7;},a45_0x5add(_0x4de590,_0x308d38);}Object['defineProperty'](exports,a45_0x45f4e6(0x152),{'value':!![]}),exports[a45_0x45f4e6(0xb1)]=void 0x0;const database_1=__importDefault(require(a45_0x45f4e6(0x9f))),plisioService_1=require(a45_0x45f4e6(0xbc)),rapydService_1=require(a45_0x45f4e6(0x11e)),nodaService_1=require(a45_0x45f4e6(0x119)),coinToPayService_1=require(a45_0x45f4e6(0x168)),klymeService_1=require(a45_0x45f4e6(0x169)),coinToPayStatusService_1=require('./coinToPayStatusService'),gateway_1=require(a45_0x45f4e6(0xdc)),currencyService_1=require('./currencyService');class PaymentLinkService{constructor(){const _0x3bbd92=a45_0x45f4e6;this['plisioService']=new plisioService_1['PlisioService'](),this[_0x3bbd92(0x13a)]=new rapydService_1[(_0x3bbd92(0x14d))](),this[_0x3bbd92(0x10d)]=new nodaService_1['NodaService'](),this['coinToPayService']=new coinToPayService_1[(_0x3bbd92(0x107))](),this['klymeService']=new klymeService_1[(_0x3bbd92(0x110))]();}[a45_0x45f4e6(0x14a)](){const _0xe16f4=()=>{const _0x4a6339=a45_0x5add;return Math[_0x4a6339(0xc3)](Math[_0x4a6339(0x151)]()*0x5f5e100)['toString']()[_0x4a6339(0xec)](0x8,'0');};return _0xe16f4()+'-'+_0xe16f4();}[a45_0x45f4e6(0x14e)](_0x16b3da,_0x58b153,_0x2f288f,_0xdad13b,_0x26e30c,_0x352742,_0x31762e){const _0x19a110=a45_0x45f4e6;if(_0x26e30c&&_0x352742&&_0x31762e)return{'finalSuccessUrl':_0x26e30c,'finalFailUrl':_0x352742,'finalPendingUrl':_0x31762e,'dbSuccessUrl':_0x26e30c,'dbFailUrl':_0x352742,'dbPendingUrl':_0x31762e,'whiteUrl':null};const _0x20e18b=_0x26e30c||_0x19a110(0xa1)+_0x58b153+_0x19a110(0x13c)+_0x2f288f,_0xcc8f47=_0x352742||_0x19a110(0x145)+_0x58b153+'&payment_id='+_0x2f288f,_0x3a42dc=_0x31762e||'https://app.trapay.uk/payment/pending?id='+_0x58b153+_0x19a110(0x13c)+_0x2f288f;let _0x3d3dd2,_0x1017d0,_0x32feef;_0x16b3da===_0x19a110(0xcb)||_0x16b3da[_0x19a110(0xbf)](_0x19a110(0xd5))||_0x16b3da===_0x19a110(0x173)?(_0x3d3dd2=_0xdad13b+'/gateway/pending.php?id='+_0x58b153,_0x32feef=_0xdad13b+_0x19a110(0x11f)+_0x58b153):(_0x3d3dd2=_0xdad13b+_0x19a110(0x16a)+_0x58b153,_0x32feef=_0xdad13b+_0x19a110(0x11f)+_0x58b153);_0x1017d0=_0xdad13b+_0x19a110(0x128)+_0x58b153;let _0x196780=null;return _0x16b3da!==_0x19a110(0xc1)&&!_0x16b3da['startsWith'](_0x19a110(0xd5))?(_0x196780=_0x19a110(0x13b)+_0x58b153,console['log'](_0x19a110(0x116)+_0x16b3da+':\x20'+_0x196780)):console[_0x19a110(0x101)](_0x19a110(0x10e)+_0x16b3da+_0x19a110(0xf7)),console[_0x19a110(0x101)](_0x19a110(0x159)+_0x16b3da+_0x19a110(0x133)+_0x58b153+':'),console[_0x19a110(0x101)](_0x19a110(0xce)+_0x3d3dd2),console['log'](_0x19a110(0x127)+_0x1017d0),console['log'](_0x19a110(0xa5)+_0x32feef),console[_0x19a110(0x101)]('\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20'+_0x20e18b),console[_0x19a110(0x101)](_0x19a110(0xc4)+_0xcc8f47),console['log']('\x20\x20\x20💾\x20DB\x20Pending\x20URL:\x20'+_0x3a42dc),console['log'](_0x19a110(0xc5)+(_0x196780||_0x19a110(0x132))),{'finalSuccessUrl':_0x3d3dd2,'finalFailUrl':_0x1017d0,'finalPendingUrl':_0x32feef,'dbSuccessUrl':_0x20e18b,'dbFailUrl':_0xcc8f47,'dbPendingUrl':_0x3a42dc,'whiteUrl':_0x196780};}[a45_0x45f4e6(0xa8)](_0x5a6356,_0x14e231){const _0x2c0a96=a45_0x45f4e6;if(!_0x5a6356['startsWith'](_0x2c0a96(0xd5)))return;const _0x1ac7c6=(0x0,gateway_1[_0x2c0a96(0xd1)])(_0x5a6356),_0x2f5f7e=_0x14e231['toUpperCase']();switch(_0x1ac7c6){case'EU':if(_0x2f5f7e!=='EUR')throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x2f5f7e);break;case'GB':if(_0x2f5f7e!=='GBP')throw new Error(_0x2c0a96(0xf8)+_0x2f5f7e);break;case'DE':if(_0x2f5f7e!=='EUR')throw new Error(_0x2c0a96(0x118)+_0x2f5f7e);break;default:throw new Error(_0x2c0a96(0xb9)+_0x1ac7c6);}}async[a45_0x45f4e6(0xd3)](_0x5026d,_0x1fcb13){const _0x5b1878=a45_0x45f4e6;console[_0x5b1878(0x101)](_0x5b1878(0x13f)+_0x5026d+':\x20'+_0x1fcb13);const _0x601aa6=await database_1[_0x5b1878(0x12b)][_0x5b1878(0x104)][_0x5b1878(0xff)]({'where':{'id':_0x5026d},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x601aa6)throw new Error(_0x5b1878(0xe6));let _0xda0b9c=[];if(_0x601aa6[_0x5b1878(0x157)])try{_0xda0b9c=JSON[_0x5b1878(0xb8)](_0x601aa6['paymentGateways']),console[_0x5b1878(0x101)](_0x5b1878(0x121)+_0x601aa6['username']+_0x5b1878(0x16c),_0xda0b9c);}catch(_0x10a7a1){console['error'](_0x5b1878(0x162),_0x10a7a1),_0xda0b9c=[_0x5b1878(0xf1)];}else _0xda0b9c=[_0x5b1878(0xf1)],console['log'](_0x5b1878(0x121)+_0x601aa6[_0x5b1878(0x138)]+_0x5b1878(0x150),_0xda0b9c);const _0x4bf798=this[_0x5b1878(0xf2)](_0x1fcb13);console[_0x5b1878(0x101)](_0x5b1878(0xe7)+_0x4bf798+'\x22\x20is\x20in\x20enabled\x20gateways:',_0xda0b9c);if(!_0xda0b9c[_0x5b1878(0xeb)](_0x4bf798)){console[_0x5b1878(0x11d)](_0x5b1878(0xd7)+_0x4bf798+'\x22\x20not\x20allowed\x20for\x20shop\x20'+_0x601aa6[_0x5b1878(0x138)]),console[_0x5b1878(0x11d)](_0x5b1878(0x156)+_0xda0b9c[_0x5b1878(0x114)](',\x20'));throw new Error('Gateway\x20\x22'+_0x4bf798+_0x5b1878(0xd8)+(_0x5b1878(0x12f)+_0xda0b9c[_0x5b1878(0x114)](',\x20')+'.\x20')+'Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.');}console['log'](_0x5b1878(0xfa)+_0x4bf798+_0x5b1878(0xaa)+_0x601aa6[_0x5b1878(0x138)]);}[a45_0x45f4e6(0xf2)](_0x237e0b){const _0x168e8c=a45_0x45f4e6,_0x5cbde0={'plisio':_0x168e8c(0xf1),'rapyd':_0x168e8c(0xe2),'noda':_0x168e8c(0x166),'cointopay':_0x168e8c(0x113),'klyme_eu':'KLYME\x20EU','klyme_gb':'KLYME\x20GB','klyme_de':_0x168e8c(0x131)};return _0x5cbde0[_0x237e0b]||_0x237e0b;}async[a45_0x45f4e6(0x117)](_0x2871be,_0x42f5f7){const _0x933e6=a45_0x45f4e6;if(!(0x0,gateway_1[_0x933e6(0x103)])(_0x42f5f7[_0x933e6(0x16b)]))throw new Error(_0x933e6(0xb2)+_0x42f5f7[_0x933e6(0x16b)]+'.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)');const _0x80499a=(0x0,gateway_1[_0x933e6(0xfd)])(_0x42f5f7['gateway']);if(!_0x80499a)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x42f5f7['gateway']);console[_0x933e6(0x101)](_0x933e6(0x165)+_0x80499a),await this[_0x933e6(0xd3)](_0x2871be,_0x80499a);if(_0x80499a===_0x933e6(0xc1)&&!_0x42f5f7[_0x933e6(0x12c)])throw new Error(_0x933e6(0x172));if(_0x80499a[_0x933e6(0xbf)]('klyme_')){const _0x5a2372=(0x0,gateway_1[_0x933e6(0xd1)])(_0x80499a);console[_0x933e6(0x101)](_0x933e6(0xa6)+_0x5a2372+_0x933e6(0x15c));}let _0xc9d7c7=_0x42f5f7['country'];_0x80499a===_0x933e6(0xac)&&(_0xc9d7c7='GB',console[_0x933e6(0x101)](_0x933e6(0x112)));if(!_0x42f5f7['amount']||_0x42f5f7[_0x933e6(0x142)]<=0x0)throw new Error('amount\x20is\x20required\x20and\x20must\x20be\x20positive');let _0xa88834=_0x42f5f7['currency']||'USD';_0x80499a==='cointopay'&&(_0xa88834=_0x933e6(0xa9),console[_0x933e6(0x101)](_0x933e6(0xc9)));this[_0x933e6(0xa8)](_0x80499a,_0xa88834);const _0x59ae3e=await database_1[_0x933e6(0x12b)][_0x933e6(0xbd)]['create']({'data':{'shopId':_0x2871be,'amount':_0x42f5f7[_0x933e6(0x142)],'currency':_0xa88834,'sourceCurrency':_0x42f5f7[_0x933e6(0x12c)]||undefined,'gateway':_0x80499a,'maxPayments':_0x42f5f7[_0x933e6(0xa4)]||0x1,'currentPayments':0x0,'status':_0x933e6(0x122),'expiresAt':_0x42f5f7['expiresAt']?new Date(_0x42f5f7[_0x933e6(0xdb)]):undefined,'successUrl':_0x42f5f7[_0x933e6(0x140)]||null,'failUrl':_0x42f5f7['failUrl']||null,'pendingUrl':_0x42f5f7['pendingUrl']||null,'country':_0xc9d7c7,'language':_0x42f5f7[_0x933e6(0xba)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console['log'](_0x933e6(0x158)+_0x59ae3e['id']+'\x20('+_0x80499a+')'),console['log']('💰\x20Fixed\x20amount:\x20'+_0x59ae3e[_0x933e6(0x142)]+'\x20'+_0x59ae3e[_0x933e6(0x154)]),console['log'](_0x933e6(0x123)+_0x59ae3e['id']),console[_0x933e6(0x101)]('📝\x20Note:\x20Success/Fail/Pending\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created'),this[_0x933e6(0x108)](_0x59ae3e);}async[a45_0x45f4e6(0x15a)](_0x15da92,_0x26d1fc){const _0x30bd93=a45_0x45f4e6,{page:_0x2773ea,limit:_0x18835e,status:_0x4b3d30,gateway:_0x20bc65,search:_0x12fdfe}=_0x26d1fc,_0x3bc36e=(_0x2773ea-0x1)*_0x18835e,_0x2d358b={'shopId':_0x15da92};_0x4b3d30&&(_0x2d358b[_0x30bd93(0x16e)]=_0x4b3d30[_0x30bd93(0xd6)]());if(_0x20bc65){if((0x0,gateway_1['isValidGatewayId'])(_0x20bc65)){const _0x131b58=(0x0,gateway_1[_0x30bd93(0xfd)])(_0x20bc65);_0x131b58&&(_0x2d358b[_0x30bd93(0x16b)]=_0x131b58);}else _0x2d358b[_0x30bd93(0x16b)]=_0x20bc65[_0x30bd93(0x13e)]();}_0x12fdfe&&(_0x2d358b['OR']=[{'gateway':{'contains':_0x12fdfe,'mode':_0x30bd93(0x174)}},{'currency':{'contains':_0x12fdfe,'mode':_0x30bd93(0x174)}}]);const [_0x45a6b8,_0x40d621]=await Promise[_0x30bd93(0x16d)]([database_1['default'][_0x30bd93(0xbd)]['findMany']({'where':_0x2d358b,'skip':_0x3bc36e,'take':_0x18835e,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x30bd93(0xfb)},'take':0xa}}}),database_1[_0x30bd93(0x12b)][_0x30bd93(0xbd)]['count']({'where':_0x2d358b})]);return{'links':_0x45a6b8[_0x30bd93(0xfc)](_0x10e8a6=>this[_0x30bd93(0x108)](_0x10e8a6)),'pagination':{'page':_0x2773ea,'limit':_0x18835e,'total':_0x40d621,'totalPages':Math[_0x30bd93(0x100)](_0x40d621/_0x18835e)}};}async[a45_0x45f4e6(0xf0)](_0x1e6342,_0x894d28){const _0x45239e=a45_0x45f4e6,_0x1ca240=await database_1['default'][_0x45239e(0xbd)][_0x45239e(0xcc)]({'where':{'id':_0x894d28,'shopId':_0x1e6342},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x45239e(0xfb)}}}});if(!_0x1ca240)return null;return this[_0x45239e(0x108)](_0x1ca240);}async[a45_0x45f4e6(0xaf)](_0x483c5e,_0x92b9b8,_0x443e4c){const _0x908e27=a45_0x45f4e6,_0x130e8d={..._0x443e4c};if(_0x443e4c['gateway']){if((0x0,gateway_1[_0x908e27(0x103)])(_0x443e4c[_0x908e27(0x16b)])){const _0x3805ae=(0x0,gateway_1['getGatewayNameById'])(_0x443e4c[_0x908e27(0x16b)]);_0x3805ae&&(await this[_0x908e27(0xd3)](_0x483c5e,_0x3805ae),_0x130e8d[_0x908e27(0x16b)]=_0x3805ae);}else _0x130e8d['gateway']=_0x443e4c[_0x908e27(0x16b)][_0x908e27(0x13e)]();}(_0x130e8d[_0x908e27(0x16b)]===_0x908e27(0xac)||_0x443e4c['country']&&_0x130e8d[_0x908e27(0x16b)]!=='rapyd')&&(_0x130e8d[_0x908e27(0x16b)]===_0x908e27(0xac)&&(_0x130e8d['country']='GB',console[_0x908e27(0x101)](_0x908e27(0x170))));_0x130e8d[_0x908e27(0x16b)]==='cointopay'&&(_0x130e8d[_0x908e27(0x154)]='EUR',console['log'](_0x908e27(0xbb)));_0x130e8d['gateway']&&_0x130e8d[_0x908e27(0x154)]&&this[_0x908e27(0xa8)](_0x130e8d[_0x908e27(0x16b)],_0x130e8d[_0x908e27(0x154)]);_0x443e4c[_0x908e27(0xdb)]&&(_0x130e8d['expiresAt']=new Date(_0x443e4c[_0x908e27(0xdb)]));const _0x270e9b=await database_1[_0x908e27(0x12b)][_0x908e27(0xbd)][_0x908e27(0xf6)]({'where':{'id':_0x92b9b8,'shopId':_0x483c5e},'data':_0x130e8d,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x908e27(0xfb)},'take':0xa}}});return this[_0x908e27(0x108)](_0x270e9b);}async[a45_0x45f4e6(0xe0)](_0x49b413,_0x47f220){const _0x190053=a45_0x45f4e6;await database_1[_0x190053(0x12b)][_0x190053(0xbd)][_0x190053(0xa3)]({'where':{'id':_0x47f220,'shopId':_0x49b413}});}async['getPublicPaymentLinkData'](_0x3da9d1){const _0x3128bb=a45_0x45f4e6,_0x568980=await database_1['default']['paymentLink'][_0x3128bb(0xff)]({'where':{'id':_0x3da9d1},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x568980)return null;const _0x2944a1=_0x568980[_0x3128bb(0xdb)]&&_0x568980['expiresAt']<new Date(),_0xfcdba9=_0x568980[_0x3128bb(0xc6)]>=_0x568980[_0x3128bb(0xa4)],_0x4bac26=_0x568980[_0x3128bb(0x104)][_0x3128bb(0x16e)]===_0x3128bb(0x122),_0x2c4cbe=_0x568980[_0x3128bb(0x16e)]===_0x3128bb(0x122),_0x24a11d=!_0x2944a1&&!_0xfcdba9&&_0x4bac26&&_0x2c4cbe,_0x5a24d4=Math[_0x3128bb(0xd2)](0x0,_0x568980[_0x3128bb(0xa4)]-_0x568980[_0x3128bb(0xc6)]);return{'id':_0x568980['id'],'amount':_0x568980[_0x3128bb(0x142)],'currency':_0x568980['currency'],'sourceCurrency':_0x568980[_0x3128bb(0x12c)]||undefined,'gateway':_0x568980['gateway'],'maxPayments':_0x568980[_0x3128bb(0xa4)],'currentPayments':_0x568980[_0x3128bb(0xc6)],'status':_0x568980['status'],'expiresAt':_0x568980[_0x3128bb(0xdb)]||undefined,'shopName':_0x568980[_0x3128bb(0x104)][_0x3128bb(0xcd)],'isAvailable':_0x24a11d,'remainingPayments':_0x5a24d4};}async[a45_0x45f4e6(0xd9)](_0x1acb2a){const _0x3c311d=a45_0x45f4e6,{linkId:_0x45cc52,customerEmail:_0x2699ff,customerName:_0x339e32}=_0x1acb2a,_0x444e4e=await database_1[_0x3c311d(0x12b)][_0x3c311d(0xbd)][_0x3c311d(0xff)]({'where':{'id':_0x45cc52},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x444e4e)throw new Error(_0x3c311d(0x15e));const _0xf4f0c1=_0x444e4e[_0x3c311d(0xdb)]&&_0x444e4e[_0x3c311d(0xdb)]<new Date(),_0x561bf4=_0x444e4e[_0x3c311d(0xc6)]>=_0x444e4e[_0x3c311d(0xa4)],_0x4def86=_0x444e4e[_0x3c311d(0x104)][_0x3c311d(0x16e)]===_0x3c311d(0x122),_0x5c91e0=_0x444e4e[_0x3c311d(0x16e)]===_0x3c311d(0x122);if(_0xf4f0c1)throw new Error(_0x3c311d(0x13d));if(_0x561bf4)throw new Error(_0x3c311d(0x15b));if(!_0x4def86)throw new Error(_0x3c311d(0x125));if(!_0x5c91e0)throw new Error(_0x3c311d(0x153));await this['checkGatewayPermission'](_0x444e4e[_0x3c311d(0x124)],_0x444e4e[_0x3c311d(0x16b)]);const _0x344d5d=_0x444e4e['amount'];console[_0x3c311d(0x101)](_0x3c311d(0xa0)+_0x45cc52+':\x20'+_0x344d5d+'\x20'+_0x444e4e[_0x3c311d(0x154)]),console[_0x3c311d(0x101)](_0x3c311d(0x129)+(_0x339e32||_0x3c311d(0xf5))+'\x20('+(_0x2699ff||_0x3c311d(0x149))+')'),this[_0x3c311d(0xa8)](_0x444e4e[_0x3c311d(0x16b)],_0x444e4e[_0x3c311d(0x154)]);const _0x49467f=this[_0x3c311d(0x14a)]();console[_0x3c311d(0x101)](_0x3c311d(0x135)+_0x49467f+'\x20(8digits-8digits\x20format\x20for\x20'+_0x444e4e['gateway']+')');const _0x5f3c97=await database_1[_0x3c311d(0x12b)][_0x3c311d(0xef)][_0x3c311d(0x105)]({'data':{'shopId':_0x444e4e[_0x3c311d(0x124)],'paymentLinkId':_0x444e4e['id'],'gateway':_0x444e4e['gateway'],'amount':_0x344d5d,'currency':_0x444e4e[_0x3c311d(0x154)],'sourceCurrency':_0x444e4e[_0x3c311d(0x12c)]||undefined,'usage':_0x3c311d(0x136),'expiresAt':_0x444e4e['expiresAt']||undefined,'successUrl':_0x3c311d(0xe5),'failUrl':_0x3c311d(0xe5),'pendingUrl':_0x3c311d(0xe5),'whiteUrl':'temp','status':_0x3c311d(0xdd),'orderId':null,'gatewayOrderId':_0x49467f,'customerEmail':_0x2699ff||undefined,'customerName':_0x339e32||undefined,'country':_0x444e4e['country']||undefined,'language':_0x444e4e[_0x3c311d(0xba)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console['log'](_0x3c311d(0xa7)+_0x5f3c97['id']);const _0x4ad38b=process[_0x3c311d(0x147)][_0x3c311d(0xda)]||_0x3c311d(0xb4),{finalSuccessUrl:_0x5efb16,finalFailUrl:_0x4a51f3,finalPendingUrl:_0x2f2db2,dbSuccessUrl:_0x274738,dbFailUrl:_0x17bd4c,dbPendingUrl:_0x1a18e8,whiteUrl:_0x168398}=this[_0x3c311d(0x14e)](_0x444e4e[_0x3c311d(0x16b)],_0x5f3c97['id'],_0x49467f,_0x4ad38b,_0x444e4e[_0x3c311d(0x140)]||undefined,_0x444e4e[_0x3c311d(0x109)]||undefined,_0x444e4e['pendingUrl']||undefined);await database_1[_0x3c311d(0x12b)]['payment'][_0x3c311d(0xf6)]({'where':{'id':_0x5f3c97['id']},'data':{'successUrl':_0x274738,'failUrl':_0x17bd4c,'pendingUrl':_0x1a18e8,'whiteUrl':_0x168398}}),console['log'](_0x3c311d(0x106)+_0x344d5d+'\x20'+_0x444e4e[_0x3c311d(0x154)]),console[_0x3c311d(0x101)](_0x3c311d(0x129)+(_0x339e32||_0x3c311d(0xf5))+'\x20('+(_0x2699ff||'no\x20email')+')'),console['log'](_0x3c311d(0xa2)+_0x274738),console[_0x3c311d(0x101)]('💾\x20DB\x20Fail\x20URL:\x20'+_0x17bd4c),console[_0x3c311d(0x101)](_0x3c311d(0xe8)+_0x1a18e8),console['log']('🔗\x20White\x20URL:\x20'+(_0x168398||_0x3c311d(0x132)));let _0x573188,_0x3045f2;try{if(_0x444e4e[_0x3c311d(0x16b)]===_0x3c311d(0xc1)){console[_0x3c311d(0x101)](_0x3c311d(0x115)),console[_0x3c311d(0x101)]('\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20'+_0x444e4e['currency']),console['log'](_0x3c311d(0x14f)+_0x444e4e['sourceCurrency']);const _0x56219d=await this[_0x3c311d(0x11b)]['createPayment']({'paymentId':_0x5f3c97['id'],'orderId':_0x49467f,'amount':_0x344d5d,'currency':_0x444e4e[_0x3c311d(0x154)],'productName':_0x3c311d(0xee)+_0x344d5d+'\x20'+_0x444e4e[_0x3c311d(0x154)],'description':_0x3c311d(0xee)+_0x344d5d+'\x20'+_0x444e4e[_0x3c311d(0x154)],'successUrl':_0x5efb16,'failUrl':_0x4a51f3,'customerEmail':_0x2699ff||undefined,'customerName':_0x339e32||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x444e4e[_0x3c311d(0x12c)]||undefined});_0x573188=_0x56219d[_0x3c311d(0x16f)],_0x3045f2=_0x56219d[_0x3c311d(0x167)],await database_1[_0x3c311d(0x12b)][_0x3c311d(0xef)][_0x3c311d(0xf6)]({'where':{'id':_0x5f3c97['id']},'data':{'externalPaymentUrl':_0x3045f2,'gatewayPaymentId':_0x573188,'invoiceTotalSum':Number(_0x56219d['invoice_total_sum']),'qrCode':_0x56219d['qr_code'],'qrUrl':_0x56219d['qr_url']}});const _0x979ee3=_0x3c311d(0x155)+_0x5f3c97['id'];return console[_0x3c311d(0x101)](_0x3c311d(0xc8)+_0x979ee3),{'paymentId':_0x5f3c97['id'],'paymentUrl':_0x979ee3,'expiresAt':_0x5f3c97[_0x3c311d(0xdb)]||undefined};}else{if(_0x444e4e[_0x3c311d(0x16b)]===_0x3c311d(0xac)){const _0x1063ee=await this['rapydService'][_0x3c311d(0x117)]({'paymentId':_0x5f3c97['id'],'orderId':_0x49467f,'orderName':_0x3c311d(0xee)+_0x344d5d+'\x20'+_0x444e4e['currency'],'amount':_0x344d5d,'currency':_0x444e4e[_0x3c311d(0x154)],'country':_0x444e4e['country'],'language':_0x444e4e['language']||'EN','amountIsEditable':![],'usage':_0x3c311d(0x136),'maxPayments':0x1,'successUrl':_0x5efb16,'failUrl':_0x4a51f3});_0x573188=_0x1063ee['gateway_payment_id'],_0x3045f2=_0x1063ee['payment_url'],await database_1[_0x3c311d(0x12b)][_0x3c311d(0xef)]['update']({'where':{'id':_0x5f3c97['id']},'data':{'externalPaymentUrl':_0x3045f2,'gatewayPaymentId':_0x573188}});const _0xa4fe4d=_0x3c311d(0x155)+_0x5f3c97['id'];return console[_0x3c311d(0x101)](_0x3c311d(0x120)+_0xa4fe4d),{'paymentId':_0x5f3c97['id'],'paymentUrl':_0xa4fe4d,'expiresAt':_0x5f3c97[_0x3c311d(0xdb)]||undefined};}else{if(_0x444e4e[_0x3c311d(0x16b)]===_0x3c311d(0xcb)){const _0x4105e1=await this[_0x3c311d(0x10d)][_0x3c311d(0x117)]({'paymentId':_0x5f3c97['id'],'orderId':_0x49467f,'name':_0x3c311d(0xee)+_0x344d5d+'\x20'+_0x444e4e[_0x3c311d(0x154)],'paymentDescription':_0x3c311d(0xee)+_0x344d5d+'\x20'+_0x444e4e[_0x3c311d(0x154)],'amount':_0x344d5d,'currency':_0x444e4e['currency'],'webhookUrl':_0x3c311d(0xe1),'returnUrl':_0x2f2db2,'expiryDate':_0x444e4e[_0x3c311d(0xdb)]?.[_0x3c311d(0x163)]()});_0x573188=_0x4105e1[_0x3c311d(0x16f)],_0x3045f2=_0x4105e1[_0x3c311d(0x167)],await database_1[_0x3c311d(0x12b)][_0x3c311d(0xef)]['update']({'where':{'id':_0x5f3c97['id']},'data':{'externalPaymentUrl':_0x3045f2,'gatewayPaymentId':_0x573188,'qrUrl':_0x4105e1[_0x3c311d(0xb7)]}});const _0x1c2ce2='https://app.trapay.uk/payment/'+_0x5f3c97['id'];return console[_0x3c311d(0x101)](_0x3c311d(0x164)+_0x1c2ce2),{'paymentId':_0x5f3c97['id'],'paymentUrl':_0x1c2ce2,'expiresAt':_0x5f3c97[_0x3c311d(0xdb)]||undefined};}else{if(_0x444e4e['gateway']==='cointopay'){console['log'](_0x3c311d(0xc7)+_0x49467f+_0x3c311d(0xb3)),console['log']('💰\x20Amount:\x20'+_0x344d5d+_0x3c311d(0x144));const _0x224f24=await this[_0x3c311d(0x15d)][_0x3c311d(0x117)]({'paymentId':_0x5f3c97['id'],'orderId':_0x49467f,'amount':_0x344d5d});_0x573188=_0x224f24[_0x3c311d(0x16f)],_0x3045f2=_0x224f24['payment_url'],await database_1['default'][_0x3c311d(0xef)]['update']({'where':{'id':_0x5f3c97['id']},'data':{'externalPaymentUrl':_0x3045f2,'gatewayPaymentId':_0x573188}});_0x573188&&(console[_0x3c311d(0x101)](_0x3c311d(0x15f)+_0x5f3c97['id']+'\x20('+_0x573188+')'),coinToPayStatusService_1['coinToPayStatusService'][_0x3c311d(0xf4)](_0x5f3c97['id'],_0x573188));const _0xae6818=_0x3c311d(0x155)+_0x5f3c97['id'];return console[_0x3c311d(0x101)]('🔗\x20CoinToPay\x20payment\x20URL:\x20'+_0xae6818),{'paymentId':_0x5f3c97['id'],'paymentUrl':_0xae6818,'expiresAt':_0x5f3c97[_0x3c311d(0xdb)]||undefined};}else{if(_0x444e4e[_0x3c311d(0x16b)][_0x3c311d(0xbf)](_0x3c311d(0xd5))){const _0xc5d144=(0x0,gateway_1[_0x3c311d(0xd1)])(_0x444e4e[_0x3c311d(0x16b)]);if(!_0xc5d144)throw new Error(_0x3c311d(0xae)+_0x444e4e[_0x3c311d(0x16b)]);console[_0x3c311d(0x101)](_0x3c311d(0xa6)+_0xc5d144+_0x3c311d(0x161)+_0x49467f+_0x3c311d(0xb3)),console[_0x3c311d(0x101)](_0x3c311d(0x106)+_0x344d5d+'\x20'+_0x444e4e['currency']+_0x3c311d(0xf9)+_0xc5d144+')');const _0x2b2700=await this[_0x3c311d(0xf3)][_0x3c311d(0x117)]({'paymentId':_0x5f3c97['id'],'orderId':_0x49467f,'amount':_0x344d5d,'currency':_0x444e4e[_0x3c311d(0x154)],'region':_0xc5d144,'redirectUrl':_0x2f2db2});_0x573188=_0x2b2700[_0x3c311d(0x16f)],_0x3045f2=_0x2b2700[_0x3c311d(0x167)],await database_1[_0x3c311d(0x12b)][_0x3c311d(0xef)]['update']({'where':{'id':_0x5f3c97['id']},'data':{'externalPaymentUrl':_0x3045f2,'gatewayPaymentId':_0x573188}});const _0x463661='https://app.trapay.uk/payment/'+_0x5f3c97['id'];return console[_0x3c311d(0x101)](_0x3c311d(0xb5)+_0xc5d144+_0x3c311d(0x148)+_0x49467f),console['log'](_0x3c311d(0x14c)+_0xc5d144+_0x3c311d(0x12e)+_0x463661),{'paymentId':_0x5f3c97['id'],'paymentUrl':_0x463661,'expiresAt':_0x5f3c97[_0x3c311d(0xdb)]||undefined};}else throw new Error(_0x3c311d(0xfe)+_0x444e4e[_0x3c311d(0x16b)]);}}}}}catch(_0x1299db){await database_1['default'][_0x3c311d(0xef)]['update']({'where':{'id':_0x5f3c97['id']},'data':{'status':_0x3c311d(0xed)}});throw new Error(_0x3c311d(0xad)+(_0x1299db instanceof Error?_0x1299db['message']:_0x3c311d(0x11a)));}}async[a45_0x45f4e6(0x160)](_0x5419f6){const _0x13dcf4=a45_0x45f4e6;console[_0x13dcf4(0x101)](_0x13dcf4(0x12a)+_0x5419f6);const _0xcfd19e=await database_1[_0x13dcf4(0x12b)][_0x13dcf4(0xef)][_0x13dcf4(0xff)]({'where':{'id':_0x5419f6},'include':{'paymentLink':!![]}});if(!_0xcfd19e||!_0xcfd19e[_0x13dcf4(0xbd)]){console[_0x13dcf4(0x101)](_0x13dcf4(0xd0)+_0x5419f6+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update');return;}if(_0xcfd19e[_0x13dcf4(0x16e)]!==_0x13dcf4(0x171)){console[_0x13dcf4(0x101)]('📈\x20Payment\x20'+_0x5419f6+_0x13dcf4(0x111)+_0xcfd19e[_0x13dcf4(0x16e)]+_0x13dcf4(0xbe));return;}if(!_0xcfd19e[_0x13dcf4(0x14b)]){console[_0x13dcf4(0x101)](_0x13dcf4(0xd0)+_0x5419f6+_0x13dcf4(0x10c));return;}try{const _0x2b5c84=await database_1[_0x13dcf4(0x12b)][_0x13dcf4(0xdf)](async _0x23d782=>{const _0x58316b=_0x13dcf4,_0x43ea4b=await _0x23d782['paymentLink'][_0x58316b(0xff)]({'where':{'id':_0xcfd19e['paymentLinkId']},'select':{'id':!![],'currentPayments':!![],'maxPayments':!![],'status':!![]}});if(!_0x43ea4b)throw new Error('Payment\x20link\x20'+_0xcfd19e[_0x58316b(0x10b)]+_0x58316b(0x134));if(_0x43ea4b[_0x58316b(0xc6)]>=_0x43ea4b['maxPayments'])return console[_0x58316b(0x101)](_0x58316b(0xab)+_0xcfd19e['paymentLinkId']+_0x58316b(0xd4)+_0x43ea4b[_0x58316b(0xc6)]+'/'+_0x43ea4b[_0x58316b(0xa4)]+'),\x20skipping\x20increment'),_0x43ea4b;const _0x39ce31=await _0x23d782['payment'][_0x58316b(0x137)]({'where':{'paymentLinkId':_0xcfd19e[_0x58316b(0x10b)],'status':'PAID','paidAt':{'not':null},'id':{'not':_0x5419f6}}}),_0x4c5295=_0x39ce31+0x1,_0x18f4d8=await _0x23d782[_0x58316b(0xbd)]['update']({'where':{'id':_0xcfd19e['paymentLinkId']},'data':{'currentPayments':_0x4c5295,'status':_0x4c5295>=_0x43ea4b['maxPayments']?_0x58316b(0xea):_0x43ea4b[_0x58316b(0x16e)]}});return console[_0x58316b(0x101)]('📈\x20Payment\x20link\x20'+_0xcfd19e['paymentLinkId']+_0x58316b(0x141)+_0x43ea4b['currentPayments']+'\x20->\x20'+_0x4c5295+'/'+_0x43ea4b['maxPayments']),_0x18f4d8;});_0x2b5c84[_0x13dcf4(0x16e)]===_0x13dcf4(0xea)&&console[_0x13dcf4(0x101)](_0x13dcf4(0xe3)+_0xcfd19e[_0x13dcf4(0x10b)]+_0x13dcf4(0xc2)+_0x2b5c84[_0x13dcf4(0xc6)]+'/'+_0x2b5c84[_0x13dcf4(0xa4)]+')');}catch(_0xad686a){console['error'](_0x13dcf4(0xcf)+_0x5419f6+':',_0xad686a);}}async['getPaymentLinkStatistics'](_0x326c70){const _0x263420=a45_0x45f4e6,[_0x5ea819,_0x19ad02,_0x25574a,_0x1a7b9c]=await Promise['all']([database_1[_0x263420(0x12b)][_0x263420(0xbd)][_0x263420(0x137)]({'where':{'shopId':_0x326c70}}),database_1['default'][_0x263420(0xbd)][_0x263420(0x137)]({'where':{'shopId':_0x326c70,'status':_0x263420(0x122)}}),database_1[_0x263420(0x12b)][_0x263420(0xef)][_0x263420(0x137)]({'where':{'shopId':_0x326c70,'paymentLinkId':{'not':null}}}),database_1[_0x263420(0x12b)][_0x263420(0xef)][_0x263420(0xde)]({'where':{'shopId':_0x326c70,'paymentLinkId':{'not':null},'status':_0x263420(0x171)},'select':{'amount':!![],'currency':!![]}})]);let _0x4d3c70=0x0;for(const _0x4f79e5 of _0x1a7b9c){const _0x1a9d4c=await currencyService_1[_0x263420(0x146)][_0x263420(0x126)](_0x4f79e5[_0x263420(0x142)],_0x4f79e5['currency']);_0x4d3c70+=_0x1a9d4c;}const _0x1fdd97=_0x25574a>0x0?_0x1a7b9c[_0x263420(0x10f)]/_0x25574a*0x64:0x0;return{'totalLinks':_0x5ea819,'activeLinks':_0x19ad02,'totalPayments':_0x25574a,'totalRevenue':Math[_0x263420(0xb6)](_0x4d3c70*0x64)/0x64,'conversionRate':Math['round'](_0x1fdd97*0x64)/0x64};}[a45_0x45f4e6(0x108)](_0x232293){const _0x25aeac=a45_0x45f4e6;return{'id':_0x232293['id'],'shopId':_0x232293[_0x25aeac(0x124)],'amount':_0x232293[_0x25aeac(0x142)],'currency':_0x232293[_0x25aeac(0x154)],'sourceCurrency':_0x232293['sourceCurrency']||undefined,'gateway':_0x232293['gateway'],'maxPayments':_0x232293['maxPayments'],'currentPayments':_0x232293['currentPayments'],'status':_0x232293[_0x25aeac(0x16e)],'expiresAt':_0x232293[_0x25aeac(0xdb)]||undefined,'successUrl':_0x232293['successUrl']||undefined,'failUrl':_0x232293[_0x25aeac(0x109)]||undefined,'pendingUrl':_0x232293[_0x25aeac(0x10a)]||undefined,'country':_0x232293['country']||undefined,'language':_0x232293[_0x25aeac(0xba)]||undefined,'linkUrl':'https://app.trapay.uk/link/'+_0x232293['id'],'createdAt':_0x232293['createdAt'],'updatedAt':_0x232293[_0x25aeac(0x102)],'shop':_0x232293[_0x25aeac(0x104)],'payments':_0x232293[_0x25aeac(0x143)]};}}exports[a45_0x45f4e6(0xb1)]=PaymentLinkService;