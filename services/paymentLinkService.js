'use strict';const a49_0x5c5a70=a49_0x3bcf;(function(_0x2b7660,_0x3be18a){const _0x5f1a87=a49_0x3bcf,_0x1ce99e=_0x2b7660();while(!![]){try{const _0x4461fe=parseInt(_0x5f1a87(0x1dd))/0x1+-parseInt(_0x5f1a87(0x210))/0x2*(-parseInt(_0x5f1a87(0x1b9))/0x3)+parseInt(_0x5f1a87(0x1ef))/0x4*(-parseInt(_0x5f1a87(0x269))/0x5)+-parseInt(_0x5f1a87(0x206))/0x6+-parseInt(_0x5f1a87(0x215))/0x7+-parseInt(_0x5f1a87(0x17b))/0x8+parseInt(_0x5f1a87(0x194))/0x9*(parseInt(_0x5f1a87(0x1ac))/0xa);if(_0x4461fe===_0x3be18a)break;else _0x1ce99e['push'](_0x1ce99e['shift']());}catch(_0x3f7cb0){_0x1ce99e['push'](_0x1ce99e['shift']());}}}(a49_0x59eb,0xbfd7b));function a49_0x3bcf(_0x43baed,_0x12c9c3){const _0x59eb80=a49_0x59eb();return a49_0x3bcf=function(_0x3bcf00,_0x5cd243){_0x3bcf00=_0x3bcf00-0x175;let _0x21795c=_0x59eb80[_0x3bcf00];return _0x21795c;},a49_0x3bcf(_0x43baed,_0x12c9c3);}var __importDefault=this&&this['__importDefault']||function(_0x3f8765){const _0xcdd36c=a49_0x3bcf;return _0x3f8765&&_0x3f8765[_0xcdd36c(0x1c5)]?_0x3f8765:{'default':_0x3f8765};};function a49_0x59eb(){const _0xf995f4=['\x20payments)','\x20->\x20','paymentLinkId','update','map','username','💰\x20Checking\x20amount\x20limits\x20for\x20gateway:\x20','status','1371808fRNJbO','USD','createPaymentLink','expiresAt','currency','Rapyd','\x22\x20not\x20allowed\x20for\x20shop\x20','✅\x20KLYME\x20','CoinToPay','default','payment','toString','createPayment','MasterCard','language','./coinToPayStatusService','GBP','\x20USDT)\x20exceeds\x20the\x20maximum\x20allowed\x20amount\x20of\x20','🔗\x20Noda\x20payment\x20URL:\x20','getPaymentLinks','❌\x20Enabled\x20gateways:\x20','EUR','Plisio','floor','✅\x20Amount\x20','9oDYrRJ','https://apptest.trapay.uk/test-gateway/payment/','plisioService','CoinToPayService',',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','\x20\x20\x20🌐\x20Gateway\x20Pending\x20URL:\x20','\x20minimum\x20amount:\x20','🔗\x20Generated\x20whiteUrl\x20for\x20','plisio','error','Invalid\x20gateway\x20ID:\x20','./gateways/nodaService','\x20(validated\x20for\x20','ceil','This\x20single-use\x20payment\x20link\x20has\x20already\x20been\x20used','💰\x20Checking\x20amount\x20limits\x20for\x20shop\x20','test_gateway','no\x20email','Payment\x20amount\x20','toUpperCase','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','includes','country','COMPLETED','1665680mXrYzF','KLYME\x20GB','Please\x20reduce\x20the\x20amount.','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','\x20(MasterCard)','mastercard','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','💳\x20Initiating\x20payment\x20from\x20','getKlymeRegionFromGatewayName','💰\x20Fixed\x20amount:\x20','generateGatewayUrls','Error\x20parsing\x20gateway\x20settings:','https://apptest.trapay.uk/link/','1781121yhVDRU','💰\x20Gateway\x20','\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20','\x22\x20is\x20in\x20enabled\x20gateways:','$transaction','rapydService','Payment\x20link\x20is\x20not\x20active','none','getPaymentLinkStatistics','&payment_id=','💰\x20No\x20minimum\x20amount\x20set\x20for\x20gateway\x20','\x20status\x20is\x20','__esModule','rapyd','\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.','temp','Please\x20increase\x20the\x20amount.','currentPayments',')\x20counter\x20updated:\x20','pendingUrl','all','\x20link\x20with\x20','Gateway\x20\x22','qr_code_url','getGatewayDisplayName','Gateway\x20error:\x20','qr_url','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','env','👤\x20Customer:\x20','KlymeService','parse','type','generateGatewayOrderId','\x20enabled\x20gateways:','\x20maximum\x20amount:\x20','610618EwLgsD','nodaService','getPaymentLinkById','getPublicPaymentLinkData','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','getGatewayNameById','toFixed','Payment\x20link\x20','Test\x20Gateway','🔐\x20Checking\x20if\x20\x22','updatedAt','../types/gateway','coinToPayService','✅\x20Gateway\x20\x22','FAILED','\x20(Plisio\x20or\x20KLYME)','Payment\x20link\x20not\x20found','🔗\x20Link\x20type:\x20','164jCGcIi','📈\x20Single\x20payment\x20link\x20','MAX_SAFE_INTEGER','Anonymous','paymentGateways','currencyService','💳\x20MasterCard\x20form\x20URL:\x20','\x20USDT','\x20\x20\x20💾\x20DB\x20Pending\x20URL:\x20','formatPaymentLinkResponse','🔗\x20Rapyd\x20payment\x20URL:\x20','insensitive','🔗\x20Creating\x20','🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','klymeService','PAID','shop','✅\x20Payment\x20link\x20created:\x20','💳\x20Creating\x20KLYME\x20','/gateway/pending.php?id=','join','ACTIVE','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','991080CWTrhL','create','initiatePaymentFromLink','paidAt','\x20payments),\x20skipping\x20increment','\x20USDT\x20for\x20','amount','updatePaymentLink','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','Payment\x20link\x20has\x20expired','4qiYEGM','gatewaySettings','gateway','minAmount','\x20link\x20','2223221aAKSuG','💳\x20Creating\x20MasterCard\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','round','📈\x20Payment\x20','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','createdAt','Noda','https://apptest.trapay.uk/payment/pending?id=','🔗\x20Link\x20URL:\x20https://apptest.trapay.uk/link/','SINGLE','./gateways/plisioService','Shop\x20is\x20not\x20active','deletePaymentLink','log','\x20using\x20default\x20gateways:','cointopay','\x20gateway.\x20','multi-use','💰\x20Shop\x20','PaymentLinkService','sourceCurrency','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','https://apptest.trapay.uk/payment/','mc_','\x20USDT\x20is\x20below\x20minimum\x20','\x20\x20\x20🔗\x20White\x20URL:\x20','\x20(8digits-8digits\x20format)','🔐\x20Shop\x20','count','klyme_','📈\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','toISOString','payment_url','💰\x20Amount:\x20','\x20gateway\x20settings:','Shop\x20not\x20found','🔗\x20KLYME\x20','\x20(Test\x20Gateway)','🔗\x20Generated\x20URLs\x20for\x20','defineProperty','https://apptest.trapay.uk/payment/success?id=','invoice_total_sum','paymentLink','BASE_URL','single-use','Unknown\x20error','💾\x20DB\x20Fail\x20URL:\x20','🔗\x20Test\x20Gateway\x20payment\x20URL:\x20','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','💰\x20Plisio\x20payment\x20link\x20mapping:','💾\x20Payment\x20created:\x20','Gateway\x20not\x20found\x20for\x20ID:\x20','Unsupported\x20gateway:\x20','\x20(8digits-8digits\x20format\x20for\x20','https://apptest.trapay.uk/payment/fail?id=','maxAmount','\x20not\x20found','🔗\x20No\x20whiteUrl\x20for\x20','isValidGatewayId','\x20to\x20','gateway_payment_id','successUrl','Error\x20parsing\x20payment\x20gateways:','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20','ONCE','failUrl','random','\x20USDT\x20for\x20gateway\x20','checkGatewayPermission','Payment\x20','NodaService','Unsupported\x20KLYME\x20region:\x20','./gateways/klymeService','findUnique','validateKlymeCurrency','https://tesoft.uk/gateways/noda/webhook','checkAmountLimits','desc','\x20with\x20payment\x20ID\x20','\x20payment\x20link','startsWith','\x20USDT)\x20is\x20below\x20the\x20minimum\x20required\x20amount\x20of\x20','./gateways/coinToPayService','schedulePaymentChecks','63970YmcWPc','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','Payment\x20link\x20has\x20reached\x20maximum\x20payments','https://tesoft.uk','🔐\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','findMany','❌\x20Amount\x20','🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','shopId'];a49_0x59eb=function(){return _0xf995f4;};return a49_0x59eb();}Object[a49_0x5c5a70(0x23c)](exports,a49_0x5c5a70(0x1c5),{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a49_0x5c5a70(0x21f)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a49_0x5c5a70(0x19f)),coinToPayService_1=require(a49_0x5c5a70(0x267)),klymeService_1=require(a49_0x5c5a70(0x25d)),coinToPayStatusService_1=require(a49_0x5c5a70(0x18a)),gateway_1=require(a49_0x5c5a70(0x1e8)),currencyService_1=require('./currencyService');class PaymentLinkService{constructor(){const _0x279fc5=a49_0x5c5a70;this['plisioService']=new plisioService_1['PlisioService'](),this[_0x279fc5(0x1be)]=new rapydService_1['RapydService'](),this[_0x279fc5(0x1de)]=new nodaService_1[(_0x279fc5(0x25b))](),this[_0x279fc5(0x1e9)]=new coinToPayService_1[(_0x279fc5(0x197))](),this[_0x279fc5(0x1fd)]=new klymeService_1[(_0x279fc5(0x1d7))]();}[a49_0x5c5a70(0x1da)](){const _0x256ffc=()=>{const _0x1ba3fc=a49_0x3bcf;return Math[_0x1ba3fc(0x192)](Math[_0x1ba3fc(0x257)]()*0x5f5e100)[_0x1ba3fc(0x186)]()['padStart'](0x8,'0');};return _0x256ffc()+'-'+_0x256ffc();}[a49_0x5c5a70(0x1b6)](_0x39c468,_0x1d6e33,_0x67bef4,_0x3901b4,_0x26ae2a,_0xcf5df9,_0x5df18d){const _0x1b4c8c=a49_0x5c5a70;if(_0x26ae2a&&_0xcf5df9&&_0x5df18d)return{'finalSuccessUrl':_0x26ae2a,'finalFailUrl':_0xcf5df9,'finalPendingUrl':_0x5df18d,'dbSuccessUrl':_0x26ae2a,'dbFailUrl':_0xcf5df9,'dbPendingUrl':_0x5df18d,'whiteUrl':null};const _0x1c09ac=_0x26ae2a||_0x1b4c8c(0x23d)+_0x1d6e33+_0x1b4c8c(0x1c2)+_0x67bef4,_0x23134e=_0xcf5df9||_0x1b4c8c(0x24b)+_0x1d6e33+_0x1b4c8c(0x1c2)+_0x67bef4,_0x2dad72=_0x5df18d||_0x1b4c8c(0x21c)+_0x1d6e33+_0x1b4c8c(0x1c2)+_0x67bef4;let _0x53491d,_0x27de4a,_0x466dc6;_0x39c468==='noda'||_0x39c468[_0x1b4c8c(0x265)](_0x1b4c8c(0x232))||_0x39c468===_0x1b4c8c(0x224)?(_0x53491d=_0x3901b4+'/gateway/pending.php?id='+_0x1d6e33,_0x466dc6=_0x3901b4+_0x1b4c8c(0x202)+_0x1d6e33):(_0x53491d=_0x3901b4+'/gateway/success.php?id='+_0x1d6e33,_0x466dc6=_0x3901b4+_0x1b4c8c(0x202)+_0x1d6e33);_0x27de4a=_0x3901b4+'/gateway/fail.php?id='+_0x1d6e33;let _0x2f3310=null;return _0x39c468!==_0x1b4c8c(0x19c)&&!_0x39c468[_0x1b4c8c(0x265)]('klyme_')?(_0x2f3310='https://tesoft.uk/gateway/payment.php?id='+_0x1d6e33,console[_0x1b4c8c(0x222)](_0x1b4c8c(0x19b)+_0x39c468+':\x20'+_0x2f3310)):console[_0x1b4c8c(0x222)](_0x1b4c8c(0x24e)+_0x39c468+_0x1b4c8c(0x1ec)),console[_0x1b4c8c(0x222)](_0x1b4c8c(0x23b)+_0x39c468+_0x1b4c8c(0x263)+_0x1d6e33+':'),console[_0x1b4c8c(0x222)]('\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20'+_0x53491d),console['log'](_0x1b4c8c(0x205)+_0x27de4a),console['log'](_0x1b4c8c(0x199)+_0x466dc6),console[_0x1b4c8c(0x222)](_0x1b4c8c(0x1d4)+_0x1c09ac),console[_0x1b4c8c(0x222)](_0x1b4c8c(0x1bb)+_0x23134e),console['log'](_0x1b4c8c(0x1f7)+_0x2dad72),console[_0x1b4c8c(0x222)](_0x1b4c8c(0x22e)+(_0x2f3310||_0x1b4c8c(0x1c0))),{'finalSuccessUrl':_0x53491d,'finalFailUrl':_0x27de4a,'finalPendingUrl':_0x466dc6,'dbSuccessUrl':_0x1c09ac,'dbFailUrl':_0x23134e,'dbPendingUrl':_0x2dad72,'whiteUrl':_0x2f3310};}['validateKlymeCurrency'](_0x3f3d5e,_0x107e9c){const _0x207a01=a49_0x5c5a70;if(!_0x3f3d5e['startsWith'](_0x207a01(0x232)))return;const _0x57ccf7=(0x0,gateway_1[_0x207a01(0x1b4)])(_0x3f3d5e),_0x1aac54=_0x107e9c[_0x207a01(0x1a7)]();switch(_0x57ccf7){case'EU':if(_0x1aac54!==_0x207a01(0x190))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x1aac54);break;case'GB':if(_0x1aac54!==_0x207a01(0x18b))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x1aac54);break;case'DE':if(_0x1aac54!==_0x207a01(0x190))throw new Error(_0x207a01(0x22a)+_0x1aac54);break;default:throw new Error(_0x207a01(0x25c)+_0x57ccf7);}}async[a49_0x5c5a70(0x261)](_0x6c136b,_0x3ff578,_0x5c9de2,_0x31f72c){const _0x35041a=a49_0x5c5a70;console[_0x35041a(0x222)](_0x35041a(0x1a3)+_0x6c136b+',\x20gateway\x20'+_0x3ff578+',\x20amount:\x20'+_0x5c9de2+'\x20'+_0x31f72c);const _0x3afa8a=await currencyService_1[_0x35041a(0x1f4)]['convertToUSDT'](_0x5c9de2,_0x31f72c);console['log']('💱\x20Converted\x20'+_0x5c9de2+'\x20'+_0x31f72c+_0x35041a(0x250)+_0x3afa8a[_0x35041a(0x1e3)](0x6)+'\x20USDT\x20for\x20limit\x20checking');const _0x55df38=await database_1['default']['shop'][_0x35041a(0x25e)]({'where':{'id':_0x6c136b},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x55df38)throw new Error(_0x35041a(0x238));let _0x11f42d={};if(_0x55df38[_0x35041a(0x211)])try{_0x11f42d=JSON[_0x35041a(0x1d8)](_0x55df38[_0x35041a(0x211)]),console[_0x35041a(0x222)](_0x35041a(0x227)+_0x55df38[_0x35041a(0x178)]+_0x35041a(0x237),_0x11f42d);}catch(_0x3468d8){console[_0x35041a(0x19d)](_0x35041a(0x1b7),_0x3468d8),_0x11f42d={};}const _0x31ab9d=this['getGatewayDisplayName'](_0x3ff578);console[_0x35041a(0x222)](_0x35041a(0x179)+_0x3ff578+'\x20->\x20'+_0x31ab9d);const _0x9fabff=_0x11f42d[_0x31ab9d];if(_0x9fabff&&_0x9fabff[_0x35041a(0x213)]!==undefined){const _0x23a0e5=_0x9fabff[_0x35041a(0x213)];console[_0x35041a(0x222)]('💰\x20Gateway\x20'+_0x31ab9d+_0x35041a(0x19a)+_0x23a0e5+_0x35041a(0x1f6));if(_0x3afa8a<_0x23a0e5){console[_0x35041a(0x19d)](_0x35041a(0x26f)+_0x3afa8a[_0x35041a(0x1e3)](0x6)+_0x35041a(0x22d)+_0x23a0e5+'\x20USDT\x20for\x20gateway\x20'+_0x31ab9d);throw new Error(_0x35041a(0x1a6)+_0x5c9de2+'\x20'+_0x31f72c+'\x20('+_0x3afa8a[_0x35041a(0x1e3)](0x2)+_0x35041a(0x266)+_0x23a0e5+_0x35041a(0x20b)+_0x31ab9d+_0x35041a(0x225)+_0x35041a(0x1c9));}console['log'](_0x35041a(0x193)+_0x3afa8a[_0x35041a(0x1e3)](0x6)+'\x20USDT\x20meets\x20minimum\x20requirement\x20of\x20'+_0x23a0e5+'\x20USDT\x20for\x20gateway\x20'+_0x31ab9d);}else console[_0x35041a(0x222)](_0x35041a(0x1c3)+_0x31ab9d);if(_0x9fabff&&_0x9fabff[_0x35041a(0x24c)]!==undefined){const _0x20107f=_0x9fabff['maxAmount'];console[_0x35041a(0x222)](_0x35041a(0x1ba)+_0x31ab9d+_0x35041a(0x1dc)+_0x20107f+_0x35041a(0x1f6));if(_0x3afa8a>_0x20107f){console[_0x35041a(0x19d)](_0x35041a(0x26f)+_0x3afa8a[_0x35041a(0x1e3)](0x6)+'\x20USDT\x20exceeds\x20maximum\x20'+_0x20107f+_0x35041a(0x258)+_0x31ab9d);throw new Error(_0x35041a(0x1a6)+_0x5c9de2+'\x20'+_0x31f72c+'\x20('+_0x3afa8a[_0x35041a(0x1e3)](0x2)+_0x35041a(0x18c)+_0x20107f+_0x35041a(0x20b)+_0x31ab9d+_0x35041a(0x225)+_0x35041a(0x1ae));}console['log']('✅\x20Amount\x20'+_0x3afa8a[_0x35041a(0x1e3)](0x6)+'\x20USDT\x20meets\x20maximum\x20requirement\x20of\x20'+_0x20107f+_0x35041a(0x258)+_0x31ab9d);}else console[_0x35041a(0x222)]('💰\x20No\x20maximum\x20amount\x20set\x20for\x20gateway\x20'+_0x31ab9d);}async[a49_0x5c5a70(0x259)](_0x285b4f,_0x185167){const _0x5bad92=a49_0x5c5a70;console[_0x5bad92(0x222)](_0x5bad92(0x26d)+_0x285b4f+':\x20'+_0x185167);const _0x2fbd08=await database_1[_0x5bad92(0x184)][_0x5bad92(0x1ff)][_0x5bad92(0x25e)]({'where':{'id':_0x285b4f},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x2fbd08)throw new Error(_0x5bad92(0x238));let _0x139775=[];if(_0x2fbd08[_0x5bad92(0x1f3)])try{_0x139775=JSON[_0x5bad92(0x1d8)](_0x2fbd08[_0x5bad92(0x1f3)]),console['log'](_0x5bad92(0x230)+_0x2fbd08[_0x5bad92(0x178)]+_0x5bad92(0x1db),_0x139775);}catch(_0x4aa868){console[_0x5bad92(0x19d)](_0x5bad92(0x253),_0x4aa868),_0x139775=[_0x5bad92(0x191)];}else _0x139775=[_0x5bad92(0x191)],console[_0x5bad92(0x222)]('🔐\x20Shop\x20'+_0x2fbd08[_0x5bad92(0x178)]+_0x5bad92(0x223),_0x139775);const _0x38c6ae=this[_0x5bad92(0x1d1)](_0x185167);console['log'](_0x5bad92(0x1e6)+_0x38c6ae+_0x5bad92(0x1bc),_0x139775);if(!_0x139775[_0x5bad92(0x1a9)](_0x38c6ae)){console[_0x5bad92(0x19d)]('❌\x20Gateway\x20\x22'+_0x38c6ae+_0x5bad92(0x181)+_0x2fbd08[_0x5bad92(0x178)]),console[_0x5bad92(0x19d)](_0x5bad92(0x18f)+_0x139775['join'](',\x20'));throw new Error(_0x5bad92(0x1cf)+_0x38c6ae+_0x5bad92(0x219)+('Enabled\x20gateways:\x20'+_0x139775[_0x5bad92(0x203)](',\x20')+'.\x20')+'Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.');}console[_0x5bad92(0x222)](_0x5bad92(0x1ea)+_0x38c6ae+'\x22\x20is\x20allowed\x20for\x20shop\x20'+_0x2fbd08['username']);}[a49_0x5c5a70(0x1d1)](_0x18388a){const _0x4f64c0=a49_0x5c5a70,_0x25416d={'test_gateway':_0x4f64c0(0x1e5),'plisio':_0x4f64c0(0x191),'rapyd':_0x4f64c0(0x180),'noda':_0x4f64c0(0x21b),'cointopay':_0x4f64c0(0x183),'klyme_eu':'KLYME\x20EU','klyme_gb':_0x4f64c0(0x1ad),'klyme_de':'KLYME\x20DE','mastercard':_0x4f64c0(0x188)};return _0x25416d[_0x18388a]||_0x18388a;}async['createPaymentLink'](_0x2009ef,_0x437e68){const _0x448434=a49_0x5c5a70;if(!(0x0,gateway_1['isValidGatewayId'])(_0x437e68['gateway']))throw new Error(_0x448434(0x19e)+_0x437e68[_0x448434(0x212)]+'.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)');const _0x4024db=(0x0,gateway_1[_0x448434(0x1e2)])(_0x437e68[_0x448434(0x212)]);if(!_0x4024db)throw new Error(_0x448434(0x248)+_0x437e68[_0x448434(0x212)]);console[_0x448434(0x222)](_0x448434(0x270)+_0x4024db),await this[_0x448434(0x259)](_0x2009ef,_0x4024db);if(_0x4024db===_0x448434(0x19c)&&!_0x437e68['sourceCurrency'])throw new Error('sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links');if(_0x4024db[_0x448434(0x265)](_0x448434(0x232))){const _0x1f28ee=(0x0,gateway_1[_0x448434(0x1b4)])(_0x4024db);console[_0x448434(0x222)](_0x448434(0x201)+_0x1f28ee+'\x20payment\x20link');}let _0x4775de=_0x437e68['country'];_0x4024db===_0x448434(0x1c6)&&(_0x4775de='GB',console['log']('🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link'));if(!_0x437e68['amount']||_0x437e68[_0x448434(0x20c)]<=0x0)throw new Error('amount\x20is\x20required\x20and\x20must\x20be\x20positive');let _0x508055=_0x437e68[_0x448434(0x17f)]||_0x448434(0x17c);_0x4024db===_0x448434(0x224)&&(_0x508055=_0x448434(0x190),console[_0x448434(0x222)]('🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link'));this['validateKlymeCurrency'](_0x4024db,_0x508055),await this['checkAmountLimits'](_0x2009ef,_0x4024db,_0x437e68['amount'],_0x508055);const _0x2b2e91=_0x437e68[_0x448434(0x1d9)]||'SINGLE';console[_0x448434(0x222)](_0x448434(0x1fb)+_0x2b2e91+_0x448434(0x264));const _0x1a0153=await database_1[_0x448434(0x184)]['paymentLink'][_0x448434(0x207)]({'data':{'shopId':_0x2009ef,'amount':_0x437e68['amount'],'currency':_0x508055,'sourceCurrency':_0x437e68['sourceCurrency']||undefined,'gateway':_0x4024db,'type':_0x2b2e91,'currentPayments':0x0,'status':_0x448434(0x204),'expiresAt':_0x437e68[_0x448434(0x17e)]?new Date(_0x437e68[_0x448434(0x17e)]):undefined,'successUrl':_0x437e68['successUrl']||null,'failUrl':_0x437e68[_0x448434(0x256)]||null,'pendingUrl':_0x437e68[_0x448434(0x1cc)]||null,'country':_0x4775de,'language':_0x437e68[_0x448434(0x189)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console['log'](_0x448434(0x200)+_0x1a0153['id']+'\x20('+_0x4024db+')'),console[_0x448434(0x222)](_0x448434(0x1b5)+_0x1a0153[_0x448434(0x20c)]+'\x20'+_0x1a0153[_0x448434(0x17f)]),console['log'](_0x448434(0x1ee)+_0x1a0153[_0x448434(0x1d9)]),console[_0x448434(0x222)](_0x448434(0x21d)+_0x1a0153['id']),console[_0x448434(0x222)]('📝\x20Note:\x20Success/Fail/Pending\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created'),this[_0x448434(0x1f8)](_0x1a0153);}async[a49_0x5c5a70(0x18e)](_0x1c16bd,_0x29e833){const _0x3945cd=a49_0x5c5a70,{page:_0x26ef63,limit:_0x3125e4,status:_0x41a28d,gateway:_0x48970e,search:_0x27b7e2}=_0x29e833,_0x48bcfa=(_0x26ef63-0x1)*_0x3125e4,_0x361802={'shopId':_0x1c16bd};_0x41a28d&&(_0x361802[_0x3945cd(0x17a)]=_0x41a28d[_0x3945cd(0x1a7)]());if(_0x48970e){if((0x0,gateway_1['isValidGatewayId'])(_0x48970e)){const _0x4699d8=(0x0,gateway_1[_0x3945cd(0x1e2)])(_0x48970e);_0x4699d8&&(_0x361802['gateway']=_0x4699d8);}else _0x361802['gateway']=_0x48970e['toLowerCase']();}_0x27b7e2&&(_0x361802['OR']=[{'gateway':{'contains':_0x27b7e2,'mode':'insensitive'}},{'currency':{'contains':_0x27b7e2,'mode':_0x3945cd(0x1fa)}}]);const [_0x5c79bd,_0x5825c5]=await Promise[_0x3945cd(0x1cd)]([database_1[_0x3945cd(0x184)][_0x3945cd(0x23f)]['findMany']({'where':_0x361802,'skip':_0x48bcfa,'take':_0x3125e4,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x3945cd(0x262)},'take':0xa}}}),database_1[_0x3945cd(0x184)][_0x3945cd(0x23f)][_0x3945cd(0x231)]({'where':_0x361802})]);return{'links':_0x5c79bd[_0x3945cd(0x177)](_0x3090e9=>this[_0x3945cd(0x1f8)](_0x3090e9)),'pagination':{'page':_0x26ef63,'limit':_0x3125e4,'total':_0x5825c5,'totalPages':Math[_0x3945cd(0x1a1)](_0x5825c5/_0x3125e4)}};}async[a49_0x5c5a70(0x1df)](_0xdfc1fd,_0x389a4e){const _0x25e335=a49_0x5c5a70,_0x7baf92=await database_1[_0x25e335(0x184)][_0x25e335(0x23f)]['findFirst']({'where':{'id':_0x389a4e,'shopId':_0xdfc1fd},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x25e335(0x262)}}}});if(!_0x7baf92)return null;return this[_0x25e335(0x1f8)](_0x7baf92);}async[a49_0x5c5a70(0x20d)](_0xbaf005,_0xf00ad5,_0xc29a74){const _0x489daf=a49_0x5c5a70,_0x182585={..._0xc29a74};if(_0xc29a74[_0x489daf(0x212)]){if((0x0,gateway_1[_0x489daf(0x24f)])(_0xc29a74[_0x489daf(0x212)])){const _0x387a5d=(0x0,gateway_1['getGatewayNameById'])(_0xc29a74['gateway']);_0x387a5d&&(await this[_0x489daf(0x259)](_0xbaf005,_0x387a5d),_0x182585[_0x489daf(0x212)]=_0x387a5d);}else _0x182585[_0x489daf(0x212)]=_0xc29a74[_0x489daf(0x212)]['toLowerCase']();}(_0x182585[_0x489daf(0x212)]==='rapyd'||_0xc29a74[_0x489daf(0x1aa)]&&_0x182585[_0x489daf(0x212)]!=='rapyd')&&(_0x182585[_0x489daf(0x212)]==='rapyd'&&(_0x182585[_0x489daf(0x1aa)]='GB',console[_0x489daf(0x222)]('🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update')));_0x182585['gateway']==='cointopay'&&(_0x182585[_0x489daf(0x17f)]=_0x489daf(0x190),console[_0x489daf(0x222)](_0x489daf(0x1a8)));_0x182585[_0x489daf(0x212)]&&_0x182585['currency']&&this[_0x489daf(0x25f)](_0x182585[_0x489daf(0x212)],_0x182585[_0x489daf(0x17f)]);if(_0xc29a74['amount']&&_0x182585[_0x489daf(0x212)]){const _0x4f583b=_0xc29a74[_0x489daf(0x17f)]||_0x489daf(0x17c);await this['checkAmountLimits'](_0xbaf005,_0x182585[_0x489daf(0x212)],_0xc29a74['amount'],_0x4f583b);}_0xc29a74[_0x489daf(0x17e)]&&(_0x182585['expiresAt']=new Date(_0xc29a74[_0x489daf(0x17e)]));const _0x127c8f=await database_1[_0x489daf(0x184)][_0x489daf(0x23f)][_0x489daf(0x176)]({'where':{'id':_0xf00ad5,'shopId':_0xbaf005},'data':_0x182585,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x489daf(0x262)},'take':0xa}}});return this[_0x489daf(0x1f8)](_0x127c8f);}async[a49_0x5c5a70(0x221)](_0x32d50d,_0x33d7bd){const _0x4aa84a=a49_0x5c5a70;await database_1[_0x4aa84a(0x184)]['paymentLink']['delete']({'where':{'id':_0x33d7bd,'shopId':_0x32d50d}});}async[a49_0x5c5a70(0x1e0)](_0x11791d){const _0x261005=a49_0x5c5a70,_0x459a2d=await database_1[_0x261005(0x184)][_0x261005(0x23f)][_0x261005(0x25e)]({'where':{'id':_0x11791d},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x459a2d)return null;const _0x2acba9=_0x459a2d[_0x261005(0x17e)]&&_0x459a2d['expiresAt']<new Date(),_0x1e8f02=_0x459a2d[_0x261005(0x1d9)]===_0x261005(0x21e)?_0x459a2d[_0x261005(0x1ca)]>=0x1:![],_0x139441=_0x459a2d[_0x261005(0x1ff)][_0x261005(0x17a)]===_0x261005(0x204),_0x536081=_0x459a2d[_0x261005(0x17a)]===_0x261005(0x204),_0x2bbab6=!_0x2acba9&&!_0x1e8f02&&_0x139441&&_0x536081,_0x2414cd=_0x459a2d[_0x261005(0x1d9)]===_0x261005(0x21e)?_0x459a2d[_0x261005(0x1ca)]>=0x1?0x0:0x1:Number[_0x261005(0x1f1)];return{'id':_0x459a2d['id'],'amount':_0x459a2d[_0x261005(0x20c)],'currency':_0x459a2d[_0x261005(0x17f)],'sourceCurrency':_0x459a2d[_0x261005(0x229)]||undefined,'gateway':_0x459a2d[_0x261005(0x212)],'type':_0x459a2d[_0x261005(0x1d9)],'currentPayments':_0x459a2d[_0x261005(0x1ca)],'status':_0x459a2d[_0x261005(0x17a)],'expiresAt':_0x459a2d[_0x261005(0x17e)]||undefined,'shopName':_0x459a2d[_0x261005(0x1ff)]['name'],'isAvailable':_0x2bbab6,'remainingPayments':_0x2414cd};}async[a49_0x5c5a70(0x208)](_0x1e6892){const _0x13e065=a49_0x5c5a70,{linkId:_0x1c27f8,customerEmail:_0x19efd4,customerName:_0x22372f}=_0x1e6892,_0x27efee=await database_1[_0x13e065(0x184)][_0x13e065(0x23f)][_0x13e065(0x25e)]({'where':{'id':_0x1c27f8},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x27efee)throw new Error(_0x13e065(0x1ed));const _0x498fc0=_0x27efee['expiresAt']&&_0x27efee[_0x13e065(0x17e)]<new Date(),_0x1207fb=_0x27efee[_0x13e065(0x1d9)]===_0x13e065(0x21e)?_0x27efee[_0x13e065(0x1ca)]>=0x1:![],_0x3f2cde=_0x27efee[_0x13e065(0x1ff)][_0x13e065(0x17a)]===_0x13e065(0x204),_0x9d508b=_0x27efee[_0x13e065(0x17a)]==='ACTIVE';if(_0x498fc0)throw new Error(_0x13e065(0x20f));if(_0x1207fb){const _0x3d0d12=_0x27efee[_0x13e065(0x1d9)]==='SINGLE'?_0x13e065(0x1a2):_0x13e065(0x26b);throw new Error(_0x3d0d12);}if(!_0x3f2cde)throw new Error(_0x13e065(0x220));if(!_0x9d508b)throw new Error(_0x13e065(0x1bf));await this['checkGatewayPermission'](_0x27efee[_0x13e065(0x272)],_0x27efee[_0x13e065(0x212)]);const _0x41ef9a=_0x27efee['amount'];console[_0x13e065(0x222)](_0x13e065(0x1b3)+_0x27efee[_0x13e065(0x1d9)]+_0x13e065(0x214)+_0x1c27f8+':\x20'+_0x41ef9a+'\x20'+_0x27efee[_0x13e065(0x17f)]),console['log'](_0x13e065(0x1d6)+(_0x22372f||_0x13e065(0x1f2))+'\x20('+(_0x19efd4||_0x13e065(0x1a5))+')'),this[_0x13e065(0x25f)](_0x27efee[_0x13e065(0x212)],_0x27efee[_0x13e065(0x17f)]),await this['checkAmountLimits'](_0x27efee[_0x13e065(0x272)],_0x27efee[_0x13e065(0x212)],_0x41ef9a,_0x27efee['currency']);const _0x875c9e=this[_0x13e065(0x1da)]();console[_0x13e065(0x222)]('🎯\x20Generated\x20gateway\x20order_id:\x20'+_0x875c9e+_0x13e065(0x24a)+_0x27efee[_0x13e065(0x212)]+')');const _0x2d8d54=await database_1['default'][_0x13e065(0x185)][_0x13e065(0x207)]({'data':{'shopId':_0x27efee[_0x13e065(0x272)],'paymentLinkId':_0x27efee['id'],'gateway':_0x27efee[_0x13e065(0x212)],'amount':_0x41ef9a,'currency':_0x27efee[_0x13e065(0x17f)],'sourceCurrency':_0x27efee[_0x13e065(0x229)]||undefined,'usage':'ONCE','expiresAt':_0x27efee['expiresAt']||undefined,'successUrl':_0x13e065(0x1c8),'failUrl':_0x13e065(0x1c8),'pendingUrl':'temp','whiteUrl':'temp','status':'PENDING','orderId':null,'gatewayOrderId':_0x875c9e,'customerEmail':_0x19efd4||undefined,'customerName':_0x22372f||undefined,'country':_0x27efee[_0x13e065(0x1aa)]||undefined,'language':_0x27efee[_0x13e065(0x189)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console['log'](_0x13e065(0x247)+_0x2d8d54['id']);const _0x553df1=process[_0x13e065(0x1d5)][_0x13e065(0x240)]||_0x13e065(0x26c),{finalSuccessUrl:_0x93e33f,finalFailUrl:_0x2f06dc,finalPendingUrl:_0x26d428,dbSuccessUrl:_0x4d7c4a,dbFailUrl:_0x180aac,dbPendingUrl:_0x2f0ae8,whiteUrl:_0x4069c6}=this[_0x13e065(0x1b6)](_0x27efee[_0x13e065(0x212)],_0x2d8d54['id'],_0x875c9e,_0x553df1,_0x27efee[_0x13e065(0x252)]||undefined,_0x27efee[_0x13e065(0x256)]||undefined,_0x27efee[_0x13e065(0x1cc)]||undefined);await database_1[_0x13e065(0x184)][_0x13e065(0x185)][_0x13e065(0x176)]({'where':{'id':_0x2d8d54['id']},'data':{'successUrl':_0x4d7c4a,'failUrl':_0x180aac,'pendingUrl':_0x2f0ae8,'whiteUrl':_0x4069c6}}),console[_0x13e065(0x222)](_0x13e065(0x236)+_0x41ef9a+'\x20'+_0x27efee['currency']),console['log']('👤\x20Customer:\x20'+(_0x22372f||'Anonymous')+'\x20('+(_0x19efd4||_0x13e065(0x1a5))+')'),console[_0x13e065(0x222)]('💾\x20DB\x20Success\x20URL:\x20'+_0x4d7c4a),console['log'](_0x13e065(0x243)+_0x180aac),console['log']('💾\x20DB\x20Pending\x20URL:\x20'+_0x2f0ae8),console[_0x13e065(0x222)]('🔗\x20White\x20URL:\x20'+(_0x4069c6||_0x13e065(0x1c0)));let _0x54c977,_0x281788;try{if(_0x27efee[_0x13e065(0x212)]==='plisio'){console['log'](_0x13e065(0x246)),console[_0x13e065(0x222)](_0x13e065(0x245)+_0x27efee['currency']),console[_0x13e065(0x222)](_0x13e065(0x1e1)+_0x27efee['sourceCurrency']);const _0x47c577=await this[_0x13e065(0x196)][_0x13e065(0x187)]({'paymentId':_0x2d8d54['id'],'orderId':_0x875c9e,'amount':_0x41ef9a,'currency':_0x27efee[_0x13e065(0x17f)],'productName':_0x13e065(0x25a)+_0x41ef9a+'\x20'+_0x27efee[_0x13e065(0x17f)],'description':_0x13e065(0x25a)+_0x41ef9a+'\x20'+_0x27efee[_0x13e065(0x17f)],'successUrl':_0x93e33f,'failUrl':_0x2f06dc,'customerEmail':_0x19efd4||undefined,'customerName':_0x22372f||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x27efee['sourceCurrency']||undefined});_0x54c977=_0x47c577[_0x13e065(0x251)],_0x281788=_0x47c577[_0x13e065(0x235)],await database_1['default']['payment']['update']({'where':{'id':_0x2d8d54['id']},'data':{'externalPaymentUrl':_0x281788,'gatewayPaymentId':_0x54c977,'invoiceTotalSum':Number(_0x47c577[_0x13e065(0x23e)]),'qrCode':_0x47c577['qr_code'],'qrUrl':_0x47c577[_0x13e065(0x1d3)]}});const _0x399a74=_0x13e065(0x22b)+_0x2d8d54['id'];return console[_0x13e065(0x222)]('🔗\x20Plisio\x20payment\x20URL:\x20'+_0x399a74),{'paymentId':_0x2d8d54['id'],'paymentUrl':_0x399a74,'expiresAt':_0x2d8d54[_0x13e065(0x17e)]||undefined};}else{if(_0x27efee[_0x13e065(0x212)]===_0x13e065(0x1c6)){const _0x2d1d45=await this[_0x13e065(0x1be)][_0x13e065(0x17d)]({'paymentId':_0x2d8d54['id'],'orderId':_0x875c9e,'orderName':_0x13e065(0x25a)+_0x41ef9a+'\x20'+_0x27efee[_0x13e065(0x17f)],'amount':_0x41ef9a,'currency':_0x27efee[_0x13e065(0x17f)],'country':_0x27efee[_0x13e065(0x1aa)],'language':_0x27efee[_0x13e065(0x189)]||'EN','amountIsEditable':![],'usage':_0x13e065(0x255),'maxPayments':0x1,'successUrl':_0x93e33f,'failUrl':_0x2f06dc});_0x54c977=_0x2d1d45[_0x13e065(0x251)],_0x281788=_0x2d1d45['payment_url'],await database_1[_0x13e065(0x184)][_0x13e065(0x185)]['update']({'where':{'id':_0x2d8d54['id']},'data':{'externalPaymentUrl':_0x281788,'gatewayPaymentId':_0x54c977}});const _0x3fa4b8='https://apptest.trapay.uk/payment/'+_0x2d8d54['id'];return console[_0x13e065(0x222)](_0x13e065(0x1f9)+_0x3fa4b8),{'paymentId':_0x2d8d54['id'],'paymentUrl':_0x3fa4b8,'expiresAt':_0x2d8d54[_0x13e065(0x17e)]||undefined};}else{if(_0x27efee[_0x13e065(0x212)]==='noda'){const _0x4e4a52=await this[_0x13e065(0x1de)][_0x13e065(0x17d)]({'paymentId':_0x2d8d54['id'],'orderId':_0x875c9e,'name':'Payment\x20'+_0x41ef9a+'\x20'+_0x27efee[_0x13e065(0x17f)],'paymentDescription':_0x13e065(0x25a)+_0x41ef9a+'\x20'+_0x27efee[_0x13e065(0x17f)],'amount':_0x41ef9a,'currency':_0x27efee[_0x13e065(0x17f)],'webhookUrl':_0x13e065(0x260),'returnUrl':_0x26d428,'expiryDate':_0x27efee[_0x13e065(0x17e)]?.[_0x13e065(0x234)]()});_0x54c977=_0x4e4a52[_0x13e065(0x251)],_0x281788=_0x4e4a52[_0x13e065(0x235)],await database_1[_0x13e065(0x184)][_0x13e065(0x185)][_0x13e065(0x176)]({'where':{'id':_0x2d8d54['id']},'data':{'externalPaymentUrl':_0x281788,'gatewayPaymentId':_0x54c977,'qrUrl':_0x4e4a52[_0x13e065(0x1d0)]}});const _0x4a8226=_0x13e065(0x22b)+_0x2d8d54['id'];return console[_0x13e065(0x222)](_0x13e065(0x18d)+_0x4a8226),{'paymentId':_0x2d8d54['id'],'paymentUrl':_0x4a8226,'expiresAt':_0x2d8d54[_0x13e065(0x17e)]||undefined};}else{if(_0x27efee[_0x13e065(0x212)]===_0x13e065(0x224)){console[_0x13e065(0x222)](_0x13e065(0x1fc)+_0x875c9e+'\x20(8digits-8digits\x20format)'),console[_0x13e065(0x222)]('💰\x20Amount:\x20'+_0x41ef9a+_0x13e065(0x20e));const _0x34952c=await this['coinToPayService']['createPaymentLink']({'paymentId':_0x2d8d54['id'],'orderId':_0x875c9e,'amount':_0x41ef9a});_0x54c977=_0x34952c[_0x13e065(0x251)],_0x281788=_0x34952c[_0x13e065(0x235)],await database_1[_0x13e065(0x184)]['payment'][_0x13e065(0x176)]({'where':{'id':_0x2d8d54['id']},'data':{'externalPaymentUrl':_0x281788,'gatewayPaymentId':_0x54c977}});_0x54c977&&(console[_0x13e065(0x222)](_0x13e065(0x254)+_0x2d8d54['id']+'\x20('+_0x54c977+')'),coinToPayStatusService_1['coinToPayStatusService'][_0x13e065(0x268)](_0x2d8d54['id'],_0x54c977));const _0x355594=_0x13e065(0x22b)+_0x2d8d54['id'];return console['log']('🔗\x20CoinToPay\x20payment\x20URL:\x20'+_0x355594),{'paymentId':_0x2d8d54['id'],'paymentUrl':_0x355594,'expiresAt':_0x2d8d54[_0x13e065(0x17e)]||undefined};}else{if(_0x27efee[_0x13e065(0x212)]['startsWith']('klyme_')){const _0x26b678=(0x0,gateway_1[_0x13e065(0x1b4)])(_0x27efee[_0x13e065(0x212)]);if(!_0x26b678)throw new Error('Invalid\x20KLYME\x20gateway:\x20'+_0x27efee[_0x13e065(0x212)]);console[_0x13e065(0x222)](_0x13e065(0x201)+_0x26b678+_0x13e065(0x271)+_0x875c9e+_0x13e065(0x22f)),console[_0x13e065(0x222)](_0x13e065(0x236)+_0x41ef9a+'\x20'+_0x27efee[_0x13e065(0x17f)]+_0x13e065(0x1a0)+_0x26b678+')');const _0x2ed2e2=await this['klymeService'][_0x13e065(0x17d)]({'paymentId':_0x2d8d54['id'],'orderId':_0x875c9e,'amount':_0x41ef9a,'currency':_0x27efee[_0x13e065(0x17f)],'region':_0x26b678,'redirectUrl':_0x26d428});_0x54c977=_0x2ed2e2[_0x13e065(0x251)],_0x281788=_0x2ed2e2[_0x13e065(0x235)],await database_1[_0x13e065(0x184)][_0x13e065(0x185)]['update']({'where':{'id':_0x2d8d54['id']},'data':{'externalPaymentUrl':_0x281788,'gatewayPaymentId':_0x54c977}});const _0x3ebc7e=_0x13e065(0x22b)+_0x2d8d54['id'];return console[_0x13e065(0x222)](_0x13e065(0x182)+_0x26b678+_0x13e065(0x1af)+_0x875c9e),console[_0x13e065(0x222)](_0x13e065(0x239)+_0x26b678+'\x20payment\x20URL:\x20'+_0x3ebc7e),{'paymentId':_0x2d8d54['id'],'paymentUrl':_0x3ebc7e,'expiresAt':_0x2d8d54[_0x13e065(0x17e)]||undefined};}else{if(_0x27efee['gateway']===_0x13e065(0x1a4)){console[_0x13e065(0x222)]('🧪\x20Creating\x20Test\x20Gateway\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x875c9e+_0x13e065(0x22f)),console[_0x13e065(0x222)](_0x13e065(0x236)+_0x41ef9a+'\x20'+_0x27efee[_0x13e065(0x17f)]+_0x13e065(0x23a));const _0x13eba4=_0x13e065(0x195)+_0x2d8d54['id'];await database_1[_0x13e065(0x184)]['payment'][_0x13e065(0x176)]({'where':{'id':_0x2d8d54['id']},'data':{'externalPaymentUrl':_0x13eba4,'gatewayPaymentId':'test_'+_0x875c9e}});const _0x15dce7='https://apptest.trapay.uk/payment/'+_0x2d8d54['id'];return console[_0x13e065(0x222)](_0x13e065(0x244)+_0x15dce7),console['log']('🧪\x20Test\x20Gateway\x20form\x20URL:\x20'+_0x13eba4),{'paymentId':_0x2d8d54['id'],'paymentUrl':_0x15dce7,'expiresAt':_0x2d8d54[_0x13e065(0x17e)]||undefined};}else{if(_0x27efee[_0x13e065(0x212)]===_0x13e065(0x1b1)){console[_0x13e065(0x222)](_0x13e065(0x216)+_0x875c9e+_0x13e065(0x22f)),console[_0x13e065(0x222)](_0x13e065(0x236)+_0x41ef9a+'\x20'+_0x27efee[_0x13e065(0x17f)]+_0x13e065(0x1b0));const _0x279e9e=_0x13e065(0x22b)+_0x2d8d54['id'];await database_1[_0x13e065(0x184)][_0x13e065(0x185)][_0x13e065(0x176)]({'where':{'id':_0x2d8d54['id']},'data':{'externalPaymentUrl':_0x279e9e,'gatewayPaymentId':_0x13e065(0x22c)+_0x875c9e,'paymentMethod':_0x13e065(0x1b1)}});const _0x141c87=_0x13e065(0x22b)+_0x2d8d54['id'];return console[_0x13e065(0x222)]('🔗\x20MasterCard\x20payment\x20URL:\x20'+_0x141c87),console[_0x13e065(0x222)](_0x13e065(0x1f5)+_0x279e9e),{'paymentId':_0x2d8d54['id'],'paymentUrl':_0x141c87,'expiresAt':_0x2d8d54['expiresAt']||undefined};}else throw new Error(_0x13e065(0x249)+_0x27efee[_0x13e065(0x212)]);}}}}}}}catch(_0x10d8d9){await database_1['default'][_0x13e065(0x185)][_0x13e065(0x176)]({'where':{'id':_0x2d8d54['id']},'data':{'status':_0x13e065(0x1eb)}});throw new Error(_0x13e065(0x1d2)+(_0x10d8d9 instanceof Error?_0x10d8d9['message']:_0x13e065(0x242)));}}async['handleSuccessfulPayment'](_0x1e99ea){const _0x1cda79=a49_0x5c5a70;console[_0x1cda79(0x222)](_0x1cda79(0x233)+_0x1e99ea);const _0x26120c=await database_1[_0x1cda79(0x184)][_0x1cda79(0x185)]['findUnique']({'where':{'id':_0x1e99ea},'include':{'paymentLink':!![]}});if(!_0x26120c||!_0x26120c['paymentLink']){console[_0x1cda79(0x222)]('📈\x20Payment\x20'+_0x1e99ea+_0x1cda79(0x1b2));return;}if(_0x26120c[_0x1cda79(0x17a)]!==_0x1cda79(0x1fe)){console[_0x1cda79(0x222)]('📈\x20Payment\x20'+_0x1e99ea+_0x1cda79(0x1c4)+_0x26120c['status']+_0x1cda79(0x198));return;}if(!_0x26120c[_0x1cda79(0x209)]){console[_0x1cda79(0x222)](_0x1cda79(0x218)+_0x1e99ea+_0x1cda79(0x1c7));return;}try{const _0x5f4597=await database_1[_0x1cda79(0x184)][_0x1cda79(0x1bd)](async _0x4ab2a3=>{const _0x37be0b=_0x1cda79,_0x4fdd93=await _0x4ab2a3[_0x37be0b(0x23f)]['findUnique']({'where':{'id':_0x26120c['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(!_0x4fdd93)throw new Error(_0x37be0b(0x1e4)+_0x26120c[_0x37be0b(0x175)]+_0x37be0b(0x24d));if(_0x4fdd93[_0x37be0b(0x1d9)]===_0x37be0b(0x21e)&&_0x4fdd93['currentPayments']>=0x1)return console[_0x37be0b(0x222)](_0x37be0b(0x1f0)+_0x26120c[_0x37be0b(0x175)]+'\x20already\x20used\x20('+_0x4fdd93[_0x37be0b(0x1ca)]+_0x37be0b(0x20a)),_0x4fdd93;const _0x3e7924=await _0x4ab2a3[_0x37be0b(0x185)]['count']({'where':{'paymentLinkId':_0x26120c[_0x37be0b(0x175)],'status':_0x37be0b(0x1fe),'paidAt':{'not':null},'id':{'not':_0x1e99ea}}}),_0x187ac4=_0x3e7924+0x1,_0x17d25f=_0x4fdd93[_0x37be0b(0x1d9)]===_0x37be0b(0x21e)&&_0x187ac4>=0x1?_0x37be0b(0x1ab):_0x4fdd93[_0x37be0b(0x17a)],_0x4eca6d=await _0x4ab2a3[_0x37be0b(0x23f)]['update']({'where':{'id':_0x26120c[_0x37be0b(0x175)]},'data':{'currentPayments':_0x187ac4,'status':_0x17d25f}});return console[_0x37be0b(0x222)]('📈\x20Payment\x20link\x20'+_0x26120c[_0x37be0b(0x175)]+'\x20('+_0x4fdd93[_0x37be0b(0x1d9)]+_0x37be0b(0x1cb)+_0x4fdd93['currentPayments']+_0x37be0b(0x274)+_0x187ac4),_0x4eca6d;});if(_0x5f4597['status']===_0x1cda79(0x1ab)){const _0x356b1b=_0x5f4597[_0x1cda79(0x1d9)]===_0x1cda79(0x21e)?_0x1cda79(0x241):_0x1cda79(0x226);console[_0x1cda79(0x222)]('🏁\x20Payment\x20link\x20'+_0x26120c[_0x1cda79(0x175)]+'\x20completed\x20('+_0x356b1b+_0x1cda79(0x1ce)+_0x5f4597[_0x1cda79(0x1ca)]+_0x1cda79(0x273));}}catch(_0x1756a9){console['error'](_0x1cda79(0x26a)+_0x1e99ea+':',_0x1756a9);}}async[a49_0x5c5a70(0x1c1)](_0x522a75){const _0x51700d=a49_0x5c5a70,[_0x141819,_0x23bf96,_0x18398d,_0x370a2e]=await Promise['all']([database_1[_0x51700d(0x184)][_0x51700d(0x23f)]['count']({'where':{'shopId':_0x522a75}}),database_1[_0x51700d(0x184)]['paymentLink']['count']({'where':{'shopId':_0x522a75,'status':_0x51700d(0x204)}}),database_1[_0x51700d(0x184)][_0x51700d(0x185)][_0x51700d(0x231)]({'where':{'shopId':_0x522a75,'paymentLinkId':{'not':null},'gateway':{'not':_0x51700d(0x1a4)}}}),database_1['default'][_0x51700d(0x185)][_0x51700d(0x26e)]({'where':{'shopId':_0x522a75,'paymentLinkId':{'not':null},'status':'PAID','gateway':{'not':_0x51700d(0x1a4)}},'select':{'amount':!![],'currency':!![]}})]);let _0x39c2d0=0x0;for(const _0x1bdb7b of _0x370a2e){const _0x9c0486=await currencyService_1[_0x51700d(0x1f4)]['convertToUSDT'](_0x1bdb7b['amount'],_0x1bdb7b[_0x51700d(0x17f)]);_0x39c2d0+=_0x9c0486;}const _0x5529aa=_0x18398d>0x0?_0x370a2e['length']/_0x18398d*0x64:0x0;return{'totalLinks':_0x141819,'activeLinks':_0x23bf96,'totalPayments':_0x18398d,'totalRevenue':Math[_0x51700d(0x217)](_0x39c2d0*0x64)/0x64,'conversionRate':Math[_0x51700d(0x217)](_0x5529aa*0x64)/0x64};}[a49_0x5c5a70(0x1f8)](_0x188f52){const _0xa8851a=a49_0x5c5a70;return{'id':_0x188f52['id'],'shopId':_0x188f52[_0xa8851a(0x272)],'amount':_0x188f52['amount'],'currency':_0x188f52[_0xa8851a(0x17f)],'sourceCurrency':_0x188f52['sourceCurrency']||undefined,'gateway':_0x188f52[_0xa8851a(0x212)],'type':_0x188f52[_0xa8851a(0x1d9)],'currentPayments':_0x188f52[_0xa8851a(0x1ca)],'status':_0x188f52[_0xa8851a(0x17a)],'expiresAt':_0x188f52[_0xa8851a(0x17e)]||undefined,'successUrl':_0x188f52['successUrl']||undefined,'failUrl':_0x188f52['failUrl']||undefined,'pendingUrl':_0x188f52[_0xa8851a(0x1cc)]||undefined,'country':_0x188f52[_0xa8851a(0x1aa)]||undefined,'language':_0x188f52[_0xa8851a(0x189)]||undefined,'linkUrl':_0xa8851a(0x1b8)+_0x188f52['id'],'createdAt':_0x188f52[_0xa8851a(0x21a)],'updatedAt':_0x188f52[_0xa8851a(0x1e7)],'shop':_0x188f52[_0xa8851a(0x1ff)],'payments':_0x188f52['payments']};}}exports[a49_0x5c5a70(0x228)]=PaymentLinkService;