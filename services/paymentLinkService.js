'use strict';const a52_0x33f4ee=a52_0x3772;function a52_0x1349(){const _0x5e397d=['country','updatedAt','\x20not\x20found','Payment\x20','\x20status\x20calculation:','💱\x20Converted\x20','📈\x20Single\x20payment\x20link\x20','sourceCurrency','🔗\x20Creating\x20','📈\x20Payment\x20','Invalid\x20KLYME\x20gateway:\x20','ceil','name','EXPIRED','defineProperty','paymentLink','USD','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','toLowerCase','env','none','coinToPayStatusService','ACTIVE','generateGatewayUrls','✅\x20Amount\x20','\x20with\x20payment\x20ID\x20','\x20\x20\x20-\x20Database\x20status:\x20','https://app.trapay.uk/payment/success?id=','951270QdscHj','\x20\x20\x20-\x20Effective\x20status:\x20','https://app.trapay.uk/payment/','📈\x20Current\x20payment\x20link\x20state:','Invalid\x20gateway\x20ID:\x20','createPayment','amerService','🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','\x20to\x20','status','cointopay','🔗\x20KLYME\x20','\x20USDT','Please\x20reduce\x20the\x20amount.','\x20enabled\x20gateways\x20(internal):','\x20link\x20','createdAt','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','\x20(8digits-8digits\x20format\x20for\x20','\x20(MasterCard)','💰\x20Checking\x20amount\x20limits\x20for\x20shop\x20','\x20->\x20','temp','2881438QqYVpV','findUnique','Gateway\x20not\x20found\x20for\x20ID:\x20','13QALzAV','/gateway/fail.php?id=','cointopay2','insensitive','validateKlymeCurrency','amer_','Amer',',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','formatPaymentLinkResponse','error','convertToUSDT','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','rapydService','getGatewayNameById','__importDefault','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update','qr_code_url','💳\x20MasterCard\x20form\x20URL:\x20','getGatewayDisplayName','checkAmountLimits','\x20USDT\x20meets\x20maximum\x20requirement\x20of\x20','minAmount','CoinToPay','\x20minimum\x20amount:\x20','💾\x20DB\x20Success\x20URL:\x20','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','KLYME\x20EU','\x20(domain:\x20','1146610fTFPUF','/gateway/success.php?id=','currentPayments','✅\x20KLYME\x20','\x20payments)','username','📝\x20Note:\x20Success/Fail/Pending\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created','no\x20email','🔗\x20No\x20whiteUrl\x20for\x20','\x20\x20\x20🌐\x20Gateway\x20Pending\x20URL:\x20','🔗\x20Plisio\x20payment\x20URL:\x20','mastercard','CoinToPayService','$transaction','paymentGateways','\x20using\x20default\x20gateways:','single-use','📈\x20Updating\x20payment\x20link\x20','create','\x20already\x20used\x20(','\x20\x20\x20🔗\x20White\x20URL:\x20','This\x20single-use\x20payment\x20link\x20has\x20already\x20been\x20used','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','payment_url','test_','/gateway/payment.php?id=','\x20link\x20with\x20','findMany','💰\x20No\x20minimum\x20amount\x20set\x20for\x20gateway\x20','Noda','https://app.trapay.uk/payment/pending?id=','gateway','6NDGNkj','6MIrWfS','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE),\x201111\x20(MasterCard),\x201110\x20(Amer)','/gateway/pending.php?id=','payment','💳\x20Creating\x20MasterCard\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','log','Test\x20Gateway','PAID','createPaymentLink','Anonymous','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','floor','count','🔗\x20CoinToPay2\x20(Open\x20Banking\x202)\x20payment\x20URL:\x20','getPaymentLinkStatistics','\x20(Amer)','./gateways/klymeService','Shop\x20is\x20not\x20active','3600513nkyZHP','toUpperCase','🏁\x20Payment\x20link\x20','email','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','🔗\x20Noda\x20payment\x20URL:\x20','join','BASE_URL','PaymentLinkService','\x20USDT\x20is\x20below\x20minimum\x20','amount\x20is\x20required\x20and\x20must\x20be\x20positive','Plisio','append','message','nodaService','❌\x20Amount\x20','SINGLE','successUrl','test_gateway','💳\x20Creating\x20Amer\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','currency','https://app.trapay.uk/payment/fail?id=','MasterCard','maxAmount','🎯\x20Generated\x20gateway\x20order_id:\x20','klyme_','\x20\x20\x20-\x20Is\x20completed:\x20','❌\x20Gateway\x20\x22','KLYME\x20DE','8SIskiW','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','gateway_payment_id','rapyd','🔐\x20Checking\x20if\x20\x22','🧪\x20Creating\x20Test\x20Gateway\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','\x20(8digits-8digits\x20format)','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20','KLYME\x20GB',',\x20gateway\x20','round','delete','PENDING','Unsupported\x20KLYME\x20region:\x20','🔗\x20Public\x20link\x20','toFixed','📈\x20All\x20conditions\x20met\x20for\x20payment\x20','🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','📧\x20URL\x20параметры:','\x22\x20is\x20allowed\x20for\x20shop\x20','\x20USDT\x20exceeds\x20maximum\x20','plisio','\x20USDT)\x20exceeds\x20the\x20maximum\x20allowed\x20amount\x20of\x20','getPublicPaymentLinkData','parse','../types/gateway','Payment\x20amount\x20','./gateways/rapydService','38723NSMxeB','type','\x20payments),\x20skipping\x20increment','\x20(validated\x20for\x20','\x20USDT\x20for\x20limit\x20checking','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','NodaService','Open\x20Banking\x202','length','\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20','RapydService','./gateways/nodaService','Payment\x20link\x20not\x20found','paidAt','549501levZNW','💰\x20Amount:\x20','update','language','Payment\x20not\x20found','Shop\x20not\x20found','./gateways/amerService','💰\x20Fixed\x20amount:\x20','map','💰\x20Shop\x20','4fukkyq','💰\x20Checking\x20amount\x20limits\x20for\x20gateway:\x20','desc','toISOString','coinToPayService','COMPLETED','__esModule','PlisioService','checkGatewayPermission','noda','./coinToPayStatusService','qr_code','gatewaySettings','💳\x20Initiating\x20payment\x20from\x20','includes','\x20gateway.\x20','amount','https://','KlymeService','🔗\x20Link\x20type:\x20','\x20(Plisio\x20or\x20KLYME)','./gateways/coinToPay2Service','AmerService','Payment\x20link\x20has\x20expired',')\x20counter\x20updated:\x20','👤\x20Customer:\x20','toString','💳\x20Creating\x20KLYME\x20','ONCE','33PaMtlK','schedulePaymentChecks','\x20\x20\x20-\x20Type:\x20','paymentLinkId','🔗\x20CoinToPay\x20payment\x20URL:\x20','./gateways/coinToPayService','all','&payment_id=','failUrl','getPaymentLinkById','\x22\x20is\x20in\x20enabled\x20gateways:','\x20USDT\x20for\x20','isValidGatewayId',',\x20proceeding\x20with\x20payment\x20link\x20counter\x20update','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20','Please\x20increase\x20the\x20amount.','🔗\x20Amer\x20payment\x20URL:\x20','🧪\x20Test\x20Gateway\x20form\x20URL:\x20','startsWith','\x20maximum\x20amount:\x20','Enabled\x20gateways:\x20','generateGatewayOrderId','plisioService','mc_','✅\x20Gateway\x20\x22','💾\x20DB\x20Pending\x20URL:\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','pendingUrl','klymeService','\x20payment\x20link','payments','expiresAt','Error\x20parsing\x20payment\x20gateways:','💰\x20Gateway\x20','💰\x20Plisio\x20payment\x20link\x20mapping:','initiatePaymentFromLink','CoinToPay2Service','\x20completed\x20(','Unknown\x20error','✅\x20Payment\x20link\x20created:\x20','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','payment_id','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','🪙\x20Creating\x20CoinToPay2\x20(Open\x20Banking\x202)\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','shop','🔐\x20Shop\x20','shopId','getKlymeRegionFromGatewayName','📈\x20handleSuccessfulPayment\x20called\x20for\x20payment:\x20','🔗\x20Test\x20Gateway\x20payment\x20URL:\x20','\x20USDT\x20meets\x20minimum\x20requirement\x20of\x20','https://api2.trapay.uk/payment.php?','default','\x20gateway\x20settings:','Rapyd','Payment\x20link\x20has\x20reached\x20maximum\x20payments','EUR','./gateways/plisioService','\x20\x20\x20-\x20Current\x20payments:\x20','💾\x20Payment\x20created:\x20','\x20\x20\x20💾\x20DB\x20Pending\x20URL:\x20','10482876CCdYJq','random','https://app.trapay.uk/link/','currencyService','GBP','\x20USDT\x20for\x20gateway\x20','https://tesoft.uk/gateways/noda/webhook'];a52_0x1349=function(){return _0x5e397d;};return a52_0x1349();}function a52_0x3772(_0x29cf7d,_0x3fbd32){const _0x13497=a52_0x1349();return a52_0x3772=function(_0x37728f,_0x3dc451){_0x37728f=_0x37728f-0x65;let _0x586c8c=_0x13497[_0x37728f];return _0x586c8c;},a52_0x3772(_0x29cf7d,_0x3fbd32);}(function(_0x3cbe37,_0x4267e7){const _0x3b5ace=a52_0x3772,_0x565d7d=_0x3cbe37();while(!![]){try{const _0x2fdd26=-parseInt(_0x3b5ace(0x93))/0x1*(-parseInt(_0x3b5ace(0x17f))/0x2)+-parseInt(_0x3b5ace(0xa1))/0x3*(parseInt(_0x3b5ace(0xab))/0x4)+-parseInt(_0x3b5ace(0x128))/0x5+-parseInt(_0x3b5ace(0x180))/0x6*(-parseInt(_0x3b5ace(0x13f))/0x7)+parseInt(_0x3b5ace(0x77))/0x8*(-parseInt(_0x3b5ace(0x192))/0x9)+parseInt(_0x3b5ace(0x15f))/0xa*(-parseInt(_0x3b5ace(0xc8))/0xb)+parseInt(_0x3b5ace(0x105))/0xc*(parseInt(_0x3b5ace(0x142))/0xd);if(_0x2fdd26===_0x4267e7)break;else _0x565d7d['push'](_0x565d7d['shift']());}catch(_0x2b8007){_0x565d7d['push'](_0x565d7d['shift']());}}}(a52_0x1349,0x4550b));var __importDefault=this&&this[a52_0x33f4ee(0x151)]||function(_0x352b06){const _0x37aae8=a52_0x33f4ee;return _0x352b06&&_0x352b06[_0x37aae8(0xb1)]?_0x352b06:{'default':_0x352b06};};Object[a52_0x33f4ee(0x11a)](exports,a52_0x33f4ee(0xb1),{'value':!![]}),exports[a52_0x33f4ee(0x19a)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a52_0x33f4ee(0x101)),rapydService_1=require(a52_0x33f4ee(0x92)),nodaService_1=require(a52_0x33f4ee(0x9e)),coinToPayService_1=require(a52_0x33f4ee(0xcd)),coinToPay2Service_1=require(a52_0x33f4ee(0xc0)),klymeService_1=require(a52_0x33f4ee(0x190)),amerService_1=require(a52_0x33f4ee(0xa7)),coinToPayStatusService_1=require(a52_0x33f4ee(0xb5)),gateway_1=require(a52_0x33f4ee(0x90)),currencyService_1=require('./currencyService');class PaymentLinkService{constructor(){const _0x107b25=a52_0x33f4ee;this[_0x107b25(0xde)]=new plisioService_1[(_0x107b25(0xb2))](),this[_0x107b25(0x14f)]=new rapydService_1[(_0x107b25(0x9d))](),this[_0x107b25(0x68)]=new nodaService_1[(_0x107b25(0x99))](),this[_0x107b25(0xaf)]=new coinToPayService_1[(_0x107b25(0x16b))](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x107b25(0xec))](),this[_0x107b25(0xe4)]=new klymeService_1[(_0x107b25(0xbd))](),this[_0x107b25(0x12e)]=new amerService_1[(_0x107b25(0xc1))]();}['generateGatewayOrderId'](){const _0x1def63=()=>{const _0x22a298=a52_0x3772;return Math[_0x22a298(0x18b)](Math[_0x22a298(0x106)]()*0x5f5e100)[_0x22a298(0xc5)]()['padStart'](0x8,'0');};return _0x1def63()+'-'+_0x1def63();}['generateGatewayUrls'](_0x21c304,_0x43c6ed,_0x277b93,_0x20ddd0,_0x5943e1,_0x25f2aa,_0x3ff98d){const _0x3a5390=a52_0x33f4ee;if(_0x5943e1&&_0x25f2aa&&_0x3ff98d)return{'finalSuccessUrl':_0x5943e1,'finalFailUrl':_0x25f2aa,'finalPendingUrl':_0x3ff98d,'dbSuccessUrl':_0x5943e1,'dbFailUrl':_0x25f2aa,'dbPendingUrl':_0x3ff98d,'whiteUrl':null};const _0x29d3a1=_0x5943e1||_0x3a5390(0x127)+_0x43c6ed+_0x3a5390(0xcf)+_0x277b93,_0x50a0d0=_0x25f2aa||_0x3a5390(0x6f)+_0x43c6ed+_0x3a5390(0xcf)+_0x277b93,_0x2906b2=_0x3ff98d||_0x3a5390(0x17d)+_0x43c6ed+_0x3a5390(0xcf)+_0x277b93;let _0x2dcda2,_0x38141a,_0x457347;_0x21c304===_0x3a5390(0xb4)||_0x21c304[_0x3a5390(0xda)](_0x3a5390(0x73))||_0x21c304===_0x3a5390(0x132)||_0x21c304===_0x3a5390(0x144)?(_0x2dcda2=_0x20ddd0+_0x3a5390(0x182)+_0x43c6ed,_0x457347=_0x20ddd0+_0x3a5390(0x182)+_0x43c6ed):(_0x2dcda2=_0x20ddd0+_0x3a5390(0x160)+_0x43c6ed,_0x457347=_0x20ddd0+'/gateway/pending.php?id='+_0x43c6ed);_0x38141a=_0x20ddd0+_0x3a5390(0x143)+_0x43c6ed;let _0x3af6f4=null;if(_0x21c304!==_0x3a5390(0x8c)&&!_0x21c304[_0x3a5390(0xda)]('klyme_')){const _0x20ae9e=_0x21c304===_0x3a5390(0x144)?'traffer.uk':'tesoft.uk';_0x3af6f4=_0x3a5390(0xbc)+_0x20ae9e+_0x3a5390(0x178)+_0x43c6ed,console[_0x3a5390(0x185)]('🔗\x20Generated\x20whiteUrl\x20for\x20'+_0x21c304+':\x20'+_0x3af6f4+_0x3a5390(0x15e)+_0x20ae9e+')');}else console['log'](_0x3a5390(0x167)+_0x21c304+_0x3a5390(0xbf));return console[_0x3a5390(0x185)]('🔗\x20Generated\x20URLs\x20for\x20'+_0x21c304+_0x3a5390(0x125)+_0x43c6ed+':'),console[_0x3a5390(0x185)](_0x3a5390(0x78)+_0x2dcda2),console[_0x3a5390(0x185)](_0x3a5390(0x18a)+_0x38141a),console[_0x3a5390(0x185)](_0x3a5390(0x168)+_0x457347),console[_0x3a5390(0x185)](_0x3a5390(0x98)+_0x29d3a1),console['log']('\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20'+_0x50a0d0),console[_0x3a5390(0x185)](_0x3a5390(0x104)+_0x2906b2),console['log'](_0x3a5390(0x173)+(_0x3af6f4||_0x3a5390(0x120))),{'finalSuccessUrl':_0x2dcda2,'finalFailUrl':_0x38141a,'finalPendingUrl':_0x457347,'dbSuccessUrl':_0x29d3a1,'dbFailUrl':_0x50a0d0,'dbPendingUrl':_0x2906b2,'whiteUrl':_0x3af6f4};}['validateKlymeCurrency'](_0x2c98f4,_0x552c46){const _0x2cf686=a52_0x33f4ee;if(!_0x2c98f4[_0x2cf686(0xda)]('klyme_'))return;const _0x37f546=(0x0,gateway_1[_0x2cf686(0xf7)])(_0x2c98f4),_0x8af294=_0x552c46[_0x2cf686(0x193)]();switch(_0x37f546){case'EU':if(_0x8af294!==_0x2cf686(0x100))throw new Error(_0x2cf686(0xe2)+_0x8af294);break;case'GB':if(_0x8af294!==_0x2cf686(0x109))throw new Error(_0x2cf686(0x15c)+_0x8af294);break;case'DE':if(_0x8af294!=='EUR')throw new Error(_0x2cf686(0xf2)+_0x8af294);break;default:throw new Error(_0x2cf686(0x84)+_0x37f546);}}async['checkAmountLimits'](_0x3eb140,_0x58efff,_0x187191,_0x1b3492){const _0x38d2d0=a52_0x33f4ee;console[_0x38d2d0(0x185)](_0x38d2d0(0x13c)+_0x3eb140+_0x38d2d0(0x80)+_0x58efff+',\x20amount:\x20'+_0x187191+'\x20'+_0x1b3492);const _0x3872ca=await currencyService_1[_0x38d2d0(0x108)]['convertToUSDT'](_0x187191,_0x1b3492);console[_0x38d2d0(0x185)](_0x38d2d0(0x111)+_0x187191+'\x20'+_0x1b3492+_0x38d2d0(0x130)+_0x3872ca[_0x38d2d0(0x86)](0x6)+_0x38d2d0(0x97));const _0x2301c9=await database_1[_0x38d2d0(0xfc)]['shop'][_0x38d2d0(0x140)]({'where':{'id':_0x3eb140},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x2301c9)throw new Error(_0x38d2d0(0xa6));let _0x1b77a2={};if(_0x2301c9[_0x38d2d0(0xb7)])try{_0x1b77a2=JSON[_0x38d2d0(0x8f)](_0x2301c9[_0x38d2d0(0xb7)]),console[_0x38d2d0(0x185)](_0x38d2d0(0xaa)+_0x2301c9[_0x38d2d0(0x164)]+_0x38d2d0(0xfd),_0x1b77a2);}catch(_0x1eb492){console[_0x38d2d0(0x14c)]('Error\x20parsing\x20gateway\x20settings:',_0x1eb492),_0x1b77a2={};}const _0x3f4e48=this[_0x38d2d0(0x155)](_0x58efff);console[_0x38d2d0(0x185)](_0x38d2d0(0xac)+_0x58efff+_0x38d2d0(0x13d)+_0x3f4e48);const _0x5ac183=_0x1b77a2[_0x3f4e48];if(_0x5ac183&&_0x5ac183[_0x38d2d0(0x158)]!==undefined){const _0x2d582e=_0x5ac183[_0x38d2d0(0x158)];console['log'](_0x38d2d0(0xe9)+_0x3f4e48+_0x38d2d0(0x15a)+_0x2d582e+_0x38d2d0(0x134));if(_0x3872ca<_0x2d582e){console['error'](_0x38d2d0(0x69)+_0x3872ca['toFixed'](0x6)+_0x38d2d0(0x19b)+_0x2d582e+_0x38d2d0(0x10a)+_0x3f4e48);throw new Error(_0x38d2d0(0x91)+_0x187191+'\x20'+_0x1b3492+'\x20('+_0x3872ca[_0x38d2d0(0x86)](0x2)+'\x20USDT)\x20is\x20below\x20the\x20minimum\x20required\x20amount\x20of\x20'+_0x2d582e+_0x38d2d0(0xd3)+_0x3f4e48+_0x38d2d0(0xba)+_0x38d2d0(0xd7));}console['log'](_0x38d2d0(0x124)+_0x3872ca['toFixed'](0x6)+_0x38d2d0(0xfa)+_0x2d582e+'\x20USDT\x20for\x20gateway\x20'+_0x3f4e48);}else console[_0x38d2d0(0x185)](_0x38d2d0(0x17b)+_0x3f4e48);if(_0x5ac183&&_0x5ac183['maxAmount']!==undefined){const _0x9e9ba=_0x5ac183[_0x38d2d0(0x71)];console['log'](_0x38d2d0(0xe9)+_0x3f4e48+_0x38d2d0(0xdb)+_0x9e9ba+_0x38d2d0(0x134));if(_0x3872ca>_0x9e9ba){console[_0x38d2d0(0x14c)](_0x38d2d0(0x69)+_0x3872ca[_0x38d2d0(0x86)](0x6)+_0x38d2d0(0x8b)+_0x9e9ba+_0x38d2d0(0x10a)+_0x3f4e48);throw new Error('Payment\x20amount\x20'+_0x187191+'\x20'+_0x1b3492+'\x20('+_0x3872ca['toFixed'](0x2)+_0x38d2d0(0x8d)+_0x9e9ba+'\x20USDT\x20for\x20'+_0x3f4e48+_0x38d2d0(0xba)+_0x38d2d0(0x135));}console[_0x38d2d0(0x185)](_0x38d2d0(0x124)+_0x3872ca['toFixed'](0x6)+_0x38d2d0(0x157)+_0x9e9ba+'\x20USDT\x20for\x20gateway\x20'+_0x3f4e48);}else console[_0x38d2d0(0x185)]('💰\x20No\x20maximum\x20amount\x20set\x20for\x20gateway\x20'+_0x3f4e48);}async[a52_0x33f4ee(0xb3)](_0x467d6e,_0x470ac5){const _0x874bb5=a52_0x33f4ee;console['log']('🔐\x20Checking\x20gateway\x20permission\x20for\x20shop\x20'+_0x467d6e+':\x20'+_0x470ac5);const _0x8db057=await database_1[_0x874bb5(0xfc)][_0x874bb5(0xf4)][_0x874bb5(0x140)]({'where':{'id':_0x467d6e},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x8db057)throw new Error(_0x874bb5(0xa6));let _0x11a34b=[];if(_0x8db057[_0x874bb5(0x16d)])try{const _0x3814fe=JSON[_0x874bb5(0x8f)](_0x8db057[_0x874bb5(0x16d)]);_0x11a34b=_0x3814fe[_0x874bb5(0xa9)](_0x5d4514=>this[_0x874bb5(0x155)](_0x5d4514)),console[_0x874bb5(0x185)](_0x874bb5(0xf5)+_0x8db057[_0x874bb5(0x164)]+_0x874bb5(0x136),_0x3814fe),console['log'](_0x874bb5(0xf5)+_0x8db057['username']+'\x20enabled\x20gateways\x20(display):',_0x11a34b);}catch(_0x585586){console['error'](_0x874bb5(0xe8),_0x585586),_0x11a34b=['Plisio'];}else _0x11a34b=['Plisio'],console[_0x874bb5(0x185)](_0x874bb5(0xf5)+_0x8db057[_0x874bb5(0x164)]+_0x874bb5(0x16e),_0x11a34b);const _0x598faa=this[_0x874bb5(0x155)](_0x470ac5);console[_0x874bb5(0x185)](_0x874bb5(0x7b)+_0x598faa+_0x874bb5(0xd2),_0x11a34b);if(!_0x11a34b[_0x874bb5(0xb9)](_0x598faa)){console['error'](_0x874bb5(0x75)+_0x598faa+'\x22\x20not\x20allowed\x20for\x20shop\x20'+_0x8db057['username']),console[_0x874bb5(0x14c)]('❌\x20Enabled\x20gateways:\x20'+_0x11a34b[_0x874bb5(0x198)](',\x20'));throw new Error('Gateway\x20\x22'+_0x598faa+_0x874bb5(0x14a)+(_0x874bb5(0xdc)+_0x11a34b['join'](',\x20')+'.\x20')+'Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.');}console['log'](_0x874bb5(0xe0)+_0x598faa+_0x874bb5(0x8a)+_0x8db057['username']);}[a52_0x33f4ee(0x155)](_0x55e28c){const _0x5f5ade=a52_0x33f4ee,_0x2d10b7={'test_gateway':_0x5f5ade(0x186),'plisio':_0x5f5ade(0x65),'rapyd':_0x5f5ade(0xfe),'noda':_0x5f5ade(0x17c),'cointopay':_0x5f5ade(0x159),'cointopay2':_0x5f5ade(0x9a),'klyme_eu':_0x5f5ade(0x15d),'klyme_gb':_0x5f5ade(0x7f),'klyme_de':_0x5f5ade(0x76),'mastercard':_0x5f5ade(0x70),'amer':_0x5f5ade(0x148)};return _0x2d10b7[_0x55e28c]||_0x55e28c;}async['createPaymentLink'](_0x2b8190,_0x5bdd84){const _0x20b1c6=a52_0x33f4ee;if(!(0x0,gateway_1['isValidGatewayId'])(_0x5bdd84[_0x20b1c6(0x17e)]))throw new Error(_0x20b1c6(0x12c)+_0x5bdd84['gateway']+_0x20b1c6(0x181));const _0x2e9b90=(0x0,gateway_1[_0x20b1c6(0x150)])(_0x5bdd84[_0x20b1c6(0x17e)]);if(!_0x2e9b90)throw new Error(_0x20b1c6(0x141)+_0x5bdd84[_0x20b1c6(0x17e)]);console[_0x20b1c6(0x185)](_0x20b1c6(0x12f)+_0x2e9b90),await this['checkGatewayPermission'](_0x2b8190,_0x2e9b90);if(_0x2e9b90===_0x20b1c6(0x8c)&&!_0x5bdd84['sourceCurrency'])throw new Error(_0x20b1c6(0x14e));if(_0x2e9b90['startsWith'](_0x20b1c6(0x73))){const _0x298dee=(0x0,gateway_1[_0x20b1c6(0xf7)])(_0x2e9b90);console[_0x20b1c6(0x185)](_0x20b1c6(0xc6)+_0x298dee+_0x20b1c6(0xe5));}let _0x2719e2=_0x5bdd84['country'];_0x2e9b90==='rapyd'&&(_0x2719e2='GB',console[_0x20b1c6(0x185)](_0x20b1c6(0x175)));if(!_0x5bdd84[_0x20b1c6(0xbb)]||_0x5bdd84['amount']<=0x0)throw new Error(_0x20b1c6(0x19c));let _0x42a40a=_0x5bdd84[_0x20b1c6(0x6e)]||'USD';(_0x2e9b90===_0x20b1c6(0x132)||_0x2e9b90==='cointopay2')&&(_0x42a40a=_0x20b1c6(0x100),console['log']('🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20'+_0x2e9b90+_0x20b1c6(0xe5)));this[_0x20b1c6(0x146)](_0x2e9b90,_0x42a40a),await this[_0x20b1c6(0x156)](_0x2b8190,_0x2e9b90,_0x5bdd84[_0x20b1c6(0xbb)],_0x42a40a);const _0x38bf66=_0x5bdd84[_0x20b1c6(0x94)]||_0x20b1c6(0x6a);console[_0x20b1c6(0x185)](_0x20b1c6(0x114)+_0x38bf66+'\x20payment\x20link');const _0x3a0db3=await database_1['default'][_0x20b1c6(0x11b)][_0x20b1c6(0x171)]({'data':{'shopId':_0x2b8190,'amount':_0x5bdd84[_0x20b1c6(0xbb)],'currency':_0x42a40a,'sourceCurrency':_0x5bdd84[_0x20b1c6(0x113)]||undefined,'gateway':_0x2e9b90,'type':_0x38bf66,'currentPayments':0x0,'status':'ACTIVE','expiresAt':_0x5bdd84['expiresAt']?new Date(_0x5bdd84['expiresAt']):undefined,'successUrl':_0x5bdd84[_0x20b1c6(0x6b)]||null,'failUrl':_0x5bdd84[_0x20b1c6(0xd0)]||null,'pendingUrl':_0x5bdd84['pendingUrl']||null,'country':_0x2719e2,'language':_0x5bdd84['language']||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x20b1c6(0x185)](_0x20b1c6(0xef)+_0x3a0db3['id']+'\x20('+_0x2e9b90+')'),console[_0x20b1c6(0x185)](_0x20b1c6(0xa8)+_0x3a0db3[_0x20b1c6(0xbb)]+'\x20'+_0x3a0db3[_0x20b1c6(0x6e)]),console[_0x20b1c6(0x185)](_0x20b1c6(0xbe)+_0x3a0db3[_0x20b1c6(0x94)]),console[_0x20b1c6(0x185)]('🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/'+_0x3a0db3['id']),console['log'](_0x20b1c6(0x165)),this[_0x20b1c6(0x14b)](_0x3a0db3);}async['getPaymentLinks'](_0xeee5e9,_0x1db970){const _0x4c4593=a52_0x33f4ee,{page:_0x30212e,limit:_0x4f590d,status:_0x456f6d,gateway:_0x5f4532,search:_0x40aff1}=_0x1db970,_0x4d5ce6=(_0x30212e-0x1)*_0x4f590d,_0x5d3c63={'shopId':_0xeee5e9};_0x456f6d&&(_0x5d3c63[_0x4c4593(0x131)]=_0x456f6d[_0x4c4593(0x193)]());if(_0x5f4532){if((0x0,gateway_1['isValidGatewayId'])(_0x5f4532)){const _0x59f2ed=(0x0,gateway_1[_0x4c4593(0x150)])(_0x5f4532);_0x59f2ed&&(_0x5d3c63[_0x4c4593(0x17e)]=_0x59f2ed);}else _0x5d3c63[_0x4c4593(0x17e)]=_0x5f4532[_0x4c4593(0x11e)]();}_0x40aff1&&(_0x5d3c63['OR']=[{'gateway':{'contains':_0x40aff1,'mode':_0x4c4593(0x145)}},{'currency':{'contains':_0x40aff1,'mode':_0x4c4593(0x145)}}]);const [_0x209f56,_0x1e13bd]=await Promise['all']([database_1[_0x4c4593(0xfc)][_0x4c4593(0x11b)][_0x4c4593(0x17a)]({'where':_0x5d3c63,'skip':_0x4d5ce6,'take':_0x4f590d,'orderBy':{'createdAt':_0x4c4593(0xad)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x4c4593(0xad)},'take':0xa}}}),database_1[_0x4c4593(0xfc)]['paymentLink']['count']({'where':_0x5d3c63})]);return{'links':_0x209f56[_0x4c4593(0xa9)](_0xa778e8=>this[_0x4c4593(0x14b)](_0xa778e8)),'pagination':{'page':_0x30212e,'limit':_0x4f590d,'total':_0x1e13bd,'totalPages':Math[_0x4c4593(0x117)](_0x1e13bd/_0x4f590d)}};}async[a52_0x33f4ee(0xd1)](_0x3d9e88,_0x12c44e){const _0x2c7ed9=a52_0x33f4ee,_0x24aaf9=await database_1[_0x2c7ed9(0xfc)][_0x2c7ed9(0x11b)]['findFirst']({'where':{'id':_0x12c44e,'shopId':_0x3d9e88},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x2c7ed9(0xad)}}}});if(!_0x24aaf9)return null;return this[_0x2c7ed9(0x14b)](_0x24aaf9);}async['updatePaymentLink'](_0xbf433d,_0x3eddce,_0x7c50ac){const _0x22e665=a52_0x33f4ee,_0x2b8906={..._0x7c50ac};if(_0x7c50ac[_0x22e665(0x17e)]){if((0x0,gateway_1[_0x22e665(0xd4)])(_0x7c50ac['gateway'])){const _0x3a603a=(0x0,gateway_1[_0x22e665(0x150)])(_0x7c50ac['gateway']);_0x3a603a&&(await this[_0x22e665(0xb3)](_0xbf433d,_0x3a603a),_0x2b8906[_0x22e665(0x17e)]=_0x3a603a);}else _0x2b8906[_0x22e665(0x17e)]=_0x7c50ac[_0x22e665(0x17e)]['toLowerCase']();}(_0x2b8906['gateway']===_0x22e665(0x7a)||_0x7c50ac[_0x22e665(0x10c)]&&_0x2b8906['gateway']!=='rapyd')&&(_0x2b8906[_0x22e665(0x17e)]==='rapyd'&&(_0x2b8906[_0x22e665(0x10c)]='GB',console[_0x22e665(0x185)](_0x22e665(0x88))));(_0x2b8906[_0x22e665(0x17e)]==='cointopay'||_0x2b8906[_0x22e665(0x17e)]==='cointopay2')&&(_0x2b8906[_0x22e665(0x6e)]=_0x22e665(0x100),console[_0x22e665(0x185)](_0x22e665(0xd6)+_0x2b8906['gateway']+'\x20payment\x20link\x20update'));_0x2b8906['gateway']&&_0x2b8906[_0x22e665(0x6e)]&&this[_0x22e665(0x146)](_0x2b8906['gateway'],_0x2b8906[_0x22e665(0x6e)]);if(_0x7c50ac[_0x22e665(0xbb)]&&_0x2b8906[_0x22e665(0x17e)]){const _0x23ab9f=_0x7c50ac[_0x22e665(0x6e)]||_0x22e665(0x11c);await this['checkAmountLimits'](_0xbf433d,_0x2b8906[_0x22e665(0x17e)],_0x7c50ac['amount'],_0x23ab9f);}_0x7c50ac[_0x22e665(0xe7)]&&(_0x2b8906[_0x22e665(0xe7)]=new Date(_0x7c50ac['expiresAt']));const _0x2f81f=await database_1[_0x22e665(0xfc)][_0x22e665(0x11b)][_0x22e665(0xa3)]({'where':{'id':_0x3eddce,'shopId':_0xbf433d},'data':_0x2b8906,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x22e665(0xad)},'take':0xa}}});return this[_0x22e665(0x14b)](_0x2f81f);}async['deletePaymentLink'](_0x26eb52,_0x234d11){const _0x272d97=a52_0x33f4ee;await database_1[_0x272d97(0xfc)][_0x272d97(0x11b)][_0x272d97(0x82)]({'where':{'id':_0x234d11,'shopId':_0x26eb52}});}async[a52_0x33f4ee(0x8e)](_0x2c3bb3){const _0x21d4fd=a52_0x33f4ee,_0x2a9078=await database_1[_0x21d4fd(0xfc)][_0x21d4fd(0x11b)][_0x21d4fd(0x140)]({'where':{'id':_0x2c3bb3},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x2a9078)return null;const _0x5c2cde=_0x2a9078[_0x21d4fd(0xe7)]&&_0x2a9078[_0x21d4fd(0xe7)]<new Date(),_0x1d78c2=_0x2a9078['type']===_0x21d4fd(0x6a)?_0x2a9078[_0x21d4fd(0x161)]>=0x1:![],_0x4f7804=_0x2a9078[_0x21d4fd(0xf4)][_0x21d4fd(0x131)]===_0x21d4fd(0x122),_0x4f0d95=_0x2a9078[_0x21d4fd(0x131)]==='ACTIVE',_0x120507=!_0x5c2cde&&!_0x1d78c2&&_0x4f7804&&_0x4f0d95,_0x213424=_0x2a9078[_0x21d4fd(0x94)]===_0x21d4fd(0x6a)?_0x2a9078['currentPayments']>=0x1?0x0:0x1:Number['MAX_SAFE_INTEGER'];let _0x123722=_0x2a9078[_0x21d4fd(0x131)];if(_0x1d78c2)_0x123722=_0x21d4fd(0xb0);else _0x5c2cde&&(_0x123722=_0x21d4fd(0x119));return console['log'](_0x21d4fd(0x85)+_0x2c3bb3+_0x21d4fd(0x110)),console['log'](_0x21d4fd(0x126)+_0x2a9078['status']),console[_0x21d4fd(0x185)](_0x21d4fd(0xca)+_0x2a9078[_0x21d4fd(0x94)]),console[_0x21d4fd(0x185)](_0x21d4fd(0x102)+_0x2a9078[_0x21d4fd(0x161)]),console[_0x21d4fd(0x185)](_0x21d4fd(0x74)+_0x1d78c2),console[_0x21d4fd(0x185)]('\x20\x20\x20-\x20Is\x20expired:\x20'+_0x5c2cde),console[_0x21d4fd(0x185)](_0x21d4fd(0x129)+_0x123722),{'id':_0x2a9078['id'],'amount':_0x2a9078[_0x21d4fd(0xbb)],'currency':_0x2a9078[_0x21d4fd(0x6e)],'sourceCurrency':_0x2a9078['sourceCurrency']||undefined,'gateway':_0x2a9078[_0x21d4fd(0x17e)],'type':_0x2a9078['type'],'currentPayments':_0x2a9078[_0x21d4fd(0x161)],'status':_0x123722,'expiresAt':_0x2a9078['expiresAt']||undefined,'shopName':_0x2a9078[_0x21d4fd(0xf4)]['name'],'isAvailable':_0x120507,'remainingPayments':_0x213424};}async[a52_0x33f4ee(0xeb)](_0x27885a){const _0x205659=a52_0x33f4ee,{linkId:_0x503f1c,customerEmail:_0x59106b,customerName:_0x5cf21f}=_0x27885a,_0x420009=await database_1['default'][_0x205659(0x11b)]['findUnique']({'where':{'id':_0x503f1c},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x420009)throw new Error(_0x205659(0x9f));const _0x3c97ff=_0x420009[_0x205659(0xe7)]&&_0x420009[_0x205659(0xe7)]<new Date(),_0xc219a8=_0x420009[_0x205659(0x94)]===_0x205659(0x6a)?_0x420009[_0x205659(0x161)]>=0x1:![],_0x5056b8=_0x420009[_0x205659(0xf4)]['status']===_0x205659(0x122),_0x29e12e=_0x420009[_0x205659(0x131)]===_0x205659(0x122);if(_0x3c97ff)throw new Error(_0x205659(0xc2));if(_0xc219a8){const _0x382971=_0x420009[_0x205659(0x94)]===_0x205659(0x6a)?_0x205659(0x174):_0x205659(0xff);throw new Error(_0x382971);}if(!_0x5056b8)throw new Error(_0x205659(0x191));if(!_0x29e12e)throw new Error('Payment\x20link\x20is\x20not\x20active');await this[_0x205659(0xb3)](_0x420009[_0x205659(0xf6)],_0x420009['gateway']);const _0x24d65c=_0x420009[_0x205659(0xbb)];console['log'](_0x205659(0xb8)+_0x420009[_0x205659(0x94)]+_0x205659(0x137)+_0x503f1c+':\x20'+_0x24d65c+'\x20'+_0x420009[_0x205659(0x6e)]),console[_0x205659(0x185)](_0x205659(0xc4)+(_0x5cf21f||_0x205659(0x189))+'\x20('+(_0x59106b||_0x205659(0x166))+')'),this[_0x205659(0x146)](_0x420009[_0x205659(0x17e)],_0x420009[_0x205659(0x6e)]),await this['checkAmountLimits'](_0x420009['shopId'],_0x420009['gateway'],_0x24d65c,_0x420009['currency']);const _0x51be77=this[_0x205659(0xdd)]();console[_0x205659(0x185)](_0x205659(0x72)+_0x51be77+_0x205659(0x13a)+_0x420009[_0x205659(0x17e)]+')');const _0x166346=await database_1['default'][_0x205659(0x183)]['create']({'data':{'shopId':_0x420009[_0x205659(0xf6)],'paymentLinkId':_0x420009['id'],'gateway':_0x420009['gateway'],'amount':_0x24d65c,'currency':_0x420009['currency'],'sourceCurrency':_0x420009['sourceCurrency']||undefined,'usage':_0x205659(0xc7),'expiresAt':_0x420009[_0x205659(0xe7)]||undefined,'successUrl':_0x205659(0x13e),'failUrl':'temp','pendingUrl':_0x205659(0x13e),'whiteUrl':_0x205659(0x13e),'status':_0x205659(0x83),'orderId':null,'gatewayOrderId':_0x51be77,'customerEmail':_0x59106b||undefined,'customerName':_0x5cf21f||undefined,'country':_0x420009['country']||undefined,'language':_0x420009[_0x205659(0xa4)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x205659(0x185)](_0x205659(0x103)+_0x166346['id']);const _0x56dc46=process[_0x205659(0x11f)][_0x205659(0x199)]||'https://tesoft.uk',{finalSuccessUrl:_0x2fc92c,finalFailUrl:_0x50dd25,finalPendingUrl:_0x243546,dbSuccessUrl:_0x435a91,dbFailUrl:_0x531d55,dbPendingUrl:_0x190b0d,whiteUrl:_0x18d156}=this[_0x205659(0x123)](_0x420009['gateway'],_0x166346['id'],_0x51be77,_0x56dc46,_0x420009['successUrl']||undefined,_0x420009['failUrl']||undefined,_0x420009[_0x205659(0xe3)]||undefined);await database_1[_0x205659(0xfc)][_0x205659(0x183)][_0x205659(0xa3)]({'where':{'id':_0x166346['id']},'data':{'successUrl':_0x435a91,'failUrl':_0x531d55,'pendingUrl':_0x190b0d,'whiteUrl':_0x18d156}}),console[_0x205659(0x185)]('💰\x20Amount:\x20'+_0x24d65c+'\x20'+_0x420009[_0x205659(0x6e)]),console[_0x205659(0x185)](_0x205659(0xc4)+(_0x5cf21f||_0x205659(0x189))+'\x20('+(_0x59106b||_0x205659(0x166))+')'),console[_0x205659(0x185)](_0x205659(0x15b)+_0x435a91),console[_0x205659(0x185)]('💾\x20DB\x20Fail\x20URL:\x20'+_0x531d55),console['log'](_0x205659(0xe1)+_0x190b0d),console[_0x205659(0x185)]('🔗\x20White\x20URL:\x20'+(_0x18d156||_0x205659(0x120)));let _0x5735a8,_0x401ea9;try{if(_0x420009['gateway']===_0x205659(0x8c)){console['log'](_0x205659(0xea)),console[_0x205659(0x185)](_0x205659(0x11d)+_0x420009['currency']),console[_0x205659(0x185)](_0x205659(0x9c)+_0x420009['sourceCurrency']);const _0xace6d=await this[_0x205659(0xde)][_0x205659(0x12d)]({'paymentId':_0x166346['id'],'orderId':_0x51be77,'amount':_0x24d65c,'currency':_0x420009['currency'],'productName':_0x205659(0x10f)+_0x24d65c+'\x20'+_0x420009[_0x205659(0x6e)],'description':_0x205659(0x10f)+_0x24d65c+'\x20'+_0x420009['currency'],'successUrl':_0x2fc92c,'failUrl':_0x50dd25,'customerEmail':_0x59106b||undefined,'customerName':_0x5cf21f||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x420009[_0x205659(0x113)]||undefined});_0x5735a8=_0xace6d[_0x205659(0x79)],_0x401ea9=_0xace6d['payment_url'],await database_1['default'][_0x205659(0x183)]['update']({'where':{'id':_0x166346['id']},'data':{'externalPaymentUrl':_0x401ea9,'gatewayPaymentId':_0x5735a8,'invoiceTotalSum':Number(_0xace6d['invoice_total_sum']),'qrCode':_0xace6d[_0x205659(0xb6)],'qrUrl':_0xace6d['qr_url']}});const _0x283468=_0x205659(0x12a)+_0x166346['id'];return console[_0x205659(0x185)](_0x205659(0x169)+_0x283468),{'paymentId':_0x166346['id'],'paymentUrl':_0x283468,'expiresAt':_0x166346[_0x205659(0xe7)]||undefined};}else{if(_0x420009[_0x205659(0x17e)]===_0x205659(0x7a)){const _0x2ef08d=await this[_0x205659(0x14f)][_0x205659(0x188)]({'paymentId':_0x166346['id'],'orderId':_0x51be77,'orderName':'Payment\x20'+_0x24d65c+'\x20'+_0x420009[_0x205659(0x6e)],'amount':_0x24d65c,'currency':_0x420009[_0x205659(0x6e)],'country':_0x420009['country'],'language':_0x420009['language']||'EN','amountIsEditable':![],'usage':'ONCE','maxPayments':0x1,'successUrl':_0x2fc92c,'failUrl':_0x50dd25});_0x5735a8=_0x2ef08d['gateway_payment_id'],_0x401ea9=_0x2ef08d[_0x205659(0x176)],await database_1[_0x205659(0xfc)][_0x205659(0x183)][_0x205659(0xa3)]({'where':{'id':_0x166346['id']},'data':{'externalPaymentUrl':_0x401ea9,'gatewayPaymentId':_0x5735a8}});const _0x2e750e=_0x205659(0x12a)+_0x166346['id'];return console[_0x205659(0x185)]('🔗\x20Rapyd\x20payment\x20URL:\x20'+_0x2e750e),{'paymentId':_0x166346['id'],'paymentUrl':_0x2e750e,'expiresAt':_0x166346['expiresAt']||undefined};}else{if(_0x420009['gateway']==='noda'){const _0x325a98=await this[_0x205659(0x68)][_0x205659(0x188)]({'paymentId':_0x166346['id'],'orderId':_0x51be77,'name':_0x205659(0x10f)+_0x24d65c+'\x20'+_0x420009[_0x205659(0x6e)],'paymentDescription':_0x205659(0x10f)+_0x24d65c+'\x20'+_0x420009['currency'],'amount':_0x24d65c,'currency':_0x420009['currency'],'webhookUrl':_0x205659(0x10b),'returnUrl':_0x243546,'expiryDate':_0x420009['expiresAt']?.[_0x205659(0xae)]()});_0x5735a8=_0x325a98[_0x205659(0x79)],_0x401ea9=_0x325a98[_0x205659(0x176)],await database_1[_0x205659(0xfc)][_0x205659(0x183)][_0x205659(0xa3)]({'where':{'id':_0x166346['id']},'data':{'externalPaymentUrl':_0x401ea9,'gatewayPaymentId':_0x5735a8,'qrUrl':_0x325a98[_0x205659(0x153)]}});const _0x3de46b=_0x205659(0x12a)+_0x166346['id'];return console[_0x205659(0x185)](_0x205659(0x197)+_0x3de46b),{'paymentId':_0x166346['id'],'paymentUrl':_0x3de46b,'expiresAt':_0x166346['expiresAt']||undefined};}else{if(_0x420009[_0x205659(0x17e)]===_0x205659(0x132)){console['log']('🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x51be77+_0x205659(0x7d)),console[_0x205659(0x185)](_0x205659(0xa2)+_0x24d65c+'\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)');const _0x42a707=await this['coinToPayService'][_0x205659(0x188)]({'paymentId':_0x166346['id'],'orderId':_0x51be77,'amount':_0x24d65c});_0x5735a8=_0x42a707[_0x205659(0x79)],_0x401ea9=_0x42a707[_0x205659(0x176)],await database_1[_0x205659(0xfc)][_0x205659(0x183)][_0x205659(0xa3)]({'where':{'id':_0x166346['id']},'data':{'externalPaymentUrl':_0x401ea9,'gatewayPaymentId':_0x5735a8}});_0x5735a8&&(console[_0x205659(0x185)](_0x205659(0x7e)+_0x166346['id']+'\x20('+_0x5735a8+')'),coinToPayStatusService_1[_0x205659(0x121)][_0x205659(0xc9)](_0x166346['id'],_0x5735a8));const _0x132fb8='https://app.trapay.uk/payment/'+_0x166346['id'];return console[_0x205659(0x185)](_0x205659(0xcc)+_0x132fb8),{'paymentId':_0x166346['id'],'paymentUrl':_0x132fb8,'expiresAt':_0x166346['expiresAt']||undefined};}else{if(_0x420009[_0x205659(0x17e)]===_0x205659(0x144)){console[_0x205659(0x185)](_0x205659(0xf3)+_0x51be77+_0x205659(0x7d)),console[_0x205659(0x185)](_0x205659(0xa2)+_0x24d65c+_0x205659(0x139));const _0x9a22f5=await this['coinToPay2Service'][_0x205659(0x188)]({'paymentId':_0x166346['id'],'orderId':_0x51be77,'amount':_0x24d65c});_0x5735a8=_0x9a22f5[_0x205659(0x79)],_0x401ea9=_0x9a22f5[_0x205659(0x176)],await database_1[_0x205659(0xfc)][_0x205659(0x183)][_0x205659(0xa3)]({'where':{'id':_0x166346['id']},'data':{'externalPaymentUrl':_0x401ea9,'gatewayPaymentId':_0x5735a8}});_0x5735a8&&(console[_0x205659(0x185)]('🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay2\x20payment:\x20'+_0x166346['id']+'\x20('+_0x5735a8+')'),coinToPayStatusService_1[_0x205659(0x121)][_0x205659(0xc9)](_0x166346['id'],_0x5735a8));const _0x20c337='https://app.trapay.uk/payment/'+_0x166346['id'];return console[_0x205659(0x185)](_0x205659(0x18d)+_0x20c337),{'paymentId':_0x166346['id'],'paymentUrl':_0x20c337,'expiresAt':_0x166346[_0x205659(0xe7)]||undefined};}else{if(_0x420009[_0x205659(0x17e)][_0x205659(0xda)](_0x205659(0x73))){const _0x481fdd=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x420009[_0x205659(0x17e)]);if(!_0x481fdd)throw new Error(_0x205659(0x116)+_0x420009[_0x205659(0x17e)]);console[_0x205659(0x185)](_0x205659(0xc6)+_0x481fdd+'\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x51be77+_0x205659(0x7d)),console[_0x205659(0x185)](_0x205659(0xa2)+_0x24d65c+'\x20'+_0x420009[_0x205659(0x6e)]+_0x205659(0x96)+_0x481fdd+')');const _0x366dcd=await this[_0x205659(0xe4)][_0x205659(0x188)]({'paymentId':_0x166346['id'],'orderId':_0x51be77,'amount':_0x24d65c,'currency':_0x420009[_0x205659(0x6e)],'region':_0x481fdd,'redirectUrl':_0x243546});_0x5735a8=_0x366dcd[_0x205659(0x79)],_0x401ea9=_0x366dcd['payment_url'],await database_1[_0x205659(0xfc)]['payment'][_0x205659(0xa3)]({'where':{'id':_0x166346['id']},'data':{'externalPaymentUrl':_0x401ea9,'gatewayPaymentId':_0x5735a8}});const _0x37a2fc=_0x205659(0x12a)+_0x166346['id'];return console[_0x205659(0x185)](_0x205659(0x162)+_0x481fdd+_0x205659(0xf0)+_0x51be77),console[_0x205659(0x185)](_0x205659(0x133)+_0x481fdd+'\x20payment\x20URL:\x20'+_0x37a2fc),{'paymentId':_0x166346['id'],'paymentUrl':_0x37a2fc,'expiresAt':_0x166346[_0x205659(0xe7)]||undefined};}else{if(_0x420009[_0x205659(0x17e)]===_0x205659(0x6c)){console['log'](_0x205659(0x7c)+_0x51be77+_0x205659(0x7d)),console['log'](_0x205659(0xa2)+_0x24d65c+'\x20'+_0x420009[_0x205659(0x6e)]+'\x20(Test\x20Gateway)');const _0x442ae5='https://app.trapay.uk/test-gateway/payment/'+_0x166346['id'];await database_1['default'][_0x205659(0x183)]['update']({'where':{'id':_0x166346['id']},'data':{'externalPaymentUrl':_0x442ae5,'gatewayPaymentId':_0x205659(0x177)+_0x51be77}});const _0x4623a4=_0x205659(0x12a)+_0x166346['id'];return console[_0x205659(0x185)](_0x205659(0xf9)+_0x4623a4),console[_0x205659(0x185)](_0x205659(0xd9)+_0x442ae5),{'paymentId':_0x166346['id'],'paymentUrl':_0x4623a4,'expiresAt':_0x166346[_0x205659(0xe7)]||undefined};}else{if(_0x420009[_0x205659(0x17e)]==='mastercard'){console[_0x205659(0x185)](_0x205659(0x184)+_0x51be77+_0x205659(0x7d)),console[_0x205659(0x185)](_0x205659(0xa2)+_0x24d65c+'\x20'+_0x420009[_0x205659(0x6e)]+_0x205659(0x13b));const _0xca193c=new URLSearchParams();_0x59106b&&_0xca193c[_0x205659(0x66)](_0x205659(0x195),_0x59106b);_0x5cf21f&&_0xca193c[_0x205659(0x66)](_0x205659(0x118),_0x5cf21f);const _0x1b5d25='https://app.trapay.uk/payment/'+_0x166346['id']+(_0xca193c[_0x205659(0xc5)]()?'?'+_0xca193c[_0x205659(0xc5)]():'');await database_1[_0x205659(0xfc)][_0x205659(0x183)][_0x205659(0xa3)]({'where':{'id':_0x166346['id']},'data':{'externalPaymentUrl':_0x1b5d25,'gatewayPaymentId':_0x205659(0xdf)+_0x51be77,'paymentMethod':_0x205659(0x16a)}});const _0x3d0dd2='https://app.trapay.uk/payment/'+_0x166346['id']+(_0xca193c['toString']()?'?'+_0xca193c[_0x205659(0xc5)]():'');return console['log']('🔗\x20MasterCard\x20payment\x20URL:\x20'+_0x3d0dd2),console['log'](_0x205659(0x154)+_0x1b5d25),console[_0x205659(0x185)](_0x205659(0x89),_0xca193c['toString']()),{'paymentId':_0x166346['id'],'paymentUrl':_0x3d0dd2,'expiresAt':_0x166346[_0x205659(0xe7)]||undefined};}else{if(_0x420009[_0x205659(0x17e)]==='amer'){console[_0x205659(0x185)](_0x205659(0x6d)+_0x51be77),console[_0x205659(0x185)]('💰\x20Amount:\x20'+_0x24d65c+'\x20'+_0x420009[_0x205659(0x6e)]+_0x205659(0x18f));const _0x19cee5=new URLSearchParams();_0x19cee5[_0x205659(0x66)](_0x205659(0xf1),_0x166346['id']),_0x19cee5[_0x205659(0x66)](_0x205659(0xbb),_0x24d65c[_0x205659(0xc5)]()),_0x19cee5[_0x205659(0x66)](_0x205659(0x6e),_0x420009[_0x205659(0x6e)]);_0x59106b&&_0x19cee5[_0x205659(0x66)](_0x205659(0x195),_0x59106b);_0x5cf21f&&_0x19cee5[_0x205659(0x66)](_0x205659(0x118),_0x5cf21f);const _0x4abe31=_0x205659(0xfb)+_0x19cee5[_0x205659(0xc5)]();return await database_1[_0x205659(0xfc)][_0x205659(0x183)]['update']({'where':{'id':_0x166346['id']},'data':{'externalPaymentUrl':_0x4abe31,'gatewayPaymentId':_0x205659(0x147)+_0x51be77,'paymentMethod':'amer'}}),console[_0x205659(0x185)](_0x205659(0xd8)+_0x4abe31),{'paymentId':_0x166346['id'],'paymentUrl':_0x4abe31,'expiresAt':_0x166346['expiresAt']||undefined};}else throw new Error('Unsupported\x20gateway:\x20'+_0x420009[_0x205659(0x17e)]);}}}}}}}}}catch(_0x126323){await database_1[_0x205659(0xfc)]['payment']['update']({'where':{'id':_0x166346['id']},'data':{'status':'FAILED'}});throw new Error('Gateway\x20error:\x20'+(_0x126323 instanceof Error?_0x126323[_0x205659(0x67)]:_0x205659(0xee)));}}async['handleSuccessfulPayment'](_0x1e88f3){const _0x2ffacc=a52_0x33f4ee;console[_0x2ffacc(0x185)](_0x2ffacc(0xf8)+_0x1e88f3);const _0x456ebd=await database_1[_0x2ffacc(0xfc)][_0x2ffacc(0x183)]['findUnique']({'where':{'id':_0x1e88f3},'include':{'paymentLink':!![]}});console['log']('📈\x20Payment\x20found:',_0x456ebd?{'id':_0x456ebd['id'],'status':_0x456ebd['status'],'paidAt':_0x456ebd['paidAt'],'paymentLinkId':_0x456ebd[_0x2ffacc(0xcb)],'paymentLink':_0x456ebd['paymentLink']?{'id':_0x456ebd[_0x2ffacc(0x11b)]['id'],'type':_0x456ebd[_0x2ffacc(0x11b)][_0x2ffacc(0x94)],'currentPayments':_0x456ebd[_0x2ffacc(0x11b)][_0x2ffacc(0x161)],'status':_0x456ebd[_0x2ffacc(0x11b)][_0x2ffacc(0x131)]}:null}:_0x2ffacc(0xa5));if(!_0x456ebd||!_0x456ebd[_0x2ffacc(0x11b)]){console[_0x2ffacc(0x185)](_0x2ffacc(0x115)+_0x1e88f3+_0x2ffacc(0x152));return;}if(_0x456ebd[_0x2ffacc(0x131)]!=='PAID'){console[_0x2ffacc(0x185)](_0x2ffacc(0x115)+_0x1e88f3+'\x20status\x20is\x20'+_0x456ebd[_0x2ffacc(0x131)]+_0x2ffacc(0x149));return;}if(!_0x456ebd[_0x2ffacc(0xa0)]){console[_0x2ffacc(0x185)](_0x2ffacc(0x115)+_0x1e88f3+'\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.');return;}console[_0x2ffacc(0x185)](_0x2ffacc(0x87)+_0x1e88f3+_0x2ffacc(0xd5));try{const _0x459a8b=await database_1['default'][_0x2ffacc(0x16c)](async _0x18e612=>{const _0x5442d0=_0x2ffacc,_0x3e6674=await _0x18e612[_0x5442d0(0x11b)]['findUnique']({'where':{'id':_0x456ebd['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(!_0x3e6674)throw new Error('Payment\x20link\x20'+_0x456ebd[_0x5442d0(0xcb)]+_0x5442d0(0x10e));console['log'](_0x5442d0(0x12b),_0x3e6674);if(_0x3e6674[_0x5442d0(0x94)]==='SINGLE'&&_0x3e6674[_0x5442d0(0x161)]>=0x1)return console[_0x5442d0(0x185)](_0x5442d0(0x112)+_0x456ebd[_0x5442d0(0xcb)]+_0x5442d0(0x172)+_0x3e6674[_0x5442d0(0x161)]+_0x5442d0(0x95)),_0x3e6674;const _0x29f011=await _0x18e612[_0x5442d0(0x183)][_0x5442d0(0x18c)]({'where':{'paymentLinkId':_0x456ebd[_0x5442d0(0xcb)],'status':_0x5442d0(0x187),'paidAt':{'not':null},'id':{'not':_0x1e88f3}}});console[_0x5442d0(0x185)]('📈\x20Existing\x20successful\x20payments\x20for\x20link\x20'+_0x456ebd[_0x5442d0(0xcb)]+':\x20'+_0x29f011);const _0x306acd=_0x29f011+0x1,_0x3178e3=_0x3e6674[_0x5442d0(0x94)]===_0x5442d0(0x6a)&&_0x306acd>=0x1?_0x5442d0(0xb0):_0x3e6674[_0x5442d0(0x131)];console[_0x5442d0(0x185)](_0x5442d0(0x170)+_0x456ebd['paymentLinkId']+':'),console[_0x5442d0(0x185)](_0x5442d0(0xca)+_0x3e6674[_0x5442d0(0x94)]),console[_0x5442d0(0x185)](_0x5442d0(0x102)+_0x3e6674[_0x5442d0(0x161)]+_0x5442d0(0x13d)+_0x306acd),console['log']('\x20\x20\x20-\x20Status:\x20'+_0x3e6674['status']+'\x20->\x20'+_0x3178e3);const _0x13e9d4=await _0x18e612[_0x5442d0(0x11b)][_0x5442d0(0xa3)]({'where':{'id':_0x456ebd[_0x5442d0(0xcb)]},'data':{'currentPayments':_0x306acd,'status':_0x3178e3}});return console[_0x5442d0(0x185)]('📈\x20Payment\x20link\x20'+_0x456ebd[_0x5442d0(0xcb)]+'\x20('+_0x3e6674['type']+_0x5442d0(0xc3)+_0x3e6674[_0x5442d0(0x161)]+'\x20->\x20'+_0x306acd),_0x13e9d4;});if(_0x459a8b[_0x2ffacc(0x131)]===_0x2ffacc(0xb0)){const _0x4f3125=_0x459a8b[_0x2ffacc(0x94)]===_0x2ffacc(0x6a)?_0x2ffacc(0x16f):'multi-use';console[_0x2ffacc(0x185)](_0x2ffacc(0x194)+_0x456ebd['paymentLinkId']+_0x2ffacc(0xed)+_0x4f3125+_0x2ffacc(0x179)+_0x459a8b[_0x2ffacc(0x161)]+_0x2ffacc(0x163));}}catch(_0x4fbf98){console[_0x2ffacc(0x14c)](_0x2ffacc(0x196)+_0x1e88f3+':',_0x4fbf98);throw _0x4fbf98;}}async[a52_0x33f4ee(0x18e)](_0x2987de){const _0x49cc51=a52_0x33f4ee,[_0x3cbc9f,_0x128516,_0x9a25fc,_0x41e266]=await Promise[_0x49cc51(0xce)]([database_1[_0x49cc51(0xfc)][_0x49cc51(0x11b)][_0x49cc51(0x18c)]({'where':{'shopId':_0x2987de}}),database_1['default'][_0x49cc51(0x11b)][_0x49cc51(0x18c)]({'where':{'shopId':_0x2987de,'status':_0x49cc51(0x122)}}),database_1[_0x49cc51(0xfc)][_0x49cc51(0x183)][_0x49cc51(0x18c)]({'where':{'shopId':_0x2987de,'paymentLinkId':{'not':null},'gateway':{'not':'test_gateway'}}}),database_1['default'][_0x49cc51(0x183)][_0x49cc51(0x17a)]({'where':{'shopId':_0x2987de,'paymentLinkId':{'not':null},'status':'PAID','gateway':{'not':'test_gateway'}},'select':{'amount':!![],'currency':!![]}})]);let _0x2bd80f=0x0;for(const _0x31875e of _0x41e266){const _0xcf21dc=await currencyService_1['currencyService'][_0x49cc51(0x14d)](_0x31875e['amount'],_0x31875e[_0x49cc51(0x6e)]);_0x2bd80f+=_0xcf21dc;}const _0x560fb4=_0x9a25fc>0x0?_0x41e266[_0x49cc51(0x9b)]/_0x9a25fc*0x64:0x0;return{'totalLinks':_0x3cbc9f,'activeLinks':_0x128516,'totalPayments':_0x9a25fc,'totalRevenue':Math[_0x49cc51(0x81)](_0x2bd80f*0x64)/0x64,'conversionRate':Math[_0x49cc51(0x81)](_0x560fb4*0x64)/0x64};}[a52_0x33f4ee(0x14b)](_0x85a768){const _0x1e62ef=a52_0x33f4ee;return{'id':_0x85a768['id'],'shopId':_0x85a768[_0x1e62ef(0xf6)],'amount':_0x85a768[_0x1e62ef(0xbb)],'currency':_0x85a768[_0x1e62ef(0x6e)],'sourceCurrency':_0x85a768[_0x1e62ef(0x113)]||undefined,'gateway':_0x85a768[_0x1e62ef(0x17e)],'type':_0x85a768[_0x1e62ef(0x94)],'currentPayments':_0x85a768['currentPayments'],'status':_0x85a768[_0x1e62ef(0x131)],'expiresAt':_0x85a768['expiresAt']||undefined,'successUrl':_0x85a768[_0x1e62ef(0x6b)]||undefined,'failUrl':_0x85a768[_0x1e62ef(0xd0)]||undefined,'pendingUrl':_0x85a768[_0x1e62ef(0xe3)]||undefined,'country':_0x85a768['country']||undefined,'language':_0x85a768['language']||undefined,'linkUrl':_0x1e62ef(0x107)+_0x85a768['id'],'createdAt':_0x85a768[_0x1e62ef(0x138)],'updatedAt':_0x85a768[_0x1e62ef(0x10d)],'shop':_0x85a768[_0x1e62ef(0xf4)],'payments':_0x85a768[_0x1e62ef(0xe6)]};}}exports[a52_0x33f4ee(0x19a)]=PaymentLinkService;