'use strict';function a45_0x112e(){const _0x5448b9=['CoinToPay','\x20\x20\x20💾\x20DB\x20Success\x20URL:\x20','💾\x20Payment\x20created:\x20','qr_code_url','\x20payment\x20URL:\x20','plisio','🪙\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Payment\x20link\x20is\x20not\x20active','\x20\x20\x20🌐\x20Gateway\x20Pending\x20URL:\x20','toLowerCase','2eGIiHL','Error\x20parsing\x20payment\x20gateways:','updatePaymentLink','PaymentLinkService','Payment\x20link\x20has\x20expired','initiatePaymentFromLink','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','COMPLETED','klymeService','round','🪙\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','schedulePaymentChecks','paymentGateways','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','\x22\x20is\x20allowed\x20for\x20shop\x20','https://app.trapay.uk/link/','error','11500qkIWCS','PENDING','🪙\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','KLYME\x20EU','Shop\x20is\x20not\x20active','\x20\x20\x20🌐\x20Gateway\x20Fail\x20URL:\x20','Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.','💰\x20Fixed\x20amount:\x20','🔐\x20Shop\x20','KLYME\x20DE','🔗\x20Generated\x20URLs\x20for\x20','coinToPayService','sourceCurrency','FAILED','CoinToPayService','gateway_payment_id','Plisio','🔗\x20Noda\x20payment\x20URL:\x20','gateway','getPaymentLinkById','Gateway\x20error:\x20','NodaService','/gateway/pending.php?id=','join','toUpperCase','https://app.trapay.uk/payment/','\x20with\x20payment\x20ID\x20','map','📝\x20Note:\x20Success/Fail/Pending\x20URLs\x20will\x20be\x20generated\x20when\x20payment\x20is\x20created','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','formatPaymentLinkResponse','invoice_total_sum','Rapyd','failUrl','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','name','create','startsWith','max','GBP','📈\x20Payment\x20link\x20','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','amount\x20is\x20required\x20and\x20must\x20be\x20positive','parse','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','update','shop','getGatewayNameById','./gateways/plisioService','updatedAt','amount','BASE_URL','coinToPayStatusService','country','cointopay','),\x20skipping\x20increment','__esModule','🔗\x20KLYME\x20','paymentLink','\x20\x20\x20💾\x20DB\x20Pending\x20URL:\x20','temp','\x20counter\x20updated:\x20','💾\x20DB\x20Pending\x20URL:\x20','pendingUrl','shopId','findFirst','7616590vKTlKZ','successUrl','Payment\x20link\x20','rapyd',',\x20not\x20PAID.\x20Skipping\x20counter\x20update.','Payment\x20','PAID','getPublicPaymentLinkData','convertToUSDT','getPaymentLinkStatistics','status','maxPayments','747200KiSUiK','https://tesoft.uk/gateway/payment.php?id=','9zixnbR','1140492JUfcfJ','checkGatewayPermission','no\x20email','payment_url','padStart','createPaymentLink','🔗\x20CoinToPay\x20payment\x20URL:\x20','ceil','❌\x20Enabled\x20gateways:\x20','1500568lGIQIo','Enabled\x20gateways:\x20','all','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','default','\x20\x20\x20🌐\x20Gateway\x20Success\x20URL:\x20','https://app.trapay.uk/payment/fail?id=','💳\x20Initiating\x20payment\x20from\x20link\x20','💳\x20Creating\x20KLYME\x20','./gateways/klymeService','qr_code','payments','nodaService','\x20(validated\x20for\x20','🔗\x20Plisio\x20payment\x20URL:\x20','paymentLinkId','1937642qvicAL','\x20\x20\x20💾\x20DB\x20Fail\x20URL:\x20','./coinToPayStatusService','log','Noda','length','&payment_id=','https://app.trapay.uk/payment/pending?id=','../types/gateway','plisioService','__importDefault','https://app.trapay.uk/payment/success?id=','\x20(8digits-8digits\x20format\x20for\x20','536ZuExxH','📈\x20Payment\x20','generateGatewayOrderId','./currencyService','Anonymous','📈\x20Processing\x20successful\x20payment\x20for\x20payment\x20link\x20counter:\x20','💾\x20DB\x20Fail\x20URL:\x20','message','../config/database','payment','🇬🇧\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','validateKlymeCurrency','\x20status\x20is\x20','Payment\x20link\x20not\x20found','Gateway\x20not\x20found\x20for\x20ID:\x20','1691808WpvdCk','qr_url','ONCE','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','delete','💾\x20DB\x20Success\x20URL:\x20','currency','🎯\x20Generated\x20gateway\x20order_id:\x20','expiresAt','RapydService','getGatewayDisplayName','isValidGatewayId','Invalid\x20gateway\x20ID:\x20','👤\x20Customer:\x20','EUR','❌\x20Gateway\x20\x22','Unsupported\x20KLYME\x20region:\x20','USD','count','paidAt','\x20not\x20found','createdAt','\x20using\x20default\x20gateways:','insensitive','Shop\x20not\x20found','💰\x20Amount:\x20','currentPayments','handleSuccessfulPayment','ACTIVE','getKlymeRegionFromGatewayName','rapydService','🔗\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','random','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','https://tesoft.uk/gateways/noda/webhook','env','toString','./gateways/nodaService','🏁\x20Payment\x20link\x20','./gateways/coinToPayService','findUnique','\x20completed\x20(reached\x20max\x20payments:\x20','desc','language','klyme_','createPayment','Payment\x20link\x20has\x20reached\x20maximum\x20payments','✅\x20Gateway\x20\x22','username','🪙\x20Scheduling\x20individual\x20status\x20checks\x20for\x20CoinToPay\x20payment:\x20'];a45_0x112e=function(){return _0x5448b9;};return a45_0x112e();}const a45_0x153970=a45_0xedd7;(function(_0x1174d9,_0x48b028){const _0x5f097b=a45_0xedd7,_0x2a4e2b=_0x1174d9();while(!![]){try{const _0x28898d=parseInt(_0x5f097b(0x1b8))/0x1*(-parseInt(_0x5f097b(0x22d))/0x2)+-parseInt(_0x5f097b(0x1f0))/0x3+parseInt(_0x5f097b(0x1e1))/0x4*(parseInt(_0x5f097b(0x23e))/0x5)+parseInt(_0x5f097b(0x1bb))/0x6+parseInt(_0x5f097b(0x1d4))/0x7+parseInt(_0x5f097b(0x1c4))/0x8+-parseInt(_0x5f097b(0x1ba))/0x9*(-parseInt(_0x5f097b(0x1ac))/0xa);if(_0x28898d===_0x48b028)break;else _0x2a4e2b['push'](_0x2a4e2b['shift']());}catch(_0x2c2a70){_0x2a4e2b['push'](_0x2a4e2b['shift']());}}}(a45_0x112e,0x64dfe));function a45_0xedd7(_0x3ee7f9,_0xdeed96){const _0x112ea0=a45_0x112e();return a45_0xedd7=function(_0xedd7e5,_0x1ab7aa){_0xedd7e5=_0xedd7e5-0x184;let _0x3907a3=_0x112ea0[_0xedd7e5];return _0x3907a3;},a45_0xedd7(_0x3ee7f9,_0xdeed96);}var __importDefault=this&&this[a45_0x153970(0x1de)]||function(_0x50550d){const _0x2cdb7f=a45_0x153970;return _0x50550d&&_0x50550d[_0x2cdb7f(0x1a2)]?_0x50550d:{'default':_0x50550d};};Object['defineProperty'](exports,a45_0x153970(0x1a2),{'value':!![]}),exports[a45_0x153970(0x230)]=void 0x0;const database_1=__importDefault(require(a45_0x153970(0x1e9))),plisioService_1=require(a45_0x153970(0x19a)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a45_0x153970(0x215)),coinToPayService_1=require(a45_0x153970(0x217)),klymeService_1=require(a45_0x153970(0x1cd)),coinToPayStatusService_1=require(a45_0x153970(0x1d6)),gateway_1=require(a45_0x153970(0x1dc)),currencyService_1=require(a45_0x153970(0x1e4));class PaymentLinkService{constructor(){const _0x267b64=a45_0x153970;this[_0x267b64(0x1dd)]=new plisioService_1['PlisioService'](),this[_0x267b64(0x20e)]=new rapydService_1[(_0x267b64(0x1f9))](),this[_0x267b64(0x1d0)]=new nodaService_1[(_0x267b64(0x253))](),this[_0x267b64(0x249)]=new coinToPayService_1[(_0x267b64(0x24c))](),this[_0x267b64(0x235)]=new klymeService_1['KlymeService']();}[a45_0x153970(0x1e3)](){const _0x32f406=()=>{const _0x292f3a=a45_0xedd7;return Math['floor'](Math[_0x292f3a(0x210)]()*0x5f5e100)[_0x292f3a(0x214)]()[_0x292f3a(0x1bf)](0x8,'0');};return _0x32f406()+'-'+_0x32f406();}['generateGatewayUrls'](_0x1c2f0a,_0x52e451,_0x38c1db,_0x6e8a9d,_0x57e71d,_0x46f35a,_0x21e31c){const _0x55a218=a45_0x153970;if(_0x57e71d&&_0x46f35a&&_0x21e31c)return{'finalSuccessUrl':_0x57e71d,'finalFailUrl':_0x46f35a,'finalPendingUrl':_0x21e31c,'dbSuccessUrl':_0x57e71d,'dbFailUrl':_0x46f35a,'dbPendingUrl':_0x21e31c};const _0x1bee0c=_0x57e71d||_0x55a218(0x1df)+_0x52e451+_0x55a218(0x1da)+_0x38c1db,_0x231e13=_0x46f35a||_0x55a218(0x1ca)+_0x52e451+_0x55a218(0x1da)+_0x38c1db,_0xf461cf=_0x21e31c||_0x55a218(0x1db)+_0x52e451+_0x55a218(0x1da)+_0x38c1db;let _0x3a12cb,_0x452188,_0x124959;return _0x1c2f0a==='noda'||_0x1c2f0a[_0x55a218(0x18f)](_0x55a218(0x21c))||_0x1c2f0a===_0x55a218(0x1a0)?(_0x3a12cb=_0x6e8a9d+_0x55a218(0x254)+_0x52e451,_0x124959=_0x6e8a9d+'/gateway/pending.php?id='+_0x52e451):(_0x3a12cb=_0x6e8a9d+'/gateway/success.php?id='+_0x52e451,_0x124959=_0x6e8a9d+_0x55a218(0x254)+_0x52e451),_0x452188=_0x6e8a9d+'/gateway/fail.php?id='+_0x52e451,console[_0x55a218(0x1d7)](_0x55a218(0x248)+_0x1c2f0a+_0x55a218(0x184)+_0x52e451+':'),console[_0x55a218(0x1d7)](_0x55a218(0x1c9)+_0x3a12cb),console[_0x55a218(0x1d7)](_0x55a218(0x243)+_0x452188),console[_0x55a218(0x1d7)](_0x55a218(0x22b)+_0x124959),console[_0x55a218(0x1d7)](_0x55a218(0x223)+_0x1bee0c),console[_0x55a218(0x1d7)](_0x55a218(0x1d5)+_0x231e13),console[_0x55a218(0x1d7)](_0x55a218(0x1a5)+_0xf461cf),{'finalSuccessUrl':_0x3a12cb,'finalFailUrl':_0x452188,'finalPendingUrl':_0x124959,'dbSuccessUrl':_0x1bee0c,'dbFailUrl':_0x231e13,'dbPendingUrl':_0xf461cf};}[a45_0x153970(0x1ec)](_0x51e372,_0x3f15e5){const _0x24dbef=a45_0x153970;if(!_0x51e372[_0x24dbef(0x18f)](_0x24dbef(0x21c)))return;const _0x337702=(0x0,gateway_1[_0x24dbef(0x20d)])(_0x51e372),_0x899b9b=_0x3f15e5[_0x24dbef(0x256)]();switch(_0x337702){case'EU':if(_0x899b9b!==_0x24dbef(0x1fe))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x899b9b);break;case'GB':if(_0x899b9b!==_0x24dbef(0x191))throw new Error(_0x24dbef(0x18c)+_0x899b9b);break;case'DE':if(_0x899b9b!=='EUR')throw new Error(_0x24dbef(0x229)+_0x899b9b);break;default:throw new Error(_0x24dbef(0x200)+_0x337702);}}async['checkGatewayPermission'](_0x430b5e,_0x1b9713){const _0x4116ec=a45_0x153970;console['log']('🔐\x20Checking\x20gateway\x20permission\x20for\x20shop\x20'+_0x430b5e+':\x20'+_0x1b9713);const _0x36f83c=await database_1[_0x4116ec(0x1c8)][_0x4116ec(0x198)][_0x4116ec(0x218)]({'where':{'id':_0x430b5e},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x36f83c)throw new Error(_0x4116ec(0x208));let _0x165fe9=[];if(_0x36f83c[_0x4116ec(0x239)])try{_0x165fe9=JSON[_0x4116ec(0x195)](_0x36f83c[_0x4116ec(0x239)]),console[_0x4116ec(0x1d7)]('🔐\x20Shop\x20'+_0x36f83c['username']+'\x20enabled\x20gateways:',_0x165fe9);}catch(_0x39abf7){console[_0x4116ec(0x23d)](_0x4116ec(0x22e),_0x39abf7),_0x165fe9=[_0x4116ec(0x24e)];}else _0x165fe9=[_0x4116ec(0x24e)],console['log'](_0x4116ec(0x246)+_0x36f83c[_0x4116ec(0x220)]+_0x4116ec(0x206),_0x165fe9);const _0x1821ae=this['getGatewayDisplayName'](_0x1b9713);console['log']('🔐\x20Checking\x20if\x20\x22'+_0x1821ae+'\x22\x20is\x20in\x20enabled\x20gateways:',_0x165fe9);if(!_0x165fe9['includes'](_0x1821ae)){console[_0x4116ec(0x23d)](_0x4116ec(0x1ff)+_0x1821ae+'\x22\x20not\x20allowed\x20for\x20shop\x20'+_0x36f83c[_0x4116ec(0x220)]),console[_0x4116ec(0x23d)](_0x4116ec(0x1c3)+_0x165fe9['join'](',\x20'));throw new Error('Gateway\x20\x22'+_0x1821ae+_0x4116ec(0x23a)+(_0x4116ec(0x1c5)+_0x165fe9[_0x4116ec(0x255)](',\x20')+'.\x20')+_0x4116ec(0x244));}console[_0x4116ec(0x1d7)](_0x4116ec(0x21f)+_0x1821ae+_0x4116ec(0x23b)+_0x36f83c[_0x4116ec(0x220)]);}[a45_0x153970(0x1fa)](_0x4bd1f5){const _0x3a7d53=a45_0x153970,_0xb1c38b={'plisio':_0x3a7d53(0x24e),'rapyd':_0x3a7d53(0x18a),'noda':_0x3a7d53(0x1d8),'cointopay':_0x3a7d53(0x222),'klyme_eu':_0x3a7d53(0x241),'klyme_gb':'KLYME\x20GB','klyme_de':_0x3a7d53(0x247)};return _0xb1c38b[_0x4bd1f5]||_0x4bd1f5;}async[a45_0x153970(0x1c0)](_0x1d11d6,_0x29cfbe){const _0x5a4094=a45_0x153970;if(!(0x0,gateway_1[_0x5a4094(0x1fb)])(_0x29cfbe[_0x5a4094(0x250)]))throw new Error(_0x5a4094(0x1fc)+_0x29cfbe[_0x5a4094(0x250)]+_0x5a4094(0x187));const _0x596c35=(0x0,gateway_1[_0x5a4094(0x199)])(_0x29cfbe[_0x5a4094(0x250)]);if(!_0x596c35)throw new Error(_0x5a4094(0x1ef)+_0x29cfbe['gateway']);console[_0x5a4094(0x1d7)](_0x5a4094(0x20f)+_0x596c35),await this[_0x5a4094(0x1bc)](_0x1d11d6,_0x596c35);if(_0x596c35==='plisio'&&!_0x29cfbe[_0x5a4094(0x24a)])throw new Error(_0x5a4094(0x193));if(_0x596c35[_0x5a4094(0x18f)](_0x5a4094(0x21c))){const _0x26a0ab=(0x0,gateway_1[_0x5a4094(0x20d)])(_0x596c35);console['log']('💳\x20Creating\x20KLYME\x20'+_0x26a0ab+'\x20payment\x20link');}let _0x40b451=_0x29cfbe[_0x5a4094(0x19f)];_0x596c35===_0x5a4094(0x1af)&&(_0x40b451='GB',console[_0x5a4094(0x1d7)](_0x5a4094(0x196)));if(!_0x29cfbe[_0x5a4094(0x19c)]||_0x29cfbe[_0x5a4094(0x19c)]<=0x0)throw new Error(_0x5a4094(0x194));let _0x2d33e0=_0x29cfbe[_0x5a4094(0x1f6)]||_0x5a4094(0x201);_0x596c35===_0x5a4094(0x1a0)&&(_0x2d33e0=_0x5a4094(0x1fe),console['log'](_0x5a4094(0x240)));this[_0x5a4094(0x1ec)](_0x596c35,_0x2d33e0);const _0x3050d4=await database_1['default'][_0x5a4094(0x1a4)][_0x5a4094(0x18e)]({'data':{'shopId':_0x1d11d6,'amount':_0x29cfbe[_0x5a4094(0x19c)],'currency':_0x2d33e0,'sourceCurrency':_0x29cfbe[_0x5a4094(0x24a)]||undefined,'gateway':_0x596c35,'maxPayments':_0x29cfbe[_0x5a4094(0x1b7)]||0x1,'currentPayments':0x0,'status':_0x5a4094(0x20c),'expiresAt':_0x29cfbe[_0x5a4094(0x1f8)]?new Date(_0x29cfbe[_0x5a4094(0x1f8)]):undefined,'successUrl':_0x29cfbe[_0x5a4094(0x1ad)]||null,'failUrl':_0x29cfbe['failUrl']||null,'pendingUrl':_0x29cfbe['pendingUrl']||null,'country':_0x40b451,'language':_0x29cfbe[_0x5a4094(0x21b)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x5a4094(0x1d7)]('✅\x20Payment\x20link\x20created:\x20'+_0x3050d4['id']+'\x20('+_0x596c35+')'),console['log'](_0x5a4094(0x245)+_0x3050d4[_0x5a4094(0x19c)]+'\x20'+_0x3050d4[_0x5a4094(0x1f6)]),console['log']('🔗\x20Link\x20URL:\x20https://app.trapay.uk/link/'+_0x3050d4['id']),console['log'](_0x5a4094(0x186)),this[_0x5a4094(0x188)](_0x3050d4);}async['getPaymentLinks'](_0x2bbe32,_0x44f196){const _0x438980=a45_0x153970,{page:_0x59566b,limit:_0x1add99,status:_0x1ee54c,gateway:_0x2cd8fc,search:_0x5e5a0e}=_0x44f196,_0x515fe5=(_0x59566b-0x1)*_0x1add99,_0x200265={'shopId':_0x2bbe32};_0x1ee54c&&(_0x200265[_0x438980(0x1b6)]=_0x1ee54c['toUpperCase']());if(_0x2cd8fc){if((0x0,gateway_1[_0x438980(0x1fb)])(_0x2cd8fc)){const _0x23331c=(0x0,gateway_1[_0x438980(0x199)])(_0x2cd8fc);_0x23331c&&(_0x200265[_0x438980(0x250)]=_0x23331c);}else _0x200265[_0x438980(0x250)]=_0x2cd8fc[_0x438980(0x22c)]();}_0x5e5a0e&&(_0x200265['OR']=[{'gateway':{'contains':_0x5e5a0e,'mode':'insensitive'}},{'currency':{'contains':_0x5e5a0e,'mode':_0x438980(0x207)}}]);const [_0x548781,_0xf29cda]=await Promise[_0x438980(0x1c6)]([database_1[_0x438980(0x1c8)]['paymentLink']['findMany']({'where':_0x200265,'skip':_0x515fe5,'take':_0x1add99,'orderBy':{'createdAt':_0x438980(0x21a)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x438980(0x21a)},'take':0xa}}}),database_1[_0x438980(0x1c8)][_0x438980(0x1a4)][_0x438980(0x202)]({'where':_0x200265})]);return{'links':_0x548781[_0x438980(0x185)](_0x3ba31c=>this[_0x438980(0x188)](_0x3ba31c)),'pagination':{'page':_0x59566b,'limit':_0x1add99,'total':_0xf29cda,'totalPages':Math[_0x438980(0x1c2)](_0xf29cda/_0x1add99)}};}async[a45_0x153970(0x251)](_0x13de24,_0x531d70){const _0x26acaa=a45_0x153970,_0xab79c0=await database_1[_0x26acaa(0x1c8)][_0x26acaa(0x1a4)][_0x26acaa(0x1ab)]({'where':{'id':_0x531d70,'shopId':_0x13de24},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'}}}});if(!_0xab79c0)return null;return this[_0x26acaa(0x188)](_0xab79c0);}async[a45_0x153970(0x22f)](_0x3f50ec,_0x47ca42,_0x1b838f){const _0x499ce8=a45_0x153970,_0x5c202b={..._0x1b838f};if(_0x1b838f[_0x499ce8(0x250)]){if((0x0,gateway_1[_0x499ce8(0x1fb)])(_0x1b838f['gateway'])){const _0x54d0cf=(0x0,gateway_1[_0x499ce8(0x199)])(_0x1b838f[_0x499ce8(0x250)]);_0x54d0cf&&(await this[_0x499ce8(0x1bc)](_0x3f50ec,_0x54d0cf),_0x5c202b[_0x499ce8(0x250)]=_0x54d0cf);}else _0x5c202b[_0x499ce8(0x250)]=_0x1b838f[_0x499ce8(0x250)][_0x499ce8(0x22c)]();}(_0x5c202b[_0x499ce8(0x250)]===_0x499ce8(0x1af)||_0x1b838f[_0x499ce8(0x19f)]&&_0x5c202b[_0x499ce8(0x250)]!==_0x499ce8(0x1af))&&(_0x5c202b[_0x499ce8(0x250)]===_0x499ce8(0x1af)&&(_0x5c202b['country']='GB',console['log'](_0x499ce8(0x1eb))));_0x5c202b[_0x499ce8(0x250)]===_0x499ce8(0x1a0)&&(_0x5c202b[_0x499ce8(0x1f6)]=_0x499ce8(0x1fe),console[_0x499ce8(0x1d7)](_0x499ce8(0x237)));_0x5c202b[_0x499ce8(0x250)]&&_0x5c202b[_0x499ce8(0x1f6)]&&this[_0x499ce8(0x1ec)](_0x5c202b[_0x499ce8(0x250)],_0x5c202b[_0x499ce8(0x1f6)]);_0x1b838f[_0x499ce8(0x1f8)]&&(_0x5c202b[_0x499ce8(0x1f8)]=new Date(_0x1b838f[_0x499ce8(0x1f8)]));const _0x211bdf=await database_1[_0x499ce8(0x1c8)][_0x499ce8(0x1a4)][_0x499ce8(0x197)]({'where':{'id':_0x47ca42,'shopId':_0x3f50ec},'data':_0x5c202b,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x499ce8(0x21a)},'take':0xa}}});return this[_0x499ce8(0x188)](_0x211bdf);}async['deletePaymentLink'](_0x5608dc,_0x42940f){const _0x3d27c6=a45_0x153970;await database_1[_0x3d27c6(0x1c8)][_0x3d27c6(0x1a4)][_0x3d27c6(0x1f4)]({'where':{'id':_0x42940f,'shopId':_0x5608dc}});}async[a45_0x153970(0x1b3)](_0x2c7ff0){const _0x3e67da=a45_0x153970,_0xd8ad5a=await database_1[_0x3e67da(0x1c8)][_0x3e67da(0x1a4)][_0x3e67da(0x218)]({'where':{'id':_0x2c7ff0},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0xd8ad5a)return null;const _0x2d50fd=_0xd8ad5a['expiresAt']&&_0xd8ad5a['expiresAt']<new Date(),_0x59effa=_0xd8ad5a['currentPayments']>=_0xd8ad5a[_0x3e67da(0x1b7)],_0x37a64b=_0xd8ad5a[_0x3e67da(0x198)]['status']===_0x3e67da(0x20c),_0x3c3b37=_0xd8ad5a[_0x3e67da(0x1b6)]==='ACTIVE',_0x51ab5a=!_0x2d50fd&&!_0x59effa&&_0x37a64b&&_0x3c3b37,_0x2c01aa=Math[_0x3e67da(0x190)](0x0,_0xd8ad5a[_0x3e67da(0x1b7)]-_0xd8ad5a[_0x3e67da(0x20a)]);return{'id':_0xd8ad5a['id'],'amount':_0xd8ad5a[_0x3e67da(0x19c)],'currency':_0xd8ad5a[_0x3e67da(0x1f6)],'sourceCurrency':_0xd8ad5a[_0x3e67da(0x24a)]||undefined,'gateway':_0xd8ad5a[_0x3e67da(0x250)],'maxPayments':_0xd8ad5a[_0x3e67da(0x1b7)],'currentPayments':_0xd8ad5a[_0x3e67da(0x20a)],'status':_0xd8ad5a[_0x3e67da(0x1b6)],'expiresAt':_0xd8ad5a[_0x3e67da(0x1f8)]||undefined,'shopName':_0xd8ad5a['shop'][_0x3e67da(0x18d)],'isAvailable':_0x51ab5a,'remainingPayments':_0x2c01aa};}async[a45_0x153970(0x232)](_0x119ba0){const _0x304957=a45_0x153970,{linkId:_0x482374,customerEmail:_0x43db77,customerName:_0xf13990}=_0x119ba0,_0x31b168=await database_1[_0x304957(0x1c8)]['paymentLink'][_0x304957(0x218)]({'where':{'id':_0x482374},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}}}});if(!_0x31b168)throw new Error(_0x304957(0x1ee));const _0x5eb5b3=_0x31b168[_0x304957(0x1f8)]&&_0x31b168[_0x304957(0x1f8)]<new Date(),_0x31d320=_0x31b168[_0x304957(0x20a)]>=_0x31b168['maxPayments'],_0x5233c6=_0x31b168['shop'][_0x304957(0x1b6)]===_0x304957(0x20c),_0x171fe7=_0x31b168[_0x304957(0x1b6)]===_0x304957(0x20c);if(_0x5eb5b3)throw new Error(_0x304957(0x231));if(_0x31d320)throw new Error(_0x304957(0x21e));if(!_0x5233c6)throw new Error(_0x304957(0x242));if(!_0x171fe7)throw new Error(_0x304957(0x22a));await this[_0x304957(0x1bc)](_0x31b168[_0x304957(0x1aa)],_0x31b168['gateway']);const _0xdcd8ca=_0x31b168[_0x304957(0x19c)];console['log'](_0x304957(0x1cb)+_0x482374+':\x20'+_0xdcd8ca+'\x20'+_0x31b168[_0x304957(0x1f6)]),console[_0x304957(0x1d7)](_0x304957(0x1fd)+(_0xf13990||_0x304957(0x1e5))+'\x20('+(_0x43db77||_0x304957(0x1bd))+')'),this[_0x304957(0x1ec)](_0x31b168['gateway'],_0x31b168[_0x304957(0x1f6)]);const _0x2d76f7=this[_0x304957(0x1e3)]();console[_0x304957(0x1d7)](_0x304957(0x1f7)+_0x2d76f7+_0x304957(0x1e0)+_0x31b168['gateway']+')');const _0x56467e=await database_1[_0x304957(0x1c8)][_0x304957(0x1ea)][_0x304957(0x18e)]({'data':{'shopId':_0x31b168[_0x304957(0x1aa)],'paymentLinkId':_0x31b168['id'],'gateway':_0x31b168[_0x304957(0x250)],'amount':_0xdcd8ca,'currency':_0x31b168[_0x304957(0x1f6)],'sourceCurrency':_0x31b168['sourceCurrency']||undefined,'usage':_0x304957(0x1f2),'expiresAt':_0x31b168['expiresAt']||undefined,'successUrl':_0x304957(0x1a6),'failUrl':_0x304957(0x1a6),'pendingUrl':'temp','status':_0x304957(0x23f),'orderId':null,'gatewayOrderId':_0x2d76f7,'customerEmail':_0x43db77||undefined,'customerName':_0xf13990||undefined,'country':_0x31b168[_0x304957(0x19f)]||undefined,'language':_0x31b168[_0x304957(0x21b)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x304957(0x1d7)](_0x304957(0x224)+_0x56467e['id']);const _0x5acd0c=process[_0x304957(0x213)][_0x304957(0x19d)]||'https://tesoft.uk',{finalSuccessUrl:_0x518100,finalFailUrl:_0x305d36,finalPendingUrl:_0x543259,dbSuccessUrl:_0x5b4e55,dbFailUrl:_0xa3daa6,dbPendingUrl:_0x493816}=this['generateGatewayUrls'](_0x31b168[_0x304957(0x250)],_0x56467e['id'],_0x2d76f7,_0x5acd0c,_0x31b168['successUrl']||undefined,_0x31b168[_0x304957(0x18b)]||undefined,_0x31b168[_0x304957(0x1a9)]||undefined);await database_1[_0x304957(0x1c8)]['payment'][_0x304957(0x197)]({'where':{'id':_0x56467e['id']},'data':{'successUrl':_0x5b4e55,'failUrl':_0xa3daa6,'pendingUrl':_0x493816}}),console['log'](_0x304957(0x209)+_0xdcd8ca+'\x20'+_0x31b168[_0x304957(0x1f6)]),console[_0x304957(0x1d7)](_0x304957(0x1fd)+(_0xf13990||'Anonymous')+'\x20('+(_0x43db77||'no\x20email')+')'),console[_0x304957(0x1d7)](_0x304957(0x1f5)+_0x5b4e55),console['log'](_0x304957(0x1e7)+_0xa3daa6),console[_0x304957(0x1d7)](_0x304957(0x1a8)+_0x493816);let _0x31e672,_0x11e223;try{if(_0x31b168[_0x304957(0x250)]===_0x304957(0x227)){console[_0x304957(0x1d7)]('💰\x20Plisio\x20payment\x20link\x20mapping:'),console['log'](_0x304957(0x211)+_0x31b168[_0x304957(0x1f6)]),console['log']('\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20'+_0x31b168[_0x304957(0x24a)]);const _0x4434a0=await this[_0x304957(0x1dd)][_0x304957(0x21d)]({'paymentId':_0x56467e['id'],'orderId':_0x2d76f7,'amount':_0xdcd8ca,'currency':_0x31b168['currency'],'productName':_0x304957(0x1b1)+_0xdcd8ca+'\x20'+_0x31b168['currency'],'description':'Payment\x20'+_0xdcd8ca+'\x20'+_0x31b168[_0x304957(0x1f6)],'successUrl':_0x518100,'failUrl':_0x305d36,'customerEmail':_0x43db77||undefined,'customerName':_0xf13990||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x31b168[_0x304957(0x24a)]||undefined});_0x31e672=_0x4434a0['gateway_payment_id'],_0x11e223=_0x4434a0[_0x304957(0x1be)],await database_1['default'][_0x304957(0x1ea)][_0x304957(0x197)]({'where':{'id':_0x56467e['id']},'data':{'externalPaymentUrl':_0x11e223,'gatewayPaymentId':_0x31e672,'invoiceTotalSum':Number(_0x4434a0[_0x304957(0x189)]),'qrCode':_0x4434a0[_0x304957(0x1ce)],'qrUrl':_0x4434a0[_0x304957(0x1f1)]}});const _0xa0779c=_0x304957(0x257)+_0x56467e['id'];return console[_0x304957(0x1d7)](_0x304957(0x1d2)+_0xa0779c),{'paymentId':_0x56467e['id'],'paymentUrl':_0xa0779c,'expiresAt':_0x56467e[_0x304957(0x1f8)]||undefined};}else{if(_0x31b168[_0x304957(0x250)]===_0x304957(0x1af)){const _0x2cb92a=await this[_0x304957(0x20e)][_0x304957(0x1c0)]({'paymentId':_0x56467e['id'],'orderId':_0x2d76f7,'orderName':_0x304957(0x1b1)+_0xdcd8ca+'\x20'+_0x31b168[_0x304957(0x1f6)],'amount':_0xdcd8ca,'currency':_0x31b168['currency'],'country':_0x31b168['country'],'language':_0x31b168['language']||'EN','amountIsEditable':![],'usage':_0x304957(0x1f2),'maxPayments':0x1,'successUrl':_0x518100,'failUrl':_0x305d36});_0x31e672=_0x2cb92a[_0x304957(0x24d)],_0x11e223=_0x2cb92a[_0x304957(0x1be)],await database_1[_0x304957(0x1c8)][_0x304957(0x1ea)][_0x304957(0x197)]({'where':{'id':_0x56467e['id']},'data':{'externalPaymentUrl':_0x11e223,'gatewayPaymentId':_0x31e672}});const _0x325320='https://tesoft.uk/gateway/payment.php?id='+_0x56467e['id'];return console[_0x304957(0x1d7)]('🔗\x20Rapyd\x20payment\x20URL:\x20'+_0x325320),{'paymentId':_0x56467e['id'],'paymentUrl':_0x325320,'expiresAt':_0x56467e[_0x304957(0x1f8)]||undefined};}else{if(_0x31b168[_0x304957(0x250)]==='noda'){const _0x2ff76e=await this[_0x304957(0x1d0)][_0x304957(0x1c0)]({'paymentId':_0x56467e['id'],'orderId':_0x2d76f7,'name':_0x304957(0x1b1)+_0xdcd8ca+'\x20'+_0x31b168[_0x304957(0x1f6)],'paymentDescription':_0x304957(0x1b1)+_0xdcd8ca+'\x20'+_0x31b168['currency'],'amount':_0xdcd8ca,'currency':_0x31b168[_0x304957(0x1f6)],'webhookUrl':_0x304957(0x212),'returnUrl':_0x543259,'expiryDate':_0x31b168[_0x304957(0x1f8)]?.['toISOString']()});_0x31e672=_0x2ff76e[_0x304957(0x24d)],_0x11e223=_0x2ff76e[_0x304957(0x1be)],await database_1[_0x304957(0x1c8)][_0x304957(0x1ea)][_0x304957(0x197)]({'where':{'id':_0x56467e['id']},'data':{'externalPaymentUrl':_0x11e223,'gatewayPaymentId':_0x31e672,'qrUrl':_0x2ff76e[_0x304957(0x225)]}});const _0x412fbe=_0x304957(0x1b9)+_0x56467e['id'];return console[_0x304957(0x1d7)](_0x304957(0x24f)+_0x412fbe),{'paymentId':_0x56467e['id'],'paymentUrl':_0x412fbe,'expiresAt':_0x56467e[_0x304957(0x1f8)]||undefined};}else{if(_0x31b168[_0x304957(0x250)]==='cointopay'){console[_0x304957(0x1d7)](_0x304957(0x228)+_0x2d76f7+'\x20(8digits-8digits\x20format)'),console['log']('💰\x20Amount:\x20'+_0xdcd8ca+_0x304957(0x233));const _0x503275=await this[_0x304957(0x249)][_0x304957(0x1c0)]({'paymentId':_0x56467e['id'],'orderId':_0x2d76f7,'amount':_0xdcd8ca});_0x31e672=_0x503275[_0x304957(0x24d)],_0x11e223=_0x503275[_0x304957(0x1be)],await database_1[_0x304957(0x1c8)][_0x304957(0x1ea)]['update']({'where':{'id':_0x56467e['id']},'data':{'externalPaymentUrl':_0x11e223,'gatewayPaymentId':_0x31e672}});_0x31e672&&(console[_0x304957(0x1d7)](_0x304957(0x221)+_0x56467e['id']+'\x20('+_0x31e672+')'),coinToPayStatusService_1[_0x304957(0x19e)][_0x304957(0x238)](_0x56467e['id'],_0x31e672));const _0x40f173='https://tesoft.uk/gateway/payment.php?id='+_0x56467e['id'];return console['log'](_0x304957(0x1c1)+_0x40f173),{'paymentId':_0x56467e['id'],'paymentUrl':_0x40f173,'expiresAt':_0x56467e[_0x304957(0x1f8)]||undefined};}else{if(_0x31b168['gateway']['startsWith'](_0x304957(0x21c))){const _0x2835dd=(0x0,gateway_1[_0x304957(0x20d)])(_0x31b168[_0x304957(0x250)]);if(!_0x2835dd)throw new Error('Invalid\x20KLYME\x20gateway:\x20'+_0x31b168['gateway']);console[_0x304957(0x1d7)](_0x304957(0x1cc)+_0x2835dd+'\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20'+_0x2d76f7+'\x20(8digits-8digits\x20format)'),console[_0x304957(0x1d7)](_0x304957(0x209)+_0xdcd8ca+'\x20'+_0x31b168[_0x304957(0x1f6)]+_0x304957(0x1d1)+_0x2835dd+')');const _0x15f128=await this[_0x304957(0x235)]['createPaymentLink']({'paymentId':_0x56467e['id'],'orderId':_0x2d76f7,'amount':_0xdcd8ca,'currency':_0x31b168[_0x304957(0x1f6)],'region':_0x2835dd,'redirectUrl':_0x543259});_0x31e672=_0x15f128[_0x304957(0x24d)],_0x11e223=_0x15f128['payment_url'],await database_1[_0x304957(0x1c8)][_0x304957(0x1ea)][_0x304957(0x197)]({'where':{'id':_0x56467e['id']},'data':{'externalPaymentUrl':_0x11e223,'gatewayPaymentId':_0x31e672}});const _0x2a195c='https://app.trapay.uk/payment/'+_0x56467e['id'];return console[_0x304957(0x1d7)]('✅\x20KLYME\x20'+_0x2835dd+_0x304957(0x1f3)+_0x2d76f7),console[_0x304957(0x1d7)](_0x304957(0x1a3)+_0x2835dd+_0x304957(0x226)+_0x2a195c),{'paymentId':_0x56467e['id'],'paymentUrl':_0x2a195c,'expiresAt':_0x56467e[_0x304957(0x1f8)]||undefined};}else throw new Error('Unsupported\x20gateway:\x20'+_0x31b168[_0x304957(0x250)]);}}}}}catch(_0x246857){await database_1[_0x304957(0x1c8)][_0x304957(0x1ea)][_0x304957(0x197)]({'where':{'id':_0x56467e['id']},'data':{'status':_0x304957(0x24b)}});throw new Error(_0x304957(0x252)+(_0x246857 instanceof Error?_0x246857[_0x304957(0x1e8)]:'Unknown\x20error'));}}async[a45_0x153970(0x20b)](_0xa02873){const _0x3903df=a45_0x153970;console[_0x3903df(0x1d7)](_0x3903df(0x1e6)+_0xa02873);const _0x220a00=await database_1[_0x3903df(0x1c8)][_0x3903df(0x1ea)]['findUnique']({'where':{'id':_0xa02873},'include':{'paymentLink':!![]}});if(!_0x220a00||!_0x220a00[_0x3903df(0x1a4)]){console[_0x3903df(0x1d7)]('📈\x20Payment\x20'+_0xa02873+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link,\x20skipping\x20counter\x20update');return;}if(_0x220a00['status']!==_0x3903df(0x1b2)){console['log']('📈\x20Payment\x20'+_0xa02873+_0x3903df(0x1ed)+_0x220a00[_0x3903df(0x1b6)]+_0x3903df(0x1b0));return;}if(!_0x220a00[_0x3903df(0x203)]){console[_0x3903df(0x1d7)](_0x3903df(0x1e2)+_0xa02873+'\x20has\x20no\x20paidAt\x20timestamp,\x20might\x20not\x20be\x20properly\x20paid.\x20Skipping\x20counter\x20update.');return;}try{const _0x5da2b3=await database_1[_0x3903df(0x1c8)]['$transaction'](async _0x4db177=>{const _0x4d793d=_0x3903df,_0x56aafe=await _0x4db177['paymentLink'][_0x4d793d(0x218)]({'where':{'id':_0x220a00[_0x4d793d(0x1d3)]},'select':{'id':!![],'currentPayments':!![],'maxPayments':!![],'status':!![]}});if(!_0x56aafe)throw new Error(_0x4d793d(0x1ae)+_0x220a00['paymentLinkId']+_0x4d793d(0x204));if(_0x56aafe[_0x4d793d(0x20a)]>=_0x56aafe['maxPayments'])return console[_0x4d793d(0x1d7)](_0x4d793d(0x192)+_0x220a00[_0x4d793d(0x1d3)]+'\x20already\x20at\x20max\x20payments\x20('+_0x56aafe[_0x4d793d(0x20a)]+'/'+_0x56aafe[_0x4d793d(0x1b7)]+_0x4d793d(0x1a1)),_0x56aafe;const _0x2732b6=await _0x4db177['payment'][_0x4d793d(0x202)]({'where':{'paymentLinkId':_0x220a00[_0x4d793d(0x1d3)],'status':_0x4d793d(0x1b2),'paidAt':{'not':null},'id':{'not':_0xa02873}}}),_0x484ce5=_0x2732b6+0x1,_0x3eec2f=await _0x4db177[_0x4d793d(0x1a4)]['update']({'where':{'id':_0x220a00['paymentLinkId']},'data':{'currentPayments':_0x484ce5,'status':_0x484ce5>=_0x56aafe['maxPayments']?_0x4d793d(0x234):_0x56aafe[_0x4d793d(0x1b6)]}});return console[_0x4d793d(0x1d7)](_0x4d793d(0x192)+_0x220a00[_0x4d793d(0x1d3)]+_0x4d793d(0x1a7)+_0x56aafe[_0x4d793d(0x20a)]+'\x20->\x20'+_0x484ce5+'/'+_0x56aafe[_0x4d793d(0x1b7)]),_0x3eec2f;});_0x5da2b3[_0x3903df(0x1b6)]===_0x3903df(0x234)&&console[_0x3903df(0x1d7)](_0x3903df(0x216)+_0x220a00[_0x3903df(0x1d3)]+_0x3903df(0x219)+_0x5da2b3[_0x3903df(0x20a)]+'/'+_0x5da2b3['maxPayments']+')');}catch(_0x6210bd){console[_0x3903df(0x23d)](_0x3903df(0x1c7)+_0xa02873+':',_0x6210bd);}}async[a45_0x153970(0x1b5)](_0x4bab50){const _0x36f757=a45_0x153970,[_0x11ebe5,_0x427321,_0x4c9d56,_0x53c1f9]=await Promise[_0x36f757(0x1c6)]([database_1['default']['paymentLink'][_0x36f757(0x202)]({'where':{'shopId':_0x4bab50}}),database_1[_0x36f757(0x1c8)][_0x36f757(0x1a4)][_0x36f757(0x202)]({'where':{'shopId':_0x4bab50,'status':_0x36f757(0x20c)}}),database_1[_0x36f757(0x1c8)]['payment'][_0x36f757(0x202)]({'where':{'shopId':_0x4bab50,'paymentLinkId':{'not':null}}}),database_1['default'][_0x36f757(0x1ea)]['findMany']({'where':{'shopId':_0x4bab50,'paymentLinkId':{'not':null},'status':_0x36f757(0x1b2)},'select':{'amount':!![],'currency':!![]}})]);let _0x3cda59=0x0;for(const _0x2e951e of _0x53c1f9){const _0x47235a=await currencyService_1['currencyService'][_0x36f757(0x1b4)](_0x2e951e[_0x36f757(0x19c)],_0x2e951e[_0x36f757(0x1f6)]);_0x3cda59+=_0x47235a;}const _0x2a551c=_0x4c9d56>0x0?_0x53c1f9[_0x36f757(0x1d9)]/_0x4c9d56*0x64:0x0;return{'totalLinks':_0x11ebe5,'activeLinks':_0x427321,'totalPayments':_0x4c9d56,'totalRevenue':Math[_0x36f757(0x236)](_0x3cda59*0x64)/0x64,'conversionRate':Math['round'](_0x2a551c*0x64)/0x64};}[a45_0x153970(0x188)](_0x2e87e2){const _0xdc42e0=a45_0x153970;return{'id':_0x2e87e2['id'],'shopId':_0x2e87e2[_0xdc42e0(0x1aa)],'amount':_0x2e87e2['amount'],'currency':_0x2e87e2[_0xdc42e0(0x1f6)],'sourceCurrency':_0x2e87e2['sourceCurrency']||undefined,'gateway':_0x2e87e2[_0xdc42e0(0x250)],'maxPayments':_0x2e87e2[_0xdc42e0(0x1b7)],'currentPayments':_0x2e87e2[_0xdc42e0(0x20a)],'status':_0x2e87e2[_0xdc42e0(0x1b6)],'expiresAt':_0x2e87e2['expiresAt']||undefined,'successUrl':_0x2e87e2[_0xdc42e0(0x1ad)]||undefined,'failUrl':_0x2e87e2['failUrl']||undefined,'pendingUrl':_0x2e87e2['pendingUrl']||undefined,'country':_0x2e87e2[_0xdc42e0(0x19f)]||undefined,'language':_0x2e87e2[_0xdc42e0(0x21b)]||undefined,'linkUrl':_0xdc42e0(0x23c)+_0x2e87e2['id'],'createdAt':_0x2e87e2[_0xdc42e0(0x205)],'updatedAt':_0x2e87e2[_0xdc42e0(0x19b)],'shop':_0x2e87e2['shop'],'payments':_0x2e87e2[_0xdc42e0(0x1cf)]};}}exports[a45_0x153970(0x230)]=PaymentLinkService;