'use strict';const a45_0x42cc3d=a45_0x144a;function a45_0xe14e(){const _0x2e6ede=['Invalid\x20KLYME\x20gateway:\x20','Payment\x20','createPayment','all','https://tesoft.uk/gateways/noda/webhook','EUR','update','PlisioService','https://app.trapay.uk/payment/pending','\x20(8digits-8digits\x20format)','amount','./gateways/nodaService','sourceCurrency','log','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','plisioService','klymeService','qr_code','failUrl','üë§\x20Customer:\x20','generateGatewayUrls','length','qr_url','\x20payments:\x20','getPaymentLinkById','10119456poCFfW','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','createPaymentLink','initiatePaymentFromLink','üîó\x20Plisio\x20payment\x20URL:\x20','insensitive','coinToPayService','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','gateway','round','/gateway/success.php?id=','GBP','10IciGCm','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','country','map','./gateways/klymeService','./gateways/coinToPayService','‚úÖ\x20KLYME\x20','klyme_','getKlymeRegionFromGatewayName','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','\x20payment\x20URL:\x20','246152wXtEJy','rapyd','currency','üíæ\x20DB\x20Fail\x20URL:\x20','paymentLinkId','default','generateGatewayOrderId','shopId','maxPayments','üîó\x20Creating\x20payment\x20link\x20for\x20gateway:\x20','language','currencyService','https://app.trapay.uk/payment/','findMany','üèÅ\x20Payment\x20link\x20','Invalid\x20gateway\x20ID:\x20','getGatewayNameById','startsWith','ü™ô\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','31958872IHHBQv','no\x20email','updatePaymentLink','Payment\x20link\x20has\x20reached\x20maximum\x20payments','noda','validateKlymeCurrency','1366181wAqsdD','formatPaymentLinkResponse','25718vMmmGx','gateway_payment_id','payment','\x20\x20\x20üåê\x20Gateway\x20Fail\x20URL:\x20','__esModule','name','currentPayments','../types/gateway','https://tesoft.uk','shop','createdAt','Gateway\x20error:\x20','\x20completed\x20(reached\x20max\x20payments)','findUnique','PENDING','cointopay','create','./gateways/plisioService','KlymeService','NodaService','expiresAt','https://app.trapay.uk/link/','ü™ô\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','Gateway\x20not\x20found\x20for\x20ID:\x20','üí≥\x20Creating\x20KLYME\x20','üîó\x20KLYME\x20','\x20\x20\x20üíæ\x20DB\x20Fail\x20URL:\x20','460suPrGs','getPaymentLinkStatistics','payment_url','Unknown\x20error','üîó\x20Rapyd\x20payment\x20URL:\x20','toISOString','COMPLETED','padStart','desc','üí∞\x20Amount:\x20','./currencyService','./gateways/rapydService','Payment\x20link\x20not\x20found','91146UAyhNi','üìà\x20Payment\x20link\x20','amount\x20is\x20required\x20and\x20must\x20be\x20positive','BASE_URL','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','30gkWrJn','üíæ\x20DB\x20Success\x20URL:\x20','üîó\x20Generated\x20URLs\x20for\x20','nodaService','status','üá¨üáß\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update','‚ùå\x20DB\x20Fail\x20URL:\x20','getPublicPaymentLinkData','üá¨üáß\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','https://tesoft.uk/gateway/payment.php?id=','convertToUSDT','toLowerCase','3488KybBLR','handleSuccessfulPayment','message','Payment\x20link\x20has\x20expired','findFirst','\x20(validated\x20for\x20','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','ONCE','rapydService','ACTIVE','floor','__importDefault','\x20(8digits-8digits\x20format\x20for\x20','isValidGatewayId','üîó\x20CoinToPay\x20payment\x20URL:\x20','\x20payment\x20link','count','RapydService','paymentLink','PaymentLinkService','successUrl','üí∞\x20Plisio\x20payment\x20link\x20mapping:','deletePaymentLink','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','üéØ\x20Generated\x20gateway\x20order_id:\x20','Unsupported\x20KLYME\x20region:\x20','Anonymous','347300ODaKno','üí≥\x20Initiating\x20payment\x20from\x20link\x20'];a45_0xe14e=function(){return _0x2e6ede;};return a45_0xe14e();}(function(_0x222a83,_0x4983cf){const _0x1698ee=a45_0x144a,_0x3ad418=_0x222a83();while(!![]){try{const _0x4c6485=parseInt(_0x1698ee(0x202))/0x1+parseInt(_0x1698ee(0x258))/0x2+-parseInt(_0x1698ee(0x231))/0x3*(-parseInt(_0x1698ee(0x1e9))/0x4)+parseInt(_0x1698ee(0x21f))/0x5*(-parseInt(_0x1698ee(0x22c))/0x6)+-parseInt(_0x1698ee(0x204))/0x7*(parseInt(_0x1698ee(0x23d))/0x8)+-parseInt(_0x1698ee(0x273))/0x9+-parseInt(_0x1698ee(0x1dd))/0xa*(-parseInt(_0x1698ee(0x1fc))/0xb);if(_0x4c6485===_0x4983cf)break;else _0x3ad418['push'](_0x3ad418['shift']());}catch(_0x2896dd){_0x3ad418['push'](_0x3ad418['shift']());}}}(a45_0xe14e,0xe4b27));var __importDefault=this&&this[a45_0x42cc3d(0x248)]||function(_0x5bdd6d){const _0x55c697=a45_0x42cc3d;return _0x5bdd6d&&_0x5bdd6d[_0x55c697(0x208)]?_0x5bdd6d:{'default':_0x5bdd6d};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a45_0x42cc3d(0x215)),rapydService_1=require(a45_0x42cc3d(0x22a)),nodaService_1=require(a45_0x42cc3d(0x265)),coinToPayService_1=require(a45_0x42cc3d(0x1e2)),klymeService_1=require(a45_0x42cc3d(0x1e1)),gateway_1=require(a45_0x42cc3d(0x20b)),currencyService_1=require(a45_0x42cc3d(0x229));function a45_0x144a(_0x158d4b,_0x515300){const _0xe14e03=a45_0xe14e();return a45_0x144a=function(_0x144ad1,_0x1dae30){_0x144ad1=_0x144ad1-0x1d9;let _0xa6ac2=_0xe14e03[_0x144ad1];return _0xa6ac2;},a45_0x144a(_0x158d4b,_0x515300);}class PaymentLinkService{constructor(){const _0x3d12f8=a45_0x42cc3d;this[_0x3d12f8(0x269)]=new plisioService_1[(_0x3d12f8(0x261))](),this[_0x3d12f8(0x245)]=new rapydService_1[(_0x3d12f8(0x24e))](),this[_0x3d12f8(0x234)]=new nodaService_1[(_0x3d12f8(0x217))](),this[_0x3d12f8(0x279)]=new coinToPayService_1['CoinToPayService'](),this[_0x3d12f8(0x26a)]=new klymeService_1[(_0x3d12f8(0x216))]();}[a45_0x42cc3d(0x1ef)](){const _0x17956f=()=>{const _0x840dd3=a45_0x144a;return Math[_0x840dd3(0x247)](Math['random']()*0x5f5e100)['toString']()[_0x840dd3(0x226)](0x8,'0');};return _0x17956f()+'-'+_0x17956f();}[a45_0x42cc3d(0x26e)](_0x5824d1,_0x466393,_0x4261d5,_0xa1c500,_0x4965e5){const _0x226192=a45_0x42cc3d;if(_0xa1c500&&_0x4965e5)return{'finalSuccessUrl':_0xa1c500,'finalFailUrl':_0x4965e5,'dbSuccessUrl':_0xa1c500,'dbFailUrl':_0x4965e5};let _0x399e5b,_0x2555ad,_0x2c1986,_0xd2135a;return _0x5824d1===_0x226192(0x200)||_0x5824d1[_0x226192(0x1fa)](_0x226192(0x1e4))?(_0x399e5b=_0x4261d5+'/gateway/pending.php?id='+_0x466393,_0x2c1986=_0x226192(0x262)):(_0x399e5b=_0x4261d5+_0x226192(0x1db)+_0x466393,_0x2c1986='https://app.trapay.uk/payment/success'),_0x2555ad=_0x4261d5+'/gateway/fail.php?id='+_0x466393,_0xd2135a='https://app.trapay.uk/payment/fail',console[_0x226192(0x267)](_0x226192(0x233)+_0x5824d1+':'),console[_0x226192(0x267)]('\x20\x20\x20üåê\x20Gateway\x20Success\x20URL:\x20'+_0x399e5b),console[_0x226192(0x267)](_0x226192(0x207)+_0x2555ad),console[_0x226192(0x267)]('\x20\x20\x20üíæ\x20DB\x20Success\x20URL:\x20'+_0x2c1986),console['log'](_0x226192(0x21e)+_0xd2135a),{'finalSuccessUrl':_0x399e5b,'finalFailUrl':_0x2555ad,'dbSuccessUrl':_0x2c1986,'dbFailUrl':_0xd2135a};}[a45_0x42cc3d(0x201)](_0x5aac65,_0x43ac2f){const _0x2a8e1f=a45_0x42cc3d;if(!_0x5aac65['startsWith'](_0x2a8e1f(0x1e4)))return;const _0x2b5763=(0x0,gateway_1[_0x2a8e1f(0x1e5)])(_0x5aac65),_0x1b4417=_0x43ac2f['toUpperCase']();switch(_0x2b5763){case'EU':if(_0x1b4417!==_0x2a8e1f(0x25f))throw new Error(_0x2a8e1f(0x1de)+_0x1b4417);break;case'GB':if(_0x1b4417!==_0x2a8e1f(0x1dc))throw new Error(_0x2a8e1f(0x230)+_0x1b4417);break;case'DE':if(_0x1b4417!==_0x2a8e1f(0x25f))throw new Error(_0x2a8e1f(0x254)+_0x1b4417);break;default:throw new Error(_0x2a8e1f(0x256)+_0x2b5763);}}async[a45_0x42cc3d(0x275)](_0xa65b86,_0x474bdd){const _0x3e3605=a45_0x42cc3d;if(!(0x0,gateway_1['isValidGatewayId'])(_0x474bdd['gateway']))throw new Error(_0x3e3605(0x1f8)+_0x474bdd[_0x3e3605(0x1d9)]+_0x3e3605(0x243));const _0x2516ea=(0x0,gateway_1[_0x3e3605(0x1f9)])(_0x474bdd[_0x3e3605(0x1d9)]);if(!_0x2516ea)throw new Error(_0x3e3605(0x21b)+_0x474bdd[_0x3e3605(0x1d9)]);console[_0x3e3605(0x267)](_0x3e3605(0x1f2)+_0x2516ea);if(_0x2516ea==='plisio'&&!_0x474bdd['sourceCurrency'])throw new Error(_0x3e3605(0x1e6));if(_0x2516ea[_0x3e3605(0x1fa)](_0x3e3605(0x1e4))){const _0x5ad0d1=(0x0,gateway_1[_0x3e3605(0x1e5)])(_0x2516ea);console[_0x3e3605(0x267)](_0x3e3605(0x21c)+_0x5ad0d1+_0x3e3605(0x24c));}let _0x439a0d=_0x474bdd[_0x3e3605(0x1df)];_0x2516ea===_0x3e3605(0x1ea)&&(_0x439a0d='GB',console[_0x3e3605(0x267)](_0x3e3605(0x239)));if(!_0x474bdd['amount']||_0x474bdd[_0x3e3605(0x264)]<=0x0)throw new Error(_0x3e3605(0x22e));let _0x241748=_0x474bdd['currency']||'USD';_0x2516ea===_0x3e3605(0x213)&&(_0x241748=_0x3e3605(0x25f),console[_0x3e3605(0x267)]('ü™ô\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link'));this['validateKlymeCurrency'](_0x2516ea,_0x241748);const _0x132ae3=process['env'][_0x3e3605(0x22f)]||_0x3e3605(0x20c),{finalSuccessUrl:_0x39670b,finalFailUrl:_0x21458c,dbSuccessUrl:_0x42be32,dbFailUrl:_0x1026ef}=this[_0x3e3605(0x26e)](_0x2516ea,'PLACEHOLDER',_0x132ae3,_0x474bdd['successUrl'],_0x474bdd[_0x3e3605(0x26c)]),_0x1a8d28=await database_1[_0x3e3605(0x1ee)][_0x3e3605(0x24f)]['create']({'data':{'shopId':_0xa65b86,'amount':_0x474bdd['amount'],'currency':_0x241748,'sourceCurrency':_0x474bdd[_0x3e3605(0x266)]||undefined,'gateway':_0x2516ea,'maxPayments':_0x474bdd[_0x3e3605(0x1f1)]||0x1,'currentPayments':0x0,'status':'ACTIVE','expiresAt':_0x474bdd[_0x3e3605(0x218)]?new Date(_0x474bdd[_0x3e3605(0x218)]):undefined,'successUrl':_0x42be32,'failUrl':_0x1026ef,'country':_0x439a0d,'language':_0x474bdd[_0x3e3605(0x1f3)]||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console[_0x3e3605(0x267)]('‚úÖ\x20Payment\x20link\x20created:\x20'+_0x1a8d28['id']+'\x20('+_0x2516ea+')'),console[_0x3e3605(0x267)]('üí∞\x20Fixed\x20amount:\x20'+_0x1a8d28[_0x3e3605(0x264)]+'\x20'+_0x1a8d28[_0x3e3605(0x1eb)]),console[_0x3e3605(0x267)]('üîó\x20Link\x20URL:\x20https://app.trapay.uk/link/'+_0x1a8d28['id']),console[_0x3e3605(0x267)]('‚úÖ\x20DB\x20Success\x20URL:\x20'+_0x1a8d28[_0x3e3605(0x251)]),console[_0x3e3605(0x267)](_0x3e3605(0x237)+_0x1a8d28[_0x3e3605(0x26c)]),this[_0x3e3605(0x203)](_0x1a8d28);}async['getPaymentLinks'](_0xc6cbd2,_0x24d9bf){const _0x57e500=a45_0x42cc3d,{page:_0x24ad17,limit:_0x1344a2,status:_0x3cd752,gateway:_0x49bac8,search:_0x3307dc}=_0x24d9bf,_0x2a5989=(_0x24ad17-0x1)*_0x1344a2,_0x2eca4e={'shopId':_0xc6cbd2};_0x3cd752&&(_0x2eca4e['status']=_0x3cd752['toUpperCase']());if(_0x49bac8){if((0x0,gateway_1['isValidGatewayId'])(_0x49bac8)){const _0x534228=(0x0,gateway_1[_0x57e500(0x1f9)])(_0x49bac8);_0x534228&&(_0x2eca4e['gateway']=_0x534228);}else _0x2eca4e[_0x57e500(0x1d9)]=_0x49bac8[_0x57e500(0x23c)]();}_0x3307dc&&(_0x2eca4e['OR']=[{'gateway':{'contains':_0x3307dc,'mode':_0x57e500(0x278)}},{'currency':{'contains':_0x3307dc,'mode':_0x57e500(0x278)}}]);const [_0x5bfd77,_0x470549]=await Promise[_0x57e500(0x25d)]([database_1['default']['paymentLink'][_0x57e500(0x1f6)]({'where':_0x2eca4e,'skip':_0x2a5989,'take':_0x1344a2,'orderBy':{'createdAt':_0x57e500(0x227)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}}),database_1[_0x57e500(0x1ee)][_0x57e500(0x24f)][_0x57e500(0x24d)]({'where':_0x2eca4e})]);return{'links':_0x5bfd77[_0x57e500(0x1e0)](_0x437999=>this[_0x57e500(0x203)](_0x437999)),'pagination':{'page':_0x24ad17,'limit':_0x1344a2,'total':_0x470549,'totalPages':Math['ceil'](_0x470549/_0x1344a2)}};}async[a45_0x42cc3d(0x272)](_0x1bcca0,_0x4a8b34){const _0x16679b=a45_0x42cc3d,_0x4e08a7=await database_1['default'][_0x16679b(0x24f)][_0x16679b(0x241)]({'where':{'id':_0x4a8b34,'shopId':_0x1bcca0},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x16679b(0x227)}}}});if(!_0x4e08a7)return null;return this[_0x16679b(0x203)](_0x4e08a7);}async[a45_0x42cc3d(0x1fe)](_0x3475a7,_0x3ccac7,_0x4311df){const _0x39c41f=a45_0x42cc3d,_0x162c30={..._0x4311df};if(_0x4311df[_0x39c41f(0x1d9)]){if((0x0,gateway_1[_0x39c41f(0x24a)])(_0x4311df[_0x39c41f(0x1d9)])){const _0x3f55a6=(0x0,gateway_1[_0x39c41f(0x1f9)])(_0x4311df[_0x39c41f(0x1d9)]);_0x3f55a6&&(_0x162c30[_0x39c41f(0x1d9)]=_0x3f55a6);}else _0x162c30[_0x39c41f(0x1d9)]=_0x4311df[_0x39c41f(0x1d9)]['toLowerCase']();}(_0x162c30[_0x39c41f(0x1d9)]===_0x39c41f(0x1ea)||_0x4311df['country']&&_0x162c30['gateway']!==_0x39c41f(0x1ea))&&(_0x162c30['gateway']===_0x39c41f(0x1ea)&&(_0x162c30[_0x39c41f(0x1df)]='GB',console[_0x39c41f(0x267)](_0x39c41f(0x236))));_0x162c30['gateway']===_0x39c41f(0x213)&&(_0x162c30['currency']=_0x39c41f(0x25f),console[_0x39c41f(0x267)](_0x39c41f(0x21a)));_0x162c30[_0x39c41f(0x1d9)]&&_0x162c30[_0x39c41f(0x1eb)]&&this[_0x39c41f(0x201)](_0x162c30['gateway'],_0x162c30[_0x39c41f(0x1eb)]);_0x4311df[_0x39c41f(0x218)]&&(_0x162c30['expiresAt']=new Date(_0x4311df[_0x39c41f(0x218)]));const _0x37ac80=await database_1[_0x39c41f(0x1ee)][_0x39c41f(0x24f)][_0x39c41f(0x260)]({'where':{'id':_0x3ccac7,'shopId':_0x3475a7},'data':_0x162c30,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa}}});return this[_0x39c41f(0x203)](_0x37ac80);}async[a45_0x42cc3d(0x253)](_0x3f7aee,_0x4de406){const _0x4f331f=a45_0x42cc3d;await database_1[_0x4f331f(0x1ee)][_0x4f331f(0x24f)]['delete']({'where':{'id':_0x4de406,'shopId':_0x3f7aee}});}async[a45_0x42cc3d(0x238)](_0x11e083){const _0x244d8f=a45_0x42cc3d,_0xd97548=await database_1[_0x244d8f(0x1ee)][_0x244d8f(0x24f)]['findUnique']({'where':{'id':_0x11e083},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0xd97548)return null;const _0xec7d20=_0xd97548['expiresAt']&&_0xd97548[_0x244d8f(0x218)]<new Date(),_0x176c92=_0xd97548[_0x244d8f(0x20a)]>=_0xd97548['maxPayments'],_0x4d8005=_0xd97548[_0x244d8f(0x20d)][_0x244d8f(0x235)]==='ACTIVE',_0x223448=_0xd97548['status']===_0x244d8f(0x246),_0x3a3054=!_0xec7d20&&!_0x176c92&&_0x4d8005&&_0x223448,_0x42f4c5=Math['max'](0x0,_0xd97548['maxPayments']-_0xd97548[_0x244d8f(0x20a)]);return{'id':_0xd97548['id'],'amount':_0xd97548[_0x244d8f(0x264)],'currency':_0xd97548['currency'],'sourceCurrency':_0xd97548[_0x244d8f(0x266)]||undefined,'gateway':_0xd97548[_0x244d8f(0x1d9)],'maxPayments':_0xd97548[_0x244d8f(0x1f1)],'currentPayments':_0xd97548[_0x244d8f(0x20a)],'status':_0xd97548[_0x244d8f(0x235)],'expiresAt':_0xd97548[_0x244d8f(0x218)]||undefined,'shopName':_0xd97548[_0x244d8f(0x20d)][_0x244d8f(0x209)],'isAvailable':_0x3a3054,'remainingPayments':_0x42f4c5};}async[a45_0x42cc3d(0x276)](_0x284f65){const _0x5a03b9=a45_0x42cc3d,{linkId:_0x68d6b3,customerEmail:_0x31ae80,customerName:_0x3b5a27}=_0x284f65,_0x40ac4a=await database_1['default'][_0x5a03b9(0x24f)][_0x5a03b9(0x211)]({'where':{'id':_0x68d6b3},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![]}}}});if(!_0x40ac4a)throw new Error(_0x5a03b9(0x22b));const _0x5842ca=_0x40ac4a['expiresAt']&&_0x40ac4a[_0x5a03b9(0x218)]<new Date(),_0x54874c=_0x40ac4a[_0x5a03b9(0x20a)]>=_0x40ac4a[_0x5a03b9(0x1f1)],_0x22273c=_0x40ac4a['shop'][_0x5a03b9(0x235)]==='ACTIVE',_0x29fdd0=_0x40ac4a[_0x5a03b9(0x235)]===_0x5a03b9(0x246);if(_0x5842ca)throw new Error(_0x5a03b9(0x240));if(_0x54874c)throw new Error(_0x5a03b9(0x1ff));if(!_0x22273c)throw new Error('Shop\x20is\x20not\x20active');if(!_0x29fdd0)throw new Error('Payment\x20link\x20is\x20not\x20active');const _0xb9d079=_0x40ac4a[_0x5a03b9(0x264)];console[_0x5a03b9(0x267)](_0x5a03b9(0x259)+_0x68d6b3+':\x20'+_0xb9d079+'\x20'+_0x40ac4a[_0x5a03b9(0x1eb)]),console[_0x5a03b9(0x267)]('üë§\x20Customer:\x20'+(_0x3b5a27||_0x5a03b9(0x257))+'\x20('+(_0x31ae80||_0x5a03b9(0x1fd))+')'),this[_0x5a03b9(0x201)](_0x40ac4a[_0x5a03b9(0x1d9)],_0x40ac4a[_0x5a03b9(0x1eb)]);const _0x542f2d=this[_0x5a03b9(0x1ef)]();console[_0x5a03b9(0x267)](_0x5a03b9(0x255)+_0x542f2d+_0x5a03b9(0x249)+_0x40ac4a[_0x5a03b9(0x1d9)]+')');const _0x5d8d18=process['env'][_0x5a03b9(0x22f)]||_0x5a03b9(0x20c),{finalSuccessUrl:_0x4e2a7d,finalFailUrl:_0x44d658,dbSuccessUrl:_0x5f3bec,dbFailUrl:_0x352d4f}=this['generateGatewayUrls'](_0x40ac4a[_0x5a03b9(0x1d9)],_0x542f2d,_0x5d8d18,_0x40ac4a[_0x5a03b9(0x251)]||undefined,_0x40ac4a['failUrl']||undefined),_0x51c57b=await database_1[_0x5a03b9(0x1ee)]['payment'][_0x5a03b9(0x214)]({'data':{'shopId':_0x40ac4a[_0x5a03b9(0x1f0)],'paymentLinkId':_0x40ac4a['id'],'gateway':_0x40ac4a[_0x5a03b9(0x1d9)],'amount':_0xb9d079,'currency':_0x40ac4a[_0x5a03b9(0x1eb)],'sourceCurrency':_0x40ac4a['sourceCurrency']||undefined,'usage':_0x5a03b9(0x244),'expiresAt':_0x40ac4a[_0x5a03b9(0x218)]||undefined,'successUrl':_0x5f3bec,'failUrl':_0x352d4f,'status':_0x5a03b9(0x212),'orderId':null,'gatewayOrderId':_0x542f2d,'customerEmail':_0x31ae80||undefined,'customerName':_0x3b5a27||undefined,'country':_0x40ac4a[_0x5a03b9(0x1df)]||undefined,'language':_0x40ac4a['language']||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x5a03b9(0x267)]('üíæ\x20Payment\x20created\x20from\x20link:\x20'+_0x51c57b['id']),console[_0x5a03b9(0x267)](_0x5a03b9(0x228)+_0xb9d079+'\x20'+_0x40ac4a[_0x5a03b9(0x1eb)]),console[_0x5a03b9(0x267)](_0x5a03b9(0x26d)+(_0x3b5a27||_0x5a03b9(0x257))+'\x20('+(_0x31ae80||_0x5a03b9(0x1fd))+')'),console['log'](_0x5a03b9(0x232)+_0x5f3bec),console[_0x5a03b9(0x267)](_0x5a03b9(0x1ec)+_0x352d4f);let _0x2c1ae6,_0x299f62;try{if(_0x40ac4a[_0x5a03b9(0x1d9)]==='plisio'){console[_0x5a03b9(0x267)](_0x5a03b9(0x252)),console[_0x5a03b9(0x267)](_0x5a03b9(0x27a)+_0x40ac4a[_0x5a03b9(0x1eb)]),console[_0x5a03b9(0x267)]('\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20'+_0x40ac4a[_0x5a03b9(0x266)]);const _0x2fff30=await this[_0x5a03b9(0x269)][_0x5a03b9(0x25c)]({'paymentId':_0x51c57b['id'],'orderId':_0x542f2d,'amount':_0xb9d079,'currency':_0x40ac4a[_0x5a03b9(0x1eb)],'productName':'Payment\x20'+_0xb9d079+'\x20'+_0x40ac4a[_0x5a03b9(0x1eb)],'description':_0x5a03b9(0x25b)+_0xb9d079+'\x20'+_0x40ac4a[_0x5a03b9(0x1eb)],'successUrl':_0x4e2a7d,'failUrl':_0x44d658,'customerEmail':_0x31ae80||undefined,'customerName':_0x3b5a27||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x40ac4a['sourceCurrency']||undefined});_0x2c1ae6=_0x2fff30[_0x5a03b9(0x205)],_0x299f62=_0x2fff30[_0x5a03b9(0x221)],await database_1[_0x5a03b9(0x1ee)][_0x5a03b9(0x206)][_0x5a03b9(0x260)]({'where':{'id':_0x51c57b['id']},'data':{'externalPaymentUrl':_0x299f62,'gatewayPaymentId':_0x2c1ae6,'invoiceTotalSum':Number(_0x2fff30['invoice_total_sum']),'qrCode':_0x2fff30[_0x5a03b9(0x26b)],'qrUrl':_0x2fff30[_0x5a03b9(0x270)]}});const _0x49fb8=_0x5a03b9(0x1f5)+_0x51c57b['id'];return console[_0x5a03b9(0x267)](_0x5a03b9(0x277)+_0x49fb8),{'paymentId':_0x51c57b['id'],'paymentUrl':_0x49fb8,'expiresAt':_0x51c57b[_0x5a03b9(0x218)]||undefined};}else{if(_0x40ac4a[_0x5a03b9(0x1d9)]===_0x5a03b9(0x1ea)){const _0x3df8df=await this[_0x5a03b9(0x245)][_0x5a03b9(0x275)]({'paymentId':_0x51c57b['id'],'orderId':_0x542f2d,'orderName':_0x5a03b9(0x25b)+_0xb9d079+'\x20'+_0x40ac4a[_0x5a03b9(0x1eb)],'amount':_0xb9d079,'currency':_0x40ac4a[_0x5a03b9(0x1eb)],'country':_0x40ac4a[_0x5a03b9(0x1df)],'language':_0x40ac4a[_0x5a03b9(0x1f3)]||'EN','amountIsEditable':![],'usage':_0x5a03b9(0x244),'maxPayments':0x1,'successUrl':_0x4e2a7d,'failUrl':_0x44d658});_0x2c1ae6=_0x3df8df[_0x5a03b9(0x205)],_0x299f62=_0x3df8df[_0x5a03b9(0x221)],await database_1[_0x5a03b9(0x1ee)][_0x5a03b9(0x206)][_0x5a03b9(0x260)]({'where':{'id':_0x51c57b['id']},'data':{'externalPaymentUrl':_0x299f62,'gatewayPaymentId':_0x2c1ae6}});const _0x304d76=_0x5a03b9(0x23a)+_0x51c57b['id'];return console[_0x5a03b9(0x267)](_0x5a03b9(0x223)+_0x304d76),{'paymentId':_0x51c57b['id'],'paymentUrl':_0x304d76,'expiresAt':_0x51c57b[_0x5a03b9(0x218)]||undefined};}else{if(_0x40ac4a[_0x5a03b9(0x1d9)]===_0x5a03b9(0x200)){const _0x2ac3a4=await this[_0x5a03b9(0x234)][_0x5a03b9(0x275)]({'paymentId':_0x51c57b['id'],'orderId':_0x542f2d,'name':'Payment\x20'+_0xb9d079+'\x20'+_0x40ac4a[_0x5a03b9(0x1eb)],'paymentDescription':_0x5a03b9(0x25b)+_0xb9d079+'\x20'+_0x40ac4a[_0x5a03b9(0x1eb)],'amount':_0xb9d079,'currency':_0x40ac4a[_0x5a03b9(0x1eb)],'webhookUrl':_0x5a03b9(0x25e),'returnUrl':_0x4e2a7d,'expiryDate':_0x40ac4a[_0x5a03b9(0x218)]?.[_0x5a03b9(0x224)]()});_0x2c1ae6=_0x2ac3a4[_0x5a03b9(0x205)],_0x299f62=_0x2ac3a4[_0x5a03b9(0x221)],await database_1[_0x5a03b9(0x1ee)][_0x5a03b9(0x206)][_0x5a03b9(0x260)]({'where':{'id':_0x51c57b['id']},'data':{'externalPaymentUrl':_0x299f62,'gatewayPaymentId':_0x2c1ae6,'qrUrl':_0x2ac3a4['qr_code_url']}});const _0x4402fa=_0x5a03b9(0x23a)+_0x51c57b['id'];return console[_0x5a03b9(0x267)]('üîó\x20Noda\x20payment\x20URL:\x20'+_0x4402fa),{'paymentId':_0x51c57b['id'],'paymentUrl':_0x4402fa,'expiresAt':_0x51c57b[_0x5a03b9(0x218)]||undefined};}else{if(_0x40ac4a[_0x5a03b9(0x1d9)]===_0x5a03b9(0x213)){console['log'](_0x5a03b9(0x1fb)+_0x542f2d+'\x20(8digits-8digits\x20format)'),console[_0x5a03b9(0x267)](_0x5a03b9(0x228)+_0xb9d079+_0x5a03b9(0x1e7));const _0x26349b=await this['coinToPayService'][_0x5a03b9(0x275)]({'paymentId':_0x51c57b['id'],'orderId':_0x542f2d,'amount':_0xb9d079});_0x2c1ae6=_0x26349b['gateway_payment_id'],_0x299f62=_0x26349b['payment_url'],await database_1[_0x5a03b9(0x1ee)][_0x5a03b9(0x206)]['update']({'where':{'id':_0x51c57b['id']},'data':{'externalPaymentUrl':_0x299f62,'gatewayPaymentId':_0x2c1ae6}});const _0x560ea8=_0x5a03b9(0x23a)+_0x51c57b['id'];return console[_0x5a03b9(0x267)](_0x5a03b9(0x24b)+_0x560ea8),{'paymentId':_0x51c57b['id'],'paymentUrl':_0x560ea8,'expiresAt':_0x51c57b[_0x5a03b9(0x218)]||undefined};}else{if(_0x40ac4a[_0x5a03b9(0x1d9)]['startsWith'](_0x5a03b9(0x1e4))){const _0x47a4b0=(0x0,gateway_1[_0x5a03b9(0x1e5)])(_0x40ac4a['gateway']);if(!_0x47a4b0)throw new Error(_0x5a03b9(0x25a)+_0x40ac4a['gateway']);console[_0x5a03b9(0x267)](_0x5a03b9(0x21c)+_0x47a4b0+_0x5a03b9(0x274)+_0x542f2d+_0x5a03b9(0x263)),console[_0x5a03b9(0x267)](_0x5a03b9(0x228)+_0xb9d079+'\x20'+_0x40ac4a[_0x5a03b9(0x1eb)]+_0x5a03b9(0x242)+_0x47a4b0+')');const _0xdfd662=await this[_0x5a03b9(0x26a)]['createPaymentLink']({'paymentId':_0x51c57b['id'],'orderId':_0x542f2d,'amount':_0xb9d079,'currency':_0x40ac4a[_0x5a03b9(0x1eb)],'region':_0x47a4b0,'redirectUrl':_0x4e2a7d});_0x2c1ae6=_0xdfd662['gateway_payment_id'],_0x299f62=_0xdfd662[_0x5a03b9(0x221)],await database_1[_0x5a03b9(0x1ee)][_0x5a03b9(0x206)]['update']({'where':{'id':_0x51c57b['id']},'data':{'externalPaymentUrl':_0x299f62,'gatewayPaymentId':_0x2c1ae6}});const _0x4f2e03=_0x5a03b9(0x1f5)+_0x51c57b['id'];return console[_0x5a03b9(0x267)](_0x5a03b9(0x1e3)+_0x47a4b0+_0x5a03b9(0x268)+_0x542f2d),console['log'](_0x5a03b9(0x21d)+_0x47a4b0+_0x5a03b9(0x1e8)+_0x4f2e03),{'paymentId':_0x51c57b['id'],'paymentUrl':_0x4f2e03,'expiresAt':_0x51c57b[_0x5a03b9(0x218)]||undefined};}else throw new Error('Unsupported\x20gateway:\x20'+_0x40ac4a['gateway']);}}}}}catch(_0x45e647){await database_1['default'][_0x5a03b9(0x206)][_0x5a03b9(0x260)]({'where':{'id':_0x51c57b['id']},'data':{'status':'FAILED'}});throw new Error(_0x5a03b9(0x20f)+(_0x45e647 instanceof Error?_0x45e647[_0x5a03b9(0x23f)]:_0x5a03b9(0x222)));}}async[a45_0x42cc3d(0x23e)](_0x2361ec){const _0x30e1f1=a45_0x42cc3d,_0xc5068b=await database_1[_0x30e1f1(0x1ee)][_0x30e1f1(0x206)]['findUnique']({'where':{'id':_0x2361ec},'include':{'paymentLink':!![]}});if(!_0xc5068b||!_0xc5068b[_0x30e1f1(0x24f)])return;const _0x3611b4=await database_1[_0x30e1f1(0x1ee)][_0x30e1f1(0x24f)][_0x30e1f1(0x260)]({'where':{'id':_0xc5068b['paymentLinkId']},'data':{'currentPayments':{'increment':0x1}}});console[_0x30e1f1(0x267)](_0x30e1f1(0x22d)+_0xc5068b[_0x30e1f1(0x1ed)]+_0x30e1f1(0x271)+_0x3611b4[_0x30e1f1(0x20a)]+'/'+_0x3611b4[_0x30e1f1(0x1f1)]),_0x3611b4['currentPayments']>=_0x3611b4[_0x30e1f1(0x1f1)]&&(await database_1[_0x30e1f1(0x1ee)][_0x30e1f1(0x24f)]['update']({'where':{'id':_0xc5068b[_0x30e1f1(0x1ed)]},'data':{'status':_0x30e1f1(0x225)}}),console[_0x30e1f1(0x267)](_0x30e1f1(0x1f7)+_0xc5068b['paymentLinkId']+_0x30e1f1(0x210)));}async[a45_0x42cc3d(0x220)](_0x360545){const _0x48bc2b=a45_0x42cc3d,[_0x4a44ab,_0x886d38,_0x37a247,_0x1c283a]=await Promise[_0x48bc2b(0x25d)]([database_1[_0x48bc2b(0x1ee)]['paymentLink']['count']({'where':{'shopId':_0x360545}}),database_1[_0x48bc2b(0x1ee)][_0x48bc2b(0x24f)][_0x48bc2b(0x24d)]({'where':{'shopId':_0x360545,'status':'ACTIVE'}}),database_1[_0x48bc2b(0x1ee)][_0x48bc2b(0x206)][_0x48bc2b(0x24d)]({'where':{'shopId':_0x360545,'paymentLinkId':{'not':null}}}),database_1['default']['payment'][_0x48bc2b(0x1f6)]({'where':{'shopId':_0x360545,'paymentLinkId':{'not':null},'status':'PAID'},'select':{'amount':!![],'currency':!![]}})]);let _0x317d1f=0x0;for(const _0x2c656b of _0x1c283a){const _0x4ed21b=await currencyService_1[_0x48bc2b(0x1f4)][_0x48bc2b(0x23b)](_0x2c656b[_0x48bc2b(0x264)],_0x2c656b[_0x48bc2b(0x1eb)]);_0x317d1f+=_0x4ed21b;}const _0x20214c=_0x37a247>0x0?_0x1c283a[_0x48bc2b(0x26f)]/_0x37a247*0x64:0x0;return{'totalLinks':_0x4a44ab,'activeLinks':_0x886d38,'totalPayments':_0x37a247,'totalRevenue':Math[_0x48bc2b(0x1da)](_0x317d1f*0x64)/0x64,'conversionRate':Math['round'](_0x20214c*0x64)/0x64};}[a45_0x42cc3d(0x203)](_0x216e43){const _0x41a91d=a45_0x42cc3d;return{'id':_0x216e43['id'],'shopId':_0x216e43[_0x41a91d(0x1f0)],'amount':_0x216e43[_0x41a91d(0x264)],'currency':_0x216e43[_0x41a91d(0x1eb)],'sourceCurrency':_0x216e43['sourceCurrency']||undefined,'gateway':_0x216e43[_0x41a91d(0x1d9)],'maxPayments':_0x216e43[_0x41a91d(0x1f1)],'currentPayments':_0x216e43[_0x41a91d(0x20a)],'status':_0x216e43[_0x41a91d(0x235)],'expiresAt':_0x216e43[_0x41a91d(0x218)]||undefined,'successUrl':_0x216e43[_0x41a91d(0x251)]||undefined,'failUrl':_0x216e43[_0x41a91d(0x26c)]||undefined,'country':_0x216e43['country']||undefined,'language':_0x216e43[_0x41a91d(0x1f3)]||undefined,'linkUrl':_0x41a91d(0x219)+_0x216e43['id'],'createdAt':_0x216e43[_0x41a91d(0x20e)],'updatedAt':_0x216e43['updatedAt'],'shop':_0x216e43['shop'],'payments':_0x216e43['payments']};}}exports[a45_0x42cc3d(0x250)]=PaymentLinkService;