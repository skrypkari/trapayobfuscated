'use strict';const a83_0x528c71=a83_0x3c18;(function(_0x3ad77c,_0x4313ae){const _0x8de2b4=a83_0x3c18,_0x298b41=_0x3ad77c();while(!![]){try{const _0x3aa310=parseInt(_0x8de2b4(0xa2))/0x1*(parseInt(_0x8de2b4(0x94))/0x2)+parseInt(_0x8de2b4(0xab))/0x3*(parseInt(_0x8de2b4(0x88))/0x4)+parseInt(_0x8de2b4(0xaf))/0x5+-parseInt(_0x8de2b4(0xa0))/0x6*(parseInt(_0x8de2b4(0x9e))/0x7)+parseInt(_0x8de2b4(0x89))/0x8*(parseInt(_0x8de2b4(0x8a))/0x9)+-parseInt(_0x8de2b4(0xb5))/0xa+-parseInt(_0x8de2b4(0xb3))/0xb;if(_0x3aa310===_0x4313ae)break;else _0x298b41['push'](_0x298b41['shift']());}catch(_0x3f2e97){_0x298b41['push'](_0x298b41['shift']());}}}(a83_0x39bd,0xee3ef));function a83_0x3c18(_0x4d1ae5,_0x517844){_0x4d1ae5=_0x4d1ae5-0x85;const _0x39bd16=a83_0x39bd();let _0x3c1813=_0x39bd16[_0x4d1ae5];return _0x3c1813;}var __importDefault=this&&this['__importDefault']||function(_0x2da362){const _0x43121d=a83_0x3c18;return _0x2da362&&_0x2da362[_0x43121d(0x9a)]?_0x2da362:{'default':_0x2da362};};function a83_0x39bd(){const _0xf7ad04=['Pre-payment\x20not\x20found','6010620XhKAKX','PrePaymentService','prePayment','update','EXPIRED','https://app.trapay.uk','gateway','4PwYYRP','240904FPpnDB','153tiXPsr','findUnique','successUrl','expiresAt','customAlphabet','customerIp','prePaymentService','getPrePaymentByCode','abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789','language','23690kFKquw','nanoid','status','currency','amount','../config/database','__esModule','orderId','default','sourceCurrency','3145786gwZOkU','PENDING','6gQENhF','failUrl','142wcvkNj','CONFIRMED','customerName','confirmPrePayment','shopId','createPrePayment','customerEmail','/p/','defineProperty','1187523ExnNsy','network','pendingUrl','Pre-payment\x20is\x20no\x20longer\x20available','6754515EUvDeL','customerCountry','generateUniqueShortCode','country','21057740XQIPlW'];a83_0x39bd=function(){return _0xf7ad04;};return a83_0x39bd();}Object[a83_0x528c71(0xaa)](exports,'__esModule',{'value':!![]}),exports[a83_0x528c71(0x90)]=exports['PrePaymentService']=void 0x0;const database_1=__importDefault(require(a83_0x528c71(0x99))),nanoid_1=require(a83_0x528c71(0x95)),nanoid=(0x0,nanoid_1[a83_0x528c71(0x8e)])(a83_0x528c71(0x92),0x8);class PrePaymentService{async[a83_0x528c71(0xa7)](_0x45f8f1){const _0x3692d7=a83_0x528c71,_0x4e17d8=await this[_0x3692d7(0xb1)](),_0x181785=new Date(Date['now']()+0x1e*0x3c*0x3e8),_0x5cb2d4=await database_1['default']['prePayment']['create']({'data':{'shortCode':_0x4e17d8,'shopId':_0x45f8f1[_0x3692d7(0xa6)],'gateway':_0x45f8f1[_0x3692d7(0x87)],'amount':_0x45f8f1[_0x3692d7(0x98)],'currency':_0x45f8f1['currency'],'sourceCurrency':_0x45f8f1['sourceCurrency'],'network':_0x45f8f1[_0x3692d7(0xac)],'orderId':_0x45f8f1[_0x3692d7(0x9b)],'country':_0x45f8f1[_0x3692d7(0xb2)],'language':_0x45f8f1['language'],'successUrl':_0x45f8f1[_0x3692d7(0x8c)],'failUrl':_0x45f8f1['failUrl'],'pendingUrl':_0x45f8f1[_0x3692d7(0xad)],'customerEmail':_0x45f8f1[_0x3692d7(0xa8)],'customerName':_0x45f8f1[_0x3692d7(0xa4)],'expiresAt':_0x181785,'status':_0x3692d7(0x9f)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x2b06e0=process.env.FRONTEND_URL||_0x3692d7(0x86),_0x3690da=_0x2b06e0+_0x3692d7(0xa9)+_0x4e17d8;return{'prePaymentId':_0x5cb2d4['id'],'shortCode':_0x5cb2d4['shortCode'],'proxyUrl':_0x3690da,'expiresAt':_0x5cb2d4[_0x3692d7(0x8d)]};}async[a83_0x528c71(0x91)](_0x5d1193){const _0x6d9734=a83_0x528c71,_0x2e9f30=await database_1['default'][_0x6d9734(0xb7)][_0x6d9734(0x8b)]({'where':{'shortCode':_0x5d1193},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2e9f30)throw new Error(_0x6d9734(0xb4));if(_0x2e9f30[_0x6d9734(0x96)]!==_0x6d9734(0x9f))throw new Error(_0x6d9734(0xae));if(new Date()>_0x2e9f30[_0x6d9734(0x8d)]){await database_1[_0x6d9734(0x9c)][_0x6d9734(0xb7)][_0x6d9734(0xb8)]({'where':{'id':_0x2e9f30['id']},'data':{'status':_0x6d9734(0x85)}});throw new Error('Pre-payment\x20has\x20expired');}return _0x2e9f30;}async[a83_0x528c71(0xa5)](_0x40bab4,_0x1bfe9c){const _0x1db43f=a83_0x528c71,_0xcac785=await this[_0x1db43f(0x91)](_0x40bab4);return await database_1[_0x1db43f(0x9c)][_0x1db43f(0xb7)][_0x1db43f(0xb8)]({'where':{'id':_0xcac785['id']},'data':{'customerEmail':_0x1bfe9c[_0x1db43f(0xa8)],'customerName':_0x1bfe9c[_0x1db43f(0xa4)],'status':_0x1db43f(0xa3),'confirmedAt':new Date()}}),{'prePaymentId':_0xcac785['id'],'customerEmail':_0x1bfe9c[_0x1db43f(0xa8)],'customerName':_0x1bfe9c['customerName'],'customerIp':_0x1bfe9c[_0x1db43f(0x8f)],'customerCountry':_0x1bfe9c[_0x1db43f(0xb0)],'shopId':_0xcac785[_0x1db43f(0xa6)],'gateway':_0xcac785[_0x1db43f(0x87)],'amount':_0xcac785[_0x1db43f(0x98)],'currency':_0xcac785[_0x1db43f(0x97)],'sourceCurrency':_0xcac785[_0x1db43f(0x9d)],'network':_0xcac785[_0x1db43f(0xac)],'orderId':_0xcac785['orderId'],'country':_0xcac785[_0x1db43f(0xb2)],'language':_0xcac785[_0x1db43f(0x93)],'successUrl':_0xcac785[_0x1db43f(0x8c)],'failUrl':_0xcac785[_0x1db43f(0xa1)],'pendingUrl':_0xcac785[_0x1db43f(0xad)]};}async[a83_0x528c71(0xb1)](){const _0x2b35ab=a83_0x528c71;let _0x5f41fa=0x0;const _0x1fb734=0xa;while(_0x5f41fa<_0x1fb734){const _0x3138e7=nanoid(),_0x5bc684=await database_1['default'][_0x2b35ab(0xb7)][_0x2b35ab(0x8b)]({'where':{'shortCode':_0x3138e7}});if(!_0x5bc684)return _0x3138e7;_0x5f41fa++;}throw new Error('Failed\x20to\x20generate\x20unique\x20short\x20code');}}exports[a83_0x528c71(0xb6)]=PrePaymentService,exports[a83_0x528c71(0x90)]=new PrePaymentService();