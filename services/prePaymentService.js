'use strict';const a83_0x5408b0=a83_0x1364;(function(_0x1b45ad,_0x16786e){const _0xa594c0=a83_0x1364,_0x53c7bc=_0x1b45ad();while(!![]){try{const _0x1d1910=parseInt(_0xa594c0(0x168))/0x1+-parseInt(_0xa594c0(0x15e))/0x2*(-parseInt(_0xa594c0(0x164))/0x3)+-parseInt(_0xa594c0(0x142))/0x4+-parseInt(_0xa594c0(0x150))/0x5+-parseInt(_0xa594c0(0x166))/0x6+-parseInt(_0xa594c0(0x148))/0x7+parseInt(_0xa594c0(0x13f))/0x8*(parseInt(_0xa594c0(0x163))/0x9);if(_0x1d1910===_0x16786e)break;else _0x53c7bc['push'](_0x53c7bc['shift']());}catch(_0x5bc47e){_0x53c7bc['push'](_0x53c7bc['shift']());}}}(a83_0x1ae0,0xbccb0));var __importDefault=this&&this[a83_0x5408b0(0x16d)]||function(_0x294f68){const _0x31ba42=a83_0x5408b0;return _0x294f68&&_0x294f68[_0x31ba42(0x157)]?_0x294f68:{'default':_0x294f68};};function a83_0x1ae0(){const _0x47addf=['../config/database','sourceCurrency','Pre-payment\x20has\x20expired','customerIp','getPrePaymentByCode','country','__esModule','generateUniqueShortCode','network','PENDING','prePaymentService','Failed\x20to\x20generate\x20unique\x20short\x20code','expiresAt','2377846vMZckt','default','customerName','confirmPrePayment','prePayment','223029xmaCql','3McUXRW','amount','2648898rucTWT','pendingUrl','276271PNrqEP','customerEmail','findUnique','https://app.trapay.uk','PrePaymentService','__importDefault','orderId','Pre-payment\x20not\x20found','632tilgjl','create','EXPIRED','3350144nzhCqb','customAlphabet','Pre-payment\x20is\x20no\x20longer\x20available','shopId','defineProperty','language','268870TxdljL','nanoid','currency','gateway','status','successUrl','createPrePayment','update','6660840WsTFzt'];a83_0x1ae0=function(){return _0x47addf;};return a83_0x1ae0();}Object[a83_0x5408b0(0x146)](exports,a83_0x5408b0(0x157),{'value':!![]}),exports[a83_0x5408b0(0x15b)]=exports[a83_0x5408b0(0x16c)]=void 0x0;const database_1=__importDefault(require(a83_0x5408b0(0x151))),nanoid_1=require(a83_0x5408b0(0x149)),nanoid=(0x0,nanoid_1[a83_0x5408b0(0x143)])('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',0x8);function a83_0x1364(_0x57038b,_0x548e4b){_0x57038b=_0x57038b-0x13d;const _0x1ae020=a83_0x1ae0();let _0x13642c=_0x1ae020[_0x57038b];return _0x13642c;}class PrePaymentService{async[a83_0x5408b0(0x14e)](_0x23ad4b){const _0x3422eb=a83_0x5408b0,_0x98e618=await this[_0x3422eb(0x158)](),_0x57db07=new Date(Date['now']()+0x1e*0x3c*0x3e8),_0x3026e5=await database_1[_0x3422eb(0x15f)][_0x3422eb(0x162)][_0x3422eb(0x140)]({'data':{'shortCode':_0x98e618,'shopId':_0x23ad4b[_0x3422eb(0x145)],'gateway':_0x23ad4b[_0x3422eb(0x14b)],'amount':_0x23ad4b[_0x3422eb(0x165)],'currency':_0x23ad4b[_0x3422eb(0x14a)],'sourceCurrency':_0x23ad4b[_0x3422eb(0x152)],'network':_0x23ad4b[_0x3422eb(0x159)],'orderId':_0x23ad4b['orderId'],'country':_0x23ad4b[_0x3422eb(0x156)],'language':_0x23ad4b[_0x3422eb(0x147)],'successUrl':_0x23ad4b['successUrl'],'failUrl':_0x23ad4b['failUrl'],'pendingUrl':_0x23ad4b['pendingUrl'],'customerEmail':_0x23ad4b[_0x3422eb(0x169)],'customerName':_0x23ad4b[_0x3422eb(0x160)],'expiresAt':_0x57db07,'status':_0x3422eb(0x15a)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x58a6cb=process.env.FRONTEND_URL||_0x3422eb(0x16b),_0x4b7c98=_0x58a6cb+'/p/'+_0x98e618;return{'prePaymentId':_0x3026e5['id'],'shortCode':_0x3026e5['shortCode'],'proxyUrl':_0x4b7c98,'expiresAt':_0x3026e5['expiresAt']};}async[a83_0x5408b0(0x155)](_0x5afcd1){const _0x285016=a83_0x5408b0,_0x5ac519=await database_1['default'][_0x285016(0x162)][_0x285016(0x16a)]({'where':{'shortCode':_0x5afcd1},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5ac519)throw new Error(_0x285016(0x13e));if(_0x5ac519[_0x285016(0x14c)]!==_0x285016(0x15a))throw new Error(_0x285016(0x144));if(new Date()>_0x5ac519[_0x285016(0x15d)]){await database_1[_0x285016(0x15f)][_0x285016(0x162)][_0x285016(0x14f)]({'where':{'id':_0x5ac519['id']},'data':{'status':_0x285016(0x141)}});throw new Error(_0x285016(0x153));}return _0x5ac519;}async[a83_0x5408b0(0x161)](_0x26eabe,_0x230dc0){const _0x2cf682=a83_0x5408b0,_0x2d597b=await this[_0x2cf682(0x155)](_0x26eabe);return await database_1[_0x2cf682(0x15f)][_0x2cf682(0x162)][_0x2cf682(0x14f)]({'where':{'id':_0x2d597b['id']},'data':{'customerEmail':_0x230dc0[_0x2cf682(0x169)],'customerName':_0x230dc0[_0x2cf682(0x160)],'status':'CONFIRMED','confirmedAt':new Date()}}),{'prePaymentId':_0x2d597b['id'],'customerEmail':_0x230dc0[_0x2cf682(0x169)],'customerName':_0x230dc0['customerName'],'customerIp':_0x230dc0[_0x2cf682(0x154)],'customerCountry':_0x230dc0['customerCountry'],'shopId':_0x2d597b[_0x2cf682(0x145)],'gateway':_0x2d597b[_0x2cf682(0x14b)],'amount':_0x2d597b[_0x2cf682(0x165)],'currency':_0x2d597b['currency'],'sourceCurrency':_0x2d597b[_0x2cf682(0x152)],'network':_0x2d597b[_0x2cf682(0x159)],'orderId':_0x2d597b[_0x2cf682(0x13d)],'country':_0x2d597b[_0x2cf682(0x156)],'language':_0x2d597b['language'],'successUrl':_0x2d597b[_0x2cf682(0x14d)],'failUrl':_0x2d597b['failUrl'],'pendingUrl':_0x2d597b[_0x2cf682(0x167)]};}async[a83_0x5408b0(0x158)](){const _0xda820a=a83_0x5408b0;let _0x2481dd=0x0;const _0xce87d=0xa;while(_0x2481dd<_0xce87d){const _0xee648a=nanoid(),_0x3eb3a3=await database_1[_0xda820a(0x15f)][_0xda820a(0x162)]['findUnique']({'where':{'shortCode':_0xee648a}});if(!_0x3eb3a3)return _0xee648a;_0x2481dd++;}throw new Error(_0xda820a(0x15c));}}exports[a83_0x5408b0(0x16c)]=PrePaymentService,exports[a83_0x5408b0(0x15b)]=new PrePaymentService();