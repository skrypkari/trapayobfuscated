'use strict';const a83_0x343c4b=a83_0x1df2;function a83_0x4dc7(){const _0x3f16e4=['https://app.trapay.uk','2688dnSCrO','Failed\x20to\x20generate\x20unique\x20short\x20code','shortCode','customerIp','__esModule','update','findUnique','language','amount','CONFIRMED','__importDefault','373688KzXchI','abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789','defineProperty','21GbyapV','orderId','pendingUrl','shopId','default','customerName','gateway','47124HHypfZ','customerEmail','prePaymentService','PENDING','396648uEuviu','10Pzlqiu','3438783CHaaZR','463014gETEuZ','prePayment','../config/database','EXPIRED','12aGDmhL','customerCountry','getPrePaymentByCode','successUrl','35145LAUMCO','failUrl','country','expiresAt','network','now','PrePaymentService','Pre-payment\x20has\x20expired','20kxFEho','3585936bpNPia','sourceCurrency','createPrePayment'];a83_0x4dc7=function(){return _0x3f16e4;};return a83_0x4dc7();}(function(_0x34d11d,_0x400970){const _0x4c6183=a83_0x1df2,_0x21be31=_0x34d11d();while(!![]){try{const _0x2b0b07=-parseInt(_0x4c6183(0x14b))/0x1*(-parseInt(_0x4c6183(0x147))/0x2)+-parseInt(_0x4c6183(0x135))/0x3*(parseInt(_0x4c6183(0x132))/0x4)+parseInt(_0x4c6183(0x153))/0x5*(-parseInt(_0x4c6183(0x143))/0x6)+parseInt(_0x4c6183(0x140))/0x7+parseInt(_0x4c6183(0x154))/0x8+parseInt(_0x4c6183(0x142))/0x9*(-parseInt(_0x4c6183(0x141))/0xa)+-parseInt(_0x4c6183(0x13c))/0xb*(-parseInt(_0x4c6183(0x158))/0xc);if(_0x2b0b07===_0x400970)break;else _0x21be31['push'](_0x21be31['shift']());}catch(_0x194484){_0x21be31['push'](_0x21be31['shift']());}}}(a83_0x4dc7,0x50bb3));var __importDefault=this&&this[a83_0x343c4b(0x162)]||function(_0x1f3353){const _0x4c3dbd=a83_0x343c4b;return _0x1f3353&&_0x1f3353[_0x4c3dbd(0x15c)]?_0x1f3353:{'default':_0x1f3353};};Object[a83_0x343c4b(0x134)](exports,a83_0x343c4b(0x15c),{'value':!![]}),exports[a83_0x343c4b(0x13e)]=exports[a83_0x343c4b(0x151)]=void 0x0;const database_1=__importDefault(require(a83_0x343c4b(0x145))),nanoid_1=require('nanoid'),nanoid=(0x0,nanoid_1['customAlphabet'])(a83_0x343c4b(0x133),0x8);function a83_0x1df2(_0x3cb324,_0xadf51d){_0x3cb324=_0x3cb324-0x132;const _0x4dc7e8=a83_0x4dc7();let _0x1df291=_0x4dc7e8[_0x3cb324];return _0x1df291;}class PrePaymentService{async[a83_0x343c4b(0x156)](_0x559258){const _0x124585=a83_0x343c4b,_0xee4b86=await this['generateUniqueShortCode'](),_0x2a7661=new Date(Date[_0x124585(0x150)]()+0x1e*0x3c*0x3e8),_0x279672=await database_1['default'][_0x124585(0x144)]['create']({'data':{'shortCode':_0xee4b86,'shopId':_0x559258[_0x124585(0x138)],'gateway':_0x559258['gateway'],'amount':_0x559258[_0x124585(0x160)],'currency':_0x559258['currency'],'sourceCurrency':_0x559258[_0x124585(0x155)],'network':_0x559258[_0x124585(0x14f)],'orderId':_0x559258['orderId'],'country':_0x559258[_0x124585(0x14d)],'language':_0x559258['language'],'successUrl':_0x559258['successUrl'],'failUrl':_0x559258[_0x124585(0x14c)],'pendingUrl':_0x559258[_0x124585(0x137)],'customerEmail':_0x559258[_0x124585(0x13d)],'customerName':_0x559258['customerName'],'expiresAt':_0x2a7661,'status':_0x124585(0x13f)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x4fdba6=process.env.FRONTEND_URL||_0x124585(0x157),_0x17bc35=_0x4fdba6+'/p/'+_0xee4b86;return{'prePaymentId':_0x279672['id'],'shortCode':_0x279672[_0x124585(0x15a)],'proxyUrl':_0x17bc35,'expiresAt':_0x279672[_0x124585(0x14e)]};}async[a83_0x343c4b(0x149)](_0x2d6f48){const _0x2b07bf=a83_0x343c4b,_0x517e69=await database_1['default']['prePayment']['findUnique']({'where':{'shortCode':_0x2d6f48},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x517e69)throw new Error('Pre-payment\x20not\x20found');if(_0x517e69['status']!==_0x2b07bf(0x13f))throw new Error('Pre-payment\x20is\x20no\x20longer\x20available');if(new Date()>_0x517e69[_0x2b07bf(0x14e)]){await database_1['default'][_0x2b07bf(0x144)][_0x2b07bf(0x15d)]({'where':{'id':_0x517e69['id']},'data':{'status':_0x2b07bf(0x146)}});throw new Error(_0x2b07bf(0x152));}return _0x517e69;}async['confirmPrePayment'](_0x593df0,_0x48cdb7){const _0x2911cc=a83_0x343c4b,_0x332245=await this[_0x2911cc(0x149)](_0x593df0);return await database_1[_0x2911cc(0x139)]['prePayment'][_0x2911cc(0x15d)]({'where':{'id':_0x332245['id']},'data':{'customerEmail':_0x48cdb7[_0x2911cc(0x13d)],'customerName':_0x48cdb7['customerName'],'status':_0x2911cc(0x161),'confirmedAt':new Date()}}),{'prePaymentId':_0x332245['id'],'customerEmail':_0x48cdb7[_0x2911cc(0x13d)],'customerName':_0x48cdb7[_0x2911cc(0x13a)],'customerIp':_0x48cdb7[_0x2911cc(0x15b)],'customerCountry':_0x48cdb7[_0x2911cc(0x148)],'shopId':_0x332245[_0x2911cc(0x138)],'gateway':_0x332245[_0x2911cc(0x13b)],'amount':_0x332245['amount'],'currency':_0x332245['currency'],'sourceCurrency':_0x332245[_0x2911cc(0x155)],'network':_0x332245[_0x2911cc(0x14f)],'orderId':_0x332245[_0x2911cc(0x136)],'country':_0x332245[_0x2911cc(0x14d)],'language':_0x332245[_0x2911cc(0x15f)],'successUrl':_0x332245[_0x2911cc(0x14a)],'failUrl':_0x332245[_0x2911cc(0x14c)],'pendingUrl':_0x332245[_0x2911cc(0x137)]};}async['generateUniqueShortCode'](){const _0x225397=a83_0x343c4b;let _0x596ca5=0x0;const _0x5ca272=0xa;while(_0x596ca5<_0x5ca272){const _0x1683d8=nanoid(),_0xb35cd7=await database_1[_0x225397(0x139)]['prePayment'][_0x225397(0x15e)]({'where':{'shortCode':_0x1683d8}});if(!_0xb35cd7)return _0x1683d8;_0x596ca5++;}throw new Error(_0x225397(0x159));}}exports[a83_0x343c4b(0x151)]=PrePaymentService,exports[a83_0x343c4b(0x13e)]=new PrePaymentService();