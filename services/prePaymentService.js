'use strict';const a83_0x1bdce5=a83_0x49ee;(function(_0x3292c8,_0x20cd75){const _0x2fd2e0=a83_0x49ee,_0x3ee475=_0x3292c8();while(!![]){try{const _0x5a34be=parseInt(_0x2fd2e0(0xe0))/0x1*(-parseInt(_0x2fd2e0(0xdc))/0x2)+parseInt(_0x2fd2e0(0xb6))/0x3+parseInt(_0x2fd2e0(0xc7))/0x4*(parseInt(_0x2fd2e0(0xdb))/0x5)+parseInt(_0x2fd2e0(0xcd))/0x6*(parseInt(_0x2fd2e0(0xce))/0x7)+-parseInt(_0x2fd2e0(0xba))/0x8+parseInt(_0x2fd2e0(0xb4))/0x9+-parseInt(_0x2fd2e0(0xcb))/0xa;if(_0x5a34be===_0x20cd75)break;else _0x3ee475['push'](_0x3ee475['shift']());}catch(_0x29032d){_0x3ee475['push'](_0x3ee475['shift']());}}}(a83_0x22ec,0x4a025));var __importDefault=this&&this[a83_0x1bdce5(0xb7)]||function(_0x53164b){const _0x42e7ca=a83_0x1bdce5;return _0x53164b&&_0x53164b[_0x42e7ca(0xd5)]?_0x53164b:{'default':_0x53164b};};Object[a83_0x1bdce5(0xd6)](exports,a83_0x1bdce5(0xd5),{'value':!![]}),exports[a83_0x1bdce5(0xc3)]=exports[a83_0x1bdce5(0xbd)]=void 0x0;const database_1=__importDefault(require(a83_0x1bdce5(0xcf))),nanoid_1=require(a83_0x1bdce5(0xd7)),nanoid=(0x0,nanoid_1['customAlphabet'])('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',0x8);class PrePaymentService{async[a83_0x1bdce5(0xc4)](_0x530afe){const _0x966f59=a83_0x1bdce5,_0x24e2e9=await this['generateUniqueShortCode'](),_0x2c8322=new Date(Date[_0x966f59(0xdd)]()+0x1e*0x3c*0x3e8),_0x55d901=await database_1[_0x966f59(0xde)][_0x966f59(0xc0)][_0x966f59(0xbb)]({'data':{'shortCode':_0x24e2e9,'shopId':_0x530afe['shopId'],'gateway':_0x530afe[_0x966f59(0xc5)],'amount':_0x530afe[_0x966f59(0xc6)],'currency':_0x530afe[_0x966f59(0xd9)],'sourceCurrency':_0x530afe['sourceCurrency'],'network':_0x530afe['network'],'orderId':_0x530afe[_0x966f59(0xb3)],'country':_0x530afe[_0x966f59(0xcc)],'language':_0x530afe[_0x966f59(0xdf)],'successUrl':_0x530afe['successUrl'],'failUrl':_0x530afe[_0x966f59(0xc9)],'pendingUrl':_0x530afe['pendingUrl'],'expiresAt':_0x2c8322,'status':_0x966f59(0xca)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x1509d6=process.env.FRONTEND_URL||_0x966f59(0xd8),_0x1bee8e=_0x1509d6+_0x966f59(0xb1)+_0x24e2e9;return{'prePaymentId':_0x55d901['id'],'shortCode':_0x55d901[_0x966f59(0xe1)],'proxyUrl':_0x1bee8e,'expiresAt':_0x55d901[_0x966f59(0xda)]};}async['getPrePaymentByCode'](_0x33cb44){const _0x1fd38d=a83_0x1bdce5,_0x148596=await database_1[_0x1fd38d(0xde)][_0x1fd38d(0xc0)]['findUnique']({'where':{'shortCode':_0x33cb44},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x148596)throw new Error('Pre-payment\x20not\x20found');if(_0x148596[_0x1fd38d(0xb8)]!=='PENDING')throw new Error('Pre-payment\x20is\x20no\x20longer\x20available');if(new Date()>_0x148596[_0x1fd38d(0xda)]){await database_1['default']['prePayment']['update']({'where':{'id':_0x148596['id']},'data':{'status':_0x1fd38d(0xbf)}});throw new Error(_0x1fd38d(0xbc));}return _0x148596;}async['confirmPrePayment'](_0x30fcc2,_0x554cd5){const _0x5c08ea=a83_0x1bdce5,_0x25a62f=await this[_0x5c08ea(0xb2)](_0x30fcc2);return await database_1[_0x5c08ea(0xde)][_0x5c08ea(0xc0)][_0x5c08ea(0xd0)]({'where':{'id':_0x25a62f['id']},'data':{'customerEmail':_0x554cd5[_0x5c08ea(0xb5)],'customerName':_0x554cd5['customerName'],'status':_0x5c08ea(0xb9),'confirmedAt':new Date()}}),{'prePaymentId':_0x25a62f['id'],'customerEmail':_0x554cd5[_0x5c08ea(0xb5)],'customerName':_0x554cd5[_0x5c08ea(0xc2)],'customerIp':_0x554cd5[_0x5c08ea(0xc1)],'customerCountry':_0x554cd5[_0x5c08ea(0xd2)],'shopId':_0x25a62f[_0x5c08ea(0xd4)],'gateway':_0x25a62f[_0x5c08ea(0xc5)],'amount':_0x25a62f['amount'],'currency':_0x25a62f['currency'],'sourceCurrency':_0x25a62f['sourceCurrency'],'network':_0x25a62f[_0x5c08ea(0xc8)],'orderId':_0x25a62f[_0x5c08ea(0xb3)],'country':_0x25a62f[_0x5c08ea(0xcc)],'language':_0x25a62f[_0x5c08ea(0xdf)],'successUrl':_0x25a62f['successUrl'],'failUrl':_0x25a62f['failUrl'],'pendingUrl':_0x25a62f[_0x5c08ea(0xd3)]};}async['generateUniqueShortCode'](){const _0x181f24=a83_0x1bdce5;let _0x123546=0x0;const _0x3b15b1=0xa;while(_0x123546<_0x3b15b1){const _0x5a4ae1=nanoid(),_0x2616d4=await database_1[_0x181f24(0xde)][_0x181f24(0xc0)][_0x181f24(0xbe)]({'where':{'shortCode':_0x5a4ae1}});if(!_0x2616d4)return _0x5a4ae1;_0x123546++;}throw new Error(_0x181f24(0xd1));}}function a83_0x49ee(_0x5c1595,_0x2aa030){_0x5c1595=_0x5c1595-0xb1;const _0x22ec30=a83_0x22ec();let _0x49ee74=_0x22ec30[_0x5c1595];return _0x49ee74;}exports[a83_0x1bdce5(0xbd)]=PrePaymentService,exports[a83_0x1bdce5(0xc3)]=new PrePaymentService();function a83_0x22ec(){const _0x24cefa=['../config/database','update','Failed\x20to\x20generate\x20unique\x20short\x20code','customerCountry','pendingUrl','shopId','__esModule','defineProperty','nanoid','https://app.trapay.uk','currency','expiresAt','9850eJKOat','227266kcwTsh','now','default','language','5EUYXRh','shortCode','/p/','getPrePaymentByCode','orderId','3394332lWCAjf','customerEmail','1080993ikSyPE','__importDefault','status','CONFIRMED','1303168PMmQhx','create','Pre-payment\x20has\x20expired','PrePaymentService','findUnique','EXPIRED','prePayment','customerIp','customerName','prePaymentService','createPrePayment','gateway','amount','1192ISzNuI','network','failUrl','PENDING','7391360NiRlib','country','138JnXLNq','136591QDXEnz'];a83_0x22ec=function(){return _0x24cefa;};return a83_0x22ec();}