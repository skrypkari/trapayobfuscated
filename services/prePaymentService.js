'use strict';function a79_0x5768(){const _0x34b587=['orderId','EXPIRED','1133000JlQqnY','customerEmail','prePayment','country','1420215hlkkrg','2NqHUTH','now','Pre-payment\x20has\x20expired','shopId','network','272RbhDtQ','sourceCurrency','default','Pre-payment\x20not\x20found','currency','CONFIRMED','__esModule','pendingUrl','successUrl','684430NBKUQV','shortCode','Failed\x20to\x20generate\x20unique\x20short\x20code','confirmPrePayment','status','customerName','433920SEnGGW','abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789','generateUniqueShortCode','failUrl','customAlphabet','4908195PlzGtL','gateway','findUnique','getPrePaymentByCode','__importDefault','createPrePayment','/p/','PrePaymentService','update','PENDING','nanoid','98658tPrHbQ','customerCountry','2264646eyKQut','prePaymentService','https://app.trapay.uk','create','amount','language','expiresAt'];a79_0x5768=function(){return _0x34b587;};return a79_0x5768();}const a79_0xcdbc49=a79_0x22d0;(function(_0x390d71,_0xfcdc0b){const _0x2abc3e=a79_0x22d0,_0x1dfce4=_0x390d71();while(!![]){try{const _0x3fd0fe=parseInt(_0x2abc3e(0x18e))/0x1*(-parseInt(_0x2abc3e(0x180))/0x2)+parseInt(_0x2abc3e(0x194))/0x3+parseInt(_0x2abc3e(0x1af))/0x4+parseInt(_0x2abc3e(0x1b3))/0x5+parseInt(_0x2abc3e(0x1a6))/0x6+-parseInt(_0x2abc3e(0x1a4))/0x7*(parseInt(_0x2abc3e(0x185))/0x8)+parseInt(_0x2abc3e(0x199))/0x9;if(_0x3fd0fe===_0xfcdc0b)break;else _0x1dfce4['push'](_0x1dfce4['shift']());}catch(_0x23e06d){_0x1dfce4['push'](_0x1dfce4['shift']());}}}(a79_0x5768,0x7303f));var __importDefault=this&&this[a79_0xcdbc49(0x19d)]||function(_0x22d6cf){const _0xb276e9=a79_0xcdbc49;return _0x22d6cf&&_0x22d6cf[_0xb276e9(0x18b)]?_0x22d6cf:{'default':_0x22d6cf};};Object['defineProperty'](exports,a79_0xcdbc49(0x18b),{'value':!![]}),exports[a79_0xcdbc49(0x1a7)]=exports[a79_0xcdbc49(0x1a0)]=void 0x0;const database_1=__importDefault(require('../config/database')),nanoid_1=require(a79_0xcdbc49(0x1a3)),nanoid=(0x0,nanoid_1[a79_0xcdbc49(0x198)])(a79_0xcdbc49(0x195),0x8);class PrePaymentService{async[a79_0xcdbc49(0x19e)](_0x48b465){const _0x1f0180=a79_0xcdbc49,_0x2604e4=await this[_0x1f0180(0x196)](),_0x3ff7f2=new Date(Date[_0x1f0180(0x181)]()+0x1e*0x3c*0x3e8),_0x40314d=await database_1[_0x1f0180(0x187)]['prePayment'][_0x1f0180(0x1a9)]({'data':{'shortCode':_0x2604e4,'shopId':_0x48b465[_0x1f0180(0x183)],'gateway':_0x48b465[_0x1f0180(0x19a)],'amount':_0x48b465[_0x1f0180(0x1aa)],'currency':_0x48b465[_0x1f0180(0x189)],'sourceCurrency':_0x48b465[_0x1f0180(0x186)],'network':_0x48b465[_0x1f0180(0x184)],'orderId':_0x48b465[_0x1f0180(0x1ad)],'country':_0x48b465[_0x1f0180(0x1b2)],'language':_0x48b465[_0x1f0180(0x1ab)],'successUrl':_0x48b465[_0x1f0180(0x18d)],'failUrl':_0x48b465[_0x1f0180(0x197)],'pendingUrl':_0x48b465[_0x1f0180(0x18c)],'expiresAt':_0x3ff7f2,'status':_0x1f0180(0x1a2)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x4337cb=process.env.FRONTEND_URL||_0x1f0180(0x1a8),_0x42dd32=_0x4337cb+_0x1f0180(0x19f)+_0x2604e4;return{'prePaymentId':_0x40314d['id'],'shortCode':_0x40314d[_0x1f0180(0x18f)],'proxyUrl':_0x42dd32,'expiresAt':_0x40314d[_0x1f0180(0x1ac)]};}async[a79_0xcdbc49(0x19c)](_0x400711){const _0x34ec77=a79_0xcdbc49,_0x21f05a=await database_1[_0x34ec77(0x187)]['prePayment'][_0x34ec77(0x19b)]({'where':{'shortCode':_0x400711},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x21f05a)throw new Error(_0x34ec77(0x188));if(_0x21f05a[_0x34ec77(0x192)]!==_0x34ec77(0x1a2))throw new Error('Pre-payment\x20is\x20no\x20longer\x20available');if(new Date()>_0x21f05a['expiresAt']){await database_1['default'][_0x34ec77(0x1b1)]['update']({'where':{'id':_0x21f05a['id']},'data':{'status':_0x34ec77(0x1ae)}});throw new Error(_0x34ec77(0x182));}return _0x21f05a;}async[a79_0xcdbc49(0x191)](_0x398984,_0x3d7caf){const _0x9217c6=a79_0xcdbc49,_0x5058d3=await this[_0x9217c6(0x19c)](_0x398984);return await database_1[_0x9217c6(0x187)][_0x9217c6(0x1b1)][_0x9217c6(0x1a1)]({'where':{'id':_0x5058d3['id']},'data':{'customerEmail':_0x3d7caf[_0x9217c6(0x1b0)],'customerName':_0x3d7caf[_0x9217c6(0x193)],'status':_0x9217c6(0x18a),'confirmedAt':new Date()}}),{'prePaymentId':_0x5058d3['id'],'customerEmail':_0x3d7caf[_0x9217c6(0x1b0)],'customerName':_0x3d7caf[_0x9217c6(0x193)],'customerIp':_0x3d7caf['customerIp'],'customerCountry':_0x3d7caf[_0x9217c6(0x1a5)],'shopId':_0x5058d3[_0x9217c6(0x183)],'gateway':_0x5058d3[_0x9217c6(0x19a)],'amount':_0x5058d3[_0x9217c6(0x1aa)],'currency':_0x5058d3[_0x9217c6(0x189)],'sourceCurrency':_0x5058d3[_0x9217c6(0x186)],'network':_0x5058d3['network'],'orderId':_0x5058d3[_0x9217c6(0x1ad)],'country':_0x5058d3[_0x9217c6(0x1b2)],'language':_0x5058d3[_0x9217c6(0x1ab)],'successUrl':_0x5058d3['successUrl'],'failUrl':_0x5058d3[_0x9217c6(0x197)],'pendingUrl':_0x5058d3['pendingUrl']};}async[a79_0xcdbc49(0x196)](){const _0x357cac=a79_0xcdbc49;let _0x224a55=0x0;const _0x553c02=0xa;while(_0x224a55<_0x553c02){const _0x443ff6=nanoid(),_0x2709e8=await database_1[_0x357cac(0x187)][_0x357cac(0x1b1)][_0x357cac(0x19b)]({'where':{'shortCode':_0x443ff6}});if(!_0x2709e8)return _0x443ff6;_0x224a55++;}throw new Error(_0x357cac(0x190));}}function a79_0x22d0(_0x489051,_0x5ee920){_0x489051=_0x489051-0x180;const _0x576842=a79_0x5768();let _0x22d0b7=_0x576842[_0x489051];return _0x22d0b7;}exports[a79_0xcdbc49(0x1a0)]=PrePaymentService,exports[a79_0xcdbc49(0x1a7)]=new PrePaymentService();