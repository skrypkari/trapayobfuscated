'use strict';const a83_0x13a8df=a83_0x5b4a;(function(_0x25727f,_0x5741e8){const _0x72101d=a83_0x5b4a,_0x5b9787=_0x25727f();while(!![]){try{const _0x98f279=parseInt(_0x72101d(0x19c))/0x1*(parseInt(_0x72101d(0x18f))/0x2)+parseInt(_0x72101d(0x188))/0x3+parseInt(_0x72101d(0x197))/0x4+-parseInt(_0x72101d(0x176))/0x5*(parseInt(_0x72101d(0x16a))/0x6)+parseInt(_0x72101d(0x181))/0x7*(parseInt(_0x72101d(0x18b))/0x8)+-parseInt(_0x72101d(0x168))/0x9*(-parseInt(_0x72101d(0x17b))/0xa)+-parseInt(_0x72101d(0x195))/0xb;if(_0x98f279===_0x5741e8)break;else _0x5b9787['push'](_0x5b9787['shift']());}catch(_0x3dd1cf){_0x5b9787['push'](_0x5b9787['shift']());}}}(a83_0x28dd,0xf34e4));function a83_0x28dd(){const _0xcf33c0=['update','language','2fqtgXS','getPrePaymentByCode','Failed\x20to\x20generate\x20unique\x20short\x20code','customerCountry','customerIp','defineProperty','21633205FXtvGJ','customerEmail','7258364sLyxdt','status','pendingUrl','prePayment','nanoid','669971PgsPYg','customAlphabet','234666JiVgER','shopId','11741358xzYEhP','../config/database','now','customerName','__importDefault','create','findUnique','abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789','default','network','shortCode','CONFIRMED','5FRajIv','PENDING','failUrl','prePaymentService','currency','250zRHakt','Pre-payment\x20has\x20expired','amount','gateway','successUrl','generateUniqueShortCode','27293gbCvYH','/p/','PrePaymentService','Pre-payment\x20is\x20no\x20longer\x20available','EXPIRED','__esModule','Pre-payment\x20not\x20found','4169751VLkYKV','sourceCurrency','orderId','808SfONPh','expiresAt'];a83_0x28dd=function(){return _0xcf33c0;};return a83_0x28dd();}function a83_0x5b4a(_0x448c08,_0x141f2a){_0x448c08=_0x448c08-0x167;const _0x28dd97=a83_0x28dd();let _0x5b4a2f=_0x28dd97[_0x448c08];return _0x5b4a2f;}var __importDefault=this&&this[a83_0x13a8df(0x16e)]||function(_0x20bbbd){const _0x42e3d4=a83_0x13a8df;return _0x20bbbd&&_0x20bbbd[_0x42e3d4(0x186)]?_0x20bbbd:{'default':_0x20bbbd};};Object[a83_0x13a8df(0x194)](exports,a83_0x13a8df(0x186),{'value':!![]}),exports[a83_0x13a8df(0x179)]=exports[a83_0x13a8df(0x183)]=void 0x0;const database_1=__importDefault(require(a83_0x13a8df(0x16b))),nanoid_1=require(a83_0x13a8df(0x19b)),nanoid=(0x0,nanoid_1[a83_0x13a8df(0x167)])(a83_0x13a8df(0x171),0x8);class PrePaymentService{async['createPrePayment'](_0x5e7a5e){const _0x2cc8d8=a83_0x13a8df,_0x5531bd=await this[_0x2cc8d8(0x180)](),_0x46f41c=new Date(Date[_0x2cc8d8(0x16c)]()+0x1e*0x3c*0x3e8),_0x391d78=await database_1[_0x2cc8d8(0x172)][_0x2cc8d8(0x19a)][_0x2cc8d8(0x16f)]({'data':{'shortCode':_0x5531bd,'shopId':_0x5e7a5e[_0x2cc8d8(0x169)],'gateway':_0x5e7a5e[_0x2cc8d8(0x17e)],'amount':_0x5e7a5e[_0x2cc8d8(0x17d)],'currency':_0x5e7a5e[_0x2cc8d8(0x17a)],'sourceCurrency':_0x5e7a5e[_0x2cc8d8(0x189)],'network':_0x5e7a5e[_0x2cc8d8(0x173)],'orderId':_0x5e7a5e['orderId'],'country':_0x5e7a5e['country'],'language':_0x5e7a5e[_0x2cc8d8(0x18e)],'successUrl':_0x5e7a5e[_0x2cc8d8(0x17f)],'failUrl':_0x5e7a5e[_0x2cc8d8(0x178)],'pendingUrl':_0x5e7a5e[_0x2cc8d8(0x199)],'customerEmail':_0x5e7a5e['customerEmail'],'customerName':_0x5e7a5e[_0x2cc8d8(0x16d)],'expiresAt':_0x46f41c,'status':'PENDING'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x153b5d=process.env.FRONTEND_URL||'https://app.trapay.uk',_0x189f15=_0x153b5d+_0x2cc8d8(0x182)+_0x5531bd;return{'prePaymentId':_0x391d78['id'],'shortCode':_0x391d78[_0x2cc8d8(0x174)],'proxyUrl':_0x189f15,'expiresAt':_0x391d78[_0x2cc8d8(0x18c)]};}async[a83_0x13a8df(0x190)](_0x2922d4){const _0x3a2b79=a83_0x13a8df,_0x1a34f9=await database_1['default']['prePayment']['findUnique']({'where':{'shortCode':_0x2922d4},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1a34f9)throw new Error(_0x3a2b79(0x187));if(_0x1a34f9[_0x3a2b79(0x198)]!==_0x3a2b79(0x177))throw new Error(_0x3a2b79(0x184));if(new Date()>_0x1a34f9['expiresAt']){await database_1['default'][_0x3a2b79(0x19a)][_0x3a2b79(0x18d)]({'where':{'id':_0x1a34f9['id']},'data':{'status':_0x3a2b79(0x185)}});throw new Error(_0x3a2b79(0x17c));}return _0x1a34f9;}async['confirmPrePayment'](_0x264b32,_0xdc646f){const _0x41c97d=a83_0x13a8df,_0x4f45eb=await this[_0x41c97d(0x190)](_0x264b32);return await database_1[_0x41c97d(0x172)]['prePayment'][_0x41c97d(0x18d)]({'where':{'id':_0x4f45eb['id']},'data':{'customerEmail':_0xdc646f['customerEmail'],'customerName':_0xdc646f['customerName'],'status':_0x41c97d(0x175),'confirmedAt':new Date()}}),{'prePaymentId':_0x4f45eb['id'],'customerEmail':_0xdc646f[_0x41c97d(0x196)],'customerName':_0xdc646f['customerName'],'customerIp':_0xdc646f[_0x41c97d(0x193)],'customerCountry':_0xdc646f[_0x41c97d(0x192)],'shopId':_0x4f45eb[_0x41c97d(0x169)],'gateway':_0x4f45eb[_0x41c97d(0x17e)],'amount':_0x4f45eb[_0x41c97d(0x17d)],'currency':_0x4f45eb['currency'],'sourceCurrency':_0x4f45eb[_0x41c97d(0x189)],'network':_0x4f45eb[_0x41c97d(0x173)],'orderId':_0x4f45eb[_0x41c97d(0x18a)],'country':_0x4f45eb['country'],'language':_0x4f45eb['language'],'successUrl':_0x4f45eb['successUrl'],'failUrl':_0x4f45eb[_0x41c97d(0x178)],'pendingUrl':_0x4f45eb[_0x41c97d(0x199)]};}async[a83_0x13a8df(0x180)](){const _0x4ae73f=a83_0x13a8df;let _0x20c154=0x0;const _0x254583=0xa;while(_0x20c154<_0x254583){const _0x5297cc=nanoid(),_0x725a03=await database_1[_0x4ae73f(0x172)][_0x4ae73f(0x19a)][_0x4ae73f(0x170)]({'where':{'shortCode':_0x5297cc}});if(!_0x725a03)return _0x5297cc;_0x20c154++;}throw new Error(_0x4ae73f(0x191));}}exports['PrePaymentService']=PrePaymentService,exports[a83_0x13a8df(0x179)]=new PrePaymentService();