'use strict';function a83_0x2ffb(){const _0x53bba6=['prePayment','363614JsewEY','../config/database','EXPIRED','6liqtsX','currency','findUnique','2121615ShTxiS','generateUniqueShortCode','18797812eyRwmE','nanoid','customAlphabet','getPrePaymentByCode','PENDING','createPrePayment','Pre-payment\x20not\x20found','4815350dyDwFA','orderId','8900950xfXFJk','PrePaymentService','32AWCEAU','Failed\x20to\x20generate\x20unique\x20short\x20code','amount','/p/','status','customerEmail','language','1215208zXHinl','customerIp','create','2wDhgJy','sourceCurrency','Pre-payment\x20is\x20no\x20longer\x20available','defineProperty','default','update','https://app.trapay.uk','abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789','gateway','shopId','__esModule','pendingUrl','network','successUrl','now','customerName','shortCode','12yjyvzC','5326664mSBvaD','confirmPrePayment','CONFIRMED','prePaymentService','country'];a83_0x2ffb=function(){return _0x53bba6;};return a83_0x2ffb();}const a83_0x3680bb=a83_0x68e6;(function(_0x91c89f,_0x30f835){const _0xfd781f=a83_0x68e6,_0x50ce06=_0x91c89f();while(!![]){try{const _0x4eeada=parseInt(_0xfd781f(0x1ef))/0x1*(-parseInt(_0xfd781f(0x1d2))/0x2)+parseInt(_0xfd781f(0x1cb))/0x3*(parseInt(_0xfd781f(0x1ec))/0x4)+parseInt(_0xfd781f(0x1e1))/0x5*(parseInt(_0xfd781f(0x1d5))/0x6)+parseInt(_0xfd781f(0x1cc))/0x7+-parseInt(_0xfd781f(0x1e5))/0x8*(parseInt(_0xfd781f(0x1d8))/0x9)+parseInt(_0xfd781f(0x1e3))/0xa+-parseInt(_0xfd781f(0x1da))/0xb;if(_0x4eeada===_0x30f835)break;else _0x50ce06['push'](_0x50ce06['shift']());}catch(_0x156b12){_0x50ce06['push'](_0x50ce06['shift']());}}}(a83_0x2ffb,0xc6b37));function a83_0x68e6(_0x18099f,_0x103916){_0x18099f=_0x18099f-0x1c3;const _0x2ffbb2=a83_0x2ffb();let _0x68e672=_0x2ffbb2[_0x18099f];return _0x68e672;}var __importDefault=this&&this['__importDefault']||function(_0x459964){const _0x254652=a83_0x68e6;return _0x459964&&_0x459964[_0x254652(0x1c4)]?_0x459964:{'default':_0x459964};};Object[a83_0x3680bb(0x1f2)](exports,'__esModule',{'value':!![]}),exports[a83_0x3680bb(0x1cf)]=exports[a83_0x3680bb(0x1e4)]=void 0x0;const database_1=__importDefault(require(a83_0x3680bb(0x1d3))),nanoid_1=require(a83_0x3680bb(0x1db)),nanoid=(0x0,nanoid_1[a83_0x3680bb(0x1dc)])(a83_0x3680bb(0x1f6),0x8);class PrePaymentService{async[a83_0x3680bb(0x1df)](_0x452cef){const _0x54026d=a83_0x3680bb,_0x51635c=await this['generateUniqueShortCode'](),_0x3b6f6f=new Date(Date[_0x54026d(0x1c8)]()+0x1e*0x3c*0x3e8),_0x560ad5=await database_1['default']['prePayment'][_0x54026d(0x1ee)]({'data':{'shortCode':_0x51635c,'shopId':_0x452cef[_0x54026d(0x1c3)],'gateway':_0x452cef[_0x54026d(0x1f7)],'amount':_0x452cef[_0x54026d(0x1e7)],'currency':_0x452cef[_0x54026d(0x1d6)],'sourceCurrency':_0x452cef[_0x54026d(0x1f0)],'network':_0x452cef[_0x54026d(0x1c6)],'orderId':_0x452cef[_0x54026d(0x1e2)],'country':_0x452cef[_0x54026d(0x1d0)],'language':_0x452cef['language'],'successUrl':_0x452cef['successUrl'],'failUrl':_0x452cef['failUrl'],'pendingUrl':_0x452cef[_0x54026d(0x1c5)],'customerEmail':_0x452cef[_0x54026d(0x1ea)],'customerName':_0x452cef[_0x54026d(0x1c9)],'expiresAt':_0x3b6f6f,'status':_0x54026d(0x1de)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x5ea6bf=process.env.FRONTEND_URL||_0x54026d(0x1f5),_0x5a9075=_0x5ea6bf+_0x54026d(0x1e8)+_0x51635c;return{'prePaymentId':_0x560ad5['id'],'shortCode':_0x560ad5[_0x54026d(0x1ca)],'proxyUrl':_0x5a9075,'expiresAt':_0x560ad5['expiresAt']};}async[a83_0x3680bb(0x1dd)](_0x36a994){const _0x52a536=a83_0x3680bb,_0x6400ff=await database_1['default']['prePayment'][_0x52a536(0x1d7)]({'where':{'shortCode':_0x36a994},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x6400ff)throw new Error(_0x52a536(0x1e0));if(_0x6400ff[_0x52a536(0x1e9)]!==_0x52a536(0x1de))throw new Error(_0x52a536(0x1f1));if(new Date()>_0x6400ff['expiresAt']){await database_1[_0x52a536(0x1f3)]['prePayment'][_0x52a536(0x1f4)]({'where':{'id':_0x6400ff['id']},'data':{'status':_0x52a536(0x1d4)}});throw new Error('Pre-payment\x20has\x20expired');}return _0x6400ff;}async[a83_0x3680bb(0x1cd)](_0x1d4e31,_0x283b13){const _0x43c396=a83_0x3680bb,_0x5e1f5e=await this[_0x43c396(0x1dd)](_0x1d4e31);return await database_1[_0x43c396(0x1f3)][_0x43c396(0x1d1)]['update']({'where':{'id':_0x5e1f5e['id']},'data':{'customerEmail':_0x283b13['customerEmail'],'customerName':_0x283b13[_0x43c396(0x1c9)],'status':_0x43c396(0x1ce),'confirmedAt':new Date()}}),{'prePaymentId':_0x5e1f5e['id'],'customerEmail':_0x283b13[_0x43c396(0x1ea)],'customerName':_0x283b13[_0x43c396(0x1c9)],'customerIp':_0x283b13[_0x43c396(0x1ed)],'customerCountry':_0x283b13['customerCountry'],'shopId':_0x5e1f5e['shopId'],'gateway':_0x5e1f5e[_0x43c396(0x1f7)],'amount':_0x5e1f5e[_0x43c396(0x1e7)],'currency':_0x5e1f5e['currency'],'sourceCurrency':_0x5e1f5e[_0x43c396(0x1f0)],'network':_0x5e1f5e[_0x43c396(0x1c6)],'orderId':_0x5e1f5e['orderId'],'country':_0x5e1f5e['country'],'language':_0x5e1f5e[_0x43c396(0x1eb)],'successUrl':_0x5e1f5e[_0x43c396(0x1c7)],'failUrl':_0x5e1f5e['failUrl'],'pendingUrl':_0x5e1f5e[_0x43c396(0x1c5)]};}async[a83_0x3680bb(0x1d9)](){const _0x5ab4a1=a83_0x3680bb;let _0x3ffb04=0x0;const _0x59682d=0xa;while(_0x3ffb04<_0x59682d){const _0x6c5869=nanoid(),_0x4632d7=await database_1['default'][_0x5ab4a1(0x1d1)][_0x5ab4a1(0x1d7)]({'where':{'shortCode':_0x6c5869}});if(!_0x4632d7)return _0x6c5869;_0x3ffb04++;}throw new Error(_0x5ab4a1(0x1e6));}}exports[a83_0x3680bb(0x1e4)]=PrePaymentService,exports[a83_0x3680bb(0x1cf)]=new PrePaymentService();