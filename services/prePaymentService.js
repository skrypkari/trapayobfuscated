'use strict';const a83_0x1e27dc=a83_0x59a8;(function(_0x5f2f36,_0x1685e5){const _0x3973e6=a83_0x59a8,_0x68fecb=_0x5f2f36();while(!![]){try{const _0x1438af=-parseInt(_0x3973e6(0x19a))/0x1*(-parseInt(_0x3973e6(0x1a3))/0x2)+parseInt(_0x3973e6(0x1a8))/0x3+-parseInt(_0x3973e6(0x19e))/0x4*(-parseInt(_0x3973e6(0x191))/0x5)+-parseInt(_0x3973e6(0x1aa))/0x6*(-parseInt(_0x3973e6(0x1b1))/0x7)+parseInt(_0x3973e6(0x1a6))/0x8*(-parseInt(_0x3973e6(0x1b5))/0x9)+parseInt(_0x3973e6(0x1b6))/0xa*(-parseInt(_0x3973e6(0x18e))/0xb)+-parseInt(_0x3973e6(0x1ae))/0xc*(parseInt(_0x3973e6(0x19c))/0xd);if(_0x1438af===_0x1685e5)break;else _0x68fecb['push'](_0x68fecb['shift']());}catch(_0x24dee1){_0x68fecb['push'](_0x68fecb['shift']());}}}(a83_0x5ce4,0x24efe));function a83_0x5ce4(){const _0x56b7ec=['153089iRHSkp','abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789','793FVlZmJ','generateUniqueShortCode','12vajoLP','Pre-payment\x20not\x20found','EXPIRED','../config/database','orderId','2SBuSum','Failed\x20to\x20generate\x20unique\x20short\x20code','amount','40MbrtOS','customerEmail','224463txtWrf','customerCountry','50682UvQojz','PrePaymentService','pendingUrl','failUrl','11892FAKDMs','shopId','expiresAt','77nSTfYO','confirmPrePayment','__esModule','prePaymentService','500193xVHHZB','10YaxsoP','getPrePaymentByCode','status','country','network','default','create','Pre-payment\x20is\x20no\x20longer\x20available','successUrl','1249259AGExDT','sourceCurrency','gateway','470620nyalzi','customerIp','currency','prePayment','findUnique','customerName','nanoid','language','Pre-payment\x20has\x20expired'];a83_0x5ce4=function(){return _0x56b7ec;};return a83_0x5ce4();}var __importDefault=this&&this['__importDefault']||function(_0x1626cc){return _0x1626cc&&_0x1626cc['__esModule']?_0x1626cc:{'default':_0x1626cc};};Object['defineProperty'](exports,a83_0x1e27dc(0x1b3),{'value':!![]}),exports['prePaymentService']=exports[a83_0x1e27dc(0x1ab)]=void 0x0;const database_1=__importDefault(require(a83_0x1e27dc(0x1a1))),nanoid_1=require(a83_0x1e27dc(0x197)),nanoid=(0x0,nanoid_1['customAlphabet'])(a83_0x1e27dc(0x19b),0x8);function a83_0x59a8(_0xf1e7ad,_0x4d9edd){_0xf1e7ad=_0xf1e7ad-0x188;const _0x5ce412=a83_0x5ce4();let _0x59a8ee=_0x5ce412[_0xf1e7ad];return _0x59a8ee;}class PrePaymentService{async['createPrePayment'](_0x2b4078){const _0x163894=a83_0x1e27dc,_0x73eac4=await this[_0x163894(0x19d)](),_0x445008=new Date(Date['now']()+0x1e*0x3c*0x3e8),_0x524b98=await database_1['default'][_0x163894(0x194)][_0x163894(0x18b)]({'data':{'shortCode':_0x73eac4,'shopId':_0x2b4078[_0x163894(0x1af)],'gateway':_0x2b4078[_0x163894(0x190)],'amount':_0x2b4078[_0x163894(0x1a5)],'currency':_0x2b4078[_0x163894(0x193)],'sourceCurrency':_0x2b4078[_0x163894(0x18f)],'network':_0x2b4078[_0x163894(0x189)],'orderId':_0x2b4078['orderId'],'country':_0x2b4078[_0x163894(0x188)],'language':_0x2b4078[_0x163894(0x198)],'successUrl':_0x2b4078[_0x163894(0x18d)],'failUrl':_0x2b4078[_0x163894(0x1ad)],'pendingUrl':_0x2b4078[_0x163894(0x1ac)],'expiresAt':_0x445008,'status':'PENDING'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x267322=process.env.FRONTEND_URL||'https://app.trapay.uk',_0x5b8277=_0x267322+'/p/'+_0x73eac4;return{'prePaymentId':_0x524b98['id'],'shortCode':_0x524b98['shortCode'],'proxyUrl':_0x5b8277,'expiresAt':_0x524b98[_0x163894(0x1b0)]};}async[a83_0x1e27dc(0x1b7)](_0x1bd072){const _0x312601=a83_0x1e27dc,_0xe42a1c=await database_1[_0x312601(0x18a)][_0x312601(0x194)]['findUnique']({'where':{'shortCode':_0x1bd072},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xe42a1c)throw new Error(_0x312601(0x19f));if(_0xe42a1c[_0x312601(0x1b8)]!=='PENDING')throw new Error(_0x312601(0x18c));if(new Date()>_0xe42a1c[_0x312601(0x1b0)]){await database_1[_0x312601(0x18a)]['prePayment']['update']({'where':{'id':_0xe42a1c['id']},'data':{'status':_0x312601(0x1a0)}});throw new Error(_0x312601(0x199));}return _0xe42a1c;}async[a83_0x1e27dc(0x1b2)](_0x36b593,_0x5111b4){const _0x281456=a83_0x1e27dc,_0x96c8c6=await this[_0x281456(0x1b7)](_0x36b593);return await database_1[_0x281456(0x18a)][_0x281456(0x194)]['update']({'where':{'id':_0x96c8c6['id']},'data':{'customerEmail':_0x5111b4[_0x281456(0x1a7)],'customerName':_0x5111b4[_0x281456(0x196)],'status':'CONFIRMED','confirmedAt':new Date()}}),{'prePaymentId':_0x96c8c6['id'],'customerEmail':_0x5111b4[_0x281456(0x1a7)],'customerName':_0x5111b4['customerName'],'customerIp':_0x5111b4[_0x281456(0x192)],'customerCountry':_0x5111b4[_0x281456(0x1a9)],'shopId':_0x96c8c6[_0x281456(0x1af)],'gateway':_0x96c8c6['gateway'],'amount':_0x96c8c6[_0x281456(0x1a5)],'currency':_0x96c8c6[_0x281456(0x193)],'sourceCurrency':_0x96c8c6['sourceCurrency'],'network':_0x96c8c6[_0x281456(0x189)],'orderId':_0x96c8c6[_0x281456(0x1a2)],'country':_0x96c8c6[_0x281456(0x188)],'language':_0x96c8c6[_0x281456(0x198)],'successUrl':_0x96c8c6[_0x281456(0x18d)],'failUrl':_0x96c8c6['failUrl'],'pendingUrl':_0x96c8c6['pendingUrl']};}async[a83_0x1e27dc(0x19d)](){const _0xe05ea3=a83_0x1e27dc;let _0x33236f=0x0;const _0x30d02b=0xa;while(_0x33236f<_0x30d02b){const _0x3cbe37=nanoid(),_0x58d31d=await database_1['default'][_0xe05ea3(0x194)][_0xe05ea3(0x195)]({'where':{'shortCode':_0x3cbe37}});if(!_0x58d31d)return _0x3cbe37;_0x33236f++;}throw new Error(_0xe05ea3(0x1a4));}}exports[a83_0x1e27dc(0x1ab)]=PrePaymentService,exports[a83_0x1e27dc(0x1b4)]=new PrePaymentService();