'use strict';const a83_0xc77baf=a83_0x1ff9;(function(_0x3a2ddf,_0x2e962f){const _0x2f0135=a83_0x1ff9,_0x1b6b43=_0x3a2ddf();while(!![]){try{const _0x459804=parseInt(_0x2f0135(0x12b))/0x1*(-parseInt(_0x2f0135(0x12c))/0x2)+-parseInt(_0x2f0135(0x154))/0x3*(parseInt(_0x2f0135(0x146))/0x4)+-parseInt(_0x2f0135(0x13c))/0x5*(parseInt(_0x2f0135(0x13b))/0x6)+-parseInt(_0x2f0135(0x142))/0x7*(-parseInt(_0x2f0135(0x147))/0x8)+-parseInt(_0x2f0135(0x14b))/0x9*(parseInt(_0x2f0135(0x140))/0xa)+-parseInt(_0x2f0135(0x137))/0xb+parseInt(_0x2f0135(0x135))/0xc*(parseInt(_0x2f0135(0x130))/0xd);if(_0x459804===_0x2e962f)break;else _0x1b6b43['push'](_0x1b6b43['shift']());}catch(_0x453c33){_0x1b6b43['push'](_0x1b6b43['shift']());}}}(a83_0x5f37,0x6b2ff));var __importDefault=this&&this['__importDefault']||function(_0x32d748){const _0x509823=a83_0x1ff9;return _0x32d748&&_0x32d748[_0x509823(0x129)]?_0x32d748:{'default':_0x32d748};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a83_0xc77baf(0x12f)]=exports[a83_0xc77baf(0x139)]=void 0x0;const database_1=__importDefault(require(a83_0xc77baf(0x14a))),nanoid_1=require(a83_0xc77baf(0x120)),nanoid=(0x0,nanoid_1[a83_0xc77baf(0x148)])(a83_0xc77baf(0x122),0x8);class PrePaymentService{async[a83_0xc77baf(0x132)](_0x3378d8){const _0x1700bd=a83_0xc77baf,_0x216132=await this[_0x1700bd(0x14d)](),_0x3ef9e4=new Date(Date[_0x1700bd(0x12a)]()+0x1e*0x3c*0x3e8),_0x181654=await database_1[_0x1700bd(0x13d)][_0x1700bd(0x133)][_0x1700bd(0x13a)]({'data':{'shortCode':_0x216132,'shopId':_0x3378d8[_0x1700bd(0x152)],'gateway':_0x3378d8['gateway'],'amount':_0x3378d8[_0x1700bd(0x134)],'currency':_0x3378d8['currency'],'sourceCurrency':_0x3378d8[_0x1700bd(0x127)],'network':_0x3378d8[_0x1700bd(0x143)],'orderId':_0x3378d8[_0x1700bd(0x121)],'country':_0x3378d8[_0x1700bd(0x128)],'language':_0x3378d8['language'],'successUrl':_0x3378d8['successUrl'],'failUrl':_0x3378d8['failUrl'],'pendingUrl':_0x3378d8[_0x1700bd(0x151)],'customerEmail':_0x3378d8['customerEmail'],'customerName':_0x3378d8[_0x1700bd(0x12d)],'expiresAt':_0x3ef9e4,'status':'PENDING'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x5623c7=process.env.FRONTEND_URL||_0x1700bd(0x14f),_0x5d5e54=_0x5623c7+'/p/'+_0x216132;return{'prePaymentId':_0x181654['id'],'shortCode':_0x181654[_0x1700bd(0x131)],'proxyUrl':_0x5d5e54,'expiresAt':_0x181654[_0x1700bd(0x13f)]};}async[a83_0xc77baf(0x150)](_0x31fa9d){const _0x4af57d=a83_0xc77baf,_0x58a734=await database_1[_0x4af57d(0x13d)][_0x4af57d(0x133)][_0x4af57d(0x125)]({'where':{'shortCode':_0x31fa9d},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x58a734)throw new Error('Pre-payment\x20not\x20found');if(_0x58a734[_0x4af57d(0x12e)]!==_0x4af57d(0x123))throw new Error(_0x4af57d(0x14e));if(new Date()>_0x58a734[_0x4af57d(0x13f)]){await database_1[_0x4af57d(0x13d)][_0x4af57d(0x133)][_0x4af57d(0x145)]({'where':{'id':_0x58a734['id']},'data':{'status':'EXPIRED'}});throw new Error(_0x4af57d(0x13e));}return _0x58a734;}async[a83_0xc77baf(0x144)](_0x1cf93f,_0x6be5ac){const _0x23e9db=a83_0xc77baf,_0x86e080=await this[_0x23e9db(0x150)](_0x1cf93f);return await database_1['default']['prePayment'][_0x23e9db(0x145)]({'where':{'id':_0x86e080['id']},'data':{'customerEmail':_0x6be5ac[_0x23e9db(0x126)],'customerName':_0x6be5ac['customerName'],'status':_0x23e9db(0x124),'confirmedAt':new Date()}}),{'prePaymentId':_0x86e080['id'],'customerEmail':_0x6be5ac[_0x23e9db(0x126)],'customerName':_0x6be5ac['customerName'],'customerIp':_0x6be5ac['customerIp'],'customerCountry':_0x6be5ac[_0x23e9db(0x153)],'shopId':_0x86e080[_0x23e9db(0x152)],'gateway':_0x86e080[_0x23e9db(0x138)],'amount':_0x86e080['amount'],'currency':_0x86e080[_0x23e9db(0x136)],'sourceCurrency':_0x86e080[_0x23e9db(0x127)],'network':_0x86e080[_0x23e9db(0x143)],'orderId':_0x86e080['orderId'],'country':_0x86e080[_0x23e9db(0x128)],'language':_0x86e080[_0x23e9db(0x14c)],'successUrl':_0x86e080[_0x23e9db(0x141)],'failUrl':_0x86e080['failUrl'],'pendingUrl':_0x86e080[_0x23e9db(0x151)]};}async[a83_0xc77baf(0x14d)](){const _0x327fb9=a83_0xc77baf;let _0x57d700=0x0;const _0x3451fd=0xa;while(_0x57d700<_0x3451fd){const _0x363430=nanoid(),_0x1d11da=await database_1[_0x327fb9(0x13d)][_0x327fb9(0x133)][_0x327fb9(0x125)]({'where':{'shortCode':_0x363430}});if(!_0x1d11da)return _0x363430;_0x57d700++;}throw new Error(_0x327fb9(0x149));}}function a83_0x1ff9(_0x35a27b,_0x255f8c){_0x35a27b=_0x35a27b-0x120;const _0x5f3797=a83_0x5f37();let _0x1ff999=_0x5f3797[_0x35a27b];return _0x1ff999;}function a83_0x5f37(){const _0x4075ed=['pendingUrl','shopId','customerCountry','29919lMMdhK','nanoid','orderId','abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789','PENDING','CONFIRMED','findUnique','customerEmail','sourceCurrency','country','__esModule','now','635IEaqfA','1618wnQkls','customerName','status','prePaymentService','91YelkMt','shortCode','createPrePayment','prePayment','amount','4327644xgMrcg','currency','7322744cvzuJk','gateway','PrePaymentService','create','161520aZawRL','30OmGryw','default','Pre-payment\x20has\x20expired','expiresAt','370eEnaCC','successUrl','4618936FWbvWO','network','confirmPrePayment','update','280iOnpRF','8rzocYM','customAlphabet','Failed\x20to\x20generate\x20unique\x20short\x20code','../config/database','171783vCJoSq','language','generateUniqueShortCode','Pre-payment\x20is\x20no\x20longer\x20available','https://app.trapay.uk','getPrePaymentByCode'];a83_0x5f37=function(){return _0x4075ed;};return a83_0x5f37();}exports[a83_0xc77baf(0x139)]=PrePaymentService,exports[a83_0xc77baf(0x12f)]=new PrePaymentService();