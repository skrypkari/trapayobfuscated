'use strict';const a83_0x5bba3b=a83_0x21fd;function a83_0x21fd(_0x1a4632,_0x5974a8){_0x1a4632=_0x1a4632-0x170;const _0x29cbe2=a83_0x29cb();let _0x21fd71=_0x29cbe2[_0x1a4632];return _0x21fd71;}(function(_0xfc6bda,_0xbab5c3){const _0x3767f8=a83_0x21fd,_0x5ece83=_0xfc6bda();while(!![]){try{const _0x4657de=parseInt(_0x3767f8(0x186))/0x1+parseInt(_0x3767f8(0x18b))/0x2*(parseInt(_0x3767f8(0x171))/0x3)+parseInt(_0x3767f8(0x19a))/0x4*(-parseInt(_0x3767f8(0x1a2))/0x5)+-parseInt(_0x3767f8(0x1a3))/0x6+parseInt(_0x3767f8(0x190))/0x7*(-parseInt(_0x3767f8(0x19e))/0x8)+-parseInt(_0x3767f8(0x198))/0x9*(-parseInt(_0x3767f8(0x181))/0xa)+parseInt(_0x3767f8(0x183))/0xb*(parseInt(_0x3767f8(0x197))/0xc);if(_0x4657de===_0xbab5c3)break;else _0x5ece83['push'](_0x5ece83['shift']());}catch(_0x551eee){_0x5ece83['push'](_0x5ece83['shift']());}}}(a83_0x29cb,0x951bf));var __importDefault=this&&this['__importDefault']||function(_0x3ff3d1){const _0x2bbff3=a83_0x21fd;return _0x3ff3d1&&_0x3ff3d1[_0x2bbff3(0x178)]?_0x3ff3d1:{'default':_0x3ff3d1};};Object['defineProperty'](exports,a83_0x5bba3b(0x178),{'value':!![]}),exports[a83_0x5bba3b(0x174)]=exports['PrePaymentService']=void 0x0;const database_1=__importDefault(require(a83_0x5bba3b(0x172))),nanoid_1=require(a83_0x5bba3b(0x192)),nanoid=(0x0,nanoid_1[a83_0x5bba3b(0x176)])(a83_0x5bba3b(0x18c),0x8);function a83_0x29cb(){const _0x2d20cc=['EXPIRED','generateUniqueShortCode','431455dEpCvR','1003476EfCxPn','Failed\x20to\x20generate\x20unique\x20short\x20code','3xwRdgx','../config/database','currency','prePaymentService','sourceCurrency','customAlphabet','customerEmail','__esModule','language','gateway','update','shopId','default','Pre-payment\x20is\x20no\x20longer\x20available','Pre-payment\x20has\x20expired','network','60yIrnat','orderId','3133229SBdbEv','create','pendingUrl','339536ybzVfG','createPrePayment','amount','https://app.trapay.uk','CONFIRMED','942508zRnEdt','abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789','PrePaymentService','customerIp','confirmPrePayment','133hZEULh','now','nanoid','PENDING','country','Pre-payment\x20not\x20found','failUrl','12zNQGlG','140877PPFLbG','successUrl','16acAquT','status','findUnique','prePayment','27952NrDsGW','shortCode'];a83_0x29cb=function(){return _0x2d20cc;};return a83_0x29cb();}class PrePaymentService{async[a83_0x5bba3b(0x187)](_0x1bdb56){const _0x478bf8=a83_0x5bba3b,_0x4833da=await this[_0x478bf8(0x1a1)](),_0x3ff20f=new Date(Date[_0x478bf8(0x191)]()+0x1e*0x3c*0x3e8),_0x351fc4=await database_1[_0x478bf8(0x17d)][_0x478bf8(0x19d)][_0x478bf8(0x184)]({'data':{'shortCode':_0x4833da,'shopId':_0x1bdb56[_0x478bf8(0x17c)],'gateway':_0x1bdb56[_0x478bf8(0x17a)],'amount':_0x1bdb56[_0x478bf8(0x188)],'currency':_0x1bdb56[_0x478bf8(0x173)],'sourceCurrency':_0x1bdb56[_0x478bf8(0x175)],'network':_0x1bdb56[_0x478bf8(0x180)],'orderId':_0x1bdb56['orderId'],'country':_0x1bdb56[_0x478bf8(0x194)],'language':_0x1bdb56[_0x478bf8(0x179)],'successUrl':_0x1bdb56[_0x478bf8(0x199)],'failUrl':_0x1bdb56['failUrl'],'pendingUrl':_0x1bdb56[_0x478bf8(0x185)],'customerEmail':_0x1bdb56[_0x478bf8(0x177)],'customerName':_0x1bdb56['customerName'],'expiresAt':_0x3ff20f,'status':_0x478bf8(0x193)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x8ae2fd=process.env.FRONTEND_URL||_0x478bf8(0x189),_0x325047=_0x8ae2fd+'/p/'+_0x4833da;return{'prePaymentId':_0x351fc4['id'],'shortCode':_0x351fc4[_0x478bf8(0x19f)],'proxyUrl':_0x325047,'expiresAt':_0x351fc4['expiresAt']};}async['getPrePaymentByCode'](_0x6b23e){const _0x3e7c8d=a83_0x5bba3b,_0xf60dae=await database_1['default']['prePayment'][_0x3e7c8d(0x19c)]({'where':{'shortCode':_0x6b23e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xf60dae)throw new Error(_0x3e7c8d(0x195));if(_0xf60dae[_0x3e7c8d(0x19b)]!=='PENDING')throw new Error(_0x3e7c8d(0x17e));if(new Date()>_0xf60dae['expiresAt']){await database_1[_0x3e7c8d(0x17d)][_0x3e7c8d(0x19d)]['update']({'where':{'id':_0xf60dae['id']},'data':{'status':_0x3e7c8d(0x1a0)}});throw new Error(_0x3e7c8d(0x17f));}return _0xf60dae;}async[a83_0x5bba3b(0x18f)](_0x336a87,_0x217139){const _0x46ce01=a83_0x5bba3b,_0x43bf5a=await this['getPrePaymentByCode'](_0x336a87);return await database_1[_0x46ce01(0x17d)][_0x46ce01(0x19d)][_0x46ce01(0x17b)]({'where':{'id':_0x43bf5a['id']},'data':{'customerEmail':_0x217139['customerEmail'],'customerName':_0x217139['customerName'],'status':_0x46ce01(0x18a),'confirmedAt':new Date()}}),{'prePaymentId':_0x43bf5a['id'],'customerEmail':_0x217139[_0x46ce01(0x177)],'customerName':_0x217139['customerName'],'customerIp':_0x217139[_0x46ce01(0x18e)],'customerCountry':_0x217139['customerCountry'],'shopId':_0x43bf5a[_0x46ce01(0x17c)],'gateway':_0x43bf5a[_0x46ce01(0x17a)],'amount':_0x43bf5a[_0x46ce01(0x188)],'currency':_0x43bf5a[_0x46ce01(0x173)],'sourceCurrency':_0x43bf5a[_0x46ce01(0x175)],'network':_0x43bf5a[_0x46ce01(0x180)],'orderId':_0x43bf5a[_0x46ce01(0x182)],'country':_0x43bf5a[_0x46ce01(0x194)],'language':_0x43bf5a[_0x46ce01(0x179)],'successUrl':_0x43bf5a[_0x46ce01(0x199)],'failUrl':_0x43bf5a[_0x46ce01(0x196)],'pendingUrl':_0x43bf5a[_0x46ce01(0x185)]};}async[a83_0x5bba3b(0x1a1)](){const _0x1eaa96=a83_0x5bba3b;let _0x33f2c6=0x0;const _0x37ded0=0xa;while(_0x33f2c6<_0x37ded0){const _0xdc1c3b=nanoid(),_0x5af388=await database_1[_0x1eaa96(0x17d)]['prePayment']['findUnique']({'where':{'shortCode':_0xdc1c3b}});if(!_0x5af388)return _0xdc1c3b;_0x33f2c6++;}throw new Error(_0x1eaa96(0x170));}}exports[a83_0x5bba3b(0x18d)]=PrePaymentService,exports[a83_0x5bba3b(0x174)]=new PrePaymentService();