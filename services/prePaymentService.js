'use strict';const a83_0x3d1f27=a83_0x41ec;(function(_0x26f54b,_0x2f4d57){const _0x508e3c=a83_0x41ec,_0x569188=_0x26f54b();while(!![]){try{const _0x4f531b=-parseInt(_0x508e3c(0x98))/0x1+parseInt(_0x508e3c(0xa1))/0x2+parseInt(_0x508e3c(0xb7))/0x3+-parseInt(_0x508e3c(0xa8))/0x4+parseInt(_0x508e3c(0x9d))/0x5+-parseInt(_0x508e3c(0x93))/0x6*(-parseInt(_0x508e3c(0xb2))/0x7)+-parseInt(_0x508e3c(0xb6))/0x8;if(_0x4f531b===_0x2f4d57)break;else _0x569188['push'](_0x569188['shift']());}catch(_0x6306){_0x569188['push'](_0x569188['shift']());}}}(a83_0x32c9,0xab519));var __importDefault=this&&this[a83_0x3d1f27(0xa5)]||function(_0x53e3d4){const _0x41676b=a83_0x3d1f27;return _0x53e3d4&&_0x53e3d4[_0x41676b(0xb0)]?_0x53e3d4:{'default':_0x53e3d4};};Object['defineProperty'](exports,a83_0x3d1f27(0xb0),{'value':!![]}),exports['prePaymentService']=exports['PrePaymentService']=void 0x0;function a83_0x32c9(){const _0x2d4bd2=['CONFIRMED','__importDefault','successUrl','shortCode','5303980SElqFd','shopId','create','customAlphabet','customerName','network','Pre-payment\x20not\x20found','customerCountry','__esModule','../config/database','14JlzXWj','amount','confirmPrePayment','currency','6803568ZNbHSk','3780108wPjyDp','nanoid','/p/','default','https://app.trapay.uk','orderId','PrePaymentService','Pre-payment\x20is\x20no\x20longer\x20available','gateway','getPrePaymentByCode','1466778BNKOvL','abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789','customerEmail','prePayment','status','73085DKJuzf','pendingUrl','update','createPrePayment','failUrl','1202330XqMKcN','country','findUnique','sourceCurrency','1923638XgHpXU','expiresAt','language'];a83_0x32c9=function(){return _0x2d4bd2;};return a83_0x32c9();}function a83_0x41ec(_0x356f1b,_0x5e7500){_0x356f1b=_0x356f1b-0x8d;const _0x32c99b=a83_0x32c9();let _0x41ecf5=_0x32c99b[_0x356f1b];return _0x41ecf5;}const database_1=__importDefault(require(a83_0x3d1f27(0xb1))),nanoid_1=require(a83_0x3d1f27(0xb8)),nanoid=(0x0,nanoid_1[a83_0x3d1f27(0xab)])(a83_0x3d1f27(0x94),0x8);class PrePaymentService{async[a83_0x3d1f27(0x9b)](_0x42a465){const _0x122670=a83_0x3d1f27,_0x4db41c=await this['generateUniqueShortCode'](),_0x25d36b=new Date(Date['now']()+0x1e*0x3c*0x3e8),_0x4f41e9=await database_1[_0x122670(0xba)][_0x122670(0x96)][_0x122670(0xaa)]({'data':{'shortCode':_0x4db41c,'shopId':_0x42a465[_0x122670(0xa9)],'gateway':_0x42a465[_0x122670(0x91)],'amount':_0x42a465['amount'],'currency':_0x42a465[_0x122670(0xb5)],'sourceCurrency':_0x42a465[_0x122670(0xa0)],'network':_0x42a465[_0x122670(0xad)],'orderId':_0x42a465[_0x122670(0x8e)],'country':_0x42a465[_0x122670(0x9e)],'language':_0x42a465[_0x122670(0xa3)],'successUrl':_0x42a465[_0x122670(0xa6)],'failUrl':_0x42a465[_0x122670(0x9c)],'pendingUrl':_0x42a465[_0x122670(0x99)],'customerEmail':_0x42a465[_0x122670(0x95)],'customerName':_0x42a465[_0x122670(0xac)],'expiresAt':_0x25d36b,'status':'PENDING'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x5e7506=process.env.FRONTEND_URL||_0x122670(0x8d),_0x5d27b0=_0x5e7506+_0x122670(0xb9)+_0x4db41c;return{'prePaymentId':_0x4f41e9['id'],'shortCode':_0x4f41e9[_0x122670(0xa7)],'proxyUrl':_0x5d27b0,'expiresAt':_0x4f41e9[_0x122670(0xa2)]};}async['getPrePaymentByCode'](_0x474dcb){const _0x1081e9=a83_0x3d1f27,_0x480653=await database_1[_0x1081e9(0xba)]['prePayment'][_0x1081e9(0x9f)]({'where':{'shortCode':_0x474dcb},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x480653)throw new Error(_0x1081e9(0xae));if(_0x480653[_0x1081e9(0x97)]!=='PENDING')throw new Error(_0x1081e9(0x90));if(new Date()>_0x480653[_0x1081e9(0xa2)]){await database_1['default'][_0x1081e9(0x96)][_0x1081e9(0x9a)]({'where':{'id':_0x480653['id']},'data':{'status':'EXPIRED'}});throw new Error('Pre-payment\x20has\x20expired');}return _0x480653;}async[a83_0x3d1f27(0xb4)](_0x4b382e,_0x367d99){const _0x270d3c=a83_0x3d1f27,_0x250f1e=await this[_0x270d3c(0x92)](_0x4b382e);return await database_1[_0x270d3c(0xba)][_0x270d3c(0x96)][_0x270d3c(0x9a)]({'where':{'id':_0x250f1e['id']},'data':{'customerEmail':_0x367d99[_0x270d3c(0x95)],'customerName':_0x367d99[_0x270d3c(0xac)],'status':_0x270d3c(0xa4),'confirmedAt':new Date()}}),{'prePaymentId':_0x250f1e['id'],'customerEmail':_0x367d99[_0x270d3c(0x95)],'customerName':_0x367d99[_0x270d3c(0xac)],'customerIp':_0x367d99['customerIp'],'customerCountry':_0x367d99[_0x270d3c(0xaf)],'shopId':_0x250f1e['shopId'],'gateway':_0x250f1e[_0x270d3c(0x91)],'amount':_0x250f1e[_0x270d3c(0xb3)],'currency':_0x250f1e[_0x270d3c(0xb5)],'sourceCurrency':_0x250f1e[_0x270d3c(0xa0)],'network':_0x250f1e[_0x270d3c(0xad)],'orderId':_0x250f1e[_0x270d3c(0x8e)],'country':_0x250f1e[_0x270d3c(0x9e)],'language':_0x250f1e['language'],'successUrl':_0x250f1e[_0x270d3c(0xa6)],'failUrl':_0x250f1e[_0x270d3c(0x9c)],'pendingUrl':_0x250f1e[_0x270d3c(0x99)]};}async['generateUniqueShortCode'](){const _0x36c500=a83_0x3d1f27;let _0x2003e8=0x0;const _0x52b603=0xa;while(_0x2003e8<_0x52b603){const _0x30be76=nanoid(),_0xb26afa=await database_1[_0x36c500(0xba)]['prePayment']['findUnique']({'where':{'shortCode':_0x30be76}});if(!_0xb26afa)return _0x30be76;_0x2003e8++;}throw new Error('Failed\x20to\x20generate\x20unique\x20short\x20code');}}exports[a83_0x3d1f27(0x8f)]=PrePaymentService,exports['prePaymentService']=new PrePaymentService();