'use strict';const a83_0x25a21f=a83_0x3c88;(function(_0x934d34,_0x4375c2){const _0x2f3ec6=a83_0x3c88,_0x33251b=_0x934d34();while(!![]){try{const _0x102d66=parseInt(_0x2f3ec6(0x145))/0x1*(-parseInt(_0x2f3ec6(0x156))/0x2)+-parseInt(_0x2f3ec6(0x139))/0x3+parseInt(_0x2f3ec6(0x12b))/0x4+parseInt(_0x2f3ec6(0x152))/0x5*(-parseInt(_0x2f3ec6(0x143))/0x6)+-parseInt(_0x2f3ec6(0x146))/0x7+-parseInt(_0x2f3ec6(0x14d))/0x8+parseInt(_0x2f3ec6(0x131))/0x9;if(_0x102d66===_0x4375c2)break;else _0x33251b['push'](_0x33251b['shift']());}catch(_0x5c3334){_0x33251b['push'](_0x33251b['shift']());}}}(a83_0x2d6e,0xd0baf));var __importDefault=this&&this[a83_0x25a21f(0x14b)]||function(_0x2d6f97){const _0x396242=a83_0x25a21f;return _0x2d6f97&&_0x2d6f97[_0x396242(0x150)]?_0x2d6f97:{'default':_0x2d6f97};};function a83_0x3c88(_0xd9f29f,_0x218f35){_0xd9f29f=_0xd9f29f-0x123;const _0x2d6e40=a83_0x2d6e();let _0x3c88b0=_0x2d6e40[_0xd9f29f];return _0x3c88b0;}Object[a83_0x25a21f(0x138)](exports,a83_0x25a21f(0x150),{'value':!![]}),exports['prePaymentService']=exports[a83_0x25a21f(0x14f)]=void 0x0;const database_1=__importDefault(require(a83_0x25a21f(0x125))),nanoid_1=require(a83_0x25a21f(0x142)),nanoid=(0x0,nanoid_1[a83_0x25a21f(0x14e)])(a83_0x25a21f(0x14c),0x8);function a83_0x2d6e(){const _0x2b0900=['expiresAt','4GGKdXc','currency','language','../config/database','customerCountry','network','sourceCurrency','default','findUnique','2009328eQDjhK','pendingUrl','Pre-payment\x20not\x20found','customerName','CONFIRMED','gateway','32773338tpceMm','amount','failUrl','shopId','getPrePaymentByCode','https://app.trapay.uk','shortCode','defineProperty','4931340mbXZat','EXPIRED','orderId','prePayment','PENDING','customerEmail','successUrl','status','generateUniqueShortCode','nanoid','3680286rffPKY','prePaymentService','243053fNKjGc','2104193kyvvvk','update','/p/','now','confirmPrePayment','__importDefault','abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789','1959912PWkfFB','customAlphabet','PrePaymentService','__esModule','customerIp','5BMgZpG','Pre-payment\x20is\x20no\x20longer\x20available','createPrePayment'];a83_0x2d6e=function(){return _0x2b0900;};return a83_0x2d6e();}class PrePaymentService{async[a83_0x25a21f(0x154)](_0x112637){const _0x156ebc=a83_0x25a21f,_0x13fcd0=await this['generateUniqueShortCode'](),_0x35ce35=new Date(Date[_0x156ebc(0x149)]()+0x1e*0x3c*0x3e8),_0x4e29c5=await database_1['default'][_0x156ebc(0x13c)]['create']({'data':{'shortCode':_0x13fcd0,'shopId':_0x112637[_0x156ebc(0x134)],'gateway':_0x112637[_0x156ebc(0x130)],'amount':_0x112637['amount'],'currency':_0x112637[_0x156ebc(0x123)],'sourceCurrency':_0x112637[_0x156ebc(0x128)],'network':_0x112637['network'],'orderId':_0x112637[_0x156ebc(0x13b)],'country':_0x112637['country'],'language':_0x112637[_0x156ebc(0x124)],'successUrl':_0x112637['successUrl'],'failUrl':_0x112637[_0x156ebc(0x133)],'pendingUrl':_0x112637[_0x156ebc(0x12c)],'expiresAt':_0x35ce35,'status':_0x156ebc(0x13d)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x219cbd=process.env.FRONTEND_URL||_0x156ebc(0x136),_0x29b135=_0x219cbd+_0x156ebc(0x148)+_0x13fcd0;return{'prePaymentId':_0x4e29c5['id'],'shortCode':_0x4e29c5[_0x156ebc(0x137)],'proxyUrl':_0x29b135,'expiresAt':_0x4e29c5[_0x156ebc(0x155)]};}async[a83_0x25a21f(0x135)](_0x62e1c4){const _0x258cf2=a83_0x25a21f,_0x1fa098=await database_1[_0x258cf2(0x129)]['prePayment'][_0x258cf2(0x12a)]({'where':{'shortCode':_0x62e1c4},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1fa098)throw new Error(_0x258cf2(0x12d));if(_0x1fa098[_0x258cf2(0x140)]!==_0x258cf2(0x13d))throw new Error(_0x258cf2(0x153));if(new Date()>_0x1fa098[_0x258cf2(0x155)]){await database_1[_0x258cf2(0x129)][_0x258cf2(0x13c)][_0x258cf2(0x147)]({'where':{'id':_0x1fa098['id']},'data':{'status':_0x258cf2(0x13a)}});throw new Error('Pre-payment\x20has\x20expired');}return _0x1fa098;}async[a83_0x25a21f(0x14a)](_0x3665e5,_0x59e49a){const _0x5d8c0f=a83_0x25a21f,_0x3697dd=await this[_0x5d8c0f(0x135)](_0x3665e5);return await database_1[_0x5d8c0f(0x129)][_0x5d8c0f(0x13c)][_0x5d8c0f(0x147)]({'where':{'id':_0x3697dd['id']},'data':{'customerEmail':_0x59e49a[_0x5d8c0f(0x13e)],'customerName':_0x59e49a[_0x5d8c0f(0x12e)],'status':_0x5d8c0f(0x12f),'confirmedAt':new Date()}}),{'prePaymentId':_0x3697dd['id'],'customerEmail':_0x59e49a['customerEmail'],'customerName':_0x59e49a['customerName'],'customerIp':_0x59e49a[_0x5d8c0f(0x151)],'customerCountry':_0x59e49a[_0x5d8c0f(0x126)],'shopId':_0x3697dd['shopId'],'gateway':_0x3697dd[_0x5d8c0f(0x130)],'amount':_0x3697dd[_0x5d8c0f(0x132)],'currency':_0x3697dd['currency'],'sourceCurrency':_0x3697dd['sourceCurrency'],'network':_0x3697dd[_0x5d8c0f(0x127)],'orderId':_0x3697dd[_0x5d8c0f(0x13b)],'country':_0x3697dd['country'],'language':_0x3697dd[_0x5d8c0f(0x124)],'successUrl':_0x3697dd[_0x5d8c0f(0x13f)],'failUrl':_0x3697dd[_0x5d8c0f(0x133)],'pendingUrl':_0x3697dd[_0x5d8c0f(0x12c)]};}async[a83_0x25a21f(0x141)](){const _0x5a59a5=a83_0x25a21f;let _0x2a6781=0x0;const _0x2e9e80=0xa;while(_0x2a6781<_0x2e9e80){const _0x472c3c=nanoid(),_0x2ea955=await database_1[_0x5a59a5(0x129)]['prePayment'][_0x5a59a5(0x12a)]({'where':{'shortCode':_0x472c3c}});if(!_0x2ea955)return _0x472c3c;_0x2a6781++;}throw new Error('Failed\x20to\x20generate\x20unique\x20short\x20code');}}exports[a83_0x25a21f(0x14f)]=PrePaymentService,exports[a83_0x25a21f(0x144)]=new PrePaymentService();