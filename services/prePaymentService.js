'use strict';const a79_0x2edca4=a79_0x5dd8;(function(_0x5d93a3,_0xdc1e04){const _0x24fcc2=a79_0x5dd8,_0xb18ad3=_0x5d93a3();while(!![]){try{const _0x38ce15=parseInt(_0x24fcc2(0x105))/0x1+parseInt(_0x24fcc2(0x117))/0x2*(-parseInt(_0x24fcc2(0x108))/0x3)+parseInt(_0x24fcc2(0x11e))/0x4*(parseInt(_0x24fcc2(0x122))/0x5)+parseInt(_0x24fcc2(0x116))/0x6+parseInt(_0x24fcc2(0x101))/0x7+-parseInt(_0x24fcc2(0x114))/0x8+-parseInt(_0x24fcc2(0x10e))/0x9;if(_0x38ce15===_0xdc1e04)break;else _0xb18ad3['push'](_0xb18ad3['shift']());}catch(_0xa1bbc4){_0xb18ad3['push'](_0xb18ad3['shift']());}}}(a79_0x117a,0x374f3));var __importDefault=this&&this['__importDefault']||function(_0x21edd1){const _0x5c98a1=a79_0x5dd8;return _0x21edd1&&_0x21edd1[_0x5c98a1(0x10a)]?_0x21edd1:{'default':_0x21edd1};};function a79_0x5dd8(_0x21f0bc,_0x2e6d60){_0x21f0bc=_0x21f0bc-0xf9;const _0x117a26=a79_0x117a();let _0x5dd885=_0x117a26[_0x21f0bc];return _0x5dd885;}Object[a79_0x2edca4(0x102)](exports,a79_0x2edca4(0x10a),{'value':!![]}),exports[a79_0x2edca4(0x126)]=exports[a79_0x2edca4(0xfc)]=void 0x0;const database_1=__importDefault(require('../config/database')),nanoid_1=require(a79_0x2edca4(0x10b)),nanoid=(0x0,nanoid_1[a79_0x2edca4(0x103)])(a79_0x2edca4(0x129),0x8);class PrePaymentService{async[a79_0x2edca4(0x10c)](_0x484d2e){const _0x4a17b5=a79_0x2edca4,_0x5139a1=await this['generateUniqueShortCode'](),_0x4886c7=new Date(Date[_0x4a17b5(0xf9)]()+0x1e*0x3c*0x3e8),_0x3a47ae=await database_1['default'][_0x4a17b5(0x12a)][_0x4a17b5(0x100)]({'data':{'shortCode':_0x5139a1,'shopId':_0x484d2e[_0x4a17b5(0x11f)],'gateway':_0x484d2e['gateway'],'amount':_0x484d2e[_0x4a17b5(0x113)],'currency':_0x484d2e[_0x4a17b5(0x11d)],'sourceCurrency':_0x484d2e[_0x4a17b5(0x128)],'network':_0x484d2e[_0x4a17b5(0x118)],'orderId':_0x484d2e[_0x4a17b5(0x10f)],'country':_0x484d2e[_0x4a17b5(0x11a)],'language':_0x484d2e[_0x4a17b5(0x123)],'successUrl':_0x484d2e[_0x4a17b5(0x112)],'failUrl':_0x484d2e[_0x4a17b5(0x124)],'pendingUrl':_0x484d2e['pendingUrl'],'expiresAt':_0x4886c7,'status':_0x4a17b5(0x11c)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0xd93315=process.env.FRONTEND_URL||'https://app.trapay.uk',_0x31f04e=_0xd93315+_0x4a17b5(0x10d)+_0x5139a1;return{'prePaymentId':_0x3a47ae['id'],'shortCode':_0x3a47ae[_0x4a17b5(0xff)],'proxyUrl':_0x31f04e,'expiresAt':_0x3a47ae[_0x4a17b5(0x127)]};}async[a79_0x2edca4(0x104)](_0x5629bd){const _0x1ab775=a79_0x2edca4,_0xba096e=await database_1['default'][_0x1ab775(0x12a)]['findUnique']({'where':{'shortCode':_0x5629bd},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xba096e)throw new Error(_0x1ab775(0x119));if(_0xba096e[_0x1ab775(0x106)]!==_0x1ab775(0x11c))throw new Error('Pre-payment\x20is\x20no\x20longer\x20available');if(new Date()>_0xba096e[_0x1ab775(0x127)]){await database_1[_0x1ab775(0x111)]['prePayment'][_0x1ab775(0x11b)]({'where':{'id':_0xba096e['id']},'data':{'status':_0x1ab775(0x125)}});throw new Error('Pre-payment\x20has\x20expired');}return _0xba096e;}async[a79_0x2edca4(0xfa)](_0x1f4b59,_0x2b2d99){const _0x22da92=a79_0x2edca4,_0x30616a=await this[_0x22da92(0x104)](_0x1f4b59);return await database_1[_0x22da92(0x111)][_0x22da92(0x12a)]['update']({'where':{'id':_0x30616a['id']},'data':{'customerEmail':_0x2b2d99[_0x22da92(0xfd)],'customerName':_0x2b2d99[_0x22da92(0x107)],'status':'CONFIRMED','confirmedAt':new Date()}}),{'prePaymentId':_0x30616a['id'],'customerEmail':_0x2b2d99[_0x22da92(0xfd)],'customerName':_0x2b2d99[_0x22da92(0x107)],'customerIp':_0x2b2d99[_0x22da92(0xfe)],'customerCountry':_0x2b2d99[_0x22da92(0x115)],'shopId':_0x30616a[_0x22da92(0x11f)],'gateway':_0x30616a[_0x22da92(0x110)],'amount':_0x30616a[_0x22da92(0x113)],'currency':_0x30616a[_0x22da92(0x11d)],'sourceCurrency':_0x30616a[_0x22da92(0x128)],'network':_0x30616a[_0x22da92(0x118)],'orderId':_0x30616a[_0x22da92(0x10f)],'country':_0x30616a[_0x22da92(0x11a)],'language':_0x30616a['language'],'successUrl':_0x30616a['successUrl'],'failUrl':_0x30616a[_0x22da92(0x124)],'pendingUrl':_0x30616a[_0x22da92(0x120)]};}async[a79_0x2edca4(0x121)](){const _0x56354d=a79_0x2edca4;let _0x436665=0x0;const _0x44af77=0xa;while(_0x436665<_0x44af77){const _0x35d09c=nanoid(),_0x450904=await database_1['default'][_0x56354d(0x12a)][_0x56354d(0x109)]({'where':{'shortCode':_0x35d09c}});if(!_0x450904)return _0x35d09c;_0x436665++;}throw new Error(_0x56354d(0xfb));}}function a79_0x117a(){const _0x5ed712=['amount','793984NiTCyc','customerCountry','494364nvFBUJ','77166vrgGah','network','Pre-payment\x20not\x20found','country','update','PENDING','currency','1567472ojJlQF','shopId','pendingUrl','generateUniqueShortCode','5DolhiQ','language','failUrl','EXPIRED','prePaymentService','expiresAt','sourceCurrency','abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789','prePayment','now','confirmPrePayment','Failed\x20to\x20generate\x20unique\x20short\x20code','PrePaymentService','customerEmail','customerIp','shortCode','create','2162727BsmQZy','defineProperty','customAlphabet','getPrePaymentByCode','60129NYhDLD','status','customerName','18VxnpWu','findUnique','__esModule','nanoid','createPrePayment','/p/','2574531VgmvqL','orderId','gateway','default','successUrl'];a79_0x117a=function(){return _0x5ed712;};return a79_0x117a();}exports[a79_0x2edca4(0xfc)]=PrePaymentService,exports[a79_0x2edca4(0x126)]=new PrePaymentService();