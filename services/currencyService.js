'use strict';const a39_0x4dee0c=a39_0x1766;(function(_0x3cd0fc,_0x4e3069){const _0x379bd8=a39_0x1766,_0x411be5=_0x3cd0fc();while(!![]){try{const _0x14ee47=parseInt(_0x379bd8(0x1aa))/0x1*(-parseInt(_0x379bd8(0x18f))/0x2)+-parseInt(_0x379bd8(0x166))/0x3*(-parseInt(_0x379bd8(0x1c1))/0x4)+-parseInt(_0x379bd8(0x163))/0x5+-parseInt(_0x379bd8(0x19a))/0x6+parseInt(_0x379bd8(0x151))/0x7*(parseInt(_0x379bd8(0x168))/0x8)+-parseInt(_0x379bd8(0x188))/0x9*(-parseInt(_0x379bd8(0x1a6))/0xa)+-parseInt(_0x379bd8(0x1a2))/0xb;if(_0x14ee47===_0x4e3069)break;else _0x411be5['push'](_0x411be5['shift']());}catch(_0x85708d){_0x411be5['push'](_0x411be5['shift']());}}}(a39_0x3dc1,0x62eea));var __importDefault=this&&this[a39_0x4dee0c(0x173)]||function(_0x11aea9){return _0x11aea9&&_0x11aea9['__esModule']?_0x11aea9:{'default':_0x11aea9};};function a39_0x3dc1(){const _0x4dc4ed=['✅\x20Currency\x20rates\x20service\x20started\x20with\x20hourly\x20updates','huf','xdr','warn','580KjrZta','ils','\x20USDT,\x20with\x20','\x20currencies','toUpperCase','__esModule','Initial\x20currency\x20rates\x20update\x20failed:','14vrpzQS','currencyService','czk','ngn','https://api.coingecko.com/api/v3/simple/price','MARKUP_PERCENTAGE','bnb','Periodic\x20currency\x20rates\x20update\x20failed:','length','ltc','xag','sek','updateCurrencyRates','updatedAt','forEach','error','lkr','application/json','3814470tpAYDt','cny','thb','15585xQAcXi','convertMultipleToUSDT','3031752SUphdZ','\x20to\x20',',\x20using\x201\x20as\x20fallback','pln','❌\x20Failed\x20to\x20update\x20currency\x20rates:','yfi','try','tether','eth','krw','getCurrencyRate','__importDefault','usdt','link','eur','Error\x20getting\x20rate\x20for\x20currency\x20','\x20USDT\x20=\x20','dot','rate','nzd','json','cad','inr','kwd','chf','asc','nok','catch','🔄\x20Updating\x20currency\x20rates\x20from\x20CoinGecko...','myr','findFirst','CURRENCIES','261Lekukq','Error\x20getting\x20rates\x20status:','pkr','stopPeriodicUpdates','twd','findUnique','getAllRates','34vgmChJ','currency','bdt','desc','xrp','vnd','sar','defineProperty','getRatesStatus','bhd','mxn','350064JvnROQ','Failed\x20to\x20update\x20rate\x20for\x20','rub','💱\x20Converted\x20','?ids=tether&vs_currencies=','map','all','getMarkupPercentage','924836SHNXPf','updateInterval','currencyRate','sgd','22450itJkLD','convertToUSDT','uah','Error\x20getting\x20all\x20rates:','15634RBRlyR','log','sats','dkk','%\x20markup\x20=\x20','statusText','default','status','toLowerCase','toFixed','CoinGecko\x20API\x20error:\x20','count','upsert','CurrencyService','aed','gbp','✅\x20Currency\x20rates\x20updated\x20successfully','vef','bch'];a39_0x3dc1=function(){return _0x4dc4ed;};return a39_0x3dc1();}Object[a39_0x4dee0c(0x196)](exports,a39_0x4dee0c(0x14f),{'value':!![]}),exports[a39_0x4dee0c(0x152)]=exports['CurrencyService']=void 0x0;const database_1=__importDefault(require('../config/database'));function a39_0x1766(_0x579a3e,_0x5bf03d){const _0x3dc1b0=a39_0x3dc1();return a39_0x1766=function(_0x1766d2,_0x354193){_0x1766d2=_0x1766d2-0x14d;let _0x1aad30=_0x3dc1b0[_0x1766d2];return _0x1aad30;},a39_0x1766(_0x579a3e,_0x5bf03d);}class CurrencyService{constructor(){const _0x402ecf=a39_0x4dee0c;this['COINGECKO_URL']=_0x402ecf(0x155),this[_0x402ecf(0x187)]=['btc',_0x402ecf(0x170),_0x402ecf(0x15a),_0x402ecf(0x1bc),_0x402ecf(0x157),'eos',_0x402ecf(0x193),'xlm',_0x402ecf(0x175),_0x402ecf(0x179),_0x402ecf(0x16d),'usd',_0x402ecf(0x1b8),'ars','aud',_0x402ecf(0x191),_0x402ecf(0x198),'bmd','brl',_0x402ecf(0x17d),_0x402ecf(0x180),'clp',_0x402ecf(0x164),_0x402ecf(0x153),_0x402ecf(0x1ad),_0x402ecf(0x176),_0x402ecf(0x1b9),'gel','hkd',_0x402ecf(0x1be),'idr',_0x402ecf(0x1c2),_0x402ecf(0x17e),'jpy',_0x402ecf(0x171),_0x402ecf(0x17f),_0x402ecf(0x161),'mmk',_0x402ecf(0x199),_0x402ecf(0x185),_0x402ecf(0x154),_0x402ecf(0x182),_0x402ecf(0x17b),'php',_0x402ecf(0x18a),_0x402ecf(0x16b),_0x402ecf(0x19c),_0x402ecf(0x195),_0x402ecf(0x15c),_0x402ecf(0x1a5),_0x402ecf(0x165),_0x402ecf(0x16e),_0x402ecf(0x18c),_0x402ecf(0x1a8),_0x402ecf(0x1bb),_0x402ecf(0x194),'zar',_0x402ecf(0x1bf),_0x402ecf(0x15b),'xau','bits',_0x402ecf(0x1ac)],this['updateInterval']=null,this[_0x402ecf(0x156)]=-0x3,this['startPeriodicUpdates']();}['startPeriodicUpdates'](){const _0x103f62=a39_0x4dee0c;this[_0x103f62(0x15d)]()[_0x103f62(0x183)](_0x592f92=>{const _0x516071=_0x103f62;console[_0x516071(0x160)](_0x516071(0x150),_0x592f92);}),this[_0x103f62(0x1a3)]=setInterval(async()=>{const _0x44be1e=_0x103f62;try{await this[_0x44be1e(0x15d)]();}catch(_0x3ed121){console[_0x44be1e(0x160)](_0x44be1e(0x158),_0x3ed121);}},0x3c*0x3c*0x3e8),console[_0x103f62(0x1ab)](_0x103f62(0x1bd));}[a39_0x4dee0c(0x18b)](){const _0x181c2f=a39_0x4dee0c;this[_0x181c2f(0x1a3)]&&(clearInterval(this[_0x181c2f(0x1a3)]),this['updateInterval']=null,console['log']('🛑\x20Currency\x20rates\x20periodic\x20updates\x20stopped'));}async['updateCurrencyRates'](){const _0x313bab=a39_0x4dee0c;try{console[_0x313bab(0x1ab)](_0x313bab(0x184));const _0x217cc6=this['CURRENCIES']['join'](','),_0x1fb339=this['COINGECKO_URL']+_0x313bab(0x19e)+_0x217cc6,_0x17e310=await fetch(_0x1fb339,{'headers':{'Accept':_0x313bab(0x162),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}});if(!_0x17e310['ok'])throw new Error(_0x313bab(0x1b4)+_0x17e310[_0x313bab(0x1b1)]+'\x20'+_0x17e310[_0x313bab(0x1af)]);const _0x4e5db3=await _0x17e310[_0x313bab(0x17c)]();if(!_0x4e5db3[_0x313bab(0x16f)])throw new Error('Invalid\x20response\x20format\x20from\x20CoinGecko\x20API');const _0x55c090=_0x4e5db3['tether'];console[_0x313bab(0x1ab)]('📊\x20Received\x20rates\x20for\x20'+Object['keys'](_0x55c090)[_0x313bab(0x159)]+_0x313bab(0x14d));const _0x457f07=Object['entries'](_0x55c090)[_0x313bab(0x19f)](async([_0x8f9797,_0x23d14e])=>{const _0x5a8fb7=_0x313bab;try{await database_1[_0x5a8fb7(0x1b0)]['currencyRate'][_0x5a8fb7(0x1b6)]({'where':{'currency':_0x8f9797['toLowerCase']()},'update':{'rate':_0x23d14e},'create':{'currency':_0x8f9797[_0x5a8fb7(0x1b2)](),'rate':_0x23d14e}});}catch(_0x5d8b15){console['error'](_0x5a8fb7(0x19b)+_0x8f9797+':',_0x5d8b15);}});await Promise['allSettled'](_0x457f07),console['log'](_0x313bab(0x1ba));}catch(_0x5910b7){console['error'](_0x313bab(0x16c),_0x5910b7);throw _0x5910b7;}}async[a39_0x4dee0c(0x172)](_0x27f30b){const _0x13a0a5=a39_0x4dee0c,_0x1c6b69=_0x27f30b[_0x13a0a5(0x1b2)]();if(_0x1c6b69===_0x13a0a5(0x174))return 0x1;try{const _0x363cb2=await database_1['default'][_0x13a0a5(0x1a4)][_0x13a0a5(0x18d)]({'where':{'currency':_0x1c6b69}});if(!_0x363cb2)return console[_0x13a0a5(0x1c0)]('No\x20rate\x20found\x20for\x20currency:\x20'+_0x27f30b+_0x13a0a5(0x16a)),0x1;return _0x363cb2['rate'];}catch(_0x164f95){return console[_0x13a0a5(0x160)](_0x13a0a5(0x177)+_0x27f30b+':',_0x164f95),0x1;}}async[a39_0x4dee0c(0x1a7)](_0x2007b5,_0x3e08ac){const _0x4c1371=a39_0x4dee0c,_0x35f1fc=_0x3e08ac['toLowerCase']();if(_0x35f1fc==='usdt'){const _0x2eb543=_0x2007b5*(0x1+this[_0x4c1371(0x156)]/0x64);return console['log']('💱\x20Applied\x20'+this[_0x4c1371(0x156)]+'%\x20markup\x20to\x20'+_0x2007b5+_0x4c1371(0x178)+_0x2eb543['toFixed'](0x6)+'\x20USDT'),_0x2eb543;}try{const _0x2016e3=await this[_0x4c1371(0x172)](_0x35f1fc),_0x5acdcf=_0x2007b5/_0x2016e3,_0x367dda=_0x5acdcf*(0x1+this[_0x4c1371(0x156)]/0x64);return console[_0x4c1371(0x1ab)](_0x4c1371(0x19d)+_0x2007b5+'\x20'+_0x3e08ac[_0x4c1371(0x14e)]()+_0x4c1371(0x169)+_0x5acdcf[_0x4c1371(0x1b3)](0x6)+_0x4c1371(0x1c3)+this[_0x4c1371(0x156)]+_0x4c1371(0x1ae)+_0x367dda[_0x4c1371(0x1b3)](0x6)+'\x20USDT\x20(rate:\x20'+_0x2016e3+')'),_0x367dda;}catch(_0x26044f){console[_0x4c1371(0x160)]('Error\x20converting\x20'+_0x2007b5+'\x20'+_0x3e08ac+'\x20to\x20USDT:',_0x26044f);const _0x3c5429=_0x2007b5*(0x1+this[_0x4c1371(0x156)]/0x64);return _0x3c5429;}}async[a39_0x4dee0c(0x167)](_0x7101bd){const _0x45916f=a39_0x4dee0c;let _0x39e618=0x0;for(const {amount:_0x37fc7a,currency:_0x429972}of _0x7101bd){const _0x177073=await this[_0x45916f(0x1a7)](_0x37fc7a,_0x429972);_0x39e618+=_0x177073;}return _0x39e618;}async[a39_0x4dee0c(0x18e)](){const _0x368c34=a39_0x4dee0c;try{const _0x220beb=await database_1[_0x368c34(0x1b0)][_0x368c34(0x1a4)]['findMany']({'select':{'currency':!![],'rate':!![]}}),_0x5aee4d={'usdt':0x1};return _0x220beb[_0x368c34(0x15f)](_0xbc2003=>{const _0x9dfec0=_0x368c34;_0x5aee4d[_0xbc2003[_0x9dfec0(0x190)]]=_0xbc2003[_0x9dfec0(0x17a)];}),_0x5aee4d;}catch(_0xe325d){return console[_0x368c34(0x160)](_0x368c34(0x1a9),_0xe325d),{'usdt':0x1};}}async[a39_0x4dee0c(0x197)](){const _0x4ae374=a39_0x4dee0c;try{const [_0x1d0c92,_0x5a6cf3,_0x237185]=await Promise[_0x4ae374(0x1a0)]([database_1[_0x4ae374(0x1b0)]['currencyRate'][_0x4ae374(0x1b5)](),database_1[_0x4ae374(0x1b0)][_0x4ae374(0x1a4)][_0x4ae374(0x186)]({'orderBy':{'updatedAt':_0x4ae374(0x192)},'select':{'updatedAt':!![]}}),database_1[_0x4ae374(0x1b0)][_0x4ae374(0x1a4)][_0x4ae374(0x186)]({'orderBy':{'updatedAt':_0x4ae374(0x181)},'select':{'updatedAt':!![]}})]);return{'totalRates':_0x1d0c92,'lastUpdated':_0x5a6cf3?.['updatedAt']||null,'oldestRate':_0x237185?.[_0x4ae374(0x15e)]||null,'markupPercentage':this[_0x4ae374(0x156)]};}catch(_0x574ab0){return console['error'](_0x4ae374(0x189),_0x574ab0),{'totalRates':0x0,'lastUpdated':null,'oldestRate':null,'markupPercentage':this[_0x4ae374(0x156)]};}}[a39_0x4dee0c(0x1a1)](){const _0x261458=a39_0x4dee0c;return this[_0x261458(0x156)];}}exports[a39_0x4dee0c(0x1b7)]=CurrencyService,exports[a39_0x4dee0c(0x152)]=new CurrencyService();