'use strict';const a39_0x4b8959=a39_0x2a2d;(function(_0x5b5f53,_0x4d2b35){const _0x871a30=a39_0x2a2d,_0x218c80=_0x5b5f53();while(!![]){try{const _0x5d4796=parseInt(_0x871a30(0x223))/0x1*(parseInt(_0x871a30(0x20d))/0x2)+parseInt(_0x871a30(0x200))/0x3*(-parseInt(_0x871a30(0x207))/0x4)+-parseInt(_0x871a30(0x258))/0x5*(-parseInt(_0x871a30(0x241))/0x6)+parseInt(_0x871a30(0x220))/0x7*(-parseInt(_0x871a30(0x22a))/0x8)+-parseInt(_0x871a30(0x1f4))/0x9+-parseInt(_0x871a30(0x239))/0xa+parseInt(_0x871a30(0x1ea))/0xb*(parseInt(_0x871a30(0x226))/0xc);if(_0x5d4796===_0x4d2b35)break;else _0x218c80['push'](_0x218c80['shift']());}catch(_0x3ba5df){_0x218c80['push'](_0x218c80['shift']());}}}(a39_0x5391,0xd1c31));var __importDefault=this&&this[a39_0x4b8959(0x219)]||function(_0x455fe0){return _0x455fe0&&_0x455fe0['__esModule']?_0x455fe0:{'default':_0x455fe0};};function a39_0x2a2d(_0x53b8f4,_0x3b623e){const _0x53913c=a39_0x5391();return a39_0x2a2d=function(_0x2a2dec,_0x1ce97d){_0x2a2dec=_0x2a2dec-0x1de;let _0x5bb9a5=_0x53913c[_0x2a2dec];return _0x5bb9a5;},a39_0x2a2d(_0x53b8f4,_0x3b623e);}function a39_0x5391(){const _0x793780=['asc','brl','error','aed','Failed\x20to\x20update\x20rate\x20for\x20','CurrencyService','xag','24eAqvjd','eos','aud','desc','inr','\x20USDT','\x20currencies','CURRENCIES','https://api.coingecko.com/api/v3/simple/price','Error\x20getting\x20all\x20rates:','COINGECKO_URL','myr','chf','toUpperCase','Error\x20converting\x20','mmk','toLowerCase','jpy','ltc','tether','php','ars','upsert','35570CSALRe','bmd','sats','%\x20markup\x20to\x20','MARKUP_PERCENTAGE','?ids=tether&vs_currencies=','Error\x20getting\x20rates\x20status:','clp','✅\x20Currency\x20rates\x20service\x20started\x20with\x20hourly\x20updates','idr','Periodic\x20currency\x20rates\x20update\x20failed:','currencyRate','usdt','517kZpXEI','getAllRates','\x20to\x20','CoinGecko\x20API\x20error:\x20','zar','bhd','\x20USDT,\x20with\x20','startPeriodicUpdates','bits','getCurrencyRate','11655648EpCMhr','yfi','eur','❌\x20Failed\x20to\x20update\x20currency\x20rates:','Invalid\x20response\x20format\x20from\x20CoinGecko\x20API','uah','gel','krw','updateCurrencyRates','xlm','getMarkupPercentage','keys','255oDQdWI','updateInterval','pkr','\x20USDT\x20(rate:\x20','Initial\x20currency\x20rates\x20update\x20failed:','✅\x20Currency\x20rates\x20updated\x20successfully','allSettled','10756nhrEoO','json','try','xrp','usd','nok','2744410CKmvmm','rate','vef','💱\x20Applied\x20','vnd','map','findUnique','toFixed','bnb','findFirst','log','getRatesStatus','__importDefault','bdt','ngn','czk','currencyService','No\x20rate\x20found\x20for\x20currency:\x20','dot','2667gmKkjc','📊\x20Received\x20rates\x20for\x20','convertToUSDT','1AlROxX','warn','statusText','618336VLeWIq','sgd','nzd','rub','15512ldQpIE','sar','xau','sek','updatedAt','convertMultipleToUSDT','thb','eth','link','🛑\x20Currency\x20rates\x20periodic\x20updates\x20stopped','default','application/json','gbp','mxn','💱\x20Converted\x20','7008960WkOjVA'];a39_0x5391=function(){return _0x793780;};return a39_0x5391();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a39_0x4b8959(0x21d)]=exports[a39_0x4b8959(0x23f)]=void 0x0;const database_1=__importDefault(require('../config/database'));class CurrencyService{constructor(){const _0x1ce9c2=a39_0x4b8959;this[_0x1ce9c2(0x24b)]=_0x1ce9c2(0x249),this[_0x1ce9c2(0x248)]=['btc',_0x1ce9c2(0x231),_0x1ce9c2(0x253),'bch',_0x1ce9c2(0x215),_0x1ce9c2(0x242),_0x1ce9c2(0x20a),_0x1ce9c2(0x1fd),_0x1ce9c2(0x232),_0x1ce9c2(0x21f),_0x1ce9c2(0x1f5),_0x1ce9c2(0x20b),_0x1ce9c2(0x23d),_0x1ce9c2(0x256),_0x1ce9c2(0x243),_0x1ce9c2(0x21a),_0x1ce9c2(0x1ef),_0x1ce9c2(0x1de),_0x1ce9c2(0x23b),'cad',_0x1ce9c2(0x24d),_0x1ce9c2(0x1e4),'cny',_0x1ce9c2(0x21c),'dkk',_0x1ce9c2(0x1f6),_0x1ce9c2(0x236),_0x1ce9c2(0x1fa),'hkd','huf',_0x1ce9c2(0x1e6),'ils',_0x1ce9c2(0x245),_0x1ce9c2(0x252),_0x1ce9c2(0x1fb),'kwd','lkr',_0x1ce9c2(0x250),_0x1ce9c2(0x237),_0x1ce9c2(0x24c),_0x1ce9c2(0x21b),_0x1ce9c2(0x20c),_0x1ce9c2(0x228),_0x1ce9c2(0x255),_0x1ce9c2(0x202),'pln',_0x1ce9c2(0x229),_0x1ce9c2(0x22b),_0x1ce9c2(0x22d),_0x1ce9c2(0x227),_0x1ce9c2(0x230),_0x1ce9c2(0x209),'twd',_0x1ce9c2(0x1f9),_0x1ce9c2(0x20f),_0x1ce9c2(0x211),_0x1ce9c2(0x1ee),'xdr',_0x1ce9c2(0x240),_0x1ce9c2(0x22c),_0x1ce9c2(0x1f2),_0x1ce9c2(0x1df)],this[_0x1ce9c2(0x201)]=null,this['MARKUP_PERCENTAGE']=-0x3,this[_0x1ce9c2(0x1f1)]();}[a39_0x4b8959(0x1f1)](){const _0x1811c1=a39_0x4b8959;this[_0x1811c1(0x1fc)]()['catch'](_0xb9398c=>{const _0xa0b601=_0x1811c1;console[_0xa0b601(0x23c)](_0xa0b601(0x204),_0xb9398c);}),this[_0x1811c1(0x201)]=setInterval(async()=>{const _0x463dee=_0x1811c1;try{await this[_0x463dee(0x1fc)]();}catch(_0x3090ea){console['error'](_0x463dee(0x1e7),_0x3090ea);}},0x3c*0x3c*0x3e8),console[_0x1811c1(0x217)](_0x1811c1(0x1e5));}['stopPeriodicUpdates'](){const _0x441a6b=a39_0x4b8959;this[_0x441a6b(0x201)]&&(clearInterval(this['updateInterval']),this[_0x441a6b(0x201)]=null,console[_0x441a6b(0x217)](_0x441a6b(0x233)));}async[a39_0x4b8959(0x1fc)](){const _0x1277da=a39_0x4b8959;try{console[_0x1277da(0x217)]('🔄\x20Updating\x20currency\x20rates\x20from\x20CoinGecko...');const _0x58d588=this[_0x1277da(0x248)]['join'](','),_0x1c71ff=this[_0x1277da(0x24b)]+_0x1277da(0x1e2)+_0x58d588,_0xbefb7c=await fetch(_0x1c71ff,{'headers':{'Accept':_0x1277da(0x235),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}});if(!_0xbefb7c['ok'])throw new Error(_0x1277da(0x1ed)+_0xbefb7c['status']+'\x20'+_0xbefb7c[_0x1277da(0x225)]);const _0x3ba051=await _0xbefb7c[_0x1277da(0x208)]();if(!_0x3ba051['tether'])throw new Error(_0x1277da(0x1f8));const _0x46f37c=_0x3ba051[_0x1277da(0x254)];console[_0x1277da(0x217)](_0x1277da(0x221)+Object[_0x1277da(0x1ff)](_0x46f37c)['length']+_0x1277da(0x247));const _0xcad50c=Object['entries'](_0x46f37c)[_0x1277da(0x212)](async([_0x3aa61e,_0x7b948a])=>{const _0x15a611=_0x1277da;try{await database_1['default'][_0x15a611(0x1e8)][_0x15a611(0x257)]({'where':{'currency':_0x3aa61e['toLowerCase']()},'update':{'rate':_0x7b948a},'create':{'currency':_0x3aa61e[_0x15a611(0x251)](),'rate':_0x7b948a}});}catch(_0xe3fba6){console[_0x15a611(0x23c)](_0x15a611(0x23e)+_0x3aa61e+':',_0xe3fba6);}});await Promise[_0x1277da(0x206)](_0xcad50c),console[_0x1277da(0x217)](_0x1277da(0x205));}catch(_0x33fc4){console[_0x1277da(0x23c)](_0x1277da(0x1f7),_0x33fc4);throw _0x33fc4;}}async['getCurrencyRate'](_0x50c08b){const _0x1c7db4=a39_0x4b8959,_0x15076f=_0x50c08b[_0x1c7db4(0x251)]();if(_0x15076f===_0x1c7db4(0x1e9))return 0x1;try{const _0x4a7410=await database_1[_0x1c7db4(0x234)][_0x1c7db4(0x1e8)][_0x1c7db4(0x213)]({'where':{'currency':_0x15076f}});if(!_0x4a7410)return console[_0x1c7db4(0x224)](_0x1c7db4(0x21e)+_0x50c08b+',\x20using\x201\x20as\x20fallback'),0x1;return _0x4a7410[_0x1c7db4(0x20e)];}catch(_0x4cddca){return console[_0x1c7db4(0x23c)]('Error\x20getting\x20rate\x20for\x20currency\x20'+_0x50c08b+':',_0x4cddca),0x1;}}async[a39_0x4b8959(0x222)](_0x1bda8f,_0x418cff){const _0x547ead=a39_0x4b8959,_0x57c64e=_0x418cff[_0x547ead(0x251)]();if(_0x57c64e===_0x547ead(0x1e9)){const _0x2dde45=_0x1bda8f*(0x1+this['MARKUP_PERCENTAGE']/0x64);return console['log'](_0x547ead(0x210)+this[_0x547ead(0x1e1)]+_0x547ead(0x1e0)+_0x1bda8f+'\x20USDT\x20=\x20'+_0x2dde45['toFixed'](0x6)+_0x547ead(0x246)),_0x2dde45;}try{const _0x14e334=await this[_0x547ead(0x1f3)](_0x57c64e),_0x6cbb78=_0x1bda8f/_0x14e334,_0x257e04=_0x6cbb78*(0x1+this[_0x547ead(0x1e1)]/0x64);return console[_0x547ead(0x217)](_0x547ead(0x238)+_0x1bda8f+'\x20'+_0x418cff[_0x547ead(0x24e)]()+_0x547ead(0x1ec)+_0x6cbb78['toFixed'](0x6)+_0x547ead(0x1f0)+this[_0x547ead(0x1e1)]+'%\x20markup\x20=\x20'+_0x257e04[_0x547ead(0x214)](0x6)+_0x547ead(0x203)+_0x14e334+')'),_0x257e04;}catch(_0x68c644){console['error'](_0x547ead(0x24f)+_0x1bda8f+'\x20'+_0x418cff+'\x20to\x20USDT:',_0x68c644);const _0x4ae0f2=_0x1bda8f*(0x1+this[_0x547ead(0x1e1)]/0x64);return _0x4ae0f2;}}async[a39_0x4b8959(0x22f)](_0x4953d7){let _0x1e14c9=0x0;for(const {amount:_0x103aaa,currency:_0xd9266f}of _0x4953d7){const _0x9eec05=await this['convertToUSDT'](_0x103aaa,_0xd9266f);_0x1e14c9+=_0x9eec05;}return _0x1e14c9;}async[a39_0x4b8959(0x1eb)](){const _0x2c5e68=a39_0x4b8959;try{const _0x31db92=await database_1[_0x2c5e68(0x234)][_0x2c5e68(0x1e8)]['findMany']({'select':{'currency':!![],'rate':!![]}}),_0x190a10={'usdt':0x1};return _0x31db92['forEach'](_0x312363=>{_0x190a10[_0x312363['currency']]=_0x312363['rate'];}),_0x190a10;}catch(_0xd23d2c){return console[_0x2c5e68(0x23c)](_0x2c5e68(0x24a),_0xd23d2c),{'usdt':0x1};}}async[a39_0x4b8959(0x218)](){const _0x4cedd3=a39_0x4b8959;try{const [_0x23ecf1,_0x5c4aea,_0x447c76]=await Promise['all']([database_1[_0x4cedd3(0x234)][_0x4cedd3(0x1e8)]['count'](),database_1['default']['currencyRate']['findFirst']({'orderBy':{'updatedAt':_0x4cedd3(0x244)},'select':{'updatedAt':!![]}}),database_1['default']['currencyRate'][_0x4cedd3(0x216)]({'orderBy':{'updatedAt':_0x4cedd3(0x23a)},'select':{'updatedAt':!![]}})]);return{'totalRates':_0x23ecf1,'lastUpdated':_0x5c4aea?.[_0x4cedd3(0x22e)]||null,'oldestRate':_0x447c76?.[_0x4cedd3(0x22e)]||null,'markupPercentage':this[_0x4cedd3(0x1e1)]};}catch(_0x39dc3c){return console['error'](_0x4cedd3(0x1e3),_0x39dc3c),{'totalRates':0x0,'lastUpdated':null,'oldestRate':null,'markupPercentage':this[_0x4cedd3(0x1e1)]};}}[a39_0x4b8959(0x1fe)](){return this['MARKUP_PERCENTAGE'];}}exports[a39_0x4b8959(0x23f)]=CurrencyService,exports['currencyService']=new CurrencyService();