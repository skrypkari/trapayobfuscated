'use strict';const a46_0x1830f6=a46_0x1ad2;(function(_0x1d25b0,_0x3ff1c1){const _0x1e69c4=a46_0x1ad2,_0x1d3dd6=_0x1d25b0();while(!![]){try{const _0x402823=-parseInt(_0x1e69c4(0x1b5))/0x1+-parseInt(_0x1e69c4(0x1e0))/0x2+parseInt(_0x1e69c4(0x1f0))/0x3*(-parseInt(_0x1e69c4(0x166))/0x4)+parseInt(_0x1e69c4(0x1ea))/0x5+parseInt(_0x1e69c4(0x172))/0x6+parseInt(_0x1e69c4(0x1d2))/0x7+parseInt(_0x1e69c4(0x1c5))/0x8;if(_0x402823===_0x3ff1c1)break;else _0x1d3dd6['push'](_0x1d3dd6['shift']());}catch(_0x3e6f1b){_0x1d3dd6['push'](_0x1d3dd6['shift']());}}}(a46_0x47b7,0x48602));var __importDefault=this&&this[a46_0x1830f6(0x190)]||function(_0x1abbd4){const _0x17ba07=a46_0x1830f6;return _0x1abbd4&&_0x1abbd4[_0x17ba07(0x18d)]?_0x1abbd4:{'default':_0x1abbd4};};Object['defineProperty'](exports,a46_0x1830f6(0x18d),{'value':!![]}),exports['PaymentService']=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require('./gateways/plisioService'),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a46_0x1830f6(0x1a8)),coinToPayService_1=require(a46_0x1830f6(0x204)),klymeService_1=require(a46_0x1830f6(0x1d4)),gateway_1=require('../types/gateway');function a46_0x47b7(){const _0x3db957=['createPaymentLink','Invalid\x20public\x20key','https://tesoft.uk','plisioService','createPublicPayment','padStart','payment','ðŸ”\x20Searching\x20for\x20payment\x20with\x20ID:\x20','maxPayments','767050RYCKXi','Unknown\x20error','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','Rapyd','createPayment','/gateway/pending.php?id=','ðŸ“\x20Merchant\x20order_id:\x20','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','createdAt','ðŸ”—\x20Plisio\x20payment\x20URL:\x20','230835gzrauh','ðŸ”\x20Shop\x20','Unsupported\x20KLYME\x20region:\x20','currency','PENDING','qr_code','1353FlYEEN','failUrl','customerName','join','Enabled\x20gateways:\x20','\x20(8digits-8digits\x20format\x20for\x20','findMany','qrCode','klyme_','\x20\x20\x20ðŸ’¾\x20DB\x20Success\x20URL:\x20','validateKlymeCurrency','findUnique','generateGatewayOrderId','gatewayPaymentId','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','ONCE','paymentGateways','https://tesoft.uk/gateways/noda/webhook','map','BASE_URL','./gateways/coinToPayService','getPaymentStatus','gateway_payment_id','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x20payment\x20with\x20gateway\x20order_id:\x20','ðŸ”—\x20Rapyd\x20payment\x20URL:\x20','FAILED','create','\x22\x20not\x20allowed\x20for\x20shop\x20','ðŸ”\x20Will\x20search\x20by:\x20internal\x20ID,\x20merchant\x20order\x20ID,\x20gateway\x20order\x20ID,\x20and\x20gateway\x20payment\x20ID','USD','Noda','ðŸ’¾\x20Payment\x20created\x20in\x20database:','startsWith','NodaService','https://app.trapay.uk/payment/fail','payment_url','\x22\x20is\x20in\x20enabled\x20gateways:','qr_code_url','ðŸ”—\x20Noda\x20payment\x20URL:\x20','2588zrvgLt','rapydService','PaymentService','\x20using\x20default\x20gateways:','\x20\x20\x20-\x20Merchant\x20order\x20ID:\x20','floor','\x20\x20\x20-\x20DB\x20Fail\x20URL:\x20','\x22\x20is\x20not\x20enabled\x20for\x20your\x20shop.\x20','/gateway/fail.php?id=','externalPaymentUrl','ACTIVE','Order\x20ID:\x20','227262smzjmv','KLYME\x20DE','successUrl','getPaymentById','klymeService','paymentMethod','shop','ðŸ”„\x20Processing\x20payment\x20for\x20gateway\x20ID\x20','\x20(8digits-8digits\x20format)','âš ï¸\x20Gateway\x20order\x20ID\x20','sourceCurrency','RapydService','getGatewayDisplayName','https://tesoft.uk/gateway/payment.php?id=','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','usage','username','country','name','env','Invalid\x20gateway\x20ID:\x20','plisio','log','Shop\x20is\x20not\x20active','status','bankId','\x20\x20\x20-\x20Gateway\x20order\x20ID:\x20','__esModule','ðŸ”—\x20Generated\x20URLs\x20for\x20','CoinToPayService','__importDefault','remitterName','getPaymentsByShop','\x20payment\x20URL:\x20','ðŸ”\x20Checking\x20if\x20\x22','desc','expiresAt','amount','toString','invoiceTotalSum','toUpperCase','\x20(validated\x20for\x20','\x20\x20\x20-\x20Gateway\x20payment\x20ID:\x20','noda','toLowerCase','\x20\x20\x20-\x20DB\x20Success\x20URL:\x20','KlymeService','CoinToPay','cardLast4','ðŸ”—\x20KLYME\x20','amountIsEditable','https://app.trapay.uk/payment/','\x20\x20\x20ðŸ’¾\x20DB\x20Fail\x20URL:\x20','update','./gateways/nodaService','ðŸ’³\x20Creating\x20KLYME\x20','PlisioService','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','ðŸª™\x20Creating\x20CoinToPay\x20payment\x20with\x20gateway\x20order_id:\x20','Unsupported\x20gateway:\x20','includes','Invalid\x20KLYME\x20gateway:\x20','qrUrl','cointopay','GBP','all','gatewayOrderId','352923jJAQSp','updatedAt','error','checkGatewayPermission','âœ…\x20Gateway\x20\x22','gateway','\x20enabled\x20gateways:','findFirst','âŒ\x20Gateway\x20\x22','KLYME\x20EU','not\x20provided','ðŸ’°\x20Amount:\x20','getKlymeRegionFromGatewayName','âœ…\x20Found\x20payment:\x20','\x20\x20\x20-\x20Internal\x20ID:\x20','default','5884424Umxpep','language','ðŸ”\x20Checking\x20gateway\x20permission\x20for\x20shop\x20','\x20\x20\x20-\x20Status:\x20','Gateway\x20\x22','customerEmail','orderId','\x20\x20\x20-\x20Merchant\x20order_id:\x20','generateGatewayUrls','\x20\x20\x20ðŸŒ\x20Gateway\x20Fail\x20URL:\x20','nodaService','ðŸ‡¬ðŸ‡§\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment','Plisio','3535686ePzlPS','none','./gateways/klymeService','ðŸ”„\x20Creating\x20Noda\x20payment\x20with\x20gateway\x20order_id:\x20','remitterIban'];a46_0x47b7=function(){return _0x3db957;};return a46_0x47b7();}function a46_0x1ad2(_0x53a4b0,_0x5bdf85){const _0x47b70c=a46_0x47b7();return a46_0x1ad2=function(_0x1ad250,_0x346d64){_0x1ad250=_0x1ad250-0x160;let _0x2dbb38=_0x47b70c[_0x1ad250];return _0x2dbb38;},a46_0x1ad2(_0x53a4b0,_0x5bdf85);}class PaymentService{constructor(){const _0x18e19f=a46_0x1830f6;this['plisioService']=new plisioService_1[(_0x18e19f(0x1aa))](),this[_0x18e19f(0x167)]=new rapydService_1[(_0x18e19f(0x17d))](),this[_0x18e19f(0x1cf)]=new nodaService_1[(_0x18e19f(0x160))](),this['coinToPayService']=new coinToPayService_1[(_0x18e19f(0x18f))](),this[_0x18e19f(0x176)]=new klymeService_1[(_0x18e19f(0x1a0))]();}async[a46_0x1830f6(0x1fc)](){const _0x3c6aef=a46_0x1830f6;let _0xa5e952,_0x25bf2=0x0;const _0x206709=0xa;do{const _0x25d3e1=()=>{const _0x4d4146=a46_0x1ad2;return Math[_0x4d4146(0x16b)](Math['random']()*0x5f5e100)[_0x4d4146(0x198)]()[_0x4d4146(0x1dc)](0x8,'0');};_0xa5e952=_0x25d3e1()+'-'+_0x25d3e1();const _0x50db8c=await database_1['default'][_0x3c6aef(0x1dd)][_0x3c6aef(0x1bc)]({'where':{'gatewayOrderId':_0xa5e952}});if(!_0x50db8c)break;_0x25bf2++,console['log'](_0x3c6aef(0x17b)+_0xa5e952+_0x3c6aef(0x1ab)+_0x25bf2+')');}while(_0x25bf2<_0x206709);if(_0x25bf2>=_0x206709)throw new Error('Failed\x20to\x20generate\x20unique\x20gateway\x20order\x20ID\x20after\x20maximum\x20attempts');return _0xa5e952;}[a46_0x1830f6(0x1cd)](_0x354c73,_0x45d82a,_0x5c948,_0x1bc5dc,_0x329af8){const _0x3951a9=a46_0x1830f6;if(_0x1bc5dc&&_0x329af8)return{'finalSuccessUrl':_0x1bc5dc,'finalFailUrl':_0x329af8,'dbSuccessUrl':_0x1bc5dc,'dbFailUrl':_0x329af8};let _0x2c61d8,_0x4ec6a0,_0x1c04ba,_0x10d670;return _0x354c73===_0x3951a9(0x19d)||_0x354c73[_0x3951a9(0x211)](_0x3951a9(0x1f8))?(_0x2c61d8=_0x5c948+_0x3951a9(0x1e5)+_0x45d82a,_0x1c04ba='https://app.trapay.uk/payment/pending'):(_0x2c61d8=_0x5c948+'/gateway/success.php?id='+_0x45d82a,_0x1c04ba='https://app.trapay.uk/payment/success'),_0x4ec6a0=_0x5c948+_0x3951a9(0x16e)+_0x45d82a,_0x10d670=_0x3951a9(0x161),console['log'](_0x3951a9(0x18e)+_0x354c73+':'),console[_0x3951a9(0x188)]('\x20\x20\x20ðŸŒ\x20Gateway\x20Success\x20URL:\x20'+_0x2c61d8),console[_0x3951a9(0x188)](_0x3951a9(0x1ce)+_0x4ec6a0),console[_0x3951a9(0x188)](_0x3951a9(0x1f9)+_0x1c04ba),console['log'](_0x3951a9(0x1a6)+_0x10d670),{'finalSuccessUrl':_0x2c61d8,'finalFailUrl':_0x4ec6a0,'dbSuccessUrl':_0x1c04ba,'dbFailUrl':_0x10d670};}[a46_0x1830f6(0x1fa)](_0x8ac2fd,_0x1995ea){const _0x32b344=a46_0x1830f6;if(!_0x8ac2fd[_0x32b344(0x211)](_0x32b344(0x1f8)))return;const _0x27fc4f=(0x0,gateway_1[_0x32b344(0x1c1)])(_0x8ac2fd),_0x2cd151=_0x1995ea[_0x32b344(0x19a)]();switch(_0x27fc4f){case'EU':if(_0x2cd151!=='EUR')throw new Error(_0x32b344(0x207)+_0x2cd151);break;case'GB':if(_0x2cd151!==_0x32b344(0x1b2))throw new Error(_0x32b344(0x1fe)+_0x2cd151);break;case'DE':if(_0x2cd151!=='EUR')throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x2cd151);break;default:throw new Error(_0x32b344(0x1ec)+_0x27fc4f);}}async[a46_0x1830f6(0x1b8)](_0x5203fd,_0x2155c0){const _0x9c4478=a46_0x1830f6;console[_0x9c4478(0x188)](_0x9c4478(0x1c7)+_0x5203fd+':\x20'+_0x2155c0);const _0x22dfdd=await database_1[_0x9c4478(0x1c4)][_0x9c4478(0x178)]['findUnique']({'where':{'id':_0x5203fd},'select':{'id':!![],'name':!![],'username':!![],'paymentGateways':!![]}});if(!_0x22dfdd)throw new Error('Shop\x20not\x20found');let _0x2146e8=[];if(_0x22dfdd[_0x9c4478(0x200)])try{_0x2146e8=JSON['parse'](_0x22dfdd[_0x9c4478(0x200)]),console[_0x9c4478(0x188)](_0x9c4478(0x1eb)+_0x22dfdd[_0x9c4478(0x182)]+_0x9c4478(0x1bb),_0x2146e8);}catch(_0x2610ee){console[_0x9c4478(0x1b7)]('Error\x20parsing\x20payment\x20gateways:',_0x2610ee),_0x2146e8=[_0x9c4478(0x1d1)];}else _0x2146e8=[_0x9c4478(0x1d1)],console['log']('ðŸ”\x20Shop\x20'+_0x22dfdd[_0x9c4478(0x182)]+_0x9c4478(0x169),_0x2146e8);const _0x2262f6=this[_0x9c4478(0x17e)](_0x2155c0);console[_0x9c4478(0x188)](_0x9c4478(0x194)+_0x2262f6+_0x9c4478(0x163),_0x2146e8);if(!_0x2146e8[_0x9c4478(0x1ae)](_0x2262f6)){console[_0x9c4478(0x1b7)](_0x9c4478(0x1bd)+_0x2262f6+_0x9c4478(0x20c)+_0x22dfdd[_0x9c4478(0x182)]),console[_0x9c4478(0x1b7)]('âŒ\x20Enabled\x20gateways:\x20'+_0x2146e8[_0x9c4478(0x1f3)](',\x20'));throw new Error(_0x9c4478(0x1c9)+_0x2262f6+_0x9c4478(0x16d)+(_0x9c4478(0x1f4)+_0x2146e8[_0x9c4478(0x1f3)](',\x20')+'.\x20')+'Please\x20contact\x20support\x20to\x20enable\x20additional\x20gateways.');}console['log'](_0x9c4478(0x1b9)+_0x2262f6+'\x22\x20is\x20allowed\x20for\x20shop\x20'+_0x22dfdd[_0x9c4478(0x182)]);}[a46_0x1830f6(0x17e)](_0x1d5da0){const _0x58e7b3=a46_0x1830f6,_0x5af15e={'plisio':_0x58e7b3(0x1d1),'rapyd':_0x58e7b3(0x1e3),'noda':_0x58e7b3(0x20f),'cointopay':_0x58e7b3(0x1a1),'klyme_eu':_0x58e7b3(0x1be),'klyme_gb':'KLYME\x20GB','klyme_de':_0x58e7b3(0x173)};return _0x5af15e[_0x1d5da0]||_0x1d5da0;}async[a46_0x1830f6(0x1db)](_0xaa830f){const _0x1846ac=a46_0x1830f6,{public_key:_0x8ccd61,gateway:_0x1738cb,order_id:_0x3996c8,amount:_0x487511,currency:_0x2a91c1,source_currency:_0x260f9e,usage:_0x2f56b2,expires_at:_0x19275b,success_url:_0x1d1865,fail_url:_0x3d76af,customer_email:_0x3dcab1,customer_name:_0x5e5a54,country:_0x3f2ab2,language:_0x2e671c,amount_is_editable:_0x386f9a,max_payments:_0x4d0f68,customer:_0x4cb223}=_0xaa830f;if(!(0x0,gateway_1['isValidGatewayId'])(_0x1738cb))throw new Error(_0x1846ac(0x186)+_0x1738cb+_0x1846ac(0x1e7));const _0x4aff2c=(0x0,gateway_1['getGatewayNameById'])(_0x1738cb);if(!_0x4aff2c)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x1738cb);console[_0x1846ac(0x188)](_0x1846ac(0x179)+_0x1738cb+'\x20('+_0x4aff2c+')'),this[_0x1846ac(0x1fa)](_0x4aff2c,_0x2a91c1||_0x1846ac(0x20e));const _0xddd556=await database_1['default'][_0x1846ac(0x178)][_0x1846ac(0x1fb)]({'where':{'publicKey':_0x8ccd61},'select':{'id':!![],'name':!![],'status':!![],'paymentGateways':!![]}});if(!_0xddd556)throw new Error(_0x1846ac(0x1d8));if(_0xddd556['status']!==_0x1846ac(0x170))throw new Error(_0x1846ac(0x189));await this[_0x1846ac(0x1b8)](_0xddd556['id'],_0x4aff2c);const _0x2f011c=await this['generateGatewayOrderId']();console[_0x1846ac(0x188)]('ðŸŽ¯\x20Generated\x20unique\x20gateway\x20order_id:\x20'+_0x2f011c+_0x1846ac(0x1f5)+_0x4aff2c+')');const _0x3eac3d=_0x3996c8||null;console[_0x1846ac(0x188)](_0x1846ac(0x1e6)+(_0x3eac3d||_0x1846ac(0x1bf)));const _0x1be1ee=process[_0x1846ac(0x185)][_0x1846ac(0x203)]||_0x1846ac(0x1d9),{finalSuccessUrl:_0x39e935,finalFailUrl:_0x263588,dbSuccessUrl:_0xfc56a1,dbFailUrl:_0xab14cb}=this[_0x1846ac(0x1cd)](_0x4aff2c,_0x2f011c,_0x1be1ee,_0x1d1865,_0x3d76af),_0x2b4880=await database_1[_0x1846ac(0x1c4)][_0x1846ac(0x1dd)][_0x1846ac(0x20b)]({'data':{'shopId':_0xddd556['id'],'gateway':_0x4aff2c,'amount':_0x487511,'currency':_0x2a91c1||'USD','sourceCurrency':_0x260f9e||null,'usage':_0x2f56b2||_0x1846ac(0x1ff),'expiresAt':_0x19275b?new Date(_0x19275b):null,'successUrl':_0xfc56a1,'failUrl':_0xab14cb,'status':_0x1846ac(0x1ee),'orderId':_0x3eac3d,'gatewayOrderId':_0x2f011c,'customerEmail':_0x3dcab1||null,'customerName':_0x5e5a54||null,'country':_0x3f2ab2||null,'language':_0x2e671c||null,'amountIsEditable':_0x386f9a||null,'maxPayments':_0x4d0f68||null,'rapydCustomer':_0x4cb223||null}});console[_0x1846ac(0x188)](_0x1846ac(0x210)),console['log'](_0x1846ac(0x1c3)+_0x2b4880['id']),console[_0x1846ac(0x188)](_0x1846ac(0x1cc)+(_0x3eac3d||'none')),console[_0x1846ac(0x188)]('\x20\x20\x20-\x20Gateway\x20order_id:\x20'+_0x2f011c+'\x20(8digits-8digits)'),console[_0x1846ac(0x188)](_0x1846ac(0x19f)+_0xfc56a1),console['log'](_0x1846ac(0x16c)+_0xab14cb);let _0x8759c9,_0x38e6e7;try{if(_0x4aff2c===_0x1846ac(0x187)){let _0x273efe,_0x45f81c,_0x406f45;_0x260f9e?(_0x273efe=_0x260f9e,_0x45f81c=_0x2a91c1||_0x1846ac(0x20e),_0x406f45=![]):(_0x273efe=_0x2a91c1||_0x1846ac(0x20e),_0x45f81c=_0x1846ac(0x20e),_0x406f45=![]);const _0x20df62=await this[_0x1846ac(0x1da)][_0x1846ac(0x1e4)]({'paymentId':_0x2b4880['id'],'orderId':_0x2f011c,'amount':_0x487511,'currency':_0x273efe,'productName':_0x1846ac(0x171)+_0x2f011c,'description':_0x1846ac(0x171)+_0x2f011c,'successUrl':_0x39e935,'failUrl':_0x263588,'customerEmail':_0x3dcab1,'customerName':_0x5e5a54,'isSourceCurrency':_0x406f45});_0x8759c9=_0x20df62[_0x1846ac(0x206)],_0x38e6e7=_0x20df62['payment_url'],await database_1[_0x1846ac(0x1c4)][_0x1846ac(0x1dd)][_0x1846ac(0x1a7)]({'where':{'id':_0x2b4880['id']},'data':{'externalPaymentUrl':_0x38e6e7,'gatewayPaymentId':_0x8759c9,'invoiceTotalSum':Number(_0x20df62['invoice_total_sum']),'qrCode':_0x20df62[_0x1846ac(0x1ef)],'qrUrl':_0x20df62['qr_url']}});const _0x49242d='https://app.trapay.uk/payment/'+_0x2b4880['id'];return console[_0x1846ac(0x188)](_0x1846ac(0x1e9)+_0x49242d),{'id':_0x2b4880['id'],'gateway_payment_id':_0x8759c9,'payment_url':_0x49242d,'status':_0x2b4880[_0x1846ac(0x18a)]};}else{if(_0x4aff2c==='rapyd'){const _0x2b64f0='GB';console['log'](_0x1846ac(0x1d0));const _0x3d14b6=await this['rapydService'][_0x1846ac(0x1d7)]({'paymentId':_0x2b4880['id'],'orderId':_0x2f011c,'orderName':_0x1846ac(0x171)+_0x2f011c,'amount':_0x487511,'currency':_0x2a91c1||_0x1846ac(0x20e),'country':_0x2b64f0,'language':_0x2e671c||'EN','amountIsEditable':_0x386f9a||![],'usage':_0x2f56b2||_0x1846ac(0x1ff),'maxPayments':_0x4d0f68,'customer':_0x4cb223,'successUrl':_0x39e935,'failUrl':_0x263588});_0x8759c9=_0x3d14b6[_0x1846ac(0x206)],_0x38e6e7=_0x3d14b6[_0x1846ac(0x162)],await database_1[_0x1846ac(0x1c4)][_0x1846ac(0x1dd)][_0x1846ac(0x1a7)]({'where':{'id':_0x2b4880['id']},'data':{'externalPaymentUrl':_0x38e6e7,'gatewayPaymentId':_0x8759c9,'country':_0x2b64f0}});const _0x36d539=_0x1846ac(0x17f)+_0x2b4880['id'];return console[_0x1846ac(0x188)](_0x1846ac(0x209)+_0x36d539),{'id':_0x2b4880['id'],'gateway_payment_id':_0x8759c9,'payment_url':_0x36d539,'status':_0x2b4880[_0x1846ac(0x18a)]};}else{if(_0x4aff2c===_0x1846ac(0x19d)){console[_0x1846ac(0x188)](_0x1846ac(0x1d5)+_0x2f011c+_0x1846ac(0x17a));const _0x11c9a4=await this[_0x1846ac(0x1cf)][_0x1846ac(0x1d7)]({'paymentId':_0x2b4880['id'],'orderId':_0x2f011c,'name':_0x1846ac(0x171)+_0x2f011c,'paymentDescription':_0x1846ac(0x171)+_0x2f011c,'amount':_0x487511,'currency':_0x2a91c1||_0x1846ac(0x20e),'webhookUrl':_0x1846ac(0x201),'returnUrl':_0x39e935,'expiryDate':_0x19275b});_0x8759c9=_0x11c9a4[_0x1846ac(0x206)],_0x38e6e7=_0x11c9a4[_0x1846ac(0x162)],await database_1[_0x1846ac(0x1c4)][_0x1846ac(0x1dd)][_0x1846ac(0x1a7)]({'where':{'id':_0x2b4880['id']},'data':{'externalPaymentUrl':_0x38e6e7,'gatewayPaymentId':_0x8759c9,'qrUrl':_0x11c9a4[_0x1846ac(0x164)]}});const _0x197939='https://tesoft.uk/gateway/payment.php?id='+_0x2b4880['id'];return console['log'](_0x1846ac(0x165)+_0x197939),{'id':_0x2b4880['id'],'gateway_payment_id':_0x8759c9,'payment_url':_0x197939,'status':_0x2b4880[_0x1846ac(0x18a)]};}else{if(_0x4aff2c===_0x1846ac(0x1b1)){console['log'](_0x1846ac(0x1ac)+_0x2f011c+_0x1846ac(0x17a)),console['log']('ðŸ’°\x20Amount:\x20'+_0x487511+_0x1846ac(0x180));const _0x55f82e=await this['coinToPayService'][_0x1846ac(0x1d7)]({'paymentId':_0x2b4880['id'],'orderId':_0x2f011c,'amount':_0x487511});_0x8759c9=_0x55f82e[_0x1846ac(0x206)],_0x38e6e7=_0x55f82e[_0x1846ac(0x162)],await database_1[_0x1846ac(0x1c4)]['payment'][_0x1846ac(0x1a7)]({'where':{'id':_0x2b4880['id']},'data':{'externalPaymentUrl':_0x38e6e7,'gatewayPaymentId':_0x8759c9,'currency':'EUR'}});const _0x2540d4=_0x1846ac(0x17f)+_0x2b4880['id'];return console['log']('ðŸ”—\x20CoinToPay\x20payment\x20URL:\x20'+_0x2540d4),{'id':_0x2b4880['id'],'gateway_payment_id':_0x8759c9,'payment_url':_0x2540d4,'status':_0x2b4880[_0x1846ac(0x18a)]};}else{if(_0x4aff2c[_0x1846ac(0x211)](_0x1846ac(0x1f8))){const _0xb4bfba=(0x0,gateway_1[_0x1846ac(0x1c1)])(_0x4aff2c);if(!_0xb4bfba)throw new Error(_0x1846ac(0x1af)+_0x4aff2c);console[_0x1846ac(0x188)](_0x1846ac(0x1a9)+_0xb4bfba+_0x1846ac(0x208)+_0x2f011c+_0x1846ac(0x17a)),console['log'](_0x1846ac(0x1c0)+_0x487511+'\x20'+(_0x2a91c1||_0x1846ac(0x20e))+_0x1846ac(0x19b)+_0xb4bfba+')');const _0x4c3d81=await this[_0x1846ac(0x176)][_0x1846ac(0x1d7)]({'paymentId':_0x2b4880['id'],'orderId':_0x2f011c,'amount':_0x487511,'currency':_0x2a91c1||'USD','region':_0xb4bfba,'redirectUrl':_0x39e935});_0x8759c9=_0x4c3d81['gateway_payment_id'],_0x38e6e7=_0x4c3d81['payment_url'],await database_1[_0x1846ac(0x1c4)][_0x1846ac(0x1dd)][_0x1846ac(0x1a7)]({'where':{'id':_0x2b4880['id']},'data':{'externalPaymentUrl':_0x38e6e7,'gatewayPaymentId':_0x8759c9}});const _0x292b34=_0x1846ac(0x1a5)+_0x2b4880['id'];return console[_0x1846ac(0x188)]('âœ…\x20KLYME\x20'+_0xb4bfba+_0x1846ac(0x1e2)+_0x2f011c),console[_0x1846ac(0x188)](_0x1846ac(0x1a3)+_0xb4bfba+_0x1846ac(0x193)+_0x292b34),{'id':_0x2b4880['id'],'gateway_payment_id':_0x8759c9,'payment_url':_0x292b34,'status':_0x2b4880[_0x1846ac(0x18a)]};}else throw new Error(_0x1846ac(0x1ad)+_0x4aff2c);}}}}}catch(_0x486cc4){await database_1[_0x1846ac(0x1c4)][_0x1846ac(0x1dd)][_0x1846ac(0x1a7)]({'where':{'id':_0x2b4880['id']},'data':{'status':_0x1846ac(0x20a)}});throw new Error('Gateway\x20error:\x20'+(_0x486cc4 instanceof Error?_0x486cc4['message']:_0x1846ac(0x1e1)));}}async[a46_0x1830f6(0x205)](_0x4b582f){const _0xf44974=a46_0x1830f6,_0x514c79=await database_1[_0xf44974(0x1c4)]['payment']['findUnique']({'where':{'id':_0x4b582f},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'sourceCurrency':!![],'status':!![],'externalPaymentUrl':!![],'successUrl':!![],'failUrl':!![],'customerEmail':!![],'customerName':!![],'invoiceTotalSum':!![],'qrCode':!![],'qrUrl':!![],'orderId':!![],'gatewayOrderId':!![],'country':!![],'language':!![],'amountIsEditable':!![],'maxPayments':!![],'rapydCustomer':!![],'cardLast4':!![],'paymentMethod':!![],'bankId':!![],'remitterIban':!![],'remitterName':!![],'createdAt':!![],'updatedAt':!![],'expiresAt':!![],'shop':{'select':{'name':!![]}}}});if(!_0x514c79)return null;let _0x7f3661;return _0x514c79['gateway']==='plisio'||_0x514c79[_0xf44974(0x1ba)][_0xf44974(0x211)](_0xf44974(0x1f8))?_0x7f3661=_0xf44974(0x1a5)+_0x514c79['id']:_0x7f3661=_0xf44974(0x17f)+_0x514c79['id'],{'id':_0x514c79['id'],'gateway':_0x514c79['gateway'],'amount':_0x514c79[_0xf44974(0x197)],'currency':_0x514c79[_0xf44974(0x1ed)],'source_currency':_0x514c79[_0xf44974(0x17c)],'status':_0x514c79[_0xf44974(0x18a)],'payment_url':_0x7f3661,'external_payment_url':_0x514c79[_0xf44974(0x16f)],'success_url':_0x514c79['successUrl'],'fail_url':_0x514c79[_0xf44974(0x1f1)],'customer_email':_0x514c79['customerEmail'],'customer_name':_0x514c79[_0xf44974(0x1f2)],'invoice_total_sum':_0x514c79[_0xf44974(0x199)],'qr_code':_0x514c79[_0xf44974(0x1f7)],'qr_url':_0x514c79[_0xf44974(0x1b0)],'order_id':_0x514c79[_0xf44974(0x1cb)],'gateway_order_id':_0x514c79['gatewayOrderId'],'merchant_brand':_0x514c79[_0xf44974(0x178)][_0xf44974(0x184)],'country':_0x514c79['country'],'language':_0x514c79[_0xf44974(0x1c6)],'amount_is_editable':_0x514c79['amountIsEditable'],'max_payments':_0x514c79['maxPayments'],'rapyd_customer':_0x514c79['rapydCustomer'],'card_last4':_0x514c79['cardLast4'],'payment_method':_0x514c79['paymentMethod'],'bank_id':_0x514c79[_0xf44974(0x18b)],'remitter_iban':_0x514c79[_0xf44974(0x1d6)],'remitter_name':_0x514c79[_0xf44974(0x191)],'created_at':_0x514c79['createdAt'],'updated_at':_0x514c79['updatedAt'],'expires_at':_0x514c79[_0xf44974(0x196)]};}async[a46_0x1830f6(0x175)](_0x1a4a4c){const _0x55668d=a46_0x1830f6;console['log'](_0x55668d(0x1de)+_0x1a4a4c),console['log'](_0x55668d(0x20d));const _0x267259=await database_1['default'][_0x55668d(0x1dd)][_0x55668d(0x1bc)]({'where':{'OR':[{'id':_0x1a4a4c},{'orderId':_0x1a4a4c},{'gatewayOrderId':_0x1a4a4c},{'gatewayPaymentId':_0x1a4a4c}]},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'sourceCurrency':!![],'status':!![],'externalPaymentUrl':!![],'successUrl':!![],'failUrl':!![],'customerEmail':!![],'customerName':!![],'invoiceTotalSum':!![],'qrCode':!![],'qrUrl':!![],'orderId':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'country':!![],'language':!![],'amountIsEditable':!![],'maxPayments':!![],'rapydCustomer':!![],'cardLast4':!![],'paymentMethod':!![],'bankId':!![],'remitterIban':!![],'remitterName':!![],'createdAt':!![],'updatedAt':!![],'expiresAt':!![],'shop':{'select':{'name':!![]}}}});if(!_0x267259)return console['log']('âŒ\x20Payment\x20not\x20found\x20with\x20any\x20of\x20the\x20following\x20criteria:'),console[_0x55668d(0x188)](_0x55668d(0x1c3)+_0x1a4a4c),console[_0x55668d(0x188)](_0x55668d(0x16a)+_0x1a4a4c),console[_0x55668d(0x188)](_0x55668d(0x18c)+_0x1a4a4c),console[_0x55668d(0x188)](_0x55668d(0x19c)+_0x1a4a4c),null;console[_0x55668d(0x188)](_0x55668d(0x1c2)+_0x267259['id']),console['log']('\x20\x20\x20-\x20Internal\x20ID:\x20'+_0x267259['id']),console['log'](_0x55668d(0x16a)+(_0x267259[_0x55668d(0x1cb)]||_0x55668d(0x1d3))),console[_0x55668d(0x188)](_0x55668d(0x18c)+(_0x267259[_0x55668d(0x1b4)]||_0x55668d(0x1d3))),console[_0x55668d(0x188)](_0x55668d(0x19c)+(_0x267259[_0x55668d(0x1fd)]||'none')),console[_0x55668d(0x188)]('\x20\x20\x20-\x20Gateway:\x20'+_0x267259['gateway']),console[_0x55668d(0x188)](_0x55668d(0x1c8)+_0x267259[_0x55668d(0x18a)]);let _0x8fced;return _0x267259['gateway']===_0x55668d(0x187)||_0x267259[_0x55668d(0x1ba)][_0x55668d(0x211)]('klyme_')?_0x8fced=_0x55668d(0x1a5)+_0x267259['id']:_0x8fced=_0x55668d(0x17f)+_0x267259['id'],{'id':_0x267259['id'],'gateway':_0x267259[_0x55668d(0x1ba)],'amount':_0x267259['amount'],'currency':_0x267259[_0x55668d(0x1ed)],'source_currency':_0x267259['sourceCurrency'],'status':_0x267259[_0x55668d(0x18a)],'payment_url':_0x8fced,'external_payment_url':_0x267259[_0x55668d(0x16f)],'success_url':_0x267259[_0x55668d(0x174)],'fail_url':_0x267259[_0x55668d(0x1f1)],'customer_email':_0x267259[_0x55668d(0x1ca)],'customer_name':_0x267259['customerName'],'invoice_total_sum':_0x267259[_0x55668d(0x199)],'qr_code':_0x267259[_0x55668d(0x1f7)],'qr_url':_0x267259[_0x55668d(0x1b0)],'order_id':_0x267259[_0x55668d(0x1cb)],'gateway_order_id':_0x267259[_0x55668d(0x1b4)],'merchant_brand':_0x267259[_0x55668d(0x178)][_0x55668d(0x184)],'card_last4':_0x267259['cardLast4'],'payment_method':_0x267259[_0x55668d(0x177)],'bank_id':_0x267259['bankId'],'remitter_iban':_0x267259['remitterIban'],'remitter_name':_0x267259['remitterName'],'created_at':_0x267259['createdAt'],'updated_at':_0x267259[_0x55668d(0x1b6)],'expires_at':_0x267259[_0x55668d(0x196)]};}async[a46_0x1830f6(0x192)](_0x1983f5,_0x44a990){const _0x958b17=a46_0x1830f6,{page:_0xf685e3,limit:_0x80988c,status:_0x2d2efe,gateway:_0x27aa8c}=_0x44a990,_0x5d09e0=(_0xf685e3-0x1)*_0x80988c,_0x545a77={'shopId':_0x1983f5};_0x2d2efe&&(_0x545a77[_0x958b17(0x18a)]=_0x2d2efe[_0x958b17(0x19a)]());if(_0x27aa8c){if((0x0,gateway_1['isValidGatewayId'])(_0x27aa8c)){const _0x44e955=(0x0,gateway_1['getGatewayNameById'])(_0x27aa8c);_0x44e955&&(_0x545a77[_0x958b17(0x1ba)]=_0x44e955);}else _0x545a77[_0x958b17(0x1ba)]=_0x27aa8c[_0x958b17(0x19e)]();}const [_0x4b2dce,_0x14bfac]=await Promise[_0x958b17(0x1b3)]([database_1[_0x958b17(0x1c4)][_0x958b17(0x1dd)][_0x958b17(0x1f6)]({'where':_0x545a77,'skip':_0x5d09e0,'take':_0x80988c,'orderBy':{'createdAt':_0x958b17(0x195)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'sourceCurrency':!![],'usage':!![],'status':!![],'externalPaymentUrl':!![],'successUrl':!![],'failUrl':!![],'expiresAt':!![],'orderId':!![],'gatewayOrderId':!![],'customerEmail':!![],'customerName':!![],'invoiceTotalSum':!![],'qrCode':!![],'qrUrl':!![],'country':!![],'language':!![],'amountIsEditable':!![],'maxPayments':!![],'rapydCustomer':!![],'cardLast4':!![],'paymentMethod':!![],'bankId':!![],'remitterIban':!![],'remitterName':!![],'createdAt':!![],'updatedAt':!![]}}),database_1['default'][_0x958b17(0x1dd)]['count']({'where':_0x545a77})]);return{'payments':_0x4b2dce[_0x958b17(0x202)](_0x5e5844=>{const _0x27f9ee=_0x958b17;let _0x1fca12;return _0x5e5844[_0x27f9ee(0x1ba)]===_0x27f9ee(0x187)||_0x5e5844[_0x27f9ee(0x1ba)]['startsWith'](_0x27f9ee(0x1f8))?_0x1fca12=_0x27f9ee(0x1a5)+_0x5e5844['id']:_0x1fca12=_0x27f9ee(0x17f)+_0x5e5844['id'],{'id':_0x5e5844['id'],'gateway':_0x5e5844[_0x27f9ee(0x1ba)],'title':'Order\x20ID:\x20'+_0x5e5844[_0x27f9ee(0x1b4)],'amount':_0x5e5844[_0x27f9ee(0x197)],'currency':_0x5e5844['currency'],'source_currency':_0x5e5844[_0x27f9ee(0x17c)],'usage':_0x5e5844[_0x27f9ee(0x181)],'status':_0x5e5844[_0x27f9ee(0x18a)][_0x27f9ee(0x19e)](),'payment_url':_0x1fca12,'external_payment_url':_0x5e5844[_0x27f9ee(0x16f)],'success_url':_0x5e5844[_0x27f9ee(0x174)],'fail_url':_0x5e5844['failUrl'],'expires_at':_0x5e5844[_0x27f9ee(0x196)],'order_id':_0x5e5844[_0x27f9ee(0x1cb)],'gateway_order_id':_0x5e5844[_0x27f9ee(0x1b4)],'customer_email':_0x5e5844[_0x27f9ee(0x1ca)],'customer_name':_0x5e5844[_0x27f9ee(0x1f2)],'invoice_total_sum':_0x5e5844[_0x27f9ee(0x199)],'qr_code':_0x5e5844['qrCode'],'qr_url':_0x5e5844[_0x27f9ee(0x1b0)],'country':_0x5e5844[_0x27f9ee(0x183)],'language':_0x5e5844[_0x27f9ee(0x1c6)],'amount_is_editable':_0x5e5844['amountIsEditable'],'max_payments':_0x5e5844[_0x27f9ee(0x1df)],'rapyd_customer':_0x5e5844['rapydCustomer'],'card_last4':_0x5e5844['cardLast4'],'payment_method':_0x5e5844['paymentMethod'],'bank_id':_0x5e5844[_0x27f9ee(0x18b)],'remitter_iban':_0x5e5844[_0x27f9ee(0x1d6)],'remitter_name':_0x5e5844['remitterName'],'created_at':_0x5e5844['createdAt'],'updated_at':_0x5e5844[_0x27f9ee(0x1b6)]};}),'pagination':{'page':_0xf685e3,'limit':_0x80988c,'total':_0x14bfac,'totalPages':Math['ceil'](_0x14bfac/_0x80988c)}};}async['getPaymentByShopAndId'](_0x5ea762,_0x54e805){const _0x2edbb9=a46_0x1830f6,_0x598aea=await database_1[_0x2edbb9(0x1c4)][_0x2edbb9(0x1dd)][_0x2edbb9(0x1bc)]({'where':{'id':_0x54e805,'shopId':_0x5ea762},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'sourceCurrency':!![],'usage':!![],'status':!![],'externalPaymentUrl':!![],'successUrl':!![],'failUrl':!![],'expiresAt':!![],'orderId':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'customerEmail':!![],'customerName':!![],'invoiceTotalSum':!![],'qrCode':!![],'qrUrl':!![],'country':!![],'language':!![],'amountIsEditable':!![],'maxPayments':!![],'rapydCustomer':!![],'cardLast4':!![],'paymentMethod':!![],'bankId':!![],'remitterIban':!![],'remitterName':!![],'createdAt':!![],'updatedAt':!![]}});if(!_0x598aea)return null;let _0x589d37;return _0x598aea[_0x2edbb9(0x1ba)]===_0x2edbb9(0x187)||_0x598aea[_0x2edbb9(0x1ba)][_0x2edbb9(0x211)](_0x2edbb9(0x1f8))?_0x589d37='https://app.trapay.uk/payment/'+_0x598aea['id']:_0x589d37='https://tesoft.uk/gateway/payment.php?id='+_0x598aea['id'],{'id':_0x598aea['id'],'gateway':_0x598aea[_0x2edbb9(0x1ba)],'title':_0x2edbb9(0x171)+_0x598aea[_0x2edbb9(0x1b4)],'amount':_0x598aea[_0x2edbb9(0x197)],'currency':_0x598aea[_0x2edbb9(0x1ed)],'source_currency':_0x598aea[_0x2edbb9(0x17c)],'usage':_0x598aea[_0x2edbb9(0x181)],'status':_0x598aea[_0x2edbb9(0x18a)]['toLowerCase'](),'payment_url':_0x589d37,'external_payment_url':_0x598aea[_0x2edbb9(0x16f)],'success_url':_0x598aea[_0x2edbb9(0x174)],'fail_url':_0x598aea[_0x2edbb9(0x1f1)],'expires_at':_0x598aea['expiresAt'],'order_id':_0x598aea[_0x2edbb9(0x1cb)],'gateway_order_id':_0x598aea['gatewayOrderId'],'gateway_payment_id':_0x598aea['gatewayPaymentId'],'customer_email':_0x598aea[_0x2edbb9(0x1ca)],'customer_name':_0x598aea[_0x2edbb9(0x1f2)],'invoice_total_sum':_0x598aea[_0x2edbb9(0x199)],'qr_code':_0x598aea[_0x2edbb9(0x1f7)],'qr_url':_0x598aea[_0x2edbb9(0x1b0)],'country':_0x598aea[_0x2edbb9(0x183)],'language':_0x598aea[_0x2edbb9(0x1c6)],'amount_is_editable':_0x598aea[_0x2edbb9(0x1a4)],'max_payments':_0x598aea[_0x2edbb9(0x1df)],'rapyd_customer':_0x598aea['rapydCustomer'],'card_last4':_0x598aea[_0x2edbb9(0x1a2)],'payment_method':_0x598aea[_0x2edbb9(0x177)],'bank_id':_0x598aea[_0x2edbb9(0x18b)],'remitter_iban':_0x598aea[_0x2edbb9(0x1d6)],'remitter_name':_0x598aea[_0x2edbb9(0x191)],'created_at':_0x598aea[_0x2edbb9(0x1e8)],'updated_at':_0x598aea[_0x2edbb9(0x1b6)]};}}exports[a46_0x1830f6(0x168)]=PaymentService;