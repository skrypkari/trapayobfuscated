'use strict';const a51_0x49e994=a51_0x18c2;function a51_0x30cc(){const _0x596a64=['twoFactorEnabled','generateToken','shop','361956lzqycq','backupCodes','verifyCaptcha','expiresIn','path','length','default','secret','../config/database','admin','205847PTUbUL','Invalid\x20token','startsWith','captchaService','defineProperty','Invalid\x20credentials','1046142oyuhZv','365ZertHb','2OhEeif','password','utf8','existsSync','.env','writeFileSync','trim','9204GIyCAr','verify','Invalid\x202FA\x20token\x20or\x20backup\x20code','parse','status','splice','jsonwebtoken','../config/config','1363656MkUbMM','Account\x20is\x20not\x20active','config','__esModule','ACTIVE','ADMIN_BACKUP_CODES=','readFileSync','verifyToken','username','./captchaService','2503640SziRNX','update','517314McnNij','AuthService','compare','findUnique','base32','name','totp','split','jwt','join','cloudflare','passwordHash'];a51_0x30cc=function(){return _0x596a64;};return a51_0x30cc();}(function(_0x311c9b,_0x9d5597){const _0x128f64=a51_0x18c2,_0x408740=_0x311c9b();while(!![]){try{const _0x47327e=parseInt(_0x128f64(0xd8))/0x1*(-parseInt(_0x128f64(0xe0))/0x2)+-parseInt(_0x128f64(0xbf))/0x3+-parseInt(_0x128f64(0xab))/0x4*(-parseInt(_0x128f64(0xdf))/0x5)+parseInt(_0x128f64(0xb3))/0x6+-parseInt(_0x128f64(0xce))/0x7+parseInt(_0x128f64(0xbd))/0x8+-parseInt(_0x128f64(0xde))/0x9;if(_0x47327e===_0x9d5597)break;else _0x408740['push'](_0x408740['shift']());}catch(_0x53a0b2){_0x408740['push'](_0x408740['shift']());}}}(a51_0x30cc,0x278b5));function a51_0x18c2(_0x5719b3,_0x40b526){_0x5719b3=_0x5719b3-0xab;const _0x30cc37=a51_0x30cc();let _0x18c28f=_0x30cc37[_0x5719b3];return _0x18c28f;}var __importDefault=this&&this['__importDefault']||function(_0x32c68b){return _0x32c68b&&_0x32c68b['__esModule']?_0x32c68b:{'default':_0x32c68b};};Object[a51_0x49e994(0xdc)](exports,a51_0x49e994(0xb6),{'value':!![]}),exports[a51_0x49e994(0xc0)]=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),jsonwebtoken_1=__importDefault(require(a51_0x49e994(0xb1))),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require(a51_0x49e994(0xd6))),config_1=require(a51_0x49e994(0xb2)),captchaService_1=require(a51_0x49e994(0xbc));class AuthService{[a51_0x49e994(0xcc)](_0x54bf6d){const _0x2af281=a51_0x49e994;return jsonwebtoken_1[_0x2af281(0xd4)]['sign'](_0x54bf6d,config_1[_0x2af281(0xb5)][_0x2af281(0xc7)][_0x2af281(0xd5)],{'expiresIn':String(config_1[_0x2af281(0xb5)][_0x2af281(0xc7)][_0x2af281(0xd1)])});}async['login'](_0x5bdabd){const _0x588481=a51_0x49e994,{username:_0x1c21ff,password:_0x44896b,twoFactorToken:_0x1ef230,captchaToken:_0x2054e9}=_0x5bdabd;if(!_0x1ef230||_0x1ef230[_0x588481(0xe6)]()===''){if(_0x2054e9){const _0x561ea9=await captchaService_1[_0x588481(0xdb)][_0x588481(0xd0)](_0x2054e9);if(!_0x561ea9)throw new Error('Invalid\x20captcha');}else{if(config_1[_0x588481(0xb5)][_0x588481(0xc9)]?.['turnstileSecretKey'])throw new Error('Captcha\x20verification\x20required');}}if(_0x1c21ff===config_1[_0x588481(0xb5)]['admin'][_0x588481(0xbb)]){const _0x1d251e=await bcryptjs_1[_0x588481(0xd4)][_0x588481(0xc1)](_0x44896b,config_1[_0x588481(0xb5)][_0x588481(0xd7)][_0x588481(0xca)]);if(_0x1d251e){if(config_1[_0x588481(0xb5)][_0x588481(0xd7)][_0x588481(0xcb)]){if(!_0x1ef230)return{'access_token':'','role':_0x588481(0xd7),'requires2FA':!![]};const _0x4b5ab0=speakeasy_1['default'][_0x588481(0xc5)][_0x588481(0xac)]({'secret':config_1[_0x588481(0xb5)][_0x588481(0xd7)]['twoFactorSecret'],'encoding':_0x588481(0xc3),'token':_0x1ef230,'window':0x2});if(!_0x4b5ab0){let _0x5b9784=![];if(config_1[_0x588481(0xb5)][_0x588481(0xd7)][_0x588481(0xcf)]){const _0x41f152=JSON[_0x588481(0xae)](config_1[_0x588481(0xb5)][_0x588481(0xd7)][_0x588481(0xcf)]);for(let _0x27bb6d=0x0;_0x27bb6d<_0x41f152[_0x588481(0xd3)];_0x27bb6d++){const _0x10afce=await bcryptjs_1[_0x588481(0xd4)][_0x588481(0xc1)](_0x1ef230,_0x41f152[_0x27bb6d]);if(_0x10afce){_0x5b9784=!![],_0x41f152[_0x588481(0xb0)](_0x27bb6d,0x1),config_1[_0x588481(0xb5)][_0x588481(0xd7)][_0x588481(0xcf)]=JSON['stringify'](_0x41f152);const _0x5d6ae3=require('fs'),_0x134c3b=require(_0x588481(0xd2)),_0x36b5e4=_0x134c3b[_0x588481(0xc8)](process['cwd'](),_0x588481(0xe4));if(_0x5d6ae3[_0x588481(0xe3)](_0x36b5e4)){let _0x2f64de=_0x5d6ae3[_0x588481(0xb9)](_0x36b5e4,_0x588481(0xe2));const _0x2693ca=_0x2f64de[_0x588481(0xc6)]('\x0a');for(let _0x4a7cd1=0x0;_0x4a7cd1<_0x2693ca['length'];_0x4a7cd1++){if(_0x2693ca[_0x4a7cd1][_0x588481(0xda)](_0x588481(0xb8))){_0x2693ca[_0x4a7cd1]=_0x588481(0xb8)+JSON['stringify'](_0x41f152);break;}}_0x5d6ae3[_0x588481(0xe5)](_0x36b5e4,_0x2693ca['join']('\x0a'),_0x588481(0xe2));}break;}}}if(!_0x5b9784)throw new Error(_0x588481(0xad));}}const _0x1fd75e=this[_0x588481(0xcc)]({'id':_0x588481(0xd7),'username':config_1[_0x588481(0xb5)][_0x588481(0xd7)][_0x588481(0xbb)],'role':_0x588481(0xd7)});return{'access_token':_0x1fd75e,'role':_0x588481(0xd7)};}}const _0x524f94=await database_1['default'][_0x588481(0xcd)][_0x588481(0xc2)]({'where':{'username':_0x1c21ff},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x524f94)throw new Error('Invalid\x20credentials');if(_0x524f94[_0x588481(0xaf)]!==_0x588481(0xb7))throw new Error(_0x588481(0xb4));const _0x493465=await bcryptjs_1[_0x588481(0xd4)][_0x588481(0xc1)](_0x44896b,_0x524f94[_0x588481(0xe1)]);if(!_0x493465)throw new Error(_0x588481(0xdd));await database_1[_0x588481(0xd4)][_0x588481(0xcd)][_0x588481(0xbe)]({'where':{'id':_0x524f94['id']},'data':{'lastLoginAt':new Date()}});const _0x386be6=this[_0x588481(0xcc)]({'id':_0x524f94['id'],'username':_0x524f94['username'],'role':_0x588481(0xcd)});return{'access_token':_0x386be6,'role':_0x588481(0xcd),'user':{'id':_0x524f94['id'],'name':_0x524f94[_0x588481(0xc4)],'username':_0x524f94[_0x588481(0xbb)]}};}async[a51_0x49e994(0xba)](_0x205ffb){const _0x5d4fcf=a51_0x49e994;try{const _0xbb8ed1=jsonwebtoken_1[_0x5d4fcf(0xd4)][_0x5d4fcf(0xac)](_0x205ffb,config_1[_0x5d4fcf(0xb5)]['jwt'][_0x5d4fcf(0xd5)]);return _0xbb8ed1;}catch(_0x7a1019){throw new Error(_0x5d4fcf(0xd9));}}}exports[a51_0x49e994(0xc0)]=AuthService;