'use strict';const a54_0x289278=a54_0x1222;(function(_0x1db67e,_0x2b91eb){const _0x2c7092=a54_0x1222,_0x30976c=_0x1db67e();while(!![]){try{const _0x43ecc8=parseInt(_0x2c7092(0x163))/0x1+parseInt(_0x2c7092(0x147))/0x2+-parseInt(_0x2c7092(0x17d))/0x3*(-parseInt(_0x2c7092(0x182))/0x4)+parseInt(_0x2c7092(0x150))/0x5*(parseInt(_0x2c7092(0x156))/0x6)+-parseInt(_0x2c7092(0x173))/0x7*(parseInt(_0x2c7092(0x145))/0x8)+parseInt(_0x2c7092(0x154))/0x9+-parseInt(_0x2c7092(0x17c))/0xa;if(_0x43ecc8===_0x2b91eb)break;else _0x30976c['push'](_0x30976c['shift']());}catch(_0x1a3a83){_0x30976c['push'](_0x30976c['shift']());}}}(a54_0x1663,0x70a68));var __importDefault=this&&this[a54_0x289278(0x179)]||function(_0x5c21da){const _0x33b146=a54_0x289278;return _0x5c21da&&_0x5c21da[_0x33b146(0x16f)]?_0x5c21da:{'default':_0x5c21da};};function a54_0x1663(){const _0x57a278=['Invalid\x20captcha','8288874UxtAlf','trim','498otLlDf','length','jwt','turnstileSecretKey','name','stringify','backupCodes','utf8','admin','writeFileSync','totp','defineProperty','compare','815463znJSFm','login','readFileSync','bcryptjs','generateToken','captchaService','shop','cloudflare','existsSync','base32','default','config','__esModule','findUnique','Invalid\x202FA\x20token\x20or\x20backup\x20code','join','2513IUBOzn','update','startsWith','Captcha\x20verification\x20required','path','speakeasy','__importDefault','../config/config','Invalid\x20token','15640560ylHFiZ','4029TYhzmr','ACTIVE','Invalid\x20credentials','verifyCaptcha','parse','992pqDBcL','passwordHash','../config/database','18504LKRKtW','twoFactorEnabled','1153668czgqMo','verify','sign','username','AuthService','split','jsonwebtoken','./captchaService','secret','12620peLNyh','splice','ADMIN_BACKUP_CODES='];a54_0x1663=function(){return _0x57a278;};return a54_0x1663();}Object[a54_0x289278(0x161)](exports,a54_0x289278(0x16f),{'value':!![]}),exports[a54_0x289278(0x14b)]=void 0x0;const bcryptjs_1=__importDefault(require(a54_0x289278(0x166))),jsonwebtoken_1=__importDefault(require(a54_0x289278(0x14d))),speakeasy_1=__importDefault(require(a54_0x289278(0x178))),database_1=__importDefault(require(a54_0x289278(0x184))),config_1=require(a54_0x289278(0x17a)),captchaService_1=require(a54_0x289278(0x14e));function a54_0x1222(_0x34d8b8,_0x57758e){_0x34d8b8=_0x34d8b8-0x145;const _0x166316=a54_0x1663();let _0x1222f7=_0x166316[_0x34d8b8];return _0x1222f7;}class AuthService{[a54_0x289278(0x167)](_0x1c6c71){const _0x126d14=a54_0x289278;return jsonwebtoken_1[_0x126d14(0x16d)][_0x126d14(0x149)](_0x1c6c71,config_1[_0x126d14(0x16e)][_0x126d14(0x158)]['secret'],{'expiresIn':String(config_1[_0x126d14(0x16e)][_0x126d14(0x158)]['expiresIn'])});}async[a54_0x289278(0x164)](_0x16d06e){const _0x2b60aa=a54_0x289278,{username:_0x6653bf,password:_0xbf5967,twoFactorToken:_0x17ba4f,captchaToken:_0x5eb424}=_0x16d06e;if(!_0x17ba4f||_0x17ba4f[_0x2b60aa(0x155)]()===''){if(_0x5eb424){const _0x7c6b8a=await captchaService_1[_0x2b60aa(0x168)][_0x2b60aa(0x180)](_0x5eb424);if(!_0x7c6b8a)throw new Error(_0x2b60aa(0x153));}else{if(config_1[_0x2b60aa(0x16e)][_0x2b60aa(0x16a)]?.[_0x2b60aa(0x159)])throw new Error(_0x2b60aa(0x176));}}if(_0x6653bf===config_1[_0x2b60aa(0x16e)]['admin'][_0x2b60aa(0x14a)]){const _0x116100=await bcryptjs_1[_0x2b60aa(0x16d)][_0x2b60aa(0x162)](_0xbf5967,config_1[_0x2b60aa(0x16e)][_0x2b60aa(0x15e)][_0x2b60aa(0x183)]);if(_0x116100){if(config_1[_0x2b60aa(0x16e)][_0x2b60aa(0x15e)][_0x2b60aa(0x146)]){if(!_0x17ba4f)return{'access_token':'','role':_0x2b60aa(0x15e),'requires2FA':!![]};const _0x409810=speakeasy_1[_0x2b60aa(0x16d)][_0x2b60aa(0x160)][_0x2b60aa(0x148)]({'secret':config_1['config'][_0x2b60aa(0x15e)]['twoFactorSecret'],'encoding':_0x2b60aa(0x16c),'token':_0x17ba4f,'window':0x2});if(!_0x409810){let _0x2c8b93=![];if(config_1['config'][_0x2b60aa(0x15e)][_0x2b60aa(0x15c)]){const _0x4e7b92=JSON[_0x2b60aa(0x181)](config_1['config'][_0x2b60aa(0x15e)]['backupCodes']);for(let _0xa260f3=0x0;_0xa260f3<_0x4e7b92[_0x2b60aa(0x157)];_0xa260f3++){const _0x5403e9=await bcryptjs_1[_0x2b60aa(0x16d)][_0x2b60aa(0x162)](_0x17ba4f,_0x4e7b92[_0xa260f3]);if(_0x5403e9){_0x2c8b93=!![],_0x4e7b92[_0x2b60aa(0x151)](_0xa260f3,0x1),config_1[_0x2b60aa(0x16e)][_0x2b60aa(0x15e)][_0x2b60aa(0x15c)]=JSON[_0x2b60aa(0x15b)](_0x4e7b92);const _0x383f3e=require('fs'),_0x394641=require(_0x2b60aa(0x177)),_0x25c9b8=_0x394641['join'](process['cwd'](),'.env');if(_0x383f3e[_0x2b60aa(0x16b)](_0x25c9b8)){let _0x12c180=_0x383f3e[_0x2b60aa(0x165)](_0x25c9b8,_0x2b60aa(0x15d));const _0x21780f=_0x12c180[_0x2b60aa(0x14c)]('\x0a');for(let _0xe03fb8=0x0;_0xe03fb8<_0x21780f[_0x2b60aa(0x157)];_0xe03fb8++){if(_0x21780f[_0xe03fb8][_0x2b60aa(0x175)](_0x2b60aa(0x152))){_0x21780f[_0xe03fb8]=_0x2b60aa(0x152)+JSON['stringify'](_0x4e7b92);break;}}_0x383f3e[_0x2b60aa(0x15f)](_0x25c9b8,_0x21780f[_0x2b60aa(0x172)]('\x0a'),'utf8');}break;}}}if(!_0x2c8b93)throw new Error(_0x2b60aa(0x171));}}const _0x3b4700=this[_0x2b60aa(0x167)]({'id':_0x2b60aa(0x15e),'username':config_1[_0x2b60aa(0x16e)][_0x2b60aa(0x15e)][_0x2b60aa(0x14a)],'role':_0x2b60aa(0x15e)});return{'access_token':_0x3b4700,'role':_0x2b60aa(0x15e)};}}const _0x4f311e=await database_1['default'][_0x2b60aa(0x169)][_0x2b60aa(0x170)]({'where':{'username':_0x6653bf},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x4f311e)throw new Error(_0x2b60aa(0x17f));if(_0x4f311e['status']!==_0x2b60aa(0x17e))throw new Error('Account\x20is\x20not\x20active');const _0x198ec0=await bcryptjs_1['default'][_0x2b60aa(0x162)](_0xbf5967,_0x4f311e['password']);if(!_0x198ec0)throw new Error(_0x2b60aa(0x17f));await database_1[_0x2b60aa(0x16d)][_0x2b60aa(0x169)][_0x2b60aa(0x174)]({'where':{'id':_0x4f311e['id']},'data':{'lastLoginAt':new Date()}});const _0x56c970=this[_0x2b60aa(0x167)]({'id':_0x4f311e['id'],'username':_0x4f311e[_0x2b60aa(0x14a)],'role':_0x2b60aa(0x169)});return{'access_token':_0x56c970,'role':'shop','user':{'id':_0x4f311e['id'],'name':_0x4f311e[_0x2b60aa(0x15a)],'username':_0x4f311e[_0x2b60aa(0x14a)]}};}async['verifyToken'](_0x337d8c){const _0x140e05=a54_0x289278;try{const _0x241cff=jsonwebtoken_1[_0x140e05(0x16d)][_0x140e05(0x148)](_0x337d8c,config_1[_0x140e05(0x16e)][_0x140e05(0x158)][_0x140e05(0x14f)]);return _0x241cff;}catch(_0x50eff9){throw new Error(_0x140e05(0x17b));}}}exports[a54_0x289278(0x14b)]=AuthService;