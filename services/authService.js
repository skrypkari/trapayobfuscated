'use strict';const a54_0x230599=a54_0x2b63;function a54_0x20ff(){const _0x5029fe=['speakeasy','Invalid\x202FA\x20token\x20or\x20backup\x20code','config','Invalid\x20credentials','verifyCaptcha','utf8','18621TVrtfY','existsSync','44177kOwMBS','Invalid\x20captcha','parse','generateToken','verifyToken','39861dvpRuu','390026TYEsvY','path','jsonwebtoken','../config/database','startsWith','.env','length','username','backupCodes','ACTIVE','default','passwordHash','update','923035obiCqY','twoFactorSecret','status','__importDefault','findUnique','password','16chgVMI','bcryptjs','admin','Account\x20is\x20not\x20active','splice','defineProperty','verify','568pddZHE','./captchaService','1635792exgrvQ','split','join','compare','stringify','name','jwt','shop','Invalid\x20token','AuthService','54099rclfWT','secret','login','__esModule','sign','ADMIN_BACKUP_CODES='];a54_0x20ff=function(){return _0x5029fe;};return a54_0x20ff();}(function(_0x22fd3c,_0x2ce63e){const _0x279817=a54_0x2b63,_0x18b60f=_0x22fd3c();while(!![]){try{const _0x1854b2=parseInt(_0x279817(0x1df))/0x1+parseInt(_0x279817(0x1e7))/0x2+parseInt(_0x279817(0x1e6))/0x3*(-parseInt(_0x279817(0x1fa))/0x4)+-parseInt(_0x279817(0x1f4))/0x5+-parseInt(_0x279817(0x203))/0x6+parseInt(_0x279817(0x1e1))/0x7+parseInt(_0x279817(0x201))/0x8*(parseInt(_0x279817(0x20d))/0x9);if(_0x1854b2===_0x2ce63e)break;else _0x18b60f['push'](_0x18b60f['shift']());}catch(_0x3dbf83){_0x18b60f['push'](_0x18b60f['shift']());}}}(a54_0x20ff,0x21493));function a54_0x2b63(_0x2f299b,_0x4e4fe8){_0x2f299b=_0x2f299b-0x1d5;const _0x20ff12=a54_0x20ff();let _0x2b63e0=_0x20ff12[_0x2f299b];return _0x2b63e0;}var __importDefault=this&&this[a54_0x230599(0x1f7)]||function(_0x11c676){const _0x53566e=a54_0x230599;return _0x11c676&&_0x11c676[_0x53566e(0x1d6)]?_0x11c676:{'default':_0x11c676};};Object[a54_0x230599(0x1ff)](exports,a54_0x230599(0x1d6),{'value':!![]}),exports[a54_0x230599(0x20c)]=void 0x0;const bcryptjs_1=__importDefault(require(a54_0x230599(0x1fb))),jsonwebtoken_1=__importDefault(require(a54_0x230599(0x1e9))),speakeasy_1=__importDefault(require(a54_0x230599(0x1d9))),database_1=__importDefault(require(a54_0x230599(0x1ea))),config_1=require('../config/config'),captchaService_1=require(a54_0x230599(0x202));class AuthService{[a54_0x230599(0x1e4)](_0x4e3b47){const _0x593681=a54_0x230599;return jsonwebtoken_1[_0x593681(0x1f1)][_0x593681(0x1d7)](_0x4e3b47,config_1[_0x593681(0x1db)]['jwt'][_0x593681(0x20e)],{'expiresIn':String(config_1[_0x593681(0x1db)]['jwt']['expiresIn'])});}async[a54_0x230599(0x1d5)](_0x282c3d){const _0x492d17=a54_0x230599,{username:_0xfeb94f,password:_0x2a563c,twoFactorToken:_0x5c9ff0,captchaToken:_0x1ff6a5}=_0x282c3d;if(!_0x5c9ff0||_0x5c9ff0['trim']()===''){if(_0x1ff6a5){const _0x494ff1=await captchaService_1['captchaService'][_0x492d17(0x1dd)](_0x1ff6a5);if(!_0x494ff1)throw new Error(_0x492d17(0x1e2));}else{if(config_1[_0x492d17(0x1db)]['cloudflare']?.['turnstileSecretKey'])throw new Error('Captcha\x20verification\x20required');}}if(_0xfeb94f===config_1['config'][_0x492d17(0x1fc)]['username']){const _0x3106de=await bcryptjs_1[_0x492d17(0x1f1)][_0x492d17(0x206)](_0x2a563c,config_1[_0x492d17(0x1db)][_0x492d17(0x1fc)][_0x492d17(0x1f2)]);if(_0x3106de){if(config_1[_0x492d17(0x1db)][_0x492d17(0x1fc)]['twoFactorEnabled']){if(!_0x5c9ff0)return{'access_token':'','role':'admin','requires2FA':!![]};const _0x10143c=speakeasy_1['default']['totp'][_0x492d17(0x200)]({'secret':config_1[_0x492d17(0x1db)][_0x492d17(0x1fc)][_0x492d17(0x1f5)],'encoding':'base32','token':_0x5c9ff0,'window':0x2});if(!_0x10143c){let _0x1e3529=![];if(config_1[_0x492d17(0x1db)][_0x492d17(0x1fc)]['backupCodes']){const _0x4839d8=JSON[_0x492d17(0x1e3)](config_1['config'][_0x492d17(0x1fc)][_0x492d17(0x1ef)]);for(let _0x2c8d04=0x0;_0x2c8d04<_0x4839d8[_0x492d17(0x1ed)];_0x2c8d04++){const _0x35bbd6=await bcryptjs_1[_0x492d17(0x1f1)][_0x492d17(0x206)](_0x5c9ff0,_0x4839d8[_0x2c8d04]);if(_0x35bbd6){_0x1e3529=!![],_0x4839d8[_0x492d17(0x1fe)](_0x2c8d04,0x1),config_1[_0x492d17(0x1db)]['admin'][_0x492d17(0x1ef)]=JSON['stringify'](_0x4839d8);const _0x177e6c=require('fs'),_0x2dd0f7=require(_0x492d17(0x1e8)),_0x2d5256=_0x2dd0f7[_0x492d17(0x205)](process['cwd'](),_0x492d17(0x1ec));if(_0x177e6c[_0x492d17(0x1e0)](_0x2d5256)){let _0x2b0fc7=_0x177e6c['readFileSync'](_0x2d5256,_0x492d17(0x1de));const _0xe235b1=_0x2b0fc7[_0x492d17(0x204)]('\x0a');for(let _0x27bb82=0x0;_0x27bb82<_0xe235b1[_0x492d17(0x1ed)];_0x27bb82++){if(_0xe235b1[_0x27bb82][_0x492d17(0x1eb)](_0x492d17(0x1d8))){_0xe235b1[_0x27bb82]=_0x492d17(0x1d8)+JSON[_0x492d17(0x207)](_0x4839d8);break;}}_0x177e6c['writeFileSync'](_0x2d5256,_0xe235b1['join']('\x0a'),_0x492d17(0x1de));}break;}}}if(!_0x1e3529)throw new Error(_0x492d17(0x1da));}}const _0xf3fda8=this['generateToken']({'id':_0x492d17(0x1fc),'username':config_1[_0x492d17(0x1db)][_0x492d17(0x1fc)][_0x492d17(0x1ee)],'role':'admin'});return{'access_token':_0xf3fda8,'role':_0x492d17(0x1fc)};}}const _0x21a2cc=await database_1[_0x492d17(0x1f1)]['shop'][_0x492d17(0x1f8)]({'where':{'username':_0xfeb94f},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x21a2cc)throw new Error(_0x492d17(0x1dc));if(_0x21a2cc[_0x492d17(0x1f6)]!==_0x492d17(0x1f0))throw new Error(_0x492d17(0x1fd));const _0xcdcb0a=await bcryptjs_1[_0x492d17(0x1f1)][_0x492d17(0x206)](_0x2a563c,_0x21a2cc[_0x492d17(0x1f9)]);if(!_0xcdcb0a)throw new Error(_0x492d17(0x1dc));await database_1[_0x492d17(0x1f1)][_0x492d17(0x20a)][_0x492d17(0x1f3)]({'where':{'id':_0x21a2cc['id']},'data':{'lastLoginAt':new Date()}});const _0x1ca4ba=this[_0x492d17(0x1e4)]({'id':_0x21a2cc['id'],'username':_0x21a2cc[_0x492d17(0x1ee)],'role':_0x492d17(0x20a)});return{'access_token':_0x1ca4ba,'role':'shop','user':{'id':_0x21a2cc['id'],'name':_0x21a2cc[_0x492d17(0x208)],'username':_0x21a2cc[_0x492d17(0x1ee)]}};}async[a54_0x230599(0x1e5)](_0x3d6cf0){const _0x538be8=a54_0x230599;try{const _0x4fdc08=jsonwebtoken_1[_0x538be8(0x1f1)][_0x538be8(0x200)](_0x3d6cf0,config_1[_0x538be8(0x1db)][_0x538be8(0x209)][_0x538be8(0x20e)]);return _0x4fdc08;}catch(_0x486533){throw new Error(_0x538be8(0x20b));}}}exports['AuthService']=AuthService;