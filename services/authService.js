'use strict';const a54_0x21c3a3=a54_0x2ff5;(function(_0xea5ee2,_0x107597){const _0x5ab247=a54_0x2ff5,_0x3af458=_0xea5ee2();while(!![]){try{const _0x4a63d8=-parseInt(_0x5ab247(0xa3))/0x1*(parseInt(_0x5ab247(0xbc))/0x2)+parseInt(_0x5ab247(0xc2))/0x3+parseInt(_0x5ab247(0xb7))/0x4+parseInt(_0x5ab247(0xc8))/0x5*(parseInt(_0x5ab247(0x9b))/0x6)+-parseInt(_0x5ab247(0xa8))/0x7+parseInt(_0x5ab247(0xa1))/0x8+-parseInt(_0x5ab247(0xb2))/0x9;if(_0x4a63d8===_0x107597)break;else _0x3af458['push'](_0x3af458['shift']());}catch(_0x5de8f4){_0x3af458['push'](_0x3af458['shift']());}}}(a54_0x4f16,0x3a2e6));var __importDefault=this&&this[a54_0x21c3a3(0xc7)]||function(_0x5ee35e){const _0x223685=a54_0x21c3a3;return _0x5ee35e&&_0x5ee35e[_0x223685(0xa6)]?_0x5ee35e:{'default':_0x5ee35e};};Object[a54_0x21c3a3(0x95)](exports,a54_0x21c3a3(0xa6),{'value':!![]}),exports[a54_0x21c3a3(0x9e)]=void 0x0;const bcryptjs_1=__importDefault(require(a54_0x21c3a3(0xc6))),jsonwebtoken_1=__importDefault(require(a54_0x21c3a3(0xad))),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require('../config/database')),config_1=require('../config/config'),captchaService_1=require(a54_0x21c3a3(0xba));function a54_0x2ff5(_0x2a9a6e,_0x993886){_0x2a9a6e=_0x2a9a6e-0x94;const _0x4f1661=a54_0x4f16();let _0x2ff5c4=_0x4f1661[_0x2a9a6e];return _0x2ff5c4;}class AuthService{[a54_0x21c3a3(0x9a)](_0x1570e9){const _0x3ebf6b=a54_0x21c3a3;return jsonwebtoken_1[_0x3ebf6b(0xb4)][_0x3ebf6b(0xac)](_0x1570e9,config_1[_0x3ebf6b(0xa0)]['jwt'][_0x3ebf6b(0xb9)],{'expiresIn':String(config_1[_0x3ebf6b(0xa0)]['jwt'][_0x3ebf6b(0xb6)])});}async[a54_0x21c3a3(0xc0)](_0x43a1b2){const _0x3560d4=a54_0x21c3a3,{username:_0x5d846b,password:_0x125309,twoFactorToken:_0x37c88c,captchaToken:_0x261a1e}=_0x43a1b2;if(!_0x37c88c||_0x37c88c['trim']()===''){if(_0x261a1e){const _0x29246c=await captchaService_1['captchaService'][_0x3560d4(0xcb)](_0x261a1e);if(!_0x29246c)throw new Error('Invalid\x20captcha');}else{if(config_1[_0x3560d4(0xa0)][_0x3560d4(0xa7)]?.[_0x3560d4(0xbb)])throw new Error(_0x3560d4(0xa4));}}if(_0x5d846b===config_1[_0x3560d4(0xa0)][_0x3560d4(0xbe)][_0x3560d4(0xc1)]){const _0x1d1c8b=await bcryptjs_1[_0x3560d4(0xb4)][_0x3560d4(0xca)](_0x125309,config_1[_0x3560d4(0xa0)][_0x3560d4(0xbe)][_0x3560d4(0xc9)]);if(_0x1d1c8b){if(config_1['config']['admin'][_0x3560d4(0xa9)]){if(!_0x37c88c)return{'access_token':'','role':_0x3560d4(0xbe),'requires2FA':!![]};const _0x4afba4=speakeasy_1['default'][_0x3560d4(0xb8)][_0x3560d4(0xb5)]({'secret':config_1[_0x3560d4(0xa0)][_0x3560d4(0xbe)]['twoFactorSecret'],'encoding':'base32','token':_0x37c88c,'window':0x2});if(!_0x4afba4){let _0x20a480=![];if(config_1[_0x3560d4(0xa0)][_0x3560d4(0xbe)][_0x3560d4(0xb0)]){const _0x1a63a0=JSON['parse'](config_1[_0x3560d4(0xa0)][_0x3560d4(0xbe)][_0x3560d4(0xb0)]);for(let _0x6054cc=0x0;_0x6054cc<_0x1a63a0['length'];_0x6054cc++){const _0x57059d=await bcryptjs_1['default']['compare'](_0x37c88c,_0x1a63a0[_0x6054cc]);if(_0x57059d){_0x20a480=!![],_0x1a63a0['splice'](_0x6054cc,0x1),config_1[_0x3560d4(0xa0)][_0x3560d4(0xbe)][_0x3560d4(0xb0)]=JSON[_0x3560d4(0xab)](_0x1a63a0);const _0x394c1b=require('fs'),_0x5247ae=require(_0x3560d4(0xa5)),_0x57b95b=_0x5247ae[_0x3560d4(0xc3)](process[_0x3560d4(0x9c)](),_0x3560d4(0xaf));if(_0x394c1b[_0x3560d4(0xc4)](_0x57b95b)){let _0x5baa1a=_0x394c1b[_0x3560d4(0x98)](_0x57b95b,_0x3560d4(0x99));const _0xf51640=_0x5baa1a[_0x3560d4(0xcc)]('\x0a');for(let _0x4e58d2=0x0;_0x4e58d2<_0xf51640['length'];_0x4e58d2++){if(_0xf51640[_0x4e58d2][_0x3560d4(0xb1)](_0x3560d4(0x96))){_0xf51640[_0x4e58d2]=_0x3560d4(0x96)+JSON[_0x3560d4(0xab)](_0x1a63a0);break;}}_0x394c1b[_0x3560d4(0xb3)](_0x57b95b,_0xf51640[_0x3560d4(0xc3)]('\x0a'),_0x3560d4(0x99));}break;}}}if(!_0x20a480)throw new Error(_0x3560d4(0xaa));}}const _0x27b0f8=this['generateToken']({'id':_0x3560d4(0xbe),'username':config_1[_0x3560d4(0xa0)][_0x3560d4(0xbe)][_0x3560d4(0xc1)],'role':_0x3560d4(0xbe)});return{'access_token':_0x27b0f8,'role':_0x3560d4(0xbe)};}}const _0x203395=await database_1[_0x3560d4(0xb4)][_0x3560d4(0x9d)][_0x3560d4(0xae)]({'where':{'username':_0x5d846b},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x203395)throw new Error('Invalid\x20credentials');if(_0x203395['status']!==_0x3560d4(0x9f))throw new Error('Account\x20is\x20not\x20active');const _0xeaddd=await bcryptjs_1['default']['compare'](_0x125309,_0x203395[_0x3560d4(0xbf)]);if(!_0xeaddd)throw new Error(_0x3560d4(0xc5));await database_1[_0x3560d4(0xb4)][_0x3560d4(0x9d)][_0x3560d4(0xbd)]({'where':{'id':_0x203395['id']},'data':{'lastLoginAt':new Date()}});const _0x30a7b5=this[_0x3560d4(0x9a)]({'id':_0x203395['id'],'username':_0x203395[_0x3560d4(0xc1)],'role':_0x3560d4(0x9d)});return{'access_token':_0x30a7b5,'role':_0x3560d4(0x9d),'user':{'id':_0x203395['id'],'name':_0x203395[_0x3560d4(0x97)],'username':_0x203395[_0x3560d4(0xc1)]}};}async[a54_0x21c3a3(0xa2)](_0x4af90f){const _0x5291d7=a54_0x21c3a3;try{const _0x49afab=jsonwebtoken_1['default'][_0x5291d7(0xb5)](_0x4af90f,config_1[_0x5291d7(0xa0)][_0x5291d7(0x94)][_0x5291d7(0xb9)]);return _0x49afab;}catch(_0x3bb477){throw new Error('Invalid\x20token');}}}exports[a54_0x21c3a3(0x9e)]=AuthService;function a54_0x4f16(){const _0x368711=['verifyToken','5586iioInw','Captcha\x20verification\x20required','path','__esModule','cloudflare','386463cZcWEG','twoFactorEnabled','Invalid\x202FA\x20token\x20or\x20backup\x20code','stringify','sign','jsonwebtoken','findUnique','.env','backupCodes','startsWith','10144071BOFdZH','writeFileSync','default','verify','expiresIn','1270656HCLRVt','totp','secret','./captchaService','turnstileSecretKey','4armaup','update','admin','password','login','username','1397943IEoEdH','join','existsSync','Invalid\x20credentials','bcryptjs','__importDefault','10urmXal','passwordHash','compare','verifyCaptcha','split','jwt','defineProperty','ADMIN_BACKUP_CODES=','name','readFileSync','utf8','generateToken','919692LZRtXG','cwd','shop','AuthService','ACTIVE','config','2732808YWBGRT'];a54_0x4f16=function(){return _0x368711;};return a54_0x4f16();}