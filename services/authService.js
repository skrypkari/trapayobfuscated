'use strict';const a54_0x374a18=a54_0x1ef0;(function(_0x52d684,_0x51cdcf){const _0x381a98=a54_0x1ef0,_0x176608=_0x52d684();while(!![]){try{const _0x176434=-parseInt(_0x381a98(0xc3))/0x1+parseInt(_0x381a98(0xdd))/0x2+-parseInt(_0x381a98(0xc8))/0x3+parseInt(_0x381a98(0xb2))/0x4+parseInt(_0x381a98(0xdc))/0x5*(parseInt(_0x381a98(0xb5))/0x6)+-parseInt(_0x381a98(0xd5))/0x7+-parseInt(_0x381a98(0xb6))/0x8;if(_0x176434===_0x51cdcf)break;else _0x176608['push'](_0x176608['shift']());}catch(_0x5b3eb7){_0x176608['push'](_0x176608['shift']());}}}(a54_0x4ede,0xadb47));function a54_0x1ef0(_0x32c302,_0x4a04e6){_0x32c302=_0x32c302-0xa4;const _0x4ede84=a54_0x4ede();let _0x1ef00f=_0x4ede84[_0x32c302];return _0x1ef00f;}var __importDefault=this&&this[a54_0x374a18(0xab)]||function(_0x4dc08e){const _0x579662=a54_0x374a18;return _0x4dc08e&&_0x4dc08e[_0x579662(0xd0)]?_0x4dc08e:{'default':_0x4dc08e};};function a54_0x4ede(){const _0x4b58a9=['Invalid\x202FA\x20token\x20or\x20backup\x20code','Account\x20is\x20not\x20active','utf8','3365067AlMaxt','verifyToken','Invalid\x20captcha','name','Invalid\x20credentials','writeFileSync','config','existsSync','__esModule','speakeasy','findUnique','verify','generateToken','499786FRsBvL','cloudflare','totp','default','shop','stringify','splice','130SVdfXt','2737050dtYyVA','jwt','jsonwebtoken','compare','Invalid\x20token','join','update','admin','__importDefault','backupCodes','path','bcryptjs','./captchaService','base32','captchaService','5548328gXJtja','passwordHash','length','156546ioPfrh','7642128xSuVWz','split','ADMIN_BACKUP_CODES=','startsWith','status','AuthService','password','trim','ACTIVE','twoFactorEnabled','secret','username','readFileSync','574125fLBIxw','../config/config'];a54_0x4ede=function(){return _0x4b58a9;};return a54_0x4ede();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['AuthService']=void 0x0;const bcryptjs_1=__importDefault(require(a54_0x374a18(0xae))),jsonwebtoken_1=__importDefault(require(a54_0x374a18(0xa5))),speakeasy_1=__importDefault(require(a54_0x374a18(0xd1))),database_1=__importDefault(require('../config/database')),config_1=require(a54_0x374a18(0xc4)),captchaService_1=require(a54_0x374a18(0xaf));class AuthService{['generateToken'](_0x5486bd){const _0x415045=a54_0x374a18;return jsonwebtoken_1[_0x415045(0xd8)]['sign'](_0x5486bd,config_1[_0x415045(0xce)][_0x415045(0xa4)]['secret'],{'expiresIn':String(config_1['config'][_0x415045(0xa4)]['expiresIn'])});}async['login'](_0x4d1e4f){const _0x10a0e8=a54_0x374a18,{username:_0x358c93,password:_0x4e6fb9,twoFactorToken:_0x43673a,captchaToken:_0x307f2b}=_0x4d1e4f;if(!_0x43673a||_0x43673a[_0x10a0e8(0xbd)]()===''){if(_0x307f2b){const _0xeff55d=await captchaService_1[_0x10a0e8(0xb1)]['verifyCaptcha'](_0x307f2b);if(!_0xeff55d)throw new Error(_0x10a0e8(0xca));}else{if(config_1[_0x10a0e8(0xce)][_0x10a0e8(0xd6)]?.['turnstileSecretKey'])throw new Error('Captcha\x20verification\x20required');}}if(_0x358c93===config_1['config'][_0x10a0e8(0xaa)]['username']){const _0x50a22e=await bcryptjs_1[_0x10a0e8(0xd8)][_0x10a0e8(0xa6)](_0x4e6fb9,config_1[_0x10a0e8(0xce)]['admin'][_0x10a0e8(0xb3)]);if(_0x50a22e){if(config_1[_0x10a0e8(0xce)]['admin'][_0x10a0e8(0xbf)]){if(!_0x43673a)return{'access_token':'','role':_0x10a0e8(0xaa),'requires2FA':!![]};const _0x2ad492=speakeasy_1['default'][_0x10a0e8(0xd7)]['verify']({'secret':config_1[_0x10a0e8(0xce)][_0x10a0e8(0xaa)]['twoFactorSecret'],'encoding':_0x10a0e8(0xb0),'token':_0x43673a,'window':0x2});if(!_0x2ad492){let _0x2d4c8d=![];if(config_1[_0x10a0e8(0xce)][_0x10a0e8(0xaa)][_0x10a0e8(0xac)]){const _0x31e965=JSON['parse'](config_1[_0x10a0e8(0xce)]['admin'][_0x10a0e8(0xac)]);for(let _0x2a6bb9=0x0;_0x2a6bb9<_0x31e965[_0x10a0e8(0xb4)];_0x2a6bb9++){const _0xff3573=await bcryptjs_1[_0x10a0e8(0xd8)][_0x10a0e8(0xa6)](_0x43673a,_0x31e965[_0x2a6bb9]);if(_0xff3573){_0x2d4c8d=!![],_0x31e965[_0x10a0e8(0xdb)](_0x2a6bb9,0x1),config_1[_0x10a0e8(0xce)][_0x10a0e8(0xaa)]['backupCodes']=JSON[_0x10a0e8(0xda)](_0x31e965);const _0x5c9c18=require('fs'),_0x14b808=require(_0x10a0e8(0xad)),_0xc3986f=_0x14b808[_0x10a0e8(0xa8)](process['cwd'](),'.env');if(_0x5c9c18[_0x10a0e8(0xcf)](_0xc3986f)){let _0x5935bf=_0x5c9c18[_0x10a0e8(0xc2)](_0xc3986f,_0x10a0e8(0xc7));const _0x3b230e=_0x5935bf[_0x10a0e8(0xb7)]('\x0a');for(let _0x2d46a6=0x0;_0x2d46a6<_0x3b230e['length'];_0x2d46a6++){if(_0x3b230e[_0x2d46a6][_0x10a0e8(0xb9)](_0x10a0e8(0xb8))){_0x3b230e[_0x2d46a6]='ADMIN_BACKUP_CODES='+JSON[_0x10a0e8(0xda)](_0x31e965);break;}}_0x5c9c18[_0x10a0e8(0xcd)](_0xc3986f,_0x3b230e[_0x10a0e8(0xa8)]('\x0a'),_0x10a0e8(0xc7));}break;}}}if(!_0x2d4c8d)throw new Error(_0x10a0e8(0xc5));}}const _0x4452c9=this[_0x10a0e8(0xd4)]({'id':_0x10a0e8(0xaa),'username':config_1[_0x10a0e8(0xce)]['admin'][_0x10a0e8(0xc1)],'role':_0x10a0e8(0xaa)});return{'access_token':_0x4452c9,'role':'admin'};}}const _0x6a25ff=await database_1[_0x10a0e8(0xd8)][_0x10a0e8(0xd9)][_0x10a0e8(0xd2)]({'where':{'username':_0x358c93},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x6a25ff)throw new Error(_0x10a0e8(0xcc));if(_0x6a25ff[_0x10a0e8(0xba)]!==_0x10a0e8(0xbe))throw new Error(_0x10a0e8(0xc6));const _0x42232a=await bcryptjs_1['default']['compare'](_0x4e6fb9,_0x6a25ff[_0x10a0e8(0xbc)]);if(!_0x42232a)throw new Error(_0x10a0e8(0xcc));await database_1['default'][_0x10a0e8(0xd9)][_0x10a0e8(0xa9)]({'where':{'id':_0x6a25ff['id']},'data':{'lastLoginAt':new Date()}});const _0x2ed630=this[_0x10a0e8(0xd4)]({'id':_0x6a25ff['id'],'username':_0x6a25ff[_0x10a0e8(0xc1)],'role':_0x10a0e8(0xd9)});return{'access_token':_0x2ed630,'role':_0x10a0e8(0xd9),'user':{'id':_0x6a25ff['id'],'name':_0x6a25ff[_0x10a0e8(0xcb)],'username':_0x6a25ff['username']}};}async[a54_0x374a18(0xc9)](_0x34e198){const _0x5272d1=a54_0x374a18;try{const _0x253bfd=jsonwebtoken_1[_0x5272d1(0xd8)][_0x5272d1(0xd3)](_0x34e198,config_1[_0x5272d1(0xce)][_0x5272d1(0xa4)][_0x5272d1(0xc0)]);return _0x253bfd;}catch(_0x21dc45){throw new Error(_0x5272d1(0xa7));}}}exports[a54_0x374a18(0xbb)]=AuthService;