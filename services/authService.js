'use strict';const a54_0xa22761=a54_0x3993;(function(_0x2ce26c,_0x420d42){const _0x3d19f1=a54_0x3993,_0x28442a=_0x2ce26c();while(!![]){try{const _0x48631d=-parseInt(_0x3d19f1(0x197))/0x1+-parseInt(_0x3d19f1(0x198))/0x2+parseInt(_0x3d19f1(0x1b1))/0x3+-parseInt(_0x3d19f1(0x1a4))/0x4+parseInt(_0x3d19f1(0x1a6))/0x5*(parseInt(_0x3d19f1(0x195))/0x6)+parseInt(_0x3d19f1(0x191))/0x7+parseInt(_0x3d19f1(0x1a3))/0x8;if(_0x48631d===_0x420d42)break;else _0x28442a['push'](_0x28442a['shift']());}catch(_0x17c6ad){_0x28442a['push'](_0x28442a['shift']());}}}(a54_0xdd14,0xba3cd));var __importDefault=this&&this[a54_0xa22761(0x182)]||function(_0x51c8d4){const _0x1f48ff=a54_0xa22761;return _0x51c8d4&&_0x51c8d4[_0x1f48ff(0x181)]?_0x51c8d4:{'default':_0x51c8d4};};Object[a54_0xa22761(0x19f)](exports,a54_0xa22761(0x181),{'value':!![]}),exports[a54_0xa22761(0x17e)]=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),jsonwebtoken_1=__importDefault(require(a54_0xa22761(0x18f))),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require(a54_0xa22761(0x1ac))),config_1=require('../config/config'),captchaService_1=require(a54_0xa22761(0x18d));class AuthService{['generateToken'](_0x13a72b){const _0x43731d=a54_0xa22761;return jsonwebtoken_1[_0x43731d(0x184)]['sign'](_0x13a72b,config_1[_0x43731d(0x17c)][_0x43731d(0x1a9)][_0x43731d(0x1b2)],{'expiresIn':String(config_1[_0x43731d(0x17c)]['jwt'][_0x43731d(0x1a5)])});}async[a54_0xa22761(0x19d)](_0x42f16a){const _0x241222=a54_0xa22761,{username:_0x1e9de7,password:_0x3c0111,twoFactorToken:_0x256d5b,captchaToken:_0x8fcffd}=_0x42f16a;if(!_0x256d5b||_0x256d5b[_0x241222(0x1ab)]()===''){if(_0x8fcffd){const _0x108e59=await captchaService_1[_0x241222(0x18b)][_0x241222(0x183)](_0x8fcffd);if(!_0x108e59)throw new Error(_0x241222(0x18a));}else{if(config_1[_0x241222(0x17c)][_0x241222(0x196)]?.[_0x241222(0x1a0)])throw new Error('Captcha\x20verification\x20required');}}if(_0x1e9de7===config_1[_0x241222(0x17c)][_0x241222(0x1ae)][_0x241222(0x18c)]){const _0x2335be=await bcryptjs_1[_0x241222(0x184)]['compare'](_0x3c0111,config_1[_0x241222(0x17c)]['admin'][_0x241222(0x19a)]);if(_0x2335be){if(config_1[_0x241222(0x17c)]['admin'][_0x241222(0x1b3)]){if(!_0x256d5b)return{'access_token':'','role':_0x241222(0x1ae),'requires2FA':!![]};const _0x3ee197=speakeasy_1[_0x241222(0x184)][_0x241222(0x17f)][_0x241222(0x1b6)]({'secret':config_1[_0x241222(0x17c)]['admin'][_0x241222(0x192)],'encoding':_0x241222(0x17d),'token':_0x256d5b,'window':0x2});if(!_0x3ee197){let _0x27d0e1=![];if(config_1[_0x241222(0x17c)]['admin'][_0x241222(0x1aa)]){const _0x1d85e1=JSON['parse'](config_1[_0x241222(0x17c)][_0x241222(0x1ae)][_0x241222(0x1aa)]);for(let _0x16d294=0x0;_0x16d294<_0x1d85e1['length'];_0x16d294++){const _0x3f35b9=await bcryptjs_1[_0x241222(0x184)][_0x241222(0x187)](_0x256d5b,_0x1d85e1[_0x16d294]);if(_0x3f35b9){_0x27d0e1=!![],_0x1d85e1['splice'](_0x16d294,0x1),config_1[_0x241222(0x17c)][_0x241222(0x1ae)][_0x241222(0x1aa)]=JSON['stringify'](_0x1d85e1);const _0x1f25e0=require('fs'),_0x102cc1=require(_0x241222(0x1af)),_0x3e1365=_0x102cc1[_0x241222(0x1a2)](process[_0x241222(0x189)](),_0x241222(0x19b));if(_0x1f25e0[_0x241222(0x188)](_0x3e1365)){let _0x136241=_0x1f25e0['readFileSync'](_0x3e1365,_0x241222(0x1b4));const _0x324479=_0x136241[_0x241222(0x19e)]('\x0a');for(let _0x16d72b=0x0;_0x16d72b<_0x324479[_0x241222(0x1b5)];_0x16d72b++){if(_0x324479[_0x16d72b][_0x241222(0x180)]('ADMIN_BACKUP_CODES=')){_0x324479[_0x16d72b]='ADMIN_BACKUP_CODES='+JSON[_0x241222(0x199)](_0x1d85e1);break;}}_0x1f25e0[_0x241222(0x190)](_0x3e1365,_0x324479[_0x241222(0x1a2)]('\x0a'),_0x241222(0x1b4));}break;}}}if(!_0x27d0e1)throw new Error(_0x241222(0x19c));}}const _0x165230=this[_0x241222(0x1a1)]({'id':'admin','username':config_1[_0x241222(0x17c)][_0x241222(0x1ae)][_0x241222(0x18c)],'role':_0x241222(0x1ae)});return{'access_token':_0x165230,'role':_0x241222(0x1ae)};}}const _0x164829=await database_1[_0x241222(0x184)][_0x241222(0x193)][_0x241222(0x1b0)]({'where':{'username':_0x1e9de7},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x164829)throw new Error(_0x241222(0x194));if(_0x164829[_0x241222(0x18e)]!=='ACTIVE')throw new Error(_0x241222(0x1a7));const _0x5afd7f=await bcryptjs_1[_0x241222(0x184)][_0x241222(0x187)](_0x3c0111,_0x164829[_0x241222(0x1ad)]);if(!_0x5afd7f)throw new Error(_0x241222(0x194));await database_1['default']['shop'][_0x241222(0x1a8)]({'where':{'id':_0x164829['id']},'data':{'lastLoginAt':new Date()}});const _0x2b0542=this['generateToken']({'id':_0x164829['id'],'username':_0x164829[_0x241222(0x18c)],'role':_0x241222(0x193)});return{'access_token':_0x2b0542,'role':'shop','user':{'id':_0x164829['id'],'name':_0x164829['name'],'username':_0x164829['username']}};}async[a54_0xa22761(0x185)](_0x404b77){const _0x44723a=a54_0xa22761;try{const _0x1a4f7a=jsonwebtoken_1[_0x44723a(0x184)][_0x44723a(0x1b6)](_0x404b77,config_1[_0x44723a(0x17c)][_0x44723a(0x1a9)][_0x44723a(0x1b2)]);return _0x1a4f7a;}catch(_0xc7060a){throw new Error(_0x44723a(0x186));}}}function a54_0x3993(_0x3f9555,_0x3b0fb2){_0x3f9555=_0x3f9555-0x17c;const _0xdd14ab=a54_0xdd14();let _0x3993af=_0xdd14ab[_0x3f9555];return _0x3993af;}function a54_0xdd14(){const _0x585677=['cwd','Invalid\x20captcha','captchaService','username','./captchaService','status','jsonwebtoken','writeFileSync','10221064wJfFXD','twoFactorSecret','shop','Invalid\x20credentials','19962SrlbcV','cloudflare','1065328eaoBoy','1773756EpXfef','stringify','passwordHash','.env','Invalid\x202FA\x20token\x20or\x20backup\x20code','login','split','defineProperty','turnstileSecretKey','generateToken','join','5138320CyalmD','4961072INnqbn','expiresIn','1415nCHKlO','Account\x20is\x20not\x20active','update','jwt','backupCodes','trim','../config/database','password','admin','path','findUnique','2733960GSTKTr','secret','twoFactorEnabled','utf8','length','verify','config','base32','AuthService','totp','startsWith','__esModule','__importDefault','verifyCaptcha','default','verifyToken','Invalid\x20token','compare','existsSync'];a54_0xdd14=function(){return _0x585677;};return a54_0xdd14();}exports[a54_0xa22761(0x17e)]=AuthService;