'use strict';const a54_0x226488=a54_0xc2f8;function a54_0xadc9(){const _0x390f0c=['102352nFdQVP','admin','twoFactorEnabled','expiresIn','bcryptjs','secret','verifyToken','217604eMNkHL','2505900jLweHU','username','ADMIN_BACKUP_CODES=','Captcha\x20verification\x20required','status','backupCodes','__importDefault','split','Account\x20is\x20not\x20active','speakeasy','existsSync','3361760iocaEa','length','verify','join','shop','generateToken','ACTIVE','Invalid\x202FA\x20token\x20or\x20backup\x20code','cloudflare','defineProperty','jsonwebtoken','parse','findUnique','stringify','name','verifyCaptcha','sign','utf8','422815MwBTYq','Invalid\x20credentials','login','startsWith','__esModule','compare','captchaService','Invalid\x20token','turnstileSecretKey','twoFactorSecret','2007006hAEmBv','default','config','50RaXnAz','update','passwordHash','jwt','writeFileSync','../config/config','589925yZHFIB','base32','cwd','AuthService','.env','path'];a54_0xadc9=function(){return _0x390f0c;};return a54_0xadc9();}(function(_0x48d75a,_0x47bfc3){const _0x465aa7=a54_0xc2f8,_0x25ac9e=_0x48d75a();while(!![]){try{const _0x5aef21=parseInt(_0x465aa7(0x1e2))/0x1+-parseInt(_0x465aa7(0x1fb))/0x2+parseInt(_0x465aa7(0x1c5))/0x3+-parseInt(_0x465aa7(0x202))/0x4*(parseInt(_0x465aa7(0x1ef))/0x5)+parseInt(_0x465aa7(0x1ec))/0x6+parseInt(_0x465aa7(0x1f5))/0x7+-parseInt(_0x465aa7(0x1d0))/0x8;if(_0x5aef21===_0x47bfc3)break;else _0x25ac9e['push'](_0x25ac9e['shift']());}catch(_0x39b63f){_0x25ac9e['push'](_0x25ac9e['shift']());}}}(a54_0xadc9,0xa17ed));var __importDefault=this&&this[a54_0x226488(0x1cb)]||function(_0x59fa98){const _0x14cf6f=a54_0x226488;return _0x59fa98&&_0x59fa98[_0x14cf6f(0x1e6)]?_0x59fa98:{'default':_0x59fa98};};Object[a54_0x226488(0x1d9)](exports,'__esModule',{'value':!![]}),exports[a54_0x226488(0x1f8)]=void 0x0;function a54_0xc2f8(_0x4a151d,_0x5b3247){_0x4a151d=_0x4a151d-0x1c5;const _0xadc926=a54_0xadc9();let _0xc2f898=_0xadc926[_0x4a151d];return _0xc2f898;}const bcryptjs_1=__importDefault(require(a54_0x226488(0x1ff))),jsonwebtoken_1=__importDefault(require(a54_0x226488(0x1da))),speakeasy_1=__importDefault(require(a54_0x226488(0x1ce))),database_1=__importDefault(require('../config/database')),config_1=require(a54_0x226488(0x1f4)),captchaService_1=require('./captchaService');class AuthService{['generateToken'](_0xb2ddf6){const _0x286e04=a54_0x226488;return jsonwebtoken_1['default'][_0x286e04(0x1e0)](_0xb2ddf6,config_1[_0x286e04(0x1ee)][_0x286e04(0x1f2)][_0x286e04(0x200)],{'expiresIn':String(config_1[_0x286e04(0x1ee)][_0x286e04(0x1f2)][_0x286e04(0x1fe)])});}async[a54_0x226488(0x1e4)](_0xc5ca26){const _0x300667=a54_0x226488,{username:_0x3daed8,password:_0x197ba1,twoFactorToken:_0x1775ec,captchaToken:_0x142e2f}=_0xc5ca26;if(!_0x1775ec||_0x1775ec['trim']()===''){if(_0x142e2f){const _0x1d4214=await captchaService_1[_0x300667(0x1e8)][_0x300667(0x1df)](_0x142e2f);if(!_0x1d4214)throw new Error('Invalid\x20captcha');}else{if(config_1[_0x300667(0x1ee)][_0x300667(0x1d8)]?.[_0x300667(0x1ea)])throw new Error(_0x300667(0x1c8));}}if(_0x3daed8===config_1[_0x300667(0x1ee)][_0x300667(0x1fc)][_0x300667(0x1c6)]){const _0x49e834=await bcryptjs_1[_0x300667(0x1ed)][_0x300667(0x1e7)](_0x197ba1,config_1[_0x300667(0x1ee)][_0x300667(0x1fc)][_0x300667(0x1f1)]);if(_0x49e834){if(config_1[_0x300667(0x1ee)][_0x300667(0x1fc)][_0x300667(0x1fd)]){if(!_0x1775ec)return{'access_token':'','role':_0x300667(0x1fc),'requires2FA':!![]};const _0x31c79d=speakeasy_1[_0x300667(0x1ed)]['totp'][_0x300667(0x1d2)]({'secret':config_1['config'][_0x300667(0x1fc)][_0x300667(0x1eb)],'encoding':_0x300667(0x1f6),'token':_0x1775ec,'window':0x2});if(!_0x31c79d){let _0x3d5841=![];if(config_1[_0x300667(0x1ee)]['admin'][_0x300667(0x1ca)]){const _0x1d04b7=JSON[_0x300667(0x1db)](config_1['config'][_0x300667(0x1fc)][_0x300667(0x1ca)]);for(let _0x409290=0x0;_0x409290<_0x1d04b7['length'];_0x409290++){const _0x222c6d=await bcryptjs_1[_0x300667(0x1ed)][_0x300667(0x1e7)](_0x1775ec,_0x1d04b7[_0x409290]);if(_0x222c6d){_0x3d5841=!![],_0x1d04b7['splice'](_0x409290,0x1),config_1[_0x300667(0x1ee)]['admin'][_0x300667(0x1ca)]=JSON[_0x300667(0x1dd)](_0x1d04b7);const _0x89c409=require('fs'),_0xa66ef2=require(_0x300667(0x1fa)),_0x3f6348=_0xa66ef2[_0x300667(0x1d3)](process[_0x300667(0x1f7)](),_0x300667(0x1f9));if(_0x89c409[_0x300667(0x1cf)](_0x3f6348)){let _0x2ddc4e=_0x89c409['readFileSync'](_0x3f6348,_0x300667(0x1e1));const _0x5c9b08=_0x2ddc4e[_0x300667(0x1cc)]('\x0a');for(let _0x5684b0=0x0;_0x5684b0<_0x5c9b08[_0x300667(0x1d1)];_0x5684b0++){if(_0x5c9b08[_0x5684b0][_0x300667(0x1e5)](_0x300667(0x1c7))){_0x5c9b08[_0x5684b0]=_0x300667(0x1c7)+JSON[_0x300667(0x1dd)](_0x1d04b7);break;}}_0x89c409[_0x300667(0x1f3)](_0x3f6348,_0x5c9b08[_0x300667(0x1d3)]('\x0a'),'utf8');}break;}}}if(!_0x3d5841)throw new Error(_0x300667(0x1d7));}}const _0xa89090=this[_0x300667(0x1d5)]({'id':_0x300667(0x1fc),'username':config_1[_0x300667(0x1ee)]['admin']['username'],'role':_0x300667(0x1fc)});return{'access_token':_0xa89090,'role':_0x300667(0x1fc)};}}const _0x11f192=await database_1[_0x300667(0x1ed)]['shop'][_0x300667(0x1dc)]({'where':{'username':_0x3daed8},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x11f192)throw new Error(_0x300667(0x1e3));if(_0x11f192[_0x300667(0x1c9)]!==_0x300667(0x1d6))throw new Error(_0x300667(0x1cd));const _0x557912=await bcryptjs_1[_0x300667(0x1ed)][_0x300667(0x1e7)](_0x197ba1,_0x11f192['password']);if(!_0x557912)throw new Error('Invalid\x20credentials');await database_1[_0x300667(0x1ed)][_0x300667(0x1d4)][_0x300667(0x1f0)]({'where':{'id':_0x11f192['id']},'data':{'lastLoginAt':new Date()}});const _0x3b5d33=this[_0x300667(0x1d5)]({'id':_0x11f192['id'],'username':_0x11f192[_0x300667(0x1c6)],'role':'shop'});return{'access_token':_0x3b5d33,'role':_0x300667(0x1d4),'user':{'id':_0x11f192['id'],'name':_0x11f192[_0x300667(0x1de)],'username':_0x11f192[_0x300667(0x1c6)]}};}async[a54_0x226488(0x201)](_0x419bfc){const _0x2399d7=a54_0x226488;try{const _0x413795=jsonwebtoken_1[_0x2399d7(0x1ed)][_0x2399d7(0x1d2)](_0x419bfc,config_1[_0x2399d7(0x1ee)]['jwt'][_0x2399d7(0x200)]);return _0x413795;}catch(_0xb0eb34){throw new Error(_0x2399d7(0x1e9));}}}exports[a54_0x226488(0x1f8)]=AuthService;