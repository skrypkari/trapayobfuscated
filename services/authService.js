'use strict';const a49_0x4ff2bc=a49_0x4d23;function a49_0x4d23(_0x295496,_0x5a7dc9){_0x295496=_0x295496-0xba;const _0x3d833e=a49_0x3d83();let _0x4d2331=_0x3d833e[_0x295496];return _0x4d2331;}(function(_0x13edd6,_0x39d5f3){const _0x30e6b7=a49_0x4d23,_0x48a1e1=_0x13edd6();while(!![]){try{const _0x17fa38=parseInt(_0x30e6b7(0xf5))/0x1+parseInt(_0x30e6b7(0xf0))/0x2*(parseInt(_0x30e6b7(0xed))/0x3)+-parseInt(_0x30e6b7(0xbe))/0x4+-parseInt(_0x30e6b7(0xda))/0x5+parseInt(_0x30e6b7(0xf6))/0x6*(parseInt(_0x30e6b7(0xca))/0x7)+-parseInt(_0x30e6b7(0xd2))/0x8+-parseInt(_0x30e6b7(0xcd))/0x9*(-parseInt(_0x30e6b7(0xd8))/0xa);if(_0x17fa38===_0x39d5f3)break;else _0x48a1e1['push'](_0x48a1e1['shift']());}catch(_0xd4add5){_0x48a1e1['push'](_0x48a1e1['shift']());}}}(a49_0x3d83,0x86348));var __importDefault=this&&this['__importDefault']||function(_0xe1a79){const _0x43b1e6=a49_0x4d23;return _0xe1a79&&_0xe1a79[_0x43b1e6(0xea)]?_0xe1a79:{'default':_0xe1a79};};Object[a49_0x4ff2bc(0xf9)](exports,'__esModule',{'value':!![]}),exports[a49_0x4ff2bc(0xf4)]=void 0x0;const bcryptjs_1=__importDefault(require(a49_0x4ff2bc(0xdf))),jsonwebtoken_1=__importDefault(require('jsonwebtoken')),speakeasy_1=__importDefault(require(a49_0x4ff2bc(0xc6))),database_1=__importDefault(require(a49_0x4ff2bc(0xeb))),config_1=require(a49_0x4ff2bc(0xe1)),captchaService_1=require(a49_0x4ff2bc(0xe7));class AuthService{['generateToken'](_0x52cb5c){const _0x5b9c05=a49_0x4ff2bc;return jsonwebtoken_1[_0x5b9c05(0xdb)][_0x5b9c05(0xc3)](_0x52cb5c,config_1['config'][_0x5b9c05(0xe2)][_0x5b9c05(0xef)],{'expiresIn':String(config_1[_0x5b9c05(0xf7)][_0x5b9c05(0xe2)][_0x5b9c05(0xee)])});}async[a49_0x4ff2bc(0xbd)](_0x2a3d8f){const _0x37852c=a49_0x4ff2bc,{username:_0x3b030d,password:_0x586895,twoFactorToken:_0x4b846b,captchaToken:_0xa315a}=_0x2a3d8f;if(!_0x4b846b||_0x4b846b[_0x37852c(0xc0)]()===''){if(_0xa315a){const _0x5ab599=await captchaService_1[_0x37852c(0xec)][_0x37852c(0xc7)](_0xa315a);if(!_0x5ab599)throw new Error(_0x37852c(0xd4));}else{if(config_1[_0x37852c(0xf7)][_0x37852c(0xd0)]?.[_0x37852c(0xbb)])throw new Error(_0x37852c(0xc8));}}if(_0x3b030d===config_1[_0x37852c(0xf7)][_0x37852c(0xba)][_0x37852c(0xbf)]){const _0x1f8971=await bcryptjs_1['default'][_0x37852c(0xde)](_0x586895,config_1[_0x37852c(0xf7)]['admin'][_0x37852c(0xf3)]);if(_0x1f8971){if(config_1['config'][_0x37852c(0xba)]['twoFactorEnabled']){if(!_0x4b846b)return{'access_token':'','role':_0x37852c(0xba),'requires2FA':!![]};const _0x305a1b=speakeasy_1[_0x37852c(0xdb)][_0x37852c(0xd5)]['verify']({'secret':config_1[_0x37852c(0xf7)][_0x37852c(0xba)][_0x37852c(0xe0)],'encoding':_0x37852c(0xc9),'token':_0x4b846b,'window':0x2});if(!_0x305a1b){let _0x23e084=![];if(config_1[_0x37852c(0xf7)][_0x37852c(0xba)][_0x37852c(0xfb)]){const _0x476c04=JSON[_0x37852c(0xe5)](config_1[_0x37852c(0xf7)][_0x37852c(0xba)][_0x37852c(0xfb)]);for(let _0x148483=0x0;_0x148483<_0x476c04[_0x37852c(0xf1)];_0x148483++){const _0x310486=await bcryptjs_1[_0x37852c(0xdb)][_0x37852c(0xde)](_0x4b846b,_0x476c04[_0x148483]);if(_0x310486){_0x23e084=!![],_0x476c04[_0x37852c(0xe6)](_0x148483,0x1),config_1[_0x37852c(0xf7)]['admin'][_0x37852c(0xfb)]=JSON[_0x37852c(0xc4)](_0x476c04);const _0x357876=require('fs'),_0x23aba5=require(_0x37852c(0xd7)),_0x211ae1=_0x23aba5[_0x37852c(0xd1)](process[_0x37852c(0xf8)](),_0x37852c(0xc2));if(_0x357876[_0x37852c(0xe3)](_0x211ae1)){let _0x24845e=_0x357876[_0x37852c(0xc1)](_0x211ae1,_0x37852c(0xd9));const _0x3a1da4=_0x24845e[_0x37852c(0xcc)]('\x0a');for(let _0x5b244c=0x0;_0x5b244c<_0x3a1da4[_0x37852c(0xf1)];_0x5b244c++){if(_0x3a1da4[_0x5b244c][_0x37852c(0xce)]('ADMIN_BACKUP_CODES=')){_0x3a1da4[_0x5b244c]=_0x37852c(0xe4)+JSON[_0x37852c(0xc4)](_0x476c04);break;}}_0x357876['writeFileSync'](_0x211ae1,_0x3a1da4[_0x37852c(0xd1)]('\x0a'),_0x37852c(0xd9));}break;}}}if(!_0x23e084)throw new Error(_0x37852c(0xcf));}}const _0x59d85f=this['generateToken']({'id':_0x37852c(0xba),'username':config_1[_0x37852c(0xf7)][_0x37852c(0xba)][_0x37852c(0xbf)],'role':_0x37852c(0xba)});return{'access_token':_0x59d85f,'role':_0x37852c(0xba)};}}const _0x154354=await database_1[_0x37852c(0xdb)][_0x37852c(0xe9)][_0x37852c(0xcb)]({'where':{'username':_0x3b030d},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x154354)throw new Error('Invalid\x20credentials');if(_0x154354['status']!==_0x37852c(0xdd))throw new Error('Account\x20is\x20not\x20active');const _0x435162=await bcryptjs_1[_0x37852c(0xdb)][_0x37852c(0xde)](_0x586895,_0x154354[_0x37852c(0xdc)]);if(!_0x435162)throw new Error(_0x37852c(0xd3));if(_0x154354[_0x37852c(0xf2)]){if(!_0x4b846b)return{'access_token':'','role':'shop','requires2FA':!![]};const _0xad7025=speakeasy_1[_0x37852c(0xdb)]['totp']['verify']({'secret':_0x154354['twoFactorSecret'],'encoding':_0x37852c(0xc9),'token':_0x4b846b,'window':0x2});if(!_0xad7025){let _0x23285a=![];if(_0x154354['backupCodes']){const _0x1c1f69=JSON[_0x37852c(0xe5)](_0x154354[_0x37852c(0xfb)]);for(let _0x4fed04=0x0;_0x4fed04<_0x1c1f69[_0x37852c(0xf1)];_0x4fed04++){const _0x57936a=await bcryptjs_1['default'][_0x37852c(0xde)](_0x4b846b,_0x1c1f69[_0x4fed04]);if(_0x57936a){_0x23285a=!![],_0x1c1f69[_0x37852c(0xe6)](_0x4fed04,0x1),await database_1[_0x37852c(0xdb)][_0x37852c(0xe9)][_0x37852c(0xe8)]({'where':{'id':_0x154354['id']},'data':{'backupCodes':JSON[_0x37852c(0xc4)](_0x1c1f69)}});break;}}}if(!_0x23285a)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x3a5b08=this['generateToken']({'id':_0x154354['id'],'username':_0x154354['username'],'role':_0x37852c(0xe9)});return{'access_token':_0x3a5b08,'role':_0x37852c(0xe9),'user':{'id':_0x154354['id'],'name':_0x154354[_0x37852c(0xfa)],'username':_0x154354['username']}};}async[a49_0x4ff2bc(0xbc)](_0x454715){const _0x4871f1=a49_0x4ff2bc;try{const _0x22c8ab=jsonwebtoken_1[_0x4871f1(0xdb)][_0x4871f1(0xd6)](_0x454715,config_1[_0x4871f1(0xf7)][_0x4871f1(0xe2)][_0x4871f1(0xef)]);return _0x22c8ab;}catch(_0x49201b){throw new Error(_0x4871f1(0xc5));}}}function a49_0x3d83(){const _0x2c5f26=['split','9zZLNHC','startsWith','Invalid\x202FA\x20token\x20or\x20backup\x20code','cloudflare','join','2527784TNfPBI','Invalid\x20credentials','Invalid\x20captcha','totp','verify','path','8024320wMxhXR','utf8','5188355KWOxGr','default','password','ACTIVE','compare','bcryptjs','twoFactorSecret','../config/config','jwt','existsSync','ADMIN_BACKUP_CODES=','parse','splice','./captchaService','update','shop','__esModule','../config/database','captchaService','388458VtgrRh','expiresIn','secret','6OycsdU','length','twoFactorEnabled','passwordHash','AuthService','547776JneKiG','21918nJjpEP','config','cwd','defineProperty','name','backupCodes','admin','turnstileSecretKey','verifyToken','login','1518460XIZSqm','username','trim','readFileSync','.env','sign','stringify','Invalid\x20token','speakeasy','verifyCaptcha','Captcha\x20verification\x20required','base32','1043HZogOt','findUnique'];a49_0x3d83=function(){return _0x2c5f26;};return a49_0x3d83();}exports[a49_0x4ff2bc(0xf4)]=AuthService;