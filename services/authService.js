'use strict';function a54_0x5bda(_0x22e17e,_0x7aaa8f){_0x22e17e=_0x22e17e-0x98;const _0x51ebfa=a54_0x51eb();let _0x5bda30=_0x51ebfa[_0x22e17e];return _0x5bda30;}const a54_0x1a03f6=a54_0x5bda;(function(_0x21d98c,_0x4d5d4b){const _0x21f43e=a54_0x5bda,_0x466048=_0x21d98c();while(!![]){try{const _0x12f8a5=-parseInt(_0x21f43e(0xc2))/0x1*(parseInt(_0x21f43e(0xbc))/0x2)+parseInt(_0x21f43e(0xbf))/0x3+-parseInt(_0x21f43e(0xac))/0x4+-parseInt(_0x21f43e(0xa0))/0x5+parseInt(_0x21f43e(0x9e))/0x6+parseInt(_0x21f43e(0xb0))/0x7+parseInt(_0x21f43e(0xbb))/0x8;if(_0x12f8a5===_0x4d5d4b)break;else _0x466048['push'](_0x466048['shift']());}catch(_0x25855c){_0x466048['push'](_0x466048['shift']());}}}(a54_0x51eb,0x88020));function a54_0x51eb(){const _0x2d5c73=['1303170lZeioS','Invalid\x20captcha','Invalid\x20credentials','verifyToken','Invalid\x202FA\x20token\x20or\x20backup\x20code','generateToken','username','path','config','Account\x20is\x20not\x20active','readFileSync','backupCodes','3064812WtTcpS','passwordHash','compare','sign','2245271jfKRGB','totp','shop','cwd','split','length','findUnique','twoFactorEnabled','captchaService','defineProperty','verify','10418776WeiHLN','634034MYgRQu','login','splice','357657uvlUNz','admin','speakeasy','3zvpOMk','./captchaService','secret','utf8','bcryptjs','expiresIn','name','jwt','default','stringify','twoFactorSecret','../config/config','startsWith','AuthService','password','parse','__esModule','../config/database','verifyCaptcha','ADMIN_BACKUP_CODES=','join','Captcha\x20verification\x20required','writeFileSync','4755942czdtOY','cloudflare'];a54_0x51eb=function(){return _0x2d5c73;};return a54_0x51eb();}var __importDefault=this&&this['__importDefault']||function(_0x353cba){const _0x358a82=a54_0x5bda;return _0x353cba&&_0x353cba[_0x358a82(0xd2)]?_0x353cba:{'default':_0x353cba};};Object[a54_0x1a03f6(0xb9)](exports,'__esModule',{'value':!![]}),exports['AuthService']=void 0x0;const bcryptjs_1=__importDefault(require(a54_0x1a03f6(0xc6))),jsonwebtoken_1=__importDefault(require('jsonwebtoken')),speakeasy_1=__importDefault(require(a54_0x1a03f6(0xc1))),database_1=__importDefault(require(a54_0x1a03f6(0x98))),config_1=require(a54_0x1a03f6(0xcd)),captchaService_1=require(a54_0x1a03f6(0xc3));class AuthService{[a54_0x1a03f6(0xa5)](_0x1f8617){const _0x35557a=a54_0x1a03f6;return jsonwebtoken_1[_0x35557a(0xca)][_0x35557a(0xaf)](_0x1f8617,config_1[_0x35557a(0xa8)][_0x35557a(0xc9)][_0x35557a(0xc4)],{'expiresIn':String(config_1[_0x35557a(0xa8)][_0x35557a(0xc9)][_0x35557a(0xc7)])});}async[a54_0x1a03f6(0xbd)](_0x482697){const _0x2d3a5c=a54_0x1a03f6,{username:_0xd6f808,password:_0x22f976,twoFactorToken:_0x4546e5,captchaToken:_0x539ef2}=_0x482697;if(!_0x4546e5||_0x4546e5['trim']()===''){if(_0x539ef2){const _0x165d66=await captchaService_1[_0x2d3a5c(0xb8)][_0x2d3a5c(0x99)](_0x539ef2);if(!_0x165d66)throw new Error(_0x2d3a5c(0xa1));}else{if(config_1[_0x2d3a5c(0xa8)][_0x2d3a5c(0x9f)]?.['turnstileSecretKey'])throw new Error(_0x2d3a5c(0x9c));}}if(_0xd6f808===config_1[_0x2d3a5c(0xa8)][_0x2d3a5c(0xc0)]['username']){const _0x499f3d=await bcryptjs_1['default'][_0x2d3a5c(0xae)](_0x22f976,config_1[_0x2d3a5c(0xa8)]['admin'][_0x2d3a5c(0xad)]);if(_0x499f3d){if(config_1[_0x2d3a5c(0xa8)][_0x2d3a5c(0xc0)][_0x2d3a5c(0xb7)]){if(!_0x4546e5)return{'access_token':'','role':_0x2d3a5c(0xc0),'requires2FA':!![]};const _0x5afc57=speakeasy_1[_0x2d3a5c(0xca)][_0x2d3a5c(0xb1)][_0x2d3a5c(0xba)]({'secret':config_1['config'][_0x2d3a5c(0xc0)][_0x2d3a5c(0xcc)],'encoding':'base32','token':_0x4546e5,'window':0x2});if(!_0x5afc57){let _0x559b95=![];if(config_1[_0x2d3a5c(0xa8)][_0x2d3a5c(0xc0)][_0x2d3a5c(0xab)]){const _0x2e9c5d=JSON[_0x2d3a5c(0xd1)](config_1[_0x2d3a5c(0xa8)][_0x2d3a5c(0xc0)][_0x2d3a5c(0xab)]);for(let _0x3fca0a=0x0;_0x3fca0a<_0x2e9c5d[_0x2d3a5c(0xb5)];_0x3fca0a++){const _0x49fab5=await bcryptjs_1['default'][_0x2d3a5c(0xae)](_0x4546e5,_0x2e9c5d[_0x3fca0a]);if(_0x49fab5){_0x559b95=!![],_0x2e9c5d[_0x2d3a5c(0xbe)](_0x3fca0a,0x1),config_1['config'][_0x2d3a5c(0xc0)]['backupCodes']=JSON[_0x2d3a5c(0xcb)](_0x2e9c5d);const _0x335d6c=require('fs'),_0x2a37b2=require(_0x2d3a5c(0xa7)),_0x121c29=_0x2a37b2['join'](process[_0x2d3a5c(0xb3)](),'.env');if(_0x335d6c['existsSync'](_0x121c29)){let _0x56d82f=_0x335d6c[_0x2d3a5c(0xaa)](_0x121c29,_0x2d3a5c(0xc5));const _0x18fe8a=_0x56d82f[_0x2d3a5c(0xb4)]('\x0a');for(let _0x133b89=0x0;_0x133b89<_0x18fe8a['length'];_0x133b89++){if(_0x18fe8a[_0x133b89][_0x2d3a5c(0xce)](_0x2d3a5c(0x9a))){_0x18fe8a[_0x133b89]='ADMIN_BACKUP_CODES='+JSON[_0x2d3a5c(0xcb)](_0x2e9c5d);break;}}_0x335d6c[_0x2d3a5c(0x9d)](_0x121c29,_0x18fe8a[_0x2d3a5c(0x9b)]('\x0a'),_0x2d3a5c(0xc5));}break;}}}if(!_0x559b95)throw new Error(_0x2d3a5c(0xa4));}}const _0x94de9=this[_0x2d3a5c(0xa5)]({'id':_0x2d3a5c(0xc0),'username':config_1[_0x2d3a5c(0xa8)][_0x2d3a5c(0xc0)][_0x2d3a5c(0xa6)],'role':_0x2d3a5c(0xc0)});return{'access_token':_0x94de9,'role':_0x2d3a5c(0xc0)};}}const _0x555d44=await database_1[_0x2d3a5c(0xca)][_0x2d3a5c(0xb2)][_0x2d3a5c(0xb6)]({'where':{'username':_0xd6f808},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x555d44)throw new Error(_0x2d3a5c(0xa2));if(_0x555d44['status']!=='ACTIVE')throw new Error(_0x2d3a5c(0xa9));const _0x21c8f4=await bcryptjs_1[_0x2d3a5c(0xca)][_0x2d3a5c(0xae)](_0x22f976,_0x555d44[_0x2d3a5c(0xd0)]);if(!_0x21c8f4)throw new Error(_0x2d3a5c(0xa2));await database_1[_0x2d3a5c(0xca)]['shop']['update']({'where':{'id':_0x555d44['id']},'data':{'lastLoginAt':new Date()}});const _0xa0b55=this['generateToken']({'id':_0x555d44['id'],'username':_0x555d44[_0x2d3a5c(0xa6)],'role':_0x2d3a5c(0xb2)});return{'access_token':_0xa0b55,'role':_0x2d3a5c(0xb2),'user':{'id':_0x555d44['id'],'name':_0x555d44[_0x2d3a5c(0xc8)],'username':_0x555d44[_0x2d3a5c(0xa6)]}};}async[a54_0x1a03f6(0xa3)](_0x5e4cdf){const _0x275004=a54_0x1a03f6;try{const _0x1a1cd8=jsonwebtoken_1[_0x275004(0xca)][_0x275004(0xba)](_0x5e4cdf,config_1[_0x275004(0xa8)][_0x275004(0xc9)][_0x275004(0xc4)]);return _0x1a1cd8;}catch(_0x174209){throw new Error('Invalid\x20token');}}}exports[a54_0x1a03f6(0xcf)]=AuthService;