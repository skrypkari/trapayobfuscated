'use strict';const a51_0x1ed270=a51_0x21cf;(function(_0x217725,_0x3f17b9){const _0x4c1ef8=a51_0x21cf,_0x5f26fd=_0x217725();while(!![]){try{const _0x59e5e3=parseInt(_0x4c1ef8(0x18c))/0x1+-parseInt(_0x4c1ef8(0x17e))/0x2*(parseInt(_0x4c1ef8(0x186))/0x3)+-parseInt(_0x4c1ef8(0x187))/0x4*(-parseInt(_0x4c1ef8(0x179))/0x5)+parseInt(_0x4c1ef8(0x168))/0x6*(parseInt(_0x4c1ef8(0x17c))/0x7)+parseInt(_0x4c1ef8(0x173))/0x8+parseInt(_0x4c1ef8(0x190))/0x9*(parseInt(_0x4c1ef8(0x184))/0xa)+-parseInt(_0x4c1ef8(0x180))/0xb;if(_0x59e5e3===_0x3f17b9)break;else _0x5f26fd['push'](_0x5f26fd['shift']());}catch(_0x3cb248){_0x5f26fd['push'](_0x5f26fd['shift']());}}}(a51_0x2ad0,0x522d8));var __importDefault=this&&this[a51_0x1ed270(0x18e)]||function(_0x43cc45){const _0x18307c=a51_0x1ed270;return _0x43cc45&&_0x43cc45[_0x18307c(0x183)]?_0x43cc45:{'default':_0x43cc45};};function a51_0x2ad0(){const _0x439ab1=['Invalid\x20credentials','90685aLhSQa','startsWith','412922nZHjTt','backupCodes','12519485oGArWR','base32','name','__esModule','10udMgAl','jwt','6qSQCUt','2167288ZpRxct','existsSync','totp','status','shop','613298xjOqMI','jsonwebtoken','__importDefault','trim','750033smWDoT','admin','.env','findUnique','../config/config','default','compare','Captcha\x20verification\x20required','../config/database','Invalid\x20captcha','bcryptjs','utf8','passwordHash','path','ADMIN_BACKUP_CODES=','length','./captchaService','sign','stringify','readFileSync','splice','config','verify','speakeasy','294wNiAiA','password','ACTIVE','twoFactorEnabled','Invalid\x20token','login','username','expiresIn','captchaService','cwd','update','115240rUpQAj','cloudflare','join','secret','verifyCaptcha','Account\x20is\x20not\x20active','5jtgMOz','generateToken'];a51_0x2ad0=function(){return _0x439ab1;};return a51_0x2ad0();}function a51_0x21cf(_0x50916c,_0x5781d2){_0x50916c=_0x50916c-0x151;const _0x2ad034=a51_0x2ad0();let _0x21cfb4=_0x2ad034[_0x50916c];return _0x21cfb4;}Object['defineProperty'](exports,a51_0x1ed270(0x183),{'value':!![]}),exports['AuthService']=void 0x0;const bcryptjs_1=__importDefault(require(a51_0x1ed270(0x15a))),jsonwebtoken_1=__importDefault(require(a51_0x1ed270(0x18d))),speakeasy_1=__importDefault(require(a51_0x1ed270(0x167))),database_1=__importDefault(require(a51_0x1ed270(0x158))),config_1=require(a51_0x1ed270(0x154)),captchaService_1=require(a51_0x1ed270(0x160));class AuthService{[a51_0x1ed270(0x17a)](_0x859315){const _0x73f46b=a51_0x1ed270;return jsonwebtoken_1[_0x73f46b(0x155)][_0x73f46b(0x161)](_0x859315,config_1['config'][_0x73f46b(0x185)][_0x73f46b(0x176)],{'expiresIn':String(config_1[_0x73f46b(0x165)][_0x73f46b(0x185)][_0x73f46b(0x16f)])});}async[a51_0x1ed270(0x16d)](_0x2a8669){const _0x193cb4=a51_0x1ed270,{username:_0xb36a9a,password:_0x26ff2f,twoFactorToken:_0xdc40d3,captchaToken:_0x140e74}=_0x2a8669;if(!_0xdc40d3||_0xdc40d3[_0x193cb4(0x18f)]()===''){if(_0x140e74){const _0xaa3a2c=await captchaService_1[_0x193cb4(0x170)][_0x193cb4(0x177)](_0x140e74);if(!_0xaa3a2c)throw new Error(_0x193cb4(0x159));}else{if(config_1[_0x193cb4(0x165)][_0x193cb4(0x174)]?.['turnstileSecretKey'])throw new Error(_0x193cb4(0x157));}}if(_0xb36a9a===config_1[_0x193cb4(0x165)][_0x193cb4(0x151)][_0x193cb4(0x16e)]){const _0x4b9887=await bcryptjs_1[_0x193cb4(0x155)][_0x193cb4(0x156)](_0x26ff2f,config_1[_0x193cb4(0x165)][_0x193cb4(0x151)][_0x193cb4(0x15c)]);if(_0x4b9887){if(config_1[_0x193cb4(0x165)]['admin'][_0x193cb4(0x16b)]){if(!_0xdc40d3)return{'access_token':'','role':_0x193cb4(0x151),'requires2FA':!![]};const _0x5cbfee=speakeasy_1['default'][_0x193cb4(0x189)]['verify']({'secret':config_1[_0x193cb4(0x165)][_0x193cb4(0x151)]['twoFactorSecret'],'encoding':_0x193cb4(0x181),'token':_0xdc40d3,'window':0x2});if(!_0x5cbfee){let _0x14df50=![];if(config_1[_0x193cb4(0x165)][_0x193cb4(0x151)]['backupCodes']){const _0xc9f78d=JSON['parse'](config_1[_0x193cb4(0x165)][_0x193cb4(0x151)][_0x193cb4(0x17f)]);for(let _0x145c54=0x0;_0x145c54<_0xc9f78d[_0x193cb4(0x15f)];_0x145c54++){const _0x53e4e8=await bcryptjs_1[_0x193cb4(0x155)]['compare'](_0xdc40d3,_0xc9f78d[_0x145c54]);if(_0x53e4e8){_0x14df50=!![],_0xc9f78d[_0x193cb4(0x164)](_0x145c54,0x1),config_1[_0x193cb4(0x165)]['admin'][_0x193cb4(0x17f)]=JSON['stringify'](_0xc9f78d);const _0x2c2321=require('fs'),_0xc1d0fb=require(_0x193cb4(0x15d)),_0x1c6928=_0xc1d0fb['join'](process[_0x193cb4(0x171)](),_0x193cb4(0x152));if(_0x2c2321[_0x193cb4(0x188)](_0x1c6928)){let _0x247089=_0x2c2321[_0x193cb4(0x163)](_0x1c6928,_0x193cb4(0x15b));const _0x58cba3=_0x247089['split']('\x0a');for(let _0x5eb790=0x0;_0x5eb790<_0x58cba3[_0x193cb4(0x15f)];_0x5eb790++){if(_0x58cba3[_0x5eb790][_0x193cb4(0x17d)](_0x193cb4(0x15e))){_0x58cba3[_0x5eb790]=_0x193cb4(0x15e)+JSON[_0x193cb4(0x162)](_0xc9f78d);break;}}_0x2c2321['writeFileSync'](_0x1c6928,_0x58cba3[_0x193cb4(0x175)]('\x0a'),_0x193cb4(0x15b));}break;}}}if(!_0x14df50)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x433572=this[_0x193cb4(0x17a)]({'id':_0x193cb4(0x151),'username':config_1[_0x193cb4(0x165)][_0x193cb4(0x151)][_0x193cb4(0x16e)],'role':_0x193cb4(0x151)});return{'access_token':_0x433572,'role':_0x193cb4(0x151)};}}const _0x667644=await database_1[_0x193cb4(0x155)][_0x193cb4(0x18b)][_0x193cb4(0x153)]({'where':{'username':_0xb36a9a},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x667644)throw new Error(_0x193cb4(0x17b));if(_0x667644[_0x193cb4(0x18a)]!==_0x193cb4(0x16a))throw new Error(_0x193cb4(0x178));const _0xa93f2=await bcryptjs_1[_0x193cb4(0x155)]['compare'](_0x26ff2f,_0x667644[_0x193cb4(0x169)]);if(!_0xa93f2)throw new Error('Invalid\x20credentials');await database_1['default'][_0x193cb4(0x18b)][_0x193cb4(0x172)]({'where':{'id':_0x667644['id']},'data':{'lastLoginAt':new Date()}});const _0x2e1e60=this[_0x193cb4(0x17a)]({'id':_0x667644['id'],'username':_0x667644[_0x193cb4(0x16e)],'role':_0x193cb4(0x18b)});return{'access_token':_0x2e1e60,'role':_0x193cb4(0x18b),'user':{'id':_0x667644['id'],'name':_0x667644[_0x193cb4(0x182)],'username':_0x667644[_0x193cb4(0x16e)]}};}async['verifyToken'](_0x9c7eaf){const _0x4849bb=a51_0x1ed270;try{const _0x307b23=jsonwebtoken_1['default'][_0x4849bb(0x166)](_0x9c7eaf,config_1['config'][_0x4849bb(0x185)][_0x4849bb(0x176)]);return _0x307b23;}catch(_0x12a715){throw new Error(_0x4849bb(0x16c));}}}exports['AuthService']=AuthService;