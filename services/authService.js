'use strict';const a54_0x16408d=a54_0x5a50;(function(_0x55e54b,_0x4ca56f){const _0x5d978a=a54_0x5a50,_0x68e1b5=_0x55e54b();while(!![]){try{const _0x5d179d=parseInt(_0x5d978a(0x100))/0x1+parseInt(_0x5d978a(0x10f))/0x2*(-parseInt(_0x5d978a(0x117))/0x3)+parseInt(_0x5d978a(0x119))/0x4+-parseInt(_0x5d978a(0x102))/0x5+-parseInt(_0x5d978a(0x103))/0x6*(-parseInt(_0x5d978a(0x13b))/0x7)+-parseInt(_0x5d978a(0x10a))/0x8+parseInt(_0x5d978a(0x11d))/0x9*(parseInt(_0x5d978a(0x121))/0xa);if(_0x5d179d===_0x4ca56f)break;else _0x68e1b5['push'](_0x68e1b5['shift']());}catch(_0x2467cb){_0x68e1b5['push'](_0x68e1b5['shift']());}}}(a54_0x121b,0xdeb33));var __importDefault=this&&this['__importDefault']||function(_0x1a61b9){const _0x2d5ac5=a54_0x5a50;return _0x1a61b9&&_0x1a61b9[_0x2d5ac5(0x109)]?_0x1a61b9:{'default':_0x1a61b9};};Object[a54_0x16408d(0x128)](exports,a54_0x16408d(0x109),{'value':!![]}),exports[a54_0x16408d(0x124)]=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),jsonwebtoken_1=__importDefault(require(a54_0x16408d(0x106))),speakeasy_1=__importDefault(require(a54_0x16408d(0x132))),database_1=__importDefault(require(a54_0x16408d(0x125))),config_1=require(a54_0x16408d(0x12c)),captchaService_1=require(a54_0x16408d(0x13a));class AuthService{[a54_0x16408d(0x10c)](_0x348a97){const _0x43c65b=a54_0x16408d;return jsonwebtoken_1['default'][_0x43c65b(0x135)](_0x348a97,config_1[_0x43c65b(0x11c)]['jwt']['secret'],{'expiresIn':String(config_1[_0x43c65b(0x11c)][_0x43c65b(0x137)][_0x43c65b(0x112)])});}async[a54_0x16408d(0x11e)](_0x579fbe){const _0x866fad=a54_0x16408d,{username:_0x3bb9c2,password:_0xbad2de,twoFactorToken:_0x123e23,captchaToken:_0x4776a8}=_0x579fbe;if(!_0x123e23||_0x123e23[_0x866fad(0x12e)]()===''){if(_0x4776a8){const _0x4c5504=await captchaService_1[_0x866fad(0x110)][_0x866fad(0x120)](_0x4776a8);if(!_0x4c5504)throw new Error(_0x866fad(0x127));}else{if(config_1['config'][_0x866fad(0x122)]?.[_0x866fad(0x107)])throw new Error(_0x866fad(0x11b));}}if(_0x3bb9c2===config_1['config'][_0x866fad(0x126)][_0x866fad(0x105)]){const _0x1fe13a=await bcryptjs_1[_0x866fad(0x115)][_0x866fad(0x12a)](_0xbad2de,config_1[_0x866fad(0x11c)][_0x866fad(0x126)][_0x866fad(0x12d)]);if(_0x1fe13a){if(config_1[_0x866fad(0x11c)][_0x866fad(0x126)]['twoFactorEnabled']){if(!_0x123e23)return{'access_token':'','role':_0x866fad(0x126),'requires2FA':!![]};const _0x28f2cc=speakeasy_1['default'][_0x866fad(0x131)][_0x866fad(0x129)]({'secret':config_1[_0x866fad(0x11c)][_0x866fad(0x126)][_0x866fad(0x133)],'encoding':_0x866fad(0x10d),'token':_0x123e23,'window':0x2});if(!_0x28f2cc){let _0x766b65=![];if(config_1[_0x866fad(0x11c)][_0x866fad(0x126)]['backupCodes']){const _0x35a981=JSON['parse'](config_1[_0x866fad(0x11c)]['admin'][_0x866fad(0x108)]);for(let _0x4160b5=0x0;_0x4160b5<_0x35a981[_0x866fad(0x11a)];_0x4160b5++){const _0x23f629=await bcryptjs_1['default'][_0x866fad(0x12a)](_0x123e23,_0x35a981[_0x4160b5]);if(_0x23f629){_0x766b65=!![],_0x35a981['splice'](_0x4160b5,0x1),config_1[_0x866fad(0x11c)][_0x866fad(0x126)][_0x866fad(0x108)]=JSON['stringify'](_0x35a981);const _0x55aa2a=require('fs'),_0x3cc0bf=require('path'),_0x42c2b2=_0x3cc0bf[_0x866fad(0x136)](process['cwd'](),_0x866fad(0x118));if(_0x55aa2a[_0x866fad(0x101)](_0x42c2b2)){let _0x2d70a4=_0x55aa2a[_0x866fad(0x111)](_0x42c2b2,_0x866fad(0x116));const _0x3c54a8=_0x2d70a4[_0x866fad(0x130)]('\x0a');for(let _0x23216f=0x0;_0x23216f<_0x3c54a8[_0x866fad(0x11a)];_0x23216f++){if(_0x3c54a8[_0x23216f][_0x866fad(0x10e)]('ADMIN_BACKUP_CODES=')){_0x3c54a8[_0x23216f]='ADMIN_BACKUP_CODES='+JSON[_0x866fad(0x11f)](_0x35a981);break;}}_0x55aa2a['writeFileSync'](_0x42c2b2,_0x3c54a8[_0x866fad(0x136)]('\x0a'),'utf8');}break;}}}if(!_0x766b65)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x3832af=this['generateToken']({'id':'admin','username':config_1[_0x866fad(0x11c)]['admin'][_0x866fad(0x105)],'role':_0x866fad(0x126)});return{'access_token':_0x3832af,'role':_0x866fad(0x126)};}}const _0x29a605=await database_1['default'][_0x866fad(0x10b)][_0x866fad(0x139)]({'where':{'username':_0x3bb9c2},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x29a605)throw new Error('Invalid\x20credentials');if(_0x29a605[_0x866fad(0x104)]!==_0x866fad(0x138))throw new Error('Account\x20is\x20not\x20active');const _0x29e8ac=await bcryptjs_1[_0x866fad(0x115)][_0x866fad(0x12a)](_0xbad2de,_0x29a605[_0x866fad(0x12b)]);if(!_0x29e8ac)throw new Error(_0x866fad(0x113));await database_1[_0x866fad(0x115)][_0x866fad(0x10b)][_0x866fad(0x114)]({'where':{'id':_0x29a605['id']},'data':{'lastLoginAt':new Date()}});const _0x80c8d6=this[_0x866fad(0x10c)]({'id':_0x29a605['id'],'username':_0x29a605[_0x866fad(0x105)],'role':_0x866fad(0x10b)});return{'access_token':_0x80c8d6,'role':'shop','user':{'id':_0x29a605['id'],'name':_0x29a605[_0x866fad(0x134)],'username':_0x29a605[_0x866fad(0x105)]}};}async['verifyToken'](_0x46a445){const _0x3f53aa=a54_0x16408d;try{const _0x2bc0d8=jsonwebtoken_1[_0x3f53aa(0x115)][_0x3f53aa(0x129)](_0x46a445,config_1[_0x3f53aa(0x11c)][_0x3f53aa(0x137)][_0x3f53aa(0x12f)]);return _0x2bc0d8;}catch(_0xaadabc){throw new Error(_0x3f53aa(0x123));}}}function a54_0x5a50(_0x2b71f9,_0x4c1e86){_0x2b71f9=_0x2b71f9-0x100;const _0x121baa=a54_0x121b();let _0x5a5040=_0x121baa[_0x2b71f9];return _0x5a5040;}exports[a54_0x16408d(0x124)]=AuthService;function a54_0x121b(){const _0x4a80a4=['6iZWFRZ','status','username','jsonwebtoken','turnstileSecretKey','backupCodes','__esModule','7646256ksoezZ','shop','generateToken','base32','startsWith','202280rXciSP','captchaService','readFileSync','expiresIn','Invalid\x20credentials','update','default','utf8','12BFgBsn','.env','3002432efqGYz','length','Captcha\x20verification\x20required','config','9oOZUVM','login','stringify','verifyCaptcha','25219780ldNTqA','cloudflare','Invalid\x20token','AuthService','../config/database','admin','Invalid\x20captcha','defineProperty','verify','compare','password','../config/config','passwordHash','trim','secret','split','totp','speakeasy','twoFactorSecret','name','sign','join','jwt','ACTIVE','findUnique','./captchaService','2807315AlfGqI','61817ZsxMfC','existsSync','7314635hglwAR'];a54_0x121b=function(){return _0x4a80a4;};return a54_0x121b();}