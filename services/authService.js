'use strict';const a54_0x309223=a54_0x51d5;(function(_0x2d18b4,_0x2e20e6){const _0x2298ea=a54_0x51d5,_0x5ca1d3=_0x2d18b4();while(!![]){try{const _0x47c0b7=-parseInt(_0x2298ea(0x1cb))/0x1+-parseInt(_0x2298ea(0x1c8))/0x2+parseInt(_0x2298ea(0x1e7))/0x3*(parseInt(_0x2298ea(0x1d1))/0x4)+-parseInt(_0x2298ea(0x1d2))/0x5*(parseInt(_0x2298ea(0x1ca))/0x6)+-parseInt(_0x2298ea(0x1e2))/0x7+parseInt(_0x2298ea(0x1d5))/0x8*(parseInt(_0x2298ea(0x1dc))/0x9)+parseInt(_0x2298ea(0x1d8))/0xa;if(_0x47c0b7===_0x2e20e6)break;else _0x5ca1d3['push'](_0x5ca1d3['shift']());}catch(_0x124853){_0x5ca1d3['push'](_0x5ca1d3['shift']());}}}(a54_0x12e3,0x3d6f2));function a54_0x51d5(_0x34e152,_0x54d05b){_0x34e152=_0x34e152-0x1b8;const _0x12e33c=a54_0x12e3();let _0x51d5b0=_0x12e33c[_0x34e152];return _0x51d5b0;}var __importDefault=this&&this[a54_0x309223(0x1be)]||function(_0x3d9aa1){const _0xc2abe6=a54_0x309223;return _0x3d9aa1&&_0x3d9aa1[_0xc2abe6(0x1c0)]?_0x3d9aa1:{'default':_0x3d9aa1};};Object['defineProperty'](exports,a54_0x309223(0x1c0),{'value':!![]}),exports[a54_0x309223(0x1db)]=void 0x0;function a54_0x12e3(){const _0x2732be=['name','shop','AuthService','3208617MhEoLJ','generateToken','twoFactorSecret','./captchaService','jwt','readFileSync','2957486RPkjdP','compare','Invalid\x202FA\x20token\x20or\x20backup\x20code','captchaService','../config/config','21XSVkIW','existsSync','join','trim','utf8','splice','update','Invalid\x20captcha','parse','split','username','default','Invalid\x20credentials','passwordHash','bcryptjs','cwd','status','../config/database','__importDefault','ADMIN_BACKUP_CODES=','__esModule','verifyCaptcha','ACTIVE','turnstileSecretKey','config','sign','admin','password','563360ShDVEN','length','4494rHNssc','332223ZCyaqL','path','stringify','secret','cloudflare','.env','149036wnJsbm','1655IcGmFD','backupCodes','Captcha\x20verification\x20required','8iDJuFe','verify','verifyToken','9186280Zcowpw'];a54_0x12e3=function(){return _0x2732be;};return a54_0x12e3();}const bcryptjs_1=__importDefault(require(a54_0x309223(0x1ba))),jsonwebtoken_1=__importDefault(require('jsonwebtoken')),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require(a54_0x309223(0x1bd))),config_1=require(a54_0x309223(0x1e6)),captchaService_1=require(a54_0x309223(0x1df));class AuthService{[a54_0x309223(0x1dd)](_0x23955e){const _0x6943b3=a54_0x309223;return jsonwebtoken_1[_0x6943b3(0x1f2)][_0x6943b3(0x1c5)](_0x23955e,config_1[_0x6943b3(0x1c4)][_0x6943b3(0x1e0)][_0x6943b3(0x1ce)],{'expiresIn':String(config_1['config']['jwt']['expiresIn'])});}async['login'](_0x50cb9b){const _0x248b21=a54_0x309223,{username:_0x3d7558,password:_0x1caf78,twoFactorToken:_0x358b29,captchaToken:_0x526df2}=_0x50cb9b;if(!_0x358b29||_0x358b29[_0x248b21(0x1ea)]()===''){if(_0x526df2){const _0x5076=await captchaService_1[_0x248b21(0x1e5)][_0x248b21(0x1c1)](_0x526df2);if(!_0x5076)throw new Error(_0x248b21(0x1ee));}else{if(config_1['config'][_0x248b21(0x1cf)]?.[_0x248b21(0x1c3)])throw new Error(_0x248b21(0x1d4));}}if(_0x3d7558===config_1[_0x248b21(0x1c4)][_0x248b21(0x1c6)]['username']){const _0x354c0a=await bcryptjs_1[_0x248b21(0x1f2)][_0x248b21(0x1e3)](_0x1caf78,config_1[_0x248b21(0x1c4)][_0x248b21(0x1c6)][_0x248b21(0x1b9)]);if(_0x354c0a){if(config_1[_0x248b21(0x1c4)][_0x248b21(0x1c6)]['twoFactorEnabled']){if(!_0x358b29)return{'access_token':'','role':_0x248b21(0x1c6),'requires2FA':!![]};const _0x13f2c4=speakeasy_1['default']['totp'][_0x248b21(0x1d6)]({'secret':config_1[_0x248b21(0x1c4)][_0x248b21(0x1c6)][_0x248b21(0x1de)],'encoding':'base32','token':_0x358b29,'window':0x2});if(!_0x13f2c4){let _0xdb671e=![];if(config_1[_0x248b21(0x1c4)][_0x248b21(0x1c6)][_0x248b21(0x1d3)]){const _0x259334=JSON[_0x248b21(0x1ef)](config_1[_0x248b21(0x1c4)]['admin']['backupCodes']);for(let _0x2e827c=0x0;_0x2e827c<_0x259334[_0x248b21(0x1c9)];_0x2e827c++){const _0x5625e4=await bcryptjs_1[_0x248b21(0x1f2)][_0x248b21(0x1e3)](_0x358b29,_0x259334[_0x2e827c]);if(_0x5625e4){_0xdb671e=!![],_0x259334[_0x248b21(0x1ec)](_0x2e827c,0x1),config_1[_0x248b21(0x1c4)][_0x248b21(0x1c6)][_0x248b21(0x1d3)]=JSON[_0x248b21(0x1cd)](_0x259334);const _0x456d11=require('fs'),_0x2f2a5d=require(_0x248b21(0x1cc)),_0x5d46e9=_0x2f2a5d['join'](process[_0x248b21(0x1bb)](),_0x248b21(0x1d0));if(_0x456d11[_0x248b21(0x1e8)](_0x5d46e9)){let _0x106dfd=_0x456d11[_0x248b21(0x1e1)](_0x5d46e9,_0x248b21(0x1eb));const _0x1489f1=_0x106dfd[_0x248b21(0x1f0)]('\x0a');for(let _0x51bc8b=0x0;_0x51bc8b<_0x1489f1['length'];_0x51bc8b++){if(_0x1489f1[_0x51bc8b]['startsWith']('ADMIN_BACKUP_CODES=')){_0x1489f1[_0x51bc8b]=_0x248b21(0x1bf)+JSON[_0x248b21(0x1cd)](_0x259334);break;}}_0x456d11['writeFileSync'](_0x5d46e9,_0x1489f1[_0x248b21(0x1e9)]('\x0a'),'utf8');}break;}}}if(!_0xdb671e)throw new Error(_0x248b21(0x1e4));}}const _0x44720=this[_0x248b21(0x1dd)]({'id':_0x248b21(0x1c6),'username':config_1[_0x248b21(0x1c4)][_0x248b21(0x1c6)][_0x248b21(0x1f1)],'role':_0x248b21(0x1c6)});return{'access_token':_0x44720,'role':_0x248b21(0x1c6)};}}const _0x3a0d26=await database_1[_0x248b21(0x1f2)][_0x248b21(0x1da)]['findUnique']({'where':{'username':_0x3d7558},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x3a0d26)throw new Error(_0x248b21(0x1b8));if(_0x3a0d26[_0x248b21(0x1bc)]!==_0x248b21(0x1c2))throw new Error('Account\x20is\x20not\x20active');const _0x342cae=await bcryptjs_1[_0x248b21(0x1f2)]['compare'](_0x1caf78,_0x3a0d26[_0x248b21(0x1c7)]);if(!_0x342cae)throw new Error(_0x248b21(0x1b8));await database_1[_0x248b21(0x1f2)][_0x248b21(0x1da)][_0x248b21(0x1ed)]({'where':{'id':_0x3a0d26['id']},'data':{'lastLoginAt':new Date()}});const _0x385edf=this[_0x248b21(0x1dd)]({'id':_0x3a0d26['id'],'username':_0x3a0d26['username'],'role':_0x248b21(0x1da)});return{'access_token':_0x385edf,'role':'shop','user':{'id':_0x3a0d26['id'],'name':_0x3a0d26[_0x248b21(0x1d9)],'username':_0x3a0d26[_0x248b21(0x1f1)]}};}async[a54_0x309223(0x1d7)](_0x161004){const _0x30b5bc=a54_0x309223;try{const _0x304ce3=jsonwebtoken_1[_0x30b5bc(0x1f2)]['verify'](_0x161004,config_1[_0x30b5bc(0x1c4)][_0x30b5bc(0x1e0)][_0x30b5bc(0x1ce)]);return _0x304ce3;}catch(_0x234101){throw new Error('Invalid\x20token');}}}exports[a54_0x309223(0x1db)]=AuthService;