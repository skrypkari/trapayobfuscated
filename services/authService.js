'use strict';const a49_0xbee38d=a49_0x5876;(function(_0x4fc17c,_0x12b405){const _0x30ce72=a49_0x5876,_0x5f55ef=_0x4fc17c();while(!![]){try{const _0x597bae=parseInt(_0x30ce72(0x146))/0x1+parseInt(_0x30ce72(0x167))/0x2+parseInt(_0x30ce72(0x154))/0x3*(-parseInt(_0x30ce72(0x151))/0x4)+parseInt(_0x30ce72(0x166))/0x5*(parseInt(_0x30ce72(0x13c))/0x6)+-parseInt(_0x30ce72(0x16c))/0x7*(parseInt(_0x30ce72(0x165))/0x8)+-parseInt(_0x30ce72(0x16b))/0x9*(-parseInt(_0x30ce72(0x15b))/0xa)+-parseInt(_0x30ce72(0x142))/0xb;if(_0x597bae===_0x12b405)break;else _0x5f55ef['push'](_0x5f55ef['shift']());}catch(_0x59346d){_0x5f55ef['push'](_0x5f55ef['shift']());}}}(a49_0x5033,0x41e6a));function a49_0x5033(){const _0x241304=['220EzdJKI','generateToken','stringify','cloudflare','twoFactorEnabled','shop','secret','default','backupCodes','captchaService','24TGpIeD','114020NwbHQZ','707138pirIVt','expiresIn','existsSync','Account\x20is\x20not\x20active','23022nBgCcg','1125789RutAcW','length','config','readFileSync','Invalid\x20credentials','username','Invalid\x20captcha','./captchaService','verifyCaptcha','utf8','admin','name','120YAzIvK','passwordHash','jwt','verifyToken','compare','cwd','560835qsBpKp','speakeasy','AuthService','findUnique','58320FxKDeC','jsonwebtoken','__importDefault','defineProperty','Invalid\x20token','startsWith','__esModule','totp','verify','ADMIN_BACKUP_CODES=','sign','161132WfsigS','login','base32','9ZcuXOQ','../config/database','join','path','password','Captcha\x20verification\x20required','Invalid\x202FA\x20token\x20or\x20backup\x20code'];a49_0x5033=function(){return _0x241304;};return a49_0x5033();}var __importDefault=this&&this[a49_0xbee38d(0x148)]||function(_0x14a9fa){const _0x223a54=a49_0xbee38d;return _0x14a9fa&&_0x14a9fa[_0x223a54(0x14c)]?_0x14a9fa:{'default':_0x14a9fa};};function a49_0x5876(_0x45809a,_0x123152){_0x45809a=_0x45809a-0x135;const _0x503359=a49_0x5033();let _0x5876af=_0x503359[_0x45809a];return _0x5876af;}Object[a49_0xbee38d(0x149)](exports,a49_0xbee38d(0x14c),{'value':!![]}),exports[a49_0xbee38d(0x144)]=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),jsonwebtoken_1=__importDefault(require(a49_0xbee38d(0x147))),speakeasy_1=__importDefault(require(a49_0xbee38d(0x143))),database_1=__importDefault(require(a49_0xbee38d(0x155))),config_1=require('../config/config'),captchaService_1=require(a49_0xbee38d(0x137));class AuthService{['generateToken'](_0x47c2c4){const _0x48c1b4=a49_0xbee38d;return jsonwebtoken_1[_0x48c1b4(0x162)][_0x48c1b4(0x150)](_0x47c2c4,config_1['config'][_0x48c1b4(0x13e)][_0x48c1b4(0x161)],{'expiresIn':String(config_1[_0x48c1b4(0x16e)]['jwt'][_0x48c1b4(0x168)])});}async[a49_0xbee38d(0x152)](_0x1e8ada){const _0x21598a=a49_0xbee38d,{username:_0x2ce526,password:_0x3e9a9e,twoFactorToken:_0x4f844b,captchaToken:_0x515611}=_0x1e8ada;if(!_0x4f844b||_0x4f844b['trim']()===''){if(_0x515611){const _0x48b046=await captchaService_1[_0x21598a(0x164)][_0x21598a(0x138)](_0x515611);if(!_0x48b046)throw new Error(_0x21598a(0x136));}else{if(config_1['config'][_0x21598a(0x15e)]?.['turnstileSecretKey'])throw new Error(_0x21598a(0x159));}}if(_0x2ce526===config_1[_0x21598a(0x16e)][_0x21598a(0x13a)][_0x21598a(0x135)]){const _0x24e33d=await bcryptjs_1[_0x21598a(0x162)][_0x21598a(0x140)](_0x3e9a9e,config_1['config'][_0x21598a(0x13a)][_0x21598a(0x13d)]);if(_0x24e33d){if(config_1['config']['admin'][_0x21598a(0x15f)]){if(!_0x4f844b)return{'access_token':'','role':'admin','requires2FA':!![]};const _0x4b14b6=speakeasy_1[_0x21598a(0x162)][_0x21598a(0x14d)][_0x21598a(0x14e)]({'secret':config_1['config'][_0x21598a(0x13a)]['twoFactorSecret'],'encoding':_0x21598a(0x153),'token':_0x4f844b,'window':0x2});if(!_0x4b14b6){let _0x45cd38=![];if(config_1['config'][_0x21598a(0x13a)][_0x21598a(0x163)]){const _0x327de1=JSON['parse'](config_1[_0x21598a(0x16e)][_0x21598a(0x13a)]['backupCodes']);for(let _0x48ecde=0x0;_0x48ecde<_0x327de1[_0x21598a(0x16d)];_0x48ecde++){const _0x3315b4=await bcryptjs_1[_0x21598a(0x162)][_0x21598a(0x140)](_0x4f844b,_0x327de1[_0x48ecde]);if(_0x3315b4){_0x45cd38=!![],_0x327de1['splice'](_0x48ecde,0x1),config_1[_0x21598a(0x16e)][_0x21598a(0x13a)][_0x21598a(0x163)]=JSON[_0x21598a(0x15d)](_0x327de1);const _0x30fe60=require('fs'),_0x274f00=require(_0x21598a(0x157)),_0x35e45a=_0x274f00['join'](process[_0x21598a(0x141)](),'.env');if(_0x30fe60[_0x21598a(0x169)](_0x35e45a)){let _0x365d51=_0x30fe60[_0x21598a(0x16f)](_0x35e45a,_0x21598a(0x139));const _0x38f7f8=_0x365d51['split']('\x0a');for(let _0x15aff4=0x0;_0x15aff4<_0x38f7f8[_0x21598a(0x16d)];_0x15aff4++){if(_0x38f7f8[_0x15aff4][_0x21598a(0x14b)](_0x21598a(0x14f))){_0x38f7f8[_0x15aff4]=_0x21598a(0x14f)+JSON[_0x21598a(0x15d)](_0x327de1);break;}}_0x30fe60['writeFileSync'](_0x35e45a,_0x38f7f8[_0x21598a(0x156)]('\x0a'),_0x21598a(0x139));}break;}}}if(!_0x45cd38)throw new Error(_0x21598a(0x15a));}}const _0x2ca518=this['generateToken']({'id':_0x21598a(0x13a),'username':config_1[_0x21598a(0x16e)][_0x21598a(0x13a)][_0x21598a(0x135)],'role':_0x21598a(0x13a)});return{'access_token':_0x2ca518,'role':_0x21598a(0x13a)};}}const _0x3aa1aa=await database_1[_0x21598a(0x162)][_0x21598a(0x160)][_0x21598a(0x145)]({'where':{'username':_0x2ce526},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x3aa1aa)throw new Error('Invalid\x20credentials');if(_0x3aa1aa['status']!=='ACTIVE')throw new Error(_0x21598a(0x16a));const _0x37492c=await bcryptjs_1['default'][_0x21598a(0x140)](_0x3e9a9e,_0x3aa1aa[_0x21598a(0x158)]);if(!_0x37492c)throw new Error(_0x21598a(0x170));const _0x48a3a6=this[_0x21598a(0x15c)]({'id':_0x3aa1aa['id'],'username':_0x3aa1aa[_0x21598a(0x135)],'role':_0x21598a(0x160)});return{'access_token':_0x48a3a6,'role':_0x21598a(0x160),'user':{'id':_0x3aa1aa['id'],'name':_0x3aa1aa[_0x21598a(0x13b)],'username':_0x3aa1aa[_0x21598a(0x135)]}};}async[a49_0xbee38d(0x13f)](_0xfbf3b0){const _0x1b01e8=a49_0xbee38d;try{const _0x16289f=jsonwebtoken_1[_0x1b01e8(0x162)][_0x1b01e8(0x14e)](_0xfbf3b0,config_1[_0x1b01e8(0x16e)][_0x1b01e8(0x13e)]['secret']);return _0x16289f;}catch(_0x3c061b){throw new Error(_0x1b01e8(0x14a));}}}exports['AuthService']=AuthService;