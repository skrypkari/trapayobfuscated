'use strict';function a54_0x2a39(){const _0x5ef273=['admin','parse','twoFactorSecret','2912294ZuWmVq','join','generateToken','username','951owrXrE','utf8','2286552NwXGVe','captchaService','42jEjLRM','7vvlwxw','status','cwd','bcryptjs','Account\x20is\x20not\x20active','backupCodes','verifyToken','expiresIn','findUnique','config','__importDefault','password','trim','split','1226152rqjLPj','update','twoFactorEnabled','writeFileSync','27AVzEOh','__esModule','3191775VaXerd','defineProperty','totp','default','.env','cloudflare','length','AuthService','passwordHash','compare','verify','Invalid\x20credentials','Invalid\x202FA\x20token\x20or\x20backup\x20code','26075kZZIdO','existsSync','name','login','splice','startsWith','turnstileSecretKey','speakeasy','shop','../config/config','1412900zaKpWt','6RQSkPE','../config/database','path','ACTIVE','verifyCaptcha','ADMIN_BACKUP_CODES=','stringify','./captchaService','readFileSync','3972EhJyyd'];a54_0x2a39=function(){return _0x5ef273;};return a54_0x2a39();}function a54_0x3958(_0x38b723,_0x3ca6ca){_0x38b723=_0x38b723-0x1bc;const _0x2a397c=a54_0x2a39();let _0x39586a=_0x2a397c[_0x38b723];return _0x39586a;}const a54_0x43204c=a54_0x3958;(function(_0x5931c3,_0x911e1c){const _0x535714=a54_0x3958,_0x4fb588=_0x5931c3();while(!![]){try{const _0x21fb13=-parseInt(_0x535714(0x1ee))/0x1*(-parseInt(_0x535714(0x1cc))/0x2)+parseInt(_0x535714(0x1c8))/0x3*(-parseInt(_0x535714(0x1c0))/0x4)+-parseInt(_0x535714(0x1e1))/0x5*(-parseInt(_0x535714(0x1f9))/0x6)+parseInt(_0x535714(0x1cd))/0x7*(-parseInt(_0x535714(0x1db))/0x8)+parseInt(_0x535714(0x1df))/0x9*(-parseInt(_0x535714(0x1f8))/0xa)+parseInt(_0x535714(0x1c4))/0xb+-parseInt(_0x535714(0x1ca))/0xc;if(_0x21fb13===_0x911e1c)break;else _0x4fb588['push'](_0x4fb588['shift']());}catch(_0x511985){_0x4fb588['push'](_0x4fb588['shift']());}}}(a54_0x2a39,0x59e5a));var __importDefault=this&&this[a54_0x43204c(0x1d7)]||function(_0xd949d6){const _0x1d7575=a54_0x43204c;return _0xd949d6&&_0xd949d6[_0x1d7575(0x1e0)]?_0xd949d6:{'default':_0xd949d6};};Object[a54_0x43204c(0x1e2)](exports,a54_0x43204c(0x1e0),{'value':!![]}),exports[a54_0x43204c(0x1e8)]=void 0x0;const bcryptjs_1=__importDefault(require(a54_0x43204c(0x1d0))),jsonwebtoken_1=__importDefault(require('jsonwebtoken')),speakeasy_1=__importDefault(require(a54_0x43204c(0x1f5))),database_1=__importDefault(require(a54_0x43204c(0x1fa))),config_1=require(a54_0x43204c(0x1f7)),captchaService_1=require(a54_0x43204c(0x1be));class AuthService{[a54_0x43204c(0x1c6)](_0x50c038){const _0x5a763f=a54_0x43204c;return jsonwebtoken_1[_0x5a763f(0x1e4)]['sign'](_0x50c038,config_1['config']['jwt']['secret'],{'expiresIn':String(config_1[_0x5a763f(0x1d6)]['jwt'][_0x5a763f(0x1d4)])});}async[a54_0x43204c(0x1f1)](_0xa5e0db){const _0x7f71ce=a54_0x43204c,{username:_0x1742c8,password:_0x9ecffc,twoFactorToken:_0x4a00b6,captchaToken:_0x5d468f}=_0xa5e0db;if(!_0x4a00b6||_0x4a00b6[_0x7f71ce(0x1d9)]()===''){if(_0x5d468f){const _0x5db98f=await captchaService_1[_0x7f71ce(0x1cb)][_0x7f71ce(0x1fd)](_0x5d468f);if(!_0x5db98f)throw new Error('Invalid\x20captcha');}else{if(config_1[_0x7f71ce(0x1d6)][_0x7f71ce(0x1e6)]?.[_0x7f71ce(0x1f4)])throw new Error('Captcha\x20verification\x20required');}}if(_0x1742c8===config_1[_0x7f71ce(0x1d6)][_0x7f71ce(0x1c1)][_0x7f71ce(0x1c7)]){const _0x286327=await bcryptjs_1['default']['compare'](_0x9ecffc,config_1['config'][_0x7f71ce(0x1c1)][_0x7f71ce(0x1e9)]);if(_0x286327){if(config_1[_0x7f71ce(0x1d6)][_0x7f71ce(0x1c1)][_0x7f71ce(0x1dd)]){if(!_0x4a00b6)return{'access_token':'','role':_0x7f71ce(0x1c1),'requires2FA':!![]};const _0x4d18af=speakeasy_1[_0x7f71ce(0x1e4)][_0x7f71ce(0x1e3)][_0x7f71ce(0x1eb)]({'secret':config_1[_0x7f71ce(0x1d6)][_0x7f71ce(0x1c1)][_0x7f71ce(0x1c3)],'encoding':'base32','token':_0x4a00b6,'window':0x2});if(!_0x4d18af){let _0x5dd4cf=![];if(config_1[_0x7f71ce(0x1d6)][_0x7f71ce(0x1c1)][_0x7f71ce(0x1d2)]){const _0x53f30b=JSON[_0x7f71ce(0x1c2)](config_1['config'][_0x7f71ce(0x1c1)][_0x7f71ce(0x1d2)]);for(let _0x4f1dcc=0x0;_0x4f1dcc<_0x53f30b['length'];_0x4f1dcc++){const _0x577e09=await bcryptjs_1[_0x7f71ce(0x1e4)]['compare'](_0x4a00b6,_0x53f30b[_0x4f1dcc]);if(_0x577e09){_0x5dd4cf=!![],_0x53f30b[_0x7f71ce(0x1f2)](_0x4f1dcc,0x1),config_1[_0x7f71ce(0x1d6)]['admin'][_0x7f71ce(0x1d2)]=JSON['stringify'](_0x53f30b);const _0x32aeb5=require('fs'),_0x22657f=require(_0x7f71ce(0x1fb)),_0x550917=_0x22657f[_0x7f71ce(0x1c5)](process[_0x7f71ce(0x1cf)](),_0x7f71ce(0x1e5));if(_0x32aeb5[_0x7f71ce(0x1ef)](_0x550917)){let _0x768e02=_0x32aeb5[_0x7f71ce(0x1bf)](_0x550917,_0x7f71ce(0x1c9));const _0x4942b2=_0x768e02[_0x7f71ce(0x1da)]('\x0a');for(let _0x41deb7=0x0;_0x41deb7<_0x4942b2[_0x7f71ce(0x1e7)];_0x41deb7++){if(_0x4942b2[_0x41deb7][_0x7f71ce(0x1f3)](_0x7f71ce(0x1bc))){_0x4942b2[_0x41deb7]='ADMIN_BACKUP_CODES='+JSON[_0x7f71ce(0x1bd)](_0x53f30b);break;}}_0x32aeb5[_0x7f71ce(0x1de)](_0x550917,_0x4942b2[_0x7f71ce(0x1c5)]('\x0a'),'utf8');}break;}}}if(!_0x5dd4cf)throw new Error(_0x7f71ce(0x1ed));}}const _0x24174a=this['generateToken']({'id':_0x7f71ce(0x1c1),'username':config_1['config'][_0x7f71ce(0x1c1)][_0x7f71ce(0x1c7)],'role':_0x7f71ce(0x1c1)});return{'access_token':_0x24174a,'role':'admin'};}}const _0x5ba079=await database_1['default'][_0x7f71ce(0x1f6)][_0x7f71ce(0x1d5)]({'where':{'username':_0x1742c8},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x5ba079)throw new Error(_0x7f71ce(0x1ec));if(_0x5ba079[_0x7f71ce(0x1ce)]!==_0x7f71ce(0x1fc))throw new Error(_0x7f71ce(0x1d1));const _0x192428=await bcryptjs_1['default'][_0x7f71ce(0x1ea)](_0x9ecffc,_0x5ba079[_0x7f71ce(0x1d8)]);if(!_0x192428)throw new Error(_0x7f71ce(0x1ec));await database_1[_0x7f71ce(0x1e4)][_0x7f71ce(0x1f6)][_0x7f71ce(0x1dc)]({'where':{'id':_0x5ba079['id']},'data':{'lastLoginAt':new Date()}});const _0x4f7b3e=this['generateToken']({'id':_0x5ba079['id'],'username':_0x5ba079[_0x7f71ce(0x1c7)],'role':'shop'});return{'access_token':_0x4f7b3e,'role':_0x7f71ce(0x1f6),'user':{'id':_0x5ba079['id'],'name':_0x5ba079[_0x7f71ce(0x1f0)],'username':_0x5ba079['username']}};}async[a54_0x43204c(0x1d3)](_0x262995){const _0xcafc41=a54_0x43204c;try{const _0x38edbf=jsonwebtoken_1['default']['verify'](_0x262995,config_1[_0xcafc41(0x1d6)]['jwt']['secret']);return _0x38edbf;}catch(_0x2b25b3){throw new Error('Invalid\x20token');}}}exports[a54_0x43204c(0x1e8)]=AuthService;