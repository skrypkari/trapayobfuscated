'use strict';const a54_0x2d07c2=a54_0x3961;(function(_0x51d0c8,_0x23adc5){const _0x875155=a54_0x3961,_0x3e4509=_0x51d0c8();while(!![]){try{const _0x9c9f0b=parseInt(_0x875155(0x16c))/0x1+parseInt(_0x875155(0x171))/0x2*(parseInt(_0x875155(0x164))/0x3)+parseInt(_0x875155(0x18a))/0x4*(parseInt(_0x875155(0x163))/0x5)+-parseInt(_0x875155(0x17f))/0x6*(-parseInt(_0x875155(0x158))/0x7)+-parseInt(_0x875155(0x176))/0x8+-parseInt(_0x875155(0x167))/0x9*(parseInt(_0x875155(0x17e))/0xa)+-parseInt(_0x875155(0x169))/0xb*(-parseInt(_0x875155(0x15c))/0xc);if(_0x9c9f0b===_0x23adc5)break;else _0x3e4509['push'](_0x3e4509['shift']());}catch(_0x488b80){_0x3e4509['push'](_0x3e4509['shift']());}}}(a54_0x1aa0,0xdb2ec));function a54_0x1aa0(){const _0x35712a=['../config/database','Invalid\x20credentials','status','863886augprM','ACTIVE','path','length','stringify','13905800tkklUc','passwordHash','verify','__esModule','parse','backupCodes','cloudflare','verifyCaptcha','790GBolnB','25158uDxuuT','./captchaService','shop','twoFactorSecret','sign','bcryptjs','twoFactorEnabled','../config/config','utf8','jwt','base32','4ctTyQs','password','startsWith','Invalid\x202FA\x20token\x20or\x20backup\x20code','join','Invalid\x20captcha','speakeasy','findUnique','AuthService','ADMIN_BACKUP_CODES=','expiresIn','totp','.env','2170RWiAFv','admin','compare','cwd','12jcgsCS','secret','name','default','verifyToken','generateToken','username','1766255kWWVbW','9KKcMKY','update','existsSync','179082LXEYXo','__importDefault','2428811XdRBZa','readFileSync','defineProperty','1038228kHwprJ','config'];a54_0x1aa0=function(){return _0x35712a;};return a54_0x1aa0();}var __importDefault=this&&this[a54_0x2d07c2(0x168)]||function(_0x4ff7f4){const _0x30bb54=a54_0x2d07c2;return _0x4ff7f4&&_0x4ff7f4[_0x30bb54(0x179)]?_0x4ff7f4:{'default':_0x4ff7f4};};Object[a54_0x2d07c2(0x16b)](exports,a54_0x2d07c2(0x179),{'value':!![]}),exports[a54_0x2d07c2(0x192)]=void 0x0;function a54_0x3961(_0x57ed8e,_0x573fdb){_0x57ed8e=_0x57ed8e-0x157;const _0x1aa021=a54_0x1aa0();let _0x3961ec=_0x1aa021[_0x57ed8e];return _0x3961ec;}const bcryptjs_1=__importDefault(require(a54_0x2d07c2(0x184))),jsonwebtoken_1=__importDefault(require('jsonwebtoken')),speakeasy_1=__importDefault(require(a54_0x2d07c2(0x190))),database_1=__importDefault(require(a54_0x2d07c2(0x16e))),config_1=require(a54_0x2d07c2(0x186)),captchaService_1=require(a54_0x2d07c2(0x180));class AuthService{['generateToken'](_0x367e34){const _0x2584ac=a54_0x2d07c2;return jsonwebtoken_1['default'][_0x2584ac(0x183)](_0x367e34,config_1[_0x2584ac(0x16d)][_0x2584ac(0x188)]['secret'],{'expiresIn':String(config_1['config'][_0x2584ac(0x188)][_0x2584ac(0x194)])});}async['login'](_0x4287ba){const _0x25e217=a54_0x2d07c2,{username:_0x2fc40a,password:_0x24f855,twoFactorToken:_0x208369,captchaToken:_0x471895}=_0x4287ba;if(!_0x208369||_0x208369['trim']()===''){if(_0x471895){const _0x575677=await captchaService_1['captchaService'][_0x25e217(0x17d)](_0x471895);if(!_0x575677)throw new Error(_0x25e217(0x18f));}else{if(config_1[_0x25e217(0x16d)][_0x25e217(0x17c)]?.['turnstileSecretKey'])throw new Error('Captcha\x20verification\x20required');}}if(_0x2fc40a===config_1['config'][_0x25e217(0x159)][_0x25e217(0x162)]){const _0x455215=await bcryptjs_1[_0x25e217(0x15f)][_0x25e217(0x15a)](_0x24f855,config_1[_0x25e217(0x16d)]['admin'][_0x25e217(0x177)]);if(_0x455215){if(config_1['config'][_0x25e217(0x159)][_0x25e217(0x185)]){if(!_0x208369)return{'access_token':'','role':'admin','requires2FA':!![]};const _0x4accc0=speakeasy_1[_0x25e217(0x15f)][_0x25e217(0x195)][_0x25e217(0x178)]({'secret':config_1[_0x25e217(0x16d)][_0x25e217(0x159)][_0x25e217(0x182)],'encoding':_0x25e217(0x189),'token':_0x208369,'window':0x2});if(!_0x4accc0){let _0x460962=![];if(config_1[_0x25e217(0x16d)][_0x25e217(0x159)][_0x25e217(0x17b)]){const _0x5476e3=JSON[_0x25e217(0x17a)](config_1[_0x25e217(0x16d)][_0x25e217(0x159)][_0x25e217(0x17b)]);for(let _0x5ea8a0=0x0;_0x5ea8a0<_0x5476e3[_0x25e217(0x174)];_0x5ea8a0++){const _0x3acd4f=await bcryptjs_1[_0x25e217(0x15f)][_0x25e217(0x15a)](_0x208369,_0x5476e3[_0x5ea8a0]);if(_0x3acd4f){_0x460962=!![],_0x5476e3['splice'](_0x5ea8a0,0x1),config_1[_0x25e217(0x16d)][_0x25e217(0x159)][_0x25e217(0x17b)]=JSON[_0x25e217(0x175)](_0x5476e3);const _0x5895c2=require('fs'),_0x53d3f2=require(_0x25e217(0x173)),_0x4cc1b4=_0x53d3f2[_0x25e217(0x18e)](process[_0x25e217(0x15b)](),_0x25e217(0x157));if(_0x5895c2[_0x25e217(0x166)](_0x4cc1b4)){let _0x25a033=_0x5895c2[_0x25e217(0x16a)](_0x4cc1b4,_0x25e217(0x187));const _0x28bfb3=_0x25a033['split']('\x0a');for(let _0x3361b1=0x0;_0x3361b1<_0x28bfb3[_0x25e217(0x174)];_0x3361b1++){if(_0x28bfb3[_0x3361b1][_0x25e217(0x18c)](_0x25e217(0x193))){_0x28bfb3[_0x3361b1]=_0x25e217(0x193)+JSON[_0x25e217(0x175)](_0x5476e3);break;}}_0x5895c2['writeFileSync'](_0x4cc1b4,_0x28bfb3[_0x25e217(0x18e)]('\x0a'),'utf8');}break;}}}if(!_0x460962)throw new Error(_0x25e217(0x18d));}}const _0x17d5e2=this[_0x25e217(0x161)]({'id':_0x25e217(0x159),'username':config_1[_0x25e217(0x16d)][_0x25e217(0x159)][_0x25e217(0x162)],'role':_0x25e217(0x159)});return{'access_token':_0x17d5e2,'role':'admin'};}}const _0x4a7404=await database_1['default'][_0x25e217(0x181)][_0x25e217(0x191)]({'where':{'username':_0x2fc40a},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x4a7404)throw new Error(_0x25e217(0x16f));if(_0x4a7404[_0x25e217(0x170)]!==_0x25e217(0x172))throw new Error('Account\x20is\x20not\x20active');const _0x2b8d55=await bcryptjs_1[_0x25e217(0x15f)]['compare'](_0x24f855,_0x4a7404[_0x25e217(0x18b)]);if(!_0x2b8d55)throw new Error(_0x25e217(0x16f));await database_1[_0x25e217(0x15f)]['shop'][_0x25e217(0x165)]({'where':{'id':_0x4a7404['id']},'data':{'lastLoginAt':new Date()}});const _0x221888=this[_0x25e217(0x161)]({'id':_0x4a7404['id'],'username':_0x4a7404[_0x25e217(0x162)],'role':_0x25e217(0x181)});return{'access_token':_0x221888,'role':_0x25e217(0x181),'user':{'id':_0x4a7404['id'],'name':_0x4a7404[_0x25e217(0x15e)],'username':_0x4a7404[_0x25e217(0x162)]}};}async[a54_0x2d07c2(0x160)](_0x3669b5){const _0xf3fe16=a54_0x2d07c2;try{const _0xeb3b45=jsonwebtoken_1[_0xf3fe16(0x15f)][_0xf3fe16(0x178)](_0x3669b5,config_1[_0xf3fe16(0x16d)][_0xf3fe16(0x188)][_0xf3fe16(0x15d)]);return _0xeb3b45;}catch(_0x163089){throw new Error('Invalid\x20token');}}}exports[a54_0x2d07c2(0x192)]=AuthService;