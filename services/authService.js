'use strict';const a49_0x23ff84=a49_0xc389;function a49_0xc389(_0x2442e4,_0x240a59){_0x2442e4=_0x2442e4-0x151;const _0x21acc5=a49_0x21ac();let _0xc3897d=_0x21acc5[_0x2442e4];return _0xc3897d;}(function(_0x1a2e8e,_0x2b3d09){const _0x4af4f5=a49_0xc389,_0x58e3da=_0x1a2e8e();while(!![]){try{const _0x5e6862=parseInt(_0x4af4f5(0x176))/0x1*(parseInt(_0x4af4f5(0x16a))/0x2)+parseInt(_0x4af4f5(0x171))/0x3*(-parseInt(_0x4af4f5(0x17c))/0x4)+parseInt(_0x4af4f5(0x18c))/0x5*(parseInt(_0x4af4f5(0x18b))/0x6)+parseInt(_0x4af4f5(0x161))/0x7*(-parseInt(_0x4af4f5(0x175))/0x8)+parseInt(_0x4af4f5(0x168))/0x9+-parseInt(_0x4af4f5(0x18a))/0xa*(parseInt(_0x4af4f5(0x17f))/0xb)+parseInt(_0x4af4f5(0x16c))/0xc;if(_0x5e6862===_0x2b3d09)break;else _0x58e3da['push'](_0x58e3da['shift']());}catch(_0x281a9d){_0x58e3da['push'](_0x58e3da['shift']());}}}(a49_0x21ac,0x47fe2));function a49_0x21ac(){const _0x1de421=['cloudflare','utf8','length','verifyToken','stringify','name','verify','path','30lHdpPu','6gGQGjm','1101695AGHRTK','compare','./captchaService','split','ACTIVE','twoFactorSecret','AuthService','findUnique','__importDefault','default','speakeasy','login','Captcha\x20verification\x20required','defineProperty','jwt','username','../config/database','../config/config','parse','3882697jCUwGd','jsonwebtoken','Account\x20is\x20not\x20active','config','turnstileSecretKey','update','shop','128880DMHDYK','twoFactorEnabled','544084PzUYGk','cwd','6653052pwIAfC','bcryptjs','Invalid\x20captcha','ADMIN_BACKUP_CODES=','generateToken','16395XoqhlB','splice','captchaService','secret','8HIcohz','2uMCHKs','join','readFileSync','__esModule','existsSync','backupCodes','208WKlcAA','passwordHash','admin','731247oCIAZt','password','trim'];a49_0x21ac=function(){return _0x1de421;};return a49_0x21ac();}var __importDefault=this&&this[a49_0x23ff84(0x156)]||function(_0x4163c3){const _0x333e7b=a49_0x23ff84;return _0x4163c3&&_0x4163c3[_0x333e7b(0x179)]?_0x4163c3:{'default':_0x4163c3};};Object[a49_0x23ff84(0x15b)](exports,a49_0x23ff84(0x179),{'value':!![]}),exports['AuthService']=void 0x0;const bcryptjs_1=__importDefault(require(a49_0x23ff84(0x16d))),jsonwebtoken_1=__importDefault(require(a49_0x23ff84(0x162))),speakeasy_1=__importDefault(require(a49_0x23ff84(0x158))),database_1=__importDefault(require(a49_0x23ff84(0x15e))),config_1=require(a49_0x23ff84(0x15f)),captchaService_1=require(a49_0x23ff84(0x18e));class AuthService{[a49_0x23ff84(0x170)](_0x1929fb){const _0x11add7=a49_0x23ff84;return jsonwebtoken_1[_0x11add7(0x157)]['sign'](_0x1929fb,config_1[_0x11add7(0x164)][_0x11add7(0x15c)]['secret'],{'expiresIn':String(config_1[_0x11add7(0x164)][_0x11add7(0x15c)]['expiresIn'])});}async[a49_0x23ff84(0x159)](_0xa9a06e){const _0x20f585=a49_0x23ff84,{username:_0x1d8f39,password:_0x3ef28d,twoFactorToken:_0x35115f,captchaToken:_0x2eb31f}=_0xa9a06e;if(!_0x35115f||_0x35115f[_0x20f585(0x181)]()===''){if(_0x2eb31f){const _0x5d0ab5=await captchaService_1[_0x20f585(0x173)]['verifyCaptcha'](_0x2eb31f);if(!_0x5d0ab5)throw new Error(_0x20f585(0x16e));}else{if(config_1[_0x20f585(0x164)][_0x20f585(0x182)]?.[_0x20f585(0x165)])throw new Error(_0x20f585(0x15a));}}if(_0x1d8f39===config_1[_0x20f585(0x164)][_0x20f585(0x17e)][_0x20f585(0x15d)]){const _0x25a36d=await bcryptjs_1[_0x20f585(0x157)]['compare'](_0x3ef28d,config_1[_0x20f585(0x164)][_0x20f585(0x17e)][_0x20f585(0x17d)]);if(_0x25a36d){if(config_1['config'][_0x20f585(0x17e)][_0x20f585(0x169)]){if(!_0x35115f)return{'access_token':'','role':'admin','requires2FA':!![]};const _0xc6aad4=speakeasy_1[_0x20f585(0x157)]['totp'][_0x20f585(0x188)]({'secret':config_1[_0x20f585(0x164)][_0x20f585(0x17e)][_0x20f585(0x153)],'encoding':'base32','token':_0x35115f,'window':0x2});if(!_0xc6aad4){let _0x3bdb40=![];if(config_1[_0x20f585(0x164)][_0x20f585(0x17e)]['backupCodes']){const _0xb06f73=JSON[_0x20f585(0x160)](config_1[_0x20f585(0x164)][_0x20f585(0x17e)][_0x20f585(0x17b)]);for(let _0x462bad=0x0;_0x462bad<_0xb06f73[_0x20f585(0x184)];_0x462bad++){const _0x2e590f=await bcryptjs_1[_0x20f585(0x157)][_0x20f585(0x18d)](_0x35115f,_0xb06f73[_0x462bad]);if(_0x2e590f){_0x3bdb40=!![],_0xb06f73[_0x20f585(0x172)](_0x462bad,0x1),config_1[_0x20f585(0x164)][_0x20f585(0x17e)]['backupCodes']=JSON[_0x20f585(0x186)](_0xb06f73);const _0x1d4b84=require('fs'),_0x394265=require(_0x20f585(0x189)),_0x17ae4c=_0x394265[_0x20f585(0x177)](process[_0x20f585(0x16b)](),'.env');if(_0x1d4b84[_0x20f585(0x17a)](_0x17ae4c)){let _0xae4145=_0x1d4b84[_0x20f585(0x178)](_0x17ae4c,_0x20f585(0x183));const _0x3dc239=_0xae4145[_0x20f585(0x151)]('\x0a');for(let _0x979e36=0x0;_0x979e36<_0x3dc239[_0x20f585(0x184)];_0x979e36++){if(_0x3dc239[_0x979e36]['startsWith'](_0x20f585(0x16f))){_0x3dc239[_0x979e36]=_0x20f585(0x16f)+JSON[_0x20f585(0x186)](_0xb06f73);break;}}_0x1d4b84['writeFileSync'](_0x17ae4c,_0x3dc239[_0x20f585(0x177)]('\x0a'),_0x20f585(0x183));}break;}}}if(!_0x3bdb40)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x4e3996=this[_0x20f585(0x170)]({'id':_0x20f585(0x17e),'username':config_1[_0x20f585(0x164)][_0x20f585(0x17e)][_0x20f585(0x15d)],'role':_0x20f585(0x17e)});return{'access_token':_0x4e3996,'role':_0x20f585(0x17e)};}}const _0x73a1=await database_1[_0x20f585(0x157)]['shop'][_0x20f585(0x155)]({'where':{'username':_0x1d8f39},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x73a1)throw new Error('Invalid\x20credentials');if(_0x73a1['status']!==_0x20f585(0x152))throw new Error(_0x20f585(0x163));const _0x4b62be=await bcryptjs_1[_0x20f585(0x157)][_0x20f585(0x18d)](_0x3ef28d,_0x73a1[_0x20f585(0x180)]);if(!_0x4b62be)throw new Error('Invalid\x20credentials');await database_1['default'][_0x20f585(0x167)][_0x20f585(0x166)]({'where':{'id':_0x73a1['id']},'data':{'lastLoginAt':new Date()}});const _0x2de1ef=this[_0x20f585(0x170)]({'id':_0x73a1['id'],'username':_0x73a1[_0x20f585(0x15d)],'role':_0x20f585(0x167)});return{'access_token':_0x2de1ef,'role':_0x20f585(0x167),'user':{'id':_0x73a1['id'],'name':_0x73a1[_0x20f585(0x187)],'username':_0x73a1[_0x20f585(0x15d)]}};}async[a49_0x23ff84(0x185)](_0x2f2e20){const _0x580c35=a49_0x23ff84;try{const _0x29461b=jsonwebtoken_1[_0x580c35(0x157)]['verify'](_0x2f2e20,config_1[_0x580c35(0x164)][_0x580c35(0x15c)][_0x580c35(0x174)]);return _0x29461b;}catch(_0x2f125b){throw new Error('Invalid\x20token');}}}exports[a49_0x23ff84(0x154)]=AuthService;