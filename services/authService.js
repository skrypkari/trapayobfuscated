'use strict';const a49_0x46b439=a49_0xeb38;function a49_0x1aca(){const _0xe58cd2=['secret','join','56298EzfSVN','admin','Captcha\x20verification\x20required','shop','default','../config/database','Invalid\x20credentials','update','11247840kEcBeq','readFileSync','splice','config','jsonwebtoken','verifyToken','cloudflare','expiresIn','turnstileSecretKey','49644VlfDbB','username','generateToken','cwd','backupCodes','startsWith','base32','1649199ubKKJU','totp','length','password','bcryptjs','ACTIVE','login','passwordHash','565WkXfyA','verify','1082197dIcTIy','2UhKPoV','./captchaService','jwt','1800gbBzPR','../config/config','6747284UzUkFX','7091775BZJtqO','.env','verifyCaptcha','AuthService','twoFactorSecret','name','Invalid\x202FA\x20token\x20or\x20backup\x20code','trim','stringify','__esModule','sign','compare','ADMIN_BACKUP_CODES='];a49_0x1aca=function(){return _0xe58cd2;};return a49_0x1aca();}(function(_0x219a5e,_0x51f727){const _0x3e2cbe=a49_0xeb38,_0x359f39=_0x219a5e();while(!![]){try{const _0xf9995a=parseInt(_0x3e2cbe(0x8f))/0x1*(-parseInt(_0x3e2cbe(0x90))/0x2)+-parseInt(_0x3e2cbe(0x85))/0x3+parseInt(_0x3e2cbe(0x95))/0x4+parseInt(_0x3e2cbe(0x8d))/0x5*(-parseInt(_0x3e2cbe(0xa5))/0x6)+parseInt(_0x3e2cbe(0xb6))/0x7*(parseInt(_0x3e2cbe(0x93))/0x8)+-parseInt(_0x3e2cbe(0x96))/0x9+parseInt(_0x3e2cbe(0xad))/0xa;if(_0xf9995a===_0x51f727)break;else _0x359f39['push'](_0x359f39['shift']());}catch(_0x160a5e){_0x359f39['push'](_0x359f39['shift']());}}}(a49_0x1aca,0xe2591));var __importDefault=this&&this['__importDefault']||function(_0x2e4bf5){const _0x254f0c=a49_0xeb38;return _0x2e4bf5&&_0x2e4bf5[_0x254f0c(0x9f)]?_0x2e4bf5:{'default':_0x2e4bf5};};Object['defineProperty'](exports,a49_0x46b439(0x9f),{'value':!![]}),exports[a49_0x46b439(0x99)]=void 0x0;function a49_0xeb38(_0x1a8b03,_0x4ed6d5){_0x1a8b03=_0x1a8b03-0x82;const _0x1aca39=a49_0x1aca();let _0xeb381f=_0x1aca39[_0x1a8b03];return _0xeb381f;}const bcryptjs_1=__importDefault(require(a49_0x46b439(0x89))),jsonwebtoken_1=__importDefault(require(a49_0x46b439(0xb1))),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require(a49_0x46b439(0xaa))),config_1=require(a49_0x46b439(0x94)),captchaService_1=require(a49_0x46b439(0x91));class AuthService{[a49_0x46b439(0xb8)](_0x1b4cdd){const _0x15b928=a49_0x46b439;return jsonwebtoken_1['default'][_0x15b928(0xa0)](_0x1b4cdd,config_1['config'][_0x15b928(0x92)][_0x15b928(0xa3)],{'expiresIn':String(config_1['config'][_0x15b928(0x92)][_0x15b928(0xb4)])});}async[a49_0x46b439(0x8b)](_0x4214bc){const _0x15ccdf=a49_0x46b439,{username:_0x5138aa,password:_0xef77a,twoFactorToken:_0x1fc4fe,captchaToken:_0x22fe5c}=_0x4214bc;if(!_0x1fc4fe||_0x1fc4fe[_0x15ccdf(0x9d)]()===''){if(_0x22fe5c){const _0x53f7b0=await captchaService_1['captchaService'][_0x15ccdf(0x98)](_0x22fe5c);if(!_0x53f7b0)throw new Error('Invalid\x20captcha');}else{if(config_1[_0x15ccdf(0xb0)][_0x15ccdf(0xb3)]?.[_0x15ccdf(0xb5)])throw new Error(_0x15ccdf(0xa7));}}if(_0x5138aa===config_1[_0x15ccdf(0xb0)]['admin']['username']){const _0x28833b=await bcryptjs_1[_0x15ccdf(0xa9)]['compare'](_0xef77a,config_1[_0x15ccdf(0xb0)][_0x15ccdf(0xa6)][_0x15ccdf(0x8c)]);if(_0x28833b){if(config_1[_0x15ccdf(0xb0)][_0x15ccdf(0xa6)]['twoFactorEnabled']){if(!_0x1fc4fe)return{'access_token':'','role':_0x15ccdf(0xa6),'requires2FA':!![]};const _0x83ce37=speakeasy_1[_0x15ccdf(0xa9)][_0x15ccdf(0x86)][_0x15ccdf(0x8e)]({'secret':config_1['config'][_0x15ccdf(0xa6)][_0x15ccdf(0x9a)],'encoding':_0x15ccdf(0x84),'token':_0x1fc4fe,'window':0x2});if(!_0x83ce37){let _0x220830=![];if(config_1[_0x15ccdf(0xb0)][_0x15ccdf(0xa6)][_0x15ccdf(0x82)]){const _0x3e44e9=JSON['parse'](config_1[_0x15ccdf(0xb0)][_0x15ccdf(0xa6)]['backupCodes']);for(let _0x89d245=0x0;_0x89d245<_0x3e44e9[_0x15ccdf(0x87)];_0x89d245++){const _0xdf5b15=await bcryptjs_1['default'][_0x15ccdf(0xa1)](_0x1fc4fe,_0x3e44e9[_0x89d245]);if(_0xdf5b15){_0x220830=!![],_0x3e44e9[_0x15ccdf(0xaf)](_0x89d245,0x1),config_1[_0x15ccdf(0xb0)]['admin']['backupCodes']=JSON['stringify'](_0x3e44e9);const _0x3880de=require('fs'),_0x79b522=require('path'),_0xe14bfc=_0x79b522['join'](process[_0x15ccdf(0xb9)](),_0x15ccdf(0x97));if(_0x3880de['existsSync'](_0xe14bfc)){let _0x45b98f=_0x3880de[_0x15ccdf(0xae)](_0xe14bfc,'utf8');const _0x2225ba=_0x45b98f['split']('\x0a');for(let _0x357a19=0x0;_0x357a19<_0x2225ba[_0x15ccdf(0x87)];_0x357a19++){if(_0x2225ba[_0x357a19][_0x15ccdf(0x83)](_0x15ccdf(0xa2))){_0x2225ba[_0x357a19]=_0x15ccdf(0xa2)+JSON[_0x15ccdf(0x9e)](_0x3e44e9);break;}}_0x3880de['writeFileSync'](_0xe14bfc,_0x2225ba[_0x15ccdf(0xa4)]('\x0a'),'utf8');}break;}}}if(!_0x220830)throw new Error(_0x15ccdf(0x9c));}}const _0x49873a=this[_0x15ccdf(0xb8)]({'id':'admin','username':config_1[_0x15ccdf(0xb0)][_0x15ccdf(0xa6)][_0x15ccdf(0xb7)],'role':_0x15ccdf(0xa6)});return{'access_token':_0x49873a,'role':_0x15ccdf(0xa6)};}}const _0x569b45=await database_1[_0x15ccdf(0xa9)][_0x15ccdf(0xa8)]['findUnique']({'where':{'username':_0x5138aa},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x569b45)throw new Error(_0x15ccdf(0xab));if(_0x569b45['status']!==_0x15ccdf(0x8a))throw new Error('Account\x20is\x20not\x20active');const _0x4beb88=await bcryptjs_1[_0x15ccdf(0xa9)][_0x15ccdf(0xa1)](_0xef77a,_0x569b45[_0x15ccdf(0x88)]);if(!_0x4beb88)throw new Error(_0x15ccdf(0xab));await database_1['default'][_0x15ccdf(0xa8)][_0x15ccdf(0xac)]({'where':{'id':_0x569b45['id']},'data':{'lastLoginAt':new Date()}});const _0x53101f=this['generateToken']({'id':_0x569b45['id'],'username':_0x569b45[_0x15ccdf(0xb7)],'role':_0x15ccdf(0xa8)});return{'access_token':_0x53101f,'role':_0x15ccdf(0xa8),'user':{'id':_0x569b45['id'],'name':_0x569b45[_0x15ccdf(0x9b)],'username':_0x569b45['username']}};}async[a49_0x46b439(0xb2)](_0x4c5e04){const _0x45e5e4=a49_0x46b439;try{const _0xd4824a=jsonwebtoken_1['default'][_0x45e5e4(0x8e)](_0x4c5e04,config_1[_0x45e5e4(0xb0)]['jwt'][_0x45e5e4(0xa3)]);return _0xd4824a;}catch(_0x157cdd){throw new Error('Invalid\x20token');}}}exports[a49_0x46b439(0x99)]=AuthService;