'use strict';const a54_0x3fe1b5=a54_0x5301;(function(_0x94acb0,_0xf08f91){const _0x5da4ef=a54_0x5301,_0x58c23c=_0x94acb0();while(!![]){try{const _0x4dd90d=parseInt(_0x5da4ef(0x1de))/0x1+-parseInt(_0x5da4ef(0x1e0))/0x2+-parseInt(_0x5da4ef(0x1dc))/0x3*(parseInt(_0x5da4ef(0x1d7))/0x4)+parseInt(_0x5da4ef(0x1d3))/0x5*(-parseInt(_0x5da4ef(0x1ea))/0x6)+parseInt(_0x5da4ef(0x1bb))/0x7+-parseInt(_0x5da4ef(0x1c3))/0x8*(-parseInt(_0x5da4ef(0x1be))/0x9)+-parseInt(_0x5da4ef(0x1f5))/0xa*(-parseInt(_0x5da4ef(0x1d6))/0xb);if(_0x4dd90d===_0xf08f91)break;else _0x58c23c['push'](_0x58c23c['shift']());}catch(_0x5f0d99){_0x58c23c['push'](_0x58c23c['shift']());}}}(a54_0x5c04,0x19af3));var __importDefault=this&&this[a54_0x3fe1b5(0x1ce)]||function(_0x42df19){const _0x17a4ee=a54_0x3fe1b5;return _0x42df19&&_0x42df19[_0x17a4ee(0x1d9)]?_0x42df19:{'default':_0x42df19};};function a54_0x5301(_0x3010e0,_0x1f0ecf){_0x3010e0=_0x3010e0-0x1ba;const _0x5c047c=a54_0x5c04();let _0x53011f=_0x5c047c[_0x3010e0];return _0x53011f;}function a54_0x5c04(){const _0x8b3590=['45349bbHjCT','parse','242600wrsRLq','admin','trim','speakeasy','join','Invalid\x20captcha','default','Invalid\x20token','existsSync','Invalid\x20credentials','197058nnCSDq','.env','startsWith','shop','jwt','password','login','writeFileSync','ACTIVE','turnstileSecretKey','cwd','4880xFypuo','verify','passwordHash','1111215tSJZOY','generateToken','split','18aHbeuu','ADMIN_BACKUP_CODES=','compare','Invalid\x202FA\x20token\x20or\x20backup\x20code','sign','273496WGRGrs','length','readFileSync','twoFactorEnabled','verifyToken','../config/database','findUnique','splice','secret','captchaService','config','__importDefault','name','cloudflare','utf8','bcryptjs','5Zcnvdg','username','Captcha\x20verification\x20required','3542ZqMqbU','284oOrIep','jsonwebtoken','__esModule','expiresIn','../config/config','7194tLAkgL','backupCodes'];a54_0x5c04=function(){return _0x8b3590;};return a54_0x5c04();}Object['defineProperty'](exports,a54_0x3fe1b5(0x1d9),{'value':!![]}),exports['AuthService']=void 0x0;const bcryptjs_1=__importDefault(require(a54_0x3fe1b5(0x1d2))),jsonwebtoken_1=__importDefault(require(a54_0x3fe1b5(0x1d8))),speakeasy_1=__importDefault(require(a54_0x3fe1b5(0x1e3))),database_1=__importDefault(require(a54_0x3fe1b5(0x1c8))),config_1=require(a54_0x3fe1b5(0x1db)),captchaService_1=require('./captchaService');class AuthService{['generateToken'](_0x52da23){const _0xf432ab=a54_0x3fe1b5;return jsonwebtoken_1[_0xf432ab(0x1e6)][_0xf432ab(0x1c2)](_0x52da23,config_1[_0xf432ab(0x1cd)][_0xf432ab(0x1ee)][_0xf432ab(0x1cb)],{'expiresIn':String(config_1[_0xf432ab(0x1cd)]['jwt'][_0xf432ab(0x1da)])});}async[a54_0x3fe1b5(0x1f0)](_0x47ecfc){const _0xa8bfe2=a54_0x3fe1b5,{username:_0x43e315,password:_0x2c0b52,twoFactorToken:_0x59d3a0,captchaToken:_0x151d37}=_0x47ecfc;if(!_0x59d3a0||_0x59d3a0[_0xa8bfe2(0x1e2)]()===''){if(_0x151d37){const _0x5f2322=await captchaService_1[_0xa8bfe2(0x1cc)]['verifyCaptcha'](_0x151d37);if(!_0x5f2322)throw new Error(_0xa8bfe2(0x1e5));}else{if(config_1[_0xa8bfe2(0x1cd)][_0xa8bfe2(0x1d0)]?.[_0xa8bfe2(0x1f3)])throw new Error(_0xa8bfe2(0x1d5));}}if(_0x43e315===config_1['config']['admin'][_0xa8bfe2(0x1d4)]){const _0x22b7ee=await bcryptjs_1['default'][_0xa8bfe2(0x1c0)](_0x2c0b52,config_1[_0xa8bfe2(0x1cd)][_0xa8bfe2(0x1e1)][_0xa8bfe2(0x1ba)]);if(_0x22b7ee){if(config_1[_0xa8bfe2(0x1cd)][_0xa8bfe2(0x1e1)][_0xa8bfe2(0x1c6)]){if(!_0x59d3a0)return{'access_token':'','role':'admin','requires2FA':!![]};const _0x4415e4=speakeasy_1[_0xa8bfe2(0x1e6)]['totp'][_0xa8bfe2(0x1f6)]({'secret':config_1['config'][_0xa8bfe2(0x1e1)]['twoFactorSecret'],'encoding':'base32','token':_0x59d3a0,'window':0x2});if(!_0x4415e4){let _0x2aed43=![];if(config_1[_0xa8bfe2(0x1cd)][_0xa8bfe2(0x1e1)][_0xa8bfe2(0x1dd)]){const _0x4f261d=JSON[_0xa8bfe2(0x1df)](config_1[_0xa8bfe2(0x1cd)]['admin']['backupCodes']);for(let _0x4f0175=0x0;_0x4f0175<_0x4f261d[_0xa8bfe2(0x1c4)];_0x4f0175++){const _0x296995=await bcryptjs_1[_0xa8bfe2(0x1e6)][_0xa8bfe2(0x1c0)](_0x59d3a0,_0x4f261d[_0x4f0175]);if(_0x296995){_0x2aed43=!![],_0x4f261d[_0xa8bfe2(0x1ca)](_0x4f0175,0x1),config_1[_0xa8bfe2(0x1cd)][_0xa8bfe2(0x1e1)][_0xa8bfe2(0x1dd)]=JSON['stringify'](_0x4f261d);const _0x4e16d0=require('fs'),_0x3cf65f=require('path'),_0x212c6e=_0x3cf65f[_0xa8bfe2(0x1e4)](process[_0xa8bfe2(0x1f4)](),_0xa8bfe2(0x1eb));if(_0x4e16d0[_0xa8bfe2(0x1e8)](_0x212c6e)){let _0x3dd193=_0x4e16d0[_0xa8bfe2(0x1c5)](_0x212c6e,_0xa8bfe2(0x1d1));const _0x501c7d=_0x3dd193[_0xa8bfe2(0x1bd)]('\x0a');for(let _0x429f3b=0x0;_0x429f3b<_0x501c7d[_0xa8bfe2(0x1c4)];_0x429f3b++){if(_0x501c7d[_0x429f3b][_0xa8bfe2(0x1ec)](_0xa8bfe2(0x1bf))){_0x501c7d[_0x429f3b]='ADMIN_BACKUP_CODES='+JSON['stringify'](_0x4f261d);break;}}_0x4e16d0[_0xa8bfe2(0x1f1)](_0x212c6e,_0x501c7d[_0xa8bfe2(0x1e4)]('\x0a'),_0xa8bfe2(0x1d1));}break;}}}if(!_0x2aed43)throw new Error(_0xa8bfe2(0x1c1));}}const _0x4194c6=this[_0xa8bfe2(0x1bc)]({'id':'admin','username':config_1[_0xa8bfe2(0x1cd)][_0xa8bfe2(0x1e1)]['username'],'role':'admin'});return{'access_token':_0x4194c6,'role':_0xa8bfe2(0x1e1)};}}const _0x59d5f7=await database_1[_0xa8bfe2(0x1e6)][_0xa8bfe2(0x1ed)][_0xa8bfe2(0x1c9)]({'where':{'username':_0x43e315},'select':{'id':!![],'name':!![],'username':!![],'password':!![],'status':!![]}});if(!_0x59d5f7)throw new Error(_0xa8bfe2(0x1e9));if(_0x59d5f7['status']!==_0xa8bfe2(0x1f2))throw new Error('Account\x20is\x20not\x20active');const _0x1589b5=await bcryptjs_1[_0xa8bfe2(0x1e6)]['compare'](_0x2c0b52,_0x59d5f7[_0xa8bfe2(0x1ef)]);if(!_0x1589b5)throw new Error('Invalid\x20credentials');await database_1[_0xa8bfe2(0x1e6)]['shop']['update']({'where':{'id':_0x59d5f7['id']},'data':{'lastLoginAt':new Date()}});const _0xf598d2=this['generateToken']({'id':_0x59d5f7['id'],'username':_0x59d5f7['username'],'role':_0xa8bfe2(0x1ed)});return{'access_token':_0xf598d2,'role':_0xa8bfe2(0x1ed),'user':{'id':_0x59d5f7['id'],'name':_0x59d5f7[_0xa8bfe2(0x1cf)],'username':_0x59d5f7[_0xa8bfe2(0x1d4)]}};}async[a54_0x3fe1b5(0x1c7)](_0x2f8833){const _0x3139af=a54_0x3fe1b5;try{const _0x3213bc=jsonwebtoken_1[_0x3139af(0x1e6)]['verify'](_0x2f8833,config_1[_0x3139af(0x1cd)]['jwt'][_0x3139af(0x1cb)]);return _0x3213bc;}catch(_0x5a1cd7){throw new Error(_0x3139af(0x1e7));}}}exports['AuthService']=AuthService;