'use strict';function a41_0x45b2(_0x445d01,_0x181d1b){const _0x463ea0=a41_0x463e();return a41_0x45b2=function(_0x45b278,_0x190396){_0x45b278=_0x45b278-0x1af;let _0x5c3463=_0x463ea0[_0x45b278];return _0x5c3463;},a41_0x45b2(_0x445d01,_0x181d1b);}const a41_0x2159c6=a41_0x45b2;(function(_0x4d1366,_0x1983e7){const _0x33a9ed=a41_0x45b2,_0xe1623f=_0x4d1366();while(!![]){try{const _0x481804=parseInt(_0x33a9ed(0x1c9))/0x1*(parseInt(_0x33a9ed(0x20b))/0x2)+-parseInt(_0x33a9ed(0x1dc))/0x3*(parseInt(_0x33a9ed(0x200))/0x4)+parseInt(_0x33a9ed(0x204))/0x5+parseInt(_0x33a9ed(0x1bf))/0x6+-parseInt(_0x33a9ed(0x1e7))/0x7*(-parseInt(_0x33a9ed(0x201))/0x8)+parseInt(_0x33a9ed(0x203))/0x9+-parseInt(_0x33a9ed(0x1ea))/0xa;if(_0x481804===_0x1983e7)break;else _0xe1623f['push'](_0xe1623f['shift']());}catch(_0x1962e0){_0xe1623f['push'](_0xe1623f['shift']());}}}(a41_0x463e,0xed976));function a41_0x463e(){const _0x319de0=['__esModule','Error\x20stack:','order_number','../loggerService','createPayment','===\x20PLISIO\x20API\x20ERROR\x20===','/operations/','HTTP\x20','/invoices/new','GET','Failed\x20to\x20parse\x20JSON\x20response:','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','Error\x20details:','append','message','Status:','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','3tgIeYo','PENDING','map','name','Raw\x20Response\x20Body:','apiKey','PlisioService','===\x20PLISIO\x20SUCCESS\x20===','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','parse','PAID','10388nWdJUH','https://api.plisio.net/api/v1/invoices/new','fromEntries','34615780ZZxDVp','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','Plisio\x20API\x20key\x20is\x20not\x20configured','mismatch','Plisio\x20payment\x20verification\x20error:','processWebhook','https://api.trapay.uk/api/webhooks/gateway/plisio','HIDDEN','‚úÖ\x20URL\x20','Unknown\x20error\x20from\x20Plisio\x20API','email','logWhiteDomainRequest','new','log','‚ùå\x20URL\x20','logWhiteDomainResponse','PLISIO_API_KEY','plisio_direct','currency','(fiat\x20for\x20merchant)','isArray','\x20is\x20valid:\x20','993416mDhvsj','688QVsyed','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','31950tBuAGE','9616780LCdYHI','‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','Failed\x20to\x20create\x20Plisio\x20payment:\x20','data','success','Plisio\x20API\x20error:\x20','Error\x20Message:','42582gDjoQG','error','stringify','HTTP\x20Status:','\x20is\x20invalid:\x20','application/json','logWhiteDomainError','JSON\x20Parse\x20Error:\x20','qr_code','statusText','‚ùå\x20Failed\x20to\x20parse\x20tx_urls:','Transaction\x20ID:','Parsed\x20Result:','üîó\x20Formatted\x20URL:\x20','toLowerCase','Parameters:','Business\x20Error:\x20','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','txn_id','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','now','stack','Target\x20Currency:','HTTP\x20error!\x20status:\x20','toString','string','Unknown\x20error','amount','https://api.plisio.net/api/v1/operations/','pending','apiUrl','Source\x20Currency:','TesSoft\x20Payment\x20System/1.0','completed','tx_urls','entries','URL:','loggerService','text','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','11044854qTawXT','Amount:','Response\x20Time:','status','qr_url','Status\x20Text:','Full\x20URL\x20(without\x20API\x20key):','FAILED','invoice_url','Invoice\x20URL:','37HmgPDw'];a41_0x463e=function(){return _0x319de0;};return a41_0x463e();}Object['defineProperty'](exports,a41_0x2159c6(0x1ca),{'value':!![]}),exports[a41_0x2159c6(0x1e2)]=void 0x0;const loggerService_1=require(a41_0x2159c6(0x1cd));class PlisioService{constructor(){const _0x304ddb=a41_0x2159c6;this[_0x304ddb(0x1b3)]=_0x304ddb(0x1e8),this[_0x304ddb(0x1e1)]=process['env'][_0x304ddb(0x1fa)]||'',!this[_0x304ddb(0x1e1)]?console['warn'](_0x304ddb(0x205)):console['log']('üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API');}async[a41_0x2159c6(0x1ce)](_0x1e31ce){const _0xb4cbe9=a41_0x2159c6,{orderId:_0x2fce86,amount:_0x1c2373,currency:_0x58f730,productName:_0x4e5be2,description:_0x20c4a4,successUrl:_0x411b77,failUrl:_0xc47423,customerEmail:_0x599af7,customerName:_0x57849a,isSourceCurrency:_0xbdb5ac,sourceCurrency:_0x393e4d}=_0x1e31ce;if(!this[_0xb4cbe9(0x1e1)])throw new Error('Plisio\x20API\x20key\x20is\x20not\x20configured');const _0x3d1576=new URLSearchParams({'api_key':this['apiKey'],'order_number':_0x2fce86,'order_name':_0x4e5be2,'description':_0x20c4a4,'success_url':_0x411b77,'fail_url':_0xc47423,'callback_url':_0xb4cbe9(0x1f0)});_0x393e4d?(_0x3d1576[_0xb4cbe9(0x1d7)](_0xb4cbe9(0x1fc),_0x393e4d),_0x3d1576['append']('source_currency',_0x58f730),_0x3d1576[_0xb4cbe9(0x1d7)]('source_amount',_0x1c2373[_0xb4cbe9(0x223)]())):(_0x3d1576[_0xb4cbe9(0x1d7)](_0xb4cbe9(0x1fc),_0x58f730),_0x3d1576[_0xb4cbe9(0x1d7)](_0xb4cbe9(0x1b0),_0x1c2373[_0xb4cbe9(0x223)]()));_0x599af7&&_0x3d1576['append'](_0xb4cbe9(0x1f4),_0x599af7);_0x57849a&&_0x3d1576['append'](_0xb4cbe9(0x1df),_0x57849a);const _0x5ca454=this['apiUrl']+'?'+_0x3d1576[_0xb4cbe9(0x223)](),_0x2b881f=Date[_0xb4cbe9(0x21f)]();try{console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x1da)),console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x1b9),this['apiUrl']),console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x21a),Object[_0xb4cbe9(0x1e9)](_0x3d1576[_0xb4cbe9(0x1b8)]())),console['log'](_0xb4cbe9(0x1c5),_0x5ca454['replace'](this['apiKey'],_0xb4cbe9(0x1f1))),loggerService_1[_0xb4cbe9(0x1ba)][_0xb4cbe9(0x1f5)](_0xb4cbe9(0x1fb),_0xb4cbe9(0x1d2),_0xb4cbe9(0x1d3),Object['fromEntries'](_0x3d1576[_0xb4cbe9(0x1b8)]()));const _0x10ec5e=await fetch(_0x5ca454,{'method':_0xb4cbe9(0x1d3),'headers':{'Accept':'application/json','User-Agent':_0xb4cbe9(0x1b5)}}),_0x92deb9=Date['now']()-_0x2b881f;console['log']('===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20==='),console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x1d9),_0x10ec5e['status']),console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x1c4),_0x10ec5e[_0xb4cbe9(0x214)]),console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x1c1),_0x92deb9+'ms');const _0x34c335=await _0x10ec5e['text']();console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x1e0),_0x34c335);if(!_0x10ec5e['ok']){console['error'](_0xb4cbe9(0x1cf)),console[_0xb4cbe9(0x20c)](_0xb4cbe9(0x20e),_0x10ec5e['status']),console['error']('Response\x20Body:',_0x34c335),loggerService_1[_0xb4cbe9(0x1ba)][_0xb4cbe9(0x1f9)]('plisio_direct',_0xb4cbe9(0x1d2),_0x10ec5e[_0xb4cbe9(0x1c2)],_0x34c335,_0x92deb9),loggerService_1[_0xb4cbe9(0x1ba)]['logWhiteDomainError'](_0xb4cbe9(0x1fb),_0xb4cbe9(0x1d2),_0xb4cbe9(0x1d1)+_0x10ec5e[_0xb4cbe9(0x1c2)]+':\x20'+_0x34c335);throw new Error(_0xb4cbe9(0x222)+_0x10ec5e[_0xb4cbe9(0x1c2)]+',\x20body:\x20'+_0x34c335);}let _0x5e6145;try{_0x5e6145=JSON['parse'](_0x34c335);}catch(_0x16de9f){console['error'](_0xb4cbe9(0x1d4),_0x16de9f),loggerService_1[_0xb4cbe9(0x1ba)]['logWhiteDomainError'](_0xb4cbe9(0x1fb),_0xb4cbe9(0x1d2),_0xb4cbe9(0x212)+_0x16de9f);throw new Error(_0xb4cbe9(0x1db)+_0x34c335);}console['log'](_0xb4cbe9(0x1bc)),console['log'](_0xb4cbe9(0x217),JSON[_0xb4cbe9(0x20d)](_0x5e6145,null,0x2)),loggerService_1[_0xb4cbe9(0x1ba)][_0xb4cbe9(0x1f9)](_0xb4cbe9(0x1fb),_0xb4cbe9(0x1d2),_0x10ec5e[_0xb4cbe9(0x1c2)],_0x5e6145,_0x92deb9);if(_0x5e6145[_0xb4cbe9(0x1c2)]!==_0xb4cbe9(0x208)){const _0x1d1207=_0x5e6145[_0xb4cbe9(0x1d8)]||_0x5e6145[_0xb4cbe9(0x20c)]||_0xb4cbe9(0x1f3);console[_0xb4cbe9(0x20c)](_0xb4cbe9(0x202)),console[_0xb4cbe9(0x20c)](_0xb4cbe9(0x20a),_0x1d1207),loggerService_1[_0xb4cbe9(0x1ba)][_0xb4cbe9(0x211)]('plisio_direct','/invoices/new',_0xb4cbe9(0x21b)+_0x1d1207);throw new Error(_0xb4cbe9(0x209)+_0x1d1207);}if(!_0x5e6145[_0xb4cbe9(0x207)]?.[_0xb4cbe9(0x21d)]||!_0x5e6145[_0xb4cbe9(0x207)]?.['invoice_url']){console['error'](_0xb4cbe9(0x1e4)),console[_0xb4cbe9(0x20c)](_0xb4cbe9(0x1be)),console['error']('Response\x20data:',_0x5e6145['data']),loggerService_1['loggerService']['logWhiteDomainError'](_0xb4cbe9(0x1fb),_0xb4cbe9(0x1d2),_0xb4cbe9(0x21e));throw new Error(_0xb4cbe9(0x21c));}return console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x1e3)),console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x216),_0x5e6145['data'][_0xb4cbe9(0x21d)]),console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x1c8),_0x5e6145[_0xb4cbe9(0x207)]['invoice_url']),console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x1c0),_0x1c2373,_0x58f730),_0x393e4d&&(console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x1b4),_0x393e4d,'(crypto\x20for\x20payment)'),console[_0xb4cbe9(0x1f7)](_0xb4cbe9(0x221),_0x58f730,_0xb4cbe9(0x1fd))),{'gateway_payment_id':_0x5e6145['data'][_0xb4cbe9(0x21d)],'payment_url':_0x5e6145['data'][_0xb4cbe9(0x1c7)],'invoice_total_sum':_0x5e6145[_0xb4cbe9(0x207)]['invoice_total_sum'],'qr_code':_0x5e6145['data'][_0xb4cbe9(0x213)],'qr_url':_0x5e6145[_0xb4cbe9(0x207)][_0xb4cbe9(0x1c3)]};}catch(_0xc03788){console[_0xb4cbe9(0x20c)](_0xb4cbe9(0x1d5)),console['error'](_0xb4cbe9(0x1d6),_0xc03788),loggerService_1[_0xb4cbe9(0x1ba)][_0xb4cbe9(0x211)]('plisio_direct','/invoices/new',_0xc03788);if(_0xc03788 instanceof Error){console[_0xb4cbe9(0x20c)]('Error\x20message:',_0xc03788[_0xb4cbe9(0x1d8)]),console[_0xb4cbe9(0x20c)](_0xb4cbe9(0x1cb),_0xc03788[_0xb4cbe9(0x220)]);throw new Error(_0xb4cbe9(0x206)+_0xc03788['message']);}throw new Error(_0xb4cbe9(0x1bd));}}async['verifyPayment'](_0xba1245){const _0x37956e=a41_0x2159c6,_0x4acaaf=Date[_0x37956e(0x21f)]();try{if(!this[_0x37956e(0x1e1)])throw new Error(_0x37956e(0x1ec));const _0x268a19=new URLSearchParams({'api_key':this[_0x37956e(0x1e1)],'txn_id':_0xba1245}),_0x628ec9=_0x37956e(0x1b1)+_0xba1245+'?'+_0x268a19[_0x37956e(0x223)]();loggerService_1['loggerService'][_0x37956e(0x1f5)](_0x37956e(0x1fb),_0x37956e(0x1d0)+_0xba1245,_0x37956e(0x1d3),Object[_0x37956e(0x1e9)](_0x268a19[_0x37956e(0x1b8)]()));const _0x4a3799=await fetch(_0x628ec9,{'method':_0x37956e(0x1d3),'headers':{'Accept':_0x37956e(0x210),'User-Agent':_0x37956e(0x1b5)}}),_0x2326da=Date[_0x37956e(0x21f)]()-_0x4acaaf;if(!_0x4a3799['ok']){const _0x5ba562=await _0x4a3799[_0x37956e(0x1bb)]();loggerService_1['loggerService']['logWhiteDomainResponse'](_0x37956e(0x1fb),'/operations/'+_0xba1245,_0x4a3799[_0x37956e(0x1c2)],_0x5ba562,_0x2326da);throw new Error(_0x37956e(0x222)+_0x4a3799['status']);}const _0x56f88b=await _0x4a3799['json']();loggerService_1[_0x37956e(0x1ba)][_0x37956e(0x1f9)](_0x37956e(0x1fb),_0x37956e(0x1d0)+_0xba1245,_0x4a3799['status'],_0x56f88b,_0x2326da);if(_0x56f88b[_0x37956e(0x1c2)]!==_0x37956e(0x208)){loggerService_1[_0x37956e(0x1ba)]['logWhiteDomainError'](_0x37956e(0x1fb),_0x37956e(0x1d0)+_0xba1245,'Plisio\x20API\x20error:\x20'+(_0x56f88b[_0x37956e(0x1d8)]||_0x56f88b[_0x37956e(0x20c)]||_0x37956e(0x1af)));throw new Error(_0x37956e(0x209)+(_0x56f88b['message']||_0x56f88b[_0x37956e(0x20c)]||_0x37956e(0x1af)));}let _0x242337=_0x37956e(0x1dd);return{'status':_0x242337};}catch(_0x4ab0a8){console[_0x37956e(0x20c)](_0x37956e(0x1ee),_0x4ab0a8),loggerService_1[_0x37956e(0x1ba)][_0x37956e(0x211)](_0x37956e(0x1fb),_0x37956e(0x1d0)+_0xba1245,_0x4ab0a8);throw new Error(_0x37956e(0x1eb)+(_0x4ab0a8 instanceof Error?_0x4ab0a8[_0x37956e(0x1d8)]:_0x37956e(0x1af)));}}async[a41_0x2159c6(0x1ef)](_0x382373){const _0x25ed75=a41_0x2159c6;console[_0x25ed75(0x1f7)]('Processing\x20Plisio\x20webhook:',_0x382373);let _0x54491b='PENDING';switch(_0x382373[_0x25ed75(0x1c2)]?.[_0x25ed75(0x219)]()){case _0x25ed75(0x1b6):case _0x25ed75(0x1ed):_0x54491b=_0x25ed75(0x1e6);break;case'expired':_0x54491b='EXPIRED';break;case _0x25ed75(0x20c):case'cancelled':_0x54491b=_0x25ed75(0x1c6);break;case _0x25ed75(0x1f6):case _0x25ed75(0x1b2):default:_0x54491b='PENDING';break;}let _0x557af5;if(_0x382373[_0x25ed75(0x1b7)])try{console[_0x25ed75(0x1f7)]('üîó\x20Raw\x20tx_urls\x20from\x20Plisio:',_0x382373['tx_urls']);let _0x1169eb;if(typeof _0x382373[_0x25ed75(0x1b7)]===_0x25ed75(0x224))_0x1169eb=JSON[_0x25ed75(0x1e5)](_0x382373[_0x25ed75(0x1b7)]);else Array[_0x25ed75(0x1fe)](_0x382373[_0x25ed75(0x1b7)])?_0x1169eb=_0x382373[_0x25ed75(0x1b7)]:_0x1169eb=[];_0x557af5=_0x1169eb[_0x25ed75(0x1de)](_0x10f8ad=>{const _0x513023=_0x25ed75,_0x298d04=_0x10f8ad['replace'](/\\/g,'');return console[_0x513023(0x1f7)](_0x513023(0x218)+_0x10f8ad+'\x20->\x20'+_0x298d04),_0x298d04;}),console[_0x25ed75(0x1f7)]('‚úÖ\x20Processed\x20tx_urls:',_0x557af5),_0x557af5['forEach']((_0x2a77c1,_0x15876c)=>{const _0x5683f3=_0x25ed75;try{new URL(_0x2a77c1),console[_0x5683f3(0x1f7)](_0x5683f3(0x1f2)+(_0x15876c+0x1)+_0x5683f3(0x1ff)+_0x2a77c1);}catch(_0x4687ab){console[_0x5683f3(0x20c)](_0x5683f3(0x1f8)+(_0x15876c+0x1)+_0x5683f3(0x20f)+_0x2a77c1,_0x4687ab);}});}catch(_0x4a067a){console[_0x25ed75(0x20c)](_0x25ed75(0x215),_0x4a067a),console[_0x25ed75(0x20c)]('Raw\x20tx_urls\x20data:',_0x382373[_0x25ed75(0x1b7)]),_0x557af5=undefined;}return{'paymentId':_0x382373[_0x25ed75(0x1cc)]||'','status':_0x54491b,'amount':_0x382373['amount'],'currency':_0x382373[_0x25ed75(0x1fc)],'txUrls':_0x557af5};}}exports[a41_0x2159c6(0x1e2)]=PlisioService;