'use strict';const a44_0x36eff6=a44_0x4d49;(function(_0x22ac3a,_0x4f4cf4){const _0x394c71=a44_0x4d49,_0xc81da1=_0x22ac3a();while(!![]){try{const _0x27a04e=-parseInt(_0x394c71(0x123))/0x1+parseInt(_0x394c71(0x176))/0x2*(-parseInt(_0x394c71(0x14c))/0x3)+-parseInt(_0x394c71(0x189))/0x4+-parseInt(_0x394c71(0x18e))/0x5+-parseInt(_0x394c71(0x17a))/0x6*(parseInt(_0x394c71(0x198))/0x7)+parseInt(_0x394c71(0x16d))/0x8*(parseInt(_0x394c71(0x175))/0x9)+parseInt(_0x394c71(0x170))/0xa;if(_0x27a04e===_0x4f4cf4)break;else _0xc81da1['push'](_0xc81da1['shift']());}catch(_0x346367){_0xc81da1['push'](_0xc81da1['shift']());}}}(a44_0x5bc6,0x841d8));function a44_0x4d49(_0x1b942d,_0x45896e){const _0x5bc687=a44_0x5bc6();return a44_0x4d49=function(_0x4d4949,_0x59e59b){_0x4d4949=_0x4d4949-0x122;let _0x1e68d1=_0x5bc687[_0x4d4949];return _0x1e68d1;},a44_0x4d49(_0x1b942d,_0x45896e);}function a44_0x5bc6(){const _0xf4475a=['now','PlisioService','pending','Raw\x20tx_urls\x20data:','invoice_url','/operations/','616mTKIng','Status:','qr_code','33360960FpBvgP','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','HTTP\x20','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','Unknown\x20error','74565pFLLUw','248798CUNQsl','currency','entries','__esModule','6NPOreB','\x20is\x20valid:\x20','stack','processWebhook','string','parse','data','Error\x20details:','Business\x20Error:\x20','GET','Transaction\x20ID:','Invoice\x20URL:','replace','Error\x20Message:','🔗\x20Raw\x20tx_urls\x20from\x20Plisio:','3344296snHgYT','/invoices/new','❌\x20Failed\x20to\x20parse\x20tx_urls:','completed','FAILED','5392270LAderz','statusText','loggerService','PROCESSING','status','Response\x20Body:','order_number','⚠️\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','https://api.trapay.uk/api/webhooks/gateway/plisio','tx_urls','511553uXYhRy','apiUrl','1072093OLYMZC','expired','amount','Error\x20stack:','\x20->\x20','forEach','toString','stringify','logWhiteDomainResponse','success','append','warn','Error\x20message:','cancelled','json','Plisio\x20API\x20error:\x20','env','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','HIDDEN','Response\x20data:','Parsed\x20Result:','Unknown\x20error\x20from\x20Plisio\x20API','plisio_direct','PAID','\x20is\x20invalid:\x20','createPayment','===\x20PLISIO\x20SUCCESS\x20===','fromEntries','HTTP\x20Status:','Amount:','PENDING','email','Plisio\x20payment\x20verification\x20error:','logWhiteDomainRequest','===\x20PLISIO\x20API\x20ERROR\x20===','EXPIRED','map','new','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','Source\x20Currency:','text','9MwKdCh','Failed\x20to\x20create\x20Plisio\x20payment:\x20','apiKey','Plisio\x20API\x20key\x20is\x20not\x20configured','message','toLowerCase','🔗\x20Formatted\x20URL:\x20','error','mismatch','TesSoft\x20Payment\x20System/1.0','log','https://api.plisio.net/api/v1/operations/','invoice_total_sum','txn_id','application/json','Processing\x20Plisio\x20webhook:','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','Failed\x20to\x20parse\x20JSON\x20response:','Response\x20Time:','logWhiteDomainError','source_currency','💰\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','JSON\x20Parse\x20Error:\x20','Full\x20URL\x20(without\x20API\x20key):','name','isArray','HTTP\x20error!\x20status:\x20'];a44_0x5bc6=function(){return _0xf4475a;};return a44_0x5bc6();}Object['defineProperty'](exports,a44_0x36eff6(0x179),{'value':!![]}),exports[a44_0x36eff6(0x168)]=void 0x0;const loggerService_1=require('../loggerService');class PlisioService{constructor(){const _0x17459f=a44_0x36eff6;this[_0x17459f(0x122)]='https://api.plisio.net/api/v1/invoices/new',this[_0x17459f(0x14e)]=process[_0x17459f(0x133)]['PLISIO_API_KEY']||'',!this[_0x17459f(0x14e)]?console[_0x17459f(0x12e)](_0x17459f(0x195)):console[_0x17459f(0x156)](_0x17459f(0x161));}async[a44_0x36eff6(0x13c)](_0x5c5b03){const _0x2b0b96=a44_0x36eff6,{orderId:_0x2ded36,amount:_0x281442,currency:_0x4a9669,productName:_0x1f9d97,description:_0x332712,successUrl:_0x5d0846,failUrl:_0xddd1d2,customerEmail:_0x44c1c6,customerName:_0x4fec80,isSourceCurrency:_0x5f2620,sourceCurrency:_0x58b33e}=_0x5c5b03;if(!this[_0x2b0b96(0x14e)])throw new Error(_0x2b0b96(0x14f));const _0x277773=new URLSearchParams({'api_key':this['apiKey'],'order_number':_0x2ded36,'order_name':_0x1f9d97,'description':_0x332712,'success_url':_0x5d0846,'fail_url':_0xddd1d2,'callback_url':_0x2b0b96(0x196)});_0x58b33e?(_0x277773[_0x2b0b96(0x12d)](_0x2b0b96(0x177),_0x58b33e),_0x277773[_0x2b0b96(0x12d)](_0x2b0b96(0x160),_0x4a9669),_0x277773[_0x2b0b96(0x12d)]('source_amount',_0x281442[_0x2b0b96(0x129)]())):(_0x277773[_0x2b0b96(0x12d)](_0x2b0b96(0x177),_0x4a9669),_0x277773[_0x2b0b96(0x12d)]('amount',_0x281442['toString']()));_0x44c1c6&&_0x277773[_0x2b0b96(0x12d)](_0x2b0b96(0x142),_0x44c1c6);_0x4fec80&&_0x277773['append'](_0x2b0b96(0x164),_0x4fec80);const _0x38239f=this['apiUrl']+'?'+_0x277773['toString'](),_0x1187a9=Date[_0x2b0b96(0x167)]();try{console['log']('===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20==='),console['log']('URL:',this[_0x2b0b96(0x122)]),console[_0x2b0b96(0x156)]('Parameters:',Object[_0x2b0b96(0x13e)](_0x277773[_0x2b0b96(0x178)]())),console[_0x2b0b96(0x156)](_0x2b0b96(0x163),_0x38239f[_0x2b0b96(0x186)](this[_0x2b0b96(0x14e)],_0x2b0b96(0x135))),loggerService_1[_0x2b0b96(0x190)][_0x2b0b96(0x144)]('plisio_direct',_0x2b0b96(0x18a),'GET',Object[_0x2b0b96(0x13e)](_0x277773[_0x2b0b96(0x178)]()));const _0x18fb39=await fetch(_0x38239f,{'method':_0x2b0b96(0x183),'headers':{'Accept':_0x2b0b96(0x15a),'User-Agent':_0x2b0b96(0x155)}}),_0x20859b=Date['now']()-_0x1187a9;console['log']('===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20==='),console[_0x2b0b96(0x156)](_0x2b0b96(0x16e),_0x18fb39[_0x2b0b96(0x192)]),console['log']('Status\x20Text:',_0x18fb39[_0x2b0b96(0x18f)]),console[_0x2b0b96(0x156)](_0x2b0b96(0x15e),_0x20859b+'ms');const _0x2a52fa=await _0x18fb39[_0x2b0b96(0x14b)]();console[_0x2b0b96(0x156)]('Raw\x20Response\x20Body:',_0x2a52fa);if(!_0x18fb39['ok']){console[_0x2b0b96(0x153)](_0x2b0b96(0x145)),console[_0x2b0b96(0x153)](_0x2b0b96(0x13f),_0x18fb39[_0x2b0b96(0x192)]),console[_0x2b0b96(0x153)](_0x2b0b96(0x193),_0x2a52fa),loggerService_1[_0x2b0b96(0x190)][_0x2b0b96(0x12b)]('plisio_direct',_0x2b0b96(0x18a),_0x18fb39[_0x2b0b96(0x192)],_0x2a52fa,_0x20859b),loggerService_1[_0x2b0b96(0x190)][_0x2b0b96(0x15f)](_0x2b0b96(0x139),'/invoices/new',_0x2b0b96(0x172)+_0x18fb39[_0x2b0b96(0x192)]+':\x20'+_0x2a52fa);throw new Error('HTTP\x20error!\x20status:\x20'+_0x18fb39[_0x2b0b96(0x192)]+',\x20body:\x20'+_0x2a52fa);}let _0x59530d;try{_0x59530d=JSON['parse'](_0x2a52fa);}catch(_0x984476){console['error'](_0x2b0b96(0x15d),_0x984476),loggerService_1[_0x2b0b96(0x190)][_0x2b0b96(0x15f)](_0x2b0b96(0x139),_0x2b0b96(0x18a),_0x2b0b96(0x162)+_0x984476);throw new Error(_0x2b0b96(0x149)+_0x2a52fa);}console[_0x2b0b96(0x156)](_0x2b0b96(0x15c)),console[_0x2b0b96(0x156)](_0x2b0b96(0x137),JSON[_0x2b0b96(0x12a)](_0x59530d,null,0x2)),loggerService_1[_0x2b0b96(0x190)][_0x2b0b96(0x12b)](_0x2b0b96(0x139),_0x2b0b96(0x18a),_0x18fb39[_0x2b0b96(0x192)],_0x59530d,_0x20859b);if(_0x59530d[_0x2b0b96(0x192)]!==_0x2b0b96(0x12c)){const _0x3dbbed=_0x59530d[_0x2b0b96(0x150)]||_0x59530d['error']||_0x2b0b96(0x138);console[_0x2b0b96(0x153)]('===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x2b0b96(0x153)](_0x2b0b96(0x187),_0x3dbbed),loggerService_1[_0x2b0b96(0x190)][_0x2b0b96(0x15f)](_0x2b0b96(0x139),_0x2b0b96(0x18a),_0x2b0b96(0x182)+_0x3dbbed);throw new Error('Plisio\x20API\x20error:\x20'+_0x3dbbed);}if(!_0x59530d['data']?.[_0x2b0b96(0x159)]||!_0x59530d[_0x2b0b96(0x180)]?.[_0x2b0b96(0x16b)]){console[_0x2b0b96(0x153)]('===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x2b0b96(0x153)](_0x2b0b96(0x173)),console[_0x2b0b96(0x153)](_0x2b0b96(0x136),_0x59530d['data']),loggerService_1[_0x2b0b96(0x190)][_0x2b0b96(0x15f)](_0x2b0b96(0x139),_0x2b0b96(0x18a),'Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url');throw new Error(_0x2b0b96(0x134));}return console[_0x2b0b96(0x156)](_0x2b0b96(0x13d)),console[_0x2b0b96(0x156)](_0x2b0b96(0x184),_0x59530d['data'][_0x2b0b96(0x159)]),console[_0x2b0b96(0x156)](_0x2b0b96(0x185),_0x59530d[_0x2b0b96(0x180)][_0x2b0b96(0x16b)]),console[_0x2b0b96(0x156)](_0x2b0b96(0x140),_0x281442,_0x4a9669),_0x58b33e&&(console[_0x2b0b96(0x156)](_0x2b0b96(0x14a),_0x58b33e,'(crypto\x20for\x20payment)'),console['log']('Target\x20Currency:',_0x4a9669,'(fiat\x20for\x20merchant)')),{'gateway_payment_id':_0x59530d['data'][_0x2b0b96(0x159)],'payment_url':_0x59530d[_0x2b0b96(0x180)][_0x2b0b96(0x16b)],'invoice_total_sum':_0x59530d[_0x2b0b96(0x180)][_0x2b0b96(0x158)],'qr_code':_0x59530d[_0x2b0b96(0x180)][_0x2b0b96(0x16f)],'qr_url':_0x59530d[_0x2b0b96(0x180)]['qr_url']};}catch(_0x3a483d){console['error'](_0x2b0b96(0x171)),console[_0x2b0b96(0x153)](_0x2b0b96(0x181),_0x3a483d),loggerService_1[_0x2b0b96(0x190)][_0x2b0b96(0x15f)]('plisio_direct',_0x2b0b96(0x18a),_0x3a483d);if(_0x3a483d instanceof Error){console[_0x2b0b96(0x153)](_0x2b0b96(0x12f),_0x3a483d[_0x2b0b96(0x150)]),console[_0x2b0b96(0x153)](_0x2b0b96(0x126),_0x3a483d[_0x2b0b96(0x17c)]);throw new Error(_0x2b0b96(0x14d)+_0x3a483d['message']);}throw new Error('Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error');}}async['verifyPayment'](_0x3d1636){const _0x317c64=a44_0x36eff6,_0x368e59=Date[_0x317c64(0x167)]();try{if(!this['apiKey'])throw new Error('Plisio\x20API\x20key\x20is\x20not\x20configured');const _0x319bfd=new URLSearchParams({'api_key':this[_0x317c64(0x14e)],'txn_id':_0x3d1636}),_0x210759=_0x317c64(0x157)+_0x3d1636+'?'+_0x319bfd[_0x317c64(0x129)]();loggerService_1['loggerService'][_0x317c64(0x144)](_0x317c64(0x139),'/operations/'+_0x3d1636,_0x317c64(0x183),Object[_0x317c64(0x13e)](_0x319bfd['entries']()));const _0x56f786=await fetch(_0x210759,{'method':_0x317c64(0x183),'headers':{'Accept':'application/json','User-Agent':_0x317c64(0x155)}}),_0x39d8cd=Date['now']()-_0x368e59;if(!_0x56f786['ok']){const _0x2fa5cf=await _0x56f786[_0x317c64(0x14b)]();loggerService_1[_0x317c64(0x190)][_0x317c64(0x12b)]('plisio_direct',_0x317c64(0x16c)+_0x3d1636,_0x56f786['status'],_0x2fa5cf,_0x39d8cd);throw new Error(_0x317c64(0x166)+_0x56f786[_0x317c64(0x192)]);}const _0x279698=await _0x56f786[_0x317c64(0x131)]();loggerService_1[_0x317c64(0x190)][_0x317c64(0x12b)]('plisio_direct',_0x317c64(0x16c)+_0x3d1636,_0x56f786[_0x317c64(0x192)],_0x279698,_0x39d8cd);if(_0x279698[_0x317c64(0x192)]!=='success'){loggerService_1[_0x317c64(0x190)][_0x317c64(0x15f)](_0x317c64(0x139),_0x317c64(0x16c)+_0x3d1636,_0x317c64(0x132)+(_0x279698['message']||_0x279698[_0x317c64(0x153)]||_0x317c64(0x174)));throw new Error(_0x317c64(0x132)+(_0x279698[_0x317c64(0x150)]||_0x279698['error']||'Unknown\x20error'));}let _0x12a373=_0x317c64(0x141);return{'status':_0x12a373};}catch(_0x5d2d8e){console[_0x317c64(0x153)](_0x317c64(0x143),_0x5d2d8e),loggerService_1[_0x317c64(0x190)][_0x317c64(0x15f)]('plisio_direct',_0x317c64(0x16c)+_0x3d1636,_0x5d2d8e);throw new Error('Failed\x20to\x20verify\x20Plisio\x20payment:\x20'+(_0x5d2d8e instanceof Error?_0x5d2d8e[_0x317c64(0x150)]:'Unknown\x20error'));}}async[a44_0x36eff6(0x17d)](_0x2a2b75){const _0x379957=a44_0x36eff6;console[_0x379957(0x156)](_0x379957(0x15b),_0x2a2b75);let _0x4caab3=_0x379957(0x141);switch(_0x2a2b75[_0x379957(0x192)]?.[_0x379957(0x151)]()){case _0x379957(0x18c):case _0x379957(0x154):_0x4caab3=_0x379957(0x13a);break;case _0x379957(0x124):_0x4caab3=_0x379957(0x146);break;case'error':case _0x379957(0x130):_0x4caab3=_0x379957(0x18d);break;case _0x379957(0x148):_0x4caab3=_0x379957(0x141);break;case _0x379957(0x169):_0x4caab3=_0x379957(0x191);break;default:_0x4caab3=_0x379957(0x141);break;}let _0x3acb1d;if(_0x2a2b75[_0x379957(0x197)])try{console[_0x379957(0x156)](_0x379957(0x188),_0x2a2b75['tx_urls']);let _0x1aaba1;if(typeof _0x2a2b75[_0x379957(0x197)]===_0x379957(0x17e))_0x1aaba1=JSON[_0x379957(0x17f)](_0x2a2b75[_0x379957(0x197)]);else Array[_0x379957(0x165)](_0x2a2b75['tx_urls'])?_0x1aaba1=_0x2a2b75[_0x379957(0x197)]:_0x1aaba1=[];_0x3acb1d=_0x1aaba1[_0x379957(0x147)](_0xdc831c=>{const _0xb5fc79=_0x379957,_0x3f8969=_0xdc831c[_0xb5fc79(0x186)](/\\/g,'');return console[_0xb5fc79(0x156)](_0xb5fc79(0x152)+_0xdc831c+_0xb5fc79(0x127)+_0x3f8969),_0x3f8969;}),console[_0x379957(0x156)]('✅\x20Processed\x20tx_urls:',_0x3acb1d),_0x3acb1d[_0x379957(0x128)]((_0x300769,_0xcba359)=>{const _0x35ba1c=_0x379957;try{new URL(_0x300769),console[_0x35ba1c(0x156)]('✅\x20URL\x20'+(_0xcba359+0x1)+_0x35ba1c(0x17b)+_0x300769);}catch(_0x387f60){console[_0x35ba1c(0x153)]('❌\x20URL\x20'+(_0xcba359+0x1)+_0x35ba1c(0x13b)+_0x300769,_0x387f60);}});}catch(_0x46e4ea){console[_0x379957(0x153)](_0x379957(0x18b),_0x46e4ea),console['error'](_0x379957(0x16a),_0x2a2b75[_0x379957(0x197)]),_0x3acb1d=undefined;}return{'paymentId':_0x2a2b75[_0x379957(0x194)]||'','status':_0x4caab3,'amount':_0x2a2b75[_0x379957(0x125)],'currency':_0x2a2b75['currency'],'txUrls':_0x3acb1d};}}exports[a44_0x36eff6(0x168)]=PlisioService;