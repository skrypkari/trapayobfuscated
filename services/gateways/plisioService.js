'use strict';const a44_0x38ed98=a44_0x11e7;(function(_0x14e667,_0x3bffe7){const _0x1732af=a44_0x11e7,_0x54b944=_0x14e667();while(!![]){try{const _0x4452a4=-parseInt(_0x1732af(0xe1))/0x1+parseInt(_0x1732af(0x86))/0x2*(parseInt(_0x1732af(0xc8))/0x3)+parseInt(_0x1732af(0xca))/0x4*(-parseInt(_0x1732af(0x96))/0x5)+-parseInt(_0x1732af(0xb2))/0x6+-parseInt(_0x1732af(0xc6))/0x7*(parseInt(_0x1732af(0x83))/0x8)+parseInt(_0x1732af(0xed))/0x9*(-parseInt(_0x1732af(0xdc))/0xa)+parseInt(_0x1732af(0xf0))/0xb;if(_0x4452a4===_0x3bffe7)break;else _0x54b944['push'](_0x54b944['shift']());}catch(_0x4df002){_0x54b944['push'](_0x54b944['shift']());}}}(a44_0x3d15,0x2bc3b));Object[a44_0x38ed98(0x84)](exports,'__esModule',{'value':!![]}),exports['PlisioService']=void 0x0;const loggerService_1=require('../loggerService');function a44_0x3d15(){const _0x2e0b06=['tx_urls','Response\x20data:','HIDDEN','data','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','‚ùå\x20URL\x20','success','840582rtAyAU','HTTP\x20error!\x20status:\x20','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','logWhiteDomainResponse','source_currency','Raw\x20tx_urls\x20data:','Parameters:','completed','qr_url','message','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','HTTP\x20Status:','(crypto\x20for\x20payment)','string','error','URL:','‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','Error\x20stack:','üîó\x20Formatted\x20URL:\x20','Parsed\x20Result:','165494PsGYFb','source_amount','321132hnMlJe','log','300RmrEHV','Response\x20Body:','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','txn_id','üîó\x20Raw\x20tx_urls\x20from\x20Plisio:','mismatch',',\x20body:\x20','Target\x20Currency:','apiKey','qr_code','\x20is\x20invalid:\x20','plisio_direct','Unknown\x20error\x20from\x20Plisio\x20API','https://api.plisio.net/api/v1/operations/','application/json','fromEntries','/invoices/new','append','1450asRiyj','https://api.plisio.net/api/v1/invoices/new','logWhiteDomainRequest','cancelled','text','83999LgKZDu','Error\x20details:','createPayment','Failed\x20to\x20parse\x20JSON\x20response:','apiUrl','now','warn','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','===\x20PLISIO\x20SUCCESS\x20===','PLISIO_API_KEY','\x20->\x20','invoice_total_sum','3231ZnWdfn','Business\x20Error:\x20','üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','7659421mQbhFJ','PAID','Error\x20Message:','stack','map','TesSoft\x20Payment\x20System/1.0','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','Unknown\x20error','80sBoiwy','defineProperty','new','2ccTIqr','parse','PlisioService','Plisio\x20API\x20key\x20is\x20not\x20configured','Plisio\x20API\x20error:\x20','toLowerCase','PENDING','currency','\x20is\x20valid:\x20','env','GET','logWhiteDomainError','HTTP\x20','name','replace','‚ùå\x20Failed\x20to\x20parse\x20tx_urls:','7435YoUiEB','toString','‚úÖ\x20Processed\x20tx_urls:','Raw\x20Response\x20Body:','Full\x20URL\x20(without\x20API\x20key):','loggerService','entries','status','===\x20PLISIO\x20API\x20ERROR\x20===','Status:','invoice_url','Error\x20message:','Source\x20Currency:','/operations/','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','amount','processWebhook','forEach','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','Plisio\x20payment\x20verification\x20error:','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20==='];a44_0x3d15=function(){return _0x2e0b06;};return a44_0x3d15();}function a44_0x11e7(_0x3d67a9,_0x106e47){const _0x3d15fc=a44_0x3d15();return a44_0x11e7=function(_0x11e79a,_0x235301){_0x11e79a=_0x11e79a-0x80;let _0x2691b0=_0x3d15fc[_0x11e79a];return _0x2691b0;},a44_0x11e7(_0x3d67a9,_0x106e47);}class PlisioService{constructor(){const _0x2f3f9c=a44_0x38ed98;this[_0x2f3f9c(0xe5)]=_0x2f3f9c(0xdd),this[_0x2f3f9c(0xd2)]=process[_0x2f3f9c(0x8f)][_0x2f3f9c(0xea)]||'',!this[_0x2f3f9c(0xd2)]?console[_0x2f3f9c(0xe7)](_0x2f3f9c(0xc2)):console[_0x2f3f9c(0xc9)](_0x2f3f9c(0xef));}async[a44_0x38ed98(0xe3)](_0x452179){const _0x77f489=a44_0x38ed98,{orderId:_0x100381,amount:_0x2d2fec,currency:_0x2f8312,productName:_0x15c142,description:_0x5b6337,successUrl:_0x22ccbd,failUrl:_0x66f3c6,customerEmail:_0x287229,customerName:_0x1f9e5c,isSourceCurrency:_0x10c303,sourceCurrency:_0x5bd55a}=_0x452179;if(!this[_0x77f489(0xd2)])throw new Error(_0x77f489(0x89));const _0x578b61=new URLSearchParams({'api_key':this[_0x77f489(0xd2)],'order_number':_0x100381,'order_name':_0x15c142,'description':_0x5b6337,'success_url':_0x22ccbd,'fail_url':_0x66f3c6,'callback_url':'https://apitest.trapay.uk/api/webhooks/gateway/plisio'});_0x5bd55a?(_0x578b61[_0x77f489(0xdb)](_0x77f489(0x8d),_0x5bd55a),_0x578b61[_0x77f489(0xdb)](_0x77f489(0xb6),_0x2f8312),_0x578b61[_0x77f489(0xdb)](_0x77f489(0xc7),_0x2d2fec[_0x77f489(0x97)]())):(_0x578b61[_0x77f489(0xdb)](_0x77f489(0x8d),_0x2f8312),_0x578b61[_0x77f489(0xdb)](_0x77f489(0xa5),_0x2d2fec[_0x77f489(0x97)]()));_0x287229&&_0x578b61[_0x77f489(0xdb)]('email',_0x287229);_0x1f9e5c&&_0x578b61[_0x77f489(0xdb)](_0x77f489(0x93),_0x1f9e5c);const _0x1ce5e0=this[_0x77f489(0xe5)]+'?'+_0x578b61[_0x77f489(0x97)](),_0x27c285=Date[_0x77f489(0xe6)]();try{console[_0x77f489(0xc9)](_0x77f489(0xaa)),console['log'](_0x77f489(0xc1),this[_0x77f489(0xe5)]),console[_0x77f489(0xc9)](_0x77f489(0xb8),Object[_0x77f489(0xd9)](_0x578b61['entries']())),console[_0x77f489(0xc9)](_0x77f489(0x9a),_0x1ce5e0[_0x77f489(0x94)](this['apiKey'],_0x77f489(0xad))),loggerService_1['loggerService'][_0x77f489(0xde)](_0x77f489(0xd5),'/invoices/new',_0x77f489(0x90),Object[_0x77f489(0xd9)](_0x578b61['entries']()));const _0x2c72bc=await fetch(_0x1ce5e0,{'method':'GET','headers':{'Accept':'application/json','User-Agent':_0x77f489(0x80)}}),_0x46fa0d=Date[_0x77f489(0xe6)]()-_0x27c285;console[_0x77f489(0xc9)](_0x77f489(0xbc)),console[_0x77f489(0xc9)](_0x77f489(0x9f),_0x2c72bc[_0x77f489(0x9d)]),console['log']('Status\x20Text:',_0x2c72bc['statusText']),console['log']('Response\x20Time:',_0x46fa0d+'ms');const _0x51d1ec=await _0x2c72bc[_0x77f489(0xe0)]();console[_0x77f489(0xc9)](_0x77f489(0x99),_0x51d1ec);if(!_0x2c72bc['ok']){console[_0x77f489(0xc0)](_0x77f489(0x9e)),console[_0x77f489(0xc0)](_0x77f489(0xbd),_0x2c72bc['status']),console[_0x77f489(0xc0)](_0x77f489(0xcb),_0x51d1ec),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x77f489(0xd5),_0x77f489(0xda),_0x2c72bc[_0x77f489(0x9d)],_0x51d1ec,_0x46fa0d),loggerService_1[_0x77f489(0x9b)][_0x77f489(0x91)]('plisio_direct',_0x77f489(0xda),_0x77f489(0x92)+_0x2c72bc['status']+':\x20'+_0x51d1ec);throw new Error(_0x77f489(0xb3)+_0x2c72bc[_0x77f489(0x9d)]+_0x77f489(0xd0)+_0x51d1ec);}let _0x313f5d;try{_0x313f5d=JSON[_0x77f489(0x87)](_0x51d1ec);}catch(_0x3ee556){console[_0x77f489(0xc0)](_0x77f489(0xe4),_0x3ee556),loggerService_1[_0x77f489(0x9b)][_0x77f489(0x91)](_0x77f489(0xd5),'/invoices/new','JSON\x20Parse\x20Error:\x20'+_0x3ee556);throw new Error(_0x77f489(0xa4)+_0x51d1ec);}console[_0x77f489(0xc9)](_0x77f489(0xb4)),console['log'](_0x77f489(0xc5),JSON['stringify'](_0x313f5d,null,0x2)),loggerService_1[_0x77f489(0x9b)]['logWhiteDomainResponse']('plisio_direct','/invoices/new',_0x2c72bc[_0x77f489(0x9d)],_0x313f5d,_0x46fa0d);if(_0x313f5d[_0x77f489(0x9d)]!==_0x77f489(0xb1)){const _0xc0862a=_0x313f5d[_0x77f489(0xbb)]||_0x313f5d[_0x77f489(0xc0)]||_0x77f489(0xd6);console[_0x77f489(0xc0)](_0x77f489(0xcc)),console[_0x77f489(0xc0)](_0x77f489(0xf2),_0xc0862a),loggerService_1['loggerService'][_0x77f489(0x91)](_0x77f489(0xd5),_0x77f489(0xda),_0x77f489(0xee)+_0xc0862a);throw new Error('Plisio\x20API\x20error:\x20'+_0xc0862a);}if(!_0x313f5d[_0x77f489(0xae)]?.[_0x77f489(0xcd)]||!_0x313f5d[_0x77f489(0xae)]?.[_0x77f489(0xa0)]){console['error']('===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x77f489(0xc0)](_0x77f489(0xaf)),console[_0x77f489(0xc0)](_0x77f489(0xac),_0x313f5d[_0x77f489(0xae)]),loggerService_1[_0x77f489(0x9b)][_0x77f489(0x91)]('plisio_direct','/invoices/new','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url');throw new Error(_0x77f489(0xa8));}return console[_0x77f489(0xc9)](_0x77f489(0xe9)),console['log']('Transaction\x20ID:',_0x313f5d[_0x77f489(0xae)][_0x77f489(0xcd)]),console['log']('Invoice\x20URL:',_0x313f5d[_0x77f489(0xae)][_0x77f489(0xa0)]),console['log']('Amount:',_0x2d2fec,_0x2f8312),_0x5bd55a&&(console['log'](_0x77f489(0xa2),_0x5bd55a,_0x77f489(0xbe)),console[_0x77f489(0xc9)](_0x77f489(0xd1),_0x2f8312,'(fiat\x20for\x20merchant)')),{'gateway_payment_id':_0x313f5d[_0x77f489(0xae)][_0x77f489(0xcd)],'payment_url':_0x313f5d['data']['invoice_url'],'invoice_total_sum':_0x313f5d['data'][_0x77f489(0xec)],'qr_code':_0x313f5d[_0x77f489(0xae)][_0x77f489(0xd3)],'qr_url':_0x313f5d[_0x77f489(0xae)][_0x77f489(0xba)]};}catch(_0xf3b6ef){console[_0x77f489(0xc0)](_0x77f489(0x81)),console[_0x77f489(0xc0)](_0x77f489(0xe2),_0xf3b6ef),loggerService_1[_0x77f489(0x9b)][_0x77f489(0x91)](_0x77f489(0xd5),'/invoices/new',_0xf3b6ef);if(_0xf3b6ef instanceof Error){console[_0x77f489(0xc0)](_0x77f489(0xa1),_0xf3b6ef[_0x77f489(0xbb)]),console[_0x77f489(0xc0)](_0x77f489(0xc3),_0xf3b6ef[_0x77f489(0xf3)]);throw new Error('Failed\x20to\x20create\x20Plisio\x20payment:\x20'+_0xf3b6ef['message']);}throw new Error(_0x77f489(0xe8));}}async['verifyPayment'](_0x468ae1){const _0x3b3877=a44_0x38ed98,_0x50139e=Date['now']();try{if(!this[_0x3b3877(0xd2)])throw new Error('Plisio\x20API\x20key\x20is\x20not\x20configured');const _0x4b74d7=new URLSearchParams({'api_key':this[_0x3b3877(0xd2)],'txn_id':_0x468ae1}),_0x121fe1=_0x3b3877(0xd7)+_0x468ae1+'?'+_0x4b74d7[_0x3b3877(0x97)]();loggerService_1[_0x3b3877(0x9b)][_0x3b3877(0xde)](_0x3b3877(0xd5),_0x3b3877(0xa3)+_0x468ae1,_0x3b3877(0x90),Object[_0x3b3877(0xd9)](_0x4b74d7[_0x3b3877(0x9c)]()));const _0x128035=await fetch(_0x121fe1,{'method':_0x3b3877(0x90),'headers':{'Accept':_0x3b3877(0xd8),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x29164e=Date[_0x3b3877(0xe6)]()-_0x50139e;if(!_0x128035['ok']){const _0x29db4e=await _0x128035[_0x3b3877(0xe0)]();loggerService_1[_0x3b3877(0x9b)]['logWhiteDomainResponse'](_0x3b3877(0xd5),_0x3b3877(0xa3)+_0x468ae1,_0x128035[_0x3b3877(0x9d)],_0x29db4e,_0x29164e);throw new Error(_0x3b3877(0xb3)+_0x128035['status']);}const _0x452bcc=await _0x128035['json']();loggerService_1['loggerService'][_0x3b3877(0xb5)](_0x3b3877(0xd5),_0x3b3877(0xa3)+_0x468ae1,_0x128035[_0x3b3877(0x9d)],_0x452bcc,_0x29164e);if(_0x452bcc[_0x3b3877(0x9d)]!==_0x3b3877(0xb1)){loggerService_1[_0x3b3877(0x9b)][_0x3b3877(0x91)](_0x3b3877(0xd5),_0x3b3877(0xa3)+_0x468ae1,_0x3b3877(0x8a)+(_0x452bcc[_0x3b3877(0xbb)]||_0x452bcc[_0x3b3877(0xc0)]||_0x3b3877(0x82)));throw new Error(_0x3b3877(0x8a)+(_0x452bcc[_0x3b3877(0xbb)]||_0x452bcc[_0x3b3877(0xc0)]||'Unknown\x20error'));}let _0x25a457=_0x3b3877(0x8c);return{'status':_0x25a457};}catch(_0x200e61){console['error'](_0x3b3877(0xa9),_0x200e61),loggerService_1[_0x3b3877(0x9b)][_0x3b3877(0x91)](_0x3b3877(0xd5),_0x3b3877(0xa3)+_0x468ae1,_0x200e61);throw new Error('Failed\x20to\x20verify\x20Plisio\x20payment:\x20'+(_0x200e61 instanceof Error?_0x200e61['message']:'Unknown\x20error'));}}async[a44_0x38ed98(0xa6)](_0x53d875){const _0x13595b=a44_0x38ed98;console[_0x13595b(0xc9)]('Processing\x20Plisio\x20webhook:',_0x53d875);let _0x66f462=_0x13595b(0x8c);switch(_0x53d875[_0x13595b(0x9d)]?.[_0x13595b(0x8b)]()){case _0x13595b(0xb9):case _0x13595b(0xcf):_0x66f462=_0x13595b(0xf1);break;case'expired':_0x66f462='EXPIRED';break;case'error':case _0x13595b(0xdf):_0x66f462='FAILED';break;case _0x13595b(0x85):case'pending':default:_0x66f462=_0x13595b(0x8c);break;}let _0x4cff48;if(_0x53d875[_0x13595b(0xab)])try{console[_0x13595b(0xc9)](_0x13595b(0xce),_0x53d875[_0x13595b(0xab)]);let _0x46ab63;if(typeof _0x53d875[_0x13595b(0xab)]===_0x13595b(0xbf))_0x46ab63=JSON['parse'](_0x53d875['tx_urls']);else Array['isArray'](_0x53d875['tx_urls'])?_0x46ab63=_0x53d875[_0x13595b(0xab)]:_0x46ab63=[];_0x4cff48=_0x46ab63[_0x13595b(0xf4)](_0x50a103=>{const _0x19f9d4=_0x13595b,_0x2cb23e=_0x50a103[_0x19f9d4(0x94)](/\\/g,'');return console['log'](_0x19f9d4(0xc4)+_0x50a103+_0x19f9d4(0xeb)+_0x2cb23e),_0x2cb23e;}),console['log'](_0x13595b(0x98),_0x4cff48),_0x4cff48[_0x13595b(0xa7)]((_0x38bb43,_0x5b4183)=>{const _0x2edac8=_0x13595b;try{new URL(_0x38bb43),console['log']('‚úÖ\x20URL\x20'+(_0x5b4183+0x1)+_0x2edac8(0x8e)+_0x38bb43);}catch(_0x3f6281){console[_0x2edac8(0xc0)](_0x2edac8(0xb0)+(_0x5b4183+0x1)+_0x2edac8(0xd4)+_0x38bb43,_0x3f6281);}});}catch(_0x507271){console['error'](_0x13595b(0x95),_0x507271),console[_0x13595b(0xc0)](_0x13595b(0xb7),_0x53d875['tx_urls']),_0x4cff48=undefined;}return{'paymentId':_0x53d875['order_number']||'','status':_0x66f462,'amount':_0x53d875[_0x13595b(0xa5)],'currency':_0x53d875[_0x13595b(0x8d)],'txUrls':_0x4cff48};}}exports[a44_0x38ed98(0x88)]=PlisioService;