'use strict';const a41_0x3a5cd7=a41_0x5658;(function(_0x9b10fc,_0x223462){const _0x3706da=a41_0x5658,_0x318336=_0x9b10fc();while(!![]){try{const _0x59276d=parseInt(_0x3706da(0x18b))/0x1*(-parseInt(_0x3706da(0x167))/0x2)+-parseInt(_0x3706da(0x17d))/0x3+-parseInt(_0x3706da(0x15f))/0x4*(parseInt(_0x3706da(0x171))/0x5)+parseInt(_0x3706da(0x1b7))/0x6*(parseInt(_0x3706da(0x16b))/0x7)+-parseInt(_0x3706da(0x1b4))/0x8+-parseInt(_0x3706da(0x17a))/0x9*(parseInt(_0x3706da(0x18a))/0xa)+parseInt(_0x3706da(0x180))/0xb;if(_0x59276d===_0x223462)break;else _0x318336['push'](_0x318336['shift']());}catch(_0x3b4863){_0x318336['push'](_0x318336['shift']());}}}(a41_0x5bd8,0x7f4a3));function a41_0x5bd8(){const _0x50d493=['now','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Error\x20stack:','Target\x20Currency:','email','4534wfTOVD','json','üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','3289986SdyxfT','PENDING','source_amount','success','append','(fiat\x20for\x20merchant)','5TVJMat','message','name','EXPIRED','Plisio\x20payment\x20verification\x20error:','status','Error\x20message:','HTTP\x20error!\x20status:\x20','Error\x20details:','27gXvxjP','apiKey','/invoices/new','1015431wOiNjd','Error\x20Message:','‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','31362936AdPVSd','order_number','text','replace','log','toString','https://api.plisio.net/api/v1/invoices/new','HTTP\x20','logWhiteDomainError','txn_id','3363740YhqDxA','431PXdFWV','Full\x20URL\x20(without\x20API\x20key):','source_currency','createPayment','warn','PLISIO_API_KEY','error','qr_code','Failed\x20to\x20parse\x20JSON\x20response:','stringify','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','Source\x20Currency:','Parsed\x20Result:','invoice_url','Business\x20Error:\x20','statusText','processWebhook','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','Response\x20Body:','Parameters:','qr_url','Transaction\x20ID:','TesSoft\x20Payment\x20System/1.0','(crypto\x20for\x20payment)','amount','invoice_total_sum','Status\x20Text:','GET','Failed\x20to\x20create\x20Plisio\x20payment:\x20','Unknown\x20error\x20from\x20Plisio\x20API','===\x20PLISIO\x20API\x20ERROR\x20===','loggerService','plisio_direct','PAID','entries','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','Unknown\x20error','PlisioService','Response\x20data:','fromEntries','Processing\x20Plisio\x20webhook:','249616CHkIbF','Plisio\x20API\x20key\x20is\x20not\x20configured','logWhiteDomainResponse','6uZQsjJ','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','application/json','Plisio\x20API\x20error:\x20','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','pending','/operations/','HIDDEN','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','currency','data','https://api.plisio.net/api/v1/operations/','expired','Amount:','apiUrl','logWhiteDomainRequest','1775668pWmepv','toLowerCase'];a41_0x5bd8=function(){return _0x50d493;};return a41_0x5bd8();}function a41_0x5658(_0x506f61,_0x167791){const _0x5bd809=a41_0x5bd8();return a41_0x5658=function(_0x56584f,_0x389a5e){_0x56584f=_0x56584f-0x157;let _0x2ded9a=_0x5bd809[_0x56584f];return _0x2ded9a;},a41_0x5658(_0x506f61,_0x167791);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a41_0x3a5cd7(0x1b0)]=void 0x0;const loggerService_1=require('../loggerService');class PlisioService{constructor(){const _0x1deb86=a41_0x3a5cd7;this[_0x1deb86(0x15d)]=_0x1deb86(0x186),this[_0x1deb86(0x17b)]=process['env'][_0x1deb86(0x190)]||'',!this['apiKey']?console[_0x1deb86(0x18f)](_0x1deb86(0x17f)):console[_0x1deb86(0x184)](_0x1deb86(0x169));}async[a41_0x3a5cd7(0x18e)](_0x13cb33){const _0x157b80=a41_0x3a5cd7,{orderId:_0x4be76f,amount:_0x56b290,currency:_0x404c26,productName:_0x1e413f,description:_0x3a85ea,successUrl:_0x23ea76,failUrl:_0x376a45,customerEmail:_0x302812,customerName:_0x1979dc,isSourceCurrency:_0x21419b,sourceCurrency:_0x190431}=_0x13cb33;if(!this[_0x157b80(0x17b)])throw new Error('Plisio\x20API\x20key\x20is\x20not\x20configured');const _0x2cdd8f=new URLSearchParams({'api_key':this[_0x157b80(0x17b)],'order_number':_0x4be76f,'order_name':_0x1e413f,'description':_0x3a85ea,'success_url':_0x23ea76,'fail_url':_0x376a45,'callback_url':'https://api.trapay.uk/api/webhooks/gateway/plisio'});_0x190431?(_0x2cdd8f[_0x157b80(0x16f)](_0x157b80(0x158),_0x190431),_0x2cdd8f[_0x157b80(0x16f)](_0x157b80(0x18d),_0x404c26),_0x2cdd8f[_0x157b80(0x16f)](_0x157b80(0x16d),_0x56b290['toString']())):(_0x2cdd8f[_0x157b80(0x16f)](_0x157b80(0x158),_0x404c26),_0x2cdd8f[_0x157b80(0x16f)]('amount',_0x56b290[_0x157b80(0x185)]()));_0x302812&&_0x2cdd8f[_0x157b80(0x16f)](_0x157b80(0x166),_0x302812);_0x1979dc&&_0x2cdd8f['append'](_0x157b80(0x173),_0x1979dc);const _0x110097=this[_0x157b80(0x15d)]+'?'+_0x2cdd8f[_0x157b80(0x185)](),_0x10d29c=Date[_0x157b80(0x161)]();try{console[_0x157b80(0x184)]('===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20==='),console[_0x157b80(0x184)]('URL:',this[_0x157b80(0x15d)]),console[_0x157b80(0x184)](_0x157b80(0x19e),Object['fromEntries'](_0x2cdd8f[_0x157b80(0x1ad)]())),console['log'](_0x157b80(0x18c),_0x110097[_0x157b80(0x183)](this['apiKey'],_0x157b80(0x1be))),loggerService_1[_0x157b80(0x1aa)][_0x157b80(0x15e)](_0x157b80(0x1ab),_0x157b80(0x17c),'GET',Object[_0x157b80(0x1b2)](_0x2cdd8f[_0x157b80(0x1ad)]()));const _0x3b7ba5=await fetch(_0x110097,{'method':_0x157b80(0x1a6),'headers':{'Accept':_0x157b80(0x1b9),'User-Agent':_0x157b80(0x1a1)}}),_0x257201=Date[_0x157b80(0x161)]()-_0x10d29c;console[_0x157b80(0x184)](_0x157b80(0x16a)),console[_0x157b80(0x184)]('Status:',_0x3b7ba5[_0x157b80(0x176)]),console[_0x157b80(0x184)](_0x157b80(0x1a5),_0x3b7ba5[_0x157b80(0x19a)]),console[_0x157b80(0x184)]('Response\x20Time:',_0x257201+'ms');const _0x322209=await _0x3b7ba5[_0x157b80(0x182)]();console['log']('Raw\x20Response\x20Body:',_0x322209);if(!_0x3b7ba5['ok']){console['error'](_0x157b80(0x1a9)),console[_0x157b80(0x191)]('HTTP\x20Status:',_0x3b7ba5[_0x157b80(0x176)]),console[_0x157b80(0x191)](_0x157b80(0x19d),_0x322209),loggerService_1[_0x157b80(0x1aa)]['logWhiteDomainResponse'](_0x157b80(0x1ab),_0x157b80(0x17c),_0x3b7ba5['status'],_0x322209,_0x257201),loggerService_1['loggerService']['logWhiteDomainError'](_0x157b80(0x1ab),_0x157b80(0x17c),_0x157b80(0x187)+_0x3b7ba5['status']+':\x20'+_0x322209);throw new Error(_0x157b80(0x178)+_0x3b7ba5[_0x157b80(0x176)]+',\x20body:\x20'+_0x322209);}let _0x2c22b7;try{_0x2c22b7=JSON['parse'](_0x322209);}catch(_0xbd7e00){console[_0x157b80(0x191)](_0x157b80(0x193),_0xbd7e00),loggerService_1[_0x157b80(0x1aa)][_0x157b80(0x188)](_0x157b80(0x1ab),_0x157b80(0x17c),'JSON\x20Parse\x20Error:\x20'+_0xbd7e00);throw new Error(_0x157b80(0x1b8)+_0x322209);}console[_0x157b80(0x184)]('===\x20PARSED\x20PLISIO\x20RESPONSE\x20==='),console[_0x157b80(0x184)](_0x157b80(0x197),JSON[_0x157b80(0x194)](_0x2c22b7,null,0x2)),loggerService_1[_0x157b80(0x1aa)][_0x157b80(0x1b6)]('plisio_direct',_0x157b80(0x17c),_0x3b7ba5[_0x157b80(0x176)],_0x2c22b7,_0x257201);if(_0x2c22b7['status']!==_0x157b80(0x16e)){const _0x3806fa=_0x2c22b7[_0x157b80(0x172)]||_0x2c22b7[_0x157b80(0x191)]||_0x157b80(0x1a8);console[_0x157b80(0x191)](_0x157b80(0x195)),console[_0x157b80(0x191)](_0x157b80(0x17e),_0x3806fa),loggerService_1[_0x157b80(0x1aa)]['logWhiteDomainError'](_0x157b80(0x1ab),_0x157b80(0x17c),_0x157b80(0x199)+_0x3806fa);throw new Error(_0x157b80(0x1ba)+_0x3806fa);}if(!_0x2c22b7['data']?.[_0x157b80(0x189)]||!_0x2c22b7[_0x157b80(0x159)]?.[_0x157b80(0x198)]){console['error'](_0x157b80(0x163)),console[_0x157b80(0x191)](_0x157b80(0x157)),console['error'](_0x157b80(0x1b1),_0x2c22b7[_0x157b80(0x159)]),loggerService_1[_0x157b80(0x1aa)][_0x157b80(0x188)](_0x157b80(0x1ab),_0x157b80(0x17c),_0x157b80(0x162));throw new Error(_0x157b80(0x1bb));}return console[_0x157b80(0x184)]('===\x20PLISIO\x20SUCCESS\x20==='),console[_0x157b80(0x184)](_0x157b80(0x1a0),_0x2c22b7[_0x157b80(0x159)]['txn_id']),console['log']('Invoice\x20URL:',_0x2c22b7[_0x157b80(0x159)][_0x157b80(0x198)]),console['log'](_0x157b80(0x15c),_0x56b290,_0x404c26),_0x190431&&(console['log'](_0x157b80(0x196),_0x190431,_0x157b80(0x1a2)),console['log'](_0x157b80(0x165),_0x404c26,_0x157b80(0x170))),{'gateway_payment_id':_0x2c22b7[_0x157b80(0x159)][_0x157b80(0x189)],'payment_url':_0x2c22b7['data']['invoice_url'],'invoice_total_sum':_0x2c22b7[_0x157b80(0x159)][_0x157b80(0x1a4)],'qr_code':_0x2c22b7[_0x157b80(0x159)][_0x157b80(0x192)],'qr_url':_0x2c22b7['data'][_0x157b80(0x19f)]};}catch(_0x5a2709){console[_0x157b80(0x191)](_0x157b80(0x1ae)),console[_0x157b80(0x191)](_0x157b80(0x179),_0x5a2709),loggerService_1[_0x157b80(0x1aa)]['logWhiteDomainError'](_0x157b80(0x1ab),_0x157b80(0x17c),_0x5a2709);if(_0x5a2709 instanceof Error){console[_0x157b80(0x191)](_0x157b80(0x177),_0x5a2709[_0x157b80(0x172)]),console['error'](_0x157b80(0x164),_0x5a2709['stack']);throw new Error(_0x157b80(0x1a7)+_0x5a2709['message']);}throw new Error(_0x157b80(0x19c));}}async['verifyPayment'](_0x36b1ab){const _0x18884b=a41_0x3a5cd7,_0x1bd06d=Date[_0x18884b(0x161)]();try{if(!this[_0x18884b(0x17b)])throw new Error(_0x18884b(0x1b5));const _0xe92007=new URLSearchParams({'api_key':this[_0x18884b(0x17b)],'txn_id':_0x36b1ab}),_0xf81ee=_0x18884b(0x15a)+_0x36b1ab+'?'+_0xe92007[_0x18884b(0x185)]();loggerService_1['loggerService']['logWhiteDomainRequest'](_0x18884b(0x1ab),_0x18884b(0x1bd)+_0x36b1ab,_0x18884b(0x1a6),Object[_0x18884b(0x1b2)](_0xe92007[_0x18884b(0x1ad)]()));const _0x3e132b=await fetch(_0xf81ee,{'method':'GET','headers':{'Accept':'application/json','User-Agent':_0x18884b(0x1a1)}}),_0x7da39e=Date[_0x18884b(0x161)]()-_0x1bd06d;if(!_0x3e132b['ok']){const _0x526271=await _0x3e132b[_0x18884b(0x182)]();loggerService_1[_0x18884b(0x1aa)]['logWhiteDomainResponse'](_0x18884b(0x1ab),_0x18884b(0x1bd)+_0x36b1ab,_0x3e132b[_0x18884b(0x176)],_0x526271,_0x7da39e);throw new Error(_0x18884b(0x178)+_0x3e132b['status']);}const _0x5b8df2=await _0x3e132b[_0x18884b(0x168)]();loggerService_1[_0x18884b(0x1aa)][_0x18884b(0x1b6)](_0x18884b(0x1ab),_0x18884b(0x1bd)+_0x36b1ab,_0x3e132b[_0x18884b(0x176)],_0x5b8df2,_0x7da39e);if(_0x5b8df2[_0x18884b(0x176)]!=='success'){loggerService_1[_0x18884b(0x1aa)][_0x18884b(0x188)](_0x18884b(0x1ab),_0x18884b(0x1bd)+_0x36b1ab,'Plisio\x20API\x20error:\x20'+(_0x5b8df2[_0x18884b(0x172)]||_0x5b8df2[_0x18884b(0x191)]||'Unknown\x20error'));throw new Error(_0x18884b(0x1ba)+(_0x5b8df2[_0x18884b(0x172)]||_0x5b8df2['error']||_0x18884b(0x1af)));}let _0x4515f3=_0x18884b(0x16c);return{'status':_0x4515f3};}catch(_0x25b889){console[_0x18884b(0x191)](_0x18884b(0x175),_0x25b889),loggerService_1[_0x18884b(0x1aa)][_0x18884b(0x188)]('plisio_direct','/operations/'+_0x36b1ab,_0x25b889);throw new Error('Failed\x20to\x20verify\x20Plisio\x20payment:\x20'+(_0x25b889 instanceof Error?_0x25b889['message']:_0x18884b(0x1af)));}}async[a41_0x3a5cd7(0x19b)](_0x4f10fa){const _0x59789e=a41_0x3a5cd7;console[_0x59789e(0x184)](_0x59789e(0x1b3),_0x4f10fa);let _0x3e3c83=_0x59789e(0x16c);switch(_0x4f10fa[_0x59789e(0x176)]?.[_0x59789e(0x160)]()){case'completed':case'mismatch':_0x3e3c83=_0x59789e(0x1ac);break;case _0x59789e(0x15b):_0x3e3c83=_0x59789e(0x174);break;case _0x59789e(0x191):case'cancelled':_0x3e3c83='FAILED';break;case'new':case _0x59789e(0x1bc):default:_0x3e3c83=_0x59789e(0x16c);break;}return{'paymentId':_0x4f10fa[_0x59789e(0x181)]||'','status':_0x3e3c83,'amount':_0x4f10fa[_0x59789e(0x1a3)],'currency':_0x4f10fa[_0x59789e(0x158)]};}}exports[a41_0x3a5cd7(0x1b0)]=PlisioService;