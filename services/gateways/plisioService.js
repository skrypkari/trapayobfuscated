'use strict';const a52_0xac3aff=a52_0x3312;(function(_0x555009,_0x38988a){const _0x3cc07b=a52_0x3312,_0x1f4710=_0x555009();while(!![]){try{const _0x45a71a=parseInt(_0x3cc07b(0xfa))/0x1+-parseInt(_0x3cc07b(0xca))/0x2*(parseInt(_0x3cc07b(0x109))/0x3)+parseInt(_0x3cc07b(0xf7))/0x4+parseInt(_0x3cc07b(0xd7))/0x5+parseInt(_0x3cc07b(0xe0))/0x6+-parseInt(_0x3cc07b(0xf0))/0x7*(-parseInt(_0x3cc07b(0xdc))/0x8)+-parseInt(_0x3cc07b(0xf2))/0x9;if(_0x45a71a===_0x38988a)break;else _0x1f4710['push'](_0x1f4710['shift']());}catch(_0x1cc3ec){_0x1f4710['push'](_0x1f4710['shift']());}}}(a52_0x4cc9,0x8c434));function a52_0x4cc9(){const _0x1a6fbd=['Raw\x20tx_urls\x20data:','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','currency','apiKey','success','error','(fiat\x20for\x20merchant)','Status:','email','qr_code','invoice_total_sum','txn_id','üîó\x20Raw\x20tx_urls\x20from\x20Plisio:','HTTP\x20','application/json','Full\x20URL\x20(without\x20API\x20key):','Processing\x20Plisio\x20webhook:','logWhiteDomainResponse','EXPIRED','logWhiteDomainRequest','stack','warn','PAID','entries','PLISIO_API_KEY','stringify','fromEntries','===\x20PLISIO\x20SUCCESS\x20===','GET','plisio_direct','/operations/','text','apiUrl','qr_url','Plisio\x20API\x20error:\x20','Raw\x20Response\x20Body:','verifyPayment','Error\x20details:','https://api.plisio.net/api/v1/operations/','data','toString','12370OJidWh','Payment\x20System/1.0','Response\x20Time:','log','Failed\x20to\x20parse\x20JSON\x20response:','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','statusText','expired','Transaction\x20ID:','logWhiteDomainError','‚ùå\x20Failed\x20to\x20parse\x20tx_urls:','Unknown\x20error','https://api.trapay.uk/api/webhooks/gateway/plisio','2787115bxOuin','parse','now','string','forEach','1484096TEOlGz','HTTP\x20error!\x20status:\x20','FAILED','Business\x20Error:\x20','487314WtsBBa','invoice_url','Target\x20Currency:','append','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','HIDDEN','‚úÖ\x20Processed\x20tx_urls:','completed','cancelled','Parsed\x20Result:','order_number','Plisio\x20API\x20key\x20is\x20not\x20configured','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','https://api.plisio.net/api/v1/invoices/new','7uxzPAh','name','11033064zUTEXN','PlisioService','/invoices/new','Error\x20message:','Amount:','3867776tszIvx','HTTP\x20Status:','tx_urls','776254QOkpzr','pending','status','Parameters:','URL:','Response\x20data:','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','PENDING','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','loggerService','env','Source\x20Currency:','PROCESSING','__esModule','372HjOFff','message'];a52_0x4cc9=function(){return _0x1a6fbd;};return a52_0x4cc9();}Object['defineProperty'](exports,a52_0xac3aff(0x108),{'value':!![]}),exports[a52_0xac3aff(0xf3)]=void 0x0;function a52_0x3312(_0x3e2ab7,_0x12506d){const _0x4cc9b8=a52_0x4cc9();return a52_0x3312=function(_0x3312be,_0x53fae5){_0x3312be=_0x3312be-0xc0;let _0xb915f9=_0x4cc9b8[_0x3312be];return _0xb915f9;},a52_0x3312(_0x3e2ab7,_0x12506d);}const loggerService_1=require('../loggerService');class PlisioService{constructor(){const _0x41f57c=a52_0xac3aff;this['apiUrl']=_0x41f57c(0xef),this[_0x41f57c(0x10e)]=process[_0x41f57c(0x105)][_0x41f57c(0x123)]||'',!this[_0x41f57c(0x10e)]?console[_0x41f57c(0x120)]('‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables'):console[_0x41f57c(0xcd)](_0x41f57c(0xed));}async['createPayment'](_0x374266){const _0x58ae5e=a52_0xac3aff,{orderId:_0xcfff1f,amount:_0x14115d,currency:_0x2f4e1d,productName:_0x16f364,description:_0x15d375,successUrl:_0x417d48,failUrl:_0x99fb6f,customerEmail:_0x37aced,customerName:_0x47c816,isSourceCurrency:_0x31e803,sourceCurrency:_0x510431}=_0x374266;if(!this[_0x58ae5e(0x10e)])throw new Error('Plisio\x20API\x20key\x20is\x20not\x20configured');const _0x4d1387=new URLSearchParams({'api_key':this['apiKey'],'order_number':_0xcfff1f,'order_name':_0x16f364,'description':_0x15d375,'success_url':_0x417d48,'fail_url':_0x99fb6f,'callback_url':_0x58ae5e(0xd6)});_0x510431?(_0x4d1387['append']('currency',_0x510431),_0x4d1387[_0x58ae5e(0xe3)]('source_currency',_0x2f4e1d),_0x4d1387[_0x58ae5e(0xe3)]('source_amount',_0x14115d['toString']())):(_0x4d1387['append'](_0x58ae5e(0x10d),_0x2f4e1d),_0x4d1387[_0x58ae5e(0xe3)]('amount',_0x14115d['toString']()));_0x37aced&&_0x4d1387[_0x58ae5e(0xe3)](_0x58ae5e(0x113),_0x37aced);_0x47c816&&_0x4d1387[_0x58ae5e(0xe3)](_0x58ae5e(0xf1),_0x47c816);const _0x1a6f19=this['apiUrl']+'?'+_0x4d1387[_0x58ae5e(0xc9)](),_0x4abb43=Date[_0x58ae5e(0xd9)]();try{console['log'](_0x58ae5e(0xee)),console[_0x58ae5e(0xcd)](_0x58ae5e(0xfe),this[_0x58ae5e(0xc1)]),console['log'](_0x58ae5e(0xfd),Object[_0x58ae5e(0x125)](_0x4d1387[_0x58ae5e(0x122)]())),console[_0x58ae5e(0xcd)](_0x58ae5e(0x11a),_0x1a6f19['replace'](this[_0x58ae5e(0x10e)],_0x58ae5e(0xe5))),loggerService_1[_0x58ae5e(0x104)][_0x58ae5e(0x11e)]('plisio_direct',_0x58ae5e(0xf4),_0x58ae5e(0x127),Object[_0x58ae5e(0x125)](_0x4d1387[_0x58ae5e(0x122)]()));const _0x4d92a2=await fetch(_0x1a6f19,{'method':_0x58ae5e(0x127),'headers':{'Accept':_0x58ae5e(0x119),'User-Agent':_0x58ae5e(0xcb)}}),_0x1f4610=Date[_0x58ae5e(0xd9)]()-_0x4abb43;console[_0x58ae5e(0xcd)](_0x58ae5e(0x10c)),console[_0x58ae5e(0xcd)](_0x58ae5e(0x112),_0x4d92a2[_0x58ae5e(0xfc)]),console[_0x58ae5e(0xcd)]('Status\x20Text:',_0x4d92a2[_0x58ae5e(0xd0)]),console[_0x58ae5e(0xcd)](_0x58ae5e(0xcc),_0x1f4610+'ms');const _0x1c8506=await _0x4d92a2[_0x58ae5e(0xc0)]();console['log'](_0x58ae5e(0xc4),_0x1c8506);if(!_0x4d92a2['ok']){console[_0x58ae5e(0x110)]('===\x20PLISIO\x20API\x20ERROR\x20==='),console[_0x58ae5e(0x110)](_0x58ae5e(0xf8),_0x4d92a2['status']),console[_0x58ae5e(0x110)]('Response\x20Body:',_0x1c8506),loggerService_1[_0x58ae5e(0x104)]['logWhiteDomainResponse'](_0x58ae5e(0x128),'/invoices/new',_0x4d92a2[_0x58ae5e(0xfc)],_0x1c8506,_0x1f4610),loggerService_1[_0x58ae5e(0x104)][_0x58ae5e(0xd3)](_0x58ae5e(0x128),_0x58ae5e(0xf4),_0x58ae5e(0x118)+_0x4d92a2['status']+':\x20'+_0x1c8506);throw new Error(_0x58ae5e(0xdd)+_0x4d92a2[_0x58ae5e(0xfc)]+',\x20body:\x20'+_0x1c8506);}let _0x1748e4;try{_0x1748e4=JSON[_0x58ae5e(0xd8)](_0x1c8506);}catch(_0x517f24){console[_0x58ae5e(0x110)](_0x58ae5e(0xce),_0x517f24),loggerService_1[_0x58ae5e(0x104)][_0x58ae5e(0xd3)](_0x58ae5e(0x128),_0x58ae5e(0xf4),'JSON\x20Parse\x20Error:\x20'+_0x517f24);throw new Error(_0x58ae5e(0xec)+_0x1c8506);}console['log'](_0x58ae5e(0xe4)),console[_0x58ae5e(0xcd)](_0x58ae5e(0xe9),JSON[_0x58ae5e(0x124)](_0x1748e4,null,0x2)),loggerService_1[_0x58ae5e(0x104)][_0x58ae5e(0x11c)](_0x58ae5e(0x128),_0x58ae5e(0xf4),_0x4d92a2[_0x58ae5e(0xfc)],_0x1748e4,_0x1f4610);if(_0x1748e4['status']!==_0x58ae5e(0x10f)){const _0x376489=_0x1748e4[_0x58ae5e(0x10a)]||_0x1748e4[_0x58ae5e(0x110)]||'Unknown\x20error\x20from\x20Plisio\x20API';console[_0x58ae5e(0x110)]('===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x58ae5e(0x110)]('Error\x20Message:',_0x376489),loggerService_1[_0x58ae5e(0x104)][_0x58ae5e(0xd3)](_0x58ae5e(0x128),_0x58ae5e(0xf4),_0x58ae5e(0xdf)+_0x376489);throw new Error(_0x58ae5e(0xc3)+_0x376489);}if(!_0x1748e4['data']?.[_0x58ae5e(0x116)]||!_0x1748e4[_0x58ae5e(0xc8)]?.['invoice_url']){console['error']('===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x58ae5e(0x110)](_0x58ae5e(0xcf)),console[_0x58ae5e(0x110)](_0x58ae5e(0xff),_0x1748e4[_0x58ae5e(0xc8)]),loggerService_1[_0x58ae5e(0x104)][_0x58ae5e(0xd3)]('plisio_direct',_0x58ae5e(0xf4),'Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url');throw new Error(_0x58ae5e(0x101));}return console[_0x58ae5e(0xcd)](_0x58ae5e(0x126)),console['log'](_0x58ae5e(0xd2),_0x1748e4['data'][_0x58ae5e(0x116)]),console[_0x58ae5e(0xcd)]('Invoice\x20URL:',_0x1748e4[_0x58ae5e(0xc8)][_0x58ae5e(0xe1)]),console['log'](_0x58ae5e(0xf6),_0x14115d,_0x2f4e1d),_0x510431&&(console[_0x58ae5e(0xcd)](_0x58ae5e(0x106),_0x510431,'(crypto\x20for\x20payment)'),console[_0x58ae5e(0xcd)](_0x58ae5e(0xe2),_0x2f4e1d,_0x58ae5e(0x111))),{'gateway_payment_id':_0x1748e4['data']['txn_id'],'payment_url':_0x1748e4[_0x58ae5e(0xc8)][_0x58ae5e(0xe1)],'invoice_total_sum':_0x1748e4['data'][_0x58ae5e(0x115)],'qr_code':_0x1748e4[_0x58ae5e(0xc8)][_0x58ae5e(0x114)],'qr_url':_0x1748e4[_0x58ae5e(0xc8)][_0x58ae5e(0xc2)]};}catch(_0x48db59){console[_0x58ae5e(0x110)]('===\x20PLISIO\x20SERVICE\x20ERROR\x20==='),console[_0x58ae5e(0x110)](_0x58ae5e(0xc6),_0x48db59),loggerService_1['loggerService'][_0x58ae5e(0xd3)](_0x58ae5e(0x128),_0x58ae5e(0xf4),_0x48db59);if(_0x48db59 instanceof Error){console[_0x58ae5e(0x110)](_0x58ae5e(0xf5),_0x48db59[_0x58ae5e(0x10a)]),console[_0x58ae5e(0x110)]('Error\x20stack:',_0x48db59[_0x58ae5e(0x11f)]);throw new Error('Failed\x20to\x20create\x20Plisio\x20payment:\x20'+_0x48db59[_0x58ae5e(0x10a)]);}throw new Error(_0x58ae5e(0x103));}}async[a52_0xac3aff(0xc5)](_0x1e7286){const _0x406891=a52_0xac3aff,_0xdea1aa=Date[_0x406891(0xd9)]();try{if(!this['apiKey'])throw new Error(_0x406891(0xeb));const _0x513c50=new URLSearchParams({'api_key':this['apiKey'],'txn_id':_0x1e7286}),_0x42f431=_0x406891(0xc7)+_0x1e7286+'?'+_0x513c50['toString']();loggerService_1[_0x406891(0x104)][_0x406891(0x11e)](_0x406891(0x128),'/operations/'+_0x1e7286,_0x406891(0x127),Object[_0x406891(0x125)](_0x513c50['entries']()));const _0x52ea42=await fetch(_0x42f431,{'method':_0x406891(0x127),'headers':{'Accept':_0x406891(0x119),'User-Agent':_0x406891(0xcb)}}),_0x11a561=Date[_0x406891(0xd9)]()-_0xdea1aa;if(!_0x52ea42['ok']){const _0x1419aa=await _0x52ea42[_0x406891(0xc0)]();loggerService_1[_0x406891(0x104)][_0x406891(0x11c)](_0x406891(0x128),_0x406891(0x129)+_0x1e7286,_0x52ea42[_0x406891(0xfc)],_0x1419aa,_0x11a561);throw new Error('HTTP\x20error!\x20status:\x20'+_0x52ea42[_0x406891(0xfc)]);}const _0x121d6a=await _0x52ea42['json']();loggerService_1[_0x406891(0x104)][_0x406891(0x11c)](_0x406891(0x128),'/operations/'+_0x1e7286,_0x52ea42[_0x406891(0xfc)],_0x121d6a,_0x11a561);if(_0x121d6a[_0x406891(0xfc)]!==_0x406891(0x10f)){loggerService_1[_0x406891(0x104)]['logWhiteDomainError'](_0x406891(0x128),_0x406891(0x129)+_0x1e7286,_0x406891(0xc3)+(_0x121d6a[_0x406891(0x10a)]||_0x121d6a[_0x406891(0x110)]||_0x406891(0xd5)));throw new Error(_0x406891(0xc3)+(_0x121d6a[_0x406891(0x10a)]||_0x121d6a[_0x406891(0x110)]||'Unknown\x20error'));}let _0x53b512=_0x406891(0x102);return{'status':_0x53b512};}catch(_0x3a3dd4){console['error']('Plisio\x20payment\x20verification\x20error:',_0x3a3dd4),loggerService_1[_0x406891(0x104)][_0x406891(0xd3)]('plisio_direct',_0x406891(0x129)+_0x1e7286,_0x3a3dd4);throw new Error(_0x406891(0x100)+(_0x3a3dd4 instanceof Error?_0x3a3dd4[_0x406891(0x10a)]:_0x406891(0xd5)));}}async['processWebhook'](_0x539186){const _0x53f6aa=a52_0xac3aff;console['log'](_0x53f6aa(0x11b),_0x539186);let _0x50aa69='PENDING';switch(_0x539186[_0x53f6aa(0xfc)]?.['toLowerCase']()){case _0x53f6aa(0xe7):case'mismatch':_0x50aa69=_0x53f6aa(0x121);break;case _0x53f6aa(0xd1):_0x50aa69=_0x53f6aa(0x11d);break;case _0x53f6aa(0x110):case _0x53f6aa(0xe8):_0x50aa69=_0x53f6aa(0xde);break;case'new':_0x50aa69=_0x53f6aa(0x102);break;case _0x53f6aa(0xfb):_0x50aa69=_0x53f6aa(0x107);break;default:_0x50aa69=_0x53f6aa(0x102);break;}let _0x1da0be;if(_0x539186['tx_urls'])try{console[_0x53f6aa(0xcd)](_0x53f6aa(0x117),_0x539186[_0x53f6aa(0xf9)]);let _0x40b836;if(typeof _0x539186[_0x53f6aa(0xf9)]===_0x53f6aa(0xda))_0x40b836=JSON[_0x53f6aa(0xd8)](_0x539186[_0x53f6aa(0xf9)]);else Array['isArray'](_0x539186[_0x53f6aa(0xf9)])?_0x40b836=_0x539186[_0x53f6aa(0xf9)]:_0x40b836=[];_0x1da0be=_0x40b836['map'](_0x5a432c=>{const _0x4f8d57=_0x5a432c['replace'](/\\/g,'');return console['log']('üîó\x20Formatted\x20URL:\x20'+_0x5a432c+'\x20->\x20'+_0x4f8d57),_0x4f8d57;}),console['log'](_0x53f6aa(0xe6),_0x1da0be),_0x1da0be[_0x53f6aa(0xdb)]((_0x3ffbad,_0x48e999)=>{const _0x45e97d=_0x53f6aa;try{new URL(_0x3ffbad),console[_0x45e97d(0xcd)]('‚úÖ\x20URL\x20'+(_0x48e999+0x1)+'\x20is\x20valid:\x20'+_0x3ffbad);}catch(_0x2bb25a){console[_0x45e97d(0x110)]('‚ùå\x20URL\x20'+(_0x48e999+0x1)+'\x20is\x20invalid:\x20'+_0x3ffbad,_0x2bb25a);}});}catch(_0x14320c){console[_0x53f6aa(0x110)](_0x53f6aa(0xd4),_0x14320c),console[_0x53f6aa(0x110)](_0x53f6aa(0x10b),_0x539186[_0x53f6aa(0xf9)]),_0x1da0be=undefined;}return{'paymentId':_0x539186[_0x53f6aa(0xea)]||'','status':_0x50aa69,'amount':_0x539186['amount'],'currency':_0x539186[_0x53f6aa(0x10d)],'txUrls':_0x1da0be};}}exports[a52_0xac3aff(0xf3)]=PlisioService;