'use strict';const a44_0x4d5957=a44_0x2e92;function a44_0x2e92(_0x56cae9,_0x1e9171){const _0x219236=a44_0x2192();return a44_0x2e92=function(_0x2e920b,_0x2e0ba3){_0x2e920b=_0x2e920b-0xc8;let _0x2f54db=_0x219236[_0x2e920b];return _0x2f54db;},a44_0x2e92(_0x56cae9,_0x1e9171);}(function(_0x543003,_0x2c0963){const _0xc1bdbd=a44_0x2e92,_0x1544b9=_0x543003();while(!![]){try{const _0xeb0383=parseInt(_0xc1bdbd(0xe9))/0x1*(parseInt(_0xc1bdbd(0x127))/0x2)+-parseInt(_0xc1bdbd(0xc9))/0x3+parseInt(_0xc1bdbd(0xf3))/0x4*(parseInt(_0xc1bdbd(0xe0))/0x5)+parseInt(_0xc1bdbd(0xe6))/0x6*(-parseInt(_0xc1bdbd(0xd5))/0x7)+parseInt(_0xc1bdbd(0x129))/0x8*(parseInt(_0xc1bdbd(0xfe))/0x9)+-parseInt(_0xc1bdbd(0xe5))/0xa*(-parseInt(_0xc1bdbd(0x117))/0xb)+-parseInt(_0xc1bdbd(0x110))/0xc*(parseInt(_0xc1bdbd(0xea))/0xd);if(_0xeb0383===_0x2c0963)break;else _0x1544b9['push'](_0x1544b9['shift']());}catch(_0xdca99){_0x1544b9['push'](_0x1544b9['shift']());}}}(a44_0x2192,0x683d2));Object[a44_0x4d5957(0xfb)](exports,'__esModule',{'value':!![]}),exports[a44_0x4d5957(0x137)]=void 0x0;const loggerService_1=require(a44_0x4d5957(0xd2));class PlisioService{constructor(){const _0x1d2a76=a44_0x4d5957;this[_0x1d2a76(0xe3)]=_0x1d2a76(0xfd),this[_0x1d2a76(0xf9)]=process[_0x1d2a76(0x111)]['PLISIO_API_KEY']||'',!this[_0x1d2a76(0xf9)]?console[_0x1d2a76(0xe7)](_0x1d2a76(0x128)):console['log']('💰\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API');}async['createPayment'](_0x10b60){const _0x5b11e7=a44_0x4d5957,{orderId:_0x396bc4,amount:_0x334015,currency:_0xda9344,productName:_0x29f4b9,description:_0x2a8476,successUrl:_0x1c53f2,failUrl:_0x1ca150,customerEmail:_0x2b6576,customerName:_0x368ce9,isSourceCurrency:_0x3f6562,sourceCurrency:_0x312982}=_0x10b60;if(!this[_0x5b11e7(0xf9)])throw new Error(_0x5b11e7(0xe2));const _0x39aa93=new URLSearchParams({'api_key':this[_0x5b11e7(0xf9)],'order_number':_0x396bc4,'order_name':_0x29f4b9,'description':_0x2a8476,'success_url':_0x1c53f2,'fail_url':_0x1ca150,'callback_url':_0x5b11e7(0x11f)});_0x312982?(_0x39aa93[_0x5b11e7(0x126)](_0x5b11e7(0x13e),_0x312982),_0x39aa93[_0x5b11e7(0x126)](_0x5b11e7(0xee),_0xda9344),_0x39aa93[_0x5b11e7(0x126)]('source_amount',_0x334015[_0x5b11e7(0x133)]())):(_0x39aa93[_0x5b11e7(0x126)](_0x5b11e7(0x13e),_0xda9344),_0x39aa93['append'](_0x5b11e7(0x12f),_0x334015[_0x5b11e7(0x133)]()));_0x2b6576&&_0x39aa93[_0x5b11e7(0x126)](_0x5b11e7(0xe4),_0x2b6576);_0x368ce9&&_0x39aa93[_0x5b11e7(0x126)](_0x5b11e7(0x12b),_0x368ce9);const _0x5de2aa=this['apiUrl']+'?'+_0x39aa93[_0x5b11e7(0x133)](),_0x20379e=Date[_0x5b11e7(0x11d)]();try{console[_0x5b11e7(0xe1)]('===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20==='),console[_0x5b11e7(0xe1)]('URL:',this['apiUrl']),console[_0x5b11e7(0xe1)]('Parameters:',Object[_0x5b11e7(0x132)](_0x39aa93[_0x5b11e7(0x100)]())),console[_0x5b11e7(0xe1)](_0x5b11e7(0xdb),_0x5de2aa[_0x5b11e7(0xf0)](this[_0x5b11e7(0xf9)],'HIDDEN')),loggerService_1[_0x5b11e7(0x108)][_0x5b11e7(0x115)](_0x5b11e7(0x11c),'/invoices/new',_0x5b11e7(0xd3),Object[_0x5b11e7(0x132)](_0x39aa93[_0x5b11e7(0x100)]()));const _0x4612a6=await fetch(_0x5de2aa,{'method':'GET','headers':{'Accept':_0x5b11e7(0xde),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x2820af=Date['now']()-_0x20379e;console['log'](_0x5b11e7(0xf8)),console[_0x5b11e7(0xe1)](_0x5b11e7(0x104),_0x4612a6[_0x5b11e7(0x121)]),console[_0x5b11e7(0xe1)](_0x5b11e7(0xdc),_0x4612a6[_0x5b11e7(0xcd)]),console[_0x5b11e7(0xe1)](_0x5b11e7(0x103),_0x2820af+'ms');const _0x2c6827=await _0x4612a6[_0x5b11e7(0xd6)]();console[_0x5b11e7(0xe1)]('Raw\x20Response\x20Body:',_0x2c6827);if(!_0x4612a6['ok']){console[_0x5b11e7(0x10d)](_0x5b11e7(0x10f)),console['error'](_0x5b11e7(0x138),_0x4612a6['status']),console[_0x5b11e7(0x10d)](_0x5b11e7(0xff),_0x2c6827),loggerService_1[_0x5b11e7(0x108)][_0x5b11e7(0xdf)](_0x5b11e7(0x11c),_0x5b11e7(0x13c),_0x4612a6['status'],_0x2c6827,_0x2820af),loggerService_1[_0x5b11e7(0x108)][_0x5b11e7(0x112)](_0x5b11e7(0x11c),_0x5b11e7(0x13c),'HTTP\x20'+_0x4612a6[_0x5b11e7(0x121)]+':\x20'+_0x2c6827);throw new Error(_0x5b11e7(0x13b)+_0x4612a6[_0x5b11e7(0x121)]+_0x5b11e7(0xcc)+_0x2c6827);}let _0x919423;try{_0x919423=JSON[_0x5b11e7(0x105)](_0x2c6827);}catch(_0x1222a5){console[_0x5b11e7(0x10d)](_0x5b11e7(0x11e),_0x1222a5),loggerService_1[_0x5b11e7(0x108)]['logWhiteDomainError']('plisio_direct',_0x5b11e7(0x13c),_0x5b11e7(0xcf)+_0x1222a5);throw new Error(_0x5b11e7(0x120)+_0x2c6827);}console[_0x5b11e7(0xe1)](_0x5b11e7(0x106)),console['log'](_0x5b11e7(0x10c),JSON['stringify'](_0x919423,null,0x2)),loggerService_1[_0x5b11e7(0x108)][_0x5b11e7(0xdf)](_0x5b11e7(0x11c),'/invoices/new',_0x4612a6[_0x5b11e7(0x121)],_0x919423,_0x2820af);if(_0x919423[_0x5b11e7(0x121)]!=='success'){const _0x55630b=_0x919423[_0x5b11e7(0x124)]||_0x919423[_0x5b11e7(0x10d)]||_0x5b11e7(0x116);console[_0x5b11e7(0x10d)](_0x5b11e7(0x139)),console[_0x5b11e7(0x10d)](_0x5b11e7(0xd1),_0x55630b),loggerService_1['loggerService'][_0x5b11e7(0x112)](_0x5b11e7(0x11c),_0x5b11e7(0x13c),_0x5b11e7(0xd7)+_0x55630b);throw new Error('Plisio\x20API\x20error:\x20'+_0x55630b);}if(!_0x919423[_0x5b11e7(0xec)]?.[_0x5b11e7(0x130)]||!_0x919423[_0x5b11e7(0xec)]?.['invoice_url']){console[_0x5b11e7(0x10d)]('===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x5b11e7(0x10d)](_0x5b11e7(0x10a)),console[_0x5b11e7(0x10d)]('Response\x20data:',_0x919423[_0x5b11e7(0xec)]),loggerService_1[_0x5b11e7(0x108)]['logWhiteDomainError'](_0x5b11e7(0x11c),_0x5b11e7(0x13c),_0x5b11e7(0x109));throw new Error(_0x5b11e7(0x101));}return console[_0x5b11e7(0xe1)](_0x5b11e7(0xce)),console[_0x5b11e7(0xe1)](_0x5b11e7(0x107),_0x919423[_0x5b11e7(0xec)][_0x5b11e7(0x130)]),console[_0x5b11e7(0xe1)](_0x5b11e7(0x11a),_0x919423[_0x5b11e7(0xec)][_0x5b11e7(0xf2)]),console['log'](_0x5b11e7(0x13f),_0x334015,_0xda9344),_0x312982&&(console['log'](_0x5b11e7(0xca),_0x312982,_0x5b11e7(0x12c)),console[_0x5b11e7(0xe1)]('Target\x20Currency:',_0xda9344,_0x5b11e7(0x122))),{'gateway_payment_id':_0x919423[_0x5b11e7(0xec)][_0x5b11e7(0x130)],'payment_url':_0x919423['data'][_0x5b11e7(0xf2)],'invoice_total_sum':_0x919423['data'][_0x5b11e7(0x12e)],'qr_code':_0x919423[_0x5b11e7(0xec)][_0x5b11e7(0xfc)],'qr_url':_0x919423[_0x5b11e7(0xec)]['qr_url']};}catch(_0x17f6d5){console[_0x5b11e7(0x10d)](_0x5b11e7(0xda)),console[_0x5b11e7(0x10d)](_0x5b11e7(0xdd),_0x17f6d5),loggerService_1[_0x5b11e7(0x108)][_0x5b11e7(0x112)](_0x5b11e7(0x11c),_0x5b11e7(0x13c),_0x17f6d5);if(_0x17f6d5 instanceof Error){console[_0x5b11e7(0x10d)](_0x5b11e7(0x13a),_0x17f6d5[_0x5b11e7(0x124)]),console[_0x5b11e7(0x10d)](_0x5b11e7(0xd8),_0x17f6d5[_0x5b11e7(0x10b)]);throw new Error(_0x5b11e7(0x12a)+_0x17f6d5[_0x5b11e7(0x124)]);}throw new Error(_0x5b11e7(0x102));}}async[a44_0x4d5957(0xfa)](_0x3d3a32){const _0x5216d5=a44_0x4d5957,_0xd9fe45=Date[_0x5216d5(0x11d)]();try{if(!this[_0x5216d5(0xf9)])throw new Error(_0x5216d5(0xe2));const _0x3f83b2=new URLSearchParams({'api_key':this[_0x5216d5(0xf9)],'txn_id':_0x3d3a32}),_0x189a89=_0x5216d5(0xe8)+_0x3d3a32+'?'+_0x3f83b2[_0x5216d5(0x133)]();loggerService_1[_0x5216d5(0x108)]['logWhiteDomainRequest'](_0x5216d5(0x11c),_0x5216d5(0xeb)+_0x3d3a32,_0x5216d5(0xd3),Object[_0x5216d5(0x132)](_0x3f83b2[_0x5216d5(0x100)]()));const _0x1602e6=await fetch(_0x189a89,{'method':_0x5216d5(0xd3),'headers':{'Accept':_0x5216d5(0xde),'User-Agent':_0x5216d5(0xd0)}}),_0x348693=Date[_0x5216d5(0x11d)]()-_0xd9fe45;if(!_0x1602e6['ok']){const _0x19907e=await _0x1602e6[_0x5216d5(0xd6)]();loggerService_1['loggerService'][_0x5216d5(0xdf)](_0x5216d5(0x11c),_0x5216d5(0xeb)+_0x3d3a32,_0x1602e6['status'],_0x19907e,_0x348693);throw new Error(_0x5216d5(0x13b)+_0x1602e6['status']);}const _0x54ab7e=await _0x1602e6[_0x5216d5(0x114)]();loggerService_1[_0x5216d5(0x108)][_0x5216d5(0xdf)](_0x5216d5(0x11c),'/operations/'+_0x3d3a32,_0x1602e6[_0x5216d5(0x121)],_0x54ab7e,_0x348693);if(_0x54ab7e['status']!==_0x5216d5(0x113)){loggerService_1[_0x5216d5(0x108)][_0x5216d5(0x112)](_0x5216d5(0x11c),_0x5216d5(0xeb)+_0x3d3a32,_0x5216d5(0x11b)+(_0x54ab7e[_0x5216d5(0x124)]||_0x54ab7e[_0x5216d5(0x10d)]||_0x5216d5(0xf5)));throw new Error(_0x5216d5(0x11b)+(_0x54ab7e['message']||_0x54ab7e[_0x5216d5(0x10d)]||_0x5216d5(0xf5)));}let _0x1e6f84=_0x5216d5(0xc8);return{'status':_0x1e6f84};}catch(_0xbdef37){console[_0x5216d5(0x10d)]('Plisio\x20payment\x20verification\x20error:',_0xbdef37),loggerService_1[_0x5216d5(0x108)][_0x5216d5(0x112)](_0x5216d5(0x11c),'/operations/'+_0x3d3a32,_0xbdef37);throw new Error(_0x5216d5(0x10e)+(_0xbdef37 instanceof Error?_0xbdef37[_0x5216d5(0x124)]:_0x5216d5(0xf5)));}}async['processWebhook'](_0x4f973e){const _0x5d2fd5=a44_0x4d5957;console['log']('Processing\x20Plisio\x20webhook:',_0x4f973e);let _0x13ea99=_0x5d2fd5(0xc8);switch(_0x4f973e['status']?.[_0x5d2fd5(0xf4)]()){case'completed':case _0x5d2fd5(0x131):_0x13ea99='PAID';break;case _0x5d2fd5(0xf6):_0x13ea99=_0x5d2fd5(0xf1);break;case _0x5d2fd5(0x10d):case _0x5d2fd5(0xd4):_0x13ea99='FAILED';break;case _0x5d2fd5(0xcb):case'pending':default:_0x13ea99=_0x5d2fd5(0xc8);break;}let _0x147d8f;if(_0x4f973e[_0x5d2fd5(0x12d)])try{console[_0x5d2fd5(0xe1)]('🔗\x20Raw\x20tx_urls\x20from\x20Plisio:',_0x4f973e[_0x5d2fd5(0x12d)]);let _0x4aadd7;if(typeof _0x4f973e['tx_urls']===_0x5d2fd5(0x134))_0x4aadd7=JSON[_0x5d2fd5(0x105)](_0x4f973e[_0x5d2fd5(0x12d)]);else Array[_0x5d2fd5(0xf7)](_0x4f973e[_0x5d2fd5(0x12d)])?_0x4aadd7=_0x4f973e[_0x5d2fd5(0x12d)]:_0x4aadd7=[];_0x147d8f=_0x4aadd7[_0x5d2fd5(0x13d)](_0x572db6=>{const _0x150def=_0x5d2fd5,_0xcad9ee=_0x572db6[_0x150def(0xf0)](/\\/g,'');return console[_0x150def(0xe1)](_0x150def(0x135)+_0x572db6+_0x150def(0x119)+_0xcad9ee),_0xcad9ee;}),console[_0x5d2fd5(0xe1)]('✅\x20Processed\x20tx_urls:',_0x147d8f),_0x147d8f[_0x5d2fd5(0xd9)]((_0x17fb01,_0xebce9)=>{const _0x596854=_0x5d2fd5;try{new URL(_0x17fb01),console[_0x596854(0xe1)](_0x596854(0x136)+(_0xebce9+0x1)+'\x20is\x20valid:\x20'+_0x17fb01);}catch(_0x2cf360){console[_0x596854(0x10d)](_0x596854(0x125)+(_0xebce9+0x1)+_0x596854(0xef)+_0x17fb01,_0x2cf360);}});}catch(_0x561951){console[_0x5d2fd5(0x10d)](_0x5d2fd5(0x123),_0x561951),console['error'](_0x5d2fd5(0x118),_0x4f973e[_0x5d2fd5(0x12d)]),_0x147d8f=undefined;}return{'paymentId':_0x4f973e[_0x5d2fd5(0xed)]||'','status':_0x13ea99,'amount':_0x4f973e[_0x5d2fd5(0x12f)],'currency':_0x4f973e[_0x5d2fd5(0x13e)],'txUrls':_0x147d8f};}}function a44_0x2192(){const _0x1cef8a=['Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','Response\x20Time:','Status:','parse','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','Transaction\x20ID:','loggerService','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','stack','Parsed\x20Result:','error','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','===\x20PLISIO\x20API\x20ERROR\x20===','350472RPPsOv','env','logWhiteDomainError','success','json','logWhiteDomainRequest','Unknown\x20error\x20from\x20Plisio\x20API','171589wgOVRH','Raw\x20tx_urls\x20data:','\x20->\x20','Invoice\x20URL:','Plisio\x20API\x20error:\x20','plisio_direct','now','Failed\x20to\x20parse\x20JSON\x20response:','https://api.trapay.uk/api/webhooks/gateway/plisio','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','status','(fiat\x20for\x20merchant)','❌\x20Failed\x20to\x20parse\x20tx_urls:','message','❌\x20URL\x20','append','306ZIFozb','⚠️\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','64hrrRdE','Failed\x20to\x20create\x20Plisio\x20payment:\x20','name','(crypto\x20for\x20payment)','tx_urls','invoice_total_sum','amount','txn_id','mismatch','fromEntries','toString','string','🔗\x20Formatted\x20URL:\x20','✅\x20URL\x20','PlisioService','HTTP\x20Status:','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','Error\x20message:','HTTP\x20error!\x20status:\x20','/invoices/new','map','currency','Amount:','PENDING','864480RMkHSQ','Source\x20Currency:','new',',\x20body:\x20','statusText','===\x20PLISIO\x20SUCCESS\x20===','JSON\x20Parse\x20Error:\x20','TesSoft\x20Payment\x20System/1.0','Error\x20Message:','../loggerService','GET','cancelled','3270890jElTNz','text','Business\x20Error:\x20','Error\x20stack:','forEach','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','Full\x20URL\x20(without\x20API\x20key):','Status\x20Text:','Error\x20details:','application/json','logWhiteDomainResponse','30105fNHBEh','log','Plisio\x20API\x20key\x20is\x20not\x20configured','apiUrl','email','280hvNhTe','6FPQoZc','warn','https://api.plisio.net/api/v1/operations/','2495EnqfuE','169ayRhTg','/operations/','data','order_number','source_currency','\x20is\x20invalid:\x20','replace','EXPIRED','invoice_url','284eolFTv','toLowerCase','Unknown\x20error','expired','isArray','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','apiKey','verifyPayment','defineProperty','qr_code','https://api.plisio.net/api/v1/invoices/new','355581UNgwNT','Response\x20Body:','entries','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url'];a44_0x2192=function(){return _0x1cef8a;};return a44_0x2192();}exports[a44_0x4d5957(0x137)]=PlisioService;