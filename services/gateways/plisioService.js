'use strict';const a41_0x24d25e=a41_0x591a;(function(_0x1cfe5a,_0x4a6b4c){const _0x5d1519=a41_0x591a,_0x4ca20b=_0x1cfe5a();while(!![]){try{const _0x24b425=parseInt(_0x5d1519(0x113))/0x1*(-parseInt(_0x5d1519(0xed))/0x2)+parseInt(_0x5d1519(0x114))/0x3+-parseInt(_0x5d1519(0x106))/0x4+parseInt(_0x5d1519(0x137))/0x5*(parseInt(_0x5d1519(0x11b))/0x6)+parseInt(_0x5d1519(0x13a))/0x7*(parseInt(_0x5d1519(0x126))/0x8)+parseInt(_0x5d1519(0xf6))/0x9+-parseInt(_0x5d1519(0x128))/0xa;if(_0x24b425===_0x4a6b4c)break;else _0x4ca20b['push'](_0x4ca20b['shift']());}catch(_0x4c697f){_0x4ca20b['push'](_0x4ca20b['shift']());}}}(a41_0x1c07,0x47f8b));function a41_0x1c07(){const _0x46ba44=[',\x20body:\x20','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','amount','parse','Response\x20Time:','logWhiteDomainResponse','2307685usYBev','Amount:','message','28yYZSRk','logWhiteDomainError','HTTP\x20Status:','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','URL:','toString','üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','Transaction\x20ID:','===\x20PLISIO\x20API\x20ERROR\x20===','completed','json','(fiat\x20for\x20merchant)','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','txn_id','Failed\x20to\x20create\x20Plisio\x20payment:\x20','new','Target\x20Currency:','Response\x20Body:','‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','Processing\x20Plisio\x20webhook:','GET','replace','text','PLISIO_API_KEY','Error\x20stack:','Failed\x20to\x20parse\x20JSON\x20response:','Error\x20message:','defineProperty','Parameters:','email','error','Error\x20details:','504SyGFTj','entries','verifyPayment','/operations/','currency','log','/invoices/new','Unknown\x20error\x20from\x20Plisio\x20API','processWebhook','4869324cFomBj','Plisio\x20API\x20key\x20is\x20not\x20configured','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','cancelled','qr_code','qr_url','source_currency','apiUrl','PlisioService','env','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','Raw\x20Response\x20Body:','__esModule','fromEntries','data','1160076SVApZC','Unknown\x20error','expired','stringify','loggerService','Business\x20Error:\x20','https://api.plisio.net/api/v1/operations/','Plisio\x20API\x20error:\x20','HIDDEN','source_amount','application/json','mismatch','Response\x20data:','37DAMaTo','1026810ZgIRLr','HTTP\x20error!\x20status:\x20','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','apiKey','HTTP\x20','Status:','logWhiteDomainRequest','6QcbJpx','PENDING','https://api.trapay.uk/api/webhooks/gateway/plisio','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','invoice_total_sum','success','TesSoft\x20Payment\x20System/1.0','stack','invoice_url','toLowerCase','JSON\x20Parse\x20Error:\x20','429208WYxltM','plisio_direct','9653090wFAido','createPayment','append','status','pending','Error\x20Message:','https://api.plisio.net/api/v1/invoices/new','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','now'];a41_0x1c07=function(){return _0x46ba44;};return a41_0x1c07();}Object[a41_0x24d25e(0xe8)](exports,a41_0x24d25e(0x103),{'value':!![]}),exports[a41_0x24d25e(0xff)]=void 0x0;const loggerService_1=require('../loggerService');class PlisioService{constructor(){const _0x3b0dc0=a41_0x24d25e;this['apiUrl']=_0x3b0dc0(0x12e),this['apiKey']=process[_0x3b0dc0(0x100)][_0x3b0dc0(0xe4)]||'',!this[_0x3b0dc0(0x117)]?console['warn'](_0x3b0dc0(0xdf)):console['log'](_0x3b0dc0(0x140));}async[a41_0x24d25e(0x129)](_0x4f4592){const _0x1cb165=a41_0x24d25e,{orderId:_0x230296,amount:_0x1d6ebd,currency:_0x47c7a,productName:_0x4fee73,description:_0x48f4eb,successUrl:_0xf6cfbf,failUrl:_0x7adad,customerEmail:_0x585c4b,customerName:_0x26e59c,isSourceCurrency:_0x1cfdd6,sourceCurrency:_0x273231}=_0x4f4592;if(!this[_0x1cb165(0x117)])throw new Error(_0x1cb165(0xf7));const _0x4f3321=new URLSearchParams({'api_key':this[_0x1cb165(0x117)],'order_number':_0x230296,'order_name':_0x4fee73,'description':_0x48f4eb,'success_url':_0xf6cfbf,'fail_url':_0x7adad,'callback_url':_0x1cb165(0x11d)});_0x273231?(_0x4f3321['append'](_0x1cb165(0xf1),_0x273231),_0x4f3321[_0x1cb165(0x12a)](_0x1cb165(0xfd),_0x47c7a),_0x4f3321[_0x1cb165(0x12a)](_0x1cb165(0x10f),_0x1d6ebd[_0x1cb165(0x13f)]())):(_0x4f3321[_0x1cb165(0x12a)]('currency',_0x47c7a),_0x4f3321[_0x1cb165(0x12a)](_0x1cb165(0x133),_0x1d6ebd[_0x1cb165(0x13f)]()));_0x585c4b&&_0x4f3321[_0x1cb165(0x12a)](_0x1cb165(0xea),_0x585c4b);_0x26e59c&&_0x4f3321['append']('name',_0x26e59c);const _0x1fae17=this['apiUrl']+'?'+_0x4f3321['toString'](),_0x2d32c4=Date[_0x1cb165(0x130)]();try{console[_0x1cb165(0xf2)](_0x1cb165(0x12f)),console['log'](_0x1cb165(0x13e),this[_0x1cb165(0xfe)]),console[_0x1cb165(0xf2)](_0x1cb165(0xe9),Object[_0x1cb165(0x104)](_0x4f3321[_0x1cb165(0xee)]())),console[_0x1cb165(0xf2)]('Full\x20URL\x20(without\x20API\x20key):',_0x1fae17[_0x1cb165(0xe2)](this['apiKey'],_0x1cb165(0x10e))),loggerService_1[_0x1cb165(0x10a)][_0x1cb165(0x11a)](_0x1cb165(0x127),'/invoices/new',_0x1cb165(0xe1),Object[_0x1cb165(0x104)](_0x4f3321[_0x1cb165(0xee)]()));const _0x5801b0=await fetch(_0x1fae17,{'method':_0x1cb165(0xe1),'headers':{'Accept':_0x1cb165(0x110),'User-Agent':_0x1cb165(0x121)}}),_0x2f42ea=Date[_0x1cb165(0x130)]()-_0x2d32c4;console['log'](_0x1cb165(0x13d)),console[_0x1cb165(0xf2)](_0x1cb165(0x119),_0x5801b0[_0x1cb165(0x12b)]),console[_0x1cb165(0xf2)]('Status\x20Text:',_0x5801b0['statusText']),console[_0x1cb165(0xf2)](_0x1cb165(0x135),_0x2f42ea+'ms');const _0x267db8=await _0x5801b0[_0x1cb165(0xe3)]();console[_0x1cb165(0xf2)](_0x1cb165(0x102),_0x267db8);if(!_0x5801b0['ok']){console['error'](_0x1cb165(0x142)),console[_0x1cb165(0xeb)](_0x1cb165(0x13c),_0x5801b0[_0x1cb165(0x12b)]),console[_0x1cb165(0xeb)](_0x1cb165(0xde),_0x267db8),loggerService_1['loggerService'][_0x1cb165(0x136)](_0x1cb165(0x127),_0x1cb165(0xf3),_0x5801b0[_0x1cb165(0x12b)],_0x267db8,_0x2f42ea),loggerService_1[_0x1cb165(0x10a)][_0x1cb165(0x13b)]('plisio_direct',_0x1cb165(0xf3),_0x1cb165(0x118)+_0x5801b0['status']+':\x20'+_0x267db8);throw new Error('HTTP\x20error!\x20status:\x20'+_0x5801b0['status']+_0x1cb165(0x131)+_0x267db8);}let _0x50a3cf;try{_0x50a3cf=JSON[_0x1cb165(0x134)](_0x267db8);}catch(_0x818a37){console['error'](_0x1cb165(0xe6),_0x818a37),loggerService_1[_0x1cb165(0x10a)]['logWhiteDomainError'](_0x1cb165(0x127),_0x1cb165(0xf3),_0x1cb165(0x125)+_0x818a37);throw new Error(_0x1cb165(0x101)+_0x267db8);}console[_0x1cb165(0xf2)](_0x1cb165(0xf9)),console[_0x1cb165(0xf2)]('Parsed\x20Result:',JSON[_0x1cb165(0x109)](_0x50a3cf,null,0x2)),loggerService_1[_0x1cb165(0x10a)]['logWhiteDomainResponse'](_0x1cb165(0x127),_0x1cb165(0xf3),_0x5801b0[_0x1cb165(0x12b)],_0x50a3cf,_0x2f42ea);if(_0x50a3cf[_0x1cb165(0x12b)]!==_0x1cb165(0x120)){const _0x444c74=_0x50a3cf[_0x1cb165(0x139)]||_0x50a3cf[_0x1cb165(0xeb)]||_0x1cb165(0xf4);console[_0x1cb165(0xeb)]('===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20==='),console['error'](_0x1cb165(0x12d),_0x444c74),loggerService_1[_0x1cb165(0x10a)]['logWhiteDomainError'](_0x1cb165(0x127),_0x1cb165(0xf3),_0x1cb165(0x10b)+_0x444c74);throw new Error(_0x1cb165(0x10d)+_0x444c74);}if(!_0x50a3cf['data']?.['txn_id']||!_0x50a3cf[_0x1cb165(0x105)]?.[_0x1cb165(0x123)]){console[_0x1cb165(0xeb)](_0x1cb165(0xd9)),console[_0x1cb165(0xeb)](_0x1cb165(0x11e)),console[_0x1cb165(0xeb)](_0x1cb165(0x112),_0x50a3cf[_0x1cb165(0x105)]),loggerService_1[_0x1cb165(0x10a)]['logWhiteDomainError'](_0x1cb165(0x127),'/invoices/new',_0x1cb165(0x116));throw new Error('Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url');}return console[_0x1cb165(0xf2)]('===\x20PLISIO\x20SUCCESS\x20==='),console[_0x1cb165(0xf2)](_0x1cb165(0x141),_0x50a3cf[_0x1cb165(0x105)]['txn_id']),console[_0x1cb165(0xf2)]('Invoice\x20URL:',_0x50a3cf[_0x1cb165(0x105)]['invoice_url']),console['log'](_0x1cb165(0x138),_0x1d6ebd,_0x47c7a),_0x273231&&(console[_0x1cb165(0xf2)]('Source\x20Currency:',_0x273231,'(crypto\x20for\x20payment)'),console['log'](_0x1cb165(0xdd),_0x47c7a,_0x1cb165(0xd8))),{'gateway_payment_id':_0x50a3cf['data'][_0x1cb165(0xda)],'payment_url':_0x50a3cf[_0x1cb165(0x105)][_0x1cb165(0x123)],'invoice_total_sum':_0x50a3cf[_0x1cb165(0x105)][_0x1cb165(0x11f)],'qr_code':_0x50a3cf[_0x1cb165(0x105)][_0x1cb165(0xfb)],'qr_url':_0x50a3cf[_0x1cb165(0x105)][_0x1cb165(0xfc)]};}catch(_0x398896){console[_0x1cb165(0xeb)]('===\x20PLISIO\x20SERVICE\x20ERROR\x20==='),console[_0x1cb165(0xeb)](_0x1cb165(0xec),_0x398896),loggerService_1[_0x1cb165(0x10a)]['logWhiteDomainError'](_0x1cb165(0x127),_0x1cb165(0xf3),_0x398896);if(_0x398896 instanceof Error){console[_0x1cb165(0xeb)](_0x1cb165(0xe7),_0x398896[_0x1cb165(0x139)]),console[_0x1cb165(0xeb)](_0x1cb165(0xe5),_0x398896[_0x1cb165(0x122)]);throw new Error(_0x1cb165(0xdb)+_0x398896[_0x1cb165(0x139)]);}throw new Error(_0x1cb165(0xf8));}}async[a41_0x24d25e(0xef)](_0x4c14ad){const _0x969c4f=a41_0x24d25e,_0x5d7a26=Date[_0x969c4f(0x130)]();try{if(!this[_0x969c4f(0x117)])throw new Error(_0x969c4f(0xf7));const _0x1df320=new URLSearchParams({'api_key':this[_0x969c4f(0x117)],'txn_id':_0x4c14ad}),_0x3d0510=_0x969c4f(0x10c)+_0x4c14ad+'?'+_0x1df320[_0x969c4f(0x13f)]();loggerService_1[_0x969c4f(0x10a)][_0x969c4f(0x11a)]('plisio_direct',_0x969c4f(0xf0)+_0x4c14ad,_0x969c4f(0xe1),Object[_0x969c4f(0x104)](_0x1df320[_0x969c4f(0xee)]()));const _0x33c583=await fetch(_0x3d0510,{'method':_0x969c4f(0xe1),'headers':{'Accept':_0x969c4f(0x110),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x13e58f=Date[_0x969c4f(0x130)]()-_0x5d7a26;if(!_0x33c583['ok']){const _0x13b9af=await _0x33c583[_0x969c4f(0xe3)]();loggerService_1['loggerService'][_0x969c4f(0x136)]('plisio_direct',_0x969c4f(0xf0)+_0x4c14ad,_0x33c583['status'],_0x13b9af,_0x13e58f);throw new Error(_0x969c4f(0x115)+_0x33c583[_0x969c4f(0x12b)]);}const _0x410b88=await _0x33c583[_0x969c4f(0xd7)]();loggerService_1['loggerService'][_0x969c4f(0x136)](_0x969c4f(0x127),_0x969c4f(0xf0)+_0x4c14ad,_0x33c583[_0x969c4f(0x12b)],_0x410b88,_0x13e58f);if(_0x410b88[_0x969c4f(0x12b)]!=='success'){loggerService_1[_0x969c4f(0x10a)][_0x969c4f(0x13b)]('plisio_direct',_0x969c4f(0xf0)+_0x4c14ad,_0x969c4f(0x10d)+(_0x410b88['message']||_0x410b88[_0x969c4f(0xeb)]||_0x969c4f(0x107)));throw new Error(_0x969c4f(0x10d)+(_0x410b88['message']||_0x410b88[_0x969c4f(0xeb)]||_0x969c4f(0x107)));}let _0x5d23d2=_0x969c4f(0x11c);return{'status':_0x5d23d2};}catch(_0x41cc37){console[_0x969c4f(0xeb)]('Plisio\x20payment\x20verification\x20error:',_0x41cc37),loggerService_1[_0x969c4f(0x10a)]['logWhiteDomainError'](_0x969c4f(0x127),_0x969c4f(0xf0)+_0x4c14ad,_0x41cc37);throw new Error(_0x969c4f(0x132)+(_0x41cc37 instanceof Error?_0x41cc37['message']:'Unknown\x20error'));}}async[a41_0x24d25e(0xf5)](_0x9e19c8){const _0x24b987=a41_0x24d25e;console[_0x24b987(0xf2)](_0x24b987(0xe0),_0x9e19c8);let _0x20f5cf=_0x24b987(0x11c);switch(_0x9e19c8[_0x24b987(0x12b)]?.[_0x24b987(0x124)]()){case _0x24b987(0xd6):case _0x24b987(0x111):_0x20f5cf='PAID';break;case _0x24b987(0x108):_0x20f5cf='EXPIRED';break;case'error':case _0x24b987(0xfa):_0x20f5cf='FAILED';break;case _0x24b987(0xdc):case _0x24b987(0x12c):default:_0x20f5cf='PENDING';break;}return{'paymentId':_0x9e19c8['order_number']||'','status':_0x20f5cf,'amount':_0x9e19c8['amount'],'currency':_0x9e19c8[_0x24b987(0xf1)]};}}function a41_0x591a(_0x18aa80,_0x1301ca){const _0x1c0748=a41_0x1c07();return a41_0x591a=function(_0x591ab1,_0x3bf6a1){_0x591ab1=_0x591ab1-0xd6;let _0x35d198=_0x1c0748[_0x591ab1];return _0x35d198;},a41_0x591a(_0x18aa80,_0x1301ca);}exports[a41_0x24d25e(0xff)]=PlisioService;