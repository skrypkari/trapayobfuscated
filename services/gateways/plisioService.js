'use strict';const a43_0x3b4e07=a43_0x35ea;(function(_0x25516e,_0x2686e2){const _0x2afbf7=a43_0x35ea,_0x24e6d9=_0x25516e();while(!![]){try{const _0x13de0f=parseInt(_0x2afbf7(0x13d))/0x1*(parseInt(_0x2afbf7(0x153))/0x2)+-parseInt(_0x2afbf7(0x146))/0x3+parseInt(_0x2afbf7(0x10d))/0x4+parseInt(_0x2afbf7(0x107))/0x5*(-parseInt(_0x2afbf7(0x126))/0x6)+parseInt(_0x2afbf7(0x110))/0x7*(-parseInt(_0x2afbf7(0x115))/0x8)+-parseInt(_0x2afbf7(0xf6))/0x9+parseInt(_0x2afbf7(0x13f))/0xa*(parseInt(_0x2afbf7(0x129))/0xb);if(_0x13de0f===_0x2686e2)break;else _0x24e6d9['push'](_0x24e6d9['shift']());}catch(_0x5b2cf1){_0x24e6d9['push'](_0x24e6d9['shift']());}}}(a43_0x2e39,0x3aaf1));Object[a43_0x3b4e07(0x147)](exports,'__esModule',{'value':!![]}),exports['PlisioService']=void 0x0;function a43_0x2e39(){const _0x4cc0e0=['11081147lYYkex','‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','PAID','Full\x20URL\x20(without\x20API\x20key):','PlisioService','new','===\x20PLISIO\x20SUCCESS\x20===','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','map','data','stack','Plisio\x20API\x20error:\x20','error','txn_id','Invoice\x20URL:',',\x20body:\x20','currency','Raw\x20Response\x20Body:','Error\x20details:','EXPIRED','1XhDhNK','email','10OAboxJ','mismatch','PLISIO_API_KEY','statusText','amount','expired','plisio_direct','710223AKkaBC','defineProperty','invoice_url','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','‚ùå\x20Failed\x20to\x20parse\x20tx_urls:','FAILED','Processing\x20Plisio\x20webhook:','log','TesSoft\x20Payment\x20System/1.0','(fiat\x20for\x20merchant)','Transaction\x20ID:','PENDING','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','154962fsfuAa','append','Response\x20Body:','HIDDEN','status','source_amount','invoice_total_sum','text','apiUrl','HTTP\x20Status:','toString','Unknown\x20error','Source\x20Currency:','https://api.plisio.net/api/v1/invoices/new','Error\x20message:','source_currency','Response\x20Time:','apiKey','URL:','Failed\x20to\x20create\x20Plisio\x20payment:\x20','/operations/','3282120TDJOSd','now','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','Parsed\x20Result:','\x20->\x20','Error\x20Message:','üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','Unknown\x20error\x20from\x20Plisio\x20API','‚ùå\x20URL\x20','entries','qr_url','JSON\x20Parse\x20Error:\x20','completed','Response\x20data:','replace','‚úÖ\x20URL\x20','fromEntries','7495rOAgpc','loggerService','application/json','logWhiteDomainResponse','Plisio\x20API\x20key\x20is\x20not\x20configured','(crypto\x20for\x20payment)','520244xQdhDX','message','warn','58646QkVSDg','logWhiteDomainRequest','success','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','/invoices/new','352NQXuNI','Plisio\x20payment\x20verification\x20error:','name','GET','logWhiteDomainError','parse','string','Failed\x20to\x20parse\x20JSON\x20response:','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','Status:','Amount:','HTTP\x20','===\x20PLISIO\x20API\x20ERROR\x20===','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','tx_urls','https://api.plisio.net/api/v1/operations/','18uidBAj','HTTP\x20error!\x20status:\x20','json'];a43_0x2e39=function(){return _0x4cc0e0;};return a43_0x2e39();}function a43_0x35ea(_0x35d853,_0x1e85ce){const _0x2e3944=a43_0x2e39();return a43_0x35ea=function(_0x35ea23,_0x3d3dce){_0x35ea23=_0x35ea23-0xe4;let _0x4dd378=_0x2e3944[_0x35ea23];return _0x4dd378;},a43_0x35ea(_0x35d853,_0x1e85ce);}const loggerService_1=require('../loggerService');class PlisioService{constructor(){const _0x3db9aa=a43_0x3b4e07;this[_0x3db9aa(0xe9)]=_0x3db9aa(0xee),this['apiKey']=process['env'][_0x3db9aa(0x141)]||'',!this[_0x3db9aa(0xf2)]?console[_0x3db9aa(0x10f)](_0x3db9aa(0x12a)):console[_0x3db9aa(0x14d)](_0x3db9aa(0xfc));}async['createPayment'](_0x2dba32){const _0x285e1e=a43_0x3b4e07,{orderId:_0x6a5e92,amount:_0x317ace,currency:_0x522cf7,productName:_0x4a4c79,description:_0xaa2fd2,successUrl:_0x1a09c6,failUrl:_0x5577c7,customerEmail:_0x51e411,customerName:_0x433b60,isSourceCurrency:_0x233811,sourceCurrency:_0x1740f3}=_0x2dba32;if(!this[_0x285e1e(0xf2)])throw new Error(_0x285e1e(0x10b));const _0x434fa6=new URLSearchParams({'api_key':this['apiKey'],'order_number':_0x6a5e92,'order_name':_0x4a4c79,'description':_0xaa2fd2,'success_url':_0x1a09c6,'fail_url':_0x5577c7,'callback_url':'https://apitest.trapay.uk/api/webhooks/gateway/plisio'});_0x1740f3?(_0x434fa6['append'](_0x285e1e(0x139),_0x1740f3),_0x434fa6[_0x285e1e(0x154)](_0x285e1e(0xf0),_0x522cf7),_0x434fa6[_0x285e1e(0x154)](_0x285e1e(0xe6),_0x317ace['toString']())):(_0x434fa6[_0x285e1e(0x154)]('currency',_0x522cf7),_0x434fa6[_0x285e1e(0x154)]('amount',_0x317ace[_0x285e1e(0xeb)]()));_0x51e411&&_0x434fa6[_0x285e1e(0x154)](_0x285e1e(0x13e),_0x51e411);_0x433b60&&_0x434fa6[_0x285e1e(0x154)](_0x285e1e(0x117),_0x433b60);const _0x1df1e4=this[_0x285e1e(0xe9)]+'?'+_0x434fa6['toString'](),_0x430fe5=Date[_0x285e1e(0xf7)]();try{console[_0x285e1e(0x14d)](_0x285e1e(0x11d)),console[_0x285e1e(0x14d)](_0x285e1e(0xf3),this['apiUrl']),console['log']('Parameters:',Object[_0x285e1e(0x106)](_0x434fa6[_0x285e1e(0xff)]())),console['log'](_0x285e1e(0x12c),_0x1df1e4[_0x285e1e(0x104)](this[_0x285e1e(0xf2)],_0x285e1e(0xe4))),loggerService_1[_0x285e1e(0x108)][_0x285e1e(0x111)](_0x285e1e(0x145),_0x285e1e(0x114),_0x285e1e(0x118),Object[_0x285e1e(0x106)](_0x434fa6[_0x285e1e(0xff)]()));const _0x38573b=await fetch(_0x1df1e4,{'method':_0x285e1e(0x118),'headers':{'Accept':_0x285e1e(0x109),'User-Agent':_0x285e1e(0x14e)}}),_0x35f401=Date[_0x285e1e(0xf7)]()-_0x430fe5;console[_0x285e1e(0x14d)]('===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20==='),console[_0x285e1e(0x14d)](_0x285e1e(0x11e),_0x38573b[_0x285e1e(0xe5)]),console[_0x285e1e(0x14d)]('Status\x20Text:',_0x38573b[_0x285e1e(0x142)]),console[_0x285e1e(0x14d)](_0x285e1e(0xf1),_0x35f401+'ms');const _0x33be5c=await _0x38573b['text']();console[_0x285e1e(0x14d)](_0x285e1e(0x13a),_0x33be5c);if(!_0x38573b['ok']){console[_0x285e1e(0x135)](_0x285e1e(0x121)),console[_0x285e1e(0x135)](_0x285e1e(0xea),_0x38573b[_0x285e1e(0xe5)]),console[_0x285e1e(0x135)](_0x285e1e(0x155),_0x33be5c),loggerService_1[_0x285e1e(0x108)][_0x285e1e(0x10a)]('plisio_direct',_0x285e1e(0x114),_0x38573b[_0x285e1e(0xe5)],_0x33be5c,_0x35f401),loggerService_1[_0x285e1e(0x108)][_0x285e1e(0x119)]('plisio_direct','/invoices/new',_0x285e1e(0x120)+_0x38573b[_0x285e1e(0xe5)]+':\x20'+_0x33be5c);throw new Error(_0x285e1e(0x127)+_0x38573b[_0x285e1e(0xe5)]+_0x285e1e(0x138)+_0x33be5c);}let _0x308f3e;try{_0x308f3e=JSON[_0x285e1e(0x11a)](_0x33be5c);}catch(_0x4adf65){console[_0x285e1e(0x135)](_0x285e1e(0x11c),_0x4adf65),loggerService_1[_0x285e1e(0x108)][_0x285e1e(0x119)]('plisio_direct','/invoices/new',_0x285e1e(0x101)+_0x4adf65);throw new Error(_0x285e1e(0x122)+_0x33be5c);}console[_0x285e1e(0x14d)](_0x285e1e(0x149)),console[_0x285e1e(0x14d)](_0x285e1e(0xf9),JSON['stringify'](_0x308f3e,null,0x2)),loggerService_1[_0x285e1e(0x108)][_0x285e1e(0x10a)](_0x285e1e(0x145),_0x285e1e(0x114),_0x38573b[_0x285e1e(0xe5)],_0x308f3e,_0x35f401);if(_0x308f3e[_0x285e1e(0xe5)]!=='success'){const _0x4d0afe=_0x308f3e[_0x285e1e(0x10e)]||_0x308f3e['error']||_0x285e1e(0xfd);console[_0x285e1e(0x135)](_0x285e1e(0xf8)),console[_0x285e1e(0x135)](_0x285e1e(0xfb),_0x4d0afe),loggerService_1[_0x285e1e(0x108)][_0x285e1e(0x119)](_0x285e1e(0x145),'/invoices/new','Business\x20Error:\x20'+_0x4d0afe);throw new Error(_0x285e1e(0x134)+_0x4d0afe);}if(!_0x308f3e[_0x285e1e(0x132)]?.[_0x285e1e(0x136)]||!_0x308f3e['data']?.[_0x285e1e(0x148)]){console[_0x285e1e(0x135)](_0x285e1e(0x123)),console[_0x285e1e(0x135)](_0x285e1e(0x130)),console[_0x285e1e(0x135)](_0x285e1e(0x103),_0x308f3e['data']),loggerService_1['loggerService'][_0x285e1e(0x119)](_0x285e1e(0x145),'/invoices/new',_0x285e1e(0x113));throw new Error('Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url');}return console[_0x285e1e(0x14d)](_0x285e1e(0x12f)),console['log'](_0x285e1e(0x150),_0x308f3e[_0x285e1e(0x132)][_0x285e1e(0x136)]),console[_0x285e1e(0x14d)](_0x285e1e(0x137),_0x308f3e[_0x285e1e(0x132)][_0x285e1e(0x148)]),console[_0x285e1e(0x14d)](_0x285e1e(0x11f),_0x317ace,_0x522cf7),_0x1740f3&&(console[_0x285e1e(0x14d)](_0x285e1e(0xed),_0x1740f3,_0x285e1e(0x10c)),console['log']('Target\x20Currency:',_0x522cf7,_0x285e1e(0x14f))),{'gateway_payment_id':_0x308f3e[_0x285e1e(0x132)][_0x285e1e(0x136)],'payment_url':_0x308f3e[_0x285e1e(0x132)][_0x285e1e(0x148)],'invoice_total_sum':_0x308f3e['data'][_0x285e1e(0xe7)],'qr_code':_0x308f3e[_0x285e1e(0x132)]['qr_code'],'qr_url':_0x308f3e[_0x285e1e(0x132)][_0x285e1e(0x100)]};}catch(_0x4e6fc6){console[_0x285e1e(0x135)](_0x285e1e(0x152)),console['error'](_0x285e1e(0x13b),_0x4e6fc6),loggerService_1[_0x285e1e(0x108)][_0x285e1e(0x119)](_0x285e1e(0x145),_0x285e1e(0x114),_0x4e6fc6);if(_0x4e6fc6 instanceof Error){console[_0x285e1e(0x135)](_0x285e1e(0xef),_0x4e6fc6['message']),console[_0x285e1e(0x135)]('Error\x20stack:',_0x4e6fc6[_0x285e1e(0x133)]);throw new Error(_0x285e1e(0xf4)+_0x4e6fc6[_0x285e1e(0x10e)]);}throw new Error('Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error');}}async['verifyPayment'](_0x347d1d){const _0x69e059=a43_0x3b4e07,_0x2b6b3c=Date[_0x69e059(0xf7)]();try{if(!this[_0x69e059(0xf2)])throw new Error(_0x69e059(0x10b));const _0x35486b=new URLSearchParams({'api_key':this[_0x69e059(0xf2)],'txn_id':_0x347d1d}),_0x2bf105=_0x69e059(0x125)+_0x347d1d+'?'+_0x35486b[_0x69e059(0xeb)]();loggerService_1[_0x69e059(0x108)]['logWhiteDomainRequest'](_0x69e059(0x145),_0x69e059(0xf5)+_0x347d1d,'GET',Object[_0x69e059(0x106)](_0x35486b[_0x69e059(0xff)]()));const _0x11a4ae=await fetch(_0x2bf105,{'method':_0x69e059(0x118),'headers':{'Accept':_0x69e059(0x109),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x4f1344=Date[_0x69e059(0xf7)]()-_0x2b6b3c;if(!_0x11a4ae['ok']){const _0x31f2ac=await _0x11a4ae[_0x69e059(0xe8)]();loggerService_1[_0x69e059(0x108)][_0x69e059(0x10a)](_0x69e059(0x145),_0x69e059(0xf5)+_0x347d1d,_0x11a4ae['status'],_0x31f2ac,_0x4f1344);throw new Error(_0x69e059(0x127)+_0x11a4ae[_0x69e059(0xe5)]);}const _0x5e5157=await _0x11a4ae[_0x69e059(0x128)]();loggerService_1[_0x69e059(0x108)]['logWhiteDomainResponse'](_0x69e059(0x145),_0x69e059(0xf5)+_0x347d1d,_0x11a4ae[_0x69e059(0xe5)],_0x5e5157,_0x4f1344);if(_0x5e5157[_0x69e059(0xe5)]!==_0x69e059(0x112)){loggerService_1['loggerService']['logWhiteDomainError'](_0x69e059(0x145),_0x69e059(0xf5)+_0x347d1d,_0x69e059(0x134)+(_0x5e5157['message']||_0x5e5157[_0x69e059(0x135)]||_0x69e059(0xec)));throw new Error(_0x69e059(0x134)+(_0x5e5157[_0x69e059(0x10e)]||_0x5e5157['error']||_0x69e059(0xec)));}let _0x2103b2='PENDING';return{'status':_0x2103b2};}catch(_0x2c15f9){console[_0x69e059(0x135)](_0x69e059(0x116),_0x2c15f9),loggerService_1[_0x69e059(0x108)][_0x69e059(0x119)](_0x69e059(0x145),'/operations/'+_0x347d1d,_0x2c15f9);throw new Error('Failed\x20to\x20verify\x20Plisio\x20payment:\x20'+(_0x2c15f9 instanceof Error?_0x2c15f9[_0x69e059(0x10e)]:_0x69e059(0xec)));}}async['processWebhook'](_0x47fc27){const _0x34f2c9=a43_0x3b4e07;console[_0x34f2c9(0x14d)](_0x34f2c9(0x14c),_0x47fc27);let _0xb1cbaf=_0x34f2c9(0x151);switch(_0x47fc27['status']?.['toLowerCase']()){case _0x34f2c9(0x102):case _0x34f2c9(0x140):_0xb1cbaf=_0x34f2c9(0x12b);break;case _0x34f2c9(0x144):_0xb1cbaf=_0x34f2c9(0x13c);break;case _0x34f2c9(0x135):case'cancelled':_0xb1cbaf=_0x34f2c9(0x14b);break;case _0x34f2c9(0x12e):case'pending':default:_0xb1cbaf=_0x34f2c9(0x151);break;}let _0x5c5349;if(_0x47fc27[_0x34f2c9(0x124)])try{console[_0x34f2c9(0x14d)]('üîó\x20Raw\x20tx_urls\x20from\x20Plisio:',_0x47fc27['tx_urls']);let _0x3db2f6;if(typeof _0x47fc27[_0x34f2c9(0x124)]===_0x34f2c9(0x11b))_0x3db2f6=JSON[_0x34f2c9(0x11a)](_0x47fc27['tx_urls']);else Array['isArray'](_0x47fc27[_0x34f2c9(0x124)])?_0x3db2f6=_0x47fc27['tx_urls']:_0x3db2f6=[];_0x5c5349=_0x3db2f6[_0x34f2c9(0x131)](_0x124673=>{const _0x3c4b96=_0x34f2c9,_0x5280b4=_0x124673[_0x3c4b96(0x104)](/\\/g,'');return console[_0x3c4b96(0x14d)]('üîó\x20Formatted\x20URL:\x20'+_0x124673+_0x3c4b96(0xfa)+_0x5280b4),_0x5280b4;}),console[_0x34f2c9(0x14d)]('‚úÖ\x20Processed\x20tx_urls:',_0x5c5349),_0x5c5349['forEach']((_0x2d24c9,_0x13f6ab)=>{const _0x437d89=_0x34f2c9;try{new URL(_0x2d24c9),console[_0x437d89(0x14d)](_0x437d89(0x105)+(_0x13f6ab+0x1)+'\x20is\x20valid:\x20'+_0x2d24c9);}catch(_0x100592){console[_0x437d89(0x135)](_0x437d89(0xfe)+(_0x13f6ab+0x1)+'\x20is\x20invalid:\x20'+_0x2d24c9,_0x100592);}});}catch(_0x50a75b){console['error'](_0x34f2c9(0x14a),_0x50a75b),console[_0x34f2c9(0x135)]('Raw\x20tx_urls\x20data:',_0x47fc27[_0x34f2c9(0x124)]),_0x5c5349=undefined;}return{'paymentId':_0x47fc27['order_number']||'','status':_0xb1cbaf,'amount':_0x47fc27[_0x34f2c9(0x143)],'currency':_0x47fc27[_0x34f2c9(0x139)],'txUrls':_0x5c5349};}}exports[a43_0x3b4e07(0x12d)]=PlisioService;