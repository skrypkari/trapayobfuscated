'use strict';const a70_0x21ea3c=a70_0x5200;(function(_0x1f59b2,_0x1c658c){const _0x18ecfd=a70_0x5200,_0x2d2c41=_0x1f59b2();while(!![]){try{const _0x3b78da=parseInt(_0x18ecfd(0x21e))/0x1*(-parseInt(_0x18ecfd(0x206))/0x2)+-parseInt(_0x18ecfd(0x204))/0x3+-parseInt(_0x18ecfd(0x22f))/0x4+-parseInt(_0x18ecfd(0x20c))/0x5+parseInt(_0x18ecfd(0x231))/0x6+-parseInt(_0x18ecfd(0x1e8))/0x7*(-parseInt(_0x18ecfd(0x200))/0x8)+parseInt(_0x18ecfd(0x1f0))/0x9;if(_0x3b78da===_0x1c658c)break;else _0x2d2c41['push'](_0x2d2c41['shift']());}catch(_0x2eb03e){_0x2d2c41['push'](_0x2d2c41['shift']());}}}(a70_0x9a9c,0xaeec9));function a70_0x9a9c(){const _0x3dd709=['qr_url','invoice_total_sum','message','FAILED','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','PlisioService','Response\x20Time:','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','Parsed\x20Result:','verifyPayment','txn_id','HTTP\x20error!\x20status:\x20','apiUrl','/invoices/new','PENDING','Full\x20URL\x20(without\x20API\x20key):','logWhiteDomainResponse','https://api.plisio.net/api/v1/invoices/new','98315yoUCbs','Amount:','Plisio\x20API\x20error:\x20','/operations/','stringify','https://api.plisio.net/api/v1/operations/','isArray','defineProperty','5246676aVLwLn','__esModule','Business\x20Error:\x20','toString','entries','now','\x20is\x20valid:\x20','application/json','replace','pending','Transaction\x20ID:','JSON\x20Parse\x20Error:\x20','logWhiteDomainError','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','âœ…\x20URL\x20','currency','440mVuJYf','Error\x20stack:','===\x20PLISIO\x20SUCCESS\x20===','https://api.trapay.uk/api/webhooks/gateway/plisio','151962gxeziZ','ðŸ”—\x20Raw\x20tx_urls\x20from\x20Plisio:','69064TfcoQp','Failed\x20to\x20parse\x20JSON\x20response:','\x20->\x20','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','HTTP\x20Status:','../loggerService','6061245NRHGPT','text','toLowerCase','Failed\x20to\x20create\x20Plisio\x20payment:\x20','logWhiteDomainRequest','Target\x20Currency:','expired','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','Response\x20Body:','Unknown\x20error\x20from\x20Plisio\x20API','append','Error\x20details:','statusText','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','Plisio\x20API\x20key\x20is\x20not\x20configured','âŒ\x20URL\x20','plisio_direct','Processing\x20Plisio\x20webhook:','4dujRQH','error','ðŸ”—\x20Formatted\x20URL:\x20','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','Invoice\x20URL:','(crypto\x20for\x20payment)','Parameters:','apiKey','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','data','source_currency','Source\x20Currency:','Raw\x20Response\x20Body:','Status:','Error\x20Message:','Payment\x20System/1.0','Error\x20message:','974660uUEzAc','invoice_url','6034476SDaLRi','Plisio\x20payment\x20verification\x20error:','map','forEach','string','amount','PROCESSING','completed','status','qr_code','GET','âœ…\x20Processed\x20tx_urls:','stack','loggerService','source_amount','âŒ\x20Failed\x20to\x20parse\x20tx_urls:','order_number','tx_urls','===\x20PLISIO\x20API\x20ERROR\x20===','success','log','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','Unknown\x20error','\x20is\x20invalid:\x20','fromEntries',',\x20body:\x20','PAID','name','HTTP\x20'];a70_0x9a9c=function(){return _0x3dd709;};return a70_0x9a9c();}function a70_0x5200(_0x3e1e2c,_0x3fa0a6){_0x3e1e2c=_0x3e1e2c-0x1be;const _0x9a9cad=a70_0x9a9c();let _0x520082=_0x9a9cad[_0x3e1e2c];return _0x520082;}Object[a70_0x21ea3c(0x1ef)](exports,a70_0x21ea3c(0x1f1),{'value':!![]}),exports['PlisioService']=void 0x0;const loggerService_1=require(a70_0x21ea3c(0x20b));class PlisioService{constructor(){const _0x357ea6=a70_0x21ea3c;this[_0x357ea6(0x1e2)]=_0x357ea6(0x1e7),this[_0x357ea6(0x225)]=process.env.PLISIO_API_KEY||'',!this[_0x357ea6(0x225)]?console['warn']('âš ï¸\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables'):console[_0x357ea6(0x1cc)]('ðŸ’°\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API');}async['createPayment'](_0x164470){const _0x284eef=a70_0x21ea3c,{orderId:_0x4e470b,amount:_0x51a240,currency:_0x411adb,productName:_0x539143,description:_0x42f858,successUrl:_0x5113e4,failUrl:_0x355af7,customerEmail:_0x12e9f1,customerName:_0x4a7c44,isSourceCurrency:_0x2871ec,sourceCurrency:_0x242994}=_0x164470;if(!this[_0x284eef(0x225)])throw new Error(_0x284eef(0x21a));const _0x3f7896=new URLSearchParams({'api_key':this[_0x284eef(0x225)],'order_number':_0x4e470b,'order_name':_0x539143,'description':_0x42f858,'success_url':_0x5113e4,'fail_url':_0x355af7,'callback_url':_0x284eef(0x203)});_0x242994?(_0x3f7896[_0x284eef(0x216)](_0x284eef(0x1ff),_0x242994),_0x3f7896['append'](_0x284eef(0x228),_0x411adb),_0x3f7896[_0x284eef(0x216)](_0x284eef(0x1c6),_0x51a240[_0x284eef(0x1f3)]())):(_0x3f7896['append']('currency',_0x411adb),_0x3f7896[_0x284eef(0x216)](_0x284eef(0x236),_0x51a240[_0x284eef(0x1f3)]()));_0x12e9f1&&_0x3f7896[_0x284eef(0x216)]('email',_0x12e9f1);_0x4a7c44&&_0x3f7896[_0x284eef(0x216)](_0x284eef(0x1d4),_0x4a7c44);const _0x5acfc9=this[_0x284eef(0x1e2)]+'?'+_0x3f7896[_0x284eef(0x1f3)](),_0x1cd9cf=Date[_0x284eef(0x1f5)]();try{console[_0x284eef(0x1cc)](_0x284eef(0x1dd)),console[_0x284eef(0x1cc)]('URL:',this[_0x284eef(0x1e2)]),console[_0x284eef(0x1cc)](_0x284eef(0x224),Object['fromEntries'](_0x3f7896[_0x284eef(0x1f4)]())),console[_0x284eef(0x1cc)](_0x284eef(0x1e5),_0x5acfc9[_0x284eef(0x1f8)](this[_0x284eef(0x225)],'HIDDEN')),loggerService_1[_0x284eef(0x1c5)][_0x284eef(0x210)](_0x284eef(0x21c),_0x284eef(0x1e3),_0x284eef(0x1c2),Object[_0x284eef(0x1d1)](_0x3f7896[_0x284eef(0x1f4)]()));const _0x55ed26=await fetch(_0x5acfc9,{'method':_0x284eef(0x1c2),'headers':{'Accept':'application/json','User-Agent':'Payment\x20System/1.0'}}),_0x57de7a=Date[_0x284eef(0x1f5)]()-_0x1cd9cf;console[_0x284eef(0x1cc)](_0x284eef(0x221)),console[_0x284eef(0x1cc)](_0x284eef(0x22b),_0x55ed26[_0x284eef(0x1c0)]),console['log']('Status\x20Text:',_0x55ed26[_0x284eef(0x218)]),console['log'](_0x284eef(0x1dc),_0x57de7a+'ms');const _0x3aa8c7=await _0x55ed26[_0x284eef(0x20d)]();console[_0x284eef(0x1cc)](_0x284eef(0x22a),_0x3aa8c7);if(!_0x55ed26['ok']){console[_0x284eef(0x21f)](_0x284eef(0x1ca)),console['error'](_0x284eef(0x20a),_0x55ed26['status']),console[_0x284eef(0x21f)](_0x284eef(0x214),_0x3aa8c7),loggerService_1[_0x284eef(0x1c5)]['logWhiteDomainResponse'](_0x284eef(0x21c),_0x284eef(0x1e3),_0x55ed26[_0x284eef(0x1c0)],_0x3aa8c7,_0x57de7a),loggerService_1[_0x284eef(0x1c5)][_0x284eef(0x1fc)](_0x284eef(0x21c),_0x284eef(0x1e3),_0x284eef(0x1d5)+_0x55ed26[_0x284eef(0x1c0)]+':\x20'+_0x3aa8c7);throw new Error(_0x284eef(0x1e1)+_0x55ed26['status']+_0x284eef(0x1d2)+_0x3aa8c7);}let _0x2e83b0;try{_0x2e83b0=JSON['parse'](_0x3aa8c7);}catch(_0x124f92){console[_0x284eef(0x21f)](_0x284eef(0x207),_0x124f92),loggerService_1['loggerService'][_0x284eef(0x1fc)](_0x284eef(0x21c),_0x284eef(0x1e3),_0x284eef(0x1fb)+_0x124f92);throw new Error(_0x284eef(0x209)+_0x3aa8c7);}console[_0x284eef(0x1cc)](_0x284eef(0x1ce)),console['log'](_0x284eef(0x1de),JSON[_0x284eef(0x1ec)](_0x2e83b0,null,0x2)),loggerService_1[_0x284eef(0x1c5)][_0x284eef(0x1e6)](_0x284eef(0x21c),'/invoices/new',_0x55ed26[_0x284eef(0x1c0)],_0x2e83b0,_0x57de7a);if(_0x2e83b0[_0x284eef(0x1c0)]!==_0x284eef(0x1cb)){const _0x50c09a=_0x2e83b0[_0x284eef(0x1d8)]||_0x2e83b0[_0x284eef(0x21f)]||_0x284eef(0x215);console[_0x284eef(0x21f)](_0x284eef(0x1cd)),console[_0x284eef(0x21f)](_0x284eef(0x22c),_0x50c09a),loggerService_1[_0x284eef(0x1c5)][_0x284eef(0x1fc)](_0x284eef(0x21c),'/invoices/new',_0x284eef(0x1f2)+_0x50c09a);throw new Error('Plisio\x20API\x20error:\x20'+_0x50c09a);}if(!_0x2e83b0[_0x284eef(0x227)]?.['txn_id']||!_0x2e83b0['data']?.[_0x284eef(0x230)]){console[_0x284eef(0x21f)](_0x284eef(0x226)),console['error'](_0x284eef(0x219)),console['error']('Response\x20data:',_0x2e83b0[_0x284eef(0x227)]),loggerService_1[_0x284eef(0x1c5)]['logWhiteDomainError'](_0x284eef(0x21c),_0x284eef(0x1e3),'Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url');throw new Error(_0x284eef(0x1fd));}return console[_0x284eef(0x1cc)](_0x284eef(0x202)),console[_0x284eef(0x1cc)](_0x284eef(0x1fa),_0x2e83b0['data']['txn_id']),console[_0x284eef(0x1cc)](_0x284eef(0x222),_0x2e83b0[_0x284eef(0x227)][_0x284eef(0x230)]),console['log'](_0x284eef(0x1e9),_0x51a240,_0x411adb),_0x242994&&(console[_0x284eef(0x1cc)](_0x284eef(0x229),_0x242994,_0x284eef(0x223)),console[_0x284eef(0x1cc)](_0x284eef(0x211),_0x411adb,'(fiat\x20for\x20merchant)')),{'gateway_payment_id':_0x2e83b0[_0x284eef(0x227)][_0x284eef(0x1e0)],'payment_url':_0x2e83b0['data']['invoice_url'],'invoice_total_sum':_0x2e83b0[_0x284eef(0x227)][_0x284eef(0x1d7)],'qr_code':_0x2e83b0[_0x284eef(0x227)][_0x284eef(0x1c1)],'qr_url':_0x2e83b0[_0x284eef(0x227)][_0x284eef(0x1d6)]};}catch(_0x18de9e){console[_0x284eef(0x21f)](_0x284eef(0x1da)),console[_0x284eef(0x21f)](_0x284eef(0x217),_0x18de9e),loggerService_1['loggerService'][_0x284eef(0x1fc)](_0x284eef(0x21c),_0x284eef(0x1e3),_0x18de9e);if(_0x18de9e instanceof Error){console[_0x284eef(0x21f)](_0x284eef(0x22e),_0x18de9e[_0x284eef(0x1d8)]),console['error'](_0x284eef(0x201),_0x18de9e[_0x284eef(0x1c4)]);throw new Error(_0x284eef(0x20f)+_0x18de9e[_0x284eef(0x1d8)]);}throw new Error(_0x284eef(0x213));}}async[a70_0x21ea3c(0x1df)](_0xa84ff2){const _0x4bed53=a70_0x21ea3c,_0x14cd39=Date[_0x4bed53(0x1f5)]();try{if(!this['apiKey'])throw new Error(_0x4bed53(0x21a));const _0x5e8341=new URLSearchParams({'api_key':this['apiKey'],'txn_id':_0xa84ff2}),_0x21573b=_0x4bed53(0x1ed)+_0xa84ff2+'?'+_0x5e8341[_0x4bed53(0x1f3)]();loggerService_1[_0x4bed53(0x1c5)]['logWhiteDomainRequest'](_0x4bed53(0x21c),_0x4bed53(0x1eb)+_0xa84ff2,_0x4bed53(0x1c2),Object[_0x4bed53(0x1d1)](_0x5e8341['entries']()));const _0x36c1a3=await fetch(_0x21573b,{'method':_0x4bed53(0x1c2),'headers':{'Accept':_0x4bed53(0x1f7),'User-Agent':_0x4bed53(0x22d)}}),_0x10ee61=Date['now']()-_0x14cd39;if(!_0x36c1a3['ok']){const _0xb5a71b=await _0x36c1a3[_0x4bed53(0x20d)]();loggerService_1[_0x4bed53(0x1c5)][_0x4bed53(0x1e6)](_0x4bed53(0x21c),'/operations/'+_0xa84ff2,_0x36c1a3[_0x4bed53(0x1c0)],_0xb5a71b,_0x10ee61);throw new Error(_0x4bed53(0x1e1)+_0x36c1a3[_0x4bed53(0x1c0)]);}const _0x2209a1=await _0x36c1a3['json']();loggerService_1['loggerService']['logWhiteDomainResponse'](_0x4bed53(0x21c),'/operations/'+_0xa84ff2,_0x36c1a3['status'],_0x2209a1,_0x10ee61);if(_0x2209a1[_0x4bed53(0x1c0)]!=='success'){loggerService_1[_0x4bed53(0x1c5)][_0x4bed53(0x1fc)](_0x4bed53(0x21c),_0x4bed53(0x1eb)+_0xa84ff2,_0x4bed53(0x1ea)+(_0x2209a1[_0x4bed53(0x1d8)]||_0x2209a1['error']||'Unknown\x20error'));throw new Error('Plisio\x20API\x20error:\x20'+(_0x2209a1[_0x4bed53(0x1d8)]||_0x2209a1['error']||_0x4bed53(0x1cf)));}let _0x37f424=_0x4bed53(0x1e4);return{'status':_0x37f424};}catch(_0xe3aeba){console[_0x4bed53(0x21f)](_0x4bed53(0x232),_0xe3aeba),loggerService_1[_0x4bed53(0x1c5)][_0x4bed53(0x1fc)]('plisio_direct',_0x4bed53(0x1eb)+_0xa84ff2,_0xe3aeba);throw new Error('Failed\x20to\x20verify\x20Plisio\x20payment:\x20'+(_0xe3aeba instanceof Error?_0xe3aeba[_0x4bed53(0x1d8)]:_0x4bed53(0x1cf)));}}async['processWebhook'](_0x2f024a){const _0xce3303=a70_0x21ea3c;console['log'](_0xce3303(0x21d),_0x2f024a);let _0x57ff83='PENDING';switch(_0x2f024a[_0xce3303(0x1c0)]?.[_0xce3303(0x20e)]()){case _0xce3303(0x1bf):case'mismatch':_0x57ff83=_0xce3303(0x1d3);break;case _0xce3303(0x212):_0x57ff83='EXPIRED';break;case _0xce3303(0x21f):case'cancelled':_0x57ff83=_0xce3303(0x1d9);break;case'new':_0x57ff83='PENDING';break;case _0xce3303(0x1f9):_0x57ff83=_0xce3303(0x1be);break;default:_0x57ff83=_0xce3303(0x1e4);break;}let _0x2e1fab;if(_0x2f024a[_0xce3303(0x1c9)])try{console[_0xce3303(0x1cc)](_0xce3303(0x205),_0x2f024a[_0xce3303(0x1c9)]);let _0x1a437c;if(typeof _0x2f024a[_0xce3303(0x1c9)]===_0xce3303(0x235))_0x1a437c=JSON['parse'](_0x2f024a[_0xce3303(0x1c9)]);else Array[_0xce3303(0x1ee)](_0x2f024a[_0xce3303(0x1c9)])?_0x1a437c=_0x2f024a['tx_urls']:_0x1a437c=[];_0x2e1fab=_0x1a437c[_0xce3303(0x233)](_0x5a3458=>{const _0x66edc5=_0xce3303,_0x112ac4=_0x5a3458[_0x66edc5(0x1f8)](/\\/g,'');return console[_0x66edc5(0x1cc)](_0x66edc5(0x220)+_0x5a3458+_0x66edc5(0x208)+_0x112ac4),_0x112ac4;}),console[_0xce3303(0x1cc)](_0xce3303(0x1c3),_0x2e1fab),_0x2e1fab[_0xce3303(0x234)]((_0x54d342,_0x148364)=>{const _0x4d70e=_0xce3303;try{new URL(_0x54d342),console[_0x4d70e(0x1cc)](_0x4d70e(0x1fe)+(_0x148364+0x1)+_0x4d70e(0x1f6)+_0x54d342);}catch(_0x436c91){console['error'](_0x4d70e(0x21b)+(_0x148364+0x1)+_0x4d70e(0x1d0)+_0x54d342,_0x436c91);}});}catch(_0xcc9a75){console[_0xce3303(0x21f)](_0xce3303(0x1c7),_0xcc9a75),console[_0xce3303(0x21f)]('Raw\x20tx_urls\x20data:',_0x2f024a['tx_urls']),_0x2e1fab=undefined;}return{'paymentId':_0x2f024a[_0xce3303(0x1c8)]||'','status':_0x57ff83,'amount':_0x2f024a[_0xce3303(0x236)],'currency':_0x2f024a['currency'],'txUrls':_0x2e1fab};}}exports[a70_0x21ea3c(0x1db)]=PlisioService;