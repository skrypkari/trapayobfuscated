'use strict';const a44_0x139148=a44_0x3f7d;function a44_0x3a45(){const _0x2b87ac=['__esModule','completed','apiUrl','stack','Full\x20URL\x20(without\x20API\x20key):','invoice_url','Business\x20Error:\x20','qr_url','logWhiteDomainRequest','Parameters:','logWhiteDomainResponse','defineProperty','log','TesSoft\x20Payment\x20System/1.0','append','now','plisio_direct','Target\x20Currency:','Response\x20Time:','Failed\x20to\x20create\x20Plisio\x20payment:\x20','parse','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','630PmSmme','entries','txn_id','tx_urls','Response\x20data:','email','Plisio\x20API\x20error:\x20','89221YExkTq','Amount:','message','text','source_currency','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','✅\x20Processed\x20tx_urls:','Error\x20message:','Error\x20details:','logWhiteDomainError','✅\x20URL\x20','Raw\x20tx_urls\x20data:','/invoices/new','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','445907iTYIxe','forEach','7bEWqqX','37530TPrclG','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','GET','success','currency','2574372lOfkeC','Processing\x20Plisio\x20webhook:','276UTtizo','💰\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','❌\x20Failed\x20to\x20parse\x20tx_urls:','Plisio\x20payment\x20verification\x20error:','isArray','toString','name','PlisioService','map','255960ajxtIs','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','HTTP\x20error!\x20status:\x20','2vgteVH','../loggerService','application/json','new','❌\x20URL\x20',',\x20body:\x20','⚠️\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','error','\x20->\x20','Error\x20Message:','createPayment','invoice_total_sum','PLISIO_API_KEY','pending','env','apiKey','Unknown\x20error\x20from\x20Plisio\x20API','Unknown\x20error','HIDDEN','Failed\x20to\x20parse\x20JSON\x20response:','Response\x20Body:','amount','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','/operations/','5034vOdWGz','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','6628112qhwUpG','Status:','https://api.trapay.uk/api/webhooks/gateway/plisio','2180JBoLiw','data','🔗\x20Raw\x20tx_urls\x20from\x20Plisio:','mismatch','expired','🔗\x20Formatted\x20URL:\x20','Status\x20Text:','fromEntries','replace','processWebhook','PENDING','loggerService','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','statusText','Parsed\x20Result:','string','(crypto\x20for\x20payment)','source_amount','https://api.plisio.net/api/v1/operations/','JSON\x20Parse\x20Error:\x20','status'];a44_0x3a45=function(){return _0x2b87ac;};return a44_0x3a45();}function a44_0x3f7d(_0x3c2692,_0x23f8d1){const _0x3a45b8=a44_0x3a45();return a44_0x3f7d=function(_0x3f7d4a,_0x1ef9bb){_0x3f7d4a=_0x3f7d4a-0x1ec;let _0xd4517e=_0x3a45b8[_0x3f7d4a];return _0xd4517e;},a44_0x3f7d(_0x3c2692,_0x23f8d1);}(function(_0x273a1b,_0x5b3f5e){const _0x874437=a44_0x3f7d,_0x52ffb1=_0x273a1b();while(!![]){try{const _0x1135d9=-parseInt(_0x874437(0x241))/0x1*(-parseInt(_0x874437(0x257))/0x2)+parseInt(_0x874437(0x249))/0x3+-parseInt(_0x874437(0x254))/0x4+-parseInt(_0x874437(0x201))/0x5*(parseInt(_0x874437(0x1fc))/0x6)+parseInt(_0x874437(0x243))/0x7*(-parseInt(_0x874437(0x1fe))/0x8)+parseInt(_0x874437(0x244))/0x9*(parseInt(_0x874437(0x22c))/0xa)+-parseInt(_0x874437(0x233))/0xb*(-parseInt(_0x874437(0x24b))/0xc);if(_0x1135d9===_0x5b3f5e)break;else _0x52ffb1['push'](_0x52ffb1['shift']());}catch(_0x23da17){_0x52ffb1['push'](_0x52ffb1['shift']());}}}(a44_0x3a45,0x78d8a));Object[a44_0x139148(0x221)](exports,a44_0x139148(0x216),{'value':!![]}),exports[a44_0x139148(0x252)]=void 0x0;const loggerService_1=require(a44_0x139148(0x258));class PlisioService{constructor(){const _0x110806=a44_0x139148;this[_0x110806(0x218)]='https://api.plisio.net/api/v1/invoices/new',this['apiKey']=process[_0x110806(0x1f1)][_0x110806(0x1ef)]||'',!this[_0x110806(0x1f2)]?console['warn'](_0x110806(0x25d)):console[_0x110806(0x222)](_0x110806(0x24c));}async[a44_0x139148(0x1ed)](_0x208dc6){const _0x20f9ce=a44_0x139148,{orderId:_0x144616,amount:_0x3234e7,currency:_0x399d82,productName:_0x26474e,description:_0x30fddd,successUrl:_0x4738f9,failUrl:_0x42f2e0,customerEmail:_0x536eea,customerName:_0x545ed8,isSourceCurrency:_0x9c1286,sourceCurrency:_0x7d16f8}=_0x208dc6;if(!this[_0x20f9ce(0x1f2)])throw new Error('Plisio\x20API\x20key\x20is\x20not\x20configured');const _0x78f736=new URLSearchParams({'api_key':this[_0x20f9ce(0x1f2)],'order_number':_0x144616,'order_name':_0x26474e,'description':_0x30fddd,'success_url':_0x4738f9,'fail_url':_0x42f2e0,'callback_url':_0x20f9ce(0x200)});_0x7d16f8?(_0x78f736[_0x20f9ce(0x224)](_0x20f9ce(0x248),_0x7d16f8),_0x78f736[_0x20f9ce(0x224)](_0x20f9ce(0x237),_0x399d82),_0x78f736[_0x20f9ce(0x224)](_0x20f9ce(0x212),_0x3234e7[_0x20f9ce(0x250)]())):(_0x78f736['append'](_0x20f9ce(0x248),_0x399d82),_0x78f736['append'](_0x20f9ce(0x1f8),_0x3234e7['toString']()));_0x536eea&&_0x78f736[_0x20f9ce(0x224)](_0x20f9ce(0x231),_0x536eea);_0x545ed8&&_0x78f736['append'](_0x20f9ce(0x251),_0x545ed8);const _0x1b7379=this['apiUrl']+'?'+_0x78f736['toString'](),_0x434b91=Date[_0x20f9ce(0x225)]();try{console[_0x20f9ce(0x222)](_0x20f9ce(0x22b)),console['log']('URL:',this[_0x20f9ce(0x218)]),console[_0x20f9ce(0x222)](_0x20f9ce(0x21f),Object[_0x20f9ce(0x208)](_0x78f736[_0x20f9ce(0x22d)]())),console['log'](_0x20f9ce(0x21a),_0x1b7379[_0x20f9ce(0x209)](this[_0x20f9ce(0x1f2)],_0x20f9ce(0x1f5))),loggerService_1['loggerService'][_0x20f9ce(0x21e)]('plisio_direct',_0x20f9ce(0x23f),'GET',Object[_0x20f9ce(0x208)](_0x78f736['entries']()));const _0x42d081=await fetch(_0x1b7379,{'method':_0x20f9ce(0x246),'headers':{'Accept':'application/json','User-Agent':_0x20f9ce(0x223)}}),_0x4a1d97=Date['now']()-_0x434b91;console[_0x20f9ce(0x222)](_0x20f9ce(0x1f9)),console[_0x20f9ce(0x222)](_0x20f9ce(0x1ff),_0x42d081[_0x20f9ce(0x215)]),console[_0x20f9ce(0x222)](_0x20f9ce(0x207),_0x42d081[_0x20f9ce(0x20e)]),console[_0x20f9ce(0x222)](_0x20f9ce(0x228),_0x4a1d97+'ms');const _0x1be19c=await _0x42d081[_0x20f9ce(0x236)]();console[_0x20f9ce(0x222)]('Raw\x20Response\x20Body:',_0x1be19c);if(!_0x42d081['ok']){console[_0x20f9ce(0x25e)]('===\x20PLISIO\x20API\x20ERROR\x20==='),console[_0x20f9ce(0x25e)]('HTTP\x20Status:',_0x42d081[_0x20f9ce(0x215)]),console['error'](_0x20f9ce(0x1f7),_0x1be19c),loggerService_1['loggerService'][_0x20f9ce(0x220)](_0x20f9ce(0x226),'/invoices/new',_0x42d081[_0x20f9ce(0x215)],_0x1be19c,_0x4a1d97),loggerService_1[_0x20f9ce(0x20c)]['logWhiteDomainError'](_0x20f9ce(0x226),'/invoices/new','HTTP\x20'+_0x42d081[_0x20f9ce(0x215)]+':\x20'+_0x1be19c);throw new Error(_0x20f9ce(0x256)+_0x42d081[_0x20f9ce(0x215)]+_0x20f9ce(0x25c)+_0x1be19c);}let _0x15ed17;try{_0x15ed17=JSON[_0x20f9ce(0x22a)](_0x1be19c);}catch(_0x1d3cd9){console[_0x20f9ce(0x25e)](_0x20f9ce(0x1f6),_0x1d3cd9),loggerService_1[_0x20f9ce(0x20c)]['logWhiteDomainError']('plisio_direct','/invoices/new',_0x20f9ce(0x214)+_0x1d3cd9);throw new Error(_0x20f9ce(0x1fa)+_0x1be19c);}console['log'](_0x20f9ce(0x245)),console[_0x20f9ce(0x222)](_0x20f9ce(0x20f),JSON['stringify'](_0x15ed17,null,0x2)),loggerService_1['loggerService'][_0x20f9ce(0x220)]('plisio_direct',_0x20f9ce(0x23f),_0x42d081[_0x20f9ce(0x215)],_0x15ed17,_0x4a1d97);if(_0x15ed17[_0x20f9ce(0x215)]!==_0x20f9ce(0x247)){const _0x8decd5=_0x15ed17[_0x20f9ce(0x235)]||_0x15ed17[_0x20f9ce(0x25e)]||_0x20f9ce(0x1f3);console[_0x20f9ce(0x25e)](_0x20f9ce(0x255)),console[_0x20f9ce(0x25e)](_0x20f9ce(0x1ec),_0x8decd5),loggerService_1[_0x20f9ce(0x20c)]['logWhiteDomainError'](_0x20f9ce(0x226),_0x20f9ce(0x23f),_0x20f9ce(0x21c)+_0x8decd5);throw new Error('Plisio\x20API\x20error:\x20'+_0x8decd5);}if(!_0x15ed17[_0x20f9ce(0x202)]?.[_0x20f9ce(0x22e)]||!_0x15ed17[_0x20f9ce(0x202)]?.['invoice_url']){console['error']('===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x20f9ce(0x25e)]('Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response'),console[_0x20f9ce(0x25e)](_0x20f9ce(0x230),_0x15ed17[_0x20f9ce(0x202)]),loggerService_1[_0x20f9ce(0x20c)][_0x20f9ce(0x23c)](_0x20f9ce(0x226),_0x20f9ce(0x23f),_0x20f9ce(0x240));throw new Error(_0x20f9ce(0x20d));}return console['log']('===\x20PLISIO\x20SUCCESS\x20==='),console[_0x20f9ce(0x222)]('Transaction\x20ID:',_0x15ed17['data'][_0x20f9ce(0x22e)]),console[_0x20f9ce(0x222)]('Invoice\x20URL:',_0x15ed17[_0x20f9ce(0x202)][_0x20f9ce(0x21b)]),console[_0x20f9ce(0x222)](_0x20f9ce(0x234),_0x3234e7,_0x399d82),_0x7d16f8&&(console[_0x20f9ce(0x222)]('Source\x20Currency:',_0x7d16f8,_0x20f9ce(0x211)),console[_0x20f9ce(0x222)](_0x20f9ce(0x227),_0x399d82,'(fiat\x20for\x20merchant)')),{'gateway_payment_id':_0x15ed17['data'][_0x20f9ce(0x22e)],'payment_url':_0x15ed17[_0x20f9ce(0x202)][_0x20f9ce(0x21b)],'invoice_total_sum':_0x15ed17[_0x20f9ce(0x202)][_0x20f9ce(0x1ee)],'qr_code':_0x15ed17[_0x20f9ce(0x202)]['qr_code'],'qr_url':_0x15ed17[_0x20f9ce(0x202)][_0x20f9ce(0x21d)]};}catch(_0x2eb7a7){console[_0x20f9ce(0x25e)]('===\x20PLISIO\x20SERVICE\x20ERROR\x20==='),console[_0x20f9ce(0x25e)](_0x20f9ce(0x23b),_0x2eb7a7),loggerService_1[_0x20f9ce(0x20c)][_0x20f9ce(0x23c)](_0x20f9ce(0x226),_0x20f9ce(0x23f),_0x2eb7a7);if(_0x2eb7a7 instanceof Error){console[_0x20f9ce(0x25e)](_0x20f9ce(0x23a),_0x2eb7a7[_0x20f9ce(0x235)]),console[_0x20f9ce(0x25e)]('Error\x20stack:',_0x2eb7a7[_0x20f9ce(0x219)]);throw new Error(_0x20f9ce(0x229)+_0x2eb7a7[_0x20f9ce(0x235)]);}throw new Error(_0x20f9ce(0x238));}}async['verifyPayment'](_0xcac310){const _0x2848bc=a44_0x139148,_0xacb3ad=Date['now']();try{if(!this['apiKey'])throw new Error('Plisio\x20API\x20key\x20is\x20not\x20configured');const _0x5d29c7=new URLSearchParams({'api_key':this[_0x2848bc(0x1f2)],'txn_id':_0xcac310}),_0x46e778=_0x2848bc(0x213)+_0xcac310+'?'+_0x5d29c7[_0x2848bc(0x250)]();loggerService_1['loggerService'][_0x2848bc(0x21e)](_0x2848bc(0x226),_0x2848bc(0x1fb)+_0xcac310,_0x2848bc(0x246),Object[_0x2848bc(0x208)](_0x5d29c7[_0x2848bc(0x22d)]()));const _0x1677a8=await fetch(_0x46e778,{'method':_0x2848bc(0x246),'headers':{'Accept':_0x2848bc(0x259),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x5dc41d=Date[_0x2848bc(0x225)]()-_0xacb3ad;if(!_0x1677a8['ok']){const _0x132228=await _0x1677a8[_0x2848bc(0x236)]();loggerService_1[_0x2848bc(0x20c)][_0x2848bc(0x220)](_0x2848bc(0x226),_0x2848bc(0x1fb)+_0xcac310,_0x1677a8['status'],_0x132228,_0x5dc41d);throw new Error(_0x2848bc(0x256)+_0x1677a8[_0x2848bc(0x215)]);}const _0x6e2cd0=await _0x1677a8['json']();loggerService_1[_0x2848bc(0x20c)][_0x2848bc(0x220)](_0x2848bc(0x226),_0x2848bc(0x1fb)+_0xcac310,_0x1677a8[_0x2848bc(0x215)],_0x6e2cd0,_0x5dc41d);if(_0x6e2cd0['status']!=='success'){loggerService_1[_0x2848bc(0x20c)]['logWhiteDomainError'](_0x2848bc(0x226),'/operations/'+_0xcac310,_0x2848bc(0x232)+(_0x6e2cd0[_0x2848bc(0x235)]||_0x6e2cd0[_0x2848bc(0x25e)]||'Unknown\x20error'));throw new Error(_0x2848bc(0x232)+(_0x6e2cd0[_0x2848bc(0x235)]||_0x6e2cd0[_0x2848bc(0x25e)]||'Unknown\x20error'));}let _0x541535='PENDING';return{'status':_0x541535};}catch(_0x388334){console['error'](_0x2848bc(0x24e),_0x388334),loggerService_1[_0x2848bc(0x20c)][_0x2848bc(0x23c)](_0x2848bc(0x226),_0x2848bc(0x1fb)+_0xcac310,_0x388334);throw new Error(_0x2848bc(0x1fd)+(_0x388334 instanceof Error?_0x388334[_0x2848bc(0x235)]:_0x2848bc(0x1f4)));}}async[a44_0x139148(0x20a)](_0xa785c5){const _0x5955de=a44_0x139148;console['log'](_0x5955de(0x24a),_0xa785c5);let _0x51b5fc=_0x5955de(0x20b);switch(_0xa785c5[_0x5955de(0x215)]?.['toLowerCase']()){case _0x5955de(0x217):case _0x5955de(0x204):_0x51b5fc='PAID';break;case _0x5955de(0x205):_0x51b5fc='EXPIRED';break;case _0x5955de(0x25e):case'cancelled':_0x51b5fc='FAILED';break;case _0x5955de(0x25a):case _0x5955de(0x1f0):default:_0x51b5fc=_0x5955de(0x20b);break;}let _0x4f24d9;if(_0xa785c5['tx_urls'])try{console[_0x5955de(0x222)](_0x5955de(0x203),_0xa785c5['tx_urls']);let _0x535028;if(typeof _0xa785c5[_0x5955de(0x22f)]===_0x5955de(0x210))_0x535028=JSON[_0x5955de(0x22a)](_0xa785c5[_0x5955de(0x22f)]);else Array[_0x5955de(0x24f)](_0xa785c5['tx_urls'])?_0x535028=_0xa785c5[_0x5955de(0x22f)]:_0x535028=[];_0x4f24d9=_0x535028[_0x5955de(0x253)](_0x4d628c=>{const _0x3e9597=_0x5955de,_0x36c896=_0x4d628c['replace'](/\\/g,'');return console[_0x3e9597(0x222)](_0x3e9597(0x206)+_0x4d628c+_0x3e9597(0x25f)+_0x36c896),_0x36c896;}),console[_0x5955de(0x222)](_0x5955de(0x239),_0x4f24d9),_0x4f24d9[_0x5955de(0x242)]((_0x211fd0,_0x2a5e6b)=>{const _0x3de9a=_0x5955de;try{new URL(_0x211fd0),console['log'](_0x3de9a(0x23d)+(_0x2a5e6b+0x1)+'\x20is\x20valid:\x20'+_0x211fd0);}catch(_0x349c11){console[_0x3de9a(0x25e)](_0x3de9a(0x25b)+(_0x2a5e6b+0x1)+'\x20is\x20invalid:\x20'+_0x211fd0,_0x349c11);}});}catch(_0x6427e3){console[_0x5955de(0x25e)](_0x5955de(0x24d),_0x6427e3),console[_0x5955de(0x25e)](_0x5955de(0x23e),_0xa785c5[_0x5955de(0x22f)]),_0x4f24d9=undefined;}return{'paymentId':_0xa785c5['order_number']||'','status':_0x51b5fc,'amount':_0xa785c5[_0x5955de(0x1f8)],'currency':_0xa785c5['currency'],'txUrls':_0x4f24d9};}}exports[a44_0x139148(0x252)]=PlisioService;