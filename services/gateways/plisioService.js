'use strict';const a47_0x31276b=a47_0x5889;(function(_0x2f14e1,_0x391979){const _0x492bcb=a47_0x5889,_0x12f344=_0x2f14e1();while(!![]){try{const _0x1336c1=-parseInt(_0x492bcb(0xef))/0x1+-parseInt(_0x492bcb(0x109))/0x2+-parseInt(_0x492bcb(0x105))/0x3+-parseInt(_0x492bcb(0x113))/0x4+-parseInt(_0x492bcb(0x13d))/0x5+-parseInt(_0x492bcb(0xfc))/0x6*(parseInt(_0x492bcb(0x121))/0x7)+-parseInt(_0x492bcb(0x10b))/0x8*(-parseInt(_0x492bcb(0x14c))/0x9);if(_0x1336c1===_0x391979)break;else _0x12f344['push'](_0x12f344['shift']());}catch(_0x400e73){_0x12f344['push'](_0x12f344['shift']());}}}(a47_0x3e17,0xf039c));Object['defineProperty'](exports,a47_0x31276b(0x145),{'value':!![]}),exports['PlisioService']=void 0x0;const loggerService_1=require(a47_0x31276b(0x100));function a47_0x3e17(){const _0x3d584f=['Source\x20Currency:','6514275wiMdNf','logWhiteDomainResponse','isArray','PROCESSING','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','Processing\x20Plisio\x20webhook:','\x20->\x20','Error\x20Message:','__esModule','new','txn_id','\x20is\x20valid:\x20','invoice_total_sum','Failed\x20to\x20parse\x20JSON\x20response:','Plisio\x20API\x20error:\x20','45OdxxsN','Amount:','Raw\x20tx_urls\x20data:','toLowerCase','Business\x20Error:\x20','now','‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','name','üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','env','GET','application/json','URL:','(crypto\x20for\x20payment)','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','Unknown\x20error','882797nEDrJj','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','Error\x20stack:','expired','https://api.plisio.net/api/v1/invoices/new','Failed\x20to\x20create\x20Plisio\x20payment:\x20','‚ùå\x20Failed\x20to\x20parse\x20tx_urls:','success','toString','Transaction\x20ID:','data','===\x20PLISIO\x20API\x20ERROR\x20===','error','906Qlevez','fromEntries','email','HTTP\x20error!\x20status:\x20','../loggerService','Invoice\x20URL:','qr_code','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','logWhiteDomainRequest','2253183gWeOHW','Response\x20Body:','/operations/','message','840596LDgoZC','PlisioService','9864280IXobXE','mismatch','Response\x20data:','Unknown\x20error\x20from\x20Plisio\x20API','pending','string','stringify','apiKey','5706468cnVXhw','currency','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','log','status','‚úÖ\x20Processed\x20tx_urls:','Response\x20Time:','loggerService','map','https://api.plisio.net/api/v1/operations/','Raw\x20Response\x20Body:','PENDING','qr_url','append','18431jFUoOD','text','Status:','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','/invoices/new','invoice_url','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','Plisio\x20API\x20key\x20is\x20not\x20configured','üîó\x20Formatted\x20URL:\x20','TesSoft\x20Payment\x20System/1.0','FAILED','PLISIO_API_KEY','Plisio\x20payment\x20verification\x20error:','tx_urls','apiUrl','replace','Parsed\x20Result:','Error\x20message:','source_currency','order_number','parse','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','plisio_direct','json','logWhiteDomainError','amount','entries'];a47_0x3e17=function(){return _0x3d584f;};return a47_0x3e17();}class PlisioService{constructor(){const _0x140f09=a47_0x31276b;this['apiUrl']=_0x140f09(0xf3),this['apiKey']=process[_0x140f09(0x156)][_0x140f09(0x12c)]||'',!this[_0x140f09(0x112)]?console['warn'](_0x140f09(0x152)):console[_0x140f09(0x116)](_0x140f09(0x154));}async['createPayment'](_0x3dcb10){const _0x1fbdbb=a47_0x31276b,{orderId:_0x4df198,amount:_0x4da664,currency:_0xab5d56,productName:_0x19a9f1,description:_0x10dc3e,successUrl:_0x31b0b1,failUrl:_0x6964f5,customerEmail:_0x27a546,customerName:_0x5899c2,isSourceCurrency:_0x1de9f3,sourceCurrency:_0x46576f}=_0x3dcb10;if(!this[_0x1fbdbb(0x112)])throw new Error(_0x1fbdbb(0x128));const _0x57da16=new URLSearchParams({'api_key':this['apiKey'],'order_number':_0x4df198,'order_name':_0x19a9f1,'description':_0x10dc3e,'success_url':_0x31b0b1,'fail_url':_0x6964f5,'callback_url':'https://api.trapay.uk/api/webhooks/gateway/plisio'});_0x46576f?(_0x57da16['append'](_0x1fbdbb(0x114),_0x46576f),_0x57da16['append'](_0x1fbdbb(0x133),_0xab5d56),_0x57da16['append']('source_amount',_0x4da664[_0x1fbdbb(0xf7)]())):(_0x57da16[_0x1fbdbb(0x120)](_0x1fbdbb(0x114),_0xab5d56),_0x57da16['append'](_0x1fbdbb(0x13a),_0x4da664['toString']()));_0x27a546&&_0x57da16[_0x1fbdbb(0x120)](_0x1fbdbb(0xfe),_0x27a546);_0x5899c2&&_0x57da16[_0x1fbdbb(0x120)](_0x1fbdbb(0x153),_0x5899c2);const _0x47f900=this[_0x1fbdbb(0x12f)]+'?'+_0x57da16[_0x1fbdbb(0xf7)](),_0x168a6e=Date['now']();try{console[_0x1fbdbb(0x116)]('===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20==='),console[_0x1fbdbb(0x116)](_0x1fbdbb(0x159),this[_0x1fbdbb(0x12f)]),console[_0x1fbdbb(0x116)]('Parameters:',Object['fromEntries'](_0x57da16[_0x1fbdbb(0x13b)]())),console['log']('Full\x20URL\x20(without\x20API\x20key):',_0x47f900[_0x1fbdbb(0x130)](this[_0x1fbdbb(0x112)],'HIDDEN')),loggerService_1['loggerService'][_0x1fbdbb(0x104)](_0x1fbdbb(0x137),_0x1fbdbb(0x125),'GET',Object[_0x1fbdbb(0xfd)](_0x57da16[_0x1fbdbb(0x13b)]()));const _0x28d869=await fetch(_0x47f900,{'method':_0x1fbdbb(0x157),'headers':{'Accept':_0x1fbdbb(0x158),'User-Agent':_0x1fbdbb(0x12a)}}),_0x2aa894=Date[_0x1fbdbb(0x151)]()-_0x168a6e;console[_0x1fbdbb(0x116)](_0x1fbdbb(0x136)),console[_0x1fbdbb(0x116)](_0x1fbdbb(0x123),_0x28d869[_0x1fbdbb(0x117)]),console[_0x1fbdbb(0x116)]('Status\x20Text:',_0x28d869['statusText']),console[_0x1fbdbb(0x116)](_0x1fbdbb(0x119),_0x2aa894+'ms');const _0x4c6d13=await _0x28d869[_0x1fbdbb(0x122)]();console[_0x1fbdbb(0x116)](_0x1fbdbb(0x11d),_0x4c6d13);if(!_0x28d869['ok']){console['error'](_0x1fbdbb(0xfa)),console[_0x1fbdbb(0xfb)]('HTTP\x20Status:',_0x28d869[_0x1fbdbb(0x117)]),console[_0x1fbdbb(0xfb)](_0x1fbdbb(0x106),_0x4c6d13),loggerService_1[_0x1fbdbb(0x11a)]['logWhiteDomainResponse'](_0x1fbdbb(0x137),_0x1fbdbb(0x125),_0x28d869[_0x1fbdbb(0x117)],_0x4c6d13,_0x2aa894),loggerService_1[_0x1fbdbb(0x11a)][_0x1fbdbb(0x139)](_0x1fbdbb(0x137),_0x1fbdbb(0x125),'HTTP\x20'+_0x28d869['status']+':\x20'+_0x4c6d13);throw new Error(_0x1fbdbb(0xff)+_0x28d869[_0x1fbdbb(0x117)]+',\x20body:\x20'+_0x4c6d13);}let _0x140733;try{_0x140733=JSON['parse'](_0x4c6d13);}catch(_0x3d3a45){console['error'](_0x1fbdbb(0x14a),_0x3d3a45),loggerService_1['loggerService'][_0x1fbdbb(0x139)](_0x1fbdbb(0x137),_0x1fbdbb(0x125),'JSON\x20Parse\x20Error:\x20'+_0x3d3a45);throw new Error(_0x1fbdbb(0x115)+_0x4c6d13);}console[_0x1fbdbb(0x116)](_0x1fbdbb(0x141)),console[_0x1fbdbb(0x116)](_0x1fbdbb(0x131),JSON[_0x1fbdbb(0x111)](_0x140733,null,0x2)),loggerService_1[_0x1fbdbb(0x11a)][_0x1fbdbb(0x13e)](_0x1fbdbb(0x137),_0x1fbdbb(0x125),_0x28d869[_0x1fbdbb(0x117)],_0x140733,_0x2aa894);if(_0x140733[_0x1fbdbb(0x117)]!==_0x1fbdbb(0xf6)){const _0x2d3832=_0x140733['message']||_0x140733['error']||_0x1fbdbb(0x10e);console['error'](_0x1fbdbb(0x127)),console[_0x1fbdbb(0xfb)](_0x1fbdbb(0x144),_0x2d3832),loggerService_1[_0x1fbdbb(0x11a)][_0x1fbdbb(0x139)]('plisio_direct','/invoices/new',_0x1fbdbb(0x150)+_0x2d3832);throw new Error(_0x1fbdbb(0x14b)+_0x2d3832);}if(!_0x140733['data']?.[_0x1fbdbb(0x147)]||!_0x140733['data']?.[_0x1fbdbb(0x126)]){console[_0x1fbdbb(0xfb)]('===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x1fbdbb(0xfb)](_0x1fbdbb(0x124)),console['error'](_0x1fbdbb(0x10d),_0x140733[_0x1fbdbb(0xf9)]),loggerService_1['loggerService']['logWhiteDomainError'](_0x1fbdbb(0x137),_0x1fbdbb(0x125),_0x1fbdbb(0xf0));throw new Error(_0x1fbdbb(0xed));}return console['log']('===\x20PLISIO\x20SUCCESS\x20==='),console[_0x1fbdbb(0x116)](_0x1fbdbb(0xf8),_0x140733[_0x1fbdbb(0xf9)]['txn_id']),console[_0x1fbdbb(0x116)](_0x1fbdbb(0x101),_0x140733['data'][_0x1fbdbb(0x126)]),console[_0x1fbdbb(0x116)](_0x1fbdbb(0x14d),_0x4da664,_0xab5d56),_0x46576f&&(console[_0x1fbdbb(0x116)](_0x1fbdbb(0x13c),_0x46576f,_0x1fbdbb(0xec)),console['log']('Target\x20Currency:',_0xab5d56,'(fiat\x20for\x20merchant)')),{'gateway_payment_id':_0x140733[_0x1fbdbb(0xf9)]['txn_id'],'payment_url':_0x140733[_0x1fbdbb(0xf9)][_0x1fbdbb(0x126)],'invoice_total_sum':_0x140733['data'][_0x1fbdbb(0x149)],'qr_code':_0x140733[_0x1fbdbb(0xf9)][_0x1fbdbb(0x102)],'qr_url':_0x140733[_0x1fbdbb(0xf9)][_0x1fbdbb(0x11f)]};}catch(_0x15b477){console[_0x1fbdbb(0xfb)](_0x1fbdbb(0x103)),console[_0x1fbdbb(0xfb)]('Error\x20details:',_0x15b477),loggerService_1[_0x1fbdbb(0x11a)][_0x1fbdbb(0x139)](_0x1fbdbb(0x137),'/invoices/new',_0x15b477);if(_0x15b477 instanceof Error){console[_0x1fbdbb(0xfb)](_0x1fbdbb(0x132),_0x15b477[_0x1fbdbb(0x108)]),console[_0x1fbdbb(0xfb)](_0x1fbdbb(0xf1),_0x15b477['stack']);throw new Error(_0x1fbdbb(0xf4)+_0x15b477[_0x1fbdbb(0x108)]);}throw new Error('Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error');}}async['verifyPayment'](_0x31474e){const _0x460661=a47_0x31276b,_0x528505=Date[_0x460661(0x151)]();try{if(!this[_0x460661(0x112)])throw new Error(_0x460661(0x128));const _0x2e49ec=new URLSearchParams({'api_key':this[_0x460661(0x112)],'txn_id':_0x31474e}),_0x329b3c=_0x460661(0x11c)+_0x31474e+'?'+_0x2e49ec['toString']();loggerService_1['loggerService']['logWhiteDomainRequest'](_0x460661(0x137),_0x460661(0x107)+_0x31474e,_0x460661(0x157),Object[_0x460661(0xfd)](_0x2e49ec[_0x460661(0x13b)]()));const _0x328f45=await fetch(_0x329b3c,{'method':_0x460661(0x157),'headers':{'Accept':_0x460661(0x158),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x38bceb=Date['now']()-_0x528505;if(!_0x328f45['ok']){const _0x8554f6=await _0x328f45[_0x460661(0x122)]();loggerService_1[_0x460661(0x11a)][_0x460661(0x13e)](_0x460661(0x137),'/operations/'+_0x31474e,_0x328f45['status'],_0x8554f6,_0x38bceb);throw new Error(_0x460661(0xff)+_0x328f45['status']);}const _0x4812c4=await _0x328f45[_0x460661(0x138)]();loggerService_1[_0x460661(0x11a)]['logWhiteDomainResponse'](_0x460661(0x137),_0x460661(0x107)+_0x31474e,_0x328f45['status'],_0x4812c4,_0x38bceb);if(_0x4812c4[_0x460661(0x117)]!==_0x460661(0xf6)){loggerService_1[_0x460661(0x11a)][_0x460661(0x139)](_0x460661(0x137),'/operations/'+_0x31474e,'Plisio\x20API\x20error:\x20'+(_0x4812c4[_0x460661(0x108)]||_0x4812c4[_0x460661(0xfb)]||_0x460661(0xee)));throw new Error(_0x460661(0x14b)+(_0x4812c4[_0x460661(0x108)]||_0x4812c4[_0x460661(0xfb)]||'Unknown\x20error'));}let _0x8502ee=_0x460661(0x11e);return{'status':_0x8502ee};}catch(_0x4a6d76){console[_0x460661(0xfb)](_0x460661(0x12d),_0x4a6d76),loggerService_1[_0x460661(0x11a)][_0x460661(0x139)](_0x460661(0x137),_0x460661(0x107)+_0x31474e,_0x4a6d76);throw new Error(_0x460661(0x155)+(_0x4a6d76 instanceof Error?_0x4a6d76[_0x460661(0x108)]:_0x460661(0xee)));}}async['processWebhook'](_0x353bef){const _0x1ab166=a47_0x31276b;console['log'](_0x1ab166(0x142),_0x353bef);let _0x5e02eb=_0x1ab166(0x11e);switch(_0x353bef['status']?.[_0x1ab166(0x14f)]()){case'completed':case _0x1ab166(0x10c):_0x5e02eb='PAID';break;case _0x1ab166(0xf2):_0x5e02eb='EXPIRED';break;case _0x1ab166(0xfb):case'cancelled':_0x5e02eb=_0x1ab166(0x12b);break;case _0x1ab166(0x146):_0x5e02eb=_0x1ab166(0x11e);break;case _0x1ab166(0x10f):_0x5e02eb=_0x1ab166(0x140);break;default:_0x5e02eb=_0x1ab166(0x11e);break;}let _0x21aa87;if(_0x353bef[_0x1ab166(0x12e)])try{console[_0x1ab166(0x116)]('üîó\x20Raw\x20tx_urls\x20from\x20Plisio:',_0x353bef[_0x1ab166(0x12e)]);let _0x2f15f0;if(typeof _0x353bef[_0x1ab166(0x12e)]===_0x1ab166(0x110))_0x2f15f0=JSON[_0x1ab166(0x135)](_0x353bef['tx_urls']);else Array[_0x1ab166(0x13f)](_0x353bef[_0x1ab166(0x12e)])?_0x2f15f0=_0x353bef['tx_urls']:_0x2f15f0=[];_0x21aa87=_0x2f15f0[_0x1ab166(0x11b)](_0x55e756=>{const _0x1fb81a=_0x1ab166,_0x36a582=_0x55e756[_0x1fb81a(0x130)](/\\/g,'');return console[_0x1fb81a(0x116)](_0x1fb81a(0x129)+_0x55e756+_0x1fb81a(0x143)+_0x36a582),_0x36a582;}),console[_0x1ab166(0x116)](_0x1ab166(0x118),_0x21aa87),_0x21aa87['forEach']((_0x256eb3,_0x1ca3b5)=>{const _0x24d319=_0x1ab166;try{new URL(_0x256eb3),console[_0x24d319(0x116)]('‚úÖ\x20URL\x20'+(_0x1ca3b5+0x1)+_0x24d319(0x148)+_0x256eb3);}catch(_0x252035){console[_0x24d319(0xfb)]('‚ùå\x20URL\x20'+(_0x1ca3b5+0x1)+'\x20is\x20invalid:\x20'+_0x256eb3,_0x252035);}});}catch(_0x53d668){console[_0x1ab166(0xfb)](_0x1ab166(0xf5),_0x53d668),console[_0x1ab166(0xfb)](_0x1ab166(0x14e),_0x353bef[_0x1ab166(0x12e)]),_0x21aa87=undefined;}return{'paymentId':_0x353bef[_0x1ab166(0x134)]||'','status':_0x5e02eb,'amount':_0x353bef[_0x1ab166(0x13a)],'currency':_0x353bef[_0x1ab166(0x114)],'txUrls':_0x21aa87};}}function a47_0x5889(_0x4e44a3,_0x5938f1){const _0x3e1727=a47_0x3e17();return a47_0x5889=function(_0x588944,_0x452d52){_0x588944=_0x588944-0xec;let _0x4440d2=_0x3e1727[_0x588944];return _0x4440d2;},a47_0x5889(_0x4e44a3,_0x5938f1);}exports[a47_0x31276b(0x10a)]=PlisioService;