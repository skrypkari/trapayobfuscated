'use strict';const a41_0x591790=a41_0x3951;function a41_0x3951(_0x364009,_0x104975){const _0x3ae634=a41_0x3ae6();return a41_0x3951=function(_0x395128,_0x107176){_0x395128=_0x395128-0xeb;let _0x44a7de=_0x3ae634[_0x395128];return _0x44a7de;},a41_0x3951(_0x364009,_0x104975);}(function(_0x3efca8,_0x471f18){const _0x460c1e=a41_0x3951,_0x1ce6ab=_0x3efca8();while(!![]){try{const _0x4ccc9d=parseInt(_0x460c1e(0xf4))/0x1+parseInt(_0x460c1e(0x10c))/0x2*(parseInt(_0x460c1e(0x14e))/0x3)+parseInt(_0x460c1e(0x14f))/0x4*(parseInt(_0x460c1e(0x143))/0x5)+-parseInt(_0x460c1e(0x12a))/0x6*(-parseInt(_0x460c1e(0x135))/0x7)+parseInt(_0x460c1e(0x101))/0x8+-parseInt(_0x460c1e(0x133))/0x9+-parseInt(_0x460c1e(0x132))/0xa;if(_0x4ccc9d===_0x471f18)break;else _0x1ce6ab['push'](_0x1ce6ab['shift']());}catch(_0x497347){_0x1ce6ab['push'](_0x1ce6ab['shift']());}}}(a41_0x3ae6,0x810e4));function a41_0x3ae6(){const _0x2e4222=['/operations/','data','PLISIO_API_KEY','Error\x20details:','replace','‚ùå\x20Failed\x20to\x20parse\x20tx_urls:','forEach','FAILED','completed','entries','now','https://api.trapay.uk/api/webhooks/gateway/plisio','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','PENDING','Transaction\x20ID:','logWhiteDomainRequest','logWhiteDomainError','new','map','TesSoft\x20Payment\x20System/1.0','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','email','log','toString','\x20is\x20invalid:\x20','GET','607805VMcOSw','Error\x20message:','\x20is\x20valid:\x20','Unknown\x20error','Failed\x20to\x20create\x20Plisio\x20payment:\x20','Plisio\x20API\x20error:\x20','apiUrl','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','error','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','env','txn_id','expired','3428408pLxErC','‚úÖ\x20URL\x20','Response\x20data:','stack','mismatch','warn','currency','invoice_url','Source\x20Currency:','defineProperty',',\x20body:\x20','2RBioaU','application/json','processWebhook','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','HTTP\x20Status:','success','EXPIRED','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','Raw\x20tx_urls\x20data:','Raw\x20Response\x20Body:','\x20->\x20','loggerService','Amount:','qr_url','pending','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','Target\x20Currency:','(fiat\x20for\x20merchant)','Failed\x20to\x20parse\x20JSON\x20response:','append','isArray','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','‚ùå\x20URL\x20','Parsed\x20Result:','createPayment','cancelled','source_currency','(crypto\x20for\x20payment)','apiKey','fromEntries','12bOSBLc','invoice_total_sum','üîó\x20Formatted\x20URL:\x20','https://api.plisio.net/api/v1/invoices/new','PAID','https://api.plisio.net/api/v1/operations/','===\x20PLISIO\x20API\x20ERROR\x20===','HTTP\x20','21293280KnKKfB','922905GvgTxk','HIDDEN','1996239qiyzsj','PlisioService','Plisio\x20API\x20key\x20is\x20not\x20configured','plisio_direct','qr_code','‚úÖ\x20Processed\x20tx_urls:','message','json','/invoices/new','source_amount','status','Error\x20stack:','Plisio\x20payment\x20verification\x20error:','Status:','3223960LPiDHX','Full\x20URL\x20(without\x20API\x20key):','Status\x20Text:','Unknown\x20error\x20from\x20Plisio\x20API','logWhiteDomainResponse','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','URL:','amount','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','__esModule','1526949LMsQbi','4rmHxEz','tx_urls'];a41_0x3ae6=function(){return _0x2e4222;};return a41_0x3ae6();}Object[a41_0x591790(0x10a)](exports,a41_0x591790(0x14d),{'value':!![]}),exports[a41_0x591790(0x136)]=void 0x0;const loggerService_1=require('../loggerService');class PlisioService{constructor(){const _0x266a56=a41_0x591790;this[_0x266a56(0xfa)]=_0x266a56(0x12d),this[_0x266a56(0x128)]=process[_0x266a56(0xfe)][_0x266a56(0x153)]||'',!this[_0x266a56(0x128)]?console[_0x266a56(0x106)]('‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables'):console[_0x266a56(0xf0)](_0x266a56(0x149));}async[a41_0x591790(0x124)](_0x2ac613){const _0x4879e9=a41_0x591790,{orderId:_0x57b94f,amount:_0x40f81d,currency:_0x2c5794,productName:_0x1da121,description:_0x44831c,successUrl:_0x25d0fb,failUrl:_0x24ceef,customerEmail:_0x16d9ad,customerName:_0x2b8ec4,isSourceCurrency:_0x59d6ca,sourceCurrency:_0x3f6b6f}=_0x2ac613;if(!this[_0x4879e9(0x128)])throw new Error(_0x4879e9(0x137));const _0x421667=new URLSearchParams({'api_key':this[_0x4879e9(0x128)],'order_number':_0x57b94f,'order_name':_0x1da121,'description':_0x44831c,'success_url':_0x25d0fb,'fail_url':_0x24ceef,'callback_url':_0x4879e9(0x15c)});_0x3f6b6f?(_0x421667[_0x4879e9(0x11f)]('currency',_0x3f6b6f),_0x421667[_0x4879e9(0x11f)](_0x4879e9(0x126),_0x2c5794),_0x421667[_0x4879e9(0x11f)](_0x4879e9(0x13e),_0x40f81d[_0x4879e9(0xf1)]())):(_0x421667[_0x4879e9(0x11f)](_0x4879e9(0x107),_0x2c5794),_0x421667[_0x4879e9(0x11f)](_0x4879e9(0x14b),_0x40f81d[_0x4879e9(0xf1)]()));_0x16d9ad&&_0x421667[_0x4879e9(0x11f)](_0x4879e9(0xef),_0x16d9ad);_0x2b8ec4&&_0x421667[_0x4879e9(0x11f)]('name',_0x2b8ec4);const _0x4d878b=this['apiUrl']+'?'+_0x421667['toString'](),_0x2c0aaf=Date[_0x4879e9(0x15b)]();try{console[_0x4879e9(0xf0)](_0x4879e9(0xfb)),console[_0x4879e9(0xf0)](_0x4879e9(0x14a),this[_0x4879e9(0xfa)]),console[_0x4879e9(0xf0)]('Parameters:',Object[_0x4879e9(0x129)](_0x421667[_0x4879e9(0x15a)]())),console[_0x4879e9(0xf0)](_0x4879e9(0x144),_0x4d878b[_0x4879e9(0x155)](this[_0x4879e9(0x128)],_0x4879e9(0x134))),loggerService_1[_0x4879e9(0x117)][_0x4879e9(0x160)]('plisio_direct',_0x4879e9(0x13d),_0x4879e9(0xf3),Object['fromEntries'](_0x421667[_0x4879e9(0x15a)]()));const _0x16ad6a=await fetch(_0x4d878b,{'method':_0x4879e9(0xf3),'headers':{'Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x454136=Date[_0x4879e9(0x15b)]()-_0x2c0aaf;console[_0x4879e9(0xf0)](_0x4879e9(0x121)),console[_0x4879e9(0xf0)](_0x4879e9(0x142),_0x16ad6a[_0x4879e9(0x13f)]),console['log'](_0x4879e9(0x145),_0x16ad6a['statusText']),console[_0x4879e9(0xf0)]('Response\x20Time:',_0x454136+'ms');const _0x535021=await _0x16ad6a['text']();console['log'](_0x4879e9(0x115),_0x535021);if(!_0x16ad6a['ok']){console[_0x4879e9(0xfc)](_0x4879e9(0x130)),console[_0x4879e9(0xfc)](_0x4879e9(0x110),_0x16ad6a[_0x4879e9(0x13f)]),console[_0x4879e9(0xfc)]('Response\x20Body:',_0x535021),loggerService_1['loggerService']['logWhiteDomainResponse']('plisio_direct',_0x4879e9(0x13d),_0x16ad6a['status'],_0x535021,_0x454136),loggerService_1[_0x4879e9(0x117)][_0x4879e9(0x161)](_0x4879e9(0x138),'/invoices/new',_0x4879e9(0x131)+_0x16ad6a[_0x4879e9(0x13f)]+':\x20'+_0x535021);throw new Error('HTTP\x20error!\x20status:\x20'+_0x16ad6a[_0x4879e9(0x13f)]+_0x4879e9(0x10b)+_0x535021);}let _0x3b0036;try{_0x3b0036=JSON['parse'](_0x535021);}catch(_0xebf21c){console[_0x4879e9(0xfc)](_0x4879e9(0x11e),_0xebf21c),loggerService_1[_0x4879e9(0x117)][_0x4879e9(0x161)](_0x4879e9(0x138),_0x4879e9(0x13d),'JSON\x20Parse\x20Error:\x20'+_0xebf21c);throw new Error('Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20'+_0x535021);}console[_0x4879e9(0xf0)](_0x4879e9(0xee)),console[_0x4879e9(0xf0)](_0x4879e9(0x123),JSON['stringify'](_0x3b0036,null,0x2)),loggerService_1[_0x4879e9(0x117)]['logWhiteDomainResponse']('plisio_direct',_0x4879e9(0x13d),_0x16ad6a[_0x4879e9(0x13f)],_0x3b0036,_0x454136);if(_0x3b0036[_0x4879e9(0x13f)]!==_0x4879e9(0x111)){const _0x85484c=_0x3b0036['message']||_0x3b0036[_0x4879e9(0xfc)]||_0x4879e9(0x146);console['error'](_0x4879e9(0x113)),console[_0x4879e9(0xfc)]('Error\x20Message:',_0x85484c),loggerService_1[_0x4879e9(0x117)][_0x4879e9(0x161)](_0x4879e9(0x138),_0x4879e9(0x13d),'Business\x20Error:\x20'+_0x85484c);throw new Error('Plisio\x20API\x20error:\x20'+_0x85484c);}if(!_0x3b0036[_0x4879e9(0x152)]?.['txn_id']||!_0x3b0036[_0x4879e9(0x152)]?.[_0x4879e9(0x108)]){console[_0x4879e9(0xfc)](_0x4879e9(0x10f)),console['error']('Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response'),console['error'](_0x4879e9(0x103),_0x3b0036['data']),loggerService_1[_0x4879e9(0x117)][_0x4879e9(0x161)](_0x4879e9(0x138),_0x4879e9(0x13d),_0x4879e9(0x11b));throw new Error(_0x4879e9(0x148));}return console['log']('===\x20PLISIO\x20SUCCESS\x20==='),console[_0x4879e9(0xf0)](_0x4879e9(0x15f),_0x3b0036[_0x4879e9(0x152)][_0x4879e9(0xff)]),console[_0x4879e9(0xf0)]('Invoice\x20URL:',_0x3b0036[_0x4879e9(0x152)][_0x4879e9(0x108)]),console['log'](_0x4879e9(0x118),_0x40f81d,_0x2c5794),_0x3f6b6f&&(console[_0x4879e9(0xf0)](_0x4879e9(0x109),_0x3f6b6f,_0x4879e9(0x127)),console[_0x4879e9(0xf0)](_0x4879e9(0x11c),_0x2c5794,_0x4879e9(0x11d))),{'gateway_payment_id':_0x3b0036[_0x4879e9(0x152)][_0x4879e9(0xff)],'payment_url':_0x3b0036[_0x4879e9(0x152)][_0x4879e9(0x108)],'invoice_total_sum':_0x3b0036[_0x4879e9(0x152)][_0x4879e9(0x12b)],'qr_code':_0x3b0036[_0x4879e9(0x152)][_0x4879e9(0x139)],'qr_url':_0x3b0036[_0x4879e9(0x152)][_0x4879e9(0x119)]};}catch(_0x50e9c8){console[_0x4879e9(0xfc)](_0x4879e9(0x15d)),console[_0x4879e9(0xfc)](_0x4879e9(0x154),_0x50e9c8),loggerService_1[_0x4879e9(0x117)][_0x4879e9(0x161)]('plisio_direct',_0x4879e9(0x13d),_0x50e9c8);if(_0x50e9c8 instanceof Error){console[_0x4879e9(0xfc)](_0x4879e9(0xf5),_0x50e9c8[_0x4879e9(0x13b)]),console[_0x4879e9(0xfc)](_0x4879e9(0x140),_0x50e9c8[_0x4879e9(0x104)]);throw new Error(_0x4879e9(0xf8)+_0x50e9c8[_0x4879e9(0x13b)]);}throw new Error(_0x4879e9(0xfd));}}async['verifyPayment'](_0x17644a){const _0x59b84c=a41_0x591790,_0x202809=Date[_0x59b84c(0x15b)]();try{if(!this['apiKey'])throw new Error(_0x59b84c(0x137));const _0x2484ee=new URLSearchParams({'api_key':this[_0x59b84c(0x128)],'txn_id':_0x17644a}),_0x5bae94=_0x59b84c(0x12f)+_0x17644a+'?'+_0x2484ee[_0x59b84c(0xf1)]();loggerService_1['loggerService'][_0x59b84c(0x160)](_0x59b84c(0x138),'/operations/'+_0x17644a,_0x59b84c(0xf3),Object['fromEntries'](_0x2484ee[_0x59b84c(0x15a)]()));const _0x1e061a=await fetch(_0x5bae94,{'method':_0x59b84c(0xf3),'headers':{'Accept':_0x59b84c(0x10d),'User-Agent':_0x59b84c(0xed)}}),_0x543ab7=Date[_0x59b84c(0x15b)]()-_0x202809;if(!_0x1e061a['ok']){const _0x2675da=await _0x1e061a['text']();loggerService_1[_0x59b84c(0x117)][_0x59b84c(0x147)]('plisio_direct',_0x59b84c(0x151)+_0x17644a,_0x1e061a['status'],_0x2675da,_0x543ab7);throw new Error('HTTP\x20error!\x20status:\x20'+_0x1e061a[_0x59b84c(0x13f)]);}const _0x5253f9=await _0x1e061a[_0x59b84c(0x13c)]();loggerService_1['loggerService']['logWhiteDomainResponse'](_0x59b84c(0x138),_0x59b84c(0x151)+_0x17644a,_0x1e061a[_0x59b84c(0x13f)],_0x5253f9,_0x543ab7);if(_0x5253f9[_0x59b84c(0x13f)]!=='success'){loggerService_1[_0x59b84c(0x117)][_0x59b84c(0x161)](_0x59b84c(0x138),_0x59b84c(0x151)+_0x17644a,_0x59b84c(0xf9)+(_0x5253f9[_0x59b84c(0x13b)]||_0x5253f9[_0x59b84c(0xfc)]||'Unknown\x20error'));throw new Error('Plisio\x20API\x20error:\x20'+(_0x5253f9[_0x59b84c(0x13b)]||_0x5253f9['error']||_0x59b84c(0xf7)));}let _0x2ae1b9=_0x59b84c(0x15e);return{'status':_0x2ae1b9};}catch(_0x4d9459){console[_0x59b84c(0xfc)](_0x59b84c(0x141),_0x4d9459),loggerService_1[_0x59b84c(0x117)][_0x59b84c(0x161)]('plisio_direct',_0x59b84c(0x151)+_0x17644a,_0x4d9459);throw new Error(_0x59b84c(0x14c)+(_0x4d9459 instanceof Error?_0x4d9459[_0x59b84c(0x13b)]:_0x59b84c(0xf7)));}}async[a41_0x591790(0x10e)](_0xab6ddb){const _0xcfe40b=a41_0x591790;console[_0xcfe40b(0xf0)]('Processing\x20Plisio\x20webhook:',_0xab6ddb);let _0x6e64d3=_0xcfe40b(0x15e);switch(_0xab6ddb['status']?.['toLowerCase']()){case _0xcfe40b(0x159):case _0xcfe40b(0x105):_0x6e64d3=_0xcfe40b(0x12e);break;case _0xcfe40b(0x100):_0x6e64d3=_0xcfe40b(0x112);break;case'error':case _0xcfe40b(0x125):_0x6e64d3=_0xcfe40b(0x158);break;case _0xcfe40b(0xeb):case _0xcfe40b(0x11a):default:_0x6e64d3='PENDING';break;}let _0x4e929f;if(_0xab6ddb[_0xcfe40b(0x150)])try{console[_0xcfe40b(0xf0)]('üîó\x20Raw\x20tx_urls\x20from\x20Plisio:',_0xab6ddb[_0xcfe40b(0x150)]);let _0x5122ba;if(typeof _0xab6ddb[_0xcfe40b(0x150)]==='string')_0x5122ba=JSON['parse'](_0xab6ddb['tx_urls']);else Array[_0xcfe40b(0x120)](_0xab6ddb[_0xcfe40b(0x150)])?_0x5122ba=_0xab6ddb['tx_urls']:_0x5122ba=[];_0x4e929f=_0x5122ba[_0xcfe40b(0xec)](_0x56d940=>{const _0x461116=_0xcfe40b,_0x3558ec=_0x56d940[_0x461116(0x155)](/\\/g,'');return console[_0x461116(0xf0)](_0x461116(0x12c)+_0x56d940+_0x461116(0x116)+_0x3558ec),_0x3558ec;}),console[_0xcfe40b(0xf0)](_0xcfe40b(0x13a),_0x4e929f),_0x4e929f[_0xcfe40b(0x157)]((_0x4a8f52,_0x36d559)=>{const _0x2c5029=_0xcfe40b;try{new URL(_0x4a8f52),console[_0x2c5029(0xf0)](_0x2c5029(0x102)+(_0x36d559+0x1)+_0x2c5029(0xf6)+_0x4a8f52);}catch(_0xe0b5b2){console[_0x2c5029(0xfc)](_0x2c5029(0x122)+(_0x36d559+0x1)+_0x2c5029(0xf2)+_0x4a8f52,_0xe0b5b2);}});}catch(_0x1b0596){console[_0xcfe40b(0xfc)](_0xcfe40b(0x156),_0x1b0596),console['error'](_0xcfe40b(0x114),_0xab6ddb[_0xcfe40b(0x150)]),_0x4e929f=undefined;}return{'paymentId':_0xab6ddb['order_number']||'','status':_0x6e64d3,'amount':_0xab6ddb[_0xcfe40b(0x14b)],'currency':_0xab6ddb[_0xcfe40b(0x107)],'txUrls':_0x4e929f};}}exports['PlisioService']=PlisioService;