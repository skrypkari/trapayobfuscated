'use strict';const a55_0x1f6771=a55_0x2378;function a55_0x2378(_0x37531e,_0xf0f5c9){const _0x362d2e=a55_0x362d();return a55_0x2378=function(_0x2378fb,_0x3407d7){_0x2378fb=_0x2378fb-0xe8;let _0x3c56f5=_0x362d2e[_0x2378fb];return _0x3c56f5;},a55_0x2378(_0x37531e,_0xf0f5c9);}(function(_0x51ba50,_0x3a7b88){const _0x1c0825=a55_0x2378,_0x5f3ee=_0x51ba50();while(!![]){try{const _0x25bc50=-parseInt(_0x1c0825(0x155))/0x1*(parseInt(_0x1c0825(0x125))/0x2)+-parseInt(_0x1c0825(0x10f))/0x3*(parseInt(_0x1c0825(0x12b))/0x4)+parseInt(_0x1c0825(0x129))/0x5*(parseInt(_0x1c0825(0x12d))/0x6)+-parseInt(_0x1c0825(0x150))/0x7*(-parseInt(_0x1c0825(0x151))/0x8)+-parseInt(_0x1c0825(0x10e))/0x9+parseInt(_0x1c0825(0xf6))/0xa*(-parseInt(_0x1c0825(0xef))/0xb)+-parseInt(_0x1c0825(0x118))/0xc*(-parseInt(_0x1c0825(0xec))/0xd);if(_0x25bc50===_0x3a7b88)break;else _0x5f3ee['push'](_0x5f3ee['shift']());}catch(_0x4a8a01){_0x5f3ee['push'](_0x5f3ee['shift']());}}}(a55_0x362d,0xc20e7));function a55_0x362d(){const _0x40a582=['status','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','source_amount','apiKey','logWhiteDomainError','Transaction\x20ID:','map','💰\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','plisio_direct','replace','Plisio\x20API\x20key\x20is\x20not\x20configured','❌\x20Failed\x20to\x20parse\x20tx_urls:','message','source_currency','../loggerService','invoice_url','toLowerCase','log','Failed\x20to\x20create\x20Plisio\x20payment:\x20','text','json','data','Error\x20message:','apiUrl','stack','loggerService','Plisio\x20API\x20error:\x20','🔗\x20Formatted\x20URL:\x20','Invoice\x20URL:','PENDING','9058721QZjMZv','8eIrhsJ','pending','Processing\x20Plisio\x20webhook:','Error\x20Message:','1uQOaXN','logWhiteDomainRequest','logWhiteDomainResponse','name','append','Source\x20Currency:','expired','Amount:','entries','defineProperty','PLISIO_API_KEY','GET','Failed\x20to\x20parse\x20JSON\x20response:','PROCESSING','Parameters:','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','Response\x20Time:','⚠️\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','Unknown\x20error\x20from\x20Plisio\x20API','createPayment','10803xRhwEd','stringify','Raw\x20Response\x20Body:','44aLozpr','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','error','\x20is\x20valid:\x20','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','Parsed\x20Result:','1945150QnvdQy','Unknown\x20error','string','txn_id','HTTP\x20','qr_url','Status:','https://api.trapay.uk/api/webhooks/gateway/plisio','Status\x20Text:','warn','PAID','Raw\x20tx_urls\x20data:','FAILED','__esModule','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','fromEntries','Response\x20data:','\x20->\x20','now','Payment\x20System/1.0','success','amount','13670226lKnlzT','3VFQtiN','new','Error\x20details:','Plisio\x20payment\x20verification\x20error:','Target\x20Currency:','isArray','application/json','PlisioService',',\x20body:\x20','46908GHzICz','completed','qr_code','invoice_total_sum','Response\x20Body:','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','✅\x20URL\x20','/operations/','currency','verifyPayment','(fiat\x20for\x20merchant)','/invoices/new','1825918wfLSsR','tx_urls','Full\x20URL\x20(without\x20API\x20key):','(crypto\x20for\x20payment)','1695065yXBtOV','toString','6218932lQpFmh','\x20is\x20invalid:\x20','18SkFNRc','parse','Business\x20Error:\x20','forEach','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20'];a55_0x362d=function(){return _0x40a582;};return a55_0x362d();}Object[a55_0x1f6771(0x15e)](exports,a55_0x1f6771(0x103),{'value':!![]}),exports[a55_0x1f6771(0x116)]=void 0x0;const loggerService_1=require(a55_0x1f6771(0x140));class PlisioService{constructor(){const _0x49e5d6=a55_0x1f6771;this['apiUrl']='https://api.plisio.net/api/v1/invoices/new',this['apiKey']=process['env'][_0x49e5d6(0x15f)]||'',!this[_0x49e5d6(0x135)]?console[_0x49e5d6(0xff)](_0x49e5d6(0xe9)):console['log'](_0x49e5d6(0x139));}async[a55_0x1f6771(0xeb)](_0x30e9b7){const _0x110640=a55_0x1f6771,{orderId:_0xfa10a7,amount:_0x1df82e,currency:_0xc21489,productName:_0x5a2a61,description:_0xd10e97,successUrl:_0x3587a9,failUrl:_0x5e6004,customerEmail:_0x158b2a,customerName:_0x9a9a3a,isSourceCurrency:_0x33b9ee,sourceCurrency:_0x4e3e37}=_0x30e9b7;if(!this[_0x110640(0x135)])throw new Error('Plisio\x20API\x20key\x20is\x20not\x20configured');const _0x4bb23a=new URLSearchParams({'api_key':this[_0x110640(0x135)],'order_number':_0xfa10a7,'order_name':_0x5a2a61,'description':_0xd10e97,'success_url':_0x3587a9,'fail_url':_0x5e6004,'callback_url':_0x110640(0xfd)});_0x4e3e37?(_0x4bb23a['append'](_0x110640(0x121),_0x4e3e37),_0x4bb23a[_0x110640(0x159)](_0x110640(0x13f),_0xc21489),_0x4bb23a[_0x110640(0x159)](_0x110640(0x134),_0x1df82e[_0x110640(0x12a)]())):(_0x4bb23a[_0x110640(0x159)](_0x110640(0x121),_0xc21489),_0x4bb23a['append'](_0x110640(0x10d),_0x1df82e[_0x110640(0x12a)]()));_0x158b2a&&_0x4bb23a[_0x110640(0x159)]('email',_0x158b2a);_0x9a9a3a&&_0x4bb23a[_0x110640(0x159)](_0x110640(0x158),_0x9a9a3a);const _0x55003d=this[_0x110640(0x149)]+'?'+_0x4bb23a[_0x110640(0x12a)](),_0x1ed5fc=Date[_0x110640(0x10a)]();try{console['log'](_0x110640(0xf4)),console[_0x110640(0x143)]('URL:',this[_0x110640(0x149)]),console['log'](_0x110640(0x163),Object[_0x110640(0x107)](_0x4bb23a['entries']())),console[_0x110640(0x143)](_0x110640(0x127),_0x55003d[_0x110640(0x13b)](this[_0x110640(0x135)],'HIDDEN')),loggerService_1[_0x110640(0x14b)][_0x110640(0x156)](_0x110640(0x13a),_0x110640(0x124),'GET',Object['fromEntries'](_0x4bb23a[_0x110640(0x15d)]()));const _0x5a8fdb=await fetch(_0x55003d,{'method':_0x110640(0x160),'headers':{'Accept':_0x110640(0x115),'User-Agent':_0x110640(0x10b)}}),_0x128f11=Date[_0x110640(0x10a)]()-_0x1ed5fc;console['log'](_0x110640(0xf0)),console[_0x110640(0x143)](_0x110640(0xfc),_0x5a8fdb[_0x110640(0x132)]),console[_0x110640(0x143)](_0x110640(0xfe),_0x5a8fdb['statusText']),console[_0x110640(0x143)](_0x110640(0xe8),_0x128f11+'ms');const _0x5b32b0=await _0x5a8fdb[_0x110640(0x145)]();console[_0x110640(0x143)](_0x110640(0xee),_0x5b32b0);if(!_0x5a8fdb['ok']){console[_0x110640(0xf1)]('===\x20PLISIO\x20API\x20ERROR\x20==='),console[_0x110640(0xf1)]('HTTP\x20Status:',_0x5a8fdb[_0x110640(0x132)]),console[_0x110640(0xf1)](_0x110640(0x11c),_0x5b32b0),loggerService_1['loggerService'][_0x110640(0x157)]('plisio_direct',_0x110640(0x124),_0x5a8fdb[_0x110640(0x132)],_0x5b32b0,_0x128f11),loggerService_1[_0x110640(0x14b)][_0x110640(0x136)](_0x110640(0x13a),'/invoices/new',_0x110640(0xfa)+_0x5a8fdb[_0x110640(0x132)]+':\x20'+_0x5b32b0);throw new Error('HTTP\x20error!\x20status:\x20'+_0x5a8fdb['status']+_0x110640(0x117)+_0x5b32b0);}let _0xbe8e7;try{_0xbe8e7=JSON[_0x110640(0x12e)](_0x5b32b0);}catch(_0x3595dd){console[_0x110640(0xf1)](_0x110640(0x161),_0x3595dd),loggerService_1[_0x110640(0x14b)][_0x110640(0x136)](_0x110640(0x13a),_0x110640(0x124),'JSON\x20Parse\x20Error:\x20'+_0x3595dd);throw new Error(_0x110640(0x131)+_0x5b32b0);}console[_0x110640(0x143)](_0x110640(0x164)),console[_0x110640(0x143)](_0x110640(0xf5),JSON[_0x110640(0xed)](_0xbe8e7,null,0x2)),loggerService_1[_0x110640(0x14b)][_0x110640(0x157)](_0x110640(0x13a),'/invoices/new',_0x5a8fdb[_0x110640(0x132)],_0xbe8e7,_0x128f11);if(_0xbe8e7[_0x110640(0x132)]!==_0x110640(0x10c)){const _0x50d219=_0xbe8e7[_0x110640(0x13e)]||_0xbe8e7[_0x110640(0xf1)]||_0x110640(0xea);console[_0x110640(0xf1)]('===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x110640(0xf1)](_0x110640(0x154),_0x50d219),loggerService_1[_0x110640(0x14b)][_0x110640(0x136)](_0x110640(0x13a),_0x110640(0x124),_0x110640(0x12f)+_0x50d219);throw new Error(_0x110640(0x14c)+_0x50d219);}if(!_0xbe8e7[_0x110640(0x147)]?.[_0x110640(0xf9)]||!_0xbe8e7[_0x110640(0x147)]?.[_0x110640(0x141)]){console['error'](_0x110640(0x11e)),console[_0x110640(0xf1)](_0x110640(0x11d)),console['error'](_0x110640(0x108),_0xbe8e7['data']),loggerService_1[_0x110640(0x14b)][_0x110640(0x136)](_0x110640(0x13a),_0x110640(0x124),_0x110640(0xf3));throw new Error(_0x110640(0x106));}return console['log']('===\x20PLISIO\x20SUCCESS\x20==='),console['log'](_0x110640(0x137),_0xbe8e7[_0x110640(0x147)][_0x110640(0xf9)]),console[_0x110640(0x143)](_0x110640(0x14e),_0xbe8e7[_0x110640(0x147)][_0x110640(0x141)]),console[_0x110640(0x143)](_0x110640(0x15c),_0x1df82e,_0xc21489),_0x4e3e37&&(console['log'](_0x110640(0x15a),_0x4e3e37,_0x110640(0x128)),console['log'](_0x110640(0x113),_0xc21489,_0x110640(0x123))),{'gateway_payment_id':_0xbe8e7[_0x110640(0x147)][_0x110640(0xf9)],'payment_url':_0xbe8e7[_0x110640(0x147)]['invoice_url'],'invoice_total_sum':_0xbe8e7[_0x110640(0x147)][_0x110640(0x11b)],'qr_code':_0xbe8e7[_0x110640(0x147)][_0x110640(0x11a)],'qr_url':_0xbe8e7[_0x110640(0x147)][_0x110640(0xfb)]};}catch(_0x5cf05c){console[_0x110640(0xf1)](_0x110640(0x105)),console[_0x110640(0xf1)](_0x110640(0x111),_0x5cf05c),loggerService_1[_0x110640(0x14b)][_0x110640(0x136)](_0x110640(0x13a),_0x110640(0x124),_0x5cf05c);if(_0x5cf05c instanceof Error){console[_0x110640(0xf1)](_0x110640(0x148),_0x5cf05c[_0x110640(0x13e)]),console[_0x110640(0xf1)]('Error\x20stack:',_0x5cf05c[_0x110640(0x14a)]);throw new Error(_0x110640(0x144)+_0x5cf05c[_0x110640(0x13e)]);}throw new Error(_0x110640(0x104));}}async[a55_0x1f6771(0x122)](_0x49d468){const _0x2864ab=a55_0x1f6771,_0x19c892=Date[_0x2864ab(0x10a)]();try{if(!this[_0x2864ab(0x135)])throw new Error(_0x2864ab(0x13c));const _0xec4ea1=new URLSearchParams({'api_key':this[_0x2864ab(0x135)],'txn_id':_0x49d468}),_0x2d9f46='https://api.plisio.net/api/v1/operations/'+_0x49d468+'?'+_0xec4ea1['toString']();loggerService_1[_0x2864ab(0x14b)][_0x2864ab(0x156)]('plisio_direct','/operations/'+_0x49d468,_0x2864ab(0x160),Object[_0x2864ab(0x107)](_0xec4ea1['entries']()));const _0x1d492b=await fetch(_0x2d9f46,{'method':_0x2864ab(0x160),'headers':{'Accept':_0x2864ab(0x115),'User-Agent':_0x2864ab(0x10b)}}),_0x111124=Date[_0x2864ab(0x10a)]()-_0x19c892;if(!_0x1d492b['ok']){const _0x4d8bc1=await _0x1d492b[_0x2864ab(0x145)]();loggerService_1[_0x2864ab(0x14b)][_0x2864ab(0x157)](_0x2864ab(0x13a),_0x2864ab(0x120)+_0x49d468,_0x1d492b[_0x2864ab(0x132)],_0x4d8bc1,_0x111124);throw new Error('HTTP\x20error!\x20status:\x20'+_0x1d492b[_0x2864ab(0x132)]);}const _0x59f2cc=await _0x1d492b[_0x2864ab(0x146)]();loggerService_1[_0x2864ab(0x14b)][_0x2864ab(0x157)](_0x2864ab(0x13a),_0x2864ab(0x120)+_0x49d468,_0x1d492b[_0x2864ab(0x132)],_0x59f2cc,_0x111124);if(_0x59f2cc['status']!==_0x2864ab(0x10c)){loggerService_1['loggerService'][_0x2864ab(0x136)](_0x2864ab(0x13a),_0x2864ab(0x120)+_0x49d468,_0x2864ab(0x14c)+(_0x59f2cc['message']||_0x59f2cc[_0x2864ab(0xf1)]||_0x2864ab(0xf7)));throw new Error('Plisio\x20API\x20error:\x20'+(_0x59f2cc[_0x2864ab(0x13e)]||_0x59f2cc[_0x2864ab(0xf1)]||'Unknown\x20error'));}let _0x36c6d4=_0x2864ab(0x14f);return{'status':_0x36c6d4};}catch(_0xc9f066){console[_0x2864ab(0xf1)](_0x2864ab(0x112),_0xc9f066),loggerService_1[_0x2864ab(0x14b)]['logWhiteDomainError'](_0x2864ab(0x13a),'/operations/'+_0x49d468,_0xc9f066);throw new Error(_0x2864ab(0x133)+(_0xc9f066 instanceof Error?_0xc9f066['message']:_0x2864ab(0xf7)));}}async['processWebhook'](_0x215030){const _0x4aa401=a55_0x1f6771;console[_0x4aa401(0x143)](_0x4aa401(0x153),_0x215030);let _0x37b56d=_0x4aa401(0x14f);switch(_0x215030[_0x4aa401(0x132)]?.[_0x4aa401(0x142)]()){case _0x4aa401(0x119):case'mismatch':_0x37b56d=_0x4aa401(0x100);break;case _0x4aa401(0x15b):_0x37b56d='EXPIRED';break;case'error':case'cancelled':_0x37b56d=_0x4aa401(0x102);break;case _0x4aa401(0x110):_0x37b56d=_0x4aa401(0x14f);break;case _0x4aa401(0x152):_0x37b56d=_0x4aa401(0x162);break;default:_0x37b56d=_0x4aa401(0x14f);break;}let _0x34b142;if(_0x215030['tx_urls'])try{console['log']('🔗\x20Raw\x20tx_urls\x20from\x20Plisio:',_0x215030['tx_urls']);let _0x4350be;if(typeof _0x215030[_0x4aa401(0x126)]===_0x4aa401(0xf8))_0x4350be=JSON[_0x4aa401(0x12e)](_0x215030[_0x4aa401(0x126)]);else Array[_0x4aa401(0x114)](_0x215030['tx_urls'])?_0x4350be=_0x215030['tx_urls']:_0x4350be=[];_0x34b142=_0x4350be[_0x4aa401(0x138)](_0x26eb56=>{const _0xf1fe93=_0x4aa401,_0x526b25=_0x26eb56[_0xf1fe93(0x13b)](/\\/g,'');return console[_0xf1fe93(0x143)](_0xf1fe93(0x14d)+_0x26eb56+_0xf1fe93(0x109)+_0x526b25),_0x526b25;}),console[_0x4aa401(0x143)]('✅\x20Processed\x20tx_urls:',_0x34b142),_0x34b142[_0x4aa401(0x130)]((_0x2eaed0,_0x39169a)=>{const _0x3a9520=_0x4aa401;try{new URL(_0x2eaed0),console['log'](_0x3a9520(0x11f)+(_0x39169a+0x1)+_0x3a9520(0xf2)+_0x2eaed0);}catch(_0x7d24db){console[_0x3a9520(0xf1)]('❌\x20URL\x20'+(_0x39169a+0x1)+_0x3a9520(0x12c)+_0x2eaed0,_0x7d24db);}});}catch(_0x40cbd3){console[_0x4aa401(0xf1)](_0x4aa401(0x13d),_0x40cbd3),console['error'](_0x4aa401(0x101),_0x215030[_0x4aa401(0x126)]),_0x34b142=undefined;}return{'paymentId':_0x215030['order_number']||'','status':_0x37b56d,'amount':_0x215030[_0x4aa401(0x10d)],'currency':_0x215030[_0x4aa401(0x121)],'txUrls':_0x34b142};}}exports[a55_0x1f6771(0x116)]=PlisioService;