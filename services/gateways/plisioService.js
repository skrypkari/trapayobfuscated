'use strict';const a44_0x28ecc7=a44_0x10ac;(function(_0x4329f4,_0x21d81a){const _0x4d4b52=a44_0x10ac,_0x333829=_0x4329f4();while(!![]){try{const _0x339861=parseInt(_0x4d4b52(0xf0))/0x1+parseInt(_0x4d4b52(0xea))/0x2+parseInt(_0x4d4b52(0x97))/0x3*(-parseInt(_0x4d4b52(0xb5))/0x4)+-parseInt(_0x4d4b52(0x95))/0x5+-parseInt(_0x4d4b52(0xd4))/0x6+parseInt(_0x4d4b52(0xf7))/0x7+parseInt(_0x4d4b52(0xa2))/0x8;if(_0x339861===_0x21d81a)break;else _0x333829['push'](_0x333829['shift']());}catch(_0x1a7ed3){_0x333829['push'](_0x333829['shift']());}}}(a44_0x3599,0x4e0a2));function a44_0x3599(){const _0x302a2a=['===\x20PLISIO\x20API\x20ERROR\x20===','üîó\x20Formatted\x20URL:\x20','entries','378511CxQhaO','message','Full\x20URL\x20(without\x20API\x20key):','‚ùå\x20URL\x20','https://api.plisio.net/api/v1/invoices/new','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','HIDDEN','text','2291300olzmsW','Error\x20message:','864MfWcJi','Parameters:','logWhiteDomainResponse','Raw\x20Response\x20Body:','toString','TesSoft\x20Payment\x20System/1.0','status','Response\x20Body:','Plisio\x20API\x20key\x20is\x20not\x20configured','Raw\x20tx_urls\x20data:','loggerService','5915944NAOzAA','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','GET','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','HTTP\x20','mismatch','createPayment','PlisioService','Processing\x20Plisio\x20webhook:','Error\x20details:','\x20->\x20','toLowerCase','cancelled','amount','completed','parse','currency','source_currency','Failed\x20to\x20create\x20Plisio\x20payment:\x20','2832RrKYKI','‚ùå\x20Failed\x20to\x20parse\x20tx_urls:','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','verifyPayment','FAILED','string','apiUrl','üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','Response\x20Time:',',\x20body:\x20','data','Status:','‚úÖ\x20URL\x20','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','txn_id','PENDING','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','fromEntries','invoice_total_sum','now','logWhiteDomainError','tx_urls','Business\x20Error:\x20','success','Amount:','name','plisio_direct','json','append','invoice_url','application/json','1969524BLAmQF','Status\x20Text:','env','Response\x20data:','source_amount','log','stack','Transaction\x20ID:','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','Target\x20Currency:','error','Unknown\x20error','(fiat\x20for\x20merchant)','/operations/','pending','/invoices/new','URL:','https://api.trapay.uk/api/webhooks/gateway/plisio','email','Plisio\x20API\x20error:\x20','processWebhook','new','946172iDVZaI','\x20is\x20valid:\x20','apiKey','(crypto\x20for\x20payment)','order_number','PLISIO_API_KEY','43416LkJxuv','===\x20PLISIO\x20SUCCESS\x20===','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','map'];a44_0x3599=function(){return _0x302a2a;};return a44_0x3599();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a44_0x28ecc7(0xa9)]=void 0x0;function a44_0x10ac(_0x43cfb9,_0x1802e7){const _0x359932=a44_0x3599();return a44_0x10ac=function(_0x10ac65,_0x16b167){_0x10ac65=_0x10ac65-0x90;let _0x50cbcb=_0x359932[_0x10ac65];return _0x50cbcb;},a44_0x10ac(_0x43cfb9,_0x1802e7);}const loggerService_1=require('../loggerService');class PlisioService{constructor(){const _0x51ed43=a44_0x28ecc7;this[_0x51ed43(0xbb)]=_0x51ed43(0x91),this[_0x51ed43(0xec)]=process[_0x51ed43(0xd6)][_0x51ed43(0xef)]||'',!this[_0x51ed43(0xec)]?console['warn']('‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables'):console[_0x51ed43(0xd9)](_0x51ed43(0xbc));}async[a44_0x28ecc7(0xa8)](_0x7e4c17){const _0x51ec81=a44_0x28ecc7,{orderId:_0x3cc386,amount:_0x3e9103,currency:_0x3cef09,productName:_0x41e623,description:_0x523f57,successUrl:_0x553458,failUrl:_0x55275d,customerEmail:_0x35b3ca,customerName:_0x1abe3d,isSourceCurrency:_0x47b97f,sourceCurrency:_0x47bff9}=_0x7e4c17;if(!this[_0x51ec81(0xec)])throw new Error(_0x51ec81(0x9f));const _0x192ba5=new URLSearchParams({'api_key':this['apiKey'],'order_number':_0x3cc386,'order_name':_0x41e623,'description':_0x523f57,'success_url':_0x553458,'fail_url':_0x55275d,'callback_url':_0x51ec81(0xe5)});_0x47bff9?(_0x192ba5[_0x51ec81(0xd1)]('currency',_0x47bff9),_0x192ba5[_0x51ec81(0xd1)](_0x51ec81(0xb3),_0x3cef09),_0x192ba5['append'](_0x51ec81(0xd8),_0x3e9103[_0x51ec81(0x9b)]())):(_0x192ba5[_0x51ec81(0xd1)](_0x51ec81(0xb2),_0x3cef09),_0x192ba5[_0x51ec81(0xd1)](_0x51ec81(0xaf),_0x3e9103[_0x51ec81(0x9b)]()));_0x35b3ca&&_0x192ba5[_0x51ec81(0xd1)](_0x51ec81(0xe6),_0x35b3ca);_0x1abe3d&&_0x192ba5[_0x51ec81(0xd1)](_0x51ec81(0xce),_0x1abe3d);const _0x34963b=this[_0x51ec81(0xbb)]+'?'+_0x192ba5[_0x51ec81(0x9b)](),_0x677b92=Date[_0x51ec81(0xc8)]();try{console[_0x51ec81(0xd9)]('===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20==='),console[_0x51ec81(0xd9)](_0x51ec81(0xe4),this[_0x51ec81(0xbb)]),console[_0x51ec81(0xd9)](_0x51ec81(0x98),Object['fromEntries'](_0x192ba5[_0x51ec81(0xf6)]())),console[_0x51ec81(0xd9)](_0x51ec81(0xf9),_0x34963b['replace'](this[_0x51ec81(0xec)],_0x51ec81(0x93))),loggerService_1['loggerService']['logWhiteDomainRequest'](_0x51ec81(0xcf),'/invoices/new',_0x51ec81(0xa4),Object[_0x51ec81(0xc6)](_0x192ba5[_0x51ec81(0xf6)]()));const _0x48ec6e=await fetch(_0x34963b,{'method':_0x51ec81(0xa4),'headers':{'Accept':_0x51ec81(0xd3),'User-Agent':_0x51ec81(0x9c)}}),_0x11f10e=Date[_0x51ec81(0xc8)]()-_0x677b92;console['log'](_0x51ec81(0xc2)),console[_0x51ec81(0xd9)](_0x51ec81(0xc0),_0x48ec6e[_0x51ec81(0x9d)]),console[_0x51ec81(0xd9)](_0x51ec81(0xd5),_0x48ec6e['statusText']),console[_0x51ec81(0xd9)](_0x51ec81(0xbd),_0x11f10e+'ms');const _0x3c446b=await _0x48ec6e[_0x51ec81(0x94)]();console[_0x51ec81(0xd9)](_0x51ec81(0x9a),_0x3c446b);if(!_0x48ec6e['ok']){console[_0x51ec81(0xde)](_0x51ec81(0xf4)),console['error']('HTTP\x20Status:',_0x48ec6e['status']),console['error'](_0x51ec81(0x9e),_0x3c446b),loggerService_1[_0x51ec81(0xa1)][_0x51ec81(0x99)](_0x51ec81(0xcf),_0x51ec81(0xe3),_0x48ec6e['status'],_0x3c446b,_0x11f10e),loggerService_1[_0x51ec81(0xa1)][_0x51ec81(0xc9)](_0x51ec81(0xcf),'/invoices/new',_0x51ec81(0xa6)+_0x48ec6e['status']+':\x20'+_0x3c446b);throw new Error('HTTP\x20error!\x20status:\x20'+_0x48ec6e[_0x51ec81(0x9d)]+_0x51ec81(0xbe)+_0x3c446b);}let _0x4ec57a;try{_0x4ec57a=JSON[_0x51ec81(0xb1)](_0x3c446b);}catch(_0x1354f7){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0x1354f7),loggerService_1[_0x51ec81(0xa1)][_0x51ec81(0xc9)](_0x51ec81(0xcf),_0x51ec81(0xe3),'JSON\x20Parse\x20Error:\x20'+_0x1354f7);throw new Error('Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20'+_0x3c446b);}console[_0x51ec81(0xd9)]('===\x20PARSED\x20PLISIO\x20RESPONSE\x20==='),console[_0x51ec81(0xd9)]('Parsed\x20Result:',JSON['stringify'](_0x4ec57a,null,0x2)),loggerService_1[_0x51ec81(0xa1)][_0x51ec81(0x99)](_0x51ec81(0xcf),_0x51ec81(0xe3),_0x48ec6e[_0x51ec81(0x9d)],_0x4ec57a,_0x11f10e);if(_0x4ec57a[_0x51ec81(0x9d)]!==_0x51ec81(0xcc)){const _0x2b514d=_0x4ec57a[_0x51ec81(0xf8)]||_0x4ec57a[_0x51ec81(0xde)]||'Unknown\x20error\x20from\x20Plisio\x20API';console[_0x51ec81(0xde)]('===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x51ec81(0xde)]('Error\x20Message:',_0x2b514d),loggerService_1['loggerService'][_0x51ec81(0xc9)]('plisio_direct',_0x51ec81(0xe3),_0x51ec81(0xcb)+_0x2b514d);throw new Error(_0x51ec81(0xe7)+_0x2b514d);}if(!_0x4ec57a[_0x51ec81(0xbf)]?.['txn_id']||!_0x4ec57a[_0x51ec81(0xbf)]?.[_0x51ec81(0xd2)]){console[_0x51ec81(0xde)](_0x51ec81(0xf2)),console[_0x51ec81(0xde)](_0x51ec81(0xa5)),console['error'](_0x51ec81(0xd7),_0x4ec57a[_0x51ec81(0xbf)]),loggerService_1[_0x51ec81(0xa1)][_0x51ec81(0xc9)](_0x51ec81(0xcf),_0x51ec81(0xe3),_0x51ec81(0x92));throw new Error(_0x51ec81(0xa3));}return console[_0x51ec81(0xd9)](_0x51ec81(0xf1)),console[_0x51ec81(0xd9)](_0x51ec81(0xdb),_0x4ec57a[_0x51ec81(0xbf)]['txn_id']),console[_0x51ec81(0xd9)]('Invoice\x20URL:',_0x4ec57a[_0x51ec81(0xbf)][_0x51ec81(0xd2)]),console[_0x51ec81(0xd9)](_0x51ec81(0xcd),_0x3e9103,_0x3cef09),_0x47bff9&&(console[_0x51ec81(0xd9)]('Source\x20Currency:',_0x47bff9,_0x51ec81(0xed)),console[_0x51ec81(0xd9)](_0x51ec81(0xdd),_0x3cef09,_0x51ec81(0xe0))),{'gateway_payment_id':_0x4ec57a[_0x51ec81(0xbf)][_0x51ec81(0xc3)],'payment_url':_0x4ec57a[_0x51ec81(0xbf)][_0x51ec81(0xd2)],'invoice_total_sum':_0x4ec57a[_0x51ec81(0xbf)][_0x51ec81(0xc7)],'qr_code':_0x4ec57a[_0x51ec81(0xbf)]['qr_code'],'qr_url':_0x4ec57a['data']['qr_url']};}catch(_0x59dbfb){console[_0x51ec81(0xde)](_0x51ec81(0xc5)),console[_0x51ec81(0xde)](_0x51ec81(0xab),_0x59dbfb),loggerService_1[_0x51ec81(0xa1)][_0x51ec81(0xc9)](_0x51ec81(0xcf),_0x51ec81(0xe3),_0x59dbfb);if(_0x59dbfb instanceof Error){console[_0x51ec81(0xde)](_0x51ec81(0x96),_0x59dbfb['message']),console[_0x51ec81(0xde)]('Error\x20stack:',_0x59dbfb[_0x51ec81(0xda)]);throw new Error(_0x51ec81(0xb4)+_0x59dbfb[_0x51ec81(0xf8)]);}throw new Error(_0x51ec81(0xb7));}}async[a44_0x28ecc7(0xb8)](_0x4e9c16){const _0x25b1fb=a44_0x28ecc7,_0x106e8d=Date[_0x25b1fb(0xc8)]();try{if(!this[_0x25b1fb(0xec)])throw new Error(_0x25b1fb(0x9f));const _0x515a31=new URLSearchParams({'api_key':this[_0x25b1fb(0xec)],'txn_id':_0x4e9c16}),_0x3b4ccc='https://api.plisio.net/api/v1/operations/'+_0x4e9c16+'?'+_0x515a31['toString']();loggerService_1[_0x25b1fb(0xa1)]['logWhiteDomainRequest'](_0x25b1fb(0xcf),_0x25b1fb(0xe1)+_0x4e9c16,_0x25b1fb(0xa4),Object[_0x25b1fb(0xc6)](_0x515a31[_0x25b1fb(0xf6)]()));const _0x1fc84d=await fetch(_0x3b4ccc,{'method':_0x25b1fb(0xa4),'headers':{'Accept':'application/json','User-Agent':_0x25b1fb(0x9c)}}),_0x54caa1=Date[_0x25b1fb(0xc8)]()-_0x106e8d;if(!_0x1fc84d['ok']){const _0x406095=await _0x1fc84d[_0x25b1fb(0x94)]();loggerService_1[_0x25b1fb(0xa1)][_0x25b1fb(0x99)](_0x25b1fb(0xcf),'/operations/'+_0x4e9c16,_0x1fc84d['status'],_0x406095,_0x54caa1);throw new Error('HTTP\x20error!\x20status:\x20'+_0x1fc84d[_0x25b1fb(0x9d)]);}const _0x40af02=await _0x1fc84d[_0x25b1fb(0xd0)]();loggerService_1[_0x25b1fb(0xa1)][_0x25b1fb(0x99)]('plisio_direct',_0x25b1fb(0xe1)+_0x4e9c16,_0x1fc84d[_0x25b1fb(0x9d)],_0x40af02,_0x54caa1);if(_0x40af02['status']!==_0x25b1fb(0xcc)){loggerService_1[_0x25b1fb(0xa1)]['logWhiteDomainError']('plisio_direct','/operations/'+_0x4e9c16,_0x25b1fb(0xe7)+(_0x40af02[_0x25b1fb(0xf8)]||_0x40af02['error']||_0x25b1fb(0xdf)));throw new Error('Plisio\x20API\x20error:\x20'+(_0x40af02['message']||_0x40af02[_0x25b1fb(0xde)]||_0x25b1fb(0xdf)));}let _0x37bd78=_0x25b1fb(0xc4);return{'status':_0x37bd78};}catch(_0x4f25eb){console['error']('Plisio\x20payment\x20verification\x20error:',_0x4f25eb),loggerService_1[_0x25b1fb(0xa1)][_0x25b1fb(0xc9)](_0x25b1fb(0xcf),_0x25b1fb(0xe1)+_0x4e9c16,_0x4f25eb);throw new Error(_0x25b1fb(0xdc)+(_0x4f25eb instanceof Error?_0x4f25eb['message']:_0x25b1fb(0xdf)));}}async[a44_0x28ecc7(0xe8)](_0x2d35c7){const _0x471d47=a44_0x28ecc7;console[_0x471d47(0xd9)](_0x471d47(0xaa),_0x2d35c7);let _0x11e96d=_0x471d47(0xc4);switch(_0x2d35c7[_0x471d47(0x9d)]?.[_0x471d47(0xad)]()){case _0x471d47(0xb0):case _0x471d47(0xa7):_0x11e96d='PAID';break;case'expired':_0x11e96d='EXPIRED';break;case'error':case _0x471d47(0xae):_0x11e96d=_0x471d47(0xb9);break;case _0x471d47(0xe9):case _0x471d47(0xe2):default:_0x11e96d=_0x471d47(0xc4);break;}let _0x8f1758;if(_0x2d35c7[_0x471d47(0xca)])try{console['log']('üîó\x20Raw\x20tx_urls\x20from\x20Plisio:',_0x2d35c7[_0x471d47(0xca)]);let _0x4f9aaf;if(typeof _0x2d35c7['tx_urls']===_0x471d47(0xba))_0x4f9aaf=JSON[_0x471d47(0xb1)](_0x2d35c7['tx_urls']);else Array['isArray'](_0x2d35c7['tx_urls'])?_0x4f9aaf=_0x2d35c7['tx_urls']:_0x4f9aaf=[];_0x8f1758=_0x4f9aaf[_0x471d47(0xf3)](_0x49130c=>{const _0x53525d=_0x471d47,_0x17e305=_0x49130c['replace'](/\\/g,'');return console[_0x53525d(0xd9)](_0x53525d(0xf5)+_0x49130c+_0x53525d(0xac)+_0x17e305),_0x17e305;}),console['log']('‚úÖ\x20Processed\x20tx_urls:',_0x8f1758),_0x8f1758['forEach']((_0x381291,_0x58e7c7)=>{const _0xb50fbb=_0x471d47;try{new URL(_0x381291),console[_0xb50fbb(0xd9)](_0xb50fbb(0xc1)+(_0x58e7c7+0x1)+_0xb50fbb(0xeb)+_0x381291);}catch(_0x3030ef){console[_0xb50fbb(0xde)](_0xb50fbb(0x90)+(_0x58e7c7+0x1)+'\x20is\x20invalid:\x20'+_0x381291,_0x3030ef);}});}catch(_0x121836){console[_0x471d47(0xde)](_0x471d47(0xb6),_0x121836),console[_0x471d47(0xde)](_0x471d47(0xa0),_0x2d35c7['tx_urls']),_0x8f1758=undefined;}return{'paymentId':_0x2d35c7[_0x471d47(0xee)]||'','status':_0x11e96d,'amount':_0x2d35c7[_0x471d47(0xaf)],'currency':_0x2d35c7[_0x471d47(0xb2)],'txUrls':_0x8f1758};}}exports['PlisioService']=PlisioService;