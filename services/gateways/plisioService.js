'use strict';function a44_0x323f(){const _0x1991ab=['loggerService','üîó\x20Formatted\x20URL:\x20','Response\x20Body:','Error\x20stack:','currency','replace','Invoice\x20URL:','Plisio\x20API\x20error:\x20','FAILED','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','text','message','status','entries','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','mismatch','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','source_amount','json','logWhiteDomainResponse','plisio_direct','‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','24zQRlIi','Error\x20message:','\x20->\x20','forEach','stringify','data','6ZHTCMg','Source\x20Currency:','131670mYrRCC','Processing\x20Plisio\x20webhook:','PENDING','EXPIRED','../loggerService','Response\x20Time:','274292pubfxm','üîó\x20Raw\x20tx_urls\x20from\x20Plisio:','/operations/','807iJxZZb','success','expired','append','PAID','pending','application/json','fromEntries','Status\x20Text:','map','‚úÖ\x20Processed\x20tx_urls:','1579131PnGTIq','Response\x20data:','96306pxQWMS','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','apiKey','590313cXGYOw','amount','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','\x20is\x20valid:\x20','apiUrl','txn_id','Parsed\x20Result:','Error\x20details:','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','HTTP\x20Status:','Unknown\x20error','Plisio\x20API\x20key\x20is\x20not\x20configured','TesSoft\x20Payment\x20System/1.0','Plisio\x20payment\x20verification\x20error:','order_number','toString','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','GET','HTTP\x20','parse','invoice_url','Failed\x20to\x20parse\x20JSON\x20response:','/invoices/new','Raw\x20Response\x20Body:','üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','HTTP\x20error!\x20status:\x20','now','Failed\x20to\x20create\x20Plisio\x20payment:\x20','https://api.plisio.net/api/v1/invoices/new','Transaction\x20ID:','2402BMQCfd','string','logWhiteDomainError','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','log','tx_urls','createPayment','Business\x20Error:\x20','toLowerCase',',\x20body:\x20','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','statusText','source_currency','(fiat\x20for\x20merchant)','URL:','Target\x20Currency:','‚ùå\x20Failed\x20to\x20parse\x20tx_urls:','10LcUzNo','3016480gVeHqr','warn','name','PlisioService','cancelled','isArray','‚úÖ\x20URL\x20','Full\x20URL\x20(without\x20API\x20key):','Status:','logWhiteDomainRequest','error'];a44_0x323f=function(){return _0x1991ab;};return a44_0x323f();}const a44_0x4fb775=a44_0x463b;(function(_0x9e0905,_0xb02b9b){const _0xd27246=a44_0x463b,_0x1a32c4=_0x9e0905();while(!![]){try{const _0x21368a=parseInt(_0xd27246(0xb5))/0x1+parseInt(_0xd27246(0xd3))/0x2*(parseInt(_0xd27246(0x117))/0x3)+parseInt(_0xd27246(0x114))/0x4+parseInt(_0xd27246(0xe5))/0x5*(-parseInt(_0xd27246(0x10c))/0x6)+parseInt(_0xd27246(0x124))/0x7*(-parseInt(_0xd27246(0x106))/0x8)+parseInt(_0xd27246(0x122))/0x9+-parseInt(_0xd27246(0xe4))/0xa*(parseInt(_0xd27246(0x10e))/0xb);if(_0x21368a===_0xb02b9b)break;else _0x1a32c4['push'](_0x1a32c4['shift']());}catch(_0x42ad8b){_0x1a32c4['push'](_0x1a32c4['shift']());}}}(a44_0x323f,0x7a48a));function a44_0x463b(_0x59fee5,_0x533bc8){const _0x323f42=a44_0x323f();return a44_0x463b=function(_0x463b3d,_0x23fa33){_0x463b3d=_0x463b3d-0xb5;let _0x2d1438=_0x323f42[_0x463b3d];return _0x2d1438;},a44_0x463b(_0x59fee5,_0x533bc8);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a44_0x4fb775(0xe8)]=void 0x0;const loggerService_1=require(a44_0x4fb775(0x112));class PlisioService{constructor(){const _0x42eaa7=a44_0x4fb775;this[_0x42eaa7(0xb9)]=_0x42eaa7(0xd1),this['apiKey']=process['env']['PLISIO_API_KEY']||'',!this[_0x42eaa7(0x127)]?console[_0x42eaa7(0xe6)](_0x42eaa7(0x105)):console[_0x42eaa7(0xd7)](_0x42eaa7(0xcd));}async[a44_0x4fb775(0xd9)](_0x2562de){const _0x4fc88a=a44_0x4fb775,{orderId:_0x38b95f,amount:_0x5a16c3,currency:_0x4339cc,productName:_0x4cccc1,description:_0x2c9671,successUrl:_0x42abf9,failUrl:_0x4abaeb,customerEmail:_0x2aa8f5,customerName:_0x261dbf,isSourceCurrency:_0x33d51f,sourceCurrency:_0xd896cb}=_0x2562de;if(!this[_0x4fc88a(0x127)])throw new Error('Plisio\x20API\x20key\x20is\x20not\x20configured');const _0x369997=new URLSearchParams({'api_key':this['apiKey'],'order_number':_0x38b95f,'order_name':_0x4cccc1,'description':_0x2c9671,'success_url':_0x42abf9,'fail_url':_0x4abaeb,'callback_url':'https://api.trapay.uk/api/webhooks/gateway/plisio'});_0xd896cb?(_0x369997['append'](_0x4fc88a(0xf4),_0xd896cb),_0x369997[_0x4fc88a(0x11a)](_0x4fc88a(0xdf),_0x4339cc),_0x369997[_0x4fc88a(0x11a)](_0x4fc88a(0x101),_0x5a16c3['toString']())):(_0x369997[_0x4fc88a(0x11a)](_0x4fc88a(0xf4),_0x4339cc),_0x369997['append'](_0x4fc88a(0xb6),_0x5a16c3[_0x4fc88a(0xc4)]()));_0x2aa8f5&&_0x369997[_0x4fc88a(0x11a)]('email',_0x2aa8f5);_0x261dbf&&_0x369997['append'](_0x4fc88a(0xe7),_0x261dbf);const _0x146e54=this[_0x4fc88a(0xb9)]+'?'+_0x369997[_0x4fc88a(0xc4)](),_0x45d4ae=Date[_0x4fc88a(0xcf)]();try{console[_0x4fc88a(0xd7)]('===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20==='),console[_0x4fc88a(0xd7)](_0x4fc88a(0xe1),this[_0x4fc88a(0xb9)]),console[_0x4fc88a(0xd7)]('Parameters:',Object[_0x4fc88a(0x11e)](_0x369997[_0x4fc88a(0xfd)]())),console[_0x4fc88a(0xd7)](_0x4fc88a(0xec),_0x146e54[_0x4fc88a(0xf5)](this[_0x4fc88a(0x127)],'HIDDEN')),loggerService_1[_0x4fc88a(0xf0)][_0x4fc88a(0xee)](_0x4fc88a(0x104),_0x4fc88a(0xcb),'GET',Object[_0x4fc88a(0x11e)](_0x369997['entries']()));const _0x2a7e82=await fetch(_0x146e54,{'method':_0x4fc88a(0xc6),'headers':{'Accept':_0x4fc88a(0x11d),'User-Agent':_0x4fc88a(0xc1)}}),_0x505743=Date[_0x4fc88a(0xcf)]()-_0x45d4ae;console[_0x4fc88a(0xd7)](_0x4fc88a(0xfe)),console[_0x4fc88a(0xd7)](_0x4fc88a(0xed),_0x2a7e82[_0x4fc88a(0xfc)]),console[_0x4fc88a(0xd7)](_0x4fc88a(0x11f),_0x2a7e82[_0x4fc88a(0xde)]),console[_0x4fc88a(0xd7)](_0x4fc88a(0x113),_0x505743+'ms');const _0x3e2834=await _0x2a7e82['text']();console['log'](_0x4fc88a(0xcc),_0x3e2834);if(!_0x2a7e82['ok']){console[_0x4fc88a(0xef)]('===\x20PLISIO\x20API\x20ERROR\x20==='),console[_0x4fc88a(0xef)](_0x4fc88a(0xbe),_0x2a7e82[_0x4fc88a(0xfc)]),console['error'](_0x4fc88a(0xf2),_0x3e2834),loggerService_1[_0x4fc88a(0xf0)]['logWhiteDomainResponse'](_0x4fc88a(0x104),'/invoices/new',_0x2a7e82[_0x4fc88a(0xfc)],_0x3e2834,_0x505743),loggerService_1[_0x4fc88a(0xf0)][_0x4fc88a(0xd5)](_0x4fc88a(0x104),_0x4fc88a(0xcb),_0x4fc88a(0xc7)+_0x2a7e82[_0x4fc88a(0xfc)]+':\x20'+_0x3e2834);throw new Error(_0x4fc88a(0xce)+_0x2a7e82[_0x4fc88a(0xfc)]+_0x4fc88a(0xdc)+_0x3e2834);}let _0x398816;try{_0x398816=JSON[_0x4fc88a(0xc8)](_0x3e2834);}catch(_0x4b5d4c){console['error'](_0x4fc88a(0xca),_0x4b5d4c),loggerService_1['loggerService']['logWhiteDomainError'](_0x4fc88a(0x104),_0x4fc88a(0xcb),'JSON\x20Parse\x20Error:\x20'+_0x4b5d4c);throw new Error(_0x4fc88a(0xf9)+_0x3e2834);}console['log'](_0x4fc88a(0x126)),console['log'](_0x4fc88a(0xbb),JSON[_0x4fc88a(0x10a)](_0x398816,null,0x2)),loggerService_1['loggerService'][_0x4fc88a(0x103)](_0x4fc88a(0x104),_0x4fc88a(0xcb),_0x2a7e82[_0x4fc88a(0xfc)],_0x398816,_0x505743);if(_0x398816[_0x4fc88a(0xfc)]!==_0x4fc88a(0x118)){const _0xdfd7ab=_0x398816[_0x4fc88a(0xfb)]||_0x398816[_0x4fc88a(0xef)]||'Unknown\x20error\x20from\x20Plisio\x20API';console['error'](_0x4fc88a(0xb7)),console[_0x4fc88a(0xef)]('Error\x20Message:',_0xdfd7ab),loggerService_1[_0x4fc88a(0xf0)]['logWhiteDomainError'](_0x4fc88a(0x104),_0x4fc88a(0xcb),_0x4fc88a(0xda)+_0xdfd7ab);throw new Error('Plisio\x20API\x20error:\x20'+_0xdfd7ab);}if(!_0x398816['data']?.['txn_id']||!_0x398816['data']?.[_0x4fc88a(0xc9)]){console[_0x4fc88a(0xef)](_0x4fc88a(0x100)),console[_0x4fc88a(0xef)](_0x4fc88a(0xc5)),console['error'](_0x4fc88a(0x123),_0x398816[_0x4fc88a(0x10b)]),loggerService_1[_0x4fc88a(0xf0)][_0x4fc88a(0xd5)](_0x4fc88a(0x104),_0x4fc88a(0xcb),_0x4fc88a(0xbd));throw new Error(_0x4fc88a(0xdd));}return console[_0x4fc88a(0xd7)]('===\x20PLISIO\x20SUCCESS\x20==='),console[_0x4fc88a(0xd7)](_0x4fc88a(0xd2),_0x398816[_0x4fc88a(0x10b)][_0x4fc88a(0xba)]),console[_0x4fc88a(0xd7)](_0x4fc88a(0xf6),_0x398816[_0x4fc88a(0x10b)][_0x4fc88a(0xc9)]),console[_0x4fc88a(0xd7)]('Amount:',_0x5a16c3,_0x4339cc),_0xd896cb&&(console['log'](_0x4fc88a(0x10d),_0xd896cb,'(crypto\x20for\x20payment)'),console[_0x4fc88a(0xd7)](_0x4fc88a(0xe2),_0x4339cc,_0x4fc88a(0xe0))),{'gateway_payment_id':_0x398816['data'][_0x4fc88a(0xba)],'payment_url':_0x398816[_0x4fc88a(0x10b)][_0x4fc88a(0xc9)],'invoice_total_sum':_0x398816[_0x4fc88a(0x10b)]['invoice_total_sum'],'qr_code':_0x398816['data']['qr_code'],'qr_url':_0x398816[_0x4fc88a(0x10b)]['qr_url']};}catch(_0x1f4660){console[_0x4fc88a(0xef)](_0x4fc88a(0x125)),console['error'](_0x4fc88a(0xbc),_0x1f4660),loggerService_1['loggerService'][_0x4fc88a(0xd5)]('plisio_direct',_0x4fc88a(0xcb),_0x1f4660);if(_0x1f4660 instanceof Error){console[_0x4fc88a(0xef)](_0x4fc88a(0x107),_0x1f4660[_0x4fc88a(0xfb)]),console[_0x4fc88a(0xef)](_0x4fc88a(0xf3),_0x1f4660['stack']);throw new Error(_0x4fc88a(0xd0)+_0x1f4660[_0x4fc88a(0xfb)]);}throw new Error(_0x4fc88a(0xd6));}}async['verifyPayment'](_0x551164){const _0xe641c1=a44_0x4fb775,_0x4976d3=Date[_0xe641c1(0xcf)]();try{if(!this['apiKey'])throw new Error(_0xe641c1(0xc0));const _0x4f4804=new URLSearchParams({'api_key':this[_0xe641c1(0x127)],'txn_id':_0x551164}),_0x3f7d12='https://api.plisio.net/api/v1/operations/'+_0x551164+'?'+_0x4f4804[_0xe641c1(0xc4)]();loggerService_1[_0xe641c1(0xf0)][_0xe641c1(0xee)](_0xe641c1(0x104),'/operations/'+_0x551164,_0xe641c1(0xc6),Object['fromEntries'](_0x4f4804[_0xe641c1(0xfd)]()));const _0x123e49=await fetch(_0x3f7d12,{'method':'GET','headers':{'Accept':_0xe641c1(0x11d),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x568d3e=Date[_0xe641c1(0xcf)]()-_0x4976d3;if(!_0x123e49['ok']){const _0xddb809=await _0x123e49[_0xe641c1(0xfa)]();loggerService_1[_0xe641c1(0xf0)][_0xe641c1(0x103)]('plisio_direct',_0xe641c1(0x116)+_0x551164,_0x123e49['status'],_0xddb809,_0x568d3e);throw new Error(_0xe641c1(0xce)+_0x123e49[_0xe641c1(0xfc)]);}const _0x4fa92d=await _0x123e49[_0xe641c1(0x102)]();loggerService_1[_0xe641c1(0xf0)][_0xe641c1(0x103)](_0xe641c1(0x104),_0xe641c1(0x116)+_0x551164,_0x123e49[_0xe641c1(0xfc)],_0x4fa92d,_0x568d3e);if(_0x4fa92d[_0xe641c1(0xfc)]!=='success'){loggerService_1[_0xe641c1(0xf0)]['logWhiteDomainError'](_0xe641c1(0x104),_0xe641c1(0x116)+_0x551164,_0xe641c1(0xf7)+(_0x4fa92d[_0xe641c1(0xfb)]||_0x4fa92d['error']||_0xe641c1(0xbf)));throw new Error('Plisio\x20API\x20error:\x20'+(_0x4fa92d[_0xe641c1(0xfb)]||_0x4fa92d[_0xe641c1(0xef)]||_0xe641c1(0xbf)));}let _0x560aa6=_0xe641c1(0x110);return{'status':_0x560aa6};}catch(_0x52756b){console[_0xe641c1(0xef)](_0xe641c1(0xc2),_0x52756b),loggerService_1[_0xe641c1(0xf0)][_0xe641c1(0xd5)]('plisio_direct',_0xe641c1(0x116)+_0x551164,_0x52756b);throw new Error('Failed\x20to\x20verify\x20Plisio\x20payment:\x20'+(_0x52756b instanceof Error?_0x52756b[_0xe641c1(0xfb)]:_0xe641c1(0xbf)));}}async['processWebhook'](_0x38e6ab){const _0x4432a1=a44_0x4fb775;console['log'](_0x4432a1(0x10f),_0x38e6ab);let _0x355a08=_0x4432a1(0x110);switch(_0x38e6ab[_0x4432a1(0xfc)]?.[_0x4432a1(0xdb)]()){case'completed':case _0x4432a1(0xff):_0x355a08=_0x4432a1(0x11b);break;case _0x4432a1(0x119):_0x355a08=_0x4432a1(0x111);break;case _0x4432a1(0xef):case _0x4432a1(0xe9):_0x355a08=_0x4432a1(0xf8);break;case'new':case _0x4432a1(0x11c):default:_0x355a08='PENDING';break;}let _0x561dfd;if(_0x38e6ab[_0x4432a1(0xd8)])try{console[_0x4432a1(0xd7)](_0x4432a1(0x115),_0x38e6ab[_0x4432a1(0xd8)]);let _0x308e10;if(typeof _0x38e6ab['tx_urls']===_0x4432a1(0xd4))_0x308e10=JSON['parse'](_0x38e6ab['tx_urls']);else Array[_0x4432a1(0xea)](_0x38e6ab['tx_urls'])?_0x308e10=_0x38e6ab[_0x4432a1(0xd8)]:_0x308e10=[];_0x561dfd=_0x308e10[_0x4432a1(0x120)](_0x4eb77b=>{const _0x523500=_0x4432a1,_0x3f0980=_0x4eb77b['replace'](/\\/g,'');return console['log'](_0x523500(0xf1)+_0x4eb77b+_0x523500(0x108)+_0x3f0980),_0x3f0980;}),console[_0x4432a1(0xd7)](_0x4432a1(0x121),_0x561dfd),_0x561dfd[_0x4432a1(0x109)]((_0x30c92f,_0xee2641)=>{const _0x281096=_0x4432a1;try{new URL(_0x30c92f),console[_0x281096(0xd7)](_0x281096(0xeb)+(_0xee2641+0x1)+_0x281096(0xb8)+_0x30c92f);}catch(_0x34c452){console[_0x281096(0xef)]('‚ùå\x20URL\x20'+(_0xee2641+0x1)+'\x20is\x20invalid:\x20'+_0x30c92f,_0x34c452);}});}catch(_0x8e0f06){console['error'](_0x4432a1(0xe3),_0x8e0f06),console[_0x4432a1(0xef)]('Raw\x20tx_urls\x20data:',_0x38e6ab['tx_urls']),_0x561dfd=undefined;}return{'paymentId':_0x38e6ab[_0x4432a1(0xc3)]||'','status':_0x355a08,'amount':_0x38e6ab[_0x4432a1(0xb6)],'currency':_0x38e6ab[_0x4432a1(0xf4)],'txUrls':_0x561dfd};}}exports['PlisioService']=PlisioService;