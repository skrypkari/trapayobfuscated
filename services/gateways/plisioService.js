'use strict';const a51_0x2ed3dd=a51_0xa49c;function a51_0xa49c(_0x751453,_0x263233){const _0x1d1a7f=a51_0x1d1a();return a51_0xa49c=function(_0xa49cb8,_0x4d510c){_0xa49cb8=_0xa49cb8-0xe6;let _0x46a110=_0x1d1a7f[_0xa49cb8];return _0x46a110;},a51_0xa49c(_0x751453,_0x263233);}(function(_0x31d3b0,_0x3ed1ab){const _0x10ae7c=a51_0xa49c,_0x51b673=_0x31d3b0();while(!![]){try{const _0x322a06=parseInt(_0x10ae7c(0x122))/0x1*(parseInt(_0x10ae7c(0x124))/0x2)+-parseInt(_0x10ae7c(0x13e))/0x3*(parseInt(_0x10ae7c(0x140))/0x4)+-parseInt(_0x10ae7c(0x163))/0x5*(parseInt(_0x10ae7c(0xfa))/0x6)+-parseInt(_0x10ae7c(0xf4))/0x7*(-parseInt(_0x10ae7c(0x13c))/0x8)+-parseInt(_0x10ae7c(0x125))/0x9*(parseInt(_0x10ae7c(0xe9))/0xa)+-parseInt(_0x10ae7c(0x103))/0xb+parseInt(_0x10ae7c(0x136))/0xc;if(_0x322a06===_0x3ed1ab)break;else _0x51b673['push'](_0x51b673['shift']());}catch(_0x2b3e4f){_0x51b673['push'](_0x51b673['shift']());}}}(a51_0x1d1a,0x90904));function a51_0x1d1a(){const _0x3c1810=['order_number','===\x20PLISIO\x20API\x20ERROR\x20===','logWhiteDomainRequest','PLISIO_API_KEY','469qbeGfh','Unknown\x20error\x20from\x20Plisio\x20API','PROCESSING','fromEntries','❌\x20URL\x20','❌\x20Failed\x20to\x20parse\x20tx_urls:','102npGyut','statusText','Raw\x20Response\x20Body:','✅\x20Processed\x20tx_urls:','loggerService','Response\x20data:','entries','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','now','5342480nCtMjx','cancelled','isArray','stack','HIDDEN','HTTP\x20Status:','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','replace','Parsed\x20Result:','\x20is\x20valid:\x20','invoice_url','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','qr_url','Error\x20message:','💰\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','data','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','txn_id','currency','https://api.plisio.net/api/v1/operations/','Processing\x20Plisio\x20webhook:','Raw\x20tx_urls\x20data:','Full\x20URL\x20(without\x20API\x20key):','log','Response\x20Time:','===\x20PLISIO\x20SUCCESS\x20===','toLowerCase','status','email','URL:','message','7OjBgmD','Plisio\x20API\x20key\x20is\x20not\x20configured','317862WKZBKB','9eYDyTC','FAILED','Amount:','⚠️\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','processWebhook','append','HTTP\x20error!\x20status:\x20','(crypto\x20for\x20payment)','error','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','Status\x20Text:','tx_urls','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','Source\x20Currency:','application/json','✅\x20URL\x20','qr_code','19148724TdxiWC','(fiat\x20for\x20merchant)','text','logWhiteDomainResponse','Unknown\x20error','Business\x20Error:\x20','10680OXHfXm','Plisio\x20API\x20error:\x20','6FcFFpA','\x20->\x20','1333196sHkhLO','Error\x20stack:','https://api.plisio.net/api/v1/invoices/new','Invoice\x20URL:','toString','/invoices/new','🔗\x20Formatted\x20URL:\x20','amount','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','new','pending','Error\x20details:','\x20is\x20invalid:\x20','PlisioService','PENDING','Parameters:','/operations/','PAID','Transaction\x20ID:','logWhiteDomainError','GET','__esModule','source_currency','invoice_total_sum','env','name','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','Plisio\x20payment\x20verification\x20error:','mismatch','map','plisio_direct','Target\x20Currency:','createPayment','parse','success','76690ZVwbfe','apiKey','apiUrl',',\x20body:\x20','7925330MYYnXV','Failed\x20to\x20create\x20Plisio\x20payment:\x20','Response\x20Body:','https://api.trapay.uk/api/webhooks/gateway/plisio','completed','string','Error\x20Message:'];a51_0x1d1a=function(){return _0x3c1810;};return a51_0x1d1a();}Object['defineProperty'](exports,a51_0x2ed3dd(0x155),{'value':!![]}),exports[a51_0x2ed3dd(0x14d)]=void 0x0;const loggerService_1=require('../loggerService');class PlisioService{constructor(){const _0x4854fb=a51_0x2ed3dd;this[_0x4854fb(0xe7)]=_0x4854fb(0x142),this[_0x4854fb(0xe6)]=process[_0x4854fb(0x158)][_0x4854fb(0xf3)]||'',!this[_0x4854fb(0xe6)]?console['warn'](_0x4854fb(0x128)):console['log'](_0x4854fb(0x111));}async[a51_0x2ed3dd(0x160)](_0x2c2494){const _0x297ba2=a51_0x2ed3dd,{orderId:_0x1b24a5,amount:_0x58e692,currency:_0xbfc8a8,productName:_0x34ccbd,description:_0x4b36e9,successUrl:_0x698d32,failUrl:_0x5bd452,customerEmail:_0xd19236,customerName:_0x5cf80e,isSourceCurrency:_0x4648bc,sourceCurrency:_0x4e1d5e}=_0x2c2494;if(!this[_0x297ba2(0xe6)])throw new Error('Plisio\x20API\x20key\x20is\x20not\x20configured');const _0x50a05e=new URLSearchParams({'api_key':this[_0x297ba2(0xe6)],'order_number':_0x1b24a5,'order_name':_0x34ccbd,'description':_0x4b36e9,'success_url':_0x698d32,'fail_url':_0x5bd452,'callback_url':_0x297ba2(0xec)});_0x4e1d5e?(_0x50a05e['append']('currency',_0x4e1d5e),_0x50a05e[_0x297ba2(0x12a)](_0x297ba2(0x156),_0xbfc8a8),_0x50a05e[_0x297ba2(0x12a)]('source_amount',_0x58e692[_0x297ba2(0x144)]())):(_0x50a05e[_0x297ba2(0x12a)](_0x297ba2(0x115),_0xbfc8a8),_0x50a05e[_0x297ba2(0x12a)](_0x297ba2(0x147),_0x58e692[_0x297ba2(0x144)]()));_0xd19236&&_0x50a05e[_0x297ba2(0x12a)](_0x297ba2(0x11f),_0xd19236);_0x5cf80e&&_0x50a05e[_0x297ba2(0x12a)](_0x297ba2(0x159),_0x5cf80e);const _0x2e1fc7=this[_0x297ba2(0xe7)]+'?'+_0x50a05e[_0x297ba2(0x144)](),_0x417cce=Date[_0x297ba2(0x102)]();try{console['log'](_0x297ba2(0x148)),console[_0x297ba2(0x11a)](_0x297ba2(0x120),this[_0x297ba2(0xe7)]),console[_0x297ba2(0x11a)](_0x297ba2(0x14f),Object['fromEntries'](_0x50a05e[_0x297ba2(0x100)]())),console[_0x297ba2(0x11a)](_0x297ba2(0x119),_0x2e1fc7[_0x297ba2(0x10a)](this['apiKey'],_0x297ba2(0x107))),loggerService_1[_0x297ba2(0xfe)]['logWhiteDomainRequest'](_0x297ba2(0x15e),'/invoices/new','GET',Object['fromEntries'](_0x50a05e[_0x297ba2(0x100)]()));const _0xad1ce7=await fetch(_0x2e1fc7,{'method':'GET','headers':{'Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x5262ce=Date[_0x297ba2(0x102)]()-_0x417cce;console['log']('===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20==='),console['log']('Status:',_0xad1ce7[_0x297ba2(0x11e)]),console[_0x297ba2(0x11a)](_0x297ba2(0x12f),_0xad1ce7[_0x297ba2(0xfb)]),console[_0x297ba2(0x11a)](_0x297ba2(0x11b),_0x5262ce+'ms');const _0x205f7f=await _0xad1ce7[_0x297ba2(0x138)]();console[_0x297ba2(0x11a)](_0x297ba2(0xfc),_0x205f7f);if(!_0xad1ce7['ok']){console[_0x297ba2(0x12d)](_0x297ba2(0xf1)),console[_0x297ba2(0x12d)](_0x297ba2(0x108),_0xad1ce7[_0x297ba2(0x11e)]),console[_0x297ba2(0x12d)](_0x297ba2(0xeb),_0x205f7f),loggerService_1[_0x297ba2(0xfe)][_0x297ba2(0x139)](_0x297ba2(0x15e),'/invoices/new',_0xad1ce7[_0x297ba2(0x11e)],_0x205f7f,_0x5262ce),loggerService_1['loggerService'][_0x297ba2(0x153)]('plisio_direct',_0x297ba2(0x145),'HTTP\x20'+_0xad1ce7[_0x297ba2(0x11e)]+':\x20'+_0x205f7f);throw new Error(_0x297ba2(0x12b)+_0xad1ce7['status']+_0x297ba2(0xe8)+_0x205f7f);}let _0x3a89b4;try{_0x3a89b4=JSON[_0x297ba2(0x161)](_0x205f7f);}catch(_0x28f6a8){console[_0x297ba2(0x12d)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x28f6a8),loggerService_1[_0x297ba2(0xfe)]['logWhiteDomainError']('plisio_direct',_0x297ba2(0x145),'JSON\x20Parse\x20Error:\x20'+_0x28f6a8);throw new Error(_0x297ba2(0x15a)+_0x205f7f);}console[_0x297ba2(0x11a)]('===\x20PARSED\x20PLISIO\x20RESPONSE\x20==='),console[_0x297ba2(0x11a)](_0x297ba2(0x10b),JSON['stringify'](_0x3a89b4,null,0x2)),loggerService_1[_0x297ba2(0xfe)][_0x297ba2(0x139)](_0x297ba2(0x15e),_0x297ba2(0x145),_0xad1ce7['status'],_0x3a89b4,_0x5262ce);if(_0x3a89b4[_0x297ba2(0x11e)]!=='success'){const _0x255930=_0x3a89b4[_0x297ba2(0x121)]||_0x3a89b4[_0x297ba2(0x12d)]||_0x297ba2(0xf5);console[_0x297ba2(0x12d)](_0x297ba2(0x109)),console[_0x297ba2(0x12d)](_0x297ba2(0xef),_0x255930),loggerService_1[_0x297ba2(0xfe)][_0x297ba2(0x153)](_0x297ba2(0x15e),_0x297ba2(0x145),_0x297ba2(0x13b)+_0x255930);throw new Error(_0x297ba2(0x13d)+_0x255930);}if(!_0x3a89b4[_0x297ba2(0x112)]?.[_0x297ba2(0x114)]||!_0x3a89b4[_0x297ba2(0x112)]?.[_0x297ba2(0x10d)]){console[_0x297ba2(0x12d)](_0x297ba2(0x113)),console[_0x297ba2(0x12d)](_0x297ba2(0x10e)),console['error'](_0x297ba2(0xff),_0x3a89b4['data']),loggerService_1[_0x297ba2(0xfe)][_0x297ba2(0x153)](_0x297ba2(0x15e),_0x297ba2(0x145),'Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url');throw new Error(_0x297ba2(0x101));}return console[_0x297ba2(0x11a)](_0x297ba2(0x11c)),console[_0x297ba2(0x11a)](_0x297ba2(0x152),_0x3a89b4[_0x297ba2(0x112)]['txn_id']),console[_0x297ba2(0x11a)](_0x297ba2(0x143),_0x3a89b4['data'][_0x297ba2(0x10d)]),console[_0x297ba2(0x11a)](_0x297ba2(0x127),_0x58e692,_0xbfc8a8),_0x4e1d5e&&(console[_0x297ba2(0x11a)](_0x297ba2(0x132),_0x4e1d5e,_0x297ba2(0x12c)),console['log'](_0x297ba2(0x15f),_0xbfc8a8,_0x297ba2(0x137))),{'gateway_payment_id':_0x3a89b4['data'][_0x297ba2(0x114)],'payment_url':_0x3a89b4['data'][_0x297ba2(0x10d)],'invoice_total_sum':_0x3a89b4['data'][_0x297ba2(0x157)],'qr_code':_0x3a89b4[_0x297ba2(0x112)][_0x297ba2(0x135)],'qr_url':_0x3a89b4[_0x297ba2(0x112)][_0x297ba2(0x10f)]};}catch(_0x4a5575){console['error']('===\x20PLISIO\x20SERVICE\x20ERROR\x20==='),console[_0x297ba2(0x12d)](_0x297ba2(0x14b),_0x4a5575),loggerService_1[_0x297ba2(0xfe)][_0x297ba2(0x153)]('plisio_direct','/invoices/new',_0x4a5575);if(_0x4a5575 instanceof Error){console[_0x297ba2(0x12d)](_0x297ba2(0x110),_0x4a5575[_0x297ba2(0x121)]),console[_0x297ba2(0x12d)](_0x297ba2(0x141),_0x4a5575[_0x297ba2(0x106)]);throw new Error(_0x297ba2(0xea)+_0x4a5575[_0x297ba2(0x121)]);}throw new Error(_0x297ba2(0x131));}}async['verifyPayment'](_0x23fdb6){const _0x4a21fe=a51_0x2ed3dd,_0x3b37f7=Date['now']();try{if(!this[_0x4a21fe(0xe6)])throw new Error(_0x4a21fe(0x123));const _0x3829f4=new URLSearchParams({'api_key':this[_0x4a21fe(0xe6)],'txn_id':_0x23fdb6}),_0x2442aa=_0x4a21fe(0x116)+_0x23fdb6+'?'+_0x3829f4[_0x4a21fe(0x144)]();loggerService_1[_0x4a21fe(0xfe)][_0x4a21fe(0xf2)](_0x4a21fe(0x15e),_0x4a21fe(0x150)+_0x23fdb6,'GET',Object[_0x4a21fe(0xf7)](_0x3829f4[_0x4a21fe(0x100)]()));const _0x3df072=await fetch(_0x2442aa,{'method':_0x4a21fe(0x154),'headers':{'Accept':_0x4a21fe(0x133),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x1f3ddd=Date[_0x4a21fe(0x102)]()-_0x3b37f7;if(!_0x3df072['ok']){const _0x39d802=await _0x3df072[_0x4a21fe(0x138)]();loggerService_1[_0x4a21fe(0xfe)][_0x4a21fe(0x139)](_0x4a21fe(0x15e),_0x4a21fe(0x150)+_0x23fdb6,_0x3df072[_0x4a21fe(0x11e)],_0x39d802,_0x1f3ddd);throw new Error('HTTP\x20error!\x20status:\x20'+_0x3df072['status']);}const _0x1ae1cb=await _0x3df072['json']();loggerService_1[_0x4a21fe(0xfe)][_0x4a21fe(0x139)](_0x4a21fe(0x15e),'/operations/'+_0x23fdb6,_0x3df072['status'],_0x1ae1cb,_0x1f3ddd);if(_0x1ae1cb['status']!==_0x4a21fe(0x162)){loggerService_1[_0x4a21fe(0xfe)][_0x4a21fe(0x153)](_0x4a21fe(0x15e),_0x4a21fe(0x150)+_0x23fdb6,_0x4a21fe(0x13d)+(_0x1ae1cb[_0x4a21fe(0x121)]||_0x1ae1cb[_0x4a21fe(0x12d)]||_0x4a21fe(0x13a)));throw new Error('Plisio\x20API\x20error:\x20'+(_0x1ae1cb[_0x4a21fe(0x121)]||_0x1ae1cb[_0x4a21fe(0x12d)]||_0x4a21fe(0x13a)));}let _0x99e03f='PENDING';return{'status':_0x99e03f};}catch(_0x2a20c4){console[_0x4a21fe(0x12d)](_0x4a21fe(0x15b),_0x2a20c4),loggerService_1[_0x4a21fe(0xfe)][_0x4a21fe(0x153)]('plisio_direct',_0x4a21fe(0x150)+_0x23fdb6,_0x2a20c4);throw new Error(_0x4a21fe(0x12e)+(_0x2a20c4 instanceof Error?_0x2a20c4[_0x4a21fe(0x121)]:'Unknown\x20error'));}}async[a51_0x2ed3dd(0x129)](_0x30a134){const _0x2eee58=a51_0x2ed3dd;console[_0x2eee58(0x11a)](_0x2eee58(0x117),_0x30a134);let _0x2aeb40='PENDING';switch(_0x30a134['status']?.[_0x2eee58(0x11d)]()){case _0x2eee58(0xed):case _0x2eee58(0x15c):_0x2aeb40=_0x2eee58(0x151);break;case'expired':_0x2aeb40='EXPIRED';break;case _0x2eee58(0x12d):case _0x2eee58(0x104):_0x2aeb40=_0x2eee58(0x126);break;case _0x2eee58(0x149):_0x2aeb40=_0x2eee58(0x14e);break;case _0x2eee58(0x14a):_0x2aeb40=_0x2eee58(0xf6);break;default:_0x2aeb40=_0x2eee58(0x14e);break;}let _0x3dc668;if(_0x30a134[_0x2eee58(0x130)])try{console[_0x2eee58(0x11a)]('🔗\x20Raw\x20tx_urls\x20from\x20Plisio:',_0x30a134[_0x2eee58(0x130)]);let _0x81ce19;if(typeof _0x30a134['tx_urls']===_0x2eee58(0xee))_0x81ce19=JSON[_0x2eee58(0x161)](_0x30a134[_0x2eee58(0x130)]);else Array[_0x2eee58(0x105)](_0x30a134[_0x2eee58(0x130)])?_0x81ce19=_0x30a134['tx_urls']:_0x81ce19=[];_0x3dc668=_0x81ce19[_0x2eee58(0x15d)](_0x2f30b7=>{const _0x40d4d6=_0x2eee58,_0x486502=_0x2f30b7['replace'](/\\/g,'');return console['log'](_0x40d4d6(0x146)+_0x2f30b7+_0x40d4d6(0x13f)+_0x486502),_0x486502;}),console[_0x2eee58(0x11a)](_0x2eee58(0xfd),_0x3dc668),_0x3dc668['forEach']((_0x14bdb6,_0x3ca3f3)=>{const _0xa320cb=_0x2eee58;try{new URL(_0x14bdb6),console[_0xa320cb(0x11a)](_0xa320cb(0x134)+(_0x3ca3f3+0x1)+_0xa320cb(0x10c)+_0x14bdb6);}catch(_0x1db636){console['error'](_0xa320cb(0xf8)+(_0x3ca3f3+0x1)+_0xa320cb(0x14c)+_0x14bdb6,_0x1db636);}});}catch(_0x580e49){console[_0x2eee58(0x12d)](_0x2eee58(0xf9),_0x580e49),console[_0x2eee58(0x12d)](_0x2eee58(0x118),_0x30a134[_0x2eee58(0x130)]),_0x3dc668=undefined;}return{'paymentId':_0x30a134[_0x2eee58(0xf0)]||'','status':_0x2aeb40,'amount':_0x30a134['amount'],'currency':_0x30a134[_0x2eee58(0x115)],'txUrls':_0x3dc668};}}exports['PlisioService']=PlisioService;