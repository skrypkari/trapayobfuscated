'use strict';const a44_0xcefe01=a44_0x4e74;function a44_0x4e74(_0x4b2942,_0x381dbc){const _0x19648d=a44_0x1964();return a44_0x4e74=function(_0x4e74c7,_0x4a48e9){_0x4e74c7=_0x4e74c7-0xdf;let _0x3ba3f0=_0x19648d[_0x4e74c7];return _0x3ba3f0;},a44_0x4e74(_0x4b2942,_0x381dbc);}(function(_0x3c2558,_0x51969a){const _0x233b8d=a44_0x4e74,_0x461803=_0x3c2558();while(!![]){try{const _0x4f986a=-parseInt(_0x233b8d(0x12a))/0x1+parseInt(_0x233b8d(0x114))/0x2+parseInt(_0x233b8d(0x13c))/0x3+parseInt(_0x233b8d(0x120))/0x4*(-parseInt(_0x233b8d(0x134))/0x5)+parseInt(_0x233b8d(0x110))/0x6*(-parseInt(_0x233b8d(0x136))/0x7)+parseInt(_0x233b8d(0x10c))/0x8*(-parseInt(_0x233b8d(0x101))/0x9)+parseInt(_0x233b8d(0x12c))/0xa;if(_0x4f986a===_0x51969a)break;else _0x461803['push'](_0x461803['shift']());}catch(_0x38ce8f){_0x461803['push'](_0x461803['shift']());}}}(a44_0x1964,0x27967));Object[a44_0xcefe01(0xea)](exports,a44_0xcefe01(0xe4),{'value':!![]}),exports[a44_0xcefe01(0x13a)]=void 0x0;function a44_0x1964(){const _0x37396a=['expired','URL:','Unknown\x20error\x20from\x20Plisio\x20API','entries','error','Failed\x20to\x20parse\x20JSON\x20response:','plisio_direct','currency','‚úÖ\x20Processed\x20tx_urls:','Plisio\x20API\x20error:\x20','TesSoft\x20Payment\x20System/1.0','\x20->\x20','Error\x20details:','PAID','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','Invoice\x20URL:','text','__esModule','https://api.trapay.uk/api/webhooks/gateway/plisio','append','verifyPayment','===\x20PLISIO\x20API\x20ERROR\x20===','fromEntries','defineProperty','replace','‚ùå\x20Failed\x20to\x20parse\x20tx_urls:','log','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','HTTP\x20Status:','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','üîó\x20Formatted\x20URL:\x20','isArray','source_amount','stringify','email','‚ùå\x20URL\x20','loggerService','Status:','source_currency','parse','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','Plisio\x20API\x20key\x20is\x20not\x20configured','Raw\x20tx_urls\x20data:','message','(fiat\x20for\x20merchant)','===\x20PLISIO\x20SUCCESS\x20===','1257489Jhbxpn','forEach','Processing\x20Plisio\x20webhook:','logWhiteDomainResponse','Source\x20Currency:','invoice_url','PENDING','Response\x20Body:','toLowerCase','data','Transaction\x20ID:','8BWoOtx','Error\x20stack:','pending','üîó\x20Raw\x20tx_urls\x20from\x20Plisio:','1611786ZjXIAj','https://api.plisio.net/api/v1/invoices/new','createPayment','JSON\x20Parse\x20Error:\x20','337680FpPWjM','order_number','GET','Plisio\x20payment\x20verification\x20error:','completed','map','now','statusText','env','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','success','apiUrl','4AELmGA','EXPIRED','‚úÖ\x20URL\x20','mismatch','HIDDEN','tx_urls','Parsed\x20Result:','qr_url','HTTP\x20error!\x20status:\x20','PROCESSING','248658IwKJNw','logWhiteDomainRequest','7411870Roaell','string','HTTP\x20','cancelled','Unknown\x20error','Error\x20Message:','Error\x20message:','amount','548425HzjIVX','application/json','7fYzScF','Amount:','apiKey','qr_code','PlisioService',',\x20body:\x20','56457pFhpZj','toString','/operations/','logWhiteDomainError','status','processWebhook','/invoices/new','stack','Raw\x20Response\x20Body:','Failed\x20to\x20create\x20Plisio\x20payment:\x20'];a44_0x1964=function(){return _0x37396a;};return a44_0x1964();}const loggerService_1=require('../loggerService');class PlisioService{constructor(){const _0x322cfc=a44_0xcefe01;this[_0x322cfc(0x11f)]=_0x322cfc(0x111),this[_0x322cfc(0x138)]=process[_0x322cfc(0x11c)]['PLISIO_API_KEY']||'',!this['apiKey']?console['warn']('‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables'):console[_0x322cfc(0xed)]('üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API');}async[a44_0xcefe01(0x112)](_0x4c95df){const _0x3f4f7d=a44_0xcefe01,{orderId:_0x4bd46f,amount:_0x5b0f2c,currency:_0x471ccf,productName:_0x4c2d8f,description:_0x56da89,successUrl:_0x4413cd,failUrl:_0x136f43,customerEmail:_0x2c0c89,customerName:_0x448752,isSourceCurrency:_0x3bd983,sourceCurrency:_0x292e29}=_0x4c95df;if(!this[_0x3f4f7d(0x138)])throw new Error(_0x3f4f7d(0xfc));const _0x28f918=new URLSearchParams({'api_key':this[_0x3f4f7d(0x138)],'order_number':_0x4bd46f,'order_name':_0x4c2d8f,'description':_0x56da89,'success_url':_0x4413cd,'fail_url':_0x136f43,'callback_url':_0x3f4f7d(0xe5)});_0x292e29?(_0x28f918[_0x3f4f7d(0xe6)](_0x3f4f7d(0x14d),_0x292e29),_0x28f918['append'](_0x3f4f7d(0xf9),_0x471ccf),_0x28f918[_0x3f4f7d(0xe6)](_0x3f4f7d(0xf3),_0x5b0f2c[_0x3f4f7d(0x13d)]())):(_0x28f918[_0x3f4f7d(0xe6)](_0x3f4f7d(0x14d),_0x471ccf),_0x28f918['append']('amount',_0x5b0f2c[_0x3f4f7d(0x13d)]()));_0x2c0c89&&_0x28f918[_0x3f4f7d(0xe6)](_0x3f4f7d(0xf5),_0x2c0c89);_0x448752&&_0x28f918[_0x3f4f7d(0xe6)]('name',_0x448752);const _0x15d83f=this[_0x3f4f7d(0x11f)]+'?'+_0x28f918[_0x3f4f7d(0x13d)](),_0x158f03=Date['now']();try{console['log']('===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20==='),console['log'](_0x3f4f7d(0x147),this['apiUrl']),console[_0x3f4f7d(0xed)]('Parameters:',Object[_0x3f4f7d(0xe9)](_0x28f918['entries']())),console['log']('Full\x20URL\x20(without\x20API\x20key):',_0x15d83f[_0x3f4f7d(0xeb)](this[_0x3f4f7d(0x138)],_0x3f4f7d(0x124))),loggerService_1[_0x3f4f7d(0xf7)][_0x3f4f7d(0x12b)](_0x3f4f7d(0x14c),_0x3f4f7d(0x142),_0x3f4f7d(0x116),Object[_0x3f4f7d(0xe9)](_0x28f918[_0x3f4f7d(0x149)]()));const _0x56efb5=await fetch(_0x15d83f,{'method':_0x3f4f7d(0x116),'headers':{'Accept':_0x3f4f7d(0x135),'User-Agent':_0x3f4f7d(0x150)}}),_0x4cf0b0=Date[_0x3f4f7d(0x11a)]()-_0x158f03;console['log'](_0x3f4f7d(0x11d)),console[_0x3f4f7d(0xed)](_0x3f4f7d(0xf8),_0x56efb5[_0x3f4f7d(0x140)]),console['log']('Status\x20Text:',_0x56efb5[_0x3f4f7d(0x11b)]),console[_0x3f4f7d(0xed)]('Response\x20Time:',_0x4cf0b0+'ms');const _0x4701e1=await _0x56efb5[_0x3f4f7d(0xe3)]();console[_0x3f4f7d(0xed)](_0x3f4f7d(0x144),_0x4701e1);if(!_0x56efb5['ok']){console[_0x3f4f7d(0x14a)](_0x3f4f7d(0xe8)),console['error'](_0x3f4f7d(0xef),_0x56efb5[_0x3f4f7d(0x140)]),console[_0x3f4f7d(0x14a)](_0x3f4f7d(0x108),_0x4701e1),loggerService_1[_0x3f4f7d(0xf7)][_0x3f4f7d(0x104)]('plisio_direct',_0x3f4f7d(0x142),_0x56efb5[_0x3f4f7d(0x140)],_0x4701e1,_0x4cf0b0),loggerService_1['loggerService'][_0x3f4f7d(0x13f)](_0x3f4f7d(0x14c),_0x3f4f7d(0x142),_0x3f4f7d(0x12e)+_0x56efb5['status']+':\x20'+_0x4701e1);throw new Error('HTTP\x20error!\x20status:\x20'+_0x56efb5[_0x3f4f7d(0x140)]+_0x3f4f7d(0x13b)+_0x4701e1);}let _0x4d953a;try{_0x4d953a=JSON[_0x3f4f7d(0xfa)](_0x4701e1);}catch(_0xb47cfe){console['error'](_0x3f4f7d(0x14b),_0xb47cfe),loggerService_1['loggerService'][_0x3f4f7d(0x13f)]('plisio_direct','/invoices/new',_0x3f4f7d(0x113)+_0xb47cfe);throw new Error('Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20'+_0x4701e1);}console[_0x3f4f7d(0xed)]('===\x20PARSED\x20PLISIO\x20RESPONSE\x20==='),console[_0x3f4f7d(0xed)](_0x3f4f7d(0x126),JSON[_0x3f4f7d(0xf4)](_0x4d953a,null,0x2)),loggerService_1[_0x3f4f7d(0xf7)]['logWhiteDomainResponse'](_0x3f4f7d(0x14c),_0x3f4f7d(0x142),_0x56efb5[_0x3f4f7d(0x140)],_0x4d953a,_0x4cf0b0);if(_0x4d953a[_0x3f4f7d(0x140)]!==_0x3f4f7d(0x11e)){const _0x254eb8=_0x4d953a['message']||_0x4d953a[_0x3f4f7d(0x14a)]||_0x3f4f7d(0x148);console[_0x3f4f7d(0x14a)](_0x3f4f7d(0xe1)),console[_0x3f4f7d(0x14a)](_0x3f4f7d(0x131),_0x254eb8),loggerService_1[_0x3f4f7d(0xf7)][_0x3f4f7d(0x13f)](_0x3f4f7d(0x14c),'/invoices/new','Business\x20Error:\x20'+_0x254eb8);throw new Error('Plisio\x20API\x20error:\x20'+_0x254eb8);}if(!_0x4d953a['data']?.['txn_id']||!_0x4d953a['data']?.[_0x3f4f7d(0x106)]){console['error']('===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console['error']('Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response'),console[_0x3f4f7d(0x14a)]('Response\x20data:',_0x4d953a['data']),loggerService_1['loggerService'][_0x3f4f7d(0x13f)](_0x3f4f7d(0x14c),'/invoices/new','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url');throw new Error(_0x3f4f7d(0xf0));}return console[_0x3f4f7d(0xed)](_0x3f4f7d(0x100)),console['log'](_0x3f4f7d(0x10b),_0x4d953a[_0x3f4f7d(0x10a)]['txn_id']),console[_0x3f4f7d(0xed)](_0x3f4f7d(0xe2),_0x4d953a[_0x3f4f7d(0x10a)][_0x3f4f7d(0x106)]),console['log'](_0x3f4f7d(0x137),_0x5b0f2c,_0x471ccf),_0x292e29&&(console[_0x3f4f7d(0xed)](_0x3f4f7d(0x105),_0x292e29,'(crypto\x20for\x20payment)'),console[_0x3f4f7d(0xed)]('Target\x20Currency:',_0x471ccf,_0x3f4f7d(0xff))),{'gateway_payment_id':_0x4d953a[_0x3f4f7d(0x10a)]['txn_id'],'payment_url':_0x4d953a['data'][_0x3f4f7d(0x106)],'invoice_total_sum':_0x4d953a['data']['invoice_total_sum'],'qr_code':_0x4d953a['data'][_0x3f4f7d(0x139)],'qr_url':_0x4d953a['data'][_0x3f4f7d(0x127)]};}catch(_0x1cf179){console['error'](_0x3f4f7d(0xee)),console[_0x3f4f7d(0x14a)](_0x3f4f7d(0xdf),_0x1cf179),loggerService_1[_0x3f4f7d(0xf7)][_0x3f4f7d(0x13f)](_0x3f4f7d(0x14c),'/invoices/new',_0x1cf179);if(_0x1cf179 instanceof Error){console['error'](_0x3f4f7d(0x132),_0x1cf179['message']),console[_0x3f4f7d(0x14a)](_0x3f4f7d(0x10d),_0x1cf179[_0x3f4f7d(0x143)]);throw new Error(_0x3f4f7d(0x145)+_0x1cf179[_0x3f4f7d(0xfe)]);}throw new Error('Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error');}}async[a44_0xcefe01(0xe7)](_0x9fc577){const _0x55afc6=a44_0xcefe01,_0x41f441=Date[_0x55afc6(0x11a)]();try{if(!this['apiKey'])throw new Error(_0x55afc6(0xfc));const _0x31c918=new URLSearchParams({'api_key':this[_0x55afc6(0x138)],'txn_id':_0x9fc577}),_0x1f5609='https://api.plisio.net/api/v1/operations/'+_0x9fc577+'?'+_0x31c918['toString']();loggerService_1[_0x55afc6(0xf7)]['logWhiteDomainRequest'](_0x55afc6(0x14c),_0x55afc6(0x13e)+_0x9fc577,_0x55afc6(0x116),Object[_0x55afc6(0xe9)](_0x31c918[_0x55afc6(0x149)]()));const _0x274fe2=await fetch(_0x1f5609,{'method':_0x55afc6(0x116),'headers':{'Accept':_0x55afc6(0x135),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x3112f3=Date[_0x55afc6(0x11a)]()-_0x41f441;if(!_0x274fe2['ok']){const _0x22db48=await _0x274fe2[_0x55afc6(0xe3)]();loggerService_1[_0x55afc6(0xf7)]['logWhiteDomainResponse']('plisio_direct',_0x55afc6(0x13e)+_0x9fc577,_0x274fe2[_0x55afc6(0x140)],_0x22db48,_0x3112f3);throw new Error(_0x55afc6(0x128)+_0x274fe2[_0x55afc6(0x140)]);}const _0x38a501=await _0x274fe2['json']();loggerService_1[_0x55afc6(0xf7)][_0x55afc6(0x104)](_0x55afc6(0x14c),'/operations/'+_0x9fc577,_0x274fe2['status'],_0x38a501,_0x3112f3);if(_0x38a501[_0x55afc6(0x140)]!==_0x55afc6(0x11e)){loggerService_1['loggerService'][_0x55afc6(0x13f)](_0x55afc6(0x14c),_0x55afc6(0x13e)+_0x9fc577,_0x55afc6(0x14f)+(_0x38a501['message']||_0x38a501[_0x55afc6(0x14a)]||_0x55afc6(0x130)));throw new Error(_0x55afc6(0x14f)+(_0x38a501[_0x55afc6(0xfe)]||_0x38a501[_0x55afc6(0x14a)]||_0x55afc6(0x130)));}let _0x40efee=_0x55afc6(0x107);return{'status':_0x40efee};}catch(_0x1600dc){console[_0x55afc6(0x14a)](_0x55afc6(0x117),_0x1600dc),loggerService_1[_0x55afc6(0xf7)]['logWhiteDomainError']('plisio_direct','/operations/'+_0x9fc577,_0x1600dc);throw new Error(_0x55afc6(0xfb)+(_0x1600dc instanceof Error?_0x1600dc['message']:'Unknown\x20error'));}}async[a44_0xcefe01(0x141)](_0x39f3c4){const _0x175ee0=a44_0xcefe01;console[_0x175ee0(0xed)](_0x175ee0(0x103),_0x39f3c4);let _0xf088e=_0x175ee0(0x107);switch(_0x39f3c4[_0x175ee0(0x140)]?.[_0x175ee0(0x109)]()){case _0x175ee0(0x118):case _0x175ee0(0x123):_0xf088e=_0x175ee0(0xe0);break;case _0x175ee0(0x146):_0xf088e=_0x175ee0(0x121);break;case _0x175ee0(0x14a):case _0x175ee0(0x12f):_0xf088e='FAILED';break;case'new':_0xf088e=_0x175ee0(0x107);break;case _0x175ee0(0x10e):_0xf088e=_0x175ee0(0x129);break;default:_0xf088e='PENDING';break;}let _0x19fc68;if(_0x39f3c4[_0x175ee0(0x125)])try{console[_0x175ee0(0xed)](_0x175ee0(0x10f),_0x39f3c4[_0x175ee0(0x125)]);let _0x3bd908;if(typeof _0x39f3c4[_0x175ee0(0x125)]===_0x175ee0(0x12d))_0x3bd908=JSON[_0x175ee0(0xfa)](_0x39f3c4[_0x175ee0(0x125)]);else Array[_0x175ee0(0xf2)](_0x39f3c4[_0x175ee0(0x125)])?_0x3bd908=_0x39f3c4[_0x175ee0(0x125)]:_0x3bd908=[];_0x19fc68=_0x3bd908[_0x175ee0(0x119)](_0x1720e7=>{const _0x4c716a=_0x175ee0,_0x1e05d6=_0x1720e7[_0x4c716a(0xeb)](/\\/g,'');return console[_0x4c716a(0xed)](_0x4c716a(0xf1)+_0x1720e7+_0x4c716a(0x151)+_0x1e05d6),_0x1e05d6;}),console[_0x175ee0(0xed)](_0x175ee0(0x14e),_0x19fc68),_0x19fc68[_0x175ee0(0x102)]((_0x56cf5b,_0x1bfe45)=>{const _0x424f4d=_0x175ee0;try{new URL(_0x56cf5b),console[_0x424f4d(0xed)](_0x424f4d(0x122)+(_0x1bfe45+0x1)+'\x20is\x20valid:\x20'+_0x56cf5b);}catch(_0x4cbb87){console[_0x424f4d(0x14a)](_0x424f4d(0xf6)+(_0x1bfe45+0x1)+'\x20is\x20invalid:\x20'+_0x56cf5b,_0x4cbb87);}});}catch(_0x5072b5){console[_0x175ee0(0x14a)](_0x175ee0(0xec),_0x5072b5),console[_0x175ee0(0x14a)](_0x175ee0(0xfd),_0x39f3c4[_0x175ee0(0x125)]),_0x19fc68=undefined;}return{'paymentId':_0x39f3c4[_0x175ee0(0x115)]||'','status':_0xf088e,'amount':_0x39f3c4[_0x175ee0(0x133)],'currency':_0x39f3c4[_0x175ee0(0x14d)],'txUrls':_0x19fc68};}}exports['PlisioService']=PlisioService;