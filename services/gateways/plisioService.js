'use strict';const a41_0x5db3e3=a41_0x45ad;function a41_0x45ad(_0x5d9d91,_0x41697a){const _0x239ec4=a41_0x239e();return a41_0x45ad=function(_0x45adde,_0x3232ce){_0x45adde=_0x45adde-0xdb;let _0x4cf52a=_0x239ec4[_0x45adde];return _0x4cf52a;},a41_0x45ad(_0x5d9d91,_0x41697a);}function a41_0x239e(){const _0x1355b0=['pending','PlisioService','tx_urls','completed','defineProperty','error','5531512iTTdWF','invoice_total_sum','\x20is\x20invalid:\x20','Target\x20Currency:','Response\x20data:','28805517qExaPP','replace','Amount:','Parameters:','fromEntries','Error\x20message:','email','warn','Plisio\x20API\x20error:\x20','message','FAILED','statusText','data','URL:','‚ùå\x20Failed\x20to\x20parse\x20tx_urls:','qr_url','toLowerCase','log','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','loggerService','‚úÖ\x20URL\x20','parse','Response\x20Time:','apiUrl','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','append','Source\x20Currency:','/invoices/new','Invoice\x20URL:','createPayment','invoice_url','(fiat\x20for\x20merchant)','1879353bGIoGl','‚úÖ\x20Processed\x20tx_urls:','17RutnmE','new','text','Error\x20stack:','===\x20PLISIO\x20API\x20ERROR\x20===','Status:','mismatch','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','https://api.plisio.net/api/v1/operations/','logWhiteDomainError','status','name','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','148704zgdlFQ','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','HTTP\x20','HTTP\x20Status:','../loggerService','/operations/','HIDDEN','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','1842617UzvbqT','Raw\x20Response\x20Body:','üîó\x20Raw\x20tx_urls\x20from\x20Plisio:','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','map','GET','application/json','Parsed\x20Result:','currency','expired','qr_code','success','toString','Processing\x20Plisio\x20webhook:','logWhiteDomainResponse','JSON\x20Parse\x20Error:\x20','Plisio\x20API\x20key\x20is\x20not\x20configured','txn_id','TesSoft\x20Payment\x20System/1.0','Full\x20URL\x20(without\x20API\x20key):','749610xsLiuF','stringify','Error\x20Message:','PLISIO_API_KEY','Failed\x20to\x20create\x20Plisio\x20payment:\x20','now','logWhiteDomainRequest','apiKey','entries','plisio_direct','forEach','isArray','json','EXPIRED','HTTP\x20error!\x20status:\x20','32FuZNaY','Unknown\x20error','Unknown\x20error\x20from\x20Plisio\x20API','PAID','source_currency','amount','env','8236836RuPHvU',',\x20body:\x20','https://api.plisio.net/api/v1/invoices/new'];a41_0x239e=function(){return _0x1355b0;};return a41_0x239e();}(function(_0xb58489,_0x2980ac){const _0x50e78f=a41_0x45ad,_0x5065a3=_0xb58489();while(!![]){try{const _0x3175bc=-parseInt(_0x50e78f(0x11b))/0x1*(-parseInt(_0x50e78f(0x128))/0x2)+-parseInt(_0x50e78f(0x119))/0x3+-parseInt(_0x50e78f(0xe4))/0x4*(parseInt(_0x50e78f(0x144))/0x5)+-parseInt(_0x50e78f(0xeb))/0x6+parseInt(_0x50e78f(0x130))/0x7+-parseInt(_0x50e78f(0xf4))/0x8+parseInt(_0x50e78f(0xf9))/0x9;if(_0x3175bc===_0x2980ac)break;else _0x5065a3['push'](_0x5065a3['shift']());}catch(_0x565d1e){_0x5065a3['push'](_0x5065a3['shift']());}}}(a41_0x239e,0xcc87c));Object[a41_0x5db3e3(0xf2)](exports,'__esModule',{'value':!![]}),exports[a41_0x5db3e3(0xef)]=void 0x0;const loggerService_1=require(a41_0x5db3e3(0x12c));class PlisioService{constructor(){const _0x179e70=a41_0x5db3e3;this['apiUrl']=_0x179e70(0xed),this[_0x179e70(0xdc)]=process[_0x179e70(0xea)][_0x179e70(0x147)]||'',!this[_0x179e70(0xdc)]?console[_0x179e70(0x100)]('‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables'):console[_0x179e70(0x10a)]('üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API');}async[a41_0x5db3e3(0x116)](_0x3ac41e){const _0x39a767=a41_0x5db3e3,{orderId:_0x249510,amount:_0xd0accd,currency:_0x38c9d3,productName:_0xa07706,description:_0x36c503,successUrl:_0x41aebe,failUrl:_0x77d4f0,customerEmail:_0x51af17,customerName:_0x3db11c,isSourceCurrency:_0x526e4b,sourceCurrency:_0x57fa73}=_0x3ac41e;if(!this[_0x39a767(0xdc)])throw new Error(_0x39a767(0x140));const _0x5b5aa2=new URLSearchParams({'api_key':this[_0x39a767(0xdc)],'order_number':_0x249510,'order_name':_0xa07706,'description':_0x36c503,'success_url':_0x41aebe,'fail_url':_0x77d4f0,'callback_url':'https://api.trapay.uk/api/webhooks/gateway/plisio'});_0x57fa73?(_0x5b5aa2[_0x39a767(0x112)](_0x39a767(0x138),_0x57fa73),_0x5b5aa2[_0x39a767(0x112)](_0x39a767(0xe8),_0x38c9d3),_0x5b5aa2[_0x39a767(0x112)]('source_amount',_0xd0accd[_0x39a767(0x13c)]())):(_0x5b5aa2[_0x39a767(0x112)]('currency',_0x38c9d3),_0x5b5aa2['append'](_0x39a767(0xe9),_0xd0accd['toString']()));_0x51af17&&_0x5b5aa2['append'](_0x39a767(0xff),_0x51af17);_0x3db11c&&_0x5b5aa2[_0x39a767(0x112)](_0x39a767(0x126),_0x3db11c);const _0x2d89bd=this[_0x39a767(0x110)]+'?'+_0x5b5aa2[_0x39a767(0x13c)](),_0xa8afb2=Date[_0x39a767(0x149)]();try{console['log']('===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20==='),console[_0x39a767(0x10a)](_0x39a767(0x106),this[_0x39a767(0x110)]),console['log'](_0x39a767(0xfc),Object['fromEntries'](_0x5b5aa2['entries']())),console['log'](_0x39a767(0x143),_0x2d89bd[_0x39a767(0xfa)](this[_0x39a767(0xdc)],_0x39a767(0x12e))),loggerService_1[_0x39a767(0x10c)][_0x39a767(0xdb)](_0x39a767(0xde),_0x39a767(0x114),'GET',Object['fromEntries'](_0x5b5aa2['entries']()));const _0x2e1dde=await fetch(_0x2d89bd,{'method':_0x39a767(0x135),'headers':{'Accept':_0x39a767(0x136),'User-Agent':_0x39a767(0x142)}}),_0x19c761=Date['now']()-_0xa8afb2;console[_0x39a767(0x10a)]('===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20==='),console[_0x39a767(0x10a)](_0x39a767(0x120),_0x2e1dde[_0x39a767(0x125)]),console[_0x39a767(0x10a)]('Status\x20Text:',_0x2e1dde[_0x39a767(0x104)]),console['log'](_0x39a767(0x10f),_0x19c761+'ms');const _0x4aa99c=await _0x2e1dde[_0x39a767(0x11d)]();console[_0x39a767(0x10a)](_0x39a767(0x131),_0x4aa99c);if(!_0x2e1dde['ok']){console[_0x39a767(0xf3)](_0x39a767(0x11f)),console[_0x39a767(0xf3)](_0x39a767(0x12b),_0x2e1dde[_0x39a767(0x125)]),console[_0x39a767(0xf3)]('Response\x20Body:',_0x4aa99c),loggerService_1[_0x39a767(0x10c)][_0x39a767(0x13e)]('plisio_direct',_0x39a767(0x114),_0x2e1dde[_0x39a767(0x125)],_0x4aa99c,_0x19c761),loggerService_1[_0x39a767(0x10c)]['logWhiteDomainError']('plisio_direct',_0x39a767(0x114),_0x39a767(0x12a)+_0x2e1dde[_0x39a767(0x125)]+':\x20'+_0x4aa99c);throw new Error(_0x39a767(0xe3)+_0x2e1dde[_0x39a767(0x125)]+_0x39a767(0xec)+_0x4aa99c);}let _0x311dd4;try{_0x311dd4=JSON[_0x39a767(0x10e)](_0x4aa99c);}catch(_0x132f0e){console[_0x39a767(0xf3)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x132f0e),loggerService_1[_0x39a767(0x10c)][_0x39a767(0x124)](_0x39a767(0xde),_0x39a767(0x114),_0x39a767(0x13f)+_0x132f0e);throw new Error(_0x39a767(0x133)+_0x4aa99c);}console[_0x39a767(0x10a)](_0x39a767(0x129)),console[_0x39a767(0x10a)](_0x39a767(0x137),JSON[_0x39a767(0x145)](_0x311dd4,null,0x2)),loggerService_1[_0x39a767(0x10c)][_0x39a767(0x13e)]('plisio_direct',_0x39a767(0x114),_0x2e1dde[_0x39a767(0x125)],_0x311dd4,_0x19c761);if(_0x311dd4[_0x39a767(0x125)]!==_0x39a767(0x13b)){const _0x168178=_0x311dd4[_0x39a767(0x102)]||_0x311dd4[_0x39a767(0xf3)]||_0x39a767(0xe6);console[_0x39a767(0xf3)](_0x39a767(0x122)),console[_0x39a767(0xf3)](_0x39a767(0x146),_0x168178),loggerService_1['loggerService'][_0x39a767(0x124)]('plisio_direct','/invoices/new','Business\x20Error:\x20'+_0x168178);throw new Error(_0x39a767(0x101)+_0x168178);}if(!_0x311dd4['data']?.[_0x39a767(0x141)]||!_0x311dd4['data']?.[_0x39a767(0x117)]){console[_0x39a767(0xf3)]('===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x39a767(0xf3)]('Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response'),console[_0x39a767(0xf3)](_0x39a767(0xf8),_0x311dd4[_0x39a767(0x105)]),loggerService_1[_0x39a767(0x10c)][_0x39a767(0x124)](_0x39a767(0xde),_0x39a767(0x114),'Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url');throw new Error(_0x39a767(0x111));}return console[_0x39a767(0x10a)]('===\x20PLISIO\x20SUCCESS\x20==='),console[_0x39a767(0x10a)]('Transaction\x20ID:',_0x311dd4['data']['txn_id']),console[_0x39a767(0x10a)](_0x39a767(0x115),_0x311dd4[_0x39a767(0x105)]['invoice_url']),console[_0x39a767(0x10a)](_0x39a767(0xfb),_0xd0accd,_0x38c9d3),_0x57fa73&&(console['log'](_0x39a767(0x113),_0x57fa73,'(crypto\x20for\x20payment)'),console[_0x39a767(0x10a)](_0x39a767(0xf7),_0x38c9d3,_0x39a767(0x118))),{'gateway_payment_id':_0x311dd4[_0x39a767(0x105)][_0x39a767(0x141)],'payment_url':_0x311dd4[_0x39a767(0x105)][_0x39a767(0x117)],'invoice_total_sum':_0x311dd4[_0x39a767(0x105)][_0x39a767(0xf5)],'qr_code':_0x311dd4[_0x39a767(0x105)][_0x39a767(0x13a)],'qr_url':_0x311dd4[_0x39a767(0x105)][_0x39a767(0x108)]};}catch(_0x510421){console[_0x39a767(0xf3)](_0x39a767(0x10b)),console[_0x39a767(0xf3)]('Error\x20details:',_0x510421),loggerService_1[_0x39a767(0x10c)]['logWhiteDomainError'](_0x39a767(0xde),'/invoices/new',_0x510421);if(_0x510421 instanceof Error){console[_0x39a767(0xf3)](_0x39a767(0xfe),_0x510421['message']),console[_0x39a767(0xf3)](_0x39a767(0x11e),_0x510421['stack']);throw new Error(_0x39a767(0x148)+_0x510421[_0x39a767(0x102)]);}throw new Error(_0x39a767(0x12f));}}async['verifyPayment'](_0x991e5b){const _0x5878e0=a41_0x5db3e3,_0x34e95b=Date[_0x5878e0(0x149)]();try{if(!this['apiKey'])throw new Error(_0x5878e0(0x140));const _0x3d3605=new URLSearchParams({'api_key':this[_0x5878e0(0xdc)],'txn_id':_0x991e5b}),_0x1b924a=_0x5878e0(0x123)+_0x991e5b+'?'+_0x3d3605[_0x5878e0(0x13c)]();loggerService_1[_0x5878e0(0x10c)][_0x5878e0(0xdb)](_0x5878e0(0xde),_0x5878e0(0x12d)+_0x991e5b,_0x5878e0(0x135),Object[_0x5878e0(0xfd)](_0x3d3605[_0x5878e0(0xdd)]()));const _0x239fe0=await fetch(_0x1b924a,{'method':_0x5878e0(0x135),'headers':{'Accept':_0x5878e0(0x136),'User-Agent':_0x5878e0(0x142)}}),_0x136d73=Date[_0x5878e0(0x149)]()-_0x34e95b;if(!_0x239fe0['ok']){const _0x46e8fa=await _0x239fe0['text']();loggerService_1[_0x5878e0(0x10c)][_0x5878e0(0x13e)](_0x5878e0(0xde),'/operations/'+_0x991e5b,_0x239fe0[_0x5878e0(0x125)],_0x46e8fa,_0x136d73);throw new Error(_0x5878e0(0xe3)+_0x239fe0[_0x5878e0(0x125)]);}const _0x39aed7=await _0x239fe0[_0x5878e0(0xe1)]();loggerService_1[_0x5878e0(0x10c)]['logWhiteDomainResponse'](_0x5878e0(0xde),'/operations/'+_0x991e5b,_0x239fe0[_0x5878e0(0x125)],_0x39aed7,_0x136d73);if(_0x39aed7['status']!=='success'){loggerService_1[_0x5878e0(0x10c)][_0x5878e0(0x124)](_0x5878e0(0xde),_0x5878e0(0x12d)+_0x991e5b,'Plisio\x20API\x20error:\x20'+(_0x39aed7[_0x5878e0(0x102)]||_0x39aed7[_0x5878e0(0xf3)]||_0x5878e0(0xe5)));throw new Error(_0x5878e0(0x101)+(_0x39aed7[_0x5878e0(0x102)]||_0x39aed7['error']||_0x5878e0(0xe5)));}let _0x315d56='PENDING';return{'status':_0x315d56};}catch(_0x1396ba){console[_0x5878e0(0xf3)]('Plisio\x20payment\x20verification\x20error:',_0x1396ba),loggerService_1[_0x5878e0(0x10c)]['logWhiteDomainError']('plisio_direct',_0x5878e0(0x12d)+_0x991e5b,_0x1396ba);throw new Error(_0x5878e0(0x127)+(_0x1396ba instanceof Error?_0x1396ba[_0x5878e0(0x102)]:_0x5878e0(0xe5)));}}async['processWebhook'](_0x12c1c5){const _0x1fbcf1=a41_0x5db3e3;console[_0x1fbcf1(0x10a)](_0x1fbcf1(0x13d),_0x12c1c5);let _0x432b0c='PENDING';switch(_0x12c1c5[_0x1fbcf1(0x125)]?.[_0x1fbcf1(0x109)]()){case _0x1fbcf1(0xf1):case _0x1fbcf1(0x121):_0x432b0c=_0x1fbcf1(0xe7);break;case _0x1fbcf1(0x139):_0x432b0c=_0x1fbcf1(0xe2);break;case _0x1fbcf1(0xf3):case'cancelled':_0x432b0c=_0x1fbcf1(0x103);break;case _0x1fbcf1(0x11c):case _0x1fbcf1(0xee):default:_0x432b0c='PENDING';break;}let _0x3a9815;if(_0x12c1c5['tx_urls'])try{console[_0x1fbcf1(0x10a)](_0x1fbcf1(0x132),_0x12c1c5[_0x1fbcf1(0xf0)]);let _0x12d558;if(typeof _0x12c1c5[_0x1fbcf1(0xf0)]==='string')_0x12d558=JSON[_0x1fbcf1(0x10e)](_0x12c1c5[_0x1fbcf1(0xf0)]);else Array[_0x1fbcf1(0xe0)](_0x12c1c5[_0x1fbcf1(0xf0)])?_0x12d558=_0x12c1c5[_0x1fbcf1(0xf0)]:_0x12d558=[];_0x3a9815=_0x12d558[_0x1fbcf1(0x134)](_0x3a4574=>{const _0x43e2f1=_0x1fbcf1,_0xb6d3b=_0x3a4574[_0x43e2f1(0xfa)](/\\/g,'');return console['log']('üîó\x20Formatted\x20URL:\x20'+_0x3a4574+'\x20->\x20'+_0xb6d3b),_0xb6d3b;}),console[_0x1fbcf1(0x10a)](_0x1fbcf1(0x11a),_0x3a9815),_0x3a9815[_0x1fbcf1(0xdf)]((_0x6e932d,_0x24ee3c)=>{const _0x44d3a4=_0x1fbcf1;try{new URL(_0x6e932d),console['log'](_0x44d3a4(0x10d)+(_0x24ee3c+0x1)+'\x20is\x20valid:\x20'+_0x6e932d);}catch(_0x1c7765){console[_0x44d3a4(0xf3)]('‚ùå\x20URL\x20'+(_0x24ee3c+0x1)+_0x44d3a4(0xf6)+_0x6e932d,_0x1c7765);}});}catch(_0x5e7c48){console[_0x1fbcf1(0xf3)](_0x1fbcf1(0x107),_0x5e7c48),console[_0x1fbcf1(0xf3)]('Raw\x20tx_urls\x20data:',_0x12c1c5[_0x1fbcf1(0xf0)]),_0x3a9815=undefined;}return{'paymentId':_0x12c1c5['order_number']||'','status':_0x432b0c,'amount':_0x12c1c5[_0x1fbcf1(0xe9)],'currency':_0x12c1c5[_0x1fbcf1(0x138)],'txUrls':_0x3a9815};}}exports[a41_0x5db3e3(0xef)]=PlisioService;