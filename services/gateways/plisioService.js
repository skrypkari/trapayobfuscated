'use strict';const a74_0x368e85=a74_0x2668;(function(_0x28e03a,_0x3d1467){const _0x3cc732=a74_0x2668,_0x48b8f4=_0x28e03a();while(!![]){try{const _0x6d3ba5=parseInt(_0x3cc732(0x1c0))/0x1+-parseInt(_0x3cc732(0x1b9))/0x2*(parseInt(_0x3cc732(0x219))/0x3)+-parseInt(_0x3cc732(0x1c9))/0x4+-parseInt(_0x3cc732(0x205))/0x5+-parseInt(_0x3cc732(0x1f9))/0x6*(parseInt(_0x3cc732(0x1c4))/0x7)+parseInt(_0x3cc732(0x1f8))/0x8+parseInt(_0x3cc732(0x225))/0x9;if(_0x6d3ba5===_0x3d1467)break;else _0x48b8f4['push'](_0x48b8f4['shift']());}catch(_0x3b0251){_0x48b8f4['push'](_0x48b8f4['shift']());}}}(a74_0x2ca9,0xdae99));Object[a74_0x368e85(0x206)](exports,a74_0x368e85(0x1d7),{'value':!![]}),exports['PlisioService']=void 0x0;function a74_0x2668(_0x1fbefb,_0x558d96){_0x1fbefb=_0x1fbefb-0x1b8;const _0x2ca981=a74_0x2ca9();let _0x26686e=_0x2ca981[_0x1fbefb];return _0x26686e;}function a74_0x2ca9(){const _0x3ca39f=['invoice_total_sum','===\x20PLISIO\x20SUCCESS\x20===','__esModule','expired','source_amount','toString','üîó\x20Formatted\x20URL:\x20','‚úÖ\x20Processed\x20tx_urls:','amount','logWhiteDomainError','log','GET','new','text','message','Raw\x20Response\x20Body:','parse','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','error','Status:','/operations/','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','Processing\x20Plisio\x20webhook:','statusText','completed','Error\x20message:','logWhiteDomainRequest','stack','Parsed\x20Result:','/invoices/new','replace','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','(crypto\x20for\x20payment)','EXPIRED','URL:','2191744nsChaM','24tcUQKc','invoice_url','PROCESSING','Amount:','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','createPayment','fromEntries','logWhiteDomainResponse','loggerService','order_number','PENDING','6497625cAMLYM','defineProperty','===\x20PLISIO\x20API\x20ERROR\x20===','PlisioService','verifyPayment','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','Response\x20Time:','map','Plisio\x20API\x20key\x20is\x20not\x20configured','application/json','‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','JSON\x20Parse\x20Error:\x20','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','email','name','status','PAID','apiUrl','Unknown\x20error\x20from\x20Plisio\x20API','Error\x20details:','18xVvNKm','apiKey','Source\x20Currency:','Invoice\x20URL:','Parameters:','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Status\x20Text:','(fiat\x20for\x20merchant)','entries','Plisio\x20payment\x20verification\x20error:','Response\x20data:','now','25713054mbFXSM','HTTP\x20','FAILED','Payment\x20System/1.0','Plisio\x20API\x20error:\x20','mismatch','data','\x20is\x20invalid:\x20','103324bvXMMT','‚ùå\x20Failed\x20to\x20parse\x20tx_urls:','processWebhook','plisio_direct','üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','Response\x20Body:','HIDDEN','1195642vnkiBo','Error\x20stack:','\x20is\x20valid:\x20','json','1915144jImRkJ','currency','tx_urls','https://api.plisio.net/api/v1/operations/','cancelled','2904344sYBuTf','Transaction\x20ID:','‚úÖ\x20URL\x20','txn_id','append','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','forEach','HTTP\x20Status:','Unknown\x20error','https://api.plisio.net/api/v1/invoices/new','Failed\x20to\x20create\x20Plisio\x20payment:\x20','Business\x20Error:\x20'];a74_0x2ca9=function(){return _0x3ca39f;};return a74_0x2ca9();}const loggerService_1=require('../loggerService');class PlisioService{constructor(){const _0x2931ec=a74_0x368e85;this['apiUrl']=_0x2931ec(0x1d2),this[_0x2931ec(0x21a)]=process.env.PLISIO_API_KEY||'',!this[_0x2931ec(0x21a)]?console['warn'](_0x2931ec(0x20f)):console[_0x2931ec(0x1df)](_0x2931ec(0x1bd));}async[a74_0x368e85(0x1ff)](_0x21e8f2){const _0x1c332f=a74_0x368e85,{orderId:_0x42ead9,amount:_0x2defa2,currency:_0x25036b,productName:_0x522893,description:_0x994bb1,successUrl:_0x5c89c2,failUrl:_0x2c9313,customerEmail:_0x1ddfd1,customerName:_0x3f39a3,isSourceCurrency:_0x103092,sourceCurrency:_0x260260}=_0x21e8f2;if(!this[_0x1c332f(0x21a)])throw new Error(_0x1c332f(0x20d));const _0x4508a3=new URLSearchParams({'api_key':this['apiKey'],'order_number':_0x42ead9,'order_name':_0x522893,'description':_0x994bb1,'success_url':_0x5c89c2,'fail_url':_0x2c9313,'callback_url':'https://api.trapay.uk/api/webhooks/gateway/plisio'});_0x260260?(_0x4508a3[_0x1c332f(0x1cd)](_0x1c332f(0x1c5),_0x260260),_0x4508a3[_0x1c332f(0x1cd)]('source_currency',_0x25036b),_0x4508a3['append'](_0x1c332f(0x1d9),_0x2defa2[_0x1c332f(0x1da)]())):(_0x4508a3[_0x1c332f(0x1cd)](_0x1c332f(0x1c5),_0x25036b),_0x4508a3[_0x1c332f(0x1cd)](_0x1c332f(0x1dd),_0x2defa2[_0x1c332f(0x1da)]()));_0x1ddfd1&&_0x4508a3['append'](_0x1c332f(0x212),_0x1ddfd1);_0x3f39a3&&_0x4508a3[_0x1c332f(0x1cd)](_0x1c332f(0x213),_0x3f39a3);const _0x2f9611=this[_0x1c332f(0x216)]+'?'+_0x4508a3[_0x1c332f(0x1da)](),_0x4fe100=Date[_0x1c332f(0x224)]();try{console['log'](_0x1c332f(0x1fe)),console['log'](_0x1c332f(0x1f7),this[_0x1c332f(0x216)]),console['log'](_0x1c332f(0x21d),Object[_0x1c332f(0x200)](_0x4508a3['entries']())),console[_0x1c332f(0x1df)]('Full\x20URL\x20(without\x20API\x20key):',_0x2f9611[_0x1c332f(0x1f3)](this[_0x1c332f(0x21a)],_0x1c332f(0x1bf))),loggerService_1[_0x1c332f(0x202)][_0x1c332f(0x1ef)](_0x1c332f(0x1bc),_0x1c332f(0x1f2),_0x1c332f(0x1e0),Object[_0x1c332f(0x200)](_0x4508a3[_0x1c332f(0x221)]()));const _0x399ca7=await fetch(_0x2f9611,{'method':'GET','headers':{'Accept':_0x1c332f(0x20e),'User-Agent':_0x1c332f(0x228)}}),_0x183a20=Date['now']()-_0x4fe100;console['log'](_0x1c332f(0x1e6)),console[_0x1c332f(0x1df)](_0x1c332f(0x1e8),_0x399ca7[_0x1c332f(0x214)]),console[_0x1c332f(0x1df)](_0x1c332f(0x21f),_0x399ca7[_0x1c332f(0x1ec)]),console[_0x1c332f(0x1df)](_0x1c332f(0x20b),_0x183a20+'ms');const _0x106dab=await _0x399ca7[_0x1c332f(0x1e2)]();console[_0x1c332f(0x1df)](_0x1c332f(0x1e4),_0x106dab);if(!_0x399ca7['ok']){console[_0x1c332f(0x1e7)](_0x1c332f(0x207)),console[_0x1c332f(0x1e7)](_0x1c332f(0x1d0),_0x399ca7[_0x1c332f(0x214)]),console[_0x1c332f(0x1e7)](_0x1c332f(0x1be),_0x106dab),loggerService_1[_0x1c332f(0x202)][_0x1c332f(0x201)](_0x1c332f(0x1bc),_0x1c332f(0x1f2),_0x399ca7[_0x1c332f(0x214)],_0x106dab,_0x183a20),loggerService_1[_0x1c332f(0x202)][_0x1c332f(0x1de)](_0x1c332f(0x1bc),_0x1c332f(0x1f2),_0x1c332f(0x226)+_0x399ca7['status']+':\x20'+_0x106dab);throw new Error('HTTP\x20error!\x20status:\x20'+_0x399ca7[_0x1c332f(0x214)]+',\x20body:\x20'+_0x106dab);}let _0x527979;try{_0x527979=JSON[_0x1c332f(0x1e5)](_0x106dab);}catch(_0x152645){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0x152645),loggerService_1[_0x1c332f(0x202)][_0x1c332f(0x1de)](_0x1c332f(0x1bc),_0x1c332f(0x1f2),_0x1c332f(0x210)+_0x152645);throw new Error('Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20'+_0x106dab);}console[_0x1c332f(0x1df)]('===\x20PARSED\x20PLISIO\x20RESPONSE\x20==='),console['log'](_0x1c332f(0x1f1),JSON['stringify'](_0x527979,null,0x2)),loggerService_1['loggerService'][_0x1c332f(0x201)]('plisio_direct',_0x1c332f(0x1f2),_0x399ca7['status'],_0x527979,_0x183a20);if(_0x527979[_0x1c332f(0x214)]!=='success'){const _0x9c7180=_0x527979['message']||_0x527979[_0x1c332f(0x1e7)]||_0x1c332f(0x217);console[_0x1c332f(0x1e7)](_0x1c332f(0x1ce)),console[_0x1c332f(0x1e7)]('Error\x20Message:',_0x9c7180),loggerService_1['loggerService'][_0x1c332f(0x1de)](_0x1c332f(0x1bc),_0x1c332f(0x1f2),_0x1c332f(0x1d4)+_0x9c7180);throw new Error(_0x1c332f(0x229)+_0x9c7180);}if(!_0x527979['data']?.[_0x1c332f(0x1cc)]||!_0x527979[_0x1c332f(0x22b)]?.[_0x1c332f(0x1fa)]){console['error'](_0x1c332f(0x21e)),console['error'](_0x1c332f(0x1f4)),console['error'](_0x1c332f(0x223),_0x527979[_0x1c332f(0x22b)]),loggerService_1[_0x1c332f(0x202)][_0x1c332f(0x1de)](_0x1c332f(0x1bc),'/invoices/new',_0x1c332f(0x1fd));throw new Error(_0x1c332f(0x20a));}return console[_0x1c332f(0x1df)](_0x1c332f(0x1d6)),console['log'](_0x1c332f(0x1ca),_0x527979[_0x1c332f(0x22b)][_0x1c332f(0x1cc)]),console[_0x1c332f(0x1df)](_0x1c332f(0x21c),_0x527979['data'][_0x1c332f(0x1fa)]),console['log'](_0x1c332f(0x1fc),_0x2defa2,_0x25036b),_0x260260&&(console[_0x1c332f(0x1df)](_0x1c332f(0x21b),_0x260260,_0x1c332f(0x1f5)),console[_0x1c332f(0x1df)]('Target\x20Currency:',_0x25036b,_0x1c332f(0x220))),{'gateway_payment_id':_0x527979[_0x1c332f(0x22b)][_0x1c332f(0x1cc)],'payment_url':_0x527979['data'][_0x1c332f(0x1fa)],'invoice_total_sum':_0x527979[_0x1c332f(0x22b)][_0x1c332f(0x1d5)],'qr_code':_0x527979[_0x1c332f(0x22b)]['qr_code'],'qr_url':_0x527979[_0x1c332f(0x22b)]['qr_url']};}catch(_0x40af77){console[_0x1c332f(0x1e7)](_0x1c332f(0x211)),console[_0x1c332f(0x1e7)](_0x1c332f(0x218),_0x40af77),loggerService_1[_0x1c332f(0x202)][_0x1c332f(0x1de)](_0x1c332f(0x1bc),'/invoices/new',_0x40af77);if(_0x40af77 instanceof Error){console[_0x1c332f(0x1e7)](_0x1c332f(0x1ee),_0x40af77[_0x1c332f(0x1e3)]),console[_0x1c332f(0x1e7)](_0x1c332f(0x1c1),_0x40af77[_0x1c332f(0x1f0)]);throw new Error(_0x1c332f(0x1d3)+_0x40af77['message']);}throw new Error('Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error');}}async[a74_0x368e85(0x209)](_0x553cbf){const _0x3ae765=a74_0x368e85,_0x2dcbfd=Date['now']();try{if(!this[_0x3ae765(0x21a)])throw new Error(_0x3ae765(0x20d));const _0x374d92=new URLSearchParams({'api_key':this[_0x3ae765(0x21a)],'txn_id':_0x553cbf}),_0x390ed8=_0x3ae765(0x1c7)+_0x553cbf+'?'+_0x374d92[_0x3ae765(0x1da)]();loggerService_1[_0x3ae765(0x202)]['logWhiteDomainRequest'](_0x3ae765(0x1bc),_0x3ae765(0x1e9)+_0x553cbf,_0x3ae765(0x1e0),Object[_0x3ae765(0x200)](_0x374d92[_0x3ae765(0x221)]()));const _0x3dba96=await fetch(_0x390ed8,{'method':'GET','headers':{'Accept':'application/json','User-Agent':_0x3ae765(0x228)}}),_0x271b5e=Date['now']()-_0x2dcbfd;if(!_0x3dba96['ok']){const _0x3d9147=await _0x3dba96['text']();loggerService_1[_0x3ae765(0x202)]['logWhiteDomainResponse']('plisio_direct',_0x3ae765(0x1e9)+_0x553cbf,_0x3dba96['status'],_0x3d9147,_0x271b5e);throw new Error('HTTP\x20error!\x20status:\x20'+_0x3dba96['status']);}const _0x3a5b48=await _0x3dba96[_0x3ae765(0x1c3)]();loggerService_1[_0x3ae765(0x202)]['logWhiteDomainResponse'](_0x3ae765(0x1bc),_0x3ae765(0x1e9)+_0x553cbf,_0x3dba96['status'],_0x3a5b48,_0x271b5e);if(_0x3a5b48[_0x3ae765(0x214)]!=='success'){loggerService_1['loggerService'][_0x3ae765(0x1de)]('plisio_direct','/operations/'+_0x553cbf,_0x3ae765(0x229)+(_0x3a5b48[_0x3ae765(0x1e3)]||_0x3a5b48[_0x3ae765(0x1e7)]||_0x3ae765(0x1d1)));throw new Error(_0x3ae765(0x229)+(_0x3a5b48[_0x3ae765(0x1e3)]||_0x3a5b48[_0x3ae765(0x1e7)]||_0x3ae765(0x1d1)));}let _0xbc2ea='PENDING';return{'status':_0xbc2ea};}catch(_0xa8b0ed){console[_0x3ae765(0x1e7)](_0x3ae765(0x222),_0xa8b0ed),loggerService_1[_0x3ae765(0x202)][_0x3ae765(0x1de)](_0x3ae765(0x1bc),'/operations/'+_0x553cbf,_0xa8b0ed);throw new Error(_0x3ae765(0x1ea)+(_0xa8b0ed instanceof Error?_0xa8b0ed['message']:'Unknown\x20error'));}}async[a74_0x368e85(0x1bb)](_0x2766a8){const _0x511c39=a74_0x368e85;console[_0x511c39(0x1df)](_0x511c39(0x1eb),_0x2766a8);let _0x4da6ee=_0x511c39(0x204);switch(_0x2766a8['status']?.['toLowerCase']()){case _0x511c39(0x1ed):case _0x511c39(0x22a):_0x4da6ee=_0x511c39(0x215);break;case _0x511c39(0x1d8):_0x4da6ee=_0x511c39(0x1f6);break;case'error':case _0x511c39(0x1c8):_0x4da6ee=_0x511c39(0x227);break;case _0x511c39(0x1e1):_0x4da6ee='PENDING';break;case'pending':_0x4da6ee=_0x511c39(0x1fb);break;default:_0x4da6ee=_0x511c39(0x204);break;}let _0x503bda;if(_0x2766a8[_0x511c39(0x1c6)])try{console[_0x511c39(0x1df)]('üîó\x20Raw\x20tx_urls\x20from\x20Plisio:',_0x2766a8[_0x511c39(0x1c6)]);let _0xa9e066;if(typeof _0x2766a8[_0x511c39(0x1c6)]==='string')_0xa9e066=JSON[_0x511c39(0x1e5)](_0x2766a8['tx_urls']);else Array['isArray'](_0x2766a8[_0x511c39(0x1c6)])?_0xa9e066=_0x2766a8[_0x511c39(0x1c6)]:_0xa9e066=[];_0x503bda=_0xa9e066[_0x511c39(0x20c)](_0x1fc632=>{const _0x4d0691=_0x511c39,_0x55a89f=_0x1fc632[_0x4d0691(0x1f3)](/\\/g,'');return console[_0x4d0691(0x1df)](_0x4d0691(0x1db)+_0x1fc632+'\x20->\x20'+_0x55a89f),_0x55a89f;}),console[_0x511c39(0x1df)](_0x511c39(0x1dc),_0x503bda),_0x503bda[_0x511c39(0x1cf)]((_0x2415f0,_0x30b41e)=>{const _0x50f156=_0x511c39;try{new URL(_0x2415f0),console[_0x50f156(0x1df)](_0x50f156(0x1cb)+(_0x30b41e+0x1)+_0x50f156(0x1c2)+_0x2415f0);}catch(_0x3f7942){console['error']('‚ùå\x20URL\x20'+(_0x30b41e+0x1)+_0x50f156(0x1b8)+_0x2415f0,_0x3f7942);}});}catch(_0x38ee08){console[_0x511c39(0x1e7)](_0x511c39(0x1ba),_0x38ee08),console[_0x511c39(0x1e7)]('Raw\x20tx_urls\x20data:',_0x2766a8['tx_urls']),_0x503bda=undefined;}return{'paymentId':_0x2766a8[_0x511c39(0x203)]||'','status':_0x4da6ee,'amount':_0x2766a8[_0x511c39(0x1dd)],'currency':_0x2766a8['currency'],'txUrls':_0x503bda};}}exports[a74_0x368e85(0x208)]=PlisioService;