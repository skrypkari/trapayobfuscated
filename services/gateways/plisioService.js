'use strict';const a52_0x14d6bb=a52_0x1581;(function(_0x2e7f90,_0x30a4cd){const _0x30c2d0=a52_0x1581,_0x185e8f=_0x2e7f90();while(!![]){try{const _0x450818=parseInt(_0x30c2d0(0x176))/0x1+parseInt(_0x30c2d0(0x1d3))/0x2+parseInt(_0x30c2d0(0x16e))/0x3*(parseInt(_0x30c2d0(0x169))/0x4)+-parseInt(_0x30c2d0(0x188))/0x5*(parseInt(_0x30c2d0(0x1c8))/0x6)+parseInt(_0x30c2d0(0x1ca))/0x7+parseInt(_0x30c2d0(0x190))/0x8*(-parseInt(_0x30c2d0(0x17a))/0x9)+parseInt(_0x30c2d0(0x1b0))/0xa;if(_0x450818===_0x30a4cd)break;else _0x185e8f['push'](_0x185e8f['shift']());}catch(_0x32db38){_0x185e8f['push'](_0x185e8f['shift']());}}}(a52_0x5434,0x8e2de));function a52_0x1581(_0x12b3a9,_0xbf4e55){const _0x5434ad=a52_0x5434();return a52_0x1581=function(_0x158175,_0x53840b){_0x158175=_0x158175-0x169;let _0x3c4225=_0x5434ad[_0x158175];return _0x3c4225;},a52_0x1581(_0x12b3a9,_0xbf4e55);}Object[a52_0x14d6bb(0x17f)](exports,'__esModule',{'value':!![]}),exports[a52_0x14d6bb(0x175)]=void 0x0;function a52_0x5434(){const _0x1f7476=['logWhiteDomainError','currency','defineProperty','Unknown\x20error','FAILED','PROCESSING','Parsed\x20Result:','string',',\x20body:\x20','tx_urls','Plisio\x20API\x20error:\x20','115kgQGuV','Failed\x20to\x20create\x20Plisio\x20payment:\x20','HTTP\x20Status:','Plisio\x20payment\x20verification\x20error:','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','PLISIO_API_KEY','expired','https://api.trapay.uk/api/webhooks/gateway/plisio','8KUUyJq','message','replace','\x20is\x20valid:\x20','JSON\x20Parse\x20Error:\x20','new','data','log','warn','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','Error\x20Message:','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','parse','text','HTTP\x20error!\x20status:\x20','append','/invoices/new','Response\x20Time:','invoice_url','forEach','‚úÖ\x20Processed\x20tx_urls:','Response\x20data:','cancelled','üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','success','qr_code','‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','GET','üîó\x20Formatted\x20URL:\x20','stack','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','Error\x20message:','1003650qhBlHK','amount','name','loggerService','logWhiteDomainRequest','source_currency','error','entries','order_number','application/json','fromEntries','‚ùå\x20Failed\x20to\x20parse\x20tx_urls:','apiUrl','now','verifyPayment','Unknown\x20error\x20from\x20Plisio\x20API','EXPIRED','Target\x20Currency:','status','isArray','Source\x20Currency:','URL:','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','toLowerCase','144354GVfebJ','Response\x20Body:','5273814zrbuBh','logWhiteDomainResponse','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','map','Business\x20Error:\x20','PENDING','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','Amount:','(crypto\x20for\x20payment)','75826LUrMtp','Plisio\x20API\x20key\x20is\x20not\x20configured','apiKey','plisio_direct','toString','completed','Raw\x20tx_urls\x20data:','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','Payment\x20System/1.0','104UGoJrz','txn_id','Error\x20details:','===\x20PLISIO\x20SUCCESS\x20===','HIDDEN','48432eqfHGq','Error\x20stack:','\x20is\x20invalid:\x20','pending','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','source_amount','Full\x20URL\x20(without\x20API\x20key):','PlisioService','473932OufAtG','(fiat\x20for\x20merchant)','qr_url','statusText','5846697AVSfrr','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','/operations/'];a52_0x5434=function(){return _0x1f7476;};return a52_0x5434();}const loggerService_1=require('../loggerService');class PlisioService{constructor(){const _0x242a00=a52_0x14d6bb;this['apiUrl']='https://api.plisio.net/api/v1/invoices/new',this[_0x242a00(0x1d5)]=process['env'][_0x242a00(0x18d)]||'',!this[_0x242a00(0x1d5)]?console[_0x242a00(0x198)](_0x242a00(0x1aa)):console[_0x242a00(0x197)](_0x242a00(0x1a7));}async['createPayment'](_0x8bd7b4){const _0x452db5=a52_0x14d6bb,{orderId:_0x1a8f3f,amount:_0x2224a0,currency:_0xaaff9b,productName:_0x1047b9,description:_0x1b6637,successUrl:_0x7f0358,failUrl:_0x10cae5,customerEmail:_0x4e4ac6,customerName:_0xb099e,isSourceCurrency:_0x53cb9f,sourceCurrency:_0x2520bc}=_0x8bd7b4;if(!this[_0x452db5(0x1d5)])throw new Error('Plisio\x20API\x20key\x20is\x20not\x20configured');const _0x33fa22=new URLSearchParams({'api_key':this[_0x452db5(0x1d5)],'order_number':_0x1a8f3f,'order_name':_0x1047b9,'description':_0x1b6637,'success_url':_0x7f0358,'fail_url':_0x10cae5,'callback_url':_0x452db5(0x18f)});_0x2520bc?(_0x33fa22[_0x452db5(0x19f)](_0x452db5(0x17e),_0x2520bc),_0x33fa22[_0x452db5(0x19f)](_0x452db5(0x1b5),_0xaaff9b),_0x33fa22[_0x452db5(0x19f)](_0x452db5(0x173),_0x2224a0[_0x452db5(0x1d7)]())):(_0x33fa22[_0x452db5(0x19f)]('currency',_0xaaff9b),_0x33fa22[_0x452db5(0x19f)](_0x452db5(0x1b1),_0x2224a0[_0x452db5(0x1d7)]()));_0x4e4ac6&&_0x33fa22[_0x452db5(0x19f)]('email',_0x4e4ac6);_0xb099e&&_0x33fa22['append'](_0x452db5(0x1b2),_0xb099e);const _0x40a4c4=this[_0x452db5(0x1bc)]+'?'+_0x33fa22[_0x452db5(0x1d7)](),_0x122394=Date[_0x452db5(0x1bd)]();try{console[_0x452db5(0x197)](_0x452db5(0x1da)),console[_0x452db5(0x197)](_0x452db5(0x1c5),this[_0x452db5(0x1bc)]),console['log']('Parameters:',Object[_0x452db5(0x1ba)](_0x33fa22[_0x452db5(0x1b7)]())),console[_0x452db5(0x197)](_0x452db5(0x174),_0x40a4c4[_0x452db5(0x192)](this[_0x452db5(0x1d5)],_0x452db5(0x16d))),loggerService_1[_0x452db5(0x1b3)][_0x452db5(0x1b4)]('plisio_direct',_0x452db5(0x1a0),_0x452db5(0x1ab),Object['fromEntries'](_0x33fa22['entries']()));const _0x2a2d93=await fetch(_0x40a4c4,{'method':_0x452db5(0x1ab),'headers':{'Accept':_0x452db5(0x1b9),'User-Agent':_0x452db5(0x1db)}}),_0x1baf96=Date['now']()-_0x122394;console[_0x452db5(0x197)](_0x452db5(0x199)),console[_0x452db5(0x197)]('Status:',_0x2a2d93[_0x452db5(0x1c2)]),console[_0x452db5(0x197)]('Status\x20Text:',_0x2a2d93[_0x452db5(0x179)]),console['log'](_0x452db5(0x1a1),_0x1baf96+'ms');const _0x7950ad=await _0x2a2d93[_0x452db5(0x19d)]();console[_0x452db5(0x197)]('Raw\x20Response\x20Body:',_0x7950ad);if(!_0x2a2d93['ok']){console[_0x452db5(0x1b6)]('===\x20PLISIO\x20API\x20ERROR\x20==='),console[_0x452db5(0x1b6)](_0x452db5(0x18a),_0x2a2d93[_0x452db5(0x1c2)]),console[_0x452db5(0x1b6)](_0x452db5(0x1c9),_0x7950ad),loggerService_1[_0x452db5(0x1b3)][_0x452db5(0x1cb)]('plisio_direct',_0x452db5(0x1a0),_0x2a2d93[_0x452db5(0x1c2)],_0x7950ad,_0x1baf96),loggerService_1[_0x452db5(0x1b3)][_0x452db5(0x17d)](_0x452db5(0x1d6),_0x452db5(0x1a0),'HTTP\x20'+_0x2a2d93[_0x452db5(0x1c2)]+':\x20'+_0x7950ad);throw new Error('HTTP\x20error!\x20status:\x20'+_0x2a2d93[_0x452db5(0x1c2)]+_0x452db5(0x185)+_0x7950ad);}let _0x5f425b;try{_0x5f425b=JSON['parse'](_0x7950ad);}catch(_0x3c501c){console[_0x452db5(0x1b6)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x3c501c),loggerService_1['loggerService'][_0x452db5(0x17d)](_0x452db5(0x1d6),'/invoices/new',_0x452db5(0x194)+_0x3c501c);throw new Error(_0x452db5(0x19b)+_0x7950ad);}console['log'](_0x452db5(0x1ae)),console['log'](_0x452db5(0x183),JSON['stringify'](_0x5f425b,null,0x2)),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x452db5(0x1d6),_0x452db5(0x1a0),_0x2a2d93['status'],_0x5f425b,_0x1baf96);if(_0x5f425b[_0x452db5(0x1c2)]!==_0x452db5(0x1a8)){const _0x536adc=_0x5f425b[_0x452db5(0x191)]||_0x5f425b['error']||_0x452db5(0x1bf);console[_0x452db5(0x1b6)](_0x452db5(0x172)),console[_0x452db5(0x1b6)](_0x452db5(0x19a),_0x536adc),loggerService_1['loggerService'][_0x452db5(0x17d)]('plisio_direct',_0x452db5(0x1a0),_0x452db5(0x1ce)+_0x536adc);throw new Error(_0x452db5(0x187)+_0x536adc);}if(!_0x5f425b[_0x452db5(0x196)]?.[_0x452db5(0x16a)]||!_0x5f425b[_0x452db5(0x196)]?.[_0x452db5(0x1a2)]){console[_0x452db5(0x1b6)](_0x452db5(0x17b)),console[_0x452db5(0x1b6)]('Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response'),console[_0x452db5(0x1b6)](_0x452db5(0x1a5),_0x5f425b[_0x452db5(0x196)]),loggerService_1[_0x452db5(0x1b3)]['logWhiteDomainError'](_0x452db5(0x1d6),_0x452db5(0x1a0),_0x452db5(0x1cc));throw new Error(_0x452db5(0x1c6));}return console[_0x452db5(0x197)](_0x452db5(0x16c)),console[_0x452db5(0x197)]('Transaction\x20ID:',_0x5f425b[_0x452db5(0x196)]['txn_id']),console[_0x452db5(0x197)]('Invoice\x20URL:',_0x5f425b[_0x452db5(0x196)]['invoice_url']),console[_0x452db5(0x197)](_0x452db5(0x1d1),_0x2224a0,_0xaaff9b),_0x2520bc&&(console['log'](_0x452db5(0x1c4),_0x2520bc,_0x452db5(0x1d2)),console[_0x452db5(0x197)](_0x452db5(0x1c1),_0xaaff9b,_0x452db5(0x177))),{'gateway_payment_id':_0x5f425b['data'][_0x452db5(0x16a)],'payment_url':_0x5f425b[_0x452db5(0x196)]['invoice_url'],'invoice_total_sum':_0x5f425b[_0x452db5(0x196)]['invoice_total_sum'],'qr_code':_0x5f425b['data'][_0x452db5(0x1a9)],'qr_url':_0x5f425b[_0x452db5(0x196)][_0x452db5(0x178)]};}catch(_0x103bea){console[_0x452db5(0x1b6)]('===\x20PLISIO\x20SERVICE\x20ERROR\x20==='),console[_0x452db5(0x1b6)](_0x452db5(0x16b),_0x103bea),loggerService_1[_0x452db5(0x1b3)]['logWhiteDomainError'](_0x452db5(0x1d6),_0x452db5(0x1a0),_0x103bea);if(_0x103bea instanceof Error){console[_0x452db5(0x1b6)](_0x452db5(0x1af),_0x103bea[_0x452db5(0x191)]),console[_0x452db5(0x1b6)](_0x452db5(0x16f),_0x103bea[_0x452db5(0x1ad)]);throw new Error(_0x452db5(0x189)+_0x103bea[_0x452db5(0x191)]);}throw new Error(_0x452db5(0x18c));}}async[a52_0x14d6bb(0x1be)](_0xd157f0){const _0x2b9dc5=a52_0x14d6bb,_0x1a174a=Date[_0x2b9dc5(0x1bd)]();try{if(!this['apiKey'])throw new Error(_0x2b9dc5(0x1d4));const _0x80faef=new URLSearchParams({'api_key':this[_0x2b9dc5(0x1d5)],'txn_id':_0xd157f0}),_0xacc669='https://api.plisio.net/api/v1/operations/'+_0xd157f0+'?'+_0x80faef['toString']();loggerService_1[_0x2b9dc5(0x1b3)][_0x2b9dc5(0x1b4)](_0x2b9dc5(0x1d6),_0x2b9dc5(0x17c)+_0xd157f0,_0x2b9dc5(0x1ab),Object[_0x2b9dc5(0x1ba)](_0x80faef[_0x2b9dc5(0x1b7)]()));const _0x110b94=await fetch(_0xacc669,{'method':_0x2b9dc5(0x1ab),'headers':{'Accept':_0x2b9dc5(0x1b9),'User-Agent':_0x2b9dc5(0x1db)}}),_0x1a9881=Date[_0x2b9dc5(0x1bd)]()-_0x1a174a;if(!_0x110b94['ok']){const _0x3d206f=await _0x110b94[_0x2b9dc5(0x19d)]();loggerService_1[_0x2b9dc5(0x1b3)]['logWhiteDomainResponse']('plisio_direct',_0x2b9dc5(0x17c)+_0xd157f0,_0x110b94[_0x2b9dc5(0x1c2)],_0x3d206f,_0x1a9881);throw new Error(_0x2b9dc5(0x19e)+_0x110b94['status']);}const _0x3c556a=await _0x110b94['json']();loggerService_1[_0x2b9dc5(0x1b3)][_0x2b9dc5(0x1cb)](_0x2b9dc5(0x1d6),_0x2b9dc5(0x17c)+_0xd157f0,_0x110b94[_0x2b9dc5(0x1c2)],_0x3c556a,_0x1a9881);if(_0x3c556a[_0x2b9dc5(0x1c2)]!==_0x2b9dc5(0x1a8)){loggerService_1[_0x2b9dc5(0x1b3)]['logWhiteDomainError']('plisio_direct','/operations/'+_0xd157f0,'Plisio\x20API\x20error:\x20'+(_0x3c556a[_0x2b9dc5(0x191)]||_0x3c556a[_0x2b9dc5(0x1b6)]||_0x2b9dc5(0x180)));throw new Error('Plisio\x20API\x20error:\x20'+(_0x3c556a[_0x2b9dc5(0x191)]||_0x3c556a['error']||'Unknown\x20error'));}let _0x13af31='PENDING';return{'status':_0x13af31};}catch(_0x55fc8f){console['error'](_0x2b9dc5(0x18b),_0x55fc8f),loggerService_1[_0x2b9dc5(0x1b3)]['logWhiteDomainError'](_0x2b9dc5(0x1d6),_0x2b9dc5(0x17c)+_0xd157f0,_0x55fc8f);throw new Error(_0x2b9dc5(0x1d0)+(_0x55fc8f instanceof Error?_0x55fc8f[_0x2b9dc5(0x191)]:_0x2b9dc5(0x180)));}}async['processWebhook'](_0x4b84f7){const _0x3a3925=a52_0x14d6bb;console['log']('Processing\x20Plisio\x20webhook:',_0x4b84f7);let _0x50165c=_0x3a3925(0x1cf);switch(_0x4b84f7[_0x3a3925(0x1c2)]?.[_0x3a3925(0x1c7)]()){case _0x3a3925(0x1d8):case'mismatch':_0x50165c='PAID';break;case _0x3a3925(0x18e):_0x50165c=_0x3a3925(0x1c0);break;case _0x3a3925(0x1b6):case _0x3a3925(0x1a6):_0x50165c=_0x3a3925(0x181);break;case _0x3a3925(0x195):_0x50165c=_0x3a3925(0x1cf);break;case _0x3a3925(0x171):_0x50165c=_0x3a3925(0x182);break;default:_0x50165c=_0x3a3925(0x1cf);break;}let _0x1e7833;if(_0x4b84f7[_0x3a3925(0x186)])try{console['log']('üîó\x20Raw\x20tx_urls\x20from\x20Plisio:',_0x4b84f7[_0x3a3925(0x186)]);let _0x2e280a;if(typeof _0x4b84f7[_0x3a3925(0x186)]===_0x3a3925(0x184))_0x2e280a=JSON[_0x3a3925(0x19c)](_0x4b84f7[_0x3a3925(0x186)]);else Array[_0x3a3925(0x1c3)](_0x4b84f7['tx_urls'])?_0x2e280a=_0x4b84f7[_0x3a3925(0x186)]:_0x2e280a=[];_0x1e7833=_0x2e280a[_0x3a3925(0x1cd)](_0x340aab=>{const _0x5014cb=_0x3a3925,_0x2e3f4c=_0x340aab[_0x5014cb(0x192)](/\\/g,'');return console[_0x5014cb(0x197)](_0x5014cb(0x1ac)+_0x340aab+'\x20->\x20'+_0x2e3f4c),_0x2e3f4c;}),console['log'](_0x3a3925(0x1a4),_0x1e7833),_0x1e7833[_0x3a3925(0x1a3)]((_0x1862a7,_0xd1a746)=>{const _0x5eb03c=_0x3a3925;try{new URL(_0x1862a7),console[_0x5eb03c(0x197)]('‚úÖ\x20URL\x20'+(_0xd1a746+0x1)+_0x5eb03c(0x193)+_0x1862a7);}catch(_0x4f31ed){console['error']('‚ùå\x20URL\x20'+(_0xd1a746+0x1)+_0x5eb03c(0x170)+_0x1862a7,_0x4f31ed);}});}catch(_0x2c67a6){console['error'](_0x3a3925(0x1bb),_0x2c67a6),console['error'](_0x3a3925(0x1d9),_0x4b84f7[_0x3a3925(0x186)]),_0x1e7833=undefined;}return{'paymentId':_0x4b84f7[_0x3a3925(0x1b8)]||'','status':_0x50165c,'amount':_0x4b84f7['amount'],'currency':_0x4b84f7[_0x3a3925(0x17e)],'txUrls':_0x1e7833};}}exports[a52_0x14d6bb(0x175)]=PlisioService;