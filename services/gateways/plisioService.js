'use strict';const a41_0x409dcf=a41_0x7110;(function(_0x5a0803,_0x1be752){const _0x27ccf9=a41_0x7110,_0x200e89=_0x5a0803();while(!![]){try{const _0x1c6db7=-parseInt(_0x27ccf9(0xb1))/0x1*(-parseInt(_0x27ccf9(0xbf))/0x2)+parseInt(_0x27ccf9(0x8b))/0x3*(parseInt(_0x27ccf9(0xdd))/0x4)+-parseInt(_0x27ccf9(0x7d))/0x5*(parseInt(_0x27ccf9(0x9e))/0x6)+parseInt(_0x27ccf9(0xa8))/0x7+-parseInt(_0x27ccf9(0xa9))/0x8+-parseInt(_0x27ccf9(0xb7))/0x9+-parseInt(_0x27ccf9(0xcc))/0xa*(-parseInt(_0x27ccf9(0xd7))/0xb);if(_0x1c6db7===_0x1be752)break;else _0x200e89['push'](_0x200e89['shift']());}catch(_0x545a7e){_0x200e89['push'](_0x200e89['shift']());}}}(a41_0x593a,0x3f805));Object[a41_0x409dcf(0xd4)](exports,'__esModule',{'value':!![]}),exports[a41_0x409dcf(0xb3)]=void 0x0;function a41_0x593a(){const _0xa7849d=['(crypto\x20for\x20payment)','EXPIRED','https://api.plisio.net/api/v1/operations/','10bwIzhC','Response\x20data:','new','Response\x20Time:','application/json','createPayment','logWhiteDomainResponse','plisio_direct','defineProperty','tx_urls','log','2142734Kgthzq','Failed\x20to\x20parse\x20JSON\x20response:','Unknown\x20error','completed','pending','error','76XuTKQj','‚úÖ\x20URL\x20','map','/operations/','data','invoice_total_sum','invoice_url','txn_id','verifyPayment','logWhiteDomainRequest','replace','forEach','GET','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','json','Failed\x20to\x20create\x20Plisio\x20payment:\x20','Parsed\x20Result:','Error\x20details:','‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','5WlFWUN','JSON\x20Parse\x20Error:\x20','(fiat\x20for\x20merchant)','apiKey','now','expired','message','PLISIO_API_KEY','Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url','success','source_amount','warn','üîó\x20Formatted\x20URL:\x20','Parameters:','37857JXbFMj','Transaction\x20ID:','text','/invoices/new','Business\x20Error:\x20','Amount:','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','status','qr_code','qr_url','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','fromEntries','Plisio\x20API\x20error:\x20','append','Invoice\x20URL:','apiUrl','HIDDEN','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','currency','1425498SSxIjb','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','email','string','\x20is\x20valid:\x20','https://api.plisio.net/api/v1/invoices/new','logWhiteDomainError','loggerService','üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','statusText','2349571tmqjEe','130304xyyYkB','processWebhook','Error\x20message:','‚ùå\x20URL\x20','HTTP\x20Status:','Raw\x20tx_urls\x20data:','cancelled','order_number','512zRQJNh','Raw\x20Response\x20Body:','PlisioService','mismatch','TesSoft\x20Payment\x20System/1.0','Status:','4153932QDyjnH','entries','HTTP\x20error!\x20status:\x20','Status\x20Text:','toLowerCase','isArray','Error\x20Message:','parse','802EPzRxX',',\x20body:\x20','Plisio\x20API\x20key\x20is\x20not\x20configured','Error\x20stack:','PENDING','toString','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','Unknown\x20error\x20from\x20Plisio\x20API','stack','source_currency'];a41_0x593a=function(){return _0xa7849d;};return a41_0x593a();}function a41_0x7110(_0x4e396b,_0x1e1b5c){const _0x593abd=a41_0x593a();return a41_0x7110=function(_0x71102c,_0x215ee3){_0x71102c=_0x71102c-0x77;let _0x2e963d=_0x593abd[_0x71102c];return _0x2e963d;},a41_0x7110(_0x4e396b,_0x1e1b5c);}const loggerService_1=require('../loggerService');class PlisioService{constructor(){const _0x427b58=a41_0x409dcf;this['apiUrl']=_0x427b58(0xa3),this[_0x427b58(0x80)]=process['env'][_0x427b58(0x84)]||'',!this[_0x427b58(0x80)]?console[_0x427b58(0x88)](_0x427b58(0x7c)):console[_0x427b58(0xd6)](_0x427b58(0xa6));}async[a41_0x409dcf(0xd1)](_0x2ae569){const _0x5740a8=a41_0x409dcf,{orderId:_0x72aadd,amount:_0x2b9633,currency:_0x44a9ac,productName:_0x12c9f1,description:_0x39f3cd,successUrl:_0x4a937b,failUrl:_0x4d2428,customerEmail:_0x203b4a,customerName:_0x56bf76,isSourceCurrency:_0x253ba7,sourceCurrency:_0x3890d4}=_0x2ae569;if(!this['apiKey'])throw new Error(_0x5740a8(0xc1));const _0x729e75=new URLSearchParams({'api_key':this[_0x5740a8(0x80)],'order_number':_0x72aadd,'order_name':_0x12c9f1,'description':_0x39f3cd,'success_url':_0x4a937b,'fail_url':_0x4d2428,'callback_url':'https://apitest.trapay.uk/api/webhooks/gateway/plisio'});_0x3890d4?(_0x729e75[_0x5740a8(0x98)]('currency',_0x3890d4),_0x729e75[_0x5740a8(0x98)](_0x5740a8(0xc8),_0x44a9ac),_0x729e75['append'](_0x5740a8(0x87),_0x2b9633[_0x5740a8(0xc4)]())):(_0x729e75[_0x5740a8(0x98)](_0x5740a8(0x9d),_0x44a9ac),_0x729e75['append']('amount',_0x2b9633['toString']()));_0x203b4a&&_0x729e75[_0x5740a8(0x98)](_0x5740a8(0xa0),_0x203b4a);_0x56bf76&&_0x729e75[_0x5740a8(0x98)]('name',_0x56bf76);const _0x316b5a=this[_0x5740a8(0x9a)]+'?'+_0x729e75[_0x5740a8(0xc4)](),_0x2b96aa=Date[_0x5740a8(0x81)]();try{console[_0x5740a8(0xd6)]('===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20==='),console[_0x5740a8(0xd6)]('URL:',this[_0x5740a8(0x9a)]),console[_0x5740a8(0xd6)](_0x5740a8(0x8a),Object[_0x5740a8(0x96)](_0x729e75[_0x5740a8(0xb8)]())),console['log']('Full\x20URL\x20(without\x20API\x20key):',_0x316b5a['replace'](this[_0x5740a8(0x80)],_0x5740a8(0x9b))),loggerService_1[_0x5740a8(0xa5)][_0x5740a8(0xe6)]('plisio_direct',_0x5740a8(0x8e),'GET',Object['fromEntries'](_0x729e75[_0x5740a8(0xb8)]()));const _0xbcf7bb=await fetch(_0x316b5a,{'method':_0x5740a8(0xe9),'headers':{'Accept':_0x5740a8(0xd0),'User-Agent':_0x5740a8(0xb5)}}),_0x641349=Date['now']()-_0x2b96aa;console['log']('===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20==='),console[_0x5740a8(0xd6)](_0x5740a8(0xb6),_0xbcf7bb['status']),console['log'](_0x5740a8(0xba),_0xbcf7bb[_0x5740a8(0xa7)]),console[_0x5740a8(0xd6)](_0x5740a8(0xcf),_0x641349+'ms');const _0x39ebc1=await _0xbcf7bb[_0x5740a8(0x8d)]();console[_0x5740a8(0xd6)](_0x5740a8(0xb2),_0x39ebc1);if(!_0xbcf7bb['ok']){console[_0x5740a8(0xdc)]('===\x20PLISIO\x20API\x20ERROR\x20==='),console[_0x5740a8(0xdc)](_0x5740a8(0xad),_0xbcf7bb[_0x5740a8(0x92)]),console[_0x5740a8(0xdc)]('Response\x20Body:',_0x39ebc1),loggerService_1['loggerService'][_0x5740a8(0xd2)](_0x5740a8(0xd3),_0x5740a8(0x8e),_0xbcf7bb[_0x5740a8(0x92)],_0x39ebc1,_0x641349),loggerService_1[_0x5740a8(0xa5)][_0x5740a8(0xa4)](_0x5740a8(0xd3),_0x5740a8(0x8e),'HTTP\x20'+_0xbcf7bb['status']+':\x20'+_0x39ebc1);throw new Error(_0x5740a8(0xb9)+_0xbcf7bb[_0x5740a8(0x92)]+_0x5740a8(0xc0)+_0x39ebc1);}let _0x37b4a3;try{_0x37b4a3=JSON[_0x5740a8(0xbe)](_0x39ebc1);}catch(_0x232b77){console[_0x5740a8(0xdc)](_0x5740a8(0xd8),_0x232b77),loggerService_1[_0x5740a8(0xa5)][_0x5740a8(0xa4)](_0x5740a8(0xd3),_0x5740a8(0x8e),_0x5740a8(0x7e)+_0x232b77);throw new Error('Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20'+_0x39ebc1);}console['log'](_0x5740a8(0x91)),console[_0x5740a8(0xd6)](_0x5740a8(0x7a),JSON['stringify'](_0x37b4a3,null,0x2)),loggerService_1['loggerService'][_0x5740a8(0xd2)]('plisio_direct','/invoices/new',_0xbcf7bb[_0x5740a8(0x92)],_0x37b4a3,_0x641349);if(_0x37b4a3[_0x5740a8(0x92)]!==_0x5740a8(0x86)){const _0x6a320e=_0x37b4a3[_0x5740a8(0x83)]||_0x37b4a3[_0x5740a8(0xdc)]||_0x5740a8(0xc6);console[_0x5740a8(0xdc)](_0x5740a8(0x95)),console[_0x5740a8(0xdc)](_0x5740a8(0xbd),_0x6a320e),loggerService_1[_0x5740a8(0xa5)][_0x5740a8(0xa4)](_0x5740a8(0xd3),'/invoices/new',_0x5740a8(0x8f)+_0x6a320e);throw new Error(_0x5740a8(0x97)+_0x6a320e);}if(!_0x37b4a3[_0x5740a8(0xe1)]?.['txn_id']||!_0x37b4a3[_0x5740a8(0xe1)]?.[_0x5740a8(0xe3)]){console[_0x5740a8(0xdc)](_0x5740a8(0x77)),console[_0x5740a8(0xdc)](_0x5740a8(0x9c)),console[_0x5740a8(0xdc)](_0x5740a8(0xcd),_0x37b4a3[_0x5740a8(0xe1)]),loggerService_1[_0x5740a8(0xa5)][_0x5740a8(0xa4)](_0x5740a8(0xd3),_0x5740a8(0x8e),'Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url');throw new Error(_0x5740a8(0x85));}return console[_0x5740a8(0xd6)]('===\x20PLISIO\x20SUCCESS\x20==='),console[_0x5740a8(0xd6)](_0x5740a8(0x8c),_0x37b4a3['data'][_0x5740a8(0xe4)]),console[_0x5740a8(0xd6)](_0x5740a8(0x99),_0x37b4a3[_0x5740a8(0xe1)][_0x5740a8(0xe3)]),console[_0x5740a8(0xd6)](_0x5740a8(0x90),_0x2b9633,_0x44a9ac),_0x3890d4&&(console['log']('Source\x20Currency:',_0x3890d4,_0x5740a8(0xc9)),console['log']('Target\x20Currency:',_0x44a9ac,_0x5740a8(0x7f))),{'gateway_payment_id':_0x37b4a3['data'][_0x5740a8(0xe4)],'payment_url':_0x37b4a3[_0x5740a8(0xe1)][_0x5740a8(0xe3)],'invoice_total_sum':_0x37b4a3[_0x5740a8(0xe1)][_0x5740a8(0xe2)],'qr_code':_0x37b4a3['data'][_0x5740a8(0x93)],'qr_url':_0x37b4a3[_0x5740a8(0xe1)][_0x5740a8(0x94)]};}catch(_0x5cbf34){console['error']('===\x20PLISIO\x20SERVICE\x20ERROR\x20==='),console[_0x5740a8(0xdc)](_0x5740a8(0x7b),_0x5cbf34),loggerService_1[_0x5740a8(0xa5)][_0x5740a8(0xa4)](_0x5740a8(0xd3),_0x5740a8(0x8e),_0x5cbf34);if(_0x5cbf34 instanceof Error){console[_0x5740a8(0xdc)](_0x5740a8(0xab),_0x5cbf34['message']),console[_0x5740a8(0xdc)](_0x5740a8(0xc2),_0x5cbf34[_0x5740a8(0xc7)]);throw new Error(_0x5740a8(0x79)+_0x5cbf34['message']);}throw new Error(_0x5740a8(0xc5));}}async[a41_0x409dcf(0xe5)](_0x164d6f){const _0x19d82b=a41_0x409dcf,_0x1e5af0=Date[_0x19d82b(0x81)]();try{if(!this[_0x19d82b(0x80)])throw new Error(_0x19d82b(0xc1));const _0x3d4c35=new URLSearchParams({'api_key':this['apiKey'],'txn_id':_0x164d6f}),_0x31fd3b=_0x19d82b(0xcb)+_0x164d6f+'?'+_0x3d4c35[_0x19d82b(0xc4)]();loggerService_1[_0x19d82b(0xa5)][_0x19d82b(0xe6)](_0x19d82b(0xd3),_0x19d82b(0xe0)+_0x164d6f,_0x19d82b(0xe9),Object[_0x19d82b(0x96)](_0x3d4c35[_0x19d82b(0xb8)]()));const _0x5655bd=await fetch(_0x31fd3b,{'method':_0x19d82b(0xe9),'headers':{'Accept':'application/json','User-Agent':_0x19d82b(0xb5)}}),_0x57b1de=Date[_0x19d82b(0x81)]()-_0x1e5af0;if(!_0x5655bd['ok']){const _0x48d12e=await _0x5655bd[_0x19d82b(0x8d)]();loggerService_1[_0x19d82b(0xa5)]['logWhiteDomainResponse'](_0x19d82b(0xd3),_0x19d82b(0xe0)+_0x164d6f,_0x5655bd['status'],_0x48d12e,_0x57b1de);throw new Error('HTTP\x20error!\x20status:\x20'+_0x5655bd[_0x19d82b(0x92)]);}const _0x5d2630=await _0x5655bd[_0x19d82b(0x78)]();loggerService_1[_0x19d82b(0xa5)][_0x19d82b(0xd2)](_0x19d82b(0xd3),_0x19d82b(0xe0)+_0x164d6f,_0x5655bd[_0x19d82b(0x92)],_0x5d2630,_0x57b1de);if(_0x5d2630[_0x19d82b(0x92)]!==_0x19d82b(0x86)){loggerService_1[_0x19d82b(0xa5)][_0x19d82b(0xa4)](_0x19d82b(0xd3),_0x19d82b(0xe0)+_0x164d6f,_0x19d82b(0x97)+(_0x5d2630['message']||_0x5d2630[_0x19d82b(0xdc)]||_0x19d82b(0xd9)));throw new Error(_0x19d82b(0x97)+(_0x5d2630[_0x19d82b(0x83)]||_0x5d2630[_0x19d82b(0xdc)]||_0x19d82b(0xd9)));}let _0x102b18=_0x19d82b(0xc3);return{'status':_0x102b18};}catch(_0x48d1b4){console[_0x19d82b(0xdc)]('Plisio\x20payment\x20verification\x20error:',_0x48d1b4),loggerService_1[_0x19d82b(0xa5)][_0x19d82b(0xa4)](_0x19d82b(0xd3),'/operations/'+_0x164d6f,_0x48d1b4);throw new Error(_0x19d82b(0x9f)+(_0x48d1b4 instanceof Error?_0x48d1b4[_0x19d82b(0x83)]:_0x19d82b(0xd9)));}}async[a41_0x409dcf(0xaa)](_0x301d70){const _0x188935=a41_0x409dcf;console[_0x188935(0xd6)]('Processing\x20Plisio\x20webhook:',_0x301d70);let _0x4db516=_0x188935(0xc3);switch(_0x301d70[_0x188935(0x92)]?.[_0x188935(0xbb)]()){case _0x188935(0xda):case _0x188935(0xb4):_0x4db516='PAID';break;case _0x188935(0x82):_0x4db516=_0x188935(0xca);break;case _0x188935(0xdc):case _0x188935(0xaf):_0x4db516='FAILED';break;case _0x188935(0xce):case _0x188935(0xdb):default:_0x4db516='PENDING';break;}let _0x4ea326;if(_0x301d70['tx_urls'])try{console[_0x188935(0xd6)]('üîó\x20Raw\x20tx_urls\x20from\x20Plisio:',_0x301d70[_0x188935(0xd5)]);let _0x391be1;if(typeof _0x301d70[_0x188935(0xd5)]===_0x188935(0xa1))_0x391be1=JSON['parse'](_0x301d70[_0x188935(0xd5)]);else Array[_0x188935(0xbc)](_0x301d70[_0x188935(0xd5)])?_0x391be1=_0x301d70[_0x188935(0xd5)]:_0x391be1=[];_0x4ea326=_0x391be1[_0x188935(0xdf)](_0x2dec6b=>{const _0x28e301=_0x188935,_0x454af3=_0x2dec6b[_0x28e301(0xe7)](/\\/g,'');return console['log'](_0x28e301(0x89)+_0x2dec6b+'\x20->\x20'+_0x454af3),_0x454af3;}),console[_0x188935(0xd6)]('‚úÖ\x20Processed\x20tx_urls:',_0x4ea326),_0x4ea326[_0x188935(0xe8)]((_0x4d192f,_0x4acb1a)=>{const _0x2583a7=_0x188935;try{new URL(_0x4d192f),console[_0x2583a7(0xd6)](_0x2583a7(0xde)+(_0x4acb1a+0x1)+_0x2583a7(0xa2)+_0x4d192f);}catch(_0x5e7bdc){console[_0x2583a7(0xdc)](_0x2583a7(0xac)+(_0x4acb1a+0x1)+'\x20is\x20invalid:\x20'+_0x4d192f,_0x5e7bdc);}});}catch(_0x500a53){console[_0x188935(0xdc)]('‚ùå\x20Failed\x20to\x20parse\x20tx_urls:',_0x500a53),console[_0x188935(0xdc)](_0x188935(0xae),_0x301d70[_0x188935(0xd5)]),_0x4ea326=undefined;}return{'paymentId':_0x301d70[_0x188935(0xb0)]||'','status':_0x4db516,'amount':_0x301d70['amount'],'currency':_0x301d70[_0x188935(0x9d)],'txUrls':_0x4ea326};}}exports[a41_0x409dcf(0xb3)]=PlisioService;