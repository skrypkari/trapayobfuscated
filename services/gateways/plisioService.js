'use strict';function a51_0x430f(_0x28438f,_0x2cab5c){const _0x56bc5f=a51_0x56bc();return a51_0x430f=function(_0x430fef,_0x4aad6f){_0x430fef=_0x430fef-0xb2;let _0x3ffd58=_0x56bc5f[_0x430fef];return _0x3ffd58;},a51_0x430f(_0x28438f,_0x2cab5c);}const a51_0x5d8dd0=a51_0x430f;(function(_0x18e3ad,_0x208916){const _0x1b254f=a51_0x430f,_0x595ea6=_0x18e3ad();while(!![]){try{const _0x4b6bdc=parseInt(_0x1b254f(0xeb))/0x1+parseInt(_0x1b254f(0x11a))/0x2+-parseInt(_0x1b254f(0x10a))/0x3*(parseInt(_0x1b254f(0xb6))/0x4)+parseInt(_0x1b254f(0xe2))/0x5*(parseInt(_0x1b254f(0x102))/0x6)+-parseInt(_0x1b254f(0xfc))/0x7*(-parseInt(_0x1b254f(0xe6))/0x8)+-parseInt(_0x1b254f(0xcc))/0x9*(parseInt(_0x1b254f(0xe3))/0xa)+parseInt(_0x1b254f(0xce))/0xb*(-parseInt(_0x1b254f(0xb3))/0xc);if(_0x4b6bdc===_0x208916)break;else _0x595ea6['push'](_0x595ea6['shift']());}catch(_0x1b592e){_0x595ea6['push'](_0x595ea6['shift']());}}}(a51_0x56bc,0x6e396));Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a51_0x5d8dd0(0xb4)]=void 0x0;const loggerService_1=require(a51_0x5d8dd0(0x106));class PlisioService{constructor(){const _0x14a257=a51_0x5d8dd0;this[_0x14a257(0x116)]='https://api.plisio.net/api/v1/invoices/new',this[_0x14a257(0x118)]=process[_0x14a257(0x114)][_0x14a257(0xd4)]||'',!this['apiKey']?console[_0x14a257(0x112)]('⚠️\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables'):console[_0x14a257(0xdd)](_0x14a257(0xdf));}async[a51_0x5d8dd0(0xf6)](_0x571f40){const _0x2971dc=a51_0x5d8dd0,{orderId:_0x333110,amount:_0x160c0f,currency:_0x1301bd,productName:_0x4b1f69,description:_0x3d8408,successUrl:_0x294b04,failUrl:_0x37521b,customerEmail:_0x17898a,customerName:_0x499a17,isSourceCurrency:_0x5cba8f,sourceCurrency:_0x429585}=_0x571f40;if(!this[_0x2971dc(0x118)])throw new Error('Plisio\x20API\x20key\x20is\x20not\x20configured');const _0x58dc5a=new URLSearchParams({'api_key':this[_0x2971dc(0x118)],'order_number':_0x333110,'order_name':_0x4b1f69,'description':_0x3d8408,'success_url':_0x294b04,'fail_url':_0x37521b,'callback_url':_0x2971dc(0x101)});_0x429585?(_0x58dc5a['append'](_0x2971dc(0x10c),_0x429585),_0x58dc5a[_0x2971dc(0x10d)](_0x2971dc(0xb2),_0x1301bd),_0x58dc5a['append']('source_amount',_0x160c0f[_0x2971dc(0x103)]())):(_0x58dc5a[_0x2971dc(0x10d)](_0x2971dc(0x10c),_0x1301bd),_0x58dc5a[_0x2971dc(0x10d)](_0x2971dc(0x11f),_0x160c0f[_0x2971dc(0x103)]()));_0x17898a&&_0x58dc5a['append'](_0x2971dc(0xc5),_0x17898a);_0x499a17&&_0x58dc5a[_0x2971dc(0x10d)](_0x2971dc(0xc1),_0x499a17);const _0x3eacb2=this['apiUrl']+'?'+_0x58dc5a[_0x2971dc(0x103)](),_0x112482=Date['now']();try{console[_0x2971dc(0xdd)](_0x2971dc(0xbe)),console[_0x2971dc(0xdd)](_0x2971dc(0x10f),this[_0x2971dc(0x116)]),console['log'](_0x2971dc(0x117),Object['fromEntries'](_0x58dc5a[_0x2971dc(0xed)]())),console['log'](_0x2971dc(0xf9),_0x3eacb2[_0x2971dc(0xd7)](this['apiKey'],_0x2971dc(0x11e))),loggerService_1['loggerService'][_0x2971dc(0xda)](_0x2971dc(0xea),_0x2971dc(0x111),_0x2971dc(0x110),Object[_0x2971dc(0xc3)](_0x58dc5a[_0x2971dc(0xed)]()));const _0x3d72f0=await fetch(_0x3eacb2,{'method':_0x2971dc(0x110),'headers':{'Accept':_0x2971dc(0x11d),'User-Agent':_0x2971dc(0xd5)}}),_0x2ef9e4=Date[_0x2971dc(0xf0)]()-_0x112482;console[_0x2971dc(0xdd)](_0x2971dc(0xbf)),console[_0x2971dc(0xdd)]('Status:',_0x3d72f0[_0x2971dc(0x121)]),console[_0x2971dc(0xdd)](_0x2971dc(0xfe),_0x3d72f0['statusText']),console[_0x2971dc(0xdd)](_0x2971dc(0xe4),_0x2ef9e4+'ms');const _0x1eb250=await _0x3d72f0[_0x2971dc(0xe8)]();console[_0x2971dc(0xdd)](_0x2971dc(0xba),_0x1eb250);if(!_0x3d72f0['ok']){console['error']('===\x20PLISIO\x20API\x20ERROR\x20==='),console['error']('HTTP\x20Status:',_0x3d72f0[_0x2971dc(0x121)]),console['error'](_0x2971dc(0xf7),_0x1eb250),loggerService_1[_0x2971dc(0x107)][_0x2971dc(0xd3)](_0x2971dc(0xea),_0x2971dc(0x111),_0x3d72f0['status'],_0x1eb250,_0x2ef9e4),loggerService_1[_0x2971dc(0x107)][_0x2971dc(0xc7)](_0x2971dc(0xea),'/invoices/new','HTTP\x20'+_0x3d72f0['status']+':\x20'+_0x1eb250);throw new Error('HTTP\x20error!\x20status:\x20'+_0x3d72f0[_0x2971dc(0x121)]+_0x2971dc(0x108)+_0x1eb250);}let _0x319eda;try{_0x319eda=JSON[_0x2971dc(0x115)](_0x1eb250);}catch(_0xaae54d){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0xaae54d),loggerService_1[_0x2971dc(0x107)][_0x2971dc(0xc7)](_0x2971dc(0xea),'/invoices/new','JSON\x20Parse\x20Error:\x20'+_0xaae54d);throw new Error(_0x2971dc(0xd6)+_0x1eb250);}console['log'](_0x2971dc(0xc4)),console['log'](_0x2971dc(0xec),JSON[_0x2971dc(0xc0)](_0x319eda,null,0x2)),loggerService_1[_0x2971dc(0x107)][_0x2971dc(0xd3)]('plisio_direct',_0x2971dc(0x111),_0x3d72f0['status'],_0x319eda,_0x2ef9e4);if(_0x319eda['status']!==_0x2971dc(0xbb)){const _0x126543=_0x319eda[_0x2971dc(0xde)]||_0x319eda['error']||'Unknown\x20error\x20from\x20Plisio\x20API';console[_0x2971dc(0xd9)]('===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x2971dc(0xd9)]('Error\x20Message:',_0x126543),loggerService_1[_0x2971dc(0x107)][_0x2971dc(0xc7)](_0x2971dc(0xea),_0x2971dc(0x111),_0x2971dc(0xc8)+_0x126543);throw new Error(_0x2971dc(0x113)+_0x126543);}if(!_0x319eda[_0x2971dc(0xd1)]?.[_0x2971dc(0xfd)]||!_0x319eda[_0x2971dc(0xd1)]?.['invoice_url']){console[_0x2971dc(0xd9)](_0x2971dc(0xcb)),console[_0x2971dc(0xd9)](_0x2971dc(0xd8)),console[_0x2971dc(0xd9)](_0x2971dc(0xc2),_0x319eda[_0x2971dc(0xd1)]),loggerService_1[_0x2971dc(0x107)][_0x2971dc(0xc7)]('plisio_direct',_0x2971dc(0x111),'Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url');throw new Error('Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url');}return console[_0x2971dc(0xdd)](_0x2971dc(0xf4)),console['log'](_0x2971dc(0xfa),_0x319eda[_0x2971dc(0xd1)][_0x2971dc(0xfd)]),console['log'](_0x2971dc(0x11b),_0x319eda[_0x2971dc(0xd1)]['invoice_url']),console[_0x2971dc(0xdd)]('Amount:',_0x160c0f,_0x1301bd),_0x429585&&(console[_0x2971dc(0xdd)](_0x2971dc(0xb5),_0x429585,'(crypto\x20for\x20payment)'),console[_0x2971dc(0xdd)](_0x2971dc(0xe0),_0x1301bd,_0x2971dc(0xd0))),{'gateway_payment_id':_0x319eda[_0x2971dc(0xd1)][_0x2971dc(0xfd)],'payment_url':_0x319eda[_0x2971dc(0xd1)][_0x2971dc(0x105)],'invoice_total_sum':_0x319eda[_0x2971dc(0xd1)][_0x2971dc(0xe9)],'qr_code':_0x319eda[_0x2971dc(0xd1)][_0x2971dc(0xee)],'qr_url':_0x319eda[_0x2971dc(0xd1)][_0x2971dc(0xd2)]};}catch(_0x24d3af){console[_0x2971dc(0xd9)](_0x2971dc(0xbd)),console[_0x2971dc(0xd9)](_0x2971dc(0x11c),_0x24d3af),loggerService_1[_0x2971dc(0x107)]['logWhiteDomainError'](_0x2971dc(0xea),_0x2971dc(0x111),_0x24d3af);if(_0x24d3af instanceof Error){console[_0x2971dc(0xd9)](_0x2971dc(0x109),_0x24d3af[_0x2971dc(0xde)]),console['error'](_0x2971dc(0x10e),_0x24d3af[_0x2971dc(0xdb)]);throw new Error(_0x2971dc(0xdc)+_0x24d3af[_0x2971dc(0xde)]);}throw new Error(_0x2971dc(0xf8));}}async[a51_0x5d8dd0(0x10b)](_0x17c6cf){const _0x220d67=a51_0x5d8dd0,_0x25ef06=Date[_0x220d67(0xf0)]();try{if(!this[_0x220d67(0x118)])throw new Error(_0x220d67(0xf5));const _0x205a7e=new URLSearchParams({'api_key':this[_0x220d67(0x118)],'txn_id':_0x17c6cf}),_0xa66fd2='https://api.plisio.net/api/v1/operations/'+_0x17c6cf+'?'+_0x205a7e[_0x220d67(0x103)]();loggerService_1[_0x220d67(0x107)][_0x220d67(0xda)](_0x220d67(0xea),_0x220d67(0x120)+_0x17c6cf,_0x220d67(0x110),Object['fromEntries'](_0x205a7e[_0x220d67(0xed)]()));const _0x23c092=await fetch(_0xa66fd2,{'method':_0x220d67(0x110),'headers':{'Accept':_0x220d67(0x11d),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x16d923=Date[_0x220d67(0xf0)]()-_0x25ef06;if(!_0x23c092['ok']){const _0x568a42=await _0x23c092[_0x220d67(0xe8)]();loggerService_1['loggerService'][_0x220d67(0xd3)]('plisio_direct',_0x220d67(0x120)+_0x17c6cf,_0x23c092[_0x220d67(0x121)],_0x568a42,_0x16d923);throw new Error('HTTP\x20error!\x20status:\x20'+_0x23c092[_0x220d67(0x121)]);}const _0x1d42ae=await _0x23c092[_0x220d67(0xbc)]();loggerService_1['loggerService'][_0x220d67(0xd3)](_0x220d67(0xea),_0x220d67(0x120)+_0x17c6cf,_0x23c092[_0x220d67(0x121)],_0x1d42ae,_0x16d923);if(_0x1d42ae['status']!==_0x220d67(0xbb)){loggerService_1[_0x220d67(0x107)]['logWhiteDomainError'](_0x220d67(0xea),'/operations/'+_0x17c6cf,_0x220d67(0x113)+(_0x1d42ae[_0x220d67(0xde)]||_0x1d42ae['error']||_0x220d67(0xb9)));throw new Error('Plisio\x20API\x20error:\x20'+(_0x1d42ae[_0x220d67(0xde)]||_0x1d42ae['error']||_0x220d67(0xb9)));}let _0x16296a=_0x220d67(0xf2);return{'status':_0x16296a};}catch(_0x128390){console[_0x220d67(0xd9)](_0x220d67(0xf1),_0x128390),loggerService_1['loggerService'][_0x220d67(0xc7)](_0x220d67(0xea),'/operations/'+_0x17c6cf,_0x128390);throw new Error('Failed\x20to\x20verify\x20Plisio\x20payment:\x20'+(_0x128390 instanceof Error?_0x128390[_0x220d67(0xde)]:'Unknown\x20error'));}}async['processWebhook'](_0x34032a){const _0x4fc356=a51_0x5d8dd0;console['log'](_0x4fc356(0xc9),_0x34032a);let _0x16dc75=_0x4fc356(0xf2);switch(_0x34032a[_0x4fc356(0x121)]?.[_0x4fc356(0xb8)]()){case _0x4fc356(0xe1):case _0x4fc356(0xe5):_0x16dc75=_0x4fc356(0xe7);break;case'expired':_0x16dc75=_0x4fc356(0x122);break;case _0x4fc356(0xd9):case'cancelled':_0x16dc75='FAILED';break;case _0x4fc356(0xff):_0x16dc75=_0x4fc356(0xf2);break;case _0x4fc356(0xf3):_0x16dc75=_0x4fc356(0xef);break;default:_0x16dc75=_0x4fc356(0xf2);break;}let _0x28b64b;if(_0x34032a[_0x4fc356(0xcd)])try{console[_0x4fc356(0xdd)](_0x4fc356(0xcf),_0x34032a[_0x4fc356(0xcd)]);let _0xa572f4;if(typeof _0x34032a['tx_urls']===_0x4fc356(0x104))_0xa572f4=JSON['parse'](_0x34032a[_0x4fc356(0xcd)]);else Array[_0x4fc356(0x119)](_0x34032a[_0x4fc356(0xcd)])?_0xa572f4=_0x34032a[_0x4fc356(0xcd)]:_0xa572f4=[];_0x28b64b=_0xa572f4['map'](_0x3dbcfa=>{const _0x15bec6=_0x4fc356,_0x192aff=_0x3dbcfa[_0x15bec6(0xd7)](/\\/g,'');return console[_0x15bec6(0xdd)]('🔗\x20Formatted\x20URL:\x20'+_0x3dbcfa+_0x15bec6(0xca)+_0x192aff),_0x192aff;}),console[_0x4fc356(0xdd)](_0x4fc356(0xb7),_0x28b64b),_0x28b64b['forEach']((_0x422449,_0x20ef50)=>{const _0x507ea1=_0x4fc356;try{new URL(_0x422449),console['log']('✅\x20URL\x20'+(_0x20ef50+0x1)+'\x20is\x20valid:\x20'+_0x422449);}catch(_0x130936){console[_0x507ea1(0xd9)](_0x507ea1(0xc6)+(_0x20ef50+0x1)+_0x507ea1(0x100)+_0x422449,_0x130936);}});}catch(_0x123eb7){console[_0x4fc356(0xd9)]('❌\x20Failed\x20to\x20parse\x20tx_urls:',_0x123eb7),console[_0x4fc356(0xd9)]('Raw\x20tx_urls\x20data:',_0x34032a[_0x4fc356(0xcd)]),_0x28b64b=undefined;}return{'paymentId':_0x34032a[_0x4fc356(0xfb)]||'','status':_0x16dc75,'amount':_0x34032a[_0x4fc356(0x11f)],'currency':_0x34032a[_0x4fc356(0x10c)],'txUrls':_0x28b64b};}}function a51_0x56bc(){const _0x3c97a0=['🔗\x20Raw\x20tx_urls\x20from\x20Plisio:','(fiat\x20for\x20merchant)','data','qr_url','logWhiteDomainResponse','PLISIO_API_KEY','TesSoft\x20Payment\x20System/1.0','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','replace','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','error','logWhiteDomainRequest','stack','Failed\x20to\x20create\x20Plisio\x20payment:\x20','log','message','💰\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API','Target\x20Currency:','completed','5wbkCAr','244050InECPL','Response\x20Time:','mismatch','56dIThYx','PAID','text','invoice_total_sum','plisio_direct','152854tuPlUD','Parsed\x20Result:','entries','qr_code','PROCESSING','now','Plisio\x20payment\x20verification\x20error:','PENDING','pending','===\x20PLISIO\x20SUCCESS\x20===','Plisio\x20API\x20key\x20is\x20not\x20configured','createPayment','Response\x20Body:','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','Full\x20URL\x20(without\x20API\x20key):','Transaction\x20ID:','order_number','589603BRXtpv','txn_id','Status\x20Text:','new','\x20is\x20invalid:\x20','https://api.trapay.uk/api/webhooks/gateway/plisio','3502578hDTCds','toString','string','invoice_url','../loggerService','loggerService',',\x20body:\x20','Error\x20message:','3vMRfHZ','verifyPayment','currency','append','Error\x20stack:','URL:','GET','/invoices/new','warn','Plisio\x20API\x20error:\x20','env','parse','apiUrl','Parameters:','apiKey','isArray','1138304epIUCA','Invoice\x20URL:','Error\x20details:','application/json','HIDDEN','amount','/operations/','status','EXPIRED','source_currency','60492rnfMSZ','PlisioService','Source\x20Currency:','965324bXPSFU','✅\x20Processed\x20tx_urls:','toLowerCase','Unknown\x20error','Raw\x20Response\x20Body:','success','json','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','stringify','name','Response\x20data:','fromEntries','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','email','❌\x20URL\x20','logWhiteDomainError','Business\x20Error:\x20','Processing\x20Plisio\x20webhook:','\x20->\x20','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','252pFAoog','tx_urls','1133UVXAiM'];a51_0x56bc=function(){return _0x3c97a0;};return a51_0x56bc();}exports[a51_0x5d8dd0(0xb4)]=PlisioService;