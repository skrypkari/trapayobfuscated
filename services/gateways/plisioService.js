'use strict';const a74_0x561e4f=a74_0x3aa7;function a74_0x4f13(){const _0x2eea21=['7950075fYSOHZ','Status:','HTTP\x20error!\x20status:\x20','===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20===','Plisio\x20payment\x20verification\x20error:','entries','isArray','amount','new','Error\x20Message:','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','stack','application/json','cancelled','apiUrl','toLowerCase','===\x20PLISIO\x20SUCCESS\x20===','logWhiteDomainResponse','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','email','map','toString','Plisio\x20API\x20key\x20is\x20not\x20configured','PENDING','2632990SbUjQB','logWhiteDomainRequest','error','FAILED','completed','/invoices/new','üîó\x20Raw\x20tx_urls\x20from\x20Plisio:','996574ifbbSB','source_currency','üîó\x20Formatted\x20URL:\x20','/operations/','message','stringify','HIDDEN','Payment\x20System/1.0','plisio_direct','===\x20PLISIO\x20API\x20ERROR\x20===','‚úÖ\x20Processed\x20tx_urls:','append','3180231yhEsEG','Response\x20Time:','(fiat\x20for\x20merchant)','json','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','Response\x20Body:','33CSKntO','__esModule','489yLzypD','‚úÖ\x20URL\x20','log','Plisio\x20API\x20error:\x20','forEach','Processing\x20Plisio\x20webhook:','28396oiPKhw','txn_id','\x20->\x20','statusText','now','status','invoice_url','apiKey',',\x20body:\x20','Target\x20Currency:','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','replace','data','\x20is\x20invalid:\x20','Unknown\x20error','HTTP\x20Status:','tx_urls','https://api.plisio.net/api/v1/invoices/new','Raw\x20Response\x20Body:','Error\x20message:','expired','16YzSDpJ','Parsed\x20Result:','qr_code','string','GET','processWebhook','text','fromEntries','loggerService','8652936UsMKJm','success','defineProperty','parse','Amount:','qr_url','https://api.plisio.net/api/v1/operations/','logWhiteDomainError','../loggerService','2usfZjz','name','PAID','3159805ifuzOI','‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables','===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20===','currency','invoice_total_sum'];a74_0x4f13=function(){return _0x2eea21;};return a74_0x4f13();}(function(_0x18b7f5,_0x370567){const _0x2b2b97=a74_0x3aa7,_0xfa4ec6=_0x18b7f5();while(!![]){try{const _0x5d3567=-parseInt(_0x2b2b97(0x20e))/0x1*(-parseInt(_0x2b2b97(0x1e6))/0x2)+parseInt(_0x2b2b97(0x222))/0x3*(-parseInt(_0x2b2b97(0x228))/0x4)+parseInt(_0x2b2b97(0x1e9))/0x5+parseInt(_0x2b2b97(0x1dd))/0x6+-parseInt(_0x2b2b97(0x1ee))/0x7+parseInt(_0x2b2b97(0x23d))/0x8*(-parseInt(_0x2b2b97(0x21a))/0x9)+-parseInt(_0x2b2b97(0x207))/0xa*(-parseInt(_0x2b2b97(0x220))/0xb);if(_0x5d3567===_0x370567)break;else _0xfa4ec6['push'](_0xfa4ec6['shift']());}catch(_0x2fa623){_0xfa4ec6['push'](_0xfa4ec6['shift']());}}}(a74_0x4f13,0xd2350));Object[a74_0x561e4f(0x1df)](exports,a74_0x561e4f(0x221),{'value':!![]}),exports['PlisioService']=void 0x0;const loggerService_1=require(a74_0x561e4f(0x1e5));class PlisioService{constructor(){const _0x2e33d2=a74_0x561e4f;this[_0x2e33d2(0x1fc)]=_0x2e33d2(0x239),this[_0x2e33d2(0x22f)]=process.env.PLISIO_API_KEY||'',!this[_0x2e33d2(0x22f)]?console['warn'](_0x2e33d2(0x1ea)):console[_0x2e33d2(0x224)]('üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API');}async['createPayment'](_0x5e73df){const _0x41b6ee=a74_0x561e4f,{orderId:_0x2a6ec2,amount:_0x300fe2,currency:_0x2a7cd8,productName:_0x41e7c1,description:_0x197c0a,successUrl:_0x55f3e5,failUrl:_0x488983,customerEmail:_0x340a68,customerName:_0x54f852,isSourceCurrency:_0x59bb10,sourceCurrency:_0x3b8936}=_0x5e73df;if(!this[_0x41b6ee(0x22f)])throw new Error(_0x41b6ee(0x205));const _0x20cd99=new URLSearchParams({'api_key':this['apiKey'],'order_number':_0x2a6ec2,'order_name':_0x41e7c1,'description':_0x197c0a,'success_url':_0x55f3e5,'fail_url':_0x488983,'callback_url':'https://api.trapay.uk/api/webhooks/gateway/plisio'});_0x3b8936?(_0x20cd99['append'](_0x41b6ee(0x1ec),_0x3b8936),_0x20cd99[_0x41b6ee(0x219)](_0x41b6ee(0x20f),_0x2a7cd8),_0x20cd99['append']('source_amount',_0x300fe2['toString']())):(_0x20cd99['append'](_0x41b6ee(0x1ec),_0x2a7cd8),_0x20cd99[_0x41b6ee(0x219)](_0x41b6ee(0x1f5),_0x300fe2[_0x41b6ee(0x204)]()));_0x340a68&&_0x20cd99['append'](_0x41b6ee(0x202),_0x340a68);_0x54f852&&_0x20cd99[_0x41b6ee(0x219)](_0x41b6ee(0x1e7),_0x54f852);const _0x5ad99b=this[_0x41b6ee(0x1fc)]+'?'+_0x20cd99['toString'](),_0x3ef08b=Date[_0x41b6ee(0x22c)]();try{console['log'](_0x41b6ee(0x1f1)),console['log']('URL:',this[_0x41b6ee(0x1fc)]),console[_0x41b6ee(0x224)]('Parameters:',Object[_0x41b6ee(0x1db)](_0x20cd99[_0x41b6ee(0x1f3)]())),console[_0x41b6ee(0x224)]('Full\x20URL\x20(without\x20API\x20key):',_0x5ad99b[_0x41b6ee(0x233)](this[_0x41b6ee(0x22f)],_0x41b6ee(0x214))),loggerService_1[_0x41b6ee(0x1dc)][_0x41b6ee(0x208)]('plisio_direct',_0x41b6ee(0x20c),_0x41b6ee(0x241),Object['fromEntries'](_0x20cd99['entries']()));const _0x4d85f0=await fetch(_0x5ad99b,{'method':'GET','headers':{'Accept':_0x41b6ee(0x1fa),'User-Agent':_0x41b6ee(0x215)}}),_0x6cac45=Date[_0x41b6ee(0x22c)]()-_0x3ef08b;console[_0x41b6ee(0x224)]('===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20==='),console[_0x41b6ee(0x224)](_0x41b6ee(0x1ef),_0x4d85f0['status']),console[_0x41b6ee(0x224)]('Status\x20Text:',_0x4d85f0[_0x41b6ee(0x22b)]),console['log'](_0x41b6ee(0x21b),_0x6cac45+'ms');const _0x4fd692=await _0x4d85f0[_0x41b6ee(0x1da)]();console['log'](_0x41b6ee(0x23a),_0x4fd692);if(!_0x4d85f0['ok']){console['error'](_0x41b6ee(0x217)),console[_0x41b6ee(0x209)](_0x41b6ee(0x237),_0x4d85f0[_0x41b6ee(0x22d)]),console[_0x41b6ee(0x209)](_0x41b6ee(0x21f),_0x4fd692),loggerService_1[_0x41b6ee(0x1dc)][_0x41b6ee(0x1ff)](_0x41b6ee(0x216),'/invoices/new',_0x4d85f0['status'],_0x4fd692,_0x6cac45),loggerService_1[_0x41b6ee(0x1dc)][_0x41b6ee(0x1e4)](_0x41b6ee(0x216),_0x41b6ee(0x20c),'HTTP\x20'+_0x4d85f0[_0x41b6ee(0x22d)]+':\x20'+_0x4fd692);throw new Error(_0x41b6ee(0x1f0)+_0x4d85f0[_0x41b6ee(0x22d)]+_0x41b6ee(0x230)+_0x4fd692);}let _0x49335c;try{_0x49335c=JSON[_0x41b6ee(0x1e0)](_0x4fd692);}catch(_0x377129){console[_0x41b6ee(0x209)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x377129),loggerService_1[_0x41b6ee(0x1dc)]['logWhiteDomainError'](_0x41b6ee(0x216),'/invoices/new','JSON\x20Parse\x20Error:\x20'+_0x377129);throw new Error(_0x41b6ee(0x232)+_0x4fd692);}console[_0x41b6ee(0x224)]('===\x20PARSED\x20PLISIO\x20RESPONSE\x20==='),console['log'](_0x41b6ee(0x23e),JSON[_0x41b6ee(0x213)](_0x49335c,null,0x2)),loggerService_1[_0x41b6ee(0x1dc)][_0x41b6ee(0x1ff)]('plisio_direct',_0x41b6ee(0x20c),_0x4d85f0[_0x41b6ee(0x22d)],_0x49335c,_0x6cac45);if(_0x49335c[_0x41b6ee(0x22d)]!==_0x41b6ee(0x1de)){const _0x163858=_0x49335c[_0x41b6ee(0x212)]||_0x49335c[_0x41b6ee(0x209)]||'Unknown\x20error\x20from\x20Plisio\x20API';console['error']('===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x41b6ee(0x209)](_0x41b6ee(0x1f7),_0x163858),loggerService_1[_0x41b6ee(0x1dc)][_0x41b6ee(0x1e4)]('plisio_direct',_0x41b6ee(0x20c),'Business\x20Error:\x20'+_0x163858);throw new Error(_0x41b6ee(0x225)+_0x163858);}if(!_0x49335c['data']?.[_0x41b6ee(0x229)]||!_0x49335c['data']?.[_0x41b6ee(0x22e)]){console[_0x41b6ee(0x209)](_0x41b6ee(0x1eb)),console[_0x41b6ee(0x209)](_0x41b6ee(0x201)),console[_0x41b6ee(0x209)]('Response\x20data:',_0x49335c[_0x41b6ee(0x234)]),loggerService_1[_0x41b6ee(0x1dc)]['logWhiteDomainError']('plisio_direct',_0x41b6ee(0x20c),_0x41b6ee(0x21e));throw new Error('Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url');}return console[_0x41b6ee(0x224)](_0x41b6ee(0x1fe)),console[_0x41b6ee(0x224)]('Transaction\x20ID:',_0x49335c[_0x41b6ee(0x234)]['txn_id']),console[_0x41b6ee(0x224)]('Invoice\x20URL:',_0x49335c[_0x41b6ee(0x234)][_0x41b6ee(0x22e)]),console[_0x41b6ee(0x224)](_0x41b6ee(0x1e1),_0x300fe2,_0x2a7cd8),_0x3b8936&&(console[_0x41b6ee(0x224)]('Source\x20Currency:',_0x3b8936,'(crypto\x20for\x20payment)'),console[_0x41b6ee(0x224)](_0x41b6ee(0x231),_0x2a7cd8,_0x41b6ee(0x21c))),{'gateway_payment_id':_0x49335c['data'][_0x41b6ee(0x229)],'payment_url':_0x49335c['data'][_0x41b6ee(0x22e)],'invoice_total_sum':_0x49335c[_0x41b6ee(0x234)][_0x41b6ee(0x1ed)],'qr_code':_0x49335c[_0x41b6ee(0x234)][_0x41b6ee(0x23f)],'qr_url':_0x49335c[_0x41b6ee(0x234)][_0x41b6ee(0x1e2)]};}catch(_0x402496){console[_0x41b6ee(0x209)](_0x41b6ee(0x1f8)),console[_0x41b6ee(0x209)]('Error\x20details:',_0x402496),loggerService_1[_0x41b6ee(0x1dc)][_0x41b6ee(0x1e4)](_0x41b6ee(0x216),_0x41b6ee(0x20c),_0x402496);if(_0x402496 instanceof Error){console[_0x41b6ee(0x209)](_0x41b6ee(0x23b),_0x402496[_0x41b6ee(0x212)]),console[_0x41b6ee(0x209)]('Error\x20stack:',_0x402496[_0x41b6ee(0x1f9)]);throw new Error('Failed\x20to\x20create\x20Plisio\x20payment:\x20'+_0x402496[_0x41b6ee(0x212)]);}throw new Error(_0x41b6ee(0x200));}}async['verifyPayment'](_0x489816){const _0x47ea54=a74_0x561e4f,_0x1776a9=Date[_0x47ea54(0x22c)]();try{if(!this[_0x47ea54(0x22f)])throw new Error(_0x47ea54(0x205));const _0x531541=new URLSearchParams({'api_key':this[_0x47ea54(0x22f)],'txn_id':_0x489816}),_0x495b56=_0x47ea54(0x1e3)+_0x489816+'?'+_0x531541[_0x47ea54(0x204)]();loggerService_1[_0x47ea54(0x1dc)][_0x47ea54(0x208)](_0x47ea54(0x216),_0x47ea54(0x211)+_0x489816,'GET',Object[_0x47ea54(0x1db)](_0x531541[_0x47ea54(0x1f3)]()));const _0x39e8ca=await fetch(_0x495b56,{'method':_0x47ea54(0x241),'headers':{'Accept':_0x47ea54(0x1fa),'User-Agent':_0x47ea54(0x215)}}),_0x240662=Date[_0x47ea54(0x22c)]()-_0x1776a9;if(!_0x39e8ca['ok']){const _0x711c8a=await _0x39e8ca['text']();loggerService_1[_0x47ea54(0x1dc)][_0x47ea54(0x1ff)](_0x47ea54(0x216),'/operations/'+_0x489816,_0x39e8ca[_0x47ea54(0x22d)],_0x711c8a,_0x240662);throw new Error(_0x47ea54(0x1f0)+_0x39e8ca[_0x47ea54(0x22d)]);}const _0x421240=await _0x39e8ca[_0x47ea54(0x21d)]();loggerService_1[_0x47ea54(0x1dc)]['logWhiteDomainResponse'](_0x47ea54(0x216),'/operations/'+_0x489816,_0x39e8ca[_0x47ea54(0x22d)],_0x421240,_0x240662);if(_0x421240[_0x47ea54(0x22d)]!==_0x47ea54(0x1de)){loggerService_1[_0x47ea54(0x1dc)][_0x47ea54(0x1e4)](_0x47ea54(0x216),_0x47ea54(0x211)+_0x489816,_0x47ea54(0x225)+(_0x421240[_0x47ea54(0x212)]||_0x421240[_0x47ea54(0x209)]||_0x47ea54(0x236)));throw new Error(_0x47ea54(0x225)+(_0x421240[_0x47ea54(0x212)]||_0x421240[_0x47ea54(0x209)]||_0x47ea54(0x236)));}let _0x56ea2a=_0x47ea54(0x206);return{'status':_0x56ea2a};}catch(_0x583270){console[_0x47ea54(0x209)](_0x47ea54(0x1f2),_0x583270),loggerService_1[_0x47ea54(0x1dc)][_0x47ea54(0x1e4)](_0x47ea54(0x216),'/operations/'+_0x489816,_0x583270);throw new Error('Failed\x20to\x20verify\x20Plisio\x20payment:\x20'+(_0x583270 instanceof Error?_0x583270[_0x47ea54(0x212)]:_0x47ea54(0x236)));}}async[a74_0x561e4f(0x242)](_0x42e352){const _0x1bef17=a74_0x561e4f;console[_0x1bef17(0x224)](_0x1bef17(0x227),_0x42e352);let _0x4a5791=_0x1bef17(0x206);switch(_0x42e352[_0x1bef17(0x22d)]?.[_0x1bef17(0x1fd)]()){case _0x1bef17(0x20b):case'mismatch':_0x4a5791=_0x1bef17(0x1e8);break;case _0x1bef17(0x23c):_0x4a5791='EXPIRED';break;case'error':case _0x1bef17(0x1fb):_0x4a5791=_0x1bef17(0x20a);break;case _0x1bef17(0x1f6):_0x4a5791=_0x1bef17(0x206);break;case'pending':_0x4a5791='PROCESSING';break;default:_0x4a5791=_0x1bef17(0x206);break;}let _0x627cb;if(_0x42e352[_0x1bef17(0x238)])try{console[_0x1bef17(0x224)](_0x1bef17(0x20d),_0x42e352[_0x1bef17(0x238)]);let _0x4ccd5d;if(typeof _0x42e352[_0x1bef17(0x238)]===_0x1bef17(0x240))_0x4ccd5d=JSON[_0x1bef17(0x1e0)](_0x42e352[_0x1bef17(0x238)]);else Array[_0x1bef17(0x1f4)](_0x42e352[_0x1bef17(0x238)])?_0x4ccd5d=_0x42e352[_0x1bef17(0x238)]:_0x4ccd5d=[];_0x627cb=_0x4ccd5d[_0x1bef17(0x203)](_0x1b30a2=>{const _0x502b47=_0x1bef17,_0x2ba31e=_0x1b30a2[_0x502b47(0x233)](/\\/g,'');return console[_0x502b47(0x224)](_0x502b47(0x210)+_0x1b30a2+_0x502b47(0x22a)+_0x2ba31e),_0x2ba31e;}),console[_0x1bef17(0x224)](_0x1bef17(0x218),_0x627cb),_0x627cb[_0x1bef17(0x226)]((_0x337782,_0xeb7619)=>{const _0x5bec8c=_0x1bef17;try{new URL(_0x337782),console[_0x5bec8c(0x224)](_0x5bec8c(0x223)+(_0xeb7619+0x1)+'\x20is\x20valid:\x20'+_0x337782);}catch(_0x2b8fef){console[_0x5bec8c(0x209)]('‚ùå\x20URL\x20'+(_0xeb7619+0x1)+_0x5bec8c(0x235)+_0x337782,_0x2b8fef);}});}catch(_0x408b07){console['error']('‚ùå\x20Failed\x20to\x20parse\x20tx_urls:',_0x408b07),console[_0x1bef17(0x209)]('Raw\x20tx_urls\x20data:',_0x42e352[_0x1bef17(0x238)]),_0x627cb=undefined;}return{'paymentId':_0x42e352['order_number']||'','status':_0x4a5791,'amount':_0x42e352[_0x1bef17(0x1f5)],'currency':_0x42e352[_0x1bef17(0x1ec)],'txUrls':_0x627cb};}}function a74_0x3aa7(_0x35bd36,_0x579e94){_0x35bd36=_0x35bd36-0x1da;const _0x4f13f4=a74_0x4f13();let _0x3aa75a=_0x4f13f4[_0x35bd36];return _0x3aa75a;}exports['PlisioService']=PlisioService;