'use strict';const a68_0xd91f1e=a68_0x2a59;(function(_0x3b3786,_0x723d87){const _0x5c44d3=a68_0x2a59,_0x2ff105=_0x3b3786();while(!![]){try{const _0x4f1974=parseInt(_0x5c44d3(0x125))/0x1*(-parseInt(_0x5c44d3(0x18a))/0x2)+parseInt(_0x5c44d3(0x183))/0x3*(-parseInt(_0x5c44d3(0x140))/0x4)+-parseInt(_0x5c44d3(0x17d))/0x5+-parseInt(_0x5c44d3(0x143))/0x6+parseInt(_0x5c44d3(0x175))/0x7+parseInt(_0x5c44d3(0x171))/0x8*(-parseInt(_0x5c44d3(0x154))/0x9)+-parseInt(_0x5c44d3(0x14b))/0xa*(-parseInt(_0x5c44d3(0x187))/0xb);if(_0x4f1974===_0x723d87)break;else _0x2ff105['push'](_0x2ff105['shift']());}catch(_0x5d88c5){_0x2ff105['push'](_0x2ff105['shift']());}}}(a68_0x48d8,0xe645c));function a68_0x2a59(_0x4c8181,_0x3b983c){_0x4c8181=_0x4c8181-0x121;const _0x48d8d0=a68_0x48d8();let _0x2a5946=_0x48d8d0[_0x4c8181];return _0x2a5946;}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a68_0xd91f1e(0x12f)]=void 0x0;const loggerService_1=require(a68_0xd91f1e(0x158));class PlisioService{constructor(){const _0x61f2ac=a68_0xd91f1e;this[_0x61f2ac(0x159)]=_0x61f2ac(0x155),this[_0x61f2ac(0x168)]=process.env.PLISIO_API_KEY||'',!this[_0x61f2ac(0x168)]?console['warn']('‚ö†Ô∏è\x20PLISIO_API_KEY\x20not\x20found\x20in\x20environment\x20variables'):console[_0x61f2ac(0x13a)]('üí∞\x20Plisio\x20service\x20initialized\x20with\x20direct\x20API');}async[a68_0xd91f1e(0x156)](_0x485563){const _0x577961=a68_0xd91f1e,{orderId:_0x2a2e5b,amount:_0x31288c,currency:_0x4e5cc9,productName:_0x36fcb8,description:_0x4ef334,successUrl:_0x145f1d,failUrl:_0x1c88e2,customerEmail:_0x3e57e7,customerName:_0x42f4ce,isSourceCurrency:_0x5c6888,sourceCurrency:_0x759dd9}=_0x485563;if(!this[_0x577961(0x168)])throw new Error(_0x577961(0x129));const _0x2537ff=new URLSearchParams({'api_key':this['apiKey'],'order_number':_0x2a2e5b,'order_name':_0x36fcb8,'description':_0x4ef334,'success_url':_0x145f1d,'fail_url':_0x1c88e2,'callback_url':_0x577961(0x166)});_0x759dd9?(_0x2537ff[_0x577961(0x121)](_0x577961(0x179),_0x759dd9),_0x2537ff[_0x577961(0x121)](_0x577961(0x17e),_0x4e5cc9),_0x2537ff[_0x577961(0x121)](_0x577961(0x180),_0x31288c[_0x577961(0x16e)]())):(_0x2537ff[_0x577961(0x121)]('currency',_0x4e5cc9),_0x2537ff[_0x577961(0x121)]('amount',_0x31288c[_0x577961(0x16e)]()));_0x3e57e7&&_0x2537ff['append'](_0x577961(0x136),_0x3e57e7);_0x42f4ce&&_0x2537ff['append'](_0x577961(0x190),_0x42f4ce);const _0x164612=this[_0x577961(0x159)]+'?'+_0x2537ff[_0x577961(0x16e)](),_0x1d98bd=Date[_0x577961(0x142)]();try{console[_0x577961(0x13a)]('===\x20PLISIO\x20DIRECT\x20API\x20REQUEST\x20==='),console[_0x577961(0x13a)]('URL:',this[_0x577961(0x159)]),console[_0x577961(0x13a)](_0x577961(0x165),Object[_0x577961(0x182)](_0x2537ff[_0x577961(0x138)]())),console[_0x577961(0x13a)](_0x577961(0x14a),_0x164612[_0x577961(0x174)](this[_0x577961(0x168)],_0x577961(0x170))),loggerService_1[_0x577961(0x16d)][_0x577961(0x13e)](_0x577961(0x162),'/invoices/new',_0x577961(0x15b),Object[_0x577961(0x182)](_0x2537ff[_0x577961(0x138)]()));const _0x26aa0d=await fetch(_0x164612,{'method':_0x577961(0x15b),'headers':{'Accept':'application/json','User-Agent':_0x577961(0x148)}}),_0x1cca93=Date[_0x577961(0x142)]()-_0x1d98bd;console[_0x577961(0x13a)](_0x577961(0x127)),console[_0x577961(0x13a)](_0x577961(0x192),_0x26aa0d[_0x577961(0x124)]),console[_0x577961(0x13a)](_0x577961(0x131),_0x26aa0d[_0x577961(0x13d)]),console[_0x577961(0x13a)](_0x577961(0x18b),_0x1cca93+'ms');const _0x26cacc=await _0x26aa0d['text']();console[_0x577961(0x13a)](_0x577961(0x141),_0x26cacc);if(!_0x26aa0d['ok']){console[_0x577961(0x178)](_0x577961(0x160)),console[_0x577961(0x178)](_0x577961(0x132),_0x26aa0d[_0x577961(0x124)]),console[_0x577961(0x178)]('Response\x20Body:',_0x26cacc),loggerService_1[_0x577961(0x16d)][_0x577961(0x144)]('plisio_direct',_0x577961(0x184),_0x26aa0d[_0x577961(0x124)],_0x26cacc,_0x1cca93),loggerService_1[_0x577961(0x16d)]['logWhiteDomainError']('plisio_direct','/invoices/new','HTTP\x20'+_0x26aa0d[_0x577961(0x124)]+':\x20'+_0x26cacc);throw new Error(_0x577961(0x17a)+_0x26aa0d[_0x577961(0x124)]+_0x577961(0x18d)+_0x26cacc);}let _0xfecd3e;try{_0xfecd3e=JSON['parse'](_0x26cacc);}catch(_0x3d2749){console[_0x577961(0x178)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x3d2749),loggerService_1[_0x577961(0x16d)][_0x577961(0x18f)](_0x577961(0x162),_0x577961(0x184),_0x577961(0x189)+_0x3d2749);throw new Error(_0x577961(0x13c)+_0x26cacc);}console[_0x577961(0x13a)](_0x577961(0x163)),console['log'](_0x577961(0x172),JSON[_0x577961(0x139)](_0xfecd3e,null,0x2)),loggerService_1['loggerService'][_0x577961(0x144)](_0x577961(0x162),_0x577961(0x184),_0x26aa0d['status'],_0xfecd3e,_0x1cca93);if(_0xfecd3e['status']!=='success'){const _0xd74b2c=_0xfecd3e[_0x577961(0x12c)]||_0xfecd3e[_0x577961(0x178)]||_0x577961(0x153);console[_0x577961(0x178)](_0x577961(0x122)),console[_0x577961(0x178)](_0x577961(0x17b),_0xd74b2c),loggerService_1[_0x577961(0x16d)][_0x577961(0x18f)](_0x577961(0x162),_0x577961(0x184),_0x577961(0x191)+_0xd74b2c);throw new Error(_0x577961(0x17c)+_0xd74b2c);}if(!_0xfecd3e[_0x577961(0x14c)]?.[_0x577961(0x135)]||!_0xfecd3e[_0x577961(0x14c)]?.['invoice_url']){console['error']('===\x20PLISIO\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console['error'](_0x577961(0x126)),console['error']('Response\x20data:',_0xfecd3e[_0x577961(0x14c)]),loggerService_1[_0x577961(0x16d)][_0x577961(0x18f)]('plisio_direct',_0x577961(0x184),_0x577961(0x169));throw new Error('Invalid\x20response\x20from\x20Plisio\x20API:\x20missing\x20txn_id\x20or\x20invoice_url');}return console['log'](_0x577961(0x152)),console[_0x577961(0x13a)](_0x577961(0x157),_0xfecd3e[_0x577961(0x14c)]['txn_id']),console['log'](_0x577961(0x145),_0xfecd3e[_0x577961(0x14c)]['invoice_url']),console[_0x577961(0x13a)](_0x577961(0x18e),_0x31288c,_0x4e5cc9),_0x759dd9&&(console[_0x577961(0x13a)](_0x577961(0x13b),_0x759dd9,_0x577961(0x161)),console[_0x577961(0x13a)](_0x577961(0x181),_0x4e5cc9,_0x577961(0x164))),{'gateway_payment_id':_0xfecd3e[_0x577961(0x14c)][_0x577961(0x135)],'payment_url':_0xfecd3e['data'][_0x577961(0x173)],'invoice_total_sum':_0xfecd3e[_0x577961(0x14c)][_0x577961(0x15d)],'qr_code':_0xfecd3e['data'][_0x577961(0x14e)],'qr_url':_0xfecd3e['data'][_0x577961(0x16a)]};}catch(_0x30d776){console[_0x577961(0x178)](_0x577961(0x146)),console[_0x577961(0x178)](_0x577961(0x12a),_0x30d776),loggerService_1['loggerService'][_0x577961(0x18f)]('plisio_direct',_0x577961(0x184),_0x30d776);if(_0x30d776 instanceof Error){console['error'](_0x577961(0x177),_0x30d776[_0x577961(0x12c)]),console['error'](_0x577961(0x15f),_0x30d776[_0x577961(0x133)]);throw new Error('Failed\x20to\x20create\x20Plisio\x20payment:\x20'+_0x30d776['message']);}throw new Error(_0x577961(0x14f));}}async['verifyPayment'](_0x29844b){const _0x5ef78b=a68_0xd91f1e,_0x25d020=Date['now']();try{if(!this[_0x5ef78b(0x168)])throw new Error(_0x5ef78b(0x129));const _0x5d2fc7=new URLSearchParams({'api_key':this[_0x5ef78b(0x168)],'txn_id':_0x29844b}),_0x45c2fb=_0x5ef78b(0x150)+_0x29844b+'?'+_0x5d2fc7[_0x5ef78b(0x16e)]();loggerService_1[_0x5ef78b(0x16d)][_0x5ef78b(0x13e)](_0x5ef78b(0x162),_0x5ef78b(0x130)+_0x29844b,'GET',Object[_0x5ef78b(0x182)](_0x5d2fc7['entries']()));const _0xe5e99c=await fetch(_0x45c2fb,{'method':_0x5ef78b(0x15b),'headers':{'Accept':_0x5ef78b(0x12d),'User-Agent':_0x5ef78b(0x148)}}),_0x1c1555=Date[_0x5ef78b(0x142)]()-_0x25d020;if(!_0xe5e99c['ok']){const _0x2e0809=await _0xe5e99c[_0x5ef78b(0x147)]();loggerService_1['loggerService'][_0x5ef78b(0x144)](_0x5ef78b(0x162),'/operations/'+_0x29844b,_0xe5e99c['status'],_0x2e0809,_0x1c1555);throw new Error(_0x5ef78b(0x17a)+_0xe5e99c[_0x5ef78b(0x124)]);}const _0x2de2b8=await _0xe5e99c[_0x5ef78b(0x16f)]();loggerService_1['loggerService']['logWhiteDomainResponse']('plisio_direct','/operations/'+_0x29844b,_0xe5e99c[_0x5ef78b(0x124)],_0x2de2b8,_0x1c1555);if(_0x2de2b8[_0x5ef78b(0x124)]!==_0x5ef78b(0x15e)){loggerService_1[_0x5ef78b(0x16d)][_0x5ef78b(0x18f)](_0x5ef78b(0x162),_0x5ef78b(0x130)+_0x29844b,_0x5ef78b(0x17c)+(_0x2de2b8[_0x5ef78b(0x12c)]||_0x2de2b8['error']||_0x5ef78b(0x18c)));throw new Error(_0x5ef78b(0x17c)+(_0x2de2b8[_0x5ef78b(0x12c)]||_0x2de2b8['error']||_0x5ef78b(0x18c)));}let _0x5a2519=_0x5ef78b(0x185);return{'status':_0x5a2519};}catch(_0x1270cf){console['error']('Plisio\x20payment\x20verification\x20error:',_0x1270cf),loggerService_1['loggerService'][_0x5ef78b(0x18f)](_0x5ef78b(0x162),_0x5ef78b(0x130)+_0x29844b,_0x1270cf);throw new Error(_0x5ef78b(0x137)+(_0x1270cf instanceof Error?_0x1270cf['message']:_0x5ef78b(0x18c)));}}async['processWebhook'](_0x3c5293){const _0x40aca3=a68_0xd91f1e;console[_0x40aca3(0x13a)]('Processing\x20Plisio\x20webhook:',_0x3c5293);let _0x49dd33='PENDING';switch(_0x3c5293['status']?.[_0x40aca3(0x128)]()){case _0x40aca3(0x13f):case'mismatch':_0x49dd33='PAID';break;case _0x40aca3(0x14d):_0x49dd33=_0x40aca3(0x149);break;case'error':case _0x40aca3(0x123):_0x49dd33=_0x40aca3(0x16c);break;case _0x40aca3(0x176):_0x49dd33=_0x40aca3(0x185);break;case _0x40aca3(0x188):_0x49dd33='PROCESSING';break;default:_0x49dd33=_0x40aca3(0x185);break;}let _0x4e4fb5;if(_0x3c5293[_0x40aca3(0x151)])try{console[_0x40aca3(0x13a)]('üîó\x20Raw\x20tx_urls\x20from\x20Plisio:',_0x3c5293[_0x40aca3(0x151)]);let _0xc61ed5;if(typeof _0x3c5293[_0x40aca3(0x151)]==='string')_0xc61ed5=JSON[_0x40aca3(0x16b)](_0x3c5293[_0x40aca3(0x151)]);else Array['isArray'](_0x3c5293['tx_urls'])?_0xc61ed5=_0x3c5293[_0x40aca3(0x151)]:_0xc61ed5=[];_0x4e4fb5=_0xc61ed5['map'](_0x2ab425=>{const _0x1be466=_0x40aca3,_0x490bd2=_0x2ab425[_0x1be466(0x174)](/\\/g,'');return console[_0x1be466(0x13a)](_0x1be466(0x15a)+_0x2ab425+'\x20->\x20'+_0x490bd2),_0x490bd2;}),console[_0x40aca3(0x13a)](_0x40aca3(0x12b),_0x4e4fb5),_0x4e4fb5[_0x40aca3(0x186)]((_0x149b50,_0x1cb6da)=>{const _0x3a64e8=_0x40aca3;try{new URL(_0x149b50),console['log'](_0x3a64e8(0x134)+(_0x1cb6da+0x1)+_0x3a64e8(0x17f)+_0x149b50);}catch(_0x136986){console['error']('‚ùå\x20URL\x20'+(_0x1cb6da+0x1)+_0x3a64e8(0x167)+_0x149b50,_0x136986);}});}catch(_0x16ad37){console[_0x40aca3(0x178)]('‚ùå\x20Failed\x20to\x20parse\x20tx_urls:',_0x16ad37),console[_0x40aca3(0x178)](_0x40aca3(0x12e),_0x3c5293['tx_urls']),_0x4e4fb5=undefined;}return{'paymentId':_0x3c5293[_0x40aca3(0x15c)]||'','status':_0x49dd33,'amount':_0x3c5293['amount'],'currency':_0x3c5293['currency'],'txUrls':_0x4e4fb5};}}exports[a68_0xd91f1e(0x12f)]=PlisioService;function a68_0x48d8(){const _0x580089=['txn_id','email','Failed\x20to\x20verify\x20Plisio\x20payment:\x20','entries','stringify','log','Source\x20Currency:','Invalid\x20JSON\x20response\x20from\x20Plisio\x20API:\x20','statusText','logWhiteDomainRequest','completed','164CtOCaB','Raw\x20Response\x20Body:','now','5474382HueNPv','logWhiteDomainResponse','Invoice\x20URL:','===\x20PLISIO\x20SERVICE\x20ERROR\x20===','text','Payment\x20System/1.0','EXPIRED','Full\x20URL\x20(without\x20API\x20key):','275570ZtWUIE','data','expired','qr_code','Failed\x20to\x20create\x20Plisio\x20payment:\x20Unknown\x20error','https://api.plisio.net/api/v1/operations/','tx_urls','===\x20PLISIO\x20SUCCESS\x20===','Unknown\x20error\x20from\x20Plisio\x20API','494523lTcUwH','https://api.plisio.net/api/v1/invoices/new','createPayment','Transaction\x20ID:','../loggerService','apiUrl','üîó\x20Formatted\x20URL:\x20','GET','order_number','invoice_total_sum','success','Error\x20stack:','===\x20PLISIO\x20API\x20ERROR\x20===','(crypto\x20for\x20payment)','plisio_direct','===\x20PARSED\x20PLISIO\x20RESPONSE\x20===','(fiat\x20for\x20merchant)','Parameters:','https://api.trapay.uk/api/webhooks/gateway/plisio','\x20is\x20invalid:\x20','apiKey','Incomplete\x20response:\x20missing\x20txn_id\x20or\x20invoice_url','qr_url','parse','FAILED','loggerService','toString','json','HIDDEN','152BkxzOQ','Parsed\x20Result:','invoice_url','replace','2104389RsHeAC','new','Error\x20message:','error','currency','HTTP\x20error!\x20status:\x20','Error\x20Message:','Plisio\x20API\x20error:\x20','2583640SrjxqA','source_currency','\x20is\x20valid:\x20','source_amount','Target\x20Currency:','fromEntries','26142SuNWNN','/invoices/new','PENDING','forEach','1507eSzYpy','pending','JSON\x20Parse\x20Error:\x20','1048MatXeD','Response\x20Time:','Unknown\x20error',',\x20body:\x20','Amount:','logWhiteDomainError','name','Business\x20Error:\x20','Status:','append','===\x20PLISIO\x20API\x20BUSINESS\x20ERROR\x20===','cancelled','status','577kMGopg','Missing\x20txn_id\x20or\x20invoice_url\x20in\x20response','===\x20PLISIO\x20DIRECT\x20API\x20RESPONSE\x20===','toLowerCase','Plisio\x20API\x20key\x20is\x20not\x20configured','Error\x20details:','‚úÖ\x20Processed\x20tx_urls:','message','application/json','Raw\x20tx_urls\x20data:','PlisioService','/operations/','Status\x20Text:','HTTP\x20Status:','stack','‚úÖ\x20URL\x20'];a68_0x48d8=function(){return _0x580089;};return a68_0x48d8();}