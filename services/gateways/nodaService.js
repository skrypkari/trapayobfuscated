'use strict';const a43_0x459b04=a43_0x13fe;(function(_0x40f465,_0x56f40f){const _0x2fbfec=a43_0x13fe,_0x125a30=_0x40f465();while(!![]){try{const _0x24a80b=-parseInt(_0x2fbfec(0x14d))/0x1+-parseInt(_0x2fbfec(0x11d))/0x2+-parseInt(_0x2fbfec(0x180))/0x3+parseInt(_0x2fbfec(0x120))/0x4+parseInt(_0x2fbfec(0x181))/0x5+parseInt(_0x2fbfec(0x17d))/0x6+-parseInt(_0x2fbfec(0x175))/0x7*(-parseInt(_0x2fbfec(0x153))/0x8);if(_0x24a80b===_0x56f40f)break;else _0x125a30['push'](_0x125a30['shift']());}catch(_0x25232f){_0x125a30['push'](_0x125a30['shift']());}}}(a43_0x2358,0x784f8));Object[a43_0x459b04(0x189)](exports,a43_0x459b04(0x182),{'value':!![]}),exports[a43_0x459b04(0x125)]=void 0x0;function a43_0x13fe(_0x335794,_0x313978){const _0x235854=a43_0x2358();return a43_0x13fe=function(_0x13fec4,_0x3bf1cc){_0x13fec4=_0x13fec4-0x11a;let _0x2e7f77=_0x235854[_0x13fec4];return _0x2e7f77;},a43_0x13fe(_0x335794,_0x313978);}const loggerService_1=require(a43_0x459b04(0x169));class NodaService{constructor(){const _0x3d243b=a43_0x459b04;this[_0x3d243b(0x148)]='https://tesoft.uk/gateway/noda/',console[_0x3d243b(0x145)](_0x3d243b(0x166));}async[a43_0x459b04(0x165)](_0x34f7ce){const _0x452fe5=a43_0x459b04,{orderId:_0x1cf21d,name:_0x15fdea,paymentDescription:_0x12c1ab,amount:_0xae2441,currency:_0x24382a,webhookUrl:_0x59d3ee,returnUrl:_0x365a65,expiryDate:_0x5b2b04}=_0x34f7ce,_0x4e2df6=_0x24382a[_0x452fe5(0x186)](),_0x2b8af7='https://tesoft.uk/gateway/noda/webhook/',_0x414ce9=_0x452fe5(0x128)+_0x1cf21d,_0x1941f1={'name':_0x15fdea,'paymentDescription':_0x12c1ab,'amount':_0xae2441,'currency':_0x4e2df6,'paymentId':_0x1cf21d,'webhookUrl':_0x2b8af7,'returnUrl':_0x414ce9};_0x5b2b04&&(_0x1941f1[_0x452fe5(0x14c)]=_0x5b2b04);const _0x18795c=Date[_0x452fe5(0x163)]();try{console[_0x452fe5(0x145)](_0x452fe5(0x178)),console[_0x452fe5(0x145)]('URL:',this[_0x452fe5(0x148)]),console['log']('Request\x20Body\x20(Direct\x20JSON):',JSON[_0x452fe5(0x13e)](_0x1941f1,null,0x2)),console[_0x452fe5(0x145)](_0x452fe5(0x162),_0x1cf21d,_0x452fe5(0x149)),console[_0x452fe5(0x145)](_0x452fe5(0x11f),_0x414ce9),loggerService_1[_0x452fe5(0x155)][_0x452fe5(0x170)](_0x452fe5(0x143),_0x452fe5(0x146),_0x452fe5(0x15d),_0x1941f1);const _0x4c32b8=await fetch(this[_0x452fe5(0x148)],{'method':_0x452fe5(0x15d),'headers':{'Content-Type':'application/json','Accept':_0x452fe5(0x12c),'User-Agent':_0x452fe5(0x135)},'body':JSON[_0x452fe5(0x13e)](_0x1941f1)}),_0x50063e=Date[_0x452fe5(0x163)]()-_0x18795c;console[_0x452fe5(0x145)](_0x452fe5(0x161)),console['log'](_0x452fe5(0x14b),_0x4c32b8[_0x452fe5(0x12f)]),console['log'](_0x452fe5(0x134),_0x4c32b8[_0x452fe5(0x156)]),console[_0x452fe5(0x145)]('Headers:',Object['fromEntries'](_0x4c32b8[_0x452fe5(0x11c)]['entries']())),console[_0x452fe5(0x145)](_0x452fe5(0x123),_0x50063e+'ms');const _0x5bcd3b=await _0x4c32b8[_0x452fe5(0x16e)]();console['log'](_0x452fe5(0x179),_0x5bcd3b);if(!_0x4c32b8['ok']){console[_0x452fe5(0x138)](_0x452fe5(0x158)),console[_0x452fe5(0x138)](_0x452fe5(0x17b),_0x4c32b8['status']),console[_0x452fe5(0x138)](_0x452fe5(0x126),_0x5bcd3b),loggerService_1[_0x452fe5(0x155)][_0x452fe5(0x121)](_0x452fe5(0x143),'/payment-links',_0x4c32b8[_0x452fe5(0x12f)],_0x5bcd3b,_0x50063e),loggerService_1[_0x452fe5(0x155)][_0x452fe5(0x132)](_0x452fe5(0x143),'/payment-links',_0x452fe5(0x13f)+_0x4c32b8['status']+':\x20'+_0x5bcd3b);if(_0x4c32b8[_0x452fe5(0x12f)]===0x190)throw new Error('One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value');else{if(_0x4c32b8[_0x452fe5(0x12f)]===0x1f4)throw new Error(_0x452fe5(0x152));}throw new Error(_0x452fe5(0x141)+_0x4c32b8['status']+_0x452fe5(0x130)+_0x5bcd3b);}let _0x6b8753;try{_0x6b8753=JSON[_0x452fe5(0x15e)](_0x5bcd3b);}catch(_0x3bef7f){console[_0x452fe5(0x138)](_0x452fe5(0x127),_0x3bef7f),loggerService_1[_0x452fe5(0x155)][_0x452fe5(0x132)](_0x452fe5(0x143),_0x452fe5(0x146),_0x452fe5(0x15a)+_0x3bef7f);throw new Error(_0x452fe5(0x16c)+_0x5bcd3b);}console[_0x452fe5(0x145)](_0x452fe5(0x185)),console[_0x452fe5(0x145)](_0x452fe5(0x139),JSON['stringify'](_0x6b8753,null,0x2)),loggerService_1[_0x452fe5(0x155)][_0x452fe5(0x121)](_0x452fe5(0x143),_0x452fe5(0x146),_0x4c32b8[_0x452fe5(0x12f)],_0x6b8753,_0x50063e);if(_0x6b8753['error']||_0x6b8753[_0x452fe5(0x142)]){const _0x18f781=_0x6b8753[_0x452fe5(0x137)]||_0x6b8753[_0x452fe5(0x138)]||_0x452fe5(0x13d);console[_0x452fe5(0x138)]('===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20==='),console['error']('Error\x20Message:',_0x18f781),console[_0x452fe5(0x138)]('Status\x20Code:',_0x6b8753[_0x452fe5(0x142)]),loggerService_1['loggerService'][_0x452fe5(0x132)](_0x452fe5(0x143),_0x452fe5(0x146),_0x452fe5(0x14f)+_0x18f781);throw new Error(_0x452fe5(0x14e)+_0x18f781);}if(!_0x6b8753['id']||!_0x6b8753[_0x452fe5(0x131)]?.[_0x452fe5(0x16d)]){console['error'](_0x452fe5(0x17c)),console[_0x452fe5(0x138)](_0x452fe5(0x18f)),console[_0x452fe5(0x138)]('Response\x20data:',_0x6b8753),loggerService_1[_0x452fe5(0x155)]['logWhiteDomainError'](_0x452fe5(0x143),'/payment-links',_0x452fe5(0x12a));throw new Error(_0x452fe5(0x190));}return console['log'](_0x452fe5(0x17f)),console[_0x452fe5(0x145)](_0x452fe5(0x164),_0x6b8753['id']),console[_0x452fe5(0x145)](_0x452fe5(0x18d),_0x6b8753[_0x452fe5(0x131)][_0x452fe5(0x16d)]),console[_0x452fe5(0x145)](_0x452fe5(0x147),_0x6b8753['shortLinkUrls'][_0x452fe5(0x171)]||_0x452fe5(0x16f)),console['log'](_0x452fe5(0x12b),_0x1cf21d,_0x452fe5(0x136)),console[_0x452fe5(0x145)]('✅\x20Return\x20URL\x20configured\x20for\x20pending:',_0x414ce9),{'gateway_payment_id':_0x6b8753['id'],'payment_url':_0x6b8753['shortLinkUrls'][_0x452fe5(0x16d)],'qr_code_url':_0x6b8753[_0x452fe5(0x131)]['qrCodeLink'],'expiry_date':_0x6b8753[_0x452fe5(0x14c)]};}catch(_0x1a5c9c){console[_0x452fe5(0x138)]('===\x20NODA\x20SERVICE\x20ERROR\x20==='),console[_0x452fe5(0x138)](_0x452fe5(0x12e),_0x1a5c9c),loggerService_1['loggerService'][_0x452fe5(0x132)](_0x452fe5(0x143),_0x452fe5(0x146),_0x1a5c9c);if(_0x1a5c9c instanceof Error){console['error'](_0x452fe5(0x11b),_0x1a5c9c['message']),console[_0x452fe5(0x138)](_0x452fe5(0x188),_0x1a5c9c['stack']);throw new Error(_0x452fe5(0x168)+_0x1a5c9c['message']);}throw new Error(_0x452fe5(0x18e));}}async['verifyPayment'](_0x18984a){const _0x3ee361=a43_0x459b04,_0x3eddf8=Date['now']();try{loggerService_1['loggerService'][_0x3ee361(0x170)](_0x3ee361(0x143),_0x3ee361(0x15c)+_0x18984a,_0x3ee361(0x12d),{});const _0x1d9e38=await fetch(this['apiUrl']+'/'+_0x18984a,{'method':_0x3ee361(0x12d),'headers':{'Content-Type':_0x3ee361(0x12c),'User-Agent':_0x3ee361(0x135)}}),_0x684241=Date[_0x3ee361(0x163)]()-_0x3eddf8;if(!_0x1d9e38['ok']){const _0x141017=await _0x1d9e38[_0x3ee361(0x16e)]();loggerService_1[_0x3ee361(0x155)][_0x3ee361(0x121)](_0x3ee361(0x143),_0x3ee361(0x15c)+_0x18984a,_0x1d9e38[_0x3ee361(0x12f)],_0x141017,_0x684241);throw new Error(_0x3ee361(0x141)+_0x1d9e38['status']);}const _0x40edcd=await _0x1d9e38[_0x3ee361(0x14a)]();loggerService_1[_0x3ee361(0x155)][_0x3ee361(0x121)](_0x3ee361(0x143),_0x3ee361(0x15c)+_0x18984a,_0x1d9e38[_0x3ee361(0x12f)],_0x40edcd,_0x684241);if(_0x40edcd[_0x3ee361(0x138)]||_0x40edcd[_0x3ee361(0x142)]){loggerService_1[_0x3ee361(0x155)][_0x3ee361(0x132)](_0x3ee361(0x143),_0x3ee361(0x15c)+_0x18984a,_0x3ee361(0x14e)+(_0x40edcd['message']||_0x40edcd[_0x3ee361(0x138)]||_0x3ee361(0x18c)));throw new Error(_0x3ee361(0x14e)+(_0x40edcd[_0x3ee361(0x137)]||_0x40edcd[_0x3ee361(0x138)]||_0x3ee361(0x18c)));}let _0x1c3cc1='PENDING';if(_0x40edcd[_0x3ee361(0x122)]===![]){if(_0x40edcd['expiryDate']){const _0x3530a4=new Date(_0x40edcd['expiryDate']),_0x350f5a=new Date();_0x3530a4<_0x350f5a?_0x1c3cc1='EXPIRED':_0x1c3cc1=_0x3ee361(0x174);}else _0x1c3cc1=_0x3ee361(0x174);}else _0x1c3cc1=_0x3ee361(0x16b);return{'status':_0x1c3cc1,'amount':_0x40edcd[_0x3ee361(0x160)],'currency':_0x40edcd[_0x3ee361(0x167)],'isActive':_0x40edcd['isActive']};}catch(_0x482395){console['error'](_0x3ee361(0x140),_0x482395),loggerService_1[_0x3ee361(0x155)][_0x3ee361(0x132)]('noda',_0x3ee361(0x15c)+_0x18984a,_0x482395);throw new Error('Failed\x20to\x20verify\x20Noda\x20payment:\x20'+(_0x482395 instanceof Error?_0x482395[_0x3ee361(0x137)]:'Unknown\x20error'));}}async['processWebhook'](_0x1ebff7){const _0x58232a=a43_0x459b04;console['log']('Processing\x20Noda\x20webhook:',_0x1ebff7);let _0x5f3d76=_0x58232a(0x16b);switch(_0x1ebff7[_0x58232a(0x177)]?.[_0x58232a(0x13b)]()){case _0x58232a(0x13c):case _0x58232a(0x17a):case'paid':case _0x58232a(0x151):case _0x58232a(0x17e):_0x1ebff7['Settled']===_0x58232a(0x15b)?_0x5f3d76=_0x58232a(0x18a):_0x5f3d76=_0x58232a(0x16b);break;case _0x58232a(0x16a):case _0x58232a(0x18b):case'failed':case'error':case _0x58232a(0x144):_0x5f3d76=_0x58232a(0x174);break;case _0x58232a(0x184):case _0x58232a(0x157):_0x5f3d76=_0x58232a(0x15f);break;case _0x58232a(0x172):case _0x58232a(0x187):case _0x58232a(0x150):case _0x58232a(0x124):case'in_progress':default:_0x5f3d76='PENDING';break;}return{'paymentId':_0x1ebff7[_0x58232a(0x11a)]||_0x1ebff7['PaymentId'],'status':_0x5f3d76,'amount':_0x1ebff7[_0x58232a(0x191)],'currency':_0x1ebff7[_0x58232a(0x183)],'additionalInfo':{'method':_0x1ebff7[_0x58232a(0x11e)],'bankId':_0x1ebff7[_0x58232a(0x176)],'settled':_0x1ebff7['Settled'],'settlementDate':_0x1ebff7[_0x58232a(0x159)],'remitterName':_0x1ebff7[_0x58232a(0x173)]?.[_0x58232a(0x133)],'remitterIban':_0x1ebff7[_0x58232a(0x173)]?.[_0x58232a(0x129)],'bankTransactionId':_0x1ebff7[_0x58232a(0x154)]}};}[a43_0x459b04(0x13a)](_0xc8bb4e,_0x3abb8d){const _0x297145=a43_0x459b04;return console['log']('Noda\x20webhook\x20signature\x20verification:',{'receivedSignature':_0x3abb8d,'paymentId':_0xc8bb4e['PaymentId'],'merchantPaymentId':_0xc8bb4e[_0x297145(0x11a)]}),!![];}}function a43_0x2358(){const _0x1846e3=['statusCode','noda','rejected','log','/payment-links','QR\x20Code\x20Link:','apiUrl','(8digits-8digits\x20format\x20for\x20Noda)','json','Status:','expiryDate','67759unXIOL','Noda\x20API\x20error:\x20','Business\x20Error:\x20','active','success','All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid','46768CijHaP','BankTransactionId','loggerService','statusText','timeout','===\x20NODA\x20API\x20ERROR\x20===','SettlementDate','JSON\x20Parse\x20Error:\x20','Yes','/payment-links/','POST','parse','EXPIRED','amount','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','Order\x20ID\x20Format:','now','Payment\x20Link\x20ID:','createPaymentLink','🌐\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','currency','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','../loggerService','cancelled','PENDING','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','shortLink','text','Not\x20provided','logWhiteDomainRequest','qrCodeLink','pending','Remitter','FAILED','259QQuiEd','BankId','Status','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20===','Raw\x20Response\x20Body:','completed','HTTP\x20Status:','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','5874612lwTQwZ','successful','===\x20NODA\x20SUCCESS\x20===','2659797dLjVhj','3581465MjQcmz','__esModule','Currency','expired','===\x20PARSED\x20NODA\x20RESPONSE\x20===','toUpperCase','created','Error\x20stack:','defineProperty','PAID','canceled','Unknown\x20error','Short\x20Link:','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','Missing\x20id\x20or\x20shortLink\x20in\x20response','Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink','Amount','MerchantPaymentId','Error\x20message:','headers','1073532hfmbOD','Method','✅\x20ОБНОВЛЕНО:\x20Return\x20URL\x20uses\x20pending.php:','288876haqtMq','logWhiteDomainResponse','isActive','Response\x20Time:','processing','NodaService','Response\x20Body:','Failed\x20to\x20parse\x20JSON\x20response:','https://tesoft.uk/gateway/pending.php?id=','Iban','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','Order\x20ID\x20Used:','application/json','GET','Error\x20details:','status',',\x20body:\x20','shortLinkUrls','logWhiteDomainError','Name','Status\x20Text:','TesSoft\x20Payment\x20System/1.0','(8digits-8digits\x20format)','message','error','Parsed\x20Result:','verifyWebhookSignature','toLowerCase','done','Unknown\x20error\x20from\x20Noda\x20API','stringify','HTTP\x20','Noda\x20payment\x20verification\x20error:','HTTP\x20error!\x20status:\x20'];a43_0x2358=function(){return _0x1846e3;};return a43_0x2358();}exports['NodaService']=NodaService;