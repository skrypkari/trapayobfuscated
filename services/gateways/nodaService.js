'use strict';const a42_0x4a1fff=a42_0x1daf;(function(_0x24a706,_0x4c3e19){const _0x1244d6=a42_0x1daf,_0x413f8f=_0x24a706();while(!![]){try{const _0x540196=-parseInt(_0x1244d6(0x157))/0x1*(-parseInt(_0x1244d6(0x145))/0x2)+parseInt(_0x1244d6(0x141))/0x3+parseInt(_0x1244d6(0x113))/0x4+-parseInt(_0x1244d6(0xf3))/0x5*(parseInt(_0x1244d6(0x103))/0x6)+-parseInt(_0x1244d6(0x104))/0x7*(parseInt(_0x1244d6(0x15e))/0x8)+parseInt(_0x1244d6(0x131))/0x9+-parseInt(_0x1244d6(0xfc))/0xa;if(_0x540196===_0x4c3e19)break;else _0x413f8f['push'](_0x413f8f['shift']());}catch(_0x352f5b){_0x413f8f['push'](_0x413f8f['shift']());}}}(a42_0x18d1,0x5377d));function a42_0x1daf(_0x5a9b3d,_0x52e52a){const _0x18d1a6=a42_0x18d1();return a42_0x1daf=function(_0x1daffd,_0x2f7115){_0x1daffd=_0x1daffd-0xf0;let _0x15687d=_0x18d1a6[_0x1daffd];return _0x15687d;},a42_0x1daf(_0x5a9b3d,_0x52e52a);}function a42_0x18d1(){const _0x53b964=['HTTP\x20','Request\x20Body\x20(Direct\x20JSON):',',\x20body:\x20','Iban','34221CtmRul','Settled','message','(8digits-8digits\x20format\x20for\x20Noda)','1422aVImbV','shortLink','loggerService','Order\x20ID\x20Format:','NodaService','Status','apiUrl','PENDING','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','Status:','Status\x20Text:','error','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','EXPIRED','Unknown\x20error','verifyPayment','Missing\x20id\x20or\x20shortLink\x20in\x20response','https://tesoft.uk/gateway/noda/webhook/','793oxCQhg','Method','Raw\x20Response\x20Body:','processWebhook','statusText','isActive','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','1030096aqRuZm','HTTP\x20Status:','===\x20NODA\x20SERVICE\x20ERROR\x20===','https://tesoft.uk/gateway/noda/','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','(8digits-8digits\x20format)','toUpperCase','1588120hCXpwb','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20===','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','HTTP\x20error!\x20status:\x20','successful','cancelled','JSON\x20Parse\x20Error:\x20','Yes','Headers:','1295610sNGYVF','Parsed\x20Result:','amount','created','PAID','completed','parse','12tSzZYA','21PaCXXa','noda','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','SettlementDate','logWhiteDomainResponse','Error\x20Message:','URL:','log','logWhiteDomainRequest','stringify','Response\x20Body:','Response\x20Time:','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','expiryDate','processing','2723088mKYLEs','GET','../loggerService','Unknown\x20error\x20from\x20Noda\x20API','Failed\x20to\x20verify\x20Noda\x20payment:\x20','entries','createPaymentLink','POST','text','===\x20NODA\x20API\x20ERROR\x20===','shortLinkUrls','defineProperty','failed','Business\x20Error:\x20','application/json','done','Noda\x20webhook\x20signature\x20verification:','All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid','status','Error\x20details:','FAILED','fromEntries','Not\x20provided','BankId','statusCode','now','Status\x20Code:','logWhiteDomainError','Remitter','pending','2132802hhbVUt','Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink','/payment-links/','/payment-links','qrCodeLink','Order\x20ID\x20Used:','Noda\x20API\x20error:\x20','Short\x20Link:','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','active','Payment\x20Link\x20ID:','Failed\x20to\x20parse\x20JSON\x20response:'];a42_0x18d1=function(){return _0x53b964;};return a42_0x18d1();}Object[a42_0x4a1fff(0x11e)](exports,'__esModule',{'value':!![]}),exports[a42_0x4a1fff(0x149)]=void 0x0;const loggerService_1=require(a42_0x4a1fff(0x115));class NodaService{constructor(){const _0x44d7de=a42_0x4a1fff;this[_0x44d7de(0x14b)]=_0x44d7de(0x161),console[_0x44d7de(0x10b)]('üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy');}async[a42_0x4a1fff(0x119)](_0xb0060b){const _0x22c782=a42_0x4a1fff,{orderId:_0x23d099,name:_0x25d1bb,paymentDescription:_0x1c74ed,amount:_0x2b240d,currency:_0x3facbc,webhookUrl:_0x440c79,returnUrl:_0x2a5ddb,expiryDate:_0x4da59c}=_0xb0060b,_0x54f26a=_0x3facbc[_0x22c782(0xf2)](),_0x46cb0b=_0x22c782(0x156),_0x2d0c4a='https://tesoft.uk/gateway/pending.php?id='+_0x23d099,_0x3b07eb={'name':_0x25d1bb,'paymentDescription':_0x1c74ed,'amount':_0x2b240d,'currency':_0x54f26a,'paymentId':_0x23d099,'webhookUrl':_0x46cb0b,'returnUrl':_0x2d0c4a};_0x4da59c&&(_0x3b07eb[_0x22c782(0x111)]=_0x4da59c);const _0x324c84=Date[_0x22c782(0x12c)]();try{console[_0x22c782(0x10b)](_0x22c782(0xf4)),console[_0x22c782(0x10b)](_0x22c782(0x10a),this[_0x22c782(0x14b)]),console[_0x22c782(0x10b)](_0x22c782(0x13e),JSON[_0x22c782(0x10d)](_0x3b07eb,null,0x2)),console[_0x22c782(0x10b)](_0x22c782(0x148),_0x23d099,_0x22c782(0x144)),console[_0x22c782(0x10b)]('‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:',_0x2d0c4a),loggerService_1[_0x22c782(0x147)][_0x22c782(0x10c)](_0x22c782(0x105),_0x22c782(0x134),_0x22c782(0x11a),_0x3b07eb);const _0x6d3793=await fetch(this[_0x22c782(0x14b)],{'method':_0x22c782(0x11a),'headers':{'Content-Type':_0x22c782(0x121),'Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x3b07eb)}),_0x1a6aa7=Date[_0x22c782(0x12c)]()-_0x324c84;console[_0x22c782(0x10b)](_0x22c782(0x14d)),console[_0x22c782(0x10b)](_0x22c782(0x14e),_0x6d3793[_0x22c782(0x125)]),console[_0x22c782(0x10b)](_0x22c782(0x14f),_0x6d3793[_0x22c782(0x15b)]),console['log'](_0x22c782(0xfb),Object[_0x22c782(0x128)](_0x6d3793['headers'][_0x22c782(0x118)]())),console[_0x22c782(0x10b)](_0x22c782(0x10f),_0x1a6aa7+'ms');const _0x3cecf4=await _0x6d3793['text']();console[_0x22c782(0x10b)](_0x22c782(0x159),_0x3cecf4);if(!_0x6d3793['ok']){console[_0x22c782(0x150)](_0x22c782(0x11c)),console[_0x22c782(0x150)](_0x22c782(0x15f),_0x6d3793[_0x22c782(0x125)]),console['error'](_0x22c782(0x10e),_0x3cecf4),loggerService_1['loggerService'][_0x22c782(0x108)](_0x22c782(0x105),_0x22c782(0x134),_0x6d3793[_0x22c782(0x125)],_0x3cecf4,_0x1a6aa7),loggerService_1[_0x22c782(0x147)][_0x22c782(0x12e)](_0x22c782(0x105),_0x22c782(0x134),_0x22c782(0x13d)+_0x6d3793[_0x22c782(0x125)]+':\x20'+_0x3cecf4);if(_0x6d3793[_0x22c782(0x125)]===0x190)throw new Error(_0x22c782(0x110));else{if(_0x6d3793[_0x22c782(0x125)]===0x1f4)throw new Error(_0x22c782(0x124));}throw new Error('HTTP\x20error!\x20status:\x20'+_0x6d3793['status']+_0x22c782(0x13f)+_0x3cecf4);}let _0x5eda8c;try{_0x5eda8c=JSON[_0x22c782(0x102)](_0x3cecf4);}catch(_0x8b58f3){console[_0x22c782(0x150)](_0x22c782(0x13c),_0x8b58f3),loggerService_1[_0x22c782(0x147)]['logWhiteDomainError'](_0x22c782(0x105),'/payment-links',_0x22c782(0xf9)+_0x8b58f3);throw new Error(_0x22c782(0x106)+_0x3cecf4);}console[_0x22c782(0x10b)]('===\x20PARSED\x20NODA\x20RESPONSE\x20==='),console[_0x22c782(0x10b)](_0x22c782(0xfd),JSON[_0x22c782(0x10d)](_0x5eda8c,null,0x2)),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x22c782(0x105),_0x22c782(0x134),_0x6d3793[_0x22c782(0x125)],_0x5eda8c,_0x1a6aa7);if(_0x5eda8c[_0x22c782(0x150)]||_0x5eda8c['statusCode']){const _0x4d6215=_0x5eda8c[_0x22c782(0x143)]||_0x5eda8c[_0x22c782(0x150)]||_0x22c782(0x116);console['error'](_0x22c782(0x139)),console[_0x22c782(0x150)](_0x22c782(0x109),_0x4d6215),console['error'](_0x22c782(0x12d),_0x5eda8c['statusCode']),loggerService_1['loggerService'][_0x22c782(0x12e)]('noda','/payment-links',_0x22c782(0x120)+_0x4d6215);throw new Error(_0x22c782(0x137)+_0x4d6215);}if(!_0x5eda8c['id']||!_0x5eda8c[_0x22c782(0x11d)]?.[_0x22c782(0x146)]){console[_0x22c782(0x150)](_0x22c782(0xf5)),console[_0x22c782(0x150)](_0x22c782(0x155)),console['error']('Response\x20data:',_0x5eda8c),loggerService_1[_0x22c782(0x147)][_0x22c782(0x12e)]('noda',_0x22c782(0x134),_0x22c782(0x15d));throw new Error(_0x22c782(0x132));}return console[_0x22c782(0x10b)]('===\x20NODA\x20SUCCESS\x20==='),console[_0x22c782(0x10b)](_0x22c782(0x13b),_0x5eda8c['id']),console[_0x22c782(0x10b)](_0x22c782(0x138),_0x5eda8c[_0x22c782(0x11d)][_0x22c782(0x146)]),console[_0x22c782(0x10b)]('QR\x20Code\x20Link:',_0x5eda8c[_0x22c782(0x11d)][_0x22c782(0x135)]||_0x22c782(0x129)),console[_0x22c782(0x10b)](_0x22c782(0x136),_0x23d099,_0x22c782(0xf1)),console[_0x22c782(0x10b)](_0x22c782(0xf0),_0x2d0c4a),{'gateway_payment_id':_0x5eda8c['id'],'payment_url':_0x5eda8c['shortLinkUrls'][_0x22c782(0x146)],'qr_code_url':_0x5eda8c[_0x22c782(0x11d)][_0x22c782(0x135)],'expiry_date':_0x5eda8c[_0x22c782(0x111)]};}catch(_0x1257df){console[_0x22c782(0x150)](_0x22c782(0x160)),console[_0x22c782(0x150)](_0x22c782(0x126),_0x1257df),loggerService_1[_0x22c782(0x147)][_0x22c782(0x12e)](_0x22c782(0x105),_0x22c782(0x134),_0x1257df);if(_0x1257df instanceof Error){console[_0x22c782(0x150)]('Error\x20message:',_0x1257df['message']),console['error']('Error\x20stack:',_0x1257df['stack']);throw new Error(_0x22c782(0x151)+_0x1257df['message']);}throw new Error('Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error');}}async[a42_0x4a1fff(0x154)](_0x354ced){const _0x549dae=a42_0x4a1fff,_0x1af713=Date[_0x549dae(0x12c)]();try{loggerService_1[_0x549dae(0x147)][_0x549dae(0x10c)]('noda',_0x549dae(0x133)+_0x354ced,_0x549dae(0x114),{});const _0x336ab3=await fetch(this[_0x549dae(0x14b)]+'/'+_0x354ced,{'method':'GET','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x5cd10e=Date[_0x549dae(0x12c)]()-_0x1af713;if(!_0x336ab3['ok']){const _0x4ac697=await _0x336ab3[_0x549dae(0x11b)]();loggerService_1[_0x549dae(0x147)][_0x549dae(0x108)]('noda','/payment-links/'+_0x354ced,_0x336ab3[_0x549dae(0x125)],_0x4ac697,_0x5cd10e);throw new Error(_0x549dae(0xf6)+_0x336ab3[_0x549dae(0x125)]);}const _0x47eb4f=await _0x336ab3['json']();loggerService_1[_0x549dae(0x147)][_0x549dae(0x108)](_0x549dae(0x105),_0x549dae(0x133)+_0x354ced,_0x336ab3[_0x549dae(0x125)],_0x47eb4f,_0x5cd10e);if(_0x47eb4f[_0x549dae(0x150)]||_0x47eb4f[_0x549dae(0x12b)]){loggerService_1[_0x549dae(0x147)][_0x549dae(0x12e)](_0x549dae(0x105),_0x549dae(0x133)+_0x354ced,_0x549dae(0x137)+(_0x47eb4f['message']||_0x47eb4f[_0x549dae(0x150)]||_0x549dae(0x153)));throw new Error(_0x549dae(0x137)+(_0x47eb4f[_0x549dae(0x143)]||_0x47eb4f[_0x549dae(0x150)]||_0x549dae(0x153)));}let _0x334bdd=_0x549dae(0x14c);if(_0x47eb4f[_0x549dae(0x15c)]===![]){if(_0x47eb4f[_0x549dae(0x111)]){const _0x5f26b5=new Date(_0x47eb4f[_0x549dae(0x111)]),_0x1adc2d=new Date();_0x5f26b5<_0x1adc2d?_0x334bdd=_0x549dae(0x152):_0x334bdd='FAILED';}else _0x334bdd=_0x549dae(0x127);}else _0x334bdd='PENDING';return{'status':_0x334bdd,'amount':_0x47eb4f[_0x549dae(0xfe)],'currency':_0x47eb4f['currency'],'isActive':_0x47eb4f[_0x549dae(0x15c)]};}catch(_0x4ced18){console[_0x549dae(0x150)]('Noda\x20payment\x20verification\x20error:',_0x4ced18),loggerService_1[_0x549dae(0x147)]['logWhiteDomainError']('noda','/payment-links/'+_0x354ced,_0x4ced18);throw new Error(_0x549dae(0x117)+(_0x4ced18 instanceof Error?_0x4ced18['message']:_0x549dae(0x153)));}}async[a42_0x4a1fff(0x15a)](_0x23a328){const _0x41e8ee=a42_0x4a1fff;console[_0x41e8ee(0x10b)]('Processing\x20Noda\x20webhook:',_0x23a328);let _0x264db9=_0x41e8ee(0x14c);switch(_0x23a328[_0x41e8ee(0x14a)]?.['toLowerCase']()){case _0x41e8ee(0x122):case _0x41e8ee(0x101):case'paid':case'success':case _0x41e8ee(0xf7):_0x23a328[_0x41e8ee(0x142)]===_0x41e8ee(0xfa)?_0x264db9=_0x41e8ee(0x100):_0x264db9=_0x41e8ee(0x14c);break;case _0x41e8ee(0xf8):case'canceled':case _0x41e8ee(0x11f):case _0x41e8ee(0x150):case'rejected':_0x264db9='FAILED';break;case'expired':case'timeout':_0x264db9=_0x41e8ee(0x152);break;case _0x41e8ee(0x130):case _0x41e8ee(0xff):case _0x41e8ee(0x13a):case _0x41e8ee(0x112):case'in_progress':default:_0x264db9=_0x41e8ee(0x14c);break;}return{'paymentId':_0x23a328['MerchantPaymentId']||_0x23a328['PaymentId'],'status':_0x264db9,'amount':_0x23a328['Amount'],'currency':_0x23a328['Currency'],'additionalInfo':{'method':_0x23a328[_0x41e8ee(0x158)],'bankId':_0x23a328[_0x41e8ee(0x12a)],'settled':_0x23a328[_0x41e8ee(0x142)],'settlementDate':_0x23a328[_0x41e8ee(0x107)],'remitterName':_0x23a328['Remitter']?.['Name'],'remitterIban':_0x23a328[_0x41e8ee(0x12f)]?.[_0x41e8ee(0x140)],'bankTransactionId':_0x23a328['BankTransactionId']}};}['verifyWebhookSignature'](_0x3f927f,_0xd9d5e6){const _0x232013=a42_0x4a1fff;return console[_0x232013(0x10b)](_0x232013(0x123),{'receivedSignature':_0xd9d5e6,'paymentId':_0x3f927f['PaymentId'],'merchantPaymentId':_0x3f927f['MerchantPaymentId']}),!![];}}exports[a42_0x4a1fff(0x149)]=NodaService;