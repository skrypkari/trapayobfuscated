'use strict';const a43_0x2d2992=a43_0x3492;(function(_0x2739dd,_0x26048d){const _0x3dd63b=a43_0x3492,_0x2a276e=_0x2739dd();while(!![]){try{const _0x413de0=-parseInt(_0x3dd63b(0x1ec))/0x1+-parseInt(_0x3dd63b(0x1eb))/0x2*(-parseInt(_0x3dd63b(0x1f4))/0x3)+-parseInt(_0x3dd63b(0x1c8))/0x4+parseInt(_0x3dd63b(0x1cc))/0x5*(parseInt(_0x3dd63b(0x1fa))/0x6)+parseInt(_0x3dd63b(0x1ce))/0x7+-parseInt(_0x3dd63b(0x21f))/0x8+parseInt(_0x3dd63b(0x1fd))/0x9;if(_0x413de0===_0x26048d)break;else _0x2a276e['push'](_0x2a276e['shift']());}catch(_0x1f934e){_0x2a276e['push'](_0x2a276e['shift']());}}}(a43_0x20ff,0xbd95e));function a43_0x3492(_0x3a389d,_0x1e51f9){const _0x20ffb2=a43_0x20ff();return a43_0x3492=function(_0x3492a5,_0x18d5b2){_0x3492a5=_0x3492a5-0x1b0;let _0x73d79c=_0x20ffb2[_0x3492a5];return _0x73d79c;},a43_0x3492(_0x3a389d,_0x1e51f9);}Object[a43_0x2d2992(0x1f5)](exports,'__esModule',{'value':!![]}),exports[a43_0x2d2992(0x214)]=void 0x0;function a43_0x20ff(){const _0x330b06=['173195UPTXDl','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','4000759cMSwNp','===\x20NODA\x20SERVICE\x20ERROR\x20===','text','BankTransactionId','Noda\x20payment\x20verification\x20error:','stringify','üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink','PAID',',\x20body:\x20','Response\x20Body:','Not\x20provided','completed','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','log','HTTP\x20','rejected','toLowerCase','Status\x20Code:','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','currency','Unknown\x20error','error','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','Error\x20Message:','expired','Response\x20Time:','parse','status','274iEyGGY','722158jzNjvK','failed','qrCodeLink','URL:','now','Missing\x20id\x20or\x20shortLink\x20in\x20response','Settled','PENDING','1968bVtSRm','defineProperty','logWhiteDomainError','success','done','HTTP\x20Status:','174UnTNlB','Amount','Status:','11543247WdsTYq','message','Payment\x20Link\x20ID:','shortLinkUrls','GET','===\x20NODA\x20API\x20ERROR\x20===','successful','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20===','Error\x20details:','Noda\x20API\x20error:\x20','Response\x20data:','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','Iban','entries','POST','amount','Unknown\x20error\x20from\x20Noda\x20API','Status','https://tesoft.uk/gateway/pending.php?id=','Business\x20Error:\x20','SettlementDate','FAILED','verifyPayment','NodaService','Error\x20message:','Status\x20Text:','Headers:','(8digits-8digits\x20format\x20for\x20Noda)','/payment-links/','===\x20NODA\x20SUCCESS\x20===','application/json','Error\x20stack:','Failed\x20to\x20verify\x20Noda\x20payment:\x20','isActive','5660456SOaEOo','timeout','expiryDate','PaymentId','QR\x20Code\x20Link:','in_progress','statusText','===\x20PARSED\x20NODA\x20RESPONSE\x20===','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','processWebhook','statusCode','Failed\x20to\x20parse\x20JSON\x20response:','HTTP\x20error!\x20status:\x20','loggerService','Raw\x20Response\x20Body:','logWhiteDomainRequest','logWhiteDomainResponse','/payment-links','createPaymentLink','cancelled','apiUrl','pending','noda','https://tesoft.uk/gateway/noda/webhook/','verifyWebhookSignature','stack','2969064RYVjnB','(8digits-8digits\x20format)','TesSoft\x20Payment\x20System/1.0','shortLink'];a43_0x20ff=function(){return _0x330b06;};return a43_0x20ff();}const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0x2595fa=a43_0x2d2992;this[_0x2595fa(0x1c2)]='https://tesoft.uk/gateway/noda/',console['log'](_0x2595fa(0x1d4));}async[a43_0x2d2992(0x1c0)](_0x2ea499){const _0xdd4312=a43_0x2d2992,{orderId:_0x2bdbc1,name:_0x393638,paymentDescription:_0x392224,amount:_0x2b133d,currency:_0x411871,webhookUrl:_0x48decf,returnUrl:_0x38e42c,expiryDate:_0x176ebe}=_0x2ea499,_0x5b38b7=_0x411871['toUpperCase'](),_0x1f6160=_0xdd4312(0x1c5),_0x54ffdb=_0xdd4312(0x20f)+_0x2bdbc1,_0x549092={'name':_0x393638,'paymentDescription':_0x392224,'amount':_0x2b133d,'currency':_0x5b38b7,'paymentId':_0x2bdbc1,'webhookUrl':_0x1f6160,'returnUrl':_0x54ffdb};_0x176ebe&&(_0x549092[_0xdd4312(0x1b0)]=_0x176ebe);const _0x43b50d=Date['now']();try{console[_0xdd4312(0x1dc)](_0xdd4312(0x204)),console[_0xdd4312(0x1dc)](_0xdd4312(0x1ef),this['apiUrl']),console[_0xdd4312(0x1dc)]('Request\x20Body\x20(Direct\x20JSON):',JSON['stringify'](_0x549092,null,0x2)),console[_0xdd4312(0x1dc)]('Order\x20ID\x20Format:',_0x2bdbc1,_0xdd4312(0x218)),console[_0xdd4312(0x1dc)]('‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:',_0x54ffdb),loggerService_1[_0xdd4312(0x1bb)]['logWhiteDomainRequest'](_0xdd4312(0x1c4),_0xdd4312(0x1bf),_0xdd4312(0x20b),_0x549092);const _0x4b407d=await fetch(this['apiUrl'],{'method':_0xdd4312(0x20b),'headers':{'Content-Type':_0xdd4312(0x21b),'Accept':_0xdd4312(0x21b),'User-Agent':_0xdd4312(0x1ca)},'body':JSON[_0xdd4312(0x1d3)](_0x549092)}),_0x2722e2=Date[_0xdd4312(0x1f0)]()-_0x43b50d;console[_0xdd4312(0x1dc)](_0xdd4312(0x1cd)),console[_0xdd4312(0x1dc)](_0xdd4312(0x1fc),_0x4b407d[_0xdd4312(0x1ea)]),console[_0xdd4312(0x1dc)](_0xdd4312(0x216),_0x4b407d[_0xdd4312(0x1b4)]),console[_0xdd4312(0x1dc)](_0xdd4312(0x217),Object['fromEntries'](_0x4b407d['headers'][_0xdd4312(0x20a)]())),console['log'](_0xdd4312(0x1e8),_0x2722e2+'ms');const _0x461e9a=await _0x4b407d[_0xdd4312(0x1d0)]();console[_0xdd4312(0x1dc)](_0xdd4312(0x1bc),_0x461e9a);if(!_0x4b407d['ok']){console['error'](_0xdd4312(0x202)),console[_0xdd4312(0x1e4)](_0xdd4312(0x1f9),_0x4b407d[_0xdd4312(0x1ea)]),console[_0xdd4312(0x1e4)](_0xdd4312(0x1d8),_0x461e9a),loggerService_1['loggerService'][_0xdd4312(0x1be)](_0xdd4312(0x1c4),_0xdd4312(0x1bf),_0x4b407d[_0xdd4312(0x1ea)],_0x461e9a,_0x2722e2),loggerService_1[_0xdd4312(0x1bb)][_0xdd4312(0x1f6)]('noda',_0xdd4312(0x1bf),_0xdd4312(0x1dd)+_0x4b407d[_0xdd4312(0x1ea)]+':\x20'+_0x461e9a);if(_0x4b407d['status']===0x190)throw new Error(_0xdd4312(0x208));else{if(_0x4b407d[_0xdd4312(0x1ea)]===0x1f4)throw new Error('All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid');}throw new Error(_0xdd4312(0x1ba)+_0x4b407d[_0xdd4312(0x1ea)]+_0xdd4312(0x1d7)+_0x461e9a);}let _0x5e36dd;try{_0x5e36dd=JSON[_0xdd4312(0x1e9)](_0x461e9a);}catch(_0x3c44ab){console['error'](_0xdd4312(0x1b9),_0x3c44ab),loggerService_1['loggerService']['logWhiteDomainError']('noda',_0xdd4312(0x1bf),'JSON\x20Parse\x20Error:\x20'+_0x3c44ab);throw new Error(_0xdd4312(0x1db)+_0x461e9a);}console[_0xdd4312(0x1dc)](_0xdd4312(0x1b5)),console[_0xdd4312(0x1dc)]('Parsed\x20Result:',JSON['stringify'](_0x5e36dd,null,0x2)),loggerService_1['loggerService'][_0xdd4312(0x1be)](_0xdd4312(0x1c4),_0xdd4312(0x1bf),_0x4b407d[_0xdd4312(0x1ea)],_0x5e36dd,_0x2722e2);if(_0x5e36dd[_0xdd4312(0x1e4)]||_0x5e36dd[_0xdd4312(0x1b8)]){const _0x165558=_0x5e36dd['message']||_0x5e36dd[_0xdd4312(0x1e4)]||_0xdd4312(0x20d);console['error']('===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20==='),console['error'](_0xdd4312(0x1e6),_0x165558),console[_0xdd4312(0x1e4)](_0xdd4312(0x1e0),_0x5e36dd[_0xdd4312(0x1b8)]),loggerService_1[_0xdd4312(0x1bb)][_0xdd4312(0x1f6)](_0xdd4312(0x1c4),_0xdd4312(0x1bf),_0xdd4312(0x210)+_0x165558);throw new Error('Noda\x20API\x20error:\x20'+_0x165558);}if(!_0x5e36dd['id']||!_0x5e36dd[_0xdd4312(0x200)]?.[_0xdd4312(0x1cb)]){console['error']('===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0xdd4312(0x1e4)](_0xdd4312(0x1f1)),console[_0xdd4312(0x1e4)](_0xdd4312(0x207),_0x5e36dd),loggerService_1[_0xdd4312(0x1bb)]['logWhiteDomainError'](_0xdd4312(0x1c4),_0xdd4312(0x1bf),_0xdd4312(0x1e1));throw new Error(_0xdd4312(0x1d5));}return console['log'](_0xdd4312(0x21a)),console[_0xdd4312(0x1dc)](_0xdd4312(0x1ff),_0x5e36dd['id']),console[_0xdd4312(0x1dc)]('Short\x20Link:',_0x5e36dd[_0xdd4312(0x200)][_0xdd4312(0x1cb)]),console[_0xdd4312(0x1dc)](_0xdd4312(0x1b2),_0x5e36dd[_0xdd4312(0x200)][_0xdd4312(0x1ee)]||_0xdd4312(0x1d9)),console[_0xdd4312(0x1dc)]('Order\x20ID\x20Used:',_0x2bdbc1,_0xdd4312(0x1c9)),console['log'](_0xdd4312(0x1e5),_0x54ffdb),{'gateway_payment_id':_0x5e36dd['id'],'payment_url':_0x5e36dd[_0xdd4312(0x200)][_0xdd4312(0x1cb)],'qr_code_url':_0x5e36dd[_0xdd4312(0x200)][_0xdd4312(0x1ee)],'expiry_date':_0x5e36dd['expiryDate']};}catch(_0x578628){console[_0xdd4312(0x1e4)](_0xdd4312(0x1cf)),console[_0xdd4312(0x1e4)](_0xdd4312(0x205),_0x578628),loggerService_1[_0xdd4312(0x1bb)][_0xdd4312(0x1f6)](_0xdd4312(0x1c4),'/payment-links',_0x578628);if(_0x578628 instanceof Error){console[_0xdd4312(0x1e4)](_0xdd4312(0x215),_0x578628[_0xdd4312(0x1fe)]),console['error'](_0xdd4312(0x21c),_0x578628[_0xdd4312(0x1c7)]);throw new Error('Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20'+_0x578628[_0xdd4312(0x1fe)]);}throw new Error(_0xdd4312(0x1b6));}}async[a43_0x2d2992(0x213)](_0x3b543a){const _0x35d592=a43_0x2d2992,_0x48fa7f=Date[_0x35d592(0x1f0)]();try{loggerService_1['loggerService'][_0x35d592(0x1bd)](_0x35d592(0x1c4),_0x35d592(0x219)+_0x3b543a,_0x35d592(0x201),{});const _0x4fbf79=await fetch(this[_0x35d592(0x1c2)]+'/'+_0x3b543a,{'method':_0x35d592(0x201),'headers':{'Content-Type':'application/json','User-Agent':_0x35d592(0x1ca)}}),_0x4d2d19=Date[_0x35d592(0x1f0)]()-_0x48fa7f;if(!_0x4fbf79['ok']){const _0x292dc5=await _0x4fbf79[_0x35d592(0x1d0)]();loggerService_1['loggerService'][_0x35d592(0x1be)]('noda',_0x35d592(0x219)+_0x3b543a,_0x4fbf79[_0x35d592(0x1ea)],_0x292dc5,_0x4d2d19);throw new Error(_0x35d592(0x1ba)+_0x4fbf79['status']);}const _0x453ebc=await _0x4fbf79['json']();loggerService_1[_0x35d592(0x1bb)]['logWhiteDomainResponse'](_0x35d592(0x1c4),_0x35d592(0x219)+_0x3b543a,_0x4fbf79['status'],_0x453ebc,_0x4d2d19);if(_0x453ebc[_0x35d592(0x1e4)]||_0x453ebc[_0x35d592(0x1b8)]){loggerService_1[_0x35d592(0x1bb)]['logWhiteDomainError'](_0x35d592(0x1c4),_0x35d592(0x219)+_0x3b543a,_0x35d592(0x206)+(_0x453ebc[_0x35d592(0x1fe)]||_0x453ebc[_0x35d592(0x1e4)]||_0x35d592(0x1e3)));throw new Error('Noda\x20API\x20error:\x20'+(_0x453ebc[_0x35d592(0x1fe)]||_0x453ebc[_0x35d592(0x1e4)]||_0x35d592(0x1e3)));}let _0x4c7a92='PENDING';if(_0x453ebc['isActive']===![]){if(_0x453ebc[_0x35d592(0x1b0)]){const _0x6f6fcf=new Date(_0x453ebc[_0x35d592(0x1b0)]),_0xf75943=new Date();_0x6f6fcf<_0xf75943?_0x4c7a92='EXPIRED':_0x4c7a92=_0x35d592(0x212);}else _0x4c7a92='FAILED';}else _0x4c7a92='PENDING';return{'status':_0x4c7a92,'amount':_0x453ebc[_0x35d592(0x20c)],'currency':_0x453ebc[_0x35d592(0x1e2)],'isActive':_0x453ebc[_0x35d592(0x21e)]};}catch(_0x268c0b){console[_0x35d592(0x1e4)](_0x35d592(0x1d2),_0x268c0b),loggerService_1[_0x35d592(0x1bb)]['logWhiteDomainError'](_0x35d592(0x1c4),_0x35d592(0x219)+_0x3b543a,_0x268c0b);throw new Error(_0x35d592(0x21d)+(_0x268c0b instanceof Error?_0x268c0b[_0x35d592(0x1fe)]:_0x35d592(0x1e3)));}}async[a43_0x2d2992(0x1b7)](_0x16d541){const _0x131ea2=a43_0x2d2992;console[_0x131ea2(0x1dc)]('Processing\x20Noda\x20webhook:',_0x16d541);let _0x11a44b=_0x131ea2(0x1f3);switch(_0x16d541[_0x131ea2(0x20e)]?.[_0x131ea2(0x1df)]()){case _0x131ea2(0x1f8):case _0x131ea2(0x1da):case'paid':case _0x131ea2(0x1f7):case _0x131ea2(0x203):_0x16d541['Settled']==='Yes'?_0x11a44b=_0x131ea2(0x1d6):_0x11a44b=_0x131ea2(0x1f3);break;case _0x131ea2(0x1c1):case'canceled':case _0x131ea2(0x1ed):case _0x131ea2(0x1e4):case _0x131ea2(0x1de):_0x11a44b=_0x131ea2(0x212);break;case _0x131ea2(0x1e7):case _0x131ea2(0x220):_0x11a44b='EXPIRED';break;case _0x131ea2(0x1c3):case'created':case'active':case'processing':case _0x131ea2(0x1b3):default:_0x11a44b=_0x131ea2(0x1f3);break;}return{'paymentId':_0x16d541['MerchantPaymentId']||_0x16d541[_0x131ea2(0x1b1)],'status':_0x11a44b,'amount':_0x16d541[_0x131ea2(0x1fb)],'currency':_0x16d541['Currency'],'additionalInfo':{'method':_0x16d541['Method'],'bankId':_0x16d541['BankId'],'settled':_0x16d541[_0x131ea2(0x1f2)],'settlementDate':_0x16d541[_0x131ea2(0x211)],'remitterName':_0x16d541['Remitter']?.['Name'],'remitterIban':_0x16d541['Remitter']?.[_0x131ea2(0x209)],'bankTransactionId':_0x16d541[_0x131ea2(0x1d1)]}};}[a43_0x2d2992(0x1c6)](_0x3fd589,_0x207d24){const _0x436dc1=a43_0x2d2992;return console['log']('Noda\x20webhook\x20signature\x20verification:',{'receivedSignature':_0x207d24,'paymentId':_0x3fd589[_0x436dc1(0x1b1)],'merchantPaymentId':_0x3fd589['MerchantPaymentId']}),!![];}}exports[a43_0x2d2992(0x214)]=NodaService;