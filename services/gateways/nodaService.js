'use strict';const a40_0x332a73=a40_0x25c6;(function(_0x14f6cf,_0xb1bf55){const _0x44fb2f=a40_0x25c6,_0x2ffeef=_0x14f6cf();while(!![]){try{const _0x3cd09a=-parseInt(_0x44fb2f(0x14e))/0x1+-parseInt(_0x44fb2f(0x135))/0x2+parseInt(_0x44fb2f(0x152))/0x3+parseInt(_0x44fb2f(0x154))/0x4*(parseInt(_0x44fb2f(0x148))/0x5)+parseInt(_0x44fb2f(0x16c))/0x6+parseInt(_0x44fb2f(0x147))/0x7+-parseInt(_0x44fb2f(0x16d))/0x8;if(_0x3cd09a===_0xb1bf55)break;else _0x2ffeef['push'](_0x2ffeef['shift']());}catch(_0x2fd716){_0x2ffeef['push'](_0x2ffeef['shift']());}}}(a40_0x4a95,0x7f1f0));function a40_0x25c6(_0x2943ab,_0x37c897){const _0x4a9556=a40_0x4a95();return a40_0x25c6=function(_0x25c6ba,_0x1466b2){_0x25c6ba=_0x25c6ba-0x106;let _0x4330a3=_0x4a9556[_0x25c6ba];return _0x4330a3;},a40_0x25c6(_0x2943ab,_0x37c897);}Object[a40_0x332a73(0x170)](exports,a40_0x332a73(0x171),{'value':!![]}),exports['NodaService']=void 0x0;const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0x1f0c99=a40_0x332a73;this[_0x1f0c99(0x137)]='https://tesoft.uk/gateway/noda/',console[_0x1f0c99(0x134)](_0x1f0c99(0x151));}async[a40_0x332a73(0x14b)](_0x5d55c7){const _0x3b412c=a40_0x332a73,{orderId:_0x5b6c16,name:_0x1485e4,paymentDescription:_0x3e2619,amount:_0x2b114d,currency:_0x16da16,webhookUrl:_0x509dd8,returnUrl:_0x4c3708,expiryDate:_0x3da0a2}=_0x5d55c7,_0xe10699=_0x16da16[_0x3b412c(0x123)](),_0x30e85c=_0x3b412c(0x120),_0x3b247a='https://tesoft.uk/gateway/success.php?id='+_0x5b6c16,_0x46bd6e={'name':_0x1485e4,'paymentDescription':_0x3e2619,'amount':_0x2b114d,'currency':_0xe10699,'paymentId':_0x5b6c16,'webhookUrl':_0x30e85c,'returnUrl':_0x3b247a};_0x3da0a2&&(_0x46bd6e[_0x3b412c(0x139)]=_0x3da0a2);const _0x385359=Date['now']();try{console[_0x3b412c(0x134)](_0x3b412c(0x114)),console[_0x3b412c(0x134)](_0x3b412c(0x11b),this[_0x3b412c(0x137)]),console[_0x3b412c(0x134)]('Request\x20Body\x20(Direct\x20JSON):',JSON['stringify'](_0x46bd6e,null,0x2)),console[_0x3b412c(0x134)]('Order\x20ID\x20Format:',_0x5b6c16,_0x3b412c(0x117)),loggerService_1['loggerService']['logWhiteDomainRequest']('noda','/payment-links',_0x3b412c(0x11d),_0x46bd6e);const _0x46ccf6=await fetch(this['apiUrl'],{'method':_0x3b412c(0x11d),'headers':{'Content-Type':_0x3b412c(0x164),'Accept':_0x3b412c(0x164),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x46bd6e)}),_0x21d492=Date['now']()-_0x385359;console['log'](_0x3b412c(0x13d)),console['log'](_0x3b412c(0x10a),_0x46ccf6['status']),console[_0x3b412c(0x134)](_0x3b412c(0x124),_0x46ccf6[_0x3b412c(0x107)]),console[_0x3b412c(0x134)](_0x3b412c(0x146),Object[_0x3b412c(0x156)](_0x46ccf6['headers'][_0x3b412c(0x106)]())),console[_0x3b412c(0x134)](_0x3b412c(0x132),_0x21d492+'ms');const _0x1a9a54=await _0x46ccf6[_0x3b412c(0x136)]();console[_0x3b412c(0x134)](_0x3b412c(0x13c),_0x1a9a54);if(!_0x46ccf6['ok']){console[_0x3b412c(0x125)](_0x3b412c(0x15f)),console['error'](_0x3b412c(0x150),_0x46ccf6['status']),console[_0x3b412c(0x125)](_0x3b412c(0x12a),_0x1a9a54),loggerService_1[_0x3b412c(0x166)][_0x3b412c(0x173)](_0x3b412c(0x138),_0x3b412c(0x11a),_0x46ccf6[_0x3b412c(0x13f)],_0x1a9a54,_0x21d492),loggerService_1['loggerService'][_0x3b412c(0x131)](_0x3b412c(0x138),'/payment-links',_0x3b412c(0x12f)+_0x46ccf6[_0x3b412c(0x13f)]+':\x20'+_0x1a9a54);if(_0x46ccf6[_0x3b412c(0x13f)]===0x190)throw new Error(_0x3b412c(0x172));else{if(_0x46ccf6[_0x3b412c(0x13f)]===0x1f4)throw new Error(_0x3b412c(0x13e));}throw new Error('HTTP\x20error!\x20status:\x20'+_0x46ccf6[_0x3b412c(0x13f)]+',\x20body:\x20'+_0x1a9a54);}let _0xa4cdf3;try{_0xa4cdf3=JSON[_0x3b412c(0x12c)](_0x1a9a54);}catch(_0x3c3d3b){console['error'](_0x3b412c(0x118),_0x3c3d3b),loggerService_1[_0x3b412c(0x166)]['logWhiteDomainError'](_0x3b412c(0x138),_0x3b412c(0x11a),_0x3b412c(0x167)+_0x3c3d3b);throw new Error(_0x3b412c(0x169)+_0x1a9a54);}console[_0x3b412c(0x134)](_0x3b412c(0x115)),console[_0x3b412c(0x134)]('Parsed\x20Result:',JSON['stringify'](_0xa4cdf3,null,0x2)),loggerService_1[_0x3b412c(0x166)][_0x3b412c(0x173)]('noda',_0x3b412c(0x11a),_0x46ccf6['status'],_0xa4cdf3,_0x21d492);if(_0xa4cdf3['error']||_0xa4cdf3[_0x3b412c(0x111)]){const _0x23b6ca=_0xa4cdf3['message']||_0xa4cdf3[_0x3b412c(0x125)]||'Unknown\x20error\x20from\x20Noda\x20API';console[_0x3b412c(0x125)](_0x3b412c(0x112)),console[_0x3b412c(0x125)](_0x3b412c(0x16f),_0x23b6ca),console[_0x3b412c(0x125)](_0x3b412c(0x153),_0xa4cdf3[_0x3b412c(0x111)]),loggerService_1[_0x3b412c(0x166)]['logWhiteDomainError'](_0x3b412c(0x138),_0x3b412c(0x11a),_0x3b412c(0x11e)+_0x23b6ca);throw new Error(_0x3b412c(0x10f)+_0x23b6ca);}if(!_0xa4cdf3['id']||!_0xa4cdf3[_0x3b412c(0x15a)]?.[_0x3b412c(0x157)]){console[_0x3b412c(0x125)](_0x3b412c(0x12d)),console[_0x3b412c(0x125)]('Missing\x20id\x20or\x20shortLink\x20in\x20response'),console['error'](_0x3b412c(0x11f),_0xa4cdf3),loggerService_1['loggerService'][_0x3b412c(0x131)]('noda',_0x3b412c(0x11a),'Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink');throw new Error('Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink');}return console['log'](_0x3b412c(0x113)),console['log'](_0x3b412c(0x121),_0xa4cdf3['id']),console[_0x3b412c(0x134)](_0x3b412c(0x116),_0xa4cdf3['shortLinkUrls'][_0x3b412c(0x157)]),console[_0x3b412c(0x134)](_0x3b412c(0x158),_0xa4cdf3[_0x3b412c(0x15a)][_0x3b412c(0x12e)]||_0x3b412c(0x140)),console[_0x3b412c(0x134)](_0x3b412c(0x144),_0x5b6c16,_0x3b412c(0x13a)),{'gateway_payment_id':_0xa4cdf3['id'],'payment_url':_0xa4cdf3[_0x3b412c(0x15a)]['shortLink'],'qr_code_url':_0xa4cdf3[_0x3b412c(0x15a)]['qrCodeLink'],'expiry_date':_0xa4cdf3[_0x3b412c(0x139)]};}catch(_0x5a5c9e){console[_0x3b412c(0x125)](_0x3b412c(0x163)),console[_0x3b412c(0x125)]('Error\x20details:',_0x5a5c9e),loggerService_1[_0x3b412c(0x166)][_0x3b412c(0x131)](_0x3b412c(0x138),_0x3b412c(0x11a),_0x5a5c9e);if(_0x5a5c9e instanceof Error){console['error']('Error\x20message:',_0x5a5c9e[_0x3b412c(0x110)]),console[_0x3b412c(0x125)](_0x3b412c(0x165),_0x5a5c9e['stack']);throw new Error(_0x3b412c(0x155)+_0x5a5c9e[_0x3b412c(0x110)]);}throw new Error('Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error');}}async['verifyPayment'](_0x7d4997){const _0x2eafb3=a40_0x332a73,_0x2c69a9=Date[_0x2eafb3(0x126)]();try{loggerService_1['loggerService'][_0x2eafb3(0x10e)](_0x2eafb3(0x138),'/payment-links/'+_0x7d4997,'GET',{});const _0x14693b=await fetch(this[_0x2eafb3(0x137)]+'/'+_0x7d4997,{'method':'GET','headers':{'Content-Type':'application/json','User-Agent':_0x2eafb3(0x119)}}),_0x1ef536=Date[_0x2eafb3(0x126)]()-_0x2c69a9;if(!_0x14693b['ok']){const _0x4f28b8=await _0x14693b['text']();loggerService_1[_0x2eafb3(0x166)][_0x2eafb3(0x173)](_0x2eafb3(0x138),_0x2eafb3(0x159)+_0x7d4997,_0x14693b['status'],_0x4f28b8,_0x1ef536);throw new Error(_0x2eafb3(0x143)+_0x14693b[_0x2eafb3(0x13f)]);}const _0x333e3d=await _0x14693b[_0x2eafb3(0x13b)]();loggerService_1[_0x2eafb3(0x166)][_0x2eafb3(0x173)](_0x2eafb3(0x138),'/payment-links/'+_0x7d4997,_0x14693b[_0x2eafb3(0x13f)],_0x333e3d,_0x1ef536);if(_0x333e3d['error']||_0x333e3d[_0x2eafb3(0x111)]){loggerService_1[_0x2eafb3(0x166)][_0x2eafb3(0x131)](_0x2eafb3(0x138),_0x2eafb3(0x159)+_0x7d4997,_0x2eafb3(0x10f)+(_0x333e3d[_0x2eafb3(0x110)]||_0x333e3d[_0x2eafb3(0x125)]||_0x2eafb3(0x133)));throw new Error('Noda\x20API\x20error:\x20'+(_0x333e3d[_0x2eafb3(0x110)]||_0x333e3d[_0x2eafb3(0x125)]||_0x2eafb3(0x133)));}let _0x33228a=_0x2eafb3(0x162);if(_0x333e3d[_0x2eafb3(0x127)]===![]){if(_0x333e3d[_0x2eafb3(0x139)]){const _0x9505d7=new Date(_0x333e3d['expiryDate']),_0x248052=new Date();_0x9505d7<_0x248052?_0x33228a=_0x2eafb3(0x15e):_0x33228a='FAILED';}else _0x33228a='FAILED';}else _0x33228a='PENDING';return{'status':_0x33228a,'amount':_0x333e3d[_0x2eafb3(0x109)],'currency':_0x333e3d['currency'],'isActive':_0x333e3d[_0x2eafb3(0x127)]};}catch(_0x595266){console[_0x2eafb3(0x125)]('Noda\x20payment\x20verification\x20error:',_0x595266),loggerService_1[_0x2eafb3(0x166)][_0x2eafb3(0x131)](_0x2eafb3(0x138),_0x2eafb3(0x159)+_0x7d4997,_0x595266);throw new Error(_0x2eafb3(0x128)+(_0x595266 instanceof Error?_0x595266[_0x2eafb3(0x110)]:_0x2eafb3(0x133)));}}async[a40_0x332a73(0x142)](_0xc9e1b8){const _0x2a3a14=a40_0x332a73;console['log'](_0x2a3a14(0x168),_0xc9e1b8);let _0x435a43=_0x2a3a14(0x162);switch(_0xc9e1b8[_0x2a3a14(0x16b)]?.[_0x2a3a14(0x141)]()){case _0x2a3a14(0x160):case'completed':case'paid':case'success':case _0x2a3a14(0x10c):_0xc9e1b8[_0x2a3a14(0x108)]===_0x2a3a14(0x14a)?_0x435a43=_0x2a3a14(0x14d):_0x435a43=_0x2a3a14(0x162);break;case'cancelled':case'canceled':case _0x2a3a14(0x122):case _0x2a3a14(0x125):case'rejected':_0x435a43='FAILED';break;case _0x2a3a14(0x145):case _0x2a3a14(0x11c):_0x435a43='EXPIRED';break;case'pending':case _0x2a3a14(0x16e):case _0x2a3a14(0x15c):case'processing':case _0x2a3a14(0x15b):default:_0x435a43=_0x2a3a14(0x162);break;}return{'paymentId':_0xc9e1b8[_0x2a3a14(0x129)]||_0xc9e1b8[_0x2a3a14(0x149)],'status':_0x435a43,'amount':_0xc9e1b8['Amount'],'currency':_0xc9e1b8['Currency'],'additionalInfo':{'method':_0xc9e1b8[_0x2a3a14(0x130)],'bankId':_0xc9e1b8[_0x2a3a14(0x161)],'settled':_0xc9e1b8[_0x2a3a14(0x108)],'settlementDate':_0xc9e1b8[_0x2a3a14(0x14f)],'remitterName':_0xc9e1b8[_0x2a3a14(0x10d)]?.[_0x2a3a14(0x12b)],'remitterIban':_0xc9e1b8['Remitter']?.[_0x2a3a14(0x14c)],'bankTransactionId':_0xc9e1b8[_0x2a3a14(0x16a)]}};}[a40_0x332a73(0x10b)](_0x30fcbc,_0x4e4a1b){const _0x39c45a=a40_0x332a73;return console[_0x39c45a(0x134)](_0x39c45a(0x15d),{'receivedSignature':_0x4e4a1b,'paymentId':_0x30fcbc[_0x39c45a(0x149)],'merchantPaymentId':_0x30fcbc[_0x39c45a(0x129)]}),!![];}}exports['NodaService']=NodaService;function a40_0x4a95(){const _0x1a7677=['error','now','isActive','Failed\x20to\x20verify\x20Noda\x20payment:\x20','MerchantPaymentId','Response\x20Body:','Name','parse','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','qrCodeLink','HTTP\x20','Method','logWhiteDomainError','Response\x20Time:','Unknown\x20error','log','548016KOPkuA','text','apiUrl','noda','expiryDate','(8digits-8digits\x20format)','json','Raw\x20Response\x20Body:','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid','status','Not\x20provided','toLowerCase','processWebhook','HTTP\x20error!\x20status:\x20','Order\x20ID\x20Used:','expired','Headers:','3043096PDqbsD','128110RdcGBY','PaymentId','Yes','createPaymentLink','Iban','PAID','193541tbXvNi','SettlementDate','HTTP\x20Status:','ðŸŒ\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','1190958EpQdXn','Status\x20Code:','4FFZVfS','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','fromEntries','shortLink','QR\x20Code\x20Link:','/payment-links/','shortLinkUrls','in_progress','active','Noda\x20webhook\x20signature\x20verification:','EXPIRED','===\x20NODA\x20API\x20ERROR\x20===','done','BankId','PENDING','===\x20NODA\x20SERVICE\x20ERROR\x20===','application/json','Error\x20stack:','loggerService','JSON\x20Parse\x20Error:\x20','Processing\x20Noda\x20webhook:','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','BankTransactionId','Status','4228032gottgG','4590168jjnbbc','created','Error\x20Message:','defineProperty','__esModule','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','logWhiteDomainResponse','entries','statusText','Settled','amount','Status:','verifyWebhookSignature','successful','Remitter','logWhiteDomainRequest','Noda\x20API\x20error:\x20','message','statusCode','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','===\x20NODA\x20SUCCESS\x20===','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20===','===\x20PARSED\x20NODA\x20RESPONSE\x20===','Short\x20Link:','(8digits-8digits\x20format\x20for\x20Noda)','Failed\x20to\x20parse\x20JSON\x20response:','TesSoft\x20Payment\x20System/1.0','/payment-links','URL:','timeout','POST','Business\x20Error:\x20','Response\x20data:','https://tesoft.uk/gateway/noda/webhook/','Payment\x20Link\x20ID:','failed','toUpperCase','Status\x20Text:'];a40_0x4a95=function(){return _0x1a7677;};return a40_0x4a95();}