'use strict';const a46_0x280dd8=a46_0x564f;(function(_0xa12aad,_0x1e6ca3){const _0x557f51=a46_0x564f,_0x2a08a2=_0xa12aad();while(!![]){try{const _0x524c39=parseInt(_0x557f51(0x197))/0x1*(-parseInt(_0x557f51(0x1b1))/0x2)+-parseInt(_0x557f51(0x1c8))/0x3+-parseInt(_0x557f51(0x1bf))/0x4*(-parseInt(_0x557f51(0x1a6))/0x5)+parseInt(_0x557f51(0x180))/0x6+-parseInt(_0x557f51(0x196))/0x7+-parseInt(_0x557f51(0x1b7))/0x8+parseInt(_0x557f51(0x195))/0x9;if(_0x524c39===_0x1e6ca3)break;else _0x2a08a2['push'](_0x2a08a2['shift']());}catch(_0x316845){_0x2a08a2['push'](_0x2a08a2['shift']());}}}(a46_0x5237,0xc1916));Object[a46_0x280dd8(0x1a4)](exports,'__esModule',{'value':!![]}),exports[a46_0x280dd8(0x18b)]=void 0x0;const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0x44f1f9=a46_0x280dd8;this['apiUrl']=_0x44f1f9(0x17c),console['log']('üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy');}async[a46_0x280dd8(0x1e2)](_0x251d7b){const _0x397e6a=a46_0x280dd8,{orderId:_0x2d4741,name:_0x420400,paymentDescription:_0xb032ca,amount:_0x1fcaaa,currency:_0x20d729,webhookUrl:_0x870e18,returnUrl:_0x3301d6,expiryDate:_0x42eac5}=_0x251d7b,_0x1337d4=_0x20d729[_0x397e6a(0x1b6)](),_0x432311='https://tesoft.uk/gateway/noda/webhook/',_0x27d28b=_0x397e6a(0x1cc)+_0x2d4741,_0x3a515e={'name':_0x420400,'paymentDescription':_0xb032ca,'amount':_0x1fcaaa,'currency':_0x1337d4,'paymentId':_0x2d4741,'webhookUrl':_0x432311,'returnUrl':_0x27d28b};_0x42eac5&&(_0x3a515e['expiryDate']=_0x42eac5);const _0x4402c7=Date[_0x397e6a(0x1eb)]();try{console[_0x397e6a(0x183)]('===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20==='),console['log'](_0x397e6a(0x182),this[_0x397e6a(0x1c5)]),console[_0x397e6a(0x183)](_0x397e6a(0x1b3),JSON['stringify'](_0x3a515e,null,0x2)),console[_0x397e6a(0x183)](_0x397e6a(0x1b0),_0x2d4741,'(8digits-8digits\x20format\x20for\x20Noda)'),console['log']('‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:',_0x27d28b),loggerService_1[_0x397e6a(0x1d6)][_0x397e6a(0x188)](_0x397e6a(0x194),_0x397e6a(0x1be),_0x397e6a(0x1ba),_0x3a515e);const _0x20447f=await fetch(this[_0x397e6a(0x1c5)],{'method':_0x397e6a(0x1ba),'headers':{'Content-Type':'application/json','Accept':_0x397e6a(0x1d1),'User-Agent':_0x397e6a(0x1c2)},'body':JSON[_0x397e6a(0x181)](_0x3a515e)}),_0x1511c3=Date[_0x397e6a(0x1eb)]()-_0x4402c7;console[_0x397e6a(0x183)](_0x397e6a(0x1e0)),console['log']('Status:',_0x20447f[_0x397e6a(0x1b4)]),console[_0x397e6a(0x183)](_0x397e6a(0x1ea),_0x20447f[_0x397e6a(0x1a0)]),console['log'](_0x397e6a(0x17d),Object['fromEntries'](_0x20447f['headers'][_0x397e6a(0x184)]())),console['log'](_0x397e6a(0x1dc),_0x1511c3+'ms');const _0x91828b=await _0x20447f[_0x397e6a(0x1d2)]();console[_0x397e6a(0x183)](_0x397e6a(0x1d0),_0x91828b);if(!_0x20447f['ok']){console[_0x397e6a(0x1de)](_0x397e6a(0x1f0)),console[_0x397e6a(0x1de)](_0x397e6a(0x1c9),_0x20447f[_0x397e6a(0x1b4)]),console[_0x397e6a(0x1de)](_0x397e6a(0x1aa),_0x91828b),loggerService_1[_0x397e6a(0x1d6)]['logWhiteDomainResponse'](_0x397e6a(0x194),_0x397e6a(0x1be),_0x20447f[_0x397e6a(0x1b4)],_0x91828b,_0x1511c3),loggerService_1['loggerService'][_0x397e6a(0x18f)]('noda',_0x397e6a(0x1be),_0x397e6a(0x1af)+_0x20447f[_0x397e6a(0x1b4)]+':\x20'+_0x91828b);if(_0x20447f[_0x397e6a(0x1b4)]===0x190)throw new Error(_0x397e6a(0x1e4));else{if(_0x20447f[_0x397e6a(0x1b4)]===0x1f4)throw new Error(_0x397e6a(0x1ad));}throw new Error(_0x397e6a(0x1cb)+_0x20447f[_0x397e6a(0x1b4)]+_0x397e6a(0x1d4)+_0x91828b);}let _0x4e3dea;try{_0x4e3dea=JSON['parse'](_0x91828b);}catch(_0xd85812){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0xd85812),loggerService_1['loggerService'][_0x397e6a(0x18f)](_0x397e6a(0x194),'/payment-links',_0x397e6a(0x1a5)+_0xd85812);throw new Error(_0x397e6a(0x1a9)+_0x91828b);}console[_0x397e6a(0x183)]('===\x20PARSED\x20NODA\x20RESPONSE\x20==='),console[_0x397e6a(0x183)](_0x397e6a(0x19e),JSON[_0x397e6a(0x181)](_0x4e3dea,null,0x2)),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x397e6a(0x194),_0x397e6a(0x1be),_0x20447f['status'],_0x4e3dea,_0x1511c3);if(_0x4e3dea['error']||_0x4e3dea[_0x397e6a(0x193)]){const _0x5ac4df=_0x4e3dea['message']||_0x4e3dea[_0x397e6a(0x1de)]||_0x397e6a(0x17b);console[_0x397e6a(0x1de)](_0x397e6a(0x192)),console[_0x397e6a(0x1de)](_0x397e6a(0x1da),_0x5ac4df),console[_0x397e6a(0x1de)]('Status\x20Code:',_0x4e3dea[_0x397e6a(0x193)]),loggerService_1[_0x397e6a(0x1d6)][_0x397e6a(0x18f)](_0x397e6a(0x194),_0x397e6a(0x1be),_0x397e6a(0x1ca)+_0x5ac4df);throw new Error(_0x397e6a(0x18e)+_0x5ac4df);}if(!_0x4e3dea['id']||!_0x4e3dea[_0x397e6a(0x1e7)]?.[_0x397e6a(0x1e3)]){console[_0x397e6a(0x1de)]('===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x397e6a(0x1de)](_0x397e6a(0x1d9)),console['error'](_0x397e6a(0x1b5),_0x4e3dea),loggerService_1[_0x397e6a(0x1d6)]['logWhiteDomainError']('noda',_0x397e6a(0x1be),_0x397e6a(0x1b9));throw new Error(_0x397e6a(0x19c));}return console[_0x397e6a(0x183)]('===\x20NODA\x20SUCCESS\x20==='),console[_0x397e6a(0x183)](_0x397e6a(0x199),_0x4e3dea['id']),console['log'](_0x397e6a(0x18d),_0x4e3dea[_0x397e6a(0x1e7)][_0x397e6a(0x1e3)]),console['log'](_0x397e6a(0x1a7),_0x4e3dea['shortLinkUrls']['qrCodeLink']||_0x397e6a(0x187)),console['log'](_0x397e6a(0x1e1),_0x2d4741,_0x397e6a(0x1e8)),console['log'](_0x397e6a(0x1cd),_0x27d28b),{'gateway_payment_id':_0x4e3dea['id'],'payment_url':_0x4e3dea[_0x397e6a(0x1e7)]['shortLink'],'qr_code_url':_0x4e3dea[_0x397e6a(0x1e7)][_0x397e6a(0x1c7)],'expiry_date':_0x4e3dea[_0x397e6a(0x19b)]};}catch(_0x146cfa){console[_0x397e6a(0x1de)]('===\x20NODA\x20SERVICE\x20ERROR\x20==='),console[_0x397e6a(0x1de)](_0x397e6a(0x190),_0x146cfa),loggerService_1[_0x397e6a(0x1d6)][_0x397e6a(0x18f)](_0x397e6a(0x194),_0x397e6a(0x1be),_0x146cfa);if(_0x146cfa instanceof Error){console[_0x397e6a(0x1de)](_0x397e6a(0x1b8),_0x146cfa[_0x397e6a(0x198)]),console[_0x397e6a(0x1de)]('Error\x20stack:',_0x146cfa[_0x397e6a(0x1d8)]);throw new Error(_0x397e6a(0x1a8)+_0x146cfa[_0x397e6a(0x198)]);}throw new Error(_0x397e6a(0x1b2));}}async['verifyPayment'](_0x9490fb){const _0x36ea7b=a46_0x280dd8,_0x1dffcf=Date[_0x36ea7b(0x1eb)]();try{loggerService_1['loggerService']['logWhiteDomainRequest']('noda',_0x36ea7b(0x1c0)+_0x9490fb,_0x36ea7b(0x19a),{});const _0x4ad231=await fetch(this['apiUrl']+'/'+_0x9490fb,{'method':_0x36ea7b(0x19a),'headers':{'Content-Type':_0x36ea7b(0x1d1),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x2e557a=Date[_0x36ea7b(0x1eb)]()-_0x1dffcf;if(!_0x4ad231['ok']){const _0x23f177=await _0x4ad231[_0x36ea7b(0x1d2)]();loggerService_1[_0x36ea7b(0x1d6)][_0x36ea7b(0x1d3)](_0x36ea7b(0x194),'/payment-links/'+_0x9490fb,_0x4ad231[_0x36ea7b(0x1b4)],_0x23f177,_0x2e557a);throw new Error(_0x36ea7b(0x1cb)+_0x4ad231['status']);}const _0x4a5763=await _0x4ad231['json']();loggerService_1[_0x36ea7b(0x1d6)][_0x36ea7b(0x1d3)](_0x36ea7b(0x194),_0x36ea7b(0x1c0)+_0x9490fb,_0x4ad231[_0x36ea7b(0x1b4)],_0x4a5763,_0x2e557a);if(_0x4a5763[_0x36ea7b(0x1de)]||_0x4a5763[_0x36ea7b(0x193)]){loggerService_1[_0x36ea7b(0x1d6)][_0x36ea7b(0x18f)]('noda',_0x36ea7b(0x1c0)+_0x9490fb,_0x36ea7b(0x18e)+(_0x4a5763[_0x36ea7b(0x198)]||_0x4a5763[_0x36ea7b(0x1de)]||_0x36ea7b(0x1ce)));throw new Error(_0x36ea7b(0x18e)+(_0x4a5763[_0x36ea7b(0x198)]||_0x4a5763[_0x36ea7b(0x1de)]||'Unknown\x20error'));}let _0x1e2a3f=_0x36ea7b(0x1c3);if(_0x4a5763['isActive']===![]){if(_0x4a5763[_0x36ea7b(0x19b)]){const _0x1d3b2b=new Date(_0x4a5763[_0x36ea7b(0x19b)]),_0x2e8b1e=new Date();_0x1d3b2b<_0x2e8b1e?_0x1e2a3f=_0x36ea7b(0x1ae):_0x1e2a3f='FAILED';}else _0x1e2a3f=_0x36ea7b(0x191);}else _0x1e2a3f='PENDING';return{'status':_0x1e2a3f,'amount':_0x4a5763[_0x36ea7b(0x1a2)],'currency':_0x4a5763['currency'],'isActive':_0x4a5763[_0x36ea7b(0x1c4)]};}catch(_0x1c8dcd){console['error'](_0x36ea7b(0x1d5),_0x1c8dcd),loggerService_1['loggerService'][_0x36ea7b(0x18f)](_0x36ea7b(0x194),_0x36ea7b(0x1c0)+_0x9490fb,_0x1c8dcd);throw new Error(_0x36ea7b(0x1ee)+(_0x1c8dcd instanceof Error?_0x1c8dcd[_0x36ea7b(0x198)]:_0x36ea7b(0x1ce)));}}async[a46_0x280dd8(0x1e6)](_0x32f8b9){const _0x575dcd=a46_0x280dd8;console[_0x575dcd(0x183)](_0x575dcd(0x18c),_0x32f8b9);let _0x4cf1f2='PENDING';switch(_0x32f8b9[_0x575dcd(0x1bc)]?.[_0x575dcd(0x19d)]()){case _0x575dcd(0x1d7):case _0x575dcd(0x1a3):case _0x575dcd(0x17e):case _0x575dcd(0x1df):case _0x575dcd(0x1ac):_0x32f8b9[_0x575dcd(0x1ec)]===_0x575dcd(0x185)?_0x4cf1f2=_0x575dcd(0x1ed):_0x4cf1f2=_0x575dcd(0x1c3);break;case'cancelled':case _0x575dcd(0x186):case _0x575dcd(0x1db):case _0x575dcd(0x1de):case _0x575dcd(0x19f):_0x4cf1f2=_0x575dcd(0x191);break;case _0x575dcd(0x1e5):case'timeout':_0x4cf1f2='EXPIRED';break;case _0x575dcd(0x1ef):case _0x575dcd(0x1bd):case _0x575dcd(0x1bb):case'processing':case'in_progress':default:_0x4cf1f2=_0x575dcd(0x1c3);break;}return{'paymentId':_0x32f8b9[_0x575dcd(0x1c6)]||_0x32f8b9['PaymentId'],'status':_0x4cf1f2,'amount':_0x32f8b9['Amount'],'currency':_0x32f8b9[_0x575dcd(0x17f)],'additionalInfo':{'method':_0x32f8b9[_0x575dcd(0x17a)],'bankId':_0x32f8b9[_0x575dcd(0x189)],'settled':_0x32f8b9['Settled'],'settlementDate':_0x32f8b9[_0x575dcd(0x1ab)],'remitterName':_0x32f8b9['Remitter']?.['Name'],'remitterIban':_0x32f8b9[_0x575dcd(0x1e9)]?.[_0x575dcd(0x18a)],'bankTransactionId':_0x32f8b9[_0x575dcd(0x1c1)]}};}[a46_0x280dd8(0x1dd)](_0x59345b,_0x4c1cf9){const _0x2c8a6b=a46_0x280dd8;return console[_0x2c8a6b(0x183)](_0x2c8a6b(0x1cf),{'receivedSignature':_0x4c1cf9,'paymentId':_0x59345b[_0x2c8a6b(0x1a1)],'merchantPaymentId':_0x59345b[_0x2c8a6b(0x1c6)]}),!![];}}function a46_0x564f(_0x5de25e,_0x5948ee){const _0x523796=a46_0x5237();return a46_0x564f=function(_0x564f11,_0x474244){_0x564f11=_0x564f11-0x17a;let _0x36b633=_0x523796[_0x564f11];return _0x36b633;},a46_0x564f(_0x5de25e,_0x5948ee);}function a46_0x5237(){const _0x3565c5=['QR\x20Code\x20Link:','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','Response\x20Body:','SettlementDate','successful','All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid','EXPIRED','HTTP\x20','Order\x20ID\x20Format:','288494nSKudZ','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','Request\x20Body\x20(Direct\x20JSON):','status','Response\x20data:','toUpperCase','7199624mGxsoN','Error\x20message:','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','POST','active','Status','created','/payment-links','2962736JpEMqT','/payment-links/','BankTransactionId','TesSoft\x20Payment\x20System/1.0','PENDING','isActive','apiUrl','MerchantPaymentId','qrCodeLink','4349508yMlbFs','HTTP\x20Status:','Business\x20Error:\x20','HTTP\x20error!\x20status:\x20','https://tesoft.uk/gateway/pending.php?id=','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','Unknown\x20error','Noda\x20webhook\x20signature\x20verification:','Raw\x20Response\x20Body:','application/json','text','logWhiteDomainResponse',',\x20body:\x20','Noda\x20payment\x20verification\x20error:','loggerService','done','stack','Missing\x20id\x20or\x20shortLink\x20in\x20response','Error\x20Message:','failed','Response\x20Time:','verifyWebhookSignature','error','success','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','Order\x20ID\x20Used:','createPaymentLink','shortLink','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','expired','processWebhook','shortLinkUrls','(8digits-8digits\x20format)','Remitter','Status\x20Text:','now','Settled','PAID','Failed\x20to\x20verify\x20Noda\x20payment:\x20','pending','===\x20NODA\x20API\x20ERROR\x20===','Method','Unknown\x20error\x20from\x20Noda\x20API','https://tesoft.uk/gateway/noda/','Headers:','paid','Currency','981804BlEFag','stringify','URL:','log','entries','Yes','canceled','Not\x20provided','logWhiteDomainRequest','BankId','Iban','NodaService','Processing\x20Noda\x20webhook:','Short\x20Link:','Noda\x20API\x20error:\x20','logWhiteDomainError','Error\x20details:','FAILED','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','statusCode','noda','21538458YfixPs','4249189MQGNYS','2gwmFfI','message','Payment\x20Link\x20ID:','GET','expiryDate','Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink','toLowerCase','Parsed\x20Result:','rejected','statusText','PaymentId','amount','completed','defineProperty','JSON\x20Parse\x20Error:\x20','10bZasUb'];a46_0x5237=function(){return _0x3565c5;};return a46_0x5237();}exports['NodaService']=NodaService;