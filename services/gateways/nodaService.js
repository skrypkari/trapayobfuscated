'use strict';const a43_0x2b6347=a43_0x2af3;(function(_0x339a8a,_0x4b1dd0){const _0x378187=a43_0x2af3,_0x45f921=_0x339a8a();while(!![]){try{const _0x35705d=parseInt(_0x378187(0x128))/0x1*(-parseInt(_0x378187(0x140))/0x2)+-parseInt(_0x378187(0xfd))/0x3+-parseInt(_0x378187(0x150))/0x4+-parseInt(_0x378187(0x12d))/0x5+-parseInt(_0x378187(0x107))/0x6+parseInt(_0x378187(0x10a))/0x7+-parseInt(_0x378187(0x12c))/0x8*(-parseInt(_0x378187(0x12b))/0x9);if(_0x35705d===_0x4b1dd0)break;else _0x45f921['push'](_0x45f921['shift']());}catch(_0x5ee26f){_0x45f921['push'](_0x45f921['shift']());}}}(a43_0x370f,0x70f01));Object[a43_0x2b6347(0x151)](exports,a43_0x2b6347(0xef),{'value':!![]}),exports[a43_0x2b6347(0xff)]=void 0x0;function a43_0x370f(){const _0x7f6ee6=['https://tesoft.uk/gateway/noda/','stack','Processing\x20Noda\x20webhook:','fromEntries','Not\x20provided','apiUrl','Error\x20details:','message','EXPIRED','expired','processWebhook','HTTP\x20Status:','256226wADqyl','Raw\x20Response\x20Body:','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','PAID','Unknown\x20error','BankId','application/json','HTTP\x20','Error\x20stack:','Payment\x20Link\x20ID:','verifyPayment','parse','‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:','Missing\x20id\x20or\x20shortLink\x20in\x20response','in_progress','statusCode','2701260IRfEiT','defineProperty','paid','error','/payment-links/','timeout','PENDING','URL:','===\x20NODA\x20SUCCESS\x20===','TesSoft\x20Payment\x20System/1.0','(8digits-8digits\x20format\x20for\x20Noda)','Order\x20ID\x20Format:','log','logWhiteDomainResponse','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','Amount','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Method','SettlementDate','__esModule','GET','logWhiteDomainError','https://tesoft.uk/gateway/pending.php?id=','Iban','status','Status\x20Code:','statusText','QR\x20Code\x20Link:','cancelled','MerchantPaymentId','headers','üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','canceled','1030128ZLTDpK','verifyWebhookSignature','NodaService','active','Response\x20data:','Short\x20Link:','HTTP\x20error!\x20status:\x20','created','/payment-links','https://tesoft.uk/gateway/noda/webhook/','537984JpknWu','Response\x20Time:','shortLinkUrls','4113389JVQEKF','Settled','POST','amount','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','completed','text','Noda\x20payment\x20verification\x20error:','toUpperCase','Failed\x20to\x20parse\x20JSON\x20response:','logWhiteDomainRequest','entries','Status\x20Text:','===\x20NODA\x20API\x20ERROR\x20===','Currency','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','Response\x20Body:','noda','PaymentId','All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid','===\x20PARSED\x20NODA\x20RESPONSE\x20===','FAILED','isActive','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','Noda\x20API\x20error:\x20','stringify','Name','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','loggerService',',\x20body:\x20','4AePSUM','Remitter','expiryDate','18828648ZGAbbO','8IoqsnM','2981495aHjSeb','shortLink','success','successful','Error\x20Message:','now','failed'];a43_0x370f=function(){return _0x7f6ee6;};return a43_0x370f();}function a43_0x2af3(_0x5ac282,_0x4b608d){const _0x370f01=a43_0x370f();return a43_0x2af3=function(_0x2af3aa,_0x34da05){_0x2af3aa=_0x2af3aa-0xe5;let _0x37c40b=_0x370f01[_0x2af3aa];return _0x37c40b;},a43_0x2af3(_0x5ac282,_0x4b608d);}const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0x16f048=a43_0x2b6347;this[_0x16f048(0x139)]=_0x16f048(0x134),console[_0x16f048(0xe8)](_0x16f048(0xfb));}async['createPaymentLink'](_0x5297f5){const _0x5ad08e=a43_0x2b6347,{orderId:_0x1d9bd9,name:_0x1a4322,paymentDescription:_0x308a1c,amount:_0x4dba9,currency:_0x9ade0e,webhookUrl:_0x1d33a0,returnUrl:_0x25b7f9,expiryDate:_0x4f2890}=_0x5297f5,_0x1bd8ac=_0x9ade0e[_0x5ad08e(0x112)](),_0x116d45=_0x5ad08e(0x106),_0x1d42c=_0x5ad08e(0xf2)+_0x1d9bd9,_0x12dbb1={'name':_0x1a4322,'paymentDescription':_0x308a1c,'amount':_0x4dba9,'currency':_0x1bd8ac,'paymentId':_0x1d9bd9,'webhookUrl':_0x116d45,'returnUrl':_0x1d42c};_0x4f2890&&(_0x12dbb1[_0x5ad08e(0x12a)]=_0x4f2890);const _0x37b422=Date[_0x5ad08e(0x132)]();try{console[_0x5ad08e(0xe8)]('===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20==='),console['log'](_0x5ad08e(0x157),this['apiUrl']),console[_0x5ad08e(0xe8)]('Request\x20Body\x20(Direct\x20JSON):',JSON[_0x5ad08e(0x123)](_0x12dbb1,null,0x2)),console[_0x5ad08e(0xe8)](_0x5ad08e(0xe7),_0x1d9bd9,_0x5ad08e(0xe6)),console[_0x5ad08e(0xe8)](_0x5ad08e(0x14c),_0x1d42c),loggerService_1[_0x5ad08e(0x126)][_0x5ad08e(0x114)](_0x5ad08e(0x11b),'/payment-links',_0x5ad08e(0x10c),_0x12dbb1);const _0x599db4=await fetch(this[_0x5ad08e(0x139)],{'method':_0x5ad08e(0x10c),'headers':{'Content-Type':_0x5ad08e(0x146),'Accept':_0x5ad08e(0x146),'User-Agent':_0x5ad08e(0xe5)},'body':JSON[_0x5ad08e(0x123)](_0x12dbb1)}),_0x2b44f6=Date[_0x5ad08e(0x132)]()-_0x37b422;console[_0x5ad08e(0xe8)](_0x5ad08e(0xea)),console[_0x5ad08e(0xe8)]('Status:',_0x599db4['status']),console['log'](_0x5ad08e(0x116),_0x599db4[_0x5ad08e(0xf6)]),console['log']('Headers:',Object[_0x5ad08e(0x137)](_0x599db4[_0x5ad08e(0xfa)][_0x5ad08e(0x115)]())),console[_0x5ad08e(0xe8)](_0x5ad08e(0x108),_0x2b44f6+'ms');const _0x189f23=await _0x599db4[_0x5ad08e(0x110)]();console[_0x5ad08e(0xe8)](_0x5ad08e(0x141),_0x189f23);if(!_0x599db4['ok']){console['error'](_0x5ad08e(0x117)),console[_0x5ad08e(0x153)](_0x5ad08e(0x13f),_0x599db4[_0x5ad08e(0xf4)]),console[_0x5ad08e(0x153)](_0x5ad08e(0x11a),_0x189f23),loggerService_1[_0x5ad08e(0x126)]['logWhiteDomainResponse']('noda',_0x5ad08e(0x105),_0x599db4[_0x5ad08e(0xf4)],_0x189f23,_0x2b44f6),loggerService_1['loggerService'][_0x5ad08e(0xf1)]('noda','/payment-links',_0x5ad08e(0x147)+_0x599db4['status']+':\x20'+_0x189f23);if(_0x599db4[_0x5ad08e(0xf4)]===0x190)throw new Error(_0x5ad08e(0x10e));else{if(_0x599db4[_0x5ad08e(0xf4)]===0x1f4)throw new Error(_0x5ad08e(0x11d));}throw new Error(_0x5ad08e(0x103)+_0x599db4[_0x5ad08e(0xf4)]+_0x5ad08e(0x127)+_0x189f23);}let _0x387548;try{_0x387548=JSON[_0x5ad08e(0x14b)](_0x189f23);}catch(_0x2d015c){console[_0x5ad08e(0x153)](_0x5ad08e(0x113),_0x2d015c),loggerService_1[_0x5ad08e(0x126)][_0x5ad08e(0xf1)](_0x5ad08e(0x11b),_0x5ad08e(0x105),'JSON\x20Parse\x20Error:\x20'+_0x2d015c);throw new Error(_0x5ad08e(0x121)+_0x189f23);}console[_0x5ad08e(0xe8)](_0x5ad08e(0x11e)),console[_0x5ad08e(0xe8)]('Parsed\x20Result:',JSON['stringify'](_0x387548,null,0x2)),loggerService_1[_0x5ad08e(0x126)][_0x5ad08e(0xe9)](_0x5ad08e(0x11b),'/payment-links',_0x599db4['status'],_0x387548,_0x2b44f6);if(_0x387548[_0x5ad08e(0x153)]||_0x387548['statusCode']){const _0x1109d9=_0x387548[_0x5ad08e(0x13b)]||_0x387548[_0x5ad08e(0x153)]||'Unknown\x20error\x20from\x20Noda\x20API';console[_0x5ad08e(0x153)](_0x5ad08e(0x142)),console['error'](_0x5ad08e(0x131),_0x1109d9),console['error'](_0x5ad08e(0xf5),_0x387548[_0x5ad08e(0x14f)]),loggerService_1['loggerService'][_0x5ad08e(0xf1)](_0x5ad08e(0x11b),_0x5ad08e(0x105),'Business\x20Error:\x20'+_0x1109d9);throw new Error(_0x5ad08e(0x122)+_0x1109d9);}if(!_0x387548['id']||!_0x387548['shortLinkUrls']?.[_0x5ad08e(0x12e)]){console[_0x5ad08e(0x153)](_0x5ad08e(0xec)),console[_0x5ad08e(0x153)](_0x5ad08e(0x14d)),console[_0x5ad08e(0x153)](_0x5ad08e(0x101),_0x387548),loggerService_1[_0x5ad08e(0x126)][_0x5ad08e(0xf1)](_0x5ad08e(0x11b),'/payment-links',_0x5ad08e(0x119));throw new Error('Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink');}return console['log'](_0x5ad08e(0x158)),console[_0x5ad08e(0xe8)](_0x5ad08e(0x149),_0x387548['id']),console[_0x5ad08e(0xe8)](_0x5ad08e(0x102),_0x387548[_0x5ad08e(0x109)][_0x5ad08e(0x12e)]),console[_0x5ad08e(0xe8)](_0x5ad08e(0xf7),_0x387548[_0x5ad08e(0x109)]['qrCodeLink']||_0x5ad08e(0x138)),console[_0x5ad08e(0xe8)]('Order\x20ID\x20Used:',_0x1d9bd9,'(8digits-8digits\x20format)'),console['log'](_0x5ad08e(0x125),_0x1d42c),{'gateway_payment_id':_0x387548['id'],'payment_url':_0x387548[_0x5ad08e(0x109)][_0x5ad08e(0x12e)],'qr_code_url':_0x387548['shortLinkUrls']['qrCodeLink'],'expiry_date':_0x387548[_0x5ad08e(0x12a)]};}catch(_0x3b18d4){console['error']('===\x20NODA\x20SERVICE\x20ERROR\x20==='),console['error'](_0x5ad08e(0x13a),_0x3b18d4),loggerService_1[_0x5ad08e(0x126)]['logWhiteDomainError']('noda','/payment-links',_0x3b18d4);if(_0x3b18d4 instanceof Error){console[_0x5ad08e(0x153)]('Error\x20message:',_0x3b18d4[_0x5ad08e(0x13b)]),console[_0x5ad08e(0x153)](_0x5ad08e(0x148),_0x3b18d4[_0x5ad08e(0x135)]);throw new Error('Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20'+_0x3b18d4[_0x5ad08e(0x13b)]);}throw new Error('Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error');}}async[a43_0x2b6347(0x14a)](_0x42fe91){const _0x4636a2=a43_0x2b6347,_0x1d5a58=Date[_0x4636a2(0x132)]();try{loggerService_1[_0x4636a2(0x126)][_0x4636a2(0x114)](_0x4636a2(0x11b),_0x4636a2(0x154)+_0x42fe91,'GET',{});const _0x14ebff=await fetch(this['apiUrl']+'/'+_0x42fe91,{'method':_0x4636a2(0xf0),'headers':{'Content-Type':_0x4636a2(0x146),'User-Agent':_0x4636a2(0xe5)}}),_0x4d574b=Date['now']()-_0x1d5a58;if(!_0x14ebff['ok']){const _0x206dcf=await _0x14ebff['text']();loggerService_1[_0x4636a2(0x126)]['logWhiteDomainResponse'](_0x4636a2(0x11b),_0x4636a2(0x154)+_0x42fe91,_0x14ebff['status'],_0x206dcf,_0x4d574b);throw new Error(_0x4636a2(0x103)+_0x14ebff[_0x4636a2(0xf4)]);}const _0x5748ad=await _0x14ebff['json']();loggerService_1[_0x4636a2(0x126)][_0x4636a2(0xe9)](_0x4636a2(0x11b),'/payment-links/'+_0x42fe91,_0x14ebff[_0x4636a2(0xf4)],_0x5748ad,_0x4d574b);if(_0x5748ad[_0x4636a2(0x153)]||_0x5748ad['statusCode']){loggerService_1[_0x4636a2(0x126)][_0x4636a2(0xf1)](_0x4636a2(0x11b),_0x4636a2(0x154)+_0x42fe91,'Noda\x20API\x20error:\x20'+(_0x5748ad[_0x4636a2(0x13b)]||_0x5748ad[_0x4636a2(0x153)]||_0x4636a2(0x144)));throw new Error(_0x4636a2(0x122)+(_0x5748ad[_0x4636a2(0x13b)]||_0x5748ad[_0x4636a2(0x153)]||_0x4636a2(0x144)));}let _0x3af33e=_0x4636a2(0x156);if(_0x5748ad['isActive']===![]){if(_0x5748ad[_0x4636a2(0x12a)]){const _0x8cfe93=new Date(_0x5748ad['expiryDate']),_0x47e222=new Date();_0x8cfe93<_0x47e222?_0x3af33e=_0x4636a2(0x13c):_0x3af33e=_0x4636a2(0x11f);}else _0x3af33e=_0x4636a2(0x11f);}else _0x3af33e=_0x4636a2(0x156);return{'status':_0x3af33e,'amount':_0x5748ad[_0x4636a2(0x10d)],'currency':_0x5748ad['currency'],'isActive':_0x5748ad[_0x4636a2(0x120)]};}catch(_0x2722e1){console[_0x4636a2(0x153)](_0x4636a2(0x111),_0x2722e1),loggerService_1['loggerService']['logWhiteDomainError']('noda',_0x4636a2(0x154)+_0x42fe91,_0x2722e1);throw new Error('Failed\x20to\x20verify\x20Noda\x20payment:\x20'+(_0x2722e1 instanceof Error?_0x2722e1[_0x4636a2(0x13b)]:_0x4636a2(0x144)));}}async[a43_0x2b6347(0x13e)](_0x154888){const _0x38695f=a43_0x2b6347;console[_0x38695f(0xe8)](_0x38695f(0x136),_0x154888);let _0x30f6c4='PENDING';switch(_0x154888['Status']?.['toLowerCase']()){case'done':case _0x38695f(0x10f):case _0x38695f(0x152):case _0x38695f(0x12f):case _0x38695f(0x130):_0x154888[_0x38695f(0x10b)]==='Yes'?_0x30f6c4=_0x38695f(0x143):_0x30f6c4=_0x38695f(0x156);break;case _0x38695f(0xf8):case _0x38695f(0xfc):case _0x38695f(0x133):case _0x38695f(0x153):case'rejected':_0x30f6c4=_0x38695f(0x11f);break;case _0x38695f(0x13d):case _0x38695f(0x155):_0x30f6c4=_0x38695f(0x13c);break;case'pending':case _0x38695f(0x104):case _0x38695f(0x100):case'processing':case _0x38695f(0x14e):default:_0x30f6c4=_0x38695f(0x156);break;}return{'paymentId':_0x154888['MerchantPaymentId']||_0x154888[_0x38695f(0x11c)],'status':_0x30f6c4,'amount':_0x154888[_0x38695f(0xeb)],'currency':_0x154888[_0x38695f(0x118)],'additionalInfo':{'method':_0x154888[_0x38695f(0xed)],'bankId':_0x154888[_0x38695f(0x145)],'settled':_0x154888[_0x38695f(0x10b)],'settlementDate':_0x154888[_0x38695f(0xee)],'remitterName':_0x154888[_0x38695f(0x129)]?.[_0x38695f(0x124)],'remitterIban':_0x154888[_0x38695f(0x129)]?.[_0x38695f(0xf3)],'bankTransactionId':_0x154888['BankTransactionId']}};}[a43_0x2b6347(0xfe)](_0x14861f,_0x483765){const _0x15c5fd=a43_0x2b6347;return console[_0x15c5fd(0xe8)]('Noda\x20webhook\x20signature\x20verification:',{'receivedSignature':_0x483765,'paymentId':_0x14861f['PaymentId'],'merchantPaymentId':_0x14861f[_0x15c5fd(0xf9)]}),!![];}}exports[a43_0x2b6347(0xff)]=NodaService;