'use strict';const a43_0x344710=a43_0x1ae8;(function(_0x4a3f00,_0x1d905d){const _0x4709f4=a43_0x1ae8,_0x4478e2=_0x4a3f00();while(!![]){try{const _0x34dd0f=-parseInt(_0x4709f4(0x156))/0x1*(parseInt(_0x4709f4(0x176))/0x2)+-parseInt(_0x4709f4(0x195))/0x3*(parseInt(_0x4709f4(0x153))/0x4)+-parseInt(_0x4709f4(0x170))/0x5*(-parseInt(_0x4709f4(0x17b))/0x6)+parseInt(_0x4709f4(0x12d))/0x7+-parseInt(_0x4709f4(0x177))/0x8+-parseInt(_0x4709f4(0x15c))/0x9*(parseInt(_0x4709f4(0x135))/0xa)+parseInt(_0x4709f4(0x150))/0xb;if(_0x34dd0f===_0x1d905d)break;else _0x4478e2['push'](_0x4478e2['shift']());}catch(_0x189b65){_0x4478e2['push'](_0x4478e2['shift']());}}}(a43_0x2066,0xa8e3e));function a43_0x2066(){const _0x709e77=['cancelled','188677OJtQpd','/payment-links','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','EXPIRED','now','logWhiteDomainError','117oDmkXE','Error\x20Message:','log','rejected','processWebhook','Unknown\x20error\x20from\x20Noda\x20API','PAID','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','Method','Noda\x20API\x20error:\x20','/payment-links/','TesSoft\x20Payment\x20System/1.0','JSON\x20Parse\x20Error:\x20','PENDING','Noda\x20webhook\x20signature\x20verification:','https://tesoft.uk/gateway/pending.php?id=','Error\x20stack:','Iban','BankId','timeout','2310zbTOnI','Status','Error\x20message:','Response\x20data:','text','failed','12cflGPz','3733216jKLeAP','processing','All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid','canceled','804DyLtyc','isActive','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','shortLinkUrls','entries','qrCodeLink','SettlementDate','noda','Unknown\x20error','GET','Remitter','loggerService','===\x20PARSED\x20NODA\x20RESPONSE\x20===','Business\x20Error:\x20','fromEntries','apiUrl','Short\x20Link:','QR\x20Code\x20Link:','active','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20===','URL:','in_progress','createPaymentLink','Status:','stringify','Settled','189GhKpEi','done','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','paid','shortLink','headers','PaymentId','NodaService','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','Not\x20provided',',\x20body:\x20','expired','FAILED','success','expiryDate','Response\x20Time:','===\x20NODA\x20SERVICE\x20ERROR\x20===','3183649JnmTQE','statusCode','logWhiteDomainResponse','Status\x20Text:','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','completed','currency','../loggerService','461010JYZiBX','application/json','(8digits-8digits\x20format\x20for\x20Noda)','Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','===\x20NODA\x20SUCCESS\x20===','BankTransactionId','Amount','Failed\x20to\x20verify\x20Noda\x20payment:\x20','error','toUpperCase','HTTP\x20','__esModule','Raw\x20Response\x20Body:','üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','logWhiteDomainRequest','POST','Response\x20Body:','Yes','Error\x20details:','pending','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','status','‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:','json','MerchantPaymentId','HTTP\x20error!\x20status:\x20','33630619RmaRVk','message','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','43444eryQHU','Noda\x20payment\x20verification\x20error:'];a43_0x2066=function(){return _0x709e77;};return a43_0x2066();}Object['defineProperty'](exports,a43_0x344710(0x141),{'value':!![]}),exports[a43_0x344710(0x19c)]=void 0x0;function a43_0x1ae8(_0x31ceaa,_0x4989f4){const _0x2066d3=a43_0x2066();return a43_0x1ae8=function(_0x1ae870,_0x32d0d8){_0x1ae870=_0x1ae870-0x12a;let _0x25e6ac=_0x2066d3[_0x1ae870];return _0x25e6ac;},a43_0x1ae8(_0x31ceaa,_0x4989f4);}const loggerService_1=require(a43_0x344710(0x134));class NodaService{constructor(){const _0xc06fe7=a43_0x344710;this['apiUrl']='https://tesoft.uk/gateway/noda/',console[_0xc06fe7(0x15e)](_0xc06fe7(0x143));}async[a43_0x344710(0x191)](_0x218e30){const _0x2dd738=a43_0x344710,{orderId:_0xfdcd24,name:_0x4f2d7f,paymentDescription:_0x31cfb1,amount:_0x141623,currency:_0x18ccbe,webhookUrl:_0x158c05,returnUrl:_0x3d6c93,expiryDate:_0x586020}=_0x218e30,_0x1b51bc=_0x18ccbe[_0x2dd738(0x13f)](),_0x4a31ea='https://tesoft.uk/gateway/noda/webhook/',_0x54244d=_0x2dd738(0x16b)+_0xfdcd24,_0x288c7c={'name':_0x4f2d7f,'paymentDescription':_0x31cfb1,'amount':_0x141623,'currency':_0x1b51bc,'paymentId':_0xfdcd24,'webhookUrl':_0x4a31ea,'returnUrl':_0x54244d};_0x586020&&(_0x288c7c[_0x2dd738(0x12a)]=_0x586020);const _0x1c3a41=Date[_0x2dd738(0x15a)]();try{console[_0x2dd738(0x15e)](_0x2dd738(0x18e)),console[_0x2dd738(0x15e)](_0x2dd738(0x18f),this[_0x2dd738(0x18a)]),console[_0x2dd738(0x15e)]('Request\x20Body\x20(Direct\x20JSON):',JSON[_0x2dd738(0x193)](_0x288c7c,null,0x2)),console['log']('Order\x20ID\x20Format:',_0xfdcd24,_0x2dd738(0x137)),console[_0x2dd738(0x15e)](_0x2dd738(0x14c),_0x54244d),loggerService_1[_0x2dd738(0x186)][_0x2dd738(0x144)](_0x2dd738(0x182),'/payment-links',_0x2dd738(0x145),_0x288c7c);const _0x4cccaf=await fetch(this[_0x2dd738(0x18a)],{'method':_0x2dd738(0x145),'headers':{'Content-Type':_0x2dd738(0x136),'Accept':_0x2dd738(0x136),'User-Agent':_0x2dd738(0x167)},'body':JSON[_0x2dd738(0x193)](_0x288c7c)}),_0x419686=Date[_0x2dd738(0x15a)]()-_0x1c3a41;console[_0x2dd738(0x15e)](_0x2dd738(0x197)),console[_0x2dd738(0x15e)](_0x2dd738(0x192),_0x4cccaf['status']),console[_0x2dd738(0x15e)](_0x2dd738(0x130),_0x4cccaf['statusText']),console[_0x2dd738(0x15e)]('Headers:',Object[_0x2dd738(0x189)](_0x4cccaf[_0x2dd738(0x19a)][_0x2dd738(0x17f)]())),console[_0x2dd738(0x15e)](_0x2dd738(0x12b),_0x419686+'ms');const _0x3763db=await _0x4cccaf['text']();console[_0x2dd738(0x15e)](_0x2dd738(0x142),_0x3763db);if(!_0x4cccaf['ok']){console[_0x2dd738(0x13e)]('===\x20NODA\x20API\x20ERROR\x20==='),console[_0x2dd738(0x13e)]('HTTP\x20Status:',_0x4cccaf[_0x2dd738(0x14b)]),console[_0x2dd738(0x13e)](_0x2dd738(0x146),_0x3763db),loggerService_1['loggerService'][_0x2dd738(0x12f)](_0x2dd738(0x182),'/payment-links',_0x4cccaf[_0x2dd738(0x14b)],_0x3763db,_0x419686),loggerService_1[_0x2dd738(0x186)][_0x2dd738(0x15b)](_0x2dd738(0x182),'/payment-links',_0x2dd738(0x140)+_0x4cccaf[_0x2dd738(0x14b)]+':\x20'+_0x3763db);if(_0x4cccaf[_0x2dd738(0x14b)]===0x190)throw new Error(_0x2dd738(0x152));else{if(_0x4cccaf[_0x2dd738(0x14b)]===0x1f4)throw new Error(_0x2dd738(0x179));}throw new Error(_0x2dd738(0x14f)+_0x4cccaf['status']+_0x2dd738(0x19f)+_0x3763db);}let _0x395f89;try{_0x395f89=JSON['parse'](_0x3763db);}catch(_0x3b2099){console[_0x2dd738(0x13e)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x3b2099),loggerService_1['loggerService'][_0x2dd738(0x15b)]('noda',_0x2dd738(0x157),_0x2dd738(0x168)+_0x3b2099);throw new Error(_0x2dd738(0x17d)+_0x3763db);}console[_0x2dd738(0x15e)](_0x2dd738(0x187)),console[_0x2dd738(0x15e)]('Parsed\x20Result:',JSON['stringify'](_0x395f89,null,0x2)),loggerService_1['loggerService'][_0x2dd738(0x12f)](_0x2dd738(0x182),_0x2dd738(0x157),_0x4cccaf[_0x2dd738(0x14b)],_0x395f89,_0x419686);if(_0x395f89[_0x2dd738(0x13e)]||_0x395f89['statusCode']){const _0x27d120=_0x395f89['message']||_0x395f89[_0x2dd738(0x13e)]||_0x2dd738(0x161);console[_0x2dd738(0x13e)](_0x2dd738(0x19d)),console[_0x2dd738(0x13e)](_0x2dd738(0x15d),_0x27d120),console[_0x2dd738(0x13e)]('Status\x20Code:',_0x395f89['statusCode']),loggerService_1[_0x2dd738(0x186)][_0x2dd738(0x15b)]('noda','/payment-links',_0x2dd738(0x188)+_0x27d120);throw new Error('Noda\x20API\x20error:\x20'+_0x27d120);}if(!_0x395f89['id']||!_0x395f89['shortLinkUrls']?.[_0x2dd738(0x199)]){console[_0x2dd738(0x13e)](_0x2dd738(0x139)),console['error']('Missing\x20id\x20or\x20shortLink\x20in\x20response'),console[_0x2dd738(0x13e)](_0x2dd738(0x173),_0x395f89),loggerService_1[_0x2dd738(0x186)]['logWhiteDomainError'](_0x2dd738(0x182),_0x2dd738(0x157),_0x2dd738(0x14a));throw new Error(_0x2dd738(0x138));}return console[_0x2dd738(0x15e)](_0x2dd738(0x13a)),console[_0x2dd738(0x15e)]('Payment\x20Link\x20ID:',_0x395f89['id']),console['log'](_0x2dd738(0x18b),_0x395f89[_0x2dd738(0x17e)][_0x2dd738(0x199)]),console['log'](_0x2dd738(0x18c),_0x395f89['shortLinkUrls'][_0x2dd738(0x180)]||_0x2dd738(0x19e)),console[_0x2dd738(0x15e)]('Order\x20ID\x20Used:',_0xfdcd24,'(8digits-8digits\x20format)'),console[_0x2dd738(0x15e)](_0x2dd738(0x158),_0x54244d),{'gateway_payment_id':_0x395f89['id'],'payment_url':_0x395f89[_0x2dd738(0x17e)][_0x2dd738(0x199)],'qr_code_url':_0x395f89[_0x2dd738(0x17e)][_0x2dd738(0x180)],'expiry_date':_0x395f89[_0x2dd738(0x12a)]};}catch(_0x2816b){console[_0x2dd738(0x13e)](_0x2dd738(0x12c)),console[_0x2dd738(0x13e)](_0x2dd738(0x148),_0x2816b),loggerService_1[_0x2dd738(0x186)][_0x2dd738(0x15b)](_0x2dd738(0x182),_0x2dd738(0x157),_0x2816b);if(_0x2816b instanceof Error){console['error'](_0x2dd738(0x172),_0x2816b[_0x2dd738(0x151)]),console['error'](_0x2dd738(0x16c),_0x2816b['stack']);throw new Error(_0x2dd738(0x131)+_0x2816b[_0x2dd738(0x151)]);}throw new Error(_0x2dd738(0x163));}}async['verifyPayment'](_0x40df04){const _0x425d08=a43_0x344710,_0x457eee=Date[_0x425d08(0x15a)]();try{loggerService_1[_0x425d08(0x186)]['logWhiteDomainRequest'](_0x425d08(0x182),_0x425d08(0x166)+_0x40df04,_0x425d08(0x184),{});const _0x11968e=await fetch(this['apiUrl']+'/'+_0x40df04,{'method':'GET','headers':{'Content-Type':_0x425d08(0x136),'User-Agent':_0x425d08(0x167)}}),_0x4d5676=Date[_0x425d08(0x15a)]()-_0x457eee;if(!_0x11968e['ok']){const _0x3d9f51=await _0x11968e[_0x425d08(0x174)]();loggerService_1['loggerService'][_0x425d08(0x12f)](_0x425d08(0x182),_0x425d08(0x166)+_0x40df04,_0x11968e[_0x425d08(0x14b)],_0x3d9f51,_0x4d5676);throw new Error(_0x425d08(0x14f)+_0x11968e[_0x425d08(0x14b)]);}const _0x13796d=await _0x11968e[_0x425d08(0x14d)]();loggerService_1[_0x425d08(0x186)][_0x425d08(0x12f)]('noda',_0x425d08(0x166)+_0x40df04,_0x11968e[_0x425d08(0x14b)],_0x13796d,_0x4d5676);if(_0x13796d[_0x425d08(0x13e)]||_0x13796d[_0x425d08(0x12e)]){loggerService_1['loggerService'][_0x425d08(0x15b)](_0x425d08(0x182),'/payment-links/'+_0x40df04,_0x425d08(0x165)+(_0x13796d[_0x425d08(0x151)]||_0x13796d[_0x425d08(0x13e)]||_0x425d08(0x183)));throw new Error(_0x425d08(0x165)+(_0x13796d['message']||_0x13796d[_0x425d08(0x13e)]||_0x425d08(0x183)));}let _0x51b919='PENDING';if(_0x13796d[_0x425d08(0x17c)]===![]){if(_0x13796d['expiryDate']){const _0x4dad96=new Date(_0x13796d[_0x425d08(0x12a)]),_0x4b3233=new Date();_0x4dad96<_0x4b3233?_0x51b919=_0x425d08(0x159):_0x51b919=_0x425d08(0x1a1);}else _0x51b919=_0x425d08(0x1a1);}else _0x51b919=_0x425d08(0x169);return{'status':_0x51b919,'amount':_0x13796d['amount'],'currency':_0x13796d[_0x425d08(0x133)],'isActive':_0x13796d['isActive']};}catch(_0x4666ff){console[_0x425d08(0x13e)](_0x425d08(0x154),_0x4666ff),loggerService_1['loggerService']['logWhiteDomainError'](_0x425d08(0x182),_0x425d08(0x166)+_0x40df04,_0x4666ff);throw new Error(_0x425d08(0x13d)+(_0x4666ff instanceof Error?_0x4666ff[_0x425d08(0x151)]:_0x425d08(0x183)));}}async[a43_0x344710(0x160)](_0x543ae4){const _0x4f378c=a43_0x344710;console[_0x4f378c(0x15e)]('Processing\x20Noda\x20webhook:',_0x543ae4);let _0x237226='PENDING';switch(_0x543ae4[_0x4f378c(0x171)]?.['toLowerCase']()){case _0x4f378c(0x196):case _0x4f378c(0x132):case _0x4f378c(0x198):case _0x4f378c(0x1a2):case'successful':_0x543ae4[_0x4f378c(0x194)]===_0x4f378c(0x147)?_0x237226=_0x4f378c(0x162):_0x237226=_0x4f378c(0x169);break;case _0x4f378c(0x155):case _0x4f378c(0x17a):case _0x4f378c(0x175):case _0x4f378c(0x13e):case _0x4f378c(0x15f):_0x237226=_0x4f378c(0x1a1);break;case _0x4f378c(0x1a0):case _0x4f378c(0x16f):_0x237226=_0x4f378c(0x159);break;case _0x4f378c(0x149):case'created':case _0x4f378c(0x18d):case _0x4f378c(0x178):case _0x4f378c(0x190):default:_0x237226='PENDING';break;}return{'paymentId':_0x543ae4[_0x4f378c(0x14e)]||_0x543ae4[_0x4f378c(0x19b)],'status':_0x237226,'amount':_0x543ae4[_0x4f378c(0x13c)],'currency':_0x543ae4['Currency'],'additionalInfo':{'method':_0x543ae4[_0x4f378c(0x164)],'bankId':_0x543ae4[_0x4f378c(0x16e)],'settled':_0x543ae4[_0x4f378c(0x194)],'settlementDate':_0x543ae4[_0x4f378c(0x181)],'remitterName':_0x543ae4[_0x4f378c(0x185)]?.['Name'],'remitterIban':_0x543ae4[_0x4f378c(0x185)]?.[_0x4f378c(0x16d)],'bankTransactionId':_0x543ae4[_0x4f378c(0x13b)]}};}['verifyWebhookSignature'](_0x370b94,_0x1f9908){const _0xd4cde=a43_0x344710;return console[_0xd4cde(0x15e)](_0xd4cde(0x16a),{'receivedSignature':_0x1f9908,'paymentId':_0x370b94[_0xd4cde(0x19b)],'merchantPaymentId':_0x370b94[_0xd4cde(0x14e)]}),!![];}}exports[a43_0x344710(0x19c)]=NodaService;