'use strict';const a65_0x158415=a65_0x3df5;(function(_0x38218f,_0x4bd858){const _0x3ac213=a65_0x3df5,_0x2bf898=_0x38218f();while(!![]){try{const _0x1c8082=parseInt(_0x3ac213(0x100))/0x1+parseInt(_0x3ac213(0x15d))/0x2+-parseInt(_0x3ac213(0x106))/0x3+-parseInt(_0x3ac213(0x11d))/0x4*(-parseInt(_0x3ac213(0x15b))/0x5)+-parseInt(_0x3ac213(0x10e))/0x6+parseInt(_0x3ac213(0x134))/0x7*(parseInt(_0x3ac213(0x11b))/0x8)+-parseInt(_0x3ac213(0xf9))/0x9*(parseInt(_0x3ac213(0x141))/0xa);if(_0x1c8082===_0x4bd858)break;else _0x2bf898['push'](_0x2bf898['shift']());}catch(_0x37baa2){_0x2bf898['push'](_0x2bf898['shift']());}}}(a65_0x5900,0xbd4a2));Object[a65_0x158415(0x146)](exports,a65_0x158415(0x152),{'value':!![]}),exports['NodaService']=void 0x0;const loggerService_1=require(a65_0x158415(0x111));function a65_0x5900(){const _0x4432aa=['created','46062gmaBOG','logWhiteDomainRequest','done','log','/payment-links','createPaymentLink','processing','617017zUlRFq','===\x20PARSED\x20NODA\x20RESPONSE\x20===','MerchantPaymentId','Noda\x20webhook\x20signature\x20verification:','POST','https://tesoft.uk/gateway/noda/webhook/','1590717fOZVXG',',\x20body:\x20','HTTP\x20Status:','Response\x20Body:','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','Payment\x20System/1.0','stack','PENDING','6558078ipsLSc','Request\x20Body\x20(Direct\x20JSON):','isActive','../loggerService','Remitter','error','headers','NodaService','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','toLowerCase','verifyWebhookSignature','Failed\x20to\x20verify\x20Noda\x20payment:\x20','Status\x20Code:','16rlKCwP','Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink','267832ErkUJf','Response\x20Time:','json','Headers:','statusCode','Response\x20data:','Amount','paid','‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:','Missing\x20id\x20or\x20shortLink\x20in\x20response','status','shortLink','noda','EXPIRED','application/json','completed','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','FAILED','GET','logWhiteDomainError','Raw\x20Response\x20Body:','shortLinkUrls','Error\x20Message:','4710776GArAtp','pending','expiryDate','Settled','amount','qrCodeLink','canceled','cancelled','parse','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','BankId','toUpperCase','===\x20NODA\x20SERVICE\x20ERROR\x20===','2180uNzPWJ','stringify','All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid','Status:','entries','defineProperty','Unknown\x20error','Noda\x20API\x20error:\x20','Failed\x20to\x20parse\x20JSON\x20response:','Parsed\x20Result:','Not\x20provided','Error\x20message:','text','HTTP\x20error!\x20status:\x20','BankTransactionId','Status\x20Text:','Order\x20ID\x20Format:','__esModule','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','currency','timeout','/payment-links/','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','loggerService','Business\x20Error:\x20','35Lamckc','message','2165294FdAdCv','(8digits-8digits\x20format)','now','apiUrl','PaymentId','logWhiteDomainResponse','Short\x20Link:','fromEntries','Noda\x20payment\x20verification\x20error:','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20==='];a65_0x5900=function(){return _0x4432aa;};return a65_0x5900();}function a65_0x3df5(_0xe3049c,_0x5440ce){_0xe3049c=_0xe3049c-0xf0;const _0x5900c8=a65_0x5900();let _0x3df51f=_0x5900c8[_0xe3049c];return _0x3df51f;}class NodaService{constructor(){const _0x66f21=a65_0x158415;this[_0x66f21(0xf1)]='https://tesoft.uk/gateway/noda/',console[_0x66f21(0xfc)]('üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy');}async[a65_0x158415(0xfe)](_0xd97f04){const _0x5ade57=a65_0x158415,{orderId:_0x1ec203,name:_0x28e8fc,paymentDescription:_0x58b822,amount:_0x1fbb1e,currency:_0xaa2455,webhookUrl:_0x5dae97,returnUrl:_0x2b1503,expiryDate:_0x35d43b}=_0xd97f04,_0x4230d7=_0xaa2455[_0x5ade57(0x13f)](),_0x4c0b38=_0x5ade57(0x105),_0x5c6d8f='https://tesoft.uk/gateway/pending.php?id='+_0x1ec203,_0x2cc51e={'name':_0x28e8fc,'paymentDescription':_0x58b822,'amount':_0x1fbb1e,'currency':_0x4230d7,'paymentId':_0x1ec203,'webhookUrl':_0x4c0b38,'returnUrl':_0x5c6d8f};_0x35d43b&&(_0x2cc51e[_0x5ade57(0x136)]=_0x35d43b);const _0x4a52cd=Date[_0x5ade57(0xf0)]();try{console[_0x5ade57(0xfc)](_0x5ade57(0xf7)),console[_0x5ade57(0xfc)]('URL:',this[_0x5ade57(0xf1)]),console[_0x5ade57(0xfc)](_0x5ade57(0x10f),JSON[_0x5ade57(0x142)](_0x2cc51e,null,0x2)),console[_0x5ade57(0xfc)](_0x5ade57(0x151),_0x1ec203,'(8digits-8digits\x20format\x20for\x20Noda)'),console[_0x5ade57(0xfc)](_0x5ade57(0x125),_0x5c6d8f),loggerService_1['loggerService']['logWhiteDomainRequest'](_0x5ade57(0x129),_0x5ade57(0xfd),'POST',_0x2cc51e);const _0x2b90d5=await fetch(this[_0x5ade57(0xf1)],{'method':_0x5ade57(0x104),'headers':{'Content-Type':_0x5ade57(0x12b),'Accept':'application/json','User-Agent':_0x5ade57(0x10b)},'body':JSON[_0x5ade57(0x142)](_0x2cc51e)}),_0x3debab=Date[_0x5ade57(0xf0)]()-_0x4a52cd;console[_0x5ade57(0xfc)](_0x5ade57(0x158)),console[_0x5ade57(0xfc)](_0x5ade57(0x144),_0x2b90d5[_0x5ade57(0x127)]),console[_0x5ade57(0xfc)](_0x5ade57(0x150),_0x2b90d5['statusText']),console[_0x5ade57(0xfc)](_0x5ade57(0x120),Object[_0x5ade57(0xf5)](_0x2b90d5[_0x5ade57(0x114)][_0x5ade57(0x145)]())),console[_0x5ade57(0xfc)](_0x5ade57(0x11e),_0x3debab+'ms');const _0x2cc731=await _0x2b90d5['text']();console['log'](_0x5ade57(0x131),_0x2cc731);if(!_0x2b90d5['ok']){console[_0x5ade57(0x113)]('===\x20NODA\x20API\x20ERROR\x20==='),console[_0x5ade57(0x113)](_0x5ade57(0x108),_0x2b90d5[_0x5ade57(0x127)]),console[_0x5ade57(0x113)](_0x5ade57(0x109),_0x2cc731),loggerService_1[_0x5ade57(0x159)][_0x5ade57(0xf3)](_0x5ade57(0x129),'/payment-links',_0x2b90d5['status'],_0x2cc731,_0x3debab),loggerService_1['loggerService'][_0x5ade57(0x130)]('noda','/payment-links','HTTP\x20'+_0x2b90d5['status']+':\x20'+_0x2cc731);if(_0x2b90d5[_0x5ade57(0x127)]===0x190)throw new Error(_0x5ade57(0x10a));else{if(_0x2b90d5[_0x5ade57(0x127)]===0x1f4)throw new Error(_0x5ade57(0x143));}throw new Error(_0x5ade57(0x14e)+_0x2b90d5['status']+_0x5ade57(0x107)+_0x2cc731);}let _0x3394ad;try{_0x3394ad=JSON[_0x5ade57(0x13c)](_0x2cc731);}catch(_0x3b2245){console[_0x5ade57(0x113)](_0x5ade57(0x149),_0x3b2245),loggerService_1[_0x5ade57(0x159)][_0x5ade57(0x130)]('noda','/payment-links','JSON\x20Parse\x20Error:\x20'+_0x3b2245);throw new Error(_0x5ade57(0x153)+_0x2cc731);}console[_0x5ade57(0xfc)](_0x5ade57(0x101)),console['log'](_0x5ade57(0x14a),JSON[_0x5ade57(0x142)](_0x3394ad,null,0x2)),loggerService_1[_0x5ade57(0x159)]['logWhiteDomainResponse'](_0x5ade57(0x129),_0x5ade57(0xfd),_0x2b90d5['status'],_0x3394ad,_0x3debab);if(_0x3394ad[_0x5ade57(0x113)]||_0x3394ad[_0x5ade57(0x121)]){const _0x50eb97=_0x3394ad[_0x5ade57(0x15c)]||_0x3394ad[_0x5ade57(0x113)]||'Unknown\x20error\x20from\x20Noda\x20API';console[_0x5ade57(0x113)]('===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x5ade57(0x113)](_0x5ade57(0x133),_0x50eb97),console[_0x5ade57(0x113)](_0x5ade57(0x11a),_0x3394ad[_0x5ade57(0x121)]),loggerService_1[_0x5ade57(0x159)]['logWhiteDomainError'](_0x5ade57(0x129),_0x5ade57(0xfd),_0x5ade57(0x15a)+_0x50eb97);throw new Error(_0x5ade57(0x148)+_0x50eb97);}if(!_0x3394ad['id']||!_0x3394ad[_0x5ade57(0x132)]?.[_0x5ade57(0x128)]){console[_0x5ade57(0x113)]('===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x5ade57(0x113)](_0x5ade57(0x126)),console[_0x5ade57(0x113)](_0x5ade57(0x122),_0x3394ad),loggerService_1[_0x5ade57(0x159)][_0x5ade57(0x130)](_0x5ade57(0x129),_0x5ade57(0xfd),_0x5ade57(0x116));throw new Error(_0x5ade57(0x11c));}return console[_0x5ade57(0xfc)]('===\x20NODA\x20SUCCESS\x20==='),console['log']('Payment\x20Link\x20ID:',_0x3394ad['id']),console['log'](_0x5ade57(0xf4),_0x3394ad[_0x5ade57(0x132)][_0x5ade57(0x128)]),console[_0x5ade57(0xfc)]('QR\x20Code\x20Link:',_0x3394ad[_0x5ade57(0x132)]['qrCodeLink']||_0x5ade57(0x14b)),console['log']('Order\x20ID\x20Used:',_0x1ec203,_0x5ade57(0x15e)),console['log'](_0x5ade57(0x157),_0x5c6d8f),{'gateway_payment_id':_0x3394ad['id'],'payment_url':_0x3394ad['shortLinkUrls'][_0x5ade57(0x128)],'qr_code_url':_0x3394ad[_0x5ade57(0x132)][_0x5ade57(0x139)],'expiry_date':_0x3394ad['expiryDate']};}catch(_0x4cf1dd){console[_0x5ade57(0x113)](_0x5ade57(0x140)),console[_0x5ade57(0x113)]('Error\x20details:',_0x4cf1dd),loggerService_1[_0x5ade57(0x159)][_0x5ade57(0x130)](_0x5ade57(0x129),_0x5ade57(0xfd),_0x4cf1dd);if(_0x4cf1dd instanceof Error){console[_0x5ade57(0x113)](_0x5ade57(0x14c),_0x4cf1dd['message']),console[_0x5ade57(0x113)]('Error\x20stack:',_0x4cf1dd[_0x5ade57(0x10c)]);throw new Error(_0x5ade57(0x12d)+_0x4cf1dd[_0x5ade57(0x15c)]);}throw new Error(_0x5ade57(0x13d));}}async['verifyPayment'](_0x24411e){const _0x38c8aa=a65_0x158415,_0x1aa2d5=Date[_0x38c8aa(0xf0)]();try{loggerService_1[_0x38c8aa(0x159)][_0x38c8aa(0xfa)](_0x38c8aa(0x129),'/payment-links/'+_0x24411e,_0x38c8aa(0x12f),{});const _0x5c63ac=await fetch(this[_0x38c8aa(0xf1)]+'/'+_0x24411e,{'method':_0x38c8aa(0x12f),'headers':{'Content-Type':_0x38c8aa(0x12b),'User-Agent':_0x38c8aa(0x10b)}}),_0x241a1e=Date['now']()-_0x1aa2d5;if(!_0x5c63ac['ok']){const _0x3012bb=await _0x5c63ac[_0x38c8aa(0x14d)]();loggerService_1[_0x38c8aa(0x159)]['logWhiteDomainResponse'](_0x38c8aa(0x129),_0x38c8aa(0x156)+_0x24411e,_0x5c63ac[_0x38c8aa(0x127)],_0x3012bb,_0x241a1e);throw new Error(_0x38c8aa(0x14e)+_0x5c63ac[_0x38c8aa(0x127)]);}const _0x33f29c=await _0x5c63ac[_0x38c8aa(0x11f)]();loggerService_1[_0x38c8aa(0x159)][_0x38c8aa(0xf3)]('noda','/payment-links/'+_0x24411e,_0x5c63ac[_0x38c8aa(0x127)],_0x33f29c,_0x241a1e);if(_0x33f29c['error']||_0x33f29c['statusCode']){loggerService_1[_0x38c8aa(0x159)][_0x38c8aa(0x130)]('noda',_0x38c8aa(0x156)+_0x24411e,_0x38c8aa(0x148)+(_0x33f29c['message']||_0x33f29c[_0x38c8aa(0x113)]||_0x38c8aa(0x147)));throw new Error(_0x38c8aa(0x148)+(_0x33f29c['message']||_0x33f29c[_0x38c8aa(0x113)]||_0x38c8aa(0x147)));}let _0x3d88b1=_0x38c8aa(0x10d);if(_0x33f29c[_0x38c8aa(0x110)]===![]){if(_0x33f29c[_0x38c8aa(0x136)]){const _0x553610=new Date(_0x33f29c[_0x38c8aa(0x136)]),_0x11e5fc=new Date();_0x553610<_0x11e5fc?_0x3d88b1=_0x38c8aa(0x12a):_0x3d88b1=_0x38c8aa(0x12e);}else _0x3d88b1=_0x38c8aa(0x12e);}else _0x3d88b1=_0x38c8aa(0x10d);return{'status':_0x3d88b1,'amount':_0x33f29c[_0x38c8aa(0x138)],'currency':_0x33f29c[_0x38c8aa(0x154)],'isActive':_0x33f29c[_0x38c8aa(0x110)]};}catch(_0x43123b){console['error'](_0x38c8aa(0xf6),_0x43123b),loggerService_1[_0x38c8aa(0x159)]['logWhiteDomainError'](_0x38c8aa(0x129),_0x38c8aa(0x156)+_0x24411e,_0x43123b);throw new Error(_0x38c8aa(0x119)+(_0x43123b instanceof Error?_0x43123b[_0x38c8aa(0x15c)]:_0x38c8aa(0x147)));}}async['processWebhook'](_0x5c1b99){const _0xa8246d=a65_0x158415;console[_0xa8246d(0xfc)]('Processing\x20Noda\x20webhook:',_0x5c1b99);let _0x17936a=_0xa8246d(0x10d);switch(_0x5c1b99['Status']?.[_0xa8246d(0x117)]()){case _0xa8246d(0xfb):case _0xa8246d(0x12c):case _0xa8246d(0x124):case'success':case'successful':_0x5c1b99['Settled']==='Yes'?_0x17936a='PAID':_0x17936a=_0xa8246d(0x10d);break;case _0xa8246d(0x13b):case _0xa8246d(0x13a):case'failed':case _0xa8246d(0x113):case'rejected':_0x17936a=_0xa8246d(0x12e);break;case'expired':case _0xa8246d(0x155):_0x17936a=_0xa8246d(0x12a);break;case _0xa8246d(0x135):case _0xa8246d(0xf8):case'active':case _0xa8246d(0xff):case'in_progress':default:_0x17936a='PENDING';break;}return{'paymentId':_0x5c1b99[_0xa8246d(0x102)]||_0x5c1b99['PaymentId'],'status':_0x17936a,'amount':_0x5c1b99[_0xa8246d(0x123)],'currency':_0x5c1b99['Currency'],'additionalInfo':{'method':_0x5c1b99['Method'],'bankId':_0x5c1b99[_0xa8246d(0x13e)],'settled':_0x5c1b99[_0xa8246d(0x137)],'settlementDate':_0x5c1b99['SettlementDate'],'remitterName':_0x5c1b99[_0xa8246d(0x112)]?.['Name'],'remitterIban':_0x5c1b99[_0xa8246d(0x112)]?.['Iban'],'bankTransactionId':_0x5c1b99[_0xa8246d(0x14f)]}};}[a65_0x158415(0x118)](_0x6cf9e1,_0x46d1c9){const _0x48c5b7=a65_0x158415;return console[_0x48c5b7(0xfc)](_0x48c5b7(0x103),{'receivedSignature':_0x46d1c9,'paymentId':_0x6cf9e1[_0x48c5b7(0xf2)],'merchantPaymentId':_0x6cf9e1[_0x48c5b7(0x102)]}),!![];}}exports[a65_0x158415(0x115)]=NodaService;