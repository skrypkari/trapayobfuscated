'use strict';const a40_0x5341d7=a40_0x3e48;(function(_0x2b3cb3,_0xe9e16b){const _0x22ef6c=a40_0x3e48,_0x209df0=_0x2b3cb3();while(!![]){try{const _0x4e0538=parseInt(_0x22ef6c(0xad))/0x1+parseInt(_0x22ef6c(0xbc))/0x2+-parseInt(_0x22ef6c(0xda))/0x3+parseInt(_0x22ef6c(0xc8))/0x4*(parseInt(_0x22ef6c(0xc7))/0x5)+parseInt(_0x22ef6c(0xc4))/0x6*(-parseInt(_0x22ef6c(0xd3))/0x7)+-parseInt(_0x22ef6c(0xba))/0x8+parseInt(_0x22ef6c(0xb8))/0x9*(-parseInt(_0x22ef6c(0x102))/0xa);if(_0x4e0538===_0xe9e16b)break;else _0x209df0['push'](_0x209df0['shift']());}catch(_0x34dd2c){_0x209df0['push'](_0x209df0['shift']());}}}(a40_0x504c,0x4fcb1));function a40_0x3e48(_0x5367c3,_0x422923){const _0x504c0c=a40_0x504c();return a40_0x3e48=function(_0x3e48d5,_0x4197b2){_0x3e48d5=_0x3e48d5-0xaa;let _0x409d98=_0x504c0c[_0x3e48d5];return _0x409d98;},a40_0x3e48(_0x5367c3,_0x422923);}Object[a40_0x5341d7(0x10b)](exports,a40_0x5341d7(0x11c),{'value':!![]}),exports['NodaService']=void 0x0;function a40_0x504c(){const _0x3939db=['Error\x20Message:','timeout','QR\x20Code\x20Link:','Settled','Failed\x20to\x20verify\x20Noda\x20payment:\x20','expired','entries','Method','===\x20NODA\x20SUCCESS\x20===','4939929IfJEAt','created','1475088rPwkdW','pending','1080404caUdTW','verifyPayment','All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid','/payment-links/','NodaService','TesSoft\x20Payment\x20System/1.0','isActive','BankId','274734lHEiZV','Headers:','Response\x20Time:','1877765yfCbLr','4IihflX','PaymentId','active','stringify','qrCodeLink','===\x20PARSED\x20NODA\x20RESPONSE\x20===','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','stack','Remitter','statusText','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','21ECcGuh','Unknown\x20error','Request\x20Body\x20(Direct\x20JSON):','apiUrl','paid','Response\x20data:','shortLink','619119AjFObk','(8digits-8digits\x20format)','Name','Currency','MerchantPaymentId','Error\x20stack:','currency','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','PAID','https://tesoft.uk/gateway/success.php?id=','text','HTTP\x20','HTTP\x20error!\x20status:\x20','application/json','URL:','Amount','Response\x20Body:','===\x20NODA\x20API\x20ERROR\x20===','Noda\x20API\x20error:\x20','Iban','done','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','logWhiteDomainRequest','noda','Order\x20ID\x20Format:','Error\x20message:','amount','failed','loggerService','EXPIRED','toLowerCase','statusCode','canceled','processWebhook','JSON\x20Parse\x20Error:\x20','Payment\x20Link\x20ID:','message','Status:','HTTP\x20Status:','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','10pEtVXJ','status','cancelled','POST','in_progress','GET','logWhiteDomainError','log','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','defineProperty','BankTransactionId','Noda\x20payment\x20verification\x20error:','Not\x20provided','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','Short\x20Link:','PENDING','Status\x20Code:','verifyWebhookSignature','successful','shortLinkUrls','Failed\x20to\x20parse\x20JSON\x20response:','/payment-links','Status\x20Text:','error','rejected','Raw\x20Response\x20Body:','__esModule','headers','Error\x20details:','Processing\x20Noda\x20webhook:','===\x20NODA\x20SERVICE\x20ERROR\x20===','logWhiteDomainResponse','Noda\x20webhook\x20signature\x20verification:','FAILED','488085Dzyqjn','now'];a40_0x504c=function(){return _0x3939db;};return a40_0x504c();}const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0x5646f2=a40_0x5341d7;this['apiUrl']='https://tesoft.uk/gateway/noda/',console[_0x5646f2(0x109)]('üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy');}async['createPaymentLink'](_0x28ce30){const _0x2154e5=a40_0x5341d7,{orderId:_0x40f67d,name:_0x4bb371,paymentDescription:_0x412a84,amount:_0x331448,currency:_0x582b39,webhookUrl:_0xecf8c8,returnUrl:_0x57514a,expiryDate:_0x3694e7}=_0x28ce30,_0x478136=_0x582b39['toUpperCase'](),_0x551f7f='https://tesoft.uk/gateway/noda/webhook/',_0x449751=_0x2154e5(0xe3)+_0x40f67d,_0x453c3e={'name':_0x4bb371,'paymentDescription':_0x412a84,'amount':_0x331448,'currency':_0x478136,'paymentId':_0x40f67d,'webhookUrl':_0x551f7f,'returnUrl':_0x449751};_0x3694e7&&(_0x453c3e['expiryDate']=_0x3694e7);const _0x34c7d9=Date[_0x2154e5(0xae)]();try{console['log']('===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20==='),console[_0x2154e5(0x109)](_0x2154e5(0xe8),this[_0x2154e5(0xd6)]),console[_0x2154e5(0x109)](_0x2154e5(0xd5),JSON[_0x2154e5(0xcb)](_0x453c3e,null,0x2)),console['log'](_0x2154e5(0xf2),_0x40f67d,'(8digits-8digits\x20format\x20for\x20Noda)'),loggerService_1['loggerService'][_0x2154e5(0xf0)](_0x2154e5(0xf1),_0x2154e5(0x117),_0x2154e5(0x105),_0x453c3e);const _0x129dc3=await fetch(this[_0x2154e5(0xd6)],{'method':_0x2154e5(0x105),'headers':{'Content-Type':'application/json','Accept':_0x2154e5(0xe7),'User-Agent':_0x2154e5(0xc1)},'body':JSON[_0x2154e5(0xcb)](_0x453c3e)}),_0x517cc4=Date[_0x2154e5(0xae)]()-_0x34c7d9;console[_0x2154e5(0x109)](_0x2154e5(0xe1)),console[_0x2154e5(0x109)](_0x2154e5(0xff),_0x129dc3[_0x2154e5(0x103)]),console[_0x2154e5(0x109)](_0x2154e5(0x118),_0x129dc3[_0x2154e5(0xd1)]),console[_0x2154e5(0x109)](_0x2154e5(0xc5),Object['fromEntries'](_0x129dc3[_0x2154e5(0x11d)][_0x2154e5(0xb5)]())),console[_0x2154e5(0x109)](_0x2154e5(0xc6),_0x517cc4+'ms');const _0x3d4863=await _0x129dc3[_0x2154e5(0xe4)]();console['log'](_0x2154e5(0x11b),_0x3d4863);if(!_0x129dc3['ok']){console[_0x2154e5(0x119)](_0x2154e5(0xeb)),console[_0x2154e5(0x119)](_0x2154e5(0x100),_0x129dc3[_0x2154e5(0x103)]),console['error'](_0x2154e5(0xea),_0x3d4863),loggerService_1['loggerService'][_0x2154e5(0xaa)](_0x2154e5(0xf1),'/payment-links',_0x129dc3[_0x2154e5(0x103)],_0x3d4863,_0x517cc4),loggerService_1[_0x2154e5(0xf6)][_0x2154e5(0x108)]('noda',_0x2154e5(0x117),_0x2154e5(0xe5)+_0x129dc3[_0x2154e5(0x103)]+':\x20'+_0x3d4863);if(_0x129dc3[_0x2154e5(0x103)]===0x190)throw new Error(_0x2154e5(0x10a));else{if(_0x129dc3[_0x2154e5(0x103)]===0x1f4)throw new Error(_0x2154e5(0xbe));}throw new Error(_0x2154e5(0xe6)+_0x129dc3[_0x2154e5(0x103)]+',\x20body:\x20'+_0x3d4863);}let _0x42d8c2;try{_0x42d8c2=JSON['parse'](_0x3d4863);}catch(_0x173132){console[_0x2154e5(0x119)](_0x2154e5(0x116),_0x173132),loggerService_1[_0x2154e5(0xf6)][_0x2154e5(0x108)](_0x2154e5(0xf1),_0x2154e5(0x117),_0x2154e5(0xfc)+_0x173132);throw new Error(_0x2154e5(0xef)+_0x3d4863);}console[_0x2154e5(0x109)](_0x2154e5(0xcd)),console[_0x2154e5(0x109)]('Parsed\x20Result:',JSON[_0x2154e5(0xcb)](_0x42d8c2,null,0x2)),loggerService_1['loggerService'][_0x2154e5(0xaa)](_0x2154e5(0xf1),_0x2154e5(0x117),_0x129dc3['status'],_0x42d8c2,_0x517cc4);if(_0x42d8c2[_0x2154e5(0x119)]||_0x42d8c2[_0x2154e5(0xf9)]){const _0x1e4b83=_0x42d8c2['message']||_0x42d8c2[_0x2154e5(0x119)]||'Unknown\x20error\x20from\x20Noda\x20API';console['error'](_0x2154e5(0x101)),console[_0x2154e5(0x119)](_0x2154e5(0xaf),_0x1e4b83),console[_0x2154e5(0x119)](_0x2154e5(0x112),_0x42d8c2[_0x2154e5(0xf9)]),loggerService_1[_0x2154e5(0xf6)][_0x2154e5(0x108)](_0x2154e5(0xf1),_0x2154e5(0x117),'Business\x20Error:\x20'+_0x1e4b83);throw new Error('Noda\x20API\x20error:\x20'+_0x1e4b83);}if(!_0x42d8c2['id']||!_0x42d8c2[_0x2154e5(0x115)]?.[_0x2154e5(0xd9)]){console['error'](_0x2154e5(0xd2)),console['error']('Missing\x20id\x20or\x20shortLink\x20in\x20response'),console[_0x2154e5(0x119)](_0x2154e5(0xd8),_0x42d8c2),loggerService_1[_0x2154e5(0xf6)][_0x2154e5(0x108)]('noda','/payment-links',_0x2154e5(0x10f));throw new Error('Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink');}return console[_0x2154e5(0x109)](_0x2154e5(0xb7)),console[_0x2154e5(0x109)](_0x2154e5(0xfd),_0x42d8c2['id']),console[_0x2154e5(0x109)](_0x2154e5(0x110),_0x42d8c2[_0x2154e5(0x115)][_0x2154e5(0xd9)]),console['log'](_0x2154e5(0xb1),_0x42d8c2[_0x2154e5(0x115)][_0x2154e5(0xcc)]||_0x2154e5(0x10e)),console[_0x2154e5(0x109)]('Order\x20ID\x20Used:',_0x40f67d,_0x2154e5(0xdb)),{'gateway_payment_id':_0x42d8c2['id'],'payment_url':_0x42d8c2[_0x2154e5(0x115)]['shortLink'],'qr_code_url':_0x42d8c2[_0x2154e5(0x115)]['qrCodeLink'],'expiry_date':_0x42d8c2['expiryDate']};}catch(_0x34e6dd){console[_0x2154e5(0x119)](_0x2154e5(0x120)),console[_0x2154e5(0x119)](_0x2154e5(0x11e),_0x34e6dd),loggerService_1[_0x2154e5(0xf6)][_0x2154e5(0x108)](_0x2154e5(0xf1),_0x2154e5(0x117),_0x34e6dd);if(_0x34e6dd instanceof Error){console[_0x2154e5(0x119)](_0x2154e5(0xf3),_0x34e6dd[_0x2154e5(0xfe)]),console['error'](_0x2154e5(0xdf),_0x34e6dd[_0x2154e5(0xcf)]);throw new Error('Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20'+_0x34e6dd[_0x2154e5(0xfe)]);}throw new Error(_0x2154e5(0xce));}}async[a40_0x5341d7(0xbd)](_0x46d732){const _0x248474=a40_0x5341d7,_0x32a4e1=Date['now']();try{loggerService_1[_0x248474(0xf6)]['logWhiteDomainRequest'](_0x248474(0xf1),_0x248474(0xbf)+_0x46d732,_0x248474(0x107),{});const _0x3a7aa3=await fetch(this[_0x248474(0xd6)]+'/'+_0x46d732,{'method':_0x248474(0x107),'headers':{'Content-Type':'application/json','User-Agent':_0x248474(0xc1)}}),_0xb3e973=Date[_0x248474(0xae)]()-_0x32a4e1;if(!_0x3a7aa3['ok']){const _0x449723=await _0x3a7aa3['text']();loggerService_1['loggerService'][_0x248474(0xaa)]('noda',_0x248474(0xbf)+_0x46d732,_0x3a7aa3['status'],_0x449723,_0xb3e973);throw new Error(_0x248474(0xe6)+_0x3a7aa3[_0x248474(0x103)]);}const _0x5b3d2f=await _0x3a7aa3['json']();loggerService_1[_0x248474(0xf6)][_0x248474(0xaa)](_0x248474(0xf1),_0x248474(0xbf)+_0x46d732,_0x3a7aa3[_0x248474(0x103)],_0x5b3d2f,_0xb3e973);if(_0x5b3d2f[_0x248474(0x119)]||_0x5b3d2f[_0x248474(0xf9)]){loggerService_1['loggerService'][_0x248474(0x108)](_0x248474(0xf1),_0x248474(0xbf)+_0x46d732,_0x248474(0xec)+(_0x5b3d2f[_0x248474(0xfe)]||_0x5b3d2f[_0x248474(0x119)]||_0x248474(0xd4)));throw new Error(_0x248474(0xec)+(_0x5b3d2f[_0x248474(0xfe)]||_0x5b3d2f[_0x248474(0x119)]||_0x248474(0xd4)));}let _0xe3e0cf=_0x248474(0x111);if(_0x5b3d2f[_0x248474(0xc2)]===![]){if(_0x5b3d2f['expiryDate']){const _0x173246=new Date(_0x5b3d2f['expiryDate']),_0xc1ace2=new Date();_0x173246<_0xc1ace2?_0xe3e0cf=_0x248474(0xf7):_0xe3e0cf='FAILED';}else _0xe3e0cf=_0x248474(0xac);}else _0xe3e0cf=_0x248474(0x111);return{'status':_0xe3e0cf,'amount':_0x5b3d2f[_0x248474(0xf4)],'currency':_0x5b3d2f[_0x248474(0xe0)],'isActive':_0x5b3d2f[_0x248474(0xc2)]};}catch(_0x184975){console['error'](_0x248474(0x10d),_0x184975),loggerService_1[_0x248474(0xf6)][_0x248474(0x108)](_0x248474(0xf1),'/payment-links/'+_0x46d732,_0x184975);throw new Error(_0x248474(0xb3)+(_0x184975 instanceof Error?_0x184975[_0x248474(0xfe)]:_0x248474(0xd4)));}}async[a40_0x5341d7(0xfb)](_0x220cb5){const _0x279fca=a40_0x5341d7;console[_0x279fca(0x109)](_0x279fca(0x11f),_0x220cb5);let _0x34a5e8=_0x279fca(0x111);switch(_0x220cb5['Status']?.[_0x279fca(0xf8)]()){case _0x279fca(0xee):case'completed':case _0x279fca(0xd7):case'success':case _0x279fca(0x114):_0x220cb5[_0x279fca(0xb2)]==='Yes'?_0x34a5e8=_0x279fca(0xe2):_0x34a5e8=_0x279fca(0x111);break;case _0x279fca(0x104):case _0x279fca(0xfa):case _0x279fca(0xf5):case _0x279fca(0x119):case _0x279fca(0x11a):_0x34a5e8=_0x279fca(0xac);break;case _0x279fca(0xb4):case _0x279fca(0xb0):_0x34a5e8=_0x279fca(0xf7);break;case _0x279fca(0xbb):case _0x279fca(0xb9):case _0x279fca(0xca):case'processing':case _0x279fca(0x106):default:_0x34a5e8=_0x279fca(0x111);break;}return{'paymentId':_0x220cb5['MerchantPaymentId']||_0x220cb5['PaymentId'],'status':_0x34a5e8,'amount':_0x220cb5[_0x279fca(0xe9)],'currency':_0x220cb5[_0x279fca(0xdd)],'additionalInfo':{'method':_0x220cb5[_0x279fca(0xb6)],'bankId':_0x220cb5[_0x279fca(0xc3)],'settled':_0x220cb5[_0x279fca(0xb2)],'settlementDate':_0x220cb5['SettlementDate'],'remitterName':_0x220cb5[_0x279fca(0xd0)]?.[_0x279fca(0xdc)],'remitterIban':_0x220cb5[_0x279fca(0xd0)]?.[_0x279fca(0xed)],'bankTransactionId':_0x220cb5[_0x279fca(0x10c)]}};}[a40_0x5341d7(0x113)](_0x25aea5,_0x274f22){const _0x1e0e7d=a40_0x5341d7;return console[_0x1e0e7d(0x109)](_0x1e0e7d(0xab),{'receivedSignature':_0x274f22,'paymentId':_0x25aea5[_0x1e0e7d(0xc9)],'merchantPaymentId':_0x25aea5[_0x1e0e7d(0xde)]}),!![];}}exports[a40_0x5341d7(0xc0)]=NodaService;