'use strict';const a43_0x2b203d=a43_0x359a;(function(_0x3fdfa5,_0x7559b3){const _0x5ad8bb=a43_0x359a,_0x12d35b=_0x3fdfa5();while(!![]){try{const _0x1631d5=parseInt(_0x5ad8bb(0x1dd))/0x1+-parseInt(_0x5ad8bb(0x236))/0x2+-parseInt(_0x5ad8bb(0x221))/0x3*(-parseInt(_0x5ad8bb(0x1ce))/0x4)+-parseInt(_0x5ad8bb(0x1f6))/0x5*(parseInt(_0x5ad8bb(0x228))/0x6)+-parseInt(_0x5ad8bb(0x1c7))/0x7+-parseInt(_0x5ad8bb(0x1f9))/0x8+-parseInt(_0x5ad8bb(0x1d0))/0x9*(-parseInt(_0x5ad8bb(0x217))/0xa);if(_0x1631d5===_0x7559b3)break;else _0x12d35b['push'](_0x12d35b['shift']());}catch(_0x5bedeb){_0x12d35b['push'](_0x12d35b['shift']());}}}(a43_0x5e97,0x30e0e));function a43_0x5e97(){const _0x5ea8ee=['entries','Error\x20details:','Parsed\x20Result:','Noda\x20API\x20error:\x20','NodaService','‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:','All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid','fromEntries','parse','timeout','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','Status\x20Text:','toLowerCase','Response\x20Body:','logWhiteDomainRequest','60yLfUBu','now','text','1779560RiHIRC','shortLink','===\x20NODA\x20API\x20ERROR\x20===','Settled','Noda\x20payment\x20verification\x20error:','BankId','Unknown\x20error\x20from\x20Noda\x20API','EXPIRED','log','rejected','/payment-links/','Yes','logWhiteDomainResponse','Method','Unknown\x20error','expiryDate','SettlementDate','GET','Order\x20ID\x20Format:','Iban','Business\x20Error:\x20','statusText','BankTransactionId','loggerService','MerchantPaymentId','(8digits-8digits\x20format)','https://tesoft.uk/gateway/noda/webhook/','apiUrl','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','message','6670NUxnNG','processing','HTTP\x20','Currency','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','Error\x20stack:','json','JSON\x20Parse\x20Error:\x20','URL:','isActive','4881CynLLp','error','PAID',',\x20body:\x20','POST','success','completed','97932PSsiZU','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','Request\x20Body\x20(Direct\x20JSON):','processWebhook','shortLinkUrls','logWhiteDomainError','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','status','active','TesSoft\x20Payment\x20System/1.0','Status:','HTTP\x20error!\x20status:\x20','noda','748688cRSLye','in_progress','verifyWebhookSignature','Headers:','1599129zhQquQ','amount','PENDING','created','HTTP\x20Status:','failed','https://tesoft.uk/gateway/pending.php?id=','152LqHFGp','application/json','14346AHcwgv','Failed\x20to\x20verify\x20Noda\x20payment:\x20','done','Name','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20===','successful','Remitter','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','/payment-links','createPaymentLink','Short\x20Link:','Payment\x20Link\x20ID:','üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','96282hyHhps','FAILED','defineProperty','qrCodeLink','toUpperCase','stringify','===\x20PARSED\x20NODA\x20RESPONSE\x20===','Not\x20provided','Failed\x20to\x20parse\x20JSON\x20response:','Missing\x20id\x20or\x20shortLink\x20in\x20response'];a43_0x5e97=function(){return _0x5ea8ee;};return a43_0x5e97();}Object[a43_0x2b203d(0x1df)](exports,'__esModule',{'value':!![]}),exports[a43_0x2b203d(0x1eb)]=void 0x0;function a43_0x359a(_0x96c29f,_0x5b0c9f){const _0x5e97e3=a43_0x5e97();return a43_0x359a=function(_0x359ab5,_0x1d0461){_0x359ab5=_0x359ab5-0x1c4;let _0x55b45d=_0x5e97e3[_0x359ab5];return _0x55b45d;},a43_0x359a(_0x96c29f,_0x5b0c9f);}const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0x13545f=a43_0x2b203d;this['apiUrl']='https://tesoft.uk/gateway/noda/',console[_0x13545f(0x201)](_0x13545f(0x1dc));}async[a43_0x2b203d(0x1d9)](_0x4250da){const _0x426d41=a43_0x2b203d,{orderId:_0x2a1b5b,name:_0x416623,paymentDescription:_0x2dd439,amount:_0x4f8963,currency:_0x169e45,webhookUrl:_0xe1a21b,returnUrl:_0x57f608,expiryDate:_0x4a9462}=_0x4250da,_0x3616e5=_0x169e45[_0x426d41(0x1e1)](),_0x400807=_0x426d41(0x213),_0x1951b1=_0x426d41(0x1cd)+_0x2a1b5b,_0x2fe31a={'name':_0x416623,'paymentDescription':_0x2dd439,'amount':_0x4f8963,'currency':_0x3616e5,'paymentId':_0x2a1b5b,'webhookUrl':_0x400807,'returnUrl':_0x1951b1};_0x4a9462&&(_0x2fe31a[_0x426d41(0x208)]=_0x4a9462);const _0xde42c=Date['now']();try{console[_0x426d41(0x201)](_0x426d41(0x1d4)),console[_0x426d41(0x201)](_0x426d41(0x21f),this[_0x426d41(0x214)]),console['log'](_0x426d41(0x22a),JSON[_0x426d41(0x1e2)](_0x2fe31a,null,0x2)),console[_0x426d41(0x201)](_0x426d41(0x20b),_0x2a1b5b,'(8digits-8digits\x20format\x20for\x20Noda)'),console[_0x426d41(0x201)](_0x426d41(0x1ec),_0x1951b1),loggerService_1[_0x426d41(0x210)]['logWhiteDomainRequest'](_0x426d41(0x235),_0x426d41(0x1d8),_0x426d41(0x225),_0x2fe31a);const _0x5ebd3e=await fetch(this[_0x426d41(0x214)],{'method':_0x426d41(0x225),'headers':{'Content-Type':_0x426d41(0x1cf),'Accept':_0x426d41(0x1cf),'User-Agent':_0x426d41(0x232)},'body':JSON[_0x426d41(0x1e2)](_0x2fe31a)}),_0x4363af=Date['now']()-_0xde42c;console['log'](_0x426d41(0x215)),console[_0x426d41(0x201)](_0x426d41(0x233),_0x5ebd3e['status']),console[_0x426d41(0x201)](_0x426d41(0x1f2),_0x5ebd3e[_0x426d41(0x20e)]),console[_0x426d41(0x201)](_0x426d41(0x1c6),Object[_0x426d41(0x1ee)](_0x5ebd3e['headers'][_0x426d41(0x1e7)]())),console[_0x426d41(0x201)]('Response\x20Time:',_0x4363af+'ms');const _0x13d84c=await _0x5ebd3e['text']();console[_0x426d41(0x201)]('Raw\x20Response\x20Body:',_0x13d84c);if(!_0x5ebd3e['ok']){console[_0x426d41(0x222)](_0x426d41(0x1fb)),console[_0x426d41(0x222)](_0x426d41(0x1cb),_0x5ebd3e[_0x426d41(0x230)]),console[_0x426d41(0x222)](_0x426d41(0x1f4),_0x13d84c),loggerService_1[_0x426d41(0x210)][_0x426d41(0x205)]('noda',_0x426d41(0x1d8),_0x5ebd3e[_0x426d41(0x230)],_0x13d84c,_0x4363af),loggerService_1[_0x426d41(0x210)]['logWhiteDomainError']('noda',_0x426d41(0x1d8),_0x426d41(0x219)+_0x5ebd3e[_0x426d41(0x230)]+':\x20'+_0x13d84c);if(_0x5ebd3e['status']===0x190)throw new Error(_0x426d41(0x229));else{if(_0x5ebd3e['status']===0x1f4)throw new Error(_0x426d41(0x1ed));}throw new Error(_0x426d41(0x234)+_0x5ebd3e[_0x426d41(0x230)]+_0x426d41(0x224)+_0x13d84c);}let _0x4c7bf8;try{_0x4c7bf8=JSON[_0x426d41(0x1ef)](_0x13d84c);}catch(_0x42dff8){console['error'](_0x426d41(0x1e5),_0x42dff8),loggerService_1['loggerService'][_0x426d41(0x22d)](_0x426d41(0x235),'/payment-links',_0x426d41(0x21e)+_0x42dff8);throw new Error(_0x426d41(0x1d7)+_0x13d84c);}console['log'](_0x426d41(0x1e3)),console[_0x426d41(0x201)](_0x426d41(0x1e9),JSON[_0x426d41(0x1e2)](_0x4c7bf8,null,0x2)),loggerService_1[_0x426d41(0x210)]['logWhiteDomainResponse'](_0x426d41(0x235),_0x426d41(0x1d8),_0x5ebd3e[_0x426d41(0x230)],_0x4c7bf8,_0x4363af);if(_0x4c7bf8[_0x426d41(0x222)]||_0x4c7bf8['statusCode']){const _0x21555b=_0x4c7bf8['message']||_0x4c7bf8[_0x426d41(0x222)]||_0x426d41(0x1ff);console[_0x426d41(0x222)](_0x426d41(0x1f1)),console[_0x426d41(0x222)]('Error\x20Message:',_0x21555b),console[_0x426d41(0x222)]('Status\x20Code:',_0x4c7bf8['statusCode']),loggerService_1[_0x426d41(0x210)][_0x426d41(0x22d)](_0x426d41(0x235),'/payment-links',_0x426d41(0x20d)+_0x21555b);throw new Error(_0x426d41(0x1ea)+_0x21555b);}if(!_0x4c7bf8['id']||!_0x4c7bf8[_0x426d41(0x22c)]?.[_0x426d41(0x1fa)]){console[_0x426d41(0x222)]('===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x426d41(0x222)](_0x426d41(0x1e6)),console[_0x426d41(0x222)]('Response\x20data:',_0x4c7bf8),loggerService_1['loggerService'][_0x426d41(0x22d)](_0x426d41(0x235),_0x426d41(0x1d8),'Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink');throw new Error('Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink');}return console[_0x426d41(0x201)]('===\x20NODA\x20SUCCESS\x20==='),console[_0x426d41(0x201)](_0x426d41(0x1db),_0x4c7bf8['id']),console[_0x426d41(0x201)](_0x426d41(0x1da),_0x4c7bf8[_0x426d41(0x22c)][_0x426d41(0x1fa)]),console[_0x426d41(0x201)]('QR\x20Code\x20Link:',_0x4c7bf8[_0x426d41(0x22c)]['qrCodeLink']||_0x426d41(0x1e4)),console[_0x426d41(0x201)]('Order\x20ID\x20Used:',_0x2a1b5b,_0x426d41(0x212)),console[_0x426d41(0x201)](_0x426d41(0x22e),_0x1951b1),{'gateway_payment_id':_0x4c7bf8['id'],'payment_url':_0x4c7bf8[_0x426d41(0x22c)]['shortLink'],'qr_code_url':_0x4c7bf8[_0x426d41(0x22c)][_0x426d41(0x1e0)],'expiry_date':_0x4c7bf8[_0x426d41(0x208)]};}catch(_0x1acaa8){console[_0x426d41(0x222)]('===\x20NODA\x20SERVICE\x20ERROR\x20==='),console['error'](_0x426d41(0x1e8),_0x1acaa8),loggerService_1[_0x426d41(0x210)][_0x426d41(0x22d)](_0x426d41(0x235),'/payment-links',_0x1acaa8);if(_0x1acaa8 instanceof Error){console[_0x426d41(0x222)]('Error\x20message:',_0x1acaa8[_0x426d41(0x216)]),console['error'](_0x426d41(0x21c),_0x1acaa8['stack']);throw new Error(_0x426d41(0x21b)+_0x1acaa8[_0x426d41(0x216)]);}throw new Error(_0x426d41(0x22f));}}async['verifyPayment'](_0x50c3ec){const _0x79de79=a43_0x2b203d,_0x3a81a4=Date['now']();try{loggerService_1[_0x79de79(0x210)][_0x79de79(0x1f5)]('noda',_0x79de79(0x203)+_0x50c3ec,_0x79de79(0x20a),{});const _0x1c2c0a=await fetch(this[_0x79de79(0x214)]+'/'+_0x50c3ec,{'method':'GET','headers':{'Content-Type':_0x79de79(0x1cf),'User-Agent':'TesSoft\x20Payment\x20System/1.0'}}),_0x2990b5=Date[_0x79de79(0x1f7)]()-_0x3a81a4;if(!_0x1c2c0a['ok']){const _0x3a7186=await _0x1c2c0a[_0x79de79(0x1f8)]();loggerService_1[_0x79de79(0x210)]['logWhiteDomainResponse']('noda',_0x79de79(0x203)+_0x50c3ec,_0x1c2c0a[_0x79de79(0x230)],_0x3a7186,_0x2990b5);throw new Error('HTTP\x20error!\x20status:\x20'+_0x1c2c0a[_0x79de79(0x230)]);}const _0x4d40f5=await _0x1c2c0a[_0x79de79(0x21d)]();loggerService_1['loggerService']['logWhiteDomainResponse'](_0x79de79(0x235),_0x79de79(0x203)+_0x50c3ec,_0x1c2c0a['status'],_0x4d40f5,_0x2990b5);if(_0x4d40f5[_0x79de79(0x222)]||_0x4d40f5['statusCode']){loggerService_1[_0x79de79(0x210)]['logWhiteDomainError'](_0x79de79(0x235),_0x79de79(0x203)+_0x50c3ec,_0x79de79(0x1ea)+(_0x4d40f5['message']||_0x4d40f5[_0x79de79(0x222)]||_0x79de79(0x207)));throw new Error(_0x79de79(0x1ea)+(_0x4d40f5[_0x79de79(0x216)]||_0x4d40f5[_0x79de79(0x222)]||_0x79de79(0x207)));}let _0x458038=_0x79de79(0x1c9);if(_0x4d40f5[_0x79de79(0x220)]===![]){if(_0x4d40f5[_0x79de79(0x208)]){const _0x504760=new Date(_0x4d40f5[_0x79de79(0x208)]),_0x10390b=new Date();_0x504760<_0x10390b?_0x458038=_0x79de79(0x200):_0x458038=_0x79de79(0x1de);}else _0x458038=_0x79de79(0x1de);}else _0x458038='PENDING';return{'status':_0x458038,'amount':_0x4d40f5[_0x79de79(0x1c8)],'currency':_0x4d40f5['currency'],'isActive':_0x4d40f5[_0x79de79(0x220)]};}catch(_0x432002){console[_0x79de79(0x222)](_0x79de79(0x1fd),_0x432002),loggerService_1[_0x79de79(0x210)][_0x79de79(0x22d)](_0x79de79(0x235),_0x79de79(0x203)+_0x50c3ec,_0x432002);throw new Error(_0x79de79(0x1d1)+(_0x432002 instanceof Error?_0x432002[_0x79de79(0x216)]:_0x79de79(0x207)));}}async[a43_0x2b203d(0x22b)](_0x245360){const _0x50214f=a43_0x2b203d;console[_0x50214f(0x201)]('Processing\x20Noda\x20webhook:',_0x245360);let _0x377fae='PENDING';switch(_0x245360['Status']?.[_0x50214f(0x1f3)]()){case _0x50214f(0x1d2):case _0x50214f(0x227):case'paid':case _0x50214f(0x226):case _0x50214f(0x1d5):_0x245360[_0x50214f(0x1fc)]===_0x50214f(0x204)?_0x377fae=_0x50214f(0x223):_0x377fae=_0x50214f(0x1c9);break;case'cancelled':case'canceled':case _0x50214f(0x1cc):case'error':case _0x50214f(0x202):_0x377fae=_0x50214f(0x1de);break;case'expired':case _0x50214f(0x1f0):_0x377fae=_0x50214f(0x200);break;case'pending':case _0x50214f(0x1ca):case _0x50214f(0x231):case _0x50214f(0x218):case _0x50214f(0x1c4):default:_0x377fae='PENDING';break;}return{'paymentId':_0x245360['MerchantPaymentId']||_0x245360['PaymentId'],'status':_0x377fae,'amount':_0x245360['Amount'],'currency':_0x245360[_0x50214f(0x21a)],'additionalInfo':{'method':_0x245360[_0x50214f(0x206)],'bankId':_0x245360[_0x50214f(0x1fe)],'settled':_0x245360['Settled'],'settlementDate':_0x245360[_0x50214f(0x209)],'remitterName':_0x245360[_0x50214f(0x1d6)]?.[_0x50214f(0x1d3)],'remitterIban':_0x245360['Remitter']?.[_0x50214f(0x20c)],'bankTransactionId':_0x245360[_0x50214f(0x20f)]}};}[a43_0x2b203d(0x1c5)](_0x2ad29f,_0x59554f){const _0x45c70a=a43_0x2b203d;return console[_0x45c70a(0x201)]('Noda\x20webhook\x20signature\x20verification:',{'receivedSignature':_0x59554f,'paymentId':_0x2ad29f['PaymentId'],'merchantPaymentId':_0x2ad29f[_0x45c70a(0x211)]}),!![];}}exports[a43_0x2b203d(0x1eb)]=NodaService;