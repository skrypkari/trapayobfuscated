'use strict';function a46_0xa336(){const _0x3ad6ab=['GET','SettlementDate','745236lFTEhB','Response\x20Time:','cancelled','toLowerCase','logWhiteDomainError','toUpperCase','done','/payment-links/','Unknown\x20error','https://tesoft.uk/gateway/noda/','POST','currency','loggerService','Noda\x20webhook\x20signature\x20verification:','5599WLcAWD','verifyWebhookSignature','üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','===\x20PARSED\x20NODA\x20RESPONSE\x20===','Order\x20ID\x20Format:','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','NodaService','logWhiteDomainResponse','EXPIRED','3441915FGhKbF','error','Method','(8digits-8digits\x20format)','shortLinkUrls','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20===','2109645cWDRRO','successful','TesSoft\x20Payment\x20System/1.0','log','Failed\x20to\x20parse\x20JSON\x20response:','1ZdDXOB','logWhiteDomainRequest','Name','timeout','completed','Not\x20provided','paid','fromEntries','28AExBon','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','Headers:','Unknown\x20error\x20from\x20Noda\x20API','application/json','Raw\x20Response\x20Body:','apiUrl','64212ChtiCJ','HTTP\x20Status:','processing','===\x20NODA\x20SERVICE\x20ERROR\x20===','Error\x20stack:','Short\x20Link:','Settled','Order\x20ID\x20Used:','Remitter','now','Error\x20message:','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','expiryDate','shortLink','Failed\x20to\x20verify\x20Noda\x20payment:\x20','(8digits-8digits\x20format\x20for\x20Noda)','QR\x20Code\x20Link:','FAILED','success','Business\x20Error:\x20','createPaymentLink','text','HTTP\x20error!\x20status:\x20','===\x20NODA\x20API\x20ERROR\x20===','BankId','defineProperty','PENDING','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','entries','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===',',\x20body:\x20','Noda\x20API\x20error:\x20','noda','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','created','stringify','HTTP\x20','stack','Parsed\x20Result:','pending','21jOszhg','Error\x20details:','status','Noda\x20payment\x20verification\x20error:','Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink','Iban','Payment\x20Link\x20ID:','failed','MerchantPaymentId','message','isActive','https://tesoft.uk/gateway/noda/webhook/','PaymentId','statusCode','https://tesoft.uk/gateway/pending.php?id=','Error\x20Message:','Yes','qrCodeLink','7470tsysrU','/payment-links','All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid','Status:','‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:','Amount','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','Status\x20Code:','64706SUEbsA','Missing\x20id\x20or\x20shortLink\x20in\x20response','URL:','3206424jYWcIo','Response\x20data:','in_progress','canceled','BankTransactionId','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error'];a46_0xa336=function(){return _0x3ad6ab;};return a46_0xa336();}const a46_0x4455f7=a46_0x61d6;(function(_0x573e3f,_0x6c1140){const _0x165001=a46_0x61d6,_0x45cf6b=_0x573e3f();while(!![]){try{const _0x5cae2d=parseInt(_0x165001(0x10a))/0x1*(parseInt(_0x165001(0x15b))/0x2)+parseInt(_0x165001(0x119))/0x3*(parseInt(_0x165001(0x112))/0x4)+-parseInt(_0x165001(0xff))/0x5+-parseInt(_0x165001(0x166))/0x6+parseInt(_0x165001(0x141))/0x7*(parseInt(_0x165001(0x15e))/0x8)+-parseInt(_0x165001(0x105))/0x9+parseInt(_0x165001(0x153))/0xa*(parseInt(_0x165001(0x174))/0xb);if(_0x5cae2d===_0x6c1140)break;else _0x45cf6b['push'](_0x45cf6b['shift']());}catch(_0x594624){_0x45cf6b['push'](_0x45cf6b['shift']());}}}(a46_0xa336,0xaf3fb));function a46_0x61d6(_0xfcdcf5,_0x1e2eec){const _0xa3364b=a46_0xa336();return a46_0x61d6=function(_0x61d69a,_0x1de261){_0x61d69a=_0x61d69a-0xfd;let _0x68df67=_0xa3364b[_0x61d69a];return _0x68df67;},a46_0x61d6(_0xfcdcf5,_0x1e2eec);}Object[a46_0x4455f7(0x132)](exports,'__esModule',{'value':!![]}),exports[a46_0x4455f7(0x17a)]=void 0x0;const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0x460812=a46_0x4455f7;this[_0x460812(0x118)]=_0x460812(0x16f),console[_0x460812(0x108)](_0x460812(0x176));}async[a46_0x4455f7(0x12d)](_0x37ae3e){const _0x923c60=a46_0x4455f7,{orderId:_0x4a1db7,name:_0x39f02b,paymentDescription:_0x3bfdd6,amount:_0xd35a2,currency:_0x555b1d,webhookUrl:_0x5800f0,returnUrl:_0x2da23b,expiryDate:_0x154872}=_0x37ae3e,_0x1960bd=_0x555b1d[_0x923c60(0x16b)](),_0x509867=_0x923c60(0x14c),_0x3704ad=_0x923c60(0x14f)+_0x4a1db7,_0x31279b={'name':_0x39f02b,'paymentDescription':_0x3bfdd6,'amount':_0xd35a2,'currency':_0x1960bd,'paymentId':_0x4a1db7,'webhookUrl':_0x509867,'returnUrl':_0x3704ad};_0x154872&&(_0x31279b['expiryDate']=_0x154872);const _0xc5630b=Date[_0x923c60(0x122)]();try{console[_0x923c60(0x108)](_0x923c60(0x104)),console[_0x923c60(0x108)](_0x923c60(0x15d),this['apiUrl']),console['log']('Request\x20Body\x20(Direct\x20JSON):',JSON['stringify'](_0x31279b,null,0x2)),console[_0x923c60(0x108)](_0x923c60(0x178),_0x4a1db7,_0x923c60(0x128)),console[_0x923c60(0x108)](_0x923c60(0x157),_0x3704ad),loggerService_1['loggerService']['logWhiteDomainRequest'](_0x923c60(0x139),_0x923c60(0x154),_0x923c60(0x170),_0x31279b);const _0x4ad1ab=await fetch(this[_0x923c60(0x118)],{'method':_0x923c60(0x170),'headers':{'Content-Type':_0x923c60(0x116),'Accept':_0x923c60(0x116),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x923c60(0x13c)](_0x31279b)}),_0x2cc757=Date[_0x923c60(0x122)]()-_0xc5630b;console[_0x923c60(0x108)](_0x923c60(0x113)),console[_0x923c60(0x108)](_0x923c60(0x156),_0x4ad1ab[_0x923c60(0x143)]),console[_0x923c60(0x108)]('Status\x20Text:',_0x4ad1ab['statusText']),console[_0x923c60(0x108)](_0x923c60(0x114),Object[_0x923c60(0x111)](_0x4ad1ab['headers'][_0x923c60(0x135)]())),console[_0x923c60(0x108)](_0x923c60(0x167),_0x2cc757+'ms');const _0x49f850=await _0x4ad1ab[_0x923c60(0x12e)]();console[_0x923c60(0x108)](_0x923c60(0x117),_0x49f850);if(!_0x4ad1ab['ok']){console[_0x923c60(0x100)](_0x923c60(0x130)),console[_0x923c60(0x100)](_0x923c60(0x11a),_0x4ad1ab[_0x923c60(0x143)]),console[_0x923c60(0x100)]('Response\x20Body:',_0x49f850),loggerService_1[_0x923c60(0x172)][_0x923c60(0xfd)]('noda',_0x923c60(0x154),_0x4ad1ab['status'],_0x49f850,_0x2cc757),loggerService_1[_0x923c60(0x172)][_0x923c60(0x16a)](_0x923c60(0x139),_0x923c60(0x154),_0x923c60(0x13d)+_0x4ad1ab[_0x923c60(0x143)]+':\x20'+_0x49f850);if(_0x4ad1ab[_0x923c60(0x143)]===0x190)throw new Error(_0x923c60(0x159));else{if(_0x4ad1ab[_0x923c60(0x143)]===0x1f4)throw new Error(_0x923c60(0x155));}throw new Error(_0x923c60(0x12f)+_0x4ad1ab[_0x923c60(0x143)]+_0x923c60(0x137)+_0x49f850);}let _0x6e49f1;try{_0x6e49f1=JSON['parse'](_0x49f850);}catch(_0x51c1ab){console['error'](_0x923c60(0x109),_0x51c1ab),loggerService_1[_0x923c60(0x172)][_0x923c60(0x16a)](_0x923c60(0x139),_0x923c60(0x154),'JSON\x20Parse\x20Error:\x20'+_0x51c1ab);throw new Error('Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20'+_0x49f850);}console[_0x923c60(0x108)](_0x923c60(0x177)),console[_0x923c60(0x108)](_0x923c60(0x13f),JSON[_0x923c60(0x13c)](_0x6e49f1,null,0x2)),loggerService_1[_0x923c60(0x172)][_0x923c60(0xfd)](_0x923c60(0x139),_0x923c60(0x154),_0x4ad1ab[_0x923c60(0x143)],_0x6e49f1,_0x2cc757);if(_0x6e49f1[_0x923c60(0x100)]||_0x6e49f1[_0x923c60(0x14e)]){const _0x4e802d=_0x6e49f1[_0x923c60(0x14a)]||_0x6e49f1[_0x923c60(0x100)]||_0x923c60(0x115);console[_0x923c60(0x100)](_0x923c60(0x136)),console[_0x923c60(0x100)](_0x923c60(0x150),_0x4e802d),console[_0x923c60(0x100)](_0x923c60(0x15a),_0x6e49f1['statusCode']),loggerService_1[_0x923c60(0x172)][_0x923c60(0x16a)](_0x923c60(0x139),_0x923c60(0x154),_0x923c60(0x12c)+_0x4e802d);throw new Error(_0x923c60(0x138)+_0x4e802d);}if(!_0x6e49f1['id']||!_0x6e49f1['shortLinkUrls']?.[_0x923c60(0x126)]){console[_0x923c60(0x100)](_0x923c60(0x134)),console['error'](_0x923c60(0x15c)),console['error'](_0x923c60(0x15f),_0x6e49f1),loggerService_1[_0x923c60(0x172)][_0x923c60(0x16a)]('noda','/payment-links',_0x923c60(0x124));throw new Error(_0x923c60(0x145));}return console['log']('===\x20NODA\x20SUCCESS\x20==='),console['log'](_0x923c60(0x147),_0x6e49f1['id']),console[_0x923c60(0x108)](_0x923c60(0x11e),_0x6e49f1[_0x923c60(0x103)][_0x923c60(0x126)]),console[_0x923c60(0x108)](_0x923c60(0x129),_0x6e49f1['shortLinkUrls']['qrCodeLink']||_0x923c60(0x10f)),console[_0x923c60(0x108)](_0x923c60(0x120),_0x4a1db7,_0x923c60(0x102)),console[_0x923c60(0x108)](_0x923c60(0x13a),_0x3704ad),{'gateway_payment_id':_0x6e49f1['id'],'payment_url':_0x6e49f1['shortLinkUrls'][_0x923c60(0x126)],'qr_code_url':_0x6e49f1[_0x923c60(0x103)][_0x923c60(0x152)],'expiry_date':_0x6e49f1[_0x923c60(0x125)]};}catch(_0x1904f9){console[_0x923c60(0x100)](_0x923c60(0x11c)),console[_0x923c60(0x100)](_0x923c60(0x142),_0x1904f9),loggerService_1[_0x923c60(0x172)]['logWhiteDomainError'](_0x923c60(0x139),_0x923c60(0x154),_0x1904f9);if(_0x1904f9 instanceof Error){console['error'](_0x923c60(0x123),_0x1904f9['message']),console[_0x923c60(0x100)](_0x923c60(0x11d),_0x1904f9[_0x923c60(0x13e)]);throw new Error(_0x923c60(0x179)+_0x1904f9[_0x923c60(0x14a)]);}throw new Error(_0x923c60(0x163));}}async['verifyPayment'](_0x592d76){const _0x3c5c06=a46_0x4455f7,_0x7ae3c7=Date['now']();try{loggerService_1[_0x3c5c06(0x172)][_0x3c5c06(0x10b)](_0x3c5c06(0x139),_0x3c5c06(0x16d)+_0x592d76,_0x3c5c06(0x164),{});const _0x525283=await fetch(this[_0x3c5c06(0x118)]+'/'+_0x592d76,{'method':_0x3c5c06(0x164),'headers':{'Content-Type':_0x3c5c06(0x116),'User-Agent':_0x3c5c06(0x107)}}),_0x1941c3=Date[_0x3c5c06(0x122)]()-_0x7ae3c7;if(!_0x525283['ok']){const _0x5de806=await _0x525283[_0x3c5c06(0x12e)]();loggerService_1[_0x3c5c06(0x172)]['logWhiteDomainResponse'](_0x3c5c06(0x139),_0x3c5c06(0x16d)+_0x592d76,_0x525283[_0x3c5c06(0x143)],_0x5de806,_0x1941c3);throw new Error('HTTP\x20error!\x20status:\x20'+_0x525283[_0x3c5c06(0x143)]);}const _0x2ae1c4=await _0x525283['json']();loggerService_1[_0x3c5c06(0x172)][_0x3c5c06(0xfd)](_0x3c5c06(0x139),'/payment-links/'+_0x592d76,_0x525283[_0x3c5c06(0x143)],_0x2ae1c4,_0x1941c3);if(_0x2ae1c4[_0x3c5c06(0x100)]||_0x2ae1c4['statusCode']){loggerService_1[_0x3c5c06(0x172)][_0x3c5c06(0x16a)](_0x3c5c06(0x139),_0x3c5c06(0x16d)+_0x592d76,_0x3c5c06(0x138)+(_0x2ae1c4[_0x3c5c06(0x14a)]||_0x2ae1c4['error']||_0x3c5c06(0x16e)));throw new Error('Noda\x20API\x20error:\x20'+(_0x2ae1c4[_0x3c5c06(0x14a)]||_0x2ae1c4[_0x3c5c06(0x100)]||_0x3c5c06(0x16e)));}let _0x330d90='PENDING';if(_0x2ae1c4['isActive']===![]){if(_0x2ae1c4[_0x3c5c06(0x125)]){const _0x53fa69=new Date(_0x2ae1c4[_0x3c5c06(0x125)]),_0x56fefa=new Date();_0x53fa69<_0x56fefa?_0x330d90=_0x3c5c06(0xfe):_0x330d90=_0x3c5c06(0x12a);}else _0x330d90=_0x3c5c06(0x12a);}else _0x330d90=_0x3c5c06(0x133);return{'status':_0x330d90,'amount':_0x2ae1c4['amount'],'currency':_0x2ae1c4[_0x3c5c06(0x171)],'isActive':_0x2ae1c4[_0x3c5c06(0x14b)]};}catch(_0x3b2c21){console[_0x3c5c06(0x100)](_0x3c5c06(0x144),_0x3b2c21),loggerService_1[_0x3c5c06(0x172)][_0x3c5c06(0x16a)]('noda',_0x3c5c06(0x16d)+_0x592d76,_0x3b2c21);throw new Error(_0x3c5c06(0x127)+(_0x3b2c21 instanceof Error?_0x3b2c21[_0x3c5c06(0x14a)]:_0x3c5c06(0x16e)));}}async['processWebhook'](_0x426124){const _0x21e568=a46_0x4455f7;console[_0x21e568(0x108)]('Processing\x20Noda\x20webhook:',_0x426124);let _0x21a816=_0x21e568(0x133);switch(_0x426124['Status']?.[_0x21e568(0x169)]()){case _0x21e568(0x16c):case _0x21e568(0x10e):case _0x21e568(0x110):case _0x21e568(0x12b):case _0x21e568(0x106):_0x426124[_0x21e568(0x11f)]===_0x21e568(0x151)?_0x21a816='PAID':_0x21a816='PENDING';break;case _0x21e568(0x168):case _0x21e568(0x161):case _0x21e568(0x148):case _0x21e568(0x100):case'rejected':_0x21a816=_0x21e568(0x12a);break;case'expired':case _0x21e568(0x10d):_0x21a816=_0x21e568(0xfe);break;case _0x21e568(0x140):case _0x21e568(0x13b):case'active':case _0x21e568(0x11b):case _0x21e568(0x160):default:_0x21a816='PENDING';break;}return{'paymentId':_0x426124[_0x21e568(0x149)]||_0x426124['PaymentId'],'status':_0x21a816,'amount':_0x426124[_0x21e568(0x158)],'currency':_0x426124['Currency'],'additionalInfo':{'method':_0x426124[_0x21e568(0x101)],'bankId':_0x426124[_0x21e568(0x131)],'settled':_0x426124[_0x21e568(0x11f)],'settlementDate':_0x426124[_0x21e568(0x165)],'remitterName':_0x426124['Remitter']?.[_0x21e568(0x10c)],'remitterIban':_0x426124[_0x21e568(0x121)]?.[_0x21e568(0x146)],'bankTransactionId':_0x426124[_0x21e568(0x162)]}};}[a46_0x4455f7(0x175)](_0x46c331,_0x19fdb4){const _0x281c8f=a46_0x4455f7;return console['log'](_0x281c8f(0x173),{'receivedSignature':_0x19fdb4,'paymentId':_0x46c331[_0x281c8f(0x14d)],'merchantPaymentId':_0x46c331['MerchantPaymentId']}),!![];}}exports[a46_0x4455f7(0x17a)]=NodaService;