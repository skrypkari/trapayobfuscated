'use strict';const a60_0x2b04d7=a60_0x25ab;function a60_0x25ab(_0x3d587c,_0x44e230){_0x3d587c=_0x3d587c-0x1ee;const _0x2702d1=a60_0x2702();let _0x25ab95=_0x2702d1[_0x3d587c];return _0x25ab95;}(function(_0x18a757,_0x5e123b){const _0xfbdd77=a60_0x25ab,_0x3df75b=_0x18a757();while(!![]){try{const _0x3065ea=parseInt(_0xfbdd77(0x1fd))/0x1+-parseInt(_0xfbdd77(0x21c))/0x2*(parseInt(_0xfbdd77(0x1f4))/0x3)+-parseInt(_0xfbdd77(0x243))/0x4+-parseInt(_0xfbdd77(0x225))/0x5+parseInt(_0xfbdd77(0x203))/0x6+parseInt(_0xfbdd77(0x20c))/0x7+parseInt(_0xfbdd77(0x207))/0x8*(parseInt(_0xfbdd77(0x22b))/0x9);if(_0x3065ea===_0x5e123b)break;else _0x3df75b['push'](_0x3df75b['shift']());}catch(_0x25c1a1){_0x3df75b['push'](_0x3df75b['shift']());}}}(a60_0x2702,0x71a36));function a60_0x2702(){const _0x1ea30f=['text','MerchantPaymentId','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','logWhiteDomainResponse','2703272ManbeQ','Short\x20Link:','Not\x20provided','isActive','https://tesoft.uk/gateway/pending.php?id=','cancelled','QR\x20Code\x20Link:','Settled','logWhiteDomainError','POST','EXPIRED','Remitter','defineProperty','headers','now','canceled','Unknown\x20error\x20from\x20Noda\x20API','GET','message','shortLink','URL:','log','Parsed\x20Result:','Response\x20data:','===\x20NODA\x20SUCCESS\x20===','timeout','HTTP\x20error!\x20status:\x20','BankTransactionId','Unknown\x20error','/payment-links/','statusCode','rejected','entries','successful','(8digits-8digits\x20format)','qrCodeLink','Response\x20Time:','Processing\x20Noda\x20webhook:','PENDING','success','PAID','1563AkIxlC','SettlementDate','Response\x20Body:','pending','error','HTTP\x20','Error\x20details:','Method','Status:','914051xFUQge','FAILED','createPaymentLink','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','===\x20PARSED\x20NODA\x20RESPONSE\x20===','apiUrl','603414XPWeEn','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','(8digits-8digits\x20format\x20for\x20Noda)','Status','4363960flLvxh','stack','Noda\x20payment\x20verification\x20error:','application/json','Failed\x20to\x20verify\x20Noda\x20payment:\x20','2094883dEhGwr','expiryDate','BankId','Status\x20Code:','===\x20NODA\x20API\x20ERROR\x20===','failed','loggerService','Business\x20Error:\x20','Yes','verifyPayment','Error\x20stack:','Request\x20Body\x20(Direct\x20JSON):','https://tesoft.uk/gateway/noda/','Iban','noda','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20===','2732dPRFBV','processWebhook','HTTP\x20Status:','processing','NodaService','Failed\x20to\x20parse\x20JSON\x20response:','Noda\x20API\x20error:\x20','Headers:','===\x20NODA\x20SERVICE\x20ERROR\x20===','32090bnyLaO','Order\x20ID\x20Used:','status','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','JSON\x20Parse\x20Error:\x20','Noda\x20webhook\x20signature\x20verification:','9VztusJ','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','active','in_progress','Currency','shortLinkUrls','json','PaymentId','‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:','/payment-links','__esModule','Payment\x20System/1.0','amount','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','parse','logWhiteDomainRequest','Amount','Order\x20ID\x20Format:','Error\x20message:'];a60_0x2702=function(){return _0x1ea30f;};return a60_0x2702();}Object[a60_0x2b04d7(0x24f)](exports,a60_0x2b04d7(0x235),{'value':!![]}),exports['NodaService']=void 0x0;const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0x401f12=a60_0x2b04d7;this[_0x401f12(0x202)]=_0x401f12(0x218),console[_0x401f12(0x258)](_0x401f12(0x239));}async[a60_0x2b04d7(0x1ff)](_0x5d0056){const _0x25e325=a60_0x2b04d7,{orderId:_0x432f2f,name:_0x234028,paymentDescription:_0x2319b2,amount:_0x5030c0,currency:_0x55beee,webhookUrl:_0xd67844,returnUrl:_0x48f9f8,expiryDate:_0x53f91c}=_0x5d0056,_0x15b29a=_0x55beee['toUpperCase'](),_0x79d0e3='https://tesoft.uk/gateway/noda/webhook/',_0x59a03d=_0x25e325(0x247)+_0x432f2f,_0x480c75={'name':_0x234028,'paymentDescription':_0x2319b2,'amount':_0x5030c0,'currency':_0x15b29a,'paymentId':_0x432f2f,'webhookUrl':_0x79d0e3,'returnUrl':_0x59a03d};_0x53f91c&&(_0x480c75['expiryDate']=_0x53f91c);const _0x213630=Date[_0x25e325(0x251)]();try{console['log'](_0x25e325(0x21b)),console[_0x25e325(0x258)](_0x25e325(0x257),this[_0x25e325(0x202)]),console[_0x25e325(0x258)](_0x25e325(0x217),JSON['stringify'](_0x480c75,null,0x2)),console[_0x25e325(0x258)](_0x25e325(0x23d),_0x432f2f,_0x25e325(0x205)),console[_0x25e325(0x258)](_0x25e325(0x233),_0x59a03d),loggerService_1[_0x25e325(0x212)]['logWhiteDomainRequest'](_0x25e325(0x21a),_0x25e325(0x234),_0x25e325(0x24c),_0x480c75);const _0x48c741=await fetch(this[_0x25e325(0x202)],{'method':_0x25e325(0x24c),'headers':{'Content-Type':_0x25e325(0x20a),'Accept':_0x25e325(0x20a),'User-Agent':'Payment\x20System/1.0'},'body':JSON['stringify'](_0x480c75)}),_0x3a0408=Date[_0x25e325(0x251)]()-_0x213630;console[_0x25e325(0x258)]('===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20==='),console[_0x25e325(0x258)](_0x25e325(0x1fc),_0x48c741['status']),console[_0x25e325(0x258)]('Status\x20Text:',_0x48c741['statusText']),console[_0x25e325(0x258)](_0x25e325(0x223),Object['fromEntries'](_0x48c741[_0x25e325(0x250)][_0x25e325(0x263)]())),console[_0x25e325(0x258)](_0x25e325(0x1ef),_0x3a0408+'ms');const _0x19f5c9=await _0x48c741[_0x25e325(0x23f)]();console[_0x25e325(0x258)]('Raw\x20Response\x20Body:',_0x19f5c9);if(!_0x48c741['ok']){console['error'](_0x25e325(0x210)),console[_0x25e325(0x1f8)](_0x25e325(0x21e),_0x48c741[_0x25e325(0x227)]),console[_0x25e325(0x1f8)](_0x25e325(0x1f6),_0x19f5c9),loggerService_1['loggerService'][_0x25e325(0x242)](_0x25e325(0x21a),_0x25e325(0x234),_0x48c741[_0x25e325(0x227)],_0x19f5c9,_0x3a0408),loggerService_1[_0x25e325(0x212)][_0x25e325(0x24b)](_0x25e325(0x21a),_0x25e325(0x234),_0x25e325(0x1f9)+_0x48c741[_0x25e325(0x227)]+':\x20'+_0x19f5c9);if(_0x48c741[_0x25e325(0x227)]===0x190)throw new Error('One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value');else{if(_0x48c741['status']===0x1f4)throw new Error('All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid');}throw new Error('HTTP\x20error!\x20status:\x20'+_0x48c741['status']+',\x20body:\x20'+_0x19f5c9);}let _0x8022ca;try{_0x8022ca=JSON[_0x25e325(0x23a)](_0x19f5c9);}catch(_0x795cb9){console[_0x25e325(0x1f8)](_0x25e325(0x221),_0x795cb9),loggerService_1[_0x25e325(0x212)][_0x25e325(0x24b)]('noda','/payment-links',_0x25e325(0x229)+_0x795cb9);throw new Error(_0x25e325(0x238)+_0x19f5c9);}console[_0x25e325(0x258)](_0x25e325(0x201)),console[_0x25e325(0x258)](_0x25e325(0x259),JSON['stringify'](_0x8022ca,null,0x2)),loggerService_1['loggerService'][_0x25e325(0x242)]('noda','/payment-links',_0x48c741[_0x25e325(0x227)],_0x8022ca,_0x3a0408);if(_0x8022ca[_0x25e325(0x1f8)]||_0x8022ca['statusCode']){const _0x2bec09=_0x8022ca[_0x25e325(0x255)]||_0x8022ca['error']||_0x25e325(0x253);console[_0x25e325(0x1f8)](_0x25e325(0x228)),console[_0x25e325(0x1f8)]('Error\x20Message:',_0x2bec09),console['error'](_0x25e325(0x20f),_0x8022ca[_0x25e325(0x261)]),loggerService_1[_0x25e325(0x212)][_0x25e325(0x24b)]('noda',_0x25e325(0x234),_0x25e325(0x213)+_0x2bec09);throw new Error(_0x25e325(0x222)+_0x2bec09);}if(!_0x8022ca['id']||!_0x8022ca['shortLinkUrls']?.['shortLink']){console[_0x25e325(0x1f8)](_0x25e325(0x22c)),console[_0x25e325(0x1f8)]('Missing\x20id\x20or\x20shortLink\x20in\x20response'),console[_0x25e325(0x1f8)](_0x25e325(0x25a),_0x8022ca),loggerService_1['loggerService']['logWhiteDomainError']('noda',_0x25e325(0x234),_0x25e325(0x200));throw new Error('Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink');}return console[_0x25e325(0x258)](_0x25e325(0x25b)),console[_0x25e325(0x258)]('Payment\x20Link\x20ID:',_0x8022ca['id']),console[_0x25e325(0x258)](_0x25e325(0x244),_0x8022ca[_0x25e325(0x230)][_0x25e325(0x256)]),console['log'](_0x25e325(0x249),_0x8022ca[_0x25e325(0x230)]['qrCodeLink']||_0x25e325(0x245)),console[_0x25e325(0x258)](_0x25e325(0x226),_0x432f2f,_0x25e325(0x265)),console[_0x25e325(0x258)](_0x25e325(0x241),_0x59a03d),{'gateway_payment_id':_0x8022ca['id'],'payment_url':_0x8022ca[_0x25e325(0x230)][_0x25e325(0x256)],'qr_code_url':_0x8022ca['shortLinkUrls'][_0x25e325(0x1ee)],'expiry_date':_0x8022ca[_0x25e325(0x20d)]};}catch(_0x4e2629){console['error'](_0x25e325(0x224)),console[_0x25e325(0x1f8)](_0x25e325(0x1fa),_0x4e2629),loggerService_1[_0x25e325(0x212)][_0x25e325(0x24b)]('noda',_0x25e325(0x234),_0x4e2629);if(_0x4e2629 instanceof Error){console['error'](_0x25e325(0x23e),_0x4e2629['message']),console['error'](_0x25e325(0x216),_0x4e2629[_0x25e325(0x208)]);throw new Error('Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20'+_0x4e2629[_0x25e325(0x255)]);}throw new Error(_0x25e325(0x204));}}async[a60_0x2b04d7(0x215)](_0x33c3cf){const _0x584ee3=a60_0x2b04d7,_0x2ba844=Date[_0x584ee3(0x251)]();try{loggerService_1[_0x584ee3(0x212)][_0x584ee3(0x23b)](_0x584ee3(0x21a),_0x584ee3(0x260)+_0x33c3cf,_0x584ee3(0x254),{});const _0x5d7336=await fetch(this[_0x584ee3(0x202)]+'/'+_0x33c3cf,{'method':_0x584ee3(0x254),'headers':{'Content-Type':_0x584ee3(0x20a),'User-Agent':_0x584ee3(0x236)}}),_0x21722c=Date[_0x584ee3(0x251)]()-_0x2ba844;if(!_0x5d7336['ok']){const _0x1d56ef=await _0x5d7336['text']();loggerService_1[_0x584ee3(0x212)]['logWhiteDomainResponse']('noda',_0x584ee3(0x260)+_0x33c3cf,_0x5d7336[_0x584ee3(0x227)],_0x1d56ef,_0x21722c);throw new Error(_0x584ee3(0x25d)+_0x5d7336[_0x584ee3(0x227)]);}const _0x2d5342=await _0x5d7336[_0x584ee3(0x231)]();loggerService_1[_0x584ee3(0x212)][_0x584ee3(0x242)](_0x584ee3(0x21a),'/payment-links/'+_0x33c3cf,_0x5d7336[_0x584ee3(0x227)],_0x2d5342,_0x21722c);if(_0x2d5342[_0x584ee3(0x1f8)]||_0x2d5342[_0x584ee3(0x261)]){loggerService_1[_0x584ee3(0x212)][_0x584ee3(0x24b)](_0x584ee3(0x21a),_0x584ee3(0x260)+_0x33c3cf,_0x584ee3(0x222)+(_0x2d5342[_0x584ee3(0x255)]||_0x2d5342['error']||_0x584ee3(0x25f)));throw new Error(_0x584ee3(0x222)+(_0x2d5342['message']||_0x2d5342[_0x584ee3(0x1f8)]||_0x584ee3(0x25f)));}let _0x529512='PENDING';if(_0x2d5342[_0x584ee3(0x246)]===![]){if(_0x2d5342[_0x584ee3(0x20d)]){const _0x28d71b=new Date(_0x2d5342[_0x584ee3(0x20d)]),_0x307ae4=new Date();_0x28d71b<_0x307ae4?_0x529512=_0x584ee3(0x24d):_0x529512=_0x584ee3(0x1fe);}else _0x529512=_0x584ee3(0x1fe);}else _0x529512=_0x584ee3(0x1f1);return{'status':_0x529512,'amount':_0x2d5342[_0x584ee3(0x237)],'currency':_0x2d5342['currency'],'isActive':_0x2d5342[_0x584ee3(0x246)]};}catch(_0x10a084){console[_0x584ee3(0x1f8)](_0x584ee3(0x209),_0x10a084),loggerService_1[_0x584ee3(0x212)][_0x584ee3(0x24b)](_0x584ee3(0x21a),_0x584ee3(0x260)+_0x33c3cf,_0x10a084);throw new Error(_0x584ee3(0x20b)+(_0x10a084 instanceof Error?_0x10a084[_0x584ee3(0x255)]:_0x584ee3(0x25f)));}}async[a60_0x2b04d7(0x21d)](_0x354c61){const _0x1e924a=a60_0x2b04d7;console[_0x1e924a(0x258)](_0x1e924a(0x1f0),_0x354c61);let _0x1221b6='PENDING';switch(_0x354c61[_0x1e924a(0x206)]?.['toLowerCase']()){case'done':case'completed':case'paid':case _0x1e924a(0x1f2):case _0x1e924a(0x264):_0x354c61[_0x1e924a(0x24a)]===_0x1e924a(0x214)?_0x1221b6=_0x1e924a(0x1f3):_0x1221b6='PENDING';break;case _0x1e924a(0x248):case _0x1e924a(0x252):case _0x1e924a(0x211):case _0x1e924a(0x1f8):case _0x1e924a(0x262):_0x1221b6=_0x1e924a(0x1fe);break;case'expired':case _0x1e924a(0x25c):_0x1221b6=_0x1e924a(0x24d);break;case _0x1e924a(0x1f7):case'created':case _0x1e924a(0x22d):case _0x1e924a(0x21f):case _0x1e924a(0x22e):default:_0x1221b6=_0x1e924a(0x1f1);break;}return{'paymentId':_0x354c61[_0x1e924a(0x240)]||_0x354c61['PaymentId'],'status':_0x1221b6,'amount':_0x354c61[_0x1e924a(0x23c)],'currency':_0x354c61[_0x1e924a(0x22f)],'additionalInfo':{'method':_0x354c61[_0x1e924a(0x1fb)],'bankId':_0x354c61[_0x1e924a(0x20e)],'settled':_0x354c61[_0x1e924a(0x24a)],'settlementDate':_0x354c61[_0x1e924a(0x1f5)],'remitterName':_0x354c61[_0x1e924a(0x24e)]?.['Name'],'remitterIban':_0x354c61[_0x1e924a(0x24e)]?.[_0x1e924a(0x219)],'bankTransactionId':_0x354c61[_0x1e924a(0x25e)]}};}['verifyWebhookSignature'](_0x4d6c38,_0x8c745b){const _0x3d06a3=a60_0x2b04d7;return console['log'](_0x3d06a3(0x22a),{'receivedSignature':_0x8c745b,'paymentId':_0x4d6c38[_0x3d06a3(0x232)],'merchantPaymentId':_0x4d6c38['MerchantPaymentId']}),!![];}}exports[a60_0x2b04d7(0x220)]=NodaService;