'use strict';const a44_0x499d9f=a44_0x335b;(function(_0x4a8a76,_0x272ae1){const _0x21e1b0=a44_0x335b,_0x511194=_0x4a8a76();while(!![]){try{const _0x34c37c=parseInt(_0x21e1b0(0x1ff))/0x1+parseInt(_0x21e1b0(0x1d2))/0x2+-parseInt(_0x21e1b0(0x210))/0x3+parseInt(_0x21e1b0(0x1f8))/0x4*(parseInt(_0x21e1b0(0x20f))/0x5)+-parseInt(_0x21e1b0(0x216))/0x6+-parseInt(_0x21e1b0(0x21f))/0x7*(-parseInt(_0x21e1b0(0x1c9))/0x8)+-parseInt(_0x21e1b0(0x1f0))/0x9;if(_0x34c37c===_0x272ae1)break;else _0x511194['push'](_0x511194['shift']());}catch(_0x42c88d){_0x511194['push'](_0x511194['shift']());}}}(a44_0x60bd,0xacf63));function a44_0x335b(_0xe8027d,_0x2126ab){const _0x60bd9=a44_0x60bd();return a44_0x335b=function(_0x335be3,_0x1bd42e){_0x335be3=_0x335be3-0x1bb;let _0x462273=_0x60bd9[_0x335be3];return _0x462273;},a44_0x335b(_0xe8027d,_0x2126ab);}function a44_0x60bd(){const _0x5f5059=['statusText','FAILED','Payment\x20Link\x20ID:','(8digits-8digits\x20format)','Request\x20Body\x20(Direct\x20JSON):','error','logWhiteDomainResponse','qrCodeLink','3355177ZCXzfG','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','active','URL:','text','success','cancelled','stringify','Error\x20stack:','pending','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Failed\x20to\x20verify\x20Noda\x20payment:\x20','message','done','Failed\x20to\x20parse\x20JSON\x20response:','in_progress','/payment-links/','===\x20PARSED\x20NODA\x20RESPONSE\x20===','Settled','json','application/json','Response\x20Time:','TesSoft\x20Payment\x20System/1.0','HTTP\x20','HTTP\x20error!\x20status:\x20','expiryDate','NodaService','GET','log','shortLinkUrls','8vFPmLv','Unknown\x20error\x20from\x20Noda\x20API','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','Status\x20Text:','logWhiteDomainRequest','QR\x20Code\x20Link:','now','BankTransactionId','fromEntries','1377382JPhuQo','verifyWebhookSignature','Error\x20Message:','status','toUpperCase','failed','Unknown\x20error','canceled','PENDING','Status:','entries','parse','https://tesoft.uk/gateway/noda/','Short\x20Link:','Raw\x20Response\x20Body:','===\x20NODA\x20API\x20ERROR\x20===','amount','JSON\x20Parse\x20Error:\x20','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','Iban','PaymentId','stack','apiUrl','Status\x20Code:','noda','loggerService','üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','statusCode','toLowerCase','===\x20NODA\x20SUCCESS\x20===','6048954VyYtMu',',\x20body:\x20','Business\x20Error:\x20','isActive','Parsed\x20Result:','Response\x20data:','Order\x20ID\x20Used:','Noda\x20webhook\x20signature\x20verification:','983548aAcxpD','POST','(8digits-8digits\x20format\x20for\x20Noda)','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','verifyPayment','Noda\x20payment\x20verification\x20error:','/payment-links','168768gYgSxt','Name','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:','shortLink','Response\x20Body:','HTTP\x20Status:','https://tesoft.uk/gateway/noda/webhook/','expired','Headers:','Not\x20provided','Amount','EXPIRED','rejected','Remitter','Yes','15lupNMu','2017272Qohzpr','successful','logWhiteDomainError','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20===','Processing\x20Noda\x20webhook:','timeout','128700xoTXZE'];a44_0x60bd=function(){return _0x5f5059;};return a44_0x60bd();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a44_0x499d9f(0x1c5)]=void 0x0;const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0x1eba6f=a44_0x499d9f;this[_0x1eba6f(0x1e8)]=_0x1eba6f(0x1de),console[_0x1eba6f(0x1c7)](_0x1eba6f(0x1ec));}async['createPaymentLink'](_0x1cda00){const _0x12c46b=a44_0x499d9f,{orderId:_0x598e3f,name:_0x7d02f9,paymentDescription:_0x22f9d9,amount:_0x7bd08d,currency:_0x241936,webhookUrl:_0x51dafd,returnUrl:_0x1bc933,expiryDate:_0x5b40e4}=_0x1cda00,_0xdf683f=_0x241936[_0x12c46b(0x1d6)](),_0x28991f=_0x12c46b(0x206),_0x52d8fa='https://tesoft.uk/gateway/pending.php?id='+_0x598e3f,_0x139466={'name':_0x7d02f9,'paymentDescription':_0x22f9d9,'amount':_0x7bd08d,'currency':_0xdf683f,'paymentId':_0x598e3f,'webhookUrl':_0x28991f,'returnUrl':_0x52d8fa};_0x5b40e4&&(_0x139466[_0x12c46b(0x1c4)]=_0x5b40e4);const _0x34e85b=Date[_0x12c46b(0x1cf)]();try{console[_0x12c46b(0x1c7)](_0x12c46b(0x213)),console[_0x12c46b(0x1c7)](_0x12c46b(0x222),this[_0x12c46b(0x1e8)]),console[_0x12c46b(0x1c7)](_0x12c46b(0x21b),JSON[_0x12c46b(0x226)](_0x139466,null,0x2)),console[_0x12c46b(0x1c7)]('Order\x20ID\x20Format:',_0x598e3f,_0x12c46b(0x1fa)),console[_0x12c46b(0x1c7)](_0x12c46b(0x202),_0x52d8fa),loggerService_1[_0x12c46b(0x1eb)][_0x12c46b(0x1cd)](_0x12c46b(0x1ea),_0x12c46b(0x1fe),'POST',_0x139466);const _0x493f87=await fetch(this[_0x12c46b(0x1e8)],{'method':_0x12c46b(0x1f9),'headers':{'Content-Type':_0x12c46b(0x1bf),'Accept':_0x12c46b(0x1bf),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x12c46b(0x226)](_0x139466)}),_0x2fddde=Date['now']()-_0x34e85b;console['log'](_0x12c46b(0x1e4)),console['log'](_0x12c46b(0x1db),_0x493f87['status']),console[_0x12c46b(0x1c7)](_0x12c46b(0x1cc),_0x493f87[_0x12c46b(0x217)]),console[_0x12c46b(0x1c7)](_0x12c46b(0x208),Object[_0x12c46b(0x1d1)](_0x493f87['headers'][_0x12c46b(0x1dc)]())),console['log'](_0x12c46b(0x1c0),_0x2fddde+'ms');const _0xfc3d06=await _0x493f87[_0x12c46b(0x223)]();console[_0x12c46b(0x1c7)](_0x12c46b(0x1e0),_0xfc3d06);if(!_0x493f87['ok']){console[_0x12c46b(0x21c)](_0x12c46b(0x1e1)),console['error'](_0x12c46b(0x205),_0x493f87[_0x12c46b(0x1d5)]),console[_0x12c46b(0x21c)](_0x12c46b(0x204),_0xfc3d06),loggerService_1[_0x12c46b(0x1eb)][_0x12c46b(0x21d)]('noda',_0x12c46b(0x1fe),_0x493f87[_0x12c46b(0x1d5)],_0xfc3d06,_0x2fddde),loggerService_1[_0x12c46b(0x1eb)][_0x12c46b(0x212)]('noda',_0x12c46b(0x1fe),_0x12c46b(0x1c2)+_0x493f87[_0x12c46b(0x1d5)]+':\x20'+_0xfc3d06);if(_0x493f87[_0x12c46b(0x1d5)]===0x190)throw new Error('One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value');else{if(_0x493f87['status']===0x1f4)throw new Error('All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid');}throw new Error(_0x12c46b(0x1c3)+_0x493f87[_0x12c46b(0x1d5)]+_0x12c46b(0x1f1)+_0xfc3d06);}let _0x4a1858;try{_0x4a1858=JSON[_0x12c46b(0x1dd)](_0xfc3d06);}catch(_0x5b31df){console['error'](_0x12c46b(0x22d),_0x5b31df),loggerService_1[_0x12c46b(0x1eb)][_0x12c46b(0x212)]('noda',_0x12c46b(0x1fe),_0x12c46b(0x1e3)+_0x5b31df);throw new Error(_0x12c46b(0x220)+_0xfc3d06);}console[_0x12c46b(0x1c7)](_0x12c46b(0x1bc)),console[_0x12c46b(0x1c7)](_0x12c46b(0x1f4),JSON['stringify'](_0x4a1858,null,0x2)),loggerService_1[_0x12c46b(0x1eb)][_0x12c46b(0x21d)](_0x12c46b(0x1ea),_0x12c46b(0x1fe),_0x493f87[_0x12c46b(0x1d5)],_0x4a1858,_0x2fddde);if(_0x4a1858[_0x12c46b(0x21c)]||_0x4a1858[_0x12c46b(0x1ed)]){const _0x2aab2a=_0x4a1858[_0x12c46b(0x22b)]||_0x4a1858[_0x12c46b(0x21c)]||_0x12c46b(0x1ca);console[_0x12c46b(0x21c)](_0x12c46b(0x1cb)),console[_0x12c46b(0x21c)](_0x12c46b(0x1d4),_0x2aab2a),console[_0x12c46b(0x21c)](_0x12c46b(0x1e9),_0x4a1858[_0x12c46b(0x1ed)]),loggerService_1[_0x12c46b(0x1eb)][_0x12c46b(0x212)](_0x12c46b(0x1ea),_0x12c46b(0x1fe),_0x12c46b(0x1f2)+_0x2aab2a);throw new Error('Noda\x20API\x20error:\x20'+_0x2aab2a);}if(!_0x4a1858['id']||!_0x4a1858[_0x12c46b(0x1c8)]?.[_0x12c46b(0x203)]){console[_0x12c46b(0x21c)](_0x12c46b(0x229)),console[_0x12c46b(0x21c)]('Missing\x20id\x20or\x20shortLink\x20in\x20response'),console[_0x12c46b(0x21c)](_0x12c46b(0x1f5),_0x4a1858),loggerService_1[_0x12c46b(0x1eb)]['logWhiteDomainError'](_0x12c46b(0x1ea),_0x12c46b(0x1fe),'Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink');throw new Error('Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink');}return console[_0x12c46b(0x1c7)](_0x12c46b(0x1ef)),console[_0x12c46b(0x1c7)](_0x12c46b(0x219),_0x4a1858['id']),console['log'](_0x12c46b(0x1df),_0x4a1858['shortLinkUrls'][_0x12c46b(0x203)]),console['log'](_0x12c46b(0x1ce),_0x4a1858[_0x12c46b(0x1c8)][_0x12c46b(0x21e)]||_0x12c46b(0x209)),console[_0x12c46b(0x1c7)](_0x12c46b(0x1f6),_0x598e3f,_0x12c46b(0x21a)),console[_0x12c46b(0x1c7)](_0x12c46b(0x201),_0x52d8fa),{'gateway_payment_id':_0x4a1858['id'],'payment_url':_0x4a1858[_0x12c46b(0x1c8)][_0x12c46b(0x203)],'qr_code_url':_0x4a1858['shortLinkUrls'][_0x12c46b(0x21e)],'expiry_date':_0x4a1858[_0x12c46b(0x1c4)]};}catch(_0x581a9f){console[_0x12c46b(0x21c)]('===\x20NODA\x20SERVICE\x20ERROR\x20==='),console[_0x12c46b(0x21c)]('Error\x20details:',_0x581a9f),loggerService_1[_0x12c46b(0x1eb)]['logWhiteDomainError'](_0x12c46b(0x1ea),_0x12c46b(0x1fe),_0x581a9f);if(_0x581a9f instanceof Error){console['error']('Error\x20message:',_0x581a9f['message']),console[_0x12c46b(0x21c)](_0x12c46b(0x227),_0x581a9f[_0x12c46b(0x1e7)]);throw new Error(_0x12c46b(0x1fb)+_0x581a9f[_0x12c46b(0x22b)]);}throw new Error('Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error');}}async[a44_0x499d9f(0x1fc)](_0x49f944){const _0x5a3cd8=a44_0x499d9f,_0x3ef8c4=Date[_0x5a3cd8(0x1cf)]();try{loggerService_1[_0x5a3cd8(0x1eb)][_0x5a3cd8(0x1cd)](_0x5a3cd8(0x1ea),_0x5a3cd8(0x1bb)+_0x49f944,_0x5a3cd8(0x1c6),{});const _0x52a737=await fetch(this[_0x5a3cd8(0x1e8)]+'/'+_0x49f944,{'method':'GET','headers':{'Content-Type':'application/json','User-Agent':_0x5a3cd8(0x1c1)}}),_0x1bd695=Date[_0x5a3cd8(0x1cf)]()-_0x3ef8c4;if(!_0x52a737['ok']){const _0x2ec421=await _0x52a737[_0x5a3cd8(0x223)]();loggerService_1['loggerService'][_0x5a3cd8(0x21d)](_0x5a3cd8(0x1ea),'/payment-links/'+_0x49f944,_0x52a737[_0x5a3cd8(0x1d5)],_0x2ec421,_0x1bd695);throw new Error(_0x5a3cd8(0x1c3)+_0x52a737[_0x5a3cd8(0x1d5)]);}const _0x2c7dfb=await _0x52a737[_0x5a3cd8(0x1be)]();loggerService_1[_0x5a3cd8(0x1eb)][_0x5a3cd8(0x21d)](_0x5a3cd8(0x1ea),'/payment-links/'+_0x49f944,_0x52a737['status'],_0x2c7dfb,_0x1bd695);if(_0x2c7dfb[_0x5a3cd8(0x21c)]||_0x2c7dfb[_0x5a3cd8(0x1ed)]){loggerService_1['loggerService']['logWhiteDomainError'](_0x5a3cd8(0x1ea),'/payment-links/'+_0x49f944,'Noda\x20API\x20error:\x20'+(_0x2c7dfb[_0x5a3cd8(0x22b)]||_0x2c7dfb[_0x5a3cd8(0x21c)]||_0x5a3cd8(0x1d8)));throw new Error('Noda\x20API\x20error:\x20'+(_0x2c7dfb[_0x5a3cd8(0x22b)]||_0x2c7dfb['error']||'Unknown\x20error'));}let _0x311a83=_0x5a3cd8(0x1da);if(_0x2c7dfb[_0x5a3cd8(0x1f3)]===![]){if(_0x2c7dfb[_0x5a3cd8(0x1c4)]){const _0x534ac3=new Date(_0x2c7dfb['expiryDate']),_0x60c2b4=new Date();_0x534ac3<_0x60c2b4?_0x311a83=_0x5a3cd8(0x20b):_0x311a83=_0x5a3cd8(0x218);}else _0x311a83=_0x5a3cd8(0x218);}else _0x311a83='PENDING';return{'status':_0x311a83,'amount':_0x2c7dfb[_0x5a3cd8(0x1e2)],'currency':_0x2c7dfb['currency'],'isActive':_0x2c7dfb[_0x5a3cd8(0x1f3)]};}catch(_0x2dc1f8){console[_0x5a3cd8(0x21c)](_0x5a3cd8(0x1fd),_0x2dc1f8),loggerService_1[_0x5a3cd8(0x1eb)][_0x5a3cd8(0x212)](_0x5a3cd8(0x1ea),'/payment-links/'+_0x49f944,_0x2dc1f8);throw new Error(_0x5a3cd8(0x22a)+(_0x2dc1f8 instanceof Error?_0x2dc1f8['message']:_0x5a3cd8(0x1d8)));}}async['processWebhook'](_0x1b60b0){const _0x3b8ff8=a44_0x499d9f;console[_0x3b8ff8(0x1c7)](_0x3b8ff8(0x214),_0x1b60b0);let _0x2ee27f=_0x3b8ff8(0x1da);switch(_0x1b60b0['Status']?.[_0x3b8ff8(0x1ee)]()){case _0x3b8ff8(0x22c):case'completed':case'paid':case _0x3b8ff8(0x224):case _0x3b8ff8(0x211):_0x1b60b0[_0x3b8ff8(0x1bd)]===_0x3b8ff8(0x20e)?_0x2ee27f='PAID':_0x2ee27f=_0x3b8ff8(0x1da);break;case _0x3b8ff8(0x225):case _0x3b8ff8(0x1d9):case _0x3b8ff8(0x1d7):case _0x3b8ff8(0x21c):case _0x3b8ff8(0x20c):_0x2ee27f=_0x3b8ff8(0x218);break;case _0x3b8ff8(0x207):case _0x3b8ff8(0x215):_0x2ee27f='EXPIRED';break;case _0x3b8ff8(0x228):case'created':case _0x3b8ff8(0x221):case'processing':case _0x3b8ff8(0x22e):default:_0x2ee27f=_0x3b8ff8(0x1da);break;}return{'paymentId':_0x1b60b0['MerchantPaymentId']||_0x1b60b0[_0x3b8ff8(0x1e6)],'status':_0x2ee27f,'amount':_0x1b60b0[_0x3b8ff8(0x20a)],'currency':_0x1b60b0['Currency'],'additionalInfo':{'method':_0x1b60b0['Method'],'bankId':_0x1b60b0['BankId'],'settled':_0x1b60b0['Settled'],'settlementDate':_0x1b60b0['SettlementDate'],'remitterName':_0x1b60b0[_0x3b8ff8(0x20d)]?.[_0x3b8ff8(0x200)],'remitterIban':_0x1b60b0[_0x3b8ff8(0x20d)]?.[_0x3b8ff8(0x1e5)],'bankTransactionId':_0x1b60b0[_0x3b8ff8(0x1d0)]}};}[a44_0x499d9f(0x1d3)](_0x5ee39e,_0x1c191c){const _0x4ccad2=a44_0x499d9f;return console[_0x4ccad2(0x1c7)](_0x4ccad2(0x1f7),{'receivedSignature':_0x1c191c,'paymentId':_0x5ee39e['PaymentId'],'merchantPaymentId':_0x5ee39e['MerchantPaymentId']}),!![];}}exports['NodaService']=NodaService;