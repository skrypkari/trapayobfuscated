'use strict';function a43_0x1aee(){const _0x3efa51=[',\x20body:\x20','(8digits-8digits\x20format)','toLowerCase','3989576MrbIVV','__esModule','‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:','5400513FFstDY','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','Noda\x20payment\x20verification\x20error:','Status\x20Code:','now','===\x20NODA\x20SERVICE\x20ERROR\x20===','FAILED','completed','Order\x20ID\x20Used:','loggerService','1261418jbbSjs','Error\x20Message:','JSON\x20Parse\x20Error:\x20','Iban','Short\x20Link:','done','expiryDate','pending','logWhiteDomainRequest','Unknown\x20error','Processing\x20Noda\x20webhook:','Error\x20details:','HTTP\x20','log','expired','PaymentId','logWhiteDomainError','72pjJHmY','Payment\x20Link\x20ID:','Currency','entries','HTTP\x20error!\x20status:\x20','json','(8digits-8digits\x20format\x20for\x20Noda)','Raw\x20Response\x20Body:','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','headers','SettlementDate','error','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','MerchantPaymentId','success','Missing\x20id\x20or\x20shortLink\x20in\x20response','noda','status','Method','message','Order\x20ID\x20Format:','Yes','apiUrl','processWebhook','shortLinkUrls','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','EXPIRED','10893260IqtGHY','verifyWebhookSignature','TesSoft\x20Payment\x20System/1.0','Name','Headers:','PAID','===\x20NODA\x20API\x20ERROR\x20===','POST','===\x20PARSED\x20NODA\x20RESPONSE\x20===','Response\x20Body:','createPaymentLink','stringify','QR\x20Code\x20Link:','1yfzvPp','All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20===','GET','Unknown\x20error\x20from\x20Noda\x20API','Noda\x20API\x20error:\x20','parse','/payment-links','successful','Error\x20message:','timeout','Status\x20Text:','https://tesoft.uk/gateway/pending.php?id=','active','currency','Status','375352VeEPcQ','https://tesoft.uk/gateway/noda/webhook/','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','amount','===\x20NODA\x20SUCCESS\x20===','rejected','text','/payment-links/','application/json','logWhiteDomainResponse','HTTP\x20Status:','URL:','shortLink','fromEntries','PENDING','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','isActive','4164235QSgqlo','Noda\x20webhook\x20signature\x20verification:','canceled','üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','Amount','paid','Settled','11701896kjhuwd','defineProperty','Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink','statusCode'];a43_0x1aee=function(){return _0x3efa51;};return a43_0x1aee();}const a43_0x2a0ca0=a43_0x5d56;(function(_0x335e76,_0x503fbc){const _0x3f20d0=a43_0x5d56,_0x7534cf=_0x335e76();while(!![]){try{const _0x4172ca=parseInt(_0x3f20d0(0x12b))/0x1*(-parseInt(_0x3f20d0(0x168))/0x2)+parseInt(_0x3f20d0(0x15e))/0x3+-parseInt(_0x3f20d0(0x15b))/0x4+parseInt(_0x3f20d0(0x14d))/0x5+-parseInt(_0x3f20d0(0x154))/0x6+parseInt(_0x3f20d0(0x194))/0x7+-parseInt(_0x3f20d0(0x13b))/0x8*(-parseInt(_0x3f20d0(0x179))/0x9);if(_0x4172ca===_0x503fbc)break;else _0x7534cf['push'](_0x7534cf['shift']());}catch(_0x27a18f){_0x7534cf['push'](_0x7534cf['shift']());}}}(a43_0x1aee,0xf0c13));Object[a43_0x2a0ca0(0x155)](exports,a43_0x2a0ca0(0x15c),{'value':!![]}),exports['NodaService']=void 0x0;const loggerService_1=require('../loggerService');function a43_0x5d56(_0x23163c,_0x118ab9){const _0x1aee01=a43_0x1aee();return a43_0x5d56=function(_0x5d56b5,_0x15f0bd){_0x5d56b5=_0x5d56b5-0x129;let _0x5e8de1=_0x1aee01[_0x5d56b5];return _0x5e8de1;},a43_0x5d56(_0x23163c,_0x118ab9);}class NodaService{constructor(){const _0x4b000c=a43_0x2a0ca0;this[_0x4b000c(0x18f)]='https://tesoft.uk/gateway/noda/',console[_0x4b000c(0x175)](_0x4b000c(0x150));}async[a43_0x2a0ca0(0x19e)](_0x55c424){const _0x3cefd8=a43_0x2a0ca0,{orderId:_0x5df1cc,name:_0x5beffb,paymentDescription:_0x35fdfd,amount:_0x45dbc2,currency:_0x4b26f1,webhookUrl:_0x44a765,returnUrl:_0x29de35,expiryDate:_0xc38a10}=_0x55c424,_0x5730ed=_0x4b26f1['toUpperCase'](),_0x246c3f=_0x3cefd8(0x13c),_0x41cd77=_0x3cefd8(0x137)+_0x5df1cc,_0x1f42ad={'name':_0x5beffb,'paymentDescription':_0x35fdfd,'amount':_0x45dbc2,'currency':_0x5730ed,'paymentId':_0x5df1cc,'webhookUrl':_0x246c3f,'returnUrl':_0x41cd77};_0xc38a10&&(_0x1f42ad[_0x3cefd8(0x16e)]=_0xc38a10);const _0x3aa8ab=Date[_0x3cefd8(0x162)]();try{console[_0x3cefd8(0x175)](_0x3cefd8(0x12d)),console['log'](_0x3cefd8(0x146),this['apiUrl']),console[_0x3cefd8(0x175)]('Request\x20Body\x20(Direct\x20JSON):',JSON['stringify'](_0x1f42ad,null,0x2)),console[_0x3cefd8(0x175)](_0x3cefd8(0x18d),_0x5df1cc,_0x3cefd8(0x17f)),console[_0x3cefd8(0x175)](_0x3cefd8(0x15d),_0x41cd77),loggerService_1['loggerService'][_0x3cefd8(0x170)](_0x3cefd8(0x189),'/payment-links','POST',_0x1f42ad);const _0x45aa7c=await fetch(this[_0x3cefd8(0x18f)],{'method':_0x3cefd8(0x19b),'headers':{'Content-Type':_0x3cefd8(0x143),'Accept':_0x3cefd8(0x143),'User-Agent':_0x3cefd8(0x196)},'body':JSON[_0x3cefd8(0x129)](_0x1f42ad)}),_0x456135=Date[_0x3cefd8(0x162)]()-_0x3aa8ab;console[_0x3cefd8(0x175)](_0x3cefd8(0x14b)),console[_0x3cefd8(0x175)]('Status:',_0x45aa7c[_0x3cefd8(0x18a)]),console[_0x3cefd8(0x175)](_0x3cefd8(0x136),_0x45aa7c['statusText']),console[_0x3cefd8(0x175)](_0x3cefd8(0x198),Object[_0x3cefd8(0x148)](_0x45aa7c[_0x3cefd8(0x182)][_0x3cefd8(0x17c)]())),console[_0x3cefd8(0x175)]('Response\x20Time:',_0x456135+'ms');const _0x5478a9=await _0x45aa7c[_0x3cefd8(0x141)]();console[_0x3cefd8(0x175)](_0x3cefd8(0x180),_0x5478a9);if(!_0x45aa7c['ok']){console[_0x3cefd8(0x184)](_0x3cefd8(0x19a)),console[_0x3cefd8(0x184)](_0x3cefd8(0x145),_0x45aa7c[_0x3cefd8(0x18a)]),console[_0x3cefd8(0x184)](_0x3cefd8(0x19d),_0x5478a9),loggerService_1[_0x3cefd8(0x167)][_0x3cefd8(0x144)]('noda',_0x3cefd8(0x132),_0x45aa7c[_0x3cefd8(0x18a)],_0x5478a9,_0x456135),loggerService_1[_0x3cefd8(0x167)]['logWhiteDomainError'](_0x3cefd8(0x189),'/payment-links',_0x3cefd8(0x174)+_0x45aa7c['status']+':\x20'+_0x5478a9);if(_0x45aa7c[_0x3cefd8(0x18a)]===0x190)throw new Error(_0x3cefd8(0x185));else{if(_0x45aa7c[_0x3cefd8(0x18a)]===0x1f4)throw new Error(_0x3cefd8(0x12c));}throw new Error(_0x3cefd8(0x17d)+_0x45aa7c[_0x3cefd8(0x18a)]+_0x3cefd8(0x158)+_0x5478a9);}let _0x177e8b;try{_0x177e8b=JSON[_0x3cefd8(0x131)](_0x5478a9);}catch(_0x518bf4){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0x518bf4),loggerService_1[_0x3cefd8(0x167)]['logWhiteDomainError']('noda','/payment-links',_0x3cefd8(0x16a)+_0x518bf4);throw new Error(_0x3cefd8(0x15f)+_0x5478a9);}console[_0x3cefd8(0x175)](_0x3cefd8(0x19c)),console[_0x3cefd8(0x175)]('Parsed\x20Result:',JSON[_0x3cefd8(0x129)](_0x177e8b,null,0x2)),loggerService_1[_0x3cefd8(0x167)][_0x3cefd8(0x144)](_0x3cefd8(0x189),_0x3cefd8(0x132),_0x45aa7c[_0x3cefd8(0x18a)],_0x177e8b,_0x456135);if(_0x177e8b[_0x3cefd8(0x184)]||_0x177e8b['statusCode']){const _0x26849d=_0x177e8b['message']||_0x177e8b[_0x3cefd8(0x184)]||_0x3cefd8(0x12f);console[_0x3cefd8(0x184)]('===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x3cefd8(0x184)](_0x3cefd8(0x169),_0x26849d),console[_0x3cefd8(0x184)](_0x3cefd8(0x161),_0x177e8b[_0x3cefd8(0x157)]),loggerService_1[_0x3cefd8(0x167)][_0x3cefd8(0x178)](_0x3cefd8(0x189),_0x3cefd8(0x132),'Business\x20Error:\x20'+_0x26849d);throw new Error(_0x3cefd8(0x130)+_0x26849d);}if(!_0x177e8b['id']||!_0x177e8b['shortLinkUrls']?.[_0x3cefd8(0x147)]){console[_0x3cefd8(0x184)](_0x3cefd8(0x181)),console[_0x3cefd8(0x184)](_0x3cefd8(0x188)),console[_0x3cefd8(0x184)]('Response\x20data:',_0x177e8b),loggerService_1[_0x3cefd8(0x167)]['logWhiteDomainError'](_0x3cefd8(0x189),'/payment-links',_0x3cefd8(0x192));throw new Error(_0x3cefd8(0x156));}return console['log'](_0x3cefd8(0x13f)),console[_0x3cefd8(0x175)](_0x3cefd8(0x17a),_0x177e8b['id']),console[_0x3cefd8(0x175)](_0x3cefd8(0x16c),_0x177e8b[_0x3cefd8(0x191)]['shortLink']),console[_0x3cefd8(0x175)](_0x3cefd8(0x12a),_0x177e8b[_0x3cefd8(0x191)]['qrCodeLink']||'Not\x20provided'),console[_0x3cefd8(0x175)](_0x3cefd8(0x166),_0x5df1cc,_0x3cefd8(0x159)),console[_0x3cefd8(0x175)](_0x3cefd8(0x13d),_0x41cd77),{'gateway_payment_id':_0x177e8b['id'],'payment_url':_0x177e8b[_0x3cefd8(0x191)][_0x3cefd8(0x147)],'qr_code_url':_0x177e8b[_0x3cefd8(0x191)]['qrCodeLink'],'expiry_date':_0x177e8b[_0x3cefd8(0x16e)]};}catch(_0x43fc33){console[_0x3cefd8(0x184)](_0x3cefd8(0x163)),console[_0x3cefd8(0x184)](_0x3cefd8(0x173),_0x43fc33),loggerService_1[_0x3cefd8(0x167)][_0x3cefd8(0x178)]('noda','/payment-links',_0x43fc33);if(_0x43fc33 instanceof Error){console['error'](_0x3cefd8(0x134),_0x43fc33[_0x3cefd8(0x18c)]),console[_0x3cefd8(0x184)]('Error\x20stack:',_0x43fc33['stack']);throw new Error('Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20'+_0x43fc33['message']);}throw new Error(_0x3cefd8(0x14a));}}async['verifyPayment'](_0x233e87){const _0x165e04=a43_0x2a0ca0,_0x495994=Date[_0x165e04(0x162)]();try{loggerService_1[_0x165e04(0x167)][_0x165e04(0x170)](_0x165e04(0x189),'/payment-links/'+_0x233e87,_0x165e04(0x12e),{});const _0x41d27a=await fetch(this[_0x165e04(0x18f)]+'/'+_0x233e87,{'method':_0x165e04(0x12e),'headers':{'Content-Type':'application/json','User-Agent':_0x165e04(0x196)}}),_0x44a1e2=Date[_0x165e04(0x162)]()-_0x495994;if(!_0x41d27a['ok']){const _0x3c4c4c=await _0x41d27a['text']();loggerService_1['loggerService']['logWhiteDomainResponse']('noda',_0x165e04(0x142)+_0x233e87,_0x41d27a[_0x165e04(0x18a)],_0x3c4c4c,_0x44a1e2);throw new Error(_0x165e04(0x17d)+_0x41d27a[_0x165e04(0x18a)]);}const _0x4bafe3=await _0x41d27a[_0x165e04(0x17e)]();loggerService_1['loggerService'][_0x165e04(0x144)](_0x165e04(0x189),_0x165e04(0x142)+_0x233e87,_0x41d27a['status'],_0x4bafe3,_0x44a1e2);if(_0x4bafe3['error']||_0x4bafe3['statusCode']){loggerService_1[_0x165e04(0x167)][_0x165e04(0x178)](_0x165e04(0x189),_0x165e04(0x142)+_0x233e87,_0x165e04(0x130)+(_0x4bafe3[_0x165e04(0x18c)]||_0x4bafe3[_0x165e04(0x184)]||'Unknown\x20error'));throw new Error(_0x165e04(0x130)+(_0x4bafe3[_0x165e04(0x18c)]||_0x4bafe3[_0x165e04(0x184)]||_0x165e04(0x171)));}let _0x398ac0=_0x165e04(0x149);if(_0x4bafe3[_0x165e04(0x14c)]===![]){if(_0x4bafe3['expiryDate']){const _0x1921e8=new Date(_0x4bafe3[_0x165e04(0x16e)]),_0x3b2baf=new Date();_0x1921e8<_0x3b2baf?_0x398ac0=_0x165e04(0x193):_0x398ac0=_0x165e04(0x164);}else _0x398ac0=_0x165e04(0x164);}else _0x398ac0=_0x165e04(0x149);return{'status':_0x398ac0,'amount':_0x4bafe3[_0x165e04(0x13e)],'currency':_0x4bafe3[_0x165e04(0x139)],'isActive':_0x4bafe3[_0x165e04(0x14c)]};}catch(_0x5d3736){console['error'](_0x165e04(0x160),_0x5d3736),loggerService_1['loggerService'][_0x165e04(0x178)](_0x165e04(0x189),_0x165e04(0x142)+_0x233e87,_0x5d3736);throw new Error('Failed\x20to\x20verify\x20Noda\x20payment:\x20'+(_0x5d3736 instanceof Error?_0x5d3736[_0x165e04(0x18c)]:_0x165e04(0x171)));}}async[a43_0x2a0ca0(0x190)](_0x1400ec){const _0x67e18b=a43_0x2a0ca0;console[_0x67e18b(0x175)](_0x67e18b(0x172),_0x1400ec);let _0x1262d5='PENDING';switch(_0x1400ec[_0x67e18b(0x13a)]?.[_0x67e18b(0x15a)]()){case _0x67e18b(0x16d):case _0x67e18b(0x165):case _0x67e18b(0x152):case _0x67e18b(0x187):case _0x67e18b(0x133):_0x1400ec['Settled']===_0x67e18b(0x18e)?_0x1262d5=_0x67e18b(0x199):_0x1262d5='PENDING';break;case'cancelled':case _0x67e18b(0x14f):case'failed':case _0x67e18b(0x184):case _0x67e18b(0x140):_0x1262d5=_0x67e18b(0x164);break;case _0x67e18b(0x176):case _0x67e18b(0x135):_0x1262d5='EXPIRED';break;case _0x67e18b(0x16f):case'created':case _0x67e18b(0x138):case'processing':case'in_progress':default:_0x1262d5=_0x67e18b(0x149);break;}return{'paymentId':_0x1400ec[_0x67e18b(0x186)]||_0x1400ec['PaymentId'],'status':_0x1262d5,'amount':_0x1400ec[_0x67e18b(0x151)],'currency':_0x1400ec[_0x67e18b(0x17b)],'additionalInfo':{'method':_0x1400ec[_0x67e18b(0x18b)],'bankId':_0x1400ec['BankId'],'settled':_0x1400ec[_0x67e18b(0x153)],'settlementDate':_0x1400ec[_0x67e18b(0x183)],'remitterName':_0x1400ec['Remitter']?.[_0x67e18b(0x197)],'remitterIban':_0x1400ec['Remitter']?.[_0x67e18b(0x16b)],'bankTransactionId':_0x1400ec['BankTransactionId']}};}[a43_0x2a0ca0(0x195)](_0x3ff079,_0x30bbba){const _0x27789b=a43_0x2a0ca0;return console[_0x27789b(0x175)](_0x27789b(0x14e),{'receivedSignature':_0x30bbba,'paymentId':_0x3ff079[_0x27789b(0x177)],'merchantPaymentId':_0x3ff079[_0x27789b(0x186)]}),!![];}}exports['NodaService']=NodaService;