'use strict';const a40_0x1afdc7=a40_0x9279;function a40_0x111a(){const _0x157274=['TesSoft\x20Payment\x20System/1.0','Amount','Unknown\x20error\x20from\x20Noda\x20API','https://tesoft.uk/gateway/pending.php?id=','(8digits-8digits\x20format\x20for\x20Noda)','statusText','PaymentId','toUpperCase','stringify','parse','processWebhook','Status','message','65121lomBYp','Error\x20stack:','Noda\x20payment\x20verification\x20error:','apiUrl','pending','now','done','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','headers','stack','Yes','canceled','Order\x20ID\x20Format:','createPaymentLink',',\x20body:\x20','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','Business\x20Error:\x20','Noda\x20API\x20error:\x20','/payment-links','Raw\x20Response\x20Body:','EXPIRED','GET','paid','rejected','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','HTTP\x20Status:','logWhiteDomainError','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','Response\x20Time:','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','Request\x20Body\x20(Direct\x20JSON):','2710377rsOqHA','POST','logWhiteDomainRequest','entries','defineProperty','64RwtkGs','Noda\x20webhook\x20signature\x20verification:','BankId','Response\x20Body:','cancelled','HTTP\x20error!\x20status:\x20','Error\x20details:','URL:','Failed\x20to\x20parse\x20JSON\x20response:','verifyWebhookSignature','currency','application/json','JSON\x20Parse\x20Error:\x20','text','PAID','amount','Failed\x20to\x20verify\x20Noda\x20payment:\x20','SettlementDate','processing','Missing\x20id\x20or\x20shortLink\x20in\x20response','expired','toLowerCase','expiryDate','545544gpcTIV','created','307482ZRcaWX','https://tesoft.uk/gateway/noda/webhook/','QR\x20Code\x20Link:','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','Status\x20Text:','(8digits-8digits\x20format)','loggerService','Not\x20provided','fromEntries','active','296769ompxMZ','statusCode','Order\x20ID\x20Used:','PENDING','FAILED','log','Iban','__esModule','üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','successful','248Aksbsk','in_progress','qrCodeLink','shortLinkUrls','MerchantPaymentId','Status\x20Code:','logWhiteDomainResponse','===\x20PARSED\x20NODA\x20RESPONSE\x20===','===\x20NODA\x20SERVICE\x20ERROR\x20===','HTTP\x20','1253784gWlaRJ','https://tesoft.uk/gateway/noda/','status','52985ibPlxp','error','success','Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink','completed','NodaService','Method','Response\x20data:','Headers:','/payment-links/','noda','Unknown\x20error','shortLink','Settled'];a40_0x111a=function(){return _0x157274;};return a40_0x111a();}function a40_0x9279(_0x1b3f1a,_0x558a95){const _0x111a92=a40_0x111a();return a40_0x9279=function(_0x92799d,_0xf0075c){_0x92799d=_0x92799d-0x13c;let _0x3a2241=_0x111a92[_0x92799d];return _0x3a2241;},a40_0x9279(_0x1b3f1a,_0x558a95);}(function(_0x18f3e4,_0x4c6bda){const _0x5f0686=a40_0x9279,_0xebb8ee=_0x18f3e4();while(!![]){try{const _0x3b8abd=-parseInt(_0x5f0686(0x184))/0x1+parseInt(_0x5f0686(0x17a))/0x2+-parseInt(_0x5f0686(0x178))/0x3+parseInt(_0x5f0686(0x161))/0x4*(parseInt(_0x5f0686(0x19b))/0x5)+-parseInt(_0x5f0686(0x198))/0x6+parseInt(_0x5f0686(0x13d))/0x7*(parseInt(_0x5f0686(0x18e))/0x8)+parseInt(_0x5f0686(0x15c))/0x9;if(_0x3b8abd===_0x4c6bda)break;else _0xebb8ee['push'](_0xebb8ee['shift']());}catch(_0x36296a){_0xebb8ee['push'](_0xebb8ee['shift']());}}}(a40_0x111a,0x36fea));Object[a40_0x1afdc7(0x160)](exports,a40_0x1afdc7(0x18b),{'value':!![]}),exports[a40_0x1afdc7(0x1a0)]=void 0x0;const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0x27a16f=a40_0x1afdc7;this[_0x27a16f(0x140)]=_0x27a16f(0x199),console[_0x27a16f(0x189)](_0x27a16f(0x18c));}async[a40_0x1afdc7(0x14a)](_0x1c8cfb){const _0x32c087=a40_0x1afdc7,{orderId:_0x33072e,name:_0x200fed,paymentDescription:_0x53af51,amount:_0x14387f,currency:_0xf5ff32,webhookUrl:_0x2c6e80,returnUrl:_0x25ff50,expiryDate:_0x1647dd}=_0x1c8cfb,_0x35ee83=_0xf5ff32[_0x32c087(0x1b0)](),_0x43fe4a=_0x32c087(0x17b),_0x2f863a=_0x32c087(0x1ac)+_0x33072e,_0x202cc0={'name':_0x200fed,'paymentDescription':_0x53af51,'amount':_0x14387f,'currency':_0x35ee83,'paymentId':_0x33072e,'webhookUrl':_0x43fe4a,'returnUrl':_0x2f863a};_0x1647dd&&(_0x202cc0[_0x32c087(0x177)]=_0x1647dd);const _0x549b99=Date[_0x32c087(0x142)]();try{console['log']('===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20==='),console['log'](_0x32c087(0x168),this[_0x32c087(0x140)]),console[_0x32c087(0x189)](_0x32c087(0x15b),JSON[_0x32c087(0x1b1)](_0x202cc0,null,0x2)),console[_0x32c087(0x189)](_0x32c087(0x149),_0x33072e,_0x32c087(0x1ad)),console[_0x32c087(0x189)]('‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:',_0x2f863a),loggerService_1[_0x32c087(0x180)][_0x32c087(0x15e)]('noda','/payment-links',_0x32c087(0x15d),_0x202cc0);const _0x4a93e6=await fetch(this['apiUrl'],{'method':_0x32c087(0x15d),'headers':{'Content-Type':'application/json','Accept':_0x32c087(0x16c),'User-Agent':_0x32c087(0x1a9)},'body':JSON[_0x32c087(0x1b1)](_0x202cc0)}),_0x1385c1=Date['now']()-_0x549b99;console[_0x32c087(0x189)]('===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20==='),console[_0x32c087(0x189)]('Status:',_0x4a93e6[_0x32c087(0x19a)]),console[_0x32c087(0x189)](_0x32c087(0x17e),_0x4a93e6[_0x32c087(0x1ae)]),console[_0x32c087(0x189)](_0x32c087(0x1a3),Object[_0x32c087(0x182)](_0x4a93e6[_0x32c087(0x145)][_0x32c087(0x15f)]())),console[_0x32c087(0x189)](_0x32c087(0x159),_0x1385c1+'ms');const _0x4c6939=await _0x4a93e6[_0x32c087(0x16e)]();console[_0x32c087(0x189)](_0x32c087(0x150),_0x4c6939);if(!_0x4a93e6['ok']){console['error']('===\x20NODA\x20API\x20ERROR\x20==='),console[_0x32c087(0x19c)](_0x32c087(0x156),_0x4a93e6[_0x32c087(0x19a)]),console['error'](_0x32c087(0x164),_0x4c6939),loggerService_1[_0x32c087(0x180)][_0x32c087(0x194)](_0x32c087(0x1a5),'/payment-links',_0x4a93e6[_0x32c087(0x19a)],_0x4c6939,_0x1385c1),loggerService_1[_0x32c087(0x180)][_0x32c087(0x157)](_0x32c087(0x1a5),_0x32c087(0x14f),_0x32c087(0x197)+_0x4a93e6[_0x32c087(0x19a)]+':\x20'+_0x4c6939);if(_0x4a93e6[_0x32c087(0x19a)]===0x190)throw new Error(_0x32c087(0x15a));else{if(_0x4a93e6[_0x32c087(0x19a)]===0x1f4)throw new Error('All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid');}throw new Error(_0x32c087(0x166)+_0x4a93e6['status']+_0x32c087(0x14b)+_0x4c6939);}let _0x163761;try{_0x163761=JSON[_0x32c087(0x1b2)](_0x4c6939);}catch(_0x3eb5e6){console['error'](_0x32c087(0x169),_0x3eb5e6),loggerService_1[_0x32c087(0x180)][_0x32c087(0x157)]('noda',_0x32c087(0x14f),_0x32c087(0x16d)+_0x3eb5e6);throw new Error(_0x32c087(0x158)+_0x4c6939);}console[_0x32c087(0x189)](_0x32c087(0x195)),console['log']('Parsed\x20Result:',JSON['stringify'](_0x163761,null,0x2)),loggerService_1[_0x32c087(0x180)][_0x32c087(0x194)]('noda',_0x32c087(0x14f),_0x4a93e6['status'],_0x163761,_0x1385c1);if(_0x163761[_0x32c087(0x19c)]||_0x163761[_0x32c087(0x185)]){const _0x37a496=_0x163761['message']||_0x163761[_0x32c087(0x19c)]||_0x32c087(0x1ab);console[_0x32c087(0x19c)](_0x32c087(0x14c)),console[_0x32c087(0x19c)]('Error\x20Message:',_0x37a496),console[_0x32c087(0x19c)](_0x32c087(0x193),_0x163761[_0x32c087(0x185)]),loggerService_1[_0x32c087(0x180)][_0x32c087(0x157)](_0x32c087(0x1a5),_0x32c087(0x14f),_0x32c087(0x14d)+_0x37a496);throw new Error(_0x32c087(0x14e)+_0x37a496);}if(!_0x163761['id']||!_0x163761[_0x32c087(0x191)]?.[_0x32c087(0x1a7)]){console[_0x32c087(0x19c)]('===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x32c087(0x19c)](_0x32c087(0x174)),console[_0x32c087(0x19c)](_0x32c087(0x1a2),_0x163761),loggerService_1[_0x32c087(0x180)]['logWhiteDomainError'](_0x32c087(0x1a5),_0x32c087(0x14f),_0x32c087(0x155));throw new Error(_0x32c087(0x19e));}return console[_0x32c087(0x189)]('===\x20NODA\x20SUCCESS\x20==='),console[_0x32c087(0x189)]('Payment\x20Link\x20ID:',_0x163761['id']),console[_0x32c087(0x189)]('Short\x20Link:',_0x163761[_0x32c087(0x191)][_0x32c087(0x1a7)]),console['log'](_0x32c087(0x17c),_0x163761[_0x32c087(0x191)][_0x32c087(0x190)]||_0x32c087(0x181)),console[_0x32c087(0x189)](_0x32c087(0x186),_0x33072e,_0x32c087(0x17f)),console[_0x32c087(0x189)](_0x32c087(0x144),_0x2f863a),{'gateway_payment_id':_0x163761['id'],'payment_url':_0x163761['shortLinkUrls'][_0x32c087(0x1a7)],'qr_code_url':_0x163761[_0x32c087(0x191)][_0x32c087(0x190)],'expiry_date':_0x163761['expiryDate']};}catch(_0xa3b456){console[_0x32c087(0x19c)](_0x32c087(0x196)),console[_0x32c087(0x19c)](_0x32c087(0x167),_0xa3b456),loggerService_1[_0x32c087(0x180)]['logWhiteDomainError']('noda',_0x32c087(0x14f),_0xa3b456);if(_0xa3b456 instanceof Error){console[_0x32c087(0x19c)]('Error\x20message:',_0xa3b456[_0x32c087(0x13c)]),console['error'](_0x32c087(0x13e),_0xa3b456[_0x32c087(0x146)]);throw new Error(_0x32c087(0x17d)+_0xa3b456['message']);}throw new Error('Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error');}}async['verifyPayment'](_0x43c361){const _0xc5ac91=a40_0x1afdc7,_0x310d14=Date[_0xc5ac91(0x142)]();try{loggerService_1['loggerService'][_0xc5ac91(0x15e)](_0xc5ac91(0x1a5),_0xc5ac91(0x1a4)+_0x43c361,_0xc5ac91(0x152),{});const _0x37d35d=await fetch(this[_0xc5ac91(0x140)]+'/'+_0x43c361,{'method':_0xc5ac91(0x152),'headers':{'Content-Type':_0xc5ac91(0x16c),'User-Agent':_0xc5ac91(0x1a9)}}),_0x200faa=Date[_0xc5ac91(0x142)]()-_0x310d14;if(!_0x37d35d['ok']){const _0xab055=await _0x37d35d[_0xc5ac91(0x16e)]();loggerService_1[_0xc5ac91(0x180)]['logWhiteDomainResponse'](_0xc5ac91(0x1a5),_0xc5ac91(0x1a4)+_0x43c361,_0x37d35d[_0xc5ac91(0x19a)],_0xab055,_0x200faa);throw new Error(_0xc5ac91(0x166)+_0x37d35d[_0xc5ac91(0x19a)]);}const _0x5db812=await _0x37d35d['json']();loggerService_1['loggerService']['logWhiteDomainResponse'](_0xc5ac91(0x1a5),_0xc5ac91(0x1a4)+_0x43c361,_0x37d35d[_0xc5ac91(0x19a)],_0x5db812,_0x200faa);if(_0x5db812[_0xc5ac91(0x19c)]||_0x5db812['statusCode']){loggerService_1[_0xc5ac91(0x180)]['logWhiteDomainError']('noda',_0xc5ac91(0x1a4)+_0x43c361,'Noda\x20API\x20error:\x20'+(_0x5db812['message']||_0x5db812[_0xc5ac91(0x19c)]||'Unknown\x20error'));throw new Error(_0xc5ac91(0x14e)+(_0x5db812[_0xc5ac91(0x13c)]||_0x5db812[_0xc5ac91(0x19c)]||_0xc5ac91(0x1a6)));}let _0x44180d=_0xc5ac91(0x187);if(_0x5db812['isActive']===![]){if(_0x5db812[_0xc5ac91(0x177)]){const _0x39f35f=new Date(_0x5db812['expiryDate']),_0x13ae55=new Date();_0x39f35f<_0x13ae55?_0x44180d=_0xc5ac91(0x151):_0x44180d=_0xc5ac91(0x188);}else _0x44180d=_0xc5ac91(0x188);}else _0x44180d=_0xc5ac91(0x187);return{'status':_0x44180d,'amount':_0x5db812[_0xc5ac91(0x170)],'currency':_0x5db812[_0xc5ac91(0x16b)],'isActive':_0x5db812['isActive']};}catch(_0xeb66b2){console[_0xc5ac91(0x19c)](_0xc5ac91(0x13f),_0xeb66b2),loggerService_1[_0xc5ac91(0x180)][_0xc5ac91(0x157)](_0xc5ac91(0x1a5),_0xc5ac91(0x1a4)+_0x43c361,_0xeb66b2);throw new Error(_0xc5ac91(0x171)+(_0xeb66b2 instanceof Error?_0xeb66b2[_0xc5ac91(0x13c)]:_0xc5ac91(0x1a6)));}}async[a40_0x1afdc7(0x1b3)](_0x1265e6){const _0x356a85=a40_0x1afdc7;console[_0x356a85(0x189)]('Processing\x20Noda\x20webhook:',_0x1265e6);let _0x49b621=_0x356a85(0x187);switch(_0x1265e6[_0x356a85(0x1b4)]?.[_0x356a85(0x176)]()){case _0x356a85(0x143):case _0x356a85(0x19f):case _0x356a85(0x153):case _0x356a85(0x19d):case _0x356a85(0x18d):_0x1265e6['Settled']===_0x356a85(0x147)?_0x49b621=_0x356a85(0x16f):_0x49b621='PENDING';break;case _0x356a85(0x165):case _0x356a85(0x148):case'failed':case _0x356a85(0x19c):case _0x356a85(0x154):_0x49b621=_0x356a85(0x188);break;case _0x356a85(0x175):case'timeout':_0x49b621=_0x356a85(0x151);break;case _0x356a85(0x141):case _0x356a85(0x179):case _0x356a85(0x183):case _0x356a85(0x173):case _0x356a85(0x18f):default:_0x49b621='PENDING';break;}return{'paymentId':_0x1265e6[_0x356a85(0x192)]||_0x1265e6['PaymentId'],'status':_0x49b621,'amount':_0x1265e6[_0x356a85(0x1aa)],'currency':_0x1265e6['Currency'],'additionalInfo':{'method':_0x1265e6[_0x356a85(0x1a1)],'bankId':_0x1265e6[_0x356a85(0x163)],'settled':_0x1265e6[_0x356a85(0x1a8)],'settlementDate':_0x1265e6[_0x356a85(0x172)],'remitterName':_0x1265e6['Remitter']?.['Name'],'remitterIban':_0x1265e6['Remitter']?.[_0x356a85(0x18a)],'bankTransactionId':_0x1265e6['BankTransactionId']}};}[a40_0x1afdc7(0x16a)](_0x513356,_0x327876){const _0x3f20c0=a40_0x1afdc7;return console[_0x3f20c0(0x189)](_0x3f20c0(0x162),{'receivedSignature':_0x327876,'paymentId':_0x513356[_0x3f20c0(0x1af)],'merchantPaymentId':_0x513356['MerchantPaymentId']}),!![];}}exports[a40_0x1afdc7(0x1a0)]=NodaService;