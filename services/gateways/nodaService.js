'use strict';function a50_0xd22c(){const _0x510de0=['/payment-links/','status','14880150slXAZS','apiUrl','Status\x20Text:','4969170igMWAg','fromEntries','toUpperCase','verifyWebhookSignature','stack','application/json','MerchantPaymentId','statusCode','Payment\x20Link\x20ID:','Noda\x20payment\x20verification\x20error:','shortLinkUrls',',\x20body:\x20','noda','Parsed\x20Result:','URL:','log','message','13AYCaXG','(8digits-8digits\x20format)','Error\x20message:','success','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','createPaymentLink','active','currency','Settled','Unknown\x20error','38886aoFaLa','Payment\x20System/1.0','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','processing','https://tesoft.uk/gateway/noda/webhook/','https://tesoft.uk/gateway/noda/','360687nEapYm','Error\x20Message:','Failed\x20to\x20parse\x20JSON\x20response:','in_progress','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','GET','Status:','18TKSCmV','16137JUaiBv','logWhiteDomainResponse','BankTransactionId','logWhiteDomainError','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','2761388pLqnkN','HTTP\x20','Noda\x20API\x20error:\x20','canceled','loggerService','Business\x20Error:\x20','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','===\x20NODA\x20API\x20ERROR\x20===','https://tesoft.uk/gateway/pending.php?id=','Order\x20ID\x20Format:','Noda\x20webhook\x20signature\x20verification:','text','3648gQcTrO','isActive','POST','JSON\x20Parse\x20Error:\x20','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','successful','FAILED','Currency','now','SettlementDate','stringify','created','error','pending','PENDING','BankId','logWhiteDomainRequest','failed','PaymentId','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','statusText','PAID','===\x20NODA\x20SERVICE\x20ERROR\x20===','Unknown\x20error\x20from\x20Noda\x20API','Name','Iban','Order\x20ID\x20Used:','__esModule','Missing\x20id\x20or\x20shortLink\x20in\x20response','Yes','cancelled','rejected','Raw\x20Response\x20Body:','completed','Status\x20Code:','üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','parse','===\x20PARSED\x20NODA\x20RESPONSE\x20===','amount','QR\x20Code\x20Link:','HTTP\x20error!\x20status:\x20','Response\x20data:','toLowerCase','shortLink','defineProperty','EXPIRED','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','Error\x20details:','2469740dypfHP','Request\x20Body\x20(Direct\x20JSON):','/payment-links','Remitter','===\x20NODA\x20SUCCESS\x20===','Method','done','processWebhook','Response\x20Body:','qrCodeLink','Failed\x20to\x20verify\x20Noda\x20payment:\x20','expiryDate'];a50_0xd22c=function(){return _0x510de0;};return a50_0xd22c();}const a50_0x3c15c8=a50_0x9020;(function(_0x53f34a,_0x455fab){const _0xd2b5f8=a50_0x9020,_0x4d9181=_0x53f34a();while(!![]){try{const _0xe65284=parseInt(_0xd2b5f8(0x199))/0x1*(parseInt(_0xd2b5f8(0x1a3))/0x2)+parseInt(_0xd2b5f8(0x12d))/0x3+-parseInt(_0xd2b5f8(0x177))/0x4+-parseInt(_0xd2b5f8(0x188))/0x5+-parseInt(_0xd2b5f8(0x135))/0x6*(-parseInt(_0xd2b5f8(0x13b))/0x7)+-parseInt(_0xd2b5f8(0x147))/0x8*(parseInt(_0xd2b5f8(0x136))/0x9)+parseInt(_0xd2b5f8(0x185))/0xa;if(_0xe65284===_0x455fab)break;else _0x4d9181['push'](_0x4d9181['shift']());}catch(_0x4c1b0d){_0x4d9181['push'](_0x4d9181['shift']());}}}(a50_0xd22c,0x9649a));function a50_0x9020(_0x4a0129,_0x5c27e7){const _0xd22cda=a50_0xd22c();return a50_0x9020=function(_0x902029,_0x37bc75){_0x902029=_0x902029-0x12b;let _0x1b69a1=_0xd22cda[_0x902029];return _0x1b69a1;},a50_0x9020(_0x4a0129,_0x5c27e7);}Object[a50_0x3c15c8(0x173)](exports,a50_0x3c15c8(0x162),{'value':!![]}),exports['NodaService']=void 0x0;const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0x386290=a50_0x3c15c8;this['apiUrl']=_0x386290(0x12c),console[_0x386290(0x197)](_0x386290(0x16a));}async[a50_0x3c15c8(0x19e)](_0x2185be){const _0x53a915=a50_0x3c15c8,{orderId:_0x24adbc,name:_0x4086af,paymentDescription:_0x2c4934,amount:_0x25d186,currency:_0x3470e3,webhookUrl:_0x4f7841,returnUrl:_0x3326c4,expiryDate:_0x1544d7}=_0x2185be,_0x208d77=_0x3470e3[_0x53a915(0x18a)](),_0x3b489f=_0x53a915(0x12b),_0x4c6c1a=_0x53a915(0x143)+_0x24adbc,_0x45471f={'name':_0x4086af,'paymentDescription':_0x2c4934,'amount':_0x25d186,'currency':_0x208d77,'paymentId':_0x24adbc,'webhookUrl':_0x3b489f,'returnUrl':_0x4c6c1a};_0x1544d7&&(_0x45471f[_0x53a915(0x182)]=_0x1544d7);const _0x14110a=Date['now']();try{console['log']('===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20==='),console[_0x53a915(0x197)](_0x53a915(0x196),this[_0x53a915(0x186)]),console[_0x53a915(0x197)](_0x53a915(0x178),JSON[_0x53a915(0x151)](_0x45471f,null,0x2)),console[_0x53a915(0x197)](_0x53a915(0x144),_0x24adbc,'(8digits-8digits\x20format\x20for\x20Noda)'),console[_0x53a915(0x197)]('‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:',_0x4c6c1a),loggerService_1[_0x53a915(0x13f)][_0x53a915(0x157)]('noda',_0x53a915(0x179),_0x53a915(0x149),_0x45471f);const _0x2bac8d=await fetch(this[_0x53a915(0x186)],{'method':_0x53a915(0x149),'headers':{'Content-Type':_0x53a915(0x18d),'Accept':_0x53a915(0x18d),'User-Agent':_0x53a915(0x1a4)},'body':JSON[_0x53a915(0x151)](_0x45471f)}),_0x376673=Date[_0x53a915(0x14f)]()-_0x14110a;console[_0x53a915(0x197)](_0x53a915(0x131)),console[_0x53a915(0x197)](_0x53a915(0x134),_0x2bac8d[_0x53a915(0x184)]),console[_0x53a915(0x197)](_0x53a915(0x187),_0x2bac8d[_0x53a915(0x15b)]),console[_0x53a915(0x197)]('Headers:',Object[_0x53a915(0x189)](_0x2bac8d['headers']['entries']())),console[_0x53a915(0x197)]('Response\x20Time:',_0x376673+'ms');const _0x445777=await _0x2bac8d[_0x53a915(0x146)]();console[_0x53a915(0x197)](_0x53a915(0x167),_0x445777);if(!_0x2bac8d['ok']){console[_0x53a915(0x153)](_0x53a915(0x142)),console[_0x53a915(0x153)]('HTTP\x20Status:',_0x2bac8d['status']),console[_0x53a915(0x153)](_0x53a915(0x17f),_0x445777),loggerService_1['loggerService'][_0x53a915(0x137)](_0x53a915(0x194),_0x53a915(0x179),_0x2bac8d[_0x53a915(0x184)],_0x445777,_0x376673),loggerService_1[_0x53a915(0x13f)][_0x53a915(0x139)](_0x53a915(0x194),_0x53a915(0x179),_0x53a915(0x13c)+_0x2bac8d[_0x53a915(0x184)]+':\x20'+_0x445777);if(_0x2bac8d[_0x53a915(0x184)]===0x190)throw new Error(_0x53a915(0x14b));else{if(_0x2bac8d['status']===0x1f4)throw new Error('All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid');}throw new Error('HTTP\x20error!\x20status:\x20'+_0x2bac8d[_0x53a915(0x184)]+_0x53a915(0x193)+_0x445777);}let _0x2ea6b7;try{_0x2ea6b7=JSON[_0x53a915(0x16b)](_0x445777);}catch(_0x44a930){console['error'](_0x53a915(0x12f),_0x44a930),loggerService_1[_0x53a915(0x13f)][_0x53a915(0x139)]('noda',_0x53a915(0x179),_0x53a915(0x14a)+_0x44a930);throw new Error(_0x53a915(0x141)+_0x445777);}console[_0x53a915(0x197)](_0x53a915(0x16c)),console[_0x53a915(0x197)](_0x53a915(0x195),JSON[_0x53a915(0x151)](_0x2ea6b7,null,0x2)),loggerService_1[_0x53a915(0x13f)][_0x53a915(0x137)](_0x53a915(0x194),_0x53a915(0x179),_0x2bac8d[_0x53a915(0x184)],_0x2ea6b7,_0x376673);if(_0x2ea6b7[_0x53a915(0x153)]||_0x2ea6b7[_0x53a915(0x18f)]){const _0x8c7114=_0x2ea6b7[_0x53a915(0x198)]||_0x2ea6b7[_0x53a915(0x153)]||_0x53a915(0x15e);console['error'](_0x53a915(0x19d)),console[_0x53a915(0x153)](_0x53a915(0x12e),_0x8c7114),console[_0x53a915(0x153)](_0x53a915(0x169),_0x2ea6b7['statusCode']),loggerService_1['loggerService'][_0x53a915(0x139)](_0x53a915(0x194),_0x53a915(0x179),_0x53a915(0x140)+_0x8c7114);throw new Error('Noda\x20API\x20error:\x20'+_0x8c7114);}if(!_0x2ea6b7['id']||!_0x2ea6b7[_0x53a915(0x192)]?.[_0x53a915(0x172)]){console['error'](_0x53a915(0x15a)),console[_0x53a915(0x153)](_0x53a915(0x163)),console['error'](_0x53a915(0x170),_0x2ea6b7),loggerService_1[_0x53a915(0x13f)][_0x53a915(0x139)](_0x53a915(0x194),_0x53a915(0x179),_0x53a915(0x1a5));throw new Error('Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink');}return console[_0x53a915(0x197)](_0x53a915(0x17b)),console[_0x53a915(0x197)](_0x53a915(0x190),_0x2ea6b7['id']),console['log']('Short\x20Link:',_0x2ea6b7[_0x53a915(0x192)][_0x53a915(0x172)]),console[_0x53a915(0x197)](_0x53a915(0x16e),_0x2ea6b7[_0x53a915(0x192)][_0x53a915(0x180)]||'Not\x20provided'),console['log'](_0x53a915(0x161),_0x24adbc,_0x53a915(0x19a)),console[_0x53a915(0x197)](_0x53a915(0x175),_0x4c6c1a),{'gateway_payment_id':_0x2ea6b7['id'],'payment_url':_0x2ea6b7['shortLinkUrls'][_0x53a915(0x172)],'qr_code_url':_0x2ea6b7[_0x53a915(0x192)][_0x53a915(0x180)],'expiry_date':_0x2ea6b7[_0x53a915(0x182)]};}catch(_0x1e2dfd){console['error'](_0x53a915(0x15d)),console[_0x53a915(0x153)](_0x53a915(0x176),_0x1e2dfd),loggerService_1[_0x53a915(0x13f)]['logWhiteDomainError'](_0x53a915(0x194),_0x53a915(0x179),_0x1e2dfd);if(_0x1e2dfd instanceof Error){console['error'](_0x53a915(0x19b),_0x1e2dfd[_0x53a915(0x198)]),console[_0x53a915(0x153)]('Error\x20stack:',_0x1e2dfd[_0x53a915(0x18c)]);throw new Error(_0x53a915(0x132)+_0x1e2dfd[_0x53a915(0x198)]);}throw new Error(_0x53a915(0x13a));}}async['verifyPayment'](_0x3a100a){const _0xc00a6f=a50_0x3c15c8,_0x374b44=Date[_0xc00a6f(0x14f)]();try{loggerService_1['loggerService'][_0xc00a6f(0x157)]('noda',_0xc00a6f(0x183)+_0x3a100a,_0xc00a6f(0x133),{});const _0x2a716a=await fetch(this[_0xc00a6f(0x186)]+'/'+_0x3a100a,{'method':_0xc00a6f(0x133),'headers':{'Content-Type':_0xc00a6f(0x18d),'User-Agent':'Payment\x20System/1.0'}}),_0x258c9f=Date[_0xc00a6f(0x14f)]()-_0x374b44;if(!_0x2a716a['ok']){const _0x4bea29=await _0x2a716a['text']();loggerService_1[_0xc00a6f(0x13f)][_0xc00a6f(0x137)](_0xc00a6f(0x194),'/payment-links/'+_0x3a100a,_0x2a716a['status'],_0x4bea29,_0x258c9f);throw new Error(_0xc00a6f(0x16f)+_0x2a716a[_0xc00a6f(0x184)]);}const _0x5747d7=await _0x2a716a['json']();loggerService_1['loggerService'][_0xc00a6f(0x137)](_0xc00a6f(0x194),'/payment-links/'+_0x3a100a,_0x2a716a['status'],_0x5747d7,_0x258c9f);if(_0x5747d7[_0xc00a6f(0x153)]||_0x5747d7['statusCode']){loggerService_1[_0xc00a6f(0x13f)][_0xc00a6f(0x139)](_0xc00a6f(0x194),_0xc00a6f(0x183)+_0x3a100a,_0xc00a6f(0x13d)+(_0x5747d7['message']||_0x5747d7['error']||'Unknown\x20error'));throw new Error('Noda\x20API\x20error:\x20'+(_0x5747d7[_0xc00a6f(0x198)]||_0x5747d7[_0xc00a6f(0x153)]||_0xc00a6f(0x1a2)));}let _0x506c21=_0xc00a6f(0x155);if(_0x5747d7['isActive']===![]){if(_0x5747d7[_0xc00a6f(0x182)]){const _0x1daac8=new Date(_0x5747d7[_0xc00a6f(0x182)]),_0x1a5522=new Date();_0x1daac8<_0x1a5522?_0x506c21=_0xc00a6f(0x174):_0x506c21='FAILED';}else _0x506c21='FAILED';}else _0x506c21=_0xc00a6f(0x155);return{'status':_0x506c21,'amount':_0x5747d7[_0xc00a6f(0x16d)],'currency':_0x5747d7[_0xc00a6f(0x1a0)],'isActive':_0x5747d7[_0xc00a6f(0x148)]};}catch(_0x356698){console['error'](_0xc00a6f(0x191),_0x356698),loggerService_1['loggerService']['logWhiteDomainError'](_0xc00a6f(0x194),_0xc00a6f(0x183)+_0x3a100a,_0x356698);throw new Error(_0xc00a6f(0x181)+(_0x356698 instanceof Error?_0x356698[_0xc00a6f(0x198)]:'Unknown\x20error'));}}async[a50_0x3c15c8(0x17e)](_0x376f79){const _0x4f2f16=a50_0x3c15c8;console[_0x4f2f16(0x197)]('Processing\x20Noda\x20webhook:',_0x376f79);let _0x40c921='PENDING';switch(_0x376f79['Status']?.[_0x4f2f16(0x171)]()){case _0x4f2f16(0x17d):case _0x4f2f16(0x168):case'paid':case _0x4f2f16(0x19c):case _0x4f2f16(0x14c):_0x376f79[_0x4f2f16(0x1a1)]===_0x4f2f16(0x164)?_0x40c921=_0x4f2f16(0x15c):_0x40c921=_0x4f2f16(0x155);break;case _0x4f2f16(0x165):case _0x4f2f16(0x13e):case _0x4f2f16(0x158):case _0x4f2f16(0x153):case _0x4f2f16(0x166):_0x40c921=_0x4f2f16(0x14d);break;case'expired':case'timeout':_0x40c921=_0x4f2f16(0x174);break;case _0x4f2f16(0x154):case _0x4f2f16(0x152):case _0x4f2f16(0x19f):case _0x4f2f16(0x1a6):case _0x4f2f16(0x130):default:_0x40c921=_0x4f2f16(0x155);break;}return{'paymentId':_0x376f79['MerchantPaymentId']||_0x376f79[_0x4f2f16(0x159)],'status':_0x40c921,'amount':_0x376f79['Amount'],'currency':_0x376f79[_0x4f2f16(0x14e)],'additionalInfo':{'method':_0x376f79[_0x4f2f16(0x17c)],'bankId':_0x376f79[_0x4f2f16(0x156)],'settled':_0x376f79[_0x4f2f16(0x1a1)],'settlementDate':_0x376f79[_0x4f2f16(0x150)],'remitterName':_0x376f79[_0x4f2f16(0x17a)]?.[_0x4f2f16(0x15f)],'remitterIban':_0x376f79[_0x4f2f16(0x17a)]?.[_0x4f2f16(0x160)],'bankTransactionId':_0x376f79[_0x4f2f16(0x138)]}};}[a50_0x3c15c8(0x18b)](_0xfaec57,_0x176143){const _0x53183a=a50_0x3c15c8;return console[_0x53183a(0x197)](_0x53183a(0x145),{'receivedSignature':_0x176143,'paymentId':_0xfaec57[_0x53183a(0x159)],'merchantPaymentId':_0xfaec57[_0x53183a(0x18e)]}),!![];}}exports['NodaService']=NodaService;