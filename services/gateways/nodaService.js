'use strict';const a40_0x545327=a40_0x52f6;(function(_0x140000,_0x437e6f){const _0x447a2d=a40_0x52f6,_0x523aa4=_0x140000();while(!![]){try{const _0x46d676=parseInt(_0x447a2d(0x13f))/0x1*(parseInt(_0x447a2d(0x167))/0x2)+-parseInt(_0x447a2d(0x15b))/0x3+-parseInt(_0x447a2d(0x12a))/0x4+parseInt(_0x447a2d(0x11f))/0x5+parseInt(_0x447a2d(0x152))/0x6*(parseInt(_0x447a2d(0x165))/0x7)+-parseInt(_0x447a2d(0x129))/0x8+-parseInt(_0x447a2d(0x14b))/0x9;if(_0x46d676===_0x437e6f)break;else _0x523aa4['push'](_0x523aa4['shift']());}catch(_0x559964){_0x523aa4['push'](_0x523aa4['shift']());}}}(a40_0x4ae4,0x28cdd));Object[a40_0x545327(0x164)](exports,a40_0x545327(0x128),{'value':!![]}),exports['NodaService']=void 0x0;function a40_0x52f6(_0x1d65e0,_0x22fee2){const _0x4ae442=a40_0x4ae4();return a40_0x52f6=function(_0x52f6f9,_0x594bd2){_0x52f6f9=_0x52f6f9-0xfb;let _0x1e95b0=_0x4ae442[_0x52f6f9];return _0x1e95b0;},a40_0x52f6(_0x1d65e0,_0x22fee2);}const loggerService_1=require(a40_0x545327(0x14c));class NodaService{constructor(){const _0x44ad17=a40_0x545327;this['apiUrl']=_0x44ad17(0x10a),console[_0x44ad17(0x120)](_0x44ad17(0x107));}async[a40_0x545327(0x12b)](_0x521548){const _0x27a0e9=a40_0x545327,{orderId:_0x3a2f96,name:_0x3968a7,paymentDescription:_0x5de60f,amount:_0x2311f3,currency:_0x37e2a4,webhookUrl:_0x41a353,returnUrl:_0x40521d,expiryDate:_0x1417e0}=_0x521548,_0x588f61=_0x37e2a4[_0x27a0e9(0x16d)](),_0x53519b='https://tesoft.uk/gateway/noda/webhook/',_0x56d65d='https://tesoft.uk/gateway/success.php?id='+_0x3a2f96,_0x4649a0={'name':_0x3968a7,'paymentDescription':_0x5de60f,'amount':_0x2311f3,'currency':_0x588f61,'paymentId':_0x3a2f96,'webhookUrl':_0x53519b,'returnUrl':_0x56d65d};_0x1417e0&&(_0x4649a0[_0x27a0e9(0x155)]=_0x1417e0);const _0x1e1293=Date[_0x27a0e9(0x127)]();try{console[_0x27a0e9(0x120)]('===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20==='),console['log'](_0x27a0e9(0x15d),this[_0x27a0e9(0x117)]),console['log']('Request\x20Body\x20(Direct\x20JSON):',JSON['stringify'](_0x4649a0,null,0x2)),console[_0x27a0e9(0x120)](_0x27a0e9(0x113),_0x3a2f96,'(8digits-8digits\x20format\x20for\x20Noda)'),loggerService_1[_0x27a0e9(0x148)][_0x27a0e9(0xff)]('noda',_0x27a0e9(0x11d),'POST',_0x4649a0);const _0x24dc18=await fetch(this[_0x27a0e9(0x117)],{'method':_0x27a0e9(0x143),'headers':{'Content-Type':_0x27a0e9(0x10d),'Accept':'application/json','User-Agent':_0x27a0e9(0xfc)},'body':JSON[_0x27a0e9(0x16b)](_0x4649a0)}),_0x24a395=Date['now']()-_0x1e1293;console[_0x27a0e9(0x120)](_0x27a0e9(0x151)),console[_0x27a0e9(0x120)](_0x27a0e9(0x103),_0x24dc18[_0x27a0e9(0x160)]),console[_0x27a0e9(0x120)](_0x27a0e9(0x158),_0x24dc18[_0x27a0e9(0x15f)]),console['log']('Headers:',Object[_0x27a0e9(0x116)](_0x24dc18[_0x27a0e9(0x169)][_0x27a0e9(0x145)]())),console[_0x27a0e9(0x120)]('Response\x20Time:',_0x24a395+'ms');const _0x225878=await _0x24dc18[_0x27a0e9(0x153)]();console[_0x27a0e9(0x120)](_0x27a0e9(0x142),_0x225878);if(!_0x24dc18['ok']){console[_0x27a0e9(0x10f)](_0x27a0e9(0x11c)),console[_0x27a0e9(0x10f)]('HTTP\x20Status:',_0x24dc18[_0x27a0e9(0x160)]),console[_0x27a0e9(0x10f)](_0x27a0e9(0x162),_0x225878),loggerService_1[_0x27a0e9(0x148)]['logWhiteDomainResponse'](_0x27a0e9(0x11a),_0x27a0e9(0x11d),_0x24dc18[_0x27a0e9(0x160)],_0x225878,_0x24a395),loggerService_1['loggerService'][_0x27a0e9(0x100)](_0x27a0e9(0x11a),_0x27a0e9(0x11d),_0x27a0e9(0x12c)+_0x24dc18[_0x27a0e9(0x160)]+':\x20'+_0x225878);if(_0x24dc18['status']===0x190)throw new Error(_0x27a0e9(0x14d));else{if(_0x24dc18[_0x27a0e9(0x160)]===0x1f4)throw new Error('All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid');}throw new Error('HTTP\x20error!\x20status:\x20'+_0x24dc18[_0x27a0e9(0x160)]+_0x27a0e9(0xfd)+_0x225878);}let _0x3b42e4;try{_0x3b42e4=JSON[_0x27a0e9(0x146)](_0x225878);}catch(_0x17f997){console[_0x27a0e9(0x10f)](_0x27a0e9(0x15e),_0x17f997),loggerService_1['loggerService']['logWhiteDomainError'](_0x27a0e9(0x11a),'/payment-links','JSON\x20Parse\x20Error:\x20'+_0x17f997);throw new Error('Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20'+_0x225878);}console[_0x27a0e9(0x120)]('===\x20PARSED\x20NODA\x20RESPONSE\x20==='),console[_0x27a0e9(0x120)](_0x27a0e9(0x136),JSON[_0x27a0e9(0x16b)](_0x3b42e4,null,0x2)),loggerService_1[_0x27a0e9(0x148)]['logWhiteDomainResponse']('noda',_0x27a0e9(0x11d),_0x24dc18[_0x27a0e9(0x160)],_0x3b42e4,_0x24a395);if(_0x3b42e4[_0x27a0e9(0x10f)]||_0x3b42e4['statusCode']){const _0x490e2c=_0x3b42e4[_0x27a0e9(0x137)]||_0x3b42e4['error']||'Unknown\x20error\x20from\x20Noda\x20API';console[_0x27a0e9(0x10f)](_0x27a0e9(0x10c)),console[_0x27a0e9(0x10f)](_0x27a0e9(0x108),_0x490e2c),console[_0x27a0e9(0x10f)](_0x27a0e9(0x11b),_0x3b42e4[_0x27a0e9(0x126)]),loggerService_1[_0x27a0e9(0x148)][_0x27a0e9(0x100)](_0x27a0e9(0x11a),_0x27a0e9(0x11d),'Business\x20Error:\x20'+_0x490e2c);throw new Error(_0x27a0e9(0x133)+_0x490e2c);}if(!_0x3b42e4['id']||!_0x3b42e4[_0x27a0e9(0x139)]?.[_0x27a0e9(0x131)]){console[_0x27a0e9(0x10f)](_0x27a0e9(0x125)),console[_0x27a0e9(0x10f)](_0x27a0e9(0x154)),console['error'](_0x27a0e9(0x141),_0x3b42e4),loggerService_1[_0x27a0e9(0x148)][_0x27a0e9(0x100)](_0x27a0e9(0x11a),_0x27a0e9(0x11d),_0x27a0e9(0xfb));throw new Error(_0x27a0e9(0x119));}return console['log'](_0x27a0e9(0xfe)),console[_0x27a0e9(0x120)]('Payment\x20Link\x20ID:',_0x3b42e4['id']),console['log'](_0x27a0e9(0x16a),_0x3b42e4[_0x27a0e9(0x139)]['shortLink']),console['log'](_0x27a0e9(0x157),_0x3b42e4[_0x27a0e9(0x139)]['qrCodeLink']||_0x27a0e9(0x134)),console['log'](_0x27a0e9(0x122),_0x3a2f96,'(8digits-8digits\x20format)'),{'gateway_payment_id':_0x3b42e4['id'],'payment_url':_0x3b42e4[_0x27a0e9(0x139)][_0x27a0e9(0x131)],'qr_code_url':_0x3b42e4[_0x27a0e9(0x139)]['qrCodeLink'],'expiry_date':_0x3b42e4[_0x27a0e9(0x155)]};}catch(_0x2fde9a){console[_0x27a0e9(0x10f)](_0x27a0e9(0x130)),console['error'](_0x27a0e9(0x161),_0x2fde9a),loggerService_1[_0x27a0e9(0x148)][_0x27a0e9(0x100)](_0x27a0e9(0x11a),_0x27a0e9(0x11d),_0x2fde9a);if(_0x2fde9a instanceof Error){console[_0x27a0e9(0x10f)](_0x27a0e9(0x16c),_0x2fde9a['message']),console['error'](_0x27a0e9(0x140),_0x2fde9a[_0x27a0e9(0x150)]);throw new Error(_0x27a0e9(0x156)+_0x2fde9a[_0x27a0e9(0x137)]);}throw new Error(_0x27a0e9(0x109));}}async[a40_0x545327(0x15c)](_0x43b920){const _0x228862=a40_0x545327,_0x3591bc=Date[_0x228862(0x127)]();try{loggerService_1['loggerService'][_0x228862(0xff)](_0x228862(0x11a),_0x228862(0x132)+_0x43b920,_0x228862(0x124),{});const _0x38e6fc=await fetch(this[_0x228862(0x117)]+'/'+_0x43b920,{'method':'GET','headers':{'Content-Type':_0x228862(0x10d),'User-Agent':_0x228862(0xfc)}}),_0x4880e0=Date[_0x228862(0x127)]()-_0x3591bc;if(!_0x38e6fc['ok']){const _0x290429=await _0x38e6fc[_0x228862(0x153)]();loggerService_1[_0x228862(0x148)][_0x228862(0x14a)]('noda','/payment-links/'+_0x43b920,_0x38e6fc['status'],_0x290429,_0x4880e0);throw new Error(_0x228862(0x12f)+_0x38e6fc[_0x228862(0x160)]);}const _0x473238=await _0x38e6fc[_0x228862(0x10e)]();loggerService_1[_0x228862(0x148)][_0x228862(0x14a)](_0x228862(0x11a),_0x228862(0x132)+_0x43b920,_0x38e6fc[_0x228862(0x160)],_0x473238,_0x4880e0);if(_0x473238[_0x228862(0x10f)]||_0x473238[_0x228862(0x126)]){loggerService_1['loggerService'][_0x228862(0x100)](_0x228862(0x11a),_0x228862(0x132)+_0x43b920,_0x228862(0x133)+(_0x473238[_0x228862(0x137)]||_0x473238[_0x228862(0x10f)]||_0x228862(0x13e)));throw new Error(_0x228862(0x133)+(_0x473238[_0x228862(0x137)]||_0x473238[_0x228862(0x10f)]||'Unknown\x20error'));}let _0x13dc93='PENDING';if(_0x473238['isActive']===![]){if(_0x473238[_0x228862(0x155)]){const _0x4a7b46=new Date(_0x473238['expiryDate']),_0x42b3d6=new Date();_0x4a7b46<_0x42b3d6?_0x13dc93=_0x228862(0x163):_0x13dc93=_0x228862(0x121);}else _0x13dc93=_0x228862(0x121);}else _0x13dc93=_0x228862(0x135);return{'status':_0x13dc93,'amount':_0x473238[_0x228862(0x105)],'currency':_0x473238['currency'],'isActive':_0x473238[_0x228862(0x13b)]};}catch(_0x5e8364){console[_0x228862(0x10f)]('Noda\x20payment\x20verification\x20error:',_0x5e8364),loggerService_1[_0x228862(0x148)][_0x228862(0x100)](_0x228862(0x11a),'/payment-links/'+_0x43b920,_0x5e8364);throw new Error(_0x228862(0x13a)+(_0x5e8364 instanceof Error?_0x5e8364[_0x228862(0x137)]:_0x228862(0x13e)));}}async['processWebhook'](_0xc730fd){const _0x5df4de=a40_0x545327;console[_0x5df4de(0x120)](_0x5df4de(0x147),_0xc730fd);let _0x4b01ff='PENDING';switch(_0xc730fd[_0x5df4de(0x10b)]?.[_0x5df4de(0x14f)]()){case _0x5df4de(0x11e):case _0x5df4de(0x118):case _0x5df4de(0x112):case _0x5df4de(0x138):case'successful':_0xc730fd['Settled']===_0x5df4de(0x12e)?_0x4b01ff=_0x5df4de(0x15a):_0x4b01ff=_0x5df4de(0x135);break;case _0x5df4de(0x166):case'canceled':case'failed':case _0x5df4de(0x10f):case _0x5df4de(0x114):_0x4b01ff=_0x5df4de(0x121);break;case _0x5df4de(0x102):case'timeout':_0x4b01ff=_0x5df4de(0x163);break;case'pending':case _0x5df4de(0x111):case _0x5df4de(0x123):case _0x5df4de(0x14e):case'in_progress':default:_0x4b01ff='PENDING';break;}return{'paymentId':_0xc730fd[_0x5df4de(0x149)]||_0xc730fd[_0x5df4de(0x106)],'status':_0x4b01ff,'amount':_0xc730fd['Amount'],'currency':_0xc730fd[_0x5df4de(0x104)],'additionalInfo':{'method':_0xc730fd[_0x5df4de(0x13d)],'bankId':_0xc730fd[_0x5df4de(0x110)],'settled':_0xc730fd[_0x5df4de(0x144)],'settlementDate':_0xc730fd[_0x5df4de(0x13c)],'remitterName':_0xc730fd[_0x5df4de(0x101)]?.['Name'],'remitterIban':_0xc730fd['Remitter']?.[_0x5df4de(0x168)],'bankTransactionId':_0xc730fd['BankTransactionId']}};}[a40_0x545327(0x115)](_0x8cfe5f,_0x244472){const _0x39d94e=a40_0x545327;return console[_0x39d94e(0x120)](_0x39d94e(0x159),{'receivedSignature':_0x244472,'paymentId':_0x8cfe5f['PaymentId'],'merchantPaymentId':_0x8cfe5f['MerchantPaymentId']}),!![];}}function a40_0x4ae4(){const _0xc7a842=['151742CwaHOi','Iban','headers','Short\x20Link:','stringify','Error\x20message:','toUpperCase','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','TesSoft\x20Payment\x20System/1.0',',\x20body:\x20','===\x20NODA\x20SUCCESS\x20===','logWhiteDomainRequest','logWhiteDomainError','Remitter','expired','Status:','Currency','amount','PaymentId','ðŸŒ\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','Error\x20Message:','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','https://tesoft.uk/gateway/noda/','Status','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','application/json','json','error','BankId','created','paid','Order\x20ID\x20Format:','rejected','verifyWebhookSignature','fromEntries','apiUrl','completed','Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink','noda','Status\x20Code:','===\x20NODA\x20API\x20ERROR\x20===','/payment-links','done','1548425cSxLjc','log','FAILED','Order\x20ID\x20Used:','active','GET','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','statusCode','now','__esModule','2303096HjhocL','522092IqnXev','createPaymentLink','HTTP\x20','NodaService','Yes','HTTP\x20error!\x20status:\x20','===\x20NODA\x20SERVICE\x20ERROR\x20===','shortLink','/payment-links/','Noda\x20API\x20error:\x20','Not\x20provided','PENDING','Parsed\x20Result:','message','success','shortLinkUrls','Failed\x20to\x20verify\x20Noda\x20payment:\x20','isActive','SettlementDate','Method','Unknown\x20error','4SBCyMv','Error\x20stack:','Response\x20data:','Raw\x20Response\x20Body:','POST','Settled','entries','parse','Processing\x20Noda\x20webhook:','loggerService','MerchantPaymentId','logWhiteDomainResponse','975843PXSVLp','../loggerService','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','processing','toLowerCase','stack','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','6zxuRjt','text','Missing\x20id\x20or\x20shortLink\x20in\x20response','expiryDate','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','QR\x20Code\x20Link:','Status\x20Text:','Noda\x20webhook\x20signature\x20verification:','PAID','666054qodcNW','verifyPayment','URL:','Failed\x20to\x20parse\x20JSON\x20response:','statusText','status','Error\x20details:','Response\x20Body:','EXPIRED','defineProperty','2119733pMqUph','cancelled'];a40_0x4ae4=function(){return _0xc7a842;};return a40_0x4ae4();}exports[a40_0x545327(0x12d)]=NodaService;