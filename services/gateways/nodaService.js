'use strict';const a46_0x5785cd=a46_0x5c1c;function a46_0x135c(){const _0x8fd8a2=['Processing\x20Noda\x20webhook:','All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid','üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','‚úÖ\x20Return\x20URL\x20configured\x20for\x20pending:','/payment-links/','json','Payment\x20Link\x20ID:','Noda\x20payment\x20verification\x20error:','done','canceled','logWhiteDomainResponse','PENDING','HTTP\x20error!\x20status:\x20','processing','created','PaymentId','===\x20NODA\x20SERVICE\x20ERROR\x20===','Failed\x20to\x20verify\x20Noda\x20payment:\x20','168GPHReH','FAILED','Raw\x20Response\x20Body:','__esModule','10CYyjGO','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','logWhiteDomainRequest','1hUazpK','12tlQWYh','timeout','(8digits-8digits\x20format)','expiryDate','NodaService','Failed\x20to\x20parse\x20JSON\x20response:','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','https://tesoft.uk/gateway/pending.php?id=','status','HTTP\x20','fromEntries','===\x20PARSED\x20NODA\x20RESPONSE\x20===','Status:','QR\x20Code\x20Link:','error','headers','failed','Settled','1473wyvadl','Missing\x20id\x20or\x20shortLink\x20in\x20response','shortLink','/payment-links','amount','stringify','Currency','pending','1488366FoYuNg','Noda\x20webhook\x20signature\x20verification:','now','GET','logWhiteDomainError','Noda\x20API\x20error:\x20','loggerService','qrCodeLink','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','https://tesoft.uk/gateway/noda/','14791EglqSy','2152117Kxtwam','expired','text','HTTP\x20Status:','log','Business\x20Error:\x20','URL:','Status','Response\x20Time:','‚úÖ\x20–û–ë–ù–û–í–õ–ï–ù–û:\x20Return\x20URL\x20uses\x20pending.php:','865704vQQxrw','https://tesoft.uk/gateway/noda/webhook/','verifyPayment','completed','Remitter','Not\x20provided','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20===','statusCode','Status\x20Code:','Order\x20ID\x20Format:','rejected','Amount','Request\x20Body\x20(Direct\x20JSON):','message','toUpperCase','===\x20NODA\x20SUCCESS\x20===','stack','2568110zVInCC','MerchantPaymentId','shortLinkUrls','Short\x20Link:','Error\x20details:','active','apiUrl','Method','208692tTcMgD','EXPIRED','Unknown\x20error','noda','createPaymentLink','BankTransactionId','Status\x20Text:','JSON\x20Parse\x20Error:\x20','Headers:','1492DGKmix','toLowerCase','cancelled','Error\x20message:','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','POST','Unknown\x20error\x20from\x20Noda\x20API','PAID',',\x20body:\x20','in_progress','Iban','application/json','TesSoft\x20Payment\x20System/1.0','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20==='];a46_0x135c=function(){return _0x8fd8a2;};return a46_0x135c();}(function(_0x40ea07,_0x5bbd7c){const _0x304e22=a46_0x5c1c,_0x2d4f2e=_0x40ea07();while(!![]){try{const _0x26415e=-parseInt(_0x304e22(0x144))/0x1*(-parseInt(_0x304e22(0x18d))/0x2)+-parseInt(_0x304e22(0x157))/0x3*(parseInt(_0x304e22(0x11d))/0x4)+-parseInt(_0x304e22(0x141))/0x5*(-parseInt(_0x304e22(0x174))/0x6)+-parseInt(_0x304e22(0x169))/0x7*(-parseInt(_0x304e22(0x13d))/0x8)+-parseInt(_0x304e22(0x15f))/0x9+parseInt(_0x304e22(0x185))/0xa+-parseInt(_0x304e22(0x16a))/0xb*(parseInt(_0x304e22(0x145))/0xc);if(_0x26415e===_0x5bbd7c)break;else _0x2d4f2e['push'](_0x2d4f2e['shift']());}catch(_0x3660ea){_0x2d4f2e['push'](_0x2d4f2e['shift']());}}}(a46_0x135c,0x249ae));Object['defineProperty'](exports,a46_0x5785cd(0x140),{'value':!![]}),exports[a46_0x5785cd(0x149)]=void 0x0;function a46_0x5c1c(_0x51b701,_0x1065ec){const _0x135c7a=a46_0x135c();return a46_0x5c1c=function(_0x5c1c79,_0x5c2195){_0x5c1c79=_0x5c1c79-0x116;let _0x7390c9=_0x135c7a[_0x5c1c79];return _0x7390c9;},a46_0x5c1c(_0x51b701,_0x1065ec);}const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0x250854=a46_0x5785cd;this[_0x250854(0x18b)]=_0x250854(0x168),console[_0x250854(0x16e)](_0x250854(0x12d));}async[a46_0x5785cd(0x118)](_0x5c9a0d){const _0x27e451=a46_0x5785cd,{orderId:_0x7aec58,name:_0x4f2029,paymentDescription:_0x6c7e7d,amount:_0x14edd6,currency:_0x15351b,webhookUrl:_0x81f0e7,returnUrl:_0x2cdff7,expiryDate:_0x45e5cc}=_0x5c9a0d,_0x501734=_0x15351b[_0x27e451(0x182)](),_0x125f24=_0x27e451(0x175),_0x1aafd3=_0x27e451(0x14c)+_0x7aec58,_0x1cff0a={'name':_0x4f2029,'paymentDescription':_0x6c7e7d,'amount':_0x14edd6,'currency':_0x501734,'paymentId':_0x7aec58,'webhookUrl':_0x125f24,'returnUrl':_0x1aafd3};_0x45e5cc&&(_0x1cff0a['expiryDate']=_0x45e5cc);const _0x498351=Date[_0x27e451(0x161)]();try{console['log'](_0x27e451(0x17a)),console[_0x27e451(0x16e)](_0x27e451(0x170),this[_0x27e451(0x18b)]),console[_0x27e451(0x16e)](_0x27e451(0x180),JSON[_0x27e451(0x15c)](_0x1cff0a,null,0x2)),console['log'](_0x27e451(0x17d),_0x7aec58,'(8digits-8digits\x20format\x20for\x20Noda)'),console[_0x27e451(0x16e)](_0x27e451(0x173),_0x1aafd3),loggerService_1[_0x27e451(0x165)][_0x27e451(0x143)](_0x27e451(0x117),'/payment-links',_0x27e451(0x122),_0x1cff0a);const _0x11d0ea=await fetch(this[_0x27e451(0x18b)],{'method':'POST','headers':{'Content-Type':_0x27e451(0x128),'Accept':_0x27e451(0x128),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x27e451(0x15c)](_0x1cff0a)}),_0xa150ca=Date[_0x27e451(0x161)]()-_0x498351;console[_0x27e451(0x16e)]('===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20==='),console[_0x27e451(0x16e)](_0x27e451(0x151),_0x11d0ea['status']),console[_0x27e451(0x16e)](_0x27e451(0x11a),_0x11d0ea['statusText']),console[_0x27e451(0x16e)](_0x27e451(0x11c),Object[_0x27e451(0x14f)](_0x11d0ea[_0x27e451(0x154)]['entries']())),console[_0x27e451(0x16e)](_0x27e451(0x172),_0xa150ca+'ms');const _0x3d65a4=await _0x11d0ea[_0x27e451(0x16c)]();console[_0x27e451(0x16e)](_0x27e451(0x13f),_0x3d65a4);if(!_0x11d0ea['ok']){console[_0x27e451(0x153)]('===\x20NODA\x20API\x20ERROR\x20==='),console[_0x27e451(0x153)](_0x27e451(0x16d),_0x11d0ea[_0x27e451(0x14d)]),console[_0x27e451(0x153)]('Response\x20Body:',_0x3d65a4),loggerService_1[_0x27e451(0x165)][_0x27e451(0x135)](_0x27e451(0x117),'/payment-links',_0x11d0ea['status'],_0x3d65a4,_0xa150ca),loggerService_1[_0x27e451(0x165)][_0x27e451(0x163)]('noda','/payment-links',_0x27e451(0x14e)+_0x11d0ea[_0x27e451(0x14d)]+':\x20'+_0x3d65a4);if(_0x11d0ea[_0x27e451(0x14d)]===0x190)throw new Error(_0x27e451(0x121));else{if(_0x11d0ea[_0x27e451(0x14d)]===0x1f4)throw new Error(_0x27e451(0x12c));}throw new Error(_0x27e451(0x137)+_0x11d0ea[_0x27e451(0x14d)]+_0x27e451(0x125)+_0x3d65a4);}let _0x57107f;try{_0x57107f=JSON['parse'](_0x3d65a4);}catch(_0x525254){console[_0x27e451(0x153)](_0x27e451(0x14a),_0x525254),loggerService_1[_0x27e451(0x165)][_0x27e451(0x163)](_0x27e451(0x117),_0x27e451(0x15a),_0x27e451(0x11b)+_0x525254);throw new Error(_0x27e451(0x167)+_0x3d65a4);}console[_0x27e451(0x16e)](_0x27e451(0x150)),console['log']('Parsed\x20Result:',JSON[_0x27e451(0x15c)](_0x57107f,null,0x2)),loggerService_1[_0x27e451(0x165)][_0x27e451(0x135)](_0x27e451(0x117),_0x27e451(0x15a),_0x11d0ea['status'],_0x57107f,_0xa150ca);if(_0x57107f[_0x27e451(0x153)]||_0x57107f[_0x27e451(0x17b)]){const _0x101ee1=_0x57107f[_0x27e451(0x181)]||_0x57107f[_0x27e451(0x153)]||_0x27e451(0x123);console[_0x27e451(0x153)]('===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x27e451(0x153)]('Error\x20Message:',_0x101ee1),console[_0x27e451(0x153)](_0x27e451(0x17c),_0x57107f[_0x27e451(0x17b)]),loggerService_1[_0x27e451(0x165)]['logWhiteDomainError'](_0x27e451(0x117),_0x27e451(0x15a),_0x27e451(0x16f)+_0x101ee1);throw new Error(_0x27e451(0x164)+_0x101ee1);}if(!_0x57107f['id']||!_0x57107f[_0x27e451(0x187)]?.[_0x27e451(0x159)]){console[_0x27e451(0x153)](_0x27e451(0x12a)),console[_0x27e451(0x153)](_0x27e451(0x158)),console[_0x27e451(0x153)]('Response\x20data:',_0x57107f),loggerService_1['loggerService'][_0x27e451(0x163)](_0x27e451(0x117),_0x27e451(0x15a),'Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink');throw new Error('Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink');}return console[_0x27e451(0x16e)](_0x27e451(0x183)),console[_0x27e451(0x16e)](_0x27e451(0x131),_0x57107f['id']),console[_0x27e451(0x16e)](_0x27e451(0x188),_0x57107f[_0x27e451(0x187)][_0x27e451(0x159)]),console[_0x27e451(0x16e)](_0x27e451(0x152),_0x57107f[_0x27e451(0x187)]['qrCodeLink']||_0x27e451(0x179)),console['log']('Order\x20ID\x20Used:',_0x7aec58,_0x27e451(0x147)),console[_0x27e451(0x16e)](_0x27e451(0x12e),_0x1aafd3),{'gateway_payment_id':_0x57107f['id'],'payment_url':_0x57107f[_0x27e451(0x187)]['shortLink'],'qr_code_url':_0x57107f[_0x27e451(0x187)][_0x27e451(0x166)],'expiry_date':_0x57107f[_0x27e451(0x148)]};}catch(_0x3f9b42){console[_0x27e451(0x153)](_0x27e451(0x13b)),console[_0x27e451(0x153)](_0x27e451(0x189),_0x3f9b42),loggerService_1[_0x27e451(0x165)][_0x27e451(0x163)]('noda','/payment-links',_0x3f9b42);if(_0x3f9b42 instanceof Error){console['error'](_0x27e451(0x120),_0x3f9b42[_0x27e451(0x181)]),console[_0x27e451(0x153)]('Error\x20stack:',_0x3f9b42[_0x27e451(0x184)]);throw new Error(_0x27e451(0x142)+_0x3f9b42[_0x27e451(0x181)]);}throw new Error(_0x27e451(0x14b));}}async[a46_0x5785cd(0x176)](_0x3fb595){const _0x1b635b=a46_0x5785cd,_0x8a1ed1=Date['now']();try{loggerService_1['loggerService'][_0x1b635b(0x143)](_0x1b635b(0x117),_0x1b635b(0x12f)+_0x3fb595,_0x1b635b(0x162),{});const _0x2c99fb=await fetch(this[_0x1b635b(0x18b)]+'/'+_0x3fb595,{'method':_0x1b635b(0x162),'headers':{'Content-Type':'application/json','User-Agent':_0x1b635b(0x129)}}),_0xde5f2c=Date[_0x1b635b(0x161)]()-_0x8a1ed1;if(!_0x2c99fb['ok']){const _0x28ef09=await _0x2c99fb[_0x1b635b(0x16c)]();loggerService_1['loggerService'][_0x1b635b(0x135)]('noda','/payment-links/'+_0x3fb595,_0x2c99fb[_0x1b635b(0x14d)],_0x28ef09,_0xde5f2c);throw new Error(_0x1b635b(0x137)+_0x2c99fb[_0x1b635b(0x14d)]);}const _0x466da3=await _0x2c99fb[_0x1b635b(0x130)]();loggerService_1[_0x1b635b(0x165)][_0x1b635b(0x135)](_0x1b635b(0x117),_0x1b635b(0x12f)+_0x3fb595,_0x2c99fb[_0x1b635b(0x14d)],_0x466da3,_0xde5f2c);if(_0x466da3['error']||_0x466da3[_0x1b635b(0x17b)]){loggerService_1[_0x1b635b(0x165)][_0x1b635b(0x163)](_0x1b635b(0x117),_0x1b635b(0x12f)+_0x3fb595,_0x1b635b(0x164)+(_0x466da3[_0x1b635b(0x181)]||_0x466da3[_0x1b635b(0x153)]||'Unknown\x20error'));throw new Error(_0x1b635b(0x164)+(_0x466da3[_0x1b635b(0x181)]||_0x466da3[_0x1b635b(0x153)]||_0x1b635b(0x116)));}let _0x13c0dc='PENDING';if(_0x466da3['isActive']===![]){if(_0x466da3[_0x1b635b(0x148)]){const _0x21f61d=new Date(_0x466da3[_0x1b635b(0x148)]),_0x516ace=new Date();_0x21f61d<_0x516ace?_0x13c0dc=_0x1b635b(0x18e):_0x13c0dc=_0x1b635b(0x13e);}else _0x13c0dc='FAILED';}else _0x13c0dc='PENDING';return{'status':_0x13c0dc,'amount':_0x466da3[_0x1b635b(0x15b)],'currency':_0x466da3['currency'],'isActive':_0x466da3['isActive']};}catch(_0x26d81c){console[_0x1b635b(0x153)](_0x1b635b(0x132),_0x26d81c),loggerService_1[_0x1b635b(0x165)][_0x1b635b(0x163)]('noda','/payment-links/'+_0x3fb595,_0x26d81c);throw new Error(_0x1b635b(0x13c)+(_0x26d81c instanceof Error?_0x26d81c[_0x1b635b(0x181)]:_0x1b635b(0x116)));}}async['processWebhook'](_0xc1786e){const _0x59b808=a46_0x5785cd;console[_0x59b808(0x16e)](_0x59b808(0x12b),_0xc1786e);let _0x33dbd6=_0x59b808(0x136);switch(_0xc1786e[_0x59b808(0x171)]?.[_0x59b808(0x11e)]()){case _0x59b808(0x133):case _0x59b808(0x177):case'paid':case'success':case'successful':_0xc1786e['Settled']==='Yes'?_0x33dbd6=_0x59b808(0x124):_0x33dbd6='PENDING';break;case _0x59b808(0x11f):case _0x59b808(0x134):case _0x59b808(0x155):case _0x59b808(0x153):case _0x59b808(0x17e):_0x33dbd6=_0x59b808(0x13e);break;case _0x59b808(0x16b):case _0x59b808(0x146):_0x33dbd6=_0x59b808(0x18e);break;case _0x59b808(0x15e):case _0x59b808(0x139):case _0x59b808(0x18a):case _0x59b808(0x138):case _0x59b808(0x126):default:_0x33dbd6=_0x59b808(0x136);break;}return{'paymentId':_0xc1786e[_0x59b808(0x186)]||_0xc1786e[_0x59b808(0x13a)],'status':_0x33dbd6,'amount':_0xc1786e[_0x59b808(0x17f)],'currency':_0xc1786e[_0x59b808(0x15d)],'additionalInfo':{'method':_0xc1786e[_0x59b808(0x18c)],'bankId':_0xc1786e['BankId'],'settled':_0xc1786e[_0x59b808(0x156)],'settlementDate':_0xc1786e['SettlementDate'],'remitterName':_0xc1786e[_0x59b808(0x178)]?.['Name'],'remitterIban':_0xc1786e[_0x59b808(0x178)]?.[_0x59b808(0x127)],'bankTransactionId':_0xc1786e[_0x59b808(0x119)]}};}['verifyWebhookSignature'](_0x3b384d,_0x712488){const _0x2d9302=a46_0x5785cd;return console[_0x2d9302(0x16e)](_0x2d9302(0x160),{'receivedSignature':_0x712488,'paymentId':_0x3b384d['PaymentId'],'merchantPaymentId':_0x3b384d[_0x2d9302(0x186)]}),!![];}}exports[a46_0x5785cd(0x149)]=NodaService;