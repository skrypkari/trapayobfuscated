'use strict';function a40_0x1f22(){const _0x2c266f=['TesSoft\x20Payment\x20System/1.0','HTTP\x20','json','log','34931798bLQxTp','===\x20NODA\x20SERVICE\x20ERROR\x20===','BankId','Name','Not\x20provided','created','headers','https://tesoft.uk/gateway/noda/webhook/','isActive','QR\x20Code\x20Link:','Noda\x20API\x20error:\x20','MerchantPaymentId','expiryDate','successful','Processing\x20Noda\x20webhook:','Error\x20message:','===\x20NODA\x20API\x20REQUEST\x20(White\x20Domain\x20-\x20Direct\x20JSON)\x20===','verifyWebhookSignature','36xFWTIb','PaymentId','amount',',\x20body:\x20','success','HTTP\x20error!\x20status:\x20','Failed\x20to\x20verify\x20Noda\x20payment:\x20','GET','Payment\x20Link\x20ID:','Business\x20Error:\x20','JSON\x20Parse\x20Error:\x20','processWebhook','21HACcXe','stringify','logWhiteDomainRequest','URL:','Iban','BankTransactionId','canceled','2580939gpRtnV','Status\x20Text:','message','parse','stack','===\x20NODA\x20API\x20BUSINESS\x20ERROR\x20===','Invalid\x20JSON\x20response\x20from\x20Noda\x20API:\x20','pending','410442MBkNFu','logWhiteDomainResponse','Incomplete\x20response:\x20missing\x20id\x20or\x20shortLink','2508325OpDUXu','===\x20NODA\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','Method','in_progress','completed','createPaymentLink','Parsed\x20Result:','Error\x20Message:','__esModule','https://tesoft.uk/gateway/noda/','62938EOZqxe','===\x20NODA\x20API\x20ERROR\x20===','HTTP\x20Status:','loggerService','Response\x20Body:','Remitter','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20Unknown\x20error','now','shortLinkUrls','Missing\x20id\x20or\x20shortLink\x20in\x20response','statusCode','Status:','Currency','Response\x20Time:','EXPIRED','status','üåê\x20Noda\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','paid','Response\x20data:','FAILED','2084216vGdsNT','application/json','Request\x20Body\x20(Direct\x20JSON):','(8digits-8digits\x20format\x20for\x20Noda)','Status','Error\x20details:','/payment-links/','defineProperty','/payment-links','Error\x20stack:','statusText','POST','Raw\x20Response\x20Body:','===\x20NODA\x20API\x20INCOMPLETE\x20RESPONSE\x20===','noda','qrCodeLink','Unknown\x20error','Settled','Order\x20ID\x20Format:','processing','19NaFsFz','Status\x20Code:','apiUrl','toUpperCase','shortLink','logWhiteDomainError','done','PENDING','https://tesoft.uk/gateway/success.php?id=','failed','NodaService','Yes','Failed\x20to\x20create\x20Noda\x20payment\x20link:\x20','2419944rhlvlK','timeout','text','PAID','error','One\x20of\x20the\x20required\x20parameters\x20is\x20missing\x20or\x20has\x20an\x20incorrect\x20value','10NKkEBE','Amount','Noda\x20webhook\x20signature\x20verification:','active'];a40_0x1f22=function(){return _0x2c266f;};return a40_0x1f22();}function a40_0x1a5d(_0x264b60,_0x1d944c){const _0x1f22d2=a40_0x1f22();return a40_0x1a5d=function(_0x1a5d80,_0x2d68b6){_0x1a5d80=_0x1a5d80-0x1bc;let _0x283d61=_0x1f22d2[_0x1a5d80];return _0x283d61;},a40_0x1a5d(_0x264b60,_0x1d944c);}const a40_0x1c49cd=a40_0x1a5d;(function(_0x34000b,_0x401e2a){const _0x4fdb73=a40_0x1a5d,_0x3c54af=_0x34000b();while(!![]){try{const _0x36cef4=parseInt(_0x4fdb73(0x21f))/0x1*(parseInt(_0x4fdb73(0x1f7))/0x2)+-parseInt(_0x4fdb73(0x1ea))/0x3*(-parseInt(_0x4fdb73(0x1cf))/0x4)+parseInt(_0x4fdb73(0x1ed))/0x5+parseInt(_0x4fdb73(0x22c))/0x6+-parseInt(_0x4fdb73(0x1db))/0x7*(-parseInt(_0x4fdb73(0x20b))/0x8)+parseInt(_0x4fdb73(0x1e2))/0x9+parseInt(_0x4fdb73(0x232))/0xa*(-parseInt(_0x4fdb73(0x1bd))/0xb);if(_0x36cef4===_0x401e2a)break;else _0x3c54af['push'](_0x3c54af['shift']());}catch(_0x6db656){_0x3c54af['push'](_0x3c54af['shift']());}}}(a40_0x1f22,0x99110));Object[a40_0x1c49cd(0x212)](exports,a40_0x1c49cd(0x1f5),{'value':!![]}),exports[a40_0x1c49cd(0x229)]=void 0x0;const loggerService_1=require('../loggerService');class NodaService{constructor(){const _0xe8cdb=a40_0x1c49cd;this[_0xe8cdb(0x221)]=_0xe8cdb(0x1f6),console[_0xe8cdb(0x1bc)](_0xe8cdb(0x207));}async[a40_0x1c49cd(0x1f2)](_0x2e86f1){const _0x2d1a9f=a40_0x1c49cd,{orderId:_0x26b06e,name:_0x2a1d0a,paymentDescription:_0x2a98ea,amount:_0x91bdb0,currency:_0x4ba1e6,webhookUrl:_0x1f59b2,returnUrl:_0x9e3e64,expiryDate:_0x2988bb}=_0x2e86f1,_0x39fc67=_0x4ba1e6[_0x2d1a9f(0x222)](),_0x15bd3d=_0x2d1a9f(0x1c4),_0x5df5d7=_0x2d1a9f(0x227)+_0x26b06e,_0x501da7={'name':_0x2a1d0a,'paymentDescription':_0x2a98ea,'amount':_0x91bdb0,'currency':_0x39fc67,'paymentId':_0x26b06e,'webhookUrl':_0x15bd3d,'returnUrl':_0x5df5d7};_0x2988bb&&(_0x501da7[_0x2d1a9f(0x1c9)]=_0x2988bb);const _0x498b29=Date[_0x2d1a9f(0x1fe)]();try{console[_0x2d1a9f(0x1bc)](_0x2d1a9f(0x1cd)),console[_0x2d1a9f(0x1bc)](_0x2d1a9f(0x1de),this[_0x2d1a9f(0x221)]),console['log'](_0x2d1a9f(0x20d),JSON[_0x2d1a9f(0x1dc)](_0x501da7,null,0x2)),console['log'](_0x2d1a9f(0x21d),_0x26b06e,_0x2d1a9f(0x20e)),loggerService_1[_0x2d1a9f(0x1fa)][_0x2d1a9f(0x1dd)](_0x2d1a9f(0x219),_0x2d1a9f(0x213),_0x2d1a9f(0x216),_0x501da7);const _0x101406=await fetch(this['apiUrl'],{'method':_0x2d1a9f(0x216),'headers':{'Content-Type':_0x2d1a9f(0x20c),'Accept':_0x2d1a9f(0x20c),'User-Agent':_0x2d1a9f(0x236)},'body':JSON[_0x2d1a9f(0x1dc)](_0x501da7)}),_0x74565e=Date['now']()-_0x498b29;console['log'](_0x2d1a9f(0x1ee)),console[_0x2d1a9f(0x1bc)](_0x2d1a9f(0x202),_0x101406['status']),console[_0x2d1a9f(0x1bc)](_0x2d1a9f(0x1e3),_0x101406[_0x2d1a9f(0x215)]),console[_0x2d1a9f(0x1bc)]('Headers:',Object['fromEntries'](_0x101406[_0x2d1a9f(0x1c3)]['entries']())),console[_0x2d1a9f(0x1bc)](_0x2d1a9f(0x204),_0x74565e+'ms');const _0x297a41=await _0x101406[_0x2d1a9f(0x22e)]();console[_0x2d1a9f(0x1bc)](_0x2d1a9f(0x217),_0x297a41);if(!_0x101406['ok']){console[_0x2d1a9f(0x230)](_0x2d1a9f(0x1f8)),console['error'](_0x2d1a9f(0x1f9),_0x101406['status']),console['error'](_0x2d1a9f(0x1fb),_0x297a41),loggerService_1[_0x2d1a9f(0x1fa)][_0x2d1a9f(0x1eb)]('noda',_0x2d1a9f(0x213),_0x101406[_0x2d1a9f(0x206)],_0x297a41,_0x74565e),loggerService_1[_0x2d1a9f(0x1fa)]['logWhiteDomainError'](_0x2d1a9f(0x219),_0x2d1a9f(0x213),_0x2d1a9f(0x237)+_0x101406[_0x2d1a9f(0x206)]+':\x20'+_0x297a41);if(_0x101406[_0x2d1a9f(0x206)]===0x190)throw new Error(_0x2d1a9f(0x231));else{if(_0x101406[_0x2d1a9f(0x206)]===0x1f4)throw new Error('All\x20the\x20required\x20parameters\x20are\x20missing,\x20so\x20the\x20request\x20is\x20invalid');}throw new Error(_0x2d1a9f(0x1d4)+_0x101406['status']+_0x2d1a9f(0x1d2)+_0x297a41);}let _0x3efda9;try{_0x3efda9=JSON[_0x2d1a9f(0x1e5)](_0x297a41);}catch(_0x4980e4){console[_0x2d1a9f(0x230)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x4980e4),loggerService_1['loggerService']['logWhiteDomainError'](_0x2d1a9f(0x219),_0x2d1a9f(0x213),_0x2d1a9f(0x1d9)+_0x4980e4);throw new Error(_0x2d1a9f(0x1e8)+_0x297a41);}console['log']('===\x20PARSED\x20NODA\x20RESPONSE\x20==='),console[_0x2d1a9f(0x1bc)](_0x2d1a9f(0x1f3),JSON[_0x2d1a9f(0x1dc)](_0x3efda9,null,0x2)),loggerService_1[_0x2d1a9f(0x1fa)]['logWhiteDomainResponse'](_0x2d1a9f(0x219),_0x2d1a9f(0x213),_0x101406['status'],_0x3efda9,_0x74565e);if(_0x3efda9[_0x2d1a9f(0x230)]||_0x3efda9[_0x2d1a9f(0x201)]){const _0x2565c4=_0x3efda9[_0x2d1a9f(0x1e4)]||_0x3efda9[_0x2d1a9f(0x230)]||'Unknown\x20error\x20from\x20Noda\x20API';console[_0x2d1a9f(0x230)](_0x2d1a9f(0x1e7)),console[_0x2d1a9f(0x230)](_0x2d1a9f(0x1f4),_0x2565c4),console[_0x2d1a9f(0x230)](_0x2d1a9f(0x220),_0x3efda9[_0x2d1a9f(0x201)]),loggerService_1[_0x2d1a9f(0x1fa)]['logWhiteDomainError'](_0x2d1a9f(0x219),_0x2d1a9f(0x213),_0x2d1a9f(0x1d8)+_0x2565c4);throw new Error(_0x2d1a9f(0x1c7)+_0x2565c4);}if(!_0x3efda9['id']||!_0x3efda9['shortLinkUrls']?.[_0x2d1a9f(0x223)]){console[_0x2d1a9f(0x230)](_0x2d1a9f(0x218)),console[_0x2d1a9f(0x230)](_0x2d1a9f(0x200)),console[_0x2d1a9f(0x230)](_0x2d1a9f(0x209),_0x3efda9),loggerService_1[_0x2d1a9f(0x1fa)][_0x2d1a9f(0x224)]('noda',_0x2d1a9f(0x213),_0x2d1a9f(0x1ec));throw new Error('Invalid\x20response\x20from\x20Noda\x20API:\x20missing\x20id\x20or\x20shortLink');}return console[_0x2d1a9f(0x1bc)]('===\x20NODA\x20SUCCESS\x20==='),console[_0x2d1a9f(0x1bc)](_0x2d1a9f(0x1d7),_0x3efda9['id']),console['log']('Short\x20Link:',_0x3efda9[_0x2d1a9f(0x1ff)][_0x2d1a9f(0x223)]),console[_0x2d1a9f(0x1bc)](_0x2d1a9f(0x1c6),_0x3efda9[_0x2d1a9f(0x1ff)][_0x2d1a9f(0x21a)]||_0x2d1a9f(0x1c1)),console[_0x2d1a9f(0x1bc)]('Order\x20ID\x20Used:',_0x26b06e,'(8digits-8digits\x20format)'),{'gateway_payment_id':_0x3efda9['id'],'payment_url':_0x3efda9[_0x2d1a9f(0x1ff)][_0x2d1a9f(0x223)],'qr_code_url':_0x3efda9[_0x2d1a9f(0x1ff)][_0x2d1a9f(0x21a)],'expiry_date':_0x3efda9[_0x2d1a9f(0x1c9)]};}catch(_0x1376b9){console['error'](_0x2d1a9f(0x1be)),console[_0x2d1a9f(0x230)](_0x2d1a9f(0x210),_0x1376b9),loggerService_1['loggerService'][_0x2d1a9f(0x224)]('noda',_0x2d1a9f(0x213),_0x1376b9);if(_0x1376b9 instanceof Error){console['error'](_0x2d1a9f(0x1cc),_0x1376b9['message']),console['error'](_0x2d1a9f(0x214),_0x1376b9[_0x2d1a9f(0x1e6)]);throw new Error(_0x2d1a9f(0x22b)+_0x1376b9[_0x2d1a9f(0x1e4)]);}throw new Error(_0x2d1a9f(0x1fd));}}async['verifyPayment'](_0x107888){const _0x23ed80=a40_0x1c49cd,_0x34f980=Date[_0x23ed80(0x1fe)]();try{loggerService_1[_0x23ed80(0x1fa)]['logWhiteDomainRequest'](_0x23ed80(0x219),_0x23ed80(0x211)+_0x107888,_0x23ed80(0x1d6),{});const _0x3a370c=await fetch(this[_0x23ed80(0x221)]+'/'+_0x107888,{'method':_0x23ed80(0x1d6),'headers':{'Content-Type':'application/json','User-Agent':_0x23ed80(0x236)}}),_0x3dc790=Date['now']()-_0x34f980;if(!_0x3a370c['ok']){const _0x5c2716=await _0x3a370c[_0x23ed80(0x22e)]();loggerService_1[_0x23ed80(0x1fa)][_0x23ed80(0x1eb)](_0x23ed80(0x219),_0x23ed80(0x211)+_0x107888,_0x3a370c['status'],_0x5c2716,_0x3dc790);throw new Error(_0x23ed80(0x1d4)+_0x3a370c[_0x23ed80(0x206)]);}const _0x46fd73=await _0x3a370c[_0x23ed80(0x238)]();loggerService_1[_0x23ed80(0x1fa)][_0x23ed80(0x1eb)](_0x23ed80(0x219),_0x23ed80(0x211)+_0x107888,_0x3a370c[_0x23ed80(0x206)],_0x46fd73,_0x3dc790);if(_0x46fd73[_0x23ed80(0x230)]||_0x46fd73[_0x23ed80(0x201)]){loggerService_1[_0x23ed80(0x1fa)][_0x23ed80(0x224)](_0x23ed80(0x219),_0x23ed80(0x211)+_0x107888,_0x23ed80(0x1c7)+(_0x46fd73[_0x23ed80(0x1e4)]||_0x46fd73[_0x23ed80(0x230)]||_0x23ed80(0x21b)));throw new Error(_0x23ed80(0x1c7)+(_0x46fd73[_0x23ed80(0x1e4)]||_0x46fd73[_0x23ed80(0x230)]||_0x23ed80(0x21b)));}let _0x5d1538='PENDING';if(_0x46fd73['isActive']===![]){if(_0x46fd73[_0x23ed80(0x1c9)]){const _0x5094a8=new Date(_0x46fd73[_0x23ed80(0x1c9)]),_0x314542=new Date();_0x5094a8<_0x314542?_0x5d1538=_0x23ed80(0x205):_0x5d1538=_0x23ed80(0x20a);}else _0x5d1538=_0x23ed80(0x20a);}else _0x5d1538='PENDING';return{'status':_0x5d1538,'amount':_0x46fd73[_0x23ed80(0x1d1)],'currency':_0x46fd73['currency'],'isActive':_0x46fd73[_0x23ed80(0x1c5)]};}catch(_0x461678){console[_0x23ed80(0x230)]('Noda\x20payment\x20verification\x20error:',_0x461678),loggerService_1[_0x23ed80(0x1fa)][_0x23ed80(0x224)](_0x23ed80(0x219),_0x23ed80(0x211)+_0x107888,_0x461678);throw new Error(_0x23ed80(0x1d5)+(_0x461678 instanceof Error?_0x461678[_0x23ed80(0x1e4)]:_0x23ed80(0x21b)));}}async[a40_0x1c49cd(0x1da)](_0x29efd4){const _0x378bca=a40_0x1c49cd;console[_0x378bca(0x1bc)](_0x378bca(0x1cb),_0x29efd4);let _0xdbd26a=_0x378bca(0x226);switch(_0x29efd4[_0x378bca(0x20f)]?.['toLowerCase']()){case _0x378bca(0x225):case _0x378bca(0x1f1):case _0x378bca(0x208):case _0x378bca(0x1d3):case _0x378bca(0x1ca):_0x29efd4[_0x378bca(0x21c)]===_0x378bca(0x22a)?_0xdbd26a=_0x378bca(0x22f):_0xdbd26a='PENDING';break;case'cancelled':case _0x378bca(0x1e1):case _0x378bca(0x228):case _0x378bca(0x230):case'rejected':_0xdbd26a=_0x378bca(0x20a);break;case'expired':case _0x378bca(0x22d):_0xdbd26a=_0x378bca(0x205);break;case _0x378bca(0x1e9):case _0x378bca(0x1c2):case _0x378bca(0x235):case _0x378bca(0x21e):case _0x378bca(0x1f0):default:_0xdbd26a=_0x378bca(0x226);break;}return{'paymentId':_0x29efd4[_0x378bca(0x1c8)]||_0x29efd4['PaymentId'],'status':_0xdbd26a,'amount':_0x29efd4[_0x378bca(0x233)],'currency':_0x29efd4[_0x378bca(0x203)],'additionalInfo':{'method':_0x29efd4[_0x378bca(0x1ef)],'bankId':_0x29efd4[_0x378bca(0x1bf)],'settled':_0x29efd4[_0x378bca(0x21c)],'settlementDate':_0x29efd4['SettlementDate'],'remitterName':_0x29efd4[_0x378bca(0x1fc)]?.[_0x378bca(0x1c0)],'remitterIban':_0x29efd4[_0x378bca(0x1fc)]?.[_0x378bca(0x1df)],'bankTransactionId':_0x29efd4[_0x378bca(0x1e0)]}};}[a40_0x1c49cd(0x1ce)](_0x5b4daa,_0x55a9b8){const _0x4a6329=a40_0x1c49cd;return console['log'](_0x4a6329(0x234),{'receivedSignature':_0x55a9b8,'paymentId':_0x5b4daa[_0x4a6329(0x1d0)],'merchantPaymentId':_0x5b4daa[_0x4a6329(0x1c8)]}),!![];}}exports['NodaService']=NodaService;