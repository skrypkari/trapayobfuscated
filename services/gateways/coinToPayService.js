'use strict';function a40_0x1c99(){const _0x833089=['Response\x20Body:','now','Unknown\x20error\x20from\x20CoinToPay\x20status\x20API','https://tesoft.uk/gateway/cointopay/','pending','===\x20PARSED\x20COINTOPAY\x20STATUS\x20RESPONSE\x20===','parse','Invalid\x20response\x20from\x20CoinToPay\x20status\x20API:\x20missing\x20data','521270BvdmOg','Business\x20Error:\x20','entries','Payment\x20URL:','ü™ô\x20Creating\x20CoinToPay\x20payment:\x20','__esModule','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20Unknown\x20error','text','https://tesoft.uk/gateway/cointopay/status.php','toLowerCase','879624PaXYWB','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','Amount','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','gateway_payment_id','Result:','Failed\x20to\x20check\x20CoinToPay\x20payment\x20status:\x20','success','merchant_reference_id','HTTP\x20','EXPIRED','ExpiryTime','6tGRgNi','Response\x20data:','stack','awaiting\x20fiat','PENDING','status','Currency:','Parsed\x20Result:','Status:','HTTP\x20error!\x20status:\x20','TransactionConfirmedOn','CoinToPay\x20API\x20error:\x20','cancelled','Raw\x20Response\x20Body:','URL:','IBAN:','===\x20COINTOPAY\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','üè¶\x20Payment\x20Detail:','650335MDvaJx','Response\x20Time:','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','message','amount','JSON\x20Parse\x20Error:\x20','currency','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20status\x20API:\x20','Invalid\x20response\x20from\x20CoinToPay\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','===\x20COINTOPAY\x20STATUS\x20SUCCESS\x20===','logWhiteDomainError','apiUrl','/create','Status\x20Code:','Error\x20details:','paid','Status\x20Text:','1032764ClHjfA','PaymentDetail','payment_url','Error\x20Message:','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20API:\x20','ü™ô\x20CoinToPay\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','CreatedOn','8hcMxwz','logWhiteDomainResponse','data','26CbaoaH','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','POST','logWhiteDomainRequest','Status','status_code','HTTP\x20Status:','===\x20PARSED\x20COINTOPAY\x20RESPONSE\x20===','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20','Error\x20message:','stringify','/status','Amount:','===\x20COINTOPAY\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','expired','inputCurrency','cointopay','Request\x20Body:','Failed\x20to\x20parse\x20JSON\x20response:','statusUrl','üè¶\x20Extracted\x20IBAN:','result','timeout','verifyPayment','Error\x20stack:','Transaction\x20ID:','headers','===\x20COINTOPAY\x20STATUS\x20API\x20ERROR\x20===','Headers:','failed','595479MwzEZl','application/json','PAID','statusText','loggerService','CoinToPayService','waiting','created','Gateway\x20Payment\x20ID:','match','===\x20COINTOPAY\x20STATUS\x20CHECK\x20RESPONSE\x20===','EUR','Status\x20API\x20Error:\x20','2784040JELdcJ','TesSoft\x20Payment\x20System/1.0','EUR\x20(always\x20EUR\x20for\x20CoinToPay)','not\x20confirmed','4035zzNJdX','fromEntries','Unknown\x20error','TransactionID','\x20EUR','log','error','checkPaymentStatus','Incomplete\x20response:\x20missing\x20data','===\x20COINTOPAY\x20API\x20ERROR\x20==='];a40_0x1c99=function(){return _0x833089;};return a40_0x1c99();}const a40_0x5e26fe=a40_0x47ab;function a40_0x47ab(_0x3d96d0,_0x103313){const _0x1c990c=a40_0x1c99();return a40_0x47ab=function(_0x47ab89,_0x3f3f6d){_0x47ab89=_0x47ab89-0x14a;let _0x5e4ef9=_0x1c990c[_0x47ab89];return _0x5e4ef9;},a40_0x47ab(_0x3d96d0,_0x103313);}(function(_0x48ac84,_0x16d7c4){const _0x361f3f=a40_0x47ab,_0x65487b=_0x48ac84();while(!![]){try{const _0x19af32=parseInt(_0x361f3f(0x193))/0x1*(parseInt(_0x361f3f(0x164))/0x2)+-parseInt(_0x361f3f(0x182))/0x3+-parseInt(_0x361f3f(0x15a))/0x4+parseInt(_0x361f3f(0x1a5))/0x5*(parseInt(_0x361f3f(0x1bb))/0x6)+parseInt(_0x361f3f(0x1cd))/0x7+-parseInt(_0x361f3f(0x161))/0x8*(-parseInt(_0x361f3f(0x1af))/0x9)+parseInt(_0x361f3f(0x18f))/0xa;if(_0x19af32===_0x16d7c4)break;else _0x65487b['push'](_0x65487b['shift']());}catch(_0x20f851){_0x65487b['push'](_0x65487b['shift']());}}}(a40_0x1c99,0x2946e));Object['defineProperty'](exports,a40_0x5e26fe(0x1aa),{'value':!![]}),exports[a40_0x5e26fe(0x187)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPayService{constructor(){const _0x5df81d=a40_0x5e26fe;this[_0x5df81d(0x154)]=_0x5df81d(0x1a0),this[_0x5df81d(0x177)]=_0x5df81d(0x1ad),console['log'](_0x5df81d(0x15f)),console['log']('üìä\x20Status\x20check\x20URL:',this[_0x5df81d(0x177)]);}async['createPaymentLink'](_0xd145ee){const _0x5b0548=a40_0x5e26fe,{orderId:_0x5a6334,amount:_0x3116a0}=_0xd145ee;console[_0x5b0548(0x198)](_0x5b0548(0x1a9)+_0x3116a0+_0x5b0548(0x197));const _0x38ca={'amount':_0x3116a0},_0x4708e4=Date[_0x5b0548(0x19e)]();try{console[_0x5b0548(0x198)]('===\x20COINTOPAY\x20API\x20REQUEST\x20(White\x20Domain)\x20==='),console[_0x5b0548(0x198)](_0x5b0548(0x1c9),this[_0x5b0548(0x154)]),console['log'](_0x5b0548(0x175),JSON['stringify'](_0x38ca,null,0x2)),console['log'](_0x5b0548(0x170),_0x3116a0,_0x5b0548(0x191)),loggerService_1['loggerService'][_0x5b0548(0x167)]('cointopay','/create',_0x5b0548(0x166),_0x38ca);const _0x20b8d9=await fetch(this[_0x5b0548(0x154)],{'method':_0x5b0548(0x166),'headers':{'Content-Type':_0x5b0548(0x183),'Accept':_0x5b0548(0x183),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x38ca)}),_0x5e4ff8=Date[_0x5b0548(0x19e)]()-_0x4708e4;console['log'](_0x5b0548(0x171)),console[_0x5b0548(0x198)](_0x5b0548(0x1c3),_0x20b8d9[_0x5b0548(0x1c0)]),console[_0x5b0548(0x198)](_0x5b0548(0x159),_0x20b8d9[_0x5b0548(0x185)]),console[_0x5b0548(0x198)](_0x5b0548(0x180),Object[_0x5b0548(0x194)](_0x20b8d9[_0x5b0548(0x17e)][_0x5b0548(0x1a7)]())),console[_0x5b0548(0x198)](_0x5b0548(0x14a),_0x5e4ff8+'ms');const _0x1675fb=await _0x20b8d9[_0x5b0548(0x1ac)]();console['log'](_0x5b0548(0x1c8),_0x1675fb);if(!_0x20b8d9['ok']){console[_0x5b0548(0x199)](_0x5b0548(0x19c)),console[_0x5b0548(0x199)]('HTTP\x20Status:',_0x20b8d9['status']),console['error'](_0x5b0548(0x19d),_0x1675fb),loggerService_1[_0x5b0548(0x186)][_0x5b0548(0x162)](_0x5b0548(0x174),'/create',_0x20b8d9[_0x5b0548(0x1c0)],_0x1675fb,_0x5e4ff8),loggerService_1[_0x5b0548(0x186)][_0x5b0548(0x153)](_0x5b0548(0x174),'/create','HTTP\x20'+_0x20b8d9[_0x5b0548(0x1c0)]+':\x20'+_0x1675fb);throw new Error(_0x5b0548(0x1c4)+_0x20b8d9[_0x5b0548(0x1c0)]+',\x20body:\x20'+_0x1675fb);}let _0x85961c;try{_0x85961c=JSON[_0x5b0548(0x1a3)](_0x1675fb);}catch(_0x99addf){console[_0x5b0548(0x199)](_0x5b0548(0x176),_0x99addf),loggerService_1['loggerService'][_0x5b0548(0x153)](_0x5b0548(0x174),_0x5b0548(0x155),_0x5b0548(0x14e)+_0x99addf);throw new Error(_0x5b0548(0x15e)+_0x1675fb);}console[_0x5b0548(0x198)](_0x5b0548(0x16b)),console[_0x5b0548(0x198)](_0x5b0548(0x1c2),JSON[_0x5b0548(0x16e)](_0x85961c,null,0x2)),loggerService_1[_0x5b0548(0x186)][_0x5b0548(0x162)](_0x5b0548(0x174),_0x5b0548(0x155),_0x20b8d9['status'],_0x85961c,_0x5e4ff8);if(_0x85961c[_0x5b0548(0x199)]){const _0x5bffec=_0x85961c['message']||_0x85961c[_0x5b0548(0x199)]||'Unknown\x20error\x20from\x20CoinToPay\x20API';console[_0x5b0548(0x199)]('===\x20COINTOPAY\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x5b0548(0x199)](_0x5b0548(0x15d),_0x5bffec),loggerService_1[_0x5b0548(0x186)][_0x5b0548(0x153)](_0x5b0548(0x174),_0x5b0548(0x155),_0x5b0548(0x1a6)+_0x5bffec);throw new Error(_0x5b0548(0x1c6)+_0x5bffec);}if(!_0x85961c[_0x5b0548(0x15c)]||!_0x85961c[_0x5b0548(0x1b3)]){console[_0x5b0548(0x199)]('===\x20COINTOPAY\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x5b0548(0x199)](_0x5b0548(0x1b0)),console[_0x5b0548(0x199)](_0x5b0548(0x1bc),_0x85961c),loggerService_1[_0x5b0548(0x186)]['logWhiteDomainError'](_0x5b0548(0x174),_0x5b0548(0x155),_0x5b0548(0x14b));throw new Error(_0x5b0548(0x151));}return console[_0x5b0548(0x198)]('===\x20COINTOPAY\x20SUCCESS\x20==='),console[_0x5b0548(0x198)](_0x5b0548(0x18a),_0x85961c[_0x5b0548(0x1b3)]),console[_0x5b0548(0x198)](_0x5b0548(0x1a8),_0x85961c[_0x5b0548(0x15c)]),console[_0x5b0548(0x198)](_0x5b0548(0x170),_0x3116a0,_0x5b0548(0x18d)),{'gateway_payment_id':_0x85961c[_0x5b0548(0x1b3)],'payment_url':_0x85961c[_0x5b0548(0x15c)]};}catch(_0x391206){console[_0x5b0548(0x199)]('===\x20COINTOPAY\x20SERVICE\x20ERROR\x20==='),console[_0x5b0548(0x199)](_0x5b0548(0x157),_0x391206),loggerService_1['loggerService'][_0x5b0548(0x153)](_0x5b0548(0x174),'/create',_0x391206);if(_0x391206 instanceof Error){console[_0x5b0548(0x199)](_0x5b0548(0x16d),_0x391206['message']),console['error'](_0x5b0548(0x17c),_0x391206[_0x5b0548(0x1bd)]);throw new Error(_0x5b0548(0x16c)+_0x391206['message']);}throw new Error(_0x5b0548(0x1ab));}}async[a40_0x5e26fe(0x19a)](_0x2d155f){const _0x5f4bb5=a40_0x5e26fe,_0xb8c538=Date[_0x5f4bb5(0x19e)]();try{console['log']('üìä\x20Checking\x20CoinToPay\x20payment\x20status\x20for:\x20'+_0x2d155f);const _0x358eb6={'gatewayPaymentId':_0x2d155f};loggerService_1['loggerService'][_0x5f4bb5(0x167)](_0x5f4bb5(0x174),_0x5f4bb5(0x16f),_0x5f4bb5(0x166),_0x358eb6);const _0x18120a=await fetch(this['statusUrl'],{'method':_0x5f4bb5(0x166),'headers':{'Content-Type':_0x5f4bb5(0x183),'Accept':_0x5f4bb5(0x183),'User-Agent':_0x5f4bb5(0x190)},'body':JSON['stringify'](_0x358eb6)}),_0x3a5265=Date['now']()-_0xb8c538;console['log'](_0x5f4bb5(0x18c)),console[_0x5f4bb5(0x198)](_0x5f4bb5(0x1c3),_0x18120a['status']),console[_0x5f4bb5(0x198)](_0x5f4bb5(0x14a),_0x3a5265+'ms');if(!_0x18120a['ok']){const _0x36f83e=await _0x18120a[_0x5f4bb5(0x1ac)]();console[_0x5f4bb5(0x199)](_0x5f4bb5(0x16a),_0x18120a['status']),console[_0x5f4bb5(0x199)](_0x5f4bb5(0x19d),_0x36f83e),loggerService_1[_0x5f4bb5(0x186)][_0x5f4bb5(0x162)](_0x5f4bb5(0x174),_0x5f4bb5(0x16f),_0x18120a[_0x5f4bb5(0x1c0)],_0x36f83e,_0x3a5265),loggerService_1[_0x5f4bb5(0x186)]['logWhiteDomainError'](_0x5f4bb5(0x174),'/status',_0x5f4bb5(0x1b8)+_0x18120a[_0x5f4bb5(0x1c0)]+':\x20'+_0x36f83e);throw new Error(_0x5f4bb5(0x1c4)+_0x18120a[_0x5f4bb5(0x1c0)]);}const _0x534092=await _0x18120a[_0x5f4bb5(0x1ac)]();console[_0x5f4bb5(0x198)](_0x5f4bb5(0x1c8),_0x534092);let _0x5972a6;try{_0x5972a6=JSON[_0x5f4bb5(0x1a3)](_0x534092);}catch(_0x158952){console[_0x5f4bb5(0x199)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x158952),loggerService_1[_0x5f4bb5(0x186)]['logWhiteDomainError']('cointopay',_0x5f4bb5(0x16f),_0x5f4bb5(0x14e)+_0x158952);throw new Error(_0x5f4bb5(0x150)+_0x534092);}loggerService_1[_0x5f4bb5(0x186)][_0x5f4bb5(0x162)](_0x5f4bb5(0x174),'/status',_0x18120a[_0x5f4bb5(0x1c0)],_0x5972a6,_0x3a5265),console['log'](_0x5f4bb5(0x1a2)),console['log'](_0x5f4bb5(0x1b4),_0x5972a6['result']),console[_0x5f4bb5(0x198)](_0x5f4bb5(0x156),_0x5972a6[_0x5f4bb5(0x169)]),console[_0x5f4bb5(0x198)]('Payment\x20Status:',_0x5972a6[_0x5f4bb5(0x163)]?.[_0x5f4bb5(0x168)]),console[_0x5f4bb5(0x198)](_0x5f4bb5(0x170),_0x5972a6[_0x5f4bb5(0x163)]?.[_0x5f4bb5(0x1b1)]),console[_0x5f4bb5(0x198)](_0x5f4bb5(0x1c1),_0x5972a6[_0x5f4bb5(0x163)]?.[_0x5f4bb5(0x173)]);if(_0x5972a6[_0x5f4bb5(0x179)]!==_0x5f4bb5(0x1b6)||_0x5972a6[_0x5f4bb5(0x169)]!==0xc8){const _0x2ed691=_0x5972a6['message']||_0x5f4bb5(0x19f);console[_0x5f4bb5(0x199)](_0x5f4bb5(0x17f)),console[_0x5f4bb5(0x199)]('Error\x20Message:',_0x2ed691),loggerService_1[_0x5f4bb5(0x186)]['logWhiteDomainError'](_0x5f4bb5(0x174),_0x5f4bb5(0x16f),_0x5f4bb5(0x18e)+_0x2ed691);throw new Error('CoinToPay\x20status\x20API\x20error:\x20'+_0x2ed691);}if(!_0x5972a6[_0x5f4bb5(0x163)]){console[_0x5f4bb5(0x199)](_0x5f4bb5(0x1cb)),console[_0x5f4bb5(0x199)]('Missing\x20data\x20in\x20response'),loggerService_1[_0x5f4bb5(0x186)][_0x5f4bb5(0x153)](_0x5f4bb5(0x174),_0x5f4bb5(0x16f),_0x5f4bb5(0x19b));throw new Error(_0x5f4bb5(0x1a4));}let _0x7afd08=_0x5f4bb5(0x1bf);switch(_0x5972a6[_0x5f4bb5(0x163)][_0x5f4bb5(0x168)]?.['toLowerCase']()){case'paid':_0x7afd08=_0x5f4bb5(0x184);break;case _0x5f4bb5(0x1c7):case _0x5f4bb5(0x181):case _0x5f4bb5(0x199):_0x7afd08='FAILED';break;case _0x5f4bb5(0x172):case _0x5f4bb5(0x17a):_0x7afd08=_0x5f4bb5(0x1b9);break;case _0x5f4bb5(0x188):case _0x5f4bb5(0x1be):case _0x5f4bb5(0x1a1):case _0x5f4bb5(0x189):default:_0x7afd08=_0x5f4bb5(0x1bf);break;}let _0x217ada,_0x5ba4c6;if(_0x5972a6[_0x5f4bb5(0x163)]['PaymentDetail']){const _0x54d45b=_0x5972a6[_0x5f4bb5(0x163)][_0x5f4bb5(0x15b)];console[_0x5f4bb5(0x198)](_0x5f4bb5(0x1cc),_0x54d45b);const _0x138a30=_0x54d45b[_0x5f4bb5(0x18b)](/IBAN\s+([A-Z0-9]+)/i);_0x138a30&&(_0x217ada=_0x138a30[0x1],console['log'](_0x5f4bb5(0x178),_0x217ada)),_0x5ba4c6=_0x54d45b;}const _0x5bba11={'iban':_0x217ada,'bankDetails':_0x5ba4c6,'transactionId':_0x5972a6[_0x5f4bb5(0x163)][_0x5f4bb5(0x196)],'coinAddress':_0x5972a6['data']['coinAddress'],'qrCodeUrl':_0x5972a6[_0x5f4bb5(0x163)]['QRCodeURL'],'expiryTime':_0x5972a6[_0x5f4bb5(0x163)][_0x5f4bb5(0x1ba)],'createdOn':_0x5972a6[_0x5f4bb5(0x163)][_0x5f4bb5(0x160)],'confirmedOn':_0x5972a6['data'][_0x5f4bb5(0x1c5)]};console[_0x5f4bb5(0x198)](_0x5f4bb5(0x152)),console[_0x5f4bb5(0x198)](_0x5f4bb5(0x1c3),_0x5972a6[_0x5f4bb5(0x163)]['Status'],'->',_0x7afd08),console['log'](_0x5f4bb5(0x170),_0x5972a6[_0x5f4bb5(0x163)]['Amount'],_0x5972a6['data']['inputCurrency']),console[_0x5f4bb5(0x198)](_0x5f4bb5(0x17d),_0x5972a6[_0x5f4bb5(0x163)][_0x5f4bb5(0x196)]),console['log'](_0x5f4bb5(0x1ca),_0x217ada||'not\x20found'),console[_0x5f4bb5(0x198)]('Created\x20On:',_0x5972a6[_0x5f4bb5(0x163)][_0x5f4bb5(0x160)]),console[_0x5f4bb5(0x198)]('Confirmed\x20On:',_0x5972a6[_0x5f4bb5(0x163)]['TransactionConfirmedOn']||_0x5f4bb5(0x192));if(_0x5972a6['data'][_0x5f4bb5(0x168)]?.[_0x5f4bb5(0x1ae)]()===_0x5f4bb5(0x1be))console[_0x5f4bb5(0x198)](_0x5f4bb5(0x1b2));else _0x5972a6[_0x5f4bb5(0x163)][_0x5f4bb5(0x168)]?.[_0x5f4bb5(0x1ae)]()===_0x5f4bb5(0x158)&&console[_0x5f4bb5(0x198)](_0x5f4bb5(0x165));return{'status':_0x7afd08,'amount':parseFloat(_0x5972a6['data']['Amount'])||undefined,'currency':_0x5972a6[_0x5f4bb5(0x163)]['inputCurrency']||'EUR','paymentDetails':_0x5bba11};}catch(_0x2f5376){console['error']('CoinToPay\x20payment\x20status\x20check\x20error:',_0x2f5376),loggerService_1[_0x5f4bb5(0x186)]['logWhiteDomainError']('cointopay',_0x5f4bb5(0x16f),_0x2f5376);throw new Error(_0x5f4bb5(0x1b5)+(_0x2f5376 instanceof Error?_0x2f5376[_0x5f4bb5(0x14c)]:_0x5f4bb5(0x195)));}}async[a40_0x5e26fe(0x17b)](_0x39a147){const _0x553a6c=a40_0x5e26fe,_0x3b6b3b=await this[_0x553a6c(0x19a)](_0x39a147);return{'status':_0x3b6b3b['status'],'amount':_0x3b6b3b[_0x553a6c(0x14d)],'currency':_0x3b6b3b[_0x553a6c(0x14f)]};}async['processWebhook'](_0xd70722){const _0x261ec9=a40_0x5e26fe;console[_0x261ec9(0x198)]('Processing\x20CoinToPay\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0xd70722);let _0x130d85='PENDING';switch(_0xd70722['status']?.[_0x261ec9(0x1ae)]()){case _0x261ec9(0x158):_0x130d85='PAID';break;case _0x261ec9(0x1c7):case'failed':case'error':_0x130d85='FAILED';break;case _0x261ec9(0x172):case _0x261ec9(0x17a):_0x130d85=_0x261ec9(0x1b9);break;case'pending':case _0x261ec9(0x188):case _0x261ec9(0x1be):case _0x261ec9(0x189):default:_0x130d85=_0x261ec9(0x1bf);break;}return{'paymentId':_0xd70722['order_id']||_0xd70722[_0x261ec9(0x1b7)]||'','status':_0x130d85,'amount':_0xd70722[_0x261ec9(0x14d)],'currency':_0xd70722[_0x261ec9(0x14f)]||_0x261ec9(0x18d)};}}exports[a40_0x5e26fe(0x187)]=CoinToPayService;