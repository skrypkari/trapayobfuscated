'use strict';const a40_0xe56649=a40_0xcf7e;function a40_0x128e(){const _0x95c9e1=['status','TesSoft\x20Payment\x20System/1.0','8coaAVU','Missing\x20data\x20in\x20response','Unknown\x20error','text','Currency:','Response\x20data:','10prerSF','application/json','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','amount','paid','Parsed\x20Result:','now','Headers:','Response\x20Body:','===\x20COINTOPAY\x20STATUS\x20API\x20ERROR\x20===','IBAN:','ExpiryTime','Result:','Status:','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20API:\x20','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','__esModule','logWhiteDomainError','log','payment_url','18eIGgsc','Processing\x20CoinToPay\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','created','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','Business\x20Error:\x20','JSON\x20Parse\x20Error:\x20','Incomplete\x20response:\x20missing\x20data','cointopay','error','Amount:','logWhiteDomainResponse','4034485ZSnCTE','===\x20PARSED\x20COINTOPAY\x20RESPONSE\x20===','Confirmed\x20On:','HTTP\x20Status:','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20Unknown\x20error','FAILED','HTTP\x20error!\x20status:\x20','Invalid\x20response\x20from\x20CoinToPay\x20status\x20API:\x20missing\x20data','Created\x20On:','defineProperty','failed','parse','üìä\x20Status\x20check\x20URL:','Invalid\x20response\x20from\x20CoinToPay\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','Status','Request\x20Body:','currency','HTTP\x20','PENDING','status_code','headers','not\x20confirmed','üè¶\x20Payment\x20Detail:','Payment\x20Status:','\x20EUR','TransactionID','POST','gateway_payment_id','===\x20COINTOPAY\x20API\x20ERROR\x20===','createPaymentLink','Failed\x20to\x20parse\x20JSON\x20response:','===\x20COINTOPAY\x20STATUS\x20CHECK\x20RESPONSE\x20===','EUR\x20(always\x20EUR\x20for\x20CoinToPay)','PAID','Amount','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20status\x20API:\x20','QRCodeURL','stringify','apiUrl','checkPaymentStatus','CoinToPayService','waiting','pending','228320JJWIXN','Gateway\x20Payment\x20ID:','73802iczACI','Status\x20API\x20Error:\x20','9161581wntiPH','result','inputCurrency','message','logWhiteDomainRequest','===\x20COINTOPAY\x20SUCCESS\x20===','CoinToPay\x20API\x20error:\x20','üè¶\x20Extracted\x20IBAN:','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','cancelled','TransactionConfirmedOn','fromEntries','CoinToPay\x20status\x20API\x20error:\x20','5330380aLRjgr','===\x20COINTOPAY\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','statusText','data','success','Error\x20details:','loggerService','/create','Unknown\x20error\x20from\x20CoinToPay\x20status\x20API','===\x20COINTOPAY\x20SERVICE\x20ERROR\x20===','===\x20COINTOPAY\x20API\x20REQUEST\x20(White\x20Domain)\x20===','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20','https://tesoft.uk/gateway/cointopay/','Response\x20Time:','Transaction\x20ID:','EXPIRED','toLowerCase','Error\x20stack:','ü™ô\x20Creating\x20CoinToPay\x20payment:\x20','Unknown\x20error\x20from\x20CoinToPay\x20API','Error\x20message:','statusUrl','Raw\x20Response\x20Body:','timeout','order_id','Error\x20Message:','match','awaiting\x20fiat','EUR','864132aKxtmQ','verifyPayment','not\x20found','1RbjAlw','===\x20PARSED\x20COINTOPAY\x20STATUS\x20RESPONSE\x20===','Failed\x20to\x20check\x20CoinToPay\x20payment\x20status:\x20','/status','===\x20COINTOPAY\x20STATUS\x20SUCCESS\x20===','CreatedOn','Status\x20Code:','===\x20COINTOPAY\x20API\x20BUSINESS\x20ERROR\x20===','üìä\x20Checking\x20CoinToPay\x20payment\x20status\x20for:\x20','PaymentDetail','429264WJvaVu'];a40_0x128e=function(){return _0x95c9e1;};return a40_0x128e();}(function(_0x5cf8c3,_0x345878){const _0x4f526d=a40_0xcf7e,_0x508d59=_0x5cf8c3();while(!![]){try{const _0x51c752=parseInt(_0x4f526d(0x143))/0x1*(parseInt(_0x4f526d(0x114))/0x2)+parseInt(_0x4f526d(0x16a))/0x3*(parseInt(_0x4f526d(0x112))/0x4)+parseInt(_0x4f526d(0x156))/0x5*(-parseInt(_0x4f526d(0x140))/0x6)+-parseInt(_0x4f526d(0xe7))/0x7*(-parseInt(_0x4f526d(0x150))/0x8)+-parseInt(_0x4f526d(0x14d))/0x9+parseInt(_0x4f526d(0x123))/0xa+-parseInt(_0x4f526d(0x116))/0xb;if(_0x51c752===_0x345878)break;else _0x508d59['push'](_0x508d59['shift']());}catch(_0x3be5a1){_0x508d59['push'](_0x508d59['shift']());}}}(a40_0x128e,0x4e2a3));Object[a40_0xe56649(0xf0)](exports,a40_0xe56649(0x166),{'value':!![]}),exports[a40_0xe56649(0x10f)]=void 0x0;function a40_0xcf7e(_0x45bc7d,_0x5ca0a4){const _0x128e57=a40_0x128e();return a40_0xcf7e=function(_0xcf7eb,_0xbf6f08){_0xcf7eb=_0xcf7eb-0xe6;let _0x2f2c4a=_0x128e57[_0xcf7eb];return _0x2f2c4a;},a40_0xcf7e(_0x45bc7d,_0x5ca0a4);}const loggerService_1=require('../loggerService');class CoinToPayService{constructor(){const _0x1c2cdf=a40_0xe56649;this['apiUrl']=_0x1c2cdf(0x12f),this['statusUrl']='https://tesoft.uk/gateway/cointopay/status.php',console[_0x1c2cdf(0x168)]('ü™ô\x20CoinToPay\x20service\x20initialized\x20with\x20white\x20domain\x20proxy'),console['log'](_0x1c2cdf(0xf3),this[_0x1c2cdf(0x138)]);}async[a40_0xe56649(0x104)](_0xaafe1b){const _0x877c31=a40_0xe56649,{orderId:_0x4334f4,amount:_0x5a8153}=_0xaafe1b;console[_0x877c31(0x168)](_0x877c31(0x135)+_0x5a8153+_0x877c31(0xff));const _0x4f23be={'amount':_0x5a8153},_0x3d253b=Date[_0x877c31(0x15c)]();try{console[_0x877c31(0x168)](_0x877c31(0x12d)),console['log']('URL:',this[_0x877c31(0x10d)]),console[_0x877c31(0x168)](_0x877c31(0xf6),JSON[_0x877c31(0x10c)](_0x4f23be,null,0x2)),console[_0x877c31(0x168)](_0x877c31(0x173),_0x5a8153,_0x877c31(0x107)),loggerService_1[_0x877c31(0x129)][_0x877c31(0x11a)](_0x877c31(0x171),'/create',_0x877c31(0x101),_0x4f23be);const _0x2de824=await fetch(this[_0x877c31(0x10d)],{'method':'POST','headers':{'Content-Type':_0x877c31(0x157),'Accept':'application/json','User-Agent':_0x877c31(0x14f)},'body':JSON[_0x877c31(0x10c)](_0x4f23be)}),_0x3e6834=Date['now']()-_0x3d253b;console[_0x877c31(0x168)]('===\x20COINTOPAY\x20API\x20RESPONSE\x20(White\x20Domain)\x20==='),console[_0x877c31(0x168)](_0x877c31(0x163),_0x2de824[_0x877c31(0x14e)]),console['log']('Status\x20Text:',_0x2de824[_0x877c31(0x125)]),console['log'](_0x877c31(0x15d),Object[_0x877c31(0x121)](_0x2de824[_0x877c31(0xfb)]['entries']())),console[_0x877c31(0x168)](_0x877c31(0x130),_0x3e6834+'ms');const _0x38bdd9=await _0x2de824[_0x877c31(0x153)]();console[_0x877c31(0x168)](_0x877c31(0x139),_0x38bdd9);if(!_0x2de824['ok']){console[_0x877c31(0x172)](_0x877c31(0x103)),console[_0x877c31(0x172)](_0x877c31(0xea),_0x2de824[_0x877c31(0x14e)]),console['error'](_0x877c31(0x15e),_0x38bdd9),loggerService_1[_0x877c31(0x129)]['logWhiteDomainResponse']('cointopay',_0x877c31(0x12a),_0x2de824[_0x877c31(0x14e)],_0x38bdd9,_0x3e6834),loggerService_1[_0x877c31(0x129)][_0x877c31(0x167)](_0x877c31(0x171),_0x877c31(0x12a),_0x877c31(0xf8)+_0x2de824[_0x877c31(0x14e)]+':\x20'+_0x38bdd9);throw new Error(_0x877c31(0xed)+_0x2de824[_0x877c31(0x14e)]+',\x20body:\x20'+_0x38bdd9);}let _0x293cde;try{_0x293cde=JSON[_0x877c31(0xf2)](_0x38bdd9);}catch(_0x9464b){console[_0x877c31(0x172)](_0x877c31(0x105),_0x9464b),loggerService_1[_0x877c31(0x129)][_0x877c31(0x167)]('cointopay',_0x877c31(0x12a),_0x877c31(0x16f)+_0x9464b);throw new Error(_0x877c31(0x164)+_0x38bdd9);}console[_0x877c31(0x168)](_0x877c31(0xe8)),console[_0x877c31(0x168)](_0x877c31(0x15b),JSON['stringify'](_0x293cde,null,0x2)),loggerService_1[_0x877c31(0x129)]['logWhiteDomainResponse']('cointopay',_0x877c31(0x12a),_0x2de824[_0x877c31(0x14e)],_0x293cde,_0x3e6834);if(_0x293cde['error']){const _0x2a606c=_0x293cde[_0x877c31(0x119)]||_0x293cde[_0x877c31(0x172)]||_0x877c31(0x136);console['error'](_0x877c31(0x14a)),console[_0x877c31(0x172)](_0x877c31(0x13c),_0x2a606c),loggerService_1[_0x877c31(0x129)][_0x877c31(0x167)]('cointopay',_0x877c31(0x12a),_0x877c31(0x16e)+_0x2a606c);throw new Error(_0x877c31(0x11c)+_0x2a606c);}if(!_0x293cde['payment_url']||!_0x293cde[_0x877c31(0x102)]){console['error']('===\x20COINTOPAY\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x877c31(0x172)](_0x877c31(0x158)),console[_0x877c31(0x172)](_0x877c31(0x155),_0x293cde),loggerService_1[_0x877c31(0x129)][_0x877c31(0x167)](_0x877c31(0x171),'/create',_0x877c31(0x11e));throw new Error(_0x877c31(0xf4));}return console[_0x877c31(0x168)](_0x877c31(0x11b)),console['log'](_0x877c31(0x113),_0x293cde[_0x877c31(0x102)]),console[_0x877c31(0x168)]('Payment\x20URL:',_0x293cde[_0x877c31(0x169)]),console[_0x877c31(0x168)](_0x877c31(0x173),_0x5a8153,_0x877c31(0x13f)),{'gateway_payment_id':_0x293cde[_0x877c31(0x102)],'payment_url':_0x293cde[_0x877c31(0x169)]};}catch(_0x4e4112){console[_0x877c31(0x172)](_0x877c31(0x12c)),console[_0x877c31(0x172)](_0x877c31(0x128),_0x4e4112),loggerService_1[_0x877c31(0x129)]['logWhiteDomainError'](_0x877c31(0x171),_0x877c31(0x12a),_0x4e4112);if(_0x4e4112 instanceof Error){console['error'](_0x877c31(0x137),_0x4e4112[_0x877c31(0x119)]),console[_0x877c31(0x172)](_0x877c31(0x134),_0x4e4112['stack']);throw new Error(_0x877c31(0x12e)+_0x4e4112[_0x877c31(0x119)]);}throw new Error(_0x877c31(0xeb));}}async['checkPaymentStatus'](_0x28d9b2){const _0x425a4f=a40_0xe56649,_0x15a64c=Date[_0x425a4f(0x15c)]();try{console[_0x425a4f(0x168)](_0x425a4f(0x14b)+_0x28d9b2);const _0x3b877e={'gatewayPaymentId':_0x28d9b2};loggerService_1[_0x425a4f(0x129)][_0x425a4f(0x11a)](_0x425a4f(0x171),'/status',_0x425a4f(0x101),_0x3b877e);const _0x2d01ca=await fetch(this['statusUrl'],{'method':_0x425a4f(0x101),'headers':{'Content-Type':_0x425a4f(0x157),'Accept':_0x425a4f(0x157),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x425a4f(0x10c)](_0x3b877e)}),_0x2f579c=Date[_0x425a4f(0x15c)]()-_0x15a64c;console['log'](_0x425a4f(0x106)),console[_0x425a4f(0x168)](_0x425a4f(0x163),_0x2d01ca['status']),console[_0x425a4f(0x168)](_0x425a4f(0x130),_0x2f579c+'ms');if(!_0x2d01ca['ok']){const _0x16d1a5=await _0x2d01ca['text']();console['error'](_0x425a4f(0xea),_0x2d01ca[_0x425a4f(0x14e)]),console[_0x425a4f(0x172)](_0x425a4f(0x15e),_0x16d1a5),loggerService_1[_0x425a4f(0x129)]['logWhiteDomainResponse'](_0x425a4f(0x171),_0x425a4f(0x146),_0x2d01ca[_0x425a4f(0x14e)],_0x16d1a5,_0x2f579c),loggerService_1[_0x425a4f(0x129)][_0x425a4f(0x167)](_0x425a4f(0x171),'/status','HTTP\x20'+_0x2d01ca['status']+':\x20'+_0x16d1a5);throw new Error('HTTP\x20error!\x20status:\x20'+_0x2d01ca['status']);}const _0x4b1cf3=await _0x2d01ca[_0x425a4f(0x153)]();console['log'](_0x425a4f(0x139),_0x4b1cf3);let _0x1ca9ac;try{_0x1ca9ac=JSON[_0x425a4f(0xf2)](_0x4b1cf3);}catch(_0x33bb9b){console[_0x425a4f(0x172)](_0x425a4f(0x105),_0x33bb9b),loggerService_1[_0x425a4f(0x129)][_0x425a4f(0x167)](_0x425a4f(0x171),_0x425a4f(0x146),_0x425a4f(0x16f)+_0x33bb9b);throw new Error(_0x425a4f(0x10a)+_0x4b1cf3);}loggerService_1['loggerService'][_0x425a4f(0xe6)](_0x425a4f(0x171),_0x425a4f(0x146),_0x2d01ca[_0x425a4f(0x14e)],_0x1ca9ac,_0x2f579c),console[_0x425a4f(0x168)](_0x425a4f(0x144)),console[_0x425a4f(0x168)](_0x425a4f(0x162),_0x1ca9ac[_0x425a4f(0x117)]),console[_0x425a4f(0x168)](_0x425a4f(0x149),_0x1ca9ac[_0x425a4f(0xfa)]),console['log'](_0x425a4f(0xfe),_0x1ca9ac[_0x425a4f(0x126)]?.[_0x425a4f(0xf5)]),console[_0x425a4f(0x168)](_0x425a4f(0x173),_0x1ca9ac['data']?.[_0x425a4f(0x109)]),console['log'](_0x425a4f(0x154),_0x1ca9ac['data']?.[_0x425a4f(0x118)]);if(_0x1ca9ac['result']!==_0x425a4f(0x127)||_0x1ca9ac[_0x425a4f(0xfa)]!==0xc8){const _0x40801e=_0x1ca9ac[_0x425a4f(0x119)]||_0x425a4f(0x12b);console[_0x425a4f(0x172)](_0x425a4f(0x15f)),console[_0x425a4f(0x172)](_0x425a4f(0x13c),_0x40801e),loggerService_1['loggerService'][_0x425a4f(0x167)](_0x425a4f(0x171),_0x425a4f(0x146),_0x425a4f(0x115)+_0x40801e);throw new Error(_0x425a4f(0x122)+_0x40801e);}if(!_0x1ca9ac[_0x425a4f(0x126)]){console[_0x425a4f(0x172)](_0x425a4f(0x124)),console[_0x425a4f(0x172)](_0x425a4f(0x151)),loggerService_1[_0x425a4f(0x129)][_0x425a4f(0x167)](_0x425a4f(0x171),_0x425a4f(0x146),_0x425a4f(0x170));throw new Error(_0x425a4f(0xee));}let _0x2c6a13='PENDING';switch(_0x1ca9ac[_0x425a4f(0x126)][_0x425a4f(0xf5)]?.[_0x425a4f(0x133)]()){case'paid':_0x2c6a13=_0x425a4f(0x108);break;case _0x425a4f(0x11f):case _0x425a4f(0xf1):case _0x425a4f(0x172):_0x2c6a13=_0x425a4f(0xec);break;case'expired':case'timeout':_0x2c6a13=_0x425a4f(0x132);break;case _0x425a4f(0x110):case'awaiting\x20fiat':case _0x425a4f(0x111):case _0x425a4f(0x16c):default:_0x2c6a13=_0x425a4f(0xf9);break;}let _0x3bdb15,_0x368f1a;if(_0x1ca9ac[_0x425a4f(0x126)][_0x425a4f(0x14c)]){const _0x1bbbd8=_0x1ca9ac[_0x425a4f(0x126)]['PaymentDetail'];console[_0x425a4f(0x168)](_0x425a4f(0xfd),_0x1bbbd8);const _0x3f3864=_0x1bbbd8[_0x425a4f(0x13d)](/IBAN\s+([A-Z0-9]+)/i);_0x3f3864&&(_0x3bdb15=_0x3f3864[0x1],console[_0x425a4f(0x168)](_0x425a4f(0x11d),_0x3bdb15)),_0x368f1a=_0x1bbbd8;}const _0x2189ee={'iban':_0x3bdb15,'bankDetails':_0x368f1a,'transactionId':_0x1ca9ac[_0x425a4f(0x126)][_0x425a4f(0x100)],'coinAddress':_0x1ca9ac[_0x425a4f(0x126)]['coinAddress'],'qrCodeUrl':_0x1ca9ac[_0x425a4f(0x126)][_0x425a4f(0x10b)],'expiryTime':_0x1ca9ac[_0x425a4f(0x126)][_0x425a4f(0x161)],'createdOn':_0x1ca9ac[_0x425a4f(0x126)][_0x425a4f(0x148)],'confirmedOn':_0x1ca9ac['data']['TransactionConfirmedOn']};console[_0x425a4f(0x168)](_0x425a4f(0x147)),console['log'](_0x425a4f(0x163),_0x1ca9ac[_0x425a4f(0x126)][_0x425a4f(0xf5)],'->',_0x2c6a13),console[_0x425a4f(0x168)]('Amount:',_0x1ca9ac['data'][_0x425a4f(0x109)],_0x1ca9ac[_0x425a4f(0x126)][_0x425a4f(0x118)]),console['log'](_0x425a4f(0x131),_0x1ca9ac[_0x425a4f(0x126)][_0x425a4f(0x100)]),console[_0x425a4f(0x168)](_0x425a4f(0x160),_0x3bdb15||_0x425a4f(0x142)),console[_0x425a4f(0x168)](_0x425a4f(0xef),_0x1ca9ac['data'][_0x425a4f(0x148)]),console['log'](_0x425a4f(0xe9),_0x1ca9ac[_0x425a4f(0x126)][_0x425a4f(0x120)]||_0x425a4f(0xfc));if(_0x1ca9ac[_0x425a4f(0x126)]['Status']?.['toLowerCase']()===_0x425a4f(0x13e))console[_0x425a4f(0x168)](_0x425a4f(0x165));else _0x1ca9ac[_0x425a4f(0x126)][_0x425a4f(0xf5)]?.[_0x425a4f(0x133)]()===_0x425a4f(0x15a)&&console[_0x425a4f(0x168)](_0x425a4f(0x16d));return{'status':_0x2c6a13,'amount':parseFloat(_0x1ca9ac[_0x425a4f(0x126)][_0x425a4f(0x109)])||undefined,'currency':_0x1ca9ac[_0x425a4f(0x126)]['inputCurrency']||_0x425a4f(0x13f),'paymentDetails':_0x2189ee};}catch(_0x4d84e3){console['error']('CoinToPay\x20payment\x20status\x20check\x20error:',_0x4d84e3),loggerService_1[_0x425a4f(0x129)][_0x425a4f(0x167)]('cointopay',_0x425a4f(0x146),_0x4d84e3);throw new Error(_0x425a4f(0x145)+(_0x4d84e3 instanceof Error?_0x4d84e3['message']:_0x425a4f(0x152)));}}async[a40_0xe56649(0x141)](_0x3603dd){const _0x415983=a40_0xe56649,_0x4e5677=await this[_0x415983(0x10e)](_0x3603dd);return{'status':_0x4e5677[_0x415983(0x14e)],'amount':_0x4e5677[_0x415983(0x159)],'currency':_0x4e5677[_0x415983(0xf7)]};}async['processWebhook'](_0x1e0154){const _0x129d34=a40_0xe56649;console[_0x129d34(0x168)](_0x129d34(0x16b),_0x1e0154);let _0x1a070b=_0x129d34(0xf9);switch(_0x1e0154['status']?.[_0x129d34(0x133)]()){case'paid':_0x1a070b=_0x129d34(0x108);break;case _0x129d34(0x11f):case _0x129d34(0xf1):case _0x129d34(0x172):_0x1a070b=_0x129d34(0xec);break;case'expired':case _0x129d34(0x13a):_0x1a070b=_0x129d34(0x132);break;case _0x129d34(0x111):case _0x129d34(0x110):case _0x129d34(0x13e):case _0x129d34(0x16c):default:_0x1a070b=_0x129d34(0xf9);break;}return{'paymentId':_0x1e0154[_0x129d34(0x13b)]||_0x1e0154['merchant_reference_id']||'','status':_0x1a070b,'amount':_0x1e0154[_0x129d34(0x159)],'currency':_0x1e0154[_0x129d34(0xf7)]||_0x129d34(0x13f)};}}exports[a40_0xe56649(0x10f)]=CoinToPayService;