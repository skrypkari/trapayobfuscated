'use strict';const a40_0x2aa08d=a40_0x357f;function a40_0x357f(_0x101ca0,_0x212c40){const _0x22053f=a40_0x2205();return a40_0x357f=function(_0x357fd7,_0x164aa1){_0x357fd7=_0x357fd7-0x85;let _0xfcffac=_0x22053f[_0x357fd7];return _0xfcffac;},a40_0x357f(_0x101ca0,_0x212c40);}(function(_0x5e88d4,_0x3e298c){const _0x166ce1=a40_0x357f,_0x53e7b7=_0x5e88d4();while(!![]){try{const _0x5a514a=-parseInt(_0x166ce1(0xb4))/0x1+parseInt(_0x166ce1(0xba))/0x2+parseInt(_0x166ce1(0x88))/0x3+parseInt(_0x166ce1(0xee))/0x4*(parseInt(_0x166ce1(0xd7))/0x5)+-parseInt(_0x166ce1(0xcf))/0x6*(parseInt(_0x166ce1(0xf8))/0x7)+-parseInt(_0x166ce1(0xb5))/0x8+parseInt(_0x166ce1(0xa2))/0x9;if(_0x5a514a===_0x3e298c)break;else _0x53e7b7['push'](_0x53e7b7['shift']());}catch(_0x5752e0){_0x53e7b7['push'](_0x53e7b7['shift']());}}}(a40_0x2205,0x83dd8));Object[a40_0x2aa08d(0xc5)](exports,'__esModule',{'value':!![]}),exports[a40_0x2aa08d(0xde)]=void 0x0;function a40_0x2205(){const _0xab2220=['/status','Response\x20Body:','failed','PENDING','Invalid\x20response\x20from\x20CoinToPay\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','inputCurrency','\x20EUR','coinAddress','HTTP\x20Status:','not\x20found','447279fEazRW','Unknown\x20error\x20from\x20CoinToPay\x20status\x20API','timeout','merchant_reference_id','TesSoft\x20Payment\x20System/1.0','/create','stack','error','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','===\x20COINTOPAY\x20SUCCESS\x20===','CreatedOn','===\x20COINTOPAY\x20SERVICE\x20ERROR\x20===','Gateway\x20Payment\x20ID:','Unknown\x20error','headers','log','statusUrl','createPaymentLink','QRCodeURL','Business\x20Error:\x20','loggerService','stringify','message','match','EXPIRED','CoinToPay\x20status\x20API\x20error:\x20','309924whGHmM','checkPaymentStatus','amount','EUR\x20(always\x20EUR\x20for\x20CoinToPay)','HTTP\x20error!\x20status:\x20','created','text','Failed\x20to\x20check\x20CoinToPay\x20payment\x20status:\x20','Payment\x20Status:','===\x20COINTOPAY\x20API\x20ERROR\x20===','status','order_id','Missing\x20data\x20in\x20response','ü™ô\x20CoinToPay\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','Status\x20Code:','Error\x20Message:','Response\x20data:','===\x20PARSED\x20COINTOPAY\x20RESPONSE\x20===','573128JrcDnf','2519768BLHndd','===\x20COINTOPAY\x20STATUS\x20API\x20ERROR\x20===','toLowerCase','logWhiteDomainResponse','PaymentDetail','1452910EjQPIW','Error\x20stack:','processWebhook','waiting','https://tesoft.uk/gateway/cointopay/','Transaction\x20ID:',',\x20body:\x20','cointopay','Created\x20On:','Currency:','TransactionConfirmedOn','defineProperty','POST','cancelled','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Status\x20Text:','currency','Amount:','now','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20API:\x20','paid','22242UFpAma','Invalid\x20response\x20from\x20CoinToPay\x20status\x20API:\x20missing\x20data','===\x20COINTOPAY\x20API\x20INCOMPLETE\x20RESPONSE\x20===','logWhiteDomainRequest','ü™ô\x20Creating\x20CoinToPay\x20payment:\x20','gateway_payment_id','JSON\x20Parse\x20Error:\x20','Amount','145LXSABU','success','parse','not\x20confirmed','===\x20COINTOPAY\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','===\x20PARSED\x20COINTOPAY\x20STATUS\x20RESPONSE\x20===','IBAN:','CoinToPayService','Status\x20API\x20Error:\x20','URL:','application/json','Raw\x20Response\x20Body:','PAID','ExpiryTime','Status:','expired','===\x20COINTOPAY\x20API\x20BUSINESS\x20ERROR\x20===','üìä\x20Checking\x20CoinToPay\x20payment\x20status\x20for:\x20','Payment\x20URL:','logWhiteDomainError','Response\x20Time:','Request\x20Body:','FAILED','146132VamFcu','awaiting\x20fiat','EUR','Status','status_code','result','apiUrl','üè¶\x20Payment\x20Detail:','data','Parsed\x20Result:','1022Jitwqe','fromEntries','statusText','Error\x20details:','pending','https://tesoft.uk/gateway/cointopay/status.php','TransactionID'];a40_0x2205=function(){return _0xab2220;};return a40_0x2205();}const loggerService_1=require('../loggerService');class CoinToPayService{constructor(){const _0x2bdad7=a40_0x2aa08d;this[_0x2bdad7(0xf4)]=_0x2bdad7(0xbe),this[_0x2bdad7(0x98)]=_0x2bdad7(0xfd),console[_0x2bdad7(0x97)](_0x2bdad7(0xaf)),console[_0x2bdad7(0x97)]('üìä\x20Status\x20check\x20URL:',this[_0x2bdad7(0x98)]);}async[a40_0x2aa08d(0x99)](_0x5e3eed){const _0x40dbd9=a40_0x2aa08d,{orderId:_0x25f68c,amount:_0x336569}=_0x5e3eed;console[_0x40dbd9(0x97)](_0x40dbd9(0xd3)+_0x336569+_0x40dbd9(0x105));const _0x238912={'amount':_0x336569},_0x27a5b3=Date[_0x40dbd9(0xcc)]();try{console['log']('===\x20COINTOPAY\x20API\x20REQUEST\x20(White\x20Domain)\x20==='),console[_0x40dbd9(0x97)](_0x40dbd9(0xe0),this[_0x40dbd9(0xf4)]),console['log'](_0x40dbd9(0xec),JSON[_0x40dbd9(0x9d)](_0x238912,null,0x2)),console[_0x40dbd9(0x97)](_0x40dbd9(0xcb),_0x336569,_0x40dbd9(0xa5)),loggerService_1[_0x40dbd9(0x9c)][_0x40dbd9(0xd2)]('cointopay',_0x40dbd9(0x8d),_0x40dbd9(0xc6),_0x238912);const _0x4353d0=await fetch(this[_0x40dbd9(0xf4)],{'method':'POST','headers':{'Content-Type':_0x40dbd9(0xe1),'Accept':_0x40dbd9(0xe1),'User-Agent':_0x40dbd9(0x8c)},'body':JSON[_0x40dbd9(0x9d)](_0x238912)}),_0x596178=Date[_0x40dbd9(0xcc)]()-_0x27a5b3;console[_0x40dbd9(0x97)](_0x40dbd9(0xdb)),console[_0x40dbd9(0x97)](_0x40dbd9(0xe5),_0x4353d0[_0x40dbd9(0xac)]),console[_0x40dbd9(0x97)](_0x40dbd9(0xc9),_0x4353d0[_0x40dbd9(0xfa)]),console[_0x40dbd9(0x97)]('Headers:',Object[_0x40dbd9(0xf9)](_0x4353d0[_0x40dbd9(0x96)]['entries']())),console[_0x40dbd9(0x97)](_0x40dbd9(0xeb),_0x596178+'ms');const _0x62fe06=await _0x4353d0['text']();console['log'](_0x40dbd9(0xe2),_0x62fe06);if(!_0x4353d0['ok']){console['error'](_0x40dbd9(0xab)),console[_0x40dbd9(0x8f)](_0x40dbd9(0x86),_0x4353d0['status']),console[_0x40dbd9(0x8f)](_0x40dbd9(0x100),_0x62fe06),loggerService_1[_0x40dbd9(0x9c)][_0x40dbd9(0xb8)](_0x40dbd9(0xc1),'/create',_0x4353d0[_0x40dbd9(0xac)],_0x62fe06,_0x596178),loggerService_1[_0x40dbd9(0x9c)][_0x40dbd9(0xea)]('cointopay',_0x40dbd9(0x8d),'HTTP\x20'+_0x4353d0[_0x40dbd9(0xac)]+':\x20'+_0x62fe06);throw new Error(_0x40dbd9(0xa6)+_0x4353d0[_0x40dbd9(0xac)]+_0x40dbd9(0xc0)+_0x62fe06);}let _0x26b242;try{_0x26b242=JSON[_0x40dbd9(0xd9)](_0x62fe06);}catch(_0x1f2333){console[_0x40dbd9(0x8f)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x1f2333),loggerService_1[_0x40dbd9(0x9c)][_0x40dbd9(0xea)](_0x40dbd9(0xc1),_0x40dbd9(0x8d),_0x40dbd9(0xd5)+_0x1f2333);throw new Error(_0x40dbd9(0xcd)+_0x62fe06);}console[_0x40dbd9(0x97)](_0x40dbd9(0xb3)),console[_0x40dbd9(0x97)](_0x40dbd9(0xf7),JSON['stringify'](_0x26b242,null,0x2)),loggerService_1[_0x40dbd9(0x9c)][_0x40dbd9(0xb8)](_0x40dbd9(0xc1),_0x40dbd9(0x8d),_0x4353d0[_0x40dbd9(0xac)],_0x26b242,_0x596178);if(_0x26b242[_0x40dbd9(0x8f)]){const _0x24f2bf=_0x26b242[_0x40dbd9(0x9e)]||_0x26b242[_0x40dbd9(0x8f)]||'Unknown\x20error\x20from\x20CoinToPay\x20API';console[_0x40dbd9(0x8f)](_0x40dbd9(0xe7)),console[_0x40dbd9(0x8f)](_0x40dbd9(0xb1),_0x24f2bf),loggerService_1['loggerService'][_0x40dbd9(0xea)](_0x40dbd9(0xc1),_0x40dbd9(0x8d),_0x40dbd9(0x9b)+_0x24f2bf);throw new Error('CoinToPay\x20API\x20error:\x20'+_0x24f2bf);}if(!_0x26b242['payment_url']||!_0x26b242[_0x40dbd9(0xd4)]){console[_0x40dbd9(0x8f)](_0x40dbd9(0xd1)),console['error'](_0x40dbd9(0x90)),console['error'](_0x40dbd9(0xb2),_0x26b242),loggerService_1[_0x40dbd9(0x9c)][_0x40dbd9(0xea)](_0x40dbd9(0xc1),_0x40dbd9(0x8d),'Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error(_0x40dbd9(0x103));}return console[_0x40dbd9(0x97)](_0x40dbd9(0x91)),console[_0x40dbd9(0x97)](_0x40dbd9(0x94),_0x26b242[_0x40dbd9(0xd4)]),console[_0x40dbd9(0x97)](_0x40dbd9(0xe9),_0x26b242['payment_url']),console[_0x40dbd9(0x97)](_0x40dbd9(0xcb),_0x336569,_0x40dbd9(0xf0)),{'gateway_payment_id':_0x26b242[_0x40dbd9(0xd4)],'payment_url':_0x26b242['payment_url']};}catch(_0x201bc7){console['error'](_0x40dbd9(0x93)),console[_0x40dbd9(0x8f)](_0x40dbd9(0xfb),_0x201bc7),loggerService_1[_0x40dbd9(0x9c)]['logWhiteDomainError']('cointopay','/create',_0x201bc7);if(_0x201bc7 instanceof Error){console[_0x40dbd9(0x8f)]('Error\x20message:',_0x201bc7[_0x40dbd9(0x9e)]),console[_0x40dbd9(0x8f)](_0x40dbd9(0xbb),_0x201bc7[_0x40dbd9(0x8e)]);throw new Error('Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20'+_0x201bc7['message']);}throw new Error('Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20Unknown\x20error');}}async[a40_0x2aa08d(0xa3)](_0x419794){const _0x324a3e=a40_0x2aa08d,_0x187ca0=Date[_0x324a3e(0xcc)]();try{console[_0x324a3e(0x97)](_0x324a3e(0xe8)+_0x419794);const _0x363909={'gatewayPaymentId':_0x419794};loggerService_1[_0x324a3e(0x9c)][_0x324a3e(0xd2)](_0x324a3e(0xc1),_0x324a3e(0xff),'POST',_0x363909);const _0x3f14e3=await fetch(this[_0x324a3e(0x98)],{'method':_0x324a3e(0xc6),'headers':{'Content-Type':'application/json','Accept':_0x324a3e(0xe1),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x324a3e(0x9d)](_0x363909)}),_0x315c44=Date[_0x324a3e(0xcc)]()-_0x187ca0;console[_0x324a3e(0x97)]('===\x20COINTOPAY\x20STATUS\x20CHECK\x20RESPONSE\x20==='),console[_0x324a3e(0x97)](_0x324a3e(0xe5),_0x3f14e3[_0x324a3e(0xac)]),console[_0x324a3e(0x97)](_0x324a3e(0xeb),_0x315c44+'ms');if(!_0x3f14e3['ok']){const _0x4d1f47=await _0x3f14e3[_0x324a3e(0xa8)]();console[_0x324a3e(0x8f)](_0x324a3e(0x86),_0x3f14e3[_0x324a3e(0xac)]),console[_0x324a3e(0x8f)](_0x324a3e(0x100),_0x4d1f47),loggerService_1[_0x324a3e(0x9c)][_0x324a3e(0xb8)](_0x324a3e(0xc1),'/status',_0x3f14e3[_0x324a3e(0xac)],_0x4d1f47,_0x315c44),loggerService_1[_0x324a3e(0x9c)][_0x324a3e(0xea)](_0x324a3e(0xc1),'/status','HTTP\x20'+_0x3f14e3[_0x324a3e(0xac)]+':\x20'+_0x4d1f47);throw new Error(_0x324a3e(0xa6)+_0x3f14e3[_0x324a3e(0xac)]);}const _0x343b17=await _0x3f14e3[_0x324a3e(0xa8)]();console['log']('Raw\x20Response\x20Body:',_0x343b17);let _0xd9367c;try{_0xd9367c=JSON[_0x324a3e(0xd9)](_0x343b17);}catch(_0x4e25ba){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0x4e25ba),loggerService_1['loggerService'][_0x324a3e(0xea)](_0x324a3e(0xc1),_0x324a3e(0xff),_0x324a3e(0xd5)+_0x4e25ba);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20status\x20API:\x20'+_0x343b17);}loggerService_1[_0x324a3e(0x9c)][_0x324a3e(0xb8)](_0x324a3e(0xc1),'/status',_0x3f14e3[_0x324a3e(0xac)],_0xd9367c,_0x315c44),console['log'](_0x324a3e(0xdc)),console['log']('Result:',_0xd9367c[_0x324a3e(0xf3)]),console[_0x324a3e(0x97)](_0x324a3e(0xb0),_0xd9367c[_0x324a3e(0xf2)]),console['log'](_0x324a3e(0xaa),_0xd9367c[_0x324a3e(0xf6)]?.[_0x324a3e(0xf1)]),console[_0x324a3e(0x97)](_0x324a3e(0xcb),_0xd9367c[_0x324a3e(0xf6)]?.[_0x324a3e(0xd6)]),console['log'](_0x324a3e(0xc3),_0xd9367c[_0x324a3e(0xf6)]?.[_0x324a3e(0x104)]);if(_0xd9367c[_0x324a3e(0xf3)]!==_0x324a3e(0xd8)||_0xd9367c[_0x324a3e(0xf2)]!==0xc8){const _0x12e31c=_0xd9367c[_0x324a3e(0x9e)]||_0x324a3e(0x89);console[_0x324a3e(0x8f)](_0x324a3e(0xb6)),console[_0x324a3e(0x8f)](_0x324a3e(0xb1),_0x12e31c),loggerService_1[_0x324a3e(0x9c)][_0x324a3e(0xea)](_0x324a3e(0xc1),_0x324a3e(0xff),_0x324a3e(0xdf)+_0x12e31c);throw new Error(_0x324a3e(0xa1)+_0x12e31c);}if(!_0xd9367c[_0x324a3e(0xf6)]){console[_0x324a3e(0x8f)]('===\x20COINTOPAY\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x324a3e(0x8f)](_0x324a3e(0xae)),loggerService_1[_0x324a3e(0x9c)][_0x324a3e(0xea)](_0x324a3e(0xc1),_0x324a3e(0xff),'Incomplete\x20response:\x20missing\x20data');throw new Error(_0x324a3e(0xd0));}let _0x5cc866=_0x324a3e(0x102);switch(_0xd9367c[_0x324a3e(0xf6)][_0x324a3e(0xf1)]?.[_0x324a3e(0xb7)]()){case'paid':_0x5cc866=_0x324a3e(0xe3);break;case'cancelled':case _0x324a3e(0x101):case'error':_0x5cc866=_0x324a3e(0xed);break;case _0x324a3e(0xe6):case _0x324a3e(0x8a):_0x5cc866='EXPIRED';break;case _0x324a3e(0xbd):case _0x324a3e(0xef):case _0x324a3e(0xfc):case _0x324a3e(0xa7):default:_0x5cc866='PENDING';break;}let _0x43c49e,_0x5db2cf;if(_0xd9367c[_0x324a3e(0xf6)][_0x324a3e(0xb9)]){const _0x5d1b6d=_0xd9367c['data'][_0x324a3e(0xb9)];console[_0x324a3e(0x97)](_0x324a3e(0xf5),_0x5d1b6d);const _0x392aaf=_0x5d1b6d[_0x324a3e(0x9f)](/IBAN\s+([A-Z0-9]+)/i);_0x392aaf&&(_0x43c49e=_0x392aaf[0x1],console[_0x324a3e(0x97)]('üè¶\x20Extracted\x20IBAN:',_0x43c49e)),_0x5db2cf=_0x5d1b6d;}const _0x461165={'iban':_0x43c49e,'bankDetails':_0x5db2cf,'transactionId':_0xd9367c[_0x324a3e(0xf6)]['TransactionID'],'coinAddress':_0xd9367c['data'][_0x324a3e(0x85)],'qrCodeUrl':_0xd9367c[_0x324a3e(0xf6)][_0x324a3e(0x9a)],'expiryTime':_0xd9367c[_0x324a3e(0xf6)][_0x324a3e(0xe4)],'createdOn':_0xd9367c[_0x324a3e(0xf6)]['CreatedOn'],'confirmedOn':_0xd9367c[_0x324a3e(0xf6)][_0x324a3e(0xc4)]};console[_0x324a3e(0x97)]('===\x20COINTOPAY\x20STATUS\x20SUCCESS\x20==='),console['log'](_0x324a3e(0xe5),_0xd9367c['data']['Status'],'->',_0x5cc866),console[_0x324a3e(0x97)](_0x324a3e(0xcb),_0xd9367c[_0x324a3e(0xf6)][_0x324a3e(0xd6)],_0xd9367c[_0x324a3e(0xf6)]['inputCurrency']),console[_0x324a3e(0x97)](_0x324a3e(0xbf),_0xd9367c['data'][_0x324a3e(0xfe)]),console[_0x324a3e(0x97)](_0x324a3e(0xdd),_0x43c49e||_0x324a3e(0x87)),console[_0x324a3e(0x97)](_0x324a3e(0xc2),_0xd9367c[_0x324a3e(0xf6)][_0x324a3e(0x92)]),console[_0x324a3e(0x97)]('Confirmed\x20On:',_0xd9367c[_0x324a3e(0xf6)][_0x324a3e(0xc4)]||_0x324a3e(0xda));if(_0xd9367c[_0x324a3e(0xf6)]['Status']?.[_0x324a3e(0xb7)]()==='awaiting\x20fiat')console[_0x324a3e(0x97)](_0x324a3e(0xc8));else _0xd9367c['data'][_0x324a3e(0xf1)]?.[_0x324a3e(0xb7)]()===_0x324a3e(0xce)&&console['log']('‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID');return{'status':_0x5cc866,'amount':parseFloat(_0xd9367c[_0x324a3e(0xf6)][_0x324a3e(0xd6)])||undefined,'currency':_0xd9367c[_0x324a3e(0xf6)][_0x324a3e(0x104)]||'EUR','paymentDetails':_0x461165};}catch(_0x407705){console[_0x324a3e(0x8f)]('CoinToPay\x20payment\x20status\x20check\x20error:',_0x407705),loggerService_1[_0x324a3e(0x9c)][_0x324a3e(0xea)](_0x324a3e(0xc1),_0x324a3e(0xff),_0x407705);throw new Error(_0x324a3e(0xa9)+(_0x407705 instanceof Error?_0x407705['message']:_0x324a3e(0x95)));}}async['verifyPayment'](_0x457d03){const _0x1369d7=a40_0x2aa08d,_0x93faee=await this['checkPaymentStatus'](_0x457d03);return{'status':_0x93faee[_0x1369d7(0xac)],'amount':_0x93faee[_0x1369d7(0xa4)],'currency':_0x93faee['currency']};}async[a40_0x2aa08d(0xbc)](_0x1ae61f){const _0x4bea31=a40_0x2aa08d;console[_0x4bea31(0x97)]('Processing\x20CoinToPay\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x1ae61f);let _0x185af3=_0x4bea31(0x102);switch(_0x1ae61f[_0x4bea31(0xac)]?.[_0x4bea31(0xb7)]()){case'paid':_0x185af3=_0x4bea31(0xe3);break;case _0x4bea31(0xc7):case _0x4bea31(0x101):case _0x4bea31(0x8f):_0x185af3=_0x4bea31(0xed);break;case'expired':case _0x4bea31(0x8a):_0x185af3=_0x4bea31(0xa0);break;case _0x4bea31(0xfc):case _0x4bea31(0xbd):case _0x4bea31(0xef):case'created':default:_0x185af3=_0x4bea31(0x102);break;}return{'paymentId':_0x1ae61f[_0x4bea31(0xad)]||_0x1ae61f[_0x4bea31(0x8b)]||'','status':_0x185af3,'amount':_0x1ae61f['amount'],'currency':_0x1ae61f[_0x4bea31(0xca)]||'EUR'};}}exports[a40_0x2aa08d(0xde)]=CoinToPayService;