'use strict';const a44_0x59c23f=a44_0x5ead;function a44_0x5ead(_0x5ede98,_0x3a84aa){const _0x59e6a3=a44_0x59e6();return a44_0x5ead=function(_0x5eade6,_0xd82d4b){_0x5eade6=_0x5eade6-0xa4;let _0x2438fb=_0x59e6a3[_0x5eade6];return _0x2438fb;},a44_0x5ead(_0x5ede98,_0x3a84aa);}function a44_0x59e6(){const _0x592360=['toLowerCase','Amount','244473hgNbQA','1016GBkHQs','828180xnuxqI','waiting','CoinToPay\x20status\x20API\x20error:\x20','ü™ô\x20CoinToPay\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','expired','/create','Error\x20message:','Status\x20Text:','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20','cointopay','Response\x20Time:','===\x20PARSED\x20COINTOPAY\x20STATUS\x20RESPONSE\x20===','536340GjYSdS','Incomplete\x20response:\x20missing\x20data','===\x20COINTOPAY\x20SERVICE\x20ERROR\x20===','awaiting\x20fiat','üìä\x20Checking\x20CoinToPay\x20payment\x20status\x20for:\x20','üìä\x20Status\x20check\x20URL:','===\x20COINTOPAY\x20API\x20BUSINESS\x20ERROR\x20===','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','paid','CoinToPay\x20API\x20error:\x20','Status','Raw\x20Response\x20Body:','loggerService','Missing\x20data\x20in\x20response','coinAddress','pending','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','ExpiryTime','5sYbBBZ','IBAN:','CreatedOn','https://tesoft.uk/gateway/cointopay/status.php','headers','===\x20COINTOPAY\x20STATUS\x20API\x20ERROR\x20===','status_code','===\x20COINTOPAY\x20STATUS\x20SUCCESS\x20===','===\x20COINTOPAY\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','now',',\x20body:\x20','Request\x20Body:','Payment\x20Status:','938IQrObZ','\x20EUR','amount','Invalid\x20response\x20from\x20CoinToPay\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','defineProperty','Failed\x20to\x20parse\x20JSON\x20response:','created','__esModule','gateway_payment_id','fromEntries','Amount:','result','message','EXPIRED','merchant_reference_id','timeout','entries','log','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20status\x20API:\x20','Unknown\x20error\x20from\x20CoinToPay\x20status\x20API','FAILED','Status:','failed','verifyPayment','===\x20COINTOPAY\x20STATUS\x20CHECK\x20RESPONSE\x20===','HTTP\x20Status:','statusUrl','Currency:','Error\x20Message:','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','application/json','status','POST','not\x20found','Failed\x20to\x20check\x20CoinToPay\x20payment\x20status:\x20','Unknown\x20error','ü™ô\x20Creating\x20CoinToPay\x20payment:\x20','TransactionID','CoinToPayService','===\x20PARSED\x20COINTOPAY\x20RESPONSE\x20===','15FkbdMJ','stack','stringify','logWhiteDomainResponse','Transaction\x20ID:','Response\x20data:','üè¶\x20Payment\x20Detail:','parse','error','135886TLxObj','Parsed\x20Result:','data','logWhiteDomainRequest','payment_url','EUR\x20(always\x20EUR\x20for\x20CoinToPay)','apiUrl','Result:','QRCodeURL','CoinToPay\x20payment\x20status\x20check\x20error:','logWhiteDomainError','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20API:\x20','JSON\x20Parse\x20Error:\x20','inputCurrency','Headers:','===\x20COINTOPAY\x20API\x20REQUEST\x20(White\x20Domain)\x20===','PaymentDetail','EUR','text','HTTP\x20error!\x20status:\x20','736836spSTmh','TransactionConfirmedOn','currency','createPaymentLink','üè¶\x20Extracted\x20IBAN:','/status','cancelled','HTTP\x20','===\x20COINTOPAY\x20API\x20INCOMPLETE\x20RESPONSE\x20===','order_id','PENDING','Processing\x20CoinToPay\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','222150ITmnSk','statusText','===\x20COINTOPAY\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Payment\x20URL:'];a44_0x59e6=function(){return _0x592360;};return a44_0x59e6();}(function(_0x43dcd1,_0x45f9ec){const _0x7d5d9a=a44_0x5ead,_0x916b34=_0x43dcd1();while(!![]){try{const _0x436245=parseInt(_0x7d5d9a(0xba))/0x1+-parseInt(_0x7d5d9a(0x118))/0x2*(-parseInt(_0x7d5d9a(0x10f))/0x3)+-parseInt(_0x7d5d9a(0xc8))/0x4+-parseInt(_0x7d5d9a(0xda))/0x5*(parseInt(_0x7d5d9a(0xa8))/0x6)+parseInt(_0x7d5d9a(0xe7))/0x7*(parseInt(_0x7d5d9a(0xbb))/0x8)+-parseInt(_0x7d5d9a(0xbc))/0x9+-parseInt(_0x7d5d9a(0xb4))/0xa;if(_0x436245===_0x45f9ec)break;else _0x916b34['push'](_0x916b34['shift']());}catch(_0x55ecd4){_0x916b34['push'](_0x916b34['shift']());}}}(a44_0x59e6,0x382c0));Object[a44_0x59c23f(0xeb)](exports,a44_0x59c23f(0xee),{'value':!![]}),exports[a44_0x59c23f(0x10d)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPayService{constructor(){const _0x24efa6=a44_0x59c23f;this[_0x24efa6(0x11e)]='https://tesoft.uk/gateway/cointopay/',this[_0x24efa6(0x101)]=_0x24efa6(0xdd),console['log'](_0x24efa6(0xbf)),console[_0x24efa6(0xf8)](_0x24efa6(0xcd),this[_0x24efa6(0x101)]);}async[a44_0x59c23f(0xab)](_0xda00d8){const _0xa698a8=a44_0x59c23f,{orderId:_0x438f95,amount:_0x50b8bd}=_0xda00d8;console[_0xa698a8(0xf8)](_0xa698a8(0x10b)+_0x50b8bd+_0xa698a8(0xe8));const _0x257a9e={'amount':_0x50b8bd},_0x445367=Date['now']();try{console[_0xa698a8(0xf8)](_0xa698a8(0x127)),console['log']('URL:',this[_0xa698a8(0x11e)]),console[_0xa698a8(0xf8)](_0xa698a8(0xe5),JSON[_0xa698a8(0x111)](_0x257a9e,null,0x2)),console[_0xa698a8(0xf8)](_0xa698a8(0xf1),_0x50b8bd,_0xa698a8(0x11d)),loggerService_1[_0xa698a8(0xd4)][_0xa698a8(0x11b)]('cointopay','/create',_0xa698a8(0x107),_0x257a9e);const _0x1cbb93=await fetch(this[_0xa698a8(0x11e)],{'method':'POST','headers':{'Content-Type':_0xa698a8(0x105),'Accept':_0xa698a8(0x105),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0xa698a8(0x111)](_0x257a9e)}),_0xb5e02d=Date[_0xa698a8(0xe3)]()-_0x445367;console[_0xa698a8(0xf8)](_0xa698a8(0xe2)),console[_0xa698a8(0xf8)](_0xa698a8(0xfc),_0x1cbb93[_0xa698a8(0x106)]),console[_0xa698a8(0xf8)](_0xa698a8(0xc3),_0x1cbb93[_0xa698a8(0xb5)]),console[_0xa698a8(0xf8)](_0xa698a8(0x126),Object[_0xa698a8(0xf0)](_0x1cbb93[_0xa698a8(0xde)][_0xa698a8(0xf7)]())),console['log']('Response\x20Time:',_0xb5e02d+'ms');const _0x506a2a=await _0x1cbb93[_0xa698a8(0xa6)]();console[_0xa698a8(0xf8)](_0xa698a8(0xd3),_0x506a2a);if(!_0x1cbb93['ok']){console[_0xa698a8(0x117)]('===\x20COINTOPAY\x20API\x20ERROR\x20==='),console['error'](_0xa698a8(0x100),_0x1cbb93[_0xa698a8(0x106)]),console['error']('Response\x20Body:',_0x506a2a),loggerService_1[_0xa698a8(0xd4)][_0xa698a8(0x112)](_0xa698a8(0xc5),'/create',_0x1cbb93[_0xa698a8(0x106)],_0x506a2a,_0xb5e02d),loggerService_1[_0xa698a8(0xd4)][_0xa698a8(0x122)](_0xa698a8(0xc5),_0xa698a8(0xc1),_0xa698a8(0xaf)+_0x1cbb93[_0xa698a8(0x106)]+':\x20'+_0x506a2a);throw new Error(_0xa698a8(0xa7)+_0x1cbb93[_0xa698a8(0x106)]+_0xa698a8(0xe4)+_0x506a2a);}let _0x11cbf0;try{_0x11cbf0=JSON[_0xa698a8(0x116)](_0x506a2a);}catch(_0x44d2eb){console[_0xa698a8(0x117)](_0xa698a8(0xec),_0x44d2eb),loggerService_1['loggerService']['logWhiteDomainError']('cointopay','/create','JSON\x20Parse\x20Error:\x20'+_0x44d2eb);throw new Error(_0xa698a8(0x123)+_0x506a2a);}console[_0xa698a8(0xf8)](_0xa698a8(0x10e)),console[_0xa698a8(0xf8)](_0xa698a8(0x119),JSON['stringify'](_0x11cbf0,null,0x2)),loggerService_1[_0xa698a8(0xd4)][_0xa698a8(0x112)]('cointopay',_0xa698a8(0xc1),_0x1cbb93[_0xa698a8(0x106)],_0x11cbf0,_0xb5e02d);if(_0x11cbf0['error']){const _0x5175a1=_0x11cbf0['message']||_0x11cbf0['error']||'Unknown\x20error\x20from\x20CoinToPay\x20API';console[_0xa698a8(0x117)](_0xa698a8(0xce)),console[_0xa698a8(0x117)](_0xa698a8(0x103),_0x5175a1),loggerService_1['loggerService'][_0xa698a8(0x122)](_0xa698a8(0xc5),_0xa698a8(0xc1),'Business\x20Error:\x20'+_0x5175a1);throw new Error(_0xa698a8(0xd1)+_0x5175a1);}if(!_0x11cbf0[_0xa698a8(0x11c)]||!_0x11cbf0[_0xa698a8(0xef)]){console[_0xa698a8(0x117)](_0xa698a8(0xb0)),console['error'](_0xa698a8(0xcf)),console[_0xa698a8(0x117)](_0xa698a8(0x114),_0x11cbf0),loggerService_1['loggerService'][_0xa698a8(0x122)](_0xa698a8(0xc5),_0xa698a8(0xc1),_0xa698a8(0x104));throw new Error(_0xa698a8(0xea));}return console[_0xa698a8(0xf8)]('===\x20COINTOPAY\x20SUCCESS\x20==='),console[_0xa698a8(0xf8)]('Gateway\x20Payment\x20ID:',_0x11cbf0['gateway_payment_id']),console[_0xa698a8(0xf8)](_0xa698a8(0xb7),_0x11cbf0[_0xa698a8(0x11c)]),console['log'](_0xa698a8(0xf1),_0x50b8bd,'EUR'),{'gateway_payment_id':_0x11cbf0['gateway_payment_id'],'payment_url':_0x11cbf0['payment_url']};}catch(_0x2055da){console[_0xa698a8(0x117)](_0xa698a8(0xca)),console['error']('Error\x20details:',_0x2055da),loggerService_1[_0xa698a8(0xd4)]['logWhiteDomainError'](_0xa698a8(0xc5),_0xa698a8(0xc1),_0x2055da);if(_0x2055da instanceof Error){console[_0xa698a8(0x117)](_0xa698a8(0xc2),_0x2055da['message']),console[_0xa698a8(0x117)]('Error\x20stack:',_0x2055da[_0xa698a8(0x110)]);throw new Error(_0xa698a8(0xc4)+_0x2055da[_0xa698a8(0xf3)]);}throw new Error('Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20Unknown\x20error');}}async['checkPaymentStatus'](_0x2a0181){const _0x30fe54=a44_0x59c23f,_0x3c0b76=Date[_0x30fe54(0xe3)]();try{console[_0x30fe54(0xf8)](_0x30fe54(0xcc)+_0x2a0181);const _0x1ae4e4={'gatewayPaymentId':_0x2a0181};loggerService_1['loggerService'][_0x30fe54(0x11b)](_0x30fe54(0xc5),_0x30fe54(0xad),_0x30fe54(0x107),_0x1ae4e4);const _0x3b239d=await fetch(this[_0x30fe54(0x101)],{'method':_0x30fe54(0x107),'headers':{'Content-Type':'application/json','Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x30fe54(0x111)](_0x1ae4e4)}),_0x3138d5=Date['now']()-_0x3c0b76;console[_0x30fe54(0xf8)](_0x30fe54(0xff)),console[_0x30fe54(0xf8)](_0x30fe54(0xfc),_0x3b239d[_0x30fe54(0x106)]),console[_0x30fe54(0xf8)](_0x30fe54(0xc6),_0x3138d5+'ms');if(!_0x3b239d['ok']){const _0x5d338c=await _0x3b239d[_0x30fe54(0xa6)]();console[_0x30fe54(0x117)]('HTTP\x20Status:',_0x3b239d[_0x30fe54(0x106)]),console[_0x30fe54(0x117)]('Response\x20Body:',_0x5d338c),loggerService_1[_0x30fe54(0xd4)][_0x30fe54(0x112)](_0x30fe54(0xc5),_0x30fe54(0xad),_0x3b239d[_0x30fe54(0x106)],_0x5d338c,_0x3138d5),loggerService_1['loggerService'][_0x30fe54(0x122)]('cointopay','/status',_0x30fe54(0xaf)+_0x3b239d[_0x30fe54(0x106)]+':\x20'+_0x5d338c);throw new Error(_0x30fe54(0xa7)+_0x3b239d['status']);}const _0x24745a=await _0x3b239d[_0x30fe54(0xa6)]();console[_0x30fe54(0xf8)](_0x30fe54(0xd3),_0x24745a);let _0x4b1032;try{_0x4b1032=JSON[_0x30fe54(0x116)](_0x24745a);}catch(_0x3f0fc0){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0x3f0fc0),loggerService_1[_0x30fe54(0xd4)]['logWhiteDomainError'](_0x30fe54(0xc5),_0x30fe54(0xad),_0x30fe54(0x124)+_0x3f0fc0);throw new Error(_0x30fe54(0xf9)+_0x24745a);}loggerService_1['loggerService']['logWhiteDomainResponse'](_0x30fe54(0xc5),_0x30fe54(0xad),_0x3b239d[_0x30fe54(0x106)],_0x4b1032,_0x3138d5),console[_0x30fe54(0xf8)](_0x30fe54(0xc7)),console[_0x30fe54(0xf8)](_0x30fe54(0x11f),_0x4b1032[_0x30fe54(0xf2)]),console[_0x30fe54(0xf8)]('Status\x20Code:',_0x4b1032[_0x30fe54(0xe0)]),console[_0x30fe54(0xf8)](_0x30fe54(0xe6),_0x4b1032[_0x30fe54(0x11a)]?.['Status']),console[_0x30fe54(0xf8)](_0x30fe54(0xf1),_0x4b1032[_0x30fe54(0x11a)]?.['Amount']),console['log'](_0x30fe54(0x102),_0x4b1032['data']?.[_0x30fe54(0x125)]);if(_0x4b1032[_0x30fe54(0xf2)]!=='success'||_0x4b1032[_0x30fe54(0xe0)]!==0xc8){const _0x19af5d=_0x4b1032['message']||_0x30fe54(0xfa);console['error'](_0x30fe54(0xdf)),console[_0x30fe54(0x117)](_0x30fe54(0x103),_0x19af5d),loggerService_1['loggerService'][_0x30fe54(0x122)](_0x30fe54(0xc5),_0x30fe54(0xad),'Status\x20API\x20Error:\x20'+_0x19af5d);throw new Error(_0x30fe54(0xbe)+_0x19af5d);}if(!_0x4b1032[_0x30fe54(0x11a)]){console[_0x30fe54(0x117)](_0x30fe54(0xb6)),console[_0x30fe54(0x117)](_0x30fe54(0xd5)),loggerService_1[_0x30fe54(0xd4)][_0x30fe54(0x122)]('cointopay','/status',_0x30fe54(0xc9));throw new Error('Invalid\x20response\x20from\x20CoinToPay\x20status\x20API:\x20missing\x20data');}let _0xac0b4a='PENDING';switch(_0x4b1032[_0x30fe54(0x11a)][_0x30fe54(0xd2)]?.[_0x30fe54(0xb8)]()){case'paid':_0xac0b4a='PAID';break;case _0x30fe54(0xae):case _0x30fe54(0xfd):case _0x30fe54(0x117):_0xac0b4a=_0x30fe54(0xfb);break;case _0x30fe54(0xc0):case _0x30fe54(0xf6):_0xac0b4a=_0x30fe54(0xf4);break;case _0x30fe54(0xbd):case _0x30fe54(0xcb):case _0x30fe54(0xd7):case _0x30fe54(0xed):default:_0xac0b4a='PENDING';break;}let _0x24afca,_0x5738c1;if(_0x4b1032[_0x30fe54(0x11a)][_0x30fe54(0xa4)]){const _0x123d0e=_0x4b1032['data']['PaymentDetail'];console[_0x30fe54(0xf8)](_0x30fe54(0x115),_0x123d0e);const _0x58fa75=_0x123d0e['match'](/IBAN\s+([A-Z0-9]+)/i);_0x58fa75&&(_0x24afca=_0x58fa75[0x1],console[_0x30fe54(0xf8)](_0x30fe54(0xac),_0x24afca)),_0x5738c1=_0x123d0e;}const _0x2908cb={'iban':_0x24afca,'bankDetails':_0x5738c1,'transactionId':_0x4b1032[_0x30fe54(0x11a)][_0x30fe54(0x10c)],'coinAddress':_0x4b1032[_0x30fe54(0x11a)][_0x30fe54(0xd6)],'qrCodeUrl':_0x4b1032[_0x30fe54(0x11a)][_0x30fe54(0x120)],'expiryTime':_0x4b1032['data'][_0x30fe54(0xd9)],'createdOn':_0x4b1032[_0x30fe54(0x11a)][_0x30fe54(0xdc)],'confirmedOn':_0x4b1032[_0x30fe54(0x11a)]['TransactionConfirmedOn']};console[_0x30fe54(0xf8)](_0x30fe54(0xe1)),console['log'](_0x30fe54(0xfc),_0x4b1032[_0x30fe54(0x11a)][_0x30fe54(0xd2)],'->',_0xac0b4a),console[_0x30fe54(0xf8)](_0x30fe54(0xf1),_0x4b1032['data'][_0x30fe54(0xb9)],_0x4b1032[_0x30fe54(0x11a)]['inputCurrency']),console[_0x30fe54(0xf8)](_0x30fe54(0x113),_0x4b1032['data'][_0x30fe54(0x10c)]),console['log'](_0x30fe54(0xdb),_0x24afca||_0x30fe54(0x108)),console['log']('Created\x20On:',_0x4b1032['data'][_0x30fe54(0xdc)]),console[_0x30fe54(0xf8)]('Confirmed\x20On:',_0x4b1032['data'][_0x30fe54(0xa9)]||'not\x20confirmed');if(_0x4b1032[_0x30fe54(0x11a)][_0x30fe54(0xd2)]?.['toLowerCase']()===_0x30fe54(0xcb))console[_0x30fe54(0xf8)](_0x30fe54(0xd8));else _0x4b1032[_0x30fe54(0x11a)][_0x30fe54(0xd2)]?.['toLowerCase']()===_0x30fe54(0xd0)&&console['log']('‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID');return{'status':_0xac0b4a,'amount':parseFloat(_0x4b1032[_0x30fe54(0x11a)][_0x30fe54(0xb9)])||undefined,'currency':_0x4b1032[_0x30fe54(0x11a)][_0x30fe54(0x125)]||'EUR','paymentDetails':_0x2908cb};}catch(_0x156dc5){console['error'](_0x30fe54(0x121),_0x156dc5),loggerService_1[_0x30fe54(0xd4)][_0x30fe54(0x122)]('cointopay','/status',_0x156dc5);throw new Error(_0x30fe54(0x109)+(_0x156dc5 instanceof Error?_0x156dc5[_0x30fe54(0xf3)]:_0x30fe54(0x10a)));}}async[a44_0x59c23f(0xfe)](_0x49c287){const _0x899fcf=a44_0x59c23f,_0x5194c7=await this['checkPaymentStatus'](_0x49c287);return{'status':_0x5194c7[_0x899fcf(0x106)],'amount':_0x5194c7[_0x899fcf(0xe9)],'currency':_0x5194c7[_0x899fcf(0xaa)]};}async['processWebhook'](_0x55c5f8){const _0x1d5fbd=a44_0x59c23f;console['log'](_0x1d5fbd(0xb3),_0x55c5f8);let _0x3218e7=_0x1d5fbd(0xb2);switch(_0x55c5f8[_0x1d5fbd(0x106)]?.[_0x1d5fbd(0xb8)]()){case _0x1d5fbd(0xd0):_0x3218e7='PAID';break;case _0x1d5fbd(0xae):case'failed':case'error':_0x3218e7=_0x1d5fbd(0xfb);break;case _0x1d5fbd(0xc0):case _0x1d5fbd(0xf6):_0x3218e7=_0x1d5fbd(0xf4);break;case _0x1d5fbd(0xd7):case _0x1d5fbd(0xbd):case _0x1d5fbd(0xcb):case _0x1d5fbd(0xed):default:_0x3218e7=_0x1d5fbd(0xb2);break;}return{'paymentId':_0x55c5f8[_0x1d5fbd(0xb1)]||_0x55c5f8[_0x1d5fbd(0xf5)]||'','status':_0x3218e7,'amount':_0x55c5f8['amount'],'currency':_0x55c5f8[_0x1d5fbd(0xaa)]||_0x1d5fbd(0xa5)};}}exports[a44_0x59c23f(0x10d)]=CoinToPayService;