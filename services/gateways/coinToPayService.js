'use strict';const a65_0x1165b6=a65_0x2579;function a65_0x2579(_0x44b52c,_0xa21298){_0x44b52c=_0x44b52c-0x13e;const _0x489125=a65_0x4891();let _0x257911=_0x489125[_0x44b52c];return _0x257911;}(function(_0x1dbbd6,_0x5bd5d4){const _0x33aa79=a65_0x2579,_0x3dc920=_0x1dbbd6();while(!![]){try{const _0x256c1b=-parseInt(_0x33aa79(0x155))/0x1+-parseInt(_0x33aa79(0x14e))/0x2*(parseInt(_0x33aa79(0x149))/0x3)+-parseInt(_0x33aa79(0x150))/0x4+-parseInt(_0x33aa79(0x16a))/0x5+parseInt(_0x33aa79(0x18f))/0x6+parseInt(_0x33aa79(0x16d))/0x7*(-parseInt(_0x33aa79(0x192))/0x8)+-parseInt(_0x33aa79(0x1a4))/0x9*(-parseInt(_0x33aa79(0x162))/0xa);if(_0x256c1b===_0x5bd5d4)break;else _0x3dc920['push'](_0x3dc920['shift']());}catch(_0x1c2349){_0x3dc920['push'](_0x3dc920['shift']());}}}(a65_0x4891,0xc7d56));Object['defineProperty'](exports,a65_0x1165b6(0x1b3),{'value':!![]}),exports[a65_0x1165b6(0x193)]=void 0x0;const loggerService_1=require('../loggerService');function a65_0x4891(){const _0x1aab99=['Unknown\x20error\x20from\x20CoinToPay\x20API','Missing\x20data\x20in\x20response','fromEntries','application/json','2OOqtYV','ExpiryTime','5183492BVebYR','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20Unknown\x20error','FAILED','CoinToPay\x20API\x20error:\x20','===\x20COINTOPAY\x20SUCCESS\x20===','1042711MRAbuz','ðŸª™\x20Creating\x20CoinToPay\x20payment:\x20','ðŸ“Š\x20Checking\x20CoinToPay\x20payment\x20status\x20for:\x20','URL:','loggerService','entries','/status','POST','Error\x20details:','HTTP\x20Status:','Payment\x20Status:','TransactionConfirmedOn','stack','1150fNiHFu','Payment\x20URL\x20(modified):','Processing\x20CoinToPay\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','logWhiteDomainError','IBAN:','===\x20COINTOPAY\x20API\x20ERROR\x20===','waiting','Created\x20On:','6882635ZMcgmi','===\x20COINTOPAY\x20SERVICE\x20ERROR\x20===','ðŸ“Š\x20Status\x20check\x20URL:','28217UuDxTt','HTTP\x20error!\x20status:\x20','https://tesoft.uk/gateway/cointopay/','logWhiteDomainResponse','Unknown\x20error','message','Currency:','JSON\x20Parse\x20Error:\x20','===\x20COINTOPAY\x20STATUS\x20CHECK\x20RESPONSE\x20===','===\x20COINTOPAY\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','expired','awaiting\x20fiat','\x20EUR','amount','status','Raw\x20Response\x20Body:','PENDING','Status\x20API\x20Error:\x20','logWhiteDomainRequest','parse','cancelled','result','Status','Error\x20message:','merchant_reference_id','EXPIRED','Transaction\x20ID:','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','gateway_payment_id','failed','Gateway\x20Payment\x20ID:','https://tesoft.uk/gateway/cointopay/status.php','Business\x20Error:\x20','PAID','6284466eBfFkA','payment_url','status_code','848OajsJP','CoinToPayService','Payment\x20System/1.0','Status\x20Code:','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20status\x20API:\x20','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','&alternative=false','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20','===\x20COINTOPAY\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Unknown\x20error\x20from\x20CoinToPay\x20status\x20API','data','paid','Status\x20Text:','Response\x20Body:','CoinToPay\x20payment\x20status\x20check\x20error:','inputCurrency','order_id','statusText','399186bPXOhN','Error\x20Message:','Status:','ðŸ¦\x20Extracted\x20IBAN:','Headers:','Error\x20stack:','Response\x20Time:','TransactionID','timeout','===\x20COINTOPAY\x20STATUS\x20SUCCESS\x20===','Amount','pending','success','Response\x20data:','apiUrl','__esModule','createPaymentLink','EUR','Failed\x20to\x20parse\x20JSON\x20response:','currency','PaymentDetail','verifyPayment','===\x20COINTOPAY\x20API\x20BUSINESS\x20ERROR\x20===','error','âœ…\x20\x22Paid\x22\x20mapped\x20to\x20PAID','not\x20found','cointopay','match','/create','Parsed\x20Result:','===\x20COINTOPAY\x20API\x20REQUEST\x20(White\x20Domain)\x20===','now','Result:','toLowerCase','ðŸ’¡\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','HTTP\x20','stringify','log','text','checkPaymentStatus','Amount:','ðŸª™\x20CoinToPay\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','Confirmed\x20On:','CreatedOn','Invalid\x20response\x20from\x20CoinToPay\x20status\x20API:\x20missing\x20data','===\x20COINTOPAY\x20STATUS\x20API\x20ERROR\x20===','3561618OxDNQW'];a65_0x4891=function(){return _0x1aab99;};return a65_0x4891();}class CoinToPayService{constructor(){const _0x591869=a65_0x1165b6;this[_0x591869(0x1b2)]=_0x591869(0x16f),this['statusUrl']=_0x591869(0x18c),console[_0x591869(0x140)](_0x591869(0x144)),console['log'](_0x591869(0x16c),this['statusUrl']);}async[a65_0x1165b6(0x1b4)](_0x3bd103){const _0x5a92ea=a65_0x1165b6,{orderId:_0x14c8c2,amount:_0x1ef647}=_0x3bd103;console[_0x5a92ea(0x140)](_0x5a92ea(0x156)+_0x1ef647+_0x5a92ea(0x179));const _0x435403={'amount':_0x1ef647},_0x201d4d=Date[_0x5a92ea(0x1c3)]();try{console[_0x5a92ea(0x140)](_0x5a92ea(0x1c2)),console[_0x5a92ea(0x140)](_0x5a92ea(0x158),this['apiUrl']),console['log']('Request\x20Body:',JSON['stringify'](_0x435403,null,0x2)),console[_0x5a92ea(0x140)](_0x5a92ea(0x143),_0x1ef647,'EUR\x20(always\x20EUR\x20for\x20CoinToPay)'),loggerService_1[_0x5a92ea(0x159)][_0x5a92ea(0x17f)](_0x5a92ea(0x1be),_0x5a92ea(0x1c0),_0x5a92ea(0x15c),_0x435403);const _0x473f0b=await fetch(this[_0x5a92ea(0x1b2)],{'method':'POST','headers':{'Content-Type':_0x5a92ea(0x14d),'Accept':'application/json','User-Agent':_0x5a92ea(0x194)},'body':JSON[_0x5a92ea(0x13f)](_0x435403)}),_0x1ac5b1=Date[_0x5a92ea(0x1c3)]()-_0x201d4d;console[_0x5a92ea(0x140)]('===\x20COINTOPAY\x20API\x20RESPONSE\x20(White\x20Domain)\x20==='),console[_0x5a92ea(0x140)](_0x5a92ea(0x1a6),_0x473f0b[_0x5a92ea(0x17b)]),console[_0x5a92ea(0x140)](_0x5a92ea(0x19e),_0x473f0b[_0x5a92ea(0x1a3)]),console['log'](_0x5a92ea(0x1a8),Object[_0x5a92ea(0x14c)](_0x473f0b['headers'][_0x5a92ea(0x15a)]())),console[_0x5a92ea(0x140)]('Response\x20Time:',_0x1ac5b1+'ms');const _0x1ff11a=await _0x473f0b[_0x5a92ea(0x141)]();console[_0x5a92ea(0x140)](_0x5a92ea(0x17c),_0x1ff11a);if(!_0x473f0b['ok']){console['error'](_0x5a92ea(0x167)),console[_0x5a92ea(0x1bb)](_0x5a92ea(0x15e),_0x473f0b[_0x5a92ea(0x17b)]),console['error']('Response\x20Body:',_0x1ff11a),loggerService_1['loggerService'][_0x5a92ea(0x170)](_0x5a92ea(0x1be),_0x5a92ea(0x1c0),_0x473f0b[_0x5a92ea(0x17b)],_0x1ff11a,_0x1ac5b1),loggerService_1['loggerService'][_0x5a92ea(0x165)](_0x5a92ea(0x1be),_0x5a92ea(0x1c0),_0x5a92ea(0x13e)+_0x473f0b[_0x5a92ea(0x17b)]+':\x20'+_0x1ff11a);throw new Error(_0x5a92ea(0x16e)+_0x473f0b[_0x5a92ea(0x17b)]+',\x20body:\x20'+_0x1ff11a);}let _0x4e942f;try{_0x4e942f=JSON[_0x5a92ea(0x180)](_0x1ff11a);}catch(_0x2d2067){console[_0x5a92ea(0x1bb)](_0x5a92ea(0x1b6),_0x2d2067),loggerService_1[_0x5a92ea(0x159)][_0x5a92ea(0x165)]('cointopay',_0x5a92ea(0x1c0),_0x5a92ea(0x174)+_0x2d2067);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20API:\x20'+_0x1ff11a);}console[_0x5a92ea(0x140)]('===\x20PARSED\x20COINTOPAY\x20RESPONSE\x20==='),console[_0x5a92ea(0x140)](_0x5a92ea(0x1c1),JSON['stringify'](_0x4e942f,null,0x2)),loggerService_1['loggerService'][_0x5a92ea(0x170)](_0x5a92ea(0x1be),_0x5a92ea(0x1c0),_0x473f0b[_0x5a92ea(0x17b)],_0x4e942f,_0x1ac5b1);if(_0x4e942f['error']){const _0x4f3111=_0x4e942f[_0x5a92ea(0x172)]||_0x4e942f[_0x5a92ea(0x1bb)]||_0x5a92ea(0x14a);console[_0x5a92ea(0x1bb)](_0x5a92ea(0x1ba)),console[_0x5a92ea(0x1bb)](_0x5a92ea(0x1a5),_0x4f3111),loggerService_1[_0x5a92ea(0x159)]['logWhiteDomainError'](_0x5a92ea(0x1be),'/create',_0x5a92ea(0x18d)+_0x4f3111);throw new Error(_0x5a92ea(0x153)+_0x4f3111);}if(!_0x4e942f[_0x5a92ea(0x190)]||!_0x4e942f['gateway_payment_id']){console[_0x5a92ea(0x1bb)](_0x5a92ea(0x19a)),console['error'](_0x5a92ea(0x197)),console[_0x5a92ea(0x1bb)](_0x5a92ea(0x1b1),_0x4e942f),loggerService_1[_0x5a92ea(0x159)][_0x5a92ea(0x165)](_0x5a92ea(0x1be),_0x5a92ea(0x1c0),_0x5a92ea(0x188));throw new Error('Invalid\x20response\x20from\x20CoinToPay\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id');}console[_0x5a92ea(0x140)](_0x5a92ea(0x154)),console['log'](_0x5a92ea(0x18b),_0x4e942f[_0x5a92ea(0x189)]),console[_0x5a92ea(0x140)]('Payment\x20URL\x20(original):',_0x4e942f[_0x5a92ea(0x190)]);const _0x5e1668=_0x4e942f[_0x5a92ea(0x190)]+_0x5a92ea(0x198);return console[_0x5a92ea(0x140)](_0x5a92ea(0x163),_0x5e1668),console[_0x5a92ea(0x140)](_0x5a92ea(0x143),_0x1ef647,_0x5a92ea(0x1b5)),{'gateway_payment_id':_0x4e942f[_0x5a92ea(0x189)],'payment_url':_0x5e1668};}catch(_0x27c020){console[_0x5a92ea(0x1bb)](_0x5a92ea(0x16b)),console[_0x5a92ea(0x1bb)](_0x5a92ea(0x15d),_0x27c020),loggerService_1[_0x5a92ea(0x159)]['logWhiteDomainError'](_0x5a92ea(0x1be),_0x5a92ea(0x1c0),_0x27c020);if(_0x27c020 instanceof Error){console[_0x5a92ea(0x1bb)](_0x5a92ea(0x184),_0x27c020[_0x5a92ea(0x172)]),console[_0x5a92ea(0x1bb)](_0x5a92ea(0x1a9),_0x27c020[_0x5a92ea(0x161)]);throw new Error(_0x5a92ea(0x199)+_0x27c020['message']);}throw new Error(_0x5a92ea(0x151));}}async['checkPaymentStatus'](_0x56057f){const _0x40f562=a65_0x1165b6,_0x372b4d=Date['now']();try{console[_0x40f562(0x140)](_0x40f562(0x157)+_0x56057f);const _0x3e4774={'gatewayPaymentId':_0x56057f};loggerService_1['loggerService'][_0x40f562(0x17f)](_0x40f562(0x1be),_0x40f562(0x15b),_0x40f562(0x15c),_0x3e4774);const _0x3e3ca8=await fetch(this['statusUrl'],{'method':'POST','headers':{'Content-Type':_0x40f562(0x14d),'Accept':_0x40f562(0x14d),'User-Agent':_0x40f562(0x194)},'body':JSON['stringify'](_0x3e4774)}),_0x26f391=Date[_0x40f562(0x1c3)]()-_0x372b4d;console['log'](_0x40f562(0x175)),console[_0x40f562(0x140)]('Status:',_0x3e3ca8[_0x40f562(0x17b)]),console[_0x40f562(0x140)](_0x40f562(0x1aa),_0x26f391+'ms');if(!_0x3e3ca8['ok']){const _0x3dc0c0=await _0x3e3ca8['text']();console[_0x40f562(0x1bb)](_0x40f562(0x15e),_0x3e3ca8[_0x40f562(0x17b)]),console[_0x40f562(0x1bb)](_0x40f562(0x19f),_0x3dc0c0),loggerService_1[_0x40f562(0x159)][_0x40f562(0x170)]('cointopay',_0x40f562(0x15b),_0x3e3ca8[_0x40f562(0x17b)],_0x3dc0c0,_0x26f391),loggerService_1[_0x40f562(0x159)][_0x40f562(0x165)]('cointopay','/status','HTTP\x20'+_0x3e3ca8['status']+':\x20'+_0x3dc0c0);throw new Error(_0x40f562(0x16e)+_0x3e3ca8[_0x40f562(0x17b)]);}const _0x392d16=await _0x3e3ca8[_0x40f562(0x141)]();console[_0x40f562(0x140)](_0x40f562(0x17c),_0x392d16);let _0x5c62b5;try{_0x5c62b5=JSON[_0x40f562(0x180)](_0x392d16);}catch(_0x3efb1e){console['error'](_0x40f562(0x1b6),_0x3efb1e),loggerService_1[_0x40f562(0x159)]['logWhiteDomainError'](_0x40f562(0x1be),_0x40f562(0x15b),_0x40f562(0x174)+_0x3efb1e);throw new Error(_0x40f562(0x196)+_0x392d16);}loggerService_1['loggerService'][_0x40f562(0x170)](_0x40f562(0x1be),'/status',_0x3e3ca8[_0x40f562(0x17b)],_0x5c62b5,_0x26f391),console['log']('===\x20PARSED\x20COINTOPAY\x20STATUS\x20RESPONSE\x20==='),console[_0x40f562(0x140)](_0x40f562(0x1c4),_0x5c62b5[_0x40f562(0x182)]),console[_0x40f562(0x140)](_0x40f562(0x195),_0x5c62b5[_0x40f562(0x191)]),console['log'](_0x40f562(0x15f),_0x5c62b5[_0x40f562(0x19c)]?.['Status']),console['log'](_0x40f562(0x143),_0x5c62b5[_0x40f562(0x19c)]?.['Amount']),console['log'](_0x40f562(0x173),_0x5c62b5[_0x40f562(0x19c)]?.[_0x40f562(0x1a1)]);if(_0x5c62b5['result']!==_0x40f562(0x1b0)||_0x5c62b5['status_code']!==0xc8){const _0x2d7704=_0x5c62b5[_0x40f562(0x172)]||_0x40f562(0x19b);console['error'](_0x40f562(0x148)),console['error']('Error\x20Message:',_0x2d7704),loggerService_1[_0x40f562(0x159)][_0x40f562(0x165)](_0x40f562(0x1be),_0x40f562(0x15b),_0x40f562(0x17e)+_0x2d7704);throw new Error('CoinToPay\x20status\x20API\x20error:\x20'+_0x2d7704);}if(!_0x5c62b5['data']){console['error'](_0x40f562(0x176)),console['error'](_0x40f562(0x14b)),loggerService_1[_0x40f562(0x159)]['logWhiteDomainError'](_0x40f562(0x1be),_0x40f562(0x15b),'Incomplete\x20response:\x20missing\x20data');throw new Error(_0x40f562(0x147));}let _0x99ac4d='PENDING';switch(_0x5c62b5[_0x40f562(0x19c)][_0x40f562(0x183)]?.[_0x40f562(0x1c5)]()){case _0x40f562(0x19d):_0x99ac4d='PAID';break;case _0x40f562(0x181):case _0x40f562(0x18a):case _0x40f562(0x1bb):_0x99ac4d=_0x40f562(0x152);break;case _0x40f562(0x177):case _0x40f562(0x1ac):_0x99ac4d='EXPIRED';break;case _0x40f562(0x168):case _0x40f562(0x178):case'pending':case'created':default:_0x99ac4d='PENDING';break;}let _0x228d82,_0x35b083;if(_0x5c62b5['data'][_0x40f562(0x1b8)]){const _0x4b39ea=_0x5c62b5['data']['PaymentDetail'];console[_0x40f562(0x140)]('ðŸ¦\x20Payment\x20Detail:',_0x4b39ea);const _0x1ae750=_0x4b39ea[_0x40f562(0x1bf)](/IBAN\s+([A-Z0-9]+)/i);_0x1ae750&&(_0x228d82=_0x1ae750[0x1],console[_0x40f562(0x140)](_0x40f562(0x1a7),_0x228d82)),_0x35b083=_0x4b39ea;}const _0x2c8324={'iban':_0x228d82,'bankDetails':_0x35b083,'transactionId':_0x5c62b5[_0x40f562(0x19c)][_0x40f562(0x1ab)],'coinAddress':_0x5c62b5[_0x40f562(0x19c)]['coinAddress'],'qrCodeUrl':_0x5c62b5[_0x40f562(0x19c)]['QRCodeURL'],'expiryTime':_0x5c62b5[_0x40f562(0x19c)][_0x40f562(0x14f)],'createdOn':_0x5c62b5[_0x40f562(0x19c)][_0x40f562(0x146)],'confirmedOn':_0x5c62b5['data']['TransactionConfirmedOn']};console['log'](_0x40f562(0x1ad)),console['log']('Status:',_0x5c62b5['data'][_0x40f562(0x183)],'->',_0x99ac4d),console['log'](_0x40f562(0x143),_0x5c62b5[_0x40f562(0x19c)][_0x40f562(0x1ae)],_0x5c62b5[_0x40f562(0x19c)]['inputCurrency']),console[_0x40f562(0x140)](_0x40f562(0x187),_0x5c62b5[_0x40f562(0x19c)][_0x40f562(0x1ab)]),console[_0x40f562(0x140)](_0x40f562(0x166),_0x228d82||_0x40f562(0x1bd)),console[_0x40f562(0x140)](_0x40f562(0x169),_0x5c62b5['data'][_0x40f562(0x146)]),console[_0x40f562(0x140)](_0x40f562(0x145),_0x5c62b5[_0x40f562(0x19c)][_0x40f562(0x160)]||'not\x20confirmed');if(_0x5c62b5[_0x40f562(0x19c)][_0x40f562(0x183)]?.[_0x40f562(0x1c5)]()==='awaiting\x20fiat')console['log'](_0x40f562(0x1c6));else _0x5c62b5[_0x40f562(0x19c)][_0x40f562(0x183)]?.[_0x40f562(0x1c5)]()===_0x40f562(0x19d)&&console[_0x40f562(0x140)](_0x40f562(0x1bc));return{'status':_0x99ac4d,'amount':parseFloat(_0x5c62b5[_0x40f562(0x19c)][_0x40f562(0x1ae)])||undefined,'currency':_0x5c62b5['data'][_0x40f562(0x1a1)]||'EUR','paymentDetails':_0x2c8324};}catch(_0x17d995){console['error'](_0x40f562(0x1a0),_0x17d995),loggerService_1[_0x40f562(0x159)]['logWhiteDomainError'](_0x40f562(0x1be),'/status',_0x17d995);throw new Error('Failed\x20to\x20check\x20CoinToPay\x20payment\x20status:\x20'+(_0x17d995 instanceof Error?_0x17d995['message']:_0x40f562(0x171)));}}async[a65_0x1165b6(0x1b9)](_0x29725b){const _0x3a1f19=a65_0x1165b6,_0x582e97=await this[_0x3a1f19(0x142)](_0x29725b);return{'status':_0x582e97['status'],'amount':_0x582e97[_0x3a1f19(0x17a)],'currency':_0x582e97['currency']};}async['processWebhook'](_0x55574e){const _0x51b547=a65_0x1165b6;console[_0x51b547(0x140)](_0x51b547(0x164),_0x55574e);let _0x4e6b7a=_0x51b547(0x17d);switch(_0x55574e['status']?.[_0x51b547(0x1c5)]()){case _0x51b547(0x19d):_0x4e6b7a=_0x51b547(0x18e);break;case _0x51b547(0x181):case _0x51b547(0x18a):case _0x51b547(0x1bb):_0x4e6b7a=_0x51b547(0x152);break;case'expired':case _0x51b547(0x1ac):_0x4e6b7a=_0x51b547(0x186);break;case _0x51b547(0x1af):case _0x51b547(0x168):case'awaiting\x20fiat':case'created':default:_0x4e6b7a=_0x51b547(0x17d);break;}return{'paymentId':_0x55574e[_0x51b547(0x1a2)]||_0x55574e[_0x51b547(0x185)]||'','status':_0x4e6b7a,'amount':_0x55574e[_0x51b547(0x17a)],'currency':_0x55574e[_0x51b547(0x1b7)]||_0x51b547(0x1b5)};}}exports['CoinToPayService']=CoinToPayService;