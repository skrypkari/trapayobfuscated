'use strict';const a38_0x400f7a=a38_0x2d53;function a38_0x5bb6(){const _0x254f03=['IBAN:','CreatedOn','logWhiteDomainError','CoinToPay\x20payment\x20status\x20check\x20error:','EUR\x20(always\x20EUR\x20for\x20CoinToPay)','log','awaiting\x20fiat','Status\x20Text:','POST','===\x20PARSED\x20COINTOPAY\x20RESPONSE\x20===','cointopay','1889362OPUnTP','ü™ô\x20Creating\x20CoinToPay\x20payment:\x20','===\x20COINTOPAY\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','checkPaymentStatus','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','Status','entries','URL:','message','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','CoinToPayService','TesSoft\x20Payment\x20System/1.0','ExpiryTime','PENDING','pending','3621744qImuqi','HTTP\x20error!\x20status:\x20','===\x20COINTOPAY\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Failed\x20to\x20parse\x20JSON\x20response:','/status','logWhiteDomainRequest','Invalid\x20response\x20from\x20CoinToPay\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20','https://tesoft.uk/gateway/cointopay/status.php','HTTP\x20Status:','created','===\x20COINTOPAY\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','currency','2195766TVkove','===\x20COINTOPAY\x20API\x20REQUEST\x20(White\x20Domain)\x20===','error','amount','Missing\x20data\x20in\x20response','match','PAID','__esModule','===\x20COINTOPAY\x20STATUS\x20API\x20ERROR\x20===','fromEntries','stringify','===\x20COINTOPAY\x20STATUS\x20SUCCESS\x20===','PaymentDetail','/create','Unknown\x20error','statusUrl','loggerService','Status\x20API\x20Error:\x20','processWebhook','Payment\x20Status:','===\x20COINTOPAY\x20SERVICE\x20ERROR\x20===','inputCurrency','toLowerCase','25740336yHAPpk','Request\x20Body:','Response\x20data:','logWhiteDomainResponse','success','../loggerService','application/json','result','HTTP\x20','cancelled','now','gateway_payment_id','Unknown\x20error\x20from\x20CoinToPay\x20API','8967PmhReJ','372OkrhXB','Confirmed\x20On:','text','7068430RNYsVt','not\x20confirmed','557534wRiHut','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20API:\x20','üìä\x20Status\x20check\x20URL:','CoinToPay\x20status\x20API\x20error:\x20','createPaymentLink','paid','===\x20COINTOPAY\x20API\x20BUSINESS\x20ERROR\x20===','order_id','status_code','failed','status','payment_url','Amount','data','JSON\x20Parse\x20Error:\x20','Result:','apiUrl','FAILED','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20status\x20API:\x20','not\x20found','defineProperty','Response\x20Body:','===\x20PARSED\x20COINTOPAY\x20STATUS\x20RESPONSE\x20===','Created\x20On:','EUR','Failed\x20to\x20check\x20CoinToPay\x20payment\x20status:\x20','verifyPayment','ü™ô\x20CoinToPay\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','Headers:','Status:','\x20EUR','EXPIRED','TransactionConfirmedOn','Error\x20details:','expired','TransactionID','Error\x20Message:','merchant_reference_id','Payment\x20URL:','timeout','üè¶\x20Payment\x20Detail:','Response\x20Time:','stack','Amount:','QRCodeURL','üìä\x20Checking\x20CoinToPay\x20payment\x20status\x20for:\x20','parse'];a38_0x5bb6=function(){return _0x254f03;};return a38_0x5bb6();}(function(_0x19242d,_0x31e7df){const _0xae49df=a38_0x2d53,_0x1f1b0c=_0x19242d();while(!![]){try{const _0x579a1b=parseInt(_0xae49df(0x1cf))/0x1+parseInt(_0xae49df(0x195))/0x2+parseInt(_0xae49df(0x18f))/0x3*(-parseInt(_0xae49df(0x190))/0x4)+parseInt(_0xae49df(0x193))/0x5+parseInt(_0xae49df(0x16b))/0x6+parseInt(_0xae49df(0x15e))/0x7+-parseInt(_0xae49df(0x182))/0x8;if(_0x579a1b===_0x31e7df)break;else _0x1f1b0c['push'](_0x1f1b0c['shift']());}catch(_0x4d312d){_0x1f1b0c['push'](_0x1f1b0c['shift']());}}}(a38_0x5bb6,0xecbb1));function a38_0x2d53(_0x13e09a,_0x3156a5){const _0x5bb6ca=a38_0x5bb6();return a38_0x2d53=function(_0x2d53c9,_0x470297){_0x2d53c9=_0x2d53c9-0x153;let _0x3fa74f=_0x5bb6ca[_0x2d53c9];return _0x3fa74f;},a38_0x2d53(_0x13e09a,_0x3156a5);}Object[a38_0x400f7a(0x1a9)](exports,a38_0x400f7a(0x172),{'value':!![]}),exports[a38_0x400f7a(0x159)]=void 0x0;const loggerService_1=require(a38_0x400f7a(0x187));class CoinToPayService{constructor(){const _0x10ede4=a38_0x400f7a;this[_0x10ede4(0x1a5)]='https://tesoft.uk/gateway/cointopay/',this['statusUrl']=_0x10ede4(0x166),console[_0x10ede4(0x1c9)](_0x10ede4(0x1b0)),console['log'](_0x10ede4(0x197),this[_0x10ede4(0x17a)]);}async[a38_0x400f7a(0x199)](_0x4fa95f){const _0x56dc09=a38_0x400f7a,{orderId:_0x2e6959,amount:_0x5e28d4}=_0x4fa95f;console[_0x56dc09(0x1c9)](_0x56dc09(0x1d0)+_0x5e28d4+_0x56dc09(0x1b3));const _0x59cf00={'amount':_0x5e28d4},_0x110d19=Date['now']();try{console[_0x56dc09(0x1c9)](_0x56dc09(0x16c)),console[_0x56dc09(0x1c9)](_0x56dc09(0x156),this[_0x56dc09(0x1a5)]),console[_0x56dc09(0x1c9)](_0x56dc09(0x183),JSON[_0x56dc09(0x175)](_0x59cf00,null,0x2)),console['log']('Amount:',_0x5e28d4,_0x56dc09(0x1c8)),loggerService_1[_0x56dc09(0x17b)][_0x56dc09(0x163)]('cointopay','/create',_0x56dc09(0x1cc),_0x59cf00);const _0x2c9306=await fetch(this[_0x56dc09(0x1a5)],{'method':_0x56dc09(0x1cc),'headers':{'Content-Type':_0x56dc09(0x188),'Accept':'application/json','User-Agent':_0x56dc09(0x15a)},'body':JSON['stringify'](_0x59cf00)}),_0x5aef98=Date[_0x56dc09(0x18c)]()-_0x110d19;console[_0x56dc09(0x1c9)](_0x56dc09(0x1d1)),console[_0x56dc09(0x1c9)](_0x56dc09(0x1b2),_0x2c9306[_0x56dc09(0x19f)]),console[_0x56dc09(0x1c9)](_0x56dc09(0x1cb),_0x2c9306['statusText']),console[_0x56dc09(0x1c9)](_0x56dc09(0x1b1),Object[_0x56dc09(0x174)](_0x2c9306['headers'][_0x56dc09(0x155)]())),console['log']('Response\x20Time:',_0x5aef98+'ms');const _0x2756dc=await _0x2c9306[_0x56dc09(0x192)]();console['log']('Raw\x20Response\x20Body:',_0x2756dc);if(!_0x2c9306['ok']){console[_0x56dc09(0x16d)]('===\x20COINTOPAY\x20API\x20ERROR\x20==='),console[_0x56dc09(0x16d)]('HTTP\x20Status:',_0x2c9306['status']),console[_0x56dc09(0x16d)](_0x56dc09(0x1aa),_0x2756dc),loggerService_1[_0x56dc09(0x17b)][_0x56dc09(0x185)](_0x56dc09(0x1ce),_0x56dc09(0x178),_0x2c9306['status'],_0x2756dc,_0x5aef98),loggerService_1[_0x56dc09(0x17b)][_0x56dc09(0x1c6)](_0x56dc09(0x1ce),_0x56dc09(0x178),'HTTP\x20'+_0x2c9306[_0x56dc09(0x19f)]+':\x20'+_0x2756dc);throw new Error(_0x56dc09(0x15f)+_0x2c9306[_0x56dc09(0x19f)]+',\x20body:\x20'+_0x2756dc);}let _0x182537;try{_0x182537=JSON[_0x56dc09(0x1c3)](_0x2756dc);}catch(_0x1b3c6e){console[_0x56dc09(0x16d)](_0x56dc09(0x161),_0x1b3c6e),loggerService_1[_0x56dc09(0x17b)][_0x56dc09(0x1c6)](_0x56dc09(0x1ce),_0x56dc09(0x178),_0x56dc09(0x1a3)+_0x1b3c6e);throw new Error(_0x56dc09(0x196)+_0x2756dc);}console['log'](_0x56dc09(0x1cd)),console[_0x56dc09(0x1c9)]('Parsed\x20Result:',JSON[_0x56dc09(0x175)](_0x182537,null,0x2)),loggerService_1[_0x56dc09(0x17b)]['logWhiteDomainResponse']('cointopay',_0x56dc09(0x178),_0x2c9306[_0x56dc09(0x19f)],_0x182537,_0x5aef98);if(_0x182537[_0x56dc09(0x16d)]){const _0x8117b0=_0x182537[_0x56dc09(0x157)]||_0x182537[_0x56dc09(0x16d)]||_0x56dc09(0x18e);console[_0x56dc09(0x16d)](_0x56dc09(0x19b)),console[_0x56dc09(0x16d)]('Error\x20Message:',_0x8117b0),loggerService_1[_0x56dc09(0x17b)][_0x56dc09(0x1c6)](_0x56dc09(0x1ce),_0x56dc09(0x178),'Business\x20Error:\x20'+_0x8117b0);throw new Error('CoinToPay\x20API\x20error:\x20'+_0x8117b0);}if(!_0x182537['payment_url']||!_0x182537['gateway_payment_id']){console[_0x56dc09(0x16d)](_0x56dc09(0x160)),console[_0x56dc09(0x16d)](_0x56dc09(0x153)),console['error'](_0x56dc09(0x184),_0x182537),loggerService_1[_0x56dc09(0x17b)][_0x56dc09(0x1c6)](_0x56dc09(0x1ce),_0x56dc09(0x178),_0x56dc09(0x158));throw new Error(_0x56dc09(0x164));}return console['log']('===\x20COINTOPAY\x20SUCCESS\x20==='),console['log']('Gateway\x20Payment\x20ID:',_0x182537[_0x56dc09(0x18d)]),console['log'](_0x56dc09(0x1bb),_0x182537['payment_url']),console[_0x56dc09(0x1c9)](_0x56dc09(0x1c0),_0x5e28d4,_0x56dc09(0x1ad)),{'gateway_payment_id':_0x182537[_0x56dc09(0x18d)],'payment_url':_0x182537[_0x56dc09(0x1a0)]};}catch(_0x470578){console['error'](_0x56dc09(0x17f)),console[_0x56dc09(0x16d)](_0x56dc09(0x1b6),_0x470578),loggerService_1[_0x56dc09(0x17b)][_0x56dc09(0x1c6)](_0x56dc09(0x1ce),_0x56dc09(0x178),_0x470578);if(_0x470578 instanceof Error){console[_0x56dc09(0x16d)]('Error\x20message:',_0x470578[_0x56dc09(0x157)]),console[_0x56dc09(0x16d)]('Error\x20stack:',_0x470578[_0x56dc09(0x1bf)]);throw new Error(_0x56dc09(0x165)+_0x470578[_0x56dc09(0x157)]);}throw new Error('Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20Unknown\x20error');}}async[a38_0x400f7a(0x1d3)](_0x277f0b){const _0x9084bb=a38_0x400f7a,_0x22603e=Date[_0x9084bb(0x18c)]();try{console[_0x9084bb(0x1c9)](_0x9084bb(0x1c2)+_0x277f0b);const _0x2e702b={'gatewayPaymentId':_0x277f0b};loggerService_1['loggerService'][_0x9084bb(0x163)](_0x9084bb(0x1ce),_0x9084bb(0x162),'POST',_0x2e702b);const _0x487b77=await fetch(this['statusUrl'],{'method':_0x9084bb(0x1cc),'headers':{'Content-Type':_0x9084bb(0x188),'Accept':'application/json','User-Agent':_0x9084bb(0x15a)},'body':JSON['stringify'](_0x2e702b)}),_0x50962c=Date[_0x9084bb(0x18c)]()-_0x22603e;console[_0x9084bb(0x1c9)]('===\x20COINTOPAY\x20STATUS\x20CHECK\x20RESPONSE\x20==='),console[_0x9084bb(0x1c9)](_0x9084bb(0x1b2),_0x487b77[_0x9084bb(0x19f)]),console['log'](_0x9084bb(0x1be),_0x50962c+'ms');if(!_0x487b77['ok']){const _0x1f766f=await _0x487b77[_0x9084bb(0x192)]();console['error'](_0x9084bb(0x167),_0x487b77[_0x9084bb(0x19f)]),console['error']('Response\x20Body:',_0x1f766f),loggerService_1[_0x9084bb(0x17b)][_0x9084bb(0x185)]('cointopay',_0x9084bb(0x162),_0x487b77['status'],_0x1f766f,_0x50962c),loggerService_1[_0x9084bb(0x17b)][_0x9084bb(0x1c6)]('cointopay','/status',_0x9084bb(0x18a)+_0x487b77[_0x9084bb(0x19f)]+':\x20'+_0x1f766f);throw new Error(_0x9084bb(0x15f)+_0x487b77['status']);}const _0x1d29e5=await _0x487b77[_0x9084bb(0x192)]();console[_0x9084bb(0x1c9)]('Raw\x20Response\x20Body:',_0x1d29e5);let _0x3f14a6;try{_0x3f14a6=JSON[_0x9084bb(0x1c3)](_0x1d29e5);}catch(_0x139402){console[_0x9084bb(0x16d)](_0x9084bb(0x161),_0x139402),loggerService_1[_0x9084bb(0x17b)][_0x9084bb(0x1c6)](_0x9084bb(0x1ce),_0x9084bb(0x162),_0x9084bb(0x1a3)+_0x139402);throw new Error(_0x9084bb(0x1a7)+_0x1d29e5);}loggerService_1[_0x9084bb(0x17b)]['logWhiteDomainResponse']('cointopay','/status',_0x487b77['status'],_0x3f14a6,_0x50962c),console[_0x9084bb(0x1c9)](_0x9084bb(0x1ab)),console[_0x9084bb(0x1c9)](_0x9084bb(0x1a4),_0x3f14a6[_0x9084bb(0x189)]),console[_0x9084bb(0x1c9)]('Status\x20Code:',_0x3f14a6[_0x9084bb(0x19d)]),console[_0x9084bb(0x1c9)](_0x9084bb(0x17e),_0x3f14a6['data']?.[_0x9084bb(0x154)]),console[_0x9084bb(0x1c9)](_0x9084bb(0x1c0),_0x3f14a6[_0x9084bb(0x1a2)]?.[_0x9084bb(0x1a1)]),console[_0x9084bb(0x1c9)]('Currency:',_0x3f14a6[_0x9084bb(0x1a2)]?.['inputCurrency']);if(_0x3f14a6[_0x9084bb(0x189)]!==_0x9084bb(0x186)||_0x3f14a6[_0x9084bb(0x19d)]!==0xc8){const _0x3cfcac=_0x3f14a6[_0x9084bb(0x157)]||'Unknown\x20error\x20from\x20CoinToPay\x20status\x20API';console['error'](_0x9084bb(0x173)),console['error'](_0x9084bb(0x1b9),_0x3cfcac),loggerService_1[_0x9084bb(0x17b)][_0x9084bb(0x1c6)](_0x9084bb(0x1ce),_0x9084bb(0x162),_0x9084bb(0x17c)+_0x3cfcac);throw new Error(_0x9084bb(0x198)+_0x3cfcac);}if(!_0x3f14a6[_0x9084bb(0x1a2)]){console['error'](_0x9084bb(0x169)),console['error'](_0x9084bb(0x16f)),loggerService_1[_0x9084bb(0x17b)]['logWhiteDomainError'](_0x9084bb(0x1ce),_0x9084bb(0x162),'Incomplete\x20response:\x20missing\x20data');throw new Error('Invalid\x20response\x20from\x20CoinToPay\x20status\x20API:\x20missing\x20data');}let _0x4790c4='PENDING';switch(_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x154)]?.[_0x9084bb(0x181)]()){case _0x9084bb(0x19a):_0x4790c4=_0x9084bb(0x171);break;case _0x9084bb(0x18b):case _0x9084bb(0x19e):case'error':_0x4790c4=_0x9084bb(0x1a6);break;case _0x9084bb(0x1b7):case _0x9084bb(0x1bc):_0x4790c4=_0x9084bb(0x1b4);break;case'waiting':case'awaiting\x20fiat':case _0x9084bb(0x15d):case _0x9084bb(0x168):default:_0x4790c4='PENDING';break;}let _0x161f8f,_0x4b89ed;if(_0x3f14a6['data'][_0x9084bb(0x177)]){const _0x5e0233=_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x177)];console['log'](_0x9084bb(0x1bd),_0x5e0233);const _0x3415d9=_0x5e0233[_0x9084bb(0x170)](/IBAN\s+([A-Z0-9]+)/i);_0x3415d9&&(_0x161f8f=_0x3415d9[0x1],console['log']('üè¶\x20Extracted\x20IBAN:',_0x161f8f)),_0x4b89ed=_0x5e0233;}const _0x5e55ca={'iban':_0x161f8f,'bankDetails':_0x4b89ed,'transactionId':_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x1b8)],'coinAddress':_0x3f14a6[_0x9084bb(0x1a2)]['coinAddress'],'qrCodeUrl':_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x1c1)],'expiryTime':_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x15b)],'createdOn':_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x1c5)],'confirmedOn':_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x1b5)]};console[_0x9084bb(0x1c9)](_0x9084bb(0x176)),console[_0x9084bb(0x1c9)]('Status:',_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x154)],'->',_0x4790c4),console[_0x9084bb(0x1c9)](_0x9084bb(0x1c0),_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x1a1)],_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x180)]),console[_0x9084bb(0x1c9)]('Transaction\x20ID:',_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x1b8)]),console['log'](_0x9084bb(0x1c4),_0x161f8f||_0x9084bb(0x1a8)),console['log'](_0x9084bb(0x1ac),_0x3f14a6[_0x9084bb(0x1a2)]['CreatedOn']),console[_0x9084bb(0x1c9)](_0x9084bb(0x191),_0x3f14a6['data'][_0x9084bb(0x1b5)]||_0x9084bb(0x194));if(_0x3f14a6[_0x9084bb(0x1a2)]['Status']?.[_0x9084bb(0x181)]()===_0x9084bb(0x1ca))console[_0x9084bb(0x1c9)](_0x9084bb(0x1d2));else _0x3f14a6[_0x9084bb(0x1a2)]['Status']?.[_0x9084bb(0x181)]()===_0x9084bb(0x19a)&&console[_0x9084bb(0x1c9)]('‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID');return{'status':_0x4790c4,'amount':parseFloat(_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x1a1)])||undefined,'currency':_0x3f14a6[_0x9084bb(0x1a2)][_0x9084bb(0x180)]||_0x9084bb(0x1ad),'paymentDetails':_0x5e55ca};}catch(_0x168799){console['error'](_0x9084bb(0x1c7),_0x168799),loggerService_1[_0x9084bb(0x17b)][_0x9084bb(0x1c6)](_0x9084bb(0x1ce),_0x9084bb(0x162),_0x168799);throw new Error(_0x9084bb(0x1ae)+(_0x168799 instanceof Error?_0x168799[_0x9084bb(0x157)]:_0x9084bb(0x179)));}}async[a38_0x400f7a(0x1af)](_0x11ba86){const _0x5c951f=a38_0x400f7a,_0x582855=await this['checkPaymentStatus'](_0x11ba86);return{'status':_0x582855['status'],'amount':_0x582855['amount'],'currency':_0x582855[_0x5c951f(0x16a)]};}async[a38_0x400f7a(0x17d)](_0x5ad7d4){const _0x34d66b=a38_0x400f7a;console[_0x34d66b(0x1c9)]('Processing\x20CoinToPay\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x5ad7d4);let _0x164e5c='PENDING';switch(_0x5ad7d4[_0x34d66b(0x19f)]?.[_0x34d66b(0x181)]()){case _0x34d66b(0x19a):_0x164e5c=_0x34d66b(0x171);break;case _0x34d66b(0x18b):case _0x34d66b(0x19e):case _0x34d66b(0x16d):_0x164e5c='FAILED';break;case _0x34d66b(0x1b7):case'timeout':_0x164e5c='EXPIRED';break;case _0x34d66b(0x15d):case'waiting':case _0x34d66b(0x1ca):case _0x34d66b(0x168):default:_0x164e5c=_0x34d66b(0x15c);break;}return{'paymentId':_0x5ad7d4[_0x34d66b(0x19c)]||_0x5ad7d4[_0x34d66b(0x1ba)]||'','status':_0x164e5c,'amount':_0x5ad7d4[_0x34d66b(0x16e)],'currency':_0x5ad7d4[_0x34d66b(0x16a)]||_0x34d66b(0x1ad)};}}exports['CoinToPayService']=CoinToPayService;