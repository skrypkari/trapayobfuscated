'use strict';const a43_0x46931f=a43_0x5117;(function(_0x17c68c,_0x1fd802){const _0x565b32=a43_0x5117,_0x4ce258=_0x17c68c();while(!![]){try{const _0x1501a0=parseInt(_0x565b32(0xf2))/0x1*(parseInt(_0x565b32(0x13b))/0x2)+-parseInt(_0x565b32(0x124))/0x3*(-parseInt(_0x565b32(0x133))/0x4)+-parseInt(_0x565b32(0x11b))/0x5*(-parseInt(_0x565b32(0xe8))/0x6)+-parseInt(_0x565b32(0x14c))/0x7+parseInt(_0x565b32(0xf5))/0x8+parseInt(_0x565b32(0x112))/0x9*(parseInt(_0x565b32(0x118))/0xa)+-parseInt(_0x565b32(0x11f))/0xb*(parseInt(_0x565b32(0x159))/0xc);if(_0x1501a0===_0x1fd802)break;else _0x4ce258['push'](_0x4ce258['shift']());}catch(_0x3844b9){_0x4ce258['push'](_0x4ce258['shift']());}}}(a43_0x55c1,0x7c582));function a43_0x55c1(){const _0x354615=['/status','/create','===\x20COINTOPAY\x20STATUS\x20API\x20ERROR\x20===','logWhiteDomainError','statusText','cancelled','Missing\x20data\x20in\x20response','status_code','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20','logWhiteDomainRequest','log','üìä\x20Checking\x20CoinToPay\x20payment\x20status\x20for:\x20','24OQJeDW','ü™ô\x20CoinToPay\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','cointopay','loggerService','===\x20COINTOPAY\x20STATUS\x20CHECK\x20RESPONSE\x20===','created','Error\x20Message:','FAILED','Status\x20Text:','===\x20COINTOPAY\x20STATUS\x20SUCCESS\x20===','checkPaymentStatus','pending','Headers:','Invalid\x20response\x20from\x20CoinToPay\x20status\x20API:\x20missing\x20data','Status:','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','toLowerCase','Response\x20Time:','Response\x20data:','20592OuhZIO','Parsed\x20Result:','CoinToPay\x20status\x20API\x20error:\x20','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','IBAN:','üìä\x20Status\x20check\x20URL:','result','Failed\x20to\x20parse\x20JSON\x20response:','Unknown\x20error','apiUrl','142183eqJtDJ','CoinToPayService','Error\x20stack:','551792QRvFXT','===\x20COINTOPAY\x20API\x20REQUEST\x20(White\x20Domain)\x20===','Status','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20API:\x20','match','data','===\x20COINTOPAY\x20API\x20INCOMPLETE\x20RESPONSE\x20===','logWhiteDomainResponse','TransactionID','inputCurrency','===\x20PARSED\x20COINTOPAY\x20STATUS\x20RESPONSE\x20===','application/json','payment_url','gateway_payment_id','CreatedOn','status','amount','EXPIRED','Currency:','Status\x20API\x20Error:\x20','verifyPayment','Business\x20Error:\x20','success','waiting','awaiting\x20fiat','error','Processing\x20CoinToPay\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','===\x20COINTOPAY\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','Raw\x20Response\x20Body:','4019922zANKaI','Amount:','statusUrl','currency','Status\x20Code:','===\x20COINTOPAY\x20SUCCESS\x20===','20HThjoW','POST','HTTP\x20error!\x20status:\x20','1170WpUrkk','coinAddress','now','EUR\x20(always\x20EUR\x20for\x20CoinToPay)','9069247FhVBRS','stringify','timeout','===\x20COINTOPAY\x20SERVICE\x20ERROR\x20===','Request\x20Body:','159lQsBXO','HTTP\x20','Invalid\x20response\x20from\x20CoinToPay\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','üè¶\x20Extracted\x20IBAN:','PAID','üè¶\x20Payment\x20Detail:','CoinToPay\x20API\x20error:\x20','JSON\x20Parse\x20Error:\x20','Response\x20Body:','Unknown\x20error\x20from\x20CoinToPay\x20API','TesSoft\x20Payment\x20System/1.0','===\x20PARSED\x20COINTOPAY\x20RESPONSE\x20===','PaymentDetail','entries','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20status\x20API:\x20','2012xVwaqj','Transaction\x20ID:','ExpiryTime','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','paid','fromEntries','stack','Payment\x20Status:','12ioXgbU','text','PENDING','EUR','\x20EUR','https://tesoft.uk/gateway/cointopay/status.php','expired','===\x20COINTOPAY\x20API\x20ERROR\x20===','message','TransactionConfirmedOn','order_id','Error\x20message:','ü™ô\x20Creating\x20CoinToPay\x20payment:\x20','HTTP\x20Status:','CoinToPay\x20payment\x20status\x20check\x20error:','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20Unknown\x20error','parse','3408069mzRELP'];a43_0x55c1=function(){return _0x354615;};return a43_0x55c1();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a43_0x46931f(0xf3)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPayService{constructor(){const _0x57ff7e=a43_0x46931f;this[_0x57ff7e(0xf1)]='https://tesoft.uk/gateway/cointopay/',this['statusUrl']=_0x57ff7e(0x140),console[_0x57ff7e(0x157)](_0x57ff7e(0x15a)),console[_0x57ff7e(0x157)](_0x57ff7e(0xed),this['statusUrl']);}async['createPaymentLink'](_0x50dc9d){const _0x4e2c9d=a43_0x46931f,{orderId:_0xf7921c,amount:_0x190bbd}=_0x50dc9d;console[_0x4e2c9d(0x157)](_0x4e2c9d(0x147)+_0x190bbd+_0x4e2c9d(0x13f));const _0x3e1f8c={'amount':_0x190bbd},_0xcec42f=Date[_0x4e2c9d(0x11d)]();try{console['log'](_0x4e2c9d(0xf6)),console[_0x4e2c9d(0x157)]('URL:',this[_0x4e2c9d(0xf1)]),console['log'](_0x4e2c9d(0x123),JSON['stringify'](_0x3e1f8c,null,0x2)),console['log'](_0x4e2c9d(0x113),_0x190bbd,_0x4e2c9d(0x11e)),loggerService_1[_0x4e2c9d(0x15c)][_0x4e2c9d(0x156)]('cointopay','/create',_0x4e2c9d(0x119),_0x3e1f8c);const _0x1185e6=await fetch(this[_0x4e2c9d(0xf1)],{'method':_0x4e2c9d(0x119),'headers':{'Content-Type':_0x4e2c9d(0x100),'Accept':_0x4e2c9d(0x100),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x4e2c9d(0x120)](_0x3e1f8c)}),_0x5de711=Date[_0x4e2c9d(0x11d)]()-_0xcec42f;console[_0x4e2c9d(0x157)](_0x4e2c9d(0x110)),console[_0x4e2c9d(0x157)](_0x4e2c9d(0x167),_0x1185e6[_0x4e2c9d(0x104)]),console[_0x4e2c9d(0x157)](_0x4e2c9d(0x161),_0x1185e6[_0x4e2c9d(0x151)]),console[_0x4e2c9d(0x157)](_0x4e2c9d(0x165),Object[_0x4e2c9d(0x138)](_0x1185e6['headers'][_0x4e2c9d(0x131)]())),console[_0x4e2c9d(0x157)](_0x4e2c9d(0xe6),_0x5de711+'ms');const _0xd20f02=await _0x1185e6[_0x4e2c9d(0x13c)]();console[_0x4e2c9d(0x157)](_0x4e2c9d(0x111),_0xd20f02);if(!_0x1185e6['ok']){console[_0x4e2c9d(0x10e)](_0x4e2c9d(0x142)),console[_0x4e2c9d(0x10e)](_0x4e2c9d(0x148),_0x1185e6[_0x4e2c9d(0x104)]),console['error'](_0x4e2c9d(0x12c),_0xd20f02),loggerService_1[_0x4e2c9d(0x15c)][_0x4e2c9d(0xfc)]('cointopay',_0x4e2c9d(0x14e),_0x1185e6[_0x4e2c9d(0x104)],_0xd20f02,_0x5de711),loggerService_1[_0x4e2c9d(0x15c)][_0x4e2c9d(0x150)]('cointopay',_0x4e2c9d(0x14e),_0x4e2c9d(0x125)+_0x1185e6[_0x4e2c9d(0x104)]+':\x20'+_0xd20f02);throw new Error(_0x4e2c9d(0x11a)+_0x1185e6['status']+',\x20body:\x20'+_0xd20f02);}let _0x26482f;try{_0x26482f=JSON[_0x4e2c9d(0x14b)](_0xd20f02);}catch(_0x2cdb73){console[_0x4e2c9d(0x10e)](_0x4e2c9d(0xef),_0x2cdb73),loggerService_1['loggerService'][_0x4e2c9d(0x150)](_0x4e2c9d(0x15b),_0x4e2c9d(0x14e),_0x4e2c9d(0x12b)+_0x2cdb73);throw new Error(_0x4e2c9d(0xf8)+_0xd20f02);}console[_0x4e2c9d(0x157)](_0x4e2c9d(0x12f)),console['log'](_0x4e2c9d(0xe9),JSON[_0x4e2c9d(0x120)](_0x26482f,null,0x2)),loggerService_1[_0x4e2c9d(0x15c)]['logWhiteDomainResponse'](_0x4e2c9d(0x15b),_0x4e2c9d(0x14e),_0x1185e6[_0x4e2c9d(0x104)],_0x26482f,_0x5de711);if(_0x26482f[_0x4e2c9d(0x10e)]){const _0xf352d6=_0x26482f['message']||_0x26482f['error']||_0x4e2c9d(0x12d);console[_0x4e2c9d(0x10e)]('===\x20COINTOPAY\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x4e2c9d(0x10e)](_0x4e2c9d(0x15f),_0xf352d6),loggerService_1[_0x4e2c9d(0x15c)][_0x4e2c9d(0x150)](_0x4e2c9d(0x15b),'/create',_0x4e2c9d(0x10a)+_0xf352d6);throw new Error(_0x4e2c9d(0x12a)+_0xf352d6);}if(!_0x26482f[_0x4e2c9d(0x101)]||!_0x26482f[_0x4e2c9d(0x102)]){console['error'](_0x4e2c9d(0xfb)),console[_0x4e2c9d(0x10e)]('Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response'),console[_0x4e2c9d(0x10e)](_0x4e2c9d(0xe7),_0x26482f),loggerService_1[_0x4e2c9d(0x15c)][_0x4e2c9d(0x150)]('cointopay',_0x4e2c9d(0x14e),_0x4e2c9d(0xeb));throw new Error(_0x4e2c9d(0x126));}return console[_0x4e2c9d(0x157)](_0x4e2c9d(0x117)),console[_0x4e2c9d(0x157)]('Gateway\x20Payment\x20ID:',_0x26482f[_0x4e2c9d(0x102)]),console[_0x4e2c9d(0x157)]('Payment\x20URL:',_0x26482f[_0x4e2c9d(0x101)]),console[_0x4e2c9d(0x157)](_0x4e2c9d(0x113),_0x190bbd,_0x4e2c9d(0x13e)),{'gateway_payment_id':_0x26482f[_0x4e2c9d(0x102)],'payment_url':_0x26482f[_0x4e2c9d(0x101)]};}catch(_0x176eb5){console[_0x4e2c9d(0x10e)](_0x4e2c9d(0x122)),console[_0x4e2c9d(0x10e)]('Error\x20details:',_0x176eb5),loggerService_1['loggerService'][_0x4e2c9d(0x150)](_0x4e2c9d(0x15b),_0x4e2c9d(0x14e),_0x176eb5);if(_0x176eb5 instanceof Error){console[_0x4e2c9d(0x10e)](_0x4e2c9d(0x146),_0x176eb5[_0x4e2c9d(0x143)]),console[_0x4e2c9d(0x10e)](_0x4e2c9d(0xf4),_0x176eb5[_0x4e2c9d(0x139)]);throw new Error(_0x4e2c9d(0x155)+_0x176eb5[_0x4e2c9d(0x143)]);}throw new Error(_0x4e2c9d(0x14a));}}async[a43_0x46931f(0x163)](_0x4c59d0){const _0x507644=a43_0x46931f,_0x2e9710=Date['now']();try{console[_0x507644(0x157)](_0x507644(0x158)+_0x4c59d0);const _0x3b77dc={'gatewayPaymentId':_0x4c59d0};loggerService_1['loggerService'][_0x507644(0x156)]('cointopay',_0x507644(0x14d),_0x507644(0x119),_0x3b77dc);const _0x35fdda=await fetch(this[_0x507644(0x114)],{'method':'POST','headers':{'Content-Type':_0x507644(0x100),'Accept':_0x507644(0x100),'User-Agent':_0x507644(0x12e)},'body':JSON[_0x507644(0x120)](_0x3b77dc)}),_0x1dfd2a=Date[_0x507644(0x11d)]()-_0x2e9710;console[_0x507644(0x157)](_0x507644(0x15d)),console[_0x507644(0x157)]('Status:',_0x35fdda[_0x507644(0x104)]),console[_0x507644(0x157)](_0x507644(0xe6),_0x1dfd2a+'ms');if(!_0x35fdda['ok']){const _0x3acebf=await _0x35fdda[_0x507644(0x13c)]();console[_0x507644(0x10e)](_0x507644(0x148),_0x35fdda['status']),console[_0x507644(0x10e)](_0x507644(0x12c),_0x3acebf),loggerService_1['loggerService'][_0x507644(0xfc)]('cointopay',_0x507644(0x14d),_0x35fdda['status'],_0x3acebf,_0x1dfd2a),loggerService_1[_0x507644(0x15c)][_0x507644(0x150)]('cointopay',_0x507644(0x14d),'HTTP\x20'+_0x35fdda['status']+':\x20'+_0x3acebf);throw new Error(_0x507644(0x11a)+_0x35fdda['status']);}const _0x156309=await _0x35fdda[_0x507644(0x13c)]();console[_0x507644(0x157)]('Raw\x20Response\x20Body:',_0x156309);let _0x5812f0;try{_0x5812f0=JSON[_0x507644(0x14b)](_0x156309);}catch(_0x32c646){console[_0x507644(0x10e)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x32c646),loggerService_1[_0x507644(0x15c)]['logWhiteDomainError'](_0x507644(0x15b),_0x507644(0x14d),_0x507644(0x12b)+_0x32c646);throw new Error(_0x507644(0x132)+_0x156309);}loggerService_1[_0x507644(0x15c)][_0x507644(0xfc)](_0x507644(0x15b),'/status',_0x35fdda[_0x507644(0x104)],_0x5812f0,_0x1dfd2a),console[_0x507644(0x157)](_0x507644(0xff)),console[_0x507644(0x157)]('Result:',_0x5812f0[_0x507644(0xee)]),console['log'](_0x507644(0x116),_0x5812f0[_0x507644(0x154)]),console[_0x507644(0x157)](_0x507644(0x13a),_0x5812f0[_0x507644(0xfa)]?.[_0x507644(0xf7)]),console['log']('Amount:',_0x5812f0[_0x507644(0xfa)]?.['Amount']),console[_0x507644(0x157)](_0x507644(0x107),_0x5812f0[_0x507644(0xfa)]?.[_0x507644(0xfe)]);if(_0x5812f0[_0x507644(0xee)]!==_0x507644(0x10b)||_0x5812f0['status_code']!==0xc8){const _0x47637a=_0x5812f0[_0x507644(0x143)]||'Unknown\x20error\x20from\x20CoinToPay\x20status\x20API';console['error'](_0x507644(0x14f)),console[_0x507644(0x10e)](_0x507644(0x15f),_0x47637a),loggerService_1['loggerService'][_0x507644(0x150)](_0x507644(0x15b),'/status',_0x507644(0x108)+_0x47637a);throw new Error(_0x507644(0xea)+_0x47637a);}if(!_0x5812f0[_0x507644(0xfa)]){console['error']('===\x20COINTOPAY\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x507644(0x10e)](_0x507644(0x153)),loggerService_1[_0x507644(0x15c)]['logWhiteDomainError'](_0x507644(0x15b),_0x507644(0x14d),'Incomplete\x20response:\x20missing\x20data');throw new Error(_0x507644(0x166));}let _0x3e3dbb=_0x507644(0x13d);switch(_0x5812f0[_0x507644(0xfa)]['Status']?.['toLowerCase']()){case _0x507644(0x137):_0x3e3dbb=_0x507644(0x128);break;case _0x507644(0x152):case'failed':case _0x507644(0x10e):_0x3e3dbb=_0x507644(0x160);break;case _0x507644(0x141):case _0x507644(0x121):_0x3e3dbb=_0x507644(0x106);break;case _0x507644(0x10c):case _0x507644(0x10d):case _0x507644(0x164):case'created':default:_0x3e3dbb='PENDING';break;}let _0x1d9b14,_0x5bafcd;if(_0x5812f0['data'][_0x507644(0x130)]){const _0x5ab9b0=_0x5812f0['data']['PaymentDetail'];console[_0x507644(0x157)](_0x507644(0x129),_0x5ab9b0);const _0x4d3b91=_0x5ab9b0[_0x507644(0xf9)](/IBAN\s+([A-Z0-9]+)/i);_0x4d3b91&&(_0x1d9b14=_0x4d3b91[0x1],console[_0x507644(0x157)](_0x507644(0x127),_0x1d9b14)),_0x5bafcd=_0x5ab9b0;}const _0x3f0431={'iban':_0x1d9b14,'bankDetails':_0x5bafcd,'transactionId':_0x5812f0[_0x507644(0xfa)][_0x507644(0xfd)],'coinAddress':_0x5812f0[_0x507644(0xfa)][_0x507644(0x11c)],'qrCodeUrl':_0x5812f0[_0x507644(0xfa)]['QRCodeURL'],'expiryTime':_0x5812f0[_0x507644(0xfa)][_0x507644(0x135)],'createdOn':_0x5812f0[_0x507644(0xfa)][_0x507644(0x103)],'confirmedOn':_0x5812f0[_0x507644(0xfa)][_0x507644(0x144)]};console[_0x507644(0x157)](_0x507644(0x162)),console[_0x507644(0x157)](_0x507644(0x167),_0x5812f0[_0x507644(0xfa)][_0x507644(0xf7)],'->',_0x3e3dbb),console['log'](_0x507644(0x113),_0x5812f0['data']['Amount'],_0x5812f0[_0x507644(0xfa)][_0x507644(0xfe)]),console[_0x507644(0x157)](_0x507644(0x134),_0x5812f0[_0x507644(0xfa)]['TransactionID']),console[_0x507644(0x157)](_0x507644(0xec),_0x1d9b14||'not\x20found'),console[_0x507644(0x157)]('Created\x20On:',_0x5812f0[_0x507644(0xfa)][_0x507644(0x103)]),console[_0x507644(0x157)]('Confirmed\x20On:',_0x5812f0['data'][_0x507644(0x144)]||'not\x20confirmed');if(_0x5812f0[_0x507644(0xfa)][_0x507644(0xf7)]?.[_0x507644(0xe5)]()===_0x507644(0x10d))console[_0x507644(0x157)](_0x507644(0x168));else _0x5812f0[_0x507644(0xfa)][_0x507644(0xf7)]?.[_0x507644(0xe5)]()===_0x507644(0x137)&&console[_0x507644(0x157)](_0x507644(0x136));return{'status':_0x3e3dbb,'amount':parseFloat(_0x5812f0[_0x507644(0xfa)]['Amount'])||undefined,'currency':_0x5812f0['data'][_0x507644(0xfe)]||_0x507644(0x13e),'paymentDetails':_0x3f0431};}catch(_0x120049){console['error'](_0x507644(0x149),_0x120049),loggerService_1['loggerService'][_0x507644(0x150)](_0x507644(0x15b),_0x507644(0x14d),_0x120049);throw new Error('Failed\x20to\x20check\x20CoinToPay\x20payment\x20status:\x20'+(_0x120049 instanceof Error?_0x120049[_0x507644(0x143)]:_0x507644(0xf0)));}}async[a43_0x46931f(0x109)](_0x3f7774){const _0x92fbda=a43_0x46931f,_0x38b475=await this[_0x92fbda(0x163)](_0x3f7774);return{'status':_0x38b475[_0x92fbda(0x104)],'amount':_0x38b475[_0x92fbda(0x105)],'currency':_0x38b475[_0x92fbda(0x115)]};}async['processWebhook'](_0x4b37d1){const _0x3ba10b=a43_0x46931f;console[_0x3ba10b(0x157)](_0x3ba10b(0x10f),_0x4b37d1);let _0x370f49='PENDING';switch(_0x4b37d1['status']?.[_0x3ba10b(0xe5)]()){case _0x3ba10b(0x137):_0x370f49='PAID';break;case _0x3ba10b(0x152):case'failed':case'error':_0x370f49=_0x3ba10b(0x160);break;case _0x3ba10b(0x141):case _0x3ba10b(0x121):_0x370f49=_0x3ba10b(0x106);break;case'pending':case _0x3ba10b(0x10c):case _0x3ba10b(0x10d):case _0x3ba10b(0x15e):default:_0x370f49=_0x3ba10b(0x13d);break;}return{'paymentId':_0x4b37d1[_0x3ba10b(0x145)]||_0x4b37d1['merchant_reference_id']||'','status':_0x370f49,'amount':_0x4b37d1['amount'],'currency':_0x4b37d1[_0x3ba10b(0x115)]||'EUR'};}}function a43_0x5117(_0x9886e,_0x5f5920){const _0x55c13c=a43_0x55c1();return a43_0x5117=function(_0x511713,_0x1b19e7){_0x511713=_0x511713-0xe5;let _0x1acf9a=_0x55c13c[_0x511713];return _0x1acf9a;},a43_0x5117(_0x9886e,_0x5f5920);}exports[a43_0x46931f(0xf3)]=CoinToPayService;