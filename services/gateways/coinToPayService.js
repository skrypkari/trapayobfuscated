'use strict';const a40_0x4d8007=a40_0x1abb;(function(_0x19bf1e,_0x164b3b){const _0x30d1dc=a40_0x1abb,_0x3b6342=_0x19bf1e();while(!![]){try{const _0x55f800=parseInt(_0x30d1dc(0x235))/0x1*(parseInt(_0x30d1dc(0x1ea))/0x2)+parseInt(_0x30d1dc(0x228))/0x3+-parseInt(_0x30d1dc(0x209))/0x4*(parseInt(_0x30d1dc(0x253))/0x5)+parseInt(_0x30d1dc(0x258))/0x6+parseInt(_0x30d1dc(0x22b))/0x7+parseInt(_0x30d1dc(0x206))/0x8+-parseInt(_0x30d1dc(0x204))/0x9;if(_0x55f800===_0x164b3b)break;else _0x3b6342['push'](_0x3b6342['shift']());}catch(_0x9c6fe4){_0x3b6342['push'](_0x3b6342['shift']());}}}(a40_0xc8b5,0xa5697));function a40_0x1abb(_0x325e75,_0x58c149){const _0xc8b5cf=a40_0xc8b5();return a40_0x1abb=function(_0x1abba2,_0x3ccae6){_0x1abba2=_0x1abba2-0x1e4;let _0x5f2e45=_0xc8b5cf[_0x1abba2];return _0x5f2e45;},a40_0x1abb(_0x325e75,_0x58c149);}function a40_0xc8b5(){const _0x119d73=['loggerService','amount','created','Status','statusText','Unknown\x20error\x20from\x20CoinToPay\x20status\x20API','===\x20COINTOPAY\x20API\x20ERROR\x20===','paid','1862283EKRaLf','defineProperty','statusUrl','5386927EhJJsb','now','Invalid\x20response\x20from\x20CoinToPay\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','text','waiting','Payment\x20Status:','JSON\x20Parse\x20Error:\x20','cancelled','Failed\x20to\x20check\x20CoinToPay\x20payment\x20status:\x20','not\x20confirmed','166973FKBaIz','Status\x20API\x20Error:\x20','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','PAID','FAILED','===\x20COINTOPAY\x20STATUS\x20API\x20ERROR\x20===','logWhiteDomainError','===\x20PARSED\x20COINTOPAY\x20STATUS\x20RESPONSE\x20===','parse','Incomplete\x20response:\x20missing\x20data','===\x20COINTOPAY\x20STATUS\x20SUCCESS\x20===','Result:','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20Unknown\x20error','Response\x20Body:','timeout','===\x20COINTOPAY\x20API\x20REQUEST\x20(White\x20Domain)\x20===','TransactionID','not\x20found','HTTP\x20','POST','Confirmed\x20On:','CreatedOn','verifyPayment','===\x20COINTOPAY\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','expired','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','===\x20COINTOPAY\x20STATUS\x20CHECK\x20RESPONSE\x20===','inputCurrency','Currency:','https://tesoft.uk/gateway/cointopay/status.php','10VDxSlj','EXPIRED','URL:','===\x20PARSED\x20COINTOPAY\x20RESPONSE\x20===','merchant_reference_id','3011724WEBgiR','processWebhook','payment_url','Error\x20details:','data','https://tesoft.uk/gateway/cointopay/','Invalid\x20response\x20from\x20CoinToPay\x20status\x20API:\x20missing\x20data','CoinToPayService','error','ü™ô\x20Creating\x20CoinToPay\x20payment:\x20','stringify','Parsed\x20Result:','===\x20COINTOPAY\x20SERVICE\x20ERROR\x20===','Raw\x20Response\x20Body:','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','Error\x20stack:','PENDING','Business\x20Error:\x20',',\x20body:\x20','2vzfRfs','failed','/create','fromEntries','checkPaymentStatus','TransactionConfirmedOn','Response\x20data:','Request\x20Body:','QRCodeURL','gateway_payment_id','EUR','application/json','pending','HTTP\x20Status:','HTTP\x20error!\x20status:\x20','logWhiteDomainRequest','IBAN:','log','awaiting\x20fiat','Status:','===\x20COINTOPAY\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','stack','Error\x20message:','cointopay','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20status\x20API:\x20','Missing\x20data\x20in\x20response','16889256Jpisbp','Payment\x20URL:','5366624hcxmSE','Status\x20Code:','Amount:','351932SDlRwl','coinAddress','üè¶\x20Extracted\x20IBAN:','apiUrl','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20','createPaymentLink','entries','logWhiteDomainResponse','\x20EUR','status','toLowerCase','Error\x20Message:','CoinToPay\x20status\x20API\x20error:\x20','message','Amount','TesSoft\x20Payment\x20System/1.0','status_code','===\x20COINTOPAY\x20API\x20BUSINESS\x20ERROR\x20===','Response\x20Time:','ü™ô\x20CoinToPay\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','CoinToPay\x20payment\x20status\x20check\x20error:','Transaction\x20ID:','/status'];a40_0xc8b5=function(){return _0x119d73;};return a40_0xc8b5();}Object[a40_0x4d8007(0x229)](exports,'__esModule',{'value':!![]}),exports[a40_0x4d8007(0x25f)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPayService{constructor(){const _0x238d6f=a40_0x4d8007;this[_0x238d6f(0x20c)]=_0x238d6f(0x25d),this[_0x238d6f(0x22a)]=_0x238d6f(0x252),console['log'](_0x238d6f(0x21c)),console[_0x238d6f(0x1fb)]('üìä\x20Status\x20check\x20URL:',this[_0x238d6f(0x22a)]);}async[a40_0x4d8007(0x20e)](_0x2d8830){const _0xe92336=a40_0x4d8007,{orderId:_0x34dcbc,amount:_0x2dcd4a}=_0x2d8830;console[_0xe92336(0x1fb)](_0xe92336(0x261)+_0x2dcd4a+_0xe92336(0x211));const _0x5dc0d9={'amount':_0x2dcd4a},_0x5b515d=Date[_0xe92336(0x22c)]();try{console[_0xe92336(0x1fb)](_0xe92336(0x244)),console[_0xe92336(0x1fb)](_0xe92336(0x255),this[_0xe92336(0x20c)]),console[_0xe92336(0x1fb)](_0xe92336(0x1f1),JSON['stringify'](_0x5dc0d9,null,0x2)),console[_0xe92336(0x1fb)](_0xe92336(0x208),_0x2dcd4a,'EUR\x20(always\x20EUR\x20for\x20CoinToPay)'),loggerService_1['loggerService'][_0xe92336(0x1f9)](_0xe92336(0x201),_0xe92336(0x1ec),_0xe92336(0x248),_0x5dc0d9);const _0x5a32e1=await fetch(this[_0xe92336(0x20c)],{'method':_0xe92336(0x248),'headers':{'Content-Type':'application/json','Accept':'application/json','User-Agent':_0xe92336(0x218)},'body':JSON[_0xe92336(0x262)](_0x5dc0d9)}),_0x6bfe84=Date[_0xe92336(0x22c)]()-_0x5b515d;console['log'](_0xe92336(0x24c)),console['log'](_0xe92336(0x1fd),_0x5a32e1['status']),console['log']('Status\x20Text:',_0x5a32e1[_0xe92336(0x224)]),console[_0xe92336(0x1fb)]('Headers:',Object[_0xe92336(0x1ed)](_0x5a32e1['headers'][_0xe92336(0x20f)]())),console['log'](_0xe92336(0x21b),_0x6bfe84+'ms');const _0x365a88=await _0x5a32e1[_0xe92336(0x22e)]();console[_0xe92336(0x1fb)](_0xe92336(0x1e4),_0x365a88);if(!_0x5a32e1['ok']){console[_0xe92336(0x260)](_0xe92336(0x226)),console['error']('HTTP\x20Status:',_0x5a32e1[_0xe92336(0x212)]),console['error'](_0xe92336(0x242),_0x365a88),loggerService_1[_0xe92336(0x220)][_0xe92336(0x210)](_0xe92336(0x201),_0xe92336(0x1ec),_0x5a32e1[_0xe92336(0x212)],_0x365a88,_0x6bfe84),loggerService_1[_0xe92336(0x220)][_0xe92336(0x23b)](_0xe92336(0x201),'/create','HTTP\x20'+_0x5a32e1[_0xe92336(0x212)]+':\x20'+_0x365a88);throw new Error(_0xe92336(0x1f8)+_0x5a32e1['status']+_0xe92336(0x1e9)+_0x365a88);}let _0x1cbdb4;try{_0x1cbdb4=JSON[_0xe92336(0x23d)](_0x365a88);}catch(_0x9c5d11){console[_0xe92336(0x260)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x9c5d11),loggerService_1[_0xe92336(0x220)]['logWhiteDomainError'](_0xe92336(0x201),'/create',_0xe92336(0x231)+_0x9c5d11);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20API:\x20'+_0x365a88);}console['log'](_0xe92336(0x256)),console['log'](_0xe92336(0x263),JSON['stringify'](_0x1cbdb4,null,0x2)),loggerService_1[_0xe92336(0x220)][_0xe92336(0x210)](_0xe92336(0x201),_0xe92336(0x1ec),_0x5a32e1[_0xe92336(0x212)],_0x1cbdb4,_0x6bfe84);if(_0x1cbdb4['error']){const _0x46e6a8=_0x1cbdb4[_0xe92336(0x216)]||_0x1cbdb4['error']||'Unknown\x20error\x20from\x20CoinToPay\x20API';console['error'](_0xe92336(0x21a)),console[_0xe92336(0x260)](_0xe92336(0x214),_0x46e6a8),loggerService_1['loggerService'][_0xe92336(0x23b)](_0xe92336(0x201),_0xe92336(0x1ec),_0xe92336(0x1e8)+_0x46e6a8);throw new Error('CoinToPay\x20API\x20error:\x20'+_0x46e6a8);}if(!_0x1cbdb4[_0xe92336(0x25a)]||!_0x1cbdb4[_0xe92336(0x1f3)]){console[_0xe92336(0x260)]('===\x20COINTOPAY\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0xe92336(0x260)](_0xe92336(0x24e)),console['error'](_0xe92336(0x1f0),_0x1cbdb4),loggerService_1['loggerService'][_0xe92336(0x23b)](_0xe92336(0x201),_0xe92336(0x1ec),'Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error(_0xe92336(0x22d));}return console[_0xe92336(0x1fb)]('===\x20COINTOPAY\x20SUCCESS\x20==='),console[_0xe92336(0x1fb)]('Gateway\x20Payment\x20ID:',_0x1cbdb4['gateway_payment_id']),console[_0xe92336(0x1fb)](_0xe92336(0x205),_0x1cbdb4[_0xe92336(0x25a)]),console['log']('Amount:',_0x2dcd4a,_0xe92336(0x1f4)),{'gateway_payment_id':_0x1cbdb4['gateway_payment_id'],'payment_url':_0x1cbdb4[_0xe92336(0x25a)]};}catch(_0x3ede4b){console[_0xe92336(0x260)](_0xe92336(0x264)),console['error'](_0xe92336(0x25b),_0x3ede4b),loggerService_1[_0xe92336(0x220)][_0xe92336(0x23b)]('cointopay',_0xe92336(0x1ec),_0x3ede4b);if(_0x3ede4b instanceof Error){console[_0xe92336(0x260)](_0xe92336(0x200),_0x3ede4b[_0xe92336(0x216)]),console[_0xe92336(0x260)](_0xe92336(0x1e6),_0x3ede4b[_0xe92336(0x1ff)]);throw new Error(_0xe92336(0x20d)+_0x3ede4b[_0xe92336(0x216)]);}throw new Error(_0xe92336(0x241));}}async[a40_0x4d8007(0x1ee)](_0xc6b8f0){const _0x179a00=a40_0x4d8007,_0x33f2a1=Date[_0x179a00(0x22c)]();try{console['log']('üìä\x20Checking\x20CoinToPay\x20payment\x20status\x20for:\x20'+_0xc6b8f0);const _0x292d22={'gatewayPaymentId':_0xc6b8f0};loggerService_1['loggerService'][_0x179a00(0x1f9)](_0x179a00(0x201),_0x179a00(0x21f),_0x179a00(0x248),_0x292d22);const _0x5169fb=await fetch(this[_0x179a00(0x22a)],{'method':_0x179a00(0x248),'headers':{'Content-Type':_0x179a00(0x1f5),'Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x179a00(0x262)](_0x292d22)}),_0x386de9=Date['now']()-_0x33f2a1;console['log'](_0x179a00(0x24f)),console[_0x179a00(0x1fb)](_0x179a00(0x1fd),_0x5169fb[_0x179a00(0x212)]),console['log'](_0x179a00(0x21b),_0x386de9+'ms');if(!_0x5169fb['ok']){const _0x4a6d43=await _0x5169fb[_0x179a00(0x22e)]();console[_0x179a00(0x260)](_0x179a00(0x1f7),_0x5169fb[_0x179a00(0x212)]),console[_0x179a00(0x260)](_0x179a00(0x242),_0x4a6d43),loggerService_1['loggerService']['logWhiteDomainResponse']('cointopay','/status',_0x5169fb[_0x179a00(0x212)],_0x4a6d43,_0x386de9),loggerService_1[_0x179a00(0x220)][_0x179a00(0x23b)](_0x179a00(0x201),_0x179a00(0x21f),_0x179a00(0x247)+_0x5169fb['status']+':\x20'+_0x4a6d43);throw new Error(_0x179a00(0x1f8)+_0x5169fb[_0x179a00(0x212)]);}const _0x5820ea=await _0x5169fb[_0x179a00(0x22e)]();console['log'](_0x179a00(0x1e4),_0x5820ea);let _0x390eb1;try{_0x390eb1=JSON[_0x179a00(0x23d)](_0x5820ea);}catch(_0x34ee9d){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0x34ee9d),loggerService_1['loggerService'][_0x179a00(0x23b)](_0x179a00(0x201),_0x179a00(0x21f),_0x179a00(0x231)+_0x34ee9d);throw new Error(_0x179a00(0x202)+_0x5820ea);}loggerService_1['loggerService']['logWhiteDomainResponse'](_0x179a00(0x201),_0x179a00(0x21f),_0x5169fb[_0x179a00(0x212)],_0x390eb1,_0x386de9),console[_0x179a00(0x1fb)](_0x179a00(0x23c)),console[_0x179a00(0x1fb)](_0x179a00(0x240),_0x390eb1['result']),console['log'](_0x179a00(0x207),_0x390eb1[_0x179a00(0x219)]),console[_0x179a00(0x1fb)](_0x179a00(0x230),_0x390eb1['data']?.[_0x179a00(0x223)]),console[_0x179a00(0x1fb)](_0x179a00(0x208),_0x390eb1[_0x179a00(0x25c)]?.[_0x179a00(0x217)]),console[_0x179a00(0x1fb)](_0x179a00(0x251),_0x390eb1[_0x179a00(0x25c)]?.['inputCurrency']);if(_0x390eb1['result']!=='success'||_0x390eb1['status_code']!==0xc8){const _0x18a9c2=_0x390eb1['message']||_0x179a00(0x225);console[_0x179a00(0x260)](_0x179a00(0x23a)),console[_0x179a00(0x260)](_0x179a00(0x214),_0x18a9c2),loggerService_1[_0x179a00(0x220)][_0x179a00(0x23b)]('cointopay',_0x179a00(0x21f),_0x179a00(0x236)+_0x18a9c2);throw new Error(_0x179a00(0x215)+_0x18a9c2);}if(!_0x390eb1[_0x179a00(0x25c)]){console[_0x179a00(0x260)](_0x179a00(0x1fe)),console[_0x179a00(0x260)](_0x179a00(0x203)),loggerService_1['loggerService']['logWhiteDomainError'](_0x179a00(0x201),_0x179a00(0x21f),_0x179a00(0x23e));throw new Error(_0x179a00(0x25e));}let _0x25eb95=_0x179a00(0x1e7);switch(_0x390eb1[_0x179a00(0x25c)][_0x179a00(0x223)]?.[_0x179a00(0x213)]()){case _0x179a00(0x227):_0x25eb95=_0x179a00(0x238);break;case _0x179a00(0x232):case _0x179a00(0x1eb):case'error':_0x25eb95=_0x179a00(0x239);break;case _0x179a00(0x24d):case _0x179a00(0x243):_0x25eb95=_0x179a00(0x254);break;case _0x179a00(0x22f):case _0x179a00(0x1fc):case _0x179a00(0x1f6):case _0x179a00(0x222):default:_0x25eb95=_0x179a00(0x1e7);break;}let _0x5c573c,_0x51c46b;if(_0x390eb1[_0x179a00(0x25c)]['PaymentDetail']){const _0x7cde16=_0x390eb1['data']['PaymentDetail'];console['log']('üè¶\x20Payment\x20Detail:',_0x7cde16);const _0x3fdd5e=_0x7cde16['match'](/IBAN\s+([A-Z0-9]+)/i);_0x3fdd5e&&(_0x5c573c=_0x3fdd5e[0x1],console[_0x179a00(0x1fb)](_0x179a00(0x20b),_0x5c573c)),_0x51c46b=_0x7cde16;}const _0x300dc9={'iban':_0x5c573c,'bankDetails':_0x51c46b,'transactionId':_0x390eb1['data'][_0x179a00(0x245)],'coinAddress':_0x390eb1[_0x179a00(0x25c)][_0x179a00(0x20a)],'qrCodeUrl':_0x390eb1[_0x179a00(0x25c)][_0x179a00(0x1f2)],'expiryTime':_0x390eb1[_0x179a00(0x25c)]['ExpiryTime'],'createdOn':_0x390eb1[_0x179a00(0x25c)][_0x179a00(0x24a)],'confirmedOn':_0x390eb1['data']['TransactionConfirmedOn']};console[_0x179a00(0x1fb)](_0x179a00(0x23f)),console['log'](_0x179a00(0x1fd),_0x390eb1['data'][_0x179a00(0x223)],'->',_0x25eb95),console[_0x179a00(0x1fb)](_0x179a00(0x208),_0x390eb1['data'][_0x179a00(0x217)],_0x390eb1[_0x179a00(0x25c)][_0x179a00(0x250)]),console[_0x179a00(0x1fb)](_0x179a00(0x21e),_0x390eb1['data'][_0x179a00(0x245)]),console[_0x179a00(0x1fb)](_0x179a00(0x1fa),_0x5c573c||_0x179a00(0x246)),console['log']('Created\x20On:',_0x390eb1[_0x179a00(0x25c)][_0x179a00(0x24a)]),console['log'](_0x179a00(0x249),_0x390eb1['data'][_0x179a00(0x1ef)]||_0x179a00(0x234));if(_0x390eb1['data'][_0x179a00(0x223)]?.[_0x179a00(0x213)]()===_0x179a00(0x1fc))console[_0x179a00(0x1fb)](_0x179a00(0x237));else _0x390eb1[_0x179a00(0x25c)][_0x179a00(0x223)]?.[_0x179a00(0x213)]()===_0x179a00(0x227)&&console[_0x179a00(0x1fb)](_0x179a00(0x1e5));return{'status':_0x25eb95,'amount':parseFloat(_0x390eb1['data'][_0x179a00(0x217)])||undefined,'currency':_0x390eb1[_0x179a00(0x25c)][_0x179a00(0x250)]||_0x179a00(0x1f4),'paymentDetails':_0x300dc9};}catch(_0x49c684){console[_0x179a00(0x260)](_0x179a00(0x21d),_0x49c684),loggerService_1[_0x179a00(0x220)][_0x179a00(0x23b)](_0x179a00(0x201),_0x179a00(0x21f),_0x49c684);throw new Error(_0x179a00(0x233)+(_0x49c684 instanceof Error?_0x49c684['message']:'Unknown\x20error'));}}async[a40_0x4d8007(0x24b)](_0xd103df){const _0x43a1a7=a40_0x4d8007,_0x45bd18=await this['checkPaymentStatus'](_0xd103df);return{'status':_0x45bd18['status'],'amount':_0x45bd18[_0x43a1a7(0x221)],'currency':_0x45bd18['currency']};}async[a40_0x4d8007(0x259)](_0x408f26){const _0x3213a2=a40_0x4d8007;console[_0x3213a2(0x1fb)]('Processing\x20CoinToPay\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x408f26);let _0x54fe35=_0x3213a2(0x1e7);switch(_0x408f26[_0x3213a2(0x212)]?.[_0x3213a2(0x213)]()){case _0x3213a2(0x227):_0x54fe35=_0x3213a2(0x238);break;case _0x3213a2(0x232):case _0x3213a2(0x1eb):case _0x3213a2(0x260):_0x54fe35=_0x3213a2(0x239);break;case _0x3213a2(0x24d):case _0x3213a2(0x243):_0x54fe35='EXPIRED';break;case _0x3213a2(0x1f6):case _0x3213a2(0x22f):case _0x3213a2(0x1fc):case'created':default:_0x54fe35=_0x3213a2(0x1e7);break;}return{'paymentId':_0x408f26['order_id']||_0x408f26[_0x3213a2(0x257)]||'','status':_0x54fe35,'amount':_0x408f26[_0x3213a2(0x221)],'currency':_0x408f26['currency']||_0x3213a2(0x1f4)};}}exports['CoinToPayService']=CoinToPayService;