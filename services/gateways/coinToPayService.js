'use strict';const a40_0x1066aa=a40_0x164c;(function(_0x50aa46,_0x23ad8f){const _0x3fdc3a=a40_0x164c,_0x2880e4=_0x50aa46();while(!![]){try{const _0x7d6d9a=parseInt(_0x3fdc3a(0x136))/0x1*(-parseInt(_0x3fdc3a(0xe6))/0x2)+parseInt(_0x3fdc3a(0x156))/0x3+parseInt(_0x3fdc3a(0xfb))/0x4*(parseInt(_0x3fdc3a(0x101))/0x5)+-parseInt(_0x3fdc3a(0xf4))/0x6+-parseInt(_0x3fdc3a(0x108))/0x7*(parseInt(_0x3fdc3a(0xed))/0x8)+-parseInt(_0x3fdc3a(0x159))/0x9*(parseInt(_0x3fdc3a(0x11c))/0xa)+-parseInt(_0x3fdc3a(0x166))/0xb*(-parseInt(_0x3fdc3a(0x126))/0xc);if(_0x7d6d9a===_0x23ad8f)break;else _0x2880e4['push'](_0x2880e4['shift']());}catch(_0x2d1620){_0x2880e4['push'](_0x2880e4['shift']());}}}(a40_0x1bdf,0xe6679));Object[a40_0x1066aa(0x148)](exports,a40_0x1066aa(0x11f),{'value':!![]}),exports[a40_0x1066aa(0x103)]=void 0x0;const loggerService_1=require('../loggerService');function a40_0x1bdf(){const _0x43084a=['logWhiteDomainError','Result:','Payment\x20URL:','===\x20COINTOPAY\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Unknown\x20error\x20from\x20CoinToPay\x20API','TransactionID','timeout','defineProperty','error','Unknown\x20error\x20from\x20CoinToPay\x20status\x20API','log','payment_url','inputCurrency','CoinToPay\x20status\x20API\x20error:\x20','Response\x20Body:','expired','===\x20COINTOPAY\x20SERVICE\x20ERROR\x20===','Gateway\x20Payment\x20ID:','PENDING','loggerService','statusText','4577760YNGTJn','Transaction\x20ID:','order_id','2632977qvkptB','Raw\x20Response\x20Body:','logWhiteDomainResponse','data','stringify','statusUrl','ü™ô\x20CoinToPay\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','CreatedOn','Status\x20Code:','TesSoft\x20Payment\x20System/1.0','Error\x20Message:','TransactionConfirmedOn','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','105347sbOvag','amount','waiting','===\x20COINTOPAY\x20SUCCESS\x20===','https://tesoft.uk/gateway/cointopay/','match','Confirmed\x20On:','\x20EUR','HTTP\x20error!\x20status:\x20','EUR\x20(always\x20EUR\x20for\x20CoinToPay)','7732kLuqGw','üè¶\x20Extracted\x20IBAN:','parse','Status:','Request\x20Body:','Status\x20Text:','cancelled','86920wexfSC','===\x20PARSED\x20COINTOPAY\x20STATUS\x20RESPONSE\x20===','headers','===\x20COINTOPAY\x20API\x20ERROR\x20===','cointopay','status','===\x20COINTOPAY\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','7768524ttojXI','toLowerCase','===\x20COINTOPAY\x20STATUS\x20CHECK\x20RESPONSE\x20===','üè¶\x20Payment\x20Detail:','not\x20confirmed','EUR','===\x20COINTOPAY\x20API\x20INCOMPLETE\x20RESPONSE\x20===','4wSJARU','pending','Incomplete\x20response:\x20missing\x20data','FAILED','URL:','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20Unknown\x20error','8600140sZDsxx','entries','CoinToPayService','HTTP\x20','logWhiteDomainRequest','Error\x20details:','checkPaymentStatus','833iOIstc','===\x20COINTOPAY\x20STATUS\x20API\x20ERROR\x20===','not\x20found','ExpiryTime','currency','ü™ô\x20Creating\x20CoinToPay\x20payment:\x20','Processing\x20CoinToPay\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','message','Failed\x20to\x20parse\x20JSON\x20response:','createPaymentLink','===\x20PARSED\x20COINTOPAY\x20RESPONSE\x20===','paid','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','Payment\x20Status:','Currency:','EXPIRED','Amount:','JSON\x20Parse\x20Error:\x20','status_code','PAID','10xmpSsr','gateway_payment_id','PaymentDetail','__esModule','Status\x20API\x20Error:\x20','Unknown\x20error','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20','application/json','üìä\x20Status\x20check\x20URL:','/status','2100DQrnpN','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','IBAN:','https://tesoft.uk/gateway/cointopay/status.php','apiUrl','created','Parsed\x20Result:',',\x20body:\x20','Amount','result','now','/create','Business\x20Error:\x20','Status','failed','===\x20COINTOPAY\x20API\x20BUSINESS\x20ERROR\x20===','284YpxKMB','fromEntries','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20status\x20API:\x20','awaiting\x20fiat','HTTP\x20Status:','Invalid\x20response\x20from\x20CoinToPay\x20status\x20API:\x20missing\x20data','Missing\x20data\x20in\x20response','CoinToPay\x20payment\x20status\x20check\x20error:','Invalid\x20response\x20from\x20CoinToPay\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','POST','text'];a40_0x1bdf=function(){return _0x43084a;};return a40_0x1bdf();}class CoinToPayService{constructor(){const _0x5a9e87=a40_0x1066aa;this[_0x5a9e87(0x12a)]=_0x5a9e87(0x16a),this[_0x5a9e87(0x15e)]=_0x5a9e87(0x129),console['log'](_0x5a9e87(0x15f)),console['log'](_0x5a9e87(0x124),this[_0x5a9e87(0x15e)]);}async[a40_0x1066aa(0x111)](_0x222072){const _0x413172=a40_0x1066aa,{orderId:_0x7c1b11,amount:_0x219e2b}=_0x222072;console[_0x413172(0x14b)](_0x413172(0x10d)+_0x219e2b+_0x413172(0xe3));const _0x358065={'amount':_0x219e2b},_0x1a7031=Date['now']();try{console[_0x413172(0x14b)]('===\x20COINTOPAY\x20API\x20REQUEST\x20(White\x20Domain)\x20==='),console[_0x413172(0x14b)](_0x413172(0xff),this[_0x413172(0x12a)]),console[_0x413172(0x14b)](_0x413172(0xea),JSON[_0x413172(0x15d)](_0x358065,null,0x2)),console[_0x413172(0x14b)](_0x413172(0x118),_0x219e2b,_0x413172(0xe5)),loggerService_1[_0x413172(0x154)][_0x413172(0x105)](_0x413172(0xf1),_0x413172(0x131),_0x413172(0x13f),_0x358065);const _0x5498a4=await fetch(this['apiUrl'],{'method':_0x413172(0x13f),'headers':{'Content-Type':_0x413172(0x123),'Accept':_0x413172(0x123),'User-Agent':_0x413172(0x162)},'body':JSON[_0x413172(0x15d)](_0x358065)}),_0x66b6f4=Date['now']()-_0x1a7031;console[_0x413172(0x14b)](_0x413172(0xf3)),console[_0x413172(0x14b)](_0x413172(0xe9),_0x5498a4[_0x413172(0xf2)]),console[_0x413172(0x14b)](_0x413172(0xeb),_0x5498a4[_0x413172(0x155)]),console[_0x413172(0x14b)]('Headers:',Object[_0x413172(0x137)](_0x5498a4[_0x413172(0xef)][_0x413172(0x102)]())),console[_0x413172(0x14b)]('Response\x20Time:',_0x66b6f4+'ms');const _0x2d8a8e=await _0x5498a4[_0x413172(0x140)]();console['log'](_0x413172(0x15a),_0x2d8a8e);if(!_0x5498a4['ok']){console[_0x413172(0x149)](_0x413172(0xf0)),console[_0x413172(0x149)](_0x413172(0x13a),_0x5498a4['status']),console[_0x413172(0x149)](_0x413172(0x14f),_0x2d8a8e),loggerService_1['loggerService'][_0x413172(0x15b)]('cointopay','/create',_0x5498a4[_0x413172(0xf2)],_0x2d8a8e,_0x66b6f4),loggerService_1['loggerService'][_0x413172(0x141)](_0x413172(0xf1),_0x413172(0x131),_0x413172(0x104)+_0x5498a4[_0x413172(0xf2)]+':\x20'+_0x2d8a8e);throw new Error(_0x413172(0xe4)+_0x5498a4[_0x413172(0xf2)]+_0x413172(0x12d)+_0x2d8a8e);}let _0x263d13;try{_0x263d13=JSON[_0x413172(0xe8)](_0x2d8a8e);}catch(_0x539e11){console[_0x413172(0x149)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x539e11),loggerService_1[_0x413172(0x154)][_0x413172(0x141)](_0x413172(0xf1),'/create',_0x413172(0x119)+_0x539e11);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20API:\x20'+_0x2d8a8e);}console[_0x413172(0x14b)](_0x413172(0x112)),console[_0x413172(0x14b)](_0x413172(0x12c),JSON[_0x413172(0x15d)](_0x263d13,null,0x2)),loggerService_1['loggerService'][_0x413172(0x15b)](_0x413172(0xf1),'/create',_0x5498a4[_0x413172(0xf2)],_0x263d13,_0x66b6f4);if(_0x263d13['error']){const _0x3e9dde=_0x263d13[_0x413172(0x10f)]||_0x263d13[_0x413172(0x149)]||_0x413172(0x145);console[_0x413172(0x149)](_0x413172(0x135)),console['error']('Error\x20Message:',_0x3e9dde),loggerService_1['loggerService']['logWhiteDomainError'](_0x413172(0xf1),'/create',_0x413172(0x132)+_0x3e9dde);throw new Error('CoinToPay\x20API\x20error:\x20'+_0x3e9dde);}if(!_0x263d13[_0x413172(0x14c)]||!_0x263d13[_0x413172(0x11d)]){console[_0x413172(0x149)](_0x413172(0xfa)),console['error'](_0x413172(0x114)),console[_0x413172(0x149)]('Response\x20data:',_0x263d13),loggerService_1[_0x413172(0x154)][_0x413172(0x141)]('cointopay',_0x413172(0x131),_0x413172(0x127));throw new Error(_0x413172(0x13e));}return console['log'](_0x413172(0x169)),console[_0x413172(0x14b)](_0x413172(0x152),_0x263d13[_0x413172(0x11d)]),console[_0x413172(0x14b)](_0x413172(0x143),_0x263d13[_0x413172(0x14c)]),console[_0x413172(0x14b)]('Amount:',_0x219e2b,_0x413172(0xf9)),{'gateway_payment_id':_0x263d13['gateway_payment_id'],'payment_url':_0x263d13[_0x413172(0x14c)]};}catch(_0x108328){console[_0x413172(0x149)](_0x413172(0x151)),console[_0x413172(0x149)](_0x413172(0x106),_0x108328),loggerService_1['loggerService'][_0x413172(0x141)](_0x413172(0xf1),_0x413172(0x131),_0x108328);if(_0x108328 instanceof Error){console[_0x413172(0x149)]('Error\x20message:',_0x108328[_0x413172(0x10f)]),console[_0x413172(0x149)]('Error\x20stack:',_0x108328['stack']);throw new Error(_0x413172(0x122)+_0x108328[_0x413172(0x10f)]);}throw new Error(_0x413172(0x100));}}async['checkPaymentStatus'](_0x18e238){const _0x3ddfde=a40_0x1066aa,_0x5020b3=Date[_0x3ddfde(0x130)]();try{console[_0x3ddfde(0x14b)]('üìä\x20Checking\x20CoinToPay\x20payment\x20status\x20for:\x20'+_0x18e238);const _0x1db8af={'gatewayPaymentId':_0x18e238};loggerService_1[_0x3ddfde(0x154)][_0x3ddfde(0x105)](_0x3ddfde(0xf1),_0x3ddfde(0x125),_0x3ddfde(0x13f),_0x1db8af);const _0x41fc21=await fetch(this[_0x3ddfde(0x15e)],{'method':_0x3ddfde(0x13f),'headers':{'Content-Type':_0x3ddfde(0x123),'Accept':_0x3ddfde(0x123),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x3ddfde(0x15d)](_0x1db8af)}),_0x54fc0c=Date['now']()-_0x5020b3;console[_0x3ddfde(0x14b)](_0x3ddfde(0xf6)),console[_0x3ddfde(0x14b)](_0x3ddfde(0xe9),_0x41fc21[_0x3ddfde(0xf2)]),console['log']('Response\x20Time:',_0x54fc0c+'ms');if(!_0x41fc21['ok']){const _0x3c7475=await _0x41fc21[_0x3ddfde(0x140)]();console[_0x3ddfde(0x149)]('HTTP\x20Status:',_0x41fc21[_0x3ddfde(0xf2)]),console[_0x3ddfde(0x149)]('Response\x20Body:',_0x3c7475),loggerService_1[_0x3ddfde(0x154)]['logWhiteDomainResponse'](_0x3ddfde(0xf1),_0x3ddfde(0x125),_0x41fc21[_0x3ddfde(0xf2)],_0x3c7475,_0x54fc0c),loggerService_1[_0x3ddfde(0x154)]['logWhiteDomainError']('cointopay',_0x3ddfde(0x125),'HTTP\x20'+_0x41fc21['status']+':\x20'+_0x3c7475);throw new Error(_0x3ddfde(0xe4)+_0x41fc21[_0x3ddfde(0xf2)]);}const _0x5080c2=await _0x41fc21[_0x3ddfde(0x140)]();console[_0x3ddfde(0x14b)]('Raw\x20Response\x20Body:',_0x5080c2);let _0x2083e0;try{_0x2083e0=JSON[_0x3ddfde(0xe8)](_0x5080c2);}catch(_0x564672){console[_0x3ddfde(0x149)](_0x3ddfde(0x110),_0x564672),loggerService_1[_0x3ddfde(0x154)][_0x3ddfde(0x141)](_0x3ddfde(0xf1),'/status',_0x3ddfde(0x119)+_0x564672);throw new Error(_0x3ddfde(0x138)+_0x5080c2);}loggerService_1[_0x3ddfde(0x154)][_0x3ddfde(0x15b)]('cointopay',_0x3ddfde(0x125),_0x41fc21['status'],_0x2083e0,_0x54fc0c),console[_0x3ddfde(0x14b)](_0x3ddfde(0xee)),console[_0x3ddfde(0x14b)](_0x3ddfde(0x142),_0x2083e0[_0x3ddfde(0x12f)]),console[_0x3ddfde(0x14b)](_0x3ddfde(0x161),_0x2083e0[_0x3ddfde(0x11a)]),console[_0x3ddfde(0x14b)](_0x3ddfde(0x115),_0x2083e0[_0x3ddfde(0x15c)]?.[_0x3ddfde(0x133)]),console[_0x3ddfde(0x14b)](_0x3ddfde(0x118),_0x2083e0['data']?.[_0x3ddfde(0x12e)]),console[_0x3ddfde(0x14b)](_0x3ddfde(0x116),_0x2083e0[_0x3ddfde(0x15c)]?.[_0x3ddfde(0x14d)]);if(_0x2083e0[_0x3ddfde(0x12f)]!=='success'||_0x2083e0['status_code']!==0xc8){const _0xe1a11b=_0x2083e0[_0x3ddfde(0x10f)]||_0x3ddfde(0x14a);console[_0x3ddfde(0x149)](_0x3ddfde(0x109)),console['error'](_0x3ddfde(0x163),_0xe1a11b),loggerService_1[_0x3ddfde(0x154)][_0x3ddfde(0x141)](_0x3ddfde(0xf1),_0x3ddfde(0x125),_0x3ddfde(0x120)+_0xe1a11b);throw new Error(_0x3ddfde(0x14e)+_0xe1a11b);}if(!_0x2083e0[_0x3ddfde(0x15c)]){console['error'](_0x3ddfde(0x144)),console[_0x3ddfde(0x149)](_0x3ddfde(0x13c)),loggerService_1[_0x3ddfde(0x154)]['logWhiteDomainError']('cointopay',_0x3ddfde(0x125),_0x3ddfde(0xfd));throw new Error(_0x3ddfde(0x13b));}let _0x24ec99=_0x3ddfde(0x153);switch(_0x2083e0[_0x3ddfde(0x15c)][_0x3ddfde(0x133)]?.[_0x3ddfde(0xf5)]()){case _0x3ddfde(0x113):_0x24ec99=_0x3ddfde(0x11b);break;case _0x3ddfde(0xec):case _0x3ddfde(0x134):case'error':_0x24ec99=_0x3ddfde(0xfe);break;case _0x3ddfde(0x150):case _0x3ddfde(0x147):_0x24ec99=_0x3ddfde(0x117);break;case _0x3ddfde(0x168):case _0x3ddfde(0x139):case _0x3ddfde(0xfc):case _0x3ddfde(0x12b):default:_0x24ec99='PENDING';break;}let _0xc367f2,_0x290c19;if(_0x2083e0[_0x3ddfde(0x15c)][_0x3ddfde(0x11e)]){const _0xbcad67=_0x2083e0[_0x3ddfde(0x15c)][_0x3ddfde(0x11e)];console['log'](_0x3ddfde(0xf7),_0xbcad67);const _0x5525b3=_0xbcad67[_0x3ddfde(0x16b)](/IBAN\s+([A-Z0-9]+)/i);_0x5525b3&&(_0xc367f2=_0x5525b3[0x1],console[_0x3ddfde(0x14b)](_0x3ddfde(0xe7),_0xc367f2)),_0x290c19=_0xbcad67;}const _0x2b23fa={'iban':_0xc367f2,'bankDetails':_0x290c19,'transactionId':_0x2083e0[_0x3ddfde(0x15c)][_0x3ddfde(0x146)],'coinAddress':_0x2083e0[_0x3ddfde(0x15c)]['coinAddress'],'qrCodeUrl':_0x2083e0[_0x3ddfde(0x15c)]['QRCodeURL'],'expiryTime':_0x2083e0['data'][_0x3ddfde(0x10b)],'createdOn':_0x2083e0[_0x3ddfde(0x15c)][_0x3ddfde(0x160)],'confirmedOn':_0x2083e0['data'][_0x3ddfde(0x164)]};console[_0x3ddfde(0x14b)]('===\x20COINTOPAY\x20STATUS\x20SUCCESS\x20==='),console['log'](_0x3ddfde(0xe9),_0x2083e0['data'][_0x3ddfde(0x133)],'->',_0x24ec99),console[_0x3ddfde(0x14b)](_0x3ddfde(0x118),_0x2083e0[_0x3ddfde(0x15c)]['Amount'],_0x2083e0[_0x3ddfde(0x15c)][_0x3ddfde(0x14d)]),console[_0x3ddfde(0x14b)](_0x3ddfde(0x157),_0x2083e0[_0x3ddfde(0x15c)][_0x3ddfde(0x146)]),console[_0x3ddfde(0x14b)](_0x3ddfde(0x128),_0xc367f2||_0x3ddfde(0x10a)),console[_0x3ddfde(0x14b)]('Created\x20On:',_0x2083e0['data']['CreatedOn']),console['log'](_0x3ddfde(0x16c),_0x2083e0['data']['TransactionConfirmedOn']||_0x3ddfde(0xf8));if(_0x2083e0[_0x3ddfde(0x15c)][_0x3ddfde(0x133)]?.[_0x3ddfde(0xf5)]()===_0x3ddfde(0x139))console[_0x3ddfde(0x14b)]('üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)');else _0x2083e0[_0x3ddfde(0x15c)][_0x3ddfde(0x133)]?.[_0x3ddfde(0xf5)]()===_0x3ddfde(0x113)&&console[_0x3ddfde(0x14b)](_0x3ddfde(0x165));return{'status':_0x24ec99,'amount':parseFloat(_0x2083e0[_0x3ddfde(0x15c)][_0x3ddfde(0x12e)])||undefined,'currency':_0x2083e0[_0x3ddfde(0x15c)][_0x3ddfde(0x14d)]||'EUR','paymentDetails':_0x2b23fa};}catch(_0x5cd632){console[_0x3ddfde(0x149)](_0x3ddfde(0x13d),_0x5cd632),loggerService_1[_0x3ddfde(0x154)]['logWhiteDomainError'](_0x3ddfde(0xf1),_0x3ddfde(0x125),_0x5cd632);throw new Error('Failed\x20to\x20check\x20CoinToPay\x20payment\x20status:\x20'+(_0x5cd632 instanceof Error?_0x5cd632[_0x3ddfde(0x10f)]:_0x3ddfde(0x121)));}}async['verifyPayment'](_0x421ed2){const _0x1bcb55=a40_0x1066aa,_0x3300f7=await this[_0x1bcb55(0x107)](_0x421ed2);return{'status':_0x3300f7['status'],'amount':_0x3300f7[_0x1bcb55(0x167)],'currency':_0x3300f7[_0x1bcb55(0x10c)]};}async['processWebhook'](_0x126ba7){const _0x516d9d=a40_0x1066aa;console[_0x516d9d(0x14b)](_0x516d9d(0x10e),_0x126ba7);let _0xac5519=_0x516d9d(0x153);switch(_0x126ba7[_0x516d9d(0xf2)]?.[_0x516d9d(0xf5)]()){case _0x516d9d(0x113):_0xac5519=_0x516d9d(0x11b);break;case _0x516d9d(0xec):case _0x516d9d(0x134):case _0x516d9d(0x149):_0xac5519=_0x516d9d(0xfe);break;case _0x516d9d(0x150):case _0x516d9d(0x147):_0xac5519=_0x516d9d(0x117);break;case'pending':case _0x516d9d(0x168):case'awaiting\x20fiat':case _0x516d9d(0x12b):default:_0xac5519=_0x516d9d(0x153);break;}return{'paymentId':_0x126ba7[_0x516d9d(0x158)]||_0x126ba7['merchant_reference_id']||'','status':_0xac5519,'amount':_0x126ba7['amount'],'currency':_0x126ba7[_0x516d9d(0x10c)]||_0x516d9d(0xf9)};}}function a40_0x164c(_0x3abaf3,_0x571eb9){const _0x1bdf4c=a40_0x1bdf();return a40_0x164c=function(_0x164c6f,_0xec4dae){_0x164c6f=_0x164c6f-0xe3;let _0x9dfc3f=_0x1bdf4c[_0x164c6f];return _0x9dfc3f;},a40_0x164c(_0x3abaf3,_0x571eb9);}exports[a40_0x1066aa(0x103)]=CoinToPayService;