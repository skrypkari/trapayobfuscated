'use strict';const a40_0x3e0dc0=a40_0x37c9;(function(_0x326b61,_0x501f2d){const _0x2d5418=a40_0x37c9,_0x5e70a9=_0x326b61();while(!![]){try{const _0x318ead=-parseInt(_0x2d5418(0x1e6))/0x1*(parseInt(_0x2d5418(0x1ef))/0x2)+-parseInt(_0x2d5418(0x1a9))/0x3+parseInt(_0x2d5418(0x1f8))/0x4+-parseInt(_0x2d5418(0x1c5))/0x5+-parseInt(_0x2d5418(0x1dd))/0x6+parseInt(_0x2d5418(0x1c9))/0x7*(-parseInt(_0x2d5418(0x1ec))/0x8)+parseInt(_0x2d5418(0x1a7))/0x9*(parseInt(_0x2d5418(0x1cd))/0xa);if(_0x318ead===_0x501f2d)break;else _0x5e70a9['push'](_0x5e70a9['shift']());}catch(_0xf22998){_0x5e70a9['push'](_0x5e70a9['shift']());}}}(a40_0x2277,0x27bf6));Object[a40_0x3e0dc0(0x1b0)](exports,a40_0x3e0dc0(0x1c2),{'value':!![]}),exports['CoinToPayService']=void 0x0;const loggerService_1=require('../loggerService');function a40_0x2277(){const _0x1b64c0=['Status\x20Code:','Amount','not\x20found','Processing\x20CoinToPay\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','Invalid\x20response\x20from\x20CoinToPay\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','statusUrl','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','status_code','cancelled','result','not\x20confirmed','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20status\x20API:\x20','Gateway\x20Payment\x20ID:','\x20EUR','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','Unknown\x20error\x20from\x20CoinToPay\x20API','status','inputCurrency','Amount:','8119827ULTrXP','üìä\x20Checking\x20CoinToPay\x20payment\x20status\x20for:\x20','666528AklQqn','Status','/create','===\x20PARSED\x20COINTOPAY\x20STATUS\x20RESPONSE\x20===','CreatedOn','===\x20COINTOPAY\x20STATUS\x20API\x20ERROR\x20===','failed','defineProperty','EUR\x20(always\x20EUR\x20for\x20CoinToPay)','Failed\x20to\x20parse\x20JSON\x20response:','HTTP\x20','error','logWhiteDomainResponse','Error\x20details:','application/json','Unknown\x20error\x20from\x20CoinToPay\x20status\x20API','message','ExpiryTime','apiUrl','Invalid\x20response\x20from\x20CoinToPay\x20status\x20API:\x20missing\x20data','stringify','===\x20COINTOPAY\x20STATUS\x20CHECK\x20RESPONSE\x20===','log','created','Response\x20Body:','__esModule','Result:','/status','1264470LTWHct','Error\x20message:','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20API:\x20','logWhiteDomainRequest','7ODXsxi','CoinToPayService','EUR','QRCodeURL','10HavxvR','cointopay','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20','Status:','timeout','===\x20COINTOPAY\x20API\x20INCOMPLETE\x20RESPONSE\x20===','EXPIRED','paid','toLowerCase','text','createPaymentLink','===\x20COINTOPAY\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Status\x20API\x20Error:\x20','Response\x20data:','Response\x20Time:','Payment\x20Status:','229608BCAiST',',\x20body:\x20','Error\x20stack:','awaiting\x20fiat','TransactionID','===\x20COINTOPAY\x20API\x20RESPONSE\x20(White\x20Domain)\x20===','Missing\x20data\x20in\x20response','üè¶\x20Extracted\x20IBAN:','parse','3NlPHEn','===\x20COINTOPAY\x20API\x20REQUEST\x20(White\x20Domain)\x20===','POST','now','===\x20COINTOPAY\x20SUCCESS\x20===','gateway_payment_id','1584256zCmbms','payment_url','HTTP\x20Status:','213132GGmpep','TesSoft\x20Payment\x20System/1.0','üìä\x20Status\x20check\x20URL:','expired','Payment\x20URL:','Unknown\x20error','pending','Created\x20On:','IBAN:','1166684SsKOTH','Raw\x20Response\x20Body:','JSON\x20Parse\x20Error:\x20','match','URL:','amount','https://tesoft.uk/gateway/cointopay/','PENDING','https://tesoft.uk/gateway/cointopay/status.php','===\x20COINTOPAY\x20API\x20ERROR\x20===','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20Unknown\x20error','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Failed\x20to\x20check\x20CoinToPay\x20payment\x20status:\x20','loggerService','===\x20COINTOPAY\x20STATUS\x20SUCCESS\x20===','data','ü™ô\x20CoinToPay\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','CoinToPay\x20payment\x20status\x20check\x20error:','HTTP\x20error!\x20status:\x20','CoinToPay\x20status\x20API\x20error:\x20','logWhiteDomainError','Request\x20Body:','===\x20COINTOPAY\x20SERVICE\x20ERROR\x20===','FAILED','CoinToPay\x20API\x20error:\x20'];a40_0x2277=function(){return _0x1b64c0;};return a40_0x2277();}class CoinToPayService{constructor(){const _0x34751b=a40_0x3e0dc0;this[_0x34751b(0x1bb)]=_0x34751b(0x1fe),this[_0x34751b(0x217)]=_0x34751b(0x200),console[_0x34751b(0x1bf)](_0x34751b(0x208)),console[_0x34751b(0x1bf)](_0x34751b(0x1f1),this[_0x34751b(0x217)]);}async[a40_0x3e0dc0(0x1d7)](_0x160df1){const _0x1a2d24=a40_0x3e0dc0,{orderId:_0x32872b,amount:_0x3b852a}=_0x160df1;console[_0x1a2d24(0x1bf)]('ü™ô\x20Creating\x20CoinToPay\x20payment:\x20'+_0x3b852a+_0x1a2d24(0x1a1));const _0x21aeac={'amount':_0x3b852a},_0xee6078=Date['now']();try{console[_0x1a2d24(0x1bf)](_0x1a2d24(0x1e7)),console[_0x1a2d24(0x1bf)](_0x1a2d24(0x1fc),this[_0x1a2d24(0x1bb)]),console[_0x1a2d24(0x1bf)](_0x1a2d24(0x20d),JSON['stringify'](_0x21aeac,null,0x2)),console[_0x1a2d24(0x1bf)](_0x1a2d24(0x1a6),_0x3b852a,_0x1a2d24(0x1b1)),loggerService_1[_0x1a2d24(0x205)][_0x1a2d24(0x1c8)](_0x1a2d24(0x1ce),_0x1a2d24(0x1ab),_0x1a2d24(0x1e8),_0x21aeac);const _0x2d3b75=await fetch(this[_0x1a2d24(0x1bb)],{'method':_0x1a2d24(0x1e8),'headers':{'Content-Type':'application/json','Accept':_0x1a2d24(0x1b7),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x1a2d24(0x1bd)](_0x21aeac)}),_0x197e59=Date[_0x1a2d24(0x1e9)]()-_0xee6078;console[_0x1a2d24(0x1bf)](_0x1a2d24(0x1e2)),console[_0x1a2d24(0x1bf)](_0x1a2d24(0x1d0),_0x2d3b75[_0x1a2d24(0x1a4)]),console[_0x1a2d24(0x1bf)]('Status\x20Text:',_0x2d3b75['statusText']),console[_0x1a2d24(0x1bf)]('Headers:',Object['fromEntries'](_0x2d3b75['headers']['entries']())),console[_0x1a2d24(0x1bf)]('Response\x20Time:',_0x197e59+'ms');const _0x4bad27=await _0x2d3b75[_0x1a2d24(0x1d6)]();console['log'](_0x1a2d24(0x1f9),_0x4bad27);if(!_0x2d3b75['ok']){console[_0x1a2d24(0x1b4)](_0x1a2d24(0x201)),console['error'](_0x1a2d24(0x1ee),_0x2d3b75[_0x1a2d24(0x1a4)]),console['error'](_0x1a2d24(0x1c1),_0x4bad27),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x1a2d24(0x1ce),'/create',_0x2d3b75[_0x1a2d24(0x1a4)],_0x4bad27,_0x197e59),loggerService_1[_0x1a2d24(0x205)][_0x1a2d24(0x20c)](_0x1a2d24(0x1ce),_0x1a2d24(0x1ab),_0x1a2d24(0x1b3)+_0x2d3b75['status']+':\x20'+_0x4bad27);throw new Error('HTTP\x20error!\x20status:\x20'+_0x2d3b75[_0x1a2d24(0x1a4)]+_0x1a2d24(0x1de)+_0x4bad27);}let _0x31fb31;try{_0x31fb31=JSON[_0x1a2d24(0x1e5)](_0x4bad27);}catch(_0x234ed6){console['error'](_0x1a2d24(0x1b2),_0x234ed6),loggerService_1[_0x1a2d24(0x205)][_0x1a2d24(0x20c)]('cointopay',_0x1a2d24(0x1ab),_0x1a2d24(0x1fa)+_0x234ed6);throw new Error(_0x1a2d24(0x1c7)+_0x4bad27);}console[_0x1a2d24(0x1bf)]('===\x20PARSED\x20COINTOPAY\x20RESPONSE\x20==='),console[_0x1a2d24(0x1bf)]('Parsed\x20Result:',JSON[_0x1a2d24(0x1bd)](_0x31fb31,null,0x2)),loggerService_1['loggerService'][_0x1a2d24(0x1b5)]('cointopay',_0x1a2d24(0x1ab),_0x2d3b75['status'],_0x31fb31,_0x197e59);if(_0x31fb31[_0x1a2d24(0x1b4)]){const _0x522899=_0x31fb31['message']||_0x31fb31[_0x1a2d24(0x1b4)]||_0x1a2d24(0x1a3);console[_0x1a2d24(0x1b4)]('===\x20COINTOPAY\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x1a2d24(0x1b4)]('Error\x20Message:',_0x522899),loggerService_1[_0x1a2d24(0x205)][_0x1a2d24(0x20c)](_0x1a2d24(0x1ce),_0x1a2d24(0x1ab),'Business\x20Error:\x20'+_0x522899);throw new Error(_0x1a2d24(0x210)+_0x522899);}if(!_0x31fb31[_0x1a2d24(0x1ed)]||!_0x31fb31[_0x1a2d24(0x1eb)]){console['error'](_0x1a2d24(0x1d2)),console[_0x1a2d24(0x1b4)](_0x1a2d24(0x1a2)),console[_0x1a2d24(0x1b4)](_0x1a2d24(0x1da),_0x31fb31),loggerService_1['loggerService'][_0x1a2d24(0x20c)](_0x1a2d24(0x1ce),'/create',_0x1a2d24(0x216));throw new Error(_0x1a2d24(0x215));}return console['log'](_0x1a2d24(0x1ea)),console[_0x1a2d24(0x1bf)](_0x1a2d24(0x1a0),_0x31fb31['gateway_payment_id']),console[_0x1a2d24(0x1bf)](_0x1a2d24(0x1f3),_0x31fb31[_0x1a2d24(0x1ed)]),console[_0x1a2d24(0x1bf)](_0x1a2d24(0x1a6),_0x3b852a,_0x1a2d24(0x1cb)),{'gateway_payment_id':_0x31fb31[_0x1a2d24(0x1eb)],'payment_url':_0x31fb31[_0x1a2d24(0x1ed)]};}catch(_0x1135f2){console[_0x1a2d24(0x1b4)](_0x1a2d24(0x20e)),console[_0x1a2d24(0x1b4)](_0x1a2d24(0x1b6),_0x1135f2),loggerService_1[_0x1a2d24(0x205)][_0x1a2d24(0x20c)]('cointopay','/create',_0x1135f2);if(_0x1135f2 instanceof Error){console[_0x1a2d24(0x1b4)](_0x1a2d24(0x1c6),_0x1135f2['message']),console[_0x1a2d24(0x1b4)](_0x1a2d24(0x1df),_0x1135f2['stack']);throw new Error(_0x1a2d24(0x1cf)+_0x1135f2['message']);}throw new Error(_0x1a2d24(0x202));}}async['checkPaymentStatus'](_0xe38180){const _0x385715=a40_0x3e0dc0,_0x104a70=Date[_0x385715(0x1e9)]();try{console[_0x385715(0x1bf)](_0x385715(0x1a8)+_0xe38180);const _0x18ab4e={'gatewayPaymentId':_0xe38180};loggerService_1[_0x385715(0x205)][_0x385715(0x1c8)](_0x385715(0x1ce),_0x385715(0x1c4),_0x385715(0x1e8),_0x18ab4e);const _0x122d93=await fetch(this['statusUrl'],{'method':_0x385715(0x1e8),'headers':{'Content-Type':_0x385715(0x1b7),'Accept':_0x385715(0x1b7),'User-Agent':_0x385715(0x1f0)},'body':JSON[_0x385715(0x1bd)](_0x18ab4e)}),_0x5667f5=Date['now']()-_0x104a70;console[_0x385715(0x1bf)](_0x385715(0x1be)),console[_0x385715(0x1bf)]('Status:',_0x122d93[_0x385715(0x1a4)]),console[_0x385715(0x1bf)](_0x385715(0x1db),_0x5667f5+'ms');if(!_0x122d93['ok']){const _0x224641=await _0x122d93['text']();console['error'](_0x385715(0x1ee),_0x122d93['status']),console[_0x385715(0x1b4)](_0x385715(0x1c1),_0x224641),loggerService_1[_0x385715(0x205)][_0x385715(0x1b5)](_0x385715(0x1ce),_0x385715(0x1c4),_0x122d93['status'],_0x224641,_0x5667f5),loggerService_1[_0x385715(0x205)]['logWhiteDomainError'](_0x385715(0x1ce),_0x385715(0x1c4),_0x385715(0x1b3)+_0x122d93['status']+':\x20'+_0x224641);throw new Error(_0x385715(0x20a)+_0x122d93[_0x385715(0x1a4)]);}const _0x19229a=await _0x122d93['text']();console['log'](_0x385715(0x1f9),_0x19229a);let _0x3fa2c8;try{_0x3fa2c8=JSON[_0x385715(0x1e5)](_0x19229a);}catch(_0xa3a1c1){console[_0x385715(0x1b4)](_0x385715(0x1b2),_0xa3a1c1),loggerService_1[_0x385715(0x205)][_0x385715(0x20c)](_0x385715(0x1ce),'/status','JSON\x20Parse\x20Error:\x20'+_0xa3a1c1);throw new Error(_0x385715(0x19f)+_0x19229a);}loggerService_1['loggerService'][_0x385715(0x1b5)](_0x385715(0x1ce),_0x385715(0x1c4),_0x122d93[_0x385715(0x1a4)],_0x3fa2c8,_0x5667f5),console[_0x385715(0x1bf)](_0x385715(0x1ac)),console[_0x385715(0x1bf)](_0x385715(0x1c3),_0x3fa2c8['result']),console[_0x385715(0x1bf)](_0x385715(0x211),_0x3fa2c8[_0x385715(0x219)]),console[_0x385715(0x1bf)](_0x385715(0x1dc),_0x3fa2c8[_0x385715(0x207)]?.[_0x385715(0x1aa)]),console[_0x385715(0x1bf)](_0x385715(0x1a6),_0x3fa2c8[_0x385715(0x207)]?.[_0x385715(0x212)]),console['log']('Currency:',_0x3fa2c8[_0x385715(0x207)]?.[_0x385715(0x1a5)]);if(_0x3fa2c8[_0x385715(0x19d)]!=='success'||_0x3fa2c8['status_code']!==0xc8){const _0x2341b7=_0x3fa2c8['message']||_0x385715(0x1b8);console[_0x385715(0x1b4)](_0x385715(0x1ae)),console[_0x385715(0x1b4)]('Error\x20Message:',_0x2341b7),loggerService_1[_0x385715(0x205)]['logWhiteDomainError'](_0x385715(0x1ce),'/status',_0x385715(0x1d9)+_0x2341b7);throw new Error(_0x385715(0x20b)+_0x2341b7);}if(!_0x3fa2c8[_0x385715(0x207)]){console[_0x385715(0x1b4)](_0x385715(0x1d8)),console[_0x385715(0x1b4)](_0x385715(0x1e3)),loggerService_1['loggerService'][_0x385715(0x20c)](_0x385715(0x1ce),_0x385715(0x1c4),'Incomplete\x20response:\x20missing\x20data');throw new Error(_0x385715(0x1bc));}let _0x342ae4=_0x385715(0x1ff);switch(_0x3fa2c8['data']['Status']?.['toLowerCase']()){case _0x385715(0x1d4):_0x342ae4='PAID';break;case _0x385715(0x19c):case _0x385715(0x1af):case _0x385715(0x1b4):_0x342ae4=_0x385715(0x20f);break;case _0x385715(0x1f2):case _0x385715(0x1d1):_0x342ae4=_0x385715(0x1d3);break;case'waiting':case _0x385715(0x1e0):case _0x385715(0x1f5):case _0x385715(0x1c0):default:_0x342ae4=_0x385715(0x1ff);break;}let _0x677fae,_0x150d9d;if(_0x3fa2c8[_0x385715(0x207)]['PaymentDetail']){const _0x48e1e1=_0x3fa2c8['data']['PaymentDetail'];console[_0x385715(0x1bf)]('üè¶\x20Payment\x20Detail:',_0x48e1e1);const _0x7e929a=_0x48e1e1[_0x385715(0x1fb)](/IBAN\s+([A-Z0-9]+)/i);_0x7e929a&&(_0x677fae=_0x7e929a[0x1],console[_0x385715(0x1bf)](_0x385715(0x1e4),_0x677fae)),_0x150d9d=_0x48e1e1;}const _0x409721={'iban':_0x677fae,'bankDetails':_0x150d9d,'transactionId':_0x3fa2c8[_0x385715(0x207)]['TransactionID'],'coinAddress':_0x3fa2c8[_0x385715(0x207)]['coinAddress'],'qrCodeUrl':_0x3fa2c8[_0x385715(0x207)][_0x385715(0x1cc)],'expiryTime':_0x3fa2c8[_0x385715(0x207)][_0x385715(0x1ba)],'createdOn':_0x3fa2c8[_0x385715(0x207)][_0x385715(0x1ad)],'confirmedOn':_0x3fa2c8[_0x385715(0x207)]['TransactionConfirmedOn']};console[_0x385715(0x1bf)](_0x385715(0x206)),console[_0x385715(0x1bf)](_0x385715(0x1d0),_0x3fa2c8['data']['Status'],'->',_0x342ae4),console['log'](_0x385715(0x1a6),_0x3fa2c8[_0x385715(0x207)][_0x385715(0x212)],_0x3fa2c8[_0x385715(0x207)]['inputCurrency']),console[_0x385715(0x1bf)]('Transaction\x20ID:',_0x3fa2c8[_0x385715(0x207)][_0x385715(0x1e1)]),console[_0x385715(0x1bf)](_0x385715(0x1f7),_0x677fae||_0x385715(0x213)),console[_0x385715(0x1bf)](_0x385715(0x1f6),_0x3fa2c8[_0x385715(0x207)][_0x385715(0x1ad)]),console[_0x385715(0x1bf)]('Confirmed\x20On:',_0x3fa2c8[_0x385715(0x207)]['TransactionConfirmedOn']||_0x385715(0x19e));if(_0x3fa2c8[_0x385715(0x207)][_0x385715(0x1aa)]?.[_0x385715(0x1d5)]()===_0x385715(0x1e0))console['log'](_0x385715(0x203));else _0x3fa2c8['data'][_0x385715(0x1aa)]?.[_0x385715(0x1d5)]()===_0x385715(0x1d4)&&console[_0x385715(0x1bf)](_0x385715(0x218));return{'status':_0x342ae4,'amount':parseFloat(_0x3fa2c8['data'][_0x385715(0x212)])||undefined,'currency':_0x3fa2c8['data']['inputCurrency']||'EUR','paymentDetails':_0x409721};}catch(_0xd7c277){console[_0x385715(0x1b4)](_0x385715(0x209),_0xd7c277),loggerService_1[_0x385715(0x205)]['logWhiteDomainError'](_0x385715(0x1ce),_0x385715(0x1c4),_0xd7c277);throw new Error(_0x385715(0x204)+(_0xd7c277 instanceof Error?_0xd7c277[_0x385715(0x1b9)]:_0x385715(0x1f4)));}}async['verifyPayment'](_0x244013){const _0x9fd598=a40_0x3e0dc0,_0x47f613=await this['checkPaymentStatus'](_0x244013);return{'status':_0x47f613[_0x9fd598(0x1a4)],'amount':_0x47f613['amount'],'currency':_0x47f613['currency']};}async['processWebhook'](_0x19afc6){const _0x124750=a40_0x3e0dc0;console['log'](_0x124750(0x214),_0x19afc6);let _0x5abf84=_0x124750(0x1ff);switch(_0x19afc6[_0x124750(0x1a4)]?.['toLowerCase']()){case _0x124750(0x1d4):_0x5abf84='PAID';break;case'cancelled':case _0x124750(0x1af):case _0x124750(0x1b4):_0x5abf84='FAILED';break;case'expired':case _0x124750(0x1d1):_0x5abf84=_0x124750(0x1d3);break;case'pending':case'waiting':case'awaiting\x20fiat':case _0x124750(0x1c0):default:_0x5abf84='PENDING';break;}return{'paymentId':_0x19afc6['order_id']||_0x19afc6['merchant_reference_id']||'','status':_0x5abf84,'amount':_0x19afc6[_0x124750(0x1fd)],'currency':_0x19afc6['currency']||_0x124750(0x1cb)};}}function a40_0x37c9(_0x535db8,_0x11973d){const _0x2277ed=a40_0x2277();return a40_0x37c9=function(_0x37c95f,_0x6c18c1){_0x37c95f=_0x37c95f-0x19c;let _0x56ec8e=_0x2277ed[_0x37c95f];return _0x56ec8e;},a40_0x37c9(_0x535db8,_0x11973d);}exports[a40_0x3e0dc0(0x1ca)]=CoinToPayService;