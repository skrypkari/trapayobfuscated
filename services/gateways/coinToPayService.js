'use strict';function a46_0x793b(){const _0x2cbd5b=['application/json','CreatedOn','8766WMWMVf','now','===\x20COINTOPAY\x20API\x20INCOMPLETE\x20RESPONSE\x20===','/create','not\x20found','inputCurrency','===\x20PARSED\x20COINTOPAY\x20RESPONSE\x20===','/status','21zVYuQx','merchant_reference_id','Unknown\x20error\x20from\x20CoinToPay\x20API','not\x20confirmed','HTTP\x20Status:','stack','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20status\x20API:\x20','logWhiteDomainError','üìä\x20Checking\x20CoinToPay\x20payment\x20status\x20for:\x20','message','Failed\x20to\x20parse\x20JSON\x20response:','Incomplete\x20response:\x20missing\x20data','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','üìä\x20Status\x20check\x20URL:','createPaymentLink','URL:','Amount:','amount','===\x20COINTOPAY\x20STATUS\x20API\x20ERROR\x20===','awaiting\x20fiat','Response\x20data:','ExpiryTime','Payment\x20URL:','===\x20COINTOPAY\x20STATUS\x20SUCCESS\x20===','HTTP\x20error!\x20status:\x20','PAID','expired','failed','Currency:','Processing\x20CoinToPay\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','Parsed\x20Result:','üè¶\x20Payment\x20Detail:','JSON\x20Parse\x20Error:\x20','created','timeout','Headers:','log','Invalid\x20JSON\x20response\x20from\x20CoinToPay\x20API:\x20','gateway_payment_id','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20','checkPaymentStatus','Status','===\x20COINTOPAY\x20API\x20ERROR\x20===','headers','EXPIRED','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','35830rTjqSI','EUR','Response\x20Body:','entries','text','CoinToPay\x20API\x20error:\x20','coinAddress','HTTP\x20','5607152IPFTdz','toLowerCase','PENDING','130476XHSRHn','Request\x20Body:','pending','QRCodeURL','CoinToPayService','order_id','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','===\x20PARSED\x20COINTOPAY\x20STATUS\x20RESPONSE\x20===','7mdkRdn','payment_url','Business\x20Error:\x20','Failed\x20to\x20create\x20CoinToPay\x20payment\x20link:\x20Unknown\x20error','cointopay','Gateway\x20Payment\x20ID:','error','===\x20COINTOPAY\x20API\x20BUSINESS\x20ERROR\x20===','https://tesoft.uk/gateway/cointopay/','Raw\x20Response\x20Body:','üè¶\x20Extracted\x20IBAN:','4500618RPFuee','Failed\x20to\x20check\x20CoinToPay\x20payment\x20status:\x20','Response\x20Time:','TesSoft\x20Payment\x20System/1.0','Status\x20API\x20Error:\x20','Created\x20On:','TransactionID','Status:','Amount','===\x20COINTOPAY\x20STATUS\x20CHECK\x20RESPONSE\x20===','\x20EUR','waiting','defineProperty','TransactionConfirmedOn','result','Error\x20stack:','Missing\x20data\x20in\x20response','Transaction\x20ID:','status_code','currency','4296896vHfHrq','Status\x20Code:','parse','267458UrwVhP','fromEntries','Error\x20Message:','status','loggerService','Confirmed\x20On:','ü™ô\x20CoinToPay\x20service\x20initialized\x20with\x20white\x20domain\x20proxy','__esModule','Invalid\x20response\x20from\x20CoinToPay\x20status\x20API:\x20missing\x20data','POST','stringify','logWhiteDomainResponse','CoinToPay\x20status\x20API\x20error:\x20','cancelled','apiUrl','Unknown\x20error','5573925DhfPYW','Status\x20Text:','FAILED','logWhiteDomainRequest','CoinToPay\x20payment\x20status\x20check\x20error:','data','ü™ô\x20Creating\x20CoinToPay\x20payment:\x20'];a46_0x793b=function(){return _0x2cbd5b;};return a46_0x793b();}const a46_0x3708a5=a46_0x1626;(function(_0x471689,_0x4da1fa){const _0x299087=a46_0x1626,_0x4290b3=_0x471689();while(!![]){try{const _0x58c521=parseInt(_0x299087(0x210))/0x1+-parseInt(_0x299087(0x23a))/0x2*(-parseInt(_0x299087(0x1d7))/0x3)+-parseInt(_0x299087(0x20d))/0x4+-parseInt(_0x299087(0x24a))/0x5+-parseInt(_0x299087(0x223))/0x6*(parseInt(_0x299087(0x218))/0x7)+-parseInt(_0x299087(0x237))/0x8+parseInt(_0x299087(0x1cf))/0x9*(parseInt(_0x299087(0x205))/0xa);if(_0x58c521===_0x4da1fa)break;else _0x4290b3['push'](_0x4290b3['shift']());}catch(_0x3349be){_0x4290b3['push'](_0x4290b3['shift']());}}}(a46_0x793b,0xb7bf9));function a46_0x1626(_0x20703b,_0x4dbd00){const _0x793bd0=a46_0x793b();return a46_0x1626=function(_0x1626c8,_0x1a78ac){_0x1626c8=_0x1626c8-0x1cc;let _0x53e54b=_0x793bd0[_0x1626c8];return _0x53e54b;},a46_0x1626(_0x20703b,_0x4dbd00);}Object[a46_0x3708a5(0x22f)](exports,a46_0x3708a5(0x241),{'value':!![]}),exports[a46_0x3708a5(0x214)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPayService{constructor(){const _0x1d947d=a46_0x3708a5;this['apiUrl']=_0x1d947d(0x220),this['statusUrl']='https://tesoft.uk/gateway/cointopay/status.php',console[_0x1d947d(0x1fb)](_0x1d947d(0x240)),console[_0x1d947d(0x1fb)](_0x1d947d(0x1e4),this['statusUrl']);}async[a46_0x3708a5(0x1e5)](_0x44737b){const _0x32119e=a46_0x3708a5,{orderId:_0x1bb4f7,amount:_0x1bb8ef}=_0x44737b;console[_0x32119e(0x1fb)](_0x32119e(0x1cc)+_0x1bb8ef+_0x32119e(0x22d));const _0x25979e={'amount':_0x1bb8ef},_0x2b9d2f=Date[_0x32119e(0x1d0)]();try{console['log']('===\x20COINTOPAY\x20API\x20REQUEST\x20(White\x20Domain)\x20==='),console['log'](_0x32119e(0x1e6),this[_0x32119e(0x248)]),console[_0x32119e(0x1fb)](_0x32119e(0x211),JSON[_0x32119e(0x244)](_0x25979e,null,0x2)),console[_0x32119e(0x1fb)](_0x32119e(0x1e7),_0x1bb8ef,'EUR\x20(always\x20EUR\x20for\x20CoinToPay)'),loggerService_1[_0x32119e(0x23e)][_0x32119e(0x24d)]('cointopay','/create',_0x32119e(0x243),_0x25979e);const _0x131522=await fetch(this[_0x32119e(0x248)],{'method':_0x32119e(0x243),'headers':{'Content-Type':_0x32119e(0x1cd),'Accept':_0x32119e(0x1cd),'User-Agent':_0x32119e(0x226)},'body':JSON[_0x32119e(0x244)](_0x25979e)}),_0x19bf7c=Date['now']()-_0x2b9d2f;console[_0x32119e(0x1fb)]('===\x20COINTOPAY\x20API\x20RESPONSE\x20(White\x20Domain)\x20==='),console[_0x32119e(0x1fb)](_0x32119e(0x22a),_0x131522[_0x32119e(0x23d)]),console[_0x32119e(0x1fb)](_0x32119e(0x24b),_0x131522['statusText']),console[_0x32119e(0x1fb)](_0x32119e(0x1fa),Object[_0x32119e(0x23b)](_0x131522[_0x32119e(0x202)][_0x32119e(0x208)]())),console[_0x32119e(0x1fb)](_0x32119e(0x225),_0x19bf7c+'ms');const _0x4ed7a4=await _0x131522[_0x32119e(0x209)]();console[_0x32119e(0x1fb)](_0x32119e(0x221),_0x4ed7a4);if(!_0x131522['ok']){console['error'](_0x32119e(0x201)),console[_0x32119e(0x21e)](_0x32119e(0x1db),_0x131522[_0x32119e(0x23d)]),console[_0x32119e(0x21e)](_0x32119e(0x207),_0x4ed7a4),loggerService_1[_0x32119e(0x23e)][_0x32119e(0x245)](_0x32119e(0x21c),_0x32119e(0x1d2),_0x131522[_0x32119e(0x23d)],_0x4ed7a4,_0x19bf7c),loggerService_1[_0x32119e(0x23e)][_0x32119e(0x1de)](_0x32119e(0x21c),_0x32119e(0x1d2),_0x32119e(0x20c)+_0x131522['status']+':\x20'+_0x4ed7a4);throw new Error(_0x32119e(0x1ef)+_0x131522[_0x32119e(0x23d)]+',\x20body:\x20'+_0x4ed7a4);}let _0x564529;try{_0x564529=JSON['parse'](_0x4ed7a4);}catch(_0x55963b){console[_0x32119e(0x21e)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x55963b),loggerService_1[_0x32119e(0x23e)]['logWhiteDomainError'](_0x32119e(0x21c),_0x32119e(0x1d2),_0x32119e(0x1f7)+_0x55963b);throw new Error(_0x32119e(0x1fc)+_0x4ed7a4);}console[_0x32119e(0x1fb)](_0x32119e(0x1d5)),console[_0x32119e(0x1fb)](_0x32119e(0x1f5),JSON[_0x32119e(0x244)](_0x564529,null,0x2)),loggerService_1[_0x32119e(0x23e)]['logWhiteDomainResponse'](_0x32119e(0x21c),'/create',_0x131522[_0x32119e(0x23d)],_0x564529,_0x19bf7c);if(_0x564529[_0x32119e(0x21e)]){const _0x55c3f7=_0x564529[_0x32119e(0x1e0)]||_0x564529['error']||_0x32119e(0x1d9);console[_0x32119e(0x21e)](_0x32119e(0x21f)),console['error']('Error\x20Message:',_0x55c3f7),loggerService_1[_0x32119e(0x23e)]['logWhiteDomainError'](_0x32119e(0x21c),_0x32119e(0x1d2),_0x32119e(0x21a)+_0x55c3f7);throw new Error(_0x32119e(0x20a)+_0x55c3f7);}if(!_0x564529[_0x32119e(0x219)]||!_0x564529[_0x32119e(0x1fd)]){console[_0x32119e(0x21e)](_0x32119e(0x1d1)),console[_0x32119e(0x21e)](_0x32119e(0x216)),console['error'](_0x32119e(0x1eb),_0x564529),loggerService_1['loggerService'][_0x32119e(0x1de)](_0x32119e(0x21c),_0x32119e(0x1d2),'Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error('Invalid\x20response\x20from\x20CoinToPay\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id');}return console[_0x32119e(0x1fb)]('===\x20COINTOPAY\x20SUCCESS\x20==='),console[_0x32119e(0x1fb)](_0x32119e(0x21d),_0x564529[_0x32119e(0x1fd)]),console[_0x32119e(0x1fb)](_0x32119e(0x1ed),_0x564529[_0x32119e(0x219)]),console[_0x32119e(0x1fb)](_0x32119e(0x1e7),_0x1bb8ef,_0x32119e(0x206)),{'gateway_payment_id':_0x564529[_0x32119e(0x1fd)],'payment_url':_0x564529[_0x32119e(0x219)]};}catch(_0xf66def){console[_0x32119e(0x21e)]('===\x20COINTOPAY\x20SERVICE\x20ERROR\x20==='),console[_0x32119e(0x21e)]('Error\x20details:',_0xf66def),loggerService_1[_0x32119e(0x23e)]['logWhiteDomainError'](_0x32119e(0x21c),_0x32119e(0x1d2),_0xf66def);if(_0xf66def instanceof Error){console[_0x32119e(0x21e)]('Error\x20message:',_0xf66def[_0x32119e(0x1e0)]),console['error'](_0x32119e(0x232),_0xf66def[_0x32119e(0x1dc)]);throw new Error(_0x32119e(0x1fe)+_0xf66def['message']);}throw new Error(_0x32119e(0x21b));}}async[a46_0x3708a5(0x1ff)](_0x20b612){const _0x15b7b3=a46_0x3708a5,_0x246c8a=Date[_0x15b7b3(0x1d0)]();try{console[_0x15b7b3(0x1fb)](_0x15b7b3(0x1df)+_0x20b612);const _0x4a340f={'gatewayPaymentId':_0x20b612};loggerService_1[_0x15b7b3(0x23e)][_0x15b7b3(0x24d)]('cointopay',_0x15b7b3(0x1d6),_0x15b7b3(0x243),_0x4a340f);const _0x239a37=await fetch(this['statusUrl'],{'method':_0x15b7b3(0x243),'headers':{'Content-Type':'application/json','Accept':'application/json','User-Agent':_0x15b7b3(0x226)},'body':JSON[_0x15b7b3(0x244)](_0x4a340f)}),_0x20ea6c=Date[_0x15b7b3(0x1d0)]()-_0x246c8a;console[_0x15b7b3(0x1fb)](_0x15b7b3(0x22c)),console['log'](_0x15b7b3(0x22a),_0x239a37[_0x15b7b3(0x23d)]),console[_0x15b7b3(0x1fb)](_0x15b7b3(0x225),_0x20ea6c+'ms');if(!_0x239a37['ok']){const _0x16e77d=await _0x239a37[_0x15b7b3(0x209)]();console['error'](_0x15b7b3(0x1db),_0x239a37['status']),console[_0x15b7b3(0x21e)](_0x15b7b3(0x207),_0x16e77d),loggerService_1[_0x15b7b3(0x23e)][_0x15b7b3(0x245)]('cointopay','/status',_0x239a37[_0x15b7b3(0x23d)],_0x16e77d,_0x20ea6c),loggerService_1[_0x15b7b3(0x23e)][_0x15b7b3(0x1de)](_0x15b7b3(0x21c),_0x15b7b3(0x1d6),'HTTP\x20'+_0x239a37[_0x15b7b3(0x23d)]+':\x20'+_0x16e77d);throw new Error(_0x15b7b3(0x1ef)+_0x239a37['status']);}const _0x3ac5d3=await _0x239a37[_0x15b7b3(0x209)]();console[_0x15b7b3(0x1fb)](_0x15b7b3(0x221),_0x3ac5d3);let _0x4722f3;try{_0x4722f3=JSON[_0x15b7b3(0x239)](_0x3ac5d3);}catch(_0x139e0d){console[_0x15b7b3(0x21e)](_0x15b7b3(0x1e1),_0x139e0d),loggerService_1[_0x15b7b3(0x23e)]['logWhiteDomainError'](_0x15b7b3(0x21c),'/status',_0x15b7b3(0x1f7)+_0x139e0d);throw new Error(_0x15b7b3(0x1dd)+_0x3ac5d3);}loggerService_1[_0x15b7b3(0x23e)][_0x15b7b3(0x245)]('cointopay',_0x15b7b3(0x1d6),_0x239a37[_0x15b7b3(0x23d)],_0x4722f3,_0x20ea6c),console[_0x15b7b3(0x1fb)](_0x15b7b3(0x217)),console['log']('Result:',_0x4722f3[_0x15b7b3(0x231)]),console[_0x15b7b3(0x1fb)](_0x15b7b3(0x238),_0x4722f3['status_code']),console[_0x15b7b3(0x1fb)]('Payment\x20Status:',_0x4722f3['data']?.[_0x15b7b3(0x200)]),console[_0x15b7b3(0x1fb)](_0x15b7b3(0x1e7),_0x4722f3['data']?.[_0x15b7b3(0x22b)]),console[_0x15b7b3(0x1fb)](_0x15b7b3(0x1f3),_0x4722f3[_0x15b7b3(0x24f)]?.[_0x15b7b3(0x1d4)]);if(_0x4722f3[_0x15b7b3(0x231)]!=='success'||_0x4722f3[_0x15b7b3(0x235)]!==0xc8){const _0x25a6b4=_0x4722f3['message']||'Unknown\x20error\x20from\x20CoinToPay\x20status\x20API';console[_0x15b7b3(0x21e)](_0x15b7b3(0x1e9)),console[_0x15b7b3(0x21e)](_0x15b7b3(0x23c),_0x25a6b4),loggerService_1[_0x15b7b3(0x23e)]['logWhiteDomainError']('cointopay',_0x15b7b3(0x1d6),_0x15b7b3(0x227)+_0x25a6b4);throw new Error(_0x15b7b3(0x246)+_0x25a6b4);}if(!_0x4722f3[_0x15b7b3(0x24f)]){console[_0x15b7b3(0x21e)]('===\x20COINTOPAY\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x15b7b3(0x21e)](_0x15b7b3(0x233)),loggerService_1['loggerService'][_0x15b7b3(0x1de)](_0x15b7b3(0x21c),_0x15b7b3(0x1d6),_0x15b7b3(0x1e2));throw new Error(_0x15b7b3(0x242));}let _0x27c6ab=_0x15b7b3(0x20f);switch(_0x4722f3[_0x15b7b3(0x24f)]['Status']?.[_0x15b7b3(0x20e)]()){case'paid':_0x27c6ab=_0x15b7b3(0x1f0);break;case'cancelled':case _0x15b7b3(0x1f2):case _0x15b7b3(0x21e):_0x27c6ab=_0x15b7b3(0x24c);break;case _0x15b7b3(0x1f1):case'timeout':_0x27c6ab=_0x15b7b3(0x203);break;case _0x15b7b3(0x22e):case _0x15b7b3(0x1ea):case _0x15b7b3(0x212):case _0x15b7b3(0x1f8):default:_0x27c6ab='PENDING';break;}let _0x361e3f,_0x5244a7;if(_0x4722f3['data']['PaymentDetail']){const _0x5dec40=_0x4722f3[_0x15b7b3(0x24f)]['PaymentDetail'];console[_0x15b7b3(0x1fb)](_0x15b7b3(0x1f6),_0x5dec40);const _0x275d86=_0x5dec40['match'](/IBAN\s+([A-Z0-9]+)/i);_0x275d86&&(_0x361e3f=_0x275d86[0x1],console['log'](_0x15b7b3(0x222),_0x361e3f)),_0x5244a7=_0x5dec40;}const _0x2d4883={'iban':_0x361e3f,'bankDetails':_0x5244a7,'transactionId':_0x4722f3[_0x15b7b3(0x24f)][_0x15b7b3(0x229)],'coinAddress':_0x4722f3[_0x15b7b3(0x24f)][_0x15b7b3(0x20b)],'qrCodeUrl':_0x4722f3[_0x15b7b3(0x24f)][_0x15b7b3(0x213)],'expiryTime':_0x4722f3[_0x15b7b3(0x24f)][_0x15b7b3(0x1ec)],'createdOn':_0x4722f3['data'][_0x15b7b3(0x1ce)],'confirmedOn':_0x4722f3[_0x15b7b3(0x24f)][_0x15b7b3(0x230)]};console[_0x15b7b3(0x1fb)](_0x15b7b3(0x1ee)),console[_0x15b7b3(0x1fb)]('Status:',_0x4722f3['data'][_0x15b7b3(0x200)],'->',_0x27c6ab),console['log'](_0x15b7b3(0x1e7),_0x4722f3[_0x15b7b3(0x24f)][_0x15b7b3(0x22b)],_0x4722f3['data']['inputCurrency']),console[_0x15b7b3(0x1fb)](_0x15b7b3(0x234),_0x4722f3[_0x15b7b3(0x24f)][_0x15b7b3(0x229)]),console[_0x15b7b3(0x1fb)]('IBAN:',_0x361e3f||_0x15b7b3(0x1d3)),console[_0x15b7b3(0x1fb)](_0x15b7b3(0x228),_0x4722f3[_0x15b7b3(0x24f)][_0x15b7b3(0x1ce)]),console['log'](_0x15b7b3(0x23f),_0x4722f3[_0x15b7b3(0x24f)][_0x15b7b3(0x230)]||_0x15b7b3(0x1da));if(_0x4722f3['data'][_0x15b7b3(0x200)]?.[_0x15b7b3(0x20e)]()===_0x15b7b3(0x1ea))console['log'](_0x15b7b3(0x204));else _0x4722f3[_0x15b7b3(0x24f)][_0x15b7b3(0x200)]?.[_0x15b7b3(0x20e)]()==='paid'&&console[_0x15b7b3(0x1fb)](_0x15b7b3(0x1e3));return{'status':_0x27c6ab,'amount':parseFloat(_0x4722f3[_0x15b7b3(0x24f)]['Amount'])||undefined,'currency':_0x4722f3[_0x15b7b3(0x24f)]['inputCurrency']||_0x15b7b3(0x206),'paymentDetails':_0x2d4883};}catch(_0x3e59bf){console['error'](_0x15b7b3(0x24e),_0x3e59bf),loggerService_1[_0x15b7b3(0x23e)][_0x15b7b3(0x1de)](_0x15b7b3(0x21c),'/status',_0x3e59bf);throw new Error(_0x15b7b3(0x224)+(_0x3e59bf instanceof Error?_0x3e59bf['message']:_0x15b7b3(0x249)));}}async['verifyPayment'](_0x4cdf91){const _0x3065a8=a46_0x3708a5,_0x1e3058=await this['checkPaymentStatus'](_0x4cdf91);return{'status':_0x1e3058[_0x3065a8(0x23d)],'amount':_0x1e3058[_0x3065a8(0x1e8)],'currency':_0x1e3058[_0x3065a8(0x236)]};}async['processWebhook'](_0x5934cf){const _0x5849bf=a46_0x3708a5;console[_0x5849bf(0x1fb)](_0x5849bf(0x1f4),_0x5934cf);let _0x4e481e=_0x5849bf(0x20f);switch(_0x5934cf['status']?.[_0x5849bf(0x20e)]()){case'paid':_0x4e481e=_0x5849bf(0x1f0);break;case _0x5849bf(0x247):case'failed':case _0x5849bf(0x21e):_0x4e481e=_0x5849bf(0x24c);break;case _0x5849bf(0x1f1):case _0x5849bf(0x1f9):_0x4e481e=_0x5849bf(0x203);break;case _0x5849bf(0x212):case _0x5849bf(0x22e):case _0x5849bf(0x1ea):case _0x5849bf(0x1f8):default:_0x4e481e=_0x5849bf(0x20f);break;}return{'paymentId':_0x5934cf[_0x5849bf(0x215)]||_0x5934cf[_0x5849bf(0x1d8)]||'','status':_0x4e481e,'amount':_0x5934cf[_0x5849bf(0x1e8)],'currency':_0x5934cf[_0x5849bf(0x236)]||_0x5849bf(0x206)};}}exports[a46_0x3708a5(0x214)]=CoinToPayService;