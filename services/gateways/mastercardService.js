'use strict';function a42_0x1f7e(){const _0x2e662c=['⏰\x20Will\x20check\x20status\x20','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','ms)','randomBytes','join','✅\x20Payment\x20successful','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','🔐\x20Private\x20key\x20path:','cwd','),\x20stopping\x20status\x20checks','PENDING','sendShopWebhook','10noLtDv','mastercard','✅\x20Status\x20response\x20decrypted\x20successfully','replace','expire_month','push','🔐\x20Private\x20key\x20length:\x20','📝\x20Data\x20to\x20sign\x20length:','Error\x20parsing\x20webhook\x20events:','toUpperCase','HTTP\x20error!\x20status:\x20','privateKeyPath','\x20characters','/status_decrypted','webhookUrl','❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):','end','\x20\x20\x20-\x20method:\x20charge','prototype','crypto','POST','status','Card\x20Holder:','statusCheckTimers','defineProperty','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','base64','🔐\x20AES\x20IV\x20length:','decryptAES','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','../telegramBotService','MasterCard\x20status\x20check\x20error:','stringify','cvv','expire_year','resolve','/status_decrypt','order_id','createDecipheriv','-----END','charge','loggerService','logWhiteDomainRequest','includes','then','...','MasterCard:\x20','__importDefault','none','MasterCardService','Unknown\x20error','payment.success','existsSync','payment','create','hasOwnProperty','🔐\x20Data\x20signed\x20with\x20RSA','call','📝\x20Encrypted\x20data\x20length:','json','Private\x20key\x20file\x20not\x20found:\x20','publicKeyPath','number','decryptResponse','-----BEGIN','parse','\x20\x20\x20-\x20key\x20length:','🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA','❌\x20Failed\x20to\x20decrypt\x20status\x20response:','1609140rGxXoo','stopAllStatusChecks','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','🔐\x20RSA\x20signing\x20successful','sendPaymentNotification','writable','failed','sendPaymentNotifications','apiUrl','Failed\x20to\x20send\x20MasterCard\x20webhook:','Order\x20ID:','clearStatusTimers','\x20status\x20updated\x20to\x20','floor','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','readFileSync','Payment\x20ID:','encryptRSA','substring','size','Public\x20key\x20file\x20not\x20found:\x20','Status\x20decryption\x20failed:\x20','date_success','logWhiteDomainError','Processing\x20MasterCard\x20webhook:','Card\x20Number:','PHP\x20decryptor\x20error','/charge','📝\x20Signature\x20length:','aes-256-ctr','🧹\x20Clearing\x20','FAILED','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','\x20result:','🔐\x20Public\x20key\x20path:','56jCQVmz','❌\x20Status\x20check\x20#','encryptAES','\x20not\x20enabled\x20for\x20shop\x20','now','set','getOwnPropertyNames','../../config/database','📊\x20Status\x20check\x20result:','\x20is\x20final\x20(','configurable','5090484PXJpjd','/status','logShopWebhookSent','createSign','3ds_url','shop','❌\x20MasterCard\x20key\x20validation\x20failed:','https://api2.trapay.uk/decrypt.php','Decryption\x20failed:\x20','length','/charge_raw','Status:','🔐\x20AES\x20key\x20and\x20IV\x20generated','/charge_decrypted','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','Response\x20Time:','default','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','❌\x20PHP\x20decryptor\x20request\x20failed:','keys','isArray','29514DOpJay','key','sign','from','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','updatePaymentStatus','✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)','merchantPointId','../loggerService','\x20with\x20status\x20','7065423MkYrrK','desc','__setModuleDefault','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','processWebhook','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','https://api.paydmeth.com/api','validateKeyFiles','71LfrLuJ','paidAt','currency','customerEmail','7608675ziwEkK','forEach','696096kbcwEw','info','decryptResponsePhp','🔍\x20MasterCard\x20status\x20check\x20#','path','description','SHA256','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','final','PAID',',\x20body:\x20','constants',',\x20Desc:\x20','Error\x20details:','****\x20****\x20****\x20','logWhiteDomainResponse','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','update','Return\x20URL:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20status\x20checks\x20for\x20payment\x20','__esModule','first_name','MasterCard\x20webhook\x20sent\x20to\x20','amount','__importStar','customerName','orderId','Final:','last_name','\x20\x20\x20-\x20merchant_point_id:','❌\x20Data\x20being\x20signed:','error','📝\x20Data\x20length:','private.pem','1111','get','gatewayOrderId','/charge_decrypt','text','\x20\x20\x20-\x20sign\x20length:','🔐\x20AES\x20key\x20length:','signRSA','checkPaymentStatus','slice','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','trim','Response\x20Body:','payment_id','TesSoft\x20Payment\x20System/1.0','Result\x20URL:','message','generateAESKey','📝\x20Encrypted\x20key\x20length:','processCardPayment','💾\x20Payment\x20data\x20prepared','Amount:','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','✅\x20Payment\x20','HTTP\x20','❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20',',\x20Final:\x20','\x20failed\x20for\x20payment\x20','\x20MasterCard\x20status\x20check\x20timers','HTTP\x20Status:','toString','Webhook\x20event\x20','webhookEvents','❌\x20RSA\x20encryption\x20failed:','toLowerCase','🔐\x20Public\x20key\x20length:\x20','🛑\x20Stopped\x20','utf8','⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20','===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20===','\x20for\x20payment\x20','🔐\x20Data\x20encrypted\x20with\x20AES','shopId','settings','5135480YNuzSF','paid','log','application/json','findUnique','RSA_PKCS1_PADDING'];a42_0x1f7e=function(){return _0x2e662c;};return a42_0x1f7e();}const a42_0x451600=a42_0x5b95;(function(_0x3beffc,_0x46d8c8){const _0x3b1c4c=a42_0x5b95,_0x692c00=_0x3beffc();while(!![]){try{const _0x621f0=-parseInt(_0x3b1c4c(0x88))/0x1*(-parseInt(_0x3b1c4c(0x76))/0x2)+parseInt(_0x3b1c4c(0x135))/0x3+-parseInt(_0x3b1c4c(0x163))/0x4+parseInt(_0x3b1c4c(0x8c))/0x5+parseInt(_0x3b1c4c(0x8e))/0x6*(-parseInt(_0x3b1c4c(0x158))/0x7)+parseInt(_0x3b1c4c(0xdd))/0x8+parseInt(_0x3b1c4c(0x80))/0x9*(-parseInt(_0x3b1c4c(0xef))/0xa);if(_0x621f0===_0x46d8c8)break;else _0x692c00['push'](_0x692c00['shift']());}catch(_0x635be0){_0x692c00['push'](_0x692c00['shift']());}}}(a42_0x1f7e,0xba091));var __createBinding=this&&this['__createBinding']||(Object[a42_0x451600(0x126)]?function(_0x5543a7,_0x477cde,_0x568366,_0x460462){const _0x28d847=a42_0x451600;if(_0x460462===undefined)_0x460462=_0x568366;var _0x98cbde=Object['getOwnPropertyDescriptor'](_0x477cde,_0x568366);(!_0x98cbde||(_0x28d847(0xb2)in _0x98cbde?!_0x477cde['__esModule']:_0x98cbde[_0x28d847(0x13a)]||_0x98cbde[_0x28d847(0x162)]))&&(_0x98cbde={'enumerable':!![],'get':function(){return _0x477cde[_0x568366];}}),Object[_0x28d847(0x107)](_0x5543a7,_0x460462,_0x98cbde);}:function(_0x465962,_0x38a946,_0x460430,_0x5ecf8e){if(_0x5ecf8e===undefined)_0x5ecf8e=_0x460430;_0x465962[_0x5ecf8e]=_0x38a946[_0x460430];}),__setModuleDefault=this&&this[a42_0x451600(0x82)]||(Object[a42_0x451600(0x126)]?function(_0x4ecdc0,_0x250e7a){const _0x554d84=a42_0x451600;Object['defineProperty'](_0x4ecdc0,_0x554d84(0x71),{'enumerable':!![],'value':_0x250e7a});}:function(_0x34e91f,_0xaa51be){const _0x50481b=a42_0x451600;_0x34e91f[_0x50481b(0x71)]=_0xaa51be;}),__importStar=this&&this[a42_0x451600(0xa7)]||(function(){var _0x12ad80=function(_0x349c1f){const _0x3f72cd=a42_0x5b95;return _0x12ad80=Object[_0x3f72cd(0x15e)]||function(_0x9c800c){const _0x4607d3=_0x3f72cd;var _0x7aa1fd=[];for(var _0x363435 in _0x9c800c)if(Object[_0x4607d3(0x101)][_0x4607d3(0x127)][_0x4607d3(0x129)](_0x9c800c,_0x363435))_0x7aa1fd[_0x7aa1fd['length']]=_0x363435;return _0x7aa1fd;},_0x12ad80(_0x349c1f);};return function(_0x22a65f){const _0x474500=a42_0x5b95;if(_0x22a65f&&_0x22a65f['__esModule'])return _0x22a65f;var _0x2f77c3={};if(_0x22a65f!=null){for(var _0x3d9247=_0x12ad80(_0x22a65f),_0x173eac=0x0;_0x173eac<_0x3d9247[_0x474500(0x6a)];_0x173eac++)if(_0x3d9247[_0x173eac]!==_0x474500(0x71))__createBinding(_0x2f77c3,_0x22a65f,_0x3d9247[_0x173eac]);}return __setModuleDefault(_0x2f77c3,_0x22a65f),_0x2f77c3;};}()),__importDefault=this&&this[a42_0x451600(0x11f)]||function(_0x232dd3){const _0x412b0f=a42_0x451600;return _0x232dd3&&_0x232dd3[_0x412b0f(0xa3)]?_0x232dd3:{'default':_0x232dd3};};Object[a42_0x451600(0x107)](exports,a42_0x451600(0xa3),{'value':!![]}),exports[a42_0x451600(0x121)]=void 0x0;function a42_0x5b95(_0x5f088d,_0x14af77){const _0x1f7eb5=a42_0x1f7e();return a42_0x5b95=function(_0x5b95a5,_0x4e4df9){_0x5b95a5=_0x5b95a5-0x68;let _0x57f984=_0x1f7eb5[_0x5b95a5];return _0x57f984;},a42_0x5b95(_0x5f088d,_0x14af77);}const crypto_1=__importDefault(require(a42_0x451600(0x102))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0x451600(0x92))),loggerService_1=require(a42_0x451600(0x7e));class MasterCardService{constructor(){const _0xe5ff63=a42_0x451600;this[_0xe5ff63(0x106)]=new Map(),this[_0xe5ff63(0x13d)]=_0xe5ff63(0x86),this[_0xe5ff63(0x7d)]=0x67c,this[_0xe5ff63(0xfa)]=path_1[_0xe5ff63(0x71)][_0xe5ff63(0xe7)](process['cwd'](),_0xe5ff63(0x74),_0xe5ff63(0xb0)),this['publicKeyPath']=path_1[_0xe5ff63(0x71)][_0xe5ff63(0xe7)](process[_0xe5ff63(0xeb)](),_0xe5ff63(0x74),'psp_public.pem'),console[_0xe5ff63(0xdf)]('💳\x20MasterCard\x20service\x20initialized'),console[_0xe5ff63(0xdf)](_0xe5ff63(0xea),this[_0xe5ff63(0xfa)]),console[_0xe5ff63(0xdf)](_0xe5ff63(0x157),this[_0xe5ff63(0x12d)]),this['validateKeyFiles']();}[a42_0x451600(0x87)](){const _0x278748=a42_0x451600;try{if(!fs_1[_0x278748(0x71)][_0x278748(0x124)](this[_0x278748(0xfa)]))throw new Error(_0x278748(0x12c)+this[_0x278748(0xfa)]);if(!fs_1[_0x278748(0x71)][_0x278748(0x124)](this[_0x278748(0x12d)]))throw new Error(_0x278748(0x149)+this[_0x278748(0x12d)]);const _0x7caaaa=fs_1[_0x278748(0x71)]['readFileSync'](this['privateKeyPath'],_0x278748(0xd6))['trim'](),_0x26a610=fs_1[_0x278748(0x71)][_0x278748(0x144)](this[_0x278748(0x12d)],_0x278748(0xd6))[_0x278748(0xbc)]();if(!_0x7caaaa['includes'](_0x278748(0x130))||!_0x7caaaa[_0x278748(0x11b)](_0x278748(0x117)))throw new Error(_0x278748(0x143));if(!_0x26a610['includes']('-----BEGIN')||!_0x26a610['includes']('-----END'))throw new Error(_0x278748(0x6f));console[_0x278748(0xdf)]('✅\x20MasterCard\x20key\x20files\x20validated\x20successfully'),console[_0x278748(0xdf)](_0x278748(0xf5)+_0x7caaaa[_0x278748(0x6a)]+'\x20characters'),console[_0x278748(0xdf)](_0x278748(0xd4)+_0x26a610[_0x278748(0x6a)]+_0x278748(0xfb));}catch(_0xdbc3a0){console[_0x278748(0xae)](_0x278748(0x169),_0xdbc3a0);throw _0xdbc3a0;}}[a42_0x451600(0xc2)](){const _0x30eda9=a42_0x451600,_0x124ea1=crypto_1[_0x30eda9(0x71)][_0x30eda9(0xe6)](0x20),_0x48f396=crypto_1[_0x30eda9(0x71)][_0x30eda9(0xe6)](0x10);return{'key':_0x124ea1,'iv':_0x48f396};}[a42_0x451600(0x15a)](_0x53cd2b,_0x38548f,_0x558282){const _0x91970c=a42_0x451600,_0xdeeb85=crypto_1[_0x91970c(0x71)]['createCipheriv'](_0x91970c(0x152),_0x38548f,_0x558282);let _0x43aed0=_0xdeeb85[_0x91970c(0x9f)](_0x53cd2b,_0x91970c(0xd6),_0x91970c(0x10a));return _0x43aed0+=_0xdeeb85[_0x91970c(0x96)]('base64'),_0x43aed0;}[a42_0x451600(0x146)](_0x235cb1,_0x31775c){const _0x2a6b68=a42_0x451600;try{const _0x381aab=fs_1[_0x2a6b68(0x71)][_0x2a6b68(0x144)](this[_0x2a6b68(0x12d)],_0x2a6b68(0xd6))[_0x2a6b68(0xbc)](),_0x2ddb33={'iv':_0x31775c[_0x2a6b68(0xcf)]('base64'),'key':_0x235cb1[_0x2a6b68(0xcf)](_0x2a6b68(0x10a))},_0x238ff5=JSON[_0x2a6b68(0x110)](_0x2ddb33);console['log'](_0x2a6b68(0xc7),_0x238ff5['length']);const _0x336bdf=crypto_1[_0x2a6b68(0x71)]['publicEncrypt']({'key':_0x381aab,'padding':crypto_1['default'][_0x2a6b68(0x99)][_0x2a6b68(0xe2)]},Buffer['from'](_0x238ff5));return console[_0x2a6b68(0xdf)](_0x2a6b68(0xbb),_0x336bdf['length']),_0x336bdf[_0x2a6b68(0xcf)](_0x2a6b68(0x10a));}catch(_0x4ee576){console[_0x2a6b68(0xae)](_0x2a6b68(0xd2),_0x4ee576);throw new Error(_0x2a6b68(0x85));}}[a42_0x451600(0xb8)](_0x4f386d){const _0xfb075=a42_0x451600;try{const _0x140465=fs_1[_0xfb075(0x71)]['readFileSync'](this['privateKeyPath'],'utf8')[_0xfb075(0xbc)](),_0x52439f=crypto_1[_0xfb075(0x71)][_0xfb075(0x166)](_0xfb075(0x94));_0x52439f[_0xfb075(0x9f)](_0x4f386d),_0x52439f[_0xfb075(0xff)]();const _0x5a80fa=_0x52439f[_0xfb075(0x78)](_0x140465,_0xfb075(0x10a));return console['log'](_0xfb075(0x138)),console['log'](_0xfb075(0xf6),_0x4f386d[_0xfb075(0x6a)]),console[_0xfb075(0xdf)](_0xfb075(0x151),_0x5a80fa[_0xfb075(0x6a)]),_0x5a80fa;}catch(_0x58e695){console[_0xfb075(0xae)]('❌\x20RSA\x20signing\x20failed:',_0x58e695),console[_0xfb075(0xae)](_0xfb075(0xad),_0x4f386d[_0xfb075(0x147)](0x0,0xc8)+_0xfb075(0x11d));throw new Error(_0xfb075(0x109));}}[a42_0x451600(0x10c)](_0x5e93f7,_0x5c3736,_0x538158){const _0x4a2437=a42_0x451600,_0x48da61=crypto_1[_0x4a2437(0x71)][_0x4a2437(0x116)](_0x4a2437(0x152),_0x5c3736,_0x538158);let _0x5b1224=_0x48da61[_0x4a2437(0x9f)](_0x5e93f7,_0x4a2437(0x10a),_0x4a2437(0xd6));return _0x5b1224+=_0x48da61[_0x4a2437(0x96)](_0x4a2437(0xd6)),_0x5b1224;}async['decryptResponsePhp'](_0x212f00,_0x1c961a){const _0x1d5c91=a42_0x451600;try{const _0x1186ab=await fetch(_0x1d5c91(0x68),{'method':_0x1d5c91(0x103),'headers':{'Content-Type':'application/json'},'body':JSON['stringify']({'info':_0x212f00,'key':_0x1c961a})});if(!_0x1186ab['ok'])throw new Error(_0x1d5c91(0x14f));return await _0x1186ab[_0x1d5c91(0xb5)]();}catch(_0x2f4702){console['error'](_0x1d5c91(0x73),_0x2f4702);throw new Error('Failed\x20to\x20decrypt\x20response\x20via\x20PHP');}}[a42_0x451600(0x12f)](_0x323767,_0x1ccade){const _0x94f7bc=a42_0x451600;try{const _0x1cac67=fs_1[_0x94f7bc(0x71)][_0x94f7bc(0x144)](this[_0x94f7bc(0xfa)],'utf8')[_0x94f7bc(0xbc)](),_0x25d6a8=crypto_1[_0x94f7bc(0x71)]['privateDecrypt'](_0x1cac67,Buffer['from'](_0x1ccade,_0x94f7bc(0x10a))),_0x471172=JSON[_0x94f7bc(0x131)](_0x25d6a8[_0x94f7bc(0xcf)]()),_0x1c9a10=Buffer[_0x94f7bc(0x79)](_0x471172[_0x94f7bc(0x77)],_0x94f7bc(0x10a)),_0x15a2a6=Buffer[_0x94f7bc(0x79)](_0x471172['iv'],_0x94f7bc(0x10a));return this[_0x94f7bc(0x10c)](_0x323767,_0x1c9a10,_0x15a2a6);}catch(_0xe9d4e2){throw new Error('Failed\x20to\x20decrypt\x20response');}}async[a42_0x451600(0xc4)](_0xe3fb97){const _0x5ba463=a42_0x451600,{paymentId:_0x2f861f,orderId:_0x19c587,amount:_0x329845,currency:_0x58845c,cardData:_0x173445,resultUrl:_0xeb56c6,returnUrl:_0x39893b,cardHolder:_0x25383d,browser:_0x41cc50}=_0xe3fb97;console['log'](_0x5ba463(0xd8)),console[_0x5ba463(0xdf)](_0x5ba463(0x145),_0x2f861f),console[_0x5ba463(0xdf)](_0x5ba463(0x13f),_0x19c587),console[_0x5ba463(0xdf)](_0x5ba463(0xc6),_0x329845,_0x58845c),console['log'](_0x5ba463(0x14e),this['maskCardNumber'](_0x173445[_0x5ba463(0x12e)])),console[_0x5ba463(0xdf)](_0x5ba463(0x105),_0x25383d[_0x5ba463(0xa4)]+'\x20'+_0x25383d[_0x5ba463(0xab)]),console[_0x5ba463(0xdf)](_0x5ba463(0xa0),_0x39893b),console[_0x5ba463(0xdf)](_0x5ba463(0xc0),_0xeb56c6);const _0xca1660={'amount':_0x329845,'currency':_0x58845c[_0x5ba463(0xf8)](),'order_id':_0x19c587,'result_url':_0xeb56c6,'return_url':_0x39893b,'card':{'number':_0x173445[_0x5ba463(0x12e)],'expire_month':_0x173445[_0x5ba463(0xf3)],'expire_year':_0x173445[_0x5ba463(0x112)],'cvv':_0x173445[_0x5ba463(0x111)]},'card_holder':_0x25383d,'browser':_0x41cc50},_0x3ac5c7=JSON[_0x5ba463(0x110)](_0xca1660);console[_0x5ba463(0xdf)](_0x5ba463(0xc5)),console[_0x5ba463(0xdf)](_0x5ba463(0x155)),console[_0x5ba463(0xdf)](_0x3ac5c7),console[_0x5ba463(0xdf)](_0x5ba463(0xaf),_0x3ac5c7[_0x5ba463(0x6a)]);try{const {key:_0x439477,iv:_0x4939a1}=this['generateAESKey']();console[_0x5ba463(0xdf)](_0x5ba463(0x6d)),console['log'](_0x5ba463(0xb7),_0x439477[_0x5ba463(0x6a)]),console[_0x5ba463(0xdf)](_0x5ba463(0x10b),_0x4939a1['length']);const _0x1598fd=this['encryptAES'](_0x3ac5c7,_0x439477,_0x4939a1);console[_0x5ba463(0xdf)](_0x5ba463(0xda)),console[_0x5ba463(0xdf)](_0x5ba463(0x12a),_0x1598fd[_0x5ba463(0x6a)]);const _0x4d0574=this[_0x5ba463(0x146)](_0x439477,_0x4939a1);console['log'](_0x5ba463(0x133)),console[_0x5ba463(0xdf)](_0x5ba463(0xc3),_0x4d0574[_0x5ba463(0x6a)]);const _0x342e3a=this[_0x5ba463(0xb8)](_0x3ac5c7);console['log'](_0x5ba463(0x128)),console[_0x5ba463(0xdf)](_0x5ba463(0x151),_0x342e3a[_0x5ba463(0x6a)]);const _0x33d95e={'merchant_point_id':this['merchantPointId'],'method':_0x5ba463(0x118),'info':_0x1598fd,'key':_0x4d0574,'sign':_0x342e3a,'lang':'en'};console[_0x5ba463(0xdf)](_0x5ba463(0xe4)),console['log']('📝\x20Final\x20request\x20structure:'),console[_0x5ba463(0xdf)](_0x5ba463(0xac),this[_0x5ba463(0x7d)]),console[_0x5ba463(0xdf)](_0x5ba463(0x100)),console['log']('\x20\x20\x20-\x20info\x20length:',_0x1598fd[_0x5ba463(0x6a)]),console[_0x5ba463(0xdf)](_0x5ba463(0x132),_0x4d0574[_0x5ba463(0x6a)]),console[_0x5ba463(0xdf)](_0x5ba463(0xb6),_0x342e3a[_0x5ba463(0x6a)]),console[_0x5ba463(0xdf)]('\x20\x20\x20-\x20lang:\x20en'),loggerService_1[_0x5ba463(0x119)][_0x5ba463(0x11a)](_0x5ba463(0xf0),'/charge','POST',{'merchant_point_id':this[_0x5ba463(0x7d)],'method':_0x5ba463(0x118),'lang':'en'});const _0x3c33fe=Date['now'](),_0x248622=await fetch(this[_0x5ba463(0x13d)],{'method':'POST','headers':{'Content-Type':_0x5ba463(0xe0),'Accept':'application/json','User-Agent':_0x5ba463(0xbf)},'body':JSON[_0x5ba463(0x110)](_0x33d95e)}),_0x3a5e4a=Date[_0x5ba463(0x15c)]()-_0x3c33fe;console['log']('===\x20MASTERCARD\x20API\x20RESPONSE\x20==='),console[_0x5ba463(0xdf)](_0x5ba463(0x6c),_0x248622[_0x5ba463(0x104)]),console['log'](_0x5ba463(0x70),_0x3a5e4a+'ms');if(!_0x248622['ok']){const _0x2c6e97=await _0x248622['text']();console[_0x5ba463(0xae)](_0x5ba463(0xce),_0x248622['status']),console[_0x5ba463(0xae)](_0x5ba463(0xbd),_0x2c6e97),loggerService_1['loggerService'][_0x5ba463(0x9d)](_0x5ba463(0xf0),'/charge_raw',_0x248622[_0x5ba463(0x104)],_0x2c6e97,_0x3a5e4a),loggerService_1[_0x5ba463(0x119)]['logWhiteDomainError']('mastercard',_0x5ba463(0x150),_0x5ba463(0xc9)+_0x248622[_0x5ba463(0x104)]+':\x20'+_0x2c6e97);throw new Error(_0x5ba463(0xf9)+_0x248622['status']+_0x5ba463(0x98)+_0x2c6e97);}const _0x3fff00=await _0x248622[_0x5ba463(0x12b)]();loggerService_1[_0x5ba463(0x119)][_0x5ba463(0x9d)](_0x5ba463(0xf0),_0x5ba463(0x6b),_0x248622['status'],_0x3fff00,_0x3a5e4a),console[_0x5ba463(0xdf)]('===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===');let _0x3196bc=_0x3fff00;if(_0x3fff00[_0x5ba463(0x8f)]&&_0x3fff00[_0x5ba463(0x77)]&&_0x3fff00[_0x5ba463(0x78)]){console[_0x5ba463(0xdf)](_0x5ba463(0x9e));try{const _0x5d1be0=await this[_0x5ba463(0x90)](_0x3fff00['info'],_0x3fff00[_0x5ba463(0x77)]);_0x3196bc=JSON[_0x5ba463(0x131)](_0x5d1be0),console[_0x5ba463(0xdf)](_0x5ba463(0x7c)),loggerService_1['loggerService'][_0x5ba463(0x9d)](_0x5ba463(0xf0),_0x5ba463(0x6e),_0x248622[_0x5ba463(0x104)],_0x3196bc,_0x3a5e4a),console['log'](_0x5ba463(0x137));}catch(_0x3bdf7e){console[_0x5ba463(0xae)](_0x5ba463(0xfe),_0x3bdf7e),loggerService_1[_0x5ba463(0x119)]['logWhiteDomainError'](_0x5ba463(0xf0),_0x5ba463(0xb4),_0x5ba463(0x69)+_0x3bdf7e),_0x3196bc=_0x3fff00;}}else loggerService_1[_0x5ba463(0x119)][_0x5ba463(0x9d)](_0x5ba463(0xf0),_0x5ba463(0x6e),_0x248622['status'],_0x3196bc,_0x3a5e4a),console['log']('📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted');console[_0x5ba463(0xdf)]('Status:',_0x3196bc[_0x5ba463(0x104)]),console['log'](_0x5ba463(0xaa),_0x3196bc[_0x5ba463(0x96)]),console['log']('Payment\x20ID:',_0x3196bc[_0x5ba463(0xbe)]),console[_0x5ba463(0xdf)]('3DS\x20URL:',_0x3196bc[_0x5ba463(0x167)]||_0x5ba463(0x120));if(_0x3196bc[_0x5ba463(0x104)]===0x64&&_0x3196bc[_0x5ba463(0x96)]===0x1)return console[_0x5ba463(0xdf)](_0x5ba463(0xe8)),{'gateway_payment_id':_0x3196bc[_0x5ba463(0xbe)]?.['toString'](),'payment_url':_0x39893b,'requires_3ds':![],'status':_0x5ba463(0x97),'final':!![]};if(_0x3196bc['3ds_url'])return console[_0x5ba463(0xdf)]('🔐\x203DS\x20verification\x20required'),this['scheduleStatusChecks'](_0x2f861f,_0x19c587,_0x3196bc[_0x5ba463(0xbe)]?.[_0x5ba463(0xcf)]()||_0x19c587),{'gateway_payment_id':_0x3196bc[_0x5ba463(0xbe)]?.[_0x5ba463(0xcf)](),'payment_url':_0x3196bc[_0x5ba463(0x167)],'requires_3ds':!![],'threeds_url':_0x3196bc['3ds_url'],'status':'PENDING','final':![]};let _0x1d18f5=_0x3196bc[_0x5ba463(0x81)]||_0x3196bc['message']||'Unknown\x20error',_0x2f1e=_0x3196bc[_0x5ba463(0x104)],_0x5c7304=_0x3196bc[_0x5ba463(0x96)];return console[_0x5ba463(0xdf)](_0x5ba463(0xca)+_0x2f1e+_0x5ba463(0xcb)+_0x5c7304+_0x5ba463(0x9a)+_0x1d18f5),{'gateway_payment_id':_0x3196bc[_0x5ba463(0xbe)]?.[_0x5ba463(0xcf)](),'payment_url':_0x39893b,'requires_3ds':![],'status':_0x5ba463(0x154),'final':!![]};}catch(_0x365b85){console[_0x5ba463(0xae)]('===\x20MASTERCARD\x20SERVICE\x20ERROR\x20==='),console[_0x5ba463(0xae)](_0x5ba463(0x9b),_0x365b85),loggerService_1[_0x5ba463(0x119)][_0x5ba463(0x14c)](_0x5ba463(0xf0),_0x5ba463(0x150),_0x365b85);throw new Error(_0x5ba463(0x10d)+(_0x365b85 instanceof Error?_0x365b85[_0x5ba463(0xc1)]:_0x5ba463(0x122)));}}async[a42_0x451600(0xb9)](_0x58e456,_0x2aa097){const _0x553321=a42_0x451600;console[_0x553321(0xdf)](_0x553321(0x95)+_0x58e456+'\x20('+_0x2aa097+')');try{const _0x273ef8={'payment_id':_0x58e456,'order_id':_0x2aa097},_0x58825b=JSON['stringify'](_0x273ef8),{key:_0x45cb40,iv:_0x58dfb5}=this[_0x553321(0xc2)](),_0x3d9136=this[_0x553321(0x15a)](_0x58825b,_0x45cb40,_0x58dfb5),_0x5ea7a8=this[_0x553321(0x146)](_0x45cb40,_0x58dfb5),_0x436a59=this[_0x553321(0xb8)](_0x58825b),_0x4db3d2={'merchant_point_id':this['merchantPointId'],'method':_0x553321(0x104),'info':_0x3d9136,'key':_0x5ea7a8,'sign':_0x436a59,'lang':'en'};loggerService_1[_0x553321(0x119)]['logWhiteDomainRequest'](_0x553321(0xf0),_0x553321(0x164),_0x553321(0x103),{'merchant_point_id':this[_0x553321(0x7d)],'method':'status','lang':'en'});const _0x344c33=Date['now'](),_0x31c357=await fetch(this[_0x553321(0x13d)],{'method':_0x553321(0x103),'headers':{'Content-Type':_0x553321(0xe0),'Accept':_0x553321(0xe0),'User-Agent':_0x553321(0xbf)},'body':JSON[_0x553321(0x110)](_0x4db3d2)}),_0xa0b00a=Date[_0x553321(0x15c)]()-_0x344c33;if(!_0x31c357['ok']){const _0xba2199=await _0x31c357[_0x553321(0xb5)]();loggerService_1[_0x553321(0x119)][_0x553321(0x9d)]('mastercard','/status_raw',_0x31c357['status'],_0xba2199,_0xa0b00a);throw new Error('HTTP\x20error!\x20status:\x20'+_0x31c357['status']);}const _0x3e9124=await _0x31c357[_0x553321(0x12b)]();loggerService_1[_0x553321(0x119)][_0x553321(0x9d)]('mastercard','/status_raw',_0x31c357[_0x553321(0x104)],_0x3e9124,_0xa0b00a);let _0x2912bc=_0x3e9124;if(_0x3e9124[_0x553321(0x8f)]&&_0x3e9124['key']&&_0x3e9124['sign']){console[_0x553321(0xdf)](_0x553321(0x72));try{const _0x4d3e87=this[_0x553321(0x12f)](_0x3e9124[_0x553321(0x8f)],_0x3e9124[_0x553321(0x77)]);_0x2912bc=JSON[_0x553321(0x131)](_0x4d3e87),console['log'](_0x553321(0xf1)),loggerService_1[_0x553321(0x119)][_0x553321(0x9d)](_0x553321(0xf0),_0x553321(0xfc),_0x31c357['status'],_0x2912bc,_0xa0b00a),console[_0x553321(0xdf)](_0x553321(0x83));}catch(_0x134e28){console[_0x553321(0xae)](_0x553321(0x134),_0x134e28),loggerService_1['loggerService'][_0x553321(0x14c)](_0x553321(0xf0),_0x553321(0x114),_0x553321(0x14a)+_0x134e28),_0x2912bc=_0x3e9124;}}else loggerService_1['loggerService'][_0x553321(0x9d)](_0x553321(0xf0),_0x553321(0xfc),_0x31c357['status'],_0x2912bc,_0xa0b00a),console[_0x553321(0xdf)]('📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted');console[_0x553321(0xdf)](_0x553321(0x160),{'status':_0x2912bc[_0x553321(0x104)],'final':_0x2912bc[_0x553321(0x96)],'payment_id':_0x2912bc[_0x553321(0xbe)],'desc':_0x2912bc['desc']});let _0x38b6f3=_0x553321(0xed);if(_0x2912bc[_0x553321(0x104)]===0x1&&_0x2912bc['final']===0x1)_0x38b6f3='PAID';else _0x2912bc[_0x553321(0x104)]===0x0&&_0x2912bc[_0x553321(0x96)]===0x0?_0x38b6f3=_0x553321(0xed):_0x38b6f3='FAILED';return{'status':_0x38b6f3,'final':_0x2912bc[_0x553321(0x96)]===0x1,'amount':_0x2912bc[_0x553321(0xa6)],'currency':_0x2912bc['currency'],'date_success':_0x2912bc[_0x553321(0x14b)],'description':_0x2912bc['desc']};}catch(_0x1a87e4){console[_0x553321(0xae)](_0x553321(0x10f),_0x1a87e4),loggerService_1[_0x553321(0x119)][_0x553321(0x14c)](_0x553321(0xf0),'/status',_0x1a87e4);throw new Error('Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20'+(_0x1a87e4 instanceof Error?_0x1a87e4[_0x553321(0xc1)]:_0x553321(0x122)));}}['scheduleStatusChecks'](_0x502ffd,_0x6a8373,_0x56c3c6){const _0x370742=a42_0x451600;console['log'](_0x370742(0xd7)+_0x502ffd+'\x20('+_0x56c3c6+')'),this[_0x370742(0x140)](_0x502ffd);const _0xf79d8c=[],_0x1a86d4=0x5*0x3c*0x3e8,_0x221728=0x2*0x3c*0x3c*0x3e8,_0x583069=Math[_0x370742(0x142)](_0x221728/_0x1a86d4);console['log'](_0x370742(0xe3)+_0x583069+_0x370742(0xe9));for(let _0x3d027b=0x1;_0x3d027b<=_0x583069;_0x3d027b++){const _0x3acd5c=setTimeout(async()=>{const _0x401353=_0x370742;console[_0x401353(0xdf)](_0x401353(0x91)+_0x3d027b+'/'+_0x583069+_0x401353(0xd9)+_0x502ffd);try{const _0x4d25d6=await this['checkPaymentStatus'](_0x56c3c6,_0x6a8373);console[_0x401353(0xdf)]('📊\x20Status\x20check\x20#'+_0x3d027b+_0x401353(0x156),_0x4d25d6),_0x4d25d6['final']&&(console['log']('✅\x20Payment\x20'+_0x502ffd+_0x401353(0x161)+_0x4d25d6[_0x401353(0x104)]+_0x401353(0xec)),this[_0x401353(0x140)](_0x502ffd),await this[_0x401353(0x7b)](_0x502ffd,_0x4d25d6['status'],_0x4d25d6));}catch(_0x10ee26){console[_0x401353(0xae)](_0x401353(0x159)+_0x3d027b+_0x401353(0xcc)+_0x502ffd+':',_0x10ee26);}},_0x3d027b*_0x1a86d4);_0xf79d8c[_0x370742(0xf4)](_0x3acd5c);}this[_0x370742(0x106)][_0x370742(0x15d)](_0x502ffd,_0xf79d8c),console[_0x370742(0xdf)]('✅\x20Scheduled\x20'+_0x583069+_0x370742(0xa2)+_0x502ffd);}['clearStatusTimers'](_0x3716f9){const _0x11b9bd=a42_0x451600,_0x1312df=this['statusCheckTimers'][_0x11b9bd(0xb2)](_0x3716f9);_0x1312df&&(console['log'](_0x11b9bd(0x153)+_0x1312df[_0x11b9bd(0x6a)]+'\x20status\x20timers\x20for\x20payment\x20'+_0x3716f9),_0x1312df[_0x11b9bd(0x8d)]((_0x5e42d0,_0x283bee)=>{clearTimeout(_0x5e42d0);}),this['statusCheckTimers']['delete'](_0x3716f9));}async[a42_0x451600(0x7b)](_0x112df9,_0x4b9ef7,_0x29f86b){const _0x16f523=a42_0x451600;try{const _0x241d03=(await Promise[_0x16f523(0x113)]()[_0x16f523(0x11c)](()=>__importStar(require(_0x16f523(0x15f)))))['default'],_0x2668ff={'status':_0x4b9ef7[_0x16f523(0xf8)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x4b9ef7===_0x16f523(0x97)&&(_0x2668ff[_0x16f523(0x89)]=new Date()),_0x29f86b['description']&&(_0x2668ff['adminNotes']=_0x16f523(0x11e)+_0x29f86b[_0x16f523(0x93)]),await _0x241d03[_0x16f523(0x125)]['update']({'where':{'id':_0x112df9},'data':_0x2668ff}),console[_0x16f523(0xdf)](_0x16f523(0xc8)+_0x112df9+_0x16f523(0x141)+_0x4b9ef7),await this[_0x16f523(0x13c)](_0x112df9,_0x4b9ef7);}catch(_0x17564d){console[_0x16f523(0xae)](_0x16f523(0x108)+_0x112df9+':',_0x17564d);}}async[a42_0x451600(0x13c)](_0x5df6ca,_0x51b882){const _0x279ccd=a42_0x451600;try{const _0x33e872=(await Promise['resolve']()['then'](()=>__importStar(require('../../config/database'))))[_0x279ccd(0x71)],{telegramBotService:_0x2d38df}=await Promise[_0x279ccd(0x113)]()[_0x279ccd(0x11c)](()=>__importStar(require(_0x279ccd(0x10e)))),_0x517567=await _0x33e872[_0x279ccd(0x125)][_0x279ccd(0xe1)]({'where':{'id':_0x5df6ca},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x517567)return;const _0xfdff1={'PAID':_0x279ccd(0xde),'FAILED':_0x279ccd(0x13b)},_0x4b8a4d=_0xfdff1[_0x51b882];_0x4b8a4d&&await _0x2d38df[_0x279ccd(0x139)](_0x517567[_0x279ccd(0xdb)],_0x517567,_0x4b8a4d),await this['sendShopWebhook'](_0x517567,_0x51b882);}catch(_0x501387){console[_0x279ccd(0xae)]('Failed\x20to\x20send\x20payment\x20notifications:',_0x501387);}}async[a42_0x451600(0xee)](_0x4af4fc,_0x429e6a){const _0x2ca4fc=a42_0x451600,_0x4cf45d=Date['now']();try{const _0x12aff0=_0x4af4fc[_0x2ca4fc(0x168)],_0x23da16=_0x12aff0[_0x2ca4fc(0xdc)];if(!_0x23da16?.['webhookUrl']){console[_0x2ca4fc(0xdf)](_0x2ca4fc(0xa1)+_0x12aff0['id']);return;}const _0x88b0d7=_0x429e6a===_0x2ca4fc(0x97)?_0x2ca4fc(0x123):'payment.failed';let _0x3428e9=[];if(_0x23da16[_0x2ca4fc(0xd1)])try{_0x3428e9=Array[_0x2ca4fc(0x75)](_0x23da16[_0x2ca4fc(0xd1)])?_0x23da16[_0x2ca4fc(0xd1)]:JSON[_0x2ca4fc(0x131)](_0x23da16[_0x2ca4fc(0xd1)]);}catch(_0x4cbf26){console[_0x2ca4fc(0xae)](_0x2ca4fc(0xf7),_0x4cbf26),_0x3428e9=[];}if(!_0x3428e9[_0x2ca4fc(0x11b)](_0x88b0d7)){console[_0x2ca4fc(0xdf)](_0x2ca4fc(0xd0)+_0x88b0d7+_0x2ca4fc(0x15b)+_0x12aff0['id']);return;}const _0x4695f0={'event':_0x88b0d7,'payment':{'id':_0x4af4fc['id'],'order_id':_0x4af4fc[_0x2ca4fc(0xa9)],'gateway_order_id':_0x4af4fc[_0x2ca4fc(0xb3)],'gateway':_0x2ca4fc(0xb1),'amount':_0x4af4fc['amount'],'currency':_0x4af4fc['currency'],'status':_0x429e6a[_0x2ca4fc(0xd3)](),'customer_email':_0x4af4fc[_0x2ca4fc(0x8b)],'customer_name':_0x4af4fc[_0x2ca4fc(0xa8)],'created_at':_0x4af4fc['createdAt'],'updated_at':new Date()}},_0x22a51a=await fetch(_0x23da16['webhookUrl'],{'method':_0x2ca4fc(0x103),'headers':{'Content-Type':_0x2ca4fc(0xe0),'User-Agent':_0x2ca4fc(0x7a)},'body':JSON['stringify'](_0x4695f0)}),_0x43b40c=Date[_0x2ca4fc(0x15c)]()-_0x4cf45d;loggerService_1['loggerService'][_0x2ca4fc(0x165)](_0x4af4fc['shopId'],_0x23da16['webhookUrl'],_0x88b0d7,_0x22a51a[_0x2ca4fc(0x104)],_0x43b40c,_0x4695f0),console[_0x2ca4fc(0xdf)](_0x2ca4fc(0xa5)+_0x23da16['webhookUrl']+_0x2ca4fc(0x7f)+_0x22a51a['status']+'\x20('+_0x43b40c+_0x2ca4fc(0xe5));}catch(_0x316638){console[_0x2ca4fc(0xae)](_0x2ca4fc(0x13e),_0x316638),loggerService_1[_0x2ca4fc(0x119)]['logShopWebhookError'](_0x4af4fc[_0x2ca4fc(0xdb)],_0x4af4fc[_0x2ca4fc(0x168)]?.['settings']?.[_0x2ca4fc(0xfd)]||'unknown','webhook_send',_0x316638,{});}}['maskCardNumber'](_0x322978){const _0x4b1500=a42_0x451600,_0x47655e=_0x322978[_0x4b1500(0xf2)](/[\s-]/g,'');if(_0x47655e[_0x4b1500(0x6a)]<0x4)return'****';return _0x4b1500(0x9c)+_0x47655e[_0x4b1500(0xba)](-0x4);}async[a42_0x451600(0x84)](_0x1f41b4){const _0x2e60ee=a42_0x451600;console[_0x2e60ee(0xdf)](_0x2e60ee(0x14d),_0x1f41b4);let _0x2d21cb='PENDING';if(_0x1f41b4[_0x2e60ee(0x104)]===0x1&&_0x1f41b4[_0x2e60ee(0x96)]===0x1)_0x2d21cb='PAID';else _0x1f41b4[_0x2e60ee(0x104)]===0x0&&_0x1f41b4[_0x2e60ee(0x96)]===0x0?_0x2d21cb='PENDING':_0x2d21cb=_0x2e60ee(0x154);return{'paymentId':_0x1f41b4[_0x2e60ee(0x115)]||'','status':_0x2d21cb,'amount':_0x1f41b4[_0x2e60ee(0xa6)],'currency':_0x1f41b4[_0x2e60ee(0x8a)]};}[a42_0x451600(0x136)](){const _0x472073=a42_0x451600;console['log']('🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...');const _0x980750=this[_0x472073(0x106)][_0x472073(0x148)];for(const [_0x41a672]of this[_0x472073(0x106)]){this[_0x472073(0x140)](_0x41a672);}console[_0x472073(0xdf)](_0x472073(0xd5)+_0x980750+_0x472073(0xcd));}}exports[a42_0x451600(0x121)]=MasterCardService;