'use strict';const a42_0xab5c90=a42_0x4101;(function(_0x2171a2,_0x18e67d){const _0x183781=a42_0x4101,_0x2a4da6=_0x2171a2();while(!![]){try{const _0x32e71c=-parseInt(_0x183781(0x23b))/0x1+parseInt(_0x183781(0x2ca))/0x2+-parseInt(_0x183781(0x1f8))/0x3*(-parseInt(_0x183781(0x1f1))/0x4)+-parseInt(_0x183781(0x254))/0x5*(parseInt(_0x183781(0x218))/0x6)+-parseInt(_0x183781(0x20f))/0x7*(-parseInt(_0x183781(0x24a))/0x8)+-parseInt(_0x183781(0x299))/0x9*(-parseInt(_0x183781(0x231))/0xa)+parseInt(_0x183781(0x2c4))/0xb*(-parseInt(_0x183781(0x208))/0xc);if(_0x32e71c===_0x18e67d)break;else _0x2a4da6['push'](_0x2a4da6['shift']());}catch(_0x304068){_0x2a4da6['push'](_0x2a4da6['shift']());}}}(a42_0x95a0,0x7cc0f));function a42_0x95a0(){const _0x4336c7=['first_name','Result\x20URL:','createCipheriv','🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA','❌\x20Data\x20being\x20signed:','size','last_name','MasterCardService','Public\x20key\x20file\x20not\x20found:\x20','🔐\x20Data\x20encrypted\x20with\x20AES','date_success','payment.success','logWhiteDomainError','📝\x20Data\x20length:','logShopWebhookSent','getOwnPropertyDescriptor','🔐\x20AES\x20key\x20and\x20IV\x20generated','/charge_raw','PAID','🛑\x20Stopped\x20','error','ms)','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20','webhookEvents','unknown','Payment\x20ID:','✅\x20Payment\x20successful','Final:','charge','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','📊\x20Status\x20check\x20result:','Card\x20Holder:','findUnique','⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20','Webhook\x20event\x20','json','6356943DxfeuG','update','📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','HTTP\x20error!\x20status:\x20','payment_id','expire_year','/status_raw','__createBinding','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','readFileSync','aes-256-ctr','🔐\x20AES\x20IV\x20length:','📝\x20Encrypted\x20key\x20length:','defineProperty','push','/charge','decryptResponsePhp','decryptAES','now','/charge_decrypt','encryptRSA','🔍\x20MasterCard\x20status\x20check\x20#','call','decryptResponse','Card\x20Number:','sendPaymentNotification','trim','__importDefault','text','__setModuleDefault','\x20\x20\x20-\x20method:\x20charge','expire_month','randomBytes','1111','apiUrl','replace','validateKeyFiles','key','adminNotes',',\x20body:\x20','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','../../config/database','create','376849iBbMPg','sendPaymentNotifications','stringify','logShopWebhookError','\x20\x20\x20-\x20sign\x20length:','system','1349856SSHpjI','createdAt','__esModule','substring','📝\x20Final\x20request\x20structure:','3DS\x20URL:','parse','set','💾\x20Payment\x20data\x20prepared','encryptAES','📝\x20Encrypted\x20data\x20length:','generateAESKey','desc','privateDecrypt','maskCardNumber','existsSync','createSign','\x20for\x20payment\x20','⏰\x20Will\x20check\x20status\x20','❌\x20RSA\x20signing\x20failed:','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','private.pem','2225692JcVfdx','❌\x20Failed\x20to\x20decrypt\x20status\x20response:','application/json','shop','/status_decrypted','webhook_send','clearStatusTimers','3QURYqQ','join','checkPaymentStatus','\x20\x20\x20-\x20key\x20length:','scheduleStatusChecks','\x20characters','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','\x20MasterCard\x20status\x20check\x20timers','cwd','customerName','\x20\x20\x20-\x20info\x20length:','final','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','constants',',\x20Desc:\x20','Error\x20parsing\x20webhook\x20events:','444BIhBPb','https://api.paydmeth.com/api','status','3ds_url','PENDING','🔐\x203DS\x20verification\x20required','order_id','7KEhAzm','createDecipheriv','POST','webhookUrl','statusCheckTimers','loggerService','from','slice','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','6pQURxQ','Failed\x20to\x20decrypt\x20response','currency','publicKeyPath','publicEncrypt','...','📝\x20Data\x20to\x20sign\x20length:','Response\x20Body:','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','psp_public.pem','privateKeyPath','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','toString','then','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','orderId','✅\x20Status\x20response\x20decrypted\x20successfully','sendShopWebhook','Amount:','\x20status\x20checks\x20for\x20payment\x20','RSA_PKCS1_PADDING','),\x20stopping\x20status\x20checks','Unknown\x20error','Private\x20key\x20file\x20not\x20found:\x20','writable','10EzjSXE','TesSoft\x20Payment\x20System/1.0','\x20\x20\x20-\x20merchant_point_id:','delete','-----BEGIN','Processing\x20MasterCard\x20webhook:','message','get','Status:','default','117749ZvmVZw','resolve','Failed\x20to\x20decrypt\x20response\x20via\x20PHP','\x20is\x20final\x20(','mastercard','keys','🔐\x20Public\x20key\x20path:','shopId','payment','📝\x20Signature\x20length:','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','Return\x20URL:','log','-----END','end','5516272ueFqif','/charge_decrypted','****\x20****\x20****\x20','base64',',\x20Final:\x20','toUpperCase','../loggerService','logWhiteDomainRequest','✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)','updatePaymentStatus','3654445psZHSg','FAILED','logWhiteDomainResponse','includes','Status\x20decryption\x20failed:\x20','✅\x20Payment\x20','signRSA','../telegramBotService','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','settings','❌\x20MasterCard\x20key\x20validation\x20failed:','processCardPayment','payment.failed','utf8','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Failed\x20to\x20send\x20MasterCard\x20webhook:','sign','hasOwnProperty','🧹\x20Clearing\x20','Failed\x20to\x20send\x20payment\x20notifications:','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','forEach','description','customerEmail','\x20\x20\x20-\x20lang:\x20en','Response\x20Time:','merchantPointId','length','📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','info','path'];a42_0x95a0=function(){return _0x4336c7;};return a42_0x95a0();}var __createBinding=this&&this[a42_0xab5c90(0x2a0)]||(Object[a42_0xab5c90(0x2c3)]?function(_0x162075,_0x1092ec,_0x3ab413,_0x412960){const _0x46f5a8=a42_0xab5c90;if(_0x412960===undefined)_0x412960=_0x3ab413;var _0x47123c=Object[_0x46f5a8(0x282)](_0x1092ec,_0x3ab413);(!_0x47123c||('get'in _0x47123c?!_0x1092ec['__esModule']:_0x47123c[_0x46f5a8(0x230)]||_0x47123c['configurable']))&&(_0x47123c={'enumerable':!![],'get':function(){return _0x1092ec[_0x3ab413];}}),Object[_0x46f5a8(0x2a6)](_0x162075,_0x412960,_0x47123c);}:function(_0x435d44,_0x3540cf,_0x5010c3,_0x6abfd3){if(_0x6abfd3===undefined)_0x6abfd3=_0x5010c3;_0x435d44[_0x6abfd3]=_0x3540cf[_0x5010c3];}),__setModuleDefault=this&&this[a42_0xab5c90(0x2b6)]||(Object[a42_0xab5c90(0x2c3)]?function(_0x5b0f0b,_0x5b0c66){Object['defineProperty'](_0x5b0f0b,'default',{'enumerable':!![],'value':_0x5b0c66});}:function(_0x3810b2,_0x170dae){const _0x36d942=a42_0xab5c90;_0x3810b2[_0x36d942(0x23a)]=_0x170dae;}),__importStar=this&&this['__importStar']||(function(){var _0x4236cf=function(_0x2be5c0){return _0x4236cf=Object['getOwnPropertyNames']||function(_0x40747a){const _0x389ff0=a42_0x4101;var _0x1dfe31=[];for(var _0xa726fa in _0x40747a)if(Object['prototype'][_0x389ff0(0x265)][_0x389ff0(0x2af)](_0x40747a,_0xa726fa))_0x1dfe31[_0x1dfe31[_0x389ff0(0x26f)]]=_0xa726fa;return _0x1dfe31;},_0x4236cf(_0x2be5c0);};return function(_0x429f92){const _0x58daa1=a42_0x4101;if(_0x429f92&&_0x429f92[_0x58daa1(0x2cc)])return _0x429f92;var _0x3cecec={};if(_0x429f92!=null){for(var _0x48bd3b=_0x4236cf(_0x429f92),_0x449bcb=0x0;_0x449bcb<_0x48bd3b['length'];_0x449bcb++)if(_0x48bd3b[_0x449bcb]!=='default')__createBinding(_0x3cecec,_0x429f92,_0x48bd3b[_0x449bcb]);}return __setModuleDefault(_0x3cecec,_0x429f92),_0x3cecec;};}()),__importDefault=this&&this[a42_0xab5c90(0x2b4)]||function(_0x2f4091){return _0x2f4091&&_0x2f4091['__esModule']?_0x2f4091:{'default':_0x2f4091};};Object['defineProperty'](exports,a42_0xab5c90(0x2cc),{'value':!![]}),exports['MasterCardService']=void 0x0;function a42_0x4101(_0xb8c151,_0x41944e){const _0x95a0a3=a42_0x95a0();return a42_0x4101=function(_0x410103,_0x5379d8){_0x410103=_0x410103-0x1ec;let _0xbd64c2=_0x95a0a3[_0x410103];return _0xbd64c2;},a42_0x4101(_0xb8c151,_0x41944e);}const crypto_1=__importDefault(require('crypto')),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0xab5c90(0x272))),loggerService_1=require(a42_0xab5c90(0x250));class MasterCardService{constructor(){const _0x588fd3=a42_0xab5c90;this['statusCheckTimers']=new Map(),this[_0x588fd3(0x2bb)]=_0x588fd3(0x209),this['merchantPointId']=0x67c,this['privateKeyPath']=path_1[_0x588fd3(0x23a)][_0x588fd3(0x1f9)](process['cwd'](),_0x588fd3(0x240),_0x588fd3(0x1f0)),this[_0x588fd3(0x21b)]=path_1['default'][_0x588fd3(0x1f9)](process[_0x588fd3(0x200)](),_0x588fd3(0x240),_0x588fd3(0x221)),console[_0x588fd3(0x247)]('💳\x20MasterCard\x20service\x20initialized'),console[_0x588fd3(0x247)]('🔐\x20Private\x20key\x20path:',this[_0x588fd3(0x222)]),console[_0x588fd3(0x247)](_0x588fd3(0x241),this[_0x588fd3(0x21b)]),this[_0x588fd3(0x2bd)]();}['validateKeyFiles'](){const _0x2891ef=a42_0xab5c90;try{if(!fs_1[_0x2891ef(0x23a)][_0x2891ef(0x2d9)](this[_0x2891ef(0x222)]))throw new Error(_0x2891ef(0x22f)+this[_0x2891ef(0x222)]);if(!fs_1[_0x2891ef(0x23a)][_0x2891ef(0x2d9)](this[_0x2891ef(0x21b)]))throw new Error(_0x2891ef(0x27b)+this['publicKeyPath']);const _0xc9c27b=fs_1[_0x2891ef(0x23a)]['readFileSync'](this[_0x2891ef(0x222)],'utf8')[_0x2891ef(0x2b3)](),_0x35e768=fs_1[_0x2891ef(0x23a)][_0x2891ef(0x2a2)](this[_0x2891ef(0x21b)],'utf8')[_0x2891ef(0x2b3)]();if(!_0xc9c27b[_0x2891ef(0x257)](_0x2891ef(0x235))||!_0xc9c27b[_0x2891ef(0x257)](_0x2891ef(0x248)))throw new Error(_0x2891ef(0x28a));if(!_0x35e768[_0x2891ef(0x257)](_0x2891ef(0x235))||!_0x35e768[_0x2891ef(0x257)]('-----END'))throw new Error(_0x2891ef(0x268));console['log'](_0x2891ef(0x245)),console[_0x2891ef(0x247)]('🔐\x20Private\x20key\x20length:\x20'+_0xc9c27b[_0x2891ef(0x26f)]+'\x20characters'),console[_0x2891ef(0x247)]('🔐\x20Public\x20key\x20length:\x20'+_0x35e768[_0x2891ef(0x26f)]+_0x2891ef(0x1fd));}catch(_0x39a1d8){console['error'](_0x2891ef(0x25e),_0x39a1d8);throw _0x39a1d8;}}[a42_0xab5c90(0x2d5)](){const _0xbfd3a6=a42_0xab5c90,_0x2d3cb5=crypto_1[_0xbfd3a6(0x23a)][_0xbfd3a6(0x2b9)](0x20),_0x5b1605=crypto_1[_0xbfd3a6(0x23a)]['randomBytes'](0x10);return{'key':_0x2d3cb5,'iv':_0x5b1605};}[a42_0xab5c90(0x2d3)](_0x127d59,_0x19a2a2,_0x2db0ba){const _0x36a9ee=a42_0xab5c90,_0x31c120=crypto_1['default'][_0x36a9ee(0x275)](_0x36a9ee(0x2a3),_0x19a2a2,_0x2db0ba);let _0x31fc3e=_0x31c120['update'](_0x127d59,_0x36a9ee(0x261),'base64');return _0x31fc3e+=_0x31c120[_0x36a9ee(0x203)](_0x36a9ee(0x24d)),_0x31fc3e;}[a42_0xab5c90(0x2ad)](_0x1b8529,_0x5b7b28){const _0x5b57d6=a42_0xab5c90;try{const _0x4f4791=fs_1[_0x5b57d6(0x23a)][_0x5b57d6(0x2a2)](this[_0x5b57d6(0x21b)],_0x5b57d6(0x261))['trim'](),_0x2b9b48={'iv':_0x5b7b28[_0x5b57d6(0x224)](_0x5b57d6(0x24d)),'key':_0x1b8529[_0x5b57d6(0x224)](_0x5b57d6(0x24d))},_0x9f3655=JSON['stringify'](_0x2b9b48);console[_0x5b57d6(0x247)](_0x5b57d6(0x226),_0x9f3655[_0x5b57d6(0x26f)]);const _0x4fd4cb=crypto_1[_0x5b57d6(0x23a)][_0x5b57d6(0x21c)]({'key':_0x4f4791,'padding':crypto_1[_0x5b57d6(0x23a)][_0x5b57d6(0x205)][_0x5b57d6(0x22c)]},Buffer[_0x5b57d6(0x215)](_0x9f3655));return console['log'](_0x5b57d6(0x25c),_0x4fd4cb['length']),_0x4fd4cb[_0x5b57d6(0x224)]('base64');}catch(_0xaeae93){console[_0x5b57d6(0x287)]('❌\x20RSA\x20encryption\x20failed:',_0xaeae93);throw new Error('Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key');}}[a42_0xab5c90(0x25a)](_0xea07c9){const _0x387b1e=a42_0xab5c90;try{const _0x445ae9=fs_1[_0x387b1e(0x23a)][_0x387b1e(0x2a2)](this[_0x387b1e(0x222)],_0x387b1e(0x261))[_0x387b1e(0x2b3)](),_0x2a9521=crypto_1[_0x387b1e(0x23a)][_0x387b1e(0x2da)]('SHA256');_0x2a9521['update'](_0xea07c9),_0x2a9521[_0x387b1e(0x249)]();const _0x25a58a=_0x2a9521[_0x387b1e(0x264)](_0x445ae9,_0x387b1e(0x24d));return console[_0x387b1e(0x247)]('🔐\x20RSA\x20signing\x20successful'),console[_0x387b1e(0x247)](_0x387b1e(0x21e),_0xea07c9[_0x387b1e(0x26f)]),console[_0x387b1e(0x247)](_0x387b1e(0x244),_0x25a58a[_0x387b1e(0x26f)]),_0x25a58a;}catch(_0x2e4f3f){console[_0x387b1e(0x287)](_0x387b1e(0x1ee),_0x2e4f3f),console[_0x387b1e(0x287)](_0x387b1e(0x277),_0xea07c9[_0x387b1e(0x2cd)](0x0,0xc8)+_0x387b1e(0x21d));throw new Error(_0x387b1e(0x1ef));}}[a42_0xab5c90(0x2aa)](_0x4d1bf5,_0x2c3ddb,_0x31134d){const _0x101243=a42_0xab5c90,_0x350523=crypto_1[_0x101243(0x23a)][_0x101243(0x210)]('aes-256-ctr',_0x2c3ddb,_0x31134d);let _0x3f6cd6=_0x350523[_0x101243(0x29a)](_0x4d1bf5,_0x101243(0x24d),_0x101243(0x261));return _0x3f6cd6+=_0x350523['final'](_0x101243(0x261)),_0x3f6cd6;}async[a42_0xab5c90(0x2a9)](_0x4c166d,_0x372864){const _0x30d5fb=a42_0xab5c90;try{const _0x36e4da=await fetch('https://api2.trapay.uk/decrypt.php',{'method':_0x30d5fb(0x211),'headers':{'Content-Type':_0x30d5fb(0x1f3)},'body':JSON[_0x30d5fb(0x2c6)]({'info':_0x4c166d,'key':_0x372864})});if(!_0x36e4da['ok'])throw new Error('PHP\x20decryptor\x20error');return await _0x36e4da['text']();}catch(_0x39df52){console['error']('❌\x20PHP\x20decryptor\x20request\x20failed:',_0x39df52);throw new Error(_0x30d5fb(0x23d));}}[a42_0xab5c90(0x2b0)](_0x43fb2f,_0x118dc0){const _0x53c769=a42_0xab5c90;try{const _0x17fc4a=fs_1[_0x53c769(0x23a)][_0x53c769(0x2a2)](this['privateKeyPath'],_0x53c769(0x261))[_0x53c769(0x2b3)](),_0x3e4f17=crypto_1['default'][_0x53c769(0x2d7)](_0x17fc4a,Buffer[_0x53c769(0x215)](_0x118dc0,_0x53c769(0x24d))),_0x1c035e=JSON['parse'](_0x3e4f17['toString']()),_0x5b9fcf=Buffer[_0x53c769(0x215)](_0x1c035e['key'],_0x53c769(0x24d)),_0x312881=Buffer['from'](_0x1c035e['iv'],'base64');return this[_0x53c769(0x2aa)](_0x43fb2f,_0x5b9fcf,_0x312881);}catch(_0x5a3e78){throw new Error(_0x53c769(0x219));}}async[a42_0xab5c90(0x25f)](_0x48f363){const _0xa032aa=a42_0xab5c90,{paymentId:_0x1f29da,orderId:_0x17745b,amount:_0xa0a3b0,currency:_0x177ea1,cardData:_0x2b5291,resultUrl:_0x15e7e2,returnUrl:_0xb81ace,cardHolder:_0x79e857,browser:_0x2f8a76}=_0x48f363;console['log']('===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20==='),console[_0xa032aa(0x247)](_0xa032aa(0x28e),_0x1f29da),console['log']('Order\x20ID:',_0x17745b),console[_0xa032aa(0x247)](_0xa032aa(0x22a),_0xa0a3b0,_0x177ea1),console[_0xa032aa(0x247)](_0xa032aa(0x2b1),this[_0xa032aa(0x2d8)](_0x2b5291['number'])),console[_0xa032aa(0x247)](_0xa032aa(0x294),_0x79e857[_0xa032aa(0x273)]+'\x20'+_0x79e857[_0xa032aa(0x279)]),console['log'](_0xa032aa(0x246),_0xb81ace),console['log'](_0xa032aa(0x274),_0x15e7e2);const _0x462484={'amount':_0xa0a3b0,'currency':_0x177ea1[_0xa032aa(0x24f)](),'order_id':_0x17745b,'result_url':_0x15e7e2,'return_url':_0xb81ace,'card':{'number':_0x2b5291['number'],'expire_month':_0x2b5291[_0xa032aa(0x2b8)],'expire_year':_0x2b5291[_0xa032aa(0x29e)],'cvv':_0x2b5291['cvv']},'card_holder':_0x79e857,'browser':_0x2f8a76},_0x1e4194=JSON['stringify'](_0x462484);console[_0xa032aa(0x247)](_0xa032aa(0x2d2)),console[_0xa032aa(0x247)]('📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:'),console[_0xa032aa(0x247)](_0x1e4194),console[_0xa032aa(0x247)](_0xa032aa(0x280),_0x1e4194[_0xa032aa(0x26f)]);try{const {key:_0x3c8372,iv:_0x4f1f58}=this['generateAESKey']();console[_0xa032aa(0x247)](_0xa032aa(0x283)),console[_0xa032aa(0x247)]('🔐\x20AES\x20key\x20length:',_0x3c8372[_0xa032aa(0x26f)]),console[_0xa032aa(0x247)](_0xa032aa(0x2a4),_0x4f1f58['length']);const _0x38eec1=this[_0xa032aa(0x2d3)](_0x1e4194,_0x3c8372,_0x4f1f58);console[_0xa032aa(0x247)](_0xa032aa(0x27c)),console[_0xa032aa(0x247)](_0xa032aa(0x2d4),_0x38eec1['length']);const _0x4dd208=this[_0xa032aa(0x2ad)](_0x3c8372,_0x4f1f58);console['log'](_0xa032aa(0x276)),console[_0xa032aa(0x247)](_0xa032aa(0x2a5),_0x4dd208['length']);const _0x37c690=this['signRSA'](_0x1e4194);console[_0xa032aa(0x247)]('🔐\x20Data\x20signed\x20with\x20RSA'),console[_0xa032aa(0x247)](_0xa032aa(0x244),_0x37c690['length']);const _0x13039d={'merchant_point_id':this[_0xa032aa(0x26e)],'method':_0xa032aa(0x291),'info':_0x38eec1,'key':_0x4dd208,'sign':_0x37c690,'lang':'en'};console[_0xa032aa(0x247)]('📤\x20Sending\x20request\x20to\x20MasterCard\x20API...'),console[_0xa032aa(0x247)](_0xa032aa(0x2ce)),console['log'](_0xa032aa(0x233),this[_0xa032aa(0x26e)]),console[_0xa032aa(0x247)](_0xa032aa(0x2b7)),console['log'](_0xa032aa(0x202),_0x38eec1[_0xa032aa(0x26f)]),console[_0xa032aa(0x247)](_0xa032aa(0x1fb),_0x4dd208[_0xa032aa(0x26f)]),console[_0xa032aa(0x247)](_0xa032aa(0x2c8),_0x37c690['length']),console[_0xa032aa(0x247)](_0xa032aa(0x26c)),loggerService_1[_0xa032aa(0x214)][_0xa032aa(0x251)](_0xa032aa(0x23f),'/charge',_0xa032aa(0x211),{'merchant_point_id':this[_0xa032aa(0x26e)],'method':_0xa032aa(0x291),'lang':'en'});const _0x13f423=Date[_0xa032aa(0x2ab)](),_0x4185b3=await fetch(this['apiUrl'],{'method':_0xa032aa(0x211),'headers':{'Content-Type':_0xa032aa(0x1f3),'Accept':_0xa032aa(0x1f3),'User-Agent':_0xa032aa(0x232)},'body':JSON[_0xa032aa(0x2c6)](_0x13039d)}),_0x3a04e0=Date[_0xa032aa(0x2ab)]()-_0x13f423;console[_0xa032aa(0x247)](_0xa032aa(0x223)),console[_0xa032aa(0x247)](_0xa032aa(0x239),_0x4185b3[_0xa032aa(0x20a)]),console['log'](_0xa032aa(0x26d),_0x3a04e0+'ms');if(!_0x4185b3['ok']){const _0x24cf26=await _0x4185b3[_0xa032aa(0x2b5)]();console[_0xa032aa(0x287)]('HTTP\x20Status:',_0x4185b3[_0xa032aa(0x20a)]),console[_0xa032aa(0x287)](_0xa032aa(0x21f),_0x24cf26),loggerService_1[_0xa032aa(0x214)][_0xa032aa(0x256)](_0xa032aa(0x23f),'/charge_raw',_0x4185b3['status'],_0x24cf26,_0x3a04e0),loggerService_1['loggerService'][_0xa032aa(0x27f)](_0xa032aa(0x23f),_0xa032aa(0x2a8),'HTTP\x20'+_0x4185b3['status']+':\x20'+_0x24cf26);throw new Error(_0xa032aa(0x29c)+_0x4185b3[_0xa032aa(0x20a)]+_0xa032aa(0x2c0)+_0x24cf26);}const _0x352015=await _0x4185b3[_0xa032aa(0x298)]();loggerService_1[_0xa032aa(0x214)][_0xa032aa(0x256)]('mastercard',_0xa032aa(0x284),_0x4185b3['status'],_0x352015,_0x3a04e0),console['log']('===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===');let _0x3d9f64=_0x352015;if(_0x352015[_0xa032aa(0x271)]&&_0x352015[_0xa032aa(0x2be)]&&_0x352015['sign']){console[_0xa032aa(0x247)]('🔐\x20Response\x20is\x20encrypted,\x20decrypting...');try{const _0x2933dc=await this[_0xa032aa(0x2a9)](_0x352015[_0xa032aa(0x271)],_0x352015[_0xa032aa(0x2be)]);_0x3d9f64=JSON['parse'](_0x2933dc),console[_0xa032aa(0x247)](_0xa032aa(0x252)),loggerService_1[_0xa032aa(0x214)][_0xa032aa(0x256)](_0xa032aa(0x23f),_0xa032aa(0x24b),_0x4185b3[_0xa032aa(0x20a)],_0x3d9f64,_0x3a04e0),console[_0xa032aa(0x247)](_0xa032aa(0x220));}catch(_0x1585ba){console[_0xa032aa(0x287)]('❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):',_0x1585ba),loggerService_1[_0xa032aa(0x214)][_0xa032aa(0x27f)](_0xa032aa(0x23f),_0xa032aa(0x2ac),'Decryption\x20failed:\x20'+_0x1585ba),_0x3d9f64=_0x352015;}}else loggerService_1[_0xa032aa(0x214)]['logWhiteDomainResponse'](_0xa032aa(0x23f),_0xa032aa(0x24b),_0x4185b3[_0xa032aa(0x20a)],_0x3d9f64,_0x3a04e0),console['log'](_0xa032aa(0x270));console[_0xa032aa(0x247)](_0xa032aa(0x239),_0x3d9f64[_0xa032aa(0x20a)]),console['log'](_0xa032aa(0x290),_0x3d9f64[_0xa032aa(0x203)]),console[_0xa032aa(0x247)](_0xa032aa(0x28e),_0x3d9f64[_0xa032aa(0x29d)]),console['log'](_0xa032aa(0x2cf),_0x3d9f64[_0xa032aa(0x20b)]||'none');if(_0x3d9f64['status']===0x64&&_0x3d9f64['final']===0x1)return console[_0xa032aa(0x247)](_0xa032aa(0x28f)),{'gateway_payment_id':_0x3d9f64[_0xa032aa(0x29d)]?.[_0xa032aa(0x224)](),'payment_url':_0xb81ace,'requires_3ds':![],'status':'PAID','final':!![]};if(_0x3d9f64[_0xa032aa(0x20b)])return console[_0xa032aa(0x247)](_0xa032aa(0x20d)),this[_0xa032aa(0x1fc)](_0x1f29da,_0x17745b,_0x3d9f64[_0xa032aa(0x29d)]?.[_0xa032aa(0x224)]()||_0x17745b),{'gateway_payment_id':_0x3d9f64[_0xa032aa(0x29d)]?.[_0xa032aa(0x224)](),'payment_url':_0x3d9f64['3ds_url'],'requires_3ds':!![],'threeds_url':_0x3d9f64[_0xa032aa(0x20b)],'status':'PENDING','final':![]};let _0x171d9b=_0x3d9f64[_0xa032aa(0x2d6)]||_0x3d9f64[_0xa032aa(0x237)]||_0xa032aa(0x22e),_0x59dae5=_0x3d9f64[_0xa032aa(0x20a)],_0x344e0e=_0x3d9f64[_0xa032aa(0x203)];return console['log']('❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20'+_0x59dae5+_0xa032aa(0x24e)+_0x344e0e+_0xa032aa(0x206)+_0x171d9b),{'gateway_payment_id':_0x3d9f64['payment_id']?.['toString'](),'payment_url':_0xb81ace,'requires_3ds':![],'status':_0xa032aa(0x255),'final':!![]};}catch(_0x1b42c1){console[_0xa032aa(0x287)](_0xa032aa(0x2a1)),console['error']('Error\x20details:',_0x1b42c1),loggerService_1[_0xa032aa(0x214)][_0xa032aa(0x27f)]('mastercard',_0xa032aa(0x2a8),_0x1b42c1);throw new Error(_0xa032aa(0x2c1)+(_0x1b42c1 instanceof Error?_0x1b42c1[_0xa032aa(0x237)]:_0xa032aa(0x22e)));}}async[a42_0xab5c90(0x1fa)](_0x2f114a,_0x54d40b){const _0x5d3edd=a42_0xab5c90;console[_0x5d3edd(0x247)](_0x5d3edd(0x1fe)+_0x2f114a+'\x20('+_0x54d40b+')');try{const _0x528d2b={'payment_id':_0x2f114a,'order_id':_0x54d40b},_0xdb1c5b=JSON[_0x5d3edd(0x2c6)](_0x528d2b),{key:_0x308ba6,iv:_0x471780}=this[_0x5d3edd(0x2d5)](),_0xdfc6aa=this['encryptAES'](_0xdb1c5b,_0x308ba6,_0x471780),_0x6b7927=this[_0x5d3edd(0x2ad)](_0x308ba6,_0x471780),_0x2ca133=this[_0x5d3edd(0x25a)](_0xdb1c5b),_0x3ca371={'merchant_point_id':this[_0x5d3edd(0x26e)],'method':'status','info':_0xdfc6aa,'key':_0x6b7927,'sign':_0x2ca133,'lang':'en'};loggerService_1[_0x5d3edd(0x214)][_0x5d3edd(0x251)](_0x5d3edd(0x23f),'/status',_0x5d3edd(0x211),{'merchant_point_id':this[_0x5d3edd(0x26e)],'method':'status','lang':'en'});const _0x5e22ac=Date['now'](),_0x2334ad=await fetch(this[_0x5d3edd(0x2bb)],{'method':_0x5d3edd(0x211),'headers':{'Content-Type':_0x5d3edd(0x1f3),'Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x3ca371)}),_0x3a1ed1=Date[_0x5d3edd(0x2ab)]()-_0x5e22ac;if(!_0x2334ad['ok']){const _0x35713c=await _0x2334ad[_0x5d3edd(0x2b5)]();loggerService_1[_0x5d3edd(0x214)][_0x5d3edd(0x256)]('mastercard',_0x5d3edd(0x29f),_0x2334ad[_0x5d3edd(0x20a)],_0x35713c,_0x3a1ed1);throw new Error(_0x5d3edd(0x29c)+_0x2334ad[_0x5d3edd(0x20a)]);}const _0x1201f6=await _0x2334ad[_0x5d3edd(0x298)]();loggerService_1[_0x5d3edd(0x214)]['logWhiteDomainResponse']('mastercard',_0x5d3edd(0x29f),_0x2334ad[_0x5d3edd(0x20a)],_0x1201f6,_0x3a1ed1);let _0x1d3b16=_0x1201f6;if(_0x1201f6['info']&&_0x1201f6['key']&&_0x1201f6[_0x5d3edd(0x264)]){console[_0x5d3edd(0x247)](_0x5d3edd(0x292));try{const _0x499453=this[_0x5d3edd(0x2b0)](_0x1201f6['info'],_0x1201f6[_0x5d3edd(0x2be)]);_0x1d3b16=JSON[_0x5d3edd(0x2d0)](_0x499453),console[_0x5d3edd(0x247)](_0x5d3edd(0x228)),loggerService_1[_0x5d3edd(0x214)][_0x5d3edd(0x256)](_0x5d3edd(0x23f),_0x5d3edd(0x1f5),_0x2334ad[_0x5d3edd(0x20a)],_0x1d3b16,_0x3a1ed1),console['log'](_0x5d3edd(0x204));}catch(_0x308f31){console[_0x5d3edd(0x287)](_0x5d3edd(0x1f2),_0x308f31),loggerService_1['loggerService']['logWhiteDomainError'](_0x5d3edd(0x23f),'/status_decrypt',_0x5d3edd(0x258)+_0x308f31),_0x1d3b16=_0x1201f6;}}else loggerService_1[_0x5d3edd(0x214)][_0x5d3edd(0x256)]('mastercard',_0x5d3edd(0x1f5),_0x2334ad['status'],_0x1d3b16,_0x3a1ed1),console[_0x5d3edd(0x247)](_0x5d3edd(0x29b));console[_0x5d3edd(0x247)](_0x5d3edd(0x293),{'status':_0x1d3b16['status'],'final':_0x1d3b16[_0x5d3edd(0x203)],'payment_id':_0x1d3b16['payment_id'],'desc':_0x1d3b16['desc']});let _0x310c84=_0x5d3edd(0x20c);if(_0x1d3b16[_0x5d3edd(0x20a)]===0x1&&_0x1d3b16[_0x5d3edd(0x203)]===0x1)_0x310c84=_0x5d3edd(0x285);else _0x1d3b16[_0x5d3edd(0x20a)]===0x0&&_0x1d3b16[_0x5d3edd(0x203)]===0x0?_0x310c84=_0x5d3edd(0x20c):_0x310c84=_0x5d3edd(0x255);return{'status':_0x310c84,'final':_0x1d3b16[_0x5d3edd(0x203)]===0x1,'amount':_0x1d3b16['amount'],'currency':_0x1d3b16[_0x5d3edd(0x21a)],'date_success':_0x1d3b16[_0x5d3edd(0x27d)],'description':_0x1d3b16[_0x5d3edd(0x2d6)]};}catch(_0x2a1eeb){console[_0x5d3edd(0x287)]('MasterCard\x20status\x20check\x20error:',_0x2a1eeb),loggerService_1[_0x5d3edd(0x214)]['logWhiteDomainError']('mastercard','/status',_0x2a1eeb);throw new Error(_0x5d3edd(0x28b)+(_0x2a1eeb instanceof Error?_0x2a1eeb[_0x5d3edd(0x237)]:_0x5d3edd(0x22e)));}}[a42_0xab5c90(0x1fc)](_0x420029,_0x4a499c,_0x5eceb8){const _0x49206d=a42_0xab5c90;console[_0x49206d(0x247)](_0x49206d(0x296)+_0x420029+'\x20('+_0x5eceb8+')'),this[_0x49206d(0x1f7)](_0x420029);const _0x2ced6c=[],_0xb2942=0x5*0x3c*0x3e8,_0x1e9984=0x2*0x3c*0x3c*0x3e8,_0x7f329d=Math['floor'](_0x1e9984/_0xb2942);console[_0x49206d(0x247)](_0x49206d(0x1ed)+_0x7f329d+_0x49206d(0x217));for(let _0x11c701=0x1;_0x11c701<=_0x7f329d;_0x11c701++){const _0x48f192=setTimeout(async()=>{const _0x567940=_0x49206d;console[_0x567940(0x247)](_0x567940(0x2ae)+_0x11c701+'/'+_0x7f329d+_0x567940(0x1ec)+_0x420029);try{const _0x2ec43f=await this[_0x567940(0x1fa)](_0x5eceb8,_0x4a499c);console['log']('📊\x20Status\x20check\x20#'+_0x11c701+'\x20result:',_0x2ec43f),_0x2ec43f[_0x567940(0x203)]&&(console[_0x567940(0x247)](_0x567940(0x259)+_0x420029+_0x567940(0x23e)+_0x2ec43f['status']+_0x567940(0x22d)),this[_0x567940(0x1f7)](_0x420029),await this['updatePaymentStatus'](_0x420029,_0x2ec43f['status'],_0x2ec43f));}catch(_0xce5234){console[_0x567940(0x287)]('❌\x20Status\x20check\x20#'+_0x11c701+'\x20failed\x20for\x20payment\x20'+_0x420029+':',_0xce5234);}},_0x11c701*_0xb2942);_0x2ced6c[_0x49206d(0x2a7)](_0x48f192);}this[_0x49206d(0x213)][_0x49206d(0x2d1)](_0x420029,_0x2ced6c),console['log']('✅\x20Scheduled\x20'+_0x7f329d+_0x49206d(0x22b)+_0x420029);}[a42_0xab5c90(0x1f7)](_0x5a3d58){const _0x402b5c=a42_0xab5c90,_0x30bf07=this['statusCheckTimers'][_0x402b5c(0x238)](_0x5a3d58);_0x30bf07&&(console[_0x402b5c(0x247)](_0x402b5c(0x266)+_0x30bf07[_0x402b5c(0x26f)]+'\x20status\x20timers\x20for\x20payment\x20'+_0x5a3d58),_0x30bf07[_0x402b5c(0x269)]((_0x5101da,_0x164a01)=>{clearTimeout(_0x5101da);}),this[_0x402b5c(0x213)][_0x402b5c(0x234)](_0x5a3d58));}async[a42_0xab5c90(0x253)](_0x1f0d8c,_0x1531bc,_0x4dd162){const _0x1a51dc=a42_0xab5c90;try{const _0x20c513=(await Promise['resolve']()[_0x1a51dc(0x225)](()=>__importStar(require('../../config/database'))))[_0x1a51dc(0x23a)],_0x379f21={'status':_0x1531bc[_0x1a51dc(0x24f)](),'updatedAt':new Date(),'statusChangedBy':_0x1a51dc(0x2c9),'statusChangedAt':new Date()};_0x1531bc===_0x1a51dc(0x285)&&(_0x379f21['paidAt']=new Date()),_0x4dd162['description']&&(_0x379f21[_0x1a51dc(0x2bf)]='MasterCard:\x20'+_0x4dd162[_0x1a51dc(0x26a)]),await _0x20c513['payment'][_0x1a51dc(0x29a)]({'where':{'id':_0x1f0d8c},'data':_0x379f21}),console[_0x1a51dc(0x247)](_0x1a51dc(0x259)+_0x1f0d8c+'\x20status\x20updated\x20to\x20'+_0x1531bc),await this[_0x1a51dc(0x2c5)](_0x1f0d8c,_0x1531bc);}catch(_0x7d4c14){console['error']('❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20'+_0x1f0d8c+':',_0x7d4c14);}}async[a42_0xab5c90(0x2c5)](_0x3e16ac,_0x7739fe){const _0xfcbc0c=a42_0xab5c90;try{const _0x3fefe7=(await Promise[_0xfcbc0c(0x23c)]()[_0xfcbc0c(0x225)](()=>__importStar(require(_0xfcbc0c(0x2c2)))))[_0xfcbc0c(0x23a)],{telegramBotService:_0x4451a2}=await Promise['resolve']()[_0xfcbc0c(0x225)](()=>__importStar(require(_0xfcbc0c(0x25b)))),_0x47c428=await _0x3fefe7[_0xfcbc0c(0x243)][_0xfcbc0c(0x295)]({'where':{'id':_0x3e16ac},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x47c428)return;const _0xbeda1a={'PAID':'paid','FAILED':'failed'},_0x414bfc=_0xbeda1a[_0x7739fe];_0x414bfc&&await _0x4451a2[_0xfcbc0c(0x2b2)](_0x47c428['shopId'],_0x47c428,_0x414bfc),await this[_0xfcbc0c(0x229)](_0x47c428,_0x7739fe);}catch(_0x49faed){console[_0xfcbc0c(0x287)](_0xfcbc0c(0x267),_0x49faed);}}async[a42_0xab5c90(0x229)](_0x38bda0,_0x1009cd){const _0x2daa72=a42_0xab5c90,_0x54b259=Date[_0x2daa72(0x2ab)]();try{const _0x5b0e64=_0x38bda0[_0x2daa72(0x1f4)],_0x3584bf=_0x5b0e64[_0x2daa72(0x25d)];if(!_0x3584bf?.[_0x2daa72(0x212)]){console[_0x2daa72(0x247)](_0x2daa72(0x262)+_0x5b0e64['id']);return;}const _0x5935e5=_0x1009cd===_0x2daa72(0x285)?_0x2daa72(0x27e):_0x2daa72(0x260);let _0x567468=[];if(_0x3584bf[_0x2daa72(0x28c)])try{_0x567468=Array['isArray'](_0x3584bf[_0x2daa72(0x28c)])?_0x3584bf['webhookEvents']:JSON[_0x2daa72(0x2d0)](_0x3584bf[_0x2daa72(0x28c)]);}catch(_0x221fb6){console[_0x2daa72(0x287)](_0x2daa72(0x207),_0x221fb6),_0x567468=[];}if(!_0x567468[_0x2daa72(0x257)](_0x5935e5)){console[_0x2daa72(0x247)](_0x2daa72(0x297)+_0x5935e5+'\x20not\x20enabled\x20for\x20shop\x20'+_0x5b0e64['id']);return;}const _0x56c01b={'event':_0x5935e5,'payment':{'id':_0x38bda0['id'],'order_id':_0x38bda0[_0x2daa72(0x227)],'gateway_order_id':_0x38bda0['gatewayOrderId'],'gateway':_0x2daa72(0x2ba),'amount':_0x38bda0['amount'],'currency':_0x38bda0[_0x2daa72(0x21a)],'status':_0x1009cd['toLowerCase'](),'customer_email':_0x38bda0[_0x2daa72(0x26b)],'customer_name':_0x38bda0[_0x2daa72(0x201)],'created_at':_0x38bda0[_0x2daa72(0x2cb)],'updated_at':new Date()}},_0xa8ed14=await fetch(_0x3584bf[_0x2daa72(0x212)],{'method':'POST','headers':{'Content-Type':_0x2daa72(0x1f3),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON['stringify'](_0x56c01b)}),_0x1bfca6=Date[_0x2daa72(0x2ab)]()-_0x54b259;loggerService_1[_0x2daa72(0x214)][_0x2daa72(0x281)](_0x38bda0[_0x2daa72(0x242)],_0x3584bf[_0x2daa72(0x212)],_0x5935e5,_0xa8ed14[_0x2daa72(0x20a)],_0x1bfca6,_0x56c01b),console['log']('MasterCard\x20webhook\x20sent\x20to\x20'+_0x3584bf['webhookUrl']+'\x20with\x20status\x20'+_0xa8ed14[_0x2daa72(0x20a)]+'\x20('+_0x1bfca6+_0x2daa72(0x288));}catch(_0x4b09d3){console['error'](_0x2daa72(0x263),_0x4b09d3),loggerService_1[_0x2daa72(0x214)][_0x2daa72(0x2c7)](_0x38bda0[_0x2daa72(0x242)],_0x38bda0['shop']?.['settings']?.[_0x2daa72(0x212)]||_0x2daa72(0x28d),_0x2daa72(0x1f6),_0x4b09d3,{});}}[a42_0xab5c90(0x2d8)](_0x4323f3){const _0x309f7b=a42_0xab5c90,_0x3370ed=_0x4323f3[_0x309f7b(0x2bc)](/[\s-]/g,'');if(_0x3370ed[_0x309f7b(0x26f)]<0x4)return'****';return _0x309f7b(0x24c)+_0x3370ed[_0x309f7b(0x216)](-0x4);}async['processWebhook'](_0x820e56){const _0x537ba7=a42_0xab5c90;console[_0x537ba7(0x247)](_0x537ba7(0x236),_0x820e56);let _0x2ca78e=_0x537ba7(0x20c);if(_0x820e56[_0x537ba7(0x20a)]===0x1&&_0x820e56[_0x537ba7(0x203)]===0x1)_0x2ca78e='PAID';else _0x820e56[_0x537ba7(0x20a)]===0x0&&_0x820e56[_0x537ba7(0x203)]===0x0?_0x2ca78e='PENDING':_0x2ca78e='FAILED';return{'paymentId':_0x820e56[_0x537ba7(0x20e)]||'','status':_0x2ca78e,'amount':_0x820e56['amount'],'currency':_0x820e56[_0x537ba7(0x21a)]};}['stopAllStatusChecks'](){const _0x2f2bb7=a42_0xab5c90;console['log'](_0x2f2bb7(0x289));const _0x279f16=this['statusCheckTimers'][_0x2f2bb7(0x278)];for(const [_0x5e66d8]of this[_0x2f2bb7(0x213)]){this['clearStatusTimers'](_0x5e66d8);}console[_0x2f2bb7(0x247)](_0x2f2bb7(0x286)+_0x279f16+_0x2f2bb7(0x1ff));}}exports[a42_0xab5c90(0x27a)]=MasterCardService;