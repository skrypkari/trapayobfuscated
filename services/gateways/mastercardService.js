'use strict';const a42_0x58eb60=a42_0x4ba4;function a42_0x545b(){const _0x2a6ac4=['Status:','20095ADGGwr','\x20failed\x20for\x20payment\x20','✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)',',\x20body:\x20','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','gatewayOrderId','510YxFEYQ','prototype','parse','6890GWdrgT','POST','📝\x20Data\x20length:','description','number','/charge_decrypt','🔐\x20Data\x20signed\x20with\x20RSA','Unknown\x20error','/status','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','MasterCard\x20status\x20check\x20error:','Failed\x20to\x20send\x20MasterCard\x20webhook:','Public\x20key\x20file\x20not\x20found:\x20','join','toLowerCase','mastercard','Processing\x20MasterCard\x20webhook:','charge','❌\x20Failed\x20to\x20decrypt\x20status\x20response:','🧹\x20Clearing\x20','❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20','set','Status\x20decryption\x20failed:\x20','sendShopWebhook','3ds_url','logShopWebhookError','currency','then','\x20not\x20enabled\x20for\x20shop\x20','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20','forEach','readFileSync','3DS\x20URL:','existsSync','Payment\x20ID:','length','getOwnPropertyDescriptor','amount','merchantPointId','618fKNQVO','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','HTTP\x20','key','1111','/charge_decrypted','updatePaymentStatus','🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA','message','apiUrl','processWebhook','generateAESKey','log','shopId','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','webhookEvents','🔐\x20Private\x20key\x20length:\x20','crypto','get','defineProperty','Failed\x20to\x20send\x20payment\x20notifications:','customerEmail','maskCardNumber','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','Failed\x20to\x20decrypt\x20response\x20via\x20PHP','477921DYSTGs','size','toUpperCase','shop','\x20for\x20payment\x20','✅\x20Payment\x20','end','orderId','📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','createSign','privateKeyPath','Response\x20Body:','✅\x20Status\x20response\x20decrypted\x20successfully','create','payment_id','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','❌\x20RSA\x20signing\x20failed:','\x20\x20\x20-\x20sign\x20length:','decryptResponse','🔐\x20RSA\x20signing\x20successful','clearStatusTimers','🔐\x20AES\x20IV\x20length:','__importDefault','FAILED','processCardPayment','replace','private.pem','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20===','includes','HTTP\x20Status:','status','../../config/database','4212268eedfpl','webhookUrl','Order\x20ID:','delete','****\x20****\x20****\x20','loggerService','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','validateKeyFiles','RSA_PKCS1_PADDING','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','Decryption\x20failed:\x20','PAID','✅\x20Scheduled\x20','MasterCardService','__importStar','payment','MasterCard\x20webhook\x20sent\x20to\x20','paid','stopAllStatusChecks','/status_decrypted','base64','info','❌\x20PHP\x20decryptor\x20request\x20failed:','📝\x20Final\x20request\x20structure:','✅\x20Payment\x20successful','****','payment.failed','adminNotes','\x20\x20\x20-\x20info\x20length:','trim','isArray','paidAt','📝\x20Encrypted\x20key\x20length:','-----BEGIN','PENDING','Card\x20Holder:','substring','logWhiteDomainError','__esModule','/charge_raw','/status_raw','sign','Error\x20details:','logShopWebhookSent','4012solmXm',',\x20Desc:\x20','statusCheckTimers','🔐\x203DS\x20verification\x20required','logWhiteDomainRequest','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','\x20result:','📝\x20Data\x20to\x20sign\x20length:','resolve','json','🔐\x20Data\x20encrypted\x20with\x20AES','getOwnPropertyNames','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','path',',\x20Final:\x20','../loggerService','findUnique','sendPaymentNotifications','\x20characters','encryptAES','createDecipheriv','aes-256-ctr','call','toString','decryptAES','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','\x20status\x20timers\x20for\x20payment\x20','error','from','🔐\x20Public\x20key\x20path:','privateDecrypt','❌\x20Status\x20check\x20#','❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','MasterCard:\x20','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','update','\x20\x20\x20-\x20key\x20length:','🔐\x20AES\x20key\x20length:','__createBinding','HTTP\x20error!\x20status:\x20','date_success','settings','-----END','desc','📝\x20Signature\x20length:','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','decryptResponsePhp','logWhiteDomainResponse','text','floor','signRSA','publicEncrypt','final','❌\x20MasterCard\x20key\x20validation\x20failed:','Amount:','customerName','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','TesSoft\x20Payment\x20System/1.0','first_name','27785252xuKatP','system','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','91YwhnAl','publicKeyPath','now','last_name','14589lVpFma','stringify','checkPaymentStatus','writable','default','Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20','encryptRSA','\x20\x20\x20-\x20lang:\x20en','🔐\x20AES\x20key\x20and\x20IV\x20generated','\x20with\x20status\x20','configurable','expire_month','psp_public.pem','utf8','468616aSjUWX','),\x20stopping\x20status\x20checks','expire_year','\x20MasterCard\x20status\x20check\x20timers','randomBytes','Return\x20URL:','createCipheriv','scheduleStatusChecks','📝\x20Encrypted\x20data\x20length:','application/json','push','cwd','Failed\x20to\x20decrypt\x20response','https://api.paydmeth.com/api','\x20status\x20checks\x20for\x20payment\x20'];a42_0x545b=function(){return _0x2a6ac4;};return a42_0x545b();}function a42_0x4ba4(_0x56b4d9,_0xb527e4){const _0x545be7=a42_0x545b();return a42_0x4ba4=function(_0x4ba4af,_0x45755d){_0x4ba4af=_0x4ba4af-0x177;let _0x56d988=_0x545be7[_0x4ba4af];return _0x56d988;},a42_0x4ba4(_0x56b4d9,_0xb527e4);}(function(_0xabef0e,_0x5288eb){const _0x2e181e=a42_0x4ba4,_0x1e7861=_0xabef0e();while(!![]){try{const _0x7e2176=-parseInt(_0x2e181e(0x200))/0x1+-parseInt(_0x2e181e(0x24d))/0x2*(-parseInt(_0x2e181e(0x1bc))/0x3)+-parseInt(_0x2e181e(0x221))/0x4+-parseInt(_0x2e181e(0x1b6))/0x5*(parseInt(_0x2e181e(0x1e6))/0x6)+parseInt(_0x2e181e(0x194))/0x7*(parseInt(_0x2e181e(0x1a6))/0x8)+-parseInt(_0x2e181e(0x198))/0x9*(parseInt(_0x2e181e(0x1bf))/0xa)+parseInt(_0x2e181e(0x191))/0xb;if(_0x7e2176===_0x5288eb)break;else _0x1e7861['push'](_0x1e7861['shift']());}catch(_0x3814a6){_0x1e7861['push'](_0x1e7861['shift']());}}}(a42_0x545b,0x8a56f));var __createBinding=this&&this[a42_0x58eb60(0x17c)]||(Object['create']?function(_0x26d2c0,_0x2436c1,_0x27de86,_0x1f272c){const _0x24d11e=a42_0x58eb60;if(_0x1f272c===undefined)_0x1f272c=_0x27de86;var _0x157f86=Object[_0x24d11e(0x1e3)](_0x2436c1,_0x27de86);(!_0x157f86||(_0x24d11e(0x1f9)in _0x157f86?!_0x2436c1[_0x24d11e(0x247)]:_0x157f86[_0x24d11e(0x19b)]||_0x157f86[_0x24d11e(0x1a2)]))&&(_0x157f86={'enumerable':!![],'get':function(){return _0x2436c1[_0x27de86];}}),Object[_0x24d11e(0x1fa)](_0x26d2c0,_0x1f272c,_0x157f86);}:function(_0x378cf7,_0x5a98a0,_0x31ecb4,_0x3b2501){if(_0x3b2501===undefined)_0x3b2501=_0x31ecb4;_0x378cf7[_0x3b2501]=_0x5a98a0[_0x31ecb4];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a42_0x58eb60(0x20d)]?function(_0x40eb47,_0x2d6098){const _0x917f14=a42_0x58eb60;Object[_0x917f14(0x1fa)](_0x40eb47,'default',{'enumerable':!![],'value':_0x2d6098});}:function(_0x3bc9b8,_0x254428){const _0x16f9be=a42_0x58eb60;_0x3bc9b8[_0x16f9be(0x19c)]=_0x254428;}),__importStar=this&&this[a42_0x58eb60(0x22f)]||(function(){var _0x94f7f7=function(_0x8b850d){const _0xef30b9=a42_0x4ba4;return _0x94f7f7=Object[_0xef30b9(0x258)]||function(_0x439c76){const _0x503e7f=_0xef30b9;var _0x1bbd13=[];for(var _0x39a902 in _0x439c76)if(Object[_0x503e7f(0x1bd)]['hasOwnProperty'][_0x503e7f(0x263)](_0x439c76,_0x39a902))_0x1bbd13[_0x1bbd13[_0x503e7f(0x1e2)]]=_0x39a902;return _0x1bbd13;},_0x94f7f7(_0x8b850d);};return function(_0x130879){const _0x17d97d=a42_0x4ba4;if(_0x130879&&_0x130879[_0x17d97d(0x247)])return _0x130879;var _0x2d256c={};if(_0x130879!=null){for(var _0x342696=_0x94f7f7(_0x130879),_0x251f8d=0x0;_0x251f8d<_0x342696[_0x17d97d(0x1e2)];_0x251f8d++)if(_0x342696[_0x251f8d]!==_0x17d97d(0x19c))__createBinding(_0x2d256c,_0x130879,_0x342696[_0x251f8d]);}return __setModuleDefault(_0x2d256c,_0x130879),_0x2d256c;};}()),__importDefault=this&&this[a42_0x58eb60(0x216)]||function(_0x29c0ad){return _0x29c0ad&&_0x29c0ad['__esModule']?_0x29c0ad:{'default':_0x29c0ad};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a42_0x58eb60(0x22e)]=void 0x0;const crypto_1=__importDefault(require(a42_0x58eb60(0x1f8))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0x58eb60(0x25a))),loggerService_1=require(a42_0x58eb60(0x25c));class MasterCardService{constructor(){const _0x13ab2a=a42_0x58eb60;this['statusCheckTimers']=new Map(),this[_0x13ab2a(0x1ef)]=_0x13ab2a(0x1b3),this[_0x13ab2a(0x1e5)]=0x67c,this[_0x13ab2a(0x20a)]=path_1[_0x13ab2a(0x19c)][_0x13ab2a(0x1cc)](process[_0x13ab2a(0x1b1)](),'keys',_0x13ab2a(0x21a)),this[_0x13ab2a(0x195)]=path_1[_0x13ab2a(0x19c)][_0x13ab2a(0x1cc)](process[_0x13ab2a(0x1b1)](),'keys',_0x13ab2a(0x1a4)),console[_0x13ab2a(0x1f2)]('💳\x20MasterCard\x20service\x20initialized'),console[_0x13ab2a(0x1f2)]('🔐\x20Private\x20key\x20path:',this[_0x13ab2a(0x20a)]),console['log'](_0x13ab2a(0x26a),this[_0x13ab2a(0x195)]),this[_0x13ab2a(0x228)]();}[a42_0x58eb60(0x228)](){const _0x2bed81=a42_0x58eb60;try{if(!fs_1[_0x2bed81(0x19c)]['existsSync'](this[_0x2bed81(0x20a)]))throw new Error('Private\x20key\x20file\x20not\x20found:\x20'+this['privateKeyPath']);if(!fs_1['default'][_0x2bed81(0x1e0)](this[_0x2bed81(0x195)]))throw new Error(_0x2bed81(0x1cb)+this[_0x2bed81(0x195)]);const _0xc86282=fs_1[_0x2bed81(0x19c)][_0x2bed81(0x1de)](this[_0x2bed81(0x20a)],_0x2bed81(0x1a5))[_0x2bed81(0x23e)](),_0x5519cc=fs_1[_0x2bed81(0x19c)][_0x2bed81(0x1de)](this[_0x2bed81(0x195)],_0x2bed81(0x1a5))[_0x2bed81(0x23e)]();if(!_0xc86282[_0x2bed81(0x21d)](_0x2bed81(0x242))||!_0xc86282[_0x2bed81(0x21d)](_0x2bed81(0x180)))throw new Error(_0x2bed81(0x259));if(!_0x5519cc['includes'](_0x2bed81(0x242))||!_0x5519cc[_0x2bed81(0x21d)]('-----END'))throw new Error(_0x2bed81(0x266));console[_0x2bed81(0x1f2)](_0x2bed81(0x178)),console[_0x2bed81(0x1f2)](_0x2bed81(0x1f7)+_0xc86282[_0x2bed81(0x1e2)]+_0x2bed81(0x25f)),console[_0x2bed81(0x1f2)]('🔐\x20Public\x20key\x20length:\x20'+_0x5519cc['length']+_0x2bed81(0x25f));}catch(_0x22e88e){console[_0x2bed81(0x268)](_0x2bed81(0x18b),_0x22e88e);throw _0x22e88e;}}[a42_0x58eb60(0x1f1)](){const _0xeca8f6=a42_0x58eb60,_0x53958e=crypto_1[_0xeca8f6(0x19c)][_0xeca8f6(0x1aa)](0x20),_0x238bce=crypto_1[_0xeca8f6(0x19c)][_0xeca8f6(0x1aa)](0x10);return{'key':_0x53958e,'iv':_0x238bce};}['encryptAES'](_0xb91b39,_0x1a7d1b,_0x37f134){const _0x5e364d=a42_0x58eb60,_0x3ac784=crypto_1[_0x5e364d(0x19c)][_0x5e364d(0x1ac)]('aes-256-ctr',_0x1a7d1b,_0x37f134);let _0x3d7fc1=_0x3ac784['update'](_0xb91b39,_0x5e364d(0x1a5),_0x5e364d(0x235));return _0x3d7fc1+=_0x3ac784[_0x5e364d(0x18a)](_0x5e364d(0x235)),_0x3d7fc1;}[a42_0x58eb60(0x19e)](_0x551d4e,_0x3959f7){const _0x2c9997=a42_0x58eb60;try{const _0x42c61d=fs_1[_0x2c9997(0x19c)]['readFileSync'](this[_0x2c9997(0x195)],_0x2c9997(0x1a5))[_0x2c9997(0x23e)](),_0x63e6f8={'iv':_0x3959f7[_0x2c9997(0x264)](_0x2c9997(0x235)),'key':_0x551d4e['toString']('base64')},_0x5551fe=JSON[_0x2c9997(0x199)](_0x63e6f8);console[_0x2c9997(0x1f2)](_0x2c9997(0x252),_0x5551fe[_0x2c9997(0x1e2)]);const _0x37d034=crypto_1[_0x2c9997(0x19c)][_0x2c9997(0x189)]({'key':_0x42c61d,'padding':crypto_1[_0x2c9997(0x19c)]['constants'][_0x2c9997(0x229)]},Buffer['from'](_0x5551fe));return console[_0x2c9997(0x1f2)](_0x2c9997(0x183),_0x37d034[_0x2c9997(0x1e2)]),_0x37d034[_0x2c9997(0x264)](_0x2c9997(0x235));}catch(_0x663318){console[_0x2c9997(0x268)]('❌\x20RSA\x20encryption\x20failed:',_0x663318);throw new Error(_0x2c9997(0x177));}}[a42_0x58eb60(0x188)](_0x6b0f95){const _0x33ef97=a42_0x58eb60;try{const _0x152cbf=fs_1[_0x33ef97(0x19c)]['readFileSync'](this[_0x33ef97(0x20a)],_0x33ef97(0x1a5))[_0x33ef97(0x23e)](),_0x26804e=crypto_1[_0x33ef97(0x19c)][_0x33ef97(0x209)]('SHA256');_0x26804e[_0x33ef97(0x179)](_0x6b0f95),_0x26804e[_0x33ef97(0x206)]();const _0x43771b=_0x26804e['sign'](_0x152cbf,_0x33ef97(0x235));return console[_0x33ef97(0x1f2)](_0x33ef97(0x213)),console[_0x33ef97(0x1f2)](_0x33ef97(0x254),_0x6b0f95[_0x33ef97(0x1e2)]),console[_0x33ef97(0x1f2)]('📝\x20Signature\x20length:',_0x43771b[_0x33ef97(0x1e2)]),_0x43771b;}catch(_0x30a9ea){console[_0x33ef97(0x268)](_0x33ef97(0x210),_0x30a9ea),console['error']('❌\x20Data\x20being\x20signed:',_0x6b0f95[_0x33ef97(0x245)](0x0,0xc8)+'...');throw new Error(_0x33ef97(0x26e));}}[a42_0x58eb60(0x265)](_0x39503a,_0x40f1dc,_0xd7f5ec){const _0x55fc96=a42_0x58eb60,_0x285841=crypto_1[_0x55fc96(0x19c)][_0x55fc96(0x261)](_0x55fc96(0x262),_0x40f1dc,_0xd7f5ec);let _0x2410bc=_0x285841[_0x55fc96(0x179)](_0x39503a,_0x55fc96(0x235),_0x55fc96(0x1a5));return _0x2410bc+=_0x285841['final']('utf8'),_0x2410bc;}async[a42_0x58eb60(0x184)](_0x190477,_0x525869){const _0x2f36c8=a42_0x58eb60;try{const _0x98fc0d=await fetch('https://api2.trapay.uk/decrypt.php',{'method':_0x2f36c8(0x1c0),'headers':{'Content-Type':_0x2f36c8(0x1af)},'body':JSON[_0x2f36c8(0x199)]({'info':_0x190477,'key':_0x525869})});if(!_0x98fc0d['ok'])throw new Error('PHP\x20decryptor\x20error');return await _0x98fc0d[_0x2f36c8(0x186)]();}catch(_0x361c24){console[_0x2f36c8(0x268)](_0x2f36c8(0x237),_0x361c24);throw new Error(_0x2f36c8(0x1ff));}}[a42_0x58eb60(0x212)](_0x1f108d,_0x243bb6){const _0x3c3101=a42_0x58eb60;try{const _0x4aec6c=fs_1[_0x3c3101(0x19c)]['readFileSync'](this['privateKeyPath'],_0x3c3101(0x1a5))[_0x3c3101(0x23e)](),_0x5c12c9=crypto_1['default'][_0x3c3101(0x26b)](_0x4aec6c,Buffer[_0x3c3101(0x269)](_0x243bb6,'base64')),_0x544dde=JSON[_0x3c3101(0x1be)](_0x5c12c9[_0x3c3101(0x264)]()),_0x412eac=Buffer[_0x3c3101(0x269)](_0x544dde['key'],'base64'),_0x2bcb71=Buffer[_0x3c3101(0x269)](_0x544dde['iv'],_0x3c3101(0x235));return this[_0x3c3101(0x265)](_0x1f108d,_0x412eac,_0x2bcb71);}catch(_0xf84559){throw new Error(_0x3c3101(0x1b2));}}async[a42_0x58eb60(0x218)](_0x16b7f5){const _0x576f15=a42_0x58eb60,{paymentId:_0x48bac6,orderId:_0x78bfca,amount:_0x4bb1f8,currency:_0x3bf890,cardData:_0x130424,resultUrl:_0x4fc180,returnUrl:_0x158c26,cardHolder:_0x5f5407,browser:_0x3eba79}=_0x16b7f5;console[_0x576f15(0x1f2)](_0x576f15(0x21c)),console[_0x576f15(0x1f2)](_0x576f15(0x1e1),_0x48bac6),console['log'](_0x576f15(0x223),_0x78bfca),console['log'](_0x576f15(0x18c),_0x4bb1f8,_0x3bf890),console[_0x576f15(0x1f2)]('Card\x20Number:',this['maskCardNumber'](_0x130424[_0x576f15(0x1c3)])),console[_0x576f15(0x1f2)](_0x576f15(0x244),_0x5f5407[_0x576f15(0x190)]+'\x20'+_0x5f5407[_0x576f15(0x197)]),console[_0x576f15(0x1f2)](_0x576f15(0x1ab),_0x158c26),console['log']('Result\x20URL:',_0x4fc180);const _0x1a822b={'amount':_0x4bb1f8,'currency':_0x3bf890[_0x576f15(0x202)](),'order_id':_0x78bfca,'result_url':_0x4fc180,'return_url':_0x158c26,'card':{'number':_0x130424[_0x576f15(0x1c3)],'expire_month':_0x130424[_0x576f15(0x1a3)],'expire_year':_0x130424[_0x576f15(0x1a8)],'cvv':_0x130424['cvv']},'card_holder':_0x5f5407,'browser':_0x3eba79},_0x55c93b=JSON[_0x576f15(0x199)](_0x1a822b);console[_0x576f15(0x1f2)]('💾\x20Payment\x20data\x20prepared'),console[_0x576f15(0x1f2)](_0x576f15(0x18e)),console[_0x576f15(0x1f2)](_0x55c93b),console[_0x576f15(0x1f2)](_0x576f15(0x1c1),_0x55c93b[_0x576f15(0x1e2)]);try{const {key:_0x560ac7,iv:_0x27b823}=this[_0x576f15(0x1f1)]();console[_0x576f15(0x1f2)](_0x576f15(0x1a0)),console['log'](_0x576f15(0x17b),_0x560ac7[_0x576f15(0x1e2)]),console['log'](_0x576f15(0x215),_0x27b823[_0x576f15(0x1e2)]);const _0x26a6cb=this[_0x576f15(0x260)](_0x55c93b,_0x560ac7,_0x27b823);console[_0x576f15(0x1f2)](_0x576f15(0x257)),console[_0x576f15(0x1f2)](_0x576f15(0x1ae),_0x26a6cb[_0x576f15(0x1e2)]);const _0x25416d=this[_0x576f15(0x19e)](_0x560ac7,_0x27b823);console[_0x576f15(0x1f2)](_0x576f15(0x1ed)),console['log'](_0x576f15(0x241),_0x25416d['length']);const _0x549b3d=this[_0x576f15(0x188)](_0x55c93b);console['log'](_0x576f15(0x1c5)),console['log'](_0x576f15(0x182),_0x549b3d[_0x576f15(0x1e2)]);const _0x31cbc1={'merchant_point_id':this[_0x576f15(0x1e5)],'method':_0x576f15(0x1d0),'info':_0x26a6cb,'key':_0x25416d,'sign':_0x549b3d,'lang':'en'};console['log'](_0x576f15(0x1e7)),console[_0x576f15(0x1f2)](_0x576f15(0x238)),console[_0x576f15(0x1f2)]('\x20\x20\x20-\x20merchant_point_id:',this[_0x576f15(0x1e5)]),console[_0x576f15(0x1f2)]('\x20\x20\x20-\x20method:\x20charge'),console['log'](_0x576f15(0x23d),_0x26a6cb[_0x576f15(0x1e2)]),console[_0x576f15(0x1f2)](_0x576f15(0x17a),_0x25416d[_0x576f15(0x1e2)]),console[_0x576f15(0x1f2)](_0x576f15(0x211),_0x549b3d['length']),console[_0x576f15(0x1f2)](_0x576f15(0x19f)),loggerService_1[_0x576f15(0x226)][_0x576f15(0x251)](_0x576f15(0x1ce),'/charge',_0x576f15(0x1c0),{'merchant_point_id':this[_0x576f15(0x1e5)],'method':_0x576f15(0x1d0),'lang':'en'});const _0x1ce639=Date[_0x576f15(0x196)](),_0xc4349a=await fetch(this['apiUrl'],{'method':_0x576f15(0x1c0),'headers':{'Content-Type':'application/json','Accept':_0x576f15(0x1af),'User-Agent':_0x576f15(0x18f)},'body':JSON[_0x576f15(0x199)](_0x31cbc1)}),_0x14e5a2=Date[_0x576f15(0x196)]()-_0x1ce639;console[_0x576f15(0x1f2)](_0x576f15(0x1f4)),console[_0x576f15(0x1f2)](_0x576f15(0x1b5),_0xc4349a['status']),console[_0x576f15(0x1f2)]('Response\x20Time:',_0x14e5a2+'ms');if(!_0xc4349a['ok']){const _0x12beac=await _0xc4349a[_0x576f15(0x186)]();console['error'](_0x576f15(0x21e),_0xc4349a[_0x576f15(0x21f)]),console['error'](_0x576f15(0x20b),_0x12beac),loggerService_1[_0x576f15(0x226)][_0x576f15(0x185)]('mastercard','/charge_raw',_0xc4349a['status'],_0x12beac,_0x14e5a2),loggerService_1[_0x576f15(0x226)][_0x576f15(0x246)](_0x576f15(0x1ce),'/charge',_0x576f15(0x1e8)+_0xc4349a[_0x576f15(0x21f)]+':\x20'+_0x12beac);throw new Error(_0x576f15(0x17d)+_0xc4349a[_0x576f15(0x21f)]+_0x576f15(0x1b9)+_0x12beac);}const _0x2ab81c=await _0xc4349a['json']();loggerService_1[_0x576f15(0x226)][_0x576f15(0x185)](_0x576f15(0x1ce),_0x576f15(0x248),_0xc4349a['status'],_0x2ab81c,_0x14e5a2),console['log']('===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===');let _0x57d12f=_0x2ab81c;if(_0x2ab81c[_0x576f15(0x236)]&&_0x2ab81c[_0x576f15(0x1e9)]&&_0x2ab81c[_0x576f15(0x24a)]){console[_0x576f15(0x1f2)](_0x576f15(0x1ba));try{const _0x53677f=await this[_0x576f15(0x184)](_0x2ab81c[_0x576f15(0x236)],_0x2ab81c[_0x576f15(0x1e9)]);_0x57d12f=JSON[_0x576f15(0x1be)](_0x53677f),console[_0x576f15(0x1f2)](_0x576f15(0x1b8)),loggerService_1['loggerService'][_0x576f15(0x185)](_0x576f15(0x1ce),_0x576f15(0x1eb),_0xc4349a[_0x576f15(0x21f)],_0x57d12f,_0x14e5a2),console[_0x576f15(0x1f2)](_0x576f15(0x193));}catch(_0x5932ef){console[_0x576f15(0x268)](_0x576f15(0x26d),_0x5932ef),loggerService_1[_0x576f15(0x226)]['logWhiteDomainError']('mastercard',_0x576f15(0x1c4),_0x576f15(0x22b)+_0x5932ef),_0x57d12f=_0x2ab81c;}}else loggerService_1[_0x576f15(0x226)]['logWhiteDomainResponse'](_0x576f15(0x1ce),_0x576f15(0x1eb),_0xc4349a[_0x576f15(0x21f)],_0x57d12f,_0x14e5a2),console[_0x576f15(0x1f2)]('📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted');console[_0x576f15(0x1f2)](_0x576f15(0x1b5),_0x57d12f[_0x576f15(0x21f)]),console['log']('Final:',_0x57d12f['final']),console[_0x576f15(0x1f2)]('Payment\x20ID:',_0x57d12f[_0x576f15(0x20e)]),console[_0x576f15(0x1f2)](_0x576f15(0x1df),_0x57d12f[_0x576f15(0x1d7)]||'none');if(_0x57d12f['status']===0x64&&_0x57d12f[_0x576f15(0x18a)]===0x1)return console[_0x576f15(0x1f2)](_0x576f15(0x239)),{'gateway_payment_id':_0x57d12f[_0x576f15(0x20e)]?.[_0x576f15(0x264)](),'payment_url':_0x158c26,'requires_3ds':![],'status':'PAID','final':!![]};if(_0x57d12f[_0x576f15(0x1d7)])return console[_0x576f15(0x1f2)](_0x576f15(0x250)),this[_0x576f15(0x1ad)](_0x48bac6,_0x78bfca,_0x57d12f[_0x576f15(0x20e)]?.[_0x576f15(0x264)]()||_0x78bfca),{'gateway_payment_id':_0x57d12f[_0x576f15(0x20e)]?.[_0x576f15(0x264)](),'payment_url':_0x57d12f[_0x576f15(0x1d7)],'requires_3ds':!![],'threeds_url':_0x57d12f[_0x576f15(0x1d7)],'status':_0x576f15(0x243),'final':![]};let _0x9e96eb=_0x57d12f[_0x576f15(0x181)]||_0x57d12f['message']||'Unknown\x20error',_0x445a5f=_0x57d12f[_0x576f15(0x21f)],_0x12e3eb=_0x57d12f['final'];return console[_0x576f15(0x1f2)](_0x576f15(0x1d3)+_0x445a5f+_0x576f15(0x25b)+_0x12e3eb+_0x576f15(0x24e)+_0x9e96eb),{'gateway_payment_id':_0x57d12f[_0x576f15(0x20e)]?.['toString'](),'payment_url':_0x158c26,'requires_3ds':![],'status':_0x576f15(0x217),'final':!![]};}catch(_0x40b542){console[_0x576f15(0x268)]('===\x20MASTERCARD\x20SERVICE\x20ERROR\x20==='),console[_0x576f15(0x268)](_0x576f15(0x24b),_0x40b542),loggerService_1[_0x576f15(0x226)][_0x576f15(0x246)]('mastercard','/charge',_0x40b542);throw new Error(_0x576f15(0x22a)+(_0x40b542 instanceof Error?_0x40b542[_0x576f15(0x1ee)]:_0x576f15(0x1c6)));}}async[a42_0x58eb60(0x19a)](_0x4e2208,_0xcc41a7){const _0x48cf84=a42_0x58eb60;console[_0x48cf84(0x1f2)](_0x48cf84(0x1c8)+_0x4e2208+'\x20('+_0xcc41a7+')');try{const _0x9eed28={'payment_id':_0x4e2208,'order_id':_0xcc41a7},_0x48a39f=JSON[_0x48cf84(0x199)](_0x9eed28),{key:_0x4d314b,iv:_0x471660}=this[_0x48cf84(0x1f1)](),_0x2c4bab=this[_0x48cf84(0x260)](_0x48a39f,_0x4d314b,_0x471660),_0x1e79ae=this[_0x48cf84(0x19e)](_0x4d314b,_0x471660),_0x134a33=this[_0x48cf84(0x188)](_0x48a39f),_0x3626c2={'merchant_point_id':this[_0x48cf84(0x1e5)],'method':_0x48cf84(0x21f),'info':_0x2c4bab,'key':_0x1e79ae,'sign':_0x134a33,'lang':'en'};loggerService_1[_0x48cf84(0x226)][_0x48cf84(0x251)](_0x48cf84(0x1ce),_0x48cf84(0x1c7),_0x48cf84(0x1c0),{'merchant_point_id':this[_0x48cf84(0x1e5)],'method':_0x48cf84(0x21f),'lang':'en'});const _0x4fc8dc=Date[_0x48cf84(0x196)](),_0xfa9698=await fetch(this[_0x48cf84(0x1ef)],{'method':_0x48cf84(0x1c0),'headers':{'Content-Type':_0x48cf84(0x1af),'Accept':_0x48cf84(0x1af),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x48cf84(0x199)](_0x3626c2)}),_0x5e16ef=Date[_0x48cf84(0x196)]()-_0x4fc8dc;if(!_0xfa9698['ok']){const _0x4c8a61=await _0xfa9698['text']();loggerService_1[_0x48cf84(0x226)][_0x48cf84(0x185)]('mastercard',_0x48cf84(0x249),_0xfa9698[_0x48cf84(0x21f)],_0x4c8a61,_0x5e16ef);throw new Error(_0x48cf84(0x17d)+_0xfa9698[_0x48cf84(0x21f)]);}const _0x2cc4e0=await _0xfa9698[_0x48cf84(0x256)]();loggerService_1[_0x48cf84(0x226)][_0x48cf84(0x185)](_0x48cf84(0x1ce),_0x48cf84(0x249),_0xfa9698[_0x48cf84(0x21f)],_0x2cc4e0,_0x5e16ef);let _0x424ef9=_0x2cc4e0;if(_0x2cc4e0[_0x48cf84(0x236)]&&_0x2cc4e0[_0x48cf84(0x1e9)]&&_0x2cc4e0[_0x48cf84(0x24a)]){console[_0x48cf84(0x1f2)](_0x48cf84(0x1f5));try{const _0x302e24=this[_0x48cf84(0x212)](_0x2cc4e0[_0x48cf84(0x236)],_0x2cc4e0[_0x48cf84(0x1e9)]);_0x424ef9=JSON[_0x48cf84(0x1be)](_0x302e24),console[_0x48cf84(0x1f2)](_0x48cf84(0x20c)),loggerService_1['loggerService'][_0x48cf84(0x185)]('mastercard','/status_decrypted',_0xfa9698[_0x48cf84(0x21f)],_0x424ef9,_0x5e16ef),console[_0x48cf84(0x1f2)](_0x48cf84(0x20f));}catch(_0x315173){console[_0x48cf84(0x268)](_0x48cf84(0x1d1),_0x315173),loggerService_1[_0x48cf84(0x226)][_0x48cf84(0x246)](_0x48cf84(0x1ce),'/status_decrypt',_0x48cf84(0x1d5)+_0x315173),_0x424ef9=_0x2cc4e0;}}else loggerService_1['loggerService'][_0x48cf84(0x185)]('mastercard',_0x48cf84(0x234),_0xfa9698[_0x48cf84(0x21f)],_0x424ef9,_0x5e16ef),console[_0x48cf84(0x1f2)](_0x48cf84(0x208));console['log']('📊\x20Status\x20check\x20result:',{'status':_0x424ef9[_0x48cf84(0x21f)],'final':_0x424ef9['final'],'payment_id':_0x424ef9[_0x48cf84(0x20e)],'desc':_0x424ef9['desc']});let _0x4dc516=_0x48cf84(0x243);if(_0x424ef9[_0x48cf84(0x21f)]===0x1&&_0x424ef9[_0x48cf84(0x18a)]===0x1)_0x4dc516=_0x48cf84(0x22c);else _0x424ef9[_0x48cf84(0x21f)]===0x0&&_0x424ef9[_0x48cf84(0x18a)]===0x0?_0x4dc516=_0x48cf84(0x243):_0x4dc516=_0x48cf84(0x217);return{'status':_0x4dc516,'final':_0x424ef9[_0x48cf84(0x18a)]===0x1,'amount':_0x424ef9['amount'],'currency':_0x424ef9[_0x48cf84(0x1d9)],'date_success':_0x424ef9[_0x48cf84(0x17e)],'description':_0x424ef9['desc']};}catch(_0x221fac){console['error'](_0x48cf84(0x1c9),_0x221fac),loggerService_1['loggerService'][_0x48cf84(0x246)](_0x48cf84(0x1ce),_0x48cf84(0x1c7),_0x221fac);throw new Error(_0x48cf84(0x19d)+(_0x221fac instanceof Error?_0x221fac[_0x48cf84(0x1ee)]:'Unknown\x20error'));}}['scheduleStatusChecks'](_0x35d997,_0x49302e,_0x450158){const _0x1d2488=a42_0x58eb60;console[_0x1d2488(0x1f2)]('⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20'+_0x35d997+'\x20('+_0x450158+')'),this['clearStatusTimers'](_0x35d997);const _0x20d56d=[],_0x91b617=0x5*0x3c*0x3e8,_0x5ec73f=0x2*0x3c*0x3c*0x3e8,_0xfe0c10=Math[_0x1d2488(0x187)](_0x5ec73f/_0x91b617);console[_0x1d2488(0x1f2)]('⏰\x20Will\x20check\x20status\x20'+_0xfe0c10+_0x1d2488(0x1fe));for(let _0x5027a7=0x1;_0x5027a7<=_0xfe0c10;_0x5027a7++){const _0x8d9c2a=setTimeout(async()=>{const _0x499657=_0x1d2488;console[_0x499657(0x1f2)]('🔍\x20MasterCard\x20status\x20check\x20#'+_0x5027a7+'/'+_0xfe0c10+_0x499657(0x204)+_0x35d997);try{const _0x28cef0=await this[_0x499657(0x19a)](_0x450158,_0x49302e);console[_0x499657(0x1f2)]('📊\x20Status\x20check\x20#'+_0x5027a7+_0x499657(0x253),_0x28cef0),_0x28cef0[_0x499657(0x18a)]&&(console[_0x499657(0x1f2)](_0x499657(0x205)+_0x35d997+'\x20is\x20final\x20('+_0x28cef0[_0x499657(0x21f)]+_0x499657(0x1a7)),this[_0x499657(0x214)](_0x35d997),await this['updatePaymentStatus'](_0x35d997,_0x28cef0[_0x499657(0x21f)],_0x28cef0));}catch(_0x3fa39f){console['error'](_0x499657(0x26c)+_0x5027a7+_0x499657(0x1b7)+_0x35d997+':',_0x3fa39f);}},_0x5027a7*_0x91b617);_0x20d56d[_0x1d2488(0x1b0)](_0x8d9c2a);}this[_0x1d2488(0x24f)][_0x1d2488(0x1d4)](_0x35d997,_0x20d56d),console[_0x1d2488(0x1f2)](_0x1d2488(0x22d)+_0xfe0c10+_0x1d2488(0x1b4)+_0x35d997);}[a42_0x58eb60(0x214)](_0x240c12){const _0x1c7311=a42_0x58eb60,_0x46d1f9=this['statusCheckTimers'][_0x1c7311(0x1f9)](_0x240c12);_0x46d1f9&&(console[_0x1c7311(0x1f2)](_0x1c7311(0x1d2)+_0x46d1f9[_0x1c7311(0x1e2)]+_0x1c7311(0x267)+_0x240c12),_0x46d1f9[_0x1c7311(0x1dd)]((_0x3b1eb6,_0x2ae149)=>{clearTimeout(_0x3b1eb6);}),this[_0x1c7311(0x24f)][_0x1c7311(0x224)](_0x240c12));}async[a42_0x58eb60(0x1ec)](_0x4f5d30,_0x2bcc11,_0x3f5f3d){const _0x120768=a42_0x58eb60;try{const _0x340726=(await Promise[_0x120768(0x255)]()[_0x120768(0x1da)](()=>__importStar(require(_0x120768(0x220)))))[_0x120768(0x19c)],_0x5ee24e={'status':_0x2bcc11[_0x120768(0x202)](),'updatedAt':new Date(),'statusChangedBy':_0x120768(0x192),'statusChangedAt':new Date()};_0x2bcc11===_0x120768(0x22c)&&(_0x5ee24e[_0x120768(0x240)]=new Date()),_0x3f5f3d[_0x120768(0x1c2)]&&(_0x5ee24e[_0x120768(0x23c)]=_0x120768(0x26f)+_0x3f5f3d[_0x120768(0x1c2)]),await _0x340726[_0x120768(0x230)]['update']({'where':{'id':_0x4f5d30},'data':_0x5ee24e}),console[_0x120768(0x1f2)](_0x120768(0x205)+_0x4f5d30+'\x20status\x20updated\x20to\x20'+_0x2bcc11),await this['sendPaymentNotifications'](_0x4f5d30,_0x2bcc11);}catch(_0x2d11c7){console[_0x120768(0x268)](_0x120768(0x1dc)+_0x4f5d30+':',_0x2d11c7);}}async[a42_0x58eb60(0x25e)](_0x5a0e06,_0x4b1386){const _0x2584b6=a42_0x58eb60;try{const _0x58436c=(await Promise[_0x2584b6(0x255)]()[_0x2584b6(0x1da)](()=>__importStar(require(_0x2584b6(0x220)))))[_0x2584b6(0x19c)],{telegramBotService:_0x4bae74}=await Promise[_0x2584b6(0x255)]()[_0x2584b6(0x1da)](()=>__importStar(require('../telegramBotService'))),_0x43d619=await _0x58436c[_0x2584b6(0x230)][_0x2584b6(0x25d)]({'where':{'id':_0x5a0e06},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x43d619)return;const _0x30cf97={'PAID':_0x2584b6(0x232),'FAILED':'failed'},_0x5b2a17=_0x30cf97[_0x4b1386];_0x5b2a17&&await _0x4bae74['sendPaymentNotification'](_0x43d619['shopId'],_0x43d619,_0x5b2a17),await this[_0x2584b6(0x1d6)](_0x43d619,_0x4b1386);}catch(_0x222f51){console['error'](_0x2584b6(0x1fb),_0x222f51);}}async[a42_0x58eb60(0x1d6)](_0xbaf9f3,_0x14becc){const _0x7e7f20=a42_0x58eb60,_0x1446ac=Date[_0x7e7f20(0x196)]();try{const _0x188a71=_0xbaf9f3[_0x7e7f20(0x203)],_0x35e17d=_0x188a71[_0x7e7f20(0x17f)];if(!_0x35e17d?.['webhookUrl']){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x188a71['id']);return;}const _0xe6f719=_0x14becc===_0x7e7f20(0x22c)?'payment.success':_0x7e7f20(0x23b);let _0x3b0573=[];if(_0x35e17d['webhookEvents'])try{_0x3b0573=Array[_0x7e7f20(0x23f)](_0x35e17d['webhookEvents'])?_0x35e17d[_0x7e7f20(0x1f6)]:JSON[_0x7e7f20(0x1be)](_0x35e17d[_0x7e7f20(0x1f6)]);}catch(_0x212d54){console[_0x7e7f20(0x268)]('Error\x20parsing\x20webhook\x20events:',_0x212d54),_0x3b0573=[];}if(!_0x3b0573['includes'](_0xe6f719)){console[_0x7e7f20(0x1f2)]('Webhook\x20event\x20'+_0xe6f719+_0x7e7f20(0x1db)+_0x188a71['id']);return;}const _0x429c4b={'event':_0xe6f719,'payment':{'id':_0xbaf9f3['id'],'order_id':_0xbaf9f3[_0x7e7f20(0x207)],'gateway_order_id':_0xbaf9f3[_0x7e7f20(0x1bb)],'gateway':_0x7e7f20(0x1ea),'amount':_0xbaf9f3[_0x7e7f20(0x1e4)],'currency':_0xbaf9f3[_0x7e7f20(0x1d9)],'status':_0x14becc[_0x7e7f20(0x1cd)](),'customer_email':_0xbaf9f3[_0x7e7f20(0x1fc)],'customer_name':_0xbaf9f3[_0x7e7f20(0x18d)],'created_at':_0xbaf9f3['createdAt'],'updated_at':new Date()}},_0x194156=await fetch(_0x35e17d[_0x7e7f20(0x222)],{'method':_0x7e7f20(0x1c0),'headers':{'Content-Type':_0x7e7f20(0x1af),'User-Agent':_0x7e7f20(0x227)},'body':JSON[_0x7e7f20(0x199)](_0x429c4b)}),_0xf1ebf2=Date[_0x7e7f20(0x196)]()-_0x1446ac;loggerService_1[_0x7e7f20(0x226)][_0x7e7f20(0x24c)](_0xbaf9f3[_0x7e7f20(0x1f3)],_0x35e17d['webhookUrl'],_0xe6f719,_0x194156['status'],_0xf1ebf2,_0x429c4b),console['log'](_0x7e7f20(0x231)+_0x35e17d[_0x7e7f20(0x222)]+_0x7e7f20(0x1a1)+_0x194156[_0x7e7f20(0x21f)]+'\x20('+_0xf1ebf2+'ms)');}catch(_0x229431){console['error'](_0x7e7f20(0x1ca),_0x229431),loggerService_1[_0x7e7f20(0x226)][_0x7e7f20(0x1d8)](_0xbaf9f3[_0x7e7f20(0x1f3)],_0xbaf9f3[_0x7e7f20(0x203)]?.[_0x7e7f20(0x17f)]?.[_0x7e7f20(0x222)]||'unknown','webhook_send',_0x229431,{});}}[a42_0x58eb60(0x1fd)](_0x4f0fd1){const _0x348e15=a42_0x58eb60,_0x3aa09b=_0x4f0fd1[_0x348e15(0x219)](/[\s-]/g,'');if(_0x3aa09b[_0x348e15(0x1e2)]<0x4)return _0x348e15(0x23a);return _0x348e15(0x225)+_0x3aa09b['slice'](-0x4);}async[a42_0x58eb60(0x1f0)](_0x2bf63f){const _0x1dd833=a42_0x58eb60;console[_0x1dd833(0x1f2)](_0x1dd833(0x1cf),_0x2bf63f);let _0x37d69b='PENDING';if(_0x2bf63f[_0x1dd833(0x21f)]===0x1&&_0x2bf63f[_0x1dd833(0x18a)]===0x1)_0x37d69b=_0x1dd833(0x22c);else _0x2bf63f[_0x1dd833(0x21f)]===0x0&&_0x2bf63f[_0x1dd833(0x18a)]===0x0?_0x37d69b='PENDING':_0x37d69b=_0x1dd833(0x217);return{'paymentId':_0x2bf63f['order_id']||'','status':_0x37d69b,'amount':_0x2bf63f[_0x1dd833(0x1e4)],'currency':_0x2bf63f[_0x1dd833(0x1d9)]};}[a42_0x58eb60(0x233)](){const _0x4ba824=a42_0x58eb60;console[_0x4ba824(0x1f2)](_0x4ba824(0x21b));const _0x30c671=this['statusCheckTimers'][_0x4ba824(0x201)];for(const [_0x5e4464]of this['statusCheckTimers']){this[_0x4ba824(0x214)](_0x5e4464);}console[_0x4ba824(0x1f2)]('🛑\x20Stopped\x20'+_0x30c671+_0x4ba824(0x1a9));}}exports[a42_0x58eb60(0x22e)]=MasterCardService;