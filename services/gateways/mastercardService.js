'use strict';const a42_0x593a7d=a42_0xa983;(function(_0x3ab083,_0x42bec1){const _0x2a4fe8=a42_0xa983,_0x287d61=_0x3ab083();while(!![]){try{const _0x118817=-parseInt(_0x2a4fe8(0x186))/0x1*(-parseInt(_0x2a4fe8(0x16a))/0x2)+parseInt(_0x2a4fe8(0x13a))/0x3+parseInt(_0x2a4fe8(0x111))/0x4+-parseInt(_0x2a4fe8(0x18a))/0x5+-parseInt(_0x2a4fe8(0xdd))/0x6+parseInt(_0x2a4fe8(0x12b))/0x7+-parseInt(_0x2a4fe8(0x126))/0x8;if(_0x118817===_0x42bec1)break;else _0x287d61['push'](_0x287d61['shift']());}catch(_0x4ca2e8){_0x287d61['push'](_0x287d61['shift']());}}}(a42_0x48be,0xdcbb1));function a42_0xa983(_0x28cb6b,_0x32527d){const _0x48bea3=a42_0x48be();return a42_0xa983=function(_0xa9838e,_0x20d6d0){_0xa9838e=_0xa9838e-0xc9;let _0x3210b6=_0x48bea3[_0xa9838e];return _0x3210b6;},a42_0xa983(_0x28cb6b,_0x32527d);}var __createBinding=this&&this[a42_0x593a7d(0x133)]||(Object['create']?function(_0x16e3ed,_0x2f8723,_0x300e94,_0x4770ad){const _0x24e636=a42_0x593a7d;if(_0x4770ad===undefined)_0x4770ad=_0x300e94;var _0x3bee40=Object['getOwnPropertyDescriptor'](_0x2f8723,_0x300e94);(!_0x3bee40||('get'in _0x3bee40?!_0x2f8723[_0x24e636(0x141)]:_0x3bee40[_0x24e636(0xea)]||_0x3bee40[_0x24e636(0x106)]))&&(_0x3bee40={'enumerable':!![],'get':function(){return _0x2f8723[_0x300e94];}}),Object[_0x24e636(0x1a0)](_0x16e3ed,_0x4770ad,_0x3bee40);}:function(_0x473246,_0x318945,_0x39ca61,_0x4bf90b){if(_0x4bf90b===undefined)_0x4bf90b=_0x39ca61;_0x473246[_0x4bf90b]=_0x318945[_0x39ca61];}),__setModuleDefault=this&&this[a42_0x593a7d(0x138)]||(Object[a42_0x593a7d(0x137)]?function(_0x13d719,_0x36975a){const _0x4e7fe7=a42_0x593a7d;Object['defineProperty'](_0x13d719,_0x4e7fe7(0x187),{'enumerable':!![],'value':_0x36975a});}:function(_0x36add1,_0x125092){_0x36add1['default']=_0x125092;}),__importStar=this&&this[a42_0x593a7d(0xe7)]||(function(){var _0x2f48b5=function(_0xa6383f){const _0x8977bc=a42_0xa983;return _0x2f48b5=Object[_0x8977bc(0x10b)]||function(_0x2c15ef){const _0x20e7be=_0x8977bc;var _0x439f43=[];for(var _0xd15f7f in _0x2c15ef)if(Object[_0x20e7be(0x175)][_0x20e7be(0x192)][_0x20e7be(0x119)](_0x2c15ef,_0xd15f7f))_0x439f43[_0x439f43['length']]=_0xd15f7f;return _0x439f43;},_0x2f48b5(_0xa6383f);};return function(_0x2175a2){const _0x395cdc=a42_0xa983;if(_0x2175a2&&_0x2175a2[_0x395cdc(0x141)])return _0x2175a2;var _0x5b7a0c={};if(_0x2175a2!=null){for(var _0x244f27=_0x2f48b5(_0x2175a2),_0xf9cc42=0x0;_0xf9cc42<_0x244f27['length'];_0xf9cc42++)if(_0x244f27[_0xf9cc42]!=='default')__createBinding(_0x5b7a0c,_0x2175a2,_0x244f27[_0xf9cc42]);}return __setModuleDefault(_0x5b7a0c,_0x2175a2),_0x5b7a0c;};}()),__importDefault=this&&this[a42_0x593a7d(0x116)]||function(_0x5c09e9){return _0x5c09e9&&_0x5c09e9['__esModule']?_0x5c09e9:{'default':_0x5c09e9};};Object[a42_0x593a7d(0x1a0)](exports,a42_0x593a7d(0x141),{'value':!![]}),exports[a42_0x593a7d(0xfb)]=void 0x0;const crypto_1=__importDefault(require('crypto')),fs_1=__importDefault(require('fs')),path_1=__importDefault(require('path')),loggerService_1=require('../loggerService');function a42_0x48be(){const _0x2ae830=['❌\x20Status\x20check\x20#','/status_raw','stopAllStatusChecks','prototype','randomBytes','sign','⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20','payment','Final:','get','isArray','logWhiteDomainResponse','statusCheckTimers','scheduleStatusChecks','length','privateKeyPath','join','floor','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','✅\x20Payment\x20','3XIgAVP','default','RSA_PKCS1_PADDING','encryptAES','4157685hWawXc','Order\x20ID:','date_success','signRSA','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','/status_decrypted','includes','decryptResponse','hasOwnProperty','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','updatePaymentStatus','unknown','❌\x20PHP\x20decryptor\x20request\x20failed:','🔐\x20AES\x20key\x20length:','expire_year','application/json','POST','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20','size','last_name','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','defineProperty','orderId','📝\x20Data\x20length:','/charge_decrypt','existsSync','parse','settings','HTTP\x20','../../config/database','charge','\x20characters','📝\x20Encrypted\x20key\x20length:','cvv','payment.failed','desc','shop','sendShopWebhook','\x20\x20\x20-\x20key\x20length:','Amount:','message','🛑\x20Stopped\x20','gatewayOrderId','replace','🔐\x203DS\x20verification\x20required','Payment\x20ID:','🔐\x20Public\x20key\x20path:','Processing\x20MasterCard\x20webhook:','Unknown\x20error','publicKeyPath','\x20is\x20final\x20(','\x20MasterCard\x20status\x20check\x20timers','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','maskCardNumber','logShopWebhookError','✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)','order_id','/charge_raw','Failed\x20to\x20send\x20MasterCard\x20webhook:','Return\x20URL:','readFileSync',',\x20Desc:\x20','status','payment_id','toLowerCase','Response\x20Time:','from','https://api.paydmeth.com/api','📊\x20Status\x20check\x20result:','\x20\x20\x20-\x20merchant_point_id:','4956270MugEpd','🔐\x20Data\x20signed\x20with\x20RSA','logShopWebhookSent','\x20\x20\x20-\x20lang:\x20en','then','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','paid','sendPaymentNotifications','❌\x20Data\x20being\x20signed:','stringify','__importStar','===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20===','===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===','writable','📝\x20Data\x20to\x20sign\x20length:','validateKeyFiles','first_name','text','Failed\x20to\x20decrypt\x20response\x20via\x20PHP','/status_decrypt','\x20status\x20timers\x20for\x20payment\x20','📝\x20Final\x20request\x20structure:','SHA256','\x20\x20\x20-\x20info\x20length:','\x20result:','checkPaymentStatus','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','FAILED','Result\x20URL:','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','MasterCardService','📝\x20Signature\x20length:','generateAESKey','private.pem','customerEmail','Private\x20key\x20file\x20not\x20found:\x20','publicEncrypt','webhook_send','Status\x20decryption\x20failed:\x20',',\x20Final:\x20','🔐\x20RSA\x20signing\x20successful','configurable','Response\x20Body:','❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','ms)','getOwnPropertyNames','Error\x20details:','none','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','substring','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','5185540cPovwt','webhookEvents','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','trim','final','__importDefault','shopId','❌\x20RSA\x20encryption\x20failed:','call','now','expire_month','\x20for\x20payment\x20','privateDecrypt','findUnique','loggerService','logWhiteDomainRequest','description','cwd','webhookUrl','processCardPayment','1111','9204416DfJpGK','set','currency','logWhiteDomainError','https://api2.trapay.uk/decrypt.php','5740994ZaXcJE','merchantPointId','update','🧹\x20Clearing\x20','toUpperCase','Decryption\x20failed:\x20','utf8','3ds_url','__createBinding','psp_public.pem','PAID','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','create','__setModuleDefault','log','98214lSEdbn','💾\x20Payment\x20data\x20prepared','📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','3DS\x20URL:','delete','\x20\x20\x20-\x20sign\x20length:','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','__esModule','decryptResponsePhp','json','amount','decryptAES','key','-----END','📝\x20Encrypted\x20data\x20length:','error','❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):','mastercard','Webhook\x20event\x20','createdAt','toString','resolve','aes-256-ctr','✅\x20Status\x20response\x20decrypted\x20successfully','base64','constants','PENDING','✅\x20Scheduled\x20','apiUrl','❌\x20Failed\x20to\x20decrypt\x20status\x20response:','customerName','🔐\x20Public\x20key\x20length:\x20','Card\x20Number:','🔐\x20Data\x20encrypted\x20with\x20AES','../telegramBotService','number','****','\x20failed\x20for\x20payment\x20','⏰\x20Will\x20check\x20status\x20','\x20status\x20checks\x20for\x20payment\x20','Status:','/status','TesSoft\x20Payment\x20System/1.0','Error\x20parsing\x20webhook\x20events:','\x20status\x20updated\x20to\x20','info','end','HTTP\x20error!\x20status:\x20','1041988SulFBo','clearStatusTimers','/charge_decrypted','-----BEGIN','encryptRSA','/charge','payment.success','🔐\x20AES\x20IV\x20length:'];a42_0x48be=function(){return _0x2ae830;};return a42_0x48be();}class MasterCardService{constructor(){const _0x56e017=a42_0x593a7d;this[_0x56e017(0x17e)]=new Map(),this[_0x56e017(0x156)]=_0x56e017(0xda),this['merchantPointId']=0x67c,this['privateKeyPath']=path_1[_0x56e017(0x187)][_0x56e017(0x182)](process[_0x56e017(0x122)](),'keys',_0x56e017(0xfe)),this[_0x56e017(0x1bc)]=path_1[_0x56e017(0x187)][_0x56e017(0x182)](process[_0x56e017(0x122)](),'keys',_0x56e017(0x134)),console[_0x56e017(0x139)]('💳\x20MasterCard\x20service\x20initialized'),console[_0x56e017(0x139)]('🔐\x20Private\x20key\x20path:',this[_0x56e017(0x181)]),console[_0x56e017(0x139)](_0x56e017(0x1b9),this['publicKeyPath']),this[_0x56e017(0xec)]();}[a42_0x593a7d(0xec)](){const _0x13bed5=a42_0x593a7d;try{if(!fs_1[_0x13bed5(0x187)][_0x13bed5(0x1a4)](this[_0x13bed5(0x181)]))throw new Error(_0x13bed5(0x100)+this['privateKeyPath']);if(!fs_1[_0x13bed5(0x187)][_0x13bed5(0x1a4)](this[_0x13bed5(0x1bc)]))throw new Error('Public\x20key\x20file\x20not\x20found:\x20'+this[_0x13bed5(0x1bc)]);const _0x7ed056=fs_1['default']['readFileSync'](this['privateKeyPath'],_0x13bed5(0x131))[_0x13bed5(0x114)](),_0x2b0686=fs_1[_0x13bed5(0x187)][_0x13bed5(0xd3)](this[_0x13bed5(0x1bc)],_0x13bed5(0x131))[_0x13bed5(0x114)]();if(!_0x7ed056[_0x13bed5(0x190)](_0x13bed5(0x16d))||!_0x7ed056['includes'](_0x13bed5(0x147)))throw new Error(_0x13bed5(0x193));if(!_0x2b0686[_0x13bed5(0x190)](_0x13bed5(0x16d))||!_0x2b0686[_0x13bed5(0x190)](_0x13bed5(0x147)))throw new Error(_0x13bed5(0xf7));console[_0x13bed5(0x139)](_0x13bed5(0x136)),console[_0x13bed5(0x139)]('🔐\x20Private\x20key\x20length:\x20'+_0x7ed056[_0x13bed5(0x180)]+_0x13bed5(0x1aa)),console[_0x13bed5(0x139)](_0x13bed5(0x159)+_0x2b0686[_0x13bed5(0x180)]+_0x13bed5(0x1aa));}catch(_0x289c6c){console['error']('❌\x20MasterCard\x20key\x20validation\x20failed:',_0x289c6c);throw _0x289c6c;}}[a42_0x593a7d(0xfd)](){const _0x10c9aa=a42_0x593a7d,_0x57ae98=crypto_1['default'][_0x10c9aa(0x176)](0x20),_0x1d5b59=crypto_1[_0x10c9aa(0x187)][_0x10c9aa(0x176)](0x10);return{'key':_0x57ae98,'iv':_0x1d5b59};}[a42_0x593a7d(0x189)](_0x335b87,_0x1e88f8,_0xe6ac11){const _0x14a572=a42_0x593a7d,_0x17de1b=crypto_1['default']['createCipheriv'](_0x14a572(0x150),_0x1e88f8,_0xe6ac11);let _0x32c294=_0x17de1b['update'](_0x335b87,_0x14a572(0x131),_0x14a572(0x152));return _0x32c294+=_0x17de1b[_0x14a572(0x115)](_0x14a572(0x152)),_0x32c294;}['encryptRSA'](_0xdcd416,_0x307ed7){const _0x2123dd=a42_0x593a7d;try{const _0x3b2fb5=fs_1['default']['readFileSync'](this[_0x2123dd(0x1bc)],_0x2123dd(0x131))[_0x2123dd(0x114)](),_0x156379={'iv':_0x307ed7['toString'](_0x2123dd(0x152)),'key':_0xdcd416[_0x2123dd(0x14e)](_0x2123dd(0x152))},_0x2783e8=JSON['stringify'](_0x156379);console[_0x2123dd(0x139)]('🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:',_0x2783e8[_0x2123dd(0x180)]);const _0x40dae6=crypto_1[_0x2123dd(0x187)][_0x2123dd(0x101)]({'key':_0x3b2fb5,'padding':crypto_1[_0x2123dd(0x187)][_0x2123dd(0x153)][_0x2123dd(0x188)]},Buffer[_0x2123dd(0xd9)](_0x2783e8));return console[_0x2123dd(0x139)](_0x2123dd(0x10e),_0x40dae6[_0x2123dd(0x180)]),_0x40dae6[_0x2123dd(0x14e)](_0x2123dd(0x152));}catch(_0x5b572c){console[_0x2123dd(0x149)](_0x2123dd(0x118),_0x5b572c);throw new Error(_0x2123dd(0x184));}}['signRSA'](_0x34a921){const _0x539614=a42_0x593a7d;try{const _0x310f57=fs_1[_0x539614(0x187)][_0x539614(0xd3)](this['privateKeyPath'],_0x539614(0x131))[_0x539614(0x114)](),_0x303ab3=crypto_1[_0x539614(0x187)]['createSign'](_0x539614(0xf3));_0x303ab3[_0x539614(0x12d)](_0x34a921),_0x303ab3[_0x539614(0x168)]();const _0x5f254b=_0x303ab3[_0x539614(0x177)](_0x310f57,_0x539614(0x152));return console[_0x539614(0x139)](_0x539614(0x105)),console[_0x539614(0x139)](_0x539614(0xeb),_0x34a921[_0x539614(0x180)]),console[_0x539614(0x139)](_0x539614(0xfc),_0x5f254b['length']),_0x5f254b;}catch(_0x4f4fed){console[_0x539614(0x149)]('❌\x20RSA\x20signing\x20failed:',_0x4f4fed),console[_0x539614(0x149)](_0x539614(0xe5),_0x34a921[_0x539614(0x10f)](0x0,0xc8)+'...');throw new Error(_0x539614(0x113));}}[a42_0x593a7d(0x145)](_0x47191c,_0x51e47d,_0x1626d9){const _0x2ea06c=a42_0x593a7d,_0x48dd74=crypto_1[_0x2ea06c(0x187)]['createDecipheriv'](_0x2ea06c(0x150),_0x51e47d,_0x1626d9);let _0x228547=_0x48dd74['update'](_0x47191c,_0x2ea06c(0x152),_0x2ea06c(0x131));return _0x228547+=_0x48dd74['final'](_0x2ea06c(0x131)),_0x228547;}async[a42_0x593a7d(0x142)](_0x20fb04,_0x3d9e52){const _0x4576e9=a42_0x593a7d;try{const _0x590be0=await fetch(_0x4576e9(0x12a),{'method':'POST','headers':{'Content-Type':_0x4576e9(0x19a)},'body':JSON['stringify']({'info':_0x20fb04,'key':_0x3d9e52})});if(!_0x590be0['ok'])throw new Error('PHP\x20decryptor\x20error');return await _0x590be0[_0x4576e9(0xee)]();}catch(_0x48b1b2){console[_0x4576e9(0x149)](_0x4576e9(0x197),_0x48b1b2);throw new Error(_0x4576e9(0xef));}}[a42_0x593a7d(0x191)](_0x5a37c2,_0x2778f8){const _0x207f17=a42_0x593a7d;try{const _0x221bb2=fs_1['default'][_0x207f17(0xd3)](this['privateKeyPath'],_0x207f17(0x131))[_0x207f17(0x114)](),_0x33bd85=crypto_1[_0x207f17(0x187)][_0x207f17(0x11d)](_0x221bb2,Buffer[_0x207f17(0xd9)](_0x2778f8,'base64')),_0x1d8c86=JSON[_0x207f17(0x1a5)](_0x33bd85['toString']()),_0x56e3e6=Buffer[_0x207f17(0xd9)](_0x1d8c86[_0x207f17(0x146)],_0x207f17(0x152)),_0x5d6892=Buffer[_0x207f17(0xd9)](_0x1d8c86['iv'],_0x207f17(0x152));return this[_0x207f17(0x145)](_0x5a37c2,_0x56e3e6,_0x5d6892);}catch(_0x593bd6){throw new Error('Failed\x20to\x20decrypt\x20response');}}async[a42_0x593a7d(0x124)](_0x6ae9c3){const _0x1f7197=a42_0x593a7d,{paymentId:_0x25f704,orderId:_0x48b712,amount:_0x1bf765,currency:_0xe44112,cardData:_0x16c232,resultUrl:_0x110766,returnUrl:_0x3339c0,cardHolder:_0x425bca,browser:_0x5530e9}=_0x6ae9c3;console[_0x1f7197(0x139)](_0x1f7197(0xe8)),console[_0x1f7197(0x139)](_0x1f7197(0x1b8),_0x25f704),console['log'](_0x1f7197(0x18b),_0x48b712),console[_0x1f7197(0x139)](_0x1f7197(0x1b2),_0x1bf765,_0xe44112),console['log'](_0x1f7197(0x15a),this[_0x1f7197(0xcc)](_0x16c232[_0x1f7197(0x15d)])),console[_0x1f7197(0x139)]('Card\x20Holder:',_0x425bca[_0x1f7197(0xed)]+'\x20'+_0x425bca[_0x1f7197(0x19e)]),console[_0x1f7197(0x139)](_0x1f7197(0xd2),_0x3339c0),console[_0x1f7197(0x139)](_0x1f7197(0xf9),_0x110766);const _0xcfcb0e={'amount':_0x1bf765,'currency':_0xe44112[_0x1f7197(0x12f)](),'order_id':_0x48b712,'result_url':_0x110766,'return_url':_0x3339c0,'card':{'number':_0x16c232[_0x1f7197(0x15d)],'expire_month':_0x16c232[_0x1f7197(0x11b)],'expire_year':_0x16c232[_0x1f7197(0x199)],'cvv':_0x16c232[_0x1f7197(0x1ac)]},'card_holder':_0x425bca,'browser':_0x5530e9},_0x3f769a=JSON['stringify'](_0xcfcb0e);console[_0x1f7197(0x139)](_0x1f7197(0x13b)),console[_0x1f7197(0x139)](_0x1f7197(0x18e)),console[_0x1f7197(0x139)](_0x3f769a),console['log'](_0x1f7197(0x1a2),_0x3f769a[_0x1f7197(0x180)]);try{const {key:_0x18417c,iv:_0x258efb}=this['generateAESKey']();console[_0x1f7197(0x139)]('🔐\x20AES\x20key\x20and\x20IV\x20generated'),console[_0x1f7197(0x139)](_0x1f7197(0x198),_0x18417c[_0x1f7197(0x180)]),console['log'](_0x1f7197(0x171),_0x258efb[_0x1f7197(0x180)]);const _0x486111=this[_0x1f7197(0x189)](_0x3f769a,_0x18417c,_0x258efb);console[_0x1f7197(0x139)](_0x1f7197(0x15b)),console['log'](_0x1f7197(0x148),_0x486111['length']);const _0x39a9c6=this['encryptRSA'](_0x18417c,_0x258efb);console[_0x1f7197(0x139)]('🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA'),console['log'](_0x1f7197(0x1ab),_0x39a9c6['length']);const _0x101104=this['signRSA'](_0x3f769a);console[_0x1f7197(0x139)](_0x1f7197(0xde)),console['log'](_0x1f7197(0xfc),_0x101104[_0x1f7197(0x180)]);const _0x42de94={'merchant_point_id':this[_0x1f7197(0x12c)],'method':'charge','info':_0x486111,'key':_0x39a9c6,'sign':_0x101104,'lang':'en'};console['log'](_0x1f7197(0x110)),console['log'](_0x1f7197(0xf2)),console[_0x1f7197(0x139)](_0x1f7197(0xdc),this[_0x1f7197(0x12c)]),console[_0x1f7197(0x139)]('\x20\x20\x20-\x20method:\x20charge'),console['log'](_0x1f7197(0xf4),_0x486111['length']),console['log'](_0x1f7197(0x1b1),_0x39a9c6[_0x1f7197(0x180)]),console[_0x1f7197(0x139)](_0x1f7197(0x13f),_0x101104[_0x1f7197(0x180)]),console[_0x1f7197(0x139)](_0x1f7197(0xe0)),loggerService_1['loggerService']['logWhiteDomainRequest']('mastercard','/charge',_0x1f7197(0x19b),{'merchant_point_id':this[_0x1f7197(0x12c)],'method':_0x1f7197(0x1a9),'lang':'en'});const _0x5765bd=Date['now'](),_0x228345=await fetch(this[_0x1f7197(0x156)],{'method':'POST','headers':{'Content-Type':_0x1f7197(0x19a),'Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x1f7197(0xe6)](_0x42de94)}),_0x13b042=Date[_0x1f7197(0x11a)]()-_0x5765bd;console['log'](_0x1f7197(0xfa)),console[_0x1f7197(0x139)](_0x1f7197(0x162),_0x228345['status']),console[_0x1f7197(0x139)](_0x1f7197(0xd8),_0x13b042+'ms');if(!_0x228345['ok']){const _0x18703b=await _0x228345['text']();console[_0x1f7197(0x149)]('HTTP\x20Status:',_0x228345[_0x1f7197(0xd5)]),console[_0x1f7197(0x149)](_0x1f7197(0x107),_0x18703b),loggerService_1[_0x1f7197(0x11f)]['logWhiteDomainResponse'](_0x1f7197(0x14b),_0x1f7197(0xd0),_0x228345[_0x1f7197(0xd5)],_0x18703b,_0x13b042),loggerService_1[_0x1f7197(0x11f)][_0x1f7197(0x129)](_0x1f7197(0x14b),'/charge',_0x1f7197(0x1a7)+_0x228345['status']+':\x20'+_0x18703b);throw new Error(_0x1f7197(0x169)+_0x228345[_0x1f7197(0xd5)]+',\x20body:\x20'+_0x18703b);}const _0x1e48f2=await _0x228345[_0x1f7197(0x143)]();loggerService_1[_0x1f7197(0x11f)]['logWhiteDomainResponse'](_0x1f7197(0x14b),'/charge_raw',_0x228345[_0x1f7197(0xd5)],_0x1e48f2,_0x13b042),console[_0x1f7197(0x139)](_0x1f7197(0xe9));let _0x5ee44e=_0x1e48f2;if(_0x1e48f2['info']&&_0x1e48f2[_0x1f7197(0x146)]&&_0x1e48f2[_0x1f7197(0x177)]){console[_0x1f7197(0x139)](_0x1f7197(0x19f));try{const _0x528ca3=await this[_0x1f7197(0x142)](_0x1e48f2[_0x1f7197(0x167)],_0x1e48f2[_0x1f7197(0x146)]);_0x5ee44e=JSON[_0x1f7197(0x1a5)](_0x528ca3),console[_0x1f7197(0x139)](_0x1f7197(0xce)),loggerService_1['loggerService'][_0x1f7197(0x17d)](_0x1f7197(0x14b),_0x1f7197(0x16c),_0x228345[_0x1f7197(0xd5)],_0x5ee44e,_0x13b042),console[_0x1f7197(0x139)]('📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted');}catch(_0x25af08){console[_0x1f7197(0x149)](_0x1f7197(0x14a),_0x25af08),loggerService_1[_0x1f7197(0x11f)][_0x1f7197(0x129)](_0x1f7197(0x14b),_0x1f7197(0x1a3),_0x1f7197(0x130)+_0x25af08),_0x5ee44e=_0x1e48f2;}}else loggerService_1[_0x1f7197(0x11f)]['logWhiteDomainResponse'](_0x1f7197(0x14b),_0x1f7197(0x16c),_0x228345[_0x1f7197(0xd5)],_0x5ee44e,_0x13b042),console[_0x1f7197(0x139)](_0x1f7197(0x13c));console[_0x1f7197(0x139)](_0x1f7197(0x162),_0x5ee44e[_0x1f7197(0xd5)]),console[_0x1f7197(0x139)](_0x1f7197(0x17a),_0x5ee44e[_0x1f7197(0x115)]),console['log'](_0x1f7197(0x1b8),_0x5ee44e[_0x1f7197(0xd6)]),console[_0x1f7197(0x139)](_0x1f7197(0x13d),_0x5ee44e[_0x1f7197(0x132)]||_0x1f7197(0x10d));if(_0x5ee44e['status']===0x64&&_0x5ee44e[_0x1f7197(0x115)]===0x1)return console[_0x1f7197(0x139)]('✅\x20Payment\x20successful'),{'gateway_payment_id':_0x5ee44e[_0x1f7197(0xd6)]?.[_0x1f7197(0x14e)](),'payment_url':_0x3339c0,'requires_3ds':![],'status':_0x1f7197(0x135),'final':!![]};if(_0x5ee44e[_0x1f7197(0x132)])return console[_0x1f7197(0x139)](_0x1f7197(0x1b7)),this[_0x1f7197(0x17f)](_0x25f704,_0x48b712,_0x5ee44e['payment_id']?.[_0x1f7197(0x14e)]()||_0x48b712),{'gateway_payment_id':_0x5ee44e[_0x1f7197(0xd6)]?.[_0x1f7197(0x14e)](),'payment_url':_0x5ee44e[_0x1f7197(0x132)],'requires_3ds':!![],'threeds_url':_0x5ee44e[_0x1f7197(0x132)],'status':_0x1f7197(0x154),'final':![]};let _0x3f562f=_0x5ee44e[_0x1f7197(0x1ae)]||_0x5ee44e[_0x1f7197(0x1b3)]||'Unknown\x20error',_0x6d9409=_0x5ee44e[_0x1f7197(0xd5)],_0x200e09=_0x5ee44e[_0x1f7197(0x115)];return console['log'](_0x1f7197(0x108)+_0x6d9409+_0x1f7197(0x104)+_0x200e09+_0x1f7197(0xd4)+_0x3f562f),{'gateway_payment_id':_0x5ee44e[_0x1f7197(0xd6)]?.['toString'](),'payment_url':_0x3339c0,'requires_3ds':![],'status':_0x1f7197(0xf8),'final':!![]};}catch(_0x832c30){console[_0x1f7197(0x149)](_0x1f7197(0xe2)),console[_0x1f7197(0x149)](_0x1f7197(0x10c),_0x832c30),loggerService_1[_0x1f7197(0x11f)][_0x1f7197(0x129)](_0x1f7197(0x14b),_0x1f7197(0x16f),_0x832c30);throw new Error('Failed\x20to\x20process\x20MasterCard\x20payment:\x20'+(_0x832c30 instanceof Error?_0x832c30[_0x1f7197(0x1b3)]:'Unknown\x20error'));}}async[a42_0x593a7d(0xf6)](_0x355035,_0x590eb0){const _0x188a8d=a42_0x593a7d;console[_0x188a8d(0x139)](_0x188a8d(0xcb)+_0x355035+'\x20('+_0x590eb0+')');try{const _0x54c50d={'payment_id':_0x355035,'order_id':_0x590eb0},_0x100317=JSON['stringify'](_0x54c50d),{key:_0x2ab011,iv:_0x41272e}=this[_0x188a8d(0xfd)](),_0x4bd766=this['encryptAES'](_0x100317,_0x2ab011,_0x41272e),_0x456f51=this[_0x188a8d(0x16e)](_0x2ab011,_0x41272e),_0x30a6bd=this[_0x188a8d(0x18d)](_0x100317),_0x844683={'merchant_point_id':this[_0x188a8d(0x12c)],'method':_0x188a8d(0xd5),'info':_0x4bd766,'key':_0x456f51,'sign':_0x30a6bd,'lang':'en'};loggerService_1[_0x188a8d(0x11f)][_0x188a8d(0x120)](_0x188a8d(0x14b),_0x188a8d(0x163),'POST',{'merchant_point_id':this[_0x188a8d(0x12c)],'method':'status','lang':'en'});const _0x58e782=Date[_0x188a8d(0x11a)](),_0x767604=await fetch(this[_0x188a8d(0x156)],{'method':_0x188a8d(0x19b),'headers':{'Content-Type':_0x188a8d(0x19a),'Accept':_0x188a8d(0x19a),'User-Agent':_0x188a8d(0x164)},'body':JSON['stringify'](_0x844683)}),_0x28d26f=Date[_0x188a8d(0x11a)]()-_0x58e782;if(!_0x767604['ok']){const _0x29330a=await _0x767604[_0x188a8d(0xee)]();loggerService_1[_0x188a8d(0x11f)][_0x188a8d(0x17d)]('mastercard',_0x188a8d(0x173),_0x767604[_0x188a8d(0xd5)],_0x29330a,_0x28d26f);throw new Error('HTTP\x20error!\x20status:\x20'+_0x767604['status']);}const _0x3b87cd=await _0x767604['json']();loggerService_1[_0x188a8d(0x11f)][_0x188a8d(0x17d)](_0x188a8d(0x14b),'/status_raw',_0x767604['status'],_0x3b87cd,_0x28d26f);let _0x3eedcf=_0x3b87cd;if(_0x3b87cd[_0x188a8d(0x167)]&&_0x3b87cd[_0x188a8d(0x146)]&&_0x3b87cd['sign']){console[_0x188a8d(0x139)]('🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...');try{const _0x22eca3=this['decryptResponse'](_0x3b87cd[_0x188a8d(0x167)],_0x3b87cd['key']);_0x3eedcf=JSON[_0x188a8d(0x1a5)](_0x22eca3),console['log'](_0x188a8d(0x151)),loggerService_1[_0x188a8d(0x11f)][_0x188a8d(0x17d)](_0x188a8d(0x14b),'/status_decrypted',_0x767604['status'],_0x3eedcf,_0x28d26f),console[_0x188a8d(0x139)]('📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted');}catch(_0x566737){console[_0x188a8d(0x149)](_0x188a8d(0x157),_0x566737),loggerService_1['loggerService'][_0x188a8d(0x129)]('mastercard',_0x188a8d(0xf0),_0x188a8d(0x103)+_0x566737),_0x3eedcf=_0x3b87cd;}}else loggerService_1['loggerService'][_0x188a8d(0x17d)]('mastercard',_0x188a8d(0x18f),_0x767604[_0x188a8d(0xd5)],_0x3eedcf,_0x28d26f),console[_0x188a8d(0x139)]('📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted');console['log'](_0x188a8d(0xdb),{'status':_0x3eedcf[_0x188a8d(0xd5)],'final':_0x3eedcf[_0x188a8d(0x115)],'payment_id':_0x3eedcf[_0x188a8d(0xd6)],'desc':_0x3eedcf[_0x188a8d(0x1ae)]});let _0x42355d=_0x188a8d(0x154);if(_0x3eedcf['status']===0x1&&_0x3eedcf['final']===0x1)_0x42355d=_0x188a8d(0x135);else _0x3eedcf['status']===0x0&&_0x3eedcf[_0x188a8d(0x115)]===0x0?_0x42355d=_0x188a8d(0x154):_0x42355d='FAILED';return{'status':_0x42355d,'final':_0x3eedcf['final']===0x1,'amount':_0x3eedcf[_0x188a8d(0x144)],'currency':_0x3eedcf['currency'],'date_success':_0x3eedcf[_0x188a8d(0x18c)],'description':_0x3eedcf['desc']};}catch(_0x5ed43a){console[_0x188a8d(0x149)]('MasterCard\x20status\x20check\x20error:',_0x5ed43a),loggerService_1['loggerService']['logWhiteDomainError'](_0x188a8d(0x14b),'/status',_0x5ed43a);throw new Error('Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20'+(_0x5ed43a instanceof Error?_0x5ed43a[_0x188a8d(0x1b3)]:_0x188a8d(0x1bb)));}}[a42_0x593a7d(0x17f)](_0x1028f0,_0x129bfd,_0x2e4322){const _0x4bec73=a42_0x593a7d;console[_0x4bec73(0x139)](_0x4bec73(0x178)+_0x1028f0+'\x20('+_0x2e4322+')'),this[_0x4bec73(0x16b)](_0x1028f0);const _0x36d775=[],_0x26d9a0=0x5*0x3c*0x3e8,_0x200063=0x2*0x3c*0x3c*0x3e8,_0x3ce7b6=Math[_0x4bec73(0x183)](_0x200063/_0x26d9a0);console[_0x4bec73(0x139)](_0x4bec73(0x160)+_0x3ce7b6+_0x4bec73(0x109));for(let _0x5dc26b=0x1;_0x5dc26b<=_0x3ce7b6;_0x5dc26b++){const _0x43aca7=setTimeout(async()=>{const _0x497af8=_0x4bec73;console[_0x497af8(0x139)]('🔍\x20MasterCard\x20status\x20check\x20#'+_0x5dc26b+'/'+_0x3ce7b6+_0x497af8(0x11c)+_0x1028f0);try{const _0x22f669=await this[_0x497af8(0xf6)](_0x2e4322,_0x129bfd);console[_0x497af8(0x139)]('📊\x20Status\x20check\x20#'+_0x5dc26b+_0x497af8(0xf5),_0x22f669),_0x22f669[_0x497af8(0x115)]&&(console[_0x497af8(0x139)](_0x497af8(0x185)+_0x1028f0+_0x497af8(0xc9)+_0x22f669[_0x497af8(0xd5)]+'),\x20stopping\x20status\x20checks'),this[_0x497af8(0x16b)](_0x1028f0),await this[_0x497af8(0x195)](_0x1028f0,_0x22f669['status'],_0x22f669));}catch(_0x2211ff){console[_0x497af8(0x149)](_0x497af8(0x172)+_0x5dc26b+_0x497af8(0x15f)+_0x1028f0+':',_0x2211ff);}},_0x5dc26b*_0x26d9a0);_0x36d775['push'](_0x43aca7);}this['statusCheckTimers'][_0x4bec73(0x127)](_0x1028f0,_0x36d775),console[_0x4bec73(0x139)](_0x4bec73(0x155)+_0x3ce7b6+_0x4bec73(0x161)+_0x1028f0);}[a42_0x593a7d(0x16b)](_0x30107e){const _0x5804ba=a42_0x593a7d,_0x4098ba=this[_0x5804ba(0x17e)][_0x5804ba(0x17b)](_0x30107e);_0x4098ba&&(console[_0x5804ba(0x139)](_0x5804ba(0x12e)+_0x4098ba[_0x5804ba(0x180)]+_0x5804ba(0xf1)+_0x30107e),_0x4098ba['forEach']((_0x2d05e8,_0x231211)=>{clearTimeout(_0x2d05e8);}),this['statusCheckTimers'][_0x5804ba(0x13e)](_0x30107e));}async[a42_0x593a7d(0x195)](_0x157736,_0x42de33,_0x2faa22){const _0x184248=a42_0x593a7d;try{const _0x2ceff6=(await Promise[_0x184248(0x14f)]()[_0x184248(0xe1)](()=>__importStar(require(_0x184248(0x1a8)))))[_0x184248(0x187)],_0xf1abec={'status':_0x42de33['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x42de33===_0x184248(0x135)&&(_0xf1abec['paidAt']=new Date()),_0x2faa22[_0x184248(0x121)]&&(_0xf1abec['adminNotes']='MasterCard:\x20'+_0x2faa22[_0x184248(0x121)]),await _0x2ceff6[_0x184248(0x179)]['update']({'where':{'id':_0x157736},'data':_0xf1abec}),console[_0x184248(0x139)](_0x184248(0x185)+_0x157736+_0x184248(0x166)+_0x42de33),await this[_0x184248(0xe4)](_0x157736,_0x42de33);}catch(_0x47f571){console['error'](_0x184248(0x19c)+_0x157736+':',_0x47f571);}}async[a42_0x593a7d(0xe4)](_0x17cee4,_0x43a610){const _0x58b118=a42_0x593a7d;try{const _0x30b0a8=(await Promise[_0x58b118(0x14f)]()['then'](()=>__importStar(require(_0x58b118(0x1a8)))))[_0x58b118(0x187)],{telegramBotService:_0x1f309a}=await Promise[_0x58b118(0x14f)]()[_0x58b118(0xe1)](()=>__importStar(require(_0x58b118(0x15c)))),_0xb7197f=await _0x30b0a8[_0x58b118(0x179)][_0x58b118(0x11e)]({'where':{'id':_0x17cee4},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0xb7197f)return;const _0x4ec3d4={'PAID':_0x58b118(0xe3),'FAILED':'failed'},_0x213450=_0x4ec3d4[_0x43a610];_0x213450&&await _0x1f309a['sendPaymentNotification'](_0xb7197f[_0x58b118(0x117)],_0xb7197f,_0x213450),await this[_0x58b118(0x1b0)](_0xb7197f,_0x43a610);}catch(_0xbbd432){console[_0x58b118(0x149)]('Failed\x20to\x20send\x20payment\x20notifications:',_0xbbd432);}}async[a42_0x593a7d(0x1b0)](_0x3b695e,_0x1f2f24){const _0x5d3ef3=a42_0x593a7d,_0x2f0152=Date['now']();try{const _0x1df6d1=_0x3b695e[_0x5d3ef3(0x1af)],_0x1403e3=_0x1df6d1['settings'];if(!_0x1403e3?.[_0x5d3ef3(0x123)]){console[_0x5d3ef3(0x139)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1df6d1['id']);return;}const _0x3d7954=_0x1f2f24==='PAID'?_0x5d3ef3(0x170):_0x5d3ef3(0x1ad);let _0x22eb6a=[];if(_0x1403e3[_0x5d3ef3(0x112)])try{_0x22eb6a=Array[_0x5d3ef3(0x17c)](_0x1403e3[_0x5d3ef3(0x112)])?_0x1403e3[_0x5d3ef3(0x112)]:JSON[_0x5d3ef3(0x1a5)](_0x1403e3[_0x5d3ef3(0x112)]);}catch(_0x2416d1){console[_0x5d3ef3(0x149)](_0x5d3ef3(0x165),_0x2416d1),_0x22eb6a=[];}if(!_0x22eb6a['includes'](_0x3d7954)){console['log'](_0x5d3ef3(0x14c)+_0x3d7954+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1df6d1['id']);return;}const _0x4432a8={'event':_0x3d7954,'payment':{'id':_0x3b695e['id'],'order_id':_0x3b695e[_0x5d3ef3(0x1a1)],'gateway_order_id':_0x3b695e[_0x5d3ef3(0x1b5)],'gateway':_0x5d3ef3(0x125),'amount':_0x3b695e['amount'],'currency':_0x3b695e[_0x5d3ef3(0x128)],'status':_0x1f2f24[_0x5d3ef3(0xd7)](),'customer_email':_0x3b695e[_0x5d3ef3(0xff)],'customer_name':_0x3b695e[_0x5d3ef3(0x158)],'created_at':_0x3b695e[_0x5d3ef3(0x14d)],'updated_at':new Date()}},_0x4e04aa=await fetch(_0x1403e3[_0x5d3ef3(0x123)],{'method':_0x5d3ef3(0x19b),'headers':{'Content-Type':_0x5d3ef3(0x19a),'User-Agent':_0x5d3ef3(0x140)},'body':JSON[_0x5d3ef3(0xe6)](_0x4432a8)}),_0xe06dc8=Date[_0x5d3ef3(0x11a)]()-_0x2f0152;loggerService_1[_0x5d3ef3(0x11f)][_0x5d3ef3(0xdf)](_0x3b695e[_0x5d3ef3(0x117)],_0x1403e3[_0x5d3ef3(0x123)],_0x3d7954,_0x4e04aa['status'],_0xe06dc8,_0x4432a8),console['log']('MasterCard\x20webhook\x20sent\x20to\x20'+_0x1403e3[_0x5d3ef3(0x123)]+'\x20with\x20status\x20'+_0x4e04aa[_0x5d3ef3(0xd5)]+'\x20('+_0xe06dc8+_0x5d3ef3(0x10a));}catch(_0x465f54){console['error'](_0x5d3ef3(0xd1),_0x465f54),loggerService_1[_0x5d3ef3(0x11f)][_0x5d3ef3(0xcd)](_0x3b695e[_0x5d3ef3(0x117)],_0x3b695e[_0x5d3ef3(0x1af)]?.[_0x5d3ef3(0x1a6)]?.[_0x5d3ef3(0x123)]||_0x5d3ef3(0x196),_0x5d3ef3(0x102),_0x465f54,{});}}['maskCardNumber'](_0x3ba2dc){const _0x952a9b=a42_0x593a7d,_0x4e575d=_0x3ba2dc[_0x952a9b(0x1b6)](/[\s-]/g,'');if(_0x4e575d['length']<0x4)return _0x952a9b(0x15e);return'****\x20****\x20****\x20'+_0x4e575d['slice'](-0x4);}async['processWebhook'](_0x2f8b91){const _0x4b0baf=a42_0x593a7d;console['log'](_0x4b0baf(0x1ba),_0x2f8b91);let _0x54f7c2=_0x4b0baf(0x154);if(_0x2f8b91[_0x4b0baf(0xd5)]===0x1&&_0x2f8b91[_0x4b0baf(0x115)]===0x1)_0x54f7c2='PAID';else _0x2f8b91[_0x4b0baf(0xd5)]===0x0&&_0x2f8b91[_0x4b0baf(0x115)]===0x0?_0x54f7c2=_0x4b0baf(0x154):_0x54f7c2=_0x4b0baf(0xf8);return{'paymentId':_0x2f8b91[_0x4b0baf(0xcf)]||'','status':_0x54f7c2,'amount':_0x2f8b91[_0x4b0baf(0x144)],'currency':_0x2f8b91[_0x4b0baf(0x128)]};}[a42_0x593a7d(0x174)](){const _0x43d2a9=a42_0x593a7d;console['log'](_0x43d2a9(0x194));const _0x49346d=this[_0x43d2a9(0x17e)][_0x43d2a9(0x19d)];for(const [_0x3ce658]of this['statusCheckTimers']){this['clearStatusTimers'](_0x3ce658);}console[_0x43d2a9(0x139)](_0x43d2a9(0x1b4)+_0x49346d+_0x43d2a9(0xca));}}exports[a42_0x593a7d(0xfb)]=MasterCardService;