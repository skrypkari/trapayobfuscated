'use strict';const a42_0x3c2e6b=a42_0x1d40;function a42_0x1d40(_0x300dc1,_0x47b079){const _0x191ced=a42_0x191c();return a42_0x1d40=function(_0x1d4006,_0x58ba13){_0x1d4006=_0x1d4006-0x7d;let _0x402496=_0x191ced[_0x1d4006];return _0x402496;},a42_0x1d40(_0x300dc1,_0x47b079);}(function(_0x1cff52,_0x5e63ce){const _0x12acb5=a42_0x1d40,_0x4b4f3c=_0x1cff52();while(!![]){try{const _0x3bd2ac=parseInt(_0x12acb5(0xfb))/0x1*(parseInt(_0x12acb5(0xb9))/0x2)+-parseInt(_0x12acb5(0xd5))/0x3+parseInt(_0x12acb5(0xe1))/0x4+-parseInt(_0x12acb5(0x152))/0x5*(parseInt(_0x12acb5(0x168))/0x6)+parseInt(_0x12acb5(0xb5))/0x7*(-parseInt(_0x12acb5(0x112))/0x8)+-parseInt(_0x12acb5(0x16c))/0x9+parseInt(_0x12acb5(0x16a))/0xa;if(_0x3bd2ac===_0x5e63ce)break;else _0x4b4f3c['push'](_0x4b4f3c['shift']());}catch(_0x339ae9){_0x4b4f3c['push'](_0x4b4f3c['shift']());}}}(a42_0x191c,0xe0051));function a42_0x191c(){const _0x1fc76a=['getOwnPropertyDescriptor','key','Failed\x20to\x20send\x20MasterCard\x20webhook:','clearStatusTimers','❌\x20PHP\x20decryptor\x20request\x20failed:','generateAESKey','✅\x20Payment\x20','📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','sendPaymentNotification','date_success','📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','\x20with\x20status\x20','865088muNRHa','\x20\x20\x20-\x20lang:\x20en','__importStar','delete','🔐\x20AES\x20key\x20length:','🔐\x20Private\x20key\x20path:','../loggerService','defineProperty','🔐\x203DS\x20verification\x20required','create','/status_decrypt','status','merchantPointId','cvv','__esModule','HTTP\x20Status:','💾\x20Payment\x20data\x20prepared','SHA256','logShopWebhookSent','unknown','maskCardNumber','readFileSync','application/json','writable','orderId','encryptAES','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','path','call','\x20status\x20checks\x20for\x20payment\x20','__importDefault','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','/charge_decrypted','\x20\x20\x20-\x20sign\x20length:','default','then','getOwnPropertyNames','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','❌\x20MasterCard\x20key\x20validation\x20failed:','join','-----BEGIN','3DS\x20URL:','Result\x20URL:','\x20\x20\x20-\x20merchant_point_id:','text','POST','Unknown\x20error','🛑\x20Stopped\x20','randomBytes','toLowerCase','last_name','prototype','MasterCard\x20webhook\x20sent\x20to\x20','****','paid','Private\x20key\x20file\x20not\x20found:\x20','✅\x20Status\x20response\x20decrypted\x20successfully','message','cwd','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','trim','❌\x20RSA\x20encryption\x20failed:','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','76365McKqDq','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20','PENDING','payment','customerEmail','Processing\x20MasterCard\x20webhook:','scheduleStatusChecks','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','✅\x20Scheduled\x20','currency','mastercard','number','🔐\x20AES\x20IV\x20length:','final','length','charge','shopId','none','❌\x20Data\x20being\x20signed:','Response\x20Body:','270yYxIGz','FAILED','24222080aytCNK','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','10187109qKcFxh','end','utf8','...','sendShopWebhook','webhookUrl','Order\x20ID:','\x20status\x20updated\x20to\x20','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','3ds_url','amount','payment_id','base64','decryptResponsePhp','expire_month','decryptAES','/status','description','createDecipheriv','🔐\x20Data\x20encrypted\x20with\x20AES','Amount:','\x20characters','includes','update','ms)','keys','updatePaymentStatus','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','-----END','checkPaymentStatus','__createBinding','stringify','crypto','findUnique','error','/status_decrypted','existsSync','constants','\x20\x20\x20-\x20info\x20length:','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','private.pem','toString','===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20===','logWhiteDomainError','PHP\x20decryptor\x20error','⏰\x20Will\x20check\x20status\x20','statusCheckTimers','size','https://api.paydmeth.com/api','🔍\x20MasterCard\x20status\x20check\x20#',',\x20body:\x20','toUpperCase','Failed\x20to\x20send\x20payment\x20notifications:','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','📊\x20Status\x20check\x20result:','substring','\x20result:','PAID','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','aes-256-ctr','/status_raw','Webhook\x20event\x20','Response\x20Time:','Failed\x20to\x20decrypt\x20response\x20via\x20PHP','logWhiteDomainRequest','7ZICIGh','Status\x20decryption\x20failed:\x20','json','createdAt','4600BoklLc','logShopWebhookError','MasterCard\x20status\x20check\x20error:','customerName','expire_year','now','📝\x20Signature\x20length:','privateDecrypt','Decryption\x20failed:\x20','privateKeyPath','❌\x20RSA\x20signing\x20failed:','Final:','encryptRSA','log','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','❌\x20Failed\x20to\x20decrypt\x20status\x20response:','webhookEvents','HTTP\x20error!\x20status:\x20','Payment\x20ID:','❌\x20Status\x20check\x20#','from','forEach','📝\x20Data\x20to\x20sign\x20length:','Failed\x20to\x20decrypt\x20response','Error\x20parsing\x20webhook\x20events:','/charge','HTTP\x20','💳\x20MasterCard\x20service\x20initialized','4202511TCOzKr','hasOwnProperty','logWhiteDomainResponse','❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):','\x20not\x20enabled\x20for\x20shop\x20','apiUrl',',\x20Desc:\x20','❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20','sign','configurable','failed','payment.failed','2353744IpfcYK','TesSoft\x20Payment\x20System/1.0','floor','\x20MasterCard\x20status\x20check\x20timers','get','publicKeyPath','parse','../telegramBotService','shop','decryptResponse','MasterCard:\x20','desc','validateKeyFiles','gatewayOrderId','slice','🧹\x20Clearing\x20','Public\x20key\x20file\x20not\x20found:\x20','processWebhook','__setModuleDefault','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','loggerService','Status:','../../config/database','1111','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','https://api2.trapay.uk/decrypt.php','537renFdy','📝\x20Encrypted\x20key\x20length:','\x20\x20\x20-\x20key\x20length:',',\x20Final:\x20','\x20for\x20payment\x20','order_id','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','MasterCardService','resolve','signRSA','/charge_raw'];a42_0x191c=function(){return _0x1fc76a;};return a42_0x191c();}var __createBinding=this&&this[a42_0x3c2e6b(0x92)]||(Object[a42_0x3c2e6b(0x11b)]?function(_0x29e66c,_0x9d524d,_0x7a22fe,_0x55df1c){const _0x52fc28=a42_0x3c2e6b;if(_0x55df1c===undefined)_0x55df1c=_0x7a22fe;var _0x3563c0=Object[_0x52fc28(0x106)](_0x9d524d,_0x7a22fe);(!_0x3563c0||(_0x52fc28(0xe5)in _0x3563c0?!_0x9d524d['__esModule']:_0x3563c0[_0x52fc28(0x129)]||_0x3563c0[_0x52fc28(0xde)]))&&(_0x3563c0={'enumerable':!![],'get':function(){return _0x9d524d[_0x7a22fe];}}),Object[_0x52fc28(0x119)](_0x29e66c,_0x55df1c,_0x3563c0);}:function(_0x509e6b,_0x2b078e,_0x4602f3,_0x319569){if(_0x319569===undefined)_0x319569=_0x4602f3;_0x509e6b[_0x319569]=_0x2b078e[_0x4602f3];}),__setModuleDefault=this&&this[a42_0x3c2e6b(0xf3)]||(Object[a42_0x3c2e6b(0x11b)]?function(_0x136a2b,_0x5b16b5){const _0x22f5dc=a42_0x3c2e6b;Object['defineProperty'](_0x136a2b,_0x22f5dc(0x135),{'enumerable':!![],'value':_0x5b16b5});}:function(_0x1a6cac,_0x5ab30e){const _0x5843a6=a42_0x3c2e6b;_0x1a6cac[_0x5843a6(0x135)]=_0x5ab30e;}),__importStar=this&&this[a42_0x3c2e6b(0x114)]||(function(){var _0x5356d8=function(_0x506cc6){const _0x175421=a42_0x1d40;return _0x5356d8=Object[_0x175421(0x137)]||function(_0x432d5c){const _0x8cba4d=_0x175421;var _0x31b101=[];for(var _0x495405 in _0x432d5c)if(Object[_0x8cba4d(0x146)][_0x8cba4d(0xd6)][_0x8cba4d(0x12e)](_0x432d5c,_0x495405))_0x31b101[_0x31b101[_0x8cba4d(0x162)]]=_0x495405;return _0x31b101;},_0x5356d8(_0x506cc6);};return function(_0x1f20d3){const _0x155bd0=a42_0x1d40;if(_0x1f20d3&&_0x1f20d3[_0x155bd0(0x120)])return _0x1f20d3;var _0x4eb16d={};if(_0x1f20d3!=null){for(var _0x1095b0=_0x5356d8(_0x1f20d3),_0x307e49=0x0;_0x307e49<_0x1095b0[_0x155bd0(0x162)];_0x307e49++)if(_0x1095b0[_0x307e49]!==_0x155bd0(0x135))__createBinding(_0x4eb16d,_0x1f20d3,_0x1095b0[_0x307e49]);}return __setModuleDefault(_0x4eb16d,_0x1f20d3),_0x4eb16d;};}()),__importDefault=this&&this[a42_0x3c2e6b(0x130)]||function(_0x5003d6){return _0x5003d6&&_0x5003d6['__esModule']?_0x5003d6:{'default':_0x5003d6};};Object[a42_0x3c2e6b(0x119)](exports,a42_0x3c2e6b(0x120),{'value':!![]}),exports['MasterCardService']=void 0x0;const crypto_1=__importDefault(require(a42_0x3c2e6b(0x94))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0x3c2e6b(0x12d))),loggerService_1=require(a42_0x3c2e6b(0x118));class MasterCardService{constructor(){const _0x977c1e=a42_0x3c2e6b;this['statusCheckTimers']=new Map(),this['apiUrl']=_0x977c1e(0xa4),this[_0x977c1e(0x11e)]=0x67c,this['privateKeyPath']=path_1[_0x977c1e(0x135)]['join'](process[_0x977c1e(0x14d)](),_0x977c1e(0x8d),_0x977c1e(0x9c)),this[_0x977c1e(0xe6)]=path_1[_0x977c1e(0x135)][_0x977c1e(0x13a)](process[_0x977c1e(0x14d)](),_0x977c1e(0x8d),'psp_public.pem'),console[_0x977c1e(0xc6)](_0x977c1e(0xd4)),console[_0x977c1e(0xc6)](_0x977c1e(0x117),this[_0x977c1e(0xc2)]),console[_0x977c1e(0xc6)]('🔐\x20Public\x20key\x20path:',this[_0x977c1e(0xe6)]),this[_0x977c1e(0xed)]();}[a42_0x3c2e6b(0xed)](){const _0x5d3522=a42_0x3c2e6b;try{if(!fs_1[_0x5d3522(0x135)]['existsSync'](this[_0x5d3522(0xc2)]))throw new Error(_0x5d3522(0x14a)+this['privateKeyPath']);if(!fs_1['default'][_0x5d3522(0x98)](this[_0x5d3522(0xe6)]))throw new Error(_0x5d3522(0xf1)+this[_0x5d3522(0xe6)]);const _0x40feea=fs_1[_0x5d3522(0x135)]['readFileSync'](this[_0x5d3522(0xc2)],'utf8')[_0x5d3522(0x14f)](),_0x6d8615=fs_1[_0x5d3522(0x135)][_0x5d3522(0x127)](this[_0x5d3522(0xe6)],_0x5d3522(0x16e))['trim']();if(!_0x40feea['includes'](_0x5d3522(0x13b))||!_0x40feea[_0x5d3522(0x8a)](_0x5d3522(0x90)))throw new Error(_0x5d3522(0x14e));if(!_0x6d8615['includes'](_0x5d3522(0x13b))||!_0x6d8615['includes'](_0x5d3522(0x90)))throw new Error(_0x5d3522(0x8f));console['log'](_0x5d3522(0x101)),console['log']('🔐\x20Private\x20key\x20length:\x20'+_0x40feea[_0x5d3522(0x162)]+_0x5d3522(0x89)),console[_0x5d3522(0xc6)]('🔐\x20Public\x20key\x20length:\x20'+_0x6d8615[_0x5d3522(0x162)]+_0x5d3522(0x89));}catch(_0x134939){console[_0x5d3522(0x96)](_0x5d3522(0x139),_0x134939);throw _0x134939;}}[a42_0x3c2e6b(0x10b)](){const _0xd10154=a42_0x3c2e6b,_0x5ba3e0=crypto_1['default'][_0xd10154(0x143)](0x20),_0x318ed9=crypto_1[_0xd10154(0x135)][_0xd10154(0x143)](0x10);return{'key':_0x5ba3e0,'iv':_0x318ed9};}['encryptAES'](_0x31415d,_0x4e3dad,_0x4194ac){const _0x968206=a42_0x3c2e6b,_0x3e9a6b=crypto_1['default']['createCipheriv'](_0x968206(0xaf),_0x4e3dad,_0x4194ac);let _0x2993ef=_0x3e9a6b[_0x968206(0x8b)](_0x31415d,_0x968206(0x16e),_0x968206(0x80));return _0x2993ef+=_0x3e9a6b[_0x968206(0x161)]('base64'),_0x2993ef;}[a42_0x3c2e6b(0xc5)](_0x1d4887,_0x5e32c9){const _0x26d00f=a42_0x3c2e6b;try{const _0x1ae167=fs_1[_0x26d00f(0x135)][_0x26d00f(0x127)](this[_0x26d00f(0xe6)],_0x26d00f(0x16e))[_0x26d00f(0x14f)](),_0x388019={'iv':_0x5e32c9['toString']('base64'),'key':_0x1d4887[_0x26d00f(0x9d)](_0x26d00f(0x80))},_0x4ccdaa=JSON[_0x26d00f(0x93)](_0x388019);console[_0x26d00f(0xc6)](_0x26d00f(0x151),_0x4ccdaa[_0x26d00f(0x162)]);const _0x209aea=crypto_1[_0x26d00f(0x135)]['publicEncrypt']({'key':_0x1ae167,'padding':crypto_1[_0x26d00f(0x135)][_0x26d00f(0x99)]['RSA_PKCS1_PADDING']},Buffer[_0x26d00f(0xcd)](_0x4ccdaa));return console[_0x26d00f(0xc6)](_0x26d00f(0x174),_0x209aea['length']),_0x209aea[_0x26d00f(0x9d)]('base64');}catch(_0x26d349){console['error'](_0x26d00f(0x150),_0x26d349);throw new Error(_0x26d00f(0x138));}}['signRSA'](_0x23486e){const _0x4cf378=a42_0x3c2e6b;try{const _0x4ffd35=fs_1[_0x4cf378(0x135)][_0x4cf378(0x127)](this[_0x4cf378(0xc2)],'utf8')[_0x4cf378(0x14f)](),_0xc2f6cc=crypto_1[_0x4cf378(0x135)]['createSign'](_0x4cf378(0x123));_0xc2f6cc[_0x4cf378(0x8b)](_0x23486e),_0xc2f6cc[_0x4cf378(0x16d)]();const _0x5e60e8=_0xc2f6cc['sign'](_0x4ffd35,'base64');return console[_0x4cf378(0xc6)]('🔐\x20RSA\x20signing\x20successful'),console[_0x4cf378(0xc6)](_0x4cf378(0xcf),_0x23486e[_0x4cf378(0x162)]),console[_0x4cf378(0xc6)](_0x4cf378(0xbf),_0x5e60e8[_0x4cf378(0x162)]),_0x5e60e8;}catch(_0x359940){console[_0x4cf378(0x96)](_0x4cf378(0xc3),_0x359940),console[_0x4cf378(0x96)](_0x4cf378(0x166),_0x23486e[_0x4cf378(0xab)](0x0,0xc8)+_0x4cf378(0x16f));throw new Error(_0x4cf378(0x9b));}}[a42_0x3c2e6b(0x83)](_0x1e3c36,_0x9b0f53,_0x5b9642){const _0x548145=a42_0x3c2e6b,_0x271952=crypto_1[_0x548145(0x135)][_0x548145(0x86)](_0x548145(0xaf),_0x9b0f53,_0x5b9642);let _0x37315b=_0x271952[_0x548145(0x8b)](_0x1e3c36,_0x548145(0x80),_0x548145(0x16e));return _0x37315b+=_0x271952[_0x548145(0x161)](_0x548145(0x16e)),_0x37315b;}async[a42_0x3c2e6b(0x81)](_0x33df75,_0x15485b){const _0x47935f=a42_0x3c2e6b;try{const _0x19f51e=await fetch(_0x47935f(0xfa),{'method':_0x47935f(0x140),'headers':{'Content-Type':_0x47935f(0x128)},'body':JSON[_0x47935f(0x93)]({'info':_0x33df75,'key':_0x15485b})});if(!_0x19f51e['ok'])throw new Error(_0x47935f(0xa0));return await _0x19f51e[_0x47935f(0x13f)]();}catch(_0x559308){console[_0x47935f(0x96)](_0x47935f(0x10a),_0x559308);throw new Error(_0x47935f(0xb3));}}[a42_0x3c2e6b(0xea)](_0x18da10,_0x3eb1c6){const _0x406cfc=a42_0x3c2e6b;try{const _0x316f8d=fs_1[_0x406cfc(0x135)][_0x406cfc(0x127)](this[_0x406cfc(0xc2)],'utf8')[_0x406cfc(0x14f)](),_0xa76861=crypto_1[_0x406cfc(0x135)][_0x406cfc(0xc0)](_0x316f8d,Buffer[_0x406cfc(0xcd)](_0x3eb1c6,'base64')),_0x2045a0=JSON[_0x406cfc(0xe7)](_0xa76861[_0x406cfc(0x9d)]()),_0x1242bc=Buffer[_0x406cfc(0xcd)](_0x2045a0[_0x406cfc(0x107)],'base64'),_0x1e0400=Buffer['from'](_0x2045a0['iv'],_0x406cfc(0x80));return this[_0x406cfc(0x83)](_0x18da10,_0x1242bc,_0x1e0400);}catch(_0xa9ab1f){throw new Error(_0x406cfc(0xd0));}}async['processCardPayment'](_0x52b7ec){const _0x40168b=a42_0x3c2e6b,{paymentId:_0xe7682c,orderId:_0x3598e3,amount:_0x349655,currency:_0x51d4d2,cardData:_0x42eebd,resultUrl:_0x2c6193,returnUrl:_0x56f650,cardHolder:_0x466935,browser:_0x2135bd}=_0x52b7ec;console[_0x40168b(0xc6)](_0x40168b(0x9e)),console['log'](_0x40168b(0xcb),_0xe7682c),console[_0x40168b(0xc6)](_0x40168b(0x172),_0x3598e3),console[_0x40168b(0xc6)](_0x40168b(0x88),_0x349655,_0x51d4d2),console['log']('Card\x20Number:',this[_0x40168b(0x126)](_0x42eebd['number'])),console[_0x40168b(0xc6)]('Card\x20Holder:',_0x466935['first_name']+'\x20'+_0x466935[_0x40168b(0x145)]),console[_0x40168b(0xc6)]('Return\x20URL:',_0x56f650),console['log'](_0x40168b(0x13d),_0x2c6193);const _0x22ae94={'amount':_0x349655,'currency':_0x51d4d2[_0x40168b(0xa7)](),'order_id':_0x3598e3,'result_url':_0x2c6193,'return_url':_0x56f650,'country':'','card':{'number':_0x42eebd[_0x40168b(0x15f)],'expire_month':_0x42eebd[_0x40168b(0x82)],'expire_year':_0x42eebd[_0x40168b(0xbd)],'cvv':_0x42eebd[_0x40168b(0x11f)]},'card_holder':_0x466935,'browser':_0x2135bd},_0x4581b7=JSON['stringify'](_0x22ae94);console[_0x40168b(0xc6)](_0x40168b(0x122)),console[_0x40168b(0xc6)](_0x40168b(0x16b)),console[_0x40168b(0xc6)](_0x4581b7),console[_0x40168b(0xc6)]('📝\x20Data\x20length:',_0x4581b7[_0x40168b(0x162)]);try{const {key:_0x5ca114,iv:_0x4406f4}=this[_0x40168b(0x10b)]();console['log']('🔐\x20AES\x20key\x20and\x20IV\x20generated'),console[_0x40168b(0xc6)](_0x40168b(0x116),_0x5ca114[_0x40168b(0x162)]),console['log'](_0x40168b(0x160),_0x4406f4[_0x40168b(0x162)]);const _0x54b24a=this[_0x40168b(0x12b)](_0x4581b7,_0x5ca114,_0x4406f4);console[_0x40168b(0xc6)](_0x40168b(0x87)),console['log']('📝\x20Encrypted\x20data\x20length:',_0x54b24a[_0x40168b(0x162)]);const _0x4c0acf=this[_0x40168b(0xc5)](_0x5ca114,_0x4406f4);console[_0x40168b(0xc6)]('🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA'),console['log'](_0x40168b(0xfc),_0x4c0acf['length']);const _0x114773=this['signRSA'](_0x4581b7);console[_0x40168b(0xc6)]('🔐\x20Data\x20signed\x20with\x20RSA'),console[_0x40168b(0xc6)](_0x40168b(0xbf),_0x114773['length']);const _0x3851d3={'merchant_point_id':this[_0x40168b(0x11e)],'method':_0x40168b(0x163),'info':_0x54b24a,'key':_0x4c0acf,'sign':_0x114773,'lang':'en'};console[_0x40168b(0xc6)](_0x40168b(0xae)),console[_0x40168b(0xc6)]('📝\x20Final\x20request\x20structure:'),console[_0x40168b(0xc6)](_0x40168b(0x13e),this[_0x40168b(0x11e)]),console[_0x40168b(0xc6)]('\x20\x20\x20-\x20method:\x20charge'),console[_0x40168b(0xc6)](_0x40168b(0x9a),_0x54b24a[_0x40168b(0x162)]),console[_0x40168b(0xc6)](_0x40168b(0xfd),_0x4c0acf[_0x40168b(0x162)]),console[_0x40168b(0xc6)](_0x40168b(0x134),_0x114773[_0x40168b(0x162)]),console['log'](_0x40168b(0x113)),loggerService_1[_0x40168b(0xf5)][_0x40168b(0xb4)](_0x40168b(0x15e),'/charge',_0x40168b(0x140),{'merchant_point_id':this[_0x40168b(0x11e)],'method':_0x40168b(0x163),'lang':'en'});const _0x411997=Date[_0x40168b(0xbe)](),_0x1419fa=await fetch(this['apiUrl'],{'method':_0x40168b(0x140),'headers':{'Content-Type':_0x40168b(0x128),'Accept':_0x40168b(0x128),'User-Agent':_0x40168b(0xe2)},'body':JSON['stringify'](_0x3851d3)}),_0x29a2b2=Date[_0x40168b(0xbe)]()-_0x411997;console[_0x40168b(0xc6)](_0x40168b(0xf4)),console['log'](_0x40168b(0xf6),_0x1419fa[_0x40168b(0x11d)]),console[_0x40168b(0xc6)](_0x40168b(0xb2),_0x29a2b2+'ms');if(!_0x1419fa['ok']){const _0x15fa1d=await _0x1419fa[_0x40168b(0x13f)]();console[_0x40168b(0x96)](_0x40168b(0x121),_0x1419fa['status']),console[_0x40168b(0x96)](_0x40168b(0x167),_0x15fa1d),loggerService_1[_0x40168b(0xf5)][_0x40168b(0xd7)](_0x40168b(0x15e),_0x40168b(0x105),_0x1419fa[_0x40168b(0x11d)],_0x15fa1d,_0x29a2b2),loggerService_1[_0x40168b(0xf5)][_0x40168b(0x9f)](_0x40168b(0x15e),_0x40168b(0xd2),_0x40168b(0xd3)+_0x1419fa[_0x40168b(0x11d)]+':\x20'+_0x15fa1d);throw new Error(_0x40168b(0xca)+_0x1419fa[_0x40168b(0x11d)]+_0x40168b(0xa6)+_0x15fa1d);}const _0x22cb32=await _0x1419fa[_0x40168b(0xb7)]();loggerService_1[_0x40168b(0xf5)][_0x40168b(0xd7)](_0x40168b(0x15e),_0x40168b(0x105),_0x1419fa['status'],_0x22cb32,_0x29a2b2),console[_0x40168b(0xc6)]('===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===');let _0x4e6fad=_0x22cb32;if(_0x22cb32['info']&&_0x22cb32[_0x40168b(0x107)]&&_0x22cb32[_0x40168b(0xdd)]){console[_0x40168b(0xc6)](_0x40168b(0x131));try{const _0x2f234a=await this[_0x40168b(0x81)](_0x22cb32['info'],_0x22cb32[_0x40168b(0x107)]);_0x4e6fad=JSON[_0x40168b(0xe7)](_0x2f234a),console[_0x40168b(0xc6)]('✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)'),loggerService_1[_0x40168b(0xf5)][_0x40168b(0xd7)]('mastercard',_0x40168b(0x133),_0x1419fa[_0x40168b(0x11d)],_0x4e6fad,_0x29a2b2),console['log'](_0x40168b(0xa9));}catch(_0x4085bb){console[_0x40168b(0x96)](_0x40168b(0xd8),_0x4085bb),loggerService_1['loggerService']['logWhiteDomainError'](_0x40168b(0x15e),'/charge_decrypt',_0x40168b(0xc1)+_0x4085bb),_0x4e6fad=_0x22cb32;}}else loggerService_1[_0x40168b(0xf5)][_0x40168b(0xd7)](_0x40168b(0x15e),_0x40168b(0x133),_0x1419fa[_0x40168b(0x11d)],_0x4e6fad,_0x29a2b2),console[_0x40168b(0xc6)](_0x40168b(0x110));console[_0x40168b(0xc6)](_0x40168b(0xf6),_0x4e6fad['status']),console['log'](_0x40168b(0xc4),_0x4e6fad[_0x40168b(0x161)]),console[_0x40168b(0xc6)](_0x40168b(0xcb),_0x4e6fad['payment_id']),console['log'](_0x40168b(0x13c),_0x4e6fad[_0x40168b(0x7d)]||_0x40168b(0x165));if(_0x4e6fad[_0x40168b(0x11d)]===0x64&&_0x4e6fad[_0x40168b(0x161)]===0x1)return console[_0x40168b(0xc6)]('✅\x20Payment\x20successful'),{'gateway_payment_id':_0x4e6fad[_0x40168b(0x7f)]?.['toString'](),'payment_url':_0x56f650,'requires_3ds':![],'status':'PAID','final':!![]};if(_0x4e6fad[_0x40168b(0x7d)])return console[_0x40168b(0xc6)](_0x40168b(0x11a)),this[_0x40168b(0x158)](_0xe7682c,_0x3598e3,_0x4e6fad[_0x40168b(0x7f)]?.[_0x40168b(0x9d)]()||_0x3598e3),{'gateway_payment_id':_0x4e6fad[_0x40168b(0x7f)]?.[_0x40168b(0x9d)](),'payment_url':_0x4e6fad[_0x40168b(0x7d)],'requires_3ds':!![],'threeds_url':_0x4e6fad[_0x40168b(0x7d)],'status':_0x40168b(0x154),'final':![]};let _0x144663=_0x4e6fad['desc']||_0x4e6fad[_0x40168b(0x14c)]||_0x40168b(0x141),_0xf7d295=_0x4e6fad[_0x40168b(0x11d)],_0x15ec55=_0x4e6fad['final'];return console[_0x40168b(0xc6)](_0x40168b(0xdc)+_0xf7d295+_0x40168b(0xfe)+_0x15ec55+_0x40168b(0xdb)+_0x144663),{'gateway_payment_id':_0x4e6fad['payment_id']?.[_0x40168b(0x9d)](),'payment_url':_0x56f650,'requires_3ds':![],'status':_0x40168b(0x169),'final':!![]};}catch(_0xae9875){console[_0x40168b(0x96)]('===\x20MASTERCARD\x20SERVICE\x20ERROR\x20==='),console[_0x40168b(0x96)]('Error\x20details:',_0xae9875),loggerService_1[_0x40168b(0xf5)]['logWhiteDomainError'](_0x40168b(0x15e),_0x40168b(0xd2),_0xae9875);throw new Error(_0x40168b(0x132)+(_0xae9875 instanceof Error?_0xae9875['message']:_0x40168b(0x141)));}}async[a42_0x3c2e6b(0x91)](_0x28e5f7,_0x338c0e){const _0x33fd92=a42_0x3c2e6b;console[_0x33fd92(0xc6)](_0x33fd92(0xc7)+_0x28e5f7+'\x20('+_0x338c0e+')');try{const _0x2192bc={'payment_id':_0x28e5f7,'order_id':_0x338c0e},_0xcd799=JSON[_0x33fd92(0x93)](_0x2192bc),{key:_0x3f7f44,iv:_0x21b632}=this[_0x33fd92(0x10b)](),_0x6919e0=this[_0x33fd92(0x12b)](_0xcd799,_0x3f7f44,_0x21b632),_0x4988db=this['encryptRSA'](_0x3f7f44,_0x21b632),_0x43d466=this[_0x33fd92(0x104)](_0xcd799),_0x287b01={'merchant_point_id':this[_0x33fd92(0x11e)],'method':_0x33fd92(0x11d),'info':_0x6919e0,'key':_0x4988db,'sign':_0x43d466,'lang':'en'};loggerService_1[_0x33fd92(0xf5)][_0x33fd92(0xb4)]('mastercard','/status',_0x33fd92(0x140),{'merchant_point_id':this[_0x33fd92(0x11e)],'method':_0x33fd92(0x11d),'lang':'en'});const _0x5dbd40=Date[_0x33fd92(0xbe)](),_0x52bcb5=await fetch(this[_0x33fd92(0xda)],{'method':_0x33fd92(0x140),'headers':{'Content-Type':'application/json','Accept':_0x33fd92(0x128),'User-Agent':_0x33fd92(0xe2)},'body':JSON[_0x33fd92(0x93)](_0x287b01)}),_0x27dc27=Date[_0x33fd92(0xbe)]()-_0x5dbd40;if(!_0x52bcb5['ok']){const _0xcfeeed=await _0x52bcb5[_0x33fd92(0x13f)]();loggerService_1[_0x33fd92(0xf5)][_0x33fd92(0xd7)](_0x33fd92(0x15e),_0x33fd92(0xb0),_0x52bcb5[_0x33fd92(0x11d)],_0xcfeeed,_0x27dc27);throw new Error(_0x33fd92(0xca)+_0x52bcb5['status']);}const _0x1e1cc6=await _0x52bcb5['json']();loggerService_1[_0x33fd92(0xf5)]['logWhiteDomainResponse'](_0x33fd92(0x15e),_0x33fd92(0xb0),_0x52bcb5[_0x33fd92(0x11d)],_0x1e1cc6,_0x27dc27);let _0x333d86=_0x1e1cc6;if(_0x1e1cc6['info']&&_0x1e1cc6['key']&&_0x1e1cc6[_0x33fd92(0xdd)]){console[_0x33fd92(0xc6)](_0x33fd92(0x159));try{const _0x283c11=this['decryptResponse'](_0x1e1cc6['info'],_0x1e1cc6[_0x33fd92(0x107)]);_0x333d86=JSON[_0x33fd92(0xe7)](_0x283c11),console[_0x33fd92(0xc6)](_0x33fd92(0x14b)),loggerService_1[_0x33fd92(0xf5)][_0x33fd92(0xd7)](_0x33fd92(0x15e),_0x33fd92(0x97),_0x52bcb5[_0x33fd92(0x11d)],_0x333d86,_0x27dc27),console[_0x33fd92(0xc6)]('📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted');}catch(_0x24dc26){console[_0x33fd92(0x96)](_0x33fd92(0xc8),_0x24dc26),loggerService_1['loggerService'][_0x33fd92(0x9f)](_0x33fd92(0x15e),_0x33fd92(0x11c),_0x33fd92(0xb6)+_0x24dc26),_0x333d86=_0x1e1cc6;}}else loggerService_1[_0x33fd92(0xf5)][_0x33fd92(0xd7)](_0x33fd92(0x15e),_0x33fd92(0x97),_0x52bcb5[_0x33fd92(0x11d)],_0x333d86,_0x27dc27),console[_0x33fd92(0xc6)](_0x33fd92(0x10d));console[_0x33fd92(0xc6)](_0x33fd92(0xaa),{'status':_0x333d86[_0x33fd92(0x11d)],'final':_0x333d86[_0x33fd92(0x161)],'payment_id':_0x333d86[_0x33fd92(0x7f)],'desc':_0x333d86[_0x33fd92(0xec)]});let _0x453095=_0x33fd92(0x154);if(_0x333d86[_0x33fd92(0x11d)]===0x1&&_0x333d86['final']===0x1)_0x453095=_0x33fd92(0xad);else _0x333d86[_0x33fd92(0x11d)]===0x0&&_0x333d86[_0x33fd92(0x161)]===0x0?_0x453095=_0x33fd92(0x154):_0x453095=_0x33fd92(0x169);return{'status':_0x453095,'final':_0x333d86[_0x33fd92(0x161)]===0x1,'amount':_0x333d86[_0x33fd92(0x7e)],'currency':_0x333d86[_0x33fd92(0x15d)],'date_success':_0x333d86[_0x33fd92(0x10f)],'description':_0x333d86[_0x33fd92(0xec)]};}catch(_0x30508b){console[_0x33fd92(0x96)](_0x33fd92(0xbb),_0x30508b),loggerService_1[_0x33fd92(0xf5)]['logWhiteDomainError'](_0x33fd92(0x15e),_0x33fd92(0x84),_0x30508b);throw new Error('Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20'+(_0x30508b instanceof Error?_0x30508b[_0x33fd92(0x14c)]:_0x33fd92(0x141)));}}[a42_0x3c2e6b(0x158)](_0x39e279,_0x2d602d,_0x3f5b9b){const _0x21ea6f=a42_0x3c2e6b;console[_0x21ea6f(0xc6)](_0x21ea6f(0x15a)+_0x39e279+'\x20('+_0x3f5b9b+')'),this['clearStatusTimers'](_0x39e279);const _0x284e01=[],_0xc42c70=0x5*0x3c*0x3e8,_0x393e5f=0x2*0x3c*0x3c*0x3e8,_0x4f46b4=Math[_0x21ea6f(0xe3)](_0x393e5f/_0xc42c70);console['log'](_0x21ea6f(0xa1)+_0x4f46b4+_0x21ea6f(0xf9));for(let _0xf464c8=0x1;_0xf464c8<=_0x4f46b4;_0xf464c8++){const _0x5712f3=setTimeout(async()=>{const _0x25169b=_0x21ea6f;console[_0x25169b(0xc6)](_0x25169b(0xa5)+_0xf464c8+'/'+_0x4f46b4+_0x25169b(0xff)+_0x39e279);try{const _0x97063f=await this[_0x25169b(0x91)](_0x3f5b9b,_0x2d602d);console['log']('📊\x20Status\x20check\x20#'+_0xf464c8+_0x25169b(0xac),_0x97063f),_0x97063f[_0x25169b(0x161)]&&(console['log']('✅\x20Payment\x20'+_0x39e279+'\x20is\x20final\x20('+_0x97063f[_0x25169b(0x11d)]+'),\x20stopping\x20status\x20checks'),this[_0x25169b(0x109)](_0x39e279),await this['updatePaymentStatus'](_0x39e279,_0x97063f['status'],_0x97063f));}catch(_0x1d84f3){console[_0x25169b(0x96)](_0x25169b(0xcc)+_0xf464c8+'\x20failed\x20for\x20payment\x20'+_0x39e279+':',_0x1d84f3);}},_0xf464c8*_0xc42c70);_0x284e01['push'](_0x5712f3);}this[_0x21ea6f(0xa2)]['set'](_0x39e279,_0x284e01),console[_0x21ea6f(0xc6)](_0x21ea6f(0x15c)+_0x4f46b4+_0x21ea6f(0x12f)+_0x39e279);}[a42_0x3c2e6b(0x109)](_0x50058b){const _0x3e7e3c=a42_0x3c2e6b,_0x3035b5=this['statusCheckTimers'][_0x3e7e3c(0xe5)](_0x50058b);_0x3035b5&&(console[_0x3e7e3c(0xc6)](_0x3e7e3c(0xf0)+_0x3035b5['length']+'\x20status\x20timers\x20for\x20payment\x20'+_0x50058b),_0x3035b5[_0x3e7e3c(0xce)]((_0x50a480,_0x2c3089)=>{clearTimeout(_0x50a480);}),this[_0x3e7e3c(0xa2)][_0x3e7e3c(0x115)](_0x50058b));}async[a42_0x3c2e6b(0x8e)](_0x42d41d,_0x4fe12f,_0xec549b){const _0x157b91=a42_0x3c2e6b;try{const _0x1f6305=(await Promise[_0x157b91(0x103)]()[_0x157b91(0x136)](()=>__importStar(require('../../config/database'))))[_0x157b91(0x135)],_0x42ffe2={'status':_0x4fe12f[_0x157b91(0xa7)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x4fe12f==='PAID'&&(_0x42ffe2['paidAt']=new Date()),_0xec549b['description']&&(_0x42ffe2['adminNotes']=_0x157b91(0xeb)+_0xec549b[_0x157b91(0x85)]),await _0x1f6305[_0x157b91(0x155)]['update']({'where':{'id':_0x42d41d},'data':_0x42ffe2}),console[_0x157b91(0xc6)](_0x157b91(0x10c)+_0x42d41d+_0x157b91(0x173)+_0x4fe12f),await this['sendPaymentNotifications'](_0x42d41d,_0x4fe12f);}catch(_0x29c942){console[_0x157b91(0x96)](_0x157b91(0x153)+_0x42d41d+':',_0x29c942);}}async['sendPaymentNotifications'](_0x56471d,_0x3981a5){const _0x31c6c6=a42_0x3c2e6b;try{const _0x2efb46=(await Promise[_0x31c6c6(0x103)]()[_0x31c6c6(0x136)](()=>__importStar(require(_0x31c6c6(0xf7)))))[_0x31c6c6(0x135)],{telegramBotService:_0x1bde1e}=await Promise[_0x31c6c6(0x103)]()[_0x31c6c6(0x136)](()=>__importStar(require(_0x31c6c6(0xe8)))),_0x481f5a=await _0x2efb46['payment'][_0x31c6c6(0x95)]({'where':{'id':_0x56471d},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x481f5a)return;const _0x1c9d9f={'PAID':_0x31c6c6(0x149),'FAILED':_0x31c6c6(0xdf)},_0x4795f5=_0x1c9d9f[_0x3981a5];_0x4795f5&&await _0x1bde1e[_0x31c6c6(0x10e)](_0x481f5a[_0x31c6c6(0x164)],_0x481f5a,_0x4795f5),await this[_0x31c6c6(0x170)](_0x481f5a,_0x3981a5);}catch(_0x192f7b){console['error'](_0x31c6c6(0xa8),_0x192f7b);}}async['sendShopWebhook'](_0xa7392a,_0x463b55){const _0xde7606=a42_0x3c2e6b,_0x1fa26c=Date[_0xde7606(0xbe)]();try{const _0x360057=_0xa7392a[_0xde7606(0xe9)],_0x32330b=_0x360057['settings'];if(!_0x32330b?.[_0xde7606(0x171)]){console['log'](_0xde7606(0x12c)+_0x360057['id']);return;}const _0x4b5411=_0x463b55===_0xde7606(0xad)?'payment.success':_0xde7606(0xe0);let _0x10c321=[];if(_0x32330b[_0xde7606(0xc9)])try{_0x10c321=Array['isArray'](_0x32330b['webhookEvents'])?_0x32330b['webhookEvents']:JSON[_0xde7606(0xe7)](_0x32330b['webhookEvents']);}catch(_0x37f6f5){console[_0xde7606(0x96)](_0xde7606(0xd1),_0x37f6f5),_0x10c321=[];}if(!_0x10c321[_0xde7606(0x8a)](_0x4b5411)){console['log'](_0xde7606(0xb1)+_0x4b5411+_0xde7606(0xd9)+_0x360057['id']);return;}const _0x57ceeb={'event':_0x4b5411,'payment':{'id':_0xa7392a['id'],'order_id':_0xa7392a[_0xde7606(0x12a)],'gateway_order_id':_0xa7392a[_0xde7606(0xee)],'gateway':_0xde7606(0xf8),'amount':_0xa7392a['amount'],'currency':_0xa7392a['currency'],'status':_0x463b55[_0xde7606(0x144)](),'customer_email':_0xa7392a[_0xde7606(0x156)],'customer_name':_0xa7392a[_0xde7606(0xbc)],'created_at':_0xa7392a[_0xde7606(0xb8)],'updated_at':new Date()}},_0x3db35e=await fetch(_0x32330b['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0xde7606(0x128),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON['stringify'](_0x57ceeb)}),_0x2fd147=Date[_0xde7606(0xbe)]()-_0x1fa26c;loggerService_1[_0xde7606(0xf5)][_0xde7606(0x124)](_0xa7392a[_0xde7606(0x164)],_0x32330b[_0xde7606(0x171)],_0x4b5411,_0x3db35e[_0xde7606(0x11d)],_0x2fd147,_0x57ceeb),console[_0xde7606(0xc6)](_0xde7606(0x147)+_0x32330b['webhookUrl']+_0xde7606(0x111)+_0x3db35e[_0xde7606(0x11d)]+'\x20('+_0x2fd147+_0xde7606(0x8c));}catch(_0x8d9910){console[_0xde7606(0x96)](_0xde7606(0x108),_0x8d9910),loggerService_1[_0xde7606(0xf5)][_0xde7606(0xba)](_0xa7392a[_0xde7606(0x164)],_0xa7392a[_0xde7606(0xe9)]?.['settings']?.[_0xde7606(0x171)]||_0xde7606(0x125),'webhook_send',_0x8d9910,{});}}[a42_0x3c2e6b(0x126)](_0x1a354a){const _0x2980e3=a42_0x3c2e6b,_0xc1d208=_0x1a354a['replace'](/[\s-]/g,'');if(_0xc1d208[_0x2980e3(0x162)]<0x4)return _0x2980e3(0x148);return'****\x20****\x20****\x20'+_0xc1d208[_0x2980e3(0xef)](-0x4);}async[a42_0x3c2e6b(0xf2)](_0x577c12){const _0x4c4f0e=a42_0x3c2e6b;console[_0x4c4f0e(0xc6)](_0x4c4f0e(0x157),_0x577c12);let _0x1d13ca=_0x4c4f0e(0x154);if(_0x577c12[_0x4c4f0e(0x11d)]===0x1&&_0x577c12[_0x4c4f0e(0x161)]===0x1)_0x1d13ca=_0x4c4f0e(0xad);else _0x577c12[_0x4c4f0e(0x11d)]===0x0&&_0x577c12['final']===0x0?_0x1d13ca='PENDING':_0x1d13ca=_0x4c4f0e(0x169);return{'paymentId':_0x577c12[_0x4c4f0e(0x100)]||'','status':_0x1d13ca,'amount':_0x577c12['amount'],'currency':_0x577c12[_0x4c4f0e(0x15d)]};}['stopAllStatusChecks'](){const _0x4c44a8=a42_0x3c2e6b;console[_0x4c44a8(0xc6)](_0x4c44a8(0x15b));const _0x25290e=this[_0x4c44a8(0xa2)][_0x4c44a8(0xa3)];for(const [_0x5de45a]of this[_0x4c44a8(0xa2)]){this[_0x4c44a8(0x109)](_0x5de45a);}console[_0x4c44a8(0xc6)](_0x4c44a8(0x142)+_0x25290e+_0x4c44a8(0xe4));}}exports[a42_0x3c2e6b(0x102)]=MasterCardService;