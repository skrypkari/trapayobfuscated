'use strict';const a42_0x415cd6=a42_0x18bc;function a42_0xb801(){const _0x382d93=['webhookEvents','validateKeyFiles','publicEncrypt','sendShopWebhook','mastercard','default','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','Status\x20decryption\x20failed:\x20','application/json','shop','Order\x20ID:','PHP\x20decryptor\x20error','✅\x20Scheduled\x20','Status:','desc','generateAESKey','📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','Failed\x20to\x20decrypt\x20response','update','Webhook\x20event\x20','/status_decrypt','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','status','3DS\x20URL:','prototype','\x20\x20\x20-\x20merchant_point_id:','defineProperty','../loggerService','/charge_decrypt','call','384251GFVMcg','includes','toString','key','error','existsSync','../../config/database','now','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','\x20with\x20status\x20','crypto','226953GEYAES','encryptAES','36xGMlAh','MasterCard\x20webhook\x20sent\x20to\x20','__importStar','webhook_send','aes-256-ctr','⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20','__createBinding','merchantPointId','🔐\x20Data\x20signed\x20with\x20RSA','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','charge','Payment\x20ID:','/status','configurable','paidAt','Processing\x20MasterCard\x20webhook:','\x20not\x20enabled\x20for\x20shop\x20','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','delete','🔐\x20RSA\x20signing\x20successful','FAILED','createdAt','path','\x20\x20\x20-\x20info\x20length:','🔐\x20Public\x20key\x20length:\x20','privateKeyPath','createSign','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','scheduleStatusChecks','✅\x20Payment\x20','\x20status\x20updated\x20to\x20','expire_month','base64','signRSA','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','encryptRSA','shopId','utf8','🔐\x20AES\x20IV\x20length:','\x20\x20\x20-\x20sign\x20length:','❌\x20Status\x20check\x20#','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','__esModule','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','checkPaymentStatus','Failed\x20to\x20send\x20payment\x20notifications:','system','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','processWebhook','❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','expire_year','📝\x20Signature\x20length:','26YYRMAh','failed','payment_id','randomBytes','TesSoft\x20Payment\x20System/1.0','text','publicKeyPath','1111','📝\x20Encrypted\x20data\x20length:','sign','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','🔐\x203DS\x20verification\x20required','payment','279ToVzGA','json','sendPaymentNotification','privateDecrypt','1610ROZpKW','final','paid','message','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','settings','\x20status\x20checks\x20for\x20payment\x20','✅\x20Status\x20response\x20decrypted\x20successfully','...','Failed\x20to\x20decrypt\x20response\x20via\x20PHP','❌\x20MasterCard\x20key\x20validation\x20failed:','Private\x20key\x20file\x20not\x20found:\x20','💳\x20MasterCard\x20service\x20initialized','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','get','Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20','payment.success','Public\x20key\x20file\x20not\x20found:\x20','set','number','clearStatusTimers','\x20failed\x20for\x20payment\x20','\x20characters','createDecipheriv','📝\x20Final\x20request\x20structure:','from','🛑\x20Stopped\x20','Amount:','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','create','updatePaymentStatus','PENDING','),\x20stopping\x20status\x20checks','MasterCard\x20status\x20check\x20error:','stringify','3422148Jsdcvk','\x20is\x20final\x20(','3ds_url','PAID','🔍\x20MasterCard\x20status\x20check\x20#','replace','https://api2.trapay.uk/decrypt.php','\x20\x20\x20-\x20method:\x20charge','isArray','payment.failed','keys','trim','none','substring','toUpperCase','🔐\x20AES\x20key\x20length:',',\x20Desc:\x20','🔐\x20Private\x20key\x20length:\x20','/charge_raw','Card\x20Holder:','date_success','📝\x20Data\x20to\x20sign\x20length:','sendPaymentNotifications','MasterCard:\x20','Error\x20parsing\x20webhook\x20events:','length','cwd','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','amount','📊\x20Status\x20check\x20#','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','toLowerCase','readFileSync','3870240IgzWdz','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','🔐\x20AES\x20key\x20and\x20IV\x20generated','decryptResponsePhp','apiUrl','loggerService','private.pem','58785tSWxMO','last_name','🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA','webhookUrl','🔐\x20Public\x20key\x20path:','logShopWebhookSent','❌\x20RSA\x20signing\x20failed:','end','/status_decrypted','📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','33946crLRHj','🔐\x20Data\x20encrypted\x20with\x20AES','hasOwnProperty','decryptResponse','orderId','\x20result:','push','🧹\x20Clearing\x20','slice','statusCheckTimers','resolve','parse','ms)','\x20MasterCard\x20status\x20check\x20timers','\x20\x20\x20-\x20lang:\x20en','POST','decryptAES','Result\x20URL:','logWhiteDomainResponse','❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20','📝\x20Data\x20length:','log','44816mnXRTD','first_name','info','\x20\x20\x20-\x20key\x20length:','💾\x20Payment\x20data\x20prepared','__importDefault','📝\x20Encrypted\x20key\x20length:','****','getOwnPropertyDescriptor','Final:','logWhiteDomainError','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','join','currency','logShopWebhookError','/charge','-----END','HTTP\x20error!\x20status:\x20','stopAllStatusChecks','customerEmail','maskCardNumber','floor','order_id','Card\x20Number:',',\x20body:\x20','Response\x20Body:','Unknown\x20error','===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20===','🔐\x20Private\x20key\x20path:','-----BEGIN','customerName','https://api.paydmeth.com/api','cvv','❌\x20RSA\x20encryption\x20failed:'];a42_0xb801=function(){return _0x382d93;};return a42_0xb801();}(function(_0xa3d774,_0xec8275){const _0x53c3f9=a42_0x18bc,_0xaa470f=_0xa3d774();while(!![]){try{const _0x492b2d=-parseInt(_0x53c3f9(0xb2))/0x1+-parseInt(_0x53c3f9(0xe9))/0x2*(parseInt(_0x53c3f9(0x145))/0x3)+parseInt(_0x53c3f9(0x11d))/0x4+-parseInt(_0x53c3f9(0x13e))/0x5+-parseInt(_0x53c3f9(0xb4))/0x6*(-parseInt(_0x53c3f9(0x1a5))/0x7)+parseInt(_0x53c3f9(0x165))/0x8*(parseInt(_0x53c3f9(0xf6))/0x9)+parseInt(_0x53c3f9(0xfa))/0xa*(parseInt(_0x53c3f9(0x14f))/0xb);if(_0x492b2d===_0xec8275)break;else _0xaa470f['push'](_0xaa470f['shift']());}catch(_0x4a8a14){_0xaa470f['push'](_0xaa470f['shift']());}}}(a42_0xb801,0x92673));var __createBinding=this&&this[a42_0x415cd6(0xba)]||(Object[a42_0x415cd6(0x117)]?function(_0x11c523,_0xbd5f4c,_0x5e5cb8,_0x553fe7){const _0x1b9ce3=a42_0x415cd6;if(_0x553fe7===undefined)_0x553fe7=_0x5e5cb8;var _0xf35339=Object[_0x1b9ce3(0x16d)](_0xbd5f4c,_0x5e5cb8);(!_0xf35339||(_0x1b9ce3(0x108)in _0xf35339?!_0xbd5f4c['__esModule']:_0xf35339['writable']||_0xf35339[_0x1b9ce3(0xc1)]))&&(_0xf35339={'enumerable':!![],'get':function(){return _0xbd5f4c[_0x5e5cb8];}}),Object[_0x1b9ce3(0x1a1)](_0x11c523,_0x553fe7,_0xf35339);}:function(_0x51bff8,_0x3aecb6,_0x46b628,_0x3d03c3){if(_0x3d03c3===undefined)_0x3d03c3=_0x46b628;_0x51bff8[_0x3d03c3]=_0x3aecb6[_0x46b628];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a42_0x415cd6(0x117)]?function(_0x5275f5,_0x211251){const _0x1cc434=a42_0x415cd6;Object[_0x1cc434(0x1a1)](_0x5275f5,_0x1cc434(0x18c),{'enumerable':!![],'value':_0x211251});}:function(_0x970c2c,_0x4e710b){const _0x18a729=a42_0x415cd6;_0x970c2c[_0x18a729(0x18c)]=_0x4e710b;}),__importStar=this&&this[a42_0x415cd6(0xb6)]||(function(){var _0x6e113b=function(_0x47be55){return _0x6e113b=Object['getOwnPropertyNames']||function(_0x56264a){const _0x38bee2=a42_0x18bc;var _0x55bc42=[];for(var _0x3f184b in _0x56264a)if(Object[_0x38bee2(0x19f)][_0x38bee2(0x151)][_0x38bee2(0x1a4)](_0x56264a,_0x3f184b))_0x55bc42[_0x55bc42[_0x38bee2(0x136)]]=_0x3f184b;return _0x55bc42;},_0x6e113b(_0x47be55);};return function(_0x445d79){const _0x10d913=a42_0x18bc;if(_0x445d79&&_0x445d79[_0x10d913(0xde)])return _0x445d79;var _0x11f4c8={};if(_0x445d79!=null){for(var _0x4a9c17=_0x6e113b(_0x445d79),_0xdd08ce=0x0;_0xdd08ce<_0x4a9c17[_0x10d913(0x136)];_0xdd08ce++)if(_0x4a9c17[_0xdd08ce]!=='default')__createBinding(_0x11f4c8,_0x445d79,_0x4a9c17[_0xdd08ce]);}return __setModuleDefault(_0x11f4c8,_0x445d79),_0x11f4c8;};}()),__importDefault=this&&this[a42_0x415cd6(0x16a)]||function(_0x28172b){const _0x48f66d=a42_0x415cd6;return _0x28172b&&_0x28172b[_0x48f66d(0xde)]?_0x28172b:{'default':_0x28172b};};Object['defineProperty'](exports,a42_0x415cd6(0xde),{'value':!![]}),exports['MasterCardService']=void 0x0;const crypto_1=__importDefault(require(a42_0x415cd6(0xb1))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0x415cd6(0xca))),loggerService_1=require(a42_0x415cd6(0x1a2));function a42_0x18bc(_0x14a202,_0xfa3e3d){const _0xb801c3=a42_0xb801();return a42_0x18bc=function(_0x18bc06,_0x5a0e51){_0x18bc06=_0x18bc06-0xaa;let _0x2046d0=_0xb801c3[_0x18bc06];return _0x2046d0;},a42_0x18bc(_0x14a202,_0xfa3e3d);}class MasterCardService{constructor(){const _0x82521c=a42_0x415cd6;this[_0x82521c(0x158)]=new Map(),this['apiUrl']=_0x82521c(0x184),this[_0x82521c(0xbb)]=0x67c,this['privateKeyPath']=path_1[_0x82521c(0x18c)][_0x82521c(0x171)](process[_0x82521c(0x137)](),_0x82521c(0x127),_0x82521c(0x144)),this[_0x82521c(0xef)]=path_1[_0x82521c(0x18c)][_0x82521c(0x171)](process[_0x82521c(0x137)](),_0x82521c(0x127),'psp_public.pem'),console[_0x82521c(0x164)](_0x82521c(0x106)),console[_0x82521c(0x164)](_0x82521c(0x181),this[_0x82521c(0xcd)]),console[_0x82521c(0x164)](_0x82521c(0x149),this['publicKeyPath']),this[_0x82521c(0x188)]();}[a42_0x415cd6(0x188)](){const _0x5f45d7=a42_0x415cd6;try{if(!fs_1[_0x5f45d7(0x18c)][_0x5f45d7(0xac)](this[_0x5f45d7(0xcd)]))throw new Error(_0x5f45d7(0x105)+this[_0x5f45d7(0xcd)]);if(!fs_1[_0x5f45d7(0x18c)]['existsSync'](this[_0x5f45d7(0xef)]))throw new Error(_0x5f45d7(0x10b)+this[_0x5f45d7(0xef)]);const _0x59a819=fs_1[_0x5f45d7(0x18c)][_0x5f45d7(0x13d)](this[_0x5f45d7(0xcd)],_0x5f45d7(0xd9))['trim'](),_0x15f255=fs_1['default'][_0x5f45d7(0x13d)](this[_0x5f45d7(0xef)],_0x5f45d7(0xd9))['trim']();if(!_0x59a819[_0x5f45d7(0x1a6)](_0x5f45d7(0x182))||!_0x59a819[_0x5f45d7(0x1a6)](_0x5f45d7(0x175)))throw new Error(_0x5f45d7(0x116));if(!_0x15f255['includes'](_0x5f45d7(0x182))||!_0x15f255[_0x5f45d7(0x1a6)]('-----END'))throw new Error(_0x5f45d7(0xc5));console[_0x5f45d7(0x164)](_0x5f45d7(0x138)),console[_0x5f45d7(0x164)](_0x5f45d7(0x12e)+_0x59a819[_0x5f45d7(0x136)]+_0x5f45d7(0x110)),console[_0x5f45d7(0x164)](_0x5f45d7(0xcc)+_0x15f255['length']+_0x5f45d7(0x110));}catch(_0x2a8c35){console['error'](_0x5f45d7(0x104),_0x2a8c35);throw _0x2a8c35;}}[a42_0x415cd6(0x196)](){const _0x92c0b4=a42_0x415cd6,_0x25814a=crypto_1['default'][_0x92c0b4(0xec)](0x20),_0x1b240b=crypto_1[_0x92c0b4(0x18c)][_0x92c0b4(0xec)](0x10);return{'key':_0x25814a,'iv':_0x1b240b};}[a42_0x415cd6(0xb3)](_0x5610d7,_0xe961c7,_0x57687d){const _0x3fff27=a42_0x415cd6,_0x241a50=crypto_1['default']['createCipheriv'](_0x3fff27(0xb8),_0xe961c7,_0x57687d);let _0x18ed77=_0x241a50[_0x3fff27(0x199)](_0x5610d7,'utf8',_0x3fff27(0xd4));return _0x18ed77+=_0x241a50[_0x3fff27(0xfb)](_0x3fff27(0xd4)),_0x18ed77;}['encryptRSA'](_0x40a47f,_0x19ab36){const _0x464b91=a42_0x415cd6;try{const _0x1880ce=fs_1[_0x464b91(0x18c)][_0x464b91(0x13d)](this[_0x464b91(0xef)],_0x464b91(0xd9))[_0x464b91(0x128)](),_0x42b286={'iv':_0x19ab36[_0x464b91(0x1a7)](_0x464b91(0xd4)),'key':_0x40a47f[_0x464b91(0x1a7)](_0x464b91(0xd4))},_0x9ef934=JSON[_0x464b91(0x11c)](_0x42b286);console[_0x464b91(0x164)](_0x464b91(0xe6),_0x9ef934['length']);const _0x4abf2e=crypto_1['default'][_0x464b91(0x189)]({'key':_0x1880ce,'padding':crypto_1[_0x464b91(0x18c)]['constants']['RSA_PKCS1_PADDING']},Buffer[_0x464b91(0x113)](_0x9ef934));return console[_0x464b91(0x164)](_0x464b91(0xfe),_0x4abf2e[_0x464b91(0x136)]),_0x4abf2e['toString'](_0x464b91(0xd4));}catch(_0x4d6bac){console[_0x464b91(0xab)](_0x464b91(0x186),_0x4d6bac);throw new Error(_0x464b91(0x19c));}}[a42_0x415cd6(0xd5)](_0x481c8f){const _0xbbf37b=a42_0x415cd6;try{const _0x716b5e=fs_1[_0xbbf37b(0x18c)][_0xbbf37b(0x13d)](this[_0xbbf37b(0xcd)],'utf8')[_0xbbf37b(0x128)](),_0x1d949c=crypto_1[_0xbbf37b(0x18c)][_0xbbf37b(0xce)]('SHA256');_0x1d949c[_0xbbf37b(0x199)](_0x481c8f),_0x1d949c[_0xbbf37b(0x14c)]();const _0x59313a=_0x1d949c[_0xbbf37b(0xf2)](_0x716b5e,_0xbbf37b(0xd4));return console[_0xbbf37b(0x164)](_0xbbf37b(0xc7)),console[_0xbbf37b(0x164)](_0xbbf37b(0x132),_0x481c8f[_0xbbf37b(0x136)]),console[_0xbbf37b(0x164)]('📝\x20Signature\x20length:',_0x59313a[_0xbbf37b(0x136)]),_0x59313a;}catch(_0x7d4b11){console['error'](_0xbbf37b(0x14b),_0x7d4b11),console[_0xbbf37b(0xab)]('❌\x20Data\x20being\x20signed:',_0x481c8f[_0xbbf37b(0x12a)](0x0,0xc8)+_0xbbf37b(0x102));throw new Error(_0xbbf37b(0xdd));}}[a42_0x415cd6(0x15f)](_0x3e2964,_0x25b31d,_0x5ae5e3){const _0x1822ca=a42_0x415cd6,_0x2b521d=crypto_1['default'][_0x1822ca(0x111)](_0x1822ca(0xb8),_0x25b31d,_0x5ae5e3);let _0x3d9855=_0x2b521d[_0x1822ca(0x199)](_0x3e2964,_0x1822ca(0xd4),'utf8');return _0x3d9855+=_0x2b521d[_0x1822ca(0xfb)](_0x1822ca(0xd9)),_0x3d9855;}async['decryptResponsePhp'](_0x5b6ae8,_0xdce727){const _0x2b7e14=a42_0x415cd6;try{const _0x264208=await fetch(_0x2b7e14(0x123),{'method':_0x2b7e14(0x15e),'headers':{'Content-Type':_0x2b7e14(0x18f)},'body':JSON['stringify']({'info':_0x5b6ae8,'key':_0xdce727})});if(!_0x264208['ok'])throw new Error(_0x2b7e14(0x192));return await _0x264208[_0x2b7e14(0xee)]();}catch(_0x4cb0b8){console[_0x2b7e14(0xab)]('❌\x20PHP\x20decryptor\x20request\x20failed:',_0x4cb0b8);throw new Error(_0x2b7e14(0x103));}}[a42_0x415cd6(0x152)](_0x5a934d,_0x49dd15){const _0x4ccff0=a42_0x415cd6;try{const _0x4b1a3b=fs_1[_0x4ccff0(0x18c)][_0x4ccff0(0x13d)](this[_0x4ccff0(0xcd)],_0x4ccff0(0xd9))[_0x4ccff0(0x128)](),_0x132c5d=crypto_1[_0x4ccff0(0x18c)][_0x4ccff0(0xf9)](_0x4b1a3b,Buffer[_0x4ccff0(0x113)](_0x49dd15,'base64')),_0x25e7de=JSON[_0x4ccff0(0x15a)](_0x132c5d[_0x4ccff0(0x1a7)]()),_0x4dd461=Buffer[_0x4ccff0(0x113)](_0x25e7de[_0x4ccff0(0xaa)],_0x4ccff0(0xd4)),_0x2a292d=Buffer['from'](_0x25e7de['iv'],_0x4ccff0(0xd4));return this[_0x4ccff0(0x15f)](_0x5a934d,_0x4dd461,_0x2a292d);}catch(_0xd4e82c){throw new Error(_0x4ccff0(0x198));}}async['processCardPayment'](_0x538503){const _0x239205=a42_0x415cd6,{paymentId:_0x52229b,orderId:_0x283c72,amount:_0x2951ab,currency:_0x4d4d9d,cardData:_0x5ea4dd,resultUrl:_0x58a8a3,returnUrl:_0x31ad5c,cardHolder:_0x451358,browser:_0x255906}=_0x538503;console['log'](_0x239205(0x180)),console['log'](_0x239205(0xbf),_0x52229b),console['log'](_0x239205(0x191),_0x283c72),console[_0x239205(0x164)](_0x239205(0x115),_0x2951ab,_0x4d4d9d),console[_0x239205(0x164)](_0x239205(0x17c),this[_0x239205(0x179)](_0x5ea4dd[_0x239205(0x10d)])),console[_0x239205(0x164)](_0x239205(0x130),_0x451358[_0x239205(0x166)]+'\x20'+_0x451358[_0x239205(0x146)]),console[_0x239205(0x164)]('Return\x20URL:',_0x31ad5c),console[_0x239205(0x164)](_0x239205(0x160),_0x58a8a3);const _0x237169={'amount':_0x2951ab,'currency':_0x4d4d9d[_0x239205(0x12b)](),'order_id':_0x283c72,'result_url':_0x58a8a3,'return_url':_0x31ad5c,'card':{'number':_0x5ea4dd[_0x239205(0x10d)],'expire_month':_0x5ea4dd[_0x239205(0xd3)],'expire_year':_0x5ea4dd[_0x239205(0xe7)],'cvv':_0x5ea4dd[_0x239205(0x185)]},'card_holder':_0x451358,'browser':_0x255906},_0x4e01ea=JSON[_0x239205(0x11c)](_0x237169);console[_0x239205(0x164)](_0x239205(0x169)),console[_0x239205(0x164)](_0x239205(0xdf)),console[_0x239205(0x164)](_0x4e01ea),console[_0x239205(0x164)](_0x239205(0x163),_0x4e01ea[_0x239205(0x136)]);try{const {key:_0x22e410,iv:_0x5f173c}=this['generateAESKey']();console[_0x239205(0x164)](_0x239205(0x140)),console[_0x239205(0x164)](_0x239205(0x12c),_0x22e410['length']),console[_0x239205(0x164)](_0x239205(0xda),_0x5f173c[_0x239205(0x136)]);const _0x40f991=this['encryptAES'](_0x4e01ea,_0x22e410,_0x5f173c);console['log'](_0x239205(0x150)),console[_0x239205(0x164)](_0x239205(0xf1),_0x40f991[_0x239205(0x136)]);const _0x481b78=this[_0x239205(0xd7)](_0x22e410,_0x5f173c);console[_0x239205(0x164)](_0x239205(0x147)),console[_0x239205(0x164)](_0x239205(0x16b),_0x481b78[_0x239205(0x136)]);const _0x8e9750=this[_0x239205(0xd5)](_0x4e01ea);console[_0x239205(0x164)](_0x239205(0xbc)),console[_0x239205(0x164)](_0x239205(0xe8),_0x8e9750[_0x239205(0x136)]);const _0x5e9f4d={'merchant_point_id':this[_0x239205(0xbb)],'method':_0x239205(0xbe),'info':_0x40f991,'key':_0x481b78,'sign':_0x8e9750,'lang':'en'};console[_0x239205(0x164)](_0x239205(0x13f)),console[_0x239205(0x164)](_0x239205(0x112)),console['log'](_0x239205(0x1a0),this[_0x239205(0xbb)]),console[_0x239205(0x164)](_0x239205(0x124)),console['log'](_0x239205(0xcb),_0x40f991['length']),console[_0x239205(0x164)](_0x239205(0x168),_0x481b78['length']),console['log'](_0x239205(0xdb),_0x8e9750[_0x239205(0x136)]),console[_0x239205(0x164)](_0x239205(0x15d)),loggerService_1[_0x239205(0x143)]['logWhiteDomainRequest']('mastercard',_0x239205(0x174),'POST',{'merchant_point_id':this['merchantPointId'],'method':_0x239205(0xbe),'lang':'en'});const _0x534659=Date[_0x239205(0xae)](),_0x1e05e2=await fetch(this[_0x239205(0x142)],{'method':_0x239205(0x15e),'headers':{'Content-Type':'application/json','Accept':_0x239205(0x18f),'User-Agent':_0x239205(0xed)},'body':JSON[_0x239205(0x11c)](_0x5e9f4d)}),_0x2490df=Date[_0x239205(0xae)]()-_0x534659;console['log'](_0x239205(0xe3)),console[_0x239205(0x164)](_0x239205(0x194),_0x1e05e2['status']),console[_0x239205(0x164)]('Response\x20Time:',_0x2490df+'ms');if(!_0x1e05e2['ok']){const _0x5d6aad=await _0x1e05e2[_0x239205(0xee)]();console[_0x239205(0xab)]('HTTP\x20Status:',_0x1e05e2[_0x239205(0x19d)]),console['error'](_0x239205(0x17e),_0x5d6aad),loggerService_1['loggerService'][_0x239205(0x161)](_0x239205(0x18b),'/charge_raw',_0x1e05e2['status'],_0x5d6aad,_0x2490df),loggerService_1[_0x239205(0x143)]['logWhiteDomainError']('mastercard',_0x239205(0x174),'HTTP\x20'+_0x1e05e2[_0x239205(0x19d)]+':\x20'+_0x5d6aad);throw new Error(_0x239205(0x176)+_0x1e05e2[_0x239205(0x19d)]+_0x239205(0x17d)+_0x5d6aad);}const _0x3fc567=await _0x1e05e2['json']();loggerService_1[_0x239205(0x143)][_0x239205(0x161)]('mastercard',_0x239205(0x12f),_0x1e05e2[_0x239205(0x19d)],_0x3fc567,_0x2490df),console[_0x239205(0x164)]('===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===');let _0x2805e7=_0x3fc567;if(_0x3fc567[_0x239205(0x167)]&&_0x3fc567['key']&&_0x3fc567['sign']){console[_0x239205(0x164)]('🔐\x20Response\x20is\x20encrypted,\x20decrypting...');try{const _0x285832=await this[_0x239205(0x141)](_0x3fc567[_0x239205(0x167)],_0x3fc567['key']);_0x2805e7=JSON[_0x239205(0x15a)](_0x285832),console[_0x239205(0x164)]('✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)'),loggerService_1[_0x239205(0x143)][_0x239205(0x161)]('mastercard','/charge_decrypted',_0x1e05e2[_0x239205(0x19d)],_0x2805e7,_0x2490df),console[_0x239205(0x164)](_0x239205(0x170));}catch(_0x18b56d){console[_0x239205(0xab)](_0x239205(0xe5),_0x18b56d),loggerService_1[_0x239205(0x143)][_0x239205(0x16f)](_0x239205(0x18b),_0x239205(0x1a3),'Decryption\x20failed:\x20'+_0x18b56d),_0x2805e7=_0x3fc567;}}else loggerService_1['loggerService']['logWhiteDomainResponse'](_0x239205(0x18b),'/charge_decrypted',_0x1e05e2[_0x239205(0x19d)],_0x2805e7,_0x2490df),console[_0x239205(0x164)](_0x239205(0x14e));console['log']('Status:',_0x2805e7[_0x239205(0x19d)]),console['log'](_0x239205(0x16e),_0x2805e7[_0x239205(0xfb)]),console[_0x239205(0x164)]('Payment\x20ID:',_0x2805e7[_0x239205(0xeb)]),console['log'](_0x239205(0x19e),_0x2805e7[_0x239205(0x11f)]||_0x239205(0x129));if(_0x2805e7['status']===0x64&&_0x2805e7[_0x239205(0xfb)]===0x1)return console[_0x239205(0x164)]('✅\x20Payment\x20successful'),{'gateway_payment_id':_0x2805e7[_0x239205(0xeb)]?.[_0x239205(0x1a7)](),'payment_url':_0x31ad5c,'requires_3ds':![],'status':_0x239205(0x120),'final':!![]};if(_0x2805e7[_0x239205(0x11f)])return console['log'](_0x239205(0xf4)),this[_0x239205(0xd0)](_0x52229b,_0x283c72,_0x2805e7[_0x239205(0xeb)]?.['toString']()||_0x283c72),{'gateway_payment_id':_0x2805e7[_0x239205(0xeb)]?.[_0x239205(0x1a7)](),'payment_url':_0x2805e7[_0x239205(0x11f)],'requires_3ds':!![],'threeds_url':_0x2805e7[_0x239205(0x11f)],'status':_0x239205(0x119),'final':![]};let _0x540aa2=_0x2805e7[_0x239205(0x195)]||_0x2805e7[_0x239205(0xfd)]||'Unknown\x20error',_0x1acd32=_0x2805e7[_0x239205(0x19d)],_0x217472=_0x2805e7[_0x239205(0xfb)];return console['log'](_0x239205(0x162)+_0x1acd32+',\x20Final:\x20'+_0x217472+_0x239205(0x12d)+_0x540aa2),{'gateway_payment_id':_0x2805e7[_0x239205(0xeb)]?.[_0x239205(0x1a7)](),'payment_url':_0x31ad5c,'requires_3ds':![],'status':_0x239205(0xc8),'final':!![]};}catch(_0x47bb25){console[_0x239205(0xab)](_0x239205(0x18d)),console[_0x239205(0xab)]('Error\x20details:',_0x47bb25),loggerService_1[_0x239205(0x143)]['logWhiteDomainError']('mastercard',_0x239205(0x174),_0x47bb25);throw new Error(_0x239205(0xaf)+(_0x47bb25 instanceof Error?_0x47bb25[_0x239205(0xfd)]:_0x239205(0x17f)));}}async['checkPaymentStatus'](_0x214da4,_0x1b4e1c){const _0x526919=a42_0x415cd6;console[_0x526919(0x164)](_0x526919(0xf3)+_0x214da4+'\x20('+_0x1b4e1c+')');try{const _0x40b81d={'payment_id':_0x214da4,'order_id':_0x1b4e1c},_0x5357c5=JSON['stringify'](_0x40b81d),{key:_0xc04790,iv:_0x527acd}=this[_0x526919(0x196)](),_0x3577ec=this[_0x526919(0xb3)](_0x5357c5,_0xc04790,_0x527acd),_0x227019=this[_0x526919(0xd7)](_0xc04790,_0x527acd),_0x4dfdac=this[_0x526919(0xd5)](_0x5357c5),_0x55a12c={'merchant_point_id':this[_0x526919(0xbb)],'method':'status','info':_0x3577ec,'key':_0x227019,'sign':_0x4dfdac,'lang':'en'};loggerService_1['loggerService']['logWhiteDomainRequest'](_0x526919(0x18b),_0x526919(0xc0),_0x526919(0x15e),{'merchant_point_id':this[_0x526919(0xbb)],'method':_0x526919(0x19d),'lang':'en'});const _0x1b1fc2=Date[_0x526919(0xae)](),_0x23525b=await fetch(this[_0x526919(0x142)],{'method':'POST','headers':{'Content-Type':_0x526919(0x18f),'Accept':_0x526919(0x18f),'User-Agent':_0x526919(0xed)},'body':JSON['stringify'](_0x55a12c)}),_0x433ade=Date[_0x526919(0xae)]()-_0x1b1fc2;if(!_0x23525b['ok']){const _0x356877=await _0x23525b[_0x526919(0xee)]();loggerService_1[_0x526919(0x143)][_0x526919(0x161)](_0x526919(0x18b),'/status_raw',_0x23525b['status'],_0x356877,_0x433ade);throw new Error('HTTP\x20error!\x20status:\x20'+_0x23525b[_0x526919(0x19d)]);}const _0x4ee79a=await _0x23525b[_0x526919(0xf7)]();loggerService_1[_0x526919(0x143)][_0x526919(0x161)](_0x526919(0x18b),'/status_raw',_0x23525b[_0x526919(0x19d)],_0x4ee79a,_0x433ade);let _0x2be981=_0x4ee79a;if(_0x4ee79a[_0x526919(0x167)]&&_0x4ee79a[_0x526919(0xaa)]&&_0x4ee79a[_0x526919(0xf2)]){console[_0x526919(0x164)](_0x526919(0x13b));try{const _0x73454d=this[_0x526919(0x152)](_0x4ee79a[_0x526919(0x167)],_0x4ee79a[_0x526919(0xaa)]);_0x2be981=JSON[_0x526919(0x15a)](_0x73454d),console[_0x526919(0x164)](_0x526919(0x101)),loggerService_1['loggerService'][_0x526919(0x161)](_0x526919(0x18b),_0x526919(0x14d),_0x23525b[_0x526919(0x19d)],_0x2be981,_0x433ade),console[_0x526919(0x164)](_0x526919(0x107));}catch(_0x1c3859){console[_0x526919(0xab)]('❌\x20Failed\x20to\x20decrypt\x20status\x20response:',_0x1c3859),loggerService_1[_0x526919(0x143)]['logWhiteDomainError'](_0x526919(0x18b),_0x526919(0x19b),_0x526919(0x18e)+_0x1c3859),_0x2be981=_0x4ee79a;}}else loggerService_1['loggerService'][_0x526919(0x161)](_0x526919(0x18b),_0x526919(0x14d),_0x23525b[_0x526919(0x19d)],_0x2be981,_0x433ade),console['log'](_0x526919(0x197));console[_0x526919(0x164)]('📊\x20Status\x20check\x20result:',{'status':_0x2be981[_0x526919(0x19d)],'final':_0x2be981['final'],'payment_id':_0x2be981[_0x526919(0xeb)],'desc':_0x2be981['desc']});let _0xfa90d8=_0x526919(0x119);if(_0x2be981[_0x526919(0x19d)]===0x1&&_0x2be981['final']===0x1)_0xfa90d8=_0x526919(0x120);else _0x2be981[_0x526919(0x19d)]===0x0&&_0x2be981['final']===0x0?_0xfa90d8=_0x526919(0x119):_0xfa90d8=_0x526919(0xc8);return{'status':_0xfa90d8,'final':_0x2be981['final']===0x1,'amount':_0x2be981['amount'],'currency':_0x2be981[_0x526919(0x172)],'date_success':_0x2be981[_0x526919(0x131)],'description':_0x2be981[_0x526919(0x195)]};}catch(_0x190bf0){console[_0x526919(0xab)](_0x526919(0x11b),_0x190bf0),loggerService_1[_0x526919(0x143)][_0x526919(0x16f)](_0x526919(0x18b),_0x526919(0xc0),_0x190bf0);throw new Error(_0x526919(0x109)+(_0x190bf0 instanceof Error?_0x190bf0['message']:'Unknown\x20error'));}}[a42_0x415cd6(0xd0)](_0x1bb4c6,_0xadd915,_0x11dcd8){const _0x1e060e=a42_0x415cd6;console[_0x1e060e(0x164)](_0x1e060e(0xb9)+_0x1bb4c6+'\x20('+_0x11dcd8+')'),this['clearStatusTimers'](_0x1bb4c6);const _0x4ba03a=[],_0x56d1fc=0x5*0x3c*0x3e8,_0x139f85=0x2*0x3c*0x3c*0x3e8,_0x2ef3f3=Math[_0x1e060e(0x17a)](_0x139f85/_0x56d1fc);console[_0x1e060e(0x164)]('⏰\x20Will\x20check\x20status\x20'+_0x2ef3f3+_0x1e060e(0xbd));for(let _0x648e36=0x1;_0x648e36<=_0x2ef3f3;_0x648e36++){const _0x5b710c=setTimeout(async()=>{const _0x47754e=_0x1e060e;console[_0x47754e(0x164)](_0x47754e(0x121)+_0x648e36+'/'+_0x2ef3f3+'\x20for\x20payment\x20'+_0x1bb4c6);try{const _0x2b73b3=await this[_0x47754e(0xe0)](_0x11dcd8,_0xadd915);console[_0x47754e(0x164)](_0x47754e(0x13a)+_0x648e36+_0x47754e(0x154),_0x2b73b3),_0x2b73b3[_0x47754e(0xfb)]&&(console['log'](_0x47754e(0xd1)+_0x1bb4c6+_0x47754e(0x11e)+_0x2b73b3[_0x47754e(0x19d)]+_0x47754e(0x11a)),this[_0x47754e(0x10e)](_0x1bb4c6),await this[_0x47754e(0x118)](_0x1bb4c6,_0x2b73b3[_0x47754e(0x19d)],_0x2b73b3));}catch(_0x4bdc54){console[_0x47754e(0xab)](_0x47754e(0xdc)+_0x648e36+_0x47754e(0x10f)+_0x1bb4c6+':',_0x4bdc54);}},_0x648e36*_0x56d1fc);_0x4ba03a[_0x1e060e(0x155)](_0x5b710c);}this['statusCheckTimers'][_0x1e060e(0x10c)](_0x1bb4c6,_0x4ba03a),console[_0x1e060e(0x164)](_0x1e060e(0x193)+_0x2ef3f3+_0x1e060e(0x100)+_0x1bb4c6);}[a42_0x415cd6(0x10e)](_0x136b44){const _0x422176=a42_0x415cd6,_0x46c213=this[_0x422176(0x158)][_0x422176(0x108)](_0x136b44);_0x46c213&&(console[_0x422176(0x164)](_0x422176(0x156)+_0x46c213[_0x422176(0x136)]+'\x20status\x20timers\x20for\x20payment\x20'+_0x136b44),_0x46c213['forEach']((_0x24f5cc,_0x529bb5)=>{clearTimeout(_0x24f5cc);}),this[_0x422176(0x158)][_0x422176(0xc6)](_0x136b44));}async[a42_0x415cd6(0x118)](_0x233159,_0xc2133,_0x4d98d2){const _0x3a49eb=a42_0x415cd6;try{const _0x48128c=(await Promise[_0x3a49eb(0x159)]()['then'](()=>__importStar(require('../../config/database'))))[_0x3a49eb(0x18c)],_0xea9e92={'status':_0xc2133['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x3a49eb(0xe2),'statusChangedAt':new Date()};_0xc2133===_0x3a49eb(0x120)&&(_0xea9e92[_0x3a49eb(0xc2)]=new Date()),_0x4d98d2['description']&&(_0xea9e92['adminNotes']=_0x3a49eb(0x134)+_0x4d98d2['description']),await _0x48128c[_0x3a49eb(0xf5)][_0x3a49eb(0x199)]({'where':{'id':_0x233159},'data':_0xea9e92}),console[_0x3a49eb(0x164)](_0x3a49eb(0xd1)+_0x233159+_0x3a49eb(0xd2)+_0xc2133),await this['sendPaymentNotifications'](_0x233159,_0xc2133);}catch(_0x2c9ece){console[_0x3a49eb(0xab)]('❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20'+_0x233159+':',_0x2c9ece);}}async[a42_0x415cd6(0x133)](_0x4a98c1,_0xd95c0f){const _0x597341=a42_0x415cd6;try{const _0x1c4216=(await Promise[_0x597341(0x159)]()['then'](()=>__importStar(require(_0x597341(0xad)))))[_0x597341(0x18c)],{telegramBotService:_0x42192b}=await Promise['resolve']()['then'](()=>__importStar(require('../telegramBotService'))),_0x1a7d16=await _0x1c4216[_0x597341(0xf5)]['findUnique']({'where':{'id':_0x4a98c1},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1a7d16)return;const _0x9fc440={'PAID':_0x597341(0xfc),'FAILED':_0x597341(0xea)},_0x5ad34d=_0x9fc440[_0xd95c0f];_0x5ad34d&&await _0x42192b[_0x597341(0xf8)](_0x1a7d16['shopId'],_0x1a7d16,_0x5ad34d),await this[_0x597341(0x18a)](_0x1a7d16,_0xd95c0f);}catch(_0x232393){console[_0x597341(0xab)](_0x597341(0xe1),_0x232393);}}async[a42_0x415cd6(0x18a)](_0x5b6903,_0x27663c){const _0x356df5=a42_0x415cd6,_0x2cc04e=Date[_0x356df5(0xae)]();try{const _0x245046=_0x5b6903[_0x356df5(0x190)],_0x58415f=_0x245046[_0x356df5(0xff)];if(!_0x58415f?.[_0x356df5(0x148)]){console[_0x356df5(0x164)](_0x356df5(0xcf)+_0x245046['id']);return;}const _0x179f27=_0x27663c===_0x356df5(0x120)?_0x356df5(0x10a):_0x356df5(0x126);let _0x1c6a42=[];if(_0x58415f[_0x356df5(0x187)])try{_0x1c6a42=Array[_0x356df5(0x125)](_0x58415f[_0x356df5(0x187)])?_0x58415f[_0x356df5(0x187)]:JSON[_0x356df5(0x15a)](_0x58415f[_0x356df5(0x187)]);}catch(_0x5840fc){console[_0x356df5(0xab)](_0x356df5(0x135),_0x5840fc),_0x1c6a42=[];}if(!_0x1c6a42[_0x356df5(0x1a6)](_0x179f27)){console[_0x356df5(0x164)](_0x356df5(0x19a)+_0x179f27+_0x356df5(0xc4)+_0x245046['id']);return;}const _0x46e893={'event':_0x179f27,'payment':{'id':_0x5b6903['id'],'order_id':_0x5b6903[_0x356df5(0x153)],'gateway_order_id':_0x5b6903['gatewayOrderId'],'gateway':_0x356df5(0xf0),'amount':_0x5b6903[_0x356df5(0x139)],'currency':_0x5b6903[_0x356df5(0x172)],'status':_0x27663c[_0x356df5(0x13c)](),'customer_email':_0x5b6903[_0x356df5(0x178)],'customer_name':_0x5b6903[_0x356df5(0x183)],'created_at':_0x5b6903[_0x356df5(0xc9)],'updated_at':new Date()}},_0xa6f068=await fetch(_0x58415f[_0x356df5(0x148)],{'method':'POST','headers':{'Content-Type':_0x356df5(0x18f),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON['stringify'](_0x46e893)}),_0x5cc04c=Date['now']()-_0x2cc04e;loggerService_1['loggerService'][_0x356df5(0x14a)](_0x5b6903[_0x356df5(0xd8)],_0x58415f[_0x356df5(0x148)],_0x179f27,_0xa6f068[_0x356df5(0x19d)],_0x5cc04c,_0x46e893),console[_0x356df5(0x164)](_0x356df5(0xb5)+_0x58415f[_0x356df5(0x148)]+_0x356df5(0xb0)+_0xa6f068[_0x356df5(0x19d)]+'\x20('+_0x5cc04c+_0x356df5(0x15b));}catch(_0x2f8cd0){console[_0x356df5(0xab)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x2f8cd0),loggerService_1[_0x356df5(0x143)][_0x356df5(0x173)](_0x5b6903[_0x356df5(0xd8)],_0x5b6903['shop']?.[_0x356df5(0xff)]?.[_0x356df5(0x148)]||'unknown',_0x356df5(0xb7),_0x2f8cd0,{});}}['maskCardNumber'](_0x4293ec){const _0x1c93fb=a42_0x415cd6,_0xce9071=_0x4293ec[_0x1c93fb(0x122)](/[\s-]/g,'');if(_0xce9071[_0x1c93fb(0x136)]<0x4)return _0x1c93fb(0x16c);return'****\x20****\x20****\x20'+_0xce9071[_0x1c93fb(0x157)](-0x4);}async[a42_0x415cd6(0xe4)](_0xa311e9){const _0x43a19f=a42_0x415cd6;console[_0x43a19f(0x164)](_0x43a19f(0xc3),_0xa311e9);let _0x29c41a=_0x43a19f(0x119);if(_0xa311e9['status']===0x1&&_0xa311e9[_0x43a19f(0xfb)]===0x1)_0x29c41a=_0x43a19f(0x120);else _0xa311e9['status']===0x0&&_0xa311e9[_0x43a19f(0xfb)]===0x0?_0x29c41a=_0x43a19f(0x119):_0x29c41a='FAILED';return{'paymentId':_0xa311e9[_0x43a19f(0x17b)]||'','status':_0x29c41a,'amount':_0xa311e9[_0x43a19f(0x139)],'currency':_0xa311e9[_0x43a19f(0x172)]};}[a42_0x415cd6(0x177)](){const _0x283097=a42_0x415cd6;console[_0x283097(0x164)](_0x283097(0xd6));const _0x5af772=this[_0x283097(0x158)]['size'];for(const [_0x4a480c]of this[_0x283097(0x158)]){this[_0x283097(0x10e)](_0x4a480c);}console['log'](_0x283097(0x114)+_0x5af772+_0x283097(0x15c));}}exports['MasterCardService']=MasterCardService;