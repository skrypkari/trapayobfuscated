'use strict';const a42_0x366c84=a42_0x34b6;(function(_0xc61cec,_0x4f7ed9){const _0x757c3e=a42_0x34b6,_0x1b0f52=_0xc61cec();while(!![]){try{const _0x3f5a0c=parseInt(_0x757c3e(0x15b))/0x1+-parseInt(_0x757c3e(0x198))/0x2*(parseInt(_0x757c3e(0x1a7))/0x3)+-parseInt(_0x757c3e(0x130))/0x4*(parseInt(_0x757c3e(0x1fc))/0x5)+-parseInt(_0x757c3e(0x17d))/0x6*(parseInt(_0x757c3e(0x132))/0x7)+parseInt(_0x757c3e(0x18a))/0x8*(parseInt(_0x757c3e(0x1d9))/0x9)+-parseInt(_0x757c3e(0x1ad))/0xa+parseInt(_0x757c3e(0x1f2))/0xb;if(_0x3f5a0c===_0x4f7ed9)break;else _0x1b0f52['push'](_0x1b0f52['shift']());}catch(_0x336fe7){_0x1b0f52['push'](_0x1b0f52['shift']());}}}(a42_0x408b,0xcd52a));var __createBinding=this&&this[a42_0x366c84(0x1ae)]||(Object[a42_0x366c84(0x16a)]?function(_0x4f2816,_0x117f95,_0x128365,_0x47e310){const _0x15bd7d=a42_0x366c84;if(_0x47e310===undefined)_0x47e310=_0x128365;var _0x3914c5=Object[_0x15bd7d(0x1f5)](_0x117f95,_0x128365);(!_0x3914c5||('get'in _0x3914c5?!_0x117f95['__esModule']:_0x3914c5[_0x15bd7d(0x1d0)]||_0x3914c5[_0x15bd7d(0x10b)]))&&(_0x3914c5={'enumerable':!![],'get':function(){return _0x117f95[_0x128365];}}),Object[_0x15bd7d(0x1b4)](_0x4f2816,_0x47e310,_0x3914c5);}:function(_0x281517,_0x3c236f,_0x68f878,_0x31d7ec){if(_0x31d7ec===undefined)_0x31d7ec=_0x68f878;_0x281517[_0x31d7ec]=_0x3c236f[_0x68f878];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a42_0x366c84(0x16a)]?function(_0x4316a0,_0xa7078d){const _0x2908e3=a42_0x366c84;Object[_0x2908e3(0x1b4)](_0x4316a0,_0x2908e3(0x1eb),{'enumerable':!![],'value':_0xa7078d});}:function(_0x3fde46,_0x3b52b7){const _0x112cc4=a42_0x366c84;_0x3fde46[_0x112cc4(0x1eb)]=_0x3b52b7;}),__importStar=this&&this[a42_0x366c84(0x137)]||(function(){var _0x2d6b4a=function(_0x233c50){return _0x2d6b4a=Object['getOwnPropertyNames']||function(_0x3e37f1){const _0x1cb5f0=a42_0x34b6;var _0x220e5e=[];for(var _0x23f138 in _0x3e37f1)if(Object['prototype'][_0x1cb5f0(0x160)][_0x1cb5f0(0x116)](_0x3e37f1,_0x23f138))_0x220e5e[_0x220e5e['length']]=_0x23f138;return _0x220e5e;},_0x2d6b4a(_0x233c50);};return function(_0x27700d){const _0x960786=a42_0x34b6;if(_0x27700d&&_0x27700d[_0x960786(0x1b3)])return _0x27700d;var _0x1103a8={};if(_0x27700d!=null){for(var _0x379a24=_0x2d6b4a(_0x27700d),_0x37885c=0x0;_0x37885c<_0x379a24[_0x960786(0x1a4)];_0x37885c++)if(_0x379a24[_0x37885c]!==_0x960786(0x1eb))__createBinding(_0x1103a8,_0x27700d,_0x379a24[_0x37885c]);}return __setModuleDefault(_0x1103a8,_0x27700d),_0x1103a8;};}()),__importDefault=this&&this[a42_0x366c84(0x164)]||function(_0x31c5eb){const _0x4608c2=a42_0x366c84;return _0x31c5eb&&_0x31c5eb[_0x4608c2(0x1b3)]?_0x31c5eb:{'default':_0x31c5eb};};function a42_0x408b(){const _0x49b2ee=['readFileSync','/charge_decrypted','customerName','Response\x20Time:','Card\x20Number:','Private\x20key\x20file\x20not\x20found:\x20','⏰\x20Will\x20check\x20status\x20','2RpqDVZ','\x20characters','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','merchantPointId','../../config/database','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','createSign','PHP\x20decryptor\x20error','logShopWebhookSent','❌\x20PHP\x20decryptor\x20request\x20failed:','status','🧹\x20Clearing\x20','length','settings','🔍\x20MasterCard\x20status\x20check\x20#','2453853tNkBvY','📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','ms)','order_id','base64','currency','3905140jYskXN','__createBinding','Failed\x20to\x20send\x20payment\x20notifications:','apiUrl','toLowerCase','adminNotes','__esModule','defineProperty','mastercard','PAID','Public\x20key\x20file\x20not\x20found:\x20','stringify','payment','📊\x20Status\x20check\x20result:','forEach','psp_public.pem','update','\x20\x20\x20-\x20method:\x20charge','generateAESKey','Payment\x20ID:','🔐\x20Data\x20encrypted\x20with\x20AES','includes','🛑\x20Stopped\x20','checkPaymentStatus','MasterCardService','encryptAES','/charge','-----END','Failed\x20to\x20decrypt\x20response\x20via\x20PHP','sign','/status','⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20','...','\x20\x20\x20-\x20info\x20length:','message','writable','Error\x20parsing\x20webhook\x20events:','randomBytes','amount','❌\x20Data\x20being\x20signed:','Webhook\x20event\x20','PENDING','\x20MasterCard\x20status\x20check\x20timers','processCardPayment','1026pFULIt','updatePaymentStatus','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','RSA_PKCS1_PADDING','date_success','keys','then','-----BEGIN','sendShopWebhook','✅\x20Payment\x20successful','✅\x20Payment\x20','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','set','loggerService','clearStatusTimers','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','payment.success','✅\x20Status\x20response\x20decrypted\x20successfully','default','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','error','payment.failed','FAILED','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','privateDecrypt','18952384axpHvX','\x20\x20\x20-\x20merchant_point_id:','❌\x20Status\x20check\x20#','getOwnPropertyDescriptor','/charge_decrypt','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','existsSync','get','Response\x20Body:','4990mBkQsz','📝\x20Signature\x20length:','from','logWhiteDomainResponse','sendPaymentNotifications','❌\x20RSA\x20encryption\x20failed:','description','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','Result\x20URL:','configurable','text','isArray','📝\x20Encrypted\x20key\x20length:','gatewayOrderId','size',',\x20Final:\x20','customerEmail','constants','🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20','call','3ds_url','failed','📝\x20Data\x20length:','💾\x20Payment\x20data\x20prepared','signRSA','cvv','Unknown\x20error','🔐\x20RSA\x20signing\x20successful','toString','shopId','\x20\x20\x20-\x20sign\x20length:',',\x20body:\x20','logWhiteDomainRequest','substring','🔐\x20Data\x20signed\x20with\x20RSA','desc','https://api2.trapay.uk/decrypt.php','log','maskCardNumber','application/json','Processing\x20MasterCard\x20webhook:','webhookEvents','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','publicEncrypt','payment_id','4964jOOADY','trim','7wlaupZ','push','path','MasterCard:\x20','\x20status\x20timers\x20for\x20payment\x20','__importStar','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','key','Status\x20decryption\x20failed:\x20','❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):','decryptResponse','private.pem','🔐\x20AES\x20key\x20and\x20IV\x20generated','\x20status\x20updated\x20to\x20','replace','📝\x20Data\x20to\x20sign\x20length:','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','toUpperCase','/status_raw','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','HTTP\x20error!\x20status:\x20','publicKeyPath','Amount:','join','Error\x20details:','🔐\x20Public\x20key\x20path:','scheduleStatusChecks','3DS\x20URL:','resolve','expire_month','expire_year','now','https://api.paydmeth.com/api','Final:','utf8','info','\x20result:','),\x20stopping\x20status\x20checks','💳\x20MasterCard\x20service\x20initialized','🔐\x20AES\x20key\x20length:','📝\x20Encrypted\x20data\x20length:','1089641oBfjBM','slice','===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20===','\x20\x20\x20-\x20key\x20length:','❌\x20Failed\x20to\x20decrypt\x20status\x20response:','hasOwnProperty','Decryption\x20failed:\x20','❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20','🔐\x203DS\x20verification\x20required','__importDefault','❌\x20MasterCard\x20key\x20validation\x20failed:','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','system','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===','create','final','Order\x20ID:','crypto','✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)','/charge_raw','logWhiteDomainError','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','📊\x20Status\x20check\x20#','orderId','MasterCard\x20status\x20check\x20error:','POST','floor','validateKeyFiles','parse','cwd','json','HTTP\x20','logShopWebhookError','159936jQLpeB','paid','encryptRSA','shop','\x20for\x20payment\x20','decryptAES','/status_decrypted','\x20not\x20enabled\x20for\x20shop\x20','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','aes-256-ctr','webhookUrl','statusCheckTimers','SHA256','35232gbiETu','charge','privateKeyPath','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','unknown','Status:','Card\x20Holder:'];a42_0x408b=function(){return _0x49b2ee;};return a42_0x408b();}function a42_0x34b6(_0x2a7c8e,_0x2f0028){const _0x408b7f=a42_0x408b();return a42_0x34b6=function(_0x34b6db,_0x1d371c){_0x34b6db=_0x34b6db-0x108;let _0x3fb1fb=_0x408b7f[_0x34b6db];return _0x3fb1fb;},a42_0x34b6(_0x2a7c8e,_0x2f0028);}Object[a42_0x366c84(0x1b4)](exports,a42_0x366c84(0x1b3),{'value':!![]}),exports[a42_0x366c84(0x1c5)]=void 0x0;const crypto_1=__importDefault(require(a42_0x366c84(0x16d))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0x366c84(0x134))),loggerService_1=require('../loggerService');class MasterCardService{constructor(){const _0x18726b=a42_0x366c84;this[_0x18726b(0x188)]=new Map(),this[_0x18726b(0x1b0)]=_0x18726b(0x152),this[_0x18726b(0x19b)]=0x67c,this[_0x18726b(0x18c)]=path_1[_0x18726b(0x1eb)][_0x18726b(0x149)](process[_0x18726b(0x179)](),'keys',_0x18726b(0x13d)),this[_0x18726b(0x147)]=path_1[_0x18726b(0x1eb)]['join'](process[_0x18726b(0x179)](),_0x18726b(0x1de),_0x18726b(0x1bc)),console[_0x18726b(0x128)](_0x18726b(0x158)),console['log']('🔐\x20Private\x20key\x20path:',this['privateKeyPath']),console[_0x18726b(0x128)](_0x18726b(0x14b),this[_0x18726b(0x147)]),this[_0x18726b(0x177)]();}['validateKeyFiles'](){const _0x24f9c1=a42_0x366c84;try{if(!fs_1[_0x24f9c1(0x1eb)]['existsSync'](this['privateKeyPath']))throw new Error(_0x24f9c1(0x196)+this[_0x24f9c1(0x18c)]);if(!fs_1[_0x24f9c1(0x1eb)][_0x24f9c1(0x1f9)](this['publicKeyPath']))throw new Error(_0x24f9c1(0x1b7)+this[_0x24f9c1(0x147)]);const _0x5bf5d2=fs_1[_0x24f9c1(0x1eb)][_0x24f9c1(0x191)](this[_0x24f9c1(0x18c)],'utf8')['trim'](),_0xc79cef=fs_1[_0x24f9c1(0x1eb)][_0x24f9c1(0x191)](this[_0x24f9c1(0x147)],'utf8')['trim']();if(!_0x5bf5d2[_0x24f9c1(0x1c2)](_0x24f9c1(0x1e0))||!_0x5bf5d2[_0x24f9c1(0x1c2)](_0x24f9c1(0x1c8)))throw new Error('Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format');if(!_0xc79cef[_0x24f9c1(0x1c2)](_0x24f9c1(0x1e0))||!_0xc79cef[_0x24f9c1(0x1c2)]('-----END'))throw new Error(_0x24f9c1(0x142));console['log'](_0x24f9c1(0x171)),console[_0x24f9c1(0x128)]('🔐\x20Private\x20key\x20length:\x20'+_0x5bf5d2[_0x24f9c1(0x1a4)]+_0x24f9c1(0x199)),console['log']('🔐\x20Public\x20key\x20length:\x20'+_0xc79cef[_0x24f9c1(0x1a4)]+_0x24f9c1(0x199));}catch(_0xfa83c1){console[_0x24f9c1(0x1ed)](_0x24f9c1(0x165),_0xfa83c1);throw _0xfa83c1;}}[a42_0x366c84(0x1bf)](){const _0x267f05=a42_0x366c84,_0x5e5b54=crypto_1[_0x267f05(0x1eb)]['randomBytes'](0x20),_0xc1a090=crypto_1[_0x267f05(0x1eb)][_0x267f05(0x1d2)](0x10);return{'key':_0x5e5b54,'iv':_0xc1a090};}[a42_0x366c84(0x1c6)](_0x316d41,_0x20e920,_0x319431){const _0x5c48d2=a42_0x366c84,_0x1139bc=crypto_1['default']['createCipheriv'](_0x5c48d2(0x186),_0x20e920,_0x319431);let _0x120d83=_0x1139bc[_0x5c48d2(0x1bd)](_0x316d41,_0x5c48d2(0x154),_0x5c48d2(0x1ab));return _0x120d83+=_0x1139bc['final']('base64'),_0x120d83;}[a42_0x366c84(0x17f)](_0x1b002e,_0x5ecc27){const _0x170b95=a42_0x366c84;try{const _0x414dee=fs_1['default'][_0x170b95(0x191)](this['publicKeyPath'],'utf8')[_0x170b95(0x131)](),_0x4c99dd={'iv':_0x5ecc27[_0x170b95(0x11f)](_0x170b95(0x1ab)),'key':_0x1b002e[_0x170b95(0x11f)](_0x170b95(0x1ab))},_0x387121=JSON[_0x170b95(0x1b8)](_0x4c99dd);console[_0x170b95(0x128)](_0x170b95(0x166),_0x387121[_0x170b95(0x1a4)]);const _0x52119f=crypto_1[_0x170b95(0x1eb)][_0x170b95(0x12e)]({'key':_0x414dee,'padding':crypto_1[_0x170b95(0x1eb)][_0x170b95(0x113)][_0x170b95(0x1dc)]},Buffer[_0x170b95(0x1fe)](_0x387121));return console[_0x170b95(0x128)](_0x170b95(0x185),_0x52119f[_0x170b95(0x1a4)]),_0x52119f[_0x170b95(0x11f)]('base64');}catch(_0x170b14){console['error'](_0x170b95(0x201),_0x170b14);throw new Error(_0x170b95(0x1db));}}[a42_0x366c84(0x11b)](_0x5aef26){const _0x549ac6=a42_0x366c84;try{const _0x1c4b4e=fs_1['default']['readFileSync'](this[_0x549ac6(0x18c)],'utf8')[_0x549ac6(0x131)](),_0xfb61a4=crypto_1[_0x549ac6(0x1eb)][_0x549ac6(0x19e)](_0x549ac6(0x189));_0xfb61a4[_0x549ac6(0x1bd)](_0x5aef26),_0xfb61a4['end']();const _0x6920e7=_0xfb61a4['sign'](_0x1c4b4e,_0x549ac6(0x1ab));return console[_0x549ac6(0x128)](_0x549ac6(0x11e)),console[_0x549ac6(0x128)](_0x549ac6(0x141),_0x5aef26[_0x549ac6(0x1a4)]),console['log'](_0x549ac6(0x1fd),_0x6920e7[_0x549ac6(0x1a4)]),_0x6920e7;}catch(_0x23f2af){console[_0x549ac6(0x1ed)]('❌\x20RSA\x20signing\x20failed:',_0x23f2af),console[_0x549ac6(0x1ed)](_0x549ac6(0x1d4),_0x5aef26[_0x549ac6(0x124)](0x0,0xc8)+_0x549ac6(0x1cd));throw new Error(_0x549ac6(0x109));}}[a42_0x366c84(0x182)](_0x490a42,_0x2a19d6,_0x13ed4d){const _0x5fa03=a42_0x366c84,_0x47b8fd=crypto_1['default']['createDecipheriv']('aes-256-ctr',_0x2a19d6,_0x13ed4d);let _0x9e4da0=_0x47b8fd['update'](_0x490a42,_0x5fa03(0x1ab),_0x5fa03(0x154));return _0x9e4da0+=_0x47b8fd[_0x5fa03(0x16b)](_0x5fa03(0x154)),_0x9e4da0;}async['decryptResponsePhp'](_0x90656c,_0x4e4c4d){const _0x38efd0=a42_0x366c84;try{const _0x265d33=await fetch(_0x38efd0(0x127),{'method':_0x38efd0(0x175),'headers':{'Content-Type':_0x38efd0(0x12a)},'body':JSON[_0x38efd0(0x1b8)]({'info':_0x90656c,'key':_0x4e4c4d})});if(!_0x265d33['ok'])throw new Error(_0x38efd0(0x19f));return await _0x265d33[_0x38efd0(0x10c)]();}catch(_0x3c4f91){console[_0x38efd0(0x1ed)](_0x38efd0(0x1a1),_0x3c4f91);throw new Error(_0x38efd0(0x1c9));}}[a42_0x366c84(0x13c)](_0x19de52,_0x2fa4c9){const _0x39437a=a42_0x366c84;try{const _0x1a53cd=fs_1['default'][_0x39437a(0x191)](this[_0x39437a(0x18c)],_0x39437a(0x154))[_0x39437a(0x131)](),_0x18562c=crypto_1[_0x39437a(0x1eb)][_0x39437a(0x1f1)](_0x1a53cd,Buffer[_0x39437a(0x1fe)](_0x2fa4c9,'base64')),_0x1d01c6=JSON['parse'](_0x18562c[_0x39437a(0x11f)]()),_0x3e1bb4=Buffer['from'](_0x1d01c6['key'],'base64'),_0x1ddced=Buffer[_0x39437a(0x1fe)](_0x1d01c6['iv'],_0x39437a(0x1ab));return this[_0x39437a(0x182)](_0x19de52,_0x3e1bb4,_0x1ddced);}catch(_0x364c7c){throw new Error('Failed\x20to\x20decrypt\x20response');}}async[a42_0x366c84(0x1d8)](_0x1f61b3){const _0x32e886=a42_0x366c84,{paymentId:_0x5925af,orderId:_0x8d4119,amount:_0x1bdd6f,currency:_0x485a3c,cardData:_0x1e411d,resultUrl:_0xf6e9a7,returnUrl:_0x2fbed0,cardHolder:_0x5b8870,browser:_0x23c52d}=_0x1f61b3;console[_0x32e886(0x128)](_0x32e886(0x15d)),console[_0x32e886(0x128)]('Payment\x20ID:',_0x5925af),console[_0x32e886(0x128)](_0x32e886(0x16c),_0x8d4119),console[_0x32e886(0x128)](_0x32e886(0x148),_0x1bdd6f,_0x485a3c),console[_0x32e886(0x128)](_0x32e886(0x195),this[_0x32e886(0x129)](_0x1e411d['number'])),console[_0x32e886(0x128)](_0x32e886(0x190),_0x5b8870['first_name']+'\x20'+_0x5b8870['last_name']),console['log']('Return\x20URL:',_0x2fbed0),console[_0x32e886(0x128)](_0x32e886(0x10a),_0xf6e9a7);const _0x409fdd={'amount':_0x1bdd6f,'currency':_0x485a3c[_0x32e886(0x143)](),'order_id':_0x8d4119,'result_url':_0xf6e9a7,'return_url':_0x2fbed0,'card':{'number':_0x1e411d['number'],'expire_month':_0x1e411d[_0x32e886(0x14f)],'expire_year':_0x1e411d[_0x32e886(0x150)],'cvv':_0x1e411d[_0x32e886(0x11c)]},'card_holder':_0x5b8870,'browser':_0x23c52d},_0x5151b4=JSON[_0x32e886(0x1b8)](_0x409fdd);console[_0x32e886(0x128)](_0x32e886(0x11a)),console['log'](_0x32e886(0x1f7)),console[_0x32e886(0x128)](_0x5151b4),console[_0x32e886(0x128)](_0x32e886(0x119),_0x5151b4[_0x32e886(0x1a4)]);try{const {key:_0x5c5103,iv:_0x3fa38c}=this[_0x32e886(0x1bf)]();console[_0x32e886(0x128)](_0x32e886(0x13e)),console[_0x32e886(0x128)](_0x32e886(0x159),_0x5c5103[_0x32e886(0x1a4)]),console[_0x32e886(0x128)]('🔐\x20AES\x20IV\x20length:',_0x3fa38c[_0x32e886(0x1a4)]);const _0x4ef961=this[_0x32e886(0x1c6)](_0x5151b4,_0x5c5103,_0x3fa38c);console[_0x32e886(0x128)](_0x32e886(0x1c1)),console[_0x32e886(0x128)](_0x32e886(0x15a),_0x4ef961[_0x32e886(0x1a4)]);const _0x5395fe=this[_0x32e886(0x17f)](_0x5c5103,_0x3fa38c);console[_0x32e886(0x128)](_0x32e886(0x114)),console[_0x32e886(0x128)](_0x32e886(0x10e),_0x5395fe[_0x32e886(0x1a4)]);const _0x33c029=this[_0x32e886(0x11b)](_0x5151b4);console[_0x32e886(0x128)](_0x32e886(0x125)),console[_0x32e886(0x128)](_0x32e886(0x1fd),_0x33c029[_0x32e886(0x1a4)]);const _0x1fa7df={'merchant_point_id':this[_0x32e886(0x19b)],'method':'charge','info':_0x4ef961,'key':_0x5395fe,'sign':_0x33c029,'lang':'en'};console['log'](_0x32e886(0x1f8)),console[_0x32e886(0x128)]('📝\x20Final\x20request\x20structure:'),console['log'](_0x32e886(0x1f3),this[_0x32e886(0x19b)]),console[_0x32e886(0x128)](_0x32e886(0x1be)),console['log'](_0x32e886(0x1ce),_0x4ef961[_0x32e886(0x1a4)]),console[_0x32e886(0x128)](_0x32e886(0x15e),_0x5395fe[_0x32e886(0x1a4)]),console[_0x32e886(0x128)](_0x32e886(0x121),_0x33c029[_0x32e886(0x1a4)]),console[_0x32e886(0x128)]('\x20\x20\x20-\x20lang:\x20en'),loggerService_1[_0x32e886(0x1e6)][_0x32e886(0x123)]('mastercard',_0x32e886(0x1c7),_0x32e886(0x175),{'merchant_point_id':this[_0x32e886(0x19b)],'method':_0x32e886(0x18b),'lang':'en'});const _0x176f03=Date['now'](),_0x3e1cd0=await fetch(this['apiUrl'],{'method':'POST','headers':{'Content-Type':_0x32e886(0x12a),'Accept':_0x32e886(0x12a),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x1fa7df)}),_0x4e8c4d=Date[_0x32e886(0x151)]()-_0x176f03;console[_0x32e886(0x128)](_0x32e886(0x18d)),console[_0x32e886(0x128)](_0x32e886(0x18f),_0x3e1cd0[_0x32e886(0x1a2)]),console[_0x32e886(0x128)](_0x32e886(0x194),_0x4e8c4d+'ms');if(!_0x3e1cd0['ok']){const _0x55cba2=await _0x3e1cd0['text']();console['error']('HTTP\x20Status:',_0x3e1cd0['status']),console[_0x32e886(0x1ed)](_0x32e886(0x1fb),_0x55cba2),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x32e886(0x1b5),_0x32e886(0x16f),_0x3e1cd0[_0x32e886(0x1a2)],_0x55cba2,_0x4e8c4d),loggerService_1[_0x32e886(0x1e6)][_0x32e886(0x170)](_0x32e886(0x1b5),_0x32e886(0x1c7),_0x32e886(0x17b)+_0x3e1cd0['status']+':\x20'+_0x55cba2);throw new Error(_0x32e886(0x146)+_0x3e1cd0[_0x32e886(0x1a2)]+_0x32e886(0x122)+_0x55cba2);}const _0x1770c1=await _0x3e1cd0['json']();loggerService_1[_0x32e886(0x1e6)][_0x32e886(0x1ff)](_0x32e886(0x1b5),_0x32e886(0x16f),_0x3e1cd0['status'],_0x1770c1,_0x4e8c4d),console[_0x32e886(0x128)](_0x32e886(0x169));let _0x346ca4=_0x1770c1;if(_0x1770c1['info']&&_0x1770c1[_0x32e886(0x139)]&&_0x1770c1['sign']){console[_0x32e886(0x128)](_0x32e886(0x145));try{const _0x2ecfd8=await this['decryptResponsePhp'](_0x1770c1[_0x32e886(0x155)],_0x1770c1[_0x32e886(0x139)]);_0x346ca4=JSON[_0x32e886(0x178)](_0x2ecfd8),console['log'](_0x32e886(0x16e)),loggerService_1[_0x32e886(0x1e6)]['logWhiteDomainResponse']('mastercard',_0x32e886(0x192),_0x3e1cd0[_0x32e886(0x1a2)],_0x346ca4,_0x4e8c4d),console[_0x32e886(0x128)](_0x32e886(0x138));}catch(_0x3bfea2){console[_0x32e886(0x1ed)](_0x32e886(0x13b),_0x3bfea2),loggerService_1[_0x32e886(0x1e6)][_0x32e886(0x170)](_0x32e886(0x1b5),_0x32e886(0x1f6),_0x32e886(0x161)+_0x3bfea2),_0x346ca4=_0x1770c1;}}else loggerService_1[_0x32e886(0x1e6)][_0x32e886(0x1ff)](_0x32e886(0x1b5),'/charge_decrypted',_0x3e1cd0['status'],_0x346ca4,_0x4e8c4d),console['log'](_0x32e886(0x1a8));console['log'](_0x32e886(0x18f),_0x346ca4[_0x32e886(0x1a2)]),console[_0x32e886(0x128)](_0x32e886(0x153),_0x346ca4['final']),console[_0x32e886(0x128)](_0x32e886(0x1c0),_0x346ca4['payment_id']),console[_0x32e886(0x128)](_0x32e886(0x14d),_0x346ca4[_0x32e886(0x117)]||'none');if(_0x346ca4[_0x32e886(0x1a2)]===0x64&&_0x346ca4[_0x32e886(0x16b)]===0x1)return console[_0x32e886(0x128)](_0x32e886(0x1e2)),{'gateway_payment_id':_0x346ca4['payment_id']?.['toString'](),'payment_url':_0x2fbed0,'requires_3ds':![],'status':'PAID','final':!![]};if(_0x346ca4[_0x32e886(0x117)])return console[_0x32e886(0x128)](_0x32e886(0x163)),this['scheduleStatusChecks'](_0x5925af,_0x8d4119,_0x346ca4[_0x32e886(0x12f)]?.[_0x32e886(0x11f)]()||_0x8d4119),{'gateway_payment_id':_0x346ca4[_0x32e886(0x12f)]?.[_0x32e886(0x11f)](),'payment_url':_0x346ca4[_0x32e886(0x117)],'requires_3ds':!![],'threeds_url':_0x346ca4['3ds_url'],'status':_0x32e886(0x1d6),'final':![]};let _0x14f5b2=_0x346ca4['desc']||_0x346ca4[_0x32e886(0x1cf)]||'Unknown\x20error',_0x379aed=_0x346ca4[_0x32e886(0x1a2)],_0x4c37da=_0x346ca4[_0x32e886(0x16b)];return console[_0x32e886(0x128)](_0x32e886(0x162)+_0x379aed+_0x32e886(0x111)+_0x4c37da+',\x20Desc:\x20'+_0x14f5b2),{'gateway_payment_id':_0x346ca4[_0x32e886(0x12f)]?.['toString'](),'payment_url':_0x2fbed0,'requires_3ds':![],'status':_0x32e886(0x1ef),'final':!![]};}catch(_0x475157){console[_0x32e886(0x1ed)](_0x32e886(0x12d)),console[_0x32e886(0x1ed)](_0x32e886(0x14a),_0x475157),loggerService_1[_0x32e886(0x1e6)]['logWhiteDomainError']('mastercard',_0x32e886(0x1c7),_0x475157);throw new Error(_0x32e886(0x1ec)+(_0x475157 instanceof Error?_0x475157[_0x32e886(0x1cf)]:_0x32e886(0x11d)));}}async[a42_0x366c84(0x1c4)](_0x56d89c,_0x269ea2){const _0x43e074=a42_0x366c84;console[_0x43e074(0x128)](_0x43e074(0x1e4)+_0x56d89c+'\x20('+_0x269ea2+')');try{const _0x43b5c9={'payment_id':_0x56d89c,'order_id':_0x269ea2},_0x3d5271=JSON[_0x43e074(0x1b8)](_0x43b5c9),{key:_0x3e9f58,iv:_0x4b6db7}=this[_0x43e074(0x1bf)](),_0x2b30cf=this[_0x43e074(0x1c6)](_0x3d5271,_0x3e9f58,_0x4b6db7),_0x5074bd=this[_0x43e074(0x17f)](_0x3e9f58,_0x4b6db7),_0x3c8ead=this[_0x43e074(0x11b)](_0x3d5271),_0x40d4ae={'merchant_point_id':this[_0x43e074(0x19b)],'method':_0x43e074(0x1a2),'info':_0x2b30cf,'key':_0x5074bd,'sign':_0x3c8ead,'lang':'en'};loggerService_1[_0x43e074(0x1e6)][_0x43e074(0x123)]('mastercard',_0x43e074(0x1cb),_0x43e074(0x175),{'merchant_point_id':this[_0x43e074(0x19b)],'method':_0x43e074(0x1a2),'lang':'en'});const _0x4ad577=Date['now'](),_0x5220bf=await fetch(this[_0x43e074(0x1b0)],{'method':_0x43e074(0x175),'headers':{'Content-Type':'application/json','Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x43e074(0x1b8)](_0x40d4ae)}),_0xe3defd=Date[_0x43e074(0x151)]()-_0x4ad577;if(!_0x5220bf['ok']){const _0x89c71f=await _0x5220bf['text']();loggerService_1[_0x43e074(0x1e6)][_0x43e074(0x1ff)](_0x43e074(0x1b5),_0x43e074(0x144),_0x5220bf['status'],_0x89c71f,_0xe3defd);throw new Error(_0x43e074(0x146)+_0x5220bf['status']);}const _0x36e07b=await _0x5220bf[_0x43e074(0x17a)]();loggerService_1[_0x43e074(0x1e6)][_0x43e074(0x1ff)](_0x43e074(0x1b5),_0x43e074(0x144),_0x5220bf['status'],_0x36e07b,_0xe3defd);let _0x37ffd0=_0x36e07b;if(_0x36e07b[_0x43e074(0x155)]&&_0x36e07b[_0x43e074(0x139)]&&_0x36e07b[_0x43e074(0x1ca)]){console[_0x43e074(0x128)](_0x43e074(0x168));try{const _0x13df90=this[_0x43e074(0x13c)](_0x36e07b[_0x43e074(0x155)],_0x36e07b[_0x43e074(0x139)]);_0x37ffd0=JSON[_0x43e074(0x178)](_0x13df90),console[_0x43e074(0x128)](_0x43e074(0x1ea)),loggerService_1[_0x43e074(0x1e6)][_0x43e074(0x1ff)](_0x43e074(0x1b5),_0x43e074(0x183),_0x5220bf['status'],_0x37ffd0,_0xe3defd),console['log'](_0x43e074(0x1e8));}catch(_0x252d97){console[_0x43e074(0x1ed)](_0x43e074(0x15f),_0x252d97),loggerService_1[_0x43e074(0x1e6)][_0x43e074(0x170)](_0x43e074(0x1b5),'/status_decrypt',_0x43e074(0x13a)+_0x252d97),_0x37ffd0=_0x36e07b;}}else loggerService_1[_0x43e074(0x1e6)][_0x43e074(0x1ff)](_0x43e074(0x1b5),_0x43e074(0x183),_0x5220bf[_0x43e074(0x1a2)],_0x37ffd0,_0xe3defd),console[_0x43e074(0x128)]('📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted');console[_0x43e074(0x128)](_0x43e074(0x1ba),{'status':_0x37ffd0[_0x43e074(0x1a2)],'final':_0x37ffd0['final'],'payment_id':_0x37ffd0[_0x43e074(0x12f)],'desc':_0x37ffd0[_0x43e074(0x126)]});let _0x263e78=_0x43e074(0x1d6);if(_0x37ffd0[_0x43e074(0x1a2)]===0x1&&_0x37ffd0[_0x43e074(0x16b)]===0x1)_0x263e78=_0x43e074(0x1b6);else _0x37ffd0[_0x43e074(0x1a2)]===0x0&&_0x37ffd0[_0x43e074(0x16b)]===0x0?_0x263e78=_0x43e074(0x1d6):_0x263e78='FAILED';return{'status':_0x263e78,'final':_0x37ffd0[_0x43e074(0x16b)]===0x1,'amount':_0x37ffd0['amount'],'currency':_0x37ffd0[_0x43e074(0x1ac)],'date_success':_0x37ffd0[_0x43e074(0x1dd)],'description':_0x37ffd0[_0x43e074(0x126)]};}catch(_0x43886e){console[_0x43e074(0x1ed)](_0x43e074(0x174),_0x43886e),loggerService_1[_0x43e074(0x1e6)][_0x43e074(0x170)](_0x43e074(0x1b5),_0x43e074(0x1cb),_0x43886e);throw new Error('Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20'+(_0x43886e instanceof Error?_0x43886e[_0x43e074(0x1cf)]:_0x43e074(0x11d)));}}[a42_0x366c84(0x14c)](_0x19abab,_0x24256d,_0xc7c80f){const _0x298e=a42_0x366c84;console[_0x298e(0x128)](_0x298e(0x1cc)+_0x19abab+'\x20('+_0xc7c80f+')'),this[_0x298e(0x1e7)](_0x19abab);const _0x266798=[],_0x65a508=0x5*0x3c*0x3e8,_0x18738f=0x2*0x3c*0x3c*0x3e8,_0x4c05ab=Math[_0x298e(0x176)](_0x18738f/_0x65a508);console[_0x298e(0x128)](_0x298e(0x197)+_0x4c05ab+_0x298e(0x19a));for(let _0x4b85fe=0x1;_0x4b85fe<=_0x4c05ab;_0x4b85fe++){const _0x329976=setTimeout(async()=>{const _0x38a1a5=_0x298e;console[_0x38a1a5(0x128)](_0x38a1a5(0x1a6)+_0x4b85fe+'/'+_0x4c05ab+_0x38a1a5(0x181)+_0x19abab);try{const _0x498571=await this['checkPaymentStatus'](_0xc7c80f,_0x24256d);console[_0x38a1a5(0x128)](_0x38a1a5(0x172)+_0x4b85fe+_0x38a1a5(0x156),_0x498571),_0x498571[_0x38a1a5(0x16b)]&&(console[_0x38a1a5(0x128)]('✅\x20Payment\x20'+_0x19abab+'\x20is\x20final\x20('+_0x498571[_0x38a1a5(0x1a2)]+_0x38a1a5(0x157)),this[_0x38a1a5(0x1e7)](_0x19abab),await this[_0x38a1a5(0x1da)](_0x19abab,_0x498571['status'],_0x498571));}catch(_0xcea5f2){console[_0x38a1a5(0x1ed)](_0x38a1a5(0x1f4)+_0x4b85fe+'\x20failed\x20for\x20payment\x20'+_0x19abab+':',_0xcea5f2);}},_0x4b85fe*_0x65a508);_0x266798[_0x298e(0x133)](_0x329976);}this[_0x298e(0x188)][_0x298e(0x1e5)](_0x19abab,_0x266798),console[_0x298e(0x128)]('✅\x20Scheduled\x20'+_0x4c05ab+'\x20status\x20checks\x20for\x20payment\x20'+_0x19abab);}[a42_0x366c84(0x1e7)](_0x50e0ac){const _0x312c28=a42_0x366c84,_0x21ea35=this[_0x312c28(0x188)][_0x312c28(0x1fa)](_0x50e0ac);_0x21ea35&&(console[_0x312c28(0x128)](_0x312c28(0x1a3)+_0x21ea35[_0x312c28(0x1a4)]+_0x312c28(0x136)+_0x50e0ac),_0x21ea35[_0x312c28(0x1bb)]((_0x2d5702,_0x578f6e)=>{clearTimeout(_0x2d5702);}),this[_0x312c28(0x188)]['delete'](_0x50e0ac));}async['updatePaymentStatus'](_0x1a383e,_0x33560b,_0x5ed957){const _0x1cc7da=a42_0x366c84;try{const _0x5135f0=(await Promise[_0x1cc7da(0x14e)]()[_0x1cc7da(0x1df)](()=>__importStar(require('../../config/database'))))[_0x1cc7da(0x1eb)],_0x5ddd10={'status':_0x33560b[_0x1cc7da(0x143)](),'updatedAt':new Date(),'statusChangedBy':_0x1cc7da(0x167),'statusChangedAt':new Date()};_0x33560b===_0x1cc7da(0x1b6)&&(_0x5ddd10['paidAt']=new Date()),_0x5ed957[_0x1cc7da(0x108)]&&(_0x5ddd10[_0x1cc7da(0x1b2)]=_0x1cc7da(0x135)+_0x5ed957['description']),await _0x5135f0[_0x1cc7da(0x1b9)]['update']({'where':{'id':_0x1a383e},'data':_0x5ddd10}),console[_0x1cc7da(0x128)](_0x1cc7da(0x1e3)+_0x1a383e+_0x1cc7da(0x13f)+_0x33560b),await this['sendPaymentNotifications'](_0x1a383e,_0x33560b);}catch(_0x174148){console[_0x1cc7da(0x1ed)](_0x1cc7da(0x115)+_0x1a383e+':',_0x174148);}}async[a42_0x366c84(0x200)](_0x3168d8,_0x4e889d){const _0x4dd487=a42_0x366c84;try{const _0x2f05ef=(await Promise[_0x4dd487(0x14e)]()['then'](()=>__importStar(require(_0x4dd487(0x19c)))))[_0x4dd487(0x1eb)],{telegramBotService:_0x16399f}=await Promise[_0x4dd487(0x14e)]()['then'](()=>__importStar(require('../telegramBotService'))),_0x1dc9a5=await _0x2f05ef[_0x4dd487(0x1b9)]['findUnique']({'where':{'id':_0x3168d8},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1dc9a5)return;const _0x1bcef5={'PAID':_0x4dd487(0x17e),'FAILED':_0x4dd487(0x118)},_0x37743d=_0x1bcef5[_0x4e889d];_0x37743d&&await _0x16399f['sendPaymentNotification'](_0x1dc9a5['shopId'],_0x1dc9a5,_0x37743d),await this[_0x4dd487(0x1e1)](_0x1dc9a5,_0x4e889d);}catch(_0xcdffca){console[_0x4dd487(0x1ed)](_0x4dd487(0x1af),_0xcdffca);}}async['sendShopWebhook'](_0xb504a2,_0x3023da){const _0x3e40c8=a42_0x366c84,_0x4d1fb9=Date[_0x3e40c8(0x151)]();try{const _0x5d93f9=_0xb504a2['shop'],_0x508db3=_0x5d93f9[_0x3e40c8(0x1a5)];if(!_0x508db3?.[_0x3e40c8(0x187)]){console[_0x3e40c8(0x128)](_0x3e40c8(0x19d)+_0x5d93f9['id']);return;}const _0x284cfa=_0x3023da===_0x3e40c8(0x1b6)?_0x3e40c8(0x1e9):_0x3e40c8(0x1ee);let _0x3ab912=[];if(_0x508db3[_0x3e40c8(0x12c)])try{_0x3ab912=Array[_0x3e40c8(0x10d)](_0x508db3[_0x3e40c8(0x12c)])?_0x508db3[_0x3e40c8(0x12c)]:JSON[_0x3e40c8(0x178)](_0x508db3['webhookEvents']);}catch(_0x5147c0){console['error'](_0x3e40c8(0x1d1),_0x5147c0),_0x3ab912=[];}if(!_0x3ab912[_0x3e40c8(0x1c2)](_0x284cfa)){console['log'](_0x3e40c8(0x1d5)+_0x284cfa+_0x3e40c8(0x184)+_0x5d93f9['id']);return;}const _0x354430={'event':_0x284cfa,'payment':{'id':_0xb504a2['id'],'order_id':_0xb504a2[_0x3e40c8(0x173)],'gateway_order_id':_0xb504a2[_0x3e40c8(0x10f)],'gateway':'1111','amount':_0xb504a2[_0x3e40c8(0x1d3)],'currency':_0xb504a2[_0x3e40c8(0x1ac)],'status':_0x3023da[_0x3e40c8(0x1b1)](),'customer_email':_0xb504a2[_0x3e40c8(0x112)],'customer_name':_0xb504a2[_0x3e40c8(0x193)],'created_at':_0xb504a2['createdAt'],'updated_at':new Date()}},_0x27278c=await fetch(_0x508db3[_0x3e40c8(0x187)],{'method':_0x3e40c8(0x175),'headers':{'Content-Type':_0x3e40c8(0x12a),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x3e40c8(0x1b8)](_0x354430)}),_0x2f646e=Date[_0x3e40c8(0x151)]()-_0x4d1fb9;loggerService_1[_0x3e40c8(0x1e6)][_0x3e40c8(0x1a0)](_0xb504a2[_0x3e40c8(0x120)],_0x508db3[_0x3e40c8(0x187)],_0x284cfa,_0x27278c[_0x3e40c8(0x1a2)],_0x2f646e,_0x354430),console[_0x3e40c8(0x128)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x508db3[_0x3e40c8(0x187)]+'\x20with\x20status\x20'+_0x27278c[_0x3e40c8(0x1a2)]+'\x20('+_0x2f646e+_0x3e40c8(0x1a9));}catch(_0x5e829a){console[_0x3e40c8(0x1ed)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x5e829a),loggerService_1['loggerService'][_0x3e40c8(0x17c)](_0xb504a2['shopId'],_0xb504a2[_0x3e40c8(0x180)]?.[_0x3e40c8(0x1a5)]?.['webhookUrl']||_0x3e40c8(0x18e),'webhook_send',_0x5e829a,{});}}[a42_0x366c84(0x129)](_0x2d1ac5){const _0x13b00f=a42_0x366c84,_0x505c6e=_0x2d1ac5[_0x13b00f(0x140)](/[\s-]/g,'');if(_0x505c6e[_0x13b00f(0x1a4)]<0x4)return'****';return'****\x20****\x20****\x20'+_0x505c6e[_0x13b00f(0x15c)](-0x4);}async['processWebhook'](_0x1d650c){const _0x1bd026=a42_0x366c84;console[_0x1bd026(0x128)](_0x1bd026(0x12b),_0x1d650c);let _0x1633a5=_0x1bd026(0x1d6);if(_0x1d650c[_0x1bd026(0x1a2)]===0x1&&_0x1d650c[_0x1bd026(0x16b)]===0x1)_0x1633a5=_0x1bd026(0x1b6);else _0x1d650c[_0x1bd026(0x1a2)]===0x0&&_0x1d650c[_0x1bd026(0x16b)]===0x0?_0x1633a5='PENDING':_0x1633a5='FAILED';return{'paymentId':_0x1d650c[_0x1bd026(0x1aa)]||'','status':_0x1633a5,'amount':_0x1d650c[_0x1bd026(0x1d3)],'currency':_0x1d650c[_0x1bd026(0x1ac)]};}['stopAllStatusChecks'](){const _0x4a9fbd=a42_0x366c84;console['log'](_0x4a9fbd(0x1f0));const _0x44d3d3=this[_0x4a9fbd(0x188)][_0x4a9fbd(0x110)];for(const [_0x35a7ac]of this['statusCheckTimers']){this[_0x4a9fbd(0x1e7)](_0x35a7ac);}console[_0x4a9fbd(0x128)](_0x4a9fbd(0x1c3)+_0x44d3d3+_0x4a9fbd(0x1d7));}}exports['MasterCardService']=MasterCardService;