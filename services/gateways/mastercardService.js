'use strict';const a42_0x1fa867=a42_0x4079;function a42_0x4079(_0x2e181b,_0x2c2783){const _0x2de81b=a42_0x2de8();return a42_0x4079=function(_0x407932,_0x372aa8){_0x407932=_0x407932-0xa7;let _0x29d566=_0x2de81b[_0x407932];return _0x29d566;},a42_0x4079(_0x2e181b,_0x2c2783);}(function(_0x5dc280,_0x328ddf){const _0x56a4e2=a42_0x4079,_0x14dc4d=_0x5dc280();while(!![]){try{const _0x4b9c3b=parseInt(_0x56a4e2(0x188))/0x1*(parseInt(_0x56a4e2(0x183))/0x2)+parseInt(_0x56a4e2(0x114))/0x3*(parseInt(_0x56a4e2(0xf8))/0x4)+-parseInt(_0x56a4e2(0xe3))/0x5*(-parseInt(_0x56a4e2(0x150))/0x6)+-parseInt(_0x56a4e2(0x101))/0x7+parseInt(_0x56a4e2(0x15e))/0x8*(parseInt(_0x56a4e2(0x143))/0x9)+-parseInt(_0x56a4e2(0xc1))/0xa+-parseInt(_0x56a4e2(0x170))/0xb;if(_0x4b9c3b===_0x328ddf)break;else _0x14dc4d['push'](_0x14dc4d['shift']());}catch(_0x1969b7){_0x14dc4d['push'](_0x14dc4d['shift']());}}}(a42_0x2de8,0x93974));var __createBinding=this&&this[a42_0x1fa867(0x12a)]||(Object[a42_0x1fa867(0x15b)]?function(_0x4f772f,_0x182545,_0x4c7789,_0x2818f2){const _0x29ae19=a42_0x1fa867;if(_0x2818f2===undefined)_0x2818f2=_0x4c7789;var _0x2a1975=Object['getOwnPropertyDescriptor'](_0x182545,_0x4c7789);(!_0x2a1975||(_0x29ae19(0xdd)in _0x2a1975?!_0x182545['__esModule']:_0x2a1975[_0x29ae19(0xa7)]||_0x2a1975['configurable']))&&(_0x2a1975={'enumerable':!![],'get':function(){return _0x182545[_0x4c7789];}}),Object['defineProperty'](_0x4f772f,_0x2818f2,_0x2a1975);}:function(_0x2336aa,_0x2f669e,_0x2a16c5,_0x34a5ad){if(_0x34a5ad===undefined)_0x34a5ad=_0x2a16c5;_0x2336aa[_0x34a5ad]=_0x2f669e[_0x2a16c5];}),__setModuleDefault=this&&this[a42_0x1fa867(0x104)]||(Object[a42_0x1fa867(0x15b)]?function(_0x1e8f35,_0x26fea9){const _0x3de8cc=a42_0x1fa867;Object[_0x3de8cc(0x16c)](_0x1e8f35,'default',{'enumerable':!![],'value':_0x26fea9});}:function(_0x3a700f,_0x1378a6){const _0x598de9=a42_0x1fa867;_0x3a700f[_0x598de9(0xfb)]=_0x1378a6;}),__importStar=this&&this[a42_0x1fa867(0x12d)]||(function(){var _0x2871b1=function(_0x280d0f){const _0x46e7f8=a42_0x4079;return _0x2871b1=Object[_0x46e7f8(0xe7)]||function(_0x4fe1f3){const _0x8dec81=_0x46e7f8;var _0x5703c1=[];for(var _0x3f950f in _0x4fe1f3)if(Object[_0x8dec81(0xf1)]['hasOwnProperty'][_0x8dec81(0xf6)](_0x4fe1f3,_0x3f950f))_0x5703c1[_0x5703c1['length']]=_0x3f950f;return _0x5703c1;},_0x2871b1(_0x280d0f);};return function(_0x575854){const _0x4fc300=a42_0x4079;if(_0x575854&&_0x575854['__esModule'])return _0x575854;var _0x389273={};if(_0x575854!=null){for(var _0x5548c0=_0x2871b1(_0x575854),_0x21142d=0x0;_0x21142d<_0x5548c0[_0x4fc300(0x160)];_0x21142d++)if(_0x5548c0[_0x21142d]!==_0x4fc300(0xfb))__createBinding(_0x389273,_0x575854,_0x5548c0[_0x21142d]);}return __setModuleDefault(_0x389273,_0x575854),_0x389273;};}()),__importDefault=this&&this['__importDefault']||function(_0x1a359f){const _0x15d6ed=a42_0x1fa867;return _0x1a359f&&_0x1a359f[_0x15d6ed(0xad)]?_0x1a359f:{'default':_0x1a359f};};function a42_0x2de8(){const _0x178c14=['/charge_decrypt','updatePaymentStatus','Unknown\x20error','readFileSync','slice','error','📊\x20Status\x20check\x20#','/charge_decrypted','cwd','decryptAES','🔍\x20MasterCard\x20status\x20check\x20#','size','✅\x20Scheduled\x20','768610RgdlzX','scheduleStatusChecks','isArray','\x20\x20\x20-\x20method:\x20charge','📝\x20Data\x20to\x20sign\x20length:','end','PAID','/status_raw','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','/status_decrypted','cvv','last_name','✅\x20Status\x20response\x20decrypted\x20successfully','maskCardNumber','https://api.paydmeth.com/api','3ds_url','Card\x20Holder:','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','\x20\x20\x20-\x20merchant_point_id:','psp_public.pem','crypto','payment.success','createDecipheriv','constants',',\x20Desc:\x20','log','POST','toString','get','✅\x20Payment\x20successful','order_id','publicEncrypt','FAILED','set','253835eDEImx','\x20status\x20updated\x20to\x20','\x20result:','unknown','getOwnPropertyNames','floor','MasterCard\x20status\x20check\x20error:','decryptResponsePhp','private.pem','webhookEvents','checkPaymentStatus','publicKeyPath','📝\x20Encrypted\x20key\x20length:','system','prototype','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','info','-----BEGIN','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','call','customerName','1924TtrceD','now','MasterCard:\x20','default','✅\x20Payment\x20','utf8','🛑\x20Stopped\x20','findUnique','/charge','1301335PaEPpI','✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)','stringify','__setModuleDefault','createCipheriv','Error\x20details:','Webhook\x20event\x20','signRSA','statusCheckTimers','generateAESKey','🔐\x20Private\x20key\x20length:\x20','MasterCardService','desc','status','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','Response\x20Body:','HTTP\x20error!\x20status:\x20','❌\x20Failed\x20to\x20decrypt\x20status\x20response:','🔐\x20Public\x20key\x20path:','1149rgjVgD','PENDING','Card\x20Number:','****','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','\x20\x20\x20-\x20sign\x20length:','Public\x20key\x20file\x20not\x20found:\x20','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','merchantPointId','\x20characters','🔐\x20Private\x20key\x20path:','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20','📝\x20Signature\x20length:','📊\x20Status\x20check\x20result:','privateKeyPath','path','gatewayOrderId','HTTP\x20Status:','forEach','logShopWebhookError','__createBinding','paidAt','settings','__importStar','key','description','message','join','📝\x20Final\x20request\x20structure:','charge','existsSync','currency','\x20\x20\x20-\x20lang:\x20en','sign','application/json','createdAt','delete','),\x20stopping\x20status\x20checks','Failed\x20to\x20send\x20MasterCard\x20webhook:','Failed\x20to\x20send\x20payment\x20notifications:','Status:','base64','🔐\x20Data\x20signed\x20with\x20RSA','\x20not\x20enabled\x20for\x20shop\x20','first_name','18unkJWL','-----END','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','amount','privateDecrypt','trim','\x20failed\x20for\x20payment\x20','HTTP\x20','===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===','\x20is\x20final\x20(','toUpperCase','paid','****\x20****\x20****\x20','78sgfpwn','Payment\x20ID:','parse','resolve','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','from','SHA256','Failed\x20to\x20process\x20MasterCard\x20payment:\x20',',\x20Final:\x20','json','1111','create','final','Response\x20Time:','4447728ByuGTW','📝\x20Encrypted\x20data\x20length:','length','❌\x20PHP\x20decryptor\x20request\x20failed:','Final:','encryptRSA','⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20','failed','❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20','validateKeyFiles','customerEmail','replace','Processing\x20MasterCard\x20webhook:','../loggerService','defineProperty','💳\x20MasterCard\x20service\x20initialized','RSA_PKCS1_PADDING','text','24411420wLYpvO','\x20with\x20status\x20','date_success','shop','encryptAES','🔐\x20Public\x20key\x20length:\x20','❌\x20Data\x20being\x20signed:','decryptResponse','randomBytes','createSign','number','🔐\x20AES\x20key\x20length:','mastercard','Decryption\x20failed:\x20','ms)','shopId','sendPaymentNotifications','logWhiteDomainResponse','../../config/database','5596WCyZGT','logWhiteDomainError','logShopWebhookSent','then','📝\x20Data\x20length:','404WdCyQp','payment_id','aes-256-ctr','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','keys','webhookUrl','🔐\x20RSA\x20signing\x20successful','❌\x20MasterCard\x20key\x20validation\x20failed:','update','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','orderId','webhook_send','❌\x20Status\x20check\x20#','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','expire_month','stopAllStatusChecks','apiUrl','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','Failed\x20to\x20decrypt\x20response\x20via\x20PHP','writable','loggerService','sendShopWebhook','Return\x20URL:','\x20\x20\x20-\x20info\x20length:','TesSoft\x20Payment\x20System/1.0','__esModule','Status\x20decryption\x20failed:\x20','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','clearStatusTimers','substring','/status','includes'];a42_0x2de8=function(){return _0x178c14;};return a42_0x2de8();}Object[a42_0x1fa867(0x16c)](exports,a42_0x1fa867(0xad),{'value':!![]}),exports['MasterCardService']=void 0x0;const crypto_1=__importDefault(require(a42_0x1fa867(0xd5))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0x1fa867(0x125))),loggerService_1=require(a42_0x1fa867(0x16b));class MasterCardService{constructor(){const _0x39dffc=a42_0x1fa867;this[_0x39dffc(0x109)]=new Map(),this[_0x39dffc(0x198)]=_0x39dffc(0xcf),this[_0x39dffc(0x11e)]=0x67c,this[_0x39dffc(0x124)]=path_1[_0x39dffc(0xfb)][_0x39dffc(0x131)](process[_0x39dffc(0xbc)](),_0x39dffc(0x18c),_0x39dffc(0xeb)),this[_0x39dffc(0xee)]=path_1['default'][_0x39dffc(0x131)](process[_0x39dffc(0xbc)](),_0x39dffc(0x18c),_0x39dffc(0xd4)),console[_0x39dffc(0xda)](_0x39dffc(0x16d)),console['log'](_0x39dffc(0x120),this['privateKeyPath']),console['log'](_0x39dffc(0x113),this[_0x39dffc(0xee)]),this[_0x39dffc(0x167)]();}['validateKeyFiles'](){const _0x19ef0d=a42_0x1fa867;try{if(!fs_1[_0x19ef0d(0xfb)]['existsSync'](this[_0x19ef0d(0x124)]))throw new Error('Private\x20key\x20file\x20not\x20found:\x20'+this['privateKeyPath']);if(!fs_1[_0x19ef0d(0xfb)][_0x19ef0d(0x134)](this[_0x19ef0d(0xee)]))throw new Error(_0x19ef0d(0x11b)+this[_0x19ef0d(0xee)]);const _0x26964f=fs_1['default'][_0x19ef0d(0xb7)](this['privateKeyPath'],'utf8')['trim'](),_0x246387=fs_1[_0x19ef0d(0xfb)][_0x19ef0d(0xb7)](this[_0x19ef0d(0xee)],_0x19ef0d(0xfd))[_0x19ef0d(0x148)]();if(!_0x26964f[_0x19ef0d(0xb3)](_0x19ef0d(0xf4))||!_0x26964f[_0x19ef0d(0xb3)](_0x19ef0d(0x144)))throw new Error(_0x19ef0d(0x154));if(!_0x246387['includes'](_0x19ef0d(0xf4))||!_0x246387['includes'](_0x19ef0d(0x144)))throw new Error('Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format');console[_0x19ef0d(0xda)](_0x19ef0d(0x145)),console[_0x19ef0d(0xda)](_0x19ef0d(0x10b)+_0x26964f[_0x19ef0d(0x160)]+_0x19ef0d(0x11f)),console[_0x19ef0d(0xda)](_0x19ef0d(0x175)+_0x246387[_0x19ef0d(0x160)]+_0x19ef0d(0x11f));}catch(_0x1e2dfb){console['error'](_0x19ef0d(0x18f),_0x1e2dfb);throw _0x1e2dfb;}}[a42_0x1fa867(0x10a)](){const _0x1844d9=a42_0x1fa867,_0x588ca0=crypto_1['default'][_0x1844d9(0x178)](0x20),_0x253213=crypto_1['default'][_0x1844d9(0x178)](0x10);return{'key':_0x588ca0,'iv':_0x253213};}['encryptAES'](_0x12ea71,_0x2da22f,_0x3785ba){const _0x374e29=a42_0x1fa867,_0x4b3f7f=crypto_1[_0x374e29(0xfb)][_0x374e29(0x105)](_0x374e29(0x18a),_0x2da22f,_0x3785ba);let _0x4d4ca3=_0x4b3f7f[_0x374e29(0x190)](_0x12ea71,_0x374e29(0xfd),_0x374e29(0x13f));return _0x4d4ca3+=_0x4b3f7f['final'](_0x374e29(0x13f)),_0x4d4ca3;}['encryptRSA'](_0x324446,_0x2489f4){const _0x1b8aaf=a42_0x1fa867;try{const _0x23b23d=fs_1[_0x1b8aaf(0xfb)]['readFileSync'](this['publicKeyPath'],_0x1b8aaf(0xfd))[_0x1b8aaf(0x148)](),_0x353728={'iv':_0x2489f4[_0x1b8aaf(0xdc)](_0x1b8aaf(0x13f)),'key':_0x324446[_0x1b8aaf(0xdc)]('base64')},_0x5a836a=JSON[_0x1b8aaf(0x103)](_0x353728);console[_0x1b8aaf(0xda)](_0x1b8aaf(0x195),_0x5a836a[_0x1b8aaf(0x160)]);const _0x3d104a=crypto_1['default'][_0x1b8aaf(0xe0)]({'key':_0x23b23d,'padding':crypto_1[_0x1b8aaf(0xfb)][_0x1b8aaf(0xd8)][_0x1b8aaf(0x16e)]},Buffer[_0x1b8aaf(0x155)](_0x5a836a));return console[_0x1b8aaf(0xda)](_0x1b8aaf(0xaf),_0x3d104a['length']),_0x3d104a['toString']('base64');}catch(_0x255a6a){console['error']('❌\x20RSA\x20encryption\x20failed:',_0x255a6a);throw new Error(_0x1b8aaf(0x11c));}}[a42_0x1fa867(0x108)](_0xdd4576){const _0x2becb0=a42_0x1fa867;try{const _0x57312c=fs_1[_0x2becb0(0xfb)]['readFileSync'](this[_0x2becb0(0x124)],_0x2becb0(0xfd))[_0x2becb0(0x148)](),_0x2617e6=crypto_1['default'][_0x2becb0(0x179)](_0x2becb0(0x156));_0x2617e6[_0x2becb0(0x190)](_0xdd4576),_0x2617e6[_0x2becb0(0xc6)]();const _0x5248bf=_0x2617e6[_0x2becb0(0x137)](_0x57312c,'base64');return console[_0x2becb0(0xda)](_0x2becb0(0x18e)),console[_0x2becb0(0xda)](_0x2becb0(0xc5),_0xdd4576[_0x2becb0(0x160)]),console[_0x2becb0(0xda)]('📝\x20Signature\x20length:',_0x5248bf[_0x2becb0(0x160)]),_0x5248bf;}catch(_0x191aa4){console['error']('❌\x20RSA\x20signing\x20failed:',_0x191aa4),console['error'](_0x2becb0(0x176),_0xdd4576[_0x2becb0(0xb1)](0x0,0xc8)+'...');throw new Error(_0x2becb0(0x119));}}[a42_0x1fa867(0xbd)](_0x295441,_0x5af71c,_0x29077f){const _0x1b01ae=a42_0x1fa867,_0x1c786a=crypto_1[_0x1b01ae(0xfb)][_0x1b01ae(0xd7)](_0x1b01ae(0x18a),_0x5af71c,_0x29077f);let _0x4a5a5b=_0x1c786a[_0x1b01ae(0x190)](_0x295441,'base64','utf8');return _0x4a5a5b+=_0x1c786a[_0x1b01ae(0x15c)](_0x1b01ae(0xfd)),_0x4a5a5b;}async['decryptResponsePhp'](_0x50b4cf,_0x1600f4){const _0x37614e=a42_0x1fa867;try{const _0xe68675=await fetch('https://api2.trapay.uk/decrypt.php',{'method':'POST','headers':{'Content-Type':_0x37614e(0x138)},'body':JSON[_0x37614e(0x103)]({'info':_0x50b4cf,'key':_0x1600f4})});if(!_0xe68675['ok'])throw new Error('PHP\x20decryptor\x20error');return await _0xe68675[_0x37614e(0x16f)]();}catch(_0x5bedf8){console[_0x37614e(0xb9)](_0x37614e(0x161),_0x5bedf8);throw new Error(_0x37614e(0x19a));}}[a42_0x1fa867(0x177)](_0x5beadb,_0x4c89e){const _0x5096a9=a42_0x1fa867;try{const _0x5b1cad=fs_1[_0x5096a9(0xfb)][_0x5096a9(0xb7)](this[_0x5096a9(0x124)],_0x5096a9(0xfd))[_0x5096a9(0x148)](),_0x46047d=crypto_1[_0x5096a9(0xfb)][_0x5096a9(0x147)](_0x5b1cad,Buffer['from'](_0x4c89e,_0x5096a9(0x13f))),_0xcdb624=JSON[_0x5096a9(0x152)](_0x46047d['toString']()),_0x2f001b=Buffer[_0x5096a9(0x155)](_0xcdb624[_0x5096a9(0x12e)],'base64'),_0x2728e8=Buffer[_0x5096a9(0x155)](_0xcdb624['iv'],_0x5096a9(0x13f));return this[_0x5096a9(0xbd)](_0x5beadb,_0x2f001b,_0x2728e8);}catch(_0xadb84d){throw new Error('Failed\x20to\x20decrypt\x20response');}}async['processCardPayment'](_0x6c4388){const _0x5b284a=a42_0x1fa867,{paymentId:_0x4074fa,orderId:_0x36204b,amount:_0x59adcb,currency:_0x44d507,cardData:_0x1a869c,resultUrl:_0x26d560,returnUrl:_0x365ee3,cardHolder:_0x56125d,browser:_0x1c212c}=_0x6c4388;console[_0x5b284a(0xda)]('===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20==='),console[_0x5b284a(0xda)](_0x5b284a(0x151),_0x4074fa),console['log']('Order\x20ID:',_0x36204b),console[_0x5b284a(0xda)]('Amount:',_0x59adcb,_0x44d507),console[_0x5b284a(0xda)](_0x5b284a(0x116),this[_0x5b284a(0xce)](_0x1a869c[_0x5b284a(0x17a)])),console[_0x5b284a(0xda)](_0x5b284a(0xd1),_0x56125d[_0x5b284a(0x142)]+'\x20'+_0x56125d[_0x5b284a(0xcc)]),console['log'](_0x5b284a(0xaa),_0x365ee3),console['log']('Result\x20URL:',_0x26d560);const _0x1cea78={'amount':_0x59adcb,'currency':_0x44d507[_0x5b284a(0x14d)](),'order_id':_0x36204b,'result_url':_0x26d560,'return_url':_0x365ee3,'card':{'number':_0x1a869c[_0x5b284a(0x17a)],'expire_month':_0x1a869c[_0x5b284a(0x196)],'expire_year':_0x1a869c['expire_year'],'cvv':_0x1a869c[_0x5b284a(0xcb)]},'card_holder':_0x56125d,'browser':_0x1c212c},_0x29b726=JSON[_0x5b284a(0x103)](_0x1cea78);console[_0x5b284a(0xda)]('💾\x20Payment\x20data\x20prepared'),console['log'](_0x5b284a(0xf5)),console['log'](_0x29b726),console[_0x5b284a(0xda)](_0x5b284a(0x187),_0x29b726[_0x5b284a(0x160)]);try{const {key:_0x1df07a,iv:_0x53f781}=this[_0x5b284a(0x10a)]();console['log']('🔐\x20AES\x20key\x20and\x20IV\x20generated'),console[_0x5b284a(0xda)](_0x5b284a(0x17b),_0x1df07a['length']),console[_0x5b284a(0xda)]('🔐\x20AES\x20IV\x20length:',_0x53f781[_0x5b284a(0x160)]);const _0x1279df=this[_0x5b284a(0x174)](_0x29b726,_0x1df07a,_0x53f781);console['log']('🔐\x20Data\x20encrypted\x20with\x20AES'),console[_0x5b284a(0xda)](_0x5b284a(0x15f),_0x1279df[_0x5b284a(0x160)]);const _0x2d7707=this['encryptRSA'](_0x1df07a,_0x53f781);console[_0x5b284a(0xda)]('🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA'),console[_0x5b284a(0xda)](_0x5b284a(0xef),_0x2d7707['length']);const _0x4a17cb=this[_0x5b284a(0x108)](_0x29b726);console['log'](_0x5b284a(0x140)),console[_0x5b284a(0xda)](_0x5b284a(0x122),_0x4a17cb[_0x5b284a(0x160)]);const _0x1bb935={'merchant_point_id':this[_0x5b284a(0x11e)],'method':_0x5b284a(0x133),'info':_0x1279df,'key':_0x2d7707,'sign':_0x4a17cb,'lang':'en'};console[_0x5b284a(0xda)]('📤\x20Sending\x20request\x20to\x20MasterCard\x20API...'),console['log'](_0x5b284a(0x132)),console['log'](_0x5b284a(0xd3),this[_0x5b284a(0x11e)]),console[_0x5b284a(0xda)](_0x5b284a(0xc4)),console[_0x5b284a(0xda)](_0x5b284a(0xab),_0x1279df[_0x5b284a(0x160)]),console[_0x5b284a(0xda)]('\x20\x20\x20-\x20key\x20length:',_0x2d7707['length']),console[_0x5b284a(0xda)](_0x5b284a(0x11a),_0x4a17cb['length']),console['log'](_0x5b284a(0x136)),loggerService_1['loggerService']['logWhiteDomainRequest'](_0x5b284a(0x17c),_0x5b284a(0x100),_0x5b284a(0xdb),{'merchant_point_id':this[_0x5b284a(0x11e)],'method':_0x5b284a(0x133),'lang':'en'});const _0x16a6da=Date[_0x5b284a(0xf9)](),_0x36b468=await fetch(this[_0x5b284a(0x198)],{'method':'POST','headers':{'Content-Type':_0x5b284a(0x138),'Accept':_0x5b284a(0x138),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x1bb935)}),_0x2b64a6=Date[_0x5b284a(0xf9)]()-_0x16a6da;console[_0x5b284a(0xda)](_0x5b284a(0xf2)),console[_0x5b284a(0xda)](_0x5b284a(0x13e),_0x36b468['status']),console[_0x5b284a(0xda)](_0x5b284a(0x15d),_0x2b64a6+'ms');if(!_0x36b468['ok']){const _0x3406f0=await _0x36b468[_0x5b284a(0x16f)]();console['error'](_0x5b284a(0x127),_0x36b468[_0x5b284a(0x10e)]),console['error'](_0x5b284a(0x110),_0x3406f0),loggerService_1[_0x5b284a(0xa8)][_0x5b284a(0x181)]('mastercard','/charge_raw',_0x36b468['status'],_0x3406f0,_0x2b64a6),loggerService_1[_0x5b284a(0xa8)][_0x5b284a(0x184)](_0x5b284a(0x17c),_0x5b284a(0x100),_0x5b284a(0x14a)+_0x36b468[_0x5b284a(0x10e)]+':\x20'+_0x3406f0);throw new Error(_0x5b284a(0x111)+_0x36b468['status']+',\x20body:\x20'+_0x3406f0);}const _0x24e90a=await _0x36b468[_0x5b284a(0x159)]();loggerService_1[_0x5b284a(0xa8)][_0x5b284a(0x181)](_0x5b284a(0x17c),'/charge_raw',_0x36b468[_0x5b284a(0x10e)],_0x24e90a,_0x2b64a6),console[_0x5b284a(0xda)](_0x5b284a(0x14b));let _0x2f7dd7=_0x24e90a;if(_0x24e90a['info']&&_0x24e90a[_0x5b284a(0x12e)]&&_0x24e90a['sign']){console['log'](_0x5b284a(0x191));try{const _0x2a5b6e=await this[_0x5b284a(0xea)](_0x24e90a['info'],_0x24e90a[_0x5b284a(0x12e)]);_0x2f7dd7=JSON[_0x5b284a(0x152)](_0x2a5b6e),console[_0x5b284a(0xda)](_0x5b284a(0x102)),loggerService_1[_0x5b284a(0xa8)][_0x5b284a(0x181)](_0x5b284a(0x17c),_0x5b284a(0xbb),_0x36b468[_0x5b284a(0x10e)],_0x2f7dd7,_0x2b64a6),console[_0x5b284a(0xda)]('📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted');}catch(_0x50eb0a){console['error']('❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):',_0x50eb0a),loggerService_1[_0x5b284a(0xa8)][_0x5b284a(0x184)](_0x5b284a(0x17c),_0x5b284a(0xb4),_0x5b284a(0x17d)+_0x50eb0a),_0x2f7dd7=_0x24e90a;}}else loggerService_1[_0x5b284a(0xa8)]['logWhiteDomainResponse']('mastercard',_0x5b284a(0xbb),_0x36b468[_0x5b284a(0x10e)],_0x2f7dd7,_0x2b64a6),console[_0x5b284a(0xda)]('📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted');console[_0x5b284a(0xda)](_0x5b284a(0x13e),_0x2f7dd7['status']),console[_0x5b284a(0xda)](_0x5b284a(0x162),_0x2f7dd7[_0x5b284a(0x15c)]),console[_0x5b284a(0xda)](_0x5b284a(0x151),_0x2f7dd7[_0x5b284a(0x189)]),console[_0x5b284a(0xda)]('3DS\x20URL:',_0x2f7dd7[_0x5b284a(0xd0)]||'none');if(_0x2f7dd7[_0x5b284a(0x10e)]===0x64&&_0x2f7dd7[_0x5b284a(0x15c)]===0x1)return console[_0x5b284a(0xda)](_0x5b284a(0xde)),{'gateway_payment_id':_0x2f7dd7[_0x5b284a(0x189)]?.[_0x5b284a(0xdc)](),'payment_url':_0x365ee3,'requires_3ds':![],'status':_0x5b284a(0xc7),'final':!![]};if(_0x2f7dd7[_0x5b284a(0xd0)])return console[_0x5b284a(0xda)]('🔐\x203DS\x20verification\x20required'),this[_0x5b284a(0xc2)](_0x4074fa,_0x36204b,_0x2f7dd7['payment_id']?.['toString']()||_0x36204b),{'gateway_payment_id':_0x2f7dd7['payment_id']?.[_0x5b284a(0xdc)](),'payment_url':_0x2f7dd7[_0x5b284a(0xd0)],'requires_3ds':!![],'threeds_url':_0x2f7dd7[_0x5b284a(0xd0)],'status':'PENDING','final':![]};let _0x5bed26=_0x2f7dd7['desc']||_0x2f7dd7['message']||'Unknown\x20error',_0x1fc0b2=_0x2f7dd7[_0x5b284a(0x10e)],_0x4b2848=_0x2f7dd7[_0x5b284a(0x15c)];return console[_0x5b284a(0xda)](_0x5b284a(0x166)+_0x1fc0b2+_0x5b284a(0x158)+_0x4b2848+_0x5b284a(0xd9)+_0x5bed26),{'gateway_payment_id':_0x2f7dd7[_0x5b284a(0x189)]?.[_0x5b284a(0xdc)](),'payment_url':_0x365ee3,'requires_3ds':![],'status':_0x5b284a(0xe1),'final':!![]};}catch(_0x4a624d){console[_0x5b284a(0xb9)](_0x5b284a(0x118)),console[_0x5b284a(0xb9)](_0x5b284a(0x106),_0x4a624d),loggerService_1[_0x5b284a(0xa8)][_0x5b284a(0x184)](_0x5b284a(0x17c),'/charge',_0x4a624d);throw new Error(_0x5b284a(0x157)+(_0x4a624d instanceof Error?_0x4a624d[_0x5b284a(0x130)]:'Unknown\x20error'));}}async[a42_0x1fa867(0xed)](_0x3d473d,_0x4f10c9){const _0x38e663=a42_0x1fa867;console[_0x38e663(0xda)](_0x38e663(0x10f)+_0x3d473d+'\x20('+_0x4f10c9+')');try{const _0x19e236={'payment_id':_0x3d473d,'order_id':_0x4f10c9},_0x54805d=JSON[_0x38e663(0x103)](_0x19e236),{key:_0x5973bb,iv:_0x237386}=this[_0x38e663(0x10a)](),_0x21715c=this[_0x38e663(0x174)](_0x54805d,_0x5973bb,_0x237386),_0x5cc511=this[_0x38e663(0x163)](_0x5973bb,_0x237386),_0x529121=this['signRSA'](_0x54805d),_0x35bd08={'merchant_point_id':this[_0x38e663(0x11e)],'method':_0x38e663(0x10e),'info':_0x21715c,'key':_0x5cc511,'sign':_0x529121,'lang':'en'};loggerService_1['loggerService']['logWhiteDomainRequest'](_0x38e663(0x17c),_0x38e663(0xb2),_0x38e663(0xdb),{'merchant_point_id':this['merchantPointId'],'method':_0x38e663(0x10e),'lang':'en'});const _0x5c01e0=Date[_0x38e663(0xf9)](),_0x1b3a4e=await fetch(this[_0x38e663(0x198)],{'method':_0x38e663(0xdb),'headers':{'Content-Type':_0x38e663(0x138),'Accept':_0x38e663(0x138),'User-Agent':_0x38e663(0xac)},'body':JSON[_0x38e663(0x103)](_0x35bd08)}),_0x448d80=Date[_0x38e663(0xf9)]()-_0x5c01e0;if(!_0x1b3a4e['ok']){const _0x1fcf80=await _0x1b3a4e[_0x38e663(0x16f)]();loggerService_1['loggerService'][_0x38e663(0x181)](_0x38e663(0x17c),_0x38e663(0xc8),_0x1b3a4e[_0x38e663(0x10e)],_0x1fcf80,_0x448d80);throw new Error(_0x38e663(0x111)+_0x1b3a4e[_0x38e663(0x10e)]);}const _0x7f72b6=await _0x1b3a4e[_0x38e663(0x159)]();loggerService_1['loggerService']['logWhiteDomainResponse'](_0x38e663(0x17c),_0x38e663(0xc8),_0x1b3a4e[_0x38e663(0x10e)],_0x7f72b6,_0x448d80);let _0x538147=_0x7f72b6;if(_0x7f72b6['info']&&_0x7f72b6[_0x38e663(0x12e)]&&_0x7f72b6[_0x38e663(0x137)]){console[_0x38e663(0xda)](_0x38e663(0xd2));try{const _0x429708=this[_0x38e663(0x177)](_0x7f72b6[_0x38e663(0xf3)],_0x7f72b6[_0x38e663(0x12e)]);_0x538147=JSON[_0x38e663(0x152)](_0x429708),console[_0x38e663(0xda)](_0x38e663(0xcd)),loggerService_1[_0x38e663(0xa8)][_0x38e663(0x181)](_0x38e663(0x17c),'/status_decrypted',_0x1b3a4e[_0x38e663(0x10e)],_0x538147,_0x448d80),console[_0x38e663(0xda)](_0x38e663(0x18b));}catch(_0x5c79ba){console[_0x38e663(0xb9)](_0x38e663(0x112),_0x5c79ba),loggerService_1[_0x38e663(0xa8)][_0x38e663(0x184)](_0x38e663(0x17c),'/status_decrypt',_0x38e663(0xae)+_0x5c79ba),_0x538147=_0x7f72b6;}}else loggerService_1[_0x38e663(0xa8)][_0x38e663(0x181)](_0x38e663(0x17c),_0x38e663(0xca),_0x1b3a4e[_0x38e663(0x10e)],_0x538147,_0x448d80),console[_0x38e663(0xda)]('📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted');console[_0x38e663(0xda)](_0x38e663(0x123),{'status':_0x538147[_0x38e663(0x10e)],'final':_0x538147[_0x38e663(0x15c)],'payment_id':_0x538147[_0x38e663(0x189)],'desc':_0x538147[_0x38e663(0x10d)]});let _0x26b707=_0x38e663(0x115);if(_0x538147['status']===0x1&&_0x538147[_0x38e663(0x15c)]===0x1)_0x26b707=_0x38e663(0xc7);else _0x538147['status']===0x0&&_0x538147[_0x38e663(0x15c)]===0x0?_0x26b707=_0x38e663(0x115):_0x26b707='FAILED';return{'status':_0x26b707,'final':_0x538147[_0x38e663(0x15c)]===0x1,'amount':_0x538147['amount'],'currency':_0x538147[_0x38e663(0x135)],'date_success':_0x538147[_0x38e663(0x172)],'description':_0x538147[_0x38e663(0x10d)]};}catch(_0x68f5e6){console[_0x38e663(0xb9)](_0x38e663(0xe9),_0x68f5e6),loggerService_1[_0x38e663(0xa8)][_0x38e663(0x184)](_0x38e663(0x17c),_0x38e663(0xb2),_0x68f5e6);throw new Error('Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20'+(_0x68f5e6 instanceof Error?_0x68f5e6[_0x38e663(0x130)]:_0x38e663(0xb6)));}}[a42_0x1fa867(0xc2)](_0x403dab,_0x431b75,_0x837b3e){const _0x208ae8=a42_0x1fa867;console[_0x208ae8(0xda)](_0x208ae8(0x164)+_0x403dab+'\x20('+_0x837b3e+')'),this['clearStatusTimers'](_0x403dab);const _0x151d41=[],_0x398836=0x5*0x3c*0x3e8,_0x6333fe=0x2*0x3c*0x3c*0x3e8,_0x5c5898=Math[_0x208ae8(0xe8)](_0x6333fe/_0x398836);console[_0x208ae8(0xda)]('⏰\x20Will\x20check\x20status\x20'+_0x5c5898+_0x208ae8(0x11d));for(let _0x343464=0x1;_0x343464<=_0x5c5898;_0x343464++){const _0x28fd2f=setTimeout(async()=>{const _0x5e2969=_0x208ae8;console[_0x5e2969(0xda)](_0x5e2969(0xbe)+_0x343464+'/'+_0x5c5898+'\x20for\x20payment\x20'+_0x403dab);try{const _0x585912=await this['checkPaymentStatus'](_0x837b3e,_0x431b75);console['log'](_0x5e2969(0xba)+_0x343464+_0x5e2969(0xe5),_0x585912),_0x585912[_0x5e2969(0x15c)]&&(console[_0x5e2969(0xda)](_0x5e2969(0xfc)+_0x403dab+_0x5e2969(0x14c)+_0x585912[_0x5e2969(0x10e)]+_0x5e2969(0x13b)),this[_0x5e2969(0xb0)](_0x403dab),await this[_0x5e2969(0xb5)](_0x403dab,_0x585912[_0x5e2969(0x10e)],_0x585912));}catch(_0x1fbdb0){console[_0x5e2969(0xb9)](_0x5e2969(0x194)+_0x343464+_0x5e2969(0x149)+_0x403dab+':',_0x1fbdb0);}},_0x343464*_0x398836);_0x151d41['push'](_0x28fd2f);}this[_0x208ae8(0x109)][_0x208ae8(0xe2)](_0x403dab,_0x151d41),console[_0x208ae8(0xda)](_0x208ae8(0xc0)+_0x5c5898+'\x20status\x20checks\x20for\x20payment\x20'+_0x403dab);}[a42_0x1fa867(0xb0)](_0x5ef86b){const _0x5d5045=a42_0x1fa867,_0x31ce2b=this[_0x5d5045(0x109)][_0x5d5045(0xdd)](_0x5ef86b);_0x31ce2b&&(console['log']('🧹\x20Clearing\x20'+_0x31ce2b[_0x5d5045(0x160)]+'\x20status\x20timers\x20for\x20payment\x20'+_0x5ef86b),_0x31ce2b[_0x5d5045(0x128)]((_0x1bf4a9,_0x113d37)=>{clearTimeout(_0x1bf4a9);}),this[_0x5d5045(0x109)][_0x5d5045(0x13a)](_0x5ef86b));}async[a42_0x1fa867(0xb5)](_0x5ef2c3,_0x391bb6,_0x1d8e98){const _0x59036e=a42_0x1fa867;try{const _0x31398e=(await Promise[_0x59036e(0x153)]()[_0x59036e(0x186)](()=>__importStar(require(_0x59036e(0x182)))))[_0x59036e(0xfb)],_0x37c647={'status':_0x391bb6['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x59036e(0xf0),'statusChangedAt':new Date()};_0x391bb6===_0x59036e(0xc7)&&(_0x37c647[_0x59036e(0x12b)]=new Date()),_0x1d8e98[_0x59036e(0x12f)]&&(_0x37c647['adminNotes']=_0x59036e(0xfa)+_0x1d8e98[_0x59036e(0x12f)]),await _0x31398e['payment'][_0x59036e(0x190)]({'where':{'id':_0x5ef2c3},'data':_0x37c647}),console[_0x59036e(0xda)](_0x59036e(0xfc)+_0x5ef2c3+_0x59036e(0xe4)+_0x391bb6),await this[_0x59036e(0x180)](_0x5ef2c3,_0x391bb6);}catch(_0x39d81a){console[_0x59036e(0xb9)](_0x59036e(0x121)+_0x5ef2c3+':',_0x39d81a);}}async['sendPaymentNotifications'](_0x311835,_0x1f46f9){const _0x5118f0=a42_0x1fa867;try{const _0x595d32=(await Promise[_0x5118f0(0x153)]()[_0x5118f0(0x186)](()=>__importStar(require(_0x5118f0(0x182)))))[_0x5118f0(0xfb)],{telegramBotService:_0x4a7c1f}=await Promise[_0x5118f0(0x153)]()[_0x5118f0(0x186)](()=>__importStar(require('../telegramBotService'))),_0x3dc9b9=await _0x595d32['payment'][_0x5118f0(0xff)]({'where':{'id':_0x311835},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x3dc9b9)return;const _0x3792ec={'PAID':_0x5118f0(0x14e),'FAILED':_0x5118f0(0x165)},_0x595024=_0x3792ec[_0x1f46f9];_0x595024&&await _0x4a7c1f['sendPaymentNotification'](_0x3dc9b9[_0x5118f0(0x17f)],_0x3dc9b9,_0x595024),await this[_0x5118f0(0xa9)](_0x3dc9b9,_0x1f46f9);}catch(_0x477f5c){console[_0x5118f0(0xb9)](_0x5118f0(0x13d),_0x477f5c);}}async[a42_0x1fa867(0xa9)](_0x5b0f36,_0x5a8db1){const _0x1fc8e2=a42_0x1fa867,_0x322441=Date[_0x1fc8e2(0xf9)]();try{const _0x46123e=_0x5b0f36['shop'],_0x5a8d3c=_0x46123e[_0x1fc8e2(0x12c)];if(!_0x5a8d3c?.[_0x1fc8e2(0x18d)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x46123e['id']);return;}const _0xe9fce1=_0x5a8db1==='PAID'?_0x1fc8e2(0xd6):'payment.failed';let _0x16e950=[];if(_0x5a8d3c[_0x1fc8e2(0xec)])try{_0x16e950=Array[_0x1fc8e2(0xc3)](_0x5a8d3c[_0x1fc8e2(0xec)])?_0x5a8d3c[_0x1fc8e2(0xec)]:JSON[_0x1fc8e2(0x152)](_0x5a8d3c[_0x1fc8e2(0xec)]);}catch(_0x3dae5e){console[_0x1fc8e2(0xb9)]('Error\x20parsing\x20webhook\x20events:',_0x3dae5e),_0x16e950=[];}if(!_0x16e950[_0x1fc8e2(0xb3)](_0xe9fce1)){console[_0x1fc8e2(0xda)](_0x1fc8e2(0x107)+_0xe9fce1+_0x1fc8e2(0x141)+_0x46123e['id']);return;}const _0x4bb0e7={'event':_0xe9fce1,'payment':{'id':_0x5b0f36['id'],'order_id':_0x5b0f36[_0x1fc8e2(0x192)],'gateway_order_id':_0x5b0f36[_0x1fc8e2(0x126)],'gateway':_0x1fc8e2(0x15a),'amount':_0x5b0f36[_0x1fc8e2(0x146)],'currency':_0x5b0f36[_0x1fc8e2(0x135)],'status':_0x5a8db1['toLowerCase'](),'customer_email':_0x5b0f36[_0x1fc8e2(0x168)],'customer_name':_0x5b0f36[_0x1fc8e2(0xf7)],'created_at':_0x5b0f36[_0x1fc8e2(0x139)],'updated_at':new Date()}},_0x5da670=await fetch(_0x5a8d3c[_0x1fc8e2(0x18d)],{'method':_0x1fc8e2(0xdb),'headers':{'Content-Type':_0x1fc8e2(0x138),'User-Agent':_0x1fc8e2(0xc9)},'body':JSON[_0x1fc8e2(0x103)](_0x4bb0e7)}),_0x1b146f=Date[_0x1fc8e2(0xf9)]()-_0x322441;loggerService_1['loggerService'][_0x1fc8e2(0x185)](_0x5b0f36['shopId'],_0x5a8d3c[_0x1fc8e2(0x18d)],_0xe9fce1,_0x5da670[_0x1fc8e2(0x10e)],_0x1b146f,_0x4bb0e7),console[_0x1fc8e2(0xda)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x5a8d3c[_0x1fc8e2(0x18d)]+_0x1fc8e2(0x171)+_0x5da670[_0x1fc8e2(0x10e)]+'\x20('+_0x1b146f+_0x1fc8e2(0x17e));}catch(_0x7c613){console[_0x1fc8e2(0xb9)](_0x1fc8e2(0x13c),_0x7c613),loggerService_1['loggerService'][_0x1fc8e2(0x129)](_0x5b0f36[_0x1fc8e2(0x17f)],_0x5b0f36[_0x1fc8e2(0x173)]?.[_0x1fc8e2(0x12c)]?.[_0x1fc8e2(0x18d)]||_0x1fc8e2(0xe6),_0x1fc8e2(0x193),_0x7c613,{});}}[a42_0x1fa867(0xce)](_0xfc59bc){const _0x1e97ca=a42_0x1fa867,_0x47f918=_0xfc59bc[_0x1e97ca(0x169)](/[\s-]/g,'');if(_0x47f918['length']<0x4)return _0x1e97ca(0x117);return _0x1e97ca(0x14f)+_0x47f918[_0x1e97ca(0xb8)](-0x4);}async['processWebhook'](_0x17074d){const _0x3c4ebf=a42_0x1fa867;console[_0x3c4ebf(0xda)](_0x3c4ebf(0x16a),_0x17074d);let _0x364e5d=_0x3c4ebf(0x115);if(_0x17074d[_0x3c4ebf(0x10e)]===0x1&&_0x17074d[_0x3c4ebf(0x15c)]===0x1)_0x364e5d=_0x3c4ebf(0xc7);else _0x17074d[_0x3c4ebf(0x10e)]===0x0&&_0x17074d['final']===0x0?_0x364e5d=_0x3c4ebf(0x115):_0x364e5d=_0x3c4ebf(0xe1);return{'paymentId':_0x17074d[_0x3c4ebf(0xdf)]||'','status':_0x364e5d,'amount':_0x17074d[_0x3c4ebf(0x146)],'currency':_0x17074d[_0x3c4ebf(0x135)]};}[a42_0x1fa867(0x197)](){const _0x3752ce=a42_0x1fa867;console[_0x3752ce(0xda)](_0x3752ce(0x199));const _0x59304a=this['statusCheckTimers'][_0x3752ce(0xbf)];for(const [_0x50b154]of this['statusCheckTimers']){this[_0x3752ce(0xb0)](_0x50b154);}console[_0x3752ce(0xda)](_0x3752ce(0xfe)+_0x59304a+'\x20MasterCard\x20status\x20check\x20timers');}}exports[a42_0x1fa867(0x10c)]=MasterCardService;