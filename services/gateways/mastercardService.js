'use strict';const a42_0xca44ce=a42_0x18f0;(function(_0x52cb15,_0x429938){const _0x2b5ead=a42_0x18f0,_0x307702=_0x52cb15();while(!![]){try{const _0x2e1dd6=parseInt(_0x2b5ead(0x17b))/0x1+-parseInt(_0x2b5ead(0x186))/0x2*(parseInt(_0x2b5ead(0x1f2))/0x3)+-parseInt(_0x2b5ead(0x23b))/0x4+-parseInt(_0x2b5ead(0x1c2))/0x5*(-parseInt(_0x2b5ead(0x1f4))/0x6)+-parseInt(_0x2b5ead(0x1f0))/0x7*(-parseInt(_0x2b5ead(0x217))/0x8)+-parseInt(_0x2b5ead(0x24f))/0x9*(-parseInt(_0x2b5ead(0x23e))/0xa)+-parseInt(_0x2b5ead(0x264))/0xb;if(_0x2e1dd6===_0x429938)break;else _0x307702['push'](_0x307702['shift']());}catch(_0x58cde6){_0x307702['push'](_0x307702['shift']());}}}(a42_0x59ca,0x24827));var __createBinding=this&&this[a42_0xca44ce(0x1cb)]||(Object['create']?function(_0x340439,_0x1ef992,_0xa10ec7,_0x2e2827){const _0x4983ac=a42_0xca44ce;if(_0x2e2827===undefined)_0x2e2827=_0xa10ec7;var _0x240140=Object[_0x4983ac(0x1a8)](_0x1ef992,_0xa10ec7);(!_0x240140||(_0x4983ac(0x263)in _0x240140?!_0x1ef992[_0x4983ac(0x1ff)]:_0x240140[_0x4983ac(0x17d)]||_0x240140[_0x4983ac(0x213)]))&&(_0x240140={'enumerable':!![],'get':function(){return _0x1ef992[_0xa10ec7];}}),Object[_0x4983ac(0x24e)](_0x340439,_0x2e2827,_0x240140);}:function(_0x1e2a2a,_0x39af6c,_0x4d6342,_0x2d63de){if(_0x2d63de===undefined)_0x2d63de=_0x4d6342;_0x1e2a2a[_0x2d63de]=_0x39af6c[_0x4d6342];}),__setModuleDefault=this&&this[a42_0xca44ce(0x25d)]||(Object['create']?function(_0x4c25d1,_0xf3fad1){const _0x4513d9=a42_0xca44ce;Object[_0x4513d9(0x24e)](_0x4c25d1,_0x4513d9(0x206),{'enumerable':!![],'value':_0xf3fad1});}:function(_0x4c21cb,_0x3fa3ec){const _0x26efe1=a42_0xca44ce;_0x4c21cb[_0x26efe1(0x206)]=_0x3fa3ec;}),__importStar=this&&this[a42_0xca44ce(0x19d)]||(function(){var _0xca0b9a=function(_0x5a772b){const _0x14fb36=a42_0x18f0;return _0xca0b9a=Object[_0x14fb36(0x20f)]||function(_0x101967){const _0xf6d688=_0x14fb36;var _0x5e3d9a=[];for(var _0x580bcb in _0x101967)if(Object[_0xf6d688(0x173)][_0xf6d688(0x1a4)][_0xf6d688(0x1b7)](_0x101967,_0x580bcb))_0x5e3d9a[_0x5e3d9a[_0xf6d688(0x194)]]=_0x580bcb;return _0x5e3d9a;},_0xca0b9a(_0x5a772b);};return function(_0x290d6a){const _0x16fda0=a42_0x18f0;if(_0x290d6a&&_0x290d6a[_0x16fda0(0x1ff)])return _0x290d6a;var _0x2005cc={};if(_0x290d6a!=null){for(var _0x11ebe9=_0xca0b9a(_0x290d6a),_0x419fdc=0x0;_0x419fdc<_0x11ebe9[_0x16fda0(0x194)];_0x419fdc++)if(_0x11ebe9[_0x419fdc]!==_0x16fda0(0x206))__createBinding(_0x2005cc,_0x290d6a,_0x11ebe9[_0x419fdc]);}return __setModuleDefault(_0x2005cc,_0x290d6a),_0x2005cc;};}()),__importDefault=this&&this[a42_0xca44ce(0x1e8)]||function(_0x27f6de){const _0x3f4cbc=a42_0xca44ce;return _0x27f6de&&_0x27f6de[_0x3f4cbc(0x1ff)]?_0x27f6de:{'default':_0x27f6de};};function a42_0x18f0(_0x5b0cd9,_0x23708a){const _0x59ca10=a42_0x59ca();return a42_0x18f0=function(_0x18f0bd,_0x45cee6){_0x18f0bd=_0x18f0bd-0x169;let _0x1194d7=_0x59ca10[_0x18f0bd];return _0x1194d7;},a42_0x18f0(_0x5b0cd9,_0x23708a);}Object['defineProperty'](exports,a42_0xca44ce(0x1ff),{'value':!![]}),exports['MasterCardService']=void 0x0;const crypto_1=__importDefault(require(a42_0xca44ce(0x176))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0xca44ce(0x20c))),loggerService_1=require(a42_0xca44ce(0x21c));function a42_0x59ca(){const _0xa7801c=['🔐\x20Private\x20key\x20path:','updatePaymentStatus','createdAt','decryptResponse','key','🔐\x203DS\x20verification\x20required','/status','__createBinding','🔐\x20AES\x20key\x20and\x20IV\x20generated','message','/charge_raw','🔐\x20Data\x20encrypted\x20with\x20AES','PHP\x20decryptor\x20error','✅\x20Status\x20response\x20decrypted\x20successfully','✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','set','...','\x20\x20\x20-\x20info\x20length:','apiUrl','PENDING','⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20','🔐\x20Public\x20key\x20length:\x20','Failed\x20to\x20send\x20MasterCard\x20webhook:','Error\x20details:','🔐\x20RSA\x20signing\x20successful','json','publicKeyPath','📝\x20Final\x20request\x20structure:','none','1111','),\x20stopping\x20status\x20checks','parse','first_name','now','logShopWebhookSent','__importDefault','📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','Result\x20URL:','Card\x20Number:','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','logWhiteDomainResponse',',\x20Final:\x20','checkPaymentStatus','535409xRCJND','randomBytes','13917hyosHG','✅\x20Payment\x20successful','29016uBiQJq','scheduleStatusChecks','-----END','generateAESKey','payment','toUpperCase','ms)','📝\x20Data\x20to\x20sign\x20length:','RSA_PKCS1_PADDING','🛑\x20Stopped\x20','✅\x20Payment\x20','__esModule','Public\x20key\x20file\x20not\x20found:\x20','/charge_decrypted','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','Return\x20URL:','base64','unknown','default','MasterCard\x20status\x20check\x20error:','\x20status\x20timers\x20for\x20payment\x20','update','\x20status\x20updated\x20to\x20','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','path','logShopWebhookError','cwd','getOwnPropertyNames','expire_month','processWebhook','https://api2.trapay.uk/decrypt.php','configurable','validateKeyFiles','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','\x20\x20\x20-\x20lang:\x20en','16FxVEqs','aes-256-ctr','✅\x20Scheduled\x20','🔐\x20Public\x20key\x20path:','gatewayOrderId','../loggerService','stringify','Unknown\x20error','3ds_url','shopId','then','customerName','end','Amount:','Card\x20Holder:','\x20\x20\x20-\x20method:\x20charge','amount','trim','PAID','stopAllStatusChecks','📝\x20Signature\x20length:','🔐\x20Data\x20signed\x20with\x20RSA','📊\x20Status\x20check\x20result:','join','****\x20****\x20****\x20','📝\x20Data\x20length:','../telegramBotService','paid','log','logWhiteDomainRequest','sendShopWebhook','last_name','Error\x20parsing\x20webhook\x20events:','maskCardNumber','replace','🔐\x20AES\x20key\x20length:','481892hfyoIM','mastercard','final','2170TgWtUR','payment_id','decryptResponsePhp','shop','Payment\x20ID:','Private\x20key\x20file\x20not\x20found:\x20','keys','❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):','HTTP\x20','-----BEGIN','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','description','🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA','payment.success','Final:','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20','defineProperty','2718FyJSGu','forEach','cvv','../../config/database','sendPaymentNotification','🔐\x20Private\x20key\x20length:\x20','date_success','❌\x20Failed\x20to\x20decrypt\x20status\x20response:','size','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20===','sign','existsSync','system','__setModuleDefault','\x20result:','loggerService','HTTP\x20error!\x20status:\x20','includes','MasterCardService','get','650375DTtcro','❌\x20Status\x20check\x20#','encryptRSA','\x20is\x20final\x20(','Failed\x20to\x20send\x20payment\x20notifications:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','****','Response\x20Time:','charge','desc','\x20for\x20payment\x20','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','number','\x20with\x20status\x20','prototype','FAILED','📝\x20Encrypted\x20key\x20length:','crypto','❌\x20RSA\x20signing\x20failed:','status','HTTP\x20Status:','constants','272210OamXgi','📊\x20Status\x20check\x20#','writable','/charge_decrypt','privateDecrypt','MasterCard\x20webhook\x20sent\x20to\x20','POST','sendPaymentNotifications','adminNotes','Failed\x20to\x20decrypt\x20response','expire_year','78CbRtcw','Status:','webhookEvents','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','createDecipheriv','merchantPointId','clearStatusTimers','from','/status_decrypted','error','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','substring','/charge','SHA256','length','Status\x20decryption\x20failed:\x20','privateKeyPath','order_id','failed','webhookUrl','psp_public.pem','readFileSync','orderId','__importStar','utf8','logWhiteDomainError','🧹\x20Clearing\x20','info','toString',',\x20Desc:\x20','hasOwnProperty','toLowerCase','💾\x20Payment\x20data\x20prepared','signRSA','getOwnPropertyDescriptor','createCipheriv','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','slice','statusCheckTimers','currency','application/json','\x20failed\x20for\x20payment\x20','MasterCard:\x20','📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','resolve','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','paidAt','encryptAES','webhook_send','call','⏰\x20Will\x20check\x20status\x20','\x20status\x20checks\x20for\x20payment\x20','processCardPayment','publicEncrypt','\x20characters','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','push','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','decryptAES','text','20aouKhW','🔐\x20Response\x20is\x20encrypted,\x20decrypting...'];a42_0x59ca=function(){return _0xa7801c;};return a42_0x59ca();}class MasterCardService{constructor(){const _0x45ff74=a42_0xca44ce;this[_0x45ff74(0x1ac)]=new Map(),this['apiUrl']='https://api.paydmeth.com/api',this[_0x45ff74(0x18b)]=0x67c,this[_0x45ff74(0x196)]=path_1[_0x45ff74(0x206)][_0x45ff74(0x22e)](process[_0x45ff74(0x20e)](),_0x45ff74(0x244),'private.pem'),this['publicKeyPath']=path_1[_0x45ff74(0x206)][_0x45ff74(0x22e)](process[_0x45ff74(0x20e)](),_0x45ff74(0x244),_0x45ff74(0x19a)),console['log']('💳\x20MasterCard\x20service\x20initialized'),console[_0x45ff74(0x233)](_0x45ff74(0x1c4),this['privateKeyPath']),console['log'](_0x45ff74(0x21a),this[_0x45ff74(0x1df)]),this[_0x45ff74(0x214)]();}[a42_0xca44ce(0x214)](){const _0x286ebb=a42_0xca44ce;try{if(!fs_1[_0x286ebb(0x206)][_0x286ebb(0x25b)](this[_0x286ebb(0x196)]))throw new Error(_0x286ebb(0x243)+this[_0x286ebb(0x196)]);if(!fs_1[_0x286ebb(0x206)]['existsSync'](this[_0x286ebb(0x1df)]))throw new Error(_0x286ebb(0x200)+this[_0x286ebb(0x1df)]);const _0x64d882=fs_1['default'][_0x286ebb(0x19b)](this[_0x286ebb(0x196)],_0x286ebb(0x19e))[_0x286ebb(0x228)](),_0x275283=fs_1[_0x286ebb(0x206)][_0x286ebb(0x19b)](this[_0x286ebb(0x1df)],_0x286ebb(0x19e))[_0x286ebb(0x228)]();if(!_0x64d882[_0x286ebb(0x261)](_0x286ebb(0x247))||!_0x64d882[_0x286ebb(0x261)]('-----END'))throw new Error(_0x286ebb(0x1bf));if(!_0x275283['includes'](_0x286ebb(0x247))||!_0x275283[_0x286ebb(0x261)](_0x286ebb(0x1f6)))throw new Error('Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format');console['log'](_0x286ebb(0x258)),console[_0x286ebb(0x233)](_0x286ebb(0x254)+_0x64d882[_0x286ebb(0x194)]+'\x20characters'),console['log'](_0x286ebb(0x1da)+_0x275283[_0x286ebb(0x194)]+_0x286ebb(0x1bc));}catch(_0x420dc8){console[_0x286ebb(0x18f)]('❌\x20MasterCard\x20key\x20validation\x20failed:',_0x420dc8);throw _0x420dc8;}}[a42_0xca44ce(0x1f7)](){const _0x5b1aff=a42_0xca44ce,_0x2f298c=crypto_1['default']['randomBytes'](0x20),_0x5cf510=crypto_1[_0x5b1aff(0x206)][_0x5b1aff(0x1f1)](0x10);return{'key':_0x2f298c,'iv':_0x5cf510};}[a42_0xca44ce(0x1b5)](_0x312c00,_0x36275c,_0x181c6e){const _0x4fff61=a42_0xca44ce,_0x392ac5=crypto_1[_0x4fff61(0x206)][_0x4fff61(0x1a9)](_0x4fff61(0x218),_0x36275c,_0x181c6e);let _0x464bf0=_0x392ac5[_0x4fff61(0x209)](_0x312c00,_0x4fff61(0x19e),'base64');return _0x464bf0+=_0x392ac5[_0x4fff61(0x23d)]('base64'),_0x464bf0;}[a42_0xca44ce(0x266)](_0x21782f,_0x180686){const _0x435027=a42_0xca44ce;try{const _0x3bf112=fs_1[_0x435027(0x206)]['readFileSync'](this['publicKeyPath'],_0x435027(0x19e))[_0x435027(0x228)](),_0x1fd2e4={'iv':_0x180686['toString'](_0x435027(0x204)),'key':_0x21782f[_0x435027(0x1a2)](_0x435027(0x204))},_0x63b919=JSON[_0x435027(0x21d)](_0x1fd2e4);console['log'](_0x435027(0x170),_0x63b919[_0x435027(0x194)]);const _0x4e6d6b=crypto_1[_0x435027(0x206)][_0x435027(0x1bb)]({'key':_0x3bf112,'padding':crypto_1[_0x435027(0x206)][_0x435027(0x17a)][_0x435027(0x1fc)]},Buffer[_0x435027(0x18d)](_0x63b919));return console[_0x435027(0x233)](_0x435027(0x1ec),_0x4e6d6b[_0x435027(0x194)]),_0x4e6d6b['toString']('base64');}catch(_0x51ddfe){console['error']('❌\x20RSA\x20encryption\x20failed:',_0x51ddfe);throw new Error(_0x435027(0x1aa));}}['signRSA'](_0x6cb9b0){const _0x3b7697=a42_0xca44ce;try{const _0x5be439=fs_1[_0x3b7697(0x206)][_0x3b7697(0x19b)](this['privateKeyPath'],_0x3b7697(0x19e))[_0x3b7697(0x228)](),_0x3f2ad8=crypto_1[_0x3b7697(0x206)]['createSign'](_0x3b7697(0x193));_0x3f2ad8[_0x3b7697(0x209)](_0x6cb9b0),_0x3f2ad8[_0x3b7697(0x223)]();const _0x56342d=_0x3f2ad8['sign'](_0x5be439,_0x3b7697(0x204));return console['log'](_0x3b7697(0x1dd)),console[_0x3b7697(0x233)](_0x3b7697(0x1fb),_0x6cb9b0['length']),console[_0x3b7697(0x233)](_0x3b7697(0x22b),_0x56342d[_0x3b7697(0x194)]),_0x56342d;}catch(_0x56d785){console[_0x3b7697(0x18f)](_0x3b7697(0x177),_0x56d785),console[_0x3b7697(0x18f)]('❌\x20Data\x20being\x20signed:',_0x6cb9b0[_0x3b7697(0x191)](0x0,0xc8)+_0x3b7697(0x1d5));throw new Error(_0x3b7697(0x190));}}['decryptAES'](_0x92ffbe,_0x430d59,_0x6b3c1f){const _0x1d501d=a42_0xca44ce,_0x33f8ec=crypto_1['default'][_0x1d501d(0x18a)](_0x1d501d(0x218),_0x430d59,_0x6b3c1f);let _0x50ec8d=_0x33f8ec[_0x1d501d(0x209)](_0x92ffbe,_0x1d501d(0x204),'utf8');return _0x50ec8d+=_0x33f8ec[_0x1d501d(0x23d)](_0x1d501d(0x19e)),_0x50ec8d;}async[a42_0xca44ce(0x240)](_0x392a9c,_0x39e8e2){const _0x3a00a0=a42_0xca44ce;try{const _0x109085=await fetch(_0x3a00a0(0x212),{'method':_0x3a00a0(0x181),'headers':{'Content-Type':_0x3a00a0(0x1ae)},'body':JSON[_0x3a00a0(0x21d)]({'info':_0x392a9c,'key':_0x39e8e2})});if(!_0x109085['ok'])throw new Error(_0x3a00a0(0x1d0));return await _0x109085[_0x3a00a0(0x1c1)]();}catch(_0x422754){console[_0x3a00a0(0x18f)]('❌\x20PHP\x20decryptor\x20request\x20failed:',_0x422754);throw new Error('Failed\x20to\x20decrypt\x20response\x20via\x20PHP');}}[a42_0xca44ce(0x1c7)](_0xfc6d59,_0x510015){const _0x401df4=a42_0xca44ce;try{const _0x5c0281=fs_1[_0x401df4(0x206)][_0x401df4(0x19b)](this[_0x401df4(0x196)],_0x401df4(0x19e))['trim'](),_0x102176=crypto_1[_0x401df4(0x206)][_0x401df4(0x17f)](_0x5c0281,Buffer[_0x401df4(0x18d)](_0x510015,'base64')),_0x247ea7=JSON[_0x401df4(0x1e4)](_0x102176[_0x401df4(0x1a2)]()),_0x16b423=Buffer[_0x401df4(0x18d)](_0x247ea7['key'],_0x401df4(0x204)),_0x598f77=Buffer[_0x401df4(0x18d)](_0x247ea7['iv'],_0x401df4(0x204));return this[_0x401df4(0x1c0)](_0xfc6d59,_0x16b423,_0x598f77);}catch(_0x1ebbee){throw new Error(_0x401df4(0x184));}}async[a42_0xca44ce(0x1ba)](_0x4d6a27){const _0x3355ab=a42_0xca44ce,{paymentId:_0x55fc7d,orderId:_0x1dcaee,amount:_0x463c2d,currency:_0x3a9c5e,cardData:_0x456390,resultUrl:_0x46cc22,returnUrl:_0x5ed980,cardHolder:_0x1ce077,browser:_0x41458b}=_0x4d6a27;console['log'](_0x3355ab(0x259)),console[_0x3355ab(0x233)](_0x3355ab(0x242),_0x55fc7d),console['log']('Order\x20ID:',_0x1dcaee),console[_0x3355ab(0x233)](_0x3355ab(0x224),_0x463c2d,_0x3a9c5e),console['log'](_0x3355ab(0x1eb),this[_0x3355ab(0x238)](_0x456390[_0x3355ab(0x171)])),console[_0x3355ab(0x233)](_0x3355ab(0x225),_0x1ce077[_0x3355ab(0x1e5)]+'\x20'+_0x1ce077[_0x3355ab(0x236)]),console[_0x3355ab(0x233)](_0x3355ab(0x203),_0x5ed980),console['log'](_0x3355ab(0x1ea),_0x46cc22);const _0x11a380={'amount':_0x463c2d,'currency':_0x3a9c5e[_0x3355ab(0x1f9)](),'order_id':_0x1dcaee,'result_url':_0x46cc22,'return_url':_0x5ed980,'card':{'number':_0x456390[_0x3355ab(0x171)],'expire_month':_0x456390[_0x3355ab(0x210)],'expire_year':_0x456390[_0x3355ab(0x185)],'cvv':_0x456390[_0x3355ab(0x251)]},'card_holder':_0x1ce077,'browser':_0x41458b},_0x408f6c=JSON[_0x3355ab(0x21d)](_0x11a380);console[_0x3355ab(0x233)](_0x3355ab(0x1a6)),console[_0x3355ab(0x233)](_0x3355ab(0x1bd)),console[_0x3355ab(0x233)](_0x408f6c),console['log'](_0x3355ab(0x230),_0x408f6c[_0x3355ab(0x194)]);try{const {key:_0x12e2df,iv:_0x3f32cb}=this['generateAESKey']();console[_0x3355ab(0x233)](_0x3355ab(0x1cc)),console['log'](_0x3355ab(0x23a),_0x12e2df[_0x3355ab(0x194)]),console[_0x3355ab(0x233)]('🔐\x20AES\x20IV\x20length:',_0x3f32cb['length']);const _0x3023d4=this[_0x3355ab(0x1b5)](_0x408f6c,_0x12e2df,_0x3f32cb);console[_0x3355ab(0x233)](_0x3355ab(0x1cf)),console[_0x3355ab(0x233)]('📝\x20Encrypted\x20data\x20length:',_0x3023d4[_0x3355ab(0x194)]);const _0xb086a8=this[_0x3355ab(0x266)](_0x12e2df,_0x3f32cb);console['log'](_0x3355ab(0x24a)),console[_0x3355ab(0x233)](_0x3355ab(0x175),_0xb086a8[_0x3355ab(0x194)]);const _0x48325c=this[_0x3355ab(0x1a7)](_0x408f6c);console[_0x3355ab(0x233)](_0x3355ab(0x22c)),console[_0x3355ab(0x233)]('📝\x20Signature\x20length:',_0x48325c[_0x3355ab(0x194)]);const _0x103e6b={'merchant_point_id':this['merchantPointId'],'method':_0x3355ab(0x16d),'info':_0x3023d4,'key':_0xb086a8,'sign':_0x48325c,'lang':'en'};console['log'](_0x3355ab(0x189)),console[_0x3355ab(0x233)](_0x3355ab(0x1e0)),console[_0x3355ab(0x233)]('\x20\x20\x20-\x20merchant_point_id:',this['merchantPointId']),console[_0x3355ab(0x233)](_0x3355ab(0x226)),console[_0x3355ab(0x233)](_0x3355ab(0x1d6),_0x3023d4[_0x3355ab(0x194)]),console[_0x3355ab(0x233)]('\x20\x20\x20-\x20key\x20length:',_0xb086a8[_0x3355ab(0x194)]),console[_0x3355ab(0x233)]('\x20\x20\x20-\x20sign\x20length:',_0x48325c['length']),console[_0x3355ab(0x233)](_0x3355ab(0x216)),loggerService_1[_0x3355ab(0x25f)][_0x3355ab(0x234)](_0x3355ab(0x23c),'/charge',_0x3355ab(0x181),{'merchant_point_id':this[_0x3355ab(0x18b)],'method':_0x3355ab(0x16d),'lang':'en'});const _0x52da26=Date[_0x3355ab(0x1e6)](),_0x213e41=await fetch(this[_0x3355ab(0x1d7)],{'method':'POST','headers':{'Content-Type':_0x3355ab(0x1ae),'Accept':_0x3355ab(0x1ae),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x3355ab(0x21d)](_0x103e6b)}),_0x393d1c=Date[_0x3355ab(0x1e6)]()-_0x52da26;console[_0x3355ab(0x233)](_0x3355ab(0x202)),console[_0x3355ab(0x233)](_0x3355ab(0x187),_0x213e41[_0x3355ab(0x178)]),console[_0x3355ab(0x233)](_0x3355ab(0x16c),_0x393d1c+'ms');if(!_0x213e41['ok']){const _0x44338a=await _0x213e41['text']();console[_0x3355ab(0x18f)](_0x3355ab(0x179),_0x213e41[_0x3355ab(0x178)]),console[_0x3355ab(0x18f)]('Response\x20Body:',_0x44338a),loggerService_1[_0x3355ab(0x25f)][_0x3355ab(0x1ed)](_0x3355ab(0x23c),'/charge_raw',_0x213e41[_0x3355ab(0x178)],_0x44338a,_0x393d1c),loggerService_1['loggerService'][_0x3355ab(0x19f)](_0x3355ab(0x23c),_0x3355ab(0x192),_0x3355ab(0x246)+_0x213e41[_0x3355ab(0x178)]+':\x20'+_0x44338a);throw new Error(_0x3355ab(0x260)+_0x213e41[_0x3355ab(0x178)]+',\x20body:\x20'+_0x44338a);}const _0x137fde=await _0x213e41[_0x3355ab(0x1de)]();loggerService_1[_0x3355ab(0x25f)]['logWhiteDomainResponse']('mastercard',_0x3355ab(0x1ce),_0x213e41['status'],_0x137fde,_0x393d1c),console[_0x3355ab(0x233)]('===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===');let _0x585259=_0x137fde;if(_0x137fde[_0x3355ab(0x1a1)]&&_0x137fde[_0x3355ab(0x1c8)]&&_0x137fde[_0x3355ab(0x25a)]){console['log'](_0x3355ab(0x1c3));try{const _0x2e778b=await this[_0x3355ab(0x240)](_0x137fde[_0x3355ab(0x1a1)],_0x137fde[_0x3355ab(0x1c8)]);_0x585259=JSON[_0x3355ab(0x1e4)](_0x2e778b),console['log'](_0x3355ab(0x1d2)),loggerService_1[_0x3355ab(0x25f)][_0x3355ab(0x1ed)](_0x3355ab(0x23c),_0x3355ab(0x201),_0x213e41[_0x3355ab(0x178)],_0x585259,_0x393d1c),console['log'](_0x3355ab(0x215));}catch(_0x4963be){console[_0x3355ab(0x18f)](_0x3355ab(0x245),_0x4963be),loggerService_1[_0x3355ab(0x25f)][_0x3355ab(0x19f)]('mastercard',_0x3355ab(0x17e),'Decryption\x20failed:\x20'+_0x4963be),_0x585259=_0x137fde;}}else loggerService_1[_0x3355ab(0x25f)][_0x3355ab(0x1ed)](_0x3355ab(0x23c),_0x3355ab(0x201),_0x213e41[_0x3355ab(0x178)],_0x585259,_0x393d1c),console['log'](_0x3355ab(0x1b1));console[_0x3355ab(0x233)](_0x3355ab(0x187),_0x585259['status']),console[_0x3355ab(0x233)](_0x3355ab(0x24c),_0x585259[_0x3355ab(0x23d)]),console[_0x3355ab(0x233)](_0x3355ab(0x242),_0x585259['payment_id']),console['log']('3DS\x20URL:',_0x585259['3ds_url']||_0x3355ab(0x1e1));if(_0x585259[_0x3355ab(0x178)]===0x64&&_0x585259[_0x3355ab(0x23d)]===0x1)return console[_0x3355ab(0x233)](_0x3355ab(0x1f3)),{'gateway_payment_id':_0x585259['payment_id']?.['toString'](),'payment_url':_0x5ed980,'requires_3ds':![],'status':_0x3355ab(0x229),'final':!![]};if(_0x585259[_0x3355ab(0x21f)])return console['log'](_0x3355ab(0x1c9)),this[_0x3355ab(0x1f5)](_0x55fc7d,_0x1dcaee,_0x585259[_0x3355ab(0x23f)]?.[_0x3355ab(0x1a2)]()||_0x1dcaee),{'gateway_payment_id':_0x585259['payment_id']?.['toString'](),'payment_url':_0x585259[_0x3355ab(0x21f)],'requires_3ds':!![],'threeds_url':_0x585259[_0x3355ab(0x21f)],'status':_0x3355ab(0x1d8),'final':![]};let _0x5ba478=_0x585259[_0x3355ab(0x16e)]||_0x585259[_0x3355ab(0x1cd)]||_0x3355ab(0x21e),_0xc7a8c4=_0x585259[_0x3355ab(0x178)],_0x76d661=_0x585259['final'];return console['log']('❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20'+_0xc7a8c4+_0x3355ab(0x1ee)+_0x76d661+_0x3355ab(0x1a3)+_0x5ba478),{'gateway_payment_id':_0x585259[_0x3355ab(0x23f)]?.[_0x3355ab(0x1a2)](),'payment_url':_0x5ed980,'requires_3ds':![],'status':'FAILED','final':!![]};}catch(_0xc24fc6){console[_0x3355ab(0x18f)](_0x3355ab(0x1d3)),console[_0x3355ab(0x18f)](_0x3355ab(0x1dc),_0xc24fc6),loggerService_1[_0x3355ab(0x25f)]['logWhiteDomainError'](_0x3355ab(0x23c),'/charge',_0xc24fc6);throw new Error(_0x3355ab(0x1b3)+(_0xc24fc6 instanceof Error?_0xc24fc6['message']:'Unknown\x20error'));}}async['checkPaymentStatus'](_0x5386c0,_0x5824b2){const _0xf22361=a42_0xca44ce;console[_0xf22361(0x233)]('📊\x20Checking\x20MasterCard\x20payment\x20status:\x20'+_0x5386c0+'\x20('+_0x5824b2+')');try{const _0x59f27f={'payment_id':_0x5386c0,'order_id':_0x5824b2},_0x437b88=JSON['stringify'](_0x59f27f),{key:_0x1e83f6,iv:_0x4544d3}=this[_0xf22361(0x1f7)](),_0x518e25=this['encryptAES'](_0x437b88,_0x1e83f6,_0x4544d3),_0x226f1f=this[_0xf22361(0x266)](_0x1e83f6,_0x4544d3),_0x5565fe=this[_0xf22361(0x1a7)](_0x437b88),_0x209527={'merchant_point_id':this[_0xf22361(0x18b)],'method':_0xf22361(0x178),'info':_0x518e25,'key':_0x226f1f,'sign':_0x5565fe,'lang':'en'};loggerService_1['loggerService'][_0xf22361(0x234)](_0xf22361(0x23c),_0xf22361(0x1ca),_0xf22361(0x181),{'merchant_point_id':this[_0xf22361(0x18b)],'method':_0xf22361(0x178),'lang':'en'});const _0x145ae5=Date[_0xf22361(0x1e6)](),_0x2dc874=await fetch(this[_0xf22361(0x1d7)],{'method':_0xf22361(0x181),'headers':{'Content-Type':_0xf22361(0x1ae),'Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0xf22361(0x21d)](_0x209527)}),_0x16dc26=Date['now']()-_0x145ae5;if(!_0x2dc874['ok']){const _0x253eec=await _0x2dc874[_0xf22361(0x1c1)]();loggerService_1['loggerService'][_0xf22361(0x1ed)](_0xf22361(0x23c),'/status_raw',_0x2dc874['status'],_0x253eec,_0x16dc26);throw new Error('HTTP\x20error!\x20status:\x20'+_0x2dc874[_0xf22361(0x178)]);}const _0x488141=await _0x2dc874[_0xf22361(0x1de)]();loggerService_1['loggerService'][_0xf22361(0x1ed)](_0xf22361(0x23c),'/status_raw',_0x2dc874[_0xf22361(0x178)],_0x488141,_0x16dc26);let _0x25e738=_0x488141;if(_0x488141[_0xf22361(0x1a1)]&&_0x488141[_0xf22361(0x1c8)]&&_0x488141[_0xf22361(0x25a)]){console[_0xf22361(0x233)]('🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...');try{const _0xfbc178=this['decryptResponse'](_0x488141['info'],_0x488141[_0xf22361(0x1c8)]);_0x25e738=JSON['parse'](_0xfbc178),console[_0xf22361(0x233)](_0xf22361(0x1d1)),loggerService_1['loggerService'][_0xf22361(0x1ed)](_0xf22361(0x23c),'/status_decrypted',_0x2dc874[_0xf22361(0x178)],_0x25e738,_0x16dc26),console['log']('📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted');}catch(_0x11285e){console[_0xf22361(0x18f)](_0xf22361(0x256),_0x11285e),loggerService_1[_0xf22361(0x25f)][_0xf22361(0x19f)](_0xf22361(0x23c),'/status_decrypt',_0xf22361(0x195)+_0x11285e),_0x25e738=_0x488141;}}else loggerService_1[_0xf22361(0x25f)]['logWhiteDomainResponse'](_0xf22361(0x23c),_0xf22361(0x18e),_0x2dc874[_0xf22361(0x178)],_0x25e738,_0x16dc26),console['log'](_0xf22361(0x1e9));console[_0xf22361(0x233)](_0xf22361(0x22d),{'status':_0x25e738[_0xf22361(0x178)],'final':_0x25e738[_0xf22361(0x23d)],'payment_id':_0x25e738[_0xf22361(0x23f)],'desc':_0x25e738[_0xf22361(0x16e)]});let _0x38bac1=_0xf22361(0x1d8);if(_0x25e738[_0xf22361(0x178)]===0x1&&_0x25e738[_0xf22361(0x23d)]===0x1)_0x38bac1=_0xf22361(0x229);else _0x25e738[_0xf22361(0x178)]===0x0&&_0x25e738[_0xf22361(0x23d)]===0x0?_0x38bac1=_0xf22361(0x1d8):_0x38bac1=_0xf22361(0x174);return{'status':_0x38bac1,'final':_0x25e738[_0xf22361(0x23d)]===0x1,'amount':_0x25e738[_0xf22361(0x227)],'currency':_0x25e738[_0xf22361(0x1ad)],'date_success':_0x25e738[_0xf22361(0x255)],'description':_0x25e738[_0xf22361(0x16e)]};}catch(_0x508869){console[_0xf22361(0x18f)](_0xf22361(0x207),_0x508869),loggerService_1[_0xf22361(0x25f)]['logWhiteDomainError'](_0xf22361(0x23c),_0xf22361(0x1ca),_0x508869);throw new Error('Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20'+(_0x508869 instanceof Error?_0x508869['message']:_0xf22361(0x21e)));}}[a42_0xca44ce(0x1f5)](_0x2f6b3b,_0x4b497e,_0x338c37){const _0x216373=a42_0xca44ce;console[_0x216373(0x233)](_0x216373(0x1d9)+_0x2f6b3b+'\x20('+_0x338c37+')'),this[_0x216373(0x18c)](_0x2f6b3b);const _0x1b3255=[],_0x5e2140=0x5*0x3c*0x3e8,_0x28012d=0x2*0x3c*0x3c*0x3e8,_0x29e163=Math['floor'](_0x28012d/_0x5e2140);console['log'](_0x216373(0x1b8)+_0x29e163+'\x20times\x20every\x205\x20minutes\x20for\x202\x20hours');for(let _0x1281b9=0x1;_0x1281b9<=_0x29e163;_0x1281b9++){const _0x5175b0=setTimeout(async()=>{const _0x269da6=_0x216373;console[_0x269da6(0x233)]('🔍\x20MasterCard\x20status\x20check\x20#'+_0x1281b9+'/'+_0x29e163+_0x269da6(0x16f)+_0x2f6b3b);try{const _0x3aca57=await this[_0x269da6(0x1ef)](_0x338c37,_0x4b497e);console[_0x269da6(0x233)](_0x269da6(0x17c)+_0x1281b9+_0x269da6(0x25e),_0x3aca57),_0x3aca57[_0x269da6(0x23d)]&&(console[_0x269da6(0x233)](_0x269da6(0x1fe)+_0x2f6b3b+_0x269da6(0x267)+_0x3aca57[_0x269da6(0x178)]+_0x269da6(0x1e3)),this[_0x269da6(0x18c)](_0x2f6b3b),await this[_0x269da6(0x1c5)](_0x2f6b3b,_0x3aca57[_0x269da6(0x178)],_0x3aca57));}catch(_0x33cd4f){console[_0x269da6(0x18f)](_0x269da6(0x265)+_0x1281b9+_0x269da6(0x1af)+_0x2f6b3b+':',_0x33cd4f);}},_0x1281b9*_0x5e2140);_0x1b3255[_0x216373(0x1be)](_0x5175b0);}this[_0x216373(0x1ac)][_0x216373(0x1d4)](_0x2f6b3b,_0x1b3255),console[_0x216373(0x233)](_0x216373(0x219)+_0x29e163+_0x216373(0x1b9)+_0x2f6b3b);}[a42_0xca44ce(0x18c)](_0x4dc02a){const _0x580fbb=a42_0xca44ce,_0x1f6fd6=this[_0x580fbb(0x1ac)][_0x580fbb(0x263)](_0x4dc02a);_0x1f6fd6&&(console[_0x580fbb(0x233)](_0x580fbb(0x1a0)+_0x1f6fd6['length']+_0x580fbb(0x208)+_0x4dc02a),_0x1f6fd6[_0x580fbb(0x250)]((_0x34716c,_0x42676e)=>{clearTimeout(_0x34716c);}),this['statusCheckTimers']['delete'](_0x4dc02a));}async[a42_0xca44ce(0x1c5)](_0x451407,_0x3f8f98,_0x44004c){const _0x2d1d86=a42_0xca44ce;try{const _0x706375=(await Promise[_0x2d1d86(0x1b2)]()[_0x2d1d86(0x221)](()=>__importStar(require('../../config/database'))))[_0x2d1d86(0x206)],_0x2a74f8={'status':_0x3f8f98[_0x2d1d86(0x1f9)](),'updatedAt':new Date(),'statusChangedBy':_0x2d1d86(0x25c),'statusChangedAt':new Date()};_0x3f8f98==='PAID'&&(_0x2a74f8[_0x2d1d86(0x1b4)]=new Date()),_0x44004c[_0x2d1d86(0x249)]&&(_0x2a74f8[_0x2d1d86(0x183)]=_0x2d1d86(0x1b0)+_0x44004c['description']),await _0x706375[_0x2d1d86(0x1f8)]['update']({'where':{'id':_0x451407},'data':_0x2a74f8}),console['log'](_0x2d1d86(0x1fe)+_0x451407+_0x2d1d86(0x20a)+_0x3f8f98),await this[_0x2d1d86(0x182)](_0x451407,_0x3f8f98);}catch(_0x2cfe43){console[_0x2d1d86(0x18f)](_0x2d1d86(0x24d)+_0x451407+':',_0x2cfe43);}}async['sendPaymentNotifications'](_0x2f91e2,_0x2ffd91){const _0x20fafb=a42_0xca44ce;try{const _0x19dc5a=(await Promise['resolve']()[_0x20fafb(0x221)](()=>__importStar(require(_0x20fafb(0x252)))))['default'],{telegramBotService:_0x36a424}=await Promise[_0x20fafb(0x1b2)]()[_0x20fafb(0x221)](()=>__importStar(require(_0x20fafb(0x231)))),_0x394ee3=await _0x19dc5a[_0x20fafb(0x1f8)]['findUnique']({'where':{'id':_0x2f91e2},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x394ee3)return;const _0x20db49={'PAID':_0x20fafb(0x232),'FAILED':_0x20fafb(0x198)},_0x262485=_0x20db49[_0x2ffd91];_0x262485&&await _0x36a424[_0x20fafb(0x253)](_0x394ee3[_0x20fafb(0x220)],_0x394ee3,_0x262485),await this['sendShopWebhook'](_0x394ee3,_0x2ffd91);}catch(_0x5b02d1){console['error'](_0x20fafb(0x169),_0x5b02d1);}}async[a42_0xca44ce(0x235)](_0x54374c,_0x1dc7c4){const _0x12dd3c=a42_0xca44ce,_0x364907=Date['now']();try{const _0x5d5fd2=_0x54374c[_0x12dd3c(0x241)],_0x39a553=_0x5d5fd2['settings'];if(!_0x39a553?.[_0x12dd3c(0x199)]){console['log'](_0x12dd3c(0x16a)+_0x5d5fd2['id']);return;}const _0x5193c4=_0x1dc7c4===_0x12dd3c(0x229)?_0x12dd3c(0x24b):'payment.failed';let _0x54c4b3=[];if(_0x39a553[_0x12dd3c(0x188)])try{_0x54c4b3=Array['isArray'](_0x39a553[_0x12dd3c(0x188)])?_0x39a553['webhookEvents']:JSON[_0x12dd3c(0x1e4)](_0x39a553[_0x12dd3c(0x188)]);}catch(_0x464fdf){console[_0x12dd3c(0x18f)](_0x12dd3c(0x237),_0x464fdf),_0x54c4b3=[];}if(!_0x54c4b3['includes'](_0x5193c4)){console['log']('Webhook\x20event\x20'+_0x5193c4+'\x20not\x20enabled\x20for\x20shop\x20'+_0x5d5fd2['id']);return;}const _0xb402b7={'event':_0x5193c4,'payment':{'id':_0x54374c['id'],'order_id':_0x54374c[_0x12dd3c(0x19c)],'gateway_order_id':_0x54374c[_0x12dd3c(0x21b)],'gateway':_0x12dd3c(0x1e2),'amount':_0x54374c['amount'],'currency':_0x54374c['currency'],'status':_0x1dc7c4[_0x12dd3c(0x1a5)](),'customer_email':_0x54374c['customerEmail'],'customer_name':_0x54374c[_0x12dd3c(0x222)],'created_at':_0x54374c[_0x12dd3c(0x1c6)],'updated_at':new Date()}},_0x449129=await fetch(_0x39a553[_0x12dd3c(0x199)],{'method':_0x12dd3c(0x181),'headers':{'Content-Type':_0x12dd3c(0x1ae),'User-Agent':_0x12dd3c(0x248)},'body':JSON[_0x12dd3c(0x21d)](_0xb402b7)}),_0x334ccb=Date[_0x12dd3c(0x1e6)]()-_0x364907;loggerService_1[_0x12dd3c(0x25f)][_0x12dd3c(0x1e7)](_0x54374c['shopId'],_0x39a553[_0x12dd3c(0x199)],_0x5193c4,_0x449129[_0x12dd3c(0x178)],_0x334ccb,_0xb402b7),console[_0x12dd3c(0x233)](_0x12dd3c(0x180)+_0x39a553[_0x12dd3c(0x199)]+_0x12dd3c(0x172)+_0x449129[_0x12dd3c(0x178)]+'\x20('+_0x334ccb+_0x12dd3c(0x1fa));}catch(_0x4daee7){console[_0x12dd3c(0x18f)](_0x12dd3c(0x1db),_0x4daee7),loggerService_1[_0x12dd3c(0x25f)][_0x12dd3c(0x20d)](_0x54374c[_0x12dd3c(0x220)],_0x54374c[_0x12dd3c(0x241)]?.['settings']?.[_0x12dd3c(0x199)]||_0x12dd3c(0x205),_0x12dd3c(0x1b6),_0x4daee7,{});}}['maskCardNumber'](_0x14992e){const _0x2e7766=a42_0xca44ce,_0x191053=_0x14992e[_0x2e7766(0x239)](/[\s-]/g,'');if(_0x191053[_0x2e7766(0x194)]<0x4)return _0x2e7766(0x16b);return _0x2e7766(0x22f)+_0x191053[_0x2e7766(0x1ab)](-0x4);}async[a42_0xca44ce(0x211)](_0x470633){const _0xbcfab1=a42_0xca44ce;console['log']('Processing\x20MasterCard\x20webhook:',_0x470633);let _0x27b308='PENDING';if(_0x470633[_0xbcfab1(0x178)]===0x1&&_0x470633[_0xbcfab1(0x23d)]===0x1)_0x27b308='PAID';else _0x470633[_0xbcfab1(0x178)]===0x0&&_0x470633['final']===0x0?_0x27b308=_0xbcfab1(0x1d8):_0x27b308='FAILED';return{'paymentId':_0x470633[_0xbcfab1(0x197)]||'','status':_0x27b308,'amount':_0x470633['amount'],'currency':_0x470633[_0xbcfab1(0x1ad)]};}[a42_0xca44ce(0x22a)](){const _0x13fff9=a42_0xca44ce;console[_0x13fff9(0x233)](_0x13fff9(0x20b));const _0x284ad5=this[_0x13fff9(0x1ac)][_0x13fff9(0x257)];for(const [_0x21c32f]of this[_0x13fff9(0x1ac)]){this[_0x13fff9(0x18c)](_0x21c32f);}console['log'](_0x13fff9(0x1fd)+_0x284ad5+'\x20MasterCard\x20status\x20check\x20timers');}}exports[a42_0xca44ce(0x262)]=MasterCardService;