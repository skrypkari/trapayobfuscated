'use strict';const a42_0x481cc2=a42_0x3398;(function(_0x4d11b2,_0x56faaa){const _0x1669af=a42_0x3398,_0x22bce3=_0x4d11b2();while(!![]){try{const _0x457728=parseInt(_0x1669af(0xff))/0x1*(parseInt(_0x1669af(0x101))/0x2)+-parseInt(_0x1669af(0x167))/0x3*(-parseInt(_0x1669af(0x1b3))/0x4)+parseInt(_0x1669af(0x17a))/0x5*(parseInt(_0x1669af(0x162))/0x6)+-parseInt(_0x1669af(0x16e))/0x7+parseInt(_0x1669af(0x132))/0x8*(parseInt(_0x1669af(0xbf))/0x9)+parseInt(_0x1669af(0x172))/0xa+-parseInt(_0x1669af(0xfb))/0xb*(parseInt(_0x1669af(0x1ad))/0xc);if(_0x457728===_0x56faaa)break;else _0x22bce3['push'](_0x22bce3['shift']());}catch(_0x211acf){_0x22bce3['push'](_0x22bce3['shift']());}}}(a42_0x14e2,0x99c1c));function a42_0x3398(_0x6f5d7d,_0x1670aa){const _0x14e22=a42_0x14e2();return a42_0x3398=function(_0x339878,_0x47f774){_0x339878=_0x339878-0xba;let _0x3ebd7d=_0x14e22[_0x339878];return _0x3ebd7d;},a42_0x3398(_0x6f5d7d,_0x1670aa);}function a42_0x14e2(){const _0x5b3c22=['trim','Status\x20decryption\x20failed:\x20','13252txsJhi','unknown','PHP\x20decryptor\x20error','\x20MasterCard\x20status\x20check\x20timers','orderId','https://api2.trapay.uk/decrypt.php','writable','7158339wPycPQ','shopId','Card\x20Holder:','✅\x20Payment\x20','default','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','💳\x20MasterCard\x20service\x20initialized','Amount:','floor','status','webhook_send','MasterCard\x20status\x20check\x20error:','from','slice','sendShopWebhook','PENDING','processWebhook','final','text','info','📝\x20Encrypted\x20key\x20length:','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','merchantPointId','ms)','getOwnPropertyDescriptor','push','📊\x20Status\x20check\x20#','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','/status','Failed\x20to\x20decrypt\x20response\x20via\x20PHP','https://api.paydmeth.com/api','🔐\x20RSA\x20signing\x20successful','checkPaymentStatus','__esModule','create','🔐\x20Public\x20key\x20length:\x20','MasterCard:\x20','settings','📝\x20Final\x20request\x20structure:','psp_public.pem','🔐\x20Data\x20signed\x20with\x20RSA','encryptRSA','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','FAILED','Webhook\x20event\x20','❌\x20Failed\x20to\x20decrypt\x20status\x20response:','customerEmail','🔐\x20Private\x20key\x20path:','POST','🧹\x20Clearing\x20','📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','size','amount','signRSA','logWhiteDomainRequest','❌\x20PHP\x20decryptor\x20request\x20failed:','✅\x20Scheduled\x20','currency','publicEncrypt','defineProperty','133606TROpRw','first_name','set','log','547NKiYsP','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','3956fDheIB','application/json','Decryption\x20failed:\x20','Private\x20key\x20file\x20not\x20found:\x20','message','Return\x20URL:','stringify','sendPaymentNotification','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','description','****\x20****\x20****\x20','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','PAID','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20','maskCardNumber','⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20','randomBytes','charge','📝\x20Signature\x20length:','json','order_id','💾\x20Payment\x20data\x20prepared','payment','base64','🔐\x20Data\x20encrypted\x20with\x20AES','resolve','❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','logWhiteDomainResponse','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','apiUrl','❌\x20Data\x20being\x20signed:','paidAt','constants','✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)','last_name','3ds_url','sign','delete','hasOwnProperty','❌\x20RSA\x20encryption\x20failed:','Response\x20Body:','🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA','path','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','customerName','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20','error','8iNQlLJ','🔐\x20AES\x20IV\x20length:','mastercard','Payment\x20ID:','===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20===','✅\x20Status\x20response\x20decrypted\x20successfully',',\x20Desc:\x20','number','loggerService','encryptAES','aes-256-ctr','logShopWebhookError','includes','✅\x20Payment\x20successful','__setModuleDefault','Response\x20Time:','none','payment_id','🔍\x20MasterCard\x20status\x20check\x20#','clearStatusTimers','createdAt','/status_decrypt','sendPaymentNotifications','\x20\x20\x20-\x20lang:\x20en','Card\x20Number:','Failed\x20to\x20decrypt\x20response','\x20status\x20updated\x20to\x20','\x20status\x20checks\x20for\x20payment\x20','desc','\x20\x20\x20-\x20key\x20length:','../../config/database','TesSoft\x20Payment\x20System/1.0','system','MasterCardService','createSign','then','🛑\x20Stopped\x20','findUnique','get','decryptResponse','configurable','expire_month','gatewayOrderId','call','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','forEach','1111','parse','1582050MXOlIT','/charge_decrypt','now','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','HTTP\x20','525QmuVat',',\x20Final:\x20','stopAllStatusChecks','private.pem','⏰\x20Will\x20check\x20status\x20','===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===','privateDecrypt','5733847FXVhch','\x20not\x20enabled\x20for\x20shop\x20','payment.success','decryptAES','11122750exNzjy','crypto','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Final:','readFileSync','),\x20stopping\x20status\x20checks','-----END','statusCheckTimers','10sRFNPl','utf8','🔐\x20Public\x20key\x20path:','createCipheriv','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','scheduleStatusChecks','\x20\x20\x20-\x20sign\x20length:','__importStar','update','❌\x20RSA\x20signing\x20failed:','HTTP\x20error!\x20status:\x20','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','toString','📝\x20Data\x20length:','/charge','toUpperCase','join','❌\x20Status\x20check\x20#','🔐\x203DS\x20verification\x20required','keys','generateAESKey','webhookEvents','expire_year','\x20result:','publicKeyPath','/status_decrypted','Unknown\x20error','/charge_decrypted','length','createDecipheriv','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','key','failed','Failed\x20to\x20send\x20payment\x20notifications:','isArray','\x20\x20\x20-\x20method:\x20charge','__importDefault','Public\x20key\x20file\x20not\x20found:\x20',',\x20body:\x20','\x20characters','payment.failed','\x20is\x20final\x20(','webhookUrl','__createBinding','shop','/status_raw','SHA256','prototype','MasterCard\x20webhook\x20sent\x20to\x20','Order\x20ID:','logWhiteDomainError','2616LOkpXH','validateKeyFiles','****','privateKeyPath'];a42_0x14e2=function(){return _0x5b3c22;};return a42_0x14e2();}var __createBinding=this&&this[a42_0x481cc2(0x1a5)]||(Object[a42_0x481cc2(0xe1)]?function(_0xaefd0c,_0xefa063,_0xf50f6a,_0x4f3efa){const _0x307b65=a42_0x481cc2;if(_0x4f3efa===undefined)_0x4f3efa=_0xf50f6a;var _0x56efba=Object[_0x307b65(0xd7)](_0xefa063,_0xf50f6a);(!_0x56efba||('get'in _0x56efba?!_0xefa063[_0x307b65(0xe0)]:_0x56efba[_0x307b65(0xbe)]||_0x56efba[_0x307b65(0x15a)]))&&(_0x56efba={'enumerable':!![],'get':function(){return _0xefa063[_0xf50f6a];}}),Object[_0x307b65(0xfa)](_0xaefd0c,_0x4f3efa,_0x56efba);}:function(_0x49738e,_0x27d4f0,_0x1ab889,_0x3a610f){if(_0x3a610f===undefined)_0x3a610f=_0x1ab889;_0x49738e[_0x3a610f]=_0x27d4f0[_0x1ab889];}),__setModuleDefault=this&&this[a42_0x481cc2(0x140)]||(Object[a42_0x481cc2(0xe1)]?function(_0x3d37af,_0x91bf2f){const _0x3c1445=a42_0x481cc2;Object[_0x3c1445(0xfa)](_0x3d37af,_0x3c1445(0xc3),{'enumerable':!![],'value':_0x91bf2f});}:function(_0x24be43,_0xa935bc){_0x24be43['default']=_0xa935bc;}),__importStar=this&&this[a42_0x481cc2(0x181)]||(function(){var _0xaacf6d=function(_0x568dbe){return _0xaacf6d=Object['getOwnPropertyNames']||function(_0x548843){const _0x54d632=a42_0x3398;var _0x129fe6=[];for(var _0x18d7fe in _0x548843)if(Object[_0x54d632(0x1a9)][_0x54d632(0x128)][_0x54d632(0x15d)](_0x548843,_0x18d7fe))_0x129fe6[_0x129fe6[_0x54d632(0x196)]]=_0x18d7fe;return _0x129fe6;},_0xaacf6d(_0x568dbe);};return function(_0xa9d60a){const _0x10964b=a42_0x3398;if(_0xa9d60a&&_0xa9d60a[_0x10964b(0xe0)])return _0xa9d60a;var _0x9d68ac={};if(_0xa9d60a!=null){for(var _0x3d24ee=_0xaacf6d(_0xa9d60a),_0x40c7fd=0x0;_0x40c7fd<_0x3d24ee['length'];_0x40c7fd++)if(_0x3d24ee[_0x40c7fd]!==_0x10964b(0xc3))__createBinding(_0x9d68ac,_0xa9d60a,_0x3d24ee[_0x40c7fd]);}return __setModuleDefault(_0x9d68ac,_0xa9d60a),_0x9d68ac;};}()),__importDefault=this&&this[a42_0x481cc2(0x19e)]||function(_0x26ce14){const _0x25cdad=a42_0x481cc2;return _0x26ce14&&_0x26ce14[_0x25cdad(0xe0)]?_0x26ce14:{'default':_0x26ce14};};Object[a42_0x481cc2(0xfa)](exports,a42_0x481cc2(0xe0),{'value':!![]}),exports[a42_0x481cc2(0x153)]=void 0x0;const crypto_1=__importDefault(require(a42_0x481cc2(0x173))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0x481cc2(0x12c))),loggerService_1=require('../loggerService');class MasterCardService{constructor(){const _0x416995=a42_0x481cc2;this['statusCheckTimers']=new Map(),this[_0x416995(0x11f)]=_0x416995(0xdd),this[_0x416995(0xd5)]=0x67c,this[_0x416995(0x1b0)]=path_1[_0x416995(0xc3)][_0x416995(0x18a)](process['cwd'](),_0x416995(0x18d),_0x416995(0x16a)),this[_0x416995(0x192)]=path_1[_0x416995(0xc3)][_0x416995(0x18a)](process['cwd'](),'keys',_0x416995(0xe6)),console[_0x416995(0xfe)](_0x416995(0xc5)),console[_0x416995(0xfe)](_0x416995(0xee),this['privateKeyPath']),console['log'](_0x416995(0x17c),this[_0x416995(0x192)]),this[_0x416995(0x1ae)]();}[a42_0x481cc2(0x1ae)](){const _0x3ada6a=a42_0x481cc2;try{if(!fs_1['default']['existsSync'](this[_0x3ada6a(0x1b0)]))throw new Error(_0x3ada6a(0x104)+this['privateKeyPath']);if(!fs_1[_0x3ada6a(0xc3)]['existsSync'](this[_0x3ada6a(0x192)]))throw new Error(_0x3ada6a(0x19f)+this[_0x3ada6a(0x192)]);const _0x2dff00=fs_1[_0x3ada6a(0xc3)][_0x3ada6a(0x176)](this[_0x3ada6a(0x1b0)],_0x3ada6a(0x17b))[_0x3ada6a(0x1b1)](),_0x36f85a=fs_1[_0x3ada6a(0xc3)][_0x3ada6a(0x176)](this[_0x3ada6a(0x192)],'utf8')[_0x3ada6a(0x1b1)]();if(!_0x2dff00['includes']('-----BEGIN')||!_0x2dff00['includes'](_0x3ada6a(0x178)))throw new Error('Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format');if(!_0x36f85a['includes']('-----BEGIN')||!_0x36f85a[_0x3ada6a(0x13e)](_0x3ada6a(0x178)))throw new Error(_0x3ada6a(0x109));console[_0x3ada6a(0xfe)](_0x3ada6a(0xc4)),console['log']('🔐\x20Private\x20key\x20length:\x20'+_0x2dff00[_0x3ada6a(0x196)]+'\x20characters'),console[_0x3ada6a(0xfe)](_0x3ada6a(0xe2)+_0x36f85a[_0x3ada6a(0x196)]+_0x3ada6a(0x1a1));}catch(_0x4ec14d){console[_0x3ada6a(0x131)]('❌\x20MasterCard\x20key\x20validation\x20failed:',_0x4ec14d);throw _0x4ec14d;}}[a42_0x481cc2(0x18e)](){const _0x36bdab=a42_0x481cc2,_0x1e7949=crypto_1['default'][_0x36bdab(0x111)](0x20),_0xf64ec7=crypto_1[_0x36bdab(0xc3)][_0x36bdab(0x111)](0x10);return{'key':_0x1e7949,'iv':_0xf64ec7};}[a42_0x481cc2(0x13b)](_0x2f0788,_0x3e1541,_0x2c717a){const _0xa2f40c=a42_0x481cc2,_0x57db07=crypto_1['default'][_0xa2f40c(0x17d)]('aes-256-ctr',_0x3e1541,_0x2c717a);let _0x3309ff=_0x57db07[_0xa2f40c(0x182)](_0x2f0788,_0xa2f40c(0x17b),'base64');return _0x3309ff+=_0x57db07['final']('base64'),_0x3309ff;}[a42_0x481cc2(0xe8)](_0x2124fb,_0x2e9431){const _0xc12039=a42_0x481cc2;try{const _0x49b320=fs_1[_0xc12039(0xc3)]['readFileSync'](this[_0xc12039(0x192)],'utf8')['trim'](),_0x31ee07={'iv':_0x2e9431[_0xc12039(0x186)](_0xc12039(0x118)),'key':_0x2124fb[_0xc12039(0x186)](_0xc12039(0x118))},_0x1c59bb=JSON[_0xc12039(0x107)](_0x31ee07);console['log'](_0xc12039(0x12f),_0x1c59bb[_0xc12039(0x196)]);const _0x23d5da=crypto_1[_0xc12039(0xc3)][_0xc12039(0xf9)]({'key':_0x49b320,'padding':crypto_1[_0xc12039(0xc3)][_0xc12039(0x122)]['RSA_PKCS1_PADDING']},Buffer[_0xc12039(0xcb)](_0x1c59bb));return console[_0xc12039(0xfe)]('✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:',_0x23d5da[_0xc12039(0x196)]),_0x23d5da[_0xc12039(0x186)]('base64');}catch(_0xc22635){console['error'](_0xc12039(0x129),_0xc22635);throw new Error(_0xc12039(0x12d));}}[a42_0x481cc2(0xf4)](_0x5eb57e){const _0x76a106=a42_0x481cc2;try{const _0x5c282c=fs_1[_0x76a106(0xc3)][_0x76a106(0x176)](this[_0x76a106(0x1b0)],_0x76a106(0x17b))['trim'](),_0x45da47=crypto_1[_0x76a106(0xc3)][_0x76a106(0x154)](_0x76a106(0x1a8));_0x45da47['update'](_0x5eb57e),_0x45da47['end']();const _0x4adbba=_0x45da47[_0x76a106(0x126)](_0x5c282c,'base64');return console[_0x76a106(0xfe)](_0x76a106(0xde)),console[_0x76a106(0xfe)]('📝\x20Data\x20to\x20sign\x20length:',_0x5eb57e[_0x76a106(0x196)]),console[_0x76a106(0xfe)]('📝\x20Signature\x20length:',_0x4adbba[_0x76a106(0x196)]),_0x4adbba;}catch(_0x3f4e8e){console[_0x76a106(0x131)](_0x76a106(0x183),_0x3f4e8e),console['error'](_0x76a106(0x120),_0x5eb57e['substring'](0x0,0xc8)+'...');throw new Error(_0x76a106(0x165));}}[a42_0x481cc2(0x171)](_0x1857f0,_0x5a4d9e,_0x26f976){const _0xb0addf=a42_0x481cc2,_0x48e6eb=crypto_1[_0xb0addf(0xc3)][_0xb0addf(0x197)](_0xb0addf(0x13c),_0x5a4d9e,_0x26f976);let _0x544117=_0x48e6eb[_0xb0addf(0x182)](_0x1857f0,_0xb0addf(0x118),_0xb0addf(0x17b));return _0x544117+=_0x48e6eb[_0xb0addf(0xd0)](_0xb0addf(0x17b)),_0x544117;}async['decryptResponsePhp'](_0x48950f,_0x4d9e02){const _0x1df7bd=a42_0x481cc2;try{const _0x2daf1d=await fetch(_0x1df7bd(0xbd),{'method':_0x1df7bd(0xef),'headers':{'Content-Type':_0x1df7bd(0x102)},'body':JSON['stringify']({'info':_0x48950f,'key':_0x4d9e02})});if(!_0x2daf1d['ok'])throw new Error(_0x1df7bd(0xba));return await _0x2daf1d['text']();}catch(_0x3de897){console[_0x1df7bd(0x131)](_0x1df7bd(0xf6),_0x3de897);throw new Error(_0x1df7bd(0xdc));}}[a42_0x481cc2(0x159)](_0x1d7108,_0x33ab84){const _0x5ea363=a42_0x481cc2;try{const _0x429c37=fs_1[_0x5ea363(0xc3)][_0x5ea363(0x176)](this[_0x5ea363(0x1b0)],_0x5ea363(0x17b))[_0x5ea363(0x1b1)](),_0x1435a2=crypto_1[_0x5ea363(0xc3)][_0x5ea363(0x16d)](_0x429c37,Buffer[_0x5ea363(0xcb)](_0x33ab84,_0x5ea363(0x118))),_0x2f00c6=JSON[_0x5ea363(0x161)](_0x1435a2['toString']()),_0x353303=Buffer[_0x5ea363(0xcb)](_0x2f00c6['key'],_0x5ea363(0x118)),_0xca6970=Buffer[_0x5ea363(0xcb)](_0x2f00c6['iv'],'base64');return this[_0x5ea363(0x171)](_0x1d7108,_0x353303,_0xca6970);}catch(_0x46db4d){throw new Error(_0x5ea363(0x14b));}}async['processCardPayment'](_0x1cd2a5){const _0x5a76bc=a42_0x481cc2,{paymentId:_0x564a19,orderId:_0x1272de,amount:_0x5d5d82,currency:_0x482c8c,cardData:_0x3e2494,resultUrl:_0x3539ea,returnUrl:_0x59480e,cardHolder:_0x1a18a3,browser:_0xe88305}=_0x1cd2a5;console[_0x5a76bc(0xfe)](_0x5a76bc(0x136)),console['log'](_0x5a76bc(0x135),_0x564a19),console['log'](_0x5a76bc(0x1ab),_0x1272de),console['log'](_0x5a76bc(0xc6),_0x5d5d82,_0x482c8c),console[_0x5a76bc(0xfe)](_0x5a76bc(0x14a),this[_0x5a76bc(0x10f)](_0x3e2494['number'])),console[_0x5a76bc(0xfe)](_0x5a76bc(0xc1),_0x1a18a3[_0x5a76bc(0xfc)]+'\x20'+_0x1a18a3[_0x5a76bc(0x124)]),console[_0x5a76bc(0xfe)](_0x5a76bc(0x106),_0x59480e),console[_0x5a76bc(0xfe)]('Result\x20URL:',_0x3539ea);const _0x27e8e9={'amount':_0x5d5d82,'currency':_0x482c8c[_0x5a76bc(0x189)](),'order_id':_0x1272de,'result_url':_0x3539ea,'return_url':_0x59480e,'card':{'number':_0x3e2494[_0x5a76bc(0x139)],'expire_month':_0x3e2494[_0x5a76bc(0x15b)],'expire_year':_0x3e2494[_0x5a76bc(0x190)],'cvv':_0x3e2494['cvv']},'card_holder':_0x1a18a3,'browser':_0xe88305},_0x4a3797=JSON[_0x5a76bc(0x107)](_0x27e8e9);console[_0x5a76bc(0xfe)](_0x5a76bc(0x116)),console[_0x5a76bc(0xfe)](_0x5a76bc(0x198)),console['log'](_0x4a3797),console[_0x5a76bc(0xfe)](_0x5a76bc(0x187),_0x4a3797[_0x5a76bc(0x196)]);try{const {key:_0x40fab9,iv:_0x1d99d3}=this['generateAESKey']();console[_0x5a76bc(0xfe)]('🔐\x20AES\x20key\x20and\x20IV\x20generated'),console[_0x5a76bc(0xfe)]('🔐\x20AES\x20key\x20length:',_0x40fab9[_0x5a76bc(0x196)]),console[_0x5a76bc(0xfe)](_0x5a76bc(0x133),_0x1d99d3['length']);const _0x1ffcf7=this[_0x5a76bc(0x13b)](_0x4a3797,_0x40fab9,_0x1d99d3);console[_0x5a76bc(0xfe)](_0x5a76bc(0x119)),console[_0x5a76bc(0xfe)]('📝\x20Encrypted\x20data\x20length:',_0x1ffcf7[_0x5a76bc(0x196)]);const _0x5a4148=this[_0x5a76bc(0xe8)](_0x40fab9,_0x1d99d3);console[_0x5a76bc(0xfe)](_0x5a76bc(0x12b)),console[_0x5a76bc(0xfe)](_0x5a76bc(0xd3),_0x5a4148['length']);const _0x3291a2=this[_0x5a76bc(0xf4)](_0x4a3797);console[_0x5a76bc(0xfe)](_0x5a76bc(0xe7)),console[_0x5a76bc(0xfe)](_0x5a76bc(0x113),_0x3291a2[_0x5a76bc(0x196)]);const _0x536ae3={'merchant_point_id':this[_0x5a76bc(0xd5)],'method':_0x5a76bc(0x112),'info':_0x1ffcf7,'key':_0x5a4148,'sign':_0x3291a2,'lang':'en'};console[_0x5a76bc(0xfe)](_0x5a76bc(0x11e)),console[_0x5a76bc(0xfe)](_0x5a76bc(0xe5)),console[_0x5a76bc(0xfe)]('\x20\x20\x20-\x20merchant_point_id:',this[_0x5a76bc(0xd5)]),console['log'](_0x5a76bc(0x19d)),console[_0x5a76bc(0xfe)]('\x20\x20\x20-\x20info\x20length:',_0x1ffcf7['length']),console['log'](_0x5a76bc(0x14f),_0x5a4148[_0x5a76bc(0x196)]),console['log'](_0x5a76bc(0x180),_0x3291a2['length']),console['log'](_0x5a76bc(0x149)),loggerService_1['loggerService']['logWhiteDomainRequest'](_0x5a76bc(0x134),_0x5a76bc(0x188),_0x5a76bc(0xef),{'merchant_point_id':this[_0x5a76bc(0xd5)],'method':'charge','lang':'en'});const _0x9f7d4=Date[_0x5a76bc(0x164)](),_0x4fcdd7=await fetch(this[_0x5a76bc(0x11f)],{'method':_0x5a76bc(0xef),'headers':{'Content-Type':_0x5a76bc(0x102),'Accept':_0x5a76bc(0x102),'User-Agent':_0x5a76bc(0x151)},'body':JSON[_0x5a76bc(0x107)](_0x536ae3)}),_0x45b2c7=Date[_0x5a76bc(0x164)]()-_0x9f7d4;console['log'](_0x5a76bc(0xe9)),console[_0x5a76bc(0xfe)]('Status:',_0x4fcdd7[_0x5a76bc(0xc8)]),console['log'](_0x5a76bc(0x141),_0x45b2c7+'ms');if(!_0x4fcdd7['ok']){const _0x3c6ba8=await _0x4fcdd7['text']();console[_0x5a76bc(0x131)]('HTTP\x20Status:',_0x4fcdd7[_0x5a76bc(0xc8)]),console[_0x5a76bc(0x131)](_0x5a76bc(0x12a),_0x3c6ba8),loggerService_1[_0x5a76bc(0x13a)][_0x5a76bc(0x11d)](_0x5a76bc(0x134),'/charge_raw',_0x4fcdd7[_0x5a76bc(0xc8)],_0x3c6ba8,_0x45b2c7),loggerService_1[_0x5a76bc(0x13a)]['logWhiteDomainError'](_0x5a76bc(0x134),_0x5a76bc(0x188),_0x5a76bc(0x166)+_0x4fcdd7[_0x5a76bc(0xc8)]+':\x20'+_0x3c6ba8);throw new Error(_0x5a76bc(0x184)+_0x4fcdd7[_0x5a76bc(0xc8)]+_0x5a76bc(0x1a0)+_0x3c6ba8);}const _0x312f90=await _0x4fcdd7['json']();loggerService_1[_0x5a76bc(0x13a)][_0x5a76bc(0x11d)]('mastercard','/charge_raw',_0x4fcdd7[_0x5a76bc(0xc8)],_0x312f90,_0x45b2c7),console[_0x5a76bc(0xfe)](_0x5a76bc(0x16c));let _0x48f791=_0x312f90;if(_0x312f90[_0x5a76bc(0xd2)]&&_0x312f90['key']&&_0x312f90['sign']){console[_0x5a76bc(0xfe)](_0x5a76bc(0x100));try{const _0x1cc9d5=await this['decryptResponsePhp'](_0x312f90['info'],_0x312f90['key']);_0x48f791=JSON[_0x5a76bc(0x161)](_0x1cc9d5),console[_0x5a76bc(0xfe)](_0x5a76bc(0x123)),loggerService_1['loggerService'][_0x5a76bc(0x11d)]('mastercard',_0x5a76bc(0x195),_0x4fcdd7[_0x5a76bc(0xc8)],_0x48f791,_0x45b2c7),console[_0x5a76bc(0xfe)](_0x5a76bc(0x185));}catch(_0x55c80a){console['error'](_0x5a76bc(0x11b),_0x55c80a),loggerService_1[_0x5a76bc(0x13a)]['logWhiteDomainError'](_0x5a76bc(0x134),_0x5a76bc(0x163),_0x5a76bc(0x103)+_0x55c80a),_0x48f791=_0x312f90;}}else loggerService_1[_0x5a76bc(0x13a)]['logWhiteDomainResponse'](_0x5a76bc(0x134),_0x5a76bc(0x195),_0x4fcdd7[_0x5a76bc(0xc8)],_0x48f791,_0x45b2c7),console['log'](_0x5a76bc(0xf1));console[_0x5a76bc(0xfe)]('Status:',_0x48f791[_0x5a76bc(0xc8)]),console[_0x5a76bc(0xfe)](_0x5a76bc(0x175),_0x48f791[_0x5a76bc(0xd0)]),console[_0x5a76bc(0xfe)](_0x5a76bc(0x135),_0x48f791[_0x5a76bc(0x143)]),console['log']('3DS\x20URL:',_0x48f791['3ds_url']||_0x5a76bc(0x142));if(_0x48f791['status']===0x64&&_0x48f791[_0x5a76bc(0xd0)]===0x1)return console[_0x5a76bc(0xfe)](_0x5a76bc(0x13f)),{'gateway_payment_id':_0x48f791[_0x5a76bc(0x143)]?.[_0x5a76bc(0x186)](),'payment_url':_0x59480e,'requires_3ds':![],'status':_0x5a76bc(0x10d),'final':!![]};if(_0x48f791[_0x5a76bc(0x125)])return console[_0x5a76bc(0xfe)](_0x5a76bc(0x18c)),this[_0x5a76bc(0x17f)](_0x564a19,_0x1272de,_0x48f791[_0x5a76bc(0x143)]?.[_0x5a76bc(0x186)]()||_0x1272de),{'gateway_payment_id':_0x48f791[_0x5a76bc(0x143)]?.[_0x5a76bc(0x186)](),'payment_url':_0x48f791['3ds_url'],'requires_3ds':!![],'threeds_url':_0x48f791['3ds_url'],'status':_0x5a76bc(0xce),'final':![]};let _0xd8542a=_0x48f791[_0x5a76bc(0x14e)]||_0x48f791[_0x5a76bc(0x105)]||_0x5a76bc(0x194),_0x2a619d=_0x48f791[_0x5a76bc(0xc8)],_0x3c5fcd=_0x48f791[_0x5a76bc(0xd0)];return console['log'](_0x5a76bc(0x130)+_0x2a619d+_0x5a76bc(0x168)+_0x3c5fcd+_0x5a76bc(0x138)+_0xd8542a),{'gateway_payment_id':_0x48f791[_0x5a76bc(0x143)]?.['toString'](),'payment_url':_0x59480e,'requires_3ds':![],'status':'FAILED','final':!![]};}catch(_0x2199d6){console[_0x5a76bc(0x131)]('===\x20MASTERCARD\x20SERVICE\x20ERROR\x20==='),console[_0x5a76bc(0x131)]('Error\x20details:',_0x2199d6),loggerService_1[_0x5a76bc(0x13a)][_0x5a76bc(0x1ac)]('mastercard',_0x5a76bc(0x188),_0x2199d6);throw new Error(_0x5a76bc(0x11c)+(_0x2199d6 instanceof Error?_0x2199d6[_0x5a76bc(0x105)]:_0x5a76bc(0x194)));}}async[a42_0x481cc2(0xdf)](_0x35ffb8,_0x1c7d88){const _0x1e45c4=a42_0x481cc2;console[_0x1e45c4(0xfe)](_0x1e45c4(0x17e)+_0x35ffb8+'\x20('+_0x1c7d88+')');try{const _0x213e88={'payment_id':_0x35ffb8,'order_id':_0x1c7d88},_0x8b4f45=JSON[_0x1e45c4(0x107)](_0x213e88),{key:_0x10a5ef,iv:_0x22d76f}=this[_0x1e45c4(0x18e)](),_0x3d8c3c=this[_0x1e45c4(0x13b)](_0x8b4f45,_0x10a5ef,_0x22d76f),_0x9a9917=this[_0x1e45c4(0xe8)](_0x10a5ef,_0x22d76f),_0x2b35b4=this['signRSA'](_0x8b4f45),_0xab9a85={'merchant_point_id':this[_0x1e45c4(0xd5)],'method':_0x1e45c4(0xc8),'info':_0x3d8c3c,'key':_0x9a9917,'sign':_0x2b35b4,'lang':'en'};loggerService_1[_0x1e45c4(0x13a)][_0x1e45c4(0xf5)]('mastercard',_0x1e45c4(0xdb),_0x1e45c4(0xef),{'merchant_point_id':this[_0x1e45c4(0xd5)],'method':_0x1e45c4(0xc8),'lang':'en'});const _0x5e94a3=Date['now'](),_0x4cd47c=await fetch(this[_0x1e45c4(0x11f)],{'method':_0x1e45c4(0xef),'headers':{'Content-Type':_0x1e45c4(0x102),'Accept':_0x1e45c4(0x102),'User-Agent':_0x1e45c4(0x151)},'body':JSON[_0x1e45c4(0x107)](_0xab9a85)}),_0x3859ec=Date[_0x1e45c4(0x164)]()-_0x5e94a3;if(!_0x4cd47c['ok']){const _0x4f6490=await _0x4cd47c[_0x1e45c4(0xd1)]();loggerService_1[_0x1e45c4(0x13a)]['logWhiteDomainResponse']('mastercard',_0x1e45c4(0x1a7),_0x4cd47c[_0x1e45c4(0xc8)],_0x4f6490,_0x3859ec);throw new Error(_0x1e45c4(0x184)+_0x4cd47c['status']);}const _0x341467=await _0x4cd47c[_0x1e45c4(0x114)]();loggerService_1[_0x1e45c4(0x13a)][_0x1e45c4(0x11d)]('mastercard',_0x1e45c4(0x1a7),_0x4cd47c[_0x1e45c4(0xc8)],_0x341467,_0x3859ec);let _0x5dac08=_0x341467;if(_0x341467['info']&&_0x341467['key']&&_0x341467['sign']){console[_0x1e45c4(0xfe)](_0x1e45c4(0x10c));try{const _0x268e15=this[_0x1e45c4(0x159)](_0x341467['info'],_0x341467[_0x1e45c4(0x199)]);_0x5dac08=JSON[_0x1e45c4(0x161)](_0x268e15),console['log'](_0x1e45c4(0x137)),loggerService_1[_0x1e45c4(0x13a)][_0x1e45c4(0x11d)](_0x1e45c4(0x134),_0x1e45c4(0x193),_0x4cd47c['status'],_0x5dac08,_0x3859ec),console[_0x1e45c4(0xfe)](_0x1e45c4(0xd4));}catch(_0xda22bc){console[_0x1e45c4(0x131)](_0x1e45c4(0xec),_0xda22bc),loggerService_1[_0x1e45c4(0x13a)][_0x1e45c4(0x1ac)](_0x1e45c4(0x134),_0x1e45c4(0x147),_0x1e45c4(0x1b2)+_0xda22bc),_0x5dac08=_0x341467;}}else loggerService_1[_0x1e45c4(0x13a)][_0x1e45c4(0x11d)](_0x1e45c4(0x134),_0x1e45c4(0x193),_0x4cd47c['status'],_0x5dac08,_0x3859ec),console[_0x1e45c4(0xfe)]('📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted');console['log']('📊\x20Status\x20check\x20result:',{'status':_0x5dac08[_0x1e45c4(0xc8)],'final':_0x5dac08[_0x1e45c4(0xd0)],'payment_id':_0x5dac08['payment_id'],'desc':_0x5dac08[_0x1e45c4(0x14e)]});let _0x5846d1=_0x1e45c4(0xce);if(_0x5dac08['status']===0x1&&_0x5dac08[_0x1e45c4(0xd0)]===0x1)_0x5846d1=_0x1e45c4(0x10d);else _0x5dac08['status']===0x0&&_0x5dac08[_0x1e45c4(0xd0)]===0x0?_0x5846d1=_0x1e45c4(0xce):_0x5846d1=_0x1e45c4(0xea);return{'status':_0x5846d1,'final':_0x5dac08[_0x1e45c4(0xd0)]===0x1,'amount':_0x5dac08[_0x1e45c4(0xf3)],'currency':_0x5dac08[_0x1e45c4(0xf8)],'date_success':_0x5dac08['date_success'],'description':_0x5dac08[_0x1e45c4(0x14e)]};}catch(_0xe69964){console[_0x1e45c4(0x131)](_0x1e45c4(0xca),_0xe69964),loggerService_1[_0x1e45c4(0x13a)][_0x1e45c4(0x1ac)](_0x1e45c4(0x134),'/status',_0xe69964);throw new Error('Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20'+(_0xe69964 instanceof Error?_0xe69964[_0x1e45c4(0x105)]:_0x1e45c4(0x194)));}}[a42_0x481cc2(0x17f)](_0xf9d4b8,_0x5ed08d,_0x45e10b){const _0x441c52=a42_0x481cc2;console[_0x441c52(0xfe)](_0x441c52(0x110)+_0xf9d4b8+'\x20('+_0x45e10b+')'),this[_0x441c52(0x145)](_0xf9d4b8);const _0x4de062=[],_0x220797=0x5*0x3c*0x3e8,_0x637796=0x2*0x3c*0x3c*0x3e8,_0x25d417=Math[_0x441c52(0xc7)](_0x637796/_0x220797);console[_0x441c52(0xfe)](_0x441c52(0x16b)+_0x25d417+'\x20times\x20every\x205\x20minutes\x20for\x202\x20hours');for(let _0x87c7d6=0x1;_0x87c7d6<=_0x25d417;_0x87c7d6++){const _0x33c6a6=setTimeout(async()=>{const _0x518e05=_0x441c52;console[_0x518e05(0xfe)](_0x518e05(0x144)+_0x87c7d6+'/'+_0x25d417+'\x20for\x20payment\x20'+_0xf9d4b8);try{const _0x2f840f=await this['checkPaymentStatus'](_0x45e10b,_0x5ed08d);console[_0x518e05(0xfe)](_0x518e05(0xd9)+_0x87c7d6+_0x518e05(0x191),_0x2f840f),_0x2f840f[_0x518e05(0xd0)]&&(console[_0x518e05(0xfe)](_0x518e05(0xc2)+_0xf9d4b8+_0x518e05(0x1a3)+_0x2f840f['status']+_0x518e05(0x177)),this[_0x518e05(0x145)](_0xf9d4b8),await this['updatePaymentStatus'](_0xf9d4b8,_0x2f840f[_0x518e05(0xc8)],_0x2f840f));}catch(_0x3da672){console[_0x518e05(0x131)](_0x518e05(0x18b)+_0x87c7d6+'\x20failed\x20for\x20payment\x20'+_0xf9d4b8+':',_0x3da672);}},_0x87c7d6*_0x220797);_0x4de062[_0x441c52(0xd8)](_0x33c6a6);}this[_0x441c52(0x179)][_0x441c52(0xfd)](_0xf9d4b8,_0x4de062),console[_0x441c52(0xfe)](_0x441c52(0xf7)+_0x25d417+_0x441c52(0x14d)+_0xf9d4b8);}[a42_0x481cc2(0x145)](_0x211401){const _0xa070=a42_0x481cc2,_0x766fe5=this[_0xa070(0x179)][_0xa070(0x158)](_0x211401);_0x766fe5&&(console['log'](_0xa070(0xf0)+_0x766fe5[_0xa070(0x196)]+'\x20status\x20timers\x20for\x20payment\x20'+_0x211401),_0x766fe5[_0xa070(0x15f)]((_0x42eaa1,_0x147f5b)=>{clearTimeout(_0x42eaa1);}),this[_0xa070(0x179)][_0xa070(0x127)](_0x211401));}async['updatePaymentStatus'](_0x98713a,_0x10bd72,_0x7e58fe){const _0x56c0ae=a42_0x481cc2;try{const _0x51dbb4=(await Promise[_0x56c0ae(0x11a)]()[_0x56c0ae(0x155)](()=>__importStar(require(_0x56c0ae(0x150)))))['default'],_0x4f77b8={'status':_0x10bd72[_0x56c0ae(0x189)](),'updatedAt':new Date(),'statusChangedBy':_0x56c0ae(0x152),'statusChangedAt':new Date()};_0x10bd72==='PAID'&&(_0x4f77b8[_0x56c0ae(0x121)]=new Date()),_0x7e58fe[_0x56c0ae(0x10a)]&&(_0x4f77b8['adminNotes']=_0x56c0ae(0xe3)+_0x7e58fe['description']),await _0x51dbb4[_0x56c0ae(0x117)][_0x56c0ae(0x182)]({'where':{'id':_0x98713a},'data':_0x4f77b8}),console['log'](_0x56c0ae(0xc2)+_0x98713a+_0x56c0ae(0x14c)+_0x10bd72),await this['sendPaymentNotifications'](_0x98713a,_0x10bd72);}catch(_0x36fbb4){console[_0x56c0ae(0x131)](_0x56c0ae(0x10e)+_0x98713a+':',_0x36fbb4);}}async[a42_0x481cc2(0x148)](_0x246769,_0x387b50){const _0x845647=a42_0x481cc2;try{const _0x23c9ab=(await Promise[_0x845647(0x11a)]()[_0x845647(0x155)](()=>__importStar(require(_0x845647(0x150)))))[_0x845647(0xc3)],{telegramBotService:_0x2e40a3}=await Promise[_0x845647(0x11a)]()[_0x845647(0x155)](()=>__importStar(require('../telegramBotService'))),_0x1b5a47=await _0x23c9ab[_0x845647(0x117)][_0x845647(0x157)]({'where':{'id':_0x246769},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1b5a47)return;const _0x47225f={'PAID':'paid','FAILED':_0x845647(0x19a)},_0x934488=_0x47225f[_0x387b50];_0x934488&&await _0x2e40a3[_0x845647(0x108)](_0x1b5a47[_0x845647(0xc0)],_0x1b5a47,_0x934488),await this[_0x845647(0xcd)](_0x1b5a47,_0x387b50);}catch(_0x164e4d){console[_0x845647(0x131)](_0x845647(0x19b),_0x164e4d);}}async[a42_0x481cc2(0xcd)](_0x314577,_0x356013){const _0x256cda=a42_0x481cc2,_0x30b9fa=Date[_0x256cda(0x164)]();try{const _0xdfa3af=_0x314577[_0x256cda(0x1a6)],_0x243e72=_0xdfa3af[_0x256cda(0xe4)];if(!_0x243e72?.[_0x256cda(0x1a4)]){console[_0x256cda(0xfe)](_0x256cda(0xda)+_0xdfa3af['id']);return;}const _0x45eda5=_0x356013===_0x256cda(0x10d)?_0x256cda(0x170):_0x256cda(0x1a2);let _0x593be4=[];if(_0x243e72[_0x256cda(0x18f)])try{_0x593be4=Array[_0x256cda(0x19c)](_0x243e72[_0x256cda(0x18f)])?_0x243e72['webhookEvents']:JSON['parse'](_0x243e72[_0x256cda(0x18f)]);}catch(_0x47e2d3){console[_0x256cda(0x131)]('Error\x20parsing\x20webhook\x20events:',_0x47e2d3),_0x593be4=[];}if(!_0x593be4[_0x256cda(0x13e)](_0x45eda5)){console['log'](_0x256cda(0xeb)+_0x45eda5+_0x256cda(0x16f)+_0xdfa3af['id']);return;}const _0x116ae6={'event':_0x45eda5,'payment':{'id':_0x314577['id'],'order_id':_0x314577[_0x256cda(0xbc)],'gateway_order_id':_0x314577[_0x256cda(0x15c)],'gateway':_0x256cda(0x160),'amount':_0x314577[_0x256cda(0xf3)],'currency':_0x314577[_0x256cda(0xf8)],'status':_0x356013['toLowerCase'](),'customer_email':_0x314577[_0x256cda(0xed)],'customer_name':_0x314577[_0x256cda(0x12e)],'created_at':_0x314577[_0x256cda(0x146)],'updated_at':new Date()}},_0x53c14b=await fetch(_0x243e72['webhookUrl'],{'method':_0x256cda(0xef),'headers':{'Content-Type':'application/json','User-Agent':_0x256cda(0x174)},'body':JSON['stringify'](_0x116ae6)}),_0xd638fc=Date[_0x256cda(0x164)]()-_0x30b9fa;loggerService_1[_0x256cda(0x13a)]['logShopWebhookSent'](_0x314577[_0x256cda(0xc0)],_0x243e72[_0x256cda(0x1a4)],_0x45eda5,_0x53c14b[_0x256cda(0xc8)],_0xd638fc,_0x116ae6),console[_0x256cda(0xfe)](_0x256cda(0x1aa)+_0x243e72[_0x256cda(0x1a4)]+'\x20with\x20status\x20'+_0x53c14b[_0x256cda(0xc8)]+'\x20('+_0xd638fc+_0x256cda(0xd6));}catch(_0x2d6750){console[_0x256cda(0x131)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x2d6750),loggerService_1[_0x256cda(0x13a)][_0x256cda(0x13d)](_0x314577[_0x256cda(0xc0)],_0x314577[_0x256cda(0x1a6)]?.[_0x256cda(0xe4)]?.['webhookUrl']||_0x256cda(0x1b4),_0x256cda(0xc9),_0x2d6750,{});}}[a42_0x481cc2(0x10f)](_0x342336){const _0x5061=a42_0x481cc2,_0x1290d7=_0x342336['replace'](/[\s-]/g,'');if(_0x1290d7[_0x5061(0x196)]<0x4)return _0x5061(0x1af);return _0x5061(0x10b)+_0x1290d7[_0x5061(0xcc)](-0x4);}async[a42_0x481cc2(0xcf)](_0x5d06f6){const _0x1911d5=a42_0x481cc2;console[_0x1911d5(0xfe)]('Processing\x20MasterCard\x20webhook:',_0x5d06f6);let _0x317c2d=_0x1911d5(0xce);if(_0x5d06f6[_0x1911d5(0xc8)]===0x1&&_0x5d06f6['final']===0x1)_0x317c2d=_0x1911d5(0x10d);else _0x5d06f6['status']===0x0&&_0x5d06f6['final']===0x0?_0x317c2d=_0x1911d5(0xce):_0x317c2d=_0x1911d5(0xea);return{'paymentId':_0x5d06f6[_0x1911d5(0x115)]||'','status':_0x317c2d,'amount':_0x5d06f6[_0x1911d5(0xf3)],'currency':_0x5d06f6[_0x1911d5(0xf8)]};}[a42_0x481cc2(0x169)](){const _0x3ad90c=a42_0x481cc2;console['log'](_0x3ad90c(0x15e));const _0xb40e11=this['statusCheckTimers'][_0x3ad90c(0xf2)];for(const [_0x5b5c92]of this['statusCheckTimers']){this[_0x3ad90c(0x145)](_0x5b5c92);}console[_0x3ad90c(0xfe)](_0x3ad90c(0x156)+_0xb40e11+_0x3ad90c(0xbb));}}exports[a42_0x481cc2(0x153)]=MasterCardService;