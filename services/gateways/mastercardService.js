'use strict';const a42_0x6c10e2=a42_0x19a5;(function(_0x26e3a4,_0x1ba845){const _0x2f6595=a42_0x19a5,_0x56c1fc=_0x26e3a4();while(!![]){try{const _0x5ce9c9=parseInt(_0x2f6595(0x1ac))/0x1+parseInt(_0x2f6595(0x269))/0x2+parseInt(_0x2f6595(0x1b8))/0x3+-parseInt(_0x2f6595(0x1ca))/0x4+-parseInt(_0x2f6595(0x180))/0x5*(parseInt(_0x2f6595(0x25c))/0x6)+-parseInt(_0x2f6595(0x1e7))/0x7*(-parseInt(_0x2f6595(0x19b))/0x8)+-parseInt(_0x2f6595(0x1da))/0x9;if(_0x5ce9c9===_0x1ba845)break;else _0x56c1fc['push'](_0x56c1fc['shift']());}catch(_0x7f4891){_0x56c1fc['push'](_0x56c1fc['shift']());}}}(a42_0x1a89,0x5c0a2));var __createBinding=this&&this['__createBinding']||(Object[a42_0x6c10e2(0x1cd)]?function(_0x501789,_0xf09617,_0x45af8f,_0x5ac81d){const _0xc685eb=a42_0x6c10e2;if(_0x5ac81d===undefined)_0x5ac81d=_0x45af8f;var _0x2cd441=Object[_0xc685eb(0x1f2)](_0xf09617,_0x45af8f);(!_0x2cd441||(_0xc685eb(0x25f)in _0x2cd441?!_0xf09617[_0xc685eb(0x1dc)]:_0x2cd441[_0xc685eb(0x1a1)]||_0x2cd441[_0xc685eb(0x20e)]))&&(_0x2cd441={'enumerable':!![],'get':function(){return _0xf09617[_0x45af8f];}}),Object[_0xc685eb(0x1cc)](_0x501789,_0x5ac81d,_0x2cd441);}:function(_0x53a912,_0x50cc80,_0x3cf4bb,_0x1d31ad){if(_0x1d31ad===undefined)_0x1d31ad=_0x3cf4bb;_0x53a912[_0x1d31ad]=_0x50cc80[_0x3cf4bb];}),__setModuleDefault=this&&this[a42_0x6c10e2(0x21c)]||(Object[a42_0x6c10e2(0x1cd)]?function(_0x472bc4,_0x4c6034){const _0x50ea49=a42_0x6c10e2;Object[_0x50ea49(0x1cc)](_0x472bc4,_0x50ea49(0x1a5),{'enumerable':!![],'value':_0x4c6034});}:function(_0x45582d,_0x1f69f8){const _0x134e9f=a42_0x6c10e2;_0x45582d[_0x134e9f(0x1a5)]=_0x1f69f8;}),__importStar=this&&this['__importStar']||(function(){var _0x3386d0=function(_0x4fd177){const _0x14adb8=a42_0x19a5;return _0x3386d0=Object[_0x14adb8(0x1f8)]||function(_0x464605){const _0x44be1e=_0x14adb8;var _0x41116e=[];for(var _0x84e0bf in _0x464605)if(Object['prototype'][_0x44be1e(0x22b)][_0x44be1e(0x19d)](_0x464605,_0x84e0bf))_0x41116e[_0x41116e[_0x44be1e(0x18a)]]=_0x84e0bf;return _0x41116e;},_0x3386d0(_0x4fd177);};return function(_0x3179bf){const _0x3ec467=a42_0x19a5;if(_0x3179bf&&_0x3179bf[_0x3ec467(0x1dc)])return _0x3179bf;var _0x310b05={};if(_0x3179bf!=null){for(var _0x2dba0d=_0x3386d0(_0x3179bf),_0x420597=0x0;_0x420597<_0x2dba0d[_0x3ec467(0x18a)];_0x420597++)if(_0x2dba0d[_0x420597]!==_0x3ec467(0x1a5))__createBinding(_0x310b05,_0x3179bf,_0x2dba0d[_0x420597]);}return __setModuleDefault(_0x310b05,_0x3179bf),_0x310b05;};}()),__importDefault=this&&this[a42_0x6c10e2(0x25b)]||function(_0x495ceb){const _0x166ee7=a42_0x6c10e2;return _0x495ceb&&_0x495ceb[_0x166ee7(0x1dc)]?_0x495ceb:{'default':_0x495ceb};};function a42_0x1a89(){const _0x3c307f=['private.pem','getOwnPropertyNames','Processing\x20MasterCard\x20webhook:','checkPaymentStatus','../telegramBotService','🔐\x20RSA\x20signing\x20successful','MasterCard\x20webhook\x20sent\x20to\x20','end','❌\x20Data\x20being\x20signed:','🔐\x20AES\x20IV\x20length:','🔐\x203DS\x20verification\x20required','Unknown\x20error','resolve','Result\x20URL:','Return\x20URL:','readFileSync','/status_raw','Amount:','\x20is\x20final\x20(','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','psp_public.pem','findUnique','delete','configurable','toUpperCase','payment.failed','Webhook\x20event\x20','paidAt','processWebhook','📝\x20Data\x20length:','utf8','📝\x20Data\x20to\x20sign\x20length:','then','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','https://api.paydmeth.com/api','Failed\x20to\x20decrypt\x20response\x20via\x20PHP','expire_year','__setModuleDefault','decryptAES','🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA','merchantPointId','/status_decrypt','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','processCardPayment','===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===','decryptResponse','3DS\x20URL:','✅\x20Payment\x20','HTTP\x20','❌\x20RSA\x20signing\x20failed:','currency','aes-256-ctr','hasOwnProperty','Status\x20decryption\x20failed:\x20','✅\x20Status\x20response\x20decrypted\x20successfully','/charge','🔐\x20Public\x20key\x20length:\x20','PAID','base64',',\x20body:\x20','apiUrl','maskCardNumber','📝\x20Signature\x20length:','Failed\x20to\x20send\x20MasterCard\x20webhook:','Error\x20parsing\x20webhook\x20events:','...','first_name','join','\x20status\x20timers\x20for\x20payment\x20','\x20failed\x20for\x20payment\x20','updatePaymentStatus','Public\x20key\x20file\x20not\x20found:\x20','MasterCard\x20status\x20check\x20error:','publicEncrypt','createSign','✅\x20Scheduled\x20','logWhiteDomainError','crypto','trim','webhookUrl','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','key','sign','mastercard','loggerService','date_success','stopAllStatusChecks','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','****','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','/status_decrypted','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','logShopWebhookError','/status','⏰\x20Will\x20check\x20status\x20','🔐\x20Public\x20key\x20path:','payment_id','log','\x20status\x20updated\x20to\x20','Failed\x20to\x20decrypt\x20response','__importDefault','330tVxfnd','toString','now','get','🧹\x20Clearing\x20','floor','Response\x20Time:','❌\x20RSA\x20encryption\x20failed:','FAILED','charge','status','encryptAES','sendPaymentNotifications','188672cSyAWa','replace','RSA_PKCS1_PADDING','includes','HTTP\x20Status:','isArray','payment','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','/charge_raw','scheduleStatusChecks','error','order_id','📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','-----BEGIN','505dBtRkt','amount','validateKeyFiles','webhookEvents','🔍\x20MasterCard\x20status\x20check\x20#','last_name','🔐\x20Private\x20key\x20length:\x20','none','encryptRSA','logShopWebhookSent','length','Order\x20ID:','❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','🔐\x20Data\x20signed\x20with\x20RSA','Decryption\x20failed:\x20','path','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','shopId','message','failed','randomBytes','application/json','🔐\x20AES\x20key\x20and\x20IV\x20generated','constants','slice','from','24JvyIaV','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','call','🛑\x20Stopped\x20','decryptResponsePhp','settings','writable','Private\x20key\x20file\x20not\x20found:\x20','HTTP\x20error!\x20status:\x20','3ds_url','default','TesSoft\x20Payment\x20System/1.0','keys','PENDING','logWhiteDomainResponse','1111','toLowerCase','225055PcZYSh','\x20result:','text','unknown','info','signRSA','Card\x20Number:','customerEmail','push','/charge_decrypted','final','MasterCard:\x20','1092546BwuFCF','adminNotes',',\x20Final:\x20','privateDecrypt','MasterCardService','cwd','/charge_decrypt','\x20\x20\x20-\x20method:\x20charge','shop','generateAESKey','parse','POST','statusCheckTimers','../../config/database','desc','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','\x20characters','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','13964MYCrrK','\x20MasterCard\x20status\x20check\x20timers','defineProperty','create','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','existsSync','stringify','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','),\x20stopping\x20status\x20checks','ms)','system','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','clearStatusTimers','privateKeyPath','https://api2.trapay.uk/decrypt.php','7151940VXZSrF','createdAt','__esModule','substring','Final:','update','description','paid','📊\x20Status\x20check\x20#','💾\x20Payment\x20data\x20prepared','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','📊\x20Status\x20check\x20result:','📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','1159963MTDvkN','publicKeyPath','json','sendShopWebhook','🔐\x20Private\x20key\x20path:','❌\x20MasterCard\x20key\x20validation\x20failed:','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20','number','Payment\x20ID:','Status:','createDecipheriv','getOwnPropertyDescriptor','logWhiteDomainRequest','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','orderId','customerName'];a42_0x1a89=function(){return _0x3c307f;};return a42_0x1a89();}Object['defineProperty'](exports,a42_0x6c10e2(0x1dc),{'value':!![]}),exports['MasterCardService']=void 0x0;const crypto_1=__importDefault(require(a42_0x6c10e2(0x244))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0x6c10e2(0x190))),loggerService_1=require('../loggerService');class MasterCardService{constructor(){const _0x2deb63=a42_0x6c10e2;this[_0x2deb63(0x1c4)]=new Map(),this[_0x2deb63(0x233)]=_0x2deb63(0x219),this['merchantPointId']=0x67c,this[_0x2deb63(0x1d8)]=path_1[_0x2deb63(0x1a5)][_0x2deb63(0x23a)](process[_0x2deb63(0x1bd)](),_0x2deb63(0x1a7),_0x2deb63(0x1f7)),this[_0x2deb63(0x1e8)]=path_1[_0x2deb63(0x1a5)][_0x2deb63(0x23a)](process[_0x2deb63(0x1bd)](),_0x2deb63(0x1a7),_0x2deb63(0x20b)),console[_0x2deb63(0x258)]('💳\x20MasterCard\x20service\x20initialized'),console[_0x2deb63(0x258)](_0x2deb63(0x1eb),this[_0x2deb63(0x1d8)]),console[_0x2deb63(0x258)](_0x2deb63(0x256),this[_0x2deb63(0x1e8)]),this[_0x2deb63(0x182)]();}[a42_0x6c10e2(0x182)](){const _0x30682c=a42_0x6c10e2;try{if(!fs_1[_0x30682c(0x1a5)]['existsSync'](this['privateKeyPath']))throw new Error(_0x30682c(0x1a2)+this[_0x30682c(0x1d8)]);if(!fs_1[_0x30682c(0x1a5)][_0x30682c(0x1cf)](this[_0x30682c(0x1e8)]))throw new Error(_0x30682c(0x23e)+this[_0x30682c(0x1e8)]);const _0x35aa69=fs_1[_0x30682c(0x1a5)][_0x30682c(0x206)](this[_0x30682c(0x1d8)],_0x30682c(0x215))['trim'](),_0x3fb48d=fs_1[_0x30682c(0x1a5)][_0x30682c(0x206)](this['publicKeyPath'],'utf8')[_0x30682c(0x245)]();if(!_0x35aa69[_0x30682c(0x26c)](_0x30682c(0x17f))||!_0x35aa69[_0x30682c(0x26c)]('-----END'))throw new Error('Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format');if(!_0x3fb48d[_0x30682c(0x26c)](_0x30682c(0x17f))||!_0x3fb48d['includes']('-----END'))throw new Error(_0x30682c(0x1d2));console['log'](_0x30682c(0x247)),console[_0x30682c(0x258)](_0x30682c(0x186)+_0x35aa69[_0x30682c(0x18a)]+_0x30682c(0x1c8)),console[_0x30682c(0x258)](_0x30682c(0x22f)+_0x3fb48d[_0x30682c(0x18a)]+'\x20characters');}catch(_0x11039e){console[_0x30682c(0x17c)](_0x30682c(0x1ec),_0x11039e);throw _0x11039e;}}[a42_0x6c10e2(0x1c1)](){const _0x2f833a=a42_0x6c10e2,_0x120584=crypto_1[_0x2f833a(0x1a5)]['randomBytes'](0x20),_0xee1167=crypto_1['default'][_0x2f833a(0x195)](0x10);return{'key':_0x120584,'iv':_0xee1167};}[a42_0x6c10e2(0x267)](_0x4fd714,_0x47e8f7,_0x2f4ec5){const _0x12dc05=a42_0x6c10e2,_0x2847c9=crypto_1[_0x12dc05(0x1a5)]['createCipheriv'](_0x12dc05(0x22a),_0x47e8f7,_0x2f4ec5);let _0x202d5a=_0x2847c9[_0x12dc05(0x1df)](_0x4fd714,'utf8',_0x12dc05(0x231));return _0x202d5a+=_0x2847c9[_0x12dc05(0x1b6)]('base64'),_0x202d5a;}['encryptRSA'](_0x382767,_0x247e7f){const _0x4cc76b=a42_0x6c10e2;try{const _0x1d41d6=fs_1[_0x4cc76b(0x1a5)]['readFileSync'](this[_0x4cc76b(0x1e8)],_0x4cc76b(0x215))['trim'](),_0x2ffd2f={'iv':_0x247e7f[_0x4cc76b(0x25d)](_0x4cc76b(0x231)),'key':_0x382767[_0x4cc76b(0x25d)]('base64')},_0x341519=JSON[_0x4cc76b(0x1d0)](_0x2ffd2f);console[_0x4cc76b(0x258)](_0x4cc76b(0x250),_0x341519[_0x4cc76b(0x18a)]);const _0x162f39=crypto_1[_0x4cc76b(0x1a5)][_0x4cc76b(0x240)]({'key':_0x1d41d6,'padding':crypto_1[_0x4cc76b(0x1a5)][_0x4cc76b(0x198)][_0x4cc76b(0x26b)]},Buffer[_0x4cc76b(0x19a)](_0x341519));return console[_0x4cc76b(0x258)](_0x4cc76b(0x19c),_0x162f39[_0x4cc76b(0x18a)]),_0x162f39[_0x4cc76b(0x25d)]('base64');}catch(_0x2b4ffb){console[_0x4cc76b(0x17c)](_0x4cc76b(0x263),_0x2b4ffb);throw new Error(_0x4cc76b(0x1ce));}}['signRSA'](_0x3c3408){const _0x34aabe=a42_0x6c10e2;try{const _0x43b90b=fs_1['default']['readFileSync'](this['privateKeyPath'],_0x34aabe(0x215))[_0x34aabe(0x245)](),_0x5c85da=crypto_1[_0x34aabe(0x1a5)][_0x34aabe(0x241)]('SHA256');_0x5c85da['update'](_0x3c3408),_0x5c85da[_0x34aabe(0x1fe)]();const _0x3bd1af=_0x5c85da[_0x34aabe(0x249)](_0x43b90b,_0x34aabe(0x231));return console[_0x34aabe(0x258)](_0x34aabe(0x1fc)),console[_0x34aabe(0x258)](_0x34aabe(0x216),_0x3c3408['length']),console['log']('📝\x20Signature\x20length:',_0x3bd1af[_0x34aabe(0x18a)]),_0x3bd1af;}catch(_0x427dd2){console[_0x34aabe(0x17c)](_0x34aabe(0x228),_0x427dd2),console[_0x34aabe(0x17c)](_0x34aabe(0x1ff),_0x3c3408[_0x34aabe(0x1dd)](0x0,0xc8)+_0x34aabe(0x238));throw new Error(_0x34aabe(0x1e4));}}[a42_0x6c10e2(0x21d)](_0x4676b1,_0x5bd51d,_0x18e0ca){const _0x26251d=a42_0x6c10e2,_0x578f77=crypto_1[_0x26251d(0x1a5)][_0x26251d(0x1f1)]('aes-256-ctr',_0x5bd51d,_0x18e0ca);let _0x19a773=_0x578f77[_0x26251d(0x1df)](_0x4676b1,'base64',_0x26251d(0x215));return _0x19a773+=_0x578f77[_0x26251d(0x1b6)](_0x26251d(0x215)),_0x19a773;}async[a42_0x6c10e2(0x19f)](_0x54ff89,_0x231c72){const _0x45bc6a=a42_0x6c10e2;try{const _0x564eea=await fetch(_0x45bc6a(0x1d9),{'method':_0x45bc6a(0x1c3),'headers':{'Content-Type':_0x45bc6a(0x196)},'body':JSON[_0x45bc6a(0x1d0)]({'info':_0x54ff89,'key':_0x231c72})});if(!_0x564eea['ok'])throw new Error('PHP\x20decryptor\x20error');return await _0x564eea[_0x45bc6a(0x1ae)]();}catch(_0x5aafd7){console[_0x45bc6a(0x17c)]('❌\x20PHP\x20decryptor\x20request\x20failed:',_0x5aafd7);throw new Error(_0x45bc6a(0x21a));}}[a42_0x6c10e2(0x224)](_0x282bb7,_0x2762fa){const _0x10556=a42_0x6c10e2;try{const _0x2d4cad=fs_1[_0x10556(0x1a5)][_0x10556(0x206)](this[_0x10556(0x1d8)],_0x10556(0x215))[_0x10556(0x245)](),_0x1acc8f=crypto_1[_0x10556(0x1a5)][_0x10556(0x1bb)](_0x2d4cad,Buffer['from'](_0x2762fa,_0x10556(0x231))),_0xe924f9=JSON['parse'](_0x1acc8f[_0x10556(0x25d)]()),_0x5e069c=Buffer[_0x10556(0x19a)](_0xe924f9[_0x10556(0x248)],_0x10556(0x231)),_0x60072=Buffer[_0x10556(0x19a)](_0xe924f9['iv'],'base64');return this[_0x10556(0x21d)](_0x282bb7,_0x5e069c,_0x60072);}catch(_0x4f13e5){throw new Error(_0x10556(0x25a));}}async[a42_0x6c10e2(0x222)](_0xaae3c){const _0x37fe7e=a42_0x6c10e2,{paymentId:_0x5435e1,orderId:_0x2672f3,amount:_0x25a575,currency:_0x185533,cardData:_0x42fbc3,resultUrl:_0x52989f,returnUrl:_0x1ce946,cardHolder:_0x26a3e1,browser:_0x2234aa}=_0xaae3c;console['log']('===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20==='),console['log'](_0x37fe7e(0x1ef),_0x5435e1),console[_0x37fe7e(0x258)](_0x37fe7e(0x18b),_0x2672f3),console[_0x37fe7e(0x258)](_0x37fe7e(0x208),_0x25a575,_0x185533),console['log'](_0x37fe7e(0x1b2),this[_0x37fe7e(0x234)](_0x42fbc3[_0x37fe7e(0x1ee)])),console['log']('Card\x20Holder:',_0x26a3e1[_0x37fe7e(0x239)]+'\x20'+_0x26a3e1[_0x37fe7e(0x185)]),console[_0x37fe7e(0x258)](_0x37fe7e(0x205),_0x1ce946),console[_0x37fe7e(0x258)](_0x37fe7e(0x204),_0x52989f);const _0x5a99da={'amount':_0x25a575,'currency':_0x185533[_0x37fe7e(0x20f)](),'order_id':_0x2672f3,'result_url':_0x52989f,'return_url':_0x1ce946,'card':{'number':_0x42fbc3[_0x37fe7e(0x1ee)],'expire_month':_0x42fbc3['expire_month'],'expire_year':_0x42fbc3[_0x37fe7e(0x21b)],'cvv':_0x42fbc3['cvv']},'card_holder':_0x26a3e1,'browser':_0x2234aa},_0x54a135=JSON[_0x37fe7e(0x1d0)](_0x5a99da);console[_0x37fe7e(0x258)](_0x37fe7e(0x1e3)),console[_0x37fe7e(0x258)](_0x37fe7e(0x221)),console[_0x37fe7e(0x258)](_0x54a135),console[_0x37fe7e(0x258)](_0x37fe7e(0x214),_0x54a135['length']);try{const {key:_0x21fdba,iv:_0x219872}=this[_0x37fe7e(0x1c1)]();console[_0x37fe7e(0x258)](_0x37fe7e(0x197)),console[_0x37fe7e(0x258)]('🔐\x20AES\x20key\x20length:',_0x21fdba[_0x37fe7e(0x18a)]),console[_0x37fe7e(0x258)](_0x37fe7e(0x200),_0x219872[_0x37fe7e(0x18a)]);const _0xf9a2b6=this[_0x37fe7e(0x267)](_0x54a135,_0x21fdba,_0x219872);console['log']('🔐\x20Data\x20encrypted\x20with\x20AES'),console['log']('📝\x20Encrypted\x20data\x20length:',_0xf9a2b6[_0x37fe7e(0x18a)]);const _0x4aca5c=this[_0x37fe7e(0x188)](_0x21fdba,_0x219872);console[_0x37fe7e(0x258)](_0x37fe7e(0x21e)),console[_0x37fe7e(0x258)]('📝\x20Encrypted\x20key\x20length:',_0x4aca5c[_0x37fe7e(0x18a)]);const _0x3bc76b=this[_0x37fe7e(0x1b1)](_0x54a135);console[_0x37fe7e(0x258)](_0x37fe7e(0x18e)),console[_0x37fe7e(0x258)](_0x37fe7e(0x235),_0x3bc76b[_0x37fe7e(0x18a)]);const _0x21e4e8={'merchant_point_id':this[_0x37fe7e(0x21f)],'method':'charge','info':_0xf9a2b6,'key':_0x4aca5c,'sign':_0x3bc76b,'lang':'en'};console[_0x37fe7e(0x258)](_0x37fe7e(0x191)),console[_0x37fe7e(0x258)]('📝\x20Final\x20request\x20structure:'),console[_0x37fe7e(0x258)]('\x20\x20\x20-\x20merchant_point_id:',this['merchantPointId']),console[_0x37fe7e(0x258)](_0x37fe7e(0x1bf)),console[_0x37fe7e(0x258)]('\x20\x20\x20-\x20info\x20length:',_0xf9a2b6[_0x37fe7e(0x18a)]),console[_0x37fe7e(0x258)]('\x20\x20\x20-\x20key\x20length:',_0x4aca5c[_0x37fe7e(0x18a)]),console[_0x37fe7e(0x258)]('\x20\x20\x20-\x20sign\x20length:',_0x3bc76b['length']),console['log']('\x20\x20\x20-\x20lang:\x20en'),loggerService_1[_0x37fe7e(0x24b)][_0x37fe7e(0x1f3)]('mastercard',_0x37fe7e(0x22e),_0x37fe7e(0x1c3),{'merchant_point_id':this[_0x37fe7e(0x21f)],'method':_0x37fe7e(0x265),'lang':'en'});const _0x242093=Date[_0x37fe7e(0x25e)](),_0xaa5698=await fetch(this[_0x37fe7e(0x233)],{'method':'POST','headers':{'Content-Type':_0x37fe7e(0x196),'Accept':_0x37fe7e(0x196),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x21e4e8)}),_0x25c9e3=Date['now']()-_0x242093;console[_0x37fe7e(0x258)](_0x37fe7e(0x1d6)),console[_0x37fe7e(0x258)](_0x37fe7e(0x1f0),_0xaa5698[_0x37fe7e(0x266)]),console[_0x37fe7e(0x258)](_0x37fe7e(0x262),_0x25c9e3+'ms');if(!_0xaa5698['ok']){const _0xa396e6=await _0xaa5698[_0x37fe7e(0x1ae)]();console[_0x37fe7e(0x17c)](_0x37fe7e(0x26d),_0xaa5698[_0x37fe7e(0x266)]),console[_0x37fe7e(0x17c)]('Response\x20Body:',_0xa396e6),loggerService_1[_0x37fe7e(0x24b)][_0x37fe7e(0x1a9)](_0x37fe7e(0x24a),'/charge_raw',_0xaa5698['status'],_0xa396e6,_0x25c9e3),loggerService_1[_0x37fe7e(0x24b)][_0x37fe7e(0x243)]('mastercard',_0x37fe7e(0x22e),_0x37fe7e(0x227)+_0xaa5698['status']+':\x20'+_0xa396e6);throw new Error(_0x37fe7e(0x1a3)+_0xaa5698[_0x37fe7e(0x266)]+_0x37fe7e(0x232)+_0xa396e6);}const _0x7ce094=await _0xaa5698['json']();loggerService_1[_0x37fe7e(0x24b)]['logWhiteDomainResponse']('mastercard',_0x37fe7e(0x17a),_0xaa5698['status'],_0x7ce094,_0x25c9e3),console['log'](_0x37fe7e(0x223));let _0x3b37f9=_0x7ce094;if(_0x7ce094['info']&&_0x7ce094['key']&&_0x7ce094['sign']){console[_0x37fe7e(0x258)](_0x37fe7e(0x18d));try{const _0x3d2faf=await this[_0x37fe7e(0x19f)](_0x7ce094[_0x37fe7e(0x1b0)],_0x7ce094[_0x37fe7e(0x248)]);_0x3b37f9=JSON[_0x37fe7e(0x1c2)](_0x3d2faf),console[_0x37fe7e(0x258)]('✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)'),loggerService_1[_0x37fe7e(0x24b)]['logWhiteDomainResponse'](_0x37fe7e(0x24a),_0x37fe7e(0x1b5),_0xaa5698['status'],_0x3b37f9,_0x25c9e3),console['log'](_0x37fe7e(0x20a));}catch(_0x8c4eb1){console[_0x37fe7e(0x17c)](_0x37fe7e(0x18c),_0x8c4eb1),loggerService_1[_0x37fe7e(0x24b)]['logWhiteDomainError']('mastercard',_0x37fe7e(0x1be),_0x37fe7e(0x18f)+_0x8c4eb1),_0x3b37f9=_0x7ce094;}}else loggerService_1[_0x37fe7e(0x24b)]['logWhiteDomainResponse'](_0x37fe7e(0x24a),_0x37fe7e(0x1b5),_0xaa5698[_0x37fe7e(0x266)],_0x3b37f9,_0x25c9e3),console[_0x37fe7e(0x258)](_0x37fe7e(0x17e));console[_0x37fe7e(0x258)](_0x37fe7e(0x1f0),_0x3b37f9[_0x37fe7e(0x266)]),console[_0x37fe7e(0x258)](_0x37fe7e(0x1de),_0x3b37f9[_0x37fe7e(0x1b6)]),console[_0x37fe7e(0x258)](_0x37fe7e(0x1ef),_0x3b37f9[_0x37fe7e(0x257)]),console[_0x37fe7e(0x258)](_0x37fe7e(0x225),_0x3b37f9[_0x37fe7e(0x1a4)]||_0x37fe7e(0x187));if(_0x3b37f9[_0x37fe7e(0x266)]===0x64&&_0x3b37f9[_0x37fe7e(0x1b6)]===0x1)return console[_0x37fe7e(0x258)]('✅\x20Payment\x20successful'),{'gateway_payment_id':_0x3b37f9['payment_id']?.[_0x37fe7e(0x25d)](),'payment_url':_0x1ce946,'requires_3ds':![],'status':_0x37fe7e(0x230),'final':!![]};if(_0x3b37f9['3ds_url'])return console[_0x37fe7e(0x258)](_0x37fe7e(0x201)),this['scheduleStatusChecks'](_0x5435e1,_0x2672f3,_0x3b37f9['payment_id']?.['toString']()||_0x2672f3),{'gateway_payment_id':_0x3b37f9[_0x37fe7e(0x257)]?.['toString'](),'payment_url':_0x3b37f9['3ds_url'],'requires_3ds':!![],'threeds_url':_0x3b37f9[_0x37fe7e(0x1a4)],'status':_0x37fe7e(0x1a8),'final':![]};let _0x414cbf=_0x3b37f9[_0x37fe7e(0x1c6)]||_0x3b37f9[_0x37fe7e(0x193)]||_0x37fe7e(0x202),_0x474c8c=_0x3b37f9[_0x37fe7e(0x266)],_0x1e6b5b=_0x3b37f9[_0x37fe7e(0x1b6)];return console[_0x37fe7e(0x258)]('❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20'+_0x474c8c+_0x37fe7e(0x1ba)+_0x1e6b5b+',\x20Desc:\x20'+_0x414cbf),{'gateway_payment_id':_0x3b37f9[_0x37fe7e(0x257)]?.[_0x37fe7e(0x25d)](),'payment_url':_0x1ce946,'requires_3ds':![],'status':_0x37fe7e(0x264),'final':!![]};}catch(_0x5c6917){console[_0x37fe7e(0x17c)](_0x37fe7e(0x252)),console[_0x37fe7e(0x17c)]('Error\x20details:',_0x5c6917),loggerService_1[_0x37fe7e(0x24b)]['logWhiteDomainError'](_0x37fe7e(0x24a),_0x37fe7e(0x22e),_0x5c6917);throw new Error(_0x37fe7e(0x1c7)+(_0x5c6917 instanceof Error?_0x5c6917['message']:_0x37fe7e(0x202)));}}async[a42_0x6c10e2(0x1fa)](_0x10ed38,_0x55b422){const _0x4a560b=a42_0x6c10e2;console[_0x4a560b(0x258)](_0x4a560b(0x1d1)+_0x10ed38+'\x20('+_0x55b422+')');try{const _0x582fe9={'payment_id':_0x10ed38,'order_id':_0x55b422},_0x190235=JSON['stringify'](_0x582fe9),{key:_0x1ff6d8,iv:_0x367f6e}=this[_0x4a560b(0x1c1)](),_0x19ec14=this[_0x4a560b(0x267)](_0x190235,_0x1ff6d8,_0x367f6e),_0x46f1c7=this[_0x4a560b(0x188)](_0x1ff6d8,_0x367f6e),_0x1c9c95=this[_0x4a560b(0x1b1)](_0x190235),_0x4df771={'merchant_point_id':this[_0x4a560b(0x21f)],'method':_0x4a560b(0x266),'info':_0x19ec14,'key':_0x46f1c7,'sign':_0x1c9c95,'lang':'en'};loggerService_1[_0x4a560b(0x24b)][_0x4a560b(0x1f3)](_0x4a560b(0x24a),_0x4a560b(0x254),_0x4a560b(0x1c3),{'merchant_point_id':this['merchantPointId'],'method':_0x4a560b(0x266),'lang':'en'});const _0x2e57c4=Date[_0x4a560b(0x25e)](),_0x7ee01e=await fetch(this[_0x4a560b(0x233)],{'method':_0x4a560b(0x1c3),'headers':{'Content-Type':_0x4a560b(0x196),'Accept':_0x4a560b(0x196),'User-Agent':_0x4a560b(0x1a6)},'body':JSON['stringify'](_0x4df771)}),_0x29b5a1=Date[_0x4a560b(0x25e)]()-_0x2e57c4;if(!_0x7ee01e['ok']){const _0xe3767f=await _0x7ee01e[_0x4a560b(0x1ae)]();loggerService_1[_0x4a560b(0x24b)]['logWhiteDomainResponse'](_0x4a560b(0x24a),_0x4a560b(0x207),_0x7ee01e[_0x4a560b(0x266)],_0xe3767f,_0x29b5a1);throw new Error(_0x4a560b(0x1a3)+_0x7ee01e[_0x4a560b(0x266)]);}const _0x302513=await _0x7ee01e[_0x4a560b(0x1e9)]();loggerService_1[_0x4a560b(0x24b)][_0x4a560b(0x1a9)](_0x4a560b(0x24a),_0x4a560b(0x207),_0x7ee01e[_0x4a560b(0x266)],_0x302513,_0x29b5a1);let _0x3e03ad=_0x302513;if(_0x302513[_0x4a560b(0x1b0)]&&_0x302513[_0x4a560b(0x248)]&&_0x302513[_0x4a560b(0x249)]){console[_0x4a560b(0x258)](_0x4a560b(0x218));try{const _0x77399a=this['decryptResponse'](_0x302513['info'],_0x302513[_0x4a560b(0x248)]);_0x3e03ad=JSON['parse'](_0x77399a),console[_0x4a560b(0x258)](_0x4a560b(0x22d)),loggerService_1['loggerService'][_0x4a560b(0x1a9)](_0x4a560b(0x24a),_0x4a560b(0x251),_0x7ee01e[_0x4a560b(0x266)],_0x3e03ad,_0x29b5a1),console['log'](_0x4a560b(0x1c9));}catch(_0x2618f9){console['error']('❌\x20Failed\x20to\x20decrypt\x20status\x20response:',_0x2618f9),loggerService_1[_0x4a560b(0x24b)]['logWhiteDomainError'](_0x4a560b(0x24a),_0x4a560b(0x220),_0x4a560b(0x22c)+_0x2618f9),_0x3e03ad=_0x302513;}}else loggerService_1[_0x4a560b(0x24b)]['logWhiteDomainResponse'](_0x4a560b(0x24a),_0x4a560b(0x251),_0x7ee01e[_0x4a560b(0x266)],_0x3e03ad,_0x29b5a1),console[_0x4a560b(0x258)](_0x4a560b(0x1e6));console['log'](_0x4a560b(0x1e5),{'status':_0x3e03ad[_0x4a560b(0x266)],'final':_0x3e03ad[_0x4a560b(0x1b6)],'payment_id':_0x3e03ad[_0x4a560b(0x257)],'desc':_0x3e03ad['desc']});let _0x5bc345=_0x4a560b(0x1a8);if(_0x3e03ad[_0x4a560b(0x266)]===0x1&&_0x3e03ad['final']===0x1)_0x5bc345=_0x4a560b(0x230);else _0x3e03ad[_0x4a560b(0x266)]===0x0&&_0x3e03ad['final']===0x0?_0x5bc345=_0x4a560b(0x1a8):_0x5bc345='FAILED';return{'status':_0x5bc345,'final':_0x3e03ad[_0x4a560b(0x1b6)]===0x1,'amount':_0x3e03ad['amount'],'currency':_0x3e03ad[_0x4a560b(0x229)],'date_success':_0x3e03ad[_0x4a560b(0x24c)],'description':_0x3e03ad[_0x4a560b(0x1c6)]};}catch(_0x318150){console['error'](_0x4a560b(0x23f),_0x318150),loggerService_1[_0x4a560b(0x24b)]['logWhiteDomainError'](_0x4a560b(0x24a),_0x4a560b(0x254),_0x318150);throw new Error('Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20'+(_0x318150 instanceof Error?_0x318150[_0x4a560b(0x193)]:_0x4a560b(0x202)));}}[a42_0x6c10e2(0x17b)](_0x17e6ae,_0x554e14,_0x38b266){const _0x4f161b=a42_0x6c10e2;console['log']('⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20'+_0x17e6ae+'\x20('+_0x38b266+')'),this['clearStatusTimers'](_0x17e6ae);const _0x3ccfe0=[],_0x286dbf=0x5*0x3c*0x3e8,_0x4dffb6=0x2*0x3c*0x3c*0x3e8,_0xf6309b=Math[_0x4f161b(0x261)](_0x4dffb6/_0x286dbf);console[_0x4f161b(0x258)](_0x4f161b(0x255)+_0xf6309b+_0x4f161b(0x179));for(let _0x317435=0x1;_0x317435<=_0xf6309b;_0x317435++){const _0x46ff58=setTimeout(async()=>{const _0x100acb=_0x4f161b;console['log'](_0x100acb(0x184)+_0x317435+'/'+_0xf6309b+'\x20for\x20payment\x20'+_0x17e6ae);try{const _0x17778b=await this[_0x100acb(0x1fa)](_0x38b266,_0x554e14);console[_0x100acb(0x258)](_0x100acb(0x1e2)+_0x317435+_0x100acb(0x1ad),_0x17778b),_0x17778b[_0x100acb(0x1b6)]&&(console[_0x100acb(0x258)](_0x100acb(0x226)+_0x17e6ae+_0x100acb(0x209)+_0x17778b['status']+_0x100acb(0x1d3)),this[_0x100acb(0x1d7)](_0x17e6ae),await this[_0x100acb(0x23d)](_0x17e6ae,_0x17778b['status'],_0x17778b));}catch(_0x399eb9){console[_0x100acb(0x17c)]('❌\x20Status\x20check\x20#'+_0x317435+_0x100acb(0x23c)+_0x17e6ae+':',_0x399eb9);}},_0x317435*_0x286dbf);_0x3ccfe0[_0x4f161b(0x1b4)](_0x46ff58);}this[_0x4f161b(0x1c4)]['set'](_0x17e6ae,_0x3ccfe0),console[_0x4f161b(0x258)](_0x4f161b(0x242)+_0xf6309b+'\x20status\x20checks\x20for\x20payment\x20'+_0x17e6ae);}[a42_0x6c10e2(0x1d7)](_0x5df20e){const _0x327ed1=a42_0x6c10e2,_0x4a5146=this[_0x327ed1(0x1c4)][_0x327ed1(0x25f)](_0x5df20e);_0x4a5146&&(console[_0x327ed1(0x258)](_0x327ed1(0x260)+_0x4a5146[_0x327ed1(0x18a)]+_0x327ed1(0x23b)+_0x5df20e),_0x4a5146['forEach']((_0x23932a,_0x2c042a)=>{clearTimeout(_0x23932a);}),this[_0x327ed1(0x1c4)][_0x327ed1(0x20d)](_0x5df20e));}async['updatePaymentStatus'](_0x233f02,_0x1765e8,_0x469414){const _0x522661=a42_0x6c10e2;try{const _0x5e7446=(await Promise[_0x522661(0x203)]()[_0x522661(0x217)](()=>__importStar(require(_0x522661(0x1c5)))))['default'],_0x4f5eb4={'status':_0x1765e8['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x522661(0x1d5),'statusChangedAt':new Date()};_0x1765e8===_0x522661(0x230)&&(_0x4f5eb4[_0x522661(0x212)]=new Date()),_0x469414[_0x522661(0x1e0)]&&(_0x4f5eb4[_0x522661(0x1b9)]=_0x522661(0x1b7)+_0x469414[_0x522661(0x1e0)]),await _0x5e7446[_0x522661(0x26f)][_0x522661(0x1df)]({'where':{'id':_0x233f02},'data':_0x4f5eb4}),console[_0x522661(0x258)]('✅\x20Payment\x20'+_0x233f02+_0x522661(0x259)+_0x1765e8),await this[_0x522661(0x268)](_0x233f02,_0x1765e8);}catch(_0x520d54){console['error'](_0x522661(0x1ed)+_0x233f02+':',_0x520d54);}}async[a42_0x6c10e2(0x268)](_0x3e76dc,_0x1119e6){const _0x386044=a42_0x6c10e2;try{const _0xed8917=(await Promise[_0x386044(0x203)]()['then'](()=>__importStar(require('../../config/database'))))[_0x386044(0x1a5)],{telegramBotService:_0x412c62}=await Promise[_0x386044(0x203)]()['then'](()=>__importStar(require(_0x386044(0x1fb)))),_0x4a28f0=await _0xed8917[_0x386044(0x26f)][_0x386044(0x20c)]({'where':{'id':_0x3e76dc},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x4a28f0)return;const _0x297831={'PAID':_0x386044(0x1e1),'FAILED':_0x386044(0x194)},_0x34e9d1=_0x297831[_0x1119e6];_0x34e9d1&&await _0x412c62['sendPaymentNotification'](_0x4a28f0[_0x386044(0x192)],_0x4a28f0,_0x34e9d1),await this[_0x386044(0x1ea)](_0x4a28f0,_0x1119e6);}catch(_0x1bc6da){console[_0x386044(0x17c)]('Failed\x20to\x20send\x20payment\x20notifications:',_0x1bc6da);}}async[a42_0x6c10e2(0x1ea)](_0x10f7ff,_0x2a423d){const _0x3a1422=a42_0x6c10e2,_0x36c4d1=Date[_0x3a1422(0x25e)]();try{const _0x3a97c6=_0x10f7ff[_0x3a1422(0x1c0)],_0x3ce274=_0x3a97c6[_0x3a1422(0x1a0)];if(!_0x3ce274?.['webhookUrl']){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3a97c6['id']);return;}const _0x1a984e=_0x2a423d==='PAID'?'payment.success':_0x3a1422(0x210);let _0x300822=[];if(_0x3ce274[_0x3a1422(0x183)])try{_0x300822=Array[_0x3a1422(0x26e)](_0x3ce274[_0x3a1422(0x183)])?_0x3ce274[_0x3a1422(0x183)]:JSON[_0x3a1422(0x1c2)](_0x3ce274[_0x3a1422(0x183)]);}catch(_0x5d838d){console[_0x3a1422(0x17c)](_0x3a1422(0x237),_0x5d838d),_0x300822=[];}if(!_0x300822[_0x3a1422(0x26c)](_0x1a984e)){console['log'](_0x3a1422(0x211)+_0x1a984e+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3a97c6['id']);return;}const _0x5265c3={'event':_0x1a984e,'payment':{'id':_0x10f7ff['id'],'order_id':_0x10f7ff[_0x3a1422(0x1f5)],'gateway_order_id':_0x10f7ff['gatewayOrderId'],'gateway':_0x3a1422(0x1aa),'amount':_0x10f7ff['amount'],'currency':_0x10f7ff[_0x3a1422(0x229)],'status':_0x2a423d[_0x3a1422(0x1ab)](),'customer_email':_0x10f7ff[_0x3a1422(0x1b3)],'customer_name':_0x10f7ff[_0x3a1422(0x1f6)],'created_at':_0x10f7ff[_0x3a1422(0x1db)],'updated_at':new Date()}},_0x26316c=await fetch(_0x3ce274[_0x3a1422(0x246)],{'method':_0x3a1422(0x1c3),'headers':{'Content-Type':'application/json','User-Agent':_0x3a1422(0x1f4)},'body':JSON[_0x3a1422(0x1d0)](_0x5265c3)}),_0x741356=Date[_0x3a1422(0x25e)]()-_0x36c4d1;loggerService_1[_0x3a1422(0x24b)][_0x3a1422(0x189)](_0x10f7ff['shopId'],_0x3ce274[_0x3a1422(0x246)],_0x1a984e,_0x26316c[_0x3a1422(0x266)],_0x741356,_0x5265c3),console[_0x3a1422(0x258)](_0x3a1422(0x1fd)+_0x3ce274[_0x3a1422(0x246)]+'\x20with\x20status\x20'+_0x26316c['status']+'\x20('+_0x741356+_0x3a1422(0x1d4));}catch(_0x271708){console['error'](_0x3a1422(0x236),_0x271708),loggerService_1['loggerService'][_0x3a1422(0x253)](_0x10f7ff[_0x3a1422(0x192)],_0x10f7ff[_0x3a1422(0x1c0)]?.['settings']?.[_0x3a1422(0x246)]||_0x3a1422(0x1af),'webhook_send',_0x271708,{});}}['maskCardNumber'](_0x1ddfae){const _0x94e694=a42_0x6c10e2,_0x491e40=_0x1ddfae[_0x94e694(0x26a)](/[\s-]/g,'');if(_0x491e40[_0x94e694(0x18a)]<0x4)return _0x94e694(0x24f);return'****\x20****\x20****\x20'+_0x491e40[_0x94e694(0x199)](-0x4);}async[a42_0x6c10e2(0x213)](_0x51bfc7){const _0x1dcb14=a42_0x6c10e2;console[_0x1dcb14(0x258)](_0x1dcb14(0x1f9),_0x51bfc7);let _0x400949=_0x1dcb14(0x1a8);if(_0x51bfc7[_0x1dcb14(0x266)]===0x1&&_0x51bfc7[_0x1dcb14(0x1b6)]===0x1)_0x400949='PAID';else _0x51bfc7[_0x1dcb14(0x266)]===0x0&&_0x51bfc7[_0x1dcb14(0x1b6)]===0x0?_0x400949=_0x1dcb14(0x1a8):_0x400949=_0x1dcb14(0x264);return{'paymentId':_0x51bfc7[_0x1dcb14(0x17d)]||'','status':_0x400949,'amount':_0x51bfc7[_0x1dcb14(0x181)],'currency':_0x51bfc7[_0x1dcb14(0x229)]};}[a42_0x6c10e2(0x24d)](){const _0x141598=a42_0x6c10e2;console['log'](_0x141598(0x24e));const _0x1f1891=this[_0x141598(0x1c4)]['size'];for(const [_0x1f5562]of this['statusCheckTimers']){this['clearStatusTimers'](_0x1f5562);}console[_0x141598(0x258)](_0x141598(0x19e)+_0x1f1891+_0x141598(0x1cb));}}function a42_0x19a5(_0x245703,_0x4798f5){const _0x1a89bb=a42_0x1a89();return a42_0x19a5=function(_0x19a5ca,_0x16873c){_0x19a5ca=_0x19a5ca-0x179;let _0x4289a9=_0x1a89bb[_0x19a5ca];return _0x4289a9;},a42_0x19a5(_0x245703,_0x4798f5);}exports[a42_0x6c10e2(0x1bc)]=MasterCardService;