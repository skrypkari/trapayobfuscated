'use strict';const a42_0x1557ee=a42_0x320f;(function(_0x386d5d,_0x3c4b75){const _0x54ba52=a42_0x320f,_0x4044a8=_0x386d5d();while(!![]){try{const _0x3f37dd=-parseInt(_0x54ba52(0x11d))/0x1+-parseInt(_0x54ba52(0x199))/0x2+-parseInt(_0x54ba52(0xfd))/0x3+parseInt(_0x54ba52(0x169))/0x4+parseInt(_0x54ba52(0x19b))/0x5*(parseInt(_0x54ba52(0xf1))/0x6)+parseInt(_0x54ba52(0x182))/0x7+parseInt(_0x54ba52(0x19d))/0x8;if(_0x3f37dd===_0x3c4b75)break;else _0x4044a8['push'](_0x4044a8['shift']());}catch(_0x4c199f){_0x4044a8['push'](_0x4044a8['shift']());}}}(a42_0x18ce,0xa2d77));var __createBinding=this&&this[a42_0x1557ee(0x137)]||(Object[a42_0x1557ee(0x157)]?function(_0x2d114a,_0x22233c,_0x1fba0c,_0x4c64b2){const _0x5f09b9=a42_0x1557ee;if(_0x4c64b2===undefined)_0x4c64b2=_0x1fba0c;var _0xe8559b=Object[_0x5f09b9(0x1a2)](_0x22233c,_0x1fba0c);(!_0xe8559b||(_0x5f09b9(0x14a)in _0xe8559b?!_0x22233c['__esModule']:_0xe8559b[_0x5f09b9(0x171)]||_0xe8559b[_0x5f09b9(0x155)]))&&(_0xe8559b={'enumerable':!![],'get':function(){return _0x22233c[_0x1fba0c];}}),Object['defineProperty'](_0x2d114a,_0x4c64b2,_0xe8559b);}:function(_0x44dd0b,_0x17738f,_0x50867c,_0x204cfe){if(_0x204cfe===undefined)_0x204cfe=_0x50867c;_0x44dd0b[_0x204cfe]=_0x17738f[_0x50867c];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x2412bd,_0x146776){const _0x8d129=a42_0x1557ee;Object[_0x8d129(0x193)](_0x2412bd,_0x8d129(0x19c),{'enumerable':!![],'value':_0x146776});}:function(_0x38be8d,_0x13f183){_0x38be8d['default']=_0x13f183;}),__importStar=this&&this[a42_0x1557ee(0x149)]||(function(){var _0x1c71a0=function(_0x42e209){const _0x930e45=a42_0x320f;return _0x1c71a0=Object[_0x930e45(0xdf)]||function(_0x2d1b8b){const _0x50c54b=_0x930e45;var _0x2fbc67=[];for(var _0x48e721 in _0x2d1b8b)if(Object[_0x50c54b(0x14b)][_0x50c54b(0x158)][_0x50c54b(0x12f)](_0x2d1b8b,_0x48e721))_0x2fbc67[_0x2fbc67[_0x50c54b(0x197)]]=_0x48e721;return _0x2fbc67;},_0x1c71a0(_0x42e209);};return function(_0x32114f){const _0x5e85fd=a42_0x320f;if(_0x32114f&&_0x32114f[_0x5e85fd(0xe4)])return _0x32114f;var _0x2b3fb6={};if(_0x32114f!=null){for(var _0x4ad064=_0x1c71a0(_0x32114f),_0x2e0eda=0x0;_0x2e0eda<_0x4ad064['length'];_0x2e0eda++)if(_0x4ad064[_0x2e0eda]!==_0x5e85fd(0x19c))__createBinding(_0x2b3fb6,_0x32114f,_0x4ad064[_0x2e0eda]);}return __setModuleDefault(_0x2b3fb6,_0x32114f),_0x2b3fb6;};}()),__importDefault=this&&this[a42_0x1557ee(0x128)]||function(_0x57b450){const _0x48b3be=a42_0x1557ee;return _0x57b450&&_0x57b450[_0x48b3be(0xe4)]?_0x57b450:{'default':_0x57b450};};Object[a42_0x1557ee(0x193)](exports,a42_0x1557ee(0xe4),{'value':!![]}),exports[a42_0x1557ee(0x11f)]=void 0x0;const crypto_1=__importDefault(require(a42_0x1557ee(0x152))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require('path')),loggerService_1=require('../loggerService');function a42_0x18ce(){const _0x56cda8=['isArray','Failed\x20to\x20decrypt\x20response','webhook_send','Order\x20ID:','settings','\x20status\x20checks\x20for\x20payment\x20','Error\x20parsing\x20webhook\x20events:','\x20status\x20updated\x20to\x20','set','Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20','keys','-----BEGIN','FAILED','expire_year','gatewayOrderId','customerEmail','defineProperty','now','🔐\x20AES\x20key\x20length:','logWhiteDomainRequest','length','🧹\x20Clearing\x20','1342900ZkVnPw','Failed\x20to\x20decrypt\x20response\x20via\x20PHP','4682605UwVCpI','default','1986848JmJLje','\x20\x20\x20-\x20info\x20length:','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','trim','merchantPointId','getOwnPropertyDescriptor','sendShopWebhook','📝\x20Data\x20length:','\x20\x20\x20-\x20lang:\x20en','🔐\x20AES\x20key\x20and\x20IV\x20generated','publicEncrypt','===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===','info','paid','HTTP\x20error!\x20status:\x20','webhookUrl','decryptResponse','processCardPayment','3DS\x20URL:','SHA256','decryptAES','Public\x20key\x20file\x20not\x20found:\x20','from','📝\x20Final\x20request\x20structure:','📊\x20Status\x20check\x20result:','log','payment_id','MasterCard\x20status\x20check\x20error:','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','adminNotes','logWhiteDomainError','📝\x20Encrypted\x20data\x20length:','❌\x20RSA\x20signing\x20failed:','stringify','PHP\x20decryptor\x20error','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20','\x20failed\x20for\x20payment\x20','❌\x20MasterCard\x20key\x20validation\x20failed:','TesSoft\x20Payment\x20System/1.0','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Unknown\x20error','../../config/database','existsSync','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','/status','🔐\x20Data\x20encrypted\x20with\x20AES','/charge','charge','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','encryptAES','getOwnPropertyNames','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','system','sendPaymentNotifications','status','__esModule','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','createDecipheriv','substring','floor','order_id','message','mastercard','updatePaymentStatus',',\x20body:\x20','privateKeyPath','includes','POST','6jjiCIv','logShopWebhookSent','description','signRSA','✅\x20Status\x20response\x20decrypted\x20successfully','shop','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','generateAESKey','/charge_decrypt','❌\x20PHP\x20decryptor\x20request\x20failed:','publicKeyPath','Failed\x20to\x20send\x20MasterCard\x20webhook:','2644257cHNKfY','3ds_url','HTTP\x20','/status_raw','base64','Error\x20details:','key','processWebhook','sign','maskCardNumber','📝\x20Data\x20to\x20sign\x20length:','final','Private\x20key\x20file\x20not\x20found:\x20','✅\x20Payment\x20successful','amount','🛑\x20Stopped\x20','MasterCard:\x20','findUnique','expire_month','utf8','🔐\x20RSA\x20signing\x20successful','private.pem','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','none','\x20status\x20timers\x20for\x20payment\x20','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','Decryption\x20failed:\x20','readFileSync','desc','⏰\x20Will\x20check\x20status\x20','...','🔐\x20Private\x20key\x20length:\x20','834445WVlgcc','🔐\x20Public\x20key\x20path:','MasterCardService','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','then','💾\x20Payment\x20data\x20prepared','update','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','toUpperCase','createSign','Card\x20Number:','__importDefault','🔍\x20MasterCard\x20status\x20check\x20#','),\x20stopping\x20status\x20checks','/charge_raw','\x20is\x20final\x20(','psp_public.pem','📝\x20Signature\x20length:','call','size','decryptResponsePhp','\x20characters','constants','ms)','loggerService','Status:','__createBinding','../telegramBotService','Status\x20decryption\x20failed:\x20','logWhiteDomainResponse','****','validateKeyFiles','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','webhookEvents','cvv','unknown','\x20not\x20enabled\x20for\x20shop\x20','privateDecrypt','scheduleStatusChecks','clearStatusTimers','join','last_name','PAID','📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','__importStar','get','prototype','payment','❌\x20RSA\x20encryption\x20failed:','🔐\x20Data\x20signed\x20with\x20RSA','\x20\x20\x20-\x20key\x20length:','customerName','✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)','crypto','PENDING','logShopWebhookError','configurable','error','create','hasOwnProperty','createdAt','RSA_PKCS1_PADDING','✅\x20Scheduled\x20','toString','/status_decrypted','encryptRSA','statusCheckTimers','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','forEach','currency','Payment\x20ID:','application/json','cwd','\x20\x20\x20-\x20method:\x20charge','sendPaymentNotification','shopId','4148940LFLKtm','🔐\x20Private\x20key\x20path:','apiUrl','aes-256-ctr','✅\x20Payment\x20','payment.success','❌\x20Data\x20being\x20signed:','HTTP\x20Status:','writable','parse','Failed\x20to\x20send\x20payment\x20notifications:','toLowerCase','💳\x20MasterCard\x20service\x20initialized','checkPaymentStatus','text','Return\x20URL:','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','json','randomBytes','❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):','/charge_decrypted','\x20\x20\x20-\x20sign\x20length:','/status_decrypt','-----END','5825407BPfiLm'];a42_0x18ce=function(){return _0x56cda8;};return a42_0x18ce();}class MasterCardService{constructor(){const _0x39da4c=a42_0x1557ee;this[_0x39da4c(0x15f)]=new Map(),this[_0x39da4c(0x16b)]='https://api.paydmeth.com/api',this['merchantPointId']=0x67c,this[_0x39da4c(0xee)]=path_1[_0x39da4c(0x19c)][_0x39da4c(0x145)](process['cwd'](),_0x39da4c(0x18d),_0x39da4c(0x112)),this[_0x39da4c(0xfb)]=path_1[_0x39da4c(0x19c)][_0x39da4c(0x145)](process[_0x39da4c(0x165)](),_0x39da4c(0x18d),_0x39da4c(0x12d)),console[_0x39da4c(0xc4)](_0x39da4c(0x175)),console['log'](_0x39da4c(0x16a),this['privateKeyPath']),console[_0x39da4c(0xc4)](_0x39da4c(0x11e),this[_0x39da4c(0xfb)]),this[_0x39da4c(0x13c)]();}[a42_0x1557ee(0x13c)](){const _0x4eeea6=a42_0x1557ee;try{if(!fs_1[_0x4eeea6(0x19c)][_0x4eeea6(0xd7)](this[_0x4eeea6(0xee)]))throw new Error(_0x4eeea6(0x109)+this[_0x4eeea6(0xee)]);if(!fs_1['default']['existsSync'](this[_0x4eeea6(0xfb)]))throw new Error(_0x4eeea6(0xc0)+this[_0x4eeea6(0xfb)]);const _0x4651d8=fs_1[_0x4eeea6(0x19c)][_0x4eeea6(0x118)](this[_0x4eeea6(0xee)],_0x4eeea6(0x110))['trim'](),_0x3fa62d=fs_1[_0x4eeea6(0x19c)]['readFileSync'](this['publicKeyPath'],_0x4eeea6(0x110))[_0x4eeea6(0x1a0)]();if(!_0x4651d8[_0x4eeea6(0xef)](_0x4eeea6(0x18e))||!_0x4651d8[_0x4eeea6(0xef)](_0x4eeea6(0x181)))throw new Error(_0x4eeea6(0xf7));if(!_0x3fa62d[_0x4eeea6(0xef)](_0x4eeea6(0x18e))||!_0x3fa62d[_0x4eeea6(0xef)](_0x4eeea6(0x181)))throw new Error(_0x4eeea6(0xc7));console[_0x4eeea6(0xc4)](_0x4eeea6(0x19f)),console[_0x4eeea6(0xc4)](_0x4eeea6(0x11c)+_0x4651d8[_0x4eeea6(0x197)]+_0x4eeea6(0x132)),console[_0x4eeea6(0xc4)]('🔐\x20Public\x20key\x20length:\x20'+_0x3fa62d[_0x4eeea6(0x197)]+_0x4eeea6(0x132));}catch(_0x3d4612){console[_0x4eeea6(0x156)](_0x4eeea6(0xd2),_0x3d4612);throw _0x3d4612;}}['generateAESKey'](){const _0x306ed6=a42_0x1557ee,_0x2216ac=crypto_1[_0x306ed6(0x19c)][_0x306ed6(0x17c)](0x20),_0x5b0afc=crypto_1[_0x306ed6(0x19c)][_0x306ed6(0x17c)](0x10);return{'key':_0x2216ac,'iv':_0x5b0afc};}[a42_0x1557ee(0xde)](_0x5af51a,_0x14cc35,_0x1bcfad){const _0x1b1e08=a42_0x1557ee,_0x454e15=crypto_1[_0x1b1e08(0x19c)]['createCipheriv'](_0x1b1e08(0x16c),_0x14cc35,_0x1bcfad);let _0x314c49=_0x454e15[_0x1b1e08(0x123)](_0x5af51a,_0x1b1e08(0x110),_0x1b1e08(0x101));return _0x314c49+=_0x454e15[_0x1b1e08(0x108)](_0x1b1e08(0x101)),_0x314c49;}[a42_0x1557ee(0x15e)](_0x562b11,_0x576020){const _0x4f3777=a42_0x1557ee;try{const _0x5c5ad0=fs_1[_0x4f3777(0x19c)][_0x4f3777(0x118)](this[_0x4f3777(0xfb)],'utf8')[_0x4f3777(0x1a0)](),_0x329458={'iv':_0x576020[_0x4f3777(0x15c)](_0x4f3777(0x101)),'key':_0x562b11[_0x4f3777(0x15c)](_0x4f3777(0x101))},_0x43d785=JSON[_0x4f3777(0xcc)](_0x329458);console[_0x4f3777(0xc4)]('🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:',_0x43d785['length']);const _0x2125e8=crypto_1[_0x4f3777(0x19c)][_0x4f3777(0x1a7)]({'key':_0x5c5ad0,'padding':crypto_1[_0x4f3777(0x19c)][_0x4f3777(0x133)][_0x4f3777(0x15a)]},Buffer[_0x4f3777(0xc1)](_0x43d785));return console[_0x4f3777(0xc4)](_0x4f3777(0x113),_0x2125e8[_0x4f3777(0x197)]),_0x2125e8[_0x4f3777(0x15c)]('base64');}catch(_0x2432d8){console[_0x4f3777(0x156)](_0x4f3777(0x14d),_0x2432d8);throw new Error(_0x4f3777(0xe0));}}[a42_0x1557ee(0xf4)](_0x1d53fa){const _0x17caf7=a42_0x1557ee;try{const _0x2d2eab=fs_1['default'][_0x17caf7(0x118)](this[_0x17caf7(0xee)],_0x17caf7(0x110))['trim'](),_0x68a4f8=crypto_1['default'][_0x17caf7(0x126)](_0x17caf7(0x1b0));_0x68a4f8[_0x17caf7(0x123)](_0x1d53fa),_0x68a4f8['end']();const _0x43b601=_0x68a4f8[_0x17caf7(0x105)](_0x2d2eab,'base64');return console[_0x17caf7(0xc4)](_0x17caf7(0x111)),console[_0x17caf7(0xc4)](_0x17caf7(0x107),_0x1d53fa[_0x17caf7(0x197)]),console[_0x17caf7(0xc4)](_0x17caf7(0x12e),_0x43b601[_0x17caf7(0x197)]),_0x43b601;}catch(_0x199fe6){console[_0x17caf7(0x156)](_0x17caf7(0xcb),_0x199fe6),console[_0x17caf7(0x156)](_0x17caf7(0x16f),_0x1d53fa[_0x17caf7(0xe7)](0x0,0xc8)+_0x17caf7(0x11b));throw new Error(_0x17caf7(0xcf));}}['decryptAES'](_0x2c0826,_0x172b8a,_0x348784){const _0x39c76e=a42_0x1557ee,_0x5d6d62=crypto_1[_0x39c76e(0x19c)][_0x39c76e(0xe6)](_0x39c76e(0x16c),_0x172b8a,_0x348784);let _0x34651b=_0x5d6d62[_0x39c76e(0x123)](_0x2c0826,_0x39c76e(0x101),_0x39c76e(0x110));return _0x34651b+=_0x5d6d62[_0x39c76e(0x108)](_0x39c76e(0x110)),_0x34651b;}async[a42_0x1557ee(0x131)](_0x4e63e7,_0x57eaa5){const _0x26bc99=a42_0x1557ee;try{const _0x19d34f=await fetch('https://api2.trapay.uk/decrypt.php',{'method':_0x26bc99(0xf0),'headers':{'Content-Type':_0x26bc99(0x164)},'body':JSON[_0x26bc99(0xcc)]({'info':_0x4e63e7,'key':_0x57eaa5})});if(!_0x19d34f['ok'])throw new Error(_0x26bc99(0xcd));return await _0x19d34f[_0x26bc99(0x177)]();}catch(_0x1be7ff){console[_0x26bc99(0x156)](_0x26bc99(0xfa),_0x1be7ff);throw new Error(_0x26bc99(0x19a));}}[a42_0x1557ee(0x1ad)](_0x3ccd9d,_0x5c55d1){const _0x3ff466=a42_0x1557ee;try{const _0x45b467=fs_1[_0x3ff466(0x19c)][_0x3ff466(0x118)](this[_0x3ff466(0xee)],_0x3ff466(0x110))[_0x3ff466(0x1a0)](),_0x120e4b=crypto_1['default'][_0x3ff466(0x142)](_0x45b467,Buffer[_0x3ff466(0xc1)](_0x5c55d1,_0x3ff466(0x101))),_0x4cc28b=JSON[_0x3ff466(0x172)](_0x120e4b[_0x3ff466(0x15c)]()),_0x5c66b2=Buffer[_0x3ff466(0xc1)](_0x4cc28b[_0x3ff466(0x103)],_0x3ff466(0x101)),_0x5f3a07=Buffer['from'](_0x4cc28b['iv'],_0x3ff466(0x101));return this[_0x3ff466(0x1b1)](_0x3ccd9d,_0x5c66b2,_0x5f3a07);}catch(_0x118de1){throw new Error(_0x3ff466(0x184));}}async[a42_0x1557ee(0x1ae)](_0x3444fd){const _0xedbfef=a42_0x1557ee,{paymentId:_0x4df728,orderId:_0x5d51f4,amount:_0x31edc8,currency:_0x4bd688,cardData:_0x1f8ac5,resultUrl:_0x58a255,returnUrl:_0x114314,cardHolder:_0x342fbe,browser:_0x73563c}=_0x3444fd;console['log']('===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20==='),console[_0xedbfef(0xc4)](_0xedbfef(0x163),_0x4df728),console[_0xedbfef(0xc4)](_0xedbfef(0x186),_0x5d51f4),console[_0xedbfef(0xc4)]('Amount:',_0x31edc8,_0x4bd688),console[_0xedbfef(0xc4)](_0xedbfef(0x127),this[_0xedbfef(0x106)](_0x1f8ac5['number'])),console[_0xedbfef(0xc4)]('Card\x20Holder:',_0x342fbe['first_name']+'\x20'+_0x342fbe[_0xedbfef(0x146)]),console[_0xedbfef(0xc4)](_0xedbfef(0x178),_0x114314),console[_0xedbfef(0xc4)]('Result\x20URL:',_0x58a255);const _0x65e831={'amount':_0x31edc8,'currency':_0x4bd688['toUpperCase'](),'order_id':_0x5d51f4,'result_url':_0x58a255,'return_url':_0x114314,'card':{'number':_0x1f8ac5['number'],'expire_month':_0x1f8ac5[_0xedbfef(0x10f)],'expire_year':_0x1f8ac5[_0xedbfef(0x190)],'cvv':_0x1f8ac5[_0xedbfef(0x13f)]},'card_holder':_0x342fbe,'browser':_0x73563c},_0x5bdfd2=JSON[_0xedbfef(0xcc)](_0x65e831);console['log'](_0xedbfef(0x122)),console[_0xedbfef(0xc4)](_0xedbfef(0x124)),console[_0xedbfef(0xc4)](_0x5bdfd2),console[_0xedbfef(0xc4)](_0xedbfef(0x1a4),_0x5bdfd2[_0xedbfef(0x197)]);try{const {key:_0x308259,iv:_0x305546}=this[_0xedbfef(0xf8)]();console[_0xedbfef(0xc4)](_0xedbfef(0x1a6)),console[_0xedbfef(0xc4)](_0xedbfef(0x195),_0x308259['length']),console[_0xedbfef(0xc4)]('🔐\x20AES\x20IV\x20length:',_0x305546[_0xedbfef(0x197)]);const _0x4ea5c4=this[_0xedbfef(0xde)](_0x5bdfd2,_0x308259,_0x305546);console[_0xedbfef(0xc4)](_0xedbfef(0xda)),console[_0xedbfef(0xc4)](_0xedbfef(0xca),_0x4ea5c4['length']);const _0x5bd017=this['encryptRSA'](_0x308259,_0x305546);console[_0xedbfef(0xc4)]('🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA'),console[_0xedbfef(0xc4)]('📝\x20Encrypted\x20key\x20length:',_0x5bd017[_0xedbfef(0x197)]);const _0x3c5217=this[_0xedbfef(0xf4)](_0x5bdfd2);console[_0xedbfef(0xc4)](_0xedbfef(0x14e)),console[_0xedbfef(0xc4)](_0xedbfef(0x12e),_0x3c5217['length']);const _0x699f84={'merchant_point_id':this[_0xedbfef(0x1a1)],'method':_0xedbfef(0xdc),'info':_0x4ea5c4,'key':_0x5bd017,'sign':_0x3c5217,'lang':'en'};console[_0xedbfef(0xc4)]('📤\x20Sending\x20request\x20to\x20MasterCard\x20API...'),console['log'](_0xedbfef(0xc2)),console['log']('\x20\x20\x20-\x20merchant_point_id:',this[_0xedbfef(0x1a1)]),console['log'](_0xedbfef(0x166)),console['log'](_0xedbfef(0x19e),_0x4ea5c4[_0xedbfef(0x197)]),console[_0xedbfef(0xc4)](_0xedbfef(0x14f),_0x5bd017[_0xedbfef(0x197)]),console[_0xedbfef(0xc4)](_0xedbfef(0x17f),_0x3c5217[_0xedbfef(0x197)]),console[_0xedbfef(0xc4)](_0xedbfef(0x1a5)),loggerService_1[_0xedbfef(0x135)][_0xedbfef(0x196)]('mastercard','/charge','POST',{'merchant_point_id':this['merchantPointId'],'method':_0xedbfef(0xdc),'lang':'en'});const _0x10ff9d=Date[_0xedbfef(0x194)](),_0x29207b=await fetch(this[_0xedbfef(0x16b)],{'method':_0xedbfef(0xf0),'headers':{'Content-Type':'application/json','Accept':'application/json','User-Agent':_0xedbfef(0xd3)},'body':JSON[_0xedbfef(0xcc)](_0x699f84)}),_0x24ed8c=Date[_0xedbfef(0x194)]()-_0x10ff9d;console[_0xedbfef(0xc4)](_0xedbfef(0x179)),console[_0xedbfef(0xc4)](_0xedbfef(0x136),_0x29207b[_0xedbfef(0xe3)]),console[_0xedbfef(0xc4)]('Response\x20Time:',_0x24ed8c+'ms');if(!_0x29207b['ok']){const _0x2fc2fd=await _0x29207b['text']();console[_0xedbfef(0x156)](_0xedbfef(0x170),_0x29207b[_0xedbfef(0xe3)]),console[_0xedbfef(0x156)]('Response\x20Body:',_0x2fc2fd),loggerService_1['loggerService'][_0xedbfef(0x13a)](_0xedbfef(0xeb),'/charge_raw',_0x29207b[_0xedbfef(0xe3)],_0x2fc2fd,_0x24ed8c),loggerService_1[_0xedbfef(0x135)][_0xedbfef(0xc9)]('mastercard','/charge',_0xedbfef(0xff)+_0x29207b['status']+':\x20'+_0x2fc2fd);throw new Error(_0xedbfef(0x1ab)+_0x29207b[_0xedbfef(0xe3)]+_0xedbfef(0xed)+_0x2fc2fd);}const _0x33c1b0=await _0x29207b[_0xedbfef(0x17b)]();loggerService_1[_0xedbfef(0x135)][_0xedbfef(0x13a)](_0xedbfef(0xeb),_0xedbfef(0x12b),_0x29207b[_0xedbfef(0xe3)],_0x33c1b0,_0x24ed8c),console[_0xedbfef(0xc4)](_0xedbfef(0x1a8));let _0x734f54=_0x33c1b0;if(_0x33c1b0[_0xedbfef(0x1a9)]&&_0x33c1b0['key']&&_0x33c1b0[_0xedbfef(0x105)]){console[_0xedbfef(0xc4)](_0xedbfef(0x120));try{const _0x3f13a3=await this[_0xedbfef(0x131)](_0x33c1b0[_0xedbfef(0x1a9)],_0x33c1b0[_0xedbfef(0x103)]);_0x734f54=JSON[_0xedbfef(0x172)](_0x3f13a3),console[_0xedbfef(0xc4)](_0xedbfef(0x151)),loggerService_1['loggerService'][_0xedbfef(0x13a)]('mastercard',_0xedbfef(0x17e),_0x29207b[_0xedbfef(0xe3)],_0x734f54,_0x24ed8c),console[_0xedbfef(0xc4)](_0xedbfef(0x160));}catch(_0x4b35dd){console['error'](_0xedbfef(0x17d),_0x4b35dd),loggerService_1['loggerService'][_0xedbfef(0xc9)](_0xedbfef(0xeb),_0xedbfef(0xf9),_0xedbfef(0x117)+_0x4b35dd),_0x734f54=_0x33c1b0;}}else loggerService_1['loggerService'][_0xedbfef(0x13a)]('mastercard','/charge_decrypted',_0x29207b[_0xedbfef(0xe3)],_0x734f54,_0x24ed8c),console['log']('📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted');console[_0xedbfef(0xc4)]('Status:',_0x734f54[_0xedbfef(0xe3)]),console[_0xedbfef(0xc4)]('Final:',_0x734f54[_0xedbfef(0x108)]),console['log'](_0xedbfef(0x163),_0x734f54['payment_id']),console['log'](_0xedbfef(0x1af),_0x734f54[_0xedbfef(0xfe)]||_0xedbfef(0x114));if(_0x734f54['status']===0x64&&_0x734f54[_0xedbfef(0x108)]===0x1)return console[_0xedbfef(0xc4)](_0xedbfef(0x10a)),{'gateway_payment_id':_0x734f54[_0xedbfef(0xc5)]?.[_0xedbfef(0x15c)](),'payment_url':_0x114314,'requires_3ds':![],'status':_0xedbfef(0x147),'final':!![]};if(_0x734f54[_0xedbfef(0xfe)])return console[_0xedbfef(0xc4)]('🔐\x203DS\x20verification\x20required'),this[_0xedbfef(0x143)](_0x4df728,_0x5d51f4,_0x734f54['payment_id']?.[_0xedbfef(0x15c)]()||_0x5d51f4),{'gateway_payment_id':_0x734f54[_0xedbfef(0xc5)]?.[_0xedbfef(0x15c)](),'payment_url':_0x734f54[_0xedbfef(0xfe)],'requires_3ds':!![],'threeds_url':_0x734f54[_0xedbfef(0xfe)],'status':_0xedbfef(0x153),'final':![]};let _0x1fe17c=_0x734f54[_0xedbfef(0x119)]||_0x734f54[_0xedbfef(0xea)]||_0xedbfef(0xd5),_0x38b33b=_0x734f54[_0xedbfef(0xe3)],_0x4e5573=_0x734f54['final'];return console[_0xedbfef(0xc4)]('❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20'+_0x38b33b+',\x20Final:\x20'+_0x4e5573+',\x20Desc:\x20'+_0x1fe17c),{'gateway_payment_id':_0x734f54[_0xedbfef(0xc5)]?.[_0xedbfef(0x15c)](),'payment_url':_0x114314,'requires_3ds':![],'status':_0xedbfef(0x18f),'final':!![]};}catch(_0x266f51){console[_0xedbfef(0x156)](_0xedbfef(0x116)),console[_0xedbfef(0x156)](_0xedbfef(0x102),_0x266f51),loggerService_1['loggerService']['logWhiteDomainError'](_0xedbfef(0xeb),_0xedbfef(0xdb),_0x266f51);throw new Error(_0xedbfef(0xce)+(_0x266f51 instanceof Error?_0x266f51[_0xedbfef(0xea)]:_0xedbfef(0xd5)));}}async[a42_0x1557ee(0x176)](_0x31a6fc,_0x3c7848){const _0x4c393f=a42_0x1557ee;console[_0x4c393f(0xc4)](_0x4c393f(0x13d)+_0x31a6fc+'\x20('+_0x3c7848+')');try{const _0x267360={'payment_id':_0x31a6fc,'order_id':_0x3c7848},_0x1fd0a0=JSON['stringify'](_0x267360),{key:_0x102f03,iv:_0x3cb865}=this[_0x4c393f(0xf8)](),_0x219558=this['encryptAES'](_0x1fd0a0,_0x102f03,_0x3cb865),_0x82514c=this[_0x4c393f(0x15e)](_0x102f03,_0x3cb865),_0x3cf5af=this['signRSA'](_0x1fd0a0),_0x1790ff={'merchant_point_id':this[_0x4c393f(0x1a1)],'method':_0x4c393f(0xe3),'info':_0x219558,'key':_0x82514c,'sign':_0x3cf5af,'lang':'en'};loggerService_1[_0x4c393f(0x135)][_0x4c393f(0x196)](_0x4c393f(0xeb),'/status',_0x4c393f(0xf0),{'merchant_point_id':this[_0x4c393f(0x1a1)],'method':'status','lang':'en'});const _0x998003=Date[_0x4c393f(0x194)](),_0x363fdf=await fetch(this['apiUrl'],{'method':_0x4c393f(0xf0),'headers':{'Content-Type':'application/json','Accept':_0x4c393f(0x164),'User-Agent':_0x4c393f(0xd3)},'body':JSON[_0x4c393f(0xcc)](_0x1790ff)}),_0x3b04e0=Date['now']()-_0x998003;if(!_0x363fdf['ok']){const _0x46079f=await _0x363fdf['text']();loggerService_1[_0x4c393f(0x135)][_0x4c393f(0x13a)]('mastercard',_0x4c393f(0x100),_0x363fdf[_0x4c393f(0xe3)],_0x46079f,_0x3b04e0);throw new Error(_0x4c393f(0x1ab)+_0x363fdf[_0x4c393f(0xe3)]);}const _0x2ac23d=await _0x363fdf[_0x4c393f(0x17b)]();loggerService_1[_0x4c393f(0x135)][_0x4c393f(0x13a)](_0x4c393f(0xeb),'/status_raw',_0x363fdf[_0x4c393f(0xe3)],_0x2ac23d,_0x3b04e0);let _0x37b767=_0x2ac23d;if(_0x2ac23d[_0x4c393f(0x1a9)]&&_0x2ac23d['key']&&_0x2ac23d[_0x4c393f(0x105)]){console['log']('🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...');try{const _0x368c99=this[_0x4c393f(0x1ad)](_0x2ac23d[_0x4c393f(0x1a9)],_0x2ac23d[_0x4c393f(0x103)]);_0x37b767=JSON[_0x4c393f(0x172)](_0x368c99),console[_0x4c393f(0xc4)](_0x4c393f(0xf5)),loggerService_1[_0x4c393f(0x135)][_0x4c393f(0x13a)]('mastercard',_0x4c393f(0x15d),_0x363fdf[_0x4c393f(0xe3)],_0x37b767,_0x3b04e0),console[_0x4c393f(0xc4)](_0x4c393f(0xe5));}catch(_0x1c099b){console[_0x4c393f(0x156)]('❌\x20Failed\x20to\x20decrypt\x20status\x20response:',_0x1c099b),loggerService_1[_0x4c393f(0x135)]['logWhiteDomainError'](_0x4c393f(0xeb),_0x4c393f(0x180),_0x4c393f(0x139)+_0x1c099b),_0x37b767=_0x2ac23d;}}else loggerService_1[_0x4c393f(0x135)][_0x4c393f(0x13a)]('mastercard',_0x4c393f(0x15d),_0x363fdf['status'],_0x37b767,_0x3b04e0),console[_0x4c393f(0xc4)](_0x4c393f(0x148));console[_0x4c393f(0xc4)](_0x4c393f(0xc3),{'status':_0x37b767['status'],'final':_0x37b767[_0x4c393f(0x108)],'payment_id':_0x37b767[_0x4c393f(0xc5)],'desc':_0x37b767['desc']});let _0x4ffec5=_0x4c393f(0x153);if(_0x37b767[_0x4c393f(0xe3)]===0x1&&_0x37b767['final']===0x1)_0x4ffec5='PAID';else _0x37b767[_0x4c393f(0xe3)]===0x0&&_0x37b767['final']===0x0?_0x4ffec5=_0x4c393f(0x153):_0x4ffec5=_0x4c393f(0x18f);return{'status':_0x4ffec5,'final':_0x37b767[_0x4c393f(0x108)]===0x1,'amount':_0x37b767['amount'],'currency':_0x37b767[_0x4c393f(0x162)],'date_success':_0x37b767['date_success'],'description':_0x37b767[_0x4c393f(0x119)]};}catch(_0x1136a0){console[_0x4c393f(0x156)](_0x4c393f(0xc6),_0x1136a0),loggerService_1[_0x4c393f(0x135)][_0x4c393f(0xc9)](_0x4c393f(0xeb),_0x4c393f(0xd9),_0x1136a0);throw new Error(_0x4c393f(0x18c)+(_0x1136a0 instanceof Error?_0x1136a0[_0x4c393f(0xea)]:_0x4c393f(0xd5)));}}[a42_0x1557ee(0x143)](_0x2b8f99,_0x1beb67,_0x1f0450){const _0x5c3e3d=a42_0x1557ee;console[_0x5c3e3d(0xc4)]('⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20'+_0x2b8f99+'\x20('+_0x1f0450+')'),this[_0x5c3e3d(0x144)](_0x2b8f99);const _0x2d2d4e=[],_0x2595ed=0x5*0x3c*0x3e8,_0x560422=0x2*0x3c*0x3c*0x3e8,_0x44ca48=Math[_0x5c3e3d(0xe8)](_0x560422/_0x2595ed);console[_0x5c3e3d(0xc4)](_0x5c3e3d(0x11a)+_0x44ca48+_0x5c3e3d(0x17a));for(let _0x7d01dc=0x1;_0x7d01dc<=_0x44ca48;_0x7d01dc++){const _0x2502a3=setTimeout(async()=>{const _0x523c6d=_0x5c3e3d;console[_0x523c6d(0xc4)](_0x523c6d(0x129)+_0x7d01dc+'/'+_0x44ca48+'\x20for\x20payment\x20'+_0x2b8f99);try{const _0x5aa0fe=await this[_0x523c6d(0x176)](_0x1f0450,_0x1beb67);console[_0x523c6d(0xc4)]('📊\x20Status\x20check\x20#'+_0x7d01dc+'\x20result:',_0x5aa0fe),_0x5aa0fe[_0x523c6d(0x108)]&&(console['log'](_0x523c6d(0x16d)+_0x2b8f99+_0x523c6d(0x12c)+_0x5aa0fe[_0x523c6d(0xe3)]+_0x523c6d(0x12a)),this[_0x523c6d(0x144)](_0x2b8f99),await this[_0x523c6d(0xec)](_0x2b8f99,_0x5aa0fe[_0x523c6d(0xe3)],_0x5aa0fe));}catch(_0x3a8b53){console[_0x523c6d(0x156)]('❌\x20Status\x20check\x20#'+_0x7d01dc+_0x523c6d(0xd1)+_0x2b8f99+':',_0x3a8b53);}},_0x7d01dc*_0x2595ed);_0x2d2d4e['push'](_0x2502a3);}this[_0x5c3e3d(0x15f)][_0x5c3e3d(0x18b)](_0x2b8f99,_0x2d2d4e),console[_0x5c3e3d(0xc4)](_0x5c3e3d(0x15b)+_0x44ca48+_0x5c3e3d(0x188)+_0x2b8f99);}[a42_0x1557ee(0x144)](_0x314fe6){const _0x23bd2d=a42_0x1557ee,_0x5b35b3=this[_0x23bd2d(0x15f)][_0x23bd2d(0x14a)](_0x314fe6);_0x5b35b3&&(console[_0x23bd2d(0xc4)](_0x23bd2d(0x198)+_0x5b35b3[_0x23bd2d(0x197)]+_0x23bd2d(0x115)+_0x314fe6),_0x5b35b3[_0x23bd2d(0x161)]((_0x34353c,_0x105abf)=>{clearTimeout(_0x34353c);}),this[_0x23bd2d(0x15f)]['delete'](_0x314fe6));}async['updatePaymentStatus'](_0x43a9f5,_0x2c5b2c,_0x1270db){const _0xda68fe=a42_0x1557ee;try{const _0x889a6=(await Promise['resolve']()[_0xda68fe(0x121)](()=>__importStar(require(_0xda68fe(0xd6)))))['default'],_0x417941={'status':_0x2c5b2c[_0xda68fe(0x125)](),'updatedAt':new Date(),'statusChangedBy':_0xda68fe(0xe1),'statusChangedAt':new Date()};_0x2c5b2c==='PAID'&&(_0x417941['paidAt']=new Date()),_0x1270db[_0xda68fe(0xf3)]&&(_0x417941[_0xda68fe(0xc8)]=_0xda68fe(0x10d)+_0x1270db[_0xda68fe(0xf3)]),await _0x889a6['payment']['update']({'where':{'id':_0x43a9f5},'data':_0x417941}),console[_0xda68fe(0xc4)](_0xda68fe(0x16d)+_0x43a9f5+_0xda68fe(0x18a)+_0x2c5b2c),await this[_0xda68fe(0xe2)](_0x43a9f5,_0x2c5b2c);}catch(_0x47872d){console['error'](_0xda68fe(0xd0)+_0x43a9f5+':',_0x47872d);}}async[a42_0x1557ee(0xe2)](_0x4bb161,_0x410ef6){const _0x554f87=a42_0x1557ee;try{const _0x28c886=(await Promise['resolve']()[_0x554f87(0x121)](()=>__importStar(require(_0x554f87(0xd6)))))['default'],{telegramBotService:_0xb25840}=await Promise['resolve']()[_0x554f87(0x121)](()=>__importStar(require(_0x554f87(0x138)))),_0x2e03bf=await _0x28c886[_0x554f87(0x14c)][_0x554f87(0x10e)]({'where':{'id':_0x4bb161},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x2e03bf)return;const _0x10d343={'PAID':_0x554f87(0x1aa),'FAILED':'failed'},_0x2e7307=_0x10d343[_0x410ef6];_0x2e7307&&await _0xb25840[_0x554f87(0x167)](_0x2e03bf[_0x554f87(0x168)],_0x2e03bf,_0x2e7307),await this['sendShopWebhook'](_0x2e03bf,_0x410ef6);}catch(_0x31e224){console['error'](_0x554f87(0x173),_0x31e224);}}async[a42_0x1557ee(0x1a3)](_0xe9175,_0x4b2bc1){const _0x4f96b6=a42_0x1557ee,_0x3e12a5=Date[_0x4f96b6(0x194)]();try{const _0x1baaf6=_0xe9175[_0x4f96b6(0xf6)],_0x3caf17=_0x1baaf6[_0x4f96b6(0x187)];if(!_0x3caf17?.[_0x4f96b6(0x1ac)]){console[_0x4f96b6(0xc4)](_0x4f96b6(0xdd)+_0x1baaf6['id']);return;}const _0x20abb7=_0x4b2bc1===_0x4f96b6(0x147)?_0x4f96b6(0x16e):'payment.failed';let _0x2517a0=[];if(_0x3caf17[_0x4f96b6(0x13e)])try{_0x2517a0=Array[_0x4f96b6(0x183)](_0x3caf17[_0x4f96b6(0x13e)])?_0x3caf17[_0x4f96b6(0x13e)]:JSON[_0x4f96b6(0x172)](_0x3caf17[_0x4f96b6(0x13e)]);}catch(_0x312d8b){console[_0x4f96b6(0x156)](_0x4f96b6(0x189),_0x312d8b),_0x2517a0=[];}if(!_0x2517a0[_0x4f96b6(0xef)](_0x20abb7)){console[_0x4f96b6(0xc4)]('Webhook\x20event\x20'+_0x20abb7+_0x4f96b6(0x141)+_0x1baaf6['id']);return;}const _0x70f3e8={'event':_0x20abb7,'payment':{'id':_0xe9175['id'],'order_id':_0xe9175['orderId'],'gateway_order_id':_0xe9175[_0x4f96b6(0x191)],'gateway':'1111','amount':_0xe9175[_0x4f96b6(0x10b)],'currency':_0xe9175[_0x4f96b6(0x162)],'status':_0x4b2bc1[_0x4f96b6(0x174)](),'customer_email':_0xe9175[_0x4f96b6(0x192)],'customer_name':_0xe9175[_0x4f96b6(0x150)],'created_at':_0xe9175[_0x4f96b6(0x159)],'updated_at':new Date()}},_0x31ed60=await fetch(_0x3caf17[_0x4f96b6(0x1ac)],{'method':_0x4f96b6(0xf0),'headers':{'Content-Type':_0x4f96b6(0x164),'User-Agent':_0x4f96b6(0xd4)},'body':JSON['stringify'](_0x70f3e8)}),_0x50c8ba=Date['now']()-_0x3e12a5;loggerService_1[_0x4f96b6(0x135)][_0x4f96b6(0xf2)](_0xe9175[_0x4f96b6(0x168)],_0x3caf17[_0x4f96b6(0x1ac)],_0x20abb7,_0x31ed60[_0x4f96b6(0xe3)],_0x50c8ba,_0x70f3e8),console[_0x4f96b6(0xc4)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x3caf17[_0x4f96b6(0x1ac)]+'\x20with\x20status\x20'+_0x31ed60[_0x4f96b6(0xe3)]+'\x20('+_0x50c8ba+_0x4f96b6(0x134));}catch(_0x506c09){console[_0x4f96b6(0x156)](_0x4f96b6(0xfc),_0x506c09),loggerService_1[_0x4f96b6(0x135)][_0x4f96b6(0x154)](_0xe9175[_0x4f96b6(0x168)],_0xe9175[_0x4f96b6(0xf6)]?.[_0x4f96b6(0x187)]?.[_0x4f96b6(0x1ac)]||_0x4f96b6(0x140),_0x4f96b6(0x185),_0x506c09,{});}}[a42_0x1557ee(0x106)](_0x1c5393){const _0xe065ca=a42_0x1557ee,_0x4bef52=_0x1c5393['replace'](/[\s-]/g,'');if(_0x4bef52[_0xe065ca(0x197)]<0x4)return _0xe065ca(0x13b);return'****\x20****\x20****\x20'+_0x4bef52['slice'](-0x4);}async[a42_0x1557ee(0x104)](_0x3d605e){const _0x4232ad=a42_0x1557ee;console[_0x4232ad(0xc4)]('Processing\x20MasterCard\x20webhook:',_0x3d605e);let _0x552e7b=_0x4232ad(0x153);if(_0x3d605e[_0x4232ad(0xe3)]===0x1&&_0x3d605e[_0x4232ad(0x108)]===0x1)_0x552e7b='PAID';else _0x3d605e['status']===0x0&&_0x3d605e[_0x4232ad(0x108)]===0x0?_0x552e7b=_0x4232ad(0x153):_0x552e7b=_0x4232ad(0x18f);return{'paymentId':_0x3d605e[_0x4232ad(0xe9)]||'','status':_0x552e7b,'amount':_0x3d605e[_0x4232ad(0x10b)],'currency':_0x3d605e[_0x4232ad(0x162)]};}['stopAllStatusChecks'](){const _0x3255f8=a42_0x1557ee;console[_0x3255f8(0xc4)](_0x3255f8(0xd8));const _0x56efed=this[_0x3255f8(0x15f)][_0x3255f8(0x130)];for(const [_0x1ee42b]of this['statusCheckTimers']){this[_0x3255f8(0x144)](_0x1ee42b);}console[_0x3255f8(0xc4)](_0x3255f8(0x10c)+_0x56efed+'\x20MasterCard\x20status\x20check\x20timers');}}function a42_0x320f(_0x31e4ba,_0x1f1faf){const _0x18ceff=a42_0x18ce();return a42_0x320f=function(_0x320f64,_0xf519a3){_0x320f64=_0x320f64-0xc0;let _0x4004db=_0x18ceff[_0x320f64];return _0x4004db;},a42_0x320f(_0x31e4ba,_0x1f1faf);}exports[a42_0x1557ee(0x11f)]=MasterCardService;