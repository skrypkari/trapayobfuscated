'use strict';const a42_0x7f3e8e=a42_0x3570;(function(_0x18667c,_0x55dddc){const _0x3070b2=a42_0x3570,_0x1d1b6c=_0x18667c();while(!![]){try{const _0x4974d8=parseInt(_0x3070b2(0xf5))/0x1*(-parseInt(_0x3070b2(0x105))/0x2)+-parseInt(_0x3070b2(0x14c))/0x3+parseInt(_0x3070b2(0xe8))/0x4*(-parseInt(_0x3070b2(0x18b))/0x5)+parseInt(_0x3070b2(0x1a0))/0x6+parseInt(_0x3070b2(0x15a))/0x7*(-parseInt(_0x3070b2(0x18a))/0x8)+parseInt(_0x3070b2(0x171))/0x9+parseInt(_0x3070b2(0x198))/0xa;if(_0x4974d8===_0x55dddc)break;else _0x1d1b6c['push'](_0x1d1b6c['shift']());}catch(_0x56c7a7){_0x1d1b6c['push'](_0x1d1b6c['shift']());}}}(a42_0x38b2,0x5c02e));var __createBinding=this&&this[a42_0x7f3e8e(0x1af)]||(Object[a42_0x7f3e8e(0x1c0)]?function(_0x3fc62d,_0x16f965,_0x13f53b,_0x344159){const _0x31fb68=a42_0x7f3e8e;if(_0x344159===undefined)_0x344159=_0x13f53b;var _0x5d0cc2=Object[_0x31fb68(0x114)](_0x16f965,_0x13f53b);(!_0x5d0cc2||('get'in _0x5d0cc2?!_0x16f965['__esModule']:_0x5d0cc2[_0x31fb68(0xe0)]||_0x5d0cc2['configurable']))&&(_0x5d0cc2={'enumerable':!![],'get':function(){return _0x16f965[_0x13f53b];}}),Object[_0x31fb68(0x16a)](_0x3fc62d,_0x344159,_0x5d0cc2);}:function(_0x14b9aa,_0x310de0,_0x3f51d0,_0x5480a9){if(_0x5480a9===undefined)_0x5480a9=_0x3f51d0;_0x14b9aa[_0x5480a9]=_0x310de0[_0x3f51d0];}),__setModuleDefault=this&&this[a42_0x7f3e8e(0xf4)]||(Object['create']?function(_0x1a3b39,_0x5dabbe){const _0x16df91=a42_0x7f3e8e;Object[_0x16df91(0x16a)](_0x1a3b39,_0x16df91(0xf2),{'enumerable':!![],'value':_0x5dabbe});}:function(_0x2931f9,_0x199ecf){_0x2931f9['default']=_0x199ecf;}),__importStar=this&&this[a42_0x7f3e8e(0x13f)]||(function(){var _0x1350e0=function(_0x5b0210){const _0x2b2c8c=a42_0x3570;return _0x1350e0=Object[_0x2b2c8c(0xe4)]||function(_0x54b8f9){const _0x4fce27=_0x2b2c8c;var _0x47e3b5=[];for(var _0x5c87ad in _0x54b8f9)if(Object[_0x4fce27(0x11e)]['hasOwnProperty']['call'](_0x54b8f9,_0x5c87ad))_0x47e3b5[_0x47e3b5[_0x4fce27(0x168)]]=_0x5c87ad;return _0x47e3b5;},_0x1350e0(_0x5b0210);};return function(_0x33ece9){const _0x4bb720=a42_0x3570;if(_0x33ece9&&_0x33ece9[_0x4bb720(0x124)])return _0x33ece9;var _0x5b4ab7={};if(_0x33ece9!=null){for(var _0x224252=_0x1350e0(_0x33ece9),_0x5e8f75=0x0;_0x5e8f75<_0x224252['length'];_0x5e8f75++)if(_0x224252[_0x5e8f75]!==_0x4bb720(0xf2))__createBinding(_0x5b4ab7,_0x33ece9,_0x224252[_0x5e8f75]);}return __setModuleDefault(_0x5b4ab7,_0x33ece9),_0x5b4ab7;};}()),__importDefault=this&&this['__importDefault']||function(_0x25aa96){const _0xb9dd82=a42_0x7f3e8e;return _0x25aa96&&_0x25aa96[_0xb9dd82(0x124)]?_0x25aa96:{'default':_0x25aa96};};function a42_0x38b2(){const _0x97e742=['message','key','❌\x20MasterCard\x20key\x20validation\x20failed:','HTTP\x20','💾\x20Payment\x20data\x20prepared','number','\x20\x20\x20-\x20info\x20length:','20553630KoJRZB','orderId','application/json','paid','HTTP\x20error!\x20status:\x20','../telegramBotService','description','webhookEvents','1230540KcHMtw','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','MasterCard\x20webhook\x20sent\x20to\x20','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','💳\x20MasterCard\x20service\x20initialized','encryptAES','log','publicEncrypt','crypto','generateAESKey','3ds_url','Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20','path','🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA','3DS\x20URL:','__createBinding','Order\x20ID:','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','amount','updatePaymentStatus','🔐\x20Public\x20key\x20length:\x20','apiUrl','payment.failed','Card\x20Holder:','shopId','expire_year','order_id','error','✅\x20Payment\x20','toLowerCase','SHA256','/status_raw','create','delete','PHP\x20decryptor\x20error','checkPaymentStatus','decryptResponse','decryptAES','Result\x20URL:','\x20not\x20enabled\x20for\x20shop\x20','toUpperCase','1111','MasterCardService','psp_public.pem','❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20','\x20with\x20status\x20','createCipheriv','writable','from','RSA_PKCS1_PADDING','PAID','getOwnPropertyNames','🔐\x20AES\x20IV\x20length:','Status:','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','76Gvqesb','status','❌\x20Failed\x20to\x20decrypt\x20status\x20response:','\x20status\x20updated\x20to\x20','📝\x20Encrypted\x20data\x20length:','payment.success','date_success','...','../loggerService','sendShopWebhook','default','resolve','__setModuleDefault','1czhKCr','Return\x20URL:','HTTP\x20Status:','end','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','size','🔐\x20AES\x20key\x20length:','get','encryptRSA','text','floor','parse','logWhiteDomainError','Error\x20details:','/charge','merchantPointId','1068884ucvklH','cvv','\x20\x20\x20-\x20sign\x20length:','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','processCardPayment','webhook_send','payment_id','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','FAILED','cwd','POST','update','payment','\x20is\x20final\x20(','Unknown\x20error','getOwnPropertyDescriptor','loggerService','existsSync','ms)','expire_month','****','Failed\x20to\x20send\x20MasterCard\x20webhook:','info','final','readFileSync','prototype','Final:','https://api.paydmeth.com/api','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','failed','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','__esModule','\x20for\x20payment\x20','\x20status\x20timers\x20for\x20payment\x20','logWhiteDomainResponse','-----END','logWhiteDomainRequest','adminNotes','Payment\x20ID:','\x20failed\x20for\x20payment\x20','last_name','Failed\x20to\x20decrypt\x20response','../../config/database','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','🔐\x20Private\x20key\x20length:\x20','/charge_raw','🔍\x20MasterCard\x20status\x20check\x20#','signRSA','createdAt','privateKeyPath','/status_decrypted','===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20===','/charge_decrypted','charge','join','Amount:','validateKeyFiles','📝\x20Encrypted\x20key\x20length:','__importStar','toString','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','system','statusCheckTimers','\x20result:','🧹\x20Clearing\x20','mastercard','decryptResponsePhp','private.pem','===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===','\x20\x20\x20-\x20method:\x20charge','currency','1606155nqkazV','includes','scheduleStatusChecks','none','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','now','❌\x20RSA\x20signing\x20failed:','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20','paidAt','Response\x20Time:','/status_decrypt','shop','-----BEGIN','7GFWsqs','\x20status\x20checks\x20for\x20payment\x20','📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','Failed\x20to\x20send\x20payment\x20notifications:','https://api2.trapay.uk/decrypt.php','clearStatusTimers','\x20\x20\x20-\x20merchant_point_id:','keys','✅\x20Status\x20response\x20decrypted\x20successfully','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','🛑\x20Stopped\x20','findUnique','stringify','json','length','gatewayOrderId','defineProperty','MasterCard:\x20','\x20characters','base64','Response\x20Body:','logShopWebhookSent','aes-256-ctr','2928654cKuQdP','sendPaymentNotifications','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','then','TesSoft\x20Payment\x20System/1.0','\x20\x20\x20-\x20lang:\x20en','forEach','🔐\x20RSA\x20signing\x20successful','webhookUrl','stopAllStatusChecks','desc','****\x20****\x20****\x20','unknown','logShopWebhookError','Error\x20parsing\x20webhook\x20events:','slice','Status\x20decryption\x20failed:\x20','❌\x20RSA\x20encryption\x20failed:','createSign','trim','settings','randomBytes','PENDING','sign','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','5639576keVmrh','114265Magomt','Private\x20key\x20file\x20not\x20found:\x20','utf8','maskCardNumber','publicKeyPath','substring'];a42_0x38b2=function(){return _0x97e742;};return a42_0x38b2();}Object[a42_0x7f3e8e(0x16a)](exports,'__esModule',{'value':!![]}),exports['MasterCardService']=void 0x0;function a42_0x3570(_0x23e4da,_0x32fd55){const _0x38b2cd=a42_0x38b2();return a42_0x3570=function(_0x357031,_0x51b9a8){_0x357031=_0x357031-0xda;let _0x1287fe=_0x38b2cd[_0x357031];return _0x1287fe;},a42_0x3570(_0x23e4da,_0x32fd55);}const crypto_1=__importDefault(require(a42_0x7f3e8e(0x1a8))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0x7f3e8e(0x1ac))),loggerService_1=require(a42_0x7f3e8e(0xf0));class MasterCardService{constructor(){const _0x5966b1=a42_0x7f3e8e;this[_0x5966b1(0x143)]=new Map(),this[_0x5966b1(0x1b5)]=_0x5966b1(0x120),this[_0x5966b1(0x104)]=0x67c,this[_0x5966b1(0x136)]=path_1['default']['join'](process[_0x5966b1(0x10e)](),_0x5966b1(0x161),_0x5966b1(0x148)),this['publicKeyPath']=path_1['default'][_0x5966b1(0x13b)](process['cwd'](),'keys',_0x5966b1(0xdc)),console[_0x5966b1(0x1a6)](_0x5966b1(0x1a4)),console[_0x5966b1(0x1a6)]('🔐\x20Private\x20key\x20path:',this['privateKeyPath']),console[_0x5966b1(0x1a6)]('🔐\x20Public\x20key\x20path:',this[_0x5966b1(0x18f)]),this[_0x5966b1(0x13d)]();}['validateKeyFiles'](){const _0x5653c9=a42_0x7f3e8e;try{if(!fs_1[_0x5653c9(0xf2)]['existsSync'](this[_0x5653c9(0x136)]))throw new Error(_0x5653c9(0x18c)+this[_0x5653c9(0x136)]);if(!fs_1[_0x5653c9(0xf2)][_0x5653c9(0x116)](this['publicKeyPath']))throw new Error('Public\x20key\x20file\x20not\x20found:\x20'+this[_0x5653c9(0x18f)]);const _0x48a499=fs_1['default']['readFileSync'](this[_0x5653c9(0x136)],_0x5653c9(0x18d))[_0x5653c9(0x184)](),_0x101fcd=fs_1[_0x5653c9(0xf2)]['readFileSync'](this[_0x5653c9(0x18f)],'utf8')['trim']();if(!_0x48a499[_0x5653c9(0x14d)](_0x5653c9(0x159))||!_0x48a499[_0x5653c9(0x14d)](_0x5653c9(0x128)))throw new Error(_0x5653c9(0x1a3));if(!_0x101fcd[_0x5653c9(0x14d)](_0x5653c9(0x159))||!_0x101fcd[_0x5653c9(0x14d)](_0x5653c9(0x128)))throw new Error(_0x5653c9(0x173));console[_0x5653c9(0x1a6)](_0x5653c9(0xe7)),console[_0x5653c9(0x1a6)](_0x5653c9(0x131)+_0x48a499[_0x5653c9(0x168)]+_0x5653c9(0x16c)),console['log'](_0x5653c9(0x1b4)+_0x101fcd['length']+'\x20characters');}catch(_0x5a9991){console[_0x5653c9(0x1bb)](_0x5653c9(0x193),_0x5a9991);throw _0x5a9991;}}[a42_0x7f3e8e(0x1a9)](){const _0x14ac80=a42_0x7f3e8e,_0x44e844=crypto_1[_0x14ac80(0xf2)][_0x14ac80(0x186)](0x20),_0x32af38=crypto_1[_0x14ac80(0xf2)][_0x14ac80(0x186)](0x10);return{'key':_0x44e844,'iv':_0x32af38};}[a42_0x7f3e8e(0x1a5)](_0xb523a3,_0x1d6eb5,_0x461614){const _0x189bf9=a42_0x7f3e8e,_0x335cf4=crypto_1[_0x189bf9(0xf2)][_0x189bf9(0xdf)](_0x189bf9(0x170),_0x1d6eb5,_0x461614);let _0x44f777=_0x335cf4[_0x189bf9(0x110)](_0xb523a3,_0x189bf9(0x18d),_0x189bf9(0x16d));return _0x44f777+=_0x335cf4[_0x189bf9(0x11c)](_0x189bf9(0x16d)),_0x44f777;}[a42_0x7f3e8e(0xfd)](_0x23c56e,_0x3a43bd){const _0x1662c6=a42_0x7f3e8e;try{const _0x427ade=fs_1[_0x1662c6(0xf2)][_0x1662c6(0x11d)](this[_0x1662c6(0x18f)],_0x1662c6(0x18d))[_0x1662c6(0x184)](),_0x11bef7={'iv':_0x3a43bd[_0x1662c6(0x140)](_0x1662c6(0x16d)),'key':_0x23c56e['toString'](_0x1662c6(0x16d))},_0x3a1462=JSON[_0x1662c6(0x166)](_0x11bef7);console['log'](_0x1662c6(0x150),_0x3a1462['length']);const _0x5c330d=crypto_1[_0x1662c6(0xf2)][_0x1662c6(0x1a7)]({'key':_0x427ade,'padding':crypto_1[_0x1662c6(0xf2)]['constants'][_0x1662c6(0xe2)]},Buffer[_0x1662c6(0xe1)](_0x3a1462));return console[_0x1662c6(0x1a6)](_0x1662c6(0x151),_0x5c330d[_0x1662c6(0x168)]),_0x5c330d[_0x1662c6(0x140)](_0x1662c6(0x16d));}catch(_0x57ccd6){console[_0x1662c6(0x1bb)](_0x1662c6(0x182),_0x57ccd6);throw new Error(_0x1662c6(0x141));}}[a42_0x7f3e8e(0x134)](_0x2b96e3){const _0x41be60=a42_0x7f3e8e;try{const _0x3af3dc=fs_1['default'][_0x41be60(0x11d)](this[_0x41be60(0x136)],_0x41be60(0x18d))['trim'](),_0x71559c=crypto_1[_0x41be60(0xf2)][_0x41be60(0x183)](_0x41be60(0x1be));_0x71559c[_0x41be60(0x110)](_0x2b96e3),_0x71559c[_0x41be60(0xf8)]();const _0x32319e=_0x71559c['sign'](_0x3af3dc,_0x41be60(0x16d));return console['log'](_0x41be60(0x178)),console[_0x41be60(0x1a6)]('📝\x20Data\x20to\x20sign\x20length:',_0x2b96e3[_0x41be60(0x168)]),console['log']('📝\x20Signature\x20length:',_0x32319e[_0x41be60(0x168)]),_0x32319e;}catch(_0xcd108e){console[_0x41be60(0x1bb)](_0x41be60(0x153),_0xcd108e),console[_0x41be60(0x1bb)]('❌\x20Data\x20being\x20signed:',_0x2b96e3[_0x41be60(0x190)](0x0,0xc8)+_0x41be60(0xef));throw new Error(_0x41be60(0x1a1));}}['decryptAES'](_0x5ab2c3,_0x56b64b,_0x38817f){const _0x12d91d=a42_0x7f3e8e,_0x1af164=crypto_1[_0x12d91d(0xf2)]['createDecipheriv'](_0x12d91d(0x170),_0x56b64b,_0x38817f);let _0x14a938=_0x1af164[_0x12d91d(0x110)](_0x5ab2c3,_0x12d91d(0x16d),_0x12d91d(0x18d));return _0x14a938+=_0x1af164[_0x12d91d(0x11c)](_0x12d91d(0x18d)),_0x14a938;}async[a42_0x7f3e8e(0x147)](_0x42d455,_0x2da8ee){const _0x1d75e2=a42_0x7f3e8e;try{const _0x472c10=await fetch(_0x1d75e2(0x15e),{'method':_0x1d75e2(0x10f),'headers':{'Content-Type':_0x1d75e2(0x19a)},'body':JSON['stringify']({'info':_0x42d455,'key':_0x2da8ee})});if(!_0x472c10['ok'])throw new Error(_0x1d75e2(0x1c2));return await _0x472c10[_0x1d75e2(0xfe)]();}catch(_0x198ab7){console[_0x1d75e2(0x1bb)]('❌\x20PHP\x20decryptor\x20request\x20failed:',_0x198ab7);throw new Error('Failed\x20to\x20decrypt\x20response\x20via\x20PHP');}}[a42_0x7f3e8e(0x1c4)](_0x3bb106,_0x323faa){const _0x53ba15=a42_0x7f3e8e;try{const _0x3cd0cd=fs_1[_0x53ba15(0xf2)][_0x53ba15(0x11d)](this[_0x53ba15(0x136)],_0x53ba15(0x18d))[_0x53ba15(0x184)](),_0x4a0639=crypto_1[_0x53ba15(0xf2)]['privateDecrypt'](_0x3cd0cd,Buffer[_0x53ba15(0xe1)](_0x323faa,_0x53ba15(0x16d))),_0x3cf1b9=JSON[_0x53ba15(0x100)](_0x4a0639[_0x53ba15(0x140)]()),_0x2b715a=Buffer[_0x53ba15(0xe1)](_0x3cf1b9[_0x53ba15(0x192)],'base64'),_0x4d5b72=Buffer[_0x53ba15(0xe1)](_0x3cf1b9['iv'],'base64');return this[_0x53ba15(0x1c5)](_0x3bb106,_0x2b715a,_0x4d5b72);}catch(_0xc3f37){throw new Error(_0x53ba15(0x12e));}}async[a42_0x7f3e8e(0x109)](_0x425adf){const _0x41beb2=a42_0x7f3e8e,{paymentId:_0x462903,orderId:_0x62a08a,amount:_0x2c4772,currency:_0x27e838,cardData:_0x217adc,resultUrl:_0x2a9cd7,returnUrl:_0x3df6b,cardHolder:_0x2c1a44,browser:_0x30e069}=_0x425adf;console[_0x41beb2(0x1a6)](_0x41beb2(0x138)),console[_0x41beb2(0x1a6)](_0x41beb2(0x12b),_0x462903),console['log'](_0x41beb2(0x1b0),_0x62a08a),console[_0x41beb2(0x1a6)](_0x41beb2(0x13c),_0x2c4772,_0x27e838),console[_0x41beb2(0x1a6)]('Card\x20Number:',this['maskCardNumber'](_0x217adc[_0x41beb2(0x196)])),console[_0x41beb2(0x1a6)](_0x41beb2(0x1b7),_0x2c1a44['first_name']+'\x20'+_0x2c1a44[_0x41beb2(0x12d)]),console['log'](_0x41beb2(0xf6),_0x3df6b),console['log'](_0x41beb2(0x1c6),_0x2a9cd7);const _0x2c71be={'amount':_0x2c4772,'currency':_0x27e838['toUpperCase'](),'order_id':_0x62a08a,'result_url':_0x2a9cd7,'return_url':_0x3df6b,'card':{'number':_0x217adc[_0x41beb2(0x196)],'expire_month':_0x217adc[_0x41beb2(0x118)],'expire_year':_0x217adc[_0x41beb2(0x1b9)],'cvv':_0x217adc[_0x41beb2(0x106)]},'card_holder':_0x2c1a44,'browser':_0x30e069},_0x26ed78=JSON[_0x41beb2(0x166)](_0x2c71be);console[_0x41beb2(0x1a6)](_0x41beb2(0x195)),console[_0x41beb2(0x1a6)]('📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:'),console[_0x41beb2(0x1a6)](_0x26ed78),console[_0x41beb2(0x1a6)]('📝\x20Data\x20length:',_0x26ed78[_0x41beb2(0x168)]);try{const {key:_0x31148b,iv:_0x9d3b3f}=this['generateAESKey']();console[_0x41beb2(0x1a6)]('🔐\x20AES\x20key\x20and\x20IV\x20generated'),console[_0x41beb2(0x1a6)](_0x41beb2(0xfb),_0x31148b['length']),console['log'](_0x41beb2(0xe5),_0x9d3b3f[_0x41beb2(0x168)]);const _0x1a9144=this[_0x41beb2(0x1a5)](_0x26ed78,_0x31148b,_0x9d3b3f);console[_0x41beb2(0x1a6)]('🔐\x20Data\x20encrypted\x20with\x20AES'),console[_0x41beb2(0x1a6)](_0x41beb2(0xec),_0x1a9144[_0x41beb2(0x168)]);const _0x22a927=this[_0x41beb2(0xfd)](_0x31148b,_0x9d3b3f);console[_0x41beb2(0x1a6)](_0x41beb2(0x1ad)),console['log'](_0x41beb2(0x13e),_0x22a927['length']);const _0xb317af=this[_0x41beb2(0x134)](_0x26ed78);console[_0x41beb2(0x1a6)]('🔐\x20Data\x20signed\x20with\x20RSA'),console[_0x41beb2(0x1a6)]('📝\x20Signature\x20length:',_0xb317af['length']);const _0x1eddfd={'merchant_point_id':this[_0x41beb2(0x104)],'method':'charge','info':_0x1a9144,'key':_0x22a927,'sign':_0xb317af,'lang':'en'};console[_0x41beb2(0x1a6)]('📤\x20Sending\x20request\x20to\x20MasterCard\x20API...'),console['log']('📝\x20Final\x20request\x20structure:'),console[_0x41beb2(0x1a6)](_0x41beb2(0x160),this[_0x41beb2(0x104)]),console['log'](_0x41beb2(0x14a)),console[_0x41beb2(0x1a6)](_0x41beb2(0x197),_0x1a9144[_0x41beb2(0x168)]),console[_0x41beb2(0x1a6)]('\x20\x20\x20-\x20key\x20length:',_0x22a927[_0x41beb2(0x168)]),console[_0x41beb2(0x1a6)](_0x41beb2(0x107),_0xb317af[_0x41beb2(0x168)]),console[_0x41beb2(0x1a6)](_0x41beb2(0x176)),loggerService_1[_0x41beb2(0x115)][_0x41beb2(0x129)]('mastercard',_0x41beb2(0x103),_0x41beb2(0x10f),{'merchant_point_id':this[_0x41beb2(0x104)],'method':_0x41beb2(0x13a),'lang':'en'});const _0x2c2308=Date[_0x41beb2(0x152)](),_0x799a55=await fetch(this[_0x41beb2(0x1b5)],{'method':_0x41beb2(0x10f),'headers':{'Content-Type':_0x41beb2(0x19a),'Accept':_0x41beb2(0x19a),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x1eddfd)}),_0xba16c0=Date['now']()-_0x2c2308;console[_0x41beb2(0x1a6)](_0x41beb2(0x108)),console[_0x41beb2(0x1a6)](_0x41beb2(0xe6),_0x799a55[_0x41beb2(0xe9)]),console[_0x41beb2(0x1a6)](_0x41beb2(0x156),_0xba16c0+'ms');if(!_0x799a55['ok']){const _0xc65cb2=await _0x799a55[_0x41beb2(0xfe)]();console[_0x41beb2(0x1bb)](_0x41beb2(0xf7),_0x799a55[_0x41beb2(0xe9)]),console[_0x41beb2(0x1bb)](_0x41beb2(0x16e),_0xc65cb2),loggerService_1[_0x41beb2(0x115)][_0x41beb2(0x127)]('mastercard','/charge_raw',_0x799a55['status'],_0xc65cb2,_0xba16c0),loggerService_1[_0x41beb2(0x115)][_0x41beb2(0x101)](_0x41beb2(0x146),_0x41beb2(0x103),_0x41beb2(0x194)+_0x799a55[_0x41beb2(0xe9)]+':\x20'+_0xc65cb2);throw new Error(_0x41beb2(0x19c)+_0x799a55[_0x41beb2(0xe9)]+',\x20body:\x20'+_0xc65cb2);}const _0x2126ea=await _0x799a55[_0x41beb2(0x167)]();loggerService_1[_0x41beb2(0x115)][_0x41beb2(0x127)](_0x41beb2(0x146),_0x41beb2(0x132),_0x799a55['status'],_0x2126ea,_0xba16c0),console[_0x41beb2(0x1a6)](_0x41beb2(0x149));let _0x28a5a2=_0x2126ea;if(_0x2126ea[_0x41beb2(0x11b)]&&_0x2126ea[_0x41beb2(0x192)]&&_0x2126ea[_0x41beb2(0x188)]){console[_0x41beb2(0x1a6)](_0x41beb2(0x1b1));try{const _0xe88796=await this[_0x41beb2(0x147)](_0x2126ea[_0x41beb2(0x11b)],_0x2126ea[_0x41beb2(0x192)]);_0x28a5a2=JSON[_0x41beb2(0x100)](_0xe88796),console[_0x41beb2(0x1a6)]('✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)'),loggerService_1[_0x41beb2(0x115)][_0x41beb2(0x127)](_0x41beb2(0x146),_0x41beb2(0x139),_0x799a55[_0x41beb2(0xe9)],_0x28a5a2,_0xba16c0),console[_0x41beb2(0x1a6)]('📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted');}catch(_0x541446){console[_0x41beb2(0x1bb)]('❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):',_0x541446),loggerService_1[_0x41beb2(0x115)][_0x41beb2(0x101)](_0x41beb2(0x146),'/charge_decrypt','Decryption\x20failed:\x20'+_0x541446),_0x28a5a2=_0x2126ea;}}else loggerService_1[_0x41beb2(0x115)][_0x41beb2(0x127)](_0x41beb2(0x146),_0x41beb2(0x139),_0x799a55[_0x41beb2(0xe9)],_0x28a5a2,_0xba16c0),console['log']('📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted');console[_0x41beb2(0x1a6)]('Status:',_0x28a5a2[_0x41beb2(0xe9)]),console[_0x41beb2(0x1a6)](_0x41beb2(0x11f),_0x28a5a2['final']),console['log'](_0x41beb2(0x12b),_0x28a5a2[_0x41beb2(0x10b)]),console[_0x41beb2(0x1a6)](_0x41beb2(0x1ae),_0x28a5a2[_0x41beb2(0x1aa)]||_0x41beb2(0x14f));if(_0x28a5a2[_0x41beb2(0xe9)]===0x64&&_0x28a5a2[_0x41beb2(0x11c)]===0x1)return console['log']('✅\x20Payment\x20successful'),{'gateway_payment_id':_0x28a5a2[_0x41beb2(0x10b)]?.[_0x41beb2(0x140)](),'payment_url':_0x3df6b,'requires_3ds':![],'status':_0x41beb2(0xe3),'final':!![]};if(_0x28a5a2['3ds_url'])return console[_0x41beb2(0x1a6)]('🔐\x203DS\x20verification\x20required'),this[_0x41beb2(0x14e)](_0x462903,_0x62a08a,_0x28a5a2[_0x41beb2(0x10b)]?.[_0x41beb2(0x140)]()||_0x62a08a),{'gateway_payment_id':_0x28a5a2['payment_id']?.['toString'](),'payment_url':_0x28a5a2['3ds_url'],'requires_3ds':!![],'threeds_url':_0x28a5a2[_0x41beb2(0x1aa)],'status':_0x41beb2(0x187),'final':![]};let _0x275ef8=_0x28a5a2[_0x41beb2(0x17b)]||_0x28a5a2[_0x41beb2(0x191)]||_0x41beb2(0x113),_0x184e9c=_0x28a5a2[_0x41beb2(0xe9)],_0x5391c1=_0x28a5a2['final'];return console[_0x41beb2(0x1a6)](_0x41beb2(0xdd)+_0x184e9c+',\x20Final:\x20'+_0x5391c1+',\x20Desc:\x20'+_0x275ef8),{'gateway_payment_id':_0x28a5a2[_0x41beb2(0x10b)]?.[_0x41beb2(0x140)](),'payment_url':_0x3df6b,'requires_3ds':![],'status':'FAILED','final':!![]};}catch(_0x5c42a2){console['error'](_0x41beb2(0x130)),console[_0x41beb2(0x1bb)](_0x41beb2(0x102),_0x5c42a2),loggerService_1['loggerService'][_0x41beb2(0x101)](_0x41beb2(0x146),_0x41beb2(0x103),_0x5c42a2);throw new Error(_0x41beb2(0x163)+(_0x5c42a2 instanceof Error?_0x5c42a2[_0x41beb2(0x191)]:'Unknown\x20error'));}}async['checkPaymentStatus'](_0x436116,_0x15cfc6){const _0x304cdf=a42_0x7f3e8e;console[_0x304cdf(0x1a6)](_0x304cdf(0x189)+_0x436116+'\x20('+_0x15cfc6+')');try{const _0x7905c0={'payment_id':_0x436116,'order_id':_0x15cfc6},_0x2d400c=JSON[_0x304cdf(0x166)](_0x7905c0),{key:_0x3e089f,iv:_0x3028a3}=this[_0x304cdf(0x1a9)](),_0x2efa0a=this['encryptAES'](_0x2d400c,_0x3e089f,_0x3028a3),_0x1e970f=this[_0x304cdf(0xfd)](_0x3e089f,_0x3028a3),_0x40bf96=this[_0x304cdf(0x134)](_0x2d400c),_0x69783e={'merchant_point_id':this[_0x304cdf(0x104)],'method':_0x304cdf(0xe9),'info':_0x2efa0a,'key':_0x1e970f,'sign':_0x40bf96,'lang':'en'};loggerService_1[_0x304cdf(0x115)][_0x304cdf(0x129)](_0x304cdf(0x146),'/status','POST',{'merchant_point_id':this['merchantPointId'],'method':_0x304cdf(0xe9),'lang':'en'});const _0x1472e8=Date['now'](),_0xa8ac01=await fetch(this[_0x304cdf(0x1b5)],{'method':_0x304cdf(0x10f),'headers':{'Content-Type':_0x304cdf(0x19a),'Accept':_0x304cdf(0x19a),'User-Agent':_0x304cdf(0x175)},'body':JSON[_0x304cdf(0x166)](_0x69783e)}),_0x1e51ce=Date['now']()-_0x1472e8;if(!_0xa8ac01['ok']){const _0x5d789f=await _0xa8ac01[_0x304cdf(0xfe)]();loggerService_1[_0x304cdf(0x115)][_0x304cdf(0x127)](_0x304cdf(0x146),_0x304cdf(0x1bf),_0xa8ac01[_0x304cdf(0xe9)],_0x5d789f,_0x1e51ce);throw new Error('HTTP\x20error!\x20status:\x20'+_0xa8ac01[_0x304cdf(0xe9)]);}const _0x15acf9=await _0xa8ac01[_0x304cdf(0x167)]();loggerService_1[_0x304cdf(0x115)]['logWhiteDomainResponse']('mastercard',_0x304cdf(0x1bf),_0xa8ac01['status'],_0x15acf9,_0x1e51ce);let _0x3cdad3=_0x15acf9;if(_0x15acf9[_0x304cdf(0x11b)]&&_0x15acf9[_0x304cdf(0x192)]&&_0x15acf9[_0x304cdf(0x188)]){console[_0x304cdf(0x1a6)](_0x304cdf(0x121));try{const _0x37b8db=this[_0x304cdf(0x1c4)](_0x15acf9[_0x304cdf(0x11b)],_0x15acf9[_0x304cdf(0x192)]);_0x3cdad3=JSON['parse'](_0x37b8db),console[_0x304cdf(0x1a6)](_0x304cdf(0x162)),loggerService_1[_0x304cdf(0x115)][_0x304cdf(0x127)]('mastercard',_0x304cdf(0x137),_0xa8ac01[_0x304cdf(0xe9)],_0x3cdad3,_0x1e51ce),console[_0x304cdf(0x1a6)](_0x304cdf(0x123));}catch(_0xf7a224){console[_0x304cdf(0x1bb)](_0x304cdf(0xea),_0xf7a224),loggerService_1[_0x304cdf(0x115)][_0x304cdf(0x101)](_0x304cdf(0x146),_0x304cdf(0x157),_0x304cdf(0x181)+_0xf7a224),_0x3cdad3=_0x15acf9;}}else loggerService_1[_0x304cdf(0x115)][_0x304cdf(0x127)](_0x304cdf(0x146),_0x304cdf(0x137),_0xa8ac01['status'],_0x3cdad3,_0x1e51ce),console[_0x304cdf(0x1a6)](_0x304cdf(0x15c));console['log']('📊\x20Status\x20check\x20result:',{'status':_0x3cdad3['status'],'final':_0x3cdad3[_0x304cdf(0x11c)],'payment_id':_0x3cdad3[_0x304cdf(0x10b)],'desc':_0x3cdad3[_0x304cdf(0x17b)]});let _0x5deb75=_0x304cdf(0x187);if(_0x3cdad3['status']===0x1&&_0x3cdad3['final']===0x1)_0x5deb75=_0x304cdf(0xe3);else _0x3cdad3[_0x304cdf(0xe9)]===0x0&&_0x3cdad3[_0x304cdf(0x11c)]===0x0?_0x5deb75=_0x304cdf(0x187):_0x5deb75=_0x304cdf(0x10d);return{'status':_0x5deb75,'final':_0x3cdad3[_0x304cdf(0x11c)]===0x1,'amount':_0x3cdad3[_0x304cdf(0x1b2)],'currency':_0x3cdad3[_0x304cdf(0x14b)],'date_success':_0x3cdad3[_0x304cdf(0xee)],'description':_0x3cdad3[_0x304cdf(0x17b)]};}catch(_0x4b2abf){console[_0x304cdf(0x1bb)]('MasterCard\x20status\x20check\x20error:',_0x4b2abf),loggerService_1['loggerService']['logWhiteDomainError'](_0x304cdf(0x146),'/status',_0x4b2abf);throw new Error(_0x304cdf(0x1ab)+(_0x4b2abf instanceof Error?_0x4b2abf[_0x304cdf(0x191)]:_0x304cdf(0x113)));}}[a42_0x7f3e8e(0x14e)](_0x452c58,_0x3b204d,_0x4ea234){const _0x58167e=a42_0x7f3e8e;console[_0x58167e(0x1a6)]('⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20'+_0x452c58+'\x20('+_0x4ea234+')'),this[_0x58167e(0x15f)](_0x452c58);const _0x32bf7a=[],_0x2a8207=0x5*0x3c*0x3e8,_0x2e7170=0x2*0x3c*0x3c*0x3e8,_0x2adeac=Math[_0x58167e(0xff)](_0x2e7170/_0x2a8207);console[_0x58167e(0x1a6)]('⏰\x20Will\x20check\x20status\x20'+_0x2adeac+_0x58167e(0xf9));for(let _0x3774c0=0x1;_0x3774c0<=_0x2adeac;_0x3774c0++){const _0x233070=setTimeout(async()=>{const _0x2a58a4=_0x58167e;console[_0x2a58a4(0x1a6)](_0x2a58a4(0x133)+_0x3774c0+'/'+_0x2adeac+_0x2a58a4(0x125)+_0x452c58);try{const _0x83420a=await this[_0x2a58a4(0x1c3)](_0x4ea234,_0x3b204d);console[_0x2a58a4(0x1a6)]('📊\x20Status\x20check\x20#'+_0x3774c0+_0x2a58a4(0x144),_0x83420a),_0x83420a['final']&&(console['log'](_0x2a58a4(0x1bc)+_0x452c58+_0x2a58a4(0x112)+_0x83420a[_0x2a58a4(0xe9)]+'),\x20stopping\x20status\x20checks'),this[_0x2a58a4(0x15f)](_0x452c58),await this[_0x2a58a4(0x1b3)](_0x452c58,_0x83420a['status'],_0x83420a));}catch(_0x5a6f51){console[_0x2a58a4(0x1bb)]('❌\x20Status\x20check\x20#'+_0x3774c0+_0x2a58a4(0x12c)+_0x452c58+':',_0x5a6f51);}},_0x3774c0*_0x2a8207);_0x32bf7a['push'](_0x233070);}this[_0x58167e(0x143)]['set'](_0x452c58,_0x32bf7a),console[_0x58167e(0x1a6)]('✅\x20Scheduled\x20'+_0x2adeac+_0x58167e(0x15b)+_0x452c58);}[a42_0x7f3e8e(0x15f)](_0x4cfb04){const _0x375e98=a42_0x7f3e8e,_0x5e2f32=this[_0x375e98(0x143)][_0x375e98(0xfc)](_0x4cfb04);_0x5e2f32&&(console['log'](_0x375e98(0x145)+_0x5e2f32[_0x375e98(0x168)]+_0x375e98(0x126)+_0x4cfb04),_0x5e2f32[_0x375e98(0x177)]((_0x47f321,_0x3c7c9f)=>{clearTimeout(_0x47f321);}),this[_0x375e98(0x143)][_0x375e98(0x1c1)](_0x4cfb04));}async[a42_0x7f3e8e(0x1b3)](_0x16801c,_0x15ed80,_0x19024a){const _0x50472d=a42_0x7f3e8e;try{const _0x40b73f=(await Promise[_0x50472d(0xf3)]()[_0x50472d(0x174)](()=>__importStar(require(_0x50472d(0x12f)))))[_0x50472d(0xf2)],_0x5a0bcd={'status':_0x15ed80[_0x50472d(0x1c8)](),'updatedAt':new Date(),'statusChangedBy':_0x50472d(0x142),'statusChangedAt':new Date()};_0x15ed80===_0x50472d(0xe3)&&(_0x5a0bcd[_0x50472d(0x155)]=new Date()),_0x19024a[_0x50472d(0x19e)]&&(_0x5a0bcd[_0x50472d(0x12a)]=_0x50472d(0x16b)+_0x19024a[_0x50472d(0x19e)]),await _0x40b73f['payment']['update']({'where':{'id':_0x16801c},'data':_0x5a0bcd}),console['log'](_0x50472d(0x1bc)+_0x16801c+_0x50472d(0xeb)+_0x15ed80),await this[_0x50472d(0x172)](_0x16801c,_0x15ed80);}catch(_0x24ff1e){console[_0x50472d(0x1bb)](_0x50472d(0x154)+_0x16801c+':',_0x24ff1e);}}async[a42_0x7f3e8e(0x172)](_0xf70218,_0x138fd2){const _0x51d839=a42_0x7f3e8e;try{const _0x1ed388=(await Promise[_0x51d839(0xf3)]()[_0x51d839(0x174)](()=>__importStar(require('../../config/database'))))[_0x51d839(0xf2)],{telegramBotService:_0x25fc64}=await Promise[_0x51d839(0xf3)]()[_0x51d839(0x174)](()=>__importStar(require(_0x51d839(0x19d)))),_0x60f3a0=await _0x1ed388[_0x51d839(0x111)][_0x51d839(0x165)]({'where':{'id':_0xf70218},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x60f3a0)return;const _0x1b19dc={'PAID':_0x51d839(0x19b),'FAILED':_0x51d839(0x122)},_0x32d6c3=_0x1b19dc[_0x138fd2];_0x32d6c3&&await _0x25fc64['sendPaymentNotification'](_0x60f3a0[_0x51d839(0x1b8)],_0x60f3a0,_0x32d6c3),await this['sendShopWebhook'](_0x60f3a0,_0x138fd2);}catch(_0x4ef8ac){console[_0x51d839(0x1bb)](_0x51d839(0x15d),_0x4ef8ac);}}async[a42_0x7f3e8e(0xf1)](_0x37c4f1,_0xf83252){const _0x1941b6=a42_0x7f3e8e,_0x5a425f=Date[_0x1941b6(0x152)]();try{const _0x4936d5=_0x37c4f1['shop'],_0x1853bc=_0x4936d5[_0x1941b6(0x185)];if(!_0x1853bc?.['webhookUrl']){console[_0x1941b6(0x1a6)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x4936d5['id']);return;}const _0x4baad0=_0xf83252===_0x1941b6(0xe3)?_0x1941b6(0xed):_0x1941b6(0x1b6);let _0x37c276=[];if(_0x1853bc['webhookEvents'])try{_0x37c276=Array['isArray'](_0x1853bc[_0x1941b6(0x19f)])?_0x1853bc[_0x1941b6(0x19f)]:JSON['parse'](_0x1853bc[_0x1941b6(0x19f)]);}catch(_0x44b9b9){console[_0x1941b6(0x1bb)](_0x1941b6(0x17f),_0x44b9b9),_0x37c276=[];}if(!_0x37c276[_0x1941b6(0x14d)](_0x4baad0)){console['log']('Webhook\x20event\x20'+_0x4baad0+_0x1941b6(0x1c7)+_0x4936d5['id']);return;}const _0x557c70={'event':_0x4baad0,'payment':{'id':_0x37c4f1['id'],'order_id':_0x37c4f1[_0x1941b6(0x199)],'gateway_order_id':_0x37c4f1[_0x1941b6(0x169)],'gateway':_0x1941b6(0xda),'amount':_0x37c4f1[_0x1941b6(0x1b2)],'currency':_0x37c4f1[_0x1941b6(0x14b)],'status':_0xf83252[_0x1941b6(0x1bd)](),'customer_email':_0x37c4f1['customerEmail'],'customer_name':_0x37c4f1['customerName'],'created_at':_0x37c4f1[_0x1941b6(0x135)],'updated_at':new Date()}},_0x3009f4=await fetch(_0x1853bc[_0x1941b6(0x179)],{'method':'POST','headers':{'Content-Type':_0x1941b6(0x19a),'User-Agent':_0x1941b6(0x10c)},'body':JSON['stringify'](_0x557c70)}),_0x32e2d4=Date['now']()-_0x5a425f;loggerService_1['loggerService'][_0x1941b6(0x16f)](_0x37c4f1[_0x1941b6(0x1b8)],_0x1853bc[_0x1941b6(0x179)],_0x4baad0,_0x3009f4[_0x1941b6(0xe9)],_0x32e2d4,_0x557c70),console[_0x1941b6(0x1a6)](_0x1941b6(0x1a2)+_0x1853bc[_0x1941b6(0x179)]+_0x1941b6(0xde)+_0x3009f4[_0x1941b6(0xe9)]+'\x20('+_0x32e2d4+_0x1941b6(0x117));}catch(_0x2899bf){console[_0x1941b6(0x1bb)](_0x1941b6(0x11a),_0x2899bf),loggerService_1[_0x1941b6(0x115)][_0x1941b6(0x17e)](_0x37c4f1[_0x1941b6(0x1b8)],_0x37c4f1[_0x1941b6(0x158)]?.['settings']?.[_0x1941b6(0x179)]||_0x1941b6(0x17d),_0x1941b6(0x10a),_0x2899bf,{});}}[a42_0x7f3e8e(0x18e)](_0x5500a8){const _0x2bc9ba=a42_0x7f3e8e,_0x22dbe8=_0x5500a8['replace'](/[\s-]/g,'');if(_0x22dbe8[_0x2bc9ba(0x168)]<0x4)return _0x2bc9ba(0x119);return _0x2bc9ba(0x17c)+_0x22dbe8[_0x2bc9ba(0x180)](-0x4);}async['processWebhook'](_0x51b6da){const _0x118c2f=a42_0x7f3e8e;console[_0x118c2f(0x1a6)]('Processing\x20MasterCard\x20webhook:',_0x51b6da);let _0x36b6e2=_0x118c2f(0x187);if(_0x51b6da[_0x118c2f(0xe9)]===0x1&&_0x51b6da['final']===0x1)_0x36b6e2=_0x118c2f(0xe3);else _0x51b6da[_0x118c2f(0xe9)]===0x0&&_0x51b6da[_0x118c2f(0x11c)]===0x0?_0x36b6e2='PENDING':_0x36b6e2=_0x118c2f(0x10d);return{'paymentId':_0x51b6da[_0x118c2f(0x1ba)]||'','status':_0x36b6e2,'amount':_0x51b6da[_0x118c2f(0x1b2)],'currency':_0x51b6da[_0x118c2f(0x14b)]};}[a42_0x7f3e8e(0x17a)](){const _0x1b39bd=a42_0x7f3e8e;console[_0x1b39bd(0x1a6)]('🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...');const _0x47580f=this['statusCheckTimers'][_0x1b39bd(0xfa)];for(const [_0x436574]of this[_0x1b39bd(0x143)]){this[_0x1b39bd(0x15f)](_0x436574);}console[_0x1b39bd(0x1a6)](_0x1b39bd(0x164)+_0x47580f+'\x20MasterCard\x20status\x20check\x20timers');}}exports[a42_0x7f3e8e(0xdb)]=MasterCardService;