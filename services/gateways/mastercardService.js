'use strict';function a42_0x310d(){const _0x1f3bba=['141BIRhDR','encryptRSA','logWhiteDomainError','Unknown\x20error','message','Amount:','last_name','HTTP\x20','/charge_raw','424952oZtuFh','end','now','replace','POST','Private\x20key\x20file\x20not\x20found:\x20','Card\x20Holder:','parse','updatePaymentStatus','/status_decrypted','📝\x20Encrypted\x20data\x20length:','aes-256-ctr','🔐\x20RSA\x20signing\x20successful','settings','\x20\x20\x20-\x20merchant_point_id:','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','342466sOtCfW','===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===','publicEncrypt','\x20MasterCard\x20status\x20check\x20timers','Status\x20decryption\x20failed:\x20','📝\x20Data\x20length:','https://api2.trapay.uk/decrypt.php','payment.failed','sendShopWebhook','amount','psp_public.pem','✅\x20Scheduled\x20','Webhook\x20event\x20','utf8','checkPaymentStatus','/status_raw','webhookEvents','paidAt','none','...','trim','❌\x20Status\x20check\x20#','MasterCardService','signRSA','getOwnPropertyNames','decryptResponse','📊\x20Status\x20check\x20result:','Failed\x20to\x20send\x20MasterCard\x20webhook:','Response\x20Time:','HTTP\x20error!\x20status:\x20','1111','🔐\x20Public\x20key\x20length:\x20','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','encryptAES','maskCardNumber','hasOwnProperty','📝\x20Final\x20request\x20structure:','HTTP\x20Status:','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20','toUpperCase','Order\x20ID:','🔐\x20AES\x20key\x20length:','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','info','/charge_decrypt','60JhLZkS','scheduleStatusChecks','📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','342280eRhwae','SHA256','path','constants','includes','\x20is\x20final\x20(','loggerService','ms)','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','PENDING','randomBytes','order_id','3ds_url','unknown','delete','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20failed\x20for\x20payment\x20','statusCheckTimers','⏰\x20Will\x20check\x20status\x20','-----END','1170VHhzri','privateDecrypt','18781TcFpmf','shopId','📝\x20Signature\x20length:','__setModuleDefault','push','TesSoft\x20Payment\x20System/1.0','expire_year','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','create','===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20===','publicKeyPath','expire_month','final','webhookUrl','🔐\x203DS\x20verification\x20required','mastercard','\x20with\x20status\x20','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20','logWhiteDomainRequest','\x20\x20\x20-\x20info\x20length:','payment_id','\x20\x20\x20-\x20lang:\x20en','log','webhook_send','processWebhook','\x20characters','Status:','desc','/charge','\x20\x20\x20-\x20method:\x20charge','number','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','sendPaymentNotifications','❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):','stringify','validateKeyFiles','💳\x20MasterCard\x20service\x20initialized','toString','FAILED','customerEmail','set','findUnique','Decryption\x20failed:\x20','Error\x20parsing\x20webhook\x20events:','../telegramBotService','🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA','32462WuThvt','toLowerCase',',\x20Desc:\x20','floor','size','text','❌\x20Data\x20being\x20signed:','\x20result:','createdAt','9712896gumSXb','error','prototype','PAID','Failed\x20to\x20decrypt\x20response','\x20status\x20timers\x20for\x20payment\x20','❌\x20PHP\x20decryptor\x20request\x20failed:','❌\x20RSA\x20encryption\x20failed:','defineProperty','base64','createDecipheriv','__importStar','processCardPayment','logWhiteDomainResponse','-----BEGIN','status','first_name','date_success','merchantPointId','crypto','update','🛑\x20Stopped\x20','privateKeyPath','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','✅\x20Payment\x20','/charge_decrypted','shop','charge','❌\x20MasterCard\x20key\x20validation\x20failed:','configurable','❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20','/status','📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','\x20not\x20enabled\x20for\x20shop\x20','📝\x20Data\x20to\x20sign\x20length:','clearStatusTimers','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','🧹\x20Clearing\x20','json','logShopWebhookError','get','from','Processing\x20MasterCard\x20webhook:','length','Result\x20URL:','gatewayOrderId','paid','../../config/database','📊\x20Status\x20check\x20#','Final:','logShopWebhookSent','decryptAES',',\x20body:\x20','key','adminNotes','sendPaymentNotification','✅\x20Payment\x20successful','resolve','sign','Failed\x20to\x20decrypt\x20response\x20via\x20PHP','customerName','\x20status\x20updated\x20to\x20','then','failed','createSign','default','2013930ESmYNw','description','generateAESKey','__esModule','existsSync','Failed\x20to\x20send\x20payment\x20notifications:','readFileSync','payment','currency','Response\x20Body:','forEach','\x20status\x20checks\x20for\x20payment\x20','application/json','https://api.paydmeth.com/api','call','Payment\x20ID:','apiUrl'];a42_0x310d=function(){return _0x1f3bba;};return a42_0x310d();}const a42_0xe05711=a42_0x855d;(function(_0x2a84ff,_0x43b540){const _0x239e5f=a42_0x855d,_0x1540e8=_0x2a84ff();while(!![]){try{const _0x418aa0=-parseInt(_0x239e5f(0x1b1))/0x1+-parseInt(_0x239e5f(0x226))/0x2*(-parseInt(_0x239e5f(0x197))/0x3)+parseInt(_0x239e5f(0x1a0))/0x4*(-parseInt(_0x239e5f(0x1df))/0x5)+parseInt(_0x239e5f(0x1f6))/0x6*(parseInt(_0x239e5f(0x1f8))/0x7)+parseInt(_0x239e5f(0x22f))/0x8+-parseInt(_0x239e5f(0x186))/0x9+parseInt(_0x239e5f(0x1e2))/0xa;if(_0x418aa0===_0x43b540)break;else _0x1540e8['push'](_0x1540e8['shift']());}catch(_0xb52f68){_0x1540e8['push'](_0x1540e8['shift']());}}}(a42_0x310d,0xa942a));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x32dcda,_0xf6cc7c,_0x2f8f57,_0x4adc8c){const _0xc4c592=a42_0x855d;if(_0x4adc8c===undefined)_0x4adc8c=_0x2f8f57;var _0x57ae39=Object['getOwnPropertyDescriptor'](_0xf6cc7c,_0x2f8f57);(!_0x57ae39||('get'in _0x57ae39?!_0xf6cc7c['__esModule']:_0x57ae39['writable']||_0x57ae39[_0xc4c592(0x24c)]))&&(_0x57ae39={'enumerable':!![],'get':function(){return _0xf6cc7c[_0x2f8f57];}}),Object[_0xc4c592(0x237)](_0x32dcda,_0x4adc8c,_0x57ae39);}:function(_0x3b34b5,_0x2b24b5,_0x1af8e5,_0x1d51fe){if(_0x1d51fe===undefined)_0x1d51fe=_0x1af8e5;_0x3b34b5[_0x1d51fe]=_0x2b24b5[_0x1af8e5];}),__setModuleDefault=this&&this[a42_0xe05711(0x1fb)]||(Object[a42_0xe05711(0x200)]?function(_0x1f2ca1,_0x414e97){const _0x43501b=a42_0xe05711;Object[_0x43501b(0x237)](_0x1f2ca1,'default',{'enumerable':!![],'value':_0x414e97});}:function(_0x1bd3fe,_0xa31ec3){const _0x44703d=a42_0xe05711;_0x1bd3fe[_0x44703d(0x185)]=_0xa31ec3;}),__importStar=this&&this[a42_0xe05711(0x23a)]||(function(){var _0x513980=function(_0x1fc6c5){const _0x3bc2da=a42_0x855d;return _0x513980=Object[_0x3bc2da(0x1c9)]||function(_0x2036fb){const _0x588556=_0x3bc2da;var _0x3eab69=[];for(var _0x5945f2 in _0x2036fb)if(Object[_0x588556(0x231)][_0x588556(0x1d4)][_0x588556(0x194)](_0x2036fb,_0x5945f2))_0x3eab69[_0x3eab69[_0x588556(0x25b)]]=_0x5945f2;return _0x3eab69;},_0x513980(_0x1fc6c5);};return function(_0x3f9c76){const _0x436727=a42_0x855d;if(_0x3f9c76&&_0x3f9c76[_0x436727(0x189)])return _0x3f9c76;var _0x45820c={};if(_0x3f9c76!=null){for(var _0x4cc59d=_0x513980(_0x3f9c76),_0x3449bf=0x0;_0x3449bf<_0x4cc59d['length'];_0x3449bf++)if(_0x4cc59d[_0x3449bf]!==_0x436727(0x185))__createBinding(_0x45820c,_0x3f9c76,_0x4cc59d[_0x3449bf]);}return __setModuleDefault(_0x45820c,_0x3f9c76),_0x45820c;};}()),__importDefault=this&&this['__importDefault']||function(_0x29984e){const _0x13f717=a42_0xe05711;return _0x29984e&&_0x29984e[_0x13f717(0x189)]?_0x29984e:{'default':_0x29984e};};Object[a42_0xe05711(0x237)](exports,a42_0xe05711(0x189),{'value':!![]}),exports['MasterCardService']=void 0x0;function a42_0x855d(_0x34b1f5,_0x126819){const _0x310da6=a42_0x310d();return a42_0x855d=function(_0x855d8e,_0x11fa48){_0x855d8e=_0x855d8e-0x174;let _0x27438c=_0x310da6[_0x855d8e];return _0x27438c;},a42_0x855d(_0x34b1f5,_0x126819);}const crypto_1=__importDefault(require(a42_0xe05711(0x242))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0xe05711(0x1e4))),loggerService_1=require('../loggerService');class MasterCardService{constructor(){const _0x4f0df4=a42_0xe05711;this['statusCheckTimers']=new Map(),this[_0x4f0df4(0x196)]=_0x4f0df4(0x193),this[_0x4f0df4(0x241)]=0x67c,this['privateKeyPath']=path_1[_0x4f0df4(0x185)]['join'](process['cwd'](),'keys','private.pem'),this[_0x4f0df4(0x202)]=path_1['default']['join'](process['cwd'](),'keys',_0x4f0df4(0x1bb)),console['log'](_0x4f0df4(0x21c)),console[_0x4f0df4(0x20e)]('🔐\x20Private\x20key\x20path:',this['privateKeyPath']),console[_0x4f0df4(0x20e)]('🔐\x20Public\x20key\x20path:',this[_0x4f0df4(0x202)]),this[_0x4f0df4(0x21b)]();}[a42_0xe05711(0x21b)](){const _0x421513=a42_0xe05711;try{if(!fs_1[_0x421513(0x185)][_0x421513(0x18a)](this[_0x421513(0x245)]))throw new Error(_0x421513(0x1a5)+this['privateKeyPath']);if(!fs_1[_0x421513(0x185)][_0x421513(0x18a)](this[_0x421513(0x202)]))throw new Error('Public\x20key\x20file\x20not\x20found:\x20'+this[_0x421513(0x202)]);const _0x25aa91=fs_1['default']['readFileSync'](this[_0x421513(0x245)],_0x421513(0x1be))[_0x421513(0x1c5)](),_0x5d8146=fs_1[_0x421513(0x185)]['readFileSync'](this['publicKeyPath'],_0x421513(0x1be))[_0x421513(0x1c5)]();if(!_0x25aa91['includes'](_0x421513(0x23d))||!_0x25aa91[_0x421513(0x1e6)](_0x421513(0x1f5)))throw new Error(_0x421513(0x1dc));if(!_0x5d8146[_0x421513(0x1e6)]('-----BEGIN')||!_0x5d8146[_0x421513(0x1e6)](_0x421513(0x1f5)))throw new Error(_0x421513(0x1d1));console[_0x421513(0x20e)]('✅\x20MasterCard\x20key\x20files\x20validated\x20successfully'),console['log']('🔐\x20Private\x20key\x20length:\x20'+_0x25aa91[_0x421513(0x25b)]+_0x421513(0x211)),console[_0x421513(0x20e)](_0x421513(0x1d0)+_0x5d8146[_0x421513(0x25b)]+'\x20characters');}catch(_0x465ed8){console[_0x421513(0x230)](_0x421513(0x24b),_0x465ed8);throw _0x465ed8;}}[a42_0xe05711(0x188)](){const _0x7871b9=a42_0xe05711,_0xc38162=crypto_1[_0x7871b9(0x185)][_0x7871b9(0x1ec)](0x20),_0x2a35c2=crypto_1[_0x7871b9(0x185)][_0x7871b9(0x1ec)](0x10);return{'key':_0xc38162,'iv':_0x2a35c2};}[a42_0xe05711(0x1d2)](_0x198628,_0x58c7ca,_0x4b3a6f){const _0xfcdf78=a42_0xe05711,_0x4fb310=crypto_1[_0xfcdf78(0x185)]['createCipheriv'](_0xfcdf78(0x1ab),_0x58c7ca,_0x4b3a6f);let _0x86e68c=_0x4fb310['update'](_0x198628,'utf8','base64');return _0x86e68c+=_0x4fb310['final'](_0xfcdf78(0x238)),_0x86e68c;}[a42_0xe05711(0x198)](_0x4d8c72,_0x42fce0){const _0x29c974=a42_0xe05711;try{const _0x222636=fs_1[_0x29c974(0x185)]['readFileSync'](this[_0x29c974(0x202)],'utf8')[_0x29c974(0x1c5)](),_0x1ad058={'iv':_0x42fce0[_0x29c974(0x21d)]('base64'),'key':_0x4d8c72[_0x29c974(0x21d)](_0x29c974(0x238))},_0x1ed101=JSON[_0x29c974(0x21a)](_0x1ad058);console[_0x29c974(0x20e)]('🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:',_0x1ed101['length']);const _0x480964=crypto_1[_0x29c974(0x185)][_0x29c974(0x1b3)]({'key':_0x222636,'padding':crypto_1[_0x29c974(0x185)][_0x29c974(0x1e5)]['RSA_PKCS1_PADDING']},Buffer[_0x29c974(0x259)](_0x1ed101));return console[_0x29c974(0x20e)]('✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:',_0x480964[_0x29c974(0x25b)]),_0x480964[_0x29c974(0x21d)](_0x29c974(0x238));}catch(_0x531706){console['error'](_0x29c974(0x236),_0x531706);throw new Error(_0x29c974(0x1d7));}}[a42_0xe05711(0x1c8)](_0x5c7078){const _0x4ae7d1=a42_0xe05711;try{const _0x177350=fs_1[_0x4ae7d1(0x185)][_0x4ae7d1(0x18c)](this[_0x4ae7d1(0x245)],_0x4ae7d1(0x1be))[_0x4ae7d1(0x1c5)](),_0x2a8874=crypto_1[_0x4ae7d1(0x185)][_0x4ae7d1(0x184)](_0x4ae7d1(0x1e3));_0x2a8874[_0x4ae7d1(0x243)](_0x5c7078),_0x2a8874[_0x4ae7d1(0x1a1)]();const _0x41ac1a=_0x2a8874[_0x4ae7d1(0x17e)](_0x177350,_0x4ae7d1(0x238));return console[_0x4ae7d1(0x20e)](_0x4ae7d1(0x1ac)),console[_0x4ae7d1(0x20e)](_0x4ae7d1(0x252),_0x5c7078[_0x4ae7d1(0x25b)]),console[_0x4ae7d1(0x20e)](_0x4ae7d1(0x1fa),_0x41ac1a['length']),_0x41ac1a;}catch(_0x4c2a0f){console[_0x4ae7d1(0x230)]('❌\x20RSA\x20signing\x20failed:',_0x4c2a0f),console['error'](_0x4ae7d1(0x22c),_0x5c7078['substring'](0x0,0xc8)+_0x4ae7d1(0x1c4));throw new Error('Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key');}}[a42_0xe05711(0x177)](_0x4de0f4,_0x2640b4,_0x5927d4){const _0x5b9c80=a42_0xe05711,_0x49b1d1=crypto_1[_0x5b9c80(0x185)][_0x5b9c80(0x239)](_0x5b9c80(0x1ab),_0x2640b4,_0x5927d4);let _0x30e9e4=_0x49b1d1[_0x5b9c80(0x243)](_0x4de0f4,_0x5b9c80(0x238),'utf8');return _0x30e9e4+=_0x49b1d1[_0x5b9c80(0x204)](_0x5b9c80(0x1be)),_0x30e9e4;}async['decryptResponsePhp'](_0x24d0a4,_0x4a9e86){const _0x130ce2=a42_0xe05711;try{const _0x394e11=await fetch(_0x130ce2(0x1b7),{'method':'POST','headers':{'Content-Type':_0x130ce2(0x192)},'body':JSON[_0x130ce2(0x21a)]({'info':_0x24d0a4,'key':_0x4a9e86})});if(!_0x394e11['ok'])throw new Error('PHP\x20decryptor\x20error');return await _0x394e11[_0x130ce2(0x22b)]();}catch(_0x48866b){console[_0x130ce2(0x230)](_0x130ce2(0x235),_0x48866b);throw new Error(_0x130ce2(0x17f));}}[a42_0xe05711(0x1ca)](_0x50ab83,_0x2a632e){const _0x55d518=a42_0xe05711;try{const _0xda066b=fs_1['default']['readFileSync'](this[_0x55d518(0x245)],'utf8')[_0x55d518(0x1c5)](),_0x3b44ec=crypto_1[_0x55d518(0x185)][_0x55d518(0x1f7)](_0xda066b,Buffer['from'](_0x2a632e,_0x55d518(0x238))),_0x582665=JSON['parse'](_0x3b44ec[_0x55d518(0x21d)]()),_0x599e7f=Buffer[_0x55d518(0x259)](_0x582665[_0x55d518(0x179)],_0x55d518(0x238)),_0x7c2c49=Buffer[_0x55d518(0x259)](_0x582665['iv'],_0x55d518(0x238));return this[_0x55d518(0x177)](_0x50ab83,_0x599e7f,_0x7c2c49);}catch(_0x5a3909){throw new Error(_0x55d518(0x233));}}async[a42_0xe05711(0x23b)](_0x4f3503){const _0x31859d=a42_0xe05711,{paymentId:_0x16c1d7,orderId:_0x4af600,amount:_0x1fce8a,currency:_0x335bd2,cardData:_0x19d128,resultUrl:_0x1f1401,returnUrl:_0x59c6dd,cardHolder:_0x15b96e,browser:_0x81d7af}=_0x4f3503;console[_0x31859d(0x20e)](_0x31859d(0x201)),console['log']('Payment\x20ID:',_0x16c1d7),console[_0x31859d(0x20e)](_0x31859d(0x1da),_0x4af600),console[_0x31859d(0x20e)](_0x31859d(0x19c),_0x1fce8a,_0x335bd2),console[_0x31859d(0x20e)]('Card\x20Number:',this['maskCardNumber'](_0x19d128[_0x31859d(0x216)])),console[_0x31859d(0x20e)](_0x31859d(0x1a6),_0x15b96e[_0x31859d(0x23f)]+'\x20'+_0x15b96e[_0x31859d(0x19d)]),console['log']('Return\x20URL:',_0x59c6dd),console[_0x31859d(0x20e)](_0x31859d(0x25c),_0x1f1401);const _0x326e66={'amount':_0x1fce8a,'currency':_0x335bd2[_0x31859d(0x1d9)](),'order_id':_0x4af600,'result_url':_0x1f1401,'return_url':_0x59c6dd,'card':{'number':_0x19d128[_0x31859d(0x216)],'expire_month':_0x19d128[_0x31859d(0x203)],'expire_year':_0x19d128[_0x31859d(0x1fe)],'cvv':_0x19d128['cvv']},'card_holder':_0x15b96e,'browser':_0x81d7af},_0x5eac40=JSON[_0x31859d(0x21a)](_0x326e66);console['log']('💾\x20Payment\x20data\x20prepared'),console[_0x31859d(0x20e)](_0x31859d(0x246)),console[_0x31859d(0x20e)](_0x5eac40),console['log'](_0x31859d(0x1b6),_0x5eac40[_0x31859d(0x25b)]);try{const {key:_0x2f11b4,iv:_0x389bd6}=this[_0x31859d(0x188)]();console[_0x31859d(0x20e)]('🔐\x20AES\x20key\x20and\x20IV\x20generated'),console[_0x31859d(0x20e)](_0x31859d(0x1db),_0x2f11b4[_0x31859d(0x25b)]),console[_0x31859d(0x20e)]('🔐\x20AES\x20IV\x20length:',_0x389bd6[_0x31859d(0x25b)]);const _0x311828=this[_0x31859d(0x1d2)](_0x5eac40,_0x2f11b4,_0x389bd6);console[_0x31859d(0x20e)]('🔐\x20Data\x20encrypted\x20with\x20AES'),console[_0x31859d(0x20e)](_0x31859d(0x1aa),_0x311828[_0x31859d(0x25b)]);const _0x23d50f=this[_0x31859d(0x198)](_0x2f11b4,_0x389bd6);console[_0x31859d(0x20e)](_0x31859d(0x225)),console['log']('📝\x20Encrypted\x20key\x20length:',_0x23d50f[_0x31859d(0x25b)]);const _0x2f02fa=this['signRSA'](_0x5eac40);console[_0x31859d(0x20e)]('🔐\x20Data\x20signed\x20with\x20RSA'),console[_0x31859d(0x20e)](_0x31859d(0x1fa),_0x2f02fa['length']);const _0x23ff08={'merchant_point_id':this['merchantPointId'],'method':_0x31859d(0x24a),'info':_0x311828,'key':_0x23d50f,'sign':_0x2f02fa,'lang':'en'};console[_0x31859d(0x20e)](_0x31859d(0x217)),console['log'](_0x31859d(0x1d5)),console[_0x31859d(0x20e)](_0x31859d(0x1ae),this[_0x31859d(0x241)]),console[_0x31859d(0x20e)](_0x31859d(0x215)),console['log'](_0x31859d(0x20b),_0x311828['length']),console[_0x31859d(0x20e)]('\x20\x20\x20-\x20key\x20length:',_0x23d50f[_0x31859d(0x25b)]),console[_0x31859d(0x20e)]('\x20\x20\x20-\x20sign\x20length:',_0x2f02fa['length']),console[_0x31859d(0x20e)](_0x31859d(0x20d)),loggerService_1['loggerService'][_0x31859d(0x20a)](_0x31859d(0x207),_0x31859d(0x214),'POST',{'merchant_point_id':this[_0x31859d(0x241)],'method':'charge','lang':'en'});const _0xd642e0=Date[_0x31859d(0x1a2)](),_0x617a1=await fetch(this[_0x31859d(0x196)],{'method':_0x31859d(0x1a4),'headers':{'Content-Type':_0x31859d(0x192),'Accept':_0x31859d(0x192),'User-Agent':_0x31859d(0x1fd)},'body':JSON[_0x31859d(0x21a)](_0x23ff08)}),_0x418614=Date[_0x31859d(0x1a2)]()-_0xd642e0;console[_0x31859d(0x20e)]('===\x20MASTERCARD\x20API\x20RESPONSE\x20==='),console[_0x31859d(0x20e)](_0x31859d(0x212),_0x617a1['status']),console[_0x31859d(0x20e)](_0x31859d(0x1cd),_0x418614+'ms');if(!_0x617a1['ok']){const _0x2db5b2=await _0x617a1[_0x31859d(0x22b)]();console[_0x31859d(0x230)](_0x31859d(0x1d6),_0x617a1[_0x31859d(0x23e)]),console[_0x31859d(0x230)](_0x31859d(0x18f),_0x2db5b2),loggerService_1['loggerService'][_0x31859d(0x23c)](_0x31859d(0x207),_0x31859d(0x19f),_0x617a1[_0x31859d(0x23e)],_0x2db5b2,_0x418614),loggerService_1[_0x31859d(0x1e8)][_0x31859d(0x199)](_0x31859d(0x207),_0x31859d(0x214),_0x31859d(0x19e)+_0x617a1[_0x31859d(0x23e)]+':\x20'+_0x2db5b2);throw new Error(_0x31859d(0x1ce)+_0x617a1[_0x31859d(0x23e)]+_0x31859d(0x178)+_0x2db5b2);}const _0x16fb49=await _0x617a1[_0x31859d(0x256)]();loggerService_1[_0x31859d(0x1e8)][_0x31859d(0x23c)](_0x31859d(0x207),_0x31859d(0x19f),_0x617a1[_0x31859d(0x23e)],_0x16fb49,_0x418614),console[_0x31859d(0x20e)](_0x31859d(0x1b2));let _0x6715c2=_0x16fb49;if(_0x16fb49[_0x31859d(0x1dd)]&&_0x16fb49[_0x31859d(0x179)]&&_0x16fb49[_0x31859d(0x17e)]){console['log']('🔐\x20Response\x20is\x20encrypted,\x20decrypting...');try{const _0x2bf061=await this['decryptResponsePhp'](_0x16fb49[_0x31859d(0x1dd)],_0x16fb49[_0x31859d(0x179)]);_0x6715c2=JSON[_0x31859d(0x1a7)](_0x2bf061),console[_0x31859d(0x20e)]('✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)'),loggerService_1[_0x31859d(0x1e8)]['logWhiteDomainResponse'](_0x31859d(0x207),_0x31859d(0x248),_0x617a1[_0x31859d(0x23e)],_0x6715c2,_0x418614),console[_0x31859d(0x20e)](_0x31859d(0x1af));}catch(_0x58832d){console[_0x31859d(0x230)](_0x31859d(0x219),_0x58832d),loggerService_1[_0x31859d(0x1e8)][_0x31859d(0x199)](_0x31859d(0x207),_0x31859d(0x1de),_0x31859d(0x222)+_0x58832d),_0x6715c2=_0x16fb49;}}else loggerService_1[_0x31859d(0x1e8)][_0x31859d(0x23c)](_0x31859d(0x207),_0x31859d(0x248),_0x617a1[_0x31859d(0x23e)],_0x6715c2,_0x418614),console[_0x31859d(0x20e)](_0x31859d(0x24f));console[_0x31859d(0x20e)](_0x31859d(0x212),_0x6715c2[_0x31859d(0x23e)]),console[_0x31859d(0x20e)](_0x31859d(0x175),_0x6715c2[_0x31859d(0x204)]),console[_0x31859d(0x20e)](_0x31859d(0x195),_0x6715c2['payment_id']),console[_0x31859d(0x20e)]('3DS\x20URL:',_0x6715c2[_0x31859d(0x1ee)]||_0x31859d(0x1c3));if(_0x6715c2['status']===0x64&&_0x6715c2[_0x31859d(0x204)]===0x1)return console['log'](_0x31859d(0x17c)),{'gateway_payment_id':_0x6715c2[_0x31859d(0x20c)]?.['toString'](),'payment_url':_0x59c6dd,'requires_3ds':![],'status':_0x31859d(0x232),'final':!![]};if(_0x6715c2[_0x31859d(0x1ee)])return console[_0x31859d(0x20e)](_0x31859d(0x206)),this[_0x31859d(0x1e0)](_0x16c1d7,_0x4af600,_0x6715c2['payment_id']?.[_0x31859d(0x21d)]()||_0x4af600),{'gateway_payment_id':_0x6715c2[_0x31859d(0x20c)]?.[_0x31859d(0x21d)](),'payment_url':_0x6715c2['3ds_url'],'requires_3ds':!![],'threeds_url':_0x6715c2['3ds_url'],'status':_0x31859d(0x1eb),'final':![]};let _0x445b47=_0x6715c2['desc']||_0x6715c2[_0x31859d(0x19b)]||_0x31859d(0x19a),_0x4b01f9=_0x6715c2[_0x31859d(0x23e)],_0xed3651=_0x6715c2[_0x31859d(0x204)];return console[_0x31859d(0x20e)](_0x31859d(0x24d)+_0x4b01f9+',\x20Final:\x20'+_0xed3651+_0x31859d(0x228)+_0x445b47),{'gateway_payment_id':_0x6715c2[_0x31859d(0x20c)]?.[_0x31859d(0x21d)](),'payment_url':_0x59c6dd,'requires_3ds':![],'status':_0x31859d(0x21e),'final':!![]};}catch(_0x145eaf){console['error'](_0x31859d(0x1ea)),console[_0x31859d(0x230)]('Error\x20details:',_0x145eaf),loggerService_1[_0x31859d(0x1e8)][_0x31859d(0x199)](_0x31859d(0x207),'/charge',_0x145eaf);throw new Error(_0x31859d(0x250)+(_0x145eaf instanceof Error?_0x145eaf['message']:'Unknown\x20error'));}}async[a42_0xe05711(0x1bf)](_0x11fd8b,_0x1c9232){const _0x1a8924=a42_0xe05711;console[_0x1a8924(0x20e)]('📊\x20Checking\x20MasterCard\x20payment\x20status:\x20'+_0x11fd8b+'\x20('+_0x1c9232+')');try{const _0x2c0b1b={'payment_id':_0x11fd8b,'order_id':_0x1c9232},_0x483ba3=JSON[_0x1a8924(0x21a)](_0x2c0b1b),{key:_0x2d26ef,iv:_0x5d55c8}=this['generateAESKey'](),_0xadabc4=this['encryptAES'](_0x483ba3,_0x2d26ef,_0x5d55c8),_0x880390=this[_0x1a8924(0x198)](_0x2d26ef,_0x5d55c8),_0x22cf15=this[_0x1a8924(0x1c8)](_0x483ba3),_0xa5d045={'merchant_point_id':this[_0x1a8924(0x241)],'method':_0x1a8924(0x23e),'info':_0xadabc4,'key':_0x880390,'sign':_0x22cf15,'lang':'en'};loggerService_1[_0x1a8924(0x1e8)]['logWhiteDomainRequest'](_0x1a8924(0x207),_0x1a8924(0x24e),_0x1a8924(0x1a4),{'merchant_point_id':this[_0x1a8924(0x241)],'method':_0x1a8924(0x23e),'lang':'en'});const _0xfaddcd=Date[_0x1a8924(0x1a2)](),_0x586f26=await fetch(this[_0x1a8924(0x196)],{'method':_0x1a8924(0x1a4),'headers':{'Content-Type':_0x1a8924(0x192),'Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0xa5d045)}),_0x5b5f87=Date[_0x1a8924(0x1a2)]()-_0xfaddcd;if(!_0x586f26['ok']){const _0x54c1ad=await _0x586f26[_0x1a8924(0x22b)]();loggerService_1['loggerService'][_0x1a8924(0x23c)](_0x1a8924(0x207),_0x1a8924(0x1c0),_0x586f26['status'],_0x54c1ad,_0x5b5f87);throw new Error(_0x1a8924(0x1ce)+_0x586f26[_0x1a8924(0x23e)]);}const _0x1ba48e=await _0x586f26[_0x1a8924(0x256)]();loggerService_1[_0x1a8924(0x1e8)]['logWhiteDomainResponse'](_0x1a8924(0x207),_0x1a8924(0x1c0),_0x586f26[_0x1a8924(0x23e)],_0x1ba48e,_0x5b5f87);let _0xeec193=_0x1ba48e;if(_0x1ba48e['info']&&_0x1ba48e[_0x1a8924(0x179)]&&_0x1ba48e[_0x1a8924(0x17e)]){console[_0x1a8924(0x20e)](_0x1a8924(0x1ff));try{const _0x3561b6=this[_0x1a8924(0x1ca)](_0x1ba48e[_0x1a8924(0x1dd)],_0x1ba48e[_0x1a8924(0x179)]);_0xeec193=JSON[_0x1a8924(0x1a7)](_0x3561b6),console[_0x1a8924(0x20e)]('✅\x20Status\x20response\x20decrypted\x20successfully'),loggerService_1[_0x1a8924(0x1e8)][_0x1a8924(0x23c)](_0x1a8924(0x207),_0x1a8924(0x1a9),_0x586f26[_0x1a8924(0x23e)],_0xeec193,_0x5b5f87),console['log'](_0x1a8924(0x254));}catch(_0x542579){console['error']('❌\x20Failed\x20to\x20decrypt\x20status\x20response:',_0x542579),loggerService_1[_0x1a8924(0x1e8)][_0x1a8924(0x199)](_0x1a8924(0x207),'/status_decrypt',_0x1a8924(0x1b5)+_0x542579),_0xeec193=_0x1ba48e;}}else loggerService_1[_0x1a8924(0x1e8)][_0x1a8924(0x23c)](_0x1a8924(0x207),_0x1a8924(0x1a9),_0x586f26[_0x1a8924(0x23e)],_0xeec193,_0x5b5f87),console[_0x1a8924(0x20e)](_0x1a8924(0x1e1));console[_0x1a8924(0x20e)](_0x1a8924(0x1cb),{'status':_0xeec193['status'],'final':_0xeec193[_0x1a8924(0x204)],'payment_id':_0xeec193[_0x1a8924(0x20c)],'desc':_0xeec193['desc']});let _0xd251be=_0x1a8924(0x1eb);if(_0xeec193[_0x1a8924(0x23e)]===0x1&&_0xeec193['final']===0x1)_0xd251be=_0x1a8924(0x232);else _0xeec193[_0x1a8924(0x23e)]===0x0&&_0xeec193['final']===0x0?_0xd251be=_0x1a8924(0x1eb):_0xd251be='FAILED';return{'status':_0xd251be,'final':_0xeec193['final']===0x1,'amount':_0xeec193[_0x1a8924(0x1ba)],'currency':_0xeec193['currency'],'date_success':_0xeec193[_0x1a8924(0x240)],'description':_0xeec193[_0x1a8924(0x213)]};}catch(_0x520db6){console['error']('MasterCard\x20status\x20check\x20error:',_0x520db6),loggerService_1[_0x1a8924(0x1e8)][_0x1a8924(0x199)](_0x1a8924(0x207),'/status',_0x520db6);throw new Error(_0x1a8924(0x1d8)+(_0x520db6 instanceof Error?_0x520db6[_0x1a8924(0x19b)]:_0x1a8924(0x19a)));}}[a42_0xe05711(0x1e0)](_0x372aaa,_0x2563b2,_0x4da147){const _0x16ae98=a42_0xe05711;console[_0x16ae98(0x20e)]('⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20'+_0x372aaa+'\x20('+_0x4da147+')'),this['clearStatusTimers'](_0x372aaa);const _0xe9d4df=[],_0x183a81=0x5*0x3c*0x3e8,_0x217bed=0x2*0x3c*0x3c*0x3e8,_0x4af6e8=Math[_0x16ae98(0x229)](_0x217bed/_0x183a81);console[_0x16ae98(0x20e)](_0x16ae98(0x1f4)+_0x4af6e8+_0x16ae98(0x1b0));for(let _0x4bd958=0x1;_0x4bd958<=_0x4af6e8;_0x4bd958++){const _0x506544=setTimeout(async()=>{const _0x3b4f54=_0x16ae98;console['log']('🔍\x20MasterCard\x20status\x20check\x20#'+_0x4bd958+'/'+_0x4af6e8+'\x20for\x20payment\x20'+_0x372aaa);try{const _0x3a2f4c=await this[_0x3b4f54(0x1bf)](_0x4da147,_0x2563b2);console[_0x3b4f54(0x20e)](_0x3b4f54(0x174)+_0x4bd958+_0x3b4f54(0x22d),_0x3a2f4c),_0x3a2f4c[_0x3b4f54(0x204)]&&(console[_0x3b4f54(0x20e)](_0x3b4f54(0x247)+_0x372aaa+_0x3b4f54(0x1e7)+_0x3a2f4c[_0x3b4f54(0x23e)]+'),\x20stopping\x20status\x20checks'),this[_0x3b4f54(0x253)](_0x372aaa),await this[_0x3b4f54(0x1a8)](_0x372aaa,_0x3a2f4c[_0x3b4f54(0x23e)],_0x3a2f4c));}catch(_0x85aeb0){console[_0x3b4f54(0x230)](_0x3b4f54(0x1c6)+_0x4bd958+_0x3b4f54(0x1f2)+_0x372aaa+':',_0x85aeb0);}},_0x4bd958*_0x183a81);_0xe9d4df[_0x16ae98(0x1fc)](_0x506544);}this[_0x16ae98(0x1f3)][_0x16ae98(0x220)](_0x372aaa,_0xe9d4df),console[_0x16ae98(0x20e)](_0x16ae98(0x1bc)+_0x4af6e8+_0x16ae98(0x191)+_0x372aaa);}[a42_0xe05711(0x253)](_0x307372){const _0x2b8633=a42_0xe05711,_0x3c7019=this['statusCheckTimers'][_0x2b8633(0x258)](_0x307372);_0x3c7019&&(console[_0x2b8633(0x20e)](_0x2b8633(0x255)+_0x3c7019['length']+_0x2b8633(0x234)+_0x307372),_0x3c7019[_0x2b8633(0x190)]((_0x41c726,_0x2a3d4f)=>{clearTimeout(_0x41c726);}),this[_0x2b8633(0x1f3)][_0x2b8633(0x1f0)](_0x307372));}async[a42_0xe05711(0x1a8)](_0x4e9f25,_0x4b35d6,_0x5b98e6){const _0x1ae38d=a42_0xe05711;try{const _0x3c8607=(await Promise['resolve']()['then'](()=>__importStar(require(_0x1ae38d(0x25f)))))[_0x1ae38d(0x185)],_0x223079={'status':_0x4b35d6[_0x1ae38d(0x1d9)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x4b35d6===_0x1ae38d(0x232)&&(_0x223079[_0x1ae38d(0x1c2)]=new Date()),_0x5b98e6[_0x1ae38d(0x187)]&&(_0x223079[_0x1ae38d(0x17a)]='MasterCard:\x20'+_0x5b98e6['description']),await _0x3c8607['payment'][_0x1ae38d(0x243)]({'where':{'id':_0x4e9f25},'data':_0x223079}),console[_0x1ae38d(0x20e)](_0x1ae38d(0x247)+_0x4e9f25+_0x1ae38d(0x181)+_0x4b35d6),await this[_0x1ae38d(0x218)](_0x4e9f25,_0x4b35d6);}catch(_0x39bdc6){console[_0x1ae38d(0x230)](_0x1ae38d(0x209)+_0x4e9f25+':',_0x39bdc6);}}async[a42_0xe05711(0x218)](_0xecf4fd,_0x1a67a5){const _0x3f12f8=a42_0xe05711;try{const _0x46dfe5=(await Promise[_0x3f12f8(0x17d)]()[_0x3f12f8(0x182)](()=>__importStar(require(_0x3f12f8(0x25f)))))[_0x3f12f8(0x185)],{telegramBotService:_0x1055a2}=await Promise[_0x3f12f8(0x17d)]()[_0x3f12f8(0x182)](()=>__importStar(require(_0x3f12f8(0x224)))),_0x39be5d=await _0x46dfe5[_0x3f12f8(0x18d)][_0x3f12f8(0x221)]({'where':{'id':_0xecf4fd},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x39be5d)return;const _0x570131={'PAID':_0x3f12f8(0x25e),'FAILED':_0x3f12f8(0x183)},_0x22e968=_0x570131[_0x1a67a5];_0x22e968&&await _0x1055a2[_0x3f12f8(0x17b)](_0x39be5d[_0x3f12f8(0x1f9)],_0x39be5d,_0x22e968),await this[_0x3f12f8(0x1b9)](_0x39be5d,_0x1a67a5);}catch(_0x320f3f){console[_0x3f12f8(0x230)](_0x3f12f8(0x18b),_0x320f3f);}}async[a42_0xe05711(0x1b9)](_0x2c33ab,_0x5948aa){const _0x2ab124=a42_0xe05711,_0x16ecda=Date[_0x2ab124(0x1a2)]();try{const _0x1c4f99=_0x2c33ab[_0x2ab124(0x249)],_0x112552=_0x1c4f99['settings'];if(!_0x112552?.[_0x2ab124(0x205)]){console[_0x2ab124(0x20e)](_0x2ab124(0x1f1)+_0x1c4f99['id']);return;}const _0x3e1c97=_0x5948aa===_0x2ab124(0x232)?'payment.success':_0x2ab124(0x1b8);let _0x2682d9=[];if(_0x112552[_0x2ab124(0x1c1)])try{_0x2682d9=Array['isArray'](_0x112552[_0x2ab124(0x1c1)])?_0x112552['webhookEvents']:JSON[_0x2ab124(0x1a7)](_0x112552[_0x2ab124(0x1c1)]);}catch(_0x2645a6){console[_0x2ab124(0x230)](_0x2ab124(0x223),_0x2645a6),_0x2682d9=[];}if(!_0x2682d9[_0x2ab124(0x1e6)](_0x3e1c97)){console[_0x2ab124(0x20e)](_0x2ab124(0x1bd)+_0x3e1c97+_0x2ab124(0x251)+_0x1c4f99['id']);return;}const _0x1a2add={'event':_0x3e1c97,'payment':{'id':_0x2c33ab['id'],'order_id':_0x2c33ab['orderId'],'gateway_order_id':_0x2c33ab[_0x2ab124(0x25d)],'gateway':_0x2ab124(0x1cf),'amount':_0x2c33ab[_0x2ab124(0x1ba)],'currency':_0x2c33ab[_0x2ab124(0x18e)],'status':_0x5948aa[_0x2ab124(0x227)](),'customer_email':_0x2c33ab[_0x2ab124(0x21f)],'customer_name':_0x2c33ab[_0x2ab124(0x180)],'created_at':_0x2c33ab[_0x2ab124(0x22e)],'updated_at':new Date()}},_0x32b390=await fetch(_0x112552[_0x2ab124(0x205)],{'method':'POST','headers':{'Content-Type':_0x2ab124(0x192),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x2ab124(0x21a)](_0x1a2add)}),_0x59850c=Date[_0x2ab124(0x1a2)]()-_0x16ecda;loggerService_1[_0x2ab124(0x1e8)][_0x2ab124(0x176)](_0x2c33ab[_0x2ab124(0x1f9)],_0x112552[_0x2ab124(0x205)],_0x3e1c97,_0x32b390[_0x2ab124(0x23e)],_0x59850c,_0x1a2add),console[_0x2ab124(0x20e)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x112552[_0x2ab124(0x205)]+_0x2ab124(0x208)+_0x32b390[_0x2ab124(0x23e)]+'\x20('+_0x59850c+_0x2ab124(0x1e9));}catch(_0x5933fb){console['error'](_0x2ab124(0x1cc),_0x5933fb),loggerService_1[_0x2ab124(0x1e8)][_0x2ab124(0x257)](_0x2c33ab['shopId'],_0x2c33ab[_0x2ab124(0x249)]?.[_0x2ab124(0x1ad)]?.[_0x2ab124(0x205)]||_0x2ab124(0x1ef),_0x2ab124(0x20f),_0x5933fb,{});}}[a42_0xe05711(0x1d3)](_0x224282){const _0x3b66cb=a42_0xe05711,_0x5b262d=_0x224282[_0x3b66cb(0x1a3)](/[\s-]/g,'');if(_0x5b262d[_0x3b66cb(0x25b)]<0x4)return'****';return'****\x20****\x20****\x20'+_0x5b262d['slice'](-0x4);}async[a42_0xe05711(0x210)](_0x48553e){const _0x40131f=a42_0xe05711;console['log'](_0x40131f(0x25a),_0x48553e);let _0x27278a='PENDING';if(_0x48553e[_0x40131f(0x23e)]===0x1&&_0x48553e['final']===0x1)_0x27278a=_0x40131f(0x232);else _0x48553e['status']===0x0&&_0x48553e[_0x40131f(0x204)]===0x0?_0x27278a=_0x40131f(0x1eb):_0x27278a='FAILED';return{'paymentId':_0x48553e[_0x40131f(0x1ed)]||'','status':_0x27278a,'amount':_0x48553e['amount'],'currency':_0x48553e[_0x40131f(0x18e)]};}['stopAllStatusChecks'](){const _0x430433=a42_0xe05711;console[_0x430433(0x20e)]('🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...');const _0xcf8fd9=this[_0x430433(0x1f3)][_0x430433(0x22a)];for(const [_0x4ca486]of this[_0x430433(0x1f3)]){this[_0x430433(0x253)](_0x4ca486);}console[_0x430433(0x20e)](_0x430433(0x244)+_0xcf8fd9+_0x430433(0x1b4));}}exports[a42_0xe05711(0x1c7)]=MasterCardService;