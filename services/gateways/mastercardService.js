'use strict';const a42_0x152485=a42_0x4c2e;(function(_0x24d652,_0x4fa0e7){const _0x330a4e=a42_0x4c2e,_0x55d330=_0x24d652();while(!![]){try{const _0x11ac1d=parseInt(_0x330a4e(0x113))/0x1+parseInt(_0x330a4e(0x153))/0x2+parseInt(_0x330a4e(0x163))/0x3*(-parseInt(_0x330a4e(0x103))/0x4)+-parseInt(_0x330a4e(0x188))/0x5+-parseInt(_0x330a4e(0x18d))/0x6+-parseInt(_0x330a4e(0x13b))/0x7*(-parseInt(_0x330a4e(0x161))/0x8)+parseInt(_0x330a4e(0x131))/0x9*(parseInt(_0x330a4e(0x1db))/0xa);if(_0x11ac1d===_0x4fa0e7)break;else _0x55d330['push'](_0x55d330['shift']());}catch(_0x258569){_0x55d330['push'](_0x55d330['shift']());}}}(a42_0x2a6b,0x784ee));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x538774,_0x493ba9,_0x4c8cf2,_0x458ede){const _0x434fe6=a42_0x4c2e;if(_0x458ede===undefined)_0x458ede=_0x4c8cf2;var _0x41b28e=Object[_0x434fe6(0x15b)](_0x493ba9,_0x4c8cf2);(!_0x41b28e||('get'in _0x41b28e?!_0x493ba9[_0x434fe6(0x127)]:_0x41b28e['writable']||_0x41b28e[_0x434fe6(0x167)]))&&(_0x41b28e={'enumerable':!![],'get':function(){return _0x493ba9[_0x4c8cf2];}}),Object['defineProperty'](_0x538774,_0x458ede,_0x41b28e);}:function(_0x21701e,_0x3ae450,_0x25b8cf,_0x2cb839){if(_0x2cb839===undefined)_0x2cb839=_0x25b8cf;_0x21701e[_0x2cb839]=_0x3ae450[_0x25b8cf];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x3daf16,_0x2fb1c0){const _0x347f50=a42_0x4c2e;Object['defineProperty'](_0x3daf16,_0x347f50(0x178),{'enumerable':!![],'value':_0x2fb1c0});}:function(_0x8d3974,_0x2c1176){const _0x1b5e64=a42_0x4c2e;_0x8d3974[_0x1b5e64(0x178)]=_0x2c1176;}),__importStar=this&&this[a42_0x152485(0x1b1)]||(function(){var _0x174e58=function(_0x15cd57){const _0x14c162=a42_0x4c2e;return _0x174e58=Object[_0x14c162(0x19d)]||function(_0x13faef){const _0x26f6ec=_0x14c162;var _0x5e6dc9=[];for(var _0x2cecbe in _0x13faef)if(Object[_0x26f6ec(0x15e)]['hasOwnProperty'][_0x26f6ec(0x18f)](_0x13faef,_0x2cecbe))_0x5e6dc9[_0x5e6dc9['length']]=_0x2cecbe;return _0x5e6dc9;},_0x174e58(_0x15cd57);};return function(_0x1da989){const _0x1073a5=a42_0x4c2e;if(_0x1da989&&_0x1da989['__esModule'])return _0x1da989;var _0x1ba025={};if(_0x1da989!=null){for(var _0xb246c2=_0x174e58(_0x1da989),_0x4dc52d=0x0;_0x4dc52d<_0xb246c2[_0x1073a5(0x196)];_0x4dc52d++)if(_0xb246c2[_0x4dc52d]!=='default')__createBinding(_0x1ba025,_0x1da989,_0xb246c2[_0x4dc52d]);}return __setModuleDefault(_0x1ba025,_0x1da989),_0x1ba025;};}()),__importDefault=this&&this[a42_0x152485(0x16e)]||function(_0x4e5909){return _0x4e5909&&_0x4e5909['__esModule']?_0x4e5909:{'default':_0x4e5909};};Object[a42_0x152485(0x14c)](exports,a42_0x152485(0x127),{'value':!![]}),exports[a42_0x152485(0x186)]=void 0x0;function a42_0x4c2e(_0x366a1f,_0x1ffe5d){const _0x2a6bee=a42_0x2a6b();return a42_0x4c2e=function(_0x4c2efc,_0x5d3466){_0x4c2efc=_0x4c2efc-0xfc;let _0x451ac4=_0x2a6bee[_0x4c2efc];return _0x451ac4;},a42_0x4c2e(_0x366a1f,_0x1ffe5d);}const crypto_1=__importDefault(require(a42_0x152485(0x1cb))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0x152485(0x10d))),loggerService_1=require('../loggerService');function a42_0x2a6b(){const _0x5e7fc0=['decryptResponse','createCipheriv','🔐\x20AES\x20IV\x20length:','/charge_decrypted','update','privateDecrypt','push','SHA256','TesSoft\x20Payment\x20System/1.0','__importStar','/status_decrypted','log','❌\x20Status\x20check\x20#','PENDING','cvv','Webhook\x20event\x20','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','sendShopWebhook','number','publicKeyPath','💾\x20Payment\x20data\x20prepared','webhookUrl','MasterCard\x20status\x20check\x20error:','constants','privateKeyPath','/status','https://api.paydmeth.com/api','payment','Error\x20parsing\x20webhook\x20events:','createSign','date_success','now','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','webhookEvents','findUnique','crypto','Processing\x20MasterCard\x20webhook:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','POST','❌\x20RSA\x20encryption\x20failed:','MasterCard\x20webhook\x20sent\x20to\x20','charge','unknown','encryptRSA','Payment\x20ID:','),\x20stopping\x20status\x20checks','****','psp_public.pem','HTTP\x20','json','\x20not\x20enabled\x20for\x20shop\x20','21090FnGLZb','Failed\x20to\x20decrypt\x20response\x20via\x20PHP','toLowerCase','Response\x20Time:','Status\x20decryption\x20failed:\x20','delete','toString','MasterCard:\x20','\x20\x20\x20-\x20method:\x20charge','📝\x20Encrypted\x20data\x20length:','amount','scheduleStatusChecks','last_name','3ds_url','Status:','✅\x20Payment\x20successful','\x20is\x20final\x20(','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','toUpperCase','Unknown\x20error','processCardPayment','set','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','4wvfGIQ','1111','❌\x20RSA\x20signing\x20failed:','shop','isArray','Public\x20key\x20file\x20not\x20found:\x20','\x20\x20\x20-\x20lang:\x20en','existsSync','/status_raw','logWhiteDomainResponse','path','🔐\x203DS\x20verification\x20required','merchantPointId','📝\x20Final\x20request\x20structure:','✅\x20Payment\x20','join','646713IwWEXw','\x20result:','Error\x20details:','ms)','../telegramBotService','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','order_id','cwd','🔐\x20AES\x20key\x20length:','webhook_send','generateAESKey','desc','error','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','statusCheckTimers','paidAt','createdAt','settings','\x20status\x20timers\x20for\x20payment\x20','\x20\x20\x20-\x20merchant_point_id:','__esModule','signRSA','expire_year','✅\x20Status\x20response\x20decrypted\x20successfully','payment.success','/charge_raw','\x20with\x20status\x20',',\x20Desc:\x20','validateKeyFiles','sendPaymentNotification','3294eqrZYB','none','RSA_PKCS1_PADDING','📝\x20Data\x20length:','📝\x20Data\x20to\x20sign\x20length:','apiUrl','payment_id','🔐\x20Private\x20key\x20path:','clearStatusTimers','🔐\x20Data\x20encrypted\x20with\x20AES','7xesoxe','includes','shopId','PAID','randomBytes','/charge','replace','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','description','\x20characters','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','❌\x20Data\x20being\x20signed:','-----BEGIN','trim','Decryption\x20failed:\x20','utf8','readFileSync','defineProperty','get','key','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','\x20failed\x20for\x20payment\x20','sign','base64','1128490WMgueG','Private\x20key\x20file\x20not\x20found:\x20','message','🧹\x20Clearing\x20','first_name','Response\x20Body:','Amount:','FAILED','getOwnPropertyDescriptor','❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20','parse','prototype','🔐\x20Data\x20signed\x20with\x20RSA','3DS\x20URL:','2970568jUeePP','===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===','2119485zqTBOW','Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20','-----END','final','configurable','keys','🔐\x20Private\x20key\x20length:\x20','size','📝\x20Signature\x20length:','\x20status\x20checks\x20for\x20payment\x20','adminNotes','__importDefault','../../config/database','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','then','logWhiteDomainRequest','maskCardNumber','/status_decrypt','loggerService','Card\x20Holder:','status','default','slice','...','mastercard','sendPaymentNotifications','resolve','updatePaymentStatus','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','application/json','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','📊\x20Status\x20check\x20result:','from','system','📝\x20Encrypted\x20key\x20length:','MasterCardService','🔐\x20Public\x20key\x20path:','3372000PZpbxZ','customerName','decryptResponsePhp','decryptAES','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','2882976ajKWir','text','call','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','info','❌\x20PHP\x20decryptor\x20request\x20failed:','\x20\x20\x20-\x20sign\x20length:','https://api2.trapay.uk/decrypt.php','❌\x20Failed\x20to\x20decrypt\x20status\x20response:','length','encryptAES','stringify','currency','payment.failed','🛑\x20Stopped\x20','HTTP\x20error!\x20status:\x20','getOwnPropertyNames','/charge_decrypt','expire_month','PHP\x20decryptor\x20error','Result\x20URL:','logShopWebhookSent','createDecipheriv','Final:','logWhiteDomainError','Failed\x20to\x20send\x20MasterCard\x20webhook:','🔐\x20AES\x20key\x20and\x20IV\x20generated'];a42_0x2a6b=function(){return _0x5e7fc0;};return a42_0x2a6b();}class MasterCardService{constructor(){const _0x306e9e=a42_0x152485;this[_0x306e9e(0x121)]=new Map(),this['apiUrl']=_0x306e9e(0x1c2),this['merchantPointId']=0x67c,this[_0x306e9e(0x1c0)]=path_1['default'][_0x306e9e(0x112)](process['cwd'](),_0x306e9e(0x168),'private.pem'),this['publicKeyPath']=path_1[_0x306e9e(0x178)][_0x306e9e(0x112)](process[_0x306e9e(0x11a)](),'keys',_0x306e9e(0x1d7)),console[_0x306e9e(0x1b3)]('💳\x20MasterCard\x20service\x20initialized'),console[_0x306e9e(0x1b3)](_0x306e9e(0x138),this['privateKeyPath']),console['log'](_0x306e9e(0x187),this[_0x306e9e(0x1bb)]),this[_0x306e9e(0x12f)]();}['validateKeyFiles'](){const _0x4fe85c=a42_0x152485;try{if(!fs_1[_0x4fe85c(0x178)][_0x4fe85c(0x10a)](this[_0x4fe85c(0x1c0)]))throw new Error(_0x4fe85c(0x154)+this[_0x4fe85c(0x1c0)]);if(!fs_1[_0x4fe85c(0x178)][_0x4fe85c(0x10a)](this['publicKeyPath']))throw new Error(_0x4fe85c(0x108)+this[_0x4fe85c(0x1bb)]);const _0x3d5065=fs_1['default'][_0x4fe85c(0x14b)](this[_0x4fe85c(0x1c0)],_0x4fe85c(0x14a))[_0x4fe85c(0x148)](),_0x1c55fd=fs_1['default'][_0x4fe85c(0x14b)](this[_0x4fe85c(0x1bb)],_0x4fe85c(0x14a))[_0x4fe85c(0x148)]();if(!_0x3d5065[_0x4fe85c(0x13c)](_0x4fe85c(0x147))||!_0x3d5065[_0x4fe85c(0x13c)](_0x4fe85c(0x165)))throw new Error(_0x4fe85c(0x102));if(!_0x1c55fd[_0x4fe85c(0x13c)](_0x4fe85c(0x147))||!_0x1c55fd[_0x4fe85c(0x13c)]('-----END'))throw new Error(_0x4fe85c(0x1c8));console[_0x4fe85c(0x1b3)]('✅\x20MasterCard\x20key\x20files\x20validated\x20successfully'),console[_0x4fe85c(0x1b3)](_0x4fe85c(0x169)+_0x3d5065[_0x4fe85c(0x196)]+_0x4fe85c(0x144)),console[_0x4fe85c(0x1b3)]('🔐\x20Public\x20key\x20length:\x20'+_0x1c55fd[_0x4fe85c(0x196)]+_0x4fe85c(0x144));}catch(_0xd454d2){console[_0x4fe85c(0x11f)]('❌\x20MasterCard\x20key\x20validation\x20failed:',_0xd454d2);throw _0xd454d2;}}[a42_0x152485(0x11d)](){const _0xd9c881=a42_0x152485,_0x107528=crypto_1[_0xd9c881(0x178)][_0xd9c881(0x13f)](0x20),_0x81e6c6=crypto_1[_0xd9c881(0x178)][_0xd9c881(0x13f)](0x10);return{'key':_0x107528,'iv':_0x81e6c6};}['encryptAES'](_0x715a7b,_0x965183,_0x45188e){const _0x22de63=a42_0x152485,_0x1c2a35=crypto_1[_0x22de63(0x178)][_0x22de63(0x1a9)]('aes-256-ctr',_0x965183,_0x45188e);let _0xcb0c18=_0x1c2a35[_0x22de63(0x1ac)](_0x715a7b,'utf8',_0x22de63(0x152));return _0xcb0c18+=_0x1c2a35['final']('base64'),_0xcb0c18;}[a42_0x152485(0x1d3)](_0x195510,_0x44cb61){const _0x12d070=a42_0x152485;try{const _0x2dff95=fs_1['default']['readFileSync'](this['publicKeyPath'],_0x12d070(0x14a))[_0x12d070(0x148)](),_0x2d083a={'iv':_0x44cb61['toString'](_0x12d070(0x152)),'key':_0x195510[_0x12d070(0x1e1)](_0x12d070(0x152))},_0x423832=JSON[_0x12d070(0x198)](_0x2d083a);console[_0x12d070(0x1b3)](_0x12d070(0x181),_0x423832['length']);const _0x119437=crypto_1['default']['publicEncrypt']({'key':_0x2dff95,'padding':crypto_1[_0x12d070(0x178)][_0x12d070(0x1bf)][_0x12d070(0x133)]},Buffer['from'](_0x423832));return console[_0x12d070(0x1b3)]('✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:',_0x119437['length']),_0x119437['toString'](_0x12d070(0x152));}catch(_0xa667e6){console[_0x12d070(0x11f)](_0x12d070(0x1cf),_0xa667e6);throw new Error(_0x12d070(0x120));}}[a42_0x152485(0x128)](_0x9af39f){const _0x11081a=a42_0x152485;try{const _0xde19d1=fs_1[_0x11081a(0x178)][_0x11081a(0x14b)](this['privateKeyPath'],_0x11081a(0x14a))[_0x11081a(0x148)](),_0x20d169=crypto_1[_0x11081a(0x178)][_0x11081a(0x1c5)](_0x11081a(0x1af));_0x20d169[_0x11081a(0x1ac)](_0x9af39f),_0x20d169['end']();const _0x2c1cdc=_0x20d169[_0x11081a(0x151)](_0xde19d1,_0x11081a(0x152));return console['log']('🔐\x20RSA\x20signing\x20successful'),console[_0x11081a(0x1b3)](_0x11081a(0x135),_0x9af39f['length']),console[_0x11081a(0x1b3)](_0x11081a(0x16b),_0x2c1cdc[_0x11081a(0x196)]),_0x2c1cdc;}catch(_0x58e609){console[_0x11081a(0x11f)](_0x11081a(0x105),_0x58e609),console[_0x11081a(0x11f)](_0x11081a(0x146),_0x9af39f['substring'](0x0,0xc8)+_0x11081a(0x17a));throw new Error('Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key');}}[a42_0x152485(0x18b)](_0x7c3957,_0x455f74,_0x5ea11b){const _0x5b9067=a42_0x152485,_0x362189=crypto_1[_0x5b9067(0x178)][_0x5b9067(0x1a3)]('aes-256-ctr',_0x455f74,_0x5ea11b);let _0x29a43b=_0x362189[_0x5b9067(0x1ac)](_0x7c3957,_0x5b9067(0x152),_0x5b9067(0x14a));return _0x29a43b+=_0x362189['final'](_0x5b9067(0x14a)),_0x29a43b;}async[a42_0x152485(0x18a)](_0x2af9e8,_0x40e589){const _0x1b87ea=a42_0x152485;try{const _0x154392=await fetch(_0x1b87ea(0x194),{'method':'POST','headers':{'Content-Type':'application/json'},'body':JSON[_0x1b87ea(0x198)]({'info':_0x2af9e8,'key':_0x40e589})});if(!_0x154392['ok'])throw new Error(_0x1b87ea(0x1a0));return await _0x154392[_0x1b87ea(0x18e)]();}catch(_0xe91515){console['error'](_0x1b87ea(0x192),_0xe91515);throw new Error(_0x1b87ea(0x1dc));}}[a42_0x152485(0x1a8)](_0x1bae32,_0x579c52){const _0x55f867=a42_0x152485;try{const _0xca9e52=fs_1[_0x55f867(0x178)][_0x55f867(0x14b)](this[_0x55f867(0x1c0)],'utf8')[_0x55f867(0x148)](),_0x7e600c=crypto_1['default'][_0x55f867(0x1ad)](_0xca9e52,Buffer[_0x55f867(0x183)](_0x579c52,_0x55f867(0x152))),_0x1f79ff=JSON[_0x55f867(0x15d)](_0x7e600c[_0x55f867(0x1e1)]()),_0x2c4ab8=Buffer[_0x55f867(0x183)](_0x1f79ff[_0x55f867(0x14e)],_0x55f867(0x152)),_0x439f4b=Buffer[_0x55f867(0x183)](_0x1f79ff['iv'],_0x55f867(0x152));return this['decryptAES'](_0x1bae32,_0x2c4ab8,_0x439f4b);}catch(_0x44ae6c){throw new Error('Failed\x20to\x20decrypt\x20response');}}async[a42_0x152485(0x100)](_0x2d85e0){const _0x38dfce=a42_0x152485,{paymentId:_0x539bb1,orderId:_0x5c188a,amount:_0x1e05a4,currency:_0x457442,cardData:_0xb2e8d9,resultUrl:_0x5cc088,returnUrl:_0x17eceb,cardHolder:_0x264beb,browser:_0x24195d}=_0x2d85e0;console[_0x38dfce(0x1b3)]('===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20==='),console['log']('Payment\x20ID:',_0x539bb1),console[_0x38dfce(0x1b3)]('Order\x20ID:',_0x5c188a),console[_0x38dfce(0x1b3)](_0x38dfce(0x159),_0x1e05a4,_0x457442),console['log']('Card\x20Number:',this[_0x38dfce(0x173)](_0xb2e8d9[_0x38dfce(0x1ba)])),console[_0x38dfce(0x1b3)](_0x38dfce(0x176),_0x264beb[_0x38dfce(0x157)]+'\x20'+_0x264beb[_0x38dfce(0x1e7)]),console[_0x38dfce(0x1b3)]('Return\x20URL:',_0x17eceb),console[_0x38dfce(0x1b3)](_0x38dfce(0x1a1),_0x5cc088);const _0x219d0e={'amount':_0x1e05a4,'currency':_0x457442[_0x38dfce(0xfe)](),'order_id':_0x5c188a,'result_url':_0x5cc088,'return_url':_0x17eceb,'card':{'number':_0xb2e8d9[_0x38dfce(0x1ba)],'expire_month':_0xb2e8d9[_0x38dfce(0x19f)],'expire_year':_0xb2e8d9[_0x38dfce(0x129)],'cvv':_0xb2e8d9[_0x38dfce(0x1b6)]},'card_holder':_0x264beb,'browser':_0x24195d},_0x49e029=JSON[_0x38dfce(0x198)](_0x219d0e);console[_0x38dfce(0x1b3)](_0x38dfce(0x1bc)),console[_0x38dfce(0x1b3)]('📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:'),console[_0x38dfce(0x1b3)](_0x49e029),console[_0x38dfce(0x1b3)](_0x38dfce(0x134),_0x49e029[_0x38dfce(0x196)]);try{const {key:_0x13f49e,iv:_0x173760}=this[_0x38dfce(0x11d)]();console['log'](_0x38dfce(0x1a7)),console[_0x38dfce(0x1b3)](_0x38dfce(0x11b),_0x13f49e[_0x38dfce(0x196)]),console['log'](_0x38dfce(0x1aa),_0x173760['length']);const _0x431d6a=this[_0x38dfce(0x197)](_0x49e029,_0x13f49e,_0x173760);console[_0x38dfce(0x1b3)](_0x38dfce(0x13a)),console[_0x38dfce(0x1b3)](_0x38dfce(0x1e4),_0x431d6a[_0x38dfce(0x196)]);const _0x50bba7=this['encryptRSA'](_0x13f49e,_0x173760);console[_0x38dfce(0x1b3)]('🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA'),console[_0x38dfce(0x1b3)](_0x38dfce(0x185),_0x50bba7[_0x38dfce(0x196)]);const _0x5bb40f=this[_0x38dfce(0x128)](_0x49e029);console[_0x38dfce(0x1b3)](_0x38dfce(0x15f)),console['log'](_0x38dfce(0x16b),_0x5bb40f[_0x38dfce(0x196)]);const _0x19a763={'merchant_point_id':this['merchantPointId'],'method':_0x38dfce(0x1d1),'info':_0x431d6a,'key':_0x50bba7,'sign':_0x5bb40f,'lang':'en'};console[_0x38dfce(0x1b3)](_0x38dfce(0x190)),console['log'](_0x38dfce(0x110)),console['log'](_0x38dfce(0x126),this[_0x38dfce(0x10f)]),console['log'](_0x38dfce(0x1e3)),console[_0x38dfce(0x1b3)]('\x20\x20\x20-\x20info\x20length:',_0x431d6a[_0x38dfce(0x196)]),console[_0x38dfce(0x1b3)]('\x20\x20\x20-\x20key\x20length:',_0x50bba7[_0x38dfce(0x196)]),console['log'](_0x38dfce(0x193),_0x5bb40f[_0x38dfce(0x196)]),console['log'](_0x38dfce(0x109)),loggerService_1[_0x38dfce(0x175)]['logWhiteDomainRequest']('mastercard',_0x38dfce(0x140),'POST',{'merchant_point_id':this['merchantPointId'],'method':_0x38dfce(0x1d1),'lang':'en'});const _0x22e453=Date[_0x38dfce(0x1c7)](),_0x48536a=await fetch(this[_0x38dfce(0x136)],{'method':_0x38dfce(0x1ce),'headers':{'Content-Type':_0x38dfce(0x180),'Accept':_0x38dfce(0x180),'User-Agent':_0x38dfce(0x1b0)},'body':JSON[_0x38dfce(0x198)](_0x19a763)}),_0x5b9f9d=Date[_0x38dfce(0x1c7)]()-_0x22e453;console[_0x38dfce(0x1b3)](_0x38dfce(0x14f)),console[_0x38dfce(0x1b3)](_0x38dfce(0x1e9),_0x48536a['status']),console[_0x38dfce(0x1b3)](_0x38dfce(0x1de),_0x5b9f9d+'ms');if(!_0x48536a['ok']){const _0x409505=await _0x48536a[_0x38dfce(0x18e)]();console[_0x38dfce(0x11f)]('HTTP\x20Status:',_0x48536a[_0x38dfce(0x177)]),console[_0x38dfce(0x11f)](_0x38dfce(0x158),_0x409505),loggerService_1[_0x38dfce(0x175)][_0x38dfce(0x10c)](_0x38dfce(0x17b),'/charge_raw',_0x48536a[_0x38dfce(0x177)],_0x409505,_0x5b9f9d),loggerService_1['loggerService'][_0x38dfce(0x1a5)](_0x38dfce(0x17b),_0x38dfce(0x140),_0x38dfce(0x1d8)+_0x48536a[_0x38dfce(0x177)]+':\x20'+_0x409505);throw new Error(_0x38dfce(0x19c)+_0x48536a[_0x38dfce(0x177)]+',\x20body:\x20'+_0x409505);}const _0x1409cf=await _0x48536a['json']();loggerService_1['loggerService'][_0x38dfce(0x10c)]('mastercard',_0x38dfce(0x12c),_0x48536a[_0x38dfce(0x177)],_0x1409cf,_0x5b9f9d),console[_0x38dfce(0x1b3)](_0x38dfce(0x162));let _0x318a8b=_0x1409cf;if(_0x1409cf['info']&&_0x1409cf[_0x38dfce(0x14e)]&&_0x1409cf['sign']){console['log'](_0x38dfce(0x170));try{const _0x1d8fdf=await this['decryptResponsePhp'](_0x1409cf[_0x38dfce(0x191)],_0x1409cf[_0x38dfce(0x14e)]);_0x318a8b=JSON['parse'](_0x1d8fdf),console[_0x38dfce(0x1b3)]('✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)'),loggerService_1[_0x38dfce(0x175)]['logWhiteDomainResponse']('mastercard',_0x38dfce(0x1ab),_0x48536a[_0x38dfce(0x177)],_0x318a8b,_0x5b9f9d),console[_0x38dfce(0x1b3)](_0x38dfce(0xfd));}catch(_0x2e406d){console[_0x38dfce(0x11f)]('❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):',_0x2e406d),loggerService_1[_0x38dfce(0x175)][_0x38dfce(0x1a5)](_0x38dfce(0x17b),_0x38dfce(0x19e),_0x38dfce(0x149)+_0x2e406d),_0x318a8b=_0x1409cf;}}else loggerService_1[_0x38dfce(0x175)][_0x38dfce(0x10c)](_0x38dfce(0x17b),_0x38dfce(0x1ab),_0x48536a['status'],_0x318a8b,_0x5b9f9d),console[_0x38dfce(0x1b3)]('📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted');console[_0x38dfce(0x1b3)](_0x38dfce(0x1e9),_0x318a8b['status']),console[_0x38dfce(0x1b3)](_0x38dfce(0x1a4),_0x318a8b['final']),console[_0x38dfce(0x1b3)](_0x38dfce(0x1d4),_0x318a8b['payment_id']),console['log'](_0x38dfce(0x160),_0x318a8b[_0x38dfce(0x1e8)]||_0x38dfce(0x132));if(_0x318a8b[_0x38dfce(0x177)]===0x64&&_0x318a8b[_0x38dfce(0x166)]===0x1)return console[_0x38dfce(0x1b3)](_0x38dfce(0x1ea)),{'gateway_payment_id':_0x318a8b['payment_id']?.['toString'](),'payment_url':_0x17eceb,'requires_3ds':![],'status':_0x38dfce(0x13e),'final':!![]};if(_0x318a8b[_0x38dfce(0x1e8)])return console[_0x38dfce(0x1b3)](_0x38dfce(0x10e)),this[_0x38dfce(0x1e6)](_0x539bb1,_0x5c188a,_0x318a8b['payment_id']?.[_0x38dfce(0x1e1)]()||_0x5c188a),{'gateway_payment_id':_0x318a8b['payment_id']?.[_0x38dfce(0x1e1)](),'payment_url':_0x318a8b[_0x38dfce(0x1e8)],'requires_3ds':!![],'threeds_url':_0x318a8b[_0x38dfce(0x1e8)],'status':_0x38dfce(0x1b5),'final':![]};let _0x524f5d=_0x318a8b[_0x38dfce(0x11e)]||_0x318a8b[_0x38dfce(0x155)]||_0x38dfce(0xff),_0x59dfa4=_0x318a8b[_0x38dfce(0x177)],_0x2161b9=_0x318a8b[_0x38dfce(0x166)];return console[_0x38dfce(0x1b3)](_0x38dfce(0x15c)+_0x59dfa4+',\x20Final:\x20'+_0x2161b9+_0x38dfce(0x12e)+_0x524f5d),{'gateway_payment_id':_0x318a8b[_0x38dfce(0x137)]?.[_0x38dfce(0x1e1)](),'payment_url':_0x17eceb,'requires_3ds':![],'status':_0x38dfce(0x15a),'final':!![]};}catch(_0x34da51){console[_0x38dfce(0x11f)](_0x38dfce(0x118)),console[_0x38dfce(0x11f)](_0x38dfce(0x115),_0x34da51),loggerService_1[_0x38dfce(0x175)][_0x38dfce(0x1a5)](_0x38dfce(0x17b),'/charge',_0x34da51);throw new Error('Failed\x20to\x20process\x20MasterCard\x20payment:\x20'+(_0x34da51 instanceof Error?_0x34da51['message']:_0x38dfce(0xff)));}}async['checkPaymentStatus'](_0x2b809a,_0x59d7bf){const _0x31b7eb=a42_0x152485;console[_0x31b7eb(0x1b3)](_0x31b7eb(0x145)+_0x2b809a+'\x20('+_0x59d7bf+')');try{const _0x4d29eb={'payment_id':_0x2b809a,'order_id':_0x59d7bf},_0x5ab668=JSON['stringify'](_0x4d29eb),{key:_0x9c5cc5,iv:_0x4cc213}=this[_0x31b7eb(0x11d)](),_0x11658b=this[_0x31b7eb(0x197)](_0x5ab668,_0x9c5cc5,_0x4cc213),_0x85ec95=this['encryptRSA'](_0x9c5cc5,_0x4cc213),_0x5e2c14=this[_0x31b7eb(0x128)](_0x5ab668),_0x7e1b5d={'merchant_point_id':this['merchantPointId'],'method':'status','info':_0x11658b,'key':_0x85ec95,'sign':_0x5e2c14,'lang':'en'};loggerService_1[_0x31b7eb(0x175)][_0x31b7eb(0x172)](_0x31b7eb(0x17b),'/status','POST',{'merchant_point_id':this[_0x31b7eb(0x10f)],'method':_0x31b7eb(0x177),'lang':'en'});const _0x456366=Date[_0x31b7eb(0x1c7)](),_0x9e7a2b=await fetch(this[_0x31b7eb(0x136)],{'method':'POST','headers':{'Content-Type':'application/json','Accept':_0x31b7eb(0x180),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x7e1b5d)}),_0x307f7f=Date['now']()-_0x456366;if(!_0x9e7a2b['ok']){const _0x37eeff=await _0x9e7a2b[_0x31b7eb(0x18e)]();loggerService_1['loggerService'][_0x31b7eb(0x10c)]('mastercard',_0x31b7eb(0x10b),_0x9e7a2b[_0x31b7eb(0x177)],_0x37eeff,_0x307f7f);throw new Error('HTTP\x20error!\x20status:\x20'+_0x9e7a2b[_0x31b7eb(0x177)]);}const _0x3339fa=await _0x9e7a2b[_0x31b7eb(0x1d9)]();loggerService_1[_0x31b7eb(0x175)][_0x31b7eb(0x10c)](_0x31b7eb(0x17b),_0x31b7eb(0x10b),_0x9e7a2b[_0x31b7eb(0x177)],_0x3339fa,_0x307f7f);let _0x2458bc=_0x3339fa;if(_0x3339fa[_0x31b7eb(0x191)]&&_0x3339fa['key']&&_0x3339fa[_0x31b7eb(0x151)]){console[_0x31b7eb(0x1b3)](_0x31b7eb(0x17f));try{const _0x23d514=this[_0x31b7eb(0x1a8)](_0x3339fa['info'],_0x3339fa[_0x31b7eb(0x14e)]);_0x2458bc=JSON['parse'](_0x23d514),console[_0x31b7eb(0x1b3)](_0x31b7eb(0x12a)),loggerService_1[_0x31b7eb(0x175)]['logWhiteDomainResponse'](_0x31b7eb(0x17b),_0x31b7eb(0x1b2),_0x9e7a2b[_0x31b7eb(0x177)],_0x2458bc,_0x307f7f),console[_0x31b7eb(0x1b3)](_0x31b7eb(0x1b8));}catch(_0xb56c6e){console[_0x31b7eb(0x11f)](_0x31b7eb(0x195),_0xb56c6e),loggerService_1[_0x31b7eb(0x175)]['logWhiteDomainError'](_0x31b7eb(0x17b),_0x31b7eb(0x174),_0x31b7eb(0x1df)+_0xb56c6e),_0x2458bc=_0x3339fa;}}else loggerService_1[_0x31b7eb(0x175)][_0x31b7eb(0x10c)](_0x31b7eb(0x17b),_0x31b7eb(0x1b2),_0x9e7a2b[_0x31b7eb(0x177)],_0x2458bc,_0x307f7f),console[_0x31b7eb(0x1b3)]('📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted');console[_0x31b7eb(0x1b3)](_0x31b7eb(0x182),{'status':_0x2458bc[_0x31b7eb(0x177)],'final':_0x2458bc[_0x31b7eb(0x166)],'payment_id':_0x2458bc[_0x31b7eb(0x137)],'desc':_0x2458bc[_0x31b7eb(0x11e)]});let _0x3259f8='PENDING';if(_0x2458bc['status']===0x1&&_0x2458bc[_0x31b7eb(0x166)]===0x1)_0x3259f8=_0x31b7eb(0x13e);else _0x2458bc[_0x31b7eb(0x177)]===0x0&&_0x2458bc[_0x31b7eb(0x166)]===0x0?_0x3259f8=_0x31b7eb(0x1b5):_0x3259f8=_0x31b7eb(0x15a);return{'status':_0x3259f8,'final':_0x2458bc[_0x31b7eb(0x166)]===0x1,'amount':_0x2458bc[_0x31b7eb(0x1e5)],'currency':_0x2458bc[_0x31b7eb(0x199)],'date_success':_0x2458bc[_0x31b7eb(0x1c6)],'description':_0x2458bc[_0x31b7eb(0x11e)]};}catch(_0x10babe){console[_0x31b7eb(0x11f)](_0x31b7eb(0x1be),_0x10babe),loggerService_1[_0x31b7eb(0x175)][_0x31b7eb(0x1a5)](_0x31b7eb(0x17b),_0x31b7eb(0x1c1),_0x10babe);throw new Error(_0x31b7eb(0x164)+(_0x10babe instanceof Error?_0x10babe[_0x31b7eb(0x155)]:_0x31b7eb(0xff)));}}[a42_0x152485(0x1e6)](_0x3916d5,_0x3392ea,_0x318739){const _0x7aecb1=a42_0x152485;console[_0x7aecb1(0x1b3)]('⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20'+_0x3916d5+'\x20('+_0x318739+')'),this[_0x7aecb1(0x139)](_0x3916d5);const _0xf50d6c=[],_0x33c124=0x5*0x3c*0x3e8,_0xed07f1=0x2*0x3c*0x3c*0x3e8,_0x1c3c8a=Math['floor'](_0xed07f1/_0x33c124);console[_0x7aecb1(0x1b3)]('⏰\x20Will\x20check\x20status\x20'+_0x1c3c8a+_0x7aecb1(0x142));for(let _0x87f26d=0x1;_0x87f26d<=_0x1c3c8a;_0x87f26d++){const _0x979cf5=setTimeout(async()=>{const _0x5daebe=_0x7aecb1;console[_0x5daebe(0x1b3)]('🔍\x20MasterCard\x20status\x20check\x20#'+_0x87f26d+'/'+_0x1c3c8a+'\x20for\x20payment\x20'+_0x3916d5);try{const _0x131a03=await this['checkPaymentStatus'](_0x318739,_0x3392ea);console['log']('📊\x20Status\x20check\x20#'+_0x87f26d+_0x5daebe(0x114),_0x131a03),_0x131a03['final']&&(console[_0x5daebe(0x1b3)](_0x5daebe(0x111)+_0x3916d5+_0x5daebe(0xfc)+_0x131a03['status']+_0x5daebe(0x1d5)),this['clearStatusTimers'](_0x3916d5),await this[_0x5daebe(0x17e)](_0x3916d5,_0x131a03[_0x5daebe(0x177)],_0x131a03));}catch(_0x47fc19){console[_0x5daebe(0x11f)](_0x5daebe(0x1b4)+_0x87f26d+_0x5daebe(0x150)+_0x3916d5+':',_0x47fc19);}},_0x87f26d*_0x33c124);_0xf50d6c[_0x7aecb1(0x1ae)](_0x979cf5);}this[_0x7aecb1(0x121)][_0x7aecb1(0x101)](_0x3916d5,_0xf50d6c),console[_0x7aecb1(0x1b3)]('✅\x20Scheduled\x20'+_0x1c3c8a+_0x7aecb1(0x16c)+_0x3916d5);}[a42_0x152485(0x139)](_0x27bda3){const _0x22a904=a42_0x152485,_0x354d10=this['statusCheckTimers'][_0x22a904(0x14d)](_0x27bda3);_0x354d10&&(console[_0x22a904(0x1b3)](_0x22a904(0x156)+_0x354d10[_0x22a904(0x196)]+_0x22a904(0x125)+_0x27bda3),_0x354d10['forEach']((_0x4611da,_0x580825)=>{clearTimeout(_0x4611da);}),this[_0x22a904(0x121)][_0x22a904(0x1e0)](_0x27bda3));}async[a42_0x152485(0x17e)](_0x2f342b,_0x73a6b6,_0x4dccb8){const _0x39ceb6=a42_0x152485;try{const _0xc3059c=(await Promise[_0x39ceb6(0x17d)]()[_0x39ceb6(0x171)](()=>__importStar(require(_0x39ceb6(0x16f)))))['default'],_0x5a06b2={'status':_0x73a6b6['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x39ceb6(0x184),'statusChangedAt':new Date()};_0x73a6b6==='PAID'&&(_0x5a06b2[_0x39ceb6(0x122)]=new Date()),_0x4dccb8[_0x39ceb6(0x143)]&&(_0x5a06b2[_0x39ceb6(0x16d)]=_0x39ceb6(0x1e2)+_0x4dccb8[_0x39ceb6(0x143)]),await _0xc3059c[_0x39ceb6(0x1c3)][_0x39ceb6(0x1ac)]({'where':{'id':_0x2f342b},'data':_0x5a06b2}),console[_0x39ceb6(0x1b3)](_0x39ceb6(0x111)+_0x2f342b+'\x20status\x20updated\x20to\x20'+_0x73a6b6),await this[_0x39ceb6(0x17c)](_0x2f342b,_0x73a6b6);}catch(_0x4741eb){console[_0x39ceb6(0x11f)]('❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20'+_0x2f342b+':',_0x4741eb);}}async['sendPaymentNotifications'](_0x23ba32,_0x3aeefa){const _0x41800d=a42_0x152485;try{const _0x47efac=(await Promise[_0x41800d(0x17d)]()['then'](()=>__importStar(require(_0x41800d(0x16f)))))[_0x41800d(0x178)],{telegramBotService:_0x177cff}=await Promise[_0x41800d(0x17d)]()['then'](()=>__importStar(require(_0x41800d(0x117)))),_0x85d4a3=await _0x47efac['payment'][_0x41800d(0x1ca)]({'where':{'id':_0x23ba32},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x85d4a3)return;const _0x55ab9e={'PAID':'paid','FAILED':'failed'},_0x1ff3a4=_0x55ab9e[_0x3aeefa];_0x1ff3a4&&await _0x177cff[_0x41800d(0x130)](_0x85d4a3['shopId'],_0x85d4a3,_0x1ff3a4),await this[_0x41800d(0x1b9)](_0x85d4a3,_0x3aeefa);}catch(_0x1f7ac4){console[_0x41800d(0x11f)]('Failed\x20to\x20send\x20payment\x20notifications:',_0x1f7ac4);}}async['sendShopWebhook'](_0x26f8f8,_0x2716a9){const _0x3621d5=a42_0x152485,_0x15101c=Date[_0x3621d5(0x1c7)]();try{const _0x4316ba=_0x26f8f8[_0x3621d5(0x106)],_0x15991f=_0x4316ba['settings'];if(!_0x15991f?.[_0x3621d5(0x1bd)]){console[_0x3621d5(0x1b3)](_0x3621d5(0x1cd)+_0x4316ba['id']);return;}const _0x19c388=_0x2716a9==='PAID'?_0x3621d5(0x12b):_0x3621d5(0x19a);let _0x1b9534=[];if(_0x15991f[_0x3621d5(0x1c9)])try{_0x1b9534=Array[_0x3621d5(0x107)](_0x15991f[_0x3621d5(0x1c9)])?_0x15991f[_0x3621d5(0x1c9)]:JSON[_0x3621d5(0x15d)](_0x15991f[_0x3621d5(0x1c9)]);}catch(_0x46784a){console[_0x3621d5(0x11f)](_0x3621d5(0x1c4),_0x46784a),_0x1b9534=[];}if(!_0x1b9534[_0x3621d5(0x13c)](_0x19c388)){console[_0x3621d5(0x1b3)](_0x3621d5(0x1b7)+_0x19c388+_0x3621d5(0x1da)+_0x4316ba['id']);return;}const _0x2d9c3c={'event':_0x19c388,'payment':{'id':_0x26f8f8['id'],'order_id':_0x26f8f8['orderId'],'gateway_order_id':_0x26f8f8['gatewayOrderId'],'gateway':_0x3621d5(0x104),'amount':_0x26f8f8[_0x3621d5(0x1e5)],'currency':_0x26f8f8[_0x3621d5(0x199)],'status':_0x2716a9[_0x3621d5(0x1dd)](),'customer_email':_0x26f8f8['customerEmail'],'customer_name':_0x26f8f8[_0x3621d5(0x189)],'created_at':_0x26f8f8[_0x3621d5(0x123)],'updated_at':new Date()}},_0x5062ce=await fetch(_0x15991f[_0x3621d5(0x1bd)],{'method':_0x3621d5(0x1ce),'headers':{'Content-Type':'application/json','User-Agent':_0x3621d5(0x18c)},'body':JSON['stringify'](_0x2d9c3c)}),_0x270fea=Date['now']()-_0x15101c;loggerService_1[_0x3621d5(0x175)][_0x3621d5(0x1a2)](_0x26f8f8[_0x3621d5(0x13d)],_0x15991f[_0x3621d5(0x1bd)],_0x19c388,_0x5062ce['status'],_0x270fea,_0x2d9c3c),console[_0x3621d5(0x1b3)](_0x3621d5(0x1d0)+_0x15991f['webhookUrl']+_0x3621d5(0x12d)+_0x5062ce[_0x3621d5(0x177)]+'\x20('+_0x270fea+_0x3621d5(0x116));}catch(_0x141ec0){console['error'](_0x3621d5(0x1a6),_0x141ec0),loggerService_1[_0x3621d5(0x175)]['logShopWebhookError'](_0x26f8f8[_0x3621d5(0x13d)],_0x26f8f8[_0x3621d5(0x106)]?.[_0x3621d5(0x124)]?.['webhookUrl']||_0x3621d5(0x1d2),_0x3621d5(0x11c),_0x141ec0,{});}}[a42_0x152485(0x173)](_0x1aa386){const _0x2bd253=a42_0x152485,_0x790687=_0x1aa386[_0x2bd253(0x141)](/[\s-]/g,'');if(_0x790687[_0x2bd253(0x196)]<0x4)return _0x2bd253(0x1d6);return'****\x20****\x20****\x20'+_0x790687[_0x2bd253(0x179)](-0x4);}async['processWebhook'](_0x2cb1c2){const _0x398f90=a42_0x152485;console[_0x398f90(0x1b3)](_0x398f90(0x1cc),_0x2cb1c2);let _0x6aa854=_0x398f90(0x1b5);if(_0x2cb1c2[_0x398f90(0x177)]===0x1&&_0x2cb1c2[_0x398f90(0x166)]===0x1)_0x6aa854=_0x398f90(0x13e);else _0x2cb1c2[_0x398f90(0x177)]===0x0&&_0x2cb1c2['final']===0x0?_0x6aa854=_0x398f90(0x1b5):_0x6aa854='FAILED';return{'paymentId':_0x2cb1c2[_0x398f90(0x119)]||'','status':_0x6aa854,'amount':_0x2cb1c2[_0x398f90(0x1e5)],'currency':_0x2cb1c2[_0x398f90(0x199)]};}['stopAllStatusChecks'](){const _0x393480=a42_0x152485;console[_0x393480(0x1b3)]('🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...');const _0x567c02=this[_0x393480(0x121)][_0x393480(0x16a)];for(const [_0x1ce8e9]of this['statusCheckTimers']){this[_0x393480(0x139)](_0x1ce8e9);}console[_0x393480(0x1b3)](_0x393480(0x19b)+_0x567c02+'\x20MasterCard\x20status\x20check\x20timers');}}exports[a42_0x152485(0x186)]=MasterCardService;