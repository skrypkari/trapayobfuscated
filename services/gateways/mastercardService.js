'use strict';const a42_0x334d3c=a42_0x2a84;function a42_0x1974(){const _0x5ac3bb=['utf8','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','updatePaymentStatus','order_id','Unknown\x20error','get','update','apiUrl','3ds_url','decryptResponsePhp','\x20status\x20updated\x20to\x20','isArray','/charge_decrypted','SHA256','cvv','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','resolve','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','❌\x20Status\x20check\x20#','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','path','key','statusCheckTimers','\x20failed\x20for\x20payment\x20','-----BEGIN','error','end','/status','✅\x20Status\x20response\x20decrypted\x20successfully','prototype','📝\x20Data\x20to\x20sign\x20length:','defineProperty','\x20with\x20status\x20','959790uUmWzA','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully','FAILED','json','🔍\x20MasterCard\x20status\x20check\x20#','===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===','Public\x20key\x20file\x20not\x20found:\x20','565284PRcZzR','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','psp_public.pem','✅\x20Payment\x20','/status_decrypt','\x20\x20\x20-\x20method:\x20charge','ms)','getOwnPropertyNames','HTTP\x20','1544jMMPkP','Private\x20key\x20file\x20not\x20found:\x20','🔐\x20AES\x20key\x20length:','\x20\x20\x20-\x20merchant_point_id:','forEach','__importDefault','description','webhookEvents','🔐\x203DS\x20verification\x20required','\x20\x20\x20-\x20sign\x20length:','encryptAES','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','createSign','number','PAID','../loggerService','****\x20****\x20****\x20','expire_year','expire_month','charge','existsSync','last_name','../../config/database','💾\x20Payment\x20data\x20prepared','\x20status\x20timers\x20for\x20payment\x20','aes-256-ctr','shopId','writable','26yyyGoJ','webhook_send','length','Failed\x20to\x20send\x20payment\x20notifications:','🔐\x20Public\x20key\x20length:\x20','📊\x20Status\x20check\x20#','📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','sendShopWebhook','customerName','webhookUrl','POST','❌\x20Failed\x20to\x20decrypt\x20status\x20response:','Response\x20Body:','configurable','\x20status\x20checks\x20for\x20payment\x20','toString','desc','processCardPayment','create','final','now','logShopWebhookError','✅\x20Response\x20decrypted\x20successfully\x20(via\x20PHP)','PHP\x20decryptor\x20error','__importStar','HTTP\x20error!\x20status:\x20','\x20\x20\x20-\x20lang:\x20en','HTTP\x20Status:','payment.failed','Error\x20details:','decryptAES','✅\x20Scheduled\x20','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','signRSA','\x20not\x20enabled\x20for\x20shop\x20','merchantPointId','mastercard','Status:','⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20','❌\x20RSA\x20signing\x20failed:','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','trim','90FhqwJH','❌\x20Payment\x20failed\x20or\x20declined.\x20Status:\x20','checkPaymentStatus','Amount:','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','getOwnPropertyDescriptor','❌\x20Failed\x20to\x20decrypt\x20response\x20(PHP):','Final:','stringify','randomBytes','Return\x20URL:','call','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','push','logWhiteDomainResponse','payment','📊\x20Status\x20check\x20result:','3DS\x20URL:','\x20result:','❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20',',\x20body:\x20','gatewayOrderId','system','🔐\x20Data\x20encrypted\x20with\x20AES','message','payment.success','cwd','log','size','floor',',\x20Final:\x20','🔐\x20Public\x20key\x20path:','shop','settings','base64','📝\x20Signature\x20length:','constants','none','/status_decrypted','MasterCard\x20status\x20check\x20error:','decryptResponse','📝\x20Encrypted\x20data\x20length:','__setModuleDefault','),\x20stopping\x20status\x20checks','hasOwnProperty','📝\x20Encrypted\x20key\x20length:','orderId','\x20times\x20every\x205\x20minutes\x20for\x202\x20hours','Payment\x20ID:','https://api.paydmeth.com/api','amount','7388dgfReU','slice','\x20\x20\x20-\x20key\x20length:','generateAESKey','failed','payment_id','logWhiteDomainRequest','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','status','MasterCard:\x20','application/json','maskCardNumber','delete','MasterCardService','🛑\x20Stopped\x20','toLowerCase','RSA_PKCS1_PADDING','customerEmail','__esModule','default','===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20===','/status_raw','includes','info','findUnique','TesSoft\x20Payment\x20System/1.0','encryptRSA','2780666sdUdJh','publicKeyPath','parse','privateDecrypt','stopAllStatusChecks','../telegramBotService','keys','⏰\x20Will\x20check\x20status\x20','sendPaymentNotifications','__createBinding','❌\x20PHP\x20decryptor\x20request\x20failed:','Result\x20URL:','from','privateKeyPath','\x20for\x20payment\x20','then','logWhiteDomainError','📝\x20Data\x20length:','Webhook\x20event\x20','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','/charge_decrypt','2013873SdlUte','🧹\x20Clearing\x20','currency','/charge','3078410RvvkBD','PENDING','clearStatusTimers','replace','logShopWebhookSent','-----END','text','loggerService','toUpperCase','📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','sign','1111','readFileSync','Failed\x20to\x20process\x20MasterCard\x20payment:\x20','first_name'];a42_0x1974=function(){return _0x5ac3bb;};return a42_0x1974();}function a42_0x2a84(_0x43b6ef,_0x502554){const _0x1974a5=a42_0x1974();return a42_0x2a84=function(_0x2a84e6,_0x239d8d){_0x2a84e6=_0x2a84e6-0xd7;let _0x4bc41=_0x1974a5[_0x2a84e6];return _0x4bc41;},a42_0x2a84(_0x43b6ef,_0x502554);}(function(_0x255109,_0xbc2d33){const _0xf2bb74=a42_0x2a84,_0x18b251=_0x255109();while(!![]){try{const _0x59b534=-parseInt(_0xf2bb74(0x122))/0x1*(parseInt(_0xf2bb74(0x17f))/0x2)+parseInt(_0xf2bb74(0x1af))/0x3+parseInt(_0xf2bb74(0xfd))/0x4+-parseInt(_0xf2bb74(0x1b3))/0x5+-parseInt(_0xf2bb74(0xf5))/0x6+parseInt(_0xf2bb74(0x19a))/0x7+parseInt(_0xf2bb74(0x106))/0x8*(parseInt(_0xf2bb74(0x14c))/0x9);if(_0x59b534===_0xbc2d33)break;else _0x18b251['push'](_0x18b251['shift']());}catch(_0x4e65c9){_0x18b251['push'](_0x18b251['shift']());}}}(a42_0x1974,0x53079));var __createBinding=this&&this[a42_0x334d3c(0x1a3)]||(Object['create']?function(_0x1751ba,_0x378a64,_0x75514a,_0x3b8e78){const _0x423b2e=a42_0x334d3c;if(_0x3b8e78===undefined)_0x3b8e78=_0x75514a;var _0xd3bdc3=Object[_0x423b2e(0x151)](_0x378a64,_0x75514a);(!_0xd3bdc3||(_0x423b2e(0xd9)in _0xd3bdc3?!_0x378a64[_0x423b2e(0x191)]:_0xd3bdc3[_0x423b2e(0x121)]||_0xd3bdc3[_0x423b2e(0x12f)]))&&(_0xd3bdc3={'enumerable':!![],'get':function(){return _0x378a64[_0x75514a];}}),Object[_0x423b2e(0xf3)](_0x1751ba,_0x3b8e78,_0xd3bdc3);}:function(_0x728dfe,_0x233885,_0x4f2519,_0xc30558){if(_0xc30558===undefined)_0xc30558=_0x4f2519;_0x728dfe[_0xc30558]=_0x233885[_0x4f2519];}),__setModuleDefault=this&&this[a42_0x334d3c(0x176)]||(Object[a42_0x334d3c(0x134)]?function(_0xfd826a,_0x3f831a){const _0x22116b=a42_0x334d3c;Object[_0x22116b(0xf3)](_0xfd826a,'default',{'enumerable':!![],'value':_0x3f831a});}:function(_0x4b6c6f,_0x1a48f7){const _0xcf8e83=a42_0x334d3c;_0x4b6c6f[_0xcf8e83(0x192)]=_0x1a48f7;}),__importStar=this&&this[a42_0x334d3c(0x13a)]||(function(){var _0x1af208=function(_0xd40073){const _0x46fa28=a42_0x2a84;return _0x1af208=Object[_0x46fa28(0x104)]||function(_0x3b0ea2){const _0x524a58=_0x46fa28;var _0x43e6f1=[];for(var _0x369657 in _0x3b0ea2)if(Object[_0x524a58(0xf1)][_0x524a58(0x178)][_0x524a58(0x157)](_0x3b0ea2,_0x369657))_0x43e6f1[_0x43e6f1[_0x524a58(0x124)]]=_0x369657;return _0x43e6f1;},_0x1af208(_0xd40073);};return function(_0x13ab4e){const _0xdb762f=a42_0x2a84;if(_0x13ab4e&&_0x13ab4e[_0xdb762f(0x191)])return _0x13ab4e;var _0x2bae5a={};if(_0x13ab4e!=null){for(var _0xdc8a0a=_0x1af208(_0x13ab4e),_0x2993b8=0x0;_0x2993b8<_0xdc8a0a[_0xdb762f(0x124)];_0x2993b8++)if(_0xdc8a0a[_0x2993b8]!==_0xdb762f(0x192))__createBinding(_0x2bae5a,_0x13ab4e,_0xdc8a0a[_0x2993b8]);}return __setModuleDefault(_0x2bae5a,_0x13ab4e),_0x2bae5a;};}()),__importDefault=this&&this[a42_0x334d3c(0x10b)]||function(_0x50fac3){return _0x50fac3&&_0x50fac3['__esModule']?_0x50fac3:{'default':_0x50fac3};};Object[a42_0x334d3c(0xf3)](exports,'__esModule',{'value':!![]}),exports[a42_0x334d3c(0x18c)]=void 0x0;const crypto_1=__importDefault(require('crypto')),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0x334d3c(0xe8))),loggerService_1=require(a42_0x334d3c(0x115));class MasterCardService{constructor(){const _0x1b2148=a42_0x334d3c;this['statusCheckTimers']=new Map(),this['apiUrl']=_0x1b2148(0x17d),this['merchantPointId']=0x67c,this[_0x1b2148(0x1a7)]=path_1[_0x1b2148(0x192)]['join'](process[_0x1b2148(0x166)](),_0x1b2148(0x1a0),'private.pem'),this[_0x1b2148(0x19b)]=path_1['default']['join'](process[_0x1b2148(0x166)](),_0x1b2148(0x1a0),_0x1b2148(0xff)),console[_0x1b2148(0x167)]('💳\x20MasterCard\x20service\x20initialized'),console[_0x1b2148(0x167)]('🔐\x20Private\x20key\x20path:',this[_0x1b2148(0x1a7)]),console[_0x1b2148(0x167)](_0x1b2148(0x16b),this['publicKeyPath']),this['validateKeyFiles']();}['validateKeyFiles'](){const _0x5006d5=a42_0x334d3c;try{if(!fs_1[_0x5006d5(0x192)]['existsSync'](this[_0x5006d5(0x1a7)]))throw new Error(_0x5006d5(0x107)+this['privateKeyPath']);if(!fs_1[_0x5006d5(0x192)][_0x5006d5(0x11a)](this[_0x5006d5(0x19b)]))throw new Error(_0x5006d5(0xfc)+this[_0x5006d5(0x19b)]);const _0x336ead=fs_1[_0x5006d5(0x192)][_0x5006d5(0x1bf)](this[_0x5006d5(0x1a7)],'utf8')[_0x5006d5(0x14b)](),_0xd56f08=fs_1[_0x5006d5(0x192)][_0x5006d5(0x1bf)](this[_0x5006d5(0x19b)],_0x5006d5(0x1c2))[_0x5006d5(0x14b)]();if(!_0x336ead[_0x5006d5(0x195)]('-----BEGIN')||!_0x336ead[_0x5006d5(0x195)](_0x5006d5(0x1b8)))throw new Error(_0x5006d5(0xe7));if(!_0xd56f08[_0x5006d5(0x195)](_0x5006d5(0xec))||!_0xd56f08[_0x5006d5(0x195)](_0x5006d5(0x1b8)))throw new Error(_0x5006d5(0x142));console[_0x5006d5(0x167)](_0x5006d5(0xf7)),console['log']('🔐\x20Private\x20key\x20length:\x20'+_0x336ead['length']+'\x20characters'),console[_0x5006d5(0x167)](_0x5006d5(0x126)+_0xd56f08[_0x5006d5(0x124)]+'\x20characters');}catch(_0x31c4d6){console[_0x5006d5(0xed)]('❌\x20MasterCard\x20key\x20validation\x20failed:',_0x31c4d6);throw _0x31c4d6;}}[a42_0x334d3c(0x182)](){const _0x139c1b=a42_0x334d3c,_0x3eb9af=crypto_1['default'][_0x139c1b(0x155)](0x20),_0x80e023=crypto_1[_0x139c1b(0x192)][_0x139c1b(0x155)](0x10);return{'key':_0x3eb9af,'iv':_0x80e023};}[a42_0x334d3c(0x110)](_0x3251f4,_0x1e2fc4,_0xd565c6){const _0x4ee350=a42_0x334d3c,_0x2459c2=crypto_1[_0x4ee350(0x192)]['createCipheriv']('aes-256-ctr',_0x1e2fc4,_0xd565c6);let _0x4f1d95=_0x2459c2[_0x4ee350(0xda)](_0x3251f4,'utf8',_0x4ee350(0x16e));return _0x4f1d95+=_0x2459c2[_0x4ee350(0x135)](_0x4ee350(0x16e)),_0x4f1d95;}[a42_0x334d3c(0x199)](_0x5e11eb,_0x5c4e41){const _0x593546=a42_0x334d3c;try{const _0x33b963=fs_1['default']['readFileSync'](this[_0x593546(0x19b)],'utf8')['trim'](),_0x182b24={'iv':_0x5c4e41[_0x593546(0x131)](_0x593546(0x16e)),'key':_0x5e11eb['toString'](_0x593546(0x16e))},_0x471c80=JSON[_0x593546(0x154)](_0x182b24);console[_0x593546(0x167)]('🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:',_0x471c80[_0x593546(0x124)]);const _0x5039d2=crypto_1[_0x593546(0x192)]['publicEncrypt']({'key':_0x33b963,'padding':crypto_1[_0x593546(0x192)][_0x593546(0x170)][_0x593546(0x18f)]},Buffer[_0x593546(0x1a6)](_0x471c80));return console[_0x593546(0x167)]('✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:',_0x5039d2[_0x593546(0x124)]),_0x5039d2[_0x593546(0x131)]('base64');}catch(_0x54af23){console[_0x593546(0xed)]('❌\x20RSA\x20encryption\x20failed:',_0x54af23);throw new Error(_0x593546(0x14a));}}['signRSA'](_0x5a7af9){const _0x563e7d=a42_0x334d3c;try{const _0x23f2a6=fs_1['default'][_0x563e7d(0x1bf)](this[_0x563e7d(0x1a7)],_0x563e7d(0x1c2))['trim'](),_0x47ddb9=crypto_1[_0x563e7d(0x192)][_0x563e7d(0x112)](_0x563e7d(0xe1));_0x47ddb9[_0x563e7d(0xda)](_0x5a7af9),_0x47ddb9[_0x563e7d(0xee)]();const _0xe7d758=_0x47ddb9[_0x563e7d(0x1bd)](_0x23f2a6,_0x563e7d(0x16e));return console[_0x563e7d(0x167)]('🔐\x20RSA\x20signing\x20successful'),console['log'](_0x563e7d(0xf2),_0x5a7af9[_0x563e7d(0x124)]),console[_0x563e7d(0x167)](_0x563e7d(0x16f),_0xe7d758[_0x563e7d(0x124)]),_0xe7d758;}catch(_0x49312e){console['error'](_0x563e7d(0x149),_0x49312e),console[_0x563e7d(0xed)]('❌\x20Data\x20being\x20signed:',_0x5a7af9['substring'](0x0,0xc8)+'...');throw new Error(_0x563e7d(0x186));}}[a42_0x334d3c(0x140)](_0x47e4b4,_0x63c0ed,_0x332967){const _0x33690a=a42_0x334d3c,_0x4f71a4=crypto_1[_0x33690a(0x192)]['createDecipheriv'](_0x33690a(0x11f),_0x63c0ed,_0x332967);let _0x9bc9c8=_0x4f71a4[_0x33690a(0xda)](_0x47e4b4,'base64',_0x33690a(0x1c2));return _0x9bc9c8+=_0x4f71a4[_0x33690a(0x135)](_0x33690a(0x1c2)),_0x9bc9c8;}async[a42_0x334d3c(0xdd)](_0x1a658c,_0x14ce7c){const _0x2a5077=a42_0x334d3c;try{const _0x5c333a=await fetch('https://api2.trapay.uk/decrypt.php',{'method':'POST','headers':{'Content-Type':_0x2a5077(0x189)},'body':JSON[_0x2a5077(0x154)]({'info':_0x1a658c,'key':_0x14ce7c})});if(!_0x5c333a['ok'])throw new Error(_0x2a5077(0x139));return await _0x5c333a[_0x2a5077(0x1b9)]();}catch(_0x103f4c){console['error'](_0x2a5077(0x1a4),_0x103f4c);throw new Error('Failed\x20to\x20decrypt\x20response\x20via\x20PHP');}}['decryptResponse'](_0x13e022,_0x5c7bb1){const _0x2c0e10=a42_0x334d3c;try{const _0x199b2e=fs_1[_0x2c0e10(0x192)][_0x2c0e10(0x1bf)](this[_0x2c0e10(0x1a7)],_0x2c0e10(0x1c2))['trim'](),_0xbe235c=crypto_1['default'][_0x2c0e10(0x19d)](_0x199b2e,Buffer[_0x2c0e10(0x1a6)](_0x5c7bb1,_0x2c0e10(0x16e))),_0x2f4205=JSON[_0x2c0e10(0x19c)](_0xbe235c[_0x2c0e10(0x131)]()),_0x1e8e8e=Buffer[_0x2c0e10(0x1a6)](_0x2f4205[_0x2c0e10(0xe9)],_0x2c0e10(0x16e)),_0xde6f9f=Buffer[_0x2c0e10(0x1a6)](_0x2f4205['iv'],_0x2c0e10(0x16e));return this['decryptAES'](_0x13e022,_0x1e8e8e,_0xde6f9f);}catch(_0x45999a){throw new Error('Failed\x20to\x20decrypt\x20response');}}async[a42_0x334d3c(0x133)](_0x33656f){const _0x35a53e=a42_0x334d3c,{paymentId:_0x3f71fd,orderId:_0x274a4c,amount:_0x114aa6,currency:_0x2846b8,cardData:_0x59917e,resultUrl:_0x17f42d,returnUrl:_0x5c09f0,cardHolder:_0x45ff5a,browser:_0x423f7c}=_0x33656f;console[_0x35a53e(0x167)](_0x35a53e(0x193)),console['log'](_0x35a53e(0x17c),_0x3f71fd),console[_0x35a53e(0x167)]('Order\x20ID:',_0x274a4c),console[_0x35a53e(0x167)](_0x35a53e(0x14f),_0x114aa6,_0x2846b8),console[_0x35a53e(0x167)]('Card\x20Number:',this[_0x35a53e(0x18a)](_0x59917e['number'])),console[_0x35a53e(0x167)]('Card\x20Holder:',_0x45ff5a[_0x35a53e(0x1c1)]+'\x20'+_0x45ff5a[_0x35a53e(0x11b)]),console[_0x35a53e(0x167)](_0x35a53e(0x156),_0x5c09f0),console[_0x35a53e(0x167)](_0x35a53e(0x1a5),_0x17f42d);const _0x2700a9={'amount':_0x114aa6,'currency':_0x2846b8[_0x35a53e(0x1bb)](),'order_id':_0x274a4c,'result_url':_0x17f42d,'return_url':_0x5c09f0,'card':{'number':_0x59917e[_0x35a53e(0x113)],'expire_month':_0x59917e[_0x35a53e(0x118)],'expire_year':_0x59917e[_0x35a53e(0x117)],'cvv':_0x59917e[_0x35a53e(0xe2)]},'card_holder':_0x45ff5a,'browser':_0x423f7c},_0x5e3d1d=JSON[_0x35a53e(0x154)](_0x2700a9);console['log'](_0x35a53e(0x11d)),console[_0x35a53e(0x167)]('📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:'),console['log'](_0x5e3d1d),console[_0x35a53e(0x167)](_0x35a53e(0x1ab),_0x5e3d1d[_0x35a53e(0x124)]);try{const {key:_0x5554ba,iv:_0x86113f}=this['generateAESKey']();console[_0x35a53e(0x167)]('🔐\x20AES\x20key\x20and\x20IV\x20generated'),console[_0x35a53e(0x167)](_0x35a53e(0x108),_0x5554ba[_0x35a53e(0x124)]),console['log']('🔐\x20AES\x20IV\x20length:',_0x86113f[_0x35a53e(0x124)]);const _0xb1d42d=this[_0x35a53e(0x110)](_0x5e3d1d,_0x5554ba,_0x86113f);console['log'](_0x35a53e(0x163)),console[_0x35a53e(0x167)](_0x35a53e(0x175),_0xb1d42d[_0x35a53e(0x124)]);const _0x33a60a=this[_0x35a53e(0x199)](_0x5554ba,_0x86113f);console[_0x35a53e(0x167)]('🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA'),console[_0x35a53e(0x167)](_0x35a53e(0x179),_0x33a60a[_0x35a53e(0x124)]);const _0x4210dc=this[_0x35a53e(0x143)](_0x5e3d1d);console[_0x35a53e(0x167)]('🔐\x20Data\x20signed\x20with\x20RSA'),console['log'](_0x35a53e(0x16f),_0x4210dc[_0x35a53e(0x124)]);const _0x51c68e={'merchant_point_id':this['merchantPointId'],'method':_0x35a53e(0x119),'info':_0xb1d42d,'key':_0x33a60a,'sign':_0x4210dc,'lang':'en'};console[_0x35a53e(0x167)](_0x35a53e(0xf6)),console[_0x35a53e(0x167)]('📝\x20Final\x20request\x20structure:'),console[_0x35a53e(0x167)](_0x35a53e(0x109),this[_0x35a53e(0x145)]),console[_0x35a53e(0x167)](_0x35a53e(0x102)),console['log']('\x20\x20\x20-\x20info\x20length:',_0xb1d42d['length']),console[_0x35a53e(0x167)](_0x35a53e(0x181),_0x33a60a[_0x35a53e(0x124)]),console[_0x35a53e(0x167)](_0x35a53e(0x10f),_0x4210dc['length']),console['log'](_0x35a53e(0x13c)),loggerService_1['loggerService'][_0x35a53e(0x185)](_0x35a53e(0x146),_0x35a53e(0x1b2),'POST',{'merchant_point_id':this['merchantPointId'],'method':'charge','lang':'en'});const _0xc54889=Date[_0x35a53e(0x136)](),_0x244cb4=await fetch(this[_0x35a53e(0xdb)],{'method':_0x35a53e(0x12c),'headers':{'Content-Type':'application/json','Accept':_0x35a53e(0x189),'User-Agent':_0x35a53e(0x198)},'body':JSON[_0x35a53e(0x154)](_0x51c68e)}),_0x469c17=Date['now']()-_0xc54889;console[_0x35a53e(0x167)](_0x35a53e(0x1c3)),console[_0x35a53e(0x167)](_0x35a53e(0x147),_0x244cb4['status']),console[_0x35a53e(0x167)]('Response\x20Time:',_0x469c17+'ms');if(!_0x244cb4['ok']){const _0x343fbe=await _0x244cb4['text']();console[_0x35a53e(0xed)](_0x35a53e(0x13d),_0x244cb4['status']),console[_0x35a53e(0xed)](_0x35a53e(0x12e),_0x343fbe),loggerService_1[_0x35a53e(0x1ba)]['logWhiteDomainResponse'](_0x35a53e(0x146),'/charge_raw',_0x244cb4[_0x35a53e(0x187)],_0x343fbe,_0x469c17),loggerService_1[_0x35a53e(0x1ba)]['logWhiteDomainError'](_0x35a53e(0x146),_0x35a53e(0x1b2),_0x35a53e(0x105)+_0x244cb4['status']+':\x20'+_0x343fbe);throw new Error(_0x35a53e(0x13b)+_0x244cb4['status']+_0x35a53e(0x160)+_0x343fbe);}const _0x50ab66=await _0x244cb4[_0x35a53e(0xf9)]();loggerService_1[_0x35a53e(0x1ba)]['logWhiteDomainResponse']('mastercard','/charge_raw',_0x244cb4[_0x35a53e(0x187)],_0x50ab66,_0x469c17),console[_0x35a53e(0x167)](_0x35a53e(0xfb));let _0x411bd4=_0x50ab66;if(_0x50ab66['info']&&_0x50ab66[_0x35a53e(0xe9)]&&_0x50ab66[_0x35a53e(0x1bd)]){console[_0x35a53e(0x167)](_0x35a53e(0x111));try{const _0x592b89=await this[_0x35a53e(0xdd)](_0x50ab66[_0x35a53e(0x196)],_0x50ab66[_0x35a53e(0xe9)]);_0x411bd4=JSON[_0x35a53e(0x19c)](_0x592b89),console['log'](_0x35a53e(0x138)),loggerService_1['loggerService'][_0x35a53e(0x15a)](_0x35a53e(0x146),_0x35a53e(0xe0),_0x244cb4[_0x35a53e(0x187)],_0x411bd4,_0x469c17),console[_0x35a53e(0x167)](_0x35a53e(0x150));}catch(_0x2a24f7){console['error'](_0x35a53e(0x152),_0x2a24f7),loggerService_1[_0x35a53e(0x1ba)][_0x35a53e(0x1aa)](_0x35a53e(0x146),_0x35a53e(0x1ae),'Decryption\x20failed:\x20'+_0x2a24f7),_0x411bd4=_0x50ab66;}}else loggerService_1[_0x35a53e(0x1ba)][_0x35a53e(0x15a)](_0x35a53e(0x146),_0x35a53e(0xe0),_0x244cb4[_0x35a53e(0x187)],_0x411bd4,_0x469c17),console[_0x35a53e(0x167)](_0x35a53e(0x128));console[_0x35a53e(0x167)]('Status:',_0x411bd4[_0x35a53e(0x187)]),console[_0x35a53e(0x167)](_0x35a53e(0x153),_0x411bd4[_0x35a53e(0x135)]),console[_0x35a53e(0x167)](_0x35a53e(0x17c),_0x411bd4[_0x35a53e(0x184)]),console[_0x35a53e(0x167)](_0x35a53e(0x15d),_0x411bd4[_0x35a53e(0xdc)]||_0x35a53e(0x171));if(_0x411bd4[_0x35a53e(0x187)]===0x64&&_0x411bd4[_0x35a53e(0x135)]===0x1)return console[_0x35a53e(0x167)]('✅\x20Payment\x20successful'),{'gateway_payment_id':_0x411bd4[_0x35a53e(0x184)]?.[_0x35a53e(0x131)](),'payment_url':_0x5c09f0,'requires_3ds':![],'status':'PAID','final':!![]};if(_0x411bd4[_0x35a53e(0xdc)])return console[_0x35a53e(0x167)](_0x35a53e(0x10e)),this['scheduleStatusChecks'](_0x3f71fd,_0x274a4c,_0x411bd4[_0x35a53e(0x184)]?.['toString']()||_0x274a4c),{'gateway_payment_id':_0x411bd4[_0x35a53e(0x184)]?.[_0x35a53e(0x131)](),'payment_url':_0x411bd4[_0x35a53e(0xdc)],'requires_3ds':!![],'threeds_url':_0x411bd4[_0x35a53e(0xdc)],'status':_0x35a53e(0x1b4),'final':![]};let _0x5b72d2=_0x411bd4[_0x35a53e(0x132)]||_0x411bd4['message']||_0x35a53e(0xd8),_0x5d0b12=_0x411bd4[_0x35a53e(0x187)],_0x2699c9=_0x411bd4[_0x35a53e(0x135)];return console[_0x35a53e(0x167)](_0x35a53e(0x14d)+_0x5d0b12+_0x35a53e(0x16a)+_0x2699c9+',\x20Desc:\x20'+_0x5b72d2),{'gateway_payment_id':_0x411bd4[_0x35a53e(0x184)]?.[_0x35a53e(0x131)](),'payment_url':_0x5c09f0,'requires_3ds':![],'status':'FAILED','final':!![]};}catch(_0xb7ac43){console[_0x35a53e(0xed)](_0x35a53e(0x1ad)),console['error'](_0x35a53e(0x13f),_0xb7ac43),loggerService_1[_0x35a53e(0x1ba)][_0x35a53e(0x1aa)](_0x35a53e(0x146),_0x35a53e(0x1b2),_0xb7ac43);throw new Error(_0x35a53e(0x1c0)+(_0xb7ac43 instanceof Error?_0xb7ac43[_0x35a53e(0x164)]:_0x35a53e(0xd8)));}}async[a42_0x334d3c(0x14e)](_0x5cf113,_0x46f6e1){const _0x5e9304=a42_0x334d3c;console[_0x5e9304(0x167)](_0x5e9304(0xfe)+_0x5cf113+'\x20('+_0x46f6e1+')');try{const _0x5134da={'payment_id':_0x5cf113,'order_id':_0x46f6e1},_0x3dda24=JSON['stringify'](_0x5134da),{key:_0x1f33ea,iv:_0x13468a}=this[_0x5e9304(0x182)](),_0x146395=this['encryptAES'](_0x3dda24,_0x1f33ea,_0x13468a),_0x4a7db3=this[_0x5e9304(0x199)](_0x1f33ea,_0x13468a),_0x30fa28=this[_0x5e9304(0x143)](_0x3dda24),_0x4b430f={'merchant_point_id':this[_0x5e9304(0x145)],'method':'status','info':_0x146395,'key':_0x4a7db3,'sign':_0x30fa28,'lang':'en'};loggerService_1[_0x5e9304(0x1ba)][_0x5e9304(0x185)]('mastercard',_0x5e9304(0xef),_0x5e9304(0x12c),{'merchant_point_id':this[_0x5e9304(0x145)],'method':_0x5e9304(0x187),'lang':'en'});const _0xa453bd=Date[_0x5e9304(0x136)](),_0x1fa556=await fetch(this[_0x5e9304(0xdb)],{'method':_0x5e9304(0x12c),'headers':{'Content-Type':'application/json','Accept':_0x5e9304(0x189),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x5e9304(0x154)](_0x4b430f)}),_0x5ac80e=Date[_0x5e9304(0x136)]()-_0xa453bd;if(!_0x1fa556['ok']){const _0x37d9ee=await _0x1fa556['text']();loggerService_1['loggerService'][_0x5e9304(0x15a)](_0x5e9304(0x146),'/status_raw',_0x1fa556[_0x5e9304(0x187)],_0x37d9ee,_0x5ac80e);throw new Error(_0x5e9304(0x13b)+_0x1fa556[_0x5e9304(0x187)]);}const _0x297027=await _0x1fa556[_0x5e9304(0xf9)]();loggerService_1['loggerService']['logWhiteDomainResponse'](_0x5e9304(0x146),_0x5e9304(0x194),_0x1fa556['status'],_0x297027,_0x5ac80e);let _0x462f90=_0x297027;if(_0x297027['info']&&_0x297027[_0x5e9304(0xe9)]&&_0x297027[_0x5e9304(0x1bd)]){console['log']('🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...');try{const _0x5ea19e=this[_0x5e9304(0x174)](_0x297027[_0x5e9304(0x196)],_0x297027[_0x5e9304(0xe9)]);_0x462f90=JSON['parse'](_0x5ea19e),console[_0x5e9304(0x167)](_0x5e9304(0xf0)),loggerService_1[_0x5e9304(0x1ba)][_0x5e9304(0x15a)](_0x5e9304(0x146),'/status_decrypted',_0x1fa556['status'],_0x462f90,_0x5ac80e),console[_0x5e9304(0x167)](_0x5e9304(0x158));}catch(_0x44e09b){console['error'](_0x5e9304(0x12d),_0x44e09b),loggerService_1['loggerService']['logWhiteDomainError'](_0x5e9304(0x146),_0x5e9304(0x101),'Status\x20decryption\x20failed:\x20'+_0x44e09b),_0x462f90=_0x297027;}}else loggerService_1['loggerService'][_0x5e9304(0x15a)](_0x5e9304(0x146),_0x5e9304(0x172),_0x1fa556['status'],_0x462f90,_0x5ac80e),console['log'](_0x5e9304(0x1bc));console[_0x5e9304(0x167)](_0x5e9304(0x15c),{'status':_0x462f90[_0x5e9304(0x187)],'final':_0x462f90[_0x5e9304(0x135)],'payment_id':_0x462f90[_0x5e9304(0x184)],'desc':_0x462f90[_0x5e9304(0x132)]});let _0x116c72=_0x5e9304(0x1b4);if(_0x462f90['status']===0x1&&_0x462f90[_0x5e9304(0x135)]===0x1)_0x116c72=_0x5e9304(0x114);else _0x462f90[_0x5e9304(0x187)]===0x0&&_0x462f90[_0x5e9304(0x135)]===0x0?_0x116c72=_0x5e9304(0x1b4):_0x116c72=_0x5e9304(0xf8);return{'status':_0x116c72,'final':_0x462f90['final']===0x1,'amount':_0x462f90['amount'],'currency':_0x462f90[_0x5e9304(0x1b1)],'date_success':_0x462f90['date_success'],'description':_0x462f90[_0x5e9304(0x132)]};}catch(_0x3ec5a6){console['error'](_0x5e9304(0x173),_0x3ec5a6),loggerService_1['loggerService']['logWhiteDomainError']('mastercard',_0x5e9304(0xef),_0x3ec5a6);throw new Error('Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20'+(_0x3ec5a6 instanceof Error?_0x3ec5a6[_0x5e9304(0x164)]:_0x5e9304(0xd8)));}}['scheduleStatusChecks'](_0x20d930,_0xa7963f,_0xae5bab){const _0x37dff5=a42_0x334d3c;console[_0x37dff5(0x167)](_0x37dff5(0x148)+_0x20d930+'\x20('+_0xae5bab+')'),this[_0x37dff5(0x1b5)](_0x20d930);const _0x506c67=[],_0xa9fc85=0x5*0x3c*0x3e8,_0xe3beeb=0x2*0x3c*0x3c*0x3e8,_0x56f944=Math[_0x37dff5(0x169)](_0xe3beeb/_0xa9fc85);console['log'](_0x37dff5(0x1a1)+_0x56f944+_0x37dff5(0x17b));for(let _0x405de2=0x1;_0x405de2<=_0x56f944;_0x405de2++){const _0x52ff77=setTimeout(async()=>{const _0x33acbd=_0x37dff5;console[_0x33acbd(0x167)](_0x33acbd(0xfa)+_0x405de2+'/'+_0x56f944+_0x33acbd(0x1a8)+_0x20d930);try{const _0x8c6102=await this['checkPaymentStatus'](_0xae5bab,_0xa7963f);console[_0x33acbd(0x167)](_0x33acbd(0x127)+_0x405de2+_0x33acbd(0x15e),_0x8c6102),_0x8c6102[_0x33acbd(0x135)]&&(console['log']('✅\x20Payment\x20'+_0x20d930+'\x20is\x20final\x20('+_0x8c6102['status']+_0x33acbd(0x177)),this[_0x33acbd(0x1b5)](_0x20d930),await this[_0x33acbd(0x1c5)](_0x20d930,_0x8c6102[_0x33acbd(0x187)],_0x8c6102));}catch(_0x16a2f5){console[_0x33acbd(0xed)](_0x33acbd(0xe6)+_0x405de2+_0x33acbd(0xeb)+_0x20d930+':',_0x16a2f5);}},_0x405de2*_0xa9fc85);_0x506c67[_0x37dff5(0x159)](_0x52ff77);}this[_0x37dff5(0xea)]['set'](_0x20d930,_0x506c67),console['log'](_0x37dff5(0x141)+_0x56f944+_0x37dff5(0x130)+_0x20d930);}[a42_0x334d3c(0x1b5)](_0x42c593){const _0x273fe5=a42_0x334d3c,_0x205a04=this['statusCheckTimers']['get'](_0x42c593);_0x205a04&&(console[_0x273fe5(0x167)](_0x273fe5(0x1b0)+_0x205a04[_0x273fe5(0x124)]+_0x273fe5(0x11e)+_0x42c593),_0x205a04[_0x273fe5(0x10a)]((_0x14d7f6,_0x590c19)=>{clearTimeout(_0x14d7f6);}),this['statusCheckTimers'][_0x273fe5(0x18b)](_0x42c593));}async[a42_0x334d3c(0x1c5)](_0x26e9da,_0x3b071e,_0x2463bc){const _0x4a4d26=a42_0x334d3c;try{const _0xa1193b=(await Promise[_0x4a4d26(0xe4)]()['then'](()=>__importStar(require(_0x4a4d26(0x11c)))))['default'],_0xb3a3a3={'status':_0x3b071e[_0x4a4d26(0x1bb)](),'updatedAt':new Date(),'statusChangedBy':_0x4a4d26(0x162),'statusChangedAt':new Date()};_0x3b071e==='PAID'&&(_0xb3a3a3['paidAt']=new Date()),_0x2463bc[_0x4a4d26(0x10c)]&&(_0xb3a3a3['adminNotes']=_0x4a4d26(0x188)+_0x2463bc[_0x4a4d26(0x10c)]),await _0xa1193b[_0x4a4d26(0x15b)]['update']({'where':{'id':_0x26e9da},'data':_0xb3a3a3}),console[_0x4a4d26(0x167)](_0x4a4d26(0x100)+_0x26e9da+_0x4a4d26(0xde)+_0x3b071e),await this[_0x4a4d26(0x1a2)](_0x26e9da,_0x3b071e);}catch(_0x5d6d9b){console[_0x4a4d26(0xed)](_0x4a4d26(0x15f)+_0x26e9da+':',_0x5d6d9b);}}async['sendPaymentNotifications'](_0x3eeaa9,_0x25b7d5){const _0x4678a2=a42_0x334d3c;try{const _0x55564b=(await Promise[_0x4678a2(0xe4)]()[_0x4678a2(0x1a9)](()=>__importStar(require(_0x4678a2(0x11c)))))[_0x4678a2(0x192)],{telegramBotService:_0x34c989}=await Promise[_0x4678a2(0xe4)]()[_0x4678a2(0x1a9)](()=>__importStar(require(_0x4678a2(0x19f)))),_0x3e9811=await _0x55564b['payment'][_0x4678a2(0x197)]({'where':{'id':_0x3eeaa9},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x3e9811)return;const _0x26a25c={'PAID':'paid','FAILED':_0x4678a2(0x183)},_0x101ed9=_0x26a25c[_0x25b7d5];_0x101ed9&&await _0x34c989['sendPaymentNotification'](_0x3e9811[_0x4678a2(0x120)],_0x3e9811,_0x101ed9),await this[_0x4678a2(0x129)](_0x3e9811,_0x25b7d5);}catch(_0x6e0da9){console[_0x4678a2(0xed)](_0x4678a2(0x125),_0x6e0da9);}}async[a42_0x334d3c(0x129)](_0x48baa0,_0x32c92d){const _0x528f3f=a42_0x334d3c,_0x152a94=Date[_0x528f3f(0x136)]();try{const _0x135f10=_0x48baa0[_0x528f3f(0x16c)],_0x5f09b8=_0x135f10[_0x528f3f(0x16d)];if(!_0x5f09b8?.[_0x528f3f(0x12b)]){console[_0x528f3f(0x167)](_0x528f3f(0xe5)+_0x135f10['id']);return;}const _0x3fb0af=_0x32c92d===_0x528f3f(0x114)?_0x528f3f(0x165):_0x528f3f(0x13e);let _0x101213=[];if(_0x5f09b8[_0x528f3f(0x10d)])try{_0x101213=Array[_0x528f3f(0xdf)](_0x5f09b8[_0x528f3f(0x10d)])?_0x5f09b8[_0x528f3f(0x10d)]:JSON[_0x528f3f(0x19c)](_0x5f09b8[_0x528f3f(0x10d)]);}catch(_0x521794){console[_0x528f3f(0xed)]('Error\x20parsing\x20webhook\x20events:',_0x521794),_0x101213=[];}if(!_0x101213['includes'](_0x3fb0af)){console[_0x528f3f(0x167)](_0x528f3f(0x1ac)+_0x3fb0af+_0x528f3f(0x144)+_0x135f10['id']);return;}const _0x26e21f={'event':_0x3fb0af,'payment':{'id':_0x48baa0['id'],'order_id':_0x48baa0[_0x528f3f(0x17a)],'gateway_order_id':_0x48baa0[_0x528f3f(0x161)],'gateway':_0x528f3f(0x1be),'amount':_0x48baa0[_0x528f3f(0x17e)],'currency':_0x48baa0[_0x528f3f(0x1b1)],'status':_0x32c92d[_0x528f3f(0x18e)](),'customer_email':_0x48baa0[_0x528f3f(0x190)],'customer_name':_0x48baa0[_0x528f3f(0x12a)],'created_at':_0x48baa0['createdAt'],'updated_at':new Date()}},_0x1c4b97=await fetch(_0x5f09b8[_0x528f3f(0x12b)],{'method':_0x528f3f(0x12c),'headers':{'Content-Type':'application/json','User-Agent':_0x528f3f(0x1c4)},'body':JSON[_0x528f3f(0x154)](_0x26e21f)}),_0x35b3e1=Date[_0x528f3f(0x136)]()-_0x152a94;loggerService_1[_0x528f3f(0x1ba)][_0x528f3f(0x1b7)](_0x48baa0[_0x528f3f(0x120)],_0x5f09b8[_0x528f3f(0x12b)],_0x3fb0af,_0x1c4b97[_0x528f3f(0x187)],_0x35b3e1,_0x26e21f),console[_0x528f3f(0x167)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x5f09b8[_0x528f3f(0x12b)]+_0x528f3f(0xf4)+_0x1c4b97['status']+'\x20('+_0x35b3e1+_0x528f3f(0x103));}catch(_0x164780){console[_0x528f3f(0xed)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x164780),loggerService_1[_0x528f3f(0x1ba)][_0x528f3f(0x137)](_0x48baa0[_0x528f3f(0x120)],_0x48baa0[_0x528f3f(0x16c)]?.[_0x528f3f(0x16d)]?.[_0x528f3f(0x12b)]||'unknown',_0x528f3f(0x123),_0x164780,{});}}['maskCardNumber'](_0x3ba5bd){const _0x22549a=a42_0x334d3c,_0x2a5f0c=_0x3ba5bd[_0x22549a(0x1b6)](/[\s-]/g,'');if(_0x2a5f0c['length']<0x4)return'****';return _0x22549a(0x116)+_0x2a5f0c[_0x22549a(0x180)](-0x4);}async['processWebhook'](_0x58f9ea){const _0x3c2918=a42_0x334d3c;console[_0x3c2918(0x167)]('Processing\x20MasterCard\x20webhook:',_0x58f9ea);let _0x2972c7='PENDING';if(_0x58f9ea[_0x3c2918(0x187)]===0x1&&_0x58f9ea[_0x3c2918(0x135)]===0x1)_0x2972c7='PAID';else _0x58f9ea[_0x3c2918(0x187)]===0x0&&_0x58f9ea[_0x3c2918(0x135)]===0x0?_0x2972c7='PENDING':_0x2972c7=_0x3c2918(0xf8);return{'paymentId':_0x58f9ea[_0x3c2918(0xd7)]||'','status':_0x2972c7,'amount':_0x58f9ea[_0x3c2918(0x17e)],'currency':_0x58f9ea[_0x3c2918(0x1b1)]};}[a42_0x334d3c(0x19e)](){const _0x2dbe15=a42_0x334d3c;console[_0x2dbe15(0x167)](_0x2dbe15(0xe3));const _0x482907=this[_0x2dbe15(0xea)][_0x2dbe15(0x168)];for(const [_0x2f8ff3]of this['statusCheckTimers']){this['clearStatusTimers'](_0x2f8ff3);}console[_0x2dbe15(0x167)](_0x2dbe15(0x18d)+_0x482907+'\x20MasterCard\x20status\x20check\x20timers');}}exports['MasterCardService']=MasterCardService;