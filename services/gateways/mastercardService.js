'use strict';const a42_0x35a2f2=a42_0x1cb6;function a42_0x2a51(){const _0x392119=['📝\x20Decrypted\x20data\x20length:','/status_raw','💳\x20MasterCard\x20service\x20initialized','decryptResponse','logWhiteDomainError','writable','🧹\x20Clearing\x20','Decryption\x20failed:\x20','📝\x20Encrypted\x20data\x20length:','Card\x20Number:','prototype','psp_public.pem','12GWwEtB','readFileSync','❌\x20Status\x20check\x20#','updatePaymentStatus','🔐\x20AES\x20key+IV\x20encrypted\x20with\x20RSA','payment_id','Failed\x20to\x20encrypt\x20with\x20RSA\x20public\x20key','shopId','isArray','sign','RSA_PKCS1_PADDING','logWhiteDomainRequest','Result\x20URL:','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','FAILED','__importDefault','✅\x20MasterCard\x20key\x20files\x20validated\x20successfully',',\x20body:\x20','description','🔐\x20Starting\x20response\x20decryption...','Response\x20Body:','../telegramBotService','scheduleStatusChecks','📤\x20Sending\x20request\x20to\x20MasterCard\x20API...','****','🔐\x20Response\x20is\x20encrypted,\x20decrypting...','includes','logShopWebhookSent','Amount:','push','customerName','__esModule','✅\x20AES\x20data\x20decryption\x20successful','parse','\x20\x20\x20-\x20lang:\x20en','apiUrl','charge','===\x20MASTERCARD\x20API\x20RESPONSE\x20===','__createBinding','Payment\x20ID:','logWhiteDomainResponse','HTTP\x20error!\x20status:\x20','customerEmail','POST','cwd','stopAllStatusChecks','clearStatusTimers','✅\x20Key\x20structure\x20parsed\x20successfully','validateKeyFiles','📝\x20Decrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted','Failed\x20to\x20check\x20MasterCard\x20payment\x20status:\x20','❌\x20RSA\x20signing\x20failed:','TesSoft\x20Payment\x20System/1.0','📝\x20Signature\x20length:','Public\x20key\x20file\x20not\x20found:\x20','processWebhook','statusCheckTimers','✅\x20Response\x20decrypted\x20successfully','https://api.psp-release.net/api','\x20\x20\x20-\x20merchant_point_id:','494087dlcgDb','4sikxxN','❌\x20RSA\x20encryption\x20failed:','****\x20****\x20****\x20','webhook_send','Card\x20Holder:','\x20with\x20status\x20','Private\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','\x20result:','✅\x20RSA\x20encryption\x20successful,\x20encrypted\x20length:','failed','\x20\x20\x20-\x20key\x20length:','🔐\x20RSA\x20encryption\x20-\x20Key\x20structure\x20JSON\x20length:','trim','log','130277YQJzbI','Error\x20details:','Private\x20key\x20file\x20not\x20found:\x20','webhookUrl','Failed\x20to\x20sign\x20with\x20RSA\x20private\x20key','🛑\x20Stopped\x20','from','amount','findUnique','call','❌\x20Data\x20being\x20signed:','📝\x20Data\x20length:','MasterCard\x20webhook\x20sent\x20to\x20','toLowerCase','\x20characters','application/json','path','54BkddWX','processCardPayment','-----END','payment.success','info','Response\x20Time:','\x20status\x20timers\x20for\x20payment\x20','join','end','9ydbPwg','🔐\x20RSA\x20signing\x20successful','\x20\x20\x20-\x20sign\x20length:','substring','sendPaymentNotification','/status_decrypt','stringify','first_name','merchantPointId','resolve','💾\x20Payment\x20data\x20prepared','forEach','Unknown\x20error','text','🔐\x20Data\x20signed\x20with\x20RSA','orderId','3ds_url','logShopWebhookError','🛑\x20Stopping\x20all\x20MasterCard\x20status\x20checks...','payment','../loggerService','🔐\x20AES\x20key\x20length:','4023600hyHMSz','delete','HTTP\x20','floor','📊\x20Status\x20check\x20#','final','desc','🔐\x20Public\x20key\x20path:','aes-256-ctr','/status','Failed\x20to\x20send\x20payment\x20notifications:','❌\x20MasterCard\x20key\x20validation\x20failed:','/charge','PENDING','now','6967708lefZjP','Public\x20key\x20file\x20does\x20not\x20appear\x20to\x20be\x20in\x20PEM\x20format','PAID','signRSA','number','order_id','defineProperty','paid','===\x20PARSED\x20MASTERCARD\x20RESPONSE\x20===','base64','key','✅\x20Payment\x20','/charge_decrypted','📝\x20Unencrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','✅\x20Payment\x20successful\x20without\x203DS','randomBytes','createCipheriv','none','message','-----BEGIN','/status_decrypted','Status:','📝\x20Decrypted\x20status\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/status_decrypted','📝\x20Final\x20request\x20structure:','private.pem','✅\x20Status\x20response\x20decrypted\x20successfully','encryptRSA','sendPaymentNotifications','webhookEvents','7406090cftfcb','status','⏰\x20Scheduling\x20status\x20checks\x20for\x20MasterCard\x20payment:\x20','\x20status\x20checks\x20for\x20payment\x20','get','/charge_raw','Failed\x20to\x20decrypt\x20response','📝\x20Encrypted\x20info\x20length:','existsSync','\x20MasterCard\x20status\x20check\x20timers','Processing\x20MasterCard\x20webhook:','🔐\x20Private\x20key\x20path:','===\x20MASTERCARD\x20SERVICE\x20ERROR\x20===','680355IxUgqh','encryptAES','set','decryptAES','adminNotes','createdAt','MasterCardService','publicKeyPath','shop','toString','json','🔐\x20AES\x20key\x20and\x20IV\x20generated','privateKeyPath','🔐\x20Status\x20response\x20is\x20encrypted,\x20decrypting...','3DS\x20URL:','currency','📝\x20Data\x20to\x20be\x20signed\x20and\x20encrypted:','checkPaymentStatus','slice','date_success','Final:','privateDecrypt','mastercard','expire_year','keys','error','update','../../config/database','703056ExmvYX','1111','default','system','🔐\x20Public\x20key\x20length:\x20','loggerService','===\x20MASTERCARD\x20PAYMENT\x20PROCESSING\x20===','paidAt','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20status\x20updated\x20to\x20','crypto','size','then','Webhook\x20event\x20','length','createDecipheriv','generateAESKey','🔐\x20AES\x20IV\x20length:','HTTP\x20Status:','📊\x20Checking\x20MasterCard\x20payment\x20status:\x20','create','📝\x20Encrypted\x20key\x20length:','utf8','❌\x20Error\x20details:','\x20\x20\x20-\x20info\x20length:'];a42_0x2a51=function(){return _0x392119;};return a42_0x2a51();}(function(_0x80deda,_0x1af125){const _0x8c1db3=a42_0x1cb6,_0x2db514=_0x80deda();while(!![]){try{const _0x41f558=parseInt(_0x8c1db3(0x1d5))/0x1*(parseInt(_0x8c1db3(0x1d6))/0x2)+parseInt(_0x8c1db3(0x158))/0x3*(-parseInt(_0x8c1db3(0x199))/0x4)+-parseInt(_0x8c1db3(0x214))/0x5+parseInt(_0x8c1db3(0x1f5))/0x6*(-parseInt(_0x8c1db3(0x1e4))/0x7)+-parseInt(_0x8c1db3(0x174))/0x8*(parseInt(_0x8c1db3(0x1fe))/0x9)+parseInt(_0x8c1db3(0x14b))/0xa+parseInt(_0x8c1db3(0x223))/0xb;if(_0x41f558===_0x1af125)break;else _0x2db514['push'](_0x2db514['shift']());}catch(_0x29a986){_0x2db514['push'](_0x2db514['shift']());}}}(a42_0x2a51,0x97cbb));var __createBinding=this&&this[a42_0x35a2f2(0x1bf)]||(Object[a42_0x35a2f2(0x188)]?function(_0x45b699,_0x274909,_0x2ac939,_0x1c42d2){const _0x1808b3=a42_0x35a2f2;if(_0x1c42d2===undefined)_0x1c42d2=_0x2ac939;var _0x2eb764=Object['getOwnPropertyDescriptor'](_0x274909,_0x2ac939);(!_0x2eb764||(_0x1808b3(0x14f)in _0x2eb764?!_0x274909[_0x1808b3(0x1b8)]:_0x2eb764[_0x1808b3(0x192)]||_0x2eb764['configurable']))&&(_0x2eb764={'enumerable':!![],'get':function(){return _0x274909[_0x2ac939];}}),Object[_0x1808b3(0x229)](_0x45b699,_0x1c42d2,_0x2eb764);}:function(_0x23b00e,_0x3848c5,_0x49d562,_0x46c777){if(_0x46c777===undefined)_0x46c777=_0x49d562;_0x23b00e[_0x46c777]=_0x3848c5[_0x49d562];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a42_0x35a2f2(0x188)]?function(_0x3b8392,_0x176009){const _0x2e0937=a42_0x35a2f2;Object['defineProperty'](_0x3b8392,_0x2e0937(0x176),{'enumerable':!![],'value':_0x176009});}:function(_0x441754,_0x295d11){const _0x347a28=a42_0x35a2f2;_0x441754[_0x347a28(0x176)]=_0x295d11;}),__importStar=this&&this['__importStar']||(function(){var _0x5a92b3=function(_0x3e9d2b){return _0x5a92b3=Object['getOwnPropertyNames']||function(_0x52f3e7){const _0x438a8d=a42_0x1cb6;var _0x446313=[];for(var _0x2fab68 in _0x52f3e7)if(Object[_0x438a8d(0x197)]['hasOwnProperty'][_0x438a8d(0x1ed)](_0x52f3e7,_0x2fab68))_0x446313[_0x446313['length']]=_0x2fab68;return _0x446313;},_0x5a92b3(_0x3e9d2b);};return function(_0xd92f1f){const _0x52781f=a42_0x1cb6;if(_0xd92f1f&&_0xd92f1f['__esModule'])return _0xd92f1f;var _0x4c473e={};if(_0xd92f1f!=null){for(var _0x2c118c=_0x5a92b3(_0xd92f1f),_0x5c590b=0x0;_0x5c590b<_0x2c118c[_0x52781f(0x182)];_0x5c590b++)if(_0x2c118c[_0x5c590b]!==_0x52781f(0x176))__createBinding(_0x4c473e,_0xd92f1f,_0x2c118c[_0x5c590b]);}return __setModuleDefault(_0x4c473e,_0xd92f1f),_0x4c473e;};}()),__importDefault=this&&this[a42_0x35a2f2(0x1a8)]||function(_0x4a94a4){const _0x119b53=a42_0x35a2f2;return _0x4a94a4&&_0x4a94a4[_0x119b53(0x1b8)]?_0x4a94a4:{'default':_0x4a94a4};};function a42_0x1cb6(_0x34226d,_0x52d4b5){const _0x2a51d3=a42_0x2a51();return a42_0x1cb6=function(_0x1cb605,_0x630cb2){_0x1cb605=_0x1cb605-0x13a;let _0xe694b3=_0x2a51d3[_0x1cb605];return _0xe694b3;},a42_0x1cb6(_0x34226d,_0x52d4b5);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a42_0x35a2f2(0x15e)]=void 0x0;const crypto_1=__importDefault(require(a42_0x35a2f2(0x17e))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a42_0x35a2f2(0x1f4))),loggerService_1=require(a42_0x35a2f2(0x212));class MasterCardService{constructor(){const _0x243578=a42_0x35a2f2;this[_0x243578(0x1d1)]=new Map(),this[_0x243578(0x1bc)]=_0x243578(0x1d3),this['merchantPointId']=0x3e8,this[_0x243578(0x164)]=path_1[_0x243578(0x176)][_0x243578(0x1fc)](process['cwd'](),'keys',_0x243578(0x146)),this['publicKeyPath']=path_1[_0x243578(0x176)]['join'](process[_0x243578(0x1c5)](),_0x243578(0x170),_0x243578(0x198)),console[_0x243578(0x1e3)](_0x243578(0x18f)),console['log'](_0x243578(0x156),this[_0x243578(0x164)]),console['log'](_0x243578(0x21b),this[_0x243578(0x15f)]),this[_0x243578(0x1c9)]();}[a42_0x35a2f2(0x1c9)](){const _0x2fb068=a42_0x35a2f2;try{if(!fs_1[_0x2fb068(0x176)][_0x2fb068(0x153)](this[_0x2fb068(0x164)]))throw new Error(_0x2fb068(0x1e6)+this[_0x2fb068(0x164)]);if(!fs_1[_0x2fb068(0x176)][_0x2fb068(0x153)](this[_0x2fb068(0x15f)]))throw new Error(_0x2fb068(0x1cf)+this[_0x2fb068(0x15f)]);const _0x4d9e04=fs_1[_0x2fb068(0x176)][_0x2fb068(0x19a)](this[_0x2fb068(0x164)],'utf8')[_0x2fb068(0x1e2)](),_0x2a4d80=fs_1[_0x2fb068(0x176)][_0x2fb068(0x19a)](this['publicKeyPath'],_0x2fb068(0x18a))[_0x2fb068(0x1e2)]();if(!_0x4d9e04[_0x2fb068(0x1b3)](_0x2fb068(0x141))||!_0x4d9e04[_0x2fb068(0x1b3)](_0x2fb068(0x1f7)))throw new Error(_0x2fb068(0x1dc));if(!_0x2a4d80[_0x2fb068(0x1b3)](_0x2fb068(0x141))||!_0x2a4d80[_0x2fb068(0x1b3)](_0x2fb068(0x1f7)))throw new Error(_0x2fb068(0x224));console['log'](_0x2fb068(0x1a9)),console[_0x2fb068(0x1e3)]('🔐\x20Private\x20key\x20length:\x20'+_0x4d9e04[_0x2fb068(0x182)]+'\x20characters'),console[_0x2fb068(0x1e3)](_0x2fb068(0x178)+_0x2a4d80[_0x2fb068(0x182)]+_0x2fb068(0x1f2));}catch(_0x4826cc){console[_0x2fb068(0x171)](_0x2fb068(0x21f),_0x4826cc);throw _0x4826cc;}}[a42_0x35a2f2(0x184)](){const _0x3b912b=a42_0x35a2f2,_0x5a5989=crypto_1['default'][_0x3b912b(0x13d)](0x20),_0x37ce9b=crypto_1[_0x3b912b(0x176)][_0x3b912b(0x13d)](0x10);return{'key':_0x5a5989,'iv':_0x37ce9b};}[a42_0x35a2f2(0x159)](_0x32b87d,_0x4556c6,_0x1420da){const _0x5e2abc=a42_0x35a2f2,_0x3d24b6=crypto_1[_0x5e2abc(0x176)][_0x5e2abc(0x13e)]('aes-256-ctr',_0x4556c6,_0x1420da);let _0x57514f=_0x3d24b6[_0x5e2abc(0x172)](_0x32b87d,_0x5e2abc(0x18a),_0x5e2abc(0x22c));return _0x57514f+=_0x3d24b6['final']('base64'),_0x57514f;}[a42_0x35a2f2(0x148)](_0x284047,_0x2464f7){const _0x2686b0=a42_0x35a2f2;try{const _0x4bf7c9=fs_1[_0x2686b0(0x176)]['readFileSync'](this[_0x2686b0(0x15f)],_0x2686b0(0x18a))[_0x2686b0(0x1e2)](),_0x12a5e3={'iv':_0x2464f7[_0x2686b0(0x161)](_0x2686b0(0x22c)),'key':_0x284047[_0x2686b0(0x161)]('base64')},_0x1e01d7=JSON[_0x2686b0(0x204)](_0x12a5e3);console[_0x2686b0(0x1e3)](_0x2686b0(0x1e1),_0x1e01d7[_0x2686b0(0x182)]);const _0x15c8f7=crypto_1[_0x2686b0(0x176)]['publicEncrypt']({'key':_0x4bf7c9,'padding':crypto_1['default']['constants'][_0x2686b0(0x1a3)]},Buffer[_0x2686b0(0x1ea)](_0x1e01d7));return console['log'](_0x2686b0(0x1de),_0x15c8f7[_0x2686b0(0x182)]),_0x15c8f7[_0x2686b0(0x161)]('base64');}catch(_0x2209f0){console[_0x2686b0(0x171)](_0x2686b0(0x1d7),_0x2209f0);throw new Error(_0x2686b0(0x19f));}}['signRSA'](_0x3ac96e){const _0x2c3a93=a42_0x35a2f2;try{const _0xd2e404=fs_1[_0x2c3a93(0x176)][_0x2c3a93(0x19a)](this[_0x2c3a93(0x164)],_0x2c3a93(0x18a))[_0x2c3a93(0x1e2)](),_0x4fb0e2=crypto_1['default']['createSign']('SHA256');_0x4fb0e2[_0x2c3a93(0x172)](_0x3ac96e),_0x4fb0e2[_0x2c3a93(0x1fd)]();const _0x59d70=_0x4fb0e2[_0x2c3a93(0x1a2)](_0xd2e404,_0x2c3a93(0x22c));return console[_0x2c3a93(0x1e3)](_0x2c3a93(0x1ff)),console[_0x2c3a93(0x1e3)]('📝\x20Data\x20to\x20sign\x20length:',_0x3ac96e[_0x2c3a93(0x182)]),console[_0x2c3a93(0x1e3)](_0x2c3a93(0x1ce),_0x59d70['length']),_0x59d70;}catch(_0x154ea6){console[_0x2c3a93(0x171)](_0x2c3a93(0x1cc),_0x154ea6),console[_0x2c3a93(0x171)](_0x2c3a93(0x1ee),_0x3ac96e[_0x2c3a93(0x201)](0x0,0xc8)+'...');throw new Error(_0x2c3a93(0x1e8));}}[a42_0x35a2f2(0x15b)](_0x459d22,_0x12be7e,_0x540286){const _0x4b1514=a42_0x35a2f2,_0x14b377=crypto_1['default'][_0x4b1514(0x183)](_0x4b1514(0x21c),_0x12be7e,_0x540286);let _0x520033=_0x14b377['update'](_0x459d22,_0x4b1514(0x22c),_0x4b1514(0x18a));return _0x520033+=_0x14b377[_0x4b1514(0x219)](_0x4b1514(0x18a)),_0x520033;}[a42_0x35a2f2(0x190)](_0x15f9e3,_0x28e286){const _0x282391=a42_0x35a2f2;try{const _0x5255fc=fs_1[_0x282391(0x176)]['readFileSync'](this[_0x282391(0x164)],_0x282391(0x18a))['trim']();console[_0x282391(0x1e3)](_0x282391(0x1ac)),console[_0x282391(0x1e3)](_0x282391(0x152),_0x15f9e3['length']),console[_0x282391(0x1e3)](_0x282391(0x189),_0x28e286['length']);const _0x2653fd=crypto_1['default'][_0x282391(0x16d)]({'key':_0x5255fc,'padding':crypto_1['default']['constants'][_0x282391(0x1a3)]},Buffer[_0x282391(0x1ea)](_0x28e286,'base64'));console[_0x282391(0x1e3)]('✅\x20RSA\x20key\x20decryption\x20successful');const _0x4570bc=JSON[_0x282391(0x1ba)](_0x2653fd[_0x282391(0x161)]()),_0x5e56a2=Buffer[_0x282391(0x1ea)](_0x4570bc['key'],_0x282391(0x22c)),_0x262717=Buffer[_0x282391(0x1ea)](_0x4570bc['iv'],'base64');console[_0x282391(0x1e3)](_0x282391(0x1c8)),console['log']('🔐\x20AES\x20key\x20length:',_0x5e56a2['length']),console['log'](_0x282391(0x185),_0x262717['length']);const _0x434d1d=this['decryptAES'](_0x15f9e3,_0x5e56a2,_0x262717);return console[_0x282391(0x1e3)](_0x282391(0x1b9)),console[_0x282391(0x1e3)](_0x282391(0x18d),_0x434d1d['length']),_0x434d1d;}catch(_0xca073d){console[_0x282391(0x171)]('❌\x20Response\x20decryption\x20failed:',_0xca073d);_0xca073d instanceof Error?console[_0x282391(0x171)](_0x282391(0x18b),_0xca073d[_0x282391(0x140)]):console['error']('❌\x20Error\x20details:',_0xca073d);throw new Error(_0x282391(0x151));}}async[a42_0x35a2f2(0x1f6)](_0x548204){const _0x427477=a42_0x35a2f2,{paymentId:_0x2274ad,orderId:_0x25355e,amount:_0x4dea71,currency:_0x181586,cardData:_0x27c8f6,resultUrl:_0x5e4bab,returnUrl:_0x2c76d2,cardHolder:_0x2a1d05,browser:_0x3b838e}=_0x548204;console[_0x427477(0x1e3)](_0x427477(0x17a)),console['log'](_0x427477(0x1c0),_0x2274ad),console[_0x427477(0x1e3)]('Order\x20ID:',_0x25355e),console[_0x427477(0x1e3)](_0x427477(0x1b5),_0x4dea71,_0x181586),console[_0x427477(0x1e3)](_0x427477(0x196),this['maskCardNumber'](_0x27c8f6[_0x427477(0x227)])),console[_0x427477(0x1e3)](_0x427477(0x1da),_0x2a1d05[_0x427477(0x205)]+'\x20'+_0x2a1d05['last_name']),console['log']('Return\x20URL:',_0x2c76d2),console[_0x427477(0x1e3)](_0x427477(0x1a5),_0x5e4bab);const _0x437725={'amount':_0x4dea71,'currency':_0x181586['toUpperCase'](),'order_id':_0x25355e,'result_url':_0x5e4bab,'return_url':_0x2c76d2,'card':{'number':_0x27c8f6[_0x427477(0x227)],'expire_month':_0x27c8f6['expire_month'],'expire_year':_0x27c8f6[_0x427477(0x16f)],'cvv':_0x27c8f6['cvv']},'card_holder':_0x2a1d05,'browser':_0x3b838e},_0x479288=JSON[_0x427477(0x204)](_0x437725);console[_0x427477(0x1e3)](_0x427477(0x208)),console[_0x427477(0x1e3)](_0x427477(0x168)),console[_0x427477(0x1e3)](_0x479288),console[_0x427477(0x1e3)](_0x427477(0x1ef),_0x479288[_0x427477(0x182)]);try{const {key:_0x5d910d,iv:_0x233a2c}=this['generateAESKey']();console[_0x427477(0x1e3)](_0x427477(0x163)),console[_0x427477(0x1e3)](_0x427477(0x213),_0x5d910d[_0x427477(0x182)]),console['log'](_0x427477(0x185),_0x233a2c[_0x427477(0x182)]);const _0x341756=this[_0x427477(0x159)](_0x479288,_0x5d910d,_0x233a2c);console[_0x427477(0x1e3)]('🔐\x20Data\x20encrypted\x20with\x20AES'),console[_0x427477(0x1e3)](_0x427477(0x195),_0x341756['length']);const _0x3f9734=this[_0x427477(0x148)](_0x5d910d,_0x233a2c);console[_0x427477(0x1e3)](_0x427477(0x19d)),console[_0x427477(0x1e3)](_0x427477(0x189),_0x3f9734[_0x427477(0x182)]);const _0x46e330=this[_0x427477(0x226)](_0x479288);console[_0x427477(0x1e3)](_0x427477(0x20c)),console[_0x427477(0x1e3)]('📝\x20Signature\x20length:',_0x46e330['length']);const _0x28c4a7={'merchant_point_id':this[_0x427477(0x206)],'method':_0x427477(0x1bd),'info':_0x341756,'key':_0x3f9734,'sign':_0x46e330,'lang':'en'};console['log'](_0x427477(0x1b0)),console[_0x427477(0x1e3)](_0x427477(0x145)),console['log'](_0x427477(0x1d4),this[_0x427477(0x206)]),console[_0x427477(0x1e3)]('\x20\x20\x20-\x20method:\x20charge'),console[_0x427477(0x1e3)](_0x427477(0x18c),_0x341756[_0x427477(0x182)]),console['log'](_0x427477(0x1e0),_0x3f9734[_0x427477(0x182)]),console[_0x427477(0x1e3)](_0x427477(0x200),_0x46e330[_0x427477(0x182)]),console['log'](_0x427477(0x1bb)),loggerService_1[_0x427477(0x179)][_0x427477(0x1a4)](_0x427477(0x16e),'/charge',_0x427477(0x1c4),{'merchant_point_id':this[_0x427477(0x206)],'method':'charge','lang':'en'});const _0x44e399=Date[_0x427477(0x222)](),_0x2b196c=await fetch(this[_0x427477(0x1bc)],{'method':_0x427477(0x1c4),'headers':{'Content-Type':_0x427477(0x1f3),'Accept':_0x427477(0x1f3),'User-Agent':_0x427477(0x1cd)},'body':JSON[_0x427477(0x204)](_0x28c4a7)}),_0x357058=Date[_0x427477(0x222)]()-_0x44e399;console[_0x427477(0x1e3)](_0x427477(0x1be)),console[_0x427477(0x1e3)](_0x427477(0x143),_0x2b196c[_0x427477(0x14c)]),console[_0x427477(0x1e3)](_0x427477(0x1fa),_0x357058+'ms');if(!_0x2b196c['ok']){const _0x51c23d=await _0x2b196c[_0x427477(0x20b)]();console[_0x427477(0x171)](_0x427477(0x186),_0x2b196c['status']),console[_0x427477(0x171)](_0x427477(0x1ad),_0x51c23d),loggerService_1['loggerService']['logWhiteDomainResponse']('mastercard',_0x427477(0x150),_0x2b196c[_0x427477(0x14c)],_0x51c23d,_0x357058),loggerService_1[_0x427477(0x179)][_0x427477(0x191)]('mastercard',_0x427477(0x220),_0x427477(0x216)+_0x2b196c[_0x427477(0x14c)]+':\x20'+_0x51c23d);throw new Error(_0x427477(0x1c2)+_0x2b196c[_0x427477(0x14c)]+_0x427477(0x1aa)+_0x51c23d);}const _0x23f3ad=await _0x2b196c[_0x427477(0x162)]();loggerService_1[_0x427477(0x179)][_0x427477(0x1c1)](_0x427477(0x16e),_0x427477(0x150),_0x2b196c['status'],_0x23f3ad,_0x357058),console[_0x427477(0x1e3)](_0x427477(0x22b));let _0x2ae079=_0x23f3ad;if(_0x23f3ad[_0x427477(0x1f9)]&&_0x23f3ad[_0x427477(0x22d)]&&_0x23f3ad[_0x427477(0x1a2)]){console[_0x427477(0x1e3)](_0x427477(0x1b2));try{const _0x4f8ba7=this[_0x427477(0x190)](_0x23f3ad[_0x427477(0x1f9)],_0x23f3ad[_0x427477(0x22d)]);_0x2ae079=JSON[_0x427477(0x1ba)](_0x4f8ba7),console[_0x427477(0x1e3)](_0x427477(0x1d2)),loggerService_1[_0x427477(0x179)][_0x427477(0x1c1)](_0x427477(0x16e),_0x427477(0x13a),_0x2b196c[_0x427477(0x14c)],_0x2ae079,_0x357058),console[_0x427477(0x1e3)](_0x427477(0x1ca));}catch(_0x35cf98){console[_0x427477(0x171)]('❌\x20Failed\x20to\x20decrypt\x20response:',_0x35cf98),loggerService_1[_0x427477(0x179)]['logWhiteDomainError']('mastercard','/charge_decrypt',_0x427477(0x194)+_0x35cf98),_0x2ae079=_0x23f3ad;}}else loggerService_1[_0x427477(0x179)]['logWhiteDomainResponse']('mastercard',_0x427477(0x13a),_0x2b196c['status'],_0x2ae079,_0x357058),console['log']('📝\x20Unencrypted\x20response\x20logged\x20to\x20white_domain_responses\x20with\x20endpoint:\x20/charge_decrypted');console[_0x427477(0x1e3)]('Status:',_0x2ae079['status']),console[_0x427477(0x1e3)](_0x427477(0x16c),_0x2ae079[_0x427477(0x219)]),console[_0x427477(0x1e3)]('Payment\x20ID:',_0x2ae079[_0x427477(0x19e)]),console['log'](_0x427477(0x166),_0x2ae079[_0x427477(0x20e)]||_0x427477(0x13f));if(_0x2ae079['status']===0x1&&_0x2ae079['final']===0x1)return console[_0x427477(0x1e3)](_0x427477(0x13c)),{'gateway_payment_id':_0x2ae079[_0x427477(0x19e)]?.['toString'](),'payment_url':_0x2c76d2,'requires_3ds':![],'status':_0x427477(0x225),'final':!![]};else return _0x2ae079[_0x427477(0x20e)]?(console[_0x427477(0x1e3)]('🔐\x203DS\x20verification\x20required'),this[_0x427477(0x1af)](_0x2274ad,_0x25355e,_0x2ae079['payment_id']?.['toString']()||_0x25355e),{'gateway_payment_id':_0x2ae079['payment_id']?.[_0x427477(0x161)](),'payment_url':_0x2ae079[_0x427477(0x20e)],'requires_3ds':!![],'threeds_url':_0x2ae079['3ds_url'],'status':'PENDING','final':![]}):(console[_0x427477(0x1e3)]('❌\x20Payment\x20failed\x20or\x20declined'),{'gateway_payment_id':_0x2ae079['payment_id']?.[_0x427477(0x161)](),'payment_url':_0x2c76d2,'requires_3ds':![],'status':_0x427477(0x1a7),'final':!![]});}catch(_0x53b126){console[_0x427477(0x171)](_0x427477(0x157)),console[_0x427477(0x171)](_0x427477(0x1e5),_0x53b126),loggerService_1[_0x427477(0x179)][_0x427477(0x191)](_0x427477(0x16e),_0x427477(0x220),_0x53b126);throw new Error('Failed\x20to\x20process\x20MasterCard\x20payment:\x20'+(_0x53b126 instanceof Error?_0x53b126[_0x427477(0x140)]:_0x427477(0x20a)));}}async[a42_0x35a2f2(0x169)](_0x4d24c2,_0x55b5b9){const _0x1e4276=a42_0x35a2f2;console[_0x1e4276(0x1e3)](_0x1e4276(0x187)+_0x4d24c2+'\x20('+_0x55b5b9+')');try{const _0x1f38e5={'payment_id':_0x4d24c2,'order_id':_0x55b5b9},_0x46658c=JSON[_0x1e4276(0x204)](_0x1f38e5),{key:_0x3df999,iv:_0x56ea8e}=this[_0x1e4276(0x184)](),_0x41b607=this[_0x1e4276(0x159)](_0x46658c,_0x3df999,_0x56ea8e),_0x5a4f43=this[_0x1e4276(0x148)](_0x3df999,_0x56ea8e),_0x28b231=this[_0x1e4276(0x226)](_0x46658c),_0x256e69={'merchant_point_id':this[_0x1e4276(0x206)],'method':_0x1e4276(0x14c),'info':_0x41b607,'key':_0x5a4f43,'sign':_0x28b231,'lang':'en'};loggerService_1[_0x1e4276(0x179)]['logWhiteDomainRequest'](_0x1e4276(0x16e),_0x1e4276(0x21d),'POST',{'merchant_point_id':this[_0x1e4276(0x206)],'method':_0x1e4276(0x14c),'lang':'en'});const _0x57289d=Date[_0x1e4276(0x222)](),_0x504522=await fetch(this[_0x1e4276(0x1bc)],{'method':'POST','headers':{'Content-Type':_0x1e4276(0x1f3),'Accept':_0x1e4276(0x1f3),'User-Agent':_0x1e4276(0x1cd)},'body':JSON[_0x1e4276(0x204)](_0x256e69)}),_0x3b3e17=Date[_0x1e4276(0x222)]()-_0x57289d;if(!_0x504522['ok']){const _0x1bff50=await _0x504522['text']();loggerService_1['loggerService']['logWhiteDomainResponse'](_0x1e4276(0x16e),_0x1e4276(0x18e),_0x504522['status'],_0x1bff50,_0x3b3e17);throw new Error(_0x1e4276(0x1c2)+_0x504522['status']);}const _0x551e08=await _0x504522['json']();loggerService_1['loggerService'][_0x1e4276(0x1c1)]('mastercard',_0x1e4276(0x18e),_0x504522['status'],_0x551e08,_0x3b3e17);let _0x1d5faf=_0x551e08;if(_0x551e08[_0x1e4276(0x1f9)]&&_0x551e08[_0x1e4276(0x22d)]&&_0x551e08[_0x1e4276(0x1a2)]){console[_0x1e4276(0x1e3)](_0x1e4276(0x165));try{const _0x51e718=this[_0x1e4276(0x190)](_0x551e08[_0x1e4276(0x1f9)],_0x551e08[_0x1e4276(0x22d)]);_0x1d5faf=JSON[_0x1e4276(0x1ba)](_0x51e718),console[_0x1e4276(0x1e3)](_0x1e4276(0x147)),loggerService_1['loggerService'][_0x1e4276(0x1c1)](_0x1e4276(0x16e),'/status_decrypted',_0x504522[_0x1e4276(0x14c)],_0x1d5faf,_0x3b3e17),console[_0x1e4276(0x1e3)](_0x1e4276(0x144));}catch(_0x5e2011){console[_0x1e4276(0x171)]('❌\x20Failed\x20to\x20decrypt\x20status\x20response:',_0x5e2011),loggerService_1['loggerService'][_0x1e4276(0x191)]('mastercard',_0x1e4276(0x203),'Status\x20decryption\x20failed:\x20'+_0x5e2011),_0x1d5faf=_0x551e08;}}else loggerService_1[_0x1e4276(0x179)][_0x1e4276(0x1c1)](_0x1e4276(0x16e),_0x1e4276(0x142),_0x504522['status'],_0x1d5faf,_0x3b3e17),console[_0x1e4276(0x1e3)](_0x1e4276(0x13b));console[_0x1e4276(0x1e3)]('📊\x20Status\x20check\x20result:',{'status':_0x1d5faf[_0x1e4276(0x14c)],'final':_0x1d5faf[_0x1e4276(0x219)],'payment_id':_0x1d5faf['payment_id'],'desc':_0x1d5faf[_0x1e4276(0x21a)]});let _0x5c8ecf=_0x1e4276(0x221);if(_0x1d5faf['status']===0x1&&_0x1d5faf['final']===0x1)_0x5c8ecf=_0x1e4276(0x225);else _0x1d5faf['status']===0x0&&_0x1d5faf[_0x1e4276(0x219)]===0x0?_0x5c8ecf=_0x1e4276(0x221):_0x5c8ecf=_0x1e4276(0x1a7);return{'status':_0x5c8ecf,'final':_0x1d5faf['final']===0x1,'amount':_0x1d5faf['amount'],'currency':_0x1d5faf[_0x1e4276(0x167)],'date_success':_0x1d5faf[_0x1e4276(0x16b)],'description':_0x1d5faf['desc']};}catch(_0x36089a){console[_0x1e4276(0x171)]('MasterCard\x20status\x20check\x20error:',_0x36089a),loggerService_1[_0x1e4276(0x179)][_0x1e4276(0x191)](_0x1e4276(0x16e),'/status',_0x36089a);throw new Error(_0x1e4276(0x1cb)+(_0x36089a instanceof Error?_0x36089a[_0x1e4276(0x140)]:_0x1e4276(0x20a)));}}['scheduleStatusChecks'](_0x493929,_0x8d90ed,_0xdde65e){const _0x3600df=a42_0x35a2f2;console[_0x3600df(0x1e3)](_0x3600df(0x14d)+_0x493929+'\x20('+_0xdde65e+')'),this[_0x3600df(0x1c7)](_0x493929);const _0x2b22c6=[],_0x4429ef=0x5*0x3c*0x3e8,_0x3b1f16=0x2*0x3c*0x3c*0x3e8,_0xe01dd1=Math[_0x3600df(0x217)](_0x3b1f16/_0x4429ef);console[_0x3600df(0x1e3)]('⏰\x20Will\x20check\x20status\x20'+_0xe01dd1+'\x20times\x20every\x205\x20minutes\x20for\x202\x20hours');for(let _0x2cdddb=0x1;_0x2cdddb<=_0xe01dd1;_0x2cdddb++){const _0xe15cbf=setTimeout(async()=>{const _0x5f1775=_0x3600df;console[_0x5f1775(0x1e3)]('🔍\x20MasterCard\x20status\x20check\x20#'+_0x2cdddb+'/'+_0xe01dd1+'\x20for\x20payment\x20'+_0x493929);try{const _0x407f62=await this[_0x5f1775(0x169)](_0xdde65e,_0x8d90ed);console['log'](_0x5f1775(0x218)+_0x2cdddb+_0x5f1775(0x1dd),_0x407f62),_0x407f62[_0x5f1775(0x219)]&&(console['log'](_0x5f1775(0x22e)+_0x493929+'\x20is\x20final\x20('+_0x407f62[_0x5f1775(0x14c)]+'),\x20stopping\x20status\x20checks'),this['clearStatusTimers'](_0x493929),await this[_0x5f1775(0x19c)](_0x493929,_0x407f62[_0x5f1775(0x14c)],_0x407f62));}catch(_0x236edd){console[_0x5f1775(0x171)](_0x5f1775(0x19b)+_0x2cdddb+'\x20failed\x20for\x20payment\x20'+_0x493929+':',_0x236edd);}},_0x2cdddb*_0x4429ef);_0x2b22c6[_0x3600df(0x1b6)](_0xe15cbf);}this[_0x3600df(0x1d1)][_0x3600df(0x15a)](_0x493929,_0x2b22c6),console[_0x3600df(0x1e3)]('✅\x20Scheduled\x20'+_0xe01dd1+_0x3600df(0x14e)+_0x493929);}['clearStatusTimers'](_0x3ed707){const _0x12601b=a42_0x35a2f2,_0x473f4a=this[_0x12601b(0x1d1)][_0x12601b(0x14f)](_0x3ed707);_0x473f4a&&(console[_0x12601b(0x1e3)](_0x12601b(0x193)+_0x473f4a[_0x12601b(0x182)]+_0x12601b(0x1fb)+_0x3ed707),_0x473f4a[_0x12601b(0x209)]((_0xf66856,_0x111c55)=>{clearTimeout(_0xf66856);}),this[_0x12601b(0x1d1)][_0x12601b(0x215)](_0x3ed707));}async[a42_0x35a2f2(0x19c)](_0x8be32b,_0x27197a,_0x1c7e9b){const _0x4761f5=a42_0x35a2f2;try{const _0x45312b=(await Promise[_0x4761f5(0x207)]()['then'](()=>__importStar(require(_0x4761f5(0x173)))))[_0x4761f5(0x176)],_0x5813ab={'status':_0x27197a['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x4761f5(0x177),'statusChangedAt':new Date()};_0x27197a===_0x4761f5(0x225)&&(_0x5813ab[_0x4761f5(0x17b)]=new Date()),_0x1c7e9b[_0x4761f5(0x1ab)]&&(_0x5813ab[_0x4761f5(0x15c)]='MasterCard:\x20'+_0x1c7e9b[_0x4761f5(0x1ab)]),await _0x45312b[_0x4761f5(0x211)][_0x4761f5(0x172)]({'where':{'id':_0x8be32b},'data':_0x5813ab}),console[_0x4761f5(0x1e3)]('✅\x20Payment\x20'+_0x8be32b+_0x4761f5(0x17d)+_0x27197a),await this[_0x4761f5(0x149)](_0x8be32b,_0x27197a);}catch(_0x4dd9c1){console[_0x4761f5(0x171)]('❌\x20Failed\x20to\x20update\x20payment\x20status\x20for\x20'+_0x8be32b+':',_0x4dd9c1);}}async[a42_0x35a2f2(0x149)](_0x517ef5,_0x38a2a4){const _0x44f308=a42_0x35a2f2;try{const _0x25c2af=(await Promise[_0x44f308(0x207)]()[_0x44f308(0x180)](()=>__importStar(require(_0x44f308(0x173)))))[_0x44f308(0x176)],{telegramBotService:_0x55c3ae}=await Promise['resolve']()['then'](()=>__importStar(require(_0x44f308(0x1ae)))),_0xb59b7d=await _0x25c2af['payment'][_0x44f308(0x1ec)]({'where':{'id':_0x517ef5},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0xb59b7d)return;const _0x25fd19={'PAID':_0x44f308(0x22a),'FAILED':_0x44f308(0x1df)},_0x328996=_0x25fd19[_0x38a2a4];_0x328996&&await _0x55c3ae[_0x44f308(0x202)](_0xb59b7d[_0x44f308(0x1a0)],_0xb59b7d,_0x328996),await this['sendShopWebhook'](_0xb59b7d,_0x38a2a4);}catch(_0x5b029e){console[_0x44f308(0x171)](_0x44f308(0x21e),_0x5b029e);}}async['sendShopWebhook'](_0x29c523,_0x49b2c7){const _0x1b664a=a42_0x35a2f2,_0x309fa1=Date[_0x1b664a(0x222)]();try{const _0x3ea675=_0x29c523[_0x1b664a(0x160)],_0x792b3=_0x3ea675['settings'];if(!_0x792b3?.[_0x1b664a(0x1e7)]){console[_0x1b664a(0x1e3)](_0x1b664a(0x17c)+_0x3ea675['id']);return;}const _0xe9737=_0x49b2c7==='PAID'?_0x1b664a(0x1f8):'payment.failed';let _0x2ff7f8=[];if(_0x792b3[_0x1b664a(0x14a)])try{_0x2ff7f8=Array[_0x1b664a(0x1a1)](_0x792b3[_0x1b664a(0x14a)])?_0x792b3[_0x1b664a(0x14a)]:JSON[_0x1b664a(0x1ba)](_0x792b3['webhookEvents']);}catch(_0x4a6f08){console[_0x1b664a(0x171)]('Error\x20parsing\x20webhook\x20events:',_0x4a6f08),_0x2ff7f8=[];}if(!_0x2ff7f8[_0x1b664a(0x1b3)](_0xe9737)){console[_0x1b664a(0x1e3)](_0x1b664a(0x181)+_0xe9737+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3ea675['id']);return;}const _0x2346e6={'event':_0xe9737,'payment':{'id':_0x29c523['id'],'order_id':_0x29c523[_0x1b664a(0x20d)],'gateway_order_id':_0x29c523['gatewayOrderId'],'gateway':_0x1b664a(0x175),'amount':_0x29c523[_0x1b664a(0x1eb)],'currency':_0x29c523[_0x1b664a(0x167)],'status':_0x49b2c7[_0x1b664a(0x1f1)](),'customer_email':_0x29c523[_0x1b664a(0x1c3)],'customer_name':_0x29c523[_0x1b664a(0x1b7)],'created_at':_0x29c523[_0x1b664a(0x15d)],'updated_at':new Date()}},_0x3cb5f5=await fetch(_0x792b3[_0x1b664a(0x1e7)],{'method':_0x1b664a(0x1c4),'headers':{'Content-Type':_0x1b664a(0x1f3),'User-Agent':_0x1b664a(0x1a6)},'body':JSON['stringify'](_0x2346e6)}),_0x4e5bbe=Date[_0x1b664a(0x222)]()-_0x309fa1;loggerService_1['loggerService'][_0x1b664a(0x1b4)](_0x29c523['shopId'],_0x792b3[_0x1b664a(0x1e7)],_0xe9737,_0x3cb5f5[_0x1b664a(0x14c)],_0x4e5bbe,_0x2346e6),console[_0x1b664a(0x1e3)](_0x1b664a(0x1f0)+_0x792b3[_0x1b664a(0x1e7)]+_0x1b664a(0x1db)+_0x3cb5f5[_0x1b664a(0x14c)]+'\x20('+_0x4e5bbe+'ms)');}catch(_0x319ebf){console[_0x1b664a(0x171)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x319ebf),loggerService_1[_0x1b664a(0x179)][_0x1b664a(0x20f)](_0x29c523[_0x1b664a(0x1a0)],_0x29c523[_0x1b664a(0x160)]?.['settings']?.['webhookUrl']||'unknown',_0x1b664a(0x1d9),_0x319ebf,{});}}['maskCardNumber'](_0x345a9e){const _0x11ca04=a42_0x35a2f2,_0x2e8858=_0x345a9e['replace'](/[\s-]/g,'');if(_0x2e8858[_0x11ca04(0x182)]<0x4)return _0x11ca04(0x1b1);return _0x11ca04(0x1d8)+_0x2e8858[_0x11ca04(0x16a)](-0x4);}async[a42_0x35a2f2(0x1d0)](_0x4a00ad){const _0x411035=a42_0x35a2f2;console[_0x411035(0x1e3)](_0x411035(0x155),_0x4a00ad);let _0x43c75b=_0x411035(0x221);if(_0x4a00ad['status']===0x1&&_0x4a00ad[_0x411035(0x219)]===0x1)_0x43c75b=_0x411035(0x225);else _0x4a00ad[_0x411035(0x14c)]===0x0&&_0x4a00ad[_0x411035(0x219)]===0x0?_0x43c75b=_0x411035(0x221):_0x43c75b='FAILED';return{'paymentId':_0x4a00ad[_0x411035(0x228)]||'','status':_0x43c75b,'amount':_0x4a00ad[_0x411035(0x1eb)],'currency':_0x4a00ad[_0x411035(0x167)]};}[a42_0x35a2f2(0x1c6)](){const _0x1bdae9=a42_0x35a2f2;console[_0x1bdae9(0x1e3)](_0x1bdae9(0x210));const _0xd0c8e9=this[_0x1bdae9(0x1d1)][_0x1bdae9(0x17f)];for(const [_0x5263ce]of this['statusCheckTimers']){this[_0x1bdae9(0x1c7)](_0x5263ce);}console[_0x1bdae9(0x1e3)](_0x1bdae9(0x1e9)+_0xd0c8e9+_0x1bdae9(0x154));}}exports['MasterCardService']=MasterCardService;