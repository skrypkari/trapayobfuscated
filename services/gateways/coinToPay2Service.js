'use strict';function a40_0x43f8(_0xbe2ac,_0xecbdc9){const _0x5b30c1=a40_0x5b30();return a40_0x43f8=function(_0x43f876,_0x3f9edc){_0x43f876=_0x43f876-0x132;let _0x1f0244=_0x5b30c1[_0x43f876];return _0x1f0244;},a40_0x43f8(_0xbe2ac,_0xecbdc9);}const a40_0x2f6868=a40_0x43f8;(function(_0x2c7217,_0x508be1){const _0x4b0f28=a40_0x43f8,_0x46d03b=_0x2c7217();while(!![]){try{const _0x417a0c=-parseInt(_0x4b0f28(0x13f))/0x1*(parseInt(_0x4b0f28(0x146))/0x2)+-parseInt(_0x4b0f28(0x181))/0x3+parseInt(_0x4b0f28(0x19f))/0x4+-parseInt(_0x4b0f28(0x183))/0x5+-parseInt(_0x4b0f28(0x144))/0x6*(-parseInt(_0x4b0f28(0x186))/0x7)+parseInt(_0x4b0f28(0x13b))/0x8+parseInt(_0x4b0f28(0x139))/0x9;if(_0x417a0c===_0x508be1)break;else _0x46d03b['push'](_0x46d03b['shift']());}catch(_0x1eea0e){_0x46d03b['push'](_0x46d03b['shift']());}}}(a40_0x5b30,0x83117));Object['defineProperty'](exports,a40_0x2f6868(0x14f),{'value':!![]}),exports['CoinToPay2Service']=void 0x0;const loggerService_1=require('../loggerService');function a40_0x5b30(){const _0x198f33=['PaymentDetail','success','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Unknown\x20error\x20from\x20CoinToPay2\x20API','pending','data','paid','https://traffer.uk/gateway/cointopay/status.php','Payment\x20Status:','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','9175977WPosnL','awaiting\x20fiat','2168288jvXEhZ','HTTP\x20Status:','Result:','TransactionConfirmedOn','1QqsIbl','coinAddress','PAID','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','===\x20COINTOPAY2\x20SUCCESS\x20===','1698LoTPIm','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','1401502WSJwRF','Parsed\x20Result:','waiting','checkPaymentStatus','Error\x20details:','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','order_id','loggerService',',\x20body:\x20','__esModule','Status\x20API\x20Error:\x20','Transaction\x20ID:','timeout','/status','amount','result','Amount','🪙\x20Creating\x20CoinToPay2\x20payment:\x20','https://traffer.uk/gateway/cointopay/','Response\x20Time:','Status\x20Code:','statusUrl','Error\x20Message:','🪙\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','Payment\x20URL:','Created\x20On:','EUR','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','log','inputCurrency','Headers:','Confirmed\x20On:','Currency:','\x20EUR','Error\x20message:','error','entries','Missing\x20data\x20in\x20response','CoinToPay2Service','Status:','created','logWhiteDomainResponse','/create','text','IBAN:','status','not\x20confirmed','not\x20found','cancelled','stringify','Failed\x20to\x20parse\x20JSON\x20response:','JSON\x20Parse\x20Error:\x20','Raw\x20Response\x20Body:','CoinToPay2\x20status\x20API\x20error:\x20','expired','FAILED','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','Unknown\x20error','2669106NgPWXQ','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','5286840DqzpLg','EXPIRED','toLowerCase','25515uYgFnH','PENDING','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','Amount:','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','Status','📊\x20Status\x20check\x20URL:','fromEntries','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','apiUrl','TransactionID','status_code','match','logWhiteDomainRequest','Gateway\x20Payment\x20ID:','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','📊\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','message','Incomplete\x20response:\x20missing\x20data','✅\x20\x22Paid\x22\x20mapped\x20to\x20PAID','headers','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','cointopay2','3450208FAVWJQ','POST','payment_url','QRCodeURL','statusText','Business\x20Error:\x20','CoinToPay2\x20payment\x20status\x20check\x20error:','failed','currency','logWhiteDomainError','HTTP\x20error!\x20status:\x20','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','HTTP\x20','CoinToPay2\x20API\x20error:\x20','CreatedOn','application/json','Response\x20Body:','now','gateway_payment_id','parse','Status\x20Text:'];a40_0x5b30=function(){return _0x198f33;};return a40_0x5b30();}class CoinToPay2Service{constructor(){const _0x1589dd=a40_0x2f6868;this['apiUrl']=_0x1589dd(0x158),this[_0x1589dd(0x15b)]=_0x1589dd(0x136),console[_0x1589dd(0x163)](_0x1589dd(0x15d)),console[_0x1589dd(0x163)](_0x1589dd(0x18c),this[_0x1589dd(0x15b)]);}async['createPaymentLink'](_0x5efe02){const _0x1f0657=a40_0x2f6868,{orderId:_0xcf1ba6,amount:_0x182d4e}=_0x5efe02;console[_0x1f0657(0x163)](_0x1f0657(0x157)+_0x182d4e+_0x1f0657(0x168));const _0x19ca89={'amount':_0x182d4e},_0x251b74=Date[_0x1f0657(0x1b0)]();try{console[_0x1f0657(0x163)]('===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20==='),console[_0x1f0657(0x163)]('URL:',this[_0x1f0657(0x18f)]),console[_0x1f0657(0x163)]('Request\x20Body:',JSON[_0x1f0657(0x178)](_0x19ca89,null,0x2)),console[_0x1f0657(0x163)](_0x1f0657(0x189),_0x182d4e,_0x1f0657(0x138)),loggerService_1[_0x1f0657(0x14d)][_0x1f0657(0x193)](_0x1f0657(0x19e),_0x1f0657(0x171),_0x1f0657(0x1a0),_0x19ca89);const _0x434021=await fetch(this[_0x1f0657(0x18f)],{'method':_0x1f0657(0x1a0),'headers':{'Content-Type':_0x1f0657(0x1ae),'Accept':_0x1f0657(0x1ae),'User-Agent':_0x1f0657(0x142)},'body':JSON[_0x1f0657(0x178)](_0x19ca89)}),_0x3aa251=Date[_0x1f0657(0x1b0)]()-_0x251b74;console['log'](_0x1f0657(0x17f)),console[_0x1f0657(0x163)](_0x1f0657(0x16e),_0x434021['status']),console[_0x1f0657(0x163)](_0x1f0657(0x1b3),_0x434021[_0x1f0657(0x1a3)]),console[_0x1f0657(0x163)](_0x1f0657(0x165),Object[_0x1f0657(0x18d)](_0x434021[_0x1f0657(0x19c)][_0x1f0657(0x16b)]())),console[_0x1f0657(0x163)](_0x1f0657(0x159),_0x3aa251+'ms');const _0x29a934=await _0x434021[_0x1f0657(0x172)]();console[_0x1f0657(0x163)](_0x1f0657(0x17b),_0x29a934);if(!_0x434021['ok']){console[_0x1f0657(0x16a)]('===\x20COINTOPAY2\x20API\x20ERROR\x20==='),console[_0x1f0657(0x16a)](_0x1f0657(0x13c),_0x434021[_0x1f0657(0x174)]),console['error'](_0x1f0657(0x1af),_0x29a934),loggerService_1[_0x1f0657(0x14d)][_0x1f0657(0x170)](_0x1f0657(0x19e),'/create',_0x434021[_0x1f0657(0x174)],_0x29a934,_0x3aa251),loggerService_1['loggerService']['logWhiteDomainError'](_0x1f0657(0x19e),_0x1f0657(0x171),_0x1f0657(0x1ab)+_0x434021[_0x1f0657(0x174)]+':\x20'+_0x29a934);throw new Error('HTTP\x20error!\x20status:\x20'+_0x434021['status']+_0x1f0657(0x14e)+_0x29a934);}let _0x9b330e;try{_0x9b330e=JSON[_0x1f0657(0x1b2)](_0x29a934);}catch(_0x48f1ca){console[_0x1f0657(0x16a)](_0x1f0657(0x179),_0x48f1ca),loggerService_1[_0x1f0657(0x14d)][_0x1f0657(0x1a8)](_0x1f0657(0x19e),_0x1f0657(0x171),_0x1f0657(0x17a)+_0x48f1ca);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20'+_0x29a934);}console[_0x1f0657(0x163)](_0x1f0657(0x162)),console[_0x1f0657(0x163)](_0x1f0657(0x147),JSON['stringify'](_0x9b330e,null,0x2)),loggerService_1[_0x1f0657(0x14d)]['logWhiteDomainResponse'](_0x1f0657(0x19e),'/create',_0x434021[_0x1f0657(0x174)],_0x9b330e,_0x3aa251);if(_0x9b330e[_0x1f0657(0x16a)]){const _0x398ea0=_0x9b330e[_0x1f0657(0x199)]||_0x9b330e['error']||_0x1f0657(0x132);console[_0x1f0657(0x16a)](_0x1f0657(0x161)),console[_0x1f0657(0x16a)](_0x1f0657(0x15c),_0x398ea0),loggerService_1[_0x1f0657(0x14d)][_0x1f0657(0x1a8)]('cointopay2',_0x1f0657(0x171),_0x1f0657(0x1a4)+_0x398ea0);throw new Error(_0x1f0657(0x1ac)+_0x398ea0);}if(!_0x9b330e['payment_url']||!_0x9b330e['gateway_payment_id']){console['error']('===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x1f0657(0x16a)](_0x1f0657(0x195)),console[_0x1f0657(0x16a)]('Response\x20data:',_0x9b330e),loggerService_1[_0x1f0657(0x14d)][_0x1f0657(0x1a8)]('cointopay2',_0x1f0657(0x171),_0x1f0657(0x198));throw new Error(_0x1f0657(0x14b));}return console[_0x1f0657(0x163)](_0x1f0657(0x143)),console[_0x1f0657(0x163)](_0x1f0657(0x194),_0x9b330e['gateway_payment_id']),console[_0x1f0657(0x163)](_0x1f0657(0x15e),_0x9b330e['payment_url']),console[_0x1f0657(0x163)](_0x1f0657(0x189),_0x182d4e,_0x1f0657(0x160)),{'gateway_payment_id':_0x9b330e[_0x1f0657(0x1b1)],'payment_url':_0x9b330e[_0x1f0657(0x1a1)]};}catch(_0x29bec7){console[_0x1f0657(0x16a)]('===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20==='),console[_0x1f0657(0x16a)](_0x1f0657(0x14a),_0x29bec7),loggerService_1[_0x1f0657(0x14d)][_0x1f0657(0x1a8)](_0x1f0657(0x19e),_0x1f0657(0x171),_0x29bec7);if(_0x29bec7 instanceof Error){console['error'](_0x1f0657(0x169),_0x29bec7[_0x1f0657(0x199)]),console[_0x1f0657(0x16a)]('Error\x20stack:',_0x29bec7['stack']);throw new Error(_0x1f0657(0x188)+_0x29bec7[_0x1f0657(0x199)]);}throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error');}}async['checkPaymentStatus'](_0x536aee){const _0x52afe0=a40_0x2f6868,_0xc7e59a=Date['now']();try{console[_0x52afe0(0x163)](_0x52afe0(0x197)+_0x536aee);const _0x24c873={'gatewayPaymentId':_0x536aee};loggerService_1['loggerService'][_0x52afe0(0x193)](_0x52afe0(0x19e),_0x52afe0(0x153),_0x52afe0(0x1a0),_0x24c873);const _0x199744=await fetch(this[_0x52afe0(0x15b)],{'method':_0x52afe0(0x1a0),'headers':{'Content-Type':_0x52afe0(0x1ae),'Accept':_0x52afe0(0x1ae),'User-Agent':_0x52afe0(0x142)},'body':JSON['stringify'](_0x24c873)}),_0x44661e=Date[_0x52afe0(0x1b0)]()-_0xc7e59a;console[_0x52afe0(0x163)](_0x52afe0(0x196)),console[_0x52afe0(0x163)](_0x52afe0(0x16e),_0x199744[_0x52afe0(0x174)]),console[_0x52afe0(0x163)](_0x52afe0(0x159),_0x44661e+'ms');if(!_0x199744['ok']){const _0x25b11e=await _0x199744['text']();console[_0x52afe0(0x16a)](_0x52afe0(0x13c),_0x199744[_0x52afe0(0x174)]),console[_0x52afe0(0x16a)](_0x52afe0(0x1af),_0x25b11e),loggerService_1[_0x52afe0(0x14d)][_0x52afe0(0x170)]('cointopay2',_0x52afe0(0x153),_0x199744[_0x52afe0(0x174)],_0x25b11e,_0x44661e),loggerService_1['loggerService'][_0x52afe0(0x1a8)](_0x52afe0(0x19e),_0x52afe0(0x153),'HTTP\x20'+_0x199744[_0x52afe0(0x174)]+':\x20'+_0x25b11e);throw new Error(_0x52afe0(0x1a9)+_0x199744[_0x52afe0(0x174)]);}const _0x56e15c=await _0x199744[_0x52afe0(0x172)]();console[_0x52afe0(0x163)](_0x52afe0(0x17b),_0x56e15c);let _0x12e900;try{_0x12e900=JSON[_0x52afe0(0x1b2)](_0x56e15c);}catch(_0x18633e){console[_0x52afe0(0x16a)](_0x52afe0(0x179),_0x18633e),loggerService_1['loggerService'][_0x52afe0(0x1a8)]('cointopay2',_0x52afe0(0x153),_0x52afe0(0x17a)+_0x18633e);throw new Error(_0x52afe0(0x18e)+_0x56e15c);}loggerService_1[_0x52afe0(0x14d)][_0x52afe0(0x170)]('cointopay2',_0x52afe0(0x153),_0x199744['status'],_0x12e900,_0x44661e),console['log']('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console['log'](_0x52afe0(0x13d),_0x12e900[_0x52afe0(0x155)]),console['log'](_0x52afe0(0x15a),_0x12e900[_0x52afe0(0x191)]),console['log'](_0x52afe0(0x137),_0x12e900[_0x52afe0(0x134)]?.[_0x52afe0(0x18b)]),console[_0x52afe0(0x163)](_0x52afe0(0x189),_0x12e900[_0x52afe0(0x134)]?.[_0x52afe0(0x156)]),console['log'](_0x52afe0(0x167),_0x12e900[_0x52afe0(0x134)]?.[_0x52afe0(0x164)]);if(_0x12e900[_0x52afe0(0x155)]!==_0x52afe0(0x1b5)||_0x12e900[_0x52afe0(0x191)]!==0xc8){const _0x5d1437=_0x12e900[_0x52afe0(0x199)]||'Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API';console[_0x52afe0(0x16a)](_0x52afe0(0x18a)),console[_0x52afe0(0x16a)](_0x52afe0(0x15c),_0x5d1437),loggerService_1[_0x52afe0(0x14d)][_0x52afe0(0x1a8)](_0x52afe0(0x19e),'/status',_0x52afe0(0x150)+_0x5d1437);throw new Error(_0x52afe0(0x17c)+_0x5d1437);}if(!_0x12e900[_0x52afe0(0x134)]){console[_0x52afe0(0x16a)](_0x52afe0(0x1b6)),console['error'](_0x52afe0(0x16c)),loggerService_1[_0x52afe0(0x14d)][_0x52afe0(0x1a8)]('cointopay2',_0x52afe0(0x153),_0x52afe0(0x19a));throw new Error(_0x52afe0(0x19d));}let _0x20e720='PENDING';switch(_0x12e900[_0x52afe0(0x134)][_0x52afe0(0x18b)]?.[_0x52afe0(0x185)]()){case _0x52afe0(0x135):_0x20e720=_0x52afe0(0x141);break;case'cancelled':case _0x52afe0(0x1a6):case _0x52afe0(0x16a):_0x20e720=_0x52afe0(0x17e);break;case'expired':case _0x52afe0(0x152):_0x20e720=_0x52afe0(0x184);break;case _0x52afe0(0x148):case'awaiting\x20fiat':case _0x52afe0(0x133):case _0x52afe0(0x16f):default:_0x20e720='PENDING';break;}let _0x37821e,_0x3b5e0a;if(_0x12e900['data']['PaymentDetail']){const _0x444db3=_0x12e900[_0x52afe0(0x134)][_0x52afe0(0x1b4)];console[_0x52afe0(0x163)]('🏦\x20Payment\x20Detail:',_0x444db3);const _0x4247fb=_0x444db3[_0x52afe0(0x192)](/IBAN\s+([A-Z0-9]+)/i);_0x4247fb&&(_0x37821e=_0x4247fb[0x1],console[_0x52afe0(0x163)]('🏦\x20Extracted\x20IBAN:',_0x37821e)),_0x3b5e0a=_0x444db3;}const _0x520df5={'iban':_0x37821e,'bankDetails':_0x3b5e0a,'transactionId':_0x12e900[_0x52afe0(0x134)][_0x52afe0(0x190)],'coinAddress':_0x12e900[_0x52afe0(0x134)][_0x52afe0(0x140)],'qrCodeUrl':_0x12e900['data'][_0x52afe0(0x1a2)],'expiryTime':_0x12e900['data']['ExpiryTime'],'createdOn':_0x12e900[_0x52afe0(0x134)][_0x52afe0(0x1ad)],'confirmedOn':_0x12e900[_0x52afe0(0x134)][_0x52afe0(0x13e)]};console[_0x52afe0(0x163)](_0x52afe0(0x182)),console[_0x52afe0(0x163)](_0x52afe0(0x16e),_0x12e900['data'][_0x52afe0(0x18b)],'->',_0x20e720),console[_0x52afe0(0x163)](_0x52afe0(0x189),_0x12e900[_0x52afe0(0x134)][_0x52afe0(0x156)],_0x12e900['data'][_0x52afe0(0x164)]),console[_0x52afe0(0x163)](_0x52afe0(0x151),_0x12e900[_0x52afe0(0x134)][_0x52afe0(0x190)]),console[_0x52afe0(0x163)](_0x52afe0(0x173),_0x37821e||_0x52afe0(0x176)),console[_0x52afe0(0x163)](_0x52afe0(0x15f),_0x12e900['data'][_0x52afe0(0x1ad)]),console['log'](_0x52afe0(0x166),_0x12e900[_0x52afe0(0x134)][_0x52afe0(0x13e)]||_0x52afe0(0x175));if(_0x12e900[_0x52afe0(0x134)]['Status']?.[_0x52afe0(0x185)]()===_0x52afe0(0x13a))console[_0x52afe0(0x163)]('💡\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)');else _0x12e900[_0x52afe0(0x134)][_0x52afe0(0x18b)]?.[_0x52afe0(0x185)]()==='paid'&&console[_0x52afe0(0x163)](_0x52afe0(0x19b));return{'status':_0x20e720,'amount':parseFloat(_0x12e900[_0x52afe0(0x134)][_0x52afe0(0x156)])||undefined,'currency':_0x12e900[_0x52afe0(0x134)][_0x52afe0(0x164)]||_0x52afe0(0x160),'paymentDetails':_0x520df5};}catch(_0x41bca5){console[_0x52afe0(0x16a)](_0x52afe0(0x1a5),_0x41bca5),loggerService_1[_0x52afe0(0x14d)][_0x52afe0(0x1a8)](_0x52afe0(0x19e),'/status',_0x41bca5);throw new Error(_0x52afe0(0x145)+(_0x41bca5 instanceof Error?_0x41bca5['message']:_0x52afe0(0x180)));}}async['verifyPayment'](_0x43eb63){const _0x312b78=a40_0x2f6868,_0x4533b7=await this[_0x312b78(0x149)](_0x43eb63);return{'status':_0x4533b7['status'],'amount':_0x4533b7[_0x312b78(0x154)],'currency':_0x4533b7[_0x312b78(0x1a7)]};}async['processWebhook'](_0x67928d){const _0x2e42ca=a40_0x2f6868;console[_0x2e42ca(0x163)](_0x2e42ca(0x1aa),_0x67928d);let _0x1264fc=_0x2e42ca(0x187);switch(_0x67928d[_0x2e42ca(0x174)]?.[_0x2e42ca(0x185)]()){case _0x2e42ca(0x135):_0x1264fc=_0x2e42ca(0x141);break;case _0x2e42ca(0x177):case'failed':case _0x2e42ca(0x16a):_0x1264fc=_0x2e42ca(0x17e);break;case _0x2e42ca(0x17d):case _0x2e42ca(0x152):_0x1264fc='EXPIRED';break;case _0x2e42ca(0x133):case _0x2e42ca(0x148):case _0x2e42ca(0x13a):case _0x2e42ca(0x16f):default:_0x1264fc=_0x2e42ca(0x187);break;}return{'paymentId':_0x67928d[_0x2e42ca(0x14c)]||_0x67928d['merchant_reference_id']||'','status':_0x1264fc,'amount':_0x67928d[_0x2e42ca(0x154)],'currency':_0x67928d[_0x2e42ca(0x1a7)]||_0x2e42ca(0x160)};}}exports[a40_0x2f6868(0x16d)]=CoinToPay2Service;