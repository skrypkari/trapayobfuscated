'use strict';const a40_0x36417a=a40_0x24cb;(function(_0x336bdf,_0x29eddc){const _0x5673b4=a40_0x24cb,_0xe201b6=_0x336bdf();while(!![]){try{const _0x482f9f=-parseInt(_0x5673b4(0x1a5))/0x1+-parseInt(_0x5673b4(0x1c8))/0x2*(-parseInt(_0x5673b4(0x180))/0x3)+-parseInt(_0x5673b4(0x187))/0x4*(parseInt(_0x5673b4(0x1dc))/0x5)+-parseInt(_0x5673b4(0x197))/0x6+-parseInt(_0x5673b4(0x1b7))/0x7+parseInt(_0x5673b4(0x1cc))/0x8*(-parseInt(_0x5673b4(0x1ef))/0x9)+-parseInt(_0x5673b4(0x1df))/0xa*(-parseInt(_0x5673b4(0x1c6))/0xb);if(_0x482f9f===_0x29eddc)break;else _0xe201b6['push'](_0xe201b6['shift']());}catch(_0x383218){_0xe201b6['push'](_0xe201b6['shift']());}}}(a40_0x42e8,0xe0aec));function a40_0x42e8(){const _0xf71fc4=['awaiting\x20fiat','CoinToPay2\x20payment\x20status\x20check\x20error:','Request\x20Body:','error','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','defineProperty','Error\x20Message:','parse','CreatedOn','amount','expired','loggerService','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','HTTP\x20','Gateway\x20Payment\x20ID:','Error\x20stack:','PENDING','pending','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','stringify','241023TrXOkz','Status:','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','status_code','headers','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','298212bFopqC','order_id',',\x20body:\x20','Payment\x20Status:','statusText','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','ExpiryTime','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','checkPaymentStatus','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','TransactionConfirmedOn','Currency:','Status','TransactionID','PaymentDetail','text','7113630ficHMM','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','https://traffer.uk/gateway/cointopay/','merchant_reference_id','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','logWhiteDomainRequest','FAILED','../loggerService','Status\x20Code:','Amount','EUR','stack','Unknown\x20error\x20from\x20CoinToPay2\x20API','940222JiTXFl','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','Error\x20details:','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','cointopay2','QRCodeURL','createPaymentLink','Transaction\x20ID:','log','===\x20COINTOPAY2\x20SUCCESS\x20===','Amount:','Response\x20data:','not\x20found','data','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','logWhiteDomainResponse','payment_url','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','3199637MFZJuv','gateway_payment_id','now','Created\x20On:','Response\x20Body:','/create','URL:','result','logWhiteDomainError','paid','POST','EXPIRED','__esModule','timeout','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','46670107DpshFw','Raw\x20Response\x20Body:','12IjiVWq','IBAN:','toLowerCase','source','8120JqNMQX','waiting','üìä\x20Status\x20check\x20URL:','created','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','apiUrl','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','verifyPayment','Status\x20Text:','PAID','\x20EUR','Incomplete\x20response:\x20missing\x20data','Payment\x20URL:','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','inputCurrency','/status','50IHAtif','JSON\x20Parse\x20Error:\x20','coinAddress','10PWPkpD','success','status','Result:','currency','statusUrl','HTTP\x20Status:','cancelled','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','Status\x20API\x20Error:\x20','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Response\x20Time:','CoinToPay2Service','message','application/json','Failed\x20to\x20parse\x20JSON\x20response:','4221RsxsCo','match','Headers:','Parsed\x20Result:','failed'];a40_0x42e8=function(){return _0xf71fc4;};return a40_0x42e8();}Object[a40_0x36417a(0x1f9)](exports,a40_0x36417a(0x1c3),{'value':!![]}),exports[a40_0x36417a(0x1eb)]=void 0x0;function a40_0x24cb(_0x47b3d3,_0x623162){const _0x42e823=a40_0x42e8();return a40_0x24cb=function(_0x24cb90,_0x47fd79){_0x24cb90=_0x24cb90-0x17f;let _0x3ef80f=_0x42e823[_0x24cb90];return _0x3ef80f;},a40_0x24cb(_0x47b3d3,_0x623162);}const loggerService_1=require(a40_0x36417a(0x19f));class CoinToPay2Service{constructor(){const _0xc7732e=a40_0x36417a;this[_0xc7732e(0x1d1)]=_0xc7732e(0x19a),this['statusUrl']='https://traffer.uk/gateway/cointopay/status.php',console['log'](_0xc7732e(0x198)),console[_0xc7732e(0x1ad)](_0xc7732e(0x1ce),this[_0xc7732e(0x1e4)]);}async[a40_0x36417a(0x1ab)](_0x2b883f){const _0x431345=a40_0x36417a,{orderId:_0x3259f8,amount:_0x5dd534}=_0x2b883f;console['log'](_0x431345(0x1a8)+_0x5dd534+_0x431345(0x1d6));const _0x275f1a={'amount':_0x5dd534},_0x2a8959=Date['now']();try{console[_0x431345(0x1ad)]('===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20==='),console['log'](_0x431345(0x1bd),this['apiUrl']),console[_0x431345(0x1ad)](_0x431345(0x1f6),JSON[_0x431345(0x17f)](_0x275f1a,null,0x2)),console[_0x431345(0x1ad)](_0x431345(0x1af),_0x5dd534,_0x431345(0x1a6)),loggerService_1['loggerService'][_0x431345(0x19d)](_0x431345(0x1a9),_0x431345(0x1bc),'POST',_0x275f1a);const _0x793077=await fetch(this['apiUrl'],{'method':_0x431345(0x1c1),'headers':{'Content-Type':_0x431345(0x1ed),'Accept':_0x431345(0x1ed),'User-Agent':_0x431345(0x1f8)},'body':JSON[_0x431345(0x17f)](_0x275f1a)}),_0x5f41df=Date[_0x431345(0x1b9)]()-_0x2a8959;console[_0x431345(0x1ad)]('===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20==='),console['log']('Status:',_0x793077[_0x431345(0x1e1)]),console[_0x431345(0x1ad)](_0x431345(0x1d4),_0x793077[_0x431345(0x18b)]),console['log'](_0x431345(0x1f1),Object['fromEntries'](_0x793077[_0x431345(0x184)]['entries']())),console[_0x431345(0x1ad)](_0x431345(0x1ea),_0x5f41df+'ms');const _0x1d0801=await _0x793077[_0x431345(0x196)]();console[_0x431345(0x1ad)](_0x431345(0x1c7),_0x1d0801);if(!_0x793077['ok']){console[_0x431345(0x1f7)]('===\x20COINTOPAY2\x20API\x20ERROR\x20==='),console[_0x431345(0x1f7)](_0x431345(0x1e5),_0x793077[_0x431345(0x1e1)]),console['error'](_0x431345(0x1bb),_0x1d0801),loggerService_1[_0x431345(0x1ff)][_0x431345(0x1b4)]('cointopay2',_0x431345(0x1bc),_0x793077['status'],_0x1d0801,_0x5f41df),loggerService_1[_0x431345(0x1ff)][_0x431345(0x1bf)]('cointopay2','/create',_0x431345(0x201)+_0x793077[_0x431345(0x1e1)]+':\x20'+_0x1d0801);throw new Error('HTTP\x20error!\x20status:\x20'+_0x793077[_0x431345(0x1e1)]+_0x431345(0x189)+_0x1d0801);}let _0x460789;try{_0x460789=JSON[_0x431345(0x1fb)](_0x1d0801);}catch(_0x573f01){console[_0x431345(0x1f7)](_0x431345(0x1ee),_0x573f01),loggerService_1[_0x431345(0x1ff)][_0x431345(0x1bf)](_0x431345(0x1a9),_0x431345(0x1bc),_0x431345(0x1dd)+_0x573f01);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20'+_0x1d0801);}console[_0x431345(0x1ad)](_0x431345(0x1e9)),console['log'](_0x431345(0x1f2),JSON[_0x431345(0x17f)](_0x460789,null,0x2)),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x431345(0x1a9),_0x431345(0x1bc),_0x793077[_0x431345(0x1e1)],_0x460789,_0x5f41df);if(_0x460789[_0x431345(0x1f7)]){const _0x174b29=_0x460789[_0x431345(0x1ec)]||_0x460789['error']||_0x431345(0x1a4);console[_0x431345(0x1f7)](_0x431345(0x1b6)),console[_0x431345(0x1f7)](_0x431345(0x1fa),_0x174b29),loggerService_1[_0x431345(0x1ff)][_0x431345(0x1bf)](_0x431345(0x1a9),_0x431345(0x1bc),'Business\x20Error:\x20'+_0x174b29);throw new Error('CoinToPay2\x20API\x20error:\x20'+_0x174b29);}if(!_0x460789[_0x431345(0x1b5)]||!_0x460789[_0x431345(0x1b8)]){console[_0x431345(0x1f7)](_0x431345(0x1b3)),console[_0x431345(0x1f7)](_0x431345(0x1c5)),console[_0x431345(0x1f7)](_0x431345(0x1b0),_0x460789),loggerService_1[_0x431345(0x1ff)][_0x431345(0x1bf)]('cointopay2','/create',_0x431345(0x186));throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id');}return console[_0x431345(0x1ad)](_0x431345(0x1ae)),console[_0x431345(0x1ad)](_0x431345(0x202),_0x460789[_0x431345(0x1b8)]),console[_0x431345(0x1ad)](_0x431345(0x1d8),_0x460789[_0x431345(0x1b5)]),console[_0x431345(0x1ad)](_0x431345(0x1af),_0x5dd534,_0x431345(0x1a2)),{'gateway_payment_id':_0x460789[_0x431345(0x1b8)],'payment_url':_0x460789[_0x431345(0x1b5)]};}catch(_0x5ce120){console[_0x431345(0x1f7)]('===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20==='),console[_0x431345(0x1f7)](_0x431345(0x1a7),_0x5ce120),loggerService_1[_0x431345(0x1ff)][_0x431345(0x1bf)](_0x431345(0x1a9),'/create',_0x5ce120);if(_0x5ce120 instanceof Error){console[_0x431345(0x1f7)]('Error\x20message:',_0x5ce120[_0x431345(0x1ec)]),console['error'](_0x431345(0x203),_0x5ce120[_0x431345(0x1a3)]);throw new Error(_0x431345(0x1e7)+_0x5ce120[_0x431345(0x1ec)]);}throw new Error(_0x431345(0x190));}}async['checkPaymentStatus'](_0x262627){const _0x3abd47=a40_0x36417a,_0x2cd0c2=Date['now']();try{console[_0x3abd47(0x1ad)](_0x3abd47(0x182)+_0x262627);const _0x564ac1={'gatewayPaymentId':_0x262627};loggerService_1[_0x3abd47(0x1ff)][_0x3abd47(0x19d)](_0x3abd47(0x1a9),'/status',_0x3abd47(0x1c1),_0x564ac1);const _0x357a3d=await fetch(this[_0x3abd47(0x1e4)],{'method':_0x3abd47(0x1c1),'headers':{'Content-Type':'application/json','Accept':_0x3abd47(0x1ed),'User-Agent':_0x3abd47(0x1f8)},'body':JSON[_0x3abd47(0x17f)](_0x564ac1)}),_0x58023a=Date[_0x3abd47(0x1b9)]()-_0x2cd0c2;console[_0x3abd47(0x1ad)]('===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20==='),console[_0x3abd47(0x1ad)](_0x3abd47(0x181),_0x357a3d['status']),console[_0x3abd47(0x1ad)](_0x3abd47(0x1ea),_0x58023a+'ms');if(!_0x357a3d['ok']){const _0x9d14b3=await _0x357a3d[_0x3abd47(0x196)]();console['error']('HTTP\x20Status:',_0x357a3d[_0x3abd47(0x1e1)]),console[_0x3abd47(0x1f7)](_0x3abd47(0x1bb),_0x9d14b3),loggerService_1[_0x3abd47(0x1ff)][_0x3abd47(0x1b4)]('cointopay2',_0x3abd47(0x1db),_0x357a3d['status'],_0x9d14b3,_0x58023a),loggerService_1[_0x3abd47(0x1ff)]['logWhiteDomainError'](_0x3abd47(0x1a9),_0x3abd47(0x1db),_0x3abd47(0x201)+_0x357a3d[_0x3abd47(0x1e1)]+':\x20'+_0x9d14b3);throw new Error('HTTP\x20error!\x20status:\x20'+_0x357a3d['status']);}const _0x9b4cf8=await _0x357a3d[_0x3abd47(0x196)]();console['log'](_0x3abd47(0x1c7),_0x9b4cf8);let _0x26f4e6;try{_0x26f4e6=JSON['parse'](_0x9b4cf8);}catch(_0x3ad9d2){console[_0x3abd47(0x1f7)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x3ad9d2),loggerService_1[_0x3abd47(0x1ff)]['logWhiteDomainError'](_0x3abd47(0x1a9),_0x3abd47(0x1db),_0x3abd47(0x1dd)+_0x3ad9d2);throw new Error(_0x3abd47(0x18c)+_0x9b4cf8);}loggerService_1[_0x3abd47(0x1ff)][_0x3abd47(0x1b4)](_0x3abd47(0x1a9),_0x3abd47(0x1db),_0x357a3d[_0x3abd47(0x1e1)],_0x26f4e6,_0x58023a),console['log'](_0x3abd47(0x1d0)),console[_0x3abd47(0x1ad)](_0x3abd47(0x1e2),_0x26f4e6[_0x3abd47(0x1be)]),console[_0x3abd47(0x1ad)](_0x3abd47(0x1a0),_0x26f4e6['status_code']),console['log'](_0x3abd47(0x18a),_0x26f4e6['data']?.[_0x3abd47(0x193)]),console[_0x3abd47(0x1ad)](_0x3abd47(0x1af),_0x26f4e6[_0x3abd47(0x1b2)]?.[_0x3abd47(0x1a1)]),console[_0x3abd47(0x1ad)](_0x3abd47(0x192),_0x26f4e6['data']?.[_0x3abd47(0x1da)]);if(_0x26f4e6['result']!==_0x3abd47(0x1e0)||_0x26f4e6[_0x3abd47(0x183)]!==0xc8){const _0x40a964=_0x26f4e6['message']||_0x3abd47(0x1d2);console[_0x3abd47(0x1f7)](_0x3abd47(0x19c)),console[_0x3abd47(0x1f7)]('Error\x20Message:',_0x40a964),loggerService_1[_0x3abd47(0x1ff)]['logWhiteDomainError']('cointopay2','/status',_0x3abd47(0x1e8)+_0x40a964);throw new Error('CoinToPay2\x20status\x20API\x20error:\x20'+_0x40a964);}if(!_0x26f4e6['data']){console[_0x3abd47(0x1f7)](_0x3abd47(0x199)),console[_0x3abd47(0x1f7)]('Missing\x20data\x20in\x20response'),loggerService_1[_0x3abd47(0x1ff)][_0x3abd47(0x1bf)]('cointopay2','/status',_0x3abd47(0x1d7));throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data');}let _0x20fdf6=_0x3abd47(0x204);switch(_0x26f4e6[_0x3abd47(0x1b2)][_0x3abd47(0x193)]?.[_0x3abd47(0x1ca)]()){case _0x3abd47(0x1c0):_0x20fdf6='PAID';break;case _0x3abd47(0x1e6):case _0x3abd47(0x1f3):case'error':_0x20fdf6=_0x3abd47(0x19e);break;case _0x3abd47(0x1fe):case _0x3abd47(0x1c4):_0x20fdf6=_0x3abd47(0x1c2);break;case _0x3abd47(0x1cd):case _0x3abd47(0x1f4):case _0x3abd47(0x205):case'created':default:_0x20fdf6=_0x3abd47(0x204);break;}let _0xa3f425,_0x4ae243;if(_0x26f4e6[_0x3abd47(0x1b2)][_0x3abd47(0x195)]){const _0x51285c=_0x26f4e6[_0x3abd47(0x1b2)]['PaymentDetail'];console['log']('üè¶\x20Payment\x20Detail:',_0x51285c);const _0xb2e9e9=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x432e93 of _0xb2e9e9){const _0x5b7ba4=_0x51285c[_0x3abd47(0x1f0)](_0x432e93);if(_0x5b7ba4){_0xa3f425=_0x5b7ba4[0x1],console[_0x3abd47(0x1ad)]('üè¶\x20Extracted\x20IBAN:',_0xa3f425,'using\x20pattern:',_0x432e93[_0x3abd47(0x1cb)]);break;}}if(!_0xa3f425){console[_0x3abd47(0x1ad)](_0x3abd47(0x200));const _0xfe9b25=_0x51285c[_0x3abd47(0x1f0)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0xfe9b25&&(_0xa3f425=_0xfe9b25[0x1],console[_0x3abd47(0x1ad)](_0x3abd47(0x18e),_0xa3f425));}_0x4ae243=_0x51285c;}const _0x48cd63={'iban':_0xa3f425,'bankDetails':_0x4ae243,'transactionId':_0x26f4e6[_0x3abd47(0x1b2)][_0x3abd47(0x194)],'coinAddress':_0x26f4e6['data'][_0x3abd47(0x1de)],'qrCodeUrl':_0x26f4e6[_0x3abd47(0x1b2)][_0x3abd47(0x1aa)],'expiryTime':_0x26f4e6[_0x3abd47(0x1b2)][_0x3abd47(0x18d)],'createdOn':_0x26f4e6['data'][_0x3abd47(0x1fc)],'confirmedOn':_0x26f4e6[_0x3abd47(0x1b2)][_0x3abd47(0x191)]};console[_0x3abd47(0x1ad)]('===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20==='),console[_0x3abd47(0x1ad)](_0x3abd47(0x181),_0x26f4e6['data']['Status'],'->',_0x20fdf6),console[_0x3abd47(0x1ad)](_0x3abd47(0x1af),_0x26f4e6[_0x3abd47(0x1b2)]['Amount'],_0x26f4e6[_0x3abd47(0x1b2)]['inputCurrency']),console[_0x3abd47(0x1ad)](_0x3abd47(0x1ac),_0x26f4e6[_0x3abd47(0x1b2)][_0x3abd47(0x194)]),console['log'](_0x3abd47(0x1c9),_0xa3f425||_0x3abd47(0x1b1)),console[_0x3abd47(0x1ad)](_0x3abd47(0x1ba),_0x26f4e6[_0x3abd47(0x1b2)][_0x3abd47(0x1fc)]),console[_0x3abd47(0x1ad)]('Confirmed\x20On:',_0x26f4e6[_0x3abd47(0x1b2)][_0x3abd47(0x191)]||'not\x20confirmed');if(_0x26f4e6[_0x3abd47(0x1b2)]['Status']?.[_0x3abd47(0x1ca)]()===_0x3abd47(0x1f4))console[_0x3abd47(0x1ad)](_0x3abd47(0x185));else _0x26f4e6['data']['Status']?.['toLowerCase']()===_0x3abd47(0x1c0)&&console[_0x3abd47(0x1ad)]('‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID');return{'status':_0x20fdf6,'amount':parseFloat(_0x26f4e6[_0x3abd47(0x1b2)]['Amount'])||undefined,'currency':_0x26f4e6[_0x3abd47(0x1b2)][_0x3abd47(0x1da)]||_0x3abd47(0x1a2),'paymentDetails':_0x48cd63};}catch(_0x3f1048){console[_0x3abd47(0x1f7)](_0x3abd47(0x1f5),_0x3f1048),loggerService_1[_0x3abd47(0x1ff)]['logWhiteDomainError']('cointopay2','/status',_0x3f1048);throw new Error(_0x3abd47(0x1d9)+(_0x3f1048 instanceof Error?_0x3f1048[_0x3abd47(0x1ec)]:'Unknown\x20error'));}}async[a40_0x36417a(0x1d3)](_0x166177){const _0x320c2a=a40_0x36417a,_0x11fbbe=await this[_0x320c2a(0x18f)](_0x166177);return{'status':_0x11fbbe['status'],'amount':_0x11fbbe['amount'],'currency':_0x11fbbe[_0x320c2a(0x1e3)]};}async['processWebhook'](_0x36664e){const _0x4fbe20=a40_0x36417a;console[_0x4fbe20(0x1ad)](_0x4fbe20(0x206),_0x36664e);let _0x579c3d=_0x4fbe20(0x204);switch(_0x36664e['status']?.['toLowerCase']()){case _0x4fbe20(0x1c0):_0x579c3d=_0x4fbe20(0x1d5);break;case _0x4fbe20(0x1e6):case _0x4fbe20(0x1f3):case _0x4fbe20(0x1f7):_0x579c3d=_0x4fbe20(0x19e);break;case _0x4fbe20(0x1fe):case'timeout':_0x579c3d=_0x4fbe20(0x1c2);break;case'pending':case _0x4fbe20(0x1cd):case _0x4fbe20(0x1f4):case _0x4fbe20(0x1cf):default:_0x579c3d='PENDING';break;}return{'paymentId':_0x36664e[_0x4fbe20(0x188)]||_0x36664e[_0x4fbe20(0x19b)]||'','status':_0x579c3d,'amount':_0x36664e[_0x4fbe20(0x1fd)],'currency':_0x36664e['currency']||_0x4fbe20(0x1a2)};}}exports[a40_0x36417a(0x1eb)]=CoinToPay2Service;