'use strict';const a43_0x12f540=a43_0x8a19;(function(_0xda54f2,_0x548662){const _0xc0ef66=a43_0x8a19,_0x49243b=_0xda54f2();while(!![]){try{const _0x384e06=-parseInt(_0xc0ef66(0xe6))/0x1*(parseInt(_0xc0ef66(0x109))/0x2)+-parseInt(_0xc0ef66(0x13d))/0x3*(-parseInt(_0xc0ef66(0x16c))/0x4)+parseInt(_0xc0ef66(0xf6))/0x5*(parseInt(_0xc0ef66(0x158))/0x6)+parseInt(_0xc0ef66(0x110))/0x7+parseInt(_0xc0ef66(0xe7))/0x8*(parseInt(_0xc0ef66(0x116))/0x9)+-parseInt(_0xc0ef66(0x153))/0xa+parseInt(_0xc0ef66(0x155))/0xb*(parseInt(_0xc0ef66(0x170))/0xc);if(_0x384e06===_0x548662)break;else _0x49243b['push'](_0x49243b['shift']());}catch(_0x3b37af){_0x49243b['push'](_0x49243b['shift']());}}}(a43_0x2a1d,0xbd4e3));function a43_0x2a1d(){const _0x2660c8=['Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','Error\x20details:','failed','text','Created\x20On:','CoinToPay2\x20payment\x20status\x20check\x20error:','not\x20found','parse','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','toLowerCase','9sLXnJp','ExpiryTime','pending','HTTP\x20','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','Parsed\x20Result:','Status:','success','source','logWhiteDomainError','JSON\x20Parse\x20Error:\x20','Failed\x20to\x20parse\x20JSON\x20response:','CreatedOn','log','Request\x20Body:','now','application/json','Incomplete\x20response:\x20missing\x20data','IBAN:','Missing\x20data\x20in\x20response','logWhiteDomainRequest','amount','9700190ctqpyL','defineProperty','4384479oBOOib','PAID','Confirmed\x20On:','37416DjjxUg','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','message','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','PENDING','Response\x20Time:','gateway_payment_id','merchant_reference_id','Response\x20Body:','Status','statusText','Unknown\x20error','statusUrl','waiting','HTTP\x20error!\x20status:\x20','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','EUR','394188mMzBMH','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','expired','Amount:','36WLqsNz','created','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','1OiOsWx','1271104rDargq','entries','\x20EUR','POST','üè¶\x20Payment\x20Detail:','headers','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','fromEntries','order_id','coinAddress','Status\x20Code:','FAILED','checkPaymentStatus','QRCodeURL','stack','315BwpACv','match','using\x20pattern:','error','paid','Headers:','Result:','/status','payment_url','Gateway\x20Payment\x20ID:','üè¶\x20Extracted\x20IBAN:','CoinToPay2Service','cointopay2','Amount','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Transaction\x20ID:','data','logWhiteDomainResponse','createPaymentLink','2694152FUVHpn','Unknown\x20error\x20from\x20CoinToPay2\x20API','PaymentDetail','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','Currency:','Raw\x20Response\x20Body:','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','1784202NPWHwl','__esModule','apiUrl','awaiting\x20fiat','currency','loggerService','54wdKGFt','CoinToPay2\x20status\x20API\x20error:\x20','Payment\x20Status:','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','verifyPayment','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','cancelled','/create',',\x20body:\x20','TransactionConfirmedOn','status_code','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','stringify','inputCurrency','status','URL:','===\x20COINTOPAY2\x20API\x20ERROR\x20===','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','https://traffer.uk/gateway/cointopay/','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','timeout','Error\x20Message:','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','result','HTTP\x20Status:','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:'];a43_0x2a1d=function(){return _0x2660c8;};return a43_0x2a1d();}Object[a43_0x12f540(0x154)](exports,a43_0x12f540(0x111),{'value':!![]}),exports[a43_0x12f540(0x101)]=void 0x0;function a43_0x8a19(_0x19d8ff,_0x2f3ee5){const _0x2a1d23=a43_0x2a1d();return a43_0x8a19=function(_0x8a192b,_0xf082ec){_0x8a192b=_0x8a192b-0xe6;let _0x1a2f75=_0x2a1d23[_0x8a192b];return _0x1a2f75;},a43_0x8a19(_0x19d8ff,_0x2f3ee5);}const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x324702=a43_0x12f540;this[_0x324702(0x112)]=_0x324702(0x128),this['statusUrl']='https://traffer.uk/gateway/cointopay/status.php',console[_0x324702(0x14a)](_0x324702(0x121)),console[_0x324702(0x14a)]('üìä\x20Status\x20check\x20URL:',this[_0x324702(0x165)]);}async[a43_0x12f540(0x108)](_0x429c67){const _0x4f8c8f=a43_0x12f540,{orderId:_0x311441,amount:_0x5355d7}=_0x429c67;console['log']('ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20'+_0x5355d7+_0x4f8c8f(0xe9));const _0xd6643c={'amount':_0x5355d7},_0x216ed1=Date[_0x4f8c8f(0x14c)]();try{console[_0x4f8c8f(0x14a)](_0x4f8c8f(0x172)),console[_0x4f8c8f(0x14a)](_0x4f8c8f(0x125),this[_0x4f8c8f(0x112)]),console[_0x4f8c8f(0x14a)](_0x4f8c8f(0x14b),JSON['stringify'](_0xd6643c,null,0x2)),console['log'](_0x4f8c8f(0x16f),_0x5355d7,_0x4f8c8f(0x141)),loggerService_1[_0x4f8c8f(0x115)][_0x4f8c8f(0x151)](_0x4f8c8f(0x102),_0x4f8c8f(0x11d),'POST',_0xd6643c);const _0x14f157=await fetch(this['apiUrl'],{'method':_0x4f8c8f(0xea),'headers':{'Content-Type':_0x4f8c8f(0x14d),'Accept':'application/json','User-Agent':_0x4f8c8f(0x168)},'body':JSON['stringify'](_0xd6643c)}),_0x5b429f=Date['now']()-_0x216ed1;console['log']('===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20==='),console[_0x4f8c8f(0x14a)](_0x4f8c8f(0x143),_0x14f157[_0x4f8c8f(0x124)]),console[_0x4f8c8f(0x14a)]('Status\x20Text:',_0x14f157[_0x4f8c8f(0x163)]),console[_0x4f8c8f(0x14a)](_0x4f8c8f(0xfb),Object[_0x4f8c8f(0xee)](_0x14f157[_0x4f8c8f(0xec)][_0x4f8c8f(0xe8)]())),console[_0x4f8c8f(0x14a)](_0x4f8c8f(0x15e),_0x5b429f+'ms');const _0x2f4783=await _0x14f157[_0x4f8c8f(0x134)]();console[_0x4f8c8f(0x14a)]('Raw\x20Response\x20Body:',_0x2f4783);if(!_0x14f157['ok']){console[_0x4f8c8f(0xf9)](_0x4f8c8f(0x126)),console[_0x4f8c8f(0xf9)](_0x4f8c8f(0x12f),_0x14f157['status']),console[_0x4f8c8f(0xf9)](_0x4f8c8f(0x161),_0x2f4783),loggerService_1[_0x4f8c8f(0x115)]['logWhiteDomainResponse'](_0x4f8c8f(0x102),_0x4f8c8f(0x11d),_0x14f157['status'],_0x2f4783,_0x5b429f),loggerService_1['loggerService'][_0x4f8c8f(0x146)]('cointopay2',_0x4f8c8f(0x11d),_0x4f8c8f(0x140)+_0x14f157[_0x4f8c8f(0x124)]+':\x20'+_0x2f4783);throw new Error(_0x4f8c8f(0x167)+_0x14f157[_0x4f8c8f(0x124)]+_0x4f8c8f(0x11e)+_0x2f4783);}let _0x7911ca;try{_0x7911ca=JSON[_0x4f8c8f(0x138)](_0x2f4783);}catch(_0x468ccb){console[_0x4f8c8f(0xf9)](_0x4f8c8f(0x148),_0x468ccb),loggerService_1[_0x4f8c8f(0x115)][_0x4f8c8f(0x146)](_0x4f8c8f(0x102),_0x4f8c8f(0x11d),_0x4f8c8f(0x147)+_0x468ccb);throw new Error(_0x4f8c8f(0x10f)+_0x2f4783);}console['log'](_0x4f8c8f(0x104)),console[_0x4f8c8f(0x14a)](_0x4f8c8f(0x142),JSON[_0x4f8c8f(0x122)](_0x7911ca,null,0x2)),loggerService_1[_0x4f8c8f(0x115)][_0x4f8c8f(0x107)](_0x4f8c8f(0x102),_0x4f8c8f(0x11d),_0x14f157[_0x4f8c8f(0x124)],_0x7911ca,_0x5b429f);if(_0x7911ca['error']){const _0x27e8b3=_0x7911ca[_0x4f8c8f(0x15a)]||_0x7911ca['error']||_0x4f8c8f(0x10a);console[_0x4f8c8f(0xf9)](_0x4f8c8f(0x127)),console[_0x4f8c8f(0xf9)](_0x4f8c8f(0x12b),_0x27e8b3),loggerService_1[_0x4f8c8f(0x115)][_0x4f8c8f(0x146)](_0x4f8c8f(0x102),_0x4f8c8f(0x11d),'Business\x20Error:\x20'+_0x27e8b3);throw new Error('CoinToPay2\x20API\x20error:\x20'+_0x27e8b3);}if(!_0x7911ca['payment_url']||!_0x7911ca[_0x4f8c8f(0x15f)]){console[_0x4f8c8f(0xf9)](_0x4f8c8f(0x12c)),console[_0x4f8c8f(0xf9)](_0x4f8c8f(0x15c)),console[_0x4f8c8f(0xf9)]('Response\x20data:',_0x7911ca),loggerService_1[_0x4f8c8f(0x115)]['logWhiteDomainError']('cointopay2','/create',_0x4f8c8f(0x10c));throw new Error(_0x4f8c8f(0xed));}return console[_0x4f8c8f(0x14a)]('===\x20COINTOPAY2\x20SUCCESS\x20==='),console['log'](_0x4f8c8f(0xff),_0x7911ca[_0x4f8c8f(0x15f)]),console[_0x4f8c8f(0x14a)]('Payment\x20URL:',_0x7911ca[_0x4f8c8f(0xfe)]),console['log'](_0x4f8c8f(0x16f),_0x5355d7,_0x4f8c8f(0x16b)),{'gateway_payment_id':_0x7911ca['gateway_payment_id'],'payment_url':_0x7911ca[_0x4f8c8f(0xfe)]};}catch(_0x4b0545){console['error']('===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20==='),console[_0x4f8c8f(0xf9)](_0x4f8c8f(0x132),_0x4b0545),loggerService_1[_0x4f8c8f(0x115)][_0x4f8c8f(0x146)](_0x4f8c8f(0x102),_0x4f8c8f(0x11d),_0x4b0545);if(_0x4b0545 instanceof Error){console[_0x4f8c8f(0xf9)]('Error\x20message:',_0x4b0545[_0x4f8c8f(0x15a)]),console['error']('Error\x20stack:',_0x4b0545[_0x4f8c8f(0xf5)]);throw new Error(_0x4f8c8f(0x169)+_0x4b0545['message']);}throw new Error(_0x4f8c8f(0x15b));}}async[a43_0x12f540(0xf3)](_0x23723b){const _0x304b55=a43_0x12f540,_0x233f3c=Date['now']();try{console['log']('üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20'+_0x23723b);const _0x22da53={'gatewayPaymentId':_0x23723b};loggerService_1['loggerService'][_0x304b55(0x151)](_0x304b55(0x102),'/status',_0x304b55(0xea),_0x22da53);const _0x27f86a=await fetch(this[_0x304b55(0x165)],{'method':_0x304b55(0xea),'headers':{'Content-Type':_0x304b55(0x14d),'Accept':_0x304b55(0x14d),'User-Agent':_0x304b55(0x168)},'body':JSON[_0x304b55(0x122)](_0x22da53)}),_0x2d1d7f=Date[_0x304b55(0x14c)]()-_0x233f3c;console[_0x304b55(0x14a)](_0x304b55(0x119)),console[_0x304b55(0x14a)]('Status:',_0x27f86a[_0x304b55(0x124)]),console[_0x304b55(0x14a)]('Response\x20Time:',_0x2d1d7f+'ms');if(!_0x27f86a['ok']){const _0x459095=await _0x27f86a[_0x304b55(0x134)]();console[_0x304b55(0xf9)](_0x304b55(0x12f),_0x27f86a[_0x304b55(0x124)]),console[_0x304b55(0xf9)](_0x304b55(0x161),_0x459095),loggerService_1[_0x304b55(0x115)][_0x304b55(0x107)](_0x304b55(0x102),_0x304b55(0xfd),_0x27f86a[_0x304b55(0x124)],_0x459095,_0x2d1d7f),loggerService_1[_0x304b55(0x115)][_0x304b55(0x146)](_0x304b55(0x102),'/status',_0x304b55(0x140)+_0x27f86a['status']+':\x20'+_0x459095);throw new Error(_0x304b55(0x167)+_0x27f86a[_0x304b55(0x124)]);}const _0x25eae5=await _0x27f86a[_0x304b55(0x134)]();console[_0x304b55(0x14a)](_0x304b55(0x10e),_0x25eae5);let _0x52dd2d;try{_0x52dd2d=JSON['parse'](_0x25eae5);}catch(_0x2e0925){console[_0x304b55(0xf9)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x2e0925),loggerService_1['loggerService'][_0x304b55(0x146)](_0x304b55(0x102),_0x304b55(0xfd),_0x304b55(0x147)+_0x2e0925);throw new Error(_0x304b55(0x139)+_0x25eae5);}loggerService_1[_0x304b55(0x115)]['logWhiteDomainResponse'](_0x304b55(0x102),_0x304b55(0xfd),_0x27f86a[_0x304b55(0x124)],_0x52dd2d,_0x2d1d7f),console[_0x304b55(0x14a)](_0x304b55(0x11b)),console[_0x304b55(0x14a)](_0x304b55(0xfc),_0x52dd2d['result']),console[_0x304b55(0x14a)](_0x304b55(0xf1),_0x52dd2d[_0x304b55(0x120)]),console['log'](_0x304b55(0x118),_0x52dd2d[_0x304b55(0x106)]?.[_0x304b55(0x162)]),console['log'](_0x304b55(0x16f),_0x52dd2d['data']?.[_0x304b55(0x103)]),console[_0x304b55(0x14a)](_0x304b55(0x10d),_0x52dd2d[_0x304b55(0x106)]?.[_0x304b55(0x123)]);if(_0x52dd2d[_0x304b55(0x12e)]!==_0x304b55(0x144)||_0x52dd2d[_0x304b55(0x120)]!==0xc8){const _0x107303=_0x52dd2d['message']||_0x304b55(0x13b);console[_0x304b55(0xf9)]('===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20==='),console[_0x304b55(0xf9)](_0x304b55(0x12b),_0x107303),loggerService_1[_0x304b55(0x115)][_0x304b55(0x146)](_0x304b55(0x102),_0x304b55(0xfd),'Status\x20API\x20Error:\x20'+_0x107303);throw new Error(_0x304b55(0x117)+_0x107303);}if(!_0x52dd2d['data']){console['error']('===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x304b55(0xf9)](_0x304b55(0x150)),loggerService_1['loggerService']['logWhiteDomainError']('cointopay2',_0x304b55(0xfd),_0x304b55(0x14e));throw new Error(_0x304b55(0x131));}let _0x14abbe=_0x304b55(0x15d);switch(_0x52dd2d[_0x304b55(0x106)][_0x304b55(0x162)]?.['toLowerCase']()){case _0x304b55(0xfa):_0x14abbe=_0x304b55(0x156);break;case _0x304b55(0x11c):case'failed':case'error':_0x14abbe='FAILED';break;case _0x304b55(0x16e):case _0x304b55(0x12a):_0x14abbe='EXPIRED';break;case _0x304b55(0x166):case'awaiting\x20fiat':case _0x304b55(0x13f):case _0x304b55(0x171):default:_0x14abbe=_0x304b55(0x15d);break;}let _0x24f8f3,_0x14b7d7;if(_0x52dd2d[_0x304b55(0x106)][_0x304b55(0x10b)]){const _0x94771=_0x52dd2d[_0x304b55(0x106)][_0x304b55(0x10b)];console[_0x304b55(0x14a)](_0x304b55(0xeb),_0x94771);const _0x46ab99=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x51abd1 of _0x46ab99){const _0x33949c=_0x94771[_0x304b55(0xf7)](_0x51abd1);if(_0x33949c){_0x24f8f3=_0x33949c[0x1],console[_0x304b55(0x14a)](_0x304b55(0x100),_0x24f8f3,_0x304b55(0xf8),_0x51abd1[_0x304b55(0x145)]);break;}}if(!_0x24f8f3){console[_0x304b55(0x14a)](_0x304b55(0x159));const _0x2f145c=_0x94771[_0x304b55(0xf7)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x2f145c&&(_0x24f8f3=_0x2f145c[0x1],console['log'](_0x304b55(0x130),_0x24f8f3));}_0x14b7d7=_0x94771;}const _0x131a96={'iban':_0x24f8f3,'bankDetails':_0x14b7d7,'transactionId':_0x52dd2d[_0x304b55(0x106)]['TransactionID'],'coinAddress':_0x52dd2d['data'][_0x304b55(0xf0)],'qrCodeUrl':_0x52dd2d[_0x304b55(0x106)][_0x304b55(0xf4)],'expiryTime':_0x52dd2d[_0x304b55(0x106)][_0x304b55(0x13e)],'createdOn':_0x52dd2d[_0x304b55(0x106)][_0x304b55(0x149)],'confirmedOn':_0x52dd2d['data'][_0x304b55(0x11f)]};console[_0x304b55(0x14a)](_0x304b55(0x16a)),console[_0x304b55(0x14a)](_0x304b55(0x143),_0x52dd2d[_0x304b55(0x106)][_0x304b55(0x162)],'->',_0x14abbe),console[_0x304b55(0x14a)]('Amount:',_0x52dd2d[_0x304b55(0x106)]['Amount'],_0x52dd2d[_0x304b55(0x106)]['inputCurrency']),console[_0x304b55(0x14a)](_0x304b55(0x105),_0x52dd2d[_0x304b55(0x106)]['TransactionID']),console['log'](_0x304b55(0x14f),_0x24f8f3||_0x304b55(0x137)),console[_0x304b55(0x14a)](_0x304b55(0x135),_0x52dd2d[_0x304b55(0x106)]['CreatedOn']),console[_0x304b55(0x14a)](_0x304b55(0x157),_0x52dd2d[_0x304b55(0x106)][_0x304b55(0x11f)]||'not\x20confirmed');if(_0x52dd2d[_0x304b55(0x106)][_0x304b55(0x162)]?.[_0x304b55(0x13c)]()===_0x304b55(0x113))console['log'](_0x304b55(0x12d));else _0x52dd2d[_0x304b55(0x106)][_0x304b55(0x162)]?.[_0x304b55(0x13c)]()==='paid'&&console[_0x304b55(0x14a)](_0x304b55(0x13a));return{'status':_0x14abbe,'amount':parseFloat(_0x52dd2d['data'][_0x304b55(0x103)])||undefined,'currency':_0x52dd2d[_0x304b55(0x106)][_0x304b55(0x123)]||'EUR','paymentDetails':_0x131a96};}catch(_0x41ffed){console[_0x304b55(0xf9)](_0x304b55(0x136),_0x41ffed),loggerService_1[_0x304b55(0x115)][_0x304b55(0x146)]('cointopay2',_0x304b55(0xfd),_0x41ffed);throw new Error(_0x304b55(0x129)+(_0x41ffed instanceof Error?_0x41ffed[_0x304b55(0x15a)]:_0x304b55(0x164)));}}async[a43_0x12f540(0x11a)](_0x5dfffb){const _0xdce247=a43_0x12f540,_0x92c01a=await this['checkPaymentStatus'](_0x5dfffb);return{'status':_0x92c01a[_0xdce247(0x124)],'amount':_0x92c01a[_0xdce247(0x152)],'currency':_0x92c01a[_0xdce247(0x114)]};}async['processWebhook'](_0x6d8fc1){const _0x31820c=a43_0x12f540;console[_0x31820c(0x14a)](_0x31820c(0x16d),_0x6d8fc1);let _0xe623f1='PENDING';switch(_0x6d8fc1[_0x31820c(0x124)]?.['toLowerCase']()){case _0x31820c(0xfa):_0xe623f1=_0x31820c(0x156);break;case _0x31820c(0x11c):case _0x31820c(0x133):case'error':_0xe623f1=_0x31820c(0xf2);break;case _0x31820c(0x16e):case _0x31820c(0x12a):_0xe623f1='EXPIRED';break;case _0x31820c(0x13f):case _0x31820c(0x166):case _0x31820c(0x113):case _0x31820c(0x171):default:_0xe623f1=_0x31820c(0x15d);break;}return{'paymentId':_0x6d8fc1[_0x31820c(0xef)]||_0x6d8fc1[_0x31820c(0x160)]||'','status':_0xe623f1,'amount':_0x6d8fc1['amount'],'currency':_0x6d8fc1['currency']||_0x31820c(0x16b)};}}exports[a43_0x12f540(0x101)]=CoinToPay2Service;