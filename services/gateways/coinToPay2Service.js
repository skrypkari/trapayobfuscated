'use strict';function a54_0x1bb1(){const _0x56a9ae=['===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','PaymentDetail','2gXMjBE','Response\x20Body:','result','Currency:','Status','logWhiteDomainResponse','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','not\x20confirmed','log','Confirmed\x20On:','Payment\x20URL\x20(modified):','order_id','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','now','Status\x20Text:','HTTP\x20Status:','IBAN:','amount','currency','/create','Unknown\x20error\x20from\x20CoinToPay2\x20API','üìä\x20Status\x20check\x20URL:','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','https://traffer.uk/gateway/cointopay/','CreatedOn','logWhiteDomainRequest','===\x20COINTOPAY2\x20SUCCESS\x20===','944PHHxAl','Payment\x20System/1.0\x20(CoinToPay2)','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','/status','330280tURHbV','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','statusUrl','status','timeout','1393FrEfgw','Response\x20Time:','expired','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','cancelled','PAID','TransactionConfirmedOn','HTTP\x20error!\x20status:\x20','2196WnuZar','EUR','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','FAILED','POST','waiting','Payment\x20URL\x20(original):','1434aKflmr','CoinToPay2\x20API\x20error:\x20','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','merchant_reference_id','URL:','CoinToPay2Service','28666yuEZhZ','CoinToPay2\x20payment\x20status\x20check\x20error:','Error\x20stack:','Error\x20Message:','cointopay2','headers','source','Amount:','checkPaymentStatus','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','===\x20COINTOPAY2\x20API\x20ERROR\x20===','error','coinAddress','Raw\x20Response\x20Body:','300NKljpr','message','Unknown\x20error','QRCodeURL','Amount','Missing\x20data\x20in\x20response','status_code','727680KCOZWw','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','stringify','JSON\x20Parse\x20Error:\x20','created','application/json','Failed\x20to\x20parse\x20JSON\x20response:','pending','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','18131IbDLBd','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','&alternative=false','\x20EUR','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','loggerService','HTTP\x20','TransactionID','entries','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','success','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','paid','verifyPayment','data','Headers:','failed','Transaction\x20ID:','Status\x20Code:','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','gateway_payment_id','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','Business\x20Error:\x20','EXPIRED','Response\x20data:','payment_url','../loggerService','Parsed\x20Result:','849afMydL','stack','match','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Status:','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','PENDING','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','toLowerCase','apiUrl','Request\x20Body:','ExpiryTime','parse','inputCurrency','awaiting\x20fiat','logWhiteDomainError','Gateway\x20Payment\x20ID:','text','752GRwepQ','fromEntries'];a54_0x1bb1=function(){return _0x56a9ae;};return a54_0x1bb1();}function a54_0x372c(_0x412df6,_0xa9dbd8){_0x412df6=_0x412df6-0xd3;const _0x1bb13f=a54_0x1bb1();let _0x372ca4=_0x1bb13f[_0x412df6];return _0x372ca4;}const a54_0x515856=a54_0x372c;(function(_0x255dc0,_0x16a2b2){const _0x2f27e2=a54_0x372c,_0x2e90ba=_0x255dc0();while(!![]){try{const _0x3e4fc4=parseInt(_0x2f27e2(0xfd))/0x1*(-parseInt(_0x2f27e2(0x130))/0x2)+-parseInt(_0x2f27e2(0x11a))/0x3*(-parseInt(_0x2f27e2(0x12c))/0x4)+parseInt(_0x2f27e2(0x150))/0x5+-parseInt(_0x2f27e2(0xd8))/0x6*(-parseInt(_0x2f27e2(0x156))/0x7)+-parseInt(_0x2f27e2(0x14c))/0x8*(parseInt(_0x2f27e2(0x15e))/0x9)+parseInt(_0x2f27e2(0xf3))/0xa+parseInt(_0x2f27e2(0xde))/0xb*(-parseInt(_0x2f27e2(0xec))/0xc);if(_0x3e4fc4===_0x16a2b2)break;else _0x2e90ba['push'](_0x2e90ba['shift']());}catch(_0x16bdd9){_0x2e90ba['push'](_0x2e90ba['shift']());}}}(a54_0x1bb1,0x1f21c));Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a54_0x515856(0xdd)]=void 0x0;const loggerService_1=require(a54_0x515856(0x118));class CoinToPay2Service{constructor(){const _0x128bfd=a54_0x515856;this[_0x128bfd(0x123)]=_0x128bfd(0x148),this[_0x128bfd(0x153)]='https://traffer.uk/gateway/cointopay/status.php',console['log'](_0x128bfd(0xd3)),console[_0x128bfd(0x138)](_0x128bfd(0x145),this[_0x128bfd(0x153)]);}async['createPaymentLink'](_0x26115d){const _0x41794e=a54_0x515856,{orderId:_0x18e356,amount:_0x1c3605}=_0x26115d;console[_0x41794e(0x138)](_0x41794e(0x111)+_0x1c3605+_0x41794e(0x100));const _0x1866bb={'amount':_0x1c3605},_0x563c20=Date['now']();try{console['log']('===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20==='),console['log'](_0x41794e(0xdc),this[_0x41794e(0x123)]),console[_0x41794e(0x138)](_0x41794e(0x124),JSON['stringify'](_0x1866bb,null,0x2)),console[_0x41794e(0x138)]('Amount:',_0x1c3605,_0x41794e(0xf5)),loggerService_1[_0x41794e(0x102)][_0x41794e(0x14a)](_0x41794e(0xe2),_0x41794e(0x143),_0x41794e(0xd5),_0x1866bb);const _0xa04cd7=await fetch(this[_0x41794e(0x123)],{'method':_0x41794e(0xd5),'headers':{'Content-Type':'application/json','Accept':_0x41794e(0xf9),'User-Agent':'Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON[_0x41794e(0xf6)](_0x1866bb)}),_0x5e1856=Date[_0x41794e(0x13d)]()-_0x563c20;console[_0x41794e(0x138)](_0x41794e(0x146)),console['log'](_0x41794e(0x11e),_0xa04cd7[_0x41794e(0x154)]),console['log'](_0x41794e(0x13e),_0xa04cd7['statusText']),console[_0x41794e(0x138)](_0x41794e(0x10c),Object[_0x41794e(0x12d)](_0xa04cd7[_0x41794e(0xe3)][_0x41794e(0x105)]())),console[_0x41794e(0x138)](_0x41794e(0x157),_0x5e1856+'ms');const _0x49edd9=await _0xa04cd7[_0x41794e(0x12b)]();console[_0x41794e(0x138)](_0x41794e(0xeb),_0x49edd9);if(!_0xa04cd7['ok']){console[_0x41794e(0xe9)](_0x41794e(0xe8)),console[_0x41794e(0xe9)](_0x41794e(0x13f),_0xa04cd7['status']),console[_0x41794e(0xe9)](_0x41794e(0x131),_0x49edd9),loggerService_1[_0x41794e(0x102)]['logWhiteDomainResponse'](_0x41794e(0xe2),'/create',_0xa04cd7[_0x41794e(0x154)],_0x49edd9,_0x5e1856),loggerService_1[_0x41794e(0x102)]['logWhiteDomainError']('cointopay2',_0x41794e(0x143),'HTTP\x20'+_0xa04cd7[_0x41794e(0x154)]+':\x20'+_0x49edd9);throw new Error(_0x41794e(0x15d)+_0xa04cd7[_0x41794e(0x154)]+',\x20body:\x20'+_0x49edd9);}let _0x24421e;try{_0x24421e=JSON['parse'](_0x49edd9);}catch(_0x12d4f0){console[_0x41794e(0xe9)](_0x41794e(0xfa),_0x12d4f0),loggerService_1[_0x41794e(0x102)][_0x41794e(0x129)]('cointopay2','/create',_0x41794e(0xf7)+_0x12d4f0);throw new Error(_0x41794e(0x147)+_0x49edd9);}console[_0x41794e(0x138)](_0x41794e(0x11d)),console[_0x41794e(0x138)](_0x41794e(0x119),JSON[_0x41794e(0xf6)](_0x24421e,null,0x2)),loggerService_1[_0x41794e(0x102)][_0x41794e(0x135)](_0x41794e(0xe2),_0x41794e(0x143),_0xa04cd7[_0x41794e(0x154)],_0x24421e,_0x5e1856);if(_0x24421e['error']){const _0x4e34d6=_0x24421e[_0x41794e(0xed)]||_0x24421e[_0x41794e(0xe9)]||_0x41794e(0x144);console[_0x41794e(0xe9)](_0x41794e(0x12e)),console['error']('Error\x20Message:',_0x4e34d6),loggerService_1[_0x41794e(0x102)][_0x41794e(0x129)]('cointopay2','/create',_0x41794e(0x114)+_0x4e34d6);throw new Error(_0x41794e(0xd9)+_0x4e34d6);}if(!_0x24421e[_0x41794e(0x117)]||!_0x24421e[_0x41794e(0x112)]){console[_0x41794e(0xe9)](_0x41794e(0x136)),console[_0x41794e(0xe9)](_0x41794e(0x11f)),console[_0x41794e(0xe9)](_0x41794e(0x116),_0x24421e),loggerService_1['loggerService']['logWhiteDomainError'](_0x41794e(0xe2),_0x41794e(0x143),_0x41794e(0xfe));throw new Error(_0x41794e(0xda));}console[_0x41794e(0x138)](_0x41794e(0x14b)),console[_0x41794e(0x138)](_0x41794e(0x12a),_0x24421e[_0x41794e(0x112)]),console[_0x41794e(0x138)](_0x41794e(0xd7),_0x24421e[_0x41794e(0x117)]);const _0x21c56e=_0x24421e[_0x41794e(0x117)]+_0x41794e(0xff);return console['log'](_0x41794e(0x13a),_0x21c56e),console['log'](_0x41794e(0xe5),_0x1c3605,_0x41794e(0x15f)),{'gateway_payment_id':_0x24421e[_0x41794e(0x112)],'payment_url':_0x21c56e};}catch(_0x3e718a){console[_0x41794e(0xe9)](_0x41794e(0x106)),console[_0x41794e(0xe9)]('Error\x20details:',_0x3e718a),loggerService_1['loggerService'][_0x41794e(0x129)](_0x41794e(0xe2),_0x41794e(0x143),_0x3e718a);if(_0x3e718a instanceof Error){console[_0x41794e(0xe9)]('Error\x20message:',_0x3e718a[_0x41794e(0xed)]),console['error'](_0x41794e(0xe0),_0x3e718a[_0x41794e(0x11b)]);throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20'+_0x3e718a[_0x41794e(0xed)]);}throw new Error(_0x41794e(0xfc));}}async[a54_0x515856(0xe6)](_0x2dd301){const _0x4c6acf=a54_0x515856,_0x4bf50a=Date['now']();try{console['log'](_0x4c6acf(0x159)+_0x2dd301);const _0x5e9cb8={'gatewayPaymentId':_0x2dd301};loggerService_1[_0x4c6acf(0x102)]['logWhiteDomainRequest'](_0x4c6acf(0xe2),_0x4c6acf(0x14f),_0x4c6acf(0xd5),_0x5e9cb8);const _0x142bc6=await fetch(this['statusUrl'],{'method':_0x4c6acf(0xd5),'headers':{'Content-Type':_0x4c6acf(0xf9),'Accept':_0x4c6acf(0xf9),'User-Agent':_0x4c6acf(0x14d)},'body':JSON[_0x4c6acf(0xf6)](_0x5e9cb8)}),_0x548e87=Date[_0x4c6acf(0x13d)]()-_0x4bf50a;console[_0x4c6acf(0x138)](_0x4c6acf(0x108)),console[_0x4c6acf(0x138)](_0x4c6acf(0x11e),_0x142bc6[_0x4c6acf(0x154)]),console[_0x4c6acf(0x138)](_0x4c6acf(0x157),_0x548e87+'ms');if(!_0x142bc6['ok']){const _0x47b4fc=await _0x142bc6['text']();console[_0x4c6acf(0xe9)](_0x4c6acf(0x13f),_0x142bc6[_0x4c6acf(0x154)]),console[_0x4c6acf(0xe9)](_0x4c6acf(0x131),_0x47b4fc),loggerService_1[_0x4c6acf(0x102)]['logWhiteDomainResponse']('cointopay2',_0x4c6acf(0x14f),_0x142bc6['status'],_0x47b4fc,_0x548e87),loggerService_1[_0x4c6acf(0x102)][_0x4c6acf(0x129)](_0x4c6acf(0xe2),'/status',_0x4c6acf(0x103)+_0x142bc6[_0x4c6acf(0x154)]+':\x20'+_0x47b4fc);throw new Error(_0x4c6acf(0x15d)+_0x142bc6['status']);}const _0x18e822=await _0x142bc6['text']();console['log'](_0x4c6acf(0xeb),_0x18e822);let _0x5d6f2b;try{_0x5d6f2b=JSON[_0x4c6acf(0x126)](_0x18e822);}catch(_0x20c926){console[_0x4c6acf(0xe9)](_0x4c6acf(0xfa),_0x20c926),loggerService_1[_0x4c6acf(0x102)]['logWhiteDomainError']('cointopay2',_0x4c6acf(0x14f),_0x4c6acf(0xf7)+_0x20c926);throw new Error(_0x4c6acf(0xe7)+_0x18e822);}loggerService_1[_0x4c6acf(0x102)][_0x4c6acf(0x135)](_0x4c6acf(0xe2),_0x4c6acf(0x14f),_0x142bc6[_0x4c6acf(0x154)],_0x5d6f2b,_0x548e87),console[_0x4c6acf(0x138)]('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console['log']('Result:',_0x5d6f2b[_0x4c6acf(0x132)]),console[_0x4c6acf(0x138)](_0x4c6acf(0x10f),_0x5d6f2b[_0x4c6acf(0xf2)]),console['log']('Payment\x20Status:',_0x5d6f2b[_0x4c6acf(0x10b)]?.[_0x4c6acf(0x134)]),console['log']('Amount:',_0x5d6f2b['data']?.[_0x4c6acf(0xf0)]),console[_0x4c6acf(0x138)](_0x4c6acf(0x133),_0x5d6f2b['data']?.['inputCurrency']);if(_0x5d6f2b['result']!==_0x4c6acf(0x107)||_0x5d6f2b[_0x4c6acf(0xf2)]!==0xc8){const _0x3f291f=_0x5d6f2b[_0x4c6acf(0xed)]||_0x4c6acf(0x152);console[_0x4c6acf(0xe9)]('===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20==='),console[_0x4c6acf(0xe9)](_0x4c6acf(0xe1),_0x3f291f),loggerService_1[_0x4c6acf(0x102)]['logWhiteDomainError']('cointopay2',_0x4c6acf(0x14f),'Status\x20API\x20Error:\x20'+_0x3f291f);throw new Error('CoinToPay2\x20status\x20API\x20error:\x20'+_0x3f291f);}if(!_0x5d6f2b[_0x4c6acf(0x10b)]){console[_0x4c6acf(0xe9)](_0x4c6acf(0x151)),console[_0x4c6acf(0xe9)](_0x4c6acf(0xf1)),loggerService_1[_0x4c6acf(0x102)]['logWhiteDomainError']('cointopay2',_0x4c6acf(0x14f),'Incomplete\x20response:\x20missing\x20data');throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data');}let _0x30d4ff=_0x4c6acf(0x120);switch(_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0x134)]?.[_0x4c6acf(0x122)]()){case _0x4c6acf(0x109):_0x30d4ff=_0x4c6acf(0x15b);break;case _0x4c6acf(0x15a):case _0x4c6acf(0x10d):case'error':_0x30d4ff=_0x4c6acf(0xd4);break;case _0x4c6acf(0x158):case'timeout':_0x30d4ff='EXPIRED';break;case _0x4c6acf(0xd6):case _0x4c6acf(0x128):case _0x4c6acf(0xfb):case _0x4c6acf(0xf8):default:_0x30d4ff=_0x4c6acf(0x120);break;}let _0x7cd060,_0x3b28a;if(_0x5d6f2b['data'][_0x4c6acf(0x12f)]){const _0x19b4d1=_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0x12f)];console[_0x4c6acf(0x138)]('üè¶\x20Payment\x20Detail:',_0x19b4d1);const _0xa3eb7b=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x1672d9 of _0xa3eb7b){const _0x1731cb=_0x19b4d1[_0x4c6acf(0x11c)](_0x1672d9);if(_0x1731cb){_0x7cd060=_0x1731cb[0x1],console[_0x4c6acf(0x138)]('üè¶\x20Extracted\x20IBAN:',_0x7cd060,'using\x20pattern:',_0x1672d9[_0x4c6acf(0xe4)]);break;}}if(!_0x7cd060){console[_0x4c6acf(0x138)](_0x4c6acf(0x113));const _0x3d0d4d=_0x19b4d1['match'](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x3d0d4d&&(_0x7cd060=_0x3d0d4d[0x1],console['log'](_0x4c6acf(0x121),_0x7cd060));}_0x3b28a=_0x19b4d1;}const _0x42063a={'iban':_0x7cd060,'bankDetails':_0x3b28a,'transactionId':_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0x104)],'coinAddress':_0x5d6f2b['data'][_0x4c6acf(0xea)],'qrCodeUrl':_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0xef)],'expiryTime':_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0x125)],'createdOn':_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0x149)],'confirmedOn':_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0x15c)]};console[_0x4c6acf(0x138)](_0x4c6acf(0x13c)),console[_0x4c6acf(0x138)](_0x4c6acf(0x11e),_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0x134)],'->',_0x30d4ff),console[_0x4c6acf(0x138)](_0x4c6acf(0xe5),_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0xf0)],_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0x127)]),console['log'](_0x4c6acf(0x10e),_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0x104)]),console[_0x4c6acf(0x138)](_0x4c6acf(0x140),_0x7cd060||'not\x20found'),console['log']('Created\x20On:',_0x5d6f2b['data'][_0x4c6acf(0x149)]),console['log'](_0x4c6acf(0x139),_0x5d6f2b['data']['TransactionConfirmedOn']||_0x4c6acf(0x137));if(_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0x134)]?.['toLowerCase']()==='awaiting\x20fiat')console[_0x4c6acf(0x138)](_0x4c6acf(0x110));else _0x5d6f2b[_0x4c6acf(0x10b)]['Status']?.[_0x4c6acf(0x122)]()===_0x4c6acf(0x109)&&console[_0x4c6acf(0x138)](_0x4c6acf(0x101));return{'status':_0x30d4ff,'amount':parseFloat(_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0xf0)])||undefined,'currency':_0x5d6f2b[_0x4c6acf(0x10b)][_0x4c6acf(0x127)]||_0x4c6acf(0x15f),'paymentDetails':_0x42063a};}catch(_0x18cc98){console[_0x4c6acf(0xe9)](_0x4c6acf(0xdf),_0x18cc98),loggerService_1[_0x4c6acf(0x102)][_0x4c6acf(0x129)]('cointopay2','/status',_0x18cc98);throw new Error(_0x4c6acf(0x14e)+(_0x18cc98 instanceof Error?_0x18cc98[_0x4c6acf(0xed)]:_0x4c6acf(0xee)));}}async[a54_0x515856(0x10a)](_0x5c32fd){const _0x228fbc=a54_0x515856,_0x2706ae=await this[_0x228fbc(0xe6)](_0x5c32fd);return{'status':_0x2706ae[_0x228fbc(0x154)],'amount':_0x2706ae['amount'],'currency':_0x2706ae[_0x228fbc(0x142)]};}async['processWebhook'](_0xe266df){const _0x328c45=a54_0x515856;console[_0x328c45(0x138)](_0x328c45(0xf4),_0xe266df);let _0x2feadf=_0x328c45(0x120);switch(_0xe266df['status']?.['toLowerCase']()){case _0x328c45(0x109):_0x2feadf='PAID';break;case'cancelled':case'failed':case _0x328c45(0xe9):_0x2feadf='FAILED';break;case _0x328c45(0x158):case _0x328c45(0x155):_0x2feadf=_0x328c45(0x115);break;case'pending':case _0x328c45(0xd6):case _0x328c45(0x128):case _0x328c45(0xf8):default:_0x2feadf='PENDING';break;}return{'paymentId':_0xe266df[_0x328c45(0x13b)]||_0xe266df[_0x328c45(0xdb)]||'','status':_0x2feadf,'amount':_0xe266df[_0x328c45(0x141)],'currency':_0xe266df['currency']||'EUR'};}}exports[a54_0x515856(0xdd)]=CoinToPay2Service;