'use strict';const a48_0x544965=a48_0x5779;(function(_0x4f16a3,_0x27cb6e){const _0x42ce06=a48_0x5779,_0x4013f5=_0x4f16a3();while(!![]){try{const _0x128a90=parseInt(_0x42ce06(0x123))/0x1+parseInt(_0x42ce06(0x14e))/0x2+parseInt(_0x42ce06(0x129))/0x3*(parseInt(_0x42ce06(0x187))/0x4)+parseInt(_0x42ce06(0x18b))/0x5*(parseInt(_0x42ce06(0x17c))/0x6)+parseInt(_0x42ce06(0x132))/0x7+-parseInt(_0x42ce06(0x12a))/0x8*(parseInt(_0x42ce06(0x12f))/0x9)+-parseInt(_0x42ce06(0x158))/0xa;if(_0x128a90===_0x27cb6e)break;else _0x4013f5['push'](_0x4013f5['shift']());}catch(_0x547418){_0x4013f5['push'](_0x4013f5['shift']());}}}(a48_0x38d2,0x27cb4));function a48_0x38d2(){const _0x5b5205=['Headers:','Parsed\x20Result:','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','TransactionConfirmedOn','Missing\x20data\x20in\x20response','608ARzyPL','status_code','Response\x20Body:','Amount','Created\x20On:','Payment\x20URL\x20(original):','56649NpmUml','888824XiWyJc','Unknown\x20error','CreatedOn','result','status','18PYGZgK','verifyPayment','paid','1496047PUmmic','CoinToPay2Service','waiting','logWhiteDomainRequest','Incomplete\x20response:\x20missing\x20data','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','Status:','CoinToPay2\x20API\x20error:\x20','Response\x20data:','error','üè¶\x20Extracted\x20IBAN:','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','Status\x20Code:','currency','/status','match','EUR','expired','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','EXPIRED','using\x20pattern:','not\x20confirmed','order_id','message','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','Confirmed\x20On:','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','60766YrWKds','TransactionID','logWhiteDomainError','üìä\x20Status\x20check\x20URL:',',\x20body:\x20','Request\x20Body:','Amount:','Failed\x20to\x20parse\x20JSON\x20response:','inputCurrency','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','3226430QnKVpb','ExpiryTime','timeout','CoinToPay2\x20status\x20API\x20error:\x20','entries','Error\x20message:','/create','QRCodeURL','Status\x20API\x20Error:\x20','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','HTTP\x20','Error\x20Message:','Response\x20Time:','FAILED','awaiting\x20fiat','JSON\x20Parse\x20Error:\x20','üè¶\x20Payment\x20Detail:','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','log','PAID','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','statusText','created','cointopay2','cancelled','logWhiteDomainResponse','HTTP\x20Status:','pending','data','URL:','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','Status','Payment\x20System/1.0\x20(CoinToPay2)','\x20EUR','failed','statusUrl','114JjOjie','processWebhook','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','https://traffer.uk/gateway/cointopay/','&alternative=false','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','PaymentDetail','application/json','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','40MRzfmK','gateway_payment_id','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','merchant_reference_id','72185BSRYzu','loggerService','headers','CoinToPay2\x20payment\x20status\x20check\x20error:','PENDING','toLowerCase','payment_url','now','not\x20found','checkPaymentStatus','createPaymentLink','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','Business\x20Error:\x20','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','text','Payment\x20Status:','apiUrl','source','stringify','defineProperty','HTTP\x20error!\x20status:\x20','POST'];a48_0x38d2=function(){return _0x5b5205;};return a48_0x38d2();}Object[a48_0x544965(0x1a0)](exports,'__esModule',{'value':!![]}),exports[a48_0x544965(0x133)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x2a36a9=a48_0x544965;this['apiUrl']=_0x2a36a9(0x180),this[_0x2a36a9(0x17b)]='https://traffer.uk/gateway/cointopay/status.php',console[_0x2a36a9(0x16a)]('ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy'),console[_0x2a36a9(0x16a)](_0x2a36a9(0x151),this[_0x2a36a9(0x17b)]);}async[a48_0x544965(0x195)](_0x4da4b6){const _0x343f4e=a48_0x544965,{orderId:_0xbc3af9,amount:_0x287d9b}=_0x4da4b6;console[_0x343f4e(0x16a)](_0x343f4e(0x19a)+_0x287d9b+_0x343f4e(0x179));const _0x2a546b={'amount':_0x287d9b},_0x427bee=Date[_0x343f4e(0x192)]();try{console[_0x343f4e(0x16a)](_0x343f4e(0x14d)),console[_0x343f4e(0x16a)](_0x343f4e(0x175),this[_0x343f4e(0x19d)]),console[_0x343f4e(0x16a)](_0x343f4e(0x153),JSON[_0x343f4e(0x19f)](_0x2a546b,null,0x2)),console[_0x343f4e(0x16a)](_0x343f4e(0x154),_0x287d9b,_0x343f4e(0x16c)),loggerService_1[_0x343f4e(0x18c)][_0x343f4e(0x135)](_0x343f4e(0x16f),'/create',_0x343f4e(0x1a2),_0x2a546b);const _0x17f039=await fetch(this[_0x343f4e(0x19d)],{'method':_0x343f4e(0x1a2),'headers':{'Content-Type':'application/json','Accept':_0x343f4e(0x184),'User-Agent':'Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON[_0x343f4e(0x19f)](_0x2a546b)}),_0x4daff7=Date[_0x343f4e(0x192)]()-_0x427bee;console[_0x343f4e(0x16a)]('===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20==='),console['log'](_0x343f4e(0x138),_0x17f039[_0x343f4e(0x12e)]),console[_0x343f4e(0x16a)]('Status\x20Text:',_0x17f039[_0x343f4e(0x16d)]),console[_0x343f4e(0x16a)](_0x343f4e(0x1a3),Object['fromEntries'](_0x17f039[_0x343f4e(0x18d)][_0x343f4e(0x15c)]())),console[_0x343f4e(0x16a)](_0x343f4e(0x164),_0x4daff7+'ms');const _0x49ff02=await _0x17f039[_0x343f4e(0x19b)]();console[_0x343f4e(0x16a)]('Raw\x20Response\x20Body:',_0x49ff02);if(!_0x17f039['ok']){console[_0x343f4e(0x13b)]('===\x20COINTOPAY2\x20API\x20ERROR\x20==='),console[_0x343f4e(0x13b)](_0x343f4e(0x172),_0x17f039[_0x343f4e(0x12e)]),console[_0x343f4e(0x13b)](_0x343f4e(0x125),_0x49ff02),loggerService_1[_0x343f4e(0x18c)][_0x343f4e(0x171)](_0x343f4e(0x16f),_0x343f4e(0x15e),_0x17f039['status'],_0x49ff02,_0x4daff7),loggerService_1[_0x343f4e(0x18c)][_0x343f4e(0x150)](_0x343f4e(0x16f),_0x343f4e(0x15e),_0x343f4e(0x162)+_0x17f039[_0x343f4e(0x12e)]+':\x20'+_0x49ff02);throw new Error('HTTP\x20error!\x20status:\x20'+_0x17f039[_0x343f4e(0x12e)]+_0x343f4e(0x152)+_0x49ff02);}let _0xd87398;try{_0xd87398=JSON['parse'](_0x49ff02);}catch(_0x51337b){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0x51337b),loggerService_1[_0x343f4e(0x18c)][_0x343f4e(0x150)](_0x343f4e(0x16f),_0x343f4e(0x15e),_0x343f4e(0x167)+_0x51337b);throw new Error(_0x343f4e(0x120)+_0x49ff02);}console[_0x343f4e(0x16a)](_0x343f4e(0x13d)),console[_0x343f4e(0x16a)](_0x343f4e(0x1a4),JSON[_0x343f4e(0x19f)](_0xd87398,null,0x2)),loggerService_1[_0x343f4e(0x18c)]['logWhiteDomainResponse']('cointopay2','/create',_0x17f039[_0x343f4e(0x12e)],_0xd87398,_0x4daff7);if(_0xd87398['error']){const _0xc94583=_0xd87398[_0x343f4e(0x14a)]||_0xd87398[_0x343f4e(0x13b)]||'Unknown\x20error\x20from\x20CoinToPay2\x20API';console[_0x343f4e(0x13b)](_0x343f4e(0x137)),console[_0x343f4e(0x13b)](_0x343f4e(0x163),_0xc94583),loggerService_1[_0x343f4e(0x18c)][_0x343f4e(0x150)](_0x343f4e(0x16f),_0x343f4e(0x15e),_0x343f4e(0x197)+_0xc94583);throw new Error(_0x343f4e(0x139)+_0xc94583);}if(!_0xd87398[_0x343f4e(0x191)]||!_0xd87398['gateway_payment_id']){console[_0x343f4e(0x13b)](_0x343f4e(0x198)),console[_0x343f4e(0x13b)]('Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response'),console[_0x343f4e(0x13b)](_0x343f4e(0x13a),_0xd87398),loggerService_1[_0x343f4e(0x18c)]['logWhiteDomainError'](_0x343f4e(0x16f),_0x343f4e(0x15e),_0x343f4e(0x161));throw new Error(_0x343f4e(0x13e));}console[_0x343f4e(0x16a)]('===\x20COINTOPAY2\x20SUCCESS\x20==='),console[_0x343f4e(0x16a)]('Gateway\x20Payment\x20ID:',_0xd87398[_0x343f4e(0x188)]),console[_0x343f4e(0x16a)](_0x343f4e(0x128),_0xd87398[_0x343f4e(0x191)]);const _0x16e83b=_0xd87398['payment_url']+_0x343f4e(0x181);return console[_0x343f4e(0x16a)]('Payment\x20URL\x20(modified):',_0x16e83b),console[_0x343f4e(0x16a)]('Amount:',_0x287d9b,_0x343f4e(0x143)),{'gateway_payment_id':_0xd87398[_0x343f4e(0x188)],'payment_url':_0x16e83b};}catch(_0x43e149){console['error'](_0x343f4e(0x199)),console[_0x343f4e(0x13b)]('Error\x20details:',_0x43e149),loggerService_1[_0x343f4e(0x18c)][_0x343f4e(0x150)](_0x343f4e(0x16f),_0x343f4e(0x15e),_0x43e149);if(_0x43e149 instanceof Error){console[_0x343f4e(0x13b)](_0x343f4e(0x15d),_0x43e149[_0x343f4e(0x14a)]),console['error']('Error\x20stack:',_0x43e149['stack']);throw new Error(_0x343f4e(0x176)+_0x43e149[_0x343f4e(0x14a)]);}throw new Error(_0x343f4e(0x196));}}async[a48_0x544965(0x194)](_0x6d3e95){const _0x519bc2=a48_0x544965,_0x17e775=Date[_0x519bc2(0x192)]();try{console[_0x519bc2(0x16a)](_0x519bc2(0x189)+_0x6d3e95);const _0x19de52={'gatewayPaymentId':_0x6d3e95};loggerService_1[_0x519bc2(0x18c)][_0x519bc2(0x135)](_0x519bc2(0x16f),_0x519bc2(0x141),_0x519bc2(0x1a2),_0x19de52);const _0x30cb7d=await fetch(this['statusUrl'],{'method':'POST','headers':{'Content-Type':_0x519bc2(0x184),'Accept':_0x519bc2(0x184),'User-Agent':_0x519bc2(0x178)},'body':JSON[_0x519bc2(0x19f)](_0x19de52)}),_0x3645f0=Date['now']()-_0x17e775;console['log'](_0x519bc2(0x182)),console['log']('Status:',_0x30cb7d[_0x519bc2(0x12e)]),console[_0x519bc2(0x16a)]('Response\x20Time:',_0x3645f0+'ms');if(!_0x30cb7d['ok']){const _0x345470=await _0x30cb7d[_0x519bc2(0x19b)]();console[_0x519bc2(0x13b)](_0x519bc2(0x172),_0x30cb7d[_0x519bc2(0x12e)]),console[_0x519bc2(0x13b)]('Response\x20Body:',_0x345470),loggerService_1[_0x519bc2(0x18c)]['logWhiteDomainResponse']('cointopay2','/status',_0x30cb7d['status'],_0x345470,_0x3645f0),loggerService_1[_0x519bc2(0x18c)][_0x519bc2(0x150)](_0x519bc2(0x16f),_0x519bc2(0x141),_0x519bc2(0x162)+_0x30cb7d[_0x519bc2(0x12e)]+':\x20'+_0x345470);throw new Error(_0x519bc2(0x1a1)+_0x30cb7d[_0x519bc2(0x12e)]);}const _0x1f117b=await _0x30cb7d[_0x519bc2(0x19b)]();console[_0x519bc2(0x16a)]('Raw\x20Response\x20Body:',_0x1f117b);let _0x1b529d;try{_0x1b529d=JSON['parse'](_0x1f117b);}catch(_0x59a748){console[_0x519bc2(0x13b)](_0x519bc2(0x155),_0x59a748),loggerService_1[_0x519bc2(0x18c)][_0x519bc2(0x150)](_0x519bc2(0x16f),'/status',_0x519bc2(0x167)+_0x59a748);throw new Error(_0x519bc2(0x186)+_0x1f117b);}loggerService_1[_0x519bc2(0x18c)]['logWhiteDomainResponse'](_0x519bc2(0x16f),_0x519bc2(0x141),_0x30cb7d['status'],_0x1b529d,_0x3645f0),console[_0x519bc2(0x16a)](_0x519bc2(0x145)),console[_0x519bc2(0x16a)]('Result:',_0x1b529d[_0x519bc2(0x12d)]),console[_0x519bc2(0x16a)](_0x519bc2(0x13f),_0x1b529d['status_code']),console[_0x519bc2(0x16a)](_0x519bc2(0x19c),_0x1b529d['data']?.[_0x519bc2(0x177)]),console[_0x519bc2(0x16a)](_0x519bc2(0x154),_0x1b529d['data']?.[_0x519bc2(0x126)]),console[_0x519bc2(0x16a)]('Currency:',_0x1b529d[_0x519bc2(0x174)]?.[_0x519bc2(0x156)]);if(_0x1b529d[_0x519bc2(0x12d)]!=='success'||_0x1b529d[_0x519bc2(0x124)]!==0xc8){const _0x3c061a=_0x1b529d[_0x519bc2(0x14a)]||_0x519bc2(0x157);console[_0x519bc2(0x13b)]('===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20==='),console[_0x519bc2(0x13b)](_0x519bc2(0x163),_0x3c061a),loggerService_1[_0x519bc2(0x18c)]['logWhiteDomainError'](_0x519bc2(0x16f),'/status',_0x519bc2(0x160)+_0x3c061a);throw new Error(_0x519bc2(0x15b)+_0x3c061a);}if(!_0x1b529d[_0x519bc2(0x174)]){console['error']('===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x519bc2(0x13b)](_0x519bc2(0x122)),loggerService_1['loggerService'][_0x519bc2(0x150)](_0x519bc2(0x16f),_0x519bc2(0x141),_0x519bc2(0x136));throw new Error(_0x519bc2(0x185));}let _0x3fe8ad=_0x519bc2(0x18f);switch(_0x1b529d[_0x519bc2(0x174)]['Status']?.[_0x519bc2(0x190)]()){case'paid':_0x3fe8ad=_0x519bc2(0x16b);break;case _0x519bc2(0x170):case _0x519bc2(0x17a):case _0x519bc2(0x13b):_0x3fe8ad='FAILED';break;case _0x519bc2(0x144):case _0x519bc2(0x15a):_0x3fe8ad='EXPIRED';break;case _0x519bc2(0x134):case _0x519bc2(0x166):case _0x519bc2(0x173):case _0x519bc2(0x16e):default:_0x3fe8ad=_0x519bc2(0x18f);break;}let _0x465b30,_0x15d49b;if(_0x1b529d[_0x519bc2(0x174)][_0x519bc2(0x183)]){const _0x4c19c9=_0x1b529d['data']['PaymentDetail'];console[_0x519bc2(0x16a)](_0x519bc2(0x168),_0x4c19c9);const _0x311996=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x223614 of _0x311996){const _0x3d9ca7=_0x4c19c9[_0x519bc2(0x142)](_0x223614);if(_0x3d9ca7){_0x465b30=_0x3d9ca7[0x1],console[_0x519bc2(0x16a)](_0x519bc2(0x13c),_0x465b30,_0x519bc2(0x147),_0x223614[_0x519bc2(0x19e)]);break;}}if(!_0x465b30){console[_0x519bc2(0x16a)](_0x519bc2(0x14b));const _0x2228a6=_0x4c19c9[_0x519bc2(0x142)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x2228a6&&(_0x465b30=_0x2228a6[0x1],console[_0x519bc2(0x16a)](_0x519bc2(0x17f),_0x465b30));}_0x15d49b=_0x4c19c9;}const _0x2c09e8={'iban':_0x465b30,'bankDetails':_0x15d49b,'transactionId':_0x1b529d[_0x519bc2(0x174)][_0x519bc2(0x14f)],'coinAddress':_0x1b529d['data']['coinAddress'],'qrCodeUrl':_0x1b529d[_0x519bc2(0x174)][_0x519bc2(0x15f)],'expiryTime':_0x1b529d[_0x519bc2(0x174)][_0x519bc2(0x159)],'createdOn':_0x1b529d[_0x519bc2(0x174)]['CreatedOn'],'confirmedOn':_0x1b529d[_0x519bc2(0x174)][_0x519bc2(0x121)]};console[_0x519bc2(0x16a)](_0x519bc2(0x17e)),console[_0x519bc2(0x16a)](_0x519bc2(0x138),_0x1b529d['data'][_0x519bc2(0x177)],'->',_0x3fe8ad),console['log'](_0x519bc2(0x154),_0x1b529d[_0x519bc2(0x174)][_0x519bc2(0x126)],_0x1b529d[_0x519bc2(0x174)][_0x519bc2(0x156)]),console[_0x519bc2(0x16a)]('Transaction\x20ID:',_0x1b529d[_0x519bc2(0x174)][_0x519bc2(0x14f)]),console[_0x519bc2(0x16a)]('IBAN:',_0x465b30||_0x519bc2(0x193)),console[_0x519bc2(0x16a)](_0x519bc2(0x127),_0x1b529d[_0x519bc2(0x174)][_0x519bc2(0x12c)]),console['log'](_0x519bc2(0x14c),_0x1b529d[_0x519bc2(0x174)][_0x519bc2(0x121)]||_0x519bc2(0x148));if(_0x1b529d['data']['Status']?.['toLowerCase']()==='awaiting\x20fiat')console['log']('üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)');else _0x1b529d[_0x519bc2(0x174)][_0x519bc2(0x177)]?.[_0x519bc2(0x190)]()===_0x519bc2(0x131)&&console[_0x519bc2(0x16a)]('‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID');return{'status':_0x3fe8ad,'amount':parseFloat(_0x1b529d[_0x519bc2(0x174)][_0x519bc2(0x126)])||undefined,'currency':_0x1b529d['data']['inputCurrency']||_0x519bc2(0x143),'paymentDetails':_0x2c09e8};}catch(_0x41e9e9){console[_0x519bc2(0x13b)](_0x519bc2(0x18e),_0x41e9e9),loggerService_1[_0x519bc2(0x18c)][_0x519bc2(0x150)](_0x519bc2(0x16f),_0x519bc2(0x141),_0x41e9e9);throw new Error(_0x519bc2(0x169)+(_0x41e9e9 instanceof Error?_0x41e9e9[_0x519bc2(0x14a)]:_0x519bc2(0x12b)));}}async[a48_0x544965(0x130)](_0x2c2875){const _0x27951c=a48_0x544965,_0x3408ac=await this[_0x27951c(0x194)](_0x2c2875);return{'status':_0x3408ac[_0x27951c(0x12e)],'amount':_0x3408ac['amount'],'currency':_0x3408ac[_0x27951c(0x140)]};}async[a48_0x544965(0x17d)](_0x2ae672){const _0x520155=a48_0x544965;console['log']('Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x2ae672);let _0x3adf1e=_0x520155(0x18f);switch(_0x2ae672['status']?.[_0x520155(0x190)]()){case _0x520155(0x131):_0x3adf1e=_0x520155(0x16b);break;case'cancelled':case _0x520155(0x17a):case _0x520155(0x13b):_0x3adf1e=_0x520155(0x165);break;case _0x520155(0x144):case'timeout':_0x3adf1e=_0x520155(0x146);break;case _0x520155(0x173):case _0x520155(0x134):case _0x520155(0x166):case _0x520155(0x16e):default:_0x3adf1e='PENDING';break;}return{'paymentId':_0x2ae672[_0x520155(0x149)]||_0x2ae672[_0x520155(0x18a)]||'','status':_0x3adf1e,'amount':_0x2ae672['amount'],'currency':_0x2ae672['currency']||'EUR'};}}function a48_0x5779(_0x251143,_0x496acc){const _0x38d218=a48_0x38d2();return a48_0x5779=function(_0x57792a,_0x46972e){_0x57792a=_0x57792a-0x120;let _0xb1a845=_0x38d218[_0x57792a];return _0xb1a845;},a48_0x5779(_0x251143,_0x496acc);}exports['CoinToPay2Service']=CoinToPay2Service;