'use strict';const a43_0xee2650=a43_0x54ff;(function(_0x402592,_0x587590){const _0x3d3b7e=a43_0x54ff,_0x381911=_0x402592();while(!![]){try{const _0x12a15b=-parseInt(_0x3d3b7e(0x164))/0x1*(parseInt(_0x3d3b7e(0x1a8))/0x2)+parseInt(_0x3d3b7e(0x1df))/0x3+parseInt(_0x3d3b7e(0x15d))/0x4+-parseInt(_0x3d3b7e(0x1c4))/0x5*(-parseInt(_0x3d3b7e(0x1a6))/0x6)+-parseInt(_0x3d3b7e(0x185))/0x7*(parseInt(_0x3d3b7e(0x170))/0x8)+-parseInt(_0x3d3b7e(0x183))/0x9+-parseInt(_0x3d3b7e(0x18b))/0xa*(-parseInt(_0x3d3b7e(0x184))/0xb);if(_0x12a15b===_0x587590)break;else _0x381911['push'](_0x381911['shift']());}catch(_0x53d733){_0x381911['push'](_0x381911['shift']());}}}(a43_0x45c7,0xe0069));function a43_0x54ff(_0x5aadcd,_0x5774b0){const _0x45c7e8=a43_0x45c7();return a43_0x54ff=function(_0x54ff64,_0x3a7acb){_0x54ff64=_0x54ff64-0x15a;let _0x55c985=_0x45c7e8[_0x54ff64];return _0x55c985;},a43_0x54ff(_0x5aadcd,_0x5774b0);}function a43_0x45c7(){const _0x25f56a=['\x20EUR','Amount','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','Failed\x20to\x20parse\x20JSON\x20response:','IBAN:','üè¶\x20Payment\x20Detail:','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','loggerService','3340209jMMYJk','Status\x20API\x20Error:\x20','PaymentDetail','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','currency','failed','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','Error\x20Message:','headers','Amount:','7295880wxZAju','ExpiryTime','Business\x20Error:\x20','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','logWhiteDomainRequest','HTTP\x20Status:','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','17bzJssZ','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','awaiting\x20fiat','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','expired','processWebhook','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','status','logWhiteDomainError','CoinToPay2\x20payment\x20status\x20check\x20error:','EUR','8pMShIE','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','Status\x20Code:','success','now','logWhiteDomainResponse','EXPIRED','checkPaymentStatus','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','application/json','URL:','message','Status:','merchant_reference_id','toLowerCase','paid','POST','CoinToPay2Service','amount','4245813arMXPb','1251525CQlsMu','4526543BdgjiD','Payment\x20URL:','error','HTTP\x20','===\x20COINTOPAY2\x20SUCCESS\x20===','pending','20GUVLeB','Created\x20On:','status_code','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','Headers:','match','JSON\x20Parse\x20Error:\x20','Response\x20Time:','stack','log','Response\x20Body:','statusText','https://traffer.uk/gateway/cointopay/status.php','Error\x20message:','data','https://traffer.uk/gateway/cointopay/','Error\x20details:','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','Currency:','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','CreatedOn','order_id','verifyPayment','QRCodeURL','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','PENDING','778350Jlogjv','parse','178598kUNzQf','statusUrl','payment_url','coinAddress','TransactionConfirmedOn','created','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','üè¶\x20Extracted\x20IBAN:','Parsed\x20Result:','stringify','Response\x20data:','/status','Incomplete\x20response:\x20missing\x20data','PAID','Unknown\x20error\x20from\x20CoinToPay2\x20API','entries','FAILED','Confirmed\x20On:','Raw\x20Response\x20Body:','Status','cancelled','apiUrl','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','Unknown\x20error','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','text','Missing\x20data\x20in\x20response','fromEntries','15DGzePR','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','TransactionID','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','waiting','Request\x20Body:','not\x20confirmed','Result:','result','HTTP\x20error!\x20status:\x20','cointopay2','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','inputCurrency','Error\x20stack:','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','/create','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','gateway_payment_id'];a43_0x45c7=function(){return _0x25f56a;};return a43_0x45c7();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a43_0xee2650(0x181)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x592ab8=a43_0xee2650;this[_0x592ab8(0x1bd)]=_0x592ab8(0x19a),this[_0x592ab8(0x1a9)]=_0x592ab8(0x197),console[_0x592ab8(0x194)](_0x592ab8(0x168)),console[_0x592ab8(0x194)]('üìä\x20Status\x20check\x20URL:',this[_0x592ab8(0x1a9)]);}async['createPaymentLink'](_0x401936){const _0x241cdc=a43_0xee2650,{orderId:_0x3b36d2,amount:_0xacaf85}=_0x401936;console[_0x241cdc(0x194)](_0x241cdc(0x18e)+_0xacaf85+_0x241cdc(0x1d7));const _0x379226={'amount':_0xacaf85},_0x25186d=Date['now']();try{console['log']('===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20==='),console[_0x241cdc(0x194)](_0x241cdc(0x17a),this['apiUrl']),console[_0x241cdc(0x194)](_0x241cdc(0x1c9),JSON['stringify'](_0x379226,null,0x2)),console[_0x241cdc(0x194)](_0x241cdc(0x15c),_0xacaf85,_0x241cdc(0x1dd)),loggerService_1['loggerService'][_0x241cdc(0x161)](_0x241cdc(0x1ce),'/create',_0x241cdc(0x180),_0x379226);const _0x2cce4f=await fetch(this[_0x241cdc(0x1bd)],{'method':_0x241cdc(0x180),'headers':{'Content-Type':'application/json','Accept':_0x241cdc(0x179),'User-Agent':_0x241cdc(0x1e2)},'body':JSON[_0x241cdc(0x1b1)](_0x379226)}),_0x2b844e=Date[_0x241cdc(0x174)]()-_0x25186d;console[_0x241cdc(0x194)]('===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20==='),console[_0x241cdc(0x194)](_0x241cdc(0x17c),_0x2cce4f[_0x241cdc(0x16c)]),console['log']('Status\x20Text:',_0x2cce4f[_0x241cdc(0x196)]),console[_0x241cdc(0x194)](_0x241cdc(0x18f),Object[_0x241cdc(0x1c3)](_0x2cce4f[_0x241cdc(0x15b)][_0x241cdc(0x1b7)]())),console['log'](_0x241cdc(0x192),_0x2b844e+'ms');const _0x5ddf6b=await _0x2cce4f[_0x241cdc(0x1c1)]();console[_0x241cdc(0x194)]('Raw\x20Response\x20Body:',_0x5ddf6b);if(!_0x2cce4f['ok']){console[_0x241cdc(0x187)]('===\x20COINTOPAY2\x20API\x20ERROR\x20==='),console[_0x241cdc(0x187)](_0x241cdc(0x162),_0x2cce4f[_0x241cdc(0x16c)]),console[_0x241cdc(0x187)]('Response\x20Body:',_0x5ddf6b),loggerService_1[_0x241cdc(0x1de)][_0x241cdc(0x175)](_0x241cdc(0x1ce),'/create',_0x2cce4f[_0x241cdc(0x16c)],_0x5ddf6b,_0x2b844e),loggerService_1[_0x241cdc(0x1de)]['logWhiteDomainError']('cointopay2','/create',_0x241cdc(0x188)+_0x2cce4f[_0x241cdc(0x16c)]+':\x20'+_0x5ddf6b);throw new Error(_0x241cdc(0x1cd)+_0x2cce4f[_0x241cdc(0x16c)]+',\x20body:\x20'+_0x5ddf6b);}let _0x2d3b0a;try{_0x2d3b0a=JSON[_0x241cdc(0x1a7)](_0x5ddf6b);}catch(_0x54f8b5){console[_0x241cdc(0x187)](_0x241cdc(0x1da),_0x54f8b5),loggerService_1[_0x241cdc(0x1de)][_0x241cdc(0x16d)](_0x241cdc(0x1ce),_0x241cdc(0x1d3),_0x241cdc(0x191)+_0x54f8b5);throw new Error(_0x241cdc(0x1be)+_0x5ddf6b);}console[_0x241cdc(0x194)](_0x241cdc(0x163)),console[_0x241cdc(0x194)](_0x241cdc(0x1b0),JSON[_0x241cdc(0x1b1)](_0x2d3b0a,null,0x2)),loggerService_1[_0x241cdc(0x1de)]['logWhiteDomainResponse'](_0x241cdc(0x1ce),_0x241cdc(0x1d3),_0x2cce4f[_0x241cdc(0x16c)],_0x2d3b0a,_0x2b844e);if(_0x2d3b0a['error']){const _0x29b6e0=_0x2d3b0a['message']||_0x2d3b0a[_0x241cdc(0x187)]||_0x241cdc(0x1b6);console['error']('===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x241cdc(0x187)](_0x241cdc(0x15a),_0x29b6e0),loggerService_1['loggerService'][_0x241cdc(0x16d)]('cointopay2',_0x241cdc(0x1d3),_0x241cdc(0x15f)+_0x29b6e0);throw new Error('CoinToPay2\x20API\x20error:\x20'+_0x29b6e0);}if(!_0x2d3b0a['payment_url']||!_0x2d3b0a[_0x241cdc(0x1d6)]){console['error'](_0x241cdc(0x1c5)),console['error'](_0x241cdc(0x160)),console[_0x241cdc(0x187)](_0x241cdc(0x1b2),_0x2d3b0a),loggerService_1[_0x241cdc(0x1de)][_0x241cdc(0x16d)](_0x241cdc(0x1ce),_0x241cdc(0x1d3),'Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error(_0x241cdc(0x1d2));}return console[_0x241cdc(0x194)](_0x241cdc(0x189)),console['log']('Gateway\x20Payment\x20ID:',_0x2d3b0a['gateway_payment_id']),console[_0x241cdc(0x194)](_0x241cdc(0x186),_0x2d3b0a[_0x241cdc(0x1aa)]),console[_0x241cdc(0x194)]('Amount:',_0xacaf85,_0x241cdc(0x16f)),{'gateway_payment_id':_0x2d3b0a[_0x241cdc(0x1d6)],'payment_url':_0x2d3b0a[_0x241cdc(0x1aa)]};}catch(_0x2ecc5e){console['error'](_0x241cdc(0x1cf)),console[_0x241cdc(0x187)](_0x241cdc(0x19b),_0x2ecc5e),loggerService_1[_0x241cdc(0x1de)][_0x241cdc(0x16d)](_0x241cdc(0x1ce),_0x241cdc(0x1d3),_0x2ecc5e);if(_0x2ecc5e instanceof Error){console[_0x241cdc(0x187)](_0x241cdc(0x198),_0x2ecc5e['message']),console[_0x241cdc(0x187)](_0x241cdc(0x1d1),_0x2ecc5e[_0x241cdc(0x193)]);throw new Error(_0x241cdc(0x1e5)+_0x2ecc5e['message']);}throw new Error(_0x241cdc(0x178));}}async[a43_0xee2650(0x177)](_0x586d39){const _0x84d077=a43_0xee2650,_0x323af2=Date[_0x84d077(0x174)]();try{console['log'](_0x84d077(0x171)+_0x586d39);const _0x379429={'gatewayPaymentId':_0x586d39};loggerService_1[_0x84d077(0x1de)][_0x84d077(0x161)](_0x84d077(0x1ce),_0x84d077(0x1b3),_0x84d077(0x180),_0x379429);const _0x52a8fc=await fetch(this['statusUrl'],{'method':_0x84d077(0x180),'headers':{'Content-Type':_0x84d077(0x179),'Accept':_0x84d077(0x179),'User-Agent':_0x84d077(0x1e2)},'body':JSON['stringify'](_0x379429)}),_0x240fa7=Date[_0x84d077(0x174)]()-_0x323af2;console['log'](_0x84d077(0x1d9)),console['log'](_0x84d077(0x17c),_0x52a8fc[_0x84d077(0x16c)]),console[_0x84d077(0x194)](_0x84d077(0x192),_0x240fa7+'ms');if(!_0x52a8fc['ok']){const _0x320247=await _0x52a8fc['text']();console[_0x84d077(0x187)]('HTTP\x20Status:',_0x52a8fc[_0x84d077(0x16c)]),console[_0x84d077(0x187)](_0x84d077(0x195),_0x320247),loggerService_1[_0x84d077(0x1de)][_0x84d077(0x175)]('cointopay2',_0x84d077(0x1b3),_0x52a8fc[_0x84d077(0x16c)],_0x320247,_0x240fa7),loggerService_1[_0x84d077(0x1de)]['logWhiteDomainError']('cointopay2',_0x84d077(0x1b3),_0x84d077(0x188)+_0x52a8fc[_0x84d077(0x16c)]+':\x20'+_0x320247);throw new Error(_0x84d077(0x1cd)+_0x52a8fc['status']);}const _0x40ddd9=await _0x52a8fc[_0x84d077(0x1c1)]();console[_0x84d077(0x194)](_0x84d077(0x1ba),_0x40ddd9);let _0x92ec20;try{_0x92ec20=JSON[_0x84d077(0x1a7)](_0x40ddd9);}catch(_0x3b0d8f){console[_0x84d077(0x187)](_0x84d077(0x1da),_0x3b0d8f),loggerService_1[_0x84d077(0x1de)][_0x84d077(0x16d)]('cointopay2','/status','JSON\x20Parse\x20Error:\x20'+_0x3b0d8f);throw new Error(_0x84d077(0x19c)+_0x40ddd9);}loggerService_1['loggerService'][_0x84d077(0x175)](_0x84d077(0x1ce),_0x84d077(0x1b3),_0x52a8fc[_0x84d077(0x16c)],_0x92ec20,_0x240fa7),console[_0x84d077(0x194)](_0x84d077(0x1c7)),console['log'](_0x84d077(0x1cb),_0x92ec20[_0x84d077(0x1cc)]),console[_0x84d077(0x194)](_0x84d077(0x172),_0x92ec20['status_code']),console[_0x84d077(0x194)]('Payment\x20Status:',_0x92ec20[_0x84d077(0x199)]?.['Status']),console[_0x84d077(0x194)](_0x84d077(0x15c),_0x92ec20['data']?.[_0x84d077(0x1d8)]),console[_0x84d077(0x194)](_0x84d077(0x19d),_0x92ec20[_0x84d077(0x199)]?.['inputCurrency']);if(_0x92ec20[_0x84d077(0x1cc)]!==_0x84d077(0x173)||_0x92ec20[_0x84d077(0x18d)]!==0xc8){const _0x5da9f7=_0x92ec20['message']||'Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API';console[_0x84d077(0x187)](_0x84d077(0x166)),console['error']('Error\x20Message:',_0x5da9f7),loggerService_1[_0x84d077(0x1de)][_0x84d077(0x16d)](_0x84d077(0x1ce),_0x84d077(0x1b3),_0x84d077(0x1e0)+_0x5da9f7);throw new Error('CoinToPay2\x20status\x20API\x20error:\x20'+_0x5da9f7);}if(!_0x92ec20[_0x84d077(0x199)]){console[_0x84d077(0x187)](_0x84d077(0x1d5)),console[_0x84d077(0x187)](_0x84d077(0x1c2)),loggerService_1['loggerService']['logWhiteDomainError'](_0x84d077(0x1ce),_0x84d077(0x1b3),_0x84d077(0x1b4));throw new Error(_0x84d077(0x1a4));}let _0x58c7bd=_0x84d077(0x1a5);switch(_0x92ec20[_0x84d077(0x199)][_0x84d077(0x1bb)]?.[_0x84d077(0x17e)]()){case _0x84d077(0x17f):_0x58c7bd='PAID';break;case _0x84d077(0x1bc):case _0x84d077(0x1e4):case'error':_0x58c7bd=_0x84d077(0x1b8);break;case _0x84d077(0x169):case'timeout':_0x58c7bd=_0x84d077(0x176);break;case _0x84d077(0x1c8):case _0x84d077(0x167):case _0x84d077(0x18a):case _0x84d077(0x1ad):default:_0x58c7bd='PENDING';break;}let _0x15d88d,_0xe4af2e;if(_0x92ec20[_0x84d077(0x199)][_0x84d077(0x1e1)]){const _0x55323b=_0x92ec20['data'][_0x84d077(0x1e1)];console['log'](_0x84d077(0x1dc),_0x55323b);const _0xb6ead8=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0xf3252a of _0xb6ead8){const _0x3cd913=_0x55323b[_0x84d077(0x190)](_0xf3252a);if(_0x3cd913){_0x15d88d=_0x3cd913[0x1],console[_0x84d077(0x194)](_0x84d077(0x1af),_0x15d88d,'using\x20pattern:',_0xf3252a['source']);break;}}if(!_0x15d88d){console[_0x84d077(0x194)](_0x84d077(0x1c0));const _0xd73428=_0x55323b[_0x84d077(0x190)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0xd73428&&(_0x15d88d=_0xd73428[0x1],console[_0x84d077(0x194)](_0x84d077(0x19e),_0x15d88d));}_0xe4af2e=_0x55323b;}const _0x29c7f8={'iban':_0x15d88d,'bankDetails':_0xe4af2e,'transactionId':_0x92ec20[_0x84d077(0x199)][_0x84d077(0x1c6)],'coinAddress':_0x92ec20[_0x84d077(0x199)][_0x84d077(0x1ab)],'qrCodeUrl':_0x92ec20['data'][_0x84d077(0x1a2)],'expiryTime':_0x92ec20['data'][_0x84d077(0x15e)],'createdOn':_0x92ec20[_0x84d077(0x199)][_0x84d077(0x19f)],'confirmedOn':_0x92ec20[_0x84d077(0x199)]['TransactionConfirmedOn']};console['log'](_0x84d077(0x16b)),console[_0x84d077(0x194)](_0x84d077(0x17c),_0x92ec20[_0x84d077(0x199)][_0x84d077(0x1bb)],'->',_0x58c7bd),console['log'](_0x84d077(0x15c),_0x92ec20['data'][_0x84d077(0x1d8)],_0x92ec20[_0x84d077(0x199)]['inputCurrency']),console['log']('Transaction\x20ID:',_0x92ec20['data'][_0x84d077(0x1c6)]),console[_0x84d077(0x194)](_0x84d077(0x1db),_0x15d88d||'not\x20found'),console[_0x84d077(0x194)](_0x84d077(0x18c),_0x92ec20[_0x84d077(0x199)]['CreatedOn']),console[_0x84d077(0x194)](_0x84d077(0x1b9),_0x92ec20['data'][_0x84d077(0x1ac)]||_0x84d077(0x1ca));if(_0x92ec20['data'][_0x84d077(0x1bb)]?.[_0x84d077(0x17e)]()===_0x84d077(0x167))console[_0x84d077(0x194)](_0x84d077(0x165));else _0x92ec20[_0x84d077(0x199)]['Status']?.[_0x84d077(0x17e)]()===_0x84d077(0x17f)&&console[_0x84d077(0x194)](_0x84d077(0x1d4));return{'status':_0x58c7bd,'amount':parseFloat(_0x92ec20[_0x84d077(0x199)][_0x84d077(0x1d8)])||undefined,'currency':_0x92ec20['data'][_0x84d077(0x1d0)]||_0x84d077(0x16f),'paymentDetails':_0x29c7f8};}catch(_0x3e6627){console[_0x84d077(0x187)](_0x84d077(0x16e),_0x3e6627),loggerService_1[_0x84d077(0x1de)][_0x84d077(0x16d)](_0x84d077(0x1ce),_0x84d077(0x1b3),_0x3e6627);throw new Error(_0x84d077(0x1ae)+(_0x3e6627 instanceof Error?_0x3e6627[_0x84d077(0x17b)]:_0x84d077(0x1bf)));}}async[a43_0xee2650(0x1a1)](_0x294ea4){const _0xe49760=a43_0xee2650,_0x95c0a5=await this['checkPaymentStatus'](_0x294ea4);return{'status':_0x95c0a5['status'],'amount':_0x95c0a5[_0xe49760(0x182)],'currency':_0x95c0a5[_0xe49760(0x1e3)]};}async[a43_0xee2650(0x16a)](_0x528aeb){const _0xdb719=a43_0xee2650;console[_0xdb719(0x194)](_0xdb719(0x1a3),_0x528aeb);let _0x50d59a=_0xdb719(0x1a5);switch(_0x528aeb['status']?.[_0xdb719(0x17e)]()){case _0xdb719(0x17f):_0x50d59a=_0xdb719(0x1b5);break;case _0xdb719(0x1bc):case _0xdb719(0x1e4):case _0xdb719(0x187):_0x50d59a=_0xdb719(0x1b8);break;case _0xdb719(0x169):case'timeout':_0x50d59a=_0xdb719(0x176);break;case'pending':case'waiting':case'awaiting\x20fiat':case'created':default:_0x50d59a=_0xdb719(0x1a5);break;}return{'paymentId':_0x528aeb[_0xdb719(0x1a0)]||_0x528aeb[_0xdb719(0x17d)]||'','status':_0x50d59a,'amount':_0x528aeb[_0xdb719(0x182)],'currency':_0x528aeb[_0xdb719(0x1e3)]||_0xdb719(0x16f)};}}exports[a43_0xee2650(0x181)]=CoinToPay2Service;