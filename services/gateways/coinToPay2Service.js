'use strict';function a43_0x2347(_0x7873c8,_0x43d02f){const _0x4008e3=a43_0x4008();return a43_0x2347=function(_0x234769,_0x319535){_0x234769=_0x234769-0x18c;let _0x1c87e1=_0x4008e3[_0x234769];return _0x1c87e1;},a43_0x2347(_0x7873c8,_0x43d02f);}function a43_0x4008(){const _0x1e6b06=['logWhiteDomainRequest','URL:','entries','Failed\x20to\x20parse\x20JSON\x20response:','ExpiryTime','Headers:','Amount','gateway_payment_id','inputCurrency','waiting','8495018uTdBgs','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','===\x20COINTOPAY2\x20API\x20ERROR\x20===','awaiting\x20fiat','failed','status','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','stack','2031114OKQEQz','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','match','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','created','Parsed\x20Result:','result','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','CoinToPay2\x20payment\x20status\x20check\x20error:','defineProperty','üìä\x20Status\x20check\x20URL:','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Response\x20Time:','cancelled','toLowerCase','data','Raw\x20Response\x20Body:','log','Currency:','logWhiteDomainError','üè¶\x20Payment\x20Detail:','Error\x20details:','Status\x20API\x20Error:\x20','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','4401912kHCQvn','headers','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','Missing\x20data\x20in\x20response','Status','Response\x20data:','amount','parse','message','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','POST','HTTP\x20Status:','statusText','Unknown\x20error','timeout','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','logWhiteDomainResponse','QRCodeURL','pending','text','CoinToPay2\x20status\x20API\x20error:\x20','status_code','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','stringify','4107884epHpYC','Unknown\x20error\x20from\x20CoinToPay2\x20API','/create','HTTP\x20error!\x20status:\x20','PaymentDetail','Confirmed\x20On:','Status\x20Text:','HTTP\x20','IBAN:','Gateway\x20Payment\x20ID:','now','PAID','Error\x20message:','EXPIRED','../loggerService','FAILED','PENDING','/status','TransactionID','35095QPdTns','Created\x20On:','application/json','processWebhook','JSON\x20Parse\x20Error:\x20','TransactionConfirmedOn','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','order_id','not\x20confirmed','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','Status:','Amount:','Response\x20Body:','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','101899HnYDVi','Error\x20stack:','expired','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','payment_url','CoinToPay2\x20API\x20error:\x20','cointopay2','fromEntries','apiUrl','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','coinAddress','statusUrl','currency',',\x20body:\x20','EUR','Request\x20Body:','checkPaymentStatus','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','CoinToPay2Service','12kszVxD','loggerService','verifyPayment','Error\x20Message:','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','merchant_reference_id','üè¶\x20Extracted\x20IBAN:','paid','https://traffer.uk/gateway/cointopay/status.php','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','using\x20pattern:','3654465gQakqI','error','CreatedOn','Incomplete\x20response:\x20missing\x20data'];a43_0x4008=function(){return _0x1e6b06;};return a43_0x4008();}const a43_0x380056=a43_0x2347;(function(_0x49805a,_0x4ba164){const _0x58698f=a43_0x2347,_0x5e9a6c=_0x49805a();while(!![]){try{const _0x147b17=parseInt(_0x58698f(0x1cd))/0x1+-parseInt(_0x58698f(0x205))/0x2+parseInt(_0x58698f(0x1ed))/0x3+parseInt(_0x58698f(0x1ac))/0x4+-parseInt(_0x58698f(0x1bf))/0x5*(-parseInt(_0x58698f(0x1e0))/0x6)+-parseInt(_0x58698f(0x1fb))/0x7+parseInt(_0x58698f(0x194))/0x8;if(_0x147b17===_0x4ba164)break;else _0x5e9a6c['push'](_0x5e9a6c['shift']());}catch(_0x369e6f){_0x5e9a6c['push'](_0x5e9a6c['shift']());}}}(a43_0x4008,0xa68bb));Object[a43_0x380056(0x20f)](exports,'__esModule',{'value':!![]}),exports[a43_0x380056(0x1df)]=void 0x0;const loggerService_1=require(a43_0x380056(0x1ba));class CoinToPay2Service{constructor(){const _0x3672b6=a43_0x380056;this[_0x3672b6(0x1d5)]='https://traffer.uk/gateway/cointopay/',this['statusUrl']=_0x3672b6(0x1ea),console[_0x3672b6(0x18d)](_0x3672b6(0x206)),console['log'](_0x3672b6(0x210),this[_0x3672b6(0x1d8)]);}async['createPaymentLink'](_0xaf37ae){const _0x290e02=a43_0x380056,{orderId:_0x3d799a,amount:_0x38dbcd}=_0xaf37ae;console[_0x290e02(0x18d)](_0x290e02(0x1a3)+_0x38dbcd+'\x20EUR');const _0x4a22c1={'amount':_0x38dbcd},_0x1e5831=Date[_0x290e02(0x1b6)]();try{console[_0x290e02(0x18d)]('===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20==='),console[_0x290e02(0x18d)](_0x290e02(0x1f2),this[_0x290e02(0x1d5)]),console[_0x290e02(0x18d)](_0x290e02(0x1dc),JSON[_0x290e02(0x1ab)](_0x4a22c1,null,0x2)),console['log']('Amount:',_0x38dbcd,_0x290e02(0x20d)),loggerService_1[_0x290e02(0x1e1)][_0x290e02(0x1f1)]('cointopay2',_0x290e02(0x1ae),_0x290e02(0x19e),_0x4a22c1);const _0x106a1a=await fetch(this[_0x290e02(0x1d5)],{'method':_0x290e02(0x19e),'headers':{'Content-Type':_0x290e02(0x1c1),'Accept':_0x290e02(0x1c1),'User-Agent':_0x290e02(0x1d0)},'body':JSON[_0x290e02(0x1ab)](_0x4a22c1)}),_0x26f8b1=Date[_0x290e02(0x1b6)]()-_0x1e5831;console[_0x290e02(0x18d)](_0x290e02(0x1cc)),console[_0x290e02(0x18d)](_0x290e02(0x1c9),_0x106a1a[_0x290e02(0x200)]),console[_0x290e02(0x18d)](_0x290e02(0x1b2),_0x106a1a[_0x290e02(0x1a0)]),console[_0x290e02(0x18d)](_0x290e02(0x1f6),Object[_0x290e02(0x1d4)](_0x106a1a[_0x290e02(0x195)][_0x290e02(0x1f3)]())),console[_0x290e02(0x18d)](_0x290e02(0x212),_0x26f8b1+'ms');const _0x2fe46c=await _0x106a1a[_0x290e02(0x1a7)]();console[_0x290e02(0x18d)](_0x290e02(0x18c),_0x2fe46c);if(!_0x106a1a['ok']){console[_0x290e02(0x1ee)](_0x290e02(0x1fd)),console[_0x290e02(0x1ee)]('HTTP\x20Status:',_0x106a1a[_0x290e02(0x200)]),console['error'](_0x290e02(0x1cb),_0x2fe46c),loggerService_1[_0x290e02(0x1e1)][_0x290e02(0x1a4)]('cointopay2',_0x290e02(0x1ae),_0x106a1a[_0x290e02(0x200)],_0x2fe46c,_0x26f8b1),loggerService_1['loggerService'][_0x290e02(0x18f)](_0x290e02(0x1d3),'/create','HTTP\x20'+_0x106a1a[_0x290e02(0x200)]+':\x20'+_0x2fe46c);throw new Error(_0x290e02(0x1af)+_0x106a1a[_0x290e02(0x200)]+_0x290e02(0x1da)+_0x2fe46c);}let _0x12d035;try{_0x12d035=JSON[_0x290e02(0x19b)](_0x2fe46c);}catch(_0x548324){console[_0x290e02(0x1ee)](_0x290e02(0x1f4),_0x548324),loggerService_1['loggerService'][_0x290e02(0x18f)]('cointopay2',_0x290e02(0x1ae),_0x290e02(0x1c3)+_0x548324);throw new Error(_0x290e02(0x203)+_0x2fe46c);}console[_0x290e02(0x18d)]('===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20==='),console[_0x290e02(0x18d)](_0x290e02(0x20b),JSON['stringify'](_0x12d035,null,0x2)),loggerService_1['loggerService'][_0x290e02(0x1a4)](_0x290e02(0x1d3),_0x290e02(0x1ae),_0x106a1a[_0x290e02(0x200)],_0x12d035,_0x26f8b1);if(_0x12d035[_0x290e02(0x1ee)]){const _0x1731e2=_0x12d035[_0x290e02(0x19c)]||_0x12d035[_0x290e02(0x1ee)]||_0x290e02(0x1ad);console['error']('===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x290e02(0x1ee)](_0x290e02(0x1e3),_0x1731e2),loggerService_1[_0x290e02(0x1e1)][_0x290e02(0x18f)](_0x290e02(0x1d3),'/create','Business\x20Error:\x20'+_0x1731e2);throw new Error(_0x290e02(0x1d2)+_0x1731e2);}if(!_0x12d035[_0x290e02(0x1d1)]||!_0x12d035['gateway_payment_id']){console[_0x290e02(0x1ee)](_0x290e02(0x209)),console[_0x290e02(0x1ee)]('Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response'),console[_0x290e02(0x1ee)](_0x290e02(0x199),_0x12d035),loggerService_1[_0x290e02(0x1e1)][_0x290e02(0x18f)](_0x290e02(0x1d3),'/create','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error(_0x290e02(0x1c5));}return console['log']('===\x20COINTOPAY2\x20SUCCESS\x20==='),console[_0x290e02(0x18d)](_0x290e02(0x1b5),_0x12d035[_0x290e02(0x1f8)]),console['log']('Payment\x20URL:',_0x12d035['payment_url']),console[_0x290e02(0x18d)](_0x290e02(0x1ca),_0x38dbcd,'EUR'),{'gateway_payment_id':_0x12d035[_0x290e02(0x1f8)],'payment_url':_0x12d035[_0x290e02(0x1d1)]};}catch(_0x170117){console[_0x290e02(0x1ee)](_0x290e02(0x1fc)),console[_0x290e02(0x1ee)](_0x290e02(0x191),_0x170117),loggerService_1[_0x290e02(0x1e1)][_0x290e02(0x18f)]('cointopay2',_0x290e02(0x1ae),_0x170117);if(_0x170117 instanceof Error){console[_0x290e02(0x1ee)](_0x290e02(0x1b8),_0x170117[_0x290e02(0x19c)]),console[_0x290e02(0x1ee)](_0x290e02(0x1ce),_0x170117[_0x290e02(0x204)]);throw new Error(_0x290e02(0x1c8)+_0x170117[_0x290e02(0x19c)]);}throw new Error(_0x290e02(0x1e6));}}async[a43_0x380056(0x1dd)](_0x142820){const _0x5b2435=a43_0x380056,_0x2548e7=Date['now']();try{console['log'](_0x5b2435(0x1e5)+_0x142820);const _0x5c20e1={'gatewayPaymentId':_0x142820};loggerService_1['loggerService'][_0x5b2435(0x1f1)](_0x5b2435(0x1d3),_0x5b2435(0x1bd),_0x5b2435(0x19e),_0x5c20e1);const _0x2c40ff=await fetch(this[_0x5b2435(0x1d8)],{'method':_0x5b2435(0x19e),'headers':{'Content-Type':'application/json','Accept':_0x5b2435(0x1c1),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON[_0x5b2435(0x1ab)](_0x5c20e1)}),_0x5a08a8=Date[_0x5b2435(0x1b6)]()-_0x2548e7;console[_0x5b2435(0x18d)](_0x5b2435(0x1aa)),console['log'](_0x5b2435(0x1c9),_0x2c40ff['status']),console[_0x5b2435(0x18d)](_0x5b2435(0x212),_0x5a08a8+'ms');if(!_0x2c40ff['ok']){const _0x41eae7=await _0x2c40ff['text']();console[_0x5b2435(0x1ee)](_0x5b2435(0x19f),_0x2c40ff[_0x5b2435(0x200)]),console[_0x5b2435(0x1ee)](_0x5b2435(0x1cb),_0x41eae7),loggerService_1[_0x5b2435(0x1e1)][_0x5b2435(0x1a4)](_0x5b2435(0x1d3),_0x5b2435(0x1bd),_0x2c40ff[_0x5b2435(0x200)],_0x41eae7,_0x5a08a8),loggerService_1['loggerService']['logWhiteDomainError'](_0x5b2435(0x1d3),_0x5b2435(0x1bd),_0x5b2435(0x1b3)+_0x2c40ff['status']+':\x20'+_0x41eae7);throw new Error(_0x5b2435(0x1af)+_0x2c40ff[_0x5b2435(0x200)]);}const _0x13d047=await _0x2c40ff[_0x5b2435(0x1a7)]();console[_0x5b2435(0x18d)]('Raw\x20Response\x20Body:',_0x13d047);let _0x34e9be;try{_0x34e9be=JSON['parse'](_0x13d047);}catch(_0x38ec47){console[_0x5b2435(0x1ee)](_0x5b2435(0x1f4),_0x38ec47),loggerService_1[_0x5b2435(0x1e1)]['logWhiteDomainError'](_0x5b2435(0x1d3),_0x5b2435(0x1bd),_0x5b2435(0x1c3)+_0x38ec47);throw new Error(_0x5b2435(0x196)+_0x13d047);}loggerService_1[_0x5b2435(0x1e1)][_0x5b2435(0x1a4)](_0x5b2435(0x1d3),_0x5b2435(0x1bd),_0x2c40ff['status'],_0x34e9be,_0x5a08a8),console[_0x5b2435(0x18d)](_0x5b2435(0x1d6)),console[_0x5b2435(0x18d)]('Result:',_0x34e9be[_0x5b2435(0x20c)]),console[_0x5b2435(0x18d)]('Status\x20Code:',_0x34e9be[_0x5b2435(0x1a9)]),console[_0x5b2435(0x18d)]('Payment\x20Status:',_0x34e9be[_0x5b2435(0x215)]?.['Status']),console[_0x5b2435(0x18d)]('Amount:',_0x34e9be[_0x5b2435(0x215)]?.['Amount']),console['log'](_0x5b2435(0x18e),_0x34e9be[_0x5b2435(0x215)]?.[_0x5b2435(0x1f9)]);if(_0x34e9be[_0x5b2435(0x20c)]!=='success'||_0x34e9be[_0x5b2435(0x1a9)]!==0xc8){const _0x116e11=_0x34e9be[_0x5b2435(0x19c)]||_0x5b2435(0x19d);console[_0x5b2435(0x1ee)](_0x5b2435(0x1de)),console[_0x5b2435(0x1ee)]('Error\x20Message:',_0x116e11),loggerService_1['loggerService'][_0x5b2435(0x18f)](_0x5b2435(0x1d3),_0x5b2435(0x1bd),_0x5b2435(0x192)+_0x116e11);throw new Error(_0x5b2435(0x1a8)+_0x116e11);}if(!_0x34e9be[_0x5b2435(0x215)]){console[_0x5b2435(0x1ee)](_0x5b2435(0x211)),console['error'](_0x5b2435(0x197)),loggerService_1[_0x5b2435(0x1e1)][_0x5b2435(0x18f)]('cointopay2',_0x5b2435(0x1bd),_0x5b2435(0x1f0));throw new Error(_0x5b2435(0x202));}let _0x51f487=_0x5b2435(0x1bc);switch(_0x34e9be[_0x5b2435(0x215)][_0x5b2435(0x198)]?.['toLowerCase']()){case _0x5b2435(0x1e9):_0x51f487=_0x5b2435(0x1b7);break;case _0x5b2435(0x213):case _0x5b2435(0x1ff):case _0x5b2435(0x1ee):_0x51f487='FAILED';break;case _0x5b2435(0x1cf):case _0x5b2435(0x1a2):_0x51f487=_0x5b2435(0x1b9);break;case _0x5b2435(0x1fa):case _0x5b2435(0x1fe):case _0x5b2435(0x1a6):case _0x5b2435(0x20a):default:_0x51f487='PENDING';break;}let _0x5e744d,_0x173531;if(_0x34e9be['data'][_0x5b2435(0x1b0)]){const _0x1328d2=_0x34e9be[_0x5b2435(0x215)][_0x5b2435(0x1b0)];console[_0x5b2435(0x18d)](_0x5b2435(0x190),_0x1328d2);const _0x23fee6=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x5ee991 of _0x23fee6){const _0x24e891=_0x1328d2['match'](_0x5ee991);if(_0x24e891){_0x5e744d=_0x24e891[0x1],console['log'](_0x5b2435(0x1e8),_0x5e744d,_0x5b2435(0x1ec),_0x5ee991['source']);break;}}if(!_0x5e744d){console['log'](_0x5b2435(0x193));const _0x6207c3=_0x1328d2[_0x5b2435(0x207)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x6207c3&&(_0x5e744d=_0x6207c3[0x1],console[_0x5b2435(0x18d)]('üè¶\x20Extracted\x20IBAN\x20via\x20fallback:',_0x5e744d));}_0x173531=_0x1328d2;}const _0x584f5a={'iban':_0x5e744d,'bankDetails':_0x173531,'transactionId':_0x34e9be[_0x5b2435(0x215)]['TransactionID'],'coinAddress':_0x34e9be[_0x5b2435(0x215)][_0x5b2435(0x1d7)],'qrCodeUrl':_0x34e9be['data'][_0x5b2435(0x1a5)],'expiryTime':_0x34e9be[_0x5b2435(0x215)][_0x5b2435(0x1f5)],'createdOn':_0x34e9be[_0x5b2435(0x215)][_0x5b2435(0x1ef)],'confirmedOn':_0x34e9be['data']['TransactionConfirmedOn']};console[_0x5b2435(0x18d)](_0x5b2435(0x201)),console['log'](_0x5b2435(0x1c9),_0x34e9be[_0x5b2435(0x215)]['Status'],'->',_0x51f487),console['log'](_0x5b2435(0x1ca),_0x34e9be[_0x5b2435(0x215)][_0x5b2435(0x1f7)],_0x34e9be['data'][_0x5b2435(0x1f9)]),console[_0x5b2435(0x18d)]('Transaction\x20ID:',_0x34e9be[_0x5b2435(0x215)][_0x5b2435(0x1be)]),console['log'](_0x5b2435(0x1b4),_0x5e744d||'not\x20found'),console[_0x5b2435(0x18d)](_0x5b2435(0x1c0),_0x34e9be['data']['CreatedOn']),console['log'](_0x5b2435(0x1b1),_0x34e9be[_0x5b2435(0x215)][_0x5b2435(0x1c4)]||_0x5b2435(0x1c7));if(_0x34e9be[_0x5b2435(0x215)][_0x5b2435(0x198)]?.[_0x5b2435(0x214)]()===_0x5b2435(0x1fe))console['log'](_0x5b2435(0x1e4));else _0x34e9be[_0x5b2435(0x215)][_0x5b2435(0x198)]?.[_0x5b2435(0x214)]()===_0x5b2435(0x1e9)&&console[_0x5b2435(0x18d)](_0x5b2435(0x1eb));return{'status':_0x51f487,'amount':parseFloat(_0x34e9be[_0x5b2435(0x215)][_0x5b2435(0x1f7)])||undefined,'currency':_0x34e9be[_0x5b2435(0x215)][_0x5b2435(0x1f9)]||'EUR','paymentDetails':_0x584f5a};}catch(_0x587776){console['error'](_0x5b2435(0x20e),_0x587776),loggerService_1[_0x5b2435(0x1e1)][_0x5b2435(0x18f)](_0x5b2435(0x1d3),'/status',_0x587776);throw new Error(_0x5b2435(0x208)+(_0x587776 instanceof Error?_0x587776[_0x5b2435(0x19c)]:_0x5b2435(0x1a1)));}}async[a43_0x380056(0x1e2)](_0x2dfcaf){const _0x4653c7=a43_0x380056,_0xb2b5c8=await this[_0x4653c7(0x1dd)](_0x2dfcaf);return{'status':_0xb2b5c8[_0x4653c7(0x200)],'amount':_0xb2b5c8[_0x4653c7(0x19a)],'currency':_0xb2b5c8[_0x4653c7(0x1d9)]};}async[a43_0x380056(0x1c2)](_0xffc86){const _0x106692=a43_0x380056;console[_0x106692(0x18d)]('Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0xffc86);let _0x202d11=_0x106692(0x1bc);switch(_0xffc86['status']?.[_0x106692(0x214)]()){case _0x106692(0x1e9):_0x202d11=_0x106692(0x1b7);break;case'cancelled':case _0x106692(0x1ff):case _0x106692(0x1ee):_0x202d11=_0x106692(0x1bb);break;case'expired':case _0x106692(0x1a2):_0x202d11=_0x106692(0x1b9);break;case _0x106692(0x1a6):case _0x106692(0x1fa):case _0x106692(0x1fe):case _0x106692(0x20a):default:_0x202d11=_0x106692(0x1bc);break;}return{'paymentId':_0xffc86[_0x106692(0x1c6)]||_0xffc86[_0x106692(0x1e7)]||'','status':_0x202d11,'amount':_0xffc86['amount'],'currency':_0xffc86['currency']||_0x106692(0x1db)};}}exports[a43_0x380056(0x1df)]=CoinToPay2Service;