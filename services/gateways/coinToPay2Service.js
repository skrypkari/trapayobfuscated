'use strict';const a40_0x53fbc4=a40_0x4b81;function a40_0x2e53(){const _0x29575c=['https://traffer.uk/gateway/cointopay/','Status\x20Code:','5GUwfGd','Confirmed\x20On:','HTTP\x20Status:','text','30054960crQlEY','message','Response\x20Body:','762pywZBL','waiting','processWebhook','2645094YLxtDb','Failed\x20to\x20parse\x20JSON\x20response:','üè¶\x20Extracted\x20IBAN:','Request\x20Body:','ExpiryTime','IBAN:','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','statusUrl','awaiting\x20fiat','8161587aLDvqb','Currency:','Error\x20message:','\x20EUR','/create','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','PAID','Created\x20On:','loggerService','QRCodeURL','2549056pWKhQK','logWhiteDomainResponse','__esModule','URL:','logWhiteDomainError','status_code','Payment\x20URL:','coinAddress','Response\x20Time:','EUR','amount','now','/status','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','Status\x20API\x20Error:\x20','toLowerCase','expired','Raw\x20Response\x20Body:','2210854buBPHb','CoinToPay2\x20payment\x20status\x20check\x20error:','currency','defineProperty','FAILED','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','not\x20confirmed','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','result','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','headers','Amount:','JSON\x20Parse\x20Error:\x20','log','payment_url','Incomplete\x20response:\x20missing\x20data','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','CoinToPay2\x20status\x20API\x20error:\x20','Status\x20Text:','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','HTTP\x20error!\x20status:\x20','Transaction\x20ID:','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','Business\x20Error:\x20','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','statusText','application/json','parse','apiUrl','match','Result:','273883lnWaah','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','Status','inputCurrency','verifyPayment','success','Status:','gateway_payment_id','Response\x20data:','failed','merchant_reference_id','https://traffer.uk/gateway/cointopay/status.php','HTTP\x20','timeout','CreatedOn','Amount','logWhiteDomainRequest','stringify','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','status','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','4664mryXai','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','TransactionID','data',',\x20body:\x20','PaymentDetail','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','entries','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','===\x20COINTOPAY2\x20SUCCESS\x20===','EXPIRED','üè¶\x20Payment\x20Detail:','CoinToPay2\x20API\x20error:\x20','Error\x20stack:','not\x20found','TransactionConfirmedOn','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','Missing\x20data\x20in\x20response','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','Error\x20Message:','Unknown\x20error','cancelled','PENDING','POST','Unknown\x20error\x20from\x20CoinToPay2\x20API','error','paid','CoinToPay2Service','cointopay2'];a40_0x2e53=function(){return _0x29575c;};return a40_0x2e53();}function a40_0x4b81(_0x8e0bc3,_0x13e542){const _0x2e5380=a40_0x2e53();return a40_0x4b81=function(_0x4b812d,_0x3197fd){_0x4b812d=_0x4b812d-0x115;let _0x13b609=_0x2e5380[_0x4b812d];return _0x13b609;},a40_0x4b81(_0x8e0bc3,_0x13e542);}(function(_0x45b7ee,_0x2a5dfb){const _0x599164=a40_0x4b81,_0x25bcf8=_0x45b7ee();while(!![]){try{const _0x868b20=parseInt(_0x599164(0x189))/0x1+-parseInt(_0x599164(0x16a))/0x2+-parseInt(_0x599164(0x141))/0x3*(-parseInt(_0x599164(0x11b))/0x4)+-parseInt(_0x599164(0x13a))/0x5*(parseInt(_0x599164(0x144))/0x6)+-parseInt(_0x599164(0x14d))/0x7+-parseInt(_0x599164(0x157))/0x8+parseInt(_0x599164(0x13e))/0x9;if(_0x868b20===_0x2a5dfb)break;else _0x25bcf8['push'](_0x25bcf8['shift']());}catch(_0x50e84b){_0x25bcf8['push'](_0x25bcf8['shift']());}}}(a40_0x2e53,0xd682e));Object[a40_0x53fbc4(0x16d)](exports,a40_0x53fbc4(0x159),{'value':!![]}),exports[a40_0x53fbc4(0x136)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x3143ac=a40_0x53fbc4;this[_0x3143ac(0x186)]=_0x3143ac(0x138),this[_0x3143ac(0x14b)]=_0x3143ac(0x194),console[_0x3143ac(0x177)](_0x3143ac(0x121)),console[_0x3143ac(0x177)]('üìä\x20Status\x20check\x20URL:',this[_0x3143ac(0x14b)]);}async['createPaymentLink'](_0x1760b4){const _0x5c5ada=a40_0x53fbc4,{orderId:_0x326b25,amount:_0x13b8a5}=_0x1760b4;console['log']('ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20'+_0x13b8a5+_0x5c5ada(0x150));const _0x29dcb5={'amount':_0x13b8a5},_0x106daa=Date[_0x5c5ada(0x162)]();try{console[_0x5c5ada(0x177)]('===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20==='),console['log'](_0x5c5ada(0x15a),this[_0x5c5ada(0x186)]),console[_0x5c5ada(0x177)](_0x5c5ada(0x147),JSON[_0x5c5ada(0x117)](_0x29dcb5,null,0x2)),console[_0x5c5ada(0x177)]('Amount:',_0x13b8a5,_0x5c5ada(0x11a)),loggerService_1[_0x5c5ada(0x155)]['logWhiteDomainRequest'](_0x5c5ada(0x137),_0x5c5ada(0x151),_0x5c5ada(0x132),_0x29dcb5);const _0x5573c6=await fetch(this[_0x5c5ada(0x186)],{'method':_0x5c5ada(0x132),'headers':{'Content-Type':'application/json','Accept':'application/json','User-Agent':_0x5c5ada(0x12b)},'body':JSON['stringify'](_0x29dcb5)}),_0x580d4c=Date[_0x5c5ada(0x162)]()-_0x106daa;console[_0x5c5ada(0x177)]('===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20==='),console[_0x5c5ada(0x177)](_0x5c5ada(0x18f),_0x5573c6[_0x5c5ada(0x119)]),console['log'](_0x5c5ada(0x17c),_0x5573c6[_0x5c5ada(0x183)]),console[_0x5c5ada(0x177)]('Headers:',Object['fromEntries'](_0x5573c6[_0x5c5ada(0x174)][_0x5c5ada(0x122)]())),console[_0x5c5ada(0x177)](_0x5c5ada(0x15f),_0x580d4c+'ms');const _0x3491df=await _0x5573c6['text']();console[_0x5c5ada(0x177)](_0x5c5ada(0x169),_0x3491df);if(!_0x5573c6['ok']){console[_0x5c5ada(0x134)]('===\x20COINTOPAY2\x20API\x20ERROR\x20==='),console[_0x5c5ada(0x134)](_0x5c5ada(0x13c),_0x5573c6['status']),console['error'](_0x5c5ada(0x140),_0x3491df),loggerService_1['loggerService'][_0x5c5ada(0x158)](_0x5c5ada(0x137),'/create',_0x5573c6[_0x5c5ada(0x119)],_0x3491df,_0x580d4c),loggerService_1[_0x5c5ada(0x155)][_0x5c5ada(0x15b)](_0x5c5ada(0x137),_0x5c5ada(0x151),_0x5c5ada(0x195)+_0x5573c6[_0x5c5ada(0x119)]+':\x20'+_0x3491df);throw new Error(_0x5c5ada(0x17e)+_0x5573c6[_0x5c5ada(0x119)]+_0x5c5ada(0x11f)+_0x3491df);}let _0x3b1087;try{_0x3b1087=JSON[_0x5c5ada(0x185)](_0x3491df);}catch(_0x3a6131){console['error'](_0x5c5ada(0x145),_0x3a6131),loggerService_1[_0x5c5ada(0x155)][_0x5c5ada(0x15b)](_0x5c5ada(0x137),_0x5c5ada(0x151),_0x5c5ada(0x176)+_0x3a6131);throw new Error(_0x5c5ada(0x17a)+_0x3491df);}console[_0x5c5ada(0x177)]('===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20==='),console[_0x5c5ada(0x177)]('Parsed\x20Result:',JSON['stringify'](_0x3b1087,null,0x2)),loggerService_1[_0x5c5ada(0x155)]['logWhiteDomainResponse'](_0x5c5ada(0x137),_0x5c5ada(0x151),_0x5573c6[_0x5c5ada(0x119)],_0x3b1087,_0x580d4c);if(_0x3b1087[_0x5c5ada(0x134)]){const _0x1c13da=_0x3b1087[_0x5c5ada(0x13f)]||_0x3b1087['error']||_0x5c5ada(0x133);console[_0x5c5ada(0x134)](_0x5c5ada(0x14a)),console[_0x5c5ada(0x134)](_0x5c5ada(0x12e),_0x1c13da),loggerService_1[_0x5c5ada(0x155)][_0x5c5ada(0x15b)](_0x5c5ada(0x137),_0x5c5ada(0x151),_0x5c5ada(0x181)+_0x1c13da);throw new Error(_0x5c5ada(0x127)+_0x1c13da);}if(!_0x3b1087[_0x5c5ada(0x178)]||!_0x3b1087['gateway_payment_id']){console[_0x5c5ada(0x134)]('===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x5c5ada(0x134)](_0x5c5ada(0x17d)),console[_0x5c5ada(0x134)](_0x5c5ada(0x191),_0x3b1087),loggerService_1[_0x5c5ada(0x155)][_0x5c5ada(0x15b)](_0x5c5ada(0x137),'/create',_0x5c5ada(0x123));throw new Error(_0x5c5ada(0x165));}return console[_0x5c5ada(0x177)](_0x5c5ada(0x124)),console[_0x5c5ada(0x177)]('Gateway\x20Payment\x20ID:',_0x3b1087[_0x5c5ada(0x190)]),console[_0x5c5ada(0x177)](_0x5c5ada(0x15d),_0x3b1087[_0x5c5ada(0x178)]),console[_0x5c5ada(0x177)](_0x5c5ada(0x175),_0x13b8a5,_0x5c5ada(0x160)),{'gateway_payment_id':_0x3b1087['gateway_payment_id'],'payment_url':_0x3b1087[_0x5c5ada(0x178)]};}catch(_0x158aae){console['error'](_0x5c5ada(0x182)),console[_0x5c5ada(0x134)]('Error\x20details:',_0x158aae),loggerService_1[_0x5c5ada(0x155)][_0x5c5ada(0x15b)](_0x5c5ada(0x137),_0x5c5ada(0x151),_0x158aae);if(_0x158aae instanceof Error){console[_0x5c5ada(0x134)](_0x5c5ada(0x14f),_0x158aae['message']),console[_0x5c5ada(0x134)](_0x5c5ada(0x128),_0x158aae['stack']);throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20'+_0x158aae['message']);}throw new Error(_0x5c5ada(0x16f));}}async['checkPaymentStatus'](_0x3353f9){const _0x48c9b5=a40_0x53fbc4,_0x53b150=Date[_0x48c9b5(0x162)]();try{console[_0x48c9b5(0x177)](_0x48c9b5(0x18a)+_0x3353f9);const _0x258bf0={'gatewayPaymentId':_0x3353f9};loggerService_1[_0x48c9b5(0x155)][_0x48c9b5(0x116)](_0x48c9b5(0x137),'/status',_0x48c9b5(0x132),_0x258bf0);const _0x526451=await fetch(this[_0x48c9b5(0x14b)],{'method':_0x48c9b5(0x132),'headers':{'Content-Type':_0x48c9b5(0x184),'Accept':_0x48c9b5(0x184),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON['stringify'](_0x258bf0)}),_0x5ec4a0=Date['now']()-_0x53b150;console[_0x48c9b5(0x177)](_0x48c9b5(0x12d)),console[_0x48c9b5(0x177)](_0x48c9b5(0x18f),_0x526451[_0x48c9b5(0x119)]),console[_0x48c9b5(0x177)]('Response\x20Time:',_0x5ec4a0+'ms');if(!_0x526451['ok']){const _0x27a29a=await _0x526451[_0x48c9b5(0x13d)]();console['error'](_0x48c9b5(0x13c),_0x526451['status']),console[_0x48c9b5(0x134)](_0x48c9b5(0x140),_0x27a29a),loggerService_1[_0x48c9b5(0x155)][_0x48c9b5(0x158)](_0x48c9b5(0x137),_0x48c9b5(0x163),_0x526451[_0x48c9b5(0x119)],_0x27a29a,_0x5ec4a0),loggerService_1['loggerService'][_0x48c9b5(0x15b)](_0x48c9b5(0x137),_0x48c9b5(0x163),'HTTP\x20'+_0x526451['status']+':\x20'+_0x27a29a);throw new Error(_0x48c9b5(0x17e)+_0x526451[_0x48c9b5(0x119)]);}const _0x208367=await _0x526451[_0x48c9b5(0x13d)]();console[_0x48c9b5(0x177)](_0x48c9b5(0x169),_0x208367);let _0x5bfbf7;try{_0x5bfbf7=JSON[_0x48c9b5(0x185)](_0x208367);}catch(_0x3bf95d){console[_0x48c9b5(0x134)](_0x48c9b5(0x145),_0x3bf95d),loggerService_1[_0x48c9b5(0x155)][_0x48c9b5(0x15b)]('cointopay2',_0x48c9b5(0x163),_0x48c9b5(0x176)+_0x3bf95d);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20'+_0x208367);}loggerService_1[_0x48c9b5(0x155)]['logWhiteDomainResponse']('cointopay2',_0x48c9b5(0x163),_0x526451['status'],_0x5bfbf7,_0x5ec4a0),console[_0x48c9b5(0x177)](_0x48c9b5(0x173)),console[_0x48c9b5(0x177)](_0x48c9b5(0x188),_0x5bfbf7[_0x48c9b5(0x172)]),console['log'](_0x48c9b5(0x139),_0x5bfbf7['status_code']),console[_0x48c9b5(0x177)]('Payment\x20Status:',_0x5bfbf7['data']?.[_0x48c9b5(0x18b)]),console[_0x48c9b5(0x177)]('Amount:',_0x5bfbf7[_0x48c9b5(0x11e)]?.[_0x48c9b5(0x115)]),console[_0x48c9b5(0x177)](_0x48c9b5(0x14e),_0x5bfbf7[_0x48c9b5(0x11e)]?.[_0x48c9b5(0x18c)]);if(_0x5bfbf7[_0x48c9b5(0x172)]!==_0x48c9b5(0x18e)||_0x5bfbf7[_0x48c9b5(0x15c)]!==0xc8){const _0x4d325f=_0x5bfbf7[_0x48c9b5(0x13f)]||_0x48c9b5(0x118);console['error']('===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20==='),console[_0x48c9b5(0x134)](_0x48c9b5(0x12e),_0x4d325f),loggerService_1[_0x48c9b5(0x155)]['logWhiteDomainError']('cointopay2','/status',_0x48c9b5(0x166)+_0x4d325f);throw new Error(_0x48c9b5(0x17b)+_0x4d325f);}if(!_0x5bfbf7[_0x48c9b5(0x11e)]){console['error'](_0x48c9b5(0x164)),console[_0x48c9b5(0x134)](_0x48c9b5(0x12c)),loggerService_1['loggerService'][_0x48c9b5(0x15b)]('cointopay2',_0x48c9b5(0x163),_0x48c9b5(0x179));throw new Error(_0x48c9b5(0x152));}let _0x1937ba=_0x48c9b5(0x131);switch(_0x5bfbf7['data'][_0x48c9b5(0x18b)]?.[_0x48c9b5(0x167)]()){case _0x48c9b5(0x135):_0x1937ba=_0x48c9b5(0x153);break;case _0x48c9b5(0x130):case _0x48c9b5(0x192):case _0x48c9b5(0x134):_0x1937ba='FAILED';break;case _0x48c9b5(0x168):case _0x48c9b5(0x196):_0x1937ba='EXPIRED';break;case _0x48c9b5(0x142):case'awaiting\x20fiat':case'pending':case'created':default:_0x1937ba=_0x48c9b5(0x131);break;}let _0x3f82cf,_0x160cc2;if(_0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x120)]){const _0x3ef258=_0x5bfbf7['data'][_0x48c9b5(0x120)];console[_0x48c9b5(0x177)](_0x48c9b5(0x126),_0x3ef258);const _0x465a6c=_0x3ef258[_0x48c9b5(0x187)](/IBAN\s+([A-Z0-9]+)/i);_0x465a6c&&(_0x3f82cf=_0x465a6c[0x1],console[_0x48c9b5(0x177)](_0x48c9b5(0x146),_0x3f82cf)),_0x160cc2=_0x3ef258;}const _0x22a8e9={'iban':_0x3f82cf,'bankDetails':_0x160cc2,'transactionId':_0x5bfbf7['data'][_0x48c9b5(0x11d)],'coinAddress':_0x5bfbf7['data'][_0x48c9b5(0x15e)],'qrCodeUrl':_0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x156)],'expiryTime':_0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x148)],'createdOn':_0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x197)],'confirmedOn':_0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x12a)]};console[_0x48c9b5(0x177)](_0x48c9b5(0x11c)),console[_0x48c9b5(0x177)](_0x48c9b5(0x18f),_0x5bfbf7['data'][_0x48c9b5(0x18b)],'->',_0x1937ba),console[_0x48c9b5(0x177)](_0x48c9b5(0x175),_0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x115)],_0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x18c)]),console[_0x48c9b5(0x177)](_0x48c9b5(0x17f),_0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x11d)]),console[_0x48c9b5(0x177)](_0x48c9b5(0x149),_0x3f82cf||_0x48c9b5(0x129)),console['log'](_0x48c9b5(0x154),_0x5bfbf7[_0x48c9b5(0x11e)]['CreatedOn']),console['log'](_0x48c9b5(0x13b),_0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x12a)]||_0x48c9b5(0x170));if(_0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x18b)]?.[_0x48c9b5(0x167)]()===_0x48c9b5(0x14c))console[_0x48c9b5(0x177)]('üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)');else _0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x18b)]?.[_0x48c9b5(0x167)]()===_0x48c9b5(0x135)&&console[_0x48c9b5(0x177)](_0x48c9b5(0x171));return{'status':_0x1937ba,'amount':parseFloat(_0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x115)])||undefined,'currency':_0x5bfbf7[_0x48c9b5(0x11e)][_0x48c9b5(0x18c)]||_0x48c9b5(0x160),'paymentDetails':_0x22a8e9};}catch(_0x43faaf){console[_0x48c9b5(0x134)](_0x48c9b5(0x16b),_0x43faaf),loggerService_1[_0x48c9b5(0x155)][_0x48c9b5(0x15b)](_0x48c9b5(0x137),'/status',_0x43faaf);throw new Error('Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20'+(_0x43faaf instanceof Error?_0x43faaf[_0x48c9b5(0x13f)]:_0x48c9b5(0x12f)));}}async[a40_0x53fbc4(0x18d)](_0x41b2e1){const _0x2bf9bc=a40_0x53fbc4,_0x197761=await this['checkPaymentStatus'](_0x41b2e1);return{'status':_0x197761[_0x2bf9bc(0x119)],'amount':_0x197761[_0x2bf9bc(0x161)],'currency':_0x197761[_0x2bf9bc(0x16c)]};}async[a40_0x53fbc4(0x143)](_0x6ce9bd){const _0x4dc3ce=a40_0x53fbc4;console[_0x4dc3ce(0x177)](_0x4dc3ce(0x180),_0x6ce9bd);let _0x4d3264=_0x4dc3ce(0x131);switch(_0x6ce9bd[_0x4dc3ce(0x119)]?.[_0x4dc3ce(0x167)]()){case _0x4dc3ce(0x135):_0x4d3264='PAID';break;case _0x4dc3ce(0x130):case _0x4dc3ce(0x192):case _0x4dc3ce(0x134):_0x4d3264=_0x4dc3ce(0x16e);break;case _0x4dc3ce(0x168):case _0x4dc3ce(0x196):_0x4d3264=_0x4dc3ce(0x125);break;case'pending':case'waiting':case _0x4dc3ce(0x14c):case'created':default:_0x4d3264=_0x4dc3ce(0x131);break;}return{'paymentId':_0x6ce9bd['order_id']||_0x6ce9bd[_0x4dc3ce(0x193)]||'','status':_0x4d3264,'amount':_0x6ce9bd['amount'],'currency':_0x6ce9bd[_0x4dc3ce(0x16c)]||_0x4dc3ce(0x160)};}}exports[a40_0x53fbc4(0x136)]=CoinToPay2Service;