'use strict';const a42_0xb116f6=a42_0x2b8c;(function(_0x564c28,_0x3dfaf0){const _0x219ce2=a42_0x2b8c,_0x3d180b=_0x564c28();while(!![]){try{const _0xed23d5=parseInt(_0x219ce2(0x12d))/0x1*(-parseInt(_0x219ce2(0x126))/0x2)+parseInt(_0x219ce2(0x101))/0x3+parseInt(_0x219ce2(0x12f))/0x4+parseInt(_0x219ce2(0x118))/0x5+parseInt(_0x219ce2(0x14d))/0x6+-parseInt(_0x219ce2(0x128))/0x7*(parseInt(_0x219ce2(0x142))/0x8)+parseInt(_0x219ce2(0xf9))/0x9*(-parseInt(_0x219ce2(0xda))/0xa);if(_0xed23d5===_0x3dfaf0)break;else _0x3d180b['push'](_0x3d180b['shift']());}catch(_0x4771cf){_0x3d180b['push'](_0x3d180b['shift']());}}}(a42_0x4a4a,0x9c3d5));Object[a42_0xb116f6(0x106)](exports,'__esModule',{'value':!![]}),exports[a42_0xb116f6(0x10f)]=void 0x0;const loggerService_1=require('../loggerService');function a42_0x2b8c(_0x41bd43,_0x42a6ec){const _0x4a4a2d=a42_0x4a4a();return a42_0x2b8c=function(_0x2b8c36,_0x5502b0){_0x2b8c36=_0x2b8c36-0xd4;let _0x49e3dd=_0x4a4a2d[_0x2b8c36];return _0x49e3dd;},a42_0x2b8c(_0x41bd43,_0x42a6ec);}function a42_0x4a4a(){const _0x3eaf55=['Raw\x20Response\x20Body:','PENDING','awaiting\x20fiat','2032020WIYKnC','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Business\x20Error:\x20','gateway_payment_id','Gateway\x20Payment\x20ID:','defineProperty','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','statusText','IBAN:','üè¶\x20Extracted\x20IBAN:','üè¶\x20Payment\x20Detail:','data','Incomplete\x20response:\x20missing\x20data','Status\x20Text:','CoinToPay2Service','cancelled','Error\x20details:','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','failed','Response\x20Body:','toLowerCase','result','success','1960630NZdGjI','log','Status','Parsed\x20Result:','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','source','match','stringify','Amount','statusUrl','order_id','message','expired','EUR','334EJMsER','Unknown\x20error','69244dGWbeC','parse','headers','Currency:','/create','6951bCXBww','now','2167904QUinIw','status_code','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','coinAddress','TransactionConfirmedOn','logWhiteDomainResponse','Error\x20message:','URL:','loggerService','Status\x20Code:','CoinToPay2\x20status\x20API\x20error:\x20','/status','currency','PaymentDetail','apiUrl','Error\x20stack:','EXPIRED','timeout','Unknown\x20error\x20from\x20CoinToPay2\x20API','608RFsuRn','not\x20confirmed','PAID','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','FAILED','paid','payment_url','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','POST','logWhiteDomainRequest','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','6233376tTwmUt','status','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Response\x20Time:','HTTP\x20','HTTP\x20Status:','HTTP\x20error!\x20status:\x20','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','checkPaymentStatus','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','inputCurrency','Transaction\x20ID:','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy',',\x20body:\x20','Status:','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','stack','Headers:','488860bwZYVV','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','üìä\x20Status\x20check\x20URL:','using\x20pattern:','error','Response\x20data:','Created\x20On:','Payment\x20URL:','text','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','TransactionID','https://traffer.uk/gateway/cointopay/','cointopay2','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','Amount:','Confirmed\x20On:','createPaymentLink','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','JSON\x20Parse\x20Error:\x20','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','\x20EUR','created','Missing\x20data\x20in\x20response','entries','Status\x20API\x20Error:\x20','Error\x20Message:','waiting','logWhiteDomainError','verifyPayment','CreatedOn','18zaKMKJ','Failed\x20to\x20parse\x20JSON\x20response:','merchant_reference_id','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','application/json'];a42_0x4a4a=function(){return _0x3eaf55;};return a42_0x4a4a();}class CoinToPay2Service{constructor(){const _0x1cd768=a42_0xb116f6;this[_0x1cd768(0x13d)]=_0x1cd768(0xe5),this[_0x1cd768(0x121)]='https://traffer.uk/gateway/cointopay/status.php',console[_0x1cd768(0x119)](_0x1cd768(0xd4)),console['log'](_0x1cd768(0xdc),this[_0x1cd768(0x121)]);}async[a42_0xb116f6(0xea)](_0x36c44e){const _0x200310=a42_0xb116f6,{orderId:_0x126c28,amount:_0x1e89e8}=_0x36c44e;console[_0x200310(0x119)](_0x200310(0x154)+_0x1e89e8+_0x200310(0xef));const _0x142aa={'amount':_0x1e89e8},_0x143c81=Date[_0x200310(0x12e)]();try{console[_0x200310(0x119)](_0x200310(0xe3)),console[_0x200310(0x119)](_0x200310(0x136),this['apiUrl']),console['log']('Request\x20Body:',JSON[_0x200310(0x11f)](_0x142aa,null,0x2)),console[_0x200310(0x119)](_0x200310(0xe8),_0x1e89e8,'EUR\x20(always\x20EUR\x20for\x20CoinToPay2)'),loggerService_1['loggerService'][_0x200310(0x14b)](_0x200310(0xe6),'/create',_0x200310(0x14a),_0x142aa);const _0x4fdd81=await fetch(this['apiUrl'],{'method':_0x200310(0x14a),'headers':{'Content-Type':_0x200310(0xfd),'Accept':'application/json','User-Agent':_0x200310(0x131)},'body':JSON['stringify'](_0x142aa)}),_0x42837e=Date[_0x200310(0x12e)]()-_0x143c81;console['log'](_0x200310(0xfc)),console[_0x200310(0x119)](_0x200310(0xd6),_0x4fdd81[_0x200310(0x14e)]),console[_0x200310(0x119)](_0x200310(0x10e),_0x4fdd81[_0x200310(0x108)]),console[_0x200310(0x119)](_0x200310(0xd9),Object['fromEntries'](_0x4fdd81[_0x200310(0x12a)][_0x200310(0xf2)]())),console[_0x200310(0x119)](_0x200310(0x150),_0x42837e+'ms');const _0x10999f=await _0x4fdd81[_0x200310(0xe2)]();console[_0x200310(0x119)](_0x200310(0xfe),_0x10999f);if(!_0x4fdd81['ok']){console[_0x200310(0xde)]('===\x20COINTOPAY2\x20API\x20ERROR\x20==='),console[_0x200310(0xde)](_0x200310(0x152),_0x4fdd81[_0x200310(0x14e)]),console[_0x200310(0xde)]('Response\x20Body:',_0x10999f),loggerService_1['loggerService'][_0x200310(0x134)](_0x200310(0xe6),'/create',_0x4fdd81['status'],_0x10999f,_0x42837e),loggerService_1[_0x200310(0x137)][_0x200310(0xf6)]('cointopay2',_0x200310(0x12c),_0x200310(0x151)+_0x4fdd81[_0x200310(0x14e)]+':\x20'+_0x10999f);throw new Error(_0x200310(0x153)+_0x4fdd81[_0x200310(0x14e)]+_0x200310(0xd5)+_0x10999f);}let _0x1e26e3;try{_0x1e26e3=JSON[_0x200310(0x129)](_0x10999f);}catch(_0x385a35){console[_0x200310(0xde)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x385a35),loggerService_1[_0x200310(0x137)][_0x200310(0xf6)](_0x200310(0xe6),_0x200310(0x12c),_0x200310(0xec)+_0x385a35);throw new Error(_0x200310(0x145)+_0x10999f);}console[_0x200310(0x119)](_0x200310(0x102)),console[_0x200310(0x119)](_0x200310(0x11b),JSON[_0x200310(0x11f)](_0x1e26e3,null,0x2)),loggerService_1[_0x200310(0x137)][_0x200310(0x134)](_0x200310(0xe6),_0x200310(0x12c),_0x4fdd81['status'],_0x1e26e3,_0x42837e);if(_0x1e26e3[_0x200310(0xde)]){const _0x5d8e6a=_0x1e26e3[_0x200310(0x123)]||_0x1e26e3[_0x200310(0xde)]||_0x200310(0x141);console[_0x200310(0xde)]('===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20==='),console['error']('Error\x20Message:',_0x5d8e6a),loggerService_1[_0x200310(0x137)][_0x200310(0xf6)](_0x200310(0xe6),_0x200310(0x12c),_0x200310(0x103)+_0x5d8e6a);throw new Error('CoinToPay2\x20API\x20error:\x20'+_0x5d8e6a);}if(!_0x1e26e3[_0x200310(0x148)]||!_0x1e26e3[_0x200310(0x104)]){console['error'](_0x200310(0x112)),console[_0x200310(0xde)](_0x200310(0xee)),console[_0x200310(0xde)](_0x200310(0xdf),_0x1e26e3),loggerService_1[_0x200310(0x137)][_0x200310(0xf6)](_0x200310(0xe6),_0x200310(0x12c),_0x200310(0x14c));throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id');}return console['log']('===\x20COINTOPAY2\x20SUCCESS\x20==='),console[_0x200310(0x119)](_0x200310(0x105),_0x1e26e3['gateway_payment_id']),console[_0x200310(0x119)](_0x200310(0xe1),_0x1e26e3[_0x200310(0x148)]),console[_0x200310(0x119)]('Amount:',_0x1e89e8,_0x200310(0x125)),{'gateway_payment_id':_0x1e26e3[_0x200310(0x104)],'payment_url':_0x1e26e3['payment_url']};}catch(_0xc30fd3){console[_0x200310(0xde)](_0x200310(0x155)),console['error'](_0x200310(0x111),_0xc30fd3),loggerService_1[_0x200310(0x137)][_0x200310(0xf6)](_0x200310(0xe6),_0x200310(0x12c),_0xc30fd3);if(_0xc30fd3 instanceof Error){console['error'](_0x200310(0x135),_0xc30fd3[_0x200310(0x123)]),console['error'](_0x200310(0x13e),_0xc30fd3[_0x200310(0xd8)]);throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20'+_0xc30fd3[_0x200310(0x123)]);}throw new Error(_0x200310(0x107));}}async[a42_0xb116f6(0x156)](_0x44a02b){const _0x340aea=a42_0xb116f6,_0x4a9185=Date[_0x340aea(0x12e)]();try{console[_0x340aea(0x119)](_0x340aea(0xed)+_0x44a02b);const _0x53cea7={'gatewayPaymentId':_0x44a02b};loggerService_1[_0x340aea(0x137)][_0x340aea(0x14b)]('cointopay2',_0x340aea(0x13a),_0x340aea(0x14a),_0x53cea7);const _0x494254=await fetch(this[_0x340aea(0x121)],{'method':_0x340aea(0x14a),'headers':{'Content-Type':_0x340aea(0xfd),'Accept':'application/json','User-Agent':_0x340aea(0x131)},'body':JSON['stringify'](_0x53cea7)}),_0x4cb06b=Date[_0x340aea(0x12e)]()-_0x4a9185;console[_0x340aea(0x119)]('===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20==='),console[_0x340aea(0x119)](_0x340aea(0xd6),_0x494254[_0x340aea(0x14e)]),console['log']('Response\x20Time:',_0x4cb06b+'ms');if(!_0x494254['ok']){const _0x8f878b=await _0x494254[_0x340aea(0xe2)]();console[_0x340aea(0xde)](_0x340aea(0x152),_0x494254[_0x340aea(0x14e)]),console['error'](_0x340aea(0x114),_0x8f878b),loggerService_1['loggerService'][_0x340aea(0x134)](_0x340aea(0xe6),'/status',_0x494254[_0x340aea(0x14e)],_0x8f878b,_0x4cb06b),loggerService_1[_0x340aea(0x137)][_0x340aea(0xf6)](_0x340aea(0xe6),'/status',_0x340aea(0x151)+_0x494254[_0x340aea(0x14e)]+':\x20'+_0x8f878b);throw new Error(_0x340aea(0x153)+_0x494254[_0x340aea(0x14e)]);}const _0x2200aa=await _0x494254[_0x340aea(0xe2)]();console[_0x340aea(0x119)](_0x340aea(0xfe),_0x2200aa);let _0x14b79c;try{_0x14b79c=JSON['parse'](_0x2200aa);}catch(_0x39883a){console['error'](_0x340aea(0xfa),_0x39883a),loggerService_1[_0x340aea(0x137)][_0x340aea(0xf6)](_0x340aea(0xe6),_0x340aea(0x13a),_0x340aea(0xec)+_0x39883a);throw new Error(_0x340aea(0xe7)+_0x2200aa);}loggerService_1['loggerService'][_0x340aea(0x134)](_0x340aea(0xe6),_0x340aea(0x13a),_0x494254[_0x340aea(0x14e)],_0x14b79c,_0x4cb06b),console[_0x340aea(0x119)]('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console[_0x340aea(0x119)]('Result:',_0x14b79c[_0x340aea(0x116)]),console[_0x340aea(0x119)](_0x340aea(0x138),_0x14b79c['status_code']),console[_0x340aea(0x119)]('Payment\x20Status:',_0x14b79c[_0x340aea(0x10c)]?.[_0x340aea(0x11a)]),console[_0x340aea(0x119)](_0x340aea(0xe8),_0x14b79c[_0x340aea(0x10c)]?.['Amount']),console[_0x340aea(0x119)](_0x340aea(0x12b),_0x14b79c['data']?.[_0x340aea(0x158)]);if(_0x14b79c['result']!==_0x340aea(0x117)||_0x14b79c[_0x340aea(0x130)]!==0xc8){const _0x1281a4=_0x14b79c[_0x340aea(0x123)]||'Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API';console[_0x340aea(0xde)]('===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20==='),console[_0x340aea(0xde)](_0x340aea(0xf4),_0x1281a4),loggerService_1['loggerService'][_0x340aea(0xf6)](_0x340aea(0xe6),'/status',_0x340aea(0xf3)+_0x1281a4);throw new Error(_0x340aea(0x139)+_0x1281a4);}if(!_0x14b79c['data']){console[_0x340aea(0xde)](_0x340aea(0x157)),console['error'](_0x340aea(0xf1)),loggerService_1['loggerService']['logWhiteDomainError'](_0x340aea(0xe6),'/status',_0x340aea(0x10d));throw new Error(_0x340aea(0xdb));}let _0x40cab3=_0x340aea(0xff);switch(_0x14b79c[_0x340aea(0x10c)][_0x340aea(0x11a)]?.[_0x340aea(0x115)]()){case _0x340aea(0x147):_0x40cab3=_0x340aea(0x144);break;case _0x340aea(0x110):case _0x340aea(0x113):case _0x340aea(0xde):_0x40cab3=_0x340aea(0x146);break;case _0x340aea(0x124):case _0x340aea(0x140):_0x40cab3=_0x340aea(0x13f);break;case _0x340aea(0xf5):case'awaiting\x20fiat':case'pending':case _0x340aea(0xf0):default:_0x40cab3=_0x340aea(0xff);break;}let _0x107628,_0x57ae1a;if(_0x14b79c['data'][_0x340aea(0x13c)]){const _0x224da2=_0x14b79c['data'][_0x340aea(0x13c)];console[_0x340aea(0x119)](_0x340aea(0x10b),_0x224da2);const _0x110685=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x57741d of _0x110685){const _0x54e62b=_0x224da2[_0x340aea(0x11e)](_0x57741d);if(_0x54e62b){_0x107628=_0x54e62b[0x1],console[_0x340aea(0x119)](_0x340aea(0x10a),_0x107628,_0x340aea(0xdd),_0x57741d[_0x340aea(0x11d)]);break;}}if(!_0x107628){console[_0x340aea(0x119)](_0x340aea(0x11c));const _0x5ca9f8=_0x224da2[_0x340aea(0x11e)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x5ca9f8&&(_0x107628=_0x5ca9f8[0x1],console[_0x340aea(0x119)](_0x340aea(0xd7),_0x107628));}_0x57ae1a=_0x224da2;}const _0x1a3d9c={'iban':_0x107628,'bankDetails':_0x57ae1a,'transactionId':_0x14b79c[_0x340aea(0x10c)][_0x340aea(0xe4)],'coinAddress':_0x14b79c[_0x340aea(0x10c)][_0x340aea(0x132)],'qrCodeUrl':_0x14b79c[_0x340aea(0x10c)]['QRCodeURL'],'expiryTime':_0x14b79c[_0x340aea(0x10c)]['ExpiryTime'],'createdOn':_0x14b79c[_0x340aea(0x10c)][_0x340aea(0xf8)],'confirmedOn':_0x14b79c[_0x340aea(0x10c)][_0x340aea(0x133)]};console[_0x340aea(0x119)]('===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20==='),console['log'](_0x340aea(0xd6),_0x14b79c[_0x340aea(0x10c)][_0x340aea(0x11a)],'->',_0x40cab3),console[_0x340aea(0x119)](_0x340aea(0xe8),_0x14b79c[_0x340aea(0x10c)][_0x340aea(0x120)],_0x14b79c[_0x340aea(0x10c)][_0x340aea(0x158)]),console[_0x340aea(0x119)](_0x340aea(0x159),_0x14b79c['data'][_0x340aea(0xe4)]),console[_0x340aea(0x119)](_0x340aea(0x109),_0x107628||'not\x20found'),console['log'](_0x340aea(0xe0),_0x14b79c[_0x340aea(0x10c)]['CreatedOn']),console[_0x340aea(0x119)](_0x340aea(0xe9),_0x14b79c[_0x340aea(0x10c)][_0x340aea(0x133)]||_0x340aea(0x143));if(_0x14b79c[_0x340aea(0x10c)][_0x340aea(0x11a)]?.[_0x340aea(0x115)]()===_0x340aea(0x100))console['log'](_0x340aea(0x14f));else _0x14b79c[_0x340aea(0x10c)][_0x340aea(0x11a)]?.[_0x340aea(0x115)]()==='paid'&&console['log'](_0x340aea(0xeb));return{'status':_0x40cab3,'amount':parseFloat(_0x14b79c[_0x340aea(0x10c)][_0x340aea(0x120)])||undefined,'currency':_0x14b79c[_0x340aea(0x10c)][_0x340aea(0x158)]||_0x340aea(0x125),'paymentDetails':_0x1a3d9c};}catch(_0x2965c2){console[_0x340aea(0xde)]('CoinToPay2\x20payment\x20status\x20check\x20error:',_0x2965c2),loggerService_1['loggerService'][_0x340aea(0xf6)](_0x340aea(0xe6),'/status',_0x2965c2);throw new Error(_0x340aea(0x149)+(_0x2965c2 instanceof Error?_0x2965c2[_0x340aea(0x123)]:_0x340aea(0x127)));}}async[a42_0xb116f6(0xf7)](_0x90b75f){const _0x5a4a42=a42_0xb116f6,_0x3e01e6=await this[_0x5a4a42(0x156)](_0x90b75f);return{'status':_0x3e01e6[_0x5a4a42(0x14e)],'amount':_0x3e01e6['amount'],'currency':_0x3e01e6[_0x5a4a42(0x13b)]};}async['processWebhook'](_0x22a934){const _0x32da37=a42_0xb116f6;console[_0x32da37(0x119)]('Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x22a934);let _0x34db49=_0x32da37(0xff);switch(_0x22a934[_0x32da37(0x14e)]?.[_0x32da37(0x115)]()){case _0x32da37(0x147):_0x34db49='PAID';break;case _0x32da37(0x110):case'failed':case _0x32da37(0xde):_0x34db49=_0x32da37(0x146);break;case _0x32da37(0x124):case _0x32da37(0x140):_0x34db49=_0x32da37(0x13f);break;case'pending':case _0x32da37(0xf5):case _0x32da37(0x100):case _0x32da37(0xf0):default:_0x34db49='PENDING';break;}return{'paymentId':_0x22a934[_0x32da37(0x122)]||_0x22a934[_0x32da37(0xfb)]||'','status':_0x34db49,'amount':_0x22a934['amount'],'currency':_0x22a934[_0x32da37(0x13b)]||_0x32da37(0x125)};}}exports[a42_0xb116f6(0x10f)]=CoinToPay2Service;