'use strict';const a64_0x4ca1cb=a64_0x2c7b;(function(_0x3a0b2d,_0x50c25b){const _0x122476=a64_0x2c7b,_0x361ed8=_0x3a0b2d();while(!![]){try{const _0x586c71=-parseInt(_0x122476(0x17a))/0x1*(parseInt(_0x122476(0x180))/0x2)+parseInt(_0x122476(0x14a))/0x3+-parseInt(_0x122476(0x16c))/0x4*(-parseInt(_0x122476(0x1a7))/0x5)+parseInt(_0x122476(0x168))/0x6+parseInt(_0x122476(0x142))/0x7*(-parseInt(_0x122476(0x194))/0x8)+-parseInt(_0x122476(0x129))/0x9*(parseInt(_0x122476(0x16e))/0xa)+-parseInt(_0x122476(0x166))/0xb*(-parseInt(_0x122476(0x159))/0xc);if(_0x586c71===_0x50c25b)break;else _0x361ed8['push'](_0x361ed8['shift']());}catch(_0x981c21){_0x361ed8['push'](_0x361ed8['shift']());}}}(a64_0x50d4,0x1b145));Object[a64_0x4ca1cb(0x137)](exports,a64_0x4ca1cb(0x1a0),{'value':!![]}),exports[a64_0x4ca1cb(0x17d)]=void 0x0;function a64_0x50d4(){const _0x59cf81=['CoinToPay2\x20API\x20error:\x20','fromEntries','JSON\x20Parse\x20Error:\x20','Payment\x20URL\x20(original):','Confirmed\x20On:','416kscyBi','HTTP\x20','paid','cointopay2','currency','Incomplete\x20response:\x20missing\x20data','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','Transaction\x20ID:','order_id','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','Status\x20API\x20Error:\x20','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','__esModule','Status','FAILED','TransactionID','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Amount','9540FvAdMm','===\x20COINTOPAY2\x20API\x20ERROR\x20===','text','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','URL:','PaymentDetail','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','apiUrl','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','inputCurrency','statusUrl','result','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','Gateway\x20Payment\x20ID:','Response\x20data:','\x20EUR','stringify','awaiting\x20fiat','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','285183wFpwQH','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','Error\x20Message:','failed','Created\x20On:','created','HTTP\x20Status:','EXPIRED','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','Result:','Failed\x20to\x20parse\x20JSON\x20response:','https://traffer.uk/gateway/cointopay/status.php','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','defineProperty','gateway_payment_id','createPaymentLink','data','success','Error\x20details:','POST','match','/create','Error\x20stack:','PAID','8260rxYzNH','waiting','ExpiryTime','log','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','expired','CoinToPay2\x20status\x20API\x20error:\x20','pending','387336BedvrF','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','stack','message','coinAddress','Request\x20Body:','Parsed\x20Result:','Response\x20Body:','processWebhook','error','Unknown\x20error\x20from\x20CoinToPay2\x20API','QRCodeURL','checkPaymentStatus','application/json','status','556980xKWDpm','Payment\x20System/1.0\x20(CoinToPay2)','Response\x20Time:','EUR','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','===\x20COINTOPAY2\x20SUCCESS\x20===','amount','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','headers','now','Status\x20Code:','Headers:','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','22VYpIcx','Amount:','782496WadSVC','&alternative=false','Status\x20Text:','Missing\x20data\x20in\x20response','24FeKVkb','logWhiteDomainResponse','20ABEVRf','Raw\x20Response\x20Body:','source','using\x20pattern:','loggerService','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','CreatedOn','TransactionConfirmedOn','PENDING',',\x20body:\x20','cancelled','statusText','1349jvjGks','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','/status','CoinToPay2Service','Error\x20message:','Payment\x20Status:','190whVndK','Status:','merchant_reference_id','CoinToPay2\x20payment\x20status\x20check\x20error:','logWhiteDomainRequest','Payment\x20URL\x20(modified):','payment_url','timeout','toLowerCase','Business\x20Error:\x20','not\x20confirmed','logWhiteDomainError','IBAN:','parse','not\x20found'];a64_0x50d4=function(){return _0x59cf81;};return a64_0x50d4();}function a64_0x2c7b(_0x56b96d,_0x555be0){_0x56b96d=_0x56b96d-0x124;const _0x50d4cc=a64_0x50d4();let _0x2c7bb0=_0x50d4cc[_0x56b96d];return _0x2c7bb0;}const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x2bec7c=a64_0x4ca1cb;this[_0x2bec7c(0x1af)]='https://traffer.uk/gateway/cointopay/',this[_0x2bec7c(0x1b2)]=_0x2bec7c(0x135),console[_0x2bec7c(0x145)](_0x2bec7c(0x19a)),console[_0x2bec7c(0x145)]('üìä\x20Status\x20check\x20URL:',this['statusUrl']);}async[a64_0x4ca1cb(0x139)](_0x3cb172){const _0x8ea14=a64_0x4ca1cb,{orderId:_0xd880fb,amount:_0x1ec328}=_0x3cb172;console[_0x8ea14(0x145)]('ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20'+_0x1ec328+_0x8ea14(0x125));const _0x5922f6={'amount':_0x1ec328},_0x170331=Date['now']();try{console[_0x8ea14(0x145)](_0x8ea14(0x128)),console[_0x8ea14(0x145)](_0x8ea14(0x1ac),this[_0x8ea14(0x1af)]),console[_0x8ea14(0x145)](_0x8ea14(0x14f),JSON['stringify'](_0x5922f6,null,0x2)),console[_0x8ea14(0x145)]('Amount:',_0x1ec328,_0x8ea14(0x1ab)),loggerService_1[_0x8ea14(0x172)]['logWhiteDomainRequest'](_0x8ea14(0x197),_0x8ea14(0x13f),'POST',_0x5922f6);const _0x5860e7=await fetch(this[_0x8ea14(0x1af)],{'method':_0x8ea14(0x13d),'headers':{'Content-Type':_0x8ea14(0x157),'Accept':_0x8ea14(0x157),'User-Agent':_0x8ea14(0x15a)},'body':JSON[_0x8ea14(0x126)](_0x5922f6)}),_0x29d3d5=Date['now']()-_0x170331;console[_0x8ea14(0x145)](_0x8ea14(0x136)),console['log'](_0x8ea14(0x181),_0x5860e7[_0x8ea14(0x158)]),console[_0x8ea14(0x145)](_0x8ea14(0x16a),_0x5860e7[_0x8ea14(0x179)]),console[_0x8ea14(0x145)](_0x8ea14(0x164),Object[_0x8ea14(0x190)](_0x5860e7[_0x8ea14(0x161)]['entries']())),console[_0x8ea14(0x145)](_0x8ea14(0x15b),_0x29d3d5+'ms');const _0x22912=await _0x5860e7[_0x8ea14(0x1a9)]();console[_0x8ea14(0x145)](_0x8ea14(0x16f),_0x22912);if(!_0x5860e7['ok']){console[_0x8ea14(0x153)](_0x8ea14(0x1a8)),console[_0x8ea14(0x153)]('HTTP\x20Status:',_0x5860e7[_0x8ea14(0x158)]),console[_0x8ea14(0x153)](_0x8ea14(0x151),_0x22912),loggerService_1[_0x8ea14(0x172)][_0x8ea14(0x16d)]('cointopay2',_0x8ea14(0x13f),_0x5860e7[_0x8ea14(0x158)],_0x22912,_0x29d3d5),loggerService_1[_0x8ea14(0x172)]['logWhiteDomainError']('cointopay2',_0x8ea14(0x13f),_0x8ea14(0x195)+_0x5860e7[_0x8ea14(0x158)]+':\x20'+_0x22912);throw new Error('HTTP\x20error!\x20status:\x20'+_0x5860e7[_0x8ea14(0x158)]+_0x8ea14(0x177)+_0x22912);}let _0x13b0dd;try{_0x13b0dd=JSON[_0x8ea14(0x18d)](_0x22912);}catch(_0x2df7b6){console[_0x8ea14(0x153)](_0x8ea14(0x134),_0x2df7b6),loggerService_1[_0x8ea14(0x172)][_0x8ea14(0x18b)](_0x8ea14(0x197),'/create',_0x8ea14(0x191)+_0x2df7b6);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20'+_0x22912);}console[_0x8ea14(0x145)](_0x8ea14(0x12a)),console['log'](_0x8ea14(0x150),JSON[_0x8ea14(0x126)](_0x13b0dd,null,0x2)),loggerService_1[_0x8ea14(0x172)][_0x8ea14(0x16d)](_0x8ea14(0x197),'/create',_0x5860e7[_0x8ea14(0x158)],_0x13b0dd,_0x29d3d5);if(_0x13b0dd[_0x8ea14(0x153)]){const _0x3f3bdc=_0x13b0dd[_0x8ea14(0x14d)]||_0x13b0dd[_0x8ea14(0x153)]||_0x8ea14(0x154);console[_0x8ea14(0x153)]('===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20==='),console['error']('Error\x20Message:',_0x3f3bdc),loggerService_1['loggerService'][_0x8ea14(0x18b)](_0x8ea14(0x197),_0x8ea14(0x13f),_0x8ea14(0x189)+_0x3f3bdc);throw new Error(_0x8ea14(0x18f)+_0x3f3bdc);}if(!_0x13b0dd[_0x8ea14(0x186)]||!_0x13b0dd[_0x8ea14(0x138)]){console[_0x8ea14(0x153)]('===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x8ea14(0x153)](_0x8ea14(0x19f)),console[_0x8ea14(0x153)](_0x8ea14(0x124),_0x13b0dd),loggerService_1['loggerService']['logWhiteDomainError'](_0x8ea14(0x197),_0x8ea14(0x13f),_0x8ea14(0x1aa));throw new Error(_0x8ea14(0x14b));}console[_0x8ea14(0x145)](_0x8ea14(0x15e)),console['log'](_0x8ea14(0x1b5),_0x13b0dd['gateway_payment_id']),console['log'](_0x8ea14(0x192),_0x13b0dd[_0x8ea14(0x186)]);const _0x1b9340=_0x13b0dd[_0x8ea14(0x186)]+_0x8ea14(0x169);return console[_0x8ea14(0x145)](_0x8ea14(0x185),_0x1b9340),console[_0x8ea14(0x145)](_0x8ea14(0x167),_0x1ec328,_0x8ea14(0x15c)),{'gateway_payment_id':_0x13b0dd[_0x8ea14(0x138)],'payment_url':_0x1b9340};}catch(_0x42f8eb){console[_0x8ea14(0x153)](_0x8ea14(0x1ae)),console[_0x8ea14(0x153)](_0x8ea14(0x13c),_0x42f8eb),loggerService_1[_0x8ea14(0x172)]['logWhiteDomainError'](_0x8ea14(0x197),_0x8ea14(0x13f),_0x42f8eb);if(_0x42f8eb instanceof Error){console[_0x8ea14(0x153)](_0x8ea14(0x17e),_0x42f8eb[_0x8ea14(0x14d)]),console[_0x8ea14(0x153)](_0x8ea14(0x140),_0x42f8eb[_0x8ea14(0x14c)]);throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20'+_0x42f8eb[_0x8ea14(0x14d)]);}throw new Error(_0x8ea14(0x1b4));}}async[a64_0x4ca1cb(0x156)](_0x10b65b){const _0x50052c=a64_0x4ca1cb,_0x2989c7=Date[_0x50052c(0x162)]();try{console[_0x50052c(0x145)](_0x50052c(0x19d)+_0x10b65b);const _0x265397={'gatewayPaymentId':_0x10b65b};loggerService_1[_0x50052c(0x172)][_0x50052c(0x184)]('cointopay2',_0x50052c(0x17c),'POST',_0x265397);const _0x2ceb40=await fetch(this['statusUrl'],{'method':'POST','headers':{'Content-Type':_0x50052c(0x157),'Accept':_0x50052c(0x157),'User-Agent':_0x50052c(0x15a)},'body':JSON[_0x50052c(0x126)](_0x265397)}),_0x21950a=Date[_0x50052c(0x162)]()-_0x2989c7;console[_0x50052c(0x145)](_0x50052c(0x1b0)),console[_0x50052c(0x145)](_0x50052c(0x181),_0x2ceb40[_0x50052c(0x158)]),console[_0x50052c(0x145)](_0x50052c(0x15b),_0x21950a+'ms');if(!_0x2ceb40['ok']){const _0xab7cd2=await _0x2ceb40[_0x50052c(0x1a9)]();console[_0x50052c(0x153)](_0x50052c(0x130),_0x2ceb40[_0x50052c(0x158)]),console[_0x50052c(0x153)]('Response\x20Body:',_0xab7cd2),loggerService_1['loggerService'][_0x50052c(0x16d)](_0x50052c(0x197),_0x50052c(0x17c),_0x2ceb40[_0x50052c(0x158)],_0xab7cd2,_0x21950a),loggerService_1[_0x50052c(0x172)][_0x50052c(0x18b)](_0x50052c(0x197),_0x50052c(0x17c),_0x50052c(0x195)+_0x2ceb40['status']+':\x20'+_0xab7cd2);throw new Error('HTTP\x20error!\x20status:\x20'+_0x2ceb40[_0x50052c(0x158)]);}const _0x5dbdb5=await _0x2ceb40[_0x50052c(0x1a9)]();console['log'](_0x50052c(0x16f),_0x5dbdb5);let _0x3e19f3;try{_0x3e19f3=JSON[_0x50052c(0x18d)](_0x5dbdb5);}catch(_0x35550c){console['error'](_0x50052c(0x134),_0x35550c),loggerService_1[_0x50052c(0x172)][_0x50052c(0x18b)](_0x50052c(0x197),_0x50052c(0x17c),'JSON\x20Parse\x20Error:\x20'+_0x35550c);throw new Error(_0x50052c(0x165)+_0x5dbdb5);}loggerService_1['loggerService'][_0x50052c(0x16d)](_0x50052c(0x197),_0x50052c(0x17c),_0x2ceb40['status'],_0x3e19f3,_0x21950a),console[_0x50052c(0x145)]('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console[_0x50052c(0x145)](_0x50052c(0x133),_0x3e19f3[_0x50052c(0x1b3)]),console[_0x50052c(0x145)](_0x50052c(0x163),_0x3e19f3['status_code']),console[_0x50052c(0x145)](_0x50052c(0x17f),_0x3e19f3[_0x50052c(0x13a)]?.[_0x50052c(0x1a1)]),console[_0x50052c(0x145)]('Amount:',_0x3e19f3[_0x50052c(0x13a)]?.[_0x50052c(0x1a6)]),console[_0x50052c(0x145)]('Currency:',_0x3e19f3['data']?.[_0x50052c(0x1b1)]);if(_0x3e19f3['result']!==_0x50052c(0x13b)||_0x3e19f3['status_code']!==0xc8){const _0x46d4f4=_0x3e19f3['message']||_0x50052c(0x160);console[_0x50052c(0x153)](_0x50052c(0x1a4)),console['error'](_0x50052c(0x12c),_0x46d4f4),loggerService_1[_0x50052c(0x172)][_0x50052c(0x18b)](_0x50052c(0x197),'/status',_0x50052c(0x19e)+_0x46d4f4);throw new Error(_0x50052c(0x148)+_0x46d4f4);}if(!_0x3e19f3['data']){console[_0x50052c(0x153)](_0x50052c(0x1a5)),console['error'](_0x50052c(0x16b)),loggerService_1[_0x50052c(0x172)][_0x50052c(0x18b)](_0x50052c(0x197),_0x50052c(0x17c),_0x50052c(0x199));throw new Error(_0x50052c(0x132));}let _0x3b73bc=_0x50052c(0x176);switch(_0x3e19f3['data'][_0x50052c(0x1a1)]?.['toLowerCase']()){case _0x50052c(0x196):_0x3b73bc=_0x50052c(0x141);break;case'cancelled':case _0x50052c(0x12d):case _0x50052c(0x153):_0x3b73bc='FAILED';break;case _0x50052c(0x147):case'timeout':_0x3b73bc=_0x50052c(0x131);break;case'waiting':case _0x50052c(0x127):case _0x50052c(0x149):case'created':default:_0x3b73bc=_0x50052c(0x176);break;}let _0x37c282,_0x8a30bf;if(_0x3e19f3[_0x50052c(0x13a)][_0x50052c(0x1ad)]){const _0x5bb673=_0x3e19f3[_0x50052c(0x13a)]['PaymentDetail'];console[_0x50052c(0x145)]('üè¶\x20Payment\x20Detail:',_0x5bb673);const _0x2b40c7=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x3cce7b of _0x2b40c7){const _0x3a3da6=_0x5bb673['match'](_0x3cce7b);if(_0x3a3da6){_0x37c282=_0x3a3da6[0x1],console[_0x50052c(0x145)]('üè¶\x20Extracted\x20IBAN:',_0x37c282,_0x50052c(0x171),_0x3cce7b[_0x50052c(0x170)]);break;}}if(!_0x37c282){console[_0x50052c(0x145)](_0x50052c(0x146));const _0x91952=_0x5bb673[_0x50052c(0x13e)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x91952&&(_0x37c282=_0x91952[0x1],console[_0x50052c(0x145)](_0x50052c(0x17b),_0x37c282));}_0x8a30bf=_0x5bb673;}const _0x1eeb1a={'iban':_0x37c282,'bankDetails':_0x8a30bf,'transactionId':_0x3e19f3[_0x50052c(0x13a)][_0x50052c(0x1a3)],'coinAddress':_0x3e19f3['data'][_0x50052c(0x14e)],'qrCodeUrl':_0x3e19f3[_0x50052c(0x13a)][_0x50052c(0x155)],'expiryTime':_0x3e19f3['data'][_0x50052c(0x144)],'createdOn':_0x3e19f3[_0x50052c(0x13a)][_0x50052c(0x174)],'confirmedOn':_0x3e19f3['data'][_0x50052c(0x175)]};console[_0x50052c(0x145)](_0x50052c(0x173)),console[_0x50052c(0x145)](_0x50052c(0x181),_0x3e19f3[_0x50052c(0x13a)][_0x50052c(0x1a1)],'->',_0x3b73bc),console[_0x50052c(0x145)](_0x50052c(0x167),_0x3e19f3[_0x50052c(0x13a)][_0x50052c(0x1a6)],_0x3e19f3[_0x50052c(0x13a)]['inputCurrency']),console[_0x50052c(0x145)](_0x50052c(0x19b),_0x3e19f3['data']['TransactionID']),console['log'](_0x50052c(0x18c),_0x37c282||_0x50052c(0x18e)),console[_0x50052c(0x145)](_0x50052c(0x12e),_0x3e19f3[_0x50052c(0x13a)][_0x50052c(0x174)]),console['log'](_0x50052c(0x193),_0x3e19f3[_0x50052c(0x13a)][_0x50052c(0x175)]||_0x50052c(0x18a));if(_0x3e19f3[_0x50052c(0x13a)][_0x50052c(0x1a1)]?.[_0x50052c(0x188)]()===_0x50052c(0x127))console['log']('üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)');else _0x3e19f3[_0x50052c(0x13a)][_0x50052c(0x1a1)]?.[_0x50052c(0x188)]()===_0x50052c(0x196)&&console[_0x50052c(0x145)](_0x50052c(0x15d));return{'status':_0x3b73bc,'amount':parseFloat(_0x3e19f3[_0x50052c(0x13a)]['Amount'])||undefined,'currency':_0x3e19f3[_0x50052c(0x13a)][_0x50052c(0x1b1)]||_0x50052c(0x15c),'paymentDetails':_0x1eeb1a};}catch(_0x1fe110){console[_0x50052c(0x153)](_0x50052c(0x183),_0x1fe110),loggerService_1[_0x50052c(0x172)]['logWhiteDomainError']('cointopay2',_0x50052c(0x17c),_0x1fe110);throw new Error(_0x50052c(0x12b)+(_0x1fe110 instanceof Error?_0x1fe110[_0x50052c(0x14d)]:'Unknown\x20error'));}}async['verifyPayment'](_0x4f010e){const _0x428fb0=a64_0x4ca1cb,_0x385d8f=await this[_0x428fb0(0x156)](_0x4f010e);return{'status':_0x385d8f[_0x428fb0(0x158)],'amount':_0x385d8f[_0x428fb0(0x15f)],'currency':_0x385d8f[_0x428fb0(0x198)]};}async[a64_0x4ca1cb(0x152)](_0x5843f6){const _0x34a099=a64_0x4ca1cb;console[_0x34a099(0x145)]('Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x5843f6);let _0x17a0f6=_0x34a099(0x176);switch(_0x5843f6['status']?.[_0x34a099(0x188)]()){case _0x34a099(0x196):_0x17a0f6=_0x34a099(0x141);break;case _0x34a099(0x178):case _0x34a099(0x12d):case _0x34a099(0x153):_0x17a0f6=_0x34a099(0x1a2);break;case _0x34a099(0x147):case _0x34a099(0x187):_0x17a0f6=_0x34a099(0x131);break;case _0x34a099(0x149):case _0x34a099(0x143):case _0x34a099(0x127):case _0x34a099(0x12f):default:_0x17a0f6=_0x34a099(0x176);break;}return{'paymentId':_0x5843f6[_0x34a099(0x19c)]||_0x5843f6[_0x34a099(0x182)]||'','status':_0x17a0f6,'amount':_0x5843f6[_0x34a099(0x15f)],'currency':_0x5843f6[_0x34a099(0x198)]||_0x34a099(0x15c)};}}exports[a64_0x4ca1cb(0x17d)]=CoinToPay2Service;