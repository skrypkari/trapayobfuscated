'use strict';const a43_0x2aa4b9=a43_0x24c2;(function(_0x2302ee,_0x1ccd4f){const _0x4999e2=a43_0x24c2,_0x18ccbb=_0x2302ee();while(!![]){try{const _0x433be0=parseInt(_0x4999e2(0xb3))/0x1*(parseInt(_0x4999e2(0xfc))/0x2)+-parseInt(_0x4999e2(0xdc))/0x3+-parseInt(_0x4999e2(0xd2))/0x4+-parseInt(_0x4999e2(0x94))/0x5*(-parseInt(_0x4999e2(0xea))/0x6)+-parseInt(_0x4999e2(0xbf))/0x7*(-parseInt(_0x4999e2(0xba))/0x8)+-parseInt(_0x4999e2(0x8f))/0x9*(-parseInt(_0x4999e2(0xf0))/0xa)+-parseInt(_0x4999e2(0xd8))/0xb;if(_0x433be0===_0x1ccd4f)break;else _0x18ccbb['push'](_0x18ccbb['shift']());}catch(_0x4ea7c5){_0x18ccbb['push'](_0x18ccbb['shift']());}}}(a43_0x7209,0x991ae));function a43_0x24c2(_0xeb5ab0,_0xabba79){const _0x72093e=a43_0x7209();return a43_0x24c2=function(_0x24c20e,_0x3c41a9){_0x24c20e=_0x24c20e-0x83;let _0x35edd8=_0x72093e[_0x24c20e];return _0x35edd8;},a43_0x24c2(_0xeb5ab0,_0xabba79);}Object['defineProperty'](exports,a43_0x2aa4b9(0x86),{'value':!![]}),exports[a43_0x2aa4b9(0xf6)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x978502=a43_0x2aa4b9;this[_0x978502(0x8c)]=_0x978502(0xcf),this[_0x978502(0xf4)]=_0x978502(0xf7),console[_0x978502(0xe7)]('ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy'),console['log']('üìä\x20Status\x20check\x20URL:',this['statusUrl']);}async['createPaymentLink'](_0x5a98e4){const _0xd4aa9f=a43_0x2aa4b9,{orderId:_0x47912d,amount:_0x4bc77c}=_0x5a98e4;console['log'](_0xd4aa9f(0xed)+_0x4bc77c+_0xd4aa9f(0xef));const _0x5a910c={'amount':_0x4bc77c},_0x5a75c4=Date[_0xd4aa9f(0xfe)]();try{console[_0xd4aa9f(0xe7)](_0xd4aa9f(0x8e)),console[_0xd4aa9f(0xe7)](_0xd4aa9f(0xf2),this[_0xd4aa9f(0x8c)]),console['log'](_0xd4aa9f(0xae),JSON['stringify'](_0x5a910c,null,0x2)),console['log'](_0xd4aa9f(0xbc),_0x4bc77c,_0xd4aa9f(0xc4)),loggerService_1[_0xd4aa9f(0xc1)]['logWhiteDomainRequest']('cointopay2','/create',_0xd4aa9f(0xa8),_0x5a910c);const _0xe13db2=await fetch(this[_0xd4aa9f(0x8c)],{'method':_0xd4aa9f(0xa8),'headers':{'Content-Type':'application/json','Accept':_0xd4aa9f(0xfd),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON[_0xd4aa9f(0xb6)](_0x5a910c)}),_0x5344d5=Date['now']()-_0x5a75c4;console[_0xd4aa9f(0xe7)]('===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20==='),console[_0xd4aa9f(0xe7)]('Status:',_0xe13db2['status']),console['log']('Status\x20Text:',_0xe13db2[_0xd4aa9f(0xda)]),console['log'](_0xd4aa9f(0xa4),Object[_0xd4aa9f(0x88)](_0xe13db2[_0xd4aa9f(0xee)][_0xd4aa9f(0x85)]())),console[_0xd4aa9f(0xe7)](_0xd4aa9f(0xb7),_0x5344d5+'ms');const _0x47c7c5=await _0xe13db2[_0xd4aa9f(0xe3)]();console['log'](_0xd4aa9f(0xaa),_0x47c7c5);if(!_0xe13db2['ok']){console['error'](_0xd4aa9f(0xa2)),console[_0xd4aa9f(0xf5)](_0xd4aa9f(0x8a),_0xe13db2[_0xd4aa9f(0x8d)]),console[_0xd4aa9f(0xf5)](_0xd4aa9f(0x9b),_0x47c7c5),loggerService_1[_0xd4aa9f(0xc1)][_0xd4aa9f(0xd4)](_0xd4aa9f(0xbe),'/create',_0xe13db2[_0xd4aa9f(0x8d)],_0x47c7c5,_0x5344d5),loggerService_1[_0xd4aa9f(0xc1)][_0xd4aa9f(0xa5)](_0xd4aa9f(0xbe),'/create',_0xd4aa9f(0xd9)+_0xe13db2[_0xd4aa9f(0x8d)]+':\x20'+_0x47c7c5);throw new Error(_0xd4aa9f(0x9f)+_0xe13db2['status']+_0xd4aa9f(0xb9)+_0x47c7c5);}let _0x24198c;try{_0x24198c=JSON[_0xd4aa9f(0xe5)](_0x47c7c5);}catch(_0x36251b){console['error'](_0xd4aa9f(0xab),_0x36251b),loggerService_1[_0xd4aa9f(0xc1)][_0xd4aa9f(0xa5)]('cointopay2','/create',_0xd4aa9f(0xa3)+_0x36251b);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20'+_0x47c7c5);}console['log']('===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20==='),console[_0xd4aa9f(0xe7)](_0xd4aa9f(0x83),JSON[_0xd4aa9f(0xb6)](_0x24198c,null,0x2)),loggerService_1[_0xd4aa9f(0xc1)][_0xd4aa9f(0xd4)]('cointopay2',_0xd4aa9f(0xa9),_0xe13db2[_0xd4aa9f(0x8d)],_0x24198c,_0x5344d5);if(_0x24198c[_0xd4aa9f(0xf5)]){const _0x1335f6=_0x24198c[_0xd4aa9f(0x90)]||_0x24198c[_0xd4aa9f(0xf5)]||_0xd4aa9f(0xe4);console[_0xd4aa9f(0xf5)](_0xd4aa9f(0xca)),console[_0xd4aa9f(0xf5)](_0xd4aa9f(0xd7),_0x1335f6),loggerService_1[_0xd4aa9f(0xc1)][_0xd4aa9f(0xa5)](_0xd4aa9f(0xbe),_0xd4aa9f(0xa9),'Business\x20Error:\x20'+_0x1335f6);throw new Error(_0xd4aa9f(0xe2)+_0x1335f6);}if(!_0x24198c['payment_url']||!_0x24198c['gateway_payment_id']){console['error'](_0xd4aa9f(0xc3)),console[_0xd4aa9f(0xf5)](_0xd4aa9f(0xb1)),console[_0xd4aa9f(0xf5)](_0xd4aa9f(0x95),_0x24198c),loggerService_1[_0xd4aa9f(0xc1)][_0xd4aa9f(0xa5)](_0xd4aa9f(0xbe),'/create','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error(_0xd4aa9f(0xad));}return console[_0xd4aa9f(0xe7)](_0xd4aa9f(0xc6)),console[_0xd4aa9f(0xe7)](_0xd4aa9f(0xde),_0x24198c['gateway_payment_id']),console[_0xd4aa9f(0xe7)](_0xd4aa9f(0x98),_0x24198c['payment_url']),console[_0xd4aa9f(0xe7)]('Amount:',_0x4bc77c,_0xd4aa9f(0xbd)),{'gateway_payment_id':_0x24198c['gateway_payment_id'],'payment_url':_0x24198c[_0xd4aa9f(0x96)]};}catch(_0x46d629){console[_0xd4aa9f(0xf5)](_0xd4aa9f(0x87)),console[_0xd4aa9f(0xf5)](_0xd4aa9f(0xcb),_0x46d629),loggerService_1[_0xd4aa9f(0xc1)][_0xd4aa9f(0xa5)](_0xd4aa9f(0xbe),_0xd4aa9f(0xa9),_0x46d629);if(_0x46d629 instanceof Error){console[_0xd4aa9f(0xf5)](_0xd4aa9f(0xb0),_0x46d629['message']),console[_0xd4aa9f(0xf5)]('Error\x20stack:',_0x46d629['stack']);throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20'+_0x46d629[_0xd4aa9f(0x90)]);}throw new Error(_0xd4aa9f(0xe0));}}async['checkPaymentStatus'](_0x4c7d81){const _0x29250b=a43_0x2aa4b9,_0x4bf672=Date[_0x29250b(0xfe)]();try{console[_0x29250b(0xe7)](_0x29250b(0xdb)+_0x4c7d81);const _0x88af2b={'gatewayPaymentId':_0x4c7d81};loggerService_1[_0x29250b(0xc1)]['logWhiteDomainRequest'](_0x29250b(0xbe),_0x29250b(0x92),'POST',_0x88af2b);const _0x354e2=await fetch(this['statusUrl'],{'method':_0x29250b(0xa8),'headers':{'Content-Type':_0x29250b(0xfd),'Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON['stringify'](_0x88af2b)}),_0x4ed1aa=Date[_0x29250b(0xfe)]()-_0x4bf672;console[_0x29250b(0xe7)](_0x29250b(0xff)),console[_0x29250b(0xe7)]('Status:',_0x354e2['status']),console[_0x29250b(0xe7)](_0x29250b(0xb7),_0x4ed1aa+'ms');if(!_0x354e2['ok']){const _0x39b671=await _0x354e2[_0x29250b(0xe3)]();console['error'](_0x29250b(0x8a),_0x354e2['status']),console[_0x29250b(0xf5)](_0x29250b(0x9b),_0x39b671),loggerService_1[_0x29250b(0xc1)]['logWhiteDomainResponse'](_0x29250b(0xbe),_0x29250b(0x92),_0x354e2['status'],_0x39b671,_0x4ed1aa),loggerService_1[_0x29250b(0xc1)]['logWhiteDomainError'](_0x29250b(0xbe),'/status','HTTP\x20'+_0x354e2[_0x29250b(0x8d)]+':\x20'+_0x39b671);throw new Error(_0x29250b(0x9f)+_0x354e2[_0x29250b(0x8d)]);}const _0x320ed0=await _0x354e2[_0x29250b(0xe3)]();console['log'](_0x29250b(0xaa),_0x320ed0);let _0x4f0f3e;try{_0x4f0f3e=JSON[_0x29250b(0xe5)](_0x320ed0);}catch(_0x4923ef){console[_0x29250b(0xf5)](_0x29250b(0xab),_0x4923ef),loggerService_1[_0x29250b(0xc1)]['logWhiteDomainError']('cointopay2',_0x29250b(0x92),'JSON\x20Parse\x20Error:\x20'+_0x4923ef);throw new Error(_0x29250b(0xe9)+_0x320ed0);}loggerService_1[_0x29250b(0xc1)][_0x29250b(0xd4)](_0x29250b(0xbe),_0x29250b(0x92),_0x354e2[_0x29250b(0x8d)],_0x4f0f3e,_0x4ed1aa),console[_0x29250b(0xe7)](_0x29250b(0x93)),console[_0x29250b(0xe7)]('Result:',_0x4f0f3e[_0x29250b(0xbb)]),console['log'](_0x29250b(0xd3),_0x4f0f3e[_0x29250b(0xa6)]),console['log'](_0x29250b(0xc0),_0x4f0f3e[_0x29250b(0xe6)]?.[_0x29250b(0x9c)]),console[_0x29250b(0xe7)](_0x29250b(0xbc),_0x4f0f3e[_0x29250b(0xe6)]?.[_0x29250b(0xd1)]),console[_0x29250b(0xe7)](_0x29250b(0xaf),_0x4f0f3e[_0x29250b(0xe6)]?.[_0x29250b(0xeb)]);if(_0x4f0f3e[_0x29250b(0xbb)]!=='success'||_0x4f0f3e['status_code']!==0xc8){const _0x594ee4=_0x4f0f3e[_0x29250b(0x90)]||_0x29250b(0xd6);console[_0x29250b(0xf5)](_0x29250b(0xb2)),console[_0x29250b(0xf5)](_0x29250b(0xd7),_0x594ee4),loggerService_1[_0x29250b(0xc1)][_0x29250b(0xa5)]('cointopay2',_0x29250b(0x92),_0x29250b(0xc2)+_0x594ee4);throw new Error('CoinToPay2\x20status\x20API\x20error:\x20'+_0x594ee4);}if(!_0x4f0f3e[_0x29250b(0xe6)]){console[_0x29250b(0xf5)]('===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x29250b(0xf5)](_0x29250b(0xb5)),loggerService_1[_0x29250b(0xc1)][_0x29250b(0xa5)](_0x29250b(0xbe),_0x29250b(0x92),_0x29250b(0xdd));throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data');}let _0x4ed18b=_0x29250b(0xfb);switch(_0x4f0f3e[_0x29250b(0xe6)][_0x29250b(0x9c)]?.[_0x29250b(0x99)]()){case'paid':_0x4ed18b=_0x29250b(0x9a);break;case'cancelled':case _0x29250b(0xac):case'error':_0x4ed18b='FAILED';break;case _0x29250b(0xe1):case _0x29250b(0xec):_0x4ed18b=_0x29250b(0xa1);break;case _0x29250b(0x97):case _0x29250b(0xb4):case'pending':case _0x29250b(0xd5):default:_0x4ed18b=_0x29250b(0xfb);break;}let _0x15e7f2,_0x2d5dfc;if(_0x4f0f3e[_0x29250b(0xe6)][_0x29250b(0xd0)]){const _0x1ffb71=_0x4f0f3e['data'][_0x29250b(0xd0)];console['log'](_0x29250b(0xa0),_0x1ffb71);const _0x485fdd=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x846e80 of _0x485fdd){const _0x90d5a7=_0x1ffb71[_0x29250b(0xb8)](_0x846e80);if(_0x90d5a7){_0x15e7f2=_0x90d5a7[0x1],console[_0x29250b(0xe7)](_0x29250b(0xc9),_0x15e7f2,_0x29250b(0xcc),_0x846e80['source']);break;}}if(!_0x15e7f2){console['log'](_0x29250b(0xc7));const _0xbc16c7=_0x1ffb71[_0x29250b(0xb8)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0xbc16c7&&(_0x15e7f2=_0xbc16c7[0x1],console[_0x29250b(0xe7)]('üè¶\x20Extracted\x20IBAN\x20via\x20fallback:',_0x15e7f2));}_0x2d5dfc=_0x1ffb71;}const _0x210409={'iban':_0x15e7f2,'bankDetails':_0x2d5dfc,'transactionId':_0x4f0f3e[_0x29250b(0xe6)][_0x29250b(0xdf)],'coinAddress':_0x4f0f3e[_0x29250b(0xe6)][_0x29250b(0xf9)],'qrCodeUrl':_0x4f0f3e[_0x29250b(0xe6)]['QRCodeURL'],'expiryTime':_0x4f0f3e[_0x29250b(0xe6)]['ExpiryTime'],'createdOn':_0x4f0f3e[_0x29250b(0xe6)][_0x29250b(0xf1)],'confirmedOn':_0x4f0f3e[_0x29250b(0xe6)][_0x29250b(0xc5)]};console[_0x29250b(0xe7)]('===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20==='),console[_0x29250b(0xe7)]('Status:',_0x4f0f3e['data'][_0x29250b(0x9c)],'->',_0x4ed18b),console[_0x29250b(0xe7)](_0x29250b(0xbc),_0x4f0f3e[_0x29250b(0xe6)][_0x29250b(0xd1)],_0x4f0f3e['data'][_0x29250b(0xeb)]),console[_0x29250b(0xe7)]('Transaction\x20ID:',_0x4f0f3e[_0x29250b(0xe6)]['TransactionID']),console[_0x29250b(0xe7)](_0x29250b(0xfa),_0x15e7f2||'not\x20found'),console['log'](_0x29250b(0xc8),_0x4f0f3e[_0x29250b(0xe6)][_0x29250b(0xf1)]),console[_0x29250b(0xe7)](_0x29250b(0x89),_0x4f0f3e[_0x29250b(0xe6)]['TransactionConfirmedOn']||_0x29250b(0x84));if(_0x4f0f3e['data'][_0x29250b(0x9c)]?.[_0x29250b(0x99)]()===_0x29250b(0xb4))console[_0x29250b(0xe7)](_0x29250b(0x9d));else _0x4f0f3e[_0x29250b(0xe6)][_0x29250b(0x9c)]?.[_0x29250b(0x99)]()==='paid'&&console['log'](_0x29250b(0x91));return{'status':_0x4ed18b,'amount':parseFloat(_0x4f0f3e['data'][_0x29250b(0xd1)])||undefined,'currency':_0x4f0f3e[_0x29250b(0xe6)][_0x29250b(0xeb)]||_0x29250b(0xbd),'paymentDetails':_0x210409};}catch(_0x5ae4e2){console[_0x29250b(0xf5)](_0x29250b(0x8b),_0x5ae4e2),loggerService_1['loggerService'][_0x29250b(0xa5)]('cointopay2','/status',_0x5ae4e2);throw new Error(_0x29250b(0x9e)+(_0x5ae4e2 instanceof Error?_0x5ae4e2[_0x29250b(0x90)]:_0x29250b(0xcd)));}}async[a43_0x2aa4b9(0xe8)](_0x3bab8e){const _0x5a8066=a43_0x2aa4b9,_0x332258=await this['checkPaymentStatus'](_0x3bab8e);return{'status':_0x332258[_0x5a8066(0x8d)],'amount':_0x332258['amount'],'currency':_0x332258['currency']};}async['processWebhook'](_0x3339e6){const _0x3cc2ed=a43_0x2aa4b9;console[_0x3cc2ed(0xe7)](_0x3cc2ed(0xce),_0x3339e6);let _0x38bcfd='PENDING';switch(_0x3339e6[_0x3cc2ed(0x8d)]?.['toLowerCase']()){case _0x3cc2ed(0xa7):_0x38bcfd='PAID';break;case _0x3cc2ed(0xf3):case _0x3cc2ed(0xac):case _0x3cc2ed(0xf5):_0x38bcfd='FAILED';break;case _0x3cc2ed(0xe1):case _0x3cc2ed(0xec):_0x38bcfd=_0x3cc2ed(0xa1);break;case'pending':case'waiting':case _0x3cc2ed(0xb4):case _0x3cc2ed(0xd5):default:_0x38bcfd=_0x3cc2ed(0xfb);break;}return{'paymentId':_0x3339e6['order_id']||_0x3339e6[_0x3cc2ed(0xf8)]||'','status':_0x38bcfd,'amount':_0x3339e6['amount'],'currency':_0x3339e6[_0x3cc2ed(0x100)]||_0x3cc2ed(0xbd)};}}exports['CoinToPay2Service']=CoinToPay2Service;function a43_0x7209(){const _0x127666=['match',',\x20body:\x20','448832MzonTp','result','Amount:','EUR','cointopay2','7OLzErA','Payment\x20Status:','loggerService','Status\x20API\x20Error:\x20','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','TransactionConfirmedOn','===\x20COINTOPAY2\x20SUCCESS\x20===','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','Created\x20On:','üè¶\x20Extracted\x20IBAN:','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','Error\x20details:','using\x20pattern:','Unknown\x20error','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','https://traffer.uk/gateway/cointopay/','PaymentDetail','Amount','4840720OQUAmm','Status\x20Code:','logWhiteDomainResponse','created','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','Error\x20Message:','2600455orwlRq','HTTP\x20','statusText','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','936492ppsNfr','Incomplete\x20response:\x20missing\x20data','Gateway\x20Payment\x20ID:','TransactionID','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','expired','CoinToPay2\x20API\x20error:\x20','text','Unknown\x20error\x20from\x20CoinToPay2\x20API','parse','data','log','verifyPayment','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','42zKJvHQ','inputCurrency','timeout','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','headers','\x20EUR','6190yjetWP','CreatedOn','URL:','cancelled','statusUrl','error','CoinToPay2Service','https://traffer.uk/gateway/cointopay/status.php','merchant_reference_id','coinAddress','IBAN:','PENDING','2HhaRTK','application/json','now','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','currency','Parsed\x20Result:','not\x20confirmed','entries','__esModule','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','fromEntries','Confirmed\x20On:','HTTP\x20Status:','CoinToPay2\x20payment\x20status\x20check\x20error:','apiUrl','status','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','12681mBZYpD','message','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','/status','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','827850ZbGXCJ','Response\x20data:','payment_url','waiting','Payment\x20URL:','toLowerCase','PAID','Response\x20Body:','Status','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','HTTP\x20error!\x20status:\x20','üè¶\x20Payment\x20Detail:','EXPIRED','===\x20COINTOPAY2\x20API\x20ERROR\x20===','JSON\x20Parse\x20Error:\x20','Headers:','logWhiteDomainError','status_code','paid','POST','/create','Raw\x20Response\x20Body:','Failed\x20to\x20parse\x20JSON\x20response:','failed','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','Request\x20Body:','Currency:','Error\x20message:','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','298602aBdJzp','awaiting\x20fiat','Missing\x20data\x20in\x20response','stringify','Response\x20Time:'];a43_0x7209=function(){return _0x127666;};return a43_0x7209();}