'use strict';const a48_0x4f968c=a48_0xd18f;function a48_0xb4e7(){const _0x1f9c62=['&alternative=false','Error\x20Message:','statusUrl','Currency:','12243756XRkreC','/status','error','apiUrl','match','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','===\x20COINTOPAY2\x20SUCCESS\x20===','Payment\x20Status:','toLowerCase','Raw\x20Response\x20Body:','source','Error\x20message:','fromEntries','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','Parsed\x20Result:','checkPaymentStatus','CreatedOn','/create','result','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','üìä\x20Status\x20check\x20URL:','parse','PENDING','Status:','IBAN:','created','defineProperty','HTTP\x20error!\x20status:\x20','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','776qBSQMP','__esModule','amount','2638EHvuIu','processWebhook','44IopCvS','loggerService','message','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','text','not\x20confirmed','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','Response\x20Body:','order_id','Payment\x20System/1.0\x20(CoinToPay2)','expired','696038yrgtEW','https://traffer.uk/gateway/cointopay/','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','261177kaSnSh','status_code','failed','gateway_payment_id','Incomplete\x20response:\x20missing\x20data','now','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','statusText','not\x20found','EUR','JSON\x20Parse\x20Error:\x20','QRCodeURL','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','verifyPayment','PAID','pending','Created\x20On:','EXPIRED','Error\x20details:','CoinToPay2\x20payment\x20status\x20check\x20error:','logWhiteDomainRequest','FAILED',',\x20body:\x20','Unknown\x20error\x20from\x20CoinToPay2\x20API','createPaymentLink','Amount:','logWhiteDomainError','42vhrXKs','awaiting\x20fiat','Unknown\x20error','359070GyqyIX','Failed\x20to\x20parse\x20JSON\x20response:','payment_url','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','CoinToPay2Service','status','CoinToPay2\x20API\x20error:\x20','URL:','../loggerService','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','TransactionConfirmedOn','stringify','log','10ReBpXt','Result:','Headers:','üè¶\x20Extracted\x20IBAN:','Response\x20Time:','HTTP\x20','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','success','cointopay2','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','data','inputCurrency','Amount','48917yBmPuy','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','Payment\x20URL\x20(modified):','244kuZoFP','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','https://traffer.uk/gateway/cointopay/status.php','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','Confirmed\x20On:','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','application/json','cancelled','üè¶\x20Payment\x20Detail:','logWhiteDomainResponse','paid','TransactionID','Status\x20Code:','stack','using\x20pattern:','Payment\x20URL\x20(original):','73494laeSDU','ExpiryTime','HTTP\x20Status:','Transaction\x20ID:','POST','currency','===\x20COINTOPAY2\x20API\x20ERROR\x20===','Status'];a48_0xb4e7=function(){return _0x1f9c62;};return a48_0xb4e7();}(function(_0x38e338,_0x237203){const _0x514b0c=a48_0xd18f,_0x5426da=_0x38e338();while(!![]){try{const _0x5b65ce=parseInt(_0x514b0c(0xf7))/0x1*(parseInt(_0x514b0c(0x134))/0x2)+-parseInt(_0x514b0c(0x144))/0x3+-parseInt(_0x514b0c(0x136))/0x4*(-parseInt(_0x514b0c(0x162))/0x5)+parseInt(_0x514b0c(0x15f))/0x6*(-parseInt(_0x514b0c(0x141))/0x7)+parseInt(_0x514b0c(0x131))/0x8*(-parseInt(_0x514b0c(0x108))/0x9)+parseInt(_0x514b0c(0xe6))/0xa*(parseInt(_0x514b0c(0xf3))/0xb)+parseInt(_0x514b0c(0x114))/0xc;if(_0x5b65ce===_0x237203)break;else _0x5426da['push'](_0x5426da['shift']());}catch(_0x5c0436){_0x5426da['push'](_0x5426da['shift']());}}}(a48_0xb4e7,0x890c7));function a48_0xd18f(_0x4428bc,_0x44d264){const _0xb4e7d7=a48_0xb4e7();return a48_0xd18f=function(_0xd18fc1,_0x15a72e){_0xd18fc1=_0xd18fc1-0xda;let _0x1b5879=_0xb4e7d7[_0xd18fc1];return _0x1b5879;},a48_0xd18f(_0x4428bc,_0x44d264);}Object[a48_0x4f968c(0x12e)](exports,a48_0x4f968c(0x132),{'value':!![]}),exports[a48_0x4f968c(0xdd)]=void 0x0;const loggerService_1=require(a48_0x4f968c(0xe1));class CoinToPay2Service{constructor(){const _0x37805f=a48_0x4f968c;this[_0x37805f(0x117)]=_0x37805f(0x142),this[_0x37805f(0x112)]=_0x37805f(0xf9),console[_0x37805f(0xe5)]('ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy'),console['log'](_0x37805f(0x128),this[_0x37805f(0x112)]);}async[a48_0x4f968c(0x15c)](_0x712f7){const _0x2f10c0=a48_0x4f968c,{orderId:_0x33568f,amount:_0x376cc8}=_0x712f7;console[_0x2f10c0(0xe5)](_0x2f10c0(0x139)+_0x376cc8+'\x20EUR');const _0x370605={'amount':_0x376cc8},_0x2b2fcb=Date['now']();try{console[_0x2f10c0(0xe5)]('===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20==='),console['log'](_0x2f10c0(0xe0),this[_0x2f10c0(0x117)]),console[_0x2f10c0(0xe5)]('Request\x20Body:',JSON['stringify'](_0x370605,null,0x2)),console[_0x2f10c0(0xe5)](_0x2f10c0(0x15d),_0x376cc8,_0x2f10c0(0x143)),loggerService_1[_0x2f10c0(0x137)][_0x2f10c0(0x158)](_0x2f10c0(0xee),_0x2f10c0(0x125),_0x2f10c0(0x10c),_0x370605);const _0x36f1cf=await fetch(this[_0x2f10c0(0x117)],{'method':'POST','headers':{'Content-Type':_0x2f10c0(0xfe),'Accept':_0x2f10c0(0xfe),'User-Agent':'Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON[_0x2f10c0(0xe4)](_0x370605)}),_0x3d9d70=Date[_0x2f10c0(0x149)]()-_0x2b2fcb;console[_0x2f10c0(0xe5)](_0x2f10c0(0x150)),console[_0x2f10c0(0xe5)](_0x2f10c0(0x12b),_0x36f1cf['status']),console[_0x2f10c0(0xe5)]('Status\x20Text:',_0x36f1cf[_0x2f10c0(0x14b)]),console['log'](_0x2f10c0(0xe8),Object[_0x2f10c0(0x120)](_0x36f1cf['headers']['entries']())),console[_0x2f10c0(0xe5)](_0x2f10c0(0xea),_0x3d9d70+'ms');const _0x2247de=await _0x36f1cf['text']();console[_0x2f10c0(0xe5)](_0x2f10c0(0x11d),_0x2247de);if(!_0x36f1cf['ok']){console[_0x2f10c0(0x116)](_0x2f10c0(0x10e)),console['error'](_0x2f10c0(0x10a),_0x36f1cf[_0x2f10c0(0xde)]),console[_0x2f10c0(0x116)](_0x2f10c0(0x13d),_0x2247de),loggerService_1[_0x2f10c0(0x137)]['logWhiteDomainResponse'](_0x2f10c0(0xee),_0x2f10c0(0x125),_0x36f1cf['status'],_0x2247de,_0x3d9d70),loggerService_1['loggerService']['logWhiteDomainError'](_0x2f10c0(0xee),_0x2f10c0(0x125),_0x2f10c0(0xeb)+_0x36f1cf['status']+':\x20'+_0x2247de);throw new Error(_0x2f10c0(0x12f)+_0x36f1cf[_0x2f10c0(0xde)]+_0x2f10c0(0x15a)+_0x2247de);}let _0x413381;try{_0x413381=JSON['parse'](_0x2247de);}catch(_0x2f9e72){console['error'](_0x2f10c0(0xda),_0x2f9e72),loggerService_1[_0x2f10c0(0x137)][_0x2f10c0(0x15e)](_0x2f10c0(0xee),'/create','JSON\x20Parse\x20Error:\x20'+_0x2f9e72);throw new Error(_0x2f10c0(0x130)+_0x2247de);}console[_0x2f10c0(0xe5)](_0x2f10c0(0xf4)),console['log'](_0x2f10c0(0x122),JSON['stringify'](_0x413381,null,0x2)),loggerService_1[_0x2f10c0(0x137)][_0x2f10c0(0x101)](_0x2f10c0(0xee),_0x2f10c0(0x125),_0x36f1cf[_0x2f10c0(0xde)],_0x413381,_0x3d9d70);if(_0x413381[_0x2f10c0(0x116)]){const _0x4dde7c=_0x413381['message']||_0x413381[_0x2f10c0(0x116)]||_0x2f10c0(0x15b);console[_0x2f10c0(0x116)](_0x2f10c0(0xfd)),console[_0x2f10c0(0x116)](_0x2f10c0(0x111),_0x4dde7c),loggerService_1['loggerService'][_0x2f10c0(0x15e)]('cointopay2',_0x2f10c0(0x125),'Business\x20Error:\x20'+_0x4dde7c);throw new Error(_0x2f10c0(0xdf)+_0x4dde7c);}if(!_0x413381[_0x2f10c0(0xdb)]||!_0x413381[_0x2f10c0(0x147)]){console['error'](_0x2f10c0(0xdc)),console[_0x2f10c0(0x116)](_0x2f10c0(0x121)),console[_0x2f10c0(0x116)]('Response\x20data:',_0x413381),loggerService_1[_0x2f10c0(0x137)][_0x2f10c0(0x15e)](_0x2f10c0(0xee),_0x2f10c0(0x125),'Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id');}console['log'](_0x2f10c0(0x11a)),console[_0x2f10c0(0xe5)]('Gateway\x20Payment\x20ID:',_0x413381['gateway_payment_id']),console[_0x2f10c0(0xe5)](_0x2f10c0(0x107),_0x413381[_0x2f10c0(0xdb)]);const _0x5824d2=_0x413381['payment_url']+_0x2f10c0(0x110);return console['log'](_0x2f10c0(0xf6),_0x5824d2),console[_0x2f10c0(0xe5)](_0x2f10c0(0x15d),_0x376cc8,_0x2f10c0(0x14d)),{'gateway_payment_id':_0x413381[_0x2f10c0(0x147)],'payment_url':_0x5824d2};}catch(_0x4841c5){console[_0x2f10c0(0x116)]('===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20==='),console['error'](_0x2f10c0(0x156),_0x4841c5),loggerService_1[_0x2f10c0(0x137)]['logWhiteDomainError'](_0x2f10c0(0xee),_0x2f10c0(0x125),_0x4841c5);if(_0x4841c5 instanceof Error){console['error'](_0x2f10c0(0x11f),_0x4841c5[_0x2f10c0(0x138)]),console[_0x2f10c0(0x116)]('Error\x20stack:',_0x4841c5[_0x2f10c0(0x105)]);throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20'+_0x4841c5[_0x2f10c0(0x138)]);}throw new Error(_0x2f10c0(0xfa));}}async['checkPaymentStatus'](_0x5b5967){const _0x448c35=a48_0x4f968c,_0xd1c5de=Date[_0x448c35(0x149)]();try{console[_0x448c35(0xe5)](_0x448c35(0xef)+_0x5b5967);const _0x5e519d={'gatewayPaymentId':_0x5b5967};loggerService_1[_0x448c35(0x137)][_0x448c35(0x158)]('cointopay2',_0x448c35(0x115),_0x448c35(0x10c),_0x5e519d);const _0x2e237a=await fetch(this[_0x448c35(0x112)],{'method':'POST','headers':{'Content-Type':_0x448c35(0xfe),'Accept':_0x448c35(0xfe),'User-Agent':_0x448c35(0x13f)},'body':JSON['stringify'](_0x5e519d)}),_0x1320a1=Date[_0x448c35(0x149)]()-_0xd1c5de;console[_0x448c35(0xe5)]('===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20==='),console[_0x448c35(0xe5)]('Status:',_0x2e237a['status']),console['log'](_0x448c35(0xea),_0x1320a1+'ms');if(!_0x2e237a['ok']){const _0x22dd50=await _0x2e237a[_0x448c35(0x13a)]();console['error'](_0x448c35(0x10a),_0x2e237a[_0x448c35(0xde)]),console[_0x448c35(0x116)](_0x448c35(0x13d),_0x22dd50),loggerService_1[_0x448c35(0x137)]['logWhiteDomainResponse'](_0x448c35(0xee),_0x448c35(0x115),_0x2e237a[_0x448c35(0xde)],_0x22dd50,_0x1320a1),loggerService_1[_0x448c35(0x137)]['logWhiteDomainError'](_0x448c35(0xee),_0x448c35(0x115),_0x448c35(0xeb)+_0x2e237a['status']+':\x20'+_0x22dd50);throw new Error('HTTP\x20error!\x20status:\x20'+_0x2e237a[_0x448c35(0xde)]);}const _0x4ece64=await _0x2e237a[_0x448c35(0x13a)]();console[_0x448c35(0xe5)]('Raw\x20Response\x20Body:',_0x4ece64);let _0x4baca7;try{_0x4baca7=JSON[_0x448c35(0x129)](_0x4ece64);}catch(_0x384d0e){console[_0x448c35(0x116)](_0x448c35(0xda),_0x384d0e),loggerService_1[_0x448c35(0x137)][_0x448c35(0x15e)](_0x448c35(0xee),'/status',_0x448c35(0x14e)+_0x384d0e);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20'+_0x4ece64);}loggerService_1['loggerService'][_0x448c35(0x101)](_0x448c35(0xee),_0x448c35(0x115),_0x2e237a[_0x448c35(0xde)],_0x4baca7,_0x1320a1),console['log']('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console[_0x448c35(0xe5)](_0x448c35(0xe7),_0x4baca7[_0x448c35(0x126)]),console[_0x448c35(0xe5)](_0x448c35(0x104),_0x4baca7[_0x448c35(0x145)]),console[_0x448c35(0xe5)](_0x448c35(0x11b),_0x4baca7[_0x448c35(0xf0)]?.[_0x448c35(0x10f)]),console[_0x448c35(0xe5)](_0x448c35(0x15d),_0x4baca7[_0x448c35(0xf0)]?.[_0x448c35(0xf2)]),console['log'](_0x448c35(0x113),_0x4baca7[_0x448c35(0xf0)]?.[_0x448c35(0xf1)]);if(_0x4baca7[_0x448c35(0x126)]!==_0x448c35(0xed)||_0x4baca7[_0x448c35(0x145)]!==0xc8){const _0x4eb176=_0x4baca7['message']||_0x448c35(0xf5);console[_0x448c35(0x116)](_0x448c35(0x119)),console[_0x448c35(0x116)](_0x448c35(0x111),_0x4eb176),loggerService_1[_0x448c35(0x137)][_0x448c35(0x15e)]('cointopay2','/status','Status\x20API\x20Error:\x20'+_0x4eb176);throw new Error('CoinToPay2\x20status\x20API\x20error:\x20'+_0x4eb176);}if(!_0x4baca7['data']){console[_0x448c35(0x116)]('===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console['error']('Missing\x20data\x20in\x20response'),loggerService_1['loggerService']['logWhiteDomainError']('cointopay2',_0x448c35(0x115),_0x448c35(0x148));throw new Error(_0x448c35(0x127));}let _0x47bc91=_0x448c35(0x12a);switch(_0x4baca7['data'][_0x448c35(0x10f)]?.[_0x448c35(0x11c)]()){case _0x448c35(0x102):_0x47bc91=_0x448c35(0x152);break;case _0x448c35(0xff):case'failed':case'error':_0x47bc91=_0x448c35(0x159);break;case _0x448c35(0x140):case'timeout':_0x47bc91=_0x448c35(0x155);break;case'waiting':case _0x448c35(0x160):case _0x448c35(0x153):case _0x448c35(0x12d):default:_0x47bc91='PENDING';break;}let _0xc6ab8,_0x5bd96c;if(_0x4baca7['data']['PaymentDetail']){const _0x13be23=_0x4baca7[_0x448c35(0xf0)]['PaymentDetail'];console[_0x448c35(0xe5)](_0x448c35(0x100),_0x13be23);const _0x158f0d=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x1ba245 of _0x158f0d){const _0x3561be=_0x13be23[_0x448c35(0x118)](_0x1ba245);if(_0x3561be){_0xc6ab8=_0x3561be[0x1],console[_0x448c35(0xe5)](_0x448c35(0xe9),_0xc6ab8,_0x448c35(0x106),_0x1ba245[_0x448c35(0x11e)]);break;}}if(!_0xc6ab8){console['log'](_0x448c35(0x13c));const _0x1621b7=_0x13be23['match'](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x1621b7&&(_0xc6ab8=_0x1621b7[0x1],console['log'](_0x448c35(0xf8),_0xc6ab8));}_0x5bd96c=_0x13be23;}const _0x4cce4e={'iban':_0xc6ab8,'bankDetails':_0x5bd96c,'transactionId':_0x4baca7[_0x448c35(0xf0)][_0x448c35(0x103)],'coinAddress':_0x4baca7[_0x448c35(0xf0)]['coinAddress'],'qrCodeUrl':_0x4baca7[_0x448c35(0xf0)][_0x448c35(0x14f)],'expiryTime':_0x4baca7['data'][_0x448c35(0x109)],'createdOn':_0x4baca7[_0x448c35(0xf0)][_0x448c35(0x124)],'confirmedOn':_0x4baca7['data'][_0x448c35(0xe3)]};console[_0x448c35(0xe5)](_0x448c35(0xec)),console[_0x448c35(0xe5)](_0x448c35(0x12b),_0x4baca7[_0x448c35(0xf0)]['Status'],'->',_0x47bc91),console[_0x448c35(0xe5)](_0x448c35(0x15d),_0x4baca7[_0x448c35(0xf0)][_0x448c35(0xf2)],_0x4baca7[_0x448c35(0xf0)]['inputCurrency']),console[_0x448c35(0xe5)](_0x448c35(0x10b),_0x4baca7[_0x448c35(0xf0)][_0x448c35(0x103)]),console['log'](_0x448c35(0x12c),_0xc6ab8||_0x448c35(0x14c)),console['log'](_0x448c35(0x154),_0x4baca7[_0x448c35(0xf0)][_0x448c35(0x124)]),console[_0x448c35(0xe5)](_0x448c35(0xfc),_0x4baca7[_0x448c35(0xf0)][_0x448c35(0xe3)]||_0x448c35(0x13b));if(_0x4baca7[_0x448c35(0xf0)][_0x448c35(0x10f)]?.[_0x448c35(0x11c)]()==='awaiting\x20fiat')console['log'](_0x448c35(0xe2));else _0x4baca7[_0x448c35(0xf0)][_0x448c35(0x10f)]?.[_0x448c35(0x11c)]()==='paid'&&console[_0x448c35(0xe5)]('‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID');return{'status':_0x47bc91,'amount':parseFloat(_0x4baca7[_0x448c35(0xf0)][_0x448c35(0xf2)])||undefined,'currency':_0x4baca7[_0x448c35(0xf0)][_0x448c35(0xf1)]||_0x448c35(0x14d),'paymentDetails':_0x4cce4e};}catch(_0xea851f){console[_0x448c35(0x116)](_0x448c35(0x157),_0xea851f),loggerService_1['loggerService'][_0x448c35(0x15e)]('cointopay2',_0x448c35(0x115),_0xea851f);throw new Error(_0x448c35(0x14a)+(_0xea851f instanceof Error?_0xea851f[_0x448c35(0x138)]:_0x448c35(0x161)));}}async[a48_0x4f968c(0x151)](_0x4cecd2){const _0x404fca=a48_0x4f968c,_0x23013a=await this[_0x404fca(0x123)](_0x4cecd2);return{'status':_0x23013a[_0x404fca(0xde)],'amount':_0x23013a[_0x404fca(0x133)],'currency':_0x23013a[_0x404fca(0x10d)]};}async[a48_0x4f968c(0x135)](_0x5e8df1){const _0x4a8656=a48_0x4f968c;console[_0x4a8656(0xe5)](_0x4a8656(0xfb),_0x5e8df1);let _0x1f9bfa=_0x4a8656(0x12a);switch(_0x5e8df1[_0x4a8656(0xde)]?.[_0x4a8656(0x11c)]()){case _0x4a8656(0x102):_0x1f9bfa=_0x4a8656(0x152);break;case'cancelled':case _0x4a8656(0x146):case _0x4a8656(0x116):_0x1f9bfa=_0x4a8656(0x159);break;case _0x4a8656(0x140):case'timeout':_0x1f9bfa='EXPIRED';break;case _0x4a8656(0x153):case'waiting':case'awaiting\x20fiat':case _0x4a8656(0x12d):default:_0x1f9bfa=_0x4a8656(0x12a);break;}return{'paymentId':_0x5e8df1[_0x4a8656(0x13e)]||_0x5e8df1['merchant_reference_id']||'','status':_0x1f9bfa,'amount':_0x5e8df1[_0x4a8656(0x133)],'currency':_0x5e8df1[_0x4a8656(0x10d)]||_0x4a8656(0x14d)};}}exports['CoinToPay2Service']=CoinToPay2Service;