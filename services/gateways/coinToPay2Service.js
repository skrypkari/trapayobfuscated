'use strict';const a56_0x3fadfb=a56_0x4086;function a56_0x1fe5(){const _0x69f01d=['status_code','URL:','Payment\x20Status:','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','stringify','&alternative=false','/status','14958320ubIszw','failed','IBAN:','https://traffer.uk/gateway/cointopay/status.php','Status\x20API\x20Error:\x20','timeout','Headers:','coinAddress','Currency:','log','Payment\x20URL\x20(modified):','\x20EUR','logWhiteDomainError','3118056YUhzpQ','statusUrl','360189dlHmqL','waiting','CreatedOn','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','success','===\x20COINTOPAY2\x20API\x20ERROR\x20===','HTTP\x20','Amount','__esModule','awaiting\x20fiat','Error\x20message:','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','createPaymentLink','Payment\x20URL\x20(original):','Request\x20Body:','Transaction\x20ID:','loggerService','2897461dhAOTG','match','EXPIRED','created','Created\x20On:','Parsed\x20Result:','/create','Result:','stack','message','amount','order_id','12qspwUM','apiUrl','Unknown\x20error','PaymentDetail','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','Incomplete\x20response:\x20missing\x20data','logWhiteDomainResponse','merchant_reference_id','FAILED','payment_url','not\x20found','data','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','expired','2835535yYnYhd','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','PENDING','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','Response\x20Body:','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','source','parse','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','headers','pending','üè¶\x20Extracted\x20IBAN:','cointopay2','application/json','processWebhook','PAID','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','using\x20pattern:','../loggerService','Confirmed\x20On:','statusText','Raw\x20Response\x20Body:','Missing\x20data\x20in\x20response','inputCurrency','text','ExpiryTime','üìä\x20Status\x20check\x20URL:','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','Unknown\x20error\x20from\x20CoinToPay2\x20API','Error\x20Message:','EUR','QRCodeURL','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','currency','checkPaymentStatus','Error\x20stack:','Status','result','Error\x20details:','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','error','Status\x20Text:','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','CoinToPay2\x20API\x20error:\x20','JSON\x20Parse\x20Error:\x20','Status:','gateway_payment_id','fromEntries','paid','HTTP\x20Status:','now','https://traffer.uk/gateway/cointopay/','TransactionConfirmedOn','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','Amount:',',\x20body:\x20','962211hvaSyg','Response\x20Time:','Payment\x20System/1.0\x20(CoinToPay2)','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','cancelled','153388fyzkaf','verifyPayment','entries','POST','status','toLowerCase'];a56_0x1fe5=function(){return _0x69f01d;};return a56_0x1fe5();}(function(_0x5ebc6f,_0x50c547){const _0x6b9578=a56_0x4086,_0x35daed=_0x5ebc6f();while(!![]){try{const _0x294386=parseInt(_0x6b9578(0x1a5))/0x1+parseInt(_0x6b9578(0x189))/0x2+parseInt(_0x6b9578(0x184))/0x3+-parseInt(_0x6b9578(0x1a3))/0x4+-parseInt(_0x6b9578(0x1d0))/0x5+parseInt(_0x6b9578(0x1c2))/0x6*(-parseInt(_0x6b9578(0x1b6))/0x7)+parseInt(_0x6b9578(0x196))/0x8;if(_0x294386===_0x50c547)break;else _0x35daed['push'](_0x35daed['shift']());}catch(_0x41907a){_0x35daed['push'](_0x35daed['shift']());}}}(a56_0x1fe5,0x6e94f));Object['defineProperty'](exports,a56_0x3fadfb(0x1ad),{'value':!![]}),exports['CoinToPay2Service']=void 0x0;const loggerService_1=require(a56_0x3fadfb(0x1e3));function a56_0x4086(_0x58362e,_0x285e98){_0x58362e=_0x58362e-0x168;const _0x1fe5d7=a56_0x1fe5();let _0x408680=_0x1fe5d7[_0x58362e];return _0x408680;}class CoinToPay2Service{constructor(){const _0xe5f736=a56_0x3fadfb;this[_0xe5f736(0x1c3)]=_0xe5f736(0x17f),this[_0xe5f736(0x1a4)]=_0xe5f736(0x199),console[_0xe5f736(0x19f)](_0xe5f736(0x1e1)),console['log'](_0xe5f736(0x1eb),this[_0xe5f736(0x1a4)]);}async[a56_0x3fadfb(0x1b1)](_0xb8038){const _0x3e7464=a56_0x3fadfb,{orderId:_0x1738fb,amount:_0x117e25}=_0xb8038;console[_0x3e7464(0x19f)]('ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20'+_0x117e25+_0x3e7464(0x1a1));const _0x588875={'amount':_0x117e25},_0x1eec27=Date[_0x3e7464(0x17e)]();try{console[_0x3e7464(0x19f)](_0x3e7464(0x1ed)),console[_0x3e7464(0x19f)](_0x3e7464(0x190),this[_0x3e7464(0x1c3)]),console[_0x3e7464(0x19f)](_0x3e7464(0x1b3),JSON['stringify'](_0x588875,null,0x2)),console[_0x3e7464(0x19f)](_0x3e7464(0x182),_0x117e25,'EUR\x20(always\x20EUR\x20for\x20CoinToPay2)'),loggerService_1[_0x3e7464(0x1b5)]['logWhiteDomainRequest'](_0x3e7464(0x1dd),_0x3e7464(0x1bc),_0x3e7464(0x18c),_0x588875);const _0x34e8ef=await fetch(this[_0x3e7464(0x1c3)],{'method':_0x3e7464(0x18c),'headers':{'Content-Type':'application/json','Accept':_0x3e7464(0x1de),'User-Agent':_0x3e7464(0x186)},'body':JSON[_0x3e7464(0x193)](_0x588875)}),_0x8d24bd=Date[_0x3e7464(0x17e)]()-_0x1eec27;console[_0x3e7464(0x19f)](_0x3e7464(0x1d6)),console[_0x3e7464(0x19f)](_0x3e7464(0x179),_0x34e8ef['status']),console['log'](_0x3e7464(0x175),_0x34e8ef[_0x3e7464(0x1e5)]),console[_0x3e7464(0x19f)](_0x3e7464(0x19c),Object[_0x3e7464(0x17b)](_0x34e8ef[_0x3e7464(0x1da)][_0x3e7464(0x18b)]())),console[_0x3e7464(0x19f)](_0x3e7464(0x185),_0x8d24bd+'ms');const _0x52d3f8=await _0x34e8ef['text']();console['log'](_0x3e7464(0x1e6),_0x52d3f8);if(!_0x34e8ef['ok']){console[_0x3e7464(0x174)](_0x3e7464(0x1aa)),console['error']('HTTP\x20Status:',_0x34e8ef[_0x3e7464(0x18d)]),console[_0x3e7464(0x174)](_0x3e7464(0x1d5),_0x52d3f8),loggerService_1[_0x3e7464(0x1b5)][_0x3e7464(0x1c8)](_0x3e7464(0x1dd),'/create',_0x34e8ef[_0x3e7464(0x18d)],_0x52d3f8,_0x8d24bd),loggerService_1['loggerService'][_0x3e7464(0x1a2)](_0x3e7464(0x1dd),_0x3e7464(0x1bc),_0x3e7464(0x1ab)+_0x34e8ef['status']+':\x20'+_0x52d3f8);throw new Error('HTTP\x20error!\x20status:\x20'+_0x34e8ef[_0x3e7464(0x18d)]+_0x3e7464(0x183)+_0x52d3f8);}let _0x54430b;try{_0x54430b=JSON[_0x3e7464(0x1d8)](_0x52d3f8);}catch(_0x5dca35){console[_0x3e7464(0x174)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x5dca35),loggerService_1[_0x3e7464(0x1b5)][_0x3e7464(0x1a2)](_0x3e7464(0x1dd),'/create',_0x3e7464(0x178)+_0x5dca35);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20'+_0x52d3f8);}console[_0x3e7464(0x19f)](_0x3e7464(0x187)),console[_0x3e7464(0x19f)](_0x3e7464(0x1bb),JSON[_0x3e7464(0x193)](_0x54430b,null,0x2)),loggerService_1[_0x3e7464(0x1b5)][_0x3e7464(0x1c8)](_0x3e7464(0x1dd),_0x3e7464(0x1bc),_0x34e8ef[_0x3e7464(0x18d)],_0x54430b,_0x8d24bd);if(_0x54430b[_0x3e7464(0x174)]){const _0x20bff9=_0x54430b['message']||_0x54430b['error']||_0x3e7464(0x168);console[_0x3e7464(0x174)](_0x3e7464(0x1d2)),console[_0x3e7464(0x174)](_0x3e7464(0x169),_0x20bff9),loggerService_1['loggerService'][_0x3e7464(0x1a2)]('cointopay2',_0x3e7464(0x1bc),'Business\x20Error:\x20'+_0x20bff9);throw new Error(_0x3e7464(0x177)+_0x20bff9);}if(!_0x54430b['payment_url']||!_0x54430b['gateway_payment_id']){console[_0x3e7464(0x174)](_0x3e7464(0x1ec)),console[_0x3e7464(0x174)](_0x3e7464(0x1b0)),console['error']('Response\x20data:',_0x54430b),loggerService_1[_0x3e7464(0x1b5)][_0x3e7464(0x1a2)](_0x3e7464(0x1dd),_0x3e7464(0x1bc),_0x3e7464(0x1d1));throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id');}console[_0x3e7464(0x19f)]('===\x20COINTOPAY2\x20SUCCESS\x20==='),console[_0x3e7464(0x19f)]('Gateway\x20Payment\x20ID:',_0x54430b[_0x3e7464(0x17a)]),console[_0x3e7464(0x19f)](_0x3e7464(0x1b2),_0x54430b[_0x3e7464(0x1cb)]);const _0x14fdbe=_0x54430b[_0x3e7464(0x1cb)]+_0x3e7464(0x194);return console[_0x3e7464(0x19f)](_0x3e7464(0x1a0),_0x14fdbe),console[_0x3e7464(0x19f)](_0x3e7464(0x182),_0x117e25,'EUR'),{'gateway_payment_id':_0x54430b[_0x3e7464(0x17a)],'payment_url':_0x14fdbe};}catch(_0x3a0745){console[_0x3e7464(0x174)]('===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20==='),console[_0x3e7464(0x174)](_0x3e7464(0x172),_0x3a0745),loggerService_1[_0x3e7464(0x1b5)][_0x3e7464(0x1a2)](_0x3e7464(0x1dd),'/create',_0x3a0745);if(_0x3a0745 instanceof Error){console[_0x3e7464(0x174)](_0x3e7464(0x1af),_0x3a0745[_0x3e7464(0x1bf)]),console[_0x3e7464(0x174)](_0x3e7464(0x16f),_0x3a0745[_0x3e7464(0x1be)]);throw new Error(_0x3e7464(0x181)+_0x3a0745[_0x3e7464(0x1bf)]);}throw new Error(_0x3e7464(0x16c));}}async[a56_0x3fadfb(0x16e)](_0x170cb4){const _0x16371f=a56_0x3fadfb,_0x276786=Date[_0x16371f(0x17e)]();try{console['log'](_0x16371f(0x1ce)+_0x170cb4);const _0x15ce86={'gatewayPaymentId':_0x170cb4};loggerService_1['loggerService']['logWhiteDomainRequest'](_0x16371f(0x1dd),_0x16371f(0x195),_0x16371f(0x18c),_0x15ce86);const _0x653898=await fetch(this['statusUrl'],{'method':'POST','headers':{'Content-Type':_0x16371f(0x1de),'Accept':_0x16371f(0x1de),'User-Agent':_0x16371f(0x186)},'body':JSON[_0x16371f(0x193)](_0x15ce86)}),_0xee1aea=Date[_0x16371f(0x17e)]()-_0x276786;console[_0x16371f(0x19f)](_0x16371f(0x1d4)),console['log'](_0x16371f(0x179),_0x653898['status']),console['log'](_0x16371f(0x185),_0xee1aea+'ms');if(!_0x653898['ok']){const _0x440fbd=await _0x653898[_0x16371f(0x1e9)]();console[_0x16371f(0x174)](_0x16371f(0x17d),_0x653898[_0x16371f(0x18d)]),console['error'](_0x16371f(0x1d5),_0x440fbd),loggerService_1['loggerService'][_0x16371f(0x1c8)](_0x16371f(0x1dd),_0x16371f(0x195),_0x653898[_0x16371f(0x18d)],_0x440fbd,_0xee1aea),loggerService_1[_0x16371f(0x1b5)]['logWhiteDomainError']('cointopay2',_0x16371f(0x195),'HTTP\x20'+_0x653898[_0x16371f(0x18d)]+':\x20'+_0x440fbd);throw new Error('HTTP\x20error!\x20status:\x20'+_0x653898[_0x16371f(0x18d)]);}const _0x35eea8=await _0x653898[_0x16371f(0x1e9)]();console['log']('Raw\x20Response\x20Body:',_0x35eea8);let _0x2a13cf;try{_0x2a13cf=JSON['parse'](_0x35eea8);}catch(_0x4329f5){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0x4329f5),loggerService_1['loggerService']['logWhiteDomainError'](_0x16371f(0x1dd),'/status',_0x16371f(0x178)+_0x4329f5);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20'+_0x35eea8);}loggerService_1[_0x16371f(0x1b5)][_0x16371f(0x1c8)]('cointopay2','/status',_0x653898[_0x16371f(0x18d)],_0x2a13cf,_0xee1aea),console[_0x16371f(0x19f)](_0x16371f(0x176)),console['log'](_0x16371f(0x1bd),_0x2a13cf[_0x16371f(0x171)]),console[_0x16371f(0x19f)]('Status\x20Code:',_0x2a13cf['status_code']),console[_0x16371f(0x19f)](_0x16371f(0x191),_0x2a13cf['data']?.[_0x16371f(0x170)]),console[_0x16371f(0x19f)](_0x16371f(0x182),_0x2a13cf[_0x16371f(0x1cd)]?.[_0x16371f(0x1ac)]),console[_0x16371f(0x19f)](_0x16371f(0x19e),_0x2a13cf[_0x16371f(0x1cd)]?.[_0x16371f(0x1e8)]);if(_0x2a13cf[_0x16371f(0x171)]!==_0x16371f(0x1a9)||_0x2a13cf[_0x16371f(0x18f)]!==0xc8){const _0xff41a8=_0x2a13cf[_0x16371f(0x1bf)]||'Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API';console[_0x16371f(0x174)]('===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20==='),console[_0x16371f(0x174)](_0x16371f(0x169),_0xff41a8),loggerService_1[_0x16371f(0x1b5)][_0x16371f(0x1a2)](_0x16371f(0x1dd),_0x16371f(0x195),_0x16371f(0x19a)+_0xff41a8);throw new Error('CoinToPay2\x20status\x20API\x20error:\x20'+_0xff41a8);}if(!_0x2a13cf[_0x16371f(0x1cd)]){console[_0x16371f(0x174)]('===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x16371f(0x174)](_0x16371f(0x1e7)),loggerService_1[_0x16371f(0x1b5)][_0x16371f(0x1a2)](_0x16371f(0x1dd),_0x16371f(0x195),_0x16371f(0x1c7));throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data');}let _0x3e53fb=_0x16371f(0x1d3);switch(_0x2a13cf['data']['Status']?.[_0x16371f(0x18e)]()){case _0x16371f(0x17c):_0x3e53fb=_0x16371f(0x1e0);break;case'cancelled':case _0x16371f(0x197):case _0x16371f(0x174):_0x3e53fb=_0x16371f(0x1ca);break;case _0x16371f(0x1cf):case'timeout':_0x3e53fb=_0x16371f(0x1b8);break;case _0x16371f(0x1a6):case _0x16371f(0x1ae):case'pending':case _0x16371f(0x1b9):default:_0x3e53fb=_0x16371f(0x1d3);break;}let _0x32aca9,_0x1cd9d1;if(_0x2a13cf[_0x16371f(0x1cd)][_0x16371f(0x1c5)]){const _0x201be6=_0x2a13cf[_0x16371f(0x1cd)][_0x16371f(0x1c5)];console[_0x16371f(0x19f)]('üè¶\x20Payment\x20Detail:',_0x201be6);const _0x33dcab=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x2a9708 of _0x33dcab){const _0x3bbaea=_0x201be6[_0x16371f(0x1b7)](_0x2a9708);if(_0x3bbaea){_0x32aca9=_0x3bbaea[0x1],console[_0x16371f(0x19f)](_0x16371f(0x1dc),_0x32aca9,_0x16371f(0x1e2),_0x2a9708[_0x16371f(0x1d7)]);break;}}if(!_0x32aca9){console[_0x16371f(0x19f)](_0x16371f(0x1c6));const _0x2f7d0b=_0x201be6['match'](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x2f7d0b&&(_0x32aca9=_0x2f7d0b[0x1],console[_0x16371f(0x19f)]('üè¶\x20Extracted\x20IBAN\x20via\x20fallback:',_0x32aca9));}_0x1cd9d1=_0x201be6;}const _0x390e16={'iban':_0x32aca9,'bankDetails':_0x1cd9d1,'transactionId':_0x2a13cf[_0x16371f(0x1cd)]['TransactionID'],'coinAddress':_0x2a13cf[_0x16371f(0x1cd)][_0x16371f(0x19d)],'qrCodeUrl':_0x2a13cf[_0x16371f(0x1cd)][_0x16371f(0x16b)],'expiryTime':_0x2a13cf[_0x16371f(0x1cd)][_0x16371f(0x1ea)],'createdOn':_0x2a13cf[_0x16371f(0x1cd)][_0x16371f(0x1a7)],'confirmedOn':_0x2a13cf[_0x16371f(0x1cd)]['TransactionConfirmedOn']};console[_0x16371f(0x19f)](_0x16371f(0x1d9)),console['log'](_0x16371f(0x179),_0x2a13cf[_0x16371f(0x1cd)][_0x16371f(0x170)],'->',_0x3e53fb),console[_0x16371f(0x19f)](_0x16371f(0x182),_0x2a13cf[_0x16371f(0x1cd)][_0x16371f(0x1ac)],_0x2a13cf[_0x16371f(0x1cd)]['inputCurrency']),console[_0x16371f(0x19f)](_0x16371f(0x1b4),_0x2a13cf['data']['TransactionID']),console['log'](_0x16371f(0x198),_0x32aca9||_0x16371f(0x1cc)),console[_0x16371f(0x19f)](_0x16371f(0x1ba),_0x2a13cf['data'][_0x16371f(0x1a7)]),console[_0x16371f(0x19f)](_0x16371f(0x1e4),_0x2a13cf[_0x16371f(0x1cd)][_0x16371f(0x180)]||'not\x20confirmed');if(_0x2a13cf[_0x16371f(0x1cd)]['Status']?.['toLowerCase']()===_0x16371f(0x1ae))console[_0x16371f(0x19f)](_0x16371f(0x173));else _0x2a13cf[_0x16371f(0x1cd)][_0x16371f(0x170)]?.[_0x16371f(0x18e)]()==='paid'&&console[_0x16371f(0x19f)](_0x16371f(0x1a8));return{'status':_0x3e53fb,'amount':parseFloat(_0x2a13cf[_0x16371f(0x1cd)][_0x16371f(0x1ac)])||undefined,'currency':_0x2a13cf[_0x16371f(0x1cd)][_0x16371f(0x1e8)]||_0x16371f(0x16a),'paymentDetails':_0x390e16};}catch(_0x36b59a){console[_0x16371f(0x174)]('CoinToPay2\x20payment\x20status\x20check\x20error:',_0x36b59a),loggerService_1[_0x16371f(0x1b5)][_0x16371f(0x1a2)](_0x16371f(0x1dd),_0x16371f(0x195),_0x36b59a);throw new Error('Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20'+(_0x36b59a instanceof Error?_0x36b59a['message']:_0x16371f(0x1c4)));}}async[a56_0x3fadfb(0x18a)](_0x2add42){const _0x5a402f=a56_0x3fadfb,_0xea8978=await this['checkPaymentStatus'](_0x2add42);return{'status':_0xea8978[_0x5a402f(0x18d)],'amount':_0xea8978['amount'],'currency':_0xea8978[_0x5a402f(0x16d)]};}async[a56_0x3fadfb(0x1df)](_0x36efa9){const _0x54f329=a56_0x3fadfb;console[_0x54f329(0x19f)](_0x54f329(0x192),_0x36efa9);let _0x4d5c67=_0x54f329(0x1d3);switch(_0x36efa9['status']?.[_0x54f329(0x18e)]()){case _0x54f329(0x17c):_0x4d5c67=_0x54f329(0x1e0);break;case _0x54f329(0x188):case'failed':case'error':_0x4d5c67=_0x54f329(0x1ca);break;case _0x54f329(0x1cf):case _0x54f329(0x19b):_0x4d5c67=_0x54f329(0x1b8);break;case _0x54f329(0x1db):case _0x54f329(0x1a6):case _0x54f329(0x1ae):case'created':default:_0x4d5c67=_0x54f329(0x1d3);break;}return{'paymentId':_0x36efa9[_0x54f329(0x1c1)]||_0x36efa9[_0x54f329(0x1c9)]||'','status':_0x4d5c67,'amount':_0x36efa9[_0x54f329(0x1c0)],'currency':_0x36efa9['currency']||'EUR'};}}exports['CoinToPay2Service']=CoinToPay2Service;