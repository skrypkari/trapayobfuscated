'use strict';const a40_0x10d6ea=a40_0x1736;(function(_0x471206,_0x39a3fb){const _0x3f1a17=a40_0x1736,_0x3c09a8=_0x471206();while(!![]){try{const _0x3de512=-parseInt(_0x3f1a17(0xab))/0x1*(parseInt(_0x3f1a17(0x82))/0x2)+parseInt(_0x3f1a17(0xd0))/0x3+-parseInt(_0x3f1a17(0xea))/0x4*(-parseInt(_0x3f1a17(0x99))/0x5)+-parseInt(_0x3f1a17(0x9f))/0x6*(parseInt(_0x3f1a17(0xef))/0x7)+parseInt(_0x3f1a17(0x79))/0x8*(-parseInt(_0x3f1a17(0xf2))/0x9)+parseInt(_0x3f1a17(0x6b))/0xa+parseInt(_0x3f1a17(0x6e))/0xb;if(_0x3de512===_0x39a3fb)break;else _0x3c09a8['push'](_0x3c09a8['shift']());}catch(_0x117f55){_0x3c09a8['push'](_0x3c09a8['shift']());}}}(a40_0x53cf,0xdb0a6));Object[a40_0x10d6ea(0xa6)](exports,a40_0x10d6ea(0xbf),{'value':!![]}),exports['CoinToPay2Service']=void 0x0;const loggerService_1=require(a40_0x10d6ea(0xa5));function a40_0x1736(_0x280d38,_0x9f6ebe){const _0x53cfcd=a40_0x53cf();return a40_0x1736=function(_0x17360f,_0x3a1775){_0x17360f=_0x17360f-0x6b;let _0xbe6f8b=_0x53cfcd[_0x17360f];return _0xbe6f8b;},a40_0x1736(_0x280d38,_0x9f6ebe);}function a40_0x53cf(){const _0x4193bc=['ExpiryTime','\x20EUR',',\x20body:\x20','Headers:','===\x20COINTOPAY2\x20API\x20ERROR\x20===','üè¶\x20Payment\x20Detail:','27628gVnTrG','source','Response\x20data:','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','917QAiSOr','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','24579VxIqNs','/status','match','===\x20COINTOPAY2\x20SUCCESS\x20===','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','parse','CoinToPay2\x20payment\x20status\x20check\x20error:','Result:','logWhiteDomainRequest','success','1689140zvbeJm','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','Business\x20Error:\x20','13495339XmeVnJ','currency','Payment\x20Status:','URL:','PENDING','TransactionID','fromEntries','/create','Raw\x20Response\x20Body:','now','CoinToPay2Service','1056jesaaR','created','https://traffer.uk/gateway/cointopay/status.php','expired','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','timeout','gateway_payment_id','43444JDvTix','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','Confirmed\x20On:','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','text','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','Amount:','Payment\x20URL:','error','FAILED','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','PAID','cointopay2','CoinToPay2\x20API\x20error:\x20','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Incomplete\x20response:\x20missing\x20data','JSON\x20Parse\x20Error:\x20','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Currency:','stringify','100KzVIpO','QRCodeURL','Amount','Unknown\x20error\x20from\x20CoinToPay2\x20API','statusUrl','amount','33942IdDSFb','paid','createPaymentLink','https://traffer.uk/gateway/cointopay/','Request\x20Body:','üìä\x20Status\x20check\x20URL:','../loggerService','defineProperty','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','TransactionConfirmedOn','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','stack','19iZwSbS','PaymentDetail','status','not\x20found','cancelled','IBAN:','coinAddress','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','log','checkPaymentStatus','CreatedOn','HTTP\x20','EXPIRED','üè¶\x20Extracted\x20IBAN:','Status\x20Text:','Missing\x20data\x20in\x20response','logWhiteDomainResponse','Status:','Failed\x20to\x20parse\x20JSON\x20response:','apiUrl','__esModule','Response\x20Body:','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','result','Response\x20Time:','statusText','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','Unknown\x20error','awaiting\x20fiat','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','data','Created\x20On:','loggerService','message','merchant_reference_id','logWhiteDomainError','2632692ezcxsH','order_id','Error\x20details:','toLowerCase','payment_url','Gateway\x20Payment\x20ID:','inputCurrency','HTTP\x20Status:','POST','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','application/json','not\x20confirmed','pending','headers','EUR','Error\x20Message:','Error\x20stack:','failed','Status'];a40_0x53cf=function(){return _0x4193bc;};return a40_0x53cf();}class CoinToPay2Service{constructor(){const _0x4d89e7=a40_0x10d6ea;this[_0x4d89e7(0xbe)]=_0x4d89e7(0xa2),this['statusUrl']=_0x4d89e7(0x7b),console[_0x4d89e7(0xb3)](_0x4d89e7(0x8c)),console['log'](_0x4d89e7(0xa4),this[_0x4d89e7(0x9d)]);}async[a40_0x10d6ea(0xa1)](_0x41ada7){const _0x41a646=a40_0x10d6ea,{orderId:_0x3243c8,amount:_0x26b809}=_0x41ada7;console[_0x41a646(0xb3)]('ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20'+_0x26b809+_0x41a646(0xe5));const _0x1d1d7b={'amount':_0x26b809},_0x5aff25=Date[_0x41a646(0x77)]();try{console[_0x41a646(0xb3)](_0x41a646(0x8d)),console[_0x41a646(0xb3)](_0x41a646(0x71),this[_0x41a646(0xbe)]),console[_0x41a646(0xb3)](_0x41a646(0xa3),JSON[_0x41a646(0x98)](_0x1d1d7b,null,0x2)),console['log']('Amount:',_0x26b809,_0x41a646(0x95)),loggerService_1[_0x41a646(0xcc)][_0x41a646(0xfa)](_0x41a646(0x8f),_0x41a646(0x75),_0x41a646(0xd8),_0x1d1d7b);const _0x145f89=await fetch(this['apiUrl'],{'method':_0x41a646(0xd8),'headers':{'Content-Type':_0x41a646(0xdb),'Accept':'application/json','User-Agent':_0x41a646(0xed)},'body':JSON[_0x41a646(0x98)](_0x1d1d7b)}),_0x5c16f0=Date[_0x41a646(0x77)]()-_0x5aff25;console[_0x41a646(0xb3)](_0x41a646(0x83)),console[_0x41a646(0xb3)](_0x41a646(0xbc),_0x145f89[_0x41a646(0xad)]),console[_0x41a646(0xb3)](_0x41a646(0xb9),_0x145f89[_0x41a646(0xc4)]),console[_0x41a646(0xb3)](_0x41a646(0xe7),Object[_0x41a646(0x74)](_0x145f89[_0x41a646(0xde)]['entries']())),console[_0x41a646(0xb3)](_0x41a646(0xc3),_0x5c16f0+'ms');const _0x40bdc3=await _0x145f89[_0x41a646(0x86)]();console[_0x41a646(0xb3)](_0x41a646(0x76),_0x40bdc3);if(!_0x145f89['ok']){console['error'](_0x41a646(0xe8)),console['error'](_0x41a646(0xd7),_0x145f89[_0x41a646(0xad)]),console[_0x41a646(0x8a)](_0x41a646(0xc0),_0x40bdc3),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x41a646(0x8f),_0x41a646(0x75),_0x145f89['status'],_0x40bdc3,_0x5c16f0),loggerService_1[_0x41a646(0xcc)]['logWhiteDomainError']('cointopay2',_0x41a646(0x75),_0x41a646(0xb6)+_0x145f89[_0x41a646(0xad)]+':\x20'+_0x40bdc3);throw new Error('HTTP\x20error!\x20status:\x20'+_0x145f89['status']+_0x41a646(0xe6)+_0x40bdc3);}let _0x22a50a;try{_0x22a50a=JSON['parse'](_0x40bdc3);}catch(_0xbcae9d){console[_0x41a646(0x8a)](_0x41a646(0xbd),_0xbcae9d),loggerService_1[_0x41a646(0xcc)][_0x41a646(0xcf)](_0x41a646(0x8f),'/create',_0x41a646(0x93)+_0xbcae9d);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20'+_0x40bdc3);}console[_0x41a646(0xb3)](_0x41a646(0xf0)),console[_0x41a646(0xb3)]('Parsed\x20Result:',JSON[_0x41a646(0x98)](_0x22a50a,null,0x2)),loggerService_1[_0x41a646(0xcc)]['logWhiteDomainResponse'](_0x41a646(0x8f),_0x41a646(0x75),_0x145f89[_0x41a646(0xad)],_0x22a50a,_0x5c16f0);if(_0x22a50a[_0x41a646(0x8a)]){const _0x3a5e24=_0x22a50a[_0x41a646(0xcd)]||_0x22a50a['error']||_0x41a646(0x9c);console['error'](_0x41a646(0x7f)),console[_0x41a646(0x8a)](_0x41a646(0xe0),_0x3a5e24),loggerService_1['loggerService']['logWhiteDomainError'](_0x41a646(0x8f),_0x41a646(0x75),_0x41a646(0x6d)+_0x3a5e24);throw new Error(_0x41a646(0x90)+_0x3a5e24);}if(!_0x22a50a[_0x41a646(0xd4)]||!_0x22a50a['gateway_payment_id']){console[_0x41a646(0x8a)](_0x41a646(0xc8)),console['error'](_0x41a646(0xda)),console[_0x41a646(0x8a)](_0x41a646(0xec),_0x22a50a),loggerService_1[_0x41a646(0xcc)][_0x41a646(0xcf)](_0x41a646(0x8f),_0x41a646(0x75),_0x41a646(0xf1));throw new Error(_0x41a646(0xc1));}return console[_0x41a646(0xb3)](_0x41a646(0xf5)),console[_0x41a646(0xb3)](_0x41a646(0xd5),_0x22a50a[_0x41a646(0x81)]),console[_0x41a646(0xb3)](_0x41a646(0x89),_0x22a50a[_0x41a646(0xd4)]),console['log'](_0x41a646(0x88),_0x26b809,_0x41a646(0xdf)),{'gateway_payment_id':_0x22a50a[_0x41a646(0x81)],'payment_url':_0x22a50a['payment_url']};}catch(_0x1ee6e5){console[_0x41a646(0x8a)]('===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20==='),console['error'](_0x41a646(0xd2),_0x1ee6e5),loggerService_1[_0x41a646(0xcc)][_0x41a646(0xcf)]('cointopay2',_0x41a646(0x75),_0x1ee6e5);if(_0x1ee6e5 instanceof Error){console[_0x41a646(0x8a)]('Error\x20message:',_0x1ee6e5['message']),console[_0x41a646(0x8a)](_0x41a646(0xe1),_0x1ee6e5[_0x41a646(0xaa)]);throw new Error(_0x41a646(0x85)+_0x1ee6e5[_0x41a646(0xcd)]);}throw new Error(_0x41a646(0x6c));}}async['checkPaymentStatus'](_0x270058){const _0x2dc205=a40_0x10d6ea,_0xccb490=Date[_0x2dc205(0x77)]();try{console['log'](_0x2dc205(0x7e)+_0x270058);const _0x37742e={'gatewayPaymentId':_0x270058};loggerService_1['loggerService'][_0x2dc205(0xfa)](_0x2dc205(0x8f),_0x2dc205(0xf3),_0x2dc205(0xd8),_0x37742e);const _0x2e209a=await fetch(this[_0x2dc205(0x9d)],{'method':_0x2dc205(0xd8),'headers':{'Content-Type':'application/json','Accept':_0x2dc205(0xdb),'User-Agent':_0x2dc205(0xed)},'body':JSON[_0x2dc205(0x98)](_0x37742e)}),_0x2353c9=Date[_0x2dc205(0x77)]()-_0xccb490;console['log']('===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20==='),console[_0x2dc205(0xb3)](_0x2dc205(0xbc),_0x2e209a[_0x2dc205(0xad)]),console[_0x2dc205(0xb3)](_0x2dc205(0xc3),_0x2353c9+'ms');if(!_0x2e209a['ok']){const _0x5da4da=await _0x2e209a[_0x2dc205(0x86)]();console[_0x2dc205(0x8a)](_0x2dc205(0xd7),_0x2e209a[_0x2dc205(0xad)]),console['error']('Response\x20Body:',_0x5da4da),loggerService_1['loggerService'][_0x2dc205(0xbb)](_0x2dc205(0x8f),'/status',_0x2e209a[_0x2dc205(0xad)],_0x5da4da,_0x2353c9),loggerService_1[_0x2dc205(0xcc)][_0x2dc205(0xcf)](_0x2dc205(0x8f),_0x2dc205(0xf3),_0x2dc205(0xb6)+_0x2e209a[_0x2dc205(0xad)]+':\x20'+_0x5da4da);throw new Error('HTTP\x20error!\x20status:\x20'+_0x2e209a['status']);}const _0x1890e8=await _0x2e209a[_0x2dc205(0x86)]();console['log'](_0x2dc205(0x76),_0x1890e8);let _0x43b8b3;try{_0x43b8b3=JSON[_0x2dc205(0xf7)](_0x1890e8);}catch(_0x31c2c4){console[_0x2dc205(0x8a)](_0x2dc205(0xbd),_0x31c2c4),loggerService_1[_0x2dc205(0xcc)][_0x2dc205(0xcf)](_0x2dc205(0x8f),_0x2dc205(0xf3),_0x2dc205(0x93)+_0x31c2c4);throw new Error(_0x2dc205(0xd9)+_0x1890e8);}loggerService_1[_0x2dc205(0xcc)][_0x2dc205(0xbb)]('cointopay2',_0x2dc205(0xf3),_0x2e209a['status'],_0x43b8b3,_0x2353c9),console[_0x2dc205(0xb3)](_0x2dc205(0xa9)),console['log'](_0x2dc205(0xf9),_0x43b8b3[_0x2dc205(0xc2)]),console[_0x2dc205(0xb3)]('Status\x20Code:',_0x43b8b3['status_code']),console[_0x2dc205(0xb3)](_0x2dc205(0x70),_0x43b8b3[_0x2dc205(0xca)]?.['Status']),console[_0x2dc205(0xb3)](_0x2dc205(0x88),_0x43b8b3[_0x2dc205(0xca)]?.[_0x2dc205(0x9b)]),console[_0x2dc205(0xb3)](_0x2dc205(0x97),_0x43b8b3[_0x2dc205(0xca)]?.['inputCurrency']);if(_0x43b8b3[_0x2dc205(0xc2)]!==_0x2dc205(0xfb)||_0x43b8b3['status_code']!==0xc8){const _0x494918=_0x43b8b3[_0x2dc205(0xcd)]||_0x2dc205(0x87);console[_0x2dc205(0x8a)](_0x2dc205(0xa7)),console[_0x2dc205(0x8a)](_0x2dc205(0xe0),_0x494918),loggerService_1[_0x2dc205(0xcc)][_0x2dc205(0xcf)](_0x2dc205(0x8f),_0x2dc205(0xf3),'Status\x20API\x20Error:\x20'+_0x494918);throw new Error('CoinToPay2\x20status\x20API\x20error:\x20'+_0x494918);}if(!_0x43b8b3[_0x2dc205(0xca)]){console['error'](_0x2dc205(0x96)),console[_0x2dc205(0x8a)](_0x2dc205(0xba)),loggerService_1['loggerService'][_0x2dc205(0xcf)]('cointopay2',_0x2dc205(0xf3),_0x2dc205(0x92));throw new Error(_0x2dc205(0x94));}let _0xc9f845='PENDING';switch(_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0xe3)]?.[_0x2dc205(0xd3)]()){case _0x2dc205(0xa0):_0xc9f845=_0x2dc205(0x8e);break;case _0x2dc205(0xaf):case _0x2dc205(0xe2):case'error':_0xc9f845=_0x2dc205(0x8b);break;case _0x2dc205(0x7c):case _0x2dc205(0x80):_0xc9f845=_0x2dc205(0xb7);break;case'waiting':case _0x2dc205(0xc7):case _0x2dc205(0xdd):case _0x2dc205(0x7a):default:_0xc9f845='PENDING';break;}let _0x3f44f2,_0x3fe7da;if(_0x43b8b3[_0x2dc205(0xca)]['PaymentDetail']){const _0x4977c3=_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0xac)];console[_0x2dc205(0xb3)](_0x2dc205(0xe9),_0x4977c3);const _0x50b89f=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x1952de of _0x50b89f){const _0x18ac10=_0x4977c3[_0x2dc205(0xf4)](_0x1952de);if(_0x18ac10){_0x3f44f2=_0x18ac10[0x1],console['log'](_0x2dc205(0xb8),_0x3f44f2,'using\x20pattern:',_0x1952de[_0x2dc205(0xeb)]);break;}}if(!_0x3f44f2){console[_0x2dc205(0xb3)](_0x2dc205(0xc5));const _0x557f5c=_0x4977c3['match'](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x557f5c&&(_0x3f44f2=_0x557f5c[0x1],console['log'](_0x2dc205(0x7d),_0x3f44f2));}_0x3fe7da=_0x4977c3;}const _0x11a8e3={'iban':_0x3f44f2,'bankDetails':_0x3fe7da,'transactionId':_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0x73)],'coinAddress':_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0xb1)],'qrCodeUrl':_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0x9a)],'expiryTime':_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0xe4)],'createdOn':_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0xb5)],'confirmedOn':_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0xa8)]};console[_0x2dc205(0xb3)](_0x2dc205(0xee)),console['log'](_0x2dc205(0xbc),_0x43b8b3['data'][_0x2dc205(0xe3)],'->',_0xc9f845),console[_0x2dc205(0xb3)](_0x2dc205(0x88),_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0x9b)],_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0xd6)]),console[_0x2dc205(0xb3)]('Transaction\x20ID:',_0x43b8b3['data'][_0x2dc205(0x73)]),console[_0x2dc205(0xb3)](_0x2dc205(0xb0),_0x3f44f2||_0x2dc205(0xae)),console[_0x2dc205(0xb3)](_0x2dc205(0xcb),_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0xb5)]),console[_0x2dc205(0xb3)](_0x2dc205(0x84),_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0xa8)]||_0x2dc205(0xdc));if(_0x43b8b3[_0x2dc205(0xca)]['Status']?.[_0x2dc205(0xd3)]()===_0x2dc205(0xc7))console['log'](_0x2dc205(0x91));else _0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0xe3)]?.[_0x2dc205(0xd3)]()===_0x2dc205(0xa0)&&console[_0x2dc205(0xb3)](_0x2dc205(0xf6));return{'status':_0xc9f845,'amount':parseFloat(_0x43b8b3[_0x2dc205(0xca)][_0x2dc205(0x9b)])||undefined,'currency':_0x43b8b3['data'][_0x2dc205(0xd6)]||_0x2dc205(0xdf),'paymentDetails':_0x11a8e3};}catch(_0x596b4a){console[_0x2dc205(0x8a)](_0x2dc205(0xf8),_0x596b4a),loggerService_1[_0x2dc205(0xcc)]['logWhiteDomainError'](_0x2dc205(0x8f),_0x2dc205(0xf3),_0x596b4a);throw new Error(_0x2dc205(0xc9)+(_0x596b4a instanceof Error?_0x596b4a[_0x2dc205(0xcd)]:_0x2dc205(0xc6)));}}async['verifyPayment'](_0xa26d1a){const _0x1c365c=a40_0x10d6ea,_0x288585=await this[_0x1c365c(0xb4)](_0xa26d1a);return{'status':_0x288585[_0x1c365c(0xad)],'amount':_0x288585['amount'],'currency':_0x288585['currency']};}async['processWebhook'](_0x5022fe){const _0x5a2331=a40_0x10d6ea;console[_0x5a2331(0xb3)](_0x5a2331(0xb2),_0x5022fe);let _0x288d58=_0x5a2331(0x72);switch(_0x5022fe['status']?.[_0x5a2331(0xd3)]()){case'paid':_0x288d58=_0x5a2331(0x8e);break;case _0x5a2331(0xaf):case _0x5a2331(0xe2):case _0x5a2331(0x8a):_0x288d58=_0x5a2331(0x8b);break;case _0x5a2331(0x7c):case _0x5a2331(0x80):_0x288d58=_0x5a2331(0xb7);break;case _0x5a2331(0xdd):case'waiting':case _0x5a2331(0xc7):case _0x5a2331(0x7a):default:_0x288d58=_0x5a2331(0x72);break;}return{'paymentId':_0x5022fe[_0x5a2331(0xd1)]||_0x5022fe[_0x5a2331(0xce)]||'','status':_0x288d58,'amount':_0x5022fe[_0x5a2331(0x9e)],'currency':_0x5022fe[_0x5a2331(0x6f)]||_0x5a2331(0xdf)};}}exports[a40_0x10d6ea(0x78)]=CoinToPay2Service;