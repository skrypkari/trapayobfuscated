'use strict';function a42_0x38d8(_0x1fa92f,_0x3064c2){const _0x2d1a1b=a42_0x2d1a();return a42_0x38d8=function(_0x38d85a,_0x21c367){_0x38d85a=_0x38d85a-0xf7;let _0x259a70=_0x2d1a1b[_0x38d85a];return _0x259a70;},a42_0x38d8(_0x1fa92f,_0x3064c2);}const a42_0xd0ef13=a42_0x38d8;(function(_0x2df986,_0xf41d67){const _0x1f4adf=a42_0x38d8,_0x32b0bc=_0x2df986();while(!![]){try{const _0x40447f=parseInt(_0x1f4adf(0x124))/0x1*(parseInt(_0x1f4adf(0x104))/0x2)+parseInt(_0x1f4adf(0x12b))/0x3+parseInt(_0x1f4adf(0x147))/0x4*(-parseInt(_0x1f4adf(0x152))/0x5)+-parseInt(_0x1f4adf(0x123))/0x6*(-parseInt(_0x1f4adf(0x173))/0x7)+-parseInt(_0x1f4adf(0x170))/0x8*(-parseInt(_0x1f4adf(0xfc))/0x9)+-parseInt(_0x1f4adf(0x175))/0xa*(parseInt(_0x1f4adf(0x145))/0xb)+-parseInt(_0x1f4adf(0x109))/0xc;if(_0x40447f===_0xf41d67)break;else _0x32b0bc['push'](_0x32b0bc['shift']());}catch(_0x171f4b){_0x32b0bc['push'](_0x32b0bc['shift']());}}}(a42_0x2d1a,0xc474e));Object[a42_0xd0ef13(0x16c)](exports,a42_0xd0ef13(0x15f),{'value':!![]}),exports[a42_0xd0ef13(0x157)]=void 0x0;const loggerService_1=require('../loggerService');function a42_0x2d1a(){const _0x2a9db8=['statusText','data','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Status:','checkPaymentStatus','waiting','logWhiteDomainResponse','processWebhook','CoinToPay2\x20payment\x20status\x20check\x20error:','7764rrMYLI','31WNhsDe','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','coinAddress','Incomplete\x20response:\x20missing\x20data','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','failed','status','3683991WpZYTp','expired','error','stack','paid','POST','created','Error\x20Message:','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','Created\x20On:','application/json','status_code','now','Transaction\x20ID:','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','currency','Response\x20data:','PaymentDetail','fromEntries','===\x20COINTOPAY2\x20API\x20ERROR\x20===','JSON\x20Parse\x20Error:\x20','Business\x20Error:\x20','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','verifyPayment','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','success','535480VycaNT','Currency:','20qLMAcn','loggerService','inputCurrency','cancelled','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','Headers:','message','IBAN:','Error\x20details:','toLowerCase','amount','847130BTGuwd','Failed\x20to\x20parse\x20JSON\x20response:','Amount:','source','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','CoinToPay2Service','stringify','Confirmed\x20On:','timeout','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','CreatedOn','statusUrl','headers','__esModule','logWhiteDomainError','HTTP\x20Status:','/create','URL:','payment_url','Gateway\x20Payment\x20ID:','logWhiteDomainRequest','text','cointopay2','not\x20found','awaiting\x20fiat','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','defineProperty','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','/status','532312yLmzGV','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','https://traffer.uk/gateway/cointopay/','4291xbirgo','QRCodeURL','110WyWBNn','Status\x20Text:','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','Payment\x20URL:','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','PENDING','Missing\x20data\x20in\x20response','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','gateway_payment_id','createPaymentLink','HTTP\x20error!\x20status:\x20','===\x20COINTOPAY2\x20SUCCESS\x20===','Response\x20Time:','198ogkoZi','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','TransactionConfirmedOn','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','üìä\x20Status\x20check\x20URL:','ExpiryTime','Amount','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','103694fWFatL','Error\x20message:','pending','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','apiUrl','34860456OyTkKJ','EUR','result','log','HTTP\x20','Status','TransactionID','PAID','match','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','not\x20confirmed','CoinToPay2\x20status\x20API\x20error:\x20','EXPIRED','parse','Unknown\x20error\x20from\x20CoinToPay2\x20API','Raw\x20Response\x20Body:','FAILED'];a42_0x2d1a=function(){return _0x2a9db8;};return a42_0x2d1a();}class CoinToPay2Service{constructor(){const _0x2e3da5=a42_0xd0ef13;this[_0x2e3da5(0x108)]=_0x2e3da5(0x172),this['statusUrl']='https://traffer.uk/gateway/cointopay/status.php',console[_0x2e3da5(0x10c)](_0x2e3da5(0x177)),console[_0x2e3da5(0x10c)](_0x2e3da5(0x100),this['statusUrl']);}async[a42_0xd0ef13(0xf8)](_0x3fc502){const _0x52b3ef=a42_0xd0ef13,{orderId:_0x584b30,amount:_0x5dde15}=_0x3fc502;console[_0x52b3ef(0x10c)]('ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20'+_0x5dde15+'\x20EUR');const _0x278ae1={'amount':_0x5dde15},_0x2979f2=Date[_0x52b3ef(0x137)]();try{console[_0x52b3ef(0x10c)]('===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20==='),console[_0x52b3ef(0x10c)](_0x52b3ef(0x163),this[_0x52b3ef(0x108)]),console[_0x52b3ef(0x10c)]('Request\x20Body:',JSON[_0x52b3ef(0x158)](_0x278ae1,null,0x2)),console['log'](_0x52b3ef(0x154),_0x5dde15,'EUR\x20(always\x20EUR\x20for\x20CoinToPay2)'),loggerService_1[_0x52b3ef(0x148)][_0x52b3ef(0x166)](_0x52b3ef(0x168),'/create',_0x52b3ef(0x130),_0x278ae1);const _0x71e237=await fetch(this['apiUrl'],{'method':_0x52b3ef(0x130),'headers':{'Content-Type':_0x52b3ef(0x135),'Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON['stringify'](_0x278ae1)}),_0x2c8327=Date['now']()-_0x2979f2;console[_0x52b3ef(0x10c)](_0x52b3ef(0x16b)),console[_0x52b3ef(0x10c)](_0x52b3ef(0x11d),_0x71e237[_0x52b3ef(0x12a)]),console[_0x52b3ef(0x10c)](_0x52b3ef(0x176),_0x71e237[_0x52b3ef(0x11a)]),console[_0x52b3ef(0x10c)](_0x52b3ef(0x14c),Object[_0x52b3ef(0x13d)](_0x71e237[_0x52b3ef(0x15e)]['entries']())),console[_0x52b3ef(0x10c)](_0x52b3ef(0xfb),_0x2c8327+'ms');const _0x1e0b1f=await _0x71e237[_0x52b3ef(0x167)]();console[_0x52b3ef(0x10c)](_0x52b3ef(0x118),_0x1e0b1f);if(!_0x71e237['ok']){console[_0x52b3ef(0x12d)](_0x52b3ef(0x13e)),console[_0x52b3ef(0x12d)](_0x52b3ef(0x161),_0x71e237['status']),console[_0x52b3ef(0x12d)]('Response\x20Body:',_0x1e0b1f),loggerService_1[_0x52b3ef(0x148)][_0x52b3ef(0x120)](_0x52b3ef(0x168),_0x52b3ef(0x162),_0x71e237[_0x52b3ef(0x12a)],_0x1e0b1f,_0x2c8327),loggerService_1['loggerService'][_0x52b3ef(0x160)](_0x52b3ef(0x168),_0x52b3ef(0x162),_0x52b3ef(0x10d)+_0x71e237[_0x52b3ef(0x12a)]+':\x20'+_0x1e0b1f);throw new Error(_0x52b3ef(0xf9)+_0x71e237['status']+',\x20body:\x20'+_0x1e0b1f);}let _0x5878e2;try{_0x5878e2=JSON[_0x52b3ef(0x116)](_0x1e0b1f);}catch(_0x5f04fe){console[_0x52b3ef(0x12d)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x5f04fe),loggerService_1[_0x52b3ef(0x148)]['logWhiteDomainError'](_0x52b3ef(0x168),_0x52b3ef(0x162),_0x52b3ef(0x13f)+_0x5f04fe);throw new Error(_0x52b3ef(0x139)+_0x1e0b1f);}console['log'](_0x52b3ef(0x112)),console[_0x52b3ef(0x10c)]('Parsed\x20Result:',JSON['stringify'](_0x5878e2,null,0x2)),loggerService_1[_0x52b3ef(0x148)][_0x52b3ef(0x120)](_0x52b3ef(0x168),_0x52b3ef(0x162),_0x71e237['status'],_0x5878e2,_0x2c8327);if(_0x5878e2[_0x52b3ef(0x12d)]){const _0x4b3cff=_0x5878e2[_0x52b3ef(0x14d)]||_0x5878e2[_0x52b3ef(0x12d)]||_0x52b3ef(0x117);console['error']('===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x52b3ef(0x12d)](_0x52b3ef(0x132),_0x4b3cff),loggerService_1[_0x52b3ef(0x148)][_0x52b3ef(0x160)]('cointopay2',_0x52b3ef(0x162),_0x52b3ef(0x140)+_0x4b3cff);throw new Error('CoinToPay2\x20API\x20error:\x20'+_0x4b3cff);}if(!_0x5878e2[_0x52b3ef(0x164)]||!_0x5878e2['gateway_payment_id']){console[_0x52b3ef(0x12d)](_0x52b3ef(0x179)),console['error'](_0x52b3ef(0x156)),console['error'](_0x52b3ef(0x13b),_0x5878e2),loggerService_1[_0x52b3ef(0x148)]['logWhiteDomainError'](_0x52b3ef(0x168),_0x52b3ef(0x162),_0x52b3ef(0x141));throw new Error(_0x52b3ef(0x14b));}return console[_0x52b3ef(0x10c)](_0x52b3ef(0xfa)),console[_0x52b3ef(0x10c)](_0x52b3ef(0x165),_0x5878e2[_0x52b3ef(0xf7)]),console[_0x52b3ef(0x10c)](_0x52b3ef(0x178),_0x5878e2[_0x52b3ef(0x164)]),console[_0x52b3ef(0x10c)](_0x52b3ef(0x154),_0x5dde15,_0x52b3ef(0x10a)),{'gateway_payment_id':_0x5878e2[_0x52b3ef(0xf7)],'payment_url':_0x5878e2[_0x52b3ef(0x164)]};}catch(_0x281516){console['error']('===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20==='),console[_0x52b3ef(0x12d)](_0x52b3ef(0x14f),_0x281516),loggerService_1[_0x52b3ef(0x148)]['logWhiteDomainError']('cointopay2',_0x52b3ef(0x162),_0x281516);if(_0x281516 instanceof Error){console[_0x52b3ef(0x12d)](_0x52b3ef(0x105),_0x281516['message']),console[_0x52b3ef(0x12d)]('Error\x20stack:',_0x281516[_0x52b3ef(0x12e)]);throw new Error(_0x52b3ef(0x16e)+_0x281516['message']);}throw new Error(_0x52b3ef(0xff));}}async[a42_0xd0ef13(0x11e)](_0x3bf4fb){const _0x7813a6=a42_0xd0ef13,_0x361edf=Date[_0x7813a6(0x137)]();try{console[_0x7813a6(0x10c)](_0x7813a6(0x15b)+_0x3bf4fb);const _0x1ea347={'gatewayPaymentId':_0x3bf4fb};loggerService_1['loggerService']['logWhiteDomainRequest']('cointopay2',_0x7813a6(0x16f),'POST',_0x1ea347);const _0x2f9430=await fetch(this[_0x7813a6(0x15d)],{'method':'POST','headers':{'Content-Type':_0x7813a6(0x135),'Accept':_0x7813a6(0x135),'User-Agent':_0x7813a6(0x171)},'body':JSON[_0x7813a6(0x158)](_0x1ea347)}),_0x4fac3f=Date[_0x7813a6(0x137)]()-_0x361edf;console[_0x7813a6(0x10c)](_0x7813a6(0x125)),console[_0x7813a6(0x10c)](_0x7813a6(0x11d),_0x2f9430[_0x7813a6(0x12a)]),console[_0x7813a6(0x10c)](_0x7813a6(0xfb),_0x4fac3f+'ms');if(!_0x2f9430['ok']){const _0x442c56=await _0x2f9430[_0x7813a6(0x167)]();console[_0x7813a6(0x12d)](_0x7813a6(0x161),_0x2f9430[_0x7813a6(0x12a)]),console[_0x7813a6(0x12d)]('Response\x20Body:',_0x442c56),loggerService_1['loggerService'][_0x7813a6(0x120)](_0x7813a6(0x168),'/status',_0x2f9430[_0x7813a6(0x12a)],_0x442c56,_0x4fac3f),loggerService_1['loggerService'][_0x7813a6(0x160)](_0x7813a6(0x168),_0x7813a6(0x16f),'HTTP\x20'+_0x2f9430[_0x7813a6(0x12a)]+':\x20'+_0x442c56);throw new Error(_0x7813a6(0xf9)+_0x2f9430[_0x7813a6(0x12a)]);}const _0x2e7a53=await _0x2f9430[_0x7813a6(0x167)]();console[_0x7813a6(0x10c)](_0x7813a6(0x118),_0x2e7a53);let _0x5a5384;try{_0x5a5384=JSON[_0x7813a6(0x116)](_0x2e7a53);}catch(_0x2b0ca3){console[_0x7813a6(0x12d)](_0x7813a6(0x153),_0x2b0ca3),loggerService_1['loggerService']['logWhiteDomainError'](_0x7813a6(0x168),_0x7813a6(0x16f),_0x7813a6(0x13f)+_0x2b0ca3);throw new Error(_0x7813a6(0x128)+_0x2e7a53);}loggerService_1[_0x7813a6(0x148)][_0x7813a6(0x120)](_0x7813a6(0x168),'/status',_0x2f9430[_0x7813a6(0x12a)],_0x5a5384,_0x4fac3f),console[_0x7813a6(0x10c)]('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console[_0x7813a6(0x10c)]('Result:',_0x5a5384[_0x7813a6(0x10b)]),console['log']('Status\x20Code:',_0x5a5384[_0x7813a6(0x136)]),console['log']('Payment\x20Status:',_0x5a5384['data']?.[_0x7813a6(0x10e)]),console[_0x7813a6(0x10c)]('Amount:',_0x5a5384[_0x7813a6(0x11b)]?.[_0x7813a6(0x102)]),console[_0x7813a6(0x10c)](_0x7813a6(0x146),_0x5a5384[_0x7813a6(0x11b)]?.['inputCurrency']);if(_0x5a5384[_0x7813a6(0x10b)]!==_0x7813a6(0x144)||_0x5a5384['status_code']!==0xc8){const _0x48813f=_0x5a5384[_0x7813a6(0x14d)]||_0x7813a6(0x133);console[_0x7813a6(0x12d)](_0x7813a6(0x143)),console[_0x7813a6(0x12d)]('Error\x20Message:',_0x48813f),loggerService_1['loggerService']['logWhiteDomainError'](_0x7813a6(0x168),_0x7813a6(0x16f),'Status\x20API\x20Error:\x20'+_0x48813f);throw new Error(_0x7813a6(0x114)+_0x48813f);}if(!_0x5a5384[_0x7813a6(0x11b)]){console['error'](_0x7813a6(0x11c)),console['error'](_0x7813a6(0x17b)),loggerService_1['loggerService']['logWhiteDomainError']('cointopay2','/status',_0x7813a6(0x127));throw new Error(_0x7813a6(0x17c));}let _0x5b8bd3=_0x7813a6(0x17a);switch(_0x5a5384['data']['Status']?.['toLowerCase']()){case _0x7813a6(0x12f):_0x5b8bd3=_0x7813a6(0x110);break;case _0x7813a6(0x14a):case'failed':case _0x7813a6(0x12d):_0x5b8bd3=_0x7813a6(0x119);break;case _0x7813a6(0x12c):case _0x7813a6(0x15a):_0x5b8bd3='EXPIRED';break;case'waiting':case _0x7813a6(0x16a):case _0x7813a6(0x106):case _0x7813a6(0x131):default:_0x5b8bd3=_0x7813a6(0x17a);break;}let _0x2c1093,_0x11766c;if(_0x5a5384['data'][_0x7813a6(0x13c)]){const _0x42acee=_0x5a5384['data']['PaymentDetail'];console[_0x7813a6(0x10c)]('üè¶\x20Payment\x20Detail:',_0x42acee);const _0x5bb604=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x1f68dc of _0x5bb604){const _0x4403d6=_0x42acee[_0x7813a6(0x111)](_0x1f68dc);if(_0x4403d6){_0x2c1093=_0x4403d6[0x1],console[_0x7813a6(0x10c)]('üè¶\x20Extracted\x20IBAN:',_0x2c1093,'using\x20pattern:',_0x1f68dc[_0x7813a6(0x155)]);break;}}if(!_0x2c1093){console[_0x7813a6(0x10c)](_0x7813a6(0xfd));const _0x21bfb9=_0x42acee[_0x7813a6(0x111)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x21bfb9&&(_0x2c1093=_0x21bfb9[0x1],console['log']('üè¶\x20Extracted\x20IBAN\x20via\x20fallback:',_0x2c1093));}_0x11766c=_0x42acee;}const _0x234835={'iban':_0x2c1093,'bankDetails':_0x11766c,'transactionId':_0x5a5384[_0x7813a6(0x11b)][_0x7813a6(0x10f)],'coinAddress':_0x5a5384[_0x7813a6(0x11b)][_0x7813a6(0x126)],'qrCodeUrl':_0x5a5384[_0x7813a6(0x11b)][_0x7813a6(0x174)],'expiryTime':_0x5a5384[_0x7813a6(0x11b)][_0x7813a6(0x101)],'createdOn':_0x5a5384[_0x7813a6(0x11b)][_0x7813a6(0x15c)],'confirmedOn':_0x5a5384[_0x7813a6(0x11b)]['TransactionConfirmedOn']};console[_0x7813a6(0x10c)](_0x7813a6(0x16d)),console['log'](_0x7813a6(0x11d),_0x5a5384['data']['Status'],'->',_0x5b8bd3),console[_0x7813a6(0x10c)](_0x7813a6(0x154),_0x5a5384[_0x7813a6(0x11b)][_0x7813a6(0x102)],_0x5a5384[_0x7813a6(0x11b)][_0x7813a6(0x149)]),console['log'](_0x7813a6(0x138),_0x5a5384[_0x7813a6(0x11b)][_0x7813a6(0x10f)]),console[_0x7813a6(0x10c)](_0x7813a6(0x14e),_0x2c1093||_0x7813a6(0x169)),console[_0x7813a6(0x10c)](_0x7813a6(0x134),_0x5a5384[_0x7813a6(0x11b)][_0x7813a6(0x15c)]),console['log'](_0x7813a6(0x159),_0x5a5384['data'][_0x7813a6(0xfe)]||_0x7813a6(0x113));if(_0x5a5384[_0x7813a6(0x11b)][_0x7813a6(0x10e)]?.[_0x7813a6(0x150)]()===_0x7813a6(0x16a))console[_0x7813a6(0x10c)](_0x7813a6(0x103));else _0x5a5384[_0x7813a6(0x11b)][_0x7813a6(0x10e)]?.[_0x7813a6(0x150)]()===_0x7813a6(0x12f)&&console[_0x7813a6(0x10c)](_0x7813a6(0x107));return{'status':_0x5b8bd3,'amount':parseFloat(_0x5a5384[_0x7813a6(0x11b)][_0x7813a6(0x102)])||undefined,'currency':_0x5a5384['data'][_0x7813a6(0x149)]||'EUR','paymentDetails':_0x234835};}catch(_0x1e79fb){console[_0x7813a6(0x12d)](_0x7813a6(0x122),_0x1e79fb),loggerService_1[_0x7813a6(0x148)]['logWhiteDomainError'](_0x7813a6(0x168),_0x7813a6(0x16f),_0x1e79fb);throw new Error('Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20'+(_0x1e79fb instanceof Error?_0x1e79fb['message']:'Unknown\x20error'));}}async[a42_0xd0ef13(0x142)](_0x455cdc){const _0x2a0889=a42_0xd0ef13,_0x1a7296=await this['checkPaymentStatus'](_0x455cdc);return{'status':_0x1a7296['status'],'amount':_0x1a7296['amount'],'currency':_0x1a7296[_0x2a0889(0x13a)]};}async[a42_0xd0ef13(0x121)](_0x4b75f9){const _0x4658b5=a42_0xd0ef13;console[_0x4658b5(0x10c)]('Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x4b75f9);let _0xd4632b='PENDING';switch(_0x4b75f9[_0x4658b5(0x12a)]?.[_0x4658b5(0x150)]()){case'paid':_0xd4632b=_0x4658b5(0x110);break;case _0x4658b5(0x14a):case _0x4658b5(0x129):case _0x4658b5(0x12d):_0xd4632b=_0x4658b5(0x119);break;case'expired':case _0x4658b5(0x15a):_0xd4632b=_0x4658b5(0x115);break;case'pending':case _0x4658b5(0x11f):case _0x4658b5(0x16a):case _0x4658b5(0x131):default:_0xd4632b=_0x4658b5(0x17a);break;}return{'paymentId':_0x4b75f9['order_id']||_0x4b75f9['merchant_reference_id']||'','status':_0xd4632b,'amount':_0x4b75f9[_0x4658b5(0x151)],'currency':_0x4b75f9[_0x4658b5(0x13a)]||_0x4658b5(0x10a)};}}exports[a42_0xd0ef13(0x157)]=CoinToPay2Service;