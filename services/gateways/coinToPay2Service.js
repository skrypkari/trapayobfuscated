'use strict';const a43_0x34007a=a43_0x1133;function a43_0x1133(_0x59fdff,_0x435e55){const _0x22ac21=a43_0x22ac();return a43_0x1133=function(_0x113310,_0x1db104){_0x113310=_0x113310-0xed;let _0x2c7c66=_0x22ac21[_0x113310];return _0x2c7c66;},a43_0x1133(_0x59fdff,_0x435e55);}(function(_0x66952c,_0x1c7c12){const _0x1f72e4=a43_0x1133,_0x4ff4e9=_0x66952c();while(!![]){try{const _0x3da716=parseInt(_0x1f72e4(0x136))/0x1+parseInt(_0x1f72e4(0x12c))/0x2*(-parseInt(_0x1f72e4(0xf0))/0x3)+-parseInt(_0x1f72e4(0x14f))/0x4*(-parseInt(_0x1f72e4(0x147))/0x5)+-parseInt(_0x1f72e4(0x178))/0x6*(parseInt(_0x1f72e4(0x100))/0x7)+parseInt(_0x1f72e4(0x16b))/0x8*(parseInt(_0x1f72e4(0x13e))/0x9)+parseInt(_0x1f72e4(0x14c))/0xa+parseInt(_0x1f72e4(0x154))/0xb*(parseInt(_0x1f72e4(0x16c))/0xc);if(_0x3da716===_0x1c7c12)break;else _0x4ff4e9['push'](_0x4ff4e9['shift']());}catch(_0x4946d9){_0x4ff4e9['push'](_0x4ff4e9['shift']());}}}(a43_0x22ac,0xa5337));function a43_0x22ac(){const _0x2035e6=['Error\x20stack:','checkPaymentStatus','Status:','IBAN:','message','parse','Amount','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','701544WAIvoL','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','gateway_payment_id','===\x20COINTOPAY2\x20API\x20ERROR\x20===','21IsjYKS','match','statusText','Failed\x20to\x20parse\x20JSON\x20response:','entries','Status','cointopay2','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','Created\x20On:','Request\x20Body:','Result:','URL:','Status\x20API\x20Error:\x20','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','Amount:','49gWqakB','currency','CoinToPay2Service','not\x20confirmed','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','PAID','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','Missing\x20data\x20in\x20response','Raw\x20Response\x20Body:','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','CreatedOn','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','waiting','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Incomplete\x20response:\x20missing\x20data','defineProperty','logWhiteDomainError','verifyPayment','üè¶\x20Extracted\x20IBAN:','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','__esModule','headers','TransactionConfirmedOn','data','awaiting\x20fiat','not\x20found','Unknown\x20error\x20from\x20CoinToPay2\x20API','merchant_reference_id','created','status','error','HTTP\x20','Response\x20Body:','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','/status','Currency:','expired','Response\x20data:','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','payment_url','Confirmed\x20On:','amount','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','304930EgfRgM','pending','Unknown\x20error','loggerService','Headers:','source','apiUrl','JSON\x20Parse\x20Error:\x20','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===',',\x20body:\x20','307675cejgzH','Error\x20details:','status_code','timeout','Transaction\x20ID:','QRCodeURL','EXPIRED','stringify','18vvmUco','HTTP\x20Status:','Response\x20Time:','statusUrl','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','failed','POST','PENDING','cancelled','2891710zpmmMX','toLowerCase','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','log','2312050jjGDLg','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','EUR','4GooJGX','TransactionID','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','Error\x20message:','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','33HVoNoD','stack','createPaymentLink','result','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','Business\x20Error:\x20','coinAddress','HTTP\x20error!\x20status:\x20','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Error\x20Message:','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','\x20EUR','inputCurrency','üè¶\x20Payment\x20Detail:','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','üìä\x20Status\x20check\x20URL:','logWhiteDomainResponse','paid','order_id','application/json','now','/create','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','1247728LgojNj','4532928Itnyek','logWhiteDomainRequest','text','Gateway\x20Payment\x20ID:'];a43_0x22ac=function(){return _0x2035e6;};return a43_0x22ac();}Object[a43_0x34007a(0x10f)](exports,a43_0x34007a(0x115),{'value':!![]}),exports[a43_0x34007a(0x102)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x3a8ec6=a43_0x34007a;this[_0x3a8ec6(0x132)]='https://traffer.uk/gateway/cointopay/',this[_0x3a8ec6(0x141)]='https://traffer.uk/gateway/cointopay/status.php',console[_0x3a8ec6(0x14b)](_0x3a8ec6(0x114)),console[_0x3a8ec6(0x14b)](_0x3a8ec6(0x163),this['statusUrl']);}async[a43_0x34007a(0x156)](_0x324425){const _0x1f0808=a43_0x34007a,{orderId:_0x2f407c,amount:_0x245828}=_0x324425;console[_0x1f0808(0x14b)](_0x1f0808(0x16a)+_0x245828+_0x1f0808(0x15f));const _0x311498={'amount':_0x245828},_0x5d18cd=Date['now']();try{console[_0x1f0808(0x14b)](_0x1f0808(0x153)),console['log'](_0x1f0808(0xfb),this[_0x1f0808(0x132)]),console['log'](_0x1f0808(0xf9),JSON[_0x1f0808(0x13d)](_0x311498,null,0x2)),console[_0x1f0808(0x14b)](_0x1f0808(0xff),_0x245828,_0x1f0808(0x127)),loggerService_1[_0x1f0808(0x12f)][_0x1f0808(0x16d)](_0x1f0808(0xf6),'/create',_0x1f0808(0x144),_0x311498);const _0x5dc0d0=await fetch(this[_0x1f0808(0x132)],{'method':'POST','headers':{'Content-Type':_0x1f0808(0x167),'Accept':_0x1f0808(0x167),'User-Agent':_0x1f0808(0xfe)},'body':JSON[_0x1f0808(0x13d)](_0x311498)}),_0xa68543=Date[_0x1f0808(0x168)]()-_0x5d18cd;console[_0x1f0808(0x14b)](_0x1f0808(0x106)),console[_0x1f0808(0x14b)]('Status:',_0x5dc0d0['status']),console['log']('Status\x20Text:',_0x5dc0d0[_0x1f0808(0xf2)]),console[_0x1f0808(0x14b)](_0x1f0808(0x130),Object['fromEntries'](_0x5dc0d0[_0x1f0808(0x116)][_0x1f0808(0xf4)]())),console['log'](_0x1f0808(0x140),_0xa68543+'ms');const _0x34d754=await _0x5dc0d0[_0x1f0808(0x16e)]();console[_0x1f0808(0x14b)](_0x1f0808(0x108),_0x34d754);if(!_0x5dc0d0['ok']){console[_0x1f0808(0x11f)](_0x1f0808(0xef)),console[_0x1f0808(0x11f)](_0x1f0808(0x13f),_0x5dc0d0[_0x1f0808(0x11e)]),console['error'](_0x1f0808(0x121),_0x34d754),loggerService_1[_0x1f0808(0x12f)][_0x1f0808(0x164)](_0x1f0808(0xf6),_0x1f0808(0x169),_0x5dc0d0[_0x1f0808(0x11e)],_0x34d754,_0xa68543),loggerService_1[_0x1f0808(0x12f)][_0x1f0808(0x110)]('cointopay2',_0x1f0808(0x169),_0x1f0808(0x120)+_0x5dc0d0[_0x1f0808(0x11e)]+':\x20'+_0x34d754);throw new Error(_0x1f0808(0x15b)+_0x5dc0d0['status']+_0x1f0808(0x135)+_0x34d754);}let _0x51a607;try{_0x51a607=JSON[_0x1f0808(0x175)](_0x34d754);}catch(_0x3b8a6a){console[_0x1f0808(0x11f)](_0x1f0808(0xf3),_0x3b8a6a),loggerService_1[_0x1f0808(0x12f)][_0x1f0808(0x110)](_0x1f0808(0xf6),_0x1f0808(0x169),'JSON\x20Parse\x20Error:\x20'+_0x3b8a6a);throw new Error(_0x1f0808(0x10b)+_0x34d754);}console[_0x1f0808(0x14b)](_0x1f0808(0x10d)),console[_0x1f0808(0x14b)]('Parsed\x20Result:',JSON['stringify'](_0x51a607,null,0x2)),loggerService_1[_0x1f0808(0x12f)][_0x1f0808(0x164)](_0x1f0808(0xf6),_0x1f0808(0x169),_0x5dc0d0[_0x1f0808(0x11e)],_0x51a607,_0xa68543);if(_0x51a607[_0x1f0808(0x11f)]){const _0x5b3b35=_0x51a607['message']||_0x51a607[_0x1f0808(0x11f)]||_0x1f0808(0x11b);console[_0x1f0808(0x11f)](_0x1f0808(0x162)),console[_0x1f0808(0x11f)](_0x1f0808(0x15d),_0x5b3b35),loggerService_1[_0x1f0808(0x12f)]['logWhiteDomainError']('cointopay2','/create',_0x1f0808(0x159)+_0x5b3b35);throw new Error('CoinToPay2\x20API\x20error:\x20'+_0x5b3b35);}if(!_0x51a607[_0x1f0808(0x128)]||!_0x51a607[_0x1f0808(0xee)]){console['error'](_0x1f0808(0x177)),console[_0x1f0808(0x11f)](_0x1f0808(0x14d)),console[_0x1f0808(0x11f)](_0x1f0808(0x126),_0x51a607),loggerService_1[_0x1f0808(0x12f)][_0x1f0808(0x110)](_0x1f0808(0xf6),'/create','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error(_0x1f0808(0x12b));}return console[_0x1f0808(0x14b)]('===\x20COINTOPAY2\x20SUCCESS\x20==='),console[_0x1f0808(0x14b)](_0x1f0808(0x16f),_0x51a607[_0x1f0808(0xee)]),console['log']('Payment\x20URL:',_0x51a607[_0x1f0808(0x128)]),console['log'](_0x1f0808(0xff),_0x245828,_0x1f0808(0x14e)),{'gateway_payment_id':_0x51a607[_0x1f0808(0xee)],'payment_url':_0x51a607[_0x1f0808(0x128)]};}catch(_0xfe84b7){console['error'](_0x1f0808(0x149)),console['error'](_0x1f0808(0x137),_0xfe84b7),loggerService_1[_0x1f0808(0x12f)][_0x1f0808(0x110)](_0x1f0808(0xf6),_0x1f0808(0x169),_0xfe84b7);if(_0xfe84b7 instanceof Error){console['error'](_0x1f0808(0x152),_0xfe84b7[_0x1f0808(0x174)]),console['error'](_0x1f0808(0x170),_0xfe84b7[_0x1f0808(0x155)]);throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20'+_0xfe84b7[_0x1f0808(0x174)]);}throw new Error(_0x1f0808(0x158));}}async[a43_0x34007a(0x171)](_0x5740ec){const _0x541bfe=a43_0x34007a,_0x43ea2e=Date[_0x541bfe(0x168)]();try{console[_0x541bfe(0x14b)](_0x541bfe(0x104)+_0x5740ec);const _0x4563d0={'gatewayPaymentId':_0x5740ec};loggerService_1[_0x541bfe(0x12f)][_0x541bfe(0x16d)]('cointopay2',_0x541bfe(0x123),_0x541bfe(0x144),_0x4563d0);const _0x3442f4=await fetch(this[_0x541bfe(0x141)],{'method':_0x541bfe(0x144),'headers':{'Content-Type':_0x541bfe(0x167),'Accept':_0x541bfe(0x167),'User-Agent':_0x541bfe(0xfe)},'body':JSON['stringify'](_0x4563d0)}),_0x10b703=Date['now']()-_0x43ea2e;console[_0x541bfe(0x14b)]('===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20==='),console[_0x541bfe(0x14b)](_0x541bfe(0x172),_0x3442f4[_0x541bfe(0x11e)]),console[_0x541bfe(0x14b)](_0x541bfe(0x140),_0x10b703+'ms');if(!_0x3442f4['ok']){const _0x56a391=await _0x3442f4['text']();console[_0x541bfe(0x11f)](_0x541bfe(0x13f),_0x3442f4[_0x541bfe(0x11e)]),console[_0x541bfe(0x11f)](_0x541bfe(0x121),_0x56a391),loggerService_1[_0x541bfe(0x12f)][_0x541bfe(0x164)]('cointopay2',_0x541bfe(0x123),_0x3442f4[_0x541bfe(0x11e)],_0x56a391,_0x10b703),loggerService_1['loggerService'][_0x541bfe(0x110)](_0x541bfe(0xf6),_0x541bfe(0x123),'HTTP\x20'+_0x3442f4[_0x541bfe(0x11e)]+':\x20'+_0x56a391);throw new Error(_0x541bfe(0x15b)+_0x3442f4[_0x541bfe(0x11e)]);}const _0x28add1=await _0x3442f4[_0x541bfe(0x16e)]();console['log'](_0x541bfe(0x108),_0x28add1);let _0x33fec4;try{_0x33fec4=JSON[_0x541bfe(0x175)](_0x28add1);}catch(_0x4ea75a){console[_0x541bfe(0x11f)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x4ea75a),loggerService_1[_0x541bfe(0x12f)][_0x541bfe(0x110)](_0x541bfe(0xf6),'/status',_0x541bfe(0x133)+_0x4ea75a);throw new Error(_0x541bfe(0x14a)+_0x28add1);}loggerService_1['loggerService'][_0x541bfe(0x164)](_0x541bfe(0xf6),_0x541bfe(0x123),_0x3442f4[_0x541bfe(0x11e)],_0x33fec4,_0x10b703),console[_0x541bfe(0x14b)](_0x541bfe(0xfd)),console[_0x541bfe(0x14b)](_0x541bfe(0xfa),_0x33fec4[_0x541bfe(0x157)]),console[_0x541bfe(0x14b)]('Status\x20Code:',_0x33fec4[_0x541bfe(0x138)]),console[_0x541bfe(0x14b)]('Payment\x20Status:',_0x33fec4[_0x541bfe(0x118)]?.[_0x541bfe(0xf5)]),console[_0x541bfe(0x14b)](_0x541bfe(0xff),_0x33fec4[_0x541bfe(0x118)]?.[_0x541bfe(0x176)]),console[_0x541bfe(0x14b)](_0x541bfe(0x124),_0x33fec4[_0x541bfe(0x118)]?.[_0x541bfe(0x160)]);if(_0x33fec4[_0x541bfe(0x157)]!=='success'||_0x33fec4[_0x541bfe(0x138)]!==0xc8){const _0x36d290=_0x33fec4['message']||_0x541bfe(0x113);console[_0x541bfe(0x11f)](_0x541bfe(0x122)),console[_0x541bfe(0x11f)](_0x541bfe(0x15d),_0x36d290),loggerService_1[_0x541bfe(0x12f)][_0x541bfe(0x110)](_0x541bfe(0xf6),'/status',_0x541bfe(0xfc)+_0x36d290);throw new Error('CoinToPay2\x20status\x20API\x20error:\x20'+_0x36d290);}if(!_0x33fec4[_0x541bfe(0x118)]){console['error']('===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x541bfe(0x11f)](_0x541bfe(0x107)),loggerService_1[_0x541bfe(0x12f)][_0x541bfe(0x110)](_0x541bfe(0xf6),'/status',_0x541bfe(0x10e));throw new Error(_0x541bfe(0x109));}let _0x52a75f=_0x541bfe(0x145);switch(_0x33fec4[_0x541bfe(0x118)][_0x541bfe(0xf5)]?.['toLowerCase']()){case'paid':_0x52a75f=_0x541bfe(0x105);break;case _0x541bfe(0x146):case _0x541bfe(0x143):case _0x541bfe(0x11f):_0x52a75f='FAILED';break;case'expired':case'timeout':_0x52a75f=_0x541bfe(0x13c);break;case _0x541bfe(0x10c):case _0x541bfe(0x119):case _0x541bfe(0x12d):case _0x541bfe(0x11d):default:_0x52a75f='PENDING';break;}let _0x4bb813,_0x5f364d;if(_0x33fec4[_0x541bfe(0x118)]['PaymentDetail']){const _0x3202f1=_0x33fec4['data']['PaymentDetail'];console['log'](_0x541bfe(0x161),_0x3202f1);const _0x408409=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x688b63 of _0x408409){const _0x2937df=_0x3202f1[_0x541bfe(0xf1)](_0x688b63);if(_0x2937df){_0x4bb813=_0x2937df[0x1],console[_0x541bfe(0x14b)](_0x541bfe(0x112),_0x4bb813,'using\x20pattern:',_0x688b63[_0x541bfe(0x131)]);break;}}if(!_0x4bb813){console[_0x541bfe(0x14b)](_0x541bfe(0xed));const _0x589c6d=_0x3202f1[_0x541bfe(0xf1)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x589c6d&&(_0x4bb813=_0x589c6d[0x1],console['log'](_0x541bfe(0xf7),_0x4bb813));}_0x5f364d=_0x3202f1;}const _0x467aa3={'iban':_0x4bb813,'bankDetails':_0x5f364d,'transactionId':_0x33fec4[_0x541bfe(0x118)][_0x541bfe(0x150)],'coinAddress':_0x33fec4[_0x541bfe(0x118)][_0x541bfe(0x15a)],'qrCodeUrl':_0x33fec4[_0x541bfe(0x118)][_0x541bfe(0x13b)],'expiryTime':_0x33fec4[_0x541bfe(0x118)]['ExpiryTime'],'createdOn':_0x33fec4[_0x541bfe(0x118)][_0x541bfe(0x10a)],'confirmedOn':_0x33fec4[_0x541bfe(0x118)][_0x541bfe(0x117)]};console[_0x541bfe(0x14b)](_0x541bfe(0x134)),console[_0x541bfe(0x14b)]('Status:',_0x33fec4[_0x541bfe(0x118)][_0x541bfe(0xf5)],'->',_0x52a75f),console[_0x541bfe(0x14b)]('Amount:',_0x33fec4['data'][_0x541bfe(0x176)],_0x33fec4[_0x541bfe(0x118)][_0x541bfe(0x160)]),console['log'](_0x541bfe(0x13a),_0x33fec4[_0x541bfe(0x118)][_0x541bfe(0x150)]),console[_0x541bfe(0x14b)](_0x541bfe(0x173),_0x4bb813||_0x541bfe(0x11a)),console['log'](_0x541bfe(0xf8),_0x33fec4[_0x541bfe(0x118)][_0x541bfe(0x10a)]),console[_0x541bfe(0x14b)](_0x541bfe(0x129),_0x33fec4['data'][_0x541bfe(0x117)]||_0x541bfe(0x103));if(_0x33fec4[_0x541bfe(0x118)]['Status']?.[_0x541bfe(0x148)]()===_0x541bfe(0x119))console[_0x541bfe(0x14b)](_0x541bfe(0x15c));else _0x33fec4[_0x541bfe(0x118)][_0x541bfe(0xf5)]?.[_0x541bfe(0x148)]()===_0x541bfe(0x165)&&console[_0x541bfe(0x14b)](_0x541bfe(0x15e));return{'status':_0x52a75f,'amount':parseFloat(_0x33fec4[_0x541bfe(0x118)][_0x541bfe(0x176)])||undefined,'currency':_0x33fec4[_0x541bfe(0x118)][_0x541bfe(0x160)]||'EUR','paymentDetails':_0x467aa3};}catch(_0x488022){console['error']('CoinToPay2\x20payment\x20status\x20check\x20error:',_0x488022),loggerService_1[_0x541bfe(0x12f)][_0x541bfe(0x110)](_0x541bfe(0xf6),_0x541bfe(0x123),_0x488022);throw new Error(_0x541bfe(0x151)+(_0x488022 instanceof Error?_0x488022[_0x541bfe(0x174)]:_0x541bfe(0x12e)));}}async[a43_0x34007a(0x111)](_0x1e6bfa){const _0x301ab7=a43_0x34007a,_0x502bcc=await this['checkPaymentStatus'](_0x1e6bfa);return{'status':_0x502bcc[_0x301ab7(0x11e)],'amount':_0x502bcc[_0x301ab7(0x12a)],'currency':_0x502bcc[_0x301ab7(0x101)]};}async['processWebhook'](_0x18faae){const _0x2308a1=a43_0x34007a;console['log'](_0x2308a1(0x142),_0x18faae);let _0x58b026=_0x2308a1(0x145);switch(_0x18faae[_0x2308a1(0x11e)]?.[_0x2308a1(0x148)]()){case'paid':_0x58b026='PAID';break;case'cancelled':case _0x2308a1(0x143):case'error':_0x58b026='FAILED';break;case _0x2308a1(0x125):case _0x2308a1(0x139):_0x58b026=_0x2308a1(0x13c);break;case _0x2308a1(0x12d):case'waiting':case _0x2308a1(0x119):case _0x2308a1(0x11d):default:_0x58b026='PENDING';break;}return{'paymentId':_0x18faae[_0x2308a1(0x166)]||_0x18faae[_0x2308a1(0x11c)]||'','status':_0x58b026,'amount':_0x18faae[_0x2308a1(0x12a)],'currency':_0x18faae['currency']||_0x2308a1(0x14e)};}}exports['CoinToPay2Service']=CoinToPay2Service;