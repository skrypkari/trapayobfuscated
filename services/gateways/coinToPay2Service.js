'use strict';function a43_0x4238(){const _0x2cf789=['Incomplete\x20response:\x20missing\x20data','failed','statusText','match','Headers:','Error\x20message:','Status:','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','loggerService','createPaymentLink','statusUrl','inputCurrency','===\x20COINTOPAY2\x20SUCCESS\x20===','üè¶\x20Payment\x20Detail:','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','created','2540DIEpuV','../loggerService','pending','data','EXPIRED','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','not\x20confirmed','Response\x20Body:','104412lyycdl','defineProperty','/status','awaiting\x20fiat','1610fMOcfx','error','218304FAXfNt','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','Confirmed\x20On:','Status\x20API\x20Error:\x20','EUR','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','text','HTTP\x20error!\x20status:\x20','payment_url','amount','4717048DwZWRl','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','stringify','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','https://traffer.uk/gateway/cointopay/status.php','Created\x20On:','Status','üìä\x20Status\x20check\x20URL:','HTTP\x20','verifyPayment','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20',',\x20body:\x20','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','source','logWhiteDomainRequest','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','paid','headers','logWhiteDomainResponse','Business\x20Error:\x20','Error\x20stack:','not\x20found','Transaction\x20ID:','PENDING','toLowerCase','CoinToPay2Service','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','parse','log','Status\x20Text:','JSON\x20Parse\x20Error:\x20','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','PaymentDetail','Payment\x20Status:','URL:','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','message','8JOdbce','Gateway\x20Payment\x20ID:','result','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','QRCodeURL','success','632004cdDjtK','CreatedOn','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','Failed\x20to\x20parse\x20JSON\x20response:','https://traffer.uk/gateway/cointopay/','now','currency','HTTP\x20Status:','3235ambfbQ','order_id','Unknown\x20error','entries','cointopay2','merchant_reference_id','CoinToPay2\x20payment\x20status\x20check\x20error:','5785173aqaHqA','__esModule','FAILED','Amount:','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','status_code','385065iwAHdK','Status\x20Code:','checkPaymentStatus','TransactionConfirmedOn','Error\x20Message:','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','CoinToPay2\x20API\x20error:\x20','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','logWhiteDomainError','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','POST','apiUrl','Amount','Missing\x20data\x20in\x20response','Currency:','Response\x20Time:','cancelled','CoinToPay2\x20status\x20API\x20error:\x20','/create','application/json','gateway_payment_id','8AMoymC','Request\x20Body:','===\x20COINTOPAY2\x20API\x20ERROR\x20===','Error\x20details:','coinAddress','Raw\x20Response\x20Body:','PAID','waiting','status'];a43_0x4238=function(){return _0x2cf789;};return a43_0x4238();}const a43_0x184c9d=a43_0x52c1;(function(_0x36ee07,_0x196e27){const _0x396da6=a43_0x52c1,_0x53ee02=_0x36ee07();while(!![]){try{const _0x37065d=-parseInt(_0x396da6(0x185))/0x1+-parseInt(_0x396da6(0x17f))/0x2*(-parseInt(_0x396da6(0x19a))/0x3)+-parseInt(_0x396da6(0x141))/0x4*(-parseInt(_0x396da6(0x18d))/0x5)+parseInt(_0x396da6(0x14f))/0x6+-parseInt(_0x396da6(0x159))/0x7+parseInt(_0x396da6(0x1af))/0x8*(-parseInt(_0x396da6(0x194))/0x9)+parseInt(_0x396da6(0x14d))/0xa*(parseInt(_0x396da6(0x149))/0xb);if(_0x37065d===_0x196e27)break;else _0x53ee02['push'](_0x53ee02['shift']());}catch(_0x448bac){_0x53ee02['push'](_0x53ee02['shift']());}}}(a43_0x4238,0x83e24));Object[a43_0x184c9d(0x14a)](exports,a43_0x184c9d(0x195),{'value':!![]}),exports[a43_0x184c9d(0x172)]=void 0x0;function a43_0x52c1(_0x47088c,_0xe9189d){const _0x423870=a43_0x4238();return a43_0x52c1=function(_0x52c113,_0x39f9ca){_0x52c113=_0x52c113-0x139;let _0x5f5253=_0x423870[_0x52c113];return _0x5f5253;},a43_0x52c1(_0x47088c,_0xe9189d);}const loggerService_1=require(a43_0x184c9d(0x142));class CoinToPay2Service{constructor(){const _0x52dad7=a43_0x184c9d;this[_0x52dad7(0x1a5)]=_0x52dad7(0x189),this[_0x52dad7(0x13b)]=_0x52dad7(0x15d),console[_0x52dad7(0x175)](_0x52dad7(0x15c)),console[_0x52dad7(0x175)](_0x52dad7(0x160),this[_0x52dad7(0x13b)]);}async[a43_0x184c9d(0x13a)](_0x11a5e9){const _0x3d7942=a43_0x184c9d,{orderId:_0x6ed73f,amount:_0x42f89e}=_0x11a5e9;console[_0x3d7942(0x175)](_0x3d7942(0x173)+_0x42f89e+'\x20EUR');const _0x5b0358={'amount':_0x42f89e},_0x3b0c92=Date['now']();try{console[_0x3d7942(0x175)](_0x3d7942(0x146)),console[_0x3d7942(0x175)](_0x3d7942(0x17c),this[_0x3d7942(0x1a5)]),console[_0x3d7942(0x175)](_0x3d7942(0x1b0),JSON['stringify'](_0x5b0358,null,0x2)),console[_0x3d7942(0x175)](_0x3d7942(0x197),_0x42f89e,_0x3d7942(0x13f)),loggerService_1[_0x3d7942(0x139)][_0x3d7942(0x167)](_0x3d7942(0x191),_0x3d7942(0x1ac),_0x3d7942(0x1a4),_0x5b0358);const _0x315801=await fetch(this[_0x3d7942(0x1a5)],{'method':_0x3d7942(0x1a4),'headers':{'Content-Type':'application/json','Accept':_0x3d7942(0x1ad),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON[_0x3d7942(0x15b)](_0x5b0358)}),_0x513e1f=Date[_0x3d7942(0x18a)]()-_0x3b0c92;console['log'](_0x3d7942(0x187)),console['log'](_0x3d7942(0x1be),_0x315801['status']),console['log'](_0x3d7942(0x176),_0x315801[_0x3d7942(0x1ba)]),console[_0x3d7942(0x175)](_0x3d7942(0x1bc),Object['fromEntries'](_0x315801[_0x3d7942(0x16a)][_0x3d7942(0x190)]())),console[_0x3d7942(0x175)]('Response\x20Time:',_0x513e1f+'ms');const _0x53be61=await _0x315801[_0x3d7942(0x155)]();console[_0x3d7942(0x175)]('Raw\x20Response\x20Body:',_0x53be61);if(!_0x315801['ok']){console[_0x3d7942(0x14e)](_0x3d7942(0x1b1)),console['error'](_0x3d7942(0x18c),_0x315801['status']),console['error']('Response\x20Body:',_0x53be61),loggerService_1[_0x3d7942(0x139)]['logWhiteDomainResponse'](_0x3d7942(0x191),_0x3d7942(0x1ac),_0x315801['status'],_0x53be61,_0x513e1f),loggerService_1[_0x3d7942(0x139)][_0x3d7942(0x1a2)](_0x3d7942(0x191),_0x3d7942(0x1ac),'HTTP\x20'+_0x315801['status']+':\x20'+_0x53be61);throw new Error(_0x3d7942(0x156)+_0x315801['status']+_0x3d7942(0x164)+_0x53be61);}let _0xedc5c1;try{_0xedc5c1=JSON[_0x3d7942(0x174)](_0x53be61);}catch(_0x32d261){console[_0x3d7942(0x14e)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x32d261),loggerService_1[_0x3d7942(0x139)][_0x3d7942(0x1a2)](_0x3d7942(0x191),'/create',_0x3d7942(0x177)+_0x32d261);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20'+_0x53be61);}console['log'](_0x3d7942(0x1a3)),console['log']('Parsed\x20Result:',JSON[_0x3d7942(0x15b)](_0xedc5c1,null,0x2)),loggerService_1[_0x3d7942(0x139)][_0x3d7942(0x16b)]('cointopay2',_0x3d7942(0x1ac),_0x315801[_0x3d7942(0x1b7)],_0xedc5c1,_0x513e1f);if(_0xedc5c1[_0x3d7942(0x14e)]){const _0x5e53b4=_0xedc5c1['message']||_0xedc5c1[_0x3d7942(0x14e)]||'Unknown\x20error\x20from\x20CoinToPay2\x20API';console[_0x3d7942(0x14e)]('===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x3d7942(0x14e)](_0x3d7942(0x19e),_0x5e53b4),loggerService_1[_0x3d7942(0x139)][_0x3d7942(0x1a2)]('cointopay2',_0x3d7942(0x1ac),_0x3d7942(0x16c)+_0x5e53b4);throw new Error(_0x3d7942(0x1a0)+_0x5e53b4);}if(!_0xedc5c1['payment_url']||!_0xedc5c1[_0x3d7942(0x1ae)]){console[_0x3d7942(0x14e)](_0x3d7942(0x198)),console[_0x3d7942(0x14e)](_0x3d7942(0x1a1)),console[_0x3d7942(0x14e)]('Response\x20data:',_0xedc5c1),loggerService_1[_0x3d7942(0x139)][_0x3d7942(0x1a2)](_0x3d7942(0x191),_0x3d7942(0x1ac),_0x3d7942(0x150));throw new Error(_0x3d7942(0x19f));}return console['log'](_0x3d7942(0x13d)),console[_0x3d7942(0x175)](_0x3d7942(0x180),_0xedc5c1[_0x3d7942(0x1ae)]),console[_0x3d7942(0x175)]('Payment\x20URL:',_0xedc5c1[_0x3d7942(0x157)]),console['log'](_0x3d7942(0x197),_0x42f89e,_0x3d7942(0x153)),{'gateway_payment_id':_0xedc5c1[_0x3d7942(0x1ae)],'payment_url':_0xedc5c1[_0x3d7942(0x157)]};}catch(_0x3398dd){console[_0x3d7942(0x14e)]('===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20==='),console[_0x3d7942(0x14e)](_0x3d7942(0x1b2),_0x3398dd),loggerService_1[_0x3d7942(0x139)]['logWhiteDomainError'](_0x3d7942(0x191),'/create',_0x3398dd);if(_0x3398dd instanceof Error){console['error'](_0x3d7942(0x1bd),_0x3398dd['message']),console[_0x3d7942(0x14e)](_0x3d7942(0x16d),_0x3398dd['stack']);throw new Error(_0x3d7942(0x163)+_0x3398dd['message']);}throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error');}}async[a43_0x184c9d(0x19c)](_0x47be68){const _0x817849=a43_0x184c9d,_0x2edd9d=Date[_0x817849(0x18a)]();try{console[_0x817849(0x175)](_0x817849(0x168)+_0x47be68);const _0x3040d9={'gatewayPaymentId':_0x47be68};loggerService_1['loggerService'][_0x817849(0x167)]('cointopay2',_0x817849(0x14b),_0x817849(0x1a4),_0x3040d9);const _0x491530=await fetch(this[_0x817849(0x13b)],{'method':'POST','headers':{'Content-Type':_0x817849(0x1ad),'Accept':_0x817849(0x1ad),'User-Agent':_0x817849(0x1c0)},'body':JSON[_0x817849(0x15b)](_0x3040d9)}),_0x85d076=Date['now']()-_0x2edd9d;console[_0x817849(0x175)]('===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20==='),console[_0x817849(0x175)](_0x817849(0x1be),_0x491530[_0x817849(0x1b7)]),console['log'](_0x817849(0x1a9),_0x85d076+'ms');if(!_0x491530['ok']){const _0x19e142=await _0x491530[_0x817849(0x155)]();console[_0x817849(0x14e)](_0x817849(0x18c),_0x491530[_0x817849(0x1b7)]),console[_0x817849(0x14e)](_0x817849(0x148),_0x19e142),loggerService_1['loggerService'][_0x817849(0x16b)](_0x817849(0x191),_0x817849(0x14b),_0x491530['status'],_0x19e142,_0x85d076),loggerService_1['loggerService'][_0x817849(0x1a2)]('cointopay2',_0x817849(0x14b),_0x817849(0x161)+_0x491530[_0x817849(0x1b7)]+':\x20'+_0x19e142);throw new Error(_0x817849(0x156)+_0x491530[_0x817849(0x1b7)]);}const _0x508884=await _0x491530[_0x817849(0x155)]();console[_0x817849(0x175)](_0x817849(0x1b4),_0x508884);let _0x9eb1d5;try{_0x9eb1d5=JSON['parse'](_0x508884);}catch(_0x466d2e){console[_0x817849(0x14e)](_0x817849(0x188),_0x466d2e),loggerService_1['loggerService'][_0x817849(0x1a2)]('cointopay2',_0x817849(0x14b),_0x817849(0x177)+_0x466d2e);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20'+_0x508884);}loggerService_1[_0x817849(0x139)][_0x817849(0x16b)](_0x817849(0x191),_0x817849(0x14b),_0x491530[_0x817849(0x1b7)],_0x9eb1d5,_0x85d076),console[_0x817849(0x175)]('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console['log']('Result:',_0x9eb1d5[_0x817849(0x181)]),console['log'](_0x817849(0x19b),_0x9eb1d5['status_code']),console[_0x817849(0x175)](_0x817849(0x17b),_0x9eb1d5[_0x817849(0x144)]?.['Status']),console[_0x817849(0x175)](_0x817849(0x197),_0x9eb1d5[_0x817849(0x144)]?.[_0x817849(0x1a6)]),console[_0x817849(0x175)](_0x817849(0x1a8),_0x9eb1d5[_0x817849(0x144)]?.[_0x817849(0x13c)]);if(_0x9eb1d5['result']!==_0x817849(0x184)||_0x9eb1d5[_0x817849(0x199)]!==0xc8){const _0x220fa0=_0x9eb1d5[_0x817849(0x17e)]||_0x817849(0x182);console['error'](_0x817849(0x17d)),console['error'](_0x817849(0x19e),_0x220fa0),loggerService_1[_0x817849(0x139)][_0x817849(0x1a2)](_0x817849(0x191),_0x817849(0x14b),_0x817849(0x152)+_0x220fa0);throw new Error(_0x817849(0x1ab)+_0x220fa0);}if(!_0x9eb1d5['data']){console[_0x817849(0x14e)](_0x817849(0x165)),console[_0x817849(0x14e)](_0x817849(0x1a7)),loggerService_1[_0x817849(0x139)]['logWhiteDomainError'](_0x817849(0x191),_0x817849(0x14b),_0x817849(0x1b8));throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data');}let _0x1f3760=_0x817849(0x170);switch(_0x9eb1d5[_0x817849(0x144)][_0x817849(0x15f)]?.[_0x817849(0x171)]()){case _0x817849(0x169):_0x1f3760=_0x817849(0x1b5);break;case'cancelled':case _0x817849(0x1b9):case'error':_0x1f3760=_0x817849(0x196);break;case'expired':case'timeout':_0x1f3760=_0x817849(0x145);break;case _0x817849(0x1b6):case _0x817849(0x14c):case _0x817849(0x143):case _0x817849(0x140):default:_0x1f3760=_0x817849(0x170);break;}let _0x2eb6e2,_0xf6a168;if(_0x9eb1d5[_0x817849(0x144)]['PaymentDetail']){const _0x10b8c7=_0x9eb1d5[_0x817849(0x144)][_0x817849(0x17a)];console[_0x817849(0x175)](_0x817849(0x13e),_0x10b8c7);const _0x5d4a00=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x4c8a04 of _0x5d4a00){const _0x3ac70a=_0x10b8c7[_0x817849(0x1bb)](_0x4c8a04);if(_0x3ac70a){_0x2eb6e2=_0x3ac70a[0x1],console['log']('üè¶\x20Extracted\x20IBAN:',_0x2eb6e2,'using\x20pattern:',_0x4c8a04[_0x817849(0x166)]);break;}}if(!_0x2eb6e2){console[_0x817849(0x175)](_0x817849(0x15a));const _0x4aa128=_0x10b8c7['match'](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x4aa128&&(_0x2eb6e2=_0x4aa128[0x1],console[_0x817849(0x175)]('üè¶\x20Extracted\x20IBAN\x20via\x20fallback:',_0x2eb6e2));}_0xf6a168=_0x10b8c7;}const _0x9e9605={'iban':_0x2eb6e2,'bankDetails':_0xf6a168,'transactionId':_0x9eb1d5[_0x817849(0x144)]['TransactionID'],'coinAddress':_0x9eb1d5[_0x817849(0x144)][_0x817849(0x1b3)],'qrCodeUrl':_0x9eb1d5['data'][_0x817849(0x183)],'expiryTime':_0x9eb1d5[_0x817849(0x144)]['ExpiryTime'],'createdOn':_0x9eb1d5[_0x817849(0x144)][_0x817849(0x186)],'confirmedOn':_0x9eb1d5['data'][_0x817849(0x19d)]};console[_0x817849(0x175)](_0x817849(0x1bf)),console[_0x817849(0x175)](_0x817849(0x1be),_0x9eb1d5[_0x817849(0x144)][_0x817849(0x15f)],'->',_0x1f3760),console[_0x817849(0x175)]('Amount:',_0x9eb1d5[_0x817849(0x144)][_0x817849(0x1a6)],_0x9eb1d5[_0x817849(0x144)][_0x817849(0x13c)]),console['log'](_0x817849(0x16f),_0x9eb1d5[_0x817849(0x144)]['TransactionID']),console[_0x817849(0x175)]('IBAN:',_0x2eb6e2||_0x817849(0x16e)),console[_0x817849(0x175)](_0x817849(0x15e),_0x9eb1d5[_0x817849(0x144)][_0x817849(0x186)]),console[_0x817849(0x175)](_0x817849(0x151),_0x9eb1d5['data'][_0x817849(0x19d)]||_0x817849(0x147));if(_0x9eb1d5['data'][_0x817849(0x15f)]?.[_0x817849(0x171)]()==='awaiting\x20fiat')console[_0x817849(0x175)]('üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)');else _0x9eb1d5[_0x817849(0x144)][_0x817849(0x15f)]?.[_0x817849(0x171)]()===_0x817849(0x169)&&console[_0x817849(0x175)](_0x817849(0x178));return{'status':_0x1f3760,'amount':parseFloat(_0x9eb1d5['data'][_0x817849(0x1a6)])||undefined,'currency':_0x9eb1d5[_0x817849(0x144)][_0x817849(0x13c)]||'EUR','paymentDetails':_0x9e9605};}catch(_0x5ef352){console[_0x817849(0x14e)](_0x817849(0x193),_0x5ef352),loggerService_1[_0x817849(0x139)][_0x817849(0x1a2)](_0x817849(0x191),_0x817849(0x14b),_0x5ef352);throw new Error(_0x817849(0x179)+(_0x5ef352 instanceof Error?_0x5ef352[_0x817849(0x17e)]:_0x817849(0x18f)));}}async[a43_0x184c9d(0x162)](_0x4d650a){const _0x432708=a43_0x184c9d,_0x45cf4a=await this[_0x432708(0x19c)](_0x4d650a);return{'status':_0x45cf4a['status'],'amount':_0x45cf4a[_0x432708(0x158)],'currency':_0x45cf4a['currency']};}async['processWebhook'](_0xb199ac){const _0x5a621f=a43_0x184c9d;console[_0x5a621f(0x175)](_0x5a621f(0x154),_0xb199ac);let _0xe9db55='PENDING';switch(_0xb199ac[_0x5a621f(0x1b7)]?.[_0x5a621f(0x171)]()){case'paid':_0xe9db55=_0x5a621f(0x1b5);break;case _0x5a621f(0x1aa):case'failed':case _0x5a621f(0x14e):_0xe9db55='FAILED';break;case'expired':case'timeout':_0xe9db55='EXPIRED';break;case _0x5a621f(0x143):case _0x5a621f(0x1b6):case _0x5a621f(0x14c):case _0x5a621f(0x140):default:_0xe9db55=_0x5a621f(0x170);break;}return{'paymentId':_0xb199ac[_0x5a621f(0x18e)]||_0xb199ac[_0x5a621f(0x192)]||'','status':_0xe9db55,'amount':_0xb199ac[_0x5a621f(0x158)],'currency':_0xb199ac[_0x5a621f(0x18b)]||_0x5a621f(0x153)};}}exports[a43_0x184c9d(0x172)]=CoinToPay2Service;