'use strict';const a45_0x38e55a=a45_0x4168;function a45_0x4168(_0x4f4eac,_0x5823ab){const _0x1361e7=a45_0x1361();return a45_0x4168=function(_0x4168af,_0x1dd535){_0x4168af=_0x4168af-0x11b;let _0x4cffd9=_0x1361e7[_0x4168af];return _0x4cffd9;},a45_0x4168(_0x4f4eac,_0x5823ab);}(function(_0x9cdf8c,_0x28da38){const _0x2f3baa=a45_0x4168,_0x2601cf=_0x9cdf8c();while(!![]){try{const _0xbf18e7=-parseInt(_0x2f3baa(0x184))/0x1*(parseInt(_0x2f3baa(0x16a))/0x2)+-parseInt(_0x2f3baa(0x172))/0x3*(parseInt(_0x2f3baa(0x126))/0x4)+parseInt(_0x2f3baa(0x17d))/0x5*(-parseInt(_0x2f3baa(0x167))/0x6)+-parseInt(_0x2f3baa(0x169))/0x7+-parseInt(_0x2f3baa(0x137))/0x8*(parseInt(_0x2f3baa(0x12d))/0x9)+parseInt(_0x2f3baa(0x16c))/0xa*(-parseInt(_0x2f3baa(0x182))/0xb)+parseInt(_0x2f3baa(0x19e))/0xc;if(_0xbf18e7===_0x28da38)break;else _0x2601cf['push'](_0x2601cf['shift']());}catch(_0x1944d8){_0x2601cf['push'](_0x2601cf['shift']());}}}(a45_0x1361,0x57d58));Object[a45_0x38e55a(0x188)](exports,'__esModule',{'value':!![]}),exports[a45_0x38e55a(0x163)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x248a0f=a45_0x38e55a;this['apiUrl']=_0x248a0f(0x15e),this[_0x248a0f(0x1a0)]=_0x248a0f(0x13b),console[_0x248a0f(0x183)]('🪙\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy'),console['log']('📊\x20Status\x20check\x20URL:',this[_0x248a0f(0x1a0)]);}async[a45_0x38e55a(0x148)](_0x2fb5f1){const _0x15cada=a45_0x38e55a,{orderId:_0x2919ad,amount:_0x417e2a}=_0x2fb5f1;console[_0x15cada(0x183)](_0x15cada(0x18a)+_0x417e2a+_0x15cada(0x136));const _0x585f2d={'amount':_0x417e2a},_0x9a75d=Date[_0x15cada(0x14c)]();try{console[_0x15cada(0x183)](_0x15cada(0x1a7)),console['log'](_0x15cada(0x133),this[_0x15cada(0x14b)]),console['log'](_0x15cada(0x138),JSON[_0x15cada(0x196)](_0x585f2d,null,0x2)),console[_0x15cada(0x183)](_0x15cada(0x19f),_0x417e2a,_0x15cada(0x17e)),loggerService_1[_0x15cada(0x17b)][_0x15cada(0x131)](_0x15cada(0x18d),_0x15cada(0x12f),_0x15cada(0x1a6),_0x585f2d);const _0x374cce=await fetch(this[_0x15cada(0x14b)],{'method':'POST','headers':{'Content-Type':_0x15cada(0x168),'Accept':_0x15cada(0x168),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON[_0x15cada(0x196)](_0x585f2d)}),_0x218612=Date[_0x15cada(0x14c)]()-_0x9a75d;console[_0x15cada(0x183)](_0x15cada(0x135)),console['log'](_0x15cada(0x180),_0x374cce[_0x15cada(0x14a)]),console[_0x15cada(0x183)](_0x15cada(0x1a3),_0x374cce[_0x15cada(0x12e)]),console[_0x15cada(0x183)](_0x15cada(0x166),Object[_0x15cada(0x158)](_0x374cce[_0x15cada(0x165)][_0x15cada(0x1a4)]())),console[_0x15cada(0x183)](_0x15cada(0x192),_0x218612+'ms');const _0x3b8e2c=await _0x374cce[_0x15cada(0x179)]();console[_0x15cada(0x183)]('Raw\x20Response\x20Body:',_0x3b8e2c);if(!_0x374cce['ok']){console[_0x15cada(0x171)](_0x15cada(0x12c)),console['error']('HTTP\x20Status:',_0x374cce['status']),console[_0x15cada(0x171)](_0x15cada(0x13a),_0x3b8e2c),loggerService_1[_0x15cada(0x17b)][_0x15cada(0x146)](_0x15cada(0x18d),_0x15cada(0x12f),_0x374cce['status'],_0x3b8e2c,_0x218612),loggerService_1[_0x15cada(0x17b)][_0x15cada(0x151)](_0x15cada(0x18d),'/create',_0x15cada(0x11b)+_0x374cce[_0x15cada(0x14a)]+':\x20'+_0x3b8e2c);throw new Error(_0x15cada(0x121)+_0x374cce[_0x15cada(0x14a)]+',\x20body:\x20'+_0x3b8e2c);}let _0xacfe28;try{_0xacfe28=JSON[_0x15cada(0x14f)](_0x3b8e2c);}catch(_0x580ec6){console[_0x15cada(0x171)](_0x15cada(0x161),_0x580ec6),loggerService_1[_0x15cada(0x17b)][_0x15cada(0x151)](_0x15cada(0x18d),_0x15cada(0x12f),_0x15cada(0x19c)+_0x580ec6);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20'+_0x3b8e2c);}console[_0x15cada(0x183)]('===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20==='),console[_0x15cada(0x183)]('Parsed\x20Result:',JSON[_0x15cada(0x196)](_0xacfe28,null,0x2)),loggerService_1[_0x15cada(0x17b)][_0x15cada(0x146)]('cointopay2',_0x15cada(0x12f),_0x374cce[_0x15cada(0x14a)],_0xacfe28,_0x218612);if(_0xacfe28[_0x15cada(0x171)]){const _0x250089=_0xacfe28['message']||_0xacfe28[_0x15cada(0x171)]||_0x15cada(0x18c);console[_0x15cada(0x171)](_0x15cada(0x19b)),console[_0x15cada(0x171)](_0x15cada(0x13f),_0x250089),loggerService_1['loggerService'][_0x15cada(0x151)](_0x15cada(0x18d),_0x15cada(0x12f),'Business\x20Error:\x20'+_0x250089);throw new Error(_0x15cada(0x125)+_0x250089);}if(!_0xacfe28[_0x15cada(0x199)]||!_0xacfe28['gateway_payment_id']){console[_0x15cada(0x171)](_0x15cada(0x15c)),console['error'](_0x15cada(0x181)),console[_0x15cada(0x171)](_0x15cada(0x16f),_0xacfe28),loggerService_1[_0x15cada(0x17b)][_0x15cada(0x151)](_0x15cada(0x18d),_0x15cada(0x12f),_0x15cada(0x132));throw new Error(_0x15cada(0x155));}return console[_0x15cada(0x183)](_0x15cada(0x174)),console[_0x15cada(0x183)](_0x15cada(0x16e),_0xacfe28[_0x15cada(0x123)]),console[_0x15cada(0x183)](_0x15cada(0x178),_0xacfe28['payment_url']),console['log'](_0x15cada(0x19f),_0x417e2a,'EUR'),{'gateway_payment_id':_0xacfe28[_0x15cada(0x123)],'payment_url':_0xacfe28['payment_url']};}catch(_0x5d9ee1){console[_0x15cada(0x171)](_0x15cada(0x152)),console[_0x15cada(0x171)](_0x15cada(0x129),_0x5d9ee1),loggerService_1[_0x15cada(0x17b)]['logWhiteDomainError'](_0x15cada(0x18d),'/create',_0x5d9ee1);if(_0x5d9ee1 instanceof Error){console[_0x15cada(0x171)](_0x15cada(0x15d),_0x5d9ee1[_0x15cada(0x18e)]),console[_0x15cada(0x171)](_0x15cada(0x19a),_0x5d9ee1[_0x15cada(0x159)]);throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20'+_0x5d9ee1[_0x15cada(0x18e)]);}throw new Error(_0x15cada(0x195));}}async[a45_0x38e55a(0x140)](_0x1a80c5){const _0x186dd3=a45_0x38e55a,_0x4ca423=Date[_0x186dd3(0x14c)]();try{console[_0x186dd3(0x183)]('📊\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20'+_0x1a80c5);const _0x914eba={'gatewayPaymentId':_0x1a80c5};loggerService_1['loggerService']['logWhiteDomainRequest'](_0x186dd3(0x18d),_0x186dd3(0x164),_0x186dd3(0x1a6),_0x914eba);const _0x275d3e=await fetch(this[_0x186dd3(0x1a0)],{'method':_0x186dd3(0x1a6),'headers':{'Content-Type':_0x186dd3(0x168),'Accept':_0x186dd3(0x168),'User-Agent':_0x186dd3(0x15f)},'body':JSON[_0x186dd3(0x196)](_0x914eba)}),_0x5d8c37=Date[_0x186dd3(0x14c)]()-_0x4ca423;console[_0x186dd3(0x183)]('===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20==='),console[_0x186dd3(0x183)]('Status:',_0x275d3e[_0x186dd3(0x14a)]),console[_0x186dd3(0x183)](_0x186dd3(0x192),_0x5d8c37+'ms');if(!_0x275d3e['ok']){const _0x26fc52=await _0x275d3e[_0x186dd3(0x179)]();console[_0x186dd3(0x171)](_0x186dd3(0x139),_0x275d3e['status']),console['error'](_0x186dd3(0x13a),_0x26fc52),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x186dd3(0x18d),'/status',_0x275d3e[_0x186dd3(0x14a)],_0x26fc52,_0x5d8c37),loggerService_1[_0x186dd3(0x17b)][_0x186dd3(0x151)]('cointopay2',_0x186dd3(0x164),_0x186dd3(0x11b)+_0x275d3e[_0x186dd3(0x14a)]+':\x20'+_0x26fc52);throw new Error(_0x186dd3(0x121)+_0x275d3e[_0x186dd3(0x14a)]);}const _0x4bd8b2=await _0x275d3e[_0x186dd3(0x179)]();console[_0x186dd3(0x183)](_0x186dd3(0x13d),_0x4bd8b2);let _0x3cfd81;try{_0x3cfd81=JSON[_0x186dd3(0x14f)](_0x4bd8b2);}catch(_0x2670f0){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0x2670f0),loggerService_1[_0x186dd3(0x17b)]['logWhiteDomainError']('cointopay2',_0x186dd3(0x164),_0x186dd3(0x19c)+_0x2670f0);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20'+_0x4bd8b2);}loggerService_1[_0x186dd3(0x17b)][_0x186dd3(0x146)](_0x186dd3(0x18d),_0x186dd3(0x164),_0x275d3e[_0x186dd3(0x14a)],_0x3cfd81,_0x5d8c37),console['log']('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console[_0x186dd3(0x183)](_0x186dd3(0x16b),_0x3cfd81[_0x186dd3(0x15a)]),console[_0x186dd3(0x183)](_0x186dd3(0x162),_0x3cfd81[_0x186dd3(0x124)]),console[_0x186dd3(0x183)](_0x186dd3(0x12a),_0x3cfd81['data']?.['Status']),console['log'](_0x186dd3(0x19f),_0x3cfd81[_0x186dd3(0x153)]?.['Amount']),console[_0x186dd3(0x183)](_0x186dd3(0x120),_0x3cfd81[_0x186dd3(0x153)]?.[_0x186dd3(0x191)]);if(_0x3cfd81[_0x186dd3(0x15a)]!=='success'||_0x3cfd81['status_code']!==0xc8){const _0x3243d8=_0x3cfd81['message']||_0x186dd3(0x149);console['error']('===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20==='),console[_0x186dd3(0x171)](_0x186dd3(0x13f),_0x3243d8),loggerService_1[_0x186dd3(0x17b)]['logWhiteDomainError'](_0x186dd3(0x18d),_0x186dd3(0x164),_0x186dd3(0x127)+_0x3243d8);throw new Error(_0x186dd3(0x175)+_0x3243d8);}if(!_0x3cfd81['data']){console[_0x186dd3(0x171)](_0x186dd3(0x17f)),console[_0x186dd3(0x171)](_0x186dd3(0x122)),loggerService_1['loggerService'][_0x186dd3(0x151)](_0x186dd3(0x18d),_0x186dd3(0x164),_0x186dd3(0x1a1));throw new Error(_0x186dd3(0x13e));}let _0x52451b='PENDING';switch(_0x3cfd81[_0x186dd3(0x153)]['Status']?.['toLowerCase']()){case _0x186dd3(0x142):_0x52451b=_0x186dd3(0x16d);break;case _0x186dd3(0x130):case _0x186dd3(0x185):case _0x186dd3(0x171):_0x52451b=_0x186dd3(0x177);break;case _0x186dd3(0x11c):case _0x186dd3(0x128):_0x52451b='EXPIRED';break;case _0x186dd3(0x170):case _0x186dd3(0x18b):case _0x186dd3(0x12b):case'created':default:_0x52451b=_0x186dd3(0x15b);break;}let _0x209e50,_0x1a9010;if(_0x3cfd81['data'][_0x186dd3(0x145)]){const _0x5913f4=_0x3cfd81[_0x186dd3(0x153)][_0x186dd3(0x145)];console[_0x186dd3(0x183)](_0x186dd3(0x156),_0x5913f4);const _0x4b7f0e=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x307eef of _0x4b7f0e){const _0x5a1401=_0x5913f4[_0x186dd3(0x160)](_0x307eef);if(_0x5a1401){_0x209e50=_0x5a1401[0x1],console['log'](_0x186dd3(0x173),_0x209e50,'using\x20pattern:',_0x307eef[_0x186dd3(0x14e)]);break;}}if(!_0x209e50){console['log'](_0x186dd3(0x19d));const _0x377a6f=_0x5913f4[_0x186dd3(0x160)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x377a6f&&(_0x209e50=_0x377a6f[0x1],console[_0x186dd3(0x183)](_0x186dd3(0x150),_0x209e50));}_0x1a9010=_0x5913f4;}const _0x43046f={'iban':_0x209e50,'bankDetails':_0x1a9010,'transactionId':_0x3cfd81[_0x186dd3(0x153)]['TransactionID'],'coinAddress':_0x3cfd81[_0x186dd3(0x153)][_0x186dd3(0x143)],'qrCodeUrl':_0x3cfd81[_0x186dd3(0x153)][_0x186dd3(0x147)],'expiryTime':_0x3cfd81[_0x186dd3(0x153)][_0x186dd3(0x187)],'createdOn':_0x3cfd81[_0x186dd3(0x153)]['CreatedOn'],'confirmedOn':_0x3cfd81['data'][_0x186dd3(0x193)]};console['log'](_0x186dd3(0x198)),console['log'](_0x186dd3(0x180),_0x3cfd81[_0x186dd3(0x153)][_0x186dd3(0x190)],'->',_0x52451b),console[_0x186dd3(0x183)](_0x186dd3(0x19f),_0x3cfd81[_0x186dd3(0x153)][_0x186dd3(0x154)],_0x3cfd81[_0x186dd3(0x153)][_0x186dd3(0x191)]),console[_0x186dd3(0x183)](_0x186dd3(0x13c),_0x3cfd81['data'][_0x186dd3(0x176)]),console[_0x186dd3(0x183)]('IBAN:',_0x209e50||_0x186dd3(0x18f)),console[_0x186dd3(0x183)](_0x186dd3(0x186),_0x3cfd81['data'][_0x186dd3(0x17c)]),console['log'](_0x186dd3(0x14d),_0x3cfd81['data'][_0x186dd3(0x193)]||'not\x20confirmed');if(_0x3cfd81[_0x186dd3(0x153)][_0x186dd3(0x190)]?.[_0x186dd3(0x141)]()==='awaiting\x20fiat')console[_0x186dd3(0x183)](_0x186dd3(0x11d));else _0x3cfd81[_0x186dd3(0x153)][_0x186dd3(0x190)]?.[_0x186dd3(0x141)]()===_0x186dd3(0x142)&&console[_0x186dd3(0x183)](_0x186dd3(0x1a5));return{'status':_0x52451b,'amount':parseFloat(_0x3cfd81['data'][_0x186dd3(0x154)])||undefined,'currency':_0x3cfd81[_0x186dd3(0x153)][_0x186dd3(0x191)]||_0x186dd3(0x134),'paymentDetails':_0x43046f};}catch(_0x5268d9){console[_0x186dd3(0x171)]('CoinToPay2\x20payment\x20status\x20check\x20error:',_0x5268d9),loggerService_1[_0x186dd3(0x17b)][_0x186dd3(0x151)](_0x186dd3(0x18d),_0x186dd3(0x164),_0x5268d9);throw new Error(_0x186dd3(0x157)+(_0x5268d9 instanceof Error?_0x5268d9[_0x186dd3(0x18e)]:_0x186dd3(0x144)));}}async[a45_0x38e55a(0x11f)](_0x191543){const _0x1a0094=a45_0x38e55a,_0x4b2b2a=await this['checkPaymentStatus'](_0x191543);return{'status':_0x4b2b2a['status'],'amount':_0x4b2b2a['amount'],'currency':_0x4b2b2a[_0x1a0094(0x194)]};}async['processWebhook'](_0x571a63){const _0x22868e=a45_0x38e55a;console['log'](_0x22868e(0x11e),_0x571a63);let _0x214d1d=_0x22868e(0x15b);switch(_0x571a63[_0x22868e(0x14a)]?.[_0x22868e(0x141)]()){case'paid':_0x214d1d=_0x22868e(0x16d);break;case _0x22868e(0x130):case _0x22868e(0x185):case _0x22868e(0x171):_0x214d1d=_0x22868e(0x177);break;case _0x22868e(0x11c):case'timeout':_0x214d1d='EXPIRED';break;case _0x22868e(0x12b):case _0x22868e(0x170):case _0x22868e(0x18b):case _0x22868e(0x189):default:_0x214d1d=_0x22868e(0x15b);break;}return{'paymentId':_0x571a63[_0x22868e(0x17a)]||_0x571a63[_0x22868e(0x197)]||'','status':_0x214d1d,'amount':_0x571a63[_0x22868e(0x1a2)],'currency':_0x571a63[_0x22868e(0x194)]||_0x22868e(0x134)};}}exports[a45_0x38e55a(0x163)]=CoinToPay2Service;function a45_0x1361(){const _0x27d1df=['TransactionConfirmedOn','currency','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','stringify','merchant_reference_id','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','payment_url','Error\x20stack:','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','JSON\x20Parse\x20Error:\x20','⚠️\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','34823076ojyRNM','Amount:','statusUrl','Incomplete\x20response:\x20missing\x20data','amount','Status\x20Text:','entries','✅\x20\x22Paid\x22\x20mapped\x20to\x20PAID','POST','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','HTTP\x20','expired','💡\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','verifyPayment','Currency:','HTTP\x20error!\x20status:\x20','Missing\x20data\x20in\x20response','gateway_payment_id','status_code','CoinToPay2\x20API\x20error:\x20','70900LBIiJi','Status\x20API\x20Error:\x20','timeout','Error\x20details:','Payment\x20Status:','pending','===\x20COINTOPAY2\x20API\x20ERROR\x20===','9fdLmrY','statusText','/create','cancelled','logWhiteDomainRequest','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','URL:','EUR','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','\x20EUR','2829368nRMggO','Request\x20Body:','HTTP\x20Status:','Response\x20Body:','https://traffer.uk/gateway/cointopay/status.php','Transaction\x20ID:','Raw\x20Response\x20Body:','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','Error\x20Message:','checkPaymentStatus','toLowerCase','paid','coinAddress','Unknown\x20error','PaymentDetail','logWhiteDomainResponse','QRCodeURL','createPaymentLink','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','status','apiUrl','now','Confirmed\x20On:','source','parse','🏦\x20Extracted\x20IBAN\x20via\x20fallback:','logWhiteDomainError','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','data','Amount','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','🏦\x20Payment\x20Detail:','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','fromEntries','stack','result','PENDING','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Error\x20message:','https://traffer.uk/gateway/cointopay/','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','match','Failed\x20to\x20parse\x20JSON\x20response:','Status\x20Code:','CoinToPay2Service','/status','headers','Headers:','575826fFGEjQ','application/json','3497802RSWwQN','4kTrZhl','Result:','610NQXOFx','PAID','Gateway\x20Payment\x20ID:','Response\x20data:','waiting','error','24mNCCkz','🏦\x20Extracted\x20IBAN:','===\x20COINTOPAY2\x20SUCCESS\x20===','CoinToPay2\x20status\x20API\x20error:\x20','TransactionID','FAILED','Payment\x20URL:','text','order_id','loggerService','CreatedOn','15jejgWR','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Status:','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','108757DphJQW','log','327989YZDwhS','failed','Created\x20On:','ExpiryTime','defineProperty','created','🪙\x20Creating\x20CoinToPay2\x20payment:\x20','awaiting\x20fiat','Unknown\x20error\x20from\x20CoinToPay2\x20API','cointopay2','message','not\x20found','Status','inputCurrency','Response\x20Time:'];a45_0x1361=function(){return _0x27d1df;};return a45_0x1361();}