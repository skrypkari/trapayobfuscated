'use strict';const a40_0x241b57=a40_0x53e8;(function(_0x232f91,_0x4dce01){const _0x11c89b=a40_0x53e8,_0x5cbba9=_0x232f91();while(!![]){try{const _0x9070eb=parseInt(_0x11c89b(0x180))/0x1*(-parseInt(_0x11c89b(0x145))/0x2)+parseInt(_0x11c89b(0x157))/0x3*(parseInt(_0x11c89b(0x14a))/0x4)+-parseInt(_0x11c89b(0x199))/0x5*(parseInt(_0x11c89b(0x182))/0x6)+parseInt(_0x11c89b(0x179))/0x7+parseInt(_0x11c89b(0x156))/0x8*(-parseInt(_0x11c89b(0x167))/0x9)+parseInt(_0x11c89b(0x12b))/0xa*(-parseInt(_0x11c89b(0x192))/0xb)+parseInt(_0x11c89b(0x13a))/0xc;if(_0x9070eb===_0x4dce01)break;else _0x5cbba9['push'](_0x5cbba9['shift']());}catch(_0x1a7593){_0x5cbba9['push'](_0x5cbba9['shift']());}}}(a40_0x2ae3,0xd0bc9));Object[a40_0x241b57(0x12d)](exports,a40_0x241b57(0x129),{'value':!![]}),exports['CoinToPay2Service']=void 0x0;const loggerService_1=require('../loggerService');function a40_0x2ae3(){const _0x1ca7e0=['EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','status','üìä\x20Status\x20check\x20URL:','__esModule','/create','10TQXEmd','Error\x20stack:','defineProperty','statusText','Headers:','message','CoinToPay2\x20status\x20API\x20error:\x20','currency','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','üè¶\x20Extracted\x20IBAN:','processWebhook','headers','waiting','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','34990380IQsOwt','error','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','Payment\x20Status:','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','fromEntries','PAID','Status\x20API\x20Error:\x20','logWhiteDomainResponse','Error\x20details:','loggerService','64058nqauYQ','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','Response\x20data:','statusUrl','cointopay2','1415448WHwRKJ','Status:','stringify','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','CoinToPay2\x20payment\x20status\x20check\x20error:','success','not\x20found','===\x20COINTOPAY2\x20SUCCESS\x20===','HTTP\x20error!\x20status:\x20','Parsed\x20Result:','Currency:','failed','2648HHkDbU','6xXiBOu','===\x20COINTOPAY2\x20API\x20ERROR\x20===','HTTP\x20Status:','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','Request\x20Body:','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','TransactionID','FAILED','QRCodeURL','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Amount:','logWhiteDomainError','awaiting\x20fiat','application/json','createPaymentLink','25317BenanX','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','Status\x20Text:','\x20EUR','parse','Status\x20Code:','Raw\x20Response\x20Body:','CoinToPay2Service','amount','Created\x20On:','Result:','Amount','toLowerCase','Response\x20Body:','data','cancelled','result','https://traffer.uk/gateway/cointopay/','7730142HCbTVc','expired','EUR','gateway_payment_id','log','paid','merchant_reference_id','20rRNJQR','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','18YHzNaQ','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','CoinToPay2\x20API\x20error:\x20','https://traffer.uk/gateway/cointopay/status.php','Unknown\x20error\x20from\x20CoinToPay2\x20API','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','Error\x20Message:','pending','PaymentDetail','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','Failed\x20to\x20parse\x20JSON\x20response:','JSON\x20Parse\x20Error:\x20','payment_url','coinAddress','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','10130890QDKHtH','Business\x20Error:\x20','now','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Response\x20Time:','2300395BwbxSo','inputCurrency','IBAN:','CreatedOn','EXPIRED','Status','/status','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','Unknown\x20error','TransactionConfirmedOn','POST','created','HTTP\x20','ExpiryTime','apiUrl','logWhiteDomainRequest','PENDING','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','text','checkPaymentStatus','status_code','Incomplete\x20response:\x20missing\x20data','entries'];a40_0x2ae3=function(){return _0x1ca7e0;};return a40_0x2ae3();}function a40_0x53e8(_0x4e1d37,_0x1dbd11){const _0x2ae38a=a40_0x2ae3();return a40_0x53e8=function(_0x53e87c,_0xa6828e){_0x53e87c=_0x53e87c-0x11b;let _0x213cc5=_0x2ae38a[_0x53e87c];return _0x213cc5;},a40_0x53e8(_0x4e1d37,_0x1dbd11);}class CoinToPay2Service{constructor(){const _0x4d9b34=a40_0x241b57;this[_0x4d9b34(0x11d)]=_0x4d9b34(0x178),this[_0x4d9b34(0x148)]=_0x4d9b34(0x185),console[_0x4d9b34(0x17d)](_0x4d9b34(0x188)),console[_0x4d9b34(0x17d)](_0x4d9b34(0x128),this[_0x4d9b34(0x148)]);}async[a40_0x241b57(0x166)](_0x3e4cdb){const _0x4cf95c=a40_0x241b57,{orderId:_0x4ed5b4,amount:_0x15122b}=_0x3e4cdb;console['log'](_0x4cf95c(0x146)+_0x15122b+_0x4cf95c(0x16a));const _0x1ca457={'amount':_0x15122b},_0x2d7b67=Date['now']();try{console[_0x4cf95c(0x17d)](_0x4cf95c(0x15c)),console[_0x4cf95c(0x17d)]('URL:',this[_0x4cf95c(0x11d)]),console['log'](_0x4cf95c(0x15b),JSON[_0x4cf95c(0x14c)](_0x1ca457,null,0x2)),console[_0x4cf95c(0x17d)](_0x4cf95c(0x162),_0x15122b,_0x4cf95c(0x126)),loggerService_1['loggerService'][_0x4cf95c(0x11e)](_0x4cf95c(0x149),'/create',_0x4cf95c(0x1a3),_0x1ca457);const _0x5ffaf0=await fetch(this[_0x4cf95c(0x11d)],{'method':_0x4cf95c(0x1a3),'headers':{'Content-Type':_0x4cf95c(0x165),'Accept':_0x4cf95c(0x165),'User-Agent':_0x4cf95c(0x13c)},'body':JSON['stringify'](_0x1ca457)}),_0x4f959e=Date[_0x4cf95c(0x194)]()-_0x2d7b67;console[_0x4cf95c(0x17d)](_0x4cf95c(0x160)),console[_0x4cf95c(0x17d)](_0x4cf95c(0x14b),_0x5ffaf0[_0x4cf95c(0x127)]),console['log'](_0x4cf95c(0x169),_0x5ffaf0[_0x4cf95c(0x12e)]),console['log'](_0x4cf95c(0x12f),Object[_0x4cf95c(0x13f)](_0x5ffaf0[_0x4cf95c(0x136)][_0x4cf95c(0x125)]())),console[_0x4cf95c(0x17d)](_0x4cf95c(0x198),_0x4f959e+'ms');const _0x4e8f99=await _0x5ffaf0[_0x4cf95c(0x121)]();console[_0x4cf95c(0x17d)]('Raw\x20Response\x20Body:',_0x4e8f99);if(!_0x5ffaf0['ok']){console['error'](_0x4cf95c(0x158)),console[_0x4cf95c(0x13b)](_0x4cf95c(0x159),_0x5ffaf0[_0x4cf95c(0x127)]),console[_0x4cf95c(0x13b)](_0x4cf95c(0x174),_0x4e8f99),loggerService_1[_0x4cf95c(0x144)][_0x4cf95c(0x142)](_0x4cf95c(0x149),_0x4cf95c(0x12a),_0x5ffaf0[_0x4cf95c(0x127)],_0x4e8f99,_0x4f959e),loggerService_1[_0x4cf95c(0x144)][_0x4cf95c(0x163)]('cointopay2',_0x4cf95c(0x12a),_0x4cf95c(0x11b)+_0x5ffaf0[_0x4cf95c(0x127)]+':\x20'+_0x4e8f99);throw new Error(_0x4cf95c(0x152)+_0x5ffaf0[_0x4cf95c(0x127)]+',\x20body:\x20'+_0x4e8f99);}let _0x2d6b31;try{_0x2d6b31=JSON[_0x4cf95c(0x16b)](_0x4e8f99);}catch(_0x3a21a1){console[_0x4cf95c(0x13b)](_0x4cf95c(0x18d),_0x3a21a1),loggerService_1[_0x4cf95c(0x144)][_0x4cf95c(0x163)](_0x4cf95c(0x149),_0x4cf95c(0x12a),_0x4cf95c(0x18e)+_0x3a21a1);throw new Error(_0x4cf95c(0x139)+_0x4e8f99);}console[_0x4cf95c(0x17d)](_0x4cf95c(0x197)),console['log'](_0x4cf95c(0x153),JSON[_0x4cf95c(0x14c)](_0x2d6b31,null,0x2)),loggerService_1[_0x4cf95c(0x144)][_0x4cf95c(0x142)](_0x4cf95c(0x149),_0x4cf95c(0x12a),_0x5ffaf0['status'],_0x2d6b31,_0x4f959e);if(_0x2d6b31['error']){const _0x22e2b2=_0x2d6b31['message']||_0x2d6b31[_0x4cf95c(0x13b)]||_0x4cf95c(0x186);console[_0x4cf95c(0x13b)](_0x4cf95c(0x15a)),console['error'](_0x4cf95c(0x189),_0x22e2b2),loggerService_1['loggerService'][_0x4cf95c(0x163)](_0x4cf95c(0x149),'/create',_0x4cf95c(0x193)+_0x22e2b2);throw new Error(_0x4cf95c(0x184)+_0x22e2b2);}if(!_0x2d6b31[_0x4cf95c(0x18f)]||!_0x2d6b31[_0x4cf95c(0x17c)]){console[_0x4cf95c(0x13b)](_0x4cf95c(0x161)),console[_0x4cf95c(0x13b)](_0x4cf95c(0x138)),console[_0x4cf95c(0x13b)](_0x4cf95c(0x147),_0x2d6b31),loggerService_1[_0x4cf95c(0x144)][_0x4cf95c(0x163)](_0x4cf95c(0x149),'/create',_0x4cf95c(0x120));throw new Error(_0x4cf95c(0x196));}return console['log'](_0x4cf95c(0x151)),console[_0x4cf95c(0x17d)]('Gateway\x20Payment\x20ID:',_0x2d6b31[_0x4cf95c(0x17c)]),console[_0x4cf95c(0x17d)]('Payment\x20URL:',_0x2d6b31[_0x4cf95c(0x18f)]),console[_0x4cf95c(0x17d)](_0x4cf95c(0x162),_0x15122b,_0x4cf95c(0x17b)),{'gateway_payment_id':_0x2d6b31[_0x4cf95c(0x17c)],'payment_url':_0x2d6b31['payment_url']};}catch(_0x46c1a5){console[_0x4cf95c(0x13b)]('===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20==='),console[_0x4cf95c(0x13b)](_0x4cf95c(0x143),_0x46c1a5),loggerService_1['loggerService'][_0x4cf95c(0x163)](_0x4cf95c(0x149),_0x4cf95c(0x12a),_0x46c1a5);if(_0x46c1a5 instanceof Error){console['error']('Error\x20message:',_0x46c1a5['message']),console[_0x4cf95c(0x13b)](_0x4cf95c(0x12c),_0x46c1a5['stack']);throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20'+_0x46c1a5['message']);}throw new Error(_0x4cf95c(0x13e));}}async[a40_0x241b57(0x122)](_0x4b4d9e){const _0x12ffaf=a40_0x241b57,_0x272dc4=Date[_0x12ffaf(0x194)]();try{console[_0x12ffaf(0x17d)](_0x12ffaf(0x187)+_0x4b4d9e);const _0x8c3b69={'gatewayPaymentId':_0x4b4d9e};loggerService_1[_0x12ffaf(0x144)]['logWhiteDomainRequest'](_0x12ffaf(0x149),_0x12ffaf(0x19f),'POST',_0x8c3b69);const _0x1ae21d=await fetch(this[_0x12ffaf(0x148)],{'method':_0x12ffaf(0x1a3),'headers':{'Content-Type':_0x12ffaf(0x165),'Accept':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON[_0x12ffaf(0x14c)](_0x8c3b69)}),_0x50a07a=Date[_0x12ffaf(0x194)]()-_0x272dc4;console[_0x12ffaf(0x17d)]('===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20==='),console[_0x12ffaf(0x17d)]('Status:',_0x1ae21d['status']),console[_0x12ffaf(0x17d)](_0x12ffaf(0x198),_0x50a07a+'ms');if(!_0x1ae21d['ok']){const _0x5b2aae=await _0x1ae21d[_0x12ffaf(0x121)]();console['error'](_0x12ffaf(0x159),_0x1ae21d[_0x12ffaf(0x127)]),console[_0x12ffaf(0x13b)](_0x12ffaf(0x174),_0x5b2aae),loggerService_1[_0x12ffaf(0x144)][_0x12ffaf(0x142)]('cointopay2','/status',_0x1ae21d[_0x12ffaf(0x127)],_0x5b2aae,_0x50a07a),loggerService_1['loggerService'][_0x12ffaf(0x163)](_0x12ffaf(0x149),_0x12ffaf(0x19f),_0x12ffaf(0x11b)+_0x1ae21d[_0x12ffaf(0x127)]+':\x20'+_0x5b2aae);throw new Error('HTTP\x20error!\x20status:\x20'+_0x1ae21d[_0x12ffaf(0x127)]);}const _0x1f891e=await _0x1ae21d[_0x12ffaf(0x121)]();console[_0x12ffaf(0x17d)](_0x12ffaf(0x16d),_0x1f891e);let _0x1073e0;try{_0x1073e0=JSON['parse'](_0x1f891e);}catch(_0x25ef01){console[_0x12ffaf(0x13b)](_0x12ffaf(0x18d),_0x25ef01),loggerService_1[_0x12ffaf(0x144)]['logWhiteDomainError']('cointopay2','/status',_0x12ffaf(0x18e)+_0x25ef01);throw new Error(_0x12ffaf(0x18c)+_0x1f891e);}loggerService_1[_0x12ffaf(0x144)][_0x12ffaf(0x142)](_0x12ffaf(0x149),'/status',_0x1ae21d[_0x12ffaf(0x127)],_0x1073e0,_0x50a07a),console[_0x12ffaf(0x17d)](_0x12ffaf(0x133)),console[_0x12ffaf(0x17d)](_0x12ffaf(0x171),_0x1073e0[_0x12ffaf(0x177)]),console[_0x12ffaf(0x17d)](_0x12ffaf(0x16c),_0x1073e0[_0x12ffaf(0x123)]),console['log'](_0x12ffaf(0x13d),_0x1073e0['data']?.['Status']),console[_0x12ffaf(0x17d)]('Amount:',_0x1073e0['data']?.[_0x12ffaf(0x172)]),console[_0x12ffaf(0x17d)](_0x12ffaf(0x154),_0x1073e0[_0x12ffaf(0x175)]?.[_0x12ffaf(0x19a)]);if(_0x1073e0['result']!==_0x12ffaf(0x14f)||_0x1073e0[_0x12ffaf(0x123)]!==0xc8){const _0xdf14be=_0x1073e0[_0x12ffaf(0x130)]||_0x12ffaf(0x181);console[_0x12ffaf(0x13b)]('===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20==='),console['error']('Error\x20Message:',_0xdf14be),loggerService_1[_0x12ffaf(0x144)][_0x12ffaf(0x163)](_0x12ffaf(0x149),_0x12ffaf(0x19f),_0x12ffaf(0x141)+_0xdf14be);throw new Error(_0x12ffaf(0x131)+_0xdf14be);}if(!_0x1073e0[_0x12ffaf(0x175)]){console['error']('===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x12ffaf(0x13b)]('Missing\x20data\x20in\x20response'),loggerService_1[_0x12ffaf(0x144)][_0x12ffaf(0x163)]('cointopay2',_0x12ffaf(0x19f),_0x12ffaf(0x124));throw new Error(_0x12ffaf(0x14d));}let _0x1dd3bb=_0x12ffaf(0x11f);switch(_0x1073e0['data']['Status']?.[_0x12ffaf(0x173)]()){case'paid':_0x1dd3bb=_0x12ffaf(0x140);break;case _0x12ffaf(0x176):case _0x12ffaf(0x155):case _0x12ffaf(0x13b):_0x1dd3bb=_0x12ffaf(0x15e);break;case _0x12ffaf(0x17a):case'timeout':_0x1dd3bb=_0x12ffaf(0x19d);break;case _0x12ffaf(0x137):case _0x12ffaf(0x164):case _0x12ffaf(0x18a):case _0x12ffaf(0x1a4):default:_0x1dd3bb=_0x12ffaf(0x11f);break;}let _0x20fd8d,_0x3c38b8;if(_0x1073e0[_0x12ffaf(0x175)][_0x12ffaf(0x18b)]){const _0x403965=_0x1073e0[_0x12ffaf(0x175)][_0x12ffaf(0x18b)];console[_0x12ffaf(0x17d)]('üè¶\x20Payment\x20Detail:',_0x403965);const _0x14b95f=_0x403965['match'](/IBAN\s+([A-Z0-9]+)/i);_0x14b95f&&(_0x20fd8d=_0x14b95f[0x1],console[_0x12ffaf(0x17d)](_0x12ffaf(0x134),_0x20fd8d)),_0x3c38b8=_0x403965;}const _0x22cdf1={'iban':_0x20fd8d,'bankDetails':_0x3c38b8,'transactionId':_0x1073e0[_0x12ffaf(0x175)][_0x12ffaf(0x15d)],'coinAddress':_0x1073e0['data'][_0x12ffaf(0x190)],'qrCodeUrl':_0x1073e0[_0x12ffaf(0x175)][_0x12ffaf(0x15f)],'expiryTime':_0x1073e0['data'][_0x12ffaf(0x11c)],'createdOn':_0x1073e0[_0x12ffaf(0x175)][_0x12ffaf(0x19c)],'confirmedOn':_0x1073e0[_0x12ffaf(0x175)][_0x12ffaf(0x1a2)]};console[_0x12ffaf(0x17d)](_0x12ffaf(0x191)),console[_0x12ffaf(0x17d)](_0x12ffaf(0x14b),_0x1073e0['data']['Status'],'->',_0x1dd3bb),console[_0x12ffaf(0x17d)]('Amount:',_0x1073e0[_0x12ffaf(0x175)]['Amount'],_0x1073e0[_0x12ffaf(0x175)]['inputCurrency']),console['log']('Transaction\x20ID:',_0x1073e0[_0x12ffaf(0x175)][_0x12ffaf(0x15d)]),console[_0x12ffaf(0x17d)](_0x12ffaf(0x19b),_0x20fd8d||_0x12ffaf(0x150)),console[_0x12ffaf(0x17d)](_0x12ffaf(0x170),_0x1073e0['data'][_0x12ffaf(0x19c)]),console[_0x12ffaf(0x17d)]('Confirmed\x20On:',_0x1073e0[_0x12ffaf(0x175)][_0x12ffaf(0x1a2)]||'not\x20confirmed');if(_0x1073e0[_0x12ffaf(0x175)]['Status']?.[_0x12ffaf(0x173)]()===_0x12ffaf(0x164))console[_0x12ffaf(0x17d)](_0x12ffaf(0x195));else _0x1073e0[_0x12ffaf(0x175)][_0x12ffaf(0x19e)]?.['toLowerCase']()===_0x12ffaf(0x17e)&&console[_0x12ffaf(0x17d)](_0x12ffaf(0x1a0));return{'status':_0x1dd3bb,'amount':parseFloat(_0x1073e0['data'][_0x12ffaf(0x172)])||undefined,'currency':_0x1073e0[_0x12ffaf(0x175)]['inputCurrency']||_0x12ffaf(0x17b),'paymentDetails':_0x22cdf1};}catch(_0x1a4811){console[_0x12ffaf(0x13b)](_0x12ffaf(0x14e),_0x1a4811),loggerService_1[_0x12ffaf(0x144)][_0x12ffaf(0x163)](_0x12ffaf(0x149),'/status',_0x1a4811);throw new Error(_0x12ffaf(0x183)+(_0x1a4811 instanceof Error?_0x1a4811['message']:_0x12ffaf(0x1a1)));}}async['verifyPayment'](_0x513057){const _0x1d577d=a40_0x241b57,_0x47c349=await this[_0x1d577d(0x122)](_0x513057);return{'status':_0x47c349['status'],'amount':_0x47c349['amount'],'currency':_0x47c349['currency']};}async[a40_0x241b57(0x135)](_0x20e80d){const _0x2972c3=a40_0x241b57;console[_0x2972c3(0x17d)](_0x2972c3(0x168),_0x20e80d);let _0x5d55de=_0x2972c3(0x11f);switch(_0x20e80d['status']?.[_0x2972c3(0x173)]()){case _0x2972c3(0x17e):_0x5d55de=_0x2972c3(0x140);break;case _0x2972c3(0x176):case _0x2972c3(0x155):case _0x2972c3(0x13b):_0x5d55de='FAILED';break;case _0x2972c3(0x17a):case'timeout':_0x5d55de=_0x2972c3(0x19d);break;case'pending':case'waiting':case _0x2972c3(0x164):case _0x2972c3(0x1a4):default:_0x5d55de=_0x2972c3(0x11f);break;}return{'paymentId':_0x20e80d['order_id']||_0x20e80d[_0x2972c3(0x17f)]||'','status':_0x5d55de,'amount':_0x20e80d[_0x2972c3(0x16f)],'currency':_0x20e80d[_0x2972c3(0x132)]||'EUR'};}}exports[a40_0x241b57(0x16e)]=CoinToPay2Service;