'use strict';function a54_0x4572(){const _0x2f7091=['Payment\x20URL\x20(original):','coinAddress','PENDING','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Failed\x20to\x20parse\x20JSON\x20response:','not\x20confirmed','statusText','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Unknown\x20error','4121985tbNWuO',',\x20body:\x20','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','URL:','Currency:','TransactionID','Amount:','&alternative=false','__esModule','Status\x20Text:','toLowerCase','CreatedOn','===\x20COINTOPAY2\x20API\x20ERROR\x20===','9795AwIstz','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','Error\x20stack:','Response\x20Body:','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','ExpiryTime','Response\x20data:','https://traffer.uk/gateway/cointopay/status.php','entries','error','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','Parsed\x20Result:','data','1752744JDGwKm','/status','Error\x20message:','Result:','POST','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','Incomplete\x20response:\x20missing\x20data','expired','processWebhook','failed','log','165489tmysnK','status','https://traffer.uk/gateway/cointopay/','status_code','now','Response\x20Time:','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','Headers:','CoinToPay2\x20API\x20error:\x20','22419ERRNnT','stringify','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','Payment\x20System/1.0\x20(CoinToPay2)','Created\x20On:','HTTP\x20error!\x20status:\x20','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','order_id','11DZevsE','result','source','/create','TransactionConfirmedOn','match','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','PAID','not\x20found','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','using\x20pattern:','QRCodeURL','JSON\x20Parse\x20Error:\x20','message','5849570tnZFMq','Payment\x20Status:','2648XLHrnu','pending','HTTP\x20Status:','IBAN:','logWhiteDomainResponse','stack','paid','application/json','CoinToPay2\x20status\x20API\x20error:\x20','cointopay2','Raw\x20Response\x20Body:','üè¶\x20Payment\x20Detail:','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','merchant_reference_id','Status\x20API\x20Error:\x20','624sBwbyT','cancelled','CoinToPay2Service','5bQaBwV','Payment\x20URL\x20(modified):','Business\x20Error:\x20','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','currency','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','createPaymentLink','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','gateway_payment_id','Status:','awaiting\x20fiat','üìä\x20Status\x20check\x20URL:','waiting','Status','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','payment_url','FAILED','success','Error\x20details:','created','EUR','parse','1429530UXlASO','logWhiteDomainError','\x20EUR','checkPaymentStatus','Error\x20Message:','Amount','timeout','inputCurrency','amount','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','HTTP\x20','text','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','logWhiteDomainRequest','Status\x20Code:','loggerService'];a54_0x4572=function(){return _0x2f7091;};return a54_0x4572();}const a54_0xb66ef7=a54_0x2393;function a54_0x2393(_0x151e20,_0x3d3c64){_0x151e20=_0x151e20-0x12b;const _0x45721a=a54_0x4572();let _0x2393bf=_0x45721a[_0x151e20];return _0x2393bf;}(function(_0x3d55ce,_0x24114b){const _0xaa88fa=a54_0x2393,_0x4032c6=_0x3d55ce();while(!![]){try{const _0x42f62e=parseInt(_0xaa88fa(0x142))/0x1+parseInt(_0xaa88fa(0x18c))/0x2+-parseInt(_0xaa88fa(0x1b2))/0x3*(parseInt(_0xaa88fa(0x173))/0x4)+-parseInt(_0xaa88fa(0x176))/0x5*(parseInt(_0xaa88fa(0x137))/0x6)+parseInt(_0xaa88fa(0x1a5))/0x7+-parseInt(_0xaa88fa(0x163))/0x8*(parseInt(_0xaa88fa(0x14b))/0x9)+parseInt(_0xaa88fa(0x161))/0xa*(parseInt(_0xaa88fa(0x153))/0xb);if(_0x42f62e===_0x24114b)break;else _0x4032c6['push'](_0x4032c6['shift']());}catch(_0x2e42a2){_0x4032c6['push'](_0x4032c6['shift']());}}}(a54_0x4572,0x68831));Object['defineProperty'](exports,a54_0xb66ef7(0x1ad),{'value':!![]}),exports[a54_0xb66ef7(0x175)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x18ecc1=a54_0xb66ef7;this['apiUrl']=_0x18ecc1(0x144),this['statusUrl']=_0x18ecc1(0x130),console[_0x18ecc1(0x141)]('ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy'),console[_0x18ecc1(0x141)](_0x18ecc1(0x181),this['statusUrl']);}async[a54_0xb66ef7(0x17c)](_0x1d02c7){const _0x5557ca=a54_0xb66ef7,{orderId:_0x1a2867,amount:_0x1e9a02}=_0x1d02c7;console[_0x5557ca(0x141)](_0x5557ca(0x1b3)+_0x1e9a02+_0x5557ca(0x18e));const _0x3ea802={'amount':_0x1e9a02},_0x2c2475=Date['now']();try{console[_0x5557ca(0x141)](_0x5557ca(0x134)),console['log'](_0x5557ca(0x1a8),this['apiUrl']),console['log']('Request\x20Body:',JSON[_0x5557ca(0x14c)](_0x3ea802,null,0x2)),console['log'](_0x5557ca(0x1ab),_0x1e9a02,_0x5557ca(0x13c)),loggerService_1[_0x5557ca(0x19b)][_0x5557ca(0x199)](_0x5557ca(0x16c),'/create',_0x5557ca(0x13b),_0x3ea802);const _0x1cf68f=await fetch(this['apiUrl'],{'method':_0x5557ca(0x13b),'headers':{'Content-Type':_0x5557ca(0x16a),'Accept':_0x5557ca(0x16a),'User-Agent':'Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON[_0x5557ca(0x14c)](_0x3ea802)}),_0x9e3c9d=Date[_0x5557ca(0x146)]()-_0x2c2475;console[_0x5557ca(0x141)](_0x5557ca(0x1a7)),console[_0x5557ca(0x141)](_0x5557ca(0x17f),_0x1cf68f['status']),console[_0x5557ca(0x141)](_0x5557ca(0x1ae),_0x1cf68f[_0x5557ca(0x1a2)]),console[_0x5557ca(0x141)](_0x5557ca(0x149),Object['fromEntries'](_0x1cf68f['headers'][_0x5557ca(0x131)]())),console['log'](_0x5557ca(0x147),_0x9e3c9d+'ms');const _0x572098=await _0x1cf68f[_0x5557ca(0x197)]();console['log']('Raw\x20Response\x20Body:',_0x572098);if(!_0x1cf68f['ok']){console[_0x5557ca(0x132)](_0x5557ca(0x1b1)),console['error'](_0x5557ca(0x165),_0x1cf68f[_0x5557ca(0x143)]),console[_0x5557ca(0x132)](_0x5557ca(0x12c),_0x572098),loggerService_1['loggerService'][_0x5557ca(0x167)]('cointopay2',_0x5557ca(0x156),_0x1cf68f['status'],_0x572098,_0x9e3c9d),loggerService_1['loggerService'][_0x5557ca(0x18d)](_0x5557ca(0x16c),_0x5557ca(0x156),_0x5557ca(0x196)+_0x1cf68f[_0x5557ca(0x143)]+':\x20'+_0x572098);throw new Error(_0x5557ca(0x150)+_0x1cf68f[_0x5557ca(0x143)]+_0x5557ca(0x1a6)+_0x572098);}let _0x3bc51d;try{_0x3bc51d=JSON[_0x5557ca(0x18b)](_0x572098);}catch(_0x1d1b13){console[_0x5557ca(0x132)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x1d1b13),loggerService_1[_0x5557ca(0x19b)][_0x5557ca(0x18d)](_0x5557ca(0x16c),'/create','JSON\x20Parse\x20Error:\x20'+_0x1d1b13);throw new Error(_0x5557ca(0x16f)+_0x572098);}console[_0x5557ca(0x141)](_0x5557ca(0x159)),console[_0x5557ca(0x141)](_0x5557ca(0x135),JSON[_0x5557ca(0x14c)](_0x3bc51d,null,0x2)),loggerService_1[_0x5557ca(0x19b)]['logWhiteDomainResponse'](_0x5557ca(0x16c),_0x5557ca(0x156),_0x1cf68f[_0x5557ca(0x143)],_0x3bc51d,_0x9e3c9d);if(_0x3bc51d[_0x5557ca(0x132)]){const _0x378650=_0x3bc51d['message']||_0x3bc51d[_0x5557ca(0x132)]||'Unknown\x20error\x20from\x20CoinToPay2\x20API';console[_0x5557ca(0x132)](_0x5557ca(0x12d)),console[_0x5557ca(0x132)](_0x5557ca(0x190),_0x378650),loggerService_1[_0x5557ca(0x19b)][_0x5557ca(0x18d)](_0x5557ca(0x16c),'/create',_0x5557ca(0x178)+_0x378650);throw new Error(_0x5557ca(0x14a)+_0x378650);}if(!_0x3bc51d[_0x5557ca(0x185)]||!_0x3bc51d[_0x5557ca(0x17e)]){console['error'](_0x5557ca(0x19f)),console[_0x5557ca(0x132)](_0x5557ca(0x133)),console[_0x5557ca(0x132)](_0x5557ca(0x12f),_0x3bc51d),loggerService_1[_0x5557ca(0x19b)][_0x5557ca(0x18d)]('cointopay2',_0x5557ca(0x156),_0x5557ca(0x198));throw new Error(_0x5557ca(0x184));}console['log']('===\x20COINTOPAY2\x20SUCCESS\x20==='),console[_0x5557ca(0x141)]('Gateway\x20Payment\x20ID:',_0x3bc51d[_0x5557ca(0x17e)]),console[_0x5557ca(0x141)](_0x5557ca(0x19c),_0x3bc51d[_0x5557ca(0x185)]);const _0x590bbc=_0x3bc51d[_0x5557ca(0x185)]+_0x5557ca(0x1ac);return console[_0x5557ca(0x141)](_0x5557ca(0x177),_0x590bbc),console[_0x5557ca(0x141)]('Amount:',_0x1e9a02,'EUR'),{'gateway_payment_id':_0x3bc51d['gateway_payment_id'],'payment_url':_0x590bbc};}catch(_0x49e1f4){console[_0x5557ca(0x132)](_0x5557ca(0x195)),console[_0x5557ca(0x132)](_0x5557ca(0x188),_0x49e1f4),loggerService_1[_0x5557ca(0x19b)][_0x5557ca(0x18d)](_0x5557ca(0x16c),_0x5557ca(0x156),_0x49e1f4);if(_0x49e1f4 instanceof Error){console[_0x5557ca(0x132)](_0x5557ca(0x139),_0x49e1f4[_0x5557ca(0x160)]),console[_0x5557ca(0x132)](_0x5557ca(0x12b),_0x49e1f4[_0x5557ca(0x168)]);throw new Error(_0x5557ca(0x17b)+_0x49e1f4[_0x5557ca(0x160)]);}throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error');}}async[a54_0xb66ef7(0x18f)](_0xc2292a){const _0x67aea2=a54_0xb66ef7,_0x3fe92f=Date[_0x67aea2(0x146)]();try{console[_0x67aea2(0x141)](_0x67aea2(0x148)+_0xc2292a);const _0x18be8b={'gatewayPaymentId':_0xc2292a};loggerService_1[_0x67aea2(0x19b)][_0x67aea2(0x199)](_0x67aea2(0x16c),_0x67aea2(0x138),'POST',_0x18be8b);const _0x3ba8f0=await fetch(this['statusUrl'],{'method':_0x67aea2(0x13b),'headers':{'Content-Type':_0x67aea2(0x16a),'Accept':_0x67aea2(0x16a),'User-Agent':_0x67aea2(0x14e)},'body':JSON['stringify'](_0x18be8b)}),_0x1b63a6=Date['now']()-_0x3fe92f;console[_0x67aea2(0x141)](_0x67aea2(0x17d)),console['log']('Status:',_0x3ba8f0[_0x67aea2(0x143)]),console[_0x67aea2(0x141)](_0x67aea2(0x147),_0x1b63a6+'ms');if(!_0x3ba8f0['ok']){const _0x4c8884=await _0x3ba8f0[_0x67aea2(0x197)]();console[_0x67aea2(0x132)](_0x67aea2(0x165),_0x3ba8f0[_0x67aea2(0x143)]),console[_0x67aea2(0x132)]('Response\x20Body:',_0x4c8884),loggerService_1[_0x67aea2(0x19b)]['logWhiteDomainResponse']('cointopay2',_0x67aea2(0x138),_0x3ba8f0['status'],_0x4c8884,_0x1b63a6),loggerService_1['loggerService'][_0x67aea2(0x18d)](_0x67aea2(0x16c),_0x67aea2(0x138),_0x67aea2(0x196)+_0x3ba8f0[_0x67aea2(0x143)]+':\x20'+_0x4c8884);throw new Error(_0x67aea2(0x150)+_0x3ba8f0['status']);}const _0x2c7dbe=await _0x3ba8f0['text']();console['log'](_0x67aea2(0x16d),_0x2c7dbe);let _0x825fd0;try{_0x825fd0=JSON['parse'](_0x2c7dbe);}catch(_0x2bfa69){console['error'](_0x67aea2(0x1a0),_0x2bfa69),loggerService_1['loggerService'][_0x67aea2(0x18d)]('cointopay2',_0x67aea2(0x138),_0x67aea2(0x15f)+_0x2bfa69);throw new Error(_0x67aea2(0x14d)+_0x2c7dbe);}loggerService_1[_0x67aea2(0x19b)][_0x67aea2(0x167)]('cointopay2',_0x67aea2(0x138),_0x3ba8f0['status'],_0x825fd0,_0x1b63a6),console['log']('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console['log'](_0x67aea2(0x13a),_0x825fd0['result']),console[_0x67aea2(0x141)](_0x67aea2(0x19a),_0x825fd0[_0x67aea2(0x145)]),console[_0x67aea2(0x141)](_0x67aea2(0x162),_0x825fd0[_0x67aea2(0x136)]?.['Status']),console[_0x67aea2(0x141)]('Amount:',_0x825fd0['data']?.[_0x67aea2(0x191)]),console[_0x67aea2(0x141)](_0x67aea2(0x1a9),_0x825fd0[_0x67aea2(0x136)]?.['inputCurrency']);if(_0x825fd0[_0x67aea2(0x154)]!==_0x67aea2(0x187)||_0x825fd0[_0x67aea2(0x145)]!==0xc8){const _0x2e67e8=_0x825fd0[_0x67aea2(0x160)]||'Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API';console[_0x67aea2(0x132)]('===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20==='),console[_0x67aea2(0x132)](_0x67aea2(0x190),_0x2e67e8),loggerService_1['loggerService'][_0x67aea2(0x18d)](_0x67aea2(0x16c),_0x67aea2(0x138),_0x67aea2(0x172)+_0x2e67e8);throw new Error(_0x67aea2(0x16b)+_0x2e67e8);}if(!_0x825fd0['data']){console[_0x67aea2(0x132)](_0x67aea2(0x170)),console[_0x67aea2(0x132)]('Missing\x20data\x20in\x20response'),loggerService_1[_0x67aea2(0x19b)][_0x67aea2(0x18d)](_0x67aea2(0x16c),_0x67aea2(0x138),_0x67aea2(0x13d));throw new Error(_0x67aea2(0x179));}let _0x1a76ca=_0x67aea2(0x19e);switch(_0x825fd0[_0x67aea2(0x136)][_0x67aea2(0x183)]?.[_0x67aea2(0x1af)]()){case _0x67aea2(0x169):_0x1a76ca=_0x67aea2(0x15a);break;case _0x67aea2(0x174):case'failed':case _0x67aea2(0x132):_0x1a76ca=_0x67aea2(0x186);break;case _0x67aea2(0x13e):case _0x67aea2(0x192):_0x1a76ca='EXPIRED';break;case _0x67aea2(0x182):case _0x67aea2(0x180):case _0x67aea2(0x164):case _0x67aea2(0x189):default:_0x1a76ca=_0x67aea2(0x19e);break;}let _0x1fd399,_0x514a3f;if(_0x825fd0[_0x67aea2(0x136)]['PaymentDetail']){const _0x1be742=_0x825fd0['data']['PaymentDetail'];console[_0x67aea2(0x141)](_0x67aea2(0x16e),_0x1be742);const _0x5057d1=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x53d08f of _0x5057d1){const _0x3a5f3e=_0x1be742['match'](_0x53d08f);if(_0x3a5f3e){_0x1fd399=_0x3a5f3e[0x1],console[_0x67aea2(0x141)]('üè¶\x20Extracted\x20IBAN:',_0x1fd399,_0x67aea2(0x15d),_0x53d08f[_0x67aea2(0x155)]);break;}}if(!_0x1fd399){console['log']('‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...');const _0x202f74=_0x1be742[_0x67aea2(0x158)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x202f74&&(_0x1fd399=_0x202f74[0x1],console['log'](_0x67aea2(0x151),_0x1fd399));}_0x514a3f=_0x1be742;}const _0x33546a={'iban':_0x1fd399,'bankDetails':_0x514a3f,'transactionId':_0x825fd0[_0x67aea2(0x136)][_0x67aea2(0x1aa)],'coinAddress':_0x825fd0[_0x67aea2(0x136)][_0x67aea2(0x19d)],'qrCodeUrl':_0x825fd0[_0x67aea2(0x136)][_0x67aea2(0x15e)],'expiryTime':_0x825fd0[_0x67aea2(0x136)][_0x67aea2(0x12e)],'createdOn':_0x825fd0['data']['CreatedOn'],'confirmedOn':_0x825fd0['data'][_0x67aea2(0x157)]};console['log']('===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20==='),console[_0x67aea2(0x141)](_0x67aea2(0x17f),_0x825fd0[_0x67aea2(0x136)][_0x67aea2(0x183)],'->',_0x1a76ca),console[_0x67aea2(0x141)]('Amount:',_0x825fd0[_0x67aea2(0x136)]['Amount'],_0x825fd0[_0x67aea2(0x136)][_0x67aea2(0x193)]),console[_0x67aea2(0x141)]('Transaction\x20ID:',_0x825fd0[_0x67aea2(0x136)][_0x67aea2(0x1aa)]),console[_0x67aea2(0x141)](_0x67aea2(0x166),_0x1fd399||_0x67aea2(0x15b)),console[_0x67aea2(0x141)](_0x67aea2(0x14f),_0x825fd0[_0x67aea2(0x136)][_0x67aea2(0x1b0)]),console[_0x67aea2(0x141)]('Confirmed\x20On:',_0x825fd0[_0x67aea2(0x136)][_0x67aea2(0x157)]||_0x67aea2(0x1a1));if(_0x825fd0[_0x67aea2(0x136)][_0x67aea2(0x183)]?.[_0x67aea2(0x1af)]()===_0x67aea2(0x180))console[_0x67aea2(0x141)](_0x67aea2(0x1a3));else _0x825fd0[_0x67aea2(0x136)]['Status']?.[_0x67aea2(0x1af)]()===_0x67aea2(0x169)&&console[_0x67aea2(0x141)](_0x67aea2(0x15c));return{'status':_0x1a76ca,'amount':parseFloat(_0x825fd0[_0x67aea2(0x136)][_0x67aea2(0x191)])||undefined,'currency':_0x825fd0['data']['inputCurrency']||_0x67aea2(0x18a),'paymentDetails':_0x33546a};}catch(_0x34598c){console[_0x67aea2(0x132)]('CoinToPay2\x20payment\x20status\x20check\x20error:',_0x34598c),loggerService_1[_0x67aea2(0x19b)]['logWhiteDomainError'](_0x67aea2(0x16c),_0x67aea2(0x138),_0x34598c);throw new Error('Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20'+(_0x34598c instanceof Error?_0x34598c['message']:_0x67aea2(0x1a4)));}}async['verifyPayment'](_0x424544){const _0x55930e=a54_0xb66ef7,_0x4119c=await this[_0x55930e(0x18f)](_0x424544);return{'status':_0x4119c[_0x55930e(0x143)],'amount':_0x4119c['amount'],'currency':_0x4119c[_0x55930e(0x17a)]};}async[a54_0xb66ef7(0x13f)](_0x2ca1e9){const _0x4d1629=a54_0xb66ef7;console[_0x4d1629(0x141)]('Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x2ca1e9);let _0x20db97=_0x4d1629(0x19e);switch(_0x2ca1e9[_0x4d1629(0x143)]?.['toLowerCase']()){case'paid':_0x20db97=_0x4d1629(0x15a);break;case _0x4d1629(0x174):case _0x4d1629(0x140):case'error':_0x20db97=_0x4d1629(0x186);break;case _0x4d1629(0x13e):case _0x4d1629(0x192):_0x20db97='EXPIRED';break;case'pending':case _0x4d1629(0x182):case'awaiting\x20fiat':case _0x4d1629(0x189):default:_0x20db97=_0x4d1629(0x19e);break;}return{'paymentId':_0x2ca1e9[_0x4d1629(0x152)]||_0x2ca1e9[_0x4d1629(0x171)]||'','status':_0x20db97,'amount':_0x2ca1e9[_0x4d1629(0x194)],'currency':_0x2ca1e9[_0x4d1629(0x17a)]||'EUR'};}}exports[a54_0xb66ef7(0x175)]=CoinToPay2Service;