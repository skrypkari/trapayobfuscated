'use strict';const a43_0x2cfe3a=a43_0x4d5c;function a43_0x18d0(){const _0x42213e=['Status:','Payment\x20URL:','fromEntries','data','statusUrl','match','Request\x20Body:','createPaymentLink','83196ohokhB','Amount:','Error\x20message:','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','https://traffer.uk/gateway/cointopay/status.php','Status\x20Text:','entries','currency','error','Gateway\x20Payment\x20ID:','üìä\x20Status\x20check\x20URL:','Raw\x20Response\x20Body:','Transaction\x20ID:','1204675UCIHIk','HTTP\x20','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','now','created','229776eDPPLg','HTTP\x20error!\x20status:\x20','TransactionConfirmedOn','gateway_payment_id','PaymentDetail','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','HTTP\x20Status:','Headers:','161nFZqbI','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','inputCurrency','status_code','54629NTHaSy','27TdZTtc','processWebhook','Confirmed\x20On:','source','awaiting\x20fiat','stringify','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20',',\x20body:\x20','CoinToPay2\x20status\x20API\x20error:\x20','POST','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','\x20EUR','PENDING','../loggerService','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','8ZmuLOi','__esModule','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','timeout','text','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','payment_url','Response\x20Body:','CreatedOn','FAILED','JSON\x20Parse\x20Error:\x20','amount','PAID','expired','üè¶\x20Extracted\x20IBAN:','Response\x20data:','Unknown\x20error','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','35456ytNOmW','IBAN:','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','cointopay2','Missing\x20data\x20in\x20response','Business\x20Error:\x20','Incomplete\x20response:\x20missing\x20data','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','status','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','/create','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','stack','/status','Error\x20Message:','Status\x20API\x20Error:\x20','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','paid','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','CoinToPay2\x20payment\x20status\x20check\x20error:','Status','merchant_reference_id','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','Result:','cancelled','logWhiteDomainRequest','CoinToPay2\x20API\x20error:\x20','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','TransactionID','not\x20found','using\x20pattern:','toLowerCase','27bkWQJs','===\x20COINTOPAY2\x20API\x20ERROR\x20===','316020cvjoAA','loggerService','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','QRCodeURL','parse','8958268KsSWXq','application/json','Failed\x20to\x20parse\x20JSON\x20response:','Currency:','logWhiteDomainError','URL:','success','pending','Response\x20Time:','Status\x20Code:','apiUrl','EUR','log','checkPaymentStatus','CoinToPay2Service','waiting','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','logWhiteDomainResponse','failed','statusText','message'];a43_0x18d0=function(){return _0x42213e;};return a43_0x18d0();}(function(_0x2e29cb,_0x5b0277){const _0x9fd57a=a43_0x4d5c,_0x498735=_0x2e29cb();while(!![]){try{const _0xc3add7=-parseInt(_0x9fd57a(0x134))/0x1*(parseInt(_0x9fd57a(0x144))/0x2)+-parseInt(_0x9fd57a(0x135))/0x3*(parseInt(_0x9fd57a(0x19a))/0x4)+-parseInt(_0x9fd57a(0x1a7))/0x5+-parseInt(_0x9fd57a(0x128))/0x6+-parseInt(_0x9fd57a(0x130))/0x7*(parseInt(_0x9fd57a(0x156))/0x8)+-parseInt(_0x9fd57a(0x176))/0x9*(-parseInt(_0x9fd57a(0x178))/0xa)+parseInt(_0x9fd57a(0x17d))/0xb;if(_0xc3add7===_0x5b0277)break;else _0x498735['push'](_0x498735['shift']());}catch(_0x500ed5){_0x498735['push'](_0x498735['shift']());}}}(a43_0x18d0,0x1ddd0));Object['defineProperty'](exports,a43_0x2cfe3a(0x145),{'value':!![]}),exports[a43_0x2cfe3a(0x18b)]=void 0x0;function a43_0x4d5c(_0x38f936,_0x525159){const _0x18d0ba=a43_0x18d0();return a43_0x4d5c=function(_0x4d5c8e,_0x52408c){_0x4d5c8e=_0x4d5c8e-0x127;let _0x1c0f4a=_0x18d0ba[_0x4d5c8e];return _0x1c0f4a;},a43_0x4d5c(_0x38f936,_0x525159);}const loggerService_1=require(a43_0x2cfe3a(0x142));class CoinToPay2Service{constructor(){const _0x302cc7=a43_0x2cfe3a;this[_0x302cc7(0x187)]='https://traffer.uk/gateway/cointopay/',this[_0x302cc7(0x196)]=_0x302cc7(0x19e),console[_0x302cc7(0x189)](_0x302cc7(0x131)),console[_0x302cc7(0x189)](_0x302cc7(0x1a4),this['statusUrl']);}async[a43_0x2cfe3a(0x199)](_0x3980f3){const _0x4f4c6d=a43_0x2cfe3a,{orderId:_0x1cd348,amount:_0x38d551}=_0x3980f3;console[_0x4f4c6d(0x189)](_0x4f4c6d(0x15d)+_0x38d551+_0x4f4c6d(0x140));const _0xd2dd81={'amount':_0x38d551},_0x1a1824=Date[_0x4f4c6d(0x1aa)]();try{console[_0x4f4c6d(0x189)](_0x4f4c6d(0x1a9)),console[_0x4f4c6d(0x189)](_0x4f4c6d(0x182),this['apiUrl']),console[_0x4f4c6d(0x189)](_0x4f4c6d(0x198),JSON[_0x4f4c6d(0x13a)](_0xd2dd81,null,0x2)),console[_0x4f4c6d(0x189)](_0x4f4c6d(0x19b),_0x38d551,_0x4f4c6d(0x16c)),loggerService_1[_0x4f4c6d(0x179)][_0x4f4c6d(0x16f)](_0x4f4c6d(0x159),'/create',_0x4f4c6d(0x13e),_0xd2dd81);const _0x2bbdc0=await fetch(this[_0x4f4c6d(0x187)],{'method':_0x4f4c6d(0x13e),'headers':{'Content-Type':_0x4f4c6d(0x17e),'Accept':_0x4f4c6d(0x17e),'User-Agent':_0x4f4c6d(0x171)},'body':JSON[_0x4f4c6d(0x13a)](_0xd2dd81)}),_0x5d59f9=Date[_0x4f4c6d(0x1aa)]()-_0x1a1824;console[_0x4f4c6d(0x189)]('===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20==='),console['log'](_0x4f4c6d(0x192),_0x2bbdc0[_0x4f4c6d(0x15e)]),console['log'](_0x4f4c6d(0x19f),_0x2bbdc0[_0x4f4c6d(0x190)]),console['log'](_0x4f4c6d(0x12f),Object[_0x4f4c6d(0x194)](_0x2bbdc0['headers'][_0x4f4c6d(0x1a0)]())),console[_0x4f4c6d(0x189)](_0x4f4c6d(0x185),_0x5d59f9+'ms');const _0x170a79=await _0x2bbdc0[_0x4f4c6d(0x148)]();console[_0x4f4c6d(0x189)](_0x4f4c6d(0x1a5),_0x170a79);if(!_0x2bbdc0['ok']){console[_0x4f4c6d(0x1a2)](_0x4f4c6d(0x177)),console[_0x4f4c6d(0x1a2)](_0x4f4c6d(0x12e),_0x2bbdc0[_0x4f4c6d(0x15e)]),console[_0x4f4c6d(0x1a2)](_0x4f4c6d(0x14b),_0x170a79),loggerService_1[_0x4f4c6d(0x179)]['logWhiteDomainResponse'](_0x4f4c6d(0x159),_0x4f4c6d(0x160),_0x2bbdc0[_0x4f4c6d(0x15e)],_0x170a79,_0x5d59f9),loggerService_1['loggerService'][_0x4f4c6d(0x181)](_0x4f4c6d(0x159),_0x4f4c6d(0x160),_0x4f4c6d(0x1a8)+_0x2bbdc0[_0x4f4c6d(0x15e)]+':\x20'+_0x170a79);throw new Error(_0x4f4c6d(0x129)+_0x2bbdc0[_0x4f4c6d(0x15e)]+_0x4f4c6d(0x13c)+_0x170a79);}let _0x502b89;try{_0x502b89=JSON[_0x4f4c6d(0x17c)](_0x170a79);}catch(_0x2655ec){console[_0x4f4c6d(0x1a2)](_0x4f4c6d(0x17f),_0x2655ec),loggerService_1['loggerService'][_0x4f4c6d(0x181)](_0x4f4c6d(0x159),_0x4f4c6d(0x160),_0x4f4c6d(0x14e)+_0x2655ec);throw new Error(_0x4f4c6d(0x18d)+_0x170a79);}console[_0x4f4c6d(0x189)]('===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20==='),console[_0x4f4c6d(0x189)]('Parsed\x20Result:',JSON[_0x4f4c6d(0x13a)](_0x502b89,null,0x2)),loggerService_1[_0x4f4c6d(0x179)][_0x4f4c6d(0x18e)](_0x4f4c6d(0x159),_0x4f4c6d(0x160),_0x2bbdc0[_0x4f4c6d(0x15e)],_0x502b89,_0x5d59f9);if(_0x502b89['error']){const _0x36a10a=_0x502b89[_0x4f4c6d(0x191)]||_0x502b89[_0x4f4c6d(0x1a2)]||'Unknown\x20error\x20from\x20CoinToPay2\x20API';console['error']('===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20==='),console['error'](_0x4f4c6d(0x164),_0x36a10a),loggerService_1[_0x4f4c6d(0x179)][_0x4f4c6d(0x181)](_0x4f4c6d(0x159),_0x4f4c6d(0x160),_0x4f4c6d(0x15b)+_0x36a10a);throw new Error(_0x4f4c6d(0x170)+_0x36a10a);}if(!_0x502b89[_0x4f4c6d(0x14a)]||!_0x502b89['gateway_payment_id']){console[_0x4f4c6d(0x1a2)](_0x4f4c6d(0x146)),console[_0x4f4c6d(0x1a2)](_0x4f4c6d(0x166)),console['error'](_0x4f4c6d(0x153),_0x502b89),loggerService_1[_0x4f4c6d(0x179)][_0x4f4c6d(0x181)](_0x4f4c6d(0x159),_0x4f4c6d(0x160),_0x4f4c6d(0x143));throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id');}return console[_0x4f4c6d(0x189)]('===\x20COINTOPAY2\x20SUCCESS\x20==='),console['log'](_0x4f4c6d(0x1a3),_0x502b89['gateway_payment_id']),console[_0x4f4c6d(0x189)](_0x4f4c6d(0x193),_0x502b89['payment_url']),console[_0x4f4c6d(0x189)](_0x4f4c6d(0x19b),_0x38d551,_0x4f4c6d(0x188)),{'gateway_payment_id':_0x502b89[_0x4f4c6d(0x12b)],'payment_url':_0x502b89['payment_url']};}catch(_0x20f5ef){console[_0x4f4c6d(0x1a2)](_0x4f4c6d(0x15f)),console[_0x4f4c6d(0x1a2)]('Error\x20details:',_0x20f5ef),loggerService_1['loggerService'][_0x4f4c6d(0x181)](_0x4f4c6d(0x159),_0x4f4c6d(0x160),_0x20f5ef);if(_0x20f5ef instanceof Error){console['error'](_0x4f4c6d(0x19c),_0x20f5ef[_0x4f4c6d(0x191)]),console[_0x4f4c6d(0x1a2)]('Error\x20stack:',_0x20f5ef[_0x4f4c6d(0x162)]);throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20'+_0x20f5ef['message']);}throw new Error(_0x4f4c6d(0x158));}}async[a43_0x2cfe3a(0x18a)](_0x19587c){const _0x328403=a43_0x2cfe3a,_0x422787=Date[_0x328403(0x1aa)]();try{console[_0x328403(0x189)]('üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20'+_0x19587c);const _0x4843b9={'gatewayPaymentId':_0x19587c};loggerService_1['loggerService'][_0x328403(0x16f)](_0x328403(0x159),_0x328403(0x163),_0x328403(0x13e),_0x4843b9);const _0x4232ea=await fetch(this['statusUrl'],{'method':_0x328403(0x13e),'headers':{'Content-Type':'application/json','Accept':_0x328403(0x17e),'User-Agent':_0x328403(0x171)},'body':JSON[_0x328403(0x13a)](_0x4843b9)}),_0x30877e=Date[_0x328403(0x1aa)]()-_0x422787;console[_0x328403(0x189)](_0x328403(0x17a)),console[_0x328403(0x189)](_0x328403(0x192),_0x4232ea[_0x328403(0x15e)]),console[_0x328403(0x189)](_0x328403(0x185),_0x30877e+'ms');if(!_0x4232ea['ok']){const _0x553f0f=await _0x4232ea['text']();console[_0x328403(0x1a2)](_0x328403(0x12e),_0x4232ea[_0x328403(0x15e)]),console[_0x328403(0x1a2)](_0x328403(0x14b),_0x553f0f),loggerService_1[_0x328403(0x179)][_0x328403(0x18e)](_0x328403(0x159),_0x328403(0x163),_0x4232ea[_0x328403(0x15e)],_0x553f0f,_0x30877e),loggerService_1['loggerService'][_0x328403(0x181)](_0x328403(0x159),_0x328403(0x163),_0x328403(0x1a8)+_0x4232ea[_0x328403(0x15e)]+':\x20'+_0x553f0f);throw new Error(_0x328403(0x129)+_0x4232ea['status']);}const _0x582db4=await _0x4232ea[_0x328403(0x148)]();console[_0x328403(0x189)]('Raw\x20Response\x20Body:',_0x582db4);let _0x103b7d;try{_0x103b7d=JSON['parse'](_0x582db4);}catch(_0x20a9da){console[_0x328403(0x1a2)](_0x328403(0x17f),_0x20a9da),loggerService_1[_0x328403(0x179)]['logWhiteDomainError']('cointopay2','/status',_0x328403(0x14e)+_0x20a9da);throw new Error(_0x328403(0x13f)+_0x582db4);}loggerService_1[_0x328403(0x179)][_0x328403(0x18e)](_0x328403(0x159),_0x328403(0x163),_0x4232ea['status'],_0x103b7d,_0x30877e),console[_0x328403(0x189)]('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console[_0x328403(0x189)](_0x328403(0x16d),_0x103b7d['result']),console[_0x328403(0x189)](_0x328403(0x186),_0x103b7d['status_code']),console[_0x328403(0x189)]('Payment\x20Status:',_0x103b7d[_0x328403(0x195)]?.[_0x328403(0x16a)]),console['log'](_0x328403(0x19b),_0x103b7d[_0x328403(0x195)]?.['Amount']),console[_0x328403(0x189)](_0x328403(0x180),_0x103b7d[_0x328403(0x195)]?.[_0x328403(0x132)]);if(_0x103b7d['result']!==_0x328403(0x183)||_0x103b7d[_0x328403(0x133)]!==0xc8){const _0x9e8f24=_0x103b7d[_0x328403(0x191)]||_0x328403(0x19d);console[_0x328403(0x1a2)]('===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20==='),console['error']('Error\x20Message:',_0x9e8f24),loggerService_1[_0x328403(0x179)]['logWhiteDomainError'](_0x328403(0x159),'/status',_0x328403(0x165)+_0x9e8f24);throw new Error(_0x328403(0x13d)+_0x9e8f24);}if(!_0x103b7d[_0x328403(0x195)]){console[_0x328403(0x1a2)]('===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x328403(0x1a2)](_0x328403(0x15a)),loggerService_1[_0x328403(0x179)]['logWhiteDomainError']('cointopay2',_0x328403(0x163),_0x328403(0x15c));throw new Error(_0x328403(0x12d));}let _0xe709ef=_0x328403(0x141);switch(_0x103b7d['data'][_0x328403(0x16a)]?.['toLowerCase']()){case _0x328403(0x167):_0xe709ef='PAID';break;case _0x328403(0x16e):case'failed':case _0x328403(0x1a2):_0xe709ef=_0x328403(0x14d);break;case _0x328403(0x151):case'timeout':_0xe709ef='EXPIRED';break;case _0x328403(0x18c):case _0x328403(0x139):case'pending':case _0x328403(0x127):default:_0xe709ef=_0x328403(0x141);break;}let _0x3b1c69,_0x21f079;if(_0x103b7d[_0x328403(0x195)][_0x328403(0x12c)]){const _0x583fa0=_0x103b7d[_0x328403(0x195)][_0x328403(0x12c)];console[_0x328403(0x189)]('üè¶\x20Payment\x20Detail:',_0x583fa0);const _0x3299c2=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x22f86b of _0x3299c2){const _0x4c113c=_0x583fa0['match'](_0x22f86b);if(_0x4c113c){_0x3b1c69=_0x4c113c[0x1],console[_0x328403(0x189)](_0x328403(0x152),_0x3b1c69,_0x328403(0x174),_0x22f86b[_0x328403(0x138)]);break;}}if(!_0x3b1c69){console[_0x328403(0x189)]('‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...');const _0x4c11cc=_0x583fa0[_0x328403(0x197)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x4c11cc&&(_0x3b1c69=_0x4c11cc[0x1],console['log'](_0x328403(0x161),_0x3b1c69));}_0x21f079=_0x583fa0;}const _0x5704b2={'iban':_0x3b1c69,'bankDetails':_0x21f079,'transactionId':_0x103b7d[_0x328403(0x195)]['TransactionID'],'coinAddress':_0x103b7d[_0x328403(0x195)]['coinAddress'],'qrCodeUrl':_0x103b7d[_0x328403(0x195)][_0x328403(0x17b)],'expiryTime':_0x103b7d[_0x328403(0x195)]['ExpiryTime'],'createdOn':_0x103b7d[_0x328403(0x195)][_0x328403(0x14c)],'confirmedOn':_0x103b7d[_0x328403(0x195)][_0x328403(0x12a)]};console[_0x328403(0x189)](_0x328403(0x155)),console[_0x328403(0x189)](_0x328403(0x192),_0x103b7d[_0x328403(0x195)]['Status'],'->',_0xe709ef),console['log'](_0x328403(0x19b),_0x103b7d['data']['Amount'],_0x103b7d[_0x328403(0x195)]['inputCurrency']),console[_0x328403(0x189)](_0x328403(0x1a6),_0x103b7d['data'][_0x328403(0x172)]),console[_0x328403(0x189)](_0x328403(0x157),_0x3b1c69||_0x328403(0x173)),console[_0x328403(0x189)]('Created\x20On:',_0x103b7d['data'][_0x328403(0x14c)]),console[_0x328403(0x189)](_0x328403(0x137),_0x103b7d[_0x328403(0x195)][_0x328403(0x12a)]||'not\x20confirmed');if(_0x103b7d[_0x328403(0x195)]['Status']?.[_0x328403(0x175)]()===_0x328403(0x139))console['log']('üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)');else _0x103b7d[_0x328403(0x195)][_0x328403(0x16a)]?.[_0x328403(0x175)]()===_0x328403(0x167)&&console[_0x328403(0x189)](_0x328403(0x168));return{'status':_0xe709ef,'amount':parseFloat(_0x103b7d['data']['Amount'])||undefined,'currency':_0x103b7d[_0x328403(0x195)][_0x328403(0x132)]||_0x328403(0x188),'paymentDetails':_0x5704b2};}catch(_0x466a5a){console['error'](_0x328403(0x169),_0x466a5a),loggerService_1[_0x328403(0x179)][_0x328403(0x181)](_0x328403(0x159),_0x328403(0x163),_0x466a5a);throw new Error(_0x328403(0x13b)+(_0x466a5a instanceof Error?_0x466a5a[_0x328403(0x191)]:_0x328403(0x154)));}}async['verifyPayment'](_0x14a561){const _0x42a50e=a43_0x2cfe3a,_0x4ea8dd=await this[_0x42a50e(0x18a)](_0x14a561);return{'status':_0x4ea8dd[_0x42a50e(0x15e)],'amount':_0x4ea8dd['amount'],'currency':_0x4ea8dd[_0x42a50e(0x1a1)]};}async[a43_0x2cfe3a(0x136)](_0x3a90b3){const _0x24f786=a43_0x2cfe3a;console[_0x24f786(0x189)](_0x24f786(0x149),_0x3a90b3);let _0xb86dc3=_0x24f786(0x141);switch(_0x3a90b3[_0x24f786(0x15e)]?.[_0x24f786(0x175)]()){case _0x24f786(0x167):_0xb86dc3=_0x24f786(0x150);break;case _0x24f786(0x16e):case _0x24f786(0x18f):case _0x24f786(0x1a2):_0xb86dc3=_0x24f786(0x14d);break;case _0x24f786(0x151):case _0x24f786(0x147):_0xb86dc3='EXPIRED';break;case _0x24f786(0x184):case _0x24f786(0x18c):case _0x24f786(0x139):case'created':default:_0xb86dc3=_0x24f786(0x141);break;}return{'paymentId':_0x3a90b3['order_id']||_0x3a90b3[_0x24f786(0x16b)]||'','status':_0xb86dc3,'amount':_0x3a90b3[_0x24f786(0x14f)],'currency':_0x3a90b3['currency']||_0x24f786(0x188)};}}exports['CoinToPay2Service']=CoinToPay2Service;