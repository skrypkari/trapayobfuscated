'use strict';const a54_0x58dd02=a54_0x3b70;(function(_0x20e132,_0xeb9f05){const _0x1ea881=a54_0x3b70,_0x3db11f=_0x20e132();while(!![]){try{const _0x5e26da=-parseInt(_0x1ea881(0xfb))/0x1*(parseInt(_0x1ea881(0x174))/0x2)+-parseInt(_0x1ea881(0x104))/0x3+-parseInt(_0x1ea881(0x166))/0x4*(-parseInt(_0x1ea881(0x119))/0x5)+-parseInt(_0x1ea881(0x127))/0x6*(parseInt(_0x1ea881(0x14e))/0x7)+-parseInt(_0x1ea881(0x117))/0x8*(parseInt(_0x1ea881(0x138))/0x9)+-parseInt(_0x1ea881(0x105))/0xa+parseInt(_0x1ea881(0x10b))/0xb;if(_0x5e26da===_0xeb9f05)break;else _0x3db11f['push'](_0x3db11f['shift']());}catch(_0x21d4eb){_0x3db11f['push'](_0x3db11f['shift']());}}}(a54_0x4396,0x6453d));function a54_0x3b70(_0x5d5b17,_0x23b522){_0x5d5b17=_0x5d5b17-0xf9;const _0x439697=a54_0x4396();let _0x3b70a5=_0x439697[_0x5d5b17];return _0x3b70a5;}Object[a54_0x58dd02(0x120)](exports,'__esModule',{'value':!![]}),exports['CoinToPay2Service']=void 0x0;const loggerService_1=require('../loggerService');function a54_0x4396(){const _0x39ce6d=['Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','application/json','CoinToPay2\x20payment\x20status\x20check\x20error:','Created\x20On:','failed','CoinToPay2Service','Gateway\x20Payment\x20ID:','expired','20iyJUsu','Status','merchant_reference_id','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','createPaymentLink','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','Raw\x20Response\x20Body:','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','URL:','awaiting\x20fiat','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','fromEntries','pending','3746ZWqDEV','TransactionConfirmedOn','processWebhook','Error\x20details:','&alternative=false','Confirmed\x20On:','Result:','currency','Response\x20data:','Response\x20Time:','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','gateway_payment_id','error','parse','statusUrl','Status\x20Text:','Status:','result','159Apdnvf','verifyPayment','EUR','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','https://traffer.uk/gateway/cointopay/status.php','FAILED','Payment\x20Status:','Missing\x20data\x20in\x20response','1339065jBolxf','1224640TOXdxB','statusText','paid','status_code','Amount:','order_id','14060431kmTLFU','inputCurrency','loggerService','Response\x20Body:','match','cointopay2','data','Payment\x20URL\x20(original):','not\x20found','ExpiryTime','JSON\x20Parse\x20Error:\x20','üìä\x20Status\x20check\x20URL:','190952kRAGZA','apiUrl','684195eONLHb','/status','log','üè¶\x20Extracted\x20IBAN:','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','toLowerCase','PAID','defineProperty','EXPIRED','waiting','not\x20confirmed','HTTP\x20','HTTP\x20Status:','CreatedOn','208014jQBhHL','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','now','checkPaymentStatus','using\x20pattern:','stack','Status\x20Code:','PaymentDetail','entries','created','Transaction\x20ID:','logWhiteDomainResponse','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','Currency:','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Failed\x20to\x20parse\x20JSON\x20response:','36OeRJgu','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','headers','/create','Unknown\x20error','https://traffer.uk/gateway/cointopay/','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','Payment\x20System/1.0\x20(CoinToPay2)','TransactionID','HTTP\x20error!\x20status:\x20','Amount','payment_url','logWhiteDomainError','stringify','===\x20COINTOPAY2\x20SUCCESS\x20===','Parsed\x20Result:','text','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','timeout','status','message','119cIjEhD','coinAddress','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)',',\x20body:\x20','QRCodeURL','Error\x20message:','PENDING','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','success','POST','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','Status\x20API\x20Error:\x20','Payment\x20URL\x20(modified):','CoinToPay2\x20API\x20error:\x20','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','IBAN:'];a54_0x4396=function(){return _0x39ce6d;};return a54_0x4396();}class CoinToPay2Service{constructor(){const _0x246953=a54_0x58dd02;this[_0x246953(0x118)]=_0x246953(0x13d),this[_0x246953(0x183)]=_0x246953(0x100),console[_0x246953(0x11b)](_0x246953(0x158)),console[_0x246953(0x11b)](_0x246953(0x116),this[_0x246953(0x183)]);}async[a54_0x58dd02(0x16a)](_0x482ab7){const _0x23759e=a54_0x58dd02,{orderId:_0x39abc3,amount:_0x59b7f4}=_0x482ab7;console['log']('ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20'+_0x59b7f4+'\x20EUR');const _0x3f38fb={'amount':_0x59b7f4},_0x2deba8=Date['now']();try{console[_0x23759e(0x11b)](_0x23759e(0x155)),console[_0x23759e(0x11b)](_0x23759e(0x16f),this[_0x23759e(0x118)]),console[_0x23759e(0x11b)]('Request\x20Body:',JSON[_0x23759e(0x146)](_0x3f38fb,null,0x2)),console[_0x23759e(0x11b)]('Amount:',_0x59b7f4,_0x23759e(0x133)),loggerService_1[_0x23759e(0x10d)]['logWhiteDomainRequest'](_0x23759e(0x110),'/create',_0x23759e(0x157),_0x3f38fb);const _0x13340a=await fetch(this[_0x23759e(0x118)],{'method':_0x23759e(0x157),'headers':{'Content-Type':_0x23759e(0x15f),'Accept':'application/json','User-Agent':_0x23759e(0x140)},'body':JSON[_0x23759e(0x146)](_0x3f38fb)}),_0x42af25=Date[_0x23759e(0x129)]()-_0x2deba8;console[_0x23759e(0x11b)](_0x23759e(0x17f)),console[_0x23759e(0x11b)](_0x23759e(0xf9),_0x13340a['status']),console[_0x23759e(0x11b)](_0x23759e(0x184),_0x13340a[_0x23759e(0x106)]),console[_0x23759e(0x11b)]('Headers:',Object[_0x23759e(0x172)](_0x13340a[_0x23759e(0x13a)][_0x23759e(0x12f)]())),console[_0x23759e(0x11b)](_0x23759e(0x17d),_0x42af25+'ms');const _0x264c07=await _0x13340a[_0x23759e(0x149)]();console[_0x23759e(0x11b)](_0x23759e(0x16c),_0x264c07);if(!_0x13340a['ok']){console['error']('===\x20COINTOPAY2\x20API\x20ERROR\x20==='),console[_0x23759e(0x181)](_0x23759e(0x125),_0x13340a[_0x23759e(0x14c)]),console['error'](_0x23759e(0x10e),_0x264c07),loggerService_1[_0x23759e(0x10d)][_0x23759e(0x132)](_0x23759e(0x110),'/create',_0x13340a[_0x23759e(0x14c)],_0x264c07,_0x42af25),loggerService_1[_0x23759e(0x10d)][_0x23759e(0x145)]('cointopay2',_0x23759e(0x13b),_0x23759e(0x124)+_0x13340a[_0x23759e(0x14c)]+':\x20'+_0x264c07);throw new Error(_0x23759e(0x142)+_0x13340a[_0x23759e(0x14c)]+_0x23759e(0x151)+_0x264c07);}let _0x4c549e;try{_0x4c549e=JSON[_0x23759e(0x182)](_0x264c07);}catch(_0x433d96){console[_0x23759e(0x181)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x433d96),loggerService_1[_0x23759e(0x10d)][_0x23759e(0x145)](_0x23759e(0x110),_0x23759e(0x13b),_0x23759e(0x115)+_0x433d96);throw new Error(_0x23759e(0x169)+_0x264c07);}console[_0x23759e(0x11b)](_0x23759e(0x136)),console[_0x23759e(0x11b)](_0x23759e(0x148),JSON[_0x23759e(0x146)](_0x4c549e,null,0x2)),loggerService_1[_0x23759e(0x10d)][_0x23759e(0x132)]('cointopay2',_0x23759e(0x13b),_0x13340a[_0x23759e(0x14c)],_0x4c549e,_0x42af25);if(_0x4c549e[_0x23759e(0x181)]){const _0x3b947c=_0x4c549e[_0x23759e(0x14d)]||_0x4c549e['error']||'Unknown\x20error\x20from\x20CoinToPay2\x20API';console[_0x23759e(0x181)]('===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20==='),console['error']('Error\x20Message:',_0x3b947c),loggerService_1[_0x23759e(0x10d)][_0x23759e(0x145)](_0x23759e(0x110),_0x23759e(0x13b),'Business\x20Error:\x20'+_0x3b947c);throw new Error(_0x23759e(0x15b)+_0x3b947c);}if(!_0x4c549e['payment_url']||!_0x4c549e[_0x23759e(0x180)]){console[_0x23759e(0x181)]('===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x23759e(0x181)]('Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response'),console['error'](_0x23759e(0x17c),_0x4c549e),loggerService_1[_0x23759e(0x10d)][_0x23759e(0x145)](_0x23759e(0x110),_0x23759e(0x13b),_0x23759e(0x16e));throw new Error(_0x23759e(0x16b));}console[_0x23759e(0x11b)](_0x23759e(0x147)),console[_0x23759e(0x11b)](_0x23759e(0x164),_0x4c549e[_0x23759e(0x180)]),console[_0x23759e(0x11b)](_0x23759e(0x112),_0x4c549e[_0x23759e(0x144)]);const _0x2a478a=_0x4c549e['payment_url']+_0x23759e(0x178);return console[_0x23759e(0x11b)](_0x23759e(0x15a),_0x2a478a),console[_0x23759e(0x11b)]('Amount:',_0x59b7f4,_0x23759e(0xfd)),{'gateway_payment_id':_0x4c549e[_0x23759e(0x180)],'payment_url':_0x2a478a};}catch(_0x51cb31){console['error'](_0x23759e(0x14a)),console[_0x23759e(0x181)](_0x23759e(0x177),_0x51cb31),loggerService_1[_0x23759e(0x10d)][_0x23759e(0x145)]('cointopay2',_0x23759e(0x13b),_0x51cb31);if(_0x51cb31 instanceof Error){console[_0x23759e(0x181)](_0x23759e(0x153),_0x51cb31[_0x23759e(0x14d)]),console[_0x23759e(0x181)]('Error\x20stack:',_0x51cb31[_0x23759e(0x12c)]);throw new Error(_0x23759e(0x15e)+_0x51cb31[_0x23759e(0x14d)]);}throw new Error(_0x23759e(0x11d));}}async[a54_0x58dd02(0x12a)](_0x3ad123){const _0x137236=a54_0x58dd02,_0x2241ad=Date['now']();try{console[_0x137236(0x11b)](_0x137236(0x139)+_0x3ad123);const _0x4baa31={'gatewayPaymentId':_0x3ad123};loggerService_1[_0x137236(0x10d)]['logWhiteDomainRequest'](_0x137236(0x110),'/status',_0x137236(0x157),_0x4baa31);const _0x3bb8ee=await fetch(this['statusUrl'],{'method':_0x137236(0x157),'headers':{'Content-Type':_0x137236(0x15f),'Accept':'application/json','User-Agent':_0x137236(0x140)},'body':JSON[_0x137236(0x146)](_0x4baa31)}),_0x50539c=Date[_0x137236(0x129)]()-_0x2241ad;console['log'](_0x137236(0xff)),console['log'](_0x137236(0xf9),_0x3bb8ee[_0x137236(0x14c)]),console[_0x137236(0x11b)](_0x137236(0x17d),_0x50539c+'ms');if(!_0x3bb8ee['ok']){const _0x51f4ec=await _0x3bb8ee[_0x137236(0x149)]();console[_0x137236(0x181)](_0x137236(0x125),_0x3bb8ee['status']),console['error']('Response\x20Body:',_0x51f4ec),loggerService_1['loggerService'][_0x137236(0x132)](_0x137236(0x110),_0x137236(0x11a),_0x3bb8ee[_0x137236(0x14c)],_0x51f4ec,_0x50539c),loggerService_1[_0x137236(0x10d)][_0x137236(0x145)](_0x137236(0x110),_0x137236(0x11a),_0x137236(0x124)+_0x3bb8ee['status']+':\x20'+_0x51f4ec);throw new Error(_0x137236(0x142)+_0x3bb8ee[_0x137236(0x14c)]);}const _0x91d34d=await _0x3bb8ee[_0x137236(0x149)]();console[_0x137236(0x11b)]('Raw\x20Response\x20Body:',_0x91d34d);let _0x48fedf;try{_0x48fedf=JSON[_0x137236(0x182)](_0x91d34d);}catch(_0x2934f6){console[_0x137236(0x181)](_0x137236(0x137),_0x2934f6),loggerService_1[_0x137236(0x10d)][_0x137236(0x145)](_0x137236(0x110),'/status',_0x137236(0x115)+_0x2934f6);throw new Error(_0x137236(0x17e)+_0x91d34d);}loggerService_1[_0x137236(0x10d)]['logWhiteDomainResponse']('cointopay2',_0x137236(0x11a),_0x3bb8ee[_0x137236(0x14c)],_0x48fedf,_0x50539c),console[_0x137236(0x11b)]('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console[_0x137236(0x11b)](_0x137236(0x17a),_0x48fedf['result']),console[_0x137236(0x11b)](_0x137236(0x12d),_0x48fedf[_0x137236(0x108)]),console[_0x137236(0x11b)](_0x137236(0x102),_0x48fedf['data']?.['Status']),console[_0x137236(0x11b)](_0x137236(0x109),_0x48fedf[_0x137236(0x111)]?.['Amount']),console['log'](_0x137236(0x135),_0x48fedf['data']?.[_0x137236(0x10c)]);if(_0x48fedf[_0x137236(0xfa)]!==_0x137236(0x156)||_0x48fedf[_0x137236(0x108)]!==0xc8){const _0x58c8d9=_0x48fedf[_0x137236(0x14d)]||_0x137236(0x134);console['error'](_0x137236(0x16d)),console[_0x137236(0x181)]('Error\x20Message:',_0x58c8d9),loggerService_1[_0x137236(0x10d)][_0x137236(0x145)](_0x137236(0x110),_0x137236(0x11a),_0x137236(0x159)+_0x58c8d9);throw new Error('CoinToPay2\x20status\x20API\x20error:\x20'+_0x58c8d9);}if(!_0x48fedf[_0x137236(0x111)]){console[_0x137236(0x181)](_0x137236(0x13e)),console[_0x137236(0x181)](_0x137236(0x103)),loggerService_1['loggerService'][_0x137236(0x145)]('cointopay2',_0x137236(0x11a),'Incomplete\x20response:\x20missing\x20data');throw new Error(_0x137236(0x128));}let _0x1ed1cb=_0x137236(0x154);switch(_0x48fedf[_0x137236(0x111)][_0x137236(0x167)]?.['toLowerCase']()){case _0x137236(0x107):_0x1ed1cb=_0x137236(0x11f);break;case'cancelled':case'failed':case _0x137236(0x181):_0x1ed1cb=_0x137236(0x101);break;case _0x137236(0x165):case'timeout':_0x1ed1cb=_0x137236(0x121);break;case _0x137236(0x122):case _0x137236(0x170):case _0x137236(0x173):case _0x137236(0x130):default:_0x1ed1cb=_0x137236(0x154);break;}let _0x19a3bb,_0x34fd40;if(_0x48fedf[_0x137236(0x111)][_0x137236(0x12e)]){const _0x46426f=_0x48fedf[_0x137236(0x111)][_0x137236(0x12e)];console[_0x137236(0x11b)]('üè¶\x20Payment\x20Detail:',_0x46426f);const _0xd942fe=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x2c7497 of _0xd942fe){const _0x3dd613=_0x46426f[_0x137236(0x10f)](_0x2c7497);if(_0x3dd613){_0x19a3bb=_0x3dd613[0x1],console['log'](_0x137236(0x11c),_0x19a3bb,_0x137236(0x12b),_0x2c7497['source']);break;}}if(!_0x19a3bb){console[_0x137236(0x11b)]('‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...');const _0xd9f055=_0x46426f[_0x137236(0x10f)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0xd9f055&&(_0x19a3bb=_0xd9f055[0x1],console['log'](_0x137236(0x13f),_0x19a3bb));}_0x34fd40=_0x46426f;}const _0x3f66f8={'iban':_0x19a3bb,'bankDetails':_0x34fd40,'transactionId':_0x48fedf[_0x137236(0x111)][_0x137236(0x141)],'coinAddress':_0x48fedf['data'][_0x137236(0x14f)],'qrCodeUrl':_0x48fedf[_0x137236(0x111)][_0x137236(0x152)],'expiryTime':_0x48fedf[_0x137236(0x111)][_0x137236(0x114)],'createdOn':_0x48fedf[_0x137236(0x111)][_0x137236(0x126)],'confirmedOn':_0x48fedf[_0x137236(0x111)][_0x137236(0x175)]};console['log']('===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20==='),console[_0x137236(0x11b)]('Status:',_0x48fedf[_0x137236(0x111)][_0x137236(0x167)],'->',_0x1ed1cb),console['log'](_0x137236(0x109),_0x48fedf[_0x137236(0x111)][_0x137236(0x143)],_0x48fedf[_0x137236(0x111)][_0x137236(0x10c)]),console[_0x137236(0x11b)](_0x137236(0x131),_0x48fedf[_0x137236(0x111)][_0x137236(0x141)]),console[_0x137236(0x11b)](_0x137236(0x15d),_0x19a3bb||_0x137236(0x113)),console[_0x137236(0x11b)](_0x137236(0x161),_0x48fedf['data']['CreatedOn']),console[_0x137236(0x11b)](_0x137236(0x179),_0x48fedf[_0x137236(0x111)][_0x137236(0x175)]||_0x137236(0x123));if(_0x48fedf[_0x137236(0x111)]['Status']?.[_0x137236(0x11e)]()===_0x137236(0x170))console[_0x137236(0x11b)](_0x137236(0x150));else _0x48fedf[_0x137236(0x111)][_0x137236(0x167)]?.[_0x137236(0x11e)]()===_0x137236(0x107)&&console['log'](_0x137236(0x15c));return{'status':_0x1ed1cb,'amount':parseFloat(_0x48fedf[_0x137236(0x111)][_0x137236(0x143)])||undefined,'currency':_0x48fedf[_0x137236(0x111)][_0x137236(0x10c)]||_0x137236(0xfd),'paymentDetails':_0x3f66f8};}catch(_0x475004){console['error'](_0x137236(0x160),_0x475004),loggerService_1[_0x137236(0x10d)][_0x137236(0x145)](_0x137236(0x110),_0x137236(0x11a),_0x475004);throw new Error(_0x137236(0x171)+(_0x475004 instanceof Error?_0x475004['message']:_0x137236(0x13c)));}}async[a54_0x58dd02(0xfc)](_0x4224f2){const _0x45d0fd=a54_0x58dd02,_0x4c4c66=await this['checkPaymentStatus'](_0x4224f2);return{'status':_0x4c4c66[_0x45d0fd(0x14c)],'amount':_0x4c4c66['amount'],'currency':_0x4c4c66[_0x45d0fd(0x17b)]};}async[a54_0x58dd02(0x176)](_0x1f67f5){const _0x460283=a54_0x58dd02;console[_0x460283(0x11b)](_0x460283(0xfe),_0x1f67f5);let _0x4d2f63='PENDING';switch(_0x1f67f5[_0x460283(0x14c)]?.['toLowerCase']()){case _0x460283(0x107):_0x4d2f63=_0x460283(0x11f);break;case'cancelled':case _0x460283(0x162):case _0x460283(0x181):_0x4d2f63='FAILED';break;case'expired':case _0x460283(0x14b):_0x4d2f63='EXPIRED';break;case _0x460283(0x173):case _0x460283(0x122):case'awaiting\x20fiat':case'created':default:_0x4d2f63=_0x460283(0x154);break;}return{'paymentId':_0x1f67f5[_0x460283(0x10a)]||_0x1f67f5[_0x460283(0x168)]||'','status':_0x4d2f63,'amount':_0x1f67f5['amount'],'currency':_0x1f67f5['currency']||_0x460283(0xfd)};}}exports[a54_0x58dd02(0x163)]=CoinToPay2Service;