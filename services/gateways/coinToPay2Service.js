'use strict';const a40_0x159ad9=a40_0x350f;function a40_0x350f(_0x126a31,_0x32cb46){const _0x419da5=a40_0x419d();return a40_0x350f=function(_0x350fbf,_0x24c584){_0x350fbf=_0x350fbf-0xd6;let _0x23e20c=_0x419da5[_0x350fbf];return _0x23e20c;},a40_0x350f(_0x126a31,_0x32cb46);}(function(_0x47db1f,_0x3797f2){const _0x4cd7aa=a40_0x350f,_0x99bf9c=_0x47db1f();while(!![]){try{const _0x31c94b=parseInt(_0x4cd7aa(0x154))/0x1+parseInt(_0x4cd7aa(0x117))/0x2+-parseInt(_0x4cd7aa(0x109))/0x3+parseInt(_0x4cd7aa(0x133))/0x4+parseInt(_0x4cd7aa(0x132))/0x5*(-parseInt(_0x4cd7aa(0xde))/0x6)+parseInt(_0x4cd7aa(0xec))/0x7*(-parseInt(_0x4cd7aa(0x13a))/0x8)+parseInt(_0x4cd7aa(0x153))/0x9*(parseInt(_0x4cd7aa(0xfc))/0xa);if(_0x31c94b===_0x3797f2)break;else _0x99bf9c['push'](_0x99bf9c['shift']());}catch(_0x4e784f){_0x99bf9c['push'](_0x99bf9c['shift']());}}}(a40_0x419d,0x59621));function a40_0x419d(){const _0x1c059a=['apiUrl','QRCodeURL','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','paid','logWhiteDomainError','defineProperty','message','CoinToPay2\x20payment\x20status\x20check\x20error:','logWhiteDomainResponse','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','Parsed\x20Result:','PaymentDetail','created','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','228qjPFZH','cointopay2','Raw\x20Response\x20Body:','expired','/status','data','success','CoinToPay2\x20API\x20error:\x20','application/json','Response\x20Body:','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','===\x20COINTOPAY2\x20SUCCESS\x20===','546XWDaKr','Confirmed\x20On:','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','Transaction\x20ID:','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','Status','URL:','pending','Request\x20Body:','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','Amount','result','https://traffer.uk/gateway/cointopay/','payment_url','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','40OYvxDE','TransactionID','../loggerService','Error\x20details:','waiting','not\x20found','error','Status\x20Text:','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','gateway_payment_id','/create','PAID','Result:','1223895sZfzJg','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','Error\x20stack:','Status\x20Code:','Error\x20message:','log','Status\x20API\x20Error:\x20','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','checkPaymentStatus','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','coinAddress','Response\x20Time:','toLowerCase','match','1329848JVkTOo','createPaymentLink','Created\x20On:','CreatedOn','\x20EUR','IBAN:','https://traffer.uk/gateway/cointopay/status.php','merchant_reference_id','üìä\x20Status\x20check\x20URL:','Incomplete\x20response:\x20missing\x20data','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','verifyPayment','Headers:','parse','Failed\x20to\x20parse\x20JSON\x20response:','failed','Amount:','stringify','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','Status:','EXPIRED','HTTP\x20Status:','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','statusText','üè¶\x20Payment\x20Detail:','loggerService','HTTP\x20error!\x20status:\x20','52315XWxEiF','2138148sIwJiQ','Error\x20Message:','timeout','Missing\x20data\x20in\x20response','inputCurrency','POST','status','46216USsUlp','Response\x20data:','HTTP\x20','FAILED','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','logWhiteDomainRequest','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','JSON\x20Parse\x20Error:\x20','cancelled','Payment\x20Status:','Unknown\x20error','EUR','Payment\x20URL:','amount','ExpiryTime','now','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','TransactionConfirmedOn','awaiting\x20fiat','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','statusUrl','CoinToPay2Service','stack','PENDING','text','362277CYmHLo','261805lZjozU','fromEntries','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','Currency:'];a40_0x419d=function(){return _0x1c059a;};return a40_0x419d();}Object[a40_0x159ad9(0x15d)](exports,'__esModule',{'value':!![]}),exports[a40_0x159ad9(0x14f)]=void 0x0;const loggerService_1=require(a40_0x159ad9(0xfe));class CoinToPay2Service{constructor(){const _0x3f0492=a40_0x159ad9;this['apiUrl']=_0x3f0492(0xf9),this[_0x3f0492(0x14e)]=_0x3f0492(0x11d),console['log'](_0x3f0492(0x140)),console['log'](_0x3f0492(0x11f),this[_0x3f0492(0x14e)]);}async[a40_0x159ad9(0x118)](_0x7ee6b4){const _0x46d2b4=a40_0x159ad9,{orderId:_0x55f41a,amount:_0x14e89c}=_0x7ee6b4;console['log'](_0x46d2b4(0xea)+_0x14e89c+_0x46d2b4(0x11b));const _0x517c84={'amount':_0x14e89c},_0x102413=Date[_0x46d2b4(0x149)]();try{console[_0x46d2b4(0x10e)](_0x46d2b4(0x14a)),console[_0x46d2b4(0x10e)](_0x46d2b4(0xf3),this['apiUrl']),console[_0x46d2b4(0x10e)](_0x46d2b4(0xf5),JSON[_0x46d2b4(0x128)](_0x517c84,null,0x2)),console[_0x46d2b4(0x10e)]('Amount:',_0x14e89c,'EUR\x20(always\x20EUR\x20for\x20CoinToPay2)'),loggerService_1[_0x46d2b4(0x130)][_0x46d2b4(0x13f)]('cointopay2',_0x46d2b4(0x106),_0x46d2b4(0x138),_0x517c84);const _0x43e48c=await fetch(this[_0x46d2b4(0x158)],{'method':_0x46d2b4(0x138),'headers':{'Content-Type':_0x46d2b4(0xe6),'Accept':_0x46d2b4(0xe6),'User-Agent':_0x46d2b4(0x15a)},'body':JSON[_0x46d2b4(0x128)](_0x517c84)}),_0x1ec3e6=Date[_0x46d2b4(0x149)]()-_0x102413;console['log'](_0x46d2b4(0x10a)),console[_0x46d2b4(0x10e)]('Status:',_0x43e48c[_0x46d2b4(0x139)]),console['log'](_0x46d2b4(0x103),_0x43e48c[_0x46d2b4(0x12e)]),console[_0x46d2b4(0x10e)](_0x46d2b4(0x123),Object[_0x46d2b4(0x155)](_0x43e48c['headers']['entries']())),console[_0x46d2b4(0x10e)](_0x46d2b4(0x114),_0x1ec3e6+'ms');const _0x321b16=await _0x43e48c['text']();console[_0x46d2b4(0x10e)](_0x46d2b4(0xe0),_0x321b16);if(!_0x43e48c['ok']){console[_0x46d2b4(0x102)]('===\x20COINTOPAY2\x20API\x20ERROR\x20==='),console['error'](_0x46d2b4(0x12c),_0x43e48c['status']),console['error'](_0x46d2b4(0xe7),_0x321b16),loggerService_1[_0x46d2b4(0x130)][_0x46d2b4(0xd8)](_0x46d2b4(0xdf),_0x46d2b4(0x106),_0x43e48c['status'],_0x321b16,_0x1ec3e6),loggerService_1['loggerService'][_0x46d2b4(0x15c)](_0x46d2b4(0xdf),_0x46d2b4(0x106),_0x46d2b4(0x13c)+_0x43e48c['status']+':\x20'+_0x321b16);throw new Error('HTTP\x20error!\x20status:\x20'+_0x43e48c[_0x46d2b4(0x139)]+',\x20body:\x20'+_0x321b16);}let _0x2a2f46;try{_0x2a2f46=JSON['parse'](_0x321b16);}catch(_0x290377){console[_0x46d2b4(0x102)](_0x46d2b4(0x125),_0x290377),loggerService_1[_0x46d2b4(0x130)][_0x46d2b4(0x15c)]('cointopay2',_0x46d2b4(0x106),_0x46d2b4(0x141)+_0x290377);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20'+_0x321b16);}console['log'](_0x46d2b4(0x12d)),console[_0x46d2b4(0x10e)](_0x46d2b4(0xda),JSON[_0x46d2b4(0x128)](_0x2a2f46,null,0x2)),loggerService_1[_0x46d2b4(0x130)]['logWhiteDomainResponse']('cointopay2',_0x46d2b4(0x106),_0x43e48c[_0x46d2b4(0x139)],_0x2a2f46,_0x1ec3e6);if(_0x2a2f46[_0x46d2b4(0x102)]){const _0x2b50ff=_0x2a2f46[_0x46d2b4(0xd6)]||_0x2a2f46[_0x46d2b4(0x102)]||'Unknown\x20error\x20from\x20CoinToPay2\x20API';console[_0x46d2b4(0x102)]('===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x46d2b4(0x102)](_0x46d2b4(0x134),_0x2b50ff),loggerService_1[_0x46d2b4(0x130)][_0x46d2b4(0x15c)](_0x46d2b4(0xdf),'/create','Business\x20Error:\x20'+_0x2b50ff);throw new Error(_0x46d2b4(0xe5)+_0x2b50ff);}if(!_0x2a2f46[_0x46d2b4(0xfa)]||!_0x2a2f46[_0x46d2b4(0x105)]){console[_0x46d2b4(0x102)](_0x46d2b4(0x121)),console[_0x46d2b4(0x102)]('Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response'),console[_0x46d2b4(0x102)](_0x46d2b4(0x13b),_0x2a2f46),loggerService_1[_0x46d2b4(0x130)]['logWhiteDomainError'](_0x46d2b4(0xdf),_0x46d2b4(0x106),_0x46d2b4(0xee));throw new Error(_0x46d2b4(0x110));}return console[_0x46d2b4(0x10e)](_0x46d2b4(0xeb)),console[_0x46d2b4(0x10e)]('Gateway\x20Payment\x20ID:',_0x2a2f46[_0x46d2b4(0x105)]),console[_0x46d2b4(0x10e)](_0x46d2b4(0x146),_0x2a2f46[_0x46d2b4(0xfa)]),console[_0x46d2b4(0x10e)]('Amount:',_0x14e89c,'EUR'),{'gateway_payment_id':_0x2a2f46[_0x46d2b4(0x105)],'payment_url':_0x2a2f46[_0x46d2b4(0xfa)]};}catch(_0xd2fe1b){console[_0x46d2b4(0x102)](_0x46d2b4(0x129)),console[_0x46d2b4(0x102)](_0x46d2b4(0xff),_0xd2fe1b),loggerService_1[_0x46d2b4(0x130)]['logWhiteDomainError'](_0x46d2b4(0xdf),_0x46d2b4(0x106),_0xd2fe1b);if(_0xd2fe1b instanceof Error){console[_0x46d2b4(0x102)](_0x46d2b4(0x10d),_0xd2fe1b['message']),console[_0x46d2b4(0x102)](_0x46d2b4(0x10b),_0xd2fe1b[_0x46d2b4(0x150)]);throw new Error(_0x46d2b4(0xfb)+_0xd2fe1b[_0x46d2b4(0xd6)]);}throw new Error(_0x46d2b4(0xef));}}async[a40_0x159ad9(0x111)](_0x5ea129){const _0xc2acc5=a40_0x159ad9,_0x327189=Date[_0xc2acc5(0x149)]();try{console[_0xc2acc5(0x10e)]('üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20'+_0x5ea129);const _0x2bae51={'gatewayPaymentId':_0x5ea129};loggerService_1[_0xc2acc5(0x130)][_0xc2acc5(0x13f)](_0xc2acc5(0xdf),'/status','POST',_0x2bae51);const _0xb7dfec=await fetch(this[_0xc2acc5(0x14e)],{'method':_0xc2acc5(0x138),'headers':{'Content-Type':_0xc2acc5(0xe6),'Accept':_0xc2acc5(0xe6),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON[_0xc2acc5(0x128)](_0x2bae51)}),_0x44fea9=Date[_0xc2acc5(0x149)]()-_0x327189;console[_0xc2acc5(0x10e)](_0xc2acc5(0xd9)),console[_0xc2acc5(0x10e)](_0xc2acc5(0x12a),_0xb7dfec[_0xc2acc5(0x139)]),console[_0xc2acc5(0x10e)](_0xc2acc5(0x114),_0x44fea9+'ms');if(!_0xb7dfec['ok']){const _0x1c5057=await _0xb7dfec[_0xc2acc5(0x152)]();console[_0xc2acc5(0x102)]('HTTP\x20Status:',_0xb7dfec['status']),console[_0xc2acc5(0x102)](_0xc2acc5(0xe7),_0x1c5057),loggerService_1[_0xc2acc5(0x130)]['logWhiteDomainResponse']('cointopay2',_0xc2acc5(0xe2),_0xb7dfec['status'],_0x1c5057,_0x44fea9),loggerService_1[_0xc2acc5(0x130)][_0xc2acc5(0x15c)](_0xc2acc5(0xdf),_0xc2acc5(0xe2),_0xc2acc5(0x13c)+_0xb7dfec[_0xc2acc5(0x139)]+':\x20'+_0x1c5057);throw new Error(_0xc2acc5(0x131)+_0xb7dfec[_0xc2acc5(0x139)]);}const _0xd26a07=await _0xb7dfec['text']();console[_0xc2acc5(0x10e)](_0xc2acc5(0xe0),_0xd26a07);let _0x32512b;try{_0x32512b=JSON[_0xc2acc5(0x124)](_0xd26a07);}catch(_0x4108e0){console['error'](_0xc2acc5(0x125),_0x4108e0),loggerService_1['loggerService'][_0xc2acc5(0x15c)](_0xc2acc5(0xdf),_0xc2acc5(0xe2),_0xc2acc5(0x141)+_0x4108e0);throw new Error(_0xc2acc5(0xf1)+_0xd26a07);}loggerService_1[_0xc2acc5(0x130)][_0xc2acc5(0xd8)](_0xc2acc5(0xdf),_0xc2acc5(0xe2),_0xb7dfec['status'],_0x32512b,_0x44fea9),console[_0xc2acc5(0x10e)](_0xc2acc5(0xdd)),console[_0xc2acc5(0x10e)](_0xc2acc5(0x108),_0x32512b[_0xc2acc5(0xf8)]),console['log'](_0xc2acc5(0x10c),_0x32512b['status_code']),console[_0xc2acc5(0x10e)](_0xc2acc5(0x143),_0x32512b['data']?.['Status']),console[_0xc2acc5(0x10e)](_0xc2acc5(0x127),_0x32512b['data']?.[_0xc2acc5(0xf7)]),console[_0xc2acc5(0x10e)](_0xc2acc5(0x157),_0x32512b[_0xc2acc5(0xe3)]?.[_0xc2acc5(0x137)]);if(_0x32512b['result']!==_0xc2acc5(0xe4)||_0x32512b['status_code']!==0xc8){const _0x26781e=_0x32512b[_0xc2acc5(0xd6)]||_0xc2acc5(0x13e);console[_0xc2acc5(0x102)]('===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20==='),console['error'](_0xc2acc5(0x134),_0x26781e),loggerService_1[_0xc2acc5(0x130)]['logWhiteDomainError']('cointopay2',_0xc2acc5(0xe2),_0xc2acc5(0x10f)+_0x26781e);throw new Error('CoinToPay2\x20status\x20API\x20error:\x20'+_0x26781e);}if(!_0x32512b[_0xc2acc5(0xe3)]){console[_0xc2acc5(0x102)](_0xc2acc5(0xe9)),console['error'](_0xc2acc5(0x136)),loggerService_1[_0xc2acc5(0x130)]['logWhiteDomainError'](_0xc2acc5(0xdf),_0xc2acc5(0xe2),_0xc2acc5(0x120));throw new Error(_0xc2acc5(0x156));}let _0x341ded=_0xc2acc5(0x151);switch(_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0xf2)]?.[_0xc2acc5(0x115)]()){case _0xc2acc5(0x15b):_0x341ded=_0xc2acc5(0x107);break;case _0xc2acc5(0x142):case _0xc2acc5(0x126):case _0xc2acc5(0x102):_0x341ded=_0xc2acc5(0x13d);break;case _0xc2acc5(0xe1):case'timeout':_0x341ded=_0xc2acc5(0x12b);break;case _0xc2acc5(0x100):case'awaiting\x20fiat':case _0xc2acc5(0xf4):case _0xc2acc5(0xdc):default:_0x341ded=_0xc2acc5(0x151);break;}let _0x3941fa,_0x55bcf8;if(_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0xdb)]){const _0x1c9751=_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0xdb)];console[_0xc2acc5(0x10e)](_0xc2acc5(0x12f),_0x1c9751);const _0x4becbc=_0x1c9751[_0xc2acc5(0x116)](/IBAN\s+([A-Z0-9]+)/i);_0x4becbc&&(_0x3941fa=_0x4becbc[0x1],console[_0xc2acc5(0x10e)]('üè¶\x20Extracted\x20IBAN:',_0x3941fa)),_0x55bcf8=_0x1c9751;}const _0x1a86c7={'iban':_0x3941fa,'bankDetails':_0x55bcf8,'transactionId':_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0xfd)],'coinAddress':_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0x113)],'qrCodeUrl':_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0x159)],'expiryTime':_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0x148)],'createdOn':_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0x11a)],'confirmedOn':_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0x14b)]};console[_0xc2acc5(0x10e)](_0xc2acc5(0x104)),console[_0xc2acc5(0x10e)](_0xc2acc5(0x12a),_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0xf2)],'->',_0x341ded),console[_0xc2acc5(0x10e)](_0xc2acc5(0x127),_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0xf7)],_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0x137)]),console['log'](_0xc2acc5(0xf0),_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0xfd)]),console[_0xc2acc5(0x10e)](_0xc2acc5(0x11c),_0x3941fa||_0xc2acc5(0x101)),console[_0xc2acc5(0x10e)](_0xc2acc5(0x119),_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0x11a)]),console['log'](_0xc2acc5(0xed),_0x32512b['data'][_0xc2acc5(0x14b)]||'not\x20confirmed');if(_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0xf2)]?.[_0xc2acc5(0x115)]()===_0xc2acc5(0x14c))console[_0xc2acc5(0x10e)](_0xc2acc5(0x112));else _0x32512b['data'][_0xc2acc5(0xf2)]?.[_0xc2acc5(0x115)]()===_0xc2acc5(0x15b)&&console['log'](_0xc2acc5(0xf6));return{'status':_0x341ded,'amount':parseFloat(_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0xf7)])||undefined,'currency':_0x32512b[_0xc2acc5(0xe3)][_0xc2acc5(0x137)]||_0xc2acc5(0x145),'paymentDetails':_0x1a86c7};}catch(_0x504a99){console['error'](_0xc2acc5(0xd7),_0x504a99),loggerService_1['loggerService'][_0xc2acc5(0x15c)](_0xc2acc5(0xdf),_0xc2acc5(0xe2),_0x504a99);throw new Error(_0xc2acc5(0x14d)+(_0x504a99 instanceof Error?_0x504a99[_0xc2acc5(0xd6)]:_0xc2acc5(0x144)));}}async[a40_0x159ad9(0x122)](_0x37f53c){const _0x7e4895=a40_0x159ad9,_0x12c5b1=await this['checkPaymentStatus'](_0x37f53c);return{'status':_0x12c5b1[_0x7e4895(0x139)],'amount':_0x12c5b1[_0x7e4895(0x147)],'currency':_0x12c5b1['currency']};}async['processWebhook'](_0x2c6eaa){const _0x49a2ca=a40_0x159ad9;console[_0x49a2ca(0x10e)](_0x49a2ca(0xe8),_0x2c6eaa);let _0x12421f=_0x49a2ca(0x151);switch(_0x2c6eaa[_0x49a2ca(0x139)]?.[_0x49a2ca(0x115)]()){case _0x49a2ca(0x15b):_0x12421f='PAID';break;case _0x49a2ca(0x142):case _0x49a2ca(0x126):case _0x49a2ca(0x102):_0x12421f=_0x49a2ca(0x13d);break;case _0x49a2ca(0xe1):case _0x49a2ca(0x135):_0x12421f=_0x49a2ca(0x12b);break;case'pending':case _0x49a2ca(0x100):case _0x49a2ca(0x14c):case _0x49a2ca(0xdc):default:_0x12421f=_0x49a2ca(0x151);break;}return{'paymentId':_0x2c6eaa['order_id']||_0x2c6eaa[_0x49a2ca(0x11e)]||'','status':_0x12421f,'amount':_0x2c6eaa[_0x49a2ca(0x147)],'currency':_0x2c6eaa['currency']||_0x49a2ca(0x145)};}}exports[a40_0x159ad9(0x14f)]=CoinToPay2Service;