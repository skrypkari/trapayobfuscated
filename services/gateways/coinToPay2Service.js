'use strict';const a42_0x556a49=a42_0x1157;(function(_0x2564fe,_0x500919){const _0x406d4e=a42_0x1157,_0x2d43fe=_0x2564fe();while(!![]){try{const _0x47c10b=-parseInt(_0x406d4e(0x153))/0x1+-parseInt(_0x406d4e(0x193))/0x2+-parseInt(_0x406d4e(0x19a))/0x3+-parseInt(_0x406d4e(0x16d))/0x4*(-parseInt(_0x406d4e(0x14c))/0x5)+-parseInt(_0x406d4e(0x1a0))/0x6+parseInt(_0x406d4e(0x1b4))/0x7+parseInt(_0x406d4e(0x1ae))/0x8;if(_0x47c10b===_0x500919)break;else _0x2d43fe['push'](_0x2d43fe['shift']());}catch(_0x3ab7c1){_0x2d43fe['push'](_0x2d43fe['shift']());}}}(a42_0x4446,0x3ce0b));Object['defineProperty'](exports,a42_0x556a49(0x171),{'value':!![]}),exports[a42_0x556a49(0x18f)]=void 0x0;const loggerService_1=require(a42_0x556a49(0x136));function a42_0x4446(){const _0x2e9e4e=['toLowerCase','Amount:','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','log','/status','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','entries','processWebhook','https://traffer.uk/gateway/cointopay/','PAID','Failed\x20to\x20parse\x20JSON\x20response:','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','stack','üè¶\x20Extracted\x20IBAN:','Parsed\x20Result:','failed','Incomplete\x20response:\x20missing\x20data','awaiting\x20fiat','TransactionID','Unknown\x20error\x20from\x20CoinToPay2\x20API','CoinToPay2Service','Error\x20stack:','HTTP\x20','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','318054qxQXAg','message','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','EXPIRED','HTTP\x20error!\x20status:\x20','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','application/json','107502yfWlkK','headers','data','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','POST','Result:','1005948ErfGZS','checkPaymentStatus','TransactionConfirmedOn','stringify','paid','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','Response\x20Time:','merchant_reference_id','error','parse','Currency:','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Gateway\x20Payment\x20ID:','FAILED','2111472juxqkj','inputCurrency','status','Payment\x20Status:','gateway_payment_id','CreatedOn','2495227BuKYMM','CoinToPay2\x20payment\x20status\x20check\x20error:','CoinToPay2\x20API\x20error:\x20','apiUrl','text','using\x20pattern:','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','cancelled','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Confirmed\x20On:','status_code','Error\x20Message:','timeout','../loggerService','loggerService','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','fromEntries','Status\x20Text:','JSON\x20Parse\x20Error:\x20','Status\x20Code:','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','CoinToPay2\x20status\x20API\x20error:\x20','Request\x20Body:','waiting','expired','Status\x20API\x20Error:\x20','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','currency','logWhiteDomainResponse','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','pending','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','now','result','340QUDKWS','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','match','===\x20COINTOPAY2\x20SUCCESS\x20===','logWhiteDomainError','Status','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','353961kYncxe','ExpiryTime','Response\x20Body:','QRCodeURL','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','order_id','EUR','source','payment_url','Amount','HTTP\x20Status:','PENDING','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','PaymentDetail','üè¶\x20Payment\x20Detail:','created','statusUrl','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','cointopay2','amount','===\x20COINTOPAY2\x20API\x20ERROR\x20===','Error\x20details:','Missing\x20data\x20in\x20response','\x20EUR','Raw\x20Response\x20Body:','/create','20320nCwbTE','Headers:','Payment\x20URL:','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','__esModule','createPaymentLink','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','Status:','Transaction\x20ID:','logWhiteDomainRequest','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','not\x20found','coinAddress',',\x20body:\x20'];a42_0x4446=function(){return _0x2e9e4e;};return a42_0x4446();}function a42_0x1157(_0x38cd2d,_0x241e82){const _0x444694=a42_0x4446();return a42_0x1157=function(_0x115762,_0xa2a295){_0x115762=_0x115762-0x12f;let _0x5a7a73=_0x444694[_0x115762];return _0x5a7a73;},a42_0x1157(_0x38cd2d,_0x241e82);}class CoinToPay2Service{constructor(){const _0x161a23=a42_0x556a49;this[_0x161a23(0x1b7)]=_0x161a23(0x183),this[_0x161a23(0x163)]='https://traffer.uk/gateway/cointopay/status.php',console[_0x161a23(0x17e)](_0x161a23(0x15f)),console['log']('üìä\x20Status\x20check\x20URL:',this['statusUrl']);}async[a42_0x556a49(0x172)](_0x2a3dfb){const _0x5d9939=a42_0x556a49,{orderId:_0x4b9c1a,amount:_0x33a193}=_0x2a3dfb;console[_0x5d9939(0x17e)]('ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20'+_0x33a193+_0x5d9939(0x16a));const _0x876fb1={'amount':_0x33a193},_0x2e79ef=Date[_0x5d9939(0x14a)]();try{console[_0x5d9939(0x17e)](_0x5d9939(0x17d)),console[_0x5d9939(0x17e)]('URL:',this['apiUrl']),console[_0x5d9939(0x17e)](_0x5d9939(0x13f),JSON[_0x5d9939(0x1a3)](_0x876fb1,null,0x2)),console['log'](_0x5d9939(0x17c),_0x33a193,_0x5d9939(0x1a5)),loggerService_1[_0x5d9939(0x137)]['logWhiteDomainRequest'](_0x5d9939(0x165),_0x5d9939(0x16c),_0x5d9939(0x19e),_0x876fb1);const _0x16b1c2=await fetch(this['apiUrl'],{'method':'POST','headers':{'Content-Type':'application/json','Accept':_0x5d9939(0x199),'User-Agent':_0x5d9939(0x173)},'body':JSON['stringify'](_0x876fb1)}),_0x3496f5=Date[_0x5d9939(0x14a)]()-_0x2e79ef;console['log'](_0x5d9939(0x186)),console['log'](_0x5d9939(0x174),_0x16b1c2[_0x5d9939(0x1b0)]),console[_0x5d9939(0x17e)](_0x5d9939(0x13a),_0x16b1c2['statusText']),console['log'](_0x5d9939(0x16e),Object[_0x5d9939(0x139)](_0x16b1c2[_0x5d9939(0x19b)][_0x5d9939(0x181)]())),console[_0x5d9939(0x17e)](_0x5d9939(0x1a6),_0x3496f5+'ms');const _0x3c4ca7=await _0x16b1c2['text']();console['log'](_0x5d9939(0x16b),_0x3c4ca7);if(!_0x16b1c2['ok']){console[_0x5d9939(0x1a8)](_0x5d9939(0x167)),console[_0x5d9939(0x1a8)](_0x5d9939(0x15d),_0x16b1c2[_0x5d9939(0x1b0)]),console['error'](_0x5d9939(0x155),_0x3c4ca7),loggerService_1[_0x5d9939(0x137)]['logWhiteDomainResponse'](_0x5d9939(0x165),_0x5d9939(0x16c),_0x16b1c2['status'],_0x3c4ca7,_0x3496f5),loggerService_1['loggerService'][_0x5d9939(0x150)](_0x5d9939(0x165),'/create',_0x5d9939(0x191)+_0x16b1c2['status']+':\x20'+_0x3c4ca7);throw new Error(_0x5d9939(0x197)+_0x16b1c2[_0x5d9939(0x1b0)]+_0x5d9939(0x17a)+_0x3c4ca7);}let _0xa5aa6d;try{_0xa5aa6d=JSON[_0x5d9939(0x1a9)](_0x3c4ca7);}catch(_0x4ca608){console[_0x5d9939(0x1a8)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x4ca608),loggerService_1[_0x5d9939(0x137)][_0x5d9939(0x150)]('cointopay2','/create',_0x5d9939(0x13b)+_0x4ca608);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20'+_0x3c4ca7);}console[_0x5d9939(0x17e)](_0x5d9939(0x131)),console[_0x5d9939(0x17e)](_0x5d9939(0x189),JSON['stringify'](_0xa5aa6d,null,0x2)),loggerService_1['loggerService'][_0x5d9939(0x145)](_0x5d9939(0x165),_0x5d9939(0x16c),_0x16b1c2[_0x5d9939(0x1b0)],_0xa5aa6d,_0x3496f5);if(_0xa5aa6d[_0x5d9939(0x1a8)]){const _0x46a564=_0xa5aa6d[_0x5d9939(0x194)]||_0xa5aa6d[_0x5d9939(0x1a8)]||_0x5d9939(0x18e);console['error'](_0x5d9939(0x138)),console['error'](_0x5d9939(0x134),_0x46a564),loggerService_1[_0x5d9939(0x137)][_0x5d9939(0x150)]('cointopay2','/create','Business\x20Error:\x20'+_0x46a564);throw new Error(_0x5d9939(0x1b6)+_0x46a564);}if(!_0xa5aa6d['payment_url']||!_0xa5aa6d[_0x5d9939(0x1b2)]){console['error'](_0x5d9939(0x13d)),console['error'](_0x5d9939(0x180)),console['error']('Response\x20data:',_0xa5aa6d),loggerService_1[_0x5d9939(0x137)][_0x5d9939(0x150)](_0x5d9939(0x165),_0x5d9939(0x16c),_0x5d9939(0x170));throw new Error(_0x5d9939(0x14d));}return console[_0x5d9939(0x17e)](_0x5d9939(0x14f)),console[_0x5d9939(0x17e)](_0x5d9939(0x1ac),_0xa5aa6d['gateway_payment_id']),console[_0x5d9939(0x17e)](_0x5d9939(0x16f),_0xa5aa6d[_0x5d9939(0x15b)]),console[_0x5d9939(0x17e)]('Amount:',_0x33a193,'EUR'),{'gateway_payment_id':_0xa5aa6d[_0x5d9939(0x1b2)],'payment_url':_0xa5aa6d[_0x5d9939(0x15b)]};}catch(_0x3059a8){console[_0x5d9939(0x1a8)](_0x5d9939(0x164)),console[_0x5d9939(0x1a8)](_0x5d9939(0x168),_0x3059a8),loggerService_1[_0x5d9939(0x137)][_0x5d9939(0x150)]('cointopay2',_0x5d9939(0x16c),_0x3059a8);if(_0x3059a8 instanceof Error){console[_0x5d9939(0x1a8)]('Error\x20message:',_0x3059a8[_0x5d9939(0x194)]),console[_0x5d9939(0x1a8)](_0x5d9939(0x190),_0x3059a8[_0x5d9939(0x187)]);throw new Error(_0x5d9939(0x146)+_0x3059a8['message']);}throw new Error(_0x5d9939(0x195));}}async[a42_0x556a49(0x1a1)](_0x3633b9){const _0x35e4fc=a42_0x556a49,_0x27ba79=Date['now']();try{console[_0x35e4fc(0x17e)](_0x35e4fc(0x152)+_0x3633b9);const _0x193a52={'gatewayPaymentId':_0x3633b9};loggerService_1['loggerService'][_0x35e4fc(0x176)](_0x35e4fc(0x165),_0x35e4fc(0x17f),'POST',_0x193a52);const _0x3f9f8b=await fetch(this[_0x35e4fc(0x163)],{'method':'POST','headers':{'Content-Type':'application/json','Accept':_0x35e4fc(0x199),'User-Agent':_0x35e4fc(0x173)},'body':JSON[_0x35e4fc(0x1a3)](_0x193a52)}),_0x4761e1=Date[_0x35e4fc(0x14a)]()-_0x27ba79;console['log'](_0x35e4fc(0x149)),console['log'](_0x35e4fc(0x174),_0x3f9f8b[_0x35e4fc(0x1b0)]),console['log']('Response\x20Time:',_0x4761e1+'ms');if(!_0x3f9f8b['ok']){const _0x5d2958=await _0x3f9f8b[_0x35e4fc(0x1b8)]();console[_0x35e4fc(0x1a8)](_0x35e4fc(0x15d),_0x3f9f8b[_0x35e4fc(0x1b0)]),console[_0x35e4fc(0x1a8)](_0x35e4fc(0x155),_0x5d2958),loggerService_1[_0x35e4fc(0x137)]['logWhiteDomainResponse'](_0x35e4fc(0x165),_0x35e4fc(0x17f),_0x3f9f8b[_0x35e4fc(0x1b0)],_0x5d2958,_0x4761e1),loggerService_1[_0x35e4fc(0x137)][_0x35e4fc(0x150)](_0x35e4fc(0x165),_0x35e4fc(0x17f),_0x35e4fc(0x191)+_0x3f9f8b[_0x35e4fc(0x1b0)]+':\x20'+_0x5d2958);throw new Error('HTTP\x20error!\x20status:\x20'+_0x3f9f8b[_0x35e4fc(0x1b0)]);}const _0x2d702d=await _0x3f9f8b[_0x35e4fc(0x1b8)]();console[_0x35e4fc(0x17e)]('Raw\x20Response\x20Body:',_0x2d702d);let _0x39c327;try{_0x39c327=JSON[_0x35e4fc(0x1a9)](_0x2d702d);}catch(_0x5437a2){console['error'](_0x35e4fc(0x185),_0x5437a2),loggerService_1[_0x35e4fc(0x137)][_0x35e4fc(0x150)](_0x35e4fc(0x165),_0x35e4fc(0x17f),_0x35e4fc(0x13b)+_0x5437a2);throw new Error(_0x35e4fc(0x148)+_0x2d702d);}loggerService_1[_0x35e4fc(0x137)][_0x35e4fc(0x145)]('cointopay2','/status',_0x3f9f8b[_0x35e4fc(0x1b0)],_0x39c327,_0x4761e1),console[_0x35e4fc(0x17e)](_0x35e4fc(0x12f)),console['log'](_0x35e4fc(0x19f),_0x39c327['result']),console[_0x35e4fc(0x17e)](_0x35e4fc(0x13c),_0x39c327['status_code']),console[_0x35e4fc(0x17e)](_0x35e4fc(0x1b1),_0x39c327[_0x35e4fc(0x19c)]?.['Status']),console['log'](_0x35e4fc(0x17c),_0x39c327['data']?.[_0x35e4fc(0x15c)]),console[_0x35e4fc(0x17e)](_0x35e4fc(0x1aa),_0x39c327[_0x35e4fc(0x19c)]?.[_0x35e4fc(0x1af)]);if(_0x39c327[_0x35e4fc(0x14b)]!=='success'||_0x39c327[_0x35e4fc(0x133)]!==0xc8){const _0x4ae491=_0x39c327[_0x35e4fc(0x194)]||'Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API';console[_0x35e4fc(0x1a8)](_0x35e4fc(0x143)),console[_0x35e4fc(0x1a8)]('Error\x20Message:',_0x4ae491),loggerService_1[_0x35e4fc(0x137)][_0x35e4fc(0x150)](_0x35e4fc(0x165),'/status',_0x35e4fc(0x142)+_0x4ae491);throw new Error(_0x35e4fc(0x13e)+_0x4ae491);}if(!_0x39c327['data']){console[_0x35e4fc(0x1a8)](_0x35e4fc(0x157)),console['error'](_0x35e4fc(0x169)),loggerService_1[_0x35e4fc(0x137)][_0x35e4fc(0x150)](_0x35e4fc(0x165),_0x35e4fc(0x17f),_0x35e4fc(0x18b));throw new Error(_0x35e4fc(0x177));}let _0x216626=_0x35e4fc(0x15e);switch(_0x39c327[_0x35e4fc(0x19c)]['Status']?.['toLowerCase']()){case _0x35e4fc(0x1a4):_0x216626='PAID';break;case'cancelled':case'failed':case _0x35e4fc(0x1a8):_0x216626='FAILED';break;case _0x35e4fc(0x141):case _0x35e4fc(0x135):_0x216626=_0x35e4fc(0x196);break;case _0x35e4fc(0x140):case _0x35e4fc(0x18c):case'pending':case _0x35e4fc(0x162):default:_0x216626='PENDING';break;}let _0x15d0e9,_0x20a5da;if(_0x39c327[_0x35e4fc(0x19c)][_0x35e4fc(0x160)]){const _0xac9d7=_0x39c327[_0x35e4fc(0x19c)][_0x35e4fc(0x160)];console['log'](_0x35e4fc(0x161),_0xac9d7);const _0x2e0cb3=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x4dc0c3 of _0x2e0cb3){const _0x1f0a29=_0xac9d7[_0x35e4fc(0x14e)](_0x4dc0c3);if(_0x1f0a29){_0x15d0e9=_0x1f0a29[0x1],console['log'](_0x35e4fc(0x188),_0x15d0e9,_0x35e4fc(0x1b9),_0x4dc0c3[_0x35e4fc(0x15a)]);break;}}if(!_0x15d0e9){console[_0x35e4fc(0x17e)](_0x35e4fc(0x198));const _0x7c8aec=_0xac9d7['match'](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x7c8aec&&(_0x15d0e9=_0x7c8aec[0x1],console[_0x35e4fc(0x17e)](_0x35e4fc(0x19d),_0x15d0e9));}_0x20a5da=_0xac9d7;}const _0x286bd7={'iban':_0x15d0e9,'bankDetails':_0x20a5da,'transactionId':_0x39c327[_0x35e4fc(0x19c)][_0x35e4fc(0x18d)],'coinAddress':_0x39c327[_0x35e4fc(0x19c)][_0x35e4fc(0x179)],'qrCodeUrl':_0x39c327[_0x35e4fc(0x19c)][_0x35e4fc(0x156)],'expiryTime':_0x39c327[_0x35e4fc(0x19c)][_0x35e4fc(0x154)],'createdOn':_0x39c327[_0x35e4fc(0x19c)]['CreatedOn'],'confirmedOn':_0x39c327[_0x35e4fc(0x19c)]['TransactionConfirmedOn']};console[_0x35e4fc(0x17e)]('===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20==='),console[_0x35e4fc(0x17e)]('Status:',_0x39c327['data']['Status'],'->',_0x216626),console['log'](_0x35e4fc(0x17c),_0x39c327['data'][_0x35e4fc(0x15c)],_0x39c327['data']['inputCurrency']),console['log'](_0x35e4fc(0x175),_0x39c327['data'][_0x35e4fc(0x18d)]),console['log']('IBAN:',_0x15d0e9||_0x35e4fc(0x178)),console[_0x35e4fc(0x17e)]('Created\x20On:',_0x39c327[_0x35e4fc(0x19c)][_0x35e4fc(0x1b3)]),console[_0x35e4fc(0x17e)](_0x35e4fc(0x132),_0x39c327[_0x35e4fc(0x19c)][_0x35e4fc(0x1a2)]||'not\x20confirmed');if(_0x39c327[_0x35e4fc(0x19c)][_0x35e4fc(0x151)]?.[_0x35e4fc(0x17b)]()===_0x35e4fc(0x18c))console['log'](_0x35e4fc(0x1ab));else _0x39c327[_0x35e4fc(0x19c)]['Status']?.['toLowerCase']()===_0x35e4fc(0x1a4)&&console[_0x35e4fc(0x17e)]('‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID');return{'status':_0x216626,'amount':parseFloat(_0x39c327['data'][_0x35e4fc(0x15c)])||undefined,'currency':_0x39c327[_0x35e4fc(0x19c)]['inputCurrency']||_0x35e4fc(0x159),'paymentDetails':_0x286bd7};}catch(_0x5bfd60){console['error'](_0x35e4fc(0x1b5),_0x5bfd60),loggerService_1[_0x35e4fc(0x137)][_0x35e4fc(0x150)](_0x35e4fc(0x165),_0x35e4fc(0x17f),_0x5bfd60);throw new Error(_0x35e4fc(0x192)+(_0x5bfd60 instanceof Error?_0x5bfd60[_0x35e4fc(0x194)]:'Unknown\x20error'));}}async['verifyPayment'](_0x3e1a59){const _0x1b94bb=a42_0x556a49,_0x805caf=await this[_0x1b94bb(0x1a1)](_0x3e1a59);return{'status':_0x805caf[_0x1b94bb(0x1b0)],'amount':_0x805caf[_0x1b94bb(0x166)],'currency':_0x805caf['currency']};}async[a42_0x556a49(0x182)](_0x1a30fc){const _0x37990b=a42_0x556a49;console['log']('Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x1a30fc);let _0x5dfbbc='PENDING';switch(_0x1a30fc[_0x37990b(0x1b0)]?.[_0x37990b(0x17b)]()){case'paid':_0x5dfbbc=_0x37990b(0x184);break;case _0x37990b(0x130):case _0x37990b(0x18a):case _0x37990b(0x1a8):_0x5dfbbc=_0x37990b(0x1ad);break;case _0x37990b(0x141):case _0x37990b(0x135):_0x5dfbbc=_0x37990b(0x196);break;case _0x37990b(0x147):case'waiting':case _0x37990b(0x18c):case _0x37990b(0x162):default:_0x5dfbbc=_0x37990b(0x15e);break;}return{'paymentId':_0x1a30fc[_0x37990b(0x158)]||_0x1a30fc[_0x37990b(0x1a7)]||'','status':_0x5dfbbc,'amount':_0x1a30fc[_0x37990b(0x166)],'currency':_0x1a30fc[_0x37990b(0x144)]||_0x37990b(0x159)};}}exports[a42_0x556a49(0x18f)]=CoinToPay2Service;