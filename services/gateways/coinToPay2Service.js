'use strict';const a54_0x271010=a54_0x8353;(function(_0x151ab6,_0x188781){const _0x327aab=a54_0x8353,_0x5426a6=_0x151ab6();while(!![]){try{const _0x2540b0=parseInt(_0x327aab(0x12b))/0x1+parseInt(_0x327aab(0x122))/0x2+parseInt(_0x327aab(0x169))/0x3*(parseInt(_0x327aab(0x149))/0x4)+-parseInt(_0x327aab(0x107))/0x5*(parseInt(_0x327aab(0x13f))/0x6)+parseInt(_0x327aab(0x12a))/0x7*(-parseInt(_0x327aab(0x16f))/0x8)+parseInt(_0x327aab(0xf0))/0x9+parseInt(_0x327aab(0x104))/0xa*(-parseInt(_0x327aab(0xea))/0xb);if(_0x2540b0===_0x188781)break;else _0x5426a6['push'](_0x5426a6['shift']());}catch(_0x32469b){_0x5426a6['push'](_0x5426a6['shift']());}}}(a54_0x17fa,0x7671b));function a54_0x17fa(){const _0x58c468=['Raw\x20Response\x20Body:','Payment\x20Status:','59736IBiomz','QRCodeURL','Request\x20Body:','logWhiteDomainResponse','https://traffer.uk/gateway/cointopay/','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','text','data','../loggerService','PENDING','2186824WJIpVd','cancelled','parse',',\x20body:\x20','message','waiting','Incomplete\x20response:\x20missing\x20data','Error\x20message:','üè¶\x20Extracted\x20IBAN:','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','toLowerCase','Currency:','expired','/create','merchant_reference_id','POST','awaiting\x20fiat','application/json','üìä\x20Status\x20check\x20URL:','pending','checkPaymentStatus','üè¶\x20Payment\x20Detail:','Status:','===\x20COINTOPAY2\x20API\x20ERROR\x20===','Parsed\x20Result:','Response\x20Time:','logWhiteDomainRequest','FAILED','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','3lQjkzQ','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','using\x20pattern:','statusUrl','createPaymentLink','464808OHjdvj','Created\x20On:','gateway_payment_id','failed','status','Headers:','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','EXPIRED','Missing\x20data\x20in\x20response','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','99Wnohpj','Response\x20data:','Amount:','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','Status\x20Code:','Error\x20stack:','5294610CseUwK','&alternative=false','IBAN:','now','URL:','success','log','EUR','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','HTTP\x20error!\x20status:\x20','match','TransactionID','Unknown\x20error','result','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','cointopay2','logWhiteDomainError','apiUrl','inputCurrency','1670510FIDJPw','HTTP\x20Status:','timeout','5WhCTrf','JSON\x20Parse\x20Error:\x20','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','amount','payment_url','===\x20COINTOPAY2\x20SUCCESS\x20===','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','loggerService','TransactionConfirmedOn','HTTP\x20','Status','Confirmed\x20On:','status_code','statusText','Status\x20Text:','CoinToPay2\x20API\x20error:\x20','error','Amount','created','PAID','not\x20found','processWebhook','Payment\x20System/1.0\x20(CoinToPay2)','CreatedOn','Response\x20Body:','PaymentDetail','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','1312422WkepQS','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','paid','defineProperty','CoinToPay2Service','/status','source','77pZhDmB','846466tsYFDb','currency','Error\x20details:','fromEntries','coinAddress','Gateway\x20Payment\x20ID:','Result:','stack','stringify','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Failed\x20to\x20parse\x20JSON\x20response:','Transaction\x20ID:','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','\x20EUR','entries','Payment\x20URL\x20(modified):','https://traffer.uk/gateway/cointopay/status.php','CoinToPay2\x20status\x20API\x20error:\x20'];a54_0x17fa=function(){return _0x58c468;};return a54_0x17fa();}Object[a54_0x271010(0x126)](exports,'__esModule',{'value':!![]}),exports[a54_0x271010(0x127)]=void 0x0;const loggerService_1=require(a54_0x271010(0x147));class CoinToPay2Service{constructor(){const _0x550e6c=a54_0x271010;this['apiUrl']=_0x550e6c(0x143),this[_0x550e6c(0x16d)]=_0x550e6c(0x13b),console['log']('ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy'),console['log'](_0x550e6c(0x15e),this['statusUrl']);}async[a54_0x271010(0x16e)](_0x425092){const _0x14158d=a54_0x271010,{orderId:_0xe4521c,amount:_0x216e73}=_0x425092;console[_0x14158d(0xf6)]('ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20'+_0x216e73+_0x14158d(0x138));const _0x4eb734={'amount':_0x216e73},_0x1ce6bb=Date[_0x14158d(0xf3)]();try{console[_0x14158d(0xf6)](_0x14158d(0x16b)),console[_0x14158d(0xf6)](_0x14158d(0xf4),this[_0x14158d(0x102)]),console['log'](_0x14158d(0x141),JSON['stringify'](_0x4eb734,null,0x2)),console[_0x14158d(0xf6)](_0x14158d(0xec),_0x216e73,_0x14158d(0x176)),loggerService_1[_0x14158d(0x10e)][_0x14158d(0x166)](_0x14158d(0x100),_0x14158d(0x159),_0x14158d(0x15b),_0x4eb734);const _0x3d260a=await fetch(this[_0x14158d(0x102)],{'method':_0x14158d(0x15b),'headers':{'Content-Type':_0x14158d(0x15d),'Accept':_0x14158d(0x15d),'User-Agent':'Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON['stringify'](_0x4eb734)}),_0x1ba9ad=Date[_0x14158d(0xf3)]()-_0x1ce6bb;console[_0x14158d(0xf6)](_0x14158d(0x137)),console[_0x14158d(0xf6)]('Status:',_0x3d260a['status']),console[_0x14158d(0xf6)](_0x14158d(0x115),_0x3d260a[_0x14158d(0x114)]),console[_0x14158d(0xf6)](_0x14158d(0x174),Object[_0x14158d(0x12e)](_0x3d260a['headers'][_0x14158d(0x139)]())),console[_0x14158d(0xf6)]('Response\x20Time:',_0x1ba9ad+'ms');const _0x76688e=await _0x3d260a['text']();console[_0x14158d(0xf6)](_0x14158d(0x13d),_0x76688e);if(!_0x3d260a['ok']){console[_0x14158d(0x117)](_0x14158d(0x163)),console[_0x14158d(0x117)]('HTTP\x20Status:',_0x3d260a['status']),console[_0x14158d(0x117)](_0x14158d(0x11f),_0x76688e),loggerService_1[_0x14158d(0x10e)]['logWhiteDomainResponse'](_0x14158d(0x100),'/create',_0x3d260a[_0x14158d(0x173)],_0x76688e,_0x1ba9ad),loggerService_1[_0x14158d(0x10e)][_0x14158d(0x101)](_0x14158d(0x100),'/create',_0x14158d(0x110)+_0x3d260a[_0x14158d(0x173)]+':\x20'+_0x76688e);throw new Error(_0x14158d(0xfa)+_0x3d260a[_0x14158d(0x173)]+_0x14158d(0x14c)+_0x76688e);}let _0x170917;try{_0x170917=JSON[_0x14158d(0x14b)](_0x76688e);}catch(_0x1268e2){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0x1268e2),loggerService_1['loggerService']['logWhiteDomainError'](_0x14158d(0x100),'/create',_0x14158d(0x108)+_0x1268e2);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20'+_0x76688e);}console['log'](_0x14158d(0x155)),console[_0x14158d(0xf6)](_0x14158d(0x164),JSON['stringify'](_0x170917,null,0x2)),loggerService_1[_0x14158d(0x10e)][_0x14158d(0x142)](_0x14158d(0x100),_0x14158d(0x159),_0x3d260a[_0x14158d(0x173)],_0x170917,_0x1ba9ad);if(_0x170917[_0x14158d(0x117)]){const _0x3eb9f4=_0x170917[_0x14158d(0x14d)]||_0x170917[_0x14158d(0x117)]||'Unknown\x20error\x20from\x20CoinToPay2\x20API';console[_0x14158d(0x117)](_0x14158d(0xff)),console[_0x14158d(0x117)]('Error\x20Message:',_0x3eb9f4),loggerService_1[_0x14158d(0x10e)]['logWhiteDomainError']('cointopay2',_0x14158d(0x159),'Business\x20Error:\x20'+_0x3eb9f4);throw new Error(_0x14158d(0x116)+_0x3eb9f4);}if(!_0x170917[_0x14158d(0x10b)]||!_0x170917[_0x14158d(0x171)]){console['error'](_0x14158d(0x153)),console['error'](_0x14158d(0xed)),console[_0x14158d(0x117)](_0x14158d(0xeb),_0x170917),loggerService_1[_0x14158d(0x10e)][_0x14158d(0x101)](_0x14158d(0x100),_0x14158d(0x159),'Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error(_0x14158d(0x175));}console['log'](_0x14158d(0x10c)),console[_0x14158d(0xf6)](_0x14158d(0x130),_0x170917[_0x14158d(0x171)]),console[_0x14158d(0xf6)]('Payment\x20URL\x20(original):',_0x170917['payment_url']);const _0x1d63f3=_0x170917['payment_url']+_0x14158d(0xf1);return console[_0x14158d(0xf6)](_0x14158d(0x13a),_0x1d63f3),console['log'](_0x14158d(0xec),_0x216e73,_0x14158d(0xf7)),{'gateway_payment_id':_0x170917[_0x14158d(0x171)],'payment_url':_0x1d63f3};}catch(_0x534109){console[_0x14158d(0x117)](_0x14158d(0x121)),console[_0x14158d(0x117)](_0x14158d(0x12d),_0x534109),loggerService_1['loggerService'][_0x14158d(0x101)](_0x14158d(0x100),_0x14158d(0x159),_0x534109);if(_0x534109 instanceof Error){console[_0x14158d(0x117)](_0x14158d(0x150),_0x534109[_0x14158d(0x14d)]),console[_0x14158d(0x117)](_0x14158d(0xef),_0x534109[_0x14158d(0x132)]);throw new Error(_0x14158d(0x144)+_0x534109[_0x14158d(0x14d)]);}throw new Error(_0x14158d(0x10d));}}async['checkPaymentStatus'](_0x5e81ef){const _0xe27ad7=a54_0x271010,_0x5cc528=Date[_0xe27ad7(0xf3)]();try{console['log'](_0xe27ad7(0x16a)+_0x5e81ef);const _0x3b5420={'gatewayPaymentId':_0x5e81ef};loggerService_1[_0xe27ad7(0x10e)][_0xe27ad7(0x166)](_0xe27ad7(0x100),_0xe27ad7(0x128),_0xe27ad7(0x15b),_0x3b5420);const _0x4d3ae2=await fetch(this[_0xe27ad7(0x16d)],{'method':_0xe27ad7(0x15b),'headers':{'Content-Type':_0xe27ad7(0x15d),'Accept':_0xe27ad7(0x15d),'User-Agent':_0xe27ad7(0x11d)},'body':JSON[_0xe27ad7(0x133)](_0x3b5420)}),_0x4532f6=Date[_0xe27ad7(0xf3)]()-_0x5cc528;console[_0xe27ad7(0xf6)](_0xe27ad7(0x123)),console[_0xe27ad7(0xf6)](_0xe27ad7(0x162),_0x4d3ae2[_0xe27ad7(0x173)]),console[_0xe27ad7(0xf6)](_0xe27ad7(0x165),_0x4532f6+'ms');if(!_0x4d3ae2['ok']){const _0x2d5317=await _0x4d3ae2[_0xe27ad7(0x145)]();console[_0xe27ad7(0x117)](_0xe27ad7(0x105),_0x4d3ae2[_0xe27ad7(0x173)]),console['error'](_0xe27ad7(0x11f),_0x2d5317),loggerService_1['loggerService'][_0xe27ad7(0x142)](_0xe27ad7(0x100),_0xe27ad7(0x128),_0x4d3ae2[_0xe27ad7(0x173)],_0x2d5317,_0x4532f6),loggerService_1[_0xe27ad7(0x10e)]['logWhiteDomainError'](_0xe27ad7(0x100),'/status',_0xe27ad7(0x110)+_0x4d3ae2[_0xe27ad7(0x173)]+':\x20'+_0x2d5317);throw new Error(_0xe27ad7(0xfa)+_0x4d3ae2[_0xe27ad7(0x173)]);}const _0x4cf14d=await _0x4d3ae2['text']();console[_0xe27ad7(0xf6)](_0xe27ad7(0x13d),_0x4cf14d);let _0x18497c;try{_0x18497c=JSON['parse'](_0x4cf14d);}catch(_0x4ea56d){console[_0xe27ad7(0x117)](_0xe27ad7(0x135),_0x4ea56d),loggerService_1[_0xe27ad7(0x10e)][_0xe27ad7(0x101)]('cointopay2',_0xe27ad7(0x128),_0xe27ad7(0x108)+_0x4ea56d);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20'+_0x4cf14d);}loggerService_1['loggerService'][_0xe27ad7(0x142)](_0xe27ad7(0x100),_0xe27ad7(0x128),_0x4d3ae2[_0xe27ad7(0x173)],_0x18497c,_0x4532f6),console[_0xe27ad7(0xf6)](_0xe27ad7(0x124)),console[_0xe27ad7(0xf6)](_0xe27ad7(0x131),_0x18497c[_0xe27ad7(0xfe)]),console['log'](_0xe27ad7(0xee),_0x18497c[_0xe27ad7(0x113)]),console[_0xe27ad7(0xf6)](_0xe27ad7(0x13e),_0x18497c[_0xe27ad7(0x146)]?.[_0xe27ad7(0x111)]),console[_0xe27ad7(0xf6)]('Amount:',_0x18497c[_0xe27ad7(0x146)]?.['Amount']),console[_0xe27ad7(0xf6)](_0xe27ad7(0x157),_0x18497c['data']?.[_0xe27ad7(0x103)]);if(_0x18497c['result']!==_0xe27ad7(0xf5)||_0x18497c[_0xe27ad7(0x113)]!==0xc8){const _0x5cda57=_0x18497c[_0xe27ad7(0x14d)]||_0xe27ad7(0x109);console[_0xe27ad7(0x117)](_0xe27ad7(0x152)),console[_0xe27ad7(0x117)]('Error\x20Message:',_0x5cda57),loggerService_1[_0xe27ad7(0x10e)]['logWhiteDomainError'](_0xe27ad7(0x100),_0xe27ad7(0x128),'Status\x20API\x20Error:\x20'+_0x5cda57);throw new Error(_0xe27ad7(0x13c)+_0x5cda57);}if(!_0x18497c[_0xe27ad7(0x146)]){console[_0xe27ad7(0x117)](_0xe27ad7(0x154)),console['error'](_0xe27ad7(0x178)),loggerService_1['loggerService'][_0xe27ad7(0x101)](_0xe27ad7(0x100),_0xe27ad7(0x128),_0xe27ad7(0x14f));throw new Error(_0xe27ad7(0x168));}let _0x3c3fda=_0xe27ad7(0x148);switch(_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0x111)]?.[_0xe27ad7(0x156)]()){case _0xe27ad7(0x125):_0x3c3fda=_0xe27ad7(0x11a);break;case _0xe27ad7(0x14a):case _0xe27ad7(0x172):case'error':_0x3c3fda=_0xe27ad7(0x167);break;case _0xe27ad7(0x158):case _0xe27ad7(0x106):_0x3c3fda=_0xe27ad7(0x177);break;case _0xe27ad7(0x14e):case _0xe27ad7(0x15c):case _0xe27ad7(0x15f):case _0xe27ad7(0x119):default:_0x3c3fda=_0xe27ad7(0x148);break;}let _0x2a3071,_0x54091f;if(_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0x120)]){const _0xc2d3c=_0x18497c[_0xe27ad7(0x146)]['PaymentDetail'];console[_0xe27ad7(0xf6)](_0xe27ad7(0x161),_0xc2d3c);const _0x2628cd=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x41cbce of _0x2628cd){const _0x35ad24=_0xc2d3c['match'](_0x41cbce);if(_0x35ad24){_0x2a3071=_0x35ad24[0x1],console[_0xe27ad7(0xf6)](_0xe27ad7(0x151),_0x2a3071,_0xe27ad7(0x16c),_0x41cbce[_0xe27ad7(0x129)]);break;}}if(!_0x2a3071){console['log']('‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...');const _0x52e156=_0xc2d3c[_0xe27ad7(0xfb)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x52e156&&(_0x2a3071=_0x52e156[0x1],console['log'](_0xe27ad7(0xe9),_0x2a3071));}_0x54091f=_0xc2d3c;}const _0x5f1fda={'iban':_0x2a3071,'bankDetails':_0x54091f,'transactionId':_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0xfc)],'coinAddress':_0x18497c['data'][_0xe27ad7(0x12f)],'qrCodeUrl':_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0x140)],'expiryTime':_0x18497c[_0xe27ad7(0x146)]['ExpiryTime'],'createdOn':_0x18497c['data'][_0xe27ad7(0x11e)],'confirmedOn':_0x18497c['data'][_0xe27ad7(0x10f)]};console[_0xe27ad7(0xf6)]('===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20==='),console[_0xe27ad7(0xf6)](_0xe27ad7(0x162),_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0x111)],'->',_0x3c3fda),console[_0xe27ad7(0xf6)](_0xe27ad7(0xec),_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0x118)],_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0x103)]),console[_0xe27ad7(0xf6)](_0xe27ad7(0x136),_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0xfc)]),console['log'](_0xe27ad7(0xf2),_0x2a3071||_0xe27ad7(0x11b)),console[_0xe27ad7(0xf6)](_0xe27ad7(0x170),_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0x11e)]),console[_0xe27ad7(0xf6)](_0xe27ad7(0x112),_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0x10f)]||'not\x20confirmed');if(_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0x111)]?.[_0xe27ad7(0x156)]()===_0xe27ad7(0x15c))console['log'](_0xe27ad7(0x134));else _0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0x111)]?.[_0xe27ad7(0x156)]()==='paid'&&console[_0xe27ad7(0xf6)](_0xe27ad7(0xf8));return{'status':_0x3c3fda,'amount':parseFloat(_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0x118)])||undefined,'currency':_0x18497c[_0xe27ad7(0x146)][_0xe27ad7(0x103)]||'EUR','paymentDetails':_0x5f1fda};}catch(_0x11dea9){console[_0xe27ad7(0x117)]('CoinToPay2\x20payment\x20status\x20check\x20error:',_0x11dea9),loggerService_1['loggerService'][_0xe27ad7(0x101)](_0xe27ad7(0x100),_0xe27ad7(0x128),_0x11dea9);throw new Error(_0xe27ad7(0xf9)+(_0x11dea9 instanceof Error?_0x11dea9[_0xe27ad7(0x14d)]:_0xe27ad7(0xfd)));}}async['verifyPayment'](_0x552476){const _0x815671=a54_0x271010,_0x13ae61=await this[_0x815671(0x160)](_0x552476);return{'status':_0x13ae61[_0x815671(0x173)],'amount':_0x13ae61[_0x815671(0x10a)],'currency':_0x13ae61[_0x815671(0x12c)]};}async[a54_0x271010(0x11c)](_0x892674){const _0x164997=a54_0x271010;console[_0x164997(0xf6)]('Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x892674);let _0x526a87=_0x164997(0x148);switch(_0x892674[_0x164997(0x173)]?.[_0x164997(0x156)]()){case _0x164997(0x125):_0x526a87=_0x164997(0x11a);break;case _0x164997(0x14a):case _0x164997(0x172):case _0x164997(0x117):_0x526a87=_0x164997(0x167);break;case _0x164997(0x158):case _0x164997(0x106):_0x526a87='EXPIRED';break;case _0x164997(0x15f):case _0x164997(0x14e):case _0x164997(0x15c):case _0x164997(0x119):default:_0x526a87=_0x164997(0x148);break;}return{'paymentId':_0x892674['order_id']||_0x892674[_0x164997(0x15a)]||'','status':_0x526a87,'amount':_0x892674[_0x164997(0x10a)],'currency':_0x892674[_0x164997(0x12c)]||_0x164997(0xf7)};}}function a54_0x8353(_0x1b5236,_0xd59101){_0x1b5236=_0x1b5236-0xe9;const _0x17fa8d=a54_0x17fa();let _0x835362=_0x17fa8d[_0x1b5236];return _0x835362;}exports[a54_0x271010(0x127)]=CoinToPay2Service;