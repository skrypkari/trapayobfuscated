'use strict';const a56_0x2211cd=a56_0xa879;(function(_0x21846b,_0x2eb385){const _0x5b50ae=a56_0xa879,_0x3d3116=_0x21846b();while(!![]){try{const _0x1d0eed=parseInt(_0x5b50ae(0x12b))/0x1*(parseInt(_0x5b50ae(0xf9))/0x2)+parseInt(_0x5b50ae(0xc8))/0x3+-parseInt(_0x5b50ae(0x118))/0x4*(-parseInt(_0x5b50ae(0x122))/0x5)+parseInt(_0x5b50ae(0x12f))/0x6*(-parseInt(_0x5b50ae(0xdd))/0x7)+parseInt(_0x5b50ae(0xf2))/0x8+-parseInt(_0x5b50ae(0xfa))/0x9+-parseInt(_0x5b50ae(0x128))/0xa;if(_0x1d0eed===_0x2eb385)break;else _0x3d3116['push'](_0x3d3116['shift']());}catch(_0x1c990c){_0x3d3116['push'](_0x3d3116['shift']());}}}(a56_0x274a,0xc2a23));function a56_0x274a(){const _0x2fd83a=['Gateway\x20Payment\x20ID:','cancelled','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','===\x20COINTOPAY2\x20SUCCESS\x20===','Error\x20details:','Status','/status','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','coinAddress','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','expired','data','statusUrl','Status\x20API\x20Error:\x20','1587849RCxVMV','log','logWhiteDomainResponse','logWhiteDomainRequest','TransactionConfirmedOn','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','status_code','loggerService','inputCurrency','Confirmed\x20On:','gateway_payment_id','üè¶\x20Payment\x20Detail:','üè¶\x20Extracted\x20IBAN:','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Result:','&alternative=false','EXPIRED','toLowerCase','Payment\x20URL\x20(original):','Response\x20Time:','Raw\x20Response\x20Body:','56ellrfr','Response\x20data:','message','stringify','CoinToPay2Service','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','HTTP\x20Status:','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','Currency:','Failed\x20to\x20parse\x20JSON\x20response:','üìä\x20Status\x20check\x20URL:','CreatedOn','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','cointopay2','HTTP\x20','Status\x20Code:','created','merchant_reference_id','text','Status\x20Text:','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','5140520KBRUDE','JSON\x20Parse\x20Error:\x20','logWhiteDomainError','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','Amount:','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','parse','8mJaqiA','11039013WWdIop','result','PENDING','Amount','paid','awaiting\x20fiat','Status:','amount','Payment\x20URL\x20(modified):','EUR','Unknown\x20error\x20from\x20CoinToPay2\x20API','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','Error\x20Message:','entries','/create',',\x20body:\x20','TransactionID','not\x20found','Payment\x20System/1.0\x20(CoinToPay2)','apiUrl','order_id','waiting','PAID','application/json','CoinToPay2\x20status\x20API\x20error:\x20','Incomplete\x20response:\x20missing\x20data','FAILED','payment_url','success','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','236rvqjdy','POST','Response\x20Body:','statusText','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Unknown\x20error','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','now','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','timeout','72245SwIGPK','status','defineProperty','match','QRCodeURL','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','1396310uHKEZA','Missing\x20data\x20in\x20response','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','157041ZPlTSf','https://traffer.uk/gateway/cointopay/','failed','ExpiryTime','366822eMJHMC','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','IBAN:','PaymentDetail','https://traffer.uk/gateway/cointopay/status.php','error','source','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','Business\x20Error:\x20','Transaction\x20ID:','currency','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','Error\x20message:','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20'];a56_0x274a=function(){return _0x2fd83a;};return a56_0x274a();}Object[a56_0x2211cd(0x124)](exports,'__esModule',{'value':!![]}),exports[a56_0x2211cd(0xe1)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x1ea3de=a56_0x2211cd;this['apiUrl']=_0x1ea3de(0x12c),this['statusUrl']=_0x1ea3de(0x133),console[_0x1ea3de(0xc9)](_0x1ea3de(0x117)),console[_0x1ea3de(0xc9)](_0x1ea3de(0xe7),this[_0x1ea3de(0xc6)]);}async['createPaymentLink'](_0x33d6f9){const _0x4aa754=a56_0x2211cd,{orderId:_0x4272d4,amount:_0x473b35}=_0x33d6f9;console[_0x4aa754(0xc9)](_0x4aa754(0xc3)+_0x473b35+'\x20EUR');const _0x1c196b={'amount':_0x473b35},_0x166e8b=Date['now']();try{console['log'](_0x4aa754(0xf1)),console['log']('URL:',this['apiUrl']),console[_0x4aa754(0xc9)]('Request\x20Body:',JSON['stringify'](_0x1c196b,null,0x2)),console[_0x4aa754(0xc9)]('Amount:',_0x473b35,_0x4aa754(0xc0)),loggerService_1['loggerService'][_0x4aa754(0xcb)](_0x4aa754(0xea),_0x4aa754(0x108),_0x4aa754(0x119),_0x1c196b);const _0x21eb93=await fetch(this[_0x4aa754(0x10d)],{'method':'POST','headers':{'Content-Type':'application/json','Accept':'application/json','User-Agent':_0x4aa754(0x10c)},'body':JSON[_0x4aa754(0xe0)](_0x1c196b)}),_0x332e65=Date[_0x4aa754(0x11f)]()-_0x166e8b;console[_0x4aa754(0xc9)](_0x4aa754(0x105)),console[_0x4aa754(0xc9)](_0x4aa754(0x100),_0x21eb93[_0x4aa754(0x123)]),console[_0x4aa754(0xc9)](_0x4aa754(0xf0),_0x21eb93[_0x4aa754(0x11b)]),console[_0x4aa754(0xc9)]('Headers:',Object['fromEntries'](_0x21eb93['headers'][_0x4aa754(0x107)]())),console[_0x4aa754(0xc9)](_0x4aa754(0xdb),_0x332e65+'ms');const _0x3b5845=await _0x21eb93[_0x4aa754(0xef)]();console[_0x4aa754(0xc9)](_0x4aa754(0xdc),_0x3b5845);if(!_0x21eb93['ok']){console[_0x4aa754(0x134)]('===\x20COINTOPAY2\x20API\x20ERROR\x20==='),console[_0x4aa754(0x134)](_0x4aa754(0xe3),_0x21eb93[_0x4aa754(0x123)]),console[_0x4aa754(0x134)]('Response\x20Body:',_0x3b5845),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x4aa754(0xea),'/create',_0x21eb93[_0x4aa754(0x123)],_0x3b5845,_0x332e65),loggerService_1[_0x4aa754(0xcf)][_0x4aa754(0xf4)](_0x4aa754(0xea),_0x4aa754(0x108),'HTTP\x20'+_0x21eb93[_0x4aa754(0x123)]+':\x20'+_0x3b5845);throw new Error('HTTP\x20error!\x20status:\x20'+_0x21eb93[_0x4aa754(0x123)]+_0x4aa754(0x109)+_0x3b5845);}let _0x3ca7f4;try{_0x3ca7f4=JSON[_0x4aa754(0xf8)](_0x3b5845);}catch(_0x5c8a81){console[_0x4aa754(0x134)](_0x4aa754(0xe6),_0x5c8a81),loggerService_1['loggerService'][_0x4aa754(0xf4)](_0x4aa754(0xea),'/create',_0x4aa754(0xf3)+_0x5c8a81);throw new Error(_0x4aa754(0xcd)+_0x3b5845);}console[_0x4aa754(0xc9)]('===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20==='),console[_0x4aa754(0xc9)]('Parsed\x20Result:',JSON[_0x4aa754(0xe0)](_0x3ca7f4,null,0x2)),loggerService_1[_0x4aa754(0xcf)][_0x4aa754(0xca)](_0x4aa754(0xea),_0x4aa754(0x108),_0x21eb93[_0x4aa754(0x123)],_0x3ca7f4,_0x332e65);if(_0x3ca7f4[_0x4aa754(0x134)]){const _0x1a02ab=_0x3ca7f4[_0x4aa754(0xdf)]||_0x3ca7f4[_0x4aa754(0x134)]||_0x4aa754(0x104);console[_0x4aa754(0x134)](_0x4aa754(0x13f)),console[_0x4aa754(0x134)]('Error\x20Message:',_0x1a02ab),loggerService_1[_0x4aa754(0xcf)][_0x4aa754(0xf4)](_0x4aa754(0xea),'/create',_0x4aa754(0x137)+_0x1a02ab);throw new Error('CoinToPay2\x20API\x20error:\x20'+_0x1a02ab);}if(!_0x3ca7f4[_0x4aa754(0x115)]||!_0x3ca7f4[_0x4aa754(0xd2)]){console['error']('===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x4aa754(0x134)](_0x4aa754(0x130)),console[_0x4aa754(0x134)](_0x4aa754(0xde),_0x3ca7f4),loggerService_1['loggerService'][_0x4aa754(0xf4)](_0x4aa754(0xea),'/create','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id');}console[_0x4aa754(0xc9)](_0x4aa754(0x140)),console[_0x4aa754(0xc9)](_0x4aa754(0x13d),_0x3ca7f4[_0x4aa754(0xd2)]),console[_0x4aa754(0xc9)](_0x4aa754(0xda),_0x3ca7f4['payment_url']);const _0x4e8c3e=_0x3ca7f4[_0x4aa754(0x115)]+_0x4aa754(0xd7);return console[_0x4aa754(0xc9)](_0x4aa754(0x102),_0x4e8c3e),console['log'](_0x4aa754(0xf6),_0x473b35,'EUR'),{'gateway_payment_id':_0x3ca7f4['gateway_payment_id'],'payment_url':_0x4e8c3e};}catch(_0x5a707d){console[_0x4aa754(0x134)](_0x4aa754(0x11e)),console[_0x4aa754(0x134)](_0x4aa754(0x141),_0x5a707d),loggerService_1['loggerService'][_0x4aa754(0xf4)](_0x4aa754(0xea),_0x4aa754(0x108),_0x5a707d);if(_0x5a707d instanceof Error){console[_0x4aa754(0x134)](_0x4aa754(0x13b),_0x5a707d[_0x4aa754(0xdf)]),console['error']('Error\x20stack:',_0x5a707d['stack']);throw new Error(_0x4aa754(0x13c)+_0x5a707d[_0x4aa754(0xdf)]);}throw new Error(_0x4aa754(0x13a));}}async['checkPaymentStatus'](_0x327d6f){const _0x534c5d=a56_0x2211cd,_0x2c2915=Date['now']();try{console[_0x534c5d(0xc9)](_0x534c5d(0xe2)+_0x327d6f);const _0x39d7d3={'gatewayPaymentId':_0x327d6f};loggerService_1[_0x534c5d(0xcf)]['logWhiteDomainRequest'](_0x534c5d(0xea),'/status',_0x534c5d(0x119),_0x39d7d3);const _0x30d5bc=await fetch(this[_0x534c5d(0xc6)],{'method':_0x534c5d(0x119),'headers':{'Content-Type':_0x534c5d(0x111),'Accept':_0x534c5d(0x111),'User-Agent':_0x534c5d(0x10c)},'body':JSON['stringify'](_0x39d7d3)}),_0x3133db=Date[_0x534c5d(0x11f)]()-_0x2c2915;console[_0x534c5d(0xc9)](_0x534c5d(0xf7)),console[_0x534c5d(0xc9)]('Status:',_0x30d5bc['status']),console[_0x534c5d(0xc9)](_0x534c5d(0xdb),_0x3133db+'ms');if(!_0x30d5bc['ok']){const _0x48b04d=await _0x30d5bc['text']();console['error'](_0x534c5d(0xe3),_0x30d5bc[_0x534c5d(0x123)]),console[_0x534c5d(0x134)](_0x534c5d(0x11a),_0x48b04d),loggerService_1[_0x534c5d(0xcf)]['logWhiteDomainResponse'](_0x534c5d(0xea),_0x534c5d(0xbf),_0x30d5bc['status'],_0x48b04d,_0x3133db),loggerService_1[_0x534c5d(0xcf)][_0x534c5d(0xf4)](_0x534c5d(0xea),_0x534c5d(0xbf),_0x534c5d(0xeb)+_0x30d5bc[_0x534c5d(0x123)]+':\x20'+_0x48b04d);throw new Error('HTTP\x20error!\x20status:\x20'+_0x30d5bc[_0x534c5d(0x123)]);}const _0x21b76b=await _0x30d5bc[_0x534c5d(0xef)]();console['log']('Raw\x20Response\x20Body:',_0x21b76b);let _0x1a6736;try{_0x1a6736=JSON[_0x534c5d(0xf8)](_0x21b76b);}catch(_0x4adf5b){console[_0x534c5d(0x134)](_0x534c5d(0xe6),_0x4adf5b),loggerService_1[_0x534c5d(0xcf)]['logWhiteDomainError'](_0x534c5d(0xea),_0x534c5d(0xbf),'JSON\x20Parse\x20Error:\x20'+_0x4adf5b);throw new Error(_0x534c5d(0x136)+_0x21b76b);}loggerService_1[_0x534c5d(0xcf)][_0x534c5d(0xca)](_0x534c5d(0xea),_0x534c5d(0xbf),_0x30d5bc[_0x534c5d(0x123)],_0x1a6736,_0x3133db),console['log'](_0x534c5d(0xf5)),console[_0x534c5d(0xc9)](_0x534c5d(0xd6),_0x1a6736[_0x534c5d(0xfb)]),console[_0x534c5d(0xc9)](_0x534c5d(0xec),_0x1a6736[_0x534c5d(0xce)]),console[_0x534c5d(0xc9)]('Payment\x20Status:',_0x1a6736[_0x534c5d(0xc5)]?.[_0x534c5d(0x142)]),console[_0x534c5d(0xc9)](_0x534c5d(0xf6),_0x1a6736[_0x534c5d(0xc5)]?.[_0x534c5d(0xfd)]),console[_0x534c5d(0xc9)](_0x534c5d(0xe5),_0x1a6736[_0x534c5d(0xc5)]?.['inputCurrency']);if(_0x1a6736[_0x534c5d(0xfb)]!==_0x534c5d(0x116)||_0x1a6736[_0x534c5d(0xce)]!==0xc8){const _0x2db3ba=_0x1a6736[_0x534c5d(0xdf)]||_0x534c5d(0x12a);console[_0x534c5d(0x134)](_0x534c5d(0xe4)),console[_0x534c5d(0x134)](_0x534c5d(0x106),_0x2db3ba),loggerService_1[_0x534c5d(0xcf)][_0x534c5d(0xf4)](_0x534c5d(0xea),_0x534c5d(0xbf),_0x534c5d(0xc7)+_0x2db3ba);throw new Error(_0x534c5d(0x112)+_0x2db3ba);}if(!_0x1a6736[_0x534c5d(0xc5)]){console[_0x534c5d(0x134)](_0x534c5d(0xd5)),console[_0x534c5d(0x134)](_0x534c5d(0x129)),loggerService_1['loggerService'][_0x534c5d(0xf4)](_0x534c5d(0xea),_0x534c5d(0xbf),_0x534c5d(0x113));throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data');}let _0x3af81d=_0x534c5d(0xfc);switch(_0x1a6736[_0x534c5d(0xc5)][_0x534c5d(0x142)]?.[_0x534c5d(0xd9)]()){case'paid':_0x3af81d='PAID';break;case'cancelled':case _0x534c5d(0x12d):case _0x534c5d(0x134):_0x3af81d=_0x534c5d(0x114);break;case _0x534c5d(0xc4):case _0x534c5d(0x121):_0x3af81d=_0x534c5d(0xd8);break;case _0x534c5d(0x10f):case'awaiting\x20fiat':case'pending':case _0x534c5d(0xed):default:_0x3af81d=_0x534c5d(0xfc);break;}let _0x4ec59b,_0x5f461f;if(_0x1a6736['data']['PaymentDetail']){const _0x461cc3=_0x1a6736[_0x534c5d(0xc5)][_0x534c5d(0x132)];console[_0x534c5d(0xc9)](_0x534c5d(0xd3),_0x461cc3);const _0x4c89c4=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x194bc5 of _0x4c89c4){const _0x322452=_0x461cc3[_0x534c5d(0x125)](_0x194bc5);if(_0x322452){_0x4ec59b=_0x322452[0x1],console[_0x534c5d(0xc9)](_0x534c5d(0xd4),_0x4ec59b,'using\x20pattern:',_0x194bc5[_0x534c5d(0x135)]);break;}}if(!_0x4ec59b){console[_0x534c5d(0xc9)](_0x534c5d(0xe9));const _0x753dbe=_0x461cc3[_0x534c5d(0x125)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x753dbe&&(_0x4ec59b=_0x753dbe[0x1],console[_0x534c5d(0xc9)](_0x534c5d(0xc1),_0x4ec59b));}_0x5f461f=_0x461cc3;}const _0x18bfa4={'iban':_0x4ec59b,'bankDetails':_0x5f461f,'transactionId':_0x1a6736[_0x534c5d(0xc5)]['TransactionID'],'coinAddress':_0x1a6736[_0x534c5d(0xc5)][_0x534c5d(0xc2)],'qrCodeUrl':_0x1a6736[_0x534c5d(0xc5)][_0x534c5d(0x126)],'expiryTime':_0x1a6736[_0x534c5d(0xc5)][_0x534c5d(0x12e)],'createdOn':_0x1a6736[_0x534c5d(0xc5)][_0x534c5d(0xe8)],'confirmedOn':_0x1a6736[_0x534c5d(0xc5)][_0x534c5d(0xcc)]};console['log']('===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20==='),console[_0x534c5d(0xc9)](_0x534c5d(0x100),_0x1a6736[_0x534c5d(0xc5)][_0x534c5d(0x142)],'->',_0x3af81d),console[_0x534c5d(0xc9)](_0x534c5d(0xf6),_0x1a6736[_0x534c5d(0xc5)][_0x534c5d(0xfd)],_0x1a6736[_0x534c5d(0xc5)][_0x534c5d(0xd0)]),console[_0x534c5d(0xc9)](_0x534c5d(0x138),_0x1a6736[_0x534c5d(0xc5)][_0x534c5d(0x10a)]),console[_0x534c5d(0xc9)](_0x534c5d(0x131),_0x4ec59b||_0x534c5d(0x10b)),console[_0x534c5d(0xc9)]('Created\x20On:',_0x1a6736['data']['CreatedOn']),console[_0x534c5d(0xc9)](_0x534c5d(0xd1),_0x1a6736[_0x534c5d(0xc5)][_0x534c5d(0xcc)]||'not\x20confirmed');if(_0x1a6736[_0x534c5d(0xc5)]['Status']?.[_0x534c5d(0xd9)]()==='awaiting\x20fiat')console[_0x534c5d(0xc9)](_0x534c5d(0x11c));else _0x1a6736[_0x534c5d(0xc5)]['Status']?.[_0x534c5d(0xd9)]()===_0x534c5d(0xfe)&&console[_0x534c5d(0xc9)](_0x534c5d(0x127));return{'status':_0x3af81d,'amount':parseFloat(_0x1a6736['data'][_0x534c5d(0xfd)])||undefined,'currency':_0x1a6736['data'][_0x534c5d(0xd0)]||'EUR','paymentDetails':_0x18bfa4};}catch(_0x5d6c0b){console[_0x534c5d(0x134)]('CoinToPay2\x20payment\x20status\x20check\x20error:',_0x5d6c0b),loggerService_1['loggerService'][_0x534c5d(0xf4)](_0x534c5d(0xea),_0x534c5d(0xbf),_0x5d6c0b);throw new Error('Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20'+(_0x5d6c0b instanceof Error?_0x5d6c0b[_0x534c5d(0xdf)]:_0x534c5d(0x11d)));}}async['verifyPayment'](_0x53a376){const _0xde7131=a56_0x2211cd,_0x14d5ef=await this['checkPaymentStatus'](_0x53a376);return{'status':_0x14d5ef['status'],'amount':_0x14d5ef[_0xde7131(0x101)],'currency':_0x14d5ef[_0xde7131(0x139)]};}async['processWebhook'](_0x45913b){const _0x321810=a56_0x2211cd;console[_0x321810(0xc9)](_0x321810(0x120),_0x45913b);let _0x2260bb=_0x321810(0xfc);switch(_0x45913b[_0x321810(0x123)]?.[_0x321810(0xd9)]()){case _0x321810(0xfe):_0x2260bb=_0x321810(0x110);break;case _0x321810(0x13e):case _0x321810(0x12d):case _0x321810(0x134):_0x2260bb=_0x321810(0x114);break;case _0x321810(0xc4):case'timeout':_0x2260bb='EXPIRED';break;case'pending':case _0x321810(0x10f):case _0x321810(0xff):case _0x321810(0xed):default:_0x2260bb=_0x321810(0xfc);break;}return{'paymentId':_0x45913b[_0x321810(0x10e)]||_0x45913b[_0x321810(0xee)]||'','status':_0x2260bb,'amount':_0x45913b[_0x321810(0x101)],'currency':_0x45913b[_0x321810(0x139)]||_0x321810(0x103)};}}function a56_0xa879(_0x29e937,_0xc1b070){_0x29e937=_0x29e937-0xbf;const _0x274a86=a56_0x274a();let _0xa8799=_0x274a86[_0x29e937];return _0xa8799;}exports[a56_0x2211cd(0xe1)]=CoinToPay2Service;