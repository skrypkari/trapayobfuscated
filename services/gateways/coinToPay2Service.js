'use strict';const a42_0x39631e=a42_0x53eb;(function(_0x53cf0c,_0x1b1115){const _0xa70a93=a42_0x53eb,_0x598f36=_0x53cf0c();while(!![]){try{const _0x4b03b1=-parseInt(_0xa70a93(0x1ae))/0x1+parseInt(_0xa70a93(0x20b))/0x2+parseInt(_0xa70a93(0x1c1))/0x3+-parseInt(_0xa70a93(0x1e9))/0x4*(parseInt(_0xa70a93(0x211))/0x5)+-parseInt(_0xa70a93(0x1de))/0x6+parseInt(_0xa70a93(0x206))/0x7*(parseInt(_0xa70a93(0x1e1))/0x8)+-parseInt(_0xa70a93(0x1fa))/0x9;if(_0x4b03b1===_0x1b1115)break;else _0x598f36['push'](_0x598f36['shift']());}catch(_0x1d15d7){_0x598f36['push'](_0x598f36['shift']());}}}(a42_0x4961,0xe8660));function a42_0x53eb(_0x4136da,_0x2db8ce){const _0x49614a=a42_0x4961();return a42_0x53eb=function(_0x53ebf7,_0x4c9ef8){_0x53ebf7=_0x53ebf7-0x1a5;let _0x3f714f=_0x49614a[_0x53ebf7];return _0x3f714f;},a42_0x53eb(_0x4136da,_0x2db8ce);}function a42_0x4961(){const _0x569d6f=['created','apiUrl','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','message','pending','status','log','success','Payment\x20Status:','üè¶\x20Extracted\x20IBAN:','CoinToPay2Service','Status\x20API\x20Error:\x20','Failed\x20to\x20parse\x20JSON\x20response:','Amount','Status:','processWebhook','CoinToPay2\x20status\x20API\x20error:\x20','paid','QRCodeURL','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','result','source','Headers:','__esModule','Transaction\x20ID:','1106556PDtcET','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','Request\x20Body:','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','amount','TransactionConfirmedOn','application/json','verifyPayment',',\x20body:\x20','Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id','timeout','not\x20found','order_id','awaiting\x20fiat','currency','Response\x20Time:','loggerService','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','logWhiteDomainError','5338728PFTlUx','stringify','Payment\x20URL:','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','https://traffer.uk/gateway/cointopay/status.php','/status','waiting','Response\x20Body:','POST','error','Amount:','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','statusUrl','Unknown\x20error','parse','failed','payment_url','EXPIRED','PaymentDetail','not\x20confirmed','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','Status\x20Code:','checkPaymentStatus','===\x20COINTOPAY2\x20API\x20ERROR\x20===','statusText','toLowerCase','HTTP\x20','Unknown\x20error\x20from\x20CoinToPay2\x20API','cancelled','855444tfmbYD','coinAddress','using\x20pattern:','40kJvtpW','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','/create','CreatedOn','üè¶\x20Payment\x20Detail:','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','JSON\x20Parse\x20Error:\x20','üìä\x20Status\x20check\x20URL:','196pwlsYc','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','PAID','headers','PENDING','inputCurrency','text','Missing\x20data\x20in\x20response','Parsed\x20Result:','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','cointopay2','Response\x20data:','Raw\x20Response\x20Body:','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','status_code','../loggerService','16556382tVQaWS','Created\x20On:','data','Status','logWhiteDomainResponse','now','match','createPaymentLink','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','logWhiteDomainRequest','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','HTTP\x20error!\x20status:\x20','2537647lGcePB','fromEntries','Currency:','EUR','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','3165308VRTULe','expired','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','FAILED','HTTP\x20Status:','entries','115735AzaFaH','defineProperty','===\x20COINTOPAY2\x20SUCCESS\x20===','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','IBAN:','gateway_payment_id','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','TransactionID','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:'];a42_0x4961=function(){return _0x569d6f;};return a42_0x4961();}Object[a42_0x39631e(0x212)](exports,a42_0x39631e(0x1ac),{'value':!![]}),exports[a42_0x39631e(0x226)]=void 0x0;const loggerService_1=require(a42_0x39631e(0x1f9));class CoinToPay2Service{constructor(){const _0x2ad116=a42_0x39631e;this[_0x2ad116(0x21b)]='https://traffer.uk/gateway/cointopay/',this[_0x2ad116(0x1cd)]=_0x2ad116(0x1c5),console[_0x2ad116(0x222)](_0x2ad116(0x1e6)),console['log'](_0x2ad116(0x1e8),this[_0x2ad116(0x1cd)]);}async[a42_0x39631e(0x201)](_0x342337){const _0x4db337=a42_0x39631e,{orderId:_0x2a93da,amount:_0x59d717}=_0x342337;console[_0x4db337(0x222)](_0x4db337(0x1a8)+_0x59d717+'\x20EUR');const _0x2145f0={'amount':_0x59d717},_0x2e9215=Date[_0x4db337(0x1ff)]();try{console[_0x4db337(0x222)]('===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20==='),console['log']('URL:',this['apiUrl']),console[_0x4db337(0x222)](_0x4db337(0x1b0),JSON[_0x4db337(0x1c2)](_0x2145f0,null,0x2)),console[_0x4db337(0x222)]('Amount:',_0x59d717,_0x4db337(0x21d)),loggerService_1['loggerService']['logWhiteDomainRequest'](_0x4db337(0x1f4),_0x4db337(0x1e3),_0x4db337(0x1c9),_0x2145f0);const _0x763756=await fetch(this[_0x4db337(0x21b)],{'method':_0x4db337(0x1c9),'headers':{'Content-Type':_0x4db337(0x1b4),'Accept':_0x4db337(0x1b4),'User-Agent':_0x4db337(0x1f7)},'body':JSON['stringify'](_0x2145f0)}),_0x135130=Date[_0x4db337(0x1ff)]()-_0x2e9215;console[_0x4db337(0x222)](_0x4db337(0x1ea)),console[_0x4db337(0x222)](_0x4db337(0x22a),_0x763756[_0x4db337(0x221)]),console[_0x4db337(0x222)]('Status\x20Text:',_0x763756[_0x4db337(0x1d9)]),console['log'](_0x4db337(0x1ab),Object[_0x4db337(0x207)](_0x763756[_0x4db337(0x1ec)][_0x4db337(0x210)]())),console[_0x4db337(0x222)](_0x4db337(0x1bd),_0x135130+'ms');const _0x3e3677=await _0x763756[_0x4db337(0x1ef)]();console[_0x4db337(0x222)]('Raw\x20Response\x20Body:',_0x3e3677);if(!_0x763756['ok']){console[_0x4db337(0x1ca)](_0x4db337(0x1d8)),console[_0x4db337(0x1ca)](_0x4db337(0x20f),_0x763756[_0x4db337(0x221)]),console[_0x4db337(0x1ca)](_0x4db337(0x1c8),_0x3e3677),loggerService_1[_0x4db337(0x1be)]['logWhiteDomainResponse'](_0x4db337(0x1f4),'/create',_0x763756['status'],_0x3e3677,_0x135130),loggerService_1['loggerService'][_0x4db337(0x1c0)](_0x4db337(0x1f4),_0x4db337(0x1e3),_0x4db337(0x1db)+_0x763756[_0x4db337(0x221)]+':\x20'+_0x3e3677);throw new Error(_0x4db337(0x205)+_0x763756['status']+_0x4db337(0x1b6)+_0x3e3677);}let _0x4decae;try{_0x4decae=JSON[_0x4db337(0x1cf)](_0x3e3677);}catch(_0x569ca1){console[_0x4db337(0x1ca)](_0x4db337(0x228),_0x569ca1),loggerService_1[_0x4db337(0x1be)]['logWhiteDomainError'](_0x4db337(0x1f4),_0x4db337(0x1e3),_0x4db337(0x1e7)+_0x569ca1);throw new Error(_0x4db337(0x1bf)+_0x3e3677);}console[_0x4db337(0x222)](_0x4db337(0x214)),console[_0x4db337(0x222)](_0x4db337(0x1f1),JSON[_0x4db337(0x1c2)](_0x4decae,null,0x2)),loggerService_1[_0x4db337(0x1be)][_0x4db337(0x1fe)](_0x4db337(0x1f4),_0x4db337(0x1e3),_0x763756['status'],_0x4decae,_0x135130);if(_0x4decae['error']){const _0x3a1584=_0x4decae['message']||_0x4decae[_0x4db337(0x1ca)]||_0x4db337(0x1dc);console[_0x4db337(0x1ca)](_0x4db337(0x21e)),console[_0x4db337(0x1ca)]('Error\x20Message:',_0x3a1584),loggerService_1['loggerService'][_0x4db337(0x1c0)]('cointopay2',_0x4db337(0x1e3),'Business\x20Error:\x20'+_0x3a1584);throw new Error('CoinToPay2\x20API\x20error:\x20'+_0x3a1584);}if(!_0x4decae['payment_url']||!_0x4decae[_0x4db337(0x216)]){console[_0x4db337(0x1ca)](_0x4db337(0x1cc)),console['error']('Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response'),console[_0x4db337(0x1ca)](_0x4db337(0x1f5),_0x4decae),loggerService_1[_0x4db337(0x1be)][_0x4db337(0x1c0)](_0x4db337(0x1f4),_0x4db337(0x1e3),_0x4db337(0x1af));throw new Error(_0x4db337(0x1b7));}return console[_0x4db337(0x222)](_0x4db337(0x213)),console[_0x4db337(0x222)]('Gateway\x20Payment\x20ID:',_0x4decae[_0x4db337(0x216)]),console['log'](_0x4db337(0x1c3),_0x4decae[_0x4db337(0x1d1)]),console['log'](_0x4db337(0x1cb),_0x59d717,_0x4db337(0x209)),{'gateway_payment_id':_0x4decae['gateway_payment_id'],'payment_url':_0x4decae[_0x4db337(0x1d1)]};}catch(_0x31715d){console[_0x4db337(0x1ca)](_0x4db337(0x20d)),console[_0x4db337(0x1ca)]('Error\x20details:',_0x31715d),loggerService_1[_0x4db337(0x1be)][_0x4db337(0x1c0)]('cointopay2',_0x4db337(0x1e3),_0x31715d);if(_0x31715d instanceof Error){console[_0x4db337(0x1ca)]('Error\x20message:',_0x31715d['message']),console[_0x4db337(0x1ca)]('Error\x20stack:',_0x31715d['stack']);throw new Error(_0x4db337(0x1e2)+_0x31715d['message']);}throw new Error(_0x4db337(0x21c));}}async['checkPaymentStatus'](_0xa16873){const _0x1eafb8=a42_0x39631e,_0x43aaa6=Date[_0x1eafb8(0x1ff)]();try{console['log'](_0x1eafb8(0x1b1)+_0xa16873);const _0x135f29={'gatewayPaymentId':_0xa16873};loggerService_1[_0x1eafb8(0x1be)][_0x1eafb8(0x203)]('cointopay2',_0x1eafb8(0x1c6),_0x1eafb8(0x1c9),_0x135f29);const _0x296a61=await fetch(this[_0x1eafb8(0x1cd)],{'method':'POST','headers':{'Content-Type':_0x1eafb8(0x1b4),'Accept':_0x1eafb8(0x1b4),'User-Agent':_0x1eafb8(0x1f7)},'body':JSON[_0x1eafb8(0x1c2)](_0x135f29)}),_0x1c3422=Date['now']()-_0x43aaa6;console[_0x1eafb8(0x222)](_0x1eafb8(0x1d5)),console[_0x1eafb8(0x222)](_0x1eafb8(0x22a),_0x296a61[_0x1eafb8(0x221)]),console[_0x1eafb8(0x222)](_0x1eafb8(0x1bd),_0x1c3422+'ms');if(!_0x296a61['ok']){const _0x102934=await _0x296a61[_0x1eafb8(0x1ef)]();console[_0x1eafb8(0x1ca)](_0x1eafb8(0x20f),_0x296a61['status']),console['error']('Response\x20Body:',_0x102934),loggerService_1[_0x1eafb8(0x1be)][_0x1eafb8(0x1fe)](_0x1eafb8(0x1f4),_0x1eafb8(0x1c6),_0x296a61[_0x1eafb8(0x221)],_0x102934,_0x1c3422),loggerService_1[_0x1eafb8(0x1be)][_0x1eafb8(0x1c0)]('cointopay2','/status',_0x1eafb8(0x1db)+_0x296a61['status']+':\x20'+_0x102934);throw new Error(_0x1eafb8(0x205)+_0x296a61['status']);}const _0x4fed85=await _0x296a61[_0x1eafb8(0x1ef)]();console[_0x1eafb8(0x222)](_0x1eafb8(0x1f6),_0x4fed85);let _0x1908f2;try{_0x1908f2=JSON[_0x1eafb8(0x1cf)](_0x4fed85);}catch(_0x59b3c8){console['error'](_0x1eafb8(0x228),_0x59b3c8),loggerService_1[_0x1eafb8(0x1be)][_0x1eafb8(0x1c0)](_0x1eafb8(0x1f4),_0x1eafb8(0x1c6),'JSON\x20Parse\x20Error:\x20'+_0x59b3c8);throw new Error(_0x1eafb8(0x20a)+_0x4fed85);}loggerService_1[_0x1eafb8(0x1be)]['logWhiteDomainResponse'](_0x1eafb8(0x1f4),_0x1eafb8(0x1c6),_0x296a61[_0x1eafb8(0x221)],_0x1908f2,_0x1c3422),console['log']('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console[_0x1eafb8(0x222)]('Result:',_0x1908f2[_0x1eafb8(0x1a9)]),console[_0x1eafb8(0x222)](_0x1eafb8(0x1d6),_0x1908f2['status_code']),console[_0x1eafb8(0x222)](_0x1eafb8(0x224),_0x1908f2['data']?.[_0x1eafb8(0x1fd)]),console[_0x1eafb8(0x222)](_0x1eafb8(0x1cb),_0x1908f2[_0x1eafb8(0x1fc)]?.[_0x1eafb8(0x229)]),console[_0x1eafb8(0x222)](_0x1eafb8(0x208),_0x1908f2['data']?.[_0x1eafb8(0x1ee)]);if(_0x1908f2[_0x1eafb8(0x1a9)]!==_0x1eafb8(0x223)||_0x1908f2[_0x1eafb8(0x1f8)]!==0xc8){const _0x1dbbbb=_0x1908f2[_0x1eafb8(0x21f)]||'Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API';console[_0x1eafb8(0x1ca)](_0x1eafb8(0x204)),console['error']('Error\x20Message:',_0x1dbbbb),loggerService_1['loggerService'][_0x1eafb8(0x1c0)](_0x1eafb8(0x1f4),_0x1eafb8(0x1c6),_0x1eafb8(0x227)+_0x1dbbbb);throw new Error(_0x1eafb8(0x1a5)+_0x1dbbbb);}if(!_0x1908f2[_0x1eafb8(0x1fc)]){console[_0x1eafb8(0x1ca)](_0x1eafb8(0x1f3)),console[_0x1eafb8(0x1ca)](_0x1eafb8(0x1f0)),loggerService_1['loggerService'][_0x1eafb8(0x1c0)](_0x1eafb8(0x1f4),_0x1eafb8(0x1c6),'Incomplete\x20response:\x20missing\x20data');throw new Error(_0x1eafb8(0x1f2));}let _0x55699b=_0x1eafb8(0x1ed);switch(_0x1908f2[_0x1eafb8(0x1fc)][_0x1eafb8(0x1fd)]?.['toLowerCase']()){case _0x1eafb8(0x1a6):_0x55699b='PAID';break;case _0x1eafb8(0x1dd):case'failed':case'error':_0x55699b=_0x1eafb8(0x20e);break;case _0x1eafb8(0x20c):case'timeout':_0x55699b=_0x1eafb8(0x1d2);break;case'waiting':case'awaiting\x20fiat':case _0x1eafb8(0x220):case _0x1eafb8(0x21a):default:_0x55699b='PENDING';break;}let _0x1a0db3,_0x534b83;if(_0x1908f2[_0x1eafb8(0x1fc)][_0x1eafb8(0x1d3)]){const _0x3b2471=_0x1908f2[_0x1eafb8(0x1fc)][_0x1eafb8(0x1d3)];console[_0x1eafb8(0x222)](_0x1eafb8(0x1e5),_0x3b2471);const _0x4349e5=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x35db6b of _0x4349e5){const _0x2d5050=_0x3b2471[_0x1eafb8(0x200)](_0x35db6b);if(_0x2d5050){_0x1a0db3=_0x2d5050[0x1],console[_0x1eafb8(0x222)](_0x1eafb8(0x225),_0x1a0db3,_0x1eafb8(0x1e0),_0x35db6b[_0x1eafb8(0x1aa)]);break;}}if(!_0x1a0db3){console[_0x1eafb8(0x222)]('‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...');const _0x57d81d=_0x3b2471[_0x1eafb8(0x200)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x57d81d&&(_0x1a0db3=_0x57d81d[0x1],console[_0x1eafb8(0x222)](_0x1eafb8(0x219),_0x1a0db3));}_0x534b83=_0x3b2471;}const _0x49a249={'iban':_0x1a0db3,'bankDetails':_0x534b83,'transactionId':_0x1908f2[_0x1eafb8(0x1fc)][_0x1eafb8(0x218)],'coinAddress':_0x1908f2[_0x1eafb8(0x1fc)][_0x1eafb8(0x1df)],'qrCodeUrl':_0x1908f2[_0x1eafb8(0x1fc)][_0x1eafb8(0x1a7)],'expiryTime':_0x1908f2['data']['ExpiryTime'],'createdOn':_0x1908f2['data'][_0x1eafb8(0x1e4)],'confirmedOn':_0x1908f2[_0x1eafb8(0x1fc)][_0x1eafb8(0x1b3)]};console[_0x1eafb8(0x222)](_0x1eafb8(0x1c4)),console['log'](_0x1eafb8(0x22a),_0x1908f2[_0x1eafb8(0x1fc)][_0x1eafb8(0x1fd)],'->',_0x55699b),console[_0x1eafb8(0x222)](_0x1eafb8(0x1cb),_0x1908f2[_0x1eafb8(0x1fc)][_0x1eafb8(0x229)],_0x1908f2['data'][_0x1eafb8(0x1ee)]),console[_0x1eafb8(0x222)](_0x1eafb8(0x1ad),_0x1908f2[_0x1eafb8(0x1fc)]['TransactionID']),console[_0x1eafb8(0x222)](_0x1eafb8(0x215),_0x1a0db3||_0x1eafb8(0x1b9)),console['log'](_0x1eafb8(0x1fb),_0x1908f2[_0x1eafb8(0x1fc)][_0x1eafb8(0x1e4)]),console['log']('Confirmed\x20On:',_0x1908f2['data'][_0x1eafb8(0x1b3)]||_0x1eafb8(0x1d4));if(_0x1908f2[_0x1eafb8(0x1fc)][_0x1eafb8(0x1fd)]?.['toLowerCase']()==='awaiting\x20fiat')console[_0x1eafb8(0x222)](_0x1eafb8(0x202));else _0x1908f2[_0x1eafb8(0x1fc)]['Status']?.[_0x1eafb8(0x1da)]()===_0x1eafb8(0x1a6)&&console[_0x1eafb8(0x222)](_0x1eafb8(0x217));return{'status':_0x55699b,'amount':parseFloat(_0x1908f2['data']['Amount'])||undefined,'currency':_0x1908f2[_0x1eafb8(0x1fc)][_0x1eafb8(0x1ee)]||_0x1eafb8(0x209),'paymentDetails':_0x49a249};}catch(_0x1b5591){console['error']('CoinToPay2\x20payment\x20status\x20check\x20error:',_0x1b5591),loggerService_1[_0x1eafb8(0x1be)][_0x1eafb8(0x1c0)](_0x1eafb8(0x1f4),_0x1eafb8(0x1c6),_0x1b5591);throw new Error('Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20'+(_0x1b5591 instanceof Error?_0x1b5591['message']:_0x1eafb8(0x1ce)));}}async[a42_0x39631e(0x1b5)](_0x525dcf){const _0x4c3920=a42_0x39631e,_0x408d95=await this[_0x4c3920(0x1d7)](_0x525dcf);return{'status':_0x408d95[_0x4c3920(0x221)],'amount':_0x408d95[_0x4c3920(0x1b2)],'currency':_0x408d95[_0x4c3920(0x1bc)]};}async[a42_0x39631e(0x22b)](_0x5c20ee){const _0x6b1b57=a42_0x39631e;console['log']('Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x5c20ee);let _0x168680=_0x6b1b57(0x1ed);switch(_0x5c20ee['status']?.[_0x6b1b57(0x1da)]()){case _0x6b1b57(0x1a6):_0x168680=_0x6b1b57(0x1eb);break;case _0x6b1b57(0x1dd):case _0x6b1b57(0x1d0):case _0x6b1b57(0x1ca):_0x168680=_0x6b1b57(0x20e);break;case'expired':case _0x6b1b57(0x1b8):_0x168680='EXPIRED';break;case _0x6b1b57(0x220):case _0x6b1b57(0x1c7):case _0x6b1b57(0x1bb):case _0x6b1b57(0x21a):default:_0x168680=_0x6b1b57(0x1ed);break;}return{'paymentId':_0x5c20ee[_0x6b1b57(0x1ba)]||_0x5c20ee['merchant_reference_id']||'','status':_0x168680,'amount':_0x5c20ee['amount'],'currency':_0x5c20ee[_0x6b1b57(0x1bc)]||_0x6b1b57(0x209)};}}exports['CoinToPay2Service']=CoinToPay2Service;