'use strict';const a43_0x3636dd=a43_0x3183;function a43_0x3183(_0x341d7e,_0x390216){const _0x43dd62=a43_0x43dd();return a43_0x3183=function(_0x318313,_0x5d6827){_0x318313=_0x318313-0xbc;let _0x2e5400=_0x43dd62[_0x318313];return _0x2e5400;},a43_0x3183(_0x341d7e,_0x390216);}function a43_0x43dd(){const _0x222c78=['2001720pGCLji','defineProperty',',\x20body:\x20','data','https://traffer.uk/gateway/cointopay/','91376BOYNRZ','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','PAID','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','checkPaymentStatus','awaiting\x20fiat','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','IBAN:','570729bDgrVx','gateway_payment_id','PENDING','not\x20confirmed','paid','CoinToPay2\x20payment\x20status\x20check\x20error:','1713970VYXXwK','expired','cancelled','inputCurrency','Amount:','source','match','156799CbmEPl','Confirmed\x20On:','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','log','TransactionID','amount','FAILED','text','__esModule','Unknown\x20error\x20from\x20CoinToPay2\x20API','Request\x20Body:','Response\x20data:','toLowerCase','Headers:','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','processWebhook','pending','4ArMtcW','application/json','parse','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','stack','waiting','JSON\x20Parse\x20Error:\x20','logWhiteDomainError','CoinToPay2Service','CoinToPay2\x20status\x20API\x20error:\x20','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','866368brzvxx','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','Payment\x20URL:','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','logWhiteDomainResponse','üè¶\x20Payment\x20Detail:','message','Error\x20details:','loggerService','failed','Created\x20On:','Error\x20Message:','headers','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','coinAddress','Result:','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','status_code','Unknown\x20error','statusText','PaymentDetail','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):','currency','Raw\x20Response\x20Body:','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','EUR','HTTP\x20error!\x20status:\x20','now','cointopay2','HTTP\x20','POST','using\x20pattern:','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','469542FkTJBv','createPaymentLink','Gateway\x20Payment\x20ID:','Status','===\x20COINTOPAY2\x20API\x20ERROR\x20===','CoinToPay2\x20API\x20error:\x20','EXPIRED','Failed\x20to\x20parse\x20JSON\x20response:','ExpiryTime','Status\x20Text:','error','Payment\x20Status:','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','\x20EUR','Error\x20stack:','timeout','status','Amount','statusUrl','TransactionConfirmedOn','apiUrl','/create','üìä\x20Status\x20check\x20URL:','/status','QRCodeURL','81TUlUKa','Response\x20Time:','===\x20COINTOPAY2\x20SUCCESS\x20===','URL:','Status:','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','stringify','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','result','logWhiteDomainRequest','Currency:','payment_url'];a43_0x43dd=function(){return _0x222c78;};return a43_0x43dd();}(function(_0x4b7051,_0x5a094b){const _0x587e08=a43_0x3183,_0xd4394f=_0x4b7051();while(!![]){try{const _0x3c4700=-parseInt(_0x587e08(0x139))/0x1+-parseInt(_0x587e08(0xcb))/0x2*(-parseInt(_0x587e08(0x12c))/0x3)+parseInt(_0x587e08(0xd6))/0x4+-parseInt(_0x587e08(0x132))/0x5+-parseInt(_0x587e08(0xf9))/0x6+parseInt(_0x587e08(0x11f))/0x7+-parseInt(_0x587e08(0x124))/0x8*(parseInt(_0x587e08(0x112))/0x9);if(_0x3c4700===_0x5a094b)break;else _0xd4394f['push'](_0xd4394f['shift']());}catch(_0x58ea50){_0xd4394f['push'](_0xd4394f['shift']());}}}(a43_0x43dd,0x31696));Object[a43_0x3636dd(0x120)](exports,a43_0x3636dd(0xc2),{'value':!![]}),exports[a43_0x3636dd(0xd3)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x1d2d96=a43_0x3636dd;this[_0x1d2d96(0x10d)]=_0x1d2d96(0x123),this[_0x1d2d96(0x10b)]='https://traffer.uk/gateway/cointopay/status.php',console[_0x1d2d96(0xbd)](_0x1d2d96(0x105)),console[_0x1d2d96(0xbd)](_0x1d2d96(0x10f),this[_0x1d2d96(0x10b)]);}async[a43_0x3636dd(0xfa)](_0x3064cf){const _0x570d1e=a43_0x3636dd,{orderId:_0x433fc7,amount:_0x4e42c7}=_0x3064cf;console['log'](_0x570d1e(0xd9)+_0x4e42c7+_0x570d1e(0x106));const _0x38b27c={'amount':_0x4e42c7},_0x52290e=Date[_0x570d1e(0xf3)]();try{console[_0x570d1e(0xbd)](_0x570d1e(0xe3)),console[_0x570d1e(0xbd)](_0x570d1e(0x115),this[_0x570d1e(0x10d)]),console[_0x570d1e(0xbd)](_0x570d1e(0xc4),JSON['stringify'](_0x38b27c,null,0x2)),console[_0x570d1e(0xbd)](_0x570d1e(0x136),_0x4e42c7,_0x570d1e(0xe6)),loggerService_1[_0x570d1e(0xde)][_0x570d1e(0x11c)]('cointopay2',_0x570d1e(0x10e),_0x570d1e(0xf6),_0x38b27c);const _0x5cfd5a=await fetch(this[_0x570d1e(0x10d)],{'method':_0x570d1e(0xf6),'headers':{'Content-Type':_0x570d1e(0xcc),'Accept':_0x570d1e(0xcc),'User-Agent':_0x570d1e(0xd5)},'body':JSON[_0x570d1e(0x118)](_0x38b27c)}),_0x1082b5=Date['now']()-_0x52290e;console[_0x570d1e(0xbd)](_0x570d1e(0xeb)),console[_0x570d1e(0xbd)](_0x570d1e(0x116),_0x5cfd5a['status']),console[_0x570d1e(0xbd)](_0x570d1e(0x102),_0x5cfd5a[_0x570d1e(0xe9)]),console['log'](_0x570d1e(0xc7),Object['fromEntries'](_0x5cfd5a[_0x570d1e(0xe2)]['entries']())),console['log'](_0x570d1e(0x113),_0x1082b5+'ms');const _0x359b00=await _0x5cfd5a[_0x570d1e(0xc1)]();console[_0x570d1e(0xbd)](_0x570d1e(0xee),_0x359b00);if(!_0x5cfd5a['ok']){console['error'](_0x570d1e(0xfd)),console[_0x570d1e(0x103)]('HTTP\x20Status:',_0x5cfd5a['status']),console['error']('Response\x20Body:',_0x359b00),loggerService_1[_0x570d1e(0xde)][_0x570d1e(0xda)](_0x570d1e(0xf4),'/create',_0x5cfd5a[_0x570d1e(0x109)],_0x359b00,_0x1082b5),loggerService_1[_0x570d1e(0xde)][_0x570d1e(0xd2)](_0x570d1e(0xf4),'/create',_0x570d1e(0xf5)+_0x5cfd5a[_0x570d1e(0x109)]+':\x20'+_0x359b00);throw new Error(_0x570d1e(0xf2)+_0x5cfd5a[_0x570d1e(0x109)]+_0x570d1e(0x121)+_0x359b00);}let _0x27c8e2;try{_0x27c8e2=JSON[_0x570d1e(0xcd)](_0x359b00);}catch(_0x27463e){console['error'](_0x570d1e(0x100),_0x27463e),loggerService_1['loggerService'][_0x570d1e(0xd2)](_0x570d1e(0xf4),'/create',_0x570d1e(0xd1)+_0x27463e);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20'+_0x359b00);}console[_0x570d1e(0xbd)]('===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20==='),console['log']('Parsed\x20Result:',JSON[_0x570d1e(0x118)](_0x27c8e2,null,0x2)),loggerService_1[_0x570d1e(0xde)][_0x570d1e(0xda)](_0x570d1e(0xf4),_0x570d1e(0x10e),_0x5cfd5a[_0x570d1e(0x109)],_0x27c8e2,_0x1082b5);if(_0x27c8e2['error']){const _0x5293df=_0x27c8e2[_0x570d1e(0xdc)]||_0x27c8e2['error']||_0x570d1e(0xc3);console[_0x570d1e(0x103)](_0x570d1e(0x12a)),console[_0x570d1e(0x103)]('Error\x20Message:',_0x5293df),loggerService_1[_0x570d1e(0xde)][_0x570d1e(0xd2)](_0x570d1e(0xf4),_0x570d1e(0x10e),'Business\x20Error:\x20'+_0x5293df);throw new Error(_0x570d1e(0xfe)+_0x5293df);}if(!_0x27c8e2['payment_url']||!_0x27c8e2[_0x570d1e(0x12d)]){console[_0x570d1e(0x103)](_0x570d1e(0xf8)),console[_0x570d1e(0x103)](_0x570d1e(0x11a)),console[_0x570d1e(0x103)](_0x570d1e(0xc5),_0x27c8e2),loggerService_1[_0x570d1e(0xde)][_0x570d1e(0xd2)](_0x570d1e(0xf4),'/create','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id');}return console[_0x570d1e(0xbd)](_0x570d1e(0x114)),console[_0x570d1e(0xbd)](_0x570d1e(0xfb),_0x27c8e2[_0x570d1e(0x12d)]),console['log'](_0x570d1e(0xd8),_0x27c8e2[_0x570d1e(0x11e)]),console[_0x570d1e(0xbd)](_0x570d1e(0x136),_0x4e42c7,_0x570d1e(0xf1)),{'gateway_payment_id':_0x27c8e2[_0x570d1e(0x12d)],'payment_url':_0x27c8e2[_0x570d1e(0x11e)]};}catch(_0x5e4f47){console['error'](_0x570d1e(0xbc)),console[_0x570d1e(0x103)](_0x570d1e(0xdd),_0x5e4f47),loggerService_1[_0x570d1e(0xde)][_0x570d1e(0xd2)](_0x570d1e(0xf4),_0x570d1e(0x10e),_0x5e4f47);if(_0x5e4f47 instanceof Error){console[_0x570d1e(0x103)]('Error\x20message:',_0x5e4f47[_0x570d1e(0xdc)]),console[_0x570d1e(0x103)](_0x570d1e(0x107),_0x5e4f47[_0x570d1e(0xcf)]);throw new Error(_0x570d1e(0x127)+_0x5e4f47[_0x570d1e(0xdc)]);}throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error');}}async[a43_0x3636dd(0x128)](_0x42c53d){const _0x763c5b=a43_0x3636dd,_0x4401c5=Date[_0x763c5b(0xf3)]();try{console[_0x763c5b(0xbd)](_0x763c5b(0x125)+_0x42c53d);const _0x5849cd={'gatewayPaymentId':_0x42c53d};loggerService_1['loggerService']['logWhiteDomainRequest'](_0x763c5b(0xf4),'/status',_0x763c5b(0xf6),_0x5849cd);const _0x16bf43=await fetch(this[_0x763c5b(0x10b)],{'method':_0x763c5b(0xf6),'headers':{'Content-Type':_0x763c5b(0xcc),'Accept':'application/json','User-Agent':_0x763c5b(0xd5)},'body':JSON[_0x763c5b(0x118)](_0x5849cd)}),_0x3922ed=Date['now']()-_0x4401c5;console[_0x763c5b(0xbd)](_0x763c5b(0xce)),console['log']('Status:',_0x16bf43['status']),console[_0x763c5b(0xbd)](_0x763c5b(0x113),_0x3922ed+'ms');if(!_0x16bf43['ok']){const _0x1e9ec6=await _0x16bf43[_0x763c5b(0xc1)]();console[_0x763c5b(0x103)]('HTTP\x20Status:',_0x16bf43[_0x763c5b(0x109)]),console[_0x763c5b(0x103)]('Response\x20Body:',_0x1e9ec6),loggerService_1[_0x763c5b(0xde)][_0x763c5b(0xda)](_0x763c5b(0xf4),_0x763c5b(0x110),_0x16bf43['status'],_0x1e9ec6,_0x3922ed),loggerService_1[_0x763c5b(0xde)][_0x763c5b(0xd2)]('cointopay2',_0x763c5b(0x110),'HTTP\x20'+_0x16bf43['status']+':\x20'+_0x1e9ec6);throw new Error(_0x763c5b(0xf2)+_0x16bf43[_0x763c5b(0x109)]);}const _0x10fab4=await _0x16bf43[_0x763c5b(0xc1)]();console[_0x763c5b(0xbd)]('Raw\x20Response\x20Body:',_0x10fab4);let _0x4e9906;try{_0x4e9906=JSON[_0x763c5b(0xcd)](_0x10fab4);}catch(_0x4faeb8){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0x4faeb8),loggerService_1[_0x763c5b(0xde)][_0x763c5b(0xd2)]('cointopay2','/status','JSON\x20Parse\x20Error:\x20'+_0x4faeb8);throw new Error(_0x763c5b(0x119)+_0x10fab4);}loggerService_1[_0x763c5b(0xde)]['logWhiteDomainResponse'](_0x763c5b(0xf4),'/status',_0x16bf43['status'],_0x4e9906,_0x3922ed),console[_0x763c5b(0xbd)]('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console['log'](_0x763c5b(0xe5),_0x4e9906[_0x763c5b(0x11b)]),console['log']('Status\x20Code:',_0x4e9906['status_code']),console[_0x763c5b(0xbd)](_0x763c5b(0x104),_0x4e9906[_0x763c5b(0x122)]?.[_0x763c5b(0xfc)]),console[_0x763c5b(0xbd)](_0x763c5b(0x136),_0x4e9906[_0x763c5b(0x122)]?.[_0x763c5b(0x10a)]),console[_0x763c5b(0xbd)](_0x763c5b(0x11d),_0x4e9906[_0x763c5b(0x122)]?.[_0x763c5b(0x135)]);if(_0x4e9906[_0x763c5b(0x11b)]!=='success'||_0x4e9906[_0x763c5b(0xe7)]!==0xc8){const _0x3d3d2d=_0x4e9906[_0x763c5b(0xdc)]||_0x763c5b(0xf0);console[_0x763c5b(0x103)](_0x763c5b(0xc8)),console[_0x763c5b(0x103)](_0x763c5b(0xe1),_0x3d3d2d),loggerService_1[_0x763c5b(0xde)][_0x763c5b(0xd2)](_0x763c5b(0xf4),'/status','Status\x20API\x20Error:\x20'+_0x3d3d2d);throw new Error(_0x763c5b(0xd4)+_0x3d3d2d);}if(!_0x4e9906[_0x763c5b(0x122)]){console[_0x763c5b(0x103)](_0x763c5b(0x117)),console[_0x763c5b(0x103)]('Missing\x20data\x20in\x20response'),loggerService_1['loggerService'][_0x763c5b(0xd2)](_0x763c5b(0xf4),_0x763c5b(0x110),'Incomplete\x20response:\x20missing\x20data');throw new Error(_0x763c5b(0xef));}let _0x2c46a0=_0x763c5b(0x12e);switch(_0x4e9906[_0x763c5b(0x122)]['Status']?.[_0x763c5b(0xc6)]()){case _0x763c5b(0x130):_0x2c46a0=_0x763c5b(0x126);break;case'cancelled':case _0x763c5b(0xdf):case _0x763c5b(0x103):_0x2c46a0='FAILED';break;case'expired':case'timeout':_0x2c46a0=_0x763c5b(0xff);break;case _0x763c5b(0xd0):case _0x763c5b(0x129):case _0x763c5b(0xca):case'created':default:_0x2c46a0=_0x763c5b(0x12e);break;}let _0x54b770,_0x25565c;if(_0x4e9906[_0x763c5b(0x122)][_0x763c5b(0xea)]){const _0x68eab1=_0x4e9906[_0x763c5b(0x122)][_0x763c5b(0xea)];console['log'](_0x763c5b(0xdb),_0x68eab1);const _0x96548d=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x50be52 of _0x96548d){const _0x59dfdc=_0x68eab1[_0x763c5b(0x138)](_0x50be52);if(_0x59dfdc){_0x54b770=_0x59dfdc[0x1],console[_0x763c5b(0xbd)]('üè¶\x20Extracted\x20IBAN:',_0x54b770,_0x763c5b(0xf7),_0x50be52[_0x763c5b(0x137)]);break;}}if(!_0x54b770){console[_0x763c5b(0xbd)]('‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...');const _0xc5dfda=_0x68eab1[_0x763c5b(0x138)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0xc5dfda&&(_0x54b770=_0xc5dfda[0x1],console[_0x763c5b(0xbd)]('üè¶\x20Extracted\x20IBAN\x20via\x20fallback:',_0x54b770));}_0x25565c=_0x68eab1;}const _0x506141={'iban':_0x54b770,'bankDetails':_0x25565c,'transactionId':_0x4e9906[_0x763c5b(0x122)]['TransactionID'],'coinAddress':_0x4e9906[_0x763c5b(0x122)][_0x763c5b(0xe4)],'qrCodeUrl':_0x4e9906[_0x763c5b(0x122)][_0x763c5b(0x111)],'expiryTime':_0x4e9906['data'][_0x763c5b(0x101)],'createdOn':_0x4e9906[_0x763c5b(0x122)]['CreatedOn'],'confirmedOn':_0x4e9906[_0x763c5b(0x122)][_0x763c5b(0x10c)]};console[_0x763c5b(0xbd)]('===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20==='),console['log']('Status:',_0x4e9906[_0x763c5b(0x122)]['Status'],'->',_0x2c46a0),console[_0x763c5b(0xbd)](_0x763c5b(0x136),_0x4e9906[_0x763c5b(0x122)][_0x763c5b(0x10a)],_0x4e9906['data'][_0x763c5b(0x135)]),console[_0x763c5b(0xbd)]('Transaction\x20ID:',_0x4e9906[_0x763c5b(0x122)][_0x763c5b(0xbe)]),console[_0x763c5b(0xbd)](_0x763c5b(0x12b),_0x54b770||'not\x20found'),console[_0x763c5b(0xbd)](_0x763c5b(0xe0),_0x4e9906[_0x763c5b(0x122)]['CreatedOn']),console[_0x763c5b(0xbd)](_0x763c5b(0x13a),_0x4e9906['data'][_0x763c5b(0x10c)]||_0x763c5b(0x12f));if(_0x4e9906['data'][_0x763c5b(0xfc)]?.[_0x763c5b(0xc6)]()===_0x763c5b(0x129))console['log']('üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)');else _0x4e9906[_0x763c5b(0x122)][_0x763c5b(0xfc)]?.[_0x763c5b(0xc6)]()===_0x763c5b(0x130)&&console[_0x763c5b(0xbd)](_0x763c5b(0xd7));return{'status':_0x2c46a0,'amount':parseFloat(_0x4e9906[_0x763c5b(0x122)][_0x763c5b(0x10a)])||undefined,'currency':_0x4e9906[_0x763c5b(0x122)][_0x763c5b(0x135)]||_0x763c5b(0xf1),'paymentDetails':_0x506141};}catch(_0x34d35b){console['error'](_0x763c5b(0x131),_0x34d35b),loggerService_1['loggerService'][_0x763c5b(0xd2)](_0x763c5b(0xf4),_0x763c5b(0x110),_0x34d35b);throw new Error('Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20'+(_0x34d35b instanceof Error?_0x34d35b['message']:_0x763c5b(0xe8)));}}async['verifyPayment'](_0x50077d){const _0x35e43e=a43_0x3636dd,_0x32b3d5=await this['checkPaymentStatus'](_0x50077d);return{'status':_0x32b3d5[_0x35e43e(0x109)],'amount':_0x32b3d5[_0x35e43e(0xbf)],'currency':_0x32b3d5[_0x35e43e(0xed)]};}async[a43_0x3636dd(0xc9)](_0x306fcc){const _0x1d4712=a43_0x3636dd;console[_0x1d4712(0xbd)](_0x1d4712(0xec),_0x306fcc);let _0x57634d='PENDING';switch(_0x306fcc['status']?.[_0x1d4712(0xc6)]()){case _0x1d4712(0x130):_0x57634d=_0x1d4712(0x126);break;case _0x1d4712(0x134):case'failed':case _0x1d4712(0x103):_0x57634d=_0x1d4712(0xc0);break;case _0x1d4712(0x133):case _0x1d4712(0x108):_0x57634d=_0x1d4712(0xff);break;case _0x1d4712(0xca):case'waiting':case'awaiting\x20fiat':case'created':default:_0x57634d=_0x1d4712(0x12e);break;}return{'paymentId':_0x306fcc['order_id']||_0x306fcc['merchant_reference_id']||'','status':_0x57634d,'amount':_0x306fcc[_0x1d4712(0xbf)],'currency':_0x306fcc[_0x1d4712(0xed)]||_0x1d4712(0xf1)};}}exports['CoinToPay2Service']=CoinToPay2Service;