'use strict';const a46_0x463279=a46_0x5200;function a46_0x5200(_0x205bb3,_0x49b58a){const _0x56a0a8=a46_0x56a0();return a46_0x5200=function(_0x5200c6,_0x30ff1c){_0x5200c6=_0x5200c6-0x173;let _0x69abaa=_0x56a0a8[_0x5200c6];return _0x69abaa;},a46_0x5200(_0x205bb3,_0x49b58a);}(function(_0x11f064,_0xfc28fa){const _0x27b806=a46_0x5200,_0x37b125=_0x11f064();while(!![]){try{const _0x5ded86=-parseInt(_0x27b806(0x1ef))/0x1+-parseInt(_0x27b806(0x1e1))/0x2+parseInt(_0x27b806(0x1f0))/0x3*(-parseInt(_0x27b806(0x1ea))/0x4)+-parseInt(_0x27b806(0x1d1))/0x5*(-parseInt(_0x27b806(0x1b9))/0x6)+parseInt(_0x27b806(0x17d))/0x7+-parseInt(_0x27b806(0x1ed))/0x8*(-parseInt(_0x27b806(0x1a8))/0x9)+-parseInt(_0x27b806(0x182))/0xa*(-parseInt(_0x27b806(0x1f3))/0xb);if(_0x5ded86===_0xfc28fa)break;else _0x37b125['push'](_0x37b125['shift']());}catch(_0x1e161a){_0x37b125['push'](_0x37b125['shift']());}}}(a46_0x56a0,0x5e011));Object[a46_0x463279(0x185)](exports,a46_0x463279(0x1c1),{'value':!![]}),exports[a46_0x463279(0x19e)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x39198a=a46_0x463279;this['apiUrl']='https://traffer.uk/gateway/cointopay/',this[_0x39198a(0x1b0)]=_0x39198a(0x1d0),console['log'](_0x39198a(0x1aa)),console['log']('📊\x20Status\x20check\x20URL:',this[_0x39198a(0x1b0)]);}async['createPaymentLink'](_0x2649ab){const _0x2e9723=a46_0x463279,{orderId:_0x23f4dd,amount:_0x54f159}=_0x2649ab;console[_0x2e9723(0x189)](_0x2e9723(0x1a9)+_0x54f159+'\x20EUR');const _0x283cd1={'amount':_0x54f159},_0x1e28f8=Date[_0x2e9723(0x1b6)]();try{console[_0x2e9723(0x189)](_0x2e9723(0x192)),console[_0x2e9723(0x189)](_0x2e9723(0x197),this[_0x2e9723(0x194)]),console[_0x2e9723(0x189)](_0x2e9723(0x1d2),JSON['stringify'](_0x283cd1,null,0x2)),console[_0x2e9723(0x189)]('Amount:',_0x54f159,_0x2e9723(0x1bb)),loggerService_1[_0x2e9723(0x1e8)]['logWhiteDomainRequest']('cointopay2',_0x2e9723(0x1c6),_0x2e9723(0x1be),_0x283cd1);const _0x199b20=await fetch(this['apiUrl'],{'method':_0x2e9723(0x1be),'headers':{'Content-Type':_0x2e9723(0x18d),'Accept':_0x2e9723(0x18d),'User-Agent':_0x2e9723(0x1e3)},'body':JSON[_0x2e9723(0x1b7)](_0x283cd1)}),_0x4ef749=Date[_0x2e9723(0x1b6)]()-_0x1e28f8;console[_0x2e9723(0x189)](_0x2e9723(0x1a1)),console[_0x2e9723(0x189)](_0x2e9723(0x1c0),_0x199b20[_0x2e9723(0x1d5)]),console[_0x2e9723(0x189)](_0x2e9723(0x1ce),_0x199b20['statusText']),console[_0x2e9723(0x189)](_0x2e9723(0x1d9),Object['fromEntries'](_0x199b20[_0x2e9723(0x17c)][_0x2e9723(0x1ad)]())),console['log'](_0x2e9723(0x1ae),_0x4ef749+'ms');const _0x3e4bf1=await _0x199b20[_0x2e9723(0x17a)]();console['log'](_0x2e9723(0x186),_0x3e4bf1);if(!_0x199b20['ok']){console[_0x2e9723(0x1cd)](_0x2e9723(0x1c9)),console[_0x2e9723(0x1cd)](_0x2e9723(0x1e9),_0x199b20['status']),console[_0x2e9723(0x1cd)]('Response\x20Body:',_0x3e4bf1),loggerService_1['loggerService'][_0x2e9723(0x1d8)](_0x2e9723(0x1c5),_0x2e9723(0x1c6),_0x199b20['status'],_0x3e4bf1,_0x4ef749),loggerService_1[_0x2e9723(0x1e8)][_0x2e9723(0x19b)]('cointopay2',_0x2e9723(0x1c6),'HTTP\x20'+_0x199b20['status']+':\x20'+_0x3e4bf1);throw new Error(_0x2e9723(0x1d3)+_0x199b20[_0x2e9723(0x1d5)]+_0x2e9723(0x1cf)+_0x3e4bf1);}let _0x1ff8ca;try{_0x1ff8ca=JSON[_0x2e9723(0x199)](_0x3e4bf1);}catch(_0x4dd7c5){console[_0x2e9723(0x1cd)](_0x2e9723(0x179),_0x4dd7c5),loggerService_1[_0x2e9723(0x1e8)][_0x2e9723(0x19b)]('cointopay2',_0x2e9723(0x1c6),_0x2e9723(0x1bd)+_0x4dd7c5);throw new Error(_0x2e9723(0x176)+_0x3e4bf1);}console[_0x2e9723(0x189)]('===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20==='),console['log']('Parsed\x20Result:',JSON[_0x2e9723(0x1b7)](_0x1ff8ca,null,0x2)),loggerService_1['loggerService'][_0x2e9723(0x1d8)](_0x2e9723(0x1c5),_0x2e9723(0x1c6),_0x199b20['status'],_0x1ff8ca,_0x4ef749);if(_0x1ff8ca['error']){const _0x5e91ba=_0x1ff8ca[_0x2e9723(0x19c)]||_0x1ff8ca[_0x2e9723(0x1cd)]||_0x2e9723(0x1e5);console[_0x2e9723(0x1cd)](_0x2e9723(0x1b8)),console[_0x2e9723(0x1cd)](_0x2e9723(0x187),_0x5e91ba),loggerService_1[_0x2e9723(0x1e8)][_0x2e9723(0x19b)](_0x2e9723(0x1c5),'/create',_0x2e9723(0x195)+_0x5e91ba);throw new Error(_0x2e9723(0x183)+_0x5e91ba);}if(!_0x1ff8ca[_0x2e9723(0x175)]||!_0x1ff8ca[_0x2e9723(0x1a7)]){console['error'](_0x2e9723(0x1d4)),console[_0x2e9723(0x1cd)](_0x2e9723(0x1a2)),console[_0x2e9723(0x1cd)](_0x2e9723(0x191),_0x1ff8ca),loggerService_1[_0x2e9723(0x1e8)]['logWhiteDomainError'](_0x2e9723(0x1c5),_0x2e9723(0x1c6),_0x2e9723(0x1a0));throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id');}return console[_0x2e9723(0x189)]('===\x20COINTOPAY2\x20SUCCESS\x20==='),console[_0x2e9723(0x189)]('Gateway\x20Payment\x20ID:',_0x1ff8ca[_0x2e9723(0x1a7)]),console[_0x2e9723(0x189)](_0x2e9723(0x1b3),_0x1ff8ca['payment_url']),console[_0x2e9723(0x189)]('Amount:',_0x54f159,_0x2e9723(0x19f)),{'gateway_payment_id':_0x1ff8ca['gateway_payment_id'],'payment_url':_0x1ff8ca[_0x2e9723(0x175)]};}catch(_0x4911da){console[_0x2e9723(0x1cd)](_0x2e9723(0x184)),console['error'](_0x2e9723(0x18b),_0x4911da),loggerService_1[_0x2e9723(0x1e8)]['logWhiteDomainError'](_0x2e9723(0x1c5),'/create',_0x4911da);if(_0x4911da instanceof Error){console[_0x2e9723(0x1cd)]('Error\x20message:',_0x4911da[_0x2e9723(0x19c)]),console[_0x2e9723(0x1cd)](_0x2e9723(0x1eb),_0x4911da[_0x2e9723(0x18f)]);throw new Error(_0x2e9723(0x1d6)+_0x4911da[_0x2e9723(0x19c)]);}throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error');}}async['checkPaymentStatus'](_0x2cc4cc){const _0x39c525=a46_0x463279,_0x591bd5=Date[_0x39c525(0x1b6)]();try{console['log'](_0x39c525(0x17f)+_0x2cc4cc);const _0x249ff0={'gatewayPaymentId':_0x2cc4cc};loggerService_1[_0x39c525(0x1e8)][_0x39c525(0x177)](_0x39c525(0x1c5),_0x39c525(0x1a4),_0x39c525(0x1be),_0x249ff0);const _0x3f3179=await fetch(this['statusUrl'],{'method':'POST','headers':{'Content-Type':_0x39c525(0x18d),'Accept':_0x39c525(0x18d),'User-Agent':_0x39c525(0x1e3)},'body':JSON[_0x39c525(0x1b7)](_0x249ff0)}),_0x2ef5fe=Date[_0x39c525(0x1b6)]()-_0x591bd5;console[_0x39c525(0x189)](_0x39c525(0x1b4)),console['log'](_0x39c525(0x1c0),_0x3f3179[_0x39c525(0x1d5)]),console[_0x39c525(0x189)]('Response\x20Time:',_0x2ef5fe+'ms');if(!_0x3f3179['ok']){const _0x1967ee=await _0x3f3179[_0x39c525(0x17a)]();console['error']('HTTP\x20Status:',_0x3f3179['status']),console[_0x39c525(0x1cd)]('Response\x20Body:',_0x1967ee),loggerService_1['loggerService'][_0x39c525(0x1d8)](_0x39c525(0x1c5),_0x39c525(0x1a4),_0x3f3179[_0x39c525(0x1d5)],_0x1967ee,_0x2ef5fe),loggerService_1[_0x39c525(0x1e8)][_0x39c525(0x19b)](_0x39c525(0x1c5),'/status','HTTP\x20'+_0x3f3179[_0x39c525(0x1d5)]+':\x20'+_0x1967ee);throw new Error(_0x39c525(0x1d3)+_0x3f3179['status']);}const _0x405439=await _0x3f3179[_0x39c525(0x17a)]();console[_0x39c525(0x189)](_0x39c525(0x186),_0x405439);let _0x537d89;try{_0x537d89=JSON[_0x39c525(0x199)](_0x405439);}catch(_0x16205a){console[_0x39c525(0x1cd)](_0x39c525(0x179),_0x16205a),loggerService_1[_0x39c525(0x1e8)][_0x39c525(0x19b)](_0x39c525(0x1c5),'/status',_0x39c525(0x1bd)+_0x16205a);throw new Error('Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20'+_0x405439);}loggerService_1[_0x39c525(0x1e8)][_0x39c525(0x1d8)](_0x39c525(0x1c5),_0x39c525(0x1a4),_0x3f3179['status'],_0x537d89,_0x2ef5fe),console[_0x39c525(0x189)](_0x39c525(0x1e4)),console[_0x39c525(0x189)](_0x39c525(0x193),_0x537d89[_0x39c525(0x1b2)]),console[_0x39c525(0x189)](_0x39c525(0x1ee),_0x537d89[_0x39c525(0x1e0)]),console[_0x39c525(0x189)](_0x39c525(0x1ec),_0x537d89['data']?.[_0x39c525(0x19d)]),console[_0x39c525(0x189)](_0x39c525(0x17e),_0x537d89[_0x39c525(0x1bf)]?.[_0x39c525(0x1da)]),console[_0x39c525(0x189)](_0x39c525(0x1cc),_0x537d89['data']?.[_0x39c525(0x1d7)]);if(_0x537d89[_0x39c525(0x1b2)]!==_0x39c525(0x1a6)||_0x537d89[_0x39c525(0x1e0)]!==0xc8){const _0x3ebec1=_0x537d89[_0x39c525(0x19c)]||'Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API';console[_0x39c525(0x1cd)](_0x39c525(0x190)),console[_0x39c525(0x1cd)](_0x39c525(0x187),_0x3ebec1),loggerService_1['loggerService']['logWhiteDomainError'](_0x39c525(0x1c5),_0x39c525(0x1a4),_0x39c525(0x1df)+_0x3ebec1);throw new Error(_0x39c525(0x1c2)+_0x3ebec1);}if(!_0x537d89[_0x39c525(0x1bf)]){console[_0x39c525(0x1cd)]('===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console['error']('Missing\x20data\x20in\x20response'),loggerService_1[_0x39c525(0x1e8)][_0x39c525(0x19b)](_0x39c525(0x1c5),_0x39c525(0x1a4),'Incomplete\x20response:\x20missing\x20data');throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data');}let _0x18bd5a=_0x39c525(0x174);switch(_0x537d89[_0x39c525(0x1bf)][_0x39c525(0x19d)]?.[_0x39c525(0x181)]()){case _0x39c525(0x198):_0x18bd5a=_0x39c525(0x1de);break;case _0x39c525(0x1e7):case'failed':case'error':_0x18bd5a=_0x39c525(0x1ba);break;case _0x39c525(0x196):case'timeout':_0x18bd5a=_0x39c525(0x1c4);break;case _0x39c525(0x1c3):case _0x39c525(0x1cb):case'pending':case _0x39c525(0x1ac):default:_0x18bd5a=_0x39c525(0x174);break;}let _0x598ec3,_0x20f0d8;if(_0x537d89[_0x39c525(0x1bf)][_0x39c525(0x188)]){const _0xdde77d=_0x537d89[_0x39c525(0x1bf)][_0x39c525(0x188)];console[_0x39c525(0x189)](_0x39c525(0x18a),_0xdde77d);const _0x1172d4=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0xee82a4 of _0x1172d4){const _0x566320=_0xdde77d[_0x39c525(0x17b)](_0xee82a4);if(_0x566320){_0x598ec3=_0x566320[0x1],console[_0x39c525(0x189)](_0x39c525(0x1b1),_0x598ec3,_0x39c525(0x1c7),_0xee82a4[_0x39c525(0x1dc)]);break;}}if(!_0x598ec3){console[_0x39c525(0x189)](_0x39c525(0x1f1));const _0x72a277=_0xdde77d[_0x39c525(0x17b)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x72a277&&(_0x598ec3=_0x72a277[0x1],console['log'](_0x39c525(0x1e2),_0x598ec3));}_0x20f0d8=_0xdde77d;}const _0x489d4e={'iban':_0x598ec3,'bankDetails':_0x20f0d8,'transactionId':_0x537d89[_0x39c525(0x1bf)][_0x39c525(0x1c8)],'coinAddress':_0x537d89[_0x39c525(0x1bf)]['coinAddress'],'qrCodeUrl':_0x537d89[_0x39c525(0x1bf)]['QRCodeURL'],'expiryTime':_0x537d89[_0x39c525(0x1bf)]['ExpiryTime'],'createdOn':_0x537d89[_0x39c525(0x1bf)]['CreatedOn'],'confirmedOn':_0x537d89[_0x39c525(0x1bf)][_0x39c525(0x1dd)]};console[_0x39c525(0x189)](_0x39c525(0x18c)),console[_0x39c525(0x189)]('Status:',_0x537d89['data'][_0x39c525(0x19d)],'->',_0x18bd5a),console[_0x39c525(0x189)](_0x39c525(0x17e),_0x537d89[_0x39c525(0x1bf)][_0x39c525(0x1da)],_0x537d89['data'][_0x39c525(0x1d7)]),console[_0x39c525(0x189)]('Transaction\x20ID:',_0x537d89[_0x39c525(0x1bf)]['TransactionID']),console[_0x39c525(0x189)]('IBAN:',_0x598ec3||'not\x20found'),console[_0x39c525(0x189)](_0x39c525(0x173),_0x537d89[_0x39c525(0x1bf)][_0x39c525(0x1ab)]),console['log'](_0x39c525(0x1a3),_0x537d89[_0x39c525(0x1bf)][_0x39c525(0x1dd)]||'not\x20confirmed');if(_0x537d89[_0x39c525(0x1bf)][_0x39c525(0x19d)]?.[_0x39c525(0x181)]()==='awaiting\x20fiat')console[_0x39c525(0x189)](_0x39c525(0x1b5));else _0x537d89[_0x39c525(0x1bf)][_0x39c525(0x19d)]?.[_0x39c525(0x181)]()===_0x39c525(0x198)&&console[_0x39c525(0x189)]('✅\x20\x22Paid\x22\x20mapped\x20to\x20PAID');return{'status':_0x18bd5a,'amount':parseFloat(_0x537d89[_0x39c525(0x1bf)][_0x39c525(0x1da)])||undefined,'currency':_0x537d89[_0x39c525(0x1bf)][_0x39c525(0x1d7)]||_0x39c525(0x19f),'paymentDetails':_0x489d4e};}catch(_0x4eebd7){console['error'](_0x39c525(0x1ca),_0x4eebd7),loggerService_1[_0x39c525(0x1e8)][_0x39c525(0x19b)](_0x39c525(0x1c5),_0x39c525(0x1a4),_0x4eebd7);throw new Error('Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20'+(_0x4eebd7 instanceof Error?_0x4eebd7[_0x39c525(0x19c)]:_0x39c525(0x18e)));}}async[a46_0x463279(0x19a)](_0x2e1c69){const _0x2897ae=a46_0x463279,_0x50fbd7=await this[_0x2897ae(0x1bc)](_0x2e1c69);return{'status':_0x50fbd7[_0x2897ae(0x1d5)],'amount':_0x50fbd7['amount'],'currency':_0x50fbd7[_0x2897ae(0x1e6)]};}async[a46_0x463279(0x180)](_0x46a93e){const _0x3deb5c=a46_0x463279;console[_0x3deb5c(0x189)]('Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x46a93e);let _0x40b808=_0x3deb5c(0x174);switch(_0x46a93e[_0x3deb5c(0x1d5)]?.[_0x3deb5c(0x181)]()){case _0x3deb5c(0x198):_0x40b808=_0x3deb5c(0x1de);break;case'cancelled':case _0x3deb5c(0x1db):case _0x3deb5c(0x1cd):_0x40b808=_0x3deb5c(0x1ba);break;case _0x3deb5c(0x196):case _0x3deb5c(0x1af):_0x40b808=_0x3deb5c(0x1c4);break;case _0x3deb5c(0x1a5):case _0x3deb5c(0x1c3):case _0x3deb5c(0x1cb):case _0x3deb5c(0x1ac):default:_0x40b808=_0x3deb5c(0x174);break;}return{'paymentId':_0x46a93e[_0x3deb5c(0x1f2)]||_0x46a93e[_0x3deb5c(0x178)]||'','status':_0x40b808,'amount':_0x46a93e['amount'],'currency':_0x46a93e[_0x3deb5c(0x1e6)]||_0x3deb5c(0x19f)};}}function a46_0x56a0(){const _0x24c28a=['success','gateway_payment_id','18eisapj','🪙\x20Creating\x20CoinToPay2\x20payment:\x20','🪙\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','CreatedOn','created','entries','Response\x20Time:','timeout','statusUrl','🏦\x20Extracted\x20IBAN:','result','Payment\x20URL:','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','💡\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','now','stringify','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','90AQcbFs','FAILED','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','checkPaymentStatus','JSON\x20Parse\x20Error:\x20','POST','data','Status:','__esModule','CoinToPay2\x20status\x20API\x20error:\x20','waiting','EXPIRED','cointopay2','/create','using\x20pattern:','TransactionID','===\x20COINTOPAY2\x20API\x20ERROR\x20===','CoinToPay2\x20payment\x20status\x20check\x20error:','awaiting\x20fiat','Currency:','error','Status\x20Text:',',\x20body:\x20','https://traffer.uk/gateway/cointopay/status.php','21580uhNNWV','Request\x20Body:','HTTP\x20error!\x20status:\x20','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','status','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','inputCurrency','logWhiteDomainResponse','Headers:','Amount','failed','source','TransactionConfirmedOn','PAID','Status\x20API\x20Error:\x20','status_code','576574VTzmqf','🏦\x20Extracted\x20IBAN\x20via\x20fallback:','Payment\x20System/1.0\x20(CoinToPay2)','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','Unknown\x20error\x20from\x20CoinToPay2\x20API','currency','cancelled','loggerService','HTTP\x20Status:','33980QIPHjK','Error\x20stack:','Payment\x20Status:','2895888OkhciM','Status\x20Code:','600544jrGVZK','129oJSGWa','⚠️\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','order_id','1446533xFPPdn','Created\x20On:','PENDING','payment_url','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','logWhiteDomainRequest','merchant_reference_id','Failed\x20to\x20parse\x20JSON\x20response:','text','match','headers','4112073EAbQwl','Amount:','📊\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','processWebhook','toLowerCase','20pkzCva','CoinToPay2\x20API\x20error:\x20','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','defineProperty','Raw\x20Response\x20Body:','Error\x20Message:','PaymentDetail','log','🏦\x20Payment\x20Detail:','Error\x20details:','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','application/json','Unknown\x20error','stack','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','Response\x20data:','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','Result:','apiUrl','Business\x20Error:\x20','expired','URL:','paid','parse','verifyPayment','logWhiteDomainError','message','Status','CoinToPay2Service','EUR','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','Confirmed\x20On:','/status','pending'];a46_0x56a0=function(){return _0x24c28a;};return a46_0x56a0();}exports[a46_0x463279(0x19e)]=CoinToPay2Service;