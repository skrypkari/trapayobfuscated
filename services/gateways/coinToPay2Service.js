'use strict';const a43_0x5af962=a43_0x56cf;(function(_0x11d548,_0x4ca12b){const _0x5d09c6=a43_0x56cf,_0x432e65=_0x11d548();while(!![]){try{const _0x280422=-parseInt(_0x5d09c6(0xe2))/0x1+parseInt(_0x5d09c6(0x130))/0x2+parseInt(_0x5d09c6(0x107))/0x3+-parseInt(_0x5d09c6(0xf5))/0x4+parseInt(_0x5d09c6(0x114))/0x5+-parseInt(_0x5d09c6(0x112))/0x6*(parseInt(_0x5d09c6(0xed))/0x7)+-parseInt(_0x5d09c6(0x100))/0x8*(-parseInt(_0x5d09c6(0x134))/0x9);if(_0x280422===_0x4ca12b)break;else _0x432e65['push'](_0x432e65['shift']());}catch(_0x2d37a0){_0x432e65['push'](_0x432e65['shift']());}}}(a43_0x22aa,0xe5632));function a43_0x56cf(_0x36aa5b,_0xd7a2e){const _0x22aabe=a43_0x22aa();return a43_0x56cf=function(_0x56cf0f,_0x278694){_0x56cf0f=_0x56cf0f-0xd3;let _0x171ba0=_0x22aabe[_0x56cf0f];return _0x171ba0;},a43_0x56cf(_0x36aa5b,_0xd7a2e);}Object[a43_0x5af962(0x132)](exports,a43_0x5af962(0xe9),{'value':!![]}),exports[a43_0x5af962(0x10d)]=void 0x0;const loggerService_1=require('../loggerService');class CoinToPay2Service{constructor(){const _0x520362=a43_0x5af962;this[_0x520362(0xe6)]='https://traffer.uk/gateway/cointopay/',this['statusUrl']=_0x520362(0x147),console[_0x520362(0x101)]('ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy'),console[_0x520362(0x101)](_0x520362(0x12b),this[_0x520362(0x111)]);}async[a43_0x5af962(0x126)](_0x193e74){const _0x1e641f=a43_0x5af962,{orderId:_0x6b2ee7,amount:_0x4a6883}=_0x193e74;console[_0x1e641f(0x101)](_0x1e641f(0xf3)+_0x4a6883+_0x1e641f(0x13d));const _0x5eecc5={'amount':_0x4a6883},_0x17d338=Date[_0x1e641f(0xf0)]();try{console[_0x1e641f(0x101)](_0x1e641f(0xfc)),console[_0x1e641f(0x101)](_0x1e641f(0x104),this['apiUrl']),console[_0x1e641f(0x101)](_0x1e641f(0xe8),JSON[_0x1e641f(0x117)](_0x5eecc5,null,0x2)),console['log']('Amount:',_0x4a6883,'EUR\x20(always\x20EUR\x20for\x20CoinToPay2)'),loggerService_1['loggerService']['logWhiteDomainRequest'](_0x1e641f(0x13a),'/create',_0x1e641f(0xff),_0x5eecc5);const _0x4bae33=await fetch(this[_0x1e641f(0xe6)],{'method':'POST','headers':{'Content-Type':_0x1e641f(0x11e),'Accept':'application/json','User-Agent':_0x1e641f(0xda)},'body':JSON['stringify'](_0x5eecc5)}),_0x348372=Date[_0x1e641f(0xf0)]()-_0x17d338;console[_0x1e641f(0x101)](_0x1e641f(0xe3)),console['log'](_0x1e641f(0x11d),_0x4bae33['status']),console[_0x1e641f(0x101)](_0x1e641f(0xf2),_0x4bae33['statusText']),console[_0x1e641f(0x101)]('Headers:',Object[_0x1e641f(0x138)](_0x4bae33[_0x1e641f(0xe5)][_0x1e641f(0x120)]())),console[_0x1e641f(0x101)](_0x1e641f(0x11a),_0x348372+'ms');const _0x1228d6=await _0x4bae33[_0x1e641f(0x146)]();console[_0x1e641f(0x101)]('Raw\x20Response\x20Body:',_0x1228d6);if(!_0x4bae33['ok']){console[_0x1e641f(0xee)]('===\x20COINTOPAY2\x20API\x20ERROR\x20==='),console[_0x1e641f(0xee)](_0x1e641f(0x110),_0x4bae33[_0x1e641f(0x144)]),console[_0x1e641f(0xee)]('Response\x20Body:',_0x1228d6),loggerService_1[_0x1e641f(0xd7)]['logWhiteDomainResponse']('cointopay2',_0x1e641f(0xd8),_0x4bae33[_0x1e641f(0x144)],_0x1228d6,_0x348372),loggerService_1[_0x1e641f(0xd7)][_0x1e641f(0x125)](_0x1e641f(0x13a),_0x1e641f(0xd8),_0x1e641f(0xf6)+_0x4bae33['status']+':\x20'+_0x1228d6);throw new Error('HTTP\x20error!\x20status:\x20'+_0x4bae33[_0x1e641f(0x144)]+_0x1e641f(0xfd)+_0x1228d6);}let _0x5a2ecc;try{_0x5a2ecc=JSON[_0x1e641f(0x13c)](_0x1228d6);}catch(_0x73e372){console[_0x1e641f(0xee)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x73e372),loggerService_1['loggerService'][_0x1e641f(0x125)](_0x1e641f(0x13a),_0x1e641f(0xd8),_0x1e641f(0x14d)+_0x73e372);throw new Error(_0x1e641f(0xea)+_0x1228d6);}console[_0x1e641f(0x101)](_0x1e641f(0x116)),console[_0x1e641f(0x101)](_0x1e641f(0x149),JSON[_0x1e641f(0x117)](_0x5a2ecc,null,0x2)),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x1e641f(0x13a),_0x1e641f(0xd8),_0x4bae33[_0x1e641f(0x144)],_0x5a2ecc,_0x348372);if(_0x5a2ecc[_0x1e641f(0xee)]){const _0x587fdf=_0x5a2ecc[_0x1e641f(0x14f)]||_0x5a2ecc[_0x1e641f(0xee)]||_0x1e641f(0xdc);console['error']('===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20==='),console['error'](_0x1e641f(0x12d),_0x587fdf),loggerService_1['loggerService'][_0x1e641f(0x125)](_0x1e641f(0x13a),_0x1e641f(0xd8),'Business\x20Error:\x20'+_0x587fdf);throw new Error('CoinToPay2\x20API\x20error:\x20'+_0x587fdf);}if(!_0x5a2ecc[_0x1e641f(0x109)]||!_0x5a2ecc[_0x1e641f(0xd5)]){console[_0x1e641f(0xee)](_0x1e641f(0xf9)),console[_0x1e641f(0xee)](_0x1e641f(0xf1)),console[_0x1e641f(0xee)](_0x1e641f(0x10e),_0x5a2ecc),loggerService_1['loggerService'][_0x1e641f(0x125)]('cointopay2','/create','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id');}return console['log'](_0x1e641f(0x14e)),console[_0x1e641f(0x101)](_0x1e641f(0x123),_0x5a2ecc[_0x1e641f(0xd5)]),console['log'](_0x1e641f(0x140),_0x5a2ecc[_0x1e641f(0x109)]),console[_0x1e641f(0x101)](_0x1e641f(0x113),_0x4a6883,_0x1e641f(0x11c)),{'gateway_payment_id':_0x5a2ecc[_0x1e641f(0xd5)],'payment_url':_0x5a2ecc[_0x1e641f(0x109)]};}catch(_0x85def9){console[_0x1e641f(0xee)]('===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20==='),console[_0x1e641f(0xee)]('Error\x20details:',_0x85def9),loggerService_1['loggerService'][_0x1e641f(0x125)]('cointopay2',_0x1e641f(0xd8),_0x85def9);if(_0x85def9 instanceof Error){console[_0x1e641f(0xee)]('Error\x20message:',_0x85def9[_0x1e641f(0x14f)]),console[_0x1e641f(0xee)](_0x1e641f(0x11f),_0x85def9[_0x1e641f(0x143)]);throw new Error(_0x1e641f(0xf4)+_0x85def9[_0x1e641f(0x14f)]);}throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error');}}async[a43_0x5af962(0xf8)](_0x58098e){const _0x5b792e=a43_0x5af962,_0x10f142=Date[_0x5b792e(0xf0)]();try{console[_0x5b792e(0x101)](_0x5b792e(0x12e)+_0x58098e);const _0x476e8e={'gatewayPaymentId':_0x58098e};loggerService_1[_0x5b792e(0xd7)]['logWhiteDomainRequest']('cointopay2',_0x5b792e(0x141),'POST',_0x476e8e);const _0x26e00d=await fetch(this[_0x5b792e(0x111)],{'method':_0x5b792e(0xff),'headers':{'Content-Type':_0x5b792e(0x11e),'Accept':_0x5b792e(0x11e),'User-Agent':_0x5b792e(0xda)},'body':JSON[_0x5b792e(0x117)](_0x476e8e)}),_0x100f7e=Date[_0x5b792e(0xf0)]()-_0x10f142;console[_0x5b792e(0x101)](_0x5b792e(0xef)),console[_0x5b792e(0x101)]('Status:',_0x26e00d['status']),console[_0x5b792e(0x101)](_0x5b792e(0x11a),_0x100f7e+'ms');if(!_0x26e00d['ok']){const _0x3baa64=await _0x26e00d[_0x5b792e(0x146)]();console[_0x5b792e(0xee)](_0x5b792e(0x110),_0x26e00d[_0x5b792e(0x144)]),console['error'](_0x5b792e(0xfa),_0x3baa64),loggerService_1[_0x5b792e(0xd7)]['logWhiteDomainResponse'](_0x5b792e(0x13a),_0x5b792e(0x141),_0x26e00d[_0x5b792e(0x144)],_0x3baa64,_0x100f7e),loggerService_1[_0x5b792e(0xd7)][_0x5b792e(0x125)]('cointopay2','/status',_0x5b792e(0xf6)+_0x26e00d[_0x5b792e(0x144)]+':\x20'+_0x3baa64);throw new Error(_0x5b792e(0xe0)+_0x26e00d['status']);}const _0x5e179f=await _0x26e00d[_0x5b792e(0x146)]();console[_0x5b792e(0x101)]('Raw\x20Response\x20Body:',_0x5e179f);let _0x25a2c1;try{_0x25a2c1=JSON['parse'](_0x5e179f);}catch(_0x2d4785){console[_0x5b792e(0xee)](_0x5b792e(0x150),_0x2d4785),loggerService_1[_0x5b792e(0xd7)][_0x5b792e(0x125)]('cointopay2','/status','JSON\x20Parse\x20Error:\x20'+_0x2d4785);throw new Error(_0x5b792e(0xe7)+_0x5e179f);}loggerService_1[_0x5b792e(0xd7)]['logWhiteDomainResponse']('cointopay2',_0x5b792e(0x141),_0x26e00d[_0x5b792e(0x144)],_0x25a2c1,_0x100f7e),console[_0x5b792e(0x101)](_0x5b792e(0xfe)),console[_0x5b792e(0x101)]('Result:',_0x25a2c1['result']),console['log'](_0x5b792e(0x10f),_0x25a2c1[_0x5b792e(0xec)]),console[_0x5b792e(0x101)](_0x5b792e(0x124),_0x25a2c1[_0x5b792e(0x129)]?.[_0x5b792e(0xdd)]),console[_0x5b792e(0x101)](_0x5b792e(0x113),_0x25a2c1[_0x5b792e(0x129)]?.[_0x5b792e(0xe1)]),console[_0x5b792e(0x101)](_0x5b792e(0x10a),_0x25a2c1[_0x5b792e(0x129)]?.[_0x5b792e(0x13e)]);if(_0x25a2c1['result']!==_0x5b792e(0x11b)||_0x25a2c1[_0x5b792e(0xec)]!==0xc8){const _0x42a405=_0x25a2c1[_0x5b792e(0x14f)]||_0x5b792e(0xf7);console[_0x5b792e(0xee)](_0x5b792e(0x121)),console[_0x5b792e(0xee)](_0x5b792e(0x12d),_0x42a405),loggerService_1[_0x5b792e(0xd7)][_0x5b792e(0x125)]('cointopay2',_0x5b792e(0x141),_0x5b792e(0x119)+_0x42a405);throw new Error(_0x5b792e(0xd9)+_0x42a405);}if(!_0x25a2c1[_0x5b792e(0x129)]){console[_0x5b792e(0xee)](_0x5b792e(0x12f)),console['error'](_0x5b792e(0x10c)),loggerService_1[_0x5b792e(0xd7)][_0x5b792e(0x125)](_0x5b792e(0x13a),_0x5b792e(0x141),_0x5b792e(0xeb));throw new Error(_0x5b792e(0x14b));}let _0x5ed892='PENDING';switch(_0x25a2c1['data']['Status']?.[_0x5b792e(0x102)]()){case _0x5b792e(0x133):_0x5ed892=_0x5b792e(0x137);break;case'cancelled':case _0x5b792e(0x115):case _0x5b792e(0xee):_0x5ed892=_0x5b792e(0x105);break;case _0x5b792e(0xdb):case'timeout':_0x5ed892=_0x5b792e(0xd3);break;case _0x5b792e(0x13f):case _0x5b792e(0x106):case _0x5b792e(0x103):case _0x5b792e(0x128):default:_0x5ed892=_0x5b792e(0x135);break;}let _0x366b60,_0x3c3db8;if(_0x25a2c1[_0x5b792e(0x129)]['PaymentDetail']){const _0x3b313c=_0x25a2c1[_0x5b792e(0x129)][_0x5b792e(0xd6)];console[_0x5b792e(0x101)](_0x5b792e(0x14a),_0x3b313c);const _0x355d5b=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x24fdb8 of _0x355d5b){const _0x775e04=_0x3b313c[_0x5b792e(0xde)](_0x24fdb8);if(_0x775e04){_0x366b60=_0x775e04[0x1],console['log'](_0x5b792e(0x122),_0x366b60,_0x5b792e(0x127),_0x24fdb8['source']);break;}}if(!_0x366b60){console[_0x5b792e(0x101)]('‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...');const _0x47f390=_0x3b313c[_0x5b792e(0xde)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x47f390&&(_0x366b60=_0x47f390[0x1],console['log']('üè¶\x20Extracted\x20IBAN\x20via\x20fallback:',_0x366b60));}_0x3c3db8=_0x3b313c;}const _0x38d1ca={'iban':_0x366b60,'bankDetails':_0x3c3db8,'transactionId':_0x25a2c1[_0x5b792e(0x129)]['TransactionID'],'coinAddress':_0x25a2c1[_0x5b792e(0x129)][_0x5b792e(0x13b)],'qrCodeUrl':_0x25a2c1[_0x5b792e(0x129)]['QRCodeURL'],'expiryTime':_0x25a2c1[_0x5b792e(0x129)]['ExpiryTime'],'createdOn':_0x25a2c1[_0x5b792e(0x129)][_0x5b792e(0x148)],'confirmedOn':_0x25a2c1[_0x5b792e(0x129)][_0x5b792e(0xe4)]};console['log'](_0x5b792e(0xdf)),console[_0x5b792e(0x101)](_0x5b792e(0x11d),_0x25a2c1[_0x5b792e(0x129)][_0x5b792e(0xdd)],'->',_0x5ed892),console[_0x5b792e(0x101)](_0x5b792e(0x113),_0x25a2c1[_0x5b792e(0x129)]['Amount'],_0x25a2c1[_0x5b792e(0x129)][_0x5b792e(0x13e)]),console[_0x5b792e(0x101)]('Transaction\x20ID:',_0x25a2c1['data'][_0x5b792e(0xd4)]),console[_0x5b792e(0x101)](_0x5b792e(0x12c),_0x366b60||_0x5b792e(0x139)),console[_0x5b792e(0x101)](_0x5b792e(0x10b),_0x25a2c1['data'][_0x5b792e(0x148)]),console[_0x5b792e(0x101)]('Confirmed\x20On:',_0x25a2c1[_0x5b792e(0x129)][_0x5b792e(0xe4)]||_0x5b792e(0x136));if(_0x25a2c1[_0x5b792e(0x129)][_0x5b792e(0xdd)]?.[_0x5b792e(0x102)]()===_0x5b792e(0x106))console[_0x5b792e(0x101)]('üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)');else _0x25a2c1[_0x5b792e(0x129)][_0x5b792e(0xdd)]?.[_0x5b792e(0x102)]()===_0x5b792e(0x133)&&console[_0x5b792e(0x101)](_0x5b792e(0x108));return{'status':_0x5ed892,'amount':parseFloat(_0x25a2c1[_0x5b792e(0x129)][_0x5b792e(0xe1)])||undefined,'currency':_0x25a2c1[_0x5b792e(0x129)][_0x5b792e(0x13e)]||_0x5b792e(0x11c),'paymentDetails':_0x38d1ca};}catch(_0xe509ab){console['error'](_0x5b792e(0x142),_0xe509ab),loggerService_1[_0x5b792e(0xd7)][_0x5b792e(0x125)](_0x5b792e(0x13a),_0x5b792e(0x141),_0xe509ab);throw new Error(_0x5b792e(0x14c)+(_0xe509ab instanceof Error?_0xe509ab[_0x5b792e(0x14f)]:'Unknown\x20error'));}}async['verifyPayment'](_0x12cbf9){const _0x40d33b=a43_0x5af962,_0x1c0d0d=await this[_0x40d33b(0xf8)](_0x12cbf9);return{'status':_0x1c0d0d[_0x40d33b(0x144)],'amount':_0x1c0d0d[_0x40d33b(0x131)],'currency':_0x1c0d0d[_0x40d33b(0x12a)]};}async[a43_0x5af962(0xfb)](_0xb6bb46){const _0x1d55f1=a43_0x5af962;console[_0x1d55f1(0x101)]('Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0xb6bb46);let _0xc4142b=_0x1d55f1(0x135);switch(_0xb6bb46[_0x1d55f1(0x144)]?.[_0x1d55f1(0x102)]()){case _0x1d55f1(0x133):_0xc4142b=_0x1d55f1(0x137);break;case'cancelled':case _0x1d55f1(0x115):case _0x1d55f1(0xee):_0xc4142b=_0x1d55f1(0x105);break;case _0x1d55f1(0xdb):case _0x1d55f1(0x145):_0xc4142b=_0x1d55f1(0xd3);break;case _0x1d55f1(0x103):case'waiting':case _0x1d55f1(0x106):case _0x1d55f1(0x128):default:_0xc4142b=_0x1d55f1(0x135);break;}return{'paymentId':_0xb6bb46[_0x1d55f1(0x118)]||_0xb6bb46['merchant_reference_id']||'','status':_0xc4142b,'amount':_0xb6bb46[_0x1d55f1(0x131)],'currency':_0xb6bb46[_0x1d55f1(0x12a)]||'EUR'};}}exports['CoinToPay2Service']=CoinToPay2Service;function a43_0x22aa(){const _0x58b37c=['/status','CoinToPay2\x20payment\x20status\x20check\x20error:','stack','status','timeout','text','https://traffer.uk/gateway/cointopay/status.php','CreatedOn','Parsed\x20Result:','üè¶\x20Payment\x20Detail:','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','JSON\x20Parse\x20Error:\x20','===\x20COINTOPAY2\x20SUCCESS\x20===','message','Failed\x20to\x20parse\x20JSON\x20response:','EXPIRED','TransactionID','gateway_payment_id','PaymentDetail','loggerService','/create','CoinToPay2\x20status\x20API\x20error:\x20','TesSoft\x20Payment\x20System/1.0\x20(CoinToPay2)','expired','Unknown\x20error\x20from\x20CoinToPay2\x20API','Status','match','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','HTTP\x20error!\x20status:\x20','Amount','1474041DSjVsV','===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20===','TransactionConfirmedOn','headers','apiUrl','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','Request\x20Body:','__esModule','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','Incomplete\x20response:\x20missing\x20data','status_code','14273kaZeKF','error','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','now','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','Status\x20Text:','ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','6967836LJUDwc','HTTP\x20','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','checkPaymentStatus','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Response\x20Body:','processWebhook','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===',',\x20body:\x20','===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20===','POST','281704RLRSzb','log','toLowerCase','pending','URL:','FAILED','awaiting\x20fiat','3870975hIhKWn','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','payment_url','Currency:','Created\x20On:','Missing\x20data\x20in\x20response','CoinToPay2Service','Response\x20data:','Status\x20Code:','HTTP\x20Status:','statusUrl','624yqZZsD','Amount:','6508535jHgdXV','failed','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','stringify','order_id','Status\x20API\x20Error:\x20','Response\x20Time:','success','EUR','Status:','application/json','Error\x20stack:','entries','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','üè¶\x20Extracted\x20IBAN:','Gateway\x20Payment\x20ID:','Payment\x20Status:','logWhiteDomainError','createPaymentLink','using\x20pattern:','created','data','currency','üìä\x20Status\x20check\x20URL:','IBAN:','Error\x20Message:','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','2776502vPozNj','amount','defineProperty','paid','99REwUmj','PENDING','not\x20confirmed','PAID','fromEntries','not\x20found','cointopay2','coinAddress','parse','\x20EUR','inputCurrency','waiting','Payment\x20URL:'];a43_0x22aa=function(){return _0x58b37c;};return a43_0x22aa();}