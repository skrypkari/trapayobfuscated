'use strict';function a48_0x421e(_0x4a782e,_0x5d6bcc){const _0x36c7b0=a48_0x36c7();return a48_0x421e=function(_0x421eac,_0x331865){_0x421eac=_0x421eac-0xfd;let _0x3bbb6f=_0x36c7b0[_0x421eac];return _0x3bbb6f;},a48_0x421e(_0x4a782e,_0x5d6bcc);}const a48_0x4a7614=a48_0x421e;(function(_0x117e48,_0x46e6e1){const _0x48cd25=a48_0x421e,_0x3a8228=_0x117e48();while(!![]){try{const _0x3f75f5=-parseInt(_0x48cd25(0x17d))/0x1*(parseInt(_0x48cd25(0x145))/0x2)+-parseInt(_0x48cd25(0x12c))/0x3+parseInt(_0x48cd25(0x12d))/0x4*(-parseInt(_0x48cd25(0x120))/0x5)+-parseInt(_0x48cd25(0x111))/0x6*(-parseInt(_0x48cd25(0x139))/0x7)+parseInt(_0x48cd25(0x155))/0x8+parseInt(_0x48cd25(0x152))/0x9*(parseInt(_0x48cd25(0x148))/0xa)+parseInt(_0x48cd25(0x11d))/0xb*(parseInt(_0x48cd25(0x122))/0xc);if(_0x3f75f5===_0x46e6e1)break;else _0x3a8228['push'](_0x3a8228['shift']());}catch(_0x461f1f){_0x3a8228['push'](_0x3a8228['shift']());}}}(a48_0x36c7,0xcd4eb));Object[a48_0x4a7614(0x128)](exports,a48_0x4a7614(0x170),{'value':!![]}),exports[a48_0x4a7614(0x143)]=void 0x0;const loggerService_1=require(a48_0x4a7614(0x131));function a48_0x36c7(){const _0x16440e=['timeout','data','../loggerService','===\x20COINTOPAY2\x20API\x20REQUEST\x20(traffer.uk)\x20===','https://traffer.uk/gateway/cointopay/status.php','payment_url','Amount','Status\x20Code:','Missing\x20data\x20in\x20response','TransactionID','781067DXrEfC','Error\x20details:','parse','Status','IBAN:','Amount:','Status\x20API\x20Error:\x20','pending','===\x20COINTOPAY2\x20STATUS\x20SUCCESS\x20===','stringify','CoinToPay2Service','status','6evaTZx','===\x20COINTOPAY2\x20STATUS\x20CHECK\x20RESPONSE\x20===','HTTP\x20error!\x20status:\x20','210KEXCrN','loggerService','Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20','CoinToPay2\x20API\x20error:\x20','&alternative=false','===\x20COINTOPAY2\x20STATUS\x20API\x20INCOMPLETE\x20RESPONSE\x20===','CreatedOn','JSON\x20Parse\x20Error:\x20',',\x20body:\x20','PaymentDetail','560745OErKKu','gateway_payment_id','FAILED','8691032CEpQQs','headers','logWhiteDomainResponse','Payment\x20System/1.0\x20(CoinToPay2)','failed','===\x20COINTOPAY2\x20API\x20INCOMPLETE\x20RESPONSE\x20===','statusUrl','Response\x20data:','Payment\x20URL\x20(original):','ü™ô\x20CoinToPay2\x20service\x20initialized\x20with\x20traffer.uk\x20proxy','logWhiteDomainRequest','===\x20COINTOPAY2\x20API\x20BUSINESS\x20ERROR\x20===','CoinToPay2\x20payment\x20status\x20check\x20error:','Unknown\x20error\x20from\x20CoinToPay2\x20API','üí°\x20\x22Awaiting\x20Fiat\x22\x20mapped\x20to\x20PENDING\x20(not\x20PAID)','Payment\x20Status:','üè¶\x20Extracted\x20IBAN:','paid','result','Failed\x20to\x20check\x20CoinToPay2\x20payment\x20status:\x20','Error\x20Message:','checkPaymentStatus','text','POST','log','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20API:\x20','üìä\x20Checking\x20CoinToPay2\x20payment\x20status\x20for:\x20','__esModule','currency','status_code','üè¶\x20Extracted\x20IBAN\x20via\x20fallback:','entries','Invalid\x20JSON\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20','match','HTTP\x20Status:','Unknown\x20error\x20from\x20CoinToPay2\x20status\x20API','createPaymentLink','===\x20PARSED\x20COINTOPAY2\x20RESPONSE\x20===','Status:','toLowerCase','529168VRDNJt','processWebhook','verifyPayment','QRCodeURL','Missing\x20payment_url\x20or\x20gateway_payment_id\x20in\x20response','coinAddress','PENDING','EXPIRED','TransactionConfirmedOn','Status\x20Text:','üìä\x20Status\x20check\x20URL:','logWhiteDomainError','https://traffer.uk/gateway/cointopay/','fromEntries','‚úÖ\x20\x22Paid\x22\x20mapped\x20to\x20PAID','cointopay2','inputCurrency','Headers:','PAID','application/json','===\x20COINTOPAY2\x20STATUS\x20API\x20ERROR\x20===','Error\x20message:','‚ö†Ô∏è\x20IBAN\x20not\x20found\x20in\x20payment\x20details.\x20Trying\x20to\x20extract\x20from\x20text...','EUR','expired','message','Created\x20On:','Gateway\x20Payment\x20ID:','18lhSgge','Response\x20Time:','ExpiryTime','===\x20COINTOPAY2\x20SERVICE\x20ERROR\x20===','HTTP\x20','created','awaiting\x20fiat','Confirmed\x20On:','statusText','/status','now','not\x20found','14483579ZINEam','merchant_reference_id','Raw\x20Response\x20Body:','15wDNqId','apiUrl','24SNyFqW','EUR\x20(always\x20EUR\x20for\x20CoinToPay2)','cancelled','/create','Request\x20Body:','Transaction\x20ID:','defineProperty','URL:','error','Response\x20Body:','4274073DFHWkn','2013028iZdfUB','Invalid\x20response\x20from\x20CoinToPay2\x20status\x20API:\x20missing\x20data'];a48_0x36c7=function(){return _0x16440e;};return a48_0x36c7();}class CoinToPay2Service{constructor(){const _0x1de0cd=a48_0x4a7614;this[_0x1de0cd(0x121)]=_0x1de0cd(0x101),this[_0x1de0cd(0x15b)]=_0x1de0cd(0x133),console[_0x1de0cd(0x16d)](_0x1de0cd(0x15e)),console[_0x1de0cd(0x16d)](_0x1de0cd(0xff),this[_0x1de0cd(0x15b)]);}async[a48_0x4a7614(0x179)](_0x49756e){const _0x55d4f0=a48_0x4a7614,{orderId:_0x22897b,amount:_0x3b936c}=_0x49756e;console[_0x55d4f0(0x16d)]('ü™ô\x20Creating\x20CoinToPay2\x20payment:\x20'+_0x3b936c+'\x20EUR');const _0x4406fa={'amount':_0x3b936c},_0x3a90e3=Date[_0x55d4f0(0x11b)]();try{console[_0x55d4f0(0x16d)](_0x55d4f0(0x132)),console['log'](_0x55d4f0(0x129),this[_0x55d4f0(0x121)]),console[_0x55d4f0(0x16d)](_0x55d4f0(0x126),JSON[_0x55d4f0(0x142)](_0x4406fa,null,0x2)),console['log'](_0x55d4f0(0x13e),_0x3b936c,_0x55d4f0(0x123)),loggerService_1[_0x55d4f0(0x149)][_0x55d4f0(0x15f)](_0x55d4f0(0x104),'/create',_0x55d4f0(0x16c),_0x4406fa);const _0x4164e5=await fetch(this[_0x55d4f0(0x121)],{'method':'POST','headers':{'Content-Type':_0x55d4f0(0x108),'Accept':_0x55d4f0(0x108),'User-Agent':_0x55d4f0(0x158)},'body':JSON[_0x55d4f0(0x142)](_0x4406fa)}),_0x36647a=Date[_0x55d4f0(0x11b)]()-_0x3a90e3;console[_0x55d4f0(0x16d)]('===\x20COINTOPAY2\x20API\x20RESPONSE\x20(traffer.uk)\x20==='),console[_0x55d4f0(0x16d)](_0x55d4f0(0x17b),_0x4164e5['status']),console[_0x55d4f0(0x16d)](_0x55d4f0(0xfe),_0x4164e5[_0x55d4f0(0x119)]),console[_0x55d4f0(0x16d)](_0x55d4f0(0x106),Object[_0x55d4f0(0x102)](_0x4164e5[_0x55d4f0(0x156)][_0x55d4f0(0x174)]())),console['log'](_0x55d4f0(0x112),_0x36647a+'ms');const _0x42f834=await _0x4164e5[_0x55d4f0(0x16b)]();console['log']('Raw\x20Response\x20Body:',_0x42f834);if(!_0x4164e5['ok']){console['error']('===\x20COINTOPAY2\x20API\x20ERROR\x20==='),console[_0x55d4f0(0x12a)]('HTTP\x20Status:',_0x4164e5[_0x55d4f0(0x144)]),console[_0x55d4f0(0x12a)](_0x55d4f0(0x12b),_0x42f834),loggerService_1[_0x55d4f0(0x149)][_0x55d4f0(0x157)](_0x55d4f0(0x104),_0x55d4f0(0x125),_0x4164e5['status'],_0x42f834,_0x36647a),loggerService_1[_0x55d4f0(0x149)]['logWhiteDomainError'](_0x55d4f0(0x104),_0x55d4f0(0x125),_0x55d4f0(0x115)+_0x4164e5[_0x55d4f0(0x144)]+':\x20'+_0x42f834);throw new Error(_0x55d4f0(0x147)+_0x4164e5[_0x55d4f0(0x144)]+_0x55d4f0(0x150)+_0x42f834);}let _0x5e43d8;try{_0x5e43d8=JSON[_0x55d4f0(0x13b)](_0x42f834);}catch(_0x99b5d){console[_0x55d4f0(0x12a)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x99b5d),loggerService_1['loggerService'][_0x55d4f0(0x100)](_0x55d4f0(0x104),_0x55d4f0(0x125),'JSON\x20Parse\x20Error:\x20'+_0x99b5d);throw new Error(_0x55d4f0(0x16e)+_0x42f834);}console[_0x55d4f0(0x16d)](_0x55d4f0(0x17a)),console[_0x55d4f0(0x16d)]('Parsed\x20Result:',JSON[_0x55d4f0(0x142)](_0x5e43d8,null,0x2)),loggerService_1[_0x55d4f0(0x149)][_0x55d4f0(0x157)](_0x55d4f0(0x104),_0x55d4f0(0x125),_0x4164e5['status'],_0x5e43d8,_0x36647a);if(_0x5e43d8[_0x55d4f0(0x12a)]){const _0x5085eb=_0x5e43d8[_0x55d4f0(0x10e)]||_0x5e43d8[_0x55d4f0(0x12a)]||_0x55d4f0(0x162);console[_0x55d4f0(0x12a)](_0x55d4f0(0x160)),console[_0x55d4f0(0x12a)](_0x55d4f0(0x169),_0x5085eb),loggerService_1[_0x55d4f0(0x149)][_0x55d4f0(0x100)](_0x55d4f0(0x104),_0x55d4f0(0x125),'Business\x20Error:\x20'+_0x5085eb);throw new Error(_0x55d4f0(0x14b)+_0x5085eb);}if(!_0x5e43d8[_0x55d4f0(0x134)]||!_0x5e43d8[_0x55d4f0(0x153)]){console[_0x55d4f0(0x12a)](_0x55d4f0(0x15a)),console[_0x55d4f0(0x12a)](_0x55d4f0(0x181)),console[_0x55d4f0(0x12a)](_0x55d4f0(0x15c),_0x5e43d8),loggerService_1[_0x55d4f0(0x149)][_0x55d4f0(0x100)](_0x55d4f0(0x104),'/create','Incomplete\x20response:\x20missing\x20payment_url\x20or\x20gateway_payment_id');throw new Error('Invalid\x20response\x20from\x20CoinToPay2\x20API:\x20missing\x20payment_url\x20or\x20gateway_payment_id');}console['log']('===\x20COINTOPAY2\x20SUCCESS\x20==='),console[_0x55d4f0(0x16d)](_0x55d4f0(0x110),_0x5e43d8[_0x55d4f0(0x153)]),console[_0x55d4f0(0x16d)](_0x55d4f0(0x15d),_0x5e43d8[_0x55d4f0(0x134)]);const _0x5f4143=_0x5e43d8[_0x55d4f0(0x134)]+_0x55d4f0(0x14c);return console[_0x55d4f0(0x16d)]('Payment\x20URL\x20(modified):',_0x5f4143),console['log'](_0x55d4f0(0x13e),_0x3b936c,'EUR'),{'gateway_payment_id':_0x5e43d8[_0x55d4f0(0x153)],'payment_url':_0x5f4143};}catch(_0x3a2860){console[_0x55d4f0(0x12a)](_0x55d4f0(0x114)),console[_0x55d4f0(0x12a)](_0x55d4f0(0x13a),_0x3a2860),loggerService_1[_0x55d4f0(0x149)][_0x55d4f0(0x100)](_0x55d4f0(0x104),_0x55d4f0(0x125),_0x3a2860);if(_0x3a2860 instanceof Error){console[_0x55d4f0(0x12a)](_0x55d4f0(0x10a),_0x3a2860[_0x55d4f0(0x10e)]),console[_0x55d4f0(0x12a)]('Error\x20stack:',_0x3a2860['stack']);throw new Error(_0x55d4f0(0x14a)+_0x3a2860[_0x55d4f0(0x10e)]);}throw new Error('Failed\x20to\x20create\x20CoinToPay2\x20payment\x20link:\x20Unknown\x20error');}}async[a48_0x4a7614(0x16a)](_0x44eefd){const _0x377469=a48_0x4a7614,_0x1ca1fb=Date['now']();try{console[_0x377469(0x16d)](_0x377469(0x16f)+_0x44eefd);const _0x3d8ac2={'gatewayPaymentId':_0x44eefd};loggerService_1[_0x377469(0x149)]['logWhiteDomainRequest'](_0x377469(0x104),_0x377469(0x11a),'POST',_0x3d8ac2);const _0x237c4b=await fetch(this[_0x377469(0x15b)],{'method':'POST','headers':{'Content-Type':_0x377469(0x108),'Accept':_0x377469(0x108),'User-Agent':'Payment\x20System/1.0\x20(CoinToPay2)'},'body':JSON['stringify'](_0x3d8ac2)}),_0x5efaf2=Date['now']()-_0x1ca1fb;console['log'](_0x377469(0x146)),console['log'](_0x377469(0x17b),_0x237c4b[_0x377469(0x144)]),console[_0x377469(0x16d)](_0x377469(0x112),_0x5efaf2+'ms');if(!_0x237c4b['ok']){const _0x4196a8=await _0x237c4b[_0x377469(0x16b)]();console[_0x377469(0x12a)](_0x377469(0x177),_0x237c4b[_0x377469(0x144)]),console['error'](_0x377469(0x12b),_0x4196a8),loggerService_1[_0x377469(0x149)][_0x377469(0x157)](_0x377469(0x104),'/status',_0x237c4b[_0x377469(0x144)],_0x4196a8,_0x5efaf2),loggerService_1[_0x377469(0x149)][_0x377469(0x100)](_0x377469(0x104),_0x377469(0x11a),_0x377469(0x115)+_0x237c4b[_0x377469(0x144)]+':\x20'+_0x4196a8);throw new Error(_0x377469(0x147)+_0x237c4b[_0x377469(0x144)]);}const _0x3305b1=await _0x237c4b[_0x377469(0x16b)]();console[_0x377469(0x16d)](_0x377469(0x11f),_0x3305b1);let _0x571c9f;try{_0x571c9f=JSON[_0x377469(0x13b)](_0x3305b1);}catch(_0x5301df){console[_0x377469(0x12a)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x5301df),loggerService_1[_0x377469(0x149)]['logWhiteDomainError']('cointopay2',_0x377469(0x11a),_0x377469(0x14f)+_0x5301df);throw new Error(_0x377469(0x175)+_0x3305b1);}loggerService_1[_0x377469(0x149)]['logWhiteDomainResponse'](_0x377469(0x104),_0x377469(0x11a),_0x237c4b[_0x377469(0x144)],_0x571c9f,_0x5efaf2),console['log']('===\x20PARSED\x20COINTOPAY2\x20STATUS\x20RESPONSE\x20==='),console[_0x377469(0x16d)]('Result:',_0x571c9f[_0x377469(0x167)]),console[_0x377469(0x16d)](_0x377469(0x136),_0x571c9f[_0x377469(0x172)]),console[_0x377469(0x16d)](_0x377469(0x164),_0x571c9f['data']?.[_0x377469(0x13c)]),console[_0x377469(0x16d)](_0x377469(0x13e),_0x571c9f[_0x377469(0x130)]?.[_0x377469(0x135)]),console[_0x377469(0x16d)]('Currency:',_0x571c9f[_0x377469(0x130)]?.[_0x377469(0x105)]);if(_0x571c9f[_0x377469(0x167)]!=='success'||_0x571c9f['status_code']!==0xc8){const _0x4e57f7=_0x571c9f[_0x377469(0x10e)]||_0x377469(0x178);console['error'](_0x377469(0x109)),console[_0x377469(0x12a)]('Error\x20Message:',_0x4e57f7),loggerService_1[_0x377469(0x149)][_0x377469(0x100)](_0x377469(0x104),_0x377469(0x11a),_0x377469(0x13f)+_0x4e57f7);throw new Error('CoinToPay2\x20status\x20API\x20error:\x20'+_0x4e57f7);}if(!_0x571c9f[_0x377469(0x130)]){console[_0x377469(0x12a)](_0x377469(0x14d)),console[_0x377469(0x12a)](_0x377469(0x137)),loggerService_1[_0x377469(0x149)][_0x377469(0x100)](_0x377469(0x104),_0x377469(0x11a),'Incomplete\x20response:\x20missing\x20data');throw new Error(_0x377469(0x12e));}let _0x557eac=_0x377469(0x183);switch(_0x571c9f[_0x377469(0x130)][_0x377469(0x13c)]?.[_0x377469(0x17c)]()){case _0x377469(0x166):_0x557eac=_0x377469(0x107);break;case _0x377469(0x124):case _0x377469(0x159):case _0x377469(0x12a):_0x557eac=_0x377469(0x154);break;case _0x377469(0x10d):case _0x377469(0x12f):_0x557eac=_0x377469(0x184);break;case'waiting':case _0x377469(0x117):case _0x377469(0x140):case'created':default:_0x557eac=_0x377469(0x183);break;}let _0x313b94,_0x493ac9;if(_0x571c9f[_0x377469(0x130)][_0x377469(0x151)]){const _0x51dfa7=_0x571c9f[_0x377469(0x130)][_0x377469(0x151)];console[_0x377469(0x16d)]('üè¶\x20Payment\x20Detail:',_0x51dfa7);const _0x5f3ec0=[/<span[^>]*>IBAN<\/span>&nbsp;([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN[:\s]+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i,/IBAN\s+([A-Z]{2}[0-9]{2}[A-Z0-9]+)/i];for(const _0x50838f of _0x5f3ec0){const _0xc64d72=_0x51dfa7[_0x377469(0x176)](_0x50838f);if(_0xc64d72){_0x313b94=_0xc64d72[0x1],console['log'](_0x377469(0x165),_0x313b94,'using\x20pattern:',_0x50838f['source']);break;}}if(!_0x313b94){console[_0x377469(0x16d)](_0x377469(0x10b));const _0x540669=_0x51dfa7[_0x377469(0x176)](/\b([A-Z]{2}[0-9]{2}[A-Z0-9]{10,})\b/i);_0x540669&&(_0x313b94=_0x540669[0x1],console['log'](_0x377469(0x173),_0x313b94));}_0x493ac9=_0x51dfa7;}const _0x2a0c40={'iban':_0x313b94,'bankDetails':_0x493ac9,'transactionId':_0x571c9f[_0x377469(0x130)][_0x377469(0x138)],'coinAddress':_0x571c9f['data'][_0x377469(0x182)],'qrCodeUrl':_0x571c9f[_0x377469(0x130)][_0x377469(0x180)],'expiryTime':_0x571c9f[_0x377469(0x130)][_0x377469(0x113)],'createdOn':_0x571c9f['data'][_0x377469(0x14e)],'confirmedOn':_0x571c9f[_0x377469(0x130)][_0x377469(0xfd)]};console[_0x377469(0x16d)](_0x377469(0x141)),console['log']('Status:',_0x571c9f[_0x377469(0x130)][_0x377469(0x13c)],'->',_0x557eac),console['log'](_0x377469(0x13e),_0x571c9f[_0x377469(0x130)][_0x377469(0x135)],_0x571c9f['data'][_0x377469(0x105)]),console['log'](_0x377469(0x127),_0x571c9f['data'][_0x377469(0x138)]),console['log'](_0x377469(0x13d),_0x313b94||_0x377469(0x11c)),console[_0x377469(0x16d)](_0x377469(0x10f),_0x571c9f[_0x377469(0x130)][_0x377469(0x14e)]),console['log'](_0x377469(0x118),_0x571c9f[_0x377469(0x130)][_0x377469(0xfd)]||'not\x20confirmed');if(_0x571c9f[_0x377469(0x130)]['Status']?.[_0x377469(0x17c)]()===_0x377469(0x117))console[_0x377469(0x16d)](_0x377469(0x163));else _0x571c9f[_0x377469(0x130)][_0x377469(0x13c)]?.['toLowerCase']()===_0x377469(0x166)&&console[_0x377469(0x16d)](_0x377469(0x103));return{'status':_0x557eac,'amount':parseFloat(_0x571c9f[_0x377469(0x130)]['Amount'])||undefined,'currency':_0x571c9f[_0x377469(0x130)][_0x377469(0x105)]||_0x377469(0x10c),'paymentDetails':_0x2a0c40};}catch(_0x33de0d){console[_0x377469(0x12a)](_0x377469(0x161),_0x33de0d),loggerService_1['loggerService'][_0x377469(0x100)](_0x377469(0x104),_0x377469(0x11a),_0x33de0d);throw new Error(_0x377469(0x168)+(_0x33de0d instanceof Error?_0x33de0d['message']:'Unknown\x20error'));}}async[a48_0x4a7614(0x17f)](_0x4c9b04){const _0x2ac41d=a48_0x4a7614,_0x1b1089=await this['checkPaymentStatus'](_0x4c9b04);return{'status':_0x1b1089[_0x2ac41d(0x144)],'amount':_0x1b1089['amount'],'currency':_0x1b1089['currency']};}async[a48_0x4a7614(0x17e)](_0x2ecb80){const _0x1b3f36=a48_0x4a7614;console[_0x1b3f36(0x16d)]('Processing\x20CoinToPay2\x20webhook\x20(deprecated\x20-\x20use\x20status\x20check\x20instead):',_0x2ecb80);let _0x515321=_0x1b3f36(0x183);switch(_0x2ecb80[_0x1b3f36(0x144)]?.[_0x1b3f36(0x17c)]()){case _0x1b3f36(0x166):_0x515321=_0x1b3f36(0x107);break;case _0x1b3f36(0x124):case'failed':case _0x1b3f36(0x12a):_0x515321='FAILED';break;case _0x1b3f36(0x10d):case _0x1b3f36(0x12f):_0x515321=_0x1b3f36(0x184);break;case _0x1b3f36(0x140):case'waiting':case _0x1b3f36(0x117):case _0x1b3f36(0x116):default:_0x515321=_0x1b3f36(0x183);break;}return{'paymentId':_0x2ecb80['order_id']||_0x2ecb80[_0x1b3f36(0x11e)]||'','status':_0x515321,'amount':_0x2ecb80['amount'],'currency':_0x2ecb80[_0x1b3f36(0x171)]||_0x1b3f36(0x10c)};}}exports['CoinToPay2Service']=CoinToPay2Service;