'use strict';const a45_0x2355bf=a45_0x3833;function a45_0x3833(_0x3ef30e,_0x54a17a){const _0x523d1f=a45_0x523d();return a45_0x3833=function(_0x383373,_0x1180e4){_0x383373=_0x383373-0x74;let _0x59a16d=_0x523d1f[_0x383373];return _0x59a16d;},a45_0x3833(_0x3ef30e,_0x54a17a);}function a45_0x523d(){const _0x462d94=['error','\x20SUCCESS\x20(Legacy\x20Format)\x20===','length','118PToyhW','toLowerCase','statusCode','/create','Raw\x20Response\x20Body:','Failed\x20to\x20create\x20KLYME\x20','HTTP\x20error!\x20status:\x20','Region\x20(geo):','logWhiteDomainRequest','padStart','Parsed\x20Result:','default','findFirst','successful','rejected','redirect_url','PENDING','https://tesoft.uk/gateway/pending.php?id=','resolve','https://tesoft.uk/gateway/klyme/','\x20currency\x20validation\x20passed:\x20','\x20API\x20error:\x20','cancelled','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','authUrl','\x20API\x20BUSINESS\x20ERROR\x20===','__createBinding','Response\x20Body:','headers','Processing\x20KLYME\x20webhook:','KlymeService','Status:','currency','HTTP\x20','Headers:','üí≥\x20KLYME\x20','\x20RESPONSE\x20===','UUID:','‚ö†Ô∏è\x20KLYME\x20reference\x20','Response\x20data:','expired','fromEntries','entries','pending','16340xVxTEp','(8digits-8digits\x20format)','\x20API\x20ERROR\x20===','===\x20KLYME\x20','Unknown\x20error\x20from\x20KLYME\x20','stringify','klyme_','Error\x20details:','__esModule',',\x20body:\x20','payment_id','1398502IbEkks','POST','in_progress','TesSoft\x20Payment\x20System/1.0','6275172AUjwDX','floor','payment','\x20validated)','7269507MTEidY','(validated\x20for\x20','Failed\x20to\x20verify\x20KLYME\x20','generateUniqueReference','24ryMzTP','JSON\x20Parse\x20Error:\x20','\x20payment\x20link:\x20Unknown\x20error','status','createPaymentLink','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','call','defineProperty','109978yBEkBx','apiUrl','Error\x20stack:','80oIhrZt','Redirect\x20URL:','log','Reference:','logWhiteDomainError','\x20API:\x20','../../config/database','Auth\x20URL:','logWhiteDomainResponse','Status\x20Code:','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','prototype','__setModuleDefault','PAID','text','processWebhook','then','canceled','../loggerService','Geo\x20Parameter:','EUR','now','confirmed','created','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','failed','Unknown\x20error','create','uuid','Unsupported\x20KLYME\x20region:\x20','paid','\x20(8digits-8digits\x20format\x20for\x20','EXPIRED','/verify/','Failed\x20to\x20parse\x20JSON\x20response:','Currency\x20Used:','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','active','message','success','Reference\x20Used:','KLYME\x20','parse','\x20SUCCESS\x20(New\x20Format)\x20===','13930hqmCLK','application/json','Reference\x20Used\x20as\x20ID:','loggerService','verifyPayment','1228VFFowj','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','950244GNLRxO','random','configurable','statusText','processing','FAILED','toUpperCase','order_id','\x20payment\x20link:\x20','toString','validateCurrencyForRegion'];a45_0x523d=function(){return _0x462d94;};return a45_0x523d();}(function(_0x1d71e3,_0x3fef0f){const _0x5d42b8=a45_0x3833,_0x4ece56=_0x1d71e3();while(!![]){try{const _0x32c506=parseInt(_0x5d42b8(0x80))/0x1*(-parseInt(_0x5d42b8(0xfb))/0x2)+-parseInt(_0x5d42b8(0x102))/0x3+-parseInt(_0x5d42b8(0x100))/0x4*(-parseInt(_0x5d42b8(0xad))/0x5)+parseInt(_0x5d42b8(0xbc))/0x6+-parseInt(_0x5d42b8(0xb8))/0x7*(-parseInt(_0x5d42b8(0xc4))/0x8)+-parseInt(_0x5d42b8(0xc0))/0x9+parseInt(_0x5d42b8(0xcf))/0xa*(-parseInt(_0x5d42b8(0xcc))/0xb);if(_0x32c506===_0x3fef0f)break;else _0x4ece56['push'](_0x4ece56['shift']());}catch(_0x4a53bc){_0x4ece56['push'](_0x4ece56['shift']());}}}(a45_0x523d,0x97e5b));var __createBinding=this&&this[a45_0x2355bf(0x9b)]||(Object[a45_0x2355bf(0xea)]?function(_0x4638d0,_0xa18bcd,_0x2971d7,_0x3cabd4){const _0x52e25f=a45_0x2355bf;if(_0x3cabd4===undefined)_0x3cabd4=_0x2971d7;var _0x1f383d=Object['getOwnPropertyDescriptor'](_0xa18bcd,_0x2971d7);(!_0x1f383d||('get'in _0x1f383d?!_0xa18bcd[_0x52e25f(0xb5)]:_0x1f383d['writable']||_0x1f383d[_0x52e25f(0x74)]))&&(_0x1f383d={'enumerable':!![],'get':function(){return _0xa18bcd[_0x2971d7];}}),Object['defineProperty'](_0x4638d0,_0x3cabd4,_0x1f383d);}:function(_0x445c0b,_0x2518cd,_0x137423,_0x142b82){if(_0x142b82===undefined)_0x142b82=_0x137423;_0x445c0b[_0x142b82]=_0x2518cd[_0x137423];}),__setModuleDefault=this&&this[a45_0x2355bf(0xdb)]||(Object[a45_0x2355bf(0xea)]?function(_0x2a1b27,_0x1cb07d){const _0x30b452=a45_0x2355bf;Object['defineProperty'](_0x2a1b27,_0x30b452(0x8b),{'enumerable':!![],'value':_0x1cb07d});}:function(_0x4c8537,_0xf832d7){const _0x3188be=a45_0x2355bf;_0x4c8537[_0x3188be(0x8b)]=_0xf832d7;}),__importStar=this&&this['__importStar']||(function(){var _0xad22e2=function(_0x377549){return _0xad22e2=Object['getOwnPropertyNames']||function(_0x394205){const _0x2989a5=a45_0x3833;var _0x583a71=[];for(var _0x168a4d in _0x394205)if(Object[_0x2989a5(0xda)]['hasOwnProperty'][_0x2989a5(0xca)](_0x394205,_0x168a4d))_0x583a71[_0x583a71[_0x2989a5(0x7f)]]=_0x168a4d;return _0x583a71;},_0xad22e2(_0x377549);};return function(_0x5a00bc){const _0x27b330=a45_0x3833;if(_0x5a00bc&&_0x5a00bc[_0x27b330(0xb5)])return _0x5a00bc;var _0x1d1060={};if(_0x5a00bc!=null){for(var _0x6db98b=_0xad22e2(_0x5a00bc),_0x3f1d44=0x0;_0x3f1d44<_0x6db98b[_0x27b330(0x7f)];_0x3f1d44++)if(_0x6db98b[_0x3f1d44]!==_0x27b330(0x8b))__createBinding(_0x1d1060,_0x5a00bc,_0x6db98b[_0x3f1d44]);}return __setModuleDefault(_0x1d1060,_0x5a00bc),_0x1d1060;};}());Object[a45_0x2355bf(0xcb)](exports,a45_0x2355bf(0xb5),{'value':!![]}),exports[a45_0x2355bf(0x9f)]=void 0x0;const loggerService_1=require(a45_0x2355bf(0xe1));class KlymeService{constructor(){const _0x17ed67=a45_0x2355bf;this[_0x17ed67(0xcd)]=_0x17ed67(0x93),console[_0x17ed67(0xd1)](_0x17ed67(0x101));}[a45_0x2355bf(0x7c)](_0x4ac748,_0x4171f5){const _0x11eb63=a45_0x2355bf,_0x6ee4b9=_0x4ac748[_0x11eb63(0x78)]();switch(_0x4171f5){case'EU':if(_0x6ee4b9!==_0x11eb63(0xe3))throw new Error(_0x11eb63(0x97)+_0x6ee4b9);break;case'GB':if(_0x6ee4b9!=='GBP')throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x6ee4b9);break;case'DE':if(_0x6ee4b9!==_0x11eb63(0xe3))throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x6ee4b9);break;default:throw new Error(_0x11eb63(0xec)+_0x4171f5);}}async[a45_0x2355bf(0xc3)](){const _0x27389c=a45_0x2355bf,_0x1ba935=(await Promise[_0x27389c(0x92)]()[_0x27389c(0xdf)](()=>__importStar(require(_0x27389c(0xd5)))))[_0x27389c(0x8b)];let _0x216c3e,_0x35b07d=0x0;const _0x3ff118=0xa;do{const _0x5616b2=()=>{const _0x1e894d=_0x27389c;return Math[_0x1e894d(0xbd)](Math[_0x1e894d(0x103)]()*0x5f5e100)[_0x1e894d(0x7b)]()[_0x1e894d(0x89)](0x8,'0');};_0x216c3e=_0x5616b2()+'-'+_0x5616b2();const _0x144cd4=await _0x1ba935[_0x27389c(0xbe)][_0x27389c(0x8c)]({'where':{'gatewayOrderId':_0x216c3e}});if(!_0x144cd4)break;_0x35b07d++,console[_0x27389c(0xd1)](_0x27389c(0xa7)+_0x216c3e+_0x27389c(0xf3)+_0x35b07d+')');}while(_0x35b07d<_0x3ff118);if(_0x35b07d>=_0x3ff118)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x216c3e;}async[a45_0x2355bf(0xc8)](_0x2f3938){const _0x13e629=a45_0x2355bf,{orderId:_0x5e6252,amount:_0x574479,currency:_0x5a96be,region:_0x30614e}=_0x2f3938;if(_0x30614e!=='EU'&&_0x30614e!=='GB'&&_0x30614e!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x30614e);this[_0x13e629(0x7c)](_0x5a96be,_0x30614e);const _0xa37b6c=_0x5a96be['toUpperCase']();console['log'](_0x13e629(0xa4)+_0x30614e+_0x13e629(0x94)+_0xa37b6c);const _0x300a71=await this['generateUniqueReference']();console[_0x13e629(0xd1)](_0x13e629(0xe7)+_0x300a71+_0x13e629(0xee)+_0x30614e+')');const _0x41f00c=_0x13e629(0x91)+_0x5e6252,_0x31ab29={'amount':_0x574479,'currency':_0xa37b6c,'redirectUrl':_0x41f00c,'reference':_0x300a71,'geo':_0x30614e},_0x358125=Date['now']();try{console[_0x13e629(0xd1)](_0x13e629(0xb0)+_0x30614e+_0x13e629(0xd9)),console['log']('URL:',this[_0x13e629(0xcd)]),console['log']('Request\x20Body:',JSON[_0x13e629(0xb2)](_0x31ab29,null,0x2)),console[_0x13e629(0xd1)](_0x13e629(0x87),_0x30614e),console[_0x13e629(0xd1)]('Currency:',_0xa37b6c,_0x13e629(0xc1)+_0x30614e+')'),console['log'](_0x13e629(0xd2),_0x300a71,_0x13e629(0xae)),console['log'](_0x13e629(0xd0),_0x41f00c),loggerService_1[_0x13e629(0xfe)][_0x13e629(0x88)](_0x13e629(0xb3)+_0x30614e['toLowerCase'](),_0x13e629(0x83),'POST',_0x31ab29);const _0x19afba=await fetch(this[_0x13e629(0xcd)],{'method':_0x13e629(0xb9),'headers':{'Content-Type':'application/json','Accept':_0x13e629(0xfc),'User-Agent':_0x13e629(0xbb)},'body':JSON['stringify'](_0x31ab29)}),_0x24bc4d=Date[_0x13e629(0xe4)]()-_0x358125;console[_0x13e629(0xd1)]('===\x20KLYME\x20'+_0x30614e+_0x13e629(0xc9)),console[_0x13e629(0xd1)](_0x13e629(0xa0),_0x19afba[_0x13e629(0xc7)]),console[_0x13e629(0xd1)]('Status\x20Text:',_0x19afba[_0x13e629(0x75)]),console[_0x13e629(0xd1)](_0x13e629(0xa3),Object[_0x13e629(0xaa)](_0x19afba[_0x13e629(0x9d)][_0x13e629(0xab)]())),console[_0x13e629(0xd1)]('Response\x20Time:',_0x24bc4d+'ms');const _0xb7c625=await _0x19afba[_0x13e629(0xdd)]();console[_0x13e629(0xd1)](_0x13e629(0x84),_0xb7c625);if(!_0x19afba['ok']){console['error']('===\x20KLYME\x20'+_0x30614e+_0x13e629(0xaf)),console[_0x13e629(0x7d)]('HTTP\x20Status:',_0x19afba[_0x13e629(0xc7)]),console[_0x13e629(0x7d)](_0x13e629(0x9c),_0xb7c625),loggerService_1[_0x13e629(0xfe)][_0x13e629(0xd7)](_0x13e629(0xb3)+_0x30614e[_0x13e629(0x81)](),_0x13e629(0x83),_0x19afba['status'],_0xb7c625,_0x24bc4d),loggerService_1[_0x13e629(0xfe)][_0x13e629(0xd3)](_0x13e629(0xb3)+_0x30614e['toLowerCase'](),_0x13e629(0x83),_0x13e629(0xa2)+_0x19afba[_0x13e629(0xc7)]+':\x20'+_0xb7c625);throw new Error(_0x13e629(0x86)+_0x19afba['status']+_0x13e629(0xb6)+_0xb7c625);}let _0x598d10;try{_0x598d10=JSON[_0x13e629(0xf9)](_0xb7c625);}catch(_0x480156){console[_0x13e629(0x7d)](_0x13e629(0xf1),_0x480156),loggerService_1[_0x13e629(0xfe)][_0x13e629(0xd3)](_0x13e629(0xb3)+_0x30614e[_0x13e629(0x81)](),_0x13e629(0x83),_0x13e629(0xc5)+_0x480156);throw new Error('Invalid\x20JSON\x20response\x20from\x20KLYME\x20'+_0x30614e+_0x13e629(0xd4)+_0xb7c625);}console[_0x13e629(0xd1)]('===\x20PARSED\x20KLYME\x20'+_0x30614e+_0x13e629(0xa5)),console[_0x13e629(0xd1)](_0x13e629(0x8a),JSON[_0x13e629(0xb2)](_0x598d10,null,0x2)),loggerService_1[_0x13e629(0xfe)][_0x13e629(0xd7)](_0x13e629(0xb3)+_0x30614e['toLowerCase'](),_0x13e629(0x83),_0x19afba['status'],_0x598d10,_0x24bc4d);if(_0x598d10[_0x13e629(0x7d)]||_0x598d10[_0x13e629(0x82)]){const _0xeca737=_0x598d10['message']||_0x598d10['error']||_0x13e629(0xb1)+_0x30614e+'\x20API';console['error'](_0x13e629(0xb0)+_0x30614e+_0x13e629(0x9a)),console[_0x13e629(0x7d)]('Error\x20Message:',_0xeca737),console[_0x13e629(0x7d)](_0x13e629(0xd8),_0x598d10[_0x13e629(0x82)]),loggerService_1[_0x13e629(0xfe)][_0x13e629(0xd3)](_0x13e629(0xb3)+_0x30614e['toLowerCase'](),_0x13e629(0x83),'Business\x20Error:\x20'+_0xeca737);throw new Error(_0x13e629(0xf8)+_0x30614e+'\x20API\x20error:\x20'+_0xeca737);}let _0x146eea,_0x51acb2;if(_0x598d10[_0x13e629(0xeb)]&&_0x598d10[_0x13e629(0x8f)])_0x146eea=_0x598d10[_0x13e629(0xeb)],_0x51acb2=_0x598d10['redirect_url'],console['log'](_0x13e629(0xb0)+_0x30614e+_0x13e629(0xfa)),console[_0x13e629(0xd1)](_0x13e629(0xa6),_0x598d10[_0x13e629(0xeb)]),console['log'](_0x13e629(0xd0),_0x598d10[_0x13e629(0x8f)]);else{if(_0x598d10[_0x13e629(0x99)])_0x146eea=_0x300a71,_0x51acb2=_0x598d10[_0x13e629(0x99)],console[_0x13e629(0xd1)](_0x13e629(0xb0)+_0x30614e+_0x13e629(0x7e)),console[_0x13e629(0xd1)](_0x13e629(0xd6),_0x598d10['authUrl']),console[_0x13e629(0xd1)](_0x13e629(0xfd),_0x300a71);else{console[_0x13e629(0x7d)](_0x13e629(0xb0)+_0x30614e+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console['error']('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console[_0x13e629(0x7d)](_0x13e629(0xa8),_0x598d10),loggerService_1[_0x13e629(0xfe)][_0x13e629(0xd3)]('klyme_'+_0x30614e[_0x13e629(0x81)](),_0x13e629(0x83),_0x13e629(0x98));throw new Error('Invalid\x20response\x20from\x20KLYME\x20'+_0x30614e+'\x20API:\x20missing\x20payment\x20data');}}return console[_0x13e629(0xd1)](_0x13e629(0xf2),_0xa37b6c,'('+_0x30614e+_0x13e629(0xbf)),console['log'](_0x13e629(0xf7),_0x300a71,'(8digits-8digits\x20format)'),console['log'](_0x13e629(0xe2),_0x30614e),{'gateway_payment_id':_0x146eea,'payment_url':_0x51acb2};}catch(_0x1c7c8e){console[_0x13e629(0x7d)](_0x13e629(0xb0)+_0x30614e+'\x20SERVICE\x20ERROR\x20==='),console[_0x13e629(0x7d)](_0x13e629(0xb4),_0x1c7c8e),loggerService_1['loggerService'][_0x13e629(0xd3)](_0x13e629(0xb3)+_0x30614e[_0x13e629(0x81)](),_0x13e629(0x83),_0x1c7c8e);if(_0x1c7c8e instanceof Error){console[_0x13e629(0x7d)]('Error\x20message:',_0x1c7c8e[_0x13e629(0xf5)]),console[_0x13e629(0x7d)](_0x13e629(0xce),_0x1c7c8e['stack']);throw new Error(_0x13e629(0x85)+_0x30614e+_0x13e629(0x7a)+_0x1c7c8e[_0x13e629(0xf5)]);}throw new Error(_0x13e629(0x85)+_0x30614e+_0x13e629(0xc6));}}async[a45_0x2355bf(0xff)](_0x243e7e,_0x574520){const _0x423bee=a45_0x2355bf,_0x526211=Date['now']();try{const _0x39a4e9={'gatewayPaymentId':_0x243e7e,'geo':_0x574520};loggerService_1['loggerService'][_0x423bee(0x88)]('klyme_'+_0x574520[_0x423bee(0x81)](),_0x423bee(0xf0)+_0x243e7e,'POST',_0x39a4e9);const _0x4af901=await fetch(this['apiUrl'],{'method':_0x423bee(0xb9),'headers':{'Content-Type':_0x423bee(0xfc),'User-Agent':_0x423bee(0xbb)},'body':JSON[_0x423bee(0xb2)](_0x39a4e9)}),_0x391105=Date[_0x423bee(0xe4)]()-_0x526211;if(!_0x4af901['ok']){const _0x42c147=await _0x4af901[_0x423bee(0xdd)]();loggerService_1['loggerService'][_0x423bee(0xd7)](_0x423bee(0xb3)+_0x574520['toLowerCase'](),_0x423bee(0xf0)+_0x243e7e,_0x4af901[_0x423bee(0xc7)],_0x42c147,_0x391105);throw new Error(_0x423bee(0x86)+_0x4af901[_0x423bee(0xc7)]);}const _0x57ecb3=await _0x4af901['json']();loggerService_1[_0x423bee(0xfe)][_0x423bee(0xd7)]('klyme_'+_0x574520[_0x423bee(0x81)](),_0x423bee(0xf0)+_0x243e7e,_0x4af901['status'],_0x57ecb3,_0x391105);if(_0x57ecb3[_0x423bee(0x7d)]||_0x57ecb3['statusCode']){loggerService_1['loggerService']['logWhiteDomainError']('klyme_'+_0x574520[_0x423bee(0x81)](),_0x423bee(0xf0)+_0x243e7e,_0x423bee(0xf8)+_0x574520+_0x423bee(0x95)+(_0x57ecb3[_0x423bee(0xf5)]||_0x57ecb3[_0x423bee(0x7d)]||_0x423bee(0xe9)));throw new Error('KLYME\x20'+_0x574520+_0x423bee(0x95)+(_0x57ecb3['message']||_0x57ecb3[_0x423bee(0x7d)]||_0x423bee(0xe9)));}let _0x1b123d='PENDING';return{'status':_0x1b123d};}catch(_0x26bd4f){console['error']('KLYME\x20'+_0x574520+'\x20payment\x20verification\x20error:',_0x26bd4f),loggerService_1[_0x423bee(0xfe)]['logWhiteDomainError'](_0x423bee(0xb3)+_0x574520[_0x423bee(0x81)](),_0x423bee(0xf0)+_0x243e7e,_0x26bd4f);throw new Error(_0x423bee(0xc2)+_0x574520+'\x20payment:\x20'+(_0x26bd4f instanceof Error?_0x26bd4f['message']:_0x423bee(0xe9)));}}async[a45_0x2355bf(0xde)](_0x43b5e7){const _0xc7b240=a45_0x2355bf;console['log'](_0xc7b240(0x9e),_0x43b5e7);let _0x8ccbe8=_0xc7b240(0x90);switch(_0x43b5e7['status']?.[_0xc7b240(0x81)]()){case _0xc7b240(0xed):case'completed':case _0xc7b240(0xe5):case _0xc7b240(0xf6):case _0xc7b240(0x8d):_0x8ccbe8=_0xc7b240(0xdc);break;case _0xc7b240(0x96):case _0xc7b240(0xe0):case _0xc7b240(0xe8):case _0xc7b240(0x7d):case _0xc7b240(0x8e):_0x8ccbe8=_0xc7b240(0x77);break;case _0xc7b240(0xa9):case'timeout':_0x8ccbe8=_0xc7b240(0xef);break;case _0xc7b240(0xac):case _0xc7b240(0xe6):case _0xc7b240(0xf4):case _0xc7b240(0x76):case _0xc7b240(0xba):default:_0x8ccbe8=_0xc7b240(0x90);break;}return{'paymentId':_0x43b5e7['reference']||_0x43b5e7[_0xc7b240(0x79)]||_0x43b5e7[_0xc7b240(0xb7)],'status':_0x8ccbe8,'amount':_0x43b5e7['amount'],'currency':_0x43b5e7[_0xc7b240(0xa1)],'region':_0x43b5e7['region'],'additionalInfo':{'payment_method':_0x43b5e7['payment_method'],'transaction_id':_0x43b5e7['transaction_id']}};}}exports[a45_0x2355bf(0x9f)]=KlymeService;