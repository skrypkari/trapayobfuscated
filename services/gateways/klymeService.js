'use strict';const a50_0x1341d1=a50_0x55cb;(function(_0x260dfc,_0x100a3f){const _0x2e2445=a50_0x55cb,_0x11bfba=_0x260dfc();while(!![]){try{const _0x489ea9=parseInt(_0x2e2445(0x223))/0x1+parseInt(_0x2e2445(0x1d7))/0x2*(-parseInt(_0x2e2445(0x1dc))/0x3)+-parseInt(_0x2e2445(0x22a))/0x4+parseInt(_0x2e2445(0x202))/0x5+parseInt(_0x2e2445(0x228))/0x6+-parseInt(_0x2e2445(0x1e1))/0x7+-parseInt(_0x2e2445(0x229))/0x8*(-parseInt(_0x2e2445(0x1ef))/0x9);if(_0x489ea9===_0x100a3f)break;else _0x11bfba['push'](_0x11bfba['shift']());}catch(_0x9d84b8){_0x11bfba['push'](_0x11bfba['shift']());}}}(a50_0x18c0,0xe52a8));function a50_0x18c0(){const _0x395e9a=['successful','klyme_','cancelled','\x20RESPONSE\x20===','processWebhook','default','Error\x20Message:','Failed\x20to\x20create\x20KLYME\x20','status','rejected','fromEntries','8488170nXGCjx','pending','headers','prototype','floor','failed','https://tesoft.uk/gateway/pending.php?id=','\x20API\x20error:\x20','\x20API:\x20','loggerService','parse','EUR','__esModule','Failed\x20to\x20verify\x20KLYME\x20','authUrl','log','toLowerCase','Processing\x20KLYME\x20webhook:','EXPIRED','\x20currency\x20validation\x20passed:\x20','now','Failed\x20to\x20parse\x20JSON\x20response:','Payment\x20System/1.0','https://tesoft.uk/gateway/klyme/','validateCurrencyForRegion','KLYME\x20','PAID','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','amount','random','===\x20KLYME\x20','logWhiteDomainResponse','Unsupported\x20KLYME\x20region:\x20','173159vMOmCH','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','logWhiteDomainError','defineProperty','2894340gLumdb','8mvxVZb','6220880GrRKDT','redirect_url','UUID:','\x20(8digits-8digits\x20format\x20for\x20','call','/create','__importStar','writable','/verify/','uuid','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','generateUniqueReference','Redirect\x20URL:','payment_id','padStart','Unknown\x20error','\x20API:\x20missing\x20payment\x20data','canceled','Headers:','transaction_id','timeout','Business\x20Error:\x20','stack','Response\x20Time:','statusCode','toUpperCase','apiUrl','getOwnPropertyNames','\x20API\x20ERROR\x20===','Raw\x20Response\x20Body:','configurable','Invalid\x20response\x20from\x20KLYME\x20','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','JSON\x20Parse\x20Error:\x20','then','\x20API\x20BUSINESS\x20ERROR\x20===','getOwnPropertyDescriptor','resolve','Status\x20Text:','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','Error\x20details:','Response\x20Body:','\x20payment:\x20','__setModuleDefault','payment','hasOwnProperty','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','error','stringify','region','(8digits-8digits\x20format)','Error\x20message:','payment_method','4exjumS','get','length','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','logWhiteDomainRequest','838602ppqARC','Reference\x20Used\x20as\x20ID:','\x20payment\x20verification\x20error:','POST','\x20API','2027200cWMREg','application/json','Geo\x20Parameter:','../loggerService','confirmed','PENDING','\x20validated)','text','\x20SUCCESS\x20(New\x20Format)\x20===','message','Status\x20Code:',',\x20body:\x20','Auth\x20URL:','expired','8904321rtAvgK','create','completed','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','created','Reference:','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','active'];a50_0x18c0=function(){return _0x395e9a;};return a50_0x18c0();}function a50_0x55cb(_0x4d9175,_0x463c68){const _0x18c03d=a50_0x18c0();return a50_0x55cb=function(_0x55cbc2,_0x2de640){_0x55cbc2=_0x55cbc2-0x1ca;let _0x14fa9a=_0x18c03d[_0x55cbc2];return _0x14fa9a;},a50_0x55cb(_0x4d9175,_0x463c68);}var __createBinding=this&&this['__createBinding']||(Object[a50_0x1341d1(0x1f0)]?function(_0x39da28,_0xe1b042,_0x45927b,_0xad80c4){const _0x37ec1d=a50_0x1341d1;if(_0xad80c4===undefined)_0xad80c4=_0x45927b;var _0x2a1c1e=Object[_0x37ec1d(0x24e)](_0xe1b042,_0x45927b);(!_0x2a1c1e||(_0x37ec1d(0x1d8)in _0x2a1c1e?!_0xe1b042[_0x37ec1d(0x20e)]:_0x2a1c1e[_0x37ec1d(0x231)]||_0x2a1c1e[_0x37ec1d(0x248)]))&&(_0x2a1c1e={'enumerable':!![],'get':function(){return _0xe1b042[_0x45927b];}}),Object['defineProperty'](_0x39da28,_0xad80c4,_0x2a1c1e);}:function(_0x4ce894,_0x52f8b8,_0x6266cc,_0x13a756){if(_0x13a756===undefined)_0x13a756=_0x6266cc;_0x4ce894[_0x13a756]=_0x52f8b8[_0x6266cc];}),__setModuleDefault=this&&this[a50_0x1341d1(0x1cd)]||(Object['create']?function(_0xae9ee2,_0x37d4ed){const _0x4493be=a50_0x1341d1;Object[_0x4493be(0x227)](_0xae9ee2,_0x4493be(0x1fc),{'enumerable':!![],'value':_0x37d4ed});}:function(_0x2807a4,_0x5f0195){const _0x2f1df0=a50_0x1341d1;_0x2807a4[_0x2f1df0(0x1fc)]=_0x5f0195;}),__importStar=this&&this[a50_0x1341d1(0x230)]||(function(){var _0x21f988=function(_0x296f53){const _0x3568cc=a50_0x55cb;return _0x21f988=Object[_0x3568cc(0x245)]||function(_0x3c9a63){const _0x2dc7fa=_0x3568cc;var _0x3284c4=[];for(var _0x506a0a in _0x3c9a63)if(Object[_0x2dc7fa(0x205)][_0x2dc7fa(0x1cf)][_0x2dc7fa(0x22e)](_0x3c9a63,_0x506a0a))_0x3284c4[_0x3284c4[_0x2dc7fa(0x1d9)]]=_0x506a0a;return _0x3284c4;},_0x21f988(_0x296f53);};return function(_0x472c44){const _0x1ee089=a50_0x55cb;if(_0x472c44&&_0x472c44[_0x1ee089(0x20e)])return _0x472c44;var _0x430408={};if(_0x472c44!=null){for(var _0x498472=_0x21f988(_0x472c44),_0x49327b=0x0;_0x49327b<_0x498472['length'];_0x49327b++)if(_0x498472[_0x49327b]!==_0x1ee089(0x1fc))__createBinding(_0x430408,_0x472c44,_0x498472[_0x49327b]);}return __setModuleDefault(_0x430408,_0x472c44),_0x430408;};}());Object[a50_0x1341d1(0x227)](exports,a50_0x1341d1(0x20e),{'value':!![]}),exports['KlymeService']=void 0x0;const loggerService_1=require(a50_0x1341d1(0x1e4));class KlymeService{constructor(){const _0x5c5e3f=a50_0x1341d1;this[_0x5c5e3f(0x244)]=_0x5c5e3f(0x219),console[_0x5c5e3f(0x211)]('üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions');}[a50_0x1341d1(0x21a)](_0x3fd79a,_0x217875){const _0x387215=a50_0x1341d1,_0x1dc839=_0x3fd79a[_0x387215(0x243)]();switch(_0x217875){case'EU':if(_0x1dc839!==_0x387215(0x20d))throw new Error(_0x387215(0x1f2)+_0x1dc839);break;case'GB':if(_0x1dc839!=='GBP')throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x1dc839);break;case'DE':if(_0x1dc839!=='EUR')throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x1dc839);break;default:throw new Error(_0x387215(0x222)+_0x217875);}}async[a50_0x1341d1(0x235)](){const _0x497fd8=a50_0x1341d1,_0x4d2da7=(await Promise[_0x497fd8(0x24f)]()[_0x497fd8(0x24c)](()=>__importStar(require('../../config/database'))))[_0x497fd8(0x1fc)];let _0x17ad6b,_0x65d717=0x0;const _0x474d60=0xa;do{const _0x2fe062=()=>{const _0x391f69=_0x497fd8;return Math[_0x391f69(0x206)](Math[_0x391f69(0x21f)]()*0x5f5e100)['toString']()[_0x391f69(0x238)](0x8,'0');};_0x17ad6b=_0x2fe062()+'-'+_0x2fe062();const _0x544cf1=await _0x4d2da7[_0x497fd8(0x1ce)]['findFirst']({'where':{'gatewayOrderId':_0x17ad6b}});if(!_0x544cf1)break;_0x65d717++,console['log']('‚ö†Ô∏è\x20KLYME\x20reference\x20'+_0x17ad6b+_0x497fd8(0x251)+_0x65d717+')');}while(_0x65d717<_0x474d60);if(_0x65d717>=_0x474d60)throw new Error(_0x497fd8(0x1da));return _0x17ad6b;}async['createPaymentLink'](_0x5da296){const _0x4439d3=a50_0x1341d1,{orderId:_0x12dbf0,amount:_0x57b6b0,currency:_0xd9af69,region:_0x309fbb}=_0x5da296;if(_0x309fbb!=='EU'&&_0x309fbb!=='GB'&&_0x309fbb!=='DE')throw new Error(_0x4439d3(0x24a)+_0x309fbb);this['validateCurrencyForRegion'](_0xd9af69,_0x309fbb);const _0x3197eb=_0xd9af69[_0x4439d3(0x243)]();console[_0x4439d3(0x211)]('üí≥\x20KLYME\x20'+_0x309fbb+_0x4439d3(0x215)+_0x3197eb);const _0x495920=await this['generateUniqueReference']();console['log'](_0x4439d3(0x21d)+_0x495920+_0x4439d3(0x22d)+_0x309fbb+')');const _0x5d24ce=_0x4439d3(0x208)+_0x12dbf0,_0x4d6bc0={'amount':_0x57b6b0,'currency':_0x3197eb,'redirectUrl':_0x5d24ce,'reference':_0x495920,'geo':_0x309fbb},_0x2a9ec0=Date['now']();try{console[_0x4439d3(0x211)](_0x4439d3(0x220)+_0x309fbb+_0x4439d3(0x234)),console[_0x4439d3(0x211)]('URL:',this[_0x4439d3(0x244)]),console[_0x4439d3(0x211)]('Request\x20Body:',JSON[_0x4439d3(0x1d2)](_0x4d6bc0,null,0x2)),console['log']('Region\x20(geo):',_0x309fbb),console[_0x4439d3(0x211)]('Currency:',_0x3197eb,'(validated\x20for\x20'+_0x309fbb+')'),console['log'](_0x4439d3(0x1f4),_0x495920,_0x4439d3(0x1d4)),console[_0x4439d3(0x211)](_0x4439d3(0x236),_0x5d24ce),loggerService_1['loggerService'][_0x4439d3(0x1db)](_0x4439d3(0x1f8)+_0x309fbb[_0x4439d3(0x212)](),'/create',_0x4439d3(0x1df),_0x4d6bc0);const _0x200cf3=await fetch(this[_0x4439d3(0x244)],{'method':_0x4439d3(0x1df),'headers':{'Content-Type':_0x4439d3(0x1e2),'Accept':'application/json','User-Agent':_0x4439d3(0x218)},'body':JSON[_0x4439d3(0x1d2)](_0x4d6bc0)}),_0x120ee6=Date[_0x4439d3(0x216)]()-_0x2a9ec0;console['log'](_0x4439d3(0x220)+_0x309fbb+_0x4439d3(0x225)),console[_0x4439d3(0x211)]('Status:',_0x200cf3['status']),console[_0x4439d3(0x211)](_0x4439d3(0x250),_0x200cf3['statusText']),console['log'](_0x4439d3(0x23c),Object[_0x4439d3(0x201)](_0x200cf3[_0x4439d3(0x204)]['entries']())),console[_0x4439d3(0x211)](_0x4439d3(0x241),_0x120ee6+'ms');const _0x18a18e=await _0x200cf3[_0x4439d3(0x1e8)]();console[_0x4439d3(0x211)](_0x4439d3(0x247),_0x18a18e);if(!_0x200cf3['ok']){console[_0x4439d3(0x1d1)](_0x4439d3(0x220)+_0x309fbb+_0x4439d3(0x246)),console[_0x4439d3(0x1d1)]('HTTP\x20Status:',_0x200cf3[_0x4439d3(0x1ff)]),console[_0x4439d3(0x1d1)](_0x4439d3(0x1cb),_0x18a18e),loggerService_1[_0x4439d3(0x20b)][_0x4439d3(0x221)]('klyme_'+_0x309fbb[_0x4439d3(0x212)](),_0x4439d3(0x22f),_0x200cf3[_0x4439d3(0x1ff)],_0x18a18e,_0x120ee6),loggerService_1['loggerService'][_0x4439d3(0x226)](_0x4439d3(0x1f8)+_0x309fbb[_0x4439d3(0x212)](),_0x4439d3(0x22f),'HTTP\x20'+_0x200cf3[_0x4439d3(0x1ff)]+':\x20'+_0x18a18e);throw new Error('HTTP\x20error!\x20status:\x20'+_0x200cf3[_0x4439d3(0x1ff)]+_0x4439d3(0x1ec)+_0x18a18e);}let _0x4d6971;try{_0x4d6971=JSON[_0x4439d3(0x20c)](_0x18a18e);}catch(_0x14d26b){console[_0x4439d3(0x1d1)](_0x4439d3(0x217),_0x14d26b),loggerService_1[_0x4439d3(0x20b)]['logWhiteDomainError'](_0x4439d3(0x1f8)+_0x309fbb[_0x4439d3(0x212)](),_0x4439d3(0x22f),_0x4439d3(0x24b)+_0x14d26b);throw new Error(_0x4439d3(0x1d0)+_0x309fbb+_0x4439d3(0x20a)+_0x18a18e);}console[_0x4439d3(0x211)]('===\x20PARSED\x20KLYME\x20'+_0x309fbb+_0x4439d3(0x1fa)),console[_0x4439d3(0x211)]('Parsed\x20Result:',JSON[_0x4439d3(0x1d2)](_0x4d6971,null,0x2)),loggerService_1['loggerService'][_0x4439d3(0x221)](_0x4439d3(0x1f8)+_0x309fbb['toLowerCase'](),_0x4439d3(0x22f),_0x200cf3[_0x4439d3(0x1ff)],_0x4d6971,_0x120ee6);if(_0x4d6971[_0x4439d3(0x1d1)]||_0x4d6971[_0x4439d3(0x242)]){const _0x5c0d74=_0x4d6971[_0x4439d3(0x1ea)]||_0x4d6971['error']||'Unknown\x20error\x20from\x20KLYME\x20'+_0x309fbb+_0x4439d3(0x1e0);console[_0x4439d3(0x1d1)]('===\x20KLYME\x20'+_0x309fbb+_0x4439d3(0x24d)),console['error'](_0x4439d3(0x1fd),_0x5c0d74),console['error'](_0x4439d3(0x1eb),_0x4d6971[_0x4439d3(0x242)]),loggerService_1[_0x4439d3(0x20b)]['logWhiteDomainError'](_0x4439d3(0x1f8)+_0x309fbb[_0x4439d3(0x212)](),_0x4439d3(0x22f),_0x4439d3(0x23f)+_0x5c0d74);throw new Error(_0x4439d3(0x21b)+_0x309fbb+_0x4439d3(0x209)+_0x5c0d74);}let _0x21cad7,_0xbde8f8;if(_0x4d6971['uuid']&&_0x4d6971['redirect_url'])_0x21cad7=_0x4d6971[_0x4439d3(0x233)],_0xbde8f8=_0x4d6971['redirect_url'],console[_0x4439d3(0x211)](_0x4439d3(0x220)+_0x309fbb+_0x4439d3(0x1e9)),console[_0x4439d3(0x211)](_0x4439d3(0x22c),_0x4d6971[_0x4439d3(0x233)]),console[_0x4439d3(0x211)]('Redirect\x20URL:',_0x4d6971[_0x4439d3(0x22b)]);else{if(_0x4d6971[_0x4439d3(0x210)])_0x21cad7=_0x495920,_0xbde8f8=_0x4d6971[_0x4439d3(0x210)],console[_0x4439d3(0x211)](_0x4439d3(0x220)+_0x309fbb+'\x20SUCCESS\x20(Legacy\x20Format)\x20==='),console[_0x4439d3(0x211)](_0x4439d3(0x1ed),_0x4d6971[_0x4439d3(0x210)]),console[_0x4439d3(0x211)](_0x4439d3(0x1dd),_0x495920);else{console[_0x4439d3(0x1d1)](_0x4439d3(0x220)+_0x309fbb+_0x4439d3(0x1f5)),console[_0x4439d3(0x1d1)]('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console[_0x4439d3(0x1d1)]('Response\x20data:',_0x4d6971),loggerService_1[_0x4439d3(0x20b)][_0x4439d3(0x226)](_0x4439d3(0x1f8)+_0x309fbb[_0x4439d3(0x212)](),'/create',_0x4439d3(0x224));throw new Error(_0x4439d3(0x249)+_0x309fbb+_0x4439d3(0x23a));}}return console[_0x4439d3(0x211)]('Currency\x20Used:',_0x3197eb,'('+_0x309fbb+_0x4439d3(0x1e7)),console['log']('Reference\x20Used:',_0x495920,_0x4439d3(0x1d4)),console[_0x4439d3(0x211)](_0x4439d3(0x1e3),_0x309fbb),{'gateway_payment_id':_0x21cad7,'payment_url':_0xbde8f8};}catch(_0x1dd598){console[_0x4439d3(0x1d1)](_0x4439d3(0x220)+_0x309fbb+'\x20SERVICE\x20ERROR\x20==='),console['error'](_0x4439d3(0x1ca),_0x1dd598),loggerService_1[_0x4439d3(0x20b)][_0x4439d3(0x226)](_0x4439d3(0x1f8)+_0x309fbb[_0x4439d3(0x212)](),'/create',_0x1dd598);if(_0x1dd598 instanceof Error){console['error'](_0x4439d3(0x1d5),_0x1dd598['message']),console[_0x4439d3(0x1d1)]('Error\x20stack:',_0x1dd598[_0x4439d3(0x240)]);throw new Error(_0x4439d3(0x1fe)+_0x309fbb+'\x20payment\x20link:\x20'+_0x1dd598[_0x4439d3(0x1ea)]);}throw new Error(_0x4439d3(0x1fe)+_0x309fbb+'\x20payment\x20link:\x20Unknown\x20error');}}async['verifyPayment'](_0x88216,_0x397604){const _0x1b474d=a50_0x1341d1,_0x205fcc=Date['now']();try{const _0x29de07={'gatewayPaymentId':_0x88216,'geo':_0x397604};loggerService_1[_0x1b474d(0x20b)][_0x1b474d(0x1db)](_0x1b474d(0x1f8)+_0x397604[_0x1b474d(0x212)](),_0x1b474d(0x232)+_0x88216,_0x1b474d(0x1df),_0x29de07);const _0x302aff=await fetch(this[_0x1b474d(0x244)],{'method':_0x1b474d(0x1df),'headers':{'Content-Type':_0x1b474d(0x1e2),'User-Agent':_0x1b474d(0x218)},'body':JSON[_0x1b474d(0x1d2)](_0x29de07)}),_0x3726bb=Date[_0x1b474d(0x216)]()-_0x205fcc;if(!_0x302aff['ok']){const _0x2a61d0=await _0x302aff[_0x1b474d(0x1e8)]();loggerService_1[_0x1b474d(0x20b)][_0x1b474d(0x221)](_0x1b474d(0x1f8)+_0x397604[_0x1b474d(0x212)](),'/verify/'+_0x88216,_0x302aff[_0x1b474d(0x1ff)],_0x2a61d0,_0x3726bb);throw new Error('HTTP\x20error!\x20status:\x20'+_0x302aff[_0x1b474d(0x1ff)]);}const _0x4b2c9c=await _0x302aff['json']();loggerService_1['loggerService'][_0x1b474d(0x221)](_0x1b474d(0x1f8)+_0x397604['toLowerCase'](),_0x1b474d(0x232)+_0x88216,_0x302aff[_0x1b474d(0x1ff)],_0x4b2c9c,_0x3726bb);if(_0x4b2c9c[_0x1b474d(0x1d1)]||_0x4b2c9c[_0x1b474d(0x242)]){loggerService_1[_0x1b474d(0x20b)][_0x1b474d(0x226)]('klyme_'+_0x397604[_0x1b474d(0x212)](),_0x1b474d(0x232)+_0x88216,_0x1b474d(0x21b)+_0x397604+_0x1b474d(0x209)+(_0x4b2c9c['message']||_0x4b2c9c[_0x1b474d(0x1d1)]||'Unknown\x20error'));throw new Error('KLYME\x20'+_0x397604+_0x1b474d(0x209)+(_0x4b2c9c['message']||_0x4b2c9c[_0x1b474d(0x1d1)]||_0x1b474d(0x239)));}let _0x3004f6=_0x1b474d(0x1e6);return{'status':_0x3004f6};}catch(_0x533b95){console[_0x1b474d(0x1d1)](_0x1b474d(0x21b)+_0x397604+_0x1b474d(0x1de),_0x533b95),loggerService_1[_0x1b474d(0x20b)]['logWhiteDomainError'](_0x1b474d(0x1f8)+_0x397604['toLowerCase'](),_0x1b474d(0x232)+_0x88216,_0x533b95);throw new Error(_0x1b474d(0x20f)+_0x397604+_0x1b474d(0x1cc)+(_0x533b95 instanceof Error?_0x533b95['message']:_0x1b474d(0x239)));}}async[a50_0x1341d1(0x1fb)](_0x1ffa4f){const _0x270790=a50_0x1341d1;console[_0x270790(0x211)](_0x270790(0x213),_0x1ffa4f);let _0x4153b7=_0x270790(0x1e6);switch(_0x1ffa4f[_0x270790(0x1ff)]?.['toLowerCase']()){case'paid':case _0x270790(0x1f1):case _0x270790(0x1e5):case'success':case _0x270790(0x1f7):_0x4153b7=_0x270790(0x21c);break;case _0x270790(0x1f9):case _0x270790(0x23b):case _0x270790(0x207):case'error':case _0x270790(0x200):_0x4153b7='FAILED';break;case _0x270790(0x1ee):case _0x270790(0x23e):_0x4153b7=_0x270790(0x214);break;case _0x270790(0x203):case _0x270790(0x1f3):case _0x270790(0x1f6):case'processing':case'in_progress':default:_0x4153b7=_0x270790(0x1e6);break;}return{'paymentId':_0x1ffa4f['reference']||_0x1ffa4f['order_id']||_0x1ffa4f[_0x270790(0x237)],'status':_0x4153b7,'amount':_0x1ffa4f[_0x270790(0x21e)],'currency':_0x1ffa4f['currency'],'region':_0x1ffa4f[_0x270790(0x1d3)],'additionalInfo':{'payment_method':_0x1ffa4f[_0x270790(0x1d6)],'transaction_id':_0x1ffa4f[_0x270790(0x23d)]}};}}exports['KlymeService']=KlymeService;