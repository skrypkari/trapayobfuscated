'use strict';const a41_0x11362f=a41_0x3c89;(function(_0xc3d339,_0x328145){const _0x243498=a41_0x3c89,_0x4fcf85=_0xc3d339();while(!![]){try{const _0xbe3c98=parseInt(_0x243498(0xc2))/0x1+parseInt(_0x243498(0xa1))/0x2+-parseInt(_0x243498(0xec))/0x3*(parseInt(_0x243498(0x11e))/0x4)+-parseInt(_0x243498(0x100))/0x5+parseInt(_0x243498(0x120))/0x6+parseInt(_0x243498(0xe9))/0x7+parseInt(_0x243498(0xce))/0x8*(-parseInt(_0x243498(0xd6))/0x9);if(_0xbe3c98===_0x328145)break;else _0x4fcf85['push'](_0x4fcf85['shift']());}catch(_0x2bea1a){_0x4fcf85['push'](_0x4fcf85['shift']());}}}(a41_0x128e,0x543e2));var __createBinding=this&&this[a41_0x11362f(0x137)]||(Object[a41_0x11362f(0x122)]?function(_0x21f1df,_0x3f0fe3,_0x2db820,_0x3e6214){const _0x3ce97f=a41_0x11362f;if(_0x3e6214===undefined)_0x3e6214=_0x2db820;var _0x2765b1=Object[_0x3ce97f(0xea)](_0x3f0fe3,_0x2db820);(!_0x2765b1||('get'in _0x2765b1?!_0x3f0fe3[_0x3ce97f(0xfa)]:_0x2765b1[_0x3ce97f(0xff)]||_0x2765b1['configurable']))&&(_0x2765b1={'enumerable':!![],'get':function(){return _0x3f0fe3[_0x2db820];}}),Object[_0x3ce97f(0xad)](_0x21f1df,_0x3e6214,_0x2765b1);}:function(_0x36f9e8,_0x2f8056,_0x5a8a87,_0xb41d5c){if(_0xb41d5c===undefined)_0xb41d5c=_0x5a8a87;_0x36f9e8[_0xb41d5c]=_0x2f8056[_0x5a8a87];}),__setModuleDefault=this&&this[a41_0x11362f(0x132)]||(Object[a41_0x11362f(0x122)]?function(_0x50b553,_0x45a309){const _0x3ca768=a41_0x11362f;Object[_0x3ca768(0xad)](_0x50b553,_0x3ca768(0xa5),{'enumerable':!![],'value':_0x45a309});}:function(_0x37abb8,_0xa3d1d){const _0x2a2275=a41_0x11362f;_0x37abb8[_0x2a2275(0xa5)]=_0xa3d1d;}),__importStar=this&&this[a41_0x11362f(0xa9)]||(function(){var _0x551e89=function(_0x2aaa7a){const _0xe487b4=a41_0x3c89;return _0x551e89=Object[_0xe487b4(0xf3)]||function(_0x1de857){const _0x1de8f8=_0xe487b4;var _0x4972f5=[];for(var _0x542626 in _0x1de857)if(Object[_0x1de8f8(0xef)]['hasOwnProperty'][_0x1de8f8(0x12d)](_0x1de857,_0x542626))_0x4972f5[_0x4972f5[_0x1de8f8(0x109)]]=_0x542626;return _0x4972f5;},_0x551e89(_0x2aaa7a);};return function(_0x394efc){const _0x1ba6a6=a41_0x3c89;if(_0x394efc&&_0x394efc[_0x1ba6a6(0xfa)])return _0x394efc;var _0x350d90={};if(_0x394efc!=null){for(var _0x36e7f7=_0x551e89(_0x394efc),_0x488e75=0x0;_0x488e75<_0x36e7f7['length'];_0x488e75++)if(_0x36e7f7[_0x488e75]!==_0x1ba6a6(0xa5))__createBinding(_0x350d90,_0x394efc,_0x36e7f7[_0x488e75]);}return __setModuleDefault(_0x350d90,_0x394efc),_0x350d90;};}());Object[a41_0x11362f(0xad)](exports,a41_0x11362f(0xfa),{'value':!![]}),exports['KlymeService']=void 0x0;const loggerService_1=require('../loggerService');class KlymeService{constructor(){const _0x5f2983=a41_0x11362f;this[_0x5f2983(0xc4)]=_0x5f2983(0xcf),console[_0x5f2983(0xa8)]('üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions');}['validateCurrencyForRegion'](_0x14711a,_0x1973c5){const _0x388ba3=a41_0x11362f,_0x9c8443=_0x14711a['toUpperCase']();switch(_0x1973c5){case'EU':if(_0x9c8443!=='EUR')throw new Error(_0x388ba3(0xb8)+_0x9c8443);break;case'GB':if(_0x9c8443!==_0x388ba3(0x12f))throw new Error(_0x388ba3(0x107)+_0x9c8443);break;case'DE':if(_0x9c8443!=='EUR')throw new Error(_0x388ba3(0x134)+_0x9c8443);break;default:throw new Error(_0x388ba3(0xb4)+_0x1973c5);}}async[a41_0x11362f(0xdf)](){const _0x509c53=a41_0x11362f,_0x3aa256=(await Promise[_0x509c53(0xb6)]()[_0x509c53(0xa4)](()=>__importStar(require(_0x509c53(0x119)))))[_0x509c53(0xa5)];let _0x551a3c,_0x7b3a58=0x0;const _0x199c4a=0xa;do{const _0x169133=()=>{const _0x39b169=_0x509c53;return Math[_0x39b169(0xbb)](Math[_0x39b169(0xe5)]()*0x5f5e100)[_0x39b169(0x13a)]()[_0x39b169(0x12b)](0x8,'0');};_0x551a3c=_0x169133()+'-'+_0x169133();const _0x227835=await _0x3aa256[_0x509c53(0xd2)]['findFirst']({'where':{'gatewayOrderId':_0x551a3c}});if(!_0x227835)break;_0x7b3a58++,console[_0x509c53(0xa8)]('‚ö†Ô∏è\x20KLYME\x20reference\x20'+_0x551a3c+_0x509c53(0xe8)+_0x7b3a58+')');}while(_0x7b3a58<_0x199c4a);if(_0x7b3a58>=_0x199c4a)throw new Error(_0x509c53(0xd9));return _0x551a3c;}async[a41_0x11362f(0x10f)](_0x345bfe){const _0x526436=a41_0x11362f,{orderId:_0x574690,amount:_0x3b4a13,currency:_0x4648f5,region:_0x54b575}=_0x345bfe;if(_0x54b575!=='EU'&&_0x54b575!=='GB'&&_0x54b575!=='DE')throw new Error(_0x526436(0xa3)+_0x54b575);this[_0x526436(0xf5)](_0x4648f5,_0x54b575);const _0x5d14e0=_0x4648f5[_0x526436(0x13b)]();console[_0x526436(0xa8)](_0x526436(0xa0)+_0x54b575+_0x526436(0x10e)+_0x5d14e0);const _0x42a526=await this['generateUniqueReference']();console[_0x526436(0xa8)](_0x526436(0xf6)+_0x42a526+_0x526436(0xd7)+_0x54b575+')');const _0x5d7def='https://tesoft.uk/gateway/pending.php?id='+_0x574690,_0x1e0286={'amount':_0x3b4a13,'currency':_0x5d14e0,'redirectUrl':_0x5d7def,'reference':_0x42a526,'geo':_0x54b575},_0x3f95f0=Date[_0x526436(0x11a)]();try{console[_0x526436(0xa8)](_0x526436(0x115)+_0x54b575+_0x526436(0xc1)),console['log'](_0x526436(0x10b),this['apiUrl']),console['log'](_0x526436(0xc0),JSON[_0x526436(0x129)](_0x1e0286,null,0x2)),console[_0x526436(0xa8)](_0x526436(0xc3),_0x54b575),console[_0x526436(0xa8)](_0x526436(0xf8),_0x5d14e0,_0x526436(0x135)+_0x54b575+')'),console[_0x526436(0xa8)](_0x526436(0xee),_0x42a526,_0x526436(0xd4)),console[_0x526436(0xa8)](_0x526436(0x131),_0x5d7def),loggerService_1[_0x526436(0x116)][_0x526436(0xbc)](_0x526436(0xbf)+_0x54b575[_0x526436(0xbe)](),_0x526436(0xf0),_0x526436(0xe0),_0x1e0286);const _0x1fe703=await fetch(this[_0x526436(0xc4)],{'method':_0x526436(0xe0),'headers':{'Content-Type':_0x526436(0x105),'Accept':_0x526436(0x105),'User-Agent':_0x526436(0x121)},'body':JSON[_0x526436(0x129)](_0x1e0286)}),_0x17c5a3=Date[_0x526436(0x11a)]()-_0x3f95f0;console[_0x526436(0xa8)]('===\x20KLYME\x20'+_0x54b575+_0x526436(0xaa)),console[_0x526436(0xa8)](_0x526436(0x138),_0x1fe703[_0x526436(0xe7)]),console[_0x526436(0xa8)](_0x526436(0xaf),_0x1fe703[_0x526436(0x125)]),console[_0x526436(0xa8)](_0x526436(0xe4),Object[_0x526436(0x12c)](_0x1fe703[_0x526436(0xc9)][_0x526436(0xeb)]())),console[_0x526436(0xa8)](_0x526436(0x11b),_0x17c5a3+'ms');const _0x363c64=await _0x1fe703[_0x526436(0xd1)]();console[_0x526436(0xa8)](_0x526436(0xbd),_0x363c64);if(!_0x1fe703['ok']){console[_0x526436(0x133)]('===\x20KLYME\x20'+_0x54b575+_0x526436(0x110)),console['error']('HTTP\x20Status:',_0x1fe703[_0x526436(0xe7)]),console[_0x526436(0x133)](_0x526436(0x106),_0x363c64),loggerService_1[_0x526436(0x116)]['logWhiteDomainResponse'](_0x526436(0xbf)+_0x54b575['toLowerCase'](),_0x526436(0xf0),_0x1fe703[_0x526436(0xe7)],_0x363c64,_0x17c5a3),loggerService_1['loggerService'][_0x526436(0xa6)]('klyme_'+_0x54b575[_0x526436(0xbe)](),'/create',_0x526436(0xf7)+_0x1fe703[_0x526436(0xe7)]+':\x20'+_0x363c64);throw new Error(_0x526436(0xc5)+_0x1fe703['status']+_0x526436(0x118)+_0x363c64);}let _0x761113;try{_0x761113=JSON[_0x526436(0xe3)](_0x363c64);}catch(_0x2b9f65){console[_0x526436(0x133)](_0x526436(0xd3),_0x2b9f65),loggerService_1['loggerService'][_0x526436(0xa6)]('klyme_'+_0x54b575[_0x526436(0xbe)](),_0x526436(0xf0),_0x526436(0x12a)+_0x2b9f65);throw new Error(_0x526436(0xcc)+_0x54b575+_0x526436(0xab)+_0x363c64);}console['log'](_0x526436(0xb7)+_0x54b575+_0x526436(0xfb)),console[_0x526436(0xa8)]('Parsed\x20Result:',JSON['stringify'](_0x761113,null,0x2)),loggerService_1[_0x526436(0x116)][_0x526436(0x11f)]('klyme_'+_0x54b575[_0x526436(0xbe)](),_0x526436(0xf0),_0x1fe703[_0x526436(0xe7)],_0x761113,_0x17c5a3);if(_0x761113[_0x526436(0x133)]||_0x761113[_0x526436(0x130)]){const _0x2493fb=_0x761113[_0x526436(0x123)]||_0x761113['error']||'Unknown\x20error\x20from\x20KLYME\x20'+_0x54b575+'\x20API';console['error'](_0x526436(0x115)+_0x54b575+'\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x526436(0x133)](_0x526436(0xfe),_0x2493fb),console[_0x526436(0x133)](_0x526436(0xca),_0x761113['statusCode']),loggerService_1[_0x526436(0x116)][_0x526436(0xa6)]('klyme_'+_0x54b575[_0x526436(0xbe)](),_0x526436(0xf0),_0x526436(0xe2)+_0x2493fb);throw new Error(_0x526436(0x12e)+_0x54b575+_0x526436(0x103)+_0x2493fb);}let _0x18cba8,_0x30c847;if(_0x761113['uuid']&&_0x761113['redirect_url'])_0x18cba8=_0x761113[_0x526436(0x11d)],_0x30c847=_0x761113['redirect_url'],console[_0x526436(0xa8)](_0x526436(0x115)+_0x54b575+_0x526436(0xdb)),console['log'](_0x526436(0xb9),_0x761113[_0x526436(0x11d)]),console['log']('Redirect\x20URL:',_0x761113[_0x526436(0xcd)]);else{if(_0x761113[_0x526436(0xcb)])_0x18cba8=_0x42a526,_0x30c847=_0x761113['authUrl'],console[_0x526436(0xa8)](_0x526436(0x115)+_0x54b575+'\x20SUCCESS\x20(Legacy\x20Format)\x20==='),console[_0x526436(0xa8)]('Auth\x20URL:',_0x761113['authUrl']),console[_0x526436(0xa8)](_0x526436(0xd0),_0x42a526);else{console[_0x526436(0x133)](_0x526436(0x115)+_0x54b575+_0x526436(0xb5)),console['error'](_0x526436(0x117)),console[_0x526436(0x133)]('Response\x20data:',_0x761113),loggerService_1[_0x526436(0x116)][_0x526436(0xa6)](_0x526436(0xbf)+_0x54b575[_0x526436(0xbe)](),_0x526436(0xf0),'Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl');throw new Error(_0x526436(0x108)+_0x54b575+_0x526436(0x136));}}return console[_0x526436(0xa8)](_0x526436(0xba),_0x5d14e0,'('+_0x54b575+_0x526436(0xb2)),console[_0x526436(0xa8)](_0x526436(0x104),_0x42a526,_0x526436(0xd4)),console[_0x526436(0xa8)](_0x526436(0x9d),_0x54b575),{'gateway_payment_id':_0x18cba8,'payment_url':_0x30c847};}catch(_0x1df19c){console['error']('===\x20KLYME\x20'+_0x54b575+_0x526436(0x102)),console[_0x526436(0x133)](_0x526436(0xe6),_0x1df19c),loggerService_1[_0x526436(0x116)][_0x526436(0xa6)](_0x526436(0xbf)+_0x54b575[_0x526436(0xbe)](),_0x526436(0xf0),_0x1df19c);if(_0x1df19c instanceof Error){console[_0x526436(0x133)](_0x526436(0xb1),_0x1df19c['message']),console[_0x526436(0x133)](_0x526436(0xa2),_0x1df19c[_0x526436(0xed)]);throw new Error(_0x526436(0xb0)+_0x54b575+_0x526436(0xfd)+_0x1df19c[_0x526436(0x123)]);}throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0x54b575+_0x526436(0xfc));}}async[a41_0x11362f(0xdd)](_0x157984,_0x1b2052){const _0x1eb671=a41_0x11362f,_0x8dcc19=Date[_0x1eb671(0x11a)]();try{const _0x106fa0={'gatewayPaymentId':_0x157984,'geo':_0x1b2052};loggerService_1['loggerService'][_0x1eb671(0xbc)](_0x1eb671(0xbf)+_0x1b2052[_0x1eb671(0xbe)](),'/verify/'+_0x157984,_0x1eb671(0xe0),_0x106fa0);const _0xefc887=await fetch(this[_0x1eb671(0xc4)],{'method':_0x1eb671(0xe0),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x106fa0)}),_0x422c54=Date[_0x1eb671(0x11a)]()-_0x8dcc19;if(!_0xefc887['ok']){const _0x5369af=await _0xefc887['text']();loggerService_1[_0x1eb671(0x116)][_0x1eb671(0x11f)](_0x1eb671(0xbf)+_0x1b2052[_0x1eb671(0xbe)](),'/verify/'+_0x157984,_0xefc887[_0x1eb671(0xe7)],_0x5369af,_0x422c54);throw new Error(_0x1eb671(0xc5)+_0xefc887[_0x1eb671(0xe7)]);}const _0x41a08b=await _0xefc887[_0x1eb671(0xda)]();loggerService_1[_0x1eb671(0x116)][_0x1eb671(0x11f)](_0x1eb671(0xbf)+_0x1b2052['toLowerCase'](),_0x1eb671(0x124)+_0x157984,_0xefc887['status'],_0x41a08b,_0x422c54);if(_0x41a08b['error']||_0x41a08b[_0x1eb671(0x130)]){loggerService_1[_0x1eb671(0x116)][_0x1eb671(0xa6)](_0x1eb671(0xbf)+_0x1b2052[_0x1eb671(0xbe)](),'/verify/'+_0x157984,_0x1eb671(0x12e)+_0x1b2052+_0x1eb671(0x103)+(_0x41a08b[_0x1eb671(0x123)]||_0x41a08b['error']||'Unknown\x20error'));throw new Error(_0x1eb671(0x12e)+_0x1b2052+_0x1eb671(0x103)+(_0x41a08b['message']||_0x41a08b[_0x1eb671(0x133)]||_0x1eb671(0xf1)));}let _0x5e2783='PENDING';return{'status':_0x5e2783};}catch(_0x1d2441){console[_0x1eb671(0x133)](_0x1eb671(0x12e)+_0x1b2052+_0x1eb671(0x113),_0x1d2441),loggerService_1[_0x1eb671(0x116)][_0x1eb671(0xa6)](_0x1eb671(0xbf)+_0x1b2052[_0x1eb671(0xbe)](),'/verify/'+_0x157984,_0x1d2441);throw new Error(_0x1eb671(0xf2)+_0x1b2052+_0x1eb671(0xdc)+(_0x1d2441 instanceof Error?_0x1d2441[_0x1eb671(0x123)]:_0x1eb671(0xf1)));}}async[a41_0x11362f(0xf4)](_0x115684){const _0x13faf7=a41_0x11362f;console['log']('Processing\x20KLYME\x20webhook:',_0x115684);let _0x3fed6d=_0x13faf7(0xac);switch(_0x115684[_0x13faf7(0xe7)]?.[_0x13faf7(0xbe)]()){case _0x13faf7(0x101):case _0x13faf7(0x114):case _0x13faf7(0xc8):case _0x13faf7(0x10c):case _0x13faf7(0xf9):_0x3fed6d='PAID';break;case _0x13faf7(0xc7):case _0x13faf7(0x126):case'failed':case _0x13faf7(0x133):case _0x13faf7(0xde):_0x3fed6d=_0x13faf7(0x128);break;case _0x13faf7(0xd8):case _0x13faf7(0xae):_0x3fed6d=_0x13faf7(0x9e);break;case _0x13faf7(0x10d):case _0x13faf7(0xd5):case _0x13faf7(0xb3):case _0x13faf7(0xe1):case _0x13faf7(0x127):default:_0x3fed6d=_0x13faf7(0xac);break;}return{'paymentId':_0x115684[_0x13faf7(0x111)]||_0x115684[_0x13faf7(0x10a)]||_0x115684[_0x13faf7(0xa7)],'status':_0x3fed6d,'amount':_0x115684[_0x13faf7(0x139)],'currency':_0x115684[_0x13faf7(0x11c)],'region':_0x115684[_0x13faf7(0x112)],'additionalInfo':{'payment_method':_0x115684[_0x13faf7(0x9f)],'transaction_id':_0x115684['transaction_id']}};}}function a41_0x128e(){const _0x3845cb=['===\x20KLYME\x20','loggerService','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response',',\x20body:\x20','../../config/database','now','Response\x20Time:','currency','uuid','4wddmOw','logWhiteDomainResponse','2311830uOzFfW','TesSoft\x20Payment\x20System/1.0','create','message','/verify/','statusText','canceled','in_progress','FAILED','stringify','JSON\x20Parse\x20Error:\x20','padStart','fromEntries','call','KLYME\x20','GBP','statusCode','Redirect\x20URL:','__setModuleDefault','error','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','(validated\x20for\x20','\x20API:\x20missing\x20payment\x20data','__createBinding','Status:','amount','toString','toUpperCase','Geo\x20Parameter:','EXPIRED','payment_method','üí≥\x20KLYME\x20','882350SXZvAp','Error\x20stack:','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','then','default','logWhiteDomainError','payment_id','log','__importStar','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','\x20API:\x20','PENDING','defineProperty','timeout','Status\x20Text:','Failed\x20to\x20create\x20KLYME\x20','Error\x20message:','\x20validated)','active','Unsupported\x20KLYME\x20region:\x20','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','resolve','===\x20PARSED\x20KLYME\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','UUID:','Currency\x20Used:','floor','logWhiteDomainRequest','Raw\x20Response\x20Body:','toLowerCase','klyme_','Request\x20Body:','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','573911WajYtd','Region\x20(geo):','apiUrl','HTTP\x20error!\x20status:\x20','KlymeService','cancelled','confirmed','headers','Status\x20Code:','authUrl','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','redirect_url','968lxLHcn','https://tesoft.uk/gateway/klyme/','Reference\x20Used\x20as\x20ID:','text','payment','Failed\x20to\x20parse\x20JSON\x20response:','(8digits-8digits\x20format)','created','56331YTDiFt','\x20(8digits-8digits\x20format\x20for\x20','expired','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','json','\x20SUCCESS\x20(New\x20Format)\x20===','\x20payment:\x20','verifyPayment','rejected','generateUniqueReference','POST','processing','Business\x20Error:\x20','parse','Headers:','random','Error\x20details:','status','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','4478950DUqSGE','getOwnPropertyDescriptor','entries','2058855ENiAFK','stack','Reference:','prototype','/create','Unknown\x20error','Failed\x20to\x20verify\x20KLYME\x20','getOwnPropertyNames','processWebhook','validateCurrencyForRegion','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','HTTP\x20','Currency:','successful','__esModule','\x20RESPONSE\x20===','\x20payment\x20link:\x20Unknown\x20error','\x20payment\x20link:\x20','Error\x20Message:','writable','1257795qMBiAS','paid','\x20SERVICE\x20ERROR\x20===','\x20API\x20error:\x20','Reference\x20Used:','application/json','Response\x20Body:','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','Invalid\x20response\x20from\x20KLYME\x20','length','order_id','URL:','success','pending','\x20currency\x20validation\x20passed:\x20','createPaymentLink','\x20API\x20ERROR\x20===','reference','region','\x20payment\x20verification\x20error:','completed'];a41_0x128e=function(){return _0x3845cb;};return a41_0x128e();}function a41_0x3c89(_0x18f142,_0x334dc4){const _0x128e5e=a41_0x128e();return a41_0x3c89=function(_0x3c89f7,_0x2c8840){_0x3c89f7=_0x3c89f7-0x9d;let _0x3c8c02=_0x128e5e[_0x3c89f7];return _0x3c8c02;},a41_0x3c89(_0x18f142,_0x334dc4);}exports[a41_0x11362f(0xc6)]=KlymeService;