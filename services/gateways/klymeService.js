'use strict';const a41_0x518a41=a41_0x5513;function a41_0x5727(){const _0x38e51b=['===\x20PARSED\x20KLYME\x20','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','\x20SERVICE\x20ERROR\x20===','length','(validated\x20for\x20','Failed\x20to\x20verify\x20KLYME\x20','EUR','Reference\x20Used\x20as\x20ID:','status','KLYME\x20','2991676hylaFD','toLowerCase','JSON\x20Parse\x20Error:\x20','defineProperty','resolve','then','/create','Failed\x20to\x20parse\x20JSON\x20response:','9702cmlFzZ','completed','klyme_','2vmMuFN','\x20payment\x20link:\x20Unknown\x20error','findFirst','error','4783554xhooAU','getOwnPropertyNames','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','2692088oaJwQN','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','Error\x20Message:','get','failed','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Raw\x20Response\x20Body:','active','region','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','paid','now','success','Response\x20data:','entries','Response\x20Body:','Currency:','__esModule','Error\x20stack:','Response\x20Time:','application/json','random','payment_method','\x20API','TesSoft\x20Payment\x20System/1.0','configurable','15790aCNpNx','\x20payment:\x20','stringify','message','createPaymentLink','logWhiteDomainError','PAID','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','Invalid\x20response\x20from\x20KLYME\x20','toString','statusCode','Status:','prototype','confirmed','Failed\x20to\x20create\x20KLYME\x20','\x20API\x20ERROR\x20===','URL:','authUrl','create','stack','logWhiteDomainResponse','POST','__importStar','\x20API\x20error:\x20','log','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','getOwnPropertyDescriptor','Unknown\x20error\x20from\x20KLYME\x20','validateCurrencyForRegion','default','writable','Unsupported\x20KLYME\x20region:\x20','currency','üí≥\x20KLYME\x20','__createBinding','generateUniqueReference','Geo\x20Parameter:','Unknown\x20error','text','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','parse','\x20API\x20BUSINESS\x20ERROR\x20===','redirect_url','9121189EzIDxv','https://tesoft.uk/gateway/pending.php?id=',',\x20body:\x20','\x20currency\x20validation\x20passed:\x20','timeout','6vLFuJW','apiUrl','430805AjhNXR','‚ö†Ô∏è\x20KLYME\x20reference\x20','../../config/database','HTTP\x20error!\x20status:\x20','Status\x20Text:','call','created','Reference:','\x20API:\x20missing\x20payment\x20data','Parsed\x20Result:','Currency\x20Used:','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','(8digits-8digits\x20format)','GBP','HTTP\x20','uuid','../loggerService','expired','/verify/','amount','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','loggerService','__setModuleDefault','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','===\x20KLYME\x20','processWebhook','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','KlymeService','payment_id','Region\x20(geo):','Processing\x20KLYME\x20webhook:','\x20(8digits-8digits\x20format\x20for\x20','statusText','order_id','cancelled','\x20SUCCESS\x20(Legacy\x20Format)\x20===','2567580MyzRVM','https://tesoft.uk/gateway/klyme/','PENDING','verifyPayment','fromEntries'];a41_0x5727=function(){return _0x38e51b;};return a41_0x5727();}(function(_0x37ed4c,_0x1cbb5a){const _0x24ce33=a41_0x5513,_0xa3220d=_0x37ed4c();while(!![]){try{const _0x43587f=-parseInt(_0x24ce33(0x185))/0x1*(-parseInt(_0x24ce33(0x1c3))/0x2)+-parseInt(_0x24ce33(0x1c7))/0x3+-parseInt(_0x24ce33(0x1b8))/0x4+-parseInt(_0x24ce33(0x1a9))/0x5+parseInt(_0x24ce33(0x183))/0x6*(parseInt(_0x24ce33(0x17e))/0x7)+parseInt(_0x24ce33(0x1cb))/0x8+parseInt(_0x24ce33(0x1c0))/0x9*(parseInt(_0x24ce33(0x153))/0xa);if(_0x43587f===_0x1cbb5a)break;else _0xa3220d['push'](_0xa3220d['shift']());}catch(_0x18c804){_0xa3220d['push'](_0xa3220d['shift']());}}}(a41_0x5727,0xdfc48));var __createBinding=this&&this[a41_0x518a41(0x175)]||(Object['create']?function(_0x204b22,_0x29cbad,_0x24ed58,_0x5c52e2){const _0x1a9933=a41_0x518a41;if(_0x5c52e2===undefined)_0x5c52e2=_0x24ed58;var _0x8f8d5f=Object[_0x1a9933(0x16d)](_0x29cbad,_0x24ed58);(!_0x8f8d5f||(_0x1a9933(0x13c)in _0x8f8d5f?!_0x29cbad[_0x1a9933(0x14a)]:_0x8f8d5f[_0x1a9933(0x171)]||_0x8f8d5f[_0x1a9933(0x152)]))&&(_0x8f8d5f={'enumerable':!![],'get':function(){return _0x29cbad[_0x24ed58];}}),Object[_0x1a9933(0x1bb)](_0x204b22,_0x5c52e2,_0x8f8d5f);}:function(_0x25c6b7,_0x311c7e,_0x3408aa,_0x21183b){if(_0x21183b===undefined)_0x21183b=_0x3408aa;_0x25c6b7[_0x21183b]=_0x311c7e[_0x3408aa];}),__setModuleDefault=this&&this[a41_0x518a41(0x19b)]||(Object[a41_0x518a41(0x165)]?function(_0x465f03,_0x29defd){const _0x109363=a41_0x518a41;Object[_0x109363(0x1bb)](_0x465f03,_0x109363(0x170),{'enumerable':!![],'value':_0x29defd});}:function(_0x3c869b,_0x35307c){const _0x5c593b=a41_0x518a41;_0x3c869b[_0x5c593b(0x170)]=_0x35307c;}),__importStar=this&&this[a41_0x518a41(0x169)]||(function(){var _0x4b0d3b=function(_0x4db104){const _0x496d9=a41_0x5513;return _0x4b0d3b=Object[_0x496d9(0x1c8)]||function(_0x10f8a9){const _0x2b205e=_0x496d9;var _0x3c8dd3=[];for(var _0x155213 in _0x10f8a9)if(Object[_0x2b205e(0x15f)]['hasOwnProperty'][_0x2b205e(0x18a)](_0x10f8a9,_0x155213))_0x3c8dd3[_0x3c8dd3[_0x2b205e(0x1b1)]]=_0x155213;return _0x3c8dd3;},_0x4b0d3b(_0x4db104);};return function(_0x26e344){const _0x30c714=a41_0x5513;if(_0x26e344&&_0x26e344[_0x30c714(0x14a)])return _0x26e344;var _0x3c1fb5={};if(_0x26e344!=null){for(var _0x5b32b6=_0x4b0d3b(_0x26e344),_0x1809fb=0x0;_0x1809fb<_0x5b32b6[_0x30c714(0x1b1)];_0x1809fb++)if(_0x5b32b6[_0x1809fb]!==_0x30c714(0x170))__createBinding(_0x3c1fb5,_0x26e344,_0x5b32b6[_0x1809fb]);}return __setModuleDefault(_0x3c1fb5,_0x26e344),_0x3c1fb5;};}());Object[a41_0x518a41(0x1bb)](exports,a41_0x518a41(0x14a),{'value':!![]}),exports['KlymeService']=void 0x0;const loggerService_1=require(a41_0x518a41(0x195));class KlymeService{constructor(){const _0x14d8ab=a41_0x518a41;this[_0x14d8ab(0x184)]=_0x14d8ab(0x1aa),console[_0x14d8ab(0x16b)]('üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions');}[a41_0x518a41(0x16f)](_0x70245d,_0xd8c5fd){const _0x3de29a=a41_0x518a41,_0x3fa343=_0x70245d['toUpperCase']();switch(_0xd8c5fd){case'EU':if(_0x3fa343!==_0x3de29a(0x1b4))throw new Error(_0x3de29a(0x13e)+_0x3fa343);break;case'GB':if(_0x3fa343!==_0x3de29a(0x192))throw new Error(_0x3de29a(0x16c)+_0x3fa343);break;case'DE':if(_0x3fa343!==_0x3de29a(0x1b4))throw new Error(_0x3de29a(0x1c9)+_0x3fa343);break;default:throw new Error(_0x3de29a(0x172)+_0xd8c5fd);}}async['generateUniqueReference'](){const _0xebdad4=a41_0x518a41,_0x5a665b=(await Promise[_0xebdad4(0x1bc)]()[_0xebdad4(0x1bd)](()=>__importStar(require(_0xebdad4(0x187)))))[_0xebdad4(0x170)];let _0x73b0dc,_0x30bffb=0x0;const _0x408d9c=0xa;do{const _0x420cca=()=>{const _0x38827c=_0xebdad4;return Math['floor'](Math[_0x38827c(0x14e)]()*0x5f5e100)[_0x38827c(0x15c)]()['padStart'](0x8,'0');};_0x73b0dc=_0x420cca()+'-'+_0x420cca();const _0x5a5d35=await _0x5a665b['payment'][_0xebdad4(0x1c5)]({'where':{'gatewayOrderId':_0x73b0dc}});if(!_0x5a5d35)break;_0x30bffb++,console['log'](_0xebdad4(0x186)+_0x73b0dc+_0xebdad4(0x190)+_0x30bffb+')');}while(_0x30bffb<_0x408d9c);if(_0x30bffb>=_0x408d9c)throw new Error(_0xebdad4(0x1cc));return _0x73b0dc;}async[a41_0x518a41(0x157)](_0x3b2287){const _0x57485a=a41_0x518a41,{orderId:_0x3495a8,amount:_0x2225b8,currency:_0x481204,region:_0x23982d}=_0x3b2287;if(_0x23982d!=='EU'&&_0x23982d!=='GB'&&_0x23982d!=='DE')throw new Error(_0x57485a(0x1ca)+_0x23982d);this[_0x57485a(0x16f)](_0x481204,_0x23982d);const _0x1fc35c=_0x481204['toUpperCase']();console['log'](_0x57485a(0x174)+_0x23982d+_0x57485a(0x181)+_0x1fc35c);const _0x305c11=await this[_0x57485a(0x176)]();console[_0x57485a(0x16b)](_0x57485a(0x17a)+_0x305c11+_0x57485a(0x1a4)+_0x23982d+')');const _0x22e684=_0x57485a(0x17f)+_0x3495a8,_0x55b87f={'amount':_0x2225b8,'currency':_0x1fc35c,'redirectUrl':_0x22e684,'reference':_0x305c11,'geo':_0x23982d},_0x571c24=Date[_0x57485a(0x144)]();try{console[_0x57485a(0x16b)]('===\x20KLYME\x20'+_0x23982d+_0x57485a(0x15a)),console['log'](_0x57485a(0x163),this[_0x57485a(0x184)]),console['log']('Request\x20Body:',JSON[_0x57485a(0x155)](_0x55b87f,null,0x2)),console[_0x57485a(0x16b)](_0x57485a(0x1a2),_0x23982d),console[_0x57485a(0x16b)](_0x57485a(0x149),_0x1fc35c,_0x57485a(0x1b2)+_0x23982d+')'),console[_0x57485a(0x16b)](_0x57485a(0x18c),_0x305c11,_0x57485a(0x191)),console[_0x57485a(0x16b)]('Redirect\x20URL:',_0x22e684),loggerService_1['loggerService']['logWhiteDomainRequest'](_0x57485a(0x1c2)+_0x23982d['toLowerCase'](),_0x57485a(0x1be),_0x57485a(0x168),_0x55b87f);const _0x369b13=await fetch(this[_0x57485a(0x184)],{'method':'POST','headers':{'Content-Type':_0x57485a(0x14d),'Accept':'application/json','User-Agent':_0x57485a(0x151)},'body':JSON[_0x57485a(0x155)](_0x55b87f)}),_0x184f03=Date[_0x57485a(0x144)]()-_0x571c24;console[_0x57485a(0x16b)]('===\x20KLYME\x20'+_0x23982d+_0x57485a(0x199)),console[_0x57485a(0x16b)](_0x57485a(0x15e),_0x369b13['status']),console['log'](_0x57485a(0x189),_0x369b13[_0x57485a(0x1a5)]),console[_0x57485a(0x16b)]('Headers:',Object[_0x57485a(0x1ad)](_0x369b13['headers'][_0x57485a(0x147)]())),console[_0x57485a(0x16b)](_0x57485a(0x14c),_0x184f03+'ms');const _0x5abec0=await _0x369b13[_0x57485a(0x179)]();console['log'](_0x57485a(0x13f),_0x5abec0);if(!_0x369b13['ok']){console['error']('===\x20KLYME\x20'+_0x23982d+_0x57485a(0x162)),console['error']('HTTP\x20Status:',_0x369b13['status']),console['error'](_0x57485a(0x148),_0x5abec0),loggerService_1[_0x57485a(0x19a)][_0x57485a(0x167)](_0x57485a(0x1c2)+_0x23982d['toLowerCase'](),_0x57485a(0x1be),_0x369b13[_0x57485a(0x1b6)],_0x5abec0,_0x184f03),loggerService_1['loggerService']['logWhiteDomainError'](_0x57485a(0x1c2)+_0x23982d[_0x57485a(0x1b9)](),_0x57485a(0x1be),_0x57485a(0x193)+_0x369b13[_0x57485a(0x1b6)]+':\x20'+_0x5abec0);throw new Error('HTTP\x20error!\x20status:\x20'+_0x369b13[_0x57485a(0x1b6)]+_0x57485a(0x180)+_0x5abec0);}let _0x39eaa5;try{_0x39eaa5=JSON[_0x57485a(0x17b)](_0x5abec0);}catch(_0x5af9a0){console[_0x57485a(0x1c6)](_0x57485a(0x1bf),_0x5af9a0),loggerService_1['loggerService'][_0x57485a(0x158)](_0x57485a(0x1c2)+_0x23982d[_0x57485a(0x1b9)](),_0x57485a(0x1be),_0x57485a(0x1ba)+_0x5af9a0);throw new Error(_0x57485a(0x142)+_0x23982d+'\x20API:\x20'+_0x5abec0);}console['log'](_0x57485a(0x1ae)+_0x23982d+'\x20RESPONSE\x20==='),console['log'](_0x57485a(0x18e),JSON['stringify'](_0x39eaa5,null,0x2)),loggerService_1[_0x57485a(0x19a)]['logWhiteDomainResponse'](_0x57485a(0x1c2)+_0x23982d['toLowerCase'](),_0x57485a(0x1be),_0x369b13[_0x57485a(0x1b6)],_0x39eaa5,_0x184f03);if(_0x39eaa5[_0x57485a(0x1c6)]||_0x39eaa5[_0x57485a(0x15d)]){const _0x691df7=_0x39eaa5['message']||_0x39eaa5[_0x57485a(0x1c6)]||_0x57485a(0x16e)+_0x23982d+_0x57485a(0x150);console[_0x57485a(0x1c6)](_0x57485a(0x19d)+_0x23982d+_0x57485a(0x17c)),console[_0x57485a(0x1c6)](_0x57485a(0x13b),_0x691df7),console['error']('Status\x20Code:',_0x39eaa5[_0x57485a(0x15d)]),loggerService_1[_0x57485a(0x19a)][_0x57485a(0x158)](_0x57485a(0x1c2)+_0x23982d[_0x57485a(0x1b9)](),_0x57485a(0x1be),'Business\x20Error:\x20'+_0x691df7);throw new Error(_0x57485a(0x1b7)+_0x23982d+_0x57485a(0x16a)+_0x691df7);}let _0x570a48,_0x52be8c;if(_0x39eaa5['uuid']&&_0x39eaa5[_0x57485a(0x17d)])_0x570a48=_0x39eaa5[_0x57485a(0x194)],_0x52be8c=_0x39eaa5['redirect_url'],console[_0x57485a(0x16b)](_0x57485a(0x19d)+_0x23982d+'\x20SUCCESS\x20(New\x20Format)\x20==='),console[_0x57485a(0x16b)]('UUID:',_0x39eaa5[_0x57485a(0x194)]),console['log']('Redirect\x20URL:',_0x39eaa5['redirect_url']);else{if(_0x39eaa5[_0x57485a(0x164)])_0x570a48=_0x305c11,_0x52be8c=_0x39eaa5['authUrl'],console[_0x57485a(0x16b)](_0x57485a(0x19d)+_0x23982d+_0x57485a(0x1a8)),console[_0x57485a(0x16b)]('Auth\x20URL:',_0x39eaa5[_0x57485a(0x164)]),console[_0x57485a(0x16b)](_0x57485a(0x1b5),_0x305c11);else{console['error']('===\x20KLYME\x20'+_0x23982d+_0x57485a(0x1af)),console['error'](_0x57485a(0x19c)),console[_0x57485a(0x1c6)](_0x57485a(0x146),_0x39eaa5),loggerService_1[_0x57485a(0x19a)][_0x57485a(0x158)]('klyme_'+_0x23982d[_0x57485a(0x1b9)](),'/create',_0x57485a(0x19f));throw new Error(_0x57485a(0x15b)+_0x23982d+_0x57485a(0x18d));}}return console['log'](_0x57485a(0x18f),_0x1fc35c,'('+_0x23982d+'\x20validated)'),console[_0x57485a(0x16b)]('Reference\x20Used:',_0x305c11,_0x57485a(0x191)),console[_0x57485a(0x16b)](_0x57485a(0x177),_0x23982d),{'gateway_payment_id':_0x570a48,'payment_url':_0x52be8c};}catch(_0x164341){console[_0x57485a(0x1c6)]('===\x20KLYME\x20'+_0x23982d+_0x57485a(0x1b0)),console[_0x57485a(0x1c6)]('Error\x20details:',_0x164341),loggerService_1[_0x57485a(0x19a)][_0x57485a(0x158)](_0x57485a(0x1c2)+_0x23982d[_0x57485a(0x1b9)](),_0x57485a(0x1be),_0x164341);if(_0x164341 instanceof Error){console['error']('Error\x20message:',_0x164341[_0x57485a(0x156)]),console['error'](_0x57485a(0x14b),_0x164341[_0x57485a(0x166)]);throw new Error(_0x57485a(0x161)+_0x23982d+'\x20payment\x20link:\x20'+_0x164341[_0x57485a(0x156)]);}throw new Error(_0x57485a(0x161)+_0x23982d+_0x57485a(0x1c4));}}async[a41_0x518a41(0x1ac)](_0x402ef4,_0x40bca4){const _0x9ec58e=a41_0x518a41,_0x4a0130=Date[_0x9ec58e(0x144)]();try{const _0x57b820={'gatewayPaymentId':_0x402ef4,'geo':_0x40bca4};loggerService_1['loggerService']['logWhiteDomainRequest'](_0x9ec58e(0x1c2)+_0x40bca4[_0x9ec58e(0x1b9)](),_0x9ec58e(0x197)+_0x402ef4,_0x9ec58e(0x168),_0x57b820);const _0x5b7be8=await fetch(this[_0x9ec58e(0x184)],{'method':_0x9ec58e(0x168),'headers':{'Content-Type':_0x9ec58e(0x14d),'User-Agent':_0x9ec58e(0x151)},'body':JSON[_0x9ec58e(0x155)](_0x57b820)}),_0x2cd23e=Date[_0x9ec58e(0x144)]()-_0x4a0130;if(!_0x5b7be8['ok']){const _0xa5bd05=await _0x5b7be8[_0x9ec58e(0x179)]();loggerService_1[_0x9ec58e(0x19a)][_0x9ec58e(0x167)]('klyme_'+_0x40bca4[_0x9ec58e(0x1b9)](),'/verify/'+_0x402ef4,_0x5b7be8[_0x9ec58e(0x1b6)],_0xa5bd05,_0x2cd23e);throw new Error(_0x9ec58e(0x188)+_0x5b7be8[_0x9ec58e(0x1b6)]);}const _0x5be920=await _0x5b7be8['json']();loggerService_1['loggerService']['logWhiteDomainResponse'](_0x9ec58e(0x1c2)+_0x40bca4[_0x9ec58e(0x1b9)](),_0x9ec58e(0x197)+_0x402ef4,_0x5b7be8[_0x9ec58e(0x1b6)],_0x5be920,_0x2cd23e);if(_0x5be920[_0x9ec58e(0x1c6)]||_0x5be920[_0x9ec58e(0x15d)]){loggerService_1[_0x9ec58e(0x19a)][_0x9ec58e(0x158)]('klyme_'+_0x40bca4[_0x9ec58e(0x1b9)](),_0x9ec58e(0x197)+_0x402ef4,_0x9ec58e(0x1b7)+_0x40bca4+'\x20API\x20error:\x20'+(_0x5be920[_0x9ec58e(0x156)]||_0x5be920[_0x9ec58e(0x1c6)]||_0x9ec58e(0x178)));throw new Error(_0x9ec58e(0x1b7)+_0x40bca4+_0x9ec58e(0x16a)+(_0x5be920['message']||_0x5be920[_0x9ec58e(0x1c6)]||_0x9ec58e(0x178)));}let _0x2f4eda=_0x9ec58e(0x1ab);return{'status':_0x2f4eda};}catch(_0x55cc47){console['error']('KLYME\x20'+_0x40bca4+'\x20payment\x20verification\x20error:',_0x55cc47),loggerService_1[_0x9ec58e(0x19a)]['logWhiteDomainError'](_0x9ec58e(0x1c2)+_0x40bca4[_0x9ec58e(0x1b9)](),_0x9ec58e(0x197)+_0x402ef4,_0x55cc47);throw new Error(_0x9ec58e(0x1b3)+_0x40bca4+_0x9ec58e(0x154)+(_0x55cc47 instanceof Error?_0x55cc47[_0x9ec58e(0x156)]:_0x9ec58e(0x178)));}}async[a41_0x518a41(0x19e)](_0x806c03){const _0x165e7b=a41_0x518a41;console[_0x165e7b(0x16b)](_0x165e7b(0x1a3),_0x806c03);let _0x3d7422=_0x165e7b(0x1ab);switch(_0x806c03[_0x165e7b(0x1b6)]?.[_0x165e7b(0x1b9)]()){case _0x165e7b(0x143):case _0x165e7b(0x1c1):case _0x165e7b(0x160):case _0x165e7b(0x145):case'successful':_0x3d7422=_0x165e7b(0x159);break;case _0x165e7b(0x1a7):case'canceled':case _0x165e7b(0x13d):case _0x165e7b(0x1c6):case'rejected':_0x3d7422='FAILED';break;case _0x165e7b(0x196):case _0x165e7b(0x182):_0x3d7422='EXPIRED';break;case'pending':case _0x165e7b(0x18b):case _0x165e7b(0x140):case'processing':case'in_progress':default:_0x3d7422='PENDING';break;}return{'paymentId':_0x806c03['reference']||_0x806c03[_0x165e7b(0x1a6)]||_0x806c03[_0x165e7b(0x1a1)],'status':_0x3d7422,'amount':_0x806c03[_0x165e7b(0x198)],'currency':_0x806c03[_0x165e7b(0x173)],'region':_0x806c03[_0x165e7b(0x141)],'additionalInfo':{'payment_method':_0x806c03[_0x165e7b(0x14f)],'transaction_id':_0x806c03['transaction_id']}};}}function a41_0x5513(_0x43353a,_0x2f5f63){const _0x572769=a41_0x5727();return a41_0x5513=function(_0x551356,_0x23e6ca){_0x551356=_0x551356-0x13b;let _0x39d786=_0x572769[_0x551356];return _0x39d786;},a41_0x5513(_0x43353a,_0x2f5f63);}exports[a41_0x518a41(0x1a0)]=KlymeService;