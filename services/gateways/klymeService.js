'use strict';const a41_0x302812=a41_0x4ed9;function a41_0x4ed9(_0x24b345,_0x3f514f){const _0x53f25a=a41_0x53f2();return a41_0x4ed9=function(_0x4ed912,_0x589cbe){_0x4ed912=_0x4ed912-0xcf;let _0x21c4d8=_0x53f25a[_0x4ed912];return _0x21c4d8;},a41_0x4ed9(_0x24b345,_0x3f514f);}(function(_0x58af6e,_0x5ecafc){const _0x2601bb=a41_0x4ed9,_0x171199=_0x58af6e();while(!![]){try{const _0x249b93=parseInt(_0x2601bb(0x11a))/0x1+parseInt(_0x2601bb(0x127))/0x2*(-parseInt(_0x2601bb(0xec))/0x3)+-parseInt(_0x2601bb(0x114))/0x4*(-parseInt(_0x2601bb(0xf1))/0x5)+-parseInt(_0x2601bb(0x158))/0x6*(parseInt(_0x2601bb(0x13f))/0x7)+parseInt(_0x2601bb(0xe9))/0x8+-parseInt(_0x2601bb(0xd1))/0x9+-parseInt(_0x2601bb(0x137))/0xa*(-parseInt(_0x2601bb(0x108))/0xb);if(_0x249b93===_0x5ecafc)break;else _0x171199['push'](_0x171199['shift']());}catch(_0x208a0a){_0x171199['push'](_0x171199['shift']());}}}(a41_0x53f2,0xa7576));function a41_0x53f2(){const _0x530a37=['expired','created','fromEntries','logWhiteDomainResponse','/verify/','\x20(8digits-8digits\x20format\x20for\x20','Error\x20Message:','logWhiteDomainError','writable','payment_method','rejected','Currency\x20Used:','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','stringify','generateUniqueReference','425504hiRJEv','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','status','908055RAsEHP','Error\x20stack:','PAID','Error\x20details:','reference','71495BAAaLa','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','hasOwnProperty','entries','createPaymentLink','json','Failed\x20to\x20verify\x20KLYME\x20','confirmed','Invalid\x20response\x20from\x20KLYME\x20','../../config/database','call','configurable','order_id','processWebhook','../loggerService','Failed\x20to\x20create\x20KLYME\x20','loggerService','Response\x20Time:','resolve',',\x20body:\x20','toString','HTTP\x20','\x20API','32624999yldIKh','__importStar','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','Reference\x20Used:','validateCurrencyForRegion','Unknown\x20error','transaction_id','toUpperCase','failed','===\x20PARSED\x20KLYME\x20','\x20payment\x20link:\x20Unknown\x20error','payment_id','148lUgPsh','Region\x20(geo):','Request\x20Body:','URL:','now','HTTP\x20error!\x20status:\x20','74695EkjbCW','authUrl','pending','default','GBP','https://tesoft.uk/gateway/pending.php?id=','klyme_','region','===\x20KLYME\x20','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','message','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','KlymeService','8nhzrYH','getOwnPropertyNames','getOwnPropertyDescriptor','Headers:','create','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','error','logWhiteDomainRequest','floor','amount','in_progress','cancelled','https://tesoft.uk/gateway/klyme/','text','Redirect\x20URL:','\x20SERVICE\x20ERROR\x20===','10DiOihT','Unsupported\x20KLYME\x20region:\x20','HTTP\x20Status:','apiUrl','processing','headers','Unknown\x20error\x20from\x20KLYME\x20','then','7oBbPKJ','POST','Reference:','Status\x20Code:','\x20SUCCESS\x20(New\x20Format)\x20===','(8digits-8digits\x20format)','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','padStart','__setModuleDefault','\x20RESPONSE\x20===','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','Error\x20message:','active','log','currency','PENDING','Business\x20Error:\x20','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','timeout','EXPIRED','UUID:','Response\x20Body:','Auth\x20URL:','\x20API\x20ERROR\x20===','random','5951316jUWdby','stack','toLowerCase','‚ö†Ô∏è\x20KLYME\x20reference\x20','\x20API:\x20missing\x20payment\x20data','Response\x20data:','\x20API\x20error:\x20','Status\x20Text:','defineProperty','JSON\x20Parse\x20Error:\x20','application/json','KLYME\x20','6613191VqaBqG','uuid','get','/create','__esModule','redirect_url','statusCode','length','payment'];a41_0x53f2=function(){return _0x530a37;};return a41_0x53f2();}var __createBinding=this&&this['__createBinding']||(Object[a41_0x302812(0x12b)]?function(_0x2f6988,_0x55ca0b,_0x5b93c6,_0x1433bf){const _0x35580c=a41_0x302812;if(_0x1433bf===undefined)_0x1433bf=_0x5b93c6;var _0x2749bb=Object[_0x35580c(0x129)](_0x55ca0b,_0x5b93c6);(!_0x2749bb||(_0x35580c(0xd3)in _0x2749bb?!_0x55ca0b[_0x35580c(0xd5)]:_0x2749bb[_0x35580c(0xe2)]||_0x2749bb[_0x35580c(0xfc)]))&&(_0x2749bb={'enumerable':!![],'get':function(){return _0x55ca0b[_0x5b93c6];}}),Object['defineProperty'](_0x2f6988,_0x1433bf,_0x2749bb);}:function(_0x29d959,_0x78387e,_0x3d54be,_0x3c4dbe){if(_0x3c4dbe===undefined)_0x3c4dbe=_0x3d54be;_0x29d959[_0x3c4dbe]=_0x78387e[_0x3d54be];}),__setModuleDefault=this&&this[a41_0x302812(0x147)]||(Object[a41_0x302812(0x12b)]?function(_0x1514e3,_0x1711a3){const _0xd5604b=a41_0x302812;Object[_0xd5604b(0x160)](_0x1514e3,_0xd5604b(0x11d),{'enumerable':!![],'value':_0x1711a3});}:function(_0x3850b7,_0x3a53f9){const _0x4e55a8=a41_0x302812;_0x3850b7[_0x4e55a8(0x11d)]=_0x3a53f9;}),__importStar=this&&this[a41_0x302812(0x109)]||(function(){var _0x3d8d24=function(_0x249318){const _0x457742=a41_0x4ed9;return _0x3d8d24=Object[_0x457742(0x128)]||function(_0x349205){const _0x59e24c=_0x457742;var _0x5bd014=[];for(var _0x13116a in _0x349205)if(Object['prototype'][_0x59e24c(0xf3)][_0x59e24c(0xfb)](_0x349205,_0x13116a))_0x5bd014[_0x5bd014[_0x59e24c(0xd8)]]=_0x13116a;return _0x5bd014;},_0x3d8d24(_0x249318);};return function(_0x197bfe){const _0xe5a765=a41_0x4ed9;if(_0x197bfe&&_0x197bfe['__esModule'])return _0x197bfe;var _0x545b4f={};if(_0x197bfe!=null){for(var _0x2e5986=_0x3d8d24(_0x197bfe),_0x1598ba=0x0;_0x1598ba<_0x2e5986[_0xe5a765(0xd8)];_0x1598ba++)if(_0x2e5986[_0x1598ba]!==_0xe5a765(0x11d))__createBinding(_0x545b4f,_0x197bfe,_0x2e5986[_0x1598ba]);}return __setModuleDefault(_0x545b4f,_0x197bfe),_0x545b4f;};}());Object[a41_0x302812(0x160)](exports,a41_0x302812(0xd5),{'value':!![]}),exports[a41_0x302812(0x126)]=void 0x0;const loggerService_1=require(a41_0x302812(0xff));class KlymeService{constructor(){const _0x3a9949=a41_0x302812;this['apiUrl']=_0x3a9949(0x133),console[_0x3a9949(0x14c)](_0x3a9949(0x150));}[a41_0x302812(0x10c)](_0x456c4e,_0x436eda){const _0x1e9b3d=a41_0x302812,_0x35acc7=_0x456c4e[_0x1e9b3d(0x10f)]();switch(_0x436eda){case'EU':if(_0x35acc7!=='EUR')throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x35acc7);break;case'GB':if(_0x35acc7!==_0x1e9b3d(0x11e))throw new Error(_0x1e9b3d(0x10a)+_0x35acc7);break;case'DE':if(_0x35acc7!=='EUR')throw new Error(_0x1e9b3d(0x145)+_0x35acc7);break;default:throw new Error(_0x1e9b3d(0x138)+_0x436eda);}}async['generateUniqueReference'](){const _0x33c1cf=a41_0x302812,_0x55c099=(await Promise[_0x33c1cf(0x103)]()[_0x33c1cf(0x13e)](()=>__importStar(require(_0x33c1cf(0xfa)))))[_0x33c1cf(0x11d)];let _0x38a108,_0x456768=0x0;const _0x4ac99c=0xa;do{const _0x3e6a66=()=>{const _0x2cda90=_0x33c1cf;return Math[_0x2cda90(0x12f)](Math[_0x2cda90(0x157)]()*0x5f5e100)[_0x2cda90(0x105)]()[_0x2cda90(0x146)](0x8,'0');};_0x38a108=_0x3e6a66()+'-'+_0x3e6a66();const _0x3b14fe=await _0x55c099[_0x33c1cf(0xd9)]['findFirst']({'where':{'gatewayOrderId':_0x38a108}});if(!_0x3b14fe)break;_0x456768++,console[_0x33c1cf(0x14c)](_0x33c1cf(0x15b)+_0x38a108+_0x33c1cf(0x125)+_0x456768+')');}while(_0x456768<_0x4ac99c);if(_0x456768>=_0x4ac99c)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x38a108;}async[a41_0x302812(0xf5)](_0x4e8691){const _0x476efd=a41_0x302812,{orderId:_0x5dd6a3,amount:_0x3705f3,currency:_0x7e0f98,region:_0x5c9889}=_0x4e8691;if(_0x5c9889!=='EU'&&_0x5c9889!=='GB'&&_0x5c9889!=='DE')throw new Error(_0x476efd(0x149)+_0x5c9889);this['validateCurrencyForRegion'](_0x7e0f98,_0x5c9889);const _0x28dcb0=_0x7e0f98[_0x476efd(0x10f)]();console[_0x476efd(0x14c)]('üí≥\x20KLYME\x20'+_0x5c9889+'\x20currency\x20validation\x20passed:\x20'+_0x28dcb0);const _0x49090a=await this[_0x476efd(0xe8)]();console['log'](_0x476efd(0xf2)+_0x49090a+_0x476efd(0xdf)+_0x5c9889+')');const _0xf4a92c=_0x476efd(0x11f)+_0x5dd6a3,_0x14a364={'amount':_0x3705f3,'currency':_0x28dcb0,'redirectUrl':_0xf4a92c,'reference':_0x49090a,'geo':_0x5c9889},_0x2021da=Date[_0x476efd(0x118)]();try{console[_0x476efd(0x14c)](_0x476efd(0x122)+_0x5c9889+_0x476efd(0x12c)),console['log'](_0x476efd(0x117),this[_0x476efd(0x13a)]),console['log'](_0x476efd(0x116),JSON['stringify'](_0x14a364,null,0x2)),console['log'](_0x476efd(0x115),_0x5c9889),console['log']('Currency:',_0x28dcb0,'(validated\x20for\x20'+_0x5c9889+')'),console['log'](_0x476efd(0x141),_0x49090a,_0x476efd(0x144)),console[_0x476efd(0x14c)](_0x476efd(0x135),_0xf4a92c),loggerService_1[_0x476efd(0x101)][_0x476efd(0x12e)](_0x476efd(0x120)+_0x5c9889[_0x476efd(0x15a)](),_0x476efd(0xd4),'POST',_0x14a364);const _0x3dab39=await fetch(this[_0x476efd(0x13a)],{'method':'POST','headers':{'Content-Type':'application/json','Accept':_0x476efd(0xcf),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x476efd(0xe7)](_0x14a364)}),_0x28bb2e=Date[_0x476efd(0x118)]()-_0x2021da;console[_0x476efd(0x14c)](_0x476efd(0x122)+_0x5c9889+_0x476efd(0x123)),console['log']('Status:',_0x3dab39[_0x476efd(0xeb)]),console[_0x476efd(0x14c)](_0x476efd(0x15f),_0x3dab39['statusText']),console['log'](_0x476efd(0x12a),Object[_0x476efd(0xdc)](_0x3dab39[_0x476efd(0x13c)][_0x476efd(0xf4)]())),console[_0x476efd(0x14c)](_0x476efd(0x102),_0x28bb2e+'ms');const _0x271e57=await _0x3dab39[_0x476efd(0x134)]();console['log']('Raw\x20Response\x20Body:',_0x271e57);if(!_0x3dab39['ok']){console['error'](_0x476efd(0x122)+_0x5c9889+_0x476efd(0x156)),console[_0x476efd(0x12d)](_0x476efd(0x139),_0x3dab39[_0x476efd(0xeb)]),console[_0x476efd(0x12d)](_0x476efd(0x154),_0x271e57),loggerService_1[_0x476efd(0x101)][_0x476efd(0xdd)](_0x476efd(0x120)+_0x5c9889[_0x476efd(0x15a)](),_0x476efd(0xd4),_0x3dab39[_0x476efd(0xeb)],_0x271e57,_0x28bb2e),loggerService_1[_0x476efd(0x101)][_0x476efd(0xe1)]('klyme_'+_0x5c9889[_0x476efd(0x15a)](),'/create',_0x476efd(0x106)+_0x3dab39[_0x476efd(0xeb)]+':\x20'+_0x271e57);throw new Error(_0x476efd(0x119)+_0x3dab39[_0x476efd(0xeb)]+_0x476efd(0x104)+_0x271e57);}let _0xa3ed0c;try{_0xa3ed0c=JSON['parse'](_0x271e57);}catch(_0x44da07){console['error']('Failed\x20to\x20parse\x20JSON\x20response:',_0x44da07),loggerService_1[_0x476efd(0x101)][_0x476efd(0xe1)](_0x476efd(0x120)+_0x5c9889[_0x476efd(0x15a)](),'/create',_0x476efd(0x161)+_0x44da07);throw new Error('Invalid\x20JSON\x20response\x20from\x20KLYME\x20'+_0x5c9889+'\x20API:\x20'+_0x271e57);}console['log'](_0x476efd(0x111)+_0x5c9889+_0x476efd(0x148)),console[_0x476efd(0x14c)]('Parsed\x20Result:',JSON[_0x476efd(0xe7)](_0xa3ed0c,null,0x2)),loggerService_1[_0x476efd(0x101)]['logWhiteDomainResponse'](_0x476efd(0x120)+_0x5c9889['toLowerCase'](),_0x476efd(0xd4),_0x3dab39[_0x476efd(0xeb)],_0xa3ed0c,_0x28bb2e);if(_0xa3ed0c['error']||_0xa3ed0c[_0x476efd(0xd7)]){const _0x3cf0ae=_0xa3ed0c[_0x476efd(0x124)]||_0xa3ed0c[_0x476efd(0x12d)]||_0x476efd(0x13d)+_0x5c9889+_0x476efd(0x107);console[_0x476efd(0x12d)]('===\x20KLYME\x20'+_0x5c9889+'\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x476efd(0x12d)](_0x476efd(0xe0),_0x3cf0ae),console[_0x476efd(0x12d)](_0x476efd(0x142),_0xa3ed0c['statusCode']),loggerService_1[_0x476efd(0x101)][_0x476efd(0xe1)]('klyme_'+_0x5c9889['toLowerCase'](),'/create',_0x476efd(0x14f)+_0x3cf0ae);throw new Error('KLYME\x20'+_0x5c9889+_0x476efd(0x15e)+_0x3cf0ae);}let _0x427546,_0x4c44ae;if(_0xa3ed0c['uuid']&&_0xa3ed0c[_0x476efd(0xd6)])_0x427546=_0xa3ed0c[_0x476efd(0xd2)],_0x4c44ae=_0xa3ed0c[_0x476efd(0xd6)],console[_0x476efd(0x14c)]('===\x20KLYME\x20'+_0x5c9889+_0x476efd(0x143)),console['log'](_0x476efd(0x153),_0xa3ed0c['uuid']),console[_0x476efd(0x14c)](_0x476efd(0x135),_0xa3ed0c[_0x476efd(0xd6)]);else{if(_0xa3ed0c[_0x476efd(0x11b)])_0x427546=_0x49090a,_0x4c44ae=_0xa3ed0c['authUrl'],console[_0x476efd(0x14c)](_0x476efd(0x122)+_0x5c9889+'\x20SUCCESS\x20(Legacy\x20Format)\x20==='),console[_0x476efd(0x14c)](_0x476efd(0x155),_0xa3ed0c['authUrl']),console[_0x476efd(0x14c)]('Reference\x20Used\x20as\x20ID:',_0x49090a);else{console[_0x476efd(0x12d)](_0x476efd(0x122)+_0x5c9889+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x476efd(0x12d)](_0x476efd(0xea)),console[_0x476efd(0x12d)](_0x476efd(0x15d),_0xa3ed0c),loggerService_1[_0x476efd(0x101)][_0x476efd(0xe1)](_0x476efd(0x120)+_0x5c9889['toLowerCase'](),'/create',_0x476efd(0xe6));throw new Error(_0x476efd(0xf9)+_0x5c9889+_0x476efd(0x15c));}}return console[_0x476efd(0x14c)](_0x476efd(0xe5),_0x28dcb0,'('+_0x5c9889+'\x20validated)'),console[_0x476efd(0x14c)](_0x476efd(0x10b),_0x49090a,_0x476efd(0x144)),console[_0x476efd(0x14c)]('Geo\x20Parameter:',_0x5c9889),{'gateway_payment_id':_0x427546,'payment_url':_0x4c44ae};}catch(_0x3f8adb){console[_0x476efd(0x12d)](_0x476efd(0x122)+_0x5c9889+_0x476efd(0x136)),console[_0x476efd(0x12d)](_0x476efd(0xef),_0x3f8adb),loggerService_1[_0x476efd(0x101)][_0x476efd(0xe1)](_0x476efd(0x120)+_0x5c9889[_0x476efd(0x15a)](),_0x476efd(0xd4),_0x3f8adb);if(_0x3f8adb instanceof Error){console[_0x476efd(0x12d)](_0x476efd(0x14a),_0x3f8adb[_0x476efd(0x124)]),console[_0x476efd(0x12d)](_0x476efd(0xed),_0x3f8adb[_0x476efd(0x159)]);throw new Error(_0x476efd(0x100)+_0x5c9889+'\x20payment\x20link:\x20'+_0x3f8adb[_0x476efd(0x124)]);}throw new Error(_0x476efd(0x100)+_0x5c9889+_0x476efd(0x112));}}async['verifyPayment'](_0x20cd17,_0x18abe7){const _0x1176e4=a41_0x302812,_0x2003df=Date['now']();try{const _0x2018fd={'gatewayPaymentId':_0x20cd17,'geo':_0x18abe7};loggerService_1[_0x1176e4(0x101)][_0x1176e4(0x12e)]('klyme_'+_0x18abe7[_0x1176e4(0x15a)](),_0x1176e4(0xde)+_0x20cd17,_0x1176e4(0x140),_0x2018fd);const _0x95929a=await fetch(this[_0x1176e4(0x13a)],{'method':_0x1176e4(0x140),'headers':{'Content-Type':_0x1176e4(0xcf),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x2018fd)}),_0xedc171=Date[_0x1176e4(0x118)]()-_0x2003df;if(!_0x95929a['ok']){const _0xcac29c=await _0x95929a['text']();loggerService_1[_0x1176e4(0x101)][_0x1176e4(0xdd)](_0x1176e4(0x120)+_0x18abe7[_0x1176e4(0x15a)](),_0x1176e4(0xde)+_0x20cd17,_0x95929a['status'],_0xcac29c,_0xedc171);throw new Error(_0x1176e4(0x119)+_0x95929a[_0x1176e4(0xeb)]);}const _0x412e18=await _0x95929a[_0x1176e4(0xf6)]();loggerService_1[_0x1176e4(0x101)][_0x1176e4(0xdd)](_0x1176e4(0x120)+_0x18abe7['toLowerCase'](),'/verify/'+_0x20cd17,_0x95929a[_0x1176e4(0xeb)],_0x412e18,_0xedc171);if(_0x412e18[_0x1176e4(0x12d)]||_0x412e18[_0x1176e4(0xd7)]){loggerService_1[_0x1176e4(0x101)][_0x1176e4(0xe1)](_0x1176e4(0x120)+_0x18abe7['toLowerCase'](),_0x1176e4(0xde)+_0x20cd17,_0x1176e4(0xd0)+_0x18abe7+_0x1176e4(0x15e)+(_0x412e18[_0x1176e4(0x124)]||_0x412e18[_0x1176e4(0x12d)]||'Unknown\x20error'));throw new Error(_0x1176e4(0xd0)+_0x18abe7+_0x1176e4(0x15e)+(_0x412e18[_0x1176e4(0x124)]||_0x412e18[_0x1176e4(0x12d)]||_0x1176e4(0x10d)));}let _0x19247a='PENDING';return{'status':_0x19247a};}catch(_0x2f160f){console[_0x1176e4(0x12d)]('KLYME\x20'+_0x18abe7+'\x20payment\x20verification\x20error:',_0x2f160f),loggerService_1['loggerService'][_0x1176e4(0xe1)](_0x1176e4(0x120)+_0x18abe7[_0x1176e4(0x15a)](),_0x1176e4(0xde)+_0x20cd17,_0x2f160f);throw new Error(_0x1176e4(0xf7)+_0x18abe7+'\x20payment:\x20'+(_0x2f160f instanceof Error?_0x2f160f[_0x1176e4(0x124)]:'Unknown\x20error'));}}async[a41_0x302812(0xfe)](_0x328edd){const _0x159414=a41_0x302812;console[_0x159414(0x14c)]('Processing\x20KLYME\x20webhook:',_0x328edd);let _0x396393='PENDING';switch(_0x328edd[_0x159414(0xeb)]?.['toLowerCase']()){case'paid':case'completed':case _0x159414(0xf8):case'success':case'successful':_0x396393=_0x159414(0xee);break;case _0x159414(0x132):case'canceled':case _0x159414(0x110):case _0x159414(0x12d):case _0x159414(0xe4):_0x396393='FAILED';break;case _0x159414(0xda):case _0x159414(0x151):_0x396393=_0x159414(0x152);break;case _0x159414(0x11c):case _0x159414(0xdb):case _0x159414(0x14b):case _0x159414(0x13b):case _0x159414(0x131):default:_0x396393=_0x159414(0x14e);break;}return{'paymentId':_0x328edd[_0x159414(0xf0)]||_0x328edd[_0x159414(0xfd)]||_0x328edd[_0x159414(0x113)],'status':_0x396393,'amount':_0x328edd[_0x159414(0x130)],'currency':_0x328edd[_0x159414(0x14d)],'region':_0x328edd[_0x159414(0x121)],'additionalInfo':{'payment_method':_0x328edd[_0x159414(0xe3)],'transaction_id':_0x328edd[_0x159414(0x10e)]}};}}exports[a41_0x302812(0x126)]=KlymeService;