'use strict';const a67_0x54f988=a67_0x4288;(function(_0x31777a,_0x1df211){const _0x47524f=a67_0x4288,_0x1eefe1=_0x31777a();while(!![]){try{const _0x2b9497=-parseInt(_0x47524f(0x1a6))/0x1+parseInt(_0x47524f(0x196))/0x2*(-parseInt(_0x47524f(0x176))/0x3)+-parseInt(_0x47524f(0x138))/0x4*(-parseInt(_0x47524f(0x168))/0x5)+-parseInt(_0x47524f(0x154))/0x6+-parseInt(_0x47524f(0x177))/0x7*(parseInt(_0x47524f(0x17a))/0x8)+parseInt(_0x47524f(0x191))/0x9+parseInt(_0x47524f(0x137))/0xa;if(_0x2b9497===_0x1df211)break;else _0x1eefe1['push'](_0x1eefe1['shift']());}catch(_0x4444c4){_0x1eefe1['push'](_0x1eefe1['shift']());}}}(a67_0x1d9d,0xcf229));var __createBinding=this&&this['__createBinding']||(Object[a67_0x54f988(0x141)]?function(_0x4ea40b,_0x110ced,_0x3cda3f,_0x33d1e5){const _0x4ead52=a67_0x54f988;if(_0x33d1e5===undefined)_0x33d1e5=_0x3cda3f;var _0x222ac4=Object['getOwnPropertyDescriptor'](_0x110ced,_0x3cda3f);(!_0x222ac4||(_0x4ead52(0x180)in _0x222ac4?!_0x110ced[_0x4ead52(0x142)]:_0x222ac4[_0x4ead52(0x14f)]||_0x222ac4[_0x4ead52(0x120)]))&&(_0x222ac4={'enumerable':!![],'get':function(){return _0x110ced[_0x3cda3f];}}),Object[_0x4ead52(0x189)](_0x4ea40b,_0x33d1e5,_0x222ac4);}:function(_0x2b247c,_0x2ee985,_0x489c07,_0x4540e0){if(_0x4540e0===undefined)_0x4540e0=_0x489c07;_0x2b247c[_0x4540e0]=_0x2ee985[_0x489c07];}),__setModuleDefault=this&&this[a67_0x54f988(0x143)]||(Object[a67_0x54f988(0x141)]?function(_0x54f9ef,_0x4221df){const _0x23c829=a67_0x54f988;Object['defineProperty'](_0x54f9ef,_0x23c829(0x14e),{'enumerable':!![],'value':_0x4221df});}:function(_0x2a6654,_0x40a456){const _0x10699b=a67_0x54f988;_0x2a6654[_0x10699b(0x14e)]=_0x40a456;}),__importStar=this&&this['__importStar']||(function(){var _0x1da631=function(_0x4d219b){const _0x18225f=a67_0x4288;return _0x1da631=Object[_0x18225f(0x16c)]||function(_0x423649){const _0x40288c=_0x18225f;var _0x5f37f2=[];for(var _0x5de279 in _0x423649)if(Object[_0x40288c(0x140)][_0x40288c(0x169)][_0x40288c(0x174)](_0x423649,_0x5de279))_0x5f37f2[_0x5f37f2[_0x40288c(0x147)]]=_0x5de279;return _0x5f37f2;},_0x1da631(_0x4d219b);};return function(_0x339eb3){const _0x521bce=a67_0x4288;if(_0x339eb3&&_0x339eb3['__esModule'])return _0x339eb3;var _0x16dffe={};if(_0x339eb3!=null){for(var _0xe6205c=_0x1da631(_0x339eb3),_0x5ba953=0x0;_0x5ba953<_0xe6205c[_0x521bce(0x147)];_0x5ba953++)if(_0xe6205c[_0x5ba953]!==_0x521bce(0x14e))__createBinding(_0x16dffe,_0x339eb3,_0xe6205c[_0x5ba953]);}return __setModuleDefault(_0x16dffe,_0x339eb3),_0x16dffe;};}());function a67_0x4288(_0x420dfc,_0x2fc01c){_0x420dfc=_0x420dfc-0x11a;const _0x1d9d65=a67_0x1d9d();let _0x42886c=_0x1d9d65[_0x420dfc];return _0x42886c;}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a67_0x54f988(0x16f)]=void 0x0;const loggerService_1=require(a67_0x54f988(0x195));function a67_0x1d9d(){const _0x22201c=['message','267lChHTz','7BbatTz','ðŸŽ¯\x20Generated\x20unique\x20KLYME\x20reference:\x20','order_id','3356608qcdXxJ','Unknown\x20error\x20from\x20KLYME\x20','PAID','\x20currency\x20validation\x20passed:\x20','Failed\x20to\x20verify\x20KLYME\x20','validateCurrencyForRegion','get','\x20API\x20error:\x20','confirmed','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','âš ï¸\x20KLYME\x20reference\x20','completed','https://tesoft.uk/gateway/klyme/','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','in_progress','defineProperty','canceled','/verify/','klyme_','logWhiteDomainResponse','Invalid\x20response\x20from\x20KLYME\x20','Failed\x20to\x20create\x20KLYME\x20','uuid','5898681FuRlhT','timeout','\x20API\x20ERROR\x20===','cancelled','../loggerService','14990TlhAlN','payment','GBP','random','toLowerCase','padStart','text','\x20API','UUID:','payment_id','stringify','Processing\x20KLYME\x20webhook:','ðŸ’³\x20KLYME\x20','Error\x20details:','floor','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','1048498JgqLlh','===\x20KLYME\x20','URL:','status',',\x20body:\x20','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','(8digits-8digits\x20format)','fromEntries','\x20payment\x20link:\x20','Error\x20message:','parse','reference','configurable','rejected','now','Raw\x20Response\x20Body:','findFirst','statusText','EXPIRED','\x20payment\x20link:\x20Unknown\x20error','pending','Redirect\x20URL:','Geo\x20Parameter:','Error\x20stack:','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','https://tesoft.uk/gateway/pending.php?id=','Error\x20Message:','Response\x20Body:','apiUrl','error','processing','failed','\x20SUCCESS\x20(New\x20Format)\x20===','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','HTTP\x20error!\x20status:\x20','18996270IZGixd','62612RTJofS','statusCode','headers','region','Reference:','/create','amount','active','prototype','create','__esModule','__setModuleDefault','authUrl','Reference\x20Used\x20as\x20ID:','loggerService','length','Status\x20Text:','generateUniqueReference','createPaymentLink','Response\x20Time:','then','PENDING','default','writable','\x20payment\x20verification\x20error:','Payment\x20System/1.0','Reference\x20Used:','\x20SUCCESS\x20(Legacy\x20Format)\x20===','2594382nLsGMI','Business\x20Error:\x20','\x20API\x20BUSINESS\x20ERROR\x20===','KLYME\x20','POST','../../config/database','application/json','Unknown\x20error','stack','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','expired','Currency\x20Used:','redirect_url','transaction_id','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','logWhiteDomainError','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','\x20RESPONSE\x20===','json','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','275dGRsqW','hasOwnProperty','Headers:','success','getOwnPropertyNames','log','logWhiteDomainRequest','KlymeService','paid','processWebhook','Unsupported\x20KLYME\x20region:\x20','\x20API:\x20','call'];a67_0x1d9d=function(){return _0x22201c;};return a67_0x1d9d();}class KlymeService{constructor(){const _0x2056fb=a67_0x54f988;this[_0x2056fb(0x130)]=_0x2056fb(0x186),console[_0x2056fb(0x16d)]('ðŸ’³\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions');}[a67_0x54f988(0x17f)](_0x464d68,_0x20ebad){const _0x1cb12a=a67_0x54f988,_0x66b348=_0x464d68['toUpperCase']();switch(_0x20ebad){case'EU':if(_0x66b348!=='EUR')throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x66b348);break;case'GB':if(_0x66b348!==_0x1cb12a(0x198))throw new Error(_0x1cb12a(0x183)+_0x66b348);break;case'DE':if(_0x66b348!=='EUR')throw new Error(_0x1cb12a(0x1ab)+_0x66b348);break;default:throw new Error(_0x1cb12a(0x172)+_0x20ebad);}}async[a67_0x54f988(0x149)](){const _0x562436=a67_0x54f988,_0x4fd1f4=(await Promise['resolve']()[_0x562436(0x14c)](()=>__importStar(require(_0x562436(0x159)))))['default'];let _0xf36f64,_0x345877=0x0;const _0x385e61=0xa;do{const _0x104c61=()=>{const _0x20d020=_0x562436;return Math[_0x20d020(0x1a4)](Math[_0x20d020(0x199)]()*0x5f5e100)['toString']()[_0x20d020(0x19b)](0x8,'0');};_0xf36f64=_0x104c61()+'-'+_0x104c61();const _0x493e7a=await _0x4fd1f4[_0x562436(0x197)][_0x562436(0x124)]({'where':{'gatewayOrderId':_0xf36f64}});if(!_0x493e7a)break;_0x345877++,console[_0x562436(0x16d)](_0x562436(0x184)+_0xf36f64+_0x562436(0x187)+_0x345877+')');}while(_0x345877<_0x385e61);if(_0x345877>=_0x385e61)throw new Error(_0x562436(0x15d));return _0xf36f64;}async[a67_0x54f988(0x14a)](_0x2e67ee){const _0x9702ad=a67_0x54f988,{orderId:_0x436ed3,amount:_0x4db6d3,currency:_0x6760e8,region:_0x182e9d}=_0x2e67ee;if(_0x182e9d!=='EU'&&_0x182e9d!=='GB'&&_0x182e9d!=='DE')throw new Error(_0x9702ad(0x1a5)+_0x182e9d);this[_0x9702ad(0x17f)](_0x6760e8,_0x182e9d);const _0x3b6ba4=_0x6760e8['toUpperCase']();console[_0x9702ad(0x16d)](_0x9702ad(0x1a2)+_0x182e9d+_0x9702ad(0x17d)+_0x3b6ba4);const _0x49115c=await this['generateUniqueReference']();console[_0x9702ad(0x16d)](_0x9702ad(0x178)+_0x49115c+'\x20(8digits-8digits\x20format\x20for\x20'+_0x182e9d+')');const _0x3c340d=_0x9702ad(0x12d)+_0x436ed3,_0x18f21e={'amount':_0x4db6d3,'currency':_0x3b6ba4,'redirectUrl':_0x3c340d,'reference':_0x49115c,'geo':_0x182e9d},_0x14bf61=Date[_0x9702ad(0x122)]();try{console[_0x9702ad(0x16d)](_0x9702ad(0x1a7)+_0x182e9d+_0x9702ad(0x135)),console[_0x9702ad(0x16d)](_0x9702ad(0x1a8),this['apiUrl']),console[_0x9702ad(0x16d)]('Request\x20Body:',JSON[_0x9702ad(0x1a0)](_0x18f21e,null,0x2)),console[_0x9702ad(0x16d)]('Region\x20(geo):',_0x182e9d),console[_0x9702ad(0x16d)]('Currency:',_0x3b6ba4,'(validated\x20for\x20'+_0x182e9d+')'),console[_0x9702ad(0x16d)](_0x9702ad(0x13c),_0x49115c,_0x9702ad(0x11a)),console['log']('Redirect\x20URL:',_0x3c340d),loggerService_1[_0x9702ad(0x146)][_0x9702ad(0x16e)](_0x9702ad(0x18c)+_0x182e9d[_0x9702ad(0x19a)](),_0x9702ad(0x13d),_0x9702ad(0x158),_0x18f21e);const _0xc783ca=await fetch(this['apiUrl'],{'method':'POST','headers':{'Content-Type':_0x9702ad(0x15a),'Accept':_0x9702ad(0x15a),'User-Agent':_0x9702ad(0x151)},'body':JSON[_0x9702ad(0x1a0)](_0x18f21e)}),_0x22a0ef=Date[_0x9702ad(0x122)]()-_0x14bf61;console[_0x9702ad(0x16d)](_0x9702ad(0x1a7)+_0x182e9d+_0x9702ad(0x162)),console[_0x9702ad(0x16d)]('Status:',_0xc783ca['status']),console[_0x9702ad(0x16d)](_0x9702ad(0x148),_0xc783ca[_0x9702ad(0x125)]),console[_0x9702ad(0x16d)](_0x9702ad(0x16a),Object[_0x9702ad(0x11b)](_0xc783ca[_0x9702ad(0x13a)]['entries']())),console[_0x9702ad(0x16d)](_0x9702ad(0x14b),_0x22a0ef+'ms');const _0x2343f3=await _0xc783ca[_0x9702ad(0x19c)]();console[_0x9702ad(0x16d)](_0x9702ad(0x123),_0x2343f3);if(!_0xc783ca['ok']){console[_0x9702ad(0x131)](_0x9702ad(0x1a7)+_0x182e9d+_0x9702ad(0x193)),console[_0x9702ad(0x131)]('HTTP\x20Status:',_0xc783ca[_0x9702ad(0x1a9)]),console[_0x9702ad(0x131)](_0x9702ad(0x12f),_0x2343f3),loggerService_1[_0x9702ad(0x146)][_0x9702ad(0x18d)](_0x9702ad(0x18c)+_0x182e9d['toLowerCase'](),_0x9702ad(0x13d),_0xc783ca[_0x9702ad(0x1a9)],_0x2343f3,_0x22a0ef),loggerService_1[_0x9702ad(0x146)][_0x9702ad(0x163)]('klyme_'+_0x182e9d['toLowerCase'](),'/create','HTTP\x20'+_0xc783ca[_0x9702ad(0x1a9)]+':\x20'+_0x2343f3);throw new Error('HTTP\x20error!\x20status:\x20'+_0xc783ca['status']+_0x9702ad(0x1aa)+_0x2343f3);}let _0x502595;try{_0x502595=JSON[_0x9702ad(0x11e)](_0x2343f3);}catch(_0x1d36c7){console[_0x9702ad(0x131)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x1d36c7),loggerService_1[_0x9702ad(0x146)][_0x9702ad(0x163)](_0x9702ad(0x18c)+_0x182e9d[_0x9702ad(0x19a)](),_0x9702ad(0x13d),'JSON\x20Parse\x20Error:\x20'+_0x1d36c7);throw new Error(_0x9702ad(0x164)+_0x182e9d+_0x9702ad(0x173)+_0x2343f3);}console['log']('===\x20PARSED\x20KLYME\x20'+_0x182e9d+_0x9702ad(0x165)),console[_0x9702ad(0x16d)]('Parsed\x20Result:',JSON[_0x9702ad(0x1a0)](_0x502595,null,0x2)),loggerService_1[_0x9702ad(0x146)][_0x9702ad(0x18d)](_0x9702ad(0x18c)+_0x182e9d['toLowerCase'](),_0x9702ad(0x13d),_0xc783ca[_0x9702ad(0x1a9)],_0x502595,_0x22a0ef);if(_0x502595[_0x9702ad(0x131)]||_0x502595[_0x9702ad(0x139)]){const _0x1d9b44=_0x502595['message']||_0x502595[_0x9702ad(0x131)]||_0x9702ad(0x17b)+_0x182e9d+_0x9702ad(0x19d);console[_0x9702ad(0x131)](_0x9702ad(0x1a7)+_0x182e9d+_0x9702ad(0x156)),console[_0x9702ad(0x131)](_0x9702ad(0x12e),_0x1d9b44),console[_0x9702ad(0x131)]('Status\x20Code:',_0x502595[_0x9702ad(0x139)]),loggerService_1['loggerService'][_0x9702ad(0x163)](_0x9702ad(0x18c)+_0x182e9d[_0x9702ad(0x19a)](),_0x9702ad(0x13d),_0x9702ad(0x155)+_0x1d9b44);throw new Error('KLYME\x20'+_0x182e9d+_0x9702ad(0x181)+_0x1d9b44);}let _0x3ad44d,_0x550116;if(_0x502595[_0x9702ad(0x190)]&&_0x502595[_0x9702ad(0x160)])_0x3ad44d=_0x502595[_0x9702ad(0x190)],_0x550116=_0x502595[_0x9702ad(0x160)],console['log']('===\x20KLYME\x20'+_0x182e9d+_0x9702ad(0x134)),console[_0x9702ad(0x16d)](_0x9702ad(0x19e),_0x502595[_0x9702ad(0x190)]),console[_0x9702ad(0x16d)](_0x9702ad(0x129),_0x502595['redirect_url']);else{if(_0x502595[_0x9702ad(0x144)])_0x3ad44d=_0x49115c,_0x550116=_0x502595[_0x9702ad(0x144)],console['log'](_0x9702ad(0x1a7)+_0x182e9d+_0x9702ad(0x153)),console[_0x9702ad(0x16d)]('Auth\x20URL:',_0x502595['authUrl']),console[_0x9702ad(0x16d)](_0x9702ad(0x145),_0x49115c);else{console['error']('===\x20KLYME\x20'+_0x182e9d+_0x9702ad(0x167)),console['error'](_0x9702ad(0x12c)),console[_0x9702ad(0x131)]('Response\x20data:',_0x502595),loggerService_1[_0x9702ad(0x146)][_0x9702ad(0x163)](_0x9702ad(0x18c)+_0x182e9d['toLowerCase'](),_0x9702ad(0x13d),'Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl');throw new Error(_0x9702ad(0x18e)+_0x182e9d+'\x20API:\x20missing\x20payment\x20data');}}return console[_0x9702ad(0x16d)](_0x9702ad(0x15f),_0x3b6ba4,'('+_0x182e9d+'\x20validated)'),console['log'](_0x9702ad(0x152),_0x49115c,_0x9702ad(0x11a)),console[_0x9702ad(0x16d)](_0x9702ad(0x12a),_0x182e9d),{'gateway_payment_id':_0x3ad44d,'payment_url':_0x550116};}catch(_0x158dc7){console[_0x9702ad(0x131)](_0x9702ad(0x1a7)+_0x182e9d+'\x20SERVICE\x20ERROR\x20==='),console[_0x9702ad(0x131)](_0x9702ad(0x1a3),_0x158dc7),loggerService_1['loggerService'][_0x9702ad(0x163)](_0x9702ad(0x18c)+_0x182e9d[_0x9702ad(0x19a)](),_0x9702ad(0x13d),_0x158dc7);if(_0x158dc7 instanceof Error){console[_0x9702ad(0x131)](_0x9702ad(0x11d),_0x158dc7['message']),console[_0x9702ad(0x131)](_0x9702ad(0x12b),_0x158dc7[_0x9702ad(0x15c)]);throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0x182e9d+_0x9702ad(0x11c)+_0x158dc7['message']);}throw new Error(_0x9702ad(0x18f)+_0x182e9d+_0x9702ad(0x127));}}async['verifyPayment'](_0x3cd50f,_0x59d603){const _0x394342=a67_0x54f988,_0x3a9b27=Date[_0x394342(0x122)]();try{const _0x29ae8b={'gatewayPaymentId':_0x3cd50f,'geo':_0x59d603};loggerService_1[_0x394342(0x146)]['logWhiteDomainRequest'](_0x394342(0x18c)+_0x59d603[_0x394342(0x19a)](),_0x394342(0x18b)+_0x3cd50f,_0x394342(0x158),_0x29ae8b);const _0x121f6a=await fetch(this[_0x394342(0x130)],{'method':'POST','headers':{'Content-Type':_0x394342(0x15a),'User-Agent':_0x394342(0x151)},'body':JSON[_0x394342(0x1a0)](_0x29ae8b)}),_0x38b8eb=Date[_0x394342(0x122)]()-_0x3a9b27;if(!_0x121f6a['ok']){const _0x1c25e7=await _0x121f6a['text']();loggerService_1[_0x394342(0x146)][_0x394342(0x18d)]('klyme_'+_0x59d603[_0x394342(0x19a)](),_0x394342(0x18b)+_0x3cd50f,_0x121f6a[_0x394342(0x1a9)],_0x1c25e7,_0x38b8eb);throw new Error(_0x394342(0x136)+_0x121f6a['status']);}const _0x33b88f=await _0x121f6a[_0x394342(0x166)]();loggerService_1[_0x394342(0x146)][_0x394342(0x18d)]('klyme_'+_0x59d603[_0x394342(0x19a)](),_0x394342(0x18b)+_0x3cd50f,_0x121f6a['status'],_0x33b88f,_0x38b8eb);if(_0x33b88f[_0x394342(0x131)]||_0x33b88f[_0x394342(0x139)]){loggerService_1['loggerService']['logWhiteDomainError']('klyme_'+_0x59d603[_0x394342(0x19a)](),_0x394342(0x18b)+_0x3cd50f,_0x394342(0x157)+_0x59d603+'\x20API\x20error:\x20'+(_0x33b88f[_0x394342(0x175)]||_0x33b88f['error']||'Unknown\x20error'));throw new Error(_0x394342(0x157)+_0x59d603+'\x20API\x20error:\x20'+(_0x33b88f[_0x394342(0x175)]||_0x33b88f[_0x394342(0x131)]||'Unknown\x20error'));}let _0x4ecae0=_0x394342(0x14d);return{'status':_0x4ecae0};}catch(_0x13f566){console[_0x394342(0x131)](_0x394342(0x157)+_0x59d603+_0x394342(0x150),_0x13f566),loggerService_1[_0x394342(0x146)][_0x394342(0x163)](_0x394342(0x18c)+_0x59d603['toLowerCase'](),_0x394342(0x18b)+_0x3cd50f,_0x13f566);throw new Error(_0x394342(0x17e)+_0x59d603+'\x20payment:\x20'+(_0x13f566 instanceof Error?_0x13f566[_0x394342(0x175)]:_0x394342(0x15b)));}}async[a67_0x54f988(0x171)](_0x222ba6){const _0x51e27c=a67_0x54f988;console[_0x51e27c(0x16d)](_0x51e27c(0x1a1),_0x222ba6);let _0x144e42=_0x51e27c(0x14d);switch(_0x222ba6['status']?.[_0x51e27c(0x19a)]()){case _0x51e27c(0x170):case _0x51e27c(0x185):case _0x51e27c(0x182):case _0x51e27c(0x16b):case'successful':_0x144e42=_0x51e27c(0x17c);break;case _0x51e27c(0x194):case _0x51e27c(0x18a):case _0x51e27c(0x133):case'error':case _0x51e27c(0x121):_0x144e42='FAILED';break;case _0x51e27c(0x15e):case _0x51e27c(0x192):_0x144e42=_0x51e27c(0x126);break;case _0x51e27c(0x128):case'created':case _0x51e27c(0x13f):case _0x51e27c(0x132):case _0x51e27c(0x188):default:_0x144e42=_0x51e27c(0x14d);break;}return{'paymentId':_0x222ba6[_0x51e27c(0x11f)]||_0x222ba6[_0x51e27c(0x179)]||_0x222ba6[_0x51e27c(0x19f)],'status':_0x144e42,'amount':_0x222ba6[_0x51e27c(0x13e)],'currency':_0x222ba6['currency'],'region':_0x222ba6[_0x51e27c(0x13b)],'additionalInfo':{'payment_method':_0x222ba6['payment_method'],'transaction_id':_0x222ba6[_0x51e27c(0x161)]}};}}exports[a67_0x54f988(0x16f)]=KlymeService;