'use strict';const a41_0x1b0a3d=a41_0x18f0;function a41_0x3603(){const _0x5d65d3=['Invalid\x20response\x20from\x20KLYME\x20',',\x20body:\x20','amount','Status:','resolve','\x20RESPONSE\x20===','writable','1509725qiZRsf','reference','hasOwnProperty','configurable','random','successful','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','\x20(8digits-8digits\x20format\x20for\x20','JSON\x20Parse\x20Error:\x20','then','Unknown\x20error','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','parse','redirect_url','toLowerCase','HTTP\x20error!\x20status:\x20','headers','verifyPayment','uuid','Failed\x20to\x20create\x20KLYME\x20','2752374GprVyh','\x20API:\x20','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','canceled','entries','335050khPErK','order_id','generateUniqueReference','Response\x20Body:','rejected','floor','pending','\x20payment\x20verification\x20error:','status','now','Error\x20details:','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','../loggerService','https://tesoft.uk/gateway/pending.php?id=','region','TesSoft\x20Payment\x20System/1.0','\x20validated)','stringify','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x20API\x20BUSINESS\x20ERROR\x20===','(8digits-8digits\x20format)','findFirst','payment','paid','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','json','Unknown\x20error\x20from\x20KLYME\x20','2895328CXszvk','GBP','13495392IfTsts','logWhiteDomainResponse','create','expired','Unsupported\x20KLYME\x20region:\x20','getOwnPropertyNames','__importStar','4989786wkMNcB','padStart','toString','Currency:','defineProperty','POST','16tKiXuV','confirmed','fromEntries','getOwnPropertyDescriptor','payment_id','Error\x20Message:','default','authUrl','üí≥\x20KLYME\x20','success','failed','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','Auth\x20URL:','apiUrl','‚ö†Ô∏è\x20KLYME\x20reference\x20','log','\x20API\x20error:\x20','\x20currency\x20validation\x20passed:\x20','KLYME\x20','Response\x20data:','call','===\x20PARSED\x20KLYME\x20','\x20API:\x20missing\x20payment\x20data','URL:','Failed\x20to\x20verify\x20KLYME\x20','Status\x20Code:','/verify/','Raw\x20Response\x20Body:','stack','logWhiteDomainError','Redirect\x20URL:','Parsed\x20Result:','../../config/database','prototype','in_progress','7OJWjCW','\x20SUCCESS\x20(Legacy\x20Format)\x20===','__setModuleDefault','payment_method','length','\x20SERVICE\x20ERROR\x20===','Reference\x20Used:','\x20payment\x20link:\x20','statusCode','\x20API','toUpperCase','===\x20KLYME\x20','EUR','cancelled','__esModule','logWhiteDomainRequest','Request\x20Body:','message','error','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','PENDING','active','klyme_','/create','application/json','loggerService','text','KlymeService','(validated\x20for\x20','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','EXPIRED','Failed\x20to\x20parse\x20JSON\x20response:','\x20payment:\x20','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Reference:','completed','validateCurrencyForRegion','2686852BNuQTK'];a41_0x3603=function(){return _0x5d65d3;};return a41_0x3603();}(function(_0x5b4677,_0x567deb){const _0x560452=a41_0x18f0,_0x1247cc=_0x5b4677();while(!![]){try{const _0x2e4121=parseInt(_0x560452(0x1b3))/0x1+-parseInt(_0x560452(0x1ab))/0x2+parseInt(_0x560452(0x15d))/0x3+-parseInt(_0x560452(0x163))/0x4*(parseInt(_0x560452(0x1cc))/0x5)+-parseInt(_0x560452(0x1c7))/0x6*(-parseInt(_0x560452(0x186))/0x7)+parseInt(_0x560452(0x154))/0x8+-parseInt(_0x560452(0x156))/0x9;if(_0x2e4121===_0x567deb)break;else _0x1247cc['push'](_0x1247cc['shift']());}catch(_0x59cdf7){_0x1247cc['push'](_0x1247cc['shift']());}}}(a41_0x3603,0xd77f6));var __createBinding=this&&this['__createBinding']||(Object[a41_0x1b0a3d(0x158)]?function(_0x495492,_0x3f20ca,_0xcb7c08,_0x5336a2){const _0x34cd58=a41_0x1b0a3d;if(_0x5336a2===undefined)_0x5336a2=_0xcb7c08;var _0x430483=Object[_0x34cd58(0x166)](_0x3f20ca,_0xcb7c08);(!_0x430483||('get'in _0x430483?!_0x3f20ca['__esModule']:_0x430483[_0x34cd58(0x1b2)]||_0x430483[_0x34cd58(0x1b6)]))&&(_0x430483={'enumerable':!![],'get':function(){return _0x3f20ca[_0xcb7c08];}}),Object[_0x34cd58(0x161)](_0x495492,_0x5336a2,_0x430483);}:function(_0x433c37,_0xf8ac17,_0x3a1340,_0x371b1f){if(_0x371b1f===undefined)_0x371b1f=_0x3a1340;_0x433c37[_0x371b1f]=_0xf8ac17[_0x3a1340];}),__setModuleDefault=this&&this[a41_0x1b0a3d(0x188)]||(Object[a41_0x1b0a3d(0x158)]?function(_0x189412,_0x1b8da7){const _0x1fff7e=a41_0x1b0a3d;Object[_0x1fff7e(0x161)](_0x189412,_0x1fff7e(0x169),{'enumerable':!![],'value':_0x1b8da7});}:function(_0x56dcc3,_0x51c0c2){_0x56dcc3['default']=_0x51c0c2;}),__importStar=this&&this[a41_0x1b0a3d(0x15c)]||(function(){var _0x3ed086=function(_0x257700){const _0x5e4c8f=a41_0x18f0;return _0x3ed086=Object[_0x5e4c8f(0x15b)]||function(_0x2a07b8){const _0x4e73af=_0x5e4c8f;var _0x52a1ca=[];for(var _0x184aaa in _0x2a07b8)if(Object[_0x4e73af(0x184)][_0x4e73af(0x1b5)][_0x4e73af(0x177)](_0x2a07b8,_0x184aaa))_0x52a1ca[_0x52a1ca['length']]=_0x184aaa;return _0x52a1ca;},_0x3ed086(_0x257700);};return function(_0x2eab63){const _0x8d1f95=a41_0x18f0;if(_0x2eab63&&_0x2eab63[_0x8d1f95(0x194)])return _0x2eab63;var _0x20290c={};if(_0x2eab63!=null){for(var _0x95ade3=_0x3ed086(_0x2eab63),_0xd15e95=0x0;_0xd15e95<_0x95ade3[_0x8d1f95(0x18a)];_0xd15e95++)if(_0x95ade3[_0xd15e95]!==_0x8d1f95(0x169))__createBinding(_0x20290c,_0x2eab63,_0x95ade3[_0xd15e95]);}return __setModuleDefault(_0x20290c,_0x2eab63),_0x20290c;};}());Object[a41_0x1b0a3d(0x161)](exports,a41_0x1b0a3d(0x194),{'value':!![]}),exports[a41_0x1b0a3d(0x1a1)]=void 0x0;function a41_0x18f0(_0x22d3d6,_0x5759c8){const _0x360368=a41_0x3603();return a41_0x18f0=function(_0x18f056,_0x5e1a9b){_0x18f056=_0x18f056-0x14e;let _0x128651=_0x360368[_0x18f056];return _0x128651;},a41_0x18f0(_0x22d3d6,_0x5759c8);}const loggerService_1=require(a41_0x1b0a3d(0x1d8));class KlymeService{constructor(){const _0x8a3b29=a41_0x1b0a3d;this[_0x8a3b29(0x170)]='https://tesoft.uk/gateway/klyme/',console[_0x8a3b29(0x172)](_0x8a3b29(0x1be));}[a41_0x1b0a3d(0x1aa)](_0x4772d9,_0x29c3e2){const _0x29bb74=a41_0x1b0a3d,_0x23eac2=_0x4772d9['toUpperCase']();switch(_0x29c3e2){case'EU':if(_0x23eac2!=='EUR')throw new Error(_0x29bb74(0x1de)+_0x23eac2);break;case'GB':if(_0x23eac2!==_0x29bb74(0x155))throw new Error(_0x29bb74(0x16e)+_0x23eac2);break;case'DE':if(_0x23eac2!==_0x29bb74(0x192))throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x23eac2);break;default:throw new Error(_0x29bb74(0x15a)+_0x29c3e2);}}async[a41_0x1b0a3d(0x1ce)](){const _0x37be83=a41_0x1b0a3d,_0x1d0def=(await Promise[_0x37be83(0x1b0)]()[_0x37be83(0x1bc)](()=>__importStar(require(_0x37be83(0x183)))))[_0x37be83(0x169)];let _0x5d67bc,_0x269396=0x0;const _0x568973=0xa;do{const _0x6850c2=()=>{const _0x492562=_0x37be83;return Math[_0x492562(0x1d1)](Math[_0x492562(0x1b7)]()*0x5f5e100)[_0x492562(0x15f)]()[_0x492562(0x15e)](0x8,'0');};_0x5d67bc=_0x6850c2()+'-'+_0x6850c2();const _0x26e838=await _0x1d0def[_0x37be83(0x14f)][_0x37be83(0x14e)]({'where':{'gatewayOrderId':_0x5d67bc}});if(!_0x26e838)break;_0x269396++,console[_0x37be83(0x172)](_0x37be83(0x171)+_0x5d67bc+'\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20'+_0x269396+')');}while(_0x269396<_0x568973);if(_0x269396>=_0x568973)throw new Error(_0x37be83(0x1c9));return _0x5d67bc;}async['createPaymentLink'](_0x5360a1){const _0x177601=a41_0x1b0a3d,{orderId:_0x5d3977,amount:_0x9bce5f,currency:_0x42e4c2,region:_0x42efcb}=_0x5360a1;if(_0x42efcb!=='EU'&&_0x42efcb!=='GB'&&_0x42efcb!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x42efcb);this[_0x177601(0x1aa)](_0x42e4c2,_0x42efcb);const _0x458240=_0x42e4c2[_0x177601(0x190)]();console['log'](_0x177601(0x16b)+_0x42efcb+_0x177601(0x174)+_0x458240);const _0x6b6539=await this[_0x177601(0x1ce)]();console[_0x177601(0x172)](_0x177601(0x1a3)+_0x6b6539+_0x177601(0x1ba)+_0x42efcb+')');const _0x3d333d=_0x177601(0x1d9)+_0x5d3977,_0x5fc69f={'amount':_0x9bce5f,'currency':_0x458240,'redirectUrl':_0x3d333d,'reference':_0x6b6539,'geo':_0x42efcb},_0x2f61bb=Date[_0x177601(0x1d5)]();try{console[_0x177601(0x172)](_0x177601(0x191)+_0x42efcb+_0x177601(0x199)),console[_0x177601(0x172)](_0x177601(0x17a),this[_0x177601(0x170)]),console[_0x177601(0x172)](_0x177601(0x196),JSON['stringify'](_0x5fc69f,null,0x2)),console[_0x177601(0x172)]('Region\x20(geo):',_0x42efcb),console[_0x177601(0x172)](_0x177601(0x160),_0x458240,_0x177601(0x1a2)+_0x42efcb+')'),console[_0x177601(0x172)](_0x177601(0x1a8),_0x6b6539,_0x177601(0x1e0)),console[_0x177601(0x172)](_0x177601(0x181),_0x3d333d),loggerService_1[_0x177601(0x19f)][_0x177601(0x195)]('klyme_'+_0x42efcb[_0x177601(0x1c1)](),_0x177601(0x19d),'POST',_0x5fc69f);const _0x2f639a=await fetch(this['apiUrl'],{'method':'POST','headers':{'Content-Type':_0x177601(0x19e),'Accept':_0x177601(0x19e),'User-Agent':_0x177601(0x1db)},'body':JSON[_0x177601(0x1dd)](_0x5fc69f)}),_0x2cb069=Date[_0x177601(0x1d5)]()-_0x2f61bb;console[_0x177601(0x172)](_0x177601(0x191)+_0x42efcb+_0x177601(0x151)),console[_0x177601(0x172)](_0x177601(0x1af),_0x2f639a[_0x177601(0x1d4)]),console[_0x177601(0x172)]('Status\x20Text:',_0x2f639a['statusText']),console['log']('Headers:',Object[_0x177601(0x165)](_0x2f639a[_0x177601(0x1c3)][_0x177601(0x1cb)]())),console[_0x177601(0x172)]('Response\x20Time:',_0x2cb069+'ms');const _0x40c5c6=await _0x2f639a[_0x177601(0x1a0)]();console[_0x177601(0x172)](_0x177601(0x17e),_0x40c5c6);if(!_0x2f639a['ok']){console[_0x177601(0x198)](_0x177601(0x191)+_0x42efcb+'\x20API\x20ERROR\x20==='),console['error']('HTTP\x20Status:',_0x2f639a[_0x177601(0x1d4)]),console[_0x177601(0x198)](_0x177601(0x1cf),_0x40c5c6),loggerService_1['loggerService'][_0x177601(0x157)](_0x177601(0x19c)+_0x42efcb[_0x177601(0x1c1)](),_0x177601(0x19d),_0x2f639a[_0x177601(0x1d4)],_0x40c5c6,_0x2cb069),loggerService_1[_0x177601(0x19f)]['logWhiteDomainError']('klyme_'+_0x42efcb[_0x177601(0x1c1)](),_0x177601(0x19d),'HTTP\x20'+_0x2f639a[_0x177601(0x1d4)]+':\x20'+_0x40c5c6);throw new Error('HTTP\x20error!\x20status:\x20'+_0x2f639a[_0x177601(0x1d4)]+_0x177601(0x1ad)+_0x40c5c6);}let _0x2b03cb;try{_0x2b03cb=JSON[_0x177601(0x1bf)](_0x40c5c6);}catch(_0x2a2f59){console[_0x177601(0x198)](_0x177601(0x1a5),_0x2a2f59),loggerService_1[_0x177601(0x19f)][_0x177601(0x180)](_0x177601(0x19c)+_0x42efcb[_0x177601(0x1c1)](),'/create',_0x177601(0x1bb)+_0x2a2f59);throw new Error(_0x177601(0x1b9)+_0x42efcb+_0x177601(0x1c8)+_0x40c5c6);}console[_0x177601(0x172)](_0x177601(0x178)+_0x42efcb+_0x177601(0x1b1)),console[_0x177601(0x172)](_0x177601(0x182),JSON[_0x177601(0x1dd)](_0x2b03cb,null,0x2)),loggerService_1[_0x177601(0x19f)][_0x177601(0x157)](_0x177601(0x19c)+_0x42efcb['toLowerCase'](),'/create',_0x2f639a[_0x177601(0x1d4)],_0x2b03cb,_0x2cb069);if(_0x2b03cb[_0x177601(0x198)]||_0x2b03cb[_0x177601(0x18e)]){const _0x49273e=_0x2b03cb['message']||_0x2b03cb[_0x177601(0x198)]||_0x177601(0x153)+_0x42efcb+_0x177601(0x18f);console['error'](_0x177601(0x191)+_0x42efcb+_0x177601(0x1df)),console[_0x177601(0x198)](_0x177601(0x168),_0x49273e),console[_0x177601(0x198)](_0x177601(0x17c),_0x2b03cb['statusCode']),loggerService_1[_0x177601(0x19f)][_0x177601(0x180)](_0x177601(0x19c)+_0x42efcb[_0x177601(0x1c1)](),_0x177601(0x19d),'Business\x20Error:\x20'+_0x49273e);throw new Error(_0x177601(0x175)+_0x42efcb+_0x177601(0x173)+_0x49273e);}let _0x2458b3,_0x43487b;if(_0x2b03cb['uuid']&&_0x2b03cb[_0x177601(0x1c0)])_0x2458b3=_0x2b03cb['uuid'],_0x43487b=_0x2b03cb[_0x177601(0x1c0)],console[_0x177601(0x172)]('===\x20KLYME\x20'+_0x42efcb+'\x20SUCCESS\x20(New\x20Format)\x20==='),console[_0x177601(0x172)]('UUID:',_0x2b03cb[_0x177601(0x1c5)]),console['log'](_0x177601(0x181),_0x2b03cb[_0x177601(0x1c0)]);else{if(_0x2b03cb[_0x177601(0x16a)])_0x2458b3=_0x6b6539,_0x43487b=_0x2b03cb[_0x177601(0x16a)],console['log'](_0x177601(0x191)+_0x42efcb+_0x177601(0x187)),console[_0x177601(0x172)](_0x177601(0x16f),_0x2b03cb[_0x177601(0x16a)]),console[_0x177601(0x172)]('Reference\x20Used\x20as\x20ID:',_0x6b6539);else{console[_0x177601(0x198)](_0x177601(0x191)+_0x42efcb+_0x177601(0x1a7)),console[_0x177601(0x198)]('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console[_0x177601(0x198)](_0x177601(0x176),_0x2b03cb),loggerService_1['loggerService'][_0x177601(0x180)]('klyme_'+_0x42efcb[_0x177601(0x1c1)](),'/create',_0x177601(0x1d7));throw new Error(_0x177601(0x1ac)+_0x42efcb+_0x177601(0x179));}}return console[_0x177601(0x172)]('Currency\x20Used:',_0x458240,'('+_0x42efcb+_0x177601(0x1dc)),console['log'](_0x177601(0x18c),_0x6b6539,_0x177601(0x1e0)),console[_0x177601(0x172)]('Geo\x20Parameter:',_0x42efcb),{'gateway_payment_id':_0x2458b3,'payment_url':_0x43487b};}catch(_0x3f6165){console[_0x177601(0x198)](_0x177601(0x191)+_0x42efcb+_0x177601(0x18b)),console['error'](_0x177601(0x1d6),_0x3f6165),loggerService_1[_0x177601(0x19f)][_0x177601(0x180)](_0x177601(0x19c)+_0x42efcb[_0x177601(0x1c1)](),'/create',_0x3f6165);if(_0x3f6165 instanceof Error){console['error']('Error\x20message:',_0x3f6165[_0x177601(0x197)]),console[_0x177601(0x198)]('Error\x20stack:',_0x3f6165[_0x177601(0x17f)]);throw new Error(_0x177601(0x1c6)+_0x42efcb+_0x177601(0x18d)+_0x3f6165[_0x177601(0x197)]);}throw new Error(_0x177601(0x1c6)+_0x42efcb+'\x20payment\x20link:\x20Unknown\x20error');}}async[a41_0x1b0a3d(0x1c4)](_0x1a4dd7,_0xad508f){const _0x1ca5e9=a41_0x1b0a3d,_0x1a4cd8=Date['now']();try{const _0x8e4f0a={'gatewayPaymentId':_0x1a4dd7,'geo':_0xad508f};loggerService_1[_0x1ca5e9(0x19f)][_0x1ca5e9(0x195)]('klyme_'+_0xad508f[_0x1ca5e9(0x1c1)](),_0x1ca5e9(0x17d)+_0x1a4dd7,'POST',_0x8e4f0a);const _0x3f226d=await fetch(this['apiUrl'],{'method':_0x1ca5e9(0x162),'headers':{'Content-Type':_0x1ca5e9(0x19e),'User-Agent':_0x1ca5e9(0x1db)},'body':JSON[_0x1ca5e9(0x1dd)](_0x8e4f0a)}),_0xfaa7dd=Date['now']()-_0x1a4cd8;if(!_0x3f226d['ok']){const _0x352ac8=await _0x3f226d[_0x1ca5e9(0x1a0)]();loggerService_1[_0x1ca5e9(0x19f)][_0x1ca5e9(0x157)](_0x1ca5e9(0x19c)+_0xad508f[_0x1ca5e9(0x1c1)](),_0x1ca5e9(0x17d)+_0x1a4dd7,_0x3f226d['status'],_0x352ac8,_0xfaa7dd);throw new Error(_0x1ca5e9(0x1c2)+_0x3f226d[_0x1ca5e9(0x1d4)]);}const _0x472e1e=await _0x3f226d[_0x1ca5e9(0x152)]();loggerService_1['loggerService'][_0x1ca5e9(0x157)]('klyme_'+_0xad508f[_0x1ca5e9(0x1c1)](),_0x1ca5e9(0x17d)+_0x1a4dd7,_0x3f226d[_0x1ca5e9(0x1d4)],_0x472e1e,_0xfaa7dd);if(_0x472e1e[_0x1ca5e9(0x198)]||_0x472e1e[_0x1ca5e9(0x18e)]){loggerService_1['loggerService'][_0x1ca5e9(0x180)](_0x1ca5e9(0x19c)+_0xad508f[_0x1ca5e9(0x1c1)](),'/verify/'+_0x1a4dd7,_0x1ca5e9(0x175)+_0xad508f+_0x1ca5e9(0x173)+(_0x472e1e[_0x1ca5e9(0x197)]||_0x472e1e[_0x1ca5e9(0x198)]||_0x1ca5e9(0x1bd)));throw new Error('KLYME\x20'+_0xad508f+_0x1ca5e9(0x173)+(_0x472e1e[_0x1ca5e9(0x197)]||_0x472e1e['error']||_0x1ca5e9(0x1bd)));}let _0xc60205=_0x1ca5e9(0x19a);return{'status':_0xc60205};}catch(_0x4ec647){console[_0x1ca5e9(0x198)](_0x1ca5e9(0x175)+_0xad508f+_0x1ca5e9(0x1d3),_0x4ec647),loggerService_1[_0x1ca5e9(0x19f)]['logWhiteDomainError']('klyme_'+_0xad508f[_0x1ca5e9(0x1c1)](),_0x1ca5e9(0x17d)+_0x1a4dd7,_0x4ec647);throw new Error(_0x1ca5e9(0x17b)+_0xad508f+_0x1ca5e9(0x1a6)+(_0x4ec647 instanceof Error?_0x4ec647[_0x1ca5e9(0x197)]:_0x1ca5e9(0x1bd)));}}async['processWebhook'](_0xfcf2ad){const _0x588675=a41_0x1b0a3d;console['log']('Processing\x20KLYME\x20webhook:',_0xfcf2ad);let _0x2a1911=_0x588675(0x19a);switch(_0xfcf2ad[_0x588675(0x1d4)]?.['toLowerCase']()){case _0x588675(0x150):case _0x588675(0x1a9):case _0x588675(0x164):case _0x588675(0x16c):case _0x588675(0x1b8):_0x2a1911='PAID';break;case _0x588675(0x193):case _0x588675(0x1ca):case _0x588675(0x16d):case _0x588675(0x198):case _0x588675(0x1d0):_0x2a1911='FAILED';break;case _0x588675(0x159):case'timeout':_0x2a1911=_0x588675(0x1a4);break;case _0x588675(0x1d2):case'created':case _0x588675(0x19b):case'processing':case _0x588675(0x185):default:_0x2a1911=_0x588675(0x19a);break;}return{'paymentId':_0xfcf2ad[_0x588675(0x1b4)]||_0xfcf2ad[_0x588675(0x1cd)]||_0xfcf2ad[_0x588675(0x167)],'status':_0x2a1911,'amount':_0xfcf2ad[_0x588675(0x1ae)],'currency':_0xfcf2ad['currency'],'region':_0xfcf2ad[_0x588675(0x1da)],'additionalInfo':{'payment_method':_0xfcf2ad[_0x588675(0x189)],'transaction_id':_0xfcf2ad['transaction_id']}};}}exports[a41_0x1b0a3d(0x1a1)]=KlymeService;