'use strict';const a41_0x4fd738=a41_0x10bf;(function(_0x41bb6b,_0x5f3fb1){const _0x2f5af0=a41_0x10bf,_0x2a3b74=_0x41bb6b();while(!![]){try{const _0x158c7b=parseInt(_0x2f5af0(0x223))/0x1+-parseInt(_0x2f5af0(0x23a))/0x2*(parseInt(_0x2f5af0(0x1ea))/0x3)+parseInt(_0x2f5af0(0x24e))/0x4*(-parseInt(_0x2f5af0(0x24b))/0x5)+parseInt(_0x2f5af0(0x24c))/0x6+-parseInt(_0x2f5af0(0x217))/0x7+parseInt(_0x2f5af0(0x25d))/0x8+parseInt(_0x2f5af0(0x1cb))/0x9*(parseInt(_0x2f5af0(0x1e3))/0xa);if(_0x158c7b===_0x5f3fb1)break;else _0x2a3b74['push'](_0x2a3b74['shift']());}catch(_0x3d3ea5){_0x2a3b74['push'](_0x2a3b74['shift']());}}}(a41_0x3220,0x606bb));var __createBinding=this&&this[a41_0x4fd738(0x219)]||(Object['create']?function(_0xa0a0ce,_0x3d9356,_0x46a273,_0x2027a5){const _0x997b59=a41_0x4fd738;if(_0x2027a5===undefined)_0x2027a5=_0x46a273;var _0x44ad63=Object['getOwnPropertyDescriptor'](_0x3d9356,_0x46a273);(!_0x44ad63||(_0x997b59(0x1fd)in _0x44ad63?!_0x3d9356[_0x997b59(0x209)]:_0x44ad63['writable']||_0x44ad63['configurable']))&&(_0x44ad63={'enumerable':!![],'get':function(){return _0x3d9356[_0x46a273];}}),Object[_0x997b59(0x1ce)](_0xa0a0ce,_0x2027a5,_0x44ad63);}:function(_0x4570d4,_0x538fc6,_0x53bccd,_0x174aa6){if(_0x174aa6===undefined)_0x174aa6=_0x53bccd;_0x4570d4[_0x174aa6]=_0x538fc6[_0x53bccd];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x1b9721,_0x2a8c08){const _0x41ac9e=a41_0x4fd738;Object[_0x41ac9e(0x1ce)](_0x1b9721,_0x41ac9e(0x1da),{'enumerable':!![],'value':_0x2a8c08});}:function(_0x589435,_0x161500){_0x589435['default']=_0x161500;}),__importStar=this&&this[a41_0x4fd738(0x201)]||(function(){var _0x2f55a5=function(_0x100bc1){return _0x2f55a5=Object['getOwnPropertyNames']||function(_0x1dec79){const _0x377438=a41_0x10bf;var _0x3f8a27=[];for(var _0x5e0eb8 in _0x1dec79)if(Object['prototype']['hasOwnProperty'][_0x377438(0x24d)](_0x1dec79,_0x5e0eb8))_0x3f8a27[_0x3f8a27[_0x377438(0x1e9)]]=_0x5e0eb8;return _0x3f8a27;},_0x2f55a5(_0x100bc1);};return function(_0x129d89){const _0x67859e=a41_0x10bf;if(_0x129d89&&_0x129d89[_0x67859e(0x209)])return _0x129d89;var _0x57e752={};if(_0x129d89!=null){for(var _0x160d2f=_0x2f55a5(_0x129d89),_0x3cc483=0x0;_0x3cc483<_0x160d2f[_0x67859e(0x1e9)];_0x3cc483++)if(_0x160d2f[_0x3cc483]!==_0x67859e(0x1da))__createBinding(_0x57e752,_0x129d89,_0x160d2f[_0x3cc483]);}return __setModuleDefault(_0x57e752,_0x129d89),_0x57e752;};}());Object[a41_0x4fd738(0x1ce)](exports,'__esModule',{'value':!![]}),exports[a41_0x4fd738(0x1d0)]=void 0x0;const loggerService_1=require(a41_0x4fd738(0x1f7));function a41_0x10bf(_0x1ab28f,_0x30a7ce){const _0x322019=a41_0x3220();return a41_0x10bf=function(_0x10bf07,_0x432d88){_0x10bf07=_0x10bf07-0x1c9;let _0x46f909=_0x322019[_0x10bf07];return _0x46f909;},a41_0x10bf(_0x1ab28f,_0x30a7ce);}function a41_0x3220(){const _0xdf4214=['Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','../loggerService','statusText','verifyPayment','log','===\x20PARSED\x20KLYME\x20','PAID','get','then','\x20payment\x20link:\x20','uuid','__importStar','application/json','Response\x20data:','payment','\x20API:\x20missing\x20payment\x20data','\x20RESPONSE\x20===','Request\x20Body:','processing','__esModule','reference','random','statusCode','Unsupported\x20KLYME\x20region:\x20','loggerService','Status:','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','POST','amount','Business\x20Error:\x20','region','order_id','1645098GAkKOD','Parsed\x20Result:','__createBinding','\x20API\x20error:\x20','logWhiteDomainError','Unknown\x20error','toUpperCase','\x20SUCCESS\x20(Legacy\x20Format)\x20===','resolve','padStart','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','fromEntries','19773UJMIko','Unknown\x20error\x20from\x20KLYME\x20','validateCurrencyForRegion','active','failed','confirmed','Failed\x20to\x20create\x20KLYME\x20','🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20','success','Processing\x20KLYME\x20webhook:','toLowerCase','payment_id','transaction_id','../../config/database','HTTP\x20Status:','/verify/','timeout','/create','\x20API:\x20','Status\x20Code:','URL:','KLYME\x20','\x20validated)','897562aMBHRG','processWebhook','\x20API\x20ERROR\x20===','in_progress','completed','klyme_','\x20(8digits-8digits\x20format\x20for\x20','text','Failed\x20to\x20verify\x20KLYME\x20','Redirect\x20URL:','redirect_url','paid','⚠️\x20KLYME\x20reference\x20','entries','HTTP\x20error!\x20status:\x20','EUR','UUID:','2105TuFclj','1779606VgypAo','call','5380ffqPFg','Geo\x20Parameter:','\x20payment\x20link:\x20Unknown\x20error','\x20payment\x20verification\x20error:','Invalid\x20response\x20from\x20KLYME\x20','Error\x20details:','Error\x20message:','(validated\x20for\x20','logWhiteDomainRequest','stack','status','message','\x20currency\x20validation\x20passed:\x20','error','createPaymentLink','2647328HaqPCO','rejected','Reference\x20Used\x20as\x20ID:','1323Liwhxr','stringify','parse','defineProperty','💳\x20KLYME\x20','KlymeService','(8digits-8digits\x20format)','Currency:','created','===\x20KLYME\x20','apiUrl','Raw\x20Response\x20Body:','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','Reference\x20Used:','\x20API\x20BUSINESS\x20ERROR\x20===','default','cancelled','Reference:','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','logWhiteDomainResponse','https://tesoft.uk/gateway/pending.php?id=','\x20API','now','currency','67870ZLQsnM','PENDING','authUrl','findFirst','GBP','canceled','length','3qQRKHW','expired','generateUniqueReference','Auth\x20URL:','HTTP\x20',',\x20body:\x20','successful','TesSoft\x20Payment\x20System/1.0','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','Region\x20(geo):','Response\x20Body:','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts'];a41_0x3220=function(){return _0xdf4214;};return a41_0x3220();}class KlymeService{constructor(){const _0x562aee=a41_0x4fd738;this[_0x562aee(0x1d5)]='https://tesoft.uk/gateway/klyme/',console[_0x562aee(0x1fa)](_0x562aee(0x210));}[a41_0x4fd738(0x225)](_0x2e1e9f,_0xff8bc0){const _0x187c81=a41_0x4fd738,_0xca90da=_0x2e1e9f[_0x187c81(0x21d)]();switch(_0xff8bc0){case'EU':if(_0xca90da!==_0x187c81(0x249))throw new Error(_0x187c81(0x1dd)+_0xca90da);break;case'GB':if(_0xca90da!==_0x187c81(0x1e7))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0xca90da);break;case'DE':if(_0xca90da!=='EUR')throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0xca90da);break;default:throw new Error(_0x187c81(0x20d)+_0xff8bc0);}}async[a41_0x4fd738(0x1ec)](){const _0x525bfa=a41_0x4fd738,_0x219a83=(await Promise[_0x525bfa(0x21f)]()[_0x525bfa(0x1fe)](()=>__importStar(require(_0x525bfa(0x230)))))[_0x525bfa(0x1da)];let _0x38aa3a,_0x3ca42b=0x0;const _0x7caeb3=0xa;do{const _0x45e7a4=()=>{const _0x1977c6=_0x525bfa;return Math['floor'](Math[_0x1977c6(0x20b)]()*0x5f5e100)['toString']()[_0x1977c6(0x220)](0x8,'0');};_0x38aa3a=_0x45e7a4()+'-'+_0x45e7a4();const _0x375969=await _0x219a83[_0x525bfa(0x204)][_0x525bfa(0x1e6)]({'where':{'gatewayOrderId':_0x38aa3a}});if(!_0x375969)break;_0x3ca42b++,console[_0x525bfa(0x1fa)](_0x525bfa(0x246)+_0x38aa3a+_0x525bfa(0x1f2)+_0x3ca42b+')');}while(_0x3ca42b<_0x7caeb3);if(_0x3ca42b>=_0x7caeb3)throw new Error(_0x525bfa(0x1f5));return _0x38aa3a;}async[a41_0x4fd738(0x25c)](_0x10ead2){const _0x589fab=a41_0x4fd738,{orderId:_0xa22f2c,amount:_0x1a5918,currency:_0x58d316,region:_0x5cd895}=_0x10ead2;if(_0x5cd895!=='EU'&&_0x5cd895!=='GB'&&_0x5cd895!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x5cd895);this[_0x589fab(0x225)](_0x58d316,_0x5cd895);const _0x2ce868=_0x58d316[_0x589fab(0x21d)]();console[_0x589fab(0x1fa)](_0x589fab(0x1cf)+_0x5cd895+_0x589fab(0x25a)+_0x2ce868);const _0x58a771=await this['generateUniqueReference']();console[_0x589fab(0x1fa)](_0x589fab(0x22a)+_0x58a771+_0x589fab(0x240)+_0x5cd895+')');const _0x460f74=_0x589fab(0x1df)+_0xa22f2c,_0x5dd2d3={'amount':_0x1a5918,'currency':_0x2ce868,'redirectUrl':_0x460f74,'reference':_0x58a771,'geo':_0x5cd895},_0x2b1631=Date[_0x589fab(0x1e1)]();try{console['log'](_0x589fab(0x1d4)+_0x5cd895+'\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20==='),console['log'](_0x589fab(0x237),this['apiUrl']),console['log'](_0x589fab(0x207),JSON[_0x589fab(0x1cc)](_0x5dd2d3,null,0x2)),console[_0x589fab(0x1fa)](_0x589fab(0x1f3),_0x5cd895),console['log'](_0x589fab(0x1d2),_0x2ce868,_0x589fab(0x255)+_0x5cd895+')'),console[_0x589fab(0x1fa)](_0x589fab(0x1dc),_0x58a771,_0x589fab(0x1d1)),console[_0x589fab(0x1fa)]('Redirect\x20URL:',_0x460f74),loggerService_1[_0x589fab(0x20e)][_0x589fab(0x256)](_0x589fab(0x23f)+_0x5cd895[_0x589fab(0x22d)](),_0x589fab(0x234),_0x589fab(0x212),_0x5dd2d3);const _0x10955e=await fetch(this[_0x589fab(0x1d5)],{'method':_0x589fab(0x212),'headers':{'Content-Type':_0x589fab(0x202),'Accept':_0x589fab(0x202),'User-Agent':_0x589fab(0x1f1)},'body':JSON['stringify'](_0x5dd2d3)}),_0x359fbb=Date[_0x589fab(0x1e1)]()-_0x2b1631;console[_0x589fab(0x1fa)](_0x589fab(0x1d4)+_0x5cd895+_0x589fab(0x1d7)),console[_0x589fab(0x1fa)](_0x589fab(0x20f),_0x10955e[_0x589fab(0x258)]),console[_0x589fab(0x1fa)]('Status\x20Text:',_0x10955e[_0x589fab(0x1f8)]),console[_0x589fab(0x1fa)]('Headers:',Object[_0x589fab(0x222)](_0x10955e['headers'][_0x589fab(0x247)]())),console['log']('Response\x20Time:',_0x359fbb+'ms');const _0x57b782=await _0x10955e[_0x589fab(0x241)]();console['log'](_0x589fab(0x1d6),_0x57b782);if(!_0x10955e['ok']){console[_0x589fab(0x25b)]('===\x20KLYME\x20'+_0x5cd895+_0x589fab(0x23c)),console[_0x589fab(0x25b)](_0x589fab(0x231),_0x10955e[_0x589fab(0x258)]),console[_0x589fab(0x25b)](_0x589fab(0x1f4),_0x57b782),loggerService_1['loggerService'][_0x589fab(0x1de)](_0x589fab(0x23f)+_0x5cd895[_0x589fab(0x22d)](),'/create',_0x10955e[_0x589fab(0x258)],_0x57b782,_0x359fbb),loggerService_1[_0x589fab(0x20e)][_0x589fab(0x21b)](_0x589fab(0x23f)+_0x5cd895['toLowerCase'](),_0x589fab(0x234),_0x589fab(0x1ee)+_0x10955e[_0x589fab(0x258)]+':\x20'+_0x57b782);throw new Error('HTTP\x20error!\x20status:\x20'+_0x10955e['status']+_0x589fab(0x1ef)+_0x57b782);}let _0x17aba5;try{_0x17aba5=JSON[_0x589fab(0x1cd)](_0x57b782);}catch(_0x11314d){console[_0x589fab(0x25b)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x11314d),loggerService_1[_0x589fab(0x20e)][_0x589fab(0x21b)](_0x589fab(0x23f)+_0x5cd895[_0x589fab(0x22d)](),_0x589fab(0x234),'JSON\x20Parse\x20Error:\x20'+_0x11314d);throw new Error('Invalid\x20JSON\x20response\x20from\x20KLYME\x20'+_0x5cd895+_0x589fab(0x235)+_0x57b782);}console[_0x589fab(0x1fa)](_0x589fab(0x1fb)+_0x5cd895+_0x589fab(0x206)),console['log'](_0x589fab(0x218),JSON[_0x589fab(0x1cc)](_0x17aba5,null,0x2)),loggerService_1[_0x589fab(0x20e)][_0x589fab(0x1de)]('klyme_'+_0x5cd895['toLowerCase'](),_0x589fab(0x234),_0x10955e['status'],_0x17aba5,_0x359fbb);if(_0x17aba5[_0x589fab(0x25b)]||_0x17aba5[_0x589fab(0x20c)]){const _0x527d0f=_0x17aba5[_0x589fab(0x259)]||_0x17aba5['error']||_0x589fab(0x224)+_0x5cd895+_0x589fab(0x1e0);console['error']('===\x20KLYME\x20'+_0x5cd895+_0x589fab(0x1d9)),console[_0x589fab(0x25b)]('Error\x20Message:',_0x527d0f),console['error'](_0x589fab(0x236),_0x17aba5['statusCode']),loggerService_1[_0x589fab(0x20e)]['logWhiteDomainError'](_0x589fab(0x23f)+_0x5cd895[_0x589fab(0x22d)](),_0x589fab(0x234),_0x589fab(0x214)+_0x527d0f);throw new Error('KLYME\x20'+_0x5cd895+_0x589fab(0x21a)+_0x527d0f);}let _0x14e180,_0x42dddd;if(_0x17aba5[_0x589fab(0x200)]&&_0x17aba5[_0x589fab(0x244)])_0x14e180=_0x17aba5[_0x589fab(0x200)],_0x42dddd=_0x17aba5[_0x589fab(0x244)],console[_0x589fab(0x1fa)](_0x589fab(0x1d4)+_0x5cd895+'\x20SUCCESS\x20(New\x20Format)\x20==='),console['log'](_0x589fab(0x24a),_0x17aba5[_0x589fab(0x200)]),console[_0x589fab(0x1fa)](_0x589fab(0x243),_0x17aba5['redirect_url']);else{if(_0x17aba5[_0x589fab(0x1e5)])_0x14e180=_0x58a771,_0x42dddd=_0x17aba5[_0x589fab(0x1e5)],console[_0x589fab(0x1fa)]('===\x20KLYME\x20'+_0x5cd895+_0x589fab(0x21e)),console['log'](_0x589fab(0x1ed),_0x17aba5[_0x589fab(0x1e5)]),console[_0x589fab(0x1fa)](_0x589fab(0x1ca),_0x58a771);else{console['error'](_0x589fab(0x1d4)+_0x5cd895+_0x589fab(0x221)),console[_0x589fab(0x25b)](_0x589fab(0x1f6)),console[_0x589fab(0x25b)](_0x589fab(0x203),_0x17aba5),loggerService_1[_0x589fab(0x20e)][_0x589fab(0x21b)](_0x589fab(0x23f)+_0x5cd895[_0x589fab(0x22d)](),_0x589fab(0x234),_0x589fab(0x211));throw new Error(_0x589fab(0x252)+_0x5cd895+_0x589fab(0x205));}}return console['log']('Currency\x20Used:',_0x2ce868,'('+_0x5cd895+_0x589fab(0x239)),console['log'](_0x589fab(0x1d8),_0x58a771,_0x589fab(0x1d1)),console[_0x589fab(0x1fa)](_0x589fab(0x24f),_0x5cd895),{'gateway_payment_id':_0x14e180,'payment_url':_0x42dddd};}catch(_0x25b1e3){console['error'](_0x589fab(0x1d4)+_0x5cd895+'\x20SERVICE\x20ERROR\x20==='),console[_0x589fab(0x25b)](_0x589fab(0x253),_0x25b1e3),loggerService_1[_0x589fab(0x20e)][_0x589fab(0x21b)]('klyme_'+_0x5cd895['toLowerCase'](),_0x589fab(0x234),_0x25b1e3);if(_0x25b1e3 instanceof Error){console[_0x589fab(0x25b)](_0x589fab(0x254),_0x25b1e3[_0x589fab(0x259)]),console['error']('Error\x20stack:',_0x25b1e3[_0x589fab(0x257)]);throw new Error(_0x589fab(0x229)+_0x5cd895+_0x589fab(0x1ff)+_0x25b1e3[_0x589fab(0x259)]);}throw new Error(_0x589fab(0x229)+_0x5cd895+_0x589fab(0x250));}}async[a41_0x4fd738(0x1f9)](_0x43ec97,_0x525111){const _0x105f07=a41_0x4fd738,_0x1ad592=Date[_0x105f07(0x1e1)]();try{const _0x429d51={'gatewayPaymentId':_0x43ec97,'geo':_0x525111};loggerService_1[_0x105f07(0x20e)][_0x105f07(0x256)]('klyme_'+_0x525111[_0x105f07(0x22d)](),_0x105f07(0x232)+_0x43ec97,_0x105f07(0x212),_0x429d51);const _0x5de5ff=await fetch(this['apiUrl'],{'method':_0x105f07(0x212),'headers':{'Content-Type':_0x105f07(0x202),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x105f07(0x1cc)](_0x429d51)}),_0x15fd53=Date[_0x105f07(0x1e1)]()-_0x1ad592;if(!_0x5de5ff['ok']){const _0x348a55=await _0x5de5ff[_0x105f07(0x241)]();loggerService_1[_0x105f07(0x20e)][_0x105f07(0x1de)](_0x105f07(0x23f)+_0x525111['toLowerCase'](),'/verify/'+_0x43ec97,_0x5de5ff[_0x105f07(0x258)],_0x348a55,_0x15fd53);throw new Error(_0x105f07(0x248)+_0x5de5ff[_0x105f07(0x258)]);}const _0x36ec77=await _0x5de5ff['json']();loggerService_1['loggerService'][_0x105f07(0x1de)](_0x105f07(0x23f)+_0x525111[_0x105f07(0x22d)](),'/verify/'+_0x43ec97,_0x5de5ff[_0x105f07(0x258)],_0x36ec77,_0x15fd53);if(_0x36ec77[_0x105f07(0x25b)]||_0x36ec77[_0x105f07(0x20c)]){loggerService_1[_0x105f07(0x20e)]['logWhiteDomainError'](_0x105f07(0x23f)+_0x525111[_0x105f07(0x22d)](),_0x105f07(0x232)+_0x43ec97,_0x105f07(0x238)+_0x525111+_0x105f07(0x21a)+(_0x36ec77['message']||_0x36ec77[_0x105f07(0x25b)]||'Unknown\x20error'));throw new Error(_0x105f07(0x238)+_0x525111+'\x20API\x20error:\x20'+(_0x36ec77[_0x105f07(0x259)]||_0x36ec77['error']||_0x105f07(0x21c)));}let _0x1fc1c3=_0x105f07(0x1e4);return{'status':_0x1fc1c3};}catch(_0x2950e2){console[_0x105f07(0x25b)](_0x105f07(0x238)+_0x525111+_0x105f07(0x251),_0x2950e2),loggerService_1[_0x105f07(0x20e)][_0x105f07(0x21b)](_0x105f07(0x23f)+_0x525111[_0x105f07(0x22d)](),'/verify/'+_0x43ec97,_0x2950e2);throw new Error(_0x105f07(0x242)+_0x525111+'\x20payment:\x20'+(_0x2950e2 instanceof Error?_0x2950e2['message']:_0x105f07(0x21c)));}}async[a41_0x4fd738(0x23b)](_0x102982){const _0x38d93d=a41_0x4fd738;console[_0x38d93d(0x1fa)](_0x38d93d(0x22c),_0x102982);let _0x1c1338='PENDING';switch(_0x102982[_0x38d93d(0x258)]?.[_0x38d93d(0x22d)]()){case _0x38d93d(0x245):case _0x38d93d(0x23e):case _0x38d93d(0x228):case _0x38d93d(0x22b):case _0x38d93d(0x1f0):_0x1c1338=_0x38d93d(0x1fc);break;case _0x38d93d(0x1db):case _0x38d93d(0x1e8):case _0x38d93d(0x227):case _0x38d93d(0x25b):case _0x38d93d(0x1c9):_0x1c1338='FAILED';break;case _0x38d93d(0x1eb):case _0x38d93d(0x233):_0x1c1338='EXPIRED';break;case'pending':case _0x38d93d(0x1d3):case _0x38d93d(0x226):case _0x38d93d(0x208):case _0x38d93d(0x23d):default:_0x1c1338=_0x38d93d(0x1e4);break;}return{'paymentId':_0x102982[_0x38d93d(0x20a)]||_0x102982[_0x38d93d(0x216)]||_0x102982[_0x38d93d(0x22e)],'status':_0x1c1338,'amount':_0x102982[_0x38d93d(0x213)],'currency':_0x102982[_0x38d93d(0x1e2)],'region':_0x102982[_0x38d93d(0x215)],'additionalInfo':{'payment_method':_0x102982['payment_method'],'transaction_id':_0x102982[_0x38d93d(0x22f)]}};}}exports[a41_0x4fd738(0x1d0)]=KlymeService;