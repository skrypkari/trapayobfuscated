'use strict';const a56_0x237abf=a56_0x47ab;(function(_0x3f7fe8,_0x471405){const _0x2d23c2=a56_0x47ab,_0x4b12a8=_0x3f7fe8();while(!![]){try{const _0x51d667=parseInt(_0x2d23c2(0x236))/0x1+parseInt(_0x2d23c2(0x206))/0x2+-parseInt(_0x2d23c2(0x221))/0x3*(parseInt(_0x2d23c2(0x26d))/0x4)+parseInt(_0x2d23c2(0x22b))/0x5*(-parseInt(_0x2d23c2(0x1f5))/0x6)+-parseInt(_0x2d23c2(0x200))/0x7+-parseInt(_0x2d23c2(0x21b))/0x8*(-parseInt(_0x2d23c2(0x268))/0x9)+parseInt(_0x2d23c2(0x23d))/0xa;if(_0x51d667===_0x471405)break;else _0x4b12a8['push'](_0x4b12a8['shift']());}catch(_0x59fa07){_0x4b12a8['push'](_0x4b12a8['shift']());}}}(a56_0x46a2,0x6f7ee));function a56_0x46a2(){const _0x249510=['application/json','klyme_','configurable','Auth\x20URL:','in_progress','Invalid\x20response\x20from\x20KLYME\x20','5081559DVtdtw','Error\x20Message:','Status\x20Code:','timeout','verifyPayment','statusCode','1019524nfMprQ','Status:','transaction_id','Failed\x20to\x20verify\x20KLYME\x20','URL:','generateUniqueReference','Reference\x20Used\x20as\x20ID:','__importStar','/create','üí≥\x20KLYME\x20','redirect_url','payment_method','Currency\x20Used:','canceled','fromEntries','statusText','apiUrl','validateCurrencyForRegion','now','Processing\x20KLYME\x20webhook:','\x20(8digits-8digits\x20format\x20for\x20','2218824blaMsA','\x20API\x20BUSINESS\x20ERROR\x20===','\x20API','Geo\x20Parameter:','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','===\x20PARSED\x20KLYME\x20','2375811myoqCG','\x20API:\x20missing\x20payment\x20data','random','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','reference','prototype','Business\x20Error:\x20','Response\x20Body:','\x20RESPONSE\x20===','pending','92860oBWWXS','order_id','\x20validated)','length','\x20payment\x20verification\x20error:','error','processing','PENDING','../../config/database','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','‚ö†Ô∏è\x20KLYME\x20reference\x20','223049nZqipI','default','defineProperty','POST','headers','logWhiteDomainRequest','floor','14286960SDMipj','Response\x20Time:','Reference\x20Used:','Redirect\x20URL:','__setModuleDefault','authUrl','Error\x20stack:','processWebhook','(8digits-8digits\x20format)','\x20payment\x20link:\x20','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','HTTP\x20error!\x20status:\x20','json','cancelled','hasOwnProperty','Response\x20data:','toUpperCase','getOwnPropertyNames','HTTP\x20','amount','status','expired','get','toLowerCase','(validated\x20for\x20','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','__esModule','\x20SERVICE\x20ERROR\x20===','call','Failed\x20to\x20parse\x20JSON\x20response:','then','Unknown\x20error\x20from\x20KLYME\x20','stringify','UUID:','\x20payment:\x20','resolve','\x20payment\x20link:\x20Unknown\x20error','https://tesoft.uk/gateway/klyme/','\x20currency\x20validation\x20passed:\x20','\x20API\x20ERROR\x20===','Headers:','payment','loggerService','9CtxwUE','message','logWhiteDomainResponse','Error\x20message:','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','4aNVKBv','Parsed\x20Result:','===\x20KLYME\x20','active','__createBinding','toString','KLYME\x20','entries','KlymeService','PAID','/verify/','log','\x20API:\x20','Failed\x20to\x20create\x20KLYME\x20','JSON\x20Parse\x20Error:\x20','payment_id','completed','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','logWhiteDomainError','confirmed','EUR','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','uuid','Unsupported\x20KLYME\x20region:\x20','failed','Currency:','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','writable','created','Region\x20(geo):','\x20API\x20error:\x20','150AUgGKq','text','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','EXPIRED','Unknown\x20error'];a56_0x46a2=function(){return _0x249510;};return a56_0x46a2();}var __createBinding=this&&this[a56_0x237abf(0x271)]||(Object['create']?function(_0x219910,_0x5cb4e3,_0x425e77,_0x2e0061){const _0x3bada7=a56_0x237abf;if(_0x2e0061===undefined)_0x2e0061=_0x425e77;var _0x2227e8=Object['getOwnPropertyDescriptor'](_0x5cb4e3,_0x425e77);(!_0x2227e8||(_0x3bada7(0x253)in _0x2227e8?!_0x5cb4e3[_0x3bada7(0x257)]:_0x2227e8[_0x3bada7(0x288)]||_0x2227e8[_0x3bada7(0x1fc)]))&&(_0x2227e8={'enumerable':!![],'get':function(){return _0x5cb4e3[_0x425e77];}}),Object[_0x3bada7(0x238)](_0x219910,_0x2e0061,_0x2227e8);}:function(_0x41f9a3,_0x47930e,_0x11fd65,_0x2688d5){if(_0x2688d5===undefined)_0x2688d5=_0x11fd65;_0x41f9a3[_0x2688d5]=_0x47930e[_0x11fd65];}),__setModuleDefault=this&&this[a56_0x237abf(0x241)]||(Object['create']?function(_0x2b6007,_0x4b12e7){const _0x408425=a56_0x237abf;Object['defineProperty'](_0x2b6007,_0x408425(0x237),{'enumerable':!![],'value':_0x4b12e7});}:function(_0x1bfd5a,_0x31634e){_0x1bfd5a['default']=_0x31634e;}),__importStar=this&&this[a56_0x237abf(0x20d)]||(function(){var _0x4b8770=function(_0x3b42de){const _0x50b414=a56_0x47ab;return _0x4b8770=Object[_0x50b414(0x24e)]||function(_0x269bf9){const _0x1aed8f=_0x50b414;var _0x384ab4=[];for(var _0x598e87 in _0x269bf9)if(Object[_0x1aed8f(0x226)][_0x1aed8f(0x24b)][_0x1aed8f(0x259)](_0x269bf9,_0x598e87))_0x384ab4[_0x384ab4[_0x1aed8f(0x22e)]]=_0x598e87;return _0x384ab4;},_0x4b8770(_0x3b42de);};return function(_0x48f068){const _0x26097b=a56_0x47ab;if(_0x48f068&&_0x48f068[_0x26097b(0x257)])return _0x48f068;var _0x3eb53e={};if(_0x48f068!=null){for(var _0x41b227=_0x4b8770(_0x48f068),_0x4fc974=0x0;_0x4fc974<_0x41b227[_0x26097b(0x22e)];_0x4fc974++)if(_0x41b227[_0x4fc974]!=='default')__createBinding(_0x3eb53e,_0x48f068,_0x41b227[_0x4fc974]);}return __setModuleDefault(_0x3eb53e,_0x48f068),_0x3eb53e;};}());function a56_0x47ab(_0x284400,_0x3c602f){_0x284400=_0x284400-0x1f4;const _0x46a2f5=a56_0x46a2();let _0x47ab89=_0x46a2f5[_0x284400];return _0x47ab89;}Object['defineProperty'](exports,a56_0x237abf(0x257),{'value':!![]}),exports[a56_0x237abf(0x275)]=void 0x0;const loggerService_1=require('../loggerService');class KlymeService{constructor(){const _0x25662c=a56_0x237abf;this[_0x25662c(0x216)]=_0x25662c(0x262),console[_0x25662c(0x278)](_0x25662c(0x234));}['validateCurrencyForRegion'](_0x200004,_0x1de969){const _0x48ce72=a56_0x237abf,_0x1fc93c=_0x200004['toUpperCase']();switch(_0x1de969){case'EU':if(_0x1fc93c!==_0x48ce72(0x281))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x1fc93c);break;case'GB':if(_0x1fc93c!=='GBP')throw new Error(_0x48ce72(0x21f)+_0x1fc93c);break;case'DE':if(_0x1fc93c!=='EUR')throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x1fc93c);break;default:throw new Error(_0x48ce72(0x284)+_0x1de969);}}async['generateUniqueReference'](){const _0xd3824d=a56_0x237abf,_0x463a2b=(await Promise[_0xd3824d(0x260)]()[_0xd3824d(0x25b)](()=>__importStar(require(_0xd3824d(0x233)))))['default'];let _0x1ed24d,_0x49b422=0x0;const _0x58f027=0xa;do{const _0x3ef958=()=>{const _0x265fdc=_0xd3824d;return Math[_0x265fdc(0x23c)](Math[_0x265fdc(0x223)]()*0x5f5e100)[_0x265fdc(0x272)]()['padStart'](0x8,'0');};_0x1ed24d=_0x3ef958()+'-'+_0x3ef958();const _0x2e34c5=await _0x463a2b[_0xd3824d(0x266)]['findFirst']({'where':{'gatewayOrderId':_0x1ed24d}});if(!_0x2e34c5)break;_0x49b422++,console[_0xd3824d(0x278)](_0xd3824d(0x235)+_0x1ed24d+'\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20'+_0x49b422+')');}while(_0x49b422<_0x58f027);if(_0x49b422>=_0x58f027)throw new Error(_0xd3824d(0x27e));return _0x1ed24d;}async['createPaymentLink'](_0x47b195){const _0x4917d4=a56_0x237abf,{orderId:_0x337dd3,amount:_0xa02808,currency:_0x520f2f,region:_0x109464}=_0x47b195;if(_0x109464!=='EU'&&_0x109464!=='GB'&&_0x109464!=='DE')throw new Error(_0x4917d4(0x256)+_0x109464);this[_0x4917d4(0x217)](_0x520f2f,_0x109464);const _0x582102=_0x520f2f[_0x4917d4(0x24d)]();console['log'](_0x4917d4(0x20f)+_0x109464+_0x4917d4(0x263)+_0x582102);const _0x21989d=await this[_0x4917d4(0x20b)]();console[_0x4917d4(0x278)](_0x4917d4(0x287)+_0x21989d+_0x4917d4(0x21a)+_0x109464+')');const _0x1ba2c2='https://tesoft.uk/gateway/pending.php?id='+_0x337dd3,_0x1cbcec={'amount':_0xa02808,'currency':_0x582102,'redirectUrl':_0x1ba2c2,'reference':_0x21989d,'geo':_0x109464},_0x2bcb77=Date[_0x4917d4(0x218)]();try{console[_0x4917d4(0x278)](_0x4917d4(0x26f)+_0x109464+'\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20==='),console[_0x4917d4(0x278)](_0x4917d4(0x20a),this[_0x4917d4(0x216)]),console[_0x4917d4(0x278)]('Request\x20Body:',JSON[_0x4917d4(0x25d)](_0x1cbcec,null,0x2)),console[_0x4917d4(0x278)](_0x4917d4(0x28a),_0x109464),console[_0x4917d4(0x278)](_0x4917d4(0x286),_0x582102,_0x4917d4(0x255)+_0x109464+')'),console['log']('Reference:',_0x21989d,_0x4917d4(0x245)),console[_0x4917d4(0x278)](_0x4917d4(0x240),_0x1ba2c2),loggerService_1[_0x4917d4(0x267)][_0x4917d4(0x23b)](_0x4917d4(0x1fb)+_0x109464['toLowerCase'](),_0x4917d4(0x20e),'POST',_0x1cbcec);const _0x23dbe5=await fetch(this[_0x4917d4(0x216)],{'method':'POST','headers':{'Content-Type':_0x4917d4(0x1fa),'Accept':_0x4917d4(0x1fa),'User-Agent':'Payment\x20System/1.0'},'body':JSON['stringify'](_0x1cbcec)}),_0x28af8a=Date['now']()-_0x2bcb77;console[_0x4917d4(0x278)]('===\x20KLYME\x20'+_0x109464+_0x4917d4(0x224)),console['log'](_0x4917d4(0x207),_0x23dbe5['status']),console['log']('Status\x20Text:',_0x23dbe5[_0x4917d4(0x215)]),console[_0x4917d4(0x278)](_0x4917d4(0x265),Object[_0x4917d4(0x214)](_0x23dbe5[_0x4917d4(0x23a)][_0x4917d4(0x274)]())),console[_0x4917d4(0x278)](_0x4917d4(0x23e),_0x28af8a+'ms');const _0x58f6a4=await _0x23dbe5[_0x4917d4(0x1f6)]();console[_0x4917d4(0x278)]('Raw\x20Response\x20Body:',_0x58f6a4);if(!_0x23dbe5['ok']){console['error'](_0x4917d4(0x26f)+_0x109464+_0x4917d4(0x264)),console[_0x4917d4(0x230)]('HTTP\x20Status:',_0x23dbe5[_0x4917d4(0x251)]),console[_0x4917d4(0x230)](_0x4917d4(0x228),_0x58f6a4),loggerService_1['loggerService'][_0x4917d4(0x26a)](_0x4917d4(0x1fb)+_0x109464[_0x4917d4(0x254)](),_0x4917d4(0x20e),_0x23dbe5['status'],_0x58f6a4,_0x28af8a),loggerService_1[_0x4917d4(0x267)][_0x4917d4(0x27f)]('klyme_'+_0x109464[_0x4917d4(0x254)](),_0x4917d4(0x20e),_0x4917d4(0x24f)+_0x23dbe5[_0x4917d4(0x251)]+':\x20'+_0x58f6a4);throw new Error(_0x4917d4(0x248)+_0x23dbe5[_0x4917d4(0x251)]+',\x20body:\x20'+_0x58f6a4);}let _0x141061;try{_0x141061=JSON['parse'](_0x58f6a4);}catch(_0x2c5c56){console[_0x4917d4(0x230)](_0x4917d4(0x25a),_0x2c5c56),loggerService_1[_0x4917d4(0x267)][_0x4917d4(0x27f)](_0x4917d4(0x1fb)+_0x109464[_0x4917d4(0x254)](),_0x4917d4(0x20e),_0x4917d4(0x27b)+_0x2c5c56);throw new Error(_0x4917d4(0x282)+_0x109464+_0x4917d4(0x279)+_0x58f6a4);}console['log'](_0x4917d4(0x220)+_0x109464+_0x4917d4(0x229)),console[_0x4917d4(0x278)](_0x4917d4(0x26e),JSON[_0x4917d4(0x25d)](_0x141061,null,0x2)),loggerService_1[_0x4917d4(0x267)][_0x4917d4(0x26a)]('klyme_'+_0x109464[_0x4917d4(0x254)](),_0x4917d4(0x20e),_0x23dbe5[_0x4917d4(0x251)],_0x141061,_0x28af8a);if(_0x141061[_0x4917d4(0x230)]||_0x141061[_0x4917d4(0x205)]){const _0xe9dd64=_0x141061[_0x4917d4(0x269)]||_0x141061[_0x4917d4(0x230)]||_0x4917d4(0x25c)+_0x109464+_0x4917d4(0x21d);console[_0x4917d4(0x230)](_0x4917d4(0x26f)+_0x109464+_0x4917d4(0x21c)),console['error'](_0x4917d4(0x201),_0xe9dd64),console[_0x4917d4(0x230)](_0x4917d4(0x202),_0x141061['statusCode']),loggerService_1[_0x4917d4(0x267)]['logWhiteDomainError'](_0x4917d4(0x1fb)+_0x109464[_0x4917d4(0x254)](),_0x4917d4(0x20e),_0x4917d4(0x227)+_0xe9dd64);throw new Error(_0x4917d4(0x273)+_0x109464+_0x4917d4(0x1f4)+_0xe9dd64);}let _0x3008d4,_0xe31d11;if(_0x141061['uuid']&&_0x141061[_0x4917d4(0x210)])_0x3008d4=_0x141061['uuid'],_0xe31d11=_0x141061[_0x4917d4(0x210)],console['log'](_0x4917d4(0x26f)+_0x109464+'\x20SUCCESS\x20(New\x20Format)\x20==='),console['log'](_0x4917d4(0x25e),_0x141061[_0x4917d4(0x283)]),console['log'](_0x4917d4(0x240),_0x141061[_0x4917d4(0x210)]);else{if(_0x141061['authUrl'])_0x3008d4=_0x21989d,_0xe31d11=_0x141061[_0x4917d4(0x242)],console[_0x4917d4(0x278)](_0x4917d4(0x26f)+_0x109464+'\x20SUCCESS\x20(Legacy\x20Format)\x20==='),console[_0x4917d4(0x278)](_0x4917d4(0x1fd),_0x141061[_0x4917d4(0x242)]),console[_0x4917d4(0x278)](_0x4917d4(0x20c),_0x21989d);else{console[_0x4917d4(0x230)](_0x4917d4(0x26f)+_0x109464+_0x4917d4(0x26c)),console[_0x4917d4(0x230)](_0x4917d4(0x247)),console[_0x4917d4(0x230)](_0x4917d4(0x24c),_0x141061),loggerService_1[_0x4917d4(0x267)]['logWhiteDomainError'](_0x4917d4(0x1fb)+_0x109464[_0x4917d4(0x254)](),_0x4917d4(0x20e),_0x4917d4(0x1f7));throw new Error(_0x4917d4(0x1ff)+_0x109464+_0x4917d4(0x222));}}return console[_0x4917d4(0x278)](_0x4917d4(0x212),_0x582102,'('+_0x109464+_0x4917d4(0x22d)),console['log'](_0x4917d4(0x23f),_0x21989d,_0x4917d4(0x245)),console[_0x4917d4(0x278)](_0x4917d4(0x21e),_0x109464),{'gateway_payment_id':_0x3008d4,'payment_url':_0xe31d11};}catch(_0x249925){console[_0x4917d4(0x230)](_0x4917d4(0x26f)+_0x109464+_0x4917d4(0x258)),console[_0x4917d4(0x230)]('Error\x20details:',_0x249925),loggerService_1[_0x4917d4(0x267)]['logWhiteDomainError'](_0x4917d4(0x1fb)+_0x109464[_0x4917d4(0x254)](),_0x4917d4(0x20e),_0x249925);if(_0x249925 instanceof Error){console[_0x4917d4(0x230)](_0x4917d4(0x26b),_0x249925[_0x4917d4(0x269)]),console[_0x4917d4(0x230)](_0x4917d4(0x243),_0x249925['stack']);throw new Error(_0x4917d4(0x27a)+_0x109464+_0x4917d4(0x246)+_0x249925[_0x4917d4(0x269)]);}throw new Error(_0x4917d4(0x27a)+_0x109464+_0x4917d4(0x261));}}async[a56_0x237abf(0x204)](_0x414c9c,_0x4ae0c7){const _0x478b58=a56_0x237abf,_0x1f1344=Date[_0x478b58(0x218)]();try{const _0x3a4afd={'gatewayPaymentId':_0x414c9c,'geo':_0x4ae0c7};loggerService_1[_0x478b58(0x267)][_0x478b58(0x23b)](_0x478b58(0x1fb)+_0x4ae0c7[_0x478b58(0x254)](),'/verify/'+_0x414c9c,'POST',_0x3a4afd);const _0x1f290c=await fetch(this[_0x478b58(0x216)],{'method':_0x478b58(0x239),'headers':{'Content-Type':'application/json','User-Agent':'Payment\x20System/1.0'},'body':JSON[_0x478b58(0x25d)](_0x3a4afd)}),_0x5a84a9=Date[_0x478b58(0x218)]()-_0x1f1344;if(!_0x1f290c['ok']){const _0x403bb9=await _0x1f290c[_0x478b58(0x1f6)]();loggerService_1['loggerService'][_0x478b58(0x26a)]('klyme_'+_0x4ae0c7[_0x478b58(0x254)](),_0x478b58(0x277)+_0x414c9c,_0x1f290c['status'],_0x403bb9,_0x5a84a9);throw new Error(_0x478b58(0x248)+_0x1f290c[_0x478b58(0x251)]);}const _0x518767=await _0x1f290c[_0x478b58(0x249)]();loggerService_1[_0x478b58(0x267)]['logWhiteDomainResponse'](_0x478b58(0x1fb)+_0x4ae0c7[_0x478b58(0x254)](),_0x478b58(0x277)+_0x414c9c,_0x1f290c[_0x478b58(0x251)],_0x518767,_0x5a84a9);if(_0x518767['error']||_0x518767['statusCode']){loggerService_1[_0x478b58(0x267)][_0x478b58(0x27f)](_0x478b58(0x1fb)+_0x4ae0c7[_0x478b58(0x254)](),_0x478b58(0x277)+_0x414c9c,_0x478b58(0x273)+_0x4ae0c7+'\x20API\x20error:\x20'+(_0x518767['message']||_0x518767[_0x478b58(0x230)]||_0x478b58(0x1f9)));throw new Error(_0x478b58(0x273)+_0x4ae0c7+_0x478b58(0x1f4)+(_0x518767[_0x478b58(0x269)]||_0x518767[_0x478b58(0x230)]||_0x478b58(0x1f9)));}let _0x4704dc='PENDING';return{'status':_0x4704dc};}catch(_0x6db87b){console[_0x478b58(0x230)](_0x478b58(0x273)+_0x4ae0c7+_0x478b58(0x22f),_0x6db87b),loggerService_1[_0x478b58(0x267)][_0x478b58(0x27f)](_0x478b58(0x1fb)+_0x4ae0c7[_0x478b58(0x254)](),_0x478b58(0x277)+_0x414c9c,_0x6db87b);throw new Error(_0x478b58(0x209)+_0x4ae0c7+_0x478b58(0x25f)+(_0x6db87b instanceof Error?_0x6db87b[_0x478b58(0x269)]:_0x478b58(0x1f9)));}}async[a56_0x237abf(0x244)](_0x3f84e5){const _0x3b56d5=a56_0x237abf;console[_0x3b56d5(0x278)](_0x3b56d5(0x219),_0x3f84e5);let _0x30db7d=_0x3b56d5(0x232);switch(_0x3f84e5[_0x3b56d5(0x251)]?.['toLowerCase']()){case'paid':case _0x3b56d5(0x27d):case _0x3b56d5(0x280):case'success':case'successful':_0x30db7d=_0x3b56d5(0x276);break;case _0x3b56d5(0x24a):case _0x3b56d5(0x213):case _0x3b56d5(0x285):case _0x3b56d5(0x230):case'rejected':_0x30db7d='FAILED';break;case _0x3b56d5(0x252):case _0x3b56d5(0x203):_0x30db7d=_0x3b56d5(0x1f8);break;case _0x3b56d5(0x22a):case _0x3b56d5(0x289):case _0x3b56d5(0x270):case _0x3b56d5(0x231):case _0x3b56d5(0x1fe):default:_0x30db7d=_0x3b56d5(0x232);break;}return{'paymentId':_0x3f84e5[_0x3b56d5(0x225)]||_0x3f84e5[_0x3b56d5(0x22c)]||_0x3f84e5[_0x3b56d5(0x27c)],'status':_0x30db7d,'amount':_0x3f84e5[_0x3b56d5(0x250)],'currency':_0x3f84e5['currency'],'region':_0x3f84e5['region'],'additionalInfo':{'payment_method':_0x3f84e5[_0x3b56d5(0x211)],'transaction_id':_0x3f84e5[_0x3b56d5(0x208)]}};}}exports[a56_0x237abf(0x275)]=KlymeService;