'use strict';const a39_0x5df7ea=a39_0x3ac8;(function(_0x44e7fb,_0x4690f0){const _0x2b52cd=a39_0x3ac8,_0x194b30=_0x44e7fb();while(!![]){try{const _0x162ea5=parseInt(_0x2b52cd(0xee))/0x1*(parseInt(_0x2b52cd(0xaf))/0x2)+-parseInt(_0x2b52cd(0x10c))/0x3+parseInt(_0x2b52cd(0xb1))/0x4*(parseInt(_0x2b52cd(0xca))/0x5)+parseInt(_0x2b52cd(0x83))/0x6*(-parseInt(_0x2b52cd(0x82))/0x7)+parseInt(_0x2b52cd(0xbd))/0x8+-parseInt(_0x2b52cd(0x8d))/0x9*(-parseInt(_0x2b52cd(0x101))/0xa)+parseInt(_0x2b52cd(0xbf))/0xb;if(_0x162ea5===_0x4690f0)break;else _0x194b30['push'](_0x194b30['shift']());}catch(_0x4e1d5f){_0x194b30['push'](_0x194b30['shift']());}}}(a39_0x18ab,0x3f967));var __createBinding=this&&this[a39_0x5df7ea(0xd9)]||(Object[a39_0x5df7ea(0xe6)]?function(_0x13ad13,_0x2eaaf8,_0x4605cd,_0x52edc9){const _0xfa80b8=a39_0x5df7ea;if(_0x52edc9===undefined)_0x52edc9=_0x4605cd;var _0x847525=Object['getOwnPropertyDescriptor'](_0x2eaaf8,_0x4605cd);(!_0x847525||('get'in _0x847525?!_0x2eaaf8[_0xfa80b8(0xe1)]:_0x847525[_0xfa80b8(0x75)]||_0x847525[_0xfa80b8(0xb2)]))&&(_0x847525={'enumerable':!![],'get':function(){return _0x2eaaf8[_0x4605cd];}}),Object[_0xfa80b8(0x10d)](_0x13ad13,_0x52edc9,_0x847525);}:function(_0x2959f2,_0x4cda9f,_0x5e6afe,_0x36af00){if(_0x36af00===undefined)_0x36af00=_0x5e6afe;_0x2959f2[_0x36af00]=_0x4cda9f[_0x5e6afe];}),__setModuleDefault=this&&this[a39_0x5df7ea(0x8c)]||(Object['create']?function(_0x38f7dc,_0x4cea19){const _0x52e38a=a39_0x5df7ea;Object[_0x52e38a(0x10d)](_0x38f7dc,_0x52e38a(0x86),{'enumerable':!![],'value':_0x4cea19});}:function(_0x3efd39,_0x475e43){const _0xfd1c8b=a39_0x5df7ea;_0x3efd39[_0xfd1c8b(0x86)]=_0x475e43;}),__importStar=this&&this[a39_0x5df7ea(0xa1)]||(function(){var _0x2288e8=function(_0x27797f){const _0x455ece=a39_0x3ac8;return _0x2288e8=Object[_0x455ece(0xa4)]||function(_0x4033c1){const _0x5ee8b4=_0x455ece;var _0x2abaa4=[];for(var _0x318e70 in _0x4033c1)if(Object[_0x5ee8b4(0x73)]['hasOwnProperty'][_0x5ee8b4(0x74)](_0x4033c1,_0x318e70))_0x2abaa4[_0x2abaa4[_0x5ee8b4(0xf5)]]=_0x318e70;return _0x2abaa4;},_0x2288e8(_0x27797f);};return function(_0x1cb967){const _0x38a124=a39_0x3ac8;if(_0x1cb967&&_0x1cb967[_0x38a124(0xe1)])return _0x1cb967;var _0x163067={};if(_0x1cb967!=null){for(var _0x3856b3=_0x2288e8(_0x1cb967),_0x4f6284=0x0;_0x4f6284<_0x3856b3['length'];_0x4f6284++)if(_0x3856b3[_0x4f6284]!=='default')__createBinding(_0x163067,_0x1cb967,_0x3856b3[_0x4f6284]);}return __setModuleDefault(_0x163067,_0x1cb967),_0x163067;};}());function a39_0x3ac8(_0x3c2bd2,_0x1b1a0a){const _0x18abc9=a39_0x18ab();return a39_0x3ac8=function(_0x3ac83f,_0x3eea3e){_0x3ac83f=_0x3ac83f-0x73;let _0x4e4cde=_0x18abc9[_0x3ac83f];return _0x4e4cde;},a39_0x3ac8(_0x3c2bd2,_0x1b1a0a);}function a39_0x18ab(){const _0x512648=['KlymeService','then','getOwnPropertyNames','payment_method','/create','payment','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','../../config/database','stringify','Invalid\x20response\x20from\x20KLYME\x20','cancelled','processing','HTTP\x20Status:','6986bRbFsu','JSON\x20Parse\x20Error:\x20','16316IdKDAE','configurable','now','completed','PAID','timeout','\x20payment:\x20','Response\x20data:','\x20SUCCESS\x20(Legacy\x20Format)\x20===','Response\x20Time:','Request\x20Body:','redirect_url','199216jppsJl','uuid','4451018gCzKkx',',\x20body:\x20','\x20payment\x20verification\x20error:','HTTP\x20error!\x20status:\x20','(validated\x20for\x20','message','\x20payment\x20link:\x20','💳\x20KLYME\x20','successful','PENDING','status','105evmlmF','success','\x20API\x20error:\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','text','\x20validated)','fromEntries','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','Status:','headers','toLowerCase','\x20payment\x20link:\x20Unknown\x20error','processWebhook','(8digits-8digits\x20format)','generateUniqueReference','__createBinding','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Raw\x20Response\x20Body:','log','random','amount','Headers:','Region\x20(geo):','__esModule','Error\x20Message:','active','TesSoft\x20Payment\x20System/1.0','===\x20KLYME\x20','create','FAILED','===\x20PARSED\x20KLYME\x20','\x20API\x20ERROR\x20===','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','logWhiteDomainRequest','Unsupported\x20KLYME\x20region:\x20','Response\x20Body:','24kAYZnp','Redirect\x20URL:','Auth\x20URL:','Status\x20Text:','expired','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','validateCurrencyForRegion','length','⚠️\x20KLYME\x20reference\x20','Failed\x20to\x20verify\x20KLYME\x20','createPaymentLink','region','created','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','Parsed\x20Result:','reference','paid','toString','https://tesoft.uk/gateway/pending.php?id=','10BzIgbN','parse','https://tesoft.uk/gateway/klyme/','Error\x20message:','statusText','\x20API\x20BUSINESS\x20ERROR\x20===','verifyPayment','apiUrl','\x20SUCCESS\x20(New\x20Format)\x20===','logWhiteDomainResponse','authUrl','602499UMLCPl','defineProperty','prototype','call','writable','application/json','padStart','GBP','\x20(8digits-8digits\x20format\x20for\x20','Error\x20stack:','klyme_','resolve','pending','logWhiteDomainError','rejected','KLYME\x20','\x20API:\x20missing\x20payment\x20data','1301524juTGxs','6OWYgSY','/verify/','Unknown\x20error\x20from\x20KLYME\x20','default','findFirst','Reference\x20Used\x20as\x20ID:','order_id','POST','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','__setModuleDefault','433701wKoXXz','Geo\x20Parameter:','Unknown\x20error','loggerService','\x20RESPONSE\x20===','failed','UUID:','Reference\x20Used:','toUpperCase','Business\x20Error:\x20','EUR','HTTP\x20','🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20','statusCode','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','entries','Failed\x20to\x20create\x20KLYME\x20','\x20API','Error\x20details:','error','__importStar'];a39_0x18ab=function(){return _0x512648;};return a39_0x18ab();}Object[a39_0x5df7ea(0x10d)](exports,a39_0x5df7ea(0xe1),{'value':!![]}),exports[a39_0x5df7ea(0xa2)]=void 0x0;const loggerService_1=require('../loggerService');class KlymeService{constructor(){const _0x4568b2=a39_0x5df7ea;this['apiUrl']=_0x4568b2(0x103),console[_0x4568b2(0xdc)](_0x4568b2(0xea));}[a39_0x5df7ea(0xf4)](_0x4656e8,_0x1e91df){const _0x5a7112=a39_0x5df7ea,_0x36796b=_0x4656e8['toUpperCase']();switch(_0x1e91df){case'EU':if(_0x36796b!=='EUR')throw new Error(_0x5a7112(0xcd)+_0x36796b);break;case'GB':if(_0x36796b!==_0x5a7112(0x78))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x36796b);break;case'DE':if(_0x36796b!==_0x5a7112(0x97))throw new Error(_0x5a7112(0x8b)+_0x36796b);break;default:throw new Error(_0x5a7112(0xec)+_0x1e91df);}}async[a39_0x5df7ea(0xd8)](){const _0x518e7c=a39_0x5df7ea,_0x67cb81=(await Promise[_0x518e7c(0x7c)]()[_0x518e7c(0xa3)](()=>__importStar(require(_0x518e7c(0xa9)))))[_0x518e7c(0x86)];let _0x28cecc,_0x79d4ff=0x0;const _0x12b0c6=0xa;do{const _0x5ea219=()=>{const _0x351c27=_0x518e7c;return Math['floor'](Math[_0x351c27(0xdd)]()*0x5f5e100)[_0x351c27(0xff)]()[_0x351c27(0x77)](0x8,'0');};_0x28cecc=_0x5ea219()+'-'+_0x5ea219();const _0xd5b4b0=await _0x67cb81[_0x518e7c(0xa7)][_0x518e7c(0x87)]({'where':{'gatewayOrderId':_0x28cecc}});if(!_0xd5b4b0)break;_0x79d4ff++,console[_0x518e7c(0xdc)](_0x518e7c(0xf6)+_0x28cecc+_0x518e7c(0xf3)+_0x79d4ff+')');}while(_0x79d4ff<_0x12b0c6);if(_0x79d4ff>=_0x12b0c6)throw new Error(_0x518e7c(0x9b));return _0x28cecc;}async[a39_0x5df7ea(0xf8)](_0x812e9a){const _0x968777=a39_0x5df7ea,{orderId:_0x47dab0,amount:_0x4f36ab,currency:_0x285f5e,region:_0x5982e4}=_0x812e9a;if(_0x5982e4!=='EU'&&_0x5982e4!=='GB'&&_0x5982e4!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x5982e4);this[_0x968777(0xf4)](_0x285f5e,_0x5982e4);const _0x24a0d1=_0x285f5e[_0x968777(0x95)]();console[_0x968777(0xdc)](_0x968777(0xc6)+_0x5982e4+'\x20currency\x20validation\x20passed:\x20'+_0x24a0d1);const _0xabbfac=await this[_0x968777(0xd8)]();console['log'](_0x968777(0x99)+_0xabbfac+_0x968777(0x79)+_0x5982e4+')');const _0x32b4ac=_0x968777(0x100)+_0x47dab0,_0x503945={'amount':_0x4f36ab,'currency':_0x24a0d1,'redirectUrl':_0x32b4ac,'reference':_0xabbfac,'geo':_0x5982e4},_0x2df5f4=Date['now']();try{console[_0x968777(0xdc)]('===\x20KLYME\x20'+_0x5982e4+'\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20==='),console[_0x968777(0xdc)]('URL:',this[_0x968777(0x108)]),console[_0x968777(0xdc)](_0x968777(0xbb),JSON['stringify'](_0x503945,null,0x2)),console[_0x968777(0xdc)](_0x968777(0xe0),_0x5982e4),console[_0x968777(0xdc)]('Currency:',_0x24a0d1,_0x968777(0xc3)+_0x5982e4+')'),console[_0x968777(0xdc)]('Reference:',_0xabbfac,_0x968777(0xd7)),console['log'](_0x968777(0xef),_0x32b4ac),loggerService_1[_0x968777(0x90)]['logWhiteDomainRequest'](_0x968777(0x7b)+_0x5982e4[_0x968777(0xd4)](),_0x968777(0xa6),_0x968777(0x8a),_0x503945);const _0x2f0434=await fetch(this[_0x968777(0x108)],{'method':_0x968777(0x8a),'headers':{'Content-Type':_0x968777(0x76),'Accept':_0x968777(0x76),'User-Agent':_0x968777(0xe4)},'body':JSON['stringify'](_0x503945)}),_0x5d8b37=Date[_0x968777(0xb3)]()-_0x2df5f4;console[_0x968777(0xdc)](_0x968777(0xe5)+_0x5982e4+_0x968777(0xd1)),console[_0x968777(0xdc)](_0x968777(0xd2),_0x2f0434[_0x968777(0xc9)]),console[_0x968777(0xdc)](_0x968777(0xf1),_0x2f0434[_0x968777(0x105)]),console['log'](_0x968777(0xdf),Object[_0x968777(0xd0)](_0x2f0434[_0x968777(0xd3)][_0x968777(0x9c)]())),console[_0x968777(0xdc)](_0x968777(0xba),_0x5d8b37+'ms');const _0x59e2d2=await _0x2f0434[_0x968777(0xce)]();console['log'](_0x968777(0xdb),_0x59e2d2);if(!_0x2f0434['ok']){console['error']('===\x20KLYME\x20'+_0x5982e4+_0x968777(0xe9)),console[_0x968777(0xa0)](_0x968777(0xae),_0x2f0434[_0x968777(0xc9)]),console[_0x968777(0xa0)](_0x968777(0xed),_0x59e2d2),loggerService_1[_0x968777(0x90)]['logWhiteDomainResponse'](_0x968777(0x7b)+_0x5982e4[_0x968777(0xd4)](),_0x968777(0xa6),_0x2f0434[_0x968777(0xc9)],_0x59e2d2,_0x5d8b37),loggerService_1[_0x968777(0x90)]['logWhiteDomainError']('klyme_'+_0x5982e4[_0x968777(0xd4)](),'/create',_0x968777(0x98)+_0x2f0434[_0x968777(0xc9)]+':\x20'+_0x59e2d2);throw new Error(_0x968777(0xc2)+_0x2f0434[_0x968777(0xc9)]+_0x968777(0xc0)+_0x59e2d2);}let _0x1fc749;try{_0x1fc749=JSON[_0x968777(0x102)](_0x59e2d2);}catch(_0x201d75){console[_0x968777(0xa0)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x201d75),loggerService_1['loggerService'][_0x968777(0x7e)]('klyme_'+_0x5982e4['toLowerCase'](),_0x968777(0xa6),_0x968777(0xb0)+_0x201d75);throw new Error(_0x968777(0xfb)+_0x5982e4+'\x20API:\x20'+_0x59e2d2);}console[_0x968777(0xdc)](_0x968777(0xe8)+_0x5982e4+_0x968777(0x91)),console[_0x968777(0xdc)](_0x968777(0xfc),JSON[_0x968777(0xaa)](_0x1fc749,null,0x2)),loggerService_1[_0x968777(0x90)]['logWhiteDomainResponse'](_0x968777(0x7b)+_0x5982e4[_0x968777(0xd4)](),'/create',_0x2f0434[_0x968777(0xc9)],_0x1fc749,_0x5d8b37);if(_0x1fc749['error']||_0x1fc749[_0x968777(0x9a)]){const _0x4abbab=_0x1fc749['message']||_0x1fc749[_0x968777(0xa0)]||_0x968777(0x85)+_0x5982e4+_0x968777(0x9e);console[_0x968777(0xa0)]('===\x20KLYME\x20'+_0x5982e4+_0x968777(0x106)),console['error'](_0x968777(0xe2),_0x4abbab),console['error']('Status\x20Code:',_0x1fc749[_0x968777(0x9a)]),loggerService_1[_0x968777(0x90)][_0x968777(0x7e)](_0x968777(0x7b)+_0x5982e4['toLowerCase'](),_0x968777(0xa6),_0x968777(0x96)+_0x4abbab);throw new Error(_0x968777(0x80)+_0x5982e4+'\x20API\x20error:\x20'+_0x4abbab);}let _0x24443b,_0x3abdef;if(_0x1fc749[_0x968777(0xbe)]&&_0x1fc749[_0x968777(0xbc)])_0x24443b=_0x1fc749[_0x968777(0xbe)],_0x3abdef=_0x1fc749['redirect_url'],console[_0x968777(0xdc)](_0x968777(0xe5)+_0x5982e4+_0x968777(0x109)),console['log'](_0x968777(0x93),_0x1fc749[_0x968777(0xbe)]),console[_0x968777(0xdc)](_0x968777(0xef),_0x1fc749[_0x968777(0xbc)]);else{if(_0x1fc749[_0x968777(0x10b)])_0x24443b=_0xabbfac,_0x3abdef=_0x1fc749[_0x968777(0x10b)],console[_0x968777(0xdc)](_0x968777(0xe5)+_0x5982e4+_0x968777(0xb9)),console[_0x968777(0xdc)](_0x968777(0xf0),_0x1fc749['authUrl']),console[_0x968777(0xdc)](_0x968777(0x88),_0xabbfac);else{console[_0x968777(0xa0)](_0x968777(0xe5)+_0x5982e4+_0x968777(0xda)),console[_0x968777(0xa0)](_0x968777(0xa8)),console[_0x968777(0xa0)](_0x968777(0xb8),_0x1fc749),loggerService_1[_0x968777(0x90)][_0x968777(0x7e)]('klyme_'+_0x5982e4['toLowerCase'](),_0x968777(0xa6),'Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl');throw new Error(_0x968777(0xab)+_0x5982e4+_0x968777(0x81));}}return console['log']('Currency\x20Used:',_0x24a0d1,'('+_0x5982e4+_0x968777(0xcf)),console[_0x968777(0xdc)](_0x968777(0x94),_0xabbfac,_0x968777(0xd7)),console[_0x968777(0xdc)](_0x968777(0x8e),_0x5982e4),{'gateway_payment_id':_0x24443b,'payment_url':_0x3abdef};}catch(_0x2ede18){console[_0x968777(0xa0)](_0x968777(0xe5)+_0x5982e4+'\x20SERVICE\x20ERROR\x20==='),console[_0x968777(0xa0)](_0x968777(0x9f),_0x2ede18),loggerService_1[_0x968777(0x90)][_0x968777(0x7e)](_0x968777(0x7b)+_0x5982e4['toLowerCase'](),_0x968777(0xa6),_0x2ede18);if(_0x2ede18 instanceof Error){console[_0x968777(0xa0)](_0x968777(0x104),_0x2ede18['message']),console[_0x968777(0xa0)](_0x968777(0x7a),_0x2ede18['stack']);throw new Error(_0x968777(0x9d)+_0x5982e4+_0x968777(0xc5)+_0x2ede18[_0x968777(0xc4)]);}throw new Error(_0x968777(0x9d)+_0x5982e4+_0x968777(0xd5));}}async[a39_0x5df7ea(0x107)](_0xe4dddd,_0x478fd9){const _0x166caa=a39_0x5df7ea,_0x5406a3=Date['now']();try{const _0x1a9268={'gatewayPaymentId':_0xe4dddd,'geo':_0x478fd9};loggerService_1['loggerService'][_0x166caa(0xeb)]('klyme_'+_0x478fd9['toLowerCase'](),_0x166caa(0x84)+_0xe4dddd,_0x166caa(0x8a),_0x1a9268);const _0x54ea24=await fetch(this[_0x166caa(0x108)],{'method':_0x166caa(0x8a),'headers':{'Content-Type':'application/json','User-Agent':_0x166caa(0xe4)},'body':JSON[_0x166caa(0xaa)](_0x1a9268)}),_0x59a19b=Date['now']()-_0x5406a3;if(!_0x54ea24['ok']){const _0x2a4792=await _0x54ea24[_0x166caa(0xce)]();loggerService_1[_0x166caa(0x90)][_0x166caa(0x10a)]('klyme_'+_0x478fd9[_0x166caa(0xd4)](),_0x166caa(0x84)+_0xe4dddd,_0x54ea24[_0x166caa(0xc9)],_0x2a4792,_0x59a19b);throw new Error(_0x166caa(0xc2)+_0x54ea24[_0x166caa(0xc9)]);}const _0x53421b=await _0x54ea24['json']();loggerService_1[_0x166caa(0x90)][_0x166caa(0x10a)](_0x166caa(0x7b)+_0x478fd9[_0x166caa(0xd4)](),'/verify/'+_0xe4dddd,_0x54ea24[_0x166caa(0xc9)],_0x53421b,_0x59a19b);if(_0x53421b['error']||_0x53421b[_0x166caa(0x9a)]){loggerService_1[_0x166caa(0x90)][_0x166caa(0x7e)]('klyme_'+_0x478fd9[_0x166caa(0xd4)](),_0x166caa(0x84)+_0xe4dddd,_0x166caa(0x80)+_0x478fd9+_0x166caa(0xcc)+(_0x53421b[_0x166caa(0xc4)]||_0x53421b[_0x166caa(0xa0)]||_0x166caa(0x8f)));throw new Error('KLYME\x20'+_0x478fd9+'\x20API\x20error:\x20'+(_0x53421b['message']||_0x53421b[_0x166caa(0xa0)]||_0x166caa(0x8f)));}let _0x336256=_0x166caa(0xc8);return{'status':_0x336256};}catch(_0x391f46){console[_0x166caa(0xa0)](_0x166caa(0x80)+_0x478fd9+_0x166caa(0xc1),_0x391f46),loggerService_1['loggerService']['logWhiteDomainError'](_0x166caa(0x7b)+_0x478fd9[_0x166caa(0xd4)](),_0x166caa(0x84)+_0xe4dddd,_0x391f46);throw new Error(_0x166caa(0xf7)+_0x478fd9+_0x166caa(0xb7)+(_0x391f46 instanceof Error?_0x391f46[_0x166caa(0xc4)]:_0x166caa(0x8f)));}}async[a39_0x5df7ea(0xd6)](_0x311f9a){const _0x5257ff=a39_0x5df7ea;console[_0x5257ff(0xdc)]('Processing\x20KLYME\x20webhook:',_0x311f9a);let _0x3f21fa=_0x5257ff(0xc8);switch(_0x311f9a[_0x5257ff(0xc9)]?.[_0x5257ff(0xd4)]()){case _0x5257ff(0xfe):case _0x5257ff(0xb4):case'confirmed':case _0x5257ff(0xcb):case _0x5257ff(0xc7):_0x3f21fa=_0x5257ff(0xb5);break;case _0x5257ff(0xac):case'canceled':case _0x5257ff(0x92):case'error':case _0x5257ff(0x7f):_0x3f21fa=_0x5257ff(0xe7);break;case _0x5257ff(0xf2):case _0x5257ff(0xb6):_0x3f21fa='EXPIRED';break;case _0x5257ff(0x7d):case _0x5257ff(0xfa):case _0x5257ff(0xe3):case _0x5257ff(0xad):case'in_progress':default:_0x3f21fa=_0x5257ff(0xc8);break;}return{'paymentId':_0x311f9a[_0x5257ff(0xfd)]||_0x311f9a[_0x5257ff(0x89)]||_0x311f9a['payment_id'],'status':_0x3f21fa,'amount':_0x311f9a[_0x5257ff(0xde)],'currency':_0x311f9a['currency'],'region':_0x311f9a[_0x5257ff(0xf9)],'additionalInfo':{'payment_method':_0x311f9a[_0x5257ff(0xa5)],'transaction_id':_0x311f9a['transaction_id']}};}}exports[a39_0x5df7ea(0xa2)]=KlymeService;