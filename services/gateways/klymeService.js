'use strict';const a42_0x44e842=a42_0x3de6;(function(_0x188bf0,_0xc475f5){const _0x487139=a42_0x3de6,_0x510338=_0x188bf0();while(!![]){try{const _0x2e9233=-parseInt(_0x487139(0x120))/0x1+parseInt(_0x487139(0x127))/0x2*(-parseInt(_0x487139(0x13e))/0x3)+-parseInt(_0x487139(0x10d))/0x4*(-parseInt(_0x487139(0x123))/0x5)+parseInt(_0x487139(0x138))/0x6*(-parseInt(_0x487139(0x14e))/0x7)+-parseInt(_0x487139(0xfe))/0x8+-parseInt(_0x487139(0x16f))/0x9+parseInt(_0x487139(0x126))/0xa*(parseInt(_0x487139(0x162))/0xb);if(_0x2e9233===_0xc475f5)break;else _0x510338['push'](_0x510338['shift']());}catch(_0x5665db){_0x510338['push'](_0x510338['shift']());}}}(a42_0xa04e,0x89106));function a42_0xa04e(){const _0x2a705e=['PAID','Currency\x20Used:','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','\x20API:\x20missing\x20payment\x20data','Status\x20Text:','Response\x20Time:','random','Redirect\x20URL:','create','Failed\x20to\x20create\x20KLYME\x20','text','UUID:','message','4XGKQIX','Auth\x20URL:','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','in_progress','currency','Failed\x20to\x20parse\x20JSON\x20response:','logWhiteDomainResponse','stringify','Invalid\x20response\x20from\x20KLYME\x20','üí≥\x20KLYME\x20','json','pending','Parsed\x20Result:','processing','EXPIRED','logWhiteDomainRequest','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','‚ö†Ô∏è\x20KLYME\x20reference\x20','\x20validated)','251784UmHeLG','__esModule','padStart','2949565MSVOpP','toUpperCase','JSON\x20Parse\x20Error:\x20','350VyAVTQ','158gbGZBe','expired','\x20payment\x20verification\x20error:','../loggerService','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','validateCurrencyForRegion','Response\x20data:','POST','payment','uuid','configurable','URL:','https://tesoft.uk/gateway/pending.php?id=','writable','/create','default','/verify/','124146fWprvI','transaction_id','paid','Failed\x20to\x20verify\x20KLYME\x20','Status\x20Code:','completed','16221FbVRug','../../config/database','(validated\x20for\x20','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','toLowerCase','\x20API','redirect_url','verifyPayment','status','findFirst','TesSoft\x20Payment\x20System/1.0','success','Reference\x20Used:','logWhiteDomainError','processWebhook','140hLbRQE','FAILED','Business\x20Error:\x20','successful','Error\x20message:','active','createPaymentLink','parse','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','Unsupported\x20KLYME\x20region:\x20','EUR','Headers:','KLYME\x20','cancelled','Unknown\x20error\x20from\x20KLYME\x20','Region\x20(geo):','PENDING','(8digits-8digits\x20format)','\x20SUCCESS\x20(New\x20Format)\x20===','694397ttPLVq','\x20payment:\x20','GBP','Raw\x20Response\x20Body:','\x20SUCCESS\x20(Legacy\x20Format)\x20===','loggerService','\x20API\x20error:\x20','timeout','Status:','get','statusCode','canceled','\x20API\x20BUSINESS\x20ERROR\x20===','3324753pcRAlm','Response\x20Body:','\x20RESPONSE\x20===','\x20payment\x20link:\x20Unknown\x20error','Error\x20details:','generateUniqueReference','entries','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','amount','error','HTTP\x20error!\x20status:\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','log','===\x20PARSED\x20KLYME\x20','apiUrl',',\x20body:\x20','application/json','===\x20KLYME\x20','Unknown\x20error','authUrl','headers','failed','now','__setModuleDefault','getOwnPropertyDescriptor','floor','resolve','KlymeService','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','payment_method','klyme_','Error\x20Message:','getOwnPropertyNames','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','fromEntries','Geo\x20Parameter:','defineProperty','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','call','6206160sGrwlj','https://tesoft.uk/gateway/klyme/'];a42_0xa04e=function(){return _0x2a705e;};return a42_0xa04e();}var __createBinding=this&&this['__createBinding']||(Object[a42_0x44e842(0x108)]?function(_0x2d1163,_0x549fa4,_0x241f67,_0x42cd9a){const _0x1b4e91=a42_0x44e842;if(_0x42cd9a===undefined)_0x42cd9a=_0x241f67;var _0x11230d=Object[_0x1b4e91(0x187)](_0x549fa4,_0x241f67);(!_0x11230d||(_0x1b4e91(0x16b)in _0x11230d?!_0x549fa4[_0x1b4e91(0x121)]:_0x11230d[_0x1b4e91(0x134)]||_0x11230d[_0x1b4e91(0x131)]))&&(_0x11230d={'enumerable':!![],'get':function(){return _0x549fa4[_0x241f67];}}),Object[_0x1b4e91(0xfb)](_0x2d1163,_0x42cd9a,_0x11230d);}:function(_0x3b5f40,_0x37720f,_0xd849b5,_0x329b9b){if(_0x329b9b===undefined)_0x329b9b=_0xd849b5;_0x3b5f40[_0x329b9b]=_0x37720f[_0xd849b5];}),__setModuleDefault=this&&this[a42_0x44e842(0x186)]||(Object[a42_0x44e842(0x108)]?function(_0x56f84b,_0x320daf){const _0x2da541=a42_0x44e842;Object[_0x2da541(0xfb)](_0x56f84b,'default',{'enumerable':!![],'value':_0x320daf});}:function(_0x5bdc17,_0xd03d31){const _0x1b5985=a42_0x44e842;_0x5bdc17[_0x1b5985(0x136)]=_0xd03d31;}),__importStar=this&&this['__importStar']||(function(){var _0x516991=function(_0x223b18){const _0xee6749=a42_0x3de6;return _0x516991=Object[_0xee6749(0x18f)]||function(_0x1d9c97){const _0x44906c=_0xee6749;var _0x349c9d=[];for(var _0x4e81e2 in _0x1d9c97)if(Object['prototype']['hasOwnProperty'][_0x44906c(0xfd)](_0x1d9c97,_0x4e81e2))_0x349c9d[_0x349c9d['length']]=_0x4e81e2;return _0x349c9d;},_0x516991(_0x223b18);};return function(_0x56f4f0){const _0x3c2ded=a42_0x3de6;if(_0x56f4f0&&_0x56f4f0[_0x3c2ded(0x121)])return _0x56f4f0;var _0xf3eb88={};if(_0x56f4f0!=null){for(var _0x2c4842=_0x516991(_0x56f4f0),_0x4d4c88=0x0;_0x4d4c88<_0x2c4842['length'];_0x4d4c88++)if(_0x2c4842[_0x4d4c88]!==_0x3c2ded(0x136))__createBinding(_0xf3eb88,_0x56f4f0,_0x2c4842[_0x4d4c88]);}return __setModuleDefault(_0xf3eb88,_0x56f4f0),_0xf3eb88;};}());Object[a42_0x44e842(0xfb)](exports,'__esModule',{'value':!![]}),exports[a42_0x44e842(0x18a)]=void 0x0;const loggerService_1=require(a42_0x44e842(0x12a));function a42_0x3de6(_0x1de0dd,_0x55d716){const _0xa04e56=a42_0xa04e();return a42_0x3de6=function(_0x3de604,_0x150094){_0x3de604=_0x3de604-0xf9;let _0x54658b=_0xa04e56[_0x3de604];return _0x54658b;},a42_0x3de6(_0x1de0dd,_0x55d716);}class KlymeService{constructor(){const _0x1944c6=a42_0x44e842;this['apiUrl']=_0x1944c6(0xff),console[_0x1944c6(0x17b)](_0x1944c6(0x10f));}[a42_0x44e842(0x12c)](_0x44874d,_0x1e840){const _0x30f22d=a42_0x44e842,_0xb8ee72=_0x44874d[_0x30f22d(0x124)]();switch(_0x1e840){case'EU':if(_0xb8ee72!==_0x30f22d(0x159))throw new Error(_0x30f22d(0x17a)+_0xb8ee72);break;case'GB':if(_0xb8ee72!==_0x30f22d(0x164))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0xb8ee72);break;case'DE':if(_0xb8ee72!==_0x30f22d(0x159))throw new Error(_0x30f22d(0x176)+_0xb8ee72);break;default:throw new Error(_0x30f22d(0x158)+_0x1e840);}}async[a42_0x44e842(0x174)](){const _0xb7ef4e=a42_0x44e842,_0xe9075f=(await Promise[_0xb7ef4e(0x189)]()['then'](()=>__importStar(require(_0xb7ef4e(0x13f)))))[_0xb7ef4e(0x136)];let _0x58bfc3,_0x267100=0x0;const _0x44d08e=0xa;do{const _0x53d849=()=>{const _0x1808e9=_0xb7ef4e;return Math[_0x1808e9(0x188)](Math[_0x1808e9(0x106)]()*0x5f5e100)['toString']()[_0x1808e9(0x122)](0x8,'0');};_0x58bfc3=_0x53d849()+'-'+_0x53d849();const _0x388a33=await _0xe9075f[_0xb7ef4e(0x12f)][_0xb7ef4e(0x148)]({'where':{'gatewayOrderId':_0x58bfc3}});if(!_0x388a33)break;_0x267100++,console[_0xb7ef4e(0x17b)](_0xb7ef4e(0x11e)+_0x58bfc3+_0xb7ef4e(0x12b)+_0x267100+')');}while(_0x267100<_0x44d08e);if(_0x267100>=_0x44d08e)throw new Error(_0xb7ef4e(0x142));return _0x58bfc3;}async[a42_0x44e842(0x154)](_0x471652){const _0x50a419=a42_0x44e842,{orderId:_0x3c8ad1,amount:_0x4beb7e,currency:_0x92d94a,region:_0x57e213}=_0x471652;if(_0x57e213!=='EU'&&_0x57e213!=='GB'&&_0x57e213!=='DE')throw new Error(_0x50a419(0x157)+_0x57e213);this['validateCurrencyForRegion'](_0x92d94a,_0x57e213);const _0xf3f1dd=_0x92d94a[_0x50a419(0x124)]();console[_0x50a419(0x17b)](_0x50a419(0x116)+_0x57e213+'\x20currency\x20validation\x20passed:\x20'+_0xf3f1dd);const _0x2e57e7=await this[_0x50a419(0x174)]();console[_0x50a419(0x17b)](_0x50a419(0x18b)+_0x2e57e7+'\x20(8digits-8digits\x20format\x20for\x20'+_0x57e213+')');const _0x248999=_0x50a419(0x133)+_0x3c8ad1,_0x328aa0={'amount':_0x4beb7e,'currency':_0xf3f1dd,'redirectUrl':_0x248999,'reference':_0x2e57e7,'geo':_0x57e213},_0x1efaa1=Date['now']();try{console[_0x50a419(0x17b)](_0x50a419(0x180)+_0x57e213+_0x50a419(0x141)),console[_0x50a419(0x17b)](_0x50a419(0x132),this[_0x50a419(0x17d)]),console[_0x50a419(0x17b)]('Request\x20Body:',JSON[_0x50a419(0x114)](_0x328aa0,null,0x2)),console[_0x50a419(0x17b)](_0x50a419(0x15e),_0x57e213),console[_0x50a419(0x17b)]('Currency:',_0xf3f1dd,_0x50a419(0x140)+_0x57e213+')'),console['log']('Reference:',_0x2e57e7,_0x50a419(0x160)),console[_0x50a419(0x17b)](_0x50a419(0x107),_0x248999),loggerService_1[_0x50a419(0x167)][_0x50a419(0x11c)](_0x50a419(0x18d)+_0x57e213['toLowerCase'](),_0x50a419(0x135),_0x50a419(0x12e),_0x328aa0);const _0x2f12a=await fetch(this[_0x50a419(0x17d)],{'method':_0x50a419(0x12e),'headers':{'Content-Type':_0x50a419(0x17f),'Accept':_0x50a419(0x17f),'User-Agent':_0x50a419(0x149)},'body':JSON[_0x50a419(0x114)](_0x328aa0)}),_0x298e16=Date[_0x50a419(0x185)]()-_0x1efaa1;console[_0x50a419(0x17b)](_0x50a419(0x180)+_0x57e213+_0x50a419(0x11d)),console[_0x50a419(0x17b)](_0x50a419(0x16a),_0x2f12a[_0x50a419(0x147)]),console[_0x50a419(0x17b)](_0x50a419(0x104),_0x2f12a['statusText']),console[_0x50a419(0x17b)](_0x50a419(0x15a),Object[_0x50a419(0xf9)](_0x2f12a[_0x50a419(0x183)][_0x50a419(0x175)]())),console[_0x50a419(0x17b)](_0x50a419(0x105),_0x298e16+'ms');const _0x37b534=await _0x2f12a['text']();console[_0x50a419(0x17b)](_0x50a419(0x165),_0x37b534);if(!_0x2f12a['ok']){console[_0x50a419(0x178)](_0x50a419(0x180)+_0x57e213+'\x20API\x20ERROR\x20==='),console[_0x50a419(0x178)]('HTTP\x20Status:',_0x2f12a['status']),console['error'](_0x50a419(0x170),_0x37b534),loggerService_1[_0x50a419(0x167)][_0x50a419(0x113)](_0x50a419(0x18d)+_0x57e213[_0x50a419(0x143)](),_0x50a419(0x135),_0x2f12a['status'],_0x37b534,_0x298e16),loggerService_1[_0x50a419(0x167)][_0x50a419(0x14c)](_0x50a419(0x18d)+_0x57e213['toLowerCase'](),_0x50a419(0x135),'HTTP\x20'+_0x2f12a['status']+':\x20'+_0x37b534);throw new Error(_0x50a419(0x179)+_0x2f12a[_0x50a419(0x147)]+_0x50a419(0x17e)+_0x37b534);}let _0x11775d;try{_0x11775d=JSON[_0x50a419(0x155)](_0x37b534);}catch(_0x251e60){console[_0x50a419(0x178)](_0x50a419(0x112),_0x251e60),loggerService_1[_0x50a419(0x167)][_0x50a419(0x14c)](_0x50a419(0x18d)+_0x57e213[_0x50a419(0x143)](),_0x50a419(0x135),_0x50a419(0x125)+_0x251e60);throw new Error(_0x50a419(0x190)+_0x57e213+'\x20API:\x20'+_0x37b534);}console[_0x50a419(0x17b)](_0x50a419(0x17c)+_0x57e213+_0x50a419(0x171)),console[_0x50a419(0x17b)](_0x50a419(0x119),JSON[_0x50a419(0x114)](_0x11775d,null,0x2)),loggerService_1['loggerService'][_0x50a419(0x113)]('klyme_'+_0x57e213[_0x50a419(0x143)](),_0x50a419(0x135),_0x2f12a['status'],_0x11775d,_0x298e16);if(_0x11775d[_0x50a419(0x178)]||_0x11775d[_0x50a419(0x16c)]){const _0x4cc573=_0x11775d[_0x50a419(0x10c)]||_0x11775d['error']||_0x50a419(0x15d)+_0x57e213+_0x50a419(0x144);console[_0x50a419(0x178)](_0x50a419(0x180)+_0x57e213+_0x50a419(0x16e)),console[_0x50a419(0x178)](_0x50a419(0x18e),_0x4cc573),console[_0x50a419(0x178)](_0x50a419(0x13c),_0x11775d[_0x50a419(0x16c)]),loggerService_1[_0x50a419(0x167)][_0x50a419(0x14c)](_0x50a419(0x18d)+_0x57e213[_0x50a419(0x143)](),_0x50a419(0x135),_0x50a419(0x150)+_0x4cc573);throw new Error(_0x50a419(0x15b)+_0x57e213+'\x20API\x20error:\x20'+_0x4cc573);}let _0x25fa27,_0x16db3b;if(_0x11775d['uuid']&&_0x11775d[_0x50a419(0x145)])_0x25fa27=_0x11775d[_0x50a419(0x130)],_0x16db3b=_0x11775d[_0x50a419(0x145)],console['log'](_0x50a419(0x180)+_0x57e213+_0x50a419(0x161)),console[_0x50a419(0x17b)](_0x50a419(0x10b),_0x11775d[_0x50a419(0x130)]),console[_0x50a419(0x17b)](_0x50a419(0x107),_0x11775d['redirect_url']);else{if(_0x11775d[_0x50a419(0x182)])_0x25fa27=_0x2e57e7,_0x16db3b=_0x11775d['authUrl'],console['log'](_0x50a419(0x180)+_0x57e213+_0x50a419(0x166)),console[_0x50a419(0x17b)](_0x50a419(0x10e),_0x11775d[_0x50a419(0x182)]),console['log']('Reference\x20Used\x20as\x20ID:',_0x2e57e7);else{console[_0x50a419(0x178)](_0x50a419(0x180)+_0x57e213+_0x50a419(0x102)),console[_0x50a419(0x178)](_0x50a419(0x156)),console[_0x50a419(0x178)](_0x50a419(0x12d),_0x11775d),loggerService_1[_0x50a419(0x167)][_0x50a419(0x14c)]('klyme_'+_0x57e213['toLowerCase'](),_0x50a419(0x135),_0x50a419(0xfc));throw new Error(_0x50a419(0x115)+_0x57e213+_0x50a419(0x103));}}return console[_0x50a419(0x17b)](_0x50a419(0x101),_0xf3f1dd,'('+_0x57e213+_0x50a419(0x11f)),console[_0x50a419(0x17b)](_0x50a419(0x14b),_0x2e57e7,_0x50a419(0x160)),console[_0x50a419(0x17b)](_0x50a419(0xfa),_0x57e213),{'gateway_payment_id':_0x25fa27,'payment_url':_0x16db3b};}catch(_0x4029e0){console['error'](_0x50a419(0x180)+_0x57e213+'\x20SERVICE\x20ERROR\x20==='),console[_0x50a419(0x178)](_0x50a419(0x173),_0x4029e0),loggerService_1[_0x50a419(0x167)][_0x50a419(0x14c)](_0x50a419(0x18d)+_0x57e213[_0x50a419(0x143)](),_0x50a419(0x135),_0x4029e0);if(_0x4029e0 instanceof Error){console[_0x50a419(0x178)](_0x50a419(0x152),_0x4029e0[_0x50a419(0x10c)]),console['error']('Error\x20stack:',_0x4029e0['stack']);throw new Error(_0x50a419(0x109)+_0x57e213+'\x20payment\x20link:\x20'+_0x4029e0[_0x50a419(0x10c)]);}throw new Error(_0x50a419(0x109)+_0x57e213+_0x50a419(0x172));}}async[a42_0x44e842(0x146)](_0x592031,_0x33b5f0){const _0x566a54=a42_0x44e842,_0x4b693b=Date[_0x566a54(0x185)]();try{const _0x541d07={'gatewayPaymentId':_0x592031,'geo':_0x33b5f0};loggerService_1[_0x566a54(0x167)][_0x566a54(0x11c)](_0x566a54(0x18d)+_0x33b5f0[_0x566a54(0x143)](),'/verify/'+_0x592031,_0x566a54(0x12e),_0x541d07);const _0x42da41=await fetch(this[_0x566a54(0x17d)],{'method':_0x566a54(0x12e),'headers':{'Content-Type':_0x566a54(0x17f),'User-Agent':_0x566a54(0x149)},'body':JSON[_0x566a54(0x114)](_0x541d07)}),_0x1458cc=Date[_0x566a54(0x185)]()-_0x4b693b;if(!_0x42da41['ok']){const _0x4a897b=await _0x42da41[_0x566a54(0x10a)]();loggerService_1[_0x566a54(0x167)][_0x566a54(0x113)](_0x566a54(0x18d)+_0x33b5f0['toLowerCase'](),_0x566a54(0x137)+_0x592031,_0x42da41[_0x566a54(0x147)],_0x4a897b,_0x1458cc);throw new Error('HTTP\x20error!\x20status:\x20'+_0x42da41[_0x566a54(0x147)]);}const _0x392e78=await _0x42da41[_0x566a54(0x117)]();loggerService_1[_0x566a54(0x167)][_0x566a54(0x113)](_0x566a54(0x18d)+_0x33b5f0[_0x566a54(0x143)](),_0x566a54(0x137)+_0x592031,_0x42da41[_0x566a54(0x147)],_0x392e78,_0x1458cc);if(_0x392e78[_0x566a54(0x178)]||_0x392e78[_0x566a54(0x16c)]){loggerService_1[_0x566a54(0x167)][_0x566a54(0x14c)](_0x566a54(0x18d)+_0x33b5f0[_0x566a54(0x143)](),_0x566a54(0x137)+_0x592031,_0x566a54(0x15b)+_0x33b5f0+_0x566a54(0x168)+(_0x392e78[_0x566a54(0x10c)]||_0x392e78[_0x566a54(0x178)]||_0x566a54(0x181)));throw new Error(_0x566a54(0x15b)+_0x33b5f0+_0x566a54(0x168)+(_0x392e78[_0x566a54(0x10c)]||_0x392e78['error']||_0x566a54(0x181)));}let _0x12efcb=_0x566a54(0x15f);return{'status':_0x12efcb};}catch(_0x5883f0){console[_0x566a54(0x178)](_0x566a54(0x15b)+_0x33b5f0+_0x566a54(0x129),_0x5883f0),loggerService_1['loggerService'][_0x566a54(0x14c)](_0x566a54(0x18d)+_0x33b5f0[_0x566a54(0x143)](),_0x566a54(0x137)+_0x592031,_0x5883f0);throw new Error(_0x566a54(0x13b)+_0x33b5f0+_0x566a54(0x163)+(_0x5883f0 instanceof Error?_0x5883f0[_0x566a54(0x10c)]:_0x566a54(0x181)));}}async[a42_0x44e842(0x14d)](_0x2a12f5){const _0x142ac8=a42_0x44e842;console[_0x142ac8(0x17b)]('Processing\x20KLYME\x20webhook:',_0x2a12f5);let _0x9e9ea9='PENDING';switch(_0x2a12f5[_0x142ac8(0x147)]?.['toLowerCase']()){case _0x142ac8(0x13a):case _0x142ac8(0x13d):case'confirmed':case _0x142ac8(0x14a):case _0x142ac8(0x151):_0x9e9ea9=_0x142ac8(0x100);break;case _0x142ac8(0x15c):case _0x142ac8(0x16d):case _0x142ac8(0x184):case _0x142ac8(0x178):case'rejected':_0x9e9ea9=_0x142ac8(0x14f);break;case _0x142ac8(0x128):case _0x142ac8(0x169):_0x9e9ea9=_0x142ac8(0x11b);break;case _0x142ac8(0x118):case'created':case _0x142ac8(0x153):case _0x142ac8(0x11a):case _0x142ac8(0x110):default:_0x9e9ea9=_0x142ac8(0x15f);break;}return{'paymentId':_0x2a12f5['reference']||_0x2a12f5['order_id']||_0x2a12f5['payment_id'],'status':_0x9e9ea9,'amount':_0x2a12f5[_0x142ac8(0x177)],'currency':_0x2a12f5[_0x142ac8(0x111)],'region':_0x2a12f5['region'],'additionalInfo':{'payment_method':_0x2a12f5[_0x142ac8(0x18c)],'transaction_id':_0x2a12f5[_0x142ac8(0x139)]}};}}exports['KlymeService']=KlymeService;