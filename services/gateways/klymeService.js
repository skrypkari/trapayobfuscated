'use strict';const a41_0x43e24a=a41_0x1823;(function(_0x2cce34,_0x45ef47){const _0x24436f=a41_0x1823,_0x583414=_0x2cce34();while(!![]){try{const _0x53eaaf=parseInt(_0x24436f(0x15f))/0x1*(-parseInt(_0x24436f(0x149))/0x2)+-parseInt(_0x24436f(0x126))/0x3+parseInt(_0x24436f(0x120))/0x4+-parseInt(_0x24436f(0xe4))/0x5*(parseInt(_0x24436f(0xe0))/0x6)+parseInt(_0x24436f(0x144))/0x7*(parseInt(_0x24436f(0x125))/0x8)+parseInt(_0x24436f(0x12f))/0x9+-parseInt(_0x24436f(0x129))/0xa*(-parseInt(_0x24436f(0x160))/0xb);if(_0x53eaaf===_0x45ef47)break;else _0x583414['push'](_0x583414['shift']());}catch(_0x4b8084){_0x583414['push'](_0x583414['shift']());}}}(a41_0x42bf,0x6c88d));function a41_0x1823(_0x536e8c,_0x1d4c2c){const _0x42bf08=a41_0x42bf();return a41_0x1823=function(_0x182356,_0x13ec77){_0x182356=_0x182356-0xd6;let _0x48a53f=_0x42bf08[_0x182356];return _0x48a53f;},a41_0x1823(_0x536e8c,_0x1d4c2c);}var __createBinding=this&&this[a41_0x43e24a(0xe3)]||(Object[a41_0x43e24a(0x14c)]?function(_0x41b703,_0x4d43b9,_0x441e61,_0x44236e){const _0x50c59f=a41_0x43e24a;if(_0x44236e===undefined)_0x44236e=_0x441e61;var _0x3811a4=Object[_0x50c59f(0xe8)](_0x4d43b9,_0x441e61);(!_0x3811a4||(_0x50c59f(0xde)in _0x3811a4?!_0x4d43b9[_0x50c59f(0xf4)]:_0x3811a4[_0x50c59f(0x135)]||_0x3811a4[_0x50c59f(0x14e)]))&&(_0x3811a4={'enumerable':!![],'get':function(){return _0x4d43b9[_0x441e61];}}),Object[_0x50c59f(0xed)](_0x41b703,_0x44236e,_0x3811a4);}:function(_0x5572a7,_0x315c76,_0x44d8a6,_0x3162cb){if(_0x3162cb===undefined)_0x3162cb=_0x44d8a6;_0x5572a7[_0x3162cb]=_0x315c76[_0x44d8a6];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a41_0x43e24a(0x14c)]?function(_0x4edda2,_0x600335){const _0x185cdd=a41_0x43e24a;Object[_0x185cdd(0xed)](_0x4edda2,'default',{'enumerable':!![],'value':_0x600335});}:function(_0x46e024,_0x5242d5){const _0x582f5c=a41_0x43e24a;_0x46e024[_0x582f5c(0xe2)]=_0x5242d5;}),__importStar=this&&this['__importStar']||(function(){var _0x15e1a2=function(_0x590042){return _0x15e1a2=Object['getOwnPropertyNames']||function(_0x588f01){const _0xfddfe1=a41_0x1823;var _0x54c393=[];for(var _0x4dba46 in _0x588f01)if(Object[_0xfddfe1(0x13c)][_0xfddfe1(0xf2)][_0xfddfe1(0x170)](_0x588f01,_0x4dba46))_0x54c393[_0x54c393[_0xfddfe1(0xec)]]=_0x4dba46;return _0x54c393;},_0x15e1a2(_0x590042);};return function(_0x593fe3){const _0x2dda30=a41_0x1823;if(_0x593fe3&&_0x593fe3[_0x2dda30(0xf4)])return _0x593fe3;var _0x3c2c8e={};if(_0x593fe3!=null){for(var _0x373be7=_0x15e1a2(_0x593fe3),_0x557ee8=0x0;_0x557ee8<_0x373be7[_0x2dda30(0xec)];_0x557ee8++)if(_0x373be7[_0x557ee8]!==_0x2dda30(0xe2))__createBinding(_0x3c2c8e,_0x593fe3,_0x373be7[_0x557ee8]);}return __setModuleDefault(_0x3c2c8e,_0x593fe3),_0x3c2c8e;};}());Object['defineProperty'](exports,a41_0x43e24a(0xf4),{'value':!![]}),exports['KlymeService']=void 0x0;const loggerService_1=require('../loggerService');class KlymeService{constructor(){const _0x5e2d46=a41_0x43e24a;this['apiUrl']=_0x5e2d46(0xf9),console[_0x5e2d46(0x11a)](_0x5e2d46(0x101));}['validateCurrencyForRegion'](_0x3fc660,_0x3858db){const _0x491f96=a41_0x43e24a,_0x3f7e7f=_0x3fc660[_0x491f96(0x112)]();switch(_0x3858db){case'EU':if(_0x3f7e7f!==_0x491f96(0x122))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x3f7e7f);break;case'GB':if(_0x3f7e7f!==_0x491f96(0x15e))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x3f7e7f);break;case'DE':if(_0x3f7e7f!==_0x491f96(0x122))throw new Error(_0x491f96(0x11c)+_0x3f7e7f);break;default:throw new Error(_0x491f96(0x155)+_0x3858db);}}async[a41_0x43e24a(0x12b)](){const _0x22d55f=a41_0x43e24a,_0x10e02d=(await Promise[_0x22d55f(0x13d)]()[_0x22d55f(0xf3)](()=>__importStar(require(_0x22d55f(0xe7)))))[_0x22d55f(0xe2)];let _0x2b1d9f,_0x26694c=0x0;const _0x3b8f31=0xa;do{const _0x567b0b=()=>{const _0x2d53b5=_0x22d55f;return Math[_0x2d53b5(0x130)](Math[_0x2d53b5(0x162)]()*0x5f5e100)[_0x2d53b5(0x115)]()[_0x2d53b5(0xe1)](0x8,'0');};_0x2b1d9f=_0x567b0b()+'-'+_0x567b0b();const _0x807ca9=await _0x10e02d[_0x22d55f(0x152)][_0x22d55f(0xf5)]({'where':{'gatewayOrderId':_0x2b1d9f}});if(!_0x807ca9)break;_0x26694c++,console[_0x22d55f(0x11a)](_0x22d55f(0x10a)+_0x2b1d9f+'\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20'+_0x26694c+')');}while(_0x26694c<_0x3b8f31);if(_0x26694c>=_0x3b8f31)throw new Error(_0x22d55f(0xfb));return _0x2b1d9f;}async[a41_0x43e24a(0x159)](_0x1c97cd){const _0x490770=a41_0x43e24a,{orderId:_0x4bbc95,amount:_0x119112,currency:_0x215852,region:_0x2539c5}=_0x1c97cd;if(_0x2539c5!=='EU'&&_0x2539c5!=='GB'&&_0x2539c5!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x2539c5);this[_0x490770(0x100)](_0x215852,_0x2539c5);const _0x558dd9=_0x215852['toUpperCase']();console[_0x490770(0x11a)](_0x490770(0xeb)+_0x2539c5+_0x490770(0x111)+_0x558dd9);const _0x3e152b=await this[_0x490770(0x12b)]();console[_0x490770(0x11a)](_0x490770(0x119)+_0x3e152b+'\x20(8digits-8digits\x20format\x20for\x20'+_0x2539c5+')');const _0x262f74=_0x490770(0x142)+_0x4bbc95,_0x197d47={'amount':_0x119112,'currency':_0x558dd9,'redirectUrl':_0x262f74,'reference':_0x3e152b,'geo':_0x2539c5},_0x210913=Date[_0x490770(0x153)]();try{console[_0x490770(0x11a)](_0x490770(0x12a)+_0x2539c5+_0x490770(0x134)),console['log'](_0x490770(0x148),this[_0x490770(0xe5)]),console['log'](_0x490770(0x16a),JSON['stringify'](_0x197d47,null,0x2)),console[_0x490770(0x11a)](_0x490770(0x108),_0x2539c5),console[_0x490770(0x11a)](_0x490770(0x154),_0x558dd9,_0x490770(0x11b)+_0x2539c5+')'),console[_0x490770(0x11a)](_0x490770(0x156),_0x3e152b,'(8digits-8digits\x20format)'),console[_0x490770(0x11a)](_0x490770(0x127),_0x262f74),loggerService_1[_0x490770(0xdb)][_0x490770(0xd8)](_0x490770(0xee)+_0x2539c5[_0x490770(0x102)](),'/create','POST',_0x197d47);const _0x20db82=await fetch(this[_0x490770(0xe5)],{'method':_0x490770(0x10f),'headers':{'Content-Type':_0x490770(0x107),'Accept':_0x490770(0x107),'User-Agent':_0x490770(0x15b)},'body':JSON[_0x490770(0x145)](_0x197d47)}),_0x342b16=Date[_0x490770(0x153)]()-_0x210913;console['log'](_0x490770(0x12a)+_0x2539c5+_0x490770(0x104)),console[_0x490770(0x11a)](_0x490770(0x14a),_0x20db82['status']),console[_0x490770(0x11a)]('Status\x20Text:',_0x20db82[_0x490770(0x150)]),console[_0x490770(0x11a)](_0x490770(0x16d),Object[_0x490770(0xfe)](_0x20db82[_0x490770(0xe6)][_0x490770(0x161)]())),console[_0x490770(0x11a)](_0x490770(0x15a),_0x342b16+'ms');const _0xf66a97=await _0x20db82[_0x490770(0x105)]();console[_0x490770(0x11a)](_0x490770(0x147),_0xf66a97);if(!_0x20db82['ok']){console['error'](_0x490770(0x12a)+_0x2539c5+_0x490770(0xea)),console[_0x490770(0xf0)](_0x490770(0x146),_0x20db82['status']),console[_0x490770(0xf0)](_0x490770(0x11f),_0xf66a97),loggerService_1['loggerService'][_0x490770(0x114)](_0x490770(0xee)+_0x2539c5['toLowerCase'](),_0x490770(0x11e),_0x20db82[_0x490770(0x16f)],_0xf66a97,_0x342b16),loggerService_1[_0x490770(0xdb)][_0x490770(0x15d)](_0x490770(0xee)+_0x2539c5['toLowerCase'](),_0x490770(0x11e),_0x490770(0x132)+_0x20db82[_0x490770(0x16f)]+':\x20'+_0xf66a97);throw new Error(_0x490770(0x10e)+_0x20db82[_0x490770(0x16f)]+',\x20body:\x20'+_0xf66a97);}let _0xa21dc7;try{_0xa21dc7=JSON[_0x490770(0x14b)](_0xf66a97);}catch(_0x179d29){console['error'](_0x490770(0x143),_0x179d29),loggerService_1[_0x490770(0xdb)][_0x490770(0x15d)](_0x490770(0xee)+_0x2539c5[_0x490770(0x102)](),_0x490770(0x11e),_0x490770(0x163)+_0x179d29);throw new Error(_0x490770(0xd6)+_0x2539c5+_0x490770(0x10d)+_0xf66a97);}console[_0x490770(0x11a)](_0x490770(0xfc)+_0x2539c5+'\x20RESPONSE\x20==='),console[_0x490770(0x11a)]('Parsed\x20Result:',JSON[_0x490770(0x145)](_0xa21dc7,null,0x2)),loggerService_1[_0x490770(0xdb)][_0x490770(0x114)](_0x490770(0xee)+_0x2539c5[_0x490770(0x102)](),_0x490770(0x11e),_0x20db82[_0x490770(0x16f)],_0xa21dc7,_0x342b16);if(_0xa21dc7['error']||_0xa21dc7['statusCode']){const _0x14aeb0=_0xa21dc7[_0x490770(0x10c)]||_0xa21dc7['error']||_0x490770(0xd9)+_0x2539c5+'\x20API';console[_0x490770(0xf0)]('===\x20KLYME\x20'+_0x2539c5+_0x490770(0xdf)),console[_0x490770(0xf0)]('Error\x20Message:',_0x14aeb0),console['error'](_0x490770(0x14d),_0xa21dc7[_0x490770(0x168)]),loggerService_1[_0x490770(0xdb)][_0x490770(0x15d)](_0x490770(0xee)+_0x2539c5['toLowerCase'](),_0x490770(0x11e),_0x490770(0xdd)+_0x14aeb0);throw new Error(_0x490770(0x131)+_0x2539c5+_0x490770(0x106)+_0x14aeb0);}let _0x497c5c,_0x33d713;if(_0xa21dc7[_0x490770(0x124)]&&_0xa21dc7[_0x490770(0x109)])_0x497c5c=_0xa21dc7[_0x490770(0x124)],_0x33d713=_0xa21dc7[_0x490770(0x109)],console[_0x490770(0x11a)](_0x490770(0x12a)+_0x2539c5+_0x490770(0x10b)),console['log']('UUID:',_0xa21dc7[_0x490770(0x124)]),console['log'](_0x490770(0x127),_0xa21dc7[_0x490770(0x109)]);else{if(_0xa21dc7[_0x490770(0x169)])_0x497c5c=_0x3e152b,_0x33d713=_0xa21dc7[_0x490770(0x169)],console['log'](_0x490770(0x12a)+_0x2539c5+_0x490770(0x121)),console[_0x490770(0x11a)](_0x490770(0x12c),_0xa21dc7['authUrl']),console[_0x490770(0x11a)](_0x490770(0xda),_0x3e152b);else{console[_0x490770(0xf0)](_0x490770(0x12a)+_0x2539c5+_0x490770(0x14f)),console[_0x490770(0xf0)]('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console[_0x490770(0xf0)](_0x490770(0x16e),_0xa21dc7),loggerService_1[_0x490770(0xdb)][_0x490770(0x15d)](_0x490770(0xee)+_0x2539c5[_0x490770(0x102)](),'/create',_0x490770(0xf6));throw new Error(_0x490770(0x113)+_0x2539c5+_0x490770(0x157));}}return console[_0x490770(0x11a)]('Currency\x20Used:',_0x558dd9,'('+_0x2539c5+_0x490770(0xf8)),console[_0x490770(0x11a)](_0x490770(0x158),_0x3e152b,_0x490770(0xd7)),console[_0x490770(0x11a)]('Geo\x20Parameter:',_0x2539c5),{'gateway_payment_id':_0x497c5c,'payment_url':_0x33d713};}catch(_0x155e10){console['error'](_0x490770(0x12a)+_0x2539c5+_0x490770(0x167)),console['error'](_0x490770(0x118),_0x155e10),loggerService_1[_0x490770(0xdb)][_0x490770(0x15d)](_0x490770(0xee)+_0x2539c5[_0x490770(0x102)](),_0x490770(0x11e),_0x155e10);if(_0x155e10 instanceof Error){console[_0x490770(0xf0)](_0x490770(0xf7),_0x155e10['message']),console[_0x490770(0xf0)](_0x490770(0x141),_0x155e10[_0x490770(0x128)]);throw new Error(_0x490770(0xf1)+_0x2539c5+'\x20payment\x20link:\x20'+_0x155e10[_0x490770(0x10c)]);}throw new Error(_0x490770(0xf1)+_0x2539c5+_0x490770(0x137));}}async['verifyPayment'](_0x3eb6f4,_0x2afa1a){const _0x2782ff=a41_0x43e24a,_0x16e5ee=Date[_0x2782ff(0x153)]();try{const _0x50c245={'gatewayPaymentId':_0x3eb6f4,'geo':_0x2afa1a};loggerService_1['loggerService']['logWhiteDomainRequest'](_0x2782ff(0xee)+_0x2afa1a[_0x2782ff(0x102)](),_0x2782ff(0x12e)+_0x3eb6f4,_0x2782ff(0x10f),_0x50c245);const _0x3c55c0=await fetch(this[_0x2782ff(0xe5)],{'method':'POST','headers':{'Content-Type':_0x2782ff(0x107),'User-Agent':_0x2782ff(0x15b)},'body':JSON['stringify'](_0x50c245)}),_0x266fba=Date['now']()-_0x16e5ee;if(!_0x3c55c0['ok']){const _0x1a915b=await _0x3c55c0[_0x2782ff(0x105)]();loggerService_1[_0x2782ff(0xdb)][_0x2782ff(0x114)]('klyme_'+_0x2afa1a[_0x2782ff(0x102)](),'/verify/'+_0x3eb6f4,_0x3c55c0[_0x2782ff(0x16f)],_0x1a915b,_0x266fba);throw new Error(_0x2782ff(0x10e)+_0x3c55c0[_0x2782ff(0x16f)]);}const _0x46d411=await _0x3c55c0[_0x2782ff(0x13e)]();loggerService_1[_0x2782ff(0xdb)][_0x2782ff(0x114)]('klyme_'+_0x2afa1a[_0x2782ff(0x102)](),_0x2782ff(0x12e)+_0x3eb6f4,_0x3c55c0[_0x2782ff(0x16f)],_0x46d411,_0x266fba);if(_0x46d411[_0x2782ff(0xf0)]||_0x46d411[_0x2782ff(0x168)]){loggerService_1[_0x2782ff(0xdb)][_0x2782ff(0x15d)](_0x2782ff(0xee)+_0x2afa1a[_0x2782ff(0x102)](),_0x2782ff(0x12e)+_0x3eb6f4,'KLYME\x20'+_0x2afa1a+_0x2782ff(0x106)+(_0x46d411[_0x2782ff(0x10c)]||_0x46d411['error']||'Unknown\x20error'));throw new Error(_0x2782ff(0x131)+_0x2afa1a+_0x2782ff(0x106)+(_0x46d411[_0x2782ff(0x10c)]||_0x46d411[_0x2782ff(0xf0)]||_0x2782ff(0x164)));}let _0x5a6d2d=_0x2782ff(0x117);return{'status':_0x5a6d2d};}catch(_0x298107){console[_0x2782ff(0xf0)](_0x2782ff(0x131)+_0x2afa1a+'\x20payment\x20verification\x20error:',_0x298107),loggerService_1[_0x2782ff(0xdb)]['logWhiteDomainError'](_0x2782ff(0xee)+_0x2afa1a[_0x2782ff(0x102)](),_0x2782ff(0x12e)+_0x3eb6f4,_0x298107);throw new Error(_0x2782ff(0x166)+_0x2afa1a+'\x20payment:\x20'+(_0x298107 instanceof Error?_0x298107[_0x2782ff(0x10c)]:_0x2782ff(0x164)));}}async['processWebhook'](_0x121c4f){const _0x3f672b=a41_0x43e24a;console['log'](_0x3f672b(0xdc),_0x121c4f);let _0x55c93c=_0x3f672b(0x117);switch(_0x121c4f[_0x3f672b(0x16f)]?.[_0x3f672b(0x102)]()){case _0x3f672b(0x139):case _0x3f672b(0x13b):case _0x3f672b(0x13f):case'success':case _0x3f672b(0x165):_0x55c93c=_0x3f672b(0xfd);break;case _0x3f672b(0x110):case _0x3f672b(0x133):case'failed':case _0x3f672b(0xf0):case _0x3f672b(0x140):_0x55c93c=_0x3f672b(0xe9);break;case _0x3f672b(0x12d):case _0x3f672b(0x138):_0x55c93c=_0x3f672b(0x13a);break;case _0x3f672b(0x116):case _0x3f672b(0x16c):case'active':case _0x3f672b(0x16b):case _0x3f672b(0x151):default:_0x55c93c=_0x3f672b(0x117);break;}return{'paymentId':_0x121c4f[_0x3f672b(0x123)]||_0x121c4f['order_id']||_0x121c4f[_0x3f672b(0x15c)],'status':_0x55c93c,'amount':_0x121c4f[_0x3f672b(0x11d)],'currency':_0x121c4f[_0x3f672b(0x103)],'region':_0x121c4f[_0x3f672b(0xef)],'additionalInfo':{'payment_method':_0x121c4f[_0x3f672b(0x136)],'transaction_id':_0x121c4f[_0x3f672b(0xff)]}};}}function a41_0x42bf(){const _0x52a287=['GBP','15eviLGV','11RmmqFd','entries','random','JSON\x20Parse\x20Error:\x20','Unknown\x20error','successful','Failed\x20to\x20verify\x20KLYME\x20','\x20SERVICE\x20ERROR\x20===','statusCode','authUrl','Request\x20Body:','processing','created','Headers:','Response\x20data:','status','call','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','(8digits-8digits\x20format)','logWhiteDomainRequest','Unknown\x20error\x20from\x20KLYME\x20','Reference\x20Used\x20as\x20ID:','loggerService','Processing\x20KLYME\x20webhook:','Business\x20Error:\x20','get','\x20API\x20BUSINESS\x20ERROR\x20===','6NeMHqr','padStart','default','__createBinding','2885215pvsspV','apiUrl','headers','../../config/database','getOwnPropertyDescriptor','FAILED','\x20API\x20ERROR\x20===','💳\x20KLYME\x20','length','defineProperty','klyme_','region','error','Failed\x20to\x20create\x20KLYME\x20','hasOwnProperty','then','__esModule','findFirst','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','Error\x20message:','\x20validated)','https://tesoft.uk/gateway/klyme/','KlymeService','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','===\x20PARSED\x20KLYME\x20','PAID','fromEntries','transaction_id','validateCurrencyForRegion','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','toLowerCase','currency','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','text','\x20API\x20error:\x20','application/json','Region\x20(geo):','redirect_url','⚠️\x20KLYME\x20reference\x20','\x20SUCCESS\x20(New\x20Format)\x20===','message','\x20API:\x20','HTTP\x20error!\x20status:\x20','POST','cancelled','\x20currency\x20validation\x20passed:\x20','toUpperCase','Invalid\x20response\x20from\x20KLYME\x20','logWhiteDomainResponse','toString','pending','PENDING','Error\x20details:','🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20','log','(validated\x20for\x20','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','amount','/create','Response\x20Body:','2878924NyjFif','\x20SUCCESS\x20(Legacy\x20Format)\x20===','EUR','reference','uuid','5433592wVwvKo','2501937DqMJZB','Redirect\x20URL:','stack','292780DsKhrK','===\x20KLYME\x20','generateUniqueReference','Auth\x20URL:','expired','/verify/','4824144vSzzfB','floor','KLYME\x20','HTTP\x20','canceled','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','writable','payment_method','\x20payment\x20link:\x20Unknown\x20error','timeout','paid','EXPIRED','completed','prototype','resolve','json','confirmed','rejected','Error\x20stack:','https://tesoft.uk/gateway/pending.php?id=','Failed\x20to\x20parse\x20JSON\x20response:','7WKOIbY','stringify','HTTP\x20Status:','Raw\x20Response\x20Body:','URL:','14486rWMhOn','Status:','parse','create','Status\x20Code:','configurable','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','statusText','in_progress','payment','now','Currency:','Unsupported\x20KLYME\x20region:\x20','Reference:','\x20API:\x20missing\x20payment\x20data','Reference\x20Used:','createPaymentLink','Response\x20Time:','TesSoft\x20Payment\x20System/1.0','payment_id','logWhiteDomainError'];a41_0x42bf=function(){return _0x52a287;};return a41_0x42bf();}exports[a41_0x43e24a(0xfa)]=KlymeService;