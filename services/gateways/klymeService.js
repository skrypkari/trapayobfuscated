'use strict';function a39_0xa86b(_0x48b951,_0x4fd734){const _0x1770d0=a39_0x1770();return a39_0xa86b=function(_0xa86b84,_0x7ea681){_0xa86b84=_0xa86b84-0xdc;let _0x209268=_0x1770d0[_0xa86b84];return _0x209268;},a39_0xa86b(_0x48b951,_0x4fd734);}const a39_0x3e67be=a39_0xa86b;(function(_0x2326fe,_0x240bdf){const _0x2b37b5=a39_0xa86b,_0xb95234=_0x2326fe();while(!![]){try{const _0x2e95e0=parseInt(_0x2b37b5(0xfd))/0x1*(-parseInt(_0x2b37b5(0x125))/0x2)+-parseInt(_0x2b37b5(0x113))/0x3+-parseInt(_0x2b37b5(0x153))/0x4+parseInt(_0x2b37b5(0x131))/0x5+-parseInt(_0x2b37b5(0x10e))/0x6+parseInt(_0x2b37b5(0xff))/0x7+parseInt(_0x2b37b5(0x107))/0x8;if(_0x2e95e0===_0x240bdf)break;else _0xb95234['push'](_0xb95234['shift']());}catch(_0x3217d8){_0xb95234['push'](_0xb95234['shift']());}}}(a39_0x1770,0x80c33));var __createBinding=this&&this[a39_0x3e67be(0xe7)]||(Object[a39_0x3e67be(0xdd)]?function(_0x1f8ff3,_0xdc6634,_0x50858e,_0x250e8f){const _0xdc9fa=a39_0x3e67be;if(_0x250e8f===undefined)_0x250e8f=_0x50858e;var _0x41ffcd=Object[_0xdc9fa(0x122)](_0xdc6634,_0x50858e);(!_0x41ffcd||('get'in _0x41ffcd?!_0xdc6634[_0xdc9fa(0x104)]:_0x41ffcd['writable']||_0x41ffcd[_0xdc9fa(0x12c)]))&&(_0x41ffcd={'enumerable':!![],'get':function(){return _0xdc6634[_0x50858e];}}),Object['defineProperty'](_0x1f8ff3,_0x250e8f,_0x41ffcd);}:function(_0x479263,_0x5d3b98,_0x273970,_0x3ce981){if(_0x3ce981===undefined)_0x3ce981=_0x273970;_0x479263[_0x3ce981]=_0x5d3b98[_0x273970];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a39_0x3e67be(0xdd)]?function(_0x17a256,_0x1c7b6f){const _0x39e147=a39_0x3e67be;Object[_0x39e147(0x10a)](_0x17a256,_0x39e147(0x15a),{'enumerable':!![],'value':_0x1c7b6f});}:function(_0x2410da,_0x4d6bf9){_0x2410da['default']=_0x4d6bf9;}),__importStar=this&&this['__importStar']||(function(){var _0x2f4148=function(_0x5a67e2){const _0x39e89e=a39_0xa86b;return _0x2f4148=Object[_0x39e89e(0x12f)]||function(_0x42dc8c){const _0x2a8146=_0x39e89e;var _0x6b3d10=[];for(var _0x3a1c22 in _0x42dc8c)if(Object['prototype'][_0x2a8146(0x144)][_0x2a8146(0x101)](_0x42dc8c,_0x3a1c22))_0x6b3d10[_0x6b3d10[_0x2a8146(0x165)]]=_0x3a1c22;return _0x6b3d10;},_0x2f4148(_0x5a67e2);};return function(_0x24f328){const _0x1bafb3=a39_0xa86b;if(_0x24f328&&_0x24f328[_0x1bafb3(0x104)])return _0x24f328;var _0x4c9386={};if(_0x24f328!=null){for(var _0x508a0d=_0x2f4148(_0x24f328),_0x5308a8=0x0;_0x5308a8<_0x508a0d[_0x1bafb3(0x165)];_0x5308a8++)if(_0x508a0d[_0x5308a8]!==_0x1bafb3(0x15a))__createBinding(_0x4c9386,_0x24f328,_0x508a0d[_0x5308a8]);}return __setModuleDefault(_0x4c9386,_0x24f328),_0x4c9386;};}());Object[a39_0x3e67be(0x10a)](exports,a39_0x3e67be(0x104),{'value':!![]}),exports[a39_0x3e67be(0x162)]=void 0x0;const loggerService_1=require('../loggerService');function a39_0x1770(){const _0x393939=['failed','__createBinding','confirmed','\x20payment\x20link:\x20','\x20SERVICE\x20ERROR\x20===','active','ðŸ’³\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','Redirect\x20URL:','then','Failed\x20to\x20create\x20KLYME\x20','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','status','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','created','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','entries','application/json','paid','(8digits-8digits\x20format)','\x20API\x20BUSINESS\x20ERROR\x20===','order_id','Error\x20stack:','Unknown\x20error\x20from\x20KLYME\x20','2IdWnRI','Status:','4751768cRgwhn','toString','call','Unsupported\x20KLYME\x20region:\x20','currency','__esModule','processWebhook','in_progress','6216144GtArZi','Raw\x20Response\x20Body:','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','defineProperty','json','âš ï¸\x20KLYME\x20reference\x20','JSON\x20Parse\x20Error:\x20','899100EnUzaU','\x20(8digits-8digits\x20format\x20for\x20','authUrl',',\x20body:\x20','\x20SUCCESS\x20(Legacy\x20Format)\x20===','823707abhKmt','validateCurrencyForRegion','HTTP\x20error!\x20status:\x20','(validated\x20for\x20','POST','timeout','Unknown\x20error','parse','https://tesoft.uk/gateway/klyme/','\x20API:\x20','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','toUpperCase','uuid','verifyPayment','message','getOwnPropertyDescriptor','ðŸ’³\x20KLYME\x20','Failed\x20to\x20parse\x20JSON\x20response:','442324bDaMas','\x20payment\x20verification\x20error:','Auth\x20URL:','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Region\x20(geo):','floor','Status\x20Code:','configurable','generateUniqueReference','Response\x20data:','getOwnPropertyNames','EXPIRED','2819195vsANTf','random','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','../../config/database','success','redirect_url','processing','\x20validated)','Parsed\x20Result:','klyme_','loggerService','payment_method','toLowerCase','transaction_id','Headers:','PENDING','createPaymentLink','statusText','/verify/','hasOwnProperty','\x20RESPONSE\x20===','URL:','===\x20KLYME\x20','Reference:','UUID:','error','now','padStart','Failed\x20to\x20verify\x20KLYME\x20','log','text','cancelled','resolve','Status\x20Text:','2502108EvSeJl','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','logWhiteDomainResponse','Currency:','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','\x20API','\x20currency\x20validation\x20passed:\x20','default','\x20API:\x20missing\x20payment\x20data','KLYME\x20','headers','https://tesoft.uk/gateway/pending.php?id=','logWhiteDomainError','\x20API\x20error:\x20','stringify','KlymeService','===\x20PARSED\x20KLYME\x20','Invalid\x20response\x20from\x20KLYME\x20','length','logWhiteDomainRequest','create','findFirst','amount','region','/create','HTTP\x20Status:','statusCode','EUR','apiUrl'];a39_0x1770=function(){return _0x393939;};return a39_0x1770();}class KlymeService{constructor(){const _0x4cdfb3=a39_0x3e67be;this[_0x4cdfb3(0xe5)]=_0x4cdfb3(0x11b),console[_0x4cdfb3(0x14e)](_0x4cdfb3(0xec));}[a39_0x3e67be(0x114)](_0x289f8f,_0xa464a7){const _0x466578=a39_0x3e67be,_0x1b130d=_0x289f8f[_0x466578(0x11e)]();switch(_0xa464a7){case'EU':if(_0x1b130d!==_0x466578(0xe4))throw new Error(_0x466578(0xf2)+_0x1b130d);break;case'GB':if(_0x1b130d!=='GBP')throw new Error(_0x466578(0x154)+_0x1b130d);break;case'DE':if(_0x1b130d!==_0x466578(0xe4))throw new Error(_0x466578(0x128)+_0x1b130d);break;default:throw new Error(_0x466578(0x102)+_0xa464a7);}}async[a39_0x3e67be(0x12d)](){const _0x168582=a39_0x3e67be,_0x1233bb=(await Promise[_0x168582(0x151)]()[_0x168582(0xee)](()=>__importStar(require(_0x168582(0x134)))))[_0x168582(0x15a)];let _0x16be80,_0x172fb8=0x0;const _0x2ed50a=0xa;do{const _0x1eeea4=()=>{const _0x54f869=_0x168582;return Math[_0x54f869(0x12a)](Math[_0x54f869(0x132)]()*0x5f5e100)[_0x54f869(0x100)]()[_0x54f869(0x14c)](0x8,'0');};_0x16be80=_0x1eeea4()+'-'+_0x1eeea4();const _0x17f324=await _0x1233bb['payment'][_0x168582(0xde)]({'where':{'gatewayOrderId':_0x16be80}});if(!_0x17f324)break;_0x172fb8++,console[_0x168582(0x14e)](_0x168582(0x10c)+_0x16be80+'\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20'+_0x172fb8+')');}while(_0x172fb8<_0x2ed50a);if(_0x172fb8>=_0x2ed50a)throw new Error(_0x168582(0xf4));return _0x16be80;}async[a39_0x3e67be(0x141)](_0x4172c8){const _0x101722=a39_0x3e67be,{orderId:_0x4efb1f,amount:_0x388ab9,currency:_0x10167b,region:_0x50be38}=_0x4172c8;if(_0x50be38!=='EU'&&_0x50be38!=='GB'&&_0x50be38!=='DE')throw new Error(_0x101722(0x11d)+_0x50be38);this[_0x101722(0x114)](_0x10167b,_0x50be38);const _0xcdd2eb=_0x10167b[_0x101722(0x11e)]();console[_0x101722(0x14e)](_0x101722(0x123)+_0x50be38+_0x101722(0x159)+_0xcdd2eb);const _0x30a7d2=await this[_0x101722(0x12d)]();console['log']('ðŸŽ¯\x20Generated\x20unique\x20KLYME\x20reference:\x20'+_0x30a7d2+_0x101722(0x10f)+_0x50be38+')');const _0x316e8c=_0x101722(0x15e)+_0x4efb1f,_0x3f87c5={'amount':_0x388ab9,'currency':_0xcdd2eb,'redirectUrl':_0x316e8c,'reference':_0x30a7d2,'geo':_0x50be38},_0x36a878=Date['now']();try{console['log'](_0x101722(0x147)+_0x50be38+_0x101722(0xf0)),console['log'](_0x101722(0x146),this[_0x101722(0xe5)]),console[_0x101722(0x14e)]('Request\x20Body:',JSON[_0x101722(0x161)](_0x3f87c5,null,0x2)),console[_0x101722(0x14e)](_0x101722(0x129),_0x50be38),console[_0x101722(0x14e)](_0x101722(0x156),_0xcdd2eb,_0x101722(0x116)+_0x50be38+')'),console[_0x101722(0x14e)](_0x101722(0x148),_0x30a7d2,_0x101722(0xf8)),console[_0x101722(0x14e)](_0x101722(0xed),_0x316e8c),loggerService_1[_0x101722(0x13b)][_0x101722(0xdc)](_0x101722(0x13a)+_0x50be38[_0x101722(0x13d)](),_0x101722(0xe1),'POST',_0x3f87c5);const _0x3ec97b=await fetch(this['apiUrl'],{'method':_0x101722(0x117),'headers':{'Content-Type':_0x101722(0xf6),'Accept':_0x101722(0xf6),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x101722(0x161)](_0x3f87c5)}),_0x10ae00=Date[_0x101722(0x14b)]()-_0x36a878;console[_0x101722(0x14e)](_0x101722(0x147)+_0x50be38+_0x101722(0x109)),console['log'](_0x101722(0xfe),_0x3ec97b[_0x101722(0xf1)]),console[_0x101722(0x14e)](_0x101722(0x152),_0x3ec97b[_0x101722(0x142)]),console['log'](_0x101722(0x13f),Object['fromEntries'](_0x3ec97b[_0x101722(0x15d)][_0x101722(0xf5)]())),console[_0x101722(0x14e)]('Response\x20Time:',_0x10ae00+'ms');const _0x5598d0=await _0x3ec97b[_0x101722(0x14f)]();console['log'](_0x101722(0x108),_0x5598d0);if(!_0x3ec97b['ok']){console['error']('===\x20KLYME\x20'+_0x50be38+'\x20API\x20ERROR\x20==='),console['error'](_0x101722(0xe2),_0x3ec97b[_0x101722(0xf1)]),console['error']('Response\x20Body:',_0x5598d0),loggerService_1[_0x101722(0x13b)]['logWhiteDomainResponse']('klyme_'+_0x50be38[_0x101722(0x13d)](),_0x101722(0xe1),_0x3ec97b[_0x101722(0xf1)],_0x5598d0,_0x10ae00),loggerService_1[_0x101722(0x13b)][_0x101722(0x15f)](_0x101722(0x13a)+_0x50be38[_0x101722(0x13d)](),_0x101722(0xe1),'HTTP\x20'+_0x3ec97b['status']+':\x20'+_0x5598d0);throw new Error(_0x101722(0x115)+_0x3ec97b['status']+_0x101722(0x111)+_0x5598d0);}let _0x3168ad;try{_0x3168ad=JSON[_0x101722(0x11a)](_0x5598d0);}catch(_0x26de42){console[_0x101722(0x14a)](_0x101722(0x124),_0x26de42),loggerService_1[_0x101722(0x13b)][_0x101722(0x15f)](_0x101722(0x13a)+_0x50be38[_0x101722(0x13d)](),'/create',_0x101722(0x10d)+_0x26de42);throw new Error('Invalid\x20JSON\x20response\x20from\x20KLYME\x20'+_0x50be38+_0x101722(0x11c)+_0x5598d0);}console[_0x101722(0x14e)](_0x101722(0x163)+_0x50be38+_0x101722(0x145)),console[_0x101722(0x14e)](_0x101722(0x139),JSON[_0x101722(0x161)](_0x3168ad,null,0x2)),loggerService_1[_0x101722(0x13b)][_0x101722(0x155)](_0x101722(0x13a)+_0x50be38[_0x101722(0x13d)](),_0x101722(0xe1),_0x3ec97b['status'],_0x3168ad,_0x10ae00);if(_0x3168ad['error']||_0x3168ad[_0x101722(0xe3)]){const _0x40c038=_0x3168ad[_0x101722(0x121)]||_0x3168ad[_0x101722(0x14a)]||_0x101722(0xfc)+_0x50be38+_0x101722(0x158);console[_0x101722(0x14a)](_0x101722(0x147)+_0x50be38+_0x101722(0xf9)),console['error']('Error\x20Message:',_0x40c038),console[_0x101722(0x14a)](_0x101722(0x12b),_0x3168ad['statusCode']),loggerService_1[_0x101722(0x13b)][_0x101722(0x15f)](_0x101722(0x13a)+_0x50be38['toLowerCase'](),'/create','Business\x20Error:\x20'+_0x40c038);throw new Error(_0x101722(0x15c)+_0x50be38+_0x101722(0x160)+_0x40c038);}let _0x4a6ecc,_0x220a51;if(_0x3168ad[_0x101722(0x11f)]&&_0x3168ad[_0x101722(0x136)])_0x4a6ecc=_0x3168ad[_0x101722(0x11f)],_0x220a51=_0x3168ad[_0x101722(0x136)],console[_0x101722(0x14e)]('===\x20KLYME\x20'+_0x50be38+'\x20SUCCESS\x20(New\x20Format)\x20==='),console[_0x101722(0x14e)](_0x101722(0x149),_0x3168ad[_0x101722(0x11f)]),console[_0x101722(0x14e)](_0x101722(0xed),_0x3168ad['redirect_url']);else{if(_0x3168ad['authUrl'])_0x4a6ecc=_0x30a7d2,_0x220a51=_0x3168ad[_0x101722(0x110)],console['log'](_0x101722(0x147)+_0x50be38+_0x101722(0x112)),console[_0x101722(0x14e)](_0x101722(0x127),_0x3168ad[_0x101722(0x110)]),console[_0x101722(0x14e)]('Reference\x20Used\x20as\x20ID:',_0x30a7d2);else{console['error'](_0x101722(0x147)+_0x50be38+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x101722(0x14a)](_0x101722(0x133)),console[_0x101722(0x14a)](_0x101722(0x12e),_0x3168ad),loggerService_1['loggerService'][_0x101722(0x15f)]('klyme_'+_0x50be38[_0x101722(0x13d)](),_0x101722(0xe1),_0x101722(0x157));throw new Error(_0x101722(0x164)+_0x50be38+_0x101722(0x15b));}}return console[_0x101722(0x14e)]('Currency\x20Used:',_0xcdd2eb,'('+_0x50be38+_0x101722(0x138)),console[_0x101722(0x14e)]('Reference\x20Used:',_0x30a7d2,_0x101722(0xf8)),console['log']('Geo\x20Parameter:',_0x50be38),{'gateway_payment_id':_0x4a6ecc,'payment_url':_0x220a51};}catch(_0x5be117){console[_0x101722(0x14a)](_0x101722(0x147)+_0x50be38+_0x101722(0xea)),console[_0x101722(0x14a)]('Error\x20details:',_0x5be117),loggerService_1['loggerService'][_0x101722(0x15f)](_0x101722(0x13a)+_0x50be38[_0x101722(0x13d)](),_0x101722(0xe1),_0x5be117);if(_0x5be117 instanceof Error){console[_0x101722(0x14a)]('Error\x20message:',_0x5be117['message']),console['error'](_0x101722(0xfb),_0x5be117['stack']);throw new Error(_0x101722(0xef)+_0x50be38+_0x101722(0xe9)+_0x5be117[_0x101722(0x121)]);}throw new Error(_0x101722(0xef)+_0x50be38+'\x20payment\x20link:\x20Unknown\x20error');}}async[a39_0x3e67be(0x120)](_0x5dec8e,_0x11511d){const _0x2ed2d0=a39_0x3e67be,_0x238490=Date['now']();try{const _0x3778f9={'gatewayPaymentId':_0x5dec8e,'geo':_0x11511d};loggerService_1[_0x2ed2d0(0x13b)][_0x2ed2d0(0xdc)](_0x2ed2d0(0x13a)+_0x11511d['toLowerCase'](),'/verify/'+_0x5dec8e,'POST',_0x3778f9);const _0x263884=await fetch(this[_0x2ed2d0(0xe5)],{'method':_0x2ed2d0(0x117),'headers':{'Content-Type':_0x2ed2d0(0xf6),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x2ed2d0(0x161)](_0x3778f9)}),_0x1c43b0=Date[_0x2ed2d0(0x14b)]()-_0x238490;if(!_0x263884['ok']){const _0x351eb2=await _0x263884['text']();loggerService_1['loggerService'][_0x2ed2d0(0x155)]('klyme_'+_0x11511d['toLowerCase'](),_0x2ed2d0(0x143)+_0x5dec8e,_0x263884[_0x2ed2d0(0xf1)],_0x351eb2,_0x1c43b0);throw new Error(_0x2ed2d0(0x115)+_0x263884[_0x2ed2d0(0xf1)]);}const _0xb4b79c=await _0x263884[_0x2ed2d0(0x10b)]();loggerService_1[_0x2ed2d0(0x13b)][_0x2ed2d0(0x155)]('klyme_'+_0x11511d['toLowerCase'](),'/verify/'+_0x5dec8e,_0x263884[_0x2ed2d0(0xf1)],_0xb4b79c,_0x1c43b0);if(_0xb4b79c[_0x2ed2d0(0x14a)]||_0xb4b79c[_0x2ed2d0(0xe3)]){loggerService_1[_0x2ed2d0(0x13b)]['logWhiteDomainError'](_0x2ed2d0(0x13a)+_0x11511d[_0x2ed2d0(0x13d)](),_0x2ed2d0(0x143)+_0x5dec8e,_0x2ed2d0(0x15c)+_0x11511d+_0x2ed2d0(0x160)+(_0xb4b79c['message']||_0xb4b79c[_0x2ed2d0(0x14a)]||'Unknown\x20error'));throw new Error(_0x2ed2d0(0x15c)+_0x11511d+_0x2ed2d0(0x160)+(_0xb4b79c['message']||_0xb4b79c[_0x2ed2d0(0x14a)]||_0x2ed2d0(0x119)));}let _0xc23e92=_0x2ed2d0(0x140);return{'status':_0xc23e92};}catch(_0x1de523){console[_0x2ed2d0(0x14a)](_0x2ed2d0(0x15c)+_0x11511d+_0x2ed2d0(0x126),_0x1de523),loggerService_1[_0x2ed2d0(0x13b)][_0x2ed2d0(0x15f)](_0x2ed2d0(0x13a)+_0x11511d[_0x2ed2d0(0x13d)](),'/verify/'+_0x5dec8e,_0x1de523);throw new Error(_0x2ed2d0(0x14d)+_0x11511d+'\x20payment:\x20'+(_0x1de523 instanceof Error?_0x1de523[_0x2ed2d0(0x121)]:'Unknown\x20error'));}}async[a39_0x3e67be(0x105)](_0x17bae3){const _0x4b3f9a=a39_0x3e67be;console['log']('Processing\x20KLYME\x20webhook:',_0x17bae3);let _0x20b6a5=_0x4b3f9a(0x140);switch(_0x17bae3[_0x4b3f9a(0xf1)]?.['toLowerCase']()){case _0x4b3f9a(0xf7):case'completed':case _0x4b3f9a(0xe8):case _0x4b3f9a(0x135):case'successful':_0x20b6a5='PAID';break;case _0x4b3f9a(0x150):case'canceled':case _0x4b3f9a(0xe6):case _0x4b3f9a(0x14a):case'rejected':_0x20b6a5='FAILED';break;case'expired':case _0x4b3f9a(0x118):_0x20b6a5=_0x4b3f9a(0x130);break;case'pending':case _0x4b3f9a(0xf3):case _0x4b3f9a(0xeb):case _0x4b3f9a(0x137):case _0x4b3f9a(0x106):default:_0x20b6a5='PENDING';break;}return{'paymentId':_0x17bae3['reference']||_0x17bae3[_0x4b3f9a(0xfa)]||_0x17bae3['payment_id'],'status':_0x20b6a5,'amount':_0x17bae3[_0x4b3f9a(0xdf)],'currency':_0x17bae3[_0x4b3f9a(0x103)],'region':_0x17bae3[_0x4b3f9a(0xe0)],'additionalInfo':{'payment_method':_0x17bae3[_0x4b3f9a(0x13c)],'transaction_id':_0x17bae3[_0x4b3f9a(0x13e)]}};}}exports[a39_0x3e67be(0x162)]=KlymeService;