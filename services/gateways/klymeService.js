'use strict';const a41_0x397716=a41_0x3418;(function(_0x381a9d,_0x513abe){const _0x1fa958=a41_0x3418,_0x38c259=_0x381a9d();while(!![]){try{const _0x31b31b=-parseInt(_0x1fa958(0x131))/0x1*(parseInt(_0x1fa958(0xd5))/0x2)+parseInt(_0x1fa958(0x12f))/0x3+-parseInt(_0x1fa958(0xee))/0x4+parseInt(_0x1fa958(0x11b))/0x5+-parseInt(_0x1fa958(0x115))/0x6*(-parseInt(_0x1fa958(0x118))/0x7)+parseInt(_0x1fa958(0x14e))/0x8+-parseInt(_0x1fa958(0x13c))/0x9*(parseInt(_0x1fa958(0x130))/0xa);if(_0x31b31b===_0x513abe)break;else _0x38c259['push'](_0x38c259['shift']());}catch(_0x3059f0){_0x38c259['push'](_0x38c259['shift']());}}}(a41_0x5a1b,0xd7db0));var __createBinding=this&&this[a41_0x397716(0x111)]||(Object[a41_0x397716(0x13f)]?function(_0x45e915,_0x34a9c9,_0x110be3,_0x30e637){const _0x5212ad=a41_0x397716;if(_0x30e637===undefined)_0x30e637=_0x110be3;var _0x225271=Object[_0x5212ad(0x125)](_0x34a9c9,_0x110be3);(!_0x225271||(_0x5212ad(0x149)in _0x225271?!_0x34a9c9['__esModule']:_0x225271[_0x5212ad(0x155)]||_0x225271[_0x5212ad(0x156)]))&&(_0x225271={'enumerable':!![],'get':function(){return _0x34a9c9[_0x110be3];}}),Object[_0x5212ad(0xe3)](_0x45e915,_0x30e637,_0x225271);}:function(_0x57a66b,_0x40f54,_0x181e32,_0x27666c){if(_0x27666c===undefined)_0x27666c=_0x181e32;_0x57a66b[_0x27666c]=_0x40f54[_0x181e32];}),__setModuleDefault=this&&this[a41_0x397716(0xe6)]||(Object['create']?function(_0x2e0b21,_0x40a549){Object['defineProperty'](_0x2e0b21,'default',{'enumerable':!![],'value':_0x40a549});}:function(_0xd4d873,_0xac3347){const _0x3320e4=a41_0x397716;_0xd4d873[_0x3320e4(0x134)]=_0xac3347;}),__importStar=this&&this[a41_0x397716(0xe5)]||(function(){var _0x36bb24=function(_0x48bc89){const _0x3fcc4b=a41_0x3418;return _0x36bb24=Object[_0x3fcc4b(0x13a)]||function(_0x2d2ed7){const _0x19d846=_0x3fcc4b;var _0x4de4e3=[];for(var _0x495194 in _0x2d2ed7)if(Object[_0x19d846(0x15f)]['hasOwnProperty'][_0x19d846(0x108)](_0x2d2ed7,_0x495194))_0x4de4e3[_0x4de4e3['length']]=_0x495194;return _0x4de4e3;},_0x36bb24(_0x48bc89);};return function(_0x5346d9){const _0x431f60=a41_0x3418;if(_0x5346d9&&_0x5346d9[_0x431f60(0x11c)])return _0x5346d9;var _0x1afe32={};if(_0x5346d9!=null){for(var _0x5675d4=_0x36bb24(_0x5346d9),_0x4ce0b2=0x0;_0x4ce0b2<_0x5675d4[_0x431f60(0x105)];_0x4ce0b2++)if(_0x5675d4[_0x4ce0b2]!==_0x431f60(0x134))__createBinding(_0x1afe32,_0x5346d9,_0x5675d4[_0x4ce0b2]);}return __setModuleDefault(_0x1afe32,_0x5346d9),_0x1afe32;};}());Object[a41_0x397716(0xe3)](exports,a41_0x397716(0x11c),{'value':!![]}),exports['KlymeService']=void 0x0;function a41_0x5a1b(){const _0x1ecbb2=['length','error','payment_id','call','HTTP\x20Status:','statusCode','order_id','Error\x20Message:','\x20payment:\x20','transaction_id','now','/verify/','__createBinding','Failed\x20to\x20parse\x20JSON\x20response:','timeout','Processing\x20KLYME\x20webhook:','1398JZAyuU','URL:','===\x20KLYME\x20','51947LQzqrP','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','\x20API\x20BUSINESS\x20ERROR\x20===','8436985gqXtsX','__esModule','amount','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','Business\x20Error:\x20','Failed\x20to\x20create\x20KLYME\x20','payment_method','\x20validated)','KlymeService','Region\x20(geo):','getOwnPropertyDescriptor','successful','===\x20PARSED\x20KLYME\x20','\x20SERVICE\x20ERROR\x20===','resolve','../loggerService','Currency:','random','parse','success','541944QOaNye','10CvjVrp','2107CFFKHn','\x20(8digits-8digits\x20format\x20for\x20','\x20payment\x20link:\x20','default','rejected','HTTP\x20error!\x20status:\x20','Redirect\x20URL:','\x20RESPONSE\x20===','/create','getOwnPropertyNames','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','18090477fEHusE','\x20API:\x20missing\x20payment\x20data','created','create',',\x20body:\x20','text','\x20currency\x20validation\x20passed:\x20','\x20API','log','toUpperCase','stringify','logWhiteDomainRequest','entries','get','padStart','\x20API:\x20','HTTP\x20','Failed\x20to\x20verify\x20KLYME\x20','5003488MLopgt','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','https://tesoft.uk/gateway/pending.php?id=','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','Raw\x20Response\x20Body:','failed','\x20API\x20error:\x20','writable','configurable','pending','klyme_','Response\x20Time:','uuid','Parsed\x20Result:','statusText','Unknown\x20error\x20from\x20KLYME\x20','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','prototype','Currency\x20Used:','TesSoft\x20Payment\x20System/1.0','validateCurrencyForRegion','then','GBP','(8digits-8digits\x20format)','processing','Status\x20Code:','\x20API\x20ERROR\x20===','Invalid\x20response\x20from\x20KLYME\x20','toLowerCase','\x20SUCCESS\x20(New\x20Format)\x20===','logWhiteDomainError','toString','stack','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','completed','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','EXPIRED','json','78BLvCkV','Headers:','\x20payment\x20verification\x20error:','authUrl','Error\x20stack:','processWebhook','message','Unknown\x20error','Unsupported\x20KLYME\x20region:\x20','KLYME\x20','redirect_url','payment','üí≥\x20KLYME\x20','reference','defineProperty','../../config/database','__importStar','__setModuleDefault','Error\x20details:','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','JSON\x20Parse\x20Error:\x20','\x20SUCCESS\x20(Legacy\x20Format)\x20===','createPaymentLink','active','logWhiteDomainResponse','4984816XCyhxI','application/json','status','apiUrl','FAILED','Response\x20Body:','PENDING','Reference\x20Used:','loggerService','Reference:','Geo\x20Parameter:','in_progress','EUR','POST','Response\x20data:','generateUniqueReference','fromEntries','Request\x20Body:','(validated\x20for\x20','cancelled','expired','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','currency'];a41_0x5a1b=function(){return _0x1ecbb2;};return a41_0x5a1b();}const loggerService_1=require(a41_0x397716(0x12a));class KlymeService{constructor(){this['apiUrl']='https://tesoft.uk/gateway/klyme/',console['log']('üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions');}['validateCurrencyForRegion'](_0x5abf7f,_0x49eab6){const _0x12338f=a41_0x397716,_0xd580d0=_0x5abf7f[_0x12338f(0x145)]();switch(_0x49eab6){case'EU':if(_0xd580d0!==_0x12338f(0xfa))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0xd580d0);break;case'GB':if(_0xd580d0!==_0x12338f(0xc5))throw new Error(_0x12338f(0xd2)+_0xd580d0);break;case'DE':if(_0xd580d0!==_0x12338f(0xfa))throw new Error(_0x12338f(0x15e)+_0xd580d0);break;default:throw new Error(_0x12338f(0xdd)+_0x49eab6);}}async[a41_0x397716(0xfd)](){const _0x593d04=a41_0x397716,_0x292594=(await Promise[_0x593d04(0x129)]()[_0x593d04(0xc4)](()=>__importStar(require(_0x593d04(0xe4)))))['default'];let _0x1ec9a3,_0x55f96a=0x0;const _0x2c0861=0xa;do{const _0x400214=()=>{const _0x3aeb3e=_0x593d04;return Math['floor'](Math[_0x3aeb3e(0x12c)]()*0x5f5e100)[_0x3aeb3e(0xce)]()[_0x3aeb3e(0x14a)](0x8,'0');};_0x1ec9a3=_0x400214()+'-'+_0x400214();const _0x503fb8=await _0x292594[_0x593d04(0xe0)]['findFirst']({'where':{'gatewayOrderId':_0x1ec9a3}});if(!_0x503fb8)break;_0x55f96a++,console[_0x593d04(0x144)]('‚ö†Ô∏è\x20KLYME\x20reference\x20'+_0x1ec9a3+_0x593d04(0x151)+_0x55f96a+')');}while(_0x55f96a<_0x2c0861);if(_0x55f96a>=_0x2c0861)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x1ec9a3;}async[a41_0x397716(0xeb)](_0x1dcb1b){const _0x2939e4=a41_0x397716,{orderId:_0x3beb48,amount:_0x588081,currency:_0x27312b,region:_0x54672c}=_0x1dcb1b;if(_0x54672c!=='EU'&&_0x54672c!=='GB'&&_0x54672c!=='DE')throw new Error(_0x2939e4(0x11e)+_0x54672c);this[_0x2939e4(0xc3)](_0x27312b,_0x54672c);const _0x3d826b=_0x27312b[_0x2939e4(0x145)]();console[_0x2939e4(0x144)](_0x2939e4(0xe1)+_0x54672c+_0x2939e4(0x142)+_0x3d826b);const _0xcc19d8=await this[_0x2939e4(0xfd)]();console['log'](_0x2939e4(0x119)+_0xcc19d8+_0x2939e4(0x132)+_0x54672c+')');const _0x2565de=_0x2939e4(0x150)+_0x3beb48,_0x1565d0={'amount':_0x588081,'currency':_0x3d826b,'redirectUrl':_0x2565de,'reference':_0xcc19d8,'geo':_0x54672c},_0x2dcbbf=Date[_0x2939e4(0x10f)]();try{console[_0x2939e4(0x144)](_0x2939e4(0x117)+_0x54672c+'\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20==='),console[_0x2939e4(0x144)](_0x2939e4(0x116),this[_0x2939e4(0xf1)]),console[_0x2939e4(0x144)](_0x2939e4(0xff),JSON[_0x2939e4(0x146)](_0x1565d0,null,0x2)),console[_0x2939e4(0x144)](_0x2939e4(0x124),_0x54672c),console['log'](_0x2939e4(0x12b),_0x3d826b,_0x2939e4(0x100)+_0x54672c+')'),console[_0x2939e4(0x144)](_0x2939e4(0xf7),_0xcc19d8,_0x2939e4(0xc6)),console[_0x2939e4(0x144)](_0x2939e4(0x137),_0x2565de),loggerService_1['loggerService'][_0x2939e4(0x147)]('klyme_'+_0x54672c[_0x2939e4(0xcb)](),'/create',_0x2939e4(0xfb),_0x1565d0);const _0x1eb03f=await fetch(this[_0x2939e4(0xf1)],{'method':_0x2939e4(0xfb),'headers':{'Content-Type':_0x2939e4(0xef),'Accept':_0x2939e4(0xef),'User-Agent':_0x2939e4(0xc2)},'body':JSON[_0x2939e4(0x146)](_0x1565d0)}),_0x43a5ef=Date['now']()-_0x2dcbbf;console[_0x2939e4(0x144)](_0x2939e4(0x117)+_0x54672c+_0x2939e4(0xd0)),console['log']('Status:',_0x1eb03f[_0x2939e4(0xf0)]),console[_0x2939e4(0x144)]('Status\x20Text:',_0x1eb03f[_0x2939e4(0x15c)]),console[_0x2939e4(0x144)](_0x2939e4(0xd6),Object[_0x2939e4(0xfe)](_0x1eb03f['headers'][_0x2939e4(0x148)]())),console[_0x2939e4(0x144)](_0x2939e4(0x159),_0x43a5ef+'ms');const _0x3c489a=await _0x1eb03f['text']();console['log'](_0x2939e4(0x152),_0x3c489a);if(!_0x1eb03f['ok']){console[_0x2939e4(0x106)](_0x2939e4(0x117)+_0x54672c+_0x2939e4(0xc9)),console['error'](_0x2939e4(0x109),_0x1eb03f[_0x2939e4(0xf0)]),console[_0x2939e4(0x106)](_0x2939e4(0xf3),_0x3c489a),loggerService_1[_0x2939e4(0xf6)][_0x2939e4(0xed)]('klyme_'+_0x54672c[_0x2939e4(0xcb)](),'/create',_0x1eb03f[_0x2939e4(0xf0)],_0x3c489a,_0x43a5ef),loggerService_1[_0x2939e4(0xf6)][_0x2939e4(0xcd)]('klyme_'+_0x54672c[_0x2939e4(0xcb)](),_0x2939e4(0x139),_0x2939e4(0x14c)+_0x1eb03f[_0x2939e4(0xf0)]+':\x20'+_0x3c489a);throw new Error(_0x2939e4(0x136)+_0x1eb03f['status']+_0x2939e4(0x140)+_0x3c489a);}let _0x39360d;try{_0x39360d=JSON[_0x2939e4(0x12d)](_0x3c489a);}catch(_0xf6db98){console[_0x2939e4(0x106)](_0x2939e4(0x112),_0xf6db98),loggerService_1[_0x2939e4(0xf6)][_0x2939e4(0xcd)](_0x2939e4(0x158)+_0x54672c[_0x2939e4(0xcb)](),_0x2939e4(0x139),_0x2939e4(0xe9)+_0xf6db98);throw new Error(_0x2939e4(0x14f)+_0x54672c+_0x2939e4(0x14b)+_0x3c489a);}console['log'](_0x2939e4(0x127)+_0x54672c+_0x2939e4(0x138)),console[_0x2939e4(0x144)](_0x2939e4(0x15b),JSON[_0x2939e4(0x146)](_0x39360d,null,0x2)),loggerService_1[_0x2939e4(0xf6)][_0x2939e4(0xed)](_0x2939e4(0x158)+_0x54672c[_0x2939e4(0xcb)](),'/create',_0x1eb03f['status'],_0x39360d,_0x43a5ef);if(_0x39360d[_0x2939e4(0x106)]||_0x39360d[_0x2939e4(0x10a)]){const _0x262a1c=_0x39360d['message']||_0x39360d[_0x2939e4(0x106)]||_0x2939e4(0x15d)+_0x54672c+_0x2939e4(0x143);console[_0x2939e4(0x106)](_0x2939e4(0x117)+_0x54672c+_0x2939e4(0x11a)),console[_0x2939e4(0x106)](_0x2939e4(0x10c),_0x262a1c),console['error'](_0x2939e4(0xc8),_0x39360d[_0x2939e4(0x10a)]),loggerService_1[_0x2939e4(0xf6)]['logWhiteDomainError'](_0x2939e4(0x158)+_0x54672c[_0x2939e4(0xcb)](),_0x2939e4(0x139),_0x2939e4(0x11f)+_0x262a1c);throw new Error(_0x2939e4(0xde)+_0x54672c+'\x20API\x20error:\x20'+_0x262a1c);}let _0x5b2f39,_0x66679c;if(_0x39360d[_0x2939e4(0x15a)]&&_0x39360d['redirect_url'])_0x5b2f39=_0x39360d['uuid'],_0x66679c=_0x39360d[_0x2939e4(0xdf)],console[_0x2939e4(0x144)](_0x2939e4(0x117)+_0x54672c+_0x2939e4(0xcc)),console[_0x2939e4(0x144)]('UUID:',_0x39360d[_0x2939e4(0x15a)]),console[_0x2939e4(0x144)](_0x2939e4(0x137),_0x39360d[_0x2939e4(0xdf)]);else{if(_0x39360d[_0x2939e4(0xd8)])_0x5b2f39=_0xcc19d8,_0x66679c=_0x39360d['authUrl'],console[_0x2939e4(0x144)]('===\x20KLYME\x20'+_0x54672c+_0x2939e4(0xea)),console[_0x2939e4(0x144)]('Auth\x20URL:',_0x39360d[_0x2939e4(0xd8)]),console[_0x2939e4(0x144)]('Reference\x20Used\x20as\x20ID:',_0xcc19d8);else{console['error'](_0x2939e4(0x117)+_0x54672c+_0x2939e4(0x13b)),console['error'](_0x2939e4(0xe8)),console['error'](_0x2939e4(0xfc),_0x39360d),loggerService_1[_0x2939e4(0xf6)]['logWhiteDomainError'](_0x2939e4(0x158)+_0x54672c[_0x2939e4(0xcb)](),_0x2939e4(0x139),_0x2939e4(0x103));throw new Error(_0x2939e4(0xca)+_0x54672c+_0x2939e4(0x13d));}}return console[_0x2939e4(0x144)](_0x2939e4(0x160),_0x3d826b,'('+_0x54672c+_0x2939e4(0x122)),console[_0x2939e4(0x144)](_0x2939e4(0xf5),_0xcc19d8,_0x2939e4(0xc6)),console['log'](_0x2939e4(0xf8),_0x54672c),{'gateway_payment_id':_0x5b2f39,'payment_url':_0x66679c};}catch(_0x44b434){console[_0x2939e4(0x106)](_0x2939e4(0x117)+_0x54672c+_0x2939e4(0x128)),console[_0x2939e4(0x106)](_0x2939e4(0xe7),_0x44b434),loggerService_1[_0x2939e4(0xf6)][_0x2939e4(0xcd)](_0x2939e4(0x158)+_0x54672c[_0x2939e4(0xcb)](),_0x2939e4(0x139),_0x44b434);if(_0x44b434 instanceof Error){console[_0x2939e4(0x106)]('Error\x20message:',_0x44b434['message']),console[_0x2939e4(0x106)](_0x2939e4(0xd9),_0x44b434[_0x2939e4(0xcf)]);throw new Error(_0x2939e4(0x120)+_0x54672c+_0x2939e4(0x133)+_0x44b434[_0x2939e4(0xdb)]);}throw new Error(_0x2939e4(0x120)+_0x54672c+'\x20payment\x20link:\x20Unknown\x20error');}}async['verifyPayment'](_0x131d93,_0x139ae2){const _0x2f196f=a41_0x397716,_0x1369c3=Date['now']();try{const _0xec22dd={'gatewayPaymentId':_0x131d93,'geo':_0x139ae2};loggerService_1[_0x2f196f(0xf6)][_0x2f196f(0x147)](_0x2f196f(0x158)+_0x139ae2['toLowerCase'](),_0x2f196f(0x110)+_0x131d93,_0x2f196f(0xfb),_0xec22dd);const _0x63edf0=await fetch(this[_0x2f196f(0xf1)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x2f196f(0xc2)},'body':JSON[_0x2f196f(0x146)](_0xec22dd)}),_0x58d57e=Date['now']()-_0x1369c3;if(!_0x63edf0['ok']){const _0x3e3a9d=await _0x63edf0[_0x2f196f(0x141)]();loggerService_1[_0x2f196f(0xf6)][_0x2f196f(0xed)]('klyme_'+_0x139ae2['toLowerCase'](),_0x2f196f(0x110)+_0x131d93,_0x63edf0['status'],_0x3e3a9d,_0x58d57e);throw new Error(_0x2f196f(0x136)+_0x63edf0[_0x2f196f(0xf0)]);}const _0xf4932=await _0x63edf0[_0x2f196f(0xd4)]();loggerService_1['loggerService'][_0x2f196f(0xed)](_0x2f196f(0x158)+_0x139ae2[_0x2f196f(0xcb)](),_0x2f196f(0x110)+_0x131d93,_0x63edf0['status'],_0xf4932,_0x58d57e);if(_0xf4932['error']||_0xf4932['statusCode']){loggerService_1[_0x2f196f(0xf6)]['logWhiteDomainError'](_0x2f196f(0x158)+_0x139ae2['toLowerCase'](),_0x2f196f(0x110)+_0x131d93,_0x2f196f(0xde)+_0x139ae2+_0x2f196f(0x154)+(_0xf4932[_0x2f196f(0xdb)]||_0xf4932[_0x2f196f(0x106)]||'Unknown\x20error'));throw new Error(_0x2f196f(0xde)+_0x139ae2+_0x2f196f(0x154)+(_0xf4932[_0x2f196f(0xdb)]||_0xf4932[_0x2f196f(0x106)]||'Unknown\x20error'));}let _0x1b950d=_0x2f196f(0xf4);return{'status':_0x1b950d};}catch(_0x118c7a){console['error'](_0x2f196f(0xde)+_0x139ae2+_0x2f196f(0xd7),_0x118c7a),loggerService_1[_0x2f196f(0xf6)]['logWhiteDomainError'](_0x2f196f(0x158)+_0x139ae2[_0x2f196f(0xcb)](),_0x2f196f(0x110)+_0x131d93,_0x118c7a);throw new Error(_0x2f196f(0x14d)+_0x139ae2+_0x2f196f(0x10d)+(_0x118c7a instanceof Error?_0x118c7a[_0x2f196f(0xdb)]:_0x2f196f(0xdc)));}}async[a41_0x397716(0xda)](_0x1f3559){const _0x21293d=a41_0x397716;console[_0x21293d(0x144)](_0x21293d(0x114),_0x1f3559);let _0x2cc73e=_0x21293d(0xf4);switch(_0x1f3559['status']?.[_0x21293d(0xcb)]()){case'paid':case _0x21293d(0xd1):case'confirmed':case _0x21293d(0x12e):case _0x21293d(0x126):_0x2cc73e='PAID';break;case _0x21293d(0x101):case'canceled':case _0x21293d(0x153):case'error':case _0x21293d(0x135):_0x2cc73e=_0x21293d(0xf2);break;case _0x21293d(0x102):case _0x21293d(0x113):_0x2cc73e=_0x21293d(0xd3);break;case _0x21293d(0x157):case _0x21293d(0x13e):case _0x21293d(0xec):case _0x21293d(0xc7):case _0x21293d(0xf9):default:_0x2cc73e=_0x21293d(0xf4);break;}return{'paymentId':_0x1f3559[_0x21293d(0xe2)]||_0x1f3559[_0x21293d(0x10b)]||_0x1f3559[_0x21293d(0x107)],'status':_0x2cc73e,'amount':_0x1f3559[_0x21293d(0x11d)],'currency':_0x1f3559[_0x21293d(0x104)],'region':_0x1f3559['region'],'additionalInfo':{'payment_method':_0x1f3559[_0x21293d(0x121)],'transaction_id':_0x1f3559[_0x21293d(0x10e)]}};}}function a41_0x3418(_0xd89566,_0x577b62){const _0x5a1bbc=a41_0x5a1b();return a41_0x3418=function(_0x341886,_0x4a2f6d){_0x341886=_0x341886-0xc2;let _0x114a26=_0x5a1bbc[_0x341886];return _0x114a26;},a41_0x3418(_0xd89566,_0x577b62);}exports[a41_0x397716(0x123)]=KlymeService;