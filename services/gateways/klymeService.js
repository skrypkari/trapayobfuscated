'use strict';const a39_0x99fab2=a39_0x3c21;(function(_0x111fbb,_0x19399b){const _0x514318=a39_0x3c21,_0x25384d=_0x111fbb();while(!![]){try{const _0x3a37fa=-parseInt(_0x514318(0x1a3))/0x1+parseInt(_0x514318(0x126))/0x2*(parseInt(_0x514318(0x197))/0x3)+-parseInt(_0x514318(0x155))/0x4+-parseInt(_0x514318(0x19d))/0x5+parseInt(_0x514318(0x1a4))/0x6+parseInt(_0x514318(0x158))/0x7*(parseInt(_0x514318(0x14b))/0x8)+parseInt(_0x514318(0x174))/0x9*(parseInt(_0x514318(0x18c))/0xa);if(_0x3a37fa===_0x19399b)break;else _0x25384d['push'](_0x25384d['shift']());}catch(_0xf63e02){_0x25384d['push'](_0x25384d['shift']());}}}(a39_0x2027,0x2e762));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x19cf68,_0x3a1009,_0x51d523,_0x12ecd6){const _0x3410c4=a39_0x3c21;if(_0x12ecd6===undefined)_0x12ecd6=_0x51d523;var _0x5b385a=Object[_0x3410c4(0x163)](_0x3a1009,_0x51d523);(!_0x5b385a||(_0x3410c4(0x142)in _0x5b385a?!_0x3a1009['__esModule']:_0x5b385a[_0x3410c4(0x17e)]||_0x5b385a[_0x3410c4(0x171)]))&&(_0x5b385a={'enumerable':!![],'get':function(){return _0x3a1009[_0x51d523];}}),Object[_0x3410c4(0x190)](_0x19cf68,_0x12ecd6,_0x5b385a);}:function(_0x23fdd9,_0x5319da,_0x2b9d19,_0x3aa38c){if(_0x3aa38c===undefined)_0x3aa38c=_0x2b9d19;_0x23fdd9[_0x3aa38c]=_0x5319da[_0x2b9d19];}),__setModuleDefault=this&&this[a39_0x99fab2(0x13b)]||(Object['create']?function(_0x47cbb2,_0x2de8eb){const _0x505c8a=a39_0x99fab2;Object[_0x505c8a(0x190)](_0x47cbb2,_0x505c8a(0x136),{'enumerable':!![],'value':_0x2de8eb});}:function(_0x10bb76,_0x57aefb){const _0x45301c=a39_0x99fab2;_0x10bb76[_0x45301c(0x136)]=_0x57aefb;}),__importStar=this&&this['__importStar']||(function(){var _0x38291e=function(_0x4ce950){const _0x460c74=a39_0x3c21;return _0x38291e=Object[_0x460c74(0x148)]||function(_0x4ad9b2){const _0x238dd1=_0x460c74;var _0x55a269=[];for(var _0x54c608 in _0x4ad9b2)if(Object[_0x238dd1(0x132)][_0x238dd1(0x161)][_0x238dd1(0x184)](_0x4ad9b2,_0x54c608))_0x55a269[_0x55a269[_0x238dd1(0x178)]]=_0x54c608;return _0x55a269;},_0x38291e(_0x4ce950);};return function(_0x423aeb){const _0x270b6c=a39_0x3c21;if(_0x423aeb&&_0x423aeb[_0x270b6c(0x144)])return _0x423aeb;var _0x5f1475={};if(_0x423aeb!=null){for(var _0x166e71=_0x38291e(_0x423aeb),_0x3b2208=0x0;_0x3b2208<_0x166e71[_0x270b6c(0x178)];_0x3b2208++)if(_0x166e71[_0x3b2208]!==_0x270b6c(0x136))__createBinding(_0x5f1475,_0x423aeb,_0x166e71[_0x3b2208]);}return __setModuleDefault(_0x5f1475,_0x423aeb),_0x5f1475;};}());function a39_0x3c21(_0x54e2c3,_0x1c387f){const _0x20271b=a39_0x2027();return a39_0x3c21=function(_0x3c21c8,_0x534c62){_0x3c21c8=_0x3c21c8-0x118;let _0x231f32=_0x20271b[_0x3c21c8];return _0x231f32;},a39_0x3c21(_0x54e2c3,_0x1c387f);}Object[a39_0x99fab2(0x190)](exports,a39_0x99fab2(0x144),{'value':!![]}),exports['KlymeService']=void 0x0;const loggerService_1=require(a39_0x99fab2(0x141));class KlymeService{constructor(){const _0x2a887b=a39_0x99fab2;this[_0x2a887b(0x15d)]=_0x2a887b(0x1a9),console[_0x2a887b(0x167)]('üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions');}[a39_0x99fab2(0x18b)](_0x2a4e0f,_0x1508a9){const _0x4146e0=a39_0x99fab2,_0x3f00b2=_0x2a4e0f['toUpperCase']();switch(_0x1508a9){case'EU':if(_0x3f00b2!==_0x4146e0(0x12a))throw new Error(_0x4146e0(0x19c)+_0x3f00b2);break;case'GB':if(_0x3f00b2!=='GBP')throw new Error(_0x4146e0(0x140)+_0x3f00b2);break;case'DE':if(_0x3f00b2!==_0x4146e0(0x12a))throw new Error(_0x4146e0(0x159)+_0x3f00b2);break;default:throw new Error(_0x4146e0(0x196)+_0x1508a9);}}async[a39_0x99fab2(0x13a)](){const _0x12611f=a39_0x99fab2,_0x5e344d=(await Promise[_0x12611f(0x198)]()['then'](()=>__importStar(require(_0x12611f(0x160)))))[_0x12611f(0x136)];let _0x56aa61,_0x36e436=0x0;const _0x310bc1=0xa;do{const _0x2884d3=()=>{const _0x4d57e2=_0x12611f;return Math[_0x4d57e2(0x181)](Math[_0x4d57e2(0x183)]()*0x5f5e100)[_0x4d57e2(0x14a)]()[_0x4d57e2(0x180)](0x8,'0');};_0x56aa61=_0x2884d3()+'-'+_0x2884d3();const _0x5daa8a=await _0x5e344d[_0x12611f(0x143)][_0x12611f(0x120)]({'where':{'gatewayOrderId':_0x56aa61}});if(!_0x5daa8a)break;_0x36e436++,console['log'](_0x12611f(0x14d)+_0x56aa61+_0x12611f(0x16b)+_0x36e436+')');}while(_0x36e436<_0x310bc1);if(_0x36e436>=_0x310bc1)throw new Error(_0x12611f(0x173));return _0x56aa61;}async['createPaymentLink'](_0x140331){const _0x475b60=a39_0x99fab2,{orderId:_0x21f332,amount:_0x59d36d,currency:_0x8987c3,region:_0x3cc74b}=_0x140331;if(_0x3cc74b!=='EU'&&_0x3cc74b!=='GB'&&_0x3cc74b!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x3cc74b);this['validateCurrencyForRegion'](_0x8987c3,_0x3cc74b);const _0x5af6ad=_0x8987c3[_0x475b60(0x15e)]();console[_0x475b60(0x167)]('üí≥\x20KLYME\x20'+_0x3cc74b+'\x20currency\x20validation\x20passed:\x20'+_0x5af6ad);const _0x4ea315=await this[_0x475b60(0x13a)]();console[_0x475b60(0x167)]('üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20'+_0x4ea315+'\x20(8digits-8digits\x20format\x20for\x20'+_0x3cc74b+')');const _0x1de2f9='https://tesoft.uk/gateway/pending.php?id='+_0x21f332,_0x28fc0c={'amount':_0x59d36d,'currency':_0x5af6ad,'redirectUrl':_0x1de2f9,'reference':_0x4ea315,'geo':_0x3cc74b},_0x3a3d1f=Date[_0x475b60(0x139)]();try{console['log'](_0x475b60(0x192)+_0x3cc74b+_0x475b60(0x13d)),console[_0x475b60(0x167)](_0x475b60(0x177),this[_0x475b60(0x15d)]),console[_0x475b60(0x167)](_0x475b60(0x182),JSON[_0x475b60(0x195)](_0x28fc0c,null,0x2)),console[_0x475b60(0x167)](_0x475b60(0x170),_0x3cc74b),console['log']('Currency:',_0x5af6ad,'(validated\x20for\x20'+_0x3cc74b+')'),console[_0x475b60(0x167)](_0x475b60(0x147),_0x4ea315,'(8digits-8digits\x20format)'),console[_0x475b60(0x167)](_0x475b60(0x1a0),_0x1de2f9),loggerService_1[_0x475b60(0x11a)][_0x475b60(0x15a)](_0x475b60(0x145)+_0x3cc74b[_0x475b60(0x118)](),'/create',_0x475b60(0x12e),_0x28fc0c);const _0x275ca5=await fetch(this['apiUrl'],{'method':'POST','headers':{'Content-Type':_0x475b60(0x16d),'Accept':_0x475b60(0x16d),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x475b60(0x195)](_0x28fc0c)}),_0x170915=Date[_0x475b60(0x139)]()-_0x3a3d1f;console[_0x475b60(0x167)]('===\x20KLYME\x20'+_0x3cc74b+'\x20API\x20RESPONSE\x20(Unified\x20Route)\x20==='),console[_0x475b60(0x167)]('Status:',_0x275ca5[_0x475b60(0x12d)]),console[_0x475b60(0x167)](_0x475b60(0x133),_0x275ca5[_0x475b60(0x16e)]),console[_0x475b60(0x167)](_0x475b60(0x199),Object['fromEntries'](_0x275ca5['headers']['entries']())),console['log']('Response\x20Time:',_0x170915+'ms');const _0x143c4c=await _0x275ca5[_0x475b60(0x172)]();console[_0x475b60(0x167)](_0x475b60(0x179),_0x143c4c);if(!_0x275ca5['ok']){console[_0x475b60(0x1a6)](_0x475b60(0x192)+_0x3cc74b+_0x475b60(0x128)),console['error'](_0x475b60(0x162),_0x275ca5[_0x475b60(0x12d)]),console[_0x475b60(0x1a6)](_0x475b60(0x164),_0x143c4c),loggerService_1[_0x475b60(0x11a)][_0x475b60(0x1a1)](_0x475b60(0x145)+_0x3cc74b[_0x475b60(0x118)](),_0x475b60(0x165),_0x275ca5[_0x475b60(0x12d)],_0x143c4c,_0x170915),loggerService_1[_0x475b60(0x11a)][_0x475b60(0x18e)](_0x475b60(0x145)+_0x3cc74b[_0x475b60(0x118)](),'/create',_0x475b60(0x14e)+_0x275ca5[_0x475b60(0x12d)]+':\x20'+_0x143c4c);throw new Error(_0x475b60(0x124)+_0x275ca5[_0x475b60(0x12d)]+_0x475b60(0x176)+_0x143c4c);}let _0x2f0969;try{_0x2f0969=JSON[_0x475b60(0x19b)](_0x143c4c);}catch(_0x3acf31){console[_0x475b60(0x1a6)](_0x475b60(0x153),_0x3acf31),loggerService_1[_0x475b60(0x11a)][_0x475b60(0x18e)](_0x475b60(0x145)+_0x3cc74b[_0x475b60(0x118)](),'/create',_0x475b60(0x11c)+_0x3acf31);throw new Error(_0x475b60(0x11f)+_0x3cc74b+_0x475b60(0x11b)+_0x143c4c);}console[_0x475b60(0x167)]('===\x20PARSED\x20KLYME\x20'+_0x3cc74b+_0x475b60(0x17c)),console['log'](_0x475b60(0x191),JSON[_0x475b60(0x195)](_0x2f0969,null,0x2)),loggerService_1[_0x475b60(0x11a)][_0x475b60(0x1a1)](_0x475b60(0x145)+_0x3cc74b['toLowerCase'](),_0x475b60(0x165),_0x275ca5[_0x475b60(0x12d)],_0x2f0969,_0x170915);if(_0x2f0969[_0x475b60(0x1a6)]||_0x2f0969[_0x475b60(0x16f)]){const _0x2bb41c=_0x2f0969[_0x475b60(0x187)]||_0x2f0969[_0x475b60(0x1a6)]||'Unknown\x20error\x20from\x20KLYME\x20'+_0x3cc74b+_0x475b60(0x119);console[_0x475b60(0x1a6)](_0x475b60(0x192)+_0x3cc74b+'\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x475b60(0x1a6)]('Error\x20Message:',_0x2bb41c),console[_0x475b60(0x1a6)](_0x475b60(0x15b),_0x2f0969['statusCode']),loggerService_1[_0x475b60(0x11a)]['logWhiteDomainError'](_0x475b60(0x145)+_0x3cc74b[_0x475b60(0x118)](),_0x475b60(0x165),_0x475b60(0x169)+_0x2bb41c);throw new Error(_0x475b60(0x168)+_0x3cc74b+_0x475b60(0x15c)+_0x2bb41c);}let _0x585617,_0x165338;if(_0x2f0969[_0x475b60(0x17f)]&&_0x2f0969[_0x475b60(0x1a5)])_0x585617=_0x2f0969[_0x475b60(0x17f)],_0x165338=_0x2f0969[_0x475b60(0x1a5)],console[_0x475b60(0x167)]('===\x20KLYME\x20'+_0x3cc74b+_0x475b60(0x186)),console[_0x475b60(0x167)](_0x475b60(0x12c),_0x2f0969['uuid']),console['log'](_0x475b60(0x1a0),_0x2f0969[_0x475b60(0x1a5)]);else{if(_0x2f0969['authUrl'])_0x585617=_0x4ea315,_0x165338=_0x2f0969[_0x475b60(0x151)],console['log']('===\x20KLYME\x20'+_0x3cc74b+_0x475b60(0x16a)),console[_0x475b60(0x167)](_0x475b60(0x138),_0x2f0969[_0x475b60(0x151)]),console[_0x475b60(0x167)](_0x475b60(0x19a),_0x4ea315);else{console[_0x475b60(0x1a6)]('===\x20KLYME\x20'+_0x3cc74b+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x475b60(0x1a6)](_0x475b60(0x149)),console[_0x475b60(0x1a6)](_0x475b60(0x150),_0x2f0969),loggerService_1['loggerService'][_0x475b60(0x18e)](_0x475b60(0x145)+_0x3cc74b[_0x475b60(0x118)](),_0x475b60(0x165),_0x475b60(0x121));throw new Error(_0x475b60(0x18f)+_0x3cc74b+_0x475b60(0x17b));}}return console[_0x475b60(0x167)](_0x475b60(0x1a7),_0x5af6ad,'('+_0x3cc74b+_0x475b60(0x1a2)),console['log'](_0x475b60(0x134),_0x4ea315,_0x475b60(0x1a8)),console['log'](_0x475b60(0x146),_0x3cc74b),{'gateway_payment_id':_0x585617,'payment_url':_0x165338};}catch(_0x13ee9f){console[_0x475b60(0x1a6)]('===\x20KLYME\x20'+_0x3cc74b+_0x475b60(0x13c)),console[_0x475b60(0x1a6)](_0x475b60(0x129),_0x13ee9f),loggerService_1[_0x475b60(0x11a)][_0x475b60(0x18e)]('klyme_'+_0x3cc74b[_0x475b60(0x118)](),_0x475b60(0x165),_0x13ee9f);if(_0x13ee9f instanceof Error){console['error'](_0x475b60(0x17a),_0x13ee9f[_0x475b60(0x187)]),console[_0x475b60(0x1a6)](_0x475b60(0x122),_0x13ee9f['stack']);throw new Error(_0x475b60(0x130)+_0x3cc74b+_0x475b60(0x125)+_0x13ee9f[_0x475b60(0x187)]);}throw new Error(_0x475b60(0x130)+_0x3cc74b+_0x475b60(0x16c));}}async['verifyPayment'](_0x15379f,_0x22c6c5){const _0x397df2=a39_0x99fab2,_0x19a0ff=Date['now']();try{const _0x4699f9={'gatewayPaymentId':_0x15379f,'geo':_0x22c6c5};loggerService_1[_0x397df2(0x11a)][_0x397df2(0x15a)](_0x397df2(0x145)+_0x22c6c5[_0x397df2(0x118)](),_0x397df2(0x156)+_0x15379f,'POST',_0x4699f9);const _0x2defee=await fetch(this[_0x397df2(0x15d)],{'method':_0x397df2(0x12e),'headers':{'Content-Type':_0x397df2(0x16d),'User-Agent':_0x397df2(0x137)},'body':JSON[_0x397df2(0x195)](_0x4699f9)}),_0x30cf5f=Date[_0x397df2(0x139)]()-_0x19a0ff;if(!_0x2defee['ok']){const _0x33b939=await _0x2defee['text']();loggerService_1[_0x397df2(0x11a)][_0x397df2(0x1a1)](_0x397df2(0x145)+_0x22c6c5['toLowerCase'](),_0x397df2(0x156)+_0x15379f,_0x2defee[_0x397df2(0x12d)],_0x33b939,_0x30cf5f);throw new Error('HTTP\x20error!\x20status:\x20'+_0x2defee['status']);}const _0x1d568e=await _0x2defee[_0x397df2(0x13e)]();loggerService_1['loggerService'][_0x397df2(0x1a1)](_0x397df2(0x145)+_0x22c6c5[_0x397df2(0x118)](),'/verify/'+_0x15379f,_0x2defee[_0x397df2(0x12d)],_0x1d568e,_0x30cf5f);if(_0x1d568e[_0x397df2(0x1a6)]||_0x1d568e[_0x397df2(0x16f)]){loggerService_1[_0x397df2(0x11a)][_0x397df2(0x18e)](_0x397df2(0x145)+_0x22c6c5[_0x397df2(0x118)](),_0x397df2(0x156)+_0x15379f,'KLYME\x20'+_0x22c6c5+'\x20API\x20error:\x20'+(_0x1d568e[_0x397df2(0x187)]||_0x1d568e[_0x397df2(0x1a6)]||_0x397df2(0x127)));throw new Error(_0x397df2(0x168)+_0x22c6c5+_0x397df2(0x15c)+(_0x1d568e[_0x397df2(0x187)]||_0x1d568e[_0x397df2(0x1a6)]||_0x397df2(0x127)));}let _0x2479bc=_0x397df2(0x185);return{'status':_0x2479bc};}catch(_0x39c745){console[_0x397df2(0x1a6)](_0x397df2(0x168)+_0x22c6c5+_0x397df2(0x188),_0x39c745),loggerService_1[_0x397df2(0x11a)][_0x397df2(0x18e)](_0x397df2(0x145)+_0x22c6c5[_0x397df2(0x118)](),_0x397df2(0x156)+_0x15379f,_0x39c745);throw new Error(_0x397df2(0x152)+_0x22c6c5+_0x397df2(0x12b)+(_0x39c745 instanceof Error?_0x39c745[_0x397df2(0x187)]:_0x397df2(0x127)));}}async[a39_0x99fab2(0x14f)](_0x2206d1){const _0x33fa6d=a39_0x99fab2;console[_0x33fa6d(0x167)](_0x33fa6d(0x17d),_0x2206d1);let _0x31c94a=_0x33fa6d(0x185);switch(_0x2206d1[_0x33fa6d(0x12d)]?.[_0x33fa6d(0x118)]()){case'paid':case _0x33fa6d(0x157):case _0x33fa6d(0x166):case _0x33fa6d(0x131):case _0x33fa6d(0x175):_0x31c94a='PAID';break;case _0x33fa6d(0x11d):case _0x33fa6d(0x18d):case'failed':case _0x33fa6d(0x1a6):case'rejected':_0x31c94a='FAILED';break;case _0x33fa6d(0x19e):case'timeout':_0x31c94a='EXPIRED';break;case _0x33fa6d(0x15f):case _0x33fa6d(0x12f):case _0x33fa6d(0x13f):case _0x33fa6d(0x194):case _0x33fa6d(0x18a):default:_0x31c94a='PENDING';break;}return{'paymentId':_0x2206d1[_0x33fa6d(0x135)]||_0x2206d1[_0x33fa6d(0x11e)]||_0x2206d1[_0x33fa6d(0x154)],'status':_0x31c94a,'amount':_0x2206d1[_0x33fa6d(0x189)],'currency':_0x2206d1['currency'],'region':_0x2206d1[_0x33fa6d(0x123)],'additionalInfo':{'payment_method':_0x2206d1[_0x33fa6d(0x19f)],'transaction_id':_0x2206d1[_0x33fa6d(0x14c)]}};}}function a39_0x2027(){const _0x352742=['JSON\x20Parse\x20Error:\x20','cancelled','order_id','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','findFirst','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','Error\x20stack:','region','HTTP\x20error!\x20status:\x20','\x20payment\x20link:\x20','4RDKBHv','Unknown\x20error','\x20API\x20ERROR\x20===','Error\x20details:','EUR','\x20payment:\x20','UUID:','status','POST','created','Failed\x20to\x20create\x20KLYME\x20','success','prototype','Status\x20Text:','Reference\x20Used:','reference','default','TesSoft\x20Payment\x20System/1.0','Auth\x20URL:','now','generateUniqueReference','__setModuleDefault','\x20SERVICE\x20ERROR\x20===','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','json','active','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','../loggerService','get','payment','__esModule','klyme_','Geo\x20Parameter:','Reference:','getOwnPropertyNames','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','toString','120zMdYxE','transaction_id','‚ö†Ô∏è\x20KLYME\x20reference\x20','HTTP\x20','processWebhook','Response\x20data:','authUrl','Failed\x20to\x20verify\x20KLYME\x20','Failed\x20to\x20parse\x20JSON\x20response:','payment_id','1100620IGrRhO','/verify/','completed','107632tAotzi','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','logWhiteDomainRequest','Status\x20Code:','\x20API\x20error:\x20','apiUrl','toUpperCase','pending','../../config/database','hasOwnProperty','HTTP\x20Status:','getOwnPropertyDescriptor','Response\x20Body:','/create','confirmed','log','KLYME\x20','Business\x20Error:\x20','\x20SUCCESS\x20(Legacy\x20Format)\x20===','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','\x20payment\x20link:\x20Unknown\x20error','application/json','statusText','statusCode','Region\x20(geo):','configurable','text','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','9hyELsp','successful',',\x20body:\x20','URL:','length','Raw\x20Response\x20Body:','Error\x20message:','\x20API:\x20missing\x20payment\x20data','\x20RESPONSE\x20===','Processing\x20KLYME\x20webhook:','writable','uuid','padStart','floor','Request\x20Body:','random','call','PENDING','\x20SUCCESS\x20(New\x20Format)\x20===','message','\x20payment\x20verification\x20error:','amount','in_progress','validateCurrencyForRegion','3061670dcrFDb','canceled','logWhiteDomainError','Invalid\x20response\x20from\x20KLYME\x20','defineProperty','Parsed\x20Result:','===\x20KLYME\x20','KlymeService','processing','stringify','Unsupported\x20KLYME\x20region:\x20','264513uTwEiE','resolve','Headers:','Reference\x20Used\x20as\x20ID:','parse','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','1125250aDOyPM','expired','payment_method','Redirect\x20URL:','logWhiteDomainResponse','\x20validated)','35812TsaCld','79044FfDhvE','redirect_url','error','Currency\x20Used:','(8digits-8digits\x20format)','https://tesoft.uk/gateway/klyme/','toLowerCase','\x20API','loggerService','\x20API:\x20'];a39_0x2027=function(){return _0x352742;};return a39_0x2027();}exports[a39_0x99fab2(0x193)]=KlymeService;