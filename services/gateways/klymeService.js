'use strict';const a67_0x3662f7=a67_0x34c4;(function(_0xdb3145,_0x126114){const _0x31ca66=a67_0x34c4,_0x56fe11=_0xdb3145();while(!![]){try{const _0x12848d=parseInt(_0x31ca66(0x1cd))/0x1*(-parseInt(_0x31ca66(0x19c))/0x2)+parseInt(_0x31ca66(0x187))/0x3+parseInt(_0x31ca66(0x1c8))/0x4+parseInt(_0x31ca66(0x17e))/0x5+-parseInt(_0x31ca66(0x1e1))/0x6+-parseInt(_0x31ca66(0x1a9))/0x7+parseInt(_0x31ca66(0x1de))/0x8;if(_0x12848d===_0x126114)break;else _0x56fe11['push'](_0x56fe11['shift']());}catch(_0x23a382){_0x56fe11['push'](_0x56fe11['shift']());}}}(a67_0x18d9,0xe6839));function a67_0x34c4(_0x4bb0f6,_0xb02971){_0x4bb0f6=_0x4bb0f6-0x154;const _0x18d93c=a67_0x18d9();let _0x34c436=_0x18d93c[_0x4bb0f6];return _0x34c436;}function a67_0x18d9(){const _0x276d17=['confirmed','Response\x20Body:','success','resolve','logWhiteDomainResponse','Error\x20message:','region','toString','7652055xZdBio','Reference\x20Used\x20as\x20ID:','successful','get','cancelled','\x20API:\x20missing\x20payment\x20data','active','create','application/json','2458851YtHsIX','Reference:','now','defineProperty','Reference\x20Used:','HTTP\x20Status:','Payment\x20System/1.0','configurable','paid','Request\x20Body:','text','KLYME\x20','Error\x20details:','\x20payment\x20link:\x20','length','loggerService','generateUniqueReference','getOwnPropertyNames','Geo\x20Parameter:','reference','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','1624594OaWMnk','__importStar','processing','timeout','status','Processing\x20KLYME\x20webhook:','JSON\x20Parse\x20Error:\x20','Failed\x20to\x20parse\x20JSON\x20response:','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','stringify','message','fromEntries','klyme_','10223535nTIvtp','PENDING','\x20currency\x20validation\x20passed:\x20','(8digits-8digits\x20format)','Response\x20data:','apiUrl','pending','entries','__esModule','expired','URL:','payment_id','\x20API:\x20','redirect_url','GBP','error','UUID:','HTTP\x20','\x20SUCCESS\x20(Legacy\x20Format)\x20===','parse','transaction_id','/create','__createBinding','Error\x20stack:','/verify/','Failed\x20to\x20create\x20KLYME\x20','Region\x20(geo):','canceled','toLowerCase','KlymeService','then','1378436RPOLMU','Headers:','stack','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','Auth\x20URL:','1gQRoNv','created','üí≥\x20KLYME\x20','\x20API\x20error:\x20','EUR','json','HTTP\x20error!\x20status:\x20','\x20API\x20ERROR\x20===','uuid','failed','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','in_progress','\x20SERVICE\x20ERROR\x20===','POST','toUpperCase','Status\x20Text:','validateCurrencyForRegion','8803120bPSsek','Failed\x20to\x20verify\x20KLYME\x20','default','3468240QqihjB','‚ö†Ô∏è\x20KLYME\x20reference\x20','logWhiteDomainRequest','===\x20PARSED\x20KLYME\x20','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','\x20(8digits-8digits\x20format\x20for\x20','statusText','order_id','\x20SUCCESS\x20(New\x20Format)\x20===','===\x20KLYME\x20','\x20RESPONSE\x20===','prototype','log','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','Invalid\x20response\x20from\x20KLYME\x20','\x20API','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','Unsupported\x20KLYME\x20region:\x20','https://tesoft.uk/gateway/klyme/',',\x20body:\x20','verifyPayment','Raw\x20Response\x20Body:','logWhiteDomainError','padStart','\x20payment\x20link:\x20Unknown\x20error','__setModuleDefault','completed','Unknown\x20error','statusCode','EXPIRED','payment_method','\x20validated)','Business\x20Error:\x20','floor','authUrl','processWebhook','rejected'];a67_0x18d9=function(){return _0x276d17;};return a67_0x18d9();}var __createBinding=this&&this[a67_0x3662f7(0x1bf)]||(Object[a67_0x3662f7(0x185)]?function(_0x2a77f4,_0x499bfc,_0x15364e,_0x5054d8){const _0x310f34=a67_0x3662f7;if(_0x5054d8===undefined)_0x5054d8=_0x15364e;var _0xf99aa5=Object['getOwnPropertyDescriptor'](_0x499bfc,_0x15364e);(!_0xf99aa5||(_0x310f34(0x181)in _0xf99aa5?!_0x499bfc[_0x310f34(0x1b1)]:_0xf99aa5['writable']||_0xf99aa5[_0x310f34(0x18e)]))&&(_0xf99aa5={'enumerable':!![],'get':function(){return _0x499bfc[_0x15364e];}}),Object[_0x310f34(0x18a)](_0x2a77f4,_0x5054d8,_0xf99aa5);}:function(_0x58afc8,_0x1b5a54,_0x54abe8,_0x5c704c){if(_0x5c704c===undefined)_0x5c704c=_0x54abe8;_0x58afc8[_0x5c704c]=_0x1b5a54[_0x54abe8];}),__setModuleDefault=this&&this[a67_0x3662f7(0x16a)]||(Object[a67_0x3662f7(0x185)]?function(_0x41b099,_0x37db20){const _0x3409dc=a67_0x3662f7;Object[_0x3409dc(0x18a)](_0x41b099,_0x3409dc(0x1e0),{'enumerable':!![],'value':_0x37db20});}:function(_0xaa9b0e,_0x22e8bc){const _0x5450d3=a67_0x3662f7;_0xaa9b0e[_0x5450d3(0x1e0)]=_0x22e8bc;}),__importStar=this&&this[a67_0x3662f7(0x19d)]||(function(){var _0x446835=function(_0x5e93be){const _0x44666e=a67_0x34c4;return _0x446835=Object[_0x44666e(0x198)]||function(_0x2eb25d){const _0x421920=_0x44666e;var _0x297372=[];for(var _0x48af4a in _0x2eb25d)if(Object[_0x421920(0x15c)]['hasOwnProperty']['call'](_0x2eb25d,_0x48af4a))_0x297372[_0x297372[_0x421920(0x195)]]=_0x48af4a;return _0x297372;},_0x446835(_0x5e93be);};return function(_0x4b9156){const _0x3a0db2=a67_0x34c4;if(_0x4b9156&&_0x4b9156[_0x3a0db2(0x1b1)])return _0x4b9156;var _0x3616a7={};if(_0x4b9156!=null){for(var _0x3dd8d5=_0x446835(_0x4b9156),_0x51d87c=0x0;_0x51d87c<_0x3dd8d5['length'];_0x51d87c++)if(_0x3dd8d5[_0x51d87c]!=='default')__createBinding(_0x3616a7,_0x4b9156,_0x3dd8d5[_0x51d87c]);}return __setModuleDefault(_0x3616a7,_0x4b9156),_0x3616a7;};}());Object[a67_0x3662f7(0x18a)](exports,'__esModule',{'value':!![]}),exports[a67_0x3662f7(0x1c6)]=void 0x0;const loggerService_1=require('../loggerService');class KlymeService{constructor(){const _0x41403b=a67_0x3662f7;this['apiUrl']=_0x41403b(0x163),console['log'](_0x41403b(0x161));}[a67_0x3662f7(0x1dd)](_0x39d1e9,_0xa63215){const _0x1673c9=a67_0x3662f7,_0x2d1198=_0x39d1e9[_0x1673c9(0x1db)]();switch(_0xa63215){case'EU':if(_0x2d1198!=='EUR')throw new Error(_0x1673c9(0x19b)+_0x2d1198);break;case'GB':if(_0x2d1198!==_0x1673c9(0x1b7))throw new Error(_0x1673c9(0x1cb)+_0x2d1198);break;case'DE':if(_0x2d1198!==_0x1673c9(0x1d1))throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x2d1198);break;default:throw new Error(_0x1673c9(0x162)+_0xa63215);}}async[a67_0x3662f7(0x197)](){const _0x4d7a0c=a67_0x3662f7,_0xc693a4=(await Promise[_0x4d7a0c(0x179)]()[_0x4d7a0c(0x1c7)](()=>__importStar(require('../../config/database'))))[_0x4d7a0c(0x1e0)];let _0x5879a9,_0x3ea1bf=0x0;const _0x3a9b45=0xa;do{const _0x118dea=()=>{const _0x5cc77f=_0x4d7a0c;return Math[_0x5cc77f(0x172)](Math['random']()*0x5f5e100)[_0x5cc77f(0x17d)]()[_0x5cc77f(0x168)](0x8,'0');};_0x5879a9=_0x118dea()+'-'+_0x118dea();const _0x88bbc9=await _0xc693a4['payment']['findFirst']({'where':{'gatewayOrderId':_0x5879a9}});if(!_0x88bbc9)break;_0x3ea1bf++,console[_0x4d7a0c(0x15d)](_0x4d7a0c(0x1e2)+_0x5879a9+_0x4d7a0c(0x15e)+_0x3ea1bf+')');}while(_0x3ea1bf<_0x3a9b45);if(_0x3ea1bf>=_0x3a9b45)throw new Error(_0x4d7a0c(0x155));return _0x5879a9;}async['createPaymentLink'](_0x8c46f2){const _0x828042=a67_0x3662f7,{orderId:_0x4393e2,amount:_0x510d49,currency:_0x2329ce,region:_0x5230a8}=_0x8c46f2;if(_0x5230a8!=='EU'&&_0x5230a8!=='GB'&&_0x5230a8!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x5230a8);this[_0x828042(0x1dd)](_0x2329ce,_0x5230a8);const _0x4aa2b5=_0x2329ce[_0x828042(0x1db)]();console[_0x828042(0x15d)](_0x828042(0x1cf)+_0x5230a8+_0x828042(0x1ab)+_0x4aa2b5);const _0xc6ee94=await this[_0x828042(0x197)]();console['log'](_0x828042(0x154)+_0xc6ee94+_0x828042(0x156)+_0x5230a8+')');const _0x1f037a='https://tesoft.uk/gateway/pending.php?id='+_0x4393e2,_0x3d8305={'amount':_0x510d49,'currency':_0x4aa2b5,'redirectUrl':_0x1f037a,'reference':_0xc6ee94,'geo':_0x5230a8},_0x175b41=Date['now']();try{console[_0x828042(0x15d)](_0x828042(0x15a)+_0x5230a8+'\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20==='),console[_0x828042(0x15d)](_0x828042(0x1b3),this[_0x828042(0x1ae)]),console[_0x828042(0x15d)](_0x828042(0x190),JSON[_0x828042(0x1a5)](_0x3d8305,null,0x2)),console['log'](_0x828042(0x1c3),_0x5230a8),console[_0x828042(0x15d)]('Currency:',_0x4aa2b5,'(validated\x20for\x20'+_0x5230a8+')'),console[_0x828042(0x15d)](_0x828042(0x188),_0xc6ee94,'(8digits-8digits\x20format)'),console[_0x828042(0x15d)]('Redirect\x20URL:',_0x1f037a),loggerService_1[_0x828042(0x196)][_0x828042(0x1e3)](_0x828042(0x1a8)+_0x5230a8[_0x828042(0x1c5)](),'/create',_0x828042(0x1da),_0x3d8305);const _0x108b21=await fetch(this[_0x828042(0x1ae)],{'method':_0x828042(0x1da),'headers':{'Content-Type':_0x828042(0x186),'Accept':_0x828042(0x186),'User-Agent':_0x828042(0x18d)},'body':JSON['stringify'](_0x3d8305)}),_0x2789a1=Date[_0x828042(0x189)]()-_0x175b41;console['log'](_0x828042(0x15a)+_0x5230a8+_0x828042(0x1d7)),console['log']('Status:',_0x108b21['status']),console[_0x828042(0x15d)](_0x828042(0x1dc),_0x108b21[_0x828042(0x157)]),console[_0x828042(0x15d)](_0x828042(0x1c9),Object[_0x828042(0x1a7)](_0x108b21['headers'][_0x828042(0x1b0)]())),console[_0x828042(0x15d)]('Response\x20Time:',_0x2789a1+'ms');const _0x33982c=await _0x108b21[_0x828042(0x191)]();console[_0x828042(0x15d)](_0x828042(0x166),_0x33982c);if(!_0x108b21['ok']){console[_0x828042(0x1b8)](_0x828042(0x15a)+_0x5230a8+_0x828042(0x1d4)),console[_0x828042(0x1b8)](_0x828042(0x18c),_0x108b21[_0x828042(0x1a0)]),console[_0x828042(0x1b8)](_0x828042(0x177),_0x33982c),loggerService_1['loggerService'][_0x828042(0x17a)](_0x828042(0x1a8)+_0x5230a8[_0x828042(0x1c5)](),_0x828042(0x1be),_0x108b21[_0x828042(0x1a0)],_0x33982c,_0x2789a1),loggerService_1[_0x828042(0x196)][_0x828042(0x167)]('klyme_'+_0x5230a8['toLowerCase'](),_0x828042(0x1be),_0x828042(0x1ba)+_0x108b21['status']+':\x20'+_0x33982c);throw new Error('HTTP\x20error!\x20status:\x20'+_0x108b21['status']+_0x828042(0x164)+_0x33982c);}let _0x40244b;try{_0x40244b=JSON[_0x828042(0x1bc)](_0x33982c);}catch(_0x4c63ea){console['error'](_0x828042(0x1a3),_0x4c63ea),loggerService_1[_0x828042(0x196)][_0x828042(0x167)](_0x828042(0x1a8)+_0x5230a8[_0x828042(0x1c5)](),_0x828042(0x1be),_0x828042(0x1a2)+_0x4c63ea);throw new Error('Invalid\x20JSON\x20response\x20from\x20KLYME\x20'+_0x5230a8+_0x828042(0x1b5)+_0x33982c);}console[_0x828042(0x15d)](_0x828042(0x1e4)+_0x5230a8+_0x828042(0x15b)),console[_0x828042(0x15d)]('Parsed\x20Result:',JSON['stringify'](_0x40244b,null,0x2)),loggerService_1[_0x828042(0x196)][_0x828042(0x17a)](_0x828042(0x1a8)+_0x5230a8[_0x828042(0x1c5)](),_0x828042(0x1be),_0x108b21[_0x828042(0x1a0)],_0x40244b,_0x2789a1);if(_0x40244b[_0x828042(0x1b8)]||_0x40244b['statusCode']){const _0xdd8210=_0x40244b['message']||_0x40244b[_0x828042(0x1b8)]||'Unknown\x20error\x20from\x20KLYME\x20'+_0x5230a8+_0x828042(0x160);console['error']('===\x20KLYME\x20'+_0x5230a8+'\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x828042(0x1b8)]('Error\x20Message:',_0xdd8210),console[_0x828042(0x1b8)]('Status\x20Code:',_0x40244b[_0x828042(0x16d)]),loggerService_1['loggerService']['logWhiteDomainError'](_0x828042(0x1a8)+_0x5230a8['toLowerCase'](),_0x828042(0x1be),_0x828042(0x171)+_0xdd8210);throw new Error(_0x828042(0x192)+_0x5230a8+_0x828042(0x1d0)+_0xdd8210);}let _0x27490d,_0x3c9eda;if(_0x40244b[_0x828042(0x1d5)]&&_0x40244b['redirect_url'])_0x27490d=_0x40244b[_0x828042(0x1d5)],_0x3c9eda=_0x40244b[_0x828042(0x1b6)],console['log'](_0x828042(0x15a)+_0x5230a8+_0x828042(0x159)),console[_0x828042(0x15d)](_0x828042(0x1b9),_0x40244b['uuid']),console[_0x828042(0x15d)]('Redirect\x20URL:',_0x40244b[_0x828042(0x1b6)]);else{if(_0x40244b[_0x828042(0x173)])_0x27490d=_0xc6ee94,_0x3c9eda=_0x40244b[_0x828042(0x173)],console['log']('===\x20KLYME\x20'+_0x5230a8+_0x828042(0x1bb)),console['log'](_0x828042(0x1cc),_0x40244b['authUrl']),console['log'](_0x828042(0x17f),_0xc6ee94);else{console[_0x828042(0x1b8)](_0x828042(0x15a)+_0x5230a8+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console['error']('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console[_0x828042(0x1b8)](_0x828042(0x1ad),_0x40244b),loggerService_1[_0x828042(0x196)][_0x828042(0x167)]('klyme_'+_0x5230a8[_0x828042(0x1c5)](),_0x828042(0x1be),_0x828042(0x1a4));throw new Error(_0x828042(0x15f)+_0x5230a8+_0x828042(0x183));}}return console[_0x828042(0x15d)]('Currency\x20Used:',_0x4aa2b5,'('+_0x5230a8+_0x828042(0x170)),console[_0x828042(0x15d)](_0x828042(0x18b),_0xc6ee94,_0x828042(0x1ac)),console[_0x828042(0x15d)](_0x828042(0x199),_0x5230a8),{'gateway_payment_id':_0x27490d,'payment_url':_0x3c9eda};}catch(_0xdc809b){console[_0x828042(0x1b8)](_0x828042(0x15a)+_0x5230a8+_0x828042(0x1d9)),console[_0x828042(0x1b8)](_0x828042(0x193),_0xdc809b),loggerService_1[_0x828042(0x196)][_0x828042(0x167)](_0x828042(0x1a8)+_0x5230a8[_0x828042(0x1c5)](),_0x828042(0x1be),_0xdc809b);if(_0xdc809b instanceof Error){console[_0x828042(0x1b8)](_0x828042(0x17b),_0xdc809b[_0x828042(0x1a6)]),console[_0x828042(0x1b8)](_0x828042(0x1c0),_0xdc809b[_0x828042(0x1ca)]);throw new Error(_0x828042(0x1c2)+_0x5230a8+_0x828042(0x194)+_0xdc809b[_0x828042(0x1a6)]);}throw new Error(_0x828042(0x1c2)+_0x5230a8+_0x828042(0x169));}}async[a67_0x3662f7(0x165)](_0x11ad6d,_0x291bf3){const _0x6f7ceb=a67_0x3662f7,_0x1dac5c=Date[_0x6f7ceb(0x189)]();try{const _0xa256aa={'gatewayPaymentId':_0x11ad6d,'geo':_0x291bf3};loggerService_1[_0x6f7ceb(0x196)]['logWhiteDomainRequest']('klyme_'+_0x291bf3[_0x6f7ceb(0x1c5)](),_0x6f7ceb(0x1c1)+_0x11ad6d,_0x6f7ceb(0x1da),_0xa256aa);const _0x39c4bc=await fetch(this['apiUrl'],{'method':_0x6f7ceb(0x1da),'headers':{'Content-Type':'application/json','User-Agent':'Payment\x20System/1.0'},'body':JSON[_0x6f7ceb(0x1a5)](_0xa256aa)}),_0x2fc6e7=Date[_0x6f7ceb(0x189)]()-_0x1dac5c;if(!_0x39c4bc['ok']){const _0x5f87b6=await _0x39c4bc[_0x6f7ceb(0x191)]();loggerService_1[_0x6f7ceb(0x196)][_0x6f7ceb(0x17a)](_0x6f7ceb(0x1a8)+_0x291bf3['toLowerCase'](),_0x6f7ceb(0x1c1)+_0x11ad6d,_0x39c4bc[_0x6f7ceb(0x1a0)],_0x5f87b6,_0x2fc6e7);throw new Error(_0x6f7ceb(0x1d3)+_0x39c4bc[_0x6f7ceb(0x1a0)]);}const _0x411f51=await _0x39c4bc[_0x6f7ceb(0x1d2)]();loggerService_1[_0x6f7ceb(0x196)][_0x6f7ceb(0x17a)]('klyme_'+_0x291bf3[_0x6f7ceb(0x1c5)](),_0x6f7ceb(0x1c1)+_0x11ad6d,_0x39c4bc[_0x6f7ceb(0x1a0)],_0x411f51,_0x2fc6e7);if(_0x411f51[_0x6f7ceb(0x1b8)]||_0x411f51['statusCode']){loggerService_1[_0x6f7ceb(0x196)][_0x6f7ceb(0x167)](_0x6f7ceb(0x1a8)+_0x291bf3[_0x6f7ceb(0x1c5)](),_0x6f7ceb(0x1c1)+_0x11ad6d,_0x6f7ceb(0x192)+_0x291bf3+'\x20API\x20error:\x20'+(_0x411f51[_0x6f7ceb(0x1a6)]||_0x411f51[_0x6f7ceb(0x1b8)]||'Unknown\x20error'));throw new Error(_0x6f7ceb(0x192)+_0x291bf3+_0x6f7ceb(0x1d0)+(_0x411f51['message']||_0x411f51['error']||_0x6f7ceb(0x16c)));}let _0x5b5ca4=_0x6f7ceb(0x1aa);return{'status':_0x5b5ca4};}catch(_0x225ea5){console[_0x6f7ceb(0x1b8)](_0x6f7ceb(0x192)+_0x291bf3+'\x20payment\x20verification\x20error:',_0x225ea5),loggerService_1[_0x6f7ceb(0x196)]['logWhiteDomainError'](_0x6f7ceb(0x1a8)+_0x291bf3[_0x6f7ceb(0x1c5)](),_0x6f7ceb(0x1c1)+_0x11ad6d,_0x225ea5);throw new Error(_0x6f7ceb(0x1df)+_0x291bf3+'\x20payment:\x20'+(_0x225ea5 instanceof Error?_0x225ea5['message']:_0x6f7ceb(0x16c)));}}async[a67_0x3662f7(0x174)](_0x2fe2b4){const _0x48853b=a67_0x3662f7;console[_0x48853b(0x15d)](_0x48853b(0x1a1),_0x2fe2b4);let _0x19a4b2=_0x48853b(0x1aa);switch(_0x2fe2b4[_0x48853b(0x1a0)]?.[_0x48853b(0x1c5)]()){case _0x48853b(0x18f):case _0x48853b(0x16b):case _0x48853b(0x176):case _0x48853b(0x178):case _0x48853b(0x180):_0x19a4b2='PAID';break;case _0x48853b(0x182):case _0x48853b(0x1c4):case _0x48853b(0x1d6):case _0x48853b(0x1b8):case _0x48853b(0x175):_0x19a4b2='FAILED';break;case _0x48853b(0x1b2):case _0x48853b(0x19f):_0x19a4b2=_0x48853b(0x16e);break;case _0x48853b(0x1af):case _0x48853b(0x1ce):case _0x48853b(0x184):case _0x48853b(0x19e):case _0x48853b(0x1d8):default:_0x19a4b2=_0x48853b(0x1aa);break;}return{'paymentId':_0x2fe2b4[_0x48853b(0x19a)]||_0x2fe2b4[_0x48853b(0x158)]||_0x2fe2b4[_0x48853b(0x1b4)],'status':_0x19a4b2,'amount':_0x2fe2b4['amount'],'currency':_0x2fe2b4['currency'],'region':_0x2fe2b4[_0x48853b(0x17c)],'additionalInfo':{'payment_method':_0x2fe2b4[_0x48853b(0x16f)],'transaction_id':_0x2fe2b4[_0x48853b(0x1bd)]}};}}exports[a67_0x3662f7(0x1c6)]=KlymeService;