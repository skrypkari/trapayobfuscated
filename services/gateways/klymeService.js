'use strict';const a61_0x2c422a=a61_0x2049;function a61_0xfd7d(){const _0x4c8400=['HTTP\x20Status:','\x20API','Reference:','getOwnPropertyNames','(8digits-8digits\x20format)','timeout','Response\x20Body:','uuid','\x20validated)','HTTP\x20','PENDING','\x20API:\x20missing\x20payment\x20data','create','expired','324525ofKrQf','964165suOMWl','Currency:','\x20payment:\x20','length','Response\x20Time:','Processing\x20KLYME\x20webhook:','5307732fVbPvI','findFirst','statusCode','JSON\x20Parse\x20Error:\x20',',\x20body:\x20','now','\x20payment\x20verification\x20error:','floor','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','Response\x20data:','Redirect\x20URL:','json','Headers:','payment','https://tesoft.uk/gateway/pending.php?id=','HTTP\x20error!\x20status:\x20','log','Invalid\x20response\x20from\x20KLYME\x20','Region\x20(geo):','created','call','Unsupported\x20KLYME\x20region:\x20','\x20SUCCESS\x20(New\x20Format)\x20===','get','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','688xTLxwx','generateUniqueReference','logWhiteDomainResponse','FAILED','===\x20KLYME\x20','../loggerService','13599EiThYV','Error\x20details:','EXPIRED','amount','GBP','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','logWhiteDomainError','defineProperty','paid','prototype','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','rejected','resolve','Failed\x20to\x20verify\x20KLYME\x20','logWhiteDomainRequest','payment_id','../../config/database','status','toString','UUID:','üí≥\x20KLYME\x20','Reference\x20Used:','PAID','\x20API\x20error:\x20','https://tesoft.uk/gateway/klyme/','__setModuleDefault','transaction_id','processWebhook','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','134aKalBY','region','stringify','\x20API:\x20','error','/verify/','writable','hasOwnProperty','Failed\x20to\x20parse\x20JSON\x20response:','application/json','statusText','‚ö†Ô∏è\x20KLYME\x20reference\x20','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Unknown\x20error\x20from\x20KLYME\x20','__esModule','createPaymentLink','Payment\x20System/1.0','271593KHvQFy','processing','Unknown\x20error','cancelled','4411964sumNpY','apiUrl','Raw\x20Response\x20Body:','redirect_url','Business\x20Error:\x20','random','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','completed','message','currency','pending','Request\x20Body:','canceled','toUpperCase','klyme_','validateCurrencyForRegion','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','5332831SriWzg','POST','in_progress','KlymeService','/create','KLYME\x20','authUrl','Reference\x20Used\x20as\x20ID:','default','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','Geo\x20Parameter:','Failed\x20to\x20create\x20KLYME\x20','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','toLowerCase','Status\x20Code:','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','text','Error\x20message:','\x20currency\x20validation\x20passed:\x20','stack','loggerService','URL:'];a61_0xfd7d=function(){return _0x4c8400;};return a61_0xfd7d();}(function(_0x479748,_0xb334c8){const _0x2bae2e=a61_0x2049,_0x249fc9=_0x479748();while(!![]){try{const _0x2d2d45=parseInt(_0x2bae2e(0xda))/0x1+parseInt(_0x2bae2e(0x11d))/0x2*(parseInt(_0x2bae2e(0x100))/0x3)+parseInt(_0x2bae2e(0x132))/0x4+-parseInt(_0x2bae2e(0xdb))/0x5+parseInt(_0x2bae2e(0xe1))/0x6+parseInt(_0x2bae2e(0x144))/0x7+-parseInt(_0x2bae2e(0xfa))/0x8*(parseInt(_0x2bae2e(0x12e))/0x9);if(_0x2d2d45===_0xb334c8)break;else _0x249fc9['push'](_0x249fc9['shift']());}catch(_0xc53919){_0x249fc9['push'](_0x249fc9['shift']());}}}(a61_0xfd7d,0x8ff3b));var __createBinding=this&&this['__createBinding']||(Object[a61_0x2c422a(0xd8)]?function(_0x3a6d9e,_0x4726f4,_0x502d46,_0x463cf6){const _0x150c70=a61_0x2c422a;if(_0x463cf6===undefined)_0x463cf6=_0x502d46;var _0x1f5293=Object['getOwnPropertyDescriptor'](_0x4726f4,_0x502d46);(!_0x1f5293||(_0x150c70(0xf8)in _0x1f5293?!_0x4726f4[_0x150c70(0x12b)]:_0x1f5293[_0x150c70(0x123)]||_0x1f5293['configurable']))&&(_0x1f5293={'enumerable':!![],'get':function(){return _0x4726f4[_0x502d46];}}),Object[_0x150c70(0x107)](_0x3a6d9e,_0x463cf6,_0x1f5293);}:function(_0x44d50f,_0x107075,_0x1d218d,_0x4a1f4a){if(_0x4a1f4a===undefined)_0x4a1f4a=_0x1d218d;_0x44d50f[_0x4a1f4a]=_0x107075[_0x1d218d];}),__setModuleDefault=this&&this[a61_0x2c422a(0x119)]||(Object['create']?function(_0x8adfbf,_0x2d3a91){const _0x5b0cf9=a61_0x2c422a;Object[_0x5b0cf9(0x107)](_0x8adfbf,'default',{'enumerable':!![],'value':_0x2d3a91});}:function(_0x14f76e,_0x5d971f){const _0x199800=a61_0x2c422a;_0x14f76e[_0x199800(0x14c)]=_0x5d971f;}),__importStar=this&&this['__importStar']||(function(){var _0x46c212=function(_0x4986af){const _0x207bed=a61_0x2049;return _0x46c212=Object[_0x207bed(0xcf)]||function(_0xc6f566){const _0x37f197=_0x207bed;var _0x95cd6a=[];for(var _0x2a4923 in _0xc6f566)if(Object[_0x37f197(0x109)][_0x37f197(0x124)][_0x37f197(0xf5)](_0xc6f566,_0x2a4923))_0x95cd6a[_0x95cd6a[_0x37f197(0xde)]]=_0x2a4923;return _0x95cd6a;},_0x46c212(_0x4986af);};return function(_0x5dd622){const _0x8b05d3=a61_0x2049;if(_0x5dd622&&_0x5dd622['__esModule'])return _0x5dd622;var _0x5e4b06={};if(_0x5dd622!=null){for(var _0x1e84ba=_0x46c212(_0x5dd622),_0x4a1af0=0x0;_0x4a1af0<_0x1e84ba[_0x8b05d3(0xde)];_0x4a1af0++)if(_0x1e84ba[_0x4a1af0]!==_0x8b05d3(0x14c))__createBinding(_0x5e4b06,_0x5dd622,_0x1e84ba[_0x4a1af0]);}return __setModuleDefault(_0x5e4b06,_0x5dd622),_0x5e4b06;};}());Object[a61_0x2c422a(0x107)](exports,a61_0x2c422a(0x12b),{'value':!![]}),exports[a61_0x2c422a(0x147)]=void 0x0;function a61_0x2049(_0x1a799b,_0x1241e2){_0x1a799b=_0x1a799b-0xcb;const _0xfd7ddd=a61_0xfd7d();let _0x2049b3=_0xfd7ddd[_0x1a799b];return _0x2049b3;}const loggerService_1=require(a61_0x2c422a(0xff));class KlymeService{constructor(){const _0xc8be0b=a61_0x2c422a;this[_0xc8be0b(0x133)]=_0xc8be0b(0x118),console[_0xc8be0b(0xf1)](_0xc8be0b(0x11c));}[a61_0x2c422a(0x141)](_0x12cc32,_0x69b4b){const _0x2dbc56=a61_0x2c422a,_0x10bcf0=_0x12cc32[_0x2dbc56(0x13f)]();switch(_0x69b4b){case'EU':if(_0x10bcf0!=='EUR')throw new Error(_0x2dbc56(0xf9)+_0x10bcf0);break;case'GB':if(_0x10bcf0!==_0x2dbc56(0x104))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x10bcf0);break;case'DE':if(_0x10bcf0!=='EUR')throw new Error(_0x2dbc56(0x143)+_0x10bcf0);break;default:throw new Error(_0x2dbc56(0xf6)+_0x69b4b);}}async[a61_0x2c422a(0xfb)](){const _0x339096=a61_0x2c422a,_0x56d604=(await Promise[_0x339096(0x10c)]()['then'](()=>__importStar(require(_0x339096(0x110)))))['default'];let _0x3ac4d5,_0x16d9ce=0x0;const _0xb36c57=0xa;do{const _0x39ab10=()=>{const _0x5be7e0=_0x339096;return Math[_0x5be7e0(0xe8)](Math[_0x5be7e0(0x137)]()*0x5f5e100)[_0x5be7e0(0x112)]()['padStart'](0x8,'0');};_0x3ac4d5=_0x39ab10()+'-'+_0x39ab10();const _0xbe17fa=await _0x56d604[_0x339096(0xee)][_0x339096(0xe2)]({'where':{'gatewayOrderId':_0x3ac4d5}});if(!_0xbe17fa)break;_0x16d9ce++,console[_0x339096(0xf1)](_0x339096(0x128)+_0x3ac4d5+_0x339096(0xe9)+_0x16d9ce+')');}while(_0x16d9ce<_0xb36c57);if(_0x16d9ce>=_0xb36c57)throw new Error(_0x339096(0x105));return _0x3ac4d5;}async[a61_0x2c422a(0x12c)](_0x23f355){const _0x5074ad=a61_0x2c422a,{orderId:_0x2fe9be,amount:_0x18c4f1,currency:_0x38c409,region:_0x4f4c4a}=_0x23f355;if(_0x4f4c4a!=='EU'&&_0x4f4c4a!=='GB'&&_0x4f4c4a!=='DE')throw new Error(_0x5074ad(0x142)+_0x4f4c4a);this['validateCurrencyForRegion'](_0x38c409,_0x4f4c4a);const _0x4d7920=_0x38c409['toUpperCase']();console[_0x5074ad(0xf1)](_0x5074ad(0x114)+_0x4f4c4a+_0x5074ad(0x156)+_0x4d7920);const _0x4707f0=await this['generateUniqueReference']();console[_0x5074ad(0xf1)](_0x5074ad(0x150)+_0x4707f0+'\x20(8digits-8digits\x20format\x20for\x20'+_0x4f4c4a+')');const _0x272edd=_0x5074ad(0xef)+_0x2fe9be,_0x4543e7={'amount':_0x18c4f1,'currency':_0x4d7920,'redirectUrl':_0x272edd,'reference':_0x4707f0,'geo':_0x4f4c4a},_0x38194f=Date[_0x5074ad(0xe6)]();try{console[_0x5074ad(0xf1)](_0x5074ad(0xfe)+_0x4f4c4a+'\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20==='),console[_0x5074ad(0xf1)](_0x5074ad(0xcb),this[_0x5074ad(0x133)]),console['log'](_0x5074ad(0x13d),JSON['stringify'](_0x4543e7,null,0x2)),console[_0x5074ad(0xf1)](_0x5074ad(0xf3),_0x4f4c4a),console[_0x5074ad(0xf1)](_0x5074ad(0xdc),_0x4d7920,'(validated\x20for\x20'+_0x4f4c4a+')'),console['log'](_0x5074ad(0xce),_0x4707f0,_0x5074ad(0xd0)),console[_0x5074ad(0xf1)](_0x5074ad(0xeb),_0x272edd),loggerService_1[_0x5074ad(0x158)][_0x5074ad(0x10e)]('klyme_'+_0x4f4c4a[_0x5074ad(0x151)](),_0x5074ad(0x148),'POST',_0x4543e7);const _0x3d335e=await fetch(this['apiUrl'],{'method':_0x5074ad(0x145),'headers':{'Content-Type':_0x5074ad(0x126),'Accept':_0x5074ad(0x126),'User-Agent':'Payment\x20System/1.0'},'body':JSON['stringify'](_0x4543e7)}),_0x4a333d=Date['now']()-_0x38194f;console[_0x5074ad(0xf1)](_0x5074ad(0xfe)+_0x4f4c4a+_0x5074ad(0x10a)),console['log']('Status:',_0x3d335e[_0x5074ad(0x111)]),console[_0x5074ad(0xf1)]('Status\x20Text:',_0x3d335e[_0x5074ad(0x127)]),console[_0x5074ad(0xf1)](_0x5074ad(0xed),Object['fromEntries'](_0x3d335e['headers']['entries']())),console[_0x5074ad(0xf1)](_0x5074ad(0xdf),_0x4a333d+'ms');const _0x1746c0=await _0x3d335e[_0x5074ad(0x154)]();console[_0x5074ad(0xf1)](_0x5074ad(0x134),_0x1746c0);if(!_0x3d335e['ok']){console[_0x5074ad(0x121)](_0x5074ad(0xfe)+_0x4f4c4a+'\x20API\x20ERROR\x20==='),console[_0x5074ad(0x121)](_0x5074ad(0xcc),_0x3d335e[_0x5074ad(0x111)]),console[_0x5074ad(0x121)](_0x5074ad(0xd2),_0x1746c0),loggerService_1[_0x5074ad(0x158)][_0x5074ad(0xfc)]('klyme_'+_0x4f4c4a[_0x5074ad(0x151)](),_0x5074ad(0x148),_0x3d335e['status'],_0x1746c0,_0x4a333d),loggerService_1[_0x5074ad(0x158)][_0x5074ad(0x106)]('klyme_'+_0x4f4c4a[_0x5074ad(0x151)](),_0x5074ad(0x148),_0x5074ad(0xd5)+_0x3d335e[_0x5074ad(0x111)]+':\x20'+_0x1746c0);throw new Error('HTTP\x20error!\x20status:\x20'+_0x3d335e[_0x5074ad(0x111)]+_0x5074ad(0xe5)+_0x1746c0);}let _0x30ca7b;try{_0x30ca7b=JSON['parse'](_0x1746c0);}catch(_0x5add29){console[_0x5074ad(0x121)](_0x5074ad(0x125),_0x5add29),loggerService_1[_0x5074ad(0x158)][_0x5074ad(0x106)](_0x5074ad(0x140)+_0x4f4c4a[_0x5074ad(0x151)](),_0x5074ad(0x148),_0x5074ad(0xe4)+_0x5add29);throw new Error(_0x5074ad(0x153)+_0x4f4c4a+_0x5074ad(0x120)+_0x1746c0);}console[_0x5074ad(0xf1)]('===\x20PARSED\x20KLYME\x20'+_0x4f4c4a+'\x20RESPONSE\x20==='),console[_0x5074ad(0xf1)]('Parsed\x20Result:',JSON[_0x5074ad(0x11f)](_0x30ca7b,null,0x2)),loggerService_1[_0x5074ad(0x158)][_0x5074ad(0xfc)]('klyme_'+_0x4f4c4a[_0x5074ad(0x151)](),_0x5074ad(0x148),_0x3d335e[_0x5074ad(0x111)],_0x30ca7b,_0x4a333d);if(_0x30ca7b[_0x5074ad(0x121)]||_0x30ca7b[_0x5074ad(0xe3)]){const _0x99d5cb=_0x30ca7b[_0x5074ad(0x13a)]||_0x30ca7b[_0x5074ad(0x121)]||_0x5074ad(0x12a)+_0x4f4c4a+_0x5074ad(0xcd);console[_0x5074ad(0x121)](_0x5074ad(0xfe)+_0x4f4c4a+'\x20API\x20BUSINESS\x20ERROR\x20==='),console['error']('Error\x20Message:',_0x99d5cb),console['error'](_0x5074ad(0x152),_0x30ca7b[_0x5074ad(0xe3)]),loggerService_1[_0x5074ad(0x158)][_0x5074ad(0x106)]('klyme_'+_0x4f4c4a['toLowerCase'](),_0x5074ad(0x148),_0x5074ad(0x136)+_0x99d5cb);throw new Error('KLYME\x20'+_0x4f4c4a+'\x20API\x20error:\x20'+_0x99d5cb);}let _0x493773,_0x22f373;if(_0x30ca7b['uuid']&&_0x30ca7b['redirect_url'])_0x493773=_0x30ca7b[_0x5074ad(0xd3)],_0x22f373=_0x30ca7b[_0x5074ad(0x135)],console[_0x5074ad(0xf1)](_0x5074ad(0xfe)+_0x4f4c4a+_0x5074ad(0xf7)),console[_0x5074ad(0xf1)](_0x5074ad(0x113),_0x30ca7b['uuid']),console['log']('Redirect\x20URL:',_0x30ca7b['redirect_url']);else{if(_0x30ca7b['authUrl'])_0x493773=_0x4707f0,_0x22f373=_0x30ca7b[_0x5074ad(0x14a)],console[_0x5074ad(0xf1)](_0x5074ad(0xfe)+_0x4f4c4a+'\x20SUCCESS\x20(Legacy\x20Format)\x20==='),console['log']('Auth\x20URL:',_0x30ca7b['authUrl']),console[_0x5074ad(0xf1)](_0x5074ad(0x14b),_0x4707f0);else{console[_0x5074ad(0x121)](_0x5074ad(0xfe)+_0x4f4c4a+_0x5074ad(0x129)),console[_0x5074ad(0x121)](_0x5074ad(0x14d)),console[_0x5074ad(0x121)](_0x5074ad(0xea),_0x30ca7b),loggerService_1[_0x5074ad(0x158)][_0x5074ad(0x106)]('klyme_'+_0x4f4c4a[_0x5074ad(0x151)](),_0x5074ad(0x148),_0x5074ad(0x138));throw new Error(_0x5074ad(0xf2)+_0x4f4c4a+_0x5074ad(0xd7));}}return console[_0x5074ad(0xf1)]('Currency\x20Used:',_0x4d7920,'('+_0x4f4c4a+_0x5074ad(0xd4)),console[_0x5074ad(0xf1)](_0x5074ad(0x115),_0x4707f0,_0x5074ad(0xd0)),console['log'](_0x5074ad(0x14e),_0x4f4c4a),{'gateway_payment_id':_0x493773,'payment_url':_0x22f373};}catch(_0x3b66e0){console[_0x5074ad(0x121)](_0x5074ad(0xfe)+_0x4f4c4a+'\x20SERVICE\x20ERROR\x20==='),console[_0x5074ad(0x121)](_0x5074ad(0x101),_0x3b66e0),loggerService_1[_0x5074ad(0x158)][_0x5074ad(0x106)]('klyme_'+_0x4f4c4a[_0x5074ad(0x151)](),_0x5074ad(0x148),_0x3b66e0);if(_0x3b66e0 instanceof Error){console[_0x5074ad(0x121)](_0x5074ad(0x155),_0x3b66e0[_0x5074ad(0x13a)]),console[_0x5074ad(0x121)]('Error\x20stack:',_0x3b66e0[_0x5074ad(0x157)]);throw new Error(_0x5074ad(0x14f)+_0x4f4c4a+'\x20payment\x20link:\x20'+_0x3b66e0[_0x5074ad(0x13a)]);}throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0x4f4c4a+'\x20payment\x20link:\x20Unknown\x20error');}}async['verifyPayment'](_0x3d0a6c,_0x3fcf38){const _0x51a718=a61_0x2c422a,_0x487fc8=Date['now']();try{const _0x429dab={'gatewayPaymentId':_0x3d0a6c,'geo':_0x3fcf38};loggerService_1['loggerService']['logWhiteDomainRequest']('klyme_'+_0x3fcf38[_0x51a718(0x151)](),_0x51a718(0x122)+_0x3d0a6c,'POST',_0x429dab);const _0x2998b2=await fetch(this['apiUrl'],{'method':_0x51a718(0x145),'headers':{'Content-Type':'application/json','User-Agent':_0x51a718(0x12d)},'body':JSON[_0x51a718(0x11f)](_0x429dab)}),_0x59c8af=Date[_0x51a718(0xe6)]()-_0x487fc8;if(!_0x2998b2['ok']){const _0x5e9508=await _0x2998b2[_0x51a718(0x154)]();loggerService_1['loggerService'][_0x51a718(0xfc)](_0x51a718(0x140)+_0x3fcf38[_0x51a718(0x151)](),'/verify/'+_0x3d0a6c,_0x2998b2[_0x51a718(0x111)],_0x5e9508,_0x59c8af);throw new Error(_0x51a718(0xf0)+_0x2998b2[_0x51a718(0x111)]);}const _0x558398=await _0x2998b2[_0x51a718(0xec)]();loggerService_1[_0x51a718(0x158)][_0x51a718(0xfc)](_0x51a718(0x140)+_0x3fcf38['toLowerCase'](),_0x51a718(0x122)+_0x3d0a6c,_0x2998b2['status'],_0x558398,_0x59c8af);if(_0x558398[_0x51a718(0x121)]||_0x558398[_0x51a718(0xe3)]){loggerService_1[_0x51a718(0x158)][_0x51a718(0x106)](_0x51a718(0x140)+_0x3fcf38[_0x51a718(0x151)](),_0x51a718(0x122)+_0x3d0a6c,_0x51a718(0x149)+_0x3fcf38+_0x51a718(0x117)+(_0x558398['message']||_0x558398[_0x51a718(0x121)]||_0x51a718(0x130)));throw new Error('KLYME\x20'+_0x3fcf38+_0x51a718(0x117)+(_0x558398['message']||_0x558398[_0x51a718(0x121)]||_0x51a718(0x130)));}let _0x4c4bd6='PENDING';return{'status':_0x4c4bd6};}catch(_0x529528){console['error']('KLYME\x20'+_0x3fcf38+_0x51a718(0xe7),_0x529528),loggerService_1[_0x51a718(0x158)][_0x51a718(0x106)](_0x51a718(0x140)+_0x3fcf38['toLowerCase'](),_0x51a718(0x122)+_0x3d0a6c,_0x529528);throw new Error(_0x51a718(0x10d)+_0x3fcf38+_0x51a718(0xdd)+(_0x529528 instanceof Error?_0x529528[_0x51a718(0x13a)]:_0x51a718(0x130)));}}async[a61_0x2c422a(0x11b)](_0x452310){const _0x17bee7=a61_0x2c422a;console[_0x17bee7(0xf1)](_0x17bee7(0xe0),_0x452310);let _0x432299='PENDING';switch(_0x452310[_0x17bee7(0x111)]?.[_0x17bee7(0x151)]()){case _0x17bee7(0x108):case _0x17bee7(0x139):case'confirmed':case'success':case'successful':_0x432299=_0x17bee7(0x116);break;case _0x17bee7(0x131):case _0x17bee7(0x13e):case'failed':case _0x17bee7(0x121):case _0x17bee7(0x10b):_0x432299=_0x17bee7(0xfd);break;case _0x17bee7(0xd9):case _0x17bee7(0xd1):_0x432299=_0x17bee7(0x102);break;case _0x17bee7(0x13c):case _0x17bee7(0xf4):case'active':case _0x17bee7(0x12f):case _0x17bee7(0x146):default:_0x432299=_0x17bee7(0xd6);break;}return{'paymentId':_0x452310['reference']||_0x452310['order_id']||_0x452310[_0x17bee7(0x10f)],'status':_0x432299,'amount':_0x452310[_0x17bee7(0x103)],'currency':_0x452310[_0x17bee7(0x13b)],'region':_0x452310[_0x17bee7(0x11e)],'additionalInfo':{'payment_method':_0x452310['payment_method'],'transaction_id':_0x452310[_0x17bee7(0x11a)]}};}}exports[a61_0x2c422a(0x147)]=KlymeService;