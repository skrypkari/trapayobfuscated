'use strict';const a42_0x27b1f6=a42_0x3a90;(function(_0x22c260,_0x1bbc0a){const _0x97b75b=a42_0x3a90,_0x1bfb99=_0x22c260();while(!![]){try{const _0xdef012=-parseInt(_0x97b75b(0xc3))/0x1*(-parseInt(_0x97b75b(0xd8))/0x2)+parseInt(_0x97b75b(0xdf))/0x3+parseInt(_0x97b75b(0xd1))/0x4+-parseInt(_0x97b75b(0x12f))/0x5+-parseInt(_0x97b75b(0xe0))/0x6*(parseInt(_0x97b75b(0x111))/0x7)+parseInt(_0x97b75b(0x146))/0x8*(parseInt(_0x97b75b(0xfe))/0x9)+-parseInt(_0x97b75b(0x122))/0xa;if(_0xdef012===_0x1bbc0a)break;else _0x1bfb99['push'](_0x1bfb99['shift']());}catch(_0x16edd1){_0x1bfb99['push'](_0x1bfb99['shift']());}}}(a42_0x176c,0xd1748));function a42_0x176c(){const _0x5a0213=['\x20API\x20ERROR\x20===','statusText','Failed\x20to\x20verify\x20KLYME\x20','logWhiteDomainResponse','expired','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','redirect_url','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','error','Business\x20Error:\x20','HTTP\x20error!\x20status:\x20','KlymeService','application/json','153336spjHzT','fromEntries','uuid','writable','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','Currency\x20Used:','prototype','HTTP\x20','createPaymentLink','Headers:','message','configurable','Unsupported\x20KLYME\x20region:\x20','Error\x20message:','Unknown\x20error','\x20currency\x20validation\x20passed:\x20','region','‚ö†Ô∏è\x20KLYME\x20reference\x20','\x20SUCCESS\x20(New\x20Format)\x20===','logWhiteDomainError','970406VchZZh','__importStar','logWhiteDomainRequest','JSON\x20Parse\x20Error:\x20','PAID','status','loggerService','stack','Failed\x20to\x20parse\x20JSON\x20response:','Redirect\x20URL:','validateCurrencyForRegion','order_id','amount','klyme_','5730892QVQNWL','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','call','paid','Region\x20(geo):','https://tesoft.uk/gateway/klyme/','\x20API:\x20','2hLzQEQ','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','Status\x20Code:','__setModuleDefault','\x20payment\x20link:\x20Unknown\x20error','json','Reference\x20Used:','2745237aSdwjG','6IRIxsy','completed','/verify/','transaction_id','getOwnPropertyNames','PENDING','__esModule','entries','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','padStart','Response\x20Body:','POST','Response\x20data:','in_progress','payment_method','resolve','currency','payment_id','length','\x20RESPONSE\x20===','generateUniqueReference','===\x20KLYME\x20','\x20API','findFirst','\x20SERVICE\x20ERROR\x20===','defineProperty','log','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','successful','(8digits-8digits\x20format)','171EDMvlD','authUrl','failed','get','EUR','üí≥\x20KLYME\x20','now','success','\x20API\x20error:\x20',',\x20body:\x20','Status:','__createBinding','rejected','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Error\x20details:','GBP','\x20API:\x20missing\x20payment\x20data','EXPIRED','statusCode','42049HbgJxq','Reference:','canceled','Error\x20stack:','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','create','/create','headers','https://tesoft.uk/gateway/pending.php?id=','toLowerCase','pending','toUpperCase','../loggerService','timeout','Raw\x20Response\x20Body:','processWebhook','Request\x20Body:','20566520mvhuVd','\x20payment:\x20','Unknown\x20error\x20from\x20KLYME\x20','../../config/database','\x20(8digits-8digits\x20format\x20for\x20','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','confirmed','Invalid\x20response\x20from\x20KLYME\x20','then','Response\x20Time:','TesSoft\x20Payment\x20System/1.0','floor','Error\x20Message:','3808970lKFshz','apiUrl','reference','default','random','text','toString','Failed\x20to\x20create\x20KLYME\x20','\x20API\x20INCOMPLETE\x20RESPONSE\x20==='];a42_0x176c=function(){return _0x5a0213;};return a42_0x176c();}var __createBinding=this&&this[a42_0x27b1f6(0x109)]||(Object['create']?function(_0x2b774d,_0x1e59e6,_0x1ccc60,_0xf0dafa){const _0x225857=a42_0x27b1f6;if(_0xf0dafa===undefined)_0xf0dafa=_0x1ccc60;var _0x2bf2eb=Object['getOwnPropertyDescriptor'](_0x1e59e6,_0x1ccc60);(!_0x2bf2eb||(_0x225857(0x101)in _0x2bf2eb?!_0x1e59e6[_0x225857(0xe6)]:_0x2bf2eb[_0x225857(0x149)]||_0x2bf2eb[_0x225857(0xba)]))&&(_0x2bf2eb={'enumerable':!![],'get':function(){return _0x1e59e6[_0x1ccc60];}}),Object[_0x225857(0xf9)](_0x2b774d,_0xf0dafa,_0x2bf2eb);}:function(_0xb0d60b,_0x35f266,_0x2f9ecf,_0x32b330){if(_0x32b330===undefined)_0x32b330=_0x2f9ecf;_0xb0d60b[_0x32b330]=_0x35f266[_0x2f9ecf];}),__setModuleDefault=this&&this[a42_0x27b1f6(0xdb)]||(Object[a42_0x27b1f6(0x116)]?function(_0x471295,_0x435c50){const _0x23f0df=a42_0x27b1f6;Object['defineProperty'](_0x471295,_0x23f0df(0x132),{'enumerable':!![],'value':_0x435c50});}:function(_0x1ef379,_0x4aeed4){const _0x1a16fb=a42_0x27b1f6;_0x1ef379[_0x1a16fb(0x132)]=_0x4aeed4;}),__importStar=this&&this[a42_0x27b1f6(0xc4)]||(function(){var _0xdf458e=function(_0x239b8f){const _0x3b3e80=a42_0x3a90;return _0xdf458e=Object[_0x3b3e80(0xe4)]||function(_0x1dd18a){const _0x33ebf4=_0x3b3e80;var _0x3ced91=[];for(var _0x3bff9d in _0x1dd18a)if(Object[_0x33ebf4(0x14c)]['hasOwnProperty'][_0x33ebf4(0xd3)](_0x1dd18a,_0x3bff9d))_0x3ced91[_0x3ced91['length']]=_0x3bff9d;return _0x3ced91;},_0xdf458e(_0x239b8f);};return function(_0x24136a){const _0x230050=a42_0x3a90;if(_0x24136a&&_0x24136a['__esModule'])return _0x24136a;var _0x290f31={};if(_0x24136a!=null){for(var _0x57bc69=_0xdf458e(_0x24136a),_0x382803=0x0;_0x382803<_0x57bc69[_0x230050(0xf2)];_0x382803++)if(_0x57bc69[_0x382803]!==_0x230050(0x132))__createBinding(_0x290f31,_0x24136a,_0x57bc69[_0x382803]);}return __setModuleDefault(_0x290f31,_0x24136a),_0x290f31;};}());Object[a42_0x27b1f6(0xf9)](exports,a42_0x27b1f6(0xe6),{'value':!![]}),exports[a42_0x27b1f6(0x144)]=void 0x0;const loggerService_1=require(a42_0x27b1f6(0x11d));function a42_0x3a90(_0x9b926c,_0x7ca100){const _0x176cc7=a42_0x176c();return a42_0x3a90=function(_0x3a9090,_0x3cd57a){_0x3a9090=_0x3a9090-0xb7;let _0x33bdac=_0x176cc7[_0x3a9090];return _0x33bdac;},a42_0x3a90(_0x9b926c,_0x7ca100);}class KlymeService{constructor(){const _0x79ee24=a42_0x27b1f6;this['apiUrl']=_0x79ee24(0xd6),console[_0x79ee24(0xfa)](_0x79ee24(0x13f));}[a42_0x27b1f6(0xcd)](_0x5a0306,_0x2f9292){const _0x3694ac=a42_0x27b1f6,_0x531631=_0x5a0306[_0x3694ac(0x11c)]();switch(_0x2f9292){case'EU':if(_0x531631!==_0x3694ac(0x102))throw new Error(_0x3694ac(0x10b)+_0x531631);break;case'GB':if(_0x531631!==_0x3694ac(0x10d))throw new Error(_0x3694ac(0xd2)+_0x531631);break;case'DE':if(_0x531631!==_0x3694ac(0x102))throw new Error(_0x3694ac(0xe8)+_0x531631);break;default:throw new Error(_0x3694ac(0xbb)+_0x2f9292);}}async['generateUniqueReference'](){const _0x2332f8=a42_0x27b1f6,_0x21b8e8=(await Promise[_0x2332f8(0xef)]()[_0x2332f8(0x12a)](()=>__importStar(require(_0x2332f8(0x125)))))[_0x2332f8(0x132)];let _0x33e3b2,_0xb15b4e=0x0;const _0x1fdb85=0xa;do{const _0x4a5d86=()=>{const _0x5a9026=_0x2332f8;return Math[_0x5a9026(0x12d)](Math[_0x5a9026(0x133)]()*0x5f5e100)[_0x5a9026(0x135)]()[_0x5a9026(0xe9)](0x8,'0');};_0x33e3b2=_0x4a5d86()+'-'+_0x4a5d86();const _0x4c63e0=await _0x21b8e8['payment'][_0x2332f8(0xf7)]({'where':{'gatewayOrderId':_0x33e3b2}});if(!_0x4c63e0)break;_0xb15b4e++,console['log'](_0x2332f8(0xc0)+_0x33e3b2+_0x2332f8(0xfb)+_0xb15b4e+')');}while(_0xb15b4e<_0x1fdb85);if(_0xb15b4e>=_0x1fdb85)throw new Error(_0x2332f8(0x14a));return _0x33e3b2;}async[a42_0x27b1f6(0xb7)](_0x3861c5){const _0x486015=a42_0x27b1f6,{orderId:_0x3aab5d,amount:_0xf03d2b,currency:_0x366dc0,region:_0x25017f}=_0x3861c5;if(_0x25017f!=='EU'&&_0x25017f!=='GB'&&_0x25017f!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x25017f);this['validateCurrencyForRegion'](_0x366dc0,_0x25017f);const _0x3c00c6=_0x366dc0['toUpperCase']();console[_0x486015(0xfa)](_0x486015(0x103)+_0x25017f+_0x486015(0xbe)+_0x3c00c6);const _0x42cd86=await this[_0x486015(0xf4)]();console[_0x486015(0xfa)](_0x486015(0x115)+_0x42cd86+_0x486015(0x126)+_0x25017f+')');const _0x47a840=_0x486015(0x119)+_0x3aab5d,_0x17960f={'amount':_0xf03d2b,'currency':_0x3c00c6,'redirectUrl':_0x47a840,'reference':_0x42cd86,'geo':_0x25017f},_0x26d250=Date[_0x486015(0x104)]();try{console['log'](_0x486015(0xf5)+_0x25017f+_0x486015(0xd9)),console[_0x486015(0xfa)]('URL:',this['apiUrl']),console['log'](_0x486015(0x121),JSON['stringify'](_0x17960f,null,0x2)),console[_0x486015(0xfa)](_0x486015(0xd5),_0x25017f),console[_0x486015(0xfa)]('Currency:',_0x3c00c6,'(validated\x20for\x20'+_0x25017f+')'),console[_0x486015(0xfa)](_0x486015(0x112),_0x42cd86,_0x486015(0xfd)),console[_0x486015(0xfa)]('Redirect\x20URL:',_0x47a840),loggerService_1[_0x486015(0xc9)][_0x486015(0xc5)](_0x486015(0xd0)+_0x25017f[_0x486015(0x11a)](),_0x486015(0x117),_0x486015(0xeb),_0x17960f);const _0x3853c6=await fetch(this['apiUrl'],{'method':'POST','headers':{'Content-Type':_0x486015(0x145),'Accept':_0x486015(0x145),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x17960f)}),_0x3362e8=Date[_0x486015(0x104)]()-_0x26d250;console[_0x486015(0xfa)](_0x486015(0xf5)+_0x25017f+_0x486015(0x140)),console[_0x486015(0xfa)](_0x486015(0x108),_0x3853c6['status']),console[_0x486015(0xfa)]('Status\x20Text:',_0x3853c6[_0x486015(0x139)]),console[_0x486015(0xfa)](_0x486015(0xb8),Object[_0x486015(0x147)](_0x3853c6[_0x486015(0x118)][_0x486015(0xe7)]())),console[_0x486015(0xfa)](_0x486015(0x12b),_0x3362e8+'ms');const _0x65dd08=await _0x3853c6[_0x486015(0x134)]();console[_0x486015(0xfa)](_0x486015(0x11f),_0x65dd08);if(!_0x3853c6['ok']){console['error'](_0x486015(0xf5)+_0x25017f+_0x486015(0x138)),console[_0x486015(0x141)]('HTTP\x20Status:',_0x3853c6[_0x486015(0xc8)]),console[_0x486015(0x141)](_0x486015(0xea),_0x65dd08),loggerService_1[_0x486015(0xc9)][_0x486015(0x13b)](_0x486015(0xd0)+_0x25017f[_0x486015(0x11a)](),'/create',_0x3853c6[_0x486015(0xc8)],_0x65dd08,_0x3362e8),loggerService_1[_0x486015(0xc9)][_0x486015(0xc2)](_0x486015(0xd0)+_0x25017f['toLowerCase'](),_0x486015(0x117),_0x486015(0x14d)+_0x3853c6[_0x486015(0xc8)]+':\x20'+_0x65dd08);throw new Error(_0x486015(0x143)+_0x3853c6['status']+_0x486015(0x107)+_0x65dd08);}let _0x384a8f;try{_0x384a8f=JSON['parse'](_0x65dd08);}catch(_0x3fa3a3){console['error'](_0x486015(0xcb),_0x3fa3a3),loggerService_1[_0x486015(0xc9)][_0x486015(0xc2)](_0x486015(0xd0)+_0x25017f[_0x486015(0x11a)](),'/create',_0x486015(0xc6)+_0x3fa3a3);throw new Error('Invalid\x20JSON\x20response\x20from\x20KLYME\x20'+_0x25017f+_0x486015(0xd7)+_0x65dd08);}console[_0x486015(0xfa)]('===\x20PARSED\x20KLYME\x20'+_0x25017f+_0x486015(0xf3)),console['log']('Parsed\x20Result:',JSON['stringify'](_0x384a8f,null,0x2)),loggerService_1[_0x486015(0xc9)][_0x486015(0x13b)](_0x486015(0xd0)+_0x25017f[_0x486015(0x11a)](),'/create',_0x3853c6[_0x486015(0xc8)],_0x384a8f,_0x3362e8);if(_0x384a8f[_0x486015(0x141)]||_0x384a8f['statusCode']){const _0x2eb993=_0x384a8f[_0x486015(0xb9)]||_0x384a8f[_0x486015(0x141)]||_0x486015(0x124)+_0x25017f+_0x486015(0xf6);console[_0x486015(0x141)](_0x486015(0xf5)+_0x25017f+'\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x486015(0x141)](_0x486015(0x12e),_0x2eb993),console[_0x486015(0x141)](_0x486015(0xda),_0x384a8f[_0x486015(0x110)]),loggerService_1[_0x486015(0xc9)][_0x486015(0xc2)]('klyme_'+_0x25017f[_0x486015(0x11a)](),'/create',_0x486015(0x142)+_0x2eb993);throw new Error('KLYME\x20'+_0x25017f+'\x20API\x20error:\x20'+_0x2eb993);}let _0x218e39,_0x558be1;if(_0x384a8f['uuid']&&_0x384a8f['redirect_url'])_0x218e39=_0x384a8f[_0x486015(0x148)],_0x558be1=_0x384a8f[_0x486015(0x13e)],console['log'](_0x486015(0xf5)+_0x25017f+_0x486015(0xc1)),console['log']('UUID:',_0x384a8f['uuid']),console['log'](_0x486015(0xcc),_0x384a8f['redirect_url']);else{if(_0x384a8f['authUrl'])_0x218e39=_0x42cd86,_0x558be1=_0x384a8f[_0x486015(0xff)],console[_0x486015(0xfa)](_0x486015(0xf5)+_0x25017f+'\x20SUCCESS\x20(Legacy\x20Format)\x20==='),console[_0x486015(0xfa)]('Auth\x20URL:',_0x384a8f[_0x486015(0xff)]),console[_0x486015(0xfa)]('Reference\x20Used\x20as\x20ID:',_0x42cd86);else{console[_0x486015(0x141)]('===\x20KLYME\x20'+_0x25017f+_0x486015(0x137)),console[_0x486015(0x141)](_0x486015(0x13d)),console[_0x486015(0x141)](_0x486015(0xec),_0x384a8f),loggerService_1['loggerService'][_0x486015(0xc2)](_0x486015(0xd0)+_0x25017f[_0x486015(0x11a)](),'/create',_0x486015(0x127));throw new Error(_0x486015(0x129)+_0x25017f+_0x486015(0x10e));}}return console['log'](_0x486015(0x14b),_0x3c00c6,'('+_0x25017f+'\x20validated)'),console['log'](_0x486015(0xde),_0x42cd86,'(8digits-8digits\x20format)'),console[_0x486015(0xfa)]('Geo\x20Parameter:',_0x25017f),{'gateway_payment_id':_0x218e39,'payment_url':_0x558be1};}catch(_0xd4f070){console[_0x486015(0x141)](_0x486015(0xf5)+_0x25017f+_0x486015(0xf8)),console[_0x486015(0x141)](_0x486015(0x10c),_0xd4f070),loggerService_1['loggerService'][_0x486015(0xc2)](_0x486015(0xd0)+_0x25017f[_0x486015(0x11a)](),'/create',_0xd4f070);if(_0xd4f070 instanceof Error){console[_0x486015(0x141)](_0x486015(0xbc),_0xd4f070[_0x486015(0xb9)]),console[_0x486015(0x141)](_0x486015(0x114),_0xd4f070[_0x486015(0xca)]);throw new Error(_0x486015(0x136)+_0x25017f+'\x20payment\x20link:\x20'+_0xd4f070['message']);}throw new Error(_0x486015(0x136)+_0x25017f+_0x486015(0xdc));}}async['verifyPayment'](_0x579b73,_0x5d1a34){const _0x2d7871=a42_0x27b1f6,_0x202f40=Date[_0x2d7871(0x104)]();try{const _0x4445e0={'gatewayPaymentId':_0x579b73,'geo':_0x5d1a34};loggerService_1[_0x2d7871(0xc9)]['logWhiteDomainRequest'](_0x2d7871(0xd0)+_0x5d1a34[_0x2d7871(0x11a)](),_0x2d7871(0xe2)+_0x579b73,_0x2d7871(0xeb),_0x4445e0);const _0x6bd424=await fetch(this[_0x2d7871(0x130)],{'method':_0x2d7871(0xeb),'headers':{'Content-Type':_0x2d7871(0x145),'User-Agent':_0x2d7871(0x12c)},'body':JSON['stringify'](_0x4445e0)}),_0x5c3ba8=Date[_0x2d7871(0x104)]()-_0x202f40;if(!_0x6bd424['ok']){const _0x43f429=await _0x6bd424['text']();loggerService_1[_0x2d7871(0xc9)]['logWhiteDomainResponse'](_0x2d7871(0xd0)+_0x5d1a34[_0x2d7871(0x11a)](),'/verify/'+_0x579b73,_0x6bd424[_0x2d7871(0xc8)],_0x43f429,_0x5c3ba8);throw new Error('HTTP\x20error!\x20status:\x20'+_0x6bd424['status']);}const _0x3a228b=await _0x6bd424[_0x2d7871(0xdd)]();loggerService_1[_0x2d7871(0xc9)][_0x2d7871(0x13b)](_0x2d7871(0xd0)+_0x5d1a34[_0x2d7871(0x11a)](),_0x2d7871(0xe2)+_0x579b73,_0x6bd424[_0x2d7871(0xc8)],_0x3a228b,_0x5c3ba8);if(_0x3a228b[_0x2d7871(0x141)]||_0x3a228b['statusCode']){loggerService_1[_0x2d7871(0xc9)][_0x2d7871(0xc2)](_0x2d7871(0xd0)+_0x5d1a34['toLowerCase'](),_0x2d7871(0xe2)+_0x579b73,'KLYME\x20'+_0x5d1a34+_0x2d7871(0x106)+(_0x3a228b['message']||_0x3a228b[_0x2d7871(0x141)]||_0x2d7871(0xbd)));throw new Error('KLYME\x20'+_0x5d1a34+_0x2d7871(0x106)+(_0x3a228b[_0x2d7871(0xb9)]||_0x3a228b[_0x2d7871(0x141)]||_0x2d7871(0xbd)));}let _0x4328c6='PENDING';return{'status':_0x4328c6};}catch(_0x36bc4f){console[_0x2d7871(0x141)]('KLYME\x20'+_0x5d1a34+'\x20payment\x20verification\x20error:',_0x36bc4f),loggerService_1['loggerService'][_0x2d7871(0xc2)](_0x2d7871(0xd0)+_0x5d1a34[_0x2d7871(0x11a)](),_0x2d7871(0xe2)+_0x579b73,_0x36bc4f);throw new Error(_0x2d7871(0x13a)+_0x5d1a34+_0x2d7871(0x123)+(_0x36bc4f instanceof Error?_0x36bc4f[_0x2d7871(0xb9)]:_0x2d7871(0xbd)));}}async[a42_0x27b1f6(0x120)](_0x2424a0){const _0x3ffb85=a42_0x27b1f6;console[_0x3ffb85(0xfa)]('Processing\x20KLYME\x20webhook:',_0x2424a0);let _0x5745c0=_0x3ffb85(0xe5);switch(_0x2424a0['status']?.[_0x3ffb85(0x11a)]()){case _0x3ffb85(0xd4):case _0x3ffb85(0xe1):case _0x3ffb85(0x128):case _0x3ffb85(0x105):case _0x3ffb85(0xfc):_0x5745c0=_0x3ffb85(0xc7);break;case'cancelled':case _0x3ffb85(0x113):case _0x3ffb85(0x100):case'error':case _0x3ffb85(0x10a):_0x5745c0='FAILED';break;case _0x3ffb85(0x13c):case _0x3ffb85(0x11e):_0x5745c0=_0x3ffb85(0x10f);break;case _0x3ffb85(0x11b):case'created':case'active':case'processing':case _0x3ffb85(0xed):default:_0x5745c0='PENDING';break;}return{'paymentId':_0x2424a0[_0x3ffb85(0x131)]||_0x2424a0[_0x3ffb85(0xce)]||_0x2424a0[_0x3ffb85(0xf1)],'status':_0x5745c0,'amount':_0x2424a0[_0x3ffb85(0xcf)],'currency':_0x2424a0[_0x3ffb85(0xf0)],'region':_0x2424a0[_0x3ffb85(0xbf)],'additionalInfo':{'payment_method':_0x2424a0[_0x3ffb85(0xee)],'transaction_id':_0x2424a0[_0x3ffb85(0xe3)]}};}}exports[a42_0x27b1f6(0x144)]=KlymeService;