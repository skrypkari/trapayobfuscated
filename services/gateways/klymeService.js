'use strict';function a44_0x3125(_0x44da4d,_0x543f87){const _0x853037=a44_0x8530();return a44_0x3125=function(_0x3125b2,_0x3efb3b){_0x3125b2=_0x3125b2-0x6a;let _0x31e7c6=_0x853037[_0x3125b2];return _0x31e7c6;},a44_0x3125(_0x44da4d,_0x543f87);}const a44_0x4dfc71=a44_0x3125;(function(_0x5de1dd,_0x4945f0){const _0x27df5a=a44_0x3125,_0x363739=_0x5de1dd();while(!![]){try{const _0x4f55eb=parseInt(_0x27df5a(0xa7))/0x1+parseInt(_0x27df5a(0x71))/0x2*(parseInt(_0x27df5a(0x83))/0x3)+-parseInt(_0x27df5a(0xa0))/0x4+parseInt(_0x27df5a(0xed))/0x5+-parseInt(_0x27df5a(0xa8))/0x6+-parseInt(_0x27df5a(0xc2))/0x7*(parseInt(_0x27df5a(0xf8))/0x8)+-parseInt(_0x27df5a(0x9b))/0x9;if(_0x4f55eb===_0x4945f0)break;else _0x363739['push'](_0x363739['shift']());}catch(_0x2977d1){_0x363739['push'](_0x363739['shift']());}}}(a44_0x8530,0xa0e46));var __createBinding=this&&this[a44_0x4dfc71(0x7f)]||(Object[a44_0x4dfc71(0x100)]?function(_0x1577a3,_0x1fe9bb,_0x13729f,_0x1a1f1e){const _0x4875a5=a44_0x4dfc71;if(_0x1a1f1e===undefined)_0x1a1f1e=_0x13729f;var _0x65c734=Object[_0x4875a5(0x6b)](_0x1fe9bb,_0x13729f);(!_0x65c734||(_0x4875a5(0xbf)in _0x65c734?!_0x1fe9bb['__esModule']:_0x65c734[_0x4875a5(0xf0)]||_0x65c734[_0x4875a5(0xd4)]))&&(_0x65c734={'enumerable':!![],'get':function(){return _0x1fe9bb[_0x13729f];}}),Object['defineProperty'](_0x1577a3,_0x1a1f1e,_0x65c734);}:function(_0x196983,_0x31107e,_0x17ca7d,_0x1b7df1){if(_0x1b7df1===undefined)_0x1b7df1=_0x17ca7d;_0x196983[_0x1b7df1]=_0x31107e[_0x17ca7d];}),__setModuleDefault=this&&this[a44_0x4dfc71(0xef)]||(Object[a44_0x4dfc71(0x100)]?function(_0x55963a,_0x1039d4){const _0x131f11=a44_0x4dfc71;Object[_0x131f11(0xb9)](_0x55963a,_0x131f11(0xf4),{'enumerable':!![],'value':_0x1039d4});}:function(_0x346aad,_0x136db4){_0x346aad['default']=_0x136db4;}),__importStar=this&&this[a44_0x4dfc71(0xcd)]||(function(){var _0x381a72=function(_0x338f22){const _0x36a78f=a44_0x3125;return _0x381a72=Object[_0x36a78f(0x75)]||function(_0x1abc8c){var _0x18b83f=[];for(var _0x1dfa12 in _0x1abc8c)if(Object['prototype']['hasOwnProperty']['call'](_0x1abc8c,_0x1dfa12))_0x18b83f[_0x18b83f['length']]=_0x1dfa12;return _0x18b83f;},_0x381a72(_0x338f22);};return function(_0x4176e5){const _0x5bd205=a44_0x3125;if(_0x4176e5&&_0x4176e5[_0x5bd205(0xc5)])return _0x4176e5;var _0x46e15c={};if(_0x4176e5!=null){for(var _0x24c580=_0x381a72(_0x4176e5),_0x1728f0=0x0;_0x1728f0<_0x24c580[_0x5bd205(0x93)];_0x1728f0++)if(_0x24c580[_0x1728f0]!==_0x5bd205(0xf4))__createBinding(_0x46e15c,_0x4176e5,_0x24c580[_0x1728f0]);}return __setModuleDefault(_0x46e15c,_0x4176e5),_0x46e15c;};}());Object[a44_0x4dfc71(0xb9)](exports,a44_0x4dfc71(0xc5),{'value':!![]}),exports['KlymeService']=void 0x0;function a44_0x8530(){const _0x5a3671=['payment_id','toLowerCase','timeout','create','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','getOwnPropertyDescriptor','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Failed\x20to\x20create\x20KLYME\x20','text','in_progress','Error\x20Message:','36070mEjiqp','Response\x20Body:','fromEntries','resolve','getOwnPropertyNames','authUrl','toUpperCase','\x20API\x20BUSINESS\x20ERROR\x20===','currency','Raw\x20Response\x20Body:','createPaymentLink','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','headers','🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20','__createBinding','error','successful','Error\x20details:','177rxuYoX','Reference\x20Used\x20as\x20ID:','message','order_id','then','statusCode','Currency:','/verify/','⚠️\x20KLYME\x20reference\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Error\x20stack:','processing','\x20payment:\x20','POST','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','===\x20PARSED\x20KLYME\x20','length','reference','Currency\x20Used:','cancelled','canceled','EUR','statusText','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','11040318wAGpKD','TesSoft\x20Payment\x20System/1.0','\x20SUCCESS\x20(Legacy\x20Format)\x20===','active','Parsed\x20Result:','110064UHShmw','region','Failed\x20to\x20parse\x20JSON\x20response:','===\x20KLYME\x20','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','payment_method','\x20API:\x20missing\x20payment\x20data','1217395xxTZas','2483256RsfqJG','stringify','KLYME\x20','Geo\x20Parameter:','logWhiteDomainRequest','\x20API:\x20','Unknown\x20error\x20from\x20KLYME\x20','Error\x20message:','\x20API\x20ERROR\x20===','application/json','rejected','Status\x20Text:','Auth\x20URL:','json','random','\x20SUCCESS\x20(New\x20Format)\x20===','completed','defineProperty','uuid','\x20API','Region\x20(geo):','status','PENDING','get','failed','klyme_','1169dMvulQ','redirect_url','(8digits-8digits\x20format)','__esModule','logWhiteDomainError','/create','entries','https://tesoft.uk/gateway/pending.php?id=','loggerService','Headers:','generateUniqueReference','__importStar','Unknown\x20error','findFirst','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','\x20API\x20error:\x20','FAILED','PAID','configurable','apiUrl','\x20payment\x20link:\x20Unknown\x20error','Processing\x20KLYME\x20webhook:','URL:','HTTP\x20error!\x20status:\x20','floor','EXPIRED',',\x20body:\x20','\x20currency\x20validation\x20passed:\x20','HTTP\x20','pending','Reference:','\x20SERVICE\x20ERROR\x20===','💳\x20KLYME\x20','../loggerService','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','now','Unsupported\x20KLYME\x20region:\x20','\x20payment\x20link:\x20','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','log','padStart','Redirect\x20URL:','Request\x20Body:','4171110IUirwd','GBP','__setModuleDefault','writable','transaction_id','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','logWhiteDomainResponse','default','Reference\x20Used:','toString','validateCurrencyForRegion','37776gmwVmn','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','HTTP\x20Status:','Invalid\x20response\x20from\x20KLYME\x20','Status:'];a44_0x8530=function(){return _0x5a3671;};return a44_0x8530();}const loggerService_1=require(a44_0x4dfc71(0xe3));class KlymeService{constructor(){const _0x479491=a44_0x4dfc71;this[_0x479491(0xd5)]='https://tesoft.uk/gateway/klyme/',console[_0x479491(0xe9)](_0x479491(0x9a));}['validateCurrencyForRegion'](_0x490a0e,_0x86367b){const _0x749fc5=a44_0x4dfc71,_0x27c007=_0x490a0e[_0x749fc5(0x77)]();switch(_0x86367b){case'EU':if(_0x27c007!==_0x749fc5(0x98))throw new Error(_0x749fc5(0x8c)+_0x27c007);break;case'GB':if(_0x27c007!==_0x749fc5(0xee))throw new Error(_0x749fc5(0xd0)+_0x27c007);break;case'DE':if(_0x27c007!==_0x749fc5(0x98))throw new Error(_0x749fc5(0xf2)+_0x27c007);break;default:throw new Error(_0x749fc5(0xe6)+_0x86367b);}}async[a44_0x4dfc71(0xcc)](){const _0x35eedd=a44_0x4dfc71,_0x3cfcf0=(await Promise[_0x35eedd(0x74)]()[_0x35eedd(0x87)](()=>__importStar(require('../../config/database'))))[_0x35eedd(0xf4)];let _0x2663fd,_0x615cc=0x0;const _0x43487e=0xa;do{const _0x4e10fe=()=>{const _0x1cccf2=_0x35eedd;return Math[_0x1cccf2(0xda)](Math[_0x1cccf2(0xb6)]()*0x5f5e100)[_0x1cccf2(0xf6)]()[_0x1cccf2(0xea)](0x8,'0');};_0x2663fd=_0x4e10fe()+'-'+_0x4e10fe();const _0xefd1be=await _0x3cfcf0['payment'][_0x35eedd(0xcf)]({'where':{'gatewayOrderId':_0x2663fd}});if(!_0xefd1be)break;_0x615cc++,console[_0x35eedd(0xe9)](_0x35eedd(0x8b)+_0x2663fd+_0x35eedd(0x91)+_0x615cc+')');}while(_0x615cc<_0x43487e);if(_0x615cc>=_0x43487e)throw new Error(_0x35eedd(0x7c));return _0x2663fd;}async[a44_0x4dfc71(0x7b)](_0x51b405){const _0x534bd9=a44_0x4dfc71,{orderId:_0x7035f1,amount:_0xcb365e,currency:_0x6819c4,region:_0x157c47}=_0x51b405;if(_0x157c47!=='EU'&&_0x157c47!=='GB'&&_0x157c47!=='DE')throw new Error(_0x534bd9(0xe8)+_0x157c47);this[_0x534bd9(0xf7)](_0x6819c4,_0x157c47);const _0x370870=_0x6819c4[_0x534bd9(0x77)]();console[_0x534bd9(0xe9)](_0x534bd9(0xe2)+_0x157c47+_0x534bd9(0xdd)+_0x370870);const _0x2bd697=await this[_0x534bd9(0xcc)]();console[_0x534bd9(0xe9)](_0x534bd9(0x7e)+_0x2bd697+'\x20(8digits-8digits\x20format\x20for\x20'+_0x157c47+')');const _0x3967e8=_0x534bd9(0xc9)+_0x7035f1,_0x56a700={'amount':_0xcb365e,'currency':_0x370870,'redirectUrl':_0x3967e8,'reference':_0x2bd697,'geo':_0x157c47},_0x5ebdf6=Date[_0x534bd9(0xe5)]();try{console[_0x534bd9(0xe9)](_0x534bd9(0xa3)+_0x157c47+_0x534bd9(0xe4)),console['log'](_0x534bd9(0xd8),this[_0x534bd9(0xd5)]),console[_0x534bd9(0xe9)](_0x534bd9(0xec),JSON[_0x534bd9(0xa9)](_0x56a700,null,0x2)),console[_0x534bd9(0xe9)](_0x534bd9(0xbc),_0x157c47),console['log'](_0x534bd9(0x89),_0x370870,'(validated\x20for\x20'+_0x157c47+')'),console['log'](_0x534bd9(0xe0),_0x2bd697,_0x534bd9(0xc4)),console['log'](_0x534bd9(0xeb),_0x3967e8),loggerService_1['loggerService'][_0x534bd9(0xac)](_0x534bd9(0xc1)+_0x157c47['toLowerCase'](),_0x534bd9(0xc7),_0x534bd9(0x90),_0x56a700);const _0x5e2f8a=await fetch(this[_0x534bd9(0xd5)],{'method':_0x534bd9(0x90),'headers':{'Content-Type':_0x534bd9(0xb1),'Accept':_0x534bd9(0xb1),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x534bd9(0xa9)](_0x56a700)}),_0x4457b7=Date[_0x534bd9(0xe5)]()-_0x5ebdf6;console[_0x534bd9(0xe9)](_0x534bd9(0xa3)+_0x157c47+_0x534bd9(0xa4)),console['log'](_0x534bd9(0xfc),_0x5e2f8a['status']),console['log'](_0x534bd9(0xb3),_0x5e2f8a[_0x534bd9(0x99)]),console[_0x534bd9(0xe9)](_0x534bd9(0xcb),Object[_0x534bd9(0x73)](_0x5e2f8a[_0x534bd9(0x7d)][_0x534bd9(0xc8)]())),console[_0x534bd9(0xe9)]('Response\x20Time:',_0x4457b7+'ms');const _0x58d58f=await _0x5e2f8a[_0x534bd9(0x6e)]();console['log'](_0x534bd9(0x7a),_0x58d58f);if(!_0x5e2f8a['ok']){console[_0x534bd9(0x80)](_0x534bd9(0xa3)+_0x157c47+_0x534bd9(0xb0)),console[_0x534bd9(0x80)](_0x534bd9(0xfa),_0x5e2f8a['status']),console[_0x534bd9(0x80)](_0x534bd9(0x72),_0x58d58f),loggerService_1['loggerService'][_0x534bd9(0xf3)](_0x534bd9(0xc1)+_0x157c47['toLowerCase'](),_0x534bd9(0xc7),_0x5e2f8a['status'],_0x58d58f,_0x4457b7),loggerService_1[_0x534bd9(0xca)]['logWhiteDomainError']('klyme_'+_0x157c47[_0x534bd9(0xfe)](),_0x534bd9(0xc7),_0x534bd9(0xde)+_0x5e2f8a[_0x534bd9(0xbd)]+':\x20'+_0x58d58f);throw new Error(_0x534bd9(0xd9)+_0x5e2f8a[_0x534bd9(0xbd)]+_0x534bd9(0xdc)+_0x58d58f);}let _0x5af8de;try{_0x5af8de=JSON['parse'](_0x58d58f);}catch(_0x542b98){console[_0x534bd9(0x80)](_0x534bd9(0xa2),_0x542b98),loggerService_1['loggerService'][_0x534bd9(0xc6)]('klyme_'+_0x157c47[_0x534bd9(0xfe)](),_0x534bd9(0xc7),'JSON\x20Parse\x20Error:\x20'+_0x542b98);throw new Error(_0x534bd9(0xf9)+_0x157c47+_0x534bd9(0xad)+_0x58d58f);}console[_0x534bd9(0xe9)](_0x534bd9(0x92)+_0x157c47+'\x20RESPONSE\x20==='),console[_0x534bd9(0xe9)](_0x534bd9(0x9f),JSON['stringify'](_0x5af8de,null,0x2)),loggerService_1['loggerService'][_0x534bd9(0xf3)](_0x534bd9(0xc1)+_0x157c47[_0x534bd9(0xfe)](),_0x534bd9(0xc7),_0x5e2f8a[_0x534bd9(0xbd)],_0x5af8de,_0x4457b7);if(_0x5af8de[_0x534bd9(0x80)]||_0x5af8de[_0x534bd9(0x88)]){const _0x43cc23=_0x5af8de['message']||_0x5af8de[_0x534bd9(0x80)]||_0x534bd9(0xae)+_0x157c47+_0x534bd9(0xbb);console[_0x534bd9(0x80)](_0x534bd9(0xa3)+_0x157c47+_0x534bd9(0x78)),console['error'](_0x534bd9(0x70),_0x43cc23),console[_0x534bd9(0x80)]('Status\x20Code:',_0x5af8de['statusCode']),loggerService_1['loggerService'][_0x534bd9(0xc6)]('klyme_'+_0x157c47[_0x534bd9(0xfe)](),_0x534bd9(0xc7),'Business\x20Error:\x20'+_0x43cc23);throw new Error(_0x534bd9(0xaa)+_0x157c47+'\x20API\x20error:\x20'+_0x43cc23);}let _0xe37ada,_0x2b5ada;if(_0x5af8de[_0x534bd9(0xba)]&&_0x5af8de['redirect_url'])_0xe37ada=_0x5af8de[_0x534bd9(0xba)],_0x2b5ada=_0x5af8de['redirect_url'],console['log'](_0x534bd9(0xa3)+_0x157c47+_0x534bd9(0xb7)),console['log']('UUID:',_0x5af8de['uuid']),console[_0x534bd9(0xe9)](_0x534bd9(0xeb),_0x5af8de[_0x534bd9(0xc3)]);else{if(_0x5af8de[_0x534bd9(0x76)])_0xe37ada=_0x2bd697,_0x2b5ada=_0x5af8de[_0x534bd9(0x76)],console[_0x534bd9(0xe9)](_0x534bd9(0xa3)+_0x157c47+_0x534bd9(0x9d)),console[_0x534bd9(0xe9)](_0x534bd9(0xb4),_0x5af8de[_0x534bd9(0x76)]),console[_0x534bd9(0xe9)](_0x534bd9(0x84),_0x2bd697);else{console[_0x534bd9(0x80)](_0x534bd9(0xa3)+_0x157c47+_0x534bd9(0x6c)),console[_0x534bd9(0x80)](_0x534bd9(0x6a)),console[_0x534bd9(0x80)]('Response\x20data:',_0x5af8de),loggerService_1['loggerService'][_0x534bd9(0xc6)]('klyme_'+_0x157c47[_0x534bd9(0xfe)](),_0x534bd9(0xc7),'Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl');throw new Error(_0x534bd9(0xfb)+_0x157c47+_0x534bd9(0xa6));}}return console[_0x534bd9(0xe9)](_0x534bd9(0x95),_0x370870,'('+_0x157c47+'\x20validated)'),console[_0x534bd9(0xe9)](_0x534bd9(0xf5),_0x2bd697,_0x534bd9(0xc4)),console[_0x534bd9(0xe9)](_0x534bd9(0xab),_0x157c47),{'gateway_payment_id':_0xe37ada,'payment_url':_0x2b5ada};}catch(_0x47854d){console[_0x534bd9(0x80)](_0x534bd9(0xa3)+_0x157c47+_0x534bd9(0xe1)),console['error'](_0x534bd9(0x82),_0x47854d),loggerService_1[_0x534bd9(0xca)][_0x534bd9(0xc6)](_0x534bd9(0xc1)+_0x157c47[_0x534bd9(0xfe)](),'/create',_0x47854d);if(_0x47854d instanceof Error){console['error'](_0x534bd9(0xaf),_0x47854d[_0x534bd9(0x85)]),console[_0x534bd9(0x80)](_0x534bd9(0x8d),_0x47854d['stack']);throw new Error(_0x534bd9(0x6d)+_0x157c47+_0x534bd9(0xe7)+_0x47854d['message']);}throw new Error(_0x534bd9(0x6d)+_0x157c47+_0x534bd9(0xd6));}}async['verifyPayment'](_0x18fb07,_0x28f8f5){const _0x33bef4=a44_0x4dfc71,_0x5859a8=Date[_0x33bef4(0xe5)]();try{const _0x4b2b68={'gatewayPaymentId':_0x18fb07,'geo':_0x28f8f5};loggerService_1[_0x33bef4(0xca)][_0x33bef4(0xac)]('klyme_'+_0x28f8f5[_0x33bef4(0xfe)](),_0x33bef4(0x8a)+_0x18fb07,_0x33bef4(0x90),_0x4b2b68);const _0x26e6f5=await fetch(this['apiUrl'],{'method':_0x33bef4(0x90),'headers':{'Content-Type':_0x33bef4(0xb1),'User-Agent':_0x33bef4(0x9c)},'body':JSON[_0x33bef4(0xa9)](_0x4b2b68)}),_0x3466ff=Date['now']()-_0x5859a8;if(!_0x26e6f5['ok']){const _0x43bd04=await _0x26e6f5['text']();loggerService_1[_0x33bef4(0xca)][_0x33bef4(0xf3)](_0x33bef4(0xc1)+_0x28f8f5[_0x33bef4(0xfe)](),'/verify/'+_0x18fb07,_0x26e6f5[_0x33bef4(0xbd)],_0x43bd04,_0x3466ff);throw new Error(_0x33bef4(0xd9)+_0x26e6f5[_0x33bef4(0xbd)]);}const _0x47b0d1=await _0x26e6f5[_0x33bef4(0xb5)]();loggerService_1['loggerService'][_0x33bef4(0xf3)](_0x33bef4(0xc1)+_0x28f8f5[_0x33bef4(0xfe)](),_0x33bef4(0x8a)+_0x18fb07,_0x26e6f5['status'],_0x47b0d1,_0x3466ff);if(_0x47b0d1['error']||_0x47b0d1[_0x33bef4(0x88)]){loggerService_1['loggerService'][_0x33bef4(0xc6)]('klyme_'+_0x28f8f5[_0x33bef4(0xfe)](),_0x33bef4(0x8a)+_0x18fb07,_0x33bef4(0xaa)+_0x28f8f5+'\x20API\x20error:\x20'+(_0x47b0d1[_0x33bef4(0x85)]||_0x47b0d1[_0x33bef4(0x80)]||_0x33bef4(0xce)));throw new Error('KLYME\x20'+_0x28f8f5+_0x33bef4(0xd1)+(_0x47b0d1[_0x33bef4(0x85)]||_0x47b0d1[_0x33bef4(0x80)]||_0x33bef4(0xce)));}let _0x14cc09=_0x33bef4(0xbe);return{'status':_0x14cc09};}catch(_0x2442e3){console[_0x33bef4(0x80)](_0x33bef4(0xaa)+_0x28f8f5+'\x20payment\x20verification\x20error:',_0x2442e3),loggerService_1[_0x33bef4(0xca)][_0x33bef4(0xc6)](_0x33bef4(0xc1)+_0x28f8f5[_0x33bef4(0xfe)](),_0x33bef4(0x8a)+_0x18fb07,_0x2442e3);throw new Error('Failed\x20to\x20verify\x20KLYME\x20'+_0x28f8f5+_0x33bef4(0x8f)+(_0x2442e3 instanceof Error?_0x2442e3[_0x33bef4(0x85)]:_0x33bef4(0xce)));}}async['processWebhook'](_0x5e56f1){const _0x104406=a44_0x4dfc71;console[_0x104406(0xe9)](_0x104406(0xd7),_0x5e56f1);let _0x451ff6=_0x104406(0xbe);switch(_0x5e56f1['status']?.[_0x104406(0xfe)]()){case'paid':case _0x104406(0xb8):case'confirmed':case'success':case _0x104406(0x81):_0x451ff6=_0x104406(0xd3);break;case _0x104406(0x96):case _0x104406(0x97):case _0x104406(0xc0):case _0x104406(0x80):case _0x104406(0xb2):_0x451ff6=_0x104406(0xd2);break;case'expired':case _0x104406(0xff):_0x451ff6=_0x104406(0xdb);break;case _0x104406(0xdf):case'created':case _0x104406(0x9e):case _0x104406(0x8e):case _0x104406(0x6f):default:_0x451ff6='PENDING';break;}return{'paymentId':_0x5e56f1[_0x104406(0x94)]||_0x5e56f1[_0x104406(0x86)]||_0x5e56f1[_0x104406(0xfd)],'status':_0x451ff6,'amount':_0x5e56f1['amount'],'currency':_0x5e56f1[_0x104406(0x79)],'region':_0x5e56f1[_0x104406(0xa1)],'additionalInfo':{'payment_method':_0x5e56f1[_0x104406(0xa5)],'transaction_id':_0x5e56f1[_0x104406(0xf1)]}};}}exports['KlymeService']=KlymeService;