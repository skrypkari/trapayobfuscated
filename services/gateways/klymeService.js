'use strict';function a39_0xb18a(_0x5da6ac,_0x5898c2){const _0x138aca=a39_0x138a();return a39_0xb18a=function(_0xb18ab9,_0x541472){_0xb18ab9=_0xb18ab9-0x10d;let _0x23bfff=_0x138aca[_0xb18ab9];return _0x23bfff;},a39_0xb18a(_0x5da6ac,_0x5898c2);}const a39_0x39b0e4=a39_0xb18a;(function(_0x4f84ac,_0x17faa1){const _0x1c790a=a39_0xb18a,_0x5e443e=_0x4f84ac();while(!![]){try{const _0x166478=parseInt(_0x1c790a(0x165))/0x1+parseInt(_0x1c790a(0x185))/0x2*(-parseInt(_0x1c790a(0x137))/0x3)+-parseInt(_0x1c790a(0x169))/0x4*(parseInt(_0x1c790a(0x17a))/0x5)+-parseInt(_0x1c790a(0x157))/0x6+parseInt(_0x1c790a(0x146))/0x7*(-parseInt(_0x1c790a(0x12e))/0x8)+-parseInt(_0x1c790a(0x110))/0x9+parseInt(_0x1c790a(0x133))/0xa*(parseInt(_0x1c790a(0x156))/0xb);if(_0x166478===_0x17faa1)break;else _0x5e443e['push'](_0x5e443e['shift']());}catch(_0x1bad2e){_0x5e443e['push'](_0x5e443e['shift']());}}}(a39_0x138a,0xb2fa1));var __createBinding=this&&this[a39_0x39b0e4(0x192)]||(Object[a39_0x39b0e4(0x138)]?function(_0x7aabeb,_0x1fd6e0,_0x5dc13d,_0xe8e2b){const _0xe3a2da=a39_0x39b0e4;if(_0xe8e2b===undefined)_0xe8e2b=_0x5dc13d;var _0x2c2aef=Object['getOwnPropertyDescriptor'](_0x1fd6e0,_0x5dc13d);(!_0x2c2aef||(_0xe3a2da(0x134)in _0x2c2aef?!_0x1fd6e0[_0xe3a2da(0x17e)]:_0x2c2aef['writable']||_0x2c2aef[_0xe3a2da(0x16d)]))&&(_0x2c2aef={'enumerable':!![],'get':function(){return _0x1fd6e0[_0x5dc13d];}}),Object['defineProperty'](_0x7aabeb,_0xe8e2b,_0x2c2aef);}:function(_0x1e7d6d,_0x28c63a,_0x57eac9,_0xb3aecf){if(_0xb3aecf===undefined)_0xb3aecf=_0x57eac9;_0x1e7d6d[_0xb3aecf]=_0x28c63a[_0x57eac9];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a39_0x39b0e4(0x138)]?function(_0xa11251,_0x177a4b){const _0x4316aa=a39_0x39b0e4;Object[_0x4316aa(0x125)](_0xa11251,_0x4316aa(0x186),{'enumerable':!![],'value':_0x177a4b});}:function(_0x2db6db,_0x5dab97){const _0x3d0c32=a39_0x39b0e4;_0x2db6db[_0x3d0c32(0x186)]=_0x5dab97;}),__importStar=this&&this[a39_0x39b0e4(0x18d)]||(function(){var _0x6da5ce=function(_0x3d5837){return _0x6da5ce=Object['getOwnPropertyNames']||function(_0x1e79ab){const _0x4fd16a=a39_0xb18a;var _0x5a77c2=[];for(var _0x5d9fc8 in _0x1e79ab)if(Object[_0x4fd16a(0x17f)]['hasOwnProperty']['call'](_0x1e79ab,_0x5d9fc8))_0x5a77c2[_0x5a77c2[_0x4fd16a(0x173)]]=_0x5d9fc8;return _0x5a77c2;},_0x6da5ce(_0x3d5837);};return function(_0x31474d){const _0x1fd147=a39_0xb18a;if(_0x31474d&&_0x31474d[_0x1fd147(0x17e)])return _0x31474d;var _0x14573a={};if(_0x31474d!=null){for(var _0x2ae4cb=_0x6da5ce(_0x31474d),_0x462112=0x0;_0x462112<_0x2ae4cb[_0x1fd147(0x173)];_0x462112++)if(_0x2ae4cb[_0x462112]!=='default')__createBinding(_0x14573a,_0x31474d,_0x2ae4cb[_0x462112]);}return __setModuleDefault(_0x14573a,_0x31474d),_0x14573a;};}());Object[a39_0x39b0e4(0x125)](exports,a39_0x39b0e4(0x17e),{'value':!![]}),exports['KlymeService']=void 0x0;const loggerService_1=require('../loggerService');class KlymeService{constructor(){const _0x380a52=a39_0x39b0e4;this[_0x380a52(0x11d)]='https://tesoft.uk/gateway/klyme/',console[_0x380a52(0x195)](_0x380a52(0x112));}['validateCurrencyForRegion'](_0x5a159c,_0x47db5f){const _0x405e08=a39_0x39b0e4,_0x1a1a3e=_0x5a159c[_0x405e08(0x132)]();switch(_0x47db5f){case'EU':if(_0x1a1a3e!==_0x405e08(0x16a))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x1a1a3e);break;case'GB':if(_0x1a1a3e!==_0x405e08(0x188))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x1a1a3e);break;case'DE':if(_0x1a1a3e!==_0x405e08(0x16a))throw new Error(_0x405e08(0x18b)+_0x1a1a3e);break;default:throw new Error(_0x405e08(0x175)+_0x47db5f);}}async[a39_0x39b0e4(0x14e)](){const _0x24ea6e=a39_0x39b0e4,_0x57663e=(await Promise[_0x24ea6e(0x18c)]()[_0x24ea6e(0x113)](()=>__importStar(require(_0x24ea6e(0x16f)))))[_0x24ea6e(0x186)];let _0x11a0ed,_0x322f60=0x0;const _0x46c25f=0xa;do{const _0xaf853d=()=>{const _0x276c66=_0x24ea6e;return Math[_0x276c66(0x16c)](Math[_0x276c66(0x14d)]()*0x5f5e100)[_0x276c66(0x10e)]()[_0x276c66(0x18f)](0x8,'0');};_0x11a0ed=_0xaf853d()+'-'+_0xaf853d();const _0x1ec752=await _0x57663e['payment'][_0x24ea6e(0x18e)]({'where':{'gatewayOrderId':_0x11a0ed}});if(!_0x1ec752)break;_0x322f60++,console['log']('‚ö†Ô∏è\x20KLYME\x20reference\x20'+_0x11a0ed+_0x24ea6e(0x179)+_0x322f60+')');}while(_0x322f60<_0x46c25f);if(_0x322f60>=_0x46c25f)throw new Error(_0x24ea6e(0x124));return _0x11a0ed;}async[a39_0x39b0e4(0x18a)](_0x20772b){const _0x2247b0=a39_0x39b0e4,{orderId:_0x52b763,amount:_0x3cb1fb,currency:_0x4596e1,region:_0x4d167f}=_0x20772b;if(_0x4d167f!=='EU'&&_0x4d167f!=='GB'&&_0x4d167f!=='DE')throw new Error(_0x2247b0(0x12c)+_0x4d167f);this[_0x2247b0(0x11e)](_0x4596e1,_0x4d167f);const _0x1c0db0=_0x4596e1[_0x2247b0(0x132)]();console['log']('üí≥\x20KLYME\x20'+_0x4d167f+_0x2247b0(0x17c)+_0x1c0db0);const _0x66c2be=await this[_0x2247b0(0x14e)]();console[_0x2247b0(0x195)]('üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20'+_0x66c2be+_0x2247b0(0x111)+_0x4d167f+')');const _0x19356c='https://tesoft.uk/gateway/pending.php?id='+_0x52b763,_0x26d674={'amount':_0x3cb1fb,'currency':_0x1c0db0,'redirectUrl':_0x19356c,'reference':_0x66c2be,'geo':_0x4d167f},_0x3a2882=Date[_0x2247b0(0x16e)]();try{console[_0x2247b0(0x195)](_0x2247b0(0x136)+_0x4d167f+_0x2247b0(0x122)),console[_0x2247b0(0x195)](_0x2247b0(0x155),this[_0x2247b0(0x11d)]),console['log']('Request\x20Body:',JSON[_0x2247b0(0x130)](_0x26d674,null,0x2)),console[_0x2247b0(0x195)](_0x2247b0(0x154),_0x4d167f),console[_0x2247b0(0x195)](_0x2247b0(0x180),_0x1c0db0,'(validated\x20for\x20'+_0x4d167f+')'),console['log'](_0x2247b0(0x15e),_0x66c2be,_0x2247b0(0x174)),console[_0x2247b0(0x195)]('Redirect\x20URL:',_0x19356c),loggerService_1[_0x2247b0(0x191)]['logWhiteDomainRequest'](_0x2247b0(0x129)+_0x4d167f[_0x2247b0(0x17b)](),_0x2247b0(0x114),_0x2247b0(0x142),_0x26d674);const _0x42b3f3=await fetch(this[_0x2247b0(0x11d)],{'method':_0x2247b0(0x142),'headers':{'Content-Type':_0x2247b0(0x162),'Accept':_0x2247b0(0x162),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x2247b0(0x130)](_0x26d674)}),_0xbee247=Date[_0x2247b0(0x16e)]()-_0x3a2882;console[_0x2247b0(0x195)](_0x2247b0(0x136)+_0x4d167f+_0x2247b0(0x10f)),console[_0x2247b0(0x195)](_0x2247b0(0x15d),_0x42b3f3[_0x2247b0(0x178)]),console[_0x2247b0(0x195)](_0x2247b0(0x119),_0x42b3f3[_0x2247b0(0x13d)]),console[_0x2247b0(0x195)](_0x2247b0(0x11b),Object['fromEntries'](_0x42b3f3[_0x2247b0(0x143)][_0x2247b0(0x171)]())),console['log'](_0x2247b0(0x181),_0xbee247+'ms');const _0x1010eb=await _0x42b3f3[_0x2247b0(0x121)]();console['log'](_0x2247b0(0x152),_0x1010eb);if(!_0x42b3f3['ok']){console[_0x2247b0(0x15f)](_0x2247b0(0x136)+_0x4d167f+_0x2247b0(0x13e)),console['error'](_0x2247b0(0x160),_0x42b3f3['status']),console['error'](_0x2247b0(0x15b),_0x1010eb),loggerService_1['loggerService'][_0x2247b0(0x141)](_0x2247b0(0x129)+_0x4d167f['toLowerCase'](),'/create',_0x42b3f3[_0x2247b0(0x178)],_0x1010eb,_0xbee247),loggerService_1[_0x2247b0(0x191)]['logWhiteDomainError'](_0x2247b0(0x129)+_0x4d167f[_0x2247b0(0x17b)](),_0x2247b0(0x114),_0x2247b0(0x13a)+_0x42b3f3['status']+':\x20'+_0x1010eb);throw new Error(_0x2247b0(0x139)+_0x42b3f3[_0x2247b0(0x178)]+_0x2247b0(0x11c)+_0x1010eb);}let _0x2a18a8;try{_0x2a18a8=JSON[_0x2247b0(0x159)](_0x1010eb);}catch(_0x4752b9){console[_0x2247b0(0x15f)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x4752b9),loggerService_1['loggerService']['logWhiteDomainError']('klyme_'+_0x4d167f[_0x2247b0(0x17b)](),'/create',_0x2247b0(0x153)+_0x4752b9);throw new Error(_0x2247b0(0x148)+_0x4d167f+_0x2247b0(0x13c)+_0x1010eb);}console[_0x2247b0(0x195)](_0x2247b0(0x131)+_0x4d167f+'\x20RESPONSE\x20==='),console[_0x2247b0(0x195)](_0x2247b0(0x187),JSON[_0x2247b0(0x130)](_0x2a18a8,null,0x2)),loggerService_1['loggerService'][_0x2247b0(0x141)](_0x2247b0(0x129)+_0x4d167f[_0x2247b0(0x17b)](),_0x2247b0(0x114),_0x42b3f3[_0x2247b0(0x178)],_0x2a18a8,_0xbee247);if(_0x2a18a8['error']||_0x2a18a8[_0x2247b0(0x176)]){const _0x5de265=_0x2a18a8[_0x2247b0(0x126)]||_0x2a18a8[_0x2247b0(0x15f)]||_0x2247b0(0x11f)+_0x4d167f+'\x20API';console[_0x2247b0(0x15f)](_0x2247b0(0x136)+_0x4d167f+'\x20API\x20BUSINESS\x20ERROR\x20==='),console['error']('Error\x20Message:',_0x5de265),console[_0x2247b0(0x15f)](_0x2247b0(0x170),_0x2a18a8['statusCode']),loggerService_1[_0x2247b0(0x191)][_0x2247b0(0x197)]('klyme_'+_0x4d167f[_0x2247b0(0x17b)](),_0x2247b0(0x114),_0x2247b0(0x123)+_0x5de265);throw new Error('KLYME\x20'+_0x4d167f+_0x2247b0(0x167)+_0x5de265);}let _0x3183f6,_0x335110;if(_0x2a18a8[_0x2247b0(0x149)]&&_0x2a18a8[_0x2247b0(0x163)])_0x3183f6=_0x2a18a8[_0x2247b0(0x149)],_0x335110=_0x2a18a8[_0x2247b0(0x163)],console[_0x2247b0(0x195)](_0x2247b0(0x136)+_0x4d167f+_0x2247b0(0x198)),console[_0x2247b0(0x195)]('UUID:',_0x2a18a8[_0x2247b0(0x149)]),console[_0x2247b0(0x195)](_0x2247b0(0x12b),_0x2a18a8[_0x2247b0(0x163)]);else{if(_0x2a18a8[_0x2247b0(0x13f)])_0x3183f6=_0x66c2be,_0x335110=_0x2a18a8[_0x2247b0(0x13f)],console[_0x2247b0(0x195)]('===\x20KLYME\x20'+_0x4d167f+_0x2247b0(0x128)),console[_0x2247b0(0x195)](_0x2247b0(0x14b),_0x2a18a8['authUrl']),console['log'](_0x2247b0(0x116),_0x66c2be);else{console['error'](_0x2247b0(0x136)+_0x4d167f+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x2247b0(0x15f)](_0x2247b0(0x158)),console[_0x2247b0(0x15f)]('Response\x20data:',_0x2a18a8),loggerService_1[_0x2247b0(0x191)][_0x2247b0(0x197)]('klyme_'+_0x4d167f['toLowerCase'](),_0x2247b0(0x114),'Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl');throw new Error(_0x2247b0(0x183)+_0x4d167f+_0x2247b0(0x12f));}}return console[_0x2247b0(0x195)](_0x2247b0(0x117),_0x1c0db0,'('+_0x4d167f+_0x2247b0(0x177)),console[_0x2247b0(0x195)](_0x2247b0(0x140),_0x66c2be,_0x2247b0(0x174)),console[_0x2247b0(0x195)]('Geo\x20Parameter:',_0x4d167f),{'gateway_payment_id':_0x3183f6,'payment_url':_0x335110};}catch(_0x17b2fb){console[_0x2247b0(0x15f)](_0x2247b0(0x136)+_0x4d167f+_0x2247b0(0x194)),console['error'](_0x2247b0(0x166),_0x17b2fb),loggerService_1['loggerService'][_0x2247b0(0x197)](_0x2247b0(0x129)+_0x4d167f[_0x2247b0(0x17b)](),'/create',_0x17b2fb);if(_0x17b2fb instanceof Error){console[_0x2247b0(0x15f)]('Error\x20message:',_0x17b2fb[_0x2247b0(0x126)]),console[_0x2247b0(0x15f)](_0x2247b0(0x168),_0x17b2fb[_0x2247b0(0x150)]);throw new Error(_0x2247b0(0x161)+_0x4d167f+'\x20payment\x20link:\x20'+_0x17b2fb[_0x2247b0(0x126)]);}throw new Error(_0x2247b0(0x161)+_0x4d167f+_0x2247b0(0x120));}}async[a39_0x39b0e4(0x12a)](_0x5430ba,_0x2582ec){const _0x239090=a39_0x39b0e4,_0x5e3e2f=Date['now']();try{const _0x379e1b={'gatewayPaymentId':_0x5430ba,'geo':_0x2582ec};loggerService_1['loggerService']['logWhiteDomainRequest'](_0x239090(0x129)+_0x2582ec[_0x239090(0x17b)](),_0x239090(0x189)+_0x5430ba,_0x239090(0x142),_0x379e1b);const _0x23fc7c=await fetch(this[_0x239090(0x11d)],{'method':'POST','headers':{'Content-Type':_0x239090(0x162),'User-Agent':_0x239090(0x11a)},'body':JSON[_0x239090(0x130)](_0x379e1b)}),_0x24dc10=Date['now']()-_0x5e3e2f;if(!_0x23fc7c['ok']){const _0x13ac18=await _0x23fc7c[_0x239090(0x121)]();loggerService_1['loggerService'][_0x239090(0x141)](_0x239090(0x129)+_0x2582ec[_0x239090(0x17b)](),_0x239090(0x189)+_0x5430ba,_0x23fc7c[_0x239090(0x178)],_0x13ac18,_0x24dc10);throw new Error(_0x239090(0x139)+_0x23fc7c[_0x239090(0x178)]);}const _0x1a862a=await _0x23fc7c[_0x239090(0x164)]();loggerService_1[_0x239090(0x191)][_0x239090(0x141)](_0x239090(0x129)+_0x2582ec[_0x239090(0x17b)](),'/verify/'+_0x5430ba,_0x23fc7c[_0x239090(0x178)],_0x1a862a,_0x24dc10);if(_0x1a862a[_0x239090(0x15f)]||_0x1a862a[_0x239090(0x176)]){loggerService_1[_0x239090(0x191)][_0x239090(0x197)]('klyme_'+_0x2582ec[_0x239090(0x17b)](),'/verify/'+_0x5430ba,_0x239090(0x17d)+_0x2582ec+_0x239090(0x167)+(_0x1a862a[_0x239090(0x126)]||_0x1a862a['error']||_0x239090(0x184)));throw new Error('KLYME\x20'+_0x2582ec+_0x239090(0x167)+(_0x1a862a[_0x239090(0x126)]||_0x1a862a[_0x239090(0x15f)]||_0x239090(0x184)));}let _0xe0fd54=_0x239090(0x118);return{'status':_0xe0fd54};}catch(_0x15827f){console[_0x239090(0x15f)]('KLYME\x20'+_0x2582ec+_0x239090(0x196),_0x15827f),loggerService_1[_0x239090(0x191)][_0x239090(0x197)](_0x239090(0x129)+_0x2582ec[_0x239090(0x17b)](),_0x239090(0x189)+_0x5430ba,_0x15827f);throw new Error('Failed\x20to\x20verify\x20KLYME\x20'+_0x2582ec+'\x20payment:\x20'+(_0x15827f instanceof Error?_0x15827f[_0x239090(0x126)]:'Unknown\x20error'));}}async[a39_0x39b0e4(0x12d)](_0x3b31d4){const _0x57de25=a39_0x39b0e4;console[_0x57de25(0x195)]('Processing\x20KLYME\x20webhook:',_0x3b31d4);let _0x2b7e09='PENDING';switch(_0x3b31d4['status']?.[_0x57de25(0x17b)]()){case _0x57de25(0x190):case'completed':case _0x57de25(0x172):case'success':case _0x57de25(0x145):_0x2b7e09=_0x57de25(0x147);break;case _0x57de25(0x14a):case _0x57de25(0x151):case _0x57de25(0x14f):case'error':case'rejected':_0x2b7e09='FAILED';break;case'expired':case'timeout':_0x2b7e09=_0x57de25(0x10d);break;case'pending':case'created':case'active':case _0x57de25(0x144):case _0x57de25(0x14c):default:_0x2b7e09='PENDING';break;}return{'paymentId':_0x3b31d4[_0x57de25(0x15c)]||_0x3b31d4[_0x57de25(0x135)]||_0x3b31d4[_0x57de25(0x193)],'status':_0x2b7e09,'amount':_0x3b31d4[_0x57de25(0x16b)],'currency':_0x3b31d4[_0x57de25(0x127)],'region':_0x3b31d4[_0x57de25(0x15a)],'additionalInfo':{'payment_method':_0x3b31d4[_0x57de25(0x13b)],'transaction_id':_0x3b31d4[_0x57de25(0x182)]}};}}exports[a39_0x39b0e4(0x115)]=KlymeService;function a39_0x138a(){const _0xed1940=['createPaymentLink','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','resolve','__importStar','findFirst','padStart','paid','loggerService','__createBinding','payment_id','\x20SERVICE\x20ERROR\x20===','log','\x20payment\x20verification\x20error:','logWhiteDomainError','\x20SUCCESS\x20(New\x20Format)\x20===','EXPIRED','toString','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','8357139xnSvPx','\x20(8digits-8digits\x20format\x20for\x20','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','then','/create','KlymeService','Reference\x20Used\x20as\x20ID:','Currency\x20Used:','PENDING','Status\x20Text:','TesSoft\x20Payment\x20System/1.0','Headers:',',\x20body:\x20','apiUrl','validateCurrencyForRegion','Unknown\x20error\x20from\x20KLYME\x20','\x20payment\x20link:\x20Unknown\x20error','text','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','Business\x20Error:\x20','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','defineProperty','message','currency','\x20SUCCESS\x20(Legacy\x20Format)\x20===','klyme_','verifyPayment','Redirect\x20URL:','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','processWebhook','40zdvwiH','\x20API:\x20missing\x20payment\x20data','stringify','===\x20PARSED\x20KLYME\x20','toUpperCase','10Ndieck','get','order_id','===\x20KLYME\x20','300LIZKHG','create','HTTP\x20error!\x20status:\x20','HTTP\x20','payment_method','\x20API:\x20','statusText','\x20API\x20ERROR\x20===','authUrl','Reference\x20Used:','logWhiteDomainResponse','POST','headers','processing','successful','1827441rOWIFE','PAID','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','uuid','cancelled','Auth\x20URL:','in_progress','random','generateUniqueReference','failed','stack','canceled','Raw\x20Response\x20Body:','JSON\x20Parse\x20Error:\x20','Region\x20(geo):','URL:','46205170isrXeK','4143972oHXMOE','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','parse','region','Response\x20Body:','reference','Status:','Reference:','error','HTTP\x20Status:','Failed\x20to\x20create\x20KLYME\x20','application/json','redirect_url','json','127067IoYTUb','Error\x20details:','\x20API\x20error:\x20','Error\x20stack:','2300SxebKO','EUR','amount','floor','configurable','now','../../config/database','Status\x20Code:','entries','confirmed','length','(8digits-8digits\x20format)','Unsupported\x20KLYME\x20region:\x20','statusCode','\x20validated)','status','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','220nRcOpP','toLowerCase','\x20currency\x20validation\x20passed:\x20','KLYME\x20','__esModule','prototype','Currency:','Response\x20Time:','transaction_id','Invalid\x20response\x20from\x20KLYME\x20','Unknown\x20error','12892vHcMkg','default','Parsed\x20Result:','GBP','/verify/'];a39_0x138a=function(){return _0xed1940;};return a39_0x138a();}