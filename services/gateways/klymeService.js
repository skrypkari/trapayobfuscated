'use strict';const a38_0x43401b=a38_0x2a3f;(function(_0x4722e9,_0x18eeef){const _0xe37cee=a38_0x2a3f,_0x1a6e42=_0x4722e9();while(!![]){try{const _0xc90e38=parseInt(_0xe37cee(0x108))/0x1*(parseInt(_0xe37cee(0x8d))/0x2)+parseInt(_0xe37cee(0xa1))/0x3+parseInt(_0xe37cee(0xfd))/0x4+parseInt(_0xe37cee(0xb7))/0x5*(-parseInt(_0xe37cee(0xb3))/0x6)+parseInt(_0xe37cee(0x114))/0x7*(parseInt(_0xe37cee(0x10c))/0x8)+parseInt(_0xe37cee(0xac))/0x9*(-parseInt(_0xe37cee(0x98))/0xa)+parseInt(_0xe37cee(0x109))/0xb*(-parseInt(_0xe37cee(0xc9))/0xc);if(_0xc90e38===_0x18eeef)break;else _0x1a6e42['push'](_0x1a6e42['shift']());}catch(_0x188d52){_0x1a6e42['push'](_0x1a6e42['shift']());}}}(a38_0x1aa9,0xd7e66));function a38_0x1aa9(){const _0x453d26=['random','6lzJcmh','configurable','TesSoft\x20Payment\x20System/1.0','EXPIRED','4943005VSEtlY','Redirect\x20URL:','hasOwnProperty','__esModule','Unknown\x20error','findFirst','completed','stringify','https://tesoft.uk/gateway/pending.php?id=','(8digits-8digits\x20format)','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','===\x20KLYME\x20','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','writable','Reference:','\x20API\x20error:\x20','authUrl','Reference\x20Used:','1999236jLFbsR','apiUrl','FAILED','../../config/database','pending','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','URL:','Error\x20stack:','success','\x20SERVICE\x20ERROR\x20===','resolve','toString','\x20API:\x20missing\x20payment\x20data','expired','https://tesoft.uk/gateway/klyme/','validateCurrencyForRegion','GBP','timeout','Status:','logWhiteDomainRequest','klyme_','verifyPayment','cancelled','generateUniqueReference','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x20API\x20BUSINESS\x20ERROR\x20===','HTTP\x20error!\x20status:\x20','Raw\x20Response\x20Body:','\x20API','statusText','now','status','default','__importStar','payment_id','paid','\x20(8digits-8digits\x20format\x20for\x20','canceled','transaction_id','Unknown\x20error\x20from\x20KLYME\x20','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','/create','/verify/','Parsed\x20Result:','Invalid\x20response\x20from\x20KLYME\x20','defineProperty','\x20SUCCESS\x20(Legacy\x20Format)\x20===','stack','currency','prototype','__createBinding','\x20validated)','519056kMNnlx','logWhiteDomainError','toUpperCase','EUR','Region\x20(geo):','\x20SUCCESS\x20(New\x20Format)\x20===','application/json','length','\x20RESPONSE\x20===','Currency\x20Used:','log','1gQtMFe','121lplyCD','KLYME\x20','get','1432fcqDst','Failed\x20to\x20create\x20KLYME\x20','parse','\x20payment\x20verification\x20error:','message','padStart','call','payment_method','46130KdViau','toLowerCase','üí≥\x20KLYME\x20','headers','../loggerService','redirect_url','HTTP\x20Status:','UUID:','entries','HTTP\x20','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','JSON\x20Parse\x20Error:\x20','processing','uuid','KLYME\x20payment\x20creation\x20is\x20only\x20supported\x20for\x20EU\x20and\x20GB\x20regions,\x20got:\x20','active','statusCode','2701890jmSMJU','createPaymentLink','\x20API:\x20','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','Failed\x20to\x20parse\x20JSON\x20response:','error','create','Response\x20data:','\x20payment:\x20','__setModuleDefault','PAID','11690pOsuvd','loggerService','Processing\x20KLYME\x20webhook:','Error\x20details:','failed','payment','Status\x20Text:','reference','KlymeService','3251454edHPMn','‚ö†Ô∏è\x20KLYME\x20reference\x20','\x20payment\x20link:\x20','(validated\x20for\x20','confirmed','Reference\x20Used\x20as\x20ID:','Currency:','created','logWhiteDomainResponse','PENDING','POST','297KrFOhv','===\x20PARSED\x20KLYME\x20','text','Auth\x20URL:','Headers:','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'];a38_0x1aa9=function(){return _0x453d26;};return a38_0x1aa9();}var __createBinding=this&&this[a38_0x43401b(0xfb)]||(Object['create']?function(_0x7956de,_0x33a3c2,_0xca01f,_0x316fc3){const _0xbff729=a38_0x43401b;if(_0x316fc3===undefined)_0x316fc3=_0xca01f;var _0x4ac669=Object['getOwnPropertyDescriptor'](_0x33a3c2,_0xca01f);(!_0x4ac669||(_0xbff729(0x10b)in _0x4ac669?!_0x33a3c2[_0xbff729(0xba)]:_0x4ac669[_0xbff729(0xc4)]||_0x4ac669[_0xbff729(0xb4)]))&&(_0x4ac669={'enumerable':!![],'get':function(){return _0x33a3c2[_0xca01f];}}),Object[_0xbff729(0xf6)](_0x7956de,_0x316fc3,_0x4ac669);}:function(_0x38250d,_0x11172e,_0x1c281a,_0x4cf193){if(_0x4cf193===undefined)_0x4cf193=_0x1c281a;_0x38250d[_0x4cf193]=_0x11172e[_0x1c281a];}),__setModuleDefault=this&&this[a38_0x43401b(0x96)]||(Object[a38_0x43401b(0x93)]?function(_0x9b56ca,_0x2ac321){const _0x13b9b6=a38_0x43401b;Object[_0x13b9b6(0xf6)](_0x9b56ca,'default',{'enumerable':!![],'value':_0x2ac321});}:function(_0x37c111,_0x17cb9f){_0x37c111['default']=_0x17cb9f;}),__importStar=this&&this[a38_0x43401b(0xea)]||(function(){var _0x129a92=function(_0x1cfdd4){return _0x129a92=Object['getOwnPropertyNames']||function(_0x397246){const _0x4f6bb6=a38_0x2a3f;var _0x6a3443=[];for(var _0x5a7778 in _0x397246)if(Object[_0x4f6bb6(0xfa)][_0x4f6bb6(0xb9)][_0x4f6bb6(0x112)](_0x397246,_0x5a7778))_0x6a3443[_0x6a3443[_0x4f6bb6(0x104)]]=_0x5a7778;return _0x6a3443;},_0x129a92(_0x1cfdd4);};return function(_0x31ddc0){const _0x4a4194=a38_0x2a3f;if(_0x31ddc0&&_0x31ddc0[_0x4a4194(0xba)])return _0x31ddc0;var _0x25a372={};if(_0x31ddc0!=null){for(var _0x28777c=_0x129a92(_0x31ddc0),_0x52515f=0x0;_0x52515f<_0x28777c[_0x4a4194(0x104)];_0x52515f++)if(_0x28777c[_0x52515f]!==_0x4a4194(0xe9))__createBinding(_0x25a372,_0x31ddc0,_0x28777c[_0x52515f]);}return __setModuleDefault(_0x25a372,_0x31ddc0),_0x25a372;};}());Object['defineProperty'](exports,a38_0x43401b(0xba),{'value':!![]}),exports[a38_0x43401b(0xa0)]=void 0x0;function a38_0x2a3f(_0x679ddc,_0x7aa473){const _0x1aa943=a38_0x1aa9();return a38_0x2a3f=function(_0x2a3faa,_0x16faf0){_0x2a3faa=_0x2a3faa-0x7e;let _0x28d92a=_0x1aa943[_0x2a3faa];return _0x28d92a;},a38_0x2a3f(_0x679ddc,_0x7aa473);}const loggerService_1=require(a38_0x43401b(0x7f));class KlymeService{constructor(){const _0x30e272=a38_0x43401b;this[_0x30e272(0xca)]=_0x30e272(0xd7),console[_0x30e272(0x107)](_0x30e272(0x86));}[a38_0x43401b(0xd8)](_0x4189d0,_0x33e20d){const _0x22f016=a38_0x43401b,_0x3688b4=_0x4189d0[_0x22f016(0xff)]();switch(_0x33e20d){case'EU':if(_0x3688b4!==_0x22f016(0x100))throw new Error(_0x22f016(0xb1)+_0x3688b4);break;case'GB':if(_0x3688b4!==_0x22f016(0xd9))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x3688b4);break;case'DE':if(_0x3688b4!==_0x22f016(0x100))throw new Error(_0x22f016(0xe1)+_0x3688b4);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x33e20d);}}async[a38_0x43401b(0xe0)](){const _0xa48bea=a38_0x43401b,_0x2f2dba=(await Promise[_0xa48bea(0xd3)]()['then'](()=>__importStar(require(_0xa48bea(0xcc)))))[_0xa48bea(0xe9)];let _0x2684d3,_0x146101=0x0;const _0xf0b733=0xa;do{const _0x1c7262=()=>{const _0x4cf37b=_0xa48bea;return Math['floor'](Math[_0x4cf37b(0xb2)]()*0x5f5e100)[_0x4cf37b(0xd4)]()[_0x4cf37b(0x111)](0x8,'0');};_0x2684d3=_0x1c7262()+'-'+_0x1c7262();const _0x4444b5=await _0x2f2dba[_0xa48bea(0x9d)][_0xa48bea(0xbc)]({'where':{'gatewayOrderId':_0x2684d3}});if(!_0x4444b5)break;_0x146101++,console[_0xa48bea(0x107)](_0xa48bea(0xa2)+_0x2684d3+_0xa48bea(0x90)+_0x146101+')');}while(_0x146101<_0xf0b733);if(_0x146101>=_0xf0b733)throw new Error(_0xa48bea(0xce));return _0x2684d3;}async[a38_0x43401b(0x8e)](_0x3e4065){const _0x353042=a38_0x43401b,{orderId:_0x379402,amount:_0x4607c6,currency:_0x1d55e0,region:_0x2c46cd}=_0x3e4065;if(_0x2c46cd!=='EU'&&_0x2c46cd!=='GB')throw new Error(_0x353042(0x8a)+_0x2c46cd);this[_0x353042(0xd8)](_0x1d55e0,_0x2c46cd);const _0x1430ff=_0x1d55e0[_0x353042(0xff)]();console[_0x353042(0x107)](_0x353042(0x116)+_0x2c46cd+'\x20currency\x20validation\x20passed:\x20'+_0x1430ff);const _0x249162=await this[_0x353042(0xe0)]();console[_0x353042(0x107)](_0x353042(0xf1)+_0x249162+_0x353042(0xed)+_0x2c46cd+')');const _0x45a561=_0x353042(0xbf)+_0x379402,_0x5da115={'amount':_0x4607c6,'currency':_0x1430ff,'redirectUrl':_0x45a561,'reference':_0x249162,'geo':_0x2c46cd},_0x4bccb2=Date[_0x353042(0xe7)]();try{console['log'](_0x353042(0xc2)+_0x2c46cd+'\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20==='),console[_0x353042(0x107)](_0x353042(0xcf),this['apiUrl']),console[_0x353042(0x107)]('Request\x20Body:',JSON[_0x353042(0xbe)](_0x5da115,null,0x2)),console[_0x353042(0x107)](_0x353042(0x101),_0x2c46cd),console['log'](_0x353042(0xa7),_0x1430ff,_0x353042(0xa4)+_0x2c46cd+')'),console[_0x353042(0x107)](_0x353042(0xc5),_0x249162,_0x353042(0xc0)),console[_0x353042(0x107)](_0x353042(0xb8),_0x45a561),loggerService_1[_0x353042(0x99)][_0x353042(0xdc)](_0x353042(0xdd)+_0x2c46cd[_0x353042(0x115)](),'/create',_0x353042(0xab),_0x5da115);const _0x3d5212=await fetch(this[_0x353042(0xca)],{'method':_0x353042(0xab),'headers':{'Content-Type':'application/json','Accept':_0x353042(0x103),'User-Agent':_0x353042(0xb5)},'body':JSON['stringify'](_0x5da115)}),_0x314da9=Date[_0x353042(0xe7)]()-_0x4bccb2;console[_0x353042(0x107)](_0x353042(0xc2)+_0x2c46cd+'\x20API\x20RESPONSE\x20(Unified\x20Route)\x20==='),console[_0x353042(0x107)](_0x353042(0xdb),_0x3d5212[_0x353042(0xe8)]),console[_0x353042(0x107)](_0x353042(0x9e),_0x3d5212[_0x353042(0xe6)]),console[_0x353042(0x107)](_0x353042(0xb0),Object['fromEntries'](_0x3d5212[_0x353042(0x7e)][_0x353042(0x83)]())),console[_0x353042(0x107)]('Response\x20Time:',_0x314da9+'ms');const _0x552b9e=await _0x3d5212[_0x353042(0xae)]();console['log'](_0x353042(0xe4),_0x552b9e);if(!_0x3d5212['ok']){console['error'](_0x353042(0xc2)+_0x2c46cd+'\x20API\x20ERROR\x20==='),console['error'](_0x353042(0x81),_0x3d5212[_0x353042(0xe8)]),console[_0x353042(0x92)]('Response\x20Body:',_0x552b9e),loggerService_1[_0x353042(0x99)][_0x353042(0xa9)](_0x353042(0xdd)+_0x2c46cd[_0x353042(0x115)](),_0x353042(0xf2),_0x3d5212['status'],_0x552b9e,_0x314da9),loggerService_1[_0x353042(0x99)][_0x353042(0xfe)]('klyme_'+_0x2c46cd[_0x353042(0x115)](),_0x353042(0xf2),_0x353042(0x84)+_0x3d5212[_0x353042(0xe8)]+':\x20'+_0x552b9e);throw new Error('HTTP\x20error!\x20status:\x20'+_0x3d5212[_0x353042(0xe8)]+',\x20body:\x20'+_0x552b9e);}let _0x37c3e4;try{_0x37c3e4=JSON[_0x353042(0x10e)](_0x552b9e);}catch(_0x140a28){console[_0x353042(0x92)](_0x353042(0x91),_0x140a28),loggerService_1[_0x353042(0x99)]['logWhiteDomainError']('klyme_'+_0x2c46cd[_0x353042(0x115)](),_0x353042(0xf2),_0x353042(0x87)+_0x140a28);throw new Error(_0x353042(0x85)+_0x2c46cd+_0x353042(0x8f)+_0x552b9e);}console[_0x353042(0x107)](_0x353042(0xad)+_0x2c46cd+_0x353042(0x105)),console[_0x353042(0x107)](_0x353042(0xf4),JSON[_0x353042(0xbe)](_0x37c3e4,null,0x2)),loggerService_1[_0x353042(0x99)]['logWhiteDomainResponse'](_0x353042(0xdd)+_0x2c46cd[_0x353042(0x115)](),_0x353042(0xf2),_0x3d5212['status'],_0x37c3e4,_0x314da9);if(_0x37c3e4[_0x353042(0x92)]||_0x37c3e4[_0x353042(0x8c)]){const _0x5046cd=_0x37c3e4['message']||_0x37c3e4[_0x353042(0x92)]||_0x353042(0xf0)+_0x2c46cd+_0x353042(0xe5);console[_0x353042(0x92)](_0x353042(0xc2)+_0x2c46cd+_0x353042(0xe2)),console['error']('Error\x20Message:',_0x5046cd),console[_0x353042(0x92)]('Status\x20Code:',_0x37c3e4[_0x353042(0x8c)]),loggerService_1[_0x353042(0x99)]['logWhiteDomainError'](_0x353042(0xdd)+_0x2c46cd[_0x353042(0x115)](),_0x353042(0xf2),'Business\x20Error:\x20'+_0x5046cd);throw new Error(_0x353042(0x10a)+_0x2c46cd+_0x353042(0xc6)+_0x5046cd);}let _0x20d844,_0x1f05fd;if(_0x37c3e4[_0x353042(0x89)]&&_0x37c3e4[_0x353042(0x80)])_0x20d844=_0x37c3e4[_0x353042(0x89)],_0x1f05fd=_0x37c3e4[_0x353042(0x80)],console['log'](_0x353042(0xc2)+_0x2c46cd+_0x353042(0x102)),console[_0x353042(0x107)](_0x353042(0x82),_0x37c3e4['uuid']),console[_0x353042(0x107)](_0x353042(0xb8),_0x37c3e4[_0x353042(0x80)]);else{if(_0x37c3e4[_0x353042(0xc7)])_0x20d844=_0x249162,_0x1f05fd=_0x37c3e4['authUrl'],console['log'](_0x353042(0xc2)+_0x2c46cd+_0x353042(0xf7)),console[_0x353042(0x107)](_0x353042(0xaf),_0x37c3e4[_0x353042(0xc7)]),console[_0x353042(0x107)](_0x353042(0xa6),_0x249162);else{console[_0x353042(0x92)](_0x353042(0xc2)+_0x2c46cd+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console['error'](_0x353042(0xc3)),console['error'](_0x353042(0x94),_0x37c3e4),loggerService_1['loggerService'][_0x353042(0xfe)](_0x353042(0xdd)+_0x2c46cd[_0x353042(0x115)](),_0x353042(0xf2),_0x353042(0xc1));throw new Error(_0x353042(0xf5)+_0x2c46cd+_0x353042(0xd5));}}return console['log'](_0x353042(0x106),_0x1430ff,'('+_0x2c46cd+_0x353042(0xfc)),console[_0x353042(0x107)](_0x353042(0xc8),_0x249162,'(8digits-8digits\x20format)'),console['log']('Geo\x20Parameter:',_0x2c46cd),{'gateway_payment_id':_0x20d844,'payment_url':_0x1f05fd};}catch(_0x50097f){console[_0x353042(0x92)](_0x353042(0xc2)+_0x2c46cd+_0x353042(0xd2)),console['error'](_0x353042(0x9b),_0x50097f),loggerService_1[_0x353042(0x99)]['logWhiteDomainError'](_0x353042(0xdd)+_0x2c46cd[_0x353042(0x115)](),'/create',_0x50097f);if(_0x50097f instanceof Error){console[_0x353042(0x92)]('Error\x20message:',_0x50097f['message']),console[_0x353042(0x92)](_0x353042(0xd0),_0x50097f[_0x353042(0xf8)]);throw new Error(_0x353042(0x10d)+_0x2c46cd+_0x353042(0xa3)+_0x50097f[_0x353042(0x110)]);}throw new Error(_0x353042(0x10d)+_0x2c46cd+'\x20payment\x20link:\x20Unknown\x20error');}}async[a38_0x43401b(0xde)](_0x4be7de,_0x17fb11){const _0x3cb79f=a38_0x43401b,_0x59d408=Date[_0x3cb79f(0xe7)]();try{const _0x204e44={'gatewayPaymentId':_0x4be7de,'geo':_0x17fb11};loggerService_1[_0x3cb79f(0x99)][_0x3cb79f(0xdc)]('klyme_'+_0x17fb11[_0x3cb79f(0x115)](),_0x3cb79f(0xf3)+_0x4be7de,_0x3cb79f(0xab),_0x204e44);const _0xd366d1=await fetch(this['apiUrl'],{'method':_0x3cb79f(0xab),'headers':{'Content-Type':_0x3cb79f(0x103),'User-Agent':_0x3cb79f(0xb5)},'body':JSON[_0x3cb79f(0xbe)](_0x204e44)}),_0x300700=Date['now']()-_0x59d408;if(!_0xd366d1['ok']){const _0x320eb4=await _0xd366d1[_0x3cb79f(0xae)]();loggerService_1[_0x3cb79f(0x99)]['logWhiteDomainResponse']('klyme_'+_0x17fb11[_0x3cb79f(0x115)](),_0x3cb79f(0xf3)+_0x4be7de,_0xd366d1[_0x3cb79f(0xe8)],_0x320eb4,_0x300700);throw new Error(_0x3cb79f(0xe3)+_0xd366d1[_0x3cb79f(0xe8)]);}const _0x337962=await _0xd366d1['json']();loggerService_1[_0x3cb79f(0x99)]['logWhiteDomainResponse']('klyme_'+_0x17fb11[_0x3cb79f(0x115)](),'/verify/'+_0x4be7de,_0xd366d1[_0x3cb79f(0xe8)],_0x337962,_0x300700);if(_0x337962['error']||_0x337962[_0x3cb79f(0x8c)]){loggerService_1[_0x3cb79f(0x99)][_0x3cb79f(0xfe)](_0x3cb79f(0xdd)+_0x17fb11[_0x3cb79f(0x115)](),'/verify/'+_0x4be7de,_0x3cb79f(0x10a)+_0x17fb11+_0x3cb79f(0xc6)+(_0x337962[_0x3cb79f(0x110)]||_0x337962[_0x3cb79f(0x92)]||'Unknown\x20error'));throw new Error(_0x3cb79f(0x10a)+_0x17fb11+_0x3cb79f(0xc6)+(_0x337962[_0x3cb79f(0x110)]||_0x337962['error']||_0x3cb79f(0xbb)));}let _0x27d18d=_0x3cb79f(0xaa);return{'status':_0x27d18d};}catch(_0x202dd0){console[_0x3cb79f(0x92)](_0x3cb79f(0x10a)+_0x17fb11+_0x3cb79f(0x10f),_0x202dd0),loggerService_1['loggerService'][_0x3cb79f(0xfe)](_0x3cb79f(0xdd)+_0x17fb11['toLowerCase'](),_0x3cb79f(0xf3)+_0x4be7de,_0x202dd0);throw new Error('Failed\x20to\x20verify\x20KLYME\x20'+_0x17fb11+_0x3cb79f(0x95)+(_0x202dd0 instanceof Error?_0x202dd0['message']:'Unknown\x20error'));}}async['processWebhook'](_0x5039a1){const _0x1d675c=a38_0x43401b;console['log'](_0x1d675c(0x9a),_0x5039a1);let _0x40b298=_0x1d675c(0xaa);switch(_0x5039a1['status']?.[_0x1d675c(0x115)]()){case _0x1d675c(0xec):case _0x1d675c(0xbd):case _0x1d675c(0xa5):case _0x1d675c(0xd1):case'successful':_0x40b298=_0x1d675c(0x97);break;case _0x1d675c(0xdf):case _0x1d675c(0xee):case _0x1d675c(0x9c):case _0x1d675c(0x92):case'rejected':_0x40b298=_0x1d675c(0xcb);break;case _0x1d675c(0xd6):case _0x1d675c(0xda):_0x40b298=_0x1d675c(0xb6);break;case _0x1d675c(0xcd):case _0x1d675c(0xa8):case _0x1d675c(0x8b):case _0x1d675c(0x88):case'in_progress':default:_0x40b298='PENDING';break;}return{'paymentId':_0x5039a1[_0x1d675c(0x9f)]||_0x5039a1['order_id']||_0x5039a1[_0x1d675c(0xeb)],'status':_0x40b298,'amount':_0x5039a1['amount'],'currency':_0x5039a1[_0x1d675c(0xf9)],'region':_0x5039a1['region'],'additionalInfo':{'payment_method':_0x5039a1[_0x1d675c(0x113)],'transaction_id':_0x5039a1[_0x1d675c(0xef)]}};}}exports[a38_0x43401b(0xa0)]=KlymeService;