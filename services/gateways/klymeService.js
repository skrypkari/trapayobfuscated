'use strict';const a42_0x3ac2cc=a42_0x1835;(function(_0x596fc5,_0x47de28){const _0x3a6af0=a42_0x1835,_0x2c6023=_0x596fc5();while(!![]){try{const _0x1f804d=-parseInt(_0x3a6af0(0x114))/0x1*(-parseInt(_0x3a6af0(0xe1))/0x2)+parseInt(_0x3a6af0(0xce))/0x3*(parseInt(_0x3a6af0(0xe8))/0x4)+-parseInt(_0x3a6af0(0xfb))/0x5*(parseInt(_0x3a6af0(0x9f))/0x6)+parseInt(_0x3a6af0(0xbf))/0x7+-parseInt(_0x3a6af0(0x110))/0x8+parseInt(_0x3a6af0(0x117))/0x9*(-parseInt(_0x3a6af0(0x11f))/0xa)+-parseInt(_0x3a6af0(0xf9))/0xb;if(_0x1f804d===_0x47de28)break;else _0x2c6023['push'](_0x2c6023['shift']());}catch(_0x3c7573){_0x2c6023['push'](_0x2c6023['shift']());}}}(a42_0x1557,0x34383));var __createBinding=this&&this['__createBinding']||(Object[a42_0x3ac2cc(0x121)]?function(_0x598b70,_0x145b85,_0x4c0506,_0x3527e8){const _0x32993f=a42_0x3ac2cc;if(_0x3527e8===undefined)_0x3527e8=_0x4c0506;var _0x40bbf5=Object[_0x32993f(0xbd)](_0x145b85,_0x4c0506);(!_0x40bbf5||(_0x32993f(0xaf)in _0x40bbf5?!_0x145b85['__esModule']:_0x40bbf5['writable']||_0x40bbf5[_0x32993f(0xb5)]))&&(_0x40bbf5={'enumerable':!![],'get':function(){return _0x145b85[_0x4c0506];}}),Object['defineProperty'](_0x598b70,_0x3527e8,_0x40bbf5);}:function(_0x5b569c,_0x41c485,_0x23f2c8,_0x4854eb){if(_0x4854eb===undefined)_0x4854eb=_0x23f2c8;_0x5b569c[_0x4854eb]=_0x41c485[_0x23f2c8];}),__setModuleDefault=this&&this[a42_0x3ac2cc(0x108)]||(Object[a42_0x3ac2cc(0x121)]?function(_0x387524,_0x2c0ce3){const _0x5b4f1d=a42_0x3ac2cc;Object[_0x5b4f1d(0xef)](_0x387524,'default',{'enumerable':!![],'value':_0x2c0ce3});}:function(_0x1fda1f,_0x1e983f){const _0x364866=a42_0x3ac2cc;_0x1fda1f[_0x364866(0x115)]=_0x1e983f;}),__importStar=this&&this[a42_0x3ac2cc(0xdd)]||(function(){var _0x2aafaa=function(_0x392437){const _0x2d574a=a42_0x1835;return _0x2aafaa=Object[_0x2d574a(0x103)]||function(_0x371349){const _0x2a1257=_0x2d574a;var _0x111dc1=[];for(var _0x398468 in _0x371349)if(Object[_0x2a1257(0xeb)][_0x2a1257(0xf8)][_0x2a1257(0xe0)](_0x371349,_0x398468))_0x111dc1[_0x111dc1[_0x2a1257(0xd4)]]=_0x398468;return _0x111dc1;},_0x2aafaa(_0x392437);};return function(_0x582841){const _0x231f57=a42_0x1835;if(_0x582841&&_0x582841[_0x231f57(0xd2)])return _0x582841;var _0x239e38={};if(_0x582841!=null){for(var _0x2500c5=_0x2aafaa(_0x582841),_0x573640=0x0;_0x573640<_0x2500c5['length'];_0x573640++)if(_0x2500c5[_0x573640]!=='default')__createBinding(_0x239e38,_0x582841,_0x2500c5[_0x573640]);}return __setModuleDefault(_0x239e38,_0x582841),_0x239e38;};}());Object[a42_0x3ac2cc(0xef)](exports,a42_0x3ac2cc(0xd2),{'value':!![]}),exports[a42_0x3ac2cc(0x102)]=void 0x0;const loggerService_1=require(a42_0x3ac2cc(0xa6));function a42_0x1835(_0x475679,_0x5887a1){const _0x155778=a42_0x1557();return a42_0x1835=function(_0x183505,_0x4ec334){_0x183505=_0x183505-0x9a;let _0x1ac9be=_0x155778[_0x183505];return _0x1ac9be;},a42_0x1835(_0x475679,_0x5887a1);}class KlymeService{constructor(){const _0x2dc201=a42_0x3ac2cc;this[_0x2dc201(0xcb)]=_0x2dc201(0xcf),console[_0x2dc201(0xb0)](_0x2dc201(0x123));}[a42_0x3ac2cc(0xc0)](_0x5ade6b,_0x569a07){const _0x2c6608=a42_0x3ac2cc,_0x32b9a2=_0x5ade6b[_0x2c6608(0xcd)]();switch(_0x569a07){case'EU':if(_0x32b9a2!==_0x2c6608(0xdc))throw new Error(_0x2c6608(0x104)+_0x32b9a2);break;case'GB':if(_0x32b9a2!==_0x2c6608(0x10a))throw new Error(_0x2c6608(0xa8)+_0x32b9a2);break;case'DE':if(_0x32b9a2!==_0x2c6608(0xdc))throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x32b9a2);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x569a07);}}async['generateUniqueReference'](){const _0x3c43bc=a42_0x3ac2cc,_0x2198b3=(await Promise['resolve']()[_0x3c43bc(0xed)](()=>__importStar(require('../../config/database'))))['default'];let _0x29efb9,_0x2c8463=0x0;const _0x410437=0xa;do{const _0xc5b8c3=()=>{const _0x42eeaf=_0x3c43bc;return Math['floor'](Math[_0x42eeaf(0x106)]()*0x5f5e100)['toString']()['padStart'](0x8,'0');};_0x29efb9=_0xc5b8c3()+'-'+_0xc5b8c3();const _0x94518=await _0x2198b3['payment']['findFirst']({'where':{'gatewayOrderId':_0x29efb9}});if(!_0x94518)break;_0x2c8463++,console[_0x3c43bc(0xb0)]('⚠️\x20KLYME\x20reference\x20'+_0x29efb9+'\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20'+_0x2c8463+')');}while(_0x2c8463<_0x410437);if(_0x2c8463>=_0x410437)throw new Error(_0x3c43bc(0xa1));return _0x29efb9;}async[a42_0x3ac2cc(0xe4)](_0x18d401){const _0x51de82=a42_0x3ac2cc,{orderId:_0x1fdc96,amount:_0x58de56,currency:_0x17a3c0,region:_0x68a9bc}=_0x18d401;if(_0x68a9bc!=='EU'&&_0x68a9bc!=='GB'&&_0x68a9bc!=='DE')throw new Error(_0x51de82(0x112)+_0x68a9bc);this[_0x51de82(0xc0)](_0x17a3c0,_0x68a9bc);const _0x1267b2=_0x17a3c0['toUpperCase']();console[_0x51de82(0xb0)](_0x51de82(0xf6)+_0x68a9bc+_0x51de82(0x9c)+_0x1267b2);const _0x9a908f=await this['generateUniqueReference']();console[_0x51de82(0xb0)](_0x51de82(0x10e)+_0x9a908f+_0x51de82(0xd7)+_0x68a9bc+')');const _0x23f58c=_0x51de82(0xd8)+_0x1fdc96,_0x36e0b4={'amount':_0x58de56,'currency':_0x1267b2,'redirectUrl':_0x23f58c,'reference':_0x9a908f,'geo':_0x68a9bc},_0x2e9b3a=Date['now']();try{console[_0x51de82(0xb0)](_0x51de82(0xd3)+_0x68a9bc+_0x51de82(0xd6)),console['log'](_0x51de82(0xf2),this['apiUrl']),console['log'](_0x51de82(0x109),JSON[_0x51de82(0xea)](_0x36e0b4,null,0x2)),console['log'](_0x51de82(0xb8),_0x68a9bc),console[_0x51de82(0xb0)](_0x51de82(0x118),_0x1267b2,_0x51de82(0xc4)+_0x68a9bc+')'),console[_0x51de82(0xb0)]('Reference:',_0x9a908f,_0x51de82(0x120)),console['log'](_0x51de82(0x105),_0x23f58c),loggerService_1[_0x51de82(0xa5)]['logWhiteDomainRequest']('klyme_'+_0x68a9bc[_0x51de82(0xe7)](),'/create',_0x51de82(0xf4),_0x36e0b4);const _0x401177=await fetch(this[_0x51de82(0xcb)],{'method':_0x51de82(0xf4),'headers':{'Content-Type':_0x51de82(0x125),'Accept':_0x51de82(0x125),'User-Agent':_0x51de82(0xb4)},'body':JSON[_0x51de82(0xea)](_0x36e0b4)}),_0x4092be=Date[_0x51de82(0xf7)]()-_0x2e9b3a;console[_0x51de82(0xb0)]('===\x20KLYME\x20'+_0x68a9bc+_0x51de82(0xba)),console[_0x51de82(0xb0)](_0x51de82(0x126),_0x401177[_0x51de82(0xc5)]),console[_0x51de82(0xb0)]('Status\x20Text:',_0x401177[_0x51de82(0xa7)]),console[_0x51de82(0xb0)](_0x51de82(0xbb),Object['fromEntries'](_0x401177[_0x51de82(0x9e)][_0x51de82(0xae)]())),console['log']('Response\x20Time:',_0x4092be+'ms');const _0x424639=await _0x401177[_0x51de82(0xdf)]();console[_0x51de82(0xb0)](_0x51de82(0xb6),_0x424639);if(!_0x401177['ok']){console[_0x51de82(0xe6)]('===\x20KLYME\x20'+_0x68a9bc+'\x20API\x20ERROR\x20==='),console['error']('HTTP\x20Status:',_0x401177[_0x51de82(0xc5)]),console[_0x51de82(0xe6)](_0x51de82(0x119),_0x424639),loggerService_1['loggerService'][_0x51de82(0x10c)](_0x51de82(0xbe)+_0x68a9bc[_0x51de82(0xe7)](),'/create',_0x401177[_0x51de82(0xc5)],_0x424639,_0x4092be),loggerService_1[_0x51de82(0xa5)][_0x51de82(0x9d)](_0x51de82(0xbe)+_0x68a9bc['toLowerCase'](),'/create',_0x51de82(0xa3)+_0x401177[_0x51de82(0xc5)]+':\x20'+_0x424639);throw new Error('HTTP\x20error!\x20status:\x20'+_0x401177[_0x51de82(0xc5)]+_0x51de82(0x101)+_0x424639);}let _0x3da604;try{_0x3da604=JSON[_0x51de82(0xfd)](_0x424639);}catch(_0x1a4239){console[_0x51de82(0xe6)](_0x51de82(0xf5),_0x1a4239),loggerService_1[_0x51de82(0xa5)][_0x51de82(0x9d)](_0x51de82(0xbe)+_0x68a9bc[_0x51de82(0xe7)](),'/create',_0x51de82(0xd0)+_0x1a4239);throw new Error('Invalid\x20JSON\x20response\x20from\x20KLYME\x20'+_0x68a9bc+_0x51de82(0xf0)+_0x424639);}console[_0x51de82(0xb0)](_0x51de82(0xb3)+_0x68a9bc+_0x51de82(0xdb)),console['log'](_0x51de82(0xde),JSON[_0x51de82(0xea)](_0x3da604,null,0x2)),loggerService_1[_0x51de82(0xa5)][_0x51de82(0x10c)]('klyme_'+_0x68a9bc['toLowerCase'](),_0x51de82(0xd9),_0x401177[_0x51de82(0xc5)],_0x3da604,_0x4092be);if(_0x3da604[_0x51de82(0xe6)]||_0x3da604['statusCode']){const _0x1add68=_0x3da604['message']||_0x3da604['error']||_0x51de82(0x10f)+_0x68a9bc+'\x20API';console[_0x51de82(0xe6)](_0x51de82(0xd3)+_0x68a9bc+_0x51de82(0x11c)),console[_0x51de82(0xe6)](_0x51de82(0xac),_0x1add68),console[_0x51de82(0xe6)](_0x51de82(0xb7),_0x3da604['statusCode']),loggerService_1[_0x51de82(0xa5)]['logWhiteDomainError'](_0x51de82(0xbe)+_0x68a9bc[_0x51de82(0xe7)](),'/create','Business\x20Error:\x20'+_0x1add68);throw new Error('KLYME\x20'+_0x68a9bc+_0x51de82(0x10b)+_0x1add68);}let _0x1c80c0,_0x254b04;if(_0x3da604[_0x51de82(0xc3)]&&_0x3da604[_0x51de82(0xc2)])_0x1c80c0=_0x3da604[_0x51de82(0xc3)],_0x254b04=_0x3da604['redirect_url'],console['log'](_0x51de82(0xd3)+_0x68a9bc+_0x51de82(0x111)),console['log'](_0x51de82(0xf3),_0x3da604[_0x51de82(0xc3)]),console[_0x51de82(0xb0)](_0x51de82(0x105),_0x3da604[_0x51de82(0xc2)]);else{if(_0x3da604['authUrl'])_0x1c80c0=_0x9a908f,_0x254b04=_0x3da604[_0x51de82(0xe5)],console['log'](_0x51de82(0xd3)+_0x68a9bc+_0x51de82(0xc8)),console['log'](_0x51de82(0xca),_0x3da604[_0x51de82(0xe5)]),console[_0x51de82(0xb0)]('Reference\x20Used\x20as\x20ID:',_0x9a908f);else{console[_0x51de82(0xe6)](_0x51de82(0xd3)+_0x68a9bc+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x51de82(0xe6)]('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console['error'](_0x51de82(0xb2),_0x3da604),loggerService_1[_0x51de82(0xa5)]['logWhiteDomainError'](_0x51de82(0xbe)+_0x68a9bc['toLowerCase'](),_0x51de82(0xd9),_0x51de82(0xee));throw new Error(_0x51de82(0xa0)+_0x68a9bc+_0x51de82(0xfc));}}return console['log'](_0x51de82(0x10d),_0x1267b2,'('+_0x68a9bc+'\x20validated)'),console[_0x51de82(0xb0)](_0x51de82(0xd1),_0x9a908f,_0x51de82(0x120)),console['log'](_0x51de82(0xab),_0x68a9bc),{'gateway_payment_id':_0x1c80c0,'payment_url':_0x254b04};}catch(_0x30e809){console[_0x51de82(0xe6)](_0x51de82(0xd3)+_0x68a9bc+_0x51de82(0x11b)),console['error'](_0x51de82(0x107),_0x30e809),loggerService_1[_0x51de82(0xa5)][_0x51de82(0x9d)](_0x51de82(0xbe)+_0x68a9bc[_0x51de82(0xe7)](),'/create',_0x30e809);if(_0x30e809 instanceof Error){console[_0x51de82(0xe6)](_0x51de82(0xc9),_0x30e809['message']),console[_0x51de82(0xe6)]('Error\x20stack:',_0x30e809[_0x51de82(0xb9)]);throw new Error(_0x51de82(0xc7)+_0x68a9bc+'\x20payment\x20link:\x20'+_0x30e809[_0x51de82(0x100)]);}throw new Error(_0x51de82(0xc7)+_0x68a9bc+'\x20payment\x20link:\x20Unknown\x20error');}}async[a42_0x3ac2cc(0xbc)](_0x21fff6,_0x12abad){const _0x5d8f4a=a42_0x3ac2cc,_0xef1387=Date[_0x5d8f4a(0xf7)]();try{const _0x56bdbc={'gatewayPaymentId':_0x21fff6,'geo':_0x12abad};loggerService_1[_0x5d8f4a(0xa5)]['logWhiteDomainRequest'](_0x5d8f4a(0xbe)+_0x12abad[_0x5d8f4a(0xe7)](),_0x5d8f4a(0x9a)+_0x21fff6,'POST',_0x56bdbc);const _0x3e6e26=await fetch(this['apiUrl'],{'method':'POST','headers':{'Content-Type':_0x5d8f4a(0x125),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x5d8f4a(0xea)](_0x56bdbc)}),_0x33a461=Date[_0x5d8f4a(0xf7)]()-_0xef1387;if(!_0x3e6e26['ok']){const _0x3f6693=await _0x3e6e26['text']();loggerService_1[_0x5d8f4a(0xa5)]['logWhiteDomainResponse'](_0x5d8f4a(0xbe)+_0x12abad['toLowerCase'](),_0x5d8f4a(0x9a)+_0x21fff6,_0x3e6e26[_0x5d8f4a(0xc5)],_0x3f6693,_0x33a461);throw new Error('HTTP\x20error!\x20status:\x20'+_0x3e6e26['status']);}const _0x5e3a6b=await _0x3e6e26[_0x5d8f4a(0xe3)]();loggerService_1[_0x5d8f4a(0xa5)]['logWhiteDomainResponse'](_0x5d8f4a(0xbe)+_0x12abad[_0x5d8f4a(0xe7)](),_0x5d8f4a(0x9a)+_0x21fff6,_0x3e6e26[_0x5d8f4a(0xc5)],_0x5e3a6b,_0x33a461);if(_0x5e3a6b[_0x5d8f4a(0xe6)]||_0x5e3a6b[_0x5d8f4a(0xa4)]){loggerService_1[_0x5d8f4a(0xa5)][_0x5d8f4a(0x9d)]('klyme_'+_0x12abad[_0x5d8f4a(0xe7)](),_0x5d8f4a(0x9a)+_0x21fff6,_0x5d8f4a(0xfe)+_0x12abad+'\x20API\x20error:\x20'+(_0x5e3a6b[_0x5d8f4a(0x100)]||_0x5e3a6b[_0x5d8f4a(0xe6)]||'Unknown\x20error'));throw new Error('KLYME\x20'+_0x12abad+_0x5d8f4a(0x10b)+(_0x5e3a6b[_0x5d8f4a(0x100)]||_0x5e3a6b[_0x5d8f4a(0xe6)]||'Unknown\x20error'));}let _0x14b6e0=_0x5d8f4a(0x11e);return{'status':_0x14b6e0};}catch(_0x2ea21c){console[_0x5d8f4a(0xe6)](_0x5d8f4a(0xfe)+_0x12abad+_0x5d8f4a(0xad),_0x2ea21c),loggerService_1[_0x5d8f4a(0xa5)][_0x5d8f4a(0x9d)]('klyme_'+_0x12abad[_0x5d8f4a(0xe7)](),_0x5d8f4a(0x9a)+_0x21fff6,_0x2ea21c);throw new Error(_0x5d8f4a(0xf1)+_0x12abad+_0x5d8f4a(0xcc)+(_0x2ea21c instanceof Error?_0x2ea21c[_0x5d8f4a(0x100)]:_0x5d8f4a(0xda)));}}async[a42_0x3ac2cc(0x11a)](_0x5ad1e2){const _0x8dd8a=a42_0x3ac2cc;console['log'](_0x8dd8a(0xff),_0x5ad1e2);let _0xe4b262=_0x8dd8a(0x11e);switch(_0x5ad1e2[_0x8dd8a(0xc5)]?.[_0x8dd8a(0xe7)]()){case'paid':case'completed':case _0x8dd8a(0xd5):case'success':case _0x8dd8a(0xc6):_0xe4b262=_0x8dd8a(0xa9);break;case _0x8dd8a(0xb1):case _0x8dd8a(0x116):case'failed':case _0x8dd8a(0xe6):case _0x8dd8a(0xe2):_0xe4b262='FAILED';break;case _0x8dd8a(0xfa):case _0x8dd8a(0x113):_0xe4b262='EXPIRED';break;case'pending':case _0x8dd8a(0x122):case _0x8dd8a(0xec):case _0x8dd8a(0xaa):case _0x8dd8a(0x11d):default:_0xe4b262=_0x8dd8a(0x11e);break;}return{'paymentId':_0x5ad1e2[_0x8dd8a(0x124)]||_0x5ad1e2[_0x8dd8a(0x9b)]||_0x5ad1e2[_0x8dd8a(0xe9)],'status':_0xe4b262,'amount':_0x5ad1e2[_0x8dd8a(0xa2)],'currency':_0x5ad1e2[_0x8dd8a(0xc1)],'region':_0x5ad1e2['region'],'additionalInfo':{'payment_method':_0x5ad1e2['payment_method'],'transaction_id':_0x5ad1e2['transaction_id']}};}}function a42_0x1557(){const _0x37fbda=['2292808VfPtfo','validateCurrencyForRegion','currency','redirect_url','uuid','(validated\x20for\x20','status','successful','Failed\x20to\x20create\x20KLYME\x20','\x20SUCCESS\x20(Legacy\x20Format)\x20===','Error\x20message:','Auth\x20URL:','apiUrl','\x20payment:\x20','toUpperCase','4596YJjhSA','https://tesoft.uk/gateway/klyme/','JSON\x20Parse\x20Error:\x20','Reference\x20Used:','__esModule','===\x20KLYME\x20','length','confirmed','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','\x20(8digits-8digits\x20format\x20for\x20','https://tesoft.uk/gateway/pending.php?id=','/create','Unknown\x20error','\x20RESPONSE\x20===','EUR','__importStar','Parsed\x20Result:','text','call','78ffGqZk','rejected','json','createPaymentLink','authUrl','error','toLowerCase','172dafGpE','payment_id','stringify','prototype','active','then','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','defineProperty','\x20API:\x20','Failed\x20to\x20verify\x20KLYME\x20','URL:','UUID:','POST','Failed\x20to\x20parse\x20JSON\x20response:','💳\x20KLYME\x20','now','hasOwnProperty','172755vzormf','expired','130YDYrsN','\x20API:\x20missing\x20payment\x20data','parse','KLYME\x20','Processing\x20KLYME\x20webhook:','message',',\x20body:\x20','KlymeService','getOwnPropertyNames','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Redirect\x20URL:','random','Error\x20details:','__setModuleDefault','Request\x20Body:','GBP','\x20API\x20error:\x20','logWhiteDomainResponse','Currency\x20Used:','🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20','Unknown\x20error\x20from\x20KLYME\x20','741440ukOaCI','\x20SUCCESS\x20(New\x20Format)\x20===','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','timeout','4591DjUtJi','default','canceled','63TbrbZm','Currency:','Response\x20Body:','processWebhook','\x20SERVICE\x20ERROR\x20===','\x20API\x20BUSINESS\x20ERROR\x20===','in_progress','PENDING','231170dttgTH','(8digits-8digits\x20format)','create','created','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','reference','application/json','Status:','/verify/','order_id','\x20currency\x20validation\x20passed:\x20','logWhiteDomainError','headers','20394FhmfpV','Invalid\x20response\x20from\x20KLYME\x20','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','amount','HTTP\x20','statusCode','loggerService','../loggerService','statusText','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','PAID','processing','Geo\x20Parameter:','Error\x20Message:','\x20payment\x20verification\x20error:','entries','get','log','cancelled','Response\x20data:','===\x20PARSED\x20KLYME\x20','TesSoft\x20Payment\x20System/1.0','configurable','Raw\x20Response\x20Body:','Status\x20Code:','Region\x20(geo):','stack','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','Headers:','verifyPayment','getOwnPropertyDescriptor','klyme_'];a42_0x1557=function(){return _0x37fbda;};return a42_0x1557();}exports[a42_0x3ac2cc(0x102)]=KlymeService;