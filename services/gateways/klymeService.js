'use strict';const a44_0x445693=a44_0xec82;(function(_0x458a0d,_0x28abd8){const _0x121875=a44_0xec82,_0x84b157=_0x458a0d();while(!![]){try{const _0x17f1d6=-parseInt(_0x121875(0xb8))/0x1*(-parseInt(_0x121875(0x13b))/0x2)+-parseInt(_0x121875(0xdf))/0x3*(parseInt(_0x121875(0xec))/0x4)+-parseInt(_0x121875(0x138))/0x5*(parseInt(_0x121875(0xce))/0x6)+-parseInt(_0x121875(0x108))/0x7*(-parseInt(_0x121875(0xee))/0x8)+-parseInt(_0x121875(0xaa))/0x9*(-parseInt(_0x121875(0x101))/0xa)+parseInt(_0x121875(0x117))/0xb+-parseInt(_0x121875(0xd7))/0xc;if(_0x17f1d6===_0x28abd8)break;else _0x84b157['push'](_0x84b157['shift']());}catch(_0xb5b011){_0x84b157['push'](_0x84b157['shift']());}}}(a44_0x2a47,0x7574e));var __createBinding=this&&this[a44_0x445693(0xbf)]||(Object['create']?function(_0x10d1bf,_0x539ff6,_0x56e20b,_0x463d9e){const _0x387cdb=a44_0x445693;if(_0x463d9e===undefined)_0x463d9e=_0x56e20b;var _0xd5f18f=Object['getOwnPropertyDescriptor'](_0x539ff6,_0x56e20b);(!_0xd5f18f||(_0x387cdb(0xb0)in _0xd5f18f?!_0x539ff6['__esModule']:_0xd5f18f[_0x387cdb(0x131)]||_0xd5f18f[_0x387cdb(0xff)]))&&(_0xd5f18f={'enumerable':!![],'get':function(){return _0x539ff6[_0x56e20b];}}),Object['defineProperty'](_0x10d1bf,_0x463d9e,_0xd5f18f);}:function(_0x16c322,_0x1690f3,_0xd4ab2d,_0x491f1f){if(_0x491f1f===undefined)_0x491f1f=_0xd4ab2d;_0x16c322[_0x491f1f]=_0x1690f3[_0xd4ab2d];}),__setModuleDefault=this&&this[a44_0x445693(0x127)]||(Object[a44_0x445693(0x121)]?function(_0xec873f,_0x54102b){const _0x15e914=a44_0x445693;Object[_0x15e914(0xbb)](_0xec873f,_0x15e914(0x125),{'enumerable':!![],'value':_0x54102b});}:function(_0x95dd48,_0x5e127c){_0x95dd48['default']=_0x5e127c;}),__importStar=this&&this[a44_0x445693(0xc1)]||(function(){var _0x2c851a=function(_0x2eb512){return _0x2c851a=Object['getOwnPropertyNames']||function(_0x32dd42){const _0x516283=a44_0xec82;var _0x53cd6e=[];for(var _0x4a79a4 in _0x32dd42)if(Object[_0x516283(0x106)][_0x516283(0x11c)][_0x516283(0x12d)](_0x32dd42,_0x4a79a4))_0x53cd6e[_0x53cd6e['length']]=_0x4a79a4;return _0x53cd6e;},_0x2c851a(_0x2eb512);};return function(_0x52991f){const _0x3b0e39=a44_0xec82;if(_0x52991f&&_0x52991f[_0x3b0e39(0x10a)])return _0x52991f;var _0x414167={};if(_0x52991f!=null){for(var _0x38fb19=_0x2c851a(_0x52991f),_0x9d5ae7=0x0;_0x9d5ae7<_0x38fb19[_0x3b0e39(0xc0)];_0x9d5ae7++)if(_0x38fb19[_0x9d5ae7]!==_0x3b0e39(0x125))__createBinding(_0x414167,_0x52991f,_0x38fb19[_0x9d5ae7]);}return __setModuleDefault(_0x414167,_0x52991f),_0x414167;};}());Object[a44_0x445693(0xbb)](exports,a44_0x445693(0x10a),{'value':!![]}),exports[a44_0x445693(0x136)]=void 0x0;const loggerService_1=require(a44_0x445693(0xcc));class KlymeService{constructor(){const _0x4ff83b=a44_0x445693;this['apiUrl']=_0x4ff83b(0x135),console[_0x4ff83b(0xe5)](_0x4ff83b(0xe4));}[a44_0x445693(0x128)](_0x2807ef,_0x245008){const _0x1d8a0f=a44_0x445693,_0x2c7045=_0x2807ef['toUpperCase']();switch(_0x245008){case'EU':if(_0x2c7045!==_0x1d8a0f(0xbe))throw new Error(_0x1d8a0f(0x122)+_0x2c7045);break;case'GB':if(_0x2c7045!==_0x1d8a0f(0x13c))throw new Error(_0x1d8a0f(0x126)+_0x2c7045);break;case'DE':if(_0x2c7045!==_0x1d8a0f(0xbe))throw new Error(_0x1d8a0f(0x12f)+_0x2c7045);break;default:throw new Error(_0x1d8a0f(0x112)+_0x245008);}}async['generateUniqueReference'](){const _0x3580ca=a44_0x445693,_0x243cca=(await Promise[_0x3580ca(0xf1)]()[_0x3580ca(0xca)](()=>__importStar(require(_0x3580ca(0xdb)))))[_0x3580ca(0x125)];let _0x577d1b,_0x3ad55a=0x0;const _0x458d52=0xa;do{const _0x21a98a=()=>{const _0x109c05=_0x3580ca;return Math['floor'](Math['random']()*0x5f5e100)[_0x109c05(0x11e)]()[_0x109c05(0x11a)](0x8,'0');};_0x577d1b=_0x21a98a()+'-'+_0x21a98a();const _0x46451e=await _0x243cca[_0x3580ca(0x109)]['findFirst']({'where':{'gatewayOrderId':_0x577d1b}});if(!_0x46451e)break;_0x3ad55a++,console[_0x3580ca(0xe5)](_0x3580ca(0x13a)+_0x577d1b+'\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20'+_0x3ad55a+')');}while(_0x3ad55a<_0x458d52);if(_0x3ad55a>=_0x458d52)throw new Error(_0x3580ca(0x103));return _0x577d1b;}async['createPaymentLink'](_0x147408){const _0x16e598=a44_0x445693,{orderId:_0x56b4c8,amount:_0x2e1489,currency:_0x250170,region:_0x22a5f9}=_0x147408;if(_0x22a5f9!=='EU'&&_0x22a5f9!=='GB'&&_0x22a5f9!=='DE')throw new Error(_0x16e598(0xef)+_0x22a5f9);this[_0x16e598(0x128)](_0x250170,_0x22a5f9);const _0x5cb6e4=_0x250170['toUpperCase']();console['log'](_0x16e598(0x100)+_0x22a5f9+_0x16e598(0xe2)+_0x5cb6e4);const _0x14d5b3=await this[_0x16e598(0xe3)]();console[_0x16e598(0xe5)]('🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20'+_0x14d5b3+_0x16e598(0xfb)+_0x22a5f9+')');const _0x5d21d8='https://tesoft.uk/gateway/pending.php?id='+_0x56b4c8,_0x1054df={'amount':_0x2e1489,'currency':_0x5cb6e4,'redirectUrl':_0x5d21d8,'reference':_0x14d5b3,'geo':_0x22a5f9},_0x4d6b2f=Date[_0x16e598(0x118)]();try{console[_0x16e598(0xe5)]('===\x20KLYME\x20'+_0x22a5f9+'\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20==='),console[_0x16e598(0xe5)](_0x16e598(0x119),this[_0x16e598(0xd2)]),console[_0x16e598(0xe5)]('Request\x20Body:',JSON[_0x16e598(0x11d)](_0x1054df,null,0x2)),console[_0x16e598(0xe5)]('Region\x20(geo):',_0x22a5f9),console[_0x16e598(0xe5)](_0x16e598(0x107),_0x5cb6e4,_0x16e598(0xe1)+_0x22a5f9+')'),console[_0x16e598(0xe5)]('Reference:',_0x14d5b3,_0x16e598(0xf8)),console[_0x16e598(0xe5)](_0x16e598(0x105),_0x5d21d8),loggerService_1[_0x16e598(0xe6)][_0x16e598(0x116)](_0x16e598(0xde)+_0x22a5f9[_0x16e598(0xc3)](),_0x16e598(0xea),'POST',_0x1054df);const _0x712e9a=await fetch(this[_0x16e598(0xd2)],{'method':'POST','headers':{'Content-Type':_0x16e598(0x102),'Accept':_0x16e598(0x102),'User-Agent':_0x16e598(0xb1)},'body':JSON[_0x16e598(0x11d)](_0x1054df)}),_0x59df56=Date[_0x16e598(0x118)]()-_0x4d6b2f;console['log']('===\x20KLYME\x20'+_0x22a5f9+'\x20API\x20RESPONSE\x20(Unified\x20Route)\x20==='),console[_0x16e598(0xe5)](_0x16e598(0xb7),_0x712e9a['status']),console['log'](_0x16e598(0xb6),_0x712e9a['statusText']),console[_0x16e598(0xe5)]('Headers:',Object[_0x16e598(0x10c)](_0x712e9a[_0x16e598(0x113)][_0x16e598(0x10f)]())),console[_0x16e598(0xe5)](_0x16e598(0xd4),_0x59df56+'ms');const _0x566a14=await _0x712e9a[_0x16e598(0xc6)]();console[_0x16e598(0xe5)]('Raw\x20Response\x20Body:',_0x566a14);if(!_0x712e9a['ok']){console[_0x16e598(0xad)](_0x16e598(0xf5)+_0x22a5f9+_0x16e598(0xd8)),console[_0x16e598(0xad)](_0x16e598(0xe7),_0x712e9a['status']),console[_0x16e598(0xad)]('Response\x20Body:',_0x566a14),loggerService_1[_0x16e598(0xe6)]['logWhiteDomainResponse']('klyme_'+_0x22a5f9[_0x16e598(0xc3)](),_0x16e598(0xea),_0x712e9a['status'],_0x566a14,_0x59df56),loggerService_1[_0x16e598(0xe6)]['logWhiteDomainError'](_0x16e598(0xde)+_0x22a5f9[_0x16e598(0xc3)](),_0x16e598(0xea),_0x16e598(0x129)+_0x712e9a[_0x16e598(0xeb)]+':\x20'+_0x566a14);throw new Error(_0x16e598(0xf3)+_0x712e9a['status']+_0x16e598(0x11b)+_0x566a14);}let _0x465fe0;try{_0x465fe0=JSON[_0x16e598(0xf9)](_0x566a14);}catch(_0x41edf2){console[_0x16e598(0xad)](_0x16e598(0xf0),_0x41edf2),loggerService_1[_0x16e598(0xe6)]['logWhiteDomainError']('klyme_'+_0x22a5f9[_0x16e598(0xc3)](),_0x16e598(0xea),'JSON\x20Parse\x20Error:\x20'+_0x41edf2);throw new Error(_0x16e598(0x139)+_0x22a5f9+_0x16e598(0xc4)+_0x566a14);}console[_0x16e598(0xe5)](_0x16e598(0x114)+_0x22a5f9+_0x16e598(0x12c)),console['log'](_0x16e598(0xfd),JSON['stringify'](_0x465fe0,null,0x2)),loggerService_1[_0x16e598(0xe6)][_0x16e598(0xd1)]('klyme_'+_0x22a5f9['toLowerCase'](),_0x16e598(0xea),_0x712e9a['status'],_0x465fe0,_0x59df56);if(_0x465fe0['error']||_0x465fe0[_0x16e598(0x133)]){const _0x104b12=_0x465fe0[_0x16e598(0xab)]||_0x465fe0[_0x16e598(0xad)]||_0x16e598(0xf4)+_0x22a5f9+_0x16e598(0x110);console[_0x16e598(0xad)](_0x16e598(0xf5)+_0x22a5f9+'\x20API\x20BUSINESS\x20ERROR\x20==='),console['error'](_0x16e598(0x124),_0x104b12),console[_0x16e598(0xad)](_0x16e598(0x12b),_0x465fe0['statusCode']),loggerService_1[_0x16e598(0xe6)]['logWhiteDomainError'](_0x16e598(0xde)+_0x22a5f9[_0x16e598(0xc3)](),'/create',_0x16e598(0xb2)+_0x104b12);throw new Error(_0x16e598(0xbd)+_0x22a5f9+'\x20API\x20error:\x20'+_0x104b12);}let _0x3bfbb6,_0x3920e2;if(_0x465fe0[_0x16e598(0xc9)]&&_0x465fe0[_0x16e598(0x104)])_0x3bfbb6=_0x465fe0['uuid'],_0x3920e2=_0x465fe0[_0x16e598(0x104)],console[_0x16e598(0xe5)](_0x16e598(0xf5)+_0x22a5f9+_0x16e598(0xd9)),console[_0x16e598(0xe5)](_0x16e598(0x10e),_0x465fe0[_0x16e598(0xc9)]),console[_0x16e598(0xe5)](_0x16e598(0x105),_0x465fe0[_0x16e598(0x104)]);else{if(_0x465fe0[_0x16e598(0x111)])_0x3bfbb6=_0x14d5b3,_0x3920e2=_0x465fe0[_0x16e598(0x111)],console[_0x16e598(0xe5)](_0x16e598(0xf5)+_0x22a5f9+_0x16e598(0xe9)),console[_0x16e598(0xe5)]('Auth\x20URL:',_0x465fe0[_0x16e598(0x111)]),console[_0x16e598(0xe5)](_0x16e598(0x137),_0x14d5b3);else{console[_0x16e598(0xad)](_0x16e598(0xf5)+_0x22a5f9+_0x16e598(0xb3)),console[_0x16e598(0xad)](_0x16e598(0xc2)),console[_0x16e598(0xad)]('Response\x20data:',_0x465fe0),loggerService_1['loggerService'][_0x16e598(0xae)](_0x16e598(0xde)+_0x22a5f9[_0x16e598(0xc3)](),_0x16e598(0xea),_0x16e598(0xe0));throw new Error(_0x16e598(0xc5)+_0x22a5f9+'\x20API:\x20missing\x20payment\x20data');}}return console[_0x16e598(0xe5)](_0x16e598(0xcf),_0x5cb6e4,'('+_0x22a5f9+'\x20validated)'),console[_0x16e598(0xe5)]('Reference\x20Used:',_0x14d5b3,'(8digits-8digits\x20format)'),console[_0x16e598(0xe5)](_0x16e598(0x123),_0x22a5f9),{'gateway_payment_id':_0x3bfbb6,'payment_url':_0x3920e2};}catch(_0x36c84c){console[_0x16e598(0xad)]('===\x20KLYME\x20'+_0x22a5f9+'\x20SERVICE\x20ERROR\x20==='),console['error'](_0x16e598(0xb5),_0x36c84c),loggerService_1[_0x16e598(0xe6)][_0x16e598(0xae)](_0x16e598(0xde)+_0x22a5f9[_0x16e598(0xc3)](),'/create',_0x36c84c);if(_0x36c84c instanceof Error){console[_0x16e598(0xad)](_0x16e598(0xed),_0x36c84c[_0x16e598(0xab)]),console[_0x16e598(0xad)](_0x16e598(0x10d),_0x36c84c[_0x16e598(0x11f)]);throw new Error(_0x16e598(0xd3)+_0x22a5f9+_0x16e598(0xd5)+_0x36c84c[_0x16e598(0xab)]);}throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0x22a5f9+_0x16e598(0xfc));}}async[a44_0x445693(0xfe)](_0x201a46,_0x10e0c8){const _0x3440d7=a44_0x445693,_0x134bae=Date[_0x3440d7(0x118)]();try{const _0x3df1a6={'gatewayPaymentId':_0x201a46,'geo':_0x10e0c8};loggerService_1['loggerService']['logWhiteDomainRequest'](_0x3440d7(0xde)+_0x10e0c8[_0x3440d7(0xc3)](),'/verify/'+_0x201a46,_0x3440d7(0xd0),_0x3df1a6);const _0x1ae1a6=await fetch(this[_0x3440d7(0xd2)],{'method':_0x3440d7(0xd0),'headers':{'Content-Type':'application/json','User-Agent':_0x3440d7(0xb1)},'body':JSON[_0x3440d7(0x11d)](_0x3df1a6)}),_0x33d74f=Date[_0x3440d7(0x118)]()-_0x134bae;if(!_0x1ae1a6['ok']){const _0x5b23b8=await _0x1ae1a6[_0x3440d7(0xc6)]();loggerService_1[_0x3440d7(0xe6)][_0x3440d7(0xd1)](_0x3440d7(0xde)+_0x10e0c8[_0x3440d7(0xc3)](),_0x3440d7(0xfa)+_0x201a46,_0x1ae1a6[_0x3440d7(0xeb)],_0x5b23b8,_0x33d74f);throw new Error(_0x3440d7(0xf3)+_0x1ae1a6[_0x3440d7(0xeb)]);}const _0x3312ee=await _0x1ae1a6[_0x3440d7(0x120)]();loggerService_1[_0x3440d7(0xe6)][_0x3440d7(0xd1)](_0x3440d7(0xde)+_0x10e0c8['toLowerCase'](),'/verify/'+_0x201a46,_0x1ae1a6['status'],_0x3312ee,_0x33d74f);if(_0x3312ee[_0x3440d7(0xad)]||_0x3312ee[_0x3440d7(0x133)]){loggerService_1[_0x3440d7(0xe6)]['logWhiteDomainError'](_0x3440d7(0xde)+_0x10e0c8['toLowerCase'](),_0x3440d7(0xfa)+_0x201a46,_0x3440d7(0xbd)+_0x10e0c8+_0x3440d7(0xd6)+(_0x3312ee[_0x3440d7(0xab)]||_0x3312ee[_0x3440d7(0xad)]||'Unknown\x20error'));throw new Error(_0x3440d7(0xbd)+_0x10e0c8+_0x3440d7(0xd6)+(_0x3312ee[_0x3440d7(0xab)]||_0x3312ee[_0x3440d7(0xad)]||_0x3440d7(0x134)));}let _0x35ad3a=_0x3440d7(0xb9);return{'status':_0x35ad3a};}catch(_0x239b67){console[_0x3440d7(0xad)]('KLYME\x20'+_0x10e0c8+_0x3440d7(0xac),_0x239b67),loggerService_1[_0x3440d7(0xe6)][_0x3440d7(0xae)](_0x3440d7(0xde)+_0x10e0c8[_0x3440d7(0xc3)](),'/verify/'+_0x201a46,_0x239b67);throw new Error(_0x3440d7(0xdc)+_0x10e0c8+'\x20payment:\x20'+(_0x239b67 instanceof Error?_0x239b67[_0x3440d7(0xab)]:_0x3440d7(0x134)));}}async['processWebhook'](_0x1198e1){const _0x264514=a44_0x445693;console['log'](_0x264514(0xe8),_0x1198e1);let _0x81a4e5=_0x264514(0xb9);switch(_0x1198e1[_0x264514(0xeb)]?.['toLowerCase']()){case'paid':case'completed':case _0x264514(0xc8):case _0x264514(0xdd):case _0x264514(0x12a):_0x81a4e5=_0x264514(0x115);break;case _0x264514(0xba):case _0x264514(0xf6):case'failed':case'error':case _0x264514(0xbc):_0x81a4e5=_0x264514(0x132);break;case _0x264514(0xcd):case _0x264514(0x12e):_0x81a4e5=_0x264514(0x10b);break;case _0x264514(0xf2):case'created':case'active':case'processing':case _0x264514(0x130):default:_0x81a4e5='PENDING';break;}return{'paymentId':_0x1198e1[_0x264514(0xc7)]||_0x1198e1[_0x264514(0xb4)]||_0x1198e1[_0x264514(0xcb)],'status':_0x81a4e5,'amount':_0x1198e1['amount'],'currency':_0x1198e1[_0x264514(0xda)],'region':_0x1198e1[_0x264514(0xaf)],'additionalInfo':{'payment_method':_0x1198e1[_0x264514(0x13d)],'transaction_id':_0x1198e1[_0x264514(0xf7)]}};}}function a44_0xec82(_0x256ad3,_0x5ad62f){const _0x2a47ba=a44_0x2a47();return a44_0xec82=function(_0xec82e2,_0x226415){_0xec82e2=_0xec82e2-0xaa;let _0x350482=_0x2a47ba[_0xec82e2];return _0x350482;},a44_0xec82(_0x256ad3,_0x5ad62f);}function a44_0x2a47(){const _0xc09f6=['entries','\x20API','authUrl','Unsupported\x20KLYME\x20region:\x20','headers','===\x20PARSED\x20KLYME\x20','PAID','logWhiteDomainRequest','340670TsPGpB','now','URL:','padStart',',\x20body:\x20','hasOwnProperty','stringify','toString','stack','json','create','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Geo\x20Parameter:','Error\x20Message:','default','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','__setModuleDefault','validateCurrencyForRegion','HTTP\x20','successful','Status\x20Code:','\x20RESPONSE\x20===','call','timeout','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','in_progress','writable','FAILED','statusCode','Unknown\x20error','https://tesoft.uk/gateway/klyme/','KlymeService','Reference\x20Used\x20as\x20ID:','215iFHZXd','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','⚠️\x20KLYME\x20reference\x20','458zydOBF','GBP','payment_method','9vZvBhQ','message','\x20payment\x20verification\x20error:','error','logWhiteDomainError','region','get','TesSoft\x20Payment\x20System/1.0','Business\x20Error:\x20','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','order_id','Error\x20details:','Status\x20Text:','Status:','23Aisqpn','PENDING','cancelled','defineProperty','rejected','KLYME\x20','EUR','__createBinding','length','__importStar','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','toLowerCase','\x20API:\x20','Invalid\x20response\x20from\x20KLYME\x20','text','reference','confirmed','uuid','then','payment_id','../loggerService','expired','83562dudkpP','Currency\x20Used:','POST','logWhiteDomainResponse','apiUrl','Failed\x20to\x20create\x20KLYME\x20','Response\x20Time:','\x20payment\x20link:\x20','\x20API\x20error:\x20','1659636NKfxLR','\x20API\x20ERROR\x20===','\x20SUCCESS\x20(New\x20Format)\x20===','currency','../../config/database','Failed\x20to\x20verify\x20KLYME\x20','success','klyme_','6rdYfVf','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','(validated\x20for\x20','\x20currency\x20validation\x20passed:\x20','generateUniqueReference','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','log','loggerService','HTTP\x20Status:','Processing\x20KLYME\x20webhook:','\x20SUCCESS\x20(Legacy\x20Format)\x20===','/create','status','278348EdZfjW','Error\x20message:','3472NGCTzM','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','Failed\x20to\x20parse\x20JSON\x20response:','resolve','pending','HTTP\x20error!\x20status:\x20','Unknown\x20error\x20from\x20KLYME\x20','===\x20KLYME\x20','canceled','transaction_id','(8digits-8digits\x20format)','parse','/verify/','\x20(8digits-8digits\x20format\x20for\x20','\x20payment\x20link:\x20Unknown\x20error','Parsed\x20Result:','verifyPayment','configurable','💳\x20KLYME\x20','3624970bkGSGK','application/json','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','redirect_url','Redirect\x20URL:','prototype','Currency:','15463xpqbNF','payment','__esModule','EXPIRED','fromEntries','Error\x20stack:','UUID:'];a44_0x2a47=function(){return _0xc09f6;};return a44_0x2a47();}exports[a44_0x445693(0x136)]=KlymeService;