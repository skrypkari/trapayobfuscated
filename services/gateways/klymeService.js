'use strict';const a67_0x395bb3=a67_0x4740;(function(_0x3cc819,_0x3516e3){const _0x58971f=a67_0x4740,_0x20e622=_0x3cc819();while(!![]){try{const _0x3364e8=parseInt(_0x58971f(0x129))/0x1+-parseInt(_0x58971f(0x11e))/0x2+parseInt(_0x58971f(0xf0))/0x3*(-parseInt(_0x58971f(0xf2))/0x4)+parseInt(_0x58971f(0xe3))/0x5+parseInt(_0x58971f(0x137))/0x6*(-parseInt(_0x58971f(0xe8))/0x7)+parseInt(_0x58971f(0x10f))/0x8*(-parseInt(_0x58971f(0xf5))/0x9)+parseInt(_0x58971f(0xd5))/0xa;if(_0x3364e8===_0x3516e3)break;else _0x20e622['push'](_0x20e622['shift']());}catch(_0xed1625){_0x20e622['push'](_0x20e622['shift']());}}}(a67_0x18e2,0x93d24));var __createBinding=this&&this[a67_0x395bb3(0xe6)]||(Object[a67_0x395bb3(0xbb)]?function(_0x4c2192,_0xe3bfef,_0x4338af,_0x299880){const _0xc8435c=a67_0x395bb3;if(_0x299880===undefined)_0x299880=_0x4338af;var _0x5f01f4=Object['getOwnPropertyDescriptor'](_0xe3bfef,_0x4338af);(!_0x5f01f4||(_0xc8435c(0xe5)in _0x5f01f4?!_0xe3bfef[_0xc8435c(0xba)]:_0x5f01f4[_0xc8435c(0xf1)]||_0x5f01f4[_0xc8435c(0x10e)]))&&(_0x5f01f4={'enumerable':!![],'get':function(){return _0xe3bfef[_0x4338af];}}),Object[_0xc8435c(0x13b)](_0x4c2192,_0x299880,_0x5f01f4);}:function(_0x3dd3c2,_0x1a2ba9,_0x41428c,_0x2b1f17){if(_0x2b1f17===undefined)_0x2b1f17=_0x41428c;_0x3dd3c2[_0x2b1f17]=_0x1a2ba9[_0x41428c];}),__setModuleDefault=this&&this[a67_0x395bb3(0xd7)]||(Object['create']?function(_0x30cec3,_0x2b93de){const _0x2d45fb=a67_0x395bb3;Object[_0x2d45fb(0x13b)](_0x30cec3,_0x2d45fb(0x113),{'enumerable':!![],'value':_0x2b93de});}:function(_0xbc5746,_0xf1fde0){const _0x189995=a67_0x395bb3;_0xbc5746[_0x189995(0x113)]=_0xf1fde0;}),__importStar=this&&this[a67_0x395bb3(0x138)]||(function(){var _0x2760de=function(_0x468d45){const _0x1821c3=a67_0x4740;return _0x2760de=Object[_0x1821c3(0xcb)]||function(_0x1a04ca){const _0x174ec2=_0x1821c3;var _0x2db027=[];for(var _0x50b44c in _0x1a04ca)if(Object[_0x174ec2(0xa9)][_0x174ec2(0x13d)][_0x174ec2(0x100)](_0x1a04ca,_0x50b44c))_0x2db027[_0x2db027['length']]=_0x50b44c;return _0x2db027;},_0x2760de(_0x468d45);};return function(_0x52d38f){const _0x1a26a6=a67_0x4740;if(_0x52d38f&&_0x52d38f[_0x1a26a6(0xba)])return _0x52d38f;var _0x5ca8e3={};if(_0x52d38f!=null){for(var _0x5b041b=_0x2760de(_0x52d38f),_0x354688=0x0;_0x354688<_0x5b041b['length'];_0x354688++)if(_0x5b041b[_0x354688]!=='default')__createBinding(_0x5ca8e3,_0x52d38f,_0x5b041b[_0x354688]);}return __setModuleDefault(_0x5ca8e3,_0x52d38f),_0x5ca8e3;};}());Object[a67_0x395bb3(0x13b)](exports,a67_0x395bb3(0xba),{'value':!![]}),exports['KlymeService']=void 0x0;function a67_0x18e2(){const _0x2a078e=['\x20API\x20error:\x20','PENDING','configurable','160oNEapz','PAID','FAILED','UUID:','default','Response\x20Body:','Error\x20Message:','Error\x20stack:','status','Raw\x20Response\x20Body:','Processing\x20KLYME\x20webhook:','Currency:','KLYME\x20','Region\x20(geo):','Geo\x20Parameter:','2413434wFwDvN','Unsupported\x20KLYME\x20region:\x20','currency','created','cancelled','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Reference\x20Used\x20as\x20ID:','Response\x20Time:','payment_method','toLowerCase','(validated\x20for\x20','1064929QFkPvu','Invalid\x20response\x20from\x20KLYME\x20','\x20payment\x20link:\x20Unknown\x20error','toUpperCase','\x20payment\x20link:\x20','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','\x20API\x20ERROR\x20===','json','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','\x20SUCCESS\x20(New\x20Format)\x20===','authUrl','findFirst','headers','\x20API:\x20missing\x20payment\x20data','889176hFBqEy','__importStar','amount','createPaymentLink','defineProperty','logWhiteDomainRequest','hasOwnProperty','prototype','\x20currency\x20validation\x20passed:\x20','apiUrl','logWhiteDomainError','pending','Redirect\x20URL:','then','completed','random','===\x20KLYME\x20','generateUniqueReference','parse','ðŸ’³\x20KLYME\x20','GBP','now','Status:','/create','__esModule','create','failed','confirmed','Request\x20Body:','application/json','Headers:','/verify/','uuid','reference','HTTP\x20Status:','message','ðŸ’³\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','success','in_progress','===\x20PARSED\x20KLYME\x20','payment_id','getOwnPropertyNames','Status\x20Code:','\x20(8digits-8digits\x20format\x20for\x20','Error\x20details:','log','https://tesoft.uk/gateway/pending.php?id=','floor','region','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','KlymeService','24298590fwXSir','Business\x20Error:\x20','__setModuleDefault','URL:','stringify','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','processWebhook','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','error','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','../loggerService','(8digits-8digits\x20format)','redirect_url','EUR','3031480ArKfIe','Auth\x20URL:','get','__createBinding','text','35OsSYcf','../../config/database','canceled','logWhiteDomainResponse','loggerService','payment','Status\x20Text:','timeout','3191493WRyZWN','writable','4zxHHTT','\x20payment\x20verification\x20error:','Response\x20data:','217836IwxZyy','HTTP\x20error!\x20status:\x20','Reference\x20Used:','resolve','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','âš ï¸\x20KLYME\x20reference\x20','JSON\x20Parse\x20Error:\x20','validateCurrencyForRegion','processing','\x20RESPONSE\x20===','POST','call','padStart','Payment\x20System/1.0',',\x20body:\x20','Failed\x20to\x20create\x20KLYME\x20','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','klyme_','verifyPayment','Unknown\x20error','statusText','EXPIRED'];a67_0x18e2=function(){return _0x2a078e;};return a67_0x18e2();}function a67_0x4740(_0x5666b8,_0x60878d){_0x5666b8=_0x5666b8-0xa9;const _0x18e295=a67_0x18e2();let _0x4740c0=_0x18e295[_0x5666b8];return _0x4740c0;}const loggerService_1=require(a67_0x395bb3(0xdf));class KlymeService{constructor(){const _0x59c117=a67_0x395bb3;this[_0x59c117(0xab)]='https://tesoft.uk/gateway/klyme/',console[_0x59c117(0xcf)](_0x59c117(0xc6));}[a67_0x395bb3(0xfc)](_0x1bc348,_0x5d9f33){const _0x39bc49=a67_0x395bb3,_0x3c88fa=_0x1bc348['toUpperCase']();switch(_0x5d9f33){case'EU':if(_0x3c88fa!=='EUR')throw new Error(_0x39bc49(0xf9)+_0x3c88fa);break;case'GB':if(_0x3c88fa!==_0x39bc49(0xb6))throw new Error(_0x39bc49(0x106)+_0x3c88fa);break;case'DE':if(_0x3c88fa!==_0x39bc49(0xe2))throw new Error(_0x39bc49(0x123)+_0x3c88fa);break;default:throw new Error(_0x39bc49(0x11f)+_0x5d9f33);}}async[a67_0x395bb3(0xb3)](){const _0x6f52f5=a67_0x395bb3,_0x5f5ca7=(await Promise[_0x6f52f5(0xf8)]()[_0x6f52f5(0xaf)](()=>__importStar(require(_0x6f52f5(0xe9)))))[_0x6f52f5(0x113)];let _0x292690,_0x6ea728=0x0;const _0x4a1268=0xa;do{const _0x5d38de=()=>{const _0x1186f4=_0x6f52f5;return Math[_0x1186f4(0xd1)](Math[_0x1186f4(0xb1)]()*0x5f5e100)['toString']()[_0x1186f4(0x101)](0x8,'0');};_0x292690=_0x5d38de()+'-'+_0x5d38de();const _0x1eb436=await _0x5f5ca7[_0x6f52f5(0xed)][_0x6f52f5(0x134)]({'where':{'gatewayOrderId':_0x292690}});if(!_0x1eb436)break;_0x6ea728++,console['log'](_0x6f52f5(0xfa)+_0x292690+_0x6f52f5(0xda)+_0x6ea728+')');}while(_0x6ea728<_0x4a1268);if(_0x6ea728>=_0x4a1268)throw new Error(_0x6f52f5(0xd3));return _0x292690;}async[a67_0x395bb3(0x13a)](_0x15e973){const _0x524e50=a67_0x395bb3,{orderId:_0x5683cd,amount:_0x4afb48,currency:_0x56e940,region:_0x440e75}=_0x15e973;if(_0x440e75!=='EU'&&_0x440e75!=='GB'&&_0x440e75!=='DE')throw new Error(_0x524e50(0x131)+_0x440e75);this[_0x524e50(0xfc)](_0x56e940,_0x440e75);const _0x22dac0=_0x56e940[_0x524e50(0x12c)]();console['log'](_0x524e50(0xb5)+_0x440e75+_0x524e50(0xaa)+_0x22dac0);const _0x137004=await this[_0x524e50(0xb3)]();console[_0x524e50(0xcf)]('ðŸŽ¯\x20Generated\x20unique\x20KLYME\x20reference:\x20'+_0x137004+_0x524e50(0xcd)+_0x440e75+')');const _0x71573c=_0x524e50(0xd0)+_0x5683cd,_0x4c1215={'amount':_0x4afb48,'currency':_0x22dac0,'redirectUrl':_0x71573c,'reference':_0x137004,'geo':_0x440e75},_0x243b76=Date[_0x524e50(0xb7)]();try{console['log'](_0x524e50(0xb2)+_0x440e75+_0x524e50(0x12e)),console[_0x524e50(0xcf)](_0x524e50(0xd8),this['apiUrl']),console[_0x524e50(0xcf)](_0x524e50(0xbe),JSON[_0x524e50(0xd9)](_0x4c1215,null,0x2)),console['log'](_0x524e50(0x11c),_0x440e75),console[_0x524e50(0xcf)](_0x524e50(0x11a),_0x22dac0,_0x524e50(0x128)+_0x440e75+')'),console['log']('Reference:',_0x137004,_0x524e50(0xe0)),console[_0x524e50(0xcf)](_0x524e50(0xae),_0x71573c),loggerService_1[_0x524e50(0xec)][_0x524e50(0x13c)](_0x524e50(0x107)+_0x440e75['toLowerCase'](),_0x524e50(0xb9),_0x524e50(0xff),_0x4c1215);const _0x68f601=await fetch(this[_0x524e50(0xab)],{'method':_0x524e50(0xff),'headers':{'Content-Type':_0x524e50(0xbf),'Accept':'application/json','User-Agent':_0x524e50(0x102)},'body':JSON[_0x524e50(0xd9)](_0x4c1215)}),_0x4b66e1=Date['now']()-_0x243b76;console[_0x524e50(0xcf)](_0x524e50(0xb2)+_0x440e75+_0x524e50(0xdc)),console[_0x524e50(0xcf)](_0x524e50(0xb8),_0x68f601[_0x524e50(0x117)]),console['log'](_0x524e50(0xee),_0x68f601[_0x524e50(0x10a)]),console[_0x524e50(0xcf)](_0x524e50(0xc0),Object['fromEntries'](_0x68f601[_0x524e50(0x135)]['entries']())),console[_0x524e50(0xcf)](_0x524e50(0x125),_0x4b66e1+'ms');const _0x6d5b12=await _0x68f601[_0x524e50(0xe7)]();console['log'](_0x524e50(0x118),_0x6d5b12);if(!_0x68f601['ok']){console[_0x524e50(0xdd)](_0x524e50(0xb2)+_0x440e75+_0x524e50(0x12f)),console['error'](_0x524e50(0xc4),_0x68f601[_0x524e50(0x117)]),console[_0x524e50(0xdd)](_0x524e50(0x114),_0x6d5b12),loggerService_1['loggerService']['logWhiteDomainResponse']('klyme_'+_0x440e75[_0x524e50(0x127)](),_0x524e50(0xb9),_0x68f601[_0x524e50(0x117)],_0x6d5b12,_0x4b66e1),loggerService_1[_0x524e50(0xec)]['logWhiteDomainError'](_0x524e50(0x107)+_0x440e75[_0x524e50(0x127)](),_0x524e50(0xb9),'HTTP\x20'+_0x68f601[_0x524e50(0x117)]+':\x20'+_0x6d5b12);throw new Error(_0x524e50(0xf6)+_0x68f601[_0x524e50(0x117)]+_0x524e50(0x103)+_0x6d5b12);}let _0x1da27f;try{_0x1da27f=JSON[_0x524e50(0xb4)](_0x6d5b12);}catch(_0x1c087b){console[_0x524e50(0xdd)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x1c087b),loggerService_1[_0x524e50(0xec)]['logWhiteDomainError'](_0x524e50(0x107)+_0x440e75['toLowerCase'](),_0x524e50(0xb9),_0x524e50(0xfb)+_0x1c087b);throw new Error('Invalid\x20JSON\x20response\x20from\x20KLYME\x20'+_0x440e75+'\x20API:\x20'+_0x6d5b12);}console[_0x524e50(0xcf)](_0x524e50(0xc9)+_0x440e75+_0x524e50(0xfe)),console['log']('Parsed\x20Result:',JSON[_0x524e50(0xd9)](_0x1da27f,null,0x2)),loggerService_1[_0x524e50(0xec)][_0x524e50(0xeb)](_0x524e50(0x107)+_0x440e75[_0x524e50(0x127)](),'/create',_0x68f601[_0x524e50(0x117)],_0x1da27f,_0x4b66e1);if(_0x1da27f['error']||_0x1da27f['statusCode']){const _0x5acc4b=_0x1da27f[_0x524e50(0xc5)]||_0x1da27f['error']||'Unknown\x20error\x20from\x20KLYME\x20'+_0x440e75+'\x20API';console[_0x524e50(0xdd)](_0x524e50(0xb2)+_0x440e75+'\x20API\x20BUSINESS\x20ERROR\x20==='),console['error'](_0x524e50(0x115),_0x5acc4b),console['error'](_0x524e50(0xcc),_0x1da27f['statusCode']),loggerService_1['loggerService'][_0x524e50(0xac)](_0x524e50(0x107)+_0x440e75['toLowerCase'](),_0x524e50(0xb9),_0x524e50(0xd6)+_0x5acc4b);throw new Error(_0x524e50(0x11b)+_0x440e75+_0x524e50(0x10c)+_0x5acc4b);}let _0x3b32d6,_0x2b1fd9;if(_0x1da27f['uuid']&&_0x1da27f[_0x524e50(0xe1)])_0x3b32d6=_0x1da27f[_0x524e50(0xc2)],_0x2b1fd9=_0x1da27f[_0x524e50(0xe1)],console[_0x524e50(0xcf)](_0x524e50(0xb2)+_0x440e75+_0x524e50(0x132)),console['log'](_0x524e50(0x112),_0x1da27f[_0x524e50(0xc2)]),console[_0x524e50(0xcf)]('Redirect\x20URL:',_0x1da27f[_0x524e50(0xe1)]);else{if(_0x1da27f[_0x524e50(0x133)])_0x3b32d6=_0x137004,_0x2b1fd9=_0x1da27f[_0x524e50(0x133)],console[_0x524e50(0xcf)](_0x524e50(0xb2)+_0x440e75+'\x20SUCCESS\x20(Legacy\x20Format)\x20==='),console[_0x524e50(0xcf)](_0x524e50(0xe4),_0x1da27f[_0x524e50(0x133)]),console['log'](_0x524e50(0x124),_0x137004);else{console[_0x524e50(0xdd)](_0x524e50(0xb2)+_0x440e75+_0x524e50(0xde)),console[_0x524e50(0xdd)]('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console[_0x524e50(0xdd)](_0x524e50(0xf4),_0x1da27f),loggerService_1['loggerService'][_0x524e50(0xac)]('klyme_'+_0x440e75[_0x524e50(0x127)](),_0x524e50(0xb9),_0x524e50(0x105));throw new Error(_0x524e50(0x12a)+_0x440e75+_0x524e50(0x136));}}return console[_0x524e50(0xcf)]('Currency\x20Used:',_0x22dac0,'('+_0x440e75+'\x20validated)'),console[_0x524e50(0xcf)](_0x524e50(0xf7),_0x137004,_0x524e50(0xe0)),console[_0x524e50(0xcf)](_0x524e50(0x11d),_0x440e75),{'gateway_payment_id':_0x3b32d6,'payment_url':_0x2b1fd9};}catch(_0x1f4c9c){console[_0x524e50(0xdd)]('===\x20KLYME\x20'+_0x440e75+'\x20SERVICE\x20ERROR\x20==='),console[_0x524e50(0xdd)](_0x524e50(0xce),_0x1f4c9c),loggerService_1[_0x524e50(0xec)][_0x524e50(0xac)](_0x524e50(0x107)+_0x440e75[_0x524e50(0x127)](),_0x524e50(0xb9),_0x1f4c9c);if(_0x1f4c9c instanceof Error){console['error']('Error\x20message:',_0x1f4c9c['message']),console[_0x524e50(0xdd)](_0x524e50(0x116),_0x1f4c9c['stack']);throw new Error(_0x524e50(0x104)+_0x440e75+_0x524e50(0x12d)+_0x1f4c9c[_0x524e50(0xc5)]);}throw new Error(_0x524e50(0x104)+_0x440e75+_0x524e50(0x12b));}}async[a67_0x395bb3(0x108)](_0x388607,_0xe4adf5){const _0x5ee6e7=a67_0x395bb3,_0x297028=Date['now']();try{const _0x1eff13={'gatewayPaymentId':_0x388607,'geo':_0xe4adf5};loggerService_1['loggerService'][_0x5ee6e7(0x13c)](_0x5ee6e7(0x107)+_0xe4adf5[_0x5ee6e7(0x127)](),_0x5ee6e7(0xc1)+_0x388607,_0x5ee6e7(0xff),_0x1eff13);const _0x364f27=await fetch(this[_0x5ee6e7(0xab)],{'method':_0x5ee6e7(0xff),'headers':{'Content-Type':_0x5ee6e7(0xbf),'User-Agent':_0x5ee6e7(0x102)},'body':JSON['stringify'](_0x1eff13)}),_0x5a0bc8=Date[_0x5ee6e7(0xb7)]()-_0x297028;if(!_0x364f27['ok']){const _0x1c2451=await _0x364f27[_0x5ee6e7(0xe7)]();loggerService_1['loggerService'][_0x5ee6e7(0xeb)](_0x5ee6e7(0x107)+_0xe4adf5['toLowerCase'](),_0x5ee6e7(0xc1)+_0x388607,_0x364f27[_0x5ee6e7(0x117)],_0x1c2451,_0x5a0bc8);throw new Error(_0x5ee6e7(0xf6)+_0x364f27['status']);}const _0x1c7a7a=await _0x364f27[_0x5ee6e7(0x130)]();loggerService_1[_0x5ee6e7(0xec)][_0x5ee6e7(0xeb)](_0x5ee6e7(0x107)+_0xe4adf5[_0x5ee6e7(0x127)](),_0x5ee6e7(0xc1)+_0x388607,_0x364f27[_0x5ee6e7(0x117)],_0x1c7a7a,_0x5a0bc8);if(_0x1c7a7a[_0x5ee6e7(0xdd)]||_0x1c7a7a['statusCode']){loggerService_1[_0x5ee6e7(0xec)][_0x5ee6e7(0xac)](_0x5ee6e7(0x107)+_0xe4adf5[_0x5ee6e7(0x127)](),'/verify/'+_0x388607,_0x5ee6e7(0x11b)+_0xe4adf5+_0x5ee6e7(0x10c)+(_0x1c7a7a[_0x5ee6e7(0xc5)]||_0x1c7a7a[_0x5ee6e7(0xdd)]||_0x5ee6e7(0x109)));throw new Error(_0x5ee6e7(0x11b)+_0xe4adf5+_0x5ee6e7(0x10c)+(_0x1c7a7a['message']||_0x1c7a7a[_0x5ee6e7(0xdd)]||'Unknown\x20error'));}let _0x2d7b41=_0x5ee6e7(0x10d);return{'status':_0x2d7b41};}catch(_0x2e343b){console[_0x5ee6e7(0xdd)](_0x5ee6e7(0x11b)+_0xe4adf5+_0x5ee6e7(0xf3),_0x2e343b),loggerService_1[_0x5ee6e7(0xec)][_0x5ee6e7(0xac)](_0x5ee6e7(0x107)+_0xe4adf5[_0x5ee6e7(0x127)](),_0x5ee6e7(0xc1)+_0x388607,_0x2e343b);throw new Error('Failed\x20to\x20verify\x20KLYME\x20'+_0xe4adf5+'\x20payment:\x20'+(_0x2e343b instanceof Error?_0x2e343b[_0x5ee6e7(0xc5)]:'Unknown\x20error'));}}async[a67_0x395bb3(0xdb)](_0x512ee3){const _0xc19253=a67_0x395bb3;console['log'](_0xc19253(0x119),_0x512ee3);let _0x203a4a='PENDING';switch(_0x512ee3[_0xc19253(0x117)]?.[_0xc19253(0x127)]()){case'paid':case _0xc19253(0xb0):case _0xc19253(0xbd):case _0xc19253(0xc7):case'successful':_0x203a4a=_0xc19253(0x110);break;case _0xc19253(0x122):case _0xc19253(0xea):case _0xc19253(0xbc):case'error':case'rejected':_0x203a4a=_0xc19253(0x111);break;case'expired':case _0xc19253(0xef):_0x203a4a=_0xc19253(0x10b);break;case _0xc19253(0xad):case _0xc19253(0x121):case'active':case _0xc19253(0xfd):case _0xc19253(0xc8):default:_0x203a4a=_0xc19253(0x10d);break;}return{'paymentId':_0x512ee3[_0xc19253(0xc3)]||_0x512ee3['order_id']||_0x512ee3[_0xc19253(0xca)],'status':_0x203a4a,'amount':_0x512ee3[_0xc19253(0x139)],'currency':_0x512ee3[_0xc19253(0x120)],'region':_0x512ee3[_0xc19253(0xd2)],'additionalInfo':{'payment_method':_0x512ee3[_0xc19253(0x126)],'transaction_id':_0x512ee3['transaction_id']}};}}exports[a67_0x395bb3(0xd4)]=KlymeService;