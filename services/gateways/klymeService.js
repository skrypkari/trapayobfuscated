'use strict';function a61_0x2ccd(){const _0x15c0d3=['completed','Reference\x20Used\x20as\x20ID:','HTTP\x20','toLowerCase','findFirst','Payment\x20System/1.0','expired','Region\x20(geo):','stringify','Error\x20message:','getOwnPropertyDescriptor','generateUniqueReference','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','created','Error\x20details:','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','verifyPayment','payment','\x20validated)','4947810jjhcmg','__setModuleDefault','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','parse','logWhiteDomainError','Processing\x20KLYME\x20webhook:','successful','\x20payment\x20link:\x20Unknown\x20error','\x20payment\x20link:\x20','get','\x20RESPONSE\x20===','\x20API\x20error:\x20','https://tesoft.uk/gateway/klyme/','UUID:','Response\x20Body:','redirect_url','padStart','POST','Response\x20data:','Parsed\x20Result:','\x20currency\x20validation\x20passed:\x20','rejected','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','Status\x20Code:',',\x20body:\x20','Invalid\x20response\x20from\x20KLYME\x20','message','Business\x20Error:\x20','timeout','KLYME\x20','3827619RRiwil','failed','createPaymentLink','writable','Failed\x20to\x20verify\x20KLYME\x20','log','error','processWebhook','56hEbdMA','canceled','(8digits-8digits\x20format)','prototype','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','1567237JJVtsX','then','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','json','/create','paid','EUR','resolve','Unknown\x20error','Reference:','üí≥\x20KLYME\x20','‚ö†Ô∏è\x20KLYME\x20reference\x20','default','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','/verify/','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','Raw\x20Response\x20Body:','transaction_id','Response\x20Time:','Currency:','processing','Currency\x20Used:','../loggerService','Status\x20Text:','===\x20KLYME\x20','KlymeService','logWhiteDomainRequest','text','confirmed','logWhiteDomainResponse','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','\x20API:\x20','__createBinding','getOwnPropertyNames','\x20SUCCESS\x20(New\x20Format)\x20===','PAID','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','(validated\x20for\x20','Error\x20stack:','authUrl','3631579yVsMXN','klyme_','reference','HTTP\x20error!\x20status:\x20','amount','statusCode','toString','now','Status:','364916zdybnr','7190288VRqKET','Failed\x20to\x20create\x20KLYME\x20','loggerService','status','currency','11723814XxuLzV','length','success','HTTP\x20Status:','\x20API:\x20missing\x20payment\x20data','random','fromEntries','apiUrl','\x20SUCCESS\x20(Legacy\x20Format)\x20===','application/json','Redirect\x20URL:','\x20API\x20BUSINESS\x20ERROR\x20===','PENDING','uuid','__esModule','Auth\x20URL:','statusText','https://tesoft.uk/gateway/pending.php?id=','configurable','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','Unknown\x20error\x20from\x20KLYME\x20','EXPIRED','\x20(8digits-8digits\x20format\x20for\x20','create','\x20payment:\x20','floor','toUpperCase'];a61_0x2ccd=function(){return _0x15c0d3;};return a61_0x2ccd();}const a61_0x1b7c97=a61_0x2660;function a61_0x2660(_0x4d7064,_0x220f3e){_0x4d7064=_0x4d7064-0xe8;const _0x2ccdfd=a61_0x2ccd();let _0x26605e=_0x2ccdfd[_0x4d7064];return _0x26605e;}(function(_0x3c4f2d,_0x348e8f){const _0x4c2d15=a61_0x2660,_0x49fae5=_0x3c4f2d();while(!![]){try{const _0xc961b1=parseInt(_0x4c2d15(0x115))/0x1+-parseInt(_0x4c2d15(0x146))/0x2+-parseInt(_0x4c2d15(0x108))/0x3+-parseInt(_0x4c2d15(0x147))/0x4+parseInt(_0x4c2d15(0xea))/0x5+-parseInt(_0x4c2d15(0x14c))/0x6+parseInt(_0x4c2d15(0x13d))/0x7*(parseInt(_0x4c2d15(0x110))/0x8);if(_0xc961b1===_0x348e8f)break;else _0x49fae5['push'](_0x49fae5['shift']());}catch(_0x455afb){_0x49fae5['push'](_0x49fae5['shift']());}}}(a61_0x2ccd,0xeee4a));var __createBinding=this&&this[a61_0x1b7c97(0x135)]||(Object['create']?function(_0x4488d0,_0xbffa5e,_0x1e963d,_0x1acbbf){const _0x528d67=a61_0x1b7c97;if(_0x1acbbf===undefined)_0x1acbbf=_0x1e963d;var _0x329572=Object[_0x528d67(0x171)](_0xbffa5e,_0x1e963d);(!_0x329572||(_0x528d67(0xf3)in _0x329572?!_0xbffa5e[_0x528d67(0x15a)]:_0x329572[_0x528d67(0x10b)]||_0x329572[_0x528d67(0x15e)]))&&(_0x329572={'enumerable':!![],'get':function(){return _0xbffa5e[_0x1e963d];}}),Object['defineProperty'](_0x4488d0,_0x1acbbf,_0x329572);}:function(_0x4be90c,_0x254da2,_0x5c92cc,_0x37c91f){if(_0x37c91f===undefined)_0x37c91f=_0x5c92cc;_0x4be90c[_0x37c91f]=_0x254da2[_0x5c92cc];}),__setModuleDefault=this&&this[a61_0x1b7c97(0xeb)]||(Object[a61_0x1b7c97(0x163)]?function(_0x53420a,_0x4f55b9){Object['defineProperty'](_0x53420a,'default',{'enumerable':!![],'value':_0x4f55b9});}:function(_0x3fc0a1,_0x2f74e4){_0x3fc0a1['default']=_0x2f74e4;}),__importStar=this&&this['__importStar']||(function(){var _0x5519b8=function(_0x4d04ce){const _0x403ec8=a61_0x2660;return _0x5519b8=Object[_0x403ec8(0x136)]||function(_0x26463d){const _0x1cb405=_0x403ec8;var _0x2f7d34=[];for(var _0x18d738 in _0x26463d)if(Object[_0x1cb405(0x113)]['hasOwnProperty']['call'](_0x26463d,_0x18d738))_0x2f7d34[_0x2f7d34[_0x1cb405(0x14d)]]=_0x18d738;return _0x2f7d34;},_0x5519b8(_0x4d04ce);};return function(_0x379c00){const _0x27d72c=a61_0x2660;if(_0x379c00&&_0x379c00[_0x27d72c(0x15a)])return _0x379c00;var _0x17ebe1={};if(_0x379c00!=null){for(var _0x2e3386=_0x5519b8(_0x379c00),_0x1a243c=0x0;_0x1a243c<_0x2e3386[_0x27d72c(0x14d)];_0x1a243c++)if(_0x2e3386[_0x1a243c]!==_0x27d72c(0x121))__createBinding(_0x17ebe1,_0x379c00,_0x2e3386[_0x1a243c]);}return __setModuleDefault(_0x17ebe1,_0x379c00),_0x17ebe1;};}());Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['KlymeService']=void 0x0;const loggerService_1=require(a61_0x1b7c97(0x12b));class KlymeService{constructor(){const _0x3a3fe7=a61_0x1b7c97;this[_0x3a3fe7(0x153)]=_0x3a3fe7(0xf6),console['log'](_0x3a3fe7(0x15f));}['validateCurrencyForRegion'](_0x5c39d3,_0x45f63a){const _0x49c42a=a61_0x1b7c97,_0x10d5cb=_0x5c39d3[_0x49c42a(0x166)]();switch(_0x45f63a){case'EU':if(_0x10d5cb!=='EUR')throw new Error(_0x49c42a(0xec)+_0x10d5cb);break;case'GB':if(_0x10d5cb!=='GBP')throw new Error(_0x49c42a(0x139)+_0x10d5cb);break;case'DE':if(_0x10d5cb!==_0x49c42a(0x11b))throw new Error(_0x49c42a(0x117)+_0x10d5cb);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x45f63a);}}async[a61_0x1b7c97(0x172)](){const _0x730b55=a61_0x1b7c97,_0x3890f6=(await Promise[_0x730b55(0x11c)]()[_0x730b55(0x116)](()=>__importStar(require('../../config/database'))))['default'];let _0x2ade21,_0x13206d=0x0;const _0x3b199c=0xa;do{const _0xe57263=()=>{const _0x50af83=_0x730b55;return Math[_0x50af83(0x165)](Math[_0x50af83(0x151)]()*0x5f5e100)[_0x50af83(0x143)]()[_0x50af83(0xfa)](0x8,'0');};_0x2ade21=_0xe57263()+'-'+_0xe57263();const _0x4b9d95=await _0x3890f6[_0x730b55(0xe8)][_0x730b55(0x16b)]({'where':{'gatewayOrderId':_0x2ade21}});if(!_0x4b9d95)break;_0x13206d++,console[_0x730b55(0x10d)](_0x730b55(0x120)+_0x2ade21+'\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20'+_0x13206d+')');}while(_0x13206d<_0x3b199c);if(_0x13206d>=_0x3b199c)throw new Error(_0x730b55(0x176));return _0x2ade21;}async[a61_0x1b7c97(0x10a)](_0x5818fe){const _0x149048=a61_0x1b7c97,{orderId:_0x1a65e8,amount:_0x58dff8,currency:_0x51186c,region:_0x525522}=_0x5818fe;if(_0x525522!=='EU'&&_0x525522!=='GB'&&_0x525522!=='DE')throw new Error(_0x149048(0x122)+_0x525522);this['validateCurrencyForRegion'](_0x51186c,_0x525522);const _0x380827=_0x51186c[_0x149048(0x166)]();console[_0x149048(0x10d)](_0x149048(0x11f)+_0x525522+_0x149048(0xfe)+_0x380827);const _0x2c8d91=await this[_0x149048(0x172)]();console[_0x149048(0x10d)](_0x149048(0x173)+_0x2c8d91+_0x149048(0x162)+_0x525522+')');const _0x478ba5=_0x149048(0x15d)+_0x1a65e8,_0x5bf6a5={'amount':_0x58dff8,'currency':_0x380827,'redirectUrl':_0x478ba5,'reference':_0x2c8d91,'geo':_0x525522},_0x2ae086=Date[_0x149048(0x144)]();try{console['log'](_0x149048(0x12d)+_0x525522+_0x149048(0x100)),console['log']('URL:',this[_0x149048(0x153)]),console['log']('Request\x20Body:',JSON[_0x149048(0x16f)](_0x5bf6a5,null,0x2)),console[_0x149048(0x10d)](_0x149048(0x16e),_0x525522),console['log'](_0x149048(0x128),_0x380827,_0x149048(0x13a)+_0x525522+')'),console[_0x149048(0x10d)](_0x149048(0x11e),_0x2c8d91,_0x149048(0x112)),console[_0x149048(0x10d)]('Redirect\x20URL:',_0x478ba5),loggerService_1[_0x149048(0x149)][_0x149048(0x12f)](_0x149048(0x13e)+_0x525522[_0x149048(0x16a)](),_0x149048(0x119),'POST',_0x5bf6a5);const _0x227200=await fetch(this[_0x149048(0x153)],{'method':_0x149048(0xfb),'headers':{'Content-Type':'application/json','Accept':_0x149048(0x155),'User-Agent':'Payment\x20System/1.0'},'body':JSON[_0x149048(0x16f)](_0x5bf6a5)}),_0x2134af=Date['now']()-_0x2ae086;console[_0x149048(0x10d)](_0x149048(0x12d)+_0x525522+'\x20API\x20RESPONSE\x20(Unified\x20Route)\x20==='),console[_0x149048(0x10d)](_0x149048(0x145),_0x227200[_0x149048(0x14a)]),console[_0x149048(0x10d)](_0x149048(0x12c),_0x227200[_0x149048(0x15c)]),console[_0x149048(0x10d)]('Headers:',Object[_0x149048(0x152)](_0x227200['headers']['entries']())),console[_0x149048(0x10d)](_0x149048(0x127),_0x2134af+'ms');const _0x470006=await _0x227200[_0x149048(0x130)]();console[_0x149048(0x10d)](_0x149048(0x125),_0x470006);if(!_0x227200['ok']){console[_0x149048(0x10e)](_0x149048(0x12d)+_0x525522+'\x20API\x20ERROR\x20==='),console[_0x149048(0x10e)](_0x149048(0x14f),_0x227200[_0x149048(0x14a)]),console['error'](_0x149048(0xf8),_0x470006),loggerService_1['loggerService']['logWhiteDomainResponse']('klyme_'+_0x525522['toLowerCase'](),_0x149048(0x119),_0x227200[_0x149048(0x14a)],_0x470006,_0x2134af),loggerService_1[_0x149048(0x149)]['logWhiteDomainError'](_0x149048(0x13e)+_0x525522['toLowerCase'](),_0x149048(0x119),_0x149048(0x169)+_0x227200[_0x149048(0x14a)]+':\x20'+_0x470006);throw new Error(_0x149048(0x140)+_0x227200[_0x149048(0x14a)]+_0x149048(0x102)+_0x470006);}let _0x435ff5;try{_0x435ff5=JSON[_0x149048(0xed)](_0x470006);}catch(_0x264d08){console[_0x149048(0x10e)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x264d08),loggerService_1[_0x149048(0x149)]['logWhiteDomainError']('klyme_'+_0x525522[_0x149048(0x16a)](),_0x149048(0x119),'JSON\x20Parse\x20Error:\x20'+_0x264d08);throw new Error(_0x149048(0x114)+_0x525522+_0x149048(0x134)+_0x470006);}console['log']('===\x20PARSED\x20KLYME\x20'+_0x525522+_0x149048(0xf4)),console[_0x149048(0x10d)](_0x149048(0xfd),JSON[_0x149048(0x16f)](_0x435ff5,null,0x2)),loggerService_1[_0x149048(0x149)][_0x149048(0x132)](_0x149048(0x13e)+_0x525522[_0x149048(0x16a)](),_0x149048(0x119),_0x227200[_0x149048(0x14a)],_0x435ff5,_0x2134af);if(_0x435ff5[_0x149048(0x10e)]||_0x435ff5[_0x149048(0x142)]){const _0x561ad2=_0x435ff5[_0x149048(0x104)]||_0x435ff5[_0x149048(0x10e)]||_0x149048(0x160)+_0x525522+'\x20API';console[_0x149048(0x10e)](_0x149048(0x12d)+_0x525522+_0x149048(0x157)),console[_0x149048(0x10e)]('Error\x20Message:',_0x561ad2),console[_0x149048(0x10e)](_0x149048(0x101),_0x435ff5['statusCode']),loggerService_1[_0x149048(0x149)][_0x149048(0xee)]('klyme_'+_0x525522[_0x149048(0x16a)](),_0x149048(0x119),_0x149048(0x105)+_0x561ad2);throw new Error(_0x149048(0x107)+_0x525522+_0x149048(0xf5)+_0x561ad2);}let _0x4b6f16,_0x485419;if(_0x435ff5[_0x149048(0x159)]&&_0x435ff5[_0x149048(0xf9)])_0x4b6f16=_0x435ff5[_0x149048(0x159)],_0x485419=_0x435ff5['redirect_url'],console['log'](_0x149048(0x12d)+_0x525522+_0x149048(0x137)),console[_0x149048(0x10d)](_0x149048(0xf7),_0x435ff5[_0x149048(0x159)]),console[_0x149048(0x10d)](_0x149048(0x156),_0x435ff5[_0x149048(0xf9)]);else{if(_0x435ff5[_0x149048(0x13c)])_0x4b6f16=_0x2c8d91,_0x485419=_0x435ff5[_0x149048(0x13c)],console[_0x149048(0x10d)](_0x149048(0x12d)+_0x525522+_0x149048(0x154)),console['log'](_0x149048(0x15b),_0x435ff5[_0x149048(0x13c)]),console[_0x149048(0x10d)](_0x149048(0x168),_0x2c8d91);else{console[_0x149048(0x10e)]('===\x20KLYME\x20'+_0x525522+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x149048(0x10e)](_0x149048(0x124)),console[_0x149048(0x10e)](_0x149048(0xfc),_0x435ff5),loggerService_1[_0x149048(0x149)]['logWhiteDomainError'](_0x149048(0x13e)+_0x525522[_0x149048(0x16a)](),_0x149048(0x119),_0x149048(0x133));throw new Error(_0x149048(0x103)+_0x525522+_0x149048(0x150));}}return console['log'](_0x149048(0x12a),_0x380827,'('+_0x525522+_0x149048(0xe9)),console[_0x149048(0x10d)]('Reference\x20Used:',_0x2c8d91,_0x149048(0x112)),console[_0x149048(0x10d)]('Geo\x20Parameter:',_0x525522),{'gateway_payment_id':_0x4b6f16,'payment_url':_0x485419};}catch(_0x4c1741){console['error'](_0x149048(0x12d)+_0x525522+'\x20SERVICE\x20ERROR\x20==='),console[_0x149048(0x10e)](_0x149048(0x175),_0x4c1741),loggerService_1['loggerService'][_0x149048(0xee)](_0x149048(0x13e)+_0x525522['toLowerCase'](),_0x149048(0x119),_0x4c1741);if(_0x4c1741 instanceof Error){console['error'](_0x149048(0x170),_0x4c1741['message']),console[_0x149048(0x10e)](_0x149048(0x13b),_0x4c1741['stack']);throw new Error(_0x149048(0x148)+_0x525522+_0x149048(0xf2)+_0x4c1741[_0x149048(0x104)]);}throw new Error(_0x149048(0x148)+_0x525522+_0x149048(0xf1));}}async[a61_0x1b7c97(0x177)](_0x1b2cbe,_0x2e6f86){const _0x170054=a61_0x1b7c97,_0xb41756=Date[_0x170054(0x144)]();try{const _0x1fcb53={'gatewayPaymentId':_0x1b2cbe,'geo':_0x2e6f86};loggerService_1[_0x170054(0x149)]['logWhiteDomainRequest'](_0x170054(0x13e)+_0x2e6f86[_0x170054(0x16a)](),_0x170054(0x123)+_0x1b2cbe,_0x170054(0xfb),_0x1fcb53);const _0x4017cc=await fetch(this[_0x170054(0x153)],{'method':_0x170054(0xfb),'headers':{'Content-Type':_0x170054(0x155),'User-Agent':_0x170054(0x16c)},'body':JSON[_0x170054(0x16f)](_0x1fcb53)}),_0x99a0b9=Date[_0x170054(0x144)]()-_0xb41756;if(!_0x4017cc['ok']){const _0x21bbfb=await _0x4017cc[_0x170054(0x130)]();loggerService_1[_0x170054(0x149)]['logWhiteDomainResponse'](_0x170054(0x13e)+_0x2e6f86[_0x170054(0x16a)](),_0x170054(0x123)+_0x1b2cbe,_0x4017cc[_0x170054(0x14a)],_0x21bbfb,_0x99a0b9);throw new Error('HTTP\x20error!\x20status:\x20'+_0x4017cc['status']);}const _0x1ef537=await _0x4017cc[_0x170054(0x118)]();loggerService_1[_0x170054(0x149)]['logWhiteDomainResponse'](_0x170054(0x13e)+_0x2e6f86[_0x170054(0x16a)](),'/verify/'+_0x1b2cbe,_0x4017cc[_0x170054(0x14a)],_0x1ef537,_0x99a0b9);if(_0x1ef537[_0x170054(0x10e)]||_0x1ef537[_0x170054(0x142)]){loggerService_1[_0x170054(0x149)]['logWhiteDomainError'](_0x170054(0x13e)+_0x2e6f86[_0x170054(0x16a)](),_0x170054(0x123)+_0x1b2cbe,_0x170054(0x107)+_0x2e6f86+_0x170054(0xf5)+(_0x1ef537[_0x170054(0x104)]||_0x1ef537['error']||'Unknown\x20error'));throw new Error(_0x170054(0x107)+_0x2e6f86+_0x170054(0xf5)+(_0x1ef537[_0x170054(0x104)]||_0x1ef537[_0x170054(0x10e)]||_0x170054(0x11d)));}let _0x20ffaf=_0x170054(0x158);return{'status':_0x20ffaf};}catch(_0x248b17){console['error']('KLYME\x20'+_0x2e6f86+'\x20payment\x20verification\x20error:',_0x248b17),loggerService_1[_0x170054(0x149)][_0x170054(0xee)](_0x170054(0x13e)+_0x2e6f86[_0x170054(0x16a)](),'/verify/'+_0x1b2cbe,_0x248b17);throw new Error(_0x170054(0x10c)+_0x2e6f86+_0x170054(0x164)+(_0x248b17 instanceof Error?_0x248b17[_0x170054(0x104)]:_0x170054(0x11d)));}}async[a61_0x1b7c97(0x10f)](_0x3aa842){const _0x1a98e5=a61_0x1b7c97;console['log'](_0x1a98e5(0xef),_0x3aa842);let _0x456f04=_0x1a98e5(0x158);switch(_0x3aa842[_0x1a98e5(0x14a)]?.['toLowerCase']()){case _0x1a98e5(0x11a):case _0x1a98e5(0x167):case _0x1a98e5(0x131):case _0x1a98e5(0x14e):case _0x1a98e5(0xf0):_0x456f04=_0x1a98e5(0x138);break;case'cancelled':case _0x1a98e5(0x111):case _0x1a98e5(0x109):case _0x1a98e5(0x10e):case _0x1a98e5(0xff):_0x456f04='FAILED';break;case _0x1a98e5(0x16d):case _0x1a98e5(0x106):_0x456f04=_0x1a98e5(0x161);break;case'pending':case _0x1a98e5(0x174):case'active':case _0x1a98e5(0x129):case'in_progress':default:_0x456f04='PENDING';break;}return{'paymentId':_0x3aa842[_0x1a98e5(0x13f)]||_0x3aa842['order_id']||_0x3aa842['payment_id'],'status':_0x456f04,'amount':_0x3aa842[_0x1a98e5(0x141)],'currency':_0x3aa842[_0x1a98e5(0x14b)],'region':_0x3aa842['region'],'additionalInfo':{'payment_method':_0x3aa842['payment_method'],'transaction_id':_0x3aa842[_0x1a98e5(0x126)]}};}}exports[a61_0x1b7c97(0x12e)]=KlymeService;