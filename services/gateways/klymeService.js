'use strict';const a41_0x314da3=a41_0x53ae;function a41_0x53ae(_0x449271,_0x17e778){const _0x4dd077=a41_0x4dd0();return a41_0x53ae=function(_0x53ae74,_0x42cc9f){_0x53ae74=_0x53ae74-0x136;let _0x1b161b=_0x4dd077[_0x53ae74];return _0x1b161b;},a41_0x53ae(_0x449271,_0x17e778);}function a41_0x4dd0(){const _0x772f84=['JSON\x20Parse\x20Error:\x20','\x20payment\x20verification\x20error:','\x20API:\x20missing\x20payment\x20data','\x20RESPONSE\x20===','get','defineProperty','region','paid','text','status','Business\x20Error:\x20','Headers:','\x20SERVICE\x20ERROR\x20===','create','getOwnPropertyNames','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','log','/verify/','Response\x20data:','/create','HTTP\x20','now','call','Unknown\x20error\x20from\x20KLYME\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','reference','309605AcDdNA','===\x20PARSED\x20KLYME\x20','\x20(8digits-8digits\x20format\x20for\x20','error','getOwnPropertyDescriptor','https://tesoft.uk/gateway/pending.php?id=','stack','\x20SUCCESS\x20(New\x20Format)\x20===','payment','apiUrl','794060BaaWrY','===\x20KLYME\x20','currency','PENDING','generateUniqueReference','loggerService','1153528oOdumb','‚ö†Ô∏è\x20KLYME\x20reference\x20','7YdkVsC','Error\x20Message:','Currency\x20Used:','stringify','processing','successful','payment_method','(validated\x20for\x20','success','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20',',\x20body:\x20','klyme_','completed','logWhiteDomainRequest','cancelled','446922tRykxP','random','\x20API:\x20','\x20API\x20BUSINESS\x20ERROR\x20===','POST','parse','logWhiteDomainError','788118mEYSOQ','logWhiteDomainResponse','KlymeService','application/json','UUID:','authUrl','KLYME\x20','statusCode','Status\x20Text:','Failed\x20to\x20parse\x20JSON\x20response:','Response\x20Body:','4gEATxt','218433NskiVV','(8digits-8digits\x20format)','\x20SUCCESS\x20(Legacy\x20Format)\x20===','transaction_id','default','Unknown\x20error','72EYMicS','verifyPayment','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','Auth\x20URL:','uuid','../../config/database','\x20API\x20ERROR\x20===','\x20API\x20error:\x20','length','payment_id','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','\x20payment\x20link:\x20Unknown\x20error','1640592UAIbRc','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','Reference:','__esModule','HTTP\x20error!\x20status:\x20','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','toLowerCase','URL:','Reference\x20Used:','Error\x20stack:','configurable','pending','EUR','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','Processing\x20KLYME\x20webhook:','padStart','Geo\x20Parameter:','Invalid\x20response\x20from\x20KLYME\x20','PAID','entries','active','toUpperCase','GBP','\x20currency\x20validation\x20passed:\x20','headers','writable','fromEntries','Error\x20message:','../loggerService','findFirst','\x20validated)','TesSoft\x20Payment\x20System/1.0','redirect_url','https://tesoft.uk/gateway/klyme/','Status:','HTTP\x20Status:','Failed\x20to\x20create\x20KLYME\x20','validateCurrencyForRegion','Status\x20Code:','__createBinding','Response\x20Time:','json','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','message','Redirect\x20URL:'];a41_0x4dd0=function(){return _0x772f84;};return a41_0x4dd0();}(function(_0x124ccd,_0x47d29c){const _0xf8e97c=a41_0x53ae,_0x36c2e3=_0x124ccd();while(!![]){try{const _0x5dd807=parseInt(_0xf8e97c(0x1b9))/0x1+-parseInt(_0xf8e97c(0x1b8))/0x2*(parseInt(_0xf8e97c(0x1a6))/0x3)+-parseInt(_0xf8e97c(0x195))/0x4+-parseInt(_0xf8e97c(0x185))/0x5+-parseInt(_0xf8e97c(0x1ad))/0x6*(parseInt(_0xf8e97c(0x197))/0x7)+parseInt(_0xf8e97c(0x13e))/0x8+-parseInt(_0xf8e97c(0x1bf))/0x9*(-parseInt(_0xf8e97c(0x18f))/0xa);if(_0x5dd807===_0x47d29c)break;else _0x36c2e3['push'](_0x36c2e3['shift']());}catch(_0x286bf6){_0x36c2e3['push'](_0x36c2e3['shift']());}}}(a41_0x4dd0,0x4426f));var __createBinding=this&&this[a41_0x314da3(0x165)]||(Object[a41_0x314da3(0x178)]?function(_0x1bba9b,_0x54257e,_0x1aac11,_0x7876){const _0x577066=a41_0x314da3;if(_0x7876===undefined)_0x7876=_0x1aac11;var _0x3455fd=Object[_0x577066(0x189)](_0x54257e,_0x1aac11);(!_0x3455fd||(_0x577066(0x16f)in _0x3455fd?!_0x54257e[_0x577066(0x141)]:_0x3455fd[_0x577066(0x157)]||_0x3455fd[_0x577066(0x148)]))&&(_0x3455fd={'enumerable':!![],'get':function(){return _0x54257e[_0x1aac11];}}),Object['defineProperty'](_0x1bba9b,_0x7876,_0x3455fd);}:function(_0x402f53,_0x2821c1,_0x371654,_0x4859d5){if(_0x4859d5===undefined)_0x4859d5=_0x371654;_0x402f53[_0x4859d5]=_0x2821c1[_0x371654];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x35cf34,_0x2f8873){const _0x415aae=a41_0x314da3;Object[_0x415aae(0x170)](_0x35cf34,'default',{'enumerable':!![],'value':_0x2f8873});}:function(_0x20f7a0,_0x173a94){_0x20f7a0['default']=_0x173a94;}),__importStar=this&&this['__importStar']||(function(){var _0x269453=function(_0x780e51){const _0x4f802b=a41_0x53ae;return _0x269453=Object[_0x4f802b(0x179)]||function(_0x505cbd){const _0x21777f=_0x4f802b;var _0x4d40b8=[];for(var _0x262558 in _0x505cbd)if(Object['prototype']['hasOwnProperty'][_0x21777f(0x181)](_0x505cbd,_0x262558))_0x4d40b8[_0x4d40b8[_0x21777f(0x13a)]]=_0x262558;return _0x4d40b8;},_0x269453(_0x780e51);};return function(_0x18ef8b){if(_0x18ef8b&&_0x18ef8b['__esModule'])return _0x18ef8b;var _0x2791ba={};if(_0x18ef8b!=null){for(var _0x183534=_0x269453(_0x18ef8b),_0x786ca6=0x0;_0x786ca6<_0x183534['length'];_0x786ca6++)if(_0x183534[_0x786ca6]!=='default')__createBinding(_0x2791ba,_0x18ef8b,_0x183534[_0x786ca6]);}return __setModuleDefault(_0x2791ba,_0x18ef8b),_0x2791ba;};}());Object[a41_0x314da3(0x170)](exports,a41_0x314da3(0x141),{'value':!![]}),exports[a41_0x314da3(0x1af)]=void 0x0;const loggerService_1=require(a41_0x314da3(0x15a));class KlymeService{constructor(){const _0x507ba4=a41_0x314da3;this['apiUrl']=_0x507ba4(0x15f),console[_0x507ba4(0x17b)](_0x507ba4(0x17a));}[a41_0x314da3(0x163)](_0x363be9,_0xe94d5b){const _0x3e83c4=a41_0x314da3,_0x238150=_0x363be9[_0x3e83c4(0x153)]();switch(_0xe94d5b){case'EU':if(_0x238150!==_0x3e83c4(0x14a))throw new Error(_0x3e83c4(0x183)+_0x238150);break;case'GB':if(_0x238150!==_0x3e83c4(0x154))throw new Error(_0x3e83c4(0x13f)+_0x238150);break;case'DE':if(_0x238150!==_0x3e83c4(0x14a))throw new Error(_0x3e83c4(0x1a0)+_0x238150);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0xe94d5b);}}async[a41_0x314da3(0x193)](){const _0x47554f=a41_0x314da3,_0x3fcf1b=(await Promise['resolve']()['then'](()=>__importStar(require(_0x47554f(0x137)))))[_0x47554f(0x1bd)];let _0x2e7751,_0x15ee3e=0x0;const _0x57bd06=0xa;do{const _0x72d6e6=()=>{const _0x57d368=_0x47554f;return Math['floor'](Math[_0x57d368(0x1a7)]()*0x5f5e100)['toString']()[_0x57d368(0x14d)](0x8,'0');};_0x2e7751=_0x72d6e6()+'-'+_0x72d6e6();const _0x231b7a=await _0x3fcf1b[_0x47554f(0x18d)][_0x47554f(0x15b)]({'where':{'gatewayOrderId':_0x2e7751}});if(!_0x231b7a)break;_0x15ee3e++,console[_0x47554f(0x17b)](_0x47554f(0x196)+_0x2e7751+_0x47554f(0x168)+_0x15ee3e+')');}while(_0x15ee3e<_0x57bd06);if(_0x15ee3e>=_0x57bd06)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x2e7751;}async['createPaymentLink'](_0xc12b92){const _0x28517a=a41_0x314da3,{orderId:_0x3d60b7,amount:_0xa01399,currency:_0x3cb7bb,region:_0x233297}=_0xc12b92;if(_0x233297!=='EU'&&_0x233297!=='GB'&&_0x233297!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x233297);this[_0x28517a(0x163)](_0x3cb7bb,_0x233297);const _0x154e28=_0x3cb7bb[_0x28517a(0x153)]();console[_0x28517a(0x17b)]('üí≥\x20KLYME\x20'+_0x233297+_0x28517a(0x155)+_0x154e28);const _0x4b1939=await this['generateUniqueReference']();console[_0x28517a(0x17b)]('üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20'+_0x4b1939+_0x28517a(0x187)+_0x233297+')');const _0x10d09a=_0x28517a(0x18a)+_0x3d60b7,_0x58aecc={'amount':_0xa01399,'currency':_0x154e28,'redirectUrl':_0x10d09a,'reference':_0x4b1939,'geo':_0x233297},_0x51a08a=Date[_0x28517a(0x180)]();try{console['log'](_0x28517a(0x190)+_0x233297+_0x28517a(0x14b)),console[_0x28517a(0x17b)](_0x28517a(0x145),this[_0x28517a(0x18e)]),console['log']('Request\x20Body:',JSON['stringify'](_0x58aecc,null,0x2)),console[_0x28517a(0x17b)]('Region\x20(geo):',_0x233297),console[_0x28517a(0x17b)]('Currency:',_0x154e28,_0x28517a(0x19e)+_0x233297+')'),console[_0x28517a(0x17b)](_0x28517a(0x140),_0x4b1939,_0x28517a(0x1ba)),console['log'](_0x28517a(0x16a),_0x10d09a),loggerService_1[_0x28517a(0x194)][_0x28517a(0x1a4)](_0x28517a(0x1a2)+_0x233297[_0x28517a(0x144)](),_0x28517a(0x17e),_0x28517a(0x1aa),_0x58aecc);const _0x40c4d1=await fetch(this['apiUrl'],{'method':'POST','headers':{'Content-Type':_0x28517a(0x1b0),'Accept':_0x28517a(0x1b0),'User-Agent':_0x28517a(0x15d)},'body':JSON[_0x28517a(0x19a)](_0x58aecc)}),_0x12353e=Date[_0x28517a(0x180)]()-_0x51a08a;console[_0x28517a(0x17b)]('===\x20KLYME\x20'+_0x233297+_0x28517a(0x143)),console['log'](_0x28517a(0x160),_0x40c4d1['status']),console[_0x28517a(0x17b)](_0x28517a(0x1b5),_0x40c4d1['statusText']),console[_0x28517a(0x17b)](_0x28517a(0x176),Object[_0x28517a(0x158)](_0x40c4d1[_0x28517a(0x156)][_0x28517a(0x151)]())),console[_0x28517a(0x17b)](_0x28517a(0x166),_0x12353e+'ms');const _0x5e5090=await _0x40c4d1[_0x28517a(0x173)]();console[_0x28517a(0x17b)]('Raw\x20Response\x20Body:',_0x5e5090);if(!_0x40c4d1['ok']){console[_0x28517a(0x188)](_0x28517a(0x190)+_0x233297+_0x28517a(0x138)),console[_0x28517a(0x188)](_0x28517a(0x161),_0x40c4d1[_0x28517a(0x174)]),console[_0x28517a(0x188)](_0x28517a(0x1b7),_0x5e5090),loggerService_1['loggerService'][_0x28517a(0x1ae)]('klyme_'+_0x233297[_0x28517a(0x144)](),_0x28517a(0x17e),_0x40c4d1[_0x28517a(0x174)],_0x5e5090,_0x12353e),loggerService_1['loggerService'][_0x28517a(0x1ac)](_0x28517a(0x1a2)+_0x233297[_0x28517a(0x144)](),_0x28517a(0x17e),_0x28517a(0x17f)+_0x40c4d1['status']+':\x20'+_0x5e5090);throw new Error(_0x28517a(0x142)+_0x40c4d1[_0x28517a(0x174)]+_0x28517a(0x1a1)+_0x5e5090);}let _0x11ebb2;try{_0x11ebb2=JSON[_0x28517a(0x1ab)](_0x5e5090);}catch(_0x89d250){console[_0x28517a(0x188)](_0x28517a(0x1b6),_0x89d250),loggerService_1[_0x28517a(0x194)][_0x28517a(0x1ac)](_0x28517a(0x1a2)+_0x233297[_0x28517a(0x144)](),'/create',_0x28517a(0x16b)+_0x89d250);throw new Error('Invalid\x20JSON\x20response\x20from\x20KLYME\x20'+_0x233297+_0x28517a(0x1a8)+_0x5e5090);}console['log'](_0x28517a(0x186)+_0x233297+_0x28517a(0x16e)),console[_0x28517a(0x17b)]('Parsed\x20Result:',JSON['stringify'](_0x11ebb2,null,0x2)),loggerService_1[_0x28517a(0x194)][_0x28517a(0x1ae)](_0x28517a(0x1a2)+_0x233297[_0x28517a(0x144)](),'/create',_0x40c4d1['status'],_0x11ebb2,_0x12353e);if(_0x11ebb2[_0x28517a(0x188)]||_0x11ebb2[_0x28517a(0x1b4)]){const _0xe5930f=_0x11ebb2[_0x28517a(0x169)]||_0x11ebb2[_0x28517a(0x188)]||_0x28517a(0x182)+_0x233297+'\x20API';console[_0x28517a(0x188)](_0x28517a(0x190)+_0x233297+_0x28517a(0x1a9)),console[_0x28517a(0x188)](_0x28517a(0x198),_0xe5930f),console['error'](_0x28517a(0x164),_0x11ebb2[_0x28517a(0x1b4)]),loggerService_1[_0x28517a(0x194)]['logWhiteDomainError'](_0x28517a(0x1a2)+_0x233297[_0x28517a(0x144)](),_0x28517a(0x17e),_0x28517a(0x175)+_0xe5930f);throw new Error(_0x28517a(0x1b3)+_0x233297+'\x20API\x20error:\x20'+_0xe5930f);}let _0x2de6b0,_0x14e96a;if(_0x11ebb2[_0x28517a(0x136)]&&_0x11ebb2[_0x28517a(0x15e)])_0x2de6b0=_0x11ebb2['uuid'],_0x14e96a=_0x11ebb2['redirect_url'],console['log'](_0x28517a(0x190)+_0x233297+_0x28517a(0x18c)),console['log'](_0x28517a(0x1b1),_0x11ebb2['uuid']),console[_0x28517a(0x17b)]('Redirect\x20URL:',_0x11ebb2[_0x28517a(0x15e)]);else{if(_0x11ebb2['authUrl'])_0x2de6b0=_0x4b1939,_0x14e96a=_0x11ebb2[_0x28517a(0x1b2)],console['log'](_0x28517a(0x190)+_0x233297+_0x28517a(0x1bb)),console[_0x28517a(0x17b)](_0x28517a(0x1c2),_0x11ebb2[_0x28517a(0x1b2)]),console['log']('Reference\x20Used\x20as\x20ID:',_0x4b1939);else{console[_0x28517a(0x188)](_0x28517a(0x190)+_0x233297+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x28517a(0x188)](_0x28517a(0x13c)),console['error'](_0x28517a(0x17d),_0x11ebb2),loggerService_1[_0x28517a(0x194)]['logWhiteDomainError'](_0x28517a(0x1a2)+_0x233297[_0x28517a(0x144)](),'/create',_0x28517a(0x1c1));throw new Error(_0x28517a(0x14f)+_0x233297+_0x28517a(0x16d));}}return console['log'](_0x28517a(0x199),_0x154e28,'('+_0x233297+_0x28517a(0x15c)),console[_0x28517a(0x17b)](_0x28517a(0x146),_0x4b1939,_0x28517a(0x1ba)),console[_0x28517a(0x17b)](_0x28517a(0x14e),_0x233297),{'gateway_payment_id':_0x2de6b0,'payment_url':_0x14e96a};}catch(_0x589a57){console[_0x28517a(0x188)](_0x28517a(0x190)+_0x233297+_0x28517a(0x177)),console[_0x28517a(0x188)]('Error\x20details:',_0x589a57),loggerService_1[_0x28517a(0x194)]['logWhiteDomainError'](_0x28517a(0x1a2)+_0x233297['toLowerCase'](),_0x28517a(0x17e),_0x589a57);if(_0x589a57 instanceof Error){console['error'](_0x28517a(0x159),_0x589a57['message']),console[_0x28517a(0x188)](_0x28517a(0x147),_0x589a57[_0x28517a(0x18b)]);throw new Error(_0x28517a(0x162)+_0x233297+'\x20payment\x20link:\x20'+_0x589a57[_0x28517a(0x169)]);}throw new Error(_0x28517a(0x162)+_0x233297+_0x28517a(0x13d));}}async[a41_0x314da3(0x1c0)](_0x1adcb9,_0x4da31a){const _0x476cd1=a41_0x314da3,_0x5bb856=Date['now']();try{const _0x20c8dc={'gatewayPaymentId':_0x1adcb9,'geo':_0x4da31a};loggerService_1['loggerService'][_0x476cd1(0x1a4)](_0x476cd1(0x1a2)+_0x4da31a[_0x476cd1(0x144)](),_0x476cd1(0x17c)+_0x1adcb9,'POST',_0x20c8dc);const _0x15cc4f=await fetch(this['apiUrl'],{'method':_0x476cd1(0x1aa),'headers':{'Content-Type':_0x476cd1(0x1b0),'User-Agent':_0x476cd1(0x15d)},'body':JSON['stringify'](_0x20c8dc)}),_0x9b1ace=Date[_0x476cd1(0x180)]()-_0x5bb856;if(!_0x15cc4f['ok']){const _0x5e5eae=await _0x15cc4f[_0x476cd1(0x173)]();loggerService_1[_0x476cd1(0x194)][_0x476cd1(0x1ae)]('klyme_'+_0x4da31a[_0x476cd1(0x144)](),_0x476cd1(0x17c)+_0x1adcb9,_0x15cc4f['status'],_0x5e5eae,_0x9b1ace);throw new Error('HTTP\x20error!\x20status:\x20'+_0x15cc4f[_0x476cd1(0x174)]);}const _0x487052=await _0x15cc4f[_0x476cd1(0x167)]();loggerService_1[_0x476cd1(0x194)]['logWhiteDomainResponse'](_0x476cd1(0x1a2)+_0x4da31a[_0x476cd1(0x144)](),_0x476cd1(0x17c)+_0x1adcb9,_0x15cc4f[_0x476cd1(0x174)],_0x487052,_0x9b1ace);if(_0x487052[_0x476cd1(0x188)]||_0x487052[_0x476cd1(0x1b4)]){loggerService_1['loggerService']['logWhiteDomainError'](_0x476cd1(0x1a2)+_0x4da31a['toLowerCase'](),_0x476cd1(0x17c)+_0x1adcb9,_0x476cd1(0x1b3)+_0x4da31a+'\x20API\x20error:\x20'+(_0x487052[_0x476cd1(0x169)]||_0x487052[_0x476cd1(0x188)]||_0x476cd1(0x1be)));throw new Error(_0x476cd1(0x1b3)+_0x4da31a+_0x476cd1(0x139)+(_0x487052[_0x476cd1(0x169)]||_0x487052['error']||_0x476cd1(0x1be)));}let _0x4b7bcd=_0x476cd1(0x192);return{'status':_0x4b7bcd};}catch(_0x25a89d){console[_0x476cd1(0x188)]('KLYME\x20'+_0x4da31a+_0x476cd1(0x16c),_0x25a89d),loggerService_1[_0x476cd1(0x194)][_0x476cd1(0x1ac)](_0x476cd1(0x1a2)+_0x4da31a[_0x476cd1(0x144)](),_0x476cd1(0x17c)+_0x1adcb9,_0x25a89d);throw new Error('Failed\x20to\x20verify\x20KLYME\x20'+_0x4da31a+'\x20payment:\x20'+(_0x25a89d instanceof Error?_0x25a89d[_0x476cd1(0x169)]:_0x476cd1(0x1be)));}}async['processWebhook'](_0x12aa53){const _0x383a8=a41_0x314da3;console[_0x383a8(0x17b)](_0x383a8(0x14c),_0x12aa53);let _0x3d24ad=_0x383a8(0x192);switch(_0x12aa53[_0x383a8(0x174)]?.[_0x383a8(0x144)]()){case _0x383a8(0x172):case _0x383a8(0x1a3):case'confirmed':case _0x383a8(0x19f):case _0x383a8(0x19c):_0x3d24ad=_0x383a8(0x150);break;case _0x383a8(0x1a5):case'canceled':case'failed':case _0x383a8(0x188):case'rejected':_0x3d24ad='FAILED';break;case'expired':case'timeout':_0x3d24ad='EXPIRED';break;case _0x383a8(0x149):case'created':case _0x383a8(0x152):case _0x383a8(0x19b):case'in_progress':default:_0x3d24ad=_0x383a8(0x192);break;}return{'paymentId':_0x12aa53[_0x383a8(0x184)]||_0x12aa53['order_id']||_0x12aa53[_0x383a8(0x13b)],'status':_0x3d24ad,'amount':_0x12aa53['amount'],'currency':_0x12aa53[_0x383a8(0x191)],'region':_0x12aa53[_0x383a8(0x171)],'additionalInfo':{'payment_method':_0x12aa53[_0x383a8(0x19d)],'transaction_id':_0x12aa53[_0x383a8(0x1bc)]}};}}exports[a41_0x314da3(0x1af)]=KlymeService;