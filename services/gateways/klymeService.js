'use strict';const a42_0x2eb218=a42_0x3d99;(function(_0x43786d,_0x1f4060){const _0x34c3e6=a42_0x3d99,_0x57d26b=_0x43786d();while(!![]){try{const _0x1b4058=parseInt(_0x34c3e6(0xee))/0x1+parseInt(_0x34c3e6(0x147))/0x2+-parseInt(_0x34c3e6(0xe7))/0x3+-parseInt(_0x34c3e6(0xf4))/0x4+parseInt(_0x34c3e6(0x136))/0x5*(parseInt(_0x34c3e6(0x157))/0x6)+parseInt(_0x34c3e6(0x156))/0x7*(parseInt(_0x34c3e6(0x10a))/0x8)+-parseInt(_0x34c3e6(0x154))/0x9;if(_0x1b4058===_0x1f4060)break;else _0x57d26b['push'](_0x57d26b['shift']());}catch(_0x1ac4f2){_0x57d26b['push'](_0x57d26b['shift']());}}}(a42_0x46a3,0x2859f));function a42_0x3d99(_0x4a2ea2,_0x2a2d88){const _0x46a37f=a42_0x46a3();return a42_0x3d99=function(_0x3d9973,_0x37255d){_0x3d9973=_0x3d9973-0xde;let _0x309673=_0x46a37f[_0x3d9973];return _0x309673;},a42_0x3d99(_0x4a2ea2,_0x2a2d88);}var __createBinding=this&&this['__createBinding']||(Object[a42_0x2eb218(0x137)]?function(_0x4dcaf0,_0x3d77a6,_0x514618,_0x30e2b6){const _0x3b8f5d=a42_0x2eb218;if(_0x30e2b6===undefined)_0x30e2b6=_0x514618;var _0x373497=Object[_0x3b8f5d(0x117)](_0x3d77a6,_0x514618);(!_0x373497||(_0x3b8f5d(0x167)in _0x373497?!_0x3d77a6[_0x3b8f5d(0x100)]:_0x373497[_0x3b8f5d(0x138)]||_0x373497['configurable']))&&(_0x373497={'enumerable':!![],'get':function(){return _0x3d77a6[_0x514618];}}),Object[_0x3b8f5d(0x114)](_0x4dcaf0,_0x30e2b6,_0x373497);}:function(_0x8f6128,_0x3606d7,_0x2c9d12,_0x4ceffd){if(_0x4ceffd===undefined)_0x4ceffd=_0x2c9d12;_0x8f6128[_0x4ceffd]=_0x3606d7[_0x2c9d12];}),__setModuleDefault=this&&this[a42_0x2eb218(0x131)]||(Object[a42_0x2eb218(0x137)]?function(_0x1d634,_0x429fe7){const _0x491f40=a42_0x2eb218;Object[_0x491f40(0x114)](_0x1d634,_0x491f40(0x107),{'enumerable':!![],'value':_0x429fe7});}:function(_0x441056,_0x497275){_0x441056['default']=_0x497275;}),__importStar=this&&this[a42_0x2eb218(0x15c)]||(function(){var _0x3730be=function(_0x56f799){return _0x3730be=Object['getOwnPropertyNames']||function(_0x243681){const _0x263338=a42_0x3d99;var _0x416017=[];for(var _0x30fcfb in _0x243681)if(Object[_0x263338(0x105)][_0x263338(0x140)][_0x263338(0x158)](_0x243681,_0x30fcfb))_0x416017[_0x416017['length']]=_0x30fcfb;return _0x416017;},_0x3730be(_0x56f799);};return function(_0x4b46c6){const _0x2019b2=a42_0x3d99;if(_0x4b46c6&&_0x4b46c6[_0x2019b2(0x100)])return _0x4b46c6;var _0x42a413={};if(_0x4b46c6!=null){for(var _0x2a25ee=_0x3730be(_0x4b46c6),_0x514763=0x0;_0x514763<_0x2a25ee[_0x2019b2(0x103)];_0x514763++)if(_0x2a25ee[_0x514763]!=='default')__createBinding(_0x42a413,_0x4b46c6,_0x2a25ee[_0x514763]);}return __setModuleDefault(_0x42a413,_0x4b46c6),_0x42a413;};}());Object[a42_0x2eb218(0x114)](exports,'__esModule',{'value':!![]}),exports[a42_0x2eb218(0x15b)]=void 0x0;const loggerService_1=require(a42_0x2eb218(0xf8));class KlymeService{constructor(){const _0x52e6ab=a42_0x2eb218;this[_0x52e6ab(0x11e)]=_0x52e6ab(0xde),console[_0x52e6ab(0x128)](_0x52e6ab(0xe0));}[a42_0x2eb218(0x134)](_0x439397,_0x5bfc9e){const _0x3ed83c=a42_0x2eb218,_0x1e0b38=_0x439397[_0x3ed83c(0x150)]();switch(_0x5bfc9e){case'EU':if(_0x1e0b38!==_0x3ed83c(0x120))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x1e0b38);break;case'GB':if(_0x1e0b38!==_0x3ed83c(0x153))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x1e0b38);break;case'DE':if(_0x1e0b38!=='EUR')throw new Error(_0x3ed83c(0xeb)+_0x1e0b38);break;default:throw new Error(_0x3ed83c(0xf6)+_0x5bfc9e);}}async[a42_0x2eb218(0xfa)](){const _0xaa05e6=a42_0x2eb218,_0x40a7a6=(await Promise[_0xaa05e6(0xf1)]()['then'](()=>__importStar(require('../../config/database'))))['default'];let _0x5cb027,_0x37c286=0x0;const _0x34da1b=0xa;do{const _0x4486eb=()=>{const _0x417892=_0xaa05e6;return Math[_0x417892(0xf7)](Math[_0x417892(0x122)]()*0x5f5e100)['toString']()['padStart'](0x8,'0');};_0x5cb027=_0x4486eb()+'-'+_0x4486eb();const _0x28ac18=await _0x40a7a6['payment'][_0xaa05e6(0x160)]({'where':{'gatewayOrderId':_0x5cb027}});if(!_0x28ac18)break;_0x37c286++,console[_0xaa05e6(0x128)](_0xaa05e6(0x149)+_0x5cb027+_0xaa05e6(0x14d)+_0x37c286+')');}while(_0x37c286<_0x34da1b);if(_0x37c286>=_0x34da1b)throw new Error(_0xaa05e6(0xf5));return _0x5cb027;}async[a42_0x2eb218(0x12b)](_0x25d855){const _0x49aac4=a42_0x2eb218,{orderId:_0x32542d,amount:_0x53812c,currency:_0x1e7cd8,region:_0x50b6c2}=_0x25d855;if(_0x50b6c2!=='EU'&&_0x50b6c2!=='GB'&&_0x50b6c2!=='DE')throw new Error(_0x49aac4(0x10c)+_0x50b6c2);this[_0x49aac4(0x134)](_0x1e7cd8,_0x50b6c2);const _0x631ab1=_0x1e7cd8[_0x49aac4(0x150)]();console[_0x49aac4(0x128)](_0x49aac4(0x118)+_0x50b6c2+'\x20currency\x20validation\x20passed:\x20'+_0x631ab1);const _0x155fb1=await this['generateUniqueReference']();console['log'](_0x49aac4(0x123)+_0x155fb1+_0x49aac4(0xe5)+_0x50b6c2+')');const _0x3c4c68=_0x49aac4(0x144)+_0x32542d,_0x3b3f45={'amount':_0x53812c,'currency':_0x631ab1,'redirectUrl':_0x3c4c68,'reference':_0x155fb1,'geo':_0x50b6c2},_0x2d92cb=Date['now']();try{console[_0x49aac4(0x128)]('===\x20KLYME\x20'+_0x50b6c2+_0x49aac4(0xe6)),console[_0x49aac4(0x128)](_0x49aac4(0x13f),this[_0x49aac4(0x11e)]),console['log']('Request\x20Body:',JSON[_0x49aac4(0x14c)](_0x3b3f45,null,0x2)),console[_0x49aac4(0x128)]('Region\x20(geo):',_0x50b6c2),console['log'](_0x49aac4(0xfc),_0x631ab1,_0x49aac4(0x148)+_0x50b6c2+')'),console[_0x49aac4(0x128)](_0x49aac4(0x168),_0x155fb1,'(8digits-8digits\x20format)'),console[_0x49aac4(0x128)](_0x49aac4(0x112),_0x3c4c68),loggerService_1[_0x49aac4(0xef)]['logWhiteDomainRequest'](_0x49aac4(0x135)+_0x50b6c2[_0x49aac4(0x13c)](),_0x49aac4(0xfb),_0x49aac4(0x11d),_0x3b3f45);const _0x223647=await fetch(this[_0x49aac4(0x11e)],{'method':_0x49aac4(0x11d),'headers':{'Content-Type':_0x49aac4(0x11f),'Accept':_0x49aac4(0x11f),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x49aac4(0x14c)](_0x3b3f45)}),_0xb53c2b=Date[_0x49aac4(0x14a)]()-_0x2d92cb;console[_0x49aac4(0x128)](_0x49aac4(0x121)+_0x50b6c2+'\x20API\x20RESPONSE\x20(Unified\x20Route)\x20==='),console[_0x49aac4(0x128)](_0x49aac4(0x13d),_0x223647[_0x49aac4(0x101)]),console[_0x49aac4(0x128)]('Status\x20Text:',_0x223647[_0x49aac4(0x13e)]),console[_0x49aac4(0x128)]('Headers:',Object[_0x49aac4(0x12c)](_0x223647[_0x49aac4(0x161)][_0x49aac4(0xec)]())),console['log']('Response\x20Time:',_0xb53c2b+'ms');const _0x469130=await _0x223647[_0x49aac4(0xf9)]();console['log'](_0x49aac4(0x115),_0x469130);if(!_0x223647['ok']){console[_0x49aac4(0x12d)](_0x49aac4(0x121)+_0x50b6c2+_0x49aac4(0x11b)),console[_0x49aac4(0x12d)](_0x49aac4(0x159),_0x223647['status']),console[_0x49aac4(0x12d)](_0x49aac4(0x10e),_0x469130),loggerService_1[_0x49aac4(0xef)][_0x49aac4(0x142)](_0x49aac4(0x135)+_0x50b6c2[_0x49aac4(0x13c)](),_0x49aac4(0xfb),_0x223647[_0x49aac4(0x101)],_0x469130,_0xb53c2b),loggerService_1[_0x49aac4(0xef)][_0x49aac4(0x110)]('klyme_'+_0x50b6c2[_0x49aac4(0x13c)](),_0x49aac4(0xfb),'HTTP\x20'+_0x223647[_0x49aac4(0x101)]+':\x20'+_0x469130);throw new Error(_0x49aac4(0x166)+_0x223647[_0x49aac4(0x101)]+',\x20body:\x20'+_0x469130);}let _0x1ffa9d;try{_0x1ffa9d=JSON[_0x49aac4(0xdf)](_0x469130);}catch(_0x5d9ff3){console[_0x49aac4(0x12d)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x5d9ff3),loggerService_1[_0x49aac4(0xef)][_0x49aac4(0x110)](_0x49aac4(0x135)+_0x50b6c2[_0x49aac4(0x13c)](),_0x49aac4(0xfb),_0x49aac4(0x162)+_0x5d9ff3);throw new Error(_0x49aac4(0x145)+_0x50b6c2+_0x49aac4(0x16a)+_0x469130);}console['log']('===\x20PARSED\x20KLYME\x20'+_0x50b6c2+_0x49aac4(0x129)),console[_0x49aac4(0x128)](_0x49aac4(0xf3),JSON[_0x49aac4(0x14c)](_0x1ffa9d,null,0x2)),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x49aac4(0x135)+_0x50b6c2[_0x49aac4(0x13c)](),_0x49aac4(0xfb),_0x223647[_0x49aac4(0x101)],_0x1ffa9d,_0xb53c2b);if(_0x1ffa9d[_0x49aac4(0x12d)]||_0x1ffa9d[_0x49aac4(0x139)]){const _0xae469d=_0x1ffa9d[_0x49aac4(0x15a)]||_0x1ffa9d[_0x49aac4(0x12d)]||_0x49aac4(0x14f)+_0x50b6c2+_0x49aac4(0x130);console['error'](_0x49aac4(0x121)+_0x50b6c2+'\x20API\x20BUSINESS\x20ERROR\x20==='),console['error'](_0x49aac4(0x15e),_0xae469d),console[_0x49aac4(0x12d)](_0x49aac4(0x151),_0x1ffa9d[_0x49aac4(0x139)]),loggerService_1[_0x49aac4(0xef)][_0x49aac4(0x110)](_0x49aac4(0x135)+_0x50b6c2['toLowerCase'](),_0x49aac4(0xfb),_0x49aac4(0xe9)+_0xae469d);throw new Error(_0x49aac4(0xe8)+_0x50b6c2+_0x49aac4(0x125)+_0xae469d);}let _0x34b6ea,_0x1d5d8d;if(_0x1ffa9d[_0x49aac4(0xed)]&&_0x1ffa9d[_0x49aac4(0x108)])_0x34b6ea=_0x1ffa9d['uuid'],_0x1d5d8d=_0x1ffa9d[_0x49aac4(0x108)],console[_0x49aac4(0x128)]('===\x20KLYME\x20'+_0x50b6c2+'\x20SUCCESS\x20(New\x20Format)\x20==='),console['log']('UUID:',_0x1ffa9d['uuid']),console['log'](_0x49aac4(0x112),_0x1ffa9d['redirect_url']);else{if(_0x1ffa9d['authUrl'])_0x34b6ea=_0x155fb1,_0x1d5d8d=_0x1ffa9d['authUrl'],console[_0x49aac4(0x128)](_0x49aac4(0x121)+_0x50b6c2+_0x49aac4(0x126)),console[_0x49aac4(0x128)]('Auth\x20URL:',_0x1ffa9d['authUrl']),console[_0x49aac4(0x128)](_0x49aac4(0x11c),_0x155fb1);else{console[_0x49aac4(0x12d)](_0x49aac4(0x121)+_0x50b6c2+_0x49aac4(0x146)),console[_0x49aac4(0x12d)](_0x49aac4(0x116)),console[_0x49aac4(0x12d)]('Response\x20data:',_0x1ffa9d),loggerService_1[_0x49aac4(0xef)][_0x49aac4(0x110)](_0x49aac4(0x135)+_0x50b6c2['toLowerCase'](),_0x49aac4(0xfb),_0x49aac4(0xfd));throw new Error(_0x49aac4(0x119)+_0x50b6c2+_0x49aac4(0x111));}}return console[_0x49aac4(0x128)](_0x49aac4(0x14e),_0x631ab1,'('+_0x50b6c2+_0x49aac4(0x12f)),console['log'](_0x49aac4(0x165),_0x155fb1,_0x49aac4(0x109)),console[_0x49aac4(0x128)](_0x49aac4(0x11a),_0x50b6c2),{'gateway_payment_id':_0x34b6ea,'payment_url':_0x1d5d8d};}catch(_0x45b173){console['error'](_0x49aac4(0x121)+_0x50b6c2+_0x49aac4(0x15f)),console[_0x49aac4(0x12d)](_0x49aac4(0x155),_0x45b173),loggerService_1[_0x49aac4(0xef)]['logWhiteDomainError'](_0x49aac4(0x135)+_0x50b6c2[_0x49aac4(0x13c)](),_0x49aac4(0xfb),_0x45b173);if(_0x45b173 instanceof Error){console[_0x49aac4(0x12d)]('Error\x20message:',_0x45b173[_0x49aac4(0x15a)]),console[_0x49aac4(0x12d)](_0x49aac4(0x113),_0x45b173['stack']);throw new Error(_0x49aac4(0x164)+_0x50b6c2+_0x49aac4(0x13b)+_0x45b173[_0x49aac4(0x15a)]);}throw new Error(_0x49aac4(0x164)+_0x50b6c2+'\x20payment\x20link:\x20Unknown\x20error');}}async[a42_0x2eb218(0x13a)](_0x52dcd4,_0x26c026){const _0x304133=a42_0x2eb218,_0x4a3b2a=Date[_0x304133(0x14a)]();try{const _0x4a3132={'gatewayPaymentId':_0x52dcd4,'geo':_0x26c026};loggerService_1[_0x304133(0xef)][_0x304133(0xe2)](_0x304133(0x135)+_0x26c026[_0x304133(0x13c)](),'/verify/'+_0x52dcd4,_0x304133(0x11d),_0x4a3132);const _0x138613=await fetch(this[_0x304133(0x11e)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x304133(0x14c)](_0x4a3132)}),_0x2b4322=Date['now']()-_0x4a3b2a;if(!_0x138613['ok']){const _0x2ff96d=await _0x138613[_0x304133(0xf9)]();loggerService_1[_0x304133(0xef)][_0x304133(0x142)]('klyme_'+_0x26c026[_0x304133(0x13c)](),'/verify/'+_0x52dcd4,_0x138613[_0x304133(0x101)],_0x2ff96d,_0x2b4322);throw new Error(_0x304133(0x166)+_0x138613[_0x304133(0x101)]);}const _0x5d978a=await _0x138613[_0x304133(0xff)]();loggerService_1['loggerService'][_0x304133(0x142)]('klyme_'+_0x26c026[_0x304133(0x13c)](),_0x304133(0x12e)+_0x52dcd4,_0x138613[_0x304133(0x101)],_0x5d978a,_0x2b4322);if(_0x5d978a[_0x304133(0x12d)]||_0x5d978a[_0x304133(0x139)]){loggerService_1['loggerService']['logWhiteDomainError'](_0x304133(0x135)+_0x26c026[_0x304133(0x13c)](),'/verify/'+_0x52dcd4,_0x304133(0xe8)+_0x26c026+_0x304133(0x125)+(_0x5d978a[_0x304133(0x15a)]||_0x5d978a[_0x304133(0x12d)]||'Unknown\x20error'));throw new Error(_0x304133(0xe8)+_0x26c026+_0x304133(0x125)+(_0x5d978a[_0x304133(0x15a)]||_0x5d978a[_0x304133(0x12d)]||_0x304133(0x106)));}let _0x4eb094=_0x304133(0x102);return{'status':_0x4eb094};}catch(_0x3f2777){console[_0x304133(0x12d)](_0x304133(0xe8)+_0x26c026+_0x304133(0x10b),_0x3f2777),loggerService_1[_0x304133(0xef)][_0x304133(0x110)](_0x304133(0x135)+_0x26c026[_0x304133(0x13c)](),'/verify/'+_0x52dcd4,_0x3f2777);throw new Error(_0x304133(0xf2)+_0x26c026+_0x304133(0xe3)+(_0x3f2777 instanceof Error?_0x3f2777[_0x304133(0x15a)]:_0x304133(0x106)));}}async[a42_0x2eb218(0x12a)](_0x2517a3){const _0x1fff34=a42_0x2eb218;console[_0x1fff34(0x128)](_0x1fff34(0x10d),_0x2517a3);let _0x1bbed7=_0x1fff34(0x102);switch(_0x2517a3['status']?.[_0x1fff34(0x13c)]()){case'paid':case _0x1fff34(0xe4):case _0x1fff34(0x104):case _0x1fff34(0x133):case _0x1fff34(0x143):_0x1bbed7=_0x1fff34(0xea);break;case _0x1fff34(0xfe):case _0x1fff34(0x163):case'failed':case _0x1fff34(0x12d):case _0x1fff34(0x124):_0x1bbed7=_0x1fff34(0x14b);break;case'expired':case'timeout':_0x1bbed7=_0x1fff34(0x152);break;case'pending':case _0x1fff34(0x10f):case'active':case _0x1fff34(0x169):case _0x1fff34(0x127):default:_0x1bbed7=_0x1fff34(0x102);break;}return{'paymentId':_0x2517a3[_0x1fff34(0x141)]||_0x2517a3['order_id']||_0x2517a3[_0x1fff34(0xe1)],'status':_0x1bbed7,'amount':_0x2517a3[_0x1fff34(0x132)],'currency':_0x2517a3['currency'],'region':_0x2517a3[_0x1fff34(0x15d)],'additionalInfo':{'payment_method':_0x2517a3[_0x1fff34(0xf0)],'transaction_id':_0x2517a3['transaction_id']}};}}exports[a42_0x2eb218(0x15b)]=KlymeService;function a42_0x46a3(){const _0x4b9e39=['findFirst','headers','JSON\x20Parse\x20Error:\x20','canceled','Failed\x20to\x20create\x20KLYME\x20','Reference\x20Used:','HTTP\x20error!\x20status:\x20','get','Reference:','processing','\x20API:\x20','https://tesoft.uk/gateway/klyme/','parse','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','payment_id','logWhiteDomainRequest','\x20payment:\x20','completed','\x20(8digits-8digits\x20format\x20for\x20','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','173100uAiggr','KLYME\x20','Business\x20Error:\x20','PAID','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','entries','uuid','303353XOPoyz','loggerService','payment_method','resolve','Failed\x20to\x20verify\x20KLYME\x20','Parsed\x20Result:','729612CQIqid','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','Unsupported\x20KLYME\x20region:\x20','floor','../loggerService','text','generateUniqueReference','/create','Currency:','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','cancelled','json','__esModule','status','PENDING','length','confirmed','prototype','Unknown\x20error','default','redirect_url','(8digits-8digits\x20format)','8rBcUIW','\x20payment\x20verification\x20error:','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','Processing\x20KLYME\x20webhook:','Response\x20Body:','created','logWhiteDomainError','\x20API:\x20missing\x20payment\x20data','Redirect\x20URL:','Error\x20stack:','defineProperty','Raw\x20Response\x20Body:','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','getOwnPropertyDescriptor','💳\x20KLYME\x20','Invalid\x20response\x20from\x20KLYME\x20','Geo\x20Parameter:','\x20API\x20ERROR\x20===','Reference\x20Used\x20as\x20ID:','POST','apiUrl','application/json','EUR','===\x20KLYME\x20','random','🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20','rejected','\x20API\x20error:\x20','\x20SUCCESS\x20(Legacy\x20Format)\x20===','in_progress','log','\x20RESPONSE\x20===','processWebhook','createPaymentLink','fromEntries','error','/verify/','\x20validated)','\x20API','__setModuleDefault','amount','success','validateCurrencyForRegion','klyme_','503680LJdalz','create','writable','statusCode','verifyPayment','\x20payment\x20link:\x20','toLowerCase','Status:','statusText','URL:','hasOwnProperty','reference','logWhiteDomainResponse','successful','https://tesoft.uk/gateway/pending.php?id=','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','548106WNjveI','(validated\x20for\x20','⚠️\x20KLYME\x20reference\x20','now','FAILED','stringify','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','Currency\x20Used:','Unknown\x20error\x20from\x20KLYME\x20','toUpperCase','Status\x20Code:','EXPIRED','GBP','4504761DLsSis','Error\x20details:','889231VIdbTy','12VzoBzj','call','HTTP\x20Status:','message','KlymeService','__importStar','region','Error\x20Message:','\x20SERVICE\x20ERROR\x20==='];a42_0x46a3=function(){return _0x4b9e39;};return a42_0x46a3();}