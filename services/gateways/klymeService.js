'use strict';const a44_0x47d93f=a44_0x2a1f;(function(_0x1373df,_0x3da396){const _0x1012f6=a44_0x2a1f,_0x3713ae=_0x1373df();while(!![]){try{const _0x52808b=-parseInt(_0x1012f6(0xdd))/0x1*(-parseInt(_0x1012f6(0xac))/0x2)+-parseInt(_0x1012f6(0xc9))/0x3*(-parseInt(_0x1012f6(0xdc))/0x4)+parseInt(_0x1012f6(0xb9))/0x5+-parseInt(_0x1012f6(0xbc))/0x6+parseInt(_0x1012f6(0x109))/0x7*(-parseInt(_0x1012f6(0xaa))/0x8)+-parseInt(_0x1012f6(0x124))/0x9*(-parseInt(_0x1012f6(0xe8))/0xa)+-parseInt(_0x1012f6(0x12c))/0xb;if(_0x52808b===_0x3da396)break;else _0x3713ae['push'](_0x3713ae['shift']());}catch(_0x21eab8){_0x3713ae['push'](_0x3713ae['shift']());}}}(a44_0x300d,0xd2f8d));function a44_0x300d(){const _0x1a53b7=['KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','Reference:','KlymeService','klyme_','validateCurrencyForRegion','Status\x20Text:','Processing\x20KLYME\x20webhook:','Response\x20Time:','69CSNwxH','get','KLYME\x20','HTTP\x20','===\x20PARSED\x20KLYME\x20','length','stringify','\x20RESPONSE\x20===','pending','create','writable','Error\x20Message:','\x20API\x20BUSINESS\x20ERROR\x20===','UUID:','now','processing','active','\x20validated)','logWhiteDomainRequest','284956AvmlqL','185OItKna','error','configurable','order_id','\x20API:\x20','payment_id','message','\x20SERVICE\x20ERROR\x20===','GBP','/verify/','\x20payment\x20link:\x20','480940phvqGU','statusCode','completed','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','__esModule','toUpperCase','logWhiteDomainError','region','default','getOwnPropertyNames','transaction_id','resolve','rejected','Error\x20stack:','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','(8digits-8digits\x20format)','Region\x20(geo):','\x20API\x20error:\x20','HTTP\x20error!\x20status:\x20','created','createPaymentLink','\x20payment\x20verification\x20error:','uuid','\x20currency\x20validation\x20passed:\x20','failed','generateUniqueReference','Reference\x20Used\x20as\x20ID:','statusText','===\x20KLYME\x20','HTTP\x20Status:','payment_method','Unsupported\x20KLYME\x20region:\x20','\x20API\x20ERROR\x20===','700DYaJPH','../loggerService','loggerService','Headers:','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','redirect_url','expired','Failed\x20to\x20parse\x20JSON\x20response:','cancelled','Raw\x20Response\x20Body:','Response\x20data:','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','Error\x20message:','text','timeout','fromEntries','EUR','Currency\x20Used:','reference',',\x20body:\x20','\x20(8digits-8digits\x20format\x20for\x20','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','Failed\x20to\x20create\x20KLYME\x20','Invalid\x20response\x20from\x20KLYME\x20','../../config/database','Status:','log','198EvOTEJ','floor','defineProperty','paid','logWhiteDomainResponse','\x20payment\x20link:\x20Unknown\x20error','FAILED','currency','32622469ZjyupW','then','toString','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','URL:','TesSoft\x20Payment\x20System/1.0','entries','getOwnPropertyDescriptor','random','status','authUrl','82240CruIKO','\x20payment:\x20','16690kXuUZQ','(validated\x20for\x20','toLowerCase','Response\x20Body:','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','Error\x20details:','application/json','PENDING','\x20SUCCESS\x20(New\x20Format)\x20===','hasOwnProperty','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','JSON\x20Parse\x20Error:\x20','call','5889790BwvROh','üí≥\x20KLYME\x20','/create','3363168AtGPBN','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','POST','apiUrl','Unknown\x20error\x20from\x20KLYME\x20'];a44_0x300d=function(){return _0x1a53b7;};return a44_0x300d();}var __createBinding=this&&this['__createBinding']||(Object[a44_0x47d93f(0xd2)]?function(_0x5684a2,_0x3748e4,_0x4c2f8a,_0x47ed36){const _0x1b820e=a44_0x47d93f;if(_0x47ed36===undefined)_0x47ed36=_0x4c2f8a;var _0x5a9315=Object[_0x1b820e(0xa6)](_0x3748e4,_0x4c2f8a);(!_0x5a9315||(_0x1b820e(0xca)in _0x5a9315?!_0x3748e4[_0x1b820e(0xec)]:_0x5a9315[_0x1b820e(0xd3)]||_0x5a9315[_0x1b820e(0xdf)]))&&(_0x5a9315={'enumerable':!![],'get':function(){return _0x3748e4[_0x4c2f8a];}}),Object[_0x1b820e(0x126)](_0x5684a2,_0x47ed36,_0x5a9315);}:function(_0xf882a4,_0x5edfc9,_0x30540e,_0x1e2843){if(_0x1e2843===undefined)_0x1e2843=_0x30540e;_0xf882a4[_0x1e2843]=_0x5edfc9[_0x30540e];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a44_0x47d93f(0xd2)]?function(_0x4ed50b,_0x93f2dc){const _0x3f695a=a44_0x47d93f;Object[_0x3f695a(0x126)](_0x4ed50b,_0x3f695a(0xf0),{'enumerable':!![],'value':_0x93f2dc});}:function(_0x56da20,_0x1793c2){const _0x2dc7fc=a44_0x47d93f;_0x56da20[_0x2dc7fc(0xf0)]=_0x1793c2;}),__importStar=this&&this['__importStar']||(function(){var _0x4adc72=function(_0x333e2d){const _0x558247=a44_0x2a1f;return _0x4adc72=Object[_0x558247(0xf1)]||function(_0x1a4cb4){const _0x56fb79=_0x558247;var _0xad8a83=[];for(var _0x4e2f7d in _0x1a4cb4)if(Object['prototype'][_0x56fb79(0xb5)][_0x56fb79(0xb8)](_0x1a4cb4,_0x4e2f7d))_0xad8a83[_0xad8a83['length']]=_0x4e2f7d;return _0xad8a83;},_0x4adc72(_0x333e2d);};return function(_0x40f47b){const _0x43f5fe=a44_0x2a1f;if(_0x40f47b&&_0x40f47b[_0x43f5fe(0xec)])return _0x40f47b;var _0x252c1a={};if(_0x40f47b!=null){for(var _0x4a50ef=_0x4adc72(_0x40f47b),_0x57e06e=0x0;_0x57e06e<_0x4a50ef[_0x43f5fe(0xce)];_0x57e06e++)if(_0x4a50ef[_0x57e06e]!=='default')__createBinding(_0x252c1a,_0x40f47b,_0x4a50ef[_0x57e06e]);}return __setModuleDefault(_0x252c1a,_0x40f47b),_0x252c1a;};}());Object[a44_0x47d93f(0x126)](exports,a44_0x47d93f(0xec),{'value':!![]}),exports[a44_0x47d93f(0xc3)]=void 0x0;const loggerService_1=require(a44_0x47d93f(0x10a));function a44_0x2a1f(_0x5728bb,_0x30dd32){const _0x300da7=a44_0x300d();return a44_0x2a1f=function(_0x2a1f9c,_0x59f08e){_0x2a1f9c=_0x2a1f9c-0xa6;let _0x8fc605=_0x300da7[_0x2a1f9c];return _0x8fc605;},a44_0x2a1f(_0x5728bb,_0x30dd32);}class KlymeService{constructor(){const _0x540fb2=a44_0x47d93f;this[_0x540fb2(0xbf)]='https://tesoft.uk/gateway/klyme/',console[_0x540fb2(0x123)](_0x540fb2(0x11e));}[a44_0x47d93f(0xc5)](_0x5e34c6,_0x5e7c75){const _0x3f2cef=a44_0x47d93f,_0x48761b=_0x5e34c6[_0x3f2cef(0xed)]();switch(_0x5e7c75){case'EU':if(_0x48761b!==_0x3f2cef(0x119))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x48761b);break;case'GB':if(_0x48761b!==_0x3f2cef(0xe5))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x48761b);break;case'DE':if(_0x48761b!=='EUR')throw new Error(_0x3f2cef(0xbd)+_0x48761b);break;default:throw new Error(_0x3f2cef(0x107)+_0x5e7c75);}}async[a44_0x47d93f(0x101)](){const _0x9f2fa4=a44_0x47d93f,_0x4cf471=(await Promise[_0x9f2fa4(0xf3)]()[_0x9f2fa4(0x12d)](()=>__importStar(require(_0x9f2fa4(0x121)))))[_0x9f2fa4(0xf0)];let _0x4a9c8a,_0x33b435=0x0;const _0x4fe86c=0xa;do{const _0xf79bac=()=>{const _0xbabaad=_0x9f2fa4;return Math[_0xbabaad(0x125)](Math[_0xbabaad(0xa7)]()*0x5f5e100)[_0xbabaad(0x12e)]()['padStart'](0x8,'0');};_0x4a9c8a=_0xf79bac()+'-'+_0xf79bac();const _0x34c35f=await _0x4cf471['payment']['findFirst']({'where':{'gatewayOrderId':_0x4a9c8a}});if(!_0x34c35f)break;_0x33b435++,console[_0x9f2fa4(0x123)]('‚ö†Ô∏è\x20KLYME\x20reference\x20'+_0x4a9c8a+_0x9f2fa4(0xf6)+_0x33b435+')');}while(_0x33b435<_0x4fe86c);if(_0x33b435>=_0x4fe86c)throw new Error(_0x9f2fa4(0x114));return _0x4a9c8a;}async[a44_0x47d93f(0xfc)](_0x2fb7d3){const _0x529435=a44_0x47d93f,{orderId:_0x15ee05,amount:_0x59e0c3,currency:_0x14b6bb,region:_0x5e01d4}=_0x2fb7d3;if(_0x5e01d4!=='EU'&&_0x5e01d4!=='GB'&&_0x5e01d4!=='DE')throw new Error(_0x529435(0xc1)+_0x5e01d4);this[_0x529435(0xc5)](_0x14b6bb,_0x5e01d4);const _0x390f61=_0x14b6bb[_0x529435(0xed)]();console[_0x529435(0x123)](_0x529435(0xba)+_0x5e01d4+_0x529435(0xff)+_0x390f61);const _0x3524a1=await this[_0x529435(0x101)]();console[_0x529435(0x123)](_0x529435(0x10d)+_0x3524a1+_0x529435(0x11d)+_0x5e01d4+')');const _0x9bbb1d='https://tesoft.uk/gateway/pending.php?id='+_0x15ee05,_0x555df6={'amount':_0x59e0c3,'currency':_0x390f61,'redirectUrl':_0x9bbb1d,'reference':_0x3524a1,'geo':_0x5e01d4},_0x39bb32=Date[_0x529435(0xd7)]();try{console[_0x529435(0x123)](_0x529435(0x104)+_0x5e01d4+_0x529435(0xb6)),console[_0x529435(0x123)](_0x529435(0x130),this['apiUrl']),console[_0x529435(0x123)]('Request\x20Body:',JSON[_0x529435(0xcf)](_0x555df6,null,0x2)),console[_0x529435(0x123)](_0x529435(0xf8),_0x5e01d4),console['log']('Currency:',_0x390f61,_0x529435(0xad)+_0x5e01d4+')'),console[_0x529435(0x123)](_0x529435(0xc2),_0x3524a1,'(8digits-8digits\x20format)'),console[_0x529435(0x123)]('Redirect\x20URL:',_0x9bbb1d),loggerService_1[_0x529435(0x10b)]['logWhiteDomainRequest'](_0x529435(0xc4)+_0x5e01d4[_0x529435(0xae)](),_0x529435(0xbb),_0x529435(0xbe),_0x555df6);const _0x5561ca=await fetch(this['apiUrl'],{'method':_0x529435(0xbe),'headers':{'Content-Type':_0x529435(0xb2),'Accept':_0x529435(0xb2),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x529435(0xcf)](_0x555df6)}),_0x5ca28e=Date[_0x529435(0xd7)]()-_0x39bb32;console['log'](_0x529435(0x104)+_0x5e01d4+_0x529435(0x12f)),console[_0x529435(0x123)](_0x529435(0x122),_0x5561ca[_0x529435(0xa8)]),console['log'](_0x529435(0xc6),_0x5561ca[_0x529435(0x103)]),console[_0x529435(0x123)](_0x529435(0x10c),Object[_0x529435(0x118)](_0x5561ca['headers'][_0x529435(0x132)]())),console['log'](_0x529435(0xc8),_0x5ca28e+'ms');const _0x18c8ad=await _0x5561ca[_0x529435(0x116)]();console[_0x529435(0x123)](_0x529435(0x112),_0x18c8ad);if(!_0x5561ca['ok']){console['error']('===\x20KLYME\x20'+_0x5e01d4+_0x529435(0x108)),console[_0x529435(0xde)](_0x529435(0x105),_0x5561ca[_0x529435(0xa8)]),console[_0x529435(0xde)](_0x529435(0xaf),_0x18c8ad),loggerService_1[_0x529435(0x10b)][_0x529435(0x128)](_0x529435(0xc4)+_0x5e01d4['toLowerCase'](),_0x529435(0xbb),_0x5561ca[_0x529435(0xa8)],_0x18c8ad,_0x5ca28e),loggerService_1[_0x529435(0x10b)][_0x529435(0xee)](_0x529435(0xc4)+_0x5e01d4[_0x529435(0xae)](),'/create',_0x529435(0xcc)+_0x5561ca['status']+':\x20'+_0x18c8ad);throw new Error('HTTP\x20error!\x20status:\x20'+_0x5561ca[_0x529435(0xa8)]+_0x529435(0x11c)+_0x18c8ad);}let _0x2ee012;try{_0x2ee012=JSON['parse'](_0x18c8ad);}catch(_0x15c300){console['error'](_0x529435(0x110),_0x15c300),loggerService_1['loggerService'][_0x529435(0xee)](_0x529435(0xc4)+_0x5e01d4[_0x529435(0xae)](),_0x529435(0xbb),_0x529435(0xb7)+_0x15c300);throw new Error(_0x529435(0xeb)+_0x5e01d4+_0x529435(0xe1)+_0x18c8ad);}console[_0x529435(0x123)](_0x529435(0xcd)+_0x5e01d4+_0x529435(0xd0)),console[_0x529435(0x123)]('Parsed\x20Result:',JSON['stringify'](_0x2ee012,null,0x2)),loggerService_1[_0x529435(0x10b)][_0x529435(0x128)](_0x529435(0xc4)+_0x5e01d4['toLowerCase'](),_0x529435(0xbb),_0x5561ca[_0x529435(0xa8)],_0x2ee012,_0x5ca28e);if(_0x2ee012[_0x529435(0xde)]||_0x2ee012[_0x529435(0xe9)]){const _0x1074fc=_0x2ee012[_0x529435(0xe3)]||_0x2ee012[_0x529435(0xde)]||_0x529435(0xc0)+_0x5e01d4+'\x20API';console['error'](_0x529435(0x104)+_0x5e01d4+_0x529435(0xd5)),console['error'](_0x529435(0xd4),_0x1074fc),console[_0x529435(0xde)]('Status\x20Code:',_0x2ee012[_0x529435(0xe9)]),loggerService_1[_0x529435(0x10b)][_0x529435(0xee)]('klyme_'+_0x5e01d4['toLowerCase'](),_0x529435(0xbb),'Business\x20Error:\x20'+_0x1074fc);throw new Error(_0x529435(0xcb)+_0x5e01d4+_0x529435(0xf9)+_0x1074fc);}let _0x307caa,_0x4d795;if(_0x2ee012[_0x529435(0xfe)]&&_0x2ee012['redirect_url'])_0x307caa=_0x2ee012[_0x529435(0xfe)],_0x4d795=_0x2ee012[_0x529435(0x10e)],console[_0x529435(0x123)]('===\x20KLYME\x20'+_0x5e01d4+_0x529435(0xb4)),console[_0x529435(0x123)](_0x529435(0xd6),_0x2ee012[_0x529435(0xfe)]),console[_0x529435(0x123)]('Redirect\x20URL:',_0x2ee012[_0x529435(0x10e)]);else{if(_0x2ee012[_0x529435(0xa9)])_0x307caa=_0x3524a1,_0x4d795=_0x2ee012[_0x529435(0xa9)],console[_0x529435(0x123)]('===\x20KLYME\x20'+_0x5e01d4+'\x20SUCCESS\x20(Legacy\x20Format)\x20==='),console[_0x529435(0x123)]('Auth\x20URL:',_0x2ee012['authUrl']),console['log'](_0x529435(0x102),_0x3524a1);else{console[_0x529435(0xde)](_0x529435(0x104)+_0x5e01d4+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x529435(0xde)](_0x529435(0xb0)),console[_0x529435(0xde)](_0x529435(0x113),_0x2ee012),loggerService_1[_0x529435(0x10b)]['logWhiteDomainError'](_0x529435(0xc4)+_0x5e01d4[_0x529435(0xae)](),_0x529435(0xbb),'Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl');throw new Error(_0x529435(0x120)+_0x5e01d4+'\x20API:\x20missing\x20payment\x20data');}}return console[_0x529435(0x123)](_0x529435(0x11a),_0x390f61,'('+_0x5e01d4+_0x529435(0xda)),console[_0x529435(0x123)]('Reference\x20Used:',_0x3524a1,_0x529435(0xf7)),console['log']('Geo\x20Parameter:',_0x5e01d4),{'gateway_payment_id':_0x307caa,'payment_url':_0x4d795};}catch(_0x5ee8b7){console[_0x529435(0xde)](_0x529435(0x104)+_0x5e01d4+_0x529435(0xe4)),console[_0x529435(0xde)](_0x529435(0xb1),_0x5ee8b7),loggerService_1[_0x529435(0x10b)][_0x529435(0xee)](_0x529435(0xc4)+_0x5e01d4[_0x529435(0xae)](),_0x529435(0xbb),_0x5ee8b7);if(_0x5ee8b7 instanceof Error){console[_0x529435(0xde)](_0x529435(0x115),_0x5ee8b7[_0x529435(0xe3)]),console['error'](_0x529435(0xf5),_0x5ee8b7['stack']);throw new Error(_0x529435(0x11f)+_0x5e01d4+_0x529435(0xe7)+_0x5ee8b7['message']);}throw new Error(_0x529435(0x11f)+_0x5e01d4+_0x529435(0x129));}}async['verifyPayment'](_0x38348d,_0xd750b8){const _0x574864=a44_0x47d93f,_0x359c7e=Date['now']();try{const _0x593076={'gatewayPaymentId':_0x38348d,'geo':_0xd750b8};loggerService_1[_0x574864(0x10b)][_0x574864(0xdb)](_0x574864(0xc4)+_0xd750b8[_0x574864(0xae)](),_0x574864(0xe6)+_0x38348d,_0x574864(0xbe),_0x593076);const _0x130cc4=await fetch(this[_0x574864(0xbf)],{'method':_0x574864(0xbe),'headers':{'Content-Type':'application/json','User-Agent':_0x574864(0x131)},'body':JSON[_0x574864(0xcf)](_0x593076)}),_0x4f5c8f=Date[_0x574864(0xd7)]()-_0x359c7e;if(!_0x130cc4['ok']){const _0x485d0e=await _0x130cc4[_0x574864(0x116)]();loggerService_1[_0x574864(0x10b)][_0x574864(0x128)](_0x574864(0xc4)+_0xd750b8[_0x574864(0xae)](),_0x574864(0xe6)+_0x38348d,_0x130cc4[_0x574864(0xa8)],_0x485d0e,_0x4f5c8f);throw new Error(_0x574864(0xfa)+_0x130cc4[_0x574864(0xa8)]);}const _0x2c1313=await _0x130cc4['json']();loggerService_1[_0x574864(0x10b)][_0x574864(0x128)](_0x574864(0xc4)+_0xd750b8[_0x574864(0xae)](),_0x574864(0xe6)+_0x38348d,_0x130cc4[_0x574864(0xa8)],_0x2c1313,_0x4f5c8f);if(_0x2c1313['error']||_0x2c1313[_0x574864(0xe9)]){loggerService_1['loggerService']['logWhiteDomainError'](_0x574864(0xc4)+_0xd750b8['toLowerCase'](),_0x574864(0xe6)+_0x38348d,_0x574864(0xcb)+_0xd750b8+_0x574864(0xf9)+(_0x2c1313[_0x574864(0xe3)]||_0x2c1313['error']||'Unknown\x20error'));throw new Error('KLYME\x20'+_0xd750b8+_0x574864(0xf9)+(_0x2c1313[_0x574864(0xe3)]||_0x2c1313[_0x574864(0xde)]||'Unknown\x20error'));}let _0x17dc7a='PENDING';return{'status':_0x17dc7a};}catch(_0xad08ff){console[_0x574864(0xde)]('KLYME\x20'+_0xd750b8+_0x574864(0xfd),_0xad08ff),loggerService_1[_0x574864(0x10b)][_0x574864(0xee)](_0x574864(0xc4)+_0xd750b8[_0x574864(0xae)](),_0x574864(0xe6)+_0x38348d,_0xad08ff);throw new Error('Failed\x20to\x20verify\x20KLYME\x20'+_0xd750b8+_0x574864(0xab)+(_0xad08ff instanceof Error?_0xad08ff[_0x574864(0xe3)]:'Unknown\x20error'));}}async['processWebhook'](_0xa933c1){const _0x4e3c96=a44_0x47d93f;console[_0x4e3c96(0x123)](_0x4e3c96(0xc7),_0xa933c1);let _0x8bbd19=_0x4e3c96(0xb3);switch(_0xa933c1[_0x4e3c96(0xa8)]?.['toLowerCase']()){case _0x4e3c96(0x127):case _0x4e3c96(0xea):case'confirmed':case'success':case'successful':_0x8bbd19='PAID';break;case _0x4e3c96(0x111):case'canceled':case _0x4e3c96(0x100):case _0x4e3c96(0xde):case _0x4e3c96(0xf4):_0x8bbd19=_0x4e3c96(0x12a);break;case _0x4e3c96(0x10f):case _0x4e3c96(0x117):_0x8bbd19='EXPIRED';break;case _0x4e3c96(0xd1):case _0x4e3c96(0xfb):case _0x4e3c96(0xd9):case _0x4e3c96(0xd8):case'in_progress':default:_0x8bbd19='PENDING';break;}return{'paymentId':_0xa933c1[_0x4e3c96(0x11b)]||_0xa933c1[_0x4e3c96(0xe0)]||_0xa933c1[_0x4e3c96(0xe2)],'status':_0x8bbd19,'amount':_0xa933c1['amount'],'currency':_0xa933c1[_0x4e3c96(0x12b)],'region':_0xa933c1[_0x4e3c96(0xef)],'additionalInfo':{'payment_method':_0xa933c1[_0x4e3c96(0x106)],'transaction_id':_0xa933c1[_0x4e3c96(0xf2)]}};}}exports[a44_0x47d93f(0xc3)]=KlymeService;