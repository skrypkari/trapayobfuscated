'use strict';const a41_0x536f05=a41_0x32d8;(function(_0x363852,_0x511aff){const _0xb095ac=a41_0x32d8,_0x5a98ef=_0x363852();while(!![]){try{const _0x32c2ca=-parseInt(_0xb095ac(0x212))/0x1+-parseInt(_0xb095ac(0x213))/0x2*(-parseInt(_0xb095ac(0x202))/0x3)+parseInt(_0xb095ac(0x208))/0x4+parseInt(_0xb095ac(0x224))/0x5+parseInt(_0xb095ac(0x21b))/0x6*(-parseInt(_0xb095ac(0x1e6))/0x7)+-parseInt(_0xb095ac(0x1d7))/0x8+parseInt(_0xb095ac(0x22d))/0x9*(parseInt(_0xb095ac(0x216))/0xa);if(_0x32c2ca===_0x511aff)break;else _0x5a98ef['push'](_0x5a98ef['shift']());}catch(_0x4f3d2a){_0x5a98ef['push'](_0x5a98ef['shift']());}}}(a41_0x1bf7,0x22dcb));function a41_0x1bf7(){const _0x3a538d=['successful','active','Parsed\x20Result:',',\x20body:\x20','Invalid\x20response\x20from\x20KLYME\x20','Error\x20details:','323973wNXFDP','region','transaction_id','then','PENDING','Redirect\x20URL:','stringify','POST','__esModule','\x20(8digits-8digits\x20format\x20for\x20','\x20API:\x20missing\x20payment\x20data','created','klyme_','\x20API:\x20','payment_method','GBP','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','\x20API\x20BUSINESS\x20ERROR\x20===','error','\x20payment:\x20','../../config/database','===\x20PARSED\x20KLYME\x20','Headers:','expired','URL:','\x20payment\x20verification\x20error:','application/json','logWhiteDomainError','Failed\x20to\x20create\x20KLYME\x20','__importStar','/create','toUpperCase','validateCurrencyForRegion','authUrl','Request\x20Body:','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','\x20SUCCESS\x20(New\x20Format)\x20===','stack','length','entries','Reference:','defineProperty','logWhiteDomainRequest','uuid','\x20validated)','\x20API\x20ERROR\x20===','Business\x20Error:\x20','https://tesoft.uk/gateway/klyme/','timeout','pending','failed','completed','KLYME\x20','confirmed','‚ö†Ô∏è\x20KLYME\x20reference\x20','1390504AQnwuJ','HTTP\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Status\x20Text:','\x20API\x20error:\x20','success','log','Failed\x20to\x20parse\x20JSON\x20response:','Raw\x20Response\x20Body:','(8digits-8digits\x20format)','configurable','Status\x20Code:','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','Response\x20Time:','\x20SERVICE\x20ERROR\x20===','7XdJkUA','message','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','KlymeService','apiUrl','../loggerService','getOwnPropertyNames','statusCode','reference','loggerService','FAILED','\x20SUCCESS\x20(Legacy\x20Format)\x20===','Response\x20data:','generateUniqueReference','Region\x20(geo):','fromEntries','parse','TesSoft\x20Payment\x20System/1.0','\x20RESPONSE\x20===','toLowerCase','order_id','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','Currency:','EUR','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Unknown\x20error','Geo\x20Parameter:','now','230751aaNATG','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Unsupported\x20KLYME\x20region:\x20','Error\x20stack:','findFirst','paid','378412prgweF','/verify/','__createBinding','processWebhook','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','üí≥\x20KLYME\x20','Failed\x20to\x20verify\x20KLYME\x20','default','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','PAID','78296BYYWDz','6OxfcFe','create','Error\x20message:','20eKlUNw','get','floor','logWhiteDomainResponse','hasOwnProperty','61752SSrQgx','EXPIRED','text','UUID:','resolve','===\x20KLYME\x20','Error\x20Message:','json','call','39240tKAtPM','status','verifyPayment'];a41_0x1bf7=function(){return _0x3a538d;};return a41_0x1bf7();}var __createBinding=this&&this[a41_0x536f05(0x20a)]||(Object[a41_0x536f05(0x214)]?function(_0x46599d,_0x26c6b1,_0x2b8cea,_0x246ca5){const _0x33212e=a41_0x536f05;if(_0x246ca5===undefined)_0x246ca5=_0x2b8cea;var _0x4630f3=Object['getOwnPropertyDescriptor'](_0x26c6b1,_0x2b8cea);(!_0x4630f3||(_0x33212e(0x217)in _0x4630f3?!_0x26c6b1[_0x33212e(0x235)]:_0x4630f3['writable']||_0x4630f3[_0x33212e(0x1e1)]))&&(_0x4630f3={'enumerable':!![],'get':function(){return _0x26c6b1[_0x2b8cea];}}),Object[_0x33212e(0x1c9)](_0x46599d,_0x246ca5,_0x4630f3);}:function(_0x2575ed,_0x5d0f9e,_0x3a7777,_0x5a06fe){if(_0x5a06fe===undefined)_0x5a06fe=_0x3a7777;_0x2575ed[_0x5a06fe]=_0x5d0f9e[_0x3a7777];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a41_0x536f05(0x214)]?function(_0x1791a6,_0x60f31b){const _0x5856aa=a41_0x536f05;Object[_0x5856aa(0x1c9)](_0x1791a6,_0x5856aa(0x20f),{'enumerable':!![],'value':_0x60f31b});}:function(_0x15fa05,_0x4e6831){_0x15fa05['default']=_0x4e6831;}),__importStar=this&&this[a41_0x536f05(0x1bd)]||(function(){var _0x107209=function(_0x316a7b){const _0x3d1bc0=a41_0x32d8;return _0x107209=Object[_0x3d1bc0(0x1ec)]||function(_0x2dd0a1){const _0x4ffe41=_0x3d1bc0;var _0x2d9a06=[];for(var _0x15e884 in _0x2dd0a1)if(Object['prototype'][_0x4ffe41(0x21a)][_0x4ffe41(0x223)](_0x2dd0a1,_0x15e884))_0x2d9a06[_0x2d9a06[_0x4ffe41(0x1c6)]]=_0x15e884;return _0x2d9a06;},_0x107209(_0x316a7b);};return function(_0x3d962e){const _0x5b33a6=a41_0x32d8;if(_0x3d962e&&_0x3d962e['__esModule'])return _0x3d962e;var _0x80b7ba={};if(_0x3d962e!=null){for(var _0x1b7afd=_0x107209(_0x3d962e),_0x42ab8e=0x0;_0x42ab8e<_0x1b7afd[_0x5b33a6(0x1c6)];_0x42ab8e++)if(_0x1b7afd[_0x42ab8e]!==_0x5b33a6(0x20f))__createBinding(_0x80b7ba,_0x3d962e,_0x1b7afd[_0x42ab8e]);}return __setModuleDefault(_0x80b7ba,_0x3d962e),_0x80b7ba;};}());Object[a41_0x536f05(0x1c9)](exports,a41_0x536f05(0x235),{'value':!![]}),exports[a41_0x536f05(0x1e9)]=void 0x0;const loggerService_1=require(a41_0x536f05(0x1eb));class KlymeService{constructor(){const _0x5043a5=a41_0x536f05;this['apiUrl']=_0x5043a5(0x1cf),console[_0x5043a5(0x1dd)]('üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions');}[a41_0x536f05(0x1c0)](_0x2b0005,_0x58cd17){const _0x39003a=a41_0x536f05,_0x2e36bd=_0x2b0005[_0x39003a(0x1bf)]();switch(_0x58cd17){case'EU':if(_0x2e36bd!==_0x39003a(0x1fd))throw new Error(_0x39003a(0x1d9)+_0x2e36bd);break;case'GB':if(_0x2e36bd!==_0x39003a(0x23c))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x2e36bd);break;case'DE':if(_0x2e36bd!==_0x39003a(0x1fd))throw new Error(_0x39003a(0x1fe)+_0x2e36bd);break;default:throw new Error(_0x39003a(0x204)+_0x58cd17);}}async[a41_0x536f05(0x1f3)](){const _0x42bd61=a41_0x536f05,_0xf40580=(await Promise[_0x42bd61(0x21f)]()[_0x42bd61(0x230)](()=>__importStar(require(_0x42bd61(0x242)))))[_0x42bd61(0x20f)];let _0x164301,_0x404329=0x0;const _0x25b3f3=0xa;do{const _0x241a58=()=>{const _0x1b3dde=_0x42bd61;return Math[_0x1b3dde(0x218)](Math['random']()*0x5f5e100)['toString']()['padStart'](0x8,'0');};_0x164301=_0x241a58()+'-'+_0x241a58();const _0x4f5fd=await _0xf40580['payment'][_0x42bd61(0x206)]({'where':{'gatewayOrderId':_0x164301}});if(!_0x4f5fd)break;_0x404329++,console[_0x42bd61(0x1dd)](_0x42bd61(0x1d6)+_0x164301+_0x42bd61(0x20c)+_0x404329+')');}while(_0x404329<_0x25b3f3);if(_0x404329>=_0x25b3f3)throw new Error(_0x42bd61(0x1c3));return _0x164301;}async['createPaymentLink'](_0x2db508){const _0x198020=a41_0x536f05,{orderId:_0x5c49f0,amount:_0x15245b,currency:_0x2c3c1b,region:_0x593f54}=_0x2db508;if(_0x593f54!=='EU'&&_0x593f54!=='GB'&&_0x593f54!=='DE')throw new Error(_0x198020(0x1fb)+_0x593f54);this[_0x198020(0x1c0)](_0x2c3c1b,_0x593f54);const _0x2dde9c=_0x2c3c1b['toUpperCase']();console['log'](_0x198020(0x20d)+_0x593f54+'\x20currency\x20validation\x20passed:\x20'+_0x2dde9c);const _0x17db08=await this[_0x198020(0x1f3)]();console['log']('üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20'+_0x17db08+_0x198020(0x236)+_0x593f54+')');const _0x5e4bb8='https://tesoft.uk/gateway/pending.php?id='+_0x5c49f0,_0x5d3716={'amount':_0x15245b,'currency':_0x2dde9c,'redirectUrl':_0x5e4bb8,'reference':_0x17db08,'geo':_0x593f54},_0x51c8d9=Date['now']();try{console[_0x198020(0x1dd)](_0x198020(0x220)+_0x593f54+_0x198020(0x23d)),console['log'](_0x198020(0x246),this[_0x198020(0x1ea)]),console['log'](_0x198020(0x1c2),JSON['stringify'](_0x5d3716,null,0x2)),console[_0x198020(0x1dd)](_0x198020(0x1f4),_0x593f54),console[_0x198020(0x1dd)](_0x198020(0x1fc),_0x2dde9c,'(validated\x20for\x20'+_0x593f54+')'),console['log'](_0x198020(0x1c8),_0x17db08,_0x198020(0x1e0)),console[_0x198020(0x1dd)](_0x198020(0x232),_0x5e4bb8),loggerService_1[_0x198020(0x1ef)][_0x198020(0x1ca)](_0x198020(0x239)+_0x593f54['toLowerCase'](),_0x198020(0x1be),_0x198020(0x234),_0x5d3716);const _0xfe16c3=await fetch(this['apiUrl'],{'method':_0x198020(0x234),'headers':{'Content-Type':_0x198020(0x248),'Accept':'application/json','User-Agent':_0x198020(0x1f7)},'body':JSON['stringify'](_0x5d3716)}),_0x1c2c10=Date[_0x198020(0x201)]()-_0x51c8d9;console[_0x198020(0x1dd)](_0x198020(0x220)+_0x593f54+_0x198020(0x1e8)),console[_0x198020(0x1dd)]('Status:',_0xfe16c3[_0x198020(0x225)]),console['log'](_0x198020(0x1da),_0xfe16c3['statusText']),console[_0x198020(0x1dd)](_0x198020(0x244),Object[_0x198020(0x1f5)](_0xfe16c3['headers'][_0x198020(0x1c7)]())),console[_0x198020(0x1dd)](_0x198020(0x1e4),_0x1c2c10+'ms');const _0x55f18f=await _0xfe16c3[_0x198020(0x21d)]();console[_0x198020(0x1dd)](_0x198020(0x1df),_0x55f18f);if(!_0xfe16c3['ok']){console['error'](_0x198020(0x220)+_0x593f54+_0x198020(0x1cd)),console[_0x198020(0x240)]('HTTP\x20Status:',_0xfe16c3[_0x198020(0x225)]),console[_0x198020(0x240)]('Response\x20Body:',_0x55f18f),loggerService_1[_0x198020(0x1ef)][_0x198020(0x219)]('klyme_'+_0x593f54[_0x198020(0x1f9)](),_0x198020(0x1be),_0xfe16c3[_0x198020(0x225)],_0x55f18f,_0x1c2c10),loggerService_1[_0x198020(0x1ef)][_0x198020(0x249)](_0x198020(0x239)+_0x593f54['toLowerCase'](),'/create',_0x198020(0x1d8)+_0xfe16c3['status']+':\x20'+_0x55f18f);throw new Error('HTTP\x20error!\x20status:\x20'+_0xfe16c3[_0x198020(0x225)]+_0x198020(0x22a)+_0x55f18f);}let _0x447919;try{_0x447919=JSON[_0x198020(0x1f6)](_0x55f18f);}catch(_0x114438){console[_0x198020(0x240)](_0x198020(0x1de),_0x114438),loggerService_1[_0x198020(0x1ef)]['logWhiteDomainError']('klyme_'+_0x593f54[_0x198020(0x1f9)](),_0x198020(0x1be),'JSON\x20Parse\x20Error:\x20'+_0x114438);throw new Error(_0x198020(0x23e)+_0x593f54+_0x198020(0x23a)+_0x55f18f);}console[_0x198020(0x1dd)](_0x198020(0x243)+_0x593f54+_0x198020(0x1f8)),console['log'](_0x198020(0x229),JSON[_0x198020(0x233)](_0x447919,null,0x2)),loggerService_1[_0x198020(0x1ef)]['logWhiteDomainResponse'](_0x198020(0x239)+_0x593f54[_0x198020(0x1f9)](),_0x198020(0x1be),_0xfe16c3[_0x198020(0x225)],_0x447919,_0x1c2c10);if(_0x447919[_0x198020(0x240)]||_0x447919[_0x198020(0x1ed)]){const _0x2332e3=_0x447919[_0x198020(0x1e7)]||_0x447919[_0x198020(0x240)]||'Unknown\x20error\x20from\x20KLYME\x20'+_0x593f54+'\x20API';console[_0x198020(0x240)](_0x198020(0x220)+_0x593f54+_0x198020(0x23f)),console[_0x198020(0x240)](_0x198020(0x221),_0x2332e3),console[_0x198020(0x240)](_0x198020(0x1e2),_0x447919[_0x198020(0x1ed)]),loggerService_1[_0x198020(0x1ef)][_0x198020(0x249)](_0x198020(0x239)+_0x593f54['toLowerCase'](),_0x198020(0x1be),_0x198020(0x1ce)+_0x2332e3);throw new Error(_0x198020(0x1d4)+_0x593f54+'\x20API\x20error:\x20'+_0x2332e3);}let _0x33ca3b,_0x1ddeb9;if(_0x447919['uuid']&&_0x447919['redirect_url'])_0x33ca3b=_0x447919[_0x198020(0x1cb)],_0x1ddeb9=_0x447919['redirect_url'],console[_0x198020(0x1dd)](_0x198020(0x220)+_0x593f54+_0x198020(0x1c4)),console['log'](_0x198020(0x21e),_0x447919[_0x198020(0x1cb)]),console['log'](_0x198020(0x232),_0x447919['redirect_url']);else{if(_0x447919[_0x198020(0x1c1)])_0x33ca3b=_0x17db08,_0x1ddeb9=_0x447919['authUrl'],console[_0x198020(0x1dd)](_0x198020(0x220)+_0x593f54+_0x198020(0x1f1)),console[_0x198020(0x1dd)]('Auth\x20URL:',_0x447919[_0x198020(0x1c1)]),console[_0x198020(0x1dd)]('Reference\x20Used\x20as\x20ID:',_0x17db08);else{console[_0x198020(0x240)](_0x198020(0x220)+_0x593f54+_0x198020(0x203)),console['error'](_0x198020(0x1e3)),console[_0x198020(0x240)](_0x198020(0x1f2),_0x447919),loggerService_1[_0x198020(0x1ef)]['logWhiteDomainError'](_0x198020(0x239)+_0x593f54[_0x198020(0x1f9)](),'/create',_0x198020(0x210));throw new Error(_0x198020(0x22b)+_0x593f54+_0x198020(0x237));}}return console[_0x198020(0x1dd)]('Currency\x20Used:',_0x2dde9c,'('+_0x593f54+_0x198020(0x1cc)),console[_0x198020(0x1dd)]('Reference\x20Used:',_0x17db08,_0x198020(0x1e0)),console[_0x198020(0x1dd)](_0x198020(0x200),_0x593f54),{'gateway_payment_id':_0x33ca3b,'payment_url':_0x1ddeb9};}catch(_0xf8773d){console[_0x198020(0x240)](_0x198020(0x220)+_0x593f54+_0x198020(0x1e5)),console[_0x198020(0x240)](_0x198020(0x22c),_0xf8773d),loggerService_1['loggerService']['logWhiteDomainError'](_0x198020(0x239)+_0x593f54[_0x198020(0x1f9)](),_0x198020(0x1be),_0xf8773d);if(_0xf8773d instanceof Error){console[_0x198020(0x240)](_0x198020(0x215),_0xf8773d[_0x198020(0x1e7)]),console[_0x198020(0x240)](_0x198020(0x205),_0xf8773d[_0x198020(0x1c5)]);throw new Error(_0x198020(0x1bc)+_0x593f54+'\x20payment\x20link:\x20'+_0xf8773d[_0x198020(0x1e7)]);}throw new Error(_0x198020(0x1bc)+_0x593f54+'\x20payment\x20link:\x20Unknown\x20error');}}async[a41_0x536f05(0x226)](_0x5e4a6e,_0x390f9c){const _0x1d5d37=a41_0x536f05,_0x5945db=Date[_0x1d5d37(0x201)]();try{const _0x3a0798={'gatewayPaymentId':_0x5e4a6e,'geo':_0x390f9c};loggerService_1[_0x1d5d37(0x1ef)][_0x1d5d37(0x1ca)](_0x1d5d37(0x239)+_0x390f9c[_0x1d5d37(0x1f9)](),_0x1d5d37(0x209)+_0x5e4a6e,'POST',_0x3a0798);const _0x19814c=await fetch(this['apiUrl'],{'method':_0x1d5d37(0x234),'headers':{'Content-Type':_0x1d5d37(0x248),'User-Agent':_0x1d5d37(0x1f7)},'body':JSON[_0x1d5d37(0x233)](_0x3a0798)}),_0x582c50=Date[_0x1d5d37(0x201)]()-_0x5945db;if(!_0x19814c['ok']){const _0x226a0f=await _0x19814c[_0x1d5d37(0x21d)]();loggerService_1[_0x1d5d37(0x1ef)][_0x1d5d37(0x219)](_0x1d5d37(0x239)+_0x390f9c['toLowerCase'](),_0x1d5d37(0x209)+_0x5e4a6e,_0x19814c[_0x1d5d37(0x225)],_0x226a0f,_0x582c50);throw new Error('HTTP\x20error!\x20status:\x20'+_0x19814c[_0x1d5d37(0x225)]);}const _0x13668c=await _0x19814c[_0x1d5d37(0x222)]();loggerService_1[_0x1d5d37(0x1ef)][_0x1d5d37(0x219)](_0x1d5d37(0x239)+_0x390f9c[_0x1d5d37(0x1f9)](),_0x1d5d37(0x209)+_0x5e4a6e,_0x19814c['status'],_0x13668c,_0x582c50);if(_0x13668c[_0x1d5d37(0x240)]||_0x13668c['statusCode']){loggerService_1[_0x1d5d37(0x1ef)]['logWhiteDomainError'](_0x1d5d37(0x239)+_0x390f9c[_0x1d5d37(0x1f9)](),_0x1d5d37(0x209)+_0x5e4a6e,'KLYME\x20'+_0x390f9c+'\x20API\x20error:\x20'+(_0x13668c[_0x1d5d37(0x1e7)]||_0x13668c[_0x1d5d37(0x240)]||'Unknown\x20error'));throw new Error(_0x1d5d37(0x1d4)+_0x390f9c+_0x1d5d37(0x1db)+(_0x13668c[_0x1d5d37(0x1e7)]||_0x13668c['error']||_0x1d5d37(0x1ff)));}let _0x286c25=_0x1d5d37(0x231);return{'status':_0x286c25};}catch(_0x34f02a){console['error']('KLYME\x20'+_0x390f9c+_0x1d5d37(0x247),_0x34f02a),loggerService_1[_0x1d5d37(0x1ef)]['logWhiteDomainError'](_0x1d5d37(0x239)+_0x390f9c[_0x1d5d37(0x1f9)](),_0x1d5d37(0x209)+_0x5e4a6e,_0x34f02a);throw new Error(_0x1d5d37(0x20e)+_0x390f9c+_0x1d5d37(0x241)+(_0x34f02a instanceof Error?_0x34f02a['message']:'Unknown\x20error'));}}async[a41_0x536f05(0x20b)](_0x18f11f){const _0x48c18e=a41_0x536f05;console[_0x48c18e(0x1dd)]('Processing\x20KLYME\x20webhook:',_0x18f11f);let _0x4eca61=_0x48c18e(0x231);switch(_0x18f11f[_0x48c18e(0x225)]?.[_0x48c18e(0x1f9)]()){case _0x48c18e(0x207):case _0x48c18e(0x1d3):case _0x48c18e(0x1d5):case _0x48c18e(0x1dc):case _0x48c18e(0x227):_0x4eca61=_0x48c18e(0x211);break;case'cancelled':case'canceled':case _0x48c18e(0x1d2):case _0x48c18e(0x240):case'rejected':_0x4eca61=_0x48c18e(0x1f0);break;case _0x48c18e(0x245):case _0x48c18e(0x1d0):_0x4eca61=_0x48c18e(0x21c);break;case _0x48c18e(0x1d1):case _0x48c18e(0x238):case _0x48c18e(0x228):case'processing':case'in_progress':default:_0x4eca61=_0x48c18e(0x231);break;}return{'paymentId':_0x18f11f[_0x48c18e(0x1ee)]||_0x18f11f[_0x48c18e(0x1fa)]||_0x18f11f['payment_id'],'status':_0x4eca61,'amount':_0x18f11f['amount'],'currency':_0x18f11f['currency'],'region':_0x18f11f[_0x48c18e(0x22e)],'additionalInfo':{'payment_method':_0x18f11f[_0x48c18e(0x23b)],'transaction_id':_0x18f11f[_0x48c18e(0x22f)]}};}}function a41_0x32d8(_0x5382fd,_0x4847bb){const _0x1bf77c=a41_0x1bf7();return a41_0x32d8=function(_0x32d8b7,_0x1db38b){_0x32d8b7=_0x32d8b7-0x1bc;let _0x2d3716=_0x1bf77c[_0x32d8b7];return _0x2d3716;},a41_0x32d8(_0x5382fd,_0x4847bb);}exports[a41_0x536f05(0x1e9)]=KlymeService;