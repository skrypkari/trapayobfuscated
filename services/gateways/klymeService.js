'use strict';const a67_0x181b6f=a67_0x1504;(function(_0x164a9b,_0x488fe1){const _0x1e15bd=a67_0x1504,_0x1b8d53=_0x164a9b();while(!![]){try{const _0x465e57=parseInt(_0x1e15bd(0x1c0))/0x1+-parseInt(_0x1e15bd(0x17a))/0x2*(-parseInt(_0x1e15bd(0x1d9))/0x3)+-parseInt(_0x1e15bd(0x189))/0x4*(parseInt(_0x1e15bd(0x1e4))/0x5)+parseInt(_0x1e15bd(0x1dc))/0x6+parseInt(_0x1e15bd(0x1d1))/0x7*(parseInt(_0x1e15bd(0x183))/0x8)+parseInt(_0x1e15bd(0x176))/0x9+-parseInt(_0x1e15bd(0x1d4))/0xa;if(_0x465e57===_0x488fe1)break;else _0x1b8d53['push'](_0x1b8d53['shift']());}catch(_0x1d2d65){_0x1b8d53['push'](_0x1b8d53['shift']());}}}(a67_0x48e0,0x89ba0));function a67_0x1504(_0x2e8861,_0x29a0ac){_0x2e8861=_0x2e8861-0x165;const _0x48e019=a67_0x48e0();let _0x1504a9=_0x48e019[_0x2e8861];return _0x1504a9;}var __createBinding=this&&this[a67_0x181b6f(0x1c7)]||(Object[a67_0x181b6f(0x1a4)]?function(_0x5cb6b0,_0x29ce9a,_0x238643,_0x25eb33){const _0x5acd05=a67_0x181b6f;if(_0x25eb33===undefined)_0x25eb33=_0x238643;var _0x5877b9=Object['getOwnPropertyDescriptor'](_0x29ce9a,_0x238643);(!_0x5877b9||(_0x5acd05(0x16f)in _0x5877b9?!_0x29ce9a[_0x5acd05(0x16d)]:_0x5877b9[_0x5acd05(0x190)]||_0x5877b9['configurable']))&&(_0x5877b9={'enumerable':!![],'get':function(){return _0x29ce9a[_0x238643];}}),Object[_0x5acd05(0x1ac)](_0x5cb6b0,_0x25eb33,_0x5877b9);}:function(_0x5975a7,_0x22034c,_0x143fc5,_0x32ba11){if(_0x32ba11===undefined)_0x32ba11=_0x143fc5;_0x5975a7[_0x32ba11]=_0x22034c[_0x143fc5];}),__setModuleDefault=this&&this[a67_0x181b6f(0x1c3)]||(Object[a67_0x181b6f(0x1a4)]?function(_0x4d2084,_0x199570){const _0x3278ad=a67_0x181b6f;Object[_0x3278ad(0x1ac)](_0x4d2084,'default',{'enumerable':!![],'value':_0x199570});}:function(_0x12e517,_0x588d4b){_0x12e517['default']=_0x588d4b;}),__importStar=this&&this[a67_0x181b6f(0x193)]||(function(){var _0xae8958=function(_0x45db0f){return _0xae8958=Object['getOwnPropertyNames']||function(_0x65786d){const _0x5aad14=a67_0x1504;var _0x3be493=[];for(var _0x452fc8 in _0x65786d)if(Object[_0x5aad14(0x1ed)][_0x5aad14(0x1be)][_0x5aad14(0x1d6)](_0x65786d,_0x452fc8))_0x3be493[_0x3be493[_0x5aad14(0x1eb)]]=_0x452fc8;return _0x3be493;},_0xae8958(_0x45db0f);};return function(_0x3082f4){const _0x54af9d=a67_0x1504;if(_0x3082f4&&_0x3082f4[_0x54af9d(0x16d)])return _0x3082f4;var _0x5d3886={};if(_0x3082f4!=null){for(var _0x21c6ce=_0xae8958(_0x3082f4),_0x1bdbf2=0x0;_0x1bdbf2<_0x21c6ce['length'];_0x1bdbf2++)if(_0x21c6ce[_0x1bdbf2]!==_0x54af9d(0x16b))__createBinding(_0x5d3886,_0x3082f4,_0x21c6ce[_0x1bdbf2]);}return __setModuleDefault(_0x5d3886,_0x3082f4),_0x5d3886;};}());function a67_0x48e0(){const _0x1af479=['successful','787256brcQkd','/create','stringify','Reference:','in_progress','\x20SUCCESS\x20(Legacy\x20Format)\x20===','Region\x20(geo):','writable','PAID','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','__importStar','Redirect\x20URL:','reference','HTTP\x20Status:','JSON\x20Parse\x20Error:\x20','order_id','===\x20PARSED\x20KLYME\x20','KlymeService','loggerService','\x20SUCCESS\x20(New\x20Format)\x20===','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','logWhiteDomainRequest','Reference\x20Used:','Failed\x20to\x20verify\x20KLYME\x20','application/json','ðŸ’³\x20KLYME\x20','Geo\x20Parameter:','create','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','apiUrl','logWhiteDomainError','authUrl','Parsed\x20Result:','Unknown\x20error\x20from\x20KLYME\x20','Invalid\x20response\x20from\x20KLYME\x20','defineProperty','Headers:','Business\x20Error:\x20','canceled','(8digits-8digits\x20format)','POST','===\x20KLYME\x20','âš ï¸\x20KLYME\x20reference\x20','FAILED','\x20currency\x20validation\x20passed:\x20','generateUniqueReference','Failed\x20to\x20create\x20KLYME\x20','\x20API:\x20','Currency\x20Used:','ðŸ’³\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','validateCurrencyForRegion','\x20payment\x20verification\x20error:','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','hasOwnProperty','parse','536556siSGXS','headers','status','__setModuleDefault','random','resolve','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','__createBinding','\x20API\x20BUSINESS\x20ERROR\x20===','Error\x20message:','payment_id','KLYME\x20','Response\x20data:','pending','Error\x20stack:','statusText','payment','242067HuFAAK','Processing\x20KLYME\x20webhook:','Currency:','15008470znQiwL','PENDING','call','Error\x20details:','URL:','162363nWzRPN','toLowerCase','error','704592PsSLyy','message','ðŸŽ¯\x20Generated\x20unique\x20KLYME\x20reference:\x20','\x20API','\x20RESPONSE\x20===','json','Status\x20Text:','rejected','5AZsFOS','stack','Response\x20Body:','floor','../../config/database','\x20API:\x20missing\x20payment\x20data','UUID:','length','redirect_url','prototype','paid','failed','then','HTTP\x20error!\x20status:\x20','\x20payment:\x20','statusCode','processWebhook','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','https://tesoft.uk/gateway/pending.php?id=','HTTP\x20','currency','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','transaction_id','Unknown\x20error','Failed\x20to\x20parse\x20JSON\x20response:','padStart','findFirst','confirmed','Status:','Raw\x20Response\x20Body:','default','klyme_','__esModule','Error\x20Message:','get','Payment\x20System/1.0','Unsupported\x20KLYME\x20region:\x20',',\x20body:\x20','payment_method','now','logWhiteDomainResponse','8164647UZruwl','toString','amount','EUR','8RmbLWM','log','\x20(8digits-8digits\x20format\x20for\x20','uuid','https://tesoft.uk/gateway/klyme/','(validated\x20for\x20','region','Response\x20Time:','\x20API\x20error:\x20','112GdHCGd','timeout','text','\x20payment\x20link:\x20','/verify/'];a67_0x48e0=function(){return _0x1af479;};return a67_0x48e0();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a67_0x181b6f(0x19a)]=void 0x0;const loggerService_1=require('../loggerService');class KlymeService{constructor(){const _0x49a7ce=a67_0x181b6f;this[_0x49a7ce(0x1a6)]=_0x49a7ce(0x17e),console['log'](_0x49a7ce(0x1ba));}[a67_0x181b6f(0x1bb)](_0x4a2388,_0xc163){const _0x4b68f8=a67_0x181b6f,_0x11d675=_0x4a2388['toUpperCase']();switch(_0xc163){case'EU':if(_0x11d675!=='EUR')throw new Error(_0x4b68f8(0x1c6)+_0x11d675);break;case'GB':if(_0x11d675!=='GBP')throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x11d675);break;case'DE':if(_0x11d675!==_0x4b68f8(0x179))throw new Error(_0x4b68f8(0x1f5)+_0x11d675);break;default:throw new Error(_0x4b68f8(0x171)+_0xc163);}}async['generateUniqueReference'](){const _0x24c207=a67_0x181b6f,_0x178dfd=(await Promise[_0x24c207(0x1c5)]()[_0x24c207(0x1f0)](()=>__importStar(require(_0x24c207(0x1e8)))))[_0x24c207(0x16b)];let _0x3108f3,_0x205e77=0x0;const _0x47dc73=0xa;do{const _0x29bbdc=()=>{const _0x438f77=_0x24c207;return Math[_0x438f77(0x1e7)](Math[_0x438f77(0x1c4)]()*0x5f5e100)[_0x438f77(0x177)]()[_0x438f77(0x166)](0x8,'0');};_0x3108f3=_0x29bbdc()+'-'+_0x29bbdc();const _0xf2526a=await _0x178dfd[_0x24c207(0x1d0)][_0x24c207(0x167)]({'where':{'gatewayOrderId':_0x3108f3}});if(!_0xf2526a)break;_0x205e77++,console[_0x24c207(0x17b)](_0x24c207(0x1b3)+_0x3108f3+_0x24c207(0x19d)+_0x205e77+')');}while(_0x205e77<_0x47dc73);if(_0x205e77>=_0x47dc73)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x3108f3;}async['createPaymentLink'](_0x3d5fc4){const _0x428702=a67_0x181b6f,{orderId:_0xd93e93,amount:_0x4ff010,currency:_0x22c908,region:_0x391280}=_0x3d5fc4;if(_0x391280!=='EU'&&_0x391280!=='GB'&&_0x391280!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x391280);this[_0x428702(0x1bb)](_0x22c908,_0x391280);const _0xc2d1cb=_0x22c908['toUpperCase']();console[_0x428702(0x17b)](_0x428702(0x1a2)+_0x391280+_0x428702(0x1b5)+_0xc2d1cb);const _0x4f9a95=await this[_0x428702(0x1b6)]();console[_0x428702(0x17b)](_0x428702(0x1de)+_0x4f9a95+_0x428702(0x17c)+_0x391280+')');const _0x488ae5=_0x428702(0x1f6)+_0xd93e93,_0x54b5c2={'amount':_0x4ff010,'currency':_0xc2d1cb,'redirectUrl':_0x488ae5,'reference':_0x4f9a95,'geo':_0x391280},_0x150846=Date[_0x428702(0x174)]();try{console[_0x428702(0x17b)](_0x428702(0x1b2)+_0x391280+_0x428702(0x1bd)),console['log'](_0x428702(0x1d8),this[_0x428702(0x1a6)]),console[_0x428702(0x17b)]('Request\x20Body:',JSON[_0x428702(0x18b)](_0x54b5c2,null,0x2)),console[_0x428702(0x17b)](_0x428702(0x18f),_0x391280),console[_0x428702(0x17b)](_0x428702(0x1d3),_0xc2d1cb,_0x428702(0x17f)+_0x391280+')'),console[_0x428702(0x17b)](_0x428702(0x18c),_0x4f9a95,_0x428702(0x1b0)),console[_0x428702(0x17b)](_0x428702(0x194),_0x488ae5),loggerService_1['loggerService'][_0x428702(0x19e)](_0x428702(0x16c)+_0x391280[_0x428702(0x1da)](),_0x428702(0x18a),'POST',_0x54b5c2);const _0x9b80d3=await fetch(this['apiUrl'],{'method':_0x428702(0x1b1),'headers':{'Content-Type':'application/json','Accept':_0x428702(0x1a1),'User-Agent':_0x428702(0x170)},'body':JSON[_0x428702(0x18b)](_0x54b5c2)}),_0x3268c5=Date[_0x428702(0x174)]()-_0x150846;console['log'](_0x428702(0x1b2)+_0x391280+'\x20API\x20RESPONSE\x20(Unified\x20Route)\x20==='),console[_0x428702(0x17b)](_0x428702(0x169),_0x9b80d3[_0x428702(0x1c2)]),console[_0x428702(0x17b)](_0x428702(0x1e2),_0x9b80d3[_0x428702(0x1cf)]),console[_0x428702(0x17b)](_0x428702(0x1ad),Object['fromEntries'](_0x9b80d3[_0x428702(0x1c1)]['entries']())),console['log'](_0x428702(0x181),_0x3268c5+'ms');const _0x5c06b4=await _0x9b80d3[_0x428702(0x185)]();console[_0x428702(0x17b)](_0x428702(0x16a),_0x5c06b4);if(!_0x9b80d3['ok']){console[_0x428702(0x1db)]('===\x20KLYME\x20'+_0x391280+'\x20API\x20ERROR\x20==='),console[_0x428702(0x1db)](_0x428702(0x196),_0x9b80d3['status']),console[_0x428702(0x1db)](_0x428702(0x1e6),_0x5c06b4),loggerService_1['loggerService'][_0x428702(0x175)](_0x428702(0x16c)+_0x391280[_0x428702(0x1da)](),_0x428702(0x18a),_0x9b80d3[_0x428702(0x1c2)],_0x5c06b4,_0x3268c5),loggerService_1[_0x428702(0x19b)][_0x428702(0x1a7)](_0x428702(0x16c)+_0x391280['toLowerCase'](),_0x428702(0x18a),_0x428702(0x1f7)+_0x9b80d3[_0x428702(0x1c2)]+':\x20'+_0x5c06b4);throw new Error('HTTP\x20error!\x20status:\x20'+_0x9b80d3[_0x428702(0x1c2)]+_0x428702(0x172)+_0x5c06b4);}let _0x35f5e2;try{_0x35f5e2=JSON[_0x428702(0x1bf)](_0x5c06b4);}catch(_0x199fa0){console[_0x428702(0x1db)](_0x428702(0x165),_0x199fa0),loggerService_1['loggerService'][_0x428702(0x1a7)](_0x428702(0x16c)+_0x391280[_0x428702(0x1da)](),_0x428702(0x18a),_0x428702(0x197)+_0x199fa0);throw new Error(_0x428702(0x1f9)+_0x391280+_0x428702(0x1b8)+_0x5c06b4);}console[_0x428702(0x17b)](_0x428702(0x199)+_0x391280+_0x428702(0x1e0)),console[_0x428702(0x17b)](_0x428702(0x1a9),JSON['stringify'](_0x35f5e2,null,0x2)),loggerService_1[_0x428702(0x19b)][_0x428702(0x175)](_0x428702(0x16c)+_0x391280[_0x428702(0x1da)](),_0x428702(0x18a),_0x9b80d3['status'],_0x35f5e2,_0x3268c5);if(_0x35f5e2[_0x428702(0x1db)]||_0x35f5e2[_0x428702(0x1f3)]){const _0x17633b=_0x35f5e2[_0x428702(0x1dd)]||_0x35f5e2[_0x428702(0x1db)]||_0x428702(0x1aa)+_0x391280+_0x428702(0x1df);console[_0x428702(0x1db)](_0x428702(0x1b2)+_0x391280+_0x428702(0x1c8)),console[_0x428702(0x1db)](_0x428702(0x16e),_0x17633b),console['error']('Status\x20Code:',_0x35f5e2[_0x428702(0x1f3)]),loggerService_1[_0x428702(0x19b)][_0x428702(0x1a7)]('klyme_'+_0x391280[_0x428702(0x1da)](),_0x428702(0x18a),_0x428702(0x1ae)+_0x17633b);throw new Error('KLYME\x20'+_0x391280+'\x20API\x20error:\x20'+_0x17633b);}let _0x303304,_0x2a7f1d;if(_0x35f5e2['uuid']&&_0x35f5e2[_0x428702(0x1ec)])_0x303304=_0x35f5e2[_0x428702(0x17d)],_0x2a7f1d=_0x35f5e2[_0x428702(0x1ec)],console['log'](_0x428702(0x1b2)+_0x391280+_0x428702(0x19c)),console[_0x428702(0x17b)](_0x428702(0x1ea),_0x35f5e2[_0x428702(0x17d)]),console['log'](_0x428702(0x194),_0x35f5e2[_0x428702(0x1ec)]);else{if(_0x35f5e2[_0x428702(0x1a8)])_0x303304=_0x4f9a95,_0x2a7f1d=_0x35f5e2[_0x428702(0x1a8)],console['log']('===\x20KLYME\x20'+_0x391280+_0x428702(0x18e)),console['log']('Auth\x20URL:',_0x35f5e2[_0x428702(0x1a8)]),console['log']('Reference\x20Used\x20as\x20ID:',_0x4f9a95);else{console[_0x428702(0x1db)]('===\x20KLYME\x20'+_0x391280+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x428702(0x1db)](_0x428702(0x1a5)),console[_0x428702(0x1db)](_0x428702(0x1cc),_0x35f5e2),loggerService_1[_0x428702(0x19b)][_0x428702(0x1a7)](_0x428702(0x16c)+_0x391280[_0x428702(0x1da)](),'/create',_0x428702(0x192));throw new Error(_0x428702(0x1ab)+_0x391280+_0x428702(0x1e9));}}return console['log'](_0x428702(0x1b9),_0xc2d1cb,'('+_0x391280+'\x20validated)'),console[_0x428702(0x17b)](_0x428702(0x19f),_0x4f9a95,_0x428702(0x1b0)),console['log'](_0x428702(0x1a3),_0x391280),{'gateway_payment_id':_0x303304,'payment_url':_0x2a7f1d};}catch(_0x4f1289){console['error'](_0x428702(0x1b2)+_0x391280+'\x20SERVICE\x20ERROR\x20==='),console[_0x428702(0x1db)](_0x428702(0x1d7),_0x4f1289),loggerService_1[_0x428702(0x19b)][_0x428702(0x1a7)](_0x428702(0x16c)+_0x391280['toLowerCase'](),_0x428702(0x18a),_0x4f1289);if(_0x4f1289 instanceof Error){console[_0x428702(0x1db)](_0x428702(0x1c9),_0x4f1289[_0x428702(0x1dd)]),console['error'](_0x428702(0x1ce),_0x4f1289[_0x428702(0x1e5)]);throw new Error(_0x428702(0x1b7)+_0x391280+_0x428702(0x186)+_0x4f1289[_0x428702(0x1dd)]);}throw new Error(_0x428702(0x1b7)+_0x391280+'\x20payment\x20link:\x20Unknown\x20error');}}async['verifyPayment'](_0x3110c3,_0x542515){const _0x59d410=a67_0x181b6f,_0x23cffa=Date['now']();try{const _0x40e286={'gatewayPaymentId':_0x3110c3,'geo':_0x542515};loggerService_1[_0x59d410(0x19b)]['logWhiteDomainRequest'](_0x59d410(0x16c)+_0x542515[_0x59d410(0x1da)](),'/verify/'+_0x3110c3,_0x59d410(0x1b1),_0x40e286);const _0x1f382a=await fetch(this[_0x59d410(0x1a6)],{'method':_0x59d410(0x1b1),'headers':{'Content-Type':_0x59d410(0x1a1),'User-Agent':'Payment\x20System/1.0'},'body':JSON[_0x59d410(0x18b)](_0x40e286)}),_0x805ce8=Date[_0x59d410(0x174)]()-_0x23cffa;if(!_0x1f382a['ok']){const _0x319862=await _0x1f382a[_0x59d410(0x185)]();loggerService_1['loggerService'][_0x59d410(0x175)]('klyme_'+_0x542515['toLowerCase'](),'/verify/'+_0x3110c3,_0x1f382a[_0x59d410(0x1c2)],_0x319862,_0x805ce8);throw new Error(_0x59d410(0x1f1)+_0x1f382a['status']);}const _0x11b3f2=await _0x1f382a[_0x59d410(0x1e1)]();loggerService_1[_0x59d410(0x19b)][_0x59d410(0x175)]('klyme_'+_0x542515[_0x59d410(0x1da)](),_0x59d410(0x187)+_0x3110c3,_0x1f382a[_0x59d410(0x1c2)],_0x11b3f2,_0x805ce8);if(_0x11b3f2[_0x59d410(0x1db)]||_0x11b3f2[_0x59d410(0x1f3)]){loggerService_1[_0x59d410(0x19b)][_0x59d410(0x1a7)](_0x59d410(0x16c)+_0x542515[_0x59d410(0x1da)](),_0x59d410(0x187)+_0x3110c3,_0x59d410(0x1cb)+_0x542515+_0x59d410(0x182)+(_0x11b3f2[_0x59d410(0x1dd)]||_0x11b3f2['error']||_0x59d410(0x1fb)));throw new Error('KLYME\x20'+_0x542515+_0x59d410(0x182)+(_0x11b3f2[_0x59d410(0x1dd)]||_0x11b3f2['error']||_0x59d410(0x1fb)));}let _0x54181e=_0x59d410(0x1d5);return{'status':_0x54181e};}catch(_0x1697f4){console[_0x59d410(0x1db)](_0x59d410(0x1cb)+_0x542515+_0x59d410(0x1bc),_0x1697f4),loggerService_1[_0x59d410(0x19b)]['logWhiteDomainError']('klyme_'+_0x542515['toLowerCase'](),_0x59d410(0x187)+_0x3110c3,_0x1697f4);throw new Error(_0x59d410(0x1a0)+_0x542515+_0x59d410(0x1f2)+(_0x1697f4 instanceof Error?_0x1697f4[_0x59d410(0x1dd)]:_0x59d410(0x1fb)));}}async[a67_0x181b6f(0x1f4)](_0x49bb58){const _0xb4b256=a67_0x181b6f;console['log'](_0xb4b256(0x1d2),_0x49bb58);let _0x42ec89=_0xb4b256(0x1d5);switch(_0x49bb58[_0xb4b256(0x1c2)]?.[_0xb4b256(0x1da)]()){case _0xb4b256(0x1ee):case'completed':case _0xb4b256(0x168):case'success':case _0xb4b256(0x188):_0x42ec89=_0xb4b256(0x191);break;case'cancelled':case _0xb4b256(0x1af):case _0xb4b256(0x1ef):case'error':case _0xb4b256(0x1e3):_0x42ec89=_0xb4b256(0x1b4);break;case'expired':case _0xb4b256(0x184):_0x42ec89='EXPIRED';break;case _0xb4b256(0x1cd):case'created':case'active':case'processing':case _0xb4b256(0x18d):default:_0x42ec89=_0xb4b256(0x1d5);break;}return{'paymentId':_0x49bb58[_0xb4b256(0x195)]||_0x49bb58[_0xb4b256(0x198)]||_0x49bb58[_0xb4b256(0x1ca)],'status':_0x42ec89,'amount':_0x49bb58[_0xb4b256(0x178)],'currency':_0x49bb58[_0xb4b256(0x1f8)],'region':_0x49bb58[_0xb4b256(0x180)],'additionalInfo':{'payment_method':_0x49bb58[_0xb4b256(0x173)],'transaction_id':_0x49bb58[_0xb4b256(0x1fa)]}};}}exports[a67_0x181b6f(0x19a)]=KlymeService;