'use strict';const a41_0xea04dd=a41_0x5d55;(function(_0x795249,_0x688e8){const _0x53461a=a41_0x5d55,_0x2d44a7=_0x795249();while(!![]){try{const _0x24851a=-parseInt(_0x53461a(0x1a1))/0x1*(parseInt(_0x53461a(0x15b))/0x2)+parseInt(_0x53461a(0x14e))/0x3+parseInt(_0x53461a(0x1d5))/0x4+-parseInt(_0x53461a(0x181))/0x5+parseInt(_0x53461a(0x1b8))/0x6+-parseInt(_0x53461a(0x177))/0x7+parseInt(_0x53461a(0x1c7))/0x8;if(_0x24851a===_0x688e8)break;else _0x2d44a7['push'](_0x2d44a7['shift']());}catch(_0xb9ee2c){_0x2d44a7['push'](_0x2d44a7['shift']());}}}(a41_0x2c7b,0xe6ad3));var __createBinding=this&&this[a41_0xea04dd(0x19a)]||(Object[a41_0xea04dd(0x1b4)]?function(_0x4f002b,_0x502c5c,_0x276d82,_0x2e7dc1){const _0x4dff83=a41_0xea04dd;if(_0x2e7dc1===undefined)_0x2e7dc1=_0x276d82;var _0x56378f=Object[_0x4dff83(0x176)](_0x502c5c,_0x276d82);(!_0x56378f||(_0x4dff83(0x14f)in _0x56378f?!_0x502c5c[_0x4dff83(0x1a3)]:_0x56378f[_0x4dff83(0x1d1)]||_0x56378f[_0x4dff83(0x1ab)]))&&(_0x56378f={'enumerable':!![],'get':function(){return _0x502c5c[_0x276d82];}}),Object['defineProperty'](_0x4f002b,_0x2e7dc1,_0x56378f);}:function(_0x4affc7,_0x3fada6,_0x164aff,_0x3d77f8){if(_0x3d77f8===undefined)_0x3d77f8=_0x164aff;_0x4affc7[_0x3d77f8]=_0x3fada6[_0x164aff];}),__setModuleDefault=this&&this[a41_0xea04dd(0x16f)]||(Object[a41_0xea04dd(0x1b4)]?function(_0x20a557,_0x3cae02){const _0x250fb3=a41_0xea04dd;Object[_0x250fb3(0x171)](_0x20a557,'default',{'enumerable':!![],'value':_0x3cae02});}:function(_0x53fc87,_0x65fcd4){const _0x444074=a41_0xea04dd;_0x53fc87[_0x444074(0x1c3)]=_0x65fcd4;}),__importStar=this&&this[a41_0xea04dd(0x1c2)]||(function(){var _0x182d5a=function(_0x5ed5ac){const _0x3a3d72=a41_0x5d55;return _0x182d5a=Object[_0x3a3d72(0x1cc)]||function(_0x2074ff){const _0x161b3d=_0x3a3d72;var _0x166411=[];for(var _0x4ade29 in _0x2074ff)if(Object[_0x161b3d(0x14d)]['hasOwnProperty'][_0x161b3d(0x1c8)](_0x2074ff,_0x4ade29))_0x166411[_0x166411[_0x161b3d(0x1d3)]]=_0x4ade29;return _0x166411;},_0x182d5a(_0x5ed5ac);};return function(_0x405a95){const _0x43cb61=a41_0x5d55;if(_0x405a95&&_0x405a95['__esModule'])return _0x405a95;var _0x559cba={};if(_0x405a95!=null){for(var _0x4798cf=_0x182d5a(_0x405a95),_0x3ccdec=0x0;_0x3ccdec<_0x4798cf['length'];_0x3ccdec++)if(_0x4798cf[_0x3ccdec]!==_0x43cb61(0x1c3))__createBinding(_0x559cba,_0x405a95,_0x4798cf[_0x3ccdec]);}return __setModuleDefault(_0x559cba,_0x405a95),_0x559cba;};}());Object['defineProperty'](exports,a41_0xea04dd(0x1a3),{'value':!![]}),exports[a41_0xea04dd(0x152)]=void 0x0;const loggerService_1=require(a41_0xea04dd(0x1c4));class KlymeService{constructor(){const _0x2fb8bd=a41_0xea04dd;this[_0x2fb8bd(0x1cd)]=_0x2fb8bd(0x159),console[_0x2fb8bd(0x166)](_0x2fb8bd(0x1a2));}[a41_0xea04dd(0x1af)](_0x4ca2d5,_0x4b53c9){const _0x1cf65d=a41_0xea04dd,_0x5a1e6a=_0x4ca2d5['toUpperCase']();switch(_0x4b53c9){case'EU':if(_0x5a1e6a!=='EUR')throw new Error(_0x1cf65d(0x165)+_0x5a1e6a);break;case'GB':if(_0x5a1e6a!=='GBP')throw new Error(_0x1cf65d(0x1ac)+_0x5a1e6a);break;case'DE':if(_0x5a1e6a!==_0x1cf65d(0x190))throw new Error(_0x1cf65d(0x1a0)+_0x5a1e6a);break;default:throw new Error(_0x1cf65d(0x1c9)+_0x4b53c9);}}async[a41_0xea04dd(0x193)](){const _0x64e67e=a41_0xea04dd,_0x1bb6ef=(await Promise[_0x64e67e(0x1a9)]()['then'](()=>__importStar(require(_0x64e67e(0x14c)))))[_0x64e67e(0x1c3)];let _0x349508,_0x40d1ba=0x0;const _0x1546b9=0xa;do{const _0x4ae978=()=>{const _0x43eb34=_0x64e67e;return Math['floor'](Math['random']()*0x5f5e100)[_0x43eb34(0x1ce)]()['padStart'](0x8,'0');};_0x349508=_0x4ae978()+'-'+_0x4ae978();const _0x390e2e=await _0x1bb6ef[_0x64e67e(0x195)]['findFirst']({'where':{'gatewayOrderId':_0x349508}});if(!_0x390e2e)break;_0x40d1ba++,console[_0x64e67e(0x166)](_0x64e67e(0x179)+_0x349508+_0x64e67e(0x1a7)+_0x40d1ba+')');}while(_0x40d1ba<_0x1546b9);if(_0x40d1ba>=_0x1546b9)throw new Error(_0x64e67e(0x157));return _0x349508;}async['createPaymentLink'](_0x43f243){const _0x578625=a41_0xea04dd,{orderId:_0x49f6a9,amount:_0x348f35,currency:_0x133de3,region:_0x3e3050}=_0x43f243;if(_0x3e3050!=='EU'&&_0x3e3050!=='GB'&&_0x3e3050!=='DE')throw new Error(_0x578625(0x17e)+_0x3e3050);this['validateCurrencyForRegion'](_0x133de3,_0x3e3050);const _0x26c04f=_0x133de3[_0x578625(0x158)]();console[_0x578625(0x166)](_0x578625(0x16d)+_0x3e3050+_0x578625(0x148)+_0x26c04f);const _0xee3880=await this['generateUniqueReference']();console[_0x578625(0x166)](_0x578625(0x144)+_0xee3880+_0x578625(0x15e)+_0x3e3050+')');const _0x56ab30=_0x578625(0x1a5)+_0x49f6a9,_0xc62e52={'amount':_0x348f35,'currency':_0x26c04f,'redirectUrl':_0x56ab30,'reference':_0xee3880,'geo':_0x3e3050},_0xe5d130=Date[_0x578625(0x14a)]();try{console[_0x578625(0x166)](_0x578625(0x154)+_0x3e3050+_0x578625(0x145)),console[_0x578625(0x166)](_0x578625(0x155),this[_0x578625(0x1cd)]),console[_0x578625(0x166)](_0x578625(0x17b),JSON['stringify'](_0xc62e52,null,0x2)),console['log']('Region\x20(geo):',_0x3e3050),console[_0x578625(0x166)](_0x578625(0x19e),_0x26c04f,_0x578625(0x18f)+_0x3e3050+')'),console[_0x578625(0x166)](_0x578625(0x198),_0xee3880,'(8digits-8digits\x20format)'),console[_0x578625(0x166)]('Redirect\x20URL:',_0x56ab30),loggerService_1['loggerService'][_0x578625(0x19d)](_0x578625(0x15f)+_0x3e3050[_0x578625(0x1aa)](),_0x578625(0x174),'POST',_0xc62e52);const _0x17a403=await fetch(this[_0x578625(0x1cd)],{'method':_0x578625(0x1c5),'headers':{'Content-Type':_0x578625(0x1a8),'Accept':_0x578625(0x1a8),'User-Agent':_0x578625(0x189)},'body':JSON[_0x578625(0x18b)](_0xc62e52)}),_0x5f80f4=Date[_0x578625(0x14a)]()-_0xe5d130;console['log']('===\x20KLYME\x20'+_0x3e3050+_0x578625(0x1b0)),console[_0x578625(0x166)](_0x578625(0x17f),_0x17a403[_0x578625(0x1bc)]),console['log'](_0x578625(0x170),_0x17a403[_0x578625(0x17c)]),console[_0x578625(0x166)](_0x578625(0x1b5),Object[_0x578625(0x161)](_0x17a403[_0x578625(0x1ca)]['entries']())),console['log'](_0x578625(0x192),_0x5f80f4+'ms');const _0x551de8=await _0x17a403[_0x578625(0x15c)]();console[_0x578625(0x166)]('Raw\x20Response\x20Body:',_0x551de8);if(!_0x17a403['ok']){console[_0x578625(0x16b)](_0x578625(0x154)+_0x3e3050+_0x578625(0x187)),console['error'](_0x578625(0x169),_0x17a403[_0x578625(0x1bc)]),console['error']('Response\x20Body:',_0x551de8),loggerService_1['loggerService'][_0x578625(0x173)](_0x578625(0x15f)+_0x3e3050[_0x578625(0x1aa)](),_0x578625(0x174),_0x17a403[_0x578625(0x1bc)],_0x551de8,_0x5f80f4),loggerService_1['loggerService'][_0x578625(0x1d2)](_0x578625(0x15f)+_0x3e3050['toLowerCase'](),_0x578625(0x174),_0x578625(0x146)+_0x17a403['status']+':\x20'+_0x551de8);throw new Error(_0x578625(0x18d)+_0x17a403[_0x578625(0x1bc)]+_0x578625(0x1ba)+_0x551de8);}let _0x26b544;try{_0x26b544=JSON[_0x578625(0x172)](_0x551de8);}catch(_0x35ae52){console['error'](_0x578625(0x16c),_0x35ae52),loggerService_1[_0x578625(0x1b3)][_0x578625(0x1d2)](_0x578625(0x15f)+_0x3e3050[_0x578625(0x1aa)](),_0x578625(0x174),_0x578625(0x149)+_0x35ae52);throw new Error(_0x578625(0x1b2)+_0x3e3050+'\x20API:\x20'+_0x551de8);}console[_0x578625(0x166)](_0x578625(0x185)+_0x3e3050+_0x578625(0x1d4)),console[_0x578625(0x166)]('Parsed\x20Result:',JSON[_0x578625(0x18b)](_0x26b544,null,0x2)),loggerService_1['loggerService'][_0x578625(0x173)](_0x578625(0x15f)+_0x3e3050[_0x578625(0x1aa)](),_0x578625(0x174),_0x17a403[_0x578625(0x1bc)],_0x26b544,_0x5f80f4);if(_0x26b544[_0x578625(0x16b)]||_0x26b544[_0x578625(0x191)]){const _0x428095=_0x26b544['message']||_0x26b544[_0x578625(0x16b)]||_0x578625(0x19b)+_0x3e3050+'\x20API';console['error'](_0x578625(0x154)+_0x3e3050+_0x578625(0x1ad)),console[_0x578625(0x16b)](_0x578625(0x1be),_0x428095),console['error']('Status\x20Code:',_0x26b544[_0x578625(0x191)]),loggerService_1[_0x578625(0x1b3)]['logWhiteDomainError'](_0x578625(0x15f)+_0x3e3050[_0x578625(0x1aa)](),_0x578625(0x174),'Business\x20Error:\x20'+_0x428095);throw new Error(_0x578625(0x168)+_0x3e3050+'\x20API\x20error:\x20'+_0x428095);}let _0x464012,_0x3b3070;if(_0x26b544[_0x578625(0x18a)]&&_0x26b544['redirect_url'])_0x464012=_0x26b544[_0x578625(0x18a)],_0x3b3070=_0x26b544[_0x578625(0x1c0)],console[_0x578625(0x166)](_0x578625(0x154)+_0x3e3050+_0x578625(0x1cb)),console[_0x578625(0x166)](_0x578625(0x194),_0x26b544[_0x578625(0x18a)]),console[_0x578625(0x166)](_0x578625(0x178),_0x26b544[_0x578625(0x1c0)]);else{if(_0x26b544[_0x578625(0x1c1)])_0x464012=_0xee3880,_0x3b3070=_0x26b544[_0x578625(0x1c1)],console[_0x578625(0x166)](_0x578625(0x154)+_0x3e3050+_0x578625(0x1b1)),console[_0x578625(0x166)]('Auth\x20URL:',_0x26b544['authUrl']),console[_0x578625(0x166)](_0x578625(0x186),_0xee3880);else{console[_0x578625(0x16b)](_0x578625(0x154)+_0x3e3050+_0x578625(0x162)),console['error']('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console[_0x578625(0x16b)](_0x578625(0x1a4),_0x26b544),loggerService_1[_0x578625(0x1b3)][_0x578625(0x1d2)](_0x578625(0x15f)+_0x3e3050[_0x578625(0x1aa)](),_0x578625(0x174),'Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl');throw new Error(_0x578625(0x147)+_0x3e3050+_0x578625(0x1b9));}}return console[_0x578625(0x166)](_0x578625(0x180),_0x26c04f,'('+_0x3e3050+_0x578625(0x16a)),console[_0x578625(0x166)](_0x578625(0x197),_0xee3880,'(8digits-8digits\x20format)'),console[_0x578625(0x166)]('Geo\x20Parameter:',_0x3e3050),{'gateway_payment_id':_0x464012,'payment_url':_0x3b3070};}catch(_0x28937c){console['error'](_0x578625(0x154)+_0x3e3050+_0x578625(0x153)),console[_0x578625(0x16b)](_0x578625(0x17d),_0x28937c),loggerService_1['loggerService'][_0x578625(0x1d2)]('klyme_'+_0x3e3050[_0x578625(0x1aa)](),_0x578625(0x174),_0x28937c);if(_0x28937c instanceof Error){console[_0x578625(0x16b)](_0x578625(0x167),_0x28937c[_0x578625(0x182)]),console[_0x578625(0x16b)](_0x578625(0x1cf),_0x28937c[_0x578625(0x14b)]);throw new Error(_0x578625(0x19c)+_0x3e3050+_0x578625(0x184)+_0x28937c['message']);}throw new Error(_0x578625(0x19c)+_0x3e3050+_0x578625(0x160));}}async[a41_0xea04dd(0x163)](_0x205cb3,_0x2fdc9f){const _0x55ea91=a41_0xea04dd,_0x214d09=Date['now']();try{const _0x11d3bc={'gatewayPaymentId':_0x205cb3,'geo':_0x2fdc9f};loggerService_1[_0x55ea91(0x1b3)][_0x55ea91(0x19d)](_0x55ea91(0x15f)+_0x2fdc9f[_0x55ea91(0x1aa)](),_0x55ea91(0x151)+_0x205cb3,_0x55ea91(0x1c5),_0x11d3bc);const _0xe49d9a=await fetch(this[_0x55ea91(0x1cd)],{'method':_0x55ea91(0x1c5),'headers':{'Content-Type':_0x55ea91(0x1a8),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x55ea91(0x18b)](_0x11d3bc)}),_0x19cbed=Date[_0x55ea91(0x14a)]()-_0x214d09;if(!_0xe49d9a['ok']){const _0xec1a7=await _0xe49d9a[_0x55ea91(0x15c)]();loggerService_1['loggerService'][_0x55ea91(0x173)](_0x55ea91(0x15f)+_0x2fdc9f['toLowerCase'](),'/verify/'+_0x205cb3,_0xe49d9a[_0x55ea91(0x1bc)],_0xec1a7,_0x19cbed);throw new Error('HTTP\x20error!\x20status:\x20'+_0xe49d9a['status']);}const _0x27f18a=await _0xe49d9a[_0x55ea91(0x183)]();loggerService_1[_0x55ea91(0x1b3)]['logWhiteDomainResponse'](_0x55ea91(0x15f)+_0x2fdc9f[_0x55ea91(0x1aa)](),_0x55ea91(0x151)+_0x205cb3,_0xe49d9a[_0x55ea91(0x1bc)],_0x27f18a,_0x19cbed);if(_0x27f18a[_0x55ea91(0x16b)]||_0x27f18a[_0x55ea91(0x191)]){loggerService_1[_0x55ea91(0x1b3)][_0x55ea91(0x1d2)](_0x55ea91(0x15f)+_0x2fdc9f[_0x55ea91(0x1aa)](),'/verify/'+_0x205cb3,_0x55ea91(0x168)+_0x2fdc9f+_0x55ea91(0x1bb)+(_0x27f18a[_0x55ea91(0x182)]||_0x27f18a[_0x55ea91(0x16b)]||_0x55ea91(0x1bf)));throw new Error(_0x55ea91(0x168)+_0x2fdc9f+_0x55ea91(0x1bb)+(_0x27f18a[_0x55ea91(0x182)]||_0x27f18a[_0x55ea91(0x16b)]||_0x55ea91(0x1bf)));}let _0x25f9f3='PENDING';return{'status':_0x25f9f3};}catch(_0x1cf01b){console[_0x55ea91(0x16b)](_0x55ea91(0x168)+_0x2fdc9f+_0x55ea91(0x15a),_0x1cf01b),loggerService_1[_0x55ea91(0x1b3)][_0x55ea91(0x1d2)](_0x55ea91(0x15f)+_0x2fdc9f['toLowerCase'](),'/verify/'+_0x205cb3,_0x1cf01b);throw new Error(_0x55ea91(0x150)+_0x2fdc9f+_0x55ea91(0x199)+(_0x1cf01b instanceof Error?_0x1cf01b['message']:_0x55ea91(0x1bf)));}}async[a41_0xea04dd(0x1d6)](_0x44d579){const _0x57b25d=a41_0xea04dd;console[_0x57b25d(0x166)]('Processing\x20KLYME\x20webhook:',_0x44d579);let _0x20b2a8=_0x57b25d(0x15d);switch(_0x44d579[_0x57b25d(0x1bc)]?.[_0x57b25d(0x1aa)]()){case'paid':case _0x57b25d(0x188):case _0x57b25d(0x19f):case'success':case'successful':_0x20b2a8=_0x57b25d(0x164);break;case _0x57b25d(0x1ae):case'canceled':case _0x57b25d(0x17a):case _0x57b25d(0x16b):case _0x57b25d(0x1b6):_0x20b2a8='FAILED';break;case _0x57b25d(0x156):case'timeout':_0x20b2a8=_0x57b25d(0x1b7);break;case _0x57b25d(0x16e):case _0x57b25d(0x1a6):case _0x57b25d(0x18e):case _0x57b25d(0x1c6):case _0x57b25d(0x196):default:_0x20b2a8=_0x57b25d(0x15d);break;}return{'paymentId':_0x44d579['reference']||_0x44d579[_0x57b25d(0x1d0)]||_0x44d579[_0x57b25d(0x143)],'status':_0x20b2a8,'amount':_0x44d579[_0x57b25d(0x1bd)],'currency':_0x44d579[_0x57b25d(0x18c)],'region':_0x44d579['region'],'additionalInfo':{'payment_method':_0x44d579[_0x57b25d(0x175)],'transaction_id':_0x44d579['transaction_id']}};}}function a41_0x5d55(_0x197c6c,_0xd734b2){const _0x2c7bd4=a41_0x2c7b();return a41_0x5d55=function(_0x5d55d7,_0x30f65c){_0x5d55d7=_0x5d55d7-0x143;let _0x4ab91a=_0x2c7bd4[_0x5d55d7];return _0x4ab91a;},a41_0x5d55(_0x197c6c,_0xd734b2);}function a41_0x2c7b(){const _0x56cd13=['default','../loggerService','POST','processing','28165912YMianh','call','Unsupported\x20KLYME\x20region:\x20','headers','\x20SUCCESS\x20(New\x20Format)\x20===','getOwnPropertyNames','apiUrl','toString','Error\x20stack:','order_id','writable','logWhiteDomainError','length','\x20RESPONSE\x20===','292480cRmDAg','processWebhook','payment_id','🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','HTTP\x20','Invalid\x20response\x20from\x20KLYME\x20','\x20currency\x20validation\x20passed:\x20','JSON\x20Parse\x20Error:\x20','now','stack','../../config/database','prototype','2336859dtHiXz','get','Failed\x20to\x20verify\x20KLYME\x20','/verify/','KlymeService','\x20SERVICE\x20ERROR\x20===','===\x20KLYME\x20','URL:','expired','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','toUpperCase','https://tesoft.uk/gateway/klyme/','\x20payment\x20verification\x20error:','1766614UYkZDt','text','PENDING','\x20(8digits-8digits\x20format\x20for\x20','klyme_','\x20payment\x20link:\x20Unknown\x20error','fromEntries','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','verifyPayment','PAID','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','log','Error\x20message:','KLYME\x20','HTTP\x20Status:','\x20validated)','error','Failed\x20to\x20parse\x20JSON\x20response:','💳\x20KLYME\x20','pending','__setModuleDefault','Status\x20Text:','defineProperty','parse','logWhiteDomainResponse','/create','payment_method','getOwnPropertyDescriptor','8487591vHvFCi','Redirect\x20URL:','⚠️\x20KLYME\x20reference\x20','failed','Request\x20Body:','statusText','Error\x20details:','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','Status:','Currency\x20Used:','8068660iBrdnR','message','json','\x20payment\x20link:\x20','===\x20PARSED\x20KLYME\x20','Reference\x20Used\x20as\x20ID:','\x20API\x20ERROR\x20===','completed','TesSoft\x20Payment\x20System/1.0','uuid','stringify','currency','HTTP\x20error!\x20status:\x20','active','(validated\x20for\x20','EUR','statusCode','Response\x20Time:','generateUniqueReference','UUID:','payment','in_progress','Reference\x20Used:','Reference:','\x20payment:\x20','__createBinding','Unknown\x20error\x20from\x20KLYME\x20','Failed\x20to\x20create\x20KLYME\x20','logWhiteDomainRequest','Currency:','confirmed','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','2ETyqrv','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','__esModule','Response\x20data:','https://tesoft.uk/gateway/pending.php?id=','created','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','application/json','resolve','toLowerCase','configurable','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','\x20API\x20BUSINESS\x20ERROR\x20===','cancelled','validateCurrencyForRegion','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','\x20SUCCESS\x20(Legacy\x20Format)\x20===','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','loggerService','create','Headers:','rejected','EXPIRED','6989388rNlJfA','\x20API:\x20missing\x20payment\x20data',',\x20body:\x20','\x20API\x20error:\x20','status','amount','Error\x20Message:','Unknown\x20error','redirect_url','authUrl','__importStar'];a41_0x2c7b=function(){return _0x56cd13;};return a41_0x2c7b();}exports[a41_0xea04dd(0x152)]=KlymeService;