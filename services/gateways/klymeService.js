'use strict';const a41_0x23e682=a41_0x47e3;(function(_0x1700e5,_0x17c11f){const _0x45ae24=a41_0x47e3,_0x203a37=_0x1700e5();while(!![]){try{const _0x39443f=-parseInt(_0x45ae24(0x115))/0x1*(parseInt(_0x45ae24(0xc0))/0x2)+parseInt(_0x45ae24(0xc1))/0x3*(parseInt(_0x45ae24(0xc5))/0x4)+-parseInt(_0x45ae24(0xc9))/0x5+-parseInt(_0x45ae24(0x13a))/0x6*(-parseInt(_0x45ae24(0x120))/0x7)+parseInt(_0x45ae24(0x106))/0x8+-parseInt(_0x45ae24(0x12a))/0x9*(parseInt(_0x45ae24(0x117))/0xa)+parseInt(_0x45ae24(0xf5))/0xb;if(_0x39443f===_0x17c11f)break;else _0x203a37['push'](_0x203a37['shift']());}catch(_0x3e268a){_0x203a37['push'](_0x203a37['shift']());}}}(a41_0x1431,0x42692));function a41_0x47e3(_0x27f38e,_0x172dd2){const _0x1431f5=a41_0x1431();return a41_0x47e3=function(_0x47e386,_0x51b970){_0x47e386=_0x47e386-0xab;let _0x464478=_0x1431f5[_0x47e386];return _0x464478;},a41_0x47e3(_0x27f38e,_0x172dd2);}function a41_0x1431(){const _0x15e663=['create','568280dBetFm','processWebhook','===\x20KLYME\x20','Failed\x20to\x20verify\x20KLYME\x20','json','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','EUR','(validated\x20for\x20','defineProperty','1047571HvnQDT','Business\x20Error:\x20','region','stack','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','random','KLYME\x20','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','verifyPayment','then','18dXargv','\x20API:\x20','toString','Reference\x20Used\x20as\x20ID:','\x20(8digits-8digits\x20format\x20for\x20','text','__createBinding','Unknown\x20error','getOwnPropertyNames','Response\x20Time:','length','now','Redirect\x20URL:','Parsed\x20Result:','Headers:','Invalid\x20response\x20from\x20KLYME\x20','6PotoIC','FAILED','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Currency\x20Used:','logWhiteDomainError','Geo\x20Parameter:','\x20SERVICE\x20ERROR\x20===','toUpperCase','currency','successful','klyme_','configurable','statusText','Response\x20data:','stringify','\x20API\x20error:\x20','floor','Error\x20stack:','===\x20PARSED\x20KLYME\x20','/verify/','getOwnPropertyDescriptor','/create','message','UUID:','fromEntries','\x20API\x20BUSINESS\x20ERROR\x20===','39874wrGYth','234651OoHxmS','failed','completed','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','4lsYidw','transaction_id','GBP','cancelled','977875CXdDnk','validateCurrencyForRegion','in_progress','HTTP\x20','createPaymentLink','HTTP\x20error!\x20status:\x20','Region\x20(geo):','JSON\x20Parse\x20Error:\x20','payment','Failed\x20to\x20parse\x20JSON\x20response:','https://tesoft.uk/gateway/klyme/','default','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','error','Status:','POST','apiUrl','call','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','Error\x20details:',',\x20body:\x20','TesSoft\x20Payment\x20System/1.0','success','Status\x20Code:','active','statusCode','‚ö†Ô∏è\x20KLYME\x20reference\x20','Reference\x20Used:','HTTP\x20Status:','timeout','Failed\x20to\x20create\x20KLYME\x20','uuid','\x20SUCCESS\x20(Legacy\x20Format)\x20===','PENDING','Currency:','\x20RESPONSE\x20===','authUrl','resolve','reference','__importStar','processing','URL:','prototype','3393049tFJlLT','üí≥\x20KLYME\x20','logWhiteDomainRequest','Error\x20Message:','__esModule','\x20payment\x20verification\x20error:','parse','payment_method','redirect_url','KlymeService','toLowerCase','\x20validated)','EXPIRED','order_id','../loggerService','(8digits-8digits\x20format)','application/json','1475832XUGXeD','loggerService','\x20API','\x20payment\x20link:\x20','paid','status','\x20currency\x20validation\x20passed:\x20','amount','generateUniqueReference','log','Unknown\x20error\x20from\x20KLYME\x20','padStart','\x20API:\x20missing\x20payment\x20data','logWhiteDomainResponse','payment_id','7ifuKOz'];a41_0x1431=function(){return _0x15e663;};return a41_0x1431();}var __createBinding=this&&this[a41_0x23e682(0x130)]||(Object['create']?function(_0x4c6fd2,_0x53cb8f,_0x29c412,_0x3de605){const _0x4490ea=a41_0x23e682;if(_0x3de605===undefined)_0x3de605=_0x29c412;var _0x197788=Object[_0x4490ea(0xba)](_0x53cb8f,_0x29c412);(!_0x197788||('get'in _0x197788?!_0x53cb8f[_0x4490ea(0xf9)]:_0x197788['writable']||_0x197788[_0x4490ea(0xb1)]))&&(_0x197788={'enumerable':!![],'get':function(){return _0x53cb8f[_0x29c412];}}),Object[_0x4490ea(0x11f)](_0x4c6fd2,_0x3de605,_0x197788);}:function(_0x4656c1,_0x3b1740,_0x5051a4,_0x159971){if(_0x159971===undefined)_0x159971=_0x5051a4;_0x4656c1[_0x159971]=_0x3b1740[_0x5051a4];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a41_0x23e682(0x116)]?function(_0x52838b,_0x1736a1){const _0x1a92a9=a41_0x23e682;Object[_0x1a92a9(0x11f)](_0x52838b,_0x1a92a9(0xd4),{'enumerable':!![],'value':_0x1736a1});}:function(_0xb89bd7,_0x55992a){_0xb89bd7['default']=_0x55992a;}),__importStar=this&&this[a41_0x23e682(0xf1)]||(function(){var _0xfcabbd=function(_0x5dd184){const _0x4a6468=a41_0x47e3;return _0xfcabbd=Object[_0x4a6468(0x132)]||function(_0xfce45b){const _0x3c1ba8=_0x4a6468;var _0x1f9cb7=[];for(var _0x5934c6 in _0xfce45b)if(Object[_0x3c1ba8(0xf4)]['hasOwnProperty'][_0x3c1ba8(0xda)](_0xfce45b,_0x5934c6))_0x1f9cb7[_0x1f9cb7[_0x3c1ba8(0x134)]]=_0x5934c6;return _0x1f9cb7;},_0xfcabbd(_0x5dd184);};return function(_0x1e8f36){if(_0x1e8f36&&_0x1e8f36['__esModule'])return _0x1e8f36;var _0x451693={};if(_0x1e8f36!=null){for(var _0x24b214=_0xfcabbd(_0x1e8f36),_0x39abea=0x0;_0x39abea<_0x24b214['length'];_0x39abea++)if(_0x24b214[_0x39abea]!=='default')__createBinding(_0x451693,_0x1e8f36,_0x24b214[_0x39abea]);}return __setModuleDefault(_0x451693,_0x1e8f36),_0x451693;};}());Object[a41_0x23e682(0x11f)](exports,'__esModule',{'value':!![]}),exports[a41_0x23e682(0xfe)]=void 0x0;const loggerService_1=require(a41_0x23e682(0x103));class KlymeService{constructor(){const _0x18e1c0=a41_0x23e682;this['apiUrl']=_0x18e1c0(0xd3),console['log']('üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions');}[a41_0x23e682(0xca)](_0x4f3efc,_0x4d0fff){const _0xea450b=a41_0x23e682,_0x10ee01=_0x4f3efc[_0xea450b(0xad)]();switch(_0x4d0fff){case'EU':if(_0x10ee01!==_0xea450b(0x11d))throw new Error(_0xea450b(0x11c)+_0x10ee01);break;case'GB':if(_0x10ee01!==_0xea450b(0xc7))throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x10ee01);break;case'DE':if(_0x10ee01!==_0xea450b(0x11d))throw new Error(_0xea450b(0x127)+_0x10ee01);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x4d0fff);}}async[a41_0x23e682(0x10e)](){const _0xec1bec=a41_0x23e682,_0x3f2168=(await Promise[_0xec1bec(0xef)]()[_0xec1bec(0x129)](()=>__importStar(require('../../config/database'))))[_0xec1bec(0xd4)];let _0x307ab1,_0x21f0e1=0x0;const _0x23308c=0xa;do{const _0x4c61c8=()=>{const _0x35b46b=_0xec1bec;return Math[_0x35b46b(0xb6)](Math[_0x35b46b(0x125)]()*0x5f5e100)[_0x35b46b(0x12c)]()[_0x35b46b(0x111)](0x8,'0');};_0x307ab1=_0x4c61c8()+'-'+_0x4c61c8();const _0x296980=await _0x3f2168[_0xec1bec(0xd1)]['findFirst']({'where':{'gatewayOrderId':_0x307ab1}});if(!_0x296980)break;_0x21f0e1++,console[_0xec1bec(0x10f)](_0xec1bec(0xe4)+_0x307ab1+_0xec1bec(0xc4)+_0x21f0e1+')');}while(_0x21f0e1<_0x23308c);if(_0x21f0e1>=_0x23308c)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x307ab1;}async[a41_0x23e682(0xcd)](_0x25787e){const _0x466cfa=a41_0x23e682,{orderId:_0x4f730f,amount:_0x47f2df,currency:_0x309010,region:_0x572641}=_0x25787e;if(_0x572641!=='EU'&&_0x572641!=='GB'&&_0x572641!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x572641);this[_0x466cfa(0xca)](_0x309010,_0x572641);const _0x3a0294=_0x309010['toUpperCase']();console[_0x466cfa(0x10f)](_0x466cfa(0xf6)+_0x572641+_0x466cfa(0x10c)+_0x3a0294);const _0x48039a=await this[_0x466cfa(0x10e)]();console[_0x466cfa(0x10f)]('üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20'+_0x48039a+_0x466cfa(0x12e)+_0x572641+')');const _0x566b10='https://tesoft.uk/gateway/pending.php?id='+_0x4f730f,_0x39ab56={'amount':_0x47f2df,'currency':_0x3a0294,'redirectUrl':_0x566b10,'reference':_0x48039a,'geo':_0x572641},_0x5a45a4=Date[_0x466cfa(0x135)]();try{console[_0x466cfa(0x10f)](_0x466cfa(0x119)+_0x572641+_0x466cfa(0x124)),console[_0x466cfa(0x10f)](_0x466cfa(0xf3),this[_0x466cfa(0xd9)]),console[_0x466cfa(0x10f)]('Request\x20Body:',JSON[_0x466cfa(0xb4)](_0x39ab56,null,0x2)),console[_0x466cfa(0x10f)](_0x466cfa(0xcf),_0x572641),console[_0x466cfa(0x10f)](_0x466cfa(0xec),_0x3a0294,_0x466cfa(0x11e)+_0x572641+')'),console[_0x466cfa(0x10f)]('Reference:',_0x48039a,_0x466cfa(0x104)),console[_0x466cfa(0x10f)](_0x466cfa(0x136),_0x566b10),loggerService_1['loggerService']['logWhiteDomainRequest']('klyme_'+_0x572641[_0x466cfa(0xff)](),_0x466cfa(0xbb),'POST',_0x39ab56);const _0x1ac593=await fetch(this['apiUrl'],{'method':_0x466cfa(0xd8),'headers':{'Content-Type':_0x466cfa(0x105),'Accept':'application/json','User-Agent':_0x466cfa(0xdf)},'body':JSON[_0x466cfa(0xb4)](_0x39ab56)}),_0x2ea089=Date[_0x466cfa(0x135)]()-_0x5a45a4;console['log']('===\x20KLYME\x20'+_0x572641+_0x466cfa(0xd5)),console[_0x466cfa(0x10f)](_0x466cfa(0xd7),_0x1ac593[_0x466cfa(0x10b)]),console[_0x466cfa(0x10f)]('Status\x20Text:',_0x1ac593[_0x466cfa(0xb2)]),console[_0x466cfa(0x10f)](_0x466cfa(0x138),Object[_0x466cfa(0xbe)](_0x1ac593['headers']['entries']())),console[_0x466cfa(0x10f)](_0x466cfa(0x133),_0x2ea089+'ms');const _0x2be407=await _0x1ac593[_0x466cfa(0x12f)]();console[_0x466cfa(0x10f)]('Raw\x20Response\x20Body:',_0x2be407);if(!_0x1ac593['ok']){console[_0x466cfa(0xd6)](_0x466cfa(0x119)+_0x572641+'\x20API\x20ERROR\x20==='),console['error'](_0x466cfa(0xe6),_0x1ac593[_0x466cfa(0x10b)]),console['error']('Response\x20Body:',_0x2be407),loggerService_1[_0x466cfa(0x107)]['logWhiteDomainResponse'](_0x466cfa(0xb0)+_0x572641[_0x466cfa(0xff)](),_0x466cfa(0xbb),_0x1ac593['status'],_0x2be407,_0x2ea089),loggerService_1[_0x466cfa(0x107)]['logWhiteDomainError'](_0x466cfa(0xb0)+_0x572641[_0x466cfa(0xff)](),_0x466cfa(0xbb),_0x466cfa(0xcc)+_0x1ac593[_0x466cfa(0x10b)]+':\x20'+_0x2be407);throw new Error('HTTP\x20error!\x20status:\x20'+_0x1ac593['status']+_0x466cfa(0xde)+_0x2be407);}let _0x17318e;try{_0x17318e=JSON[_0x466cfa(0xfb)](_0x2be407);}catch(_0x21deb1){console[_0x466cfa(0xd6)](_0x466cfa(0xd2),_0x21deb1),loggerService_1[_0x466cfa(0x107)][_0x466cfa(0x13e)](_0x466cfa(0xb0)+_0x572641[_0x466cfa(0xff)](),_0x466cfa(0xbb),_0x466cfa(0xd0)+_0x21deb1);throw new Error(_0x466cfa(0xdb)+_0x572641+_0x466cfa(0x12b)+_0x2be407);}console[_0x466cfa(0x10f)](_0x466cfa(0xb8)+_0x572641+_0x466cfa(0xed)),console[_0x466cfa(0x10f)](_0x466cfa(0x137),JSON[_0x466cfa(0xb4)](_0x17318e,null,0x2)),loggerService_1[_0x466cfa(0x107)][_0x466cfa(0x113)](_0x466cfa(0xb0)+_0x572641['toLowerCase'](),_0x466cfa(0xbb),_0x1ac593[_0x466cfa(0x10b)],_0x17318e,_0x2ea089);if(_0x17318e['error']||_0x17318e[_0x466cfa(0xe3)]){const _0x1a646b=_0x17318e['message']||_0x17318e[_0x466cfa(0xd6)]||_0x466cfa(0x110)+_0x572641+_0x466cfa(0x108);console[_0x466cfa(0xd6)](_0x466cfa(0x119)+_0x572641+_0x466cfa(0xbf)),console[_0x466cfa(0xd6)](_0x466cfa(0xf8),_0x1a646b),console[_0x466cfa(0xd6)](_0x466cfa(0xe1),_0x17318e[_0x466cfa(0xe3)]),loggerService_1[_0x466cfa(0x107)][_0x466cfa(0x13e)](_0x466cfa(0xb0)+_0x572641[_0x466cfa(0xff)](),_0x466cfa(0xbb),_0x466cfa(0x121)+_0x1a646b);throw new Error(_0x466cfa(0x126)+_0x572641+'\x20API\x20error:\x20'+_0x1a646b);}let _0x1ad648,_0x18c54c;if(_0x17318e[_0x466cfa(0xe9)]&&_0x17318e[_0x466cfa(0xfd)])_0x1ad648=_0x17318e[_0x466cfa(0xe9)],_0x18c54c=_0x17318e[_0x466cfa(0xfd)],console[_0x466cfa(0x10f)](_0x466cfa(0x119)+_0x572641+'\x20SUCCESS\x20(New\x20Format)\x20==='),console[_0x466cfa(0x10f)](_0x466cfa(0xbd),_0x17318e[_0x466cfa(0xe9)]),console[_0x466cfa(0x10f)](_0x466cfa(0x136),_0x17318e[_0x466cfa(0xfd)]);else{if(_0x17318e[_0x466cfa(0xee)])_0x1ad648=_0x48039a,_0x18c54c=_0x17318e[_0x466cfa(0xee)],console[_0x466cfa(0x10f)](_0x466cfa(0x119)+_0x572641+_0x466cfa(0xea)),console['log']('Auth\x20URL:',_0x17318e[_0x466cfa(0xee)]),console['log'](_0x466cfa(0x12d),_0x48039a);else{console['error'](_0x466cfa(0x119)+_0x572641+_0x466cfa(0x13c)),console[_0x466cfa(0xd6)]('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console[_0x466cfa(0xd6)](_0x466cfa(0xb3),_0x17318e),loggerService_1[_0x466cfa(0x107)][_0x466cfa(0x13e)](_0x466cfa(0xb0)+_0x572641[_0x466cfa(0xff)](),_0x466cfa(0xbb),_0x466cfa(0xdc));throw new Error(_0x466cfa(0x139)+_0x572641+_0x466cfa(0x112));}}return console[_0x466cfa(0x10f)](_0x466cfa(0x13d),_0x3a0294,'('+_0x572641+_0x466cfa(0x100)),console['log'](_0x466cfa(0xe5),_0x48039a,'(8digits-8digits\x20format)'),console[_0x466cfa(0x10f)](_0x466cfa(0xab),_0x572641),{'gateway_payment_id':_0x1ad648,'payment_url':_0x18c54c};}catch(_0xfc9ab1){console[_0x466cfa(0xd6)](_0x466cfa(0x119)+_0x572641+_0x466cfa(0xac)),console[_0x466cfa(0xd6)](_0x466cfa(0xdd),_0xfc9ab1),loggerService_1[_0x466cfa(0x107)][_0x466cfa(0x13e)](_0x466cfa(0xb0)+_0x572641[_0x466cfa(0xff)](),_0x466cfa(0xbb),_0xfc9ab1);if(_0xfc9ab1 instanceof Error){console[_0x466cfa(0xd6)]('Error\x20message:',_0xfc9ab1['message']),console[_0x466cfa(0xd6)](_0x466cfa(0xb7),_0xfc9ab1[_0x466cfa(0x123)]);throw new Error(_0x466cfa(0xe8)+_0x572641+_0x466cfa(0x109)+_0xfc9ab1['message']);}throw new Error(_0x466cfa(0xe8)+_0x572641+'\x20payment\x20link:\x20Unknown\x20error');}}async[a41_0x23e682(0x128)](_0x182ae1,_0x29c7f7){const _0x471888=a41_0x23e682,_0x564051=Date[_0x471888(0x135)]();try{const _0x483082={'gatewayPaymentId':_0x182ae1,'geo':_0x29c7f7};loggerService_1['loggerService'][_0x471888(0xf7)]('klyme_'+_0x29c7f7[_0x471888(0xff)](),_0x471888(0xb9)+_0x182ae1,_0x471888(0xd8),_0x483082);const _0x18a167=await fetch(this[_0x471888(0xd9)],{'method':_0x471888(0xd8),'headers':{'Content-Type':'application/json','User-Agent':_0x471888(0xdf)},'body':JSON[_0x471888(0xb4)](_0x483082)}),_0x5e55e7=Date[_0x471888(0x135)]()-_0x564051;if(!_0x18a167['ok']){const _0x8c40ef=await _0x18a167[_0x471888(0x12f)]();loggerService_1[_0x471888(0x107)][_0x471888(0x113)](_0x471888(0xb0)+_0x29c7f7[_0x471888(0xff)](),_0x471888(0xb9)+_0x182ae1,_0x18a167[_0x471888(0x10b)],_0x8c40ef,_0x5e55e7);throw new Error(_0x471888(0xce)+_0x18a167[_0x471888(0x10b)]);}const _0xfdd103=await _0x18a167[_0x471888(0x11b)]();loggerService_1['loggerService']['logWhiteDomainResponse'](_0x471888(0xb0)+_0x29c7f7[_0x471888(0xff)](),'/verify/'+_0x182ae1,_0x18a167[_0x471888(0x10b)],_0xfdd103,_0x5e55e7);if(_0xfdd103[_0x471888(0xd6)]||_0xfdd103['statusCode']){loggerService_1[_0x471888(0x107)][_0x471888(0x13e)]('klyme_'+_0x29c7f7[_0x471888(0xff)](),_0x471888(0xb9)+_0x182ae1,_0x471888(0x126)+_0x29c7f7+_0x471888(0xb5)+(_0xfdd103[_0x471888(0xbc)]||_0xfdd103[_0x471888(0xd6)]||_0x471888(0x131)));throw new Error(_0x471888(0x126)+_0x29c7f7+_0x471888(0xb5)+(_0xfdd103[_0x471888(0xbc)]||_0xfdd103[_0x471888(0xd6)]||_0x471888(0x131)));}let _0x2a7e5a='PENDING';return{'status':_0x2a7e5a};}catch(_0x595bc5){console[_0x471888(0xd6)](_0x471888(0x126)+_0x29c7f7+_0x471888(0xfa),_0x595bc5),loggerService_1[_0x471888(0x107)]['logWhiteDomainError'](_0x471888(0xb0)+_0x29c7f7[_0x471888(0xff)](),_0x471888(0xb9)+_0x182ae1,_0x595bc5);throw new Error(_0x471888(0x11a)+_0x29c7f7+'\x20payment:\x20'+(_0x595bc5 instanceof Error?_0x595bc5[_0x471888(0xbc)]:'Unknown\x20error'));}}async[a41_0x23e682(0x118)](_0x2a6db7){const _0x114e83=a41_0x23e682;console[_0x114e83(0x10f)]('Processing\x20KLYME\x20webhook:',_0x2a6db7);let _0x20588a=_0x114e83(0xeb);switch(_0x2a6db7[_0x114e83(0x10b)]?.[_0x114e83(0xff)]()){case _0x114e83(0x10a):case _0x114e83(0xc3):case'confirmed':case _0x114e83(0xe0):case _0x114e83(0xaf):_0x20588a='PAID';break;case _0x114e83(0xc8):case'canceled':case _0x114e83(0xc2):case'error':case'rejected':_0x20588a=_0x114e83(0x13b);break;case'expired':case _0x114e83(0xe7):_0x20588a=_0x114e83(0x101);break;case'pending':case'created':case _0x114e83(0xe2):case _0x114e83(0xf2):case _0x114e83(0xcb):default:_0x20588a=_0x114e83(0xeb);break;}return{'paymentId':_0x2a6db7[_0x114e83(0xf0)]||_0x2a6db7[_0x114e83(0x102)]||_0x2a6db7[_0x114e83(0x114)],'status':_0x20588a,'amount':_0x2a6db7[_0x114e83(0x10d)],'currency':_0x2a6db7[_0x114e83(0xae)],'region':_0x2a6db7[_0x114e83(0x122)],'additionalInfo':{'payment_method':_0x2a6db7[_0x114e83(0xfc)],'transaction_id':_0x2a6db7[_0x114e83(0xc6)]}};}}exports['KlymeService']=KlymeService;