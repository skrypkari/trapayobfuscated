'use strict';const a41_0x3f425e=a41_0x572c;(function(_0x315e78,_0xa6fa3f){const _0x5b9585=a41_0x572c,_0x498052=_0x315e78();while(!![]){try{const _0x44ce51=parseInt(_0x5b9585(0x126))/0x1*(parseInt(_0x5b9585(0x13f))/0x2)+-parseInt(_0x5b9585(0xdb))/0x3*(parseInt(_0x5b9585(0xe2))/0x4)+parseInt(_0x5b9585(0x132))/0x5*(parseInt(_0x5b9585(0x133))/0x6)+-parseInt(_0x5b9585(0x12a))/0x7*(-parseInt(_0x5b9585(0x11a))/0x8)+parseInt(_0x5b9585(0x11d))/0x9*(-parseInt(_0x5b9585(0xea))/0xa)+-parseInt(_0x5b9585(0x101))/0xb*(parseInt(_0x5b9585(0xed))/0xc)+-parseInt(_0x5b9585(0x106))/0xd;if(_0x44ce51===_0xa6fa3f)break;else _0x498052['push'](_0x498052['shift']());}catch(_0x126a7d){_0x498052['push'](_0x498052['shift']());}}}(a41_0x54bb,0xedaa7));function a41_0x572c(_0x18f805,_0x46177c){const _0x54bba5=a41_0x54bb();return a41_0x572c=function(_0x572c5f,_0x481a44){_0x572c5f=_0x572c5f-0xd3;let _0x5a4494=_0x54bba5[_0x572c5f];return _0x5a4494;},a41_0x572c(_0x18f805,_0x46177c);}var __createBinding=this&&this[a41_0x3f425e(0x137)]||(Object[a41_0x3f425e(0x125)]?function(_0x108f19,_0x50f278,_0x51851f,_0x326174){const _0x49c7af=a41_0x3f425e;if(_0x326174===undefined)_0x326174=_0x51851f;var _0xe3a7e8=Object[_0x49c7af(0xec)](_0x50f278,_0x51851f);(!_0xe3a7e8||(_0x49c7af(0xe6)in _0xe3a7e8?!_0x50f278[_0x49c7af(0x163)]:_0xe3a7e8['writable']||_0xe3a7e8[_0x49c7af(0x112)]))&&(_0xe3a7e8={'enumerable':!![],'get':function(){return _0x50f278[_0x51851f];}}),Object[_0x49c7af(0xf4)](_0x108f19,_0x326174,_0xe3a7e8);}:function(_0x410173,_0x525ff7,_0x36042e,_0x1939f6){if(_0x1939f6===undefined)_0x1939f6=_0x36042e;_0x410173[_0x1939f6]=_0x525ff7[_0x36042e];}),__setModuleDefault=this&&this[a41_0x3f425e(0xfc)]||(Object[a41_0x3f425e(0x125)]?function(_0x251adc,_0x389e20){const _0x5a3281=a41_0x3f425e;Object[_0x5a3281(0xf4)](_0x251adc,_0x5a3281(0x10c),{'enumerable':!![],'value':_0x389e20});}:function(_0x569b51,_0x16cc4a){_0x569b51['default']=_0x16cc4a;}),__importStar=this&&this['__importStar']||(function(){var _0x13a841=function(_0x730f7e){const _0x2ac275=a41_0x572c;return _0x13a841=Object[_0x2ac275(0xe8)]||function(_0x1bea18){const _0x644db6=_0x2ac275;var _0x292d77=[];for(var _0x409cfd in _0x1bea18)if(Object[_0x644db6(0xef)][_0x644db6(0x12e)][_0x644db6(0x138)](_0x1bea18,_0x409cfd))_0x292d77[_0x292d77[_0x644db6(0xe4)]]=_0x409cfd;return _0x292d77;},_0x13a841(_0x730f7e);};return function(_0x2aa78c){const _0x169363=a41_0x572c;if(_0x2aa78c&&_0x2aa78c['__esModule'])return _0x2aa78c;var _0x1b2471={};if(_0x2aa78c!=null){for(var _0x2cf2dd=_0x13a841(_0x2aa78c),_0x5848f6=0x0;_0x5848f6<_0x2cf2dd['length'];_0x5848f6++)if(_0x2cf2dd[_0x5848f6]!==_0x169363(0x10c))__createBinding(_0x1b2471,_0x2aa78c,_0x2cf2dd[_0x5848f6]);}return __setModuleDefault(_0x1b2471,_0x2aa78c),_0x1b2471;};}());Object[a41_0x3f425e(0xf4)](exports,a41_0x3f425e(0x163),{'value':!![]}),exports[a41_0x3f425e(0x123)]=void 0x0;const loggerService_1=require('../loggerService');class KlymeService{constructor(){const _0x23945f=a41_0x3f425e;this[_0x23945f(0xda)]='https://tesoft.uk/gateway/klyme/',console[_0x23945f(0x127)](_0x23945f(0x111));}[a41_0x3f425e(0xf1)](_0xd275bb,_0x4b5bd2){const _0x186d4f=a41_0x3f425e,_0x44c179=_0xd275bb[_0x186d4f(0x13b)]();switch(_0x4b5bd2){case'EU':if(_0x44c179!==_0x186d4f(0x14b))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x44c179);break;case'GB':if(_0x44c179!==_0x186d4f(0xd7))throw new Error(_0x186d4f(0x11b)+_0x44c179);break;case'DE':if(_0x44c179!==_0x186d4f(0x14b))throw new Error(_0x186d4f(0xf0)+_0x44c179);break;default:throw new Error(_0x186d4f(0x154)+_0x4b5bd2);}}async['generateUniqueReference'](){const _0x8914db=a41_0x3f425e,_0x4396a0=(await Promise[_0x8914db(0xd9)]()[_0x8914db(0x15e)](()=>__importStar(require(_0x8914db(0x134)))))['default'];let _0x52c450,_0x580bba=0x0;const _0x342558=0xa;do{const _0x5f6880=()=>{const _0x4616ca=_0x8914db;return Math['floor'](Math['random']()*0x5f5e100)[_0x4616ca(0xeb)]()[_0x4616ca(0x156)](0x8,'0');};_0x52c450=_0x5f6880()+'-'+_0x5f6880();const _0x49200e=await _0x4396a0['payment'][_0x8914db(0x15d)]({'where':{'gatewayOrderId':_0x52c450}});if(!_0x49200e)break;_0x580bba++,console[_0x8914db(0x127)](_0x8914db(0x147)+_0x52c450+_0x8914db(0x153)+_0x580bba+')');}while(_0x580bba<_0x342558);if(_0x580bba>=_0x342558)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x52c450;}async[a41_0x3f425e(0x119)](_0x4d3653){const _0x3e790c=a41_0x3f425e,{orderId:_0x27f403,amount:_0x2cc737,currency:_0x57c0ca,region:_0x4ff86e}=_0x4d3653;if(_0x4ff86e!=='EU'&&_0x4ff86e!=='GB'&&_0x4ff86e!=='DE')throw new Error(_0x3e790c(0x13e)+_0x4ff86e);this['validateCurrencyForRegion'](_0x57c0ca,_0x4ff86e);const _0x23a9c4=_0x57c0ca[_0x3e790c(0x13b)]();console['log'](_0x3e790c(0x14c)+_0x4ff86e+_0x3e790c(0x12d)+_0x23a9c4);const _0x406b48=await this[_0x3e790c(0x14f)]();console[_0x3e790c(0x127)](_0x3e790c(0xf2)+_0x406b48+_0x3e790c(0x12c)+_0x4ff86e+')');const _0x2425a6=_0x3e790c(0x15f)+_0x27f403,_0xcbe319={'amount':_0x2cc737,'currency':_0x23a9c4,'redirectUrl':_0x2425a6,'reference':_0x406b48,'geo':_0x4ff86e},_0x23d159=Date[_0x3e790c(0x135)]();try{console[_0x3e790c(0x127)](_0x3e790c(0x136)+_0x4ff86e+'\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20==='),console['log'](_0x3e790c(0x10f),this[_0x3e790c(0xda)]),console['log'](_0x3e790c(0x14d),JSON['stringify'](_0xcbe319,null,0x2)),console[_0x3e790c(0x127)](_0x3e790c(0x13d),_0x4ff86e),console[_0x3e790c(0x127)](_0x3e790c(0x122),_0x23a9c4,_0x3e790c(0x11f)+_0x4ff86e+')'),console['log'](_0x3e790c(0xf5),_0x406b48,'(8digits-8digits\x20format)'),console[_0x3e790c(0x127)](_0x3e790c(0x152),_0x2425a6),loggerService_1[_0x3e790c(0x15b)][_0x3e790c(0x13a)](_0x3e790c(0x11e)+_0x4ff86e['toLowerCase'](),_0x3e790c(0xe7),_0x3e790c(0x109),_0xcbe319);const _0x3dddde=await fetch(this[_0x3e790c(0xda)],{'method':_0x3e790c(0x109),'headers':{'Content-Type':_0x3e790c(0xe3),'Accept':_0x3e790c(0xe3),'User-Agent':_0x3e790c(0x113)},'body':JSON[_0x3e790c(0xe0)](_0xcbe319)}),_0x3f954c=Date[_0x3e790c(0x135)]()-_0x23d159;console[_0x3e790c(0x127)](_0x3e790c(0x136)+_0x4ff86e+'\x20API\x20RESPONSE\x20(Unified\x20Route)\x20==='),console[_0x3e790c(0x127)](_0x3e790c(0x104),_0x3dddde[_0x3e790c(0x160)]),console[_0x3e790c(0x127)](_0x3e790c(0x10a),_0x3dddde['statusText']),console['log']('Headers:',Object[_0x3e790c(0xdf)](_0x3dddde[_0x3e790c(0xff)][_0x3e790c(0x12b)]())),console[_0x3e790c(0x127)]('Response\x20Time:',_0x3f954c+'ms');const _0x427f80=await _0x3dddde[_0x3e790c(0x139)]();console['log'](_0x3e790c(0x148),_0x427f80);if(!_0x3dddde['ok']){console['error']('===\x20KLYME\x20'+_0x4ff86e+_0x3e790c(0x118)),console[_0x3e790c(0x149)]('HTTP\x20Status:',_0x3dddde['status']),console[_0x3e790c(0x149)](_0x3e790c(0x14a),_0x427f80),loggerService_1[_0x3e790c(0x15b)][_0x3e790c(0x10b)]('klyme_'+_0x4ff86e['toLowerCase'](),_0x3e790c(0xe7),_0x3dddde[_0x3e790c(0x160)],_0x427f80,_0x3f954c),loggerService_1[_0x3e790c(0x15b)][_0x3e790c(0x120)](_0x3e790c(0x11e)+_0x4ff86e[_0x3e790c(0x105)](),_0x3e790c(0xe7),_0x3e790c(0x121)+_0x3dddde[_0x3e790c(0x160)]+':\x20'+_0x427f80);throw new Error(_0x3e790c(0x142)+_0x3dddde['status']+_0x3e790c(0x161)+_0x427f80);}let _0x59e430;try{_0x59e430=JSON['parse'](_0x427f80);}catch(_0x58845e){console[_0x3e790c(0x149)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x58845e),loggerService_1[_0x3e790c(0x15b)]['logWhiteDomainError'](_0x3e790c(0x11e)+_0x4ff86e['toLowerCase'](),_0x3e790c(0xe7),_0x3e790c(0x131)+_0x58845e);throw new Error(_0x3e790c(0x103)+_0x4ff86e+_0x3e790c(0x15c)+_0x427f80);}console['log'](_0x3e790c(0x140)+_0x4ff86e+'\x20RESPONSE\x20==='),console['log']('Parsed\x20Result:',JSON[_0x3e790c(0xe0)](_0x59e430,null,0x2)),loggerService_1[_0x3e790c(0x15b)]['logWhiteDomainResponse'](_0x3e790c(0x11e)+_0x4ff86e[_0x3e790c(0x105)](),_0x3e790c(0xe7),_0x3dddde[_0x3e790c(0x160)],_0x59e430,_0x3f954c);if(_0x59e430['error']||_0x59e430[_0x3e790c(0xd3)]){const _0x364efe=_0x59e430[_0x3e790c(0x12f)]||_0x59e430[_0x3e790c(0x149)]||_0x3e790c(0x14e)+_0x4ff86e+_0x3e790c(0x128);console['error'](_0x3e790c(0x136)+_0x4ff86e+_0x3e790c(0x151)),console['error'](_0x3e790c(0x164),_0x364efe),console[_0x3e790c(0x149)]('Status\x20Code:',_0x59e430[_0x3e790c(0xd3)]),loggerService_1[_0x3e790c(0x15b)]['logWhiteDomainError'](_0x3e790c(0x11e)+_0x4ff86e[_0x3e790c(0x105)](),'/create','Business\x20Error:\x20'+_0x364efe);throw new Error(_0x3e790c(0x10d)+_0x4ff86e+_0x3e790c(0x129)+_0x364efe);}let _0x3c3709,_0x1249b1;if(_0x59e430[_0x3e790c(0x143)]&&_0x59e430[_0x3e790c(0xf3)])_0x3c3709=_0x59e430[_0x3e790c(0x143)],_0x1249b1=_0x59e430[_0x3e790c(0xf3)],console[_0x3e790c(0x127)](_0x3e790c(0x136)+_0x4ff86e+_0x3e790c(0xde)),console[_0x3e790c(0x127)](_0x3e790c(0x10e),_0x59e430[_0x3e790c(0x143)]),console['log'](_0x3e790c(0x152),_0x59e430[_0x3e790c(0xf3)]);else{if(_0x59e430['authUrl'])_0x3c3709=_0x406b48,_0x1249b1=_0x59e430[_0x3e790c(0x100)],console[_0x3e790c(0x127)](_0x3e790c(0x136)+_0x4ff86e+'\x20SUCCESS\x20(Legacy\x20Format)\x20==='),console['log'](_0x3e790c(0x141),_0x59e430[_0x3e790c(0x100)]),console[_0x3e790c(0x127)]('Reference\x20Used\x20as\x20ID:',_0x406b48);else{console[_0x3e790c(0x149)](_0x3e790c(0x136)+_0x4ff86e+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x3e790c(0x149)](_0x3e790c(0xdd)),console[_0x3e790c(0x149)](_0x3e790c(0xd8),_0x59e430),loggerService_1[_0x3e790c(0x15b)]['logWhiteDomainError'](_0x3e790c(0x11e)+_0x4ff86e[_0x3e790c(0x105)](),'/create',_0x3e790c(0xfe));throw new Error(_0x3e790c(0x117)+_0x4ff86e+'\x20API:\x20missing\x20payment\x20data');}}return console[_0x3e790c(0x127)]('Currency\x20Used:',_0x23a9c4,'('+_0x4ff86e+_0x3e790c(0x146)),console[_0x3e790c(0x127)]('Reference\x20Used:',_0x406b48,_0x3e790c(0xe1)),console[_0x3e790c(0x127)](_0x3e790c(0x124),_0x4ff86e),{'gateway_payment_id':_0x3c3709,'payment_url':_0x1249b1};}catch(_0x48efa6){console['error']('===\x20KLYME\x20'+_0x4ff86e+_0x3e790c(0xd6)),console[_0x3e790c(0x149)](_0x3e790c(0xf6),_0x48efa6),loggerService_1['loggerService'][_0x3e790c(0x120)](_0x3e790c(0x11e)+_0x4ff86e[_0x3e790c(0x105)](),_0x3e790c(0xe7),_0x48efa6);if(_0x48efa6 instanceof Error){console['error'](_0x3e790c(0xe5),_0x48efa6['message']),console[_0x3e790c(0x149)](_0x3e790c(0xee),_0x48efa6['stack']);throw new Error(_0x3e790c(0x157)+_0x4ff86e+_0x3e790c(0x115)+_0x48efa6[_0x3e790c(0x12f)]);}throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0x4ff86e+_0x3e790c(0xd4));}}async[a41_0x3f425e(0xfd)](_0x3db1d9,_0x39cadf){const _0x171179=a41_0x3f425e,_0x416ed2=Date[_0x171179(0x135)]();try{const _0x56b9c4={'gatewayPaymentId':_0x3db1d9,'geo':_0x39cadf};loggerService_1['loggerService'][_0x171179(0x13a)]('klyme_'+_0x39cadf[_0x171179(0x105)](),'/verify/'+_0x3db1d9,_0x171179(0x109),_0x56b9c4);const _0x4fba5c=await fetch(this[_0x171179(0xda)],{'method':_0x171179(0x109),'headers':{'Content-Type':'application/json','User-Agent':_0x171179(0x113)},'body':JSON['stringify'](_0x56b9c4)}),_0x363924=Date[_0x171179(0x135)]()-_0x416ed2;if(!_0x4fba5c['ok']){const _0x502b98=await _0x4fba5c[_0x171179(0x139)]();loggerService_1[_0x171179(0x15b)][_0x171179(0x10b)](_0x171179(0x11e)+_0x39cadf['toLowerCase'](),_0x171179(0x158)+_0x3db1d9,_0x4fba5c[_0x171179(0x160)],_0x502b98,_0x363924);throw new Error(_0x171179(0x142)+_0x4fba5c[_0x171179(0x160)]);}const _0x15b534=await _0x4fba5c[_0x171179(0x150)]();loggerService_1[_0x171179(0x15b)]['logWhiteDomainResponse'](_0x171179(0x11e)+_0x39cadf[_0x171179(0x105)](),_0x171179(0x158)+_0x3db1d9,_0x4fba5c['status'],_0x15b534,_0x363924);if(_0x15b534[_0x171179(0x149)]||_0x15b534[_0x171179(0xd3)]){loggerService_1[_0x171179(0x15b)][_0x171179(0x120)](_0x171179(0x11e)+_0x39cadf[_0x171179(0x105)](),_0x171179(0x158)+_0x3db1d9,_0x171179(0x10d)+_0x39cadf+_0x171179(0x129)+(_0x15b534['message']||_0x15b534[_0x171179(0x149)]||'Unknown\x20error'));throw new Error('KLYME\x20'+_0x39cadf+_0x171179(0x129)+(_0x15b534['message']||_0x15b534[_0x171179(0x149)]||_0x171179(0xf8)));}let _0x52ed2d=_0x171179(0x162);return{'status':_0x52ed2d};}catch(_0x310454){console[_0x171179(0x149)](_0x171179(0x10d)+_0x39cadf+_0x171179(0xdc),_0x310454),loggerService_1['loggerService'][_0x171179(0x120)](_0x171179(0x11e)+_0x39cadf[_0x171179(0x105)](),'/verify/'+_0x3db1d9,_0x310454);throw new Error(_0x171179(0x107)+_0x39cadf+'\x20payment:\x20'+(_0x310454 instanceof Error?_0x310454[_0x171179(0x12f)]:'Unknown\x20error'));}}async['processWebhook'](_0x14979c){const _0x114023=a41_0x3f425e;console['log'](_0x114023(0x144),_0x14979c);let _0x28b7ae=_0x114023(0x162);switch(_0x14979c[_0x114023(0x160)]?.[_0x114023(0x105)]()){case _0x114023(0xf7):case'completed':case _0x114023(0xe9):case _0x114023(0x159):case'successful':_0x28b7ae=_0x114023(0xfa);break;case _0x114023(0x108):case'canceled':case _0x114023(0x116):case _0x114023(0x149):case'rejected':_0x28b7ae=_0x114023(0x13c);break;case'expired':case'timeout':_0x28b7ae=_0x114023(0x110);break;case _0x114023(0x11c):case _0x114023(0x102):case'active':case _0x114023(0xd5):case _0x114023(0x114):default:_0x28b7ae=_0x114023(0x162);break;}return{'paymentId':_0x14979c[_0x114023(0x145)]||_0x14979c[_0x114023(0x130)]||_0x14979c[_0x114023(0x155)],'status':_0x28b7ae,'amount':_0x14979c['amount'],'currency':_0x14979c['currency'],'region':_0x14979c[_0x114023(0xf9)],'additionalInfo':{'payment_method':_0x14979c[_0x114023(0xfb)],'transaction_id':_0x14979c[_0x114023(0x15a)]}};}}exports[a41_0x3f425e(0x123)]=KlymeService;function a41_0x54bb(){const _0x2c4985=['transaction_id','loggerService','\x20API:\x20','findFirst','then','https://tesoft.uk/gateway/pending.php?id=','status',',\x20body:\x20','PENDING','__esModule','Error\x20Message:','statusCode','\x20payment\x20link:\x20Unknown\x20error','processing','\x20SERVICE\x20ERROR\x20===','GBP','Response\x20data:','resolve','apiUrl','3TwyYcH','\x20payment\x20verification\x20error:','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','\x20SUCCESS\x20(New\x20Format)\x20===','fromEntries','stringify','(8digits-8digits\x20format)','3261556vFfZRq','application/json','length','Error\x20message:','get','/create','getOwnPropertyNames','confirmed','3757100ABsLkT','toString','getOwnPropertyDescriptor','12BKaOcJ','Error\x20stack:','prototype','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','validateCurrencyForRegion','🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20','redirect_url','defineProperty','Reference:','Error\x20details:','paid','Unknown\x20error','region','PAID','payment_method','__setModuleDefault','verifyPayment','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','headers','authUrl','4506106YvIEIe','created','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','Status:','toLowerCase','23700911doelGu','Failed\x20to\x20verify\x20KLYME\x20','cancelled','POST','Status\x20Text:','logWhiteDomainResponse','default','KLYME\x20','UUID:','URL:','EXPIRED','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','configurable','TesSoft\x20Payment\x20System/1.0','in_progress','\x20payment\x20link:\x20','failed','Invalid\x20response\x20from\x20KLYME\x20','\x20API\x20ERROR\x20===','createPaymentLink','18696IPDhJf','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','pending','18ZfAsly','klyme_','(validated\x20for\x20','logWhiteDomainError','HTTP\x20','Currency:','KlymeService','Geo\x20Parameter:','create','1etWnZf','log','\x20API','\x20API\x20error:\x20','5173ZpNnpS','entries','\x20(8digits-8digits\x20format\x20for\x20','\x20currency\x20validation\x20passed:\x20','hasOwnProperty','message','order_id','JSON\x20Parse\x20Error:\x20','72085wlxlNF','462yfrGKo','../../config/database','now','===\x20KLYME\x20','__createBinding','call','text','logWhiteDomainRequest','toUpperCase','FAILED','Region\x20(geo):','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','3871858khgTio','===\x20PARSED\x20KLYME\x20','Auth\x20URL:','HTTP\x20error!\x20status:\x20','uuid','Processing\x20KLYME\x20webhook:','reference','\x20validated)','⚠️\x20KLYME\x20reference\x20','Raw\x20Response\x20Body:','error','Response\x20Body:','EUR','💳\x20KLYME\x20','Request\x20Body:','Unknown\x20error\x20from\x20KLYME\x20','generateUniqueReference','json','\x20API\x20BUSINESS\x20ERROR\x20===','Redirect\x20URL:','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','Unsupported\x20KLYME\x20region:\x20','payment_id','padStart','Failed\x20to\x20create\x20KLYME\x20','/verify/','success'];a41_0x54bb=function(){return _0x2c4985;};return a41_0x54bb();}