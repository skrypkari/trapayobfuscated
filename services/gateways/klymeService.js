'use strict';const a39_0x40eda9=a39_0x3812;(function(_0x30cbb2,_0x34e1c3){const _0x5366af=a39_0x3812,_0x452039=_0x30cbb2();while(!![]){try{const _0x486b67=-parseInt(_0x5366af(0x158))/0x1+parseInt(_0x5366af(0x130))/0x2+-parseInt(_0x5366af(0x170))/0x3*(parseInt(_0x5366af(0x151))/0x4)+-parseInt(_0x5366af(0x160))/0x5+parseInt(_0x5366af(0x15e))/0x6*(-parseInt(_0x5366af(0x121))/0x7)+-parseInt(_0x5366af(0x167))/0x8+-parseInt(_0x5366af(0x134))/0x9*(-parseInt(_0x5366af(0x179))/0xa);if(_0x486b67===_0x34e1c3)break;else _0x452039['push'](_0x452039['shift']());}catch(_0x36f440){_0x452039['push'](_0x452039['shift']());}}}(a39_0x147d,0xc1325));function a39_0x3812(_0x410285,_0x575364){const _0x147dd9=a39_0x147d();return a39_0x3812=function(_0x38129d,_0x328750){_0x38129d=_0x38129d-0x103;let _0x2822aa=_0x147dd9[_0x38129d];return _0x2822aa;},a39_0x3812(_0x410285,_0x575364);}var __createBinding=this&&this[a39_0x40eda9(0x140)]||(Object['create']?function(_0x18ad5,_0x14fd29,_0x12b790,_0x25dcfd){const _0x14591f=a39_0x40eda9;if(_0x25dcfd===undefined)_0x25dcfd=_0x12b790;var _0x1ee4fe=Object[_0x14591f(0x15c)](_0x14fd29,_0x12b790);(!_0x1ee4fe||(_0x14591f(0x128)in _0x1ee4fe?!_0x14fd29[_0x14591f(0x119)]:_0x1ee4fe['writable']||_0x1ee4fe[_0x14591f(0x112)]))&&(_0x1ee4fe={'enumerable':!![],'get':function(){return _0x14fd29[_0x12b790];}}),Object[_0x14591f(0x123)](_0x18ad5,_0x25dcfd,_0x1ee4fe);}:function(_0x14496f,_0x57cdec,_0x260e73,_0x47c1ce){if(_0x47c1ce===undefined)_0x47c1ce=_0x260e73;_0x14496f[_0x47c1ce]=_0x57cdec[_0x260e73];}),__setModuleDefault=this&&this[a39_0x40eda9(0x152)]||(Object[a39_0x40eda9(0x10b)]?function(_0x3d6e7f,_0x5aba40){const _0x443a72=a39_0x40eda9;Object[_0x443a72(0x123)](_0x3d6e7f,_0x443a72(0x15a),{'enumerable':!![],'value':_0x5aba40});}:function(_0x55c563,_0xbc659c){_0x55c563['default']=_0xbc659c;}),__importStar=this&&this[a39_0x40eda9(0x159)]||(function(){var _0x5c98e7=function(_0x12aac4){const _0x106f4e=a39_0x3812;return _0x5c98e7=Object[_0x106f4e(0x172)]||function(_0x51a233){const _0x3ab04b=_0x106f4e;var _0x5912d3=[];for(var _0x3ec7ef in _0x51a233)if(Object['prototype'][_0x3ab04b(0x15f)][_0x3ab04b(0x125)](_0x51a233,_0x3ec7ef))_0x5912d3[_0x5912d3['length']]=_0x3ec7ef;return _0x5912d3;},_0x5c98e7(_0x12aac4);};return function(_0x5bda68){const _0x54d50c=a39_0x3812;if(_0x5bda68&&_0x5bda68['__esModule'])return _0x5bda68;var _0x51335b={};if(_0x5bda68!=null){for(var _0x20d7cd=_0x5c98e7(_0x5bda68),_0x4ea2d4=0x0;_0x4ea2d4<_0x20d7cd[_0x54d50c(0x14d)];_0x4ea2d4++)if(_0x20d7cd[_0x4ea2d4]!=='default')__createBinding(_0x51335b,_0x5bda68,_0x20d7cd[_0x4ea2d4]);}return __setModuleDefault(_0x51335b,_0x5bda68),_0x51335b;};}());Object['defineProperty'](exports,a39_0x40eda9(0x119),{'value':!![]}),exports[a39_0x40eda9(0x10a)]=void 0x0;const loggerService_1=require('../loggerService');class KlymeService{constructor(){const _0x4a6e65=a39_0x40eda9;this[_0x4a6e65(0x166)]=_0x4a6e65(0x15b),console['log'](_0x4a6e65(0x192));}[a39_0x40eda9(0x114)](_0x1480a5,_0x1cb18b){const _0x2d2395=a39_0x40eda9,_0x16c469=_0x1480a5[_0x2d2395(0x165)]();switch(_0x1cb18b){case'EU':if(_0x16c469!=='EUR')throw new Error(_0x2d2395(0x11c)+_0x16c469);break;case'GB':if(_0x16c469!==_0x2d2395(0x145))throw new Error(_0x2d2395(0x138)+_0x16c469);break;case'DE':if(_0x16c469!==_0x2d2395(0x17f))throw new Error(_0x2d2395(0x13c)+_0x16c469);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x1cb18b);}}async[a39_0x40eda9(0x111)](){const _0x3eb08b=a39_0x40eda9,_0x471e66=(await Promise[_0x3eb08b(0x13b)]()[_0x3eb08b(0x16f)](()=>__importStar(require(_0x3eb08b(0x18f)))))['default'];let _0x2e1f05,_0x256c27=0x0;const _0x4c61f3=0xa;do{const _0xb01e37=()=>{const _0xdd40=_0x3eb08b;return Math['floor'](Math[_0xdd40(0x191)]()*0x5f5e100)[_0xdd40(0x122)]()[_0xdd40(0x181)](0x8,'0');};_0x2e1f05=_0xb01e37()+'-'+_0xb01e37();const _0xa289b8=await _0x471e66[_0x3eb08b(0x11e)][_0x3eb08b(0x188)]({'where':{'gatewayOrderId':_0x2e1f05}});if(!_0xa289b8)break;_0x256c27++,console['log'](_0x3eb08b(0x118)+_0x2e1f05+_0x3eb08b(0x13d)+_0x256c27+')');}while(_0x256c27<_0x4c61f3);if(_0x256c27>=_0x4c61f3)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x2e1f05;}async['createPaymentLink'](_0x18ab76){const _0x3f078c=a39_0x40eda9,{orderId:_0x5c2011,amount:_0x37f5b4,currency:_0x265b23,region:_0x19a34f}=_0x18ab76;if(_0x19a34f!=='EU'&&_0x19a34f!=='GB'&&_0x19a34f!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x19a34f);this[_0x3f078c(0x114)](_0x265b23,_0x19a34f);const _0x424589=_0x265b23[_0x3f078c(0x165)]();console[_0x3f078c(0x183)]('üí≥\x20KLYME\x20'+_0x19a34f+_0x3f078c(0x14f)+_0x424589);const _0x4a877f=await this[_0x3f078c(0x111)]();console[_0x3f078c(0x183)](_0x3f078c(0x148)+_0x4a877f+_0x3f078c(0x11a)+_0x19a34f+')');const _0x16017d='https://tesoft.uk/gateway/pending.php?id='+_0x5c2011,_0x22639d={'amount':_0x37f5b4,'currency':_0x424589,'redirectUrl':_0x16017d,'reference':_0x4a877f,'geo':_0x19a34f},_0x38e71e=Date[_0x3f078c(0x17b)]();try{console[_0x3f078c(0x183)](_0x3f078c(0x141)+_0x19a34f+_0x3f078c(0x186)),console[_0x3f078c(0x183)](_0x3f078c(0x14c),this[_0x3f078c(0x166)]),console[_0x3f078c(0x183)]('Request\x20Body:',JSON[_0x3f078c(0x136)](_0x22639d,null,0x2)),console[_0x3f078c(0x183)]('Region\x20(geo):',_0x19a34f),console[_0x3f078c(0x183)](_0x3f078c(0x156),_0x424589,_0x3f078c(0x146)+_0x19a34f+')'),console['log']('Reference:',_0x4a877f,'(8digits-8digits\x20format)'),console[_0x3f078c(0x183)]('Redirect\x20URL:',_0x16017d),loggerService_1[_0x3f078c(0x149)]['logWhiteDomainRequest']('klyme_'+_0x19a34f['toLowerCase'](),_0x3f078c(0x127),'POST',_0x22639d);const _0x32b4f3=await fetch(this[_0x3f078c(0x166)],{'method':'POST','headers':{'Content-Type':_0x3f078c(0x161),'Accept':_0x3f078c(0x161),'User-Agent':_0x3f078c(0x117)},'body':JSON[_0x3f078c(0x136)](_0x22639d)}),_0x38873e=Date['now']()-_0x38e71e;console[_0x3f078c(0x183)](_0x3f078c(0x141)+_0x19a34f+'\x20API\x20RESPONSE\x20(Unified\x20Route)\x20==='),console['log']('Status:',_0x32b4f3[_0x3f078c(0x142)]),console[_0x3f078c(0x183)](_0x3f078c(0x14e),_0x32b4f3[_0x3f078c(0x175)]),console['log'](_0x3f078c(0x109),Object['fromEntries'](_0x32b4f3['headers'][_0x3f078c(0x193)]())),console['log'](_0x3f078c(0x104),_0x38873e+'ms');const _0x1decb0=await _0x32b4f3['text']();console['log'](_0x3f078c(0x10c),_0x1decb0);if(!_0x32b4f3['ok']){console['error'](_0x3f078c(0x141)+_0x19a34f+_0x3f078c(0x13f)),console[_0x3f078c(0x17e)](_0x3f078c(0x108),_0x32b4f3['status']),console[_0x3f078c(0x17e)](_0x3f078c(0x182),_0x1decb0),loggerService_1[_0x3f078c(0x149)][_0x3f078c(0x110)]('klyme_'+_0x19a34f['toLowerCase'](),'/create',_0x32b4f3[_0x3f078c(0x142)],_0x1decb0,_0x38873e),loggerService_1[_0x3f078c(0x149)][_0x3f078c(0x144)](_0x3f078c(0x10f)+_0x19a34f[_0x3f078c(0x12c)](),_0x3f078c(0x127),'HTTP\x20'+_0x32b4f3[_0x3f078c(0x142)]+':\x20'+_0x1decb0);throw new Error('HTTP\x20error!\x20status:\x20'+_0x32b4f3[_0x3f078c(0x142)]+_0x3f078c(0x147)+_0x1decb0);}let _0x385b54;try{_0x385b54=JSON[_0x3f078c(0x135)](_0x1decb0);}catch(_0x4816af){console[_0x3f078c(0x17e)](_0x3f078c(0x196),_0x4816af),loggerService_1[_0x3f078c(0x149)]['logWhiteDomainError'](_0x3f078c(0x10f)+_0x19a34f['toLowerCase'](),_0x3f078c(0x127),'JSON\x20Parse\x20Error:\x20'+_0x4816af);throw new Error(_0x3f078c(0x17d)+_0x19a34f+_0x3f078c(0x129)+_0x1decb0);}console[_0x3f078c(0x183)]('===\x20PARSED\x20KLYME\x20'+_0x19a34f+'\x20RESPONSE\x20==='),console[_0x3f078c(0x183)](_0x3f078c(0x12a),JSON[_0x3f078c(0x136)](_0x385b54,null,0x2)),loggerService_1['loggerService'][_0x3f078c(0x110)](_0x3f078c(0x10f)+_0x19a34f[_0x3f078c(0x12c)](),_0x3f078c(0x127),_0x32b4f3[_0x3f078c(0x142)],_0x385b54,_0x38873e);if(_0x385b54[_0x3f078c(0x17e)]||_0x385b54[_0x3f078c(0x164)]){const _0x575b30=_0x385b54['message']||_0x385b54[_0x3f078c(0x17e)]||_0x3f078c(0x124)+_0x19a34f+_0x3f078c(0x11b);console[_0x3f078c(0x17e)]('===\x20KLYME\x20'+_0x19a34f+_0x3f078c(0x103)),console[_0x3f078c(0x17e)]('Error\x20Message:',_0x575b30),console[_0x3f078c(0x17e)]('Status\x20Code:',_0x385b54[_0x3f078c(0x164)]),loggerService_1[_0x3f078c(0x149)][_0x3f078c(0x144)]('klyme_'+_0x19a34f['toLowerCase'](),_0x3f078c(0x127),_0x3f078c(0x17c)+_0x575b30);throw new Error(_0x3f078c(0x178)+_0x19a34f+_0x3f078c(0x12e)+_0x575b30);}let _0x396e1a,_0x37f690;if(_0x385b54[_0x3f078c(0x18d)]&&_0x385b54[_0x3f078c(0x16e)])_0x396e1a=_0x385b54[_0x3f078c(0x18d)],_0x37f690=_0x385b54['redirect_url'],console[_0x3f078c(0x183)](_0x3f078c(0x141)+_0x19a34f+_0x3f078c(0x174)),console[_0x3f078c(0x183)]('UUID:',_0x385b54[_0x3f078c(0x18d)]),console['log'](_0x3f078c(0x15d),_0x385b54[_0x3f078c(0x16e)]);else{if(_0x385b54[_0x3f078c(0x173)])_0x396e1a=_0x4a877f,_0x37f690=_0x385b54[_0x3f078c(0x173)],console['log'](_0x3f078c(0x141)+_0x19a34f+_0x3f078c(0x154)),console[_0x3f078c(0x183)]('Auth\x20URL:',_0x385b54[_0x3f078c(0x173)]),console['log']('Reference\x20Used\x20as\x20ID:',_0x4a877f);else{console[_0x3f078c(0x17e)]('===\x20KLYME\x20'+_0x19a34f+_0x3f078c(0x115)),console[_0x3f078c(0x17e)](_0x3f078c(0x195)),console[_0x3f078c(0x17e)](_0x3f078c(0x12b),_0x385b54),loggerService_1[_0x3f078c(0x149)]['logWhiteDomainError'](_0x3f078c(0x10f)+_0x19a34f[_0x3f078c(0x12c)](),_0x3f078c(0x127),_0x3f078c(0x12f));throw new Error(_0x3f078c(0x133)+_0x19a34f+_0x3f078c(0x120));}}return console['log'](_0x3f078c(0x190),_0x424589,'('+_0x19a34f+_0x3f078c(0x153)),console[_0x3f078c(0x183)](_0x3f078c(0x155),_0x4a877f,_0x3f078c(0x11f)),console[_0x3f078c(0x183)]('Geo\x20Parameter:',_0x19a34f),{'gateway_payment_id':_0x396e1a,'payment_url':_0x37f690};}catch(_0x5a0949){console[_0x3f078c(0x17e)](_0x3f078c(0x141)+_0x19a34f+_0x3f078c(0x168)),console[_0x3f078c(0x17e)](_0x3f078c(0x184),_0x5a0949),loggerService_1[_0x3f078c(0x149)][_0x3f078c(0x144)](_0x3f078c(0x10f)+_0x19a34f[_0x3f078c(0x12c)](),'/create',_0x5a0949);if(_0x5a0949 instanceof Error){console[_0x3f078c(0x17e)](_0x3f078c(0x11d),_0x5a0949[_0x3f078c(0x16b)]),console[_0x3f078c(0x17e)](_0x3f078c(0x143),_0x5a0949['stack']);throw new Error(_0x3f078c(0x171)+_0x19a34f+_0x3f078c(0x10d)+_0x5a0949[_0x3f078c(0x16b)]);}throw new Error(_0x3f078c(0x171)+_0x19a34f+_0x3f078c(0x176));}}async[a39_0x40eda9(0x185)](_0x13beb2,_0x1cca91){const _0x24e26b=a39_0x40eda9,_0x3c55c1=Date['now']();try{const _0x2fc05f={'gatewayPaymentId':_0x13beb2,'geo':_0x1cca91};loggerService_1['loggerService']['logWhiteDomainRequest'](_0x24e26b(0x10f)+_0x1cca91['toLowerCase'](),_0x24e26b(0x12d)+_0x13beb2,_0x24e26b(0x163),_0x2fc05f);const _0xe1ba79=await fetch(this[_0x24e26b(0x166)],{'method':_0x24e26b(0x163),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x2fc05f)}),_0x5c3713=Date[_0x24e26b(0x17b)]()-_0x3c55c1;if(!_0xe1ba79['ok']){const _0x1b42db=await _0xe1ba79[_0x24e26b(0x137)]();loggerService_1[_0x24e26b(0x149)][_0x24e26b(0x110)](_0x24e26b(0x10f)+_0x1cca91[_0x24e26b(0x12c)](),'/verify/'+_0x13beb2,_0xe1ba79[_0x24e26b(0x142)],_0x1b42db,_0x5c3713);throw new Error('HTTP\x20error!\x20status:\x20'+_0xe1ba79[_0x24e26b(0x142)]);}const _0x5cce45=await _0xe1ba79[_0x24e26b(0x169)]();loggerService_1[_0x24e26b(0x149)][_0x24e26b(0x110)](_0x24e26b(0x10f)+_0x1cca91[_0x24e26b(0x12c)](),_0x24e26b(0x12d)+_0x13beb2,_0xe1ba79[_0x24e26b(0x142)],_0x5cce45,_0x5c3713);if(_0x5cce45[_0x24e26b(0x17e)]||_0x5cce45[_0x24e26b(0x164)]){loggerService_1[_0x24e26b(0x149)][_0x24e26b(0x144)]('klyme_'+_0x1cca91['toLowerCase'](),_0x24e26b(0x12d)+_0x13beb2,_0x24e26b(0x178)+_0x1cca91+'\x20API\x20error:\x20'+(_0x5cce45['message']||_0x5cce45[_0x24e26b(0x17e)]||'Unknown\x20error'));throw new Error(_0x24e26b(0x178)+_0x1cca91+_0x24e26b(0x12e)+(_0x5cce45[_0x24e26b(0x16b)]||_0x5cce45[_0x24e26b(0x17e)]||_0x24e26b(0x13e)));}let _0x1ed5b7='PENDING';return{'status':_0x1ed5b7};}catch(_0x478fd5){console[_0x24e26b(0x17e)](_0x24e26b(0x178)+_0x1cca91+_0x24e26b(0x131),_0x478fd5),loggerService_1[_0x24e26b(0x149)][_0x24e26b(0x144)](_0x24e26b(0x10f)+_0x1cca91[_0x24e26b(0x12c)](),_0x24e26b(0x12d)+_0x13beb2,_0x478fd5);throw new Error('Failed\x20to\x20verify\x20KLYME\x20'+_0x1cca91+_0x24e26b(0x10e)+(_0x478fd5 instanceof Error?_0x478fd5[_0x24e26b(0x16b)]:'Unknown\x20error'));}}async['processWebhook'](_0x2129bb){const _0xe66d63=a39_0x40eda9;console[_0xe66d63(0x183)](_0xe66d63(0x16a),_0x2129bb);let _0x50799c=_0xe66d63(0x132);switch(_0x2129bb['status']?.[_0xe66d63(0x12c)]()){case _0xe66d63(0x16c):case _0xe66d63(0x14a):case _0xe66d63(0x162):case _0xe66d63(0x189):case _0xe66d63(0x194):_0x50799c=_0xe66d63(0x17a);break;case _0xe66d63(0x113):case _0xe66d63(0x18e):case _0xe66d63(0x126):case _0xe66d63(0x17e):case _0xe66d63(0x187):_0x50799c=_0xe66d63(0x18c);break;case _0xe66d63(0x18a):case _0xe66d63(0x13a):_0x50799c=_0xe66d63(0x106);break;case _0xe66d63(0x14b):case _0xe66d63(0x107):case _0xe66d63(0x150):case _0xe66d63(0x116):case _0xe66d63(0x16d):default:_0x50799c=_0xe66d63(0x132);break;}return{'paymentId':_0x2129bb['reference']||_0x2129bb[_0xe66d63(0x177)]||_0x2129bb[_0xe66d63(0x180)],'status':_0x50799c,'amount':_0x2129bb['amount'],'currency':_0x2129bb[_0xe66d63(0x105)],'region':_0x2129bb[_0xe66d63(0x18b)],'additionalInfo':{'payment_method':_0x2129bb[_0xe66d63(0x139)],'transaction_id':_0x2129bb[_0xe66d63(0x157)]}};}}function a39_0x147d(){const _0x116072=['call','failed','/create','get','\x20API:\x20','Parsed\x20Result:','Response\x20data:','toLowerCase','/verify/','\x20API\x20error:\x20','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','1801090QNpbTY','\x20payment\x20verification\x20error:','PENDING','Invalid\x20response\x20from\x20KLYME\x20','36831933PFjvbk','parse','stringify','text','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','payment_method','timeout','resolve','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','Unknown\x20error','\x20API\x20ERROR\x20===','__createBinding','===\x20KLYME\x20','status','Error\x20stack:','logWhiteDomainError','GBP','(validated\x20for\x20',',\x20body:\x20','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','loggerService','completed','pending','URL:','length','Status\x20Text:','\x20currency\x20validation\x20passed:\x20','active','1040064Ajqtjj','__setModuleDefault','\x20validated)','\x20SUCCESS\x20(Legacy\x20Format)\x20===','Reference\x20Used:','Currency:','transaction_id','509949pxRrjO','__importStar','default','https://tesoft.uk/gateway/klyme/','getOwnPropertyDescriptor','Redirect\x20URL:','143970BEeXhD','hasOwnProperty','7328385aFCEQv','application/json','confirmed','POST','statusCode','toUpperCase','apiUrl','5295984mGFsjk','\x20SERVICE\x20ERROR\x20===','json','Processing\x20KLYME\x20webhook:','message','paid','in_progress','redirect_url','then','15xOpJKJ','Failed\x20to\x20create\x20KLYME\x20','getOwnPropertyNames','authUrl','\x20SUCCESS\x20(New\x20Format)\x20===','statusText','\x20payment\x20link:\x20Unknown\x20error','order_id','KLYME\x20','10rpeRgn','PAID','now','Business\x20Error:\x20','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','error','EUR','payment_id','padStart','Response\x20Body:','log','Error\x20details:','verifyPayment','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','rejected','findFirst','success','expired','region','FAILED','uuid','canceled','../../config/database','Currency\x20Used:','random','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','entries','successful','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','Failed\x20to\x20parse\x20JSON\x20response:','\x20API\x20BUSINESS\x20ERROR\x20===','Response\x20Time:','currency','EXPIRED','created','HTTP\x20Status:','Headers:','KlymeService','create','Raw\x20Response\x20Body:','\x20payment\x20link:\x20','\x20payment:\x20','klyme_','logWhiteDomainResponse','generateUniqueReference','configurable','cancelled','validateCurrencyForRegion','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','processing','TesSoft\x20Payment\x20System/1.0','‚ö†Ô∏è\x20KLYME\x20reference\x20','__esModule','\x20(8digits-8digits\x20format\x20for\x20','\x20API','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Error\x20message:','payment','(8digits-8digits\x20format)','\x20API:\x20missing\x20payment\x20data','77WgACBU','toString','defineProperty','Unknown\x20error\x20from\x20KLYME\x20'];a39_0x147d=function(){return _0x116072;};return a39_0x147d();}exports[a39_0x40eda9(0x10a)]=KlymeService;