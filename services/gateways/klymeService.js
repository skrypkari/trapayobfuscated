'use strict';const a67_0x10f8cf=a67_0x107f;(function(_0x3ec6b4,_0x1e37dd){const _0x4f37c9=a67_0x107f,_0x30cb96=_0x3ec6b4();while(!![]){try{const _0x5b0ae1=parseInt(_0x4f37c9(0x244))/0x1+-parseInt(_0x4f37c9(0x21e))/0x2+-parseInt(_0x4f37c9(0x22a))/0x3+parseInt(_0x4f37c9(0x263))/0x4+-parseInt(_0x4f37c9(0x1fe))/0x5+parseInt(_0x4f37c9(0x1ed))/0x6*(-parseInt(_0x4f37c9(0x270))/0x7)+parseInt(_0x4f37c9(0x220))/0x8;if(_0x5b0ae1===_0x1e37dd)break;else _0x30cb96['push'](_0x30cb96['shift']());}catch(_0x38fd9a){_0x30cb96['push'](_0x30cb96['shift']());}}}(a67_0x2a09,0x62c00));var __createBinding=this&&this['__createBinding']||(Object[a67_0x10f8cf(0x1f9)]?function(_0x5a1eef,_0x2b3bd3,_0x5951ca,_0x106700){const _0x27336d=a67_0x10f8cf;if(_0x106700===undefined)_0x106700=_0x5951ca;var _0x24920a=Object[_0x27336d(0x268)](_0x2b3bd3,_0x5951ca);(!_0x24920a||('get'in _0x24920a?!_0x2b3bd3[_0x27336d(0x210)]:_0x24920a['writable']||_0x24920a[_0x27336d(0x265)]))&&(_0x24920a={'enumerable':!![],'get':function(){return _0x2b3bd3[_0x5951ca];}}),Object[_0x27336d(0x202)](_0x5a1eef,_0x106700,_0x24920a);}:function(_0x381e6e,_0x9f628a,_0x58bdb0,_0x414e7a){if(_0x414e7a===undefined)_0x414e7a=_0x58bdb0;_0x381e6e[_0x414e7a]=_0x9f628a[_0x58bdb0];}),__setModuleDefault=this&&this[a67_0x10f8cf(0x233)]||(Object[a67_0x10f8cf(0x1f9)]?function(_0x31e716,_0x25e152){const _0x2f5a9c=a67_0x10f8cf;Object[_0x2f5a9c(0x202)](_0x31e716,'default',{'enumerable':!![],'value':_0x25e152});}:function(_0x339deb,_0xe58573){_0x339deb['default']=_0xe58573;}),__importStar=this&&this[a67_0x10f8cf(0x20a)]||(function(){var _0x38390d=function(_0x23bac2){const _0x11f901=a67_0x107f;return _0x38390d=Object[_0x11f901(0x26a)]||function(_0x41b7b3){var _0x406281=[];for(var _0x1ae945 in _0x41b7b3)if(Object['prototype']['hasOwnProperty']['call'](_0x41b7b3,_0x1ae945))_0x406281[_0x406281['length']]=_0x1ae945;return _0x406281;},_0x38390d(_0x23bac2);};return function(_0x484ab3){const _0x3966a6=a67_0x107f;if(_0x484ab3&&_0x484ab3[_0x3966a6(0x210)])return _0x484ab3;var _0x1d8dbb={};if(_0x484ab3!=null){for(var _0xf6433a=_0x38390d(_0x484ab3),_0x1cc704=0x0;_0x1cc704<_0xf6433a[_0x3966a6(0x1fa)];_0x1cc704++)if(_0xf6433a[_0x1cc704]!==_0x3966a6(0x243))__createBinding(_0x1d8dbb,_0x484ab3,_0xf6433a[_0x1cc704]);}return __setModuleDefault(_0x1d8dbb,_0x484ab3),_0x1d8dbb;};}());Object[a67_0x10f8cf(0x202)](exports,a67_0x10f8cf(0x210),{'value':!![]}),exports[a67_0x10f8cf(0x1f1)]=void 0x0;const loggerService_1=require(a67_0x10f8cf(0x24c));function a67_0x107f(_0x466a77,_0x30cacd){_0x466a77=_0x466a77-0x1e6;const _0x2a09ec=a67_0x2a09();let _0x107f3c=_0x2a09ec[_0x466a77];return _0x107f3c;}function a67_0x2a09(){const _0x2dc2e2=['loggerService','__setModuleDefault','POST','üí≥\x20KLYME\x20','../../config/database','Payment\x20System/1.0','Status\x20Text:','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','HTTP\x20','authUrl','\x20currency\x20validation\x20passed:\x20','timeout','\x20API\x20ERROR\x20===','Failed\x20to\x20create\x20KLYME\x20','(8digits-8digits\x20format)','FAILED','default','448238MPTCTQ','UUID:','resolve','created','logWhiteDomainError','Auth\x20URL:','Failed\x20to\x20verify\x20KLYME\x20','Error\x20stack:','../loggerService','klyme_','\x20SERVICE\x20ERROR\x20===','message','\x20payment\x20verification\x20error:','Unknown\x20error\x20from\x20KLYME\x20','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','reference','apiUrl','https://tesoft.uk/gateway/pending.php?id=','order_id','Currency\x20Used:','status','\x20API:\x20missing\x20payment\x20data','Reference:','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','text','Region\x20(geo):','in_progress','successful','payment_method','Error\x20Message:','confirmed','2900108qsjYxQ','toLowerCase','configurable','toString','canceled','getOwnPropertyDescriptor','findFirst','getOwnPropertyNames','rejected','Response\x20data:','JSON\x20Parse\x20Error:\x20','statusCode','Reference\x20Used\x20as\x20ID:','406yuvlOP','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','stringify','Raw\x20Response\x20Body:','\x20API','application/json','/verify/','EUR','Parsed\x20Result:','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','\x20API:\x20','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','Status:','Unsupported\x20KLYME\x20region:\x20','===\x20KLYME\x20','entries','Error\x20details:','headers','KLYME\x20','69108pgVWYv','statusText','Currency:','active','KlymeService','\x20validated)','region','redirect_url','generateUniqueReference','transaction_id','Unknown\x20error','Headers:','create','length','random','\x20SUCCESS\x20(New\x20Format)\x20===','validateCurrencyForRegion','2858940TDdixk','https://tesoft.uk/gateway/klyme/','\x20payment:\x20','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','defineProperty','Status\x20Code:','parse','logWhiteDomainRequest','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','HTTP\x20error!\x20status:\x20','expired','Redirect\x20URL:','__importStar','Failed\x20to\x20parse\x20JSON\x20response:','Business\x20Error:\x20','log','HTTP\x20Status:','payment','__esModule','===\x20PARSED\x20KLYME\x20','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','error','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','amount','processWebhook','/create','PENDING','createPaymentLink','toUpperCase','fromEntries','GBP','176106tzpMXP','\x20payment\x20link:\x20Unknown\x20error','6330520qQzuzy','Processing\x20KLYME\x20webhook:','\x20API\x20error:\x20','\x20API\x20BUSINESS\x20ERROR\x20===','failed','\x20payment\x20link:\x20','now','payment_id','logWhiteDomainResponse','stack','696645afQPGK','uuid','\x20SUCCESS\x20(Legacy\x20Format)\x20===','paid','URL:','completed','cancelled','Invalid\x20JSON\x20response\x20from\x20KLYME\x20'];a67_0x2a09=function(){return _0x2dc2e2;};return a67_0x2a09();}class KlymeService{constructor(){const _0x35a8d3=a67_0x10f8cf;this[_0x35a8d3(0x254)]=_0x35a8d3(0x1ff),console[_0x35a8d3(0x20d)](_0x35a8d3(0x214));}[a67_0x10f8cf(0x1fd)](_0x520dea,_0x47e729){const _0x5a3096=a67_0x10f8cf,_0x49275b=_0x520dea[_0x5a3096(0x21b)]();switch(_0x47e729){case'EU':if(_0x49275b!==_0x5a3096(0x277))throw new Error(_0x5a3096(0x239)+_0x49275b);break;case'GB':if(_0x49275b!==_0x5a3096(0x21d))throw new Error(_0x5a3096(0x201)+_0x49275b);break;case'DE':if(_0x49275b!=='EUR')throw new Error(_0x5a3096(0x25b)+_0x49275b);break;default:throw new Error(_0x5a3096(0x1e7)+_0x47e729);}}async[a67_0x10f8cf(0x1f5)](){const _0x43266a=a67_0x10f8cf,_0x4dbfb1=(await Promise[_0x43266a(0x246)]()['then'](()=>__importStar(require(_0x43266a(0x236)))))[_0x43266a(0x243)];let _0x4be59d,_0x1d2b97=0x0;const _0x193683=0xa;do{const _0x5c77ab=()=>{const _0x2b6f0a=_0x43266a;return Math['floor'](Math[_0x2b6f0a(0x1fb)]()*0x5f5e100)[_0x2b6f0a(0x266)]()['padStart'](0x8,'0');};_0x4be59d=_0x5c77ab()+'-'+_0x5c77ab();const _0x4cc697=await _0x4dbfb1[_0x43266a(0x20f)][_0x43266a(0x269)]({'where':{'gatewayOrderId':_0x4be59d}});if(!_0x4cc697)break;_0x1d2b97++,console[_0x43266a(0x20d)]('‚ö†Ô∏è\x20KLYME\x20reference\x20'+_0x4be59d+_0x43266a(0x271)+_0x1d2b97+')');}while(_0x1d2b97<_0x193683);if(_0x1d2b97>=_0x193683)throw new Error(_0x43266a(0x252));return _0x4be59d;}async[a67_0x10f8cf(0x21a)](_0x1416a6){const _0xce31e=a67_0x10f8cf,{orderId:_0x521527,amount:_0x26abd4,currency:_0x29358c,region:_0x5d6e13}=_0x1416a6;if(_0x5d6e13!=='EU'&&_0x5d6e13!=='GB'&&_0x5d6e13!=='DE')throw new Error(_0xce31e(0x279)+_0x5d6e13);this['validateCurrencyForRegion'](_0x29358c,_0x5d6e13);const _0x42c74d=_0x29358c[_0xce31e(0x21b)]();console['log'](_0xce31e(0x235)+_0x5d6e13+_0xce31e(0x23d)+_0x42c74d);const _0x54cffd=await this['generateUniqueReference']();console[_0xce31e(0x20d)](_0xce31e(0x27b)+_0x54cffd+'\x20(8digits-8digits\x20format\x20for\x20'+_0x5d6e13+')');const _0xccd8a=_0xce31e(0x255)+_0x521527,_0x5a7f99={'amount':_0x26abd4,'currency':_0x42c74d,'redirectUrl':_0xccd8a,'reference':_0x54cffd,'geo':_0x5d6e13},_0x55b508=Date[_0xce31e(0x226)]();try{console[_0xce31e(0x20d)](_0xce31e(0x1e8)+_0x5d6e13+_0xce31e(0x23a)),console[_0xce31e(0x20d)](_0xce31e(0x22e),this[_0xce31e(0x254)]),console[_0xce31e(0x20d)]('Request\x20Body:',JSON[_0xce31e(0x272)](_0x5a7f99,null,0x2)),console['log'](_0xce31e(0x25d),_0x5d6e13),console[_0xce31e(0x20d)](_0xce31e(0x1ef),_0x42c74d,'(validated\x20for\x20'+_0x5d6e13+')'),console[_0xce31e(0x20d)](_0xce31e(0x25a),_0x54cffd,_0xce31e(0x241)),console[_0xce31e(0x20d)](_0xce31e(0x209),_0xccd8a),loggerService_1['loggerService'][_0xce31e(0x205)](_0xce31e(0x24d)+_0x5d6e13['toLowerCase'](),_0xce31e(0x218),_0xce31e(0x234),_0x5a7f99);const _0x539d78=await fetch(this[_0xce31e(0x254)],{'method':_0xce31e(0x234),'headers':{'Content-Type':_0xce31e(0x275),'Accept':'application/json','User-Agent':_0xce31e(0x237)},'body':JSON[_0xce31e(0x272)](_0x5a7f99)}),_0x4c04c7=Date['now']()-_0x55b508;console[_0xce31e(0x20d)]('===\x20KLYME\x20'+_0x5d6e13+_0xce31e(0x206)),console[_0xce31e(0x20d)](_0xce31e(0x1e6),_0x539d78[_0xce31e(0x258)]),console[_0xce31e(0x20d)](_0xce31e(0x238),_0x539d78[_0xce31e(0x1ee)]),console[_0xce31e(0x20d)](_0xce31e(0x1f8),Object[_0xce31e(0x21c)](_0x539d78[_0xce31e(0x1eb)][_0xce31e(0x1e9)]())),console[_0xce31e(0x20d)]('Response\x20Time:',_0x4c04c7+'ms');const _0x25fa5b=await _0x539d78['text']();console[_0xce31e(0x20d)](_0xce31e(0x273),_0x25fa5b);if(!_0x539d78['ok']){console[_0xce31e(0x213)](_0xce31e(0x1e8)+_0x5d6e13+_0xce31e(0x23f)),console[_0xce31e(0x213)](_0xce31e(0x20e),_0x539d78[_0xce31e(0x258)]),console['error']('Response\x20Body:',_0x25fa5b),loggerService_1[_0xce31e(0x232)][_0xce31e(0x228)](_0xce31e(0x24d)+_0x5d6e13['toLowerCase'](),_0xce31e(0x218),_0x539d78[_0xce31e(0x258)],_0x25fa5b,_0x4c04c7),loggerService_1['loggerService'][_0xce31e(0x248)]('klyme_'+_0x5d6e13['toLowerCase'](),_0xce31e(0x218),_0xce31e(0x23b)+_0x539d78['status']+':\x20'+_0x25fa5b);throw new Error(_0xce31e(0x207)+_0x539d78[_0xce31e(0x258)]+',\x20body:\x20'+_0x25fa5b);}let _0x4e6aa0;try{_0x4e6aa0=JSON[_0xce31e(0x204)](_0x25fa5b);}catch(_0x4b3db6){console[_0xce31e(0x213)](_0xce31e(0x20b),_0x4b3db6),loggerService_1[_0xce31e(0x232)][_0xce31e(0x248)](_0xce31e(0x24d)+_0x5d6e13[_0xce31e(0x264)](),_0xce31e(0x218),_0xce31e(0x26d)+_0x4b3db6);throw new Error(_0xce31e(0x231)+_0x5d6e13+_0xce31e(0x27a)+_0x25fa5b);}console['log'](_0xce31e(0x211)+_0x5d6e13+'\x20RESPONSE\x20==='),console[_0xce31e(0x20d)](_0xce31e(0x278),JSON[_0xce31e(0x272)](_0x4e6aa0,null,0x2)),loggerService_1[_0xce31e(0x232)][_0xce31e(0x228)]('klyme_'+_0x5d6e13['toLowerCase'](),_0xce31e(0x218),_0x539d78[_0xce31e(0x258)],_0x4e6aa0,_0x4c04c7);if(_0x4e6aa0[_0xce31e(0x213)]||_0x4e6aa0['statusCode']){const _0x3885cc=_0x4e6aa0['message']||_0x4e6aa0['error']||_0xce31e(0x251)+_0x5d6e13+_0xce31e(0x274);console['error']('===\x20KLYME\x20'+_0x5d6e13+_0xce31e(0x223)),console[_0xce31e(0x213)](_0xce31e(0x261),_0x3885cc),console[_0xce31e(0x213)](_0xce31e(0x203),_0x4e6aa0[_0xce31e(0x26e)]),loggerService_1[_0xce31e(0x232)][_0xce31e(0x248)]('klyme_'+_0x5d6e13['toLowerCase'](),_0xce31e(0x218),_0xce31e(0x20c)+_0x3885cc);throw new Error(_0xce31e(0x1ec)+_0x5d6e13+'\x20API\x20error:\x20'+_0x3885cc);}let _0x5072d0,_0x1cc7e2;if(_0x4e6aa0[_0xce31e(0x22b)]&&_0x4e6aa0[_0xce31e(0x1f4)])_0x5072d0=_0x4e6aa0[_0xce31e(0x22b)],_0x1cc7e2=_0x4e6aa0[_0xce31e(0x1f4)],console[_0xce31e(0x20d)](_0xce31e(0x1e8)+_0x5d6e13+_0xce31e(0x1fc)),console[_0xce31e(0x20d)](_0xce31e(0x245),_0x4e6aa0[_0xce31e(0x22b)]),console[_0xce31e(0x20d)](_0xce31e(0x209),_0x4e6aa0[_0xce31e(0x1f4)]);else{if(_0x4e6aa0['authUrl'])_0x5072d0=_0x54cffd,_0x1cc7e2=_0x4e6aa0['authUrl'],console[_0xce31e(0x20d)]('===\x20KLYME\x20'+_0x5d6e13+_0xce31e(0x22c)),console['log'](_0xce31e(0x249),_0x4e6aa0[_0xce31e(0x23c)]),console['log'](_0xce31e(0x26f),_0x54cffd);else{console['error'](_0xce31e(0x1e8)+_0x5d6e13+_0xce31e(0x212)),console[_0xce31e(0x213)](_0xce31e(0x215)),console['error'](_0xce31e(0x26c),_0x4e6aa0),loggerService_1[_0xce31e(0x232)]['logWhiteDomainError'](_0xce31e(0x24d)+_0x5d6e13[_0xce31e(0x264)](),'/create','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl');throw new Error('Invalid\x20response\x20from\x20KLYME\x20'+_0x5d6e13+_0xce31e(0x259));}}return console[_0xce31e(0x20d)](_0xce31e(0x257),_0x42c74d,'('+_0x5d6e13+_0xce31e(0x1f2)),console['log']('Reference\x20Used:',_0x54cffd,_0xce31e(0x241)),console['log']('Geo\x20Parameter:',_0x5d6e13),{'gateway_payment_id':_0x5072d0,'payment_url':_0x1cc7e2};}catch(_0x6119c4){console['error'](_0xce31e(0x1e8)+_0x5d6e13+_0xce31e(0x24e)),console[_0xce31e(0x213)](_0xce31e(0x1ea),_0x6119c4),loggerService_1[_0xce31e(0x232)]['logWhiteDomainError']('klyme_'+_0x5d6e13[_0xce31e(0x264)](),'/create',_0x6119c4);if(_0x6119c4 instanceof Error){console[_0xce31e(0x213)]('Error\x20message:',_0x6119c4[_0xce31e(0x24f)]),console['error'](_0xce31e(0x24b),_0x6119c4[_0xce31e(0x229)]);throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0x5d6e13+_0xce31e(0x225)+_0x6119c4['message']);}throw new Error(_0xce31e(0x240)+_0x5d6e13+_0xce31e(0x21f));}}async['verifyPayment'](_0x2702fe,_0x4eb989){const _0x3117c8=a67_0x10f8cf,_0x3dd966=Date[_0x3117c8(0x226)]();try{const _0x36c972={'gatewayPaymentId':_0x2702fe,'geo':_0x4eb989};loggerService_1[_0x3117c8(0x232)][_0x3117c8(0x205)](_0x3117c8(0x24d)+_0x4eb989['toLowerCase'](),'/verify/'+_0x2702fe,'POST',_0x36c972);const _0x3cc0f4=await fetch(this[_0x3117c8(0x254)],{'method':_0x3117c8(0x234),'headers':{'Content-Type':_0x3117c8(0x275),'User-Agent':_0x3117c8(0x237)},'body':JSON[_0x3117c8(0x272)](_0x36c972)}),_0x57b73b=Date[_0x3117c8(0x226)]()-_0x3dd966;if(!_0x3cc0f4['ok']){const _0x2c6de1=await _0x3cc0f4[_0x3117c8(0x25c)]();loggerService_1[_0x3117c8(0x232)]['logWhiteDomainResponse'](_0x3117c8(0x24d)+_0x4eb989[_0x3117c8(0x264)](),_0x3117c8(0x276)+_0x2702fe,_0x3cc0f4[_0x3117c8(0x258)],_0x2c6de1,_0x57b73b);throw new Error('HTTP\x20error!\x20status:\x20'+_0x3cc0f4[_0x3117c8(0x258)]);}const _0x44d0c0=await _0x3cc0f4['json']();loggerService_1[_0x3117c8(0x232)][_0x3117c8(0x228)](_0x3117c8(0x24d)+_0x4eb989[_0x3117c8(0x264)](),_0x3117c8(0x276)+_0x2702fe,_0x3cc0f4['status'],_0x44d0c0,_0x57b73b);if(_0x44d0c0[_0x3117c8(0x213)]||_0x44d0c0['statusCode']){loggerService_1[_0x3117c8(0x232)][_0x3117c8(0x248)]('klyme_'+_0x4eb989[_0x3117c8(0x264)](),_0x3117c8(0x276)+_0x2702fe,_0x3117c8(0x1ec)+_0x4eb989+_0x3117c8(0x222)+(_0x44d0c0[_0x3117c8(0x24f)]||_0x44d0c0['error']||_0x3117c8(0x1f7)));throw new Error(_0x3117c8(0x1ec)+_0x4eb989+_0x3117c8(0x222)+(_0x44d0c0[_0x3117c8(0x24f)]||_0x44d0c0[_0x3117c8(0x213)]||_0x3117c8(0x1f7)));}let _0x5ab387=_0x3117c8(0x219);return{'status':_0x5ab387};}catch(_0x81ecb8){console[_0x3117c8(0x213)](_0x3117c8(0x1ec)+_0x4eb989+_0x3117c8(0x250),_0x81ecb8),loggerService_1[_0x3117c8(0x232)][_0x3117c8(0x248)](_0x3117c8(0x24d)+_0x4eb989[_0x3117c8(0x264)](),_0x3117c8(0x276)+_0x2702fe,_0x81ecb8);throw new Error(_0x3117c8(0x24a)+_0x4eb989+_0x3117c8(0x200)+(_0x81ecb8 instanceof Error?_0x81ecb8['message']:'Unknown\x20error'));}}async[a67_0x10f8cf(0x217)](_0x501c05){const _0x32e05f=a67_0x10f8cf;console['log'](_0x32e05f(0x221),_0x501c05);let _0x1b5741=_0x32e05f(0x219);switch(_0x501c05['status']?.['toLowerCase']()){case _0x32e05f(0x22d):case _0x32e05f(0x22f):case _0x32e05f(0x262):case'success':case _0x32e05f(0x25f):_0x1b5741='PAID';break;case _0x32e05f(0x230):case _0x32e05f(0x267):case _0x32e05f(0x224):case _0x32e05f(0x213):case _0x32e05f(0x26b):_0x1b5741=_0x32e05f(0x242);break;case _0x32e05f(0x208):case _0x32e05f(0x23e):_0x1b5741='EXPIRED';break;case'pending':case _0x32e05f(0x247):case _0x32e05f(0x1f0):case'processing':case _0x32e05f(0x25e):default:_0x1b5741=_0x32e05f(0x219);break;}return{'paymentId':_0x501c05[_0x32e05f(0x253)]||_0x501c05[_0x32e05f(0x256)]||_0x501c05[_0x32e05f(0x227)],'status':_0x1b5741,'amount':_0x501c05[_0x32e05f(0x216)],'currency':_0x501c05['currency'],'region':_0x501c05[_0x32e05f(0x1f3)],'additionalInfo':{'payment_method':_0x501c05[_0x32e05f(0x260)],'transaction_id':_0x501c05[_0x32e05f(0x1f6)]}};}}exports[a67_0x10f8cf(0x1f1)]=KlymeService;