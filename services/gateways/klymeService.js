'use strict';const a42_0x377a52=a42_0x10f9;(function(_0x1be0cc,_0x1cba75){const _0x240ad2=a42_0x10f9,_0x4ff6d3=_0x1be0cc();while(!![]){try{const _0x36f49a=-parseInt(_0x240ad2(0x217))/0x1+parseInt(_0x240ad2(0x242))/0x2+parseInt(_0x240ad2(0x238))/0x3+-parseInt(_0x240ad2(0x20a))/0x4*(-parseInt(_0x240ad2(0x24b))/0x5)+parseInt(_0x240ad2(0x206))/0x6*(parseInt(_0x240ad2(0x262))/0x7)+-parseInt(_0x240ad2(0x1f1))/0x8*(-parseInt(_0x240ad2(0x243))/0x9)+-parseInt(_0x240ad2(0x252))/0xa;if(_0x36f49a===_0x1cba75)break;else _0x4ff6d3['push'](_0x4ff6d3['shift']());}catch(_0x38cccd){_0x4ff6d3['push'](_0x4ff6d3['shift']());}}}(a42_0x34ba,0xe3f49));function a42_0x10f9(_0x3d6738,_0x44a653){const _0x34ba9f=a42_0x34ba();return a42_0x10f9=function(_0x10f92b,_0x175857){_0x10f92b=_0x10f92b-0x1e0;let _0x459dd8=_0x34ba9f[_0x10f92b];return _0x459dd8;},a42_0x10f9(_0x3d6738,_0x44a653);}function a42_0x34ba(){const _0x4eefec=['toLowerCase','payment','failed','Auth\x20URL:','prototype','json','245777ZIceHx','URL:','\x20SERVICE\x20ERROR\x20===','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','Invalid\x20response\x20from\x20KLYME\x20','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','üí≥\x20KLYME\x20','create','\x20payment\x20verification\x20error:','Error\x20message:','\x20SUCCESS\x20(New\x20Format)\x20===','reference','validateCurrencyForRegion','apiUrl','/verify/','(validated\x20for\x20','Response\x20Time:','PAID','hasOwnProperty','defineProperty','order_id','logWhiteDomainResponse','Redirect\x20URL:','now','Request\x20Body:','EUR','log','processing','/create','error','KlymeService','entries','logWhiteDomainRequest','currency','Headers:','active','26024YoUWlJ','Response\x20Body:','__esModule','__setModuleDefault','__importStar','KLYME\x20','getOwnPropertyNames','Failed\x20to\x20create\x20KLYME\x20','===\x20KLYME\x20','status','writable','(8digits-8digits\x20format)','\x20(8digits-8digits\x20format\x20for\x20','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','application/json','‚ö†Ô∏è\x20KLYME\x20reference\x20','toUpperCase','headers','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','PENDING','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','36vhiXXI','stringify','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','rejected','5260yIiMNe','loggerService','Raw\x20Response\x20Body:','amount','\x20API\x20error:\x20','random','configurable','floor','\x20API\x20BUSINESS\x20ERROR\x20===','Failed\x20to\x20parse\x20JSON\x20response:','Currency\x20Used:','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','../loggerService','428814SnUWoJ','length','generateUniqueReference','pending','successful','Unknown\x20error\x20from\x20KLYME\x20','padStart','\x20SUCCESS\x20(Legacy\x20Format)\x20===','GBP','payment_method','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','UUID:','Failed\x20to\x20verify\x20KLYME\x20','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','created','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','TesSoft\x20Payment\x20System/1.0','HTTP\x20error!\x20status:\x20','\x20payment\x20link:\x20','region','processWebhook','getOwnPropertyDescriptor','\x20payment\x20link:\x20Unknown\x20error','POST','Reference\x20Used\x20as\x20ID:','timeout','message','\x20API:\x20','Parsed\x20Result:','Region\x20(geo):','klyme_','stack','Unknown\x20error','3111975KqsoFA','default','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Business\x20Error:\x20','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','verifyPayment','fromEntries','Reference:','text','Error\x20details:','3442334xyMRGJ','3870sUddIw','statusCode','\x20currency\x20validation\x20passed:\x20','uuid','JSON\x20Parse\x20Error:\x20','\x20API\x20ERROR\x20===','Reference\x20Used:','Error\x20stack:','5745nDvdko','confirmed','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','Response\x20data:','payment_id','in_progress','Currency:','45163640epPyxp','transaction_id','logWhiteDomainError','redirect_url','toString','../../config/database','then','===\x20PARSED\x20KLYME\x20','authUrl','success'];a42_0x34ba=function(){return _0x4eefec;};return a42_0x34ba();}var __createBinding=this&&this['__createBinding']||(Object[a42_0x377a52(0x269)]?function(_0x130d27,_0x15852f,_0x438823,_0x4a89c5){const _0x28b97a=a42_0x377a52;if(_0x4a89c5===undefined)_0x4a89c5=_0x438823;var _0x461512=Object[_0x28b97a(0x22c)](_0x15852f,_0x438823);(!_0x461512||('get'in _0x461512?!_0x15852f[_0x28b97a(0x1f3)]:_0x461512[_0x28b97a(0x1fb)]||_0x461512[_0x28b97a(0x210)]))&&(_0x461512={'enumerable':!![],'get':function(){return _0x15852f[_0x438823];}}),Object['defineProperty'](_0x130d27,_0x4a89c5,_0x461512);}:function(_0xe65ca7,_0x498b8c,_0x11ef28,_0x497e62){if(_0x497e62===undefined)_0x497e62=_0x11ef28;_0xe65ca7[_0x497e62]=_0x498b8c[_0x11ef28];}),__setModuleDefault=this&&this[a42_0x377a52(0x1f4)]||(Object[a42_0x377a52(0x269)]?function(_0x3e5c3f,_0x46df3e){const _0x55fece=a42_0x377a52;Object['defineProperty'](_0x3e5c3f,_0x55fece(0x239),{'enumerable':!![],'value':_0x46df3e});}:function(_0x4b2fcf,_0x2d3506){const _0x460bd4=a42_0x377a52;_0x4b2fcf[_0x460bd4(0x239)]=_0x2d3506;}),__importStar=this&&this[a42_0x377a52(0x1f5)]||(function(){var _0x438611=function(_0x47d922){const _0x4d8baa=a42_0x10f9;return _0x438611=Object[_0x4d8baa(0x1f7)]||function(_0x4ecf76){const _0x2ef073=_0x4d8baa;var _0x1367fe=[];for(var _0x348785 in _0x4ecf76)if(Object[_0x2ef073(0x260)][_0x2ef073(0x274)]['call'](_0x4ecf76,_0x348785))_0x1367fe[_0x1367fe[_0x2ef073(0x218)]]=_0x348785;return _0x1367fe;},_0x438611(_0x47d922);};return function(_0x21102a){const _0x5d30e3=a42_0x10f9;if(_0x21102a&&_0x21102a[_0x5d30e3(0x1f3)])return _0x21102a;var _0x39ec12={};if(_0x21102a!=null){for(var _0x485efd=_0x438611(_0x21102a),_0x15a6bb=0x0;_0x15a6bb<_0x485efd[_0x5d30e3(0x218)];_0x15a6bb++)if(_0x485efd[_0x15a6bb]!==_0x5d30e3(0x239))__createBinding(_0x39ec12,_0x21102a,_0x485efd[_0x15a6bb]);}return __setModuleDefault(_0x39ec12,_0x21102a),_0x39ec12;};}());Object[a42_0x377a52(0x1e0)](exports,a42_0x377a52(0x1f3),{'value':!![]}),exports[a42_0x377a52(0x1eb)]=void 0x0;const loggerService_1=require(a42_0x377a52(0x216));class KlymeService{constructor(){const _0x27ff9c=a42_0x377a52;this[_0x27ff9c(0x26f)]='https://tesoft.uk/gateway/klyme/',console[_0x27ff9c(0x1e7)](_0x27ff9c(0x265));}[a42_0x377a52(0x26e)](_0x481d82,_0x47c9c7){const _0x554967=a42_0x377a52,_0x9b98a=_0x481d82[_0x554967(0x201)]();switch(_0x47c9c7){case'EU':if(_0x9b98a!==_0x554967(0x1e6))throw new Error(_0x554967(0x205)+_0x9b98a);break;case'GB':if(_0x9b98a!==_0x554967(0x21f))throw new Error(_0x554967(0x208)+_0x9b98a);break;case'DE':if(_0x9b98a!==_0x554967(0x1e6))throw new Error(_0x554967(0x23a)+_0x9b98a);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x47c9c7);}}async['generateUniqueReference'](){const _0xc2d161=a42_0x377a52,_0x198ad4=(await Promise['resolve']()[_0xc2d161(0x258)](()=>__importStar(require(_0xc2d161(0x257)))))[_0xc2d161(0x239)];let _0x21ffe0,_0xbb889d=0x0;const _0x5e7e23=0xa;do{const _0x55b7dc=()=>{const _0x2064f2=_0xc2d161;return Math[_0x2064f2(0x211)](Math[_0x2064f2(0x20f)]()*0x5f5e100)[_0x2064f2(0x256)]()[_0x2064f2(0x21d)](0x8,'0');};_0x21ffe0=_0x55b7dc()+'-'+_0x55b7dc();const _0x13cdb2=await _0x198ad4[_0xc2d161(0x25d)]['findFirst']({'where':{'gatewayOrderId':_0x21ffe0}});if(!_0x13cdb2)break;_0xbb889d++,console['log'](_0xc2d161(0x200)+_0x21ffe0+_0xc2d161(0x226)+_0xbb889d+')');}while(_0xbb889d<_0x5e7e23);if(_0xbb889d>=_0x5e7e23)throw new Error(_0xc2d161(0x221));return _0x21ffe0;}async['createPaymentLink'](_0x289bad){const _0x482099=a42_0x377a52,{orderId:_0x42a572,amount:_0x25a9d6,currency:_0x49b9a7,region:_0x2ab647}=_0x289bad;if(_0x2ab647!=='EU'&&_0x2ab647!=='GB'&&_0x2ab647!=='DE')throw new Error(_0x482099(0x1fe)+_0x2ab647);this[_0x482099(0x26e)](_0x49b9a7,_0x2ab647);const _0x16ca10=_0x49b9a7[_0x482099(0x201)]();console['log'](_0x482099(0x268)+_0x2ab647+_0x482099(0x245)+_0x16ca10);const _0x2c2eb7=await this[_0x482099(0x219)]();console[_0x482099(0x1e7)](_0x482099(0x24d)+_0x2c2eb7+_0x482099(0x1fd)+_0x2ab647+')');const _0x476e8a='https://tesoft.uk/gateway/pending.php?id='+_0x42a572,_0x3d9b52={'amount':_0x25a9d6,'currency':_0x16ca10,'redirectUrl':_0x476e8a,'reference':_0x2c2eb7,'geo':_0x2ab647},_0x50c7d8=Date[_0x482099(0x1e4)]();try{console[_0x482099(0x1e7)]('===\x20KLYME\x20'+_0x2ab647+_0x482099(0x215)),console[_0x482099(0x1e7)](_0x482099(0x263),this[_0x482099(0x26f)]),console[_0x482099(0x1e7)](_0x482099(0x1e5),JSON['stringify'](_0x3d9b52,null,0x2)),console[_0x482099(0x1e7)](_0x482099(0x234),_0x2ab647),console[_0x482099(0x1e7)](_0x482099(0x251),_0x16ca10,_0x482099(0x271)+_0x2ab647+')'),console[_0x482099(0x1e7)](_0x482099(0x23f),_0x2c2eb7,'(8digits-8digits\x20format)'),console[_0x482099(0x1e7)](_0x482099(0x1e3),_0x476e8a),loggerService_1['loggerService'][_0x482099(0x1ed)](_0x482099(0x235)+_0x2ab647[_0x482099(0x25c)](),_0x482099(0x1e9),_0x482099(0x22e),_0x3d9b52);const _0x417b8f=await fetch(this[_0x482099(0x26f)],{'method':_0x482099(0x22e),'headers':{'Content-Type':'application/json','Accept':_0x482099(0x1ff),'User-Agent':_0x482099(0x227)},'body':JSON['stringify'](_0x3d9b52)}),_0x5a8b44=Date[_0x482099(0x1e4)]()-_0x50c7d8;console[_0x482099(0x1e7)](_0x482099(0x1f9)+_0x2ab647+_0x482099(0x267)),console['log']('Status:',_0x417b8f[_0x482099(0x1fa)]),console['log']('Status\x20Text:',_0x417b8f['statusText']),console[_0x482099(0x1e7)](_0x482099(0x1ef),Object[_0x482099(0x23e)](_0x417b8f[_0x482099(0x202)][_0x482099(0x1ec)]())),console[_0x482099(0x1e7)](_0x482099(0x272),_0x5a8b44+'ms');const _0x47a180=await _0x417b8f[_0x482099(0x240)]();console[_0x482099(0x1e7)](_0x482099(0x20c),_0x47a180);if(!_0x417b8f['ok']){console[_0x482099(0x1ea)]('===\x20KLYME\x20'+_0x2ab647+_0x482099(0x248)),console[_0x482099(0x1ea)]('HTTP\x20Status:',_0x417b8f[_0x482099(0x1fa)]),console[_0x482099(0x1ea)](_0x482099(0x1f2),_0x47a180),loggerService_1[_0x482099(0x20b)][_0x482099(0x1e2)](_0x482099(0x235)+_0x2ab647[_0x482099(0x25c)](),_0x482099(0x1e9),_0x417b8f['status'],_0x47a180,_0x5a8b44),loggerService_1[_0x482099(0x20b)][_0x482099(0x254)](_0x482099(0x235)+_0x2ab647[_0x482099(0x25c)](),_0x482099(0x1e9),'HTTP\x20'+_0x417b8f[_0x482099(0x1fa)]+':\x20'+_0x47a180);throw new Error(_0x482099(0x228)+_0x417b8f[_0x482099(0x1fa)]+',\x20body:\x20'+_0x47a180);}let _0x1a4e6a;try{_0x1a4e6a=JSON['parse'](_0x47a180);}catch(_0x5b0fb0){console[_0x482099(0x1ea)](_0x482099(0x213),_0x5b0fb0),loggerService_1[_0x482099(0x20b)]['logWhiteDomainError'](_0x482099(0x235)+_0x2ab647['toLowerCase'](),_0x482099(0x1e9),_0x482099(0x247)+_0x5b0fb0);throw new Error(_0x482099(0x23c)+_0x2ab647+_0x482099(0x232)+_0x47a180);}console[_0x482099(0x1e7)](_0x482099(0x259)+_0x2ab647+'\x20RESPONSE\x20==='),console[_0x482099(0x1e7)](_0x482099(0x233),JSON[_0x482099(0x207)](_0x1a4e6a,null,0x2)),loggerService_1[_0x482099(0x20b)]['logWhiteDomainResponse'](_0x482099(0x235)+_0x2ab647[_0x482099(0x25c)](),'/create',_0x417b8f[_0x482099(0x1fa)],_0x1a4e6a,_0x5a8b44);if(_0x1a4e6a[_0x482099(0x1ea)]||_0x1a4e6a[_0x482099(0x244)]){const _0x162cc4=_0x1a4e6a[_0x482099(0x231)]||_0x1a4e6a['error']||_0x482099(0x21c)+_0x2ab647+'\x20API';console[_0x482099(0x1ea)]('===\x20KLYME\x20'+_0x2ab647+_0x482099(0x212)),console[_0x482099(0x1ea)]('Error\x20Message:',_0x162cc4),console['error']('Status\x20Code:',_0x1a4e6a[_0x482099(0x244)]),loggerService_1[_0x482099(0x20b)][_0x482099(0x254)](_0x482099(0x235)+_0x2ab647[_0x482099(0x25c)](),'/create',_0x482099(0x23b)+_0x162cc4);throw new Error(_0x482099(0x1f6)+_0x2ab647+_0x482099(0x20e)+_0x162cc4);}let _0x184a38,_0x5202b2;if(_0x1a4e6a[_0x482099(0x246)]&&_0x1a4e6a[_0x482099(0x255)])_0x184a38=_0x1a4e6a['uuid'],_0x5202b2=_0x1a4e6a[_0x482099(0x255)],console[_0x482099(0x1e7)]('===\x20KLYME\x20'+_0x2ab647+_0x482099(0x26c)),console[_0x482099(0x1e7)](_0x482099(0x222),_0x1a4e6a[_0x482099(0x246)]),console[_0x482099(0x1e7)](_0x482099(0x1e3),_0x1a4e6a[_0x482099(0x255)]);else{if(_0x1a4e6a[_0x482099(0x25a)])_0x184a38=_0x2c2eb7,_0x5202b2=_0x1a4e6a['authUrl'],console[_0x482099(0x1e7)](_0x482099(0x1f9)+_0x2ab647+_0x482099(0x21e)),console[_0x482099(0x1e7)](_0x482099(0x25f),_0x1a4e6a[_0x482099(0x25a)]),console['log'](_0x482099(0x22f),_0x2c2eb7);else{console[_0x482099(0x1ea)]('===\x20KLYME\x20'+_0x2ab647+_0x482099(0x224)),console[_0x482099(0x1ea)](_0x482099(0x203)),console[_0x482099(0x1ea)](_0x482099(0x24e),_0x1a4e6a),loggerService_1[_0x482099(0x20b)][_0x482099(0x254)](_0x482099(0x235)+_0x2ab647[_0x482099(0x25c)](),_0x482099(0x1e9),'Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl');throw new Error(_0x482099(0x266)+_0x2ab647+'\x20API:\x20missing\x20payment\x20data');}}return console[_0x482099(0x1e7)](_0x482099(0x214),_0x16ca10,'('+_0x2ab647+'\x20validated)'),console['log'](_0x482099(0x249),_0x2c2eb7,_0x482099(0x1fc)),console[_0x482099(0x1e7)]('Geo\x20Parameter:',_0x2ab647),{'gateway_payment_id':_0x184a38,'payment_url':_0x5202b2};}catch(_0x2c957b){console[_0x482099(0x1ea)](_0x482099(0x1f9)+_0x2ab647+_0x482099(0x264)),console[_0x482099(0x1ea)](_0x482099(0x241),_0x2c957b),loggerService_1[_0x482099(0x20b)][_0x482099(0x254)](_0x482099(0x235)+_0x2ab647[_0x482099(0x25c)](),'/create',_0x2c957b);if(_0x2c957b instanceof Error){console['error'](_0x482099(0x26b),_0x2c957b[_0x482099(0x231)]),console[_0x482099(0x1ea)](_0x482099(0x24a),_0x2c957b[_0x482099(0x236)]);throw new Error(_0x482099(0x1f8)+_0x2ab647+_0x482099(0x229)+_0x2c957b[_0x482099(0x231)]);}throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0x2ab647+_0x482099(0x22d));}}async[a42_0x377a52(0x23d)](_0xa0bda0,_0x5d86b3){const _0x10ef84=a42_0x377a52,_0x45eaa5=Date[_0x10ef84(0x1e4)]();try{const _0x409c2d={'gatewayPaymentId':_0xa0bda0,'geo':_0x5d86b3};loggerService_1['loggerService']['logWhiteDomainRequest']('klyme_'+_0x5d86b3['toLowerCase'](),_0x10ef84(0x270)+_0xa0bda0,_0x10ef84(0x22e),_0x409c2d);const _0x5e30b4=await fetch(this[_0x10ef84(0x26f)],{'method':_0x10ef84(0x22e),'headers':{'Content-Type':_0x10ef84(0x1ff),'User-Agent':_0x10ef84(0x227)},'body':JSON['stringify'](_0x409c2d)}),_0x38195c=Date[_0x10ef84(0x1e4)]()-_0x45eaa5;if(!_0x5e30b4['ok']){const _0x53c021=await _0x5e30b4[_0x10ef84(0x240)]();loggerService_1['loggerService']['logWhiteDomainResponse'](_0x10ef84(0x235)+_0x5d86b3[_0x10ef84(0x25c)](),'/verify/'+_0xa0bda0,_0x5e30b4['status'],_0x53c021,_0x38195c);throw new Error(_0x10ef84(0x228)+_0x5e30b4['status']);}const _0x43d0d3=await _0x5e30b4[_0x10ef84(0x261)]();loggerService_1['loggerService'][_0x10ef84(0x1e2)]('klyme_'+_0x5d86b3['toLowerCase'](),'/verify/'+_0xa0bda0,_0x5e30b4[_0x10ef84(0x1fa)],_0x43d0d3,_0x38195c);if(_0x43d0d3[_0x10ef84(0x1ea)]||_0x43d0d3[_0x10ef84(0x244)]){loggerService_1[_0x10ef84(0x20b)]['logWhiteDomainError'](_0x10ef84(0x235)+_0x5d86b3['toLowerCase'](),_0x10ef84(0x270)+_0xa0bda0,_0x10ef84(0x1f6)+_0x5d86b3+_0x10ef84(0x20e)+(_0x43d0d3[_0x10ef84(0x231)]||_0x43d0d3[_0x10ef84(0x1ea)]||_0x10ef84(0x237)));throw new Error(_0x10ef84(0x1f6)+_0x5d86b3+_0x10ef84(0x20e)+(_0x43d0d3[_0x10ef84(0x231)]||_0x43d0d3['error']||_0x10ef84(0x237)));}let _0x2407e3=_0x10ef84(0x204);return{'status':_0x2407e3};}catch(_0x472af7){console['error'](_0x10ef84(0x1f6)+_0x5d86b3+_0x10ef84(0x26a),_0x472af7),loggerService_1[_0x10ef84(0x20b)]['logWhiteDomainError']('klyme_'+_0x5d86b3[_0x10ef84(0x25c)](),_0x10ef84(0x270)+_0xa0bda0,_0x472af7);throw new Error(_0x10ef84(0x223)+_0x5d86b3+'\x20payment:\x20'+(_0x472af7 instanceof Error?_0x472af7['message']:_0x10ef84(0x237)));}}async[a42_0x377a52(0x22b)](_0xba64e2){const _0x318239=a42_0x377a52;console['log']('Processing\x20KLYME\x20webhook:',_0xba64e2);let _0x228992='PENDING';switch(_0xba64e2[_0x318239(0x1fa)]?.[_0x318239(0x25c)]()){case'paid':case'completed':case _0x318239(0x24c):case _0x318239(0x25b):case _0x318239(0x21b):_0x228992=_0x318239(0x273);break;case'cancelled':case'canceled':case _0x318239(0x25e):case _0x318239(0x1ea):case _0x318239(0x209):_0x228992='FAILED';break;case'expired':case _0x318239(0x230):_0x228992='EXPIRED';break;case _0x318239(0x21a):case _0x318239(0x225):case _0x318239(0x1f0):case _0x318239(0x1e8):case _0x318239(0x250):default:_0x228992='PENDING';break;}return{'paymentId':_0xba64e2[_0x318239(0x26d)]||_0xba64e2[_0x318239(0x1e1)]||_0xba64e2[_0x318239(0x24f)],'status':_0x228992,'amount':_0xba64e2[_0x318239(0x20d)],'currency':_0xba64e2[_0x318239(0x1ee)],'region':_0xba64e2[_0x318239(0x22a)],'additionalInfo':{'payment_method':_0xba64e2[_0x318239(0x220)],'transaction_id':_0xba64e2[_0x318239(0x253)]}};}}exports[a42_0x377a52(0x1eb)]=KlymeService;