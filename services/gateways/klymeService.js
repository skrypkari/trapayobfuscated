'use strict';function a41_0x8e94(_0x2a1eba,_0x4daedb){const _0x378f86=a41_0x378f();return a41_0x8e94=function(_0x8e94b2,_0x33d7dd){_0x8e94b2=_0x8e94b2-0xc5;let _0x173f07=_0x378f86[_0x8e94b2];return _0x173f07;},a41_0x8e94(_0x2a1eba,_0x4daedb);}const a41_0x332036=a41_0x8e94;(function(_0x2f748d,_0x28e6fc){const _0x372799=a41_0x8e94,_0x5875ac=_0x2f748d();while(!![]){try{const _0x596824=-parseInt(_0x372799(0x137))/0x1+-parseInt(_0x372799(0x113))/0x2+-parseInt(_0x372799(0x14a))/0x3+-parseInt(_0x372799(0x10f))/0x4*(parseInt(_0x372799(0x14c))/0x5)+-parseInt(_0x372799(0x111))/0x6+parseInt(_0x372799(0x108))/0x7+parseInt(_0x372799(0x109))/0x8;if(_0x596824===_0x28e6fc)break;else _0x5875ac['push'](_0x5875ac['shift']());}catch(_0xbf5213){_0x5875ac['push'](_0x5875ac['shift']());}}}(a41_0x378f,0x84d86));var __createBinding=this&&this[a41_0x332036(0x119)]||(Object['create']?function(_0x407fd4,_0x283385,_0x2d626e,_0x176465){const _0x67326e=a41_0x332036;if(_0x176465===undefined)_0x176465=_0x2d626e;var _0xd51834=Object['getOwnPropertyDescriptor'](_0x283385,_0x2d626e);(!_0xd51834||(_0x67326e(0x127)in _0xd51834?!_0x283385['__esModule']:_0xd51834[_0x67326e(0x11a)]||_0xd51834[_0x67326e(0x13c)]))&&(_0xd51834={'enumerable':!![],'get':function(){return _0x283385[_0x2d626e];}}),Object[_0x67326e(0x104)](_0x407fd4,_0x176465,_0xd51834);}:function(_0x8ea4b7,_0x411d60,_0x1d979a,_0x21a92a){if(_0x21a92a===undefined)_0x21a92a=_0x1d979a;_0x8ea4b7[_0x21a92a]=_0x411d60[_0x1d979a];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x448705,_0x1f668b){const _0x1f169d=a41_0x332036;Object[_0x1f169d(0x104)](_0x448705,_0x1f169d(0x138),{'enumerable':!![],'value':_0x1f668b});}:function(_0x48c891,_0x4f5fa0){const _0x1e193c=a41_0x332036;_0x48c891[_0x1e193c(0x138)]=_0x4f5fa0;}),__importStar=this&&this[a41_0x332036(0x132)]||(function(){var _0x485ad8=function(_0x34c274){const _0xe60ae7=a41_0x8e94;return _0x485ad8=Object[_0xe60ae7(0x150)]||function(_0xdb63dc){const _0x40c9a3=_0xe60ae7;var _0x361033=[];for(var _0x241b3c in _0xdb63dc)if(Object[_0x40c9a3(0x148)]['hasOwnProperty'][_0x40c9a3(0xe6)](_0xdb63dc,_0x241b3c))_0x361033[_0x361033[_0x40c9a3(0x13d)]]=_0x241b3c;return _0x361033;},_0x485ad8(_0x34c274);};return function(_0x5103d3){const _0x34733b=a41_0x8e94;if(_0x5103d3&&_0x5103d3[_0x34733b(0x10b)])return _0x5103d3;var _0x39a455={};if(_0x5103d3!=null){for(var _0x3317ce=_0x485ad8(_0x5103d3),_0x168acc=0x0;_0x168acc<_0x3317ce['length'];_0x168acc++)if(_0x3317ce[_0x168acc]!==_0x34733b(0x138))__createBinding(_0x39a455,_0x5103d3,_0x3317ce[_0x168acc]);}return __setModuleDefault(_0x39a455,_0x5103d3),_0x39a455;};}());Object[a41_0x332036(0x104)](exports,a41_0x332036(0x10b),{'value':!![]}),exports[a41_0x332036(0xcc)]=void 0x0;const loggerService_1=require(a41_0x332036(0x154));function a41_0x378f(){const _0xae61f1=['1773303dCfTHr','29209728iipJhw','uuid','__esModule','/create','toLowerCase','status','19948KkhLXz','klyme_','522462cXoQeL','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','2045986nbvEJz','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','reference','json','Error\x20details:','Processing\x20KLYME\x20webhook:','__createBinding','writable','now','in_progress','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','stringify','Failed\x20to\x20parse\x20JSON\x20response:','\x20payment:\x20','statusCode','\x20SERVICE\x20ERROR\x20===','cancelled','Request\x20Body:','Currency\x20Used:','Unknown\x20error','get','\x20(8digits-8digits\x20format\x20for\x20','toString','\x20API:\x20missing\x20payment\x20data','success','logWhiteDomainRequest','text','stack','timeout','PAID','Response\x20data:','__importStar','loggerService','Error\x20Message:','Response\x20Time:','Region\x20(geo):','778053aFtTMg','default','KLYME\x20','\x20payment\x20verification\x20error:','Raw\x20Response\x20Body:','configurable','length','Error\x20message:','Response\x20Body:','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','\x20SUCCESS\x20(New\x20Format)\x20===','processWebhook','padStart','processing','(validated\x20for\x20','then','logWhiteDomainError','prototype','../../config/database','1708923inHseS','UUID:','905juKGdS','\x20validated)','Headers:','confirmed','getOwnPropertyNames','Currency:','createPaymentLink','authUrl','../loggerService','EUR','Failed\x20to\x20create\x20KLYME\x20','payment_id','\x20API','toUpperCase','expired','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','payment','KlymeService','statusText','Geo\x20Parameter:','floor','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','⚠️\x20KLYME\x20reference\x20','/verify/','PENDING','application/json','https://tesoft.uk/gateway/klyme/','Status:','Error\x20stack:','rejected','===\x20PARSED\x20KLYME\x20','===\x20KLYME\x20','POST','paid','URL:','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','https://tesoft.uk/gateway/pending.php?id=','\x20SUCCESS\x20(Legacy\x20Format)\x20===','Status\x20Code:','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','logWhiteDomainResponse','EXPIRED','entries','call','completed','redirect_url','canceled','JSON\x20Parse\x20Error:\x20','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','message','log','Redirect\x20URL:','GBP','Status\x20Text:','generateUniqueReference','Reference\x20Used:','Unknown\x20error\x20from\x20KLYME\x20','TesSoft\x20Payment\x20System/1.0','apiUrl','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','findFirst','FAILED','(8digits-8digits\x20format)','Invalid\x20response\x20from\x20KLYME\x20','transaction_id','currency','Parsed\x20Result:','Auth\x20URL:','error','validateCurrencyForRegion','region','order_id','defineProperty','\x20API\x20error:\x20','amount','active'];a41_0x378f=function(){return _0xae61f1;};return a41_0x378f();}class KlymeService{constructor(){const _0x3314d1=a41_0x332036;this[_0x3314d1(0xf5)]=_0x3314d1(0xd5),console[_0x3314d1(0xed)](_0x3314d1(0xe2));}[a41_0x332036(0x101)](_0x1cc2a4,_0x8a3466){const _0x4f3281=a41_0x332036,_0x240ada=_0x1cc2a4[_0x4f3281(0xc8)]();switch(_0x8a3466){case'EU':if(_0x240ada!==_0x4f3281(0x155))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x240ada);break;case'GB':if(_0x240ada!==_0x4f3281(0xef))throw new Error(_0x4f3281(0x112)+_0x240ada);break;case'DE':if(_0x240ada!==_0x4f3281(0x155))throw new Error(_0x4f3281(0x140)+_0x240ada);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x8a3466);}}async[a41_0x332036(0xf1)](){const _0x14cc6a=a41_0x332036,_0x495c60=(await Promise['resolve']()[_0x14cc6a(0x146)](()=>__importStar(require(_0x14cc6a(0x149)))))[_0x14cc6a(0x138)];let _0x56c394,_0xc6d83=0x0;const _0x3e3c04=0xa;do{const _0x182aef=()=>{const _0x1c1909=_0x14cc6a;return Math[_0x1c1909(0xcf)](Math['random']()*0x5f5e100)[_0x1c1909(0x129)]()[_0x1c1909(0x143)](0x8,'0');};_0x56c394=_0x182aef()+'-'+_0x182aef();const _0xcbb243=await _0x495c60[_0x14cc6a(0xcb)][_0x14cc6a(0xf8)]({'where':{'gatewayOrderId':_0x56c394}});if(!_0xcbb243)break;_0xc6d83++,console['log'](_0x14cc6a(0xd1)+_0x56c394+_0x14cc6a(0x11d)+_0xc6d83+')');}while(_0xc6d83<_0x3e3c04);if(_0xc6d83>=_0x3e3c04)throw new Error(_0x14cc6a(0x114));return _0x56c394;}async[a41_0x332036(0x152)](_0x3fcf1c){const _0x1cac79=a41_0x332036,{orderId:_0x4030a8,amount:_0x5dab90,currency:_0x4533d2,region:_0x12e2af}=_0x3fcf1c;if(_0x12e2af!=='EU'&&_0x12e2af!=='GB'&&_0x12e2af!=='DE')throw new Error(_0x1cac79(0xeb)+_0x12e2af);this[_0x1cac79(0x101)](_0x4533d2,_0x12e2af);const _0x5ed3dd=_0x4533d2['toUpperCase']();console[_0x1cac79(0xed)]('💳\x20KLYME\x20'+_0x12e2af+'\x20currency\x20validation\x20passed:\x20'+_0x5ed3dd);const _0x59aaa3=await this[_0x1cac79(0xf1)]();console[_0x1cac79(0xed)]('🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20'+_0x59aaa3+_0x1cac79(0x128)+_0x12e2af+')');const _0x858eae=_0x1cac79(0xdf)+_0x4030a8,_0x371159={'amount':_0x5dab90,'currency':_0x5ed3dd,'redirectUrl':_0x858eae,'reference':_0x59aaa3,'geo':_0x12e2af},_0x37c43c=Date[_0x1cac79(0x11b)]();try{console[_0x1cac79(0xed)](_0x1cac79(0xda)+_0x12e2af+_0x1cac79(0xde)),console['log'](_0x1cac79(0xdd),this[_0x1cac79(0xf5)]),console[_0x1cac79(0xed)](_0x1cac79(0x124),JSON[_0x1cac79(0x11e)](_0x371159,null,0x2)),console[_0x1cac79(0xed)](_0x1cac79(0x136),_0x12e2af),console[_0x1cac79(0xed)](_0x1cac79(0x151),_0x5ed3dd,_0x1cac79(0x145)+_0x12e2af+')'),console[_0x1cac79(0xed)]('Reference:',_0x59aaa3,'(8digits-8digits\x20format)'),console['log']('Redirect\x20URL:',_0x858eae),loggerService_1[_0x1cac79(0x133)][_0x1cac79(0x12c)]('klyme_'+_0x12e2af[_0x1cac79(0x10d)](),_0x1cac79(0x10c),_0x1cac79(0xdb),_0x371159);const _0x3913af=await fetch(this[_0x1cac79(0xf5)],{'method':'POST','headers':{'Content-Type':_0x1cac79(0xd4),'Accept':_0x1cac79(0xd4),'User-Agent':_0x1cac79(0xf4)},'body':JSON[_0x1cac79(0x11e)](_0x371159)}),_0x46d645=Date[_0x1cac79(0x11b)]()-_0x37c43c;console['log'](_0x1cac79(0xda)+_0x12e2af+_0x1cac79(0xd0)),console[_0x1cac79(0xed)](_0x1cac79(0xd6),_0x3913af[_0x1cac79(0x10e)]),console['log'](_0x1cac79(0xf0),_0x3913af[_0x1cac79(0xcd)]),console[_0x1cac79(0xed)](_0x1cac79(0x14e),Object['fromEntries'](_0x3913af['headers'][_0x1cac79(0xe5)]())),console['log'](_0x1cac79(0x135),_0x46d645+'ms');const _0x4b471d=await _0x3913af[_0x1cac79(0x12d)]();console[_0x1cac79(0xed)](_0x1cac79(0x13b),_0x4b471d);if(!_0x3913af['ok']){console[_0x1cac79(0x100)](_0x1cac79(0xda)+_0x12e2af+'\x20API\x20ERROR\x20==='),console[_0x1cac79(0x100)]('HTTP\x20Status:',_0x3913af[_0x1cac79(0x10e)]),console[_0x1cac79(0x100)](_0x1cac79(0x13f),_0x4b471d),loggerService_1[_0x1cac79(0x133)]['logWhiteDomainResponse'](_0x1cac79(0x110)+_0x12e2af[_0x1cac79(0x10d)](),_0x1cac79(0x10c),_0x3913af['status'],_0x4b471d,_0x46d645),loggerService_1[_0x1cac79(0x133)]['logWhiteDomainError'](_0x1cac79(0x110)+_0x12e2af['toLowerCase'](),_0x1cac79(0x10c),'HTTP\x20'+_0x3913af[_0x1cac79(0x10e)]+':\x20'+_0x4b471d);throw new Error('HTTP\x20error!\x20status:\x20'+_0x3913af[_0x1cac79(0x10e)]+',\x20body:\x20'+_0x4b471d);}let _0x17af4a;try{_0x17af4a=JSON['parse'](_0x4b471d);}catch(_0x346182){console[_0x1cac79(0x100)](_0x1cac79(0x11f),_0x346182),loggerService_1[_0x1cac79(0x133)]['logWhiteDomainError'](_0x1cac79(0x110)+_0x12e2af[_0x1cac79(0x10d)](),_0x1cac79(0x10c),_0x1cac79(0xea)+_0x346182);throw new Error(_0x1cac79(0xca)+_0x12e2af+'\x20API:\x20'+_0x4b471d);}console[_0x1cac79(0xed)](_0x1cac79(0xd9)+_0x12e2af+'\x20RESPONSE\x20==='),console['log'](_0x1cac79(0xfe),JSON['stringify'](_0x17af4a,null,0x2)),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x1cac79(0x110)+_0x12e2af[_0x1cac79(0x10d)](),_0x1cac79(0x10c),_0x3913af[_0x1cac79(0x10e)],_0x17af4a,_0x46d645);if(_0x17af4a[_0x1cac79(0x100)]||_0x17af4a[_0x1cac79(0x121)]){const _0x46338b=_0x17af4a['message']||_0x17af4a[_0x1cac79(0x100)]||_0x1cac79(0xf3)+_0x12e2af+_0x1cac79(0xc7);console[_0x1cac79(0x100)]('===\x20KLYME\x20'+_0x12e2af+'\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x1cac79(0x100)](_0x1cac79(0x134),_0x46338b),console['error'](_0x1cac79(0xe1),_0x17af4a[_0x1cac79(0x121)]),loggerService_1[_0x1cac79(0x133)][_0x1cac79(0x147)](_0x1cac79(0x110)+_0x12e2af[_0x1cac79(0x10d)](),_0x1cac79(0x10c),'Business\x20Error:\x20'+_0x46338b);throw new Error(_0x1cac79(0x139)+_0x12e2af+_0x1cac79(0x105)+_0x46338b);}let _0x6312ca,_0x4d6655;if(_0x17af4a[_0x1cac79(0x10a)]&&_0x17af4a[_0x1cac79(0xe8)])_0x6312ca=_0x17af4a[_0x1cac79(0x10a)],_0x4d6655=_0x17af4a[_0x1cac79(0xe8)],console[_0x1cac79(0xed)]('===\x20KLYME\x20'+_0x12e2af+_0x1cac79(0x141)),console['log'](_0x1cac79(0x14b),_0x17af4a[_0x1cac79(0x10a)]),console[_0x1cac79(0xed)](_0x1cac79(0xee),_0x17af4a['redirect_url']);else{if(_0x17af4a[_0x1cac79(0x153)])_0x6312ca=_0x59aaa3,_0x4d6655=_0x17af4a[_0x1cac79(0x153)],console['log'](_0x1cac79(0xda)+_0x12e2af+_0x1cac79(0xe0)),console[_0x1cac79(0xed)](_0x1cac79(0xff),_0x17af4a[_0x1cac79(0x153)]),console[_0x1cac79(0xed)]('Reference\x20Used\x20as\x20ID:',_0x59aaa3);else{console[_0x1cac79(0x100)](_0x1cac79(0xda)+_0x12e2af+_0x1cac79(0xf6)),console[_0x1cac79(0x100)]('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console['error'](_0x1cac79(0x131),_0x17af4a),loggerService_1[_0x1cac79(0x133)]['logWhiteDomainError'](_0x1cac79(0x110)+_0x12e2af[_0x1cac79(0x10d)](),_0x1cac79(0x10c),_0x1cac79(0xf7));throw new Error(_0x1cac79(0xfb)+_0x12e2af+_0x1cac79(0x12a));}}return console[_0x1cac79(0xed)](_0x1cac79(0x125),_0x5ed3dd,'('+_0x12e2af+_0x1cac79(0x14d)),console[_0x1cac79(0xed)](_0x1cac79(0xf2),_0x59aaa3,_0x1cac79(0xfa)),console['log'](_0x1cac79(0xce),_0x12e2af),{'gateway_payment_id':_0x6312ca,'payment_url':_0x4d6655};}catch(_0x43e690){console['error'](_0x1cac79(0xda)+_0x12e2af+_0x1cac79(0x122)),console[_0x1cac79(0x100)](_0x1cac79(0x117),_0x43e690),loggerService_1[_0x1cac79(0x133)][_0x1cac79(0x147)]('klyme_'+_0x12e2af[_0x1cac79(0x10d)](),'/create',_0x43e690);if(_0x43e690 instanceof Error){console[_0x1cac79(0x100)](_0x1cac79(0x13e),_0x43e690[_0x1cac79(0xec)]),console[_0x1cac79(0x100)](_0x1cac79(0xd7),_0x43e690[_0x1cac79(0x12e)]);throw new Error(_0x1cac79(0xc5)+_0x12e2af+'\x20payment\x20link:\x20'+_0x43e690[_0x1cac79(0xec)]);}throw new Error(_0x1cac79(0xc5)+_0x12e2af+'\x20payment\x20link:\x20Unknown\x20error');}}async['verifyPayment'](_0xd7e2e,_0x62e9ea){const _0x1183e4=a41_0x332036,_0x569c18=Date[_0x1183e4(0x11b)]();try{const _0x27f17f={'gatewayPaymentId':_0xd7e2e,'geo':_0x62e9ea};loggerService_1[_0x1183e4(0x133)][_0x1183e4(0x12c)]('klyme_'+_0x62e9ea[_0x1183e4(0x10d)](),_0x1183e4(0xd2)+_0xd7e2e,_0x1183e4(0xdb),_0x27f17f);const _0x432b44=await fetch(this[_0x1183e4(0xf5)],{'method':'POST','headers':{'Content-Type':_0x1183e4(0xd4),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x1183e4(0x11e)](_0x27f17f)}),_0x210c7f=Date[_0x1183e4(0x11b)]()-_0x569c18;if(!_0x432b44['ok']){const _0x56fb0a=await _0x432b44[_0x1183e4(0x12d)]();loggerService_1[_0x1183e4(0x133)][_0x1183e4(0xe3)](_0x1183e4(0x110)+_0x62e9ea[_0x1183e4(0x10d)](),_0x1183e4(0xd2)+_0xd7e2e,_0x432b44['status'],_0x56fb0a,_0x210c7f);throw new Error('HTTP\x20error!\x20status:\x20'+_0x432b44[_0x1183e4(0x10e)]);}const _0x24e115=await _0x432b44[_0x1183e4(0x116)]();loggerService_1[_0x1183e4(0x133)]['logWhiteDomainResponse']('klyme_'+_0x62e9ea[_0x1183e4(0x10d)](),'/verify/'+_0xd7e2e,_0x432b44[_0x1183e4(0x10e)],_0x24e115,_0x210c7f);if(_0x24e115[_0x1183e4(0x100)]||_0x24e115['statusCode']){loggerService_1[_0x1183e4(0x133)][_0x1183e4(0x147)]('klyme_'+_0x62e9ea['toLowerCase'](),_0x1183e4(0xd2)+_0xd7e2e,_0x1183e4(0x139)+_0x62e9ea+_0x1183e4(0x105)+(_0x24e115[_0x1183e4(0xec)]||_0x24e115[_0x1183e4(0x100)]||_0x1183e4(0x126)));throw new Error(_0x1183e4(0x139)+_0x62e9ea+_0x1183e4(0x105)+(_0x24e115['message']||_0x24e115[_0x1183e4(0x100)]||'Unknown\x20error'));}let _0x5827a7=_0x1183e4(0xd3);return{'status':_0x5827a7};}catch(_0x57e21e){console[_0x1183e4(0x100)](_0x1183e4(0x139)+_0x62e9ea+_0x1183e4(0x13a),_0x57e21e),loggerService_1[_0x1183e4(0x133)]['logWhiteDomainError']('klyme_'+_0x62e9ea[_0x1183e4(0x10d)](),_0x1183e4(0xd2)+_0xd7e2e,_0x57e21e);throw new Error('Failed\x20to\x20verify\x20KLYME\x20'+_0x62e9ea+_0x1183e4(0x120)+(_0x57e21e instanceof Error?_0x57e21e[_0x1183e4(0xec)]:'Unknown\x20error'));}}async[a41_0x332036(0x142)](_0x1434bd){const _0x81b9cd=a41_0x332036;console['log'](_0x81b9cd(0x118),_0x1434bd);let _0x2bd77f=_0x81b9cd(0xd3);switch(_0x1434bd[_0x81b9cd(0x10e)]?.[_0x81b9cd(0x10d)]()){case _0x81b9cd(0xdc):case _0x81b9cd(0xe7):case _0x81b9cd(0x14f):case _0x81b9cd(0x12b):case'successful':_0x2bd77f=_0x81b9cd(0x130);break;case _0x81b9cd(0x123):case _0x81b9cd(0xe9):case'failed':case _0x81b9cd(0x100):case _0x81b9cd(0xd8):_0x2bd77f=_0x81b9cd(0xf9);break;case _0x81b9cd(0xc9):case _0x81b9cd(0x12f):_0x2bd77f=_0x81b9cd(0xe4);break;case'pending':case'created':case _0x81b9cd(0x107):case _0x81b9cd(0x144):case _0x81b9cd(0x11c):default:_0x2bd77f=_0x81b9cd(0xd3);break;}return{'paymentId':_0x1434bd[_0x81b9cd(0x115)]||_0x1434bd[_0x81b9cd(0x103)]||_0x1434bd[_0x81b9cd(0xc6)],'status':_0x2bd77f,'amount':_0x1434bd[_0x81b9cd(0x106)],'currency':_0x1434bd[_0x81b9cd(0xfd)],'region':_0x1434bd[_0x81b9cd(0x102)],'additionalInfo':{'payment_method':_0x1434bd['payment_method'],'transaction_id':_0x1434bd[_0x81b9cd(0xfc)]}};}}exports[a41_0x332036(0xcc)]=KlymeService;