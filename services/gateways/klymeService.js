'use strict';const a56_0x4075af=a56_0x18c8;function a56_0x18c8(_0xcd2d2d,_0x143a95){_0xcd2d2d=_0xcd2d2d-0xcf;const _0xfb30f9=a56_0xfb30();let _0x18c8be=_0xfb30f9[_0xcd2d2d];return _0x18c8be;}(function(_0x3a4a87,_0x325c65){const _0x2bb3fe=a56_0x18c8,_0x3e07b9=_0x3a4a87();while(!![]){try{const _0x3806e8=-parseInt(_0x2bb3fe(0x158))/0x1*(-parseInt(_0x2bb3fe(0x13d))/0x2)+parseInt(_0x2bb3fe(0x149))/0x3+parseInt(_0x2bb3fe(0x153))/0x4*(parseInt(_0x2bb3fe(0xec))/0x5)+-parseInt(_0x2bb3fe(0x14d))/0x6+parseInt(_0x2bb3fe(0x140))/0x7+parseInt(_0x2bb3fe(0x133))/0x8+parseInt(_0x2bb3fe(0x10c))/0x9*(-parseInt(_0x2bb3fe(0x11c))/0xa);if(_0x3806e8===_0x325c65)break;else _0x3e07b9['push'](_0x3e07b9['shift']());}catch(_0x5c30b1){_0x3e07b9['push'](_0x3e07b9['shift']());}}}(a56_0xfb30,0x8934e));function a56_0xfb30(){const _0x595157=['currency','paid','cancelled','region','\x20API\x20ERROR\x20===','8Nnkort','\x20SERVICE\x20ERROR\x20===','Failed\x20to\x20parse\x20JSON\x20response:','reference','Processing\x20KLYME\x20webhook:','40087jYqlbx','application/json','Currency\x20Used:','\x20currency\x20validation\x20passed:\x20','Raw\x20Response\x20Body:','status','Status\x20Code:','defineProperty','Status\x20Text:','statusText','resolve','Unknown\x20error','length','FAILED','JSON\x20Parse\x20Error:\x20','getOwnPropertyNames','/verify/','Error\x20Message:','message','authUrl','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','POST','payment','headers','Failed\x20to\x20verify\x20KLYME\x20','Unknown\x20error\x20from\x20KLYME\x20','klyme_','Business\x20Error:\x20','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','create','\x20payment\x20link:\x20Unknown\x20error','processWebhook','findFirst','Failed\x20to\x20create\x20KLYME\x20','payment_method','748585WWbOvr','loggerService','Unsupported\x20KLYME\x20region:\x20','Response\x20Body:','EXPIRED','pending','timeout','\x20API\x20BUSINESS\x20ERROR\x20===','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','Auth\x20URL:','get','EUR','canceled','Reference\x20Used\x20as\x20ID:','validateCurrencyForRegion','entries','parse','https://tesoft.uk/gateway/klyme/','created','fromEntries','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','../../config/database','__createBinding','toUpperCase','then','call','\x20RESPONSE\x20===','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','‚ö†Ô∏è\x20KLYME\x20reference\x20','HTTP\x20error!\x20status:\x20','logWhiteDomainRequest','üí≥\x20KLYME\x20','5666283OnEUKX','\x20payment\x20link:\x20','payment_id','stringify','../loggerService','logWhiteDomainResponse','generateUniqueReference','\x20validated)','toLowerCase','===\x20KLYME\x20','default','processing','PENDING','expired','\x20API','Invalid\x20response\x20from\x20KLYME\x20','10OANvLm','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','URL:','Geo\x20Parameter:','Status:','\x20payment\x20verification\x20error:','log','apiUrl','\x20SUCCESS\x20(New\x20Format)\x20===','KlymeService','Payment\x20System/1.0','statusCode','json','HTTP\x20Status:','random','logWhiteDomainError','redirect_url','===\x20PARSED\x20KLYME\x20','uuid','hasOwnProperty','\x20API\x20error:\x20','\x20(8digits-8digits\x20format\x20for\x20','error','239328JCrHOE','Error\x20message:','https://tesoft.uk/gateway/pending.php?id=','successful','Request\x20Body:','amount','__esModule','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','KLYME\x20','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','10wRLKzl','now','(8digits-8digits\x20format)','3508855DmhvvY','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','Response\x20Time:','writable','(validated\x20for\x20','createPaymentLink','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','PAID','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','1676727aOakIJ','stack','active','/create','2390244UaCvYY'];a56_0xfb30=function(){return _0x595157;};return a56_0xfb30();}var __createBinding=this&&this[a56_0x4075af(0x102)]||(Object[a56_0x4075af(0xe6)]?function(_0x269eb6,_0x3a8b77,_0x5a9001,_0x50c649){const _0x20c6fc=a56_0x4075af;if(_0x50c649===undefined)_0x50c649=_0x5a9001;var _0x483dee=Object['getOwnPropertyDescriptor'](_0x3a8b77,_0x5a9001);(!_0x483dee||(_0x20c6fc(0xf6)in _0x483dee?!_0x3a8b77[_0x20c6fc(0x139)]:_0x483dee[_0x20c6fc(0x143)]||_0x483dee['configurable']))&&(_0x483dee={'enumerable':!![],'get':function(){return _0x3a8b77[_0x5a9001];}}),Object[_0x20c6fc(0xd0)](_0x269eb6,_0x50c649,_0x483dee);}:function(_0x73ccee,_0x5c393a,_0x419818,_0x37deb1){if(_0x37deb1===undefined)_0x37deb1=_0x419818;_0x73ccee[_0x37deb1]=_0x5c393a[_0x419818];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a56_0x4075af(0xe6)]?function(_0x20e023,_0xa5f64e){const _0x15d627=a56_0x4075af;Object[_0x15d627(0xd0)](_0x20e023,_0x15d627(0x116),{'enumerable':!![],'value':_0xa5f64e});}:function(_0x51683e,_0x1649a6){const _0x60cfa8=a56_0x4075af;_0x51683e[_0x60cfa8(0x116)]=_0x1649a6;}),__importStar=this&&this['__importStar']||(function(){var _0x4ced3c=function(_0xae24f1){const _0x96795d=a56_0x18c8;return _0x4ced3c=Object[_0x96795d(0xd8)]||function(_0x394eff){const _0x2d9289=_0x96795d;var _0x562f17=[];for(var _0x3c9029 in _0x394eff)if(Object['prototype'][_0x2d9289(0x12f)][_0x2d9289(0x105)](_0x394eff,_0x3c9029))_0x562f17[_0x562f17[_0x2d9289(0xd5)]]=_0x3c9029;return _0x562f17;},_0x4ced3c(_0xae24f1);};return function(_0x20a720){const _0x368a97=a56_0x18c8;if(_0x20a720&&_0x20a720[_0x368a97(0x139)])return _0x20a720;var _0x420ff8={};if(_0x20a720!=null){for(var _0x2dc7ff=_0x4ced3c(_0x20a720),_0x3c02c4=0x0;_0x3c02c4<_0x2dc7ff[_0x368a97(0xd5)];_0x3c02c4++)if(_0x2dc7ff[_0x3c02c4]!==_0x368a97(0x116))__createBinding(_0x420ff8,_0x20a720,_0x2dc7ff[_0x3c02c4]);}return __setModuleDefault(_0x420ff8,_0x20a720),_0x420ff8;};}());Object['defineProperty'](exports,a56_0x4075af(0x139),{'value':!![]}),exports[a56_0x4075af(0x125)]=void 0x0;const loggerService_1=require(a56_0x4075af(0x110));class KlymeService{constructor(){const _0xad4e18=a56_0x4075af;this[_0xad4e18(0x123)]=_0xad4e18(0xfd),console['log'](_0xad4e18(0x141));}[a56_0x4075af(0xfa)](_0x2771ef,_0x1a6c6e){const _0x5899d2=a56_0x4075af,_0x5d5ebd=_0x2771ef[_0x5899d2(0x103)]();switch(_0x1a6c6e){case'EU':if(_0x5d5ebd!=='EUR')throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x5d5ebd);break;case'GB':if(_0x5d5ebd!=='GBP')throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0x5d5ebd);break;case'DE':if(_0x5d5ebd!==_0x5899d2(0xf7))throw new Error(_0x5899d2(0x148)+_0x5d5ebd);break;default:throw new Error(_0x5899d2(0xee)+_0x1a6c6e);}}async['generateUniqueReference'](){const _0x57d906=a56_0x4075af,_0x4d9c88=(await Promise[_0x57d906(0xd3)]()[_0x57d906(0x104)](()=>__importStar(require(_0x57d906(0x101)))))['default'];let _0x2824a5,_0x12300c=0x0;const _0x342993=0xa;do{const _0x88aa9a=()=>{const _0x5ca307=_0x57d906;return Math['floor'](Math[_0x5ca307(0x12a)]()*0x5f5e100)['toString']()['padStart'](0x8,'0');};_0x2824a5=_0x88aa9a()+'-'+_0x88aa9a();const _0x1e2f91=await _0x4d9c88[_0x57d906(0xdf)][_0x57d906(0xe9)]({'where':{'gatewayOrderId':_0x2824a5}});if(!_0x1e2f91)break;_0x12300c++,console[_0x57d906(0x122)](_0x57d906(0x108)+_0x2824a5+'\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20'+_0x12300c+')');}while(_0x12300c<_0x342993);if(_0x12300c>=_0x342993)throw new Error(_0x57d906(0x11d));return _0x2824a5;}async[a56_0x4075af(0x145)](_0x1b746f){const _0x54c41d=a56_0x4075af,{orderId:_0x5babb5,amount:_0xed4f5,currency:_0x32c125,region:_0x422cda}=_0x1b746f;if(_0x422cda!=='EU'&&_0x422cda!=='GB'&&_0x422cda!=='DE')throw new Error(_0x54c41d(0xf4)+_0x422cda);this['validateCurrencyForRegion'](_0x32c125,_0x422cda);const _0x1448e3=_0x32c125[_0x54c41d(0x103)]();console[_0x54c41d(0x122)](_0x54c41d(0x10b)+_0x422cda+_0x54c41d(0x15b)+_0x1448e3);const _0x5f56c7=await this[_0x54c41d(0x112)]();console[_0x54c41d(0x122)](_0x54c41d(0x107)+_0x5f56c7+_0x54c41d(0x131)+_0x422cda+')');const _0x5d3dd3=_0x54c41d(0x135)+_0x5babb5,_0x94e78b={'amount':_0xed4f5,'currency':_0x1448e3,'redirectUrl':_0x5d3dd3,'reference':_0x5f56c7,'geo':_0x422cda},_0x113224=Date[_0x54c41d(0x13e)]();try{console[_0x54c41d(0x122)](_0x54c41d(0x115)+_0x422cda+_0x54c41d(0x13c)),console['log'](_0x54c41d(0x11e),this['apiUrl']),console[_0x54c41d(0x122)](_0x54c41d(0x137),JSON[_0x54c41d(0x10f)](_0x94e78b,null,0x2)),console[_0x54c41d(0x122)]('Region\x20(geo):',_0x422cda),console[_0x54c41d(0x122)]('Currency:',_0x1448e3,_0x54c41d(0x144)+_0x422cda+')'),console['log']('Reference:',_0x5f56c7,'(8digits-8digits\x20format)'),console['log']('Redirect\x20URL:',_0x5d3dd3),loggerService_1[_0x54c41d(0xed)][_0x54c41d(0x10a)](_0x54c41d(0xe3)+_0x422cda[_0x54c41d(0x114)](),_0x54c41d(0x14c),_0x54c41d(0xde),_0x94e78b);const _0x298516=await fetch(this['apiUrl'],{'method':_0x54c41d(0xde),'headers':{'Content-Type':_0x54c41d(0x159),'Accept':_0x54c41d(0x159),'User-Agent':_0x54c41d(0x126)},'body':JSON[_0x54c41d(0x10f)](_0x94e78b)}),_0x48013b=Date[_0x54c41d(0x13e)]()-_0x113224;console[_0x54c41d(0x122)](_0x54c41d(0x115)+_0x422cda+_0x54c41d(0x100)),console[_0x54c41d(0x122)](_0x54c41d(0x120),_0x298516[_0x54c41d(0x15d)]),console[_0x54c41d(0x122)](_0x54c41d(0xd1),_0x298516[_0x54c41d(0xd2)]),console['log']('Headers:',Object[_0x54c41d(0xff)](_0x298516[_0x54c41d(0xe0)][_0x54c41d(0xfb)]())),console[_0x54c41d(0x122)](_0x54c41d(0x142),_0x48013b+'ms');const _0x5a35a8=await _0x298516['text']();console['log'](_0x54c41d(0x15c),_0x5a35a8);if(!_0x298516['ok']){console[_0x54c41d(0x132)](_0x54c41d(0x115)+_0x422cda+_0x54c41d(0x152)),console['error'](_0x54c41d(0x129),_0x298516[_0x54c41d(0x15d)]),console[_0x54c41d(0x132)](_0x54c41d(0xef),_0x5a35a8),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x54c41d(0xe3)+_0x422cda[_0x54c41d(0x114)](),'/create',_0x298516[_0x54c41d(0x15d)],_0x5a35a8,_0x48013b),loggerService_1[_0x54c41d(0xed)][_0x54c41d(0x12b)](_0x54c41d(0xe3)+_0x422cda['toLowerCase'](),'/create','HTTP\x20'+_0x298516[_0x54c41d(0x15d)]+':\x20'+_0x5a35a8);throw new Error(_0x54c41d(0x109)+_0x298516[_0x54c41d(0x15d)]+',\x20body:\x20'+_0x5a35a8);}let _0x4def5a;try{_0x4def5a=JSON[_0x54c41d(0xfc)](_0x5a35a8);}catch(_0x356678){console[_0x54c41d(0x132)](_0x54c41d(0x155),_0x356678),loggerService_1[_0x54c41d(0xed)][_0x54c41d(0x12b)]('klyme_'+_0x422cda['toLowerCase'](),_0x54c41d(0x14c),_0x54c41d(0xd7)+_0x356678);throw new Error(_0x54c41d(0xdd)+_0x422cda+'\x20API:\x20'+_0x5a35a8);}console[_0x54c41d(0x122)](_0x54c41d(0x12d)+_0x422cda+_0x54c41d(0x106)),console[_0x54c41d(0x122)]('Parsed\x20Result:',JSON[_0x54c41d(0x10f)](_0x4def5a,null,0x2)),loggerService_1['loggerService'][_0x54c41d(0x111)](_0x54c41d(0xe3)+_0x422cda[_0x54c41d(0x114)](),_0x54c41d(0x14c),_0x298516['status'],_0x4def5a,_0x48013b);if(_0x4def5a['error']||_0x4def5a[_0x54c41d(0x127)]){const _0x501b63=_0x4def5a[_0x54c41d(0xdb)]||_0x4def5a[_0x54c41d(0x132)]||_0x54c41d(0xe2)+_0x422cda+_0x54c41d(0x11a);console['error'](_0x54c41d(0x115)+_0x422cda+_0x54c41d(0xf3)),console[_0x54c41d(0x132)](_0x54c41d(0xda),_0x501b63),console[_0x54c41d(0x132)](_0x54c41d(0xcf),_0x4def5a[_0x54c41d(0x127)]),loggerService_1[_0x54c41d(0xed)][_0x54c41d(0x12b)]('klyme_'+_0x422cda['toLowerCase'](),_0x54c41d(0x14c),_0x54c41d(0xe4)+_0x501b63);throw new Error(_0x54c41d(0x13b)+_0x422cda+_0x54c41d(0x130)+_0x501b63);}let _0x2ea953,_0x41d93f;if(_0x4def5a[_0x54c41d(0x12e)]&&_0x4def5a[_0x54c41d(0x12c)])_0x2ea953=_0x4def5a[_0x54c41d(0x12e)],_0x41d93f=_0x4def5a[_0x54c41d(0x12c)],console['log']('===\x20KLYME\x20'+_0x422cda+_0x54c41d(0x124)),console[_0x54c41d(0x122)]('UUID:',_0x4def5a[_0x54c41d(0x12e)]),console[_0x54c41d(0x122)]('Redirect\x20URL:',_0x4def5a[_0x54c41d(0x12c)]);else{if(_0x4def5a[_0x54c41d(0xdc)])_0x2ea953=_0x5f56c7,_0x41d93f=_0x4def5a[_0x54c41d(0xdc)],console[_0x54c41d(0x122)](_0x54c41d(0x115)+_0x422cda+'\x20SUCCESS\x20(Legacy\x20Format)\x20==='),console[_0x54c41d(0x122)](_0x54c41d(0xf5),_0x4def5a['authUrl']),console[_0x54c41d(0x122)](_0x54c41d(0xf9),_0x5f56c7);else{console[_0x54c41d(0x132)](_0x54c41d(0x115)+_0x422cda+_0x54c41d(0xe5)),console[_0x54c41d(0x132)](_0x54c41d(0x146)),console[_0x54c41d(0x132)]('Response\x20data:',_0x4def5a),loggerService_1[_0x54c41d(0xed)][_0x54c41d(0x12b)](_0x54c41d(0xe3)+_0x422cda[_0x54c41d(0x114)](),_0x54c41d(0x14c),_0x54c41d(0x13a));throw new Error(_0x54c41d(0x11b)+_0x422cda+'\x20API:\x20missing\x20payment\x20data');}}return console['log'](_0x54c41d(0x15a),_0x1448e3,'('+_0x422cda+_0x54c41d(0x113)),console[_0x54c41d(0x122)]('Reference\x20Used:',_0x5f56c7,_0x54c41d(0x13f)),console['log'](_0x54c41d(0x11f),_0x422cda),{'gateway_payment_id':_0x2ea953,'payment_url':_0x41d93f};}catch(_0x58b66d){console['error'](_0x54c41d(0x115)+_0x422cda+_0x54c41d(0x154)),console['error']('Error\x20details:',_0x58b66d),loggerService_1[_0x54c41d(0xed)][_0x54c41d(0x12b)](_0x54c41d(0xe3)+_0x422cda[_0x54c41d(0x114)](),_0x54c41d(0x14c),_0x58b66d);if(_0x58b66d instanceof Error){console[_0x54c41d(0x132)](_0x54c41d(0x134),_0x58b66d[_0x54c41d(0xdb)]),console['error']('Error\x20stack:',_0x58b66d[_0x54c41d(0x14a)]);throw new Error(_0x54c41d(0xea)+_0x422cda+_0x54c41d(0x10d)+_0x58b66d[_0x54c41d(0xdb)]);}throw new Error(_0x54c41d(0xea)+_0x422cda+_0x54c41d(0xe7));}}async['verifyPayment'](_0x547d02,_0x34a1d0){const _0x435e3f=a56_0x4075af,_0x178f2c=Date['now']();try{const _0x19660c={'gatewayPaymentId':_0x547d02,'geo':_0x34a1d0};loggerService_1[_0x435e3f(0xed)]['logWhiteDomainRequest'](_0x435e3f(0xe3)+_0x34a1d0[_0x435e3f(0x114)](),_0x435e3f(0xd9)+_0x547d02,_0x435e3f(0xde),_0x19660c);const _0x4c50ea=await fetch(this[_0x435e3f(0x123)],{'method':_0x435e3f(0xde),'headers':{'Content-Type':'application/json','User-Agent':'Payment\x20System/1.0'},'body':JSON[_0x435e3f(0x10f)](_0x19660c)}),_0x83516f=Date[_0x435e3f(0x13e)]()-_0x178f2c;if(!_0x4c50ea['ok']){const _0x59eaf4=await _0x4c50ea['text']();loggerService_1[_0x435e3f(0xed)]['logWhiteDomainResponse']('klyme_'+_0x34a1d0[_0x435e3f(0x114)](),_0x435e3f(0xd9)+_0x547d02,_0x4c50ea[_0x435e3f(0x15d)],_0x59eaf4,_0x83516f);throw new Error(_0x435e3f(0x109)+_0x4c50ea[_0x435e3f(0x15d)]);}const _0x3034fb=await _0x4c50ea[_0x435e3f(0x128)]();loggerService_1[_0x435e3f(0xed)][_0x435e3f(0x111)](_0x435e3f(0xe3)+_0x34a1d0['toLowerCase'](),_0x435e3f(0xd9)+_0x547d02,_0x4c50ea['status'],_0x3034fb,_0x83516f);if(_0x3034fb['error']||_0x3034fb[_0x435e3f(0x127)]){loggerService_1['loggerService']['logWhiteDomainError'](_0x435e3f(0xe3)+_0x34a1d0['toLowerCase'](),_0x435e3f(0xd9)+_0x547d02,_0x435e3f(0x13b)+_0x34a1d0+_0x435e3f(0x130)+(_0x3034fb['message']||_0x3034fb[_0x435e3f(0x132)]||_0x435e3f(0xd4)));throw new Error(_0x435e3f(0x13b)+_0x34a1d0+_0x435e3f(0x130)+(_0x3034fb[_0x435e3f(0xdb)]||_0x3034fb[_0x435e3f(0x132)]||'Unknown\x20error'));}let _0x435081=_0x435e3f(0x118);return{'status':_0x435081};}catch(_0x53eb64){console[_0x435e3f(0x132)](_0x435e3f(0x13b)+_0x34a1d0+_0x435e3f(0x121),_0x53eb64),loggerService_1[_0x435e3f(0xed)][_0x435e3f(0x12b)](_0x435e3f(0xe3)+_0x34a1d0['toLowerCase'](),_0x435e3f(0xd9)+_0x547d02,_0x53eb64);throw new Error(_0x435e3f(0xe1)+_0x34a1d0+'\x20payment:\x20'+(_0x53eb64 instanceof Error?_0x53eb64[_0x435e3f(0xdb)]:_0x435e3f(0xd4)));}}async[a56_0x4075af(0xe8)](_0x4fbdda){const _0x487b99=a56_0x4075af;console[_0x487b99(0x122)](_0x487b99(0x157),_0x4fbdda);let _0x216a54=_0x487b99(0x118);switch(_0x4fbdda[_0x487b99(0x15d)]?.['toLowerCase']()){case _0x487b99(0x14f):case'completed':case'confirmed':case'success':case _0x487b99(0x136):_0x216a54=_0x487b99(0x147);break;case _0x487b99(0x150):case _0x487b99(0xf8):case'failed':case'error':case'rejected':_0x216a54=_0x487b99(0xd6);break;case _0x487b99(0x119):case _0x487b99(0xf2):_0x216a54=_0x487b99(0xf0);break;case _0x487b99(0xf1):case _0x487b99(0xfe):case _0x487b99(0x14b):case _0x487b99(0x117):case'in_progress':default:_0x216a54=_0x487b99(0x118);break;}return{'paymentId':_0x4fbdda[_0x487b99(0x156)]||_0x4fbdda['order_id']||_0x4fbdda[_0x487b99(0x10e)],'status':_0x216a54,'amount':_0x4fbdda[_0x487b99(0x138)],'currency':_0x4fbdda[_0x487b99(0x14e)],'region':_0x4fbdda[_0x487b99(0x151)],'additionalInfo':{'payment_method':_0x4fbdda[_0x487b99(0xeb)],'transaction_id':_0x4fbdda['transaction_id']}};}}exports[a56_0x4075af(0x125)]=KlymeService;