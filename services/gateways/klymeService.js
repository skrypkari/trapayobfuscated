'use strict';const a50_0x3cd814=a50_0x3caf;(function(_0x42fa98,_0x4b3761){const _0x1f55a8=a50_0x3caf,_0x24d92b=_0x42fa98();while(!![]){try{const _0x55a50b=-parseInt(_0x1f55a8(0x171))/0x1+parseInt(_0x1f55a8(0x12e))/0x2+parseInt(_0x1f55a8(0x113))/0x3+-parseInt(_0x1f55a8(0x162))/0x4+-parseInt(_0x1f55a8(0xf9))/0x5*(-parseInt(_0x1f55a8(0x107))/0x6)+-parseInt(_0x1f55a8(0x112))/0x7+parseInt(_0x1f55a8(0xfb))/0x8;if(_0x55a50b===_0x4b3761)break;else _0x24d92b['push'](_0x24d92b['shift']());}catch(_0x58fd61){_0x24d92b['push'](_0x24d92b['shift']());}}}(a50_0x1232,0x2bcdb));var __createBinding=this&&this[a50_0x3cd814(0x17b)]||(Object['create']?function(_0x78b52d,_0x4852a2,_0x2b4cb0,_0x1efc83){const _0x22d88a=a50_0x3cd814;if(_0x1efc83===undefined)_0x1efc83=_0x2b4cb0;var _0x420c9d=Object['getOwnPropertyDescriptor'](_0x4852a2,_0x2b4cb0);(!_0x420c9d||('get'in _0x420c9d?!_0x4852a2[_0x22d88a(0x13e)]:_0x420c9d[_0x22d88a(0x15c)]||_0x420c9d['configurable']))&&(_0x420c9d={'enumerable':!![],'get':function(){return _0x4852a2[_0x2b4cb0];}}),Object[_0x22d88a(0x174)](_0x78b52d,_0x1efc83,_0x420c9d);}:function(_0x29b2d5,_0x2c2d10,_0x5bbfb2,_0xc33550){if(_0xc33550===undefined)_0xc33550=_0x5bbfb2;_0x29b2d5[_0xc33550]=_0x2c2d10[_0x5bbfb2];}),__setModuleDefault=this&&this[a50_0x3cd814(0x114)]||(Object[a50_0x3cd814(0x120)]?function(_0x322895,_0x4bd25a){const _0x276df3=a50_0x3cd814;Object[_0x276df3(0x174)](_0x322895,_0x276df3(0x148),{'enumerable':!![],'value':_0x4bd25a});}:function(_0x5d0f64,_0x1db70c){_0x5d0f64['default']=_0x1db70c;}),__importStar=this&&this[a50_0x3cd814(0x17d)]||(function(){var _0x9f4adb=function(_0xc2e376){return _0x9f4adb=Object['getOwnPropertyNames']||function(_0x458a3c){const _0x4395bc=a50_0x3caf;var _0xc00bfb=[];for(var _0x241f92 in _0x458a3c)if(Object[_0x4395bc(0x122)][_0x4395bc(0x116)][_0x4395bc(0xfa)](_0x458a3c,_0x241f92))_0xc00bfb[_0xc00bfb[_0x4395bc(0x13b)]]=_0x241f92;return _0xc00bfb;},_0x9f4adb(_0xc2e376);};return function(_0x41038f){const _0x223c8e=a50_0x3caf;if(_0x41038f&&_0x41038f[_0x223c8e(0x13e)])return _0x41038f;var _0xf39fff={};if(_0x41038f!=null){for(var _0x398bb6=_0x9f4adb(_0x41038f),_0x2b4d78=0x0;_0x2b4d78<_0x398bb6[_0x223c8e(0x13b)];_0x2b4d78++)if(_0x398bb6[_0x2b4d78]!=='default')__createBinding(_0xf39fff,_0x41038f,_0x398bb6[_0x2b4d78]);}return __setModuleDefault(_0xf39fff,_0x41038f),_0xf39fff;};}());Object[a50_0x3cd814(0x174)](exports,a50_0x3cd814(0x13e),{'value':!![]}),exports['KlymeService']=void 0x0;function a50_0x1232(){const _0x59a13a=['\x20payment:\x20','KLYME\x20','entries','EXPIRED','Failed\x20to\x20create\x20KLYME\x20','459965IkSPVh','call','506856IaZxfE','HTTP\x20Status:','\x20currency\x20validation\x20passed:\x20','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','KlymeService','Payment\x20System/1.0','FAILED','expired','redirect_url','loggerService','created','message','12XJkkUY','Processing\x20KLYME\x20webhook:','../../config/database','===\x20PARSED\x20KLYME\x20','createPaymentLink','Currency:','generateUniqueReference','Auth\x20URL:','Error\x20stack:','üí≥\x20KLYME\x20','processWebhook','1027509vyqeAG','968022JqztEh','__setModuleDefault','Response\x20Body:','hasOwnProperty','Reference\x20Used:','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','apiUrl','Failed\x20to\x20verify\x20KLYME\x20','Raw\x20Response\x20Body:','Currency\x20Used:','then','HTTP\x20error!\x20status:\x20','(8digits-8digits\x20format)','create','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','prototype','parse','uuid','toUpperCase','PAID','error','canceled','Error\x20Message:','Reference:','\x20RESPONSE\x20===','JSON\x20Parse\x20Error:\x20','region','176624gjYKjQ','Status:','successful','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','../loggerService','Error\x20message:','random','\x20API\x20ERROR\x20===','statusCode','Response\x20data:','POST','URL:','\x20API','length','confirmed','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','__esModule','HTTP\x20','\x20API\x20error:\x20','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','failed','logWhiteDomainResponse','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','json','\x20SUCCESS\x20(New\x20Format)\x20===','Unknown\x20error','default','\x20validated)','EUR','https://tesoft.uk/gateway/klyme/','\x20SERVICE\x20ERROR\x20===','application/json','logWhiteDomainError','Headers:','authUrl','success','Status\x20Text:','Unsupported\x20KLYME\x20region:\x20','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','Status\x20Code:','processing','completed','Invalid\x20response\x20from\x20KLYME\x20','pending','Parsed\x20Result:','status','writable','payment_method','\x20API:\x20','/verify/','now','reference','290312qopXsL','stack','Reference\x20Used\x20as\x20ID:','toLowerCase','Region\x20(geo):','payment','logWhiteDomainRequest','Redirect\x20URL:','cancelled','\x20payment\x20verification\x20error:','validateCurrencyForRegion','paid','order_id','klyme_','===\x20KLYME\x20','259545finQUm','padStart','transaction_id','defineProperty','/create','toString','PENDING','Unknown\x20error\x20from\x20KLYME\x20','in_progress','stringify','__createBinding','log','__importStar','https://tesoft.uk/gateway/pending.php?id=',',\x20body:\x20','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','active','Business\x20Error:\x20','Geo\x20Parameter:','resolve'];a50_0x1232=function(){return _0x59a13a;};return a50_0x1232();}const loggerService_1=require(a50_0x3cd814(0x132));class KlymeService{constructor(){const _0x59d21e=a50_0x3cd814;this[_0x59d21e(0x119)]=_0x59d21e(0x14b),console[_0x59d21e(0x17c)](_0x59d21e(0x144));}['validateCurrencyForRegion'](_0x9ddcf,_0x51f9e8){const _0x13cdb6=a50_0x3cd814,_0x20709e=_0x9ddcf['toUpperCase']();switch(_0x51f9e8){case'EU':if(_0x20709e!==_0x13cdb6(0x14a))throw new Error(_0x13cdb6(0x131)+_0x20709e);break;case'GB':if(_0x20709e!=='GBP')throw new Error(_0x13cdb6(0x141)+_0x20709e);break;case'DE':if(_0x20709e!==_0x13cdb6(0x14a))throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x20709e);break;default:throw new Error(_0x13cdb6(0x153)+_0x51f9e8);}}async[a50_0x3cd814(0x10d)](){const _0x491651=a50_0x3cd814,_0x2c57ab=(await Promise[_0x491651(0xf3)]()[_0x491651(0x11d)](()=>__importStar(require(_0x491651(0x109)))))[_0x491651(0x148)];let _0x186f06,_0x4dbf73=0x0;const _0x49295b=0xa;do{const _0x2090d2=()=>{const _0x3ed0d0=_0x491651;return Math['floor'](Math[_0x3ed0d0(0x134)]()*0x5f5e100)[_0x3ed0d0(0x176)]()[_0x3ed0d0(0x172)](0x8,'0');};_0x186f06=_0x2090d2()+'-'+_0x2090d2();const _0x353ce4=await _0x2c57ab[_0x491651(0x167)]['findFirst']({'where':{'gatewayOrderId':_0x186f06}});if(!_0x353ce4)break;_0x4dbf73++,console[_0x491651(0x17c)]('‚ö†Ô∏è\x20KLYME\x20reference\x20'+_0x186f06+'\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20'+_0x4dbf73+')');}while(_0x4dbf73<_0x49295b);if(_0x4dbf73>=_0x49295b)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x186f06;}async[a50_0x3cd814(0x10b)](_0x5400e8){const _0x510fec=a50_0x3cd814,{orderId:_0x2d688f,amount:_0x2e9742,currency:_0x3bc8fc,region:_0xf7674d}=_0x5400e8;if(_0xf7674d!=='EU'&&_0xf7674d!=='GB'&&_0xf7674d!=='DE')throw new Error(_0x510fec(0xfe)+_0xf7674d);this[_0x510fec(0x16c)](_0x3bc8fc,_0xf7674d);const _0x271e18=_0x3bc8fc[_0x510fec(0x125)]();console[_0x510fec(0x17c)](_0x510fec(0x110)+_0xf7674d+_0x510fec(0xfd)+_0x271e18);const _0x179089=await this['generateUniqueReference']();console[_0x510fec(0x17c)](_0x510fec(0x121)+_0x179089+'\x20(8digits-8digits\x20format\x20for\x20'+_0xf7674d+')');const _0x526767=_0x510fec(0x17e)+_0x2d688f,_0x1857c2={'amount':_0x2e9742,'currency':_0x271e18,'redirectUrl':_0x526767,'reference':_0x179089,'geo':_0xf7674d},_0x2d70e1=Date[_0x510fec(0x160)]();try{console[_0x510fec(0x17c)](_0x510fec(0x170)+_0xf7674d+_0x510fec(0x118)),console[_0x510fec(0x17c)](_0x510fec(0x139),this[_0x510fec(0x119)]),console[_0x510fec(0x17c)]('Request\x20Body:',JSON['stringify'](_0x1857c2,null,0x2)),console[_0x510fec(0x17c)](_0x510fec(0x166),_0xf7674d),console[_0x510fec(0x17c)](_0x510fec(0x10c),_0x271e18,'(validated\x20for\x20'+_0xf7674d+')'),console['log'](_0x510fec(0x12a),_0x179089,_0x510fec(0x11f)),console[_0x510fec(0x17c)](_0x510fec(0x169),_0x526767),loggerService_1[_0x510fec(0x104)]['logWhiteDomainRequest']('klyme_'+_0xf7674d['toLowerCase'](),_0x510fec(0x175),_0x510fec(0x138),_0x1857c2);const _0x29bb4f=await fetch(this['apiUrl'],{'method':'POST','headers':{'Content-Type':_0x510fec(0x14d),'Accept':_0x510fec(0x14d),'User-Agent':_0x510fec(0x100)},'body':JSON['stringify'](_0x1857c2)}),_0x341074=Date['now']()-_0x2d70e1;console[_0x510fec(0x17c)](_0x510fec(0x170)+_0xf7674d+'\x20API\x20RESPONSE\x20(Unified\x20Route)\x20==='),console[_0x510fec(0x17c)](_0x510fec(0x12f),_0x29bb4f[_0x510fec(0x15b)]),console[_0x510fec(0x17c)](_0x510fec(0x152),_0x29bb4f['statusText']),console[_0x510fec(0x17c)](_0x510fec(0x14f),Object['fromEntries'](_0x29bb4f['headers'][_0x510fec(0xf6)]())),console[_0x510fec(0x17c)]('Response\x20Time:',_0x341074+'ms');const _0x4a1733=await _0x29bb4f['text']();console['log'](_0x510fec(0x11b),_0x4a1733);if(!_0x29bb4f['ok']){console[_0x510fec(0x127)]('===\x20KLYME\x20'+_0xf7674d+_0x510fec(0x135)),console[_0x510fec(0x127)](_0x510fec(0xfc),_0x29bb4f[_0x510fec(0x15b)]),console['error'](_0x510fec(0x115),_0x4a1733),loggerService_1['loggerService'][_0x510fec(0x143)](_0x510fec(0x16f)+_0xf7674d[_0x510fec(0x165)](),'/create',_0x29bb4f['status'],_0x4a1733,_0x341074),loggerService_1[_0x510fec(0x104)][_0x510fec(0x14e)](_0x510fec(0x16f)+_0xf7674d[_0x510fec(0x165)](),_0x510fec(0x175),_0x510fec(0x13f)+_0x29bb4f[_0x510fec(0x15b)]+':\x20'+_0x4a1733);throw new Error(_0x510fec(0x11e)+_0x29bb4f[_0x510fec(0x15b)]+_0x510fec(0x17f)+_0x4a1733);}let _0x56c3ef;try{_0x56c3ef=JSON[_0x510fec(0x123)](_0x4a1733);}catch(_0x41942d){console[_0x510fec(0x127)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x41942d),loggerService_1[_0x510fec(0x104)][_0x510fec(0x14e)](_0x510fec(0x16f)+_0xf7674d['toLowerCase'](),_0x510fec(0x175),_0x510fec(0x12c)+_0x41942d);throw new Error(_0x510fec(0x13d)+_0xf7674d+_0x510fec(0x15e)+_0x4a1733);}console[_0x510fec(0x17c)](_0x510fec(0x10a)+_0xf7674d+_0x510fec(0x12b)),console[_0x510fec(0x17c)](_0x510fec(0x15a),JSON[_0x510fec(0x17a)](_0x56c3ef,null,0x2)),loggerService_1[_0x510fec(0x104)]['logWhiteDomainResponse'](_0x510fec(0x16f)+_0xf7674d[_0x510fec(0x165)](),_0x510fec(0x175),_0x29bb4f[_0x510fec(0x15b)],_0x56c3ef,_0x341074);if(_0x56c3ef[_0x510fec(0x127)]||_0x56c3ef[_0x510fec(0x136)]){const _0xf9a669=_0x56c3ef[_0x510fec(0x106)]||_0x56c3ef[_0x510fec(0x127)]||_0x510fec(0x178)+_0xf7674d+_0x510fec(0x13a);console[_0x510fec(0x127)](_0x510fec(0x170)+_0xf7674d+'\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x510fec(0x127)](_0x510fec(0x129),_0xf9a669),console[_0x510fec(0x127)](_0x510fec(0x155),_0x56c3ef['statusCode']),loggerService_1[_0x510fec(0x104)][_0x510fec(0x14e)](_0x510fec(0x16f)+_0xf7674d[_0x510fec(0x165)](),_0x510fec(0x175),_0x510fec(0xf1)+_0xf9a669);throw new Error('KLYME\x20'+_0xf7674d+'\x20API\x20error:\x20'+_0xf9a669);}let _0x15ff54,_0x2478f4;if(_0x56c3ef[_0x510fec(0x124)]&&_0x56c3ef[_0x510fec(0x103)])_0x15ff54=_0x56c3ef[_0x510fec(0x124)],_0x2478f4=_0x56c3ef['redirect_url'],console['log'](_0x510fec(0x170)+_0xf7674d+_0x510fec(0x146)),console[_0x510fec(0x17c)]('UUID:',_0x56c3ef['uuid']),console[_0x510fec(0x17c)](_0x510fec(0x169),_0x56c3ef[_0x510fec(0x103)]);else{if(_0x56c3ef[_0x510fec(0x150)])_0x15ff54=_0x179089,_0x2478f4=_0x56c3ef[_0x510fec(0x150)],console['log'](_0x510fec(0x170)+_0xf7674d+'\x20SUCCESS\x20(Legacy\x20Format)\x20==='),console[_0x510fec(0x17c)](_0x510fec(0x10e),_0x56c3ef[_0x510fec(0x150)]),console[_0x510fec(0x17c)](_0x510fec(0x164),_0x179089);else{console[_0x510fec(0x127)](_0x510fec(0x170)+_0xf7674d+_0x510fec(0x180)),console[_0x510fec(0x127)]('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console['error'](_0x510fec(0x137),_0x56c3ef),loggerService_1[_0x510fec(0x104)][_0x510fec(0x14e)](_0x510fec(0x16f)+_0xf7674d['toLowerCase'](),_0x510fec(0x175),_0x510fec(0x154));throw new Error(_0x510fec(0x158)+_0xf7674d+'\x20API:\x20missing\x20payment\x20data');}}return console[_0x510fec(0x17c)](_0x510fec(0x11c),_0x271e18,'('+_0xf7674d+_0x510fec(0x149)),console[_0x510fec(0x17c)](_0x510fec(0x117),_0x179089,_0x510fec(0x11f)),console[_0x510fec(0x17c)](_0x510fec(0xf2),_0xf7674d),{'gateway_payment_id':_0x15ff54,'payment_url':_0x2478f4};}catch(_0x547c9a){console[_0x510fec(0x127)](_0x510fec(0x170)+_0xf7674d+_0x510fec(0x14c)),console[_0x510fec(0x127)]('Error\x20details:',_0x547c9a),loggerService_1[_0x510fec(0x104)]['logWhiteDomainError'](_0x510fec(0x16f)+_0xf7674d['toLowerCase'](),_0x510fec(0x175),_0x547c9a);if(_0x547c9a instanceof Error){console['error'](_0x510fec(0x133),_0x547c9a[_0x510fec(0x106)]),console['error'](_0x510fec(0x10f),_0x547c9a[_0x510fec(0x163)]);throw new Error(_0x510fec(0xf8)+_0xf7674d+'\x20payment\x20link:\x20'+_0x547c9a[_0x510fec(0x106)]);}throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0xf7674d+'\x20payment\x20link:\x20Unknown\x20error');}}async['verifyPayment'](_0x40644b,_0x589821){const _0x50a7c1=a50_0x3cd814,_0x5304d1=Date[_0x50a7c1(0x160)]();try{const _0x4a26bf={'gatewayPaymentId':_0x40644b,'geo':_0x589821};loggerService_1[_0x50a7c1(0x104)][_0x50a7c1(0x168)](_0x50a7c1(0x16f)+_0x589821[_0x50a7c1(0x165)](),_0x50a7c1(0x15f)+_0x40644b,'POST',_0x4a26bf);const _0x209e17=await fetch(this[_0x50a7c1(0x119)],{'method':_0x50a7c1(0x138),'headers':{'Content-Type':_0x50a7c1(0x14d),'User-Agent':_0x50a7c1(0x100)},'body':JSON[_0x50a7c1(0x17a)](_0x4a26bf)}),_0x372406=Date['now']()-_0x5304d1;if(!_0x209e17['ok']){const _0x3bbfb4=await _0x209e17['text']();loggerService_1[_0x50a7c1(0x104)][_0x50a7c1(0x143)]('klyme_'+_0x589821[_0x50a7c1(0x165)](),'/verify/'+_0x40644b,_0x209e17[_0x50a7c1(0x15b)],_0x3bbfb4,_0x372406);throw new Error(_0x50a7c1(0x11e)+_0x209e17[_0x50a7c1(0x15b)]);}const _0x59f146=await _0x209e17[_0x50a7c1(0x145)]();loggerService_1['loggerService'][_0x50a7c1(0x143)](_0x50a7c1(0x16f)+_0x589821[_0x50a7c1(0x165)](),'/verify/'+_0x40644b,_0x209e17[_0x50a7c1(0x15b)],_0x59f146,_0x372406);if(_0x59f146[_0x50a7c1(0x127)]||_0x59f146[_0x50a7c1(0x136)]){loggerService_1['loggerService'][_0x50a7c1(0x14e)]('klyme_'+_0x589821[_0x50a7c1(0x165)](),'/verify/'+_0x40644b,'KLYME\x20'+_0x589821+_0x50a7c1(0x140)+(_0x59f146['message']||_0x59f146[_0x50a7c1(0x127)]||_0x50a7c1(0x147)));throw new Error(_0x50a7c1(0xf5)+_0x589821+_0x50a7c1(0x140)+(_0x59f146[_0x50a7c1(0x106)]||_0x59f146[_0x50a7c1(0x127)]||_0x50a7c1(0x147)));}let _0x1829a6=_0x50a7c1(0x177);return{'status':_0x1829a6};}catch(_0x570d00){console[_0x50a7c1(0x127)](_0x50a7c1(0xf5)+_0x589821+_0x50a7c1(0x16b),_0x570d00),loggerService_1[_0x50a7c1(0x104)][_0x50a7c1(0x14e)](_0x50a7c1(0x16f)+_0x589821[_0x50a7c1(0x165)](),_0x50a7c1(0x15f)+_0x40644b,_0x570d00);throw new Error(_0x50a7c1(0x11a)+_0x589821+_0x50a7c1(0xf4)+(_0x570d00 instanceof Error?_0x570d00[_0x50a7c1(0x106)]:_0x50a7c1(0x147)));}}async[a50_0x3cd814(0x111)](_0x1027e1){const _0x2e2f79=a50_0x3cd814;console[_0x2e2f79(0x17c)](_0x2e2f79(0x108),_0x1027e1);let _0x57e85c=_0x2e2f79(0x177);switch(_0x1027e1[_0x2e2f79(0x15b)]?.[_0x2e2f79(0x165)]()){case _0x2e2f79(0x16d):case _0x2e2f79(0x157):case _0x2e2f79(0x13c):case _0x2e2f79(0x151):case _0x2e2f79(0x130):_0x57e85c=_0x2e2f79(0x126);break;case _0x2e2f79(0x16a):case _0x2e2f79(0x128):case _0x2e2f79(0x142):case _0x2e2f79(0x127):case'rejected':_0x57e85c=_0x2e2f79(0x101);break;case _0x2e2f79(0x102):case'timeout':_0x57e85c=_0x2e2f79(0xf7);break;case _0x2e2f79(0x159):case _0x2e2f79(0x105):case _0x2e2f79(0x181):case _0x2e2f79(0x156):case _0x2e2f79(0x179):default:_0x57e85c=_0x2e2f79(0x177);break;}return{'paymentId':_0x1027e1[_0x2e2f79(0x161)]||_0x1027e1[_0x2e2f79(0x16e)]||_0x1027e1['payment_id'],'status':_0x57e85c,'amount':_0x1027e1['amount'],'currency':_0x1027e1['currency'],'region':_0x1027e1[_0x2e2f79(0x12d)],'additionalInfo':{'payment_method':_0x1027e1[_0x2e2f79(0x15d)],'transaction_id':_0x1027e1[_0x2e2f79(0x173)]}};}}function a50_0x3caf(_0x2fb380,_0x274f82){const _0x1232b5=a50_0x1232();return a50_0x3caf=function(_0x3cafd4,_0x15c9a5){_0x3cafd4=_0x3cafd4-0xf1;let _0x45d599=_0x1232b5[_0x3cafd4];return _0x45d599;},a50_0x3caf(_0x2fb380,_0x274f82);}exports[a50_0x3cd814(0xff)]=KlymeService;