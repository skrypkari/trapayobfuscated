'use strict';const a48_0x26d71e=a48_0x1e15;(function(_0x1d459b,_0x162d1e){const _0x51a4ea=a48_0x1e15,_0x1767e2=_0x1d459b();while(!![]){try{const _0x16edae=-parseInt(_0x51a4ea(0x240))/0x1*(parseInt(_0x51a4ea(0x1f3))/0x2)+parseInt(_0x51a4ea(0x255))/0x3+-parseInt(_0x51a4ea(0x212))/0x4*(-parseInt(_0x51a4ea(0x1da))/0x5)+parseInt(_0x51a4ea(0x1db))/0x6+parseInt(_0x51a4ea(0x1d9))/0x7*(-parseInt(_0x51a4ea(0x22b))/0x8)+-parseInt(_0x51a4ea(0x201))/0x9+parseInt(_0x51a4ea(0x1ea))/0xa;if(_0x16edae===_0x162d1e)break;else _0x1767e2['push'](_0x1767e2['shift']());}catch(_0x1ff599){_0x1767e2['push'](_0x1767e2['shift']());}}}(a48_0x3407,0x23f22));function a48_0x3407(){const _0x5b6427=['Error\x20Message:','KlymeService','default','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','Business\x20Error:\x20','URL:','\x20(8digits-8digits\x20format\x20for\x20','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','KLYME\x20','/create','\x20API\x20ERROR\x20===','EUR','\x20payment:\x20','/verify/','stringify','padStart','apiUrl','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','currency','‚ö†Ô∏è\x20KLYME\x20reference\x20','statusText','38296gdDWYZ','\x20SUCCESS\x20(Legacy\x20Format)\x20===','floor','timeout','Response\x20Time:','__esModule','resolve','uuid','https://tesoft.uk/gateway/pending.php?id=','__createBinding','loggerService','validateCurrencyForRegion','message','Payment\x20System/1.0','klyme_','payment','HTTP\x20Status:','Status:','EXPIRED','Unknown\x20error','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','1BAAjuu','Failed\x20to\x20create\x20KLYME\x20','Reference:','processWebhook','now','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','redirect_url','\x20SUCCESS\x20(New\x20Format)\x20===','\x20validated)','call','Error\x20message:','completed','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','Redirect\x20URL:','getOwnPropertyDescriptor','\x20API:\x20','PENDING','===\x20KLYME\x20','Unknown\x20error\x20from\x20KLYME\x20','\x20payment\x20link:\x20Unknown\x20error','79620NPbNIV','canceled','\x20SERVICE\x20ERROR\x20===','HTTP\x20error!\x20status:\x20','parse','üí≥\x20KLYME\x20','writable','order_id','Unsupported\x20KLYME\x20region:\x20','\x20payment\x20link:\x20','\x20payment\x20verification\x20error:','\x20API\x20BUSINESS\x20ERROR\x20===','defineProperty','PAID','logWhiteDomainRequest','Auth\x20URL:','Currency\x20Used:','fromEntries','text','__setModuleDefault','Response\x20Body:','(validated\x20for\x20','prototype','json','===\x20PARSED\x20KLYME\x20','357AWFtMA','137585fIDBBR','988230vUGsHY','get','application/json','https://tesoft.uk/gateway/klyme/','toLowerCase','statusCode','stack','verifyPayment','length','toString','entries','FAILED','Error\x20details:','POST','reference','5127620IlsPML','Status\x20Code:','\x20API\x20error:\x20','\x20API:\x20missing\x20payment\x20data','findFirst','random','authUrl','createPaymentLink','Geo\x20Parameter:','545236tXPeFD','rejected','Region\x20(geo):','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','pending','region','headers','error','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','HTTP\x20','toUpperCase','status','Reference\x20Used:','create','2093733xUGOOb','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','created','processing','generateUniqueReference','logWhiteDomainResponse','logWhiteDomainError','paid','GBP','configurable','Failed\x20to\x20verify\x20KLYME\x20','log','../loggerService','Failed\x20to\x20parse\x20JSON\x20response:','(8digits-8digits\x20format)','JSON\x20Parse\x20Error:\x20','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','28QUBHFa','__importStar','Status\x20Text:','payment_method'];a48_0x3407=function(){return _0x5b6427;};return a48_0x3407();}var __createBinding=this&&this[a48_0x26d71e(0x234)]||(Object[a48_0x26d71e(0x200)]?function(_0x328d01,_0x1b6ec3,_0x37f6cc,_0x5e0943){const _0x37c90b=a48_0x26d71e;if(_0x5e0943===undefined)_0x5e0943=_0x37f6cc;var _0x3f869e=Object[_0x37c90b(0x24f)](_0x1b6ec3,_0x37f6cc);(!_0x3f869e||(_0x37c90b(0x1dc)in _0x3f869e?!_0x1b6ec3['__esModule']:_0x3f869e[_0x37c90b(0x25b)]||_0x3f869e[_0x37c90b(0x20a)]))&&(_0x3f869e={'enumerable':!![],'get':function(){return _0x1b6ec3[_0x37f6cc];}}),Object[_0x37c90b(0x261)](_0x328d01,_0x5e0943,_0x3f869e);}:function(_0x64337c,_0xfd0f5d,_0x34ab9c,_0x6ab96d){if(_0x6ab96d===undefined)_0x6ab96d=_0x34ab9c;_0x64337c[_0x6ab96d]=_0xfd0f5d[_0x34ab9c];}),__setModuleDefault=this&&this[a48_0x26d71e(0x1d3)]||(Object[a48_0x26d71e(0x200)]?function(_0x13b5b6,_0x51fd4d){const _0x43eed2=a48_0x26d71e;Object[_0x43eed2(0x261)](_0x13b5b6,_0x43eed2(0x218),{'enumerable':!![],'value':_0x51fd4d});}:function(_0x42d654,_0x43d204){const _0x1d2202=a48_0x26d71e;_0x42d654[_0x1d2202(0x218)]=_0x43d204;}),__importStar=this&&this[a48_0x26d71e(0x213)]||(function(){var _0x873c01=function(_0x2d3d04){return _0x873c01=Object['getOwnPropertyNames']||function(_0x4163c8){const _0x4cd7a7=a48_0x1e15;var _0x50ed76=[];for(var _0x20c67d in _0x4163c8)if(Object[_0x4cd7a7(0x1d6)]['hasOwnProperty'][_0x4cd7a7(0x24a)](_0x4163c8,_0x20c67d))_0x50ed76[_0x50ed76['length']]=_0x20c67d;return _0x50ed76;},_0x873c01(_0x2d3d04);};return function(_0x5a411e){const _0x4b4973=a48_0x1e15;if(_0x5a411e&&_0x5a411e[_0x4b4973(0x230)])return _0x5a411e;var _0x21907d={};if(_0x5a411e!=null){for(var _0x48ebae=_0x873c01(_0x5a411e),_0x2d5c3d=0x0;_0x2d5c3d<_0x48ebae[_0x4b4973(0x1e3)];_0x2d5c3d++)if(_0x48ebae[_0x2d5c3d]!==_0x4b4973(0x218))__createBinding(_0x21907d,_0x5a411e,_0x48ebae[_0x2d5c3d]);}return __setModuleDefault(_0x21907d,_0x5a411e),_0x21907d;};}());Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a48_0x26d71e(0x217)]=void 0x0;function a48_0x1e15(_0x596171,_0x3a5bf2){const _0x340781=a48_0x3407();return a48_0x1e15=function(_0x1e15c6,_0x1cb21a){_0x1e15c6=_0x1e15c6-0x1cf;let _0xe5a40a=_0x340781[_0x1e15c6];return _0xe5a40a;},a48_0x1e15(_0x596171,_0x3a5bf2);}const loggerService_1=require(a48_0x26d71e(0x20d));class KlymeService{constructor(){const _0x1830d6=a48_0x26d71e;this['apiUrl']=_0x1830d6(0x1de),console[_0x1830d6(0x20c)](_0x1830d6(0x219));}[a48_0x26d71e(0x236)](_0x39c962,_0x5bde87){const _0x19d3e8=a48_0x26d71e,_0x2f8ca6=_0x39c962[_0x19d3e8(0x1fd)]();switch(_0x5bde87){case'EU':if(_0x2f8ca6!==_0x19d3e8(0x221))throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x2f8ca6);break;case'GB':if(_0x2f8ca6!==_0x19d3e8(0x209))throw new Error(_0x19d3e8(0x246)+_0x2f8ca6);break;case'DE':if(_0x2f8ca6!=='EUR')throw new Error(_0x19d3e8(0x23f)+_0x2f8ca6);break;default:throw new Error(_0x19d3e8(0x25d)+_0x5bde87);}}async['generateUniqueReference'](){const _0x5a135a=a48_0x26d71e,_0x3a36e3=(await Promise[_0x5a135a(0x231)]()['then'](()=>__importStar(require('../../config/database'))))[_0x5a135a(0x218)];let _0x5b2e0a,_0x2a1d45=0x0;const _0x19db6d=0xa;do{const _0x20d177=()=>{const _0x97a85a=_0x5a135a;return Math[_0x97a85a(0x22d)](Math[_0x97a85a(0x1ef)]()*0x5f5e100)[_0x97a85a(0x1e4)]()[_0x97a85a(0x225)](0x8,'0');};_0x5b2e0a=_0x20d177()+'-'+_0x20d177();const _0x52553e=await _0x3a36e3[_0x5a135a(0x23a)][_0x5a135a(0x1ee)]({'where':{'gatewayOrderId':_0x5b2e0a}});if(!_0x52553e)break;_0x2a1d45++,console['log'](_0x5a135a(0x229)+_0x5b2e0a+_0x5a135a(0x245)+_0x2a1d45+')');}while(_0x2a1d45<_0x19db6d);if(_0x2a1d45>=_0x19db6d)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x5b2e0a;}async[a48_0x26d71e(0x1f1)](_0x1eb1d0){const _0x189176=a48_0x26d71e,{orderId:_0x28ec6f,amount:_0x277215,currency:_0x19ef66,region:_0x4bddce}=_0x1eb1d0;if(_0x4bddce!=='EU'&&_0x4bddce!=='GB'&&_0x4bddce!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x4bddce);this[_0x189176(0x236)](_0x19ef66,_0x4bddce);const _0x34bf12=_0x19ef66[_0x189176(0x1fd)]();console['log'](_0x189176(0x25a)+_0x4bddce+'\x20currency\x20validation\x20passed:\x20'+_0x34bf12);const _0x53781c=await this[_0x189176(0x205)]();console['log'](_0x189176(0x202)+_0x53781c+_0x189176(0x21c)+_0x4bddce+')');const _0x278f87=_0x189176(0x233)+_0x28ec6f,_0x3dc44b={'amount':_0x277215,'currency':_0x34bf12,'redirectUrl':_0x278f87,'reference':_0x53781c,'geo':_0x4bddce},_0xbb9055=Date[_0x189176(0x244)]();try{console[_0x189176(0x20c)](_0x189176(0x252)+_0x4bddce+_0x189176(0x211)),console[_0x189176(0x20c)](_0x189176(0x21b),this[_0x189176(0x226)]),console['log']('Request\x20Body:',JSON[_0x189176(0x224)](_0x3dc44b,null,0x2)),console[_0x189176(0x20c)](_0x189176(0x1f5),_0x4bddce),console[_0x189176(0x20c)]('Currency:',_0x34bf12,_0x189176(0x1d5)+_0x4bddce+')'),console['log'](_0x189176(0x242),_0x53781c,_0x189176(0x20f)),console['log'](_0x189176(0x24e),_0x278f87),loggerService_1[_0x189176(0x235)][_0x189176(0x263)](_0x189176(0x239)+_0x4bddce['toLowerCase'](),_0x189176(0x21f),_0x189176(0x1e8),_0x3dc44b);const _0x42967b=await fetch(this[_0x189176(0x226)],{'method':_0x189176(0x1e8),'headers':{'Content-Type':_0x189176(0x1dd),'Accept':_0x189176(0x1dd),'User-Agent':_0x189176(0x238)},'body':JSON['stringify'](_0x3dc44b)}),_0x1c2129=Date[_0x189176(0x244)]()-_0xbb9055;console['log'](_0x189176(0x252)+_0x4bddce+_0x189176(0x227)),console[_0x189176(0x20c)](_0x189176(0x23c),_0x42967b['status']),console[_0x189176(0x20c)](_0x189176(0x214),_0x42967b[_0x189176(0x22a)]),console[_0x189176(0x20c)]('Headers:',Object[_0x189176(0x1d1)](_0x42967b[_0x189176(0x1f9)][_0x189176(0x1e5)]())),console[_0x189176(0x20c)](_0x189176(0x22f),_0x1c2129+'ms');const _0x23253a=await _0x42967b[_0x189176(0x1d2)]();console['log']('Raw\x20Response\x20Body:',_0x23253a);if(!_0x42967b['ok']){console[_0x189176(0x1fa)]('===\x20KLYME\x20'+_0x4bddce+_0x189176(0x220)),console[_0x189176(0x1fa)](_0x189176(0x23b),_0x42967b[_0x189176(0x1fe)]),console[_0x189176(0x1fa)](_0x189176(0x1d4),_0x23253a),loggerService_1[_0x189176(0x235)][_0x189176(0x206)](_0x189176(0x239)+_0x4bddce[_0x189176(0x1df)](),'/create',_0x42967b[_0x189176(0x1fe)],_0x23253a,_0x1c2129),loggerService_1[_0x189176(0x235)][_0x189176(0x207)](_0x189176(0x239)+_0x4bddce[_0x189176(0x1df)](),_0x189176(0x21f),_0x189176(0x1fc)+_0x42967b[_0x189176(0x1fe)]+':\x20'+_0x23253a);throw new Error(_0x189176(0x258)+_0x42967b['status']+',\x20body:\x20'+_0x23253a);}let _0x40f504;try{_0x40f504=JSON[_0x189176(0x259)](_0x23253a);}catch(_0x326594){console[_0x189176(0x1fa)](_0x189176(0x20e),_0x326594),loggerService_1[_0x189176(0x235)][_0x189176(0x207)](_0x189176(0x239)+_0x4bddce[_0x189176(0x1df)](),'/create',_0x189176(0x210)+_0x326594);throw new Error(_0x189176(0x1f6)+_0x4bddce+_0x189176(0x250)+_0x23253a);}console[_0x189176(0x20c)](_0x189176(0x1d8)+_0x4bddce+'\x20RESPONSE\x20==='),console[_0x189176(0x20c)]('Parsed\x20Result:',JSON[_0x189176(0x224)](_0x40f504,null,0x2)),loggerService_1[_0x189176(0x235)][_0x189176(0x206)]('klyme_'+_0x4bddce['toLowerCase'](),'/create',_0x42967b['status'],_0x40f504,_0x1c2129);if(_0x40f504[_0x189176(0x1fa)]||_0x40f504[_0x189176(0x1e0)]){const _0xf427b6=_0x40f504[_0x189176(0x237)]||_0x40f504[_0x189176(0x1fa)]||_0x189176(0x253)+_0x4bddce+'\x20API';console[_0x189176(0x1fa)]('===\x20KLYME\x20'+_0x4bddce+_0x189176(0x260)),console['error'](_0x189176(0x216),_0xf427b6),console[_0x189176(0x1fa)](_0x189176(0x1eb),_0x40f504[_0x189176(0x1e0)]),loggerService_1['loggerService']['logWhiteDomainError'](_0x189176(0x239)+_0x4bddce[_0x189176(0x1df)](),_0x189176(0x21f),_0x189176(0x21a)+_0xf427b6);throw new Error(_0x189176(0x21e)+_0x4bddce+_0x189176(0x1ec)+_0xf427b6);}let _0x1e24ab,_0x561dc1;if(_0x40f504[_0x189176(0x232)]&&_0x40f504['redirect_url'])_0x1e24ab=_0x40f504[_0x189176(0x232)],_0x561dc1=_0x40f504[_0x189176(0x247)],console[_0x189176(0x20c)](_0x189176(0x252)+_0x4bddce+_0x189176(0x248)),console[_0x189176(0x20c)]('UUID:',_0x40f504[_0x189176(0x232)]),console[_0x189176(0x20c)](_0x189176(0x24e),_0x40f504[_0x189176(0x247)]);else{if(_0x40f504[_0x189176(0x1f0)])_0x1e24ab=_0x53781c,_0x561dc1=_0x40f504[_0x189176(0x1f0)],console[_0x189176(0x20c)](_0x189176(0x252)+_0x4bddce+_0x189176(0x22c)),console[_0x189176(0x20c)](_0x189176(0x1cf),_0x40f504[_0x189176(0x1f0)]),console[_0x189176(0x20c)]('Reference\x20Used\x20as\x20ID:',_0x53781c);else{console[_0x189176(0x1fa)](_0x189176(0x252)+_0x4bddce+_0x189176(0x1fb)),console['error'](_0x189176(0x21d)),console[_0x189176(0x1fa)]('Response\x20data:',_0x40f504),loggerService_1['loggerService']['logWhiteDomainError'](_0x189176(0x239)+_0x4bddce[_0x189176(0x1df)](),_0x189176(0x21f),_0x189176(0x24d));throw new Error('Invalid\x20response\x20from\x20KLYME\x20'+_0x4bddce+_0x189176(0x1ed));}}return console[_0x189176(0x20c)](_0x189176(0x1d0),_0x34bf12,'('+_0x4bddce+_0x189176(0x249)),console[_0x189176(0x20c)](_0x189176(0x1ff),_0x53781c,_0x189176(0x20f)),console[_0x189176(0x20c)](_0x189176(0x1f2),_0x4bddce),{'gateway_payment_id':_0x1e24ab,'payment_url':_0x561dc1};}catch(_0x4a084d){console[_0x189176(0x1fa)](_0x189176(0x252)+_0x4bddce+_0x189176(0x257)),console[_0x189176(0x1fa)](_0x189176(0x1e7),_0x4a084d),loggerService_1[_0x189176(0x235)][_0x189176(0x207)](_0x189176(0x239)+_0x4bddce[_0x189176(0x1df)](),'/create',_0x4a084d);if(_0x4a084d instanceof Error){console[_0x189176(0x1fa)](_0x189176(0x24b),_0x4a084d[_0x189176(0x237)]),console[_0x189176(0x1fa)]('Error\x20stack:',_0x4a084d[_0x189176(0x1e1)]);throw new Error(_0x189176(0x241)+_0x4bddce+_0x189176(0x25e)+_0x4a084d['message']);}throw new Error(_0x189176(0x241)+_0x4bddce+_0x189176(0x254));}}async[a48_0x26d71e(0x1e2)](_0x2c2983,_0x221e29){const _0x592591=a48_0x26d71e,_0x1fdd5c=Date[_0x592591(0x244)]();try{const _0x29a95e={'gatewayPaymentId':_0x2c2983,'geo':_0x221e29};loggerService_1[_0x592591(0x235)][_0x592591(0x263)]('klyme_'+_0x221e29[_0x592591(0x1df)](),_0x592591(0x223)+_0x2c2983,_0x592591(0x1e8),_0x29a95e);const _0x29f337=await fetch(this[_0x592591(0x226)],{'method':_0x592591(0x1e8),'headers':{'Content-Type':_0x592591(0x1dd),'User-Agent':_0x592591(0x238)},'body':JSON[_0x592591(0x224)](_0x29a95e)}),_0x2b9d4f=Date[_0x592591(0x244)]()-_0x1fdd5c;if(!_0x29f337['ok']){const _0x313dce=await _0x29f337[_0x592591(0x1d2)]();loggerService_1['loggerService']['logWhiteDomainResponse'](_0x592591(0x239)+_0x221e29[_0x592591(0x1df)](),'/verify/'+_0x2c2983,_0x29f337[_0x592591(0x1fe)],_0x313dce,_0x2b9d4f);throw new Error(_0x592591(0x258)+_0x29f337[_0x592591(0x1fe)]);}const _0x42930f=await _0x29f337[_0x592591(0x1d7)]();loggerService_1[_0x592591(0x235)]['logWhiteDomainResponse'](_0x592591(0x239)+_0x221e29['toLowerCase'](),_0x592591(0x223)+_0x2c2983,_0x29f337['status'],_0x42930f,_0x2b9d4f);if(_0x42930f['error']||_0x42930f[_0x592591(0x1e0)]){loggerService_1[_0x592591(0x235)][_0x592591(0x207)](_0x592591(0x239)+_0x221e29[_0x592591(0x1df)](),_0x592591(0x223)+_0x2c2983,_0x592591(0x21e)+_0x221e29+_0x592591(0x1ec)+(_0x42930f['message']||_0x42930f['error']||_0x592591(0x23e)));throw new Error('KLYME\x20'+_0x221e29+_0x592591(0x1ec)+(_0x42930f[_0x592591(0x237)]||_0x42930f[_0x592591(0x1fa)]||_0x592591(0x23e)));}let _0x4ab8af='PENDING';return{'status':_0x4ab8af};}catch(_0x5a443b){console[_0x592591(0x1fa)](_0x592591(0x21e)+_0x221e29+_0x592591(0x25f),_0x5a443b),loggerService_1[_0x592591(0x235)][_0x592591(0x207)](_0x592591(0x239)+_0x221e29[_0x592591(0x1df)](),_0x592591(0x223)+_0x2c2983,_0x5a443b);throw new Error(_0x592591(0x20b)+_0x221e29+_0x592591(0x222)+(_0x5a443b instanceof Error?_0x5a443b['message']:_0x592591(0x23e)));}}async[a48_0x26d71e(0x243)](_0x26c442){const _0x2bce45=a48_0x26d71e;console['log']('Processing\x20KLYME\x20webhook:',_0x26c442);let _0x26404c=_0x2bce45(0x251);switch(_0x26c442[_0x2bce45(0x1fe)]?.[_0x2bce45(0x1df)]()){case _0x2bce45(0x208):case _0x2bce45(0x24c):case'confirmed':case'success':case'successful':_0x26404c=_0x2bce45(0x262);break;case'cancelled':case _0x2bce45(0x256):case'failed':case'error':case _0x2bce45(0x1f4):_0x26404c=_0x2bce45(0x1e6);break;case'expired':case _0x2bce45(0x22e):_0x26404c=_0x2bce45(0x23d);break;case _0x2bce45(0x1f7):case _0x2bce45(0x203):case'active':case _0x2bce45(0x204):case'in_progress':default:_0x26404c=_0x2bce45(0x251);break;}return{'paymentId':_0x26c442[_0x2bce45(0x1e9)]||_0x26c442[_0x2bce45(0x25c)]||_0x26c442['payment_id'],'status':_0x26404c,'amount':_0x26c442['amount'],'currency':_0x26c442[_0x2bce45(0x228)],'region':_0x26c442[_0x2bce45(0x1f8)],'additionalInfo':{'payment_method':_0x26c442[_0x2bce45(0x215)],'transaction_id':_0x26c442['transaction_id']}};}}exports[a48_0x26d71e(0x217)]=KlymeService;