'use strict';function a41_0x4446(_0x325800,_0x4b0d5f){const _0x4dbf47=a41_0x4dbf();return a41_0x4446=function(_0x444664,_0x42019c){_0x444664=_0x444664-0xca;let _0x3a62c1=_0x4dbf47[_0x444664];return _0x3a62c1;},a41_0x4446(_0x325800,_0x4b0d5f);}const a41_0x3728fd=a41_0x4446;(function(_0x553d03,_0x4c33e8){const _0xd4eebb=a41_0x4446,_0x24d8dc=_0x553d03();while(!![]){try{const _0x2b1b44=-parseInt(_0xd4eebb(0x108))/0x1+parseInt(_0xd4eebb(0x117))/0x2+parseInt(_0xd4eebb(0xf7))/0x3+parseInt(_0xd4eebb(0x12f))/0x4+-parseInt(_0xd4eebb(0xd6))/0x5+parseInt(_0xd4eebb(0xe7))/0x6+-parseInt(_0xd4eebb(0x112))/0x7;if(_0x2b1b44===_0x4c33e8)break;else _0x24d8dc['push'](_0x24d8dc['shift']());}catch(_0x343bb6){_0x24d8dc['push'](_0x24d8dc['shift']());}}}(a41_0x4dbf,0x6988c));var __createBinding=this&&this[a41_0x3728fd(0x15b)]||(Object[a41_0x3728fd(0x102)]?function(_0x9e3a57,_0x22355f,_0x4201c0,_0x308ba0){const _0x10e018=a41_0x3728fd;if(_0x308ba0===undefined)_0x308ba0=_0x4201c0;var _0x22b9a8=Object[_0x10e018(0xfd)](_0x22355f,_0x4201c0);(!_0x22b9a8||(_0x10e018(0x10a)in _0x22b9a8?!_0x22355f[_0x10e018(0x106)]:_0x22b9a8[_0x10e018(0x124)]||_0x22b9a8[_0x10e018(0x158)]))&&(_0x22b9a8={'enumerable':!![],'get':function(){return _0x22355f[_0x4201c0];}}),Object[_0x10e018(0xcc)](_0x9e3a57,_0x308ba0,_0x22b9a8);}:function(_0x44fcca,_0x2a33eb,_0x3546bc,_0x283537){if(_0x283537===undefined)_0x283537=_0x3546bc;_0x44fcca[_0x283537]=_0x2a33eb[_0x3546bc];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x423f4e,_0x34216c){const _0x45c211=a41_0x3728fd;Object[_0x45c211(0xcc)](_0x423f4e,_0x45c211(0x144),{'enumerable':!![],'value':_0x34216c});}:function(_0x284df7,_0x3a23c7){const _0x1c723a=a41_0x3728fd;_0x284df7[_0x1c723a(0x144)]=_0x3a23c7;}),__importStar=this&&this['__importStar']||(function(){var _0x4720a4=function(_0x324515){const _0x21faa6=a41_0x4446;return _0x4720a4=Object[_0x21faa6(0x127)]||function(_0x1ecc8f){const _0x3a8f1e=_0x21faa6;var _0x144444=[];for(var _0x684702 in _0x1ecc8f)if(Object[_0x3a8f1e(0xf0)][_0x3a8f1e(0xe1)]['call'](_0x1ecc8f,_0x684702))_0x144444[_0x144444[_0x3a8f1e(0xcb)]]=_0x684702;return _0x144444;},_0x4720a4(_0x324515);};return function(_0x469968){const _0x1267e3=a41_0x4446;if(_0x469968&&_0x469968[_0x1267e3(0x106)])return _0x469968;var _0x391858={};if(_0x469968!=null){for(var _0x47c82f=_0x4720a4(_0x469968),_0x170536=0x0;_0x170536<_0x47c82f['length'];_0x170536++)if(_0x47c82f[_0x170536]!==_0x1267e3(0x144))__createBinding(_0x391858,_0x469968,_0x47c82f[_0x170536]);}return __setModuleDefault(_0x391858,_0x469968),_0x391858;};}());Object[a41_0x3728fd(0xcc)](exports,a41_0x3728fd(0x106),{'value':!![]}),exports['KlymeService']=void 0x0;const loggerService_1=require(a41_0x3728fd(0xff));class KlymeService{constructor(){const _0x45cfb5=a41_0x3728fd;this[_0x45cfb5(0xda)]=_0x45cfb5(0xfe),console[_0x45cfb5(0x101)](_0x45cfb5(0x14f));}[a41_0x3728fd(0x141)](_0x5ab039,_0x39cbe7){const _0x22a106=a41_0x3728fd,_0x54ae09=_0x5ab039[_0x22a106(0x111)]();switch(_0x39cbe7){case'EU':if(_0x54ae09!==_0x22a106(0x15a))throw new Error(_0x22a106(0xe9)+_0x54ae09);break;case'GB':if(_0x54ae09!==_0x22a106(0x14b))throw new Error(_0x22a106(0xd4)+_0x54ae09);break;case'DE':if(_0x54ae09!==_0x22a106(0x15a))throw new Error(_0x22a106(0xee)+_0x54ae09);break;default:throw new Error(_0x22a106(0x157)+_0x39cbe7);}}async['generateUniqueReference'](){const _0x3f8fc6=a41_0x3728fd,_0x1eb00b=(await Promise[_0x3f8fc6(0xf8)]()[_0x3f8fc6(0x12d)](()=>__importStar(require(_0x3f8fc6(0xf9)))))[_0x3f8fc6(0x144)];let _0x441300,_0x3c58b9=0x0;const _0x46e968=0xa;do{const _0x3c5f47=()=>{const _0x571a38=_0x3f8fc6;return Math['floor'](Math['random']()*0x5f5e100)[_0x571a38(0x150)]()[_0x571a38(0x10f)](0x8,'0');};_0x441300=_0x3c5f47()+'-'+_0x3c5f47();const _0x21a0b9=await _0x1eb00b[_0x3f8fc6(0x104)][_0x3f8fc6(0x12a)]({'where':{'gatewayOrderId':_0x441300}});if(!_0x21a0b9)break;_0x3c58b9++,console[_0x3f8fc6(0x101)](_0x3f8fc6(0xeb)+_0x441300+_0x3f8fc6(0xe6)+_0x3c58b9+')');}while(_0x3c58b9<_0x46e968);if(_0x3c58b9>=_0x46e968)throw new Error(_0x3f8fc6(0x147));return _0x441300;}async[a41_0x3728fd(0x110)](_0x2d5d2b){const _0x4c564a=a41_0x3728fd,{orderId:_0x462c34,amount:_0x183f63,currency:_0x528859,region:_0x5e440f}=_0x2d5d2b;if(_0x5e440f!=='EU'&&_0x5e440f!=='GB'&&_0x5e440f!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x5e440f);this[_0x4c564a(0x141)](_0x528859,_0x5e440f);const _0xd5761=_0x528859['toUpperCase']();console[_0x4c564a(0x101)]('💳\x20KLYME\x20'+_0x5e440f+_0x4c564a(0xcf)+_0xd5761);const _0x4ac135=await this[_0x4c564a(0xd3)]();console[_0x4c564a(0x101)](_0x4c564a(0x148)+_0x4ac135+_0x4c564a(0x14e)+_0x5e440f+')');const _0x4f6ac2=_0x4c564a(0x156)+_0x462c34,_0x14b089={'amount':_0x183f63,'currency':_0xd5761,'redirectUrl':_0x4f6ac2,'reference':_0x4ac135,'geo':_0x5e440f},_0x84f882=Date[_0x4c564a(0x125)]();try{console[_0x4c564a(0x101)](_0x4c564a(0x14a)+_0x5e440f+_0x4c564a(0xd2)),console[_0x4c564a(0x101)](_0x4c564a(0xdf),this[_0x4c564a(0xda)]),console['log'](_0x4c564a(0x11e),JSON[_0x4c564a(0x11d)](_0x14b089,null,0x2)),console[_0x4c564a(0x101)](_0x4c564a(0xd8),_0x5e440f),console['log'](_0x4c564a(0xdc),_0xd5761,_0x4c564a(0xdb)+_0x5e440f+')'),console['log'](_0x4c564a(0xe2),_0x4ac135,'(8digits-8digits\x20format)'),console[_0x4c564a(0x101)]('Redirect\x20URL:',_0x4f6ac2),loggerService_1[_0x4c564a(0x123)][_0x4c564a(0x145)]('klyme_'+_0x5e440f[_0x4c564a(0x146)](),_0x4c564a(0x121),_0x4c564a(0x129),_0x14b089);const _0x2439da=await fetch(this['apiUrl'],{'method':_0x4c564a(0x129),'headers':{'Content-Type':_0x4c564a(0x143),'Accept':_0x4c564a(0x143),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x4c564a(0x11d)](_0x14b089)}),_0x3b221e=Date[_0x4c564a(0x125)]()-_0x84f882;console[_0x4c564a(0x101)](_0x4c564a(0x14a)+_0x5e440f+'\x20API\x20RESPONSE\x20(Unified\x20Route)\x20==='),console[_0x4c564a(0x101)]('Status:',_0x2439da[_0x4c564a(0x153)]),console[_0x4c564a(0x101)](_0x4c564a(0xd9),_0x2439da[_0x4c564a(0xf4)]),console[_0x4c564a(0x101)](_0x4c564a(0x14c),Object[_0x4c564a(0xca)](_0x2439da[_0x4c564a(0x131)][_0x4c564a(0xfb)]())),console[_0x4c564a(0x101)](_0x4c564a(0x13e),_0x3b221e+'ms');const _0x580932=await _0x2439da[_0x4c564a(0x10e)]();console['log'](_0x4c564a(0x12e),_0x580932);if(!_0x2439da['ok']){console[_0x4c564a(0x151)](_0x4c564a(0x14a)+_0x5e440f+_0x4c564a(0x139)),console['error'](_0x4c564a(0xe8),_0x2439da[_0x4c564a(0x153)]),console['error']('Response\x20Body:',_0x580932),loggerService_1['loggerService'][_0x4c564a(0x140)](_0x4c564a(0x132)+_0x5e440f[_0x4c564a(0x146)](),_0x4c564a(0x121),_0x2439da[_0x4c564a(0x153)],_0x580932,_0x3b221e),loggerService_1[_0x4c564a(0x123)]['logWhiteDomainError'](_0x4c564a(0x132)+_0x5e440f[_0x4c564a(0x146)](),_0x4c564a(0x121),_0x4c564a(0x100)+_0x2439da['status']+':\x20'+_0x580932);throw new Error(_0x4c564a(0x109)+_0x2439da[_0x4c564a(0x153)]+_0x4c564a(0x126)+_0x580932);}let _0x254b13;try{_0x254b13=JSON[_0x4c564a(0x115)](_0x580932);}catch(_0x426f9f){console['error'](_0x4c564a(0xed),_0x426f9f),loggerService_1['loggerService'][_0x4c564a(0x10d)](_0x4c564a(0x132)+_0x5e440f[_0x4c564a(0x146)](),_0x4c564a(0x121),'JSON\x20Parse\x20Error:\x20'+_0x426f9f);throw new Error(_0x4c564a(0xf6)+_0x5e440f+_0x4c564a(0x128)+_0x580932);}console[_0x4c564a(0x101)](_0x4c564a(0x118)+_0x5e440f+_0x4c564a(0x13a)),console['log'](_0x4c564a(0x11f),JSON['stringify'](_0x254b13,null,0x2)),loggerService_1[_0x4c564a(0x123)][_0x4c564a(0x140)](_0x4c564a(0x132)+_0x5e440f[_0x4c564a(0x146)](),'/create',_0x2439da['status'],_0x254b13,_0x3b221e);if(_0x254b13[_0x4c564a(0x151)]||_0x254b13[_0x4c564a(0x14d)]){const _0x229a24=_0x254b13[_0x4c564a(0x13b)]||_0x254b13[_0x4c564a(0x151)]||_0x4c564a(0xe0)+_0x5e440f+_0x4c564a(0x103);console[_0x4c564a(0x151)](_0x4c564a(0x14a)+_0x5e440f+_0x4c564a(0xd0)),console['error'](_0x4c564a(0x137),_0x229a24),console[_0x4c564a(0x151)]('Status\x20Code:',_0x254b13[_0x4c564a(0x14d)]),loggerService_1[_0x4c564a(0x123)]['logWhiteDomainError'](_0x4c564a(0x132)+_0x5e440f[_0x4c564a(0x146)](),'/create',_0x4c564a(0x122)+_0x229a24);throw new Error(_0x4c564a(0xdd)+_0x5e440f+'\x20API\x20error:\x20'+_0x229a24);}let _0x4a4be6,_0x1d1a59;if(_0x254b13['uuid']&&_0x254b13[_0x4c564a(0xce)])_0x4a4be6=_0x254b13[_0x4c564a(0xd5)],_0x1d1a59=_0x254b13[_0x4c564a(0xce)],console[_0x4c564a(0x101)](_0x4c564a(0x14a)+_0x5e440f+_0x4c564a(0x12b)),console[_0x4c564a(0x101)]('UUID:',_0x254b13['uuid']),console[_0x4c564a(0x101)]('Redirect\x20URL:',_0x254b13['redirect_url']);else{if(_0x254b13[_0x4c564a(0x15c)])_0x4a4be6=_0x4ac135,_0x1d1a59=_0x254b13[_0x4c564a(0x15c)],console['log'](_0x4c564a(0x14a)+_0x5e440f+_0x4c564a(0x114)),console[_0x4c564a(0x101)]('Auth\x20URL:',_0x254b13['authUrl']),console[_0x4c564a(0x101)]('Reference\x20Used\x20as\x20ID:',_0x4ac135);else{console['error'](_0x4c564a(0x14a)+_0x5e440f+_0x4c564a(0x113)),console['error'](_0x4c564a(0xea)),console[_0x4c564a(0x151)](_0x4c564a(0x142),_0x254b13),loggerService_1['loggerService']['logWhiteDomainError'](_0x4c564a(0x132)+_0x5e440f[_0x4c564a(0x146)](),'/create','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl');throw new Error(_0x4c564a(0x11c)+_0x5e440f+_0x4c564a(0x13f));}}return console[_0x4c564a(0x101)]('Currency\x20Used:',_0xd5761,'('+_0x5e440f+_0x4c564a(0x152)),console[_0x4c564a(0x101)](_0x4c564a(0x155),_0x4ac135,_0x4c564a(0x11b)),console[_0x4c564a(0x101)](_0x4c564a(0x138),_0x5e440f),{'gateway_payment_id':_0x4a4be6,'payment_url':_0x1d1a59};}catch(_0x1b84a1){console[_0x4c564a(0x151)](_0x4c564a(0x14a)+_0x5e440f+'\x20SERVICE\x20ERROR\x20==='),console['error']('Error\x20details:',_0x1b84a1),loggerService_1[_0x4c564a(0x123)][_0x4c564a(0x10d)](_0x4c564a(0x132)+_0x5e440f[_0x4c564a(0x146)](),_0x4c564a(0x121),_0x1b84a1);if(_0x1b84a1 instanceof Error){console[_0x4c564a(0x151)](_0x4c564a(0xf1),_0x1b84a1[_0x4c564a(0x13b)]),console[_0x4c564a(0x151)](_0x4c564a(0xd7),_0x1b84a1['stack']);throw new Error(_0x4c564a(0x130)+_0x5e440f+_0x4c564a(0x134)+_0x1b84a1['message']);}throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0x5e440f+_0x4c564a(0xe5));}}async[a41_0x3728fd(0xe3)](_0x1e969d,_0x4186ba){const _0x44d333=a41_0x3728fd,_0x31ea3e=Date[_0x44d333(0x125)]();try{const _0x184143={'gatewayPaymentId':_0x1e969d,'geo':_0x4186ba};loggerService_1[_0x44d333(0x123)][_0x44d333(0x145)](_0x44d333(0x132)+_0x4186ba[_0x44d333(0x146)](),_0x44d333(0x116)+_0x1e969d,_0x44d333(0x129),_0x184143);const _0x13b55a=await fetch(this[_0x44d333(0xda)],{'method':_0x44d333(0x129),'headers':{'Content-Type':_0x44d333(0x143),'User-Agent':_0x44d333(0x135)},'body':JSON[_0x44d333(0x11d)](_0x184143)}),_0x5e6231=Date[_0x44d333(0x125)]()-_0x31ea3e;if(!_0x13b55a['ok']){const _0x20d48=await _0x13b55a[_0x44d333(0x10e)]();loggerService_1[_0x44d333(0x123)][_0x44d333(0x140)](_0x44d333(0x132)+_0x4186ba[_0x44d333(0x146)](),_0x44d333(0x116)+_0x1e969d,_0x13b55a[_0x44d333(0x153)],_0x20d48,_0x5e6231);throw new Error(_0x44d333(0x109)+_0x13b55a['status']);}const _0x489aae=await _0x13b55a['json']();loggerService_1[_0x44d333(0x123)][_0x44d333(0x140)](_0x44d333(0x132)+_0x4186ba[_0x44d333(0x146)](),'/verify/'+_0x1e969d,_0x13b55a[_0x44d333(0x153)],_0x489aae,_0x5e6231);if(_0x489aae[_0x44d333(0x151)]||_0x489aae[_0x44d333(0x14d)]){loggerService_1['loggerService'][_0x44d333(0x10d)]('klyme_'+_0x4186ba[_0x44d333(0x146)](),_0x44d333(0x116)+_0x1e969d,_0x44d333(0xdd)+_0x4186ba+_0x44d333(0xf2)+(_0x489aae[_0x44d333(0x13b)]||_0x489aae['error']||_0x44d333(0x107)));throw new Error('KLYME\x20'+_0x4186ba+'\x20API\x20error:\x20'+(_0x489aae[_0x44d333(0x13b)]||_0x489aae[_0x44d333(0x151)]||_0x44d333(0x107)));}let _0x483e12='PENDING';return{'status':_0x483e12};}catch(_0x41ca5a){console[_0x44d333(0x151)](_0x44d333(0xdd)+_0x4186ba+_0x44d333(0x120),_0x41ca5a),loggerService_1[_0x44d333(0x123)]['logWhiteDomainError'](_0x44d333(0x132)+_0x4186ba[_0x44d333(0x146)](),_0x44d333(0x116)+_0x1e969d,_0x41ca5a);throw new Error(_0x44d333(0xf5)+_0x4186ba+_0x44d333(0xcd)+(_0x41ca5a instanceof Error?_0x41ca5a[_0x44d333(0x13b)]:_0x44d333(0x107)));}}async['processWebhook'](_0x57a151){const _0x2a8a86=a41_0x3728fd;console[_0x2a8a86(0x101)](_0x2a8a86(0x13c),_0x57a151);let _0x3a3fd4=_0x2a8a86(0x149);switch(_0x57a151[_0x2a8a86(0x153)]?.[_0x2a8a86(0x146)]()){case'paid':case _0x2a8a86(0xd1):case'confirmed':case _0x2a8a86(0x12c):case'successful':_0x3a3fd4=_0x2a8a86(0xec);break;case _0x2a8a86(0xf3):case _0x2a8a86(0x105):case'failed':case _0x2a8a86(0x151):case _0x2a8a86(0x11a):_0x3a3fd4=_0x2a8a86(0xfa);break;case'expired':case _0x2a8a86(0x10c):_0x3a3fd4=_0x2a8a86(0x159);break;case _0x2a8a86(0x10b):case _0x2a8a86(0xef):case'active':case _0x2a8a86(0xde):case _0x2a8a86(0x154):default:_0x3a3fd4='PENDING';break;}return{'paymentId':_0x57a151['reference']||_0x57a151['order_id']||_0x57a151[_0x2a8a86(0x136)],'status':_0x3a3fd4,'amount':_0x57a151[_0x2a8a86(0xe4)],'currency':_0x57a151[_0x2a8a86(0x119)],'region':_0x57a151['region'],'additionalInfo':{'payment_method':_0x57a151[_0x2a8a86(0xfc)],'transaction_id':_0x57a151[_0x2a8a86(0x133)]}};}}exports[a41_0x3728fd(0x13d)]=KlymeService;function a41_0x4dbf(){const _0x4273be=['headers','klyme_','transaction_id','\x20payment\x20link:\x20','TesSoft\x20Payment\x20System/1.0','payment_id','Error\x20Message:','Geo\x20Parameter:','\x20API\x20ERROR\x20===','\x20RESPONSE\x20===','message','Processing\x20KLYME\x20webhook:','KlymeService','Response\x20Time:','\x20API:\x20missing\x20payment\x20data','logWhiteDomainResponse','validateCurrencyForRegion','Response\x20data:','application/json','default','logWhiteDomainRequest','toLowerCase','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20','PENDING','===\x20KLYME\x20','GBP','Headers:','statusCode','\x20(8digits-8digits\x20format\x20for\x20','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','toString','error','\x20validated)','status','in_progress','Reference\x20Used:','https://tesoft.uk/gateway/pending.php?id=','Unsupported\x20KLYME\x20region:\x20','configurable','EXPIRED','EUR','__createBinding','authUrl','fromEntries','length','defineProperty','\x20payment:\x20','redirect_url','\x20currency\x20validation\x20passed:\x20','\x20API\x20BUSINESS\x20ERROR\x20===','completed','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','generateUniqueReference','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','uuid','3338845mIzxWP','Error\x20stack:','Region\x20(geo):','Status\x20Text:','apiUrl','(validated\x20for\x20','Currency:','KLYME\x20','processing','URL:','Unknown\x20error\x20from\x20KLYME\x20','hasOwnProperty','Reference:','verifyPayment','amount','\x20payment\x20link:\x20Unknown\x20error','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','3145272fOtHgt','HTTP\x20Status:','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','⚠️\x20KLYME\x20reference\x20','PAID','Failed\x20to\x20parse\x20JSON\x20response:','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','created','prototype','Error\x20message:','\x20API\x20error:\x20','cancelled','statusText','Failed\x20to\x20verify\x20KLYME\x20','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','1293663zVQepW','resolve','../../config/database','FAILED','entries','payment_method','getOwnPropertyDescriptor','https://tesoft.uk/gateway/klyme/','../loggerService','HTTP\x20','log','create','\x20API','payment','canceled','__esModule','Unknown\x20error','465096URTjSw','HTTP\x20error!\x20status:\x20','get','pending','timeout','logWhiteDomainError','text','padStart','createPaymentLink','toUpperCase','1461712FxSNwI','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','\x20SUCCESS\x20(Legacy\x20Format)\x20===','parse','/verify/','251570PsBwys','===\x20PARSED\x20KLYME\x20','currency','rejected','(8digits-8digits\x20format)','Invalid\x20response\x20from\x20KLYME\x20','stringify','Request\x20Body:','Parsed\x20Result:','\x20payment\x20verification\x20error:','/create','Business\x20Error:\x20','loggerService','writable','now',',\x20body:\x20','getOwnPropertyNames','\x20API:\x20','POST','findFirst','\x20SUCCESS\x20(New\x20Format)\x20===','success','then','Raw\x20Response\x20Body:','2770924ZmsgRv','Failed\x20to\x20create\x20KLYME\x20'];a41_0x4dbf=function(){return _0x4273be;};return a41_0x4dbf();}