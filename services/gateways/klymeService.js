'use strict';const a45_0x42770c=a45_0x3b6b;(function(_0x4e80aa,_0x46768a){const _0xde19fa=a45_0x3b6b,_0x1cb848=_0x4e80aa();while(!![]){try{const _0x44ef86=-parseInt(_0xde19fa(0x219))/0x1+parseInt(_0xde19fa(0x249))/0x2+parseInt(_0xde19fa(0x21c))/0x3+parseInt(_0xde19fa(0x233))/0x4+-parseInt(_0xde19fa(0x271))/0x5+-parseInt(_0xde19fa(0x1fe))/0x6*(parseInt(_0xde19fa(0x22f))/0x7)+-parseInt(_0xde19fa(0x1df))/0x8*(-parseInt(_0xde19fa(0x23f))/0x9);if(_0x44ef86===_0x46768a)break;else _0x1cb848['push'](_0x1cb848['shift']());}catch(_0x123557){_0x1cb848['push'](_0x1cb848['shift']());}}}(a45_0x34da,0xa55ec));function a45_0x34da(){const _0xd6f761=['status','HTTP\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','HTTP\x20error!\x20status:\x20','===\x20PARSED\x20KLYME\x20','__setModuleDefault','prototype','active','\x20SUCCESS\x20(Legacy\x20Format)\x20===','13643wBmvQK','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','logWhiteDomainResponse','\x20API\x20error:\x20','3493196VhVjBb','\x20SERVICE\x20ERROR\x20===','Status\x20Text:','toUpperCase','now','Request\x20Body:','call','üí≥\x20KLYME\x20','rejected','TesSoft\x20Payment\x20System/1.0','length','KLYME\x20','523377RDjuKi','\x20validated)','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','text','then','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','logWhiteDomainError','create','loggerService','__esModule','809648MyhrrH','in_progress','reference','PAID','createPaymentLink','uuid','application/json','payment_method','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','\x20(8digits-8digits\x20format\x20for\x20','error','Error\x20stack:','\x20payment\x20verification\x20error:','log','stringify','Business\x20Error:\x20','Failed\x20to\x20verify\x20KLYME\x20','completed','toString','Reference\x20Used:','paid','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','KlymeService','Geo\x20Parameter:','cancelled','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Parsed\x20Result:','authUrl','Redirect\x20URL:','processing','Response\x20Body:','random','POST','Auth\x20URL:','../../config/database','logWhiteDomainRequest','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','GBP','\x20API\x20BUSINESS\x20ERROR\x20===','Region\x20(geo):','5034035HCJYFP','default','88GHqUca','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','\x20SUCCESS\x20(New\x20Format)\x20===','headers','===\x20KLYME\x20','entries','https://tesoft.uk/gateway/pending.php?id=','/verify/','Failed\x20to\x20create\x20KLYME\x20','message','getOwnPropertyDescriptor','get','defineProperty','Status\x20Code:','Unknown\x20error\x20from\x20KLYME\x20','EXPIRED','(8digits-8digits\x20format)','findFirst','__importStar','toLowerCase','URL:','Failed\x20to\x20parse\x20JSON\x20response:','\x20payment\x20link:\x20','payment','klyme_','statusCode','Invalid\x20response\x20from\x20KLYME\x20','Response\x20Time:','generateUniqueReference','verifyPayment','order_id','138uPPFrn','getOwnPropertyNames','created',',\x20body:\x20','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','payment_id','Unknown\x20error','/create','Response\x20data:','statusText','Reference:','Unsupported\x20KLYME\x20region:\x20','Reference\x20Used\x20as\x20ID:','JSON\x20Parse\x20Error:\x20','region','currency','redirect_url','Status:','validateCurrencyForRegion','writable','configurable','../loggerService','apiUrl','expired','Error\x20details:','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','resolve','939411LneNMn','UUID:','processWebhook','2251785makwva','EUR','\x20RESPONSE\x20===','fromEntries','parse','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','(validated\x20for\x20','FAILED','Currency:','floor'];a45_0x34da=function(){return _0xd6f761;};return a45_0x34da();}function a45_0x3b6b(_0x58dd9a,_0x28442b){const _0x34da73=a45_0x34da();return a45_0x3b6b=function(_0x3b6b8b,_0x7604cc){_0x3b6b8b=_0x3b6b8b-0x1df;let _0x4e2603=_0x34da73[_0x3b6b8b];return _0x4e2603;},a45_0x3b6b(_0x58dd9a,_0x28442b);}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x3c756d,_0x30776b,_0x5e68d0,_0x51620a){const _0x29667b=a45_0x3b6b;if(_0x51620a===undefined)_0x51620a=_0x5e68d0;var _0x1d5cb0=Object[_0x29667b(0x1e9)](_0x30776b,_0x5e68d0);(!_0x1d5cb0||(_0x29667b(0x1ea)in _0x1d5cb0?!_0x30776b[_0x29667b(0x248)]:_0x1d5cb0[_0x29667b(0x211)]||_0x1d5cb0[_0x29667b(0x212)]))&&(_0x1d5cb0={'enumerable':!![],'get':function(){return _0x30776b[_0x5e68d0];}}),Object[_0x29667b(0x1eb)](_0x3c756d,_0x51620a,_0x1d5cb0);}:function(_0x2874f4,_0x4cee68,_0x16581b,_0x54a963){if(_0x54a963===undefined)_0x54a963=_0x16581b;_0x2874f4[_0x54a963]=_0x4cee68[_0x16581b];}),__setModuleDefault=this&&this[a45_0x42770c(0x22b)]||(Object[a45_0x42770c(0x246)]?function(_0x40fd5c,_0xf37d61){Object['defineProperty'](_0x40fd5c,'default',{'enumerable':!![],'value':_0xf37d61});}:function(_0x517f48,_0x8d7e90){_0x517f48['default']=_0x8d7e90;}),__importStar=this&&this[a45_0x42770c(0x1f1)]||(function(){var _0x2d2128=function(_0x4158d1){const _0xe69adb=a45_0x3b6b;return _0x2d2128=Object[_0xe69adb(0x1ff)]||function(_0x4524ea){const _0x470883=_0xe69adb;var _0x4bc6cb=[];for(var _0x9fb808 in _0x4524ea)if(Object[_0x470883(0x22c)]['hasOwnProperty'][_0x470883(0x239)](_0x4524ea,_0x9fb808))_0x4bc6cb[_0x4bc6cb[_0x470883(0x23d)]]=_0x9fb808;return _0x4bc6cb;},_0x2d2128(_0x4158d1);};return function(_0xe2aeb){const _0x38f7a5=a45_0x3b6b;if(_0xe2aeb&&_0xe2aeb[_0x38f7a5(0x248)])return _0xe2aeb;var _0x196ec0={};if(_0xe2aeb!=null){for(var _0x585bf0=_0x2d2128(_0xe2aeb),_0x3d2b7a=0x0;_0x3d2b7a<_0x585bf0[_0x38f7a5(0x23d)];_0x3d2b7a++)if(_0x585bf0[_0x3d2b7a]!==_0x38f7a5(0x272))__createBinding(_0x196ec0,_0xe2aeb,_0x585bf0[_0x3d2b7a]);}return __setModuleDefault(_0x196ec0,_0xe2aeb),_0x196ec0;};}());Object['defineProperty'](exports,a45_0x42770c(0x248),{'value':!![]}),exports[a45_0x42770c(0x25f)]=void 0x0;const loggerService_1=require(a45_0x42770c(0x213));class KlymeService{constructor(){const _0xd2d6ae=a45_0x42770c;this[_0xd2d6ae(0x214)]='https://tesoft.uk/gateway/klyme/',console[_0xd2d6ae(0x256)](_0xd2d6ae(0x1e0));}[a45_0x42770c(0x210)](_0x58547f,_0x2b3f7b){const _0x3967f6=a45_0x42770c,_0x4ed6b5=_0x58547f['toUpperCase']();switch(_0x2b3f7b){case'EU':if(_0x4ed6b5!==_0x3967f6(0x21d))throw new Error(_0x3967f6(0x228)+_0x4ed6b5);break;case'GB':if(_0x4ed6b5!==_0x3967f6(0x26e))throw new Error(_0x3967f6(0x217)+_0x4ed6b5);break;case'DE':if(_0x4ed6b5!==_0x3967f6(0x21d))throw new Error(_0x3967f6(0x262)+_0x4ed6b5);break;default:throw new Error(_0x3967f6(0x209)+_0x2b3f7b);}}async[a45_0x42770c(0x1fb)](){const _0x23c60b=a45_0x42770c,_0x127156=(await Promise[_0x23c60b(0x218)]()[_0x23c60b(0x243)](()=>__importStar(require(_0x23c60b(0x26b)))))['default'];let _0x287620,_0x21b3fe=0x0;const _0x446b9f=0xa;do{const _0x5679ef=()=>{const _0x1267c2=_0x23c60b;return Math[_0x1267c2(0x225)](Math[_0x1267c2(0x268)]()*0x5f5e100)[_0x1267c2(0x25b)]()['padStart'](0x8,'0');};_0x287620=_0x5679ef()+'-'+_0x5679ef();const _0xf8aa7c=await _0x127156[_0x23c60b(0x1f6)][_0x23c60b(0x1f0)]({'where':{'gatewayOrderId':_0x287620}});if(!_0xf8aa7c)break;_0x21b3fe++,console[_0x23c60b(0x256)]('‚ö†Ô∏è\x20KLYME\x20reference\x20'+_0x287620+'\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20'+_0x21b3fe+')');}while(_0x21b3fe<_0x446b9f);if(_0x21b3fe>=_0x446b9f)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x287620;}async[a45_0x42770c(0x24d)](_0x3cd30e){const _0x548b34=a45_0x42770c,{orderId:_0x4c1f60,amount:_0x170e15,currency:_0x490d1e,region:_0x5bfee8}=_0x3cd30e;if(_0x5bfee8!=='EU'&&_0x5bfee8!=='GB'&&_0x5bfee8!=='DE')throw new Error(_0x548b34(0x230)+_0x5bfee8);this['validateCurrencyForRegion'](_0x490d1e,_0x5bfee8);const _0x26fbc7=_0x490d1e[_0x548b34(0x236)]();console[_0x548b34(0x256)](_0x548b34(0x23a)+_0x5bfee8+'\x20currency\x20validation\x20passed:\x20'+_0x26fbc7);const _0x27bfe6=await this[_0x548b34(0x1fb)]();console[_0x548b34(0x256)](_0x548b34(0x202)+_0x27bfe6+_0x548b34(0x252)+_0x5bfee8+')');const _0x563b25=_0x548b34(0x1e5)+_0x4c1f60,_0xb7a8d1={'amount':_0x170e15,'currency':_0x26fbc7,'redirectUrl':_0x563b25,'reference':_0x27bfe6,'geo':_0x5bfee8},_0x593ea4=Date[_0x548b34(0x237)]();try{console['log'](_0x548b34(0x1e3)+_0x5bfee8+_0x548b34(0x241)),console['log'](_0x548b34(0x1f3),this[_0x548b34(0x214)]),console[_0x548b34(0x256)](_0x548b34(0x238),JSON[_0x548b34(0x257)](_0xb7a8d1,null,0x2)),console[_0x548b34(0x256)](_0x548b34(0x270),_0x5bfee8),console[_0x548b34(0x256)](_0x548b34(0x224),_0x26fbc7,_0x548b34(0x222)+_0x5bfee8+')'),console[_0x548b34(0x256)](_0x548b34(0x208),_0x27bfe6,'(8digits-8digits\x20format)'),console['log']('Redirect\x20URL:',_0x563b25),loggerService_1[_0x548b34(0x247)][_0x548b34(0x26c)](_0x548b34(0x1f7)+_0x5bfee8[_0x548b34(0x1f2)](),_0x548b34(0x205),_0x548b34(0x269),_0xb7a8d1);const _0x305310=await fetch(this['apiUrl'],{'method':_0x548b34(0x269),'headers':{'Content-Type':_0x548b34(0x24f),'Accept':_0x548b34(0x24f),'User-Agent':_0x548b34(0x23c)},'body':JSON[_0x548b34(0x257)](_0xb7a8d1)}),_0x4bc0e1=Date[_0x548b34(0x237)]()-_0x593ea4;console['log']('===\x20KLYME\x20'+_0x5bfee8+_0x548b34(0x26d)),console['log'](_0x548b34(0x20f),_0x305310[_0x548b34(0x226)]),console['log'](_0x548b34(0x235),_0x305310[_0x548b34(0x207)]),console[_0x548b34(0x256)]('Headers:',Object[_0x548b34(0x21f)](_0x305310[_0x548b34(0x1e2)][_0x548b34(0x1e4)]())),console[_0x548b34(0x256)](_0x548b34(0x1fa),_0x4bc0e1+'ms');const _0x133d83=await _0x305310['text']();console['log']('Raw\x20Response\x20Body:',_0x133d83);if(!_0x305310['ok']){console[_0x548b34(0x253)]('===\x20KLYME\x20'+_0x5bfee8+'\x20API\x20ERROR\x20==='),console['error']('HTTP\x20Status:',_0x305310['status']),console[_0x548b34(0x253)](_0x548b34(0x267),_0x133d83),loggerService_1[_0x548b34(0x247)]['logWhiteDomainResponse']('klyme_'+_0x5bfee8[_0x548b34(0x1f2)](),_0x548b34(0x205),_0x305310[_0x548b34(0x226)],_0x133d83,_0x4bc0e1),loggerService_1[_0x548b34(0x247)]['logWhiteDomainError'](_0x548b34(0x1f7)+_0x5bfee8[_0x548b34(0x1f2)](),_0x548b34(0x205),_0x548b34(0x227)+_0x305310['status']+':\x20'+_0x133d83);throw new Error('HTTP\x20error!\x20status:\x20'+_0x305310[_0x548b34(0x226)]+_0x548b34(0x201)+_0x133d83);}let _0x5aecec;try{_0x5aecec=JSON[_0x548b34(0x220)](_0x133d83);}catch(_0x563607){console[_0x548b34(0x253)](_0x548b34(0x1f4),_0x563607),loggerService_1[_0x548b34(0x247)]['logWhiteDomainError'](_0x548b34(0x1f7)+_0x5bfee8[_0x548b34(0x1f2)](),_0x548b34(0x205),_0x548b34(0x20b)+_0x563607);throw new Error(_0x548b34(0x244)+_0x5bfee8+'\x20API:\x20'+_0x133d83);}console[_0x548b34(0x256)](_0x548b34(0x22a)+_0x5bfee8+_0x548b34(0x21e)),console[_0x548b34(0x256)](_0x548b34(0x263),JSON[_0x548b34(0x257)](_0x5aecec,null,0x2)),loggerService_1[_0x548b34(0x247)][_0x548b34(0x231)]('klyme_'+_0x5bfee8[_0x548b34(0x1f2)](),_0x548b34(0x205),_0x305310[_0x548b34(0x226)],_0x5aecec,_0x4bc0e1);if(_0x5aecec[_0x548b34(0x253)]||_0x5aecec['statusCode']){const _0x450359=_0x5aecec[_0x548b34(0x1e8)]||_0x5aecec[_0x548b34(0x253)]||_0x548b34(0x1ed)+_0x5bfee8+'\x20API';console[_0x548b34(0x253)](_0x548b34(0x1e3)+_0x5bfee8+_0x548b34(0x26f)),console[_0x548b34(0x253)]('Error\x20Message:',_0x450359),console[_0x548b34(0x253)](_0x548b34(0x1ec),_0x5aecec[_0x548b34(0x1f8)]),loggerService_1[_0x548b34(0x247)][_0x548b34(0x245)]('klyme_'+_0x5bfee8[_0x548b34(0x1f2)](),_0x548b34(0x205),_0x548b34(0x258)+_0x450359);throw new Error('KLYME\x20'+_0x5bfee8+'\x20API\x20error:\x20'+_0x450359);}let _0x3fb375,_0x5eb324;if(_0x5aecec[_0x548b34(0x24e)]&&_0x5aecec[_0x548b34(0x20e)])_0x3fb375=_0x5aecec[_0x548b34(0x24e)],_0x5eb324=_0x5aecec['redirect_url'],console[_0x548b34(0x256)](_0x548b34(0x1e3)+_0x5bfee8+_0x548b34(0x1e1)),console['log'](_0x548b34(0x21a),_0x5aecec[_0x548b34(0x24e)]),console[_0x548b34(0x256)](_0x548b34(0x265),_0x5aecec['redirect_url']);else{if(_0x5aecec[_0x548b34(0x264)])_0x3fb375=_0x27bfe6,_0x5eb324=_0x5aecec[_0x548b34(0x264)],console[_0x548b34(0x256)](_0x548b34(0x1e3)+_0x5bfee8+_0x548b34(0x22e)),console[_0x548b34(0x256)](_0x548b34(0x26a),_0x5aecec['authUrl']),console[_0x548b34(0x256)](_0x548b34(0x20a),_0x27bfe6);else{console[_0x548b34(0x253)](_0x548b34(0x1e3)+_0x5bfee8+_0x548b34(0x251)),console['error'](_0x548b34(0x221)),console['error'](_0x548b34(0x206),_0x5aecec),loggerService_1[_0x548b34(0x247)]['logWhiteDomainError'](_0x548b34(0x1f7)+_0x5bfee8[_0x548b34(0x1f2)](),_0x548b34(0x205),_0x548b34(0x25e));throw new Error(_0x548b34(0x1f9)+_0x5bfee8+'\x20API:\x20missing\x20payment\x20data');}}return console[_0x548b34(0x256)]('Currency\x20Used:',_0x26fbc7,'('+_0x5bfee8+_0x548b34(0x240)),console[_0x548b34(0x256)](_0x548b34(0x25c),_0x27bfe6,_0x548b34(0x1ef)),console[_0x548b34(0x256)](_0x548b34(0x260),_0x5bfee8),{'gateway_payment_id':_0x3fb375,'payment_url':_0x5eb324};}catch(_0x4dc687){console[_0x548b34(0x253)]('===\x20KLYME\x20'+_0x5bfee8+_0x548b34(0x234)),console[_0x548b34(0x253)](_0x548b34(0x216),_0x4dc687),loggerService_1['loggerService']['logWhiteDomainError'](_0x548b34(0x1f7)+_0x5bfee8[_0x548b34(0x1f2)](),_0x548b34(0x205),_0x4dc687);if(_0x4dc687 instanceof Error){console[_0x548b34(0x253)]('Error\x20message:',_0x4dc687['message']),console[_0x548b34(0x253)](_0x548b34(0x254),_0x4dc687['stack']);throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0x5bfee8+_0x548b34(0x1f5)+_0x4dc687[_0x548b34(0x1e8)]);}throw new Error(_0x548b34(0x1e7)+_0x5bfee8+'\x20payment\x20link:\x20Unknown\x20error');}}async[a45_0x42770c(0x1fc)](_0x4984b0,_0x2513f2){const _0x405118=a45_0x42770c,_0x6689ff=Date['now']();try{const _0x1eaa17={'gatewayPaymentId':_0x4984b0,'geo':_0x2513f2};loggerService_1[_0x405118(0x247)][_0x405118(0x26c)](_0x405118(0x1f7)+_0x2513f2['toLowerCase'](),_0x405118(0x1e6)+_0x4984b0,'POST',_0x1eaa17);const _0x50b911=await fetch(this[_0x405118(0x214)],{'method':_0x405118(0x269),'headers':{'Content-Type':_0x405118(0x24f),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x405118(0x257)](_0x1eaa17)}),_0x41da88=Date[_0x405118(0x237)]()-_0x6689ff;if(!_0x50b911['ok']){const _0x21a6d5=await _0x50b911[_0x405118(0x242)]();loggerService_1[_0x405118(0x247)]['logWhiteDomainResponse'](_0x405118(0x1f7)+_0x2513f2['toLowerCase'](),'/verify/'+_0x4984b0,_0x50b911[_0x405118(0x226)],_0x21a6d5,_0x41da88);throw new Error(_0x405118(0x229)+_0x50b911[_0x405118(0x226)]);}const _0x539f41=await _0x50b911['json']();loggerService_1[_0x405118(0x247)][_0x405118(0x231)](_0x405118(0x1f7)+_0x2513f2['toLowerCase'](),_0x405118(0x1e6)+_0x4984b0,_0x50b911[_0x405118(0x226)],_0x539f41,_0x41da88);if(_0x539f41['error']||_0x539f41[_0x405118(0x1f8)]){loggerService_1[_0x405118(0x247)][_0x405118(0x245)]('klyme_'+_0x2513f2['toLowerCase'](),_0x405118(0x1e6)+_0x4984b0,_0x405118(0x23e)+_0x2513f2+_0x405118(0x232)+(_0x539f41[_0x405118(0x1e8)]||_0x539f41[_0x405118(0x253)]||_0x405118(0x204)));throw new Error(_0x405118(0x23e)+_0x2513f2+_0x405118(0x232)+(_0x539f41[_0x405118(0x1e8)]||_0x539f41['error']||_0x405118(0x204)));}let _0xa7e026='PENDING';return{'status':_0xa7e026};}catch(_0x67ad18){console[_0x405118(0x253)](_0x405118(0x23e)+_0x2513f2+_0x405118(0x255),_0x67ad18),loggerService_1['loggerService'][_0x405118(0x245)](_0x405118(0x1f7)+_0x2513f2[_0x405118(0x1f2)](),_0x405118(0x1e6)+_0x4984b0,_0x67ad18);throw new Error(_0x405118(0x259)+_0x2513f2+'\x20payment:\x20'+(_0x67ad18 instanceof Error?_0x67ad18[_0x405118(0x1e8)]:_0x405118(0x204)));}}async[a45_0x42770c(0x21b)](_0x20cbc7){const _0x3874a2=a45_0x42770c;console[_0x3874a2(0x256)]('Processing\x20KLYME\x20webhook:',_0x20cbc7);let _0x32871c='PENDING';switch(_0x20cbc7['status']?.[_0x3874a2(0x1f2)]()){case _0x3874a2(0x25d):case _0x3874a2(0x25a):case'confirmed':case'success':case'successful':_0x32871c=_0x3874a2(0x24c);break;case _0x3874a2(0x261):case'canceled':case'failed':case _0x3874a2(0x253):case _0x3874a2(0x23b):_0x32871c=_0x3874a2(0x223);break;case _0x3874a2(0x215):case'timeout':_0x32871c=_0x3874a2(0x1ee);break;case'pending':case _0x3874a2(0x200):case _0x3874a2(0x22d):case _0x3874a2(0x266):case _0x3874a2(0x24a):default:_0x32871c='PENDING';break;}return{'paymentId':_0x20cbc7[_0x3874a2(0x24b)]||_0x20cbc7[_0x3874a2(0x1fd)]||_0x20cbc7[_0x3874a2(0x203)],'status':_0x32871c,'amount':_0x20cbc7['amount'],'currency':_0x20cbc7[_0x3874a2(0x20d)],'region':_0x20cbc7[_0x3874a2(0x20c)],'additionalInfo':{'payment_method':_0x20cbc7[_0x3874a2(0x250)],'transaction_id':_0x20cbc7['transaction_id']}};}}exports[a45_0x42770c(0x25f)]=KlymeService;