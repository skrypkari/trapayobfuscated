'use strict';function a44_0x344f(){const _0x4fda73=['\x20API:\x20missing\x20payment\x20data','PENDING','uuid','Failed\x20to\x20verify\x20KLYME\x20','Reference\x20Used\x20as\x20ID:','logWhiteDomainResponse','EUR','\x20API','authUrl','length','===\x20KLYME\x20','stringify','redirect_url','\x20API\x20error:\x20','Status:','resolve','message','(validated\x20for\x20','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','HTTP\x20error!\x20status:\x20','payment_id','in_progress','processWebhook','configurable','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','statusText','payment','toLowerCase','Currency:','call','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','KlymeService','__importStar','__esModule','Raw\x20Response\x20Body:','hasOwnProperty','Status\x20Code:','toUpperCase','Invalid\x20response\x20from\x20KLYME\x20','then','Error\x20message:','error','prototype','Business\x20Error:\x20','generateUniqueReference','failed','Redirect\x20URL:','Response\x20Time:','Status\x20Text:','8804cgdFPT','canceled','defineProperty','entries','Region\x20(geo):','240710WSabdr','\x20SUCCESS\x20(Legacy\x20Format)\x20===','\x20SERVICE\x20ERROR\x20===','statusCode','GBP','apiUrl','HTTP\x20Status:','211VAgxrc','JSON\x20Parse\x20Error:\x20','log','__createBinding','408569ahHTKE','/verify/','completed','\x20payment:\x20','Failed\x20to\x20parse\x20JSON\x20response:','‚ö†Ô∏è\x20KLYME\x20reference\x20','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','Headers:','https://tesoft.uk/gateway/klyme/','1884240LkiopW','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','logWhiteDomainRequest','__setModuleDefault','default','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','status','application/json','UUID:','verifyPayment','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','text','createPaymentLink','Response\x20data:','create','Response\x20Body:','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','\x20API\x20BUSINESS\x20ERROR\x20===','success','findFirst','Reference\x20Used:','Request\x20Body:','Error\x20details:','logWhiteDomainError','https://tesoft.uk/gateway/pending.php?id=','Unsupported\x20KLYME\x20region:\x20','validateCurrencyForRegion','parse','\x20RESPONSE\x20===','processing','timeout','region','\x20API\x20ERROR\x20===','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','getOwnPropertyDescriptor',',\x20body:\x20','amount','writable','created','URL:','rejected','4686592AsGUJP','get','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','reference','now','2389815zYYBlu','paid','Auth\x20URL:','(8digits-8digits\x20format)','Geo\x20Parameter:','headers','/create','\x20API:\x20','../loggerService','../../config/database','POST','\x20currency\x20validation\x20passed:\x20','Error\x20Message:','klyme_','Parsed\x20Result:','30PQFeWS','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','\x20(8digits-8digits\x20format\x20for\x20','Currency\x20Used:','successful','192UwYdsF','stack','EXPIRED','KLYME\x20','currency','TesSoft\x20Payment\x20System/1.0','\x20payment\x20verification\x20error:','fromEntries','619665KTsAXH','loggerService'];a44_0x344f=function(){return _0x4fda73;};return a44_0x344f();}const a44_0x339ffb=a44_0x5065;(function(_0x814d58,_0x4777cd){const _0x5b3840=a44_0x5065,_0xfddc7f=_0x814d58();while(!![]){try{const _0x8157a8=-parseInt(_0x5b3840(0x127))/0x1*(parseInt(_0x5b3840(0x11b))/0x2)+parseInt(_0x5b3840(0x134))/0x3+-parseInt(_0x5b3840(0xc7))/0x4+-parseInt(_0x5b3840(0xe8))/0x5*(-parseInt(_0x5b3840(0xdb))/0x6)+parseInt(_0x5b3840(0x12b))/0x7*(parseInt(_0x5b3840(0xe0))/0x8)+parseInt(_0x5b3840(0xcc))/0x9+-parseInt(_0x5b3840(0x120))/0xa;if(_0x8157a8===_0x4777cd)break;else _0xfddc7f['push'](_0xfddc7f['shift']());}catch(_0x2f8fb7){_0xfddc7f['push'](_0xfddc7f['shift']());}}}(a44_0x344f,0xc0c2b));function a44_0x5065(_0x4cece2,_0x169ce6){const _0x344f7d=a44_0x344f();return a44_0x5065=function(_0x5065c8,_0x2c6b87){_0x5065c8=_0x5065c8-0xc5;let _0x125fb4=_0x344f7d[_0x5065c8];return _0x125fb4;},a44_0x5065(_0x4cece2,_0x169ce6);}var __createBinding=this&&this[a44_0x339ffb(0x12a)]||(Object[a44_0x339ffb(0x142)]?function(_0x5cbc78,_0x4365cd,_0x36b6f7,_0x4febd2){const _0x3451b3=a44_0x339ffb;if(_0x4febd2===undefined)_0x4febd2=_0x36b6f7;var _0x6ba93d=Object[_0x3451b3(0x156)](_0x4365cd,_0x36b6f7);(!_0x6ba93d||(_0x3451b3(0xc8)in _0x6ba93d?!_0x4365cd['__esModule']:_0x6ba93d[_0x3451b3(0x159)]||_0x6ba93d[_0x3451b3(0x101)]))&&(_0x6ba93d={'enumerable':!![],'get':function(){return _0x4365cd[_0x36b6f7];}}),Object[_0x3451b3(0x11d)](_0x5cbc78,_0x4febd2,_0x6ba93d);}:function(_0x4405a6,_0x3a24f4,_0x92176b,_0x16c6d3){if(_0x16c6d3===undefined)_0x16c6d3=_0x92176b;_0x4405a6[_0x16c6d3]=_0x3a24f4[_0x92176b];}),__setModuleDefault=this&&this[a44_0x339ffb(0x137)]||(Object[a44_0x339ffb(0x142)]?function(_0x29eac1,_0x5296db){const _0x50fae6=a44_0x339ffb;Object[_0x50fae6(0x11d)](_0x29eac1,_0x50fae6(0x138),{'enumerable':!![],'value':_0x5296db});}:function(_0x2baee9,_0x1d6ec2){const _0x4c44fc=a44_0x339ffb;_0x2baee9[_0x4c44fc(0x138)]=_0x1d6ec2;}),__importStar=this&&this[a44_0x339ffb(0x10a)]||(function(){var _0x4c8c42=function(_0x40a8c1){return _0x4c8c42=Object['getOwnPropertyNames']||function(_0x437555){const _0x2e116d=a44_0x5065;var _0x33611d=[];for(var _0x3846fe in _0x437555)if(Object[_0x2e116d(0x114)][_0x2e116d(0x10d)][_0x2e116d(0x107)](_0x437555,_0x3846fe))_0x33611d[_0x33611d[_0x2e116d(0xf3)]]=_0x3846fe;return _0x33611d;},_0x4c8c42(_0x40a8c1);};return function(_0x46e8ae){const _0x308dfd=a44_0x5065;if(_0x46e8ae&&_0x46e8ae[_0x308dfd(0x10b)])return _0x46e8ae;var _0x3d8a51={};if(_0x46e8ae!=null){for(var _0x1fff76=_0x4c8c42(_0x46e8ae),_0x5e1936=0x0;_0x5e1936<_0x1fff76[_0x308dfd(0xf3)];_0x5e1936++)if(_0x1fff76[_0x5e1936]!=='default')__createBinding(_0x3d8a51,_0x46e8ae,_0x1fff76[_0x5e1936]);}return __setModuleDefault(_0x3d8a51,_0x46e8ae),_0x3d8a51;};}());Object[a44_0x339ffb(0x11d)](exports,'__esModule',{'value':!![]}),exports[a44_0x339ffb(0x109)]=void 0x0;const loggerService_1=require(a44_0x339ffb(0xd4));class KlymeService{constructor(){const _0x3a670d=a44_0x339ffb;this['apiUrl']=_0x3a670d(0x133),console[_0x3a670d(0x129)](_0x3a670d(0x108));}[a44_0x339ffb(0x14e)](_0x29b098,_0x48f2de){const _0x24ed13=a44_0x339ffb,_0x30f61c=_0x29b098[_0x24ed13(0x10f)]();switch(_0x48f2de){case'EU':if(_0x30f61c!==_0x24ed13(0xf0))throw new Error(_0x24ed13(0x155)+_0x30f61c);break;case'GB':if(_0x30f61c!==_0x24ed13(0x124))throw new Error(_0x24ed13(0xc9)+_0x30f61c);break;case'DE':if(_0x30f61c!==_0x24ed13(0xf0))throw new Error('KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0x30f61c);break;default:throw new Error(_0x24ed13(0x14d)+_0x48f2de);}}async[a44_0x339ffb(0x116)](){const _0x302b27=a44_0x339ffb,_0x2b622a=(await Promise[_0x302b27(0xf9)]()[_0x302b27(0x111)](()=>__importStar(require(_0x302b27(0xd5)))))[_0x302b27(0x138)];let _0xd5b235,_0x894aaa=0x0;const _0x1914cc=0xa;do{const _0xcbe314=()=>{return Math['floor'](Math['random']()*0x5f5e100)['toString']()['padStart'](0x8,'0');};_0xd5b235=_0xcbe314()+'-'+_0xcbe314();const _0x1a67ca=await _0x2b622a[_0x302b27(0x104)][_0x302b27(0x147)]({'where':{'gatewayOrderId':_0xd5b235}});if(!_0x1a67ca)break;_0x894aaa++,console[_0x302b27(0x129)](_0x302b27(0x130)+_0xd5b235+_0x302b27(0x139)+_0x894aaa+')');}while(_0x894aaa<_0x1914cc);if(_0x894aaa>=_0x1914cc)throw new Error(_0x302b27(0x144));return _0xd5b235;}async[a44_0x339ffb(0x140)](_0x4e7e1e){const _0x610945=a44_0x339ffb,{orderId:_0x2a07a0,amount:_0x18bfba,currency:_0x2edbbe,region:_0x5a4c6f}=_0x4e7e1e;if(_0x5a4c6f!=='EU'&&_0x5a4c6f!=='GB'&&_0x5a4c6f!=='DE')throw new Error(_0x610945(0x135)+_0x5a4c6f);this[_0x610945(0x14e)](_0x2edbbe,_0x5a4c6f);const _0xfcd706=_0x2edbbe['toUpperCase']();console[_0x610945(0x129)]('üí≥\x20KLYME\x20'+_0x5a4c6f+_0x610945(0xd7)+_0xfcd706);const _0x2afc57=await this[_0x610945(0x116)]();console[_0x610945(0x129)](_0x610945(0x13e)+_0x2afc57+_0x610945(0xdd)+_0x5a4c6f+')');const _0x16483f=_0x610945(0x14c)+_0x2a07a0,_0x5cf1d7={'amount':_0x18bfba,'currency':_0xfcd706,'redirectUrl':_0x16483f,'reference':_0x2afc57,'geo':_0x5a4c6f},_0x1a4769=Date['now']();try{console[_0x610945(0x129)](_0x610945(0xf4)+_0x5a4c6f+'\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20==='),console[_0x610945(0x129)](_0x610945(0xc5),this[_0x610945(0x125)]),console[_0x610945(0x129)](_0x610945(0x149),JSON[_0x610945(0xf5)](_0x5cf1d7,null,0x2)),console[_0x610945(0x129)](_0x610945(0x11f),_0x5a4c6f),console[_0x610945(0x129)](_0x610945(0x106),_0xfcd706,_0x610945(0xfb)+_0x5a4c6f+')'),console[_0x610945(0x129)]('Reference:',_0x2afc57,_0x610945(0xcf)),console[_0x610945(0x129)](_0x610945(0x118),_0x16483f),loggerService_1[_0x610945(0xe9)][_0x610945(0x136)](_0x610945(0xd9)+_0x5a4c6f[_0x610945(0x105)](),_0x610945(0xd2),_0x610945(0xd6),_0x5cf1d7);const _0x4b17fb=await fetch(this[_0x610945(0x125)],{'method':'POST','headers':{'Content-Type':_0x610945(0x13b),'Accept':_0x610945(0x13b),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x610945(0xf5)](_0x5cf1d7)}),_0x463ffe=Date[_0x610945(0xcb)]()-_0x1a4769;console[_0x610945(0x129)](_0x610945(0xf4)+_0x5a4c6f+_0x610945(0xdc)),console[_0x610945(0x129)](_0x610945(0xf8),_0x4b17fb[_0x610945(0x13a)]),console['log'](_0x610945(0x11a),_0x4b17fb[_0x610945(0x103)]),console[_0x610945(0x129)](_0x610945(0x132),Object[_0x610945(0xe7)](_0x4b17fb[_0x610945(0xd1)][_0x610945(0x11e)]())),console[_0x610945(0x129)](_0x610945(0x119),_0x463ffe+'ms');const _0x25e5b8=await _0x4b17fb['text']();console['log'](_0x610945(0x10c),_0x25e5b8);if(!_0x4b17fb['ok']){console[_0x610945(0x113)]('===\x20KLYME\x20'+_0x5a4c6f+_0x610945(0x154)),console[_0x610945(0x113)](_0x610945(0x126),_0x4b17fb[_0x610945(0x13a)]),console['error'](_0x610945(0x143),_0x25e5b8),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x610945(0xd9)+_0x5a4c6f['toLowerCase'](),_0x610945(0xd2),_0x4b17fb[_0x610945(0x13a)],_0x25e5b8,_0x463ffe),loggerService_1[_0x610945(0xe9)][_0x610945(0x14b)](_0x610945(0xd9)+_0x5a4c6f['toLowerCase'](),'/create','HTTP\x20'+_0x4b17fb['status']+':\x20'+_0x25e5b8);throw new Error(_0x610945(0xfd)+_0x4b17fb['status']+_0x610945(0x157)+_0x25e5b8);}let _0x22472c;try{_0x22472c=JSON[_0x610945(0x14f)](_0x25e5b8);}catch(_0x589c05){console['error'](_0x610945(0x12f),_0x589c05),loggerService_1[_0x610945(0xe9)][_0x610945(0x14b)](_0x610945(0xd9)+_0x5a4c6f[_0x610945(0x105)](),'/create',_0x610945(0x128)+_0x589c05);throw new Error(_0x610945(0x131)+_0x5a4c6f+_0x610945(0xd3)+_0x25e5b8);}console[_0x610945(0x129)]('===\x20PARSED\x20KLYME\x20'+_0x5a4c6f+_0x610945(0x150)),console[_0x610945(0x129)](_0x610945(0xda),JSON['stringify'](_0x22472c,null,0x2)),loggerService_1[_0x610945(0xe9)][_0x610945(0xef)](_0x610945(0xd9)+_0x5a4c6f[_0x610945(0x105)](),_0x610945(0xd2),_0x4b17fb[_0x610945(0x13a)],_0x22472c,_0x463ffe);if(_0x22472c['error']||_0x22472c[_0x610945(0x123)]){const _0x3c1aee=_0x22472c['message']||_0x22472c['error']||'Unknown\x20error\x20from\x20KLYME\x20'+_0x5a4c6f+_0x610945(0xf1);console[_0x610945(0x113)](_0x610945(0xf4)+_0x5a4c6f+_0x610945(0x145)),console[_0x610945(0x113)](_0x610945(0xd8),_0x3c1aee),console[_0x610945(0x113)](_0x610945(0x10e),_0x22472c['statusCode']),loggerService_1[_0x610945(0xe9)][_0x610945(0x14b)](_0x610945(0xd9)+_0x5a4c6f['toLowerCase'](),_0x610945(0xd2),_0x610945(0x115)+_0x3c1aee);throw new Error(_0x610945(0xe3)+_0x5a4c6f+_0x610945(0xf7)+_0x3c1aee);}let _0x35870c,_0x409e88;if(_0x22472c[_0x610945(0xec)]&&_0x22472c[_0x610945(0xf6)])_0x35870c=_0x22472c[_0x610945(0xec)],_0x409e88=_0x22472c[_0x610945(0xf6)],console['log']('===\x20KLYME\x20'+_0x5a4c6f+'\x20SUCCESS\x20(New\x20Format)\x20==='),console[_0x610945(0x129)](_0x610945(0x13c),_0x22472c[_0x610945(0xec)]),console[_0x610945(0x129)](_0x610945(0x118),_0x22472c[_0x610945(0xf6)]);else{if(_0x22472c['authUrl'])_0x35870c=_0x2afc57,_0x409e88=_0x22472c['authUrl'],console[_0x610945(0x129)](_0x610945(0xf4)+_0x5a4c6f+_0x610945(0x121)),console[_0x610945(0x129)](_0x610945(0xce),_0x22472c[_0x610945(0xf2)]),console[_0x610945(0x129)](_0x610945(0xee),_0x2afc57);else{console[_0x610945(0x113)]('===\x20KLYME\x20'+_0x5a4c6f+'\x20API\x20INCOMPLETE\x20RESPONSE\x20==='),console[_0x610945(0x113)](_0x610945(0xfc)),console[_0x610945(0x113)](_0x610945(0x141),_0x22472c),loggerService_1[_0x610945(0xe9)]['logWhiteDomainError'](_0x610945(0xd9)+_0x5a4c6f['toLowerCase'](),_0x610945(0xd2),_0x610945(0x102));throw new Error(_0x610945(0x110)+_0x5a4c6f+_0x610945(0xea));}}return console['log'](_0x610945(0xde),_0xfcd706,'('+_0x5a4c6f+'\x20validated)'),console[_0x610945(0x129)](_0x610945(0x148),_0x2afc57,_0x610945(0xcf)),console[_0x610945(0x129)](_0x610945(0xd0),_0x5a4c6f),{'gateway_payment_id':_0x35870c,'payment_url':_0x409e88};}catch(_0x20a6a9){console[_0x610945(0x113)](_0x610945(0xf4)+_0x5a4c6f+_0x610945(0x122)),console[_0x610945(0x113)](_0x610945(0x14a),_0x20a6a9),loggerService_1[_0x610945(0xe9)][_0x610945(0x14b)](_0x610945(0xd9)+_0x5a4c6f[_0x610945(0x105)](),_0x610945(0xd2),_0x20a6a9);if(_0x20a6a9 instanceof Error){console[_0x610945(0x113)](_0x610945(0x112),_0x20a6a9['message']),console['error']('Error\x20stack:',_0x20a6a9[_0x610945(0xe1)]);throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0x5a4c6f+'\x20payment\x20link:\x20'+_0x20a6a9[_0x610945(0xfa)]);}throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0x5a4c6f+'\x20payment\x20link:\x20Unknown\x20error');}}async[a44_0x339ffb(0x13d)](_0xf1d662,_0xccaa4b){const _0x4a7070=a44_0x339ffb,_0x222eff=Date[_0x4a7070(0xcb)]();try{const _0x302109={'gatewayPaymentId':_0xf1d662,'geo':_0xccaa4b};loggerService_1[_0x4a7070(0xe9)][_0x4a7070(0x136)]('klyme_'+_0xccaa4b[_0x4a7070(0x105)](),_0x4a7070(0x12c)+_0xf1d662,_0x4a7070(0xd6),_0x302109);const _0x115d7f=await fetch(this[_0x4a7070(0x125)],{'method':_0x4a7070(0xd6),'headers':{'Content-Type':_0x4a7070(0x13b),'User-Agent':_0x4a7070(0xe5)},'body':JSON[_0x4a7070(0xf5)](_0x302109)}),_0x4474c2=Date[_0x4a7070(0xcb)]()-_0x222eff;if(!_0x115d7f['ok']){const _0x366ca9=await _0x115d7f[_0x4a7070(0x13f)]();loggerService_1['loggerService']['logWhiteDomainResponse'](_0x4a7070(0xd9)+_0xccaa4b[_0x4a7070(0x105)](),_0x4a7070(0x12c)+_0xf1d662,_0x115d7f[_0x4a7070(0x13a)],_0x366ca9,_0x4474c2);throw new Error(_0x4a7070(0xfd)+_0x115d7f[_0x4a7070(0x13a)]);}const _0x239844=await _0x115d7f['json']();loggerService_1[_0x4a7070(0xe9)][_0x4a7070(0xef)](_0x4a7070(0xd9)+_0xccaa4b[_0x4a7070(0x105)](),_0x4a7070(0x12c)+_0xf1d662,_0x115d7f[_0x4a7070(0x13a)],_0x239844,_0x4474c2);if(_0x239844[_0x4a7070(0x113)]||_0x239844[_0x4a7070(0x123)]){loggerService_1['loggerService'][_0x4a7070(0x14b)]('klyme_'+_0xccaa4b[_0x4a7070(0x105)](),_0x4a7070(0x12c)+_0xf1d662,_0x4a7070(0xe3)+_0xccaa4b+_0x4a7070(0xf7)+(_0x239844['message']||_0x239844[_0x4a7070(0x113)]||'Unknown\x20error'));throw new Error(_0x4a7070(0xe3)+_0xccaa4b+'\x20API\x20error:\x20'+(_0x239844[_0x4a7070(0xfa)]||_0x239844[_0x4a7070(0x113)]||'Unknown\x20error'));}let _0x1300dc=_0x4a7070(0xeb);return{'status':_0x1300dc};}catch(_0x2b59b1){console[_0x4a7070(0x113)](_0x4a7070(0xe3)+_0xccaa4b+_0x4a7070(0xe6),_0x2b59b1),loggerService_1[_0x4a7070(0xe9)]['logWhiteDomainError'](_0x4a7070(0xd9)+_0xccaa4b['toLowerCase'](),_0x4a7070(0x12c)+_0xf1d662,_0x2b59b1);throw new Error(_0x4a7070(0xed)+_0xccaa4b+_0x4a7070(0x12e)+(_0x2b59b1 instanceof Error?_0x2b59b1['message']:'Unknown\x20error'));}}async[a44_0x339ffb(0x100)](_0x5b24da){const _0x481c8c=a44_0x339ffb;console[_0x481c8c(0x129)]('Processing\x20KLYME\x20webhook:',_0x5b24da);let _0x8e4ab9=_0x481c8c(0xeb);switch(_0x5b24da[_0x481c8c(0x13a)]?.[_0x481c8c(0x105)]()){case _0x481c8c(0xcd):case _0x481c8c(0x12d):case'confirmed':case _0x481c8c(0x146):case _0x481c8c(0xdf):_0x8e4ab9='PAID';break;case'cancelled':case _0x481c8c(0x11c):case _0x481c8c(0x117):case _0x481c8c(0x113):case _0x481c8c(0xc6):_0x8e4ab9='FAILED';break;case'expired':case _0x481c8c(0x152):_0x8e4ab9=_0x481c8c(0xe2);break;case'pending':case _0x481c8c(0x15a):case'active':case _0x481c8c(0x151):case _0x481c8c(0xff):default:_0x8e4ab9=_0x481c8c(0xeb);break;}return{'paymentId':_0x5b24da[_0x481c8c(0xca)]||_0x5b24da['order_id']||_0x5b24da[_0x481c8c(0xfe)],'status':_0x8e4ab9,'amount':_0x5b24da[_0x481c8c(0x158)],'currency':_0x5b24da[_0x481c8c(0xe4)],'region':_0x5b24da[_0x481c8c(0x153)],'additionalInfo':{'payment_method':_0x5b24da['payment_method'],'transaction_id':_0x5b24da['transaction_id']}};}}exports[a44_0x339ffb(0x109)]=KlymeService;