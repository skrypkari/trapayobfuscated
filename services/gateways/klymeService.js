'use strict';const a42_0x1b668a=a42_0x42fa;(function(_0x15db46,_0x396fa4){const _0x1612f8=a42_0x42fa,_0x407dad=_0x15db46();while(!![]){try{const _0x4e4b3e=-parseInt(_0x1612f8(0x230))/0x1+parseInt(_0x1612f8(0x264))/0x2+parseInt(_0x1612f8(0x209))/0x3*(-parseInt(_0x1612f8(0x228))/0x4)+-parseInt(_0x1612f8(0x214))/0x5+parseInt(_0x1612f8(0x1f7))/0x6+parseInt(_0x1612f8(0x240))/0x7+-parseInt(_0x1612f8(0x246))/0x8*(parseInt(_0x1612f8(0x1f4))/0x9);if(_0x4e4b3e===_0x396fa4)break;else _0x407dad['push'](_0x407dad['shift']());}catch(_0x6a1af2){_0x407dad['push'](_0x407dad['shift']());}}}(a42_0x2b74,0x51359));var __createBinding=this&&this[a42_0x1b668a(0x1e5)]||(Object[a42_0x1b668a(0x25f)]?function(_0x325df1,_0x1e539d,_0x48c25c,_0x57be8b){const _0xd5fdee=a42_0x1b668a;if(_0x57be8b===undefined)_0x57be8b=_0x48c25c;var _0x394fd6=Object[_0xd5fdee(0x1ff)](_0x1e539d,_0x48c25c);(!_0x394fd6||(_0xd5fdee(0x242)in _0x394fd6?!_0x1e539d[_0xd5fdee(0x252)]:_0x394fd6[_0xd5fdee(0x1da)]||_0x394fd6['configurable']))&&(_0x394fd6={'enumerable':!![],'get':function(){return _0x1e539d[_0x48c25c];}}),Object[_0xd5fdee(0x1f8)](_0x325df1,_0x57be8b,_0x394fd6);}:function(_0x1d209c,_0xcb6b6f,_0x314766,_0x1fe936){if(_0x1fe936===undefined)_0x1fe936=_0x314766;_0x1d209c[_0x1fe936]=_0xcb6b6f[_0x314766];}),__setModuleDefault=this&&this[a42_0x1b668a(0x237)]||(Object[a42_0x1b668a(0x25f)]?function(_0x25471e,_0x5195c4){const _0x45fbb5=a42_0x1b668a;Object[_0x45fbb5(0x1f8)](_0x25471e,'default',{'enumerable':!![],'value':_0x5195c4});}:function(_0x341d71,_0xb9807a){_0x341d71['default']=_0xb9807a;}),__importStar=this&&this[a42_0x1b668a(0x1e6)]||(function(){var _0x697d38=function(_0x412db9){const _0x2eff6f=a42_0x42fa;return _0x697d38=Object[_0x2eff6f(0x235)]||function(_0x34fe9f){const _0x3063f8=_0x2eff6f;var _0x4bfd0b=[];for(var _0x296fed in _0x34fe9f)if(Object[_0x3063f8(0x223)][_0x3063f8(0x1dd)][_0x3063f8(0x24a)](_0x34fe9f,_0x296fed))_0x4bfd0b[_0x4bfd0b[_0x3063f8(0x20e)]]=_0x296fed;return _0x4bfd0b;},_0x697d38(_0x412db9);};return function(_0x395840){const _0x54b49e=a42_0x42fa;if(_0x395840&&_0x395840[_0x54b49e(0x252)])return _0x395840;var _0x3f4553={};if(_0x395840!=null){for(var _0x307360=_0x697d38(_0x395840),_0xa0e4f8=0x0;_0xa0e4f8<_0x307360[_0x54b49e(0x20e)];_0xa0e4f8++)if(_0x307360[_0xa0e4f8]!==_0x54b49e(0x23e))__createBinding(_0x3f4553,_0x395840,_0x307360[_0xa0e4f8]);}return __setModuleDefault(_0x3f4553,_0x395840),_0x3f4553;};}());function a42_0x42fa(_0x39bde4,_0x5e84cd){const _0x2b7410=a42_0x2b74();return a42_0x42fa=function(_0x42fa83,_0x39320b){_0x42fa83=_0x42fa83-0x1d4;let _0x29b4f7=_0x2b7410[_0x42fa83];return _0x29b4f7;},a42_0x42fa(_0x39bde4,_0x5e84cd);}Object[a42_0x1b668a(0x1f8)](exports,a42_0x1b668a(0x252),{'value':!![]}),exports[a42_0x1b668a(0x23b)]=void 0x0;const loggerService_1=require('../loggerService');function a42_0x2b74(){const _0x1a5a69=['canceled','Auth\x20URL:','__esModule','Reference:','timeout','statusText','toLowerCase','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','amount','https://tesoft.uk/gateway/pending.php?id=','Reference\x20Used:','active','created','region','\x20RESPONSE\x20===','create','Unknown\x20error','⚠️\x20KLYME\x20reference\x20','../../config/database','stringify','893214UhhagJ','pending','confirmed','Failed\x20to\x20verify\x20KLYME\x20','\x20SUCCESS\x20(Legacy\x20Format)\x20===','loggerService','Headers:','writable','https://tesoft.uk/gateway/klyme/','verifyPayment','hasOwnProperty','\x20API\x20BUSINESS\x20ERROR\x20===','entries','Error\x20message:','\x20API:\x20missing\x20payment\x20data','Unknown\x20error\x20from\x20KLYME\x20','Currency\x20Used:','\x20payment:\x20','__createBinding','__importStar','Failed\x20to\x20create\x20KLYME\x20','apiUrl','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','authUrl','(8digits-8digits\x20format)','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','logWhiteDomainRequest','Raw\x20Response\x20Body:','TesSoft\x20Payment\x20System/1.0','log','EUR','===\x20KLYME\x20','Response\x20Body:','9Gvoeug','createPaymentLink','KLYME\x20','2666520GggAOK','defineProperty','statusCode','processWebhook','fromEntries','now','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','message','getOwnPropertyDescriptor','Request\x20Body:','\x20API\x20ERROR\x20===','PENDING','toUpperCase','EXPIRED','uuid','💳\x20KLYME\x20','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','PAID','197820tKrJzJ','headers','\x20validated)','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','transaction_id','length','/create','\x20API\x20error:\x20','generateUniqueReference',',\x20body:\x20','\x20(8digits-8digits\x20format\x20for\x20','1112460flPvzd','redirect_url','URL:','\x20payment\x20link:\x20','order_id','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','currency','\x20API','Error\x20details:','/verify/','status','Error\x20stack:','payment','logWhiteDomainError','Unsupported\x20KLYME\x20region:\x20','prototype','application/json','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','Region\x20(geo):','🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20','16UqCDcB','processing','findFirst','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','Processing\x20KLYME\x20webhook:','UUID:','HTTP\x20error!\x20status:\x20','logWhiteDomainResponse','542677YYUBXa','Invalid\x20response\x20from\x20KLYME\x20','POST','Error\x20Message:','GBP','getOwnPropertyNames','\x20API:\x20','__setModuleDefault','expired','failed','text','KlymeService','klyme_','Response\x20Time:','default','success','4037138onivsc','in_progress','get','error','\x20payment\x20verification\x20error:','successful','849592TgTYWu','Response\x20data:','Status\x20Text:','Currency:','call','\x20SERVICE\x20ERROR\x20===','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','Redirect\x20URL:','\x20SUCCESS\x20(New\x20Format)\x20===','===\x20PARSED\x20KLYME\x20'];a42_0x2b74=function(){return _0x1a5a69;};return a42_0x2b74();}class KlymeService{constructor(){const _0x3438a2=a42_0x1b668a;this[_0x3438a2(0x1e8)]=_0x3438a2(0x1db),console[_0x3438a2(0x1f0)](_0x3438a2(0x1fd));}['validateCurrencyForRegion'](_0x5c56d4,_0x3acd5b){const _0x657a0e=a42_0x1b668a,_0x52d2cd=_0x5c56d4[_0x657a0e(0x203)]();switch(_0x3acd5b){case'EU':if(_0x52d2cd!==_0x657a0e(0x1f1))throw new Error(_0x657a0e(0x225)+_0x52d2cd);break;case'GB':if(_0x52d2cd!==_0x657a0e(0x234))throw new Error(_0x657a0e(0x1e9)+_0x52d2cd);break;case'DE':if(_0x52d2cd!==_0x657a0e(0x1f1))throw new Error(_0x657a0e(0x257)+_0x52d2cd);break;default:throw new Error(_0x657a0e(0x222)+_0x3acd5b);}}async[a42_0x1b668a(0x211)](){const _0x338475=a42_0x1b668a,_0x22dc4e=(await Promise['resolve']()['then'](()=>__importStar(require(_0x338475(0x262)))))[_0x338475(0x23e)];let _0x3d17a0,_0x3511b4=0x0;const _0x370388=0xa;do{const _0x355d7b=()=>{return Math['floor'](Math['random']()*0x5f5e100)['toString']()['padStart'](0x8,'0');};_0x3d17a0=_0x355d7b()+'-'+_0x355d7b();const _0x399b89=await _0x22dc4e[_0x338475(0x220)][_0x338475(0x22a)]({'where':{'gatewayOrderId':_0x3d17a0}});if(!_0x399b89)break;_0x3511b4++,console['log'](_0x338475(0x261)+_0x3d17a0+_0x338475(0x20c)+_0x3511b4+')');}while(_0x3511b4<_0x370388);if(_0x3511b4>=_0x370388)throw new Error(_0x338475(0x24c));return _0x3d17a0;}async[a42_0x1b668a(0x1f5)](_0x352fca){const _0x579716=a42_0x1b668a,{orderId:_0x2bf43d,amount:_0x48c6b5,currency:_0x412a7b,region:_0x36f462}=_0x352fca;if(_0x36f462!=='EU'&&_0x36f462!=='GB'&&_0x36f462!=='DE')throw new Error(_0x579716(0x207)+_0x36f462);this['validateCurrencyForRegion'](_0x412a7b,_0x36f462);const _0x29d9c3=_0x412a7b['toUpperCase']();console[_0x579716(0x1f0)](_0x579716(0x206)+_0x36f462+'\x20currency\x20validation\x20passed:\x20'+_0x29d9c3);const _0x3d7b0b=await this[_0x579716(0x211)]();console[_0x579716(0x1f0)](_0x579716(0x227)+_0x3d7b0b+_0x579716(0x213)+_0x36f462+')');const _0x5075c5=_0x579716(0x259)+_0x2bf43d,_0x24314f={'amount':_0x48c6b5,'currency':_0x29d9c3,'redirectUrl':_0x5075c5,'reference':_0x3d7b0b,'geo':_0x36f462},_0xad0de4=Date[_0x579716(0x1fc)]();try{console['log'](_0x579716(0x1f2)+_0x36f462+_0x579716(0x22b)),console[_0x579716(0x1f0)](_0x579716(0x216),this[_0x579716(0x1e8)]),console['log'](_0x579716(0x200),JSON[_0x579716(0x263)](_0x24314f,null,0x2)),console[_0x579716(0x1f0)](_0x579716(0x226),_0x36f462),console[_0x579716(0x1f0)](_0x579716(0x249),_0x29d9c3,'(validated\x20for\x20'+_0x36f462+')'),console[_0x579716(0x1f0)](_0x579716(0x253),_0x3d7b0b,_0x579716(0x1eb)),console['log'](_0x579716(0x24d),_0x5075c5),loggerService_1[_0x579716(0x1d8)][_0x579716(0x1ed)](_0x579716(0x23c)+_0x36f462['toLowerCase'](),_0x579716(0x20f),_0x579716(0x232),_0x24314f);const _0x395502=await fetch(this['apiUrl'],{'method':'POST','headers':{'Content-Type':_0x579716(0x224),'Accept':_0x579716(0x224),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x579716(0x263)](_0x24314f)}),_0x1bf1fd=Date[_0x579716(0x1fc)]()-_0xad0de4;console[_0x579716(0x1f0)](_0x579716(0x1f2)+_0x36f462+_0x579716(0x1ec)),console[_0x579716(0x1f0)]('Status:',_0x395502['status']),console[_0x579716(0x1f0)](_0x579716(0x248),_0x395502[_0x579716(0x255)]),console[_0x579716(0x1f0)](_0x579716(0x1d9),Object[_0x579716(0x1fb)](_0x395502[_0x579716(0x20a)][_0x579716(0x1df)]())),console[_0x579716(0x1f0)](_0x579716(0x23d),_0x1bf1fd+'ms');const _0x12cbbd=await _0x395502[_0x579716(0x23a)]();console['log'](_0x579716(0x1ee),_0x12cbbd);if(!_0x395502['ok']){console['error'](_0x579716(0x1f2)+_0x36f462+_0x579716(0x201)),console[_0x579716(0x243)]('HTTP\x20Status:',_0x395502[_0x579716(0x21e)]),console[_0x579716(0x243)](_0x579716(0x1f3),_0x12cbbd),loggerService_1[_0x579716(0x1d8)][_0x579716(0x22f)](_0x579716(0x23c)+_0x36f462[_0x579716(0x256)](),_0x579716(0x20f),_0x395502[_0x579716(0x21e)],_0x12cbbd,_0x1bf1fd),loggerService_1[_0x579716(0x1d8)][_0x579716(0x221)](_0x579716(0x23c)+_0x36f462[_0x579716(0x256)](),'/create','HTTP\x20'+_0x395502[_0x579716(0x21e)]+':\x20'+_0x12cbbd);throw new Error(_0x579716(0x22e)+_0x395502[_0x579716(0x21e)]+_0x579716(0x212)+_0x12cbbd);}let _0x107490;try{_0x107490=JSON['parse'](_0x12cbbd);}catch(_0x296940){console[_0x579716(0x243)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x296940),loggerService_1[_0x579716(0x1d8)]['logWhiteDomainError'](_0x579716(0x23c)+_0x36f462[_0x579716(0x256)](),_0x579716(0x20f),'JSON\x20Parse\x20Error:\x20'+_0x296940);throw new Error('Invalid\x20JSON\x20response\x20from\x20KLYME\x20'+_0x36f462+_0x579716(0x236)+_0x12cbbd);}console[_0x579716(0x1f0)](_0x579716(0x24f)+_0x36f462+_0x579716(0x25e)),console[_0x579716(0x1f0)]('Parsed\x20Result:',JSON[_0x579716(0x263)](_0x107490,null,0x2)),loggerService_1[_0x579716(0x1d8)]['logWhiteDomainResponse'](_0x579716(0x23c)+_0x36f462[_0x579716(0x256)](),'/create',_0x395502[_0x579716(0x21e)],_0x107490,_0x1bf1fd);if(_0x107490[_0x579716(0x243)]||_0x107490[_0x579716(0x1f9)]){const _0x44fcd3=_0x107490['message']||_0x107490[_0x579716(0x243)]||_0x579716(0x1e2)+_0x36f462+_0x579716(0x21b);console[_0x579716(0x243)](_0x579716(0x1f2)+_0x36f462+_0x579716(0x1de)),console[_0x579716(0x243)](_0x579716(0x233),_0x44fcd3),console[_0x579716(0x243)]('Status\x20Code:',_0x107490[_0x579716(0x1f9)]),loggerService_1['loggerService'][_0x579716(0x221)](_0x579716(0x23c)+_0x36f462[_0x579716(0x256)](),_0x579716(0x20f),'Business\x20Error:\x20'+_0x44fcd3);throw new Error(_0x579716(0x1f6)+_0x36f462+_0x579716(0x210)+_0x44fcd3);}let _0x565e02,_0x36542f;if(_0x107490[_0x579716(0x205)]&&_0x107490['redirect_url'])_0x565e02=_0x107490[_0x579716(0x205)],_0x36542f=_0x107490['redirect_url'],console[_0x579716(0x1f0)](_0x579716(0x1f2)+_0x36f462+_0x579716(0x24e)),console['log'](_0x579716(0x22d),_0x107490['uuid']),console[_0x579716(0x1f0)]('Redirect\x20URL:',_0x107490[_0x579716(0x215)]);else{if(_0x107490[_0x579716(0x1ea)])_0x565e02=_0x3d7b0b,_0x36542f=_0x107490['authUrl'],console[_0x579716(0x1f0)](_0x579716(0x1f2)+_0x36f462+_0x579716(0x1d7)),console[_0x579716(0x1f0)](_0x579716(0x251),_0x107490[_0x579716(0x1ea)]),console[_0x579716(0x1f0)]('Reference\x20Used\x20as\x20ID:',_0x3d7b0b);else{console['error']('===\x20KLYME\x20'+_0x36f462+_0x579716(0x219)),console[_0x579716(0x243)]('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console[_0x579716(0x243)](_0x579716(0x247),_0x107490),loggerService_1[_0x579716(0x1d8)][_0x579716(0x221)]('klyme_'+_0x36f462[_0x579716(0x256)](),_0x579716(0x20f),'Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl');throw new Error(_0x579716(0x231)+_0x36f462+_0x579716(0x1e1));}}return console[_0x579716(0x1f0)](_0x579716(0x1e3),_0x29d9c3,'('+_0x36f462+_0x579716(0x20b)),console[_0x579716(0x1f0)](_0x579716(0x25a),_0x3d7b0b,_0x579716(0x1eb)),console[_0x579716(0x1f0)]('Geo\x20Parameter:',_0x36f462),{'gateway_payment_id':_0x565e02,'payment_url':_0x36542f};}catch(_0x2a28fa){console[_0x579716(0x243)](_0x579716(0x1f2)+_0x36f462+_0x579716(0x24b)),console[_0x579716(0x243)](_0x579716(0x21c),_0x2a28fa),loggerService_1[_0x579716(0x1d8)][_0x579716(0x221)]('klyme_'+_0x36f462[_0x579716(0x256)](),_0x579716(0x20f),_0x2a28fa);if(_0x2a28fa instanceof Error){console[_0x579716(0x243)](_0x579716(0x1e0),_0x2a28fa[_0x579716(0x1fe)]),console[_0x579716(0x243)](_0x579716(0x21f),_0x2a28fa['stack']);throw new Error(_0x579716(0x1e7)+_0x36f462+_0x579716(0x217)+_0x2a28fa[_0x579716(0x1fe)]);}throw new Error('Failed\x20to\x20create\x20KLYME\x20'+_0x36f462+'\x20payment\x20link:\x20Unknown\x20error');}}async[a42_0x1b668a(0x1dc)](_0x3136f3,_0x548910){const _0x9622ce=a42_0x1b668a,_0x1852c6=Date['now']();try{const _0x2c7860={'gatewayPaymentId':_0x3136f3,'geo':_0x548910};loggerService_1[_0x9622ce(0x1d8)]['logWhiteDomainRequest']('klyme_'+_0x548910[_0x9622ce(0x256)](),_0x9622ce(0x21d)+_0x3136f3,_0x9622ce(0x232),_0x2c7860);const _0x6e4bd7=await fetch(this['apiUrl'],{'method':_0x9622ce(0x232),'headers':{'Content-Type':_0x9622ce(0x224),'User-Agent':_0x9622ce(0x1ef)},'body':JSON[_0x9622ce(0x263)](_0x2c7860)}),_0x584821=Date[_0x9622ce(0x1fc)]()-_0x1852c6;if(!_0x6e4bd7['ok']){const _0x846a27=await _0x6e4bd7[_0x9622ce(0x23a)]();loggerService_1[_0x9622ce(0x1d8)]['logWhiteDomainResponse'](_0x9622ce(0x23c)+_0x548910[_0x9622ce(0x256)](),_0x9622ce(0x21d)+_0x3136f3,_0x6e4bd7[_0x9622ce(0x21e)],_0x846a27,_0x584821);throw new Error(_0x9622ce(0x22e)+_0x6e4bd7['status']);}const _0x42a659=await _0x6e4bd7['json']();loggerService_1[_0x9622ce(0x1d8)][_0x9622ce(0x22f)](_0x9622ce(0x23c)+_0x548910[_0x9622ce(0x256)](),_0x9622ce(0x21d)+_0x3136f3,_0x6e4bd7[_0x9622ce(0x21e)],_0x42a659,_0x584821);if(_0x42a659[_0x9622ce(0x243)]||_0x42a659[_0x9622ce(0x1f9)]){loggerService_1[_0x9622ce(0x1d8)]['logWhiteDomainError']('klyme_'+_0x548910['toLowerCase'](),_0x9622ce(0x21d)+_0x3136f3,_0x9622ce(0x1f6)+_0x548910+'\x20API\x20error:\x20'+(_0x42a659[_0x9622ce(0x1fe)]||_0x42a659[_0x9622ce(0x243)]||'Unknown\x20error'));throw new Error(_0x9622ce(0x1f6)+_0x548910+_0x9622ce(0x210)+(_0x42a659['message']||_0x42a659[_0x9622ce(0x243)]||'Unknown\x20error'));}let _0x4c51e4='PENDING';return{'status':_0x4c51e4};}catch(_0x515ea3){console[_0x9622ce(0x243)]('KLYME\x20'+_0x548910+_0x9622ce(0x244),_0x515ea3),loggerService_1[_0x9622ce(0x1d8)][_0x9622ce(0x221)](_0x9622ce(0x23c)+_0x548910[_0x9622ce(0x256)](),_0x9622ce(0x21d)+_0x3136f3,_0x515ea3);throw new Error(_0x9622ce(0x1d6)+_0x548910+_0x9622ce(0x1e4)+(_0x515ea3 instanceof Error?_0x515ea3['message']:_0x9622ce(0x260)));}}async[a42_0x1b668a(0x1fa)](_0x3001ad){const _0x198505=a42_0x1b668a;console[_0x198505(0x1f0)](_0x198505(0x22c),_0x3001ad);let _0x132e9e='PENDING';switch(_0x3001ad[_0x198505(0x21e)]?.[_0x198505(0x256)]()){case'paid':case'completed':case _0x198505(0x1d5):case _0x198505(0x23f):case _0x198505(0x245):_0x132e9e=_0x198505(0x208);break;case'cancelled':case _0x198505(0x250):case _0x198505(0x239):case _0x198505(0x243):case'rejected':_0x132e9e='FAILED';break;case _0x198505(0x238):case _0x198505(0x254):_0x132e9e=_0x198505(0x204);break;case _0x198505(0x1d4):case _0x198505(0x25c):case _0x198505(0x25b):case _0x198505(0x229):case _0x198505(0x241):default:_0x132e9e=_0x198505(0x202);break;}return{'paymentId':_0x3001ad['reference']||_0x3001ad[_0x198505(0x218)]||_0x3001ad['payment_id'],'status':_0x132e9e,'amount':_0x3001ad[_0x198505(0x258)],'currency':_0x3001ad[_0x198505(0x21a)],'region':_0x3001ad[_0x198505(0x25d)],'additionalInfo':{'payment_method':_0x3001ad['payment_method'],'transaction_id':_0x3001ad[_0x198505(0x20d)]}};}}exports[a42_0x1b668a(0x23b)]=KlymeService;