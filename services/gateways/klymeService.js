'use strict';const a39_0xa329b2=a39_0x3c8c;(function(_0x466bc1,_0x5c74fc){const _0x57a301=a39_0x3c8c,_0x427d87=_0x466bc1();while(!![]){try{const _0x1e2eaf=-parseInt(_0x57a301(0xe7))/0x1+parseInt(_0x57a301(0xe4))/0x2+-parseInt(_0x57a301(0x10e))/0x3*(-parseInt(_0x57a301(0xce))/0x4)+-parseInt(_0x57a301(0xc2))/0x5*(-parseInt(_0x57a301(0xeb))/0x6)+parseInt(_0x57a301(0x10c))/0x7+parseInt(_0x57a301(0xb6))/0x8*(parseInt(_0x57a301(0xe3))/0x9)+parseInt(_0x57a301(0xc4))/0xa*(-parseInt(_0x57a301(0xda))/0xb);if(_0x1e2eaf===_0x5c74fc)break;else _0x427d87['push'](_0x427d87['shift']());}catch(_0x47d049){_0x427d87['push'](_0x427d87['shift']());}}}(a39_0x4ad8,0xd779e));var __createBinding=this&&this[a39_0xa329b2(0xe0)]||(Object[a39_0xa329b2(0xa2)]?function(_0x4e9cbe,_0x5f957f,_0x3486db,_0x1643a3){const _0x265498=a39_0xa329b2;if(_0x1643a3===undefined)_0x1643a3=_0x3486db;var _0x4f691e=Object[_0x265498(0xdf)](_0x5f957f,_0x3486db);(!_0x4f691e||(_0x265498(0xf0)in _0x4f691e?!_0x5f957f['__esModule']:_0x4f691e['writable']||_0x4f691e[_0x265498(0xfd)]))&&(_0x4f691e={'enumerable':!![],'get':function(){return _0x5f957f[_0x3486db];}}),Object[_0x265498(0x104)](_0x4e9cbe,_0x1643a3,_0x4f691e);}:function(_0x3a51c7,_0x435070,_0x2dd746,_0x17cc5e){if(_0x17cc5e===undefined)_0x17cc5e=_0x2dd746;_0x3a51c7[_0x17cc5e]=_0x435070[_0x2dd746];}),__setModuleDefault=this&&this[a39_0xa329b2(0x11d)]||(Object['create']?function(_0x3f6075,_0x21cabd){const _0x90d5ce=a39_0xa329b2;Object[_0x90d5ce(0x104)](_0x3f6075,_0x90d5ce(0xe9),{'enumerable':!![],'value':_0x21cabd});}:function(_0xf02312,_0x36a420){_0xf02312['default']=_0x36a420;}),__importStar=this&&this[a39_0xa329b2(0xfa)]||(function(){var _0x361d56=function(_0x3351ad){const _0x3145c5=a39_0x3c8c;return _0x361d56=Object[_0x3145c5(0x9b)]||function(_0x27ded2){const _0x3e5fbf=_0x3145c5;var _0x3af7dc=[];for(var _0x25c11e in _0x27ded2)if(Object[_0x3e5fbf(0xb1)][_0x3e5fbf(0x101)][_0x3e5fbf(0x9e)](_0x27ded2,_0x25c11e))_0x3af7dc[_0x3af7dc[_0x3e5fbf(0x9d)]]=_0x25c11e;return _0x3af7dc;},_0x361d56(_0x3351ad);};return function(_0xb0f163){const _0x1afa3a=a39_0x3c8c;if(_0xb0f163&&_0xb0f163['__esModule'])return _0xb0f163;var _0xa8cb05={};if(_0xb0f163!=null){for(var _0x2a8238=_0x361d56(_0xb0f163),_0xbd472c=0x0;_0xbd472c<_0x2a8238[_0x1afa3a(0x9d)];_0xbd472c++)if(_0x2a8238[_0xbd472c]!=='default')__createBinding(_0xa8cb05,_0xb0f163,_0x2a8238[_0xbd472c]);}return __setModuleDefault(_0xa8cb05,_0xb0f163),_0xa8cb05;};}());function a39_0x3c8c(_0x50b7ec,_0x3c5bad){const _0x4ad817=a39_0x4ad8();return a39_0x3c8c=function(_0x3c8cf3,_0x2d4159){_0x3c8cf3=_0x3c8cf3-0x8b;let _0x51687b=_0x4ad817[_0x3c8cf3];return _0x51687b;},a39_0x3c8c(_0x50b7ec,_0x3c5bad);}Object[a39_0xa329b2(0x104)](exports,'__esModule',{'value':!![]}),exports[a39_0xa329b2(0xf9)]=void 0x0;const loggerService_1=require('../loggerService');class KlymeService{constructor(){const _0x3a4516=a39_0xa329b2;this[_0x3a4516(0xc0)]=_0x3a4516(0xc3),console[_0x3a4516(0x11e)](_0x3a4516(0x100));}[a39_0xa329b2(0x98)](_0x4abf5d,_0x252274){const _0x4d5f3c=a39_0xa329b2,_0x4710b7=_0x4abf5d[_0x4d5f3c(0xcf)]();switch(_0x252274){case'EU':if(_0x4710b7!==_0x4d5f3c(0xa5))throw new Error(_0x4d5f3c(0x11b)+_0x4710b7);break;case'GB':if(_0x4710b7!==_0x4d5f3c(0x117))throw new Error(_0x4d5f3c(0x11f)+_0x4710b7);break;case'DE':if(_0x4710b7!=='EUR')throw new Error(_0x4d5f3c(0xd8)+_0x4710b7);break;default:throw new Error(_0x4d5f3c(0xb4)+_0x252274);}}async[a39_0xa329b2(0xb7)](){const _0x2b0294=a39_0xa329b2,_0xc6ee05=(await Promise[_0x2b0294(0x122)]()[_0x2b0294(0xf3)](()=>__importStar(require(_0x2b0294(0xbc)))))['default'];let _0x131607,_0x5acfd3=0x0;const _0x4d1b14=0xa;do{const _0x404357=()=>{const _0x2e8bbb=_0x2b0294;return Math[_0x2e8bbb(0xbf)](Math[_0x2e8bbb(0xdb)]()*0x5f5e100)[_0x2e8bbb(0x93)]()[_0x2e8bbb(0xed)](0x8,'0');};_0x131607=_0x404357()+'-'+_0x404357();const _0x3f5a6b=await _0xc6ee05[_0x2b0294(0xf6)][_0x2b0294(0xb9)]({'where':{'gatewayOrderId':_0x131607}});if(!_0x3f5a6b)break;_0x5acfd3++,console[_0x2b0294(0x11e)](_0x2b0294(0x10f)+_0x131607+'\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20'+_0x5acfd3+')');}while(_0x5acfd3<_0x4d1b14);if(_0x5acfd3>=_0x4d1b14)throw new Error(_0x2b0294(0x94));return _0x131607;}async['createPaymentLink'](_0x53f444){const _0x4da674=a39_0xa329b2,{orderId:_0x20961a,amount:_0xe56259,currency:_0x176bd2,region:_0x3a2989}=_0x53f444;if(_0x3a2989!=='EU'&&_0x3a2989!=='GB'&&_0x3a2989!=='DE')throw new Error(_0x4da674(0x10d)+_0x3a2989);this[_0x4da674(0x98)](_0x176bd2,_0x3a2989);const _0x30ea9a=_0x176bd2['toUpperCase']();console[_0x4da674(0x11e)](_0x4da674(0xc5)+_0x3a2989+_0x4da674(0xab)+_0x30ea9a);const _0x52c474=await this[_0x4da674(0xb7)]();console[_0x4da674(0x11e)](_0x4da674(0xb8)+_0x52c474+_0x4da674(0xc6)+_0x3a2989+')');const _0xd6174a=_0x4da674(0xd0)+_0x20961a,_0x44e942={'amount':_0xe56259,'currency':_0x30ea9a,'redirectUrl':_0xd6174a,'reference':_0x52c474,'geo':_0x3a2989},_0x5ce503=Date['now']();try{console['log'](_0x4da674(0xdd)+_0x3a2989+_0x4da674(0xb3)),console[_0x4da674(0x11e)]('URL:',this[_0x4da674(0xc0)]),console[_0x4da674(0x11e)](_0x4da674(0xec),JSON[_0x4da674(0x9a)](_0x44e942,null,0x2)),console[_0x4da674(0x11e)](_0x4da674(0x103),_0x3a2989),console['log'](_0x4da674(0x96),_0x30ea9a,'(validated\x20for\x20'+_0x3a2989+')'),console[_0x4da674(0x11e)]('Reference:',_0x52c474,'(8digits-8digits\x20format)'),console[_0x4da674(0x11e)](_0x4da674(0xa7),_0xd6174a),loggerService_1[_0x4da674(0xbb)]['logWhiteDomainRequest'](_0x4da674(0x91)+_0x3a2989[_0x4da674(0xbe)](),_0x4da674(0xc1),'POST',_0x44e942);const _0x446e40=await fetch(this[_0x4da674(0xc0)],{'method':_0x4da674(0x8f),'headers':{'Content-Type':'application/json','Accept':'application/json','User-Agent':_0x4da674(0x99)},'body':JSON[_0x4da674(0x9a)](_0x44e942)}),_0x3527b5=Date[_0x4da674(0x11a)]()-_0x5ce503;console[_0x4da674(0x11e)](_0x4da674(0xdd)+_0x3a2989+_0x4da674(0xcc)),console[_0x4da674(0x11e)](_0x4da674(0xa4),_0x446e40[_0x4da674(0x118)]),console[_0x4da674(0x11e)](_0x4da674(0x90),_0x446e40[_0x4da674(0xa3)]),console[_0x4da674(0x11e)](_0x4da674(0xe8),Object[_0x4da674(0x8d)](_0x446e40[_0x4da674(0xd3)]['entries']())),console[_0x4da674(0x11e)]('Response\x20Time:',_0x3527b5+'ms');const _0x298615=await _0x446e40[_0x4da674(0xe5)]();console[_0x4da674(0x11e)](_0x4da674(0x111),_0x298615);if(!_0x446e40['ok']){console[_0x4da674(0x119)](_0x4da674(0xdd)+_0x3a2989+_0x4da674(0x107)),console[_0x4da674(0x119)]('HTTP\x20Status:',_0x446e40['status']),console[_0x4da674(0x119)]('Response\x20Body:',_0x298615),loggerService_1[_0x4da674(0xbb)][_0x4da674(0xa6)]('klyme_'+_0x3a2989[_0x4da674(0xbe)](),_0x4da674(0xc1),_0x446e40['status'],_0x298615,_0x3527b5),loggerService_1[_0x4da674(0xbb)][_0x4da674(0xae)](_0x4da674(0x91)+_0x3a2989[_0x4da674(0xbe)](),_0x4da674(0xc1),_0x4da674(0xd1)+_0x446e40[_0x4da674(0x118)]+':\x20'+_0x298615);throw new Error(_0x4da674(0x11c)+_0x446e40[_0x4da674(0x118)]+_0x4da674(0xf1)+_0x298615);}let _0x333624;try{_0x333624=JSON['parse'](_0x298615);}catch(_0x12f718){console['error'](_0x4da674(0xfc),_0x12f718),loggerService_1[_0x4da674(0xbb)][_0x4da674(0xae)](_0x4da674(0x91)+_0x3a2989[_0x4da674(0xbe)](),_0x4da674(0xc1),_0x4da674(0xf7)+_0x12f718);throw new Error(_0x4da674(0xe2)+_0x3a2989+_0x4da674(0xd2)+_0x298615);}console['log'](_0x4da674(0x106)+_0x3a2989+_0x4da674(0xaa)),console[_0x4da674(0x11e)](_0x4da674(0xe6),JSON[_0x4da674(0x9a)](_0x333624,null,0x2)),loggerService_1['loggerService']['logWhiteDomainResponse'](_0x4da674(0x91)+_0x3a2989[_0x4da674(0xbe)](),_0x4da674(0xc1),_0x446e40[_0x4da674(0x118)],_0x333624,_0x3527b5);if(_0x333624['error']||_0x333624[_0x4da674(0xf8)]){const _0x51a936=_0x333624[_0x4da674(0x10b)]||_0x333624[_0x4da674(0x119)]||_0x4da674(0xf2)+_0x3a2989+_0x4da674(0xa9);console[_0x4da674(0x119)](_0x4da674(0xdd)+_0x3a2989+'\x20API\x20BUSINESS\x20ERROR\x20==='),console[_0x4da674(0x119)](_0x4da674(0x95),_0x51a936),console[_0x4da674(0x119)](_0x4da674(0xdc),_0x333624[_0x4da674(0xf8)]),loggerService_1[_0x4da674(0xbb)][_0x4da674(0xae)](_0x4da674(0x91)+_0x3a2989[_0x4da674(0xbe)](),_0x4da674(0xc1),_0x4da674(0xcd)+_0x51a936);throw new Error(_0x4da674(0x8c)+_0x3a2989+'\x20API\x20error:\x20'+_0x51a936);}let _0x4eb334,_0xc3b9ff;if(_0x333624[_0x4da674(0x9c)]&&_0x333624[_0x4da674(0xac)])_0x4eb334=_0x333624[_0x4da674(0x9c)],_0xc3b9ff=_0x333624[_0x4da674(0xac)],console[_0x4da674(0x11e)](_0x4da674(0xdd)+_0x3a2989+_0x4da674(0xfe)),console[_0x4da674(0x11e)](_0x4da674(0xfb),_0x333624[_0x4da674(0x9c)]),console['log']('Redirect\x20URL:',_0x333624['redirect_url']);else{if(_0x333624[_0x4da674(0xd9)])_0x4eb334=_0x52c474,_0xc3b9ff=_0x333624[_0x4da674(0xd9)],console[_0x4da674(0x11e)](_0x4da674(0xdd)+_0x3a2989+_0x4da674(0xb5)),console[_0x4da674(0x11e)](_0x4da674(0x115),_0x333624[_0x4da674(0xd9)]),console['log']('Reference\x20Used\x20as\x20ID:',_0x52c474);else{console[_0x4da674(0x119)](_0x4da674(0xdd)+_0x3a2989+_0x4da674(0x8b)),console[_0x4da674(0x119)]('Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response'),console[_0x4da674(0x119)](_0x4da674(0xc9),_0x333624),loggerService_1['loggerService']['logWhiteDomainError'](_0x4da674(0x91)+_0x3a2989[_0x4da674(0xbe)](),_0x4da674(0xc1),'Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl');throw new Error(_0x4da674(0x112)+_0x3a2989+_0x4da674(0x113));}}return console[_0x4da674(0x11e)]('Currency\x20Used:',_0x30ea9a,'('+_0x3a2989+'\x20validated)'),console['log'](_0x4da674(0xad),_0x52c474,_0x4da674(0xff)),console[_0x4da674(0x11e)](_0x4da674(0xc7),_0x3a2989),{'gateway_payment_id':_0x4eb334,'payment_url':_0xc3b9ff};}catch(_0x126368){console[_0x4da674(0x119)]('===\x20KLYME\x20'+_0x3a2989+_0x4da674(0x10a)),console[_0x4da674(0x119)](_0x4da674(0x102),_0x126368),loggerService_1[_0x4da674(0xbb)][_0x4da674(0xae)](_0x4da674(0x91)+_0x3a2989[_0x4da674(0xbe)](),_0x4da674(0xc1),_0x126368);if(_0x126368 instanceof Error){console['error'](_0x4da674(0xde),_0x126368[_0x4da674(0x10b)]),console[_0x4da674(0x119)](_0x4da674(0xd4),_0x126368[_0x4da674(0xee)]);throw new Error(_0x4da674(0x116)+_0x3a2989+'\x20payment\x20link:\x20'+_0x126368[_0x4da674(0x10b)]);}throw new Error(_0x4da674(0x116)+_0x3a2989+_0x4da674(0xe1));}}async[a39_0xa329b2(0xef)](_0xed46c9,_0x3c41d9){const _0x141c70=a39_0xa329b2,_0x86878b=Date[_0x141c70(0x11a)]();try{const _0x41b12f={'gatewayPaymentId':_0xed46c9,'geo':_0x3c41d9};loggerService_1['loggerService'][_0x141c70(0xb0)](_0x141c70(0x91)+_0x3c41d9['toLowerCase'](),'/verify/'+_0xed46c9,_0x141c70(0x8f),_0x41b12f);const _0x3672b3=await fetch(this['apiUrl'],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x41b12f)}),_0x2be346=Date[_0x141c70(0x11a)]()-_0x86878b;if(!_0x3672b3['ok']){const _0x434c2d=await _0x3672b3[_0x141c70(0xe5)]();loggerService_1[_0x141c70(0xbb)][_0x141c70(0xa6)](_0x141c70(0x91)+_0x3c41d9['toLowerCase'](),_0x141c70(0x110)+_0xed46c9,_0x3672b3[_0x141c70(0x118)],_0x434c2d,_0x2be346);throw new Error(_0x141c70(0x11c)+_0x3672b3[_0x141c70(0x118)]);}const _0x5ceaf7=await _0x3672b3[_0x141c70(0xba)]();loggerService_1['loggerService'][_0x141c70(0xa6)](_0x141c70(0x91)+_0x3c41d9['toLowerCase'](),_0x141c70(0x110)+_0xed46c9,_0x3672b3[_0x141c70(0x118)],_0x5ceaf7,_0x2be346);if(_0x5ceaf7[_0x141c70(0x119)]||_0x5ceaf7[_0x141c70(0xf8)]){loggerService_1[_0x141c70(0xbb)][_0x141c70(0xae)](_0x141c70(0x91)+_0x3c41d9[_0x141c70(0xbe)](),'/verify/'+_0xed46c9,_0x141c70(0x8c)+_0x3c41d9+_0x141c70(0x120)+(_0x5ceaf7['message']||_0x5ceaf7[_0x141c70(0x119)]||_0x141c70(0x92)));throw new Error('KLYME\x20'+_0x3c41d9+_0x141c70(0x120)+(_0x5ceaf7[_0x141c70(0x10b)]||_0x5ceaf7[_0x141c70(0x119)]||_0x141c70(0x92)));}let _0x35b16a=_0x141c70(0xd7);return{'status':_0x35b16a};}catch(_0x49d15e){console[_0x141c70(0x119)](_0x141c70(0x8c)+_0x3c41d9+_0x141c70(0x121),_0x49d15e),loggerService_1['loggerService'][_0x141c70(0xae)]('klyme_'+_0x3c41d9[_0x141c70(0xbe)](),'/verify/'+_0xed46c9,_0x49d15e);throw new Error(_0x141c70(0x114)+_0x3c41d9+'\x20payment:\x20'+(_0x49d15e instanceof Error?_0x49d15e[_0x141c70(0x10b)]:_0x141c70(0x92)));}}async[a39_0xa329b2(0x105)](_0x4e8c16){const _0x35a271=a39_0xa329b2;console[_0x35a271(0x11e)](_0x35a271(0xca),_0x4e8c16);let _0x2c257d=_0x35a271(0xd7);switch(_0x4e8c16[_0x35a271(0x118)]?.[_0x35a271(0xbe)]()){case _0x35a271(0xbd):case _0x35a271(0xf4):case'confirmed':case _0x35a271(0xea):case _0x35a271(0xd6):_0x2c257d='PAID';break;case _0x35a271(0xf5):case'canceled':case _0x35a271(0xa1):case'error':case _0x35a271(0xcb):_0x2c257d=_0x35a271(0xc8);break;case'expired':case _0x35a271(0xa8):_0x2c257d=_0x35a271(0xb2);break;case'pending':case'created':case'active':case _0x35a271(0x9f):case'in_progress':default:_0x2c257d=_0x35a271(0xd7);break;}return{'paymentId':_0x4e8c16[_0x35a271(0x109)]||_0x4e8c16[_0x35a271(0x8e)]||_0x4e8c16[_0x35a271(0xa0)],'status':_0x2c257d,'amount':_0x4e8c16[_0x35a271(0xd5)],'currency':_0x4e8c16[_0x35a271(0x108)],'region':_0x4e8c16[_0x35a271(0x97)],'additionalInfo':{'payment_method':_0x4e8c16[_0x35a271(0xaf)],'transaction_id':_0x4e8c16['transaction_id']}};}}exports[a39_0xa329b2(0xf9)]=KlymeService;function a39_0x4ad8(){const _0x9b6956=['stack','verifyPayment','get',',\x20body:\x20','Unknown\x20error\x20from\x20KLYME\x20','then','completed','cancelled','payment','JSON\x20Parse\x20Error:\x20','statusCode','KlymeService','__importStar','UUID:','Failed\x20to\x20parse\x20JSON\x20response:','configurable','\x20SUCCESS\x20(New\x20Format)\x20===','(8digits-8digits\x20format)','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','hasOwnProperty','Error\x20details:','Region\x20(geo):','defineProperty','processWebhook','===\x20PARSED\x20KLYME\x20','\x20API\x20ERROR\x20===','currency','reference','\x20SERVICE\x20ERROR\x20===','message','4829412ukxbjP','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','96XPBdIA','‚ö†Ô∏è\x20KLYME\x20reference\x20','/verify/','Raw\x20Response\x20Body:','Invalid\x20response\x20from\x20KLYME\x20','\x20API:\x20missing\x20payment\x20data','Failed\x20to\x20verify\x20KLYME\x20','Auth\x20URL:','Failed\x20to\x20create\x20KLYME\x20','GBP','status','error','now','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','HTTP\x20error!\x20status:\x20','__setModuleDefault','log','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','\x20API\x20error:\x20','\x20payment\x20verification\x20error:','resolve','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','KLYME\x20','fromEntries','order_id','POST','Status\x20Text:','klyme_','Unknown\x20error','toString','Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts','Error\x20Message:','Currency:','region','validateCurrencyForRegion','TesSoft\x20Payment\x20System/1.0','stringify','getOwnPropertyNames','uuid','length','call','processing','payment_id','failed','create','statusText','Status:','EUR','logWhiteDomainResponse','Redirect\x20URL:','timeout','\x20API','\x20RESPONSE\x20===','\x20currency\x20validation\x20passed:\x20','redirect_url','Reference\x20Used:','logWhiteDomainError','payment_method','logWhiteDomainRequest','prototype','EXPIRED','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','Unsupported\x20KLYME\x20region:\x20','\x20SUCCESS\x20(Legacy\x20Format)\x20===','16hYMbAb','generateUniqueReference','üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20','findFirst','json','loggerService','../../config/database','paid','toLowerCase','floor','apiUrl','/create','22585UJQqiZ','https://tesoft.uk/gateway/klyme/','10ndoEKk','üí≥\x20KLYME\x20','\x20(8digits-8digits\x20format\x20for\x20','Geo\x20Parameter:','FAILED','Response\x20data:','Processing\x20KLYME\x20webhook:','rejected','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','Business\x20Error:\x20','94972eDeZWU','toUpperCase','https://tesoft.uk/gateway/pending.php?id=','HTTP\x20','\x20API:\x20','headers','Error\x20stack:','amount','successful','PENDING','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','authUrl','21072777rDadCz','random','Status\x20Code:','===\x20KLYME\x20','Error\x20message:','getOwnPropertyDescriptor','__createBinding','\x20payment\x20link:\x20Unknown\x20error','Invalid\x20JSON\x20response\x20from\x20KLYME\x20','3258522mriiSV','3519578lcEgVb','text','Parsed\x20Result:','1636687dvJdGV','Headers:','default','success','666AUYHJt','Request\x20Body:','padStart'];a39_0x4ad8=function(){return _0x9b6956;};return a39_0x4ad8();}