'use strict';const a41_0x221242=a41_0xdaed;(function(_0x5ddc46,_0xf0f700){const _0x583c19=a41_0xdaed,_0x122ca9=_0x5ddc46();while(!![]){try{const _0x17bdf4=-parseInt(_0x583c19(0x66))/0x1+-parseInt(_0x583c19(0xa3))/0x2*(-parseInt(_0x583c19(0x9c))/0x3)+-parseInt(_0x583c19(0xd9))/0x4*(-parseInt(_0x583c19(0xf1))/0x5)+-parseInt(_0x583c19(0xd5))/0x6+parseInt(_0x583c19(0x9d))/0x7+-parseInt(_0x583c19(0x70))/0x8+-parseInt(_0x583c19(0x81))/0x9*(-parseInt(_0x583c19(0xc1))/0xa);if(_0x17bdf4===_0xf0f700)break;else _0x122ca9['push'](_0x122ca9['shift']());}catch(_0x338e58){_0x122ca9['push'](_0x122ca9['shift']());}}}(a41_0x2b6b,0xe26f6));var __createBinding=this&&this['__createBinding']||(Object[a41_0x221242(0xd7)]?function(_0x1d4e9c,_0x2e223a,_0x3ae74c,_0x4e0607){const _0x22f70e=a41_0x221242;if(_0x4e0607===undefined)_0x4e0607=_0x3ae74c;var _0x3217ef=Object[_0x22f70e(0xd8)](_0x2e223a,_0x3ae74c);(!_0x3217ef||(_0x22f70e(0xed)in _0x3217ef?!_0x2e223a['__esModule']:_0x3217ef[_0x22f70e(0x75)]||_0x3217ef['configurable']))&&(_0x3217ef={'enumerable':!![],'get':function(){return _0x2e223a[_0x3ae74c];}}),Object[_0x22f70e(0xde)](_0x1d4e9c,_0x4e0607,_0x3217ef);}:function(_0x4dda10,_0x4ef48b,_0x57bde5,_0x31fd53){if(_0x31fd53===undefined)_0x31fd53=_0x57bde5;_0x4dda10[_0x31fd53]=_0x4ef48b[_0x57bde5];}),__setModuleDefault=this&&this[a41_0x221242(0xd2)]||(Object['create']?function(_0x1660ab,_0x5be162){const _0x2461f2=a41_0x221242;Object[_0x2461f2(0xde)](_0x1660ab,_0x2461f2(0xf8),{'enumerable':!![],'value':_0x5be162});}:function(_0x2781ab,_0x1edee8){_0x2781ab['default']=_0x1edee8;}),__importStar=this&&this[a41_0x221242(0x85)]||(function(){var _0x1b717e=function(_0x53cb5e){return _0x1b717e=Object['getOwnPropertyNames']||function(_0x326b38){const _0x5d965b=a41_0xdaed;var _0x571c89=[];for(var _0x19f097 in _0x326b38)if(Object['prototype'][_0x5d965b(0xa0)][_0x5d965b(0xa9)](_0x326b38,_0x19f097))_0x571c89[_0x571c89[_0x5d965b(0x7a)]]=_0x19f097;return _0x571c89;},_0x1b717e(_0x53cb5e);};return function(_0x2a0757){const _0xb121fc=a41_0xdaed;if(_0x2a0757&&_0x2a0757[_0xb121fc(0x9e)])return _0x2a0757;var _0xf673d1={};if(_0x2a0757!=null){for(var _0x23281e=_0x1b717e(_0x2a0757),_0x23092d=0x0;_0x23092d<_0x23281e[_0xb121fc(0x7a)];_0x23092d++)if(_0x23281e[_0x23092d]!==_0xb121fc(0xf8))__createBinding(_0xf673d1,_0x2a0757,_0x23281e[_0x23092d]);}return __setModuleDefault(_0xf673d1,_0x2a0757),_0xf673d1;};}());Object['defineProperty'](exports,a41_0x221242(0x9e),{'value':!![]}),exports[a41_0x221242(0xae)]=void 0x0;const loggerService_1=require(a41_0x221242(0xd0));class KlymeService{constructor(){const _0x1e8516=a41_0x221242;this[_0x1e8516(0xba)]=_0x1e8516(0x99),console[_0x1e8516(0xeb)](_0x1e8516(0x71));}[a41_0x221242(0x98)](_0x38a836,_0x4b9385){const _0x20ca54=a41_0x221242,_0xd184=_0x38a836[_0x20ca54(0x6f)]();switch(_0x4b9385){case'EU':if(_0xd184!=='EUR')throw new Error('KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20'+_0xd184);break;case'GB':if(_0xd184!=='GBP')throw new Error('KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20'+_0xd184);break;case'DE':if(_0xd184!==_0x20ca54(0xec))throw new Error(_0x20ca54(0xdf)+_0xd184);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x4b9385);}}async[a41_0x221242(0xea)](){const _0x150d25=a41_0x221242,_0x3f21d8=(await Promise[_0x150d25(0xf0)]()[_0x150d25(0xc8)](()=>__importStar(require('../../config/database'))))[_0x150d25(0xf8)];let _0x1af889,_0x3d210d=0x0;const _0x54cd82=0xa;do{const _0x5039c9=()=>{const _0x5df635=_0x150d25;return Math[_0x5df635(0xb0)](Math[_0x5df635(0xad)]()*0x5f5e100)[_0x5df635(0x90)]()[_0x5df635(0x93)](0x8,'0');};_0x1af889=_0x5039c9()+'-'+_0x5039c9();const _0x234dc3=await _0x3f21d8[_0x150d25(0x72)][_0x150d25(0xbb)]({'where':{'gatewayOrderId':_0x1af889}});if(!_0x234dc3)break;_0x3d210d++,console[_0x150d25(0xeb)]('‚ö†Ô∏è\x20KLYME\x20reference\x20'+_0x1af889+_0x150d25(0x9a)+_0x3d210d+')');}while(_0x3d210d<_0x54cd82);if(_0x3d210d>=_0x54cd82)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x1af889;}async[a41_0x221242(0xbc)](_0x217e21){const _0x4d5643=a41_0x221242,{orderId:_0x1a0f26,amount:_0x13ddf6,currency:_0x15f4f2,region:_0x260254}=_0x217e21;if(_0x260254!=='EU'&&_0x260254!=='GB'&&_0x260254!=='DE')throw new Error('KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20'+_0x260254);this['validateCurrencyForRegion'](_0x15f4f2,_0x260254);const _0x163038=_0x15f4f2[_0x4d5643(0x6f)]();console['log'](_0x4d5643(0xd1)+_0x260254+_0x4d5643(0xf7)+_0x163038);const _0x3e08e7=await this[_0x4d5643(0xea)]();console[_0x4d5643(0xeb)]('üéØ\x20Generated\x20unique\x20KLYME\x20reference:\x20'+_0x3e08e7+_0x4d5643(0x82)+_0x260254+')');const _0x335ec0=_0x4d5643(0x80)+_0x1a0f26,_0x233e5b={'amount':_0x13ddf6,'currency':_0x163038,'redirectUrl':_0x335ec0,'reference':_0x3e08e7,'geo':_0x260254},_0x213d5b=Date[_0x4d5643(0xb9)]();try{console[_0x4d5643(0xeb)](_0x4d5643(0x97)+_0x260254+_0x4d5643(0xc6)),console[_0x4d5643(0xeb)]('URL:',this[_0x4d5643(0xba)]),console[_0x4d5643(0xeb)](_0x4d5643(0xdc),JSON['stringify'](_0x233e5b,null,0x2)),console[_0x4d5643(0xeb)](_0x4d5643(0x96),_0x260254),console['log'](_0x4d5643(0xb5),_0x163038,_0x4d5643(0x68)+_0x260254+')'),console[_0x4d5643(0xeb)]('Reference:',_0x3e08e7,_0x4d5643(0xa6)),console[_0x4d5643(0xeb)](_0x4d5643(0x8c),_0x335ec0),loggerService_1[_0x4d5643(0x7f)]['logWhiteDomainRequest'](_0x4d5643(0xb7)+_0x260254[_0x4d5643(0x73)](),_0x4d5643(0xbe),_0x4d5643(0xc9),_0x233e5b);const _0x49683a=await fetch(this['apiUrl'],{'method':'POST','headers':{'Content-Type':'application/json','Accept':_0x4d5643(0xf3),'User-Agent':_0x4d5643(0x83)},'body':JSON['stringify'](_0x233e5b)}),_0x5648d3=Date['now']()-_0x213d5b;console[_0x4d5643(0xeb)]('===\x20KLYME\x20'+_0x260254+_0x4d5643(0xf5)),console[_0x4d5643(0xeb)]('Status:',_0x49683a[_0x4d5643(0xcf)]),console[_0x4d5643(0xeb)](_0x4d5643(0x77),_0x49683a[_0x4d5643(0x6a)]),console[_0x4d5643(0xeb)](_0x4d5643(0x92),Object[_0x4d5643(0xb6)](_0x49683a['headers'][_0x4d5643(0xe7)]())),console[_0x4d5643(0xeb)](_0x4d5643(0x95),_0x5648d3+'ms');const _0x1ec041=await _0x49683a[_0x4d5643(0xb2)]();console[_0x4d5643(0xeb)](_0x4d5643(0x6e),_0x1ec041);if(!_0x49683a['ok']){console[_0x4d5643(0x91)](_0x4d5643(0x97)+_0x260254+_0x4d5643(0xdb)),console[_0x4d5643(0x91)]('HTTP\x20Status:',_0x49683a[_0x4d5643(0xcf)]),console['error']('Response\x20Body:',_0x1ec041),loggerService_1['loggerService'][_0x4d5643(0xce)](_0x4d5643(0xb7)+_0x260254[_0x4d5643(0x73)](),'/create',_0x49683a['status'],_0x1ec041,_0x5648d3),loggerService_1['loggerService'][_0x4d5643(0xd6)]('klyme_'+_0x260254['toLowerCase'](),'/create',_0x4d5643(0x9f)+_0x49683a[_0x4d5643(0xcf)]+':\x20'+_0x1ec041);throw new Error(_0x4d5643(0xa8)+_0x49683a[_0x4d5643(0xcf)]+_0x4d5643(0xe1)+_0x1ec041);}let _0xbb445;try{_0xbb445=JSON['parse'](_0x1ec041);}catch(_0x56b6b3){console[_0x4d5643(0x91)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x56b6b3),loggerService_1[_0x4d5643(0x7f)][_0x4d5643(0xd6)](_0x4d5643(0xb7)+_0x260254[_0x4d5643(0x73)](),_0x4d5643(0xbe),'JSON\x20Parse\x20Error:\x20'+_0x56b6b3);throw new Error(_0x4d5643(0xcb)+_0x260254+_0x4d5643(0xcc)+_0x1ec041);}console[_0x4d5643(0xeb)](_0x4d5643(0x8f)+_0x260254+_0x4d5643(0xc7)),console[_0x4d5643(0xeb)](_0x4d5643(0xbf),JSON['stringify'](_0xbb445,null,0x2)),loggerService_1[_0x4d5643(0x7f)][_0x4d5643(0xce)]('klyme_'+_0x260254[_0x4d5643(0x73)](),_0x4d5643(0xbe),_0x49683a[_0x4d5643(0xcf)],_0xbb445,_0x5648d3);if(_0xbb445[_0x4d5643(0x91)]||_0xbb445[_0x4d5643(0xe3)]){const _0x375bf2=_0xbb445[_0x4d5643(0x69)]||_0xbb445[_0x4d5643(0x91)]||_0x4d5643(0xf2)+_0x260254+_0x4d5643(0x67);console['error'](_0x4d5643(0x97)+_0x260254+_0x4d5643(0xdd)),console[_0x4d5643(0x91)](_0x4d5643(0x86),_0x375bf2),console['error'](_0x4d5643(0x8a),_0xbb445['statusCode']),loggerService_1[_0x4d5643(0x7f)][_0x4d5643(0xd6)]('klyme_'+_0x260254['toLowerCase'](),_0x4d5643(0xbe),'Business\x20Error:\x20'+_0x375bf2);throw new Error(_0x4d5643(0x79)+_0x260254+'\x20API\x20error:\x20'+_0x375bf2);}let _0xf25195,_0x5bc271;if(_0xbb445['uuid']&&_0xbb445[_0x4d5643(0x8e)])_0xf25195=_0xbb445['uuid'],_0x5bc271=_0xbb445[_0x4d5643(0x8e)],console[_0x4d5643(0xeb)](_0x4d5643(0x97)+_0x260254+'\x20SUCCESS\x20(New\x20Format)\x20==='),console[_0x4d5643(0xeb)](_0x4d5643(0xef),_0xbb445[_0x4d5643(0x94)]),console[_0x4d5643(0xeb)](_0x4d5643(0x8c),_0xbb445[_0x4d5643(0x8e)]);else{if(_0xbb445[_0x4d5643(0xe5)])_0xf25195=_0x3e08e7,_0x5bc271=_0xbb445[_0x4d5643(0xe5)],console[_0x4d5643(0xeb)](_0x4d5643(0x97)+_0x260254+_0x4d5643(0xaa)),console[_0x4d5643(0xeb)](_0x4d5643(0xc5),_0xbb445[_0x4d5643(0xe5)]),console[_0x4d5643(0xeb)](_0x4d5643(0x78),_0x3e08e7);else{console['error'](_0x4d5643(0x97)+_0x260254+_0x4d5643(0xa5)),console[_0x4d5643(0x91)](_0x4d5643(0xa2)),console['error']('Response\x20data:',_0xbb445),loggerService_1[_0x4d5643(0x7f)][_0x4d5643(0xd6)](_0x4d5643(0xb7)+_0x260254[_0x4d5643(0x73)](),_0x4d5643(0xbe),_0x4d5643(0x7c));throw new Error('Invalid\x20response\x20from\x20KLYME\x20'+_0x260254+_0x4d5643(0xe9));}}return console[_0x4d5643(0xeb)](_0x4d5643(0xca),_0x163038,'('+_0x260254+_0x4d5643(0xab)),console['log'](_0x4d5643(0xe8),_0x3e08e7,_0x4d5643(0xa6)),console[_0x4d5643(0xeb)]('Geo\x20Parameter:',_0x260254),{'gateway_payment_id':_0xf25195,'payment_url':_0x5bc271};}catch(_0x5f3716){console[_0x4d5643(0x91)](_0x4d5643(0x97)+_0x260254+_0x4d5643(0x84)),console[_0x4d5643(0x91)](_0x4d5643(0x6b),_0x5f3716),loggerService_1[_0x4d5643(0x7f)][_0x4d5643(0xd6)](_0x4d5643(0xb7)+_0x260254[_0x4d5643(0x73)](),_0x4d5643(0xbe),_0x5f3716);if(_0x5f3716 instanceof Error){console[_0x4d5643(0x91)](_0x4d5643(0xb3),_0x5f3716[_0x4d5643(0x69)]),console['error'](_0x4d5643(0x89),_0x5f3716['stack']);throw new Error(_0x4d5643(0xac)+_0x260254+_0x4d5643(0x6c)+_0x5f3716[_0x4d5643(0x69)]);}throw new Error(_0x4d5643(0xac)+_0x260254+_0x4d5643(0x6d));}}async[a41_0x221242(0xb1)](_0x79d849,_0x16a0a7){const _0xad447e=a41_0x221242,_0x3b3c34=Date[_0xad447e(0xb9)]();try{const _0x54e8cd={'gatewayPaymentId':_0x79d849,'geo':_0x16a0a7};loggerService_1[_0xad447e(0x7f)][_0xad447e(0x87)](_0xad447e(0xb7)+_0x16a0a7[_0xad447e(0x73)](),_0xad447e(0xc2)+_0x79d849,_0xad447e(0xc9),_0x54e8cd);const _0x4e1a4e=await fetch(this[_0xad447e(0xba)],{'method':_0xad447e(0xc9),'headers':{'Content-Type':_0xad447e(0xf3),'User-Agent':_0xad447e(0x83)},'body':JSON[_0xad447e(0xa1)](_0x54e8cd)}),_0x46d612=Date[_0xad447e(0xb9)]()-_0x3b3c34;if(!_0x4e1a4e['ok']){const _0x499824=await _0x4e1a4e[_0xad447e(0xb2)]();loggerService_1[_0xad447e(0x7f)]['logWhiteDomainResponse'](_0xad447e(0xb7)+_0x16a0a7[_0xad447e(0x73)](),'/verify/'+_0x79d849,_0x4e1a4e[_0xad447e(0xcf)],_0x499824,_0x46d612);throw new Error('HTTP\x20error!\x20status:\x20'+_0x4e1a4e['status']);}const _0x318302=await _0x4e1a4e[_0xad447e(0xe4)]();loggerService_1[_0xad447e(0x7f)][_0xad447e(0xce)](_0xad447e(0xb7)+_0x16a0a7[_0xad447e(0x73)](),'/verify/'+_0x79d849,_0x4e1a4e[_0xad447e(0xcf)],_0x318302,_0x46d612);if(_0x318302[_0xad447e(0x91)]||_0x318302[_0xad447e(0xe3)]){loggerService_1[_0xad447e(0x7f)][_0xad447e(0xd6)](_0xad447e(0xb7)+_0x16a0a7[_0xad447e(0x73)](),_0xad447e(0xc2)+_0x79d849,_0xad447e(0x79)+_0x16a0a7+_0xad447e(0x76)+(_0x318302[_0xad447e(0x69)]||_0x318302[_0xad447e(0x91)]||_0xad447e(0xda)));throw new Error(_0xad447e(0x79)+_0x16a0a7+_0xad447e(0x76)+(_0x318302[_0xad447e(0x69)]||_0x318302[_0xad447e(0x91)]||_0xad447e(0xda)));}let _0x414d4d=_0xad447e(0xa4);return{'status':_0x414d4d};}catch(_0x5051cb){console[_0xad447e(0x91)](_0xad447e(0x79)+_0x16a0a7+'\x20payment\x20verification\x20error:',_0x5051cb),loggerService_1[_0xad447e(0x7f)][_0xad447e(0xd6)](_0xad447e(0xb7)+_0x16a0a7[_0xad447e(0x73)](),_0xad447e(0xc2)+_0x79d849,_0x5051cb);throw new Error(_0xad447e(0x9b)+_0x16a0a7+_0xad447e(0xee)+(_0x5051cb instanceof Error?_0x5051cb[_0xad447e(0x69)]:_0xad447e(0xda)));}}async['processWebhook'](_0x3f0e05){const _0x440a36=a41_0x221242;console[_0x440a36(0xeb)]('Processing\x20KLYME\x20webhook:',_0x3f0e05);let _0x14504f=_0x440a36(0xa4);switch(_0x3f0e05[_0x440a36(0xcf)]?.[_0x440a36(0x73)]()){case _0x440a36(0xc0):case'completed':case _0x440a36(0xc4):case _0x440a36(0x8d):case _0x440a36(0xd3):_0x14504f='PAID';break;case _0x440a36(0xcd):case _0x440a36(0xb4):case'failed':case _0x440a36(0x91):case _0x440a36(0xf6):_0x14504f=_0x440a36(0xe0);break;case _0x440a36(0xaf):case'timeout':_0x14504f=_0x440a36(0xe6);break;case _0x440a36(0xa7):case _0x440a36(0xbd):case _0x440a36(0xe2):case _0x440a36(0x7b):case _0x440a36(0x7e):default:_0x14504f='PENDING';break;}return{'paymentId':_0x3f0e05[_0x440a36(0xf4)]||_0x3f0e05[_0x440a36(0x7d)]||_0x3f0e05[_0x440a36(0x8b)],'status':_0x14504f,'amount':_0x3f0e05[_0x440a36(0x74)],'currency':_0x3f0e05[_0x440a36(0x88)],'region':_0x3f0e05[_0x440a36(0xd4)],'additionalInfo':{'payment_method':_0x3f0e05[_0x440a36(0xb8)],'transaction_id':_0x3f0e05[_0x440a36(0xc3)]}};}}function a41_0xdaed(_0x1e852e,_0x4f8fdb){const _0x2b6b92=a41_0x2b6b();return a41_0xdaed=function(_0xdaed57,_0x6c6f1b){_0xdaed57=_0xdaed57-0x66;let _0x17c159=_0x2b6b92[_0xdaed57];return _0x17c159;},a41_0xdaed(_0x1e852e,_0x4f8fdb);}function a41_0x2b6b(){const _0x186e4c=['\x20API:\x20','cancelled','logWhiteDomainResponse','status','../loggerService','üí≥\x20KLYME\x20','__setModuleDefault','successful','region','4217478Lprbze','logWhiteDomainError','create','getOwnPropertyDescriptor','4SwxqWc','Unknown\x20error','\x20API\x20ERROR\x20===','Request\x20Body:','\x20API\x20BUSINESS\x20ERROR\x20===','defineProperty','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','FAILED',',\x20body:\x20','active','statusCode','json','authUrl','EXPIRED','entries','Reference\x20Used:','\x20API:\x20missing\x20payment\x20data','generateUniqueReference','log','EUR','get','\x20payment:\x20','UUID:','resolve','1955245VTNFub','Unknown\x20error\x20from\x20KLYME\x20','application/json','reference','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','rejected','\x20currency\x20validation\x20passed:\x20','default','233439KTAnzG','\x20API','(validated\x20for\x20','message','statusText','Error\x20details:','\x20payment\x20link:\x20','\x20payment\x20link:\x20Unknown\x20error','Raw\x20Response\x20Body:','toUpperCase','10477488pYeSQh','üí≥\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','payment','toLowerCase','amount','writable','\x20API\x20error:\x20','Status\x20Text:','Reference\x20Used\x20as\x20ID:','KLYME\x20','length','processing','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','order_id','in_progress','loggerService','https://tesoft.uk/gateway/pending.php?id=','17838QwXSuY','\x20(8digits-8digits\x20format\x20for\x20','TesSoft\x20Payment\x20System/1.0','\x20SERVICE\x20ERROR\x20===','__importStar','Error\x20Message:','logWhiteDomainRequest','currency','Error\x20stack:','Status\x20Code:','payment_id','Redirect\x20URL:','success','redirect_url','===\x20PARSED\x20KLYME\x20','toString','error','Headers:','padStart','uuid','Response\x20Time:','Region\x20(geo):','===\x20KLYME\x20','validateCurrencyForRegion','https://tesoft.uk/gateway/klyme/','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','Failed\x20to\x20verify\x20KLYME\x20','5554617tZxAQO','5822796uQuMYC','__esModule','HTTP\x20','hasOwnProperty','stringify','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','2vYOmem','PENDING','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','(8digits-8digits\x20format)','pending','HTTP\x20error!\x20status:\x20','call','\x20SUCCESS\x20(Legacy\x20Format)\x20===','\x20validated)','Failed\x20to\x20create\x20KLYME\x20','random','KlymeService','expired','floor','verifyPayment','text','Error\x20message:','canceled','Currency:','fromEntries','klyme_','payment_method','now','apiUrl','findFirst','createPaymentLink','created','/create','Parsed\x20Result:','paid','500hhlrlj','/verify/','transaction_id','confirmed','Auth\x20URL:','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','\x20RESPONSE\x20===','then','POST','Currency\x20Used:','Invalid\x20JSON\x20response\x20from\x20KLYME\x20'];a41_0x2b6b=function(){return _0x186e4c;};return a41_0x2b6b();}exports[a41_0x221242(0xae)]=KlymeService;