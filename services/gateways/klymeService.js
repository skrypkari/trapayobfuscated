'use strict';const a42_0x1695d1=a42_0x4d85;(function(_0x1bdb87,_0x571b98){const _0x2d415c=a42_0x4d85,_0x1a857e=_0x1bdb87();while(!![]){try{const _0x2d976c=parseInt(_0x2d415c(0x182))/0x1+parseInt(_0x2d415c(0x14d))/0x2+parseInt(_0x2d415c(0x133))/0x3+parseInt(_0x2d415c(0x185))/0x4+parseInt(_0x2d415c(0x129))/0x5*(parseInt(_0x2d415c(0x12d))/0x6)+parseInt(_0x2d415c(0x12e))/0x7+-parseInt(_0x2d415c(0x18e))/0x8;if(_0x2d976c===_0x571b98)break;else _0x1a857e['push'](_0x1a857e['shift']());}catch(_0x39a26d){_0x1a857e['push'](_0x1a857e['shift']());}}}(a42_0x22f1,0xc6f31));var __createBinding=this&&this['__createBinding']||(Object[a42_0x1695d1(0x127)]?function(_0x1292fd,_0x56a1ca,_0x52862f,_0x40da27){const _0x5e6ae1=a42_0x1695d1;if(_0x40da27===undefined)_0x40da27=_0x52862f;var _0xcc8855=Object['getOwnPropertyDescriptor'](_0x56a1ca,_0x52862f);(!_0xcc8855||(_0x5e6ae1(0x11a)in _0xcc8855?!_0x56a1ca[_0x5e6ae1(0x18f)]:_0xcc8855[_0x5e6ae1(0x18d)]||_0xcc8855[_0x5e6ae1(0x14b)]))&&(_0xcc8855={'enumerable':!![],'get':function(){return _0x56a1ca[_0x52862f];}}),Object['defineProperty'](_0x1292fd,_0x40da27,_0xcc8855);}:function(_0x37011a,_0x3f6c54,_0x2d775f,_0x3a6ab1){if(_0x3a6ab1===undefined)_0x3a6ab1=_0x2d775f;_0x37011a[_0x3a6ab1]=_0x3f6c54[_0x2d775f];}),__setModuleDefault=this&&this[a42_0x1695d1(0x186)]||(Object[a42_0x1695d1(0x127)]?function(_0x8ba637,_0x59fd03){const _0x102d2c=a42_0x1695d1;Object[_0x102d2c(0x13d)](_0x8ba637,_0x102d2c(0x156),{'enumerable':!![],'value':_0x59fd03});}:function(_0x2b0f02,_0x256768){_0x2b0f02['default']=_0x256768;}),__importStar=this&&this[a42_0x1695d1(0x169)]||(function(){var _0xb37edb=function(_0x4eab67){const _0x47d951=a42_0x4d85;return _0xb37edb=Object[_0x47d951(0x175)]||function(_0x588c64){const _0x149623=_0x47d951;var _0x1e00b2=[];for(var _0x374f2f in _0x588c64)if(Object['prototype'][_0x149623(0x126)][_0x149623(0x105)](_0x588c64,_0x374f2f))_0x1e00b2[_0x1e00b2[_0x149623(0x150)]]=_0x374f2f;return _0x1e00b2;},_0xb37edb(_0x4eab67);};return function(_0x56d6f2){const _0x102dcc=a42_0x4d85;if(_0x56d6f2&&_0x56d6f2[_0x102dcc(0x18f)])return _0x56d6f2;var _0x27ae30={};if(_0x56d6f2!=null){for(var _0x264318=_0xb37edb(_0x56d6f2),_0x239f56=0x0;_0x239f56<_0x264318[_0x102dcc(0x150)];_0x239f56++)if(_0x264318[_0x239f56]!=='default')__createBinding(_0x27ae30,_0x56d6f2,_0x264318[_0x239f56]);}return __setModuleDefault(_0x27ae30,_0x56d6f2),_0x27ae30;};}());Object[a42_0x1695d1(0x13d)](exports,a42_0x1695d1(0x18f),{'value':!![]}),exports['KlymeService']=void 0x0;function a42_0x22f1(){const _0x3536f7=['(8digits-8digits\x20format)','\x20currency\x20validation\x20passed:\x20','\x20API\x20REQUEST\x20(Unified\x20Route\x20with\x20Geo)\x20===','then','error','headers','PENDING','hasOwnProperty','create','successful','5FUowBz','now','in_progress','confirmed','1675074xnCFEq','3683414IpxcLH','cancelled','completed','Invalid\x20response\x20from\x20KLYME\x20','Missing\x20uuid/redirect_url\x20or\x20authUrl\x20in\x20response','1394922PJmPdn','Currency:','application/json','parse','Status\x20Code:','Failed\x20to\x20create\x20KLYME\x20','message','resolve','../loggerService','failed','defineProperty','\x20API','Error\x20message:','KLYME\x20payment\x20creation\x20is\x20supported\x20for\x20EU,\x20GB\x20and\x20DE\x20regions,\x20got:\x20','===\x20KLYME\x20','EUR','processing','logWhiteDomainError','Processing\x20KLYME\x20webhook:','Raw\x20Response\x20Body:','statusText','POST','\x20SUCCESS\x20(New\x20Format)\x20===','redirect_url','configurable','success','2272574XYdfvw','paid','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','length','entries','HTTP\x20','\x20payment\x20link:\x20Unknown\x20error','Reference:','Unknown\x20error\x20from\x20KLYME\x20','default','Unsupported\x20KLYME\x20region:\x20','timeout','Error\x20stack:','\x20API\x20INCOMPLETE\x20RESPONSE\x20===','findFirst','\x20API\x20error:\x20','payment_id','/verify/','json','pending','Business\x20Error:\x20','authUrl','logWhiteDomainRequest','\x20API:\x20','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','GBP','Auth\x20URL:','toLowerCase','__importStar','UUID:','text','reference','URL:','/create','KLYME\x20','random','status','Unknown\x20error','padStart','active','getOwnPropertyNames','Currency\x20Used:','Reference\x20Used:','\x20SERVICE\x20ERROR\x20===','Failed\x20to\x20verify\x20KLYME\x20','Request\x20Body:','klyme_','stringify','Incomplete\x20response:\x20missing\x20uuid/redirect_url\x20or\x20authUrl','Response\x20data:','rejected','\x20payment\x20verification\x20error:','(validated\x20for\x20','340778oUkFzf','Region\x20(geo):','https://tesoft.uk/gateway/klyme/','1064988dGRsqF','__setModuleDefault','Reference\x20Used\x20as\x20ID:','===\x20PARSED\x20KLYME\x20','\x20API\x20ERROR\x20===','HTTP\x20Status:','\x20SUCCESS\x20(Legacy\x20Format)\x20===','statusCode','writable','17590160zaOxJW','__esModule','KlymeService','HTTP\x20error!\x20status:\x20','apiUrl','\x20API\x20RESPONSE\x20(Unified\x20Route)\x20===','💳\x20KLYME\x20service\x20initialized\x20with\x20unified\x20white\x20domain\x20proxy\x20for\x20all\x20regions','🎯\x20Generated\x20unique\x20KLYME\x20reference:\x20','Status:','Response\x20Body:','Status\x20Text:','TesSoft\x20Payment\x20System/1.0','fromEntries','currency','💳\x20KLYME\x20','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','call','uuid','PAID','../../config/database','amount','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','log','canceled','Parsed\x20Result:','⚠️\x20KLYME\x20reference\x20','stack','\x20API\x20BUSINESS\x20ERROR\x20===','Geo\x20Parameter:','generateUniqueReference','transaction_id','region','payment_method','toUpperCase','Error\x20Message:','Response\x20Time:','loggerService','get','Redirect\x20URL:','logWhiteDomainResponse','createPaymentLink','expired'];a42_0x22f1=function(){return _0x3536f7;};return a42_0x22f1();}function a42_0x4d85(_0x7414e5,_0x29f479){const _0x22f113=a42_0x22f1();return a42_0x4d85=function(_0x4d8506,_0x56f0f2){_0x4d8506=_0x4d8506-0xfe;let _0x34094e=_0x22f113[_0x4d8506];return _0x34094e;},a42_0x4d85(_0x7414e5,_0x29f479);}const loggerService_1=require(a42_0x1695d1(0x13b));class KlymeService{constructor(){const _0x5785a8=a42_0x1695d1;this[_0x5785a8(0x192)]=_0x5785a8(0x184),console[_0x5785a8(0x10b)](_0x5785a8(0x194));}['validateCurrencyForRegion'](_0x80d8ad,_0x46a521){const _0x5b2aa3=a42_0x1695d1,_0x4ca887=_0x80d8ad[_0x5b2aa3(0x116)]();switch(_0x46a521){case'EU':if(_0x4ca887!==_0x5b2aa3(0x142))throw new Error(_0x5b2aa3(0x165)+_0x4ca887);break;case'GB':if(_0x4ca887!==_0x5b2aa3(0x166))throw new Error(_0x5b2aa3(0x14f)+_0x4ca887);break;case'DE':if(_0x4ca887!==_0x5b2aa3(0x142))throw new Error(_0x5b2aa3(0x104)+_0x4ca887);break;default:throw new Error(_0x5b2aa3(0x157)+_0x46a521);}}async[a42_0x1695d1(0x112)](){const _0x45c174=a42_0x1695d1,_0x443769=(await Promise[_0x45c174(0x13a)]()[_0x45c174(0x122)](()=>__importStar(require(_0x45c174(0x108)))))['default'];let _0x5c0c30,_0x49a3ec=0x0;const _0x542100=0xa;do{const _0x2ac0e5=()=>{const _0x35bd36=_0x45c174;return Math['floor'](Math[_0x35bd36(0x170)]()*0x5f5e100)['toString']()[_0x35bd36(0x173)](0x8,'0');};_0x5c0c30=_0x2ac0e5()+'-'+_0x2ac0e5();const _0x5741b9=await _0x443769['payment'][_0x45c174(0x15b)]({'where':{'gatewayOrderId':_0x5c0c30}});if(!_0x5741b9)break;_0x49a3ec++,console[_0x45c174(0x10b)](_0x45c174(0x10e)+_0x5c0c30+_0x45c174(0x10a)+_0x49a3ec+')');}while(_0x49a3ec<_0x542100);if(_0x49a3ec>=_0x542100)throw new Error('Failed\x20to\x20generate\x20unique\x20KLYME\x20reference\x20after\x20maximum\x20attempts');return _0x5c0c30;}async[a42_0x1695d1(0x11d)](_0x15bd1f){const _0x2be748=a42_0x1695d1,{orderId:_0x92d476,amount:_0x405c56,currency:_0x7fa923,region:_0x849294}=_0x15bd1f;if(_0x849294!=='EU'&&_0x849294!=='GB'&&_0x849294!=='DE')throw new Error(_0x2be748(0x140)+_0x849294);this['validateCurrencyForRegion'](_0x7fa923,_0x849294);const _0x4f3af6=_0x7fa923[_0x2be748(0x116)]();console[_0x2be748(0x10b)](_0x2be748(0x103)+_0x849294+_0x2be748(0x120)+_0x4f3af6);const _0x9087ca=await this[_0x2be748(0x112)]();console['log'](_0x2be748(0x195)+_0x9087ca+'\x20(8digits-8digits\x20format\x20for\x20'+_0x849294+')');const _0x2b7d61='https://tesoft.uk/gateway/pending.php?id='+_0x92d476,_0x9c79bc={'amount':_0x405c56,'currency':_0x4f3af6,'redirectUrl':_0x2b7d61,'reference':_0x9087ca,'geo':_0x849294},_0x2b2a8e=Date[_0x2be748(0x12a)]();try{console[_0x2be748(0x10b)]('===\x20KLYME\x20'+_0x849294+_0x2be748(0x121)),console['log'](_0x2be748(0x16d),this[_0x2be748(0x192)]),console[_0x2be748(0x10b)](_0x2be748(0x17a),JSON[_0x2be748(0x17c)](_0x9c79bc,null,0x2)),console[_0x2be748(0x10b)](_0x2be748(0x183),_0x849294),console['log'](_0x2be748(0x134),_0x4f3af6,_0x2be748(0x181)+_0x849294+')'),console['log'](_0x2be748(0x154),_0x9087ca,_0x2be748(0x11f)),console[_0x2be748(0x10b)](_0x2be748(0x11b),_0x2b7d61),loggerService_1[_0x2be748(0x119)][_0x2be748(0x163)](_0x2be748(0x17b)+_0x849294['toLowerCase'](),_0x2be748(0x16e),_0x2be748(0x148),_0x9c79bc);const _0x24636c=await fetch(this[_0x2be748(0x192)],{'method':_0x2be748(0x148),'headers':{'Content-Type':_0x2be748(0x135),'Accept':_0x2be748(0x135),'User-Agent':_0x2be748(0x100)},'body':JSON['stringify'](_0x9c79bc)}),_0xcdfdc5=Date[_0x2be748(0x12a)]()-_0x2b2a8e;console['log'](_0x2be748(0x141)+_0x849294+_0x2be748(0x193)),console[_0x2be748(0x10b)](_0x2be748(0x196),_0x24636c['status']),console[_0x2be748(0x10b)](_0x2be748(0xff),_0x24636c[_0x2be748(0x147)]),console['log']('Headers:',Object[_0x2be748(0x101)](_0x24636c[_0x2be748(0x124)][_0x2be748(0x151)]())),console[_0x2be748(0x10b)](_0x2be748(0x118),_0xcdfdc5+'ms');const _0x249a3a=await _0x24636c[_0x2be748(0x16b)]();console[_0x2be748(0x10b)](_0x2be748(0x146),_0x249a3a);if(!_0x24636c['ok']){console[_0x2be748(0x123)]('===\x20KLYME\x20'+_0x849294+_0x2be748(0x189)),console[_0x2be748(0x123)](_0x2be748(0x18a),_0x24636c[_0x2be748(0x171)]),console[_0x2be748(0x123)](_0x2be748(0xfe),_0x249a3a),loggerService_1[_0x2be748(0x119)][_0x2be748(0x11c)](_0x2be748(0x17b)+_0x849294['toLowerCase'](),_0x2be748(0x16e),_0x24636c[_0x2be748(0x171)],_0x249a3a,_0xcdfdc5),loggerService_1[_0x2be748(0x119)][_0x2be748(0x144)](_0x2be748(0x17b)+_0x849294[_0x2be748(0x168)](),_0x2be748(0x16e),_0x2be748(0x152)+_0x24636c['status']+':\x20'+_0x249a3a);throw new Error(_0x2be748(0x191)+_0x24636c[_0x2be748(0x171)]+',\x20body:\x20'+_0x249a3a);}let _0x4bde7c;try{_0x4bde7c=JSON[_0x2be748(0x136)](_0x249a3a);}catch(_0x271880){console[_0x2be748(0x123)]('Failed\x20to\x20parse\x20JSON\x20response:',_0x271880),loggerService_1[_0x2be748(0x119)][_0x2be748(0x144)](_0x2be748(0x17b)+_0x849294[_0x2be748(0x168)](),'/create','JSON\x20Parse\x20Error:\x20'+_0x271880);throw new Error('Invalid\x20JSON\x20response\x20from\x20KLYME\x20'+_0x849294+_0x2be748(0x164)+_0x249a3a);}console[_0x2be748(0x10b)](_0x2be748(0x188)+_0x849294+'\x20RESPONSE\x20==='),console[_0x2be748(0x10b)](_0x2be748(0x10d),JSON[_0x2be748(0x17c)](_0x4bde7c,null,0x2)),loggerService_1['loggerService'][_0x2be748(0x11c)](_0x2be748(0x17b)+_0x849294[_0x2be748(0x168)](),_0x2be748(0x16e),_0x24636c[_0x2be748(0x171)],_0x4bde7c,_0xcdfdc5);if(_0x4bde7c[_0x2be748(0x123)]||_0x4bde7c[_0x2be748(0x18c)]){const _0x24e83a=_0x4bde7c[_0x2be748(0x139)]||_0x4bde7c[_0x2be748(0x123)]||_0x2be748(0x155)+_0x849294+_0x2be748(0x13e);console[_0x2be748(0x123)]('===\x20KLYME\x20'+_0x849294+_0x2be748(0x110)),console[_0x2be748(0x123)](_0x2be748(0x117),_0x24e83a),console[_0x2be748(0x123)](_0x2be748(0x137),_0x4bde7c[_0x2be748(0x18c)]),loggerService_1['loggerService']['logWhiteDomainError']('klyme_'+_0x849294[_0x2be748(0x168)](),'/create',_0x2be748(0x161)+_0x24e83a);throw new Error('KLYME\x20'+_0x849294+_0x2be748(0x15c)+_0x24e83a);}let _0x24bb2a,_0x518597;if(_0x4bde7c[_0x2be748(0x106)]&&_0x4bde7c['redirect_url'])_0x24bb2a=_0x4bde7c[_0x2be748(0x106)],_0x518597=_0x4bde7c[_0x2be748(0x14a)],console['log']('===\x20KLYME\x20'+_0x849294+_0x2be748(0x149)),console['log'](_0x2be748(0x16a),_0x4bde7c['uuid']),console['log'](_0x2be748(0x11b),_0x4bde7c['redirect_url']);else{if(_0x4bde7c[_0x2be748(0x162)])_0x24bb2a=_0x9087ca,_0x518597=_0x4bde7c[_0x2be748(0x162)],console[_0x2be748(0x10b)](_0x2be748(0x141)+_0x849294+_0x2be748(0x18b)),console[_0x2be748(0x10b)](_0x2be748(0x167),_0x4bde7c[_0x2be748(0x162)]),console[_0x2be748(0x10b)](_0x2be748(0x187),_0x9087ca);else{console[_0x2be748(0x123)](_0x2be748(0x141)+_0x849294+_0x2be748(0x15a)),console[_0x2be748(0x123)](_0x2be748(0x132)),console['error'](_0x2be748(0x17e),_0x4bde7c),loggerService_1[_0x2be748(0x119)][_0x2be748(0x144)]('klyme_'+_0x849294[_0x2be748(0x168)](),_0x2be748(0x16e),_0x2be748(0x17d));throw new Error(_0x2be748(0x131)+_0x849294+'\x20API:\x20missing\x20payment\x20data');}}return console[_0x2be748(0x10b)](_0x2be748(0x176),_0x4f3af6,'('+_0x849294+'\x20validated)'),console[_0x2be748(0x10b)](_0x2be748(0x177),_0x9087ca,'(8digits-8digits\x20format)'),console[_0x2be748(0x10b)](_0x2be748(0x111),_0x849294),{'gateway_payment_id':_0x24bb2a,'payment_url':_0x518597};}catch(_0x1903af){console[_0x2be748(0x123)](_0x2be748(0x141)+_0x849294+_0x2be748(0x178)),console['error']('Error\x20details:',_0x1903af),loggerService_1['loggerService']['logWhiteDomainError'](_0x2be748(0x17b)+_0x849294['toLowerCase'](),_0x2be748(0x16e),_0x1903af);if(_0x1903af instanceof Error){console[_0x2be748(0x123)](_0x2be748(0x13f),_0x1903af[_0x2be748(0x139)]),console['error'](_0x2be748(0x159),_0x1903af[_0x2be748(0x10f)]);throw new Error(_0x2be748(0x138)+_0x849294+'\x20payment\x20link:\x20'+_0x1903af[_0x2be748(0x139)]);}throw new Error(_0x2be748(0x138)+_0x849294+_0x2be748(0x153));}}async['verifyPayment'](_0x1a3dda,_0x5d0b13){const _0x3c0d43=a42_0x1695d1,_0x36408e=Date[_0x3c0d43(0x12a)]();try{const _0x1b6951={'gatewayPaymentId':_0x1a3dda,'geo':_0x5d0b13};loggerService_1[_0x3c0d43(0x119)][_0x3c0d43(0x163)](_0x3c0d43(0x17b)+_0x5d0b13[_0x3c0d43(0x168)](),_0x3c0d43(0x15e)+_0x1a3dda,_0x3c0d43(0x148),_0x1b6951);const _0x17eade=await fetch(this[_0x3c0d43(0x192)],{'method':'POST','headers':{'Content-Type':_0x3c0d43(0x135),'User-Agent':_0x3c0d43(0x100)},'body':JSON['stringify'](_0x1b6951)}),_0x4c337b=Date['now']()-_0x36408e;if(!_0x17eade['ok']){const _0x52671b=await _0x17eade[_0x3c0d43(0x16b)]();loggerService_1[_0x3c0d43(0x119)][_0x3c0d43(0x11c)](_0x3c0d43(0x17b)+_0x5d0b13['toLowerCase'](),_0x3c0d43(0x15e)+_0x1a3dda,_0x17eade[_0x3c0d43(0x171)],_0x52671b,_0x4c337b);throw new Error(_0x3c0d43(0x191)+_0x17eade['status']);}const _0x5e69e6=await _0x17eade[_0x3c0d43(0x15f)]();loggerService_1['loggerService'][_0x3c0d43(0x11c)](_0x3c0d43(0x17b)+_0x5d0b13[_0x3c0d43(0x168)](),_0x3c0d43(0x15e)+_0x1a3dda,_0x17eade['status'],_0x5e69e6,_0x4c337b);if(_0x5e69e6[_0x3c0d43(0x123)]||_0x5e69e6[_0x3c0d43(0x18c)]){loggerService_1['loggerService']['logWhiteDomainError'](_0x3c0d43(0x17b)+_0x5d0b13[_0x3c0d43(0x168)](),_0x3c0d43(0x15e)+_0x1a3dda,_0x3c0d43(0x16f)+_0x5d0b13+'\x20API\x20error:\x20'+(_0x5e69e6[_0x3c0d43(0x139)]||_0x5e69e6[_0x3c0d43(0x123)]||_0x3c0d43(0x172)));throw new Error(_0x3c0d43(0x16f)+_0x5d0b13+'\x20API\x20error:\x20'+(_0x5e69e6[_0x3c0d43(0x139)]||_0x5e69e6['error']||_0x3c0d43(0x172)));}let _0x15b47e=_0x3c0d43(0x125);return{'status':_0x15b47e};}catch(_0x38ebae){console[_0x3c0d43(0x123)]('KLYME\x20'+_0x5d0b13+_0x3c0d43(0x180),_0x38ebae),loggerService_1[_0x3c0d43(0x119)][_0x3c0d43(0x144)]('klyme_'+_0x5d0b13['toLowerCase'](),_0x3c0d43(0x15e)+_0x1a3dda,_0x38ebae);throw new Error(_0x3c0d43(0x179)+_0x5d0b13+'\x20payment:\x20'+(_0x38ebae instanceof Error?_0x38ebae[_0x3c0d43(0x139)]:_0x3c0d43(0x172)));}}async['processWebhook'](_0x278dd8){const _0x33d27d=a42_0x1695d1;console[_0x33d27d(0x10b)](_0x33d27d(0x145),_0x278dd8);let _0x1971c7=_0x33d27d(0x125);switch(_0x278dd8[_0x33d27d(0x171)]?.[_0x33d27d(0x168)]()){case _0x33d27d(0x14e):case _0x33d27d(0x130):case _0x33d27d(0x12c):case _0x33d27d(0x14c):case _0x33d27d(0x128):_0x1971c7=_0x33d27d(0x107);break;case _0x33d27d(0x12f):case _0x33d27d(0x10c):case _0x33d27d(0x13c):case _0x33d27d(0x123):case _0x33d27d(0x17f):_0x1971c7='FAILED';break;case _0x33d27d(0x11e):case _0x33d27d(0x158):_0x1971c7='EXPIRED';break;case _0x33d27d(0x160):case'created':case _0x33d27d(0x174):case _0x33d27d(0x143):case _0x33d27d(0x12b):default:_0x1971c7=_0x33d27d(0x125);break;}return{'paymentId':_0x278dd8[_0x33d27d(0x16c)]||_0x278dd8['order_id']||_0x278dd8[_0x33d27d(0x15d)],'status':_0x1971c7,'amount':_0x278dd8[_0x33d27d(0x109)],'currency':_0x278dd8[_0x33d27d(0x102)],'region':_0x278dd8[_0x33d27d(0x114)],'additionalInfo':{'payment_method':_0x278dd8[_0x33d27d(0x115)],'transaction_id':_0x278dd8[_0x33d27d(0x113)]}};}}exports[a42_0x1695d1(0x190)]=KlymeService;