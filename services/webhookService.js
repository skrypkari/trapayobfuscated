'use strict';const a55_0x46d460=a55_0x4d3a;(function(_0x2c54a3,_0x2bb1c7){const _0x3c34df=a55_0x4d3a,_0x4ddb33=_0x2c54a3();while(!![]){try{const _0x4dbc4a=parseInt(_0x3c34df(0x227))/0x1+parseInt(_0x3c34df(0x1e3))/0x2+-parseInt(_0x3c34df(0x1bd))/0x3+-parseInt(_0x3c34df(0x1ed))/0x4+parseInt(_0x3c34df(0x1c0))/0x5*(-parseInt(_0x3c34df(0x214))/0x6)+-parseInt(_0x3c34df(0x201))/0x7+parseInt(_0x3c34df(0x21b))/0x8*(parseInt(_0x3c34df(0x1d0))/0x9);if(_0x4dbc4a===_0x2bb1c7)break;else _0x4ddb33['push'](_0x4ddb33['shift']());}catch(_0x1d82ba){_0x4ddb33['push'](_0x4ddb33['shift']());}}}(a55_0x23e0,0x21f7d));function a55_0x23e0(){const _0x1f6472=['Error\x20parsing\x20webhook\x20events:','plisio','region','now','paidAt','\x20URLs','./gateways/nodaService','ðŸ’¾\x20Failure\x20message\x20saved:\x20','logShopWebhookError','toLowerCase','processNodaWebhook','paid','./telegramBotService','Error\x20parsing\x20tx_urls\x20for\x20webhook:','shopId','__esModule','customerEmail','logShopWebhookSent','./gateways/rapydService','currency','text','coinToPayService','_webhook_','ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20','webhookUrl','error','plisioService','payment','RapydService','PAID','PENDING','\x20->\x20','amount','Error\x20processing\x20Rapyd\x20webhook:','remitterName','Error\x20processing\x20CoinToPay\x20webhook:','bankId','No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook','klyme','795168DsmQmj','KlymeService','gatewayOrderId','253735XarFuy','CoinToPayService','remitterIban','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook','klymeService','logWebhookError','processKlymeWebhook','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','Processing\x20KLYME\x20webhook:','failed','stringify','\x20status\x20change:\x20','ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20','default','sendShopWebhook','orderId','1343214bWdAYE','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','txUrls','PaymentLinkService','Processing\x20Noda\x20webhook:','processWebhook','failureMessage','\x20webhook','includes','created','Webhook\x20event\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','create','ðŸ”„\x20Updating\x20payment\x20','defineProperty','Failed\x20to\x20update\x20payment\x20link\x20counter:','ðŸ’¾\x20Saving\x20failure\x20message:\x20','EXPIRED','./gateways/plisioService','100894RiUiFx','\x20updated\x20successfully:\x20','Success','Processing\x20CoinToPay\x20webhook:','plisio_gateway','payment.failed','status','processCoinToPayWebhook','sendPaymentStatusNotification','telegramBotService','829016qbVKMZ','processPlisioGatewayWebhook','webhookEvents','parse','update','PlisioService','rapyd','processPlisioWebhook','application/json','ms)','TesSoft\x20Payment\x20System/1.0','Processing\x20Plisio\x20Gateway\x20webhook:','paymentLinkService','noda','Processing\x20Rapyd\x20webhook:','__importDefault','length','additionalInfo','./loggerService','\x20from\x20','932554NmGRDo','No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook','nodaService','webhookLog','rapydService','Error\x20processing\x20Noda\x20webhook:','No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook','payment.success','cointopay','settings','findFirst','paymentMethod','Error\x20processing\x20Plisio\x20webhook:','updatePaymentStatus','âœ…\x20Payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','handleSuccessfulPayment','loggerService','gateway','6gpUINn','log','cardLast4','ðŸ’¥\x20Payment\x20','logWebhookProcessed','POST','webhook_send','32SwbIHQ','\x20status\x20unchanged\x20(','customerName','../config/database','Payment\x20','unknown','paymentId','shop','ðŸ”—\x20Payment\x20','WebhookService','\x20failure\x20message:\x20','\x20not\x20enabled\x20for\x20shop\x20','147981JLJvio','./gateways/klymeService'];a55_0x23e0=function(){return _0x1f6472;};return a55_0x23e0();}var __importDefault=this&&this[a55_0x46d460(0x1fc)]||function(_0x562f2f){const _0xb14dc0=a55_0x46d460;return _0x562f2f&&_0x562f2f[_0xb14dc0(0x1a4)]?_0x562f2f:{'default':_0x562f2f};};Object[a55_0x46d460(0x1de)](exports,'__esModule',{'value':!![]}),exports[a55_0x46d460(0x224)]=void 0x0;function a55_0x4d3a(_0xaa8f70,_0x4fd7b7){const _0x23e029=a55_0x23e0();return a55_0x4d3a=function(_0x4d3a71,_0x23478e){_0x4d3a71=_0x4d3a71-0x1a4;let _0x17131f=_0x23e029[_0x4d3a71];return _0x17131f;},a55_0x4d3a(_0xaa8f70,_0x4fd7b7);}const database_1=__importDefault(require(a55_0x46d460(0x21e))),plisioService_1=require(a55_0x46d460(0x1e2)),rapydService_1=require(a55_0x46d460(0x1a7)),nodaService_1=require(a55_0x46d460(0x22f)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require(a55_0x46d460(0x228)),telegramBotService_1=require(a55_0x46d460(0x235)),paymentLinkService_1=require('./paymentLinkService'),loggerService_1=require(a55_0x46d460(0x1ff));class WebhookService{constructor(){const _0x57919d=a55_0x46d460;this[_0x57919d(0x1af)]=new plisioService_1[(_0x57919d(0x1f2))](),this[_0x57919d(0x205)]=new rapydService_1[(_0x57919d(0x1b1))](),this[_0x57919d(0x203)]=new nodaService_1['NodaService'](),this[_0x57919d(0x1aa)]=new coinToPayService_1[(_0x57919d(0x1c1))](),this[_0x57919d(0x1c4)]=new klymeService_1[(_0x57919d(0x1be))](),this[_0x57919d(0x1f9)]=new paymentLinkService_1[(_0x57919d(0x1d3))]();}async[a55_0x46d460(0x1f4)](_0x5a41c1){const _0x407329=a55_0x46d460;console[_0x407329(0x215)]('Processing\x20Plisio\x20webhook:',_0x5a41c1);try{const _0x31aad7=await this[_0x407329(0x1af)][_0x407329(0x1d5)](_0x5a41c1);if(!_0x31aad7[_0x407329(0x221)]){console[_0x407329(0x1ae)](_0x407329(0x1c3));return;}await this[_0x407329(0x20e)](_0x31aad7[_0x407329(0x221)],_0x31aad7[_0x407329(0x1e9)],'plisio',_0x5a41c1,undefined,undefined,_0x31aad7[_0x407329(0x1d2)]),loggerService_1[_0x407329(0x212)][_0x407329(0x218)](_0x407329(0x22a),_0x31aad7[_0x407329(0x221)],_0x407329(0x1b3),_0x31aad7[_0x407329(0x1e9)],_0x5a41c1);}catch(_0x3528c4){console[_0x407329(0x1ae)](_0x407329(0x20d),_0x3528c4),loggerService_1['loggerService'][_0x407329(0x1c5)](_0x407329(0x22a),_0x3528c4,_0x5a41c1);throw _0x3528c4;}}async[a55_0x46d460(0x1ee)](_0x480755){const _0x367f45=a55_0x46d460;console[_0x367f45(0x215)](_0x367f45(0x1f8),_0x480755);try{const _0x5871c9=await this['plisioService'][_0x367f45(0x1d5)](_0x480755);if(!_0x5871c9['paymentId']){console[_0x367f45(0x1ae)](_0x367f45(0x1bb));return;}await this['updatePaymentStatus'](_0x5871c9[_0x367f45(0x221)],_0x5871c9['status'],'plisio',_0x480755,undefined,undefined,_0x5871c9['txUrls']),loggerService_1[_0x367f45(0x212)]['logWebhookProcessed']('plisio_gateway',_0x5871c9[_0x367f45(0x221)],_0x367f45(0x1b3),_0x5871c9['status'],_0x480755);}catch(_0x1adc5f){console[_0x367f45(0x1ae)](_0x367f45(0x1c7),_0x1adc5f),loggerService_1[_0x367f45(0x212)][_0x367f45(0x1c5)](_0x367f45(0x1e7),_0x1adc5f,_0x480755);throw _0x1adc5f;}}async['processRapydWebhook'](_0x369106){const _0xf96b25=a55_0x46d460;console[_0xf96b25(0x215)](_0xf96b25(0x1fb),_0x369106);try{const _0x3b8b66=await this['rapydService'][_0xf96b25(0x1d5)](_0x369106);if(!_0x3b8b66[_0xf96b25(0x221)]){console[_0xf96b25(0x1ae)]('No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook');return;}await this[_0xf96b25(0x20e)](_0x3b8b66[_0xf96b25(0x221)],_0x3b8b66[_0xf96b25(0x1e9)],_0xf96b25(0x1f3),_0x369106,_0x3b8b66['failureMessage'],_0x3b8b66['additionalInfo']),loggerService_1['loggerService'][_0xf96b25(0x218)]('rapyd',_0x3b8b66['paymentId'],_0xf96b25(0x1b3),_0x3b8b66[_0xf96b25(0x1e9)],_0x369106);}catch(_0x2f8abf){console[_0xf96b25(0x1ae)](_0xf96b25(0x1b6),_0x2f8abf),loggerService_1[_0xf96b25(0x212)][_0xf96b25(0x1c5)](_0xf96b25(0x1f3),_0x2f8abf,_0x369106);throw _0x2f8abf;}}async[a55_0x46d460(0x233)](_0x24f9db){const _0x13f697=a55_0x46d460;console[_0x13f697(0x215)](_0x13f697(0x1d4),_0x24f9db);try{const _0x16baad=await this[_0x13f697(0x203)][_0x13f697(0x1d5)](_0x24f9db);if(!_0x16baad[_0x13f697(0x221)]){console['error'](_0x13f697(0x202));return;}await this[_0x13f697(0x20e)](_0x16baad[_0x13f697(0x221)],_0x16baad['status'],_0x13f697(0x1fa),_0x24f9db,undefined,_0x16baad[_0x13f697(0x1fe)]),loggerService_1[_0x13f697(0x212)][_0x13f697(0x218)]('noda',_0x16baad[_0x13f697(0x221)],'PENDING',_0x16baad[_0x13f697(0x1e9)],_0x24f9db);}catch(_0x499d47){console[_0x13f697(0x1ae)](_0x13f697(0x206),_0x499d47),loggerService_1[_0x13f697(0x212)][_0x13f697(0x1c5)](_0x13f697(0x1fa),_0x499d47,_0x24f9db);throw _0x499d47;}}async[a55_0x46d460(0x1ea)](_0x3d5e1e){const _0x56052f=a55_0x46d460;console[_0x56052f(0x215)](_0x56052f(0x1e6),_0x3d5e1e);try{const _0x1b386c=await this['coinToPayService']['processWebhook'](_0x3d5e1e);if(!_0x1b386c[_0x56052f(0x221)]){console[_0x56052f(0x1ae)](_0x56052f(0x1ba));return;}await this[_0x56052f(0x20e)](_0x1b386c[_0x56052f(0x221)],_0x1b386c['status'],_0x56052f(0x209),_0x3d5e1e),loggerService_1[_0x56052f(0x212)][_0x56052f(0x218)](_0x56052f(0x209),_0x1b386c[_0x56052f(0x221)],_0x56052f(0x1b3),_0x1b386c[_0x56052f(0x1e9)],_0x3d5e1e);}catch(_0x305fdb){console['error'](_0x56052f(0x1b8),_0x305fdb),loggerService_1[_0x56052f(0x212)]['logWebhookError']('cointopay',_0x305fdb,_0x3d5e1e);throw _0x305fdb;}}async[a55_0x46d460(0x1c6)](_0x18cb9d){const _0x44a166=a55_0x46d460;console[_0x44a166(0x215)](_0x44a166(0x1c8),_0x18cb9d);try{const _0x42e65c=await this[_0x44a166(0x1c4)]['processWebhook'](_0x18cb9d);if(!_0x42e65c[_0x44a166(0x221)]){console[_0x44a166(0x1ae)](_0x44a166(0x207));return;}const _0x3e9954=_0x42e65c[_0x44a166(0x22b)]?'klyme_'+_0x42e65c[_0x44a166(0x22b)][_0x44a166(0x232)]():'klyme_eu';await this['updatePaymentStatus'](_0x42e65c[_0x44a166(0x221)],_0x42e65c[_0x44a166(0x1e9)],_0x3e9954,_0x18cb9d,undefined,_0x42e65c['additionalInfo']),loggerService_1['loggerService'][_0x44a166(0x218)](_0x44a166(0x1bc),_0x42e65c[_0x44a166(0x221)],_0x44a166(0x1b3),_0x42e65c[_0x44a166(0x1e9)],_0x18cb9d);}catch(_0x37dffc){console['error']('Error\x20processing\x20KLYME\x20webhook:',_0x37dffc),loggerService_1[_0x44a166(0x212)][_0x44a166(0x1c5)](_0x44a166(0x1bc),_0x37dffc,_0x18cb9d);throw _0x37dffc;}}async['updatePaymentStatus'](_0x52908f,_0x1e6546,_0x722d09,_0x324a0d,_0x507ed9,_0x371723,_0x2fae06){const _0xc5581f=a55_0x46d460;console[_0xc5581f(0x215)](_0xc5581f(0x1dd)+_0x52908f+'\x20status\x20to\x20'+_0x1e6546+_0xc5581f(0x200)+_0x722d09+_0xc5581f(0x1d7));_0x507ed9&&console[_0xc5581f(0x215)](_0xc5581f(0x217)+_0x52908f+_0xc5581f(0x225)+_0x507ed9);_0x2fae06&&_0x2fae06[_0xc5581f(0x1fd)]>0x0&&console[_0xc5581f(0x215)](_0xc5581f(0x223)+_0x52908f+'\x20transaction\x20URLs:',_0x2fae06);const _0x3d3ab4=await database_1['default'][_0xc5581f(0x1b0)][_0xc5581f(0x20b)]({'where':{'gatewayOrderId':_0x52908f,'gateway':_0x722d09},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3d3ab4){console[_0xc5581f(0x1ae)](_0xc5581f(0x1d1)+_0x52908f+'\x20and\x20gateway:\x20'+_0x722d09);return;}const _0x39bad9=_0x3d3ab4[_0xc5581f(0x1e9)];if(_0x39bad9===_0x1e6546){console['log'](_0xc5581f(0x21f)+_0x3d3ab4['id']+_0xc5581f(0x21c)+_0x1e6546+')');return;}console[_0xc5581f(0x215)](_0xc5581f(0x21f)+_0x3d3ab4['id']+_0xc5581f(0x1cb)+_0x39bad9+_0xc5581f(0x1b4)+_0x1e6546);const _0x4e53cb={'status':_0x1e6546,'updatedAt':new Date()};_0x507ed9&&(_0x4e53cb[_0xc5581f(0x1d6)]=_0x507ed9,console[_0xc5581f(0x215)](_0xc5581f(0x1e0)+_0x507ed9));_0x2fae06&&_0x2fae06['length']>0x0&&(_0x4e53cb['txUrls']=JSON[_0xc5581f(0x1ca)](_0x2fae06),console[_0xc5581f(0x215)](_0xc5581f(0x1cc)+JSON['stringify'](_0x2fae06)));_0x1e6546===_0xc5581f(0x1b2)&&_0x39bad9!==_0xc5581f(0x1b2)&&(_0x4e53cb[_0xc5581f(0x22d)]=new Date());_0x371723&&(_0x371723[_0xc5581f(0x216)]&&(_0x4e53cb['cardLast4']=_0x371723[_0xc5581f(0x216)]),_0x371723[_0xc5581f(0x20c)]&&(_0x4e53cb[_0xc5581f(0x20c)]=_0x371723[_0xc5581f(0x20c)]),_0x371723['bankId']&&(_0x4e53cb[_0xc5581f(0x1b9)]=_0x371723[_0xc5581f(0x1b9)]),_0x371723['remitterIban']&&(_0x4e53cb[_0xc5581f(0x1c2)]=_0x371723[_0xc5581f(0x1c2)]),_0x371723[_0xc5581f(0x1b7)]&&(_0x4e53cb[_0xc5581f(0x1b7)]=_0x371723[_0xc5581f(0x1b7)]));await database_1['default']['payment'][_0xc5581f(0x1f1)]({'where':{'id':_0x3d3ab4['id']},'data':_0x4e53cb});if(_0x1e6546===_0xc5581f(0x1b2)&&_0x39bad9!==_0xc5581f(0x1b2))try{await this[_0xc5581f(0x1f9)][_0xc5581f(0x211)](_0x3d3ab4['id']);}catch(_0x3afea4){console[_0xc5581f(0x1ae)](_0xc5581f(0x1df),_0x3afea4);}await database_1[_0xc5581f(0x1cd)][_0xc5581f(0x204)][_0xc5581f(0x1dc)]({'data':{'paymentId':_0x3d3ab4['id'],'shopId':_0x3d3ab4[_0xc5581f(0x237)],'event':_0x722d09+_0xc5581f(0x1ab)+_0x1e6546[_0xc5581f(0x232)](),'statusCode':0xc8,'responseBody':JSON[_0xc5581f(0x1ca)]({'oldStatus':_0x39bad9,'newStatus':_0x1e6546,'failureMessage':_0x507ed9,'txUrls':_0x2fae06,'webhookData':_0x324a0d})}}),await this[_0xc5581f(0x1ce)](_0x3d3ab4,_0x1e6546),await this[_0xc5581f(0x1eb)](_0x3d3ab4,_0x1e6546),console[_0xc5581f(0x215)](_0xc5581f(0x20f)+_0x3d3ab4['id']+_0xc5581f(0x1e4)+_0x39bad9+_0xc5581f(0x1b4)+_0x1e6546),_0x507ed9&&console['log'](_0xc5581f(0x230)+_0x507ed9),_0x2fae06&&_0x2fae06[_0xc5581f(0x1fd)]>0x0&&console['log'](_0xc5581f(0x1ac)+_0x2fae06[_0xc5581f(0x1fd)]+_0xc5581f(0x22e));}async[a55_0x46d460(0x1ce)](_0x24071c,_0x528193){const _0x4533c2=a55_0x46d460,_0x5196e0=Date['now']();try{const _0x522ad8=_0x24071c[_0x4533c2(0x222)],_0x18181d=_0x522ad8[_0x4533c2(0x20a)];if(!_0x18181d?.['webhookUrl']){console[_0x4533c2(0x215)](_0x4533c2(0x210)+_0x522ad8['id']);return;}const _0x853932=_0x528193===_0x4533c2(0x1b2)?_0x4533c2(0x208):_0x528193==='FAILED'?_0x4533c2(0x1e8):_0x528193===_0x4533c2(0x1e1)?_0x4533c2(0x1e8):'payment.pending';let _0x58259f=[];if(_0x18181d[_0x4533c2(0x1ef)])try{_0x58259f=Array['isArray'](_0x18181d['webhookEvents'])?_0x18181d['webhookEvents']:JSON[_0x4533c2(0x1f0)](_0x18181d[_0x4533c2(0x1ef)]);}catch(_0x178dc8){console['error'](_0x4533c2(0x229),_0x178dc8),_0x58259f=[];}if(!_0x58259f[_0x4533c2(0x1d8)](_0x853932)){console[_0x4533c2(0x215)](_0x4533c2(0x1da)+_0x853932+_0x4533c2(0x226)+_0x522ad8['id']);return;}let _0xc9365c;if(_0x24071c[_0x4533c2(0x1d2)])try{_0xc9365c=JSON[_0x4533c2(0x1f0)](_0x24071c[_0x4533c2(0x1d2)]);}catch(_0x28f8f0){console['error'](_0x4533c2(0x236),_0x28f8f0),_0xc9365c=undefined;}const _0x3bd041={'event':_0x853932,'payment':{'id':_0x24071c['id'],'order_id':_0x24071c[_0x4533c2(0x1cf)],'gateway_order_id':_0x24071c[_0x4533c2(0x1bf)],'gateway':_0x24071c[_0x4533c2(0x213)],'amount':_0x24071c[_0x4533c2(0x1b5)],'currency':_0x24071c[_0x4533c2(0x1a8)],'status':_0x528193['toLowerCase'](),'customer_email':_0x24071c[_0x4533c2(0x1a5)],'customer_name':_0x24071c[_0x4533c2(0x21d)],'failure_message':_0x24071c[_0x4533c2(0x1d6)],'tx_urls':_0xc9365c,'created_at':_0x24071c['createdAt'],'updated_at':new Date()}},_0x1df988=await fetch(_0x18181d[_0x4533c2(0x1ad)],{'method':_0x4533c2(0x219),'headers':{'Content-Type':_0x4533c2(0x1f5),'User-Agent':_0x4533c2(0x1f7)},'body':JSON['stringify'](_0x3bd041)}),_0x4ee3c4=Date[_0x4533c2(0x22c)]()-_0x5196e0,_0x57afe2=_0x1df988['ok']?_0x4533c2(0x1e5):await _0x1df988[_0x4533c2(0x1a9)]();loggerService_1[_0x4533c2(0x212)][_0x4533c2(0x1a6)](_0x24071c[_0x4533c2(0x237)],_0x18181d[_0x4533c2(0x1ad)],_0x853932,_0x1df988[_0x4533c2(0x1e9)],_0x4ee3c4,_0x3bd041),console[_0x4533c2(0x215)]('Shop\x20webhook\x20sent\x20to\x20'+_0x18181d[_0x4533c2(0x1ad)]+'\x20with\x20status\x20'+_0x1df988[_0x4533c2(0x1e9)]+'\x20('+_0x4ee3c4+_0x4533c2(0x1f6));}catch(_0x503340){console[_0x4533c2(0x1ae)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x503340),loggerService_1[_0x4533c2(0x212)][_0x4533c2(0x231)](_0x24071c[_0x4533c2(0x237)],_0x24071c[_0x4533c2(0x222)]?.[_0x4533c2(0x20a)]?.[_0x4533c2(0x1ad)]||_0x4533c2(0x220),_0x4533c2(0x21a),_0x503340,{});}}async['sendPaymentStatusNotification'](_0x2443ea,_0x27166c){const _0x284d15=a55_0x46d460;try{const _0x20ef2e={'PENDING':_0x284d15(0x1d9),'PAID':_0x284d15(0x234),'FAILED':_0x284d15(0x1c9),'EXPIRED':'expired'},_0x5b8b89=_0x20ef2e[_0x27166c];if(!_0x5b8b89||_0x5b8b89===_0x284d15(0x1d9))return;await telegramBotService_1[_0x284d15(0x1ec)]['sendPaymentNotification'](_0x2443ea['shopId'],_0x2443ea,_0x5b8b89);}catch(_0x42dad1){console[_0x284d15(0x1ae)](_0x284d15(0x1db),_0x42dad1);}}}exports[a55_0x46d460(0x224)]=WebhookService;