'use strict';function a69_0x1c58(_0x50b594,_0x196676){const _0x4cc84e=a69_0x4cc8();return a69_0x1c58=function(_0x1c58e5,_0x1bf802){_0x1c58e5=_0x1c58e5-0x91;let _0x2edf9e=_0x4cc84e[_0x1c58e5];return _0x2edf9e;},a69_0x1c58(_0x50b594,_0x196676);}const a69_0xbac6c7=a69_0x1c58;(function(_0x2fce3a,_0x130d94){const _0x43577d=a69_0x1c58,_0x1b6e34=_0x2fce3a();while(!![]){try{const _0x398979=-parseInt(_0x43577d(0x1ae))/0x1*(parseInt(_0x43577d(0xa7))/0x2)+-parseInt(_0x43577d(0x119))/0x3+parseInt(_0x43577d(0xa3))/0x4*(-parseInt(_0x43577d(0x94))/0x5)+parseInt(_0x43577d(0x12c))/0x6*(-parseInt(_0x43577d(0x1a9))/0x7)+parseInt(_0x43577d(0x9c))/0x8+parseInt(_0x43577d(0xbc))/0x9*(parseInt(_0x43577d(0x170))/0xa)+parseInt(_0x43577d(0x187))/0xb;if(_0x398979===_0x130d94)break;else _0x1b6e34['push'](_0x1b6e34['shift']());}catch(_0x38cfa1){_0x1b6e34['push'](_0x1b6e34['shift']());}}}(a69_0x4cc8,0x537dc));var __importDefault=this&&this[a69_0xbac6c7(0xf9)]||function(_0xbffa21){return _0xbffa21&&_0xbffa21['__esModule']?_0xbffa21:{'default':_0xbffa21};};Object['defineProperty'](exports,a69_0xbac6c7(0xb9),{'value':!![]}),exports[a69_0xbac6c7(0x10a)]=void 0x0;const database_1=__importDefault(require(a69_0xbac6c7(0xaa))),plisioService_1=require(a69_0xbac6c7(0xe1)),rapydService_1=require(a69_0xbac6c7(0xb7)),nodaService_1=require(a69_0xbac6c7(0x126)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a69_0xbac6c7(0xc5)),klymeService_1=require(a69_0xbac6c7(0x188)),mastercardService_1=require(a69_0xbac6c7(0xdf)),amerService_1=require(a69_0xbac6c7(0x19e)),ampayService_1=require(a69_0xbac6c7(0x18e)),ampayTRYService_1=require(a69_0xbac6c7(0x1bd)),telegramBotService_1=require(a69_0xbac6c7(0x172)),currencyService_1=require(a69_0xbac6c7(0x150)),loggerService_1=require(a69_0xbac6c7(0xa9));function a69_0x4cc8(){const _0x228dc3=['✅\x20Found\x20payment:\x20ID=','💸\x20CHARGEBACK:\x20Processing\x20penalty-only\x20deduction','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','klyme','16114780ybMucQ','./gateways/klymeService','Found','logShopWebhookError','loggerService','📈\x20Payment\x20details:\x20oldStatus=\x22',',\x20GatewayPaymentId=','./gateways/ampayService','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','payment','create','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','CHARGEBACK','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','VISA','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','EXPIRED','logWebhookProcessed','\x20+\x20','🔄\x20Processing\x20AmPay\x20webhook:','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','Success','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','./gateways/amerService','Payment\x20not\x20found:\x20','💰\x20Final\x20balance\x20after\x20chargeback:\x20','✅\x20Payment\x20link\x20','MASTERCARD','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','🏪\x20Shop\x20','\x20not\x20found','currencyService','86856ghQmfE','📈\x20Found\x20payment\x20link\x20','Found\x20payment\x20','🔄\x20Processing\x20AmPay\x20TRY\x20webhook:',',\x20newStatus=','11UusLwN','DECLINED','processMasterCardWebhook','updatePaymentStatus','📊\x20KLYME\x20webhook:\x20Payment\x20','📊\x20AmPay\x20webhook\x20data:','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','stringify','\x20not\x20enabled\x20for\x20shop\x20','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','\x20for\x20AmPay\x20TRY\x20webhook','Error\x20processing\x20KLYME\x20webhook:','log','🔄\x20Additional\x20data:','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','./gateways/ampayTRYService','No\x20payment\x20ID\x20in\x20VISA\x20webhook','payment.failed','balance','chargebackAmount','shopId','💰\x20Removing\x20from\x20balance:\x20','Payment\x20not\x20found','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','📊\x20Payment\x20status:\x20','PlisioService','cardLast4','gateway','gatewaySettings','settings','amountUSDT','1515590llFBvY','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','amountAfterGatewayCommissionUSDT','🔄\x20Processing\x20CoinToPay2\x20webhook:','application/json','📈\x20Payment\x20','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','visaMasterCardService','43424ALzXRc','plisioService','🔍\x20VISA\x20payment\x20search\x20executed','🔄\x20Processing\x20Plisio\x20webhook:','findMany','convertToUSDT','Payment\x20','4SdnWij','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','visa/mastercard','SINGLE','31978Cuzyfm','🔄\x20MyXSpend\x20status\x20','./loggerService','../config/database',',\x20Status=','additionalInfo','\x20commission:\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook',',\x20Gateway=','keys','🔍\x20Search\x20result:\x20','paymentLinkId','💸\x20CHARGEBACK\x20penalty\x20ONLY:\x20-','\x20=\x20',',\x20gatewayPaymentId:\x20','remitterName','./gateways/rapydService','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','__esModule','\x20for\x20MyXSpend\x20webhook','unknown','9uYiStP','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','\x22,\x20id=\x22','🔄\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','gatewayCommissionRate','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','nodaService','system','📊\x20MyXSpend\x20webhook\x20data:','./gateways/coinToPay2Service','sendShopWebhook','processMyXSpendWebhook','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','webhookLog','PAID','currency','FAILED','\x20(orderId:\x20','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','txUrls','✅\x20Found\x20payment\x20','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','createdAt','processVisaWebhook','\x22,\x20paymentLinkId=\x22','REFUND','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20',',\x20using\x20default\x2010%','No\x20additional\x20info','processAmerWebhook','📊\x20Plisio\x20webhook:\x20Payment\x20','status_addition_info','\x20→\x20','./gateways/mastercardService','webhookEvents','./gateways/plisioService','sendPaymentStatusNotification','map','Error\x20parsing\x20webhook\x20events:','\x20current\x20balance:\x20','\x20status\x20','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','Gateway\x20','ms)','VISA\x20payment\x20not\x20found:\x20','webhook_status_change_','findFirst','❌\x20VISA\x20webhook\x20processing\x20failed:','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','VisaMasterCardService','📊\x20Amer\x20webhook:\x20Payment\x20','rapyd','📝\x20Reason:\x20',',\x20status=','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','getGatewayCommission','🔄\x20Processing\x20KLYME\x20webhook:','now','rapydService','__importDefault','toFixed','\x20commission\x20for\x20shop\x20','Error\x20processing\x20CoinToPay2\x20webhook:','Failed\x20to\x20send\x20shop\x20webhook:','AmerService','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','dateTime','coinToPay2Service','\x20mapped\x20to\x20FAILED','\x20->\x20','💰\x20Converting\x20','ℹ️\x20Decline\x20reason:\x20','🔍\x20VISA\x20payment\x20search\x20result:\x20','created','system_id','logWebhookError','WebhookService','visa','updatedAt','processing','⚠️\x20CHARGEBACK\x20without\x20penalty\x20amount\x20-\x20no\x20balance\x20change','Webhook\x20event\x20','\x20in\x20shop\x20','remitterIban','MasterCard\x20payment\x20not\x20found:\x20','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','webhookUrl','NodaService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paidAt','desc','1879170vYeaJc','default','toUpperCase','ampayService','\x20status\x20updated\x20to\x20FAILED','currentPayments','paymentLink','telegramBotService','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','payment.success','amer','customerOrderId','coinToPayService','./gateways/nodaService','🔄\x20Processing\x20Rapyd\x20webhook:','customerName','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','chargeback','RapydService','96NhsCns','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20',':\x20type=','error','processNodaWebhook','visa_mastercard','Error\x20processing\x20Noda\x20webhook:','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','AmPayTRYService','ampay_try_','mastercard','amount','\x20to\x20','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','\x20USDT\x20(chargeback\x20penalty\x20ONLY)','parse','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','failed','💰\x20Payment\x20','isArray','COMPLETED','payment_method','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20(Status:\x20','$transaction','plisio_gateway','\x22,\x20orderId=\x22','processCoinToPayWebhook','Error\x20processing\x20Rapyd\x20webhook:','type','ampayTRYService','paymentMethod','plisio','klymeService','✅\x20Shop\x20','processWebhook','./currencyService','processAmPayTRYWebhook','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','toLowerCase','gatewayPaymentId','💰\x20Adding\x20to\x20balance:\x20','status','ampay_try','%\x20gateway\x20commission)','username','paymentId','cointopay2','noda','myxspend_','processKlymeWebhook','errorMessage','📊\x20Noda\x20webhook:\x20Payment\x20','findUnique','ℹ️\x20AmPay\x20status\x20','shop','processRapydWebhook','📊\x20AmPay\x20TRY\x20webhook\x20data:','failureMessage','bankId','📊\x20Amer\x20webhook\x20result:','📊\x20CoinToPay\x20webhook:\x20Payment\x20','🔄\x20Processing\x20Noda\x20webhook:','toISOString','🔄\x20Processing\x20CoinToPay\x20webhook:','ℹ️\x20AmPay\x20TRY\x20status\x20','Payment\x20marked\x20as\x20CHARGEBACK\x20(no\x20penalty\x20specified)','1754870CxVFLG','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','./telegramBotService','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','orderId','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20',',\x20Card=****','update','commission','❌\x20Payment\x20link\x20','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','\x20USDT','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','myxspend','gatewayOrderId','📊\x20MasterCard\x20webhook\x20result:','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20',',\x20using\x20default\x20commission\x2010%'];a69_0x4cc8=function(){return _0x228dc3;};return a69_0x4cc8();}class WebhookService{constructor(){const _0x2c0d55=a69_0xbac6c7;this[_0x2c0d55(0x9d)]=new plisioService_1[(_0x2c0d55(0x1c8))](),this[_0x2c0d55(0xf8)]=new rapydService_1[(_0x2c0d55(0x12b))](),this[_0x2c0d55(0xc2)]=new nodaService_1[(_0x2c0d55(0x115))](),this[_0x2c0d55(0x125)]=new coinToPayService_1['CoinToPayService'](),this['coinToPay2Service']=new coinToPay2Service_1['CoinToPay2Service'](),this[_0x2c0d55(0x14d)]=new klymeService_1['KlymeService'](),this['visaMasterCardService']=new mastercardService_1[(_0x2c0d55(0xef))](),this['amerService']=new amerService_1[(_0x2c0d55(0xfe))](),this[_0x2c0d55(0x11c)]=new ampayService_1['AmPayService'](),this[_0x2c0d55(0x14a)]=new ampayTRYService_1[(_0x2c0d55(0x134))]();}async[a69_0xbac6c7(0x1b1)](_0x59f294,_0x16c4f7,_0x58b7ff){const _0x249388=a69_0xbac6c7;console[_0x249388(0x1ba)](_0x249388(0x113)+_0x59f294+_0x249388(0x1ad)+_0x16c4f7),console[_0x249388(0x1ba)](_0x249388(0x1bb),_0x58b7ff),await database_1[_0x249388(0x11a)][_0x249388(0x144)](async _0xf518a1=>{const _0x11b624=_0x249388,_0x1d2552=await _0xf518a1[_0x11b624(0x190)][_0x11b624(0x162)]({'where':{'id':_0x59f294},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1d2552)throw new Error(_0x11b624(0xa2)+_0x59f294+'\x20not\x20found');const _0x421a66=_0x1d2552['status'],_0x12d996=_0x1d2552[_0x11b624(0x164)];console[_0x11b624(0x1ba)](_0x11b624(0x13e)+_0x59f294+':\x20'+_0x421a66+_0x11b624(0x103)+_0x16c4f7),console[_0x11b624(0x1ba)](_0x11b624(0x1a6)+_0x12d996[_0x11b624(0x15a)]+_0x11b624(0xe5)+_0x12d996[_0x11b624(0x1c0)]+_0x11b624(0x17c));const _0x1fa0a9={'status':_0x16c4f7[_0x11b624(0x11b)](),'updatedAt':new Date(),'statusChangedBy':_0x11b624(0xc3),'statusChangedAt':new Date()};_0x58b7ff?.[_0x11b624(0x167)]&&(_0x1fa0a9[_0x11b624(0x167)]=_0x58b7ff[_0x11b624(0x167)]);_0x58b7ff?.['txUrls']&&(_0x1fa0a9[_0x11b624(0xd0)]=JSON[_0x11b624(0x1b5)](_0x58b7ff['txUrls']));_0x58b7ff?.[_0x11b624(0x1c9)]&&(_0x1fa0a9[_0x11b624(0x1c9)]=_0x58b7ff[_0x11b624(0x1c9)]);_0x58b7ff?.['paymentMethod']&&(_0x1fa0a9[_0x11b624(0x14b)]=_0x58b7ff['paymentMethod']);_0x58b7ff?.[_0x11b624(0x168)]&&(_0x1fa0a9[_0x11b624(0x168)]=_0x58b7ff['bankId']);_0x58b7ff?.[_0x11b624(0x111)]&&(_0x1fa0a9[_0x11b624(0x111)]=_0x58b7ff[_0x11b624(0x111)]);_0x58b7ff?.[_0x11b624(0xb6)]&&(_0x1fa0a9[_0x11b624(0xb6)]=_0x58b7ff[_0x11b624(0xb6)]);let _0x476313=_0x12d996[_0x11b624(0x1c0)],_0x23f1e4='';if(_0x16c4f7[_0x11b624(0x11b)]()===_0x11b624(0xcb)&&_0x421a66!=='PAID'){const _0x33a518=await currencyService_1[_0x11b624(0x1a8)][_0x11b624(0xa1)](_0x1d2552[_0x11b624(0x137)],_0x1d2552[_0x11b624(0xcc)]),_0x411196=await this[_0x11b624(0xf5)](_0x12d996['id'],_0x1d2552[_0x11b624(0x1ca)]),_0x205e0c=_0x33a518*(0x1-_0x411196/0x64);_0x476313+=_0x205e0c,_0x23f1e4='+'+_0x205e0c[_0x11b624(0xfa)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20'+_0x411196+_0x11b624(0x159),_0x1fa0a9['amountUSDT']=_0x33a518,_0x1fa0a9[_0x11b624(0x96)]=_0x205e0c,_0x1fa0a9[_0x11b624(0xc0)]=_0x411196,_0x1fa0a9[_0x11b624(0x117)]=new Date(),console[_0x11b624(0x1ba)](_0x11b624(0x104)+_0x1d2552[_0x11b624(0x137)]+'\x20'+_0x1d2552['currency']+_0x11b624(0x103)+_0x33a518[_0x11b624(0xfa)](0x6)+_0x11b624(0x17c)),console[_0x11b624(0x1ba)]('💰\x20Gateway\x20'+_0x1d2552[_0x11b624(0x1ca)]+_0x11b624(0xad)+_0x411196+'%'),console[_0x11b624(0x1ba)]('💰\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x205e0c['toFixed'](0x6)+_0x11b624(0x17c)),console[_0x11b624(0x1ba)](_0x11b624(0x156)+_0x12d996[_0x11b624(0x1c0)]+_0x11b624(0x199)+_0x205e0c['toFixed'](0x6)+'\x20=\x20'+_0x476313[_0x11b624(0xfa)](0x6)+_0x11b624(0x17c));}else{if(_0x421a66===_0x11b624(0xcb)&&_0x16c4f7[_0x11b624(0x11b)]()!=='PAID'&&_0x16c4f7[_0x11b624(0x11b)]()!==_0x11b624(0x193)){let _0x971eb9;if(_0x1d2552['amountAfterGatewayCommissionUSDT'])_0x971eb9=_0x1d2552[_0x11b624(0x96)];else{if(_0x1d2552[_0x11b624(0x93)]){const _0x5e8a80=await this[_0x11b624(0xf5)](_0x12d996['id'],_0x1d2552[_0x11b624(0x1ca)]);_0x971eb9=_0x1d2552[_0x11b624(0x93)]*(0x1-_0x5e8a80/0x64);}else console[_0x11b624(0x1ba)](_0x11b624(0x1c5)),_0x971eb9=0x0;}_0x971eb9>0x0&&(_0x476313-=_0x971eb9,_0x23f1e4='-'+_0x971eb9[_0x11b624(0xfa)](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x1fa0a9[_0x11b624(0x117)]=null,console[_0x11b624(0x1ba)](_0x11b624(0x1c3)+_0x12d996[_0x11b624(0x1c0)]+'\x20-\x20'+_0x971eb9[_0x11b624(0xfa)](0x6)+_0x11b624(0xb4)+_0x476313['toFixed'](0x6)+_0x11b624(0x17c)));}}if(_0x16c4f7[_0x11b624(0x11b)]()===_0x11b624(0x193)){const _0x2bc9fa=_0x58b7ff?.[_0x11b624(0x1c1)]||0x0;console[_0x11b624(0x1ba)](_0x11b624(0x184)),_0x2bc9fa>0x0?(_0x476313-=_0x2bc9fa,_0x23f1e4='-'+_0x2bc9fa[_0x11b624(0xfa)](0x6)+_0x11b624(0x13a),_0x1fa0a9['chargebackAmount']=_0x2bc9fa,console[_0x11b624(0x1ba)](_0x11b624(0xb3)+_0x2bc9fa[_0x11b624(0xfa)](0x6)+'\x20USDT'),console['log']('💰\x20Payment\x20amount\x20is\x20NOT\x20deducted\x20(chargeback\x20penalty\x20only)'),console['log'](_0x11b624(0x1a0)+_0x476313[_0x11b624(0xfa)](0x6)+_0x11b624(0x17c))):(console[_0x11b624(0x1ba)](_0x11b624(0x10e)),_0x23f1e4=_0x11b624(0x16f));}const _0x44dfe2=await _0xf518a1['payment'][_0x11b624(0x178)]({'where':{'id':_0x59f294},'data':_0x1fa0a9});_0x476313!==_0x12d996[_0x11b624(0x1c0)]&&(await _0xf518a1[_0x11b624(0x164)][_0x11b624(0x178)]({'where':{'id':_0x12d996['id']},'data':{'balance':_0x476313}}),console[_0x11b624(0x1ba)](_0x11b624(0x14e)+_0x12d996[_0x11b624(0x15a)]+'\x20balance\x20updated:\x20'+_0x12d996[_0x11b624(0x1c0)][_0x11b624(0xfa)](0x6)+_0x11b624(0x103)+_0x476313[_0x11b624(0xfa)](0x6)+_0x11b624(0x17c)),console['log'](_0x11b624(0xf2)+_0x23f1e4));await _0xf518a1[_0x11b624(0xca)]['create']({'data':{'paymentId':_0x59f294,'shopId':_0x12d996['id'],'event':_0x11b624(0xeb)+_0x16c4f7[_0x11b624(0x154)](),'statusCode':0xc8,'responseBody':JSON[_0x11b624(0x1b5)]({'oldStatus':_0x421a66,'newStatus':_0x16c4f7[_0x11b624(0x11b)](),'balanceChange':_0x23f1e4||'no\x20balance\x20change','oldBalance':_0x12d996['balance'],'newBalance':_0x476313,'amountUSDT':_0x1fa0a9['amountUSDT'],'additionalData':_0x58b7ff,'timestamp':new Date()[_0x11b624(0x16c)]()})}}),await this[_0x11b624(0xc6)]({..._0x1d2552,..._0x44dfe2,'shop':_0x12d996},_0x16c4f7[_0x11b624(0x11b)]()),await this[_0x11b624(0xe2)]({..._0x1d2552,..._0x44dfe2},_0x16c4f7[_0x11b624(0x11b)]());if(_0x421a66!==_0x11b624(0xcb)&&_0x16c4f7[_0x11b624(0x11b)]()===_0x11b624(0xcb)){console['log']('📈\x20Payment\x20'+_0x59f294+_0x11b624(0x174)),console['log'](_0x11b624(0x18c)+_0x421a66+'\x22,\x20newStatus=\x22'+_0x16c4f7['toUpperCase']()+_0x11b624(0xd5)+_0x1d2552[_0x11b624(0xb2)]+'\x22');if(_0x1d2552[_0x11b624(0xb2)])try{const _0x88fd61=await _0xf518a1[_0x11b624(0x11f)][_0x11b624(0x162)]({'where':{'id':_0x1d2552[_0x11b624(0xb2)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x88fd61){console[_0x11b624(0x1ba)](_0x11b624(0x1aa)+_0x88fd61['id']+_0x11b624(0x12e)+_0x88fd61[_0x11b624(0x149)]+',\x20currentPayments='+_0x88fd61[_0x11b624(0x11e)]+_0x11b624(0xf3)+_0x88fd61[_0x11b624(0x157)]);const _0x6e46fc=_0x88fd61['currentPayments']+0x1,_0x28b15e=_0x88fd61[_0x11b624(0x149)]===_0x11b624(0xa6)?_0x11b624(0x140):_0x88fd61[_0x11b624(0x157)];await _0xf518a1[_0x11b624(0x11f)][_0x11b624(0x178)]({'where':{'id':_0x1d2552[_0x11b624(0xb2)]},'data':{'currentPayments':_0x6e46fc,'status':_0x28b15e,'updatedAt':new Date()}}),console[_0x11b624(0x1ba)](_0x11b624(0x1a1)+_0x88fd61['id']+'\x20updated:\x20currentPayments='+_0x88fd61[_0x11b624(0x11e)]+_0x11b624(0x103)+_0x6e46fc+',\x20status='+_0x88fd61['status']+_0x11b624(0x103)+_0x28b15e);}else console[_0x11b624(0x1ba)](_0x11b624(0x17a)+_0x1d2552[_0x11b624(0xb2)]+_0x11b624(0x1a7));}catch(_0x2b7416){console['error'](_0x11b624(0xf4),_0x2b7416);}else console['log']('📈\x20Payment\x20'+_0x59f294+_0x11b624(0x17d));}else console[_0x11b624(0x1ba)](_0x11b624(0x99)+_0x59f294+_0x11b624(0xd8)+_0x421a66+_0x11b624(0x103)+_0x16c4f7[_0x11b624(0x11b)]());});}async['processPlisioWebhook'](_0x12e393){const _0x4b1a92=a69_0xbac6c7;console[_0x4b1a92(0x1ba)](_0x4b1a92(0x9f),_0x12e393);try{const _0x4705df=await this['plisioService'][_0x4b1a92(0x14f)](_0x12e393);if(!_0x4705df['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x234760=await database_1[_0x4b1a92(0x11a)][_0x4b1a92(0x190)][_0x4b1a92(0xec)]({'where':{'gatewayOrderId':_0x4705df[_0x4b1a92(0x15b)]}});if(!_0x234760){console[_0x4b1a92(0x12f)](_0x4b1a92(0x18f)+_0x4705df['paymentId']);return;}console['log'](_0x4b1a92(0xdc)+_0x234760['id']+_0x4b1a92(0xe6)+_0x4705df['status']),await this['updatePaymentStatus'](_0x234760['id'],_0x4705df[_0x4b1a92(0x157)],{'txUrls':_0x4705df['txUrls']}),loggerService_1[_0x4b1a92(0x18b)][_0x4b1a92(0x198)](_0x4b1a92(0x14c),_0x234760['id'],_0x234760[_0x4b1a92(0x157)],_0x4705df[_0x4b1a92(0x157)],_0x12e393);}catch(_0xd1b603){console['error']('Error\x20processing\x20Plisio\x20webhook:',_0xd1b603),loggerService_1['loggerService'][_0x4b1a92(0x109)](_0x4b1a92(0x14c),_0xd1b603,_0x12e393);throw _0xd1b603;}}async['processPlisioGatewayWebhook'](_0x17093b){const _0x5df29e=a69_0xbac6c7;console[_0x5df29e(0x1ba)]('🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:',_0x17093b);try{const _0x54409f=await this[_0x5df29e(0x9d)][_0x5df29e(0x14f)](_0x17093b);if(!_0x54409f['paymentId'])throw new Error(_0x5df29e(0xff));const _0x17a120=await database_1[_0x5df29e(0x11a)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x54409f[_0x5df29e(0x15b)]}});if(!_0x17a120){console[_0x5df29e(0x12f)]('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x54409f['paymentId']);return;}console[_0x5df29e(0x1ba)](_0x5df29e(0x194)+_0x17a120['id']+_0x5df29e(0xe6)+_0x54409f['status']),await this[_0x5df29e(0x1b1)](_0x17a120['id'],_0x54409f[_0x5df29e(0x157)],{'txUrls':_0x54409f['txUrls']}),loggerService_1[_0x5df29e(0x18b)][_0x5df29e(0x198)](_0x5df29e(0x145),_0x17a120['id'],_0x17a120[_0x5df29e(0x157)],_0x54409f[_0x5df29e(0x157)],_0x17093b);}catch(_0x495833){console[_0x5df29e(0x12f)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x495833),loggerService_1['loggerService'][_0x5df29e(0x109)]('plisio_gateway',_0x495833,_0x17093b);throw _0x495833;}}async[a69_0xbac6c7(0x165)](_0x1158e3){const _0x428313=a69_0xbac6c7;console['log'](_0x428313(0x127),_0x1158e3);try{const _0x225e52=await this[_0x428313(0xf8)]['processWebhook'](_0x1158e3);if(!_0x225e52[_0x428313(0x15b)])throw new Error(_0x428313(0x121));const _0x59dc41=await database_1['default'][_0x428313(0x190)]['findFirst']({'where':{'gatewayOrderId':_0x225e52['paymentId']}});if(!_0x59dc41){console[_0x428313(0x12f)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x225e52['paymentId']);return;}console[_0x428313(0x1ba)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x59dc41['id']+_0x428313(0xe6)+_0x225e52['status']),await this[_0x428313(0x1b1)](_0x59dc41['id'],_0x225e52[_0x428313(0x157)],{'failureMessage':_0x225e52[_0x428313(0x167)],'cardLast4':_0x225e52['additionalInfo']?.['cardLast4'],'paymentMethod':_0x225e52[_0x428313(0xac)]?.[_0x428313(0x14b)]}),loggerService_1[_0x428313(0x18b)][_0x428313(0x198)](_0x428313(0xf1),_0x59dc41['id'],_0x59dc41['status'],_0x225e52['status'],_0x1158e3);}catch(_0x45849c){console['error'](_0x428313(0x148),_0x45849c),loggerService_1[_0x428313(0x18b)][_0x428313(0x109)]('rapyd',_0x45849c,_0x1158e3);throw _0x45849c;}}async[a69_0xbac6c7(0x130)](_0x212b90){const _0x376de9=a69_0xbac6c7;console[_0x376de9(0x1ba)](_0x376de9(0x16b),_0x212b90);try{const _0x24e870=await this[_0x376de9(0xc2)][_0x376de9(0x14f)](_0x212b90);if(!_0x24e870[_0x376de9(0x15b)])throw new Error(_0x376de9(0xae));const _0x4db297=await database_1[_0x376de9(0x11a)][_0x376de9(0x190)]['findFirst']({'where':{'gatewayOrderId':_0x24e870[_0x376de9(0x15b)]}});if(!_0x4db297){console[_0x376de9(0x12f)]('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x24e870[_0x376de9(0x15b)]);return;}console['log'](_0x376de9(0x161)+_0x4db297['id']+_0x376de9(0xe6)+_0x24e870['status']),await this[_0x376de9(0x1b1)](_0x4db297['id'],_0x24e870['status'],{'bankId':_0x24e870['additionalInfo']?.['bankId'],'remitterIban':_0x24e870['additionalInfo']?.[_0x376de9(0x111)],'remitterName':_0x24e870[_0x376de9(0xac)]?.[_0x376de9(0xb6)]}),loggerService_1['loggerService'][_0x376de9(0x198)](_0x376de9(0x15d),_0x4db297['id'],_0x4db297[_0x376de9(0x157)],_0x24e870[_0x376de9(0x157)],_0x212b90);}catch(_0x4d49ef){console['error'](_0x376de9(0x132),_0x4d49ef),loggerService_1[_0x376de9(0x18b)][_0x376de9(0x109)](_0x376de9(0x15d),_0x4d49ef,_0x212b90);throw _0x4d49ef;}}async[a69_0xbac6c7(0x147)](_0x95a292){const _0x443fd9=a69_0xbac6c7;console[_0x443fd9(0x1ba)](_0x443fd9(0x16d),_0x95a292);try{const _0x1d7eea=await this[_0x443fd9(0x125)][_0x443fd9(0x14f)](_0x95a292);if(!_0x1d7eea['paymentId'])throw new Error(_0x443fd9(0x17b));const _0x20ee9f=await database_1[_0x443fd9(0x11a)]['payment'][_0x443fd9(0xec)]({'where':{'gatewayOrderId':_0x1d7eea[_0x443fd9(0x15b)]}});if(!_0x20ee9f){console[_0x443fd9(0x12f)](_0x443fd9(0xd2)+_0x1d7eea['paymentId']);return;}console[_0x443fd9(0x1ba)](_0x443fd9(0x16a)+_0x20ee9f['id']+'\x20status\x20'+_0x1d7eea['status']),await this[_0x443fd9(0x1b1)](_0x20ee9f['id'],_0x1d7eea[_0x443fd9(0x157)]),loggerService_1[_0x443fd9(0x18b)][_0x443fd9(0x198)]('cointopay',_0x20ee9f['id'],_0x20ee9f[_0x443fd9(0x157)],_0x1d7eea['status'],_0x95a292);}catch(_0x541b83){console['error']('Error\x20processing\x20CoinToPay\x20webhook:',_0x541b83),loggerService_1[_0x443fd9(0x18b)][_0x443fd9(0x109)]('cointopay',_0x541b83,_0x95a292);throw _0x541b83;}}async['processCoinToPay2Webhook'](_0x575259){const _0x2c471a=a69_0xbac6c7;console['log'](_0x2c471a(0x97),_0x575259);try{const _0x5e0154=await this[_0x2c471a(0x101)][_0x2c471a(0x14f)](_0x575259);if(!_0x5e0154['paymentId'])throw new Error(_0x2c471a(0x192));const _0x3792e7=await database_1[_0x2c471a(0x11a)][_0x2c471a(0x190)][_0x2c471a(0xec)]({'where':{'gatewayOrderId':_0x5e0154[_0x2c471a(0x15b)]}});if(!_0x3792e7){console[_0x2c471a(0x12f)](_0x2c471a(0xe7)+_0x5e0154[_0x2c471a(0x15b)]);return;}console[_0x2c471a(0x1ba)](_0x2c471a(0xc1)+_0x3792e7['id']+_0x2c471a(0xe6)+_0x5e0154[_0x2c471a(0x157)]),await this[_0x2c471a(0x1b1)](_0x3792e7['id'],_0x5e0154[_0x2c471a(0x157)]),loggerService_1['loggerService'][_0x2c471a(0x198)](_0x2c471a(0x15c),_0x3792e7['id'],_0x3792e7[_0x2c471a(0x157)],_0x5e0154[_0x2c471a(0x157)],_0x575259);}catch(_0x1dd1ca){console[_0x2c471a(0x12f)](_0x2c471a(0xfc),_0x1dd1ca),loggerService_1[_0x2c471a(0x18b)][_0x2c471a(0x109)](_0x2c471a(0x15c),_0x1dd1ca,_0x575259);throw _0x1dd1ca;}}async[a69_0xbac6c7(0x15f)](_0x5cb2a6){const _0x44860f=a69_0xbac6c7;console[_0x44860f(0x1ba)](_0x44860f(0xf6),_0x5cb2a6);try{const _0x2f98d7=await this[_0x44860f(0x14d)][_0x44860f(0x14f)](_0x5cb2a6);if(!_0x2f98d7[_0x44860f(0x15b)])throw new Error(_0x44860f(0x9a));const _0x5b5fd9=await database_1[_0x44860f(0x11a)][_0x44860f(0x190)][_0x44860f(0xec)]({'where':{'gatewayOrderId':_0x2f98d7[_0x44860f(0x15b)]}});if(!_0x5b5fd9){console['error'](_0x44860f(0x185)+_0x2f98d7[_0x44860f(0x15b)]);return;}console['log'](_0x44860f(0x1b2)+_0x5b5fd9['id']+_0x44860f(0xe6)+_0x2f98d7[_0x44860f(0x157)]),await this[_0x44860f(0x1b1)](_0x5b5fd9['id'],_0x2f98d7[_0x44860f(0x157)],{'paymentMethod':_0x2f98d7[_0x44860f(0xac)]?.[_0x44860f(0x141)]}),loggerService_1[_0x44860f(0x18b)][_0x44860f(0x198)](_0x44860f(0x186),_0x5b5fd9['id'],_0x5b5fd9[_0x44860f(0x157)],_0x2f98d7[_0x44860f(0x157)],_0x5cb2a6);}catch(_0x4044d4){console[_0x44860f(0x12f)](_0x44860f(0x1b9),_0x4044d4),loggerService_1[_0x44860f(0x18b)]['logWebhookError'](_0x44860f(0x186),_0x4044d4,_0x5cb2a6);throw _0x4044d4;}}async[a69_0xbac6c7(0xd4)](_0xaa243c){const _0x5a70db=a69_0xbac6c7;console[_0x5a70db(0x1ba)]('🔄\x20Processing\x20VISA\x20webhook:',JSON[_0x5a70db(0x1b5)](_0xaa243c,null,0x2));try{const _0xebe021=await this[_0x5a70db(0x9b)]['processWebhook'](_0xaa243c,_0x5a70db(0x195));console[_0x5a70db(0x1ba)]('📊\x20VISA\x20webhook\x20result:',_0xebe021);if(!_0xebe021['paymentId']){console[_0x5a70db(0x12f)](_0x5a70db(0x1bc)),console['error']('❌\x20Available\x20webhook\x20fields:',Object['keys'](_0xaa243c));throw new Error(_0x5a70db(0x1be));}let _0x1d2558=null;console[_0x5a70db(0x1ba)](_0x5a70db(0x95)+_0xebe021[_0x5a70db(0x15b)]);if(_0xebe021[_0x5a70db(0x15b)]){console[_0x5a70db(0x1ba)](_0x5a70db(0xcf)),console[_0x5a70db(0x1ba)]('🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:'),console['log'](_0x5a70db(0x153)),console[_0x5a70db(0x1ba)](_0x5a70db(0x139)+_0xebe021['paymentId']),console[_0x5a70db(0x1ba)]('\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId'),_0x1d2558=await database_1['default']['payment'][_0x5a70db(0xec)]({'where':{'AND':[{'OR':[{'gateway':_0x5a70db(0xa5)},{'gateway':_0x5a70db(0x136)}]},{'OR':[{'gatewayPaymentId':_0xebe021[_0x5a70db(0x15b)]},{'gatewayOrderId':_0xebe021['paymentId']},{'id':_0xebe021[_0x5a70db(0x15b)]},{'orderId':_0xebe021[_0x5a70db(0x15b)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x5a70db(0x1ba)](_0x5a70db(0x9e));if(_0x1d2558)console[_0x5a70db(0x1ba)](_0x5a70db(0x183)+_0x1d2558['id']+',\x20GatewayOrderId='+_0x1d2558[_0x5a70db(0x17f)]+_0x5a70db(0x18d)+_0x1d2558['gatewayPaymentId']);else{console['log']('❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...');const _0x5c3da8=await database_1['default'][_0x5a70db(0x190)]['findMany']({'where':{'gateway':_0x5a70db(0xa5)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x5a70db(0x118)}});console[_0x5a70db(0x1ba)]('🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:',_0x5c3da8[_0x5a70db(0xe3)](_0x541960=>_0x541960['id']+_0x5a70db(0xce)+_0x541960[_0x5a70db(0x175)]+',\x20gatewayOrderId:\x20'+_0x541960[_0x5a70db(0x17f)]+_0x5a70db(0xb5)+_0x541960[_0x5a70db(0x155)]+',\x20card:\x20****'+_0x541960['cardLast4']+')'));}console[_0x5a70db(0x1ba)](_0x5a70db(0x106)+(_0x1d2558?_0x5a70db(0x189):'Not\x20found')),_0x1d2558&&console[_0x5a70db(0x1ba)]('🔍\x20Found\x20VISA\x20payment:\x20ID='+_0x1d2558['id']+_0x5a70db(0xaf)+_0x1d2558[_0x5a70db(0x1ca)]+_0x5a70db(0xab)+_0x1d2558['status']+_0x5a70db(0x177)+_0x1d2558[_0x5a70db(0x1c9)]);}if(!_0x1d2558){console[_0x5a70db(0x12f)]('❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20'+_0xebe021['paymentId']),loggerService_1[_0x5a70db(0x18b)][_0x5a70db(0x109)](_0x5a70db(0x10b),new Error('Payment\x20not\x20found:\x20'+_0xebe021[_0x5a70db(0x15b)]),_0xaa243c);throw new Error(_0x5a70db(0xea)+_0xebe021['paymentId']);}console[_0x5a70db(0x1ba)]('📊\x20VISA\x20payment\x20found:\x20'+_0x1d2558['id']+_0x5a70db(0x143)+_0x1d2558[_0x5a70db(0x157)]+'\x20→\x20'+_0xebe021['status']+')');const _0x4cebbc={};_0xebe021[_0x5a70db(0x137)]&&await database_1[_0x5a70db(0x11a)][_0x5a70db(0x190)]['update']({'where':{'id':_0x1d2558['id']},'data':{'amount':_0xebe021[_0x5a70db(0x137)],'updatedAt':new Date()}}),_0xebe021[_0x5a70db(0xcc)]&&await database_1[_0x5a70db(0x11a)][_0x5a70db(0x190)][_0x5a70db(0x178)]({'where':{'id':_0x1d2558['id']},'data':{'currency':_0xebe021[_0x5a70db(0xcc)],'updatedAt':new Date()}}),_0xebe021[_0x5a70db(0x157)]===_0x5a70db(0xcd)&&_0xebe021[_0x5a70db(0x160)]&&(_0x4cebbc[_0x5a70db(0x167)]=_0xebe021[_0x5a70db(0x160)],console[_0x5a70db(0x1ba)](_0x5a70db(0x12d)+_0xebe021[_0x5a70db(0x160)])),_0x4cebbc[_0x5a70db(0x14b)]=_0x5a70db(0x10b),await this[_0x5a70db(0x1b1)](_0x1d2558['id'],_0xebe021[_0x5a70db(0x157)],_0x4cebbc),await database_1[_0x5a70db(0x11a)][_0x5a70db(0xca)][_0x5a70db(0x191)]({'data':{'paymentId':_0x1d2558['id'],'shopId':_0x1d2558[_0x5a70db(0x1c2)],'event':'visa_'+_0xebe021[_0x5a70db(0x157)][_0x5a70db(0x154)](),'statusCode':0xc8,'responseBody':JSON[_0x5a70db(0x1b5)](_0xebe021)}}),await this[_0x5a70db(0xe2)](_0x1d2558,_0xebe021[_0x5a70db(0x157)][_0x5a70db(0x11b)]()),console[_0x5a70db(0x1ba)](_0x5a70db(0x13c)+_0x1d2558['id']);}catch(_0xbe97e){console[_0x5a70db(0x12f)](_0x5a70db(0xed),_0xbe97e),loggerService_1[_0x5a70db(0x18b)]['logWebhookError']('visa',_0xbe97e,_0xaa243c);throw _0xbe97e;}}async[a69_0xbac6c7(0x1b0)](_0x123b41){const _0xcee41a=a69_0xbac6c7;console[_0xcee41a(0x1ba)]('🔄\x20Processing\x20MasterCard\x20webhook:',JSON[_0xcee41a(0x1b5)](_0x123b41,null,0x2));try{const _0x2a9d7e=await this[_0xcee41a(0x9b)][_0xcee41a(0x14f)](_0x123b41,_0xcee41a(0x1a2));console[_0xcee41a(0x1ba)](_0xcee41a(0x180),_0x2a9d7e);if(!_0x2a9d7e[_0xcee41a(0x15b)]){console[_0xcee41a(0x12f)](_0xcee41a(0xc9)),console[_0xcee41a(0x12f)]('❌\x20Available\x20webhook\x20fields:',Object[_0xcee41a(0xb0)](_0x123b41));throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');}let _0x127d65=null;console[_0xcee41a(0x1ba)](_0xcee41a(0x142)+_0x2a9d7e['paymentId']);_0x2a9d7e[_0xcee41a(0x15b)]&&(console[_0xcee41a(0x1ba)](_0xcee41a(0xee)),_0x127d65=await database_1[_0xcee41a(0x11a)]['payment'][_0xcee41a(0xec)]({'where':{'AND':[{'OR':[{'gateway':_0xcee41a(0x131)},{'gateway':_0xcee41a(0x136)},{'gateway':'visa/mastercard'}]},{'OR':[{'gatewayPaymentId':_0x2a9d7e['paymentId']},{'gatewayOrderId':_0x2a9d7e[_0xcee41a(0x15b)]},{'id':_0x2a9d7e[_0xcee41a(0x15b)]},{'orderId':_0x2a9d7e[_0xcee41a(0x15b)]}]}]}}),console[_0xcee41a(0x1ba)](_0xcee41a(0xb1)+(_0x127d65?_0xcee41a(0x1ab)+_0x127d65['id']:_0xcee41a(0x1c4))));if(!_0x127d65){console[_0xcee41a(0x12f)](_0xcee41a(0x19b)+_0x2a9d7e[_0xcee41a(0x15b)]),console['error'](_0xcee41a(0x133)+_0x2a9d7e[_0xcee41a(0x15b)]+_0xcee41a(0xbe)+_0x2a9d7e[_0xcee41a(0x15b)]+_0xcee41a(0x146)+_0x2a9d7e[_0xcee41a(0x15b)]+'\x22');const _0xbaf683=await database_1[_0xcee41a(0x11a)][_0xcee41a(0x190)][_0xcee41a(0xa0)]({'where':{'OR':[{'gateway':'mastercard'},{'gateway':_0xcee41a(0x131)},{'gateway':_0xcee41a(0xa5)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':'desc'},'take':0xf});console[_0xcee41a(0x1ba)](_0xcee41a(0xa4),_0xbaf683),loggerService_1[_0xcee41a(0x18b)]['logWebhookError'](_0xcee41a(0x136),new Error('Payment\x20not\x20found:\x20'+_0x2a9d7e[_0xcee41a(0x15b)]),_0x123b41);throw new Error(_0xcee41a(0x112)+_0x2a9d7e['paymentId']);}console[_0xcee41a(0x1ba)]('✅\x20Found\x20payment\x20'+_0x127d65['id']+_0xcee41a(0xd7)+_0x127d65[_0xcee41a(0x157)]+_0xcee41a(0x138)+_0x2a9d7e[_0xcee41a(0x157)]);const _0x287db2={};_0x2a9d7e[_0xcee41a(0x137)]&&await database_1[_0xcee41a(0x11a)][_0xcee41a(0x190)][_0xcee41a(0x178)]({'where':{'id':_0x127d65['id']},'data':{'amount':_0x2a9d7e[_0xcee41a(0x137)],'updatedAt':new Date()}}),_0x2a9d7e[_0xcee41a(0xcc)]&&await database_1['default'][_0xcee41a(0x190)]['update']({'where':{'id':_0x127d65['id']},'data':{'currency':_0x2a9d7e[_0xcee41a(0xcc)],'updatedAt':new Date()}}),_0x2a9d7e[_0xcee41a(0x157)]===_0xcee41a(0xcd)&&_0x2a9d7e[_0xcee41a(0x160)]&&(_0x287db2[_0xcee41a(0x167)]=_0x2a9d7e[_0xcee41a(0x160)],console[_0xcee41a(0x1ba)](_0xcee41a(0x176)+_0x2a9d7e[_0xcee41a(0x160)])),_0x287db2['paymentMethod']=_0xcee41a(0x136),await this['updatePaymentStatus'](_0x127d65['id'],_0x2a9d7e[_0xcee41a(0x157)],_0x287db2),loggerService_1['loggerService'][_0xcee41a(0x198)](_0xcee41a(0x136),_0x127d65['id'],_0x127d65['status'],_0x2a9d7e['status'],_0x123b41);}catch(_0x1468f2){console[_0xcee41a(0x12f)]('❌\x20Error\x20processing\x20MasterCard\x20webhook:',_0x1468f2),loggerService_1[_0xcee41a(0x18b)]['logWebhookError']('mastercard',_0x1468f2,_0x123b41);throw _0x1468f2;}}async[a69_0xbac6c7(0xdb)](_0xe4eb68){const _0x38dc41=a69_0xbac6c7;console['log']('🔄\x20Processing\x20Amer\x20webhook:',JSON[_0x38dc41(0x1b5)](_0xe4eb68,null,0x2));try{const _0x1bfcb3=await this['amerService'][_0x38dc41(0x14f)](_0xe4eb68);console[_0x38dc41(0x1ba)](_0x38dc41(0x169),_0x1bfcb3);if(!_0x1bfcb3[_0x38dc41(0x15b)]){console['error'](_0x38dc41(0x173)),console[_0x38dc41(0x12f)]('❌\x20Available\x20webhook\x20fields:',Object['keys'](_0xe4eb68));throw new Error('No\x20payment\x20ID\x20in\x20Amer\x20webhook');}let _0xcd8a6b=null;console[_0x38dc41(0x1ba)](_0x38dc41(0x152)+_0x1bfcb3[_0x38dc41(0x15b)]),_0xcd8a6b=await database_1[_0x38dc41(0x11a)]['payment'][_0x38dc41(0xec)]({'where':{'AND':[{'gateway':_0x38dc41(0x123)},{'OR':[{'gatewayPaymentId':_0x1bfcb3['paymentId']},{'gatewayOrderId':_0x1bfcb3[_0x38dc41(0x15b)]},{'id':_0x1bfcb3['paymentId']},{'orderId':_0x1bfcb3[_0x38dc41(0x15b)]}]}]}}),console['log']('🔍\x20Search\x20result:\x20'+(_0xcd8a6b?'Found\x20payment\x20'+_0xcd8a6b['id']:'Payment\x20not\x20found'));if(!_0xcd8a6b){console[_0x38dc41(0x12f)](_0x38dc41(0x181)+_0x1bfcb3[_0x38dc41(0x15b)]);return;}console['log'](_0x38dc41(0xf0)+_0xcd8a6b['id']+_0x38dc41(0xe6)+_0x1bfcb3['status']),await this[_0x38dc41(0x1b1)](_0xcd8a6b['id'],_0x1bfcb3[_0x38dc41(0x157)],{'cardLast4':_0x1bfcb3[_0x38dc41(0xac)]?.['cardLast4'],'paymentMethod':_0x1bfcb3[_0x38dc41(0xac)]?.['paymentMethod']});}catch(_0x45bf9e){console[_0x38dc41(0x12f)]('❌\x20Error\x20processing\x20Amer\x20webhook:',_0x45bf9e),loggerService_1[_0x38dc41(0x18b)]['logWebhookError'](_0x38dc41(0x123),_0x45bf9e,_0xe4eb68);throw _0x45bf9e;}}async['processAmPayWebhook'](_0x3b254a){const _0xd8a6dd=a69_0xbac6c7;console[_0xd8a6dd(0x1ba)](_0xd8a6dd(0x19a),JSON[_0xd8a6dd(0x1b5)](_0x3b254a,null,0x2));try{const _0xf13f0d=_0x3b254a[_0xd8a6dd(0x157)],_0x2fcf07=_0x3b254a['client_transaction_id'],_0x327316=_0x3b254a['system_id'],_0x3082f7=_0x3b254a[_0xd8a6dd(0x141)],_0x1fd348=_0x3b254a[_0xd8a6dd(0x137)],_0x2a7c17=_0x3b254a[_0xd8a6dd(0xcc)],_0x57f989=_0x3b254a[_0xd8a6dd(0x179)],_0x55ce3b=_0x3b254a[_0xd8a6dd(0xdd)];if(!_0x2fcf07){console[_0xd8a6dd(0x12f)](_0xd8a6dd(0x171));throw new Error('Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook');}console[_0xd8a6dd(0x1ba)](_0xd8a6dd(0x1b3),{'status':_0xf13f0d,'clientTransactionId':_0x2fcf07,'systemId':_0x327316,'paymentMethod':_0x3082f7,'amount':_0x1fd348,'currency':_0x2a7c17,'commission':_0x57f989,'statusAdditionInfo':_0x55ce3b});const _0x279a94=await database_1[_0xd8a6dd(0x11a)][_0xd8a6dd(0x190)][_0xd8a6dd(0xec)]({'where':{'OR':[{'gatewayOrderId':_0x2fcf07},{'orderId':_0x2fcf07},{'id':_0x2fcf07},{'gatewayPaymentId':_0x2fcf07}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x279a94){console[_0xd8a6dd(0x12f)]('❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20'+_0x2fcf07);throw new Error(_0xd8a6dd(0x19f)+_0x2fcf07);}console[_0xd8a6dd(0x1ba)]('✅\x20Found\x20payment\x20'+_0x279a94['id']+'\x20for\x20AmPay\x20webhook'),console[_0xd8a6dd(0x1ba)](_0xd8a6dd(0x1c7)+_0x279a94[_0xd8a6dd(0x157)]+_0xd8a6dd(0xde)+_0xf13f0d),_0xf13f0d===_0xd8a6dd(0x1af)?(console[_0xd8a6dd(0x1ba)](_0xd8a6dd(0xc8)),await this[_0xd8a6dd(0x1b1)](_0x279a94['id'],_0xd8a6dd(0xcd)),console[_0xd8a6dd(0x1ba)]('✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20'+_0x279a94['id']+_0xd8a6dd(0x11d)),console[_0xd8a6dd(0x1ba)](_0xd8a6dd(0x105)+(_0x55ce3b||_0xd8a6dd(0xda)))):console[_0xd8a6dd(0x1ba)](_0xd8a6dd(0x163)+_0xf13f0d+_0xd8a6dd(0x1a3)),await database_1[_0xd8a6dd(0x11a)][_0xd8a6dd(0xca)][_0xd8a6dd(0x191)]({'data':{'paymentId':_0x279a94['id'],'shopId':_0x279a94[_0xd8a6dd(0x1c2)],'event':'ampay_'+(_0xf13f0d?.[_0xd8a6dd(0x154)]()||_0xd8a6dd(0xbb)),'statusCode':0xc8,'responseBody':JSON[_0xd8a6dd(0x1b5)](_0x3b254a)}}),loggerService_1[_0xd8a6dd(0x18b)][_0xd8a6dd(0x198)]('ampay',_0x279a94['id'],_0x279a94['status'],_0xf13f0d==='DECLINED'?_0xd8a6dd(0xcd):_0xf13f0d,_0x3b254a);}catch(_0x3b59de){console[_0xd8a6dd(0x12f)]('❌\x20Error\x20processing\x20AmPay\x20webhook:',_0x3b59de),loggerService_1[_0xd8a6dd(0x18b)][_0xd8a6dd(0x109)]('ampay',_0x3b59de,_0x3b254a);throw _0x3b59de;}}async[a69_0xbac6c7(0x151)](_0x47a2e7){const _0x17a846=a69_0xbac6c7;console[_0x17a846(0x1ba)](_0x17a846(0x1ac),JSON['stringify'](_0x47a2e7,null,0x2));try{const _0x4e111c=_0x47a2e7[_0x17a846(0x157)],_0x44f415=_0x47a2e7['client_transaction_id'],_0x210ab0=_0x47a2e7[_0x17a846(0x108)],_0x20cdae=_0x47a2e7['payment_method'],_0x20d36c=_0x47a2e7[_0x17a846(0x137)],_0x390c6d=_0x47a2e7[_0x17a846(0xcc)],_0x515e0b=_0x47a2e7['commission'],_0x2281a0=_0x47a2e7[_0x17a846(0xdd)];if(!_0x44f415){console[_0x17a846(0x12f)]('❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook');throw new Error(_0x17a846(0x1b7));}console[_0x17a846(0x1ba)](_0x17a846(0x166),{'status':_0x4e111c,'clientTransactionId':_0x44f415,'systemId':_0x210ab0,'paymentMethod':_0x20cdae,'amount':_0x20d36c,'currency':_0x390c6d,'commission':_0x515e0b,'statusAdditionInfo':_0x2281a0});const _0x1eae84=await database_1[_0x17a846(0x11a)]['payment'][_0x17a846(0xec)]({'where':{'OR':[{'gatewayOrderId':_0x44f415},{'orderId':_0x44f415},{'id':_0x44f415},{'gatewayPaymentId':_0x44f415}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1eae84){console[_0x17a846(0x12f)]('❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20'+_0x44f415);throw new Error('Payment\x20not\x20found:\x20'+_0x44f415);}console[_0x17a846(0x1ba)]('✅\x20Found\x20payment\x20'+_0x1eae84['id']+_0x17a846(0x1b8)),console[_0x17a846(0x1ba)](_0x17a846(0x1c7)+_0x1eae84[_0x17a846(0x157)]+_0x17a846(0xde)+_0x4e111c),_0x4e111c==='DECLINED'?(console[_0x17a846(0x1ba)](_0x17a846(0xbf)),await this['updatePaymentStatus'](_0x1eae84['id'],_0x17a846(0xcd)),console[_0x17a846(0x1ba)]('✅\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20'+_0x1eae84['id']+'\x20status\x20updated\x20to\x20FAILED'),console['log']('ℹ️\x20Decline\x20reason:\x20'+(_0x2281a0||_0x17a846(0xda)))):console[_0x17a846(0x1ba)](_0x17a846(0x16e)+_0x4e111c+'\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)'),await database_1[_0x17a846(0x11a)][_0x17a846(0xca)][_0x17a846(0x191)]({'data':{'paymentId':_0x1eae84['id'],'shopId':_0x1eae84[_0x17a846(0x1c2)],'event':_0x17a846(0x135)+(_0x4e111c?.['toLowerCase']()||_0x17a846(0xbb)),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x47a2e7)}}),loggerService_1[_0x17a846(0x18b)]['logWebhookProcessed'](_0x17a846(0x158),_0x1eae84['id'],_0x1eae84[_0x17a846(0x157)],_0x4e111c===_0x17a846(0x1af)?_0x17a846(0xcd):_0x4e111c,_0x47a2e7);}catch(_0x24277e){console[_0x17a846(0x12f)]('❌\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:',_0x24277e),loggerService_1['loggerService']['logWebhookError'](_0x17a846(0x158),_0x24277e,_0x47a2e7);throw _0x24277e;}}async[a69_0xbac6c7(0xc6)](_0x378dea,_0x6aadac){const _0x275dd3=a69_0xbac6c7,_0x2b2646=Date[_0x275dd3(0xf7)]();try{const _0x49b00a=_0x378dea['shop'],_0x73f978=_0x49b00a[_0x275dd3(0x92)];if(!_0x73f978?.['webhookUrl']){console[_0x275dd3(0x1ba)](_0x275dd3(0x116)+_0x49b00a['id']);return;}const _0x3ee694=_0x6aadac===_0x275dd3(0xcb)?_0x275dd3(0x122):_0x6aadac===_0x275dd3(0xcd)?_0x275dd3(0x1bf):_0x6aadac===_0x275dd3(0x197)?_0x275dd3(0x1bf):_0x6aadac===_0x275dd3(0x193)?_0x275dd3(0x1bf):_0x6aadac===_0x275dd3(0xd6)?_0x275dd3(0x1bf):'payment.pending';let _0x12f90f=[];if(_0x73f978[_0x275dd3(0xe0)])try{_0x12f90f=Array[_0x275dd3(0x13f)](_0x73f978['webhookEvents'])?_0x73f978[_0x275dd3(0xe0)]:JSON['parse'](_0x73f978['webhookEvents']);}catch(_0x316e63){console[_0x275dd3(0x12f)](_0x275dd3(0xe4),_0x316e63),_0x12f90f=[];}if(!_0x12f90f['includes'](_0x3ee694)){console[_0x275dd3(0x1ba)](_0x275dd3(0x10f)+_0x3ee694+_0x275dd3(0x1b6)+_0x49b00a['id']);return;}const _0x3d1d1f={'event':_0x3ee694,'payment':{'id':_0x378dea['id'],'order_id':_0x378dea[_0x275dd3(0x175)],'gateway_order_id':_0x378dea[_0x275dd3(0x17f)],'gateway':_0x378dea[_0x275dd3(0x1ca)],'amount':_0x378dea[_0x275dd3(0x137)],'currency':_0x378dea[_0x275dd3(0xcc)],'status':_0x6aadac[_0x275dd3(0x154)](),'customer_email':_0x378dea['customerEmail'],'customer_name':_0x378dea[_0x275dd3(0x128)],'failure_message':_0x378dea[_0x275dd3(0x167)],'tx_urls':_0x378dea[_0x275dd3(0xd0)]?JSON[_0x275dd3(0x13b)](_0x378dea[_0x275dd3(0xd0)]):null,'created_at':_0x378dea[_0x275dd3(0xd3)],'updated_at':_0x378dea[_0x275dd3(0x10c)]}},_0x4d228e=await fetch(_0x73f978[_0x275dd3(0x114)],{'method':'POST','headers':{'Content-Type':_0x275dd3(0x98),'User-Agent':'Payment\x20System/1.0'},'body':JSON['stringify'](_0x3d1d1f)}),_0x52a230=Date['now']()-_0x2b2646,_0x3ee20a=_0x4d228e['ok']?_0x275dd3(0x19c):await _0x4d228e['text']();loggerService_1[_0x275dd3(0x18b)]['logShopWebhookSent'](_0x378dea['shopId'],_0x73f978['webhookUrl'],_0x3ee694,_0x4d228e[_0x275dd3(0x157)],_0x52a230,_0x3d1d1f),console[_0x275dd3(0x1ba)]('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x73f978[_0x275dd3(0x114)]+'\x20with\x20status\x20'+_0x4d228e[_0x275dd3(0x157)]+'\x20('+_0x52a230+_0x275dd3(0xe9));}catch(_0x34d3c2){console[_0x275dd3(0x12f)](_0x275dd3(0xfd),_0x34d3c2),loggerService_1[_0x275dd3(0x18b)][_0x275dd3(0x18a)](_0x378dea['shopId'],_0x378dea[_0x275dd3(0x164)]?.[_0x275dd3(0x92)]?.[_0x275dd3(0x114)]||_0x275dd3(0xbb),'webhook_send',_0x34d3c2,{});}}async[a69_0xbac6c7(0xe2)](_0x9bd06b,_0x1bfe27){const _0x9268ab=a69_0xbac6c7;try{const _0x503cb3={'PENDING':_0x9268ab(0x107),'PROCESSING':_0x9268ab(0x10d),'PAID':'paid','FAILED':_0x9268ab(0x13d),'EXPIRED':'expired','REFUND':'refund','CHARGEBACK':_0x9268ab(0x12a)},_0x358f1f=_0x503cb3[_0x1bfe27];if(!_0x358f1f||_0x358f1f==='created')return;await telegramBotService_1[_0x9268ab(0x120)]['sendPaymentNotification'](_0x9bd06b[_0x9268ab(0x1c2)],_0x9bd06b,_0x358f1f);}catch(_0x333b75){console['error'](_0x9268ab(0x129),_0x333b75);}}async[a69_0xbac6c7(0xf5)](_0x44ef35,_0x421566){const _0x54a577=a69_0xbac6c7;try{const _0x29252c=await database_1[_0x54a577(0x11a)]['shop'][_0x54a577(0x162)]({'where':{'id':_0x44ef35},'select':{'gatewaySettings':!![]}});if(!_0x29252c?.[_0x54a577(0x91)])return console['log'](_0x54a577(0x1c6)+_0x44ef35+_0x54a577(0x182)),0xa;const _0x575dee=JSON[_0x54a577(0x13b)](_0x29252c['gatewaySettings']);for(const [_0x82bc96,_0x20a28e]of Object['entries'](_0x575dee)){if(_0x82bc96[_0x54a577(0x154)]()===_0x421566[_0x54a577(0x154)]()){const _0x3de872=_0x20a28e[_0x54a577(0x179)]||0xa;return console[_0x54a577(0x1ba)](_0x54a577(0xe8)+_0x421566+_0x54a577(0xfb)+_0x44ef35+':\x20'+_0x3de872+'%'),_0x3de872;}}return console[_0x54a577(0x1ba)](_0x54a577(0x1a5)+_0x421566+_0x54a577(0x110)+_0x44ef35+_0x54a577(0xd9)),0xa;}catch(_0x4b9278){return console[_0x54a577(0x12f)](_0x54a577(0xbd)+_0x44ef35+',\x20gateway\x20'+_0x421566+':',_0x4b9278),0xa;}}async[a69_0xbac6c7(0xc7)](_0x7e4aca,_0x43221a){const _0x59cd5e=a69_0xbac6c7;console['log']('🔄\x20Processing\x20MyXSpend\x20webhook:'),console[_0x59cd5e(0x1ba)]('Query\x20params:',JSON[_0x59cd5e(0x1b5)](_0x7e4aca,null,0x2)),console[_0x59cd5e(0x1ba)]('Body\x20data:',JSON['stringify'](_0x43221a,null,0x2));try{const _0x2c5752=_0x7e4aca[_0x59cd5e(0x124)]||_0x43221a[_0x59cd5e(0x124)],_0x12677e=_0x7e4aca[_0x59cd5e(0x157)]||_0x43221a[_0x59cd5e(0x157)],_0x1c430a=_0x7e4aca[_0x59cd5e(0x137)]||_0x43221a[_0x59cd5e(0x137)],_0x5a6966=_0x7e4aca[_0x59cd5e(0xcc)]||_0x43221a[_0x59cd5e(0xcc)],_0x2b88f0=_0x7e4aca[_0x59cd5e(0x100)]||_0x43221a[_0x59cd5e(0x100)];if(!_0x2c5752){console[_0x59cd5e(0x12f)](_0x59cd5e(0x1b4));throw new Error(_0x59cd5e(0x1a4));}console[_0x59cd5e(0x1ba)](_0x59cd5e(0xc4),{'customerOrderId':_0x2c5752,'status':_0x12677e,'amount':_0x1c430a,'currency':_0x5a6966,'dateTime':_0x2b88f0});const _0x1bac4a=await database_1[_0x59cd5e(0x11a)]['payment'][_0x59cd5e(0xec)]({'where':{'OR':[{'gatewayOrderId':_0x2c5752},{'orderId':_0x2c5752},{'id':_0x2c5752},{'gatewayPaymentId':_0x2c5752}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1bac4a){console[_0x59cd5e(0x12f)](_0x59cd5e(0x19d)+_0x2c5752);throw new Error(_0x59cd5e(0x19f)+_0x2c5752);}console['log'](_0x59cd5e(0xd1)+_0x1bac4a['id']+_0x59cd5e(0xba)),console[_0x59cd5e(0x1ba)](_0x59cd5e(0x1c7)+_0x1bac4a[_0x59cd5e(0x157)]+_0x59cd5e(0xde)+_0x12677e);let _0x247f78=_0x12677e?.[_0x59cd5e(0x11b)]();_0x12677e==='FAILED'||_0x12677e==='EXPIRED'?(_0x247f78=_0x59cd5e(0xcd),console[_0x59cd5e(0x1ba)](_0x59cd5e(0xa8)+_0x12677e+_0x59cd5e(0x102)),await this[_0x59cd5e(0x1b1)](_0x1bac4a['id'],_0x247f78),console['log']('✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20'+_0x1bac4a['id']+_0x59cd5e(0x11d))):console[_0x59cd5e(0x1ba)]('ℹ️\x20MyXSpend\x20status\x20'+_0x12677e+_0x59cd5e(0x196)),await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0x1bac4a['id'],'shopId':_0x1bac4a[_0x59cd5e(0x1c2)],'event':_0x59cd5e(0x15e)+(_0x12677e?.[_0x59cd5e(0x154)]()||_0x59cd5e(0xbb)),'statusCode':0xc8,'responseBody':JSON[_0x59cd5e(0x1b5)]({'queryParams':_0x7e4aca,'bodyData':_0x43221a})}}),loggerService_1['loggerService'][_0x59cd5e(0x198)](_0x59cd5e(0x17e),_0x1bac4a['id'],_0x1bac4a[_0x59cd5e(0x157)],_0x247f78||_0x12677e,{'queryParams':_0x7e4aca,'bodyData':_0x43221a});}catch(_0x52241a){console['error'](_0x59cd5e(0xb8),_0x52241a),loggerService_1[_0x59cd5e(0x18b)]['logWebhookError'](_0x59cd5e(0x17e),_0x52241a,{'queryParams':_0x7e4aca,'bodyData':_0x43221a});throw _0x52241a;}}}exports[a69_0xbac6c7(0x10a)]=WebhookService;