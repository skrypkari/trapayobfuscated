'use strict';const a66_0x41595f=a66_0x3ab5;(function(_0x19a4b9,_0x2ad9a7){const _0x5f559d=a66_0x3ab5,_0x4d6749=_0x19a4b9();while(!![]){try{const _0x1c8c32=parseInt(_0x5f559d(0x209))/0x1+-parseInt(_0x5f559d(0x2c1))/0x2*(parseInt(_0x5f559d(0x2f8))/0x3)+-parseInt(_0x5f559d(0x24f))/0x4+-parseInt(_0x5f559d(0x2c7))/0x5*(-parseInt(_0x5f559d(0x2cc))/0x6)+parseInt(_0x5f559d(0x250))/0x7+-parseInt(_0x5f559d(0x29c))/0x8*(parseInt(_0x5f559d(0x2e8))/0x9)+parseInt(_0x5f559d(0x1fc))/0xa*(parseInt(_0x5f559d(0x1f8))/0xb);if(_0x1c8c32===_0x2ad9a7)break;else _0x4d6749['push'](_0x4d6749['shift']());}catch(_0x519664){_0x4d6749['push'](_0x4d6749['shift']());}}}(a66_0x1a04,0x2d48c));function a66_0x3ab5(_0x39f72e,_0x83d7e1){const _0x1a0443=a66_0x1a04();return a66_0x3ab5=function(_0x3ab5fc,_0x553999){_0x3ab5fc=_0x3ab5fc-0x1e5;let _0x5dbc96=_0x1a0443[_0x3ab5fc];return _0x5dbc96;},a66_0x3ab5(_0x39f72e,_0x83d7e1);}var __importDefault=this&&this['__importDefault']||function(_0xc837b8){const _0x17f210=a66_0x3ab5;return _0xc837b8&&_0xc837b8[_0x17f210(0x26f)]?_0xc837b8:{'default':_0xc837b8};};Object[a66_0x41595f(0x27f)](exports,a66_0x41595f(0x26f),{'value':!![]}),exports[a66_0x41595f(0x292)]=void 0x0;const database_1=__importDefault(require(a66_0x41595f(0x285))),plisioService_1=require(a66_0x41595f(0x281)),rapydService_1=require(a66_0x41595f(0x229)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a66_0x41595f(0x22a)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require(a66_0x41595f(0x2eb)),mastercardService_1=require(a66_0x41595f(0x2fc)),amerService_1=require(a66_0x41595f(0x2c3)),ampayService_1=require(a66_0x41595f(0x2aa)),ampayTRYService_1=require('./gateways/ampayTRYService'),telegramBotService_1=require(a66_0x41595f(0x2e1)),currencyService_1=require('./currencyService'),loggerService_1=require(a66_0x41595f(0x27a));function a66_0x1a04(){const _0x2baea2=['cointopay','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','logWebhookProcessed','ampay_','WebhookService','Body\x20data:','txUrls','✅\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20','gatewaySettings','shopId','processKlymeWebhook','\x20updated:\x20currentPayments=','default','coinToPayService','2098712KjbhUb','🔄\x20Processing\x20CoinToPay2\x20webhook:','📊\x20Payment\x20status:\x20','webhook_status_change_','mastercard','remitterIban','dateTime','processAmPayTRYWebhook','🔄\x20Processing\x20MyXSpend\x20webhook:','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','paymentLinkId','📊\x20Noda\x20webhook:\x20Payment\x20','keys','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','./gateways/ampayService','🔄\x20Processing\x20Amer\x20webhook:','webhook_send','📊\x20Plisio\x20webhook:\x20Payment\x20','💰\x20Payment\x20','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','noda','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','myxspend_','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','\x20with\x20status\x20','AmerService','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','desc','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','chargebackAmount','Payment\x20not\x20found:\x20','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','customerName','Error\x20processing\x20Plisio\x20Gateway\x20webhook:',',\x20gateway\x20','update','67648uUdTnN','📤\x20Shop\x20webhook\x20sent\x20to\x20','./gateways/amerService','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','✅\x20Payment\x20link\x20','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','15pJqFwi','processWebhook','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','orderId','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','129918leIkbr','visa','KlymeService','CHARGEBACK',',\x20Gateway=','\x22,\x20orderId=\x22','💰\x20Removing\x20from\x20balance:\x20','POST','🔄\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','status_addition_info','rapydService','📊\x20MasterCard\x20webhook\x20result:','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','Webhook\x20event\x20','currentPayments','additionalInfo','updatedAt','Error\x20processing\x20Noda\x20webhook:','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','./telegramBotService','\x20-\x20','\x20not\x20found','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','plisio_gateway','📊\x20Rapyd\x20webhook:\x20Payment\x20','create','9XdvUSM','Not\x20found','\x20in\x20shop\x20','./gateways/klymeService',',\x20using\x20default\x2010%','paidAt','🔄\x20Processing\x20MasterCard\x20webhook:','🔄\x20Processing\x20VISA\x20webhook:','Found','Payment\x20not\x20found','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','\x20for\x20MyXSpend\x20webhook','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook','24RjYRXs','shop','payment.failed','PAID','./gateways/mastercardService','amerService','🔄\x20Processing\x20Plisio\x20webhook:','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20',',\x20GatewayOrderId=','log','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook',',\x20gatewayOrderId:\x20','DECLINED','customerEmail','ℹ️\x20MyXSpend\x20status\x20','✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20','Error\x20processing\x20CoinToPay2\x20webhook:','\x20->\x20','PlisioService','%\x20gateway\x20commission)','includes','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20',',\x20Card=****','webhookUrl','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','telegramBotService','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','cointopay2','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','\x22,\x20newStatus=\x22','amount','No\x20additional\x20info','getGatewayCommission','type','🏪\x20Shop\x20','ampay',',\x20Status=','payment.pending','coinToPay2Service','logWebhookError','toFixed','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','error','convertToUSDT','📈\x20Found\x20payment\x20link\x20','ampay_try','No\x20payment\x20ID\x20in\x20Amer\x20webhook','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','bankId','ampay_try_','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','findUnique','MASTERCARD','username','\x20current\x20balance:\x20','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','unknown','customerOrderId','$transaction','balance','createdAt','rapyd','processing','created','❌\x20Error\x20processing\x20AmPay\x20webhook:','🔄\x20Processing\x20Rapyd\x20webhook:','🔄\x20Processing\x20AmPay\x20webhook:','7668001MuqUbh','klyme','gatewayPaymentId','✅\x20Found\x20payment:\x20ID=','10LLFRLr','Payment\x20System/1.0','\x20mapped\x20to\x20FAILED','ℹ️\x20AmPay\x20status\x20','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','Query\x20params:','client_transaction_id','🔄\x20Processing\x20KLYME\x20webhook:','sendPaymentStatusNotification','failureMessage','\x20→\x20','Found\x20payment\x20','payment_method','102148UJwScV','currency','📈\x20Payment\x20details:\x20oldStatus=\x22','\x20=\x20','paid','commission','processMasterCardWebhook','stringify','processAmPayWebhook','errorMessage','\x20USDT\x20(chargeback\x20penalty)','🔍\x20Found\x20VISA\x20payment:\x20ID=',',\x20currentPayments=','Error\x20processing\x20Plisio\x20webhook:','Error\x20processing\x20CoinToPay\x20webhook:','📝\x20Reason:\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','🔍\x20VISA\x20payment\x20search\x20executed','ampayTRYService','toUpperCase','webhookEvents','💰\x20Converting\x20','settings','\x20to\x20','gateway','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','\x20status\x20','cardLast4','parse','processAmerWebhook','processMyXSpendWebhook','SINGLE','./gateways/rapydService','./gateways/coinToPayService','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','webhookLog','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','🔄\x20MyXSpend\x20status\x20','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','CoinToPayService','❌\x20Available\x20webhook\x20fields:','system_id','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','visa/mastercard','❌\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:','remitterName','logShopWebhookSent','FAILED','REFUND','amountUSDT','Error\x20processing\x20KLYME\x20webhook:','gatewayOrderId','findMany','loggerService',',\x20status=',':\x20type=','📊\x20AmPay\x20TRY\x20webhook\x20data:','🔄\x20Additional\x20data:','❌\x20Error\x20processing\x20MasterCard\x20webhook:','ℹ️\x20Decline\x20reason:\x20','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','amountAfterGatewayCommissionUSDT','❌\x20Payment\x20link\x20','💰\x20Adding\x20to\x20balance:\x20','CoinToPay2Service','findFirst','VISA\x20payment\x20not\x20found:\x20','failed','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','ℹ️\x20AmPay\x20TRY\x20status\x20','1259196rkRiJB','1183112rdnZob','updatePaymentStatus','❌\x20Error\x20processing\x20Amer\x20webhook:','paymentMethod','now','COMPLETED','toLowerCase','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','currencyService','processRapydWebhook','RapydService','plisioService','🔄\x20Processing\x20CoinToPay\x20webhook:','✅\x20Found\x20payment\x20','system','paymentId','paymentLink','🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:','📊\x20AmPay\x20webhook\x20data:','visa_','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','plisio','🔄\x20Processing\x20AmPay\x20TRY\x20webhook:','✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','💰\x20Amount\x20after\x20gateway\x20commission:\x20','\x20+\x20','Success','refund','visaMasterCardService','processPlisioWebhook','__esModule','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','🔄\x20Processing\x20Noda\x20webhook:','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','📈\x20Payment\x20','EXPIRED','🔍\x20Search\x20result:\x20','\x20for\x20AmPay\x20webhook',',\x20GatewayPaymentId=','\x20status\x20updated\x20to\x20FAILED','klymeService','./loggerService','payment','ms)','\x20USDT','myxspend','defineProperty','amer','./gateways/plisioService','📊\x20MyXSpend\x20webhook\x20data:','📊\x20VISA\x20payment\x20found:\x20','\x20(Status:\x20','../config/database','\x22,\x20paymentLinkId=\x22','status','📊\x20VISA\x20webhook\x20result:','Gateway\x20','nodaService',',\x20gatewayPaymentId:\x20','📊\x20Amer\x20webhook\x20result:','map'];a66_0x1a04=function(){return _0x2baea2;};return a66_0x1a04();}class WebhookService{constructor(){const _0x22f5d8=a66_0x41595f;this[_0x22f5d8(0x25c)]=new plisioService_1[(_0x22f5d8(0x30a))](),this[_0x22f5d8(0x2d7)]=new rapydService_1[(_0x22f5d8(0x25b))](),this['nodaService']=new nodaService_1['NodaService'](),this['coinToPayService']=new coinToPayService_1[(_0x22f5d8(0x230))](),this[_0x22f5d8(0x320)]=new coinToPay2Service_1[(_0x22f5d8(0x249))](),this[_0x22f5d8(0x279)]=new klymeService_1[(_0x22f5d8(0x2ce))](),this[_0x22f5d8(0x26d)]=new mastercardService_1['VisaMasterCardService'](),this[_0x22f5d8(0x2fd)]=new amerService_1[(_0x22f5d8(0x2b5))](),this['ampayService']=new ampayService_1['AmPayService'](),this[_0x22f5d8(0x21b)]=new ampayTRYService_1['AmPayTRYService']();}async[a66_0x41595f(0x251)](_0x1cc01b,_0xf4e0c3,_0x5dc2eb){const _0x53c421=a66_0x41595f;console[_0x53c421(0x301)]('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x1cc01b+',\x20newStatus='+_0xf4e0c3),console[_0x53c421(0x301)](_0x53c421(0x242),_0x5dc2eb),await database_1[_0x53c421(0x29a)][_0x53c421(0x1ef)](async _0x5b4b34=>{const _0x6378fa=_0x53c421,_0x524173=await _0x5b4b34[_0x6378fa(0x27b)][_0x6378fa(0x1e6)]({'where':{'id':_0x1cc01b},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x524173)throw new Error('Payment\x20'+_0x1cc01b+_0x6378fa(0x2e3));const _0x591038=_0x524173['status'],_0x18e988=_0x524173[_0x6378fa(0x2f9)];console[_0x6378fa(0x301)](_0x6378fa(0x2ae)+_0x1cc01b+':\x20'+_0x591038+_0x6378fa(0x309)+_0xf4e0c3),console['log'](_0x6378fa(0x31c)+_0x18e988['username']+_0x6378fa(0x1e9)+_0x18e988[_0x6378fa(0x1f0)]+_0x6378fa(0x27d));const _0x38df52={'status':_0xf4e0c3[_0x6378fa(0x21c)](),'updatedAt':new Date(),'statusChangedBy':_0x6378fa(0x25f),'statusChangedAt':new Date()};_0x5dc2eb?.['failureMessage']&&(_0x38df52[_0x6378fa(0x205)]=_0x5dc2eb[_0x6378fa(0x205)]);_0x5dc2eb?.['txUrls']&&(_0x38df52[_0x6378fa(0x294)]=JSON['stringify'](_0x5dc2eb[_0x6378fa(0x294)]));_0x5dc2eb?.[_0x6378fa(0x224)]&&(_0x38df52['cardLast4']=_0x5dc2eb[_0x6378fa(0x224)]);_0x5dc2eb?.[_0x6378fa(0x253)]&&(_0x38df52[_0x6378fa(0x253)]=_0x5dc2eb[_0x6378fa(0x253)]);_0x5dc2eb?.[_0x6378fa(0x32b)]&&(_0x38df52[_0x6378fa(0x32b)]=_0x5dc2eb['bankId']);_0x5dc2eb?.[_0x6378fa(0x2a1)]&&(_0x38df52[_0x6378fa(0x2a1)]=_0x5dc2eb[_0x6378fa(0x2a1)]);_0x5dc2eb?.[_0x6378fa(0x236)]&&(_0x38df52['remitterName']=_0x5dc2eb[_0x6378fa(0x236)]);let _0x44478b=_0x18e988[_0x6378fa(0x1f0)],_0x2fcba5='';if(_0xf4e0c3[_0x6378fa(0x21c)]()==='PAID'&&_0x591038!==_0x6378fa(0x2fb)){const _0x14c527=await currencyService_1[_0x6378fa(0x259)][_0x6378fa(0x325)](_0x524173[_0x6378fa(0x318)],_0x524173['currency']),_0x92e71d=await this[_0x6378fa(0x31a)](_0x18e988['id'],_0x524173[_0x6378fa(0x221)]),_0x4443dc=_0x14c527*(0x1-_0x92e71d/0x64);_0x44478b+=_0x4443dc,_0x2fcba5='+'+_0x4443dc[_0x6378fa(0x322)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20'+_0x92e71d+_0x6378fa(0x30b),_0x38df52['amountUSDT']=_0x14c527,_0x38df52[_0x6378fa(0x246)]=_0x4443dc,_0x38df52['gatewayCommissionRate']=_0x92e71d,_0x38df52[_0x6378fa(0x2ed)]=new Date(),console['log'](_0x6378fa(0x21e)+_0x524173[_0x6378fa(0x318)]+'\x20'+_0x524173['currency']+_0x6378fa(0x309)+_0x14c527[_0x6378fa(0x322)](0x6)+_0x6378fa(0x27d)),console['log']('💰\x20Gateway\x20'+_0x524173[_0x6378fa(0x221)]+'\x20commission:\x20'+_0x92e71d+'%'),console[_0x6378fa(0x301)](_0x6378fa(0x269)+_0x4443dc[_0x6378fa(0x322)](0x6)+_0x6378fa(0x27d)),console[_0x6378fa(0x301)](_0x6378fa(0x248)+_0x18e988[_0x6378fa(0x1f0)]+_0x6378fa(0x26a)+_0x4443dc[_0x6378fa(0x322)](0x6)+_0x6378fa(0x20c)+_0x44478b[_0x6378fa(0x322)](0x6)+_0x6378fa(0x27d));}else{if(_0x591038==='PAID'&&_0xf4e0c3[_0x6378fa(0x21c)]()!==_0x6378fa(0x2fb)){let _0x490fff;if(_0x524173[_0x6378fa(0x246)])_0x490fff=_0x524173['amountAfterGatewayCommissionUSDT'];else{if(_0x524173['amountUSDT']){const _0x48f8ac=await this['getGatewayCommission'](_0x18e988['id'],_0x524173[_0x6378fa(0x221)]);_0x490fff=_0x524173[_0x6378fa(0x23a)]*(0x1-_0x48f8ac/0x64);}else console[_0x6378fa(0x301)]('No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance'),_0x490fff=0x0;}_0x490fff>0x0&&(_0x44478b-=_0x490fff,_0x2fcba5='-'+_0x490fff[_0x6378fa(0x322)](0x6)+_0x6378fa(0x2b3),_0x38df52[_0x6378fa(0x23a)]=null,_0x38df52['amountAfterGatewayCommissionUSDT']=null,_0x38df52[_0x6378fa(0x2ed)]=null,console[_0x6378fa(0x301)](_0x6378fa(0x2d2)+_0x18e988['balance']+_0x6378fa(0x2e2)+_0x490fff[_0x6378fa(0x322)](0x6)+_0x6378fa(0x20c)+_0x44478b['toFixed'](0x6)+'\x20USDT'));}}if(_0xf4e0c3[_0x6378fa(0x21c)]()===_0x6378fa(0x2cf)){const _0x3e65c5=_0x5dc2eb?.[_0x6378fa(0x2b9)]||0x0;_0x3e65c5>0x0&&(_0x44478b-=_0x3e65c5,_0x2fcba5+='\x20and\x20-'+_0x3e65c5['toFixed'](0x6)+_0x6378fa(0x213),_0x38df52[_0x6378fa(0x2b9)]=_0x3e65c5,console['log']('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0x3e65c5[_0x6378fa(0x322)](0x6)+'\x20USDT'),console[_0x6378fa(0x301)]('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x44478b[_0x6378fa(0x322)](0x6)+_0x6378fa(0x27d)));}const _0x504ec9=await _0x5b4b34[_0x6378fa(0x27b)][_0x6378fa(0x2c0)]({'where':{'id':_0x1cc01b},'data':_0x38df52});_0x44478b!==_0x18e988[_0x6378fa(0x1f0)]&&(await _0x5b4b34[_0x6378fa(0x2f9)]['update']({'where':{'id':_0x18e988['id']},'data':{'balance':_0x44478b}}),console[_0x6378fa(0x301)]('✅\x20Shop\x20'+_0x18e988[_0x6378fa(0x1e8)]+'\x20balance\x20updated:\x20'+_0x18e988[_0x6378fa(0x1f0)][_0x6378fa(0x322)](0x6)+_0x6378fa(0x309)+_0x44478b[_0x6378fa(0x322)](0x6)+_0x6378fa(0x27d)),console['log'](_0x6378fa(0x218)+_0x2fcba5));await _0x5b4b34[_0x6378fa(0x22c)][_0x6378fa(0x2e7)]({'data':{'paymentId':_0x1cc01b,'shopId':_0x18e988['id'],'event':_0x6378fa(0x29f)+_0xf4e0c3[_0x6378fa(0x256)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x591038,'newStatus':_0xf4e0c3[_0x6378fa(0x21c)](),'balanceChange':_0x2fcba5||'no\x20balance\x20change','oldBalance':_0x18e988[_0x6378fa(0x1f0)],'newBalance':_0x44478b,'amountUSDT':_0x38df52[_0x6378fa(0x23a)],'additionalData':_0x5dc2eb,'timestamp':new Date()['toISOString']()})}}),await this['sendShopWebhook']({..._0x524173,..._0x504ec9,'shop':_0x18e988},_0xf4e0c3[_0x6378fa(0x21c)]()),await this[_0x6378fa(0x204)]({..._0x524173,..._0x504ec9},_0xf4e0c3[_0x6378fa(0x21c)]());if(_0x591038!=='PAID'&&_0xf4e0c3[_0x6378fa(0x21c)]()==='PAID'){console['log'](_0x6378fa(0x273)+_0x1cc01b+_0x6378fa(0x2e4)),console[_0x6378fa(0x301)](_0x6378fa(0x20b)+_0x591038+_0x6378fa(0x317)+_0xf4e0c3[_0x6378fa(0x21c)]()+_0x6378fa(0x286)+_0x524173[_0x6378fa(0x2a6)]+'\x22');if(_0x524173[_0x6378fa(0x2a6)])try{const _0x458528=await _0x5b4b34[_0x6378fa(0x261)][_0x6378fa(0x1e6)]({'where':{'id':_0x524173['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x458528){console[_0x6378fa(0x301)](_0x6378fa(0x326)+_0x458528['id']+_0x6378fa(0x240)+_0x458528[_0x6378fa(0x31b)]+_0x6378fa(0x215)+_0x458528[_0x6378fa(0x2dc)]+',\x20status='+_0x458528[_0x6378fa(0x287)]);const _0x1b38b8=_0x458528[_0x6378fa(0x2dc)]+0x1,_0x37a03a=_0x458528[_0x6378fa(0x31b)]===_0x6378fa(0x228)?_0x6378fa(0x255):_0x458528[_0x6378fa(0x287)];await _0x5b4b34[_0x6378fa(0x261)][_0x6378fa(0x2c0)]({'where':{'id':_0x524173[_0x6378fa(0x2a6)]},'data':{'currentPayments':_0x1b38b8,'status':_0x37a03a,'updatedAt':new Date()}}),console['log'](_0x6378fa(0x2c5)+_0x458528['id']+_0x6378fa(0x299)+_0x458528[_0x6378fa(0x2dc)]+'\x20->\x20'+_0x1b38b8+_0x6378fa(0x23f)+_0x458528[_0x6378fa(0x287)]+_0x6378fa(0x309)+_0x37a03a);}else console['log'](_0x6378fa(0x247)+_0x524173[_0x6378fa(0x2a6)]+_0x6378fa(0x2e3));}catch(_0x8ca4d0){console[_0x6378fa(0x324)](_0x6378fa(0x219),_0x8ca4d0);}else console[_0x6378fa(0x301)](_0x6378fa(0x273)+_0x1cc01b+_0x6378fa(0x2d5));}else console[_0x6378fa(0x301)](_0x6378fa(0x273)+_0x1cc01b+'\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20'+_0x591038+'\x20->\x20'+_0xf4e0c3[_0x6378fa(0x21c)]());});}async[a66_0x41595f(0x26e)](_0x1ed7bd){const _0xa43b5=a66_0x41595f;console[_0xa43b5(0x301)](_0xa43b5(0x2fe),_0x1ed7bd);try{const _0x5a02a1=await this['plisioService'][_0xa43b5(0x2c8)](_0x1ed7bd);if(!_0x5a02a1[_0xa43b5(0x260)])throw new Error(_0xa43b5(0x272));const _0x5abf95=await database_1['default'][_0xa43b5(0x27b)][_0xa43b5(0x24a)]({'where':{'gatewayOrderId':_0x5a02a1['paymentId']}});if(!_0x5abf95){console['error'](_0xa43b5(0x2f3)+_0x5a02a1[_0xa43b5(0x260)]);return;}console[_0xa43b5(0x301)](_0xa43b5(0x2ad)+_0x5abf95['id']+_0xa43b5(0x223)+_0x5a02a1['status']),await this['updatePaymentStatus'](_0x5abf95['id'],_0x5a02a1[_0xa43b5(0x287)],{'txUrls':_0x5a02a1[_0xa43b5(0x294)]}),loggerService_1[_0xa43b5(0x23e)][_0xa43b5(0x290)](_0xa43b5(0x266),_0x5abf95['id'],_0x5abf95[_0xa43b5(0x287)],_0x5a02a1[_0xa43b5(0x287)],_0x1ed7bd);}catch(_0x62582d){console[_0xa43b5(0x324)](_0xa43b5(0x216),_0x62582d),loggerService_1[_0xa43b5(0x23e)][_0xa43b5(0x321)](_0xa43b5(0x266),_0x62582d,_0x1ed7bd);throw _0x62582d;}}async['processPlisioGatewayWebhook'](_0x192250){const _0x183e5f=a66_0x41595f;console[_0x183e5f(0x301)](_0x183e5f(0x2b6),_0x192250);try{const _0x58b840=await this[_0x183e5f(0x25c)]['processWebhook'](_0x192250);if(!_0x58b840[_0x183e5f(0x260)])throw new Error(_0x183e5f(0x2c4));const _0x2684b=await database_1[_0x183e5f(0x29a)][_0x183e5f(0x27b)][_0x183e5f(0x24a)]({'where':{'gatewayOrderId':_0x58b840[_0x183e5f(0x260)]}});if(!_0x2684b){console[_0x183e5f(0x324)](_0x183e5f(0x323)+_0x58b840[_0x183e5f(0x260)]);return;}console[_0x183e5f(0x301)](_0x183e5f(0x2bc)+_0x2684b['id']+_0x183e5f(0x223)+_0x58b840[_0x183e5f(0x287)]),await this[_0x183e5f(0x251)](_0x2684b['id'],_0x58b840['status'],{'txUrls':_0x58b840['txUrls']}),loggerService_1[_0x183e5f(0x23e)]['logWebhookProcessed'](_0x183e5f(0x2e5),_0x2684b['id'],_0x2684b[_0x183e5f(0x287)],_0x58b840[_0x183e5f(0x287)],_0x192250);}catch(_0x566e45){console['error'](_0x183e5f(0x2be),_0x566e45),loggerService_1['loggerService'][_0x183e5f(0x321)](_0x183e5f(0x2e5),_0x566e45,_0x192250);throw _0x566e45;}}async[a66_0x41595f(0x25a)](_0x1a76e0){const _0x429d86=a66_0x41595f;console['log'](_0x429d86(0x1f6),_0x1a76e0);try{const _0x5f2a68=await this[_0x429d86(0x2d7)]['processWebhook'](_0x1a76e0);if(!_0x5f2a68[_0x429d86(0x260)])throw new Error('No\x20payment\x20ID\x20in\x20Rapyd\x20webhook');const _0x88ff51=await database_1[_0x429d86(0x29a)][_0x429d86(0x27b)][_0x429d86(0x24a)]({'where':{'gatewayOrderId':_0x5f2a68[_0x429d86(0x260)]}});if(!_0x88ff51){console['error']('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x5f2a68[_0x429d86(0x260)]);return;}console[_0x429d86(0x301)](_0x429d86(0x2e6)+_0x88ff51['id']+_0x429d86(0x223)+_0x5f2a68['status']),await this[_0x429d86(0x251)](_0x88ff51['id'],_0x5f2a68[_0x429d86(0x287)],{'failureMessage':_0x5f2a68['failureMessage'],'cardLast4':_0x5f2a68[_0x429d86(0x2dd)]?.[_0x429d86(0x224)],'paymentMethod':_0x5f2a68[_0x429d86(0x2dd)]?.[_0x429d86(0x253)]}),loggerService_1[_0x429d86(0x23e)][_0x429d86(0x290)]('rapyd',_0x88ff51['id'],_0x88ff51[_0x429d86(0x287)],_0x5f2a68[_0x429d86(0x287)],_0x1a76e0);}catch(_0xd2bcc6){console[_0x429d86(0x324)]('Error\x20processing\x20Rapyd\x20webhook:',_0xd2bcc6),loggerService_1['loggerService']['logWebhookError'](_0x429d86(0x1f2),_0xd2bcc6,_0x1a76e0);throw _0xd2bcc6;}}async['processNodaWebhook'](_0x4ee097){const _0x5bcf1f=a66_0x41595f;console[_0x5bcf1f(0x301)](_0x5bcf1f(0x271),_0x4ee097);try{const _0x13f319=await this[_0x5bcf1f(0x28a)][_0x5bcf1f(0x2c8)](_0x4ee097);if(!_0x13f319[_0x5bcf1f(0x260)])throw new Error('No\x20payment\x20ID\x20in\x20Noda\x20webhook');const _0x405f2b=await database_1[_0x5bcf1f(0x29a)][_0x5bcf1f(0x27b)][_0x5bcf1f(0x24a)]({'where':{'gatewayOrderId':_0x13f319['paymentId']}});if(!_0x405f2b){console[_0x5bcf1f(0x324)](_0x5bcf1f(0x1ec)+_0x13f319[_0x5bcf1f(0x260)]);return;}console['log'](_0x5bcf1f(0x2a7)+_0x405f2b['id']+_0x5bcf1f(0x223)+_0x13f319[_0x5bcf1f(0x287)]),await this[_0x5bcf1f(0x251)](_0x405f2b['id'],_0x13f319[_0x5bcf1f(0x287)],{'bankId':_0x13f319[_0x5bcf1f(0x2dd)]?.[_0x5bcf1f(0x32b)],'remitterIban':_0x13f319[_0x5bcf1f(0x2dd)]?.['remitterIban'],'remitterName':_0x13f319['additionalInfo']?.[_0x5bcf1f(0x236)]}),loggerService_1[_0x5bcf1f(0x23e)][_0x5bcf1f(0x290)](_0x5bcf1f(0x2b0),_0x405f2b['id'],_0x405f2b[_0x5bcf1f(0x287)],_0x13f319[_0x5bcf1f(0x287)],_0x4ee097);}catch(_0x4315a2){console[_0x5bcf1f(0x324)](_0x5bcf1f(0x2df),_0x4315a2),loggerService_1[_0x5bcf1f(0x23e)]['logWebhookError'](_0x5bcf1f(0x2b0),_0x4315a2,_0x4ee097);throw _0x4315a2;}}async['processCoinToPayWebhook'](_0x89f5b9){const _0x51a40f=a66_0x41595f;console[_0x51a40f(0x301)](_0x51a40f(0x25d),_0x89f5b9);try{const _0x2b57d6=await this[_0x51a40f(0x29b)]['processWebhook'](_0x89f5b9);if(!_0x2b57d6[_0x51a40f(0x260)])throw new Error(_0x51a40f(0x258));const _0x193877=await database_1[_0x51a40f(0x29a)]['payment'][_0x51a40f(0x24a)]({'where':{'gatewayOrderId':_0x2b57d6[_0x51a40f(0x260)]}});if(!_0x193877){console[_0x51a40f(0x324)](_0x51a40f(0x314)+_0x2b57d6[_0x51a40f(0x260)]);return;}console[_0x51a40f(0x301)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x193877['id']+_0x51a40f(0x223)+_0x2b57d6[_0x51a40f(0x287)]),await this[_0x51a40f(0x251)](_0x193877['id'],_0x2b57d6[_0x51a40f(0x287)]),loggerService_1[_0x51a40f(0x23e)][_0x51a40f(0x290)](_0x51a40f(0x28e),_0x193877['id'],_0x193877['status'],_0x2b57d6[_0x51a40f(0x287)],_0x89f5b9);}catch(_0x5850bd){console[_0x51a40f(0x324)](_0x51a40f(0x217),_0x5850bd),loggerService_1[_0x51a40f(0x23e)][_0x51a40f(0x321)](_0x51a40f(0x28e),_0x5850bd,_0x89f5b9);throw _0x5850bd;}}async['processCoinToPay2Webhook'](_0xde7a6f){const _0x2eba34=a66_0x41595f;console[_0x2eba34(0x301)](_0x2eba34(0x29d),_0xde7a6f);try{const _0x5ab0fb=await this[_0x2eba34(0x320)][_0x2eba34(0x2c8)](_0xde7a6f);if(!_0x5ab0fb[_0x2eba34(0x260)])throw new Error(_0x2eba34(0x2e0));const _0x25e404=await database_1['default']['payment'][_0x2eba34(0x24a)]({'where':{'gatewayOrderId':_0x5ab0fb['paymentId']}});if(!_0x25e404){console[_0x2eba34(0x324)](_0x2eba34(0x310)+_0x5ab0fb[_0x2eba34(0x260)]);return;}console[_0x2eba34(0x301)](_0x2eba34(0x24d)+_0x25e404['id']+_0x2eba34(0x223)+_0x5ab0fb[_0x2eba34(0x287)]),await this[_0x2eba34(0x251)](_0x25e404['id'],_0x5ab0fb[_0x2eba34(0x287)]),loggerService_1['loggerService'][_0x2eba34(0x290)](_0x2eba34(0x315),_0x25e404['id'],_0x25e404['status'],_0x5ab0fb[_0x2eba34(0x287)],_0xde7a6f);}catch(_0x4b37ee){console[_0x2eba34(0x324)](_0x2eba34(0x308),_0x4b37ee),loggerService_1[_0x2eba34(0x23e)]['logWebhookError']('cointopay2',_0x4b37ee,_0xde7a6f);throw _0x4b37ee;}}async[a66_0x41595f(0x298)](_0x4751b6){const _0x488fc3=a66_0x41595f;console[_0x488fc3(0x301)](_0x488fc3(0x203),_0x4751b6);try{const _0x202277=await this[_0x488fc3(0x279)]['processWebhook'](_0x4751b6);if(!_0x202277[_0x488fc3(0x260)])throw new Error(_0x488fc3(0x2bb));const _0x2d7ea9=await database_1[_0x488fc3(0x29a)][_0x488fc3(0x27b)][_0x488fc3(0x24a)]({'where':{'gatewayOrderId':_0x202277['paymentId']}});if(!_0x2d7ea9){console[_0x488fc3(0x324)](_0x488fc3(0x2da)+_0x202277[_0x488fc3(0x260)]);return;}console[_0x488fc3(0x301)]('📊\x20KLYME\x20webhook:\x20Payment\x20'+_0x2d7ea9['id']+_0x488fc3(0x223)+_0x202277[_0x488fc3(0x287)]),await this[_0x488fc3(0x251)](_0x2d7ea9['id'],_0x202277[_0x488fc3(0x287)],{'paymentMethod':_0x202277[_0x488fc3(0x2dd)]?.[_0x488fc3(0x208)]}),loggerService_1['loggerService']['logWebhookProcessed'](_0x488fc3(0x1f9),_0x2d7ea9['id'],_0x2d7ea9['status'],_0x202277[_0x488fc3(0x287)],_0x4751b6);}catch(_0x31b479){console[_0x488fc3(0x324)](_0x488fc3(0x23b),_0x31b479),loggerService_1[_0x488fc3(0x23e)][_0x488fc3(0x321)](_0x488fc3(0x1f9),_0x31b479,_0x4751b6);throw _0x31b479;}}async['processVisaWebhook'](_0xeedfae){const _0xaaa818=a66_0x41595f;console[_0xaaa818(0x301)](_0xaaa818(0x2ef),JSON[_0xaaa818(0x210)](_0xeedfae,null,0x2));try{const _0x3ae2aa=await this[_0xaaa818(0x26d)][_0xaaa818(0x2c8)](_0xeedfae,'VISA');console[_0xaaa818(0x301)](_0xaaa818(0x288),_0x3ae2aa);if(!_0x3ae2aa[_0xaaa818(0x260)]){console[_0xaaa818(0x324)](_0xaaa818(0x1eb)),console['error']('❌\x20Available\x20webhook\x20fields:',Object[_0xaaa818(0x2a8)](_0xeedfae));throw new Error('No\x20payment\x20ID\x20in\x20VISA\x20webhook');}let _0x36e01a=null;console['log'](_0xaaa818(0x265)+_0x3ae2aa[_0xaaa818(0x260)]);if(_0x3ae2aa[_0xaaa818(0x260)]){console[_0xaaa818(0x301)](_0xaaa818(0x311)),console[_0xaaa818(0x301)](_0xaaa818(0x32a)),console[_0xaaa818(0x301)](_0xaaa818(0x2f2)),console[_0xaaa818(0x301)](_0xaaa818(0x22d)+_0x3ae2aa[_0xaaa818(0x260)]),console[_0xaaa818(0x301)](_0xaaa818(0x22f)),_0x36e01a=await database_1[_0xaaa818(0x29a)][_0xaaa818(0x27b)][_0xaaa818(0x24a)]({'where':{'AND':[{'OR':[{'gateway':'visa/mastercard'},{'gateway':_0xaaa818(0x2a0)}]},{'OR':[{'gatewayPaymentId':_0x3ae2aa[_0xaaa818(0x260)]},{'gatewayOrderId':_0x3ae2aa[_0xaaa818(0x260)]},{'id':_0x3ae2aa[_0xaaa818(0x260)]},{'orderId':_0x3ae2aa[_0xaaa818(0x260)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0xaaa818(0x301)](_0xaaa818(0x21a));if(_0x36e01a)console[_0xaaa818(0x301)](_0xaaa818(0x1fb)+_0x36e01a['id']+_0xaaa818(0x300)+_0x36e01a[_0xaaa818(0x23c)]+_0xaaa818(0x277)+_0x36e01a[_0xaaa818(0x1fa)]);else{console[_0xaaa818(0x301)](_0xaaa818(0x1e5));const _0x5dc5f4=await database_1[_0xaaa818(0x29a)][_0xaaa818(0x27b)][_0xaaa818(0x23d)]({'where':{'gateway':_0xaaa818(0x234)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0xaaa818(0x2b7)}});console[_0xaaa818(0x301)](_0xaaa818(0x262),_0x5dc5f4[_0xaaa818(0x28d)](_0x2b92aa=>_0x2b92aa['id']+'\x20(orderId:\x20'+_0x2b92aa[_0xaaa818(0x2ca)]+_0xaaa818(0x303)+_0x2b92aa[_0xaaa818(0x23c)]+_0xaaa818(0x28b)+_0x2b92aa[_0xaaa818(0x1fa)]+',\x20card:\x20****'+_0x2b92aa[_0xaaa818(0x224)]+')'));}console[_0xaaa818(0x301)]('🔍\x20VISA\x20payment\x20search\x20result:\x20'+(_0x36e01a?_0xaaa818(0x2f0):_0xaaa818(0x2e9))),_0x36e01a&&console[_0xaaa818(0x301)](_0xaaa818(0x214)+_0x36e01a['id']+_0xaaa818(0x2d0)+_0x36e01a[_0xaaa818(0x221)]+_0xaaa818(0x31e)+_0x36e01a[_0xaaa818(0x287)]+_0xaaa818(0x30e)+_0x36e01a['cardLast4']);}if(!_0x36e01a){console[_0xaaa818(0x324)]('❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20'+_0x3ae2aa[_0xaaa818(0x260)]),loggerService_1[_0xaaa818(0x23e)][_0xaaa818(0x321)]('visa',new Error(_0xaaa818(0x2ba)+_0x3ae2aa['paymentId']),_0xeedfae);throw new Error(_0xaaa818(0x24b)+_0x3ae2aa[_0xaaa818(0x260)]);}console[_0xaaa818(0x301)](_0xaaa818(0x283)+_0x36e01a['id']+_0xaaa818(0x284)+_0x36e01a[_0xaaa818(0x287)]+_0xaaa818(0x206)+_0x3ae2aa[_0xaaa818(0x287)]+')');const _0x4da4f9={};_0x3ae2aa[_0xaaa818(0x318)]&&await database_1[_0xaaa818(0x29a)][_0xaaa818(0x27b)][_0xaaa818(0x2c0)]({'where':{'id':_0x36e01a['id']},'data':{'amount':_0x3ae2aa['amount'],'updatedAt':new Date()}}),_0x3ae2aa[_0xaaa818(0x20a)]&&await database_1[_0xaaa818(0x29a)]['payment'][_0xaaa818(0x2c0)]({'where':{'id':_0x36e01a['id']},'data':{'currency':_0x3ae2aa[_0xaaa818(0x20a)],'updatedAt':new Date()}}),_0x3ae2aa['status']===_0xaaa818(0x238)&&_0x3ae2aa[_0xaaa818(0x212)]&&(_0x4da4f9[_0xaaa818(0x205)]=_0x3ae2aa[_0xaaa818(0x212)],console[_0xaaa818(0x301)](_0xaaa818(0x2ff)+_0x3ae2aa[_0xaaa818(0x212)])),_0x4da4f9['paymentMethod']='visa',await this[_0xaaa818(0x251)](_0x36e01a['id'],_0x3ae2aa[_0xaaa818(0x287)],_0x4da4f9),await database_1['default'][_0xaaa818(0x22c)]['create']({'data':{'paymentId':_0x36e01a['id'],'shopId':_0x36e01a[_0xaaa818(0x297)],'event':_0xaaa818(0x264)+_0x3ae2aa['status'][_0xaaa818(0x256)](),'statusCode':0xc8,'responseBody':JSON[_0xaaa818(0x210)](_0x3ae2aa)}}),await this['sendPaymentStatusNotification'](_0x36e01a,_0x3ae2aa[_0xaaa818(0x287)]['toUpperCase']()),console[_0xaaa818(0x301)](_0xaaa818(0x2b8)+_0x36e01a['id']);}catch(_0xb0c8fc){console[_0xaaa818(0x324)]('❌\x20VISA\x20webhook\x20processing\x20failed:',_0xb0c8fc),loggerService_1[_0xaaa818(0x23e)]['logWebhookError'](_0xaaa818(0x2cd),_0xb0c8fc,_0xeedfae);throw _0xb0c8fc;}}async[a66_0x41595f(0x20f)](_0x719c4f){const _0x5d7e75=a66_0x41595f;console['log'](_0x5d7e75(0x2ee),JSON['stringify'](_0x719c4f,null,0x2));try{const _0x2756bb=await this[_0x5d7e75(0x26d)][_0x5d7e75(0x2c8)](_0x719c4f,_0x5d7e75(0x1e7));console['log'](_0x5d7e75(0x2d8),_0x2756bb);if(!_0x2756bb[_0x5d7e75(0x260)]){console[_0x5d7e75(0x324)](_0x5d7e75(0x313)),console[_0x5d7e75(0x324)]('❌\x20Available\x20webhook\x20fields:',Object[_0x5d7e75(0x2a8)](_0x719c4f));throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');}let _0x2ec444=null;console[_0x5d7e75(0x301)](_0x5d7e75(0x2a5)+_0x2756bb[_0x5d7e75(0x260)]);_0x2756bb[_0x5d7e75(0x260)]&&(console[_0x5d7e75(0x301)](_0x5d7e75(0x257)),_0x2ec444=await database_1[_0x5d7e75(0x29a)][_0x5d7e75(0x27b)][_0x5d7e75(0x24a)]({'where':{'AND':[{'OR':[{'gateway':'visa_mastercard'},{'gateway':_0x5d7e75(0x2a0)},{'gateway':_0x5d7e75(0x234)}]},{'OR':[{'gatewayPaymentId':_0x2756bb[_0x5d7e75(0x260)]},{'gatewayOrderId':_0x2756bb[_0x5d7e75(0x260)]},{'id':_0x2756bb[_0x5d7e75(0x260)]},{'orderId':_0x2756bb[_0x5d7e75(0x260)]}]}]}}),console[_0x5d7e75(0x301)]('🔍\x20Search\x20result:\x20'+(_0x2ec444?_0x5d7e75(0x207)+_0x2ec444['id']:_0x5d7e75(0x2f1))));if(!_0x2ec444){console[_0x5d7e75(0x324)]('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x2756bb[_0x5d7e75(0x260)]),console[_0x5d7e75(0x324)](_0x5d7e75(0x2af)+_0x2756bb[_0x5d7e75(0x260)]+'\x22,\x20id=\x22'+_0x2756bb[_0x5d7e75(0x260)]+_0x5d7e75(0x2d1)+_0x2756bb['paymentId']+'\x22');const _0x22e59f=await database_1['default'][_0x5d7e75(0x27b)][_0x5d7e75(0x23d)]({'where':{'OR':[{'gateway':_0x5d7e75(0x2a0)},{'gateway':'visa_mastercard'},{'gateway':_0x5d7e75(0x234)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x5d7e75(0x2b7)},'take':0xf});console[_0x5d7e75(0x301)](_0x5d7e75(0x2cb),_0x22e59f),loggerService_1[_0x5d7e75(0x23e)][_0x5d7e75(0x321)](_0x5d7e75(0x2a0),new Error(_0x5d7e75(0x2ba)+_0x2756bb[_0x5d7e75(0x260)]),_0x719c4f);throw new Error('MasterCard\x20payment\x20not\x20found:\x20'+_0x2756bb[_0x5d7e75(0x260)]);}console[_0x5d7e75(0x301)](_0x5d7e75(0x25e)+_0x2ec444['id']+_0x5d7e75(0x2c9)+_0x2ec444[_0x5d7e75(0x287)]+_0x5d7e75(0x220)+_0x2756bb['status']);const _0x5c5eb0={};_0x2756bb[_0x5d7e75(0x318)]&&await database_1[_0x5d7e75(0x29a)][_0x5d7e75(0x27b)]['update']({'where':{'id':_0x2ec444['id']},'data':{'amount':_0x2756bb[_0x5d7e75(0x318)],'updatedAt':new Date()}}),_0x2756bb[_0x5d7e75(0x20a)]&&await database_1[_0x5d7e75(0x29a)][_0x5d7e75(0x27b)]['update']({'where':{'id':_0x2ec444['id']},'data':{'currency':_0x2756bb[_0x5d7e75(0x20a)],'updatedAt':new Date()}}),_0x2756bb[_0x5d7e75(0x287)]===_0x5d7e75(0x238)&&_0x2756bb[_0x5d7e75(0x212)]&&(_0x5c5eb0['failureMessage']=_0x2756bb[_0x5d7e75(0x212)],console[_0x5d7e75(0x301)](_0x5d7e75(0x245)+_0x2756bb[_0x5d7e75(0x212)])),_0x5c5eb0[_0x5d7e75(0x253)]=_0x5d7e75(0x2a0),await this['updatePaymentStatus'](_0x2ec444['id'],_0x2756bb['status'],_0x5c5eb0),loggerService_1[_0x5d7e75(0x23e)][_0x5d7e75(0x290)](_0x5d7e75(0x2a0),_0x2ec444['id'],_0x2ec444[_0x5d7e75(0x287)],_0x2756bb['status'],_0x719c4f);}catch(_0x1774e6){console[_0x5d7e75(0x324)](_0x5d7e75(0x243),_0x1774e6),loggerService_1[_0x5d7e75(0x23e)][_0x5d7e75(0x321)](_0x5d7e75(0x2a0),_0x1774e6,_0x719c4f);throw _0x1774e6;}}async[a66_0x41595f(0x226)](_0x55ceca){const _0x98860=a66_0x41595f;console[_0x98860(0x301)](_0x98860(0x2ab),JSON[_0x98860(0x210)](_0x55ceca,null,0x2));try{const _0x133692=await this[_0x98860(0x2fd)][_0x98860(0x2c8)](_0x55ceca);console[_0x98860(0x301)](_0x98860(0x28c),_0x133692);if(!_0x133692['paymentId']){console[_0x98860(0x324)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data'),console[_0x98860(0x324)](_0x98860(0x231),Object[_0x98860(0x2a8)](_0x55ceca));throw new Error(_0x98860(0x328));}let _0x585f77=null;console[_0x98860(0x301)](_0x98860(0x1ea)+_0x133692[_0x98860(0x260)]),_0x585f77=await database_1[_0x98860(0x29a)]['payment'][_0x98860(0x24a)]({'where':{'AND':[{'gateway':_0x98860(0x280)},{'OR':[{'gatewayPaymentId':_0x133692[_0x98860(0x260)]},{'gatewayOrderId':_0x133692[_0x98860(0x260)]},{'id':_0x133692['paymentId']},{'orderId':_0x133692[_0x98860(0x260)]}]}]}}),console[_0x98860(0x301)](_0x98860(0x275)+(_0x585f77?_0x98860(0x207)+_0x585f77['id']:_0x98860(0x2f1)));if(!_0x585f77){console[_0x98860(0x324)](_0x98860(0x22b)+_0x133692[_0x98860(0x260)]);return;}console['log']('📊\x20Amer\x20webhook:\x20Payment\x20'+_0x585f77['id']+_0x98860(0x223)+_0x133692[_0x98860(0x287)]),await this[_0x98860(0x251)](_0x585f77['id'],_0x133692['status'],{'cardLast4':_0x133692[_0x98860(0x2dd)]?.['cardLast4'],'paymentMethod':_0x133692[_0x98860(0x2dd)]?.[_0x98860(0x253)]});}catch(_0xd3cfff){console[_0x98860(0x324)](_0x98860(0x252),_0xd3cfff),loggerService_1[_0x98860(0x23e)][_0x98860(0x321)](_0x98860(0x280),_0xd3cfff,_0x55ceca);throw _0xd3cfff;}}async[a66_0x41595f(0x211)](_0x513d47){const _0x2c02c7=a66_0x41595f;console[_0x2c02c7(0x301)](_0x2c02c7(0x1f7),JSON['stringify'](_0x513d47,null,0x2));try{const _0x2e01cf=_0x513d47[_0x2c02c7(0x287)],_0x48a354=_0x513d47[_0x2c02c7(0x202)],_0x3fb7c9=_0x513d47['system_id'],_0x3e169f=_0x513d47['payment_method'],_0x4ae02a=_0x513d47['amount'],_0x4f6f7c=_0x513d47[_0x2c02c7(0x20a)],_0x4fdfa5=_0x513d47[_0x2c02c7(0x20e)],_0x55fd9b=_0x513d47['status_addition_info'];if(!_0x48a354){console[_0x2c02c7(0x324)](_0x2c02c7(0x200));throw new Error('Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook');}console['log'](_0x2c02c7(0x263),{'status':_0x2e01cf,'clientTransactionId':_0x48a354,'systemId':_0x3fb7c9,'paymentMethod':_0x3e169f,'amount':_0x4ae02a,'currency':_0x4f6f7c,'commission':_0x4fdfa5,'statusAdditionInfo':_0x55fd9b});const _0x1458b9=await database_1['default']['payment'][_0x2c02c7(0x24a)]({'where':{'OR':[{'gatewayOrderId':_0x48a354},{'orderId':_0x48a354},{'id':_0x48a354},{'gatewayPaymentId':_0x48a354}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1458b9){console[_0x2c02c7(0x324)](_0x2c02c7(0x2b1)+_0x48a354);throw new Error('Payment\x20not\x20found:\x20'+_0x48a354);}console[_0x2c02c7(0x301)]('✅\x20Found\x20payment\x20'+_0x1458b9['id']+_0x2c02c7(0x276)),console[_0x2c02c7(0x301)]('📊\x20Payment\x20status:\x20'+_0x1458b9[_0x2c02c7(0x287)]+_0x2c02c7(0x206)+_0x2e01cf),_0x2e01cf===_0x2c02c7(0x304)?(console[_0x2c02c7(0x301)](_0x2c02c7(0x2c6)),await this[_0x2c02c7(0x251)](_0x1458b9['id'],'FAILED'),console['log'](_0x2c02c7(0x307)+_0x1458b9['id']+_0x2c02c7(0x278)),console[_0x2c02c7(0x301)](_0x2c02c7(0x244)+(_0x55fd9b||_0x2c02c7(0x319)))):console['log'](_0x2c02c7(0x1ff)+_0x2e01cf+_0x2c02c7(0x222)),await database_1[_0x2c02c7(0x29a)]['webhookLog'][_0x2c02c7(0x2e7)]({'data':{'paymentId':_0x1458b9['id'],'shopId':_0x1458b9['shopId'],'event':_0x2c02c7(0x291)+(_0x2e01cf?.[_0x2c02c7(0x256)]()||_0x2c02c7(0x1ed)),'statusCode':0xc8,'responseBody':JSON[_0x2c02c7(0x210)](_0x513d47)}}),loggerService_1['loggerService'][_0x2c02c7(0x290)](_0x2c02c7(0x31d),_0x1458b9['id'],_0x1458b9[_0x2c02c7(0x287)],_0x2e01cf===_0x2c02c7(0x304)?_0x2c02c7(0x238):_0x2e01cf,_0x513d47);}catch(_0xf8c6bf){console['error'](_0x2c02c7(0x1f5),_0xf8c6bf),loggerService_1[_0x2c02c7(0x23e)]['logWebhookError'](_0x2c02c7(0x31d),_0xf8c6bf,_0x513d47);throw _0xf8c6bf;}}async[a66_0x41595f(0x2a3)](_0x2eb9b4){const _0xc8be39=a66_0x41595f;console[_0xc8be39(0x301)](_0xc8be39(0x267),JSON[_0xc8be39(0x210)](_0x2eb9b4,null,0x2));try{const _0x3ac74c=_0x2eb9b4['status'],_0x44748c=_0x2eb9b4[_0xc8be39(0x202)],_0x45c155=_0x2eb9b4[_0xc8be39(0x232)],_0x1580fb=_0x2eb9b4['payment_method'],_0x1545c1=_0x2eb9b4[_0xc8be39(0x318)],_0x449083=_0x2eb9b4['currency'],_0x28d3ef=_0x2eb9b4['commission'],_0x14eec6=_0x2eb9b4[_0xc8be39(0x2d6)];if(!_0x44748c){console[_0xc8be39(0x324)](_0xc8be39(0x2f7));throw new Error(_0xc8be39(0x233));}console['log'](_0xc8be39(0x241),{'status':_0x3ac74c,'clientTransactionId':_0x44748c,'systemId':_0x45c155,'paymentMethod':_0x1580fb,'amount':_0x1545c1,'currency':_0x449083,'commission':_0x28d3ef,'statusAdditionInfo':_0x14eec6});const _0x49c418=await database_1[_0xc8be39(0x29a)][_0xc8be39(0x27b)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x44748c},{'orderId':_0x44748c},{'id':_0x44748c},{'gatewayPaymentId':_0x44748c}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x49c418){console[_0xc8be39(0x324)](_0xc8be39(0x2f6)+_0x44748c);throw new Error(_0xc8be39(0x2ba)+_0x44748c);}console[_0xc8be39(0x301)](_0xc8be39(0x25e)+_0x49c418['id']+'\x20for\x20AmPay\x20TRY\x20webhook'),console[_0xc8be39(0x301)]('📊\x20Payment\x20status:\x20'+_0x49c418['status']+'\x20→\x20'+_0x3ac74c),_0x3ac74c===_0xc8be39(0x304)?(console['log'](_0xc8be39(0x2d4)),await this[_0xc8be39(0x251)](_0x49c418['id'],'FAILED'),console[_0xc8be39(0x301)](_0xc8be39(0x295)+_0x49c418['id']+_0xc8be39(0x278)),console[_0xc8be39(0x301)](_0xc8be39(0x244)+(_0x14eec6||_0xc8be39(0x319)))):console[_0xc8be39(0x301)](_0xc8be39(0x24e)+_0x3ac74c+_0xc8be39(0x222)),await database_1['default']['webhookLog'][_0xc8be39(0x2e7)]({'data':{'paymentId':_0x49c418['id'],'shopId':_0x49c418[_0xc8be39(0x297)],'event':_0xc8be39(0x32c)+(_0x3ac74c?.[_0xc8be39(0x256)]()||_0xc8be39(0x1ed)),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x2eb9b4)}}),loggerService_1['loggerService'][_0xc8be39(0x290)](_0xc8be39(0x327),_0x49c418['id'],_0x49c418[_0xc8be39(0x287)],_0x3ac74c===_0xc8be39(0x304)?'FAILED':_0x3ac74c,_0x2eb9b4);}catch(_0x1bc9c7){console[_0xc8be39(0x324)](_0xc8be39(0x235),_0x1bc9c7),loggerService_1[_0xc8be39(0x23e)][_0xc8be39(0x321)](_0xc8be39(0x327),_0x1bc9c7,_0x2eb9b4);throw _0x1bc9c7;}}async['sendShopWebhook'](_0x381fa7,_0x25dc48){const _0x4429af=a66_0x41595f,_0x454253=Date[_0x4429af(0x254)]();try{const _0x444961=_0x381fa7[_0x4429af(0x2f9)],_0x66fb20=_0x444961['settings'];if(!_0x66fb20?.[_0x4429af(0x30f)]){console[_0x4429af(0x301)](_0x4429af(0x329)+_0x444961['id']);return;}const _0x13206f=_0x25dc48===_0x4429af(0x2fb)?'payment.success':_0x25dc48==='FAILED'?'payment.failed':_0x25dc48==='EXPIRED'?_0x4429af(0x2fa):_0x25dc48===_0x4429af(0x2cf)?_0x4429af(0x2fa):_0x25dc48===_0x4429af(0x239)?_0x4429af(0x2fa):_0x4429af(0x31f);let _0x41b02f=[];if(_0x66fb20[_0x4429af(0x21d)])try{_0x41b02f=Array['isArray'](_0x66fb20[_0x4429af(0x21d)])?_0x66fb20['webhookEvents']:JSON[_0x4429af(0x225)](_0x66fb20[_0x4429af(0x21d)]);}catch(_0x3b4321){console['error']('Error\x20parsing\x20webhook\x20events:',_0x3b4321),_0x41b02f=[];}if(!_0x41b02f[_0x4429af(0x30c)](_0x13206f)){console[_0x4429af(0x301)](_0x4429af(0x2db)+_0x13206f+'\x20not\x20enabled\x20for\x20shop\x20'+_0x444961['id']);return;}const _0x216234={'event':_0x13206f,'payment':{'id':_0x381fa7['id'],'order_id':_0x381fa7[_0x4429af(0x2ca)],'gateway_order_id':_0x381fa7[_0x4429af(0x23c)],'gateway':_0x381fa7[_0x4429af(0x221)],'amount':_0x381fa7['amount'],'currency':_0x381fa7[_0x4429af(0x20a)],'status':_0x25dc48[_0x4429af(0x256)](),'customer_email':_0x381fa7[_0x4429af(0x305)],'customer_name':_0x381fa7[_0x4429af(0x2bd)],'failure_message':_0x381fa7['failureMessage'],'tx_urls':_0x381fa7[_0x4429af(0x294)]?JSON[_0x4429af(0x225)](_0x381fa7['txUrls']):null,'created_at':_0x381fa7[_0x4429af(0x1f1)],'updated_at':_0x381fa7[_0x4429af(0x2de)]}},_0x258636=await fetch(_0x66fb20[_0x4429af(0x30f)],{'method':_0x4429af(0x2d3),'headers':{'Content-Type':'application/json','User-Agent':_0x4429af(0x1fd)},'body':JSON[_0x4429af(0x210)](_0x216234)}),_0x2ecd91=Date[_0x4429af(0x254)]()-_0x454253,_0x5ab816=_0x258636['ok']?_0x4429af(0x26b):await _0x258636['text']();loggerService_1[_0x4429af(0x23e)][_0x4429af(0x237)](_0x381fa7[_0x4429af(0x297)],_0x66fb20['webhookUrl'],_0x13206f,_0x258636['status'],_0x2ecd91,_0x216234),console[_0x4429af(0x301)](_0x4429af(0x2c2)+_0x66fb20[_0x4429af(0x30f)]+_0x4429af(0x2b4)+_0x258636[_0x4429af(0x287)]+'\x20('+_0x2ecd91+_0x4429af(0x27c));}catch(_0x2ece8c){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x2ece8c),loggerService_1['loggerService']['logShopWebhookError'](_0x381fa7[_0x4429af(0x297)],_0x381fa7[_0x4429af(0x2f9)]?.[_0x4429af(0x21f)]?.[_0x4429af(0x30f)]||_0x4429af(0x1ed),_0x4429af(0x2ac),_0x2ece8c,{});}}async[a66_0x41595f(0x204)](_0x1af05a,_0xbd239e){const _0x28325d=a66_0x41595f;try{const _0x482338={'PENDING':_0x28325d(0x1f4),'PROCESSING':_0x28325d(0x1f3),'PAID':_0x28325d(0x20d),'FAILED':_0x28325d(0x24c),'EXPIRED':'expired','REFUND':_0x28325d(0x26c),'CHARGEBACK':'chargeback'},_0x3bece0=_0x482338[_0xbd239e];if(!_0x3bece0||_0x3bece0===_0x28325d(0x1f4))return;await telegramBotService_1[_0x28325d(0x312)]['sendPaymentNotification'](_0x1af05a[_0x28325d(0x297)],_0x1af05a,_0x3bece0);}catch(_0x2c9bcc){console[_0x28325d(0x324)](_0x28325d(0x28f),_0x2c9bcc);}}async['getGatewayCommission'](_0x3748fe,_0x3b680b){const _0x59beac=a66_0x41595f;try{const _0x1ad801=await database_1[_0x59beac(0x29a)][_0x59beac(0x2f9)]['findUnique']({'where':{'id':_0x3748fe},'select':{'gatewaySettings':!![]}});if(!_0x1ad801?.['gatewaySettings'])return console[_0x59beac(0x301)](_0x59beac(0x270)+_0x3748fe+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x1bf4b=JSON[_0x59beac(0x225)](_0x1ad801[_0x59beac(0x296)]);for(const [_0x1f3391,_0x338c67]of Object['entries'](_0x1bf4b)){if(_0x1f3391['toLowerCase']()===_0x3b680b[_0x59beac(0x256)]()){const _0x4fa02f=_0x338c67['commission']||0xa;return console[_0x59beac(0x301)](_0x59beac(0x289)+_0x3b680b+'\x20commission\x20for\x20shop\x20'+_0x3748fe+':\x20'+_0x4fa02f+'%'),_0x4fa02f;}}return console[_0x59beac(0x301)](_0x59beac(0x2a9)+_0x3b680b+_0x59beac(0x2ea)+_0x3748fe+_0x59beac(0x2ec)),0xa;}catch(_0x1a0b09){return console[_0x59beac(0x324)](_0x59beac(0x316)+_0x3748fe+_0x59beac(0x2bf)+_0x3b680b+':',_0x1a0b09),0xa;}}async[a66_0x41595f(0x227)](_0x471c66,_0x3965a8){const _0x4f30ca=a66_0x41595f;console[_0x4f30ca(0x301)](_0x4f30ca(0x2a4)),console[_0x4f30ca(0x301)](_0x4f30ca(0x201),JSON[_0x4f30ca(0x210)](_0x471c66,null,0x2)),console[_0x4f30ca(0x301)](_0x4f30ca(0x293),JSON[_0x4f30ca(0x210)](_0x3965a8,null,0x2));try{const _0x4d3b69=_0x471c66[_0x4f30ca(0x1ee)]||_0x3965a8['customerOrderId'],_0xf528e4=_0x471c66[_0x4f30ca(0x287)]||_0x3965a8['status'],_0x1e18ad=_0x471c66[_0x4f30ca(0x318)]||_0x3965a8[_0x4f30ca(0x318)],_0x5bd58f=_0x471c66[_0x4f30ca(0x20a)]||_0x3965a8[_0x4f30ca(0x20a)],_0x3b0706=_0x471c66['dateTime']||_0x3965a8[_0x4f30ca(0x2a2)];if(!_0x4d3b69){console['error'](_0x4f30ca(0x302));throw new Error(_0x4f30ca(0x2f4));}console[_0x4f30ca(0x301)](_0x4f30ca(0x282),{'customerOrderId':_0x4d3b69,'status':_0xf528e4,'amount':_0x1e18ad,'currency':_0x5bd58f,'dateTime':_0x3b0706});const _0x175de8=await database_1[_0x4f30ca(0x29a)][_0x4f30ca(0x27b)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x4d3b69},{'orderId':_0x4d3b69},{'id':_0x4d3b69},{'gatewayPaymentId':_0x4d3b69}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x175de8){console[_0x4f30ca(0x324)](_0x4f30ca(0x30d)+_0x4d3b69);throw new Error(_0x4f30ca(0x2ba)+_0x4d3b69);}console[_0x4f30ca(0x301)]('✅\x20Found\x20payment\x20'+_0x175de8['id']+_0x4f30ca(0x2f5)),console[_0x4f30ca(0x301)](_0x4f30ca(0x29e)+_0x175de8[_0x4f30ca(0x287)]+_0x4f30ca(0x206)+_0xf528e4);let _0x578407=_0xf528e4?.['toUpperCase']();_0xf528e4===_0x4f30ca(0x238)||_0xf528e4===_0x4f30ca(0x274)?(_0x578407='FAILED',console['log'](_0x4f30ca(0x22e)+_0xf528e4+_0x4f30ca(0x1fe)),await this[_0x4f30ca(0x251)](_0x175de8['id'],_0x578407),console[_0x4f30ca(0x301)](_0x4f30ca(0x268)+_0x175de8['id']+_0x4f30ca(0x278))):console[_0x4f30ca(0x301)](_0x4f30ca(0x306)+_0xf528e4+'\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)'),await database_1[_0x4f30ca(0x29a)]['webhookLog'][_0x4f30ca(0x2e7)]({'data':{'paymentId':_0x175de8['id'],'shopId':_0x175de8[_0x4f30ca(0x297)],'event':_0x4f30ca(0x2b2)+(_0xf528e4?.[_0x4f30ca(0x256)]()||_0x4f30ca(0x1ed)),'statusCode':0xc8,'responseBody':JSON[_0x4f30ca(0x210)]({'queryParams':_0x471c66,'bodyData':_0x3965a8})}}),loggerService_1[_0x4f30ca(0x23e)]['logWebhookProcessed'](_0x4f30ca(0x27e),_0x175de8['id'],_0x175de8[_0x4f30ca(0x287)],_0x578407||_0xf528e4,{'queryParams':_0x471c66,'bodyData':_0x3965a8});}catch(_0x3b279f){console[_0x4f30ca(0x324)](_0x4f30ca(0x2d9),_0x3b279f),loggerService_1[_0x4f30ca(0x23e)][_0x4f30ca(0x321)](_0x4f30ca(0x27e),_0x3b279f,{'queryParams':_0x471c66,'bodyData':_0x3965a8});throw _0x3b279f;}}}exports[a66_0x41595f(0x292)]=WebhookService;