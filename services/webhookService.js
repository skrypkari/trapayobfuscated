'use strict';const a60_0x2f64e0=a60_0x24e2;function a60_0x24e2(_0x486356,_0x55f53f){const _0x4ad27e=a60_0x4ad2();return a60_0x24e2=function(_0x24e263,_0x10d2c7){_0x24e263=_0x24e263-0x85;let _0x4bd85d=_0x4ad27e[_0x24e263];return _0x4bd85d;},a60_0x24e2(_0x486356,_0x55f53f);}(function(_0x432198,_0x283be4){const _0x4d14bf=a60_0x24e2,_0xe092bf=_0x432198();while(!![]){try{const _0x1276f1=-parseInt(_0x4d14bf(0x8e))/0x1+-parseInt(_0x4d14bf(0xd9))/0x2*(-parseInt(_0x4d14bf(0x14d))/0x3)+parseInt(_0x4d14bf(0x14c))/0x4+-parseInt(_0x4d14bf(0x158))/0x5+-parseInt(_0x4d14bf(0x10b))/0x6*(parseInt(_0x4d14bf(0xe2))/0x7)+-parseInt(_0x4d14bf(0xc4))/0x8+parseInt(_0x4d14bf(0xfb))/0x9;if(_0x1276f1===_0x283be4)break;else _0xe092bf['push'](_0xe092bf['shift']());}catch(_0x42e622){_0xe092bf['push'](_0xe092bf['shift']());}}}(a60_0x4ad2,0x7923a));var __importDefault=this&&this[a60_0x2f64e0(0x138)]||function(_0x1f723c){const _0x116178=a60_0x2f64e0;return _0x1f723c&&_0x1f723c[_0x116178(0xa3)]?_0x1f723c:{'default':_0x1f723c};};Object[a60_0x2f64e0(0x90)](exports,a60_0x2f64e0(0xa3),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a60_0x2f64e0(0x150))),plisioService_1=require(a60_0x2f64e0(0x121)),rapydService_1=require(a60_0x2f64e0(0x148)),nodaService_1=require(a60_0x2f64e0(0x106)),coinToPayService_1=require(a60_0x2f64e0(0xe0)),coinToPay2Service_1=require(a60_0x2f64e0(0xd2)),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a60_0x2f64e0(0xd7)),amerService_1=require('./gateways/amerService'),telegramBotService_1=require('./telegramBotService'),currencyService_1=require(a60_0x2f64e0(0x122)),loggerService_1=require(a60_0x2f64e0(0x166));function a60_0x4ad2(){const _0x418783=['MasterCardService','4247310YObtNA','toISOString','üì§\x20Shop\x20webhook\x20sent\x20to\x20','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','Error\x20processing\x20CoinToPay2\x20webhook:','telegramBotService','webhook_status_change_','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','FAILED','gateway','RapydService','default','TesSoft\x20Payment\x20System/1.0','logWebhookError','./loggerService','remitterName','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','txUrls','\x20and\x20-','bankId','üìä\x20MasterCard\x20webhook\x20result:','PAID','\x22,\x20paymentLinkId=\x22','convertToUSDT','üîÑ\x20Additional\x20data:','logWebhookProcessed','üîÑ\x20Processing\x20Noda\x20webhook:','Error\x20processing\x20CoinToPay\x20webhook:','‚ùå\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','processAmerWebhook','Payment\x20not\x20found','logShopWebhookSent','296041XGCmKM','\x20commission:\x20','defineProperty','shop','findUnique','EXPIRED','entries','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','CoinToPayService','\x20-\x20','processRapydWebhook','log','coinToPay2Service','\x20not\x20found','amer','chargeback','\x20balance\x20updated:\x20','plisio','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','__esModule','%\x20gateway\x20commission)','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','toFixed',',\x20status=','paymentLinkId','üìä\x20CoinToPay\x20webhook:\x20Payment\x20','webhook_send','üí∞\x20Gateway\x20','no\x20balance\x20change','webhookUrl','üìä\x20KLYME\x20webhook:\x20Payment\x20','sendPaymentStatusNotification','Gateway\x20','sendShopWebhook','noda','\x20to\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Error\x20parsing\x20webhook\x20events:','CHARGEBACK','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','processPlisioGatewayWebhook','username','‚ùå\x20Available\x20webhook\x20fields:','amount','now','\x20USDT\x20(chargeback\x20penalty)',':\x20type=','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','üîÑ\x20Processing\x20Rapyd\x20webhook:','No\x20specific\x20commission\x20found\x20for\x20gateway\x20',',\x20using\x20default\x20commission\x2010%','SINGLE','1798424MHIvpu','updatePaymentStatus','settings','\x22,\x20newStatus=\x22','currencyService','paymentMethod','üìà\x20Payment\x20','rapyd','\x20=\x20','paymentLink','failed','unknown','amountUSDT','Error\x20processing\x20KLYME\x20webhook:','./gateways/coinToPay2Service','update','status','üìù\x20Reason:\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','./gateways/mastercardService','üìä\x20Amer\x20webhook:\x20Payment\x20','128306jodBmX','type','‚ùå\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','cointopay2','üìà\x20Found\x20payment\x20link\x20','parse','create','./gateways/coinToPayService','isArray','7hNsUtq','additionalInfo','üí∞\x20Adding\x20to\x20balance:\x20','masterCardService','processCoinToPay2Webhook','findFirst','updatedAt','paymentId','balance','gatewayOrderId','payment.pending','paid','customerName','gatewaySettings','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','üìä\x20Plisio\x20webhook:\x20Payment\x20','\x20->\x20','plisioService','Payment\x20','\x20status\x20','createdAt','üîÑ\x20updatePaymentStatus\x20called:\x20paymentId=','application/json','amountAfterGatewayCommissionUSDT','üîÑ\x20Processing\x20Amer\x20webhook:','19003896ZTyFtV','üîÑ\x20Processing\x20Plisio\x20webhook:','üìä\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','logShopWebhookError','POST','\x20not\x20enabled\x20for\x20shop\x20','nodaService','Failed\x20to\x20send\x20shop\x20webhook:','loggerService','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','./gateways/nodaService','commission','klymeService','payment','üîÑ\x20Processing\x20KLYME\x20webhook:','4579914GQqLKw','processMasterCardWebhook','üîç\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','getGatewayCommission','mastercard','\x20updated:\x20currentPayments=','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','coinToPayService','findMany','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','üîÑ\x20Processing\x20CoinToPay\x20webhook:','failureMessage','Error\x20processing\x20Plisio\x20webhook:','\x20commission\x20for\x20shop\x20','plisio_gateway','\x20in\x20shop\x20','\x20current\x20balance:\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','remitterIban','amerService','includes','./gateways/plisioService','./currencyService','No\x20payment\x20ID\x20in\x20Amer\x20webhook','stringify','processPlisioWebhook','webhookEvents','‚úÖ\x20Shop\x20','rapydService','‚ùå\x20Error\x20processing\x20Amer\x20webhook:','üìä\x20Amer\x20webhook\x20result:','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','Found\x20payment\x20','üîÑ\x20Processing\x20CoinToPay2\x20webhook:','shopId','\x20USDT','toUpperCase','üìà\x20Payment\x20details:\x20oldStatus=\x22','payment.failed','orderId',',\x20currentPayments=','processWebhook','üìä\x20Rapyd\x20webhook:\x20Payment\x20','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','__importDefault','sendPaymentNotification','payment.success','CoinToPay2Service','toLowerCase','‚ùå\x20Error\x20processing\x20MasterCard\x20webhook:','created','üîç\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20',',\x20gateway\x20','text','currentPayments','WebhookService','üîç\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','keys','paidAt','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','./gateways/rapydService','No\x20payment\x20ID\x20in\x20Noda\x20webhook','expired','üí∏\x20Additional\x20chargeback\x20penalty:\x20-','1816456fTSIiz','3rXkyNc','üîç\x20Search\x20result:\x20','error','../config/database',',\x20using\x20default\x2010%','cardLast4','customerEmail','processCoinToPayWebhook','üîç\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','currency'];a60_0x4ad2=function(){return _0x418783;};return a60_0x4ad2();}class WebhookService{constructor(){const _0x1e54da=a60_0x2f64e0;this[_0x1e54da(0xf3)]=new plisioService_1['PlisioService'](),this['rapydService']=new rapydService_1[(_0x1e54da(0x162))](),this[_0x1e54da(0x101)]=new nodaService_1['NodaService'](),this['coinToPayService']=new coinToPayService_1[(_0x1e54da(0x97))](),this[_0x1e54da(0x9b)]=new coinToPay2Service_1[(_0x1e54da(0x13b))](),this[_0x1e54da(0x108)]=new klymeService_1['KlymeService'](),this[_0x1e54da(0xe5)]=new mastercardService_1[(_0x1e54da(0x157))](),this[_0x1e54da(0x11f)]=new amerService_1['AmerService']();}async['updatePaymentStatus'](_0x36d50a,_0x3c30a0,_0x434479){const _0x3cc2ad=a60_0x2f64e0;console[_0x3cc2ad(0x9a)](_0x3cc2ad(0xf7)+_0x36d50a+',\x20newStatus='+_0x3c30a0),console[_0x3cc2ad(0x9a)](_0x3cc2ad(0x86),_0x434479),await database_1[_0x3cc2ad(0x163)]['$transaction'](async _0x51ae67=>{const _0x1be4a0=_0x3cc2ad,_0x14e9ef=await _0x51ae67[_0x1be4a0(0x109)][_0x1be4a0(0x92)]({'where':{'id':_0x36d50a},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x14e9ef)throw new Error(_0x1be4a0(0xf4)+_0x36d50a+_0x1be4a0(0x9c));const _0x1ced7d=_0x14e9ef[_0x1be4a0(0xd4)],_0x69188a=_0x14e9ef['shop'];console['log']('üí∞\x20Payment\x20'+_0x36d50a+':\x20'+_0x1ced7d+_0x1be4a0(0xf2)+_0x3c30a0),console[_0x1be4a0(0x9a)]('üè™\x20Shop\x20'+_0x69188a[_0x1be4a0(0xb9)]+_0x1be4a0(0x11c)+_0x69188a['balance']+_0x1be4a0(0x12f));const _0x30575e={'status':_0x3c30a0['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x434479?.[_0x1be4a0(0x117)]&&(_0x30575e['failureMessage']=_0x434479[_0x1be4a0(0x117)]);_0x434479?.['txUrls']&&(_0x30575e['txUrls']=JSON[_0x1be4a0(0x124)](_0x434479[_0x1be4a0(0x169)]));_0x434479?.[_0x1be4a0(0x152)]&&(_0x30575e[_0x1be4a0(0x152)]=_0x434479[_0x1be4a0(0x152)]);_0x434479?.[_0x1be4a0(0xc9)]&&(_0x30575e['paymentMethod']=_0x434479[_0x1be4a0(0xc9)]);_0x434479?.['bankId']&&(_0x30575e[_0x1be4a0(0x16b)]=_0x434479[_0x1be4a0(0x16b)]);_0x434479?.[_0x1be4a0(0x11e)]&&(_0x30575e[_0x1be4a0(0x11e)]=_0x434479[_0x1be4a0(0x11e)]);_0x434479?.['remitterName']&&(_0x30575e[_0x1be4a0(0x167)]=_0x434479[_0x1be4a0(0x167)]);let _0x1ca1c7=_0x69188a['balance'],_0x16cdac='';if(_0x3c30a0[_0x1be4a0(0x130)]()===_0x1be4a0(0x16d)&&_0x1ced7d!==_0x1be4a0(0x16d)){const _0x2bd4f8=await currencyService_1[_0x1be4a0(0xc8)][_0x1be4a0(0x85)](_0x14e9ef[_0x1be4a0(0xbb)],_0x14e9ef[_0x1be4a0(0x156)]),_0x4e78d8=await this[_0x1be4a0(0x10e)](_0x69188a['id'],_0x14e9ef[_0x1be4a0(0x161)]),_0x183f9a=_0x2bd4f8*(0x1-_0x4e78d8/0x64);_0x1ca1c7+=_0x183f9a,_0x16cdac='+'+_0x183f9a['toFixed'](0x6)+_0x1be4a0(0x111)+_0x4e78d8+_0x1be4a0(0xa4),_0x30575e[_0x1be4a0(0xd0)]=_0x2bd4f8,_0x30575e[_0x1be4a0(0xf9)]=_0x183f9a,_0x30575e[_0x1be4a0(0x146)]=new Date(),console['log']('üí∞\x20Converting\x20'+_0x14e9ef[_0x1be4a0(0xbb)]+'\x20'+_0x14e9ef['currency']+'\x20->\x20'+_0x2bd4f8[_0x1be4a0(0xa6)](0x6)+'\x20USDT'),console[_0x1be4a0(0x9a)](_0x1be4a0(0xab)+_0x14e9ef[_0x1be4a0(0x161)]+_0x1be4a0(0x8f)+_0x4e78d8+'%'),console['log'](_0x1be4a0(0xbf)+_0x183f9a[_0x1be4a0(0xa6)](0x6)+_0x1be4a0(0x12f)),console[_0x1be4a0(0x9a)](_0x1be4a0(0xe4)+_0x69188a[_0x1be4a0(0xea)]+'\x20+\x20'+_0x183f9a['toFixed'](0x6)+_0x1be4a0(0xcc)+_0x1ca1c7[_0x1be4a0(0xa6)](0x6)+_0x1be4a0(0x12f));}else{if(_0x1ced7d==='PAID'&&_0x3c30a0[_0x1be4a0(0x130)]()!==_0x1be4a0(0x16d)){let _0x42a1c9;if(_0x14e9ef[_0x1be4a0(0xf9)])_0x42a1c9=_0x14e9ef[_0x1be4a0(0xf9)];else{if(_0x14e9ef['amountUSDT']){const _0x55f7e6=await this[_0x1be4a0(0x10e)](_0x69188a['id'],_0x14e9ef[_0x1be4a0(0x161)]);_0x42a1c9=_0x14e9ef[_0x1be4a0(0xd0)]*(0x1-_0x55f7e6/0x64);}else console[_0x1be4a0(0x9a)](_0x1be4a0(0x96)),_0x42a1c9=0x0;}_0x42a1c9>0x0&&(_0x1ca1c7-=_0x42a1c9,_0x16cdac='-'+_0x42a1c9['toFixed'](0x6)+_0x1be4a0(0x12b),_0x30575e[_0x1be4a0(0xd0)]=null,_0x30575e['amountAfterGatewayCommissionUSDT']=null,_0x30575e[_0x1be4a0(0x146)]=null,console[_0x1be4a0(0x9a)]('üí∞\x20Removing\x20from\x20balance:\x20'+_0x69188a[_0x1be4a0(0xea)]+_0x1be4a0(0x98)+_0x42a1c9['toFixed'](0x6)+_0x1be4a0(0xcc)+_0x1ca1c7[_0x1be4a0(0xa6)](0x6)+_0x1be4a0(0x12f)));}}if(_0x3c30a0[_0x1be4a0(0x130)]()===_0x1be4a0(0xb6)){const _0xb25488=_0x434479?.['chargebackAmount']||0x0;_0xb25488>0x0&&(_0x1ca1c7-=_0xb25488,_0x16cdac+=_0x1be4a0(0x16a)+_0xb25488[_0x1be4a0(0xa6)](0x6)+_0x1be4a0(0xbd),_0x30575e['chargebackAmount']=_0xb25488,console[_0x1be4a0(0x9a)](_0x1be4a0(0x14b)+_0xb25488['toFixed'](0x6)+_0x1be4a0(0x12f)),console[_0x1be4a0(0x9a)]('üí∞\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x1ca1c7[_0x1be4a0(0xa6)](0x6)+'\x20USDT'));}const _0xbcc77f=await _0x51ae67[_0x1be4a0(0x109)][_0x1be4a0(0xd3)]({'where':{'id':_0x36d50a},'data':_0x30575e});_0x1ca1c7!==_0x69188a['balance']&&(await _0x51ae67[_0x1be4a0(0x91)][_0x1be4a0(0xd3)]({'where':{'id':_0x69188a['id']},'data':{'balance':_0x1ca1c7}}),console[_0x1be4a0(0x9a)](_0x1be4a0(0x127)+_0x69188a[_0x1be4a0(0xb9)]+_0x1be4a0(0x9f)+_0x69188a[_0x1be4a0(0xea)][_0x1be4a0(0xa6)](0x6)+_0x1be4a0(0xf2)+_0x1ca1c7[_0x1be4a0(0xa6)](0x6)+_0x1be4a0(0x12f)),console[_0x1be4a0(0x9a)](_0x1be4a0(0xd5)+_0x16cdac));await _0x51ae67['webhookLog'][_0x1be4a0(0xdf)]({'data':{'paymentId':_0x36d50a,'shopId':_0x69188a['id'],'event':_0x1be4a0(0x15e)+_0x3c30a0[_0x1be4a0(0x13c)](),'statusCode':0xc8,'responseBody':JSON[_0x1be4a0(0x124)]({'oldStatus':_0x1ced7d,'newStatus':_0x3c30a0[_0x1be4a0(0x130)](),'balanceChange':_0x16cdac||_0x1be4a0(0xac),'oldBalance':_0x69188a[_0x1be4a0(0xea)],'newBalance':_0x1ca1c7,'amountUSDT':_0x30575e['amountUSDT'],'additionalData':_0x434479,'timestamp':new Date()[_0x1be4a0(0x159)]()})}}),await this[_0x1be4a0(0xb1)]({..._0x14e9ef,..._0xbcc77f,'shop':_0x69188a},_0x3c30a0['toUpperCase']()),await this['sendPaymentStatusNotification']({..._0x14e9ef,..._0xbcc77f},_0x3c30a0['toUpperCase']());if(_0x1ced7d!==_0x1be4a0(0x16d)&&_0x3c30a0['toUpperCase']()===_0x1be4a0(0x16d)){console[_0x1be4a0(0x9a)](_0x1be4a0(0xca)+_0x36d50a+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console['log'](_0x1be4a0(0x131)+_0x1ced7d+_0x1be4a0(0xc7)+_0x3c30a0['toUpperCase']()+_0x1be4a0(0x16e)+_0x14e9ef[_0x1be4a0(0xa8)]+'\x22');if(_0x14e9ef[_0x1be4a0(0xa8)])try{const _0x445109=await _0x51ae67[_0x1be4a0(0xcd)][_0x1be4a0(0x92)]({'where':{'id':_0x14e9ef[_0x1be4a0(0xa8)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x445109){console[_0x1be4a0(0x9a)](_0x1be4a0(0xdd)+_0x445109['id']+_0x1be4a0(0xbe)+_0x445109[_0x1be4a0(0xda)]+_0x1be4a0(0x134)+_0x445109[_0x1be4a0(0x142)]+',\x20status='+_0x445109[_0x1be4a0(0xd4)]);const _0x49c08c=_0x445109[_0x1be4a0(0x142)]+0x1,_0x2f9591=_0x445109[_0x1be4a0(0xda)]===_0x1be4a0(0xc3)?'COMPLETED':_0x445109[_0x1be4a0(0xd4)];await _0x51ae67[_0x1be4a0(0xcd)]['update']({'where':{'id':_0x14e9ef[_0x1be4a0(0xa8)]},'data':{'currentPayments':_0x49c08c,'status':_0x2f9591,'updatedAt':new Date()}}),console['log']('‚úÖ\x20Payment\x20link\x20'+_0x445109['id']+_0x1be4a0(0x110)+_0x445109[_0x1be4a0(0x142)]+_0x1be4a0(0xf2)+_0x49c08c+_0x1be4a0(0xa7)+_0x445109[_0x1be4a0(0xd4)]+_0x1be4a0(0xf2)+_0x2f9591);}else console[_0x1be4a0(0x9a)]('‚ùå\x20Payment\x20link\x20'+_0x14e9ef['paymentLinkId']+_0x1be4a0(0x9c));}catch(_0x26f245){console['error'](_0x1be4a0(0x95),_0x26f245);}else console[_0x1be4a0(0x9a)]('üìà\x20Payment\x20'+_0x36d50a+_0x1be4a0(0x11d));}else console[_0x1be4a0(0x9a)]('üìà\x20Payment\x20'+_0x36d50a+_0x1be4a0(0x115)+_0x1ced7d+'\x20->\x20'+_0x3c30a0[_0x1be4a0(0x130)]());});}async[a60_0x2f64e0(0x125)](_0x1510f6){const _0x176f09=a60_0x2f64e0;console[_0x176f09(0x9a)](_0x176f09(0xfc),_0x1510f6);try{const _0x588da1=await this[_0x176f09(0xf3)][_0x176f09(0x135)](_0x1510f6);if(!_0x588da1['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x53280a=await database_1[_0x176f09(0x163)][_0x176f09(0x109)]['findFirst']({'where':{'gatewayOrderId':_0x588da1[_0x176f09(0xe9)]}});if(!_0x53280a){console[_0x176f09(0x14f)]('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x588da1[_0x176f09(0xe9)]);return;}console[_0x176f09(0x9a)](_0x176f09(0xf1)+_0x53280a['id']+_0x176f09(0xf5)+_0x588da1[_0x176f09(0xd4)]),await this[_0x176f09(0xc5)](_0x53280a['id'],_0x588da1[_0x176f09(0xd4)],{'txUrls':_0x588da1[_0x176f09(0x169)]}),loggerService_1[_0x176f09(0x103)]['logWebhookProcessed'](_0x176f09(0xa0),_0x53280a['id'],_0x53280a[_0x176f09(0xd4)],_0x588da1[_0x176f09(0xd4)],_0x1510f6);}catch(_0x55b080){console[_0x176f09(0x14f)](_0x176f09(0x118),_0x55b080),loggerService_1[_0x176f09(0x103)][_0x176f09(0x165)](_0x176f09(0xa0),_0x55b080,_0x1510f6);throw _0x55b080;}}async[a60_0x2f64e0(0xb8)](_0x3bde50){const _0x6c4798=a60_0x2f64e0;console['log']('üîÑ\x20Processing\x20Plisio\x20Gateway\x20webhook:',_0x3bde50);try{const _0x17331d=await this['plisioService'][_0x6c4798(0x135)](_0x3bde50);if(!_0x17331d[_0x6c4798(0xe9)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x564558=await database_1[_0x6c4798(0x163)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x17331d[_0x6c4798(0xe9)]}});if(!_0x564558){console[_0x6c4798(0x14f)](_0x6c4798(0xf0)+_0x17331d[_0x6c4798(0xe9)]);return;}console[_0x6c4798(0x9a)](_0x6c4798(0xfd)+_0x564558['id']+_0x6c4798(0xf5)+_0x17331d[_0x6c4798(0xd4)]),await this['updatePaymentStatus'](_0x564558['id'],_0x17331d['status'],{'txUrls':_0x17331d[_0x6c4798(0x169)]}),loggerService_1[_0x6c4798(0x103)][_0x6c4798(0x87)](_0x6c4798(0x11a),_0x564558['id'],_0x564558[_0x6c4798(0xd4)],_0x17331d[_0x6c4798(0xd4)],_0x3bde50);}catch(_0x497473){console[_0x6c4798(0x14f)](_0x6c4798(0x147),_0x497473),loggerService_1[_0x6c4798(0x103)][_0x6c4798(0x165)](_0x6c4798(0x11a),_0x497473,_0x3bde50);throw _0x497473;}}async[a60_0x2f64e0(0x99)](_0x4b0eb9){const _0x569d3e=a60_0x2f64e0;console[_0x569d3e(0x9a)](_0x569d3e(0xc0),_0x4b0eb9);try{const _0x2e9499=await this[_0x569d3e(0x128)][_0x569d3e(0x135)](_0x4b0eb9);if(!_0x2e9499['paymentId'])throw new Error(_0x569d3e(0xa2));const _0x245be1=await database_1[_0x569d3e(0x163)][_0x569d3e(0x109)][_0x569d3e(0xe7)]({'where':{'gatewayOrderId':_0x2e9499['paymentId']}});if(!_0x245be1){console[_0x569d3e(0x14f)](_0x569d3e(0xa5)+_0x2e9499['paymentId']);return;}console['log'](_0x569d3e(0x136)+_0x245be1['id']+'\x20status\x20'+_0x2e9499['status']),await this[_0x569d3e(0xc5)](_0x245be1['id'],_0x2e9499[_0x569d3e(0xd4)],{'failureMessage':_0x2e9499[_0x569d3e(0x117)],'cardLast4':_0x2e9499['additionalInfo']?.[_0x569d3e(0x152)],'paymentMethod':_0x2e9499['additionalInfo']?.[_0x569d3e(0xc9)]}),loggerService_1['loggerService'][_0x569d3e(0x87)](_0x569d3e(0xcb),_0x245be1['id'],_0x245be1[_0x569d3e(0xd4)],_0x2e9499[_0x569d3e(0xd4)],_0x4b0eb9);}catch(_0x2e8e2a){console[_0x569d3e(0x14f)]('Error\x20processing\x20Rapyd\x20webhook:',_0x2e8e2a),loggerService_1[_0x569d3e(0x103)]['logWebhookError']('rapyd',_0x2e8e2a,_0x4b0eb9);throw _0x2e8e2a;}}async['processNodaWebhook'](_0xa69640){const _0x22e6cf=a60_0x2f64e0;console[_0x22e6cf(0x9a)](_0x22e6cf(0x88),_0xa69640);try{const _0x58d5d0=await this[_0x22e6cf(0x101)][_0x22e6cf(0x135)](_0xa69640);if(!_0x58d5d0[_0x22e6cf(0xe9)])throw new Error(_0x22e6cf(0x149));const _0x1f7399=await database_1[_0x22e6cf(0x163)]['payment'][_0x22e6cf(0xe7)]({'where':{'gatewayOrderId':_0x58d5d0[_0x22e6cf(0xe9)]}});if(!_0x1f7399){console[_0x22e6cf(0x14f)](_0x22e6cf(0x15b)+_0x58d5d0[_0x22e6cf(0xe9)]);return;}console[_0x22e6cf(0x9a)]('üìä\x20Noda\x20webhook:\x20Payment\x20'+_0x1f7399['id']+_0x22e6cf(0xf5)+_0x58d5d0[_0x22e6cf(0xd4)]),await this[_0x22e6cf(0xc5)](_0x1f7399['id'],_0x58d5d0['status'],{'bankId':_0x58d5d0[_0x22e6cf(0xe3)]?.[_0x22e6cf(0x16b)],'remitterIban':_0x58d5d0[_0x22e6cf(0xe3)]?.[_0x22e6cf(0x11e)],'remitterName':_0x58d5d0[_0x22e6cf(0xe3)]?.[_0x22e6cf(0x167)]}),loggerService_1[_0x22e6cf(0x103)][_0x22e6cf(0x87)](_0x22e6cf(0xb2),_0x1f7399['id'],_0x1f7399[_0x22e6cf(0xd4)],_0x58d5d0[_0x22e6cf(0xd4)],_0xa69640);}catch(_0xbe1ad2){console[_0x22e6cf(0x14f)]('Error\x20processing\x20Noda\x20webhook:',_0xbe1ad2),loggerService_1['loggerService'][_0x22e6cf(0x165)](_0x22e6cf(0xb2),_0xbe1ad2,_0xa69640);throw _0xbe1ad2;}}async[a60_0x2f64e0(0x154)](_0x4c6a33){const _0x388794=a60_0x2f64e0;console[_0x388794(0x9a)](_0x388794(0x116),_0x4c6a33);try{const _0x272b66=await this[_0x388794(0x113)][_0x388794(0x135)](_0x4c6a33);if(!_0x272b66[_0x388794(0xe9)])throw new Error(_0x388794(0x105));const _0x15843d=await database_1[_0x388794(0x163)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x272b66['paymentId']}});if(!_0x15843d){console[_0x388794(0x14f)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x272b66[_0x388794(0xe9)]);return;}console[_0x388794(0x9a)](_0x388794(0xa9)+_0x15843d['id']+_0x388794(0xf5)+_0x272b66[_0x388794(0xd4)]),await this[_0x388794(0xc5)](_0x15843d['id'],_0x272b66[_0x388794(0xd4)]),loggerService_1[_0x388794(0x103)][_0x388794(0x87)]('cointopay',_0x15843d['id'],_0x15843d['status'],_0x272b66[_0x388794(0xd4)],_0x4c6a33);}catch(_0x4e065b){console[_0x388794(0x14f)](_0x388794(0x89),_0x4e065b),loggerService_1[_0x388794(0x103)][_0x388794(0x165)]('cointopay',_0x4e065b,_0x4c6a33);throw _0x4e065b;}}async[a60_0x2f64e0(0xe6)](_0x2ecf2c){const _0x42c809=a60_0x2f64e0;console[_0x42c809(0x9a)](_0x42c809(0x12d),_0x2ecf2c);try{const _0x3f9ae6=await this[_0x42c809(0x9b)][_0x42c809(0x135)](_0x2ecf2c);if(!_0x3f9ae6[_0x42c809(0xe9)])throw new Error(_0x42c809(0xd6));const _0x4b2ade=await database_1[_0x42c809(0x163)]['payment'][_0x42c809(0xe7)]({'where':{'gatewayOrderId':_0x3f9ae6[_0x42c809(0xe9)]}});if(!_0x4b2ade){console[_0x42c809(0x14f)](_0x42c809(0xa1)+_0x3f9ae6['paymentId']);return;}console[_0x42c809(0x9a)]('üìä\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x4b2ade['id']+_0x42c809(0xf5)+_0x3f9ae6[_0x42c809(0xd4)]),await this[_0x42c809(0xc5)](_0x4b2ade['id'],_0x3f9ae6[_0x42c809(0xd4)]),loggerService_1[_0x42c809(0x103)][_0x42c809(0x87)](_0x42c809(0xdc),_0x4b2ade['id'],_0x4b2ade[_0x42c809(0xd4)],_0x3f9ae6[_0x42c809(0xd4)],_0x2ecf2c);}catch(_0x1deda1){console[_0x42c809(0x14f)](_0x42c809(0x15c),_0x1deda1),loggerService_1[_0x42c809(0x103)]['logWebhookError'](_0x42c809(0xdc),_0x1deda1,_0x2ecf2c);throw _0x1deda1;}}async['processKlymeWebhook'](_0x10eeae){const _0x55f29a=a60_0x2f64e0;console[_0x55f29a(0x9a)](_0x55f29a(0x10a),_0x10eeae);try{const _0x368a63=await this[_0x55f29a(0x108)]['processWebhook'](_0x10eeae);if(!_0x368a63[_0x55f29a(0xe9)])throw new Error(_0x55f29a(0x104));const _0x4fbcbf=await database_1[_0x55f29a(0x163)][_0x55f29a(0x109)][_0x55f29a(0xe7)]({'where':{'gatewayOrderId':_0x368a63[_0x55f29a(0xe9)]}});if(!_0x4fbcbf){console[_0x55f29a(0x14f)](_0x55f29a(0x15f)+_0x368a63[_0x55f29a(0xe9)]);return;}console[_0x55f29a(0x9a)](_0x55f29a(0xae)+_0x4fbcbf['id']+_0x55f29a(0xf5)+_0x368a63[_0x55f29a(0xd4)]),await this[_0x55f29a(0xc5)](_0x4fbcbf['id'],_0x368a63[_0x55f29a(0xd4)],{'paymentMethod':_0x368a63[_0x55f29a(0xe3)]?.['payment_method']}),loggerService_1[_0x55f29a(0x103)][_0x55f29a(0x87)]('klyme',_0x4fbcbf['id'],_0x4fbcbf['status'],_0x368a63['status'],_0x10eeae);}catch(_0x2f5c20){console[_0x55f29a(0x14f)](_0x55f29a(0xd1),_0x2f5c20),loggerService_1[_0x55f29a(0x103)]['logWebhookError']('klyme',_0x2f5c20,_0x10eeae);throw _0x2f5c20;}}async[a60_0x2f64e0(0x10c)](_0x52860f){const _0x3842c5=a60_0x2f64e0;console[_0x3842c5(0x9a)]('üîÑ\x20Processing\x20MasterCard\x20webhook:',JSON[_0x3842c5(0x124)](_0x52860f,null,0x2));try{const _0x54002a=await this[_0x3842c5(0xe5)][_0x3842c5(0x135)](_0x52860f);console[_0x3842c5(0x9a)](_0x3842c5(0x16c),_0x54002a);if(!_0x54002a[_0x3842c5(0xe9)]){console[_0x3842c5(0x14f)]('‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data'),console[_0x3842c5(0x14f)](_0x3842c5(0xba),Object[_0x3842c5(0x145)](_0x52860f));throw new Error(_0x3842c5(0x112));}let _0x599f0f=null;console[_0x3842c5(0x9a)](_0x3842c5(0x13f)+_0x54002a[_0x3842c5(0xe9)]);_0x54002a[_0x3842c5(0xe9)]&&(console['log'](_0x3842c5(0x155)),_0x599f0f=await database_1[_0x3842c5(0x163)][_0x3842c5(0x109)]['findFirst']({'where':{'AND':[{'gateway':_0x3842c5(0x10f)},{'OR':[{'gatewayPaymentId':_0x54002a[_0x3842c5(0xe9)]},{'gatewayOrderId':_0x54002a[_0x3842c5(0xe9)]},{'id':_0x54002a[_0x3842c5(0xe9)]},{'orderId':_0x54002a[_0x3842c5(0xe9)]}]}]}}),console[_0x3842c5(0x9a)](_0x3842c5(0x14e)+(_0x599f0f?_0x3842c5(0x12c)+_0x599f0f['id']:_0x3842c5(0x8c))));if(!_0x599f0f){console[_0x3842c5(0x14f)](_0x3842c5(0x8a)+_0x54002a[_0x3842c5(0xe9)]),console[_0x3842c5(0x14f)]('üîç\x20Searched\x20by:\x20gatewayOrderId=\x22'+_0x54002a['paymentId']+'\x22,\x20id=\x22'+_0x54002a[_0x3842c5(0xe9)]+'\x22,\x20orderId=\x22'+_0x54002a[_0x3842c5(0xe9)]+'\x22');const _0x229114=await database_1['default'][_0x3842c5(0x109)][_0x3842c5(0x114)]({'where':{'gateway':'mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x3842c5(0x9a)](_0x3842c5(0x144),_0x229114);return;}console['log']('‚úÖ\x20Found\x20payment\x20'+_0x599f0f['id']+_0x3842c5(0xb7)+_0x599f0f[_0x3842c5(0xd4)]+_0x3842c5(0xb3)+_0x54002a[_0x3842c5(0xd4)]),await this['updatePaymentStatus'](_0x599f0f['id'],_0x54002a[_0x3842c5(0xd4)]),loggerService_1[_0x3842c5(0x103)][_0x3842c5(0x87)]('mastercard',_0x599f0f['id'],_0x599f0f[_0x3842c5(0xd4)],_0x54002a[_0x3842c5(0xd4)],_0x52860f);}catch(_0x39e67c){console[_0x3842c5(0x14f)](_0x3842c5(0x13d),_0x39e67c),loggerService_1[_0x3842c5(0x103)][_0x3842c5(0x165)](_0x3842c5(0x10f),_0x39e67c,_0x52860f);throw _0x39e67c;}}async[a60_0x2f64e0(0x8b)](_0x16d74e){const _0x545ba5=a60_0x2f64e0;console[_0x545ba5(0x9a)](_0x545ba5(0xfa),JSON[_0x545ba5(0x124)](_0x16d74e,null,0x2));try{const _0xd73650=await this[_0x545ba5(0x11f)]['processWebhook'](_0x16d74e);console[_0x545ba5(0x9a)](_0x545ba5(0x12a),_0xd73650);if(!_0xd73650[_0x545ba5(0xe9)]){console['error'](_0x545ba5(0x137)),console[_0x545ba5(0x14f)](_0x545ba5(0xba),Object[_0x545ba5(0x145)](_0x16d74e));throw new Error(_0x545ba5(0x123));}let _0x4a878a=null;console[_0x545ba5(0x9a)](_0x545ba5(0x10d)+_0xd73650[_0x545ba5(0xe9)]),_0x4a878a=await database_1['default'][_0x545ba5(0x109)]['findFirst']({'where':{'AND':[{'gateway':_0x545ba5(0x9d)},{'OR':[{'gatewayPaymentId':_0xd73650['paymentId']},{'gatewayOrderId':_0xd73650['paymentId']},{'id':_0xd73650[_0x545ba5(0xe9)]},{'orderId':_0xd73650[_0x545ba5(0xe9)]}]}]}}),console[_0x545ba5(0x9a)](_0x545ba5(0x14e)+(_0x4a878a?'Found\x20payment\x20'+_0x4a878a['id']:_0x545ba5(0x8c)));if(!_0x4a878a){console[_0x545ba5(0x14f)](_0x545ba5(0xdb)+_0xd73650[_0x545ba5(0xe9)]);return;}console[_0x545ba5(0x9a)](_0x545ba5(0xd8)+_0x4a878a['id']+_0x545ba5(0xf5)+_0xd73650[_0x545ba5(0xd4)]),await this['updatePaymentStatus'](_0x4a878a['id'],_0xd73650[_0x545ba5(0xd4)],{'cardLast4':_0xd73650[_0x545ba5(0xe3)]?.[_0x545ba5(0x152)],'paymentMethod':_0xd73650[_0x545ba5(0xe3)]?.['paymentMethod']});}catch(_0x1d41e1){console[_0x545ba5(0x14f)](_0x545ba5(0x129),_0x1d41e1),loggerService_1['loggerService'][_0x545ba5(0x165)](_0x545ba5(0x9d),_0x1d41e1,_0x16d74e);throw _0x1d41e1;}}async[a60_0x2f64e0(0xb1)](_0x2925e0,_0x43cec5){const _0x1bc6cc=a60_0x2f64e0,_0x2e813f=Date[_0x1bc6cc(0xbc)]();try{const _0x309115=_0x2925e0[_0x1bc6cc(0x91)],_0x112555=_0x309115['settings'];if(!_0x112555?.[_0x1bc6cc(0xad)]){console[_0x1bc6cc(0x9a)](_0x1bc6cc(0xb4)+_0x309115['id']);return;}const _0x54925b=_0x43cec5===_0x1bc6cc(0x16d)?_0x1bc6cc(0x13a):_0x43cec5===_0x1bc6cc(0x160)?_0x1bc6cc(0x132):_0x43cec5===_0x1bc6cc(0x93)?_0x1bc6cc(0x132):_0x43cec5===_0x1bc6cc(0xb6)?_0x1bc6cc(0x132):_0x43cec5==='REFUND'?'payment.failed':_0x1bc6cc(0xec);let _0x49a859=[];if(_0x112555[_0x1bc6cc(0x126)])try{_0x49a859=Array[_0x1bc6cc(0xe1)](_0x112555[_0x1bc6cc(0x126)])?_0x112555[_0x1bc6cc(0x126)]:JSON[_0x1bc6cc(0xde)](_0x112555[_0x1bc6cc(0x126)]);}catch(_0x27397d){console[_0x1bc6cc(0x14f)](_0x1bc6cc(0xb5),_0x27397d),_0x49a859=[];}if(!_0x49a859[_0x1bc6cc(0x120)](_0x54925b)){console[_0x1bc6cc(0x9a)]('Webhook\x20event\x20'+_0x54925b+_0x1bc6cc(0x100)+_0x309115['id']);return;}const _0x15bc8e={'event':_0x54925b,'payment':{'id':_0x2925e0['id'],'order_id':_0x2925e0[_0x1bc6cc(0x133)],'gateway_order_id':_0x2925e0[_0x1bc6cc(0xeb)],'gateway':_0x2925e0[_0x1bc6cc(0x161)],'amount':_0x2925e0['amount'],'currency':_0x2925e0[_0x1bc6cc(0x156)],'status':_0x43cec5[_0x1bc6cc(0x13c)](),'customer_email':_0x2925e0[_0x1bc6cc(0x153)],'customer_name':_0x2925e0[_0x1bc6cc(0xee)],'failure_message':_0x2925e0['failureMessage'],'tx_urls':_0x2925e0['txUrls']?JSON[_0x1bc6cc(0xde)](_0x2925e0[_0x1bc6cc(0x169)]):null,'created_at':_0x2925e0[_0x1bc6cc(0xf6)],'updated_at':_0x2925e0[_0x1bc6cc(0xe8)]}},_0x5c1aab=await fetch(_0x112555[_0x1bc6cc(0xad)],{'method':_0x1bc6cc(0xff),'headers':{'Content-Type':_0x1bc6cc(0xf8),'User-Agent':_0x1bc6cc(0x164)},'body':JSON[_0x1bc6cc(0x124)](_0x15bc8e)}),_0xb9d315=Date[_0x1bc6cc(0xbc)]()-_0x2e813f,_0xdb99c3=_0x5c1aab['ok']?'Success':await _0x5c1aab[_0x1bc6cc(0x141)]();loggerService_1['loggerService'][_0x1bc6cc(0x8d)](_0x2925e0[_0x1bc6cc(0x12e)],_0x112555[_0x1bc6cc(0xad)],_0x54925b,_0x5c1aab['status'],_0xb9d315,_0x15bc8e),console[_0x1bc6cc(0x9a)](_0x1bc6cc(0x15a)+_0x112555[_0x1bc6cc(0xad)]+'\x20with\x20status\x20'+_0x5c1aab[_0x1bc6cc(0xd4)]+'\x20('+_0xb9d315+'ms)');}catch(_0x57f5c5){console['error'](_0x1bc6cc(0x102),_0x57f5c5),loggerService_1['loggerService'][_0x1bc6cc(0xfe)](_0x2925e0[_0x1bc6cc(0x12e)],_0x2925e0[_0x1bc6cc(0x91)]?.[_0x1bc6cc(0xc6)]?.[_0x1bc6cc(0xad)]||_0x1bc6cc(0xcf),_0x1bc6cc(0xaa),_0x57f5c5,{});}}async[a60_0x2f64e0(0xaf)](_0xee1080,_0x3c6260){const _0x367ed4=a60_0x2f64e0;try{const _0x5ef133={'PENDING':_0x367ed4(0x13e),'PROCESSING':'processing','PAID':_0x367ed4(0xed),'FAILED':_0x367ed4(0xce),'EXPIRED':_0x367ed4(0x14a),'REFUND':'refund','CHARGEBACK':_0x367ed4(0x9e)},_0x536207=_0x5ef133[_0x3c6260];if(!_0x536207||_0x536207==='created')return;await telegramBotService_1[_0x367ed4(0x15d)][_0x367ed4(0x139)](_0xee1080['shopId'],_0xee1080,_0x536207);}catch(_0x4ae7f9){console[_0x367ed4(0x14f)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4ae7f9);}}async[a60_0x2f64e0(0x10e)](_0x4b00ac,_0x2b090d){const _0x59cf22=a60_0x2f64e0;try{const _0x4de318=await database_1[_0x59cf22(0x163)][_0x59cf22(0x91)][_0x59cf22(0x92)]({'where':{'id':_0x4b00ac},'select':{'gatewaySettings':!![]}});if(!_0x4de318?.[_0x59cf22(0xef)])return console[_0x59cf22(0x9a)]('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x4b00ac+_0x59cf22(0xc2)),0xa;const _0x4ec40b=JSON[_0x59cf22(0xde)](_0x4de318['gatewaySettings']);for(const [_0x5976a0,_0x24f00c]of Object[_0x59cf22(0x94)](_0x4ec40b)){if(_0x5976a0[_0x59cf22(0x13c)]()===_0x2b090d['toLowerCase']()){const _0x422d95=_0x24f00c[_0x59cf22(0x107)]||0xa;return console[_0x59cf22(0x9a)](_0x59cf22(0xb0)+_0x2b090d+_0x59cf22(0x119)+_0x4b00ac+':\x20'+_0x422d95+'%'),_0x422d95;}}return console['log'](_0x59cf22(0xc1)+_0x2b090d+_0x59cf22(0x11b)+_0x4b00ac+_0x59cf22(0x151)),0xa;}catch(_0x1a6bc0){return console[_0x59cf22(0x14f)](_0x59cf22(0x168)+_0x4b00ac+_0x59cf22(0x140)+_0x2b090d+':',_0x1a6bc0),0xa;}}}exports[a60_0x2f64e0(0x143)]=WebhookService;