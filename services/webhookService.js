'use strict';function a58_0x1618(){const _0x3ee7f4=['\x22,\x20paymentLinkId=\x22','paid','RapydService','shopId','💰\x20Adding\x20to\x20balance:\x20','customerName','isArray','✅\x20Found\x20payment\x20','rapyd','7842KwrWZm','📊\x20KLYME\x20webhook:\x20Payment\x20','processCoinToPayWebhook','payment.success','📊\x20CoinToPay\x20webhook:\x20Payment\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','paidAt','4bIVgDi','type','Payment\x20','./gateways/nodaService','\x20not\x20found','No\x20payment\x20ID\x20in\x20Noda\x20webhook','logShopWebhookError','update','📈\x20Payment\x20details:\x20oldStatus=\x22','./gateways/coinToPayService','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','mastercard','currencyService','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','processWebhook','balance','WebhookService','create','plisioService','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','Success','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','text','2298820JhFadT','rapydService','./telegramBotService','processMasterCardWebhook','defineProperty','parse','processing','paymentLink','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','📊\x20Plisio\x20webhook:\x20Payment\x20','🔍\x20Search\x20result:\x20','\x20current\x20balance:\x20','📊\x20Noda\x20webhook:\x20Payment\x20','SINGLE','\x20USDT','PlisioService','klyme','findFirst','updatePaymentStatus','REFUND','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','amountUSDT','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','webhookUrl','📈\x20Found\x20payment\x20link\x20','cointopay2','nodaService','toUpperCase','📈\x20Payment\x20','🔄\x20Processing\x20Plisio\x20webhook:','convertToUSDT','plisio','\x20updated:\x20currentPayments=','log','no\x20balance\x20change','sendShopWebhook','🔄\x20Processing\x20CoinToPay\x20webhook:','309510ZVyCYu','EXPIRED','NodaService','txUrls','toISOString','bankId','remitterName','Payment\x20not\x20found','logShopWebhookSent','processPlisioWebhook','PAID','ms)','4386519xTylCW','\x20not\x20enabled\x20for\x20shop\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','processCoinToPay2Webhook','./gateways/klymeService','updatedAt','webhookEvents','\x20-\x20','💸\x20Additional\x20chargeback\x20penalty:\x20-','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','\x20with\x20status\x20','../config/database','now','currentPayments','customerEmail','Webhook\x20event\x20','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','loggerService','unknown','MasterCardService','📝\x20Reason:\x20','createdAt','\x20USDT\x20(payment\x20became\x20PAID)','FAILED','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','286TnTvrS','\x20status\x20','gatewayOrderId','refund','failureMessage','\x20->\x20','coinToPayService','\x20=\x20','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','./gateways/rapydService','noda','COMPLETED','paymentLinkId','remitterIban','expired','amount','chargebackAmount','processPlisioGatewayWebhook','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','webhook_send','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','Error\x20processing\x20Rapyd\x20webhook:','plisio_gateway',',\x20status=','payment.failed','telegramBotService','additionalInfo','coinToPay2Service','logWebhookProcessed','payment_method','CoinToPay2Service','✅\x20Payment\x20link\x20','POST','\x20balance\x20updated:\x20','status','💰\x20Final\x20balance\x20after\x20chargeback:\x20','\x20+\x20','Error\x20processing\x20CoinToPay2\x20webhook:','findUnique','stringify','masterCardService','toFixed','💰\x20Removing\x20from\x20balance:\x20','error','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','settings','991615DvdxRJ','currency','default','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','Error\x20processing\x20Noda\x20webhook:','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','username','1939vGVslk','created',',\x20currentPayments=','❌\x20Available\x20webhook\x20fields:','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','\x20and\x20-','cardLast4','application/json','$transaction','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','2137810XYbMIq','cointopay','failed','processKlymeWebhook','__esModule','shop','__importDefault','\x20to\x20','3021249OKlQxY','\x20USDT\x20(chargeback\x20penalty)','🔄\x20Processing\x20KLYME\x20webhook:','gateway','🏪\x20Shop\x20','CoinToPayService','\x22,\x20id=\x22','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','klymeService','toLowerCase','🔄\x20Additional\x20data:','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','Found\x20payment\x20','8DkREHO','Error\x20processing\x20Plisio\x20webhook:','Failed\x20to\x20send\x20shop\x20webhook:','paymentMethod','📊\x20MasterCard\x20webhook\x20result:','./gateways/mastercardService','payment','webhook_status_change_','Error\x20processing\x20CoinToPay\x20webhook:','🔄\x20Processing\x20MasterCard\x20webhook:','logWebhookError','paymentId'];a58_0x1618=function(){return _0x3ee7f4;};return a58_0x1618();}function a58_0x330e(_0xb2076a,_0x57f332){const _0x161830=a58_0x1618();return a58_0x330e=function(_0x330e4d,_0x393c56){_0x330e4d=_0x330e4d-0x1e8;let _0xf87e52=_0x161830[_0x330e4d];return _0xf87e52;},a58_0x330e(_0xb2076a,_0x57f332);}const a58_0x4944be=a58_0x330e;(function(_0x406385,_0x14c23e){const _0x44f4fd=a58_0x330e,_0x428b6b=_0x406385();while(!![]){try{const _0x1d4a3e=parseInt(_0x44f4fd(0x265))/0x1+-parseInt(_0x44f4fd(0x1eb))/0x2+parseInt(_0x44f4fd(0x27f))/0x3*(-parseInt(_0x44f4fd(0x2a8))/0x4)+parseInt(_0x44f4fd(0x277))/0x5+parseInt(_0x44f4fd(0x2a1))/0x6*(parseInt(_0x44f4fd(0x26d))/0x7)+-parseInt(_0x44f4fd(0x28c))/0x8*(-parseInt(_0x44f4fd(0x21c))/0x9)+parseInt(_0x44f4fd(0x210))/0xa*(parseInt(_0x44f4fd(0x236))/0xb);if(_0x1d4a3e===_0x14c23e)break;else _0x428b6b['push'](_0x428b6b['shift']());}catch(_0x11974f){_0x428b6b['push'](_0x428b6b['shift']());}}}(a58_0x1618,0xdfd68));var __importDefault=this&&this[a58_0x4944be(0x27d)]||function(_0x582c03){const _0x57bb9b=a58_0x4944be;return _0x582c03&&_0x582c03[_0x57bb9b(0x27b)]?_0x582c03:{'default':_0x582c03};};Object[a58_0x4944be(0x1ef)](exports,'__esModule',{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a58_0x4944be(0x228))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a58_0x4944be(0x23f)),nodaService_1=require(a58_0x4944be(0x2ab)),coinToPayService_1=require(a58_0x4944be(0x2b1)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require(a58_0x4944be(0x220)),mastercardService_1=require(a58_0x4944be(0x291)),telegramBotService_1=require(a58_0x4944be(0x1ed)),currencyService_1=require('./currencyService'),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x535f77=a58_0x4944be;this[_0x535f77(0x2ba)]=new plisioService_1[(_0x535f77(0x1fa))](),this[_0x535f77(0x1ec)]=new rapydService_1[(_0x535f77(0x29a))](),this[_0x535f77(0x205)]=new nodaService_1[(_0x535f77(0x212))](),this[_0x535f77(0x23c)]=new coinToPayService_1[(_0x535f77(0x284))](),this[_0x535f77(0x252)]=new coinToPay2Service_1[(_0x535f77(0x255))](),this[_0x535f77(0x287)]=new klymeService_1['KlymeService'](),this[_0x535f77(0x25f)]=new mastercardService_1[(_0x535f77(0x230))]();}async['updatePaymentStatus'](_0x2f2beb,_0x3833c5,_0x5b426d){const _0x14e176=a58_0x4944be;console[_0x14e176(0x20c)](_0x14e176(0x2b5)+_0x2f2beb+',\x20newStatus='+_0x3833c5),console['log'](_0x14e176(0x289),_0x5b426d),await database_1[_0x14e176(0x267)][_0x14e176(0x275)](async _0x3de677=>{const _0x4a4103=_0x14e176,_0x293b96=await _0x3de677[_0x4a4103(0x292)][_0x4a4103(0x25d)]({'where':{'id':_0x2f2beb},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x293b96)throw new Error(_0x4a4103(0x2aa)+_0x2f2beb+_0x4a4103(0x2ac));const _0x53d29c=_0x293b96['status'],_0x3af164=_0x293b96['shop'];console[_0x4a4103(0x20c)]('💰\x20Payment\x20'+_0x2f2beb+':\x20'+_0x53d29c+_0x4a4103(0x23b)+_0x3833c5),console[_0x4a4103(0x20c)](_0x4a4103(0x283)+_0x3af164['username']+_0x4a4103(0x1f6)+_0x3af164[_0x4a4103(0x2b7)]+_0x4a4103(0x1f9));const _0x4e54ef={'status':_0x3833c5[_0x4a4103(0x206)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x5b426d?.[_0x4a4103(0x23a)]&&(_0x4e54ef[_0x4a4103(0x23a)]=_0x5b426d[_0x4a4103(0x23a)]);_0x5b426d?.['txUrls']&&(_0x4e54ef[_0x4a4103(0x213)]=JSON[_0x4a4103(0x25e)](_0x5b426d[_0x4a4103(0x213)]));_0x5b426d?.[_0x4a4103(0x273)]&&(_0x4e54ef[_0x4a4103(0x273)]=_0x5b426d[_0x4a4103(0x273)]);_0x5b426d?.[_0x4a4103(0x28f)]&&(_0x4e54ef[_0x4a4103(0x28f)]=_0x5b426d[_0x4a4103(0x28f)]);_0x5b426d?.['bankId']&&(_0x4e54ef[_0x4a4103(0x215)]=_0x5b426d[_0x4a4103(0x215)]);_0x5b426d?.[_0x4a4103(0x243)]&&(_0x4e54ef[_0x4a4103(0x243)]=_0x5b426d[_0x4a4103(0x243)]);_0x5b426d?.['remitterName']&&(_0x4e54ef[_0x4a4103(0x216)]=_0x5b426d[_0x4a4103(0x216)]);let _0x293ba5=_0x3af164[_0x4a4103(0x2b7)],_0x5941b4='';if(_0x3833c5['toUpperCase']()==='PAID'&&_0x53d29c!==_0x4a4103(0x21a)){const _0x3f5b76=await currencyService_1[_0x4a4103(0x2b4)][_0x4a4103(0x209)](_0x293b96[_0x4a4103(0x245)],_0x293b96[_0x4a4103(0x266)]);_0x293ba5+=_0x3f5b76,_0x5941b4='+'+_0x3f5b76[_0x4a4103(0x260)](0x6)+_0x4a4103(0x233),_0x4e54ef[_0x4a4103(0x200)]=_0x3f5b76,_0x4e54ef[_0x4a4103(0x2a7)]=new Date(),console[_0x4a4103(0x20c)]('💰\x20Converting\x20'+_0x293b96[_0x4a4103(0x245)]+'\x20'+_0x293b96[_0x4a4103(0x266)]+_0x4a4103(0x23b)+_0x3f5b76[_0x4a4103(0x260)](0x6)+_0x4a4103(0x1f9)),console['log'](_0x4a4103(0x29c)+_0x3af164[_0x4a4103(0x2b7)]+_0x4a4103(0x25b)+_0x3f5b76['toFixed'](0x6)+'\x20=\x20'+_0x293ba5[_0x4a4103(0x260)](0x6)+_0x4a4103(0x1f9));}else{if(_0x53d29c===_0x4a4103(0x21a)&&_0x3833c5['toUpperCase']()!==_0x4a4103(0x21a)){const _0x49f342=_0x293b96[_0x4a4103(0x200)];_0x49f342&&(_0x293ba5-=_0x49f342,_0x5941b4='-'+_0x49f342[_0x4a4103(0x260)](0x6)+_0x4a4103(0x1ff),_0x4e54ef['amountUSDT']=null,_0x4e54ef['paidAt']=null,console[_0x4a4103(0x20c)](_0x4a4103(0x261)+_0x3af164[_0x4a4103(0x2b7)]+_0x4a4103(0x223)+_0x49f342[_0x4a4103(0x260)](0x6)+_0x4a4103(0x23d)+_0x293ba5[_0x4a4103(0x260)](0x6)+_0x4a4103(0x1f9)));}}if(_0x3833c5[_0x4a4103(0x206)]()==='CHARGEBACK'){const _0x47e9c7=_0x5b426d?.[_0x4a4103(0x246)]||0x0;_0x47e9c7>0x0&&(_0x293ba5-=_0x47e9c7,_0x5941b4+=_0x4a4103(0x272)+_0x47e9c7[_0x4a4103(0x260)](0x6)+_0x4a4103(0x280),_0x4e54ef[_0x4a4103(0x246)]=_0x47e9c7,console[_0x4a4103(0x20c)](_0x4a4103(0x224)+_0x47e9c7[_0x4a4103(0x260)](0x6)+_0x4a4103(0x1f9)),console[_0x4a4103(0x20c)](_0x4a4103(0x25a)+_0x293ba5['toFixed'](0x6)+'\x20USDT'));}const _0x3b5a45=await _0x3de677[_0x4a4103(0x292)][_0x4a4103(0x2af)]({'where':{'id':_0x2f2beb},'data':_0x4e54ef});_0x293ba5!==_0x3af164['balance']&&(await _0x3de677[_0x4a4103(0x27c)][_0x4a4103(0x2af)]({'where':{'id':_0x3af164['id']},'data':{'balance':_0x293ba5}}),console[_0x4a4103(0x20c)]('✅\x20Shop\x20'+_0x3af164[_0x4a4103(0x26c)]+_0x4a4103(0x258)+_0x3af164[_0x4a4103(0x2b7)][_0x4a4103(0x260)](0x6)+_0x4a4103(0x23b)+_0x293ba5['toFixed'](0x6)+_0x4a4103(0x1f9)),console[_0x4a4103(0x20c)](_0x4a4103(0x231)+_0x5941b4));await _0x3de677['webhookLog'][_0x4a4103(0x2b9)]({'data':{'paymentId':_0x2f2beb,'shopId':_0x3af164['id'],'event':_0x4a4103(0x293)+_0x3833c5[_0x4a4103(0x288)](),'statusCode':0xc8,'responseBody':JSON[_0x4a4103(0x25e)]({'oldStatus':_0x53d29c,'newStatus':_0x3833c5[_0x4a4103(0x206)](),'balanceChange':_0x5941b4||_0x4a4103(0x20d),'oldBalance':_0x3af164[_0x4a4103(0x2b7)],'newBalance':_0x293ba5,'amountUSDT':_0x4e54ef[_0x4a4103(0x200)],'additionalData':_0x5b426d,'timestamp':new Date()[_0x4a4103(0x214)]()})}}),await this[_0x4a4103(0x20e)]({..._0x293b96,..._0x3b5a45,'shop':_0x3af164},_0x3833c5[_0x4a4103(0x206)]()),await this['sendPaymentStatusNotification']({..._0x293b96,..._0x3b5a45},_0x3833c5[_0x4a4103(0x206)]());if(_0x53d29c!==_0x4a4103(0x21a)&&_0x3833c5[_0x4a4103(0x206)]()===_0x4a4103(0x21a)){console[_0x4a4103(0x20c)](_0x4a4103(0x207)+_0x2f2beb+_0x4a4103(0x235)),console[_0x4a4103(0x20c)](_0x4a4103(0x2b0)+_0x53d29c+'\x22,\x20newStatus=\x22'+_0x3833c5['toUpperCase']()+_0x4a4103(0x298)+_0x293b96['paymentLinkId']+'\x22');if(_0x293b96[_0x4a4103(0x242)])try{const _0x481ce8=await _0x3de677['paymentLink']['findUnique']({'where':{'id':_0x293b96[_0x4a4103(0x242)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x481ce8){console[_0x4a4103(0x20c)](_0x4a4103(0x203)+_0x481ce8['id']+':\x20type='+_0x481ce8[_0x4a4103(0x2a9)]+_0x4a4103(0x26f)+_0x481ce8[_0x4a4103(0x22a)]+_0x4a4103(0x24e)+_0x481ce8[_0x4a4103(0x259)]);const _0xe7fa8a=_0x481ce8[_0x4a4103(0x22a)]+0x1,_0x438c4f=_0x481ce8[_0x4a4103(0x2a9)]===_0x4a4103(0x1f8)?_0x4a4103(0x241):_0x481ce8[_0x4a4103(0x259)];await _0x3de677[_0x4a4103(0x1f2)][_0x4a4103(0x2af)]({'where':{'id':_0x293b96[_0x4a4103(0x242)]},'data':{'currentPayments':_0xe7fa8a,'status':_0x438c4f,'updatedAt':new Date()}}),console['log'](_0x4a4103(0x256)+_0x481ce8['id']+_0x4a4103(0x20b)+_0x481ce8[_0x4a4103(0x22a)]+'\x20->\x20'+_0xe7fa8a+',\x20status='+_0x481ce8[_0x4a4103(0x259)]+_0x4a4103(0x23b)+_0x438c4f);}else console['log']('❌\x20Payment\x20link\x20'+_0x293b96[_0x4a4103(0x242)]+_0x4a4103(0x2ac));}catch(_0x1818bb){console[_0x4a4103(0x262)](_0x4a4103(0x286),_0x1818bb);}else console[_0x4a4103(0x20c)](_0x4a4103(0x207)+_0x2f2beb+_0x4a4103(0x2a6));}else console[_0x4a4103(0x20c)]('📈\x20Payment\x20'+_0x2f2beb+_0x4a4103(0x271)+_0x53d29c+_0x4a4103(0x23b)+_0x3833c5['toUpperCase']());});}async[a58_0x4944be(0x219)](_0x757ab){const _0x1087f6=a58_0x4944be;console[_0x1087f6(0x20c)](_0x1087f6(0x208),_0x757ab);try{const _0x4861e6=await this[_0x1087f6(0x2ba)][_0x1087f6(0x2b6)](_0x757ab);if(!_0x4861e6[_0x1087f6(0x297)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x5b189e=await database_1[_0x1087f6(0x267)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x4861e6[_0x1087f6(0x297)]}});if(!_0x5b189e){console['error'](_0x1087f6(0x28a)+_0x4861e6[_0x1087f6(0x297)]);return;}console[_0x1087f6(0x20c)](_0x1087f6(0x1f4)+_0x5b189e['id']+_0x1087f6(0x237)+_0x4861e6['status']),await this[_0x1087f6(0x1fd)](_0x5b189e['id'],_0x4861e6[_0x1087f6(0x259)],{'txUrls':_0x4861e6[_0x1087f6(0x213)]}),loggerService_1['loggerService'][_0x1087f6(0x253)](_0x1087f6(0x20a),_0x5b189e['id'],_0x5b189e[_0x1087f6(0x259)],_0x4861e6[_0x1087f6(0x259)],_0x757ab);}catch(_0x35fae5){console['error'](_0x1087f6(0x28d),_0x35fae5),loggerService_1[_0x1087f6(0x22e)][_0x1087f6(0x296)](_0x1087f6(0x20a),_0x35fae5,_0x757ab);throw _0x35fae5;}}async[a58_0x4944be(0x247)](_0xaa2778){const _0x2f22f5=a58_0x4944be;console[_0x2f22f5(0x20c)](_0x2f22f5(0x26b),_0xaa2778);try{const _0x3bb1a2=await this[_0x2f22f5(0x2ba)][_0x2f22f5(0x2b6)](_0xaa2778);if(!_0x3bb1a2['paymentId'])throw new Error(_0x2f22f5(0x23e));const _0x5c71e5=await database_1['default'][_0x2f22f5(0x292)]['findFirst']({'where':{'gatewayOrderId':_0x3bb1a2[_0x2f22f5(0x297)]}});if(!_0x5c71e5){console[_0x2f22f5(0x262)]('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x3bb1a2[_0x2f22f5(0x297)]);return;}console[_0x2f22f5(0x20c)]('📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20'+_0x5c71e5['id']+_0x2f22f5(0x237)+_0x3bb1a2[_0x2f22f5(0x259)]),await this[_0x2f22f5(0x1fd)](_0x5c71e5['id'],_0x3bb1a2[_0x2f22f5(0x259)],{'txUrls':_0x3bb1a2[_0x2f22f5(0x213)]}),loggerService_1[_0x2f22f5(0x22e)][_0x2f22f5(0x253)](_0x2f22f5(0x24d),_0x5c71e5['id'],_0x5c71e5['status'],_0x3bb1a2[_0x2f22f5(0x259)],_0xaa2778);}catch(_0x3eab81){console['error']('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x3eab81),loggerService_1['loggerService'][_0x2f22f5(0x296)](_0x2f22f5(0x24d),_0x3eab81,_0xaa2778);throw _0x3eab81;}}async['processRapydWebhook'](_0x36c903){const _0x16a4be=a58_0x4944be;console['log']('🔄\x20Processing\x20Rapyd\x20webhook:',_0x36c903);try{const _0x401b8a=await this['rapydService'][_0x16a4be(0x2b6)](_0x36c903);if(!_0x401b8a[_0x16a4be(0x297)])throw new Error('No\x20payment\x20ID\x20in\x20Rapyd\x20webhook');const _0x1954f3=await database_1['default'][_0x16a4be(0x292)][_0x16a4be(0x1fc)]({'where':{'gatewayOrderId':_0x401b8a[_0x16a4be(0x297)]}});if(!_0x1954f3){console[_0x16a4be(0x262)](_0x16a4be(0x1f3)+_0x401b8a[_0x16a4be(0x297)]);return;}console[_0x16a4be(0x20c)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x1954f3['id']+_0x16a4be(0x237)+_0x401b8a[_0x16a4be(0x259)]),await this[_0x16a4be(0x1fd)](_0x1954f3['id'],_0x401b8a[_0x16a4be(0x259)],{'failureMessage':_0x401b8a[_0x16a4be(0x23a)],'cardLast4':_0x401b8a[_0x16a4be(0x251)]?.[_0x16a4be(0x273)],'paymentMethod':_0x401b8a[_0x16a4be(0x251)]?.[_0x16a4be(0x28f)]}),loggerService_1[_0x16a4be(0x22e)]['logWebhookProcessed'](_0x16a4be(0x2a0),_0x1954f3['id'],_0x1954f3[_0x16a4be(0x259)],_0x401b8a[_0x16a4be(0x259)],_0x36c903);}catch(_0x5321e9){console[_0x16a4be(0x262)](_0x16a4be(0x24c),_0x5321e9),loggerService_1[_0x16a4be(0x22e)][_0x16a4be(0x296)](_0x16a4be(0x2a0),_0x5321e9,_0x36c903);throw _0x5321e9;}}async['processNodaWebhook'](_0x249ac8){const _0x598ee2=a58_0x4944be;console[_0x598ee2(0x20c)]('🔄\x20Processing\x20Noda\x20webhook:',_0x249ac8);try{const _0x32b602=await this['nodaService'][_0x598ee2(0x2b6)](_0x249ac8);if(!_0x32b602[_0x598ee2(0x297)])throw new Error(_0x598ee2(0x2ad));const _0x187acf=await database_1['default'][_0x598ee2(0x292)]['findFirst']({'where':{'gatewayOrderId':_0x32b602['paymentId']}});if(!_0x187acf){console[_0x598ee2(0x262)](_0x598ee2(0x268)+_0x32b602[_0x598ee2(0x297)]);return;}console[_0x598ee2(0x20c)](_0x598ee2(0x1f7)+_0x187acf['id']+_0x598ee2(0x237)+_0x32b602[_0x598ee2(0x259)]),await this[_0x598ee2(0x1fd)](_0x187acf['id'],_0x32b602['status'],{'bankId':_0x32b602['additionalInfo']?.[_0x598ee2(0x215)],'remitterIban':_0x32b602[_0x598ee2(0x251)]?.[_0x598ee2(0x243)],'remitterName':_0x32b602[_0x598ee2(0x251)]?.['remitterName']}),loggerService_1[_0x598ee2(0x22e)][_0x598ee2(0x253)]('noda',_0x187acf['id'],_0x187acf[_0x598ee2(0x259)],_0x32b602[_0x598ee2(0x259)],_0x249ac8);}catch(_0x7bc4af){console[_0x598ee2(0x262)](_0x598ee2(0x26a),_0x7bc4af),loggerService_1[_0x598ee2(0x22e)][_0x598ee2(0x296)](_0x598ee2(0x240),_0x7bc4af,_0x249ac8);throw _0x7bc4af;}}async[a58_0x4944be(0x2a3)](_0x2b2f6d){const _0x583981=a58_0x4944be;console['log'](_0x583981(0x20f),_0x2b2f6d);try{const _0x763248=await this[_0x583981(0x23c)][_0x583981(0x2b6)](_0x2b2f6d);if(!_0x763248[_0x583981(0x297)])throw new Error(_0x583981(0x22d));const _0x583eec=await database_1['default']['payment'][_0x583981(0x1fc)]({'where':{'gatewayOrderId':_0x763248[_0x583981(0x297)]}});if(!_0x583eec){console['error'](_0x583981(0x2bb)+_0x763248[_0x583981(0x297)]);return;}console[_0x583981(0x20c)](_0x583981(0x2a5)+_0x583eec['id']+_0x583981(0x237)+_0x763248[_0x583981(0x259)]),await this[_0x583981(0x1fd)](_0x583eec['id'],_0x763248['status']),loggerService_1['loggerService']['logWebhookProcessed'](_0x583981(0x278),_0x583eec['id'],_0x583eec[_0x583981(0x259)],_0x763248[_0x583981(0x259)],_0x2b2f6d);}catch(_0x5c12af){console[_0x583981(0x262)](_0x583981(0x294),_0x5c12af),loggerService_1[_0x583981(0x22e)]['logWebhookError'](_0x583981(0x278),_0x5c12af,_0x2b2f6d);throw _0x5c12af;}}async[a58_0x4944be(0x21f)](_0x11d3f9){const _0x10496f=a58_0x4944be;console[_0x10496f(0x20c)]('🔄\x20Processing\x20CoinToPay2\x20webhook:',_0x11d3f9);try{const _0x607e8=await this[_0x10496f(0x252)][_0x10496f(0x2b6)](_0x11d3f9);if(!_0x607e8[_0x10496f(0x297)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook');const _0x47cc69=await database_1[_0x10496f(0x267)][_0x10496f(0x292)][_0x10496f(0x1fc)]({'where':{'gatewayOrderId':_0x607e8[_0x10496f(0x297)]}});if(!_0x47cc69){console[_0x10496f(0x262)](_0x10496f(0x226)+_0x607e8[_0x10496f(0x297)]);return;}console[_0x10496f(0x20c)](_0x10496f(0x24b)+_0x47cc69['id']+'\x20status\x20'+_0x607e8[_0x10496f(0x259)]),await this['updatePaymentStatus'](_0x47cc69['id'],_0x607e8[_0x10496f(0x259)]),loggerService_1[_0x10496f(0x22e)]['logWebhookProcessed'](_0x10496f(0x204),_0x47cc69['id'],_0x47cc69[_0x10496f(0x259)],_0x607e8['status'],_0x11d3f9);}catch(_0x4870f9){console[_0x10496f(0x262)](_0x10496f(0x25c),_0x4870f9),loggerService_1[_0x10496f(0x22e)][_0x10496f(0x296)]('cointopay2',_0x4870f9,_0x11d3f9);throw _0x4870f9;}}async[a58_0x4944be(0x27a)](_0x4dd7ae){const _0x35559b=a58_0x4944be;console[_0x35559b(0x20c)](_0x35559b(0x281),_0x4dd7ae);try{const _0x90a9af=await this[_0x35559b(0x287)][_0x35559b(0x2b6)](_0x4dd7ae);if(!_0x90a9af['paymentId'])throw new Error(_0x35559b(0x2b2));const _0x53600e=await database_1['default']['payment'][_0x35559b(0x1fc)]({'where':{'gatewayOrderId':_0x90a9af[_0x35559b(0x297)]}});if(!_0x53600e){console[_0x35559b(0x262)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x90a9af[_0x35559b(0x297)]);return;}console[_0x35559b(0x20c)](_0x35559b(0x2a2)+_0x53600e['id']+_0x35559b(0x237)+_0x90a9af[_0x35559b(0x259)]),await this[_0x35559b(0x1fd)](_0x53600e['id'],_0x90a9af[_0x35559b(0x259)],{'paymentMethod':_0x90a9af['additionalInfo']?.[_0x35559b(0x254)]}),loggerService_1[_0x35559b(0x22e)][_0x35559b(0x253)](_0x35559b(0x1fb),_0x53600e['id'],_0x53600e[_0x35559b(0x259)],_0x90a9af['status'],_0x4dd7ae);}catch(_0x245b0b){console[_0x35559b(0x262)]('Error\x20processing\x20KLYME\x20webhook:',_0x245b0b),loggerService_1[_0x35559b(0x22e)][_0x35559b(0x296)](_0x35559b(0x1fb),_0x245b0b,_0x4dd7ae);throw _0x245b0b;}}async[a58_0x4944be(0x1ee)](_0x596638){const _0x4b84c6=a58_0x4944be;console['log'](_0x4b84c6(0x295),JSON['stringify'](_0x596638,null,0x2));try{const _0x49808b=await this[_0x4b84c6(0x25f)][_0x4b84c6(0x2b6)](_0x596638);console[_0x4b84c6(0x20c)](_0x4b84c6(0x290),_0x49808b);if(!_0x49808b[_0x4b84c6(0x297)]){console[_0x4b84c6(0x262)](_0x4b84c6(0x201)),console[_0x4b84c6(0x262)](_0x4b84c6(0x270),Object['keys'](_0x596638));throw new Error(_0x4b84c6(0x225));}let _0x57aeec=null;console['log'](_0x4b84c6(0x276)+_0x49808b[_0x4b84c6(0x297)]);_0x49808b[_0x4b84c6(0x297)]&&(console[_0x4b84c6(0x20c)](_0x4b84c6(0x24a)),_0x57aeec=await database_1[_0x4b84c6(0x267)][_0x4b84c6(0x292)]['findFirst']({'where':{'AND':[{'gateway':_0x4b84c6(0x2b3)},{'OR':[{'gatewayPaymentId':_0x49808b[_0x4b84c6(0x297)]},{'gatewayOrderId':_0x49808b[_0x4b84c6(0x297)]},{'id':_0x49808b[_0x4b84c6(0x297)]},{'orderId':_0x49808b[_0x4b84c6(0x297)]}]}]}}),console['log'](_0x4b84c6(0x1f5)+(_0x57aeec?_0x4b84c6(0x28b)+_0x57aeec['id']:_0x4b84c6(0x217))));if(!_0x57aeec){console['error'](_0x4b84c6(0x269)+_0x49808b[_0x4b84c6(0x297)]),console[_0x4b84c6(0x262)](_0x4b84c6(0x263)+_0x49808b[_0x4b84c6(0x297)]+_0x4b84c6(0x285)+_0x49808b[_0x4b84c6(0x297)]+'\x22,\x20orderId=\x22'+_0x49808b['paymentId']+'\x22');const _0x561536=await database_1['default'][_0x4b84c6(0x292)]['findMany']({'where':{'gateway':_0x4b84c6(0x2b3)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x4b84c6(0x20c)](_0x4b84c6(0x1e9),_0x561536);return;}console[_0x4b84c6(0x20c)](_0x4b84c6(0x29f)+_0x57aeec['id']+_0x4b84c6(0x248)+_0x57aeec[_0x4b84c6(0x259)]+_0x4b84c6(0x27e)+_0x49808b['status']),await this[_0x4b84c6(0x1fd)](_0x57aeec['id'],_0x49808b[_0x4b84c6(0x259)]),loggerService_1[_0x4b84c6(0x22e)][_0x4b84c6(0x253)](_0x4b84c6(0x2b3),_0x57aeec['id'],_0x57aeec[_0x4b84c6(0x259)],_0x49808b[_0x4b84c6(0x259)],_0x596638);}catch(_0x1eb8ae){console['error']('❌\x20Error\x20processing\x20MasterCard\x20webhook:',_0x1eb8ae),loggerService_1[_0x4b84c6(0x22e)]['logWebhookError'](_0x4b84c6(0x2b3),_0x1eb8ae,_0x596638);throw _0x1eb8ae;}}async[a58_0x4944be(0x20e)](_0x340984,_0x3f1c50){const _0x54142c=a58_0x4944be,_0x31ddb4=Date[_0x54142c(0x229)]();try{const _0x574a6e=_0x340984[_0x54142c(0x27c)],_0x58dd49=_0x574a6e['settings'];if(!_0x58dd49?.['webhookUrl']){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x574a6e['id']);return;}const _0x6d0f9c=_0x3f1c50===_0x54142c(0x21a)?_0x54142c(0x2a4):_0x3f1c50===_0x54142c(0x234)?_0x54142c(0x24f):_0x3f1c50===_0x54142c(0x211)?_0x54142c(0x24f):_0x3f1c50==='CHARGEBACK'?_0x54142c(0x24f):_0x3f1c50===_0x54142c(0x1fe)?'payment.failed':'payment.pending';let _0x227442=[];if(_0x58dd49[_0x54142c(0x222)])try{_0x227442=Array[_0x54142c(0x29e)](_0x58dd49['webhookEvents'])?_0x58dd49[_0x54142c(0x222)]:JSON[_0x54142c(0x1f0)](_0x58dd49[_0x54142c(0x222)]);}catch(_0x17ce67){console['error']('Error\x20parsing\x20webhook\x20events:',_0x17ce67),_0x227442=[];}if(!_0x227442['includes'](_0x6d0f9c)){console[_0x54142c(0x20c)](_0x54142c(0x22c)+_0x6d0f9c+_0x54142c(0x21d)+_0x574a6e['id']);return;}const _0x218151={'event':_0x6d0f9c,'payment':{'id':_0x340984['id'],'order_id':_0x340984['orderId'],'gateway_order_id':_0x340984[_0x54142c(0x238)],'gateway':_0x340984[_0x54142c(0x282)],'amount':_0x340984[_0x54142c(0x245)],'currency':_0x340984[_0x54142c(0x266)],'status':_0x3f1c50[_0x54142c(0x288)](),'customer_email':_0x340984[_0x54142c(0x22b)],'customer_name':_0x340984[_0x54142c(0x29d)],'failure_message':_0x340984[_0x54142c(0x23a)],'tx_urls':_0x340984['txUrls']?JSON[_0x54142c(0x1f0)](_0x340984['txUrls']):null,'created_at':_0x340984[_0x54142c(0x232)],'updated_at':_0x340984[_0x54142c(0x221)]}},_0x2db060=await fetch(_0x58dd49[_0x54142c(0x202)],{'method':_0x54142c(0x257),'headers':{'Content-Type':_0x54142c(0x274),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x54142c(0x25e)](_0x218151)}),_0xfd344=Date[_0x54142c(0x229)]()-_0x31ddb4,_0x2e14c0=_0x2db060['ok']?_0x54142c(0x1e8):await _0x2db060[_0x54142c(0x1ea)]();loggerService_1[_0x54142c(0x22e)][_0x54142c(0x218)](_0x340984[_0x54142c(0x29b)],_0x58dd49['webhookUrl'],_0x6d0f9c,_0x2db060[_0x54142c(0x259)],_0xfd344,_0x218151),console[_0x54142c(0x20c)]('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x58dd49[_0x54142c(0x202)]+_0x54142c(0x227)+_0x2db060[_0x54142c(0x259)]+'\x20('+_0xfd344+_0x54142c(0x21b));}catch(_0xa91fc2){console[_0x54142c(0x262)](_0x54142c(0x28e),_0xa91fc2),loggerService_1[_0x54142c(0x22e)][_0x54142c(0x2ae)](_0x340984[_0x54142c(0x29b)],_0x340984[_0x54142c(0x27c)]?.[_0x54142c(0x264)]?.[_0x54142c(0x202)]||_0x54142c(0x22f),_0x54142c(0x249),_0xa91fc2,{});}}async['sendPaymentStatusNotification'](_0x2e78a9,_0x172196){const _0x160201=a58_0x4944be;try{const _0x305aae={'PENDING':'created','PROCESSING':_0x160201(0x1f1),'PAID':_0x160201(0x299),'FAILED':_0x160201(0x279),'EXPIRED':_0x160201(0x244),'REFUND':_0x160201(0x239),'CHARGEBACK':'chargeback'},_0x44d27d=_0x305aae[_0x172196];if(!_0x44d27d||_0x44d27d===_0x160201(0x26e))return;await telegramBotService_1[_0x160201(0x250)]['sendPaymentNotification'](_0x2e78a9[_0x160201(0x29b)],_0x2e78a9,_0x44d27d);}catch(_0xd66c60){console[_0x160201(0x262)](_0x160201(0x21e),_0xd66c60);}}}exports[a58_0x4944be(0x2b8)]=WebhookService;