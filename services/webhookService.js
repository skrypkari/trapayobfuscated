'use strict';const a64_0x2d96fc=a64_0xcd4c;(function(_0xfdb4a,_0x327a7b){const _0x477e24=a64_0xcd4c,_0x6f9577=_0xfdb4a();while(!![]){try{const _0x1017fd=parseInt(_0x477e24(0xb9))/0x1+-parseInt(_0x477e24(0xab))/0x2+parseInt(_0x477e24(0xde))/0x3+parseInt(_0x477e24(0x130))/0x4+parseInt(_0x477e24(0xf4))/0x5*(parseInt(_0x477e24(0x168))/0x6)+parseInt(_0x477e24(0x136))/0x7+parseInt(_0x477e24(0x171))/0x8*(-parseInt(_0x477e24(0x11e))/0x9);if(_0x1017fd===_0x327a7b)break;else _0x6f9577['push'](_0x6f9577['shift']());}catch(_0x30e37b){_0x6f9577['push'](_0x6f9577['shift']());}}}(a64_0x4d89,0x653fa));function a64_0xcd4c(_0x5a7c57,_0x4b7cfa){const _0x4d8936=a64_0x4d89();return a64_0xcd4c=function(_0xcd4c78,_0x561b63){_0xcd4c78=_0xcd4c78-0xa4;let _0x440055=_0x4d8936[_0xcd4c78];return _0x440055;},a64_0xcd4c(_0x5a7c57,_0x4b7cfa);}var __importDefault=this&&this[a64_0x2d96fc(0x191)]||function(_0x22b334){const _0x4b4234=a64_0x2d96fc;return _0x22b334&&_0x22b334[_0x4b4234(0x1d7)]?_0x22b334:{'default':_0x22b334};};Object['defineProperty'](exports,a64_0x2d96fc(0x1d7),{'value':!![]}),exports[a64_0x2d96fc(0xcc)]=void 0x0;function a64_0x4d89(){const _0x36a827=['webhookLog','ampay_','nodaService','📊\x20Amer\x20webhook\x20result:','📊\x20Noda\x20webhook:\x20Payment\x20','699172fNAVmv','✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','loggerService','settings','remitterIban','ms)','4944345xKVdmn','❌\x20Payment\x20link\x20','🔍\x20Found\x20VISA\x20payment:\x20ID=','unknown','stringify','mastercard','\x22,\x20orderId=\x22','text','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','🔄\x20MyXSpend\x20status\x20','📊\x20VISA\x20payment\x20found:\x20','VISA\x20payment\x20not\x20found:\x20','\x20+\x20','\x20mapped\x20to\x20FAILED','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','🔄\x20Processing\x20MyXSpend\x20webhook:','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','❌\x20Error\x20processing\x20MasterCard\x20webhook:','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20',',\x20using\x20default\x2010%','coinToPayService','processing','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paymentLinkId','📊\x20MasterCard\x20webhook\x20result:','\x20balance\x20updated:\x20','\x20commission\x20for\x20shop\x20','🔄\x20Additional\x20data:','default',',\x20status=','dateTime','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','rapyd','\x22,\x20paymentLinkId=\x22','refund','create','logWebhookProcessed','🔍\x20VISA\x20payment\x20search\x20executed','paidAt','bankId',':\x20type=','type','processKlymeWebhook','shop','currentPayments','VisaMasterCardService','commission','currency','🔄\x20Processing\x20Plisio\x20webhook:','6XAydzm','💰\x20Removing\x20from\x20balance:\x20','chargebackAmount','%\x20gateway\x20commission)','SINGLE','created','\x20status\x20','amer','🔍\x20Search\x20result:\x20','1294248vmCtrM','failureMessage','cardLast4','Gateway\x20','\x20with\x20status\x20','📊\x20AmPay\x20webhook\x20data:','expired',',\x20Status=','processWebhook','webhook_status_change_','isArray','\x20to\x20','MASTERCARD','Error\x20processing\x20Noda\x20webhook:','amerService','🏪\x20Shop\x20','status','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','No\x20payment\x20ID\x20in\x20Noda\x20webhook','keys','🔄\x20Processing\x20Noda\x20webhook:','Success','No\x20payment\x20ID\x20in\x20Amer\x20webhook','balance',',\x20gatewayOrderId:\x20','telegramBotService','💰\x20Adding\x20to\x20balance:\x20','logShopWebhookSent','\x20not\x20enabled\x20for\x20shop\x20','payment_method','paymentLink','visa_','__importDefault','error','CoinToPayService','./gateways/coinToPayService','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','processVisaWebhook','Payment\x20System/1.0','\x22,\x20newStatus=\x22','PlisioService','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','POST','amount','./gateways/klymeService','myxspend','ℹ️\x20MyXSpend\x20status\x20','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','🔄\x20Processing\x20Amer\x20webhook:','toLowerCase','system_id','processMyXSpendWebhook','Error\x20processing\x20CoinToPay\x20webhook:','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','❌\x20Error\x20processing\x20AmPay\x20webhook:','webhookUrl','./gateways/amerService','./gateways/rapydService','visa/mastercard','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','payment','paymentId','CHARGEBACK','no\x20balance\x20change','txUrls','update','📊\x20Plisio\x20webhook:\x20Payment\x20','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','./currencyService','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','processCoinToPay2Webhook','EXPIRED','includes','toUpperCase','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','💰\x20Payment\x20','ℹ️\x20AmPay\x20status\x20','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','ampay',',\x20newStatus=','log','plisio','cointopay','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','logWebhookError','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','processRapydWebhook','visa','📈\x20Payment\x20details:\x20oldStatus=\x22','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','🔄\x20Processing\x20AmPay\x20webhook:','parse','toFixed','📊\x20MyXSpend\x20webhook\x20data:','\x20USDT','payment.failed','./gateways/ampayService','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','__esModule','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','Webhook\x20event\x20','\x20-\x20','updatedAt','gatewayCommissionRate','Failed\x20to\x20send\x20shop\x20webhook:','Found\x20payment\x20','customerName','\x20current\x20balance:\x20','visa_mastercard','1127082QBxCAW','status_addition_info','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','📊\x20Amer\x20webhook:\x20Payment\x20','📤\x20Shop\x20webhook\x20sent\x20to\x20','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','gatewayOrderId','rapydService','CoinToPay2Service','MasterCard\x20payment\x20not\x20found:\x20','📊\x20CoinToPay\x20webhook:\x20Payment\x20','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','Error\x20processing\x20KLYME\x20webhook:','webhookEvents','618639YUWXPW','gateway','sendPaymentNotification','gatewayPaymentId','\x20→\x20','Payment\x20not\x20found','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','Payment\x20not\x20found:\x20','sendShopWebhook','plisioService',',\x20card:\x20****','processMasterCardWebhook','coinToPay2Service','currencyService','./gateways/coinToPay2Service','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','processAmPayWebhook','visaMasterCardService','🔄\x20Processing\x20MasterCard\x20webhook:','WebhookService','updatePaymentStatus','cointopay2','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','Payment\x20','processAmerWebhook','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','\x22,\x20id=\x22','desc','FAILED','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','findMany','Error\x20processing\x20Rapyd\x20webhook:','🔄\x20Processing\x20CoinToPay2\x20webhook:','💸\x20Additional\x20chargeback\x20penalty:\x20-','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','toISOString','paymentMethod','1873671iLNJxb','processNodaWebhook','chargeback',',\x20Card=****','createdAt','ℹ️\x20Decline\x20reason:\x20','amountUSDT','gatewaySettings','remitterName','📊\x20VISA\x20webhook\x20result:','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','now','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','📈\x20Payment\x20','\x20for\x20MyXSpend\x20webhook','\x20in\x20shop\x20','./loggerService','Not\x20found','klyme',',\x20gatewayPaymentId:\x20','../config/database','2358705GdapqB',',\x20using\x20default\x20commission\x2010%','./gateways/plisioService','./gateways/mastercardService','\x20updated:\x20currentPayments=','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','processPlisioWebhook','\x20->\x20','amountAfterGatewayCommissionUSDT','findUnique','❌\x20Available\x20webhook\x20fields:','\x20and\x20-','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','username','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','Query\x20params:','plisio_gateway','entries','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','payment.success','\x20commission:\x20','customerOrderId','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','./gateways/nodaService',',\x20currentPayments=','noda','✅\x20Found\x20payment\x20','findFirst','orderId','AmerService','webhook_send','❌\x20Error\x20processing\x20Amer\x20webhook:','📊\x20Payment\x20status:\x20','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','sendPaymentStatusNotification','PAID','shopId','90mUHScO','ampayService','📊\x20KLYME\x20webhook:\x20Payment\x20','additionalInfo','\x20=\x20','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','klymeService','No\x20additional\x20info','\x20status\x20updated\x20to\x20FAILED','DECLINED','💰\x20Gateway\x20','Body\x20data:','💰\x20Converting\x20'];a64_0x4d89=function(){return _0x36a827;};return a64_0x4d89();}const database_1=__importDefault(require(a64_0x2d96fc(0xf3))),plisioService_1=require(a64_0x2d96fc(0xf6)),rapydService_1=require(a64_0x2d96fc(0x1ab)),nodaService_1=require(a64_0x2d96fc(0x110)),coinToPayService_1=require(a64_0x2d96fc(0x194)),coinToPay2Service_1=require(a64_0x2d96fc(0xc7)),klymeService_1=require(a64_0x2d96fc(0x19d)),mastercardService_1=require(a64_0x2d96fc(0xf7)),amerService_1=require(a64_0x2d96fc(0x1aa)),ampayService_1=require(a64_0x2d96fc(0x1d5)),telegramBotService_1=require('./telegramBotService'),currencyService_1=require(a64_0x2d96fc(0x1b9)),loggerService_1=require(a64_0x2d96fc(0xef));class WebhookService{constructor(){const _0x2ba3dd=a64_0x2d96fc;this[_0x2ba3dd(0xc2)]=new plisioService_1[(_0x2ba3dd(0x199))](),this['rapydService']=new rapydService_1['RapydService'](),this[_0x2ba3dd(0x12d)]=new nodaService_1['NodaService'](),this[_0x2ba3dd(0x14b)]=new coinToPayService_1[(_0x2ba3dd(0x193))](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x2ba3dd(0xb3))](),this[_0x2ba3dd(0x124)]=new klymeService_1['KlymeService'](),this[_0x2ba3dd(0xca)]=new mastercardService_1[(_0x2ba3dd(0x164))](),this[_0x2ba3dd(0x17f)]=new amerService_1[(_0x2ba3dd(0x116))](),this[_0x2ba3dd(0x11f)]=new ampayService_1['AmPayService']();}async[a64_0x2d96fc(0xcd)](_0x3da5b2,_0x2d81c2,_0x53a7ca){const _0x5aef5f=a64_0x2d96fc;console[_0x5aef5f(0x1c5)](_0x5aef5f(0x1c8)+_0x3da5b2+_0x5aef5f(0x1c4)+_0x2d81c2),console[_0x5aef5f(0x1c5)](_0x5aef5f(0x152),_0x53a7ca),await database_1[_0x5aef5f(0x153)]['$transaction'](async _0x36e57f=>{const _0x505661=_0x5aef5f,_0x47fb0b=await _0x36e57f[_0x505661(0x1ae)]['findUnique']({'where':{'id':_0x3da5b2},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x47fb0b)throw new Error(_0x505661(0xd0)+_0x3da5b2+'\x20not\x20found');const _0x24f120=_0x47fb0b['status'],_0x1b45a7=_0x47fb0b[_0x505661(0x162)];console['log'](_0x505661(0x1c0)+_0x3da5b2+':\x20'+_0x24f120+_0x505661(0xfb)+_0x2d81c2),console['log'](_0x505661(0x180)+_0x1b45a7['username']+_0x505661(0xa9)+_0x1b45a7['balance']+'\x20USDT');const _0x3fc8f6={'status':_0x2d81c2[_0x505661(0x1be)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x53a7ca?.['failureMessage']&&(_0x3fc8f6[_0x505661(0x172)]=_0x53a7ca['failureMessage']);_0x53a7ca?.[_0x505661(0x1b2)]&&(_0x3fc8f6[_0x505661(0x1b2)]=JSON[_0x505661(0x13a)](_0x53a7ca[_0x505661(0x1b2)]));_0x53a7ca?.[_0x505661(0x173)]&&(_0x3fc8f6[_0x505661(0x173)]=_0x53a7ca[_0x505661(0x173)]);_0x53a7ca?.['paymentMethod']&&(_0x3fc8f6[_0x505661(0xdd)]=_0x53a7ca[_0x505661(0xdd)]);_0x53a7ca?.['bankId']&&(_0x3fc8f6['bankId']=_0x53a7ca[_0x505661(0x15e)]);_0x53a7ca?.['remitterIban']&&(_0x3fc8f6[_0x505661(0x134)]=_0x53a7ca[_0x505661(0x134)]);_0x53a7ca?.[_0x505661(0xe6)]&&(_0x3fc8f6[_0x505661(0xe6)]=_0x53a7ca['remitterName']);let _0x634586=_0x1b45a7['balance'],_0x342e9e='';if(_0x2d81c2[_0x505661(0x1be)]()===_0x505661(0x11c)&&_0x24f120!==_0x505661(0x11c)){const _0x50a8a6=await currencyService_1[_0x505661(0xc6)]['convertToUSDT'](_0x47fb0b[_0x505661(0x19c)],_0x47fb0b[_0x505661(0x166)]),_0x58011d=await this['getGatewayCommission'](_0x1b45a7['id'],_0x47fb0b['gateway']),_0x4ce40c=_0x50a8a6*(0x1-_0x58011d/0x64);_0x634586+=_0x4ce40c,_0x342e9e='+'+_0x4ce40c[_0x505661(0x1d1)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20'+_0x58011d+_0x505661(0x16b),_0x3fc8f6[_0x505661(0xe4)]=_0x50a8a6,_0x3fc8f6[_0x505661(0xfc)]=_0x4ce40c,_0x3fc8f6[_0x505661(0xa5)]=_0x58011d,_0x3fc8f6[_0x505661(0x15d)]=new Date(),console[_0x505661(0x1c5)](_0x505661(0x12a)+_0x47fb0b[_0x505661(0x19c)]+'\x20'+_0x47fb0b[_0x505661(0x166)]+_0x505661(0xfb)+_0x50a8a6[_0x505661(0x1d1)](0x6)+_0x505661(0x1d3)),console[_0x505661(0x1c5)](_0x505661(0x128)+_0x47fb0b['gateway']+_0x505661(0x10c)+_0x58011d+'%'),console[_0x505661(0x1c5)]('💰\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x4ce40c[_0x505661(0x1d1)](0x6)+'\x20USDT'),console[_0x505661(0x1c5)](_0x505661(0x18b)+_0x1b45a7[_0x505661(0x188)]+_0x505661(0x142)+_0x4ce40c[_0x505661(0x1d1)](0x6)+'\x20=\x20'+_0x634586[_0x505661(0x1d1)](0x6)+'\x20USDT');}else{if(_0x24f120===_0x505661(0x11c)&&_0x2d81c2[_0x505661(0x1be)]()!=='PAID'){let _0x5a1b43;if(_0x47fb0b[_0x505661(0xfc)])_0x5a1b43=_0x47fb0b['amountAfterGatewayCommissionUSDT'];else{if(_0x47fb0b['amountUSDT']){const _0x4672b4=await this['getGatewayCommission'](_0x1b45a7['id'],_0x47fb0b[_0x505661(0xba)]);_0x5a1b43=_0x47fb0b[_0x505661(0xe4)]*(0x1-_0x4672b4/0x64);}else console[_0x505661(0x1c5)]('No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance'),_0x5a1b43=0x0;}_0x5a1b43>0x0&&(_0x634586-=_0x5a1b43,_0x342e9e='-'+_0x5a1b43[_0x505661(0x1d1)](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x3fc8f6[_0x505661(0xe4)]=null,_0x3fc8f6[_0x505661(0xfc)]=null,_0x3fc8f6[_0x505661(0x15d)]=null,console['log'](_0x505661(0x169)+_0x1b45a7[_0x505661(0x188)]+_0x505661(0x1da)+_0x5a1b43[_0x505661(0x1d1)](0x6)+_0x505661(0x122)+_0x634586[_0x505661(0x1d1)](0x6)+_0x505661(0x1d3)));}}if(_0x2d81c2[_0x505661(0x1be)]()===_0x505661(0x1b0)){const _0xe0490=_0x53a7ca?.[_0x505661(0x16a)]||0x0;_0xe0490>0x0&&(_0x634586-=_0xe0490,_0x342e9e+=_0x505661(0xff)+_0xe0490[_0x505661(0x1d1)](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0x3fc8f6[_0x505661(0x16a)]=_0xe0490,console['log'](_0x505661(0xda)+_0xe0490[_0x505661(0x1d1)](0x6)+_0x505661(0x1d3)),console[_0x505661(0x1c5)]('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x634586[_0x505661(0x1d1)](0x6)+_0x505661(0x1d3)));}const _0x1726f4=await _0x36e57f['payment']['update']({'where':{'id':_0x3da5b2},'data':_0x3fc8f6});_0x634586!==_0x1b45a7[_0x505661(0x188)]&&(await _0x36e57f['shop'][_0x505661(0x1b3)]({'where':{'id':_0x1b45a7['id']},'data':{'balance':_0x634586}}),console['log']('✅\x20Shop\x20'+_0x1b45a7[_0x505661(0x104)]+_0x505661(0x150)+_0x1b45a7[_0x505661(0x188)][_0x505661(0x1d1)](0x6)+'\x20->\x20'+_0x634586['toFixed'](0x6)+_0x505661(0x1d3)),console[_0x505661(0x1c5)]('📝\x20Reason:\x20'+_0x342e9e));await _0x36e57f[_0x505661(0x12b)]['create']({'data':{'paymentId':_0x3da5b2,'shopId':_0x1b45a7['id'],'event':_0x505661(0x17a)+_0x2d81c2[_0x505661(0x1a3)](),'statusCode':0xc8,'responseBody':JSON[_0x505661(0x13a)]({'oldStatus':_0x24f120,'newStatus':_0x2d81c2[_0x505661(0x1be)](),'balanceChange':_0x342e9e||_0x505661(0x1b1),'oldBalance':_0x1b45a7[_0x505661(0x188)],'newBalance':_0x634586,'amountUSDT':_0x3fc8f6['amountUSDT'],'additionalData':_0x53a7ca,'timestamp':new Date()[_0x505661(0xdc)]()})}}),await this[_0x505661(0xc1)]({..._0x47fb0b,..._0x1726f4,'shop':_0x1b45a7},_0x2d81c2[_0x505661(0x1be)]()),await this[_0x505661(0x11b)]({..._0x47fb0b,..._0x1726f4},_0x2d81c2[_0x505661(0x1be)]());if(_0x24f120!=='PAID'&&_0x2d81c2[_0x505661(0x1be)]()==='PAID'){console[_0x505661(0x1c5)](_0x505661(0xec)+_0x3da5b2+_0x505661(0xd6)),console[_0x505661(0x1c5)](_0x505661(0x1cd)+_0x24f120+_0x505661(0x198)+_0x2d81c2['toUpperCase']()+_0x505661(0x158)+_0x47fb0b[_0x505661(0x14e)]+'\x22');if(_0x47fb0b[_0x505661(0x14e)])try{const _0x1700ec=await _0x36e57f[_0x505661(0x18f)]['findUnique']({'where':{'id':_0x47fb0b['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1700ec){console[_0x505661(0x1c5)]('📈\x20Found\x20payment\x20link\x20'+_0x1700ec['id']+_0x505661(0x15f)+_0x1700ec[_0x505661(0x160)]+_0x505661(0x111)+_0x1700ec[_0x505661(0x163)]+',\x20status='+_0x1700ec[_0x505661(0x181)]);const _0x33d55a=_0x1700ec['currentPayments']+0x1,_0x2b9384=_0x1700ec['type']===_0x505661(0x16c)?'COMPLETED':_0x1700ec[_0x505661(0x181)];await _0x36e57f[_0x505661(0x18f)][_0x505661(0x1b3)]({'where':{'id':_0x47fb0b['paymentLinkId']},'data':{'currentPayments':_0x33d55a,'status':_0x2b9384,'updatedAt':new Date()}}),console[_0x505661(0x1c5)]('✅\x20Payment\x20link\x20'+_0x1700ec['id']+_0x505661(0xf8)+_0x1700ec[_0x505661(0x163)]+_0x505661(0xfb)+_0x33d55a+_0x505661(0x154)+_0x1700ec['status']+_0x505661(0xfb)+_0x2b9384);}else console['log'](_0x505661(0x137)+_0x47fb0b[_0x505661(0x14e)]+'\x20not\x20found');}catch(_0x1594ee){console[_0x505661(0x192)]('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x1594ee);}else console[_0x505661(0x1c5)](_0x505661(0xec)+_0x3da5b2+_0x505661(0x195));}else console[_0x505661(0x1c5)](_0x505661(0xec)+_0x3da5b2+_0x505661(0x149)+_0x24f120+_0x505661(0xfb)+_0x2d81c2[_0x505661(0x1be)]());});}async[a64_0x2d96fc(0xfa)](_0x44a67d){const _0x565ac9=a64_0x2d96fc;console['log'](_0x565ac9(0x167),_0x44a67d);try{const _0x152b73=await this[_0x565ac9(0xc2)][_0x565ac9(0x179)](_0x44a67d);if(!_0x152b73[_0x565ac9(0x1af)])throw new Error(_0x565ac9(0xbf));const _0x2887c4=await database_1['default'][_0x565ac9(0x1ae)][_0x565ac9(0x114)]({'where':{'gatewayOrderId':_0x152b73[_0x565ac9(0x1af)]}});if(!_0x2887c4){console[_0x565ac9(0x192)](_0x565ac9(0x144)+_0x152b73['paymentId']);return;}console[_0x565ac9(0x1c5)](_0x565ac9(0x1b4)+_0x2887c4['id']+_0x565ac9(0x16e)+_0x152b73[_0x565ac9(0x181)]),await this[_0x565ac9(0xcd)](_0x2887c4['id'],_0x152b73[_0x565ac9(0x181)],{'txUrls':_0x152b73[_0x565ac9(0x1b2)]}),loggerService_1[_0x565ac9(0x132)]['logWebhookProcessed'](_0x565ac9(0x1c6),_0x2887c4['id'],_0x2887c4[_0x565ac9(0x181)],_0x152b73[_0x565ac9(0x181)],_0x44a67d);}catch(_0x4040a3){console[_0x565ac9(0x192)]('Error\x20processing\x20Plisio\x20webhook:',_0x4040a3),loggerService_1[_0x565ac9(0x132)][_0x565ac9(0x1c9)](_0x565ac9(0x1c6),_0x4040a3,_0x44a67d);throw _0x4040a3;}}async['processPlisioGatewayWebhook'](_0x51d85d){const _0x359630=a64_0x2d96fc;console['log'](_0x359630(0x1b7),_0x51d85d);try{const _0x1ce1c9=await this[_0x359630(0xc2)][_0x359630(0x179)](_0x51d85d);if(!_0x1ce1c9[_0x359630(0x1af)])throw new Error(_0x359630(0x1ca));const _0x5bd901=await database_1[_0x359630(0x153)][_0x359630(0x1ae)][_0x359630(0x114)]({'where':{'gatewayOrderId':_0x1ce1c9[_0x359630(0x1af)]}});if(!_0x5bd901){console[_0x359630(0x192)](_0x359630(0xb6)+_0x1ce1c9[_0x359630(0x1af)]);return;}console[_0x359630(0x1c5)](_0x359630(0x102)+_0x5bd901['id']+_0x359630(0x16e)+_0x1ce1c9[_0x359630(0x181)]),await this['updatePaymentStatus'](_0x5bd901['id'],_0x1ce1c9['status'],{'txUrls':_0x1ce1c9[_0x359630(0x1b2)]}),loggerService_1[_0x359630(0x132)][_0x359630(0x15b)](_0x359630(0x107),_0x5bd901['id'],_0x5bd901[_0x359630(0x181)],_0x1ce1c9[_0x359630(0x181)],_0x51d85d);}catch(_0x3c0d25){console['error'](_0x359630(0x101),_0x3c0d25),loggerService_1[_0x359630(0x132)][_0x359630(0x1c9)]('plisio_gateway',_0x3c0d25,_0x51d85d);throw _0x3c0d25;}}async[a64_0x2d96fc(0x1cb)](_0x13d511){const _0x1ae385=a64_0x2d96fc;console[_0x1ae385(0x1c5)]('🔄\x20Processing\x20Rapyd\x20webhook:',_0x13d511);try{const _0x57b236=await this[_0x1ae385(0xb2)][_0x1ae385(0x179)](_0x13d511);if(!_0x57b236[_0x1ae385(0x1af)])throw new Error(_0x1ae385(0xc8));const _0x434000=await database_1[_0x1ae385(0x153)]['payment'][_0x1ae385(0x114)]({'where':{'gatewayOrderId':_0x57b236[_0x1ae385(0x1af)]}});if(!_0x434000){console[_0x1ae385(0x192)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x57b236['paymentId']);return;}console[_0x1ae385(0x1c5)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x434000['id']+_0x1ae385(0x16e)+_0x57b236[_0x1ae385(0x181)]),await this['updatePaymentStatus'](_0x434000['id'],_0x57b236[_0x1ae385(0x181)],{'failureMessage':_0x57b236[_0x1ae385(0x172)],'cardLast4':_0x57b236[_0x1ae385(0x121)]?.[_0x1ae385(0x173)],'paymentMethod':_0x57b236[_0x1ae385(0x121)]?.[_0x1ae385(0xdd)]}),loggerService_1[_0x1ae385(0x132)][_0x1ae385(0x15b)](_0x1ae385(0x157),_0x434000['id'],_0x434000['status'],_0x57b236[_0x1ae385(0x181)],_0x13d511);}catch(_0x44111a){console[_0x1ae385(0x192)](_0x1ae385(0xd8),_0x44111a),loggerService_1[_0x1ae385(0x132)]['logWebhookError'](_0x1ae385(0x157),_0x44111a,_0x13d511);throw _0x44111a;}}async[a64_0x2d96fc(0xdf)](_0x4b18e2){const _0x1e08ea=a64_0x2d96fc;console[_0x1e08ea(0x1c5)](_0x1e08ea(0x185),_0x4b18e2);try{const _0x18e335=await this[_0x1e08ea(0x12d)]['processWebhook'](_0x4b18e2);if(!_0x18e335[_0x1e08ea(0x1af)])throw new Error(_0x1e08ea(0x183));const _0x3670c0=await database_1[_0x1e08ea(0x153)]['payment'][_0x1e08ea(0x114)]({'where':{'gatewayOrderId':_0x18e335['paymentId']}});if(!_0x3670c0){console['error'](_0x1e08ea(0x1b8)+_0x18e335['paymentId']);return;}console['log'](_0x1e08ea(0x12f)+_0x3670c0['id']+_0x1e08ea(0x16e)+_0x18e335[_0x1e08ea(0x181)]),await this[_0x1e08ea(0xcd)](_0x3670c0['id'],_0x18e335[_0x1e08ea(0x181)],{'bankId':_0x18e335[_0x1e08ea(0x121)]?.[_0x1e08ea(0x15e)],'remitterIban':_0x18e335[_0x1e08ea(0x121)]?.[_0x1e08ea(0x134)],'remitterName':_0x18e335[_0x1e08ea(0x121)]?.[_0x1e08ea(0xe6)]}),loggerService_1[_0x1e08ea(0x132)][_0x1e08ea(0x15b)](_0x1e08ea(0x112),_0x3670c0['id'],_0x3670c0[_0x1e08ea(0x181)],_0x18e335[_0x1e08ea(0x181)],_0x4b18e2);}catch(_0x5c1bb8){console[_0x1e08ea(0x192)](_0x1e08ea(0x17e),_0x5c1bb8),loggerService_1[_0x1e08ea(0x132)][_0x1e08ea(0x1c9)](_0x1e08ea(0x112),_0x5c1bb8,_0x4b18e2);throw _0x5c1bb8;}}async['processCoinToPayWebhook'](_0x2accc5){const _0x493b00=a64_0x2d96fc;console[_0x493b00(0x1c5)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x2accc5);try{const _0x1857d1=await this['coinToPayService'][_0x493b00(0x179)](_0x2accc5);if(!_0x1857d1[_0x493b00(0x1af)])throw new Error(_0x493b00(0x182));const _0x7780dc=await database_1[_0x493b00(0x153)][_0x493b00(0x1ae)][_0x493b00(0x114)]({'where':{'gatewayOrderId':_0x1857d1[_0x493b00(0x1af)]}});if(!_0x7780dc){console['error']('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x1857d1[_0x493b00(0x1af)]);return;}console['log'](_0x493b00(0xb5)+_0x7780dc['id']+_0x493b00(0x16e)+_0x1857d1[_0x493b00(0x181)]),await this[_0x493b00(0xcd)](_0x7780dc['id'],_0x1857d1[_0x493b00(0x181)]),loggerService_1[_0x493b00(0x132)]['logWebhookProcessed'](_0x493b00(0x1c7),_0x7780dc['id'],_0x7780dc[_0x493b00(0x181)],_0x1857d1[_0x493b00(0x181)],_0x2accc5);}catch(_0x471e4b){console[_0x493b00(0x192)](_0x493b00(0x1a6),_0x471e4b),loggerService_1[_0x493b00(0x132)][_0x493b00(0x1c9)](_0x493b00(0x1c7),_0x471e4b,_0x2accc5);throw _0x471e4b;}}async[a64_0x2d96fc(0x1bb)](_0x30d622){const _0x3bc105=a64_0x2d96fc;console[_0x3bc105(0x1c5)](_0x3bc105(0xd9),_0x30d622);try{const _0x171582=await this[_0x3bc105(0xc5)][_0x3bc105(0x179)](_0x30d622);if(!_0x171582[_0x3bc105(0x1af)])throw new Error(_0x3bc105(0x146));const _0x16a9fa=await database_1[_0x3bc105(0x153)]['payment'][_0x3bc105(0x114)]({'where':{'gatewayOrderId':_0x171582[_0x3bc105(0x1af)]}});if(!_0x16a9fa){console['error'](_0x3bc105(0x1ad)+_0x171582[_0x3bc105(0x1af)]);return;}console[_0x3bc105(0x1c5)]('📊\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x16a9fa['id']+_0x3bc105(0x16e)+_0x171582[_0x3bc105(0x181)]),await this[_0x3bc105(0xcd)](_0x16a9fa['id'],_0x171582[_0x3bc105(0x181)]),loggerService_1['loggerService'][_0x3bc105(0x15b)](_0x3bc105(0xce),_0x16a9fa['id'],_0x16a9fa['status'],_0x171582[_0x3bc105(0x181)],_0x30d622);}catch(_0x524905){console[_0x3bc105(0x192)]('Error\x20processing\x20CoinToPay2\x20webhook:',_0x524905),loggerService_1[_0x3bc105(0x132)]['logWebhookError'](_0x3bc105(0xce),_0x524905,_0x30d622);throw _0x524905;}}async[a64_0x2d96fc(0x161)](_0x11c3a6){const _0x1dfb7b=a64_0x2d96fc;console[_0x1dfb7b(0x1c5)]('🔄\x20Processing\x20KLYME\x20webhook:',_0x11c3a6);try{const _0x39bf06=await this['klymeService'][_0x1dfb7b(0x179)](_0x11c3a6);if(!_0x39bf06[_0x1dfb7b(0x1af)])throw new Error(_0x1dfb7b(0x19a));const _0x103285=await database_1[_0x1dfb7b(0x153)][_0x1dfb7b(0x1ae)]['findFirst']({'where':{'gatewayOrderId':_0x39bf06[_0x1dfb7b(0x1af)]}});if(!_0x103285){console[_0x1dfb7b(0x192)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x39bf06['paymentId']);return;}console['log'](_0x1dfb7b(0x120)+_0x103285['id']+'\x20status\x20'+_0x39bf06[_0x1dfb7b(0x181)]),await this[_0x1dfb7b(0xcd)](_0x103285['id'],_0x39bf06[_0x1dfb7b(0x181)],{'paymentMethod':_0x39bf06[_0x1dfb7b(0x121)]?.[_0x1dfb7b(0x18e)]}),loggerService_1[_0x1dfb7b(0x132)][_0x1dfb7b(0x15b)](_0x1dfb7b(0xf1),_0x103285['id'],_0x103285[_0x1dfb7b(0x181)],_0x39bf06['status'],_0x11c3a6);}catch(_0x59200f){console[_0x1dfb7b(0x192)](_0x1dfb7b(0xb7),_0x59200f),loggerService_1[_0x1dfb7b(0x132)][_0x1dfb7b(0x1c9)](_0x1dfb7b(0xf1),_0x59200f,_0x11c3a6);throw _0x59200f;}}async[a64_0x2d96fc(0x196)](_0x59598d){const _0x41e957=a64_0x2d96fc;console[_0x41e957(0x1c5)]('🔄\x20Processing\x20VISA\x20webhook:',JSON[_0x41e957(0x13a)](_0x59598d,null,0x2));try{const _0x271531=await this[_0x41e957(0xca)]['processWebhook'](_0x59598d,'VISA');console[_0x41e957(0x1c5)](_0x41e957(0xe7),_0x271531);if(!_0x271531[_0x41e957(0x1af)]){console[_0x41e957(0x192)](_0x41e957(0x123)),console['error'](_0x41e957(0xfe),Object[_0x41e957(0x184)](_0x59598d));throw new Error('No\x20payment\x20ID\x20in\x20VISA\x20webhook');}let _0x1d9e41=null;console['log'](_0x41e957(0xcf)+_0x271531['paymentId']);if(_0x271531['paymentId']){console[_0x41e957(0x1c5)]('🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...'),console[_0x41e957(0x1c5)](_0x41e957(0x148)),console['log'](_0x41e957(0x11a)),console[_0x41e957(0x1c5)](_0x41e957(0x156)+_0x271531[_0x41e957(0x1af)]),console[_0x41e957(0x1c5)](_0x41e957(0xe9)),_0x1d9e41=await database_1[_0x41e957(0x153)][_0x41e957(0x1ae)]['findFirst']({'where':{'AND':[{'OR':[{'gateway':'visa/mastercard'},{'gateway':_0x41e957(0x13b)}]},{'OR':[{'gatewayPaymentId':_0x271531['paymentId']},{'gatewayOrderId':_0x271531[_0x41e957(0x1af)]},{'id':_0x271531[_0x41e957(0x1af)]},{'orderId':_0x271531[_0x41e957(0x1af)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x41e957(0x1c5)](_0x41e957(0x15c));if(_0x1d9e41)console[_0x41e957(0x1c5)]('✅\x20Found\x20payment:\x20ID='+_0x1d9e41['id']+',\x20GatewayOrderId='+_0x1d9e41[_0x41e957(0xb1)]+',\x20GatewayPaymentId='+_0x1d9e41[_0x41e957(0xbc)]);else{console[_0x41e957(0x1c5)](_0x41e957(0x1ce));const _0x2e1f68=await database_1[_0x41e957(0x153)][_0x41e957(0x1ae)][_0x41e957(0xd7)]({'where':{'gateway':_0x41e957(0x1ac)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x41e957(0xd4)}});console[_0x41e957(0x1c5)]('🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:',_0x2e1f68['map'](_0x2d4554=>_0x2d4554['id']+'\x20(orderId:\x20'+_0x2d4554['orderId']+_0x41e957(0x189)+_0x2d4554[_0x41e957(0xb1)]+_0x41e957(0xf2)+_0x2d4554['gatewayPaymentId']+_0x41e957(0xc3)+_0x2d4554[_0x41e957(0x173)]+')'));}console[_0x41e957(0x1c5)]('🔍\x20VISA\x20payment\x20search\x20result:\x20'+(_0x1d9e41?'Found':_0x41e957(0xf0))),_0x1d9e41&&console[_0x41e957(0x1c5)](_0x41e957(0x138)+_0x1d9e41['id']+',\x20Gateway='+_0x1d9e41[_0x41e957(0xba)]+_0x41e957(0x178)+_0x1d9e41['status']+_0x41e957(0xe1)+_0x1d9e41[_0x41e957(0x173)]);}if(!_0x1d9e41){console[_0x41e957(0x192)](_0x41e957(0x1ba)+_0x271531[_0x41e957(0x1af)]),loggerService_1['loggerService'][_0x41e957(0x1c9)]('visa',new Error('Payment\x20not\x20found:\x20'+_0x271531[_0x41e957(0x1af)]),_0x59598d);throw new Error(_0x41e957(0x141)+_0x271531['paymentId']);}console['log'](_0x41e957(0x140)+_0x1d9e41['id']+'\x20(Status:\x20'+_0x1d9e41[_0x41e957(0x181)]+_0x41e957(0xbd)+_0x271531['status']+')');const _0x5a7bf4={};_0x271531['amount']&&await database_1[_0x41e957(0x153)][_0x41e957(0x1ae)]['update']({'where':{'id':_0x1d9e41['id']},'data':{'amount':_0x271531[_0x41e957(0x19c)],'updatedAt':new Date()}}),_0x271531[_0x41e957(0x166)]&&await database_1[_0x41e957(0x153)][_0x41e957(0x1ae)]['update']({'where':{'id':_0x1d9e41['id']},'data':{'currency':_0x271531[_0x41e957(0x166)],'updatedAt':new Date()}}),_0x271531[_0x41e957(0x181)]===_0x41e957(0xd5)&&_0x271531[_0x41e957(0x172)]&&(_0x5a7bf4[_0x41e957(0x172)]=_0x271531[_0x41e957(0x172)],console[_0x41e957(0x1c5)](_0x41e957(0x100)+_0x271531[_0x41e957(0x172)])),_0x5a7bf4[_0x41e957(0xdd)]=_0x41e957(0x1cc),await this[_0x41e957(0xcd)](_0x1d9e41['id'],_0x271531['status'],_0x5a7bf4),await database_1['default'][_0x41e957(0x12b)][_0x41e957(0x15a)]({'data':{'paymentId':_0x1d9e41['id'],'shopId':_0x1d9e41[_0x41e957(0x11d)],'event':_0x41e957(0x190)+_0x271531[_0x41e957(0x181)][_0x41e957(0x1a3)](),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x271531)}}),await this[_0x41e957(0x11b)](_0x1d9e41,_0x271531[_0x41e957(0x181)][_0x41e957(0x1be)]()),console['log'](_0x41e957(0x1c2)+_0x1d9e41['id']);}catch(_0x359088){console['error']('❌\x20VISA\x20webhook\x20processing\x20failed:',_0x359088),loggerService_1[_0x41e957(0x132)]['logWebhookError'](_0x41e957(0x1cc),_0x359088,_0x59598d);throw _0x359088;}}async[a64_0x2d96fc(0xc4)](_0x1ee259){const _0x3ab4b2=a64_0x2d96fc;console[_0x3ab4b2(0x1c5)](_0x3ab4b2(0xcb),JSON[_0x3ab4b2(0x13a)](_0x1ee259,null,0x2));try{const _0x2d5504=await this[_0x3ab4b2(0xca)][_0x3ab4b2(0x179)](_0x1ee259,_0x3ab4b2(0x17d));console['log'](_0x3ab4b2(0x14f),_0x2d5504);if(!_0x2d5504['paymentId']){console[_0x3ab4b2(0x192)](_0x3ab4b2(0xd2)),console[_0x3ab4b2(0x192)](_0x3ab4b2(0xfe),Object[_0x3ab4b2(0x184)](_0x1ee259));throw new Error(_0x3ab4b2(0x10a));}let _0x35d3aa=null;console[_0x3ab4b2(0x1c5)](_0x3ab4b2(0xeb)+_0x2d5504[_0x3ab4b2(0x1af)]);_0x2d5504['paymentId']&&(console[_0x3ab4b2(0x1c5)](_0x3ab4b2(0x1a0)),_0x35d3aa=await database_1['default'][_0x3ab4b2(0x1ae)][_0x3ab4b2(0x114)]({'where':{'AND':[{'OR':[{'gateway':_0x3ab4b2(0xaa)},{'gateway':_0x3ab4b2(0x13b)},{'gateway':_0x3ab4b2(0x1ac)}]},{'OR':[{'gatewayPaymentId':_0x2d5504[_0x3ab4b2(0x1af)]},{'gatewayOrderId':_0x2d5504[_0x3ab4b2(0x1af)]},{'id':_0x2d5504[_0x3ab4b2(0x1af)]},{'orderId':_0x2d5504[_0x3ab4b2(0x1af)]}]}]}}),console['log'](_0x3ab4b2(0x170)+(_0x35d3aa?_0x3ab4b2(0xa7)+_0x35d3aa['id']:_0x3ab4b2(0xbe))));if(!_0x35d3aa){console[_0x3ab4b2(0x192)]('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x2d5504[_0x3ab4b2(0x1af)]),console[_0x3ab4b2(0x192)](_0x3ab4b2(0x103)+_0x2d5504[_0x3ab4b2(0x1af)]+_0x3ab4b2(0xd3)+_0x2d5504[_0x3ab4b2(0x1af)]+_0x3ab4b2(0x13c)+_0x2d5504[_0x3ab4b2(0x1af)]+'\x22');const _0x9b7b5c=await database_1[_0x3ab4b2(0x153)][_0x3ab4b2(0x1ae)][_0x3ab4b2(0xd7)]({'where':{'OR':[{'gateway':_0x3ab4b2(0x13b)},{'gateway':_0x3ab4b2(0xaa)},{'gateway':_0x3ab4b2(0x1ac)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x3ab4b2(0xd4)},'take':0xf});console[_0x3ab4b2(0x1c5)](_0x3ab4b2(0xe8),_0x9b7b5c),loggerService_1[_0x3ab4b2(0x132)][_0x3ab4b2(0x1c9)]('mastercard',new Error(_0x3ab4b2(0xc0)+_0x2d5504[_0x3ab4b2(0x1af)]),_0x1ee259);throw new Error(_0x3ab4b2(0xb4)+_0x2d5504[_0x3ab4b2(0x1af)]);}console[_0x3ab4b2(0x1c5)]('✅\x20Found\x20payment\x20'+_0x35d3aa['id']+_0x3ab4b2(0xdb)+_0x35d3aa[_0x3ab4b2(0x181)]+_0x3ab4b2(0x17c)+_0x2d5504['status']);const _0x27ee05={};_0x2d5504[_0x3ab4b2(0x19c)]&&await database_1[_0x3ab4b2(0x153)][_0x3ab4b2(0x1ae)][_0x3ab4b2(0x1b3)]({'where':{'id':_0x35d3aa['id']},'data':{'amount':_0x2d5504[_0x3ab4b2(0x19c)],'updatedAt':new Date()}}),_0x2d5504[_0x3ab4b2(0x166)]&&await database_1[_0x3ab4b2(0x153)]['payment']['update']({'where':{'id':_0x35d3aa['id']},'data':{'currency':_0x2d5504[_0x3ab4b2(0x166)],'updatedAt':new Date()}}),_0x2d5504[_0x3ab4b2(0x181)]===_0x3ab4b2(0xd5)&&_0x2d5504[_0x3ab4b2(0x172)]&&(_0x27ee05[_0x3ab4b2(0x172)]=_0x2d5504[_0x3ab4b2(0x172)],console['log']('❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20'+_0x2d5504[_0x3ab4b2(0x172)])),_0x27ee05[_0x3ab4b2(0xdd)]='mastercard',await this[_0x3ab4b2(0xcd)](_0x35d3aa['id'],_0x2d5504[_0x3ab4b2(0x181)],_0x27ee05),loggerService_1['loggerService'][_0x3ab4b2(0x15b)](_0x3ab4b2(0x13b),_0x35d3aa['id'],_0x35d3aa[_0x3ab4b2(0x181)],_0x2d5504[_0x3ab4b2(0x181)],_0x1ee259);}catch(_0x1fc02c){console['error'](_0x3ab4b2(0x147),_0x1fc02c),loggerService_1[_0x3ab4b2(0x132)][_0x3ab4b2(0x1c9)](_0x3ab4b2(0x13b),_0x1fc02c,_0x1ee259);throw _0x1fc02c;}}async[a64_0x2d96fc(0xd1)](_0x5d9d4c){const _0x993b98=a64_0x2d96fc;console[_0x993b98(0x1c5)](_0x993b98(0x1a2),JSON[_0x993b98(0x13a)](_0x5d9d4c,null,0x2));try{const _0x52e298=await this[_0x993b98(0x17f)][_0x993b98(0x179)](_0x5d9d4c);console[_0x993b98(0x1c5)](_0x993b98(0x12e),_0x52e298);if(!_0x52e298[_0x993b98(0x1af)]){console[_0x993b98(0x192)](_0x993b98(0x10e)),console[_0x993b98(0x192)](_0x993b98(0xfe),Object[_0x993b98(0x184)](_0x5d9d4c));throw new Error(_0x993b98(0x187));}let _0x9dd517=null;console[_0x993b98(0x1c5)](_0x993b98(0x109)+_0x52e298['paymentId']),_0x9dd517=await database_1['default'][_0x993b98(0x1ae)][_0x993b98(0x114)]({'where':{'AND':[{'gateway':_0x993b98(0x16f)},{'OR':[{'gatewayPaymentId':_0x52e298[_0x993b98(0x1af)]},{'gatewayOrderId':_0x52e298[_0x993b98(0x1af)]},{'id':_0x52e298[_0x993b98(0x1af)]},{'orderId':_0x52e298['paymentId']}]}]}}),console[_0x993b98(0x1c5)](_0x993b98(0x170)+(_0x9dd517?'Found\x20payment\x20'+_0x9dd517['id']:_0x993b98(0xbe)));if(!_0x9dd517){console[_0x993b98(0x192)](_0x993b98(0xb0)+_0x52e298[_0x993b98(0x1af)]);return;}console['log'](_0x993b98(0xae)+_0x9dd517['id']+_0x993b98(0x16e)+_0x52e298[_0x993b98(0x181)]),await this[_0x993b98(0xcd)](_0x9dd517['id'],_0x52e298[_0x993b98(0x181)],{'cardLast4':_0x52e298[_0x993b98(0x121)]?.[_0x993b98(0x173)],'paymentMethod':_0x52e298[_0x993b98(0x121)]?.[_0x993b98(0xdd)]});}catch(_0x3e0d8e){console[_0x993b98(0x192)](_0x993b98(0x118),_0x3e0d8e),loggerService_1[_0x993b98(0x132)][_0x993b98(0x1c9)](_0x993b98(0x16f),_0x3e0d8e,_0x5d9d4c);throw _0x3e0d8e;}}async[a64_0x2d96fc(0xc9)](_0x360130){const _0x57ad89=a64_0x2d96fc;console[_0x57ad89(0x1c5)](_0x57ad89(0x1cf),JSON[_0x57ad89(0x13a)](_0x360130,null,0x2));try{const _0x164c5d=_0x360130['status'],_0x404de6=_0x360130['client_transaction_id'],_0x14992c=_0x360130[_0x57ad89(0x1a4)],_0x1c7502=_0x360130[_0x57ad89(0x18e)],_0x30fb93=_0x360130[_0x57ad89(0x19c)],_0x5d5261=_0x360130[_0x57ad89(0x166)],_0x2d38e1=_0x360130['commission'],_0x15c664=_0x360130[_0x57ad89(0xac)];if(!_0x404de6){console['error'](_0x57ad89(0x105));throw new Error(_0x57ad89(0x1b5));}console[_0x57ad89(0x1c5)](_0x57ad89(0x176),{'status':_0x164c5d,'clientTransactionId':_0x404de6,'systemId':_0x14992c,'paymentMethod':_0x1c7502,'amount':_0x30fb93,'currency':_0x5d5261,'commission':_0x2d38e1,'statusAdditionInfo':_0x15c664});const _0xfadd74=await database_1[_0x57ad89(0x153)][_0x57ad89(0x1ae)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x404de6},{'orderId':_0x404de6},{'id':_0x404de6},{'gatewayPaymentId':_0x404de6}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0xfadd74){console[_0x57ad89(0x192)](_0x57ad89(0x1bf)+_0x404de6);throw new Error(_0x57ad89(0xc0)+_0x404de6);}console['log'](_0x57ad89(0x113)+_0xfadd74['id']+'\x20for\x20AmPay\x20webhook'),console['log'](_0x57ad89(0x119)+_0xfadd74[_0x57ad89(0x181)]+_0x57ad89(0xbd)+_0x164c5d),_0x164c5d===_0x57ad89(0x127)?(console[_0x57ad89(0x1c5)](_0x57ad89(0x1d8)),await this[_0x57ad89(0xcd)](_0xfadd74['id'],_0x57ad89(0xd5)),console[_0x57ad89(0x1c5)]('✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20'+_0xfadd74['id']+_0x57ad89(0x126)),console[_0x57ad89(0x1c5)](_0x57ad89(0xe3)+(_0x15c664||_0x57ad89(0x125)))):console[_0x57ad89(0x1c5)](_0x57ad89(0x1c1)+_0x164c5d+_0x57ad89(0x10f)),await database_1[_0x57ad89(0x153)][_0x57ad89(0x12b)][_0x57ad89(0x15a)]({'data':{'paymentId':_0xfadd74['id'],'shopId':_0xfadd74[_0x57ad89(0x11d)],'event':_0x57ad89(0x12c)+(_0x164c5d?.['toLowerCase']()||_0x57ad89(0x139)),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x360130)}}),loggerService_1[_0x57ad89(0x132)]['logWebhookProcessed']('ampay',_0xfadd74['id'],_0xfadd74['status'],_0x164c5d===_0x57ad89(0x127)?_0x57ad89(0xd5):_0x164c5d,_0x360130);}catch(_0x21e529){console['error'](_0x57ad89(0x1a8),_0x21e529),loggerService_1['loggerService']['logWebhookError'](_0x57ad89(0x1c3),_0x21e529,_0x360130);throw _0x21e529;}}async['sendShopWebhook'](_0x488559,_0x46f66d){const _0x4ae5a1=a64_0x2d96fc,_0x5ce018=Date[_0x4ae5a1(0xea)]();try{const _0x261a2b=_0x488559['shop'],_0x56a093=_0x261a2b[_0x4ae5a1(0x133)];if(!_0x56a093?.[_0x4ae5a1(0x1a9)]){console[_0x4ae5a1(0x1c5)](_0x4ae5a1(0x14d)+_0x261a2b['id']);return;}const _0x3b7cab=_0x46f66d===_0x4ae5a1(0x11c)?_0x4ae5a1(0x10b):_0x46f66d===_0x4ae5a1(0xd5)?'payment.failed':_0x46f66d===_0x4ae5a1(0x1bc)?_0x4ae5a1(0x1d4):_0x46f66d===_0x4ae5a1(0x1b0)?'payment.failed':_0x46f66d==='REFUND'?'payment.failed':'payment.pending';let _0x2aa689=[];if(_0x56a093[_0x4ae5a1(0xb8)])try{_0x2aa689=Array[_0x4ae5a1(0x17b)](_0x56a093[_0x4ae5a1(0xb8)])?_0x56a093[_0x4ae5a1(0xb8)]:JSON['parse'](_0x56a093[_0x4ae5a1(0xb8)]);}catch(_0x78ee62){console[_0x4ae5a1(0x192)]('Error\x20parsing\x20webhook\x20events:',_0x78ee62),_0x2aa689=[];}if(!_0x2aa689[_0x4ae5a1(0x1bd)](_0x3b7cab)){console['log'](_0x4ae5a1(0x1d9)+_0x3b7cab+_0x4ae5a1(0x18d)+_0x261a2b['id']);return;}const _0x431a74={'event':_0x3b7cab,'payment':{'id':_0x488559['id'],'order_id':_0x488559[_0x4ae5a1(0x115)],'gateway_order_id':_0x488559['gatewayOrderId'],'gateway':_0x488559[_0x4ae5a1(0xba)],'amount':_0x488559[_0x4ae5a1(0x19c)],'currency':_0x488559[_0x4ae5a1(0x166)],'status':_0x46f66d[_0x4ae5a1(0x1a3)](),'customer_email':_0x488559['customerEmail'],'customer_name':_0x488559[_0x4ae5a1(0xa8)],'failure_message':_0x488559[_0x4ae5a1(0x172)],'tx_urls':_0x488559[_0x4ae5a1(0x1b2)]?JSON[_0x4ae5a1(0x1d0)](_0x488559[_0x4ae5a1(0x1b2)]):null,'created_at':_0x488559[_0x4ae5a1(0xe2)],'updated_at':_0x488559[_0x4ae5a1(0xa4)]}},_0x188a67=await fetch(_0x56a093[_0x4ae5a1(0x1a9)],{'method':_0x4ae5a1(0x19b),'headers':{'Content-Type':'application/json','User-Agent':_0x4ae5a1(0x197)},'body':JSON[_0x4ae5a1(0x13a)](_0x431a74)}),_0x26603a=Date[_0x4ae5a1(0xea)]()-_0x5ce018,_0x5d6c53=_0x188a67['ok']?_0x4ae5a1(0x186):await _0x188a67[_0x4ae5a1(0x13d)]();loggerService_1[_0x4ae5a1(0x132)][_0x4ae5a1(0x18c)](_0x488559[_0x4ae5a1(0x11d)],_0x56a093[_0x4ae5a1(0x1a9)],_0x3b7cab,_0x188a67[_0x4ae5a1(0x181)],_0x26603a,_0x431a74),console[_0x4ae5a1(0x1c5)](_0x4ae5a1(0xaf)+_0x56a093[_0x4ae5a1(0x1a9)]+_0x4ae5a1(0x175)+_0x188a67[_0x4ae5a1(0x181)]+'\x20('+_0x26603a+_0x4ae5a1(0x135));}catch(_0x2b2244){console['error'](_0x4ae5a1(0xa6),_0x2b2244),loggerService_1[_0x4ae5a1(0x132)]['logShopWebhookError'](_0x488559[_0x4ae5a1(0x11d)],_0x488559[_0x4ae5a1(0x162)]?.['settings']?.['webhookUrl']||_0x4ae5a1(0x139),_0x4ae5a1(0x117),_0x2b2244,{});}}async['sendPaymentStatusNotification'](_0x2b6d97,_0x14e397){const _0x31942b=a64_0x2d96fc;try{const _0x208e40={'PENDING':'created','PROCESSING':_0x31942b(0x14c),'PAID':'paid','FAILED':'failed','EXPIRED':_0x31942b(0x177),'REFUND':_0x31942b(0x159),'CHARGEBACK':_0x31942b(0xe0)},_0x3264a8=_0x208e40[_0x14e397];if(!_0x3264a8||_0x3264a8===_0x31942b(0x16d))return;await telegramBotService_1[_0x31942b(0x18a)][_0x31942b(0xbb)](_0x2b6d97['shopId'],_0x2b6d97,_0x3264a8);}catch(_0x1c4635){console[_0x31942b(0x192)](_0x31942b(0x1b6),_0x1c4635);}}async['getGatewayCommission'](_0xf26848,_0x212fe6){const _0x483695=a64_0x2d96fc;try{const _0x59e7a0=await database_1['default']['shop'][_0x483695(0xfd)]({'where':{'id':_0xf26848},'select':{'gatewaySettings':!![]}});if(!_0x59e7a0?.['gatewaySettings'])return console[_0x483695(0x1c5)](_0x483695(0x13e)+_0xf26848+_0x483695(0xf5)),0xa;const _0x340efd=JSON[_0x483695(0x1d0)](_0x59e7a0[_0x483695(0xe5)]);for(const [_0x39a753,_0x1963c6]of Object[_0x483695(0x108)](_0x340efd)){if(_0x39a753[_0x483695(0x1a3)]()===_0x212fe6['toLowerCase']()){const _0x344546=_0x1963c6[_0x483695(0x165)]||0xa;return console[_0x483695(0x1c5)](_0x483695(0x174)+_0x212fe6+_0x483695(0x151)+_0xf26848+':\x20'+_0x344546+'%'),_0x344546;}}return console[_0x483695(0x1c5)](_0x483695(0x1a1)+_0x212fe6+_0x483695(0xee)+_0xf26848+_0x483695(0x14a)),0xa;}catch(_0x4f0cc8){return console[_0x483695(0x192)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0xf26848+',\x20gateway\x20'+_0x212fe6+':',_0x4f0cc8),0xa;}}async[a64_0x2d96fc(0x1a5)](_0x18b2ea,_0x4099b8){const _0x85875a=a64_0x2d96fc;console['log'](_0x85875a(0x145)),console[_0x85875a(0x1c5)](_0x85875a(0x106),JSON[_0x85875a(0x13a)](_0x18b2ea,null,0x2)),console[_0x85875a(0x1c5)](_0x85875a(0x129),JSON[_0x85875a(0x13a)](_0x4099b8,null,0x2));try{const _0x27fe75=_0x18b2ea['customerOrderId']||_0x4099b8[_0x85875a(0x10d)],_0x27804f=_0x18b2ea[_0x85875a(0x181)]||_0x4099b8['status'],_0x578457=_0x18b2ea[_0x85875a(0x19c)]||_0x4099b8[_0x85875a(0x19c)],_0x4c7112=_0x18b2ea[_0x85875a(0x166)]||_0x4099b8[_0x85875a(0x166)],_0x312945=_0x18b2ea[_0x85875a(0x155)]||_0x4099b8[_0x85875a(0x155)];if(!_0x27fe75){console[_0x85875a(0x192)](_0x85875a(0x1d6));throw new Error('Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook');}console[_0x85875a(0x1c5)](_0x85875a(0x1d2),{'customerOrderId':_0x27fe75,'status':_0x27804f,'amount':_0x578457,'currency':_0x4c7112,'dateTime':_0x312945});const _0x26b04a=await database_1[_0x85875a(0x153)][_0x85875a(0x1ae)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x27fe75},{'orderId':_0x27fe75},{'id':_0x27fe75},{'gatewayPaymentId':_0x27fe75}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x26b04a){console[_0x85875a(0x192)](_0x85875a(0x1a7)+_0x27fe75);throw new Error(_0x85875a(0xc0)+_0x27fe75);}console[_0x85875a(0x1c5)](_0x85875a(0x113)+_0x26b04a['id']+_0x85875a(0xed)),console[_0x85875a(0x1c5)](_0x85875a(0x119)+_0x26b04a[_0x85875a(0x181)]+_0x85875a(0xbd)+_0x27804f);let _0x607d2a=_0x27804f?.[_0x85875a(0x1be)]();_0x27804f==='FAILED'||_0x27804f===_0x85875a(0x1bc)?(_0x607d2a='FAILED',console[_0x85875a(0x1c5)](_0x85875a(0x13f)+_0x27804f+_0x85875a(0x143)),await this[_0x85875a(0xcd)](_0x26b04a['id'],_0x607d2a),console[_0x85875a(0x1c5)](_0x85875a(0x131)+_0x26b04a['id']+'\x20status\x20updated\x20to\x20FAILED')):console[_0x85875a(0x1c5)](_0x85875a(0x19f)+_0x27804f+_0x85875a(0xad)),await database_1[_0x85875a(0x153)][_0x85875a(0x12b)][_0x85875a(0x15a)]({'data':{'paymentId':_0x26b04a['id'],'shopId':_0x26b04a['shopId'],'event':'myxspend_'+(_0x27804f?.[_0x85875a(0x1a3)]()||'unknown'),'statusCode':0xc8,'responseBody':JSON['stringify']({'queryParams':_0x18b2ea,'bodyData':_0x4099b8})}}),loggerService_1['loggerService']['logWebhookProcessed'](_0x85875a(0x19e),_0x26b04a['id'],_0x26b04a['status'],_0x607d2a||_0x27804f,{'queryParams':_0x18b2ea,'bodyData':_0x4099b8});}catch(_0x93deb5){console[_0x85875a(0x192)](_0x85875a(0xf9),_0x93deb5),loggerService_1[_0x85875a(0x132)][_0x85875a(0x1c9)](_0x85875a(0x19e),_0x93deb5,{'queryParams':_0x18b2ea,'bodyData':_0x4099b8});throw _0x93deb5;}}}exports['WebhookService']=WebhookService;