'use strict';const a58_0x12608d=a58_0x4aa7;function a58_0x2e62(){const _0x47b29d=['Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','paid','findFirst','paidAt','NodaService',',\x20using\x20default\x20commission\x2010%','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','\x20->\x20','\x22,\x20orderId=\x22','Payment\x20','status','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','toUpperCase','\x22,\x20newStatus=\x22','15sSbagP','\x20balance\x20updated:\x20','getGatewayCommission','./gateways/nodaService','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','__importDefault','❌\x20Payment\x20link\x20','./loggerService','434385OaZSti','\x20and\x20-','💸\x20Additional\x20chargeback\x20penalty:\x20-','no\x20balance\x20change','📈\x20Payment\x20details:\x20oldStatus=\x22','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','orderId','💰\x20Removing\x20from\x20balance:\x20','💰\x20Adding\x20to\x20balance:\x20','%\x20gateway\x20commission)','💰\x20Amount\x20after\x20gateway\x20commission:\x20','📊\x20Rapyd\x20webhook:\x20Payment\x20','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','\x20-\x20','entries','\x20+\x20','shopId','processRapydWebhook','logWebhookProcessed','payment_method','application/json','amountAfterGatewayCommissionUSDT','coinToPay2Service','\x20USDT\x20(chargeback\x20penalty)','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','RapydService','txUrls','💰\x20Final\x20balance\x20after\x20chargeback:\x20','📊\x20Plisio\x20webhook:\x20Payment\x20','cardLast4',',\x20status=','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','masterCardService','📤\x20Shop\x20webhook\x20sent\x20to\x20','default','247844nEzXyD','cointopay','../config/database','❌\x20Available\x20webhook\x20fields:','\x22,\x20paymentLinkId=\x22','\x20current\x20balance:\x20','✅\x20Shop\x20','Found\x20payment\x20','✅\x20Found\x20payment\x20','failed','webhookLog','additionalInfo','🔄\x20Processing\x20CoinToPay\x20webhook:','commission','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','chargebackAmount','📊\x20CoinToPay\x20webhook:\x20Payment\x20','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','findUnique','telegramBotService','./gateways/klymeService','webhook_status_change_','failureMessage','Gateway\x20','No\x20payment\x20ID\x20in\x20Plisio\x20webhook',',\x20using\x20default\x2010%','logWebhookError','gatewaySettings','processPlisioWebhook','defineProperty','🔄\x20Additional\x20data:','\x20with\x20status\x20','gatewayOrderId','\x20USDT','✅\x20Payment\x20link\x20','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','nodaService','EXPIRED','\x20not\x20found','Failed\x20to\x20send\x20shop\x20webhook:','amountUSDT','createdAt','2934880VrqWQA','REFUND','\x20=\x20','rapyd','Webhook\x20event\x20','username','processPlisioGatewayWebhook','updatedAt','payment.failed','\x20commission:\x20','loggerService','parse','noda','📈\x20Payment\x20','Error\x20processing\x20CoinToPay2\x20webhook:','WebhookService','processNodaWebhook','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','💰\x20Gateway\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','findMany','🔄\x20Processing\x20CoinToPay2\x20webhook:','ms)','Error\x20processing\x20Rapyd\x20webhook:','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','stringify',':\x20type=','now','created','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','remitterName','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','gateway','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','48dSdvBS','remitterIban','payment.success','cointopay2','webhookEvents','📊\x20KLYME\x20webhook:\x20Payment\x20','SINGLE','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','./gateways/coinToPayService','plisioService','customerName','paymentLink','text','webhookUrl','CHARGEBACK',',\x20currentPayments=','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','🏪\x20Shop\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','🔄\x20Processing\x20KLYME\x20webhook:','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','log','customerEmail','payment.pending','PlisioService','Success','isArray','518826phrBeR','📝\x20Reason:\x20','logShopWebhookSent','toFixed','amount','expired','PAID','\x20not\x20enabled\x20for\x20shop\x20','update','keys','./telegramBotService','processWebhook','./gateways/mastercardService','💰\x20Converting\x20','system','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','FAILED','💰\x20Payment\x20','currentPayments','\x20updated:\x20currentPayments=','\x20to\x20','163954vsqHkD','./gateways/rapydService','paymentLinkId','🔄\x20Processing\x20Rapyd\x20webhook:','plisio','shop','TesSoft\x20Payment\x20System/1.0','rapydService','sendPaymentStatusNotification','237186HYPVwa','balance','error','📈\x20Found\x20payment\x20link\x20','klymeService','logShopWebhookError','POST','📊\x20MasterCard\x20webhook\x20result:','currency','18sZKuyh','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','Error\x20processing\x20Plisio\x20webhook:','settings','create','sendShopWebhook','./currencyService','CoinToPay2Service','refund','bankId','type','CoinToPayService',',\x20newStatus=','58420vSImyk','🔄\x20Processing\x20MasterCard\x20webhook:','paymentId','\x20status\x20','plisio_gateway','coinToPayService','$transaction','./gateways/plisioService','paymentMethod','toISOString','Error\x20parsing\x20webhook\x20events:','payment','toLowerCase','processCoinToPayWebhook','mastercard','processing','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','updatePaymentStatus'];a58_0x2e62=function(){return _0x47b29d;};return a58_0x2e62();}(function(_0x28e351,_0x19ae6b){const _0x59966a=a58_0x4aa7,_0x547c20=_0x28e351();while(!![]){try{const _0x22448c=-parseInt(_0x59966a(0x116))/0x1+parseInt(_0x59966a(0x135))/0x2+-parseInt(_0x59966a(0x101))/0x3+-parseInt(_0x59966a(0x181))/0x4*(-parseInt(_0x59966a(0x156))/0x5)+-parseInt(_0x59966a(0x128))/0x6*(parseInt(_0x59966a(0x15e))/0x7)+-parseInt(_0x59966a(0xe6))/0x8*(-parseInt(_0x59966a(0x11f))/0x9)+parseInt(_0x59966a(0x1ab))/0xa;if(_0x22448c===_0x19ae6b)break;else _0x547c20['push'](_0x547c20['shift']());}catch(_0x366f80){_0x547c20['push'](_0x547c20['shift']());}}}(a58_0x2e62,0x2311c));var __importDefault=this&&this[a58_0x12608d(0x15b)]||function(_0x4ee410){return _0x4ee410&&_0x4ee410['__esModule']?_0x4ee410:{'default':_0x4ee410};};Object[a58_0x12608d(0x19e)](exports,'__esModule',{'value':!![]}),exports[a58_0x12608d(0x1ba)]=void 0x0;const database_1=__importDefault(require(a58_0x12608d(0x183))),plisioService_1=require(a58_0x12608d(0x13c)),rapydService_1=require(a58_0x12608d(0x117)),nodaService_1=require(a58_0x12608d(0x159)),coinToPayService_1=require(a58_0x12608d(0xee)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require(a58_0x12608d(0x195)),mastercardService_1=require(a58_0x12608d(0x10d)),telegramBotService_1=require(a58_0x12608d(0x10b)),currencyService_1=require(a58_0x12608d(0x12e)),loggerService_1=require(a58_0x12608d(0x15d));class WebhookService{constructor(){const _0x22dbb9=a58_0x12608d;this[_0x22dbb9(0xef)]=new plisioService_1[(_0x22dbb9(0xfe))](),this[_0x22dbb9(0x11d)]=new rapydService_1[(_0x22dbb9(0x177))](),this[_0x22dbb9(0x1a5)]=new nodaService_1[(_0x22dbb9(0x14b))](),this[_0x22dbb9(0x13a)]=new coinToPayService_1[(_0x22dbb9(0x133))](),this[_0x22dbb9(0x174)]=new coinToPay2Service_1[(_0x22dbb9(0x12f))](),this[_0x22dbb9(0x123)]=new klymeService_1['KlymeService'](),this['masterCardService']=new mastercardService_1['MasterCardService']();}async[a58_0x12608d(0x146)](_0x582390,_0x3fae31,_0x32be46){const _0x5dfce4=a58_0x12608d;console[_0x5dfce4(0xfb)](_0x5dfce4(0xf6)+_0x582390+_0x5dfce4(0x134)+_0x3fae31),console[_0x5dfce4(0xfb)](_0x5dfce4(0x19f),_0x32be46),await database_1[_0x5dfce4(0x180)][_0x5dfce4(0x13b)](async _0x3527d3=>{const _0x3f6b1d=_0x5dfce4,_0x2efa31=await _0x3527d3[_0x3f6b1d(0x140)]['findUnique']({'where':{'id':_0x582390},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2efa31)throw new Error(_0x3f6b1d(0x151)+_0x582390+_0x3f6b1d(0x1a7));const _0x1d58e8=_0x2efa31[_0x3f6b1d(0x152)],_0xc1aa6a=_0x2efa31[_0x3f6b1d(0x11b)];console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x112)+_0x582390+':\x20'+_0x1d58e8+_0x3f6b1d(0x14f)+_0x3fae31),console[_0x3f6b1d(0xfb)](_0x3f6b1d(0xf7)+_0xc1aa6a[_0x3f6b1d(0x1b0)]+_0x3f6b1d(0x186)+_0xc1aa6a[_0x3f6b1d(0x120)]+_0x3f6b1d(0x1a2));const _0x110ccb={'status':_0x3fae31['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x3f6b1d(0x10f),'statusChangedAt':new Date()};_0x32be46?.[_0x3f6b1d(0x197)]&&(_0x110ccb[_0x3f6b1d(0x197)]=_0x32be46['failureMessage']);_0x32be46?.[_0x3f6b1d(0x178)]&&(_0x110ccb[_0x3f6b1d(0x178)]=JSON[_0x3f6b1d(0xdd)](_0x32be46[_0x3f6b1d(0x178)]));_0x32be46?.['cardLast4']&&(_0x110ccb[_0x3f6b1d(0x17b)]=_0x32be46[_0x3f6b1d(0x17b)]);_0x32be46?.[_0x3f6b1d(0x13d)]&&(_0x110ccb['paymentMethod']=_0x32be46[_0x3f6b1d(0x13d)]);_0x32be46?.['bankId']&&(_0x110ccb[_0x3f6b1d(0x131)]=_0x32be46[_0x3f6b1d(0x131)]);_0x32be46?.['remitterIban']&&(_0x110ccb[_0x3f6b1d(0xe7)]=_0x32be46[_0x3f6b1d(0xe7)]);_0x32be46?.['remitterName']&&(_0x110ccb[_0x3f6b1d(0xe2)]=_0x32be46[_0x3f6b1d(0xe2)]);let _0x45dad0=_0xc1aa6a['balance'],_0x27bd25='';if(_0x3fae31[_0x3f6b1d(0x154)]()===_0x3f6b1d(0x107)&&_0x1d58e8!=='PAID'){const _0x4421cc=await currencyService_1['currencyService']['convertToUSDT'](_0x2efa31[_0x3f6b1d(0x105)],_0x2efa31[_0x3f6b1d(0x127)]),_0x420c13=await this[_0x3f6b1d(0x158)](_0xc1aa6a['id'],_0x2efa31[_0x3f6b1d(0xe4)]),_0x22557=_0x4421cc*(0x1-_0x420c13/0x64);_0x45dad0+=_0x22557,_0x27bd25='+'+_0x22557[_0x3f6b1d(0x104)](0x6)+_0x3f6b1d(0x145)+_0x420c13+_0x3f6b1d(0x167),_0x110ccb[_0x3f6b1d(0x1a9)]=_0x4421cc,_0x110ccb[_0x3f6b1d(0x173)]=_0x22557,_0x110ccb[_0x3f6b1d(0x14a)]=new Date(),console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x10e)+_0x2efa31[_0x3f6b1d(0x105)]+'\x20'+_0x2efa31[_0x3f6b1d(0x127)]+_0x3f6b1d(0x14f)+_0x4421cc[_0x3f6b1d(0x104)](0x6)+_0x3f6b1d(0x1a2)),console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x1bd)+_0x2efa31[_0x3f6b1d(0xe4)]+_0x3f6b1d(0x1b4)+_0x420c13+'%'),console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x168)+_0x22557['toFixed'](0x6)+_0x3f6b1d(0x1a2)),console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x166)+_0xc1aa6a['balance']+_0x3f6b1d(0x16d)+_0x22557['toFixed'](0x6)+_0x3f6b1d(0x1ad)+_0x45dad0[_0x3f6b1d(0x104)](0x6)+'\x20USDT');}else{if(_0x1d58e8===_0x3f6b1d(0x107)&&_0x3fae31['toUpperCase']()!==_0x3f6b1d(0x107)){let _0x13af42;if(_0x2efa31['amountAfterGatewayCommissionUSDT'])_0x13af42=_0x2efa31['amountAfterGatewayCommissionUSDT'];else{if(_0x2efa31[_0x3f6b1d(0x1a9)]){const _0x419589=await this[_0x3f6b1d(0x158)](_0xc1aa6a['id'],_0x2efa31['gateway']);_0x13af42=_0x2efa31[_0x3f6b1d(0x1a9)]*(0x1-_0x419589/0x64);}else console['log'](_0x3f6b1d(0xe5)),_0x13af42=0x0;}_0x13af42>0x0&&(_0x45dad0-=_0x13af42,_0x27bd25='-'+_0x13af42[_0x3f6b1d(0x104)](0x6)+_0x3f6b1d(0xe1),_0x110ccb['amountUSDT']=null,_0x110ccb[_0x3f6b1d(0x173)]=null,_0x110ccb[_0x3f6b1d(0x14a)]=null,console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x165)+_0xc1aa6a[_0x3f6b1d(0x120)]+_0x3f6b1d(0x16b)+_0x13af42[_0x3f6b1d(0x104)](0x6)+_0x3f6b1d(0x1ad)+_0x45dad0['toFixed'](0x6)+_0x3f6b1d(0x1a2)));}}if(_0x3fae31[_0x3f6b1d(0x154)]()===_0x3f6b1d(0xf4)){const _0x19a3e5=_0x32be46?.[_0x3f6b1d(0x190)]||0x0;_0x19a3e5>0x0&&(_0x45dad0-=_0x19a3e5,_0x27bd25+=_0x3f6b1d(0x15f)+_0x19a3e5[_0x3f6b1d(0x104)](0x6)+_0x3f6b1d(0x175),_0x110ccb[_0x3f6b1d(0x190)]=_0x19a3e5,console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x160)+_0x19a3e5[_0x3f6b1d(0x104)](0x6)+'\x20USDT'),console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x179)+_0x45dad0['toFixed'](0x6)+'\x20USDT'));}const _0x18fc71=await _0x3527d3[_0x3f6b1d(0x140)][_0x3f6b1d(0x109)]({'where':{'id':_0x582390},'data':_0x110ccb});_0x45dad0!==_0xc1aa6a[_0x3f6b1d(0x120)]&&(await _0x3527d3[_0x3f6b1d(0x11b)][_0x3f6b1d(0x109)]({'where':{'id':_0xc1aa6a['id']},'data':{'balance':_0x45dad0}}),console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x187)+_0xc1aa6a[_0x3f6b1d(0x1b0)]+_0x3f6b1d(0x157)+_0xc1aa6a['balance'][_0x3f6b1d(0x104)](0x6)+'\x20->\x20'+_0x45dad0[_0x3f6b1d(0x104)](0x6)+_0x3f6b1d(0x1a2)),console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x102)+_0x27bd25));await _0x3527d3[_0x3f6b1d(0x18b)][_0x3f6b1d(0x12c)]({'data':{'paymentId':_0x582390,'shopId':_0xc1aa6a['id'],'event':_0x3f6b1d(0x196)+_0x3fae31['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x3f6b1d(0xdd)]({'oldStatus':_0x1d58e8,'newStatus':_0x3fae31[_0x3f6b1d(0x154)](),'balanceChange':_0x27bd25||_0x3f6b1d(0x161),'oldBalance':_0xc1aa6a[_0x3f6b1d(0x120)],'newBalance':_0x45dad0,'amountUSDT':_0x110ccb[_0x3f6b1d(0x1a9)],'additionalData':_0x32be46,'timestamp':new Date()[_0x3f6b1d(0x13e)]()})}}),await this[_0x3f6b1d(0x12d)]({..._0x2efa31,..._0x18fc71,'shop':_0xc1aa6a},_0x3fae31[_0x3f6b1d(0x154)]()),await this[_0x3f6b1d(0x11e)]({..._0x2efa31,..._0x18fc71},_0x3fae31[_0x3f6b1d(0x154)]());if(_0x1d58e8!==_0x3f6b1d(0x107)&&_0x3fae31[_0x3f6b1d(0x154)]()===_0x3f6b1d(0x107)){console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x1b8)+_0x582390+_0x3f6b1d(0x129)),console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x162)+_0x1d58e8+_0x3f6b1d(0x155)+_0x3fae31[_0x3f6b1d(0x154)]()+_0x3f6b1d(0x185)+_0x2efa31[_0x3f6b1d(0x118)]+'\x22');if(_0x2efa31[_0x3f6b1d(0x118)])try{const _0x9e4b24=await _0x3527d3[_0x3f6b1d(0xf1)]['findUnique']({'where':{'id':_0x2efa31[_0x3f6b1d(0x118)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x9e4b24){console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x122)+_0x9e4b24['id']+_0x3f6b1d(0xde)+_0x9e4b24['type']+_0x3f6b1d(0xf5)+_0x9e4b24[_0x3f6b1d(0x113)]+_0x3f6b1d(0x17c)+_0x9e4b24['status']);const _0x3925c6=_0x9e4b24['currentPayments']+0x1,_0x4f122c=_0x9e4b24[_0x3f6b1d(0x132)]===_0x3f6b1d(0xec)?'COMPLETED':_0x9e4b24[_0x3f6b1d(0x152)];await _0x3527d3[_0x3f6b1d(0xf1)][_0x3f6b1d(0x109)]({'where':{'id':_0x2efa31[_0x3f6b1d(0x118)]},'data':{'currentPayments':_0x3925c6,'status':_0x4f122c,'updatedAt':new Date()}}),console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x1a3)+_0x9e4b24['id']+_0x3f6b1d(0x114)+_0x9e4b24['currentPayments']+_0x3f6b1d(0x14f)+_0x3925c6+_0x3f6b1d(0x17c)+_0x9e4b24['status']+_0x3f6b1d(0x14f)+_0x4f122c);}else console['log'](_0x3f6b1d(0x15c)+_0x2efa31[_0x3f6b1d(0x118)]+'\x20not\x20found');}catch(_0x4f76f3){console['error']('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x4f76f3);}else console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x1b8)+_0x582390+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0x3f6b1d(0xfb)](_0x3f6b1d(0x1b8)+_0x582390+'\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20'+_0x1d58e8+_0x3f6b1d(0x14f)+_0x3fae31['toUpperCase']());});}async[a58_0x12608d(0x19d)](_0x499f62){const _0x5ab958=a58_0x12608d;console[_0x5ab958(0xfb)]('🔄\x20Processing\x20Plisio\x20webhook:',_0x499f62);try{const _0x4b7773=await this['plisioService'][_0x5ab958(0x10c)](_0x499f62);if(!_0x4b7773['paymentId'])throw new Error(_0x5ab958(0x199));const _0x27f799=await database_1[_0x5ab958(0x180)][_0x5ab958(0x140)][_0x5ab958(0x149)]({'where':{'gatewayOrderId':_0x4b7773[_0x5ab958(0x137)]}});if(!_0x27f799){console[_0x5ab958(0x121)]('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x4b7773['paymentId']);return;}console[_0x5ab958(0xfb)](_0x5ab958(0x17a)+_0x27f799['id']+_0x5ab958(0x138)+_0x4b7773[_0x5ab958(0x152)]),await this[_0x5ab958(0x146)](_0x27f799['id'],_0x4b7773['status'],{'txUrls':_0x4b7773[_0x5ab958(0x178)]}),loggerService_1[_0x5ab958(0x1b5)]['logWebhookProcessed'](_0x5ab958(0x11a),_0x27f799['id'],_0x27f799['status'],_0x4b7773[_0x5ab958(0x152)],_0x499f62);}catch(_0x47fa19){console[_0x5ab958(0x121)](_0x5ab958(0x12a),_0x47fa19),loggerService_1[_0x5ab958(0x1b5)][_0x5ab958(0x19b)]('plisio',_0x47fa19,_0x499f62);throw _0x47fa19;}}async[a58_0x12608d(0x1b1)](_0x1a7a2f){const _0x3b62e9=a58_0x12608d;console['log'](_0x3b62e9(0x110),_0x1a7a2f);try{const _0x78fa19=await this[_0x3b62e9(0xef)]['processWebhook'](_0x1a7a2f);if(!_0x78fa19['paymentId'])throw new Error(_0x3b62e9(0x18f));const _0x553103=await database_1[_0x3b62e9(0x180)][_0x3b62e9(0x140)][_0x3b62e9(0x149)]({'where':{'gatewayOrderId':_0x78fa19[_0x3b62e9(0x137)]}});if(!_0x553103){console[_0x3b62e9(0x121)](_0x3b62e9(0xed)+_0x78fa19['paymentId']);return;}console[_0x3b62e9(0xfb)]('📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20'+_0x553103['id']+_0x3b62e9(0x138)+_0x78fa19[_0x3b62e9(0x152)]),await this[_0x3b62e9(0x146)](_0x553103['id'],_0x78fa19[_0x3b62e9(0x152)],{'txUrls':_0x78fa19[_0x3b62e9(0x178)]}),loggerService_1[_0x3b62e9(0x1b5)][_0x3b62e9(0x170)](_0x3b62e9(0x139),_0x553103['id'],_0x553103[_0x3b62e9(0x152)],_0x78fa19[_0x3b62e9(0x152)],_0x1a7a2f);}catch(_0x212051){console[_0x3b62e9(0x121)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x212051),loggerService_1['loggerService']['logWebhookError'](_0x3b62e9(0x139),_0x212051,_0x1a7a2f);throw _0x212051;}}async[a58_0x12608d(0x16f)](_0x47ce02){const _0x49f513=a58_0x12608d;console[_0x49f513(0xfb)](_0x49f513(0x119),_0x47ce02);try{const _0x58923b=await this[_0x49f513(0x11d)][_0x49f513(0x10c)](_0x47ce02);if(!_0x58923b[_0x49f513(0x137)])throw new Error(_0x49f513(0x176));const _0x37f116=await database_1[_0x49f513(0x180)][_0x49f513(0x140)]['findFirst']({'where':{'gatewayOrderId':_0x58923b[_0x49f513(0x137)]}});if(!_0x37f116){console[_0x49f513(0x121)](_0x49f513(0x163)+_0x58923b[_0x49f513(0x137)]);return;}console[_0x49f513(0xfb)](_0x49f513(0x169)+_0x37f116['id']+'\x20status\x20'+_0x58923b[_0x49f513(0x152)]),await this['updatePaymentStatus'](_0x37f116['id'],_0x58923b[_0x49f513(0x152)],{'failureMessage':_0x58923b[_0x49f513(0x197)],'cardLast4':_0x58923b['additionalInfo']?.[_0x49f513(0x17b)],'paymentMethod':_0x58923b[_0x49f513(0x18c)]?.[_0x49f513(0x13d)]}),loggerService_1['loggerService']['logWebhookProcessed'](_0x49f513(0x1ae),_0x37f116['id'],_0x37f116[_0x49f513(0x152)],_0x58923b[_0x49f513(0x152)],_0x47ce02);}catch(_0x8adee1){console[_0x49f513(0x121)](_0x49f513(0xdb),_0x8adee1),loggerService_1[_0x49f513(0x1b5)][_0x49f513(0x19b)](_0x49f513(0x1ae),_0x8adee1,_0x47ce02);throw _0x8adee1;}}async[a58_0x12608d(0x1bb)](_0x5570bb){const _0x548b52=a58_0x12608d;console['log']('🔄\x20Processing\x20Noda\x20webhook:',_0x5570bb);try{const _0x52e211=await this['nodaService'][_0x548b52(0x10c)](_0x5570bb);if(!_0x52e211['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Noda\x20webhook');const _0x439764=await database_1[_0x548b52(0x180)][_0x548b52(0x140)]['findFirst']({'where':{'gatewayOrderId':_0x52e211[_0x548b52(0x137)]}});if(!_0x439764){console['error'](_0x548b52(0x16a)+_0x52e211[_0x548b52(0x137)]);return;}console[_0x548b52(0xfb)]('📊\x20Noda\x20webhook:\x20Payment\x20'+_0x439764['id']+_0x548b52(0x138)+_0x52e211['status']),await this[_0x548b52(0x146)](_0x439764['id'],_0x52e211[_0x548b52(0x152)],{'bankId':_0x52e211[_0x548b52(0x18c)]?.['bankId'],'remitterIban':_0x52e211[_0x548b52(0x18c)]?.[_0x548b52(0xe7)],'remitterName':_0x52e211[_0x548b52(0x18c)]?.[_0x548b52(0xe2)]}),loggerService_1[_0x548b52(0x1b5)][_0x548b52(0x170)](_0x548b52(0x1b7),_0x439764['id'],_0x439764[_0x548b52(0x152)],_0x52e211[_0x548b52(0x152)],_0x5570bb);}catch(_0x5b3579){console[_0x548b52(0x121)]('Error\x20processing\x20Noda\x20webhook:',_0x5b3579),loggerService_1[_0x548b52(0x1b5)][_0x548b52(0x19b)](_0x548b52(0x1b7),_0x5b3579,_0x5570bb);throw _0x5b3579;}}async[a58_0x12608d(0x142)](_0x38fe6d){const _0x51f674=a58_0x12608d;console[_0x51f674(0xfb)](_0x51f674(0x18d),_0x38fe6d);try{const _0x3c0a1d=await this[_0x51f674(0x13a)][_0x51f674(0x10c)](_0x38fe6d);if(!_0x3c0a1d['paymentId'])throw new Error(_0x51f674(0xdc));const _0x217818=await database_1[_0x51f674(0x180)][_0x51f674(0x140)]['findFirst']({'where':{'gatewayOrderId':_0x3c0a1d['paymentId']}});if(!_0x217818){console['error'](_0x51f674(0x14e)+_0x3c0a1d[_0x51f674(0x137)]);return;}console[_0x51f674(0xfb)](_0x51f674(0x191)+_0x217818['id']+_0x51f674(0x138)+_0x3c0a1d[_0x51f674(0x152)]),await this[_0x51f674(0x146)](_0x217818['id'],_0x3c0a1d[_0x51f674(0x152)]),loggerService_1['loggerService'][_0x51f674(0x170)](_0x51f674(0x182),_0x217818['id'],_0x217818['status'],_0x3c0a1d[_0x51f674(0x152)],_0x38fe6d);}catch(_0x2fe591){console['error']('Error\x20processing\x20CoinToPay\x20webhook:',_0x2fe591),loggerService_1['loggerService']['logWebhookError'](_0x51f674(0x182),_0x2fe591,_0x38fe6d);throw _0x2fe591;}}async['processCoinToPay2Webhook'](_0x3cc455){const _0x1a696a=a58_0x12608d;console['log'](_0x1a696a(0x1c0),_0x3cc455);try{const _0x2af5ea=await this[_0x1a696a(0x174)][_0x1a696a(0x10c)](_0x3cc455);if(!_0x2af5ea[_0x1a696a(0x137)])throw new Error(_0x1a696a(0xf8));const _0x496f15=await database_1['default'][_0x1a696a(0x140)]['findFirst']({'where':{'gatewayOrderId':_0x2af5ea[_0x1a696a(0x137)]}});if(!_0x496f15){console['error'](_0x1a696a(0x1a4)+_0x2af5ea['paymentId']);return;}console[_0x1a696a(0xfb)](_0x1a696a(0xe3)+_0x496f15['id']+_0x1a696a(0x138)+_0x2af5ea[_0x1a696a(0x152)]),await this['updatePaymentStatus'](_0x496f15['id'],_0x2af5ea[_0x1a696a(0x152)]),loggerService_1[_0x1a696a(0x1b5)][_0x1a696a(0x170)](_0x1a696a(0xe9),_0x496f15['id'],_0x496f15[_0x1a696a(0x152)],_0x2af5ea[_0x1a696a(0x152)],_0x3cc455);}catch(_0x745be4){console[_0x1a696a(0x121)](_0x1a696a(0x1b9),_0x745be4),loggerService_1[_0x1a696a(0x1b5)]['logWebhookError'](_0x1a696a(0xe9),_0x745be4,_0x3cc455);throw _0x745be4;}}async['processKlymeWebhook'](_0x56a706){const _0x4c220d=a58_0x12608d;console[_0x4c220d(0xfb)](_0x4c220d(0xf9),_0x56a706);try{const _0x24d2ec=await this['klymeService'][_0x4c220d(0x10c)](_0x56a706);if(!_0x24d2ec[_0x4c220d(0x137)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x5b0056=await database_1[_0x4c220d(0x180)]['payment'][_0x4c220d(0x149)]({'where':{'gatewayOrderId':_0x24d2ec[_0x4c220d(0x137)]}});if(!_0x5b0056){console[_0x4c220d(0x121)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x24d2ec[_0x4c220d(0x137)]);return;}console[_0x4c220d(0xfb)](_0x4c220d(0xeb)+_0x5b0056['id']+_0x4c220d(0x138)+_0x24d2ec[_0x4c220d(0x152)]),await this[_0x4c220d(0x146)](_0x5b0056['id'],_0x24d2ec[_0x4c220d(0x152)],{'paymentMethod':_0x24d2ec[_0x4c220d(0x18c)]?.[_0x4c220d(0x171)]}),loggerService_1[_0x4c220d(0x1b5)][_0x4c220d(0x170)]('klyme',_0x5b0056['id'],_0x5b0056[_0x4c220d(0x152)],_0x24d2ec['status'],_0x56a706);}catch(_0x2ff1b9){console[_0x4c220d(0x121)]('Error\x20processing\x20KLYME\x20webhook:',_0x2ff1b9),loggerService_1[_0x4c220d(0x1b5)][_0x4c220d(0x19b)]('klyme',_0x2ff1b9,_0x56a706);throw _0x2ff1b9;}}async['processMasterCardWebhook'](_0x281a5d){const _0x201bd5=a58_0x12608d;console['log'](_0x201bd5(0x136),JSON[_0x201bd5(0xdd)](_0x281a5d,null,0x2));try{const _0x5b45eb=await this[_0x201bd5(0x17e)][_0x201bd5(0x10c)](_0x281a5d);console['log'](_0x201bd5(0x126),_0x5b45eb);if(!_0x5b45eb[_0x201bd5(0x137)]){console['error']('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data'),console[_0x201bd5(0x121)](_0x201bd5(0x184),Object[_0x201bd5(0x10a)](_0x281a5d));throw new Error(_0x201bd5(0x1be));}let _0x2fb378=null;console[_0x201bd5(0xfb)](_0x201bd5(0x14d)+_0x5b45eb[_0x201bd5(0x137)]);_0x5b45eb[_0x201bd5(0x137)]&&(console['log'](_0x201bd5(0x15a)),_0x2fb378=await database_1[_0x201bd5(0x180)][_0x201bd5(0x140)][_0x201bd5(0x149)]({'where':{'AND':[{'gateway':_0x201bd5(0x143)},{'OR':[{'gatewayPaymentId':_0x5b45eb[_0x201bd5(0x137)]},{'gatewayOrderId':_0x5b45eb[_0x201bd5(0x137)]},{'id':_0x5b45eb[_0x201bd5(0x137)]},{'orderId':_0x5b45eb['paymentId']}]}]}}),console[_0x201bd5(0xfb)]('🔍\x20Search\x20result:\x20'+(_0x2fb378?_0x201bd5(0x188)+_0x2fb378['id']:'Payment\x20not\x20found')));if(!_0x2fb378){console[_0x201bd5(0x121)]('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x5b45eb[_0x201bd5(0x137)]),console[_0x201bd5(0x121)]('🔍\x20Searched\x20by:\x20gatewayOrderId=\x22'+_0x5b45eb[_0x201bd5(0x137)]+'\x22,\x20id=\x22'+_0x5b45eb[_0x201bd5(0x137)]+_0x201bd5(0x150)+_0x5b45eb[_0x201bd5(0x137)]+'\x22');const _0x3c5f22=await database_1[_0x201bd5(0x180)][_0x201bd5(0x140)][_0x201bd5(0x1bf)]({'where':{'gateway':_0x201bd5(0x143)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console['log'](_0x201bd5(0xfa),_0x3c5f22);return;}console[_0x201bd5(0xfb)](_0x201bd5(0x189)+_0x2fb378['id']+_0x201bd5(0x192)+_0x2fb378[_0x201bd5(0x152)]+_0x201bd5(0x115)+_0x5b45eb[_0x201bd5(0x152)]),await this['updatePaymentStatus'](_0x2fb378['id'],_0x5b45eb['status']),loggerService_1[_0x201bd5(0x1b5)]['logWebhookProcessed']('mastercard',_0x2fb378['id'],_0x2fb378[_0x201bd5(0x152)],_0x5b45eb[_0x201bd5(0x152)],_0x281a5d);}catch(_0x1db540){console[_0x201bd5(0x121)]('❌\x20Error\x20processing\x20MasterCard\x20webhook:',_0x1db540),loggerService_1[_0x201bd5(0x1b5)][_0x201bd5(0x19b)]('mastercard',_0x1db540,_0x281a5d);throw _0x1db540;}}async['sendShopWebhook'](_0x3a796b,_0x54f30e){const _0x36a8ee=a58_0x12608d,_0x3ef0b0=Date[_0x36a8ee(0xdf)]();try{const _0x293189=_0x3a796b[_0x36a8ee(0x11b)],_0x558c10=_0x293189[_0x36a8ee(0x12b)];if(!_0x558c10?.[_0x36a8ee(0xf3)]){console[_0x36a8ee(0xfb)](_0x36a8ee(0x1bc)+_0x293189['id']);return;}const _0x2218b8=_0x54f30e==='PAID'?_0x36a8ee(0xe8):_0x54f30e===_0x36a8ee(0x111)?_0x36a8ee(0x1b3):_0x54f30e===_0x36a8ee(0x1a6)?_0x36a8ee(0x1b3):_0x54f30e===_0x36a8ee(0xf4)?'payment.failed':_0x54f30e===_0x36a8ee(0x1ac)?_0x36a8ee(0x1b3):_0x36a8ee(0xfd);let _0x5a3d34=[];if(_0x558c10[_0x36a8ee(0xea)])try{_0x5a3d34=Array[_0x36a8ee(0x100)](_0x558c10['webhookEvents'])?_0x558c10[_0x36a8ee(0xea)]:JSON[_0x36a8ee(0x1b6)](_0x558c10[_0x36a8ee(0xea)]);}catch(_0x45e0e0){console[_0x36a8ee(0x121)](_0x36a8ee(0x13f),_0x45e0e0),_0x5a3d34=[];}if(!_0x5a3d34['includes'](_0x2218b8)){console[_0x36a8ee(0xfb)](_0x36a8ee(0x1af)+_0x2218b8+_0x36a8ee(0x108)+_0x293189['id']);return;}const _0x13eb50={'event':_0x2218b8,'payment':{'id':_0x3a796b['id'],'order_id':_0x3a796b[_0x36a8ee(0x164)],'gateway_order_id':_0x3a796b[_0x36a8ee(0x1a1)],'gateway':_0x3a796b[_0x36a8ee(0xe4)],'amount':_0x3a796b[_0x36a8ee(0x105)],'currency':_0x3a796b[_0x36a8ee(0x127)],'status':_0x54f30e[_0x36a8ee(0x141)](),'customer_email':_0x3a796b[_0x36a8ee(0xfc)],'customer_name':_0x3a796b[_0x36a8ee(0xf0)],'failure_message':_0x3a796b[_0x36a8ee(0x197)],'tx_urls':_0x3a796b[_0x36a8ee(0x178)]?JSON['parse'](_0x3a796b[_0x36a8ee(0x178)]):null,'created_at':_0x3a796b[_0x36a8ee(0x1aa)],'updated_at':_0x3a796b[_0x36a8ee(0x1b2)]}},_0xee73ce=await fetch(_0x558c10['webhookUrl'],{'method':_0x36a8ee(0x125),'headers':{'Content-Type':_0x36a8ee(0x172),'User-Agent':_0x36a8ee(0x11c)},'body':JSON[_0x36a8ee(0xdd)](_0x13eb50)}),_0x307391=Date[_0x36a8ee(0xdf)]()-_0x3ef0b0,_0x4ab683=_0xee73ce['ok']?_0x36a8ee(0xff):await _0xee73ce[_0x36a8ee(0xf2)]();loggerService_1[_0x36a8ee(0x1b5)][_0x36a8ee(0x103)](_0x3a796b['shopId'],_0x558c10[_0x36a8ee(0xf3)],_0x2218b8,_0xee73ce[_0x36a8ee(0x152)],_0x307391,_0x13eb50),console[_0x36a8ee(0xfb)](_0x36a8ee(0x17f)+_0x558c10[_0x36a8ee(0xf3)]+_0x36a8ee(0x1a0)+_0xee73ce[_0x36a8ee(0x152)]+'\x20('+_0x307391+_0x36a8ee(0x1c1));}catch(_0x2162a8){console['error'](_0x36a8ee(0x1a8),_0x2162a8),loggerService_1['loggerService'][_0x36a8ee(0x124)](_0x3a796b[_0x36a8ee(0x16e)],_0x3a796b['shop']?.['settings']?.[_0x36a8ee(0xf3)]||'unknown','webhook_send',_0x2162a8,{});}}async[a58_0x12608d(0x11e)](_0x267028,_0x23bfad){const _0x492f38=a58_0x12608d;try{const _0x2e461a={'PENDING':_0x492f38(0xe0),'PROCESSING':_0x492f38(0x144),'PAID':_0x492f38(0x148),'FAILED':_0x492f38(0x18a),'EXPIRED':_0x492f38(0x106),'REFUND':_0x492f38(0x130),'CHARGEBACK':'chargeback'},_0x3f6a08=_0x2e461a[_0x23bfad];if(!_0x3f6a08||_0x3f6a08===_0x492f38(0xe0))return;await telegramBotService_1[_0x492f38(0x194)]['sendPaymentNotification'](_0x267028[_0x492f38(0x16e)],_0x267028,_0x3f6a08);}catch(_0x660a7e){console[_0x492f38(0x121)](_0x492f38(0x153),_0x660a7e);}}async[a58_0x12608d(0x158)](_0x2fc6be,_0x30aa1e){const _0x41d300=a58_0x12608d;try{const _0x47dc76=await database_1[_0x41d300(0x180)][_0x41d300(0x11b)][_0x41d300(0x193)]({'where':{'id':_0x2fc6be},'select':{'gatewaySettings':!![]}});if(!_0x47dc76?.[_0x41d300(0x19c)])return console[_0x41d300(0xfb)](_0x41d300(0x17d)+_0x2fc6be+_0x41d300(0x14c)),0xa;const _0x47e6f5=JSON[_0x41d300(0x1b6)](_0x47dc76[_0x41d300(0x19c)]);for(const [_0x4e05af,_0xe16139]of Object[_0x41d300(0x16c)](_0x47e6f5)){if(_0x4e05af[_0x41d300(0x141)]()===_0x30aa1e[_0x41d300(0x141)]()){const _0x534b03=_0xe16139[_0x41d300(0x18e)]||0xa;return console[_0x41d300(0xfb)](_0x41d300(0x198)+_0x30aa1e+'\x20commission\x20for\x20shop\x20'+_0x2fc6be+':\x20'+_0x534b03+'%'),_0x534b03;}}return console[_0x41d300(0xfb)]('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0x30aa1e+'\x20in\x20shop\x20'+_0x2fc6be+_0x41d300(0x19a)),0xa;}catch(_0x3ae060){return console['error'](_0x41d300(0x147)+_0x2fc6be+',\x20gateway\x20'+_0x30aa1e+':',_0x3ae060),0xa;}}}function a58_0x4aa7(_0x315476,_0x40e08d){const _0x2e62b5=a58_0x2e62();return a58_0x4aa7=function(_0x4aa74e,_0x2a519c){_0x4aa74e=_0x4aa74e-0xdb;let _0x31d914=_0x2e62b5[_0x4aa74e];return _0x31d914;},a58_0x4aa7(_0x315476,_0x40e08d);}exports['WebhookService']=WebhookService;