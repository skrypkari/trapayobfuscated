'use strict';function a52_0x524c(){const _0x3393d6=['cointopay_error','success','plisio_gateway_','customerEmail','coinToPayService','üì±\x20No\x20shop\x20settings\x20found\x20for\x20shop\x20','\x20\x20\x20üìä\x20Status:\x20',',\x20name=','default',',\x20payment_method=','\x20(gateway:\x20','message','notificationPaymentSuccess','üì±\x20Processing\x20Telegram\x20notification\x20for\x20payment\x20','Failed\x20to\x20log\x20KLYME\x20webhook\x20error:','paid','Missing\x20required\x20webhook\x20data:\x20order_id\x20or\x20gateway_payment_id','logCoinToPayWebhookStatus','Payment\x20not\x20found\x20for\x20order_id:\x20','new',',\x20method=','expired','application/json','üîÑ\x20Noda\x20status\x20mapping:\x20\x22','üîÑ\x20CoinToPay\x20status\x20mapping:\x20\x22','shopSettings',',\x20Amount:\x20','Name','./gateways/plisioService','payment','plisio','\x20marked\x20as\x20paid\x20at:\x20','üí≥\x20Payment\x20method:\x20','./gateways/coinToPayService','rapyd','PaymentLinkService','pending\x20internal','klyme_','merchant_reference_id','error','create','Payment\x20not\x20found\x20for\x20gateway_id:\x20','‚úÖ\x20Telegram\x20notification\x20sent\x20successfully\x20for\x20payment\x20','payment.pending','Yes','getGatewayIdByName','\x20\x20\x20-\x20MerchantPaymentId:\x20','logWebhookError','amount','findUnique','findFirst','PAID','plisio_','logCoinToPayStatus','successful','\x20payment:','remitterName','webhookEvents','45738suRcyT','‚ùå\x20Payment\x20not\x20found\x20with\x20any\x20of\x20the\x20following\x20criteria:','\x20\x20\x20üìÖ\x20Time:\x20','order_id','üí∞\x20Payment\x20','refund','\x20status\x20updated\x20from\x20',',\x20Gateway:\x20','Status:\x20','Payment\x20','logShopWebhookSent','KLYME\x20','\x20details\x20updated:\x20payment_method=','paidAt','currency','gateway','1443eokhXT','ms)','gatewayOrderId','__importDefault','desc','\x20->\x20','Failed\x20to\x20log\x20webhook\x20error:','7235NWeMlt','processPlisioGatewayWebhook','EUR','in_progress','\x20\x20\x20-\x20gatewayPaymentId:\x20','Noda\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','Payment\x20not\x20found\x20for\x20order_number:\x20','notificationLogin','processing','Missing\x20required\x20webhook\x20data:\x20order_id\x20or\x20payment_id',',\x20Transaction\x20ID:\x20','../config/database','klyme','Iban','Failed\x20to\x20log\x20shop\x20webhook\x20error:','logShopWebhookError','plisio_gateway','\x20\x20\x20-\x20id:\x20','Remitter:\x20','KLYME\x20webhook\x20processing\x20error:',',\x20txn_id:\x20','processCoinToPayWebhook','chargeback','COINTOPAY_WEBHOOK_ERROR','üîÑ\x20Plisio\x20gateway\x20status\x20mapping:\x20\x22','shopId','webhook','PENDING','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','confirming','./telegramBotService','active','\x22\x20->\x20\x22','rejected','paymentMethod','Success','./gateways/rapydService','üîç\x20Last\x2010\x20payments\x20in\x20database\x20for\x20debugging:','gatewayPaymentId','COINTOPAY_WEBHOOK_STATUS_CHANGE','7DiFYKI','18296Phmevo','\x20details\x20updated:\x20iban=','Failed\x20to\x20send\x20shop\x20webhook:','ü™ô\x20CoinToPay\x20Webhook\x20Status\x20Change:\x20','loggerService','145837dwnyuM','shop','Payment\x20Method:\x20','created','CLO','confirmed','Payment\x20not\x20found\x20for\x20payment_id:\x20','Webhook\x20event\x20','processNodaWebhook','Processing\x20Plisio\x20gateway\x20webhook:','cointopay_','EXP','pending','üí≥\x20Extracted\x20card\x20last\x204\x20digits:\x20****','REFUND','toISOString','2584qNyIDM','PAYMENT_FAILED','üì±\x20Shop\x20notification\x20settings:','CHARGEBACK','\x20\x20\x20üìù\x20Webhook\x20Data:','remitterIban','createdAt','status','type','\x20(was:\x20','timestamp','unknown','sendPaymentNotification','\x20not\x20enabled\x20for\x20shop\x20','plisio_gateway_error','rapyd_','sendPaymentStatusNotification','defineProperty','sendShopWebhook','noda','ERR','shop_webhook_','üí≥\x20KLYME\x20payment\x20method:\x20','toUpperCase',',\x20OrderId:\x20','RapydService',',\x20GatewayPaymentId:\x20','10UpwFvO','\x20\x20\x20üìç\x20Source:\x20webhook','Rapyd\x20webhook\x20processing\x20error:','handleSuccessfulPayment','klyme_error','paymentLinkService','isArray',',\x20skipping\x20Telegram\x20notification','logWebhookProcessed','CoinToPayService','cancelled','mismatch','./paymentLinkService','üîó\x20Sending\x20webhook\x20to\x20shop\x20with\x20gateway\x20ID:\x20','2140ZZelVF','update','notificationPaymentFailed','WebhookService',',\x20order_id:\x20','webhookUrl','waiting','Failed\x20to\x20log\x20CoinToPay\x20webhook\x20error:','noda_','payment.success','\x20status\x20changed\x20to\x20','__esModule','cardLast4','text','done','\x20to\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Processing\x20KLYME\x20webhook:','orderId',',\x20Settled:\x20','nodaService','failed','toLowerCase','webhookLog','PlisioService','Missing\x20required\x20webhook\x20data:\x20txn_id\x20or\x20order_number','timeout','üîç\x20Searching\x20for\x20KLYME\x20','\x20\x20\x20-\x20gatewayOrderId:\x20','cointopay','CoinToPay\x20webhook\x20processing\x20error:','notificationRefund',',\x20GatewayOrderId:\x20','1335006eudJxk',',\x20MerchantPaymentId:\x20','POST','customerName','Webhook\x20received\x20but\x20status\x20unchanged','üîÑ\x20Plisio\x20status\x20mapping:\x20\x22','log','\x20\x20\x20-\x20orderId:\x20','üë§\x20Remitter\x20name:\x20','1452jhXnrq','158076GTQOTm','./gateways/nodaService','processKlymeWebhook','findMany','completed','includes','canceled','PAYMENT_CANCELED','rapyd_error','\x20\x20\x20-\x20PaymentId:\x20','FAILED','parseWebhookEvents','Noda\x20webhook\x20processing\x20error:','ACT','logWebhookReceived',',\x20Region:\x20','CoinToPay\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','payment_method_data','Unknown\x20error','../types/gateway','logCoinToPayError','shop_webhook_error','stringify','‚úÖ\x20Found\x20KLYME\x20payment:\x20','‚ùå\x20KLYME\x20payment\x20not\x20found\x20with\x20any\x20of\x20the\x20following\x20criteria:','\x20with\x20status\x20',',\x20bank=','bankId','Processing\x20Noda\x20webhook:','Notification:\x20Payment\x20','PROCESSING','2169fsGWCy','last4','EXPIRED','PAYMENT_COMPLETED','updatedAt'];a52_0x524c=function(){return _0x3393d6;};return a52_0x524c();}const a52_0x2c6bc9=a52_0x3b40;function a52_0x3b40(_0x2800a0,_0x2aea5f){const _0x524c2c=a52_0x524c();return a52_0x3b40=function(_0x3b4082,_0x16f41b){_0x3b4082=_0x3b4082-0x1ef;let _0x453801=_0x524c2c[_0x3b4082];return _0x453801;},a52_0x3b40(_0x2800a0,_0x2aea5f);}(function(_0xbf9ed7,_0x1f4687){const _0x3c71b3=a52_0x3b40,_0x5f3d86=_0xbf9ed7();while(!![]){try{const _0x12779a=parseInt(_0x3c71b3(0x2a1))/0x1*(parseInt(_0x3c71b3(0x2cc))/0x2)+-parseInt(_0x3c71b3(0x25b))/0x3+-parseInt(_0x3c71b3(0x2b1))/0x4*(parseInt(_0x3c71b3(0x272))/0x5)+-parseInt(_0x3c71b3(0x1f3))/0x6*(parseInt(_0x3c71b3(0x29b))/0x7)+parseInt(_0x3c71b3(0x29c))/0x8*(-parseInt(_0x3c71b3(0x21c))/0x9)+parseInt(_0x3c71b3(0x2da))/0xa*(parseInt(_0x3c71b3(0x1fc))/0xb)+parseInt(_0x3c71b3(0x1fd))/0xc*(parseInt(_0x3c71b3(0x26b))/0xd);if(_0x12779a===_0x1f4687)break;else _0x5f3d86['push'](_0x5f3d86['shift']());}catch(_0x5730be){_0x5f3d86['push'](_0x5f3d86['shift']());}}}(a52_0x524c,0x79158));var __importDefault=this&&this[a52_0x2c6bc9(0x26e)]||function(_0x4aa400){const _0x35408d=a52_0x2c6bc9;return _0x4aa400&&_0x4aa400[_0x35408d(0x2e5)]?_0x4aa400:{'default':_0x4aa400};};Object[a52_0x2c6bc9(0x2c2)](exports,'__esModule',{'value':!![]}),exports[a52_0x2c6bc9(0x2dd)]=void 0x0;const database_1=__importDefault(require(a52_0x2c6bc9(0x27e))),plisioService_1=require(a52_0x2c6bc9(0x23d)),rapydService_1=require(a52_0x2c6bc9(0x297)),nodaService_1=require(a52_0x2c6bc9(0x1fe)),coinToPayService_1=require(a52_0x2c6bc9(0x242)),klymeService_1=require('./gateways/klymeService'),paymentLinkService_1=require(a52_0x2c6bc9(0x2d8)),telegramBotService_1=require(a52_0x2c6bc9(0x291)),loggerService_1=require('./loggerService'),gateway_1=require(a52_0x2c6bc9(0x210));class WebhookService{constructor(){const _0xca2ae2=a52_0x2c6bc9;this['plisioService']=new plisioService_1[(_0xca2ae2(0x2f2))](),this['rapydService']=new rapydService_1[(_0xca2ae2(0x2ca))](),this[_0xca2ae2(0x2ee)]=new nodaService_1['NodaService'](),this[_0xca2ae2(0x225)]=new coinToPayService_1[(_0xca2ae2(0x2d5))](),this['klymeService']=new klymeService_1['KlymeService'](),this[_0xca2ae2(0x2d1)]=new paymentLinkService_1[(_0xca2ae2(0x244))]();}[a52_0x2c6bc9(0x208)](_0xfb35ee){const _0xa83030=a52_0x2c6bc9;if(!_0xfb35ee)return[];if(Array['isArray'](_0xfb35ee))return _0xfb35ee;if(typeof _0xfb35ee==='string')try{const _0x4dca2a=JSON['parse'](_0xfb35ee);return Array[_0xa83030(0x2d2)](_0x4dca2a)?_0x4dca2a:[];}catch{return[];}return[];}[a52_0x2c6bc9(0x232)](_0x1f9fcb,_0x233216,_0x177824,_0x51363c,_0x3d9094){const _0x3d34a4=a52_0x2c6bc9,_0x2f21ca={'type':_0x3d34a4(0x29a),'paymentId':_0x1f9fcb,'gatewayPaymentId':_0x233216,'oldStatus':_0x177824,'newStatus':_0x51363c,'source':_0x3d34a4(0x28d),'timestamp':new Date()[_0x3d34a4(0x2b0)](),'webhookData':_0x3d9094};loggerService_1['loggerService'][_0x3d34a4(0x256)](_0x2f21ca),console[_0x3d34a4(0x1f9)](_0x3d34a4(0x29f)+_0x1f9fcb+'\x20('+_0x233216+')'),console[_0x3d34a4(0x1f9)](_0x3d34a4(0x227)+_0x177824+_0x3d34a4(0x270)+_0x51363c),console[_0x3d34a4(0x1f9)](_0x3d34a4(0x2cd)),console[_0x3d34a4(0x1f9)](_0x3d34a4(0x25d)+_0x2f21ca[_0x3d34a4(0x2bb)]),console['log'](_0x3d34a4(0x2b5),_0x3d9094);}async['processPlisioWebhook'](_0x116e5c){const _0x4e70f4=a52_0x2c6bc9;try{loggerService_1[_0x4e70f4(0x2a0)][_0x4e70f4(0x20b)](_0x4e70f4(0x23f),_0x116e5c),console[_0x4e70f4(0x1f9)]('Processing\x20Plisio\x20webhook:',_0x116e5c);const {txn_id:_0x51571f,order_number:_0x430c6c,status:_0x593d65,amount:_0x4f3ffb,currency:_0x37f163}=_0x116e5c;if(!_0x51571f||!_0x430c6c){const _0x2ce29d=new Error(_0x4e70f4(0x2f3));loggerService_1['loggerService'][_0x4e70f4(0x250)]('plisio',_0x2ce29d,_0x116e5c);throw _0x2ce29d;}const _0x49d025=await database_1[_0x4e70f4(0x229)]['payment'][_0x4e70f4(0x253)]({'where':{'OR':[{'gatewayPaymentId':_0x51571f},{'orderId':_0x430c6c}]},'include':{'shop':{'select':{'id':!![],'name':!![]}}}});if(!_0x49d025){const _0x516abd=new Error('Payment\x20not\x20found\x20for\x20gateway_id:\x20'+_0x51571f+_0x4e70f4(0x2de)+_0x430c6c);loggerService_1[_0x4e70f4(0x2a0)][_0x4e70f4(0x250)]('plisio',_0x516abd,_0x116e5c);throw _0x516abd;}let _0x5c24db;switch(_0x593d65){case'completed':case'mismatch':_0x5c24db=_0x4e70f4(0x254);break;case _0x4e70f4(0x2ad):_0x5c24db=_0x4e70f4(0x21b);break;case'expired':_0x5c24db=_0x4e70f4(0x21e);break;case _0x4e70f4(0x248):case _0x4e70f4(0x2d6):_0x5c24db=_0x4e70f4(0x207);break;case'new':default:_0x5c24db=_0x4e70f4(0x28e);break;}console['log'](_0x4e70f4(0x1f8)+_0x593d65+_0x4e70f4(0x293)+_0x5c24db+'\x22');const _0x3af924={'status':_0x5c24db,'updatedAt':new Date()};_0x5c24db===_0x4e70f4(0x254)&&_0x49d025[_0x4e70f4(0x2b8)]!=='PAID'&&(_0x3af924['paidAt']=new Date(),console[_0x4e70f4(0x1f9)]('üí∞\x20Payment\x20'+_0x49d025['id']+_0x4e70f4(0x240)+_0x3af924['paidAt'][_0x4e70f4(0x2b0)]())),_0x49d025[_0x4e70f4(0x2b8)]!==_0x5c24db&&(await database_1[_0x4e70f4(0x229)][_0x4e70f4(0x23e)]['update']({'where':{'id':_0x49d025['id']},'data':_0x3af924}),console[_0x4e70f4(0x1f9)](_0x4e70f4(0x264)+_0x49d025['id']+_0x4e70f4(0x261)+_0x49d025[_0x4e70f4(0x2b8)]+_0x4e70f4(0x2e9)+_0x5c24db),loggerService_1[_0x4e70f4(0x2a0)][_0x4e70f4(0x2d4)](_0x4e70f4(0x23f),_0x49d025['id'],_0x49d025[_0x4e70f4(0x2b8)],_0x5c24db,_0x116e5c),_0x5c24db===_0x4e70f4(0x254)&&await this[_0x4e70f4(0x2d1)]['handleSuccessfulPayment'](_0x49d025['id']),await this['sendPaymentStatusNotification'](_0x49d025,_0x5c24db)),await database_1[_0x4e70f4(0x229)]['webhookLog'][_0x4e70f4(0x249)]({'data':{'paymentId':_0x49d025['id'],'shopId':_0x49d025[_0x4e70f4(0x28c)],'event':_0x4e70f4(0x255)+_0x593d65,'statusCode':0xc8,'responseBody':JSON[_0x4e70f4(0x213)](_0x116e5c)}});}catch(_0x4ee26f){console[_0x4e70f4(0x248)]('Webhook\x20processing\x20error:',_0x4ee26f),loggerService_1['loggerService'][_0x4e70f4(0x250)](_0x4e70f4(0x23f),_0x4ee26f,_0x116e5c);try{await database_1[_0x4e70f4(0x229)]['webhookLog'][_0x4e70f4(0x249)]({'data':{'paymentId':_0x4e70f4(0x2bc),'shopId':_0x4e70f4(0x2bc),'event':'plisio_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x4ee26f instanceof Error?_0x4ee26f[_0x4e70f4(0x22c)]:'Unknown\x20error','webhookData':_0x116e5c})}});}catch(_0x5544d1){console[_0x4e70f4(0x248)](_0x4e70f4(0x271),_0x5544d1);}throw _0x4ee26f;}}async[a52_0x2c6bc9(0x273)](_0x2ef4dc){const _0x5c37b7=a52_0x2c6bc9;try{loggerService_1[_0x5c37b7(0x2a0)]['logWebhookReceived'](_0x5c37b7(0x283),_0x2ef4dc),console[_0x5c37b7(0x1f9)](_0x5c37b7(0x2aa),_0x2ef4dc);const {txn_id:_0x5e942a,order_number:_0x5eebe2,status:_0x4b7090,amount:_0x526b2b,currency:_0x1b7005,source_currency:_0x23686e,source_amount:_0x2cfa59,invoice_total_sum:_0x1bf5b4,invoice_commission:_0x25c3e6,invoice_sum:_0x133390,confirmations:_0x25e6b3,verify_hash:_0x17495d,merchant:_0x46ab89,merchant_id:_0x44ff5f,ipn_type:_0x712d16,order_name:_0x12d424,comment:_0x5dc71f}=_0x2ef4dc;if(!_0x5e942a||!_0x5eebe2){const _0xd83b8c=new Error(_0x5c37b7(0x2f3));loggerService_1[_0x5c37b7(0x2a0)][_0x5c37b7(0x250)]('plisio_gateway',_0xd83b8c,_0x2ef4dc);throw _0xd83b8c;}const _0x418039=await database_1[_0x5c37b7(0x229)][_0x5c37b7(0x23e)][_0x5c37b7(0x253)]({'where':{'OR':[{'id':_0x5eebe2},{'gatewayPaymentId':_0x5e942a},{'gatewayOrderId':_0x5eebe2}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x418039){const _0xe22a98=new Error(_0x5c37b7(0x279)+_0x5eebe2+_0x5c37b7(0x287)+_0x5e942a);loggerService_1[_0x5c37b7(0x2a0)][_0x5c37b7(0x250)](_0x5c37b7(0x283),_0xe22a98,_0x2ef4dc);throw _0xe22a98;}let _0xcc842b;switch(_0x4b7090?.[_0x5c37b7(0x2f0)]()){case'completed':case _0x5c37b7(0x2d7):_0xcc842b=_0x5c37b7(0x254);break;case _0x5c37b7(0x2ad):_0xcc842b=_0x5c37b7(0x21b);break;case _0x5c37b7(0x236):_0xcc842b=_0x5c37b7(0x21e);break;case'error':case _0x5c37b7(0x2d6):_0xcc842b='FAILED';break;case _0x5c37b7(0x234):case _0x5c37b7(0x245):default:_0xcc842b=_0x5c37b7(0x28e);break;}console[_0x5c37b7(0x1f9)](_0x5c37b7(0x28b)+_0x4b7090+_0x5c37b7(0x293)+_0xcc842b+'\x22');const _0x4418f7={'status':_0xcc842b,'updatedAt':new Date()};_0xcc842b===_0x5c37b7(0x254)&&_0x418039['status']!=='PAID'&&(_0x4418f7[_0x5c37b7(0x268)]=new Date(),console[_0x5c37b7(0x1f9)](_0x5c37b7(0x25f)+_0x418039['id']+_0x5c37b7(0x240)+_0x4418f7[_0x5c37b7(0x268)]['toISOString']())),_0x418039[_0x5c37b7(0x2b8)]!==_0xcc842b&&(await database_1['default'][_0x5c37b7(0x23e)][_0x5c37b7(0x2db)]({'where':{'id':_0x418039['id']},'data':_0x4418f7}),console[_0x5c37b7(0x1f9)]('Payment\x20'+_0x418039['id']+'\x20status\x20updated\x20from\x20'+_0x418039['status']+'\x20to\x20'+_0xcc842b),loggerService_1[_0x5c37b7(0x2a0)][_0x5c37b7(0x2d4)](_0x5c37b7(0x283),_0x418039['id'],_0x418039['status'],_0xcc842b,_0x2ef4dc),_0xcc842b===_0x5c37b7(0x254)&&await this['paymentLinkService'][_0x5c37b7(0x2cf)](_0x418039['id']),await this[_0x5c37b7(0x2c3)](_0x418039,_0xcc842b,_0x2ef4dc),await this[_0x5c37b7(0x2c1)](_0x418039,_0xcc842b)),await database_1[_0x5c37b7(0x229)][_0x5c37b7(0x2f1)][_0x5c37b7(0x249)]({'data':{'paymentId':_0x418039['id'],'shopId':_0x418039['shopId'],'event':_0x5c37b7(0x223)+_0x4b7090,'statusCode':0xc8,'responseBody':JSON[_0x5c37b7(0x213)](_0x2ef4dc)}});}catch(_0x321a19){console[_0x5c37b7(0x248)]('Gateway\x20webhook\x20processing\x20error:',_0x321a19),loggerService_1[_0x5c37b7(0x2a0)]['logWebhookError'](_0x5c37b7(0x283),_0x321a19,_0x2ef4dc);try{await database_1[_0x5c37b7(0x229)][_0x5c37b7(0x2f1)][_0x5c37b7(0x249)]({'data':{'paymentId':_0x5c37b7(0x2bc),'shopId':'unknown','event':_0x5c37b7(0x2bf),'statusCode':0x1f4,'responseBody':JSON[_0x5c37b7(0x213)]({'error':_0x321a19 instanceof Error?_0x321a19[_0x5c37b7(0x22c)]:_0x5c37b7(0x20f),'webhookData':_0x2ef4dc})}});}catch(_0x3d1049){console['error']('Failed\x20to\x20log\x20gateway\x20webhook\x20error:',_0x3d1049);}throw _0x321a19;}}async['processRapydWebhook'](_0x2a52d8){const _0x5c08c1=a52_0x2c6bc9;try{loggerService_1[_0x5c08c1(0x2a0)]['logWebhookReceived'](_0x5c08c1(0x243),_0x2a52d8),console[_0x5c08c1(0x1f9)]('Processing\x20Rapyd\x20webhook:',_0x2a52d8);const {id:_0x57fe62,type:_0x5b2e43,data:_0x1c4161,created_at:_0x2b4906}=_0x2a52d8;if(!_0x1c4161?.['id']){const _0x2980d4=new Error('Missing\x20required\x20webhook\x20data:\x20data.id');loggerService_1[_0x5c08c1(0x2a0)][_0x5c08c1(0x250)](_0x5c08c1(0x243),_0x2980d4,_0x2a52d8);throw _0x2980d4;}const _0x4186e0=_0x1c4161['id'],_0x1aec3a=_0x1c4161[_0x5c08c1(0x247)],_0x289358=await database_1[_0x5c08c1(0x229)][_0x5c08c1(0x23e)]['findFirst']({'where':{'OR':[{'gatewayPaymentId':_0x4186e0},{'id':_0x1aec3a},{'gatewayOrderId':_0x1aec3a}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x289358){const _0x582b15=new Error(_0x5c08c1(0x24a)+_0x4186e0+',\x20merchant_reference_id:\x20'+_0x1aec3a);loggerService_1[_0x5c08c1(0x2a0)][_0x5c08c1(0x250)](_0x5c08c1(0x243),_0x582b15,_0x2a52d8);throw _0x582b15;}let _0x52445d=null,_0x72a2a0=null;_0x1c4161['payment_method_data']&&(_0x52445d=_0x1c4161[_0x5c08c1(0x20e)][_0x5c08c1(0x21d)]||null,_0x72a2a0=_0x1c4161['payment_method_data'][_0x5c08c1(0x2b9)]||_0x1c4161['payment_method_type']||null);let _0x5510ac;switch(_0x5b2e43?.[_0x5c08c1(0x2c8)]()){case _0x5c08c1(0x21f):_0x1c4161[_0x5c08c1(0x230)]===!![]&&_0x1c4161[_0x5c08c1(0x2b8)]===_0x5c08c1(0x2a5)?_0x5510ac=_0x5c08c1(0x254):_0x5510ac=_0x5c08c1(0x21b);break;case _0x5c08c1(0x204):_0x5510ac=_0x5c08c1(0x207);break;case'PAYMENT_EXPIRED':_0x5510ac='EXPIRED';break;case _0x5c08c1(0x2b2):_0x5510ac='FAILED';break;default:switch(_0x1c4161[_0x5c08c1(0x2b8)]?.[_0x5c08c1(0x2c8)]()){case _0x5c08c1(0x2a5):_0x1c4161[_0x5c08c1(0x230)]===!![]?_0x5510ac=_0x5c08c1(0x254):_0x5510ac=_0x5c08c1(0x207);break;case'CAN':_0x5510ac=_0x5c08c1(0x207);break;case _0x5c08c1(0x2ac):_0x5510ac=_0x5c08c1(0x21e);break;case _0x5c08c1(0x2c5):_0x5510ac='FAILED';break;case _0x5c08c1(0x20a):_0x5510ac='PROCESSING';break;case'NEW':default:_0x5510ac=_0x5c08c1(0x28e);break;}break;}const _0x3095fd={'status':_0x5510ac,'updatedAt':new Date()};_0x52445d&&(_0x3095fd['cardLast4']=_0x52445d,console['log'](_0x5c08c1(0x2ae)+_0x52445d)),_0x72a2a0&&(_0x3095fd[_0x5c08c1(0x295)]=_0x72a2a0,console[_0x5c08c1(0x1f9)]('üí≥\x20Payment\x20method:\x20'+_0x72a2a0)),_0x5510ac===_0x5c08c1(0x254)&&_0x289358[_0x5c08c1(0x2b8)]!==_0x5c08c1(0x254)&&(_0x3095fd[_0x5c08c1(0x268)]=new Date(),console[_0x5c08c1(0x1f9)](_0x5c08c1(0x25f)+_0x289358['id']+_0x5c08c1(0x240)+_0x3095fd[_0x5c08c1(0x268)]['toISOString']())),(_0x289358[_0x5c08c1(0x2b8)]!==_0x5510ac||_0x52445d||_0x72a2a0)&&(await database_1[_0x5c08c1(0x229)][_0x5c08c1(0x23e)][_0x5c08c1(0x2db)]({'where':{'id':_0x289358['id']},'data':_0x3095fd}),_0x289358['status']!==_0x5510ac&&(console[_0x5c08c1(0x1f9)](_0x5c08c1(0x264)+_0x289358['id']+_0x5c08c1(0x261)+_0x289358[_0x5c08c1(0x2b8)]+_0x5c08c1(0x2e9)+_0x5510ac),loggerService_1[_0x5c08c1(0x2a0)][_0x5c08c1(0x2d4)]('rapyd',_0x289358['id'],_0x289358['status'],_0x5510ac,_0x2a52d8),_0x5510ac===_0x5c08c1(0x254)&&await this[_0x5c08c1(0x2d1)][_0x5c08c1(0x2cf)](_0x289358['id']),await this['sendShopWebhook'](_0x289358,_0x5510ac,_0x2a52d8),await this[_0x5c08c1(0x2c1)](_0x289358,_0x5510ac)),(_0x52445d||_0x72a2a0)&&console[_0x5c08c1(0x1f9)]('Payment\x20'+_0x289358['id']+'\x20details\x20updated:\x20card_last4='+_0x52445d+_0x5c08c1(0x22a)+_0x72a2a0)),await database_1[_0x5c08c1(0x229)]['webhookLog'][_0x5c08c1(0x249)]({'data':{'paymentId':_0x289358['id'],'shopId':_0x289358[_0x5c08c1(0x28c)],'event':_0x5c08c1(0x2c0)+_0x5b2e43,'statusCode':0xc8,'responseBody':JSON['stringify'](_0x2a52d8)}});}catch(_0x36886c){console[_0x5c08c1(0x248)](_0x5c08c1(0x2ce),_0x36886c),loggerService_1[_0x5c08c1(0x2a0)][_0x5c08c1(0x250)](_0x5c08c1(0x243),_0x36886c,_0x2a52d8);try{await database_1[_0x5c08c1(0x229)][_0x5c08c1(0x2f1)][_0x5c08c1(0x249)]({'data':{'paymentId':_0x5c08c1(0x2bc),'shopId':_0x5c08c1(0x2bc),'event':_0x5c08c1(0x205),'statusCode':0x1f4,'responseBody':JSON[_0x5c08c1(0x213)]({'error':_0x36886c instanceof Error?_0x36886c[_0x5c08c1(0x22c)]:'Unknown\x20error','webhookData':_0x2a52d8})}});}catch(_0x4b58c4){console[_0x5c08c1(0x248)]('Failed\x20to\x20log\x20Rapyd\x20webhook\x20error:',_0x4b58c4);}throw _0x36886c;}}async[a52_0x2c6bc9(0x2a9)](_0x145671){const _0x1fb3d7=a52_0x2c6bc9;try{loggerService_1['loggerService'][_0x1fb3d7(0x20b)]('noda',_0x145671),console[_0x1fb3d7(0x1f9)](_0x1fb3d7(0x219),_0x145671);const {PaymentId:_0x29783a,Status:_0x5aa629,Signature:_0x4afe55,MerchantPaymentId:_0x3693d6,Reference:_0x123b74,Amount:_0x28f937,Currency:_0x14d427,CardId:_0x4d8609,Remitter:_0x4ad522,AdditionalData:_0x307c4d,DetailedInfo:_0x49d87b,Method:_0x35be70,BankId:_0x3649f3,IsSenderBank:_0x30103e,BankTransactionId:_0x38f7e5,Settled:_0x101419,SettlementDate:_0x1ac231}=_0x145671;if(!_0x29783a&&!_0x3693d6){const _0x55bebe=new Error('Missing\x20required\x20webhook\x20data:\x20PaymentId\x20or\x20MerchantPaymentId');loggerService_1[_0x1fb3d7(0x2a0)][_0x1fb3d7(0x250)](_0x1fb3d7(0x2c4),_0x55bebe,_0x145671);throw _0x55bebe;}console[_0x1fb3d7(0x1f9)]('üîç\x20Searching\x20for\x20Noda\x20payment:'),console['log'](_0x1fb3d7(0x206)+_0x29783a),console['log'](_0x1fb3d7(0x24f)+_0x3693d6);const _0x45f641=await database_1[_0x1fb3d7(0x229)][_0x1fb3d7(0x23e)]['findFirst']({'where':{'OR':[{'gatewayPaymentId':_0x29783a},{'id':_0x3693d6},{'gatewayOrderId':_0x3693d6},{'orderId':_0x3693d6}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x45f641){console[_0x1fb3d7(0x1f9)](_0x1fb3d7(0x25c)),console[_0x1fb3d7(0x1f9)](_0x1fb3d7(0x276)+_0x29783a),console[_0x1fb3d7(0x1f9)](_0x1fb3d7(0x284)+_0x3693d6),console[_0x1fb3d7(0x1f9)](_0x1fb3d7(0x2f6)+_0x3693d6),console[_0x1fb3d7(0x1f9)]('\x20\x20\x20-\x20orderId:\x20'+_0x3693d6);const _0x1ac4a0=await database_1[_0x1fb3d7(0x229)]['payment'][_0x1fb3d7(0x200)]({'select':{'id':!![],'gatewayPaymentId':!![],'gatewayOrderId':!![],'orderId':!![],'gateway':!![],'status':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x1fb3d7(0x26f)},'take':0xa});console['log'](_0x1fb3d7(0x298)),_0x1ac4a0['forEach'](_0x23a9b6=>{const _0x163e49=_0x1fb3d7;console['log']('\x20\x20\x20-\x20ID:\x20'+_0x23a9b6['id']+_0x163e49(0x262)+_0x23a9b6[_0x163e49(0x26a)]+_0x163e49(0x2cb)+_0x23a9b6['gatewayPaymentId']+_0x163e49(0x1f2)+_0x23a9b6[_0x163e49(0x26d)]+_0x163e49(0x2c9)+_0x23a9b6[_0x163e49(0x2ec)]+',\x20Status:\x20'+_0x23a9b6['status']);});const _0x23d00c=new Error('Payment\x20not\x20found\x20for\x20PaymentId:\x20'+_0x29783a+_0x1fb3d7(0x1f4)+_0x3693d6);loggerService_1['loggerService'][_0x1fb3d7(0x250)]('noda',_0x23d00c,_0x145671);throw _0x23d00c;}console[_0x1fb3d7(0x1f9)]('‚úÖ\x20Found\x20payment:\x20'+_0x45f641['id']+'\x20(gateway:\x20'+_0x45f641[_0x1fb3d7(0x26a)]+')'),console['log'](_0x1fb3d7(0x276)+_0x45f641[_0x1fb3d7(0x299)]),console[_0x1fb3d7(0x1f9)](_0x1fb3d7(0x2f6)+_0x45f641[_0x1fb3d7(0x26d)]),console[_0x1fb3d7(0x1f9)](_0x1fb3d7(0x1fa)+_0x45f641[_0x1fb3d7(0x2ec)]);let _0xa02c90=null,_0x1fe19c=null;_0x4ad522&&(_0xa02c90=_0x4ad522[_0x1fb3d7(0x280)]||null,_0x1fe19c=_0x4ad522[_0x1fb3d7(0x23c)]||null);let _0x5ded4f;switch(_0x5aa629?.[_0x1fb3d7(0x2f0)]()){case _0x1fb3d7(0x2e8):case _0x1fb3d7(0x201):case _0x1fb3d7(0x230):case _0x1fb3d7(0x222):case _0x1fb3d7(0x257):_0x101419===_0x1fb3d7(0x24d)||_0x101419===!![]?_0x5ded4f=_0x1fb3d7(0x254):_0x5ded4f='PROCESSING';break;case _0x1fb3d7(0x27b):case'awaiting\x20confirmation':case _0x1fb3d7(0x275):_0x5ded4f=_0x1fb3d7(0x21b);break;case _0x1fb3d7(0x2d6):case _0x1fb3d7(0x203):case _0x1fb3d7(0x2ef):case _0x1fb3d7(0x248):case'rejected':_0x5ded4f='FAILED';break;case _0x1fb3d7(0x236):case _0x1fb3d7(0x2f4):_0x5ded4f=_0x1fb3d7(0x21e);break;case _0x1fb3d7(0x2ad):case _0x1fb3d7(0x2a4):case _0x1fb3d7(0x292):default:_0x5ded4f=_0x1fb3d7(0x28e);break;}console['log'](_0x1fb3d7(0x238)+_0x5aa629+_0x1fb3d7(0x293)+_0x5ded4f+'\x22');const _0x4bb755={'status':_0x5ded4f,'updatedAt':new Date()};_0xa02c90&&(_0x4bb755[_0x1fb3d7(0x2b6)]=_0xa02c90,console[_0x1fb3d7(0x1f9)]('üè¶\x20Extracted\x20remitter\x20IBAN:\x20'+_0xa02c90)),_0x1fe19c&&(_0x4bb755[_0x1fb3d7(0x259)]=_0x1fe19c,console[_0x1fb3d7(0x1f9)](_0x1fb3d7(0x1fb)+_0x1fe19c)),_0x3649f3&&(_0x4bb755[_0x1fb3d7(0x218)]=_0x3649f3,console['log']('üè¶\x20Bank\x20ID:\x20'+_0x3649f3)),_0x35be70&&(_0x4bb755['paymentMethod']=_0x35be70,console['log'](_0x1fb3d7(0x241)+_0x35be70)),_0x5ded4f===_0x1fb3d7(0x254)&&_0x45f641[_0x1fb3d7(0x2b8)]!==_0x1fb3d7(0x254)&&(_0x4bb755[_0x1fb3d7(0x268)]=new Date(),console[_0x1fb3d7(0x1f9)](_0x1fb3d7(0x25f)+_0x45f641['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x4bb755['paidAt']['toISOString']())),(_0x45f641[_0x1fb3d7(0x2b8)]!==_0x5ded4f||_0xa02c90||_0x1fe19c||_0x3649f3||_0x35be70)&&(await database_1[_0x1fb3d7(0x229)][_0x1fb3d7(0x23e)][_0x1fb3d7(0x2db)]({'where':{'id':_0x45f641['id']},'data':_0x4bb755}),_0x45f641[_0x1fb3d7(0x2b8)]!==_0x5ded4f&&(console[_0x1fb3d7(0x1f9)]('Payment\x20'+_0x45f641['id']+_0x1fb3d7(0x261)+_0x45f641[_0x1fb3d7(0x2b8)]+_0x1fb3d7(0x2e9)+_0x5ded4f),loggerService_1[_0x1fb3d7(0x2a0)][_0x1fb3d7(0x2d4)](_0x1fb3d7(0x2c4),_0x45f641['id'],_0x45f641[_0x1fb3d7(0x2b8)],_0x5ded4f,_0x145671),_0x5ded4f===_0x1fb3d7(0x254)&&await this[_0x1fb3d7(0x2d1)]['handleSuccessfulPayment'](_0x45f641['id']),await this[_0x1fb3d7(0x2c3)](_0x45f641,_0x5ded4f,_0x145671),await this[_0x1fb3d7(0x2c1)](_0x45f641,_0x5ded4f)),(_0xa02c90||_0x1fe19c||_0x3649f3||_0x35be70)&&console[_0x1fb3d7(0x1f9)](_0x1fb3d7(0x264)+_0x45f641['id']+_0x1fb3d7(0x29d)+_0xa02c90+_0x1fb3d7(0x228)+_0x1fe19c+_0x1fb3d7(0x217)+_0x3649f3+_0x1fb3d7(0x235)+_0x35be70)),await database_1[_0x1fb3d7(0x229)][_0x1fb3d7(0x2f1)]['create']({'data':{'paymentId':_0x45f641['id'],'shopId':_0x45f641[_0x1fb3d7(0x28c)],'event':_0x1fb3d7(0x2e2)+_0x5aa629,'statusCode':0xc8,'responseBody':JSON[_0x1fb3d7(0x213)]({..._0x145671,'parsed':{'nodaPaymentId':_0x29783a,'merchantPaymentId':_0x3693d6,'status':_0x5aa629,'amount':_0x28f937,'currency':_0x14d427,'method':_0x35be70,'bankId':_0x3649f3,'settled':_0x101419,'settlementDate':_0x1ac231,'remitterName':_0x4ad522?.[_0x1fb3d7(0x23c)],'remitterIban':_0x4ad522?.['Iban']}})}}),console[_0x1fb3d7(0x1f9)](_0x1fb3d7(0x277)+_0x45f641['id']),console['log'](_0x1fb3d7(0x263)+_0x5aa629+_0x1fb3d7(0x270)+_0x5ded4f+_0x1fb3d7(0x23b)+_0x28f937+'\x20'+_0x14d427+',\x20Method:\x20'+_0x35be70),console[_0x1fb3d7(0x1f9)]('Bank:\x20'+_0x3649f3+_0x1fb3d7(0x2ed)+_0x101419+',\x20Settlement\x20Date:\x20'+_0x1ac231),console[_0x1fb3d7(0x1f9)](_0x1fb3d7(0x285)+_0x1fe19c+'\x20('+_0xa02c90+')');}catch(_0x4ccaf9){console[_0x1fb3d7(0x248)](_0x1fb3d7(0x209),_0x4ccaf9),loggerService_1[_0x1fb3d7(0x2a0)]['logWebhookError'](_0x1fb3d7(0x2c4),_0x4ccaf9,_0x145671);try{await database_1[_0x1fb3d7(0x229)][_0x1fb3d7(0x2f1)][_0x1fb3d7(0x249)]({'data':{'paymentId':_0x1fb3d7(0x2bc),'shopId':_0x1fb3d7(0x2bc),'event':'noda_error','statusCode':0x1f4,'responseBody':JSON[_0x1fb3d7(0x213)]({'error':_0x4ccaf9 instanceof Error?_0x4ccaf9['message']:_0x1fb3d7(0x20f),'webhookData':_0x145671})}});}catch(_0x2fb376){console['error']('Failed\x20to\x20log\x20Noda\x20webhook\x20error:',_0x2fb376);}throw _0x4ccaf9;}}async[a52_0x2c6bc9(0x288)](_0x185562){const _0x94e8a5=a52_0x2c6bc9;try{loggerService_1[_0x94e8a5(0x2a0)][_0x94e8a5(0x20b)](_0x94e8a5(0x1ef),_0x185562),console[_0x94e8a5(0x1f9)]('Processing\x20CoinToPay\x20webhook:',_0x185562);const {order_id:_0x8fb2c4,gateway_payment_id:_0x4050f1,status:_0x415cd5,amount:_0xd0f980,currency:_0x4b6ad2,transaction_id:_0xf23177,confirmation_count:_0x1bb8e7}=_0x185562;if(!_0x8fb2c4&&!_0x4050f1){const _0x4abbbc=new Error(_0x94e8a5(0x231));loggerService_1['loggerService'][_0x94e8a5(0x250)]('cointopay',_0x4abbbc,_0x185562);throw _0x4abbbc;}const _0x357fc5=await database_1[_0x94e8a5(0x229)][_0x94e8a5(0x23e)][_0x94e8a5(0x253)]({'where':{'OR':[{'gatewayPaymentId':_0x4050f1},{'id':_0x8fb2c4},{'gatewayOrderId':_0x8fb2c4},{'orderId':_0x8fb2c4}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x357fc5){const _0x364efa=new Error(_0x94e8a5(0x233)+_0x8fb2c4+',\x20gateway_payment_id:\x20'+_0x4050f1);loggerService_1[_0x94e8a5(0x2a0)][_0x94e8a5(0x250)](_0x94e8a5(0x1ef),_0x364efa,_0x185562);throw _0x364efa;}let _0x39b266;switch(_0x415cd5?.[_0x94e8a5(0x2f0)]()){case'paid':case _0x94e8a5(0x201):case'confirmed':_0x39b266=_0x94e8a5(0x254);break;case'processing':case _0x94e8a5(0x290):_0x39b266=_0x94e8a5(0x21b);break;case'cancelled':case _0x94e8a5(0x2ef):case _0x94e8a5(0x248):_0x39b266=_0x94e8a5(0x207);break;case'expired':case _0x94e8a5(0x2f4):_0x39b266='EXPIRED';break;case _0x94e8a5(0x2ad):case _0x94e8a5(0x2e0):case _0x94e8a5(0x2a4):default:_0x39b266=_0x94e8a5(0x28e);break;}console[_0x94e8a5(0x1f9)](_0x94e8a5(0x239)+_0x415cd5+_0x94e8a5(0x293)+_0x39b266+'\x22');const _0x23b3ae={'status':_0x39b266,'updatedAt':new Date()};_0x39b266===_0x94e8a5(0x254)&&_0x357fc5[_0x94e8a5(0x2b8)]!==_0x94e8a5(0x254)&&(_0x23b3ae['paidAt']=new Date(),console['log']('üí∞\x20Payment\x20'+_0x357fc5['id']+_0x94e8a5(0x240)+_0x23b3ae[_0x94e8a5(0x268)][_0x94e8a5(0x2b0)]())),_0x357fc5[_0x94e8a5(0x2b8)]!==_0x39b266?(this[_0x94e8a5(0x232)](_0x357fc5['id'],_0x4050f1||_0x357fc5['gatewayPaymentId']||'unknown',_0x357fc5[_0x94e8a5(0x2b8)],_0x39b266,_0x185562),await database_1[_0x94e8a5(0x229)]['payment']['update']({'where':{'id':_0x357fc5['id']},'data':_0x23b3ae}),console[_0x94e8a5(0x1f9)](_0x94e8a5(0x264)+_0x357fc5['id']+'\x20status\x20updated\x20from\x20'+_0x357fc5[_0x94e8a5(0x2b8)]+_0x94e8a5(0x2e9)+_0x39b266),loggerService_1[_0x94e8a5(0x2a0)][_0x94e8a5(0x2d4)]('cointopay',_0x357fc5['id'],_0x357fc5['status'],_0x39b266,_0x185562),_0x39b266===_0x94e8a5(0x254)&&await this[_0x94e8a5(0x2d1)][_0x94e8a5(0x2cf)](_0x357fc5['id']),await this['sendShopWebhook'](_0x357fc5,_0x39b266,_0x185562),await this[_0x94e8a5(0x2c1)](_0x357fc5,_0x39b266)):this[_0x94e8a5(0x232)](_0x357fc5['id'],_0x4050f1||_0x357fc5['gatewayPaymentId']||_0x94e8a5(0x2bc),_0x357fc5[_0x94e8a5(0x2b8)],_0x39b266,{..._0x185562,'statusUnchanged':!![],'note':_0x94e8a5(0x1f7)}),await database_1[_0x94e8a5(0x229)][_0x94e8a5(0x2f1)][_0x94e8a5(0x249)]({'data':{'paymentId':_0x357fc5['id'],'shopId':_0x357fc5[_0x94e8a5(0x28c)],'event':_0x94e8a5(0x2ab)+_0x415cd5,'statusCode':0xc8,'responseBody':JSON[_0x94e8a5(0x213)](_0x185562)}}),console[_0x94e8a5(0x1f9)](_0x94e8a5(0x20d)+_0x357fc5['id']),console['log'](_0x94e8a5(0x263)+_0x415cd5+_0x94e8a5(0x270)+_0x39b266+_0x94e8a5(0x23b)+_0xd0f980+'\x20'+(_0x4b6ad2||_0x94e8a5(0x274)));}catch(_0x55303d){console[_0x94e8a5(0x248)](_0x94e8a5(0x1f0),_0x55303d);const _0x106e9e=_0x185562?.[_0x94e8a5(0x25e)]||_0x94e8a5(0x2bc),_0x168df0=_0x185562?.['gateway_payment_id']||'unknown',_0x2f36d8={'type':_0x94e8a5(0x28a),'paymentId':_0x106e9e,'gatewayPaymentId':_0x168df0,'error':_0x55303d instanceof Error?{'message':_0x55303d['message'],'stack':_0x55303d['stack']}:_0x55303d,'source':_0x94e8a5(0x28d),'timestamp':new Date()[_0x94e8a5(0x2b0)](),'webhookData':_0x185562};loggerService_1[_0x94e8a5(0x2a0)][_0x94e8a5(0x211)](_0x2f36d8),loggerService_1['loggerService']['logWebhookError'](_0x94e8a5(0x1ef),_0x55303d,_0x185562);try{await database_1['default'][_0x94e8a5(0x2f1)][_0x94e8a5(0x249)]({'data':{'paymentId':_0x106e9e,'shopId':'unknown','event':_0x94e8a5(0x221),'statusCode':0x1f4,'responseBody':JSON[_0x94e8a5(0x213)]({'error':_0x55303d instanceof Error?_0x55303d[_0x94e8a5(0x22c)]:_0x94e8a5(0x20f),'webhookData':_0x185562})}});}catch(_0x4827f5){console[_0x94e8a5(0x248)](_0x94e8a5(0x2e1),_0x4827f5);}throw _0x55303d;}}async[a52_0x2c6bc9(0x1ff)](_0x369388){const _0x5f40dd=a52_0x2c6bc9;try{loggerService_1[_0x5f40dd(0x2a0)]['logWebhookReceived']('klyme',_0x369388),console['log'](_0x5f40dd(0x2eb),_0x369388);const {payment_id:_0x2206b3,order_id:_0x15db76,status:_0x311e6a,amount:_0x274a77,currency:_0x490f9c,region:_0x839e1d,customer_email:_0x45c7da,customer_name:_0xa4aa88,payment_method:_0x4cfd46,transaction_id:_0x298626}=_0x369388;if(!_0x15db76&&!_0x2206b3){const _0x1f78da=new Error(_0x5f40dd(0x27c));loggerService_1['loggerService'][_0x5f40dd(0x250)]('klyme',_0x1f78da,_0x369388);throw _0x1f78da;}console[_0x5f40dd(0x1f9)](_0x5f40dd(0x2f5)+_0x839e1d+_0x5f40dd(0x258)),console[_0x5f40dd(0x1f9)](_0x5f40dd(0x206)+_0x2206b3),console[_0x5f40dd(0x1f9)]('\x20\x20\x20-\x20OrderId:\x20'+_0x15db76);const _0x475e19=await database_1[_0x5f40dd(0x229)][_0x5f40dd(0x23e)][_0x5f40dd(0x253)]({'where':{'OR':[{'gatewayPaymentId':_0x2206b3},{'id':_0x15db76},{'gatewayOrderId':_0x15db76},{'orderId':_0x15db76}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x475e19){console['log'](_0x5f40dd(0x215)),console['log'](_0x5f40dd(0x276)+_0x2206b3),console[_0x5f40dd(0x1f9)](_0x5f40dd(0x284)+_0x15db76),console[_0x5f40dd(0x1f9)](_0x5f40dd(0x2f6)+_0x15db76),console[_0x5f40dd(0x1f9)](_0x5f40dd(0x1fa)+_0x15db76);const _0x5ed1b1=new Error(_0x5f40dd(0x2a7)+_0x2206b3+_0x5f40dd(0x2de)+_0x15db76);loggerService_1[_0x5f40dd(0x2a0)][_0x5f40dd(0x250)](_0x5f40dd(0x27f),_0x5ed1b1,_0x369388);throw _0x5ed1b1;}console[_0x5f40dd(0x1f9)](_0x5f40dd(0x214)+_0x475e19['id']+_0x5f40dd(0x22b)+_0x475e19[_0x5f40dd(0x26a)]+')');let _0xe37d70;switch(_0x311e6a?.[_0x5f40dd(0x2f0)]()){case _0x5f40dd(0x230):case _0x5f40dd(0x201):case _0x5f40dd(0x2a6):case _0x5f40dd(0x222):case _0x5f40dd(0x257):_0xe37d70=_0x5f40dd(0x254);break;case'processing':case _0x5f40dd(0x292):case _0x5f40dd(0x275):_0xe37d70=_0x5f40dd(0x21b);break;case _0x5f40dd(0x2d6):case _0x5f40dd(0x203):case _0x5f40dd(0x2ef):case _0x5f40dd(0x248):case _0x5f40dd(0x294):_0xe37d70='FAILED';break;case _0x5f40dd(0x236):case _0x5f40dd(0x2f4):_0xe37d70=_0x5f40dd(0x21e);break;case _0x5f40dd(0x2ad):case'created':default:_0xe37d70=_0x5f40dd(0x28e);break;}const _0x56c6ad={'status':_0xe37d70,'updatedAt':new Date()};_0x4cfd46&&(_0x56c6ad[_0x5f40dd(0x295)]=_0x4cfd46,console['log'](_0x5f40dd(0x2c7)+_0x4cfd46)),_0xe37d70===_0x5f40dd(0x254)&&_0x475e19[_0x5f40dd(0x2b8)]!==_0x5f40dd(0x254)&&(_0x56c6ad[_0x5f40dd(0x268)]=new Date(),console['log'](_0x5f40dd(0x25f)+_0x475e19['id']+_0x5f40dd(0x240)+_0x56c6ad[_0x5f40dd(0x268)]['toISOString']())),(_0x475e19[_0x5f40dd(0x2b8)]!==_0xe37d70||_0x4cfd46)&&(await database_1[_0x5f40dd(0x229)][_0x5f40dd(0x23e)][_0x5f40dd(0x2db)]({'where':{'id':_0x475e19['id']},'data':_0x56c6ad}),_0x475e19['status']!==_0xe37d70&&(console[_0x5f40dd(0x1f9)](_0x5f40dd(0x264)+_0x475e19['id']+'\x20status\x20updated\x20from\x20'+_0x475e19[_0x5f40dd(0x2b8)]+_0x5f40dd(0x2e9)+_0xe37d70),loggerService_1[_0x5f40dd(0x2a0)][_0x5f40dd(0x2d4)]('klyme',_0x475e19['id'],_0x475e19['status'],_0xe37d70,_0x369388),_0xe37d70==='PAID'&&await this[_0x5f40dd(0x2d1)][_0x5f40dd(0x2cf)](_0x475e19['id']),await this['sendShopWebhook'](_0x475e19,_0xe37d70,_0x369388),await this[_0x5f40dd(0x2c1)](_0x475e19,_0xe37d70)),_0x4cfd46&&console['log'](_0x5f40dd(0x264)+_0x475e19['id']+_0x5f40dd(0x267)+_0x4cfd46)),await database_1[_0x5f40dd(0x229)]['webhookLog'][_0x5f40dd(0x249)]({'data':{'paymentId':_0x475e19['id'],'shopId':_0x475e19[_0x5f40dd(0x28c)],'event':_0x5f40dd(0x246)+_0x839e1d?.[_0x5f40dd(0x2f0)]()+'_'+_0x311e6a,'statusCode':0xc8,'responseBody':JSON[_0x5f40dd(0x213)]({..._0x369388,'parsed':{'klymePaymentId':_0x2206b3,'orderId':_0x15db76,'status':_0x311e6a,'amount':_0x274a77,'currency':_0x490f9c,'region':_0x839e1d,'payment_method':_0x4cfd46,'transaction_id':_0x298626}})}}),console[_0x5f40dd(0x1f9)](_0x5f40dd(0x266)+_0x839e1d+_0x5f40dd(0x278)+_0x475e19['id']),console['log']('Status:\x20'+_0x311e6a+_0x5f40dd(0x270)+_0xe37d70+',\x20Amount:\x20'+_0x274a77+'\x20'+_0x490f9c+_0x5f40dd(0x20c)+_0x839e1d),console[_0x5f40dd(0x1f9)](_0x5f40dd(0x2a3)+_0x4cfd46+_0x5f40dd(0x27d)+_0x298626);}catch(_0x3b2eda){console[_0x5f40dd(0x248)](_0x5f40dd(0x286),_0x3b2eda),loggerService_1[_0x5f40dd(0x2a0)]['logWebhookError']('klyme',_0x3b2eda,_0x369388);try{await database_1['default'][_0x5f40dd(0x2f1)][_0x5f40dd(0x249)]({'data':{'paymentId':_0x5f40dd(0x2bc),'shopId':_0x5f40dd(0x2bc),'event':_0x5f40dd(0x2d0),'statusCode':0x1f4,'responseBody':JSON[_0x5f40dd(0x213)]({'error':_0x3b2eda instanceof Error?_0x3b2eda[_0x5f40dd(0x22c)]:'Unknown\x20error','webhookData':_0x369388})}});}catch(_0x60b081){console['error'](_0x5f40dd(0x22f),_0x60b081);}throw _0x3b2eda;}}async[a52_0x2c6bc9(0x2c3)](_0x4563b0,_0xe8db03,_0x3f361d){const _0x9fed16=a52_0x2c6bc9,_0x314bd5=Date['now']();try{const _0x2e2a4e=_0x4563b0[_0x9fed16(0x2a2)],_0x3bdef0=_0x2e2a4e['settings'];if(!_0x3bdef0?.[_0x9fed16(0x2df)]){console[_0x9fed16(0x1f9)](_0x9fed16(0x2ea)+_0x2e2a4e['id']);return;}const _0x14ba2e=this[_0x9fed16(0x208)](_0x3bdef0[_0x9fed16(0x25a)]),_0x4a889b=_0xe8db03===_0x9fed16(0x254)?_0x9fed16(0x2e3):_0xe8db03==='FAILED'?'payment.failed':_0x9fed16(0x24c);if(!_0x14ba2e[_0x9fed16(0x202)](_0x4a889b)){console[_0x9fed16(0x1f9)](_0x9fed16(0x2a8)+_0x4a889b+_0x9fed16(0x2be)+_0x2e2a4e['id']);return;}const _0x19dd62=(0x0,gateway_1[_0x9fed16(0x24e)])(_0x4563b0[_0x9fed16(0x26a)]),_0x36df1b={'event':_0x4a889b,'payment':{'id':_0x4563b0['id'],'order_id':_0x4563b0['orderId'],'gateway_order_id':_0x4563b0[_0x9fed16(0x26d)],'gateway':_0x19dd62||_0x4563b0[_0x9fed16(0x26a)],'amount':_0x4563b0[_0x9fed16(0x251)],'currency':_0x4563b0[_0x9fed16(0x269)],'status':_0xe8db03[_0x9fed16(0x2f0)](),'customer_email':_0x4563b0[_0x9fed16(0x224)],'customer_name':_0x4563b0[_0x9fed16(0x1f6)],'card_last4':_0x4563b0[_0x9fed16(0x2e6)],'payment_method':_0x4563b0[_0x9fed16(0x295)],'bank_id':_0x4563b0[_0x9fed16(0x218)],'remitter_iban':_0x4563b0['remitterIban'],'remitter_name':_0x4563b0[_0x9fed16(0x259)],'created_at':_0x4563b0[_0x9fed16(0x2b7)],'updated_at':_0x4563b0[_0x9fed16(0x220)]}};console[_0x9fed16(0x1f9)](_0x9fed16(0x2d9)+_0x19dd62+_0x9fed16(0x2ba)+_0x4563b0['gateway']+')');const _0x3d0cb6=await fetch(_0x3bdef0[_0x9fed16(0x2df)],{'method':_0x9fed16(0x1f5),'headers':{'Content-Type':_0x9fed16(0x237),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x9fed16(0x213)](_0x36df1b)}),_0x25ed5e=Date['now']()-_0x314bd5,_0x3d7b6c=_0x3d0cb6['ok']?_0x9fed16(0x296):await _0x3d0cb6[_0x9fed16(0x2e7)]();loggerService_1[_0x9fed16(0x2a0)][_0x9fed16(0x265)](_0x4563b0[_0x9fed16(0x28c)],_0x3bdef0[_0x9fed16(0x2df)],_0x4a889b,_0x3d0cb6[_0x9fed16(0x2b8)],_0x25ed5e,_0x36df1b),await database_1['default'][_0x9fed16(0x2f1)][_0x9fed16(0x249)]({'data':{'paymentId':_0x4563b0['id'],'shopId':_0x4563b0[_0x9fed16(0x28c)],'event':_0x9fed16(0x2c6)+_0x4a889b,'statusCode':_0x3d0cb6[_0x9fed16(0x2b8)],'responseBody':_0x3d7b6c}}),console[_0x9fed16(0x1f9)]('Shop\x20webhook\x20sent\x20to\x20'+_0x3bdef0[_0x9fed16(0x2df)]+_0x9fed16(0x216)+_0x3d0cb6[_0x9fed16(0x2b8)]+'\x20('+_0x25ed5e+_0x9fed16(0x26c));}catch(_0xc9cdc){const _0x547abf=Date['now']()-_0x314bd5;console[_0x9fed16(0x248)](_0x9fed16(0x29e),_0xc9cdc),loggerService_1[_0x9fed16(0x2a0)][_0x9fed16(0x282)](_0x4563b0[_0x9fed16(0x28c)],_0x4563b0[_0x9fed16(0x2a2)]?.['settings']?.['webhookUrl']||_0x9fed16(0x2bc),'webhook_send',_0xc9cdc,{});try{await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0x4563b0['id'],'shopId':_0x4563b0['shopId'],'event':_0x9fed16(0x212),'statusCode':0x0,'responseBody':JSON[_0x9fed16(0x213)]({'error':_0xc9cdc instanceof Error?_0xc9cdc[_0x9fed16(0x22c)]:'Unknown\x20error','responseTime':_0x547abf})}});}catch(_0x41689f){console[_0x9fed16(0x248)](_0x9fed16(0x281),_0x41689f);}}}async[a52_0x2c6bc9(0x2c1)](_0x8d529e,_0x56ddc5){const _0x19231f=a52_0x2c6bc9;try{console[_0x19231f(0x1f9)](_0x19231f(0x22e)+_0x8d529e['id']+',\x20status:\x20'+_0x56ddc5);const _0x4b1514=await database_1[_0x19231f(0x229)][_0x19231f(0x23a)][_0x19231f(0x252)]({'where':{'shopId':_0x8d529e[_0x19231f(0x28c)]},'select':{'notificationPaymentSuccess':!![],'notificationPaymentFailed':!![],'notificationRefund':!![],'notificationPayout':!![],'notificationLogin':!![],'notificationApiError':!![]}});if(!_0x4b1514){console[_0x19231f(0x1f9)](_0x19231f(0x226)+_0x8d529e[_0x19231f(0x28c)]+',\x20skipping\x20Telegram\x20notification');return;}console[_0x19231f(0x1f9)](_0x19231f(0x2b3),{'payment_success':_0x4b1514[_0x19231f(0x22d)],'payment_failed':_0x4b1514[_0x19231f(0x2dc)],'refund':_0x4b1514[_0x19231f(0x1f1)],'payout':_0x4b1514['notificationPayout'],'login':_0x4b1514[_0x19231f(0x27a)],'api_error':_0x4b1514['notificationApiError']});let _0x206912=![],_0x35ec52;switch(_0x56ddc5){case _0x19231f(0x28e):_0x4b1514[_0x19231f(0x2dc)]&&(_0x206912=!![],_0x35ec52=_0x19231f(0x2a4));break;case'PROCESSING':_0x4b1514[_0x19231f(0x2dc)]&&(_0x206912=!![],_0x35ec52=_0x19231f(0x27b));break;case _0x19231f(0x254):_0x4b1514[_0x19231f(0x22d)]&&(_0x206912=!![],_0x35ec52=_0x19231f(0x230));break;case _0x19231f(0x207):_0x4b1514[_0x19231f(0x2dc)]&&(_0x206912=!![],_0x35ec52=_0x19231f(0x2ef));break;case _0x19231f(0x21e):_0x4b1514[_0x19231f(0x2dc)]&&(_0x206912=!![],_0x35ec52=_0x19231f(0x236));break;case _0x19231f(0x2af):_0x4b1514[_0x19231f(0x1f1)]&&(_0x206912=!![],_0x35ec52=_0x19231f(0x260));break;case _0x19231f(0x2b4):_0x4b1514[_0x19231f(0x1f1)]&&(_0x206912=!![],_0x35ec52=_0x19231f(0x289));break;default:console['log']('üì±\x20Unknown\x20payment\x20status:\x20'+_0x56ddc5+_0x19231f(0x2d3));return;}if(!_0x206912){console[_0x19231f(0x1f9)]('üì±\x20Telegram\x20notification\x20disabled\x20for\x20status:\x20'+_0x56ddc5+'\x20in\x20shop\x20settings');return;}await telegramBotService_1['telegramBotService'][_0x19231f(0x2bd)](_0x8d529e[_0x19231f(0x28c)],_0x8d529e,_0x35ec52),console[_0x19231f(0x1f9)](_0x19231f(0x24b)+_0x8d529e['id']);}catch(_0x449fdd){console['error'](_0x19231f(0x28f),_0x449fdd);}}async['sendNotificationToShop'](_0x2de3d5,_0x2f5d71){const _0x20c9e9=a52_0x2c6bc9;console['log'](_0x20c9e9(0x21a)+_0x2de3d5['id']+_0x20c9e9(0x2e4)+_0x2f5d71);}}exports['WebhookService']=WebhookService;