'use strict';function a61_0x4920(_0x4eee83,_0x277b92){const _0x4a05ad=a61_0x4a05();return a61_0x4920=function(_0x4920f1,_0x2ae835){_0x4920f1=_0x4920f1-0x190;let _0x39f8dd=_0x4a05ad[_0x4920f1];return _0x39f8dd;},a61_0x4920(_0x4eee83,_0x277b92);}const a61_0x2a4edb=a61_0x4920;(function(_0xab9e63,_0x399b1c){const _0x18dfbe=a61_0x4920,_0x323d47=_0xab9e63();while(!![]){try{const _0x144c49=parseInt(_0x18dfbe(0x210))/0x1+-parseInt(_0x18dfbe(0x20a))/0x2*(parseInt(_0x18dfbe(0x27b))/0x3)+-parseInt(_0x18dfbe(0x198))/0x4+parseInt(_0x18dfbe(0x1c8))/0x5*(-parseInt(_0x18dfbe(0x278))/0x6)+-parseInt(_0x18dfbe(0x1f0))/0x7+parseInt(_0x18dfbe(0x1ff))/0x8*(parseInt(_0x18dfbe(0x258))/0x9)+parseInt(_0x18dfbe(0x247))/0xa;if(_0x144c49===_0x399b1c)break;else _0x323d47['push'](_0x323d47['shift']());}catch(_0x4fb38a){_0x323d47['push'](_0x323d47['shift']());}}}(a61_0x4a05,0x2bb61));var __importDefault=this&&this['__importDefault']||function(_0x121569){return _0x121569&&_0x121569['__esModule']?_0x121569:{'default':_0x121569};};Object[a61_0x2a4edb(0x1d7)](exports,a61_0x2a4edb(0x263),{'value':!![]}),exports[a61_0x2a4edb(0x229)]=void 0x0;function a61_0x4a05(){const _0x1d5364=['logShopWebhookSent','expired','nodaService','Gateway\x20','cointopay','🔄\x20Processing\x20Plisio\x20webhook:','\x20to\x20','payment.failed','telegramBotService','Error\x20processing\x20Plisio\x20webhook:','remitterName','./currencyService','remitterIban','\x20updated:\x20currentPayments=','getGatewayCommission','failureMessage','📈\x20Found\x20payment\x20link\x20','📊\x20Plisio\x20webhook:\x20Payment\x20','./gateways/nodaService','\x22,\x20orderId=\x22','klymeService','toFixed','❌\x20Available\x20webhook\x20fields:','failed','rapydService','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','sendPaymentNotification','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','payment_method','amount','\x20->\x20','settings','./loggerService','convertToUSDT','299395QBjmao','Error\x20processing\x20Rapyd\x20webhook:','processKlymeWebhook','default',',\x20using\x20default\x20commission\x2010%','CHARGEBACK','findMany','coinToPayService','processCoinToPay2Webhook',',\x20gateway\x20','./gateways/coinToPay2Service','toISOString','processCoinToPayWebhook','CoinToPay2Service','No\x20payment\x20ID\x20in\x20Amer\x20webhook','defineProperty','\x20USDT\x20(chargeback\x20penalty)','Payment\x20not\x20found','\x20status\x20','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','Payment\x20','paymentMethod','✅\x20Shop\x20','orderId','currencyService','SINGLE',',\x20newStatus=','plisio','currentPayments','gatewayOrderId','cardLast4','\x20in\x20shop\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','PAID','paymentId','webhookLog','coinToPay2Service','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','klyme','NodaService','66493bCflMk','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','📊\x20Amer\x20webhook\x20result:','ms)','isArray','shopId','sendShopWebhook','💸\x20Additional\x20chargeback\x20penalty:\x20-','💰\x20Converting\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','✅\x20Payment\x20link\x20','keys','payment.success','\x20current\x20balance:\x20','findUnique','800696jdiKmE','📊\x20Amer\x20webhook:\x20Payment\x20','\x22,\x20paymentLinkId=\x22','processNodaWebhook','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','plisio_gateway',',\x20using\x20default\x2010%','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','COMPLETED','\x20commission:\x20','8490XIVUpx','\x20+\x20','CoinToPayService','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','create','loggerService','7835VxxbQx','❌\x20Error\x20processing\x20Amer\x20webhook:','KlymeService','gateway','FAILED','📈\x20Payment\x20details:\x20oldStatus=\x22','additionalInfo','logShopWebhookError','✅\x20Found\x20payment\x20','cointopay2','❌\x20Error\x20processing\x20MasterCard\x20webhook:','\x22,\x20newStatus=\x22','📊\x20MasterCard\x20webhook\x20result:','MasterCardService','🔍\x20Search\x20result:\x20','🏪\x20Shop\x20','💰\x20Removing\x20from\x20balance:\x20','RapydService','Error\x20parsing\x20webhook\x20events:','webhook_status_change_','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','No\x20payment\x20ID\x20in\x20Noda\x20webhook','./gateways/amerService','update','📈\x20Payment\x20','WebhookService','📤\x20Shop\x20webhook\x20sent\x20to\x20','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','🔄\x20Processing\x20CoinToPay2\x20webhook:','%\x20gateway\x20commission)','updatePaymentStatus','masterCardService','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','includes','💰\x20Payment\x20','error','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','createdAt','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','commission','./gateways/plisioService','toUpperCase','\x20-\x20','\x20not\x20enabled\x20for\x20shop\x20','noda','status','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','processPlisioWebhook','paymentLink','Failed\x20to\x20send\x20shop\x20webhook:','🔄\x20Processing\x20CoinToPay\x20webhook:','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','\x20with\x20status\x20','Error\x20processing\x20KLYME\x20webhook:','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','6061560SmwWDK','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20',',\x20currentPayments=','gatewaySettings','\x20not\x20found','sendPaymentStatusNotification','txUrls','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','amer','mastercard','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20',',\x20status=','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','type','amountUSDT','currency','27UOdswz','paidAt','💰\x20Amount\x20after\x20gateway\x20commission:\x20','now','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','rapyd','unknown','stringify','./gateways/mastercardService','📊\x20KLYME\x20webhook:\x20Payment\x20','__esModule','\x20commission\x20for\x20shop\x20','Webhook\x20event\x20','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','./telegramBotService','📊\x20Noda\x20webhook:\x20Payment\x20','paid','🔄\x20Processing\x20Noda\x20webhook:','amountAfterGatewayCommissionUSDT','processRapydWebhook','payment','webhook_send','\x20balance\x20updated:\x20','PlisioService','logWebhookProcessed','findFirst','amerService','text','log','paymentLinkId','30HpnFGW','created','./gateways/rapydService','75ciZNjz','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','application/json','bankId','\x20USDT','./gateways/coinToPayService','\x20and\x20-','processWebhook','💰\x20Adding\x20to\x20balance:\x20','Error\x20processing\x20CoinToPay2\x20webhook:','shop','\x20=\x20','refund','toLowerCase','balance','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','TesSoft\x20Payment\x20System/1.0','processMasterCardWebhook','📝\x20Reason:\x20','1280768oiOgKW','webhookUrl','username','plisioService','processAmerWebhook','webhookEvents','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','💰\x20Final\x20balance\x20after\x20chargeback:\x20','logWebhookError','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','parse','chargebackAmount'];a61_0x4a05=function(){return _0x1d5364;};return a61_0x4a05();}const database_1=__importDefault(require('../config/database')),plisioService_1=require(a61_0x2a4edb(0x238)),rapydService_1=require(a61_0x2a4edb(0x27a)),nodaService_1=require(a61_0x2a4edb(0x1b7)),coinToPayService_1=require(a61_0x2a4edb(0x281)),coinToPay2Service_1=require(a61_0x2a4edb(0x1d2)),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a61_0x2a4edb(0x261)),amerService_1=require(a61_0x2a4edb(0x226)),telegramBotService_1=require(a61_0x2a4edb(0x268)),currencyService_1=require(a61_0x2a4edb(0x1b0)),loggerService_1=require(a61_0x2a4edb(0x1c6));class WebhookService{constructor(){const _0x243b60=a61_0x2a4edb;this['plisioService']=new plisioService_1[(_0x243b60(0x271))](),this['rapydService']=new rapydService_1[(_0x243b60(0x221))](),this[_0x243b60(0x1a7)]=new nodaService_1[(_0x243b60(0x1ef))](),this[_0x243b60(0x1cf)]=new coinToPayService_1[(_0x243b60(0x20c))](),this[_0x243b60(0x1ec)]=new coinToPay2Service_1[(_0x243b60(0x1d5))](),this[_0x243b60(0x1b9)]=new klymeService_1[(_0x243b60(0x212))](),this[_0x243b60(0x22f)]=new mastercardService_1[(_0x243b60(0x21d))](),this[_0x243b60(0x274)]=new amerService_1['AmerService']();}async[a61_0x2a4edb(0x22e)](_0x6c8bf5,_0x562fa7,_0x518407){const _0x4d5785=a61_0x2a4edb;console[_0x4d5785(0x276)](_0x4d5785(0x1a2)+_0x6c8bf5+_0x4d5785(0x1e2)+_0x562fa7),console[_0x4d5785(0x276)]('🔄\x20Additional\x20data:',_0x518407),await database_1[_0x4d5785(0x1cb)]['$transaction'](async _0x35a19c=>{const _0x1096d2=_0x4d5785,_0x232640=await _0x35a19c[_0x1096d2(0x26e)]['findUnique']({'where':{'id':_0x6c8bf5},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x232640)throw new Error(_0x1096d2(0x1dc)+_0x6c8bf5+_0x1096d2(0x24c));const _0x841dd6=_0x232640['status'],_0x49e8be=_0x232640[_0x1096d2(0x286)];console[_0x1096d2(0x276)](_0x1096d2(0x232)+_0x6c8bf5+':\x20'+_0x841dd6+_0x1096d2(0x1c4)+_0x562fa7),console[_0x1096d2(0x276)](_0x1096d2(0x21f)+_0x49e8be['username']+_0x1096d2(0x1fd)+_0x49e8be[_0x1096d2(0x193)]+_0x1096d2(0x280));const _0xd45e46={'status':_0x562fa7[_0x1096d2(0x239)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x518407?.[_0x1096d2(0x1b4)]&&(_0xd45e46[_0x1096d2(0x1b4)]=_0x518407[_0x1096d2(0x1b4)]);_0x518407?.[_0x1096d2(0x24e)]&&(_0xd45e46['txUrls']=JSON[_0x1096d2(0x260)](_0x518407[_0x1096d2(0x24e)]));_0x518407?.[_0x1096d2(0x1e6)]&&(_0xd45e46[_0x1096d2(0x1e6)]=_0x518407[_0x1096d2(0x1e6)]);_0x518407?.[_0x1096d2(0x1dd)]&&(_0xd45e46[_0x1096d2(0x1dd)]=_0x518407[_0x1096d2(0x1dd)]);_0x518407?.['bankId']&&(_0xd45e46[_0x1096d2(0x27f)]=_0x518407[_0x1096d2(0x27f)]);_0x518407?.['remitterIban']&&(_0xd45e46[_0x1096d2(0x1b1)]=_0x518407[_0x1096d2(0x1b1)]);_0x518407?.[_0x1096d2(0x1af)]&&(_0xd45e46[_0x1096d2(0x1af)]=_0x518407[_0x1096d2(0x1af)]);let _0x2f31a9=_0x49e8be[_0x1096d2(0x193)],_0x1d9136='';if(_0x562fa7[_0x1096d2(0x239)]()===_0x1096d2(0x1e9)&&_0x841dd6!=='PAID'){const _0x650df2=await currencyService_1[_0x1096d2(0x1e0)][_0x1096d2(0x1c7)](_0x232640[_0x1096d2(0x1c3)],_0x232640[_0x1096d2(0x257)]),_0x4aa0f1=await this[_0x1096d2(0x1b3)](_0x49e8be['id'],_0x232640['gateway']),_0x4b83db=_0x650df2*(0x1-_0x4aa0f1/0x64);_0x2f31a9+=_0x4b83db,_0x1d9136='+'+_0x4b83db[_0x1096d2(0x1ba)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20'+_0x4aa0f1+_0x1096d2(0x22d),_0xd45e46['amountUSDT']=_0x650df2,_0xd45e46[_0x1096d2(0x26c)]=_0x4b83db,_0xd45e46[_0x1096d2(0x259)]=new Date(),console[_0x1096d2(0x276)](_0x1096d2(0x1f8)+_0x232640['amount']+'\x20'+_0x232640[_0x1096d2(0x257)]+_0x1096d2(0x1c4)+_0x650df2[_0x1096d2(0x1ba)](0x6)+_0x1096d2(0x280)),console['log']('💰\x20Gateway\x20'+_0x232640['gateway']+_0x1096d2(0x209)+_0x4aa0f1+'%'),console[_0x1096d2(0x276)](_0x1096d2(0x25a)+_0x4b83db[_0x1096d2(0x1ba)](0x6)+'\x20USDT'),console[_0x1096d2(0x276)](_0x1096d2(0x284)+_0x49e8be['balance']+_0x1096d2(0x20b)+_0x4b83db[_0x1096d2(0x1ba)](0x6)+'\x20=\x20'+_0x2f31a9[_0x1096d2(0x1ba)](0x6)+_0x1096d2(0x280));}else{if(_0x841dd6===_0x1096d2(0x1e9)&&_0x562fa7[_0x1096d2(0x239)]()!==_0x1096d2(0x1e9)){let _0x28fc73;if(_0x232640[_0x1096d2(0x26c)])_0x28fc73=_0x232640['amountAfterGatewayCommissionUSDT'];else{if(_0x232640[_0x1096d2(0x256)]){const _0x528617=await this[_0x1096d2(0x1b3)](_0x49e8be['id'],_0x232640[_0x1096d2(0x213)]);_0x28fc73=_0x232640['amountUSDT']*(0x1-_0x528617/0x64);}else console[_0x1096d2(0x276)](_0x1096d2(0x204)),_0x28fc73=0x0;}_0x28fc73>0x0&&(_0x2f31a9-=_0x28fc73,_0x1d9136='-'+_0x28fc73[_0x1096d2(0x1ba)](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0xd45e46[_0x1096d2(0x256)]=null,_0xd45e46[_0x1096d2(0x26c)]=null,_0xd45e46[_0x1096d2(0x259)]=null,console[_0x1096d2(0x276)](_0x1096d2(0x220)+_0x49e8be[_0x1096d2(0x193)]+_0x1096d2(0x23a)+_0x28fc73['toFixed'](0x6)+_0x1096d2(0x190)+_0x2f31a9[_0x1096d2(0x1ba)](0x6)+_0x1096d2(0x280)));}}if(_0x562fa7[_0x1096d2(0x239)]()===_0x1096d2(0x1cd)){const _0x22ef80=_0x518407?.[_0x1096d2(0x1a4)]||0x0;_0x22ef80>0x0&&(_0x2f31a9-=_0x22ef80,_0x1d9136+=_0x1096d2(0x282)+_0x22ef80['toFixed'](0x6)+_0x1096d2(0x1d8),_0xd45e46[_0x1096d2(0x1a4)]=_0x22ef80,console['log'](_0x1096d2(0x1f7)+_0x22ef80[_0x1096d2(0x1ba)](0x6)+_0x1096d2(0x280)),console['log'](_0x1096d2(0x19f)+_0x2f31a9[_0x1096d2(0x1ba)](0x6)+'\x20USDT'));}const _0x5c9444=await _0x35a19c[_0x1096d2(0x26e)]['update']({'where':{'id':_0x6c8bf5},'data':_0xd45e46});_0x2f31a9!==_0x49e8be[_0x1096d2(0x193)]&&(await _0x35a19c[_0x1096d2(0x286)][_0x1096d2(0x227)]({'where':{'id':_0x49e8be['id']},'data':{'balance':_0x2f31a9}}),console[_0x1096d2(0x276)](_0x1096d2(0x1de)+_0x49e8be[_0x1096d2(0x19a)]+_0x1096d2(0x270)+_0x49e8be[_0x1096d2(0x193)]['toFixed'](0x6)+'\x20->\x20'+_0x2f31a9[_0x1096d2(0x1ba)](0x6)+'\x20USDT'),console[_0x1096d2(0x276)](_0x1096d2(0x197)+_0x1d9136));await _0x35a19c[_0x1096d2(0x1eb)][_0x1096d2(0x20e)]({'data':{'paymentId':_0x6c8bf5,'shopId':_0x49e8be['id'],'event':_0x1096d2(0x223)+_0x562fa7['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x1096d2(0x260)]({'oldStatus':_0x841dd6,'newStatus':_0x562fa7[_0x1096d2(0x239)](),'balanceChange':_0x1d9136||'no\x20balance\x20change','oldBalance':_0x49e8be['balance'],'newBalance':_0x2f31a9,'amountUSDT':_0xd45e46[_0x1096d2(0x256)],'additionalData':_0x518407,'timestamp':new Date()[_0x1096d2(0x1d3)]()})}}),await this['sendShopWebhook']({..._0x232640,..._0x5c9444,'shop':_0x49e8be},_0x562fa7['toUpperCase']()),await this['sendPaymentStatusNotification']({..._0x232640,..._0x5c9444},_0x562fa7[_0x1096d2(0x239)]());if(_0x841dd6!==_0x1096d2(0x1e9)&&_0x562fa7['toUpperCase']()==='PAID'){console['log'](_0x1096d2(0x228)+_0x6c8bf5+_0x1096d2(0x234)),console[_0x1096d2(0x276)](_0x1096d2(0x215)+_0x841dd6+_0x1096d2(0x21b)+_0x562fa7['toUpperCase']()+_0x1096d2(0x201)+_0x232640[_0x1096d2(0x277)]+'\x22');if(_0x232640[_0x1096d2(0x277)])try{const _0x485351=await _0x35a19c[_0x1096d2(0x240)][_0x1096d2(0x1fe)]({'where':{'id':_0x232640['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x485351){console[_0x1096d2(0x276)](_0x1096d2(0x1b5)+_0x485351['id']+':\x20type='+_0x485351['type']+_0x1096d2(0x24a)+_0x485351['currentPayments']+_0x1096d2(0x253)+_0x485351['status']);const _0x41a63f=_0x485351[_0x1096d2(0x1e4)]+0x1,_0x385ddc=_0x485351[_0x1096d2(0x255)]===_0x1096d2(0x1e1)?_0x1096d2(0x208):_0x485351[_0x1096d2(0x23d)];await _0x35a19c['paymentLink']['update']({'where':{'id':_0x232640[_0x1096d2(0x277)]},'data':{'currentPayments':_0x41a63f,'status':_0x385ddc,'updatedAt':new Date()}}),console['log'](_0x1096d2(0x1fa)+_0x485351['id']+_0x1096d2(0x1b2)+_0x485351[_0x1096d2(0x1e4)]+_0x1096d2(0x1c4)+_0x41a63f+_0x1096d2(0x253)+_0x485351['status']+_0x1096d2(0x1c4)+_0x385ddc);}else console['log']('❌\x20Payment\x20link\x20'+_0x232640[_0x1096d2(0x277)]+'\x20not\x20found');}catch(_0x4f7636){console[_0x1096d2(0x233)](_0x1096d2(0x1be),_0x4f7636);}else console['log'](_0x1096d2(0x228)+_0x6c8bf5+_0x1096d2(0x27c));}else console[_0x1096d2(0x276)](_0x1096d2(0x228)+_0x6c8bf5+_0x1096d2(0x246)+_0x841dd6+'\x20->\x20'+_0x562fa7['toUpperCase']());});}async[a61_0x2a4edb(0x23f)](_0x1cd2ee){const _0x14ac76=a61_0x2a4edb;console[_0x14ac76(0x276)](_0x14ac76(0x1aa),_0x1cd2ee);try{const _0x1bb063=await this['plisioService'][_0x14ac76(0x283)](_0x1cd2ee);if(!_0x1bb063[_0x14ac76(0x1ea)])throw new Error(_0x14ac76(0x194));const _0x5f1668=await database_1['default'][_0x14ac76(0x26e)][_0x14ac76(0x273)]({'where':{'gatewayOrderId':_0x1bb063[_0x14ac76(0x1ea)]}});if(!_0x5f1668){console[_0x14ac76(0x233)](_0x14ac76(0x25c)+_0x1bb063[_0x14ac76(0x1ea)]);return;}console[_0x14ac76(0x276)](_0x14ac76(0x1b6)+_0x5f1668['id']+'\x20status\x20'+_0x1bb063['status']),await this[_0x14ac76(0x22e)](_0x5f1668['id'],_0x1bb063[_0x14ac76(0x23d)],{'txUrls':_0x1bb063[_0x14ac76(0x24e)]}),loggerService_1[_0x14ac76(0x20f)][_0x14ac76(0x272)](_0x14ac76(0x1e3),_0x5f1668['id'],_0x5f1668[_0x14ac76(0x23d)],_0x1bb063['status'],_0x1cd2ee);}catch(_0x573016){console['error'](_0x14ac76(0x1ae),_0x573016),loggerService_1[_0x14ac76(0x20f)]['logWebhookError'](_0x14ac76(0x1e3),_0x573016,_0x1cd2ee);throw _0x573016;}}async['processPlisioGatewayWebhook'](_0x1bf729){const _0x5473a1=a61_0x2a4edb;console[_0x5473a1(0x276)](_0x5473a1(0x224),_0x1bf729);try{const _0x25f7cb=await this[_0x5473a1(0x19b)][_0x5473a1(0x283)](_0x1bf729);if(!_0x25f7cb[_0x5473a1(0x1ea)])throw new Error(_0x5473a1(0x1a1));const _0x48aaf1=await database_1[_0x5473a1(0x1cb)][_0x5473a1(0x26e)][_0x5473a1(0x273)]({'where':{'gatewayOrderId':_0x25f7cb[_0x5473a1(0x1ea)]}});if(!_0x48aaf1){console[_0x5473a1(0x233)](_0x5473a1(0x1db)+_0x25f7cb['paymentId']);return;}console[_0x5473a1(0x276)](_0x5473a1(0x249)+_0x48aaf1['id']+'\x20status\x20'+_0x25f7cb[_0x5473a1(0x23d)]),await this[_0x5473a1(0x22e)](_0x48aaf1['id'],_0x25f7cb[_0x5473a1(0x23d)],{'txUrls':_0x25f7cb[_0x5473a1(0x24e)]}),loggerService_1[_0x5473a1(0x20f)][_0x5473a1(0x272)](_0x5473a1(0x205),_0x48aaf1['id'],_0x48aaf1[_0x5473a1(0x23d)],_0x25f7cb[_0x5473a1(0x23d)],_0x1bf729);}catch(_0x32e062){console[_0x5473a1(0x233)](_0x5473a1(0x27d),_0x32e062),loggerService_1[_0x5473a1(0x20f)][_0x5473a1(0x1a0)](_0x5473a1(0x205),_0x32e062,_0x1bf729);throw _0x32e062;}}async[a61_0x2a4edb(0x26d)](_0x2bf325){const _0x49cfdd=a61_0x2a4edb;console[_0x49cfdd(0x276)]('🔄\x20Processing\x20Rapyd\x20webhook:',_0x2bf325);try{const _0x8f117a=await this[_0x49cfdd(0x1bd)][_0x49cfdd(0x283)](_0x2bf325);if(!_0x8f117a[_0x49cfdd(0x1ea)])throw new Error(_0x49cfdd(0x254));const _0xd95e13=await database_1[_0x49cfdd(0x1cb)][_0x49cfdd(0x26e)][_0x49cfdd(0x273)]({'where':{'gatewayOrderId':_0x8f117a['paymentId']}});if(!_0xd95e13){console['error'](_0x49cfdd(0x248)+_0x8f117a[_0x49cfdd(0x1ea)]);return;}console['log']('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0xd95e13['id']+_0x49cfdd(0x1da)+_0x8f117a[_0x49cfdd(0x23d)]),await this[_0x49cfdd(0x22e)](_0xd95e13['id'],_0x8f117a['status'],{'failureMessage':_0x8f117a[_0x49cfdd(0x1b4)],'cardLast4':_0x8f117a['additionalInfo']?.[_0x49cfdd(0x1e6)],'paymentMethod':_0x8f117a['additionalInfo']?.[_0x49cfdd(0x1dd)]}),loggerService_1['loggerService'][_0x49cfdd(0x272)](_0x49cfdd(0x25e),_0xd95e13['id'],_0xd95e13[_0x49cfdd(0x23d)],_0x8f117a[_0x49cfdd(0x23d)],_0x2bf325);}catch(_0x3fbf5d){console[_0x49cfdd(0x233)](_0x49cfdd(0x1c9),_0x3fbf5d),loggerService_1['loggerService'][_0x49cfdd(0x1a0)](_0x49cfdd(0x25e),_0x3fbf5d,_0x2bf325);throw _0x3fbf5d;}}async[a61_0x2a4edb(0x202)](_0x299c97){const _0x54bbe0=a61_0x2a4edb;console[_0x54bbe0(0x276)](_0x54bbe0(0x26b),_0x299c97);try{const _0x282b6b=await this[_0x54bbe0(0x1a7)][_0x54bbe0(0x283)](_0x299c97);if(!_0x282b6b[_0x54bbe0(0x1ea)])throw new Error(_0x54bbe0(0x225));const _0x2c9bbb=await database_1[_0x54bbe0(0x1cb)]['payment'][_0x54bbe0(0x273)]({'where':{'gatewayOrderId':_0x282b6b[_0x54bbe0(0x1ea)]}});if(!_0x2c9bbb){console[_0x54bbe0(0x233)](_0x54bbe0(0x203)+_0x282b6b['paymentId']);return;}console['log'](_0x54bbe0(0x269)+_0x2c9bbb['id']+_0x54bbe0(0x1da)+_0x282b6b[_0x54bbe0(0x23d)]),await this[_0x54bbe0(0x22e)](_0x2c9bbb['id'],_0x282b6b[_0x54bbe0(0x23d)],{'bankId':_0x282b6b['additionalInfo']?.['bankId'],'remitterIban':_0x282b6b[_0x54bbe0(0x216)]?.[_0x54bbe0(0x1b1)],'remitterName':_0x282b6b['additionalInfo']?.[_0x54bbe0(0x1af)]}),loggerService_1['loggerService'][_0x54bbe0(0x272)](_0x54bbe0(0x23c),_0x2c9bbb['id'],_0x2c9bbb['status'],_0x282b6b['status'],_0x299c97);}catch(_0x4c40e1){console[_0x54bbe0(0x233)]('Error\x20processing\x20Noda\x20webhook:',_0x4c40e1),loggerService_1['loggerService']['logWebhookError'](_0x54bbe0(0x23c),_0x4c40e1,_0x299c97);throw _0x4c40e1;}}async[a61_0x2a4edb(0x1d4)](_0x2038b6){const _0x3699d0=a61_0x2a4edb;console[_0x3699d0(0x276)](_0x3699d0(0x242),_0x2038b6);try{const _0x189d12=await this['coinToPayService'][_0x3699d0(0x283)](_0x2038b6);if(!_0x189d12['paymentId'])throw new Error(_0x3699d0(0x230));const _0x4bf94b=await database_1[_0x3699d0(0x1cb)][_0x3699d0(0x26e)][_0x3699d0(0x273)]({'where':{'gatewayOrderId':_0x189d12[_0x3699d0(0x1ea)]}});if(!_0x4bf94b){console[_0x3699d0(0x233)](_0x3699d0(0x23e)+_0x189d12[_0x3699d0(0x1ea)]);return;}console['log']('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x4bf94b['id']+'\x20status\x20'+_0x189d12[_0x3699d0(0x23d)]),await this[_0x3699d0(0x22e)](_0x4bf94b['id'],_0x189d12[_0x3699d0(0x23d)]),loggerService_1[_0x3699d0(0x20f)][_0x3699d0(0x272)](_0x3699d0(0x1a9),_0x4bf94b['id'],_0x4bf94b[_0x3699d0(0x23d)],_0x189d12['status'],_0x2038b6);}catch(_0x800ea5){console[_0x3699d0(0x233)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x800ea5),loggerService_1[_0x3699d0(0x20f)][_0x3699d0(0x1a0)]('cointopay',_0x800ea5,_0x2038b6);throw _0x800ea5;}}async[a61_0x2a4edb(0x1d0)](_0xf59d3e){const _0x4b054f=a61_0x2a4edb;console[_0x4b054f(0x276)](_0x4b054f(0x22c),_0xf59d3e);try{const _0x1fe613=await this[_0x4b054f(0x1ec)][_0x4b054f(0x283)](_0xf59d3e);if(!_0x1fe613[_0x4b054f(0x1ea)])throw new Error(_0x4b054f(0x20d));const _0x1a845a=await database_1[_0x4b054f(0x1cb)][_0x4b054f(0x26e)][_0x4b054f(0x273)]({'where':{'gatewayOrderId':_0x1fe613[_0x4b054f(0x1ea)]}});if(!_0x1a845a){console['error'](_0x4b054f(0x243)+_0x1fe613[_0x4b054f(0x1ea)]);return;}console['log']('📊\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x1a845a['id']+'\x20status\x20'+_0x1fe613[_0x4b054f(0x23d)]),await this['updatePaymentStatus'](_0x1a845a['id'],_0x1fe613['status']),loggerService_1[_0x4b054f(0x20f)]['logWebhookProcessed'](_0x4b054f(0x219),_0x1a845a['id'],_0x1a845a[_0x4b054f(0x23d)],_0x1fe613[_0x4b054f(0x23d)],_0xf59d3e);}catch(_0x1d33da){console['error'](_0x4b054f(0x285),_0x1d33da),loggerService_1[_0x4b054f(0x20f)]['logWebhookError'](_0x4b054f(0x219),_0x1d33da,_0xf59d3e);throw _0x1d33da;}}async[a61_0x2a4edb(0x1ca)](_0x5e5353){const _0x5e7202=a61_0x2a4edb;console[_0x5e7202(0x276)]('🔄\x20Processing\x20KLYME\x20webhook:',_0x5e5353);try{const _0x3d69cb=await this[_0x5e7202(0x1b9)][_0x5e7202(0x283)](_0x5e5353);if(!_0x3d69cb[_0x5e7202(0x1ea)])throw new Error(_0x5e7202(0x267));const _0x4b2a36=await database_1[_0x5e7202(0x1cb)][_0x5e7202(0x26e)][_0x5e7202(0x273)]({'where':{'gatewayOrderId':_0x3d69cb[_0x5e7202(0x1ea)]}});if(!_0x4b2a36){console[_0x5e7202(0x233)](_0x5e7202(0x25d)+_0x3d69cb[_0x5e7202(0x1ea)]);return;}console[_0x5e7202(0x276)](_0x5e7202(0x262)+_0x4b2a36['id']+_0x5e7202(0x1da)+_0x3d69cb[_0x5e7202(0x23d)]),await this[_0x5e7202(0x22e)](_0x4b2a36['id'],_0x3d69cb['status'],{'paymentMethod':_0x3d69cb[_0x5e7202(0x216)]?.[_0x5e7202(0x1c2)]}),loggerService_1[_0x5e7202(0x20f)][_0x5e7202(0x272)](_0x5e7202(0x1ee),_0x4b2a36['id'],_0x4b2a36[_0x5e7202(0x23d)],_0x3d69cb[_0x5e7202(0x23d)],_0x5e5353);}catch(_0x207535){console['error'](_0x5e7202(0x245),_0x207535),loggerService_1[_0x5e7202(0x20f)][_0x5e7202(0x1a0)](_0x5e7202(0x1ee),_0x207535,_0x5e5353);throw _0x207535;}}async[a61_0x2a4edb(0x196)](_0x31b9e7){const _0x146d5e=a61_0x2a4edb;console[_0x146d5e(0x276)]('🔄\x20Processing\x20MasterCard\x20webhook:',JSON[_0x146d5e(0x260)](_0x31b9e7,null,0x2));try{const _0x45cd38=await this['masterCardService']['processWebhook'](_0x31b9e7);console[_0x146d5e(0x276)](_0x146d5e(0x21c),_0x45cd38);if(!_0x45cd38[_0x146d5e(0x1ea)]){console['error'](_0x146d5e(0x1c1)),console['error'](_0x146d5e(0x1bb),Object[_0x146d5e(0x1fb)](_0x31b9e7));throw new Error(_0x146d5e(0x207));}let _0x53a694=null;console[_0x146d5e(0x276)]('🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x45cd38['paymentId']);_0x45cd38[_0x146d5e(0x1ea)]&&(console[_0x146d5e(0x276)]('🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x53a694=await database_1[_0x146d5e(0x1cb)][_0x146d5e(0x26e)][_0x146d5e(0x273)]({'where':{'AND':[{'gateway':_0x146d5e(0x251)},{'OR':[{'gatewayPaymentId':_0x45cd38[_0x146d5e(0x1ea)]},{'gatewayOrderId':_0x45cd38[_0x146d5e(0x1ea)]},{'id':_0x45cd38[_0x146d5e(0x1ea)]},{'orderId':_0x45cd38[_0x146d5e(0x1ea)]}]}]}}),console['log'](_0x146d5e(0x21e)+(_0x53a694?'Found\x20payment\x20'+_0x53a694['id']:'Payment\x20not\x20found')));if(!_0x53a694){console[_0x146d5e(0x233)](_0x146d5e(0x236)+_0x45cd38[_0x146d5e(0x1ea)]),console[_0x146d5e(0x233)](_0x146d5e(0x22b)+_0x45cd38[_0x146d5e(0x1ea)]+'\x22,\x20id=\x22'+_0x45cd38['paymentId']+_0x146d5e(0x1b8)+_0x45cd38['paymentId']+'\x22');const _0x47cd75=await database_1[_0x146d5e(0x1cb)][_0x146d5e(0x26e)][_0x146d5e(0x1ce)]({'where':{'gateway':_0x146d5e(0x251)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x146d5e(0x276)]('🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:',_0x47cd75);return;}console[_0x146d5e(0x276)](_0x146d5e(0x218)+_0x53a694['id']+_0x146d5e(0x1ed)+_0x53a694[_0x146d5e(0x23d)]+_0x146d5e(0x1ab)+_0x45cd38[_0x146d5e(0x23d)]),await this[_0x146d5e(0x22e)](_0x53a694['id'],_0x45cd38[_0x146d5e(0x23d)]),loggerService_1[_0x146d5e(0x20f)][_0x146d5e(0x272)](_0x146d5e(0x251),_0x53a694['id'],_0x53a694[_0x146d5e(0x23d)],_0x45cd38[_0x146d5e(0x23d)],_0x31b9e7);}catch(_0x537988){console[_0x146d5e(0x233)](_0x146d5e(0x21a),_0x537988),loggerService_1[_0x146d5e(0x20f)][_0x146d5e(0x1a0)]('mastercard',_0x537988,_0x31b9e7);throw _0x537988;}}async[a61_0x2a4edb(0x19c)](_0x1114ba){const _0x2f06a3=a61_0x2a4edb;console[_0x2f06a3(0x276)]('🔄\x20Processing\x20Amer\x20webhook:',JSON['stringify'](_0x1114ba,null,0x2));try{const _0x355fad=await this['amerService']['processWebhook'](_0x1114ba);console[_0x2f06a3(0x276)](_0x2f06a3(0x1f2),_0x355fad);if(!_0x355fad[_0x2f06a3(0x1ea)]){console[_0x2f06a3(0x233)](_0x2f06a3(0x24f)),console[_0x2f06a3(0x233)](_0x2f06a3(0x1bb),Object[_0x2f06a3(0x1fb)](_0x1114ba));throw new Error(_0x2f06a3(0x1d6));}let _0x1bcef6=null;console[_0x2f06a3(0x276)](_0x2f06a3(0x1c0)+_0x355fad[_0x2f06a3(0x1ea)]),_0x1bcef6=await database_1[_0x2f06a3(0x1cb)][_0x2f06a3(0x26e)][_0x2f06a3(0x273)]({'where':{'AND':[{'gateway':_0x2f06a3(0x250)},{'OR':[{'gatewayPaymentId':_0x355fad[_0x2f06a3(0x1ea)]},{'gatewayOrderId':_0x355fad[_0x2f06a3(0x1ea)]},{'id':_0x355fad['paymentId']},{'orderId':_0x355fad['paymentId']}]}]}}),console['log'](_0x2f06a3(0x21e)+(_0x1bcef6?'Found\x20payment\x20'+_0x1bcef6['id']:_0x2f06a3(0x1d9)));if(!_0x1bcef6){console['error'](_0x2f06a3(0x266)+_0x355fad['paymentId']);return;}console[_0x2f06a3(0x276)](_0x2f06a3(0x200)+_0x1bcef6['id']+_0x2f06a3(0x1da)+_0x355fad[_0x2f06a3(0x23d)]),await this['updatePaymentStatus'](_0x1bcef6['id'],_0x355fad[_0x2f06a3(0x23d)],{'cardLast4':_0x355fad[_0x2f06a3(0x216)]?.[_0x2f06a3(0x1e6)],'paymentMethod':_0x355fad['additionalInfo']?.['paymentMethod']});}catch(_0x348cb7){console[_0x2f06a3(0x233)](_0x2f06a3(0x211),_0x348cb7),loggerService_1[_0x2f06a3(0x20f)][_0x2f06a3(0x1a0)](_0x2f06a3(0x250),_0x348cb7,_0x1114ba);throw _0x348cb7;}}async[a61_0x2a4edb(0x1f6)](_0x563d10,_0x19e25f){const _0x27b798=a61_0x2a4edb,_0x172a09=Date[_0x27b798(0x25b)]();try{const _0x117b89=_0x563d10[_0x27b798(0x286)],_0x22386b=_0x117b89[_0x27b798(0x1c5)];if(!_0x22386b?.['webhookUrl']){console['log'](_0x27b798(0x252)+_0x117b89['id']);return;}const _0x38c8c5=_0x19e25f==='PAID'?_0x27b798(0x1fc):_0x19e25f===_0x27b798(0x214)?_0x27b798(0x1ac):_0x19e25f==='EXPIRED'?_0x27b798(0x1ac):_0x19e25f===_0x27b798(0x1cd)?_0x27b798(0x1ac):_0x19e25f==='REFUND'?_0x27b798(0x1ac):'payment.pending';let _0x59c189=[];if(_0x22386b[_0x27b798(0x19d)])try{_0x59c189=Array[_0x27b798(0x1f4)](_0x22386b['webhookEvents'])?_0x22386b[_0x27b798(0x19d)]:JSON['parse'](_0x22386b['webhookEvents']);}catch(_0x12c9d2){console['error'](_0x27b798(0x222),_0x12c9d2),_0x59c189=[];}if(!_0x59c189[_0x27b798(0x231)](_0x38c8c5)){console[_0x27b798(0x276)](_0x27b798(0x265)+_0x38c8c5+_0x27b798(0x23b)+_0x117b89['id']);return;}const _0x31ab56={'event':_0x38c8c5,'payment':{'id':_0x563d10['id'],'order_id':_0x563d10[_0x27b798(0x1df)],'gateway_order_id':_0x563d10[_0x27b798(0x1e5)],'gateway':_0x563d10[_0x27b798(0x213)],'amount':_0x563d10[_0x27b798(0x1c3)],'currency':_0x563d10[_0x27b798(0x257)],'status':_0x19e25f[_0x27b798(0x192)](),'customer_email':_0x563d10['customerEmail'],'customer_name':_0x563d10['customerName'],'failure_message':_0x563d10[_0x27b798(0x1b4)],'tx_urls':_0x563d10[_0x27b798(0x24e)]?JSON[_0x27b798(0x1a3)](_0x563d10[_0x27b798(0x24e)]):null,'created_at':_0x563d10[_0x27b798(0x235)],'updated_at':_0x563d10['updatedAt']}},_0x12cf2a=await fetch(_0x22386b['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x27b798(0x27e),'User-Agent':_0x27b798(0x195)},'body':JSON[_0x27b798(0x260)](_0x31ab56)}),_0x1e0628=Date[_0x27b798(0x25b)]()-_0x172a09,_0x5a959b=_0x12cf2a['ok']?'Success':await _0x12cf2a[_0x27b798(0x275)]();loggerService_1[_0x27b798(0x20f)][_0x27b798(0x1a5)](_0x563d10[_0x27b798(0x1f5)],_0x22386b[_0x27b798(0x199)],_0x38c8c5,_0x12cf2a[_0x27b798(0x23d)],_0x1e0628,_0x31ab56),console[_0x27b798(0x276)](_0x27b798(0x22a)+_0x22386b[_0x27b798(0x199)]+_0x27b798(0x244)+_0x12cf2a['status']+'\x20('+_0x1e0628+_0x27b798(0x1f3));}catch(_0x225e25){console[_0x27b798(0x233)](_0x27b798(0x241),_0x225e25),loggerService_1[_0x27b798(0x20f)][_0x27b798(0x217)](_0x563d10[_0x27b798(0x1f5)],_0x563d10['shop']?.[_0x27b798(0x1c5)]?.[_0x27b798(0x199)]||_0x27b798(0x25f),_0x27b798(0x26f),_0x225e25,{});}}async[a61_0x2a4edb(0x24d)](_0x331dd5,_0x52b812){const _0x268eff=a61_0x2a4edb;try{const _0x1baae1={'PENDING':_0x268eff(0x279),'PROCESSING':'processing','PAID':_0x268eff(0x26a),'FAILED':_0x268eff(0x1bc),'EXPIRED':_0x268eff(0x1a6),'REFUND':_0x268eff(0x191),'CHARGEBACK':'chargeback'},_0x4e7cad=_0x1baae1[_0x52b812];if(!_0x4e7cad||_0x4e7cad==='created')return;await telegramBotService_1[_0x268eff(0x1ad)][_0x268eff(0x1bf)](_0x331dd5[_0x268eff(0x1f5)],_0x331dd5,_0x4e7cad);}catch(_0x58c8bd){console[_0x268eff(0x233)](_0x268eff(0x1f9),_0x58c8bd);}}async[a61_0x2a4edb(0x1b3)](_0x3d9c9a,_0x5ee9dc){const _0x1490b7=a61_0x2a4edb;try{const _0x1953a2=await database_1[_0x1490b7(0x1cb)][_0x1490b7(0x286)][_0x1490b7(0x1fe)]({'where':{'id':_0x3d9c9a},'select':{'gatewaySettings':!![]}});if(!_0x1953a2?.['gatewaySettings'])return console[_0x1490b7(0x276)](_0x1490b7(0x1f1)+_0x3d9c9a+_0x1490b7(0x1cc)),0xa;const _0x2deab1=JSON[_0x1490b7(0x1a3)](_0x1953a2[_0x1490b7(0x24b)]);for(const [_0x2038a1,_0x8cc21]of Object['entries'](_0x2deab1)){if(_0x2038a1[_0x1490b7(0x192)]()===_0x5ee9dc[_0x1490b7(0x192)]()){const _0x1617ac=_0x8cc21[_0x1490b7(0x237)]||0xa;return console[_0x1490b7(0x276)](_0x1490b7(0x1a8)+_0x5ee9dc+_0x1490b7(0x264)+_0x3d9c9a+':\x20'+_0x1617ac+'%'),_0x1617ac;}}return console[_0x1490b7(0x276)](_0x1490b7(0x19e)+_0x5ee9dc+_0x1490b7(0x1e7)+_0x3d9c9a+_0x1490b7(0x206)),0xa;}catch(_0x5ddd0f){return console[_0x1490b7(0x233)](_0x1490b7(0x1e8)+_0x3d9c9a+_0x1490b7(0x1d1)+_0x5ee9dc+':',_0x5ddd0f),0xa;}}}exports[a61_0x2a4edb(0x229)]=WebhookService;