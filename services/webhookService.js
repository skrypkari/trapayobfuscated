'use strict';const a69_0x5e4c3a=a69_0x4f97;(function(_0x68ea2b,_0x5823fa){const _0x5a59af=a69_0x4f97,_0x37fea8=_0x68ea2b();while(!![]){try{const _0x17b172=-parseInt(_0x5a59af(0x2a0))/0x1*(-parseInt(_0x5a59af(0x2af))/0x2)+-parseInt(_0x5a59af(0x21c))/0x3+parseInt(_0x5a59af(0x252))/0x4*(parseInt(_0x5a59af(0x275))/0x5)+-parseInt(_0x5a59af(0x253))/0x6*(parseInt(_0x5a59af(0x17a))/0x7)+parseInt(_0x5a59af(0x201))/0x8*(parseInt(_0x5a59af(0x27d))/0x9)+parseInt(_0x5a59af(0x2b2))/0xa+-parseInt(_0x5a59af(0x1f1))/0xb*(parseInt(_0x5a59af(0x1a4))/0xc);if(_0x17b172===_0x5823fa)break;else _0x37fea8['push'](_0x37fea8['shift']());}catch(_0x2e3d25){_0x37fea8['push'](_0x37fea8['shift']());}}}(a69_0x1f93,0x23c23));function a69_0x4f97(_0x102c0f,_0x151813){const _0x1f93bb=a69_0x1f93();return a69_0x4f97=function(_0x4f97ba,_0x12d0bf){_0x4f97ba=_0x4f97ba-0x15b;let _0x1ad6f1=_0x1f93bb[_0x4f97ba];return _0x1ad6f1;},a69_0x4f97(_0x102c0f,_0x151813);}var __importDefault=this&&this[a69_0x5e4c3a(0x179)]||function(_0x434f92){const _0x441e11=a69_0x5e4c3a;return _0x434f92&&_0x434f92[_0x441e11(0x203)]?_0x434f92:{'default':_0x434f92};};Object['defineProperty'](exports,a69_0x5e4c3a(0x203),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a69_0x5e4c3a(0x18c))),plisioService_1=require(a69_0x5e4c3a(0x259)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a69_0x5e4c3a(0x22b)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a69_0x5e4c3a(0x279)),klymeService_1=require(a69_0x5e4c3a(0x2ae)),mastercardService_1=require(a69_0x5e4c3a(0x211)),amerService_1=require(a69_0x5e4c3a(0x1f9)),ampayService_1=require(a69_0x5e4c3a(0x17c)),ampayTRYService_1=require('./gateways/ampayTRYService'),telegramBotService_1=require(a69_0x5e4c3a(0x254)),currencyService_1=require(a69_0x5e4c3a(0x207)),loggerService_1=require(a69_0x5e4c3a(0x1b5));class WebhookService{constructor(){const _0x1d8a04=a69_0x5e4c3a;this[_0x1d8a04(0x20a)]=new plisioService_1[(_0x1d8a04(0x1af))](),this[_0x1d8a04(0x1eb)]=new rapydService_1[(_0x1d8a04(0x1ea))](),this[_0x1d8a04(0x1e8)]=new nodaService_1[(_0x1d8a04(0x24c))](),this[_0x1d8a04(0x1c3)]=new coinToPayService_1[(_0x1d8a04(0x15d))](),this[_0x1d8a04(0x171)]=new coinToPay2Service_1[(_0x1d8a04(0x25c))](),this[_0x1d8a04(0x264)]=new klymeService_1[(_0x1d8a04(0x1e0))](),this[_0x1d8a04(0x212)]=new mastercardService_1['VisaMasterCardService'](),this[_0x1d8a04(0x1b2)]=new amerService_1[(_0x1d8a04(0x248))](),this[_0x1d8a04(0x178)]=new ampayService_1[(_0x1d8a04(0x1ff))](),this['ampayTRYService']=new ampayTRYService_1[(_0x1d8a04(0x170))]();}async[a69_0x5e4c3a(0x168)](_0x418f15,_0x235d7d,_0x4e0043){const _0x3b5b42=a69_0x5e4c3a;console['log']('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x418f15+_0x3b5b42(0x227)+_0x235d7d),console[_0x3b5b42(0x245)](_0x3b5b42(0x176),_0x4e0043),await database_1[_0x3b5b42(0x1f3)]['$transaction'](async _0x2fde5e=>{const _0x4d233b=_0x3b5b42,_0x4ce805=await _0x2fde5e['payment'][_0x4d233b(0x1cb)]({'where':{'id':_0x418f15},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4ce805)throw new Error(_0x4d233b(0x249)+_0x418f15+_0x4d233b(0x272));const _0x5557c0=_0x4ce805[_0x4d233b(0x177)],_0x473b20=_0x4ce805[_0x4d233b(0x18b)];console[_0x4d233b(0x245)]('💰\x20Payment\x20'+_0x418f15+':\x20'+_0x5557c0+'\x20->\x20'+_0x235d7d),console[_0x4d233b(0x245)](_0x4d233b(0x1bd)+_0x473b20[_0x4d233b(0x28c)]+_0x4d233b(0x181)+_0x473b20[_0x4d233b(0x2ab)]+_0x4d233b(0x191));const _0x6502d7={'status':_0x235d7d[_0x4d233b(0x174)](),'updatedAt':new Date(),'statusChangedBy':_0x4d233b(0x289),'statusChangedAt':new Date()};_0x4e0043?.[_0x4d233b(0x19b)]&&(_0x6502d7[_0x4d233b(0x19b)]=_0x4e0043['failureMessage']);_0x4e0043?.['txUrls']&&(_0x6502d7[_0x4d233b(0x26c)]=JSON[_0x4d233b(0x173)](_0x4e0043[_0x4d233b(0x26c)]));_0x4e0043?.['cardLast4']&&(_0x6502d7[_0x4d233b(0x16c)]=_0x4e0043['cardLast4']);_0x4e0043?.['paymentMethod']&&(_0x6502d7[_0x4d233b(0x162)]=_0x4e0043['paymentMethod']);_0x4e0043?.[_0x4d233b(0x293)]&&(_0x6502d7['bankId']=_0x4e0043[_0x4d233b(0x293)]);_0x4e0043?.[_0x4d233b(0x24f)]&&(_0x6502d7[_0x4d233b(0x24f)]=_0x4e0043[_0x4d233b(0x24f)]);_0x4e0043?.[_0x4d233b(0x243)]&&(_0x6502d7['remitterName']=_0x4e0043['remitterName']);let _0x341b46=_0x473b20['balance'],_0x55794f='';if(_0x235d7d['toUpperCase']()===_0x4d233b(0x1b9)&&_0x5557c0!==_0x4d233b(0x1b9)){const _0x21dcd5=await currencyService_1[_0x4d233b(0x288)][_0x4d233b(0x193)](_0x4ce805['amount'],_0x4ce805[_0x4d233b(0x165)]),_0x6fe905=await this[_0x4d233b(0x244)](_0x473b20['id'],_0x4ce805['gateway']),_0x58df48=_0x21dcd5*(0x1-_0x6fe905/0x64);_0x341b46+=_0x58df48,_0x55794f='+'+_0x58df48['toFixed'](0x6)+_0x4d233b(0x1b1)+_0x6fe905+_0x4d233b(0x228),_0x6502d7[_0x4d233b(0x29e)]=_0x21dcd5,_0x6502d7['amountAfterGatewayCommissionUSDT']=_0x58df48,_0x6502d7[_0x4d233b(0x208)]=_0x6fe905,_0x6502d7['paidAt']=new Date(),console[_0x4d233b(0x245)]('💰\x20Converting\x20'+_0x4ce805[_0x4d233b(0x18d)]+'\x20'+_0x4ce805['currency']+_0x4d233b(0x19d)+_0x21dcd5[_0x4d233b(0x1d8)](0x6)+'\x20USDT'),console[_0x4d233b(0x245)]('💰\x20Gateway\x20'+_0x4ce805[_0x4d233b(0x1ce)]+_0x4d233b(0x270)+_0x6fe905+'%'),console[_0x4d233b(0x245)](_0x4d233b(0x213)+_0x58df48[_0x4d233b(0x1d8)](0x6)+_0x4d233b(0x191)),console[_0x4d233b(0x245)](_0x4d233b(0x22c)+_0x473b20[_0x4d233b(0x2ab)]+_0x4d233b(0x26e)+_0x58df48['toFixed'](0x6)+_0x4d233b(0x222)+_0x341b46[_0x4d233b(0x1d8)](0x6)+_0x4d233b(0x191));}else{if(_0x5557c0===_0x4d233b(0x1b9)&&_0x235d7d[_0x4d233b(0x174)]()!=='PAID'&&_0x235d7d[_0x4d233b(0x174)]()!=='CHARGEBACK'){let _0x14bfc8;if(_0x4ce805['amountAfterGatewayCommissionUSDT'])_0x14bfc8=_0x4ce805[_0x4d233b(0x2a3)];else{if(_0x4ce805['amountUSDT']){const _0x4d8923=await this['getGatewayCommission'](_0x473b20['id'],_0x4ce805[_0x4d233b(0x1ce)]);_0x14bfc8=_0x4ce805[_0x4d233b(0x29e)]*(0x1-_0x4d8923/0x64);}else console[_0x4d233b(0x245)](_0x4d233b(0x1d4)),_0x14bfc8=0x0;}_0x14bfc8>0x0&&(_0x341b46-=_0x14bfc8,_0x55794f='-'+_0x14bfc8[_0x4d233b(0x1d8)](0x6)+_0x4d233b(0x186),_0x6502d7['paidAt']=null,console[_0x4d233b(0x245)](_0x4d233b(0x210)+_0x473b20[_0x4d233b(0x2ab)]+_0x4d233b(0x1bb)+_0x14bfc8[_0x4d233b(0x1d8)](0x6)+_0x4d233b(0x222)+_0x341b46[_0x4d233b(0x1d8)](0x6)+_0x4d233b(0x191)));}}if(_0x235d7d[_0x4d233b(0x174)]()===_0x4d233b(0x189)){const _0x4bcadc=_0x4e0043?.[_0x4d233b(0x278)]||0x0;console[_0x4d233b(0x245)](_0x4d233b(0x184)),_0x4bcadc>0x0?(_0x341b46-=_0x4bcadc,_0x55794f='-'+_0x4bcadc[_0x4d233b(0x1d8)](0x6)+_0x4d233b(0x1bc),_0x6502d7[_0x4d233b(0x278)]=_0x4bcadc,console['log'](_0x4d233b(0x1df)+_0x4bcadc[_0x4d233b(0x1d8)](0x6)+_0x4d233b(0x191)),console[_0x4d233b(0x245)](_0x4d233b(0x260)),console[_0x4d233b(0x245)](_0x4d233b(0x18e)+_0x341b46[_0x4d233b(0x1d8)](0x6)+_0x4d233b(0x191))):(console[_0x4d233b(0x245)]('⚠️\x20CHARGEBACK\x20without\x20penalty\x20amount\x20-\x20no\x20balance\x20change'),_0x55794f='Payment\x20marked\x20as\x20CHARGEBACK\x20(no\x20penalty\x20specified)');}const _0x285682=await _0x2fde5e[_0x4d233b(0x267)][_0x4d233b(0x2ad)]({'where':{'id':_0x418f15},'data':_0x6502d7});_0x341b46!==_0x473b20[_0x4d233b(0x2ab)]&&(await _0x2fde5e['shop'][_0x4d233b(0x2ad)]({'where':{'id':_0x473b20['id']},'data':{'balance':_0x341b46}}),console['log'](_0x4d233b(0x256)+_0x473b20[_0x4d233b(0x28c)]+_0x4d233b(0x271)+_0x473b20[_0x4d233b(0x2ab)][_0x4d233b(0x1d8)](0x6)+_0x4d233b(0x19d)+_0x341b46[_0x4d233b(0x1d8)](0x6)+_0x4d233b(0x191)),console[_0x4d233b(0x245)](_0x4d233b(0x15e)+_0x55794f));await _0x2fde5e[_0x4d233b(0x229)][_0x4d233b(0x1c5)]({'data':{'paymentId':_0x418f15,'shopId':_0x473b20['id'],'event':_0x4d233b(0x294)+_0x235d7d[_0x4d233b(0x24e)](),'statusCode':0xc8,'responseBody':JSON[_0x4d233b(0x173)]({'oldStatus':_0x5557c0,'newStatus':_0x235d7d[_0x4d233b(0x174)](),'balanceChange':_0x55794f||_0x4d233b(0x224),'oldBalance':_0x473b20[_0x4d233b(0x2ab)],'newBalance':_0x341b46,'amountUSDT':_0x6502d7['amountUSDT'],'additionalData':_0x4e0043,'timestamp':new Date()[_0x4d233b(0x215)]()})}}),await this['sendShopWebhook']({..._0x4ce805,..._0x285682,'shop':_0x473b20},_0x235d7d['toUpperCase']()),await this['sendPaymentStatusNotification']({..._0x4ce805,..._0x285682},_0x235d7d[_0x4d233b(0x174)]());if(_0x5557c0!=='PAID'&&_0x235d7d[_0x4d233b(0x174)]()===_0x4d233b(0x1b9)){console['log'](_0x4d233b(0x1f2)+_0x418f15+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console[_0x4d233b(0x245)](_0x4d233b(0x1f4)+_0x5557c0+_0x4d233b(0x1f0)+_0x235d7d[_0x4d233b(0x174)]()+_0x4d233b(0x1ab)+_0x4ce805[_0x4d233b(0x27e)]+'\x22');if(_0x4ce805['paymentLinkId'])try{const _0x1d49ea=await _0x2fde5e[_0x4d233b(0x237)][_0x4d233b(0x1cb)]({'where':{'id':_0x4ce805[_0x4d233b(0x27e)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1d49ea){console[_0x4d233b(0x245)]('📈\x20Found\x20payment\x20link\x20'+_0x1d49ea['id']+_0x4d233b(0x1e3)+_0x1d49ea['type']+_0x4d233b(0x26b)+_0x1d49ea[_0x4d233b(0x1b8)]+_0x4d233b(0x265)+_0x1d49ea[_0x4d233b(0x177)]);const _0x575bba=_0x1d49ea['currentPayments']+0x1,_0x3224bb=_0x1d49ea['type']===_0x4d233b(0x27b)?'COMPLETED':_0x1d49ea[_0x4d233b(0x177)];await _0x2fde5e[_0x4d233b(0x237)][_0x4d233b(0x2ad)]({'where':{'id':_0x4ce805[_0x4d233b(0x27e)]},'data':{'currentPayments':_0x575bba,'status':_0x3224bb,'updatedAt':new Date()}}),console[_0x4d233b(0x245)](_0x4d233b(0x15b)+_0x1d49ea['id']+_0x4d233b(0x2a5)+_0x1d49ea[_0x4d233b(0x1b8)]+'\x20->\x20'+_0x575bba+',\x20status='+_0x1d49ea['status']+'\x20->\x20'+_0x3224bb);}else console[_0x4d233b(0x245)](_0x4d233b(0x1ba)+_0x4ce805[_0x4d233b(0x27e)]+_0x4d233b(0x272));}catch(_0x5bc345){console[_0x4d233b(0x24b)](_0x4d233b(0x23c),_0x5bc345);}else console[_0x4d233b(0x245)](_0x4d233b(0x1f2)+_0x418f15+_0x4d233b(0x19e));}else console['log'](_0x4d233b(0x1f2)+_0x418f15+'\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20'+_0x5557c0+_0x4d233b(0x19d)+_0x235d7d[_0x4d233b(0x174)]());});}async[a69_0x5e4c3a(0x282)](_0x25f313){const _0x306b7f=a69_0x5e4c3a;console['log'](_0x306b7f(0x1d2),_0x25f313);try{const _0x5de6f2=await this[_0x306b7f(0x20a)][_0x306b7f(0x231)](_0x25f313);if(!_0x5de6f2[_0x306b7f(0x167)])throw new Error(_0x306b7f(0x1d7));const _0x4bfc02=await database_1['default'][_0x306b7f(0x267)]['findFirst']({'where':{'gatewayOrderId':_0x5de6f2[_0x306b7f(0x167)]}});if(!_0x4bfc02){console[_0x306b7f(0x24b)](_0x306b7f(0x190)+_0x5de6f2['paymentId']);return;}console[_0x306b7f(0x245)](_0x306b7f(0x26f)+_0x4bfc02['id']+_0x306b7f(0x1c6)+_0x5de6f2['status']),await this[_0x306b7f(0x168)](_0x4bfc02['id'],_0x5de6f2[_0x306b7f(0x177)],{'txUrls':_0x5de6f2['txUrls']}),loggerService_1[_0x306b7f(0x2a1)][_0x306b7f(0x21e)](_0x306b7f(0x1ed),_0x4bfc02['id'],_0x4bfc02[_0x306b7f(0x177)],_0x5de6f2['status'],_0x25f313);}catch(_0xda61c7){console[_0x306b7f(0x24b)](_0x306b7f(0x1c0),_0xda61c7),loggerService_1[_0x306b7f(0x2a1)][_0x306b7f(0x1b0)](_0x306b7f(0x1ed),_0xda61c7,_0x25f313);throw _0xda61c7;}}async[a69_0x5e4c3a(0x204)](_0x4dae76){const _0x16eb69=a69_0x5e4c3a;console[_0x16eb69(0x245)](_0x16eb69(0x172),_0x4dae76);try{const _0x5dcea7=await this[_0x16eb69(0x20a)][_0x16eb69(0x231)](_0x4dae76);if(!_0x5dcea7[_0x16eb69(0x167)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x5d7ccf=await database_1[_0x16eb69(0x1f3)][_0x16eb69(0x267)][_0x16eb69(0x16a)]({'where':{'gatewayOrderId':_0x5dcea7[_0x16eb69(0x167)]}});if(!_0x5d7ccf){console[_0x16eb69(0x24b)](_0x16eb69(0x196)+_0x5dcea7['paymentId']);return;}console[_0x16eb69(0x245)](_0x16eb69(0x1d3)+_0x5d7ccf['id']+_0x16eb69(0x1c6)+_0x5dcea7[_0x16eb69(0x177)]),await this[_0x16eb69(0x168)](_0x5d7ccf['id'],_0x5dcea7[_0x16eb69(0x177)],{'txUrls':_0x5dcea7[_0x16eb69(0x26c)]}),loggerService_1[_0x16eb69(0x2a1)][_0x16eb69(0x21e)](_0x16eb69(0x15c),_0x5d7ccf['id'],_0x5d7ccf[_0x16eb69(0x177)],_0x5dcea7[_0x16eb69(0x177)],_0x4dae76);}catch(_0x3172fd){console[_0x16eb69(0x24b)](_0x16eb69(0x19a),_0x3172fd),loggerService_1['loggerService'][_0x16eb69(0x1b0)]('plisio_gateway',_0x3172fd,_0x4dae76);throw _0x3172fd;}}async[a69_0x5e4c3a(0x291)](_0x52de50){const _0x1a8a96=a69_0x5e4c3a;console[_0x1a8a96(0x245)](_0x1a8a96(0x1b6),_0x52de50);try{const _0x4d03cf=await this[_0x1a8a96(0x1eb)][_0x1a8a96(0x231)](_0x52de50);if(!_0x4d03cf['paymentId'])throw new Error(_0x1a8a96(0x241));const _0x398e54=await database_1[_0x1a8a96(0x1f3)][_0x1a8a96(0x267)]['findFirst']({'where':{'gatewayOrderId':_0x4d03cf[_0x1a8a96(0x167)]}});if(!_0x398e54){console['error']('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x4d03cf['paymentId']);return;}console[_0x1a8a96(0x245)](_0x1a8a96(0x20c)+_0x398e54['id']+_0x1a8a96(0x1c6)+_0x4d03cf[_0x1a8a96(0x177)]),await this['updatePaymentStatus'](_0x398e54['id'],_0x4d03cf[_0x1a8a96(0x177)],{'failureMessage':_0x4d03cf['failureMessage'],'cardLast4':_0x4d03cf['additionalInfo']?.[_0x1a8a96(0x16c)],'paymentMethod':_0x4d03cf[_0x1a8a96(0x22e)]?.[_0x1a8a96(0x162)]}),loggerService_1[_0x1a8a96(0x2a1)][_0x1a8a96(0x21e)]('rapyd',_0x398e54['id'],_0x398e54[_0x1a8a96(0x177)],_0x4d03cf[_0x1a8a96(0x177)],_0x52de50);}catch(_0x331118){console[_0x1a8a96(0x24b)](_0x1a8a96(0x23a),_0x331118),loggerService_1['loggerService'][_0x1a8a96(0x1b0)](_0x1a8a96(0x1f7),_0x331118,_0x52de50);throw _0x331118;}}async[a69_0x5e4c3a(0x29d)](_0x4fe26e){const _0x406fac=a69_0x5e4c3a;console['log'](_0x406fac(0x1a0),_0x4fe26e);try{const _0x38e732=await this[_0x406fac(0x1e8)]['processWebhook'](_0x4fe26e);if(!_0x38e732[_0x406fac(0x167)])throw new Error(_0x406fac(0x205));const _0x338e02=await database_1[_0x406fac(0x1f3)][_0x406fac(0x267)][_0x406fac(0x16a)]({'where':{'gatewayOrderId':_0x38e732['paymentId']}});if(!_0x338e02){console[_0x406fac(0x24b)](_0x406fac(0x1a8)+_0x38e732[_0x406fac(0x167)]);return;}console['log'](_0x406fac(0x20e)+_0x338e02['id']+'\x20status\x20'+_0x38e732['status']),await this[_0x406fac(0x168)](_0x338e02['id'],_0x38e732[_0x406fac(0x177)],{'bankId':_0x38e732[_0x406fac(0x22e)]?.[_0x406fac(0x293)],'remitterIban':_0x38e732[_0x406fac(0x22e)]?.[_0x406fac(0x24f)],'remitterName':_0x38e732['additionalInfo']?.[_0x406fac(0x243)]}),loggerService_1[_0x406fac(0x2a1)]['logWebhookProcessed'](_0x406fac(0x185),_0x338e02['id'],_0x338e02[_0x406fac(0x177)],_0x38e732[_0x406fac(0x177)],_0x4fe26e);}catch(_0x12bc7c){console['error']('Error\x20processing\x20Noda\x20webhook:',_0x12bc7c),loggerService_1['loggerService'][_0x406fac(0x1b0)](_0x406fac(0x185),_0x12bc7c,_0x4fe26e);throw _0x12bc7c;}}async[a69_0x5e4c3a(0x17e)](_0x271a9c){const _0x50f460=a69_0x5e4c3a;console[_0x50f460(0x245)](_0x50f460(0x19c),_0x271a9c);try{const _0x101b99=await this[_0x50f460(0x1c3)][_0x50f460(0x231)](_0x271a9c);if(!_0x101b99['paymentId'])throw new Error(_0x50f460(0x15f));const _0xc31fd6=await database_1['default'][_0x50f460(0x267)][_0x50f460(0x16a)]({'where':{'gatewayOrderId':_0x101b99['paymentId']}});if(!_0xc31fd6){console[_0x50f460(0x24b)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x101b99[_0x50f460(0x167)]);return;}console[_0x50f460(0x245)](_0x50f460(0x24a)+_0xc31fd6['id']+_0x50f460(0x1c6)+_0x101b99[_0x50f460(0x177)]),await this['updatePaymentStatus'](_0xc31fd6['id'],_0x101b99[_0x50f460(0x177)]),loggerService_1[_0x50f460(0x2a1)][_0x50f460(0x21e)](_0x50f460(0x23b),_0xc31fd6['id'],_0xc31fd6[_0x50f460(0x177)],_0x101b99[_0x50f460(0x177)],_0x271a9c);}catch(_0x296920){console['error'](_0x50f460(0x1a9),_0x296920),loggerService_1[_0x50f460(0x2a1)][_0x50f460(0x1b0)](_0x50f460(0x23b),_0x296920,_0x271a9c);throw _0x296920;}}async[a69_0x5e4c3a(0x287)](_0x140b52){const _0x1e40c2=a69_0x5e4c3a;console[_0x1e40c2(0x245)]('🔄\x20Processing\x20CoinToPay2\x20webhook:',_0x140b52);try{const _0x524fc4=await this[_0x1e40c2(0x171)][_0x1e40c2(0x231)](_0x140b52);if(!_0x524fc4['paymentId'])throw new Error(_0x1e40c2(0x20d));const _0x3a2887=await database_1['default']['payment'][_0x1e40c2(0x16a)]({'where':{'gatewayOrderId':_0x524fc4[_0x1e40c2(0x167)]}});if(!_0x3a2887){console[_0x1e40c2(0x24b)](_0x1e40c2(0x2b3)+_0x524fc4[_0x1e40c2(0x167)]);return;}console['log']('📊\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x3a2887['id']+_0x1e40c2(0x1c6)+_0x524fc4[_0x1e40c2(0x177)]),await this[_0x1e40c2(0x168)](_0x3a2887['id'],_0x524fc4['status']),loggerService_1[_0x1e40c2(0x2a1)]['logWebhookProcessed'](_0x1e40c2(0x1c4),_0x3a2887['id'],_0x3a2887[_0x1e40c2(0x177)],_0x524fc4[_0x1e40c2(0x177)],_0x140b52);}catch(_0x3e0967){console[_0x1e40c2(0x24b)](_0x1e40c2(0x1b7),_0x3e0967),loggerService_1['loggerService'][_0x1e40c2(0x1b0)]('cointopay2',_0x3e0967,_0x140b52);throw _0x3e0967;}}async[a69_0x5e4c3a(0x2ac)](_0x550f9a){const _0x460985=a69_0x5e4c3a;console['log'](_0x460985(0x24d),_0x550f9a);try{const _0x3f00fd=await this['klymeService'][_0x460985(0x231)](_0x550f9a);if(!_0x3f00fd[_0x460985(0x167)])throw new Error(_0x460985(0x1da));const _0x4c5254=await database_1['default']['payment'][_0x460985(0x16a)]({'where':{'gatewayOrderId':_0x3f00fd[_0x460985(0x167)]}});if(!_0x4c5254){console[_0x460985(0x24b)](_0x460985(0x274)+_0x3f00fd[_0x460985(0x167)]);return;}console['log'](_0x460985(0x1b4)+_0x4c5254['id']+_0x460985(0x1c6)+_0x3f00fd[_0x460985(0x177)]),await this['updatePaymentStatus'](_0x4c5254['id'],_0x3f00fd[_0x460985(0x177)],{'paymentMethod':_0x3f00fd[_0x460985(0x22e)]?.[_0x460985(0x29f)]}),loggerService_1[_0x460985(0x2a1)]['logWebhookProcessed'](_0x460985(0x1ef),_0x4c5254['id'],_0x4c5254[_0x460985(0x177)],_0x3f00fd[_0x460985(0x177)],_0x550f9a);}catch(_0x2bda8b){console[_0x460985(0x24b)](_0x460985(0x1e5),_0x2bda8b),loggerService_1[_0x460985(0x2a1)][_0x460985(0x1b0)](_0x460985(0x1ef),_0x2bda8b,_0x550f9a);throw _0x2bda8b;}}async[a69_0x5e4c3a(0x280)](_0x49c3f8){const _0x458360=a69_0x5e4c3a;console[_0x458360(0x245)](_0x458360(0x161),JSON[_0x458360(0x173)](_0x49c3f8,null,0x2));try{const _0x3a5dc3=await this[_0x458360(0x212)][_0x458360(0x231)](_0x49c3f8,_0x458360(0x1fe));console[_0x458360(0x245)](_0x458360(0x2b0),_0x3a5dc3);if(!_0x3a5dc3['paymentId']){console['error'](_0x458360(0x29a)),console['error']('❌\x20Available\x20webhook\x20fields:',Object[_0x458360(0x198)](_0x49c3f8));throw new Error('No\x20payment\x20ID\x20in\x20VISA\x20webhook');}let _0x32c039=null;console[_0x458360(0x245)](_0x458360(0x1de)+_0x3a5dc3[_0x458360(0x167)]);if(_0x3a5dc3[_0x458360(0x167)]){console[_0x458360(0x245)](_0x458360(0x1b3)),console[_0x458360(0x245)](_0x458360(0x1fa)),console['log'](_0x458360(0x2a7)),console[_0x458360(0x245)](_0x458360(0x19f)+_0x3a5dc3[_0x458360(0x167)]),console[_0x458360(0x245)](_0x458360(0x226)),_0x32c039=await database_1['default'][_0x458360(0x267)][_0x458360(0x16a)]({'where':{'AND':[{'OR':[{'gateway':_0x458360(0x219)},{'gateway':_0x458360(0x216)}]},{'OR':[{'gatewayPaymentId':_0x3a5dc3[_0x458360(0x167)]},{'gatewayOrderId':_0x3a5dc3[_0x458360(0x167)]},{'id':_0x3a5dc3[_0x458360(0x167)]},{'orderId':_0x3a5dc3[_0x458360(0x167)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console['log'](_0x458360(0x23d));if(_0x32c039)console[_0x458360(0x245)](_0x458360(0x1c9)+_0x32c039['id']+_0x458360(0x1d5)+_0x32c039[_0x458360(0x232)]+_0x458360(0x16e)+_0x32c039[_0x458360(0x1db)]);else{console['log'](_0x458360(0x1d1));const _0x12bedf=await database_1[_0x458360(0x1f3)][_0x458360(0x267)][_0x458360(0x296)]({'where':{'gateway':'visa/mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x458360(0x285)}});console[_0x458360(0x245)](_0x458360(0x286),_0x12bedf[_0x458360(0x1e6)](_0x13e694=>_0x13e694['id']+'\x20(orderId:\x20'+_0x13e694['orderId']+_0x458360(0x1e9)+_0x13e694[_0x458360(0x232)]+_0x458360(0x27a)+_0x13e694[_0x458360(0x1db)]+_0x458360(0x240)+_0x13e694[_0x458360(0x16c)]+')'));}console[_0x458360(0x245)](_0x458360(0x242)+(_0x32c039?'Found':_0x458360(0x17d))),_0x32c039&&console[_0x458360(0x245)](_0x458360(0x218)+_0x32c039['id']+_0x458360(0x22f)+_0x32c039[_0x458360(0x1ce)]+_0x458360(0x236)+_0x32c039[_0x458360(0x177)]+_0x458360(0x281)+_0x32c039['cardLast4']);}if(!_0x32c039){console[_0x458360(0x24b)]('❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20'+_0x3a5dc3['paymentId']),loggerService_1[_0x458360(0x2a1)][_0x458360(0x1b0)]('visa',new Error('Payment\x20not\x20found:\x20'+_0x3a5dc3[_0x458360(0x167)]),_0x49c3f8);throw new Error('VISA\x20payment\x20not\x20found:\x20'+_0x3a5dc3[_0x458360(0x167)]);}console['log'](_0x458360(0x22a)+_0x32c039['id']+'\x20(Status:\x20'+_0x32c039['status']+_0x458360(0x1a6)+_0x3a5dc3[_0x458360(0x177)]+')');const _0x1a6d0e={};_0x3a5dc3[_0x458360(0x18d)]&&await database_1['default'][_0x458360(0x267)][_0x458360(0x2ad)]({'where':{'id':_0x32c039['id']},'data':{'amount':_0x3a5dc3[_0x458360(0x18d)],'updatedAt':new Date()}}),_0x3a5dc3[_0x458360(0x165)]&&await database_1[_0x458360(0x1f3)][_0x458360(0x267)][_0x458360(0x2ad)]({'where':{'id':_0x32c039['id']},'data':{'currency':_0x3a5dc3[_0x458360(0x165)],'updatedAt':new Date()}}),_0x3a5dc3[_0x458360(0x177)]===_0x458360(0x21d)&&_0x3a5dc3[_0x458360(0x29c)]&&(_0x1a6d0e[_0x458360(0x19b)]=_0x3a5dc3['errorMessage'],console['log'](_0x458360(0x28b)+_0x3a5dc3['errorMessage'])),_0x1a6d0e[_0x458360(0x162)]=_0x458360(0x246),await this['updatePaymentStatus'](_0x32c039['id'],_0x3a5dc3[_0x458360(0x177)],_0x1a6d0e),await database_1[_0x458360(0x1f3)][_0x458360(0x229)][_0x458360(0x1c5)]({'data':{'paymentId':_0x32c039['id'],'shopId':_0x32c039[_0x458360(0x25e)],'event':_0x458360(0x225)+_0x3a5dc3['status'][_0x458360(0x24e)](),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x3a5dc3)}}),await this[_0x458360(0x261)](_0x32c039,_0x3a5dc3[_0x458360(0x177)][_0x458360(0x174)]()),console[_0x458360(0x245)](_0x458360(0x1ca)+_0x32c039['id']);}catch(_0x1f8b92){console[_0x458360(0x24b)](_0x458360(0x1dd),_0x1f8b92),loggerService_1[_0x458360(0x2a1)][_0x458360(0x1b0)]('visa',_0x1f8b92,_0x49c3f8);throw _0x1f8b92;}}async[a69_0x5e4c3a(0x1cf)](_0x45177a){const _0x386c89=a69_0x5e4c3a;console['log']('🔄\x20Processing\x20MasterCard\x20webhook:',JSON[_0x386c89(0x173)](_0x45177a,null,0x2));try{const _0x35d531=await this['visaMasterCardService'][_0x386c89(0x231)](_0x45177a,_0x386c89(0x183));console[_0x386c89(0x245)](_0x386c89(0x292),_0x35d531);if(!_0x35d531[_0x386c89(0x167)]){console[_0x386c89(0x24b)](_0x386c89(0x160)),console[_0x386c89(0x24b)](_0x386c89(0x21a),Object[_0x386c89(0x198)](_0x45177a));throw new Error(_0x386c89(0x18f));}let _0x59693c=null;console['log'](_0x386c89(0x175)+_0x35d531[_0x386c89(0x167)]);_0x35d531[_0x386c89(0x167)]&&(console[_0x386c89(0x245)](_0x386c89(0x202)),_0x59693c=await database_1['default'][_0x386c89(0x267)][_0x386c89(0x16a)]({'where':{'AND':[{'OR':[{'gateway':_0x386c89(0x1e7)},{'gateway':_0x386c89(0x216)},{'gateway':'visa/mastercard'}]},{'OR':[{'gatewayPaymentId':_0x35d531[_0x386c89(0x167)]},{'gatewayOrderId':_0x35d531[_0x386c89(0x167)]},{'id':_0x35d531[_0x386c89(0x167)]},{'orderId':_0x35d531[_0x386c89(0x167)]}]}]}}),console[_0x386c89(0x245)](_0x386c89(0x1e2)+(_0x59693c?'Found\x20payment\x20'+_0x59693c['id']:_0x386c89(0x1c8))));if(!_0x59693c){console['error'](_0x386c89(0x276)+_0x35d531['paymentId']),console[_0x386c89(0x24b)](_0x386c89(0x20b)+_0x35d531[_0x386c89(0x167)]+_0x386c89(0x1be)+_0x35d531[_0x386c89(0x167)]+_0x386c89(0x2aa)+_0x35d531[_0x386c89(0x167)]+'\x22');const _0x3d4214=await database_1[_0x386c89(0x1f3)][_0x386c89(0x267)][_0x386c89(0x296)]({'where':{'OR':[{'gateway':_0x386c89(0x216)},{'gateway':_0x386c89(0x1e7)},{'gateway':_0x386c89(0x219)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':'desc'},'take':0xf});console[_0x386c89(0x245)](_0x386c89(0x1dc),_0x3d4214),loggerService_1[_0x386c89(0x2a1)]['logWebhookError']('mastercard',new Error(_0x386c89(0x25f)+_0x35d531[_0x386c89(0x167)]),_0x45177a);throw new Error(_0x386c89(0x234)+_0x35d531[_0x386c89(0x167)]);}console[_0x386c89(0x245)](_0x386c89(0x255)+_0x59693c['id']+_0x386c89(0x28f)+_0x59693c[_0x386c89(0x177)]+_0x386c89(0x233)+_0x35d531[_0x386c89(0x177)]);const _0x11302b={};_0x35d531['amount']&&await database_1[_0x386c89(0x1f3)]['payment'][_0x386c89(0x2ad)]({'where':{'id':_0x59693c['id']},'data':{'amount':_0x35d531[_0x386c89(0x18d)],'updatedAt':new Date()}}),_0x35d531[_0x386c89(0x165)]&&await database_1[_0x386c89(0x1f3)]['payment'][_0x386c89(0x2ad)]({'where':{'id':_0x59693c['id']},'data':{'currency':_0x35d531[_0x386c89(0x165)],'updatedAt':new Date()}}),_0x35d531[_0x386c89(0x177)]===_0x386c89(0x21d)&&_0x35d531[_0x386c89(0x29c)]&&(_0x11302b[_0x386c89(0x19b)]=_0x35d531['errorMessage'],console[_0x386c89(0x245)](_0x386c89(0x29b)+_0x35d531[_0x386c89(0x29c)])),_0x11302b['paymentMethod']=_0x386c89(0x216),await this[_0x386c89(0x168)](_0x59693c['id'],_0x35d531[_0x386c89(0x177)],_0x11302b),loggerService_1[_0x386c89(0x2a1)]['logWebhookProcessed'](_0x386c89(0x216),_0x59693c['id'],_0x59693c[_0x386c89(0x177)],_0x35d531[_0x386c89(0x177)],_0x45177a);}catch(_0x380b28){console[_0x386c89(0x24b)](_0x386c89(0x1fb),_0x380b28),loggerService_1['loggerService']['logWebhookError']('mastercard',_0x380b28,_0x45177a);throw _0x380b28;}}async[a69_0x5e4c3a(0x28a)](_0x44db11){const _0x2fac05=a69_0x5e4c3a;console[_0x2fac05(0x245)](_0x2fac05(0x257),JSON[_0x2fac05(0x173)](_0x44db11,null,0x2));try{const _0x14dabd=await this[_0x2fac05(0x1b2)][_0x2fac05(0x231)](_0x44db11);console[_0x2fac05(0x245)]('📊\x20Amer\x20webhook\x20result:',_0x14dabd);if(!_0x14dabd['paymentId']){console['error'](_0x2fac05(0x283)),console[_0x2fac05(0x24b)](_0x2fac05(0x21a),Object['keys'](_0x44db11));throw new Error('No\x20payment\x20ID\x20in\x20Amer\x20webhook');}let _0xdb9012=null;console[_0x2fac05(0x245)](_0x2fac05(0x27f)+_0x14dabd[_0x2fac05(0x167)]),_0xdb9012=await database_1[_0x2fac05(0x1f3)][_0x2fac05(0x267)][_0x2fac05(0x16a)]({'where':{'AND':[{'gateway':_0x2fac05(0x2a8)},{'OR':[{'gatewayPaymentId':_0x14dabd[_0x2fac05(0x167)]},{'gatewayOrderId':_0x14dabd['paymentId']},{'id':_0x14dabd['paymentId']},{'orderId':_0x14dabd['paymentId']}]}]}}),console[_0x2fac05(0x245)](_0x2fac05(0x1e2)+(_0xdb9012?_0x2fac05(0x1ae)+_0xdb9012['id']:_0x2fac05(0x1c8)));if(!_0xdb9012){console[_0x2fac05(0x24b)](_0x2fac05(0x299)+_0x14dabd[_0x2fac05(0x167)]);return;}console['log'](_0x2fac05(0x169)+_0xdb9012['id']+'\x20status\x20'+_0x14dabd[_0x2fac05(0x177)]),await this[_0x2fac05(0x168)](_0xdb9012['id'],_0x14dabd[_0x2fac05(0x177)],{'cardLast4':_0x14dabd[_0x2fac05(0x22e)]?.[_0x2fac05(0x16c)],'paymentMethod':_0x14dabd[_0x2fac05(0x22e)]?.[_0x2fac05(0x162)]});}catch(_0x3a90b4){console['error'](_0x2fac05(0x262),_0x3a90b4),loggerService_1['loggerService'][_0x2fac05(0x1b0)](_0x2fac05(0x2a8),_0x3a90b4,_0x44db11);throw _0x3a90b4;}}async['processAmPayWebhook'](_0x3c4842){const _0x34ff06=a69_0x5e4c3a;console[_0x34ff06(0x245)](_0x34ff06(0x1f6),JSON['stringify'](_0x3c4842,null,0x2));try{const _0x15923e=_0x3c4842['status'],_0x5a5ac7=_0x3c4842[_0x34ff06(0x21f)],_0xcacf0a=_0x3c4842[_0x34ff06(0x217)],_0x41dc59=_0x3c4842[_0x34ff06(0x29f)],_0x27d99d=_0x3c4842['amount'],_0x3a1abb=_0x3c4842[_0x34ff06(0x165)],_0x52084f=_0x3c4842[_0x34ff06(0x1f5)],_0x17403f=_0x3c4842[_0x34ff06(0x23e)];if(!_0x5a5ac7){console[_0x34ff06(0x24b)](_0x34ff06(0x1ad));throw new Error('Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook');}console[_0x34ff06(0x245)](_0x34ff06(0x1ac),{'status':_0x15923e,'clientTransactionId':_0x5a5ac7,'systemId':_0xcacf0a,'paymentMethod':_0x41dc59,'amount':_0x27d99d,'currency':_0x3a1abb,'commission':_0x52084f,'statusAdditionInfo':_0x17403f});const _0x57b555=await database_1[_0x34ff06(0x1f3)][_0x34ff06(0x267)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x5a5ac7},{'orderId':_0x5a5ac7},{'id':_0x5a5ac7},{'gatewayPaymentId':_0x5a5ac7}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x57b555){console[_0x34ff06(0x24b)](_0x34ff06(0x197)+_0x5a5ac7);throw new Error(_0x34ff06(0x25f)+_0x5a5ac7);}console[_0x34ff06(0x245)](_0x34ff06(0x255)+_0x57b555['id']+_0x34ff06(0x206)),console[_0x34ff06(0x245)](_0x34ff06(0x1a3)+_0x57b555[_0x34ff06(0x177)]+_0x34ff06(0x1a6)+_0x15923e),_0x15923e==='DECLINED'?(console[_0x34ff06(0x245)](_0x34ff06(0x25a)),await this['updatePaymentStatus'](_0x57b555['id'],_0x34ff06(0x21d)),console[_0x34ff06(0x245)](_0x34ff06(0x17b)+_0x57b555['id']+_0x34ff06(0x2a9)),console[_0x34ff06(0x245)](_0x34ff06(0x28d)+(_0x17403f||_0x34ff06(0x290)))):console[_0x34ff06(0x245)](_0x34ff06(0x192)+_0x15923e+_0x34ff06(0x188)),await database_1[_0x34ff06(0x1f3)][_0x34ff06(0x229)]['create']({'data':{'paymentId':_0x57b555['id'],'shopId':_0x57b555[_0x34ff06(0x25e)],'event':'ampay_'+(_0x15923e?.[_0x34ff06(0x24e)]()||'unknown'),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x3c4842)}}),loggerService_1[_0x34ff06(0x2a1)][_0x34ff06(0x21e)](_0x34ff06(0x22d),_0x57b555['id'],_0x57b555[_0x34ff06(0x177)],_0x15923e===_0x34ff06(0x1fc)?_0x34ff06(0x21d):_0x15923e,_0x3c4842);}catch(_0x2427a8){console[_0x34ff06(0x24b)]('❌\x20Error\x20processing\x20AmPay\x20webhook:',_0x2427a8),loggerService_1[_0x34ff06(0x2a1)]['logWebhookError'](_0x34ff06(0x22d),_0x2427a8,_0x3c4842);throw _0x2427a8;}}async[a69_0x5e4c3a(0x268)](_0x319b7e){const _0x281900=a69_0x5e4c3a;console[_0x281900(0x245)]('🔄\x20Processing\x20AmPay\x20TRY\x20webhook:',JSON['stringify'](_0x319b7e,null,0x2));try{const _0x407d64=_0x319b7e[_0x281900(0x177)],_0x31e25c=_0x319b7e[_0x281900(0x21f)],_0x356c59=_0x319b7e[_0x281900(0x217)],_0x53c1c5=_0x319b7e[_0x281900(0x29f)],_0x538c88=_0x319b7e[_0x281900(0x18d)],_0x16f0a1=_0x319b7e[_0x281900(0x165)],_0x2da316=_0x319b7e[_0x281900(0x1f5)],_0x5b3f14=_0x319b7e[_0x281900(0x23e)];if(!_0x31e25c){console['error'](_0x281900(0x1d6));throw new Error(_0x281900(0x1fd));}console[_0x281900(0x245)](_0x281900(0x258),{'status':_0x407d64,'clientTransactionId':_0x31e25c,'systemId':_0x356c59,'paymentMethod':_0x53c1c5,'amount':_0x538c88,'currency':_0x16f0a1,'commission':_0x2da316,'statusAdditionInfo':_0x5b3f14});const _0x1ed6cd=await database_1[_0x281900(0x1f3)][_0x281900(0x267)][_0x281900(0x16a)]({'where':{'OR':[{'gatewayOrderId':_0x31e25c},{'orderId':_0x31e25c},{'id':_0x31e25c},{'gatewayPaymentId':_0x31e25c}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1ed6cd){console['error']('❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20'+_0x31e25c);throw new Error(_0x281900(0x25f)+_0x31e25c);}console['log']('✅\x20Found\x20payment\x20'+_0x1ed6cd['id']+'\x20for\x20AmPay\x20TRY\x20webhook'),console[_0x281900(0x245)](_0x281900(0x1a3)+_0x1ed6cd[_0x281900(0x177)]+_0x281900(0x1a6)+_0x407d64),_0x407d64===_0x281900(0x1fc)?(console[_0x281900(0x245)]('🔄\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED'),await this[_0x281900(0x168)](_0x1ed6cd['id'],'FAILED'),console[_0x281900(0x245)](_0x281900(0x164)+_0x1ed6cd['id']+_0x281900(0x2a9)),console[_0x281900(0x245)](_0x281900(0x28d)+(_0x5b3f14||_0x281900(0x290)))):console[_0x281900(0x245)](_0x281900(0x251)+_0x407d64+_0x281900(0x188)),await database_1['default'][_0x281900(0x229)][_0x281900(0x1c5)]({'data':{'paymentId':_0x1ed6cd['id'],'shopId':_0x1ed6cd[_0x281900(0x25e)],'event':'ampay_try_'+(_0x407d64?.[_0x281900(0x24e)]()||_0x281900(0x1a1)),'statusCode':0xc8,'responseBody':JSON[_0x281900(0x173)](_0x319b7e)}}),loggerService_1['loggerService'][_0x281900(0x21e)](_0x281900(0x273),_0x1ed6cd['id'],_0x1ed6cd[_0x281900(0x177)],_0x407d64==='DECLINED'?_0x281900(0x21d):_0x407d64,_0x319b7e);}catch(_0x204fa1){console[_0x281900(0x24b)](_0x281900(0x26d),_0x204fa1),loggerService_1[_0x281900(0x2a1)][_0x281900(0x1b0)](_0x281900(0x273),_0x204fa1,_0x319b7e);throw _0x204fa1;}}async[a69_0x5e4c3a(0x1d9)](_0x436fe5,_0x215941){const _0x48cc3e=a69_0x5e4c3a,_0x556331=Date[_0x48cc3e(0x298)]();try{const _0x409461=_0x436fe5[_0x48cc3e(0x18b)],_0xf5b441=_0x409461['settings'];if(!_0xf5b441?.[_0x48cc3e(0x187)]){console[_0x48cc3e(0x245)](_0x48cc3e(0x1cd)+_0x409461['id']);return;}const _0x4847eb=_0x215941===_0x48cc3e(0x1b9)?_0x48cc3e(0x2b1):_0x215941===_0x48cc3e(0x21d)?_0x48cc3e(0x195):_0x215941===_0x48cc3e(0x17f)?_0x48cc3e(0x195):_0x215941===_0x48cc3e(0x189)?_0x48cc3e(0x195):_0x215941===_0x48cc3e(0x221)?_0x48cc3e(0x195):_0x48cc3e(0x1e4);let _0xb573b2=[];if(_0xf5b441[_0x48cc3e(0x220)])try{_0xb573b2=Array['isArray'](_0xf5b441[_0x48cc3e(0x220)])?_0xf5b441['webhookEvents']:JSON['parse'](_0xf5b441[_0x48cc3e(0x220)]);}catch(_0x34182a){console[_0x48cc3e(0x24b)](_0x48cc3e(0x209),_0x34182a),_0xb573b2=[];}if(!_0xb573b2[_0x48cc3e(0x1c1)](_0x4847eb)){console[_0x48cc3e(0x245)]('Webhook\x20event\x20'+_0x4847eb+_0x48cc3e(0x166)+_0x409461['id']);return;}const _0x9af5a0={'event':_0x4847eb,'payment':{'id':_0x436fe5['id'],'order_id':_0x436fe5['orderId'],'gateway_order_id':_0x436fe5[_0x48cc3e(0x232)],'gateway':_0x436fe5[_0x48cc3e(0x1ce)],'amount':_0x436fe5[_0x48cc3e(0x18d)],'currency':_0x436fe5['currency'],'status':_0x215941[_0x48cc3e(0x24e)](),'customer_email':_0x436fe5[_0x48cc3e(0x1c2)],'customer_name':_0x436fe5[_0x48cc3e(0x263)],'failure_message':_0x436fe5['failureMessage'],'tx_urls':_0x436fe5[_0x48cc3e(0x26c)]?JSON[_0x48cc3e(0x18a)](_0x436fe5[_0x48cc3e(0x26c)]):null,'created_at':_0x436fe5[_0x48cc3e(0x235)],'updated_at':_0x436fe5[_0x48cc3e(0x214)]}},_0x48907c=await fetch(_0xf5b441[_0x48cc3e(0x187)],{'method':_0x48cc3e(0x238),'headers':{'Content-Type':_0x48cc3e(0x2a2),'User-Agent':_0x48cc3e(0x247)},'body':JSON[_0x48cc3e(0x173)](_0x9af5a0)}),_0x3d7cc=Date[_0x48cc3e(0x298)]()-_0x556331,_0x20849b=_0x48907c['ok']?_0x48cc3e(0x20f):await _0x48907c[_0x48cc3e(0x269)]();loggerService_1[_0x48cc3e(0x2a1)][_0x48cc3e(0x1f8)](_0x436fe5[_0x48cc3e(0x25e)],_0xf5b441[_0x48cc3e(0x187)],_0x4847eb,_0x48907c[_0x48cc3e(0x177)],_0x3d7cc,_0x9af5a0),console[_0x48cc3e(0x245)]('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0xf5b441[_0x48cc3e(0x187)]+_0x48cc3e(0x297)+_0x48907c[_0x48cc3e(0x177)]+'\x20('+_0x3d7cc+_0x48cc3e(0x1a7));}catch(_0x2ab52b){console[_0x48cc3e(0x24b)](_0x48cc3e(0x284),_0x2ab52b),loggerService_1[_0x48cc3e(0x2a1)][_0x48cc3e(0x16b)](_0x436fe5[_0x48cc3e(0x25e)],_0x436fe5[_0x48cc3e(0x18b)]?.['settings']?.[_0x48cc3e(0x187)]||_0x48cc3e(0x1a1),_0x48cc3e(0x180),_0x2ab52b,{});}}async[a69_0x5e4c3a(0x261)](_0xdd8c9b,_0x2bd6b7){const _0xb52d54=a69_0x5e4c3a;try{const _0x27e27d={'PENDING':'created','PROCESSING':'processing','PAID':_0xb52d54(0x163),'FAILED':_0xb52d54(0x16d),'EXPIRED':_0xb52d54(0x1ec),'REFUND':'refund','CHARGEBACK':_0xb52d54(0x23f)},_0x5da4be=_0x27e27d[_0x2bd6b7];if(!_0x5da4be||_0x5da4be===_0xb52d54(0x1a5))return;await telegramBotService_1[_0xb52d54(0x1c7)][_0xb52d54(0x1ee)](_0xdd8c9b['shopId'],_0xdd8c9b,_0x5da4be);}catch(_0x536264){console[_0xb52d54(0x24b)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x536264);}}async[a69_0x5e4c3a(0x244)](_0x1beb87,_0x1b2db8){const _0x55a234=a69_0x5e4c3a;try{const _0x276d1c=await database_1[_0x55a234(0x1f3)][_0x55a234(0x18b)][_0x55a234(0x1cb)]({'where':{'id':_0x1beb87},'select':{'gatewaySettings':!![]}});if(!_0x276d1c?.[_0x55a234(0x16f)])return console['log'](_0x55a234(0x2a4)+_0x1beb87+_0x55a234(0x1aa)),0xa;const _0x4f4131=JSON[_0x55a234(0x18a)](_0x276d1c[_0x55a234(0x16f)]);for(const [_0x40eb5b,_0x214aab]of Object[_0x55a234(0x2a6)](_0x4f4131)){if(_0x40eb5b[_0x55a234(0x24e)]()===_0x1b2db8['toLowerCase']()){const _0x1dfb7c=_0x214aab['commission']||0xa;return console[_0x55a234(0x245)](_0x55a234(0x295)+_0x1b2db8+_0x55a234(0x230)+_0x1beb87+':\x20'+_0x1dfb7c+'%'),_0x1dfb7c;}}return console[_0x55a234(0x245)](_0x55a234(0x25b)+_0x1b2db8+'\x20in\x20shop\x20'+_0x1beb87+_0x55a234(0x199)),0xa;}catch(_0x141494){return console[_0x55a234(0x24b)](_0x55a234(0x223)+_0x1beb87+_0x55a234(0x28e)+_0x1b2db8+':',_0x141494),0xa;}}async['processMyXSpendWebhook'](_0x5a8e5b,_0x53a91e){const _0x47d1bb=a69_0x5e4c3a;console[_0x47d1bb(0x245)](_0x47d1bb(0x27c)),console[_0x47d1bb(0x245)](_0x47d1bb(0x1cc),JSON[_0x47d1bb(0x173)](_0x5a8e5b,null,0x2)),console['log'](_0x47d1bb(0x25d),JSON[_0x47d1bb(0x173)](_0x53a91e,null,0x2));try{const _0x33b377=_0x5a8e5b[_0x47d1bb(0x266)]||_0x53a91e[_0x47d1bb(0x266)],_0x4b4024=_0x5a8e5b[_0x47d1bb(0x177)]||_0x53a91e['status'],_0x2ccd2f=_0x5a8e5b[_0x47d1bb(0x18d)]||_0x53a91e[_0x47d1bb(0x18d)],_0x1305b1=_0x5a8e5b[_0x47d1bb(0x165)]||_0x53a91e[_0x47d1bb(0x165)],_0x586346=_0x5a8e5b[_0x47d1bb(0x277)]||_0x53a91e[_0x47d1bb(0x277)];if(!_0x33b377){console[_0x47d1bb(0x24b)]('❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook');throw new Error(_0x47d1bb(0x1d0));}console[_0x47d1bb(0x245)](_0x47d1bb(0x239),{'customerOrderId':_0x33b377,'status':_0x4b4024,'amount':_0x2ccd2f,'currency':_0x1305b1,'dateTime':_0x586346});const _0x561db1=await database_1[_0x47d1bb(0x1f3)][_0x47d1bb(0x267)][_0x47d1bb(0x16a)]({'where':{'OR':[{'gatewayOrderId':_0x33b377},{'orderId':_0x33b377},{'id':_0x33b377},{'gatewayPaymentId':_0x33b377}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x561db1){console['error'](_0x47d1bb(0x182)+_0x33b377);throw new Error(_0x47d1bb(0x25f)+_0x33b377);}console[_0x47d1bb(0x245)](_0x47d1bb(0x255)+_0x561db1['id']+_0x47d1bb(0x1a2)),console[_0x47d1bb(0x245)](_0x47d1bb(0x1a3)+_0x561db1[_0x47d1bb(0x177)]+_0x47d1bb(0x1a6)+_0x4b4024);let _0x4fcf77=_0x4b4024?.[_0x47d1bb(0x174)]();_0x4b4024===_0x47d1bb(0x21d)||_0x4b4024==='EXPIRED'?(_0x4fcf77=_0x47d1bb(0x21d),console['log'](_0x47d1bb(0x1bf)+_0x4b4024+_0x47d1bb(0x194)),await this[_0x47d1bb(0x168)](_0x561db1['id'],_0x4fcf77),console[_0x47d1bb(0x245)]('✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20'+_0x561db1['id']+_0x47d1bb(0x2a9))):console[_0x47d1bb(0x245)](_0x47d1bb(0x21b)+_0x4b4024+_0x47d1bb(0x1e1)),await database_1[_0x47d1bb(0x1f3)]['webhookLog']['create']({'data':{'paymentId':_0x561db1['id'],'shopId':_0x561db1[_0x47d1bb(0x25e)],'event':_0x47d1bb(0x250)+(_0x4b4024?.[_0x47d1bb(0x24e)]()||_0x47d1bb(0x1a1)),'statusCode':0xc8,'responseBody':JSON['stringify']({'queryParams':_0x5a8e5b,'bodyData':_0x53a91e})}}),loggerService_1[_0x47d1bb(0x2a1)][_0x47d1bb(0x21e)](_0x47d1bb(0x200),_0x561db1['id'],_0x561db1[_0x47d1bb(0x177)],_0x4fcf77||_0x4b4024,{'queryParams':_0x5a8e5b,'bodyData':_0x53a91e});}catch(_0x28fbb1){console[_0x47d1bb(0x24b)]('❌\x20Error\x20processing\x20MyXSpend\x20webhook:',_0x28fbb1),loggerService_1['loggerService'][_0x47d1bb(0x1b0)](_0x47d1bb(0x200),_0x28fbb1,{'queryParams':_0x5a8e5b,'bodyData':_0x53a91e});throw _0x28fbb1;}}}function a69_0x1f93(){const _0x52b49b=['webhookEvents','REFUND','\x20=\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','no\x20balance\x20change','visa_','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId',',\x20newStatus=','%\x20gateway\x20commission)','webhookLog','📊\x20VISA\x20payment\x20found:\x20','./gateways/nodaService','💰\x20Adding\x20to\x20balance:\x20','ampay','additionalInfo',',\x20Gateway=','\x20commission\x20for\x20shop\x20','processWebhook','gatewayOrderId','\x20to\x20','MasterCard\x20payment\x20not\x20found:\x20','createdAt',',\x20Status=','paymentLink','POST','📊\x20MyXSpend\x20webhook\x20data:','Error\x20processing\x20Rapyd\x20webhook:','cointopay','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','🔍\x20VISA\x20payment\x20search\x20executed','status_addition_info','chargeback',',\x20card:\x20****','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','🔍\x20VISA\x20payment\x20search\x20result:\x20','remitterName','getGatewayCommission','log','visa','Payment\x20System/1.0','AmerService','Payment\x20','📊\x20CoinToPay\x20webhook:\x20Payment\x20','error','NodaService','🔄\x20Processing\x20KLYME\x20webhook:','toLowerCase','remitterIban','myxspend_','ℹ️\x20AmPay\x20TRY\x20status\x20','4tOFCtM','6DlnbIQ','./telegramBotService','✅\x20Found\x20payment\x20','✅\x20Shop\x20','🔄\x20Processing\x20Amer\x20webhook:','📊\x20AmPay\x20TRY\x20webhook\x20data:','./gateways/plisioService','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','CoinToPay2Service','Body\x20data:','shopId','Payment\x20not\x20found:\x20','💰\x20Payment\x20amount\x20is\x20NOT\x20deducted\x20(chargeback\x20penalty\x20only)','sendPaymentStatusNotification','❌\x20Error\x20processing\x20Amer\x20webhook:','customerName','klymeService',',\x20status=','customerOrderId','payment','processAmPayTRYWebhook','text','WebhookService',',\x20currentPayments=','txUrls','❌\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:','\x20+\x20','📊\x20Plisio\x20webhook:\x20Payment\x20','\x20commission:\x20','\x20balance\x20updated:\x20','\x20not\x20found','ampay_try','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','1071275LiUSit','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','dateTime','chargebackAmount','./gateways/coinToPay2Service',',\x20gatewayPaymentId:\x20','SINGLE','🔄\x20Processing\x20MyXSpend\x20webhook:','9BfPtDv','paymentLinkId','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','processVisaWebhook',',\x20Card=****','processPlisioWebhook','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','Failed\x20to\x20send\x20shop\x20webhook:','desc','🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:','processCoinToPay2Webhook','currencyService','system','processAmerWebhook','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','username','ℹ️\x20Decline\x20reason:\x20',',\x20gateway\x20','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','No\x20additional\x20info','processRapydWebhook','📊\x20MasterCard\x20webhook\x20result:','bankId','webhook_status_change_','Gateway\x20','findMany','\x20with\x20status\x20','now','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','errorMessage','processNodaWebhook','amountUSDT','payment_method','732JYguWP','loggerService','application/json','amountAfterGatewayCommissionUSDT','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','\x20updated:\x20currentPayments=','entries','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','amer','\x20status\x20updated\x20to\x20FAILED','\x22,\x20orderId=\x22','balance','processKlymeWebhook','update','./gateways/klymeService','564SrnBra','📊\x20VISA\x20webhook\x20result:','payment.success','363670sCxHWe','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','✅\x20Payment\x20link\x20','plisio_gateway','CoinToPayService','📝\x20Reason:\x20','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','🔄\x20Processing\x20VISA\x20webhook:','paymentMethod','paid','✅\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20','currency','\x20not\x20enabled\x20for\x20shop\x20','paymentId','updatePaymentStatus','📊\x20Amer\x20webhook:\x20Payment\x20','findFirst','logShopWebhookError','cardLast4','failed',',\x20GatewayPaymentId=','gatewaySettings','AmPayTRYService','coinToPay2Service','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','stringify','toUpperCase','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','🔄\x20Additional\x20data:','status','ampayService','__importDefault','705439BDTDuU','✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20','./gateways/ampayService','Not\x20found','processCoinToPayWebhook','EXPIRED','webhook_send','\x20current\x20balance:\x20','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','MASTERCARD','💸\x20CHARGEBACK:\x20Processing\x20penalty-only\x20deduction','noda','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','webhookUrl','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','CHARGEBACK','parse','shop','../config/database','amount','💰\x20Final\x20balance\x20after\x20chargeback:\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','\x20USDT','ℹ️\x20AmPay\x20status\x20','convertToUSDT','\x20mapped\x20to\x20FAILED','payment.failed','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','keys',',\x20using\x20default\x2010%','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','failureMessage','🔄\x20Processing\x20CoinToPay\x20webhook:','\x20->\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','🔄\x20Processing\x20Noda\x20webhook:','unknown','\x20for\x20MyXSpend\x20webhook','📊\x20Payment\x20status:\x20','668088kCmwNH','created','\x20→\x20','ms)','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','Error\x20processing\x20CoinToPay\x20webhook:',',\x20using\x20default\x20commission\x2010%','\x22,\x20paymentLinkId=\x22','📊\x20AmPay\x20webhook\x20data:','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','Found\x20payment\x20','PlisioService','logWebhookError','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','amerService','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','📊\x20KLYME\x20webhook:\x20Payment\x20','./loggerService','🔄\x20Processing\x20Rapyd\x20webhook:','Error\x20processing\x20CoinToPay2\x20webhook:','currentPayments','PAID','❌\x20Payment\x20link\x20','\x20-\x20','\x20USDT\x20(chargeback\x20penalty\x20ONLY)','🏪\x20Shop\x20','\x22,\x20id=\x22','🔄\x20MyXSpend\x20status\x20','Error\x20processing\x20Plisio\x20webhook:','includes','customerEmail','coinToPayService','cointopay2','create','\x20status\x20','telegramBotService','Payment\x20not\x20found','✅\x20Found\x20payment:\x20ID=','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','findUnique','Query\x20params:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','gateway','processMasterCardWebhook','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','🔄\x20Processing\x20Plisio\x20webhook:','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance',',\x20GatewayOrderId=','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','toFixed','sendShopWebhook','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','gatewayPaymentId','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','❌\x20VISA\x20webhook\x20processing\x20failed:','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','💸\x20CHARGEBACK\x20penalty\x20ONLY:\x20-','KlymeService','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','🔍\x20Search\x20result:\x20',':\x20type=','payment.pending','Error\x20processing\x20KLYME\x20webhook:','map','visa_mastercard','nodaService',',\x20gatewayOrderId:\x20','RapydService','rapydService','expired','plisio','sendPaymentNotification','klyme','\x22,\x20newStatus=\x22','22ryJAOw','📈\x20Payment\x20','default','📈\x20Payment\x20details:\x20oldStatus=\x22','commission','🔄\x20Processing\x20AmPay\x20webhook:','rapyd','logShopWebhookSent','./gateways/amerService','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','❌\x20Error\x20processing\x20MasterCard\x20webhook:','DECLINED','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','VISA','AmPayService','myxspend','1092856QlFXtc','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','__esModule','processPlisioGatewayWebhook','No\x20payment\x20ID\x20in\x20Noda\x20webhook','\x20for\x20AmPay\x20webhook','./currencyService','gatewayCommissionRate','Error\x20parsing\x20webhook\x20events:','plisioService','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','📊\x20Rapyd\x20webhook:\x20Payment\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','📊\x20Noda\x20webhook:\x20Payment\x20','Success','💰\x20Removing\x20from\x20balance:\x20','./gateways/mastercardService','visaMasterCardService','💰\x20Amount\x20after\x20gateway\x20commission:\x20','updatedAt','toISOString','mastercard','system_id','🔍\x20Found\x20VISA\x20payment:\x20ID=','visa/mastercard','❌\x20Available\x20webhook\x20fields:','ℹ️\x20MyXSpend\x20status\x20','705183tXuXyX','FAILED','logWebhookProcessed','client_transaction_id'];a69_0x1f93=function(){return _0x52b49b;};return a69_0x1f93();}exports[a69_0x5e4c3a(0x26a)]=WebhookService;