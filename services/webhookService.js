'use strict';const a60_0x5038ae=a60_0x3e87;(function(_0x53b2a7,_0x32522b){const _0x10e038=a60_0x3e87,_0x17bc1e=_0x53b2a7();while(!![]){try{const _0x582854=-parseInt(_0x10e038(0x270))/0x1*(parseInt(_0x10e038(0x2d2))/0x2)+parseInt(_0x10e038(0x299))/0x3+-parseInt(_0x10e038(0x23a))/0x4*(-parseInt(_0x10e038(0x20d))/0x5)+parseInt(_0x10e038(0x240))/0x6*(parseInt(_0x10e038(0x2aa))/0x7)+parseInt(_0x10e038(0x283))/0x8*(-parseInt(_0x10e038(0x2a7))/0x9)+-parseInt(_0x10e038(0x218))/0xa*(parseInt(_0x10e038(0x2b1))/0xb)+parseInt(_0x10e038(0x216))/0xc*(parseInt(_0x10e038(0x237))/0xd);if(_0x582854===_0x32522b)break;else _0x17bc1e['push'](_0x17bc1e['shift']());}catch(_0xce706){_0x17bc1e['push'](_0x17bc1e['shift']());}}}(a60_0x38ca,0x520f2));var __importDefault=this&&this['__importDefault']||function(_0x4c493f){const _0xaac036=a60_0x3e87;return _0x4c493f&&_0x4c493f[_0xaac036(0x1ed)]?_0x4c493f:{'default':_0x4c493f};};function a60_0x38ca(){const _0x34be70=['failed','webhookEvents','currencyService','🔄\x20Processing\x20Amer\x20webhook:','\x20->\x20','default','nodaService','\x20not\x20found','\x20commission:\x20','\x22,\x20id=\x22','shop','amountAfterGatewayCommissionUSDT','💰\x20Removing\x20from\x20balance:\x20','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','SINGLE','__esModule','%\x20gateway\x20commission)','processRapydWebhook','AmerService','plisio_gateway','findFirst','updatePaymentStatus','EXPIRED','amountUSDT','CoinToPay2Service','klyme','\x20and\x20-','📈\x20Payment\x20details:\x20oldStatus=\x22','processPlisioGatewayWebhook','commission','Error\x20parsing\x20webhook\x20events:','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','paidAt','✅\x20Found\x20payment\x20','amerService','\x20updated:\x20currentPayments=','📊\x20Plisio\x20webhook:\x20Payment\x20','📊\x20Rapyd\x20webhook:\x20Payment\x20','update','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','payment.pending','gatewaySettings','processCoinToPay2Webhook','💸\x20Additional\x20chargeback\x20penalty:\x20-','Webhook\x20event\x20','chargeback','1083985GBvqgG','cardLast4','rapyd','Found\x20payment\x20','logShopWebhookSent','logWebhookError','defineProperty','Error\x20processing\x20KLYME\x20webhook:','additionalInfo','12zyBoPZ','findUnique','306790ckcPaS','convertToUSDT','bankId','Error\x20processing\x20Plisio\x20webhook:','processKlymeWebhook','No\x20payment\x20ID\x20in\x20Amer\x20webhook','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','📊\x20MasterCard\x20webhook\x20result:','now','username','created','🔄\x20Processing\x20CoinToPay2\x20webhook:','payment.failed','processMasterCardWebhook','🔍\x20Search\x20result:\x20','📤\x20Shop\x20webhook\x20sent\x20to\x20','sendPaymentStatusNotification','🔄\x20Additional\x20data:','log','WebhookService','POST','🔄\x20Processing\x20Rapyd\x20webhook:','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:',',\x20gateway\x20','\x20with\x20status\x20','paid','balance',',\x20currentPayments=','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','./gateways/coinToPay2Service','amer','12202723XxXjcS','✅\x20Payment\x20link\x20','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','4AhQigZ','plisioService','MasterCardService','Failed\x20to\x20send\x20shop\x20webhook:','error','cointopay2','6YfBvrG',',\x20using\x20default\x20commission\x2010%','customerName','createdAt','paymentMethod','paymentLinkId','❌\x20Error\x20processing\x20Amer\x20webhook:','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','\x20to\x20','currency','\x20=\x20','KlymeService','🏪\x20Shop\x20','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','toFixed','paymentLink','🔄\x20Processing\x20CoinToPay\x20webhook:','❌\x20Error\x20processing\x20MasterCard\x20webhook:','payment_method','🔄\x20Processing\x20Plisio\x20webhook:','📊\x20Amer\x20webhook:\x20Payment\x20','💰\x20Gateway\x20','\x20-\x20','\x20in\x20shop\x20','❌\x20Available\x20webhook\x20fields:','klymeService',',\x20using\x20default\x2010%','COMPLETED','coinToPay2Service','PAID','failureMessage','./telegramBotService','\x20current\x20balance:\x20','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','Payment\x20not\x20found','remitterName','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','shopId','../config/database','./loggerService','currentPayments','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','sendShopWebhook','mastercard','payment.success','findMany','\x20balance\x20updated:\x20','4325eogugP','logWebhookProcessed','🔄\x20Processing\x20KLYME\x20webhook:','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','💰\x20Converting\x20','amount','keys','payment','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','RapydService','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','getGatewayCommission','\x22,\x20newStatus=\x22','\x22,\x20paymentLinkId=\x22','Gateway\x20','plisio','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','💰\x20Adding\x20to\x20balance:\x20','💰\x20Payment\x20','48BNCRsb','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','toLowerCase','📊\x20CoinToPay\x20webhook:\x20Payment\x20','status','Error\x20processing\x20Noda\x20webhook:','system','$transaction','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','isArray','processPlisioWebhook','updatedAt','orderId','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','parse','📈\x20Payment\x20','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','Success','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','gateway','CoinToPayService','246078CTZsAI','Error\x20processing\x20CoinToPay2\x20webhook:','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','\x20status\x20','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','./gateways/nodaService','customerEmail','processWebhook','settings','NodaService','FAILED','coinToPayService','./gateways/coinToPayService','501966krpwyH','webhook_status_change_','PlisioService','3801049NuWqnl','💰\x20Final\x20balance\x20after\x20chargeback:\x20','./gateways/rapydService','unknown','webhookUrl','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','chargebackAmount','187KknsiN','webhookLog','\x20+\x20','processAmerWebhook','text','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','TesSoft\x20Payment\x20System/1.0','rapydService','REFUND','ms)','📈\x20Found\x20payment\x20link\x20','toUpperCase','\x20USDT','paymentId','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','📊\x20Noda\x20webhook:\x20Payment\x20','sendPaymentNotification','refund','💰\x20Amount\x20after\x20gateway\x20commission:\x20','txUrls','remitterIban','gatewayOrderId','./gateways/plisioService','./gateways/klymeService','loggerService','application/json','📝\x20Reason:\x20','stringify','masterCardService','Error\x20processing\x20Rapyd\x20webhook:','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20',':\x20type=','272NIvGVB'];a60_0x38ca=function(){return _0x34be70;};return a60_0x38ca();}Object[a60_0x5038ae(0x213)](exports,a60_0x5038ae(0x1ed),{'value':!![]}),exports[a60_0x5038ae(0x22b)]=void 0x0;const database_1=__importDefault(require(a60_0x5038ae(0x266))),plisioService_1=require(a60_0x5038ae(0x2c8)),rapydService_1=require(a60_0x5038ae(0x2ac)),nodaService_1=require(a60_0x5038ae(0x29f)),coinToPayService_1=require(a60_0x5038ae(0x2a6)),coinToPay2Service_1=require(a60_0x5038ae(0x235)),klymeService_1=require(a60_0x5038ae(0x2c9)),mastercardService_1=require('./gateways/mastercardService'),amerService_1=require('./gateways/amerService'),telegramBotService_1=require(a60_0x5038ae(0x25f)),currencyService_1=require('./currencyService'),loggerService_1=require(a60_0x5038ae(0x267));class WebhookService{constructor(){const _0x541df6=a60_0x5038ae;this[_0x541df6(0x23b)]=new plisioService_1[(_0x541df6(0x2a9))](),this[_0x541df6(0x2b9)]=new rapydService_1[(_0x541df6(0x279))](),this[_0x541df6(0x2d9)]=new nodaService_1[(_0x541df6(0x2a3))](),this[_0x541df6(0x2a5)]=new coinToPayService_1[(_0x541df6(0x298))](),this[_0x541df6(0x25c)]=new coinToPay2Service_1[(_0x541df6(0x1f6))](),this[_0x541df6(0x259)]=new klymeService_1[(_0x541df6(0x24b))](),this[_0x541df6(0x2ce)]=new mastercardService_1[(_0x541df6(0x23c))](),this[_0x541df6(0x200)]=new amerService_1[(_0x541df6(0x1f0))]();}async[a60_0x5038ae(0x1f3)](_0x519dab,_0x52bb33,_0x23eb75){const _0x459793=a60_0x5038ae;console['log'](_0x459793(0x293)+_0x519dab+',\x20newStatus='+_0x52bb33),console['log'](_0x459793(0x229),_0x23eb75),await database_1[_0x459793(0x2d8)][_0x459793(0x28a)](async _0x4a8b33=>{const _0x276dd7=_0x459793,_0x28e64a=await _0x4a8b33[_0x276dd7(0x277)][_0x276dd7(0x217)]({'where':{'id':_0x519dab},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x28e64a)throw new Error('Payment\x20'+_0x519dab+_0x276dd7(0x2da));const _0x65663e=_0x28e64a[_0x276dd7(0x287)],_0x3f31e8=_0x28e64a['shop'];console[_0x276dd7(0x22a)](_0x276dd7(0x282)+_0x519dab+':\x20'+_0x65663e+_0x276dd7(0x2d7)+_0x52bb33),console[_0x276dd7(0x22a)](_0x276dd7(0x24c)+_0x3f31e8[_0x276dd7(0x221)]+_0x276dd7(0x260)+_0x3f31e8[_0x276dd7(0x232)]+_0x276dd7(0x2be));const _0x2a6257={'status':_0x52bb33[_0x276dd7(0x2bd)](),'updatedAt':new Date(),'statusChangedBy':_0x276dd7(0x289),'statusChangedAt':new Date()};_0x23eb75?.['failureMessage']&&(_0x2a6257['failureMessage']=_0x23eb75[_0x276dd7(0x25e)]);_0x23eb75?.[_0x276dd7(0x2c5)]&&(_0x2a6257['txUrls']=JSON[_0x276dd7(0x2cd)](_0x23eb75[_0x276dd7(0x2c5)]));_0x23eb75?.[_0x276dd7(0x20e)]&&(_0x2a6257[_0x276dd7(0x20e)]=_0x23eb75[_0x276dd7(0x20e)]);_0x23eb75?.[_0x276dd7(0x244)]&&(_0x2a6257['paymentMethod']=_0x23eb75[_0x276dd7(0x244)]);_0x23eb75?.[_0x276dd7(0x21a)]&&(_0x2a6257[_0x276dd7(0x21a)]=_0x23eb75[_0x276dd7(0x21a)]);_0x23eb75?.[_0x276dd7(0x2c6)]&&(_0x2a6257['remitterIban']=_0x23eb75[_0x276dd7(0x2c6)]);_0x23eb75?.[_0x276dd7(0x263)]&&(_0x2a6257['remitterName']=_0x23eb75[_0x276dd7(0x263)]);let _0x2316c4=_0x3f31e8['balance'],_0x17e82f='';if(_0x52bb33[_0x276dd7(0x2bd)]()==='PAID'&&_0x65663e!==_0x276dd7(0x25d)){const _0x3c5ba5=await currencyService_1[_0x276dd7(0x2d5)][_0x276dd7(0x219)](_0x28e64a[_0x276dd7(0x275)],_0x28e64a[_0x276dd7(0x249)]),_0xfcf85=await this[_0x276dd7(0x27b)](_0x3f31e8['id'],_0x28e64a[_0x276dd7(0x297)]),_0x2424f4=_0x3c5ba5*(0x1-_0xfcf85/0x64);_0x2316c4+=_0x2424f4,_0x17e82f='+'+_0x2424f4['toFixed'](0x6)+_0x276dd7(0x264)+_0xfcf85+_0x276dd7(0x1ee),_0x2a6257['amountUSDT']=_0x3c5ba5,_0x2a6257[_0x276dd7(0x1e9)]=_0x2424f4,_0x2a6257[_0x276dd7(0x1fe)]=new Date(),console['log'](_0x276dd7(0x274)+_0x28e64a['amount']+'\x20'+_0x28e64a[_0x276dd7(0x249)]+_0x276dd7(0x2d7)+_0x3c5ba5[_0x276dd7(0x24e)](0x6)+'\x20USDT'),console['log'](_0x276dd7(0x255)+_0x28e64a[_0x276dd7(0x297)]+_0x276dd7(0x1e6)+_0xfcf85+'%'),console[_0x276dd7(0x22a)](_0x276dd7(0x2c4)+_0x2424f4[_0x276dd7(0x24e)](0x6)+_0x276dd7(0x2be)),console[_0x276dd7(0x22a)](_0x276dd7(0x281)+_0x3f31e8[_0x276dd7(0x232)]+_0x276dd7(0x2b3)+_0x2424f4[_0x276dd7(0x24e)](0x6)+_0x276dd7(0x24a)+_0x2316c4[_0x276dd7(0x24e)](0x6)+_0x276dd7(0x2be));}else{if(_0x65663e==='PAID'&&_0x52bb33[_0x276dd7(0x2bd)]()!==_0x276dd7(0x25d)){let _0x56df64;if(_0x28e64a[_0x276dd7(0x1e9)])_0x56df64=_0x28e64a[_0x276dd7(0x1e9)];else{if(_0x28e64a[_0x276dd7(0x1f5)]){const _0x1cecf2=await this[_0x276dd7(0x27b)](_0x3f31e8['id'],_0x28e64a[_0x276dd7(0x297)]);_0x56df64=_0x28e64a['amountUSDT']*(0x1-_0x1cecf2/0x64);}else console['log']('No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance'),_0x56df64=0x0;}_0x56df64>0x0&&(_0x2316c4-=_0x56df64,_0x17e82f='-'+_0x56df64[_0x276dd7(0x24e)](0x6)+_0x276dd7(0x295),_0x2a6257[_0x276dd7(0x1f5)]=null,_0x2a6257[_0x276dd7(0x1e9)]=null,_0x2a6257[_0x276dd7(0x1fe)]=null,console[_0x276dd7(0x22a)](_0x276dd7(0x1ea)+_0x3f31e8[_0x276dd7(0x232)]+_0x276dd7(0x256)+_0x56df64[_0x276dd7(0x24e)](0x6)+_0x276dd7(0x24a)+_0x2316c4[_0x276dd7(0x24e)](0x6)+_0x276dd7(0x2be)));}}if(_0x52bb33['toUpperCase']()==='CHARGEBACK'){const _0xd577f0=_0x23eb75?.[_0x276dd7(0x2b0)]||0x0;_0xd577f0>0x0&&(_0x2316c4-=_0xd577f0,_0x17e82f+=_0x276dd7(0x1f8)+_0xd577f0[_0x276dd7(0x24e)](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0x2a6257[_0x276dd7(0x2b0)]=_0xd577f0,console[_0x276dd7(0x22a)](_0x276dd7(0x20a)+_0xd577f0['toFixed'](0x6)+_0x276dd7(0x2be)),console[_0x276dd7(0x22a)](_0x276dd7(0x2ab)+_0x2316c4[_0x276dd7(0x24e)](0x6)+_0x276dd7(0x2be)));}const _0x4e8dff=await _0x4a8b33[_0x276dd7(0x277)][_0x276dd7(0x204)]({'where':{'id':_0x519dab},'data':_0x2a6257});_0x2316c4!==_0x3f31e8[_0x276dd7(0x232)]&&(await _0x4a8b33[_0x276dd7(0x1e8)][_0x276dd7(0x204)]({'where':{'id':_0x3f31e8['id']},'data':{'balance':_0x2316c4}}),console[_0x276dd7(0x22a)]('✅\x20Shop\x20'+_0x3f31e8[_0x276dd7(0x221)]+_0x276dd7(0x26f)+_0x3f31e8[_0x276dd7(0x232)]['toFixed'](0x6)+_0x276dd7(0x2d7)+_0x2316c4[_0x276dd7(0x24e)](0x6)+'\x20USDT'),console['log'](_0x276dd7(0x2cc)+_0x17e82f));await _0x4a8b33[_0x276dd7(0x2b2)]['create']({'data':{'paymentId':_0x519dab,'shopId':_0x3f31e8['id'],'event':_0x276dd7(0x2a8)+_0x52bb33[_0x276dd7(0x285)](),'statusCode':0xc8,'responseBody':JSON[_0x276dd7(0x2cd)]({'oldStatus':_0x65663e,'newStatus':_0x52bb33['toUpperCase'](),'balanceChange':_0x17e82f||'no\x20balance\x20change','oldBalance':_0x3f31e8[_0x276dd7(0x232)],'newBalance':_0x2316c4,'amountUSDT':_0x2a6257[_0x276dd7(0x1f5)],'additionalData':_0x23eb75,'timestamp':new Date()['toISOString']()})}}),await this[_0x276dd7(0x26b)]({..._0x28e64a,..._0x4e8dff,'shop':_0x3f31e8},_0x52bb33[_0x276dd7(0x2bd)]()),await this[_0x276dd7(0x228)]({..._0x28e64a,..._0x4e8dff},_0x52bb33[_0x276dd7(0x2bd)]());if(_0x65663e!==_0x276dd7(0x25d)&&_0x52bb33[_0x276dd7(0x2bd)]()===_0x276dd7(0x25d)){console[_0x276dd7(0x22a)]('📈\x20Payment\x20'+_0x519dab+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console['log'](_0x276dd7(0x1f9)+_0x65663e+_0x276dd7(0x27c)+_0x52bb33['toUpperCase']()+_0x276dd7(0x27d)+_0x28e64a['paymentLinkId']+'\x22');if(_0x28e64a[_0x276dd7(0x245)])try{const _0x266294=await _0x4a8b33[_0x276dd7(0x24f)][_0x276dd7(0x217)]({'where':{'id':_0x28e64a[_0x276dd7(0x245)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x266294){console[_0x276dd7(0x22a)](_0x276dd7(0x2bc)+_0x266294['id']+_0x276dd7(0x2d1)+_0x266294['type']+_0x276dd7(0x233)+_0x266294['currentPayments']+',\x20status='+_0x266294[_0x276dd7(0x287)]);const _0x10e950=_0x266294[_0x276dd7(0x268)]+0x1,_0x3929e0=_0x266294['type']===_0x276dd7(0x1ec)?_0x276dd7(0x25b):_0x266294[_0x276dd7(0x287)];await _0x4a8b33[_0x276dd7(0x24f)][_0x276dd7(0x204)]({'where':{'id':_0x28e64a['paymentLinkId']},'data':{'currentPayments':_0x10e950,'status':_0x3929e0,'updatedAt':new Date()}}),console[_0x276dd7(0x22a)](_0x276dd7(0x238)+_0x266294['id']+_0x276dd7(0x201)+_0x266294[_0x276dd7(0x268)]+_0x276dd7(0x2d7)+_0x10e950+',\x20status='+_0x266294[_0x276dd7(0x287)]+_0x276dd7(0x2d7)+_0x3929e0);}else console[_0x276dd7(0x22a)]('❌\x20Payment\x20link\x20'+_0x28e64a[_0x276dd7(0x245)]+'\x20not\x20found');}catch(_0xd05ebf){console['error'](_0x276dd7(0x2af),_0xd05ebf);}else console[_0x276dd7(0x22a)](_0x276dd7(0x292)+_0x519dab+_0x276dd7(0x290));}else console['log'](_0x276dd7(0x292)+_0x519dab+'\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20'+_0x65663e+_0x276dd7(0x2d7)+_0x52bb33[_0x276dd7(0x2bd)]());});}async[a60_0x5038ae(0x28d)](_0x2cd75b){const _0x108916=a60_0x5038ae;console['log'](_0x108916(0x253),_0x2cd75b);try{const _0x1713ca=await this[_0x108916(0x23b)]['processWebhook'](_0x2cd75b);if(!_0x1713ca['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0xc01141=await database_1[_0x108916(0x2d8)][_0x108916(0x277)][_0x108916(0x1f2)]({'where':{'gatewayOrderId':_0x1713ca[_0x108916(0x2bf)]}});if(!_0xc01141){console[_0x108916(0x23e)](_0x108916(0x21e)+_0x1713ca[_0x108916(0x2bf)]);return;}console[_0x108916(0x22a)](_0x108916(0x202)+_0xc01141['id']+_0x108916(0x29c)+_0x1713ca[_0x108916(0x287)]),await this[_0x108916(0x1f3)](_0xc01141['id'],_0x1713ca[_0x108916(0x287)],{'txUrls':_0x1713ca[_0x108916(0x2c5)]}),loggerService_1[_0x108916(0x2ca)][_0x108916(0x271)](_0x108916(0x27f),_0xc01141['id'],_0xc01141[_0x108916(0x287)],_0x1713ca[_0x108916(0x287)],_0x2cd75b);}catch(_0x12601a){console[_0x108916(0x23e)](_0x108916(0x21b),_0x12601a),loggerService_1[_0x108916(0x2ca)]['logWebhookError'](_0x108916(0x27f),_0x12601a,_0x2cd75b);throw _0x12601a;}}async[a60_0x5038ae(0x1fa)](_0x11058e){const _0x2ca9ac=a60_0x5038ae;console[_0x2ca9ac(0x22a)](_0x2ca9ac(0x22e),_0x11058e);try{const _0x5e7d26=await this[_0x2ca9ac(0x23b)][_0x2ca9ac(0x2a1)](_0x11058e);if(!_0x5e7d26[_0x2ca9ac(0x2bf)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x2ea3ef=await database_1[_0x2ca9ac(0x2d8)][_0x2ca9ac(0x277)][_0x2ca9ac(0x1f2)]({'where':{'gatewayOrderId':_0x5e7d26['paymentId']}});if(!_0x2ea3ef){console[_0x2ca9ac(0x23e)](_0x2ca9ac(0x239)+_0x5e7d26[_0x2ca9ac(0x2bf)]);return;}console[_0x2ca9ac(0x22a)](_0x2ca9ac(0x24d)+_0x2ea3ef['id']+'\x20status\x20'+_0x5e7d26['status']),await this['updatePaymentStatus'](_0x2ea3ef['id'],_0x5e7d26[_0x2ca9ac(0x287)],{'txUrls':_0x5e7d26['txUrls']}),loggerService_1[_0x2ca9ac(0x2ca)]['logWebhookProcessed'](_0x2ca9ac(0x1f1),_0x2ea3ef['id'],_0x2ea3ef[_0x2ca9ac(0x287)],_0x5e7d26[_0x2ca9ac(0x287)],_0x11058e);}catch(_0x5715c6){console[_0x2ca9ac(0x23e)](_0x2ca9ac(0x27a),_0x5715c6),loggerService_1[_0x2ca9ac(0x2ca)][_0x2ca9ac(0x212)]('plisio_gateway',_0x5715c6,_0x11058e);throw _0x5715c6;}}async[a60_0x5038ae(0x1ef)](_0x4f4d76){const _0x589dd1=a60_0x5038ae;console[_0x589dd1(0x22a)](_0x589dd1(0x22d),_0x4f4d76);try{const _0x46fdbd=await this[_0x589dd1(0x2b9)]['processWebhook'](_0x4f4d76);if(!_0x46fdbd['paymentId'])throw new Error(_0x589dd1(0x2c0));const _0x169f52=await database_1[_0x589dd1(0x2d8)][_0x589dd1(0x277)]['findFirst']({'where':{'gatewayOrderId':_0x46fdbd[_0x589dd1(0x2bf)]}});if(!_0x169f52){console[_0x589dd1(0x23e)](_0x589dd1(0x269)+_0x46fdbd[_0x589dd1(0x2bf)]);return;}console[_0x589dd1(0x22a)](_0x589dd1(0x203)+_0x169f52['id']+_0x589dd1(0x29c)+_0x46fdbd['status']),await this[_0x589dd1(0x1f3)](_0x169f52['id'],_0x46fdbd[_0x589dd1(0x287)],{'failureMessage':_0x46fdbd[_0x589dd1(0x25e)],'cardLast4':_0x46fdbd['additionalInfo']?.[_0x589dd1(0x20e)],'paymentMethod':_0x46fdbd['additionalInfo']?.[_0x589dd1(0x244)]}),loggerService_1[_0x589dd1(0x2ca)]['logWebhookProcessed'](_0x589dd1(0x20f),_0x169f52['id'],_0x169f52[_0x589dd1(0x287)],_0x46fdbd[_0x589dd1(0x287)],_0x4f4d76);}catch(_0x400ce8){console[_0x589dd1(0x23e)](_0x589dd1(0x2cf),_0x400ce8),loggerService_1[_0x589dd1(0x2ca)][_0x589dd1(0x212)](_0x589dd1(0x20f),_0x400ce8,_0x4f4d76);throw _0x400ce8;}}async['processNodaWebhook'](_0x98482b){const _0x3d277d=a60_0x5038ae;console['log']('🔄\x20Processing\x20Noda\x20webhook:',_0x98482b);try{const _0x3f00ef=await this['nodaService'][_0x3d277d(0x2a1)](_0x98482b);if(!_0x3f00ef[_0x3d277d(0x2bf)])throw new Error('No\x20payment\x20ID\x20in\x20Noda\x20webhook');const _0x1266a1=await database_1[_0x3d277d(0x2d8)][_0x3d277d(0x277)][_0x3d277d(0x1f2)]({'where':{'gatewayOrderId':_0x3f00ef[_0x3d277d(0x2bf)]}});if(!_0x1266a1){console[_0x3d277d(0x23e)]('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x3f00ef[_0x3d277d(0x2bf)]);return;}console['log'](_0x3d277d(0x2c1)+_0x1266a1['id']+_0x3d277d(0x29c)+_0x3f00ef[_0x3d277d(0x287)]),await this[_0x3d277d(0x1f3)](_0x1266a1['id'],_0x3f00ef[_0x3d277d(0x287)],{'bankId':_0x3f00ef['additionalInfo']?.[_0x3d277d(0x21a)],'remitterIban':_0x3f00ef['additionalInfo']?.[_0x3d277d(0x2c6)],'remitterName':_0x3f00ef['additionalInfo']?.[_0x3d277d(0x263)]}),loggerService_1[_0x3d277d(0x2ca)]['logWebhookProcessed']('noda',_0x1266a1['id'],_0x1266a1[_0x3d277d(0x287)],_0x3f00ef[_0x3d277d(0x287)],_0x98482b);}catch(_0x251de2){console['error'](_0x3d277d(0x288),_0x251de2),loggerService_1[_0x3d277d(0x2ca)]['logWebhookError']('noda',_0x251de2,_0x98482b);throw _0x251de2;}}async['processCoinToPayWebhook'](_0x4ecf26){const _0x146d3b=a60_0x5038ae;console[_0x146d3b(0x22a)](_0x146d3b(0x250),_0x4ecf26);try{const _0x47a5d4=await this['coinToPayService']['processWebhook'](_0x4ecf26);if(!_0x47a5d4[_0x146d3b(0x2bf)])throw new Error(_0x146d3b(0x29b));const _0x4fe59a=await database_1[_0x146d3b(0x2d8)][_0x146d3b(0x277)]['findFirst']({'where':{'gatewayOrderId':_0x47a5d4[_0x146d3b(0x2bf)]}});if(!_0x4fe59a){console[_0x146d3b(0x23e)](_0x146d3b(0x296)+_0x47a5d4[_0x146d3b(0x2bf)]);return;}console[_0x146d3b(0x22a)](_0x146d3b(0x286)+_0x4fe59a['id']+_0x146d3b(0x29c)+_0x47a5d4[_0x146d3b(0x287)]),await this[_0x146d3b(0x1f3)](_0x4fe59a['id'],_0x47a5d4[_0x146d3b(0x287)]),loggerService_1[_0x146d3b(0x2ca)][_0x146d3b(0x271)]('cointopay',_0x4fe59a['id'],_0x4fe59a['status'],_0x47a5d4['status'],_0x4ecf26);}catch(_0x4ef6c0){console[_0x146d3b(0x23e)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x4ef6c0),loggerService_1[_0x146d3b(0x2ca)][_0x146d3b(0x212)]('cointopay',_0x4ef6c0,_0x4ecf26);throw _0x4ef6c0;}}async[a60_0x5038ae(0x209)](_0x4051da){const _0x33fc3d=a60_0x5038ae;console[_0x33fc3d(0x22a)](_0x33fc3d(0x223),_0x4051da);try{const _0x323082=await this['coinToPay2Service']['processWebhook'](_0x4051da);if(!_0x323082[_0x33fc3d(0x2bf)])throw new Error(_0x33fc3d(0x234));const _0x4c1d70=await database_1[_0x33fc3d(0x2d8)][_0x33fc3d(0x277)][_0x33fc3d(0x1f2)]({'where':{'gatewayOrderId':_0x323082[_0x33fc3d(0x2bf)]}});if(!_0x4c1d70){console[_0x33fc3d(0x23e)](_0x33fc3d(0x28b)+_0x323082[_0x33fc3d(0x2bf)]);return;}console[_0x33fc3d(0x22a)](_0x33fc3d(0x247)+_0x4c1d70['id']+'\x20status\x20'+_0x323082[_0x33fc3d(0x287)]),await this['updatePaymentStatus'](_0x4c1d70['id'],_0x323082[_0x33fc3d(0x287)]),loggerService_1[_0x33fc3d(0x2ca)][_0x33fc3d(0x271)](_0x33fc3d(0x23f),_0x4c1d70['id'],_0x4c1d70[_0x33fc3d(0x287)],_0x323082[_0x33fc3d(0x287)],_0x4051da);}catch(_0x381fca){console['error'](_0x33fc3d(0x29a),_0x381fca),loggerService_1[_0x33fc3d(0x2ca)][_0x33fc3d(0x212)](_0x33fc3d(0x23f),_0x381fca,_0x4051da);throw _0x381fca;}}async[a60_0x5038ae(0x21c)](_0x4c55b1){const _0x36f023=a60_0x5038ae;console[_0x36f023(0x22a)](_0x36f023(0x272),_0x4c55b1);try{const _0x3e11fa=await this[_0x36f023(0x259)][_0x36f023(0x2a1)](_0x4c55b1);if(!_0x3e11fa[_0x36f023(0x2bf)])throw new Error(_0x36f023(0x29d));const _0x326824=await database_1[_0x36f023(0x2d8)][_0x36f023(0x277)]['findFirst']({'where':{'gatewayOrderId':_0x3e11fa[_0x36f023(0x2bf)]}});if(!_0x326824){console[_0x36f023(0x23e)](_0x36f023(0x284)+_0x3e11fa[_0x36f023(0x2bf)]);return;}console[_0x36f023(0x22a)]('📊\x20KLYME\x20webhook:\x20Payment\x20'+_0x326824['id']+'\x20status\x20'+_0x3e11fa['status']),await this[_0x36f023(0x1f3)](_0x326824['id'],_0x3e11fa[_0x36f023(0x287)],{'paymentMethod':_0x3e11fa[_0x36f023(0x215)]?.[_0x36f023(0x252)]}),loggerService_1['loggerService'][_0x36f023(0x271)](_0x36f023(0x1f7),_0x326824['id'],_0x326824[_0x36f023(0x287)],_0x3e11fa[_0x36f023(0x287)],_0x4c55b1);}catch(_0x2239cd){console[_0x36f023(0x23e)](_0x36f023(0x214),_0x2239cd),loggerService_1[_0x36f023(0x2ca)]['logWebhookError'](_0x36f023(0x1f7),_0x2239cd,_0x4c55b1);throw _0x2239cd;}}async[a60_0x5038ae(0x225)](_0x4fdc98){const _0x3611cd=a60_0x5038ae;console[_0x3611cd(0x22a)]('🔄\x20Processing\x20MasterCard\x20webhook:',JSON[_0x3611cd(0x2cd)](_0x4fdc98,null,0x2));try{const _0x16f7ee=await this['masterCardService'][_0x3611cd(0x2a1)](_0x4fdc98);console[_0x3611cd(0x22a)](_0x3611cd(0x21f),_0x16f7ee);if(!_0x16f7ee[_0x3611cd(0x2bf)]){console[_0x3611cd(0x23e)](_0x3611cd(0x29e)),console[_0x3611cd(0x23e)](_0x3611cd(0x258),Object[_0x3611cd(0x276)](_0x4fdc98));throw new Error(_0x3611cd(0x280));}let _0x296c22=null;console[_0x3611cd(0x22a)](_0x3611cd(0x2d0)+_0x16f7ee[_0x3611cd(0x2bf)]);_0x16f7ee[_0x3611cd(0x2bf)]&&(console[_0x3611cd(0x22a)](_0x3611cd(0x205)),_0x296c22=await database_1[_0x3611cd(0x2d8)][_0x3611cd(0x277)][_0x3611cd(0x1f2)]({'where':{'AND':[{'gateway':_0x3611cd(0x26c)},{'OR':[{'gatewayPaymentId':_0x16f7ee['paymentId']},{'gatewayOrderId':_0x16f7ee[_0x3611cd(0x2bf)]},{'id':_0x16f7ee[_0x3611cd(0x2bf)]},{'orderId':_0x16f7ee['paymentId']}]}]}}),console[_0x3611cd(0x22a)](_0x3611cd(0x226)+(_0x296c22?_0x3611cd(0x210)+_0x296c22['id']:_0x3611cd(0x262))));if(!_0x296c22){console['error'](_0x3611cd(0x261)+_0x16f7ee['paymentId']),console[_0x3611cd(0x23e)]('🔍\x20Searched\x20by:\x20gatewayOrderId=\x22'+_0x16f7ee[_0x3611cd(0x2bf)]+_0x3611cd(0x1e7)+_0x16f7ee['paymentId']+'\x22,\x20orderId=\x22'+_0x16f7ee[_0x3611cd(0x2bf)]+'\x22');const _0x5babbc=await database_1[_0x3611cd(0x2d8)][_0x3611cd(0x277)][_0x3611cd(0x26e)]({'where':{'gateway':_0x3611cd(0x26c)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x3611cd(0x22a)](_0x3611cd(0x278),_0x5babbc);return;}console[_0x3611cd(0x22a)](_0x3611cd(0x1ff)+_0x296c22['id']+_0x3611cd(0x2b6)+_0x296c22[_0x3611cd(0x287)]+_0x3611cd(0x248)+_0x16f7ee[_0x3611cd(0x287)]),await this['updatePaymentStatus'](_0x296c22['id'],_0x16f7ee[_0x3611cd(0x287)]),loggerService_1['loggerService']['logWebhookProcessed'](_0x3611cd(0x26c),_0x296c22['id'],_0x296c22['status'],_0x16f7ee[_0x3611cd(0x287)],_0x4fdc98);}catch(_0x3e56b4){console[_0x3611cd(0x23e)](_0x3611cd(0x251),_0x3e56b4),loggerService_1[_0x3611cd(0x2ca)][_0x3611cd(0x212)]('mastercard',_0x3e56b4,_0x4fdc98);throw _0x3e56b4;}}async[a60_0x5038ae(0x2b4)](_0x273d41){const _0x164923=a60_0x5038ae;console['log'](_0x164923(0x2d6),JSON[_0x164923(0x2cd)](_0x273d41,null,0x2));try{const _0x51a709=await this['amerService'][_0x164923(0x2a1)](_0x273d41);console[_0x164923(0x22a)]('📊\x20Amer\x20webhook\x20result:',_0x51a709);if(!_0x51a709['paymentId']){console['error'](_0x164923(0x1fd)),console[_0x164923(0x23e)](_0x164923(0x258),Object[_0x164923(0x276)](_0x273d41));throw new Error(_0x164923(0x21d));}let _0xe964e1=null;console[_0x164923(0x22a)](_0x164923(0x1eb)+_0x51a709[_0x164923(0x2bf)]),_0xe964e1=await database_1[_0x164923(0x2d8)][_0x164923(0x277)][_0x164923(0x1f2)]({'where':{'AND':[{'gateway':_0x164923(0x236)},{'OR':[{'gatewayPaymentId':_0x51a709[_0x164923(0x2bf)]},{'gatewayOrderId':_0x51a709[_0x164923(0x2bf)]},{'id':_0x51a709[_0x164923(0x2bf)]},{'orderId':_0x51a709[_0x164923(0x2bf)]}]}]}}),console[_0x164923(0x22a)](_0x164923(0x226)+(_0xe964e1?_0x164923(0x210)+_0xe964e1['id']:_0x164923(0x262)));if(!_0xe964e1){console['error'](_0x164923(0x206)+_0x51a709['paymentId']);return;}console[_0x164923(0x22a)](_0x164923(0x254)+_0xe964e1['id']+_0x164923(0x29c)+_0x51a709['status']),await this[_0x164923(0x1f3)](_0xe964e1['id'],_0x51a709[_0x164923(0x287)],{'cardLast4':_0x51a709[_0x164923(0x215)]?.[_0x164923(0x20e)],'paymentMethod':_0x51a709[_0x164923(0x215)]?.[_0x164923(0x244)]});}catch(_0x2185e1){console['error'](_0x164923(0x246),_0x2185e1),loggerService_1[_0x164923(0x2ca)][_0x164923(0x212)](_0x164923(0x236),_0x2185e1,_0x273d41);throw _0x2185e1;}}async['sendShopWebhook'](_0x4a0465,_0x182e4b){const _0x1eabc5=a60_0x5038ae,_0xeedcb1=Date[_0x1eabc5(0x220)]();try{const _0x41ef36=_0x4a0465[_0x1eabc5(0x1e8)],_0x42ee06=_0x41ef36[_0x1eabc5(0x2a2)];if(!_0x42ee06?.['webhookUrl']){console[_0x1eabc5(0x22a)](_0x1eabc5(0x26a)+_0x41ef36['id']);return;}const _0x4495e1=_0x182e4b===_0x1eabc5(0x25d)?_0x1eabc5(0x26d):_0x182e4b===_0x1eabc5(0x2a4)?'payment.failed':_0x182e4b===_0x1eabc5(0x1f4)?'payment.failed':_0x182e4b==='CHARGEBACK'?_0x1eabc5(0x224):_0x182e4b===_0x1eabc5(0x2ba)?_0x1eabc5(0x224):_0x1eabc5(0x207);let _0x34a20e=[];if(_0x42ee06[_0x1eabc5(0x2d4)])try{_0x34a20e=Array[_0x1eabc5(0x28c)](_0x42ee06[_0x1eabc5(0x2d4)])?_0x42ee06[_0x1eabc5(0x2d4)]:JSON[_0x1eabc5(0x291)](_0x42ee06[_0x1eabc5(0x2d4)]);}catch(_0x53bc91){console[_0x1eabc5(0x23e)](_0x1eabc5(0x1fc),_0x53bc91),_0x34a20e=[];}if(!_0x34a20e['includes'](_0x4495e1)){console[_0x1eabc5(0x22a)](_0x1eabc5(0x20b)+_0x4495e1+'\x20not\x20enabled\x20for\x20shop\x20'+_0x41ef36['id']);return;}const _0x46eee6={'event':_0x4495e1,'payment':{'id':_0x4a0465['id'],'order_id':_0x4a0465[_0x1eabc5(0x28f)],'gateway_order_id':_0x4a0465[_0x1eabc5(0x2c7)],'gateway':_0x4a0465[_0x1eabc5(0x297)],'amount':_0x4a0465[_0x1eabc5(0x275)],'currency':_0x4a0465['currency'],'status':_0x182e4b[_0x1eabc5(0x285)](),'customer_email':_0x4a0465[_0x1eabc5(0x2a0)],'customer_name':_0x4a0465[_0x1eabc5(0x242)],'failure_message':_0x4a0465[_0x1eabc5(0x25e)],'tx_urls':_0x4a0465[_0x1eabc5(0x2c5)]?JSON[_0x1eabc5(0x291)](_0x4a0465[_0x1eabc5(0x2c5)]):null,'created_at':_0x4a0465[_0x1eabc5(0x243)],'updated_at':_0x4a0465[_0x1eabc5(0x28e)]}},_0x460a49=await fetch(_0x42ee06[_0x1eabc5(0x2ae)],{'method':_0x1eabc5(0x22c),'headers':{'Content-Type':_0x1eabc5(0x2cb),'User-Agent':_0x1eabc5(0x2b8)},'body':JSON['stringify'](_0x46eee6)}),_0x58bce1=Date[_0x1eabc5(0x220)]()-_0xeedcb1,_0x48db58=_0x460a49['ok']?_0x1eabc5(0x294):await _0x460a49[_0x1eabc5(0x2b5)]();loggerService_1['loggerService'][_0x1eabc5(0x211)](_0x4a0465[_0x1eabc5(0x265)],_0x42ee06[_0x1eabc5(0x2ae)],_0x4495e1,_0x460a49['status'],_0x58bce1,_0x46eee6),console[_0x1eabc5(0x22a)](_0x1eabc5(0x227)+_0x42ee06[_0x1eabc5(0x2ae)]+_0x1eabc5(0x230)+_0x460a49['status']+'\x20('+_0x58bce1+_0x1eabc5(0x2bb));}catch(_0x34ca72){console[_0x1eabc5(0x23e)](_0x1eabc5(0x23d),_0x34ca72),loggerService_1[_0x1eabc5(0x2ca)]['logShopWebhookError'](_0x4a0465[_0x1eabc5(0x265)],_0x4a0465['shop']?.[_0x1eabc5(0x2a2)]?.['webhookUrl']||_0x1eabc5(0x2ad),'webhook_send',_0x34ca72,{});}}async[a60_0x5038ae(0x228)](_0x570a49,_0xa6c741){const _0x3d2482=a60_0x5038ae;try{const _0x397d3d={'PENDING':'created','PROCESSING':'processing','PAID':_0x3d2482(0x231),'FAILED':_0x3d2482(0x2d3),'EXPIRED':'expired','REFUND':_0x3d2482(0x2c3),'CHARGEBACK':_0x3d2482(0x20c)},_0x45d24f=_0x397d3d[_0xa6c741];if(!_0x45d24f||_0x45d24f===_0x3d2482(0x222))return;await telegramBotService_1['telegramBotService'][_0x3d2482(0x2c2)](_0x570a49[_0x3d2482(0x265)],_0x570a49,_0x45d24f);}catch(_0x3edbdd){console[_0x3d2482(0x23e)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x3edbdd);}}async[a60_0x5038ae(0x27b)](_0x545913,_0x4ec8d8){const _0x4c9f70=a60_0x5038ae;try{const _0x86c473=await database_1[_0x4c9f70(0x2d8)]['shop']['findUnique']({'where':{'id':_0x545913},'select':{'gatewaySettings':!![]}});if(!_0x86c473?.['gatewaySettings'])return console[_0x4c9f70(0x22a)](_0x4c9f70(0x273)+_0x545913+_0x4c9f70(0x241)),0xa;const _0x5ce397=JSON[_0x4c9f70(0x291)](_0x86c473[_0x4c9f70(0x208)]);for(const [_0x52ce2d,_0x1832a2]of Object['entries'](_0x5ce397)){if(_0x52ce2d['toLowerCase']()===_0x4ec8d8[_0x4c9f70(0x285)]()){const _0x4f4b06=_0x1832a2[_0x4c9f70(0x1fb)]||0xa;return console[_0x4c9f70(0x22a)](_0x4c9f70(0x27e)+_0x4ec8d8+'\x20commission\x20for\x20shop\x20'+_0x545913+':\x20'+_0x4f4b06+'%'),_0x4f4b06;}}return console['log']('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0x4ec8d8+_0x4c9f70(0x257)+_0x545913+_0x4c9f70(0x25a)),0xa;}catch(_0x26a236){return console[_0x4c9f70(0x23e)](_0x4c9f70(0x2b7)+_0x545913+_0x4c9f70(0x22f)+_0x4ec8d8+':',_0x26a236),0xa;}}}function a60_0x3e87(_0x2dd142,_0x9e7154){const _0x38ca9b=a60_0x38ca();return a60_0x3e87=function(_0x3e876c,_0x5d0e4d){_0x3e876c=_0x3e876c-0x1e6;let _0x41141d=_0x38ca9b[_0x3e876c];return _0x41141d;},a60_0x3e87(_0x2dd142,_0x9e7154);}exports[a60_0x5038ae(0x22b)]=WebhookService;