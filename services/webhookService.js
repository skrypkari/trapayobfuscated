'use strict';const a52_0x2ba5f1=a52_0x3951;function a52_0x3951(_0x1750d0,_0x26d134){const _0x106b8f=a52_0x106b();return a52_0x3951=function(_0x3951c3,_0xa16ca){_0x3951c3=_0x3951c3-0x93;let _0x146831=_0x106b8f[_0x3951c3];return _0x146831;},a52_0x3951(_0x1750d0,_0x26d134);}(function(_0x39542f,_0x5294ee){const _0x41be59=a52_0x3951,_0x4ec299=_0x39542f();while(!![]){try{const _0x5a8ef3=parseInt(_0x41be59(0x112))/0x1*(parseInt(_0x41be59(0xa7))/0x2)+parseInt(_0x41be59(0xea))/0x3+-parseInt(_0x41be59(0xf5))/0x4+-parseInt(_0x41be59(0xe9))/0x5*(-parseInt(_0x41be59(0xfa))/0x6)+-parseInt(_0x41be59(0xb2))/0x7*(-parseInt(_0x41be59(0x11e))/0x8)+-parseInt(_0x41be59(0x10d))/0x9*(parseInt(_0x41be59(0xbc))/0xa)+-parseInt(_0x41be59(0x122))/0xb*(-parseInt(_0x41be59(0x10f))/0xc);if(_0x5a8ef3===_0x5294ee)break;else _0x4ec299['push'](_0x4ec299['shift']());}catch(_0x567001){_0x4ec299['push'](_0x4ec299['shift']());}}}(a52_0x106b,0x543e5));var __importDefault=this&&this[a52_0x2ba5f1(0x102)]||function(_0x2aa6f0){return _0x2aa6f0&&_0x2aa6f0['__esModule']?_0x2aa6f0:{'default':_0x2aa6f0};};function a52_0x106b(){const _0x3e31cb=['Processing\x20Noda\x20webhook:','shopId','__esModule','webhook_send','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook','paymentId','Error\x20processing\x20Plisio\x20webhook:','remitterIban','gatewayOrderId','281035IcVDHv','928215CdOTdq','created','failed','\x20status\x20unchanged\x20(','paymentMethod','Processing\x20KLYME\x20webhook:','Success','now','processCoinToPayWebhook','telegramBotService','processRapydWebhook','1344148XrohvD','processWebhook','amount','paidAt','RapydService','6RPfBRl','âœ…\x20Payment\x20','klyme','status','logWebhookProcessed','updatePaymentStatus','processPlisioGatewayWebhook','No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook','__importDefault','Error\x20processing\x20Rapyd\x20webhook:','ðŸ’¾\x20Failure\x20message\x20saved:\x20','isArray','txUrls','Payment\x20','text','Processing\x20CoinToPay\x20webhook:','rapyd','payment','POST','2585889nxvztl','TesSoft\x20Payment\x20System/1.0','12HjkFqr','region','webhookUrl','63892GvZBHG','error','Error\x20parsing\x20tx_urls\x20for\x20webhook:','\x20URLs','\x20->\x20','payment.pending','rapydService','./telegramBotService','length','sendPaymentStatusNotification','ðŸ”„\x20Updating\x20payment\x20','Error\x20parsing\x20webhook\x20events:','1085320bbuauI','No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook','No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook','No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook','3732938liAUqV','expired','WebhookService','_webhook_','\x20status\x20to\x20','additionalInfo','\x20webhook','Shop\x20webhook\x20sent\x20to\x20','NodaService','webhookEvents','unknown','plisioService','remitterName','settings','bankId','loggerService','./paymentLinkService','ms)','payment.success','cardLast4','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','Failed\x20to\x20update\x20payment\x20link\x20counter:','processPlisioWebhook','\x20not\x20enabled\x20for\x20shop\x20','\x20updated\x20successfully:\x20','4ZbhXGA','orderId','Failed\x20to\x20send\x20shop\x20webhook:','PENDING','parse','plisio_gateway','Error\x20processing\x20CoinToPay\x20webhook:','./gateways/rapydService','paymentLinkService','customerEmail','ðŸ’¥\x20Payment\x20','7dbGsjy','PAID','stringify','application/json','./gateways/klymeService','createdAt','cointopay','../config/database','webhookLog','FAILED','10wPEuoe','\x20transaction\x20URLs:','customerName','sendShopWebhook','processKlymeWebhook','log','Error\x20processing\x20Noda\x20webhook:','gateway','./loggerService','klymeService','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook','create','includes','noda','coinToPayService','ðŸ”—\x20Payment\x20','klyme_','shop','plisio','\x20with\x20status\x20','EXPIRED','failureMessage','payment.failed','update','\x20status\x20change:\x20','Processing\x20Plisio\x20webhook:','logWebhookError','toLowerCase','Processing\x20Rapyd\x20webhook:','handleSuccessfulPayment','defineProperty','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','findFirst','ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20','Processing\x20Plisio\x20Gateway\x20webhook:','CoinToPayService'];a52_0x106b=function(){return _0x3e31cb;};return a52_0x106b();}Object[a52_0x2ba5f1(0xda)](exports,a52_0x2ba5f1(0xe2),{'value':!![]}),exports[a52_0x2ba5f1(0x124)]=void 0x0;const database_1=__importDefault(require(a52_0x2ba5f1(0xb9))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a52_0x2ba5f1(0xae)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require(a52_0x2ba5f1(0xb6)),telegramBotService_1=require(a52_0x2ba5f1(0x119)),paymentLinkService_1=require(a52_0x2ba5f1(0x9c)),loggerService_1=require(a52_0x2ba5f1(0xc4));class WebhookService{constructor(){const _0x34b8f8=a52_0x2ba5f1;this[_0x34b8f8(0x97)]=new plisioService_1['PlisioService'](),this[_0x34b8f8(0x118)]=new rapydService_1[(_0x34b8f8(0xf9))](),this['nodaService']=new nodaService_1[(_0x34b8f8(0x94))](),this[_0x34b8f8(0xca)]=new coinToPayService_1[(_0x34b8f8(0xdf))](),this['klymeService']=new klymeService_1['KlymeService'](),this['paymentLinkService']=new paymentLinkService_1['PaymentLinkService']();}async[a52_0x2ba5f1(0xa4)](_0x331ee6){const _0x3acd6f=a52_0x2ba5f1;console['log'](_0x3acd6f(0xd5),_0x331ee6);try{const _0x13b06d=await this[_0x3acd6f(0x97)]['processWebhook'](_0x331ee6);if(!_0x13b06d[_0x3acd6f(0xe5)]){console[_0x3acd6f(0x113)](_0x3acd6f(0xc6));return;}await this[_0x3acd6f(0xff)](_0x13b06d['paymentId'],_0x13b06d[_0x3acd6f(0xfd)],_0x3acd6f(0xce),_0x331ee6,undefined,undefined,_0x13b06d['txUrls']),loggerService_1['loggerService'][_0x3acd6f(0xfe)](_0x3acd6f(0xce),_0x13b06d[_0x3acd6f(0xe5)],_0x3acd6f(0xaa),_0x13b06d[_0x3acd6f(0xfd)],_0x331ee6);}catch(_0x3204a4){console[_0x3acd6f(0x113)](_0x3acd6f(0xe6),_0x3204a4),loggerService_1[_0x3acd6f(0x9b)][_0x3acd6f(0xd6)](_0x3acd6f(0xce),_0x3204a4,_0x331ee6);throw _0x3204a4;}}async[a52_0x2ba5f1(0x100)](_0x41aad0){const _0x26c170=a52_0x2ba5f1;console[_0x26c170(0xc1)](_0x26c170(0xde),_0x41aad0);try{const _0x1b66d9=await this[_0x26c170(0x97)]['processWebhook'](_0x41aad0);if(!_0x1b66d9[_0x26c170(0xe5)]){console[_0x26c170(0x113)](_0x26c170(0xe4));return;}await this[_0x26c170(0xff)](_0x1b66d9[_0x26c170(0xe5)],_0x1b66d9[_0x26c170(0xfd)],'plisio',_0x41aad0,undefined,undefined,_0x1b66d9[_0x26c170(0x106)]),loggerService_1[_0x26c170(0x9b)][_0x26c170(0xfe)](_0x26c170(0xac),_0x1b66d9[_0x26c170(0xe5)],_0x26c170(0xaa),_0x1b66d9[_0x26c170(0xfd)],_0x41aad0);}catch(_0x48c9f0){console[_0x26c170(0x113)](_0x26c170(0xa2),_0x48c9f0),loggerService_1[_0x26c170(0x9b)]['logWebhookError'](_0x26c170(0xac),_0x48c9f0,_0x41aad0);throw _0x48c9f0;}}async[a52_0x2ba5f1(0xf4)](_0x429d37){const _0x3b1b1e=a52_0x2ba5f1;console[_0x3b1b1e(0xc1)](_0x3b1b1e(0xd8),_0x429d37);try{const _0x3344ea=await this['rapydService'][_0x3b1b1e(0xf6)](_0x429d37);if(!_0x3344ea[_0x3b1b1e(0xe5)]){console[_0x3b1b1e(0x113)](_0x3b1b1e(0x11f));return;}await this[_0x3b1b1e(0xff)](_0x3344ea['paymentId'],_0x3344ea[_0x3b1b1e(0xfd)],_0x3b1b1e(0x10a),_0x429d37,_0x3344ea['failureMessage'],_0x3344ea[_0x3b1b1e(0x127)]),loggerService_1[_0x3b1b1e(0x9b)]['logWebhookProcessed']('rapyd',_0x3344ea[_0x3b1b1e(0xe5)],_0x3b1b1e(0xaa),_0x3344ea[_0x3b1b1e(0xfd)],_0x429d37);}catch(_0x2b3481){console[_0x3b1b1e(0x113)](_0x3b1b1e(0x103),_0x2b3481),loggerService_1['loggerService'][_0x3b1b1e(0xd6)](_0x3b1b1e(0x10a),_0x2b3481,_0x429d37);throw _0x2b3481;}}async['processNodaWebhook'](_0xf66284){const _0x25cdf4=a52_0x2ba5f1;console['log'](_0x25cdf4(0xe0),_0xf66284);try{const _0x52b32d=await this['nodaService']['processWebhook'](_0xf66284);if(!_0x52b32d[_0x25cdf4(0xe5)]){console[_0x25cdf4(0x113)](_0x25cdf4(0x101));return;}await this[_0x25cdf4(0xff)](_0x52b32d['paymentId'],_0x52b32d['status'],'noda',_0xf66284,undefined,_0x52b32d['additionalInfo']),loggerService_1[_0x25cdf4(0x9b)][_0x25cdf4(0xfe)](_0x25cdf4(0xc9),_0x52b32d[_0x25cdf4(0xe5)],_0x25cdf4(0xaa),_0x52b32d['status'],_0xf66284);}catch(_0x337364){console[_0x25cdf4(0x113)](_0x25cdf4(0xc2),_0x337364),loggerService_1[_0x25cdf4(0x9b)][_0x25cdf4(0xd6)](_0x25cdf4(0xc9),_0x337364,_0xf66284);throw _0x337364;}}async[a52_0x2ba5f1(0xf2)](_0x18dce4){const _0x1b0830=a52_0x2ba5f1;console[_0x1b0830(0xc1)](_0x1b0830(0x109),_0x18dce4);try{const _0x288dae=await this[_0x1b0830(0xca)][_0x1b0830(0xf6)](_0x18dce4);if(!_0x288dae[_0x1b0830(0xe5)]){console['error'](_0x1b0830(0x121));return;}await this[_0x1b0830(0xff)](_0x288dae[_0x1b0830(0xe5)],_0x288dae[_0x1b0830(0xfd)],'cointopay',_0x18dce4),loggerService_1[_0x1b0830(0x9b)][_0x1b0830(0xfe)](_0x1b0830(0xb8),_0x288dae[_0x1b0830(0xe5)],'PENDING',_0x288dae[_0x1b0830(0xfd)],_0x18dce4);}catch(_0x827572){console['error'](_0x1b0830(0xad),_0x827572),loggerService_1[_0x1b0830(0x9b)][_0x1b0830(0xd6)](_0x1b0830(0xb8),_0x827572,_0x18dce4);throw _0x827572;}}async[a52_0x2ba5f1(0xc0)](_0x473ce3){const _0x5ce6ae=a52_0x2ba5f1;console[_0x5ce6ae(0xc1)](_0x5ce6ae(0xef),_0x473ce3);try{const _0x369e65=await this[_0x5ce6ae(0xc5)][_0x5ce6ae(0xf6)](_0x473ce3);if(!_0x369e65['paymentId']){console[_0x5ce6ae(0x113)](_0x5ce6ae(0x120));return;}const _0x116433=_0x369e65['region']?_0x5ce6ae(0xcc)+_0x369e65[_0x5ce6ae(0x110)][_0x5ce6ae(0xd7)]():'klyme_eu';await this['updatePaymentStatus'](_0x369e65[_0x5ce6ae(0xe5)],_0x369e65[_0x5ce6ae(0xfd)],_0x116433,_0x473ce3,undefined,_0x369e65['additionalInfo']),loggerService_1[_0x5ce6ae(0x9b)][_0x5ce6ae(0xfe)](_0x5ce6ae(0xfc),_0x369e65[_0x5ce6ae(0xe5)],'PENDING',_0x369e65[_0x5ce6ae(0xfd)],_0x473ce3);}catch(_0x1aae5c){console['error']('Error\x20processing\x20KLYME\x20webhook:',_0x1aae5c),loggerService_1['loggerService'][_0x5ce6ae(0xd6)](_0x5ce6ae(0xfc),_0x1aae5c,_0x473ce3);throw _0x1aae5c;}}async[a52_0x2ba5f1(0xff)](_0x9e900f,_0x27ad25,_0x1b6abb,_0x326572,_0x1d4dae,_0x4cca3b,_0x54e13b){const _0x549aa5=a52_0x2ba5f1;console[_0x549aa5(0xc1)](_0x549aa5(0x11c)+_0x9e900f+_0x549aa5(0x126)+_0x27ad25+'\x20from\x20'+_0x1b6abb+_0x549aa5(0x128));_0x1d4dae&&console[_0x549aa5(0xc1)](_0x549aa5(0xb1)+_0x9e900f+'\x20failure\x20message:\x20'+_0x1d4dae);_0x54e13b&&_0x54e13b['length']>0x0&&console['log'](_0x549aa5(0xcb)+_0x9e900f+_0x549aa5(0xbd),_0x54e13b);const _0x1ac450=await database_1['default'][_0x549aa5(0x10b)][_0x549aa5(0xdc)]({'where':{'gatewayOrderId':_0x9e900f,'gateway':_0x1b6abb},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1ac450){console[_0x549aa5(0x113)](_0x549aa5(0xa0)+_0x9e900f+'\x20and\x20gateway:\x20'+_0x1b6abb);return;}const _0x268f2d=_0x1ac450[_0x549aa5(0xfd)];if(_0x268f2d===_0x27ad25){console[_0x549aa5(0xc1)]('Payment\x20'+_0x1ac450['id']+_0x549aa5(0xed)+_0x27ad25+')');return;}console[_0x549aa5(0xc1)](_0x549aa5(0x107)+_0x1ac450['id']+_0x549aa5(0xd4)+_0x268f2d+'\x20->\x20'+_0x27ad25);const _0x18b52f={'status':_0x27ad25,'updatedAt':new Date()};_0x1d4dae&&(_0x18b52f[_0x549aa5(0xd1)]=_0x1d4dae,console[_0x549aa5(0xc1)]('ðŸ’¾\x20Saving\x20failure\x20message:\x20'+_0x1d4dae));_0x54e13b&&_0x54e13b[_0x549aa5(0x11a)]>0x0&&(_0x18b52f[_0x549aa5(0x106)]=JSON['stringify'](_0x54e13b),console[_0x549aa5(0xc1)](_0x549aa5(0xdd)+JSON[_0x549aa5(0xb4)](_0x54e13b)));_0x27ad25===_0x549aa5(0xb3)&&_0x268f2d!=='PAID'&&(_0x18b52f[_0x549aa5(0xf8)]=new Date());_0x4cca3b&&(_0x4cca3b[_0x549aa5(0x9f)]&&(_0x18b52f[_0x549aa5(0x9f)]=_0x4cca3b[_0x549aa5(0x9f)]),_0x4cca3b['paymentMethod']&&(_0x18b52f[_0x549aa5(0xee)]=_0x4cca3b['paymentMethod']),_0x4cca3b[_0x549aa5(0x9a)]&&(_0x18b52f[_0x549aa5(0x9a)]=_0x4cca3b[_0x549aa5(0x9a)]),_0x4cca3b['remitterIban']&&(_0x18b52f[_0x549aa5(0xe7)]=_0x4cca3b[_0x549aa5(0xe7)]),_0x4cca3b[_0x549aa5(0x98)]&&(_0x18b52f['remitterName']=_0x4cca3b[_0x549aa5(0x98)]));await database_1['default']['payment'][_0x549aa5(0xd3)]({'where':{'id':_0x1ac450['id']},'data':_0x18b52f});if(_0x27ad25==='PAID'&&_0x268f2d!==_0x549aa5(0xb3))try{await this[_0x549aa5(0xaf)][_0x549aa5(0xd9)](_0x1ac450['id']);}catch(_0x3c11b6){console[_0x549aa5(0x113)](_0x549aa5(0xa3),_0x3c11b6);}await database_1['default'][_0x549aa5(0xba)][_0x549aa5(0xc7)]({'data':{'paymentId':_0x1ac450['id'],'shopId':_0x1ac450[_0x549aa5(0xe1)],'event':_0x1b6abb+_0x549aa5(0x125)+_0x27ad25[_0x549aa5(0xd7)](),'statusCode':0xc8,'responseBody':JSON[_0x549aa5(0xb4)]({'oldStatus':_0x268f2d,'newStatus':_0x27ad25,'failureMessage':_0x1d4dae,'txUrls':_0x54e13b,'webhookData':_0x326572})}}),await this[_0x549aa5(0xbf)](_0x1ac450,_0x27ad25),await this[_0x549aa5(0x11b)](_0x1ac450,_0x27ad25),console['log'](_0x549aa5(0xfb)+_0x1ac450['id']+_0x549aa5(0xa6)+_0x268f2d+_0x549aa5(0x116)+_0x27ad25),_0x1d4dae&&console[_0x549aa5(0xc1)](_0x549aa5(0x104)+_0x1d4dae),_0x54e13b&&_0x54e13b['length']>0x0&&console[_0x549aa5(0xc1)]('ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20'+_0x54e13b[_0x549aa5(0x11a)]+_0x549aa5(0x115));}async[a52_0x2ba5f1(0xbf)](_0x1778e6,_0xd2d272){const _0x417bc2=a52_0x2ba5f1,_0x37e6be=Date[_0x417bc2(0xf1)]();try{const _0x43bf52=_0x1778e6[_0x417bc2(0xcd)],_0x1ef2ff=_0x43bf52[_0x417bc2(0x99)];if(!_0x1ef2ff?.['webhookUrl']){console[_0x417bc2(0xc1)](_0x417bc2(0xdb)+_0x43bf52['id']);return;}const _0x28e918=_0xd2d272===_0x417bc2(0xb3)?_0x417bc2(0x9e):_0xd2d272===_0x417bc2(0xbb)?'payment.failed':_0xd2d272===_0x417bc2(0xd0)?_0x417bc2(0xd2):_0x417bc2(0x117);let _0x35d8f3=[];if(_0x1ef2ff[_0x417bc2(0x95)])try{_0x35d8f3=Array[_0x417bc2(0x105)](_0x1ef2ff[_0x417bc2(0x95)])?_0x1ef2ff[_0x417bc2(0x95)]:JSON[_0x417bc2(0xab)](_0x1ef2ff['webhookEvents']);}catch(_0xc5c597){console[_0x417bc2(0x113)](_0x417bc2(0x11d),_0xc5c597),_0x35d8f3=[];}if(!_0x35d8f3[_0x417bc2(0xc8)](_0x28e918)){console[_0x417bc2(0xc1)]('Webhook\x20event\x20'+_0x28e918+_0x417bc2(0xa5)+_0x43bf52['id']);return;}let _0x302ced;if(_0x1778e6[_0x417bc2(0x106)])try{_0x302ced=JSON['parse'](_0x1778e6[_0x417bc2(0x106)]);}catch(_0x2d0088){console[_0x417bc2(0x113)](_0x417bc2(0x114),_0x2d0088),_0x302ced=undefined;}const _0x2716c3={'event':_0x28e918,'payment':{'id':_0x1778e6['id'],'order_id':_0x1778e6[_0x417bc2(0xa8)],'gateway_order_id':_0x1778e6[_0x417bc2(0xe8)],'gateway':_0x1778e6[_0x417bc2(0xc3)],'amount':_0x1778e6[_0x417bc2(0xf7)],'currency':_0x1778e6['currency'],'status':_0xd2d272[_0x417bc2(0xd7)](),'customer_email':_0x1778e6[_0x417bc2(0xb0)],'customer_name':_0x1778e6[_0x417bc2(0xbe)],'failure_message':_0x1778e6[_0x417bc2(0xd1)],'tx_urls':_0x302ced,'created_at':_0x1778e6[_0x417bc2(0xb7)],'updated_at':new Date()}},_0x1cb462=await fetch(_0x1ef2ff[_0x417bc2(0x111)],{'method':_0x417bc2(0x10c),'headers':{'Content-Type':_0x417bc2(0xb5),'User-Agent':_0x417bc2(0x10e)},'body':JSON[_0x417bc2(0xb4)](_0x2716c3)}),_0x455e43=Date[_0x417bc2(0xf1)]()-_0x37e6be,_0x444871=_0x1cb462['ok']?_0x417bc2(0xf0):await _0x1cb462[_0x417bc2(0x108)]();loggerService_1[_0x417bc2(0x9b)]['logShopWebhookSent'](_0x1778e6[_0x417bc2(0xe1)],_0x1ef2ff[_0x417bc2(0x111)],_0x28e918,_0x1cb462[_0x417bc2(0xfd)],_0x455e43,_0x2716c3),console[_0x417bc2(0xc1)](_0x417bc2(0x93)+_0x1ef2ff[_0x417bc2(0x111)]+_0x417bc2(0xcf)+_0x1cb462[_0x417bc2(0xfd)]+'\x20('+_0x455e43+_0x417bc2(0x9d));}catch(_0x25ac67){console[_0x417bc2(0x113)](_0x417bc2(0xa9),_0x25ac67),loggerService_1[_0x417bc2(0x9b)]['logShopWebhookError'](_0x1778e6[_0x417bc2(0xe1)],_0x1778e6[_0x417bc2(0xcd)]?.['settings']?.['webhookUrl']||_0x417bc2(0x96),_0x417bc2(0xe3),_0x25ac67,{});}}async[a52_0x2ba5f1(0x11b)](_0x49ed0e,_0x2f6844){const _0x51aca8=a52_0x2ba5f1;try{const _0x2fa491={'PENDING':_0x51aca8(0xeb),'PAID':'paid','FAILED':_0x51aca8(0xec),'EXPIRED':_0x51aca8(0x123)},_0x5522c5=_0x2fa491[_0x2f6844];if(!_0x5522c5||_0x5522c5==='created')return;await telegramBotService_1[_0x51aca8(0xf3)]['sendPaymentNotification'](_0x49ed0e[_0x51aca8(0xe1)],_0x49ed0e,_0x5522c5);}catch(_0xae8bf0){console[_0x51aca8(0x113)](_0x51aca8(0xa1),_0xae8bf0);}}}exports[a52_0x2ba5f1(0x124)]=WebhookService;