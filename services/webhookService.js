'use strict';function a57_0x5640(){const _0x4a9a2a=['🔄\x20Processing\x20Plisio\x20webhook:','11258514mrBgTs','__esModule','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','processNodaWebhook','\x20current\x20balance:\x20','additionalInfo','💸\x20Additional\x20chargeback\x20penalty:\x20-','paid','balance','CHARGEBACK','ms)','payment.failed','🔄\x20Processing\x20Rapyd\x20webhook:','isArray','paymentId','error','🔄\x20Processing\x20MasterCard\x20webhook:','💰\x20Converting\x20','toISOString','\x20=\x20','parse','coinToPayService','📝\x20Reason:\x20','\x20status\x20','plisioService','4866YXvpYq','💰\x20Payment\x20','klyme','paidAt','masterCardService','log','payment','REFUND','created','noda','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','failureMessage','946QMmfnZ','./gateways/mastercardService','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','./loggerService','updatedAt','4974uwRdoD','payment.success','chargebackAmount','RapydService','\x20USDT\x20(payment\x20became\x20PAID)','🔄\x20Processing\x20Noda\x20webhook:','\x20not\x20found','./gateways/klymeService','amount','status','customerName','settings','cardLast4','amountUSDT','Error\x20processing\x20Plisio\x20webhook:','shop','webhookEvents','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','389930AUkYjL','\x20balance\x20updated:\x20','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','loggerService','6702060CAPOJj','./gateways/coinToPayService','paymentMethod','MasterCardService','No\x20payment\x20ID\x20in\x20Noda\x20webhook','sendPaymentStatusNotification','toLowerCase','8QfEsOY','cointopay','remitterIban','PlisioService','PAID','rapydService','Error\x20processing\x20MasterCard\x20webhook:','create','findUnique','bankId','unknown','processKlymeWebhook','logShopWebhookError','toFixed','CoinToPayService','📊\x20CoinToPay\x20webhook:\x20Payment\x20','webhook_status_change_','💰\x20Adding\x20to\x20balance:\x20','convertToUSDT','Error\x20processing\x20Noda\x20webhook:','application/json','📊\x20Plisio\x20webhook:\x20Payment\x20','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','telegramBotService','processing','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','📊\x20Rapyd\x20webhook:\x20Payment\x20','now','updatePaymentStatus','update','🏪\x20Shop\x20','logWebhookProcessed','292XESBdA','default','FAILED','currency','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','findFirst','stringify','📤\x20Shop\x20webhook\x20sent\x20to\x20','mastercard','processPlisioWebhook','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','Payment\x20','processMasterCardWebhook','remitterName','klymeService','processRapydWebhook','Error\x20parsing\x20webhook\x20events:','sendShopWebhook','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','322sdBCot','shopId','logShopWebhookSent','📊\x20KLYME\x20webhook:\x20Payment\x20','username','nodaService','831546QHslOM','\x20->\x20','\x20not\x20enabled\x20for\x20shop\x20','plisio','NodaService','__importDefault','./telegramBotService','processWebhook','\x20with\x20status\x20','plisio_gateway','🔄\x20Processing\x20KLYME\x20webhook:','✅\x20Shop\x20','📊\x20Noda\x20webhook:\x20Payment\x20','1142581GIvhTV','POST','txUrls','WebhookService','\x20USDT\x20(chargeback\x20penalty)','toUpperCase','system','sendPaymentNotification','text','payment.pending','./gateways/plisioService','logWebhookError','payment_method','defineProperty','Error\x20processing\x20CoinToPay\x20webhook:','customerEmail','refund','processCoinToPayWebhook','\x20USDT','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Error\x20processing\x20Rapyd\x20webhook:','expired','webhookUrl'];a57_0x5640=function(){return _0x4a9a2a;};return a57_0x5640();}const a57_0xd6d366=a57_0x3b8e;(function(_0x159309,_0x1d75d9){const _0x49cf37=a57_0x3b8e,_0x1518ac=_0x159309();while(!![]){try{const _0x1c26f3=parseInt(_0x49cf37(0x1a1))/0x1+parseInt(_0x49cf37(0x194))/0x2+-parseInt(_0x49cf37(0x1e3))/0x3*(parseInt(_0x49cf37(0x220))/0x4)+parseInt(_0x49cf37(0x1f9))/0x5+-parseInt(_0x49cf37(0x1d2))/0x6*(-parseInt(_0x49cf37(0x18e))/0x7)+-parseInt(_0x49cf37(0x200))/0x8*(-parseInt(_0x49cf37(0x1b9))/0x9)+parseInt(_0x49cf37(0x1f5))/0xa*(-parseInt(_0x49cf37(0x1de))/0xb);if(_0x1c26f3===_0x1d75d9)break;else _0x1518ac['push'](_0x1518ac['shift']());}catch(_0x1d4ef5){_0x1518ac['push'](_0x1518ac['shift']());}}}(a57_0x5640,0xadf8a));var __importDefault=this&&this[a57_0xd6d366(0x199)]||function(_0x393870){const _0x200b1c=a57_0xd6d366;return _0x393870&&_0x393870[_0x200b1c(0x1ba)]?_0x393870:{'default':_0x393870};};Object[a57_0xd6d366(0x1ae)](exports,a57_0xd6d366(0x1ba),{'value':!![]}),exports[a57_0xd6d366(0x1a4)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a57_0xd6d366(0x1ab)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a57_0xd6d366(0x1fa)),klymeService_1=require(a57_0xd6d366(0x1ea)),mastercardService_1=require(a57_0xd6d366(0x1df)),telegramBotService_1=require(a57_0xd6d366(0x19a)),currencyService_1=require('./currencyService'),loggerService_1=require(a57_0xd6d366(0x1e1));function a57_0x3b8e(_0x7e96d8,_0x455732){const _0x5640b2=a57_0x5640();return a57_0x3b8e=function(_0x3b8e1f,_0x1f25ea){_0x3b8e1f=_0x3b8e1f-0x17f;let _0x336d93=_0x5640b2[_0x3b8e1f];return _0x336d93;},a57_0x3b8e(_0x7e96d8,_0x455732);}class WebhookService{constructor(){const _0x86de82=a57_0xd6d366;this[_0x86de82(0x1d1)]=new plisioService_1[(_0x86de82(0x203))](),this['rapydService']=new rapydService_1[(_0x86de82(0x1e6))](),this[_0x86de82(0x193)]=new nodaService_1[(_0x86de82(0x198))](),this[_0x86de82(0x1ce)]=new coinToPayService_1[(_0x86de82(0x20e))](),this[_0x86de82(0x189)]=new klymeService_1['KlymeService'](),this[_0x86de82(0x1d6)]=new mastercardService_1[(_0x86de82(0x1fc))]();}async[a57_0xd6d366(0x21c)](_0xe1dbfa,_0x1466a5,_0x5b5828){const _0x376550=a57_0xd6d366;console['log']('🔄\x20Updating\x20payment\x20'+_0xe1dbfa+'\x20status\x20to\x20'+_0x1466a5),await database_1[_0x376550(0x221)]['$transaction'](async _0x45c004=>{const _0x1a3a46=_0x376550,_0x40af83=await _0x45c004['payment'][_0x1a3a46(0x208)]({'where':{'id':_0xe1dbfa},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x40af83)throw new Error(_0x1a3a46(0x186)+_0xe1dbfa+_0x1a3a46(0x1e9));const _0x344ec3=_0x40af83[_0x1a3a46(0x1ec)],_0x2bfec0=_0x40af83[_0x1a3a46(0x1f2)];console[_0x1a3a46(0x1d7)](_0x1a3a46(0x1d3)+_0xe1dbfa+':\x20'+_0x344ec3+_0x1a3a46(0x195)+_0x1466a5),console[_0x1a3a46(0x1d7)](_0x1a3a46(0x21e)+_0x2bfec0[_0x1a3a46(0x192)]+_0x1a3a46(0x1bd)+_0x2bfec0[_0x1a3a46(0x1c1)]+_0x1a3a46(0x1b3));const _0x4eb3bf={'status':_0x1466a5[_0x1a3a46(0x1a6)](),'updatedAt':new Date(),'statusChangedBy':_0x1a3a46(0x1a7),'statusChangedAt':new Date()};_0x5b5828?.[_0x1a3a46(0x1dd)]&&(_0x4eb3bf[_0x1a3a46(0x1dd)]=_0x5b5828[_0x1a3a46(0x1dd)]);_0x5b5828?.[_0x1a3a46(0x1a3)]&&(_0x4eb3bf[_0x1a3a46(0x1a3)]=JSON[_0x1a3a46(0x181)](_0x5b5828['txUrls']));_0x5b5828?.[_0x1a3a46(0x1ef)]&&(_0x4eb3bf[_0x1a3a46(0x1ef)]=_0x5b5828['cardLast4']);_0x5b5828?.[_0x1a3a46(0x1fb)]&&(_0x4eb3bf[_0x1a3a46(0x1fb)]=_0x5b5828[_0x1a3a46(0x1fb)]);_0x5b5828?.[_0x1a3a46(0x209)]&&(_0x4eb3bf[_0x1a3a46(0x209)]=_0x5b5828[_0x1a3a46(0x209)]);_0x5b5828?.[_0x1a3a46(0x202)]&&(_0x4eb3bf[_0x1a3a46(0x202)]=_0x5b5828[_0x1a3a46(0x202)]);_0x5b5828?.['remitterName']&&(_0x4eb3bf['remitterName']=_0x5b5828[_0x1a3a46(0x188)]);let _0x434d5a=_0x2bfec0[_0x1a3a46(0x1c1)],_0x549b78='';if(_0x1466a5[_0x1a3a46(0x1a6)]()==='PAID'&&_0x344ec3!=='PAID'){const _0x5d4748=await currencyService_1['currencyService'][_0x1a3a46(0x212)](_0x40af83[_0x1a3a46(0x1eb)],_0x40af83[_0x1a3a46(0x223)]);_0x434d5a+=_0x5d4748,_0x549b78='+'+_0x5d4748[_0x1a3a46(0x20d)](0x6)+_0x1a3a46(0x1e7),_0x4eb3bf['amountUSDT']=_0x5d4748,_0x4eb3bf[_0x1a3a46(0x1d5)]=new Date(),console[_0x1a3a46(0x1d7)](_0x1a3a46(0x1ca)+_0x40af83['amount']+'\x20'+_0x40af83[_0x1a3a46(0x223)]+'\x20->\x20'+_0x5d4748[_0x1a3a46(0x20d)](0x6)+_0x1a3a46(0x1b3)),console[_0x1a3a46(0x1d7)](_0x1a3a46(0x211)+_0x2bfec0[_0x1a3a46(0x1c1)]+'\x20+\x20'+_0x5d4748[_0x1a3a46(0x20d)](0x6)+_0x1a3a46(0x1cc)+_0x434d5a[_0x1a3a46(0x20d)](0x6)+_0x1a3a46(0x1b3));}else{if(_0x344ec3===_0x1a3a46(0x204)&&_0x1466a5[_0x1a3a46(0x1a6)]()!=='PAID'){const _0x4e5101=_0x40af83[_0x1a3a46(0x1f0)];_0x4e5101&&(_0x434d5a-=_0x4e5101,_0x549b78='-'+_0x4e5101[_0x1a3a46(0x20d)](0x6)+_0x1a3a46(0x1f4),_0x4eb3bf[_0x1a3a46(0x1f0)]=null,_0x4eb3bf[_0x1a3a46(0x1d5)]=null,console[_0x1a3a46(0x1d7)]('💰\x20Removing\x20from\x20balance:\x20'+_0x2bfec0['balance']+'\x20-\x20'+_0x4e5101['toFixed'](0x6)+_0x1a3a46(0x1cc)+_0x434d5a[_0x1a3a46(0x20d)](0x6)+'\x20USDT'));}}if(_0x1466a5['toUpperCase']()==='CHARGEBACK'){const _0x2b0d3f=_0x5b5828?.[_0x1a3a46(0x1e5)]||0x0;_0x2b0d3f>0x0&&(_0x434d5a-=_0x2b0d3f,_0x549b78+='\x20and\x20-'+_0x2b0d3f['toFixed'](0x6)+_0x1a3a46(0x1a5),_0x4eb3bf[_0x1a3a46(0x1e5)]=_0x2b0d3f,console[_0x1a3a46(0x1d7)](_0x1a3a46(0x1bf)+_0x2b0d3f[_0x1a3a46(0x20d)](0x6)+_0x1a3a46(0x1b3)),console['log']('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x434d5a['toFixed'](0x6)+_0x1a3a46(0x1b3)));}const _0x3da86c=await _0x45c004['payment'][_0x1a3a46(0x21d)]({'where':{'id':_0xe1dbfa},'data':_0x4eb3bf});_0x434d5a!==_0x2bfec0[_0x1a3a46(0x1c1)]&&(await _0x45c004[_0x1a3a46(0x1f2)]['update']({'where':{'id':_0x2bfec0['id']},'data':{'balance':_0x434d5a}}),console[_0x1a3a46(0x1d7)](_0x1a3a46(0x19f)+_0x2bfec0[_0x1a3a46(0x192)]+_0x1a3a46(0x1f6)+_0x2bfec0[_0x1a3a46(0x1c1)][_0x1a3a46(0x20d)](0x6)+'\x20->\x20'+_0x434d5a['toFixed'](0x6)+_0x1a3a46(0x1b3)),console[_0x1a3a46(0x1d7)](_0x1a3a46(0x1cf)+_0x549b78)),await _0x45c004['webhookLog'][_0x1a3a46(0x207)]({'data':{'paymentId':_0xe1dbfa,'shopId':_0x2bfec0['id'],'event':_0x1a3a46(0x210)+_0x1466a5[_0x1a3a46(0x1ff)](),'statusCode':0xc8,'responseBody':JSON[_0x1a3a46(0x181)]({'oldStatus':_0x344ec3,'newStatus':_0x1466a5['toUpperCase'](),'balanceChange':_0x549b78||'no\x20balance\x20change','oldBalance':_0x2bfec0['balance'],'newBalance':_0x434d5a,'amountUSDT':_0x4eb3bf[_0x1a3a46(0x1f0)],'additionalData':_0x5b5828,'timestamp':new Date()[_0x1a3a46(0x1cb)]()})}}),await this[_0x1a3a46(0x18c)]({..._0x40af83,..._0x3da86c,'shop':_0x2bfec0},_0x1466a5[_0x1a3a46(0x1a6)]()),await this[_0x1a3a46(0x1fe)]({..._0x40af83,..._0x3da86c},_0x1466a5[_0x1a3a46(0x1a6)]());});}async[a57_0xd6d366(0x184)](_0xab6c07){const _0x31d0b5=a57_0xd6d366;console['log'](_0x31d0b5(0x1b8),_0xab6c07);try{const _0x16098e=await this[_0x31d0b5(0x1d1)][_0x31d0b5(0x19b)](_0xab6c07);if(!_0x16098e[_0x31d0b5(0x1c7)])throw new Error(_0x31d0b5(0x1e0));const _0x369dff=await database_1[_0x31d0b5(0x221)][_0x31d0b5(0x1d8)][_0x31d0b5(0x180)]({'where':{'gatewayOrderId':_0x16098e[_0x31d0b5(0x1c7)]}});if(!_0x369dff){console['error']('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x16098e[_0x31d0b5(0x1c7)]);return;}console[_0x31d0b5(0x1d7)](_0x31d0b5(0x215)+_0x369dff['id']+'\x20status\x20'+_0x16098e[_0x31d0b5(0x1ec)]),await this[_0x31d0b5(0x21c)](_0x369dff['id'],_0x16098e['status'],{'txUrls':_0x16098e['txUrls']}),loggerService_1['loggerService'][_0x31d0b5(0x21f)](_0x31d0b5(0x197),_0x369dff['id'],_0x369dff[_0x31d0b5(0x1ec)],_0x16098e[_0x31d0b5(0x1ec)],_0xab6c07);}catch(_0xeefb44){console[_0x31d0b5(0x1c8)](_0x31d0b5(0x1f1),_0xeefb44),loggerService_1[_0x31d0b5(0x1f8)][_0x31d0b5(0x1ac)]('plisio',_0xeefb44,_0xab6c07);throw _0xeefb44;}}async['processPlisioGatewayWebhook'](_0x10d6c5){const _0x1d2afc=a57_0xd6d366;console[_0x1d2afc(0x1d7)]('🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:',_0x10d6c5);try{const _0x1febc9=await this[_0x1d2afc(0x1d1)][_0x1d2afc(0x19b)](_0x10d6c5);if(!_0x1febc9['paymentId'])throw new Error(_0x1d2afc(0x185));const _0x2a31eb=await database_1[_0x1d2afc(0x221)]['payment'][_0x1d2afc(0x180)]({'where':{'gatewayOrderId':_0x1febc9[_0x1d2afc(0x1c7)]}});if(!_0x2a31eb){console[_0x1d2afc(0x1c8)](_0x1d2afc(0x216)+_0x1febc9[_0x1d2afc(0x1c7)]);return;}console[_0x1d2afc(0x1d7)](_0x1d2afc(0x1bb)+_0x2a31eb['id']+_0x1d2afc(0x1d0)+_0x1febc9['status']),await this[_0x1d2afc(0x21c)](_0x2a31eb['id'],_0x1febc9[_0x1d2afc(0x1ec)],{'txUrls':_0x1febc9[_0x1d2afc(0x1a3)]}),loggerService_1[_0x1d2afc(0x1f8)]['logWebhookProcessed'](_0x1d2afc(0x19d),_0x2a31eb['id'],_0x2a31eb[_0x1d2afc(0x1ec)],_0x1febc9[_0x1d2afc(0x1ec)],_0x10d6c5);}catch(_0x29d5e7){console['error']('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x29d5e7),loggerService_1[_0x1d2afc(0x1f8)][_0x1d2afc(0x1ac)](_0x1d2afc(0x19d),_0x29d5e7,_0x10d6c5);throw _0x29d5e7;}}async[a57_0xd6d366(0x18a)](_0xe3a0dc){const _0x398603=a57_0xd6d366;console[_0x398603(0x1d7)](_0x398603(0x1c5),_0xe3a0dc);try{const _0x554dd7=await this[_0x398603(0x205)][_0x398603(0x19b)](_0xe3a0dc);if(!_0x554dd7[_0x398603(0x1c7)])throw new Error('No\x20payment\x20ID\x20in\x20Rapyd\x20webhook');const _0x1cafbf=await database_1[_0x398603(0x221)]['payment'][_0x398603(0x180)]({'where':{'gatewayOrderId':_0x554dd7['paymentId']}});if(!_0x1cafbf){console[_0x398603(0x1c8)](_0x398603(0x219)+_0x554dd7[_0x398603(0x1c7)]);return;}console['log'](_0x398603(0x21a)+_0x1cafbf['id']+_0x398603(0x1d0)+_0x554dd7[_0x398603(0x1ec)]),await this[_0x398603(0x21c)](_0x1cafbf['id'],_0x554dd7[_0x398603(0x1ec)],{'failureMessage':_0x554dd7['failureMessage'],'cardLast4':_0x554dd7[_0x398603(0x1be)]?.[_0x398603(0x1ef)],'paymentMethod':_0x554dd7[_0x398603(0x1be)]?.[_0x398603(0x1fb)]}),loggerService_1[_0x398603(0x1f8)][_0x398603(0x21f)]('rapyd',_0x1cafbf['id'],_0x1cafbf[_0x398603(0x1ec)],_0x554dd7[_0x398603(0x1ec)],_0xe3a0dc);}catch(_0x241ceb){console[_0x398603(0x1c8)](_0x398603(0x1b5),_0x241ceb),loggerService_1[_0x398603(0x1f8)][_0x398603(0x1ac)]('rapyd',_0x241ceb,_0xe3a0dc);throw _0x241ceb;}}async[a57_0xd6d366(0x1bc)](_0x51268e){const _0x2b93c5=a57_0xd6d366;console[_0x2b93c5(0x1d7)](_0x2b93c5(0x1e8),_0x51268e);try{const _0x57f078=await this[_0x2b93c5(0x193)][_0x2b93c5(0x19b)](_0x51268e);if(!_0x57f078[_0x2b93c5(0x1c7)])throw new Error(_0x2b93c5(0x1fd));const _0x26f561=await database_1[_0x2b93c5(0x221)][_0x2b93c5(0x1d8)][_0x2b93c5(0x180)]({'where':{'gatewayOrderId':_0x57f078[_0x2b93c5(0x1c7)]}});if(!_0x26f561){console[_0x2b93c5(0x1c8)](_0x2b93c5(0x17f)+_0x57f078[_0x2b93c5(0x1c7)]);return;}console[_0x2b93c5(0x1d7)](_0x2b93c5(0x1a0)+_0x26f561['id']+_0x2b93c5(0x1d0)+_0x57f078[_0x2b93c5(0x1ec)]),await this[_0x2b93c5(0x21c)](_0x26f561['id'],_0x57f078['status'],{'bankId':_0x57f078['additionalInfo']?.[_0x2b93c5(0x209)],'remitterIban':_0x57f078[_0x2b93c5(0x1be)]?.['remitterIban'],'remitterName':_0x57f078[_0x2b93c5(0x1be)]?.[_0x2b93c5(0x188)]}),loggerService_1[_0x2b93c5(0x1f8)][_0x2b93c5(0x21f)](_0x2b93c5(0x1db),_0x26f561['id'],_0x26f561[_0x2b93c5(0x1ec)],_0x57f078['status'],_0x51268e);}catch(_0x36766e){console[_0x2b93c5(0x1c8)](_0x2b93c5(0x213),_0x36766e),loggerService_1[_0x2b93c5(0x1f8)]['logWebhookError'](_0x2b93c5(0x1db),_0x36766e,_0x51268e);throw _0x36766e;}}async[a57_0xd6d366(0x1b2)](_0x3a055c){const _0x13e503=a57_0xd6d366;console[_0x13e503(0x1d7)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x3a055c);try{const _0x1099cd=await this[_0x13e503(0x1ce)][_0x13e503(0x19b)](_0x3a055c);if(!_0x1099cd[_0x13e503(0x1c7)])throw new Error(_0x13e503(0x18d));const _0x5e82bd=await database_1['default'][_0x13e503(0x1d8)]['findFirst']({'where':{'gatewayOrderId':_0x1099cd[_0x13e503(0x1c7)]}});if(!_0x5e82bd){console['error'](_0x13e503(0x1f7)+_0x1099cd[_0x13e503(0x1c7)]);return;}console[_0x13e503(0x1d7)](_0x13e503(0x20f)+_0x5e82bd['id']+_0x13e503(0x1d0)+_0x1099cd['status']),await this[_0x13e503(0x21c)](_0x5e82bd['id'],_0x1099cd[_0x13e503(0x1ec)]),loggerService_1[_0x13e503(0x1f8)][_0x13e503(0x21f)](_0x13e503(0x201),_0x5e82bd['id'],_0x5e82bd[_0x13e503(0x1ec)],_0x1099cd['status'],_0x3a055c);}catch(_0x3d6d57){console[_0x13e503(0x1c8)](_0x13e503(0x1af),_0x3d6d57),loggerService_1[_0x13e503(0x1f8)]['logWebhookError'](_0x13e503(0x201),_0x3d6d57,_0x3a055c);throw _0x3d6d57;}}async[a57_0xd6d366(0x20b)](_0x108498){const _0x1fcf27=a57_0xd6d366;console[_0x1fcf27(0x1d7)](_0x1fcf27(0x19e),_0x108498);try{const _0xd3a21c=await this[_0x1fcf27(0x189)]['processWebhook'](_0x108498);if(!_0xd3a21c[_0x1fcf27(0x1c7)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x2d9b82=await database_1[_0x1fcf27(0x221)]['payment'][_0x1fcf27(0x180)]({'where':{'gatewayOrderId':_0xd3a21c[_0x1fcf27(0x1c7)]}});if(!_0x2d9b82){console[_0x1fcf27(0x1c8)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0xd3a21c[_0x1fcf27(0x1c7)]);return;}console[_0x1fcf27(0x1d7)](_0x1fcf27(0x191)+_0x2d9b82['id']+_0x1fcf27(0x1d0)+_0xd3a21c[_0x1fcf27(0x1ec)]),await this['updatePaymentStatus'](_0x2d9b82['id'],_0xd3a21c[_0x1fcf27(0x1ec)],{'paymentMethod':_0xd3a21c[_0x1fcf27(0x1be)]?.[_0x1fcf27(0x1ad)]}),loggerService_1[_0x1fcf27(0x1f8)][_0x1fcf27(0x21f)](_0x1fcf27(0x1d4),_0x2d9b82['id'],_0x2d9b82[_0x1fcf27(0x1ec)],_0xd3a21c['status'],_0x108498);}catch(_0xfea3a2){console['error']('Error\x20processing\x20KLYME\x20webhook:',_0xfea3a2),loggerService_1[_0x1fcf27(0x1f8)][_0x1fcf27(0x1ac)](_0x1fcf27(0x1d4),_0xfea3a2,_0x108498);throw _0xfea3a2;}}async[a57_0xd6d366(0x187)](_0xca512){const _0x2a81c6=a57_0xd6d366;console[_0x2a81c6(0x1d7)](_0x2a81c6(0x1c9),_0xca512);try{const _0x29301a=await this[_0x2a81c6(0x1d6)][_0x2a81c6(0x19b)](_0xca512);if(!_0x29301a[_0x2a81c6(0x1c7)])throw new Error(_0x2a81c6(0x1dc));const _0x128178=await database_1['default'][_0x2a81c6(0x1d8)][_0x2a81c6(0x180)]({'where':{'gatewayOrderId':_0x29301a[_0x2a81c6(0x1c7)]}});if(!_0x128178){console['error']('Payment\x20not\x20found\x20for\x20MasterCard\x20webhook:\x20'+_0x29301a[_0x2a81c6(0x1c7)]);return;}console[_0x2a81c6(0x1d7)]('📊\x20MasterCard\x20webhook:\x20Payment\x20'+_0x128178['id']+_0x2a81c6(0x1d0)+_0x29301a[_0x2a81c6(0x1ec)]),await this[_0x2a81c6(0x21c)](_0x128178['id'],_0x29301a[_0x2a81c6(0x1ec)]),loggerService_1[_0x2a81c6(0x1f8)][_0x2a81c6(0x21f)](_0x2a81c6(0x183),_0x128178['id'],_0x128178['status'],_0x29301a[_0x2a81c6(0x1ec)],_0xca512);}catch(_0x2f3e27){console[_0x2a81c6(0x1c8)](_0x2a81c6(0x206),_0x2f3e27),loggerService_1[_0x2a81c6(0x1f8)]['logWebhookError'](_0x2a81c6(0x183),_0x2f3e27,_0xca512);throw _0x2f3e27;}}async[a57_0xd6d366(0x18c)](_0x48e9ae,_0x4384d7){const _0x3a39a5=a57_0xd6d366,_0x286849=Date[_0x3a39a5(0x21b)]();try{const _0x36314f=_0x48e9ae[_0x3a39a5(0x1f2)],_0x2be963=_0x36314f[_0x3a39a5(0x1ee)];if(!_0x2be963?.[_0x3a39a5(0x1b7)]){console[_0x3a39a5(0x1d7)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x36314f['id']);return;}const _0x1403ea=_0x4384d7===_0x3a39a5(0x204)?_0x3a39a5(0x1e4):_0x4384d7===_0x3a39a5(0x222)?_0x3a39a5(0x1c4):_0x4384d7==='EXPIRED'?'payment.failed':_0x4384d7===_0x3a39a5(0x1c2)?_0x3a39a5(0x1c4):_0x4384d7===_0x3a39a5(0x1d9)?_0x3a39a5(0x1c4):_0x3a39a5(0x1aa);let _0x30d4c8=[];if(_0x2be963[_0x3a39a5(0x1f3)])try{_0x30d4c8=Array[_0x3a39a5(0x1c6)](_0x2be963[_0x3a39a5(0x1f3)])?_0x2be963[_0x3a39a5(0x1f3)]:JSON[_0x3a39a5(0x1cd)](_0x2be963[_0x3a39a5(0x1f3)]);}catch(_0x39f54a){console['error'](_0x3a39a5(0x18b),_0x39f54a),_0x30d4c8=[];}if(!_0x30d4c8['includes'](_0x1403ea)){console[_0x3a39a5(0x1d7)]('Webhook\x20event\x20'+_0x1403ea+_0x3a39a5(0x196)+_0x36314f['id']);return;}const _0x44c022={'event':_0x1403ea,'payment':{'id':_0x48e9ae['id'],'order_id':_0x48e9ae['orderId'],'gateway_order_id':_0x48e9ae['gatewayOrderId'],'gateway':_0x48e9ae['gateway'],'amount':_0x48e9ae[_0x3a39a5(0x1eb)],'currency':_0x48e9ae[_0x3a39a5(0x223)],'status':_0x4384d7['toLowerCase'](),'customer_email':_0x48e9ae[_0x3a39a5(0x1b0)],'customer_name':_0x48e9ae[_0x3a39a5(0x1ed)],'failure_message':_0x48e9ae[_0x3a39a5(0x1dd)],'tx_urls':_0x48e9ae[_0x3a39a5(0x1a3)]?JSON[_0x3a39a5(0x1cd)](_0x48e9ae[_0x3a39a5(0x1a3)]):null,'created_at':_0x48e9ae['createdAt'],'updated_at':_0x48e9ae[_0x3a39a5(0x1e2)]}},_0x32b16a=await fetch(_0x2be963['webhookUrl'],{'method':_0x3a39a5(0x1a2),'headers':{'Content-Type':_0x3a39a5(0x214),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x3a39a5(0x181)](_0x44c022)}),_0x353510=Date[_0x3a39a5(0x21b)]()-_0x286849,_0x233a6e=_0x32b16a['ok']?'Success':await _0x32b16a[_0x3a39a5(0x1a9)]();loggerService_1['loggerService'][_0x3a39a5(0x190)](_0x48e9ae[_0x3a39a5(0x18f)],_0x2be963[_0x3a39a5(0x1b7)],_0x1403ea,_0x32b16a[_0x3a39a5(0x1ec)],_0x353510,_0x44c022),console[_0x3a39a5(0x1d7)](_0x3a39a5(0x182)+_0x2be963[_0x3a39a5(0x1b7)]+_0x3a39a5(0x19c)+_0x32b16a['status']+'\x20('+_0x353510+_0x3a39a5(0x1c3));}catch(_0x901873){console[_0x3a39a5(0x1c8)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x901873),loggerService_1[_0x3a39a5(0x1f8)][_0x3a39a5(0x20c)](_0x48e9ae[_0x3a39a5(0x18f)],_0x48e9ae['shop']?.[_0x3a39a5(0x1ee)]?.[_0x3a39a5(0x1b7)]||_0x3a39a5(0x20a),'webhook_send',_0x901873,{});}}async[a57_0xd6d366(0x1fe)](_0x4fcca7,_0x4735ab){const _0x6f16b6=a57_0xd6d366;try{const _0x3bee47={'PENDING':_0x6f16b6(0x1da),'PROCESSING':_0x6f16b6(0x218),'PAID':_0x6f16b6(0x1c0),'FAILED':'failed','EXPIRED':_0x6f16b6(0x1b6),'REFUND':_0x6f16b6(0x1b1),'CHARGEBACK':'chargeback'},_0x2afc90=_0x3bee47[_0x4735ab];if(!_0x2afc90||_0x2afc90===_0x6f16b6(0x1da))return;await telegramBotService_1[_0x6f16b6(0x217)][_0x6f16b6(0x1a8)](_0x4fcca7[_0x6f16b6(0x18f)],_0x4fcca7,_0x2afc90);}catch(_0x375fbb){console[_0x6f16b6(0x1c8)](_0x6f16b6(0x1b4),_0x375fbb);}}}exports[a57_0xd6d366(0x1a4)]=WebhookService;