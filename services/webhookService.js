'use strict';const a52_0x2c026d=a52_0x22c8;(function(_0x5aa5cd,_0x223477){const _0x254ae4=a52_0x22c8,_0x94778=_0x5aa5cd();while(!![]){try{const _0x70a2ca=parseInt(_0x254ae4(0x1c8))/0x1*(parseInt(_0x254ae4(0x17d))/0x2)+-parseInt(_0x254ae4(0x193))/0x3*(-parseInt(_0x254ae4(0x1c5))/0x4)+-parseInt(_0x254ae4(0x15a))/0x5*(-parseInt(_0x254ae4(0x148))/0x6)+-parseInt(_0x254ae4(0x157))/0x7+parseInt(_0x254ae4(0x19d))/0x8+-parseInt(_0x254ae4(0x1af))/0x9+-parseInt(_0x254ae4(0x199))/0xa;if(_0x70a2ca===_0x223477)break;else _0x94778['push'](_0x94778['shift']());}catch(_0x16a06d){_0x94778['push'](_0x94778['shift']());}}}(a52_0x4a69,0xa289a));var __importDefault=this&&this[a52_0x2c026d(0x15c)]||function(_0x20ab9b){const _0x110ef7=a52_0x2c026d;return _0x20ab9b&&_0x20ab9b[_0x110ef7(0x1c4)]?_0x20ab9b:{'default':_0x20ab9b};};Object[a52_0x2c026d(0x17e)](exports,'__esModule',{'value':!![]}),exports['WebhookService']=void 0x0;function a52_0x4a69(){const _0x371143=['1089584fGnrWd','defineProperty','webhookEvents','Error\x20processing\x20KLYME\x20webhook:','paymentMethod','customerName','currency','gateway','Failed\x20to\x20update\x20payment\x20link\x20counter:','No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook','Processing\x20Rapyd\x20webhook:','./gateways/nodaService','Payment\x20','bankId','cardLast4','additionalInfo','sendPaymentNotification','processCoinToPayWebhook','noda','ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20','parse','shopId','27eNtOEG','klymeService','plisioService','text','ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20','logWebhookProcessed','2063550XhYLZT','remitterName','length','paidAt','1141488MELzLg','\x20status\x20change:\x20','Error\x20processing\x20Plisio\x20webhook:','sendPaymentStatusNotification','ðŸ”„\x20Updating\x20payment\x20','orderId','shop','Processing\x20Plisio\x20webhook:','processKlymeWebhook','txUrls','status','\x20URLs','sendShopWebhook','create','No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook','rapyd','cointopay','error','6086934XbZlBJ','telegramBotService','Error\x20processing\x20Rapyd\x20webhook:','includes','Error\x20processing\x20CoinToPay\x20webhook:','processPlisioWebhook','Success','\x20failure\x20message:\x20','PaymentLinkService','coinToPayService','remitterIban','Processing\x20Noda\x20webhook:','klyme_','findFirst','loggerService','\x20from\x20','now','toLowerCase','stringify','application/json','failed','__esModule','85420LsRDNV','plisio','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','2JmaeRM','webhook_send','No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook','webhookUrl','processRapydWebhook','processNodaWebhook','Error\x20parsing\x20tx_urls\x20for\x20webhook:','5166yvFKxR','EXPIRED','\x20with\x20status\x20','updatePaymentStatus','rapydService','No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook','failureMessage','Webhook\x20event\x20','paymentId','gatewayOrderId','Processing\x20KLYME\x20webhook:','ðŸ’¥\x20Payment\x20','Processing\x20CoinToPay\x20webhook:','logShopWebhookError','\x20status\x20to\x20','7563983XbHJJw','./paymentLinkService','\x20and\x20gateway:\x20','6995yzmNGq','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','__importDefault','PAID','\x20->\x20','payment.success','log','KlymeService','payment','_webhook_','ðŸ”—\x20Payment\x20','expired','PENDING','\x20not\x20enabled\x20for\x20shop\x20','logWebhookError','nodaService','./gateways/plisioService','klyme','unknown','plisio_gateway','Processing\x20Plisio\x20Gateway\x20webhook:','settings','created','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook','POST','./gateways/coinToPayService','Failed\x20to\x20send\x20shop\x20webhook:','TesSoft\x20Payment\x20System/1.0','\x20status\x20unchanged\x20(','default','processWebhook','payment.failed','WebhookService','Error\x20processing\x20Noda\x20webhook:','paymentLinkService'];a52_0x4a69=function(){return _0x371143;};return a52_0x4a69();}const database_1=__importDefault(require('../config/database')),plisioService_1=require(a52_0x2c026d(0x16a)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a52_0x2c026d(0x188)),coinToPayService_1=require(a52_0x2c026d(0x173)),klymeService_1=require('./gateways/klymeService'),telegramBotService_1=require('./telegramBotService'),paymentLinkService_1=require(a52_0x2c026d(0x158)),loggerService_1=require('./loggerService');function a52_0x22c8(_0x443d3a,_0x41358a){const _0x4a69a7=a52_0x4a69();return a52_0x22c8=function(_0x22c8a9,_0x47d306){_0x22c8a9=_0x22c8a9-0x142;let _0x360976=_0x4a69a7[_0x22c8a9];return _0x360976;},a52_0x22c8(_0x443d3a,_0x41358a);}class WebhookService{constructor(){const _0x40306b=a52_0x2c026d;this[_0x40306b(0x195)]=new plisioService_1['PlisioService'](),this['rapydService']=new rapydService_1['RapydService'](),this[_0x40306b(0x169)]=new nodaService_1['NodaService'](),this[_0x40306b(0x1b8)]=new coinToPayService_1['CoinToPayService'](),this[_0x40306b(0x194)]=new klymeService_1[(_0x40306b(0x161))](),this[_0x40306b(0x17c)]=new paymentLinkService_1[(_0x40306b(0x1b7))]();}async[a52_0x2c026d(0x1b4)](_0x304f28){const _0x649e3f=a52_0x2c026d;console[_0x649e3f(0x160)](_0x649e3f(0x1a4),_0x304f28);try{const _0x416017=await this['plisioService']['processWebhook'](_0x304f28);if(!_0x416017[_0x649e3f(0x150)]){console[_0x649e3f(0x1ae)]('No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook');return;}await this['updatePaymentStatus'](_0x416017[_0x649e3f(0x150)],_0x416017[_0x649e3f(0x1a7)],_0x649e3f(0x1c6),_0x304f28,undefined,undefined,_0x416017['txUrls']),loggerService_1[_0x649e3f(0x1bd)][_0x649e3f(0x198)](_0x649e3f(0x1c6),_0x416017[_0x649e3f(0x150)],_0x649e3f(0x166),_0x416017['status'],_0x304f28);}catch(_0x28f9fa){console[_0x649e3f(0x1ae)](_0x649e3f(0x19f),_0x28f9fa),loggerService_1[_0x649e3f(0x1bd)][_0x649e3f(0x168)](_0x649e3f(0x1c6),_0x28f9fa,_0x304f28);throw _0x28f9fa;}}async['processPlisioGatewayWebhook'](_0x25460c){const _0x1ded92=a52_0x2c026d;console[_0x1ded92(0x160)](_0x1ded92(0x16e),_0x25460c);try{const _0x3454cb=await this['plisioService'][_0x1ded92(0x178)](_0x25460c);if(!_0x3454cb[_0x1ded92(0x150)]){console[_0x1ded92(0x1ae)](_0x1ded92(0x171));return;}await this[_0x1ded92(0x14b)](_0x3454cb[_0x1ded92(0x150)],_0x3454cb['status'],_0x1ded92(0x1c6),_0x25460c,undefined,undefined,_0x3454cb[_0x1ded92(0x1a6)]),loggerService_1[_0x1ded92(0x1bd)][_0x1ded92(0x198)](_0x1ded92(0x16d),_0x3454cb[_0x1ded92(0x150)],_0x1ded92(0x166),_0x3454cb[_0x1ded92(0x1a7)],_0x25460c);}catch(_0x19c873){console['error'](_0x1ded92(0x15b),_0x19c873),loggerService_1[_0x1ded92(0x1bd)]['logWebhookError'](_0x1ded92(0x16d),_0x19c873,_0x25460c);throw _0x19c873;}}async[a52_0x2c026d(0x145)](_0x108d30){const _0x37958d=a52_0x2c026d;console[_0x37958d(0x160)](_0x37958d(0x187),_0x108d30);try{const _0x11975a=await this[_0x37958d(0x14c)][_0x37958d(0x178)](_0x108d30);if(!_0x11975a[_0x37958d(0x150)]){console[_0x37958d(0x1ae)](_0x37958d(0x1ab));return;}await this[_0x37958d(0x14b)](_0x11975a[_0x37958d(0x150)],_0x11975a[_0x37958d(0x1a7)],'rapyd',_0x108d30,_0x11975a[_0x37958d(0x14e)],_0x11975a[_0x37958d(0x18c)]),loggerService_1[_0x37958d(0x1bd)][_0x37958d(0x198)](_0x37958d(0x1ac),_0x11975a[_0x37958d(0x150)],_0x37958d(0x166),_0x11975a[_0x37958d(0x1a7)],_0x108d30);}catch(_0x4a0a50){console[_0x37958d(0x1ae)](_0x37958d(0x1b1),_0x4a0a50),loggerService_1[_0x37958d(0x1bd)][_0x37958d(0x168)](_0x37958d(0x1ac),_0x4a0a50,_0x108d30);throw _0x4a0a50;}}async[a52_0x2c026d(0x146)](_0x3b6109){const _0x446749=a52_0x2c026d;console['log'](_0x446749(0x1ba),_0x3b6109);try{const _0x5bde30=await this[_0x446749(0x169)][_0x446749(0x178)](_0x3b6109);if(!_0x5bde30[_0x446749(0x150)]){console[_0x446749(0x1ae)](_0x446749(0x186));return;}await this['updatePaymentStatus'](_0x5bde30[_0x446749(0x150)],_0x5bde30[_0x446749(0x1a7)],_0x446749(0x18f),_0x3b6109,undefined,_0x5bde30[_0x446749(0x18c)]),loggerService_1['loggerService'][_0x446749(0x198)](_0x446749(0x18f),_0x5bde30[_0x446749(0x150)],_0x446749(0x166),_0x5bde30['status'],_0x3b6109);}catch(_0x576f94){console[_0x446749(0x1ae)](_0x446749(0x17b),_0x576f94),loggerService_1['loggerService'][_0x446749(0x168)](_0x446749(0x18f),_0x576f94,_0x3b6109);throw _0x576f94;}}async[a52_0x2c026d(0x18e)](_0x84cfc8){const _0x3f70e2=a52_0x2c026d;console[_0x3f70e2(0x160)](_0x3f70e2(0x154),_0x84cfc8);try{const _0x1dd946=await this['coinToPayService']['processWebhook'](_0x84cfc8);if(!_0x1dd946[_0x3f70e2(0x150)]){console['error'](_0x3f70e2(0x14d));return;}await this[_0x3f70e2(0x14b)](_0x1dd946[_0x3f70e2(0x150)],_0x1dd946[_0x3f70e2(0x1a7)],'cointopay',_0x84cfc8),loggerService_1[_0x3f70e2(0x1bd)][_0x3f70e2(0x198)](_0x3f70e2(0x1ad),_0x1dd946[_0x3f70e2(0x150)],'PENDING',_0x1dd946['status'],_0x84cfc8);}catch(_0xb52321){console[_0x3f70e2(0x1ae)](_0x3f70e2(0x1b3),_0xb52321),loggerService_1['loggerService'][_0x3f70e2(0x168)]('cointopay',_0xb52321,_0x84cfc8);throw _0xb52321;}}async[a52_0x2c026d(0x1a5)](_0x373597){const _0x301149=a52_0x2c026d;console[_0x301149(0x160)](_0x301149(0x152),_0x373597);try{const _0xdb2590=await this[_0x301149(0x194)][_0x301149(0x178)](_0x373597);if(!_0xdb2590[_0x301149(0x150)]){console['error'](_0x301149(0x143));return;}const _0x5e13e0=_0xdb2590['region']?_0x301149(0x1bb)+_0xdb2590['region'][_0x301149(0x1c0)]():'klyme_eu';await this['updatePaymentStatus'](_0xdb2590[_0x301149(0x150)],_0xdb2590[_0x301149(0x1a7)],_0x5e13e0,_0x373597,undefined,_0xdb2590[_0x301149(0x18c)]),loggerService_1[_0x301149(0x1bd)][_0x301149(0x198)](_0x301149(0x16b),_0xdb2590[_0x301149(0x150)],'PENDING',_0xdb2590[_0x301149(0x1a7)],_0x373597);}catch(_0x34bc55){console['error'](_0x301149(0x180),_0x34bc55),loggerService_1[_0x301149(0x1bd)][_0x301149(0x168)]('klyme',_0x34bc55,_0x373597);throw _0x34bc55;}}async[a52_0x2c026d(0x14b)](_0x2fb357,_0x24c1b8,_0x28e93e,_0x46dba3,_0x2d2e3f,_0x252c1a,_0x5e2bff){const _0x24bde8=a52_0x2c026d;console['log'](_0x24bde8(0x1a1)+_0x2fb357+_0x24bde8(0x156)+_0x24c1b8+_0x24bde8(0x1be)+_0x28e93e+'\x20webhook');_0x2d2e3f&&console[_0x24bde8(0x160)](_0x24bde8(0x153)+_0x2fb357+_0x24bde8(0x1b6)+_0x2d2e3f);_0x5e2bff&&_0x5e2bff[_0x24bde8(0x19b)]>0x0&&console['log'](_0x24bde8(0x164)+_0x2fb357+'\x20transaction\x20URLs:',_0x5e2bff);const _0x88bc38=await database_1['default'][_0x24bde8(0x162)][_0x24bde8(0x1bc)]({'where':{'gatewayOrderId':_0x2fb357,'gateway':_0x28e93e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x88bc38){console[_0x24bde8(0x1ae)](_0x24bde8(0x1c7)+_0x2fb357+_0x24bde8(0x159)+_0x28e93e);return;}const _0x5300e2=_0x88bc38['status'];if(_0x5300e2===_0x24c1b8){console[_0x24bde8(0x160)](_0x24bde8(0x189)+_0x88bc38['id']+_0x24bde8(0x176)+_0x24c1b8+')');return;}console[_0x24bde8(0x160)](_0x24bde8(0x189)+_0x88bc38['id']+_0x24bde8(0x19e)+_0x5300e2+_0x24bde8(0x15e)+_0x24c1b8);const _0x1f6c4f={'status':_0x24c1b8,'updatedAt':new Date()};_0x2d2e3f&&(_0x1f6c4f['failureMessage']=_0x2d2e3f,console[_0x24bde8(0x160)]('ðŸ’¾\x20Saving\x20failure\x20message:\x20'+_0x2d2e3f));_0x5e2bff&&_0x5e2bff[_0x24bde8(0x19b)]>0x0&&(_0x1f6c4f[_0x24bde8(0x1a6)]=JSON[_0x24bde8(0x1c1)](_0x5e2bff),console[_0x24bde8(0x160)](_0x24bde8(0x197)+JSON['stringify'](_0x5e2bff)));_0x24c1b8===_0x24bde8(0x15d)&&_0x5300e2!==_0x24bde8(0x15d)&&(_0x1f6c4f[_0x24bde8(0x19c)]=new Date());_0x252c1a&&(_0x252c1a[_0x24bde8(0x18b)]&&(_0x1f6c4f['cardLast4']=_0x252c1a[_0x24bde8(0x18b)]),_0x252c1a['paymentMethod']&&(_0x1f6c4f[_0x24bde8(0x181)]=_0x252c1a[_0x24bde8(0x181)]),_0x252c1a[_0x24bde8(0x18a)]&&(_0x1f6c4f[_0x24bde8(0x18a)]=_0x252c1a[_0x24bde8(0x18a)]),_0x252c1a['remitterIban']&&(_0x1f6c4f['remitterIban']=_0x252c1a[_0x24bde8(0x1b9)]),_0x252c1a[_0x24bde8(0x19a)]&&(_0x1f6c4f['remitterName']=_0x252c1a[_0x24bde8(0x19a)]));await database_1['default'][_0x24bde8(0x162)]['update']({'where':{'id':_0x88bc38['id']},'data':_0x1f6c4f});if(_0x24c1b8==='PAID'&&_0x5300e2!==_0x24bde8(0x15d))try{await this[_0x24bde8(0x17c)]['handleSuccessfulPayment'](_0x88bc38['id']);}catch(_0x29c53c){console[_0x24bde8(0x1ae)](_0x24bde8(0x185),_0x29c53c);}await database_1[_0x24bde8(0x177)]['webhookLog'][_0x24bde8(0x1aa)]({'data':{'paymentId':_0x88bc38['id'],'shopId':_0x88bc38[_0x24bde8(0x192)],'event':_0x28e93e+_0x24bde8(0x163)+_0x24c1b8[_0x24bde8(0x1c0)](),'statusCode':0xc8,'responseBody':JSON[_0x24bde8(0x1c1)]({'oldStatus':_0x5300e2,'newStatus':_0x24c1b8,'failureMessage':_0x2d2e3f,'txUrls':_0x5e2bff,'webhookData':_0x46dba3})}}),await this[_0x24bde8(0x1a9)](_0x88bc38,_0x24c1b8),await this[_0x24bde8(0x1a0)](_0x88bc38,_0x24c1b8),console[_0x24bde8(0x160)]('âœ…\x20Payment\x20'+_0x88bc38['id']+'\x20updated\x20successfully:\x20'+_0x5300e2+'\x20->\x20'+_0x24c1b8),_0x2d2e3f&&console[_0x24bde8(0x160)]('ðŸ’¾\x20Failure\x20message\x20saved:\x20'+_0x2d2e3f),_0x5e2bff&&_0x5e2bff[_0x24bde8(0x19b)]>0x0&&console[_0x24bde8(0x160)](_0x24bde8(0x190)+_0x5e2bff['length']+_0x24bde8(0x1a8));}async['sendShopWebhook'](_0x4c2c32,_0x3931f1){const _0x26b708=a52_0x2c026d,_0x2f05ad=Date['now']();try{const _0x1bf7f8=_0x4c2c32[_0x26b708(0x1a3)],_0x1f1c1f=_0x1bf7f8[_0x26b708(0x16f)];if(!_0x1f1c1f?.[_0x26b708(0x144)]){console[_0x26b708(0x160)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1bf7f8['id']);return;}const _0xc5b4b=_0x3931f1==='PAID'?_0x26b708(0x15f):_0x3931f1==='FAILED'?_0x26b708(0x179):_0x3931f1===_0x26b708(0x149)?_0x26b708(0x179):'payment.pending';let _0x2ff8d9=[];if(_0x1f1c1f[_0x26b708(0x17f)])try{_0x2ff8d9=Array['isArray'](_0x1f1c1f['webhookEvents'])?_0x1f1c1f[_0x26b708(0x17f)]:JSON[_0x26b708(0x191)](_0x1f1c1f[_0x26b708(0x17f)]);}catch(_0x3e7ad1){console['error']('Error\x20parsing\x20webhook\x20events:',_0x3e7ad1),_0x2ff8d9=[];}if(!_0x2ff8d9[_0x26b708(0x1b2)](_0xc5b4b)){console['log'](_0x26b708(0x14f)+_0xc5b4b+_0x26b708(0x167)+_0x1bf7f8['id']);return;}let _0x46377f;if(_0x4c2c32[_0x26b708(0x1a6)])try{_0x46377f=JSON[_0x26b708(0x191)](_0x4c2c32[_0x26b708(0x1a6)]);}catch(_0x5550b8){console[_0x26b708(0x1ae)](_0x26b708(0x147),_0x5550b8),_0x46377f=undefined;}const _0xbd3125={'event':_0xc5b4b,'payment':{'id':_0x4c2c32['id'],'order_id':_0x4c2c32[_0x26b708(0x1a2)],'gateway_order_id':_0x4c2c32[_0x26b708(0x151)],'gateway':_0x4c2c32[_0x26b708(0x184)],'amount':_0x4c2c32['amount'],'currency':_0x4c2c32[_0x26b708(0x183)],'status':_0x3931f1['toLowerCase'](),'customer_email':_0x4c2c32['customerEmail'],'customer_name':_0x4c2c32[_0x26b708(0x182)],'failure_message':_0x4c2c32[_0x26b708(0x14e)],'tx_urls':_0x46377f,'created_at':_0x4c2c32['createdAt'],'updated_at':new Date()}},_0x521313=await fetch(_0x1f1c1f['webhookUrl'],{'method':_0x26b708(0x172),'headers':{'Content-Type':_0x26b708(0x1c2),'User-Agent':_0x26b708(0x175)},'body':JSON[_0x26b708(0x1c1)](_0xbd3125)}),_0x157c6c=Date[_0x26b708(0x1bf)]()-_0x2f05ad,_0x67bf2c=_0x521313['ok']?_0x26b708(0x1b5):await _0x521313[_0x26b708(0x196)]();loggerService_1[_0x26b708(0x1bd)]['logShopWebhookSent'](_0x4c2c32[_0x26b708(0x192)],_0x1f1c1f[_0x26b708(0x144)],_0xc5b4b,_0x521313[_0x26b708(0x1a7)],_0x157c6c,_0xbd3125),console[_0x26b708(0x160)]('Shop\x20webhook\x20sent\x20to\x20'+_0x1f1c1f[_0x26b708(0x144)]+_0x26b708(0x14a)+_0x521313[_0x26b708(0x1a7)]+'\x20('+_0x157c6c+'ms)');}catch(_0x385bb1){console[_0x26b708(0x1ae)](_0x26b708(0x174),_0x385bb1),loggerService_1['loggerService'][_0x26b708(0x155)](_0x4c2c32[_0x26b708(0x192)],_0x4c2c32['shop']?.[_0x26b708(0x16f)]?.['webhookUrl']||_0x26b708(0x16c),_0x26b708(0x142),_0x385bb1,{});}}async['sendPaymentStatusNotification'](_0x55b55a,_0x427064){const _0x24baeb=a52_0x2c026d;try{const _0x430cd8={'PENDING':'created','PAID':'paid','FAILED':_0x24baeb(0x1c3),'EXPIRED':_0x24baeb(0x165)},_0x3a89e4=_0x430cd8[_0x427064];if(!_0x3a89e4||_0x3a89e4===_0x24baeb(0x170))return;await telegramBotService_1[_0x24baeb(0x1b0)][_0x24baeb(0x18d)](_0x55b55a[_0x24baeb(0x192)],_0x55b55a,_0x3a89e4);}catch(_0x276fd7){console[_0x24baeb(0x1ae)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x276fd7);}}}exports[a52_0x2c026d(0x17a)]=WebhookService;