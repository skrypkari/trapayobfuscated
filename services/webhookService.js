'use strict';const a52_0x13dec5=a52_0x2739;(function(_0x1a2017,_0x5aa656){const _0x230299=a52_0x2739,_0x3ba5b5=_0x1a2017();while(!![]){try{const _0x25d7e3=parseInt(_0x230299(0x1ed))/0x1+parseInt(_0x230299(0x18c))/0x2+-parseInt(_0x230299(0x1cb))/0x3+parseInt(_0x230299(0x1a4))/0x4+parseInt(_0x230299(0x18d))/0x5*(parseInt(_0x230299(0x17a))/0x6)+-parseInt(_0x230299(0x1ae))/0x7*(-parseInt(_0x230299(0x1fa))/0x8)+parseInt(_0x230299(0x186))/0x9*(-parseInt(_0x230299(0x1ff))/0xa);if(_0x25d7e3===_0x5aa656)break;else _0x3ba5b5['push'](_0x3ba5b5['shift']());}catch(_0xe830fb){_0x3ba5b5['push'](_0x3ba5b5['shift']());}}}(a52_0x44a4,0x80f93));function a52_0x44a4(){const _0x55cf71=['../config/database','\x20updated\x20successfully:\x20','telegramBotService','ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20','logWebhookError','1222724hIrkbu','\x20URLs','paymentMethod','Processing\x20Plisio\x20Gateway\x20webhook:','unknown','now','text','webhookEvents','txUrls','PAID','1764574WACeGw','plisio','__importDefault','klyme','__esModule','amount','settings','plisioService','shop','Processing\x20Noda\x20webhook:','./paymentLinkService','orderId','\x20not\x20enabled\x20for\x20shop\x20','\x20failure\x20message:\x20','Error\x20processing\x20Plisio\x20webhook:','\x20status\x20to\x20','create','klyme_eu','gatewayOrderId','Error\x20processing\x20Rapyd\x20webhook:','bankId','\x20from\x20','isArray','Processing\x20KLYME\x20webhook:','Processing\x20Rapyd\x20webhook:','\x20->\x20','ðŸ’¥\x20Payment\x20','ðŸ”—\x20Payment\x20','shopId','432843eARSRQ','failed','noda','sendShopWebhook','klymeService','processRapydWebhook','webhookLog','paid','./loggerService','processPlisioWebhook','./gateways/rapydService','failureMessage','RapydService','region','application/json','\x20status\x20unchanged\x20(','rapydService','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','processNodaWebhook','payment','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20','plisio_gateway','CoinToPayService','PENDING','PaymentLinkService','includes','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook','defineProperty','No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook','default','./gateways/klymeService','payment.failed','_webhook_','134995CdpvOx','expired','additionalInfo','paymentId','error','Failed\x20to\x20update\x20payment\x20link\x20counter:','TesSoft\x20Payment\x20System/1.0','processKlymeWebhook','remitterName','Payment\x20','log','length','webhook_send','8OVvhRs','EXPIRED','POST','ðŸ”„\x20Updating\x20payment\x20','cointopay','170fMOmXO','Error\x20processing\x20Noda\x20webhook:','klyme_','paymentLinkService','Failed\x20to\x20send\x20shop\x20webhook:','createdAt','No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook','NodaService','Error\x20parsing\x20webhook\x20events:','sendPaymentStatusNotification','logWebhookProcessed','24oNpLvc','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook','./gateways/plisioService','cardLast4','logShopWebhookError','update','coinToPayService','logShopWebhookSent','remitterIban','loggerService','stringify','ðŸ’¾\x20Failure\x20message\x20saved:\x20','618093MkzIxu','nodaService','Processing\x20CoinToPay\x20webhook:','webhookUrl','updatePaymentStatus','payment.success','1092830MtODXW','751115sapHVf','WebhookService','Error\x20processing\x20CoinToPay\x20webhook:','parse','toLowerCase','gateway','./gateways/nodaService','customerName','KlymeService','Success','payment.pending','rapyd','status','processWebhook','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','ms)','PlisioService','created'];a52_0x44a4=function(){return _0x55cf71;};return a52_0x44a4();}var __importDefault=this&&this[a52_0x13dec5(0x1b0)]||function(_0x2eedca){const _0x31bd56=a52_0x13dec5;return _0x2eedca&&_0x2eedca[_0x31bd56(0x1b2)]?_0x2eedca:{'default':_0x2eedca};};function a52_0x2739(_0x41a047,_0x34f3ff){const _0x44a414=a52_0x44a4();return a52_0x2739=function(_0x27398f,_0x259780){_0x27398f=_0x27398f-0x171;let _0x492576=_0x44a414[_0x27398f];return _0x492576;},a52_0x2739(_0x41a047,_0x34f3ff);}Object[a52_0x13dec5(0x1e7)](exports,a52_0x13dec5(0x1b2),{'value':!![]}),exports[a52_0x13dec5(0x18e)]=void 0x0;const database_1=__importDefault(require(a52_0x13dec5(0x19f))),plisioService_1=require(a52_0x13dec5(0x17c)),rapydService_1=require(a52_0x13dec5(0x1d5)),nodaService_1=require(a52_0x13dec5(0x193)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require(a52_0x13dec5(0x1ea)),telegramBotService_1=require('./telegramBotService'),paymentLinkService_1=require(a52_0x13dec5(0x1b8)),loggerService_1=require(a52_0x13dec5(0x1d3));class WebhookService{constructor(){const _0x42b7ca=a52_0x13dec5;this['plisioService']=new plisioService_1[(_0x42b7ca(0x19d))](),this[_0x42b7ca(0x1db)]=new rapydService_1[(_0x42b7ca(0x1d7))](),this[_0x42b7ca(0x187)]=new nodaService_1[(_0x42b7ca(0x176))](),this[_0x42b7ca(0x180)]=new coinToPayService_1[(_0x42b7ca(0x1e2))](),this[_0x42b7ca(0x1cf)]=new klymeService_1[(_0x42b7ca(0x195))](),this['paymentLinkService']=new paymentLinkService_1[(_0x42b7ca(0x1e4))]();}async[a52_0x13dec5(0x1d4)](_0x1fd87f){const _0xb7e652=a52_0x13dec5;console[_0xb7e652(0x1f7)]('Processing\x20Plisio\x20webhook:',_0x1fd87f);try{const _0x77f6ae=await this[_0xb7e652(0x1b5)][_0xb7e652(0x19a)](_0x1fd87f);if(!_0x77f6ae[_0xb7e652(0x1f0)]){console[_0xb7e652(0x1f1)](_0xb7e652(0x17b));return;}await this['updatePaymentStatus'](_0x77f6ae[_0xb7e652(0x1f0)],_0x77f6ae['status'],_0xb7e652(0x1af),_0x1fd87f,undefined,undefined,_0x77f6ae['txUrls']),loggerService_1[_0xb7e652(0x183)][_0xb7e652(0x179)](_0xb7e652(0x1af),_0x77f6ae[_0xb7e652(0x1f0)],_0xb7e652(0x1e3),_0x77f6ae[_0xb7e652(0x199)],_0x1fd87f);}catch(_0xbb4a6f){console['error'](_0xb7e652(0x1bc),_0xbb4a6f),loggerService_1[_0xb7e652(0x183)][_0xb7e652(0x1a3)](_0xb7e652(0x1af),_0xbb4a6f,_0x1fd87f);throw _0xbb4a6f;}}async['processPlisioGatewayWebhook'](_0x1f1f34){const _0x1bb234=a52_0x13dec5;console['log'](_0x1bb234(0x1a7),_0x1f1f34);try{const _0x3eec5e=await this[_0x1bb234(0x1b5)][_0x1bb234(0x19a)](_0x1f1f34);if(!_0x3eec5e[_0x1bb234(0x1f0)]){console[_0x1bb234(0x1f1)](_0x1bb234(0x1e6));return;}await this[_0x1bb234(0x18a)](_0x3eec5e[_0x1bb234(0x1f0)],_0x3eec5e[_0x1bb234(0x199)],'plisio',_0x1f1f34,undefined,undefined,_0x3eec5e['txUrls']),loggerService_1[_0x1bb234(0x183)][_0x1bb234(0x179)]('plisio_gateway',_0x3eec5e['paymentId'],'PENDING',_0x3eec5e['status'],_0x1f1f34);}catch(_0x5a8e23){console[_0x1bb234(0x1f1)](_0x1bb234(0x1dc),_0x5a8e23),loggerService_1['loggerService'][_0x1bb234(0x1a3)](_0x1bb234(0x1e1),_0x5a8e23,_0x1f1f34);throw _0x5a8e23;}}async[a52_0x13dec5(0x1d0)](_0x19240f){const _0x4a9afa=a52_0x13dec5;console[_0x4a9afa(0x1f7)](_0x4a9afa(0x1c6),_0x19240f);try{const _0x7e6191=await this['rapydService'][_0x4a9afa(0x19a)](_0x19240f);if(!_0x7e6191[_0x4a9afa(0x1f0)]){console['error'](_0x4a9afa(0x175));return;}await this[_0x4a9afa(0x18a)](_0x7e6191['paymentId'],_0x7e6191['status'],_0x4a9afa(0x198),_0x19240f,_0x7e6191[_0x4a9afa(0x1d6)],_0x7e6191[_0x4a9afa(0x1ef)]),loggerService_1[_0x4a9afa(0x183)]['logWebhookProcessed'](_0x4a9afa(0x198),_0x7e6191[_0x4a9afa(0x1f0)],_0x4a9afa(0x1e3),_0x7e6191[_0x4a9afa(0x199)],_0x19240f);}catch(_0x458f34){console[_0x4a9afa(0x1f1)](_0x4a9afa(0x1c1),_0x458f34),loggerService_1[_0x4a9afa(0x183)][_0x4a9afa(0x1a3)](_0x4a9afa(0x198),_0x458f34,_0x19240f);throw _0x458f34;}}async[a52_0x13dec5(0x1dd)](_0x271ebe){const _0x1ace59=a52_0x13dec5;console['log'](_0x1ace59(0x1b7),_0x271ebe);try{const _0x5ad876=await this[_0x1ace59(0x187)][_0x1ace59(0x19a)](_0x271ebe);if(!_0x5ad876[_0x1ace59(0x1f0)]){console[_0x1ace59(0x1f1)]('No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook');return;}await this[_0x1ace59(0x18a)](_0x5ad876[_0x1ace59(0x1f0)],_0x5ad876[_0x1ace59(0x199)],_0x1ace59(0x1cd),_0x271ebe,undefined,_0x5ad876[_0x1ace59(0x1ef)]),loggerService_1[_0x1ace59(0x183)][_0x1ace59(0x179)](_0x1ace59(0x1cd),_0x5ad876['paymentId'],'PENDING',_0x5ad876[_0x1ace59(0x199)],_0x271ebe);}catch(_0x133117){console[_0x1ace59(0x1f1)](_0x1ace59(0x200),_0x133117),loggerService_1['loggerService']['logWebhookError'](_0x1ace59(0x1cd),_0x133117,_0x271ebe);throw _0x133117;}}async['processCoinToPayWebhook'](_0x1e789b){const _0x3d5354=a52_0x13dec5;console[_0x3d5354(0x1f7)](_0x3d5354(0x188),_0x1e789b);try{const _0x523171=await this['coinToPayService'][_0x3d5354(0x19a)](_0x1e789b);if(!_0x523171[_0x3d5354(0x1f0)]){console[_0x3d5354(0x1f1)]('No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook');return;}await this[_0x3d5354(0x18a)](_0x523171['paymentId'],_0x523171[_0x3d5354(0x199)],_0x3d5354(0x1fe),_0x1e789b),loggerService_1[_0x3d5354(0x183)]['logWebhookProcessed']('cointopay',_0x523171[_0x3d5354(0x1f0)],_0x3d5354(0x1e3),_0x523171['status'],_0x1e789b);}catch(_0x5aa280){console[_0x3d5354(0x1f1)](_0x3d5354(0x18f),_0x5aa280),loggerService_1[_0x3d5354(0x183)][_0x3d5354(0x1a3)](_0x3d5354(0x1fe),_0x5aa280,_0x1e789b);throw _0x5aa280;}}async[a52_0x13dec5(0x1f4)](_0x46c03e){const _0x54329a=a52_0x13dec5;console[_0x54329a(0x1f7)](_0x54329a(0x1c5),_0x46c03e);try{const _0x581f6b=await this['klymeService'][_0x54329a(0x19a)](_0x46c03e);if(!_0x581f6b[_0x54329a(0x1f0)]){console[_0x54329a(0x1f1)](_0x54329a(0x1e8));return;}const _0x1e10d8=_0x581f6b[_0x54329a(0x1d8)]?_0x54329a(0x171)+_0x581f6b['region']['toLowerCase']():_0x54329a(0x1bf);await this[_0x54329a(0x18a)](_0x581f6b['paymentId'],_0x581f6b[_0x54329a(0x199)],_0x1e10d8,_0x46c03e,undefined,_0x581f6b['additionalInfo']),loggerService_1[_0x54329a(0x183)][_0x54329a(0x179)](_0x54329a(0x1b1),_0x581f6b['paymentId'],_0x54329a(0x1e3),_0x581f6b['status'],_0x46c03e);}catch(_0x22f37b){console[_0x54329a(0x1f1)]('Error\x20processing\x20KLYME\x20webhook:',_0x22f37b),loggerService_1[_0x54329a(0x183)]['logWebhookError']('klyme',_0x22f37b,_0x46c03e);throw _0x22f37b;}}async[a52_0x13dec5(0x18a)](_0x406d4b,_0x68e1ee,_0x4d1f7b,_0x159ef4,_0x46e1aa,_0x3c1c73,_0x2e5fef){const _0x2cf585=a52_0x13dec5;console[_0x2cf585(0x1f7)](_0x2cf585(0x1fd)+_0x406d4b+_0x2cf585(0x1bd)+_0x68e1ee+_0x2cf585(0x1c3)+_0x4d1f7b+'\x20webhook');_0x46e1aa&&console[_0x2cf585(0x1f7)](_0x2cf585(0x1c8)+_0x406d4b+_0x2cf585(0x1bb)+_0x46e1aa);_0x2e5fef&&_0x2e5fef['length']>0x0&&console[_0x2cf585(0x1f7)](_0x2cf585(0x1c9)+_0x406d4b+'\x20transaction\x20URLs:',_0x2e5fef);const _0x48fe46=await database_1[_0x2cf585(0x1e9)][_0x2cf585(0x1de)]['findFirst']({'where':{'gatewayOrderId':_0x406d4b,'gateway':_0x4d1f7b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x48fe46){console['error'](_0x2cf585(0x19b)+_0x406d4b+'\x20and\x20gateway:\x20'+_0x4d1f7b);return;}const _0x465c46=_0x48fe46['status'];if(_0x465c46===_0x68e1ee){console[_0x2cf585(0x1f7)]('Payment\x20'+_0x48fe46['id']+_0x2cf585(0x1da)+_0x68e1ee+')');return;}console[_0x2cf585(0x1f7)](_0x2cf585(0x1f6)+_0x48fe46['id']+'\x20status\x20change:\x20'+_0x465c46+_0x2cf585(0x1c7)+_0x68e1ee);const _0xb86926={'status':_0x68e1ee,'updatedAt':new Date()};_0x46e1aa&&(_0xb86926[_0x2cf585(0x1d6)]=_0x46e1aa,console[_0x2cf585(0x1f7)]('ðŸ’¾\x20Saving\x20failure\x20message:\x20'+_0x46e1aa));_0x2e5fef&&_0x2e5fef[_0x2cf585(0x1f8)]>0x0&&(_0xb86926[_0x2cf585(0x1ac)]=JSON['stringify'](_0x2e5fef),console[_0x2cf585(0x1f7)](_0x2cf585(0x1e0)+JSON[_0x2cf585(0x184)](_0x2e5fef)));_0x68e1ee===_0x2cf585(0x1ad)&&_0x465c46!==_0x2cf585(0x1ad)&&(_0xb86926['paidAt']=new Date());_0x3c1c73&&(_0x3c1c73[_0x2cf585(0x17d)]&&(_0xb86926[_0x2cf585(0x17d)]=_0x3c1c73['cardLast4']),_0x3c1c73[_0x2cf585(0x1a6)]&&(_0xb86926[_0x2cf585(0x1a6)]=_0x3c1c73[_0x2cf585(0x1a6)]),_0x3c1c73['bankId']&&(_0xb86926[_0x2cf585(0x1c2)]=_0x3c1c73['bankId']),_0x3c1c73[_0x2cf585(0x182)]&&(_0xb86926[_0x2cf585(0x182)]=_0x3c1c73[_0x2cf585(0x182)]),_0x3c1c73[_0x2cf585(0x1f5)]&&(_0xb86926['remitterName']=_0x3c1c73[_0x2cf585(0x1f5)]));await database_1[_0x2cf585(0x1e9)][_0x2cf585(0x1de)][_0x2cf585(0x17f)]({'where':{'id':_0x48fe46['id']},'data':_0xb86926});if(_0x68e1ee===_0x2cf585(0x1ad)&&_0x465c46!=='PAID')try{await this[_0x2cf585(0x172)]['handleSuccessfulPayment'](_0x48fe46['id']);}catch(_0x41c8e3){console[_0x2cf585(0x1f1)](_0x2cf585(0x1f2),_0x41c8e3);}await database_1['default'][_0x2cf585(0x1d1)][_0x2cf585(0x1be)]({'data':{'paymentId':_0x48fe46['id'],'shopId':_0x48fe46[_0x2cf585(0x1ca)],'event':_0x4d1f7b+_0x2cf585(0x1ec)+_0x68e1ee[_0x2cf585(0x191)](),'statusCode':0xc8,'responseBody':JSON[_0x2cf585(0x184)]({'oldStatus':_0x465c46,'newStatus':_0x68e1ee,'failureMessage':_0x46e1aa,'txUrls':_0x2e5fef,'webhookData':_0x159ef4})}}),await this[_0x2cf585(0x1ce)](_0x48fe46,_0x68e1ee),await this[_0x2cf585(0x178)](_0x48fe46,_0x68e1ee),console['log']('âœ…\x20Payment\x20'+_0x48fe46['id']+_0x2cf585(0x1a0)+_0x465c46+_0x2cf585(0x1c7)+_0x68e1ee),_0x46e1aa&&console[_0x2cf585(0x1f7)](_0x2cf585(0x185)+_0x46e1aa),_0x2e5fef&&_0x2e5fef[_0x2cf585(0x1f8)]>0x0&&console[_0x2cf585(0x1f7)](_0x2cf585(0x1a2)+_0x2e5fef['length']+_0x2cf585(0x1a5));}async['sendShopWebhook'](_0x1c98b2,_0x36d377){const _0x5da663=a52_0x13dec5,_0x424475=Date[_0x5da663(0x1a9)]();try{const _0x28f3c4=_0x1c98b2[_0x5da663(0x1b6)],_0x133a6e=_0x28f3c4[_0x5da663(0x1b4)];if(!_0x133a6e?.[_0x5da663(0x189)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x28f3c4['id']);return;}const _0x8d6b96=_0x36d377===_0x5da663(0x1ad)?_0x5da663(0x18b):_0x36d377==='FAILED'?_0x5da663(0x1eb):_0x36d377===_0x5da663(0x1fb)?_0x5da663(0x1eb):_0x5da663(0x197);let _0x23d62c=[];if(_0x133a6e[_0x5da663(0x1ab)])try{_0x23d62c=Array[_0x5da663(0x1c4)](_0x133a6e['webhookEvents'])?_0x133a6e['webhookEvents']:JSON[_0x5da663(0x190)](_0x133a6e[_0x5da663(0x1ab)]);}catch(_0xd75fe3){console[_0x5da663(0x1f1)](_0x5da663(0x177),_0xd75fe3),_0x23d62c=[];}if(!_0x23d62c[_0x5da663(0x1e5)](_0x8d6b96)){console[_0x5da663(0x1f7)]('Webhook\x20event\x20'+_0x8d6b96+_0x5da663(0x1ba)+_0x28f3c4['id']);return;}let _0x1655f9;if(_0x1c98b2[_0x5da663(0x1ac)])try{_0x1655f9=JSON[_0x5da663(0x190)](_0x1c98b2[_0x5da663(0x1ac)]);}catch(_0x317b1a){console['error']('Error\x20parsing\x20tx_urls\x20for\x20webhook:',_0x317b1a),_0x1655f9=undefined;}const _0x4bf72e={'event':_0x8d6b96,'payment':{'id':_0x1c98b2['id'],'order_id':_0x1c98b2[_0x5da663(0x1b9)],'gateway_order_id':_0x1c98b2[_0x5da663(0x1c0)],'gateway':_0x1c98b2[_0x5da663(0x192)],'amount':_0x1c98b2[_0x5da663(0x1b3)],'currency':_0x1c98b2['currency'],'status':_0x36d377[_0x5da663(0x191)](),'customer_email':_0x1c98b2['customerEmail'],'customer_name':_0x1c98b2[_0x5da663(0x194)],'failure_message':_0x1c98b2[_0x5da663(0x1d6)],'tx_urls':_0x1655f9,'created_at':_0x1c98b2[_0x5da663(0x174)],'updated_at':new Date()}},_0x2cbb84=await fetch(_0x133a6e[_0x5da663(0x189)],{'method':_0x5da663(0x1fc),'headers':{'Content-Type':_0x5da663(0x1d9),'User-Agent':_0x5da663(0x1f3)},'body':JSON[_0x5da663(0x184)](_0x4bf72e)}),_0x4ba2d6=Date[_0x5da663(0x1a9)]()-_0x424475,_0x2bf080=_0x2cbb84['ok']?_0x5da663(0x196):await _0x2cbb84[_0x5da663(0x1aa)]();loggerService_1[_0x5da663(0x183)][_0x5da663(0x181)](_0x1c98b2['shopId'],_0x133a6e['webhookUrl'],_0x8d6b96,_0x2cbb84[_0x5da663(0x199)],_0x4ba2d6,_0x4bf72e),console[_0x5da663(0x1f7)]('Shop\x20webhook\x20sent\x20to\x20'+_0x133a6e[_0x5da663(0x189)]+'\x20with\x20status\x20'+_0x2cbb84['status']+'\x20('+_0x4ba2d6+_0x5da663(0x19c));}catch(_0x408db6){console[_0x5da663(0x1f1)](_0x5da663(0x173),_0x408db6),loggerService_1[_0x5da663(0x183)][_0x5da663(0x17e)](_0x1c98b2[_0x5da663(0x1ca)],_0x1c98b2[_0x5da663(0x1b6)]?.[_0x5da663(0x1b4)]?.['webhookUrl']||_0x5da663(0x1a8),_0x5da663(0x1f9),_0x408db6,{});}}async[a52_0x13dec5(0x178)](_0x1ce4f2,_0x16829c){const _0x31a98e=a52_0x13dec5;try{const _0x2b0b0b={'PENDING':_0x31a98e(0x19e),'PAID':_0x31a98e(0x1d2),'FAILED':_0x31a98e(0x1cc),'EXPIRED':_0x31a98e(0x1ee)},_0x3b9e20=_0x2b0b0b[_0x16829c];if(!_0x3b9e20||_0x3b9e20===_0x31a98e(0x19e))return;await telegramBotService_1[_0x31a98e(0x1a1)]['sendPaymentNotification'](_0x1ce4f2[_0x31a98e(0x1ca)],_0x1ce4f2,_0x3b9e20);}catch(_0x7a1b3b){console[_0x31a98e(0x1f1)](_0x31a98e(0x1df),_0x7a1b3b);}}}exports[a52_0x13dec5(0x18e)]=WebhookService;