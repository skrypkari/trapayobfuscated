'use strict';const a52_0x5f413f=a52_0x512d;(function(_0x4d757e,_0x597ee7){const _0x19c545=a52_0x512d,_0x4d79fd=_0x4d757e();while(!![]){try{const _0xf10602=parseInt(_0x19c545(0x166))/0x1*(-parseInt(_0x19c545(0x151))/0x2)+parseInt(_0x19c545(0x145))/0x3+-parseInt(_0x19c545(0x133))/0x4+-parseInt(_0x19c545(0x14d))/0x5*(parseInt(_0x19c545(0x177))/0x6)+parseInt(_0x19c545(0x129))/0x7*(-parseInt(_0x19c545(0x158))/0x8)+-parseInt(_0x19c545(0x187))/0x9*(parseInt(_0x19c545(0x17b))/0xa)+-parseInt(_0x19c545(0x189))/0xb*(-parseInt(_0x19c545(0x111))/0xc);if(_0xf10602===_0x597ee7)break;else _0x4d79fd['push'](_0x4d79fd['shift']());}catch(_0xff9b02){_0x4d79fd['push'](_0x4d79fd['shift']());}}}(a52_0xdd38,0xe859a));function a52_0xdd38(){const _0x206cf8=['created','payment.failed','processWebhook','error','rapydService','klyme_eu','328077FSmhfE','paymentLinkService','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','sendPaymentStatusNotification','Processing\x20Plisio\x20Gateway\x20webhook:','default','remitterName','./gateways/rapydService','46465soFcnX','EXPIRED','ms)','paidAt','7868NcHORt','\x20->\x20','region','rapyd','failed','\x20not\x20enabled\x20for\x20shop\x20','./gateways/coinToPayService','8AocJoL','PaymentLinkService','failureMessage','webhookEvents','\x20transaction\x20URLs:','Processing\x20Noda\x20webhook:','additionalInfo','payment','ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20','\x20status\x20to\x20','payment.pending','TesSoft\x20Payment\x20System/1.0','paid','shop','430fPApkV','webhookLog','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook','ðŸ”—\x20Payment\x20','\x20webhook','telegramBotService','Error\x20processing\x20KLYME\x20webhook:','\x20from\x20','Failed\x20to\x20update\x20payment\x20link\x20counter:','paymentId','No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook','settings','Payment\x20','status','ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20','./gateways/plisioService','loggerService','342mGlLyB','\x20updated\x20successfully:\x20','parse','includes','30vfMdbC','processCoinToPayWebhook','__importDefault','Webhook\x20event\x20','\x20URLs','FAILED','isArray','now','Processing\x20Rapyd\x20webhook:','Failed\x20to\x20send\x20shop\x20webhook:','coinToPayService','nodaService','3055824NgZmgq','processNodaWebhook','57455871jrodaR','cointopay','bankId','log','orderId','PAID','stringify','No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook','customerName','PENDING','logShopWebhookSent','Error\x20processing\x20Noda\x20webhook:','paymentMethod','\x20status\x20change:\x20','Error\x20processing\x20CoinToPay\x20webhook:','_webhook_','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','Processing\x20CoinToPay\x20webhook:','No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook','create','gateway','Success','Error\x20processing\x20Plisio\x20webhook:','text','12UQHqav','ðŸ’¥\x20Payment\x20','noda','toLowerCase','remitterIban','NodaService','klymeService','findFirst','expired','POST','webhookUrl','Shop\x20webhook\x20sent\x20to\x20','cardLast4','plisio','updatePaymentStatus','sendShopWebhook','Error\x20parsing\x20webhook\x20events:','No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook','Processing\x20Plisio\x20webhook:','plisioService','shopId','__esModule','defineProperty','logWebhookProcessed','6999083XRlFzM','\x20failure\x20message:\x20','logShopWebhookError','klyme','processKlymeWebhook','\x20with\x20status\x20','length','./loggerService','PlisioService','customerEmail','564464oejysQ','application/json','\x20and\x20gateway:\x20','payment.success','./gateways/nodaService','sendPaymentNotification','logWebhookError','processRapydWebhook','./telegramBotService','txUrls','handleSuccessfulPayment','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'];a52_0xdd38=function(){return _0x206cf8;};return a52_0xdd38();}var __importDefault=this&&this[a52_0x5f413f(0x17d)]||function(_0x1f9456){const _0x512327=a52_0x5f413f;return _0x1f9456&&_0x1f9456[_0x512327(0x126)]?_0x1f9456:{'default':_0x1f9456};};Object[a52_0x5f413f(0x127)](exports,a52_0x5f413f(0x126),{'value':!![]}),exports['WebhookService']=void 0x0;function a52_0x512d(_0x282147,_0x4c4c2c){const _0xdd38=a52_0xdd38();return a52_0x512d=function(_0x512d71,_0x3729b7){_0x512d71=_0x512d71-0x10e;let _0x8b5fee=_0xdd38[_0x512d71];return _0x8b5fee;},a52_0x512d(_0x282147,_0x4c4c2c);}const database_1=__importDefault(require('../config/database')),plisioService_1=require(a52_0x5f413f(0x175)),rapydService_1=require(a52_0x5f413f(0x14c)),nodaService_1=require(a52_0x5f413f(0x137)),coinToPayService_1=require(a52_0x5f413f(0x157)),klymeService_1=require('./gateways/klymeService'),telegramBotService_1=require(a52_0x5f413f(0x13b)),paymentLinkService_1=require('./paymentLinkService'),loggerService_1=require(a52_0x5f413f(0x130));class WebhookService{constructor(){const _0x360250=a52_0x5f413f;this[_0x360250(0x124)]=new plisioService_1[(_0x360250(0x131))](),this[_0x360250(0x143)]=new rapydService_1['RapydService'](),this['nodaService']=new nodaService_1[(_0x360250(0x116))](),this[_0x360250(0x185)]=new coinToPayService_1['CoinToPayService'](),this[_0x360250(0x117)]=new klymeService_1['KlymeService'](),this[_0x360250(0x146)]=new paymentLinkService_1[(_0x360250(0x159))]();}async['processPlisioWebhook'](_0x41a3f3){const _0x613ab5=a52_0x5f413f;console[_0x613ab5(0x18c)](_0x613ab5(0x123),_0x41a3f3);try{const _0x1c3ca0=await this[_0x613ab5(0x124)]['processWebhook'](_0x41a3f3);if(!_0x1c3ca0['paymentId']){console[_0x613ab5(0x142)]('No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook');return;}await this['updatePaymentStatus'](_0x1c3ca0[_0x613ab5(0x16f)],_0x1c3ca0['status'],'plisio',_0x41a3f3,undefined,undefined,_0x1c3ca0['txUrls']),loggerService_1['loggerService']['logWebhookProcessed']('plisio',_0x1c3ca0['paymentId'],_0x613ab5(0x192),_0x1c3ca0[_0x613ab5(0x173)],_0x41a3f3);}catch(_0x45a34c){console['error'](_0x613ab5(0x10f),_0x45a34c),loggerService_1[_0x613ab5(0x176)][_0x613ab5(0x139)](_0x613ab5(0x11e),_0x45a34c,_0x41a3f3);throw _0x45a34c;}}async['processPlisioGatewayWebhook'](_0x58400c){const _0x5e0837=a52_0x5f413f;console[_0x5e0837(0x18c)](_0x5e0837(0x149),_0x58400c);try{const _0x594b2b=await this['plisioService']['processWebhook'](_0x58400c);if(!_0x594b2b[_0x5e0837(0x16f)]){console['error'](_0x5e0837(0x168));return;}await this[_0x5e0837(0x11f)](_0x594b2b[_0x5e0837(0x16f)],_0x594b2b[_0x5e0837(0x173)],_0x5e0837(0x11e),_0x58400c,undefined,undefined,_0x594b2b[_0x5e0837(0x13c)]),loggerService_1[_0x5e0837(0x176)][_0x5e0837(0x128)]('plisio_gateway',_0x594b2b['paymentId'],_0x5e0837(0x192),_0x594b2b['status'],_0x58400c);}catch(_0x182c91){console['error'](_0x5e0837(0x147),_0x182c91),loggerService_1[_0x5e0837(0x176)][_0x5e0837(0x139)]('plisio_gateway',_0x182c91,_0x58400c);throw _0x182c91;}}async[a52_0x5f413f(0x13a)](_0x526c3c){const _0x235e27=a52_0x5f413f;console['log'](_0x235e27(0x183),_0x526c3c);try{const _0x3836f1=await this[_0x235e27(0x143)][_0x235e27(0x141)](_0x526c3c);if(!_0x3836f1['paymentId']){console[_0x235e27(0x142)](_0x235e27(0x19b));return;}await this[_0x235e27(0x11f)](_0x3836f1['paymentId'],_0x3836f1['status'],_0x235e27(0x154),_0x526c3c,_0x3836f1[_0x235e27(0x15a)],_0x3836f1[_0x235e27(0x15e)]),loggerService_1['loggerService'][_0x235e27(0x128)](_0x235e27(0x154),_0x3836f1[_0x235e27(0x16f)],_0x235e27(0x192),_0x3836f1[_0x235e27(0x173)],_0x526c3c);}catch(_0x1bc5f6){console['error']('Error\x20processing\x20Rapyd\x20webhook:',_0x1bc5f6),loggerService_1['loggerService'][_0x235e27(0x139)](_0x235e27(0x154),_0x1bc5f6,_0x526c3c);throw _0x1bc5f6;}}async[a52_0x5f413f(0x188)](_0x2f75fe){const _0x42ea75=a52_0x5f413f;console[_0x42ea75(0x18c)](_0x42ea75(0x15d),_0x2f75fe);try{const _0x58860f=await this[_0x42ea75(0x186)]['processWebhook'](_0x2f75fe);if(!_0x58860f[_0x42ea75(0x16f)]){console[_0x42ea75(0x142)](_0x42ea75(0x122));return;}await this[_0x42ea75(0x11f)](_0x58860f[_0x42ea75(0x16f)],_0x58860f['status'],_0x42ea75(0x113),_0x2f75fe,undefined,_0x58860f[_0x42ea75(0x15e)]),loggerService_1[_0x42ea75(0x176)][_0x42ea75(0x128)](_0x42ea75(0x113),_0x58860f[_0x42ea75(0x16f)],_0x42ea75(0x192),_0x58860f[_0x42ea75(0x173)],_0x2f75fe);}catch(_0x2a564f){console[_0x42ea75(0x142)](_0x42ea75(0x194),_0x2a564f),loggerService_1[_0x42ea75(0x176)][_0x42ea75(0x139)](_0x42ea75(0x113),_0x2a564f,_0x2f75fe);throw _0x2a564f;}}async[a52_0x5f413f(0x17c)](_0x174a95){const _0x521d48=a52_0x5f413f;console[_0x521d48(0x18c)](_0x521d48(0x19a),_0x174a95);try{const _0x2ba4b5=await this[_0x521d48(0x185)]['processWebhook'](_0x174a95);if(!_0x2ba4b5['paymentId']){console[_0x521d48(0x142)](_0x521d48(0x170));return;}await this['updatePaymentStatus'](_0x2ba4b5[_0x521d48(0x16f)],_0x2ba4b5[_0x521d48(0x173)],'cointopay',_0x174a95),loggerService_1[_0x521d48(0x176)][_0x521d48(0x128)](_0x521d48(0x18a),_0x2ba4b5[_0x521d48(0x16f)],'PENDING',_0x2ba4b5[_0x521d48(0x173)],_0x174a95);}catch(_0x44cf9d){console[_0x521d48(0x142)](_0x521d48(0x197),_0x44cf9d),loggerService_1[_0x521d48(0x176)]['logWebhookError'](_0x521d48(0x18a),_0x44cf9d,_0x174a95);throw _0x44cf9d;}}async[a52_0x5f413f(0x12d)](_0xcafada){const _0x1a69ba=a52_0x5f413f;console[_0x1a69ba(0x18c)]('Processing\x20KLYME\x20webhook:',_0xcafada);try{const _0x88865=await this['klymeService'][_0x1a69ba(0x141)](_0xcafada);if(!_0x88865[_0x1a69ba(0x16f)]){console[_0x1a69ba(0x142)](_0x1a69ba(0x190));return;}const _0x293e31=_0x88865[_0x1a69ba(0x153)]?'klyme_'+_0x88865['region'][_0x1a69ba(0x114)]():_0x1a69ba(0x144);await this[_0x1a69ba(0x11f)](_0x88865[_0x1a69ba(0x16f)],_0x88865[_0x1a69ba(0x173)],_0x293e31,_0xcafada,undefined,_0x88865[_0x1a69ba(0x15e)]),loggerService_1[_0x1a69ba(0x176)][_0x1a69ba(0x128)](_0x1a69ba(0x12c),_0x88865['paymentId'],_0x1a69ba(0x192),_0x88865[_0x1a69ba(0x173)],_0xcafada);}catch(_0x45af8a){console[_0x1a69ba(0x142)](_0x1a69ba(0x16c),_0x45af8a),loggerService_1[_0x1a69ba(0x176)][_0x1a69ba(0x139)](_0x1a69ba(0x12c),_0x45af8a,_0xcafada);throw _0x45af8a;}}async[a52_0x5f413f(0x11f)](_0x24be10,_0x3ffaff,_0x5d9dfe,_0x4b63b5,_0x2742a4,_0x1f551b,_0x57c8ae){const _0x144a04=a52_0x5f413f;console[_0x144a04(0x18c)]('ðŸ”„\x20Updating\x20payment\x20'+_0x24be10+_0x144a04(0x161)+_0x3ffaff+_0x144a04(0x16d)+_0x5d9dfe+_0x144a04(0x16a));_0x2742a4&&console[_0x144a04(0x18c)](_0x144a04(0x112)+_0x24be10+_0x144a04(0x12a)+_0x2742a4);_0x57c8ae&&_0x57c8ae[_0x144a04(0x12f)]>0x0&&console[_0x144a04(0x18c)](_0x144a04(0x169)+_0x24be10+_0x144a04(0x15c),_0x57c8ae);const _0xc8e81d=await database_1[_0x144a04(0x14a)]['payment'][_0x144a04(0x118)]({'where':{'gatewayOrderId':_0x24be10,'gateway':_0x5d9dfe},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xc8e81d){console[_0x144a04(0x142)](_0x144a04(0x199)+_0x24be10+_0x144a04(0x135)+_0x5d9dfe);return;}const _0x411ee0=_0xc8e81d[_0x144a04(0x173)];if(_0x411ee0===_0x3ffaff){console['log'](_0x144a04(0x172)+_0xc8e81d['id']+'\x20status\x20unchanged\x20('+_0x3ffaff+')');return;}console['log'](_0x144a04(0x172)+_0xc8e81d['id']+_0x144a04(0x196)+_0x411ee0+'\x20->\x20'+_0x3ffaff);const _0x2c75ea={'status':_0x3ffaff,'updatedAt':new Date()};_0x2742a4&&(_0x2c75ea[_0x144a04(0x15a)]=_0x2742a4,console[_0x144a04(0x18c)]('ðŸ’¾\x20Saving\x20failure\x20message:\x20'+_0x2742a4));_0x57c8ae&&_0x57c8ae[_0x144a04(0x12f)]>0x0&&(_0x2c75ea['txUrls']=JSON['stringify'](_0x57c8ae),console['log'](_0x144a04(0x160)+JSON[_0x144a04(0x18f)](_0x57c8ae)));_0x3ffaff===_0x144a04(0x18e)&&_0x411ee0!==_0x144a04(0x18e)&&(_0x2c75ea[_0x144a04(0x150)]=new Date());_0x1f551b&&(_0x1f551b[_0x144a04(0x11d)]&&(_0x2c75ea[_0x144a04(0x11d)]=_0x1f551b['cardLast4']),_0x1f551b[_0x144a04(0x195)]&&(_0x2c75ea['paymentMethod']=_0x1f551b[_0x144a04(0x195)]),_0x1f551b['bankId']&&(_0x2c75ea[_0x144a04(0x18b)]=_0x1f551b[_0x144a04(0x18b)]),_0x1f551b[_0x144a04(0x115)]&&(_0x2c75ea['remitterIban']=_0x1f551b[_0x144a04(0x115)]),_0x1f551b[_0x144a04(0x14b)]&&(_0x2c75ea['remitterName']=_0x1f551b[_0x144a04(0x14b)]));await database_1[_0x144a04(0x14a)][_0x144a04(0x15f)]['update']({'where':{'id':_0xc8e81d['id']},'data':_0x2c75ea});if(_0x3ffaff==='PAID'&&_0x411ee0!==_0x144a04(0x18e))try{await this[_0x144a04(0x146)][_0x144a04(0x13d)](_0xc8e81d['id']);}catch(_0x84c898){console[_0x144a04(0x142)](_0x144a04(0x16e),_0x84c898);}await database_1[_0x144a04(0x14a)][_0x144a04(0x167)][_0x144a04(0x19c)]({'data':{'paymentId':_0xc8e81d['id'],'shopId':_0xc8e81d[_0x144a04(0x125)],'event':_0x5d9dfe+_0x144a04(0x198)+_0x3ffaff[_0x144a04(0x114)](),'statusCode':0xc8,'responseBody':JSON[_0x144a04(0x18f)]({'oldStatus':_0x411ee0,'newStatus':_0x3ffaff,'failureMessage':_0x2742a4,'txUrls':_0x57c8ae,'webhookData':_0x4b63b5})}}),await this[_0x144a04(0x120)](_0xc8e81d,_0x3ffaff),await this['sendPaymentStatusNotification'](_0xc8e81d,_0x3ffaff),console['log']('âœ…\x20Payment\x20'+_0xc8e81d['id']+_0x144a04(0x178)+_0x411ee0+_0x144a04(0x152)+_0x3ffaff),_0x2742a4&&console['log']('ðŸ’¾\x20Failure\x20message\x20saved:\x20'+_0x2742a4),_0x57c8ae&&_0x57c8ae[_0x144a04(0x12f)]>0x0&&console['log'](_0x144a04(0x174)+_0x57c8ae[_0x144a04(0x12f)]+_0x144a04(0x17f));}async[a52_0x5f413f(0x120)](_0x339782,_0xa75edb){const _0x47ba76=a52_0x5f413f,_0x1da67d=Date[_0x47ba76(0x182)]();try{const _0x10d827=_0x339782[_0x47ba76(0x165)],_0xef0d53=_0x10d827[_0x47ba76(0x171)];if(!_0xef0d53?.[_0x47ba76(0x11b)]){console[_0x47ba76(0x18c)](_0x47ba76(0x13e)+_0x10d827['id']);return;}const _0x20fa93=_0xa75edb===_0x47ba76(0x18e)?_0x47ba76(0x136):_0xa75edb===_0x47ba76(0x180)?_0x47ba76(0x140):_0xa75edb===_0x47ba76(0x14e)?_0x47ba76(0x140):_0x47ba76(0x162);let _0x3e8dc9=[];if(_0xef0d53[_0x47ba76(0x15b)])try{_0x3e8dc9=Array[_0x47ba76(0x181)](_0xef0d53[_0x47ba76(0x15b)])?_0xef0d53[_0x47ba76(0x15b)]:JSON[_0x47ba76(0x179)](_0xef0d53[_0x47ba76(0x15b)]);}catch(_0x2383fc){console[_0x47ba76(0x142)](_0x47ba76(0x121),_0x2383fc),_0x3e8dc9=[];}if(!_0x3e8dc9[_0x47ba76(0x17a)](_0x20fa93)){console[_0x47ba76(0x18c)](_0x47ba76(0x17e)+_0x20fa93+_0x47ba76(0x156)+_0x10d827['id']);return;}let _0x52e1fb;if(_0x339782[_0x47ba76(0x13c)])try{_0x52e1fb=JSON['parse'](_0x339782['txUrls']);}catch(_0x24a4be){console[_0x47ba76(0x142)]('Error\x20parsing\x20tx_urls\x20for\x20webhook:',_0x24a4be),_0x52e1fb=undefined;}const _0x55ee4={'event':_0x20fa93,'payment':{'id':_0x339782['id'],'order_id':_0x339782[_0x47ba76(0x18d)],'gateway_order_id':_0x339782['gatewayOrderId'],'gateway':_0x339782[_0x47ba76(0x19d)],'amount':_0x339782['amount'],'currency':_0x339782['currency'],'status':_0xa75edb[_0x47ba76(0x114)](),'customer_email':_0x339782[_0x47ba76(0x132)],'customer_name':_0x339782[_0x47ba76(0x191)],'failure_message':_0x339782[_0x47ba76(0x15a)],'tx_urls':_0x52e1fb,'created_at':_0x339782['createdAt'],'updated_at':new Date()}},_0x462dd8=await fetch(_0xef0d53[_0x47ba76(0x11b)],{'method':_0x47ba76(0x11a),'headers':{'Content-Type':_0x47ba76(0x134),'User-Agent':_0x47ba76(0x163)},'body':JSON[_0x47ba76(0x18f)](_0x55ee4)}),_0x46b5f5=Date[_0x47ba76(0x182)]()-_0x1da67d,_0x17905a=_0x462dd8['ok']?_0x47ba76(0x10e):await _0x462dd8[_0x47ba76(0x110)]();loggerService_1[_0x47ba76(0x176)][_0x47ba76(0x193)](_0x339782[_0x47ba76(0x125)],_0xef0d53[_0x47ba76(0x11b)],_0x20fa93,_0x462dd8[_0x47ba76(0x173)],_0x46b5f5,_0x55ee4),console['log'](_0x47ba76(0x11c)+_0xef0d53[_0x47ba76(0x11b)]+_0x47ba76(0x12e)+_0x462dd8['status']+'\x20('+_0x46b5f5+_0x47ba76(0x14f));}catch(_0x511f02){console['error'](_0x47ba76(0x184),_0x511f02),loggerService_1[_0x47ba76(0x176)][_0x47ba76(0x12b)](_0x339782[_0x47ba76(0x125)],_0x339782[_0x47ba76(0x165)]?.[_0x47ba76(0x171)]?.[_0x47ba76(0x11b)]||'unknown','webhook_send',_0x511f02,{});}}async[a52_0x5f413f(0x148)](_0x1c1ce8,_0x12052b){const _0x3d688d=a52_0x5f413f;try{const _0x1a0589={'PENDING':_0x3d688d(0x13f),'PAID':_0x3d688d(0x164),'FAILED':_0x3d688d(0x155),'EXPIRED':_0x3d688d(0x119)},_0x40ae21=_0x1a0589[_0x12052b];if(!_0x40ae21||_0x40ae21===_0x3d688d(0x13f))return;await telegramBotService_1[_0x3d688d(0x16b)][_0x3d688d(0x138)](_0x1c1ce8[_0x3d688d(0x125)],_0x1c1ce8,_0x40ae21);}catch(_0x1630f4){console[_0x3d688d(0x142)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x1630f4);}}}exports['WebhookService']=WebhookService;