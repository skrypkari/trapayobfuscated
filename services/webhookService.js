'use strict';function a66_0x26ef(_0x52e986,_0x420661){const _0x33fa36=a66_0x33fa();return a66_0x26ef=function(_0x26ef83,_0x574fe3){_0x26ef83=_0x26ef83-0x196;let _0x2ad6cb=_0x33fa36[_0x26ef83];return _0x2ad6cb;},a66_0x26ef(_0x52e986,_0x420661);}const a66_0x1ac708=a66_0x26ef;(function(_0x14a1d3,_0x1349a7){const _0x417afe=a66_0x26ef,_0x3003ab=_0x14a1d3();while(!![]){try{const _0x1d313a=-parseInt(_0x417afe(0x274))/0x1*(-parseInt(_0x417afe(0x2c5))/0x2)+parseInt(_0x417afe(0x225))/0x3*(-parseInt(_0x417afe(0x1e0))/0x4)+-parseInt(_0x417afe(0x2d3))/0x5*(-parseInt(_0x417afe(0x1be))/0x6)+parseInt(_0x417afe(0x23c))/0x7*(parseInt(_0x417afe(0x1f8))/0x8)+parseInt(_0x417afe(0x2b4))/0x9+parseInt(_0x417afe(0x2bb))/0xa+-parseInt(_0x417afe(0x240))/0xb;if(_0x1d313a===_0x1349a7)break;else _0x3003ab['push'](_0x3003ab['shift']());}catch(_0x97f0fc){_0x3003ab['push'](_0x3003ab['shift']());}}}(a66_0x33fa,0x550b5));function a66_0x33fa(){const _0x27e132=['No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','updatePaymentStatus','✅\x20Shop\x20','./gateways/rapydService','myxspend_','📊\x20VISA\x20webhook\x20result:','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard',',\x20currentPayments=',',\x20status=','3703TMgNDJ',',\x20card:\x20****','toLowerCase','\x20in\x20shop\x20','7014194umYKlI','paidAt','logShopWebhookSent','🔄\x20Processing\x20CoinToPay2\x20webhook:','__esModule','💸\x20Additional\x20chargeback\x20penalty:\x20-','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','now','🔄\x20Processing\x20CoinToPay\x20webhook:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance',':\x20type=','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','application/json','client_transaction_id','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','\x20for\x20AmPay\x20TRY\x20webhook','create','MasterCard\x20payment\x20not\x20found:\x20','webhookLog','visa','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','noda','📊\x20Noda\x20webhook:\x20Payment\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','./gateways/ampayService','mastercard','❌\x20Error\x20processing\x20MasterCard\x20webhook:','\x20for\x20AmPay\x20webhook','./gateways/coinToPay2Service','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','Query\x20params:','gatewaySettings','default','✅\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20','unknown','amountAfterGatewayCommissionUSDT','DECLINED','nodaService','sendPaymentNotification','entries','FAILED','paymentMethod','processAmerWebhook','🔄\x20Processing\x20Amer\x20webhook:','3VbzUHk','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','\x20→\x20','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','processKlymeWebhook','paymentId','📊\x20Payment\x20status:\x20','payment','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','EXPIRED','cointopay','ampayTRYService','📊\x20AmPay\x20TRY\x20webhook\x20data:','getGatewayCommission','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','payment.success','failureMessage','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','errorMessage','Success','customerOrderId','✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','VISA','payment_method','webhook_send','created','./telegramBotService','Body\x20data:','Payment\x20','\x20not\x20found','processAmPayWebhook','telegramBotService','chargebackAmount','keys','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','findFirst',',\x20Gateway=','Failed\x20to\x20send\x20shop\x20webhook:','visa_mastercard','bankId','processPlisioGatewayWebhook','payment.failed','loggerService','shop','🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','rapydService','Error\x20processing\x20Noda\x20webhook:','💰\x20Gateway\x20','📊\x20KLYME\x20webhook:\x20Payment\x20','\x20with\x20status\x20','📈\x20Payment\x20','amerService',',\x20gateway\x20','./gateways/coinToPayService','commission','remitterName','🏪\x20Shop\x20','💰\x20Amount\x20after\x20gateway\x20commission:\x20','\x22,\x20id=\x22','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','5031738teyJVR','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','Payment\x20not\x20found:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x22,\x20newStatus=\x22','error','3383490rkyXAt','cardLast4','webhookUrl','parse','toUpperCase','failed','type','username','Not\x20found','💰\x20Removing\x20from\x20balance:\x20','32614hIQdcy','./gateways/plisioService','plisio_gateway','txUrls','RapydService','💰\x20Adding\x20to\x20balance:\x20','coinToPayService','✅\x20Found\x20payment\x20','system_id','sendPaymentStatusNotification','\x20=\x20','ms)','orderId','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','5TfFAAY','ℹ️\x20Decline\x20reason:\x20','No\x20additional\x20info','expired','AmerService','🔄\x20Processing\x20Noda\x20webhook:','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','currency','ampay_try',',\x20gatewayOrderId:\x20','log','📊\x20MasterCard\x20webhook\x20result:','Payment\x20not\x20found',',\x20newStatus=','🔄\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','sendShopWebhook',',\x20Card=****','Payment\x20System/1.0','\x20not\x20enabled\x20for\x20shop\x20','PAID','updatedAt','PlisioService','CHARGEBACK','toISOString','processAmPayTRYWebhook','stringify','desc','Gateway\x20','paymentLinkId','\x20(orderId:\x20','🔄\x20Additional\x20data:','../config/database','paymentLink','🔍\x20Found\x20VISA\x20payment:\x20ID=','currentPayments','processCoinToPayWebhook','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','paid','%\x20gateway\x20commission)','klymeService',',\x20gatewayPaymentId:\x20','128208DQhVEO','isArray','shopId','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','💰\x20Converting\x20','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','Found\x20payment\x20','POST','ampay','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','\x20USDT','./gateways/mastercardService','Error\x20parsing\x20webhook\x20events:','createdAt','visa/mastercard','visaMasterCardService','❌\x20Payment\x20link\x20','Error\x20processing\x20KLYME\x20webhook:','\x22,\x20orderId=\x22','\x20and\x20-','\x20->\x20','\x20balance\x20updated:\x20','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','currencyService','findMany','settings','\x20status\x20','processWebhook','gatewayOrderId','logWebhookError','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook',',\x20GatewayOrderId=','🔄\x20MyXSpend\x20status\x20',',\x20GatewayPaymentId=','1304AkUOfL','amount','📤\x20Shop\x20webhook\x20sent\x20to\x20','customerEmail','balance','findUnique','./gateways/ampayTRYService','REFUND','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','\x20-\x20','ℹ️\x20AmPay\x20status\x20','amountUSDT','plisio','💰\x20Final\x20balance\x20after\x20chargeback:\x20','\x20status\x20updated\x20to\x20FAILED','🔍\x20Search\x20result:\x20','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','visa_','❌\x20Error\x20processing\x20Amer\x20webhook:','amer','coinToPay2Service','Webhook\x20event\x20','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','processMyXSpendWebhook','5448psWurB','klyme','webhookEvents','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','📊\x20CoinToPay\x20webhook:\x20Payment\x20','Error\x20processing\x20Plisio\x20webhook:','❌\x20Available\x20webhook\x20fields:','status_addition_info','gateway','📊\x20Plisio\x20webhook:\x20Payment\x20','🔄\x20Processing\x20MasterCard\x20webhook:','\x20commission\x20for\x20shop\x20','Found','plisioService','remitterIban','$transaction','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','cointopay2','chargeback','\x20current\x20balance:\x20','myxspend','gatewayPaymentId','logWebhookProcessed','🔍\x20VISA\x20payment\x20search\x20result:\x20','📊\x20Amer\x20webhook:\x20Payment\x20','ampay_','\x20+\x20','WebhookService','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','ampayService','dateTime','rapyd','text','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','payment.pending','./gateways/nodaService','status','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','\x20(Status:\x20','processMasterCardWebhook','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','🔍\x20VISA\x20payment\x20search\x20executed','./gateways/amerService','3147oKLeAU','additionalInfo','\x20updated:\x20currentPayments=','📈\x20Payment\x20details:\x20oldStatus=\x22','processPlisioWebhook','MASTERCARD','Error\x20processing\x20CoinToPay2\x20webhook:','📊\x20VISA\x20payment\x20found:\x20','AmPayService','./currencyService','update','toFixed','📊\x20Rapyd\x20webhook:\x20Payment\x20'];a66_0x33fa=function(){return _0x27e132;};return a66_0x33fa();}var __importDefault=this&&this['__importDefault']||function(_0x13faad){const _0x445c0f=a66_0x26ef;return _0x13faad&&_0x13faad[_0x445c0f(0x244)]?_0x13faad:{'default':_0x13faad};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a66_0x1ac708(0x1b4))),plisioService_1=require(a66_0x1ac708(0x2c6)),rapydService_1=require(a66_0x1ac708(0x236)),nodaService_1=require(a66_0x1ac708(0x21c)),coinToPayService_1=require(a66_0x1ac708(0x2ad)),coinToPay2Service_1=require(a66_0x1ac708(0x264)),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a66_0x1ac708(0x1c9)),amerService_1=require(a66_0x1ac708(0x224)),ampayService_1=require(a66_0x1ac708(0x260)),ampayTRYService_1=require(a66_0x1ac708(0x1e6)),telegramBotService_1=require(a66_0x1ac708(0x290)),currencyService_1=require(a66_0x1ac708(0x22e)),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x576eb9=a66_0x1ac708;this[_0x576eb9(0x205)]=new plisioService_1[(_0x576eb9(0x1aa))](),this[_0x576eb9(0x2a5)]=new rapydService_1[(_0x576eb9(0x2c9))](),this[_0x576eb9(0x26d)]=new nodaService_1['NodaService'](),this['coinToPayService']=new coinToPayService_1['CoinToPayService'](),this[_0x576eb9(0x1f4)]=new coinToPay2Service_1['CoinToPay2Service'](),this[_0x576eb9(0x1bc)]=new klymeService_1['KlymeService'](),this['visaMasterCardService']=new mastercardService_1['VisaMasterCardService'](),this[_0x576eb9(0x2ab)]=new amerService_1[(_0x576eb9(0x199))](),this[_0x576eb9(0x216)]=new ampayService_1[(_0x576eb9(0x22d))](),this[_0x576eb9(0x27f)]=new ampayTRYService_1['AmPayTRYService']();}async[a66_0x1ac708(0x234)](_0x1b3e3a,_0x5972c0,_0x5560cb){const _0x114990=a66_0x1ac708;console[_0x114990(0x19f)]('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x1b3e3a+_0x114990(0x1a2)+_0x5972c0),console[_0x114990(0x19f)](_0x114990(0x1b3),_0x5560cb),await database_1[_0x114990(0x268)][_0x114990(0x207)](async _0x340971=>{const _0x349a08=_0x114990,_0x34e827=await _0x340971[_0x349a08(0x27b)][_0x349a08(0x1e5)]({'where':{'id':_0x1b3e3a},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x34e827)throw new Error(_0x349a08(0x292)+_0x1b3e3a+_0x349a08(0x293));const _0xddf1ba=_0x34e827[_0x349a08(0x21d)],_0x557846=_0x34e827['shop'];console[_0x349a08(0x19f)]('💰\x20Payment\x20'+_0x1b3e3a+':\x20'+_0xddf1ba+_0x349a08(0x1d2)+_0x5972c0),console[_0x349a08(0x19f)](_0x349a08(0x2b0)+_0x557846['username']+_0x349a08(0x20c)+_0x557846[_0x349a08(0x1e4)]+_0x349a08(0x1c8));const _0x511829={'status':_0x5972c0['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x5560cb?.[_0x349a08(0x285)]&&(_0x511829[_0x349a08(0x285)]=_0x5560cb['failureMessage']);_0x5560cb?.[_0x349a08(0x2c8)]&&(_0x511829['txUrls']=JSON[_0x349a08(0x1ae)](_0x5560cb[_0x349a08(0x2c8)]));_0x5560cb?.['cardLast4']&&(_0x511829[_0x349a08(0x2bc)]=_0x5560cb[_0x349a08(0x2bc)]);_0x5560cb?.[_0x349a08(0x271)]&&(_0x511829[_0x349a08(0x271)]=_0x5560cb[_0x349a08(0x271)]);_0x5560cb?.[_0x349a08(0x29e)]&&(_0x511829[_0x349a08(0x29e)]=_0x5560cb[_0x349a08(0x29e)]);_0x5560cb?.[_0x349a08(0x206)]&&(_0x511829['remitterIban']=_0x5560cb[_0x349a08(0x206)]);_0x5560cb?.[_0x349a08(0x2af)]&&(_0x511829[_0x349a08(0x2af)]=_0x5560cb[_0x349a08(0x2af)]);let _0x13b4bd=_0x557846['balance'],_0x4aa8f2='';if(_0x5972c0['toUpperCase']()===_0x349a08(0x1a8)&&_0xddf1ba!==_0x349a08(0x1a8)){const _0x5ba669=await currencyService_1[_0x349a08(0x1d5)]['convertToUSDT'](_0x34e827[_0x349a08(0x1e1)],_0x34e827[_0x349a08(0x19c)]),_0x348079=await this[_0x349a08(0x281)](_0x557846['id'],_0x34e827['gateway']),_0x36e927=_0x5ba669*(0x1-_0x348079/0x64);_0x13b4bd+=_0x36e927,_0x4aa8f2='+'+_0x36e927['toFixed'](0x6)+_0x349a08(0x222)+_0x348079+_0x349a08(0x1bb),_0x511829[_0x349a08(0x1eb)]=_0x5ba669,_0x511829['amountAfterGatewayCommissionUSDT']=_0x36e927,_0x511829['gatewayCommissionRate']=_0x348079,_0x511829[_0x349a08(0x241)]=new Date(),console['log'](_0x349a08(0x1c2)+_0x34e827['amount']+'\x20'+_0x34e827[_0x349a08(0x19c)]+_0x349a08(0x1d2)+_0x5ba669['toFixed'](0x6)+_0x349a08(0x1c8)),console[_0x349a08(0x19f)](_0x349a08(0x2a7)+_0x34e827[_0x349a08(0x200)]+'\x20commission:\x20'+_0x348079+'%'),console[_0x349a08(0x19f)](_0x349a08(0x2b1)+_0x36e927[_0x349a08(0x230)](0x6)+_0x349a08(0x1c8)),console[_0x349a08(0x19f)](_0x349a08(0x2ca)+_0x557846[_0x349a08(0x1e4)]+_0x349a08(0x213)+_0x36e927[_0x349a08(0x230)](0x6)+_0x349a08(0x2cf)+_0x13b4bd['toFixed'](0x6)+_0x349a08(0x1c8));}else{if(_0xddf1ba===_0x349a08(0x1a8)&&_0x5972c0['toUpperCase']()!==_0x349a08(0x1a8)){let _0x3171fe;if(_0x34e827[_0x349a08(0x26b)])_0x3171fe=_0x34e827[_0x349a08(0x26b)];else{if(_0x34e827[_0x349a08(0x1eb)]){const _0x1e00ca=await this[_0x349a08(0x281)](_0x557846['id'],_0x34e827[_0x349a08(0x200)]);_0x3171fe=_0x34e827[_0x349a08(0x1eb)]*(0x1-_0x1e00ca/0x64);}else console['log'](_0x349a08(0x24a)),_0x3171fe=0x0;}_0x3171fe>0x0&&(_0x13b4bd-=_0x3171fe,_0x4aa8f2='-'+_0x3171fe['toFixed'](0x6)+_0x349a08(0x24c),_0x511829[_0x349a08(0x1eb)]=null,_0x511829['amountAfterGatewayCommissionUSDT']=null,_0x511829[_0x349a08(0x241)]=null,console['log'](_0x349a08(0x2c4)+_0x557846[_0x349a08(0x1e4)]+_0x349a08(0x1e9)+_0x3171fe['toFixed'](0x6)+_0x349a08(0x2cf)+_0x13b4bd[_0x349a08(0x230)](0x6)+_0x349a08(0x1c8)));}}if(_0x5972c0[_0x349a08(0x2bf)]()==='CHARGEBACK'){const _0x2c4b9a=_0x5560cb?.[_0x349a08(0x296)]||0x0;_0x2c4b9a>0x0&&(_0x13b4bd-=_0x2c4b9a,_0x4aa8f2+=_0x349a08(0x1d1)+_0x2c4b9a[_0x349a08(0x230)](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0x511829[_0x349a08(0x296)]=_0x2c4b9a,console[_0x349a08(0x19f)](_0x349a08(0x245)+_0x2c4b9a[_0x349a08(0x230)](0x6)+_0x349a08(0x1c8)),console[_0x349a08(0x19f)](_0x349a08(0x1ed)+_0x13b4bd[_0x349a08(0x230)](0x6)+_0x349a08(0x1c8)));}const _0x1a1cc9=await _0x340971[_0x349a08(0x27b)][_0x349a08(0x22f)]({'where':{'id':_0x1b3e3a},'data':_0x511829});_0x13b4bd!==_0x557846[_0x349a08(0x1e4)]&&(await _0x340971[_0x349a08(0x2a2)][_0x349a08(0x22f)]({'where':{'id':_0x557846['id']},'data':{'balance':_0x13b4bd}}),console[_0x349a08(0x19f)](_0x349a08(0x235)+_0x557846[_0x349a08(0x2c2)]+_0x349a08(0x1d3)+_0x557846[_0x349a08(0x1e4)][_0x349a08(0x230)](0x6)+_0x349a08(0x1d2)+_0x13b4bd[_0x349a08(0x230)](0x6)+_0x349a08(0x1c8)),console[_0x349a08(0x19f)]('📝\x20Reason:\x20'+_0x4aa8f2));await _0x340971[_0x349a08(0x253)][_0x349a08(0x251)]({'data':{'paymentId':_0x1b3e3a,'shopId':_0x557846['id'],'event':'webhook_status_change_'+_0x5972c0['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x349a08(0x1ae)]({'oldStatus':_0xddf1ba,'newStatus':_0x5972c0[_0x349a08(0x2bf)](),'balanceChange':_0x4aa8f2||'no\x20balance\x20change','oldBalance':_0x557846[_0x349a08(0x1e4)],'newBalance':_0x13b4bd,'amountUSDT':_0x511829[_0x349a08(0x1eb)],'additionalData':_0x5560cb,'timestamp':new Date()[_0x349a08(0x1ac)]()})}}),await this[_0x349a08(0x1a4)]({..._0x34e827,..._0x1a1cc9,'shop':_0x557846},_0x5972c0['toUpperCase']()),await this[_0x349a08(0x2ce)]({..._0x34e827,..._0x1a1cc9},_0x5972c0[_0x349a08(0x2bf)]());if(_0xddf1ba!=='PAID'&&_0x5972c0[_0x349a08(0x2bf)]()===_0x349a08(0x1a8)){console['log'](_0x349a08(0x2aa)+_0x1b3e3a+_0x349a08(0x25c)),console['log'](_0x349a08(0x228)+_0xddf1ba+_0x349a08(0x2b9)+_0x5972c0[_0x349a08(0x2bf)]()+'\x22,\x20paymentLinkId=\x22'+_0x34e827[_0x349a08(0x1b1)]+'\x22');if(_0x34e827[_0x349a08(0x1b1)])try{const _0x4254b4=await _0x340971[_0x349a08(0x1b5)][_0x349a08(0x1e5)]({'where':{'id':_0x34e827[_0x349a08(0x1b1)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4254b4){console[_0x349a08(0x19f)]('📈\x20Found\x20payment\x20link\x20'+_0x4254b4['id']+_0x349a08(0x24b)+_0x4254b4[_0x349a08(0x2c1)]+_0x349a08(0x23a)+_0x4254b4['currentPayments']+_0x349a08(0x23b)+_0x4254b4[_0x349a08(0x21d)]);const _0x1f35c3=_0x4254b4['currentPayments']+0x1,_0x58cf42=_0x4254b4[_0x349a08(0x2c1)]==='SINGLE'?'COMPLETED':_0x4254b4['status'];await _0x340971['paymentLink'][_0x349a08(0x22f)]({'where':{'id':_0x34e827[_0x349a08(0x1b1)]},'data':{'currentPayments':_0x1f35c3,'status':_0x58cf42,'updatedAt':new Date()}}),console[_0x349a08(0x19f)]('✅\x20Payment\x20link\x20'+_0x4254b4['id']+_0x349a08(0x227)+_0x4254b4[_0x349a08(0x1b7)]+'\x20->\x20'+_0x1f35c3+_0x349a08(0x23b)+_0x4254b4[_0x349a08(0x21d)]+_0x349a08(0x1d2)+_0x58cf42);}else console[_0x349a08(0x19f)](_0x349a08(0x1ce)+_0x34e827['paymentLinkId']+_0x349a08(0x293));}catch(_0x1c5a05){console['error']('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x1c5a05);}else console[_0x349a08(0x19f)](_0x349a08(0x2aa)+_0x1b3e3a+_0x349a08(0x1c1));}else console[_0x349a08(0x19f)](_0x349a08(0x2aa)+_0x1b3e3a+_0x349a08(0x258)+_0xddf1ba+_0x349a08(0x1d2)+_0x5972c0['toUpperCase']());});}async[a66_0x1ac708(0x229)](_0x2657d7){const _0x1f626e=a66_0x1ac708;console['log']('🔄\x20Processing\x20Plisio\x20webhook:',_0x2657d7);try{const _0x2ca5e2=await this[_0x1f626e(0x205)]['processWebhook'](_0x2657d7);if(!_0x2ca5e2['paymentId'])throw new Error(_0x1f626e(0x208));const _0x1ada4a=await database_1[_0x1f626e(0x268)][_0x1f626e(0x27b)][_0x1f626e(0x29a)]({'where':{'gatewayOrderId':_0x2ca5e2[_0x1f626e(0x279)]}});if(!_0x1ada4a){console[_0x1f626e(0x2ba)]('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x2ca5e2[_0x1f626e(0x279)]);return;}console['log'](_0x1f626e(0x201)+_0x1ada4a['id']+_0x1f626e(0x1d8)+_0x2ca5e2[_0x1f626e(0x21d)]),await this['updatePaymentStatus'](_0x1ada4a['id'],_0x2ca5e2[_0x1f626e(0x21d)],{'txUrls':_0x2ca5e2['txUrls']}),loggerService_1['loggerService']['logWebhookProcessed'](_0x1f626e(0x1ec),_0x1ada4a['id'],_0x1ada4a['status'],_0x2ca5e2[_0x1f626e(0x21d)],_0x2657d7);}catch(_0x54b743){console[_0x1f626e(0x2ba)](_0x1f626e(0x1fd),_0x54b743),loggerService_1[_0x1f626e(0x2a1)][_0x1f626e(0x1db)](_0x1f626e(0x1ec),_0x54b743,_0x2657d7);throw _0x54b743;}}async[a66_0x1ac708(0x29f)](_0x11361c){const _0x47b4c7=a66_0x1ac708;console[_0x47b4c7(0x19f)](_0x47b4c7(0x265),_0x11361c);try{const _0x5971fb=await this[_0x47b4c7(0x205)][_0x47b4c7(0x1d9)](_0x11361c);if(!_0x5971fb[_0x47b4c7(0x279)])throw new Error(_0x47b4c7(0x277));const _0x190af9=await database_1['default'][_0x47b4c7(0x27b)][_0x47b4c7(0x29a)]({'where':{'gatewayOrderId':_0x5971fb[_0x47b4c7(0x279)]}});if(!_0x190af9){console[_0x47b4c7(0x2ba)](_0x47b4c7(0x215)+_0x5971fb[_0x47b4c7(0x279)]);return;}console[_0x47b4c7(0x19f)](_0x47b4c7(0x246)+_0x190af9['id']+_0x47b4c7(0x1d8)+_0x5971fb[_0x47b4c7(0x21d)]),await this[_0x47b4c7(0x234)](_0x190af9['id'],_0x5971fb[_0x47b4c7(0x21d)],{'txUrls':_0x5971fb[_0x47b4c7(0x2c8)]}),loggerService_1['loggerService'][_0x47b4c7(0x20f)](_0x47b4c7(0x2c7),_0x190af9['id'],_0x190af9['status'],_0x5971fb[_0x47b4c7(0x21d)],_0x11361c);}catch(_0x287783){console[_0x47b4c7(0x2ba)](_0x47b4c7(0x287),_0x287783),loggerService_1[_0x47b4c7(0x2a1)][_0x47b4c7(0x1db)](_0x47b4c7(0x2c7),_0x287783,_0x11361c);throw _0x287783;}}async['processRapydWebhook'](_0x1f122e){const _0x27c03e=a66_0x1ac708;console[_0x27c03e(0x19f)]('🔄\x20Processing\x20Rapyd\x20webhook:',_0x1f122e);try{const _0x296931=await this['rapydService'][_0x27c03e(0x1d9)](_0x1f122e);if(!_0x296931[_0x27c03e(0x279)])throw new Error(_0x27c03e(0x275));const _0x363654=await database_1[_0x27c03e(0x268)][_0x27c03e(0x27b)][_0x27c03e(0x29a)]({'where':{'gatewayOrderId':_0x296931['paymentId']}});if(!_0x363654){console[_0x27c03e(0x2ba)](_0x27c03e(0x19b)+_0x296931[_0x27c03e(0x279)]);return;}console[_0x27c03e(0x19f)](_0x27c03e(0x231)+_0x363654['id']+'\x20status\x20'+_0x296931[_0x27c03e(0x21d)]),await this['updatePaymentStatus'](_0x363654['id'],_0x296931[_0x27c03e(0x21d)],{'failureMessage':_0x296931[_0x27c03e(0x285)],'cardLast4':_0x296931[_0x27c03e(0x226)]?.[_0x27c03e(0x2bc)],'paymentMethod':_0x296931[_0x27c03e(0x226)]?.['paymentMethod']}),loggerService_1['loggerService'][_0x27c03e(0x20f)](_0x27c03e(0x218),_0x363654['id'],_0x363654['status'],_0x296931[_0x27c03e(0x21d)],_0x1f122e);}catch(_0x51a8f4){console['error']('Error\x20processing\x20Rapyd\x20webhook:',_0x51a8f4),loggerService_1['loggerService'][_0x27c03e(0x1db)]('rapyd',_0x51a8f4,_0x1f122e);throw _0x51a8f4;}}async['processNodaWebhook'](_0x142fe8){const _0x569f04=a66_0x1ac708;console['log'](_0x569f04(0x19a),_0x142fe8);try{const _0x22bb67=await this[_0x569f04(0x26d)][_0x569f04(0x1d9)](_0x142fe8);if(!_0x22bb67[_0x569f04(0x279)])throw new Error(_0x569f04(0x25b));const _0x3e7f33=await database_1[_0x569f04(0x268)]['payment'][_0x569f04(0x29a)]({'where':{'gatewayOrderId':_0x22bb67['paymentId']}});if(!_0x3e7f33){console[_0x569f04(0x2ba)](_0x569f04(0x2b3)+_0x22bb67['paymentId']);return;}console[_0x569f04(0x19f)](_0x569f04(0x25a)+_0x3e7f33['id']+_0x569f04(0x1d8)+_0x22bb67[_0x569f04(0x21d)]),await this[_0x569f04(0x234)](_0x3e7f33['id'],_0x22bb67[_0x569f04(0x21d)],{'bankId':_0x22bb67[_0x569f04(0x226)]?.[_0x569f04(0x29e)],'remitterIban':_0x22bb67[_0x569f04(0x226)]?.[_0x569f04(0x206)],'remitterName':_0x22bb67[_0x569f04(0x226)]?.[_0x569f04(0x2af)]}),loggerService_1[_0x569f04(0x2a1)][_0x569f04(0x20f)](_0x569f04(0x259),_0x3e7f33['id'],_0x3e7f33[_0x569f04(0x21d)],_0x22bb67[_0x569f04(0x21d)],_0x142fe8);}catch(_0x5e2692){console[_0x569f04(0x2ba)](_0x569f04(0x2a6),_0x5e2692),loggerService_1[_0x569f04(0x2a1)][_0x569f04(0x1db)]('noda',_0x5e2692,_0x142fe8);throw _0x5e2692;}}async[a66_0x1ac708(0x1b8)](_0x4e65e8){const _0x317220=a66_0x1ac708;console['log'](_0x317220(0x248),_0x4e65e8);try{const _0x9bc760=await this[_0x317220(0x2cb)][_0x317220(0x1d9)](_0x4e65e8);if(!_0x9bc760[_0x317220(0x279)])throw new Error(_0x317220(0x232));const _0x3edcb0=await database_1[_0x317220(0x268)][_0x317220(0x27b)][_0x317220(0x29a)]({'where':{'gatewayOrderId':_0x9bc760[_0x317220(0x279)]}});if(!_0x3edcb0){console['error'](_0x317220(0x255)+_0x9bc760[_0x317220(0x279)]);return;}console[_0x317220(0x19f)](_0x317220(0x1fc)+_0x3edcb0['id']+_0x317220(0x1d8)+_0x9bc760['status']),await this[_0x317220(0x234)](_0x3edcb0['id'],_0x9bc760[_0x317220(0x21d)]),loggerService_1[_0x317220(0x2a1)][_0x317220(0x20f)](_0x317220(0x27e),_0x3edcb0['id'],_0x3edcb0[_0x317220(0x21d)],_0x9bc760['status'],_0x4e65e8);}catch(_0x2d50cf){console[_0x317220(0x2ba)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x2d50cf),loggerService_1[_0x317220(0x2a1)][_0x317220(0x1db)](_0x317220(0x27e),_0x2d50cf,_0x4e65e8);throw _0x2d50cf;}}async['processCoinToPay2Webhook'](_0x23a73d){const _0x42a416=a66_0x1ac708;console[_0x42a416(0x19f)](_0x42a416(0x243),_0x23a73d);try{const _0x2942ef=await this[_0x42a416(0x1f4)]['processWebhook'](_0x23a73d);if(!_0x2942ef[_0x42a416(0x279)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook');const _0x1a29af=await database_1[_0x42a416(0x268)][_0x42a416(0x27b)][_0x42a416(0x29a)]({'where':{'gatewayOrderId':_0x2942ef[_0x42a416(0x279)]}});if(!_0x1a29af){console[_0x42a416(0x2ba)](_0x42a416(0x2b6)+_0x2942ef[_0x42a416(0x279)]);return;}console['log'](_0x42a416(0x1d4)+_0x1a29af['id']+_0x42a416(0x1d8)+_0x2942ef[_0x42a416(0x21d)]),await this[_0x42a416(0x234)](_0x1a29af['id'],_0x2942ef[_0x42a416(0x21d)]),loggerService_1[_0x42a416(0x2a1)][_0x42a416(0x20f)]('cointopay2',_0x1a29af['id'],_0x1a29af[_0x42a416(0x21d)],_0x2942ef[_0x42a416(0x21d)],_0x23a73d);}catch(_0x2da110){console[_0x42a416(0x2ba)](_0x42a416(0x22b),_0x2da110),loggerService_1['loggerService'][_0x42a416(0x1db)](_0x42a416(0x20a),_0x2da110,_0x23a73d);throw _0x2da110;}}async[a66_0x1ac708(0x278)](_0x347f29){const _0x4365a9=a66_0x1ac708;console[_0x4365a9(0x19f)]('🔄\x20Processing\x20KLYME\x20webhook:',_0x347f29);try{const _0x315ef1=await this[_0x4365a9(0x1bc)][_0x4365a9(0x1d9)](_0x347f29);if(!_0x315ef1[_0x4365a9(0x279)])throw new Error(_0x4365a9(0x27c));const _0x203c4b=await database_1[_0x4365a9(0x268)]['payment'][_0x4365a9(0x29a)]({'where':{'gatewayOrderId':_0x315ef1[_0x4365a9(0x279)]}});if(!_0x203c4b){console[_0x4365a9(0x2ba)](_0x4365a9(0x21e)+_0x315ef1[_0x4365a9(0x279)]);return;}console['log'](_0x4365a9(0x2a8)+_0x203c4b['id']+'\x20status\x20'+_0x315ef1[_0x4365a9(0x21d)]),await this['updatePaymentStatus'](_0x203c4b['id'],_0x315ef1[_0x4365a9(0x21d)],{'paymentMethod':_0x315ef1[_0x4365a9(0x226)]?.[_0x4365a9(0x28d)]}),loggerService_1[_0x4365a9(0x2a1)][_0x4365a9(0x20f)](_0x4365a9(0x1f9),_0x203c4b['id'],_0x203c4b[_0x4365a9(0x21d)],_0x315ef1[_0x4365a9(0x21d)],_0x347f29);}catch(_0x5446fa){console[_0x4365a9(0x2ba)](_0x4365a9(0x1cf),_0x5446fa),loggerService_1[_0x4365a9(0x2a1)]['logWebhookError'](_0x4365a9(0x1f9),_0x5446fa,_0x347f29);throw _0x5446fa;}}async['processVisaWebhook'](_0x3a3202){const _0x4044af=a66_0x1ac708;console[_0x4044af(0x19f)]('🔄\x20Processing\x20VISA\x20webhook:',JSON[_0x4044af(0x1ae)](_0x3a3202,null,0x2));try{const _0x2d9369=await this[_0x4044af(0x1cd)]['processWebhook'](_0x3a3202,_0x4044af(0x28c));console['log'](_0x4044af(0x238),_0x2d9369);if(!_0x2d9369[_0x4044af(0x279)]){console[_0x4044af(0x2ba)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data'),console[_0x4044af(0x2ba)]('❌\x20Available\x20webhook\x20fields:',Object[_0x4044af(0x297)](_0x3a3202));throw new Error('No\x20payment\x20ID\x20in\x20VISA\x20webhook');}let _0x179c35=null;console['log'](_0x4044af(0x299)+_0x2d9369[_0x4044af(0x279)]);if(_0x2d9369['paymentId']){console[_0x4044af(0x19f)]('🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...'),console[_0x4044af(0x19f)](_0x4044af(0x209)),console['log'](_0x4044af(0x239)),console[_0x4044af(0x19f)]('\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20'+_0x2d9369[_0x4044af(0x279)]),console['log'](_0x4044af(0x25e)),_0x179c35=await database_1['default']['payment']['findFirst']({'where':{'AND':[{'OR':[{'gateway':'visa/mastercard'},{'gateway':_0x4044af(0x261)}]},{'OR':[{'gatewayPaymentId':_0x2d9369[_0x4044af(0x279)]},{'gatewayOrderId':_0x2d9369[_0x4044af(0x279)]},{'id':_0x2d9369['paymentId']},{'orderId':_0x2d9369['paymentId']}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x4044af(0x19f)](_0x4044af(0x223));if(_0x179c35)console[_0x4044af(0x19f)]('✅\x20Found\x20payment:\x20ID='+_0x179c35['id']+_0x4044af(0x1dd)+_0x179c35[_0x4044af(0x1da)]+_0x4044af(0x1df)+_0x179c35['gatewayPaymentId']);else{console[_0x4044af(0x19f)](_0x4044af(0x1c7));const _0x247c41=await database_1[_0x4044af(0x268)][_0x4044af(0x27b)][_0x4044af(0x1d6)]({'where':{'gateway':_0x4044af(0x1cc)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x4044af(0x1af)}});console[_0x4044af(0x19f)](_0x4044af(0x2a3),_0x247c41['map'](_0x8ddb13=>_0x8ddb13['id']+_0x4044af(0x1b2)+_0x8ddb13[_0x4044af(0x2d1)]+_0x4044af(0x19e)+_0x8ddb13[_0x4044af(0x1da)]+_0x4044af(0x1bd)+_0x8ddb13[_0x4044af(0x20e)]+_0x4044af(0x23d)+_0x8ddb13[_0x4044af(0x2bc)]+')'));}console[_0x4044af(0x19f)](_0x4044af(0x210)+(_0x179c35?_0x4044af(0x204):_0x4044af(0x2c3))),_0x179c35&&console[_0x4044af(0x19f)](_0x4044af(0x1b6)+_0x179c35['id']+_0x4044af(0x29b)+_0x179c35['gateway']+',\x20Status='+_0x179c35['status']+_0x4044af(0x1a5)+_0x179c35[_0x4044af(0x2bc)]);}if(!_0x179c35){console[_0x4044af(0x2ba)](_0x4044af(0x1c3)+_0x2d9369[_0x4044af(0x279)]),loggerService_1[_0x4044af(0x2a1)][_0x4044af(0x1db)](_0x4044af(0x254),new Error(_0x4044af(0x2b7)+_0x2d9369[_0x4044af(0x279)]),_0x3a3202);throw new Error('VISA\x20payment\x20not\x20found:\x20'+_0x2d9369['paymentId']);}console[_0x4044af(0x19f)](_0x4044af(0x22c)+_0x179c35['id']+_0x4044af(0x21f)+_0x179c35[_0x4044af(0x21d)]+_0x4044af(0x276)+_0x2d9369[_0x4044af(0x21d)]+')');const _0x1c6421={};_0x2d9369[_0x4044af(0x1e1)]&&await database_1['default'][_0x4044af(0x27b)][_0x4044af(0x22f)]({'where':{'id':_0x179c35['id']},'data':{'amount':_0x2d9369[_0x4044af(0x1e1)],'updatedAt':new Date()}}),_0x2d9369[_0x4044af(0x19c)]&&await database_1[_0x4044af(0x268)][_0x4044af(0x27b)][_0x4044af(0x22f)]({'where':{'id':_0x179c35['id']},'data':{'currency':_0x2d9369[_0x4044af(0x19c)],'updatedAt':new Date()}}),_0x2d9369[_0x4044af(0x21d)]===_0x4044af(0x270)&&_0x2d9369[_0x4044af(0x288)]&&(_0x1c6421[_0x4044af(0x285)]=_0x2d9369['errorMessage'],console[_0x4044af(0x19f)](_0x4044af(0x1f0)+_0x2d9369[_0x4044af(0x288)])),_0x1c6421[_0x4044af(0x271)]=_0x4044af(0x254),await this[_0x4044af(0x234)](_0x179c35['id'],_0x2d9369[_0x4044af(0x21d)],_0x1c6421),await database_1[_0x4044af(0x268)][_0x4044af(0x253)][_0x4044af(0x251)]({'data':{'paymentId':_0x179c35['id'],'shopId':_0x179c35['shopId'],'event':_0x4044af(0x1f1)+_0x2d9369[_0x4044af(0x21d)][_0x4044af(0x23e)](),'statusCode':0xc8,'responseBody':JSON[_0x4044af(0x1ae)](_0x2d9369)}}),await this[_0x4044af(0x2ce)](_0x179c35,_0x2d9369[_0x4044af(0x21d)][_0x4044af(0x2bf)]()),console[_0x4044af(0x19f)](_0x4044af(0x233)+_0x179c35['id']);}catch(_0x29f1d6){console[_0x4044af(0x2ba)]('❌\x20VISA\x20webhook\x20processing\x20failed:',_0x29f1d6),loggerService_1['loggerService']['logWebhookError'](_0x4044af(0x254),_0x29f1d6,_0x3a3202);throw _0x29f1d6;}}async[a66_0x1ac708(0x220)](_0x5b459b){const _0x3666ef=a66_0x1ac708;console['log'](_0x3666ef(0x202),JSON[_0x3666ef(0x1ae)](_0x5b459b,null,0x2));try{const _0xb55aae=await this[_0x3666ef(0x1cd)][_0x3666ef(0x1d9)](_0x5b459b,_0x3666ef(0x22a));console[_0x3666ef(0x19f)](_0x3666ef(0x1a0),_0xb55aae);if(!_0xb55aae[_0x3666ef(0x279)]){console[_0x3666ef(0x2ba)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data'),console['error'](_0x3666ef(0x1fe),Object['keys'](_0x5b459b));throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');}let _0xe08c57=null;console[_0x3666ef(0x19f)](_0x3666ef(0x257)+_0xb55aae['paymentId']);_0xb55aae[_0x3666ef(0x279)]&&(console[_0x3666ef(0x19f)](_0x3666ef(0x282)),_0xe08c57=await database_1[_0x3666ef(0x268)][_0x3666ef(0x27b)]['findFirst']({'where':{'AND':[{'OR':[{'gateway':_0x3666ef(0x29d)},{'gateway':_0x3666ef(0x261)},{'gateway':_0x3666ef(0x1cc)}]},{'OR':[{'gatewayPaymentId':_0xb55aae[_0x3666ef(0x279)]},{'gatewayOrderId':_0xb55aae['paymentId']},{'id':_0xb55aae[_0x3666ef(0x279)]},{'orderId':_0xb55aae[_0x3666ef(0x279)]}]}]}}),console[_0x3666ef(0x19f)](_0x3666ef(0x1ef)+(_0xe08c57?_0x3666ef(0x1c4)+_0xe08c57['id']:_0x3666ef(0x1a1))));if(!_0xe08c57){console[_0x3666ef(0x2ba)]('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0xb55aae[_0x3666ef(0x279)]),console['error'](_0x3666ef(0x25f)+_0xb55aae['paymentId']+_0x3666ef(0x2b2)+_0xb55aae['paymentId']+_0x3666ef(0x1d0)+_0xb55aae['paymentId']+'\x22');const _0x4ee5ca=await database_1[_0x3666ef(0x268)][_0x3666ef(0x27b)][_0x3666ef(0x1d6)]({'where':{'OR':[{'gateway':'mastercard'},{'gateway':_0x3666ef(0x29d)},{'gateway':_0x3666ef(0x1cc)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':'desc'},'take':0xf});console['log'](_0x3666ef(0x2d2),_0x4ee5ca),loggerService_1['loggerService']['logWebhookError'](_0x3666ef(0x261),new Error(_0x3666ef(0x2b7)+_0xb55aae[_0x3666ef(0x279)]),_0x5b459b);throw new Error(_0x3666ef(0x252)+_0xb55aae[_0x3666ef(0x279)]);}console[_0x3666ef(0x19f)](_0x3666ef(0x2cc)+_0xe08c57['id']+_0x3666ef(0x286)+_0xe08c57[_0x3666ef(0x21d)]+'\x20to\x20'+_0xb55aae[_0x3666ef(0x21d)]);const _0x350b59={};_0xb55aae[_0x3666ef(0x1e1)]&&await database_1['default']['payment'][_0x3666ef(0x22f)]({'where':{'id':_0xe08c57['id']},'data':{'amount':_0xb55aae[_0x3666ef(0x1e1)],'updatedAt':new Date()}}),_0xb55aae['currency']&&await database_1['default'][_0x3666ef(0x27b)][_0x3666ef(0x22f)]({'where':{'id':_0xe08c57['id']},'data':{'currency':_0xb55aae['currency'],'updatedAt':new Date()}}),_0xb55aae[_0x3666ef(0x21d)]===_0x3666ef(0x270)&&_0xb55aae[_0x3666ef(0x288)]&&(_0x350b59[_0x3666ef(0x285)]=_0xb55aae[_0x3666ef(0x288)],console[_0x3666ef(0x19f)]('❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20'+_0xb55aae['errorMessage'])),_0x350b59[_0x3666ef(0x271)]=_0x3666ef(0x261),await this[_0x3666ef(0x234)](_0xe08c57['id'],_0xb55aae[_0x3666ef(0x21d)],_0x350b59),loggerService_1['loggerService']['logWebhookProcessed']('mastercard',_0xe08c57['id'],_0xe08c57[_0x3666ef(0x21d)],_0xb55aae[_0x3666ef(0x21d)],_0x5b459b);}catch(_0x36d4b1){console[_0x3666ef(0x2ba)](_0x3666ef(0x262),_0x36d4b1),loggerService_1[_0x3666ef(0x2a1)][_0x3666ef(0x1db)](_0x3666ef(0x261),_0x36d4b1,_0x5b459b);throw _0x36d4b1;}}async[a66_0x1ac708(0x272)](_0x38f545){const _0x1e9170=a66_0x1ac708;console[_0x1e9170(0x19f)](_0x1e9170(0x273),JSON[_0x1e9170(0x1ae)](_0x38f545,null,0x2));try{const _0x2cf676=await this[_0x1e9170(0x2ab)]['processWebhook'](_0x38f545);console[_0x1e9170(0x19f)]('📊\x20Amer\x20webhook\x20result:',_0x2cf676);if(!_0x2cf676[_0x1e9170(0x279)]){console[_0x1e9170(0x2ba)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data'),console[_0x1e9170(0x2ba)](_0x1e9170(0x1fe),Object['keys'](_0x38f545));throw new Error('No\x20payment\x20ID\x20in\x20Amer\x20webhook');}let _0x50de36=null;console[_0x1e9170(0x19f)](_0x1e9170(0x256)+_0x2cf676[_0x1e9170(0x279)]),_0x50de36=await database_1[_0x1e9170(0x268)][_0x1e9170(0x27b)][_0x1e9170(0x29a)]({'where':{'AND':[{'gateway':_0x1e9170(0x1f3)},{'OR':[{'gatewayPaymentId':_0x2cf676[_0x1e9170(0x279)]},{'gatewayOrderId':_0x2cf676['paymentId']},{'id':_0x2cf676[_0x1e9170(0x279)]},{'orderId':_0x2cf676[_0x1e9170(0x279)]}]}]}}),console['log'](_0x1e9170(0x1ef)+(_0x50de36?_0x1e9170(0x1c4)+_0x50de36['id']:_0x1e9170(0x1a1)));if(!_0x50de36){console[_0x1e9170(0x2ba)](_0x1e9170(0x2b5)+_0x2cf676[_0x1e9170(0x279)]);return;}console['log'](_0x1e9170(0x211)+_0x50de36['id']+_0x1e9170(0x1d8)+_0x2cf676[_0x1e9170(0x21d)]),await this[_0x1e9170(0x234)](_0x50de36['id'],_0x2cf676['status'],{'cardLast4':_0x2cf676['additionalInfo']?.['cardLast4'],'paymentMethod':_0x2cf676[_0x1e9170(0x226)]?.[_0x1e9170(0x271)]});}catch(_0x2a3009){console[_0x1e9170(0x2ba)](_0x1e9170(0x1f2),_0x2a3009),loggerService_1['loggerService'][_0x1e9170(0x1db)](_0x1e9170(0x1f3),_0x2a3009,_0x38f545);throw _0x2a3009;}}async[a66_0x1ac708(0x294)](_0x4fb167){const _0x129984=a66_0x1ac708;console[_0x129984(0x19f)]('🔄\x20Processing\x20AmPay\x20webhook:',JSON[_0x129984(0x1ae)](_0x4fb167,null,0x2));try{const _0x3a73cc=_0x4fb167[_0x129984(0x21d)],_0x55bba2=_0x4fb167[_0x129984(0x24e)],_0x83011d=_0x4fb167['system_id'],_0x5ec754=_0x4fb167[_0x129984(0x28d)],_0x4a1708=_0x4fb167['amount'],_0x36602c=_0x4fb167[_0x129984(0x19c)],_0x741b7a=_0x4fb167[_0x129984(0x2ae)],_0x387ebd=_0x4fb167[_0x129984(0x1ff)];if(!_0x55bba2){console[_0x129984(0x2ba)](_0x129984(0x21a));throw new Error('Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook');}console[_0x129984(0x19f)]('📊\x20AmPay\x20webhook\x20data:',{'status':_0x3a73cc,'clientTransactionId':_0x55bba2,'systemId':_0x83011d,'paymentMethod':_0x5ec754,'amount':_0x4a1708,'currency':_0x36602c,'commission':_0x741b7a,'statusAdditionInfo':_0x387ebd});const _0x118c36=await database_1['default'][_0x129984(0x27b)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x55bba2},{'orderId':_0x55bba2},{'id':_0x55bba2},{'gatewayPaymentId':_0x55bba2}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x118c36){console['error'](_0x129984(0x1b9)+_0x55bba2);throw new Error('Payment\x20not\x20found:\x20'+_0x55bba2);}console[_0x129984(0x19f)](_0x129984(0x2cc)+_0x118c36['id']+_0x129984(0x263)),console['log'](_0x129984(0x27a)+_0x118c36[_0x129984(0x21d)]+_0x129984(0x276)+_0x3a73cc),_0x3a73cc===_0x129984(0x26c)?(console[_0x129984(0x19f)](_0x129984(0x298)),await this[_0x129984(0x234)](_0x118c36['id'],'FAILED'),console[_0x129984(0x19f)]('✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20'+_0x118c36['id']+'\x20status\x20updated\x20to\x20FAILED'),console[_0x129984(0x19f)](_0x129984(0x196)+(_0x387ebd||_0x129984(0x197)))):console['log'](_0x129984(0x1ea)+_0x3a73cc+'\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)'),await database_1[_0x129984(0x268)][_0x129984(0x253)][_0x129984(0x251)]({'data':{'paymentId':_0x118c36['id'],'shopId':_0x118c36['shopId'],'event':_0x129984(0x212)+(_0x3a73cc?.[_0x129984(0x23e)]()||'unknown'),'statusCode':0xc8,'responseBody':JSON[_0x129984(0x1ae)](_0x4fb167)}}),loggerService_1[_0x129984(0x2a1)][_0x129984(0x20f)](_0x129984(0x1c6),_0x118c36['id'],_0x118c36[_0x129984(0x21d)],_0x3a73cc===_0x129984(0x26c)?_0x129984(0x270):_0x3a73cc,_0x4fb167);}catch(_0x7614f8){console['error']('❌\x20Error\x20processing\x20AmPay\x20webhook:',_0x7614f8),loggerService_1['loggerService'][_0x129984(0x1db)]('ampay',_0x7614f8,_0x4fb167);throw _0x7614f8;}}async[a66_0x1ac708(0x1ad)](_0x27e389){const _0x1290f1=a66_0x1ac708;console[_0x1290f1(0x19f)]('🔄\x20Processing\x20AmPay\x20TRY\x20webhook:',JSON[_0x1290f1(0x1ae)](_0x27e389,null,0x2));try{const _0x31a778=_0x27e389[_0x1290f1(0x21d)],_0x106e5c=_0x27e389[_0x1290f1(0x24e)],_0x1f3261=_0x27e389[_0x1290f1(0x2cd)],_0x1b58d2=_0x27e389[_0x1290f1(0x28d)],_0x5b8dab=_0x27e389[_0x1290f1(0x1e1)],_0x1b5de7=_0x27e389['currency'],_0x1fba97=_0x27e389[_0x1290f1(0x2ae)],_0x364ea5=_0x27e389['status_addition_info'];if(!_0x106e5c){console[_0x1290f1(0x2ba)]('❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook');throw new Error(_0x1290f1(0x1e8));}console[_0x1290f1(0x19f)](_0x1290f1(0x280),{'status':_0x31a778,'clientTransactionId':_0x106e5c,'systemId':_0x1f3261,'paymentMethod':_0x1b58d2,'amount':_0x5b8dab,'currency':_0x1b5de7,'commission':_0x1fba97,'statusAdditionInfo':_0x364ea5});const _0x23e270=await database_1[_0x1290f1(0x268)][_0x1290f1(0x27b)][_0x1290f1(0x29a)]({'where':{'OR':[{'gatewayOrderId':_0x106e5c},{'orderId':_0x106e5c},{'id':_0x106e5c},{'gatewayPaymentId':_0x106e5c}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x23e270){console[_0x1290f1(0x2ba)]('❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20'+_0x106e5c);throw new Error(_0x1290f1(0x2b7)+_0x106e5c);}console[_0x1290f1(0x19f)](_0x1290f1(0x2cc)+_0x23e270['id']+_0x1290f1(0x250)),console[_0x1290f1(0x19f)](_0x1290f1(0x27a)+_0x23e270[_0x1290f1(0x21d)]+_0x1290f1(0x276)+_0x31a778),_0x31a778===_0x1290f1(0x26c)?(console[_0x1290f1(0x19f)](_0x1290f1(0x1a3)),await this[_0x1290f1(0x234)](_0x23e270['id'],_0x1290f1(0x270)),console[_0x1290f1(0x19f)](_0x1290f1(0x269)+_0x23e270['id']+_0x1290f1(0x1ee)),console['log'](_0x1290f1(0x196)+(_0x364ea5||_0x1290f1(0x197)))):console[_0x1290f1(0x19f)]('ℹ️\x20AmPay\x20TRY\x20status\x20'+_0x31a778+_0x1290f1(0x221)),await database_1[_0x1290f1(0x268)][_0x1290f1(0x253)][_0x1290f1(0x251)]({'data':{'paymentId':_0x23e270['id'],'shopId':_0x23e270[_0x1290f1(0x1c0)],'event':'ampay_try_'+(_0x31a778?.[_0x1290f1(0x23e)]()||_0x1290f1(0x26a)),'statusCode':0xc8,'responseBody':JSON[_0x1290f1(0x1ae)](_0x27e389)}}),loggerService_1[_0x1290f1(0x2a1)][_0x1290f1(0x20f)](_0x1290f1(0x19d),_0x23e270['id'],_0x23e270[_0x1290f1(0x21d)],_0x31a778===_0x1290f1(0x26c)?'FAILED':_0x31a778,_0x27e389);}catch(_0x1d575f){console[_0x1290f1(0x2ba)]('❌\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:',_0x1d575f),loggerService_1[_0x1290f1(0x2a1)][_0x1290f1(0x1db)](_0x1290f1(0x19d),_0x1d575f,_0x27e389);throw _0x1d575f;}}async[a66_0x1ac708(0x1a4)](_0x1228a4,_0x1f38f7){const _0x3ecf5a=a66_0x1ac708,_0x5cfb6c=Date[_0x3ecf5a(0x247)]();try{const _0x699e5b=_0x1228a4[_0x3ecf5a(0x2a2)],_0x2823f8=_0x699e5b['settings'];if(!_0x2823f8?.[_0x3ecf5a(0x2bd)]){console[_0x3ecf5a(0x19f)](_0x3ecf5a(0x249)+_0x699e5b['id']);return;}const _0x20cf48=_0x1f38f7===_0x3ecf5a(0x1a8)?_0x3ecf5a(0x284):_0x1f38f7===_0x3ecf5a(0x270)?_0x3ecf5a(0x2a0):_0x1f38f7===_0x3ecf5a(0x27d)?_0x3ecf5a(0x2a0):_0x1f38f7===_0x3ecf5a(0x1ab)?_0x3ecf5a(0x2a0):_0x1f38f7===_0x3ecf5a(0x1e7)?'payment.failed':_0x3ecf5a(0x21b);let _0xcd8881=[];if(_0x2823f8[_0x3ecf5a(0x1fa)])try{_0xcd8881=Array[_0x3ecf5a(0x1bf)](_0x2823f8[_0x3ecf5a(0x1fa)])?_0x2823f8[_0x3ecf5a(0x1fa)]:JSON[_0x3ecf5a(0x2be)](_0x2823f8['webhookEvents']);}catch(_0x3b86b2){console[_0x3ecf5a(0x2ba)](_0x3ecf5a(0x1ca),_0x3b86b2),_0xcd8881=[];}if(!_0xcd8881['includes'](_0x20cf48)){console['log'](_0x3ecf5a(0x1f5)+_0x20cf48+_0x3ecf5a(0x1a7)+_0x699e5b['id']);return;}const _0x19a157={'event':_0x20cf48,'payment':{'id':_0x1228a4['id'],'order_id':_0x1228a4[_0x3ecf5a(0x2d1)],'gateway_order_id':_0x1228a4[_0x3ecf5a(0x1da)],'gateway':_0x1228a4[_0x3ecf5a(0x200)],'amount':_0x1228a4['amount'],'currency':_0x1228a4[_0x3ecf5a(0x19c)],'status':_0x1f38f7['toLowerCase'](),'customer_email':_0x1228a4[_0x3ecf5a(0x1e3)],'customer_name':_0x1228a4['customerName'],'failure_message':_0x1228a4[_0x3ecf5a(0x285)],'tx_urls':_0x1228a4[_0x3ecf5a(0x2c8)]?JSON[_0x3ecf5a(0x2be)](_0x1228a4['txUrls']):null,'created_at':_0x1228a4[_0x3ecf5a(0x1cb)],'updated_at':_0x1228a4[_0x3ecf5a(0x1a9)]}},_0x193065=await fetch(_0x2823f8[_0x3ecf5a(0x2bd)],{'method':_0x3ecf5a(0x1c5),'headers':{'Content-Type':_0x3ecf5a(0x24d),'User-Agent':_0x3ecf5a(0x1a6)},'body':JSON[_0x3ecf5a(0x1ae)](_0x19a157)}),_0x196dd1=Date['now']()-_0x5cfb6c,_0x193c86=_0x193065['ok']?_0x3ecf5a(0x289):await _0x193065[_0x3ecf5a(0x219)]();loggerService_1[_0x3ecf5a(0x2a1)][_0x3ecf5a(0x242)](_0x1228a4['shopId'],_0x2823f8['webhookUrl'],_0x20cf48,_0x193065[_0x3ecf5a(0x21d)],_0x196dd1,_0x19a157),console[_0x3ecf5a(0x19f)](_0x3ecf5a(0x1e2)+_0x2823f8[_0x3ecf5a(0x2bd)]+_0x3ecf5a(0x2a9)+_0x193065[_0x3ecf5a(0x21d)]+'\x20('+_0x196dd1+_0x3ecf5a(0x2d0));}catch(_0x8a7531){console[_0x3ecf5a(0x2ba)](_0x3ecf5a(0x29c),_0x8a7531),loggerService_1[_0x3ecf5a(0x2a1)]['logShopWebhookError'](_0x1228a4[_0x3ecf5a(0x1c0)],_0x1228a4[_0x3ecf5a(0x2a2)]?.[_0x3ecf5a(0x1d7)]?.[_0x3ecf5a(0x2bd)]||_0x3ecf5a(0x26a),_0x3ecf5a(0x28e),_0x8a7531,{});}}async[a66_0x1ac708(0x2ce)](_0x40bf58,_0x43902d){const _0x20d017=a66_0x1ac708;try{const _0x30e774={'PENDING':'created','PROCESSING':'processing','PAID':_0x20d017(0x1ba),'FAILED':_0x20d017(0x2c0),'EXPIRED':_0x20d017(0x198),'REFUND':'refund','CHARGEBACK':_0x20d017(0x20b)},_0xabe9b0=_0x30e774[_0x43902d];if(!_0xabe9b0||_0xabe9b0===_0x20d017(0x28f))return;await telegramBotService_1[_0x20d017(0x295)][_0x20d017(0x26e)](_0x40bf58[_0x20d017(0x1c0)],_0x40bf58,_0xabe9b0);}catch(_0x555dc8){console[_0x20d017(0x2ba)](_0x20d017(0x2b8),_0x555dc8);}}async['getGatewayCommission'](_0x125241,_0x4e6c64){const _0x4b08d5=a66_0x1ac708;try{const _0x49a82c=await database_1[_0x4b08d5(0x268)][_0x4b08d5(0x2a2)]['findUnique']({'where':{'id':_0x125241},'select':{'gatewaySettings':!![]}});if(!_0x49a82c?.['gatewaySettings'])return console['log']('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x125241+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x239111=JSON[_0x4b08d5(0x2be)](_0x49a82c[_0x4b08d5(0x267)]);for(const [_0x1700bc,_0x546521]of Object[_0x4b08d5(0x26f)](_0x239111)){if(_0x1700bc[_0x4b08d5(0x23e)]()===_0x4e6c64[_0x4b08d5(0x23e)]()){const _0x4417c3=_0x546521[_0x4b08d5(0x2ae)]||0xa;return console['log'](_0x4b08d5(0x1b0)+_0x4e6c64+_0x4b08d5(0x203)+_0x125241+':\x20'+_0x4417c3+'%'),_0x4417c3;}}return console[_0x4b08d5(0x19f)](_0x4b08d5(0x1f6)+_0x4e6c64+_0x4b08d5(0x23f)+_0x125241+',\x20using\x20default\x2010%'),0xa;}catch(_0x3352ff){return console[_0x4b08d5(0x2ba)](_0x4b08d5(0x25d)+_0x125241+_0x4b08d5(0x2ac)+_0x4e6c64+':',_0x3352ff),0xa;}}async[a66_0x1ac708(0x1f7)](_0x314907,_0x53dc13){const _0x1ea26d=a66_0x1ac708;console[_0x1ea26d(0x19f)]('🔄\x20Processing\x20MyXSpend\x20webhook:'),console[_0x1ea26d(0x19f)](_0x1ea26d(0x266),JSON['stringify'](_0x314907,null,0x2)),console[_0x1ea26d(0x19f)](_0x1ea26d(0x291),JSON[_0x1ea26d(0x1ae)](_0x53dc13,null,0x2));try{const _0x5e7ff7=_0x314907['customerOrderId']||_0x53dc13[_0x1ea26d(0x28a)],_0x3e2aef=_0x314907['status']||_0x53dc13[_0x1ea26d(0x21d)],_0x51d6c1=_0x314907[_0x1ea26d(0x1e1)]||_0x53dc13['amount'],_0x8e7bcf=_0x314907[_0x1ea26d(0x19c)]||_0x53dc13[_0x1ea26d(0x19c)],_0x178e42=_0x314907['dateTime']||_0x53dc13[_0x1ea26d(0x217)];if(!_0x5e7ff7){console[_0x1ea26d(0x2ba)](_0x1ea26d(0x1dc));throw new Error(_0x1ea26d(0x24f));}console[_0x1ea26d(0x19f)]('📊\x20MyXSpend\x20webhook\x20data:',{'customerOrderId':_0x5e7ff7,'status':_0x3e2aef,'amount':_0x51d6c1,'currency':_0x8e7bcf,'dateTime':_0x178e42});const _0x3cb3bb=await database_1[_0x1ea26d(0x268)][_0x1ea26d(0x27b)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x5e7ff7},{'orderId':_0x5e7ff7},{'id':_0x5e7ff7},{'gatewayPaymentId':_0x5e7ff7}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x3cb3bb){console['error'](_0x1ea26d(0x283)+_0x5e7ff7);throw new Error(_0x1ea26d(0x2b7)+_0x5e7ff7);}console[_0x1ea26d(0x19f)]('✅\x20Found\x20payment\x20'+_0x3cb3bb['id']+'\x20for\x20MyXSpend\x20webhook'),console[_0x1ea26d(0x19f)](_0x1ea26d(0x27a)+_0x3cb3bb[_0x1ea26d(0x21d)]+_0x1ea26d(0x276)+_0x3e2aef);let _0x288a95=_0x3e2aef?.[_0x1ea26d(0x2bf)]();_0x3e2aef===_0x1ea26d(0x270)||_0x3e2aef===_0x1ea26d(0x27d)?(_0x288a95=_0x1ea26d(0x270),console[_0x1ea26d(0x19f)](_0x1ea26d(0x1de)+_0x3e2aef+'\x20mapped\x20to\x20FAILED'),await this[_0x1ea26d(0x234)](_0x3cb3bb['id'],_0x288a95),console[_0x1ea26d(0x19f)](_0x1ea26d(0x28b)+_0x3cb3bb['id']+_0x1ea26d(0x1ee))):console[_0x1ea26d(0x19f)]('ℹ️\x20MyXSpend\x20status\x20'+_0x3e2aef+_0x1ea26d(0x2a4)),await database_1['default'][_0x1ea26d(0x253)]['create']({'data':{'paymentId':_0x3cb3bb['id'],'shopId':_0x3cb3bb[_0x1ea26d(0x1c0)],'event':_0x1ea26d(0x237)+(_0x3e2aef?.[_0x1ea26d(0x23e)]()||_0x1ea26d(0x26a)),'statusCode':0xc8,'responseBody':JSON[_0x1ea26d(0x1ae)]({'queryParams':_0x314907,'bodyData':_0x53dc13})}}),loggerService_1['loggerService']['logWebhookProcessed']('myxspend',_0x3cb3bb['id'],_0x3cb3bb[_0x1ea26d(0x21d)],_0x288a95||_0x3e2aef,{'queryParams':_0x314907,'bodyData':_0x53dc13});}catch(_0x3a4dda){console[_0x1ea26d(0x2ba)](_0x1ea26d(0x1fb),_0x3a4dda),loggerService_1[_0x1ea26d(0x2a1)][_0x1ea26d(0x1db)](_0x1ea26d(0x20d),_0x3a4dda,{'queryParams':_0x314907,'bodyData':_0x53dc13});throw _0x3a4dda;}}}exports[a66_0x1ac708(0x214)]=WebhookService;