'use strict';function a60_0x1740(_0x3dcefa,_0x555605){const _0x121588=a60_0x1215();return a60_0x1740=function(_0x174034,_0x54fbca){_0x174034=_0x174034-0x107;let _0x289cf0=_0x121588[_0x174034];return _0x289cf0;},a60_0x1740(_0x3dcefa,_0x555605);}const a60_0x3804d2=a60_0x1740;(function(_0xd534af,_0x1644cb){const _0x3cdb10=a60_0x1740,_0x57be9f=_0xd534af();while(!![]){try{const _0x5022b3=-parseInt(_0x3cdb10(0x1de))/0x1+-parseInt(_0x3cdb10(0x17c))/0x2*(parseInt(_0x3cdb10(0x1bd))/0x3)+-parseInt(_0x3cdb10(0x15a))/0x4*(parseInt(_0x3cdb10(0x120))/0x5)+parseInt(_0x3cdb10(0x129))/0x6*(-parseInt(_0x3cdb10(0x132))/0x7)+-parseInt(_0x3cdb10(0x140))/0x8*(parseInt(_0x3cdb10(0x1b9))/0x9)+parseInt(_0x3cdb10(0x18b))/0xa*(parseInt(_0x3cdb10(0x13f))/0xb)+parseInt(_0x3cdb10(0x113))/0xc;if(_0x5022b3===_0x1644cb)break;else _0x57be9f['push'](_0x57be9f['shift']());}catch(_0x113b82){_0x57be9f['push'](_0x57be9f['shift']());}}}(a60_0x1215,0x5df09));var __importDefault=this&&this[a60_0x3804d2(0x1ae)]||function(_0x11342a){const _0x48a8a2=a60_0x3804d2;return _0x11342a&&_0x11342a[_0x48a8a2(0x17b)]?_0x11342a:{'default':_0x11342a};};Object['defineProperty'](exports,a60_0x3804d2(0x17b),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a60_0x3804d2(0x1a7))),plisioService_1=require(a60_0x3804d2(0x151)),rapydService_1=require(a60_0x3804d2(0x124)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a60_0x3804d2(0x1cd)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a60_0x3804d2(0x182)),amerService_1=require(a60_0x3804d2(0x152)),telegramBotService_1=require(a60_0x3804d2(0x136)),currencyService_1=require(a60_0x3804d2(0x14f)),loggerService_1=require(a60_0x3804d2(0x14b));class WebhookService{constructor(){const _0x1279d3=a60_0x3804d2;this[_0x1279d3(0x19b)]=new plisioService_1[(_0x1279d3(0x16a))](),this[_0x1279d3(0x161)]=new rapydService_1[(_0x1279d3(0x13c))](),this[_0x1279d3(0x18a)]=new nodaService_1['NodaService'](),this['coinToPayService']=new coinToPayService_1[(_0x1279d3(0x11c))](),this[_0x1279d3(0x18d)]=new coinToPay2Service_1[(_0x1279d3(0x111))](),this['klymeService']=new klymeService_1['KlymeService'](),this[_0x1279d3(0x164)]=new mastercardService_1[(_0x1279d3(0x178))](),this[_0x1279d3(0x180)]=new amerService_1[(_0x1279d3(0x1bf))]();}async[a60_0x3804d2(0x1c9)](_0x2f2b51,_0x124daf,_0x222720){const _0x3d94d7=a60_0x3804d2;console['log']('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x2f2b51+_0x3d94d7(0x10b)+_0x124daf),console[_0x3d94d7(0x170)](_0x3d94d7(0x1c5),_0x222720),await database_1[_0x3d94d7(0x19d)][_0x3d94d7(0x163)](async _0x52462c=>{const _0x271513=_0x3d94d7,_0x3fa4e1=await _0x52462c['payment'][_0x271513(0x114)]({'where':{'id':_0x2f2b51},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3fa4e1)throw new Error(_0x271513(0x187)+_0x2f2b51+_0x271513(0x1e3));const _0x44f7e0=_0x3fa4e1[_0x271513(0x107)],_0x160dc2=_0x3fa4e1[_0x271513(0x1b0)];console['log']('💰\x20Payment\x20'+_0x2f2b51+':\x20'+_0x44f7e0+'\x20->\x20'+_0x124daf),console[_0x271513(0x170)](_0x271513(0x121)+_0x160dc2[_0x271513(0x13e)]+_0x271513(0x11a)+_0x160dc2[_0x271513(0x1ee)]+_0x271513(0x171));const _0x3e43f6={'status':_0x124daf[_0x271513(0x17e)](),'updatedAt':new Date(),'statusChangedBy':_0x271513(0x12a),'statusChangedAt':new Date()};_0x222720?.[_0x271513(0x125)]&&(_0x3e43f6[_0x271513(0x125)]=_0x222720[_0x271513(0x125)]);_0x222720?.['txUrls']&&(_0x3e43f6[_0x271513(0x1ad)]=JSON[_0x271513(0x13d)](_0x222720['txUrls']));_0x222720?.[_0x271513(0x134)]&&(_0x3e43f6[_0x271513(0x134)]=_0x222720[_0x271513(0x134)]);_0x222720?.[_0x271513(0x172)]&&(_0x3e43f6['paymentMethod']=_0x222720[_0x271513(0x172)]);_0x222720?.['bankId']&&(_0x3e43f6['bankId']=_0x222720['bankId']);_0x222720?.[_0x271513(0x145)]&&(_0x3e43f6[_0x271513(0x145)]=_0x222720['remitterIban']);_0x222720?.[_0x271513(0x1c2)]&&(_0x3e43f6[_0x271513(0x1c2)]=_0x222720[_0x271513(0x1c2)]);let _0x1db751=_0x160dc2[_0x271513(0x1ee)],_0x5e9c94='';if(_0x124daf[_0x271513(0x17e)]()===_0x271513(0x1b6)&&_0x44f7e0!==_0x271513(0x1b6)){const _0x55b894=await currencyService_1[_0x271513(0x14e)][_0x271513(0x157)](_0x3fa4e1[_0x271513(0x16f)],_0x3fa4e1['currency']),_0x587d50=await this[_0x271513(0x126)](_0x160dc2['id'],_0x3fa4e1[_0x271513(0x12e)]),_0x14a43e=_0x55b894*(0x1-_0x587d50/0x64);_0x1db751+=_0x14a43e,_0x5e9c94='+'+_0x14a43e[_0x271513(0x1f1)](0x6)+_0x271513(0x1f7)+_0x587d50+_0x271513(0x186),_0x3e43f6[_0x271513(0x1ed)]=_0x55b894,_0x3e43f6[_0x271513(0x1df)]=_0x14a43e,_0x3e43f6[_0x271513(0x139)]=new Date(),console[_0x271513(0x170)]('💰\x20Converting\x20'+_0x3fa4e1['amount']+'\x20'+_0x3fa4e1[_0x271513(0x174)]+'\x20->\x20'+_0x55b894[_0x271513(0x1f1)](0x6)+_0x271513(0x171)),console[_0x271513(0x170)](_0x271513(0x150)+_0x3fa4e1[_0x271513(0x12e)]+_0x271513(0x153)+_0x587d50+'%'),console[_0x271513(0x170)]('💰\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x14a43e['toFixed'](0x6)+'\x20USDT'),console[_0x271513(0x170)](_0x271513(0x11d)+_0x160dc2[_0x271513(0x1ee)]+_0x271513(0x1c6)+_0x14a43e[_0x271513(0x1f1)](0x6)+_0x271513(0x1b8)+_0x1db751[_0x271513(0x1f1)](0x6)+_0x271513(0x171));}else{if(_0x44f7e0===_0x271513(0x1b6)&&_0x124daf['toUpperCase']()!==_0x271513(0x1b6)){let _0x241145;if(_0x3fa4e1['amountAfterGatewayCommissionUSDT'])_0x241145=_0x3fa4e1['amountAfterGatewayCommissionUSDT'];else{if(_0x3fa4e1[_0x271513(0x1ed)]){const _0x1358a0=await this['getGatewayCommission'](_0x160dc2['id'],_0x3fa4e1[_0x271513(0x12e)]);_0x241145=_0x3fa4e1[_0x271513(0x1ed)]*(0x1-_0x1358a0/0x64);}else console[_0x271513(0x170)](_0x271513(0x1c4)),_0x241145=0x0;}_0x241145>0x0&&(_0x1db751-=_0x241145,_0x5e9c94='-'+_0x241145[_0x271513(0x1f1)](0x6)+_0x271513(0x133),_0x3e43f6[_0x271513(0x1ed)]=null,_0x3e43f6['amountAfterGatewayCommissionUSDT']=null,_0x3e43f6['paidAt']=null,console[_0x271513(0x170)]('💰\x20Removing\x20from\x20balance:\x20'+_0x160dc2['balance']+_0x271513(0x117)+_0x241145['toFixed'](0x6)+'\x20=\x20'+_0x1db751[_0x271513(0x1f1)](0x6)+_0x271513(0x171)));}}if(_0x124daf['toUpperCase']()===_0x271513(0x1a3)){const _0x11f894=_0x222720?.[_0x271513(0x1d2)]||0x0;_0x11f894>0x0&&(_0x1db751-=_0x11f894,_0x5e9c94+=_0x271513(0x1a9)+_0x11f894[_0x271513(0x1f1)](0x6)+_0x271513(0x1ea),_0x3e43f6[_0x271513(0x1d2)]=_0x11f894,console['log'](_0x271513(0x1db)+_0x11f894[_0x271513(0x1f1)](0x6)+_0x271513(0x171)),console['log']('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x1db751['toFixed'](0x6)+_0x271513(0x171)));}const _0x3ad50c=await _0x52462c[_0x271513(0x12c)][_0x271513(0x11f)]({'where':{'id':_0x2f2b51},'data':_0x3e43f6});_0x1db751!==_0x160dc2['balance']&&(await _0x52462c[_0x271513(0x1b0)][_0x271513(0x11f)]({'where':{'id':_0x160dc2['id']},'data':{'balance':_0x1db751}}),console[_0x271513(0x170)](_0x271513(0x10f)+_0x160dc2['username']+_0x271513(0x196)+_0x160dc2['balance']['toFixed'](0x6)+_0x271513(0x1f9)+_0x1db751['toFixed'](0x6)+'\x20USDT'),console[_0x271513(0x170)]('📝\x20Reason:\x20'+_0x5e9c94));await _0x52462c[_0x271513(0x1d4)][_0x271513(0x112)]({'data':{'paymentId':_0x2f2b51,'shopId':_0x160dc2['id'],'event':_0x271513(0x110)+_0x124daf[_0x271513(0x1e0)](),'statusCode':0xc8,'responseBody':JSON[_0x271513(0x13d)]({'oldStatus':_0x44f7e0,'newStatus':_0x124daf[_0x271513(0x17e)](),'balanceChange':_0x5e9c94||_0x271513(0x1f3),'oldBalance':_0x160dc2[_0x271513(0x1ee)],'newBalance':_0x1db751,'amountUSDT':_0x3e43f6['amountUSDT'],'additionalData':_0x222720,'timestamp':new Date()[_0x271513(0x130)]()})}}),await this['sendShopWebhook']({..._0x3fa4e1,..._0x3ad50c,'shop':_0x160dc2},_0x124daf[_0x271513(0x17e)]()),await this[_0x271513(0x1e4)]({..._0x3fa4e1,..._0x3ad50c},_0x124daf[_0x271513(0x17e)]());if(_0x44f7e0!==_0x271513(0x1b6)&&_0x124daf[_0x271513(0x17e)]()===_0x271513(0x1b6)){console[_0x271513(0x170)]('📈\x20Payment\x20'+_0x2f2b51+_0x271513(0x10d)),console[_0x271513(0x170)](_0x271513(0x1da)+_0x44f7e0+_0x271513(0x1e9)+_0x124daf[_0x271513(0x17e)]()+_0x271513(0x181)+_0x3fa4e1[_0x271513(0x192)]+'\x22');if(_0x3fa4e1[_0x271513(0x192)])try{const _0x36ef35=await _0x52462c[_0x271513(0x1bb)][_0x271513(0x114)]({'where':{'id':_0x3fa4e1[_0x271513(0x192)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x36ef35){console[_0x271513(0x170)](_0x271513(0x11e)+_0x36ef35['id']+_0x271513(0x1b3)+_0x36ef35[_0x271513(0x142)]+_0x271513(0x147)+_0x36ef35[_0x271513(0x1f4)]+',\x20status='+_0x36ef35[_0x271513(0x107)]);const _0x3fae71=_0x36ef35[_0x271513(0x1f4)]+0x1,_0x5722c1=_0x36ef35[_0x271513(0x142)]===_0x271513(0x11b)?_0x271513(0x18e):_0x36ef35[_0x271513(0x107)];await _0x52462c[_0x271513(0x1bb)]['update']({'where':{'id':_0x3fa4e1[_0x271513(0x192)]},'data':{'currentPayments':_0x3fae71,'status':_0x5722c1,'updatedAt':new Date()}}),console['log'](_0x271513(0x1d3)+_0x36ef35['id']+_0x271513(0x1d7)+_0x36ef35[_0x271513(0x1f4)]+'\x20->\x20'+_0x3fae71+_0x271513(0x1be)+_0x36ef35[_0x271513(0x107)]+_0x271513(0x1f9)+_0x5722c1);}else console['log'](_0x271513(0x149)+_0x3fa4e1[_0x271513(0x192)]+_0x271513(0x1e3));}catch(_0x24ed42){console[_0x271513(0x14a)](_0x271513(0x14c),_0x24ed42);}else console[_0x271513(0x170)](_0x271513(0x1a4)+_0x2f2b51+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console['log'](_0x271513(0x1a4)+_0x2f2b51+_0x271513(0x16d)+_0x44f7e0+'\x20->\x20'+_0x124daf['toUpperCase']());});}async['processPlisioWebhook'](_0x2f2b84){const _0x257723=a60_0x3804d2;console[_0x257723(0x170)](_0x257723(0x1c1),_0x2f2b84);try{const _0x20cf85=await this[_0x257723(0x19b)][_0x257723(0x185)](_0x2f2b84);if(!_0x20cf85[_0x257723(0x19f)])throw new Error(_0x257723(0x175));const _0x30eccb=await database_1[_0x257723(0x19d)][_0x257723(0x12c)][_0x257723(0x183)]({'where':{'gatewayOrderId':_0x20cf85['paymentId']}});if(!_0x30eccb){console['error'](_0x257723(0x18f)+_0x20cf85['paymentId']);return;}console['log'](_0x257723(0x1d1)+_0x30eccb['id']+_0x257723(0x158)+_0x20cf85[_0x257723(0x107)]),await this['updatePaymentStatus'](_0x30eccb['id'],_0x20cf85[_0x257723(0x107)],{'txUrls':_0x20cf85['txUrls']}),loggerService_1[_0x257723(0x162)][_0x257723(0x1eb)](_0x257723(0x13a),_0x30eccb['id'],_0x30eccb[_0x257723(0x107)],_0x20cf85['status'],_0x2f2b84);}catch(_0x4d19ae){console[_0x257723(0x14a)](_0x257723(0x1e1),_0x4d19ae),loggerService_1[_0x257723(0x162)]['logWebhookError'](_0x257723(0x13a),_0x4d19ae,_0x2f2b84);throw _0x4d19ae;}}async[a60_0x3804d2(0x195)](_0x26e8a7){const _0x189201=a60_0x3804d2;console[_0x189201(0x170)](_0x189201(0x166),_0x26e8a7);try{const _0x37223d=await this[_0x189201(0x19b)][_0x189201(0x185)](_0x26e8a7);if(!_0x37223d['paymentId'])throw new Error(_0x189201(0x1ab));const _0x15a3b6=await database_1[_0x189201(0x19d)][_0x189201(0x12c)][_0x189201(0x183)]({'where':{'gatewayOrderId':_0x37223d[_0x189201(0x19f)]}});if(!_0x15a3b6){console[_0x189201(0x14a)](_0x189201(0x1ba)+_0x37223d[_0x189201(0x19f)]);return;}console[_0x189201(0x170)](_0x189201(0x155)+_0x15a3b6['id']+_0x189201(0x158)+_0x37223d[_0x189201(0x107)]),await this[_0x189201(0x1c9)](_0x15a3b6['id'],_0x37223d[_0x189201(0x107)],{'txUrls':_0x37223d['txUrls']}),loggerService_1[_0x189201(0x162)]['logWebhookProcessed'](_0x189201(0x165),_0x15a3b6['id'],_0x15a3b6[_0x189201(0x107)],_0x37223d[_0x189201(0x107)],_0x26e8a7);}catch(_0x12eba8){console[_0x189201(0x14a)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x12eba8),loggerService_1['loggerService'][_0x189201(0x1f8)](_0x189201(0x165),_0x12eba8,_0x26e8a7);throw _0x12eba8;}}async[a60_0x3804d2(0x1aa)](_0x239e32){const _0x1e0120=a60_0x3804d2;console[_0x1e0120(0x170)]('🔄\x20Processing\x20Rapyd\x20webhook:',_0x239e32);try{const _0x4c31a9=await this['rapydService'][_0x1e0120(0x185)](_0x239e32);if(!_0x4c31a9['paymentId'])throw new Error(_0x1e0120(0x1e7));const _0xc62456=await database_1[_0x1e0120(0x19d)][_0x1e0120(0x12c)]['findFirst']({'where':{'gatewayOrderId':_0x4c31a9[_0x1e0120(0x19f)]}});if(!_0xc62456){console[_0x1e0120(0x14a)](_0x1e0120(0x15d)+_0x4c31a9['paymentId']);return;}console[_0x1e0120(0x170)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0xc62456['id']+_0x1e0120(0x158)+_0x4c31a9[_0x1e0120(0x107)]),await this[_0x1e0120(0x1c9)](_0xc62456['id'],_0x4c31a9[_0x1e0120(0x107)],{'failureMessage':_0x4c31a9[_0x1e0120(0x125)],'cardLast4':_0x4c31a9[_0x1e0120(0x17d)]?.['cardLast4'],'paymentMethod':_0x4c31a9['additionalInfo']?.['paymentMethod']}),loggerService_1[_0x1e0120(0x162)][_0x1e0120(0x1eb)](_0x1e0120(0x12d),_0xc62456['id'],_0xc62456[_0x1e0120(0x107)],_0x4c31a9[_0x1e0120(0x107)],_0x239e32);}catch(_0x18f957){console[_0x1e0120(0x14a)](_0x1e0120(0x108),_0x18f957),loggerService_1[_0x1e0120(0x162)][_0x1e0120(0x1f8)](_0x1e0120(0x12d),_0x18f957,_0x239e32);throw _0x18f957;}}async[a60_0x3804d2(0x1c8)](_0x4b13e2){const _0x4e58e4=a60_0x3804d2;console[_0x4e58e4(0x170)]('🔄\x20Processing\x20Noda\x20webhook:',_0x4b13e2);try{const _0x31dff9=await this['nodaService'][_0x4e58e4(0x185)](_0x4b13e2);if(!_0x31dff9['paymentId'])throw new Error(_0x4e58e4(0x131));const _0x54d7ce=await database_1[_0x4e58e4(0x19d)]['payment'][_0x4e58e4(0x183)]({'where':{'gatewayOrderId':_0x31dff9[_0x4e58e4(0x19f)]}});if(!_0x54d7ce){console[_0x4e58e4(0x14a)]('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x31dff9[_0x4e58e4(0x19f)]);return;}console[_0x4e58e4(0x170)](_0x4e58e4(0x1d6)+_0x54d7ce['id']+_0x4e58e4(0x158)+_0x31dff9[_0x4e58e4(0x107)]),await this[_0x4e58e4(0x1c9)](_0x54d7ce['id'],_0x31dff9[_0x4e58e4(0x107)],{'bankId':_0x31dff9[_0x4e58e4(0x17d)]?.[_0x4e58e4(0x19e)],'remitterIban':_0x31dff9[_0x4e58e4(0x17d)]?.['remitterIban'],'remitterName':_0x31dff9[_0x4e58e4(0x17d)]?.[_0x4e58e4(0x1c2)]}),loggerService_1[_0x4e58e4(0x162)][_0x4e58e4(0x1eb)](_0x4e58e4(0x1f6),_0x54d7ce['id'],_0x54d7ce[_0x4e58e4(0x107)],_0x31dff9[_0x4e58e4(0x107)],_0x4b13e2);}catch(_0x15be06){console[_0x4e58e4(0x14a)](_0x4e58e4(0x179),_0x15be06),loggerService_1[_0x4e58e4(0x162)][_0x4e58e4(0x1f8)](_0x4e58e4(0x1f6),_0x15be06,_0x4b13e2);throw _0x15be06;}}async[a60_0x3804d2(0x1e2)](_0x2ebcdd){const _0x26e5f2=a60_0x3804d2;console[_0x26e5f2(0x170)](_0x26e5f2(0x15b),_0x2ebcdd);try{const _0x37a505=await this[_0x26e5f2(0x176)][_0x26e5f2(0x185)](_0x2ebcdd);if(!_0x37a505[_0x26e5f2(0x19f)])throw new Error(_0x26e5f2(0x169));const _0x159327=await database_1[_0x26e5f2(0x19d)][_0x26e5f2(0x12c)]['findFirst']({'where':{'gatewayOrderId':_0x37a505[_0x26e5f2(0x19f)]}});if(!_0x159327){console[_0x26e5f2(0x14a)](_0x26e5f2(0x16c)+_0x37a505[_0x26e5f2(0x19f)]);return;}console[_0x26e5f2(0x170)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x159327['id']+_0x26e5f2(0x158)+_0x37a505[_0x26e5f2(0x107)]),await this[_0x26e5f2(0x1c9)](_0x159327['id'],_0x37a505[_0x26e5f2(0x107)]),loggerService_1[_0x26e5f2(0x162)][_0x26e5f2(0x1eb)](_0x26e5f2(0x1ce),_0x159327['id'],_0x159327['status'],_0x37a505[_0x26e5f2(0x107)],_0x2ebcdd);}catch(_0x3ae486){console[_0x26e5f2(0x14a)](_0x26e5f2(0x1ca),_0x3ae486),loggerService_1[_0x26e5f2(0x162)][_0x26e5f2(0x1f8)]('cointopay',_0x3ae486,_0x2ebcdd);throw _0x3ae486;}}async[a60_0x3804d2(0x1b2)](_0x8ea85b){const _0x35d28c=a60_0x3804d2;console[_0x35d28c(0x170)](_0x35d28c(0x1ac),_0x8ea85b);try{const _0x1d4923=await this['coinToPay2Service']['processWebhook'](_0x8ea85b);if(!_0x1d4923['paymentId'])throw new Error(_0x35d28c(0x119));const _0x351472=await database_1[_0x35d28c(0x19d)][_0x35d28c(0x12c)][_0x35d28c(0x183)]({'where':{'gatewayOrderId':_0x1d4923['paymentId']}});if(!_0x351472){console['error'](_0x35d28c(0x177)+_0x1d4923[_0x35d28c(0x19f)]);return;}console['log']('📊\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x351472['id']+_0x35d28c(0x158)+_0x1d4923['status']),await this[_0x35d28c(0x1c9)](_0x351472['id'],_0x1d4923[_0x35d28c(0x107)]),loggerService_1[_0x35d28c(0x162)]['logWebhookProcessed'](_0x35d28c(0x148),_0x351472['id'],_0x351472[_0x35d28c(0x107)],_0x1d4923['status'],_0x8ea85b);}catch(_0x232cd1){console[_0x35d28c(0x14a)](_0x35d28c(0x12f),_0x232cd1),loggerService_1['loggerService'][_0x35d28c(0x1f8)]('cointopay2',_0x232cd1,_0x8ea85b);throw _0x232cd1;}}async[a60_0x3804d2(0x123)](_0x28c71c){const _0x3da90f=a60_0x3804d2;console[_0x3da90f(0x170)](_0x3da90f(0x15c),_0x28c71c);try{const _0x376ad5=await this[_0x3da90f(0x19c)]['processWebhook'](_0x28c71c);if(!_0x376ad5['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x4b5921=await database_1[_0x3da90f(0x19d)][_0x3da90f(0x12c)]['findFirst']({'where':{'gatewayOrderId':_0x376ad5[_0x3da90f(0x19f)]}});if(!_0x4b5921){console[_0x3da90f(0x14a)](_0x3da90f(0x1a2)+_0x376ad5[_0x3da90f(0x19f)]);return;}console[_0x3da90f(0x170)](_0x3da90f(0x1b7)+_0x4b5921['id']+_0x3da90f(0x158)+_0x376ad5[_0x3da90f(0x107)]),await this['updatePaymentStatus'](_0x4b5921['id'],_0x376ad5[_0x3da90f(0x107)],{'paymentMethod':_0x376ad5[_0x3da90f(0x17d)]?.['payment_method']}),loggerService_1[_0x3da90f(0x162)][_0x3da90f(0x1eb)](_0x3da90f(0x1ef),_0x4b5921['id'],_0x4b5921[_0x3da90f(0x107)],_0x376ad5[_0x3da90f(0x107)],_0x28c71c);}catch(_0x134521){console['error'](_0x3da90f(0x1e8),_0x134521),loggerService_1[_0x3da90f(0x162)][_0x3da90f(0x1f8)]('klyme',_0x134521,_0x28c71c);throw _0x134521;}}async[a60_0x3804d2(0x1e6)](_0x1cadbb){const _0x20df3d=a60_0x3804d2;console[_0x20df3d(0x170)]('🔄\x20Processing\x20MasterCard\x20webhook:',JSON[_0x20df3d(0x13d)](_0x1cadbb,null,0x2));try{const _0x3cfc95=await this[_0x20df3d(0x164)][_0x20df3d(0x185)](_0x1cadbb);console['log']('📊\x20MasterCard\x20webhook\x20result:',_0x3cfc95);if(!_0x3cfc95[_0x20df3d(0x19f)]){console[_0x20df3d(0x14a)](_0x20df3d(0x17f)),console[_0x20df3d(0x14a)](_0x20df3d(0x135),Object[_0x20df3d(0x144)](_0x1cadbb));throw new Error(_0x20df3d(0x109));}let _0x6a8e9f=null;console[_0x20df3d(0x170)]('🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x3cfc95['paymentId']);_0x3cfc95['paymentId']&&(console[_0x20df3d(0x170)]('🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x6a8e9f=await database_1[_0x20df3d(0x19d)][_0x20df3d(0x12c)][_0x20df3d(0x183)]({'where':{'AND':[{'gateway':_0x20df3d(0x1bc)},{'OR':[{'gatewayPaymentId':_0x3cfc95[_0x20df3d(0x19f)]},{'gatewayOrderId':_0x3cfc95[_0x20df3d(0x19f)]},{'id':_0x3cfc95[_0x20df3d(0x19f)]},{'orderId':_0x3cfc95[_0x20df3d(0x19f)]}]}]}}),console[_0x20df3d(0x170)](_0x20df3d(0x159)+(_0x6a8e9f?_0x20df3d(0x16b)+_0x6a8e9f['id']:_0x20df3d(0x115))));if(!_0x6a8e9f){console[_0x20df3d(0x14a)]('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x3cfc95[_0x20df3d(0x19f)]),console[_0x20df3d(0x14a)](_0x20df3d(0x137)+_0x3cfc95[_0x20df3d(0x19f)]+_0x20df3d(0x18c)+_0x3cfc95[_0x20df3d(0x19f)]+_0x20df3d(0x13b)+_0x3cfc95[_0x20df3d(0x19f)]+'\x22');const _0x1cff1b=await database_1['default']['payment'][_0x20df3d(0x1fc)]({'where':{'gateway':_0x20df3d(0x1bc)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x20df3d(0x170)](_0x20df3d(0x17a),_0x1cff1b);return;}console[_0x20df3d(0x170)](_0x20df3d(0x10e)+_0x6a8e9f['id']+_0x20df3d(0x1dd)+_0x6a8e9f[_0x20df3d(0x107)]+_0x20df3d(0x1f5)+_0x3cfc95[_0x20df3d(0x107)]),await this['updatePaymentStatus'](_0x6a8e9f['id'],_0x3cfc95[_0x20df3d(0x107)]),loggerService_1[_0x20df3d(0x162)]['logWebhookProcessed'](_0x20df3d(0x1bc),_0x6a8e9f['id'],_0x6a8e9f['status'],_0x3cfc95[_0x20df3d(0x107)],_0x1cadbb);}catch(_0x5af791){console[_0x20df3d(0x14a)]('❌\x20Error\x20processing\x20MasterCard\x20webhook:',_0x5af791),loggerService_1[_0x20df3d(0x162)][_0x20df3d(0x1f8)](_0x20df3d(0x1bc),_0x5af791,_0x1cadbb);throw _0x5af791;}}async[a60_0x3804d2(0x1ec)](_0x445012){const _0x46674c=a60_0x3804d2;console[_0x46674c(0x170)]('🔄\x20Processing\x20Amer\x20webhook:',JSON[_0x46674c(0x13d)](_0x445012,null,0x2));try{const _0x509342=await this[_0x46674c(0x180)][_0x46674c(0x185)](_0x445012);console[_0x46674c(0x170)](_0x46674c(0x1a8),_0x509342);if(!_0x509342['paymentId']){console[_0x46674c(0x14a)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data'),console[_0x46674c(0x14a)]('❌\x20Available\x20webhook\x20fields:',Object[_0x46674c(0x144)](_0x445012));throw new Error('No\x20payment\x20ID\x20in\x20Amer\x20webhook');}let _0x68f25a=null;console[_0x46674c(0x170)](_0x46674c(0x1fa)+_0x509342[_0x46674c(0x19f)]),_0x68f25a=await database_1[_0x46674c(0x19d)][_0x46674c(0x12c)][_0x46674c(0x183)]({'where':{'AND':[{'gateway':_0x46674c(0x154)},{'OR':[{'gatewayPaymentId':_0x509342['paymentId']},{'gatewayOrderId':_0x509342['paymentId']},{'id':_0x509342[_0x46674c(0x19f)]},{'orderId':_0x509342[_0x46674c(0x19f)]}]}]}}),console[_0x46674c(0x170)](_0x46674c(0x159)+(_0x68f25a?_0x46674c(0x16b)+_0x68f25a['id']:_0x46674c(0x115)));if(!_0x68f25a){console[_0x46674c(0x14a)]('❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20'+_0x509342['paymentId']);return;}console[_0x46674c(0x170)](_0x46674c(0x190)+_0x68f25a['id']+_0x46674c(0x158)+_0x509342[_0x46674c(0x107)]),await this[_0x46674c(0x1c9)](_0x68f25a['id'],_0x509342[_0x46674c(0x107)],{'cardLast4':_0x509342[_0x46674c(0x17d)]?.[_0x46674c(0x134)],'paymentMethod':_0x509342[_0x46674c(0x17d)]?.[_0x46674c(0x172)]});}catch(_0x394911){console['error'](_0x46674c(0x127),_0x394911),loggerService_1['loggerService'][_0x46674c(0x1f8)](_0x46674c(0x154),_0x394911,_0x445012);throw _0x394911;}}async[a60_0x3804d2(0x1a5)](_0x776ead,_0x4ec13f){const _0x187cae=a60_0x3804d2,_0x51c30a=Date[_0x187cae(0x16e)]();try{const _0x3df744=_0x776ead[_0x187cae(0x1b0)],_0x2f0abe=_0x3df744['settings'];if(!_0x2f0abe?.[_0x187cae(0x199)]){console['log'](_0x187cae(0x1d5)+_0x3df744['id']);return;}const _0x422bc4=_0x4ec13f===_0x187cae(0x1b6)?_0x187cae(0x138):_0x4ec13f==='FAILED'?'payment.failed':_0x4ec13f===_0x187cae(0x1a1)?_0x187cae(0x19a):_0x4ec13f==='CHARGEBACK'?'payment.failed':_0x4ec13f===_0x187cae(0x197)?'payment.failed':_0x187cae(0x184);let _0x29e192=[];if(_0x2f0abe[_0x187cae(0x1c7)])try{_0x29e192=Array[_0x187cae(0x14d)](_0x2f0abe[_0x187cae(0x1c7)])?_0x2f0abe[_0x187cae(0x1c7)]:JSON['parse'](_0x2f0abe[_0x187cae(0x1c7)]);}catch(_0xe3c9d6){console[_0x187cae(0x14a)]('Error\x20parsing\x20webhook\x20events:',_0xe3c9d6),_0x29e192=[];}if(!_0x29e192[_0x187cae(0x198)](_0x422bc4)){console['log'](_0x187cae(0x167)+_0x422bc4+_0x187cae(0x12b)+_0x3df744['id']);return;}const _0x5b2170={'event':_0x422bc4,'payment':{'id':_0x776ead['id'],'order_id':_0x776ead[_0x187cae(0x1cc)],'gateway_order_id':_0x776ead[_0x187cae(0x10a)],'gateway':_0x776ead[_0x187cae(0x12e)],'amount':_0x776ead[_0x187cae(0x16f)],'currency':_0x776ead[_0x187cae(0x174)],'status':_0x4ec13f['toLowerCase'](),'customer_email':_0x776ead[_0x187cae(0x156)],'customer_name':_0x776ead[_0x187cae(0x1d0)],'failure_message':_0x776ead[_0x187cae(0x125)],'tx_urls':_0x776ead[_0x187cae(0x1ad)]?JSON[_0x187cae(0x15f)](_0x776ead['txUrls']):null,'created_at':_0x776ead[_0x187cae(0x1e5)],'updated_at':_0x776ead[_0x187cae(0x146)]}},_0x246cb2=await fetch(_0x2f0abe['webhookUrl'],{'method':_0x187cae(0x122),'headers':{'Content-Type':'application/json','User-Agent':_0x187cae(0x1b4)},'body':JSON['stringify'](_0x5b2170)}),_0x4c109e=Date[_0x187cae(0x16e)]()-_0x51c30a,_0x229beb=_0x246cb2['ok']?_0x187cae(0x10c):await _0x246cb2[_0x187cae(0x1cb)]();loggerService_1[_0x187cae(0x162)][_0x187cae(0x141)](_0x776ead['shopId'],_0x2f0abe['webhookUrl'],_0x422bc4,_0x246cb2[_0x187cae(0x107)],_0x4c109e,_0x5b2170),console['log'](_0x187cae(0x1c0)+_0x2f0abe[_0x187cae(0x199)]+_0x187cae(0x1a0)+_0x246cb2[_0x187cae(0x107)]+'\x20('+_0x4c109e+_0x187cae(0x173));}catch(_0x3afd01){console['error'](_0x187cae(0x1f2),_0x3afd01),loggerService_1[_0x187cae(0x162)][_0x187cae(0x194)](_0x776ead[_0x187cae(0x1f0)],_0x776ead[_0x187cae(0x1b0)]?.['settings']?.['webhookUrl']||_0x187cae(0x1d9),_0x187cae(0x160),_0x3afd01,{});}}async[a60_0x3804d2(0x1e4)](_0xf56ce1,_0x37884c){const _0x2b9482=a60_0x3804d2;try{const _0x2d8995={'PENDING':'created','PROCESSING':_0x2b9482(0x116),'PAID':_0x2b9482(0x1af),'FAILED':_0x2b9482(0x168),'EXPIRED':_0x2b9482(0x1c3),'REFUND':'refund','CHARGEBACK':'chargeback'},_0x2dc3e5=_0x2d8995[_0x37884c];if(!_0x2dc3e5||_0x2dc3e5===_0x2b9482(0x1b5))return;await telegramBotService_1['telegramBotService'][_0x2b9482(0x1dc)](_0xf56ce1['shopId'],_0xf56ce1,_0x2dc3e5);}catch(_0x115d60){console[_0x2b9482(0x14a)](_0x2b9482(0x128),_0x115d60);}}async[a60_0x3804d2(0x126)](_0x17e7de,_0x6286c7){const _0x559527=a60_0x3804d2;try{const _0x2076d7=await database_1['default'][_0x559527(0x1b0)][_0x559527(0x114)]({'where':{'id':_0x17e7de},'select':{'gatewaySettings':!![]}});if(!_0x2076d7?.[_0x559527(0x193)])return console[_0x559527(0x170)](_0x559527(0x143)+_0x17e7de+_0x559527(0x189)),0xa;const _0x45b4b1=JSON[_0x559527(0x15f)](_0x2076d7[_0x559527(0x193)]);for(const [_0x4ad3d0,_0x182eff]of Object[_0x559527(0x15e)](_0x45b4b1)){if(_0x4ad3d0[_0x559527(0x1e0)]()===_0x6286c7['toLowerCase']()){const _0x5b9c02=_0x182eff[_0x559527(0x191)]||0xa;return console[_0x559527(0x170)](_0x559527(0x118)+_0x6286c7+_0x559527(0x1fb)+_0x17e7de+':\x20'+_0x5b9c02+'%'),_0x5b9c02;}}return console[_0x559527(0x170)](_0x559527(0x1d8)+_0x6286c7+_0x559527(0x1a6)+_0x17e7de+_0x559527(0x1b1)),0xa;}catch(_0x2caa6e){return console['error'](_0x559527(0x1cf)+_0x17e7de+_0x559527(0x188)+_0x6286c7+':',_0x2caa6e),0xa;}}}exports[a60_0x3804d2(0x1fd)]=WebhookService;function a60_0x1215(){const _0x2d176f=['payment.success','paidAt','plisio','\x22,\x20orderId=\x22','RapydService','stringify','username','11363rclZlr','546976ZFtCno','logShopWebhookSent','type','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','keys','remitterIban','updatedAt',',\x20currentPayments=','cointopay2','❌\x20Payment\x20link\x20','error','./loggerService','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','isArray','currencyService','./currencyService','💰\x20Gateway\x20','./gateways/plisioService','./gateways/amerService','\x20commission:\x20','amer','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','customerEmail','convertToUSDT','\x20status\x20','🔍\x20Search\x20result:\x20','4YoHWyo','🔄\x20Processing\x20CoinToPay\x20webhook:','🔄\x20Processing\x20KLYME\x20webhook:','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','entries','parse','webhook_send','rapydService','loggerService','$transaction','masterCardService','plisio_gateway','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','Webhook\x20event\x20','failed','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','PlisioService','Found\x20payment\x20','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','now','amount','log','\x20USDT','paymentMethod','ms)','currency','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','coinToPayService','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','MasterCardService','Error\x20processing\x20Noda\x20webhook:','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','__esModule','150628EweEoz','additionalInfo','toUpperCase','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','amerService','\x22,\x20paymentLinkId=\x22','./gateways/mastercardService','findFirst','payment.pending','processWebhook','%\x20gateway\x20commission)','Payment\x20',',\x20gateway\x20',',\x20using\x20default\x20commission\x2010%','nodaService','4130CzXWpp','\x22,\x20id=\x22','coinToPay2Service','COMPLETED','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','📊\x20Amer\x20webhook:\x20Payment\x20','commission','paymentLinkId','gatewaySettings','logShopWebhookError','processPlisioGatewayWebhook','\x20balance\x20updated:\x20','REFUND','includes','webhookUrl','payment.failed','plisioService','klymeService','default','bankId','paymentId','\x20with\x20status\x20','EXPIRED','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','CHARGEBACK','📈\x20Payment\x20','sendShopWebhook','\x20in\x20shop\x20','../config/database','📊\x20Amer\x20webhook\x20result:','\x20and\x20-','processRapydWebhook','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','🔄\x20Processing\x20CoinToPay2\x20webhook:','txUrls','__importDefault','paid','shop',',\x20using\x20default\x2010%','processCoinToPay2Webhook',':\x20type=','TesSoft\x20Payment\x20System/1.0','created','PAID','📊\x20KLYME\x20webhook:\x20Payment\x20','\x20=\x20','45vwjqLY','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','paymentLink','mastercard','21wpdElH',',\x20status=','AmerService','📤\x20Shop\x20webhook\x20sent\x20to\x20','🔄\x20Processing\x20Plisio\x20webhook:','remitterName','expired','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','🔄\x20Additional\x20data:','\x20+\x20','webhookEvents','processNodaWebhook','updatePaymentStatus','Error\x20processing\x20CoinToPay\x20webhook:','text','orderId','./gateways/coinToPayService','cointopay','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','customerName','📊\x20Plisio\x20webhook:\x20Payment\x20','chargebackAmount','✅\x20Payment\x20link\x20','webhookLog','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','📊\x20Noda\x20webhook:\x20Payment\x20','\x20updated:\x20currentPayments=','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','unknown','📈\x20Payment\x20details:\x20oldStatus=\x22','💸\x20Additional\x20chargeback\x20penalty:\x20-','sendPaymentNotification','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','501439VPNBeH','amountAfterGatewayCommissionUSDT','toLowerCase','Error\x20processing\x20Plisio\x20webhook:','processCoinToPayWebhook','\x20not\x20found','sendPaymentStatusNotification','createdAt','processMasterCardWebhook','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','Error\x20processing\x20KLYME\x20webhook:','\x22,\x20newStatus=\x22','\x20USDT\x20(chargeback\x20penalty)','logWebhookProcessed','processAmerWebhook','amountUSDT','balance','klyme','shopId','toFixed','Failed\x20to\x20send\x20shop\x20webhook:','no\x20balance\x20change','currentPayments','\x20to\x20','noda','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','logWebhookError','\x20->\x20','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20commission\x20for\x20shop\x20','findMany','WebhookService','status','Error\x20processing\x20Rapyd\x20webhook:','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','gatewayOrderId',',\x20newStatus=','Success','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','✅\x20Found\x20payment\x20','✅\x20Shop\x20','webhook_status_change_','CoinToPay2Service','create','21221436PsufuS','findUnique','Payment\x20not\x20found','processing','\x20-\x20','Gateway\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','\x20current\x20balance:\x20','SINGLE','CoinToPayService','💰\x20Adding\x20to\x20balance:\x20','📈\x20Found\x20payment\x20link\x20','update','1554630kCzJvN','🏪\x20Shop\x20','POST','processKlymeWebhook','./gateways/rapydService','failureMessage','getGatewayCommission','❌\x20Error\x20processing\x20Amer\x20webhook:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','12VdCTBB','system','\x20not\x20enabled\x20for\x20shop\x20','payment','rapyd','gateway','Error\x20processing\x20CoinToPay2\x20webhook:','toISOString','No\x20payment\x20ID\x20in\x20Noda\x20webhook','451087YPOouy','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','cardLast4','❌\x20Available\x20webhook\x20fields:','./telegramBotService','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22'];a60_0x1215=function(){return _0x2d176f;};return a60_0x1215();}