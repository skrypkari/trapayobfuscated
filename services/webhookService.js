'use strict';const a58_0x335620=a58_0x2a8a;(function(_0x485250,_0x38a316){const _0x4d4122=a58_0x2a8a,_0x4bdc6f=_0x485250();while(!![]){try{const _0x4292fd=-parseInt(_0x4d4122(0xf4))/0x1*(parseInt(_0x4d4122(0xd8))/0x2)+parseInt(_0x4d4122(0x126))/0x3+-parseInt(_0x4d4122(0xdf))/0x4+-parseInt(_0x4d4122(0x162))/0x5+-parseInt(_0x4d4122(0x107))/0x6+-parseInt(_0x4d4122(0xb7))/0x7*(parseInt(_0x4d4122(0xf9))/0x8)+parseInt(_0x4d4122(0xe8))/0x9;if(_0x4292fd===_0x38a316)break;else _0x4bdc6f['push'](_0x4bdc6f['shift']());}catch(_0x5b44e4){_0x4bdc6f['push'](_0x4bdc6f['shift']());}}}(a58_0x35de,0x30ff0));var __importDefault=this&&this[a58_0x335620(0x106)]||function(_0x534e32){return _0x534e32&&_0x534e32['__esModule']?_0x534e32:{'default':_0x534e32};};function a58_0x2a8a(_0x2a7f99,_0x3278d5){const _0x35de08=a58_0x35de();return a58_0x2a8a=function(_0x2a8a18,_0xdbaf6b){_0x2a8a18=_0x2a8a18-0x9a;let _0x1fc8e9=_0x35de08[_0x2a8a18];return _0x1fc8e9;},a58_0x2a8a(_0x2a7f99,_0x3278d5);}Object[a58_0x335620(0x12a)](exports,'__esModule',{'value':!![]}),exports[a58_0x335620(0x14f)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a58_0x335620(0x156)),nodaService_1=require(a58_0x335620(0xcd)),coinToPayService_1=require(a58_0x335620(0x15f)),coinToPay2Service_1=require(a58_0x335620(0x100)),klymeService_1=require(a58_0x335620(0x141)),mastercardService_1=require(a58_0x335620(0xab)),telegramBotService_1=require('./telegramBotService'),currencyService_1=require('./currencyService'),loggerService_1=require(a58_0x335620(0x9f));function a58_0x35de(){const _0x17ef1e=['txUrls','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','CHARGEBACK','ms)','\x22,\x20id=\x22','rapydService','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','paidAt','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','46LcGeOy','masterCardService','klyme','failureMessage','sendPaymentStatusNotification','customerEmail','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','1276344XGPqsU','nodaService','CoinToPay2Service','processNodaWebhook','status','logShopWebhookSent','remitterIban','stringify','💰\x20Payment\x20','7140348okztFQ','settings','updatePaymentStatus','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','orderId','payment.pending','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','amountUSDT','REFUND','chargeback','coinToPay2Service','1289MJCxTW','error','Error\x20processing\x20KLYME\x20webhook:','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','💸\x20Additional\x20chargeback\x20penalty:\x20-','1347464FJQtTq','paymentId','\x20status\x20','toFixed','Error\x20processing\x20Plisio\x20webhook:','paid','CoinToPayService','./gateways/coinToPay2Service','mastercard','Payment\x20','processCoinToPayWebhook','logShopWebhookError','Error\x20parsing\x20webhook\x20events:','__importDefault','996396BbnkxJ','shopId','expired','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','sendShopWebhook','keys','Success','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','plisioService','PlisioService','createdAt','No\x20payment\x20ID\x20in\x20Noda\x20webhook','SINGLE','processMasterCardWebhook','payment.success','gateway','shop','text','logWebhookProcessed','plisio','📈\x20Payment\x20','currencyService','logWebhookError','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','🏪\x20Shop\x20','webhookLog','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','payment.failed','processRapydWebhook','Found\x20payment\x20','📝\x20Reason:\x20','666057ZohyPY','🔄\x20Processing\x20KLYME\x20webhook:','processPlisioGatewayWebhook','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','defineProperty','🔄\x20Processing\x20MasterCard\x20webhook:','🔄\x20Processing\x20Noda\x20webhook:','\x20not\x20enabled\x20for\x20shop\x20','✅\x20Payment\x20link\x20','FAILED','username','coinToPayService','webhookUrl','default','remitterName','update','✅\x20Shop\x20','now','EXPIRED','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','PAID','\x20USDT','Error\x20processing\x20CoinToPay2\x20webhook:','toLowerCase','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','amount','application/json','./gateways/klymeService','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','✅\x20Found\x20payment\x20','toUpperCase','klymeService',',\x20status=','\x20->\x20','RapydService','findFirst','failed','❌\x20Available\x20webhook\x20fields:','processWebhook','additionalInfo','no\x20balance\x20change','WebhookService','bankId','convertToUSDT','cardLast4','📊\x20KLYME\x20webhook:\x20Payment\x20','🔄\x20Processing\x20Plisio\x20webhook:','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','./gateways/rapydService','Failed\x20to\x20send\x20shop\x20webhook:','\x20updated:\x20currentPayments=','NodaService','💰\x20Removing\x20from\x20balance:\x20','📊\x20MasterCard\x20webhook\x20result:','\x20=\x20','📈\x20Found\x20payment\x20link\x20','sendPaymentNotification','./gateways/coinToPayService','noda','loggerService','657355dFWUvD','🔄\x20Processing\x20Rapyd\x20webhook:',',\x20newStatus=',':\x20type=','cointopay','system','type','paymentLink','paymentMethod','./loggerService','🔍\x20Search\x20result:\x20','POST','plisio_gateway','rapyd','❌\x20Payment\x20link\x20','payment','Webhook\x20event\x20','\x20current\x20balance:\x20','📊\x20Noda\x20webhook:\x20Payment\x20','currency','balance','./gateways/mastercardService','❌\x20Error\x20processing\x20MasterCard\x20webhook:','MasterCardService','cointopay2','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','payment_method','webhook_status_change_','🔄\x20Processing\x20CoinToPay\x20webhook:','$transaction','\x20not\x20found','includes','\x22,\x20newStatus=\x22','7FxzOYB','processKlymeWebhook','\x20balance\x20updated:\x20','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','log','💰\x20Converting\x20','unknown','💰\x20Adding\x20to\x20balance:\x20','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','customerName','telegramBotService','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','webhookEvents','processCoinToPay2Webhook','Error\x20processing\x20Rapyd\x20webhook:','KlymeService','processing','isArray','created','chargebackAmount','Error\x20processing\x20Noda\x20webhook:','paymentLinkId','./gateways/nodaService'];a58_0x35de=function(){return _0x17ef1e;};return a58_0x35de();}class WebhookService{constructor(){const _0x84c44=a58_0x335620;this[_0x84c44(0x10f)]=new plisioService_1[(_0x84c44(0x110))](),this[_0x84c44(0xd4)]=new rapydService_1[(_0x84c44(0x148))](),this[_0x84c44(0xe0)]=new nodaService_1[(_0x84c44(0x159))](),this[_0x84c44(0x131)]=new coinToPayService_1[(_0x84c44(0xff))](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x84c44(0xe1))](),this[_0x84c44(0x145)]=new klymeService_1[(_0x84c44(0xc6))](),this['masterCardService']=new mastercardService_1[(_0x84c44(0xad))]();}async[a58_0x335620(0xea)](_0x3ca4d5,_0x4b4d46,_0x2eb58c){const _0x501550=a58_0x335620;console[_0x501550(0xbb)](_0x501550(0xec)+_0x3ca4d5+_0x501550(0x164)+_0x4b4d46),console['log']('🔄\x20Additional\x20data:',_0x2eb58c),await database_1[_0x501550(0x133)][_0x501550(0xb3)](async _0x4b9c6a=>{const _0x265025=_0x501550,_0x1e23a8=await _0x4b9c6a[_0x265025(0xa5)]['findUnique']({'where':{'id':_0x3ca4d5},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1e23a8)throw new Error(_0x265025(0x102)+_0x3ca4d5+'\x20not\x20found');const _0x47a6f9=_0x1e23a8[_0x265025(0xe3)],_0x2f6d6d=_0x1e23a8[_0x265025(0x117)];console[_0x265025(0xbb)](_0x265025(0xe7)+_0x3ca4d5+':\x20'+_0x47a6f9+_0x265025(0x147)+_0x4b4d46),console['log'](_0x265025(0x11f)+_0x2f6d6d[_0x265025(0x130)]+_0x265025(0xa7)+_0x2f6d6d['balance']+_0x265025(0x13b));const _0xb322be={'status':_0x4b4d46[_0x265025(0x144)](),'updatedAt':new Date(),'statusChangedBy':_0x265025(0x9b),'statusChangedAt':new Date()};_0x2eb58c?.[_0x265025(0xdb)]&&(_0xb322be[_0x265025(0xdb)]=_0x2eb58c[_0x265025(0xdb)]);_0x2eb58c?.[_0x265025(0xce)]&&(_0xb322be[_0x265025(0xce)]=JSON[_0x265025(0xe6)](_0x2eb58c[_0x265025(0xce)]));_0x2eb58c?.['cardLast4']&&(_0xb322be[_0x265025(0x152)]=_0x2eb58c[_0x265025(0x152)]);_0x2eb58c?.[_0x265025(0x9e)]&&(_0xb322be[_0x265025(0x9e)]=_0x2eb58c[_0x265025(0x9e)]);_0x2eb58c?.[_0x265025(0x150)]&&(_0xb322be['bankId']=_0x2eb58c[_0x265025(0x150)]);_0x2eb58c?.['remitterIban']&&(_0xb322be[_0x265025(0xe5)]=_0x2eb58c[_0x265025(0xe5)]);_0x2eb58c?.[_0x265025(0x134)]&&(_0xb322be[_0x265025(0x134)]=_0x2eb58c[_0x265025(0x134)]);let _0x15761a=_0x2f6d6d[_0x265025(0xaa)],_0x4abe38='';if(_0x4b4d46[_0x265025(0x144)]()===_0x265025(0x13a)&&_0x47a6f9!==_0x265025(0x13a)){const _0x414196=await currencyService_1[_0x265025(0x11c)][_0x265025(0x151)](_0x1e23a8['amount'],_0x1e23a8[_0x265025(0xa9)]);_0x15761a+=_0x414196,_0x4abe38='+'+_0x414196[_0x265025(0xfc)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID)',_0xb322be[_0x265025(0xf0)]=_0x414196,_0xb322be['paidAt']=new Date(),console[_0x265025(0xbb)](_0x265025(0xbc)+_0x1e23a8['amount']+'\x20'+_0x1e23a8[_0x265025(0xa9)]+_0x265025(0x147)+_0x414196[_0x265025(0xfc)](0x6)+_0x265025(0x13b)),console[_0x265025(0xbb)](_0x265025(0xbe)+_0x2f6d6d[_0x265025(0xaa)]+'\x20+\x20'+_0x414196[_0x265025(0xfc)](0x6)+_0x265025(0x15c)+_0x15761a[_0x265025(0xfc)](0x6)+_0x265025(0x13b));}else{if(_0x47a6f9===_0x265025(0x13a)&&_0x4b4d46['toUpperCase']()!==_0x265025(0x13a)){const _0x3ec611=_0x1e23a8[_0x265025(0xf0)];_0x3ec611&&(_0x15761a-=_0x3ec611,_0x4abe38='-'+_0x3ec611[_0x265025(0xfc)](0x6)+_0x265025(0xba),_0xb322be[_0x265025(0xf0)]=null,_0xb322be[_0x265025(0xd6)]=null,console[_0x265025(0xbb)](_0x265025(0x15a)+_0x2f6d6d['balance']+'\x20-\x20'+_0x3ec611[_0x265025(0xfc)](0x6)+'\x20=\x20'+_0x15761a[_0x265025(0xfc)](0x6)+_0x265025(0x13b)));}}if(_0x4b4d46[_0x265025(0x144)]()===_0x265025(0xd1)){const _0x5a602c=_0x2eb58c?.[_0x265025(0xca)]||0x0;_0x5a602c>0x0&&(_0x15761a-=_0x5a602c,_0x4abe38+='\x20and\x20-'+_0x5a602c[_0x265025(0xfc)](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0xb322be[_0x265025(0xca)]=_0x5a602c,console[_0x265025(0xbb)](_0x265025(0xf8)+_0x5a602c[_0x265025(0xfc)](0x6)+_0x265025(0x13b)),console[_0x265025(0xbb)]('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x15761a[_0x265025(0xfc)](0x6)+_0x265025(0x13b)));}const _0x8df432=await _0x4b9c6a['payment'][_0x265025(0x135)]({'where':{'id':_0x3ca4d5},'data':_0xb322be});_0x15761a!==_0x2f6d6d[_0x265025(0xaa)]&&(await _0x4b9c6a[_0x265025(0x117)]['update']({'where':{'id':_0x2f6d6d['id']},'data':{'balance':_0x15761a}}),console['log'](_0x265025(0x136)+_0x2f6d6d[_0x265025(0x130)]+_0x265025(0xb9)+_0x2f6d6d[_0x265025(0xaa)][_0x265025(0xfc)](0x6)+'\x20->\x20'+_0x15761a[_0x265025(0xfc)](0x6)+_0x265025(0x13b)),console[_0x265025(0xbb)](_0x265025(0x125)+_0x4abe38));await _0x4b9c6a[_0x265025(0x120)]['create']({'data':{'paymentId':_0x3ca4d5,'shopId':_0x2f6d6d['id'],'event':_0x265025(0xb1)+_0x4b4d46[_0x265025(0x13d)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x47a6f9,'newStatus':_0x4b4d46[_0x265025(0x144)](),'balanceChange':_0x4abe38||_0x265025(0x14e),'oldBalance':_0x2f6d6d[_0x265025(0xaa)],'newBalance':_0x15761a,'amountUSDT':_0xb322be[_0x265025(0xf0)],'additionalData':_0x2eb58c,'timestamp':new Date()['toISOString']()})}}),await this[_0x265025(0x10b)]({..._0x1e23a8,..._0x8df432,'shop':_0x2f6d6d},_0x4b4d46[_0x265025(0x144)]()),await this['sendPaymentStatusNotification']({..._0x1e23a8,..._0x8df432},_0x4b4d46[_0x265025(0x144)]());if(_0x47a6f9!==_0x265025(0x13a)&&_0x4b4d46[_0x265025(0x144)]()===_0x265025(0x13a)){console['log'](_0x265025(0x11b)+_0x3ca4d5+_0x265025(0x11e)),console[_0x265025(0xbb)]('📈\x20Payment\x20details:\x20oldStatus=\x22'+_0x47a6f9+_0x265025(0xb6)+_0x4b4d46[_0x265025(0x144)]()+'\x22,\x20paymentLinkId=\x22'+_0x1e23a8[_0x265025(0xcc)]+'\x22');if(_0x1e23a8['paymentLinkId'])try{const _0x5c7f0b=await _0x4b9c6a[_0x265025(0x9d)]['findUnique']({'where':{'id':_0x1e23a8[_0x265025(0xcc)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5c7f0b){console['log'](_0x265025(0x15d)+_0x5c7f0b['id']+_0x265025(0x165)+_0x5c7f0b[_0x265025(0x9c)]+',\x20currentPayments='+_0x5c7f0b['currentPayments']+_0x265025(0x146)+_0x5c7f0b['status']);const _0x129081=_0x5c7f0b['currentPayments']+0x1,_0x49ffc4=_0x5c7f0b[_0x265025(0x9c)]===_0x265025(0x113)?'COMPLETED':_0x5c7f0b[_0x265025(0xe3)];await _0x4b9c6a['paymentLink'][_0x265025(0x135)]({'where':{'id':_0x1e23a8['paymentLinkId']},'data':{'currentPayments':_0x129081,'status':_0x49ffc4,'updatedAt':new Date()}}),console[_0x265025(0xbb)](_0x265025(0x12e)+_0x5c7f0b['id']+_0x265025(0x158)+_0x5c7f0b['currentPayments']+_0x265025(0x147)+_0x129081+',\x20status='+_0x5c7f0b[_0x265025(0xe3)]+'\x20->\x20'+_0x49ffc4);}else console[_0x265025(0xbb)](_0x265025(0xa4)+_0x1e23a8[_0x265025(0xcc)]+_0x265025(0xb4));}catch(_0x33e48c){console[_0x265025(0xf5)](_0x265025(0xaf),_0x33e48c);}else console[_0x265025(0xbb)](_0x265025(0x11b)+_0x3ca4d5+_0x265025(0xde));}else console[_0x265025(0xbb)](_0x265025(0x11b)+_0x3ca4d5+_0x265025(0x155)+_0x47a6f9+_0x265025(0x147)+_0x4b4d46['toUpperCase']());});}async['processPlisioWebhook'](_0x43a310){const _0x44becf=a58_0x335620;console[_0x44becf(0xbb)](_0x44becf(0x154),_0x43a310);try{const _0x5449cb=await this[_0x44becf(0x10f)]['processWebhook'](_0x43a310);if(!_0x5449cb[_0x44becf(0xfa)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x586d74=await database_1['default'][_0x44becf(0xa5)][_0x44becf(0x149)]({'where':{'gatewayOrderId':_0x5449cb[_0x44becf(0xfa)]}});if(!_0x586d74){console[_0x44becf(0xf5)](_0x44becf(0x142)+_0x5449cb[_0x44becf(0xfa)]);return;}console['log']('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0x586d74['id']+_0x44becf(0xfb)+_0x5449cb[_0x44becf(0xe3)]),await this[_0x44becf(0xea)](_0x586d74['id'],_0x5449cb['status'],{'txUrls':_0x5449cb[_0x44becf(0xce)]}),loggerService_1[_0x44becf(0x161)][_0x44becf(0x119)](_0x44becf(0x11a),_0x586d74['id'],_0x586d74['status'],_0x5449cb[_0x44becf(0xe3)],_0x43a310);}catch(_0x560002){console[_0x44becf(0xf5)](_0x44becf(0xfd),_0x560002),loggerService_1[_0x44becf(0x161)][_0x44becf(0x11d)](_0x44becf(0x11a),_0x560002,_0x43a310);throw _0x560002;}}async[a58_0x335620(0x128)](_0x390e1b){const _0x457d60=a58_0x335620;console['log'](_0x457d60(0xd0),_0x390e1b);try{const _0x26819b=await this[_0x457d60(0x10f)][_0x457d60(0x14c)](_0x390e1b);if(!_0x26819b['paymentId'])throw new Error(_0x457d60(0xf7));const _0x15b1c8=await database_1['default'][_0x457d60(0xa5)]['findFirst']({'where':{'gatewayOrderId':_0x26819b[_0x457d60(0xfa)]}});if(!_0x15b1c8){console[_0x457d60(0xf5)]('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x26819b[_0x457d60(0xfa)]);return;}console[_0x457d60(0xbb)]('📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20'+_0x15b1c8['id']+_0x457d60(0xfb)+_0x26819b['status']),await this['updatePaymentStatus'](_0x15b1c8['id'],_0x26819b[_0x457d60(0xe3)],{'txUrls':_0x26819b[_0x457d60(0xce)]}),loggerService_1[_0x457d60(0x161)][_0x457d60(0x119)](_0x457d60(0xa2),_0x15b1c8['id'],_0x15b1c8[_0x457d60(0xe3)],_0x26819b[_0x457d60(0xe3)],_0x390e1b);}catch(_0x3021a9){console['error'](_0x457d60(0xef),_0x3021a9),loggerService_1[_0x457d60(0x161)]['logWebhookError']('plisio_gateway',_0x3021a9,_0x390e1b);throw _0x3021a9;}}async[a58_0x335620(0x123)](_0x2fe98e){const _0x1e3692=a58_0x335620;console[_0x1e3692(0xbb)](_0x1e3692(0x163),_0x2fe98e);try{const _0x518557=await this['rapydService'][_0x1e3692(0x14c)](_0x2fe98e);if(!_0x518557[_0x1e3692(0xfa)])throw new Error(_0x1e3692(0x13e));const _0x45f84a=await database_1['default']['payment'][_0x1e3692(0x149)]({'where':{'gatewayOrderId':_0x518557[_0x1e3692(0xfa)]}});if(!_0x45f84a){console[_0x1e3692(0xf5)](_0x1e3692(0xd5)+_0x518557[_0x1e3692(0xfa)]);return;}console[_0x1e3692(0xbb)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x45f84a['id']+_0x1e3692(0xfb)+_0x518557[_0x1e3692(0xe3)]),await this[_0x1e3692(0xea)](_0x45f84a['id'],_0x518557[_0x1e3692(0xe3)],{'failureMessage':_0x518557[_0x1e3692(0xdb)],'cardLast4':_0x518557[_0x1e3692(0x14d)]?.[_0x1e3692(0x152)],'paymentMethod':_0x518557[_0x1e3692(0x14d)]?.[_0x1e3692(0x9e)]}),loggerService_1[_0x1e3692(0x161)][_0x1e3692(0x119)](_0x1e3692(0xa3),_0x45f84a['id'],_0x45f84a['status'],_0x518557['status'],_0x2fe98e);}catch(_0x4e999c){console[_0x1e3692(0xf5)](_0x1e3692(0xc5),_0x4e999c),loggerService_1[_0x1e3692(0x161)]['logWebhookError'](_0x1e3692(0xa3),_0x4e999c,_0x2fe98e);throw _0x4e999c;}}async[a58_0x335620(0xe2)](_0x398ff6){const _0x980ba7=a58_0x335620;console[_0x980ba7(0xbb)](_0x980ba7(0x12c),_0x398ff6);try{const _0x27b65e=await this['nodaService']['processWebhook'](_0x398ff6);if(!_0x27b65e[_0x980ba7(0xfa)])throw new Error(_0x980ba7(0x112));const _0x3841a7=await database_1[_0x980ba7(0x133)][_0x980ba7(0xa5)][_0x980ba7(0x149)]({'where':{'gatewayOrderId':_0x27b65e[_0x980ba7(0xfa)]}});if(!_0x3841a7){console[_0x980ba7(0xf5)](_0x980ba7(0x129)+_0x27b65e[_0x980ba7(0xfa)]);return;}console[_0x980ba7(0xbb)](_0x980ba7(0xa8)+_0x3841a7['id']+'\x20status\x20'+_0x27b65e['status']),await this[_0x980ba7(0xea)](_0x3841a7['id'],_0x27b65e[_0x980ba7(0xe3)],{'bankId':_0x27b65e[_0x980ba7(0x14d)]?.[_0x980ba7(0x150)],'remitterIban':_0x27b65e[_0x980ba7(0x14d)]?.[_0x980ba7(0xe5)],'remitterName':_0x27b65e[_0x980ba7(0x14d)]?.['remitterName']}),loggerService_1['loggerService']['logWebhookProcessed'](_0x980ba7(0x160),_0x3841a7['id'],_0x3841a7[_0x980ba7(0xe3)],_0x27b65e['status'],_0x398ff6);}catch(_0x164017){console['error'](_0x980ba7(0xcb),_0x164017),loggerService_1[_0x980ba7(0x161)][_0x980ba7(0x11d)](_0x980ba7(0x160),_0x164017,_0x398ff6);throw _0x164017;}}async[a58_0x335620(0x103)](_0x211141){const _0x23fd59=a58_0x335620;console[_0x23fd59(0xbb)](_0x23fd59(0xb2),_0x211141);try{const _0x5aac95=await this[_0x23fd59(0x131)][_0x23fd59(0x14c)](_0x211141);if(!_0x5aac95['paymentId'])throw new Error(_0x23fd59(0xbf));const _0x58d67b=await database_1[_0x23fd59(0x133)]['payment'][_0x23fd59(0x149)]({'where':{'gatewayOrderId':_0x5aac95[_0x23fd59(0xfa)]}});if(!_0x58d67b){console[_0x23fd59(0xf5)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x5aac95['paymentId']);return;}console[_0x23fd59(0xbb)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x58d67b['id']+_0x23fd59(0xfb)+_0x5aac95[_0x23fd59(0xe3)]),await this[_0x23fd59(0xea)](_0x58d67b['id'],_0x5aac95[_0x23fd59(0xe3)]),loggerService_1['loggerService'][_0x23fd59(0x119)](_0x23fd59(0x9a),_0x58d67b['id'],_0x58d67b['status'],_0x5aac95['status'],_0x211141);}catch(_0x17ed4c){console[_0x23fd59(0xf5)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x17ed4c),loggerService_1[_0x23fd59(0x161)][_0x23fd59(0x11d)](_0x23fd59(0x9a),_0x17ed4c,_0x211141);throw _0x17ed4c;}}async[a58_0x335620(0xc4)](_0x38ad7d){const _0x5c671a=a58_0x335620;console['log']('🔄\x20Processing\x20CoinToPay2\x20webhook:',_0x38ad7d);try{const _0x1ddacc=await this[_0x5c671a(0xf3)][_0x5c671a(0x14c)](_0x38ad7d);if(!_0x1ddacc[_0x5c671a(0xfa)])throw new Error(_0x5c671a(0xd7));const _0x4babca=await database_1[_0x5c671a(0x133)][_0x5c671a(0xa5)][_0x5c671a(0x149)]({'where':{'gatewayOrderId':_0x1ddacc[_0x5c671a(0xfa)]}});if(!_0x4babca){console['error']('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x1ddacc[_0x5c671a(0xfa)]);return;}console[_0x5c671a(0xbb)]('📊\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x4babca['id']+'\x20status\x20'+_0x1ddacc[_0x5c671a(0xe3)]),await this[_0x5c671a(0xea)](_0x4babca['id'],_0x1ddacc['status']),loggerService_1[_0x5c671a(0x161)][_0x5c671a(0x119)](_0x5c671a(0xae),_0x4babca['id'],_0x4babca['status'],_0x1ddacc[_0x5c671a(0xe3)],_0x38ad7d);}catch(_0x394997){console[_0x5c671a(0xf5)](_0x5c671a(0x13c),_0x394997),loggerService_1[_0x5c671a(0x161)][_0x5c671a(0x11d)]('cointopay2',_0x394997,_0x38ad7d);throw _0x394997;}}async[a58_0x335620(0xb8)](_0x3f1700){const _0x3f9b7e=a58_0x335620;console[_0x3f9b7e(0xbb)](_0x3f9b7e(0x127),_0x3f1700);try{const _0x20bef0=await this[_0x3f9b7e(0x145)][_0x3f9b7e(0x14c)](_0x3f1700);if(!_0x20bef0['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x161217=await database_1['default'][_0x3f9b7e(0xa5)][_0x3f9b7e(0x149)]({'where':{'gatewayOrderId':_0x20bef0[_0x3f9b7e(0xfa)]}});if(!_0x161217){console[_0x3f9b7e(0xf5)](_0x3f9b7e(0x10e)+_0x20bef0[_0x3f9b7e(0xfa)]);return;}console[_0x3f9b7e(0xbb)](_0x3f9b7e(0x153)+_0x161217['id']+_0x3f9b7e(0xfb)+_0x20bef0[_0x3f9b7e(0xe3)]),await this[_0x3f9b7e(0xea)](_0x161217['id'],_0x20bef0['status'],{'paymentMethod':_0x20bef0[_0x3f9b7e(0x14d)]?.[_0x3f9b7e(0xb0)]}),loggerService_1[_0x3f9b7e(0x161)][_0x3f9b7e(0x119)](_0x3f9b7e(0xda),_0x161217['id'],_0x161217['status'],_0x20bef0[_0x3f9b7e(0xe3)],_0x3f1700);}catch(_0x634f72){console[_0x3f9b7e(0xf5)](_0x3f9b7e(0xf6),_0x634f72),loggerService_1[_0x3f9b7e(0x161)]['logWebhookError'](_0x3f9b7e(0xda),_0x634f72,_0x3f1700);throw _0x634f72;}}async[a58_0x335620(0x114)](_0x10a315){const _0x405f6d=a58_0x335620;console[_0x405f6d(0xbb)](_0x405f6d(0x12b),JSON['stringify'](_0x10a315,null,0x2));try{const _0x58f0e9=await this[_0x405f6d(0xd9)][_0x405f6d(0x14c)](_0x10a315);console[_0x405f6d(0xbb)](_0x405f6d(0x15b),_0x58f0e9);if(!_0x58f0e9[_0x405f6d(0xfa)]){console[_0x405f6d(0xf5)](_0x405f6d(0xc2)),console[_0x405f6d(0xf5)](_0x405f6d(0x14b),Object[_0x405f6d(0x10c)](_0x10a315));throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');}let _0x3e6967=null;console['log'](_0x405f6d(0xcf)+_0x58f0e9[_0x405f6d(0xfa)]);_0x58f0e9['paymentId']&&(console[_0x405f6d(0xbb)](_0x405f6d(0x139)),_0x3e6967=await database_1[_0x405f6d(0x133)][_0x405f6d(0xa5)][_0x405f6d(0x149)]({'where':{'AND':[{'gateway':_0x405f6d(0x101)},{'OR':[{'gatewayPaymentId':_0x58f0e9['paymentId']},{'gatewayOrderId':_0x58f0e9[_0x405f6d(0xfa)]},{'id':_0x58f0e9['paymentId']},{'orderId':_0x58f0e9[_0x405f6d(0xfa)]}]}]}}),console['log'](_0x405f6d(0xa0)+(_0x3e6967?_0x405f6d(0x124)+_0x3e6967['id']:'Payment\x20not\x20found')));if(!_0x3e6967){console['error']('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x58f0e9['paymentId']),console[_0x405f6d(0xf5)](_0x405f6d(0x10a)+_0x58f0e9['paymentId']+_0x405f6d(0xd3)+_0x58f0e9[_0x405f6d(0xfa)]+'\x22,\x20orderId=\x22'+_0x58f0e9[_0x405f6d(0xfa)]+'\x22');const _0x36b9e6=await database_1['default'][_0x405f6d(0xa5)]['findMany']({'where':{'gateway':_0x405f6d(0x101)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x405f6d(0xbb)](_0x405f6d(0xeb),_0x36b9e6);return;}console[_0x405f6d(0xbb)](_0x405f6d(0x143)+_0x3e6967['id']+'\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20'+_0x3e6967[_0x405f6d(0xe3)]+'\x20to\x20'+_0x58f0e9[_0x405f6d(0xe3)]),await this[_0x405f6d(0xea)](_0x3e6967['id'],_0x58f0e9['status']),loggerService_1[_0x405f6d(0x161)][_0x405f6d(0x119)](_0x405f6d(0x101),_0x3e6967['id'],_0x3e6967[_0x405f6d(0xe3)],_0x58f0e9[_0x405f6d(0xe3)],_0x10a315);}catch(_0x1e45d8){console[_0x405f6d(0xf5)](_0x405f6d(0xac),_0x1e45d8),loggerService_1['loggerService'][_0x405f6d(0x11d)](_0x405f6d(0x101),_0x1e45d8,_0x10a315);throw _0x1e45d8;}}async[a58_0x335620(0x10b)](_0xe2ff3b,_0x5d235e){const _0x4dee02=a58_0x335620,_0x7c31ab=Date[_0x4dee02(0x137)]();try{const _0x29fcad=_0xe2ff3b[_0x4dee02(0x117)],_0x510e54=_0x29fcad[_0x4dee02(0xe9)];if(!_0x510e54?.[_0x4dee02(0x132)]){console[_0x4dee02(0xbb)](_0x4dee02(0x121)+_0x29fcad['id']);return;}const _0x5ba910=_0x5d235e==='PAID'?_0x4dee02(0x115):_0x5d235e===_0x4dee02(0x12f)?_0x4dee02(0x122):_0x5d235e===_0x4dee02(0x138)?_0x4dee02(0x122):_0x5d235e===_0x4dee02(0xd1)?_0x4dee02(0x122):_0x5d235e===_0x4dee02(0xf1)?'payment.failed':_0x4dee02(0xee);let _0x54f3b0=[];if(_0x510e54['webhookEvents'])try{_0x54f3b0=Array[_0x4dee02(0xc8)](_0x510e54[_0x4dee02(0xc3)])?_0x510e54[_0x4dee02(0xc3)]:JSON['parse'](_0x510e54[_0x4dee02(0xc3)]);}catch(_0x57e4fd){console[_0x4dee02(0xf5)](_0x4dee02(0x105),_0x57e4fd),_0x54f3b0=[];}if(!_0x54f3b0[_0x4dee02(0xb5)](_0x5ba910)){console[_0x4dee02(0xbb)](_0x4dee02(0xa6)+_0x5ba910+_0x4dee02(0x12d)+_0x29fcad['id']);return;}const _0xc0d059={'event':_0x5ba910,'payment':{'id':_0xe2ff3b['id'],'order_id':_0xe2ff3b[_0x4dee02(0xed)],'gateway_order_id':_0xe2ff3b['gatewayOrderId'],'gateway':_0xe2ff3b[_0x4dee02(0x116)],'amount':_0xe2ff3b[_0x4dee02(0x13f)],'currency':_0xe2ff3b['currency'],'status':_0x5d235e['toLowerCase'](),'customer_email':_0xe2ff3b[_0x4dee02(0xdd)],'customer_name':_0xe2ff3b[_0x4dee02(0xc0)],'failure_message':_0xe2ff3b[_0x4dee02(0xdb)],'tx_urls':_0xe2ff3b[_0x4dee02(0xce)]?JSON['parse'](_0xe2ff3b[_0x4dee02(0xce)]):null,'created_at':_0xe2ff3b[_0x4dee02(0x111)],'updated_at':_0xe2ff3b['updatedAt']}},_0x11c0a8=await fetch(_0x510e54['webhookUrl'],{'method':_0x4dee02(0xa1),'headers':{'Content-Type':_0x4dee02(0x140),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x4dee02(0xe6)](_0xc0d059)}),_0x196f93=Date['now']()-_0x7c31ab,_0x2f9c6d=_0x11c0a8['ok']?_0x4dee02(0x10d):await _0x11c0a8[_0x4dee02(0x118)]();loggerService_1['loggerService'][_0x4dee02(0xe4)](_0xe2ff3b[_0x4dee02(0x108)],_0x510e54[_0x4dee02(0x132)],_0x5ba910,_0x11c0a8[_0x4dee02(0xe3)],_0x196f93,_0xc0d059),console['log']('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x510e54[_0x4dee02(0x132)]+'\x20with\x20status\x20'+_0x11c0a8[_0x4dee02(0xe3)]+'\x20('+_0x196f93+_0x4dee02(0xd2));}catch(_0x446660){console['error'](_0x4dee02(0x157),_0x446660),loggerService_1[_0x4dee02(0x161)][_0x4dee02(0x104)](_0xe2ff3b['shopId'],_0xe2ff3b[_0x4dee02(0x117)]?.[_0x4dee02(0xe9)]?.[_0x4dee02(0x132)]||_0x4dee02(0xbd),'webhook_send',_0x446660,{});}}async[a58_0x335620(0xdc)](_0x22cf4e,_0x4f9fa0){const _0x252904=a58_0x335620;try{const _0x154152={'PENDING':_0x252904(0xc9),'PROCESSING':_0x252904(0xc7),'PAID':_0x252904(0xfe),'FAILED':_0x252904(0x14a),'EXPIRED':_0x252904(0x109),'REFUND':'refund','CHARGEBACK':_0x252904(0xf2)},_0x47fca8=_0x154152[_0x4f9fa0];if(!_0x47fca8||_0x47fca8==='created')return;await telegramBotService_1[_0x252904(0xc1)][_0x252904(0x15e)](_0x22cf4e[_0x252904(0x108)],_0x22cf4e,_0x47fca8);}catch(_0xef86a7){console[_0x252904(0xf5)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0xef86a7);}}}exports['WebhookService']=WebhookService;