'use strict';const a57_0x21d40e=a57_0x4bc1;function a57_0x4bc1(_0x28855d,_0x5a47cd){const _0x50c482=a57_0x50c4();return a57_0x4bc1=function(_0x4bc102,_0x56f6c1){_0x4bc102=_0x4bc102-0x14c;let _0x4f45ee=_0x50c482[_0x4bc102];return _0x4f45ee;},a57_0x4bc1(_0x28855d,_0x5a47cd);}function a57_0x50c4(){const _0xc24b63=['💸\x20Additional\x20chargeback\x20penalty:\x20-','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','convertToUSDT','update','webhookUrl','payment.pending','Error\x20processing\x20KLYME\x20webhook:','currencyService','amountUSDT','./gateways/rapydService','payment.failed','🏪\x20Shop\x20','paidAt','110DsOWVr','241816pRlhNe','KlymeService','🔄\x20Processing\x20Noda\x20webhook:','webhook_send','findFirst','../config/database','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','\x20not\x20found','cardLast4','Failed\x20to\x20send\x20shop\x20webhook:','💰\x20Final\x20balance\x20after\x20chargeback:\x20','\x20->\x20','sendPaymentStatusNotification','\x20status\x20to\x20','customerEmail','plisio_gateway','\x20with\x20status\x20','./gateways/klymeService','logShopWebhookError','1647IvJasj','customerName','./gateways/coinToPayService','processRapydWebhook','chargebackAmount','NodaService','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','gateway','created','processNodaWebhook','remitterName','default','includes','payment.success','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','refund','ms)','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','updatedAt','./gateways/mastercardService','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','stringify','telegramBotService','$transaction','logWebhookProcessed','11644nMZqQS','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','1045913YkbaSS','EXPIRED','\x20=\x20','paid','orderId','Error\x20processing\x20MasterCard\x20webhook:','WebhookService','toLowerCase','CoinToPayService','error','\x20USDT\x20(payment\x20became\x20PAID)','additionalInfo','🔄\x20Processing\x20CoinToPay\x20webhook:','./loggerService','now','loggerService','34952IrjIbn','toUpperCase','No\x20payment\x20ID\x20in\x20Noda\x20webhook','__esModule','balance','📊\x20Plisio\x20webhook:\x20Payment\x20','PAID','Error\x20processing\x20CoinToPay\x20webhook:','202902cgzafy','webhook_status_change_','./telegramBotService','klymeService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','./currencyService','logShopWebhookSent','shopId','\x20current\x20balance:\x20','\x20not\x20enabled\x20for\x20shop\x20','klyme','logWebhookError','🔄\x20Processing\x20Plisio\x20webhook:','processing','🔄\x20Processing\x20MasterCard\x20webhook:','plisio','toFixed','create','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','paymentId','noda','POST','./gateways/nodaService','failed','\x20balance\x20updated:\x20','27jCyMEJ','coinToPayService','txUrls','__importDefault','Success','processCoinToPayWebhook','plisioService','FAILED','REFUND','nodaService','Payment\x20not\x20found\x20for\x20MasterCard\x20webhook:\x20','sendShopWebhook','🔄\x20Updating\x20payment\x20','expired','createdAt','\x20USDT\x20(chargeback\x20penalty)','text','rapyd','failureMessage','📝\x20Reason:\x20','paymentMethod','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','📊\x20KLYME\x20webhook:\x20Payment\x20','amount','processPlisioGatewayWebhook','MasterCardService','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','8659756tEHkUR','📊\x20MasterCard\x20webhook:\x20Payment\x20','updatePaymentStatus','✅\x20Shop\x20','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','chargeback','1068965PjtRdZ','masterCardService','\x20status\x20','TesSoft\x20Payment\x20System/1.0','\x20and\x20-','application/json','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','findUnique','status','\x20USDT','🔄\x20Processing\x20KLYME\x20webhook:','PlisioService','12jEFAAU','rapydService','processWebhook','💰\x20Removing\x20from\x20balance:\x20','isArray','remitterIban','Payment\x20','\x20+\x20','payment','webhookEvents','username','Error\x20processing\x20Noda\x20webhook:','shop','unknown','mastercard','log','gatewayOrderId','cointopay','parse','currency'];a57_0x50c4=function(){return _0xc24b63;};return a57_0x50c4();}(function(_0x480da3,_0x42bada){const _0x31b0e9=a57_0x4bc1,_0x5da13d=_0x480da3();while(!![]){try{const _0xe49b49=parseInt(_0x31b0e9(0x173))/0x1+-parseInt(_0x31b0e9(0x1b9))/0x2+parseInt(_0x31b0e9(0x1d2))/0x3*(-parseInt(_0x31b0e9(0x19f))/0x4)+-parseInt(_0x31b0e9(0x1f3))/0x5*(parseInt(_0x31b0e9(0x151))/0x6)+parseInt(_0x31b0e9(0x1ed))/0x7+parseInt(_0x31b0e9(0x1b1))/0x8*(parseInt(_0x31b0e9(0x186))/0x9)+parseInt(_0x31b0e9(0x172))/0xa*(-parseInt(_0x31b0e9(0x1a1))/0xb);if(_0xe49b49===_0x42bada)break;else _0x5da13d['push'](_0x5da13d['shift']());}catch(_0x38cedc){_0x5da13d['push'](_0x5da13d['shift']());}}}(a57_0x50c4,0xa55b6));var __importDefault=this&&this[a57_0x21d40e(0x1d5)]||function(_0xcf30b3){const _0x1accde=a57_0x21d40e;return _0xcf30b3&&_0xcf30b3[_0x1accde(0x1b4)]?_0xcf30b3:{'default':_0xcf30b3};};Object['defineProperty'](exports,a57_0x21d40e(0x1b4),{'value':!![]}),exports[a57_0x21d40e(0x1a7)]=void 0x0;const database_1=__importDefault(require(a57_0x21d40e(0x178))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a57_0x21d40e(0x16e)),nodaService_1=require(a57_0x21d40e(0x1cf)),coinToPayService_1=require(a57_0x21d40e(0x188)),klymeService_1=require(a57_0x21d40e(0x184)),mastercardService_1=require(a57_0x21d40e(0x199)),telegramBotService_1=require(a57_0x21d40e(0x1bb)),currencyService_1=require(a57_0x21d40e(0x1be)),loggerService_1=require(a57_0x21d40e(0x1ae));class WebhookService{constructor(){const _0x3dfa3e=a57_0x21d40e;this[_0x3dfa3e(0x1d8)]=new plisioService_1[(_0x3dfa3e(0x150))](),this['rapydService']=new rapydService_1['RapydService'](),this['nodaService']=new nodaService_1[(_0x3dfa3e(0x18b))](),this[_0x3dfa3e(0x1d3)]=new coinToPayService_1[(_0x3dfa3e(0x1a9))](),this['klymeService']=new klymeService_1[(_0x3dfa3e(0x174))](),this[_0x3dfa3e(0x1f4)]=new mastercardService_1[(_0x3dfa3e(0x1eb))]();}async[a57_0x21d40e(0x1ef)](_0x1362f6,_0x98c188,_0x5bba57){const _0xf21c9a=a57_0x21d40e;console[_0xf21c9a(0x160)](_0xf21c9a(0x1de)+_0x1362f6+_0xf21c9a(0x180)+_0x98c188),await database_1['default'][_0xf21c9a(0x19d)](async _0x518864=>{const _0x3cbede=_0xf21c9a,_0x4380f1=await _0x518864[_0x3cbede(0x159)][_0x3cbede(0x14c)]({'where':{'id':_0x1362f6},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4380f1)throw new Error(_0x3cbede(0x157)+_0x1362f6+_0x3cbede(0x17a));const _0x49aa09=_0x4380f1[_0x3cbede(0x14d)],_0x684005=_0x4380f1['shop'];console[_0x3cbede(0x160)]('💰\x20Payment\x20'+_0x1362f6+':\x20'+_0x49aa09+_0x3cbede(0x17e)+_0x98c188),console[_0x3cbede(0x160)](_0x3cbede(0x170)+_0x684005[_0x3cbede(0x15b)]+_0x3cbede(0x1c1)+_0x684005[_0x3cbede(0x1b5)]+_0x3cbede(0x14e));const _0x124577={'status':_0x98c188[_0x3cbede(0x1b2)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x5bba57?.[_0x3cbede(0x1e4)]&&(_0x124577[_0x3cbede(0x1e4)]=_0x5bba57['failureMessage']);_0x5bba57?.[_0x3cbede(0x1d4)]&&(_0x124577[_0x3cbede(0x1d4)]=JSON[_0x3cbede(0x19b)](_0x5bba57[_0x3cbede(0x1d4)]));_0x5bba57?.[_0x3cbede(0x17b)]&&(_0x124577['cardLast4']=_0x5bba57['cardLast4']);_0x5bba57?.['paymentMethod']&&(_0x124577[_0x3cbede(0x1e6)]=_0x5bba57[_0x3cbede(0x1e6)]);_0x5bba57?.['bankId']&&(_0x124577['bankId']=_0x5bba57['bankId']);_0x5bba57?.[_0x3cbede(0x156)]&&(_0x124577[_0x3cbede(0x156)]=_0x5bba57[_0x3cbede(0x156)]);_0x5bba57?.[_0x3cbede(0x190)]&&(_0x124577['remitterName']=_0x5bba57[_0x3cbede(0x190)]);let _0x4e252e=_0x684005[_0x3cbede(0x1b5)],_0x43e009='';if(_0x98c188[_0x3cbede(0x1b2)]()==='PAID'&&_0x49aa09!==_0x3cbede(0x1b7)){const _0x4ff18c=await currencyService_1[_0x3cbede(0x16c)][_0x3cbede(0x167)](_0x4380f1[_0x3cbede(0x1e9)],_0x4380f1[_0x3cbede(0x164)]);_0x4e252e+=_0x4ff18c,_0x43e009='+'+_0x4ff18c[_0x3cbede(0x1c9)](0x6)+_0x3cbede(0x1ab),_0x124577[_0x3cbede(0x16d)]=_0x4ff18c,_0x124577[_0x3cbede(0x171)]=new Date(),console['log']('💰\x20Converting\x20'+_0x4380f1[_0x3cbede(0x1e9)]+'\x20'+_0x4380f1['currency']+'\x20->\x20'+_0x4ff18c[_0x3cbede(0x1c9)](0x6)+'\x20USDT'),console['log']('💰\x20Adding\x20to\x20balance:\x20'+_0x684005[_0x3cbede(0x1b5)]+_0x3cbede(0x158)+_0x4ff18c['toFixed'](0x6)+_0x3cbede(0x1a3)+_0x4e252e[_0x3cbede(0x1c9)](0x6)+_0x3cbede(0x14e));}else{if(_0x49aa09===_0x3cbede(0x1b7)&&_0x98c188[_0x3cbede(0x1b2)]()!=='PAID'){const _0x452a19=_0x4380f1[_0x3cbede(0x16d)];_0x452a19&&(_0x4e252e-=_0x452a19,_0x43e009='-'+_0x452a19[_0x3cbede(0x1c9)](0x6)+_0x3cbede(0x1f1),_0x124577[_0x3cbede(0x16d)]=null,_0x124577[_0x3cbede(0x171)]=null,console[_0x3cbede(0x160)](_0x3cbede(0x154)+_0x684005[_0x3cbede(0x1b5)]+'\x20-\x20'+_0x452a19[_0x3cbede(0x1c9)](0x6)+_0x3cbede(0x1a3)+_0x4e252e[_0x3cbede(0x1c9)](0x6)+_0x3cbede(0x14e)));}}if(_0x98c188[_0x3cbede(0x1b2)]()==='CHARGEBACK'){const _0x1060af=_0x5bba57?.[_0x3cbede(0x18a)]||0x0;_0x1060af>0x0&&(_0x4e252e-=_0x1060af,_0x43e009+=_0x3cbede(0x1f7)+_0x1060af['toFixed'](0x6)+_0x3cbede(0x1e1),_0x124577[_0x3cbede(0x18a)]=_0x1060af,console['log'](_0x3cbede(0x165)+_0x1060af[_0x3cbede(0x1c9)](0x6)+_0x3cbede(0x14e)),console[_0x3cbede(0x160)](_0x3cbede(0x17d)+_0x4e252e['toFixed'](0x6)+'\x20USDT'));}const _0x5b94d5=await _0x518864['payment']['update']({'where':{'id':_0x1362f6},'data':_0x124577});_0x4e252e!==_0x684005[_0x3cbede(0x1b5)]&&(await _0x518864[_0x3cbede(0x15d)][_0x3cbede(0x168)]({'where':{'id':_0x684005['id']},'data':{'balance':_0x4e252e}}),console[_0x3cbede(0x160)](_0x3cbede(0x1f0)+_0x684005[_0x3cbede(0x15b)]+_0x3cbede(0x1d1)+_0x684005['balance'][_0x3cbede(0x1c9)](0x6)+'\x20->\x20'+_0x4e252e[_0x3cbede(0x1c9)](0x6)+_0x3cbede(0x14e)),console[_0x3cbede(0x160)](_0x3cbede(0x1e5)+_0x43e009)),await _0x518864['webhookLog'][_0x3cbede(0x1ca)]({'data':{'paymentId':_0x1362f6,'shopId':_0x684005['id'],'event':_0x3cbede(0x1ba)+_0x98c188[_0x3cbede(0x1a8)](),'statusCode':0xc8,'responseBody':JSON[_0x3cbede(0x19b)]({'oldStatus':_0x49aa09,'newStatus':_0x98c188['toUpperCase'](),'balanceChange':_0x43e009||'no\x20balance\x20change','oldBalance':_0x684005[_0x3cbede(0x1b5)],'newBalance':_0x4e252e,'amountUSDT':_0x124577[_0x3cbede(0x16d)],'additionalData':_0x5bba57,'timestamp':new Date()['toISOString']()})}}),await this[_0x3cbede(0x1dd)]({..._0x4380f1,..._0x5b94d5,'shop':_0x684005},_0x98c188[_0x3cbede(0x1b2)]()),await this[_0x3cbede(0x17f)]({..._0x4380f1,..._0x5b94d5},_0x98c188[_0x3cbede(0x1b2)]());});}async['processPlisioWebhook'](_0x568dc8){const _0xe658bf=a57_0x21d40e;console[_0xe658bf(0x160)](_0xe658bf(0x1c5),_0x568dc8);try{const _0x7075f0=await this['plisioService'][_0xe658bf(0x153)](_0x568dc8);if(!_0x7075f0[_0xe658bf(0x1cc)])throw new Error(_0xe658bf(0x197));const _0xdb02a9=await database_1['default'][_0xe658bf(0x159)][_0xe658bf(0x177)]({'where':{'gatewayOrderId':_0x7075f0[_0xe658bf(0x1cc)]}});if(!_0xdb02a9){console[_0xe658bf(0x1aa)]('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x7075f0['paymentId']);return;}console[_0xe658bf(0x160)](_0xe658bf(0x1b6)+_0xdb02a9['id']+'\x20status\x20'+_0x7075f0[_0xe658bf(0x14d)]),await this[_0xe658bf(0x1ef)](_0xdb02a9['id'],_0x7075f0[_0xe658bf(0x14d)],{'txUrls':_0x7075f0[_0xe658bf(0x1d4)]}),loggerService_1['loggerService'][_0xe658bf(0x19e)](_0xe658bf(0x1c8),_0xdb02a9['id'],_0xdb02a9[_0xe658bf(0x14d)],_0x7075f0[_0xe658bf(0x14d)],_0x568dc8);}catch(_0x5a1bd7){console['error']('Error\x20processing\x20Plisio\x20webhook:',_0x5a1bd7),loggerService_1[_0xe658bf(0x1b0)][_0xe658bf(0x1c4)](_0xe658bf(0x1c8),_0x5a1bd7,_0x568dc8);throw _0x5a1bd7;}}async[a57_0x21d40e(0x1ea)](_0x25838f){const _0x294266=a57_0x21d40e;console[_0x294266(0x160)](_0x294266(0x19a),_0x25838f);try{const _0x1ee66b=await this[_0x294266(0x1d8)][_0x294266(0x153)](_0x25838f);if(!_0x1ee66b['paymentId'])throw new Error(_0x294266(0x18c));const _0x434f18=await database_1[_0x294266(0x191)][_0x294266(0x159)][_0x294266(0x177)]({'where':{'gatewayOrderId':_0x1ee66b['paymentId']}});if(!_0x434f18){console['error'](_0x294266(0x1ec)+_0x1ee66b['paymentId']);return;}console[_0x294266(0x160)]('📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20'+_0x434f18['id']+_0x294266(0x1f5)+_0x1ee66b['status']),await this['updatePaymentStatus'](_0x434f18['id'],_0x1ee66b[_0x294266(0x14d)],{'txUrls':_0x1ee66b['txUrls']}),loggerService_1[_0x294266(0x1b0)]['logWebhookProcessed']('plisio_gateway',_0x434f18['id'],_0x434f18['status'],_0x1ee66b[_0x294266(0x14d)],_0x25838f);}catch(_0x46cc8f){console['error'](_0x294266(0x194),_0x46cc8f),loggerService_1[_0x294266(0x1b0)][_0x294266(0x1c4)](_0x294266(0x182),_0x46cc8f,_0x25838f);throw _0x46cc8f;}}async[a57_0x21d40e(0x189)](_0x6908bf){const _0x5e864f=a57_0x21d40e;console[_0x5e864f(0x160)]('🔄\x20Processing\x20Rapyd\x20webhook:',_0x6908bf);try{const _0x20976a=await this[_0x5e864f(0x152)][_0x5e864f(0x153)](_0x6908bf);if(!_0x20976a['paymentId'])throw new Error(_0x5e864f(0x1f9));const _0x4eb4c7=await database_1[_0x5e864f(0x191)][_0x5e864f(0x159)]['findFirst']({'where':{'gatewayOrderId':_0x20976a[_0x5e864f(0x1cc)]}});if(!_0x4eb4c7){console[_0x5e864f(0x1aa)](_0x5e864f(0x1a0)+_0x20976a[_0x5e864f(0x1cc)]);return;}console[_0x5e864f(0x160)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x4eb4c7['id']+_0x5e864f(0x1f5)+_0x20976a[_0x5e864f(0x14d)]),await this[_0x5e864f(0x1ef)](_0x4eb4c7['id'],_0x20976a[_0x5e864f(0x14d)],{'failureMessage':_0x20976a['failureMessage'],'cardLast4':_0x20976a[_0x5e864f(0x1ac)]?.[_0x5e864f(0x17b)],'paymentMethod':_0x20976a[_0x5e864f(0x1ac)]?.[_0x5e864f(0x1e6)]}),loggerService_1[_0x5e864f(0x1b0)][_0x5e864f(0x19e)]('rapyd',_0x4eb4c7['id'],_0x4eb4c7[_0x5e864f(0x14d)],_0x20976a['status'],_0x6908bf);}catch(_0x4263e3){console[_0x5e864f(0x1aa)]('Error\x20processing\x20Rapyd\x20webhook:',_0x4263e3),loggerService_1[_0x5e864f(0x1b0)]['logWebhookError'](_0x5e864f(0x1e3),_0x4263e3,_0x6908bf);throw _0x4263e3;}}async[a57_0x21d40e(0x18f)](_0x66f787){const _0x14b628=a57_0x21d40e;console[_0x14b628(0x160)](_0x14b628(0x175),_0x66f787);try{const _0x5958a6=await this[_0x14b628(0x1db)][_0x14b628(0x153)](_0x66f787);if(!_0x5958a6['paymentId'])throw new Error(_0x14b628(0x1b3));const _0x72458f=await database_1['default'][_0x14b628(0x159)][_0x14b628(0x177)]({'where':{'gatewayOrderId':_0x5958a6[_0x14b628(0x1cc)]}});if(!_0x72458f){console[_0x14b628(0x1aa)]('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x5958a6[_0x14b628(0x1cc)]);return;}console[_0x14b628(0x160)]('📊\x20Noda\x20webhook:\x20Payment\x20'+_0x72458f['id']+_0x14b628(0x1f5)+_0x5958a6[_0x14b628(0x14d)]),await this[_0x14b628(0x1ef)](_0x72458f['id'],_0x5958a6['status'],{'bankId':_0x5958a6[_0x14b628(0x1ac)]?.['bankId'],'remitterIban':_0x5958a6[_0x14b628(0x1ac)]?.[_0x14b628(0x156)],'remitterName':_0x5958a6[_0x14b628(0x1ac)]?.['remitterName']}),loggerService_1['loggerService']['logWebhookProcessed'](_0x14b628(0x1cd),_0x72458f['id'],_0x72458f[_0x14b628(0x14d)],_0x5958a6[_0x14b628(0x14d)],_0x66f787);}catch(_0x136ee6){console[_0x14b628(0x1aa)](_0x14b628(0x15c),_0x136ee6),loggerService_1[_0x14b628(0x1b0)]['logWebhookError'](_0x14b628(0x1cd),_0x136ee6,_0x66f787);throw _0x136ee6;}}async[a57_0x21d40e(0x1d7)](_0x2af3c6){const _0x239d0e=a57_0x21d40e;console[_0x239d0e(0x160)](_0x239d0e(0x1ad),_0x2af3c6);try{const _0x481e77=await this['coinToPayService'][_0x239d0e(0x153)](_0x2af3c6);if(!_0x481e77[_0x239d0e(0x1cc)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x4a34ae=await database_1['default']['payment'][_0x239d0e(0x177)]({'where':{'gatewayOrderId':_0x481e77[_0x239d0e(0x1cc)]}});if(!_0x4a34ae){console['error'](_0x239d0e(0x179)+_0x481e77['paymentId']);return;}console[_0x239d0e(0x160)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x4a34ae['id']+_0x239d0e(0x1f5)+_0x481e77['status']),await this[_0x239d0e(0x1ef)](_0x4a34ae['id'],_0x481e77[_0x239d0e(0x14d)]),loggerService_1['loggerService'][_0x239d0e(0x19e)]('cointopay',_0x4a34ae['id'],_0x4a34ae['status'],_0x481e77['status'],_0x2af3c6);}catch(_0x12c5f8){console['error'](_0x239d0e(0x1b8),_0x12c5f8),loggerService_1[_0x239d0e(0x1b0)][_0x239d0e(0x1c4)](_0x239d0e(0x162),_0x12c5f8,_0x2af3c6);throw _0x12c5f8;}}async['processKlymeWebhook'](_0x10a972){const _0x15813f=a57_0x21d40e;console['log'](_0x15813f(0x14f),_0x10a972);try{const _0x5327ce=await this[_0x15813f(0x1bc)][_0x15813f(0x153)](_0x10a972);if(!_0x5327ce['paymentId'])throw new Error(_0x15813f(0x1e7));const _0x528e74=await database_1[_0x15813f(0x191)][_0x15813f(0x159)]['findFirst']({'where':{'gatewayOrderId':_0x5327ce[_0x15813f(0x1cc)]}});if(!_0x528e74){console[_0x15813f(0x1aa)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x5327ce[_0x15813f(0x1cc)]);return;}console['log'](_0x15813f(0x1e8)+_0x528e74['id']+'\x20status\x20'+_0x5327ce[_0x15813f(0x14d)]),await this['updatePaymentStatus'](_0x528e74['id'],_0x5327ce['status'],{'paymentMethod':_0x5327ce[_0x15813f(0x1ac)]?.['payment_method']}),loggerService_1[_0x15813f(0x1b0)][_0x15813f(0x19e)](_0x15813f(0x1c3),_0x528e74['id'],_0x528e74[_0x15813f(0x14d)],_0x5327ce[_0x15813f(0x14d)],_0x10a972);}catch(_0x514f31){console[_0x15813f(0x1aa)](_0x15813f(0x16b),_0x514f31),loggerService_1[_0x15813f(0x1b0)][_0x15813f(0x1c4)](_0x15813f(0x1c3),_0x514f31,_0x10a972);throw _0x514f31;}}async['processMasterCardWebhook'](_0x2785ce){const _0x4a3d1b=a57_0x21d40e;console[_0x4a3d1b(0x160)](_0x4a3d1b(0x1c7),_0x2785ce);try{const _0x506453=await this[_0x4a3d1b(0x1f4)][_0x4a3d1b(0x153)](_0x2785ce);if(!_0x506453['paymentId'])throw new Error(_0x4a3d1b(0x1cb));const _0x357e17=await database_1[_0x4a3d1b(0x191)][_0x4a3d1b(0x159)][_0x4a3d1b(0x177)]({'where':{'gatewayOrderId':_0x506453[_0x4a3d1b(0x1cc)]}});if(!_0x357e17){console[_0x4a3d1b(0x1aa)](_0x4a3d1b(0x1dc)+_0x506453['paymentId']);return;}console[_0x4a3d1b(0x160)](_0x4a3d1b(0x1ee)+_0x357e17['id']+'\x20status\x20'+_0x506453['status']),await this[_0x4a3d1b(0x1ef)](_0x357e17['id'],_0x506453[_0x4a3d1b(0x14d)]),loggerService_1['loggerService']['logWebhookProcessed'](_0x4a3d1b(0x15f),_0x357e17['id'],_0x357e17['status'],_0x506453['status'],_0x2785ce);}catch(_0x1d3709){console['error'](_0x4a3d1b(0x1a6),_0x1d3709),loggerService_1[_0x4a3d1b(0x1b0)]['logWebhookError']('mastercard',_0x1d3709,_0x2785ce);throw _0x1d3709;}}async[a57_0x21d40e(0x1dd)](_0x109cc5,_0x534962){const _0x48d611=a57_0x21d40e,_0x4c598=Date['now']();try{const _0x4affd9=_0x109cc5[_0x48d611(0x15d)],_0x216956=_0x4affd9['settings'];if(!_0x216956?.[_0x48d611(0x169)]){console[_0x48d611(0x160)](_0x48d611(0x1bd)+_0x4affd9['id']);return;}const _0x42c0e1=_0x534962===_0x48d611(0x1b7)?_0x48d611(0x193):_0x534962===_0x48d611(0x1d9)?_0x48d611(0x16f):_0x534962===_0x48d611(0x1a2)?'payment.failed':_0x534962==='CHARGEBACK'?'payment.failed':_0x534962===_0x48d611(0x1da)?'payment.failed':_0x48d611(0x16a);let _0x2a4dd5=[];if(_0x216956[_0x48d611(0x15a)])try{_0x2a4dd5=Array[_0x48d611(0x155)](_0x216956[_0x48d611(0x15a)])?_0x216956['webhookEvents']:JSON[_0x48d611(0x163)](_0x216956[_0x48d611(0x15a)]);}catch(_0x55d133){console[_0x48d611(0x1aa)]('Error\x20parsing\x20webhook\x20events:',_0x55d133),_0x2a4dd5=[];}if(!_0x2a4dd5[_0x48d611(0x192)](_0x42c0e1)){console[_0x48d611(0x160)]('Webhook\x20event\x20'+_0x42c0e1+_0x48d611(0x1c2)+_0x4affd9['id']);return;}const _0x4ae2a7={'event':_0x42c0e1,'payment':{'id':_0x109cc5['id'],'order_id':_0x109cc5[_0x48d611(0x1a5)],'gateway_order_id':_0x109cc5[_0x48d611(0x161)],'gateway':_0x109cc5[_0x48d611(0x18d)],'amount':_0x109cc5[_0x48d611(0x1e9)],'currency':_0x109cc5[_0x48d611(0x164)],'status':_0x534962[_0x48d611(0x1a8)](),'customer_email':_0x109cc5[_0x48d611(0x181)],'customer_name':_0x109cc5[_0x48d611(0x187)],'failure_message':_0x109cc5['failureMessage'],'tx_urls':_0x109cc5[_0x48d611(0x1d4)]?JSON[_0x48d611(0x163)](_0x109cc5[_0x48d611(0x1d4)]):null,'created_at':_0x109cc5[_0x48d611(0x1e0)],'updated_at':_0x109cc5[_0x48d611(0x198)]}},_0x4402ef=await fetch(_0x216956[_0x48d611(0x169)],{'method':_0x48d611(0x1ce),'headers':{'Content-Type':_0x48d611(0x1f8),'User-Agent':_0x48d611(0x1f6)},'body':JSON['stringify'](_0x4ae2a7)}),_0x5614a3=Date[_0x48d611(0x1af)]()-_0x4c598,_0x35b3da=_0x4402ef['ok']?_0x48d611(0x1d6):await _0x4402ef[_0x48d611(0x1e2)]();loggerService_1[_0x48d611(0x1b0)][_0x48d611(0x1bf)](_0x109cc5['shopId'],_0x216956[_0x48d611(0x169)],_0x42c0e1,_0x4402ef[_0x48d611(0x14d)],_0x5614a3,_0x4ae2a7),console[_0x48d611(0x160)]('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x216956[_0x48d611(0x169)]+_0x48d611(0x183)+_0x4402ef[_0x48d611(0x14d)]+'\x20('+_0x5614a3+_0x48d611(0x196));}catch(_0x17cfe0){console[_0x48d611(0x1aa)](_0x48d611(0x17c),_0x17cfe0),loggerService_1['loggerService'][_0x48d611(0x185)](_0x109cc5['shopId'],_0x109cc5[_0x48d611(0x15d)]?.['settings']?.[_0x48d611(0x169)]||_0x48d611(0x15e),_0x48d611(0x176),_0x17cfe0,{});}}async['sendPaymentStatusNotification'](_0x11db92,_0x5af2c3){const _0x22a8bf=a57_0x21d40e;try{const _0x389bdf={'PENDING':_0x22a8bf(0x18e),'PROCESSING':_0x22a8bf(0x1c6),'PAID':_0x22a8bf(0x1a4),'FAILED':_0x22a8bf(0x1d0),'EXPIRED':_0x22a8bf(0x1df),'REFUND':_0x22a8bf(0x195),'CHARGEBACK':_0x22a8bf(0x1f2)},_0x30e630=_0x389bdf[_0x5af2c3];if(!_0x30e630||_0x30e630===_0x22a8bf(0x18e))return;await telegramBotService_1[_0x22a8bf(0x19c)]['sendPaymentNotification'](_0x11db92[_0x22a8bf(0x1c0)],_0x11db92,_0x30e630);}catch(_0x2b4d51){console['error'](_0x22a8bf(0x166),_0x2b4d51);}}}exports['WebhookService']=WebhookService;