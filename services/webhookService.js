'use strict';const a57_0x3627a3=a57_0x5f5b;(function(_0x521bc4,_0x2a3253){const _0x3baf4b=a57_0x5f5b,_0x580ec1=_0x521bc4();while(!![]){try{const _0x21fb5f=-parseInt(_0x3baf4b(0x241))/0x1+-parseInt(_0x3baf4b(0x1a4))/0x2+-parseInt(_0x3baf4b(0x1c7))/0x3*(parseInt(_0x3baf4b(0x1fc))/0x4)+parseInt(_0x3baf4b(0x201))/0x5+-parseInt(_0x3baf4b(0x1ed))/0x6+parseInt(_0x3baf4b(0x1d4))/0x7*(-parseInt(_0x3baf4b(0x1f4))/0x8)+parseInt(_0x3baf4b(0x1af))/0x9*(parseInt(_0x3baf4b(0x1d5))/0xa);if(_0x21fb5f===_0x2a3253)break;else _0x580ec1['push'](_0x580ec1['shift']());}catch(_0x2a1eed){_0x580ec1['push'](_0x580ec1['shift']());}}}(a57_0x208a,0x566f2));function a57_0x208a(){const _0x2c6461=['processRapydWebhook','🏪\x20Shop\x20','Error\x20processing\x20Noda\x20webhook:','Payment\x20not\x20found\x20for\x20MasterCard\x20webhook:\x20','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','CHARGEBACK','\x20USDT','loggerService','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','✅\x20Shop\x20','processWebhook','🔄\x20Processing\x20Noda\x20webhook:','includes','paymentMethod','💰\x20Converting\x20','sendShopWebhook','remitterIban','webhookLog','convertToUSDT','logWebhookProcessed','📊\x20CoinToPay\x20webhook:\x20Payment\x20','KlymeService','rapydService','bankId','sendPaymentStatusNotification','coinToPayService','📊\x20MasterCard\x20webhook:\x20Payment\x20','💰\x20Adding\x20to\x20balance:\x20','balance','$transaction','💰\x20Final\x20balance\x20after\x20chargeback:\x20','currency','sendPaymentNotification','created','processPlisioGatewayWebhook','log','📊\x20KLYME\x20webhook:\x20Payment\x20','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','Success','478711SPLwbi','📊\x20Rapyd\x20webhook:\x20Payment\x20','chargebackAmount','./gateways/coinToPayService','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','📝\x20Reason:\x20','currencyService','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','🔄\x20Processing\x20Plisio\x20webhook:','processKlymeWebhook','./gateways/plisioService','payment.pending','Error\x20processing\x20Plisio\x20webhook:','payment','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','1402002McyKtd','processPlisioWebhook','stringify','toISOString','toUpperCase','plisio_gateway','payment.success','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','EXPIRED','./gateways/rapydService','./currencyService','36IcBZgy','payment.failed','amountUSDT','Failed\x20to\x20send\x20shop\x20webhook:','refund','text','expired','noda','webhook_send','POST','failureMessage','findUnique','updatePaymentStatus','defineProperty','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','💰\x20Removing\x20from\x20balance:\x20','parse','update','🔄\x20Processing\x20MasterCard\x20webhook:','masterCardService','toLowerCase','💰\x20Payment\x20','webhookEvents','\x20and\x20-','3bDVHJF','webhookUrl','findFirst','plisioService','txUrls','shopId','NodaService','📊\x20Plisio\x20webhook:\x20Payment\x20','shop','PAID','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','🔄\x20Processing\x20KLYME\x20webhook:','payment_method','541912TKbODY','3770510ZETTzF','mastercard','settings','failed','CoinToPayService','RapydService','processing','error','\x20status\x20','updatedAt','createdAt','toFixed','\x20with\x20status\x20','rapyd','paidAt','\x20->\x20','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','klymeService','__importDefault','isArray','./telegramBotService','\x20not\x20enabled\x20for\x20shop\x20','paymentId','667962wBpmDG','Error\x20processing\x20MasterCard\x20webhook:','FAILED','processCoinToPayWebhook','username','🔄\x20Updating\x20payment\x20','../config/database','16sWmIdQ','remitterName','klyme','default','MasterCardService','cardLast4','__esModule','\x20not\x20found','138724UoLNRj','Error\x20processing\x20Rapyd\x20webhook:','processMasterCardWebhook','logWebhookError','system','1631910YqSUwW','Error\x20processing\x20CoinToPay\x20webhook:','amount','\x20status\x20to\x20','customerEmail','plisio','orderId','\x20current\x20balance:\x20','./gateways/nodaService','additionalInfo','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','status','WebhookService','Webhook\x20event\x20','REFUND','application/json','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook','PlisioService','🔄\x20Processing\x20Rapyd\x20webhook:','unknown','\x20USDT\x20(payment\x20became\x20PAID)','Payment\x20','cointopay'];a57_0x208a=function(){return _0x2c6461;};return a57_0x208a();}function a57_0x5f5b(_0x5d1c12,_0x3f1ea1){const _0x208ad1=a57_0x208a();return a57_0x5f5b=function(_0x5f5b1e,_0x899e92){_0x5f5b1e=_0x5f5b1e-0x196;let _0xb49e9c=_0x208ad1[_0x5f5b1e];return _0xb49e9c;},a57_0x5f5b(_0x5d1c12,_0x3f1ea1);}var __importDefault=this&&this[a57_0x3627a3(0x1e8)]||function(_0x2fee9c){const _0x539d4a=a57_0x3627a3;return _0x2fee9c&&_0x2fee9c[_0x539d4a(0x1fa)]?_0x2fee9c:{'default':_0x2fee9c};};Object[a57_0x3627a3(0x1bc)](exports,a57_0x3627a3(0x1fa),{'value':!![]}),exports[a57_0x3627a3(0x20d)]=void 0x0;const database_1=__importDefault(require(a57_0x3627a3(0x1f3))),plisioService_1=require(a57_0x3627a3(0x19f)),rapydService_1=require(a57_0x3627a3(0x1ad)),nodaService_1=require(a57_0x3627a3(0x209)),coinToPayService_1=require(a57_0x3627a3(0x198)),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require('./gateways/mastercardService'),telegramBotService_1=require(a57_0x3627a3(0x1ea)),currencyService_1=require(a57_0x3627a3(0x1ae)),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x2d4d8e=a57_0x3627a3;this[_0x2d4d8e(0x1ca)]=new plisioService_1[(_0x2d4d8e(0x213))](),this[_0x2d4d8e(0x22f)]=new rapydService_1[(_0x2d4d8e(0x1da))](),this['nodaService']=new nodaService_1[(_0x2d4d8e(0x1cd))](),this[_0x2d4d8e(0x232)]=new coinToPayService_1[(_0x2d4d8e(0x1d9))](),this[_0x2d4d8e(0x1e7)]=new klymeService_1[(_0x2d4d8e(0x22e))](),this[_0x2d4d8e(0x1c2)]=new mastercardService_1[(_0x2d4d8e(0x1f8))]();}async[a57_0x3627a3(0x1bb)](_0x1daa8c,_0x179994,_0x1af437){const _0x4a1b60=a57_0x3627a3;console['log'](_0x4a1b60(0x1f2)+_0x1daa8c+_0x4a1b60(0x204)+_0x179994),await database_1[_0x4a1b60(0x1f7)][_0x4a1b60(0x236)](async _0x476207=>{const _0x16b3c3=_0x4a1b60,_0x39638d=await _0x476207[_0x16b3c3(0x1a2)][_0x16b3c3(0x1ba)]({'where':{'id':_0x1daa8c},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x39638d)throw new Error(_0x16b3c3(0x217)+_0x1daa8c+_0x16b3c3(0x1fb));const _0x76a263=_0x39638d[_0x16b3c3(0x20c)],_0x8e9f7d=_0x39638d[_0x16b3c3(0x1cf)];console[_0x16b3c3(0x23c)](_0x16b3c3(0x1c4)+_0x1daa8c+':\x20'+_0x76a263+'\x20->\x20'+_0x179994),console[_0x16b3c3(0x23c)](_0x16b3c3(0x21a)+_0x8e9f7d[_0x16b3c3(0x1f1)]+_0x16b3c3(0x208)+_0x8e9f7d[_0x16b3c3(0x235)]+_0x16b3c3(0x21f));const _0x4cc95c={'status':_0x179994[_0x16b3c3(0x1a8)](),'updatedAt':new Date(),'statusChangedBy':_0x16b3c3(0x200),'statusChangedAt':new Date()};_0x1af437?.[_0x16b3c3(0x1b9)]&&(_0x4cc95c[_0x16b3c3(0x1b9)]=_0x1af437['failureMessage']);_0x1af437?.['txUrls']&&(_0x4cc95c[_0x16b3c3(0x1cb)]=JSON[_0x16b3c3(0x1a6)](_0x1af437['txUrls']));_0x1af437?.[_0x16b3c3(0x1f9)]&&(_0x4cc95c[_0x16b3c3(0x1f9)]=_0x1af437[_0x16b3c3(0x1f9)]);_0x1af437?.[_0x16b3c3(0x226)]&&(_0x4cc95c[_0x16b3c3(0x226)]=_0x1af437['paymentMethod']);_0x1af437?.[_0x16b3c3(0x230)]&&(_0x4cc95c[_0x16b3c3(0x230)]=_0x1af437[_0x16b3c3(0x230)]);_0x1af437?.[_0x16b3c3(0x229)]&&(_0x4cc95c[_0x16b3c3(0x229)]=_0x1af437['remitterIban']);_0x1af437?.[_0x16b3c3(0x1f5)]&&(_0x4cc95c[_0x16b3c3(0x1f5)]=_0x1af437[_0x16b3c3(0x1f5)]);let _0xb2de85=_0x8e9f7d[_0x16b3c3(0x235)],_0xce7386='';if(_0x179994[_0x16b3c3(0x1a8)]()===_0x16b3c3(0x1d0)&&_0x76a263!==_0x16b3c3(0x1d0)){const _0x3c1d97=await currencyService_1[_0x16b3c3(0x19b)][_0x16b3c3(0x22b)](_0x39638d[_0x16b3c3(0x203)],_0x39638d[_0x16b3c3(0x238)]);_0xb2de85+=_0x3c1d97,_0xce7386='+'+_0x3c1d97[_0x16b3c3(0x1e0)](0x6)+_0x16b3c3(0x216),_0x4cc95c[_0x16b3c3(0x1b1)]=_0x3c1d97,_0x4cc95c['paidAt']=new Date(),console[_0x16b3c3(0x23c)](_0x16b3c3(0x227)+_0x39638d['amount']+'\x20'+_0x39638d['currency']+'\x20->\x20'+_0x3c1d97[_0x16b3c3(0x1e0)](0x6)+_0x16b3c3(0x21f)),console[_0x16b3c3(0x23c)](_0x16b3c3(0x234)+_0x8e9f7d[_0x16b3c3(0x235)]+'\x20+\x20'+_0x3c1d97[_0x16b3c3(0x1e0)](0x6)+'\x20=\x20'+_0xb2de85[_0x16b3c3(0x1e0)](0x6)+'\x20USDT');}else{if(_0x76a263===_0x16b3c3(0x1d0)&&_0x179994[_0x16b3c3(0x1a8)]()!==_0x16b3c3(0x1d0)){const _0x11a869=_0x39638d['amountUSDT'];_0x11a869&&(_0xb2de85-=_0x11a869,_0xce7386='-'+_0x11a869['toFixed'](0x6)+_0x16b3c3(0x1d1),_0x4cc95c[_0x16b3c3(0x1b1)]=null,_0x4cc95c[_0x16b3c3(0x1e3)]=null,console[_0x16b3c3(0x23c)](_0x16b3c3(0x1be)+_0x8e9f7d['balance']+'\x20-\x20'+_0x11a869[_0x16b3c3(0x1e0)](0x6)+'\x20=\x20'+_0xb2de85[_0x16b3c3(0x1e0)](0x6)+'\x20USDT'));}}if(_0x179994[_0x16b3c3(0x1a8)]()===_0x16b3c3(0x21e)){const _0xfaa14d=_0x1af437?.[_0x16b3c3(0x197)]||0x0;_0xfaa14d>0x0&&(_0xb2de85-=_0xfaa14d,_0xce7386+=_0x16b3c3(0x1c6)+_0xfaa14d['toFixed'](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0x4cc95c[_0x16b3c3(0x197)]=_0xfaa14d,console['log']('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0xfaa14d['toFixed'](0x6)+_0x16b3c3(0x21f)),console[_0x16b3c3(0x23c)](_0x16b3c3(0x237)+_0xb2de85[_0x16b3c3(0x1e0)](0x6)+_0x16b3c3(0x21f)));}const _0x522db9=await _0x476207[_0x16b3c3(0x1a2)]['update']({'where':{'id':_0x1daa8c},'data':_0x4cc95c});_0xb2de85!==_0x8e9f7d[_0x16b3c3(0x235)]&&(await _0x476207[_0x16b3c3(0x1cf)][_0x16b3c3(0x1c0)]({'where':{'id':_0x8e9f7d['id']},'data':{'balance':_0xb2de85}}),console['log'](_0x16b3c3(0x222)+_0x8e9f7d['username']+'\x20balance\x20updated:\x20'+_0x8e9f7d[_0x16b3c3(0x235)][_0x16b3c3(0x1e0)](0x6)+_0x16b3c3(0x1e4)+_0xb2de85[_0x16b3c3(0x1e0)](0x6)+_0x16b3c3(0x21f)),console[_0x16b3c3(0x23c)](_0x16b3c3(0x19a)+_0xce7386)),await _0x476207[_0x16b3c3(0x22a)]['create']({'data':{'paymentId':_0x1daa8c,'shopId':_0x8e9f7d['id'],'event':'webhook_status_change_'+_0x179994[_0x16b3c3(0x1c3)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x76a263,'newStatus':_0x179994[_0x16b3c3(0x1a8)](),'balanceChange':_0xce7386||'no\x20balance\x20change','oldBalance':_0x8e9f7d[_0x16b3c3(0x235)],'newBalance':_0xb2de85,'amountUSDT':_0x4cc95c['amountUSDT'],'additionalData':_0x1af437,'timestamp':new Date()[_0x16b3c3(0x1a7)]()})}}),await this[_0x16b3c3(0x228)]({..._0x39638d,..._0x522db9,'shop':_0x8e9f7d},_0x179994[_0x16b3c3(0x1a8)]()),await this[_0x16b3c3(0x231)]({..._0x39638d,..._0x522db9},_0x179994[_0x16b3c3(0x1a8)]());});}async[a57_0x3627a3(0x1a5)](_0x589655){const _0x4df5b0=a57_0x3627a3;console[_0x4df5b0(0x23c)](_0x4df5b0(0x19d),_0x589655);try{const _0x579573=await this['plisioService'][_0x4df5b0(0x223)](_0x589655);if(!_0x579573[_0x4df5b0(0x1ec)])throw new Error(_0x4df5b0(0x1bd));const _0x3110a3=await database_1[_0x4df5b0(0x1f7)][_0x4df5b0(0x1a2)]['findFirst']({'where':{'gatewayOrderId':_0x579573[_0x4df5b0(0x1ec)]}});if(!_0x3110a3){console[_0x4df5b0(0x1dc)](_0x4df5b0(0x1ab)+_0x579573[_0x4df5b0(0x1ec)]);return;}console['log'](_0x4df5b0(0x1ce)+_0x3110a3['id']+'\x20status\x20'+_0x579573[_0x4df5b0(0x20c)]),await this[_0x4df5b0(0x1bb)](_0x3110a3['id'],_0x579573[_0x4df5b0(0x20c)],{'txUrls':_0x579573[_0x4df5b0(0x1cb)]}),loggerService_1[_0x4df5b0(0x220)][_0x4df5b0(0x22c)]('plisio',_0x3110a3['id'],_0x3110a3[_0x4df5b0(0x20c)],_0x579573[_0x4df5b0(0x20c)],_0x589655);}catch(_0x3bb46a){console[_0x4df5b0(0x1dc)](_0x4df5b0(0x1a1),_0x3bb46a),loggerService_1['loggerService'][_0x4df5b0(0x1ff)](_0x4df5b0(0x206),_0x3bb46a,_0x589655);throw _0x3bb46a;}}async[a57_0x3627a3(0x23b)](_0x220b3e){const _0x1e46e7=a57_0x3627a3;console['log'](_0x1e46e7(0x1e5),_0x220b3e);try{const _0x3d8d55=await this[_0x1e46e7(0x1ca)][_0x1e46e7(0x223)](_0x220b3e);if(!_0x3d8d55[_0x1e46e7(0x1ec)])throw new Error(_0x1e46e7(0x23f));const _0x199c5c=await database_1[_0x1e46e7(0x1f7)]['payment'][_0x1e46e7(0x1c9)]({'where':{'gatewayOrderId':_0x3d8d55[_0x1e46e7(0x1ec)]}});if(!_0x199c5c){console[_0x1e46e7(0x1dc)](_0x1e46e7(0x23e)+_0x3d8d55[_0x1e46e7(0x1ec)]);return;}console[_0x1e46e7(0x23c)](_0x1e46e7(0x21d)+_0x199c5c['id']+_0x1e46e7(0x1dd)+_0x3d8d55[_0x1e46e7(0x20c)]),await this[_0x1e46e7(0x1bb)](_0x199c5c['id'],_0x3d8d55[_0x1e46e7(0x20c)],{'txUrls':_0x3d8d55[_0x1e46e7(0x1cb)]}),loggerService_1[_0x1e46e7(0x220)][_0x1e46e7(0x22c)](_0x1e46e7(0x1a9),_0x199c5c['id'],_0x199c5c[_0x1e46e7(0x20c)],_0x3d8d55['status'],_0x220b3e);}catch(_0x584d6a){console['error'](_0x1e46e7(0x19c),_0x584d6a),loggerService_1[_0x1e46e7(0x220)][_0x1e46e7(0x1ff)](_0x1e46e7(0x1a9),_0x584d6a,_0x220b3e);throw _0x584d6a;}}async[a57_0x3627a3(0x219)](_0x2c7f3a){const _0x3f55fb=a57_0x3627a3;console[_0x3f55fb(0x23c)](_0x3f55fb(0x214),_0x2c7f3a);try{const _0x3e190f=await this[_0x3f55fb(0x22f)][_0x3f55fb(0x223)](_0x2c7f3a);if(!_0x3e190f['paymentId'])throw new Error(_0x3f55fb(0x20b));const _0x33f309=await database_1[_0x3f55fb(0x1f7)][_0x3f55fb(0x1a2)][_0x3f55fb(0x1c9)]({'where':{'gatewayOrderId':_0x3e190f[_0x3f55fb(0x1ec)]}});if(!_0x33f309){console[_0x3f55fb(0x1dc)](_0x3f55fb(0x1e6)+_0x3e190f[_0x3f55fb(0x1ec)]);return;}console[_0x3f55fb(0x23c)](_0x3f55fb(0x196)+_0x33f309['id']+'\x20status\x20'+_0x3e190f[_0x3f55fb(0x20c)]),await this['updatePaymentStatus'](_0x33f309['id'],_0x3e190f[_0x3f55fb(0x20c)],{'failureMessage':_0x3e190f['failureMessage'],'cardLast4':_0x3e190f[_0x3f55fb(0x20a)]?.['cardLast4'],'paymentMethod':_0x3e190f[_0x3f55fb(0x20a)]?.[_0x3f55fb(0x226)]}),loggerService_1[_0x3f55fb(0x220)][_0x3f55fb(0x22c)](_0x3f55fb(0x1e2),_0x33f309['id'],_0x33f309[_0x3f55fb(0x20c)],_0x3e190f[_0x3f55fb(0x20c)],_0x2c7f3a);}catch(_0xc47c){console[_0x3f55fb(0x1dc)](_0x3f55fb(0x1fd),_0xc47c),loggerService_1[_0x3f55fb(0x220)][_0x3f55fb(0x1ff)](_0x3f55fb(0x1e2),_0xc47c,_0x2c7f3a);throw _0xc47c;}}async['processNodaWebhook'](_0x1dc4f1){const _0x24e428=a57_0x3627a3;console[_0x24e428(0x23c)](_0x24e428(0x224),_0x1dc4f1);try{const _0x1fcf77=await this['nodaService'][_0x24e428(0x223)](_0x1dc4f1);if(!_0x1fcf77['paymentId'])throw new Error(_0x24e428(0x212));const _0x348c63=await database_1[_0x24e428(0x1f7)][_0x24e428(0x1a2)][_0x24e428(0x1c9)]({'where':{'gatewayOrderId':_0x1fcf77[_0x24e428(0x1ec)]}});if(!_0x348c63){console['error']('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x1fcf77[_0x24e428(0x1ec)]);return;}console[_0x24e428(0x23c)]('📊\x20Noda\x20webhook:\x20Payment\x20'+_0x348c63['id']+_0x24e428(0x1dd)+_0x1fcf77['status']),await this[_0x24e428(0x1bb)](_0x348c63['id'],_0x1fcf77[_0x24e428(0x20c)],{'bankId':_0x1fcf77[_0x24e428(0x20a)]?.[_0x24e428(0x230)],'remitterIban':_0x1fcf77[_0x24e428(0x20a)]?.['remitterIban'],'remitterName':_0x1fcf77[_0x24e428(0x20a)]?.[_0x24e428(0x1f5)]}),loggerService_1[_0x24e428(0x220)]['logWebhookProcessed'](_0x24e428(0x1b6),_0x348c63['id'],_0x348c63[_0x24e428(0x20c)],_0x1fcf77[_0x24e428(0x20c)],_0x1dc4f1);}catch(_0x2b05c1){console[_0x24e428(0x1dc)](_0x24e428(0x21b),_0x2b05c1),loggerService_1['loggerService'][_0x24e428(0x1ff)]('noda',_0x2b05c1,_0x1dc4f1);throw _0x2b05c1;}}async[a57_0x3627a3(0x1f0)](_0x2e3db9){const _0x5e794d=a57_0x3627a3;console[_0x5e794d(0x23c)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x2e3db9);try{const _0x2afa94=await this[_0x5e794d(0x232)][_0x5e794d(0x223)](_0x2e3db9);if(!_0x2afa94[_0x5e794d(0x1ec)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x2ce5b2=await database_1[_0x5e794d(0x1f7)][_0x5e794d(0x1a2)][_0x5e794d(0x1c9)]({'where':{'gatewayOrderId':_0x2afa94[_0x5e794d(0x1ec)]}});if(!_0x2ce5b2){console[_0x5e794d(0x1dc)](_0x5e794d(0x221)+_0x2afa94['paymentId']);return;}console[_0x5e794d(0x23c)](_0x5e794d(0x22d)+_0x2ce5b2['id']+_0x5e794d(0x1dd)+_0x2afa94[_0x5e794d(0x20c)]),await this[_0x5e794d(0x1bb)](_0x2ce5b2['id'],_0x2afa94[_0x5e794d(0x20c)]),loggerService_1[_0x5e794d(0x220)][_0x5e794d(0x22c)](_0x5e794d(0x218),_0x2ce5b2['id'],_0x2ce5b2[_0x5e794d(0x20c)],_0x2afa94[_0x5e794d(0x20c)],_0x2e3db9);}catch(_0x46f0d3){console[_0x5e794d(0x1dc)](_0x5e794d(0x202),_0x46f0d3),loggerService_1[_0x5e794d(0x220)][_0x5e794d(0x1ff)](_0x5e794d(0x218),_0x46f0d3,_0x2e3db9);throw _0x46f0d3;}}async[a57_0x3627a3(0x19e)](_0x4b289d){const _0x4606a=a57_0x3627a3;console[_0x4606a(0x23c)](_0x4606a(0x1d2),_0x4b289d);try{const _0x16509e=await this[_0x4606a(0x1e7)][_0x4606a(0x223)](_0x4b289d);if(!_0x16509e['paymentId'])throw new Error(_0x4606a(0x199));const _0x25b1b8=await database_1[_0x4606a(0x1f7)][_0x4606a(0x1a2)][_0x4606a(0x1c9)]({'where':{'gatewayOrderId':_0x16509e[_0x4606a(0x1ec)]}});if(!_0x25b1b8){console[_0x4606a(0x1dc)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x16509e['paymentId']);return;}console[_0x4606a(0x23c)](_0x4606a(0x23d)+_0x25b1b8['id']+_0x4606a(0x1dd)+_0x16509e['status']),await this['updatePaymentStatus'](_0x25b1b8['id'],_0x16509e[_0x4606a(0x20c)],{'paymentMethod':_0x16509e[_0x4606a(0x20a)]?.[_0x4606a(0x1d3)]}),loggerService_1[_0x4606a(0x220)]['logWebhookProcessed'](_0x4606a(0x1f6),_0x25b1b8['id'],_0x25b1b8[_0x4606a(0x20c)],_0x16509e[_0x4606a(0x20c)],_0x4b289d);}catch(_0x31b9aa){console[_0x4606a(0x1dc)]('Error\x20processing\x20KLYME\x20webhook:',_0x31b9aa),loggerService_1[_0x4606a(0x220)]['logWebhookError']('klyme',_0x31b9aa,_0x4b289d);throw _0x31b9aa;}}async[a57_0x3627a3(0x1fe)](_0x23f22f){const _0x29b6a3=a57_0x3627a3;console['log'](_0x29b6a3(0x1c1),_0x23f22f);try{const _0xad3d8d=await this['masterCardService'][_0x29b6a3(0x223)](_0x23f22f);if(!_0xad3d8d[_0x29b6a3(0x1ec)])throw new Error(_0x29b6a3(0x1a3));const _0x490509=await database_1[_0x29b6a3(0x1f7)][_0x29b6a3(0x1a2)][_0x29b6a3(0x1c9)]({'where':{'gatewayOrderId':_0xad3d8d['paymentId']}});if(!_0x490509){console[_0x29b6a3(0x1dc)](_0x29b6a3(0x21c)+_0xad3d8d[_0x29b6a3(0x1ec)]);return;}console[_0x29b6a3(0x23c)](_0x29b6a3(0x233)+_0x490509['id']+_0x29b6a3(0x1dd)+_0xad3d8d[_0x29b6a3(0x20c)]),await this['updatePaymentStatus'](_0x490509['id'],_0xad3d8d[_0x29b6a3(0x20c)]),loggerService_1[_0x29b6a3(0x220)][_0x29b6a3(0x22c)](_0x29b6a3(0x1d6),_0x490509['id'],_0x490509['status'],_0xad3d8d[_0x29b6a3(0x20c)],_0x23f22f);}catch(_0x31dcc5){console[_0x29b6a3(0x1dc)](_0x29b6a3(0x1ee),_0x31dcc5),loggerService_1['loggerService'][_0x29b6a3(0x1ff)](_0x29b6a3(0x1d6),_0x31dcc5,_0x23f22f);throw _0x31dcc5;}}async[a57_0x3627a3(0x228)](_0x38b607,_0x58911a){const _0x429067=a57_0x3627a3,_0xc5de4=Date['now']();try{const _0x4980a1=_0x38b607[_0x429067(0x1cf)],_0x24c137=_0x4980a1[_0x429067(0x1d7)];if(!_0x24c137?.[_0x429067(0x1c8)]){console[_0x429067(0x23c)](_0x429067(0x211)+_0x4980a1['id']);return;}const _0x49e550=_0x58911a==='PAID'?_0x429067(0x1aa):_0x58911a===_0x429067(0x1ef)?_0x429067(0x1b0):_0x58911a===_0x429067(0x1ac)?_0x429067(0x1b0):_0x58911a===_0x429067(0x21e)?_0x429067(0x1b0):_0x58911a===_0x429067(0x20f)?_0x429067(0x1b0):_0x429067(0x1a0);let _0x11a7c2=[];if(_0x24c137[_0x429067(0x1c5)])try{_0x11a7c2=Array[_0x429067(0x1e9)](_0x24c137['webhookEvents'])?_0x24c137[_0x429067(0x1c5)]:JSON[_0x429067(0x1bf)](_0x24c137['webhookEvents']);}catch(_0x358fa0){console[_0x429067(0x1dc)]('Error\x20parsing\x20webhook\x20events:',_0x358fa0),_0x11a7c2=[];}if(!_0x11a7c2[_0x429067(0x225)](_0x49e550)){console[_0x429067(0x23c)](_0x429067(0x20e)+_0x49e550+_0x429067(0x1eb)+_0x4980a1['id']);return;}const _0x24812e={'event':_0x49e550,'payment':{'id':_0x38b607['id'],'order_id':_0x38b607[_0x429067(0x207)],'gateway_order_id':_0x38b607['gatewayOrderId'],'gateway':_0x38b607['gateway'],'amount':_0x38b607[_0x429067(0x203)],'currency':_0x38b607[_0x429067(0x238)],'status':_0x58911a[_0x429067(0x1c3)](),'customer_email':_0x38b607[_0x429067(0x205)],'customer_name':_0x38b607['customerName'],'failure_message':_0x38b607[_0x429067(0x1b9)],'tx_urls':_0x38b607[_0x429067(0x1cb)]?JSON['parse'](_0x38b607[_0x429067(0x1cb)]):null,'created_at':_0x38b607[_0x429067(0x1df)],'updated_at':_0x38b607[_0x429067(0x1de)]}},_0x3cc9cd=await fetch(_0x24c137[_0x429067(0x1c8)],{'method':_0x429067(0x1b8),'headers':{'Content-Type':_0x429067(0x210),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x429067(0x1a6)](_0x24812e)}),_0x1c14fa=Date['now']()-_0xc5de4,_0xdc783b=_0x3cc9cd['ok']?_0x429067(0x240):await _0x3cc9cd[_0x429067(0x1b4)]();loggerService_1['loggerService']['logShopWebhookSent'](_0x38b607['shopId'],_0x24c137[_0x429067(0x1c8)],_0x49e550,_0x3cc9cd[_0x429067(0x20c)],_0x1c14fa,_0x24812e),console['log']('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x24c137[_0x429067(0x1c8)]+_0x429067(0x1e1)+_0x3cc9cd[_0x429067(0x20c)]+'\x20('+_0x1c14fa+'ms)');}catch(_0x59f386){console[_0x429067(0x1dc)](_0x429067(0x1b2),_0x59f386),loggerService_1[_0x429067(0x220)]['logShopWebhookError'](_0x38b607[_0x429067(0x1cc)],_0x38b607[_0x429067(0x1cf)]?.['settings']?.[_0x429067(0x1c8)]||_0x429067(0x215),_0x429067(0x1b7),_0x59f386,{});}}async['sendPaymentStatusNotification'](_0x29ab01,_0x565177){const _0x148c90=a57_0x3627a3;try{const _0x379533={'PENDING':_0x148c90(0x23a),'PROCESSING':_0x148c90(0x1db),'PAID':'paid','FAILED':_0x148c90(0x1d8),'EXPIRED':_0x148c90(0x1b5),'REFUND':_0x148c90(0x1b3),'CHARGEBACK':'chargeback'},_0xec794f=_0x379533[_0x565177];if(!_0xec794f||_0xec794f===_0x148c90(0x23a))return;await telegramBotService_1['telegramBotService'][_0x148c90(0x239)](_0x29ab01['shopId'],_0x29ab01,_0xec794f);}catch(_0x114c90){console[_0x148c90(0x1dc)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x114c90);}}}exports[a57_0x3627a3(0x20d)]=WebhookService;