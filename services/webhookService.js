'use strict';const a60_0x2f37a7=a60_0x344a;(function(_0x10c41e,_0x5dc48d){const _0x20e86c=a60_0x344a,_0x1b38fc=_0x10c41e();while(!![]){try{const _0x149e4f=parseInt(_0x20e86c(0x113))/0x1*(parseInt(_0x20e86c(0xfa))/0x2)+-parseInt(_0x20e86c(0x136))/0x3*(-parseInt(_0x20e86c(0x146))/0x4)+-parseInt(_0x20e86c(0x119))/0x5+parseInt(_0x20e86c(0xb9))/0x6+-parseInt(_0x20e86c(0x15c))/0x7*(parseInt(_0x20e86c(0x12e))/0x8)+-parseInt(_0x20e86c(0xcd))/0x9*(-parseInt(_0x20e86c(0xa4))/0xa)+-parseInt(_0x20e86c(0xb4))/0xb;if(_0x149e4f===_0x5dc48d)break;else _0x1b38fc['push'](_0x1b38fc['shift']());}catch(_0x1aaf5e){_0x1b38fc['push'](_0x1b38fc['shift']());}}}(a60_0x5477,0x2c57e));function a60_0x344a(_0x4e4b0a,_0x38de06){const _0x547702=a60_0x5477();return a60_0x344a=function(_0x344af8,_0xa5e07){_0x344af8=_0x344af8-0x87;let _0x44be55=_0x547702[_0x344af8];return _0x44be55;},a60_0x344a(_0x4e4b0a,_0x38de06);}var __importDefault=this&&this[a60_0x2f37a7(0x143)]||function(_0x8afcaa){const _0x1bee0d=a60_0x2f37a7;return _0x8afcaa&&_0x8afcaa[_0x1bee0d(0x101)]?_0x8afcaa:{'default':_0x8afcaa};};Object[a60_0x2f37a7(0x130)](exports,'__esModule',{'value':!![]}),exports[a60_0x2f37a7(0xbb)]=void 0x0;const database_1=__importDefault(require(a60_0x2f37a7(0x14f))),plisioService_1=require(a60_0x2f37a7(0xee)),rapydService_1=require(a60_0x2f37a7(0x109)),nodaService_1=require(a60_0x2f37a7(0x14b)),coinToPayService_1=require(a60_0x2f37a7(0xd1)),coinToPay2Service_1=require(a60_0x2f37a7(0xb8)),klymeService_1=require(a60_0x2f37a7(0xc0)),mastercardService_1=require(a60_0x2f37a7(0x144)),amerService_1=require('./gateways/amerService'),telegramBotService_1=require(a60_0x2f37a7(0x121)),currencyService_1=require(a60_0x2f37a7(0xf2)),loggerService_1=require(a60_0x2f37a7(0x12b));function a60_0x5477(){const _0x3a098e=['\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','No\x20payment\x20ID\x20in\x20Amer\x20webhook','shop','remitterIban','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','Error\x20processing\x20KLYME\x20webhook:','📊\x20Amer\x20webhook:\x20Payment\x20','Error\x20processing\x20Noda\x20webhook:','masterCardService','payment_method','4739WqdVLl','mastercard','paid','💰\x20Converting\x20','failureMessage','paidAt',':\x20type=',',\x20newStatus=','amer','Payment\x20','ms)','payment','stringify','customerName','processWebhook','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','paymentLink','klymeService','coinToPayService','🔄\x20Processing\x20Noda\x20webhook:','REFUND','plisio_gateway','update','\x20commission:\x20','CHARGEBACK','SINGLE','now','logShopWebhookError','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','txUrls','📊\x20Amer\x20webhook\x20result:','chargebackAmount',',\x20currentPayments=','Payment\x20not\x20found','Error\x20processing\x20Rapyd\x20webhook:','🔄\x20Processing\x20Plisio\x20webhook:','Gateway\x20','💰\x20Gateway\x20','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','processPlisioWebhook','gatewayOrderId','rapyd','type','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','webhookUrl',',\x20status=','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','nodaService','\x20-\x20','MasterCardService','226680euyPTV','findMany','paymentLinkId','\x20and\x20-','currentPayments','🏪\x20Shop\x20','\x22,\x20orderId=\x22','\x20->\x20','default','settings','RapydService','✅\x20Payment\x20link\x20','unknown','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','📊\x20Plisio\x20webhook:\x20Payment\x20','paymentMethod','2873420NciKko','\x22,\x20paymentLinkId=\x22','CoinToPay2Service','remitterName','./gateways/coinToPay2Service','1087764KdaBhI','processAmerWebhook','WebhookService','\x20commission\x20for\x20shop\x20','commission','📊\x20CoinToPay\x20webhook:\x20Payment\x20','status','./gateways/klymeService','balance','\x22,\x20newStatus=\x22','currencyService','logWebhookProcessed','amount','gatewaySettings','noda','📊\x20Rapyd\x20webhook:\x20Payment\x20','toUpperCase','sendPaymentNotification','cardLast4','processKlymeWebhook','9wSsHnc','log','💰\x20Amount\x20after\x20gateway\x20commission:\x20','\x20USDT\x20(chargeback\x20penalty)','./gateways/coinToPayService','\x20current\x20balance:\x20','parse','updatePaymentStatus','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','📊\x20Noda\x20webhook:\x20Payment\x20','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','payment.success','🔄\x20Processing\x20MasterCard\x20webhook:','KlymeService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','FAILED','💰\x20Adding\x20to\x20balance:\x20','🔍\x20Search\x20result:\x20','webhook_send','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','amountUSDT','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','bankId','findFirst','create','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','📝\x20Reason:\x20','currency','Found\x20payment\x20','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','Error\x20parsing\x20webhook\x20events:','orderId','./gateways/plisioService','createdAt','EXPIRED','\x20USDT','./currencyService','📊\x20MasterCard\x20webhook\x20result:','logShopWebhookSent','loggerService','❌\x20Payment\x20link\x20','🔄\x20Processing\x20Amer\x20webhook:','error','sendShopWebhook','190198jdKvnu','COMPLETED','Error\x20processing\x20Plisio\x20webhook:','additionalInfo','toISOString','includes','PAID','__esModule','findUnique','No\x20payment\x20ID\x20in\x20Noda\x20webhook','TesSoft\x20Payment\x20System/1.0','amerService','updatedAt','processing','\x20not\x20enabled\x20for\x20shop\x20','./gateways/rapydService','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','processNodaWebhook','entries','toFixed','amountAfterGatewayCommissionUSDT','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','getGatewayCommission','📈\x20Payment\x20','payment.failed','2LHuzTL','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','NodaService','cointopay','klyme','244555BHBNDZ',',\x20using\x20default\x20commission\x2010%','🔄\x20Processing\x20KLYME\x20webhook:','plisioService','rapydService','plisio','POST','failed','./telegramBotService','application/json','refund','\x20in\x20shop\x20','toLowerCase','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','paymentId','\x20balance\x20updated:\x20','payment.pending','PlisioService','./loggerService','\x20=\x20','processPlisioGatewayWebhook','1720VFRmeL','chargeback','defineProperty','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','\x20status\x20','system','sendPaymentStatusNotification',',\x20using\x20default\x2010%','6RBfDgl','🔄\x20Processing\x20CoinToPay2\x20webhook:','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','username','\x20updated:\x20currentPayments=','💰\x20Payment\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','logWebhookError','webhookEvents','telegramBotService','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','📈\x20Payment\x20details:\x20oldStatus=\x22','\x20+\x20','__importDefault','./gateways/mastercardService','Error\x20processing\x20CoinToPay2\x20webhook:','486312KaeKpc','processCoinToPayWebhook','processRapydWebhook','✅\x20Found\x20payment\x20','coinToPay2Service','./gateways/nodaService','created','gateway','shopId','../config/database','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','keys'];a60_0x5477=function(){return _0x3a098e;};return a60_0x5477();}class WebhookService{constructor(){const _0x13ffc6=a60_0x2f37a7;this[_0x13ffc6(0x11c)]=new plisioService_1[(_0x13ffc6(0x12a))](),this['rapydService']=new rapydService_1[(_0x13ffc6(0xae))](),this[_0x13ffc6(0xa1)]=new nodaService_1[(_0x13ffc6(0x116))](),this[_0x13ffc6(0x16e)]=new coinToPayService_1['CoinToPayService'](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x13ffc6(0xb6))](),this[_0x13ffc6(0x16d)]=new klymeService_1[(_0x13ffc6(0xda))](),this[_0x13ffc6(0x15a)]=new mastercardService_1[(_0x13ffc6(0xa3))](),this[_0x13ffc6(0x105)]=new amerService_1['AmerService']();}async[a60_0x2f37a7(0xd4)](_0x34c7bc,_0x409ecd,_0x5c1b47){const _0x27842a=a60_0x2f37a7;console[_0x27842a(0xce)](_0x27842a(0xa0)+_0x34c7bc+_0x27842a(0x163)+_0x409ecd),console['log']('🔄\x20Additional\x20data:',_0x5c1b47),await database_1['default']['$transaction'](async _0x306927=>{const _0x21f403=_0x27842a,_0x3d6f2f=await _0x306927[_0x21f403(0x167)][_0x21f403(0x102)]({'where':{'id':_0x34c7bc},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3d6f2f)throw new Error(_0x21f403(0x165)+_0x34c7bc+'\x20not\x20found');const _0x82a6e1=_0x3d6f2f['status'],_0x29c07f=_0x3d6f2f[_0x21f403(0x154)];console[_0x21f403(0xce)](_0x21f403(0x13b)+_0x34c7bc+':\x20'+_0x82a6e1+'\x20->\x20'+_0x409ecd),console[_0x21f403(0xce)](_0x21f403(0xa9)+_0x29c07f[_0x21f403(0x139)]+_0x21f403(0xd2)+_0x29c07f[_0x21f403(0xc1)]+_0x21f403(0xf1));const _0x5aa6ed={'status':_0x409ecd['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x21f403(0x133),'statusChangedAt':new Date()};_0x5c1b47?.['failureMessage']&&(_0x5aa6ed['failureMessage']=_0x5c1b47['failureMessage']);_0x5c1b47?.['txUrls']&&(_0x5aa6ed['txUrls']=JSON['stringify'](_0x5c1b47['txUrls']));_0x5c1b47?.[_0x21f403(0xcb)]&&(_0x5aa6ed[_0x21f403(0xcb)]=_0x5c1b47[_0x21f403(0xcb)]);_0x5c1b47?.[_0x21f403(0xb3)]&&(_0x5aa6ed[_0x21f403(0xb3)]=_0x5c1b47[_0x21f403(0xb3)]);_0x5c1b47?.['bankId']&&(_0x5aa6ed[_0x21f403(0xe4)]=_0x5c1b47[_0x21f403(0xe4)]);_0x5c1b47?.[_0x21f403(0x155)]&&(_0x5aa6ed[_0x21f403(0x155)]=_0x5c1b47[_0x21f403(0x155)]);_0x5c1b47?.[_0x21f403(0xb7)]&&(_0x5aa6ed[_0x21f403(0xb7)]=_0x5c1b47[_0x21f403(0xb7)]);let _0x381d09=_0x29c07f['balance'],_0x497468='';if(_0x409ecd[_0x21f403(0xc9)]()==='PAID'&&_0x82a6e1!==_0x21f403(0x100)){const _0x20f8ea=await currencyService_1[_0x21f403(0xc3)]['convertToUSDT'](_0x3d6f2f[_0x21f403(0xc5)],_0x3d6f2f[_0x21f403(0xe9)]),_0x5cb2d4=await this[_0x21f403(0x110)](_0x29c07f['id'],_0x3d6f2f[_0x21f403(0x14d)]),_0xc296cc=_0x20f8ea*(0x1-_0x5cb2d4/0x64);_0x381d09+=_0xc296cc,_0x497468='+'+_0xc296cc[_0x21f403(0x10d)](0x6)+_0x21f403(0x156)+_0x5cb2d4+'%\x20gateway\x20commission)',_0x5aa6ed[_0x21f403(0xe1)]=_0x20f8ea,_0x5aa6ed[_0x21f403(0x10e)]=_0xc296cc,_0x5aa6ed[_0x21f403(0x161)]=new Date(),console[_0x21f403(0xce)](_0x21f403(0x15f)+_0x3d6f2f[_0x21f403(0xc5)]+'\x20'+_0x3d6f2f[_0x21f403(0xe9)]+_0x21f403(0xab)+_0x20f8ea[_0x21f403(0x10d)](0x6)+_0x21f403(0xf1)),console['log'](_0x21f403(0x96)+_0x3d6f2f[_0x21f403(0x14d)]+_0x21f403(0x88)+_0x5cb2d4+'%'),console['log'](_0x21f403(0xcf)+_0xc296cc[_0x21f403(0x10d)](0x6)+_0x21f403(0xf1)),console[_0x21f403(0xce)](_0x21f403(0xdd)+_0x29c07f[_0x21f403(0xc1)]+_0x21f403(0x142)+_0xc296cc[_0x21f403(0x10d)](0x6)+_0x21f403(0x12c)+_0x381d09['toFixed'](0x6)+_0x21f403(0xf1));}else{if(_0x82a6e1===_0x21f403(0x100)&&_0x409ecd[_0x21f403(0xc9)]()!==_0x21f403(0x100)){let _0x18ae40;if(_0x3d6f2f[_0x21f403(0x10e)])_0x18ae40=_0x3d6f2f['amountAfterGatewayCommissionUSDT'];else{if(_0x3d6f2f[_0x21f403(0xe1)]){const _0x5d5f11=await this[_0x21f403(0x110)](_0x29c07f['id'],_0x3d6f2f[_0x21f403(0x14d)]);_0x18ae40=_0x3d6f2f[_0x21f403(0xe1)]*(0x1-_0x5d5f11/0x64);}else console['log'](_0x21f403(0x9d)),_0x18ae40=0x0;}_0x18ae40>0x0&&(_0x381d09-=_0x18ae40,_0x497468='-'+_0x18ae40['toFixed'](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x5aa6ed['amountUSDT']=null,_0x5aa6ed['amountAfterGatewayCommissionUSDT']=null,_0x5aa6ed[_0x21f403(0x161)]=null,console[_0x21f403(0xce)]('💰\x20Removing\x20from\x20balance:\x20'+_0x29c07f[_0x21f403(0xc1)]+_0x21f403(0xa2)+_0x18ae40[_0x21f403(0x10d)](0x6)+_0x21f403(0x12c)+_0x381d09[_0x21f403(0x10d)](0x6)+_0x21f403(0xf1)));}}if(_0x409ecd[_0x21f403(0xc9)]()===_0x21f403(0x89)){const _0x2f6760=_0x5c1b47?.[_0x21f403(0x90)]||0x0;_0x2f6760>0x0&&(_0x381d09-=_0x2f6760,_0x497468+=_0x21f403(0xa7)+_0x2f6760['toFixed'](0x6)+_0x21f403(0xd0),_0x5aa6ed['chargebackAmount']=_0x2f6760,console[_0x21f403(0xce)]('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0x2f6760[_0x21f403(0x10d)](0x6)+'\x20USDT'),console['log']('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x381d09[_0x21f403(0x10d)](0x6)+_0x21f403(0xf1)));}const _0x12d436=await _0x306927[_0x21f403(0x167)]['update']({'where':{'id':_0x34c7bc},'data':_0x5aa6ed});_0x381d09!==_0x29c07f[_0x21f403(0xc1)]&&(await _0x306927['shop']['update']({'where':{'id':_0x29c07f['id']},'data':{'balance':_0x381d09}}),console[_0x21f403(0xce)]('✅\x20Shop\x20'+_0x29c07f[_0x21f403(0x139)]+_0x21f403(0x128)+_0x29c07f[_0x21f403(0xc1)]['toFixed'](0x6)+'\x20->\x20'+_0x381d09['toFixed'](0x6)+'\x20USDT'),console['log'](_0x21f403(0xe8)+_0x497468));await _0x306927['webhookLog'][_0x21f403(0xe6)]({'data':{'paymentId':_0x34c7bc,'shopId':_0x29c07f['id'],'event':'webhook_status_change_'+_0x409ecd[_0x21f403(0x125)](),'statusCode':0xc8,'responseBody':JSON[_0x21f403(0x168)]({'oldStatus':_0x82a6e1,'newStatus':_0x409ecd['toUpperCase'](),'balanceChange':_0x497468||'no\x20balance\x20change','oldBalance':_0x29c07f[_0x21f403(0xc1)],'newBalance':_0x381d09,'amountUSDT':_0x5aa6ed[_0x21f403(0xe1)],'additionalData':_0x5c1b47,'timestamp':new Date()[_0x21f403(0xfe)]()})}}),await this[_0x21f403(0xf9)]({..._0x3d6f2f,..._0x12d436,'shop':_0x29c07f},_0x409ecd[_0x21f403(0xc9)]()),await this[_0x21f403(0x134)]({..._0x3d6f2f,..._0x12d436},_0x409ecd['toUpperCase']());if(_0x82a6e1!==_0x21f403(0x100)&&_0x409ecd[_0x21f403(0xc9)]()==='PAID'){console['log'](_0x21f403(0x111)+_0x34c7bc+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console[_0x21f403(0xce)](_0x21f403(0x141)+_0x82a6e1+_0x21f403(0xc2)+_0x409ecd[_0x21f403(0xc9)]()+_0x21f403(0xb5)+_0x3d6f2f[_0x21f403(0xa6)]+'\x22');if(_0x3d6f2f['paymentLinkId'])try{const _0x380274=await _0x306927[_0x21f403(0x16c)][_0x21f403(0x102)]({'where':{'id':_0x3d6f2f[_0x21f403(0xa6)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x380274){console[_0x21f403(0xce)]('📈\x20Found\x20payment\x20link\x20'+_0x380274['id']+_0x21f403(0x162)+_0x380274[_0x21f403(0x9c)]+_0x21f403(0x91)+_0x380274[_0x21f403(0xa8)]+_0x21f403(0x9f)+_0x380274[_0x21f403(0xbf)]);const _0x3a6442=_0x380274[_0x21f403(0xa8)]+0x1,_0x4ab03e=_0x380274[_0x21f403(0x9c)]===_0x21f403(0x8a)?_0x21f403(0xfb):_0x380274[_0x21f403(0xbf)];await _0x306927[_0x21f403(0x16c)][_0x21f403(0x87)]({'where':{'id':_0x3d6f2f[_0x21f403(0xa6)]},'data':{'currentPayments':_0x3a6442,'status':_0x4ab03e,'updatedAt':new Date()}}),console[_0x21f403(0xce)](_0x21f403(0xaf)+_0x380274['id']+_0x21f403(0x13a)+_0x380274[_0x21f403(0xa8)]+_0x21f403(0xab)+_0x3a6442+_0x21f403(0x9f)+_0x380274['status']+_0x21f403(0xab)+_0x4ab03e);}else console['log'](_0x21f403(0xf6)+_0x3d6f2f[_0x21f403(0xa6)]+'\x20not\x20found');}catch(_0x57136a){console[_0x21f403(0xf8)](_0x21f403(0xd5),_0x57136a);}else console[_0x21f403(0xce)]('📈\x20Payment\x20'+_0x34c7bc+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0x21f403(0xce)]('📈\x20Payment\x20'+_0x34c7bc+_0x21f403(0x140)+_0x82a6e1+_0x21f403(0xab)+_0x409ecd['toUpperCase']());});}async[a60_0x2f37a7(0x99)](_0x4541bf){const _0x21d392=a60_0x2f37a7;console[_0x21d392(0xce)](_0x21d392(0x94),_0x4541bf);try{const _0x1d47a3=await this[_0x21d392(0x11c)]['processWebhook'](_0x4541bf);if(!_0x1d47a3[_0x21d392(0x127)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x50b7bd=await database_1['default'][_0x21d392(0x167)][_0x21d392(0xe5)]({'where':{'gatewayOrderId':_0x1d47a3['paymentId']}});if(!_0x50b7bd){console['error'](_0x21d392(0xe3)+_0x1d47a3[_0x21d392(0x127)]);return;}console[_0x21d392(0xce)](_0x21d392(0xb2)+_0x50b7bd['id']+_0x21d392(0x132)+_0x1d47a3[_0x21d392(0xbf)]),await this['updatePaymentStatus'](_0x50b7bd['id'],_0x1d47a3[_0x21d392(0xbf)],{'txUrls':_0x1d47a3['txUrls']}),loggerService_1[_0x21d392(0xf5)][_0x21d392(0xc4)](_0x21d392(0x11e),_0x50b7bd['id'],_0x50b7bd[_0x21d392(0xbf)],_0x1d47a3[_0x21d392(0xbf)],_0x4541bf);}catch(_0x1a5e42){console['error'](_0x21d392(0xfc),_0x1a5e42),loggerService_1[_0x21d392(0xf5)][_0x21d392(0x13d)](_0x21d392(0x11e),_0x1a5e42,_0x4541bf);throw _0x1a5e42;}}async[a60_0x2f37a7(0x12d)](_0x15b818){const _0x513f9e=a60_0x2f37a7;console[_0x513f9e(0xce)](_0x513f9e(0x10f),_0x15b818);try{const _0x5a8fd3=await this[_0x513f9e(0x11c)][_0x513f9e(0x16a)](_0x15b818);if(!_0x5a8fd3[_0x513f9e(0x127)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x10c885=await database_1[_0x513f9e(0xac)][_0x513f9e(0x167)][_0x513f9e(0xe5)]({'where':{'gatewayOrderId':_0x5a8fd3[_0x513f9e(0x127)]}});if(!_0x10c885){console['error']('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x5a8fd3['paymentId']);return;}console['log'](_0x513f9e(0x10a)+_0x10c885['id']+_0x513f9e(0x132)+_0x5a8fd3[_0x513f9e(0xbf)]),await this[_0x513f9e(0xd4)](_0x10c885['id'],_0x5a8fd3[_0x513f9e(0xbf)],{'txUrls':_0x5a8fd3[_0x513f9e(0x8e)]}),loggerService_1[_0x513f9e(0xf5)][_0x513f9e(0xc4)]('plisio_gateway',_0x10c885['id'],_0x10c885['status'],_0x5a8fd3[_0x513f9e(0xbf)],_0x15b818);}catch(_0x1a6c39){console[_0x513f9e(0xf8)](_0x513f9e(0xb1),_0x1a6c39),loggerService_1[_0x513f9e(0xf5)][_0x513f9e(0x13d)](_0x513f9e(0x171),_0x1a6c39,_0x15b818);throw _0x1a6c39;}}async[a60_0x2f37a7(0x148)](_0x489cd1){const _0x268a86=a60_0x2f37a7;console['log']('🔄\x20Processing\x20Rapyd\x20webhook:',_0x489cd1);try{const _0x3c647c=await this[_0x268a86(0x11d)][_0x268a86(0x16a)](_0x489cd1);if(!_0x3c647c['paymentId'])throw new Error(_0x268a86(0x131));const _0x1020a9=await database_1[_0x268a86(0xac)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x3c647c[_0x268a86(0x127)]}});if(!_0x1020a9){console[_0x268a86(0xf8)](_0x268a86(0xe2)+_0x3c647c[_0x268a86(0x127)]);return;}console['log'](_0x268a86(0xc8)+_0x1020a9['id']+_0x268a86(0x132)+_0x3c647c['status']),await this['updatePaymentStatus'](_0x1020a9['id'],_0x3c647c[_0x268a86(0xbf)],{'failureMessage':_0x3c647c[_0x268a86(0x160)],'cardLast4':_0x3c647c['additionalInfo']?.['cardLast4'],'paymentMethod':_0x3c647c[_0x268a86(0xfd)]?.['paymentMethod']}),loggerService_1[_0x268a86(0xf5)][_0x268a86(0xc4)]('rapyd',_0x1020a9['id'],_0x1020a9[_0x268a86(0xbf)],_0x3c647c[_0x268a86(0xbf)],_0x489cd1);}catch(_0x5cf92f){console['error'](_0x268a86(0x93),_0x5cf92f),loggerService_1[_0x268a86(0xf5)][_0x268a86(0x13d)](_0x268a86(0x9b),_0x5cf92f,_0x489cd1);throw _0x5cf92f;}}async[a60_0x2f37a7(0x10b)](_0x46c3ba){const _0x2d5696=a60_0x2f37a7;console[_0x2d5696(0xce)](_0x2d5696(0x16f),_0x46c3ba);try{const _0x42230a=await this['nodaService'][_0x2d5696(0x16a)](_0x46c3ba);if(!_0x42230a[_0x2d5696(0x127)])throw new Error(_0x2d5696(0x103));const _0x2e2521=await database_1[_0x2d5696(0xac)][_0x2d5696(0x167)][_0x2d5696(0xe5)]({'where':{'gatewayOrderId':_0x42230a['paymentId']}});if(!_0x2e2521){console[_0x2d5696(0xf8)](_0x2d5696(0x138)+_0x42230a[_0x2d5696(0x127)]);return;}console['log'](_0x2d5696(0xd6)+_0x2e2521['id']+_0x2d5696(0x132)+_0x42230a['status']),await this['updatePaymentStatus'](_0x2e2521['id'],_0x42230a[_0x2d5696(0xbf)],{'bankId':_0x42230a['additionalInfo']?.[_0x2d5696(0xe4)],'remitterIban':_0x42230a[_0x2d5696(0xfd)]?.[_0x2d5696(0x155)],'remitterName':_0x42230a['additionalInfo']?.[_0x2d5696(0xb7)]}),loggerService_1[_0x2d5696(0xf5)]['logWebhookProcessed'](_0x2d5696(0xc7),_0x2e2521['id'],_0x2e2521[_0x2d5696(0xbf)],_0x42230a[_0x2d5696(0xbf)],_0x46c3ba);}catch(_0x36160c){console['error'](_0x2d5696(0x159),_0x36160c),loggerService_1[_0x2d5696(0xf5)][_0x2d5696(0x13d)](_0x2d5696(0xc7),_0x36160c,_0x46c3ba);throw _0x36160c;}}async[a60_0x2f37a7(0x147)](_0x374757){const _0x5f17d0=a60_0x2f37a7;console[_0x5f17d0(0xce)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x374757);try{const _0x2c76dd=await this['coinToPayService']['processWebhook'](_0x374757);if(!_0x2c76dd[_0x5f17d0(0x127)])throw new Error(_0x5f17d0(0x97));const _0x26004c=await database_1[_0x5f17d0(0xac)][_0x5f17d0(0x167)][_0x5f17d0(0xe5)]({'where':{'gatewayOrderId':_0x2c76dd['paymentId']}});if(!_0x26004c){console[_0x5f17d0(0xf8)](_0x5f17d0(0xd7)+_0x2c76dd[_0x5f17d0(0x127)]);return;}console[_0x5f17d0(0xce)](_0x5f17d0(0xbe)+_0x26004c['id']+_0x5f17d0(0x132)+_0x2c76dd[_0x5f17d0(0xbf)]),await this[_0x5f17d0(0xd4)](_0x26004c['id'],_0x2c76dd[_0x5f17d0(0xbf)]),loggerService_1[_0x5f17d0(0xf5)][_0x5f17d0(0xc4)](_0x5f17d0(0x117),_0x26004c['id'],_0x26004c[_0x5f17d0(0xbf)],_0x2c76dd[_0x5f17d0(0xbf)],_0x374757);}catch(_0x192a15){console[_0x5f17d0(0xf8)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x192a15),loggerService_1[_0x5f17d0(0xf5)][_0x5f17d0(0x13d)]('cointopay',_0x192a15,_0x374757);throw _0x192a15;}}async['processCoinToPay2Webhook'](_0x34c5a3){const _0x182ff8=a60_0x2f37a7;console[_0x182ff8(0xce)](_0x182ff8(0x137),_0x34c5a3);try{const _0x579e1d=await this[_0x182ff8(0x14a)][_0x182ff8(0x16a)](_0x34c5a3);if(!_0x579e1d[_0x182ff8(0x127)])throw new Error(_0x182ff8(0x16b));const _0x29f86a=await database_1[_0x182ff8(0xac)][_0x182ff8(0x167)]['findFirst']({'where':{'gatewayOrderId':_0x579e1d[_0x182ff8(0x127)]}});if(!_0x29f86a){console['error'](_0x182ff8(0xe0)+_0x579e1d[_0x182ff8(0x127)]);return;}console[_0x182ff8(0xce)]('📊\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x29f86a['id']+'\x20status\x20'+_0x579e1d['status']),await this[_0x182ff8(0xd4)](_0x29f86a['id'],_0x579e1d[_0x182ff8(0xbf)]),loggerService_1[_0x182ff8(0xf5)][_0x182ff8(0xc4)]('cointopay2',_0x29f86a['id'],_0x29f86a[_0x182ff8(0xbf)],_0x579e1d['status'],_0x34c5a3);}catch(_0x52e9c2){console[_0x182ff8(0xf8)](_0x182ff8(0x145),_0x52e9c2),loggerService_1[_0x182ff8(0xf5)][_0x182ff8(0x13d)]('cointopay2',_0x52e9c2,_0x34c5a3);throw _0x52e9c2;}}async[a60_0x2f37a7(0xcc)](_0x931f2a){const _0x168956=a60_0x2f37a7;console['log'](_0x168956(0x11b),_0x931f2a);try{const _0x44c999=await this[_0x168956(0x16d)][_0x168956(0x16a)](_0x931f2a);if(!_0x44c999[_0x168956(0x127)])throw new Error(_0x168956(0x150));const _0xab3ac=await database_1[_0x168956(0xac)][_0x168956(0x167)][_0x168956(0xe5)]({'where':{'gatewayOrderId':_0x44c999['paymentId']}});if(!_0xab3ac){console[_0x168956(0xf8)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x44c999['paymentId']);return;}console[_0x168956(0xce)]('📊\x20KLYME\x20webhook:\x20Payment\x20'+_0xab3ac['id']+_0x168956(0x132)+_0x44c999[_0x168956(0xbf)]),await this[_0x168956(0xd4)](_0xab3ac['id'],_0x44c999[_0x168956(0xbf)],{'paymentMethod':_0x44c999[_0x168956(0xfd)]?.[_0x168956(0x15b)]}),loggerService_1['loggerService'][_0x168956(0xc4)](_0x168956(0x118),_0xab3ac['id'],_0xab3ac[_0x168956(0xbf)],_0x44c999[_0x168956(0xbf)],_0x931f2a);}catch(_0xa41b57){console[_0x168956(0xf8)](_0x168956(0x157),_0xa41b57),loggerService_1[_0x168956(0xf5)][_0x168956(0x13d)](_0x168956(0x118),_0xa41b57,_0x931f2a);throw _0xa41b57;}}async['processMasterCardWebhook'](_0x1ce187){const _0x1a82b0=a60_0x2f37a7;console[_0x1a82b0(0xce)](_0x1a82b0(0xd9),JSON[_0x1a82b0(0x168)](_0x1ce187,null,0x2));try{const _0x425980=await this[_0x1a82b0(0x15a)][_0x1a82b0(0x16a)](_0x1ce187);console[_0x1a82b0(0xce)](_0x1a82b0(0xf3),_0x425980);if(!_0x425980[_0x1a82b0(0x127)]){console['error'](_0x1a82b0(0xeb)),console[_0x1a82b0(0xf8)]('❌\x20Available\x20webhook\x20fields:',Object[_0x1a82b0(0x151)](_0x1ce187));throw new Error(_0x1a82b0(0x13c));}let _0x2d2f08=null;console[_0x1a82b0(0xce)]('🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x425980[_0x1a82b0(0x127)]);_0x425980['paymentId']&&(console[_0x1a82b0(0xce)](_0x1a82b0(0x115)),_0x2d2f08=await database_1[_0x1a82b0(0xac)][_0x1a82b0(0x167)][_0x1a82b0(0xe5)]({'where':{'AND':[{'gateway':_0x1a82b0(0x15d)},{'OR':[{'gatewayPaymentId':_0x425980[_0x1a82b0(0x127)]},{'gatewayOrderId':_0x425980[_0x1a82b0(0x127)]},{'id':_0x425980[_0x1a82b0(0x127)]},{'orderId':_0x425980[_0x1a82b0(0x127)]}]}]}}),console[_0x1a82b0(0xce)](_0x1a82b0(0xde)+(_0x2d2f08?_0x1a82b0(0xea)+_0x2d2f08['id']:_0x1a82b0(0x92))));if(!_0x2d2f08){console['error'](_0x1a82b0(0x114)+_0x425980['paymentId']),console[_0x1a82b0(0xf8)]('🔍\x20Searched\x20by:\x20gatewayOrderId=\x22'+_0x425980[_0x1a82b0(0x127)]+'\x22,\x20id=\x22'+_0x425980['paymentId']+_0x1a82b0(0xaa)+_0x425980[_0x1a82b0(0x127)]+'\x22');const _0x1ec1eb=await database_1[_0x1a82b0(0xac)][_0x1a82b0(0x167)][_0x1a82b0(0xa5)]({'where':{'gateway':'mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console['log'](_0x1a82b0(0x8d),_0x1ec1eb);return;}console['log'](_0x1a82b0(0x149)+_0x2d2f08['id']+_0x1a82b0(0x152)+_0x2d2f08[_0x1a82b0(0xbf)]+'\x20to\x20'+_0x425980['status']),await this['updatePaymentStatus'](_0x2d2f08['id'],_0x425980[_0x1a82b0(0xbf)]),loggerService_1[_0x1a82b0(0xf5)]['logWebhookProcessed'](_0x1a82b0(0x15d),_0x2d2f08['id'],_0x2d2f08[_0x1a82b0(0xbf)],_0x425980[_0x1a82b0(0xbf)],_0x1ce187);}catch(_0x3b14d5){console[_0x1a82b0(0xf8)]('❌\x20Error\x20processing\x20MasterCard\x20webhook:',_0x3b14d5),loggerService_1[_0x1a82b0(0xf5)][_0x1a82b0(0x13d)](_0x1a82b0(0x15d),_0x3b14d5,_0x1ce187);throw _0x3b14d5;}}async[a60_0x2f37a7(0xba)](_0x310bc7){const _0x3bfeee=a60_0x2f37a7;console[_0x3bfeee(0xce)](_0x3bfeee(0xf7),JSON[_0x3bfeee(0x168)](_0x310bc7,null,0x2));try{const _0x246ba6=await this['amerService'][_0x3bfeee(0x16a)](_0x310bc7);console[_0x3bfeee(0xce)](_0x3bfeee(0x8f),_0x246ba6);if(!_0x246ba6[_0x3bfeee(0x127)]){console['error']('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data'),console[_0x3bfeee(0xf8)]('❌\x20Available\x20webhook\x20fields:',Object[_0x3bfeee(0x151)](_0x310bc7));throw new Error(_0x3bfeee(0x153));}let _0x77ea4=null;console[_0x3bfeee(0xce)]('🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x246ba6[_0x3bfeee(0x127)]),_0x77ea4=await database_1['default']['payment'][_0x3bfeee(0xe5)]({'where':{'AND':[{'gateway':_0x3bfeee(0x164)},{'OR':[{'gatewayPaymentId':_0x246ba6[_0x3bfeee(0x127)]},{'gatewayOrderId':_0x246ba6[_0x3bfeee(0x127)]},{'id':_0x246ba6[_0x3bfeee(0x127)]},{'orderId':_0x246ba6[_0x3bfeee(0x127)]}]}]}}),console['log'](_0x3bfeee(0xde)+(_0x77ea4?_0x3bfeee(0xea)+_0x77ea4['id']:_0x3bfeee(0x92)));if(!_0x77ea4){console[_0x3bfeee(0xf8)](_0x3bfeee(0xe7)+_0x246ba6[_0x3bfeee(0x127)]);return;}console[_0x3bfeee(0xce)](_0x3bfeee(0x158)+_0x77ea4['id']+_0x3bfeee(0x132)+_0x246ba6['status']),await this['updatePaymentStatus'](_0x77ea4['id'],_0x246ba6[_0x3bfeee(0xbf)],{'cardLast4':_0x246ba6[_0x3bfeee(0xfd)]?.[_0x3bfeee(0xcb)],'paymentMethod':_0x246ba6[_0x3bfeee(0xfd)]?.[_0x3bfeee(0xb3)]});}catch(_0x450b42){console['error']('❌\x20Error\x20processing\x20Amer\x20webhook:',_0x450b42),loggerService_1[_0x3bfeee(0xf5)][_0x3bfeee(0x13d)](_0x3bfeee(0x164),_0x450b42,_0x310bc7);throw _0x450b42;}}async[a60_0x2f37a7(0xf9)](_0x2e02ae,_0x1613d2){const _0x5a237e=a60_0x2f37a7,_0x157dfd=Date[_0x5a237e(0x8b)]();try{const _0x422f37=_0x2e02ae[_0x5a237e(0x154)],_0x298c92=_0x422f37[_0x5a237e(0xad)];if(!_0x298c92?.[_0x5a237e(0x9e)]){console[_0x5a237e(0xce)](_0x5a237e(0xdb)+_0x422f37['id']);return;}const _0x2a78f4=_0x1613d2==='PAID'?_0x5a237e(0xd8):_0x1613d2===_0x5a237e(0xdc)?_0x5a237e(0x112):_0x1613d2===_0x5a237e(0xf0)?_0x5a237e(0x112):_0x1613d2===_0x5a237e(0x89)?'payment.failed':_0x1613d2===_0x5a237e(0x170)?'payment.failed':_0x5a237e(0x129);let _0x3b2e1b=[];if(_0x298c92[_0x5a237e(0x13e)])try{_0x3b2e1b=Array['isArray'](_0x298c92[_0x5a237e(0x13e)])?_0x298c92[_0x5a237e(0x13e)]:JSON[_0x5a237e(0xd3)](_0x298c92['webhookEvents']);}catch(_0x130785){console[_0x5a237e(0xf8)](_0x5a237e(0xec),_0x130785),_0x3b2e1b=[];}if(!_0x3b2e1b[_0x5a237e(0xff)](_0x2a78f4)){console['log']('Webhook\x20event\x20'+_0x2a78f4+_0x5a237e(0x108)+_0x422f37['id']);return;}const _0x5c1e57={'event':_0x2a78f4,'payment':{'id':_0x2e02ae['id'],'order_id':_0x2e02ae[_0x5a237e(0xed)],'gateway_order_id':_0x2e02ae[_0x5a237e(0x9a)],'gateway':_0x2e02ae[_0x5a237e(0x14d)],'amount':_0x2e02ae[_0x5a237e(0xc5)],'currency':_0x2e02ae['currency'],'status':_0x1613d2[_0x5a237e(0x125)](),'customer_email':_0x2e02ae['customerEmail'],'customer_name':_0x2e02ae[_0x5a237e(0x169)],'failure_message':_0x2e02ae['failureMessage'],'tx_urls':_0x2e02ae[_0x5a237e(0x8e)]?JSON[_0x5a237e(0xd3)](_0x2e02ae[_0x5a237e(0x8e)]):null,'created_at':_0x2e02ae[_0x5a237e(0xef)],'updated_at':_0x2e02ae[_0x5a237e(0x106)]}},_0x4d593d=await fetch(_0x298c92[_0x5a237e(0x9e)],{'method':_0x5a237e(0x11f),'headers':{'Content-Type':_0x5a237e(0x122),'User-Agent':_0x5a237e(0x104)},'body':JSON[_0x5a237e(0x168)](_0x5c1e57)}),_0x300691=Date[_0x5a237e(0x8b)]()-_0x157dfd,_0x3a5685=_0x4d593d['ok']?'Success':await _0x4d593d['text']();loggerService_1[_0x5a237e(0xf5)][_0x5a237e(0xf4)](_0x2e02ae[_0x5a237e(0x14e)],_0x298c92[_0x5a237e(0x9e)],_0x2a78f4,_0x4d593d[_0x5a237e(0xbf)],_0x300691,_0x5c1e57),console[_0x5a237e(0xce)]('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x298c92[_0x5a237e(0x9e)]+'\x20with\x20status\x20'+_0x4d593d['status']+'\x20('+_0x300691+_0x5a237e(0x166));}catch(_0x4426d1){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x4426d1),loggerService_1['loggerService'][_0x5a237e(0x8c)](_0x2e02ae[_0x5a237e(0x14e)],_0x2e02ae[_0x5a237e(0x154)]?.[_0x5a237e(0xad)]?.['webhookUrl']||_0x5a237e(0xb0),_0x5a237e(0xdf),_0x4426d1,{});}}async[a60_0x2f37a7(0x134)](_0x155a6f,_0x2a5c79){const _0x32e722=a60_0x2f37a7;try{const _0x1e5952={'PENDING':_0x32e722(0x14c),'PROCESSING':_0x32e722(0x107),'PAID':_0x32e722(0x15e),'FAILED':_0x32e722(0x120),'EXPIRED':'expired','REFUND':_0x32e722(0x123),'CHARGEBACK':_0x32e722(0x12f)},_0x45b879=_0x1e5952[_0x2a5c79];if(!_0x45b879||_0x45b879===_0x32e722(0x14c))return;await telegramBotService_1[_0x32e722(0x13f)][_0x32e722(0xca)](_0x155a6f['shopId'],_0x155a6f,_0x45b879);}catch(_0xc501c8){console[_0x32e722(0xf8)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0xc501c8);}}async[a60_0x2f37a7(0x110)](_0x1cb55b,_0x3f7261){const _0x14e8fa=a60_0x2f37a7;try{const _0x5f07f3=await database_1[_0x14e8fa(0xac)]['shop'][_0x14e8fa(0x102)]({'where':{'id':_0x1cb55b},'select':{'gatewaySettings':!![]}});if(!_0x5f07f3?.['gatewaySettings'])return console[_0x14e8fa(0xce)](_0x14e8fa(0x98)+_0x1cb55b+_0x14e8fa(0x11a)),0xa;const _0x5a2d82=JSON['parse'](_0x5f07f3[_0x14e8fa(0xc6)]);for(const [_0x5e847f,_0xca63d]of Object[_0x14e8fa(0x10c)](_0x5a2d82)){if(_0x5e847f['toLowerCase']()===_0x3f7261[_0x14e8fa(0x125)]()){const _0xe58e3e=_0xca63d[_0x14e8fa(0xbd)]||0xa;return console[_0x14e8fa(0xce)](_0x14e8fa(0x95)+_0x3f7261+_0x14e8fa(0xbc)+_0x1cb55b+':\x20'+_0xe58e3e+'%'),_0xe58e3e;}}return console[_0x14e8fa(0xce)]('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0x3f7261+_0x14e8fa(0x124)+_0x1cb55b+_0x14e8fa(0x135)),0xa;}catch(_0x29b16d){return console[_0x14e8fa(0xf8)](_0x14e8fa(0x126)+_0x1cb55b+',\x20gateway\x20'+_0x3f7261+':',_0x29b16d),0xa;}}}exports['WebhookService']=WebhookService;