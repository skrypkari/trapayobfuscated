'use strict';const a58_0x13e898=a58_0x5809;function a58_0x5809(_0x112eba,_0x1d61a1){const _0x56c103=a58_0x56c1();return a58_0x5809=function(_0x580948,_0xa83868){_0x580948=_0x580948-0xb5;let _0x38aa9d=_0x56c103[_0x580948];return _0x38aa9d;},a58_0x5809(_0x112eba,_0x1d61a1);}(function(_0x1f7a72,_0x463e7b){const _0x4e3148=a58_0x5809,_0xc0f25c=_0x1f7a72();while(!![]){try{const _0x3cabf3=parseInt(_0x4e3148(0x175))/0x1*(-parseInt(_0x4e3148(0xcd))/0x2)+parseInt(_0x4e3148(0xfe))/0x3+parseInt(_0x4e3148(0x158))/0x4+-parseInt(_0x4e3148(0x127))/0x5*(-parseInt(_0x4e3148(0x117))/0x6)+-parseInt(_0x4e3148(0x126))/0x7*(parseInt(_0x4e3148(0x104))/0x8)+-parseInt(_0x4e3148(0xca))/0x9+parseInt(_0x4e3148(0xe3))/0xa;if(_0x3cabf3===_0x463e7b)break;else _0xc0f25c['push'](_0xc0f25c['shift']());}catch(_0x33b7d1){_0xc0f25c['push'](_0xc0f25c['shift']());}}}(a58_0x56c1,0x37a3e));function a58_0x56c1(){const _0x13cd32=['Payment\x20','\x20balance\x20updated:\x20','toUpperCase','✅\x20Shop\x20','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','🔄\x20Additional\x20data:','shop','./gateways/nodaService','logShopWebhookSent',',\x20newStatus=','Error\x20processing\x20KLYME\x20webhook:','now','expired','processCoinToPayWebhook','findUnique','Success','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','currencyService','coinToPay2Service','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','telegramBotService',',\x20status=','3CQbToC','orderId','bankId','chargeback','📊\x20Rapyd\x20webhook:\x20Payment\x20','logWebhookProcessed','\x22,\x20id=\x22','webhook_status_change_','Error\x20parsing\x20webhook\x20events:','settings','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','gateway','__esModule','CHARGEBACK','type','defineProperty','failureMessage','./gateways/plisioService','system','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','cardLast4','refund','payment.failed','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','mastercard','updatePaymentStatus','❌\x20Available\x20webhook\x20fields:','ms)','3942459wDkkKg','💸\x20Additional\x20chargeback\x20penalty:\x20-','\x20-\x20','144126jjwTKA','./loggerService','✅\x20Payment\x20link\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','SINGLE','amount','shopId','Found\x20payment\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','paymentLink','MasterCardService','keys','chargebackAmount','\x20status\x20','../config/database','noda','processMasterCardWebhook','webhookUrl','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','updatedAt','processWebhook','6994660UHUBfc','🔄\x20Processing\x20MasterCard\x20webhook:','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','text','Error\x20processing\x20CoinToPay2\x20webhook:','processPlisioWebhook','customerName','status','💰\x20Final\x20balance\x20after\x20chargeback:\x20','📊\x20MasterCard\x20webhook\x20result:','\x20USDT','\x20+\x20','webhookEvents','PAID','remitterName','paid','processKlymeWebhook','plisioService','WebhookService','currentPayments','created','💰\x20Payment\x20','cointopay','paidAt','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','includes','\x20not\x20enabled\x20for\x20shop\x20','34752yYcpqG','🔄\x20Processing\x20KLYME\x20webhook:','klymeService','📈\x20Payment\x20details:\x20oldStatus=\x22','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','❌\x20Payment\x20link\x20','524296AKzzJy','🔄\x20Processing\x20Plisio\x20webhook:','update','✅\x20Found\x20payment\x20','Webhook\x20event\x20','createdAt','\x20=\x20',':\x20type=','toFixed','webhook_send','payment','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','💰\x20Converting\x20','\x22,\x20paymentLinkId=\x22','processNodaWebhook','./gateways/mastercardService','🔄\x20Processing\x20Noda\x20webhook:','processPlisioGatewayWebhook','payment.pending','106518qagamF','parse','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','POST','\x20USDT\x20(payment\x20became\x20PAID)','paymentLinkId','CoinToPay2Service','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','currency','txUrls','nodaService','default','\x20->\x20','username','\x20not\x20found','42CiniUc','115zPNzgr','klyme','KlymeService','findFirst','payment.success','🏪\x20Shop\x20','masterCardService','📊\x20CoinToPay\x20webhook:\x20Payment\x20','application/json','isArray','\x20with\x20status\x20','🔄\x20Processing\x20CoinToPay2\x20webhook:','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','Error\x20processing\x20Rapyd\x20webhook:','rapydService','loggerService','📊\x20Noda\x20webhook:\x20Payment\x20','error','📝\x20Reason:\x20','💰\x20Adding\x20to\x20balance:\x20','\x20and\x20-','logShopWebhookError','remitterIban','coinToPayService','paymentId','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','paymentMethod','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','🔄\x20Processing\x20CoinToPay\x20webhook:','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','FAILED',',\x20currentPayments=','sendPaymentStatusNotification','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','payment_method','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','no\x20balance\x20change','sendPaymentNotification','cointopay2','additionalInfo','logWebhookError','balance','sendShopWebhook','findMany','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','processRapydWebhook','stringify','amountUSDT','log','623980GEXDum','./telegramBotService','webhookLog','plisio','Payment\x20not\x20found','📈\x20Payment\x20','plisio_gateway'];a58_0x56c1=function(){return _0x13cd32;};return a58_0x56c1();}var __importDefault=this&&this['__importDefault']||function(_0x445315){const _0x248ce1=a58_0x5809;return _0x445315&&_0x445315[_0x248ce1(0xb9)]?_0x445315:{'default':_0x445315};};Object[a58_0x13e898(0xbc)](exports,a58_0x13e898(0xb9),{'value':!![]}),exports[a58_0x13e898(0xf5)]=void 0x0;const database_1=__importDefault(require(a58_0x13e898(0xdc))),plisioService_1=require(a58_0x13e898(0xbe)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a58_0x13e898(0x166)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a58_0x13e898(0x113)),telegramBotService_1=require(a58_0x13e898(0x159)),currencyService_1=require('./currencyService'),loggerService_1=require(a58_0x13e898(0xce));class WebhookService{constructor(){const _0x8957e7=a58_0x13e898;this[_0x8957e7(0xf4)]=new plisioService_1['PlisioService'](),this[_0x8957e7(0x135)]=new rapydService_1['RapydService'](),this[_0x8957e7(0x121)]=new nodaService_1['NodaService'](),this[_0x8957e7(0x13e)]=new coinToPayService_1['CoinToPayService'](),this[_0x8957e7(0x171)]=new coinToPay2Service_1[(_0x8957e7(0x11d))](),this[_0x8957e7(0x100)]=new klymeService_1[(_0x8957e7(0x129))](),this[_0x8957e7(0x12d)]=new mastercardService_1[(_0x8957e7(0xd8))]();}async[a58_0x13e898(0xc7)](_0x1da110,_0x440974,_0x5bbb1e){const _0x325c33=a58_0x13e898;console[_0x325c33(0x157)]('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x1da110+_0x325c33(0x168)+_0x440974),console[_0x325c33(0x157)](_0x325c33(0x164),_0x5bbb1e),await database_1[_0x325c33(0x122)]['$transaction'](async _0x5057e6=>{const _0x5a3281=_0x325c33,_0x566114=await _0x5057e6[_0x5a3281(0x10e)][_0x5a3281(0x16d)]({'where':{'id':_0x1da110},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x566114)throw new Error(_0x5a3281(0x15f)+_0x1da110+_0x5a3281(0x125));const _0x3183ad=_0x566114['status'],_0x315716=_0x566114['shop'];console[_0x5a3281(0x157)](_0x5a3281(0xf8)+_0x1da110+':\x20'+_0x3183ad+_0x5a3281(0x123)+_0x440974),console[_0x5a3281(0x157)](_0x5a3281(0x12c)+_0x315716['username']+'\x20current\x20balance:\x20'+_0x315716[_0x5a3281(0x150)]+_0x5a3281(0xed));const _0x19bb28={'status':_0x440974[_0x5a3281(0x161)](),'updatedAt':new Date(),'statusChangedBy':_0x5a3281(0xbf),'statusChangedAt':new Date()};_0x5bbb1e?.['failureMessage']&&(_0x19bb28[_0x5a3281(0xbd)]=_0x5bbb1e[_0x5a3281(0xbd)]);_0x5bbb1e?.['txUrls']&&(_0x19bb28['txUrls']=JSON[_0x5a3281(0x155)](_0x5bbb1e[_0x5a3281(0x120)]));_0x5bbb1e?.[_0x5a3281(0xc1)]&&(_0x19bb28[_0x5a3281(0xc1)]=_0x5bbb1e[_0x5a3281(0xc1)]);_0x5bbb1e?.[_0x5a3281(0x141)]&&(_0x19bb28[_0x5a3281(0x141)]=_0x5bbb1e[_0x5a3281(0x141)]);_0x5bbb1e?.[_0x5a3281(0x177)]&&(_0x19bb28[_0x5a3281(0x177)]=_0x5bbb1e[_0x5a3281(0x177)]);_0x5bbb1e?.[_0x5a3281(0x13d)]&&(_0x19bb28[_0x5a3281(0x13d)]=_0x5bbb1e[_0x5a3281(0x13d)]);_0x5bbb1e?.['remitterName']&&(_0x19bb28[_0x5a3281(0xf1)]=_0x5bbb1e[_0x5a3281(0xf1)]);let _0x3dbba3=_0x315716[_0x5a3281(0x150)],_0x4dd169='';if(_0x440974[_0x5a3281(0x161)]()===_0x5a3281(0xf0)&&_0x3183ad!==_0x5a3281(0xf0)){const _0x52d593=await currencyService_1[_0x5a3281(0x170)]['convertToUSDT'](_0x566114['amount'],_0x566114[_0x5a3281(0x11f)]);_0x3dbba3+=_0x52d593,_0x4dd169='+'+_0x52d593[_0x5a3281(0x10c)](0x6)+_0x5a3281(0x11b),_0x19bb28[_0x5a3281(0x156)]=_0x52d593,_0x19bb28['paidAt']=new Date(),console['log'](_0x5a3281(0x110)+_0x566114[_0x5a3281(0xd3)]+'\x20'+_0x566114[_0x5a3281(0x11f)]+_0x5a3281(0x123)+_0x52d593[_0x5a3281(0x10c)](0x6)+_0x5a3281(0xed)),console[_0x5a3281(0x157)](_0x5a3281(0x13a)+_0x315716[_0x5a3281(0x150)]+_0x5a3281(0xee)+_0x52d593[_0x5a3281(0x10c)](0x6)+_0x5a3281(0x10a)+_0x3dbba3[_0x5a3281(0x10c)](0x6)+'\x20USDT');}else{if(_0x3183ad===_0x5a3281(0xf0)&&_0x440974[_0x5a3281(0x161)]()!==_0x5a3281(0xf0)){const _0x4b3a0a=_0x566114[_0x5a3281(0x156)];_0x4b3a0a&&(_0x3dbba3-=_0x4b3a0a,_0x4dd169='-'+_0x4b3a0a[_0x5a3281(0x10c)](0x6)+_0x5a3281(0x10f),_0x19bb28[_0x5a3281(0x156)]=null,_0x19bb28[_0x5a3281(0xfa)]=null,console[_0x5a3281(0x157)]('💰\x20Removing\x20from\x20balance:\x20'+_0x315716[_0x5a3281(0x150)]+_0x5a3281(0xcc)+_0x4b3a0a['toFixed'](0x6)+_0x5a3281(0x10a)+_0x3dbba3[_0x5a3281(0x10c)](0x6)+_0x5a3281(0xed)));}}if(_0x440974[_0x5a3281(0x161)]()===_0x5a3281(0xba)){const _0x20beda=_0x5bbb1e?.['chargebackAmount']||0x0;_0x20beda>0x0&&(_0x3dbba3-=_0x20beda,_0x4dd169+=_0x5a3281(0x13b)+_0x20beda[_0x5a3281(0x10c)](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0x19bb28[_0x5a3281(0xda)]=_0x20beda,console[_0x5a3281(0x157)](_0x5a3281(0xcb)+_0x20beda[_0x5a3281(0x10c)](0x6)+_0x5a3281(0xed)),console[_0x5a3281(0x157)](_0x5a3281(0xeb)+_0x3dbba3[_0x5a3281(0x10c)](0x6)+_0x5a3281(0xed)));}const _0xd754d8=await _0x5057e6[_0x5a3281(0x10e)][_0x5a3281(0x106)]({'where':{'id':_0x1da110},'data':_0x19bb28});_0x3dbba3!==_0x315716['balance']&&(await _0x5057e6[_0x5a3281(0x165)][_0x5a3281(0x106)]({'where':{'id':_0x315716['id']},'data':{'balance':_0x3dbba3}}),console[_0x5a3281(0x157)](_0x5a3281(0x162)+_0x315716[_0x5a3281(0x124)]+_0x5a3281(0x160)+_0x315716[_0x5a3281(0x150)][_0x5a3281(0x10c)](0x6)+_0x5a3281(0x123)+_0x3dbba3[_0x5a3281(0x10c)](0x6)+_0x5a3281(0xed)),console[_0x5a3281(0x157)](_0x5a3281(0x139)+_0x4dd169));await _0x5057e6[_0x5a3281(0x15a)]['create']({'data':{'paymentId':_0x1da110,'shopId':_0x315716['id'],'event':_0x5a3281(0x17c)+_0x440974['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x3183ad,'newStatus':_0x440974[_0x5a3281(0x161)](),'balanceChange':_0x4dd169||_0x5a3281(0x14b),'oldBalance':_0x315716['balance'],'newBalance':_0x3dbba3,'amountUSDT':_0x19bb28['amountUSDT'],'additionalData':_0x5bbb1e,'timestamp':new Date()['toISOString']()})}}),await this[_0x5a3281(0x151)]({..._0x566114,..._0xd754d8,'shop':_0x315716},_0x440974['toUpperCase']()),await this['sendPaymentStatusNotification']({..._0x566114,..._0xd754d8},_0x440974[_0x5a3281(0x161)]());if(_0x3183ad!==_0x5a3281(0xf0)&&_0x440974['toUpperCase']()===_0x5a3281(0xf0)){console[_0x5a3281(0x157)](_0x5a3281(0x15d)+_0x1da110+_0x5a3281(0x133)),console[_0x5a3281(0x157)](_0x5a3281(0x101)+_0x3183ad+'\x22,\x20newStatus=\x22'+_0x440974[_0x5a3281(0x161)]()+_0x5a3281(0x111)+_0x566114[_0x5a3281(0x11c)]+'\x22');if(_0x566114[_0x5a3281(0x11c)])try{const _0xc77b00=await _0x5057e6[_0x5a3281(0xd7)][_0x5a3281(0x16d)]({'where':{'id':_0x566114['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0xc77b00){console[_0x5a3281(0x157)]('📈\x20Found\x20payment\x20link\x20'+_0xc77b00['id']+_0x5a3281(0x10b)+_0xc77b00['type']+_0x5a3281(0x146)+_0xc77b00[_0x5a3281(0xf6)]+_0x5a3281(0x174)+_0xc77b00['status']);const _0x828764=_0xc77b00[_0x5a3281(0xf6)]+0x1,_0x3559ea=_0xc77b00[_0x5a3281(0xbb)]===_0x5a3281(0xd2)?'COMPLETED':_0xc77b00[_0x5a3281(0xea)];await _0x5057e6[_0x5a3281(0xd7)]['update']({'where':{'id':_0x566114[_0x5a3281(0x11c)]},'data':{'currentPayments':_0x828764,'status':_0x3559ea,'updatedAt':new Date()}}),console['log'](_0x5a3281(0xcf)+_0xc77b00['id']+'\x20updated:\x20currentPayments='+_0xc77b00['currentPayments']+_0x5a3281(0x123)+_0x828764+_0x5a3281(0x174)+_0xc77b00[_0x5a3281(0xea)]+'\x20->\x20'+_0x3559ea);}else console['log'](_0x5a3281(0x103)+_0x566114['paymentLinkId']+_0x5a3281(0x125));}catch(_0x26ac15){console[_0x5a3281(0x138)]('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x26ac15);}else console[_0x5a3281(0x157)](_0x5a3281(0x15d)+_0x1da110+_0x5a3281(0xd6));}else console[_0x5a3281(0x157)](_0x5a3281(0x15d)+_0x1da110+_0x5a3281(0x16f)+_0x3183ad+_0x5a3281(0x123)+_0x440974[_0x5a3281(0x161)]());});}async[a58_0x13e898(0xe8)](_0x244fb0){const _0x39f9cc=a58_0x13e898;console[_0x39f9cc(0x157)](_0x39f9cc(0x105),_0x244fb0);try{const _0x5496d7=await this[_0x39f9cc(0xf4)][_0x39f9cc(0xe2)](_0x244fb0);if(!_0x5496d7[_0x39f9cc(0x13f)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0xa8eec2=await database_1[_0x39f9cc(0x122)][_0x39f9cc(0x10e)][_0x39f9cc(0x12a)]({'where':{'gatewayOrderId':_0x5496d7[_0x39f9cc(0x13f)]}});if(!_0xa8eec2){console['error'](_0x39f9cc(0x142)+_0x5496d7[_0x39f9cc(0x13f)]);return;}console['log']('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0xa8eec2['id']+'\x20status\x20'+_0x5496d7['status']),await this[_0x39f9cc(0xc7)](_0xa8eec2['id'],_0x5496d7[_0x39f9cc(0xea)],{'txUrls':_0x5496d7[_0x39f9cc(0x120)]}),loggerService_1[_0x39f9cc(0x136)][_0x39f9cc(0x17a)]('plisio',_0xa8eec2['id'],_0xa8eec2['status'],_0x5496d7[_0x39f9cc(0xea)],_0x244fb0);}catch(_0x79a2e3){console['error']('Error\x20processing\x20Plisio\x20webhook:',_0x79a2e3),loggerService_1[_0x39f9cc(0x136)][_0x39f9cc(0x14f)](_0x39f9cc(0x15b),_0x79a2e3,_0x244fb0);throw _0x79a2e3;}}async[a58_0x13e898(0x115)](_0x4be97c){const _0x1de0c3=a58_0x13e898;console[_0x1de0c3(0x157)]('🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:',_0x4be97c);try{const _0xed096a=await this[_0x1de0c3(0xf4)][_0x1de0c3(0xe2)](_0x4be97c);if(!_0xed096a[_0x1de0c3(0x13f)])throw new Error(_0x1de0c3(0xb7));const _0x2d6620=await database_1[_0x1de0c3(0x122)]['payment'][_0x1de0c3(0x12a)]({'where':{'gatewayOrderId':_0xed096a[_0x1de0c3(0x13f)]}});if(!_0x2d6620){console[_0x1de0c3(0x138)]('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0xed096a[_0x1de0c3(0x13f)]);return;}console['log'](_0x1de0c3(0x172)+_0x2d6620['id']+_0x1de0c3(0xdb)+_0xed096a[_0x1de0c3(0xea)]),await this[_0x1de0c3(0xc7)](_0x2d6620['id'],_0xed096a[_0x1de0c3(0xea)],{'txUrls':_0xed096a['txUrls']}),loggerService_1[_0x1de0c3(0x136)][_0x1de0c3(0x17a)]('plisio_gateway',_0x2d6620['id'],_0x2d6620[_0x1de0c3(0xea)],_0xed096a[_0x1de0c3(0xea)],_0x4be97c);}catch(_0x5fcb79){console[_0x1de0c3(0x138)](_0x1de0c3(0x102),_0x5fcb79),loggerService_1[_0x1de0c3(0x136)][_0x1de0c3(0x14f)](_0x1de0c3(0x15e),_0x5fcb79,_0x4be97c);throw _0x5fcb79;}}async[a58_0x13e898(0x154)](_0x44cd9a){const _0x4b6c95=a58_0x13e898;console[_0x4b6c95(0x157)]('🔄\x20Processing\x20Rapyd\x20webhook:',_0x44cd9a);try{const _0x141e78=await this['rapydService'][_0x4b6c95(0xe2)](_0x44cd9a);if(!_0x141e78[_0x4b6c95(0x13f)])throw new Error('No\x20payment\x20ID\x20in\x20Rapyd\x20webhook');const _0x17caae=await database_1['default'][_0x4b6c95(0x10e)][_0x4b6c95(0x12a)]({'where':{'gatewayOrderId':_0x141e78['paymentId']}});if(!_0x17caae){console[_0x4b6c95(0x138)](_0x4b6c95(0x144)+_0x141e78[_0x4b6c95(0x13f)]);return;}console[_0x4b6c95(0x157)](_0x4b6c95(0x179)+_0x17caae['id']+_0x4b6c95(0xdb)+_0x141e78[_0x4b6c95(0xea)]),await this[_0x4b6c95(0xc7)](_0x17caae['id'],_0x141e78[_0x4b6c95(0xea)],{'failureMessage':_0x141e78[_0x4b6c95(0xbd)],'cardLast4':_0x141e78['additionalInfo']?.['cardLast4'],'paymentMethod':_0x141e78[_0x4b6c95(0x14e)]?.[_0x4b6c95(0x141)]}),loggerService_1[_0x4b6c95(0x136)][_0x4b6c95(0x17a)]('rapyd',_0x17caae['id'],_0x17caae[_0x4b6c95(0xea)],_0x141e78['status'],_0x44cd9a);}catch(_0x4b7a16){console[_0x4b6c95(0x138)](_0x4b6c95(0x134),_0x4b7a16),loggerService_1[_0x4b6c95(0x136)][_0x4b6c95(0x14f)]('rapyd',_0x4b7a16,_0x44cd9a);throw _0x4b7a16;}}async[a58_0x13e898(0x112)](_0x39d64e){const _0x659c4=a58_0x13e898;console[_0x659c4(0x157)](_0x659c4(0x114),_0x39d64e);try{const _0x4d2158=await this[_0x659c4(0x121)][_0x659c4(0xe2)](_0x39d64e);if(!_0x4d2158[_0x659c4(0x13f)])throw new Error('No\x20payment\x20ID\x20in\x20Noda\x20webhook');const _0x2c5b44=await database_1[_0x659c4(0x122)][_0x659c4(0x10e)]['findFirst']({'where':{'gatewayOrderId':_0x4d2158['paymentId']}});if(!_0x2c5b44){console[_0x659c4(0x138)](_0x659c4(0x163)+_0x4d2158[_0x659c4(0x13f)]);return;}console[_0x659c4(0x157)](_0x659c4(0x137)+_0x2c5b44['id']+'\x20status\x20'+_0x4d2158[_0x659c4(0xea)]),await this[_0x659c4(0xc7)](_0x2c5b44['id'],_0x4d2158[_0x659c4(0xea)],{'bankId':_0x4d2158[_0x659c4(0x14e)]?.[_0x659c4(0x177)],'remitterIban':_0x4d2158[_0x659c4(0x14e)]?.['remitterIban'],'remitterName':_0x4d2158['additionalInfo']?.[_0x659c4(0xf1)]}),loggerService_1[_0x659c4(0x136)][_0x659c4(0x17a)](_0x659c4(0xdd),_0x2c5b44['id'],_0x2c5b44[_0x659c4(0xea)],_0x4d2158['status'],_0x39d64e);}catch(_0x481848){console['error']('Error\x20processing\x20Noda\x20webhook:',_0x481848),loggerService_1[_0x659c4(0x136)][_0x659c4(0x14f)](_0x659c4(0xdd),_0x481848,_0x39d64e);throw _0x481848;}}async[a58_0x13e898(0x16c)](_0x3d37de){const _0x123a7a=a58_0x13e898;console['log'](_0x123a7a(0x143),_0x3d37de);try{const _0x27f2a0=await this[_0x123a7a(0x13e)]['processWebhook'](_0x3d37de);if(!_0x27f2a0['paymentId'])throw new Error(_0x123a7a(0x140));const _0x31edaf=await database_1[_0x123a7a(0x122)]['payment'][_0x123a7a(0x12a)]({'where':{'gatewayOrderId':_0x27f2a0[_0x123a7a(0x13f)]}});if(!_0x31edaf){console[_0x123a7a(0x138)](_0x123a7a(0xe5)+_0x27f2a0[_0x123a7a(0x13f)]);return;}console[_0x123a7a(0x157)](_0x123a7a(0x12e)+_0x31edaf['id']+_0x123a7a(0xdb)+_0x27f2a0['status']),await this['updatePaymentStatus'](_0x31edaf['id'],_0x27f2a0[_0x123a7a(0xea)]),loggerService_1[_0x123a7a(0x136)][_0x123a7a(0x17a)](_0x123a7a(0xf9),_0x31edaf['id'],_0x31edaf[_0x123a7a(0xea)],_0x27f2a0['status'],_0x3d37de);}catch(_0x4797e9){console[_0x123a7a(0x138)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x4797e9),loggerService_1[_0x123a7a(0x136)][_0x123a7a(0x14f)](_0x123a7a(0xf9),_0x4797e9,_0x3d37de);throw _0x4797e9;}}async['processCoinToPay2Webhook'](_0x3086e6){const _0x413655=a58_0x13e898;console['log'](_0x413655(0x132),_0x3086e6);try{const _0x15ab5f=await this[_0x413655(0x171)][_0x413655(0xe2)](_0x3086e6);if(!_0x15ab5f[_0x413655(0x13f)])throw new Error(_0x413655(0x14a));const _0x393a5e=await database_1['default']['payment'][_0x413655(0x12a)]({'where':{'gatewayOrderId':_0x15ab5f[_0x413655(0x13f)]}});if(!_0x393a5e){console[_0x413655(0x138)]('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x15ab5f[_0x413655(0x13f)]);return;}console[_0x413655(0x157)](_0x413655(0x119)+_0x393a5e['id']+_0x413655(0xdb)+_0x15ab5f['status']),await this['updatePaymentStatus'](_0x393a5e['id'],_0x15ab5f[_0x413655(0xea)]),loggerService_1[_0x413655(0x136)][_0x413655(0x17a)]('cointopay2',_0x393a5e['id'],_0x393a5e[_0x413655(0xea)],_0x15ab5f['status'],_0x3086e6);}catch(_0x7696ef){console['error'](_0x413655(0xe7),_0x7696ef),loggerService_1[_0x413655(0x136)][_0x413655(0x14f)](_0x413655(0x14d),_0x7696ef,_0x3086e6);throw _0x7696ef;}}async[a58_0x13e898(0xf3)](_0x23386e){const _0xfb58da=a58_0x13e898;console['log'](_0xfb58da(0xff),_0x23386e);try{const _0x3d697e=await this['klymeService']['processWebhook'](_0x23386e);if(!_0x3d697e[_0xfb58da(0x13f)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x17ca48=await database_1[_0xfb58da(0x122)][_0xfb58da(0x10e)][_0xfb58da(0x12a)]({'where':{'gatewayOrderId':_0x3d697e[_0xfb58da(0x13f)]}});if(!_0x17ca48){console[_0xfb58da(0x138)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x3d697e[_0xfb58da(0x13f)]);return;}console[_0xfb58da(0x157)]('📊\x20KLYME\x20webhook:\x20Payment\x20'+_0x17ca48['id']+_0xfb58da(0xdb)+_0x3d697e[_0xfb58da(0xea)]),await this['updatePaymentStatus'](_0x17ca48['id'],_0x3d697e[_0xfb58da(0xea)],{'paymentMethod':_0x3d697e[_0xfb58da(0x14e)]?.[_0xfb58da(0x149)]}),loggerService_1[_0xfb58da(0x136)][_0xfb58da(0x17a)](_0xfb58da(0x128),_0x17ca48['id'],_0x17ca48[_0xfb58da(0xea)],_0x3d697e[_0xfb58da(0xea)],_0x23386e);}catch(_0x2308a3){console[_0xfb58da(0x138)](_0xfb58da(0x169),_0x2308a3),loggerService_1['loggerService'][_0xfb58da(0x14f)](_0xfb58da(0x128),_0x2308a3,_0x23386e);throw _0x2308a3;}}async[a58_0x13e898(0xde)](_0x5b38de){const _0x2cad8b=a58_0x13e898;console['log'](_0x2cad8b(0xe4),JSON['stringify'](_0x5b38de,null,0x2));try{const _0x4e0e40=await this[_0x2cad8b(0x12d)][_0x2cad8b(0xe2)](_0x5b38de);console[_0x2cad8b(0x157)](_0x2cad8b(0xec),_0x4e0e40);if(!_0x4e0e40[_0x2cad8b(0x13f)]){console[_0x2cad8b(0x138)](_0x2cad8b(0x11e)),console['error'](_0x2cad8b(0xc8),Object[_0x2cad8b(0xd9)](_0x5b38de));throw new Error(_0x2cad8b(0xd0));}let _0x329b54=null;console[_0x2cad8b(0x157)](_0x2cad8b(0xe0)+_0x4e0e40[_0x2cad8b(0x13f)]);_0x4e0e40['paymentId']&&(console[_0x2cad8b(0x157)](_0x2cad8b(0xfb)),_0x329b54=await database_1[_0x2cad8b(0x122)][_0x2cad8b(0x10e)][_0x2cad8b(0x12a)]({'where':{'AND':[{'gateway':'mastercard'},{'OR':[{'gatewayPaymentId':_0x4e0e40['paymentId']},{'gatewayOrderId':_0x4e0e40[_0x2cad8b(0x13f)]},{'id':_0x4e0e40[_0x2cad8b(0x13f)]},{'orderId':_0x4e0e40[_0x2cad8b(0x13f)]}]}]}}),console[_0x2cad8b(0x157)]('🔍\x20Search\x20result:\x20'+(_0x329b54?_0x2cad8b(0xd5)+_0x329b54['id']:_0x2cad8b(0x15c))));if(!_0x329b54){console[_0x2cad8b(0x138)](_0x2cad8b(0x148)+_0x4e0e40[_0x2cad8b(0x13f)]),console[_0x2cad8b(0x138)](_0x2cad8b(0x153)+_0x4e0e40[_0x2cad8b(0x13f)]+_0x2cad8b(0x17b)+_0x4e0e40[_0x2cad8b(0x13f)]+'\x22,\x20orderId=\x22'+_0x4e0e40[_0x2cad8b(0x13f)]+'\x22');const _0x2a25b9=await database_1[_0x2cad8b(0x122)][_0x2cad8b(0x10e)][_0x2cad8b(0x152)]({'where':{'gateway':_0x2cad8b(0xc6)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console['log'](_0x2cad8b(0xc4),_0x2a25b9);return;}console[_0x2cad8b(0x157)](_0x2cad8b(0x107)+_0x329b54['id']+_0x2cad8b(0xc5)+_0x329b54[_0x2cad8b(0xea)]+'\x20to\x20'+_0x4e0e40[_0x2cad8b(0xea)]),await this[_0x2cad8b(0xc7)](_0x329b54['id'],_0x4e0e40[_0x2cad8b(0xea)]),loggerService_1[_0x2cad8b(0x136)]['logWebhookProcessed'](_0x2cad8b(0xc6),_0x329b54['id'],_0x329b54[_0x2cad8b(0xea)],_0x4e0e40[_0x2cad8b(0xea)],_0x5b38de);}catch(_0x217de3){console[_0x2cad8b(0x138)]('❌\x20Error\x20processing\x20MasterCard\x20webhook:',_0x217de3),loggerService_1['loggerService'][_0x2cad8b(0x14f)](_0x2cad8b(0xc6),_0x217de3,_0x5b38de);throw _0x217de3;}}async[a58_0x13e898(0x151)](_0x3faabf,_0x519204){const _0x4ccce1=a58_0x13e898,_0x524e75=Date[_0x4ccce1(0x16a)]();try{const _0x2ce87e=_0x3faabf[_0x4ccce1(0x165)],_0x121c33=_0x2ce87e[_0x4ccce1(0xb6)];if(!_0x121c33?.[_0x4ccce1(0xdf)]){console[_0x4ccce1(0x157)](_0x4ccce1(0xd1)+_0x2ce87e['id']);return;}const _0x50fac5=_0x519204==='PAID'?_0x4ccce1(0x12b):_0x519204===_0x4ccce1(0x145)?_0x4ccce1(0xc3):_0x519204==='EXPIRED'?_0x4ccce1(0xc3):_0x519204===_0x4ccce1(0xba)?_0x4ccce1(0xc3):_0x519204==='REFUND'?'payment.failed':_0x4ccce1(0x116);let _0x538175=[];if(_0x121c33[_0x4ccce1(0xef)])try{_0x538175=Array[_0x4ccce1(0x130)](_0x121c33[_0x4ccce1(0xef)])?_0x121c33[_0x4ccce1(0xef)]:JSON[_0x4ccce1(0x118)](_0x121c33['webhookEvents']);}catch(_0x5df586){console[_0x4ccce1(0x138)](_0x4ccce1(0xb5),_0x5df586),_0x538175=[];}if(!_0x538175[_0x4ccce1(0xfc)](_0x50fac5)){console[_0x4ccce1(0x157)](_0x4ccce1(0x108)+_0x50fac5+_0x4ccce1(0xfd)+_0x2ce87e['id']);return;}const _0x3fa88a={'event':_0x50fac5,'payment':{'id':_0x3faabf['id'],'order_id':_0x3faabf[_0x4ccce1(0x176)],'gateway_order_id':_0x3faabf['gatewayOrderId'],'gateway':_0x3faabf[_0x4ccce1(0xb8)],'amount':_0x3faabf['amount'],'currency':_0x3faabf[_0x4ccce1(0x11f)],'status':_0x519204['toLowerCase'](),'customer_email':_0x3faabf['customerEmail'],'customer_name':_0x3faabf[_0x4ccce1(0xe9)],'failure_message':_0x3faabf[_0x4ccce1(0xbd)],'tx_urls':_0x3faabf[_0x4ccce1(0x120)]?JSON[_0x4ccce1(0x118)](_0x3faabf[_0x4ccce1(0x120)]):null,'created_at':_0x3faabf[_0x4ccce1(0x109)],'updated_at':_0x3faabf[_0x4ccce1(0xe1)]}},_0x5c8920=await fetch(_0x121c33[_0x4ccce1(0xdf)],{'method':_0x4ccce1(0x11a),'headers':{'Content-Type':_0x4ccce1(0x12f),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x4ccce1(0x155)](_0x3fa88a)}),_0x33c565=Date[_0x4ccce1(0x16a)]()-_0x524e75,_0x5500eb=_0x5c8920['ok']?_0x4ccce1(0x16e):await _0x5c8920[_0x4ccce1(0xe6)]();loggerService_1['loggerService'][_0x4ccce1(0x167)](_0x3faabf[_0x4ccce1(0xd4)],_0x121c33[_0x4ccce1(0xdf)],_0x50fac5,_0x5c8920[_0x4ccce1(0xea)],_0x33c565,_0x3fa88a),console['log']('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x121c33[_0x4ccce1(0xdf)]+_0x4ccce1(0x131)+_0x5c8920[_0x4ccce1(0xea)]+'\x20('+_0x33c565+_0x4ccce1(0xc9));}catch(_0x185e76){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x185e76),loggerService_1[_0x4ccce1(0x136)][_0x4ccce1(0x13c)](_0x3faabf[_0x4ccce1(0xd4)],_0x3faabf['shop']?.[_0x4ccce1(0xb6)]?.[_0x4ccce1(0xdf)]||'unknown',_0x4ccce1(0x10d),_0x185e76,{});}}async[a58_0x13e898(0x147)](_0xc02982,_0x4f7929){const _0x49122e=a58_0x13e898;try{const _0x12e620={'PENDING':_0x49122e(0xf7),'PROCESSING':'processing','PAID':_0x49122e(0xf2),'FAILED':'failed','EXPIRED':_0x49122e(0x16b),'REFUND':_0x49122e(0xc2),'CHARGEBACK':_0x49122e(0x178)},_0x1ed367=_0x12e620[_0x4f7929];if(!_0x1ed367||_0x1ed367===_0x49122e(0xf7))return;await telegramBotService_1[_0x49122e(0x173)][_0x49122e(0x14c)](_0xc02982[_0x49122e(0xd4)],_0xc02982,_0x1ed367);}catch(_0x17e50f){console[_0x49122e(0x138)](_0x49122e(0xc0),_0x17e50f);}}}exports[a58_0x13e898(0xf5)]=WebhookService;