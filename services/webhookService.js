'use strict';const a64_0x538c23=a64_0x1bb6;(function(_0x286a3d,_0x3f5126){const _0x1c6c79=a64_0x1bb6,_0x16a356=_0x286a3d();while(!![]){try{const _0x76a5f1=parseInt(_0x1c6c79(0x306))/0x1+parseInt(_0x1c6c79(0x2f6))/0x2*(parseInt(_0x1c6c79(0x29c))/0x3)+parseInt(_0x1c6c79(0x2ea))/0x4*(-parseInt(_0x1c6c79(0x228))/0x5)+parseInt(_0x1c6c79(0x287))/0x6*(parseInt(_0x1c6c79(0x30a))/0x7)+-parseInt(_0x1c6c79(0x2ed))/0x8+parseInt(_0x1c6c79(0x279))/0x9*(parseInt(_0x1c6c79(0x2a6))/0xa)+-parseInt(_0x1c6c79(0x25c))/0xb;if(_0x76a5f1===_0x3f5126)break;else _0x16a356['push'](_0x16a356['shift']());}catch(_0xf1b2c9){_0x16a356['push'](_0x16a356['shift']());}}}(a64_0x4bb2,0x4d6f1));var __importDefault=this&&this[a64_0x538c23(0x2fc)]||function(_0x29ad48){const _0x586391=a64_0x538c23;return _0x29ad48&&_0x29ad48[_0x586391(0x267)]?_0x29ad48:{'default':_0x29ad48};};Object['defineProperty'](exports,a64_0x538c23(0x267),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a64_0x538c23(0x201))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a64_0x538c23(0x2ab)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require('./gateways/mastercardService'),amerService_1=require('./gateways/amerService'),ampayService_1=require('./gateways/ampayService'),telegramBotService_1=require(a64_0x538c23(0x21e)),currencyService_1=require(a64_0x538c23(0x235)),loggerService_1=require(a64_0x538c23(0x292));function a64_0x4bb2(){const _0xf6a226=['ℹ️\x20AmPay\x20status\x20','chargeback','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','status','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...',',\x20gatewayPaymentId:\x20','logWebhookProcessed','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','💰\x20Amount\x20after\x20gateway\x20commission:\x20','\x20not\x20found','TesSoft\x20Payment\x20System/1.0','currentPayments','📊\x20CoinToPay\x20webhook:\x20Payment\x20','📊\x20MyXSpend\x20webhook\x20data:','coinToPayService','FAILED','COMPLETED','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','username','Error\x20processing\x20Rapyd\x20webhook:','Error\x20processing\x20KLYME\x20webhook:','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','ampayService','processNodaWebhook','customerName',',\x20Status=','No\x20payment\x20ID\x20in\x20Amer\x20webhook','cointopay','telegramBotService','text','payment.pending','🔍\x20VISA\x20payment\x20search\x20executed','../config/database','No\x20additional\x20info','Error\x20processing\x20CoinToPay2\x20webhook:','chargebackAmount','cointopay2','Body\x20data:','\x20USDT\x20(chargeback\x20penalty)','paymentLink',',\x20GatewayOrderId=','\x22,\x20orderId=\x22','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','\x20(Status:\x20','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','processVisaWebhook','paidAt','additionalInfo','application/json','gatewayPaymentId','🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:',',\x20using\x20default\x20commission\x2010%','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','Payment\x20','gatewaySettings','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','\x20mapped\x20to\x20FAILED','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','❌\x20Payment\x20link\x20','balance','./telegramBotService','processPlisioWebhook','mastercard','\x20USDT','map','amountUSDT','update','❌\x20Error\x20processing\x20Amer\x20webhook:','sendPaymentNotification','coinToPay2Service','5930yTNiKq','VisaMasterCardService','KlymeService','📈\x20Payment\x20details:\x20oldStatus=\x22','remitterIban','bankId','ms)','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','Not\x20found','ℹ️\x20Decline\x20reason:\x20','📊\x20Amer\x20webhook:\x20Payment\x20','remitterName','visa/mastercard','./currencyService','❌\x20Error\x20processing\x20AmPay\x20webhook:','✅\x20Shop\x20','cardLast4','📊\x20MasterCard\x20webhook\x20result:','processPlisioGatewayWebhook','\x22,\x20paymentLinkId=\x22','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','✅\x20Found\x20payment\x20','🔄\x20Processing\x20CoinToPay2\x20webhook:','updatePaymentStatus','PAID','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','❌\x20Available\x20webhook\x20fields:','\x20->\x20','sendPaymentStatusNotification','stringify','📈\x20Payment\x20','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','gatewayOrderId','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','processKlymeWebhook','No\x20payment\x20ID\x20in\x20Noda\x20webhook','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','\x20→\x20','processMyXSpendWebhook','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','convertToUSDT','amountAfterGatewayCommissionUSDT','rapyd','✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','shop','Gateway\x20','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','toISOString','klymeService','5970349DHEEYZ','create','orderId',',\x20gateway\x20','failureMessage','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','CoinToPayService','🔍\x20Found\x20VISA\x20payment:\x20ID=','noda','processMasterCardWebhook','toUpperCase','__esModule','💰\x20Payment\x20','gateway','✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20','customerEmail','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','updatedAt','commission','\x20+\x20','🔄\x20Processing\x20Rapyd\x20webhook:','webhookLog','paymentLinkId','\x20in\x20shop\x20','\x20=\x20','VISA','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','REFUND','payment_method','18qTfAON','No\x20payment\x20ID\x20in\x20KLYME\x20webhook',',\x20status=','findMany','type','ampay_','log','findUnique','💰\x20Final\x20balance\x20after\x20chargeback:\x20','📤\x20Shop\x20webhook\x20sent\x20to\x20','📊\x20Noda\x20webhook:\x20Payment\x20','customerOrderId','📊\x20Rapyd\x20webhook:\x20Payment\x20','✅\x20Payment\x20link\x20','534WgkgJf','rapydService','amount','📊\x20KLYME\x20webhook:\x20Payment\x20','📝\x20Reason:\x20','findFirst','visaMasterCardService','📊\x20Payment\x20status:\x20','loggerService','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','nodaService','./loggerService','Payment\x20not\x20found:\x20',',\x20card:\x20****','processWebhook','failed','❌\x20Error\x20processing\x20MasterCard\x20webhook:','Query\x20params:','created','📊\x20VISA\x20payment\x20found:\x20','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','8109DFZIJk','Payment\x20not\x20found','visa','paymentId','toFixed',',\x20Card=****','paymentMethod','\x20updated:\x20currentPayments=','keys','toLowerCase','1550960IjuhWW','txUrls',',\x20gatewayOrderId:\x20','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','./gateways/nodaService','ℹ️\x20MyXSpend\x20status\x20','$transaction','\x20with\x20status\x20','🔄\x20Processing\x20MasterCard\x20webhook:','payment.failed','Found\x20payment\x20','shopId','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','now','Error\x20parsing\x20webhook\x20events:','logWebhookError','amer','\x20status\x20updated\x20to\x20FAILED','📊\x20VISA\x20webhook\x20result:','myxspend','webhookUrl','visa_mastercard','webhookEvents','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','PlisioService','🔄\x20Processing\x20CoinToPay\x20webhook:','ampay','settings','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','refund','klyme','DECLINED','createdAt','\x20(orderId:\x20','getGatewayCommission','🔄\x20Processing\x20Noda\x20webhook:','\x22,\x20id=\x22','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','plisioService','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','💰\x20Adding\x20to\x20balance:\x20','sendShopWebhook','plisio_gateway',',\x20currentPayments=','parse','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','AmerService','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','\x20commission:\x20','📊\x20AmPay\x20webhook\x20data:','POST','SINGLE','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','VISA\x20payment\x20not\x20found:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','default',',\x20Gateway=','🔍\x20Search\x20result:\x20','EXPIRED','\x20for\x20MyXSpend\x20webhook','🔄\x20MyXSpend\x20status\x20','CoinToPay2Service','Failed\x20to\x20send\x20shop\x20webhook:','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','\x20balance\x20updated:\x20','Found','\x20to\x20','1172yuRnxf','💸\x20Additional\x20chargeback\x20penalty:\x20-','\x20status\x20','2843448ZkHQtr','no\x20balance\x20change','webhook_status_change_','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','entries','processAmPayWebhook','💰\x20Removing\x20from\x20balance:\x20','logShopWebhookError','dateTime','282uOlkpJ','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','logShopWebhookSent','gatewayCommissionRate','system_id','\x20for\x20AmPay\x20webhook','__importDefault','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','expired','currency','\x20not\x20enabled\x20for\x20shop\x20','includes','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','isArray','desc','416930XUDGUb','Error\x20processing\x20CoinToPay\x20webhook:','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','35756hwaJQt','payment','error','\x20and\x20-','No\x20payment\x20ID\x20in\x20VISA\x20webhook','unknown','currencyService','🏪\x20Shop\x20','processRapydWebhook','WebhookService','No\x20gateway\x20settings\x20found\x20for\x20shop\x20'];a64_0x4bb2=function(){return _0xf6a226;};return a64_0x4bb2();}function a64_0x1bb6(_0x27dff6,_0x3f9a47){const _0x4bb2a0=a64_0x4bb2();return a64_0x1bb6=function(_0x1bb643,_0x59d6ef){_0x1bb643=_0x1bb643-0x1e4;let _0xf9c67a=_0x4bb2a0[_0x1bb643];return _0xf9c67a;},a64_0x1bb6(_0x27dff6,_0x3f9a47);}class WebhookService{constructor(){const _0x331bf0=a64_0x538c23;this[_0x331bf0(0x2cd)]=new plisioService_1[(_0x331bf0(0x2bf))](),this[_0x331bf0(0x288)]=new rapydService_1['RapydService'](),this[_0x331bf0(0x291)]=new nodaService_1['NodaService'](),this[_0x331bf0(0x1ef)]=new coinToPayService_1[(_0x331bf0(0x262))](),this[_0x331bf0(0x227)]=new coinToPay2Service_1[(_0x331bf0(0x2e4))](),this[_0x331bf0(0x25b)]=new klymeService_1[(_0x331bf0(0x22a))](),this['visaMasterCardService']=new mastercardService_1[(_0x331bf0(0x229))](),this['amerService']=new amerService_1[(_0x331bf0(0x2d5))](),this[_0x331bf0(0x1f7)]=new ampayService_1['AmPayService']();}async[a64_0x538c23(0x240)](_0x1012ee,_0x28bfac,_0x46886d){const _0x2ba6e8=a64_0x538c23;console[_0x2ba6e8(0x27f)](_0x2ba6e8(0x215)+_0x1012ee+',\x20newStatus='+_0x28bfac),console['log']('🔄\x20Additional\x20data:',_0x46886d),await database_1['default'][_0x2ba6e8(0x2ad)](async _0x4b9726=>{const _0x1adc72=_0x2ba6e8,_0x412928=await _0x4b9726[_0x1adc72(0x30b)]['findUnique']({'where':{'id':_0x1012ee},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x412928)throw new Error(_0x1adc72(0x217)+_0x1012ee+_0x1adc72(0x1ea));const _0x1380ee=_0x412928['status'],_0x36e627=_0x412928[_0x1adc72(0x257)];console[_0x1adc72(0x27f)](_0x1adc72(0x268)+_0x1012ee+':\x20'+_0x1380ee+_0x1adc72(0x244)+_0x28bfac),console['log'](_0x1adc72(0x311)+_0x36e627[_0x1adc72(0x1f3)]+'\x20current\x20balance:\x20'+_0x36e627[_0x1adc72(0x21d)]+_0x1adc72(0x221));const _0x568bd7={'status':_0x28bfac[_0x1adc72(0x266)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x46886d?.[_0x1adc72(0x260)]&&(_0x568bd7[_0x1adc72(0x260)]=_0x46886d['failureMessage']);_0x46886d?.[_0x1adc72(0x2a7)]&&(_0x568bd7[_0x1adc72(0x2a7)]=JSON['stringify'](_0x46886d['txUrls']));_0x46886d?.[_0x1adc72(0x238)]&&(_0x568bd7[_0x1adc72(0x238)]=_0x46886d[_0x1adc72(0x238)]);_0x46886d?.[_0x1adc72(0x2a2)]&&(_0x568bd7[_0x1adc72(0x2a2)]=_0x46886d[_0x1adc72(0x2a2)]);_0x46886d?.['bankId']&&(_0x568bd7['bankId']=_0x46886d[_0x1adc72(0x22d)]);_0x46886d?.[_0x1adc72(0x22c)]&&(_0x568bd7[_0x1adc72(0x22c)]=_0x46886d[_0x1adc72(0x22c)]);_0x46886d?.['remitterName']&&(_0x568bd7[_0x1adc72(0x233)]=_0x46886d[_0x1adc72(0x233)]);let _0x267277=_0x36e627['balance'],_0x1c1083='';if(_0x28bfac[_0x1adc72(0x266)]()==='PAID'&&_0x1380ee!=='PAID'){const _0x23b238=await currencyService_1[_0x1adc72(0x310)][_0x1adc72(0x253)](_0x412928[_0x1adc72(0x289)],_0x412928[_0x1adc72(0x300)]),_0x1c21b4=await this[_0x1adc72(0x2c9)](_0x36e627['id'],_0x412928[_0x1adc72(0x269)]),_0x1941cc=_0x23b238*(0x1-_0x1c21b4/0x64);_0x267277+=_0x1941cc,_0x1c1083='+'+_0x1941cc['toFixed'](0x6)+_0x1adc72(0x2a9)+_0x1c21b4+'%\x20gateway\x20commission)',_0x568bd7[_0x1adc72(0x223)]=_0x23b238,_0x568bd7[_0x1adc72(0x254)]=_0x1941cc,_0x568bd7[_0x1adc72(0x2f9)]=_0x1c21b4,_0x568bd7[_0x1adc72(0x20f)]=new Date(),console[_0x1adc72(0x27f)]('💰\x20Converting\x20'+_0x412928[_0x1adc72(0x289)]+'\x20'+_0x412928[_0x1adc72(0x300)]+_0x1adc72(0x244)+_0x23b238[_0x1adc72(0x2a0)](0x6)+'\x20USDT'),console[_0x1adc72(0x27f)]('💰\x20Gateway\x20'+_0x412928[_0x1adc72(0x269)]+_0x1adc72(0x2d7)+_0x1c21b4+'%'),console[_0x1adc72(0x27f)](_0x1adc72(0x1e9)+_0x1941cc[_0x1adc72(0x2a0)](0x6)+_0x1adc72(0x221)),console[_0x1adc72(0x27f)](_0x1adc72(0x2cf)+_0x36e627[_0x1adc72(0x21d)]+_0x1adc72(0x26f)+_0x1941cc[_0x1adc72(0x2a0)](0x6)+'\x20=\x20'+_0x267277[_0x1adc72(0x2a0)](0x6)+_0x1adc72(0x221));}else{if(_0x1380ee===_0x1adc72(0x241)&&_0x28bfac['toUpperCase']()!==_0x1adc72(0x241)){let _0x32592a;if(_0x412928[_0x1adc72(0x254)])_0x32592a=_0x412928['amountAfterGatewayCommissionUSDT'];else{if(_0x412928['amountUSDT']){const _0x1764b2=await this['getGatewayCommission'](_0x36e627['id'],_0x412928[_0x1adc72(0x269)]);_0x32592a=_0x412928[_0x1adc72(0x223)]*(0x1-_0x1764b2/0x64);}else console[_0x1adc72(0x27f)](_0x1adc72(0x20b)),_0x32592a=0x0;}_0x32592a>0x0&&(_0x267277-=_0x32592a,_0x1c1083='-'+_0x32592a[_0x1adc72(0x2a0)](0x6)+_0x1adc72(0x303),_0x568bd7[_0x1adc72(0x223)]=null,_0x568bd7[_0x1adc72(0x254)]=null,_0x568bd7[_0x1adc72(0x20f)]=null,console['log'](_0x1adc72(0x2f3)+_0x36e627[_0x1adc72(0x21d)]+'\x20-\x20'+_0x32592a[_0x1adc72(0x2a0)](0x6)+_0x1adc72(0x274)+_0x267277['toFixed'](0x6)+_0x1adc72(0x221)));}}if(_0x28bfac[_0x1adc72(0x266)]()==='CHARGEBACK'){const _0x497592=_0x46886d?.[_0x1adc72(0x204)]||0x0;_0x497592>0x0&&(_0x267277-=_0x497592,_0x1c1083+=_0x1adc72(0x30d)+_0x497592[_0x1adc72(0x2a0)](0x6)+_0x1adc72(0x207),_0x568bd7['chargebackAmount']=_0x497592,console[_0x1adc72(0x27f)](_0x1adc72(0x2eb)+_0x497592[_0x1adc72(0x2a0)](0x6)+_0x1adc72(0x221)),console[_0x1adc72(0x27f)](_0x1adc72(0x281)+_0x267277[_0x1adc72(0x2a0)](0x6)+_0x1adc72(0x221)));}const _0xca9817=await _0x4b9726[_0x1adc72(0x30b)]['update']({'where':{'id':_0x1012ee},'data':_0x568bd7});_0x267277!==_0x36e627[_0x1adc72(0x21d)]&&(await _0x4b9726[_0x1adc72(0x257)][_0x1adc72(0x224)]({'where':{'id':_0x36e627['id']},'data':{'balance':_0x267277}}),console[_0x1adc72(0x27f)](_0x1adc72(0x237)+_0x36e627[_0x1adc72(0x1f3)]+_0x1adc72(0x2e7)+_0x36e627[_0x1adc72(0x21d)][_0x1adc72(0x2a0)](0x6)+_0x1adc72(0x244)+_0x267277['toFixed'](0x6)+'\x20USDT'),console['log'](_0x1adc72(0x28b)+_0x1c1083));await _0x4b9726[_0x1adc72(0x271)]['create']({'data':{'paymentId':_0x1012ee,'shopId':_0x36e627['id'],'event':_0x1adc72(0x2ef)+_0x28bfac[_0x1adc72(0x2a5)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1380ee,'newStatus':_0x28bfac[_0x1adc72(0x266)](),'balanceChange':_0x1c1083||_0x1adc72(0x2ee),'oldBalance':_0x36e627[_0x1adc72(0x21d)],'newBalance':_0x267277,'amountUSDT':_0x568bd7[_0x1adc72(0x223)],'additionalData':_0x46886d,'timestamp':new Date()[_0x1adc72(0x25a)]()})}}),await this[_0x1adc72(0x2d0)]({..._0x412928,..._0xca9817,'shop':_0x36e627},_0x28bfac[_0x1adc72(0x266)]()),await this[_0x1adc72(0x245)]({..._0x412928,..._0xca9817},_0x28bfac['toUpperCase']());if(_0x1380ee!=='PAID'&&_0x28bfac[_0x1adc72(0x266)]()===_0x1adc72(0x241)){console[_0x1adc72(0x27f)](_0x1adc72(0x247)+_0x1012ee+_0x1adc72(0x290)),console[_0x1adc72(0x27f)](_0x1adc72(0x22b)+_0x1380ee+'\x22,\x20newStatus=\x22'+_0x28bfac[_0x1adc72(0x266)]()+_0x1adc72(0x23b)+_0x412928['paymentLinkId']+'\x22');if(_0x412928[_0x1adc72(0x272)])try{const _0x1e0521=await _0x4b9726[_0x1adc72(0x208)]['findUnique']({'where':{'id':_0x412928[_0x1adc72(0x272)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1e0521){console[_0x1adc72(0x27f)]('📈\x20Found\x20payment\x20link\x20'+_0x1e0521['id']+':\x20type='+_0x1e0521[_0x1adc72(0x27d)]+_0x1adc72(0x2d2)+_0x1e0521[_0x1adc72(0x1ec)]+_0x1adc72(0x27b)+_0x1e0521[_0x1adc72(0x318)]);const _0x15d928=_0x1e0521[_0x1adc72(0x1ec)]+0x1,_0xebd22d=_0x1e0521[_0x1adc72(0x27d)]===_0x1adc72(0x2da)?_0x1adc72(0x1f1):_0x1e0521[_0x1adc72(0x318)];await _0x4b9726[_0x1adc72(0x208)][_0x1adc72(0x224)]({'where':{'id':_0x412928['paymentLinkId']},'data':{'currentPayments':_0x15d928,'status':_0xebd22d,'updatedAt':new Date()}}),console[_0x1adc72(0x27f)](_0x1adc72(0x286)+_0x1e0521['id']+_0x1adc72(0x2a3)+_0x1e0521[_0x1adc72(0x1ec)]+_0x1adc72(0x244)+_0x15d928+_0x1adc72(0x27b)+_0x1e0521[_0x1adc72(0x318)]+'\x20->\x20'+_0xebd22d);}else console['log'](_0x1adc72(0x21c)+_0x412928[_0x1adc72(0x272)]+_0x1adc72(0x1ea));}catch(_0x49f5f9){console[_0x1adc72(0x30c)](_0x1adc72(0x24e),_0x49f5f9);}else console['log'](_0x1adc72(0x247)+_0x1012ee+_0x1adc72(0x2fd));}else console['log'](_0x1adc72(0x247)+_0x1012ee+_0x1adc72(0x26c)+_0x1380ee+_0x1adc72(0x244)+_0x28bfac['toUpperCase']());});}async[a64_0x538c23(0x21f)](_0x4d82b3){const _0xbf958c=a64_0x538c23;console['log']('🔄\x20Processing\x20Plisio\x20webhook:',_0x4d82b3);try{const _0x16138b=await this['plisioService'][_0xbf958c(0x295)](_0x4d82b3);if(!_0x16138b[_0xbf958c(0x29f)])throw new Error(_0xbf958c(0x29b));const _0x37c1d4=await database_1[_0xbf958c(0x2de)][_0xbf958c(0x30b)][_0xbf958c(0x28c)]({'where':{'gatewayOrderId':_0x16138b['paymentId']}});if(!_0x37c1d4){console[_0xbf958c(0x30c)](_0xbf958c(0x23d)+_0x16138b[_0xbf958c(0x29f)]);return;}console[_0xbf958c(0x27f)]('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0x37c1d4['id']+'\x20status\x20'+_0x16138b['status']),await this[_0xbf958c(0x240)](_0x37c1d4['id'],_0x16138b['status'],{'txUrls':_0x16138b['txUrls']}),loggerService_1[_0xbf958c(0x28f)][_0xbf958c(0x1e6)]('plisio',_0x37c1d4['id'],_0x37c1d4[_0xbf958c(0x318)],_0x16138b['status'],_0x4d82b3);}catch(_0x283887){console[_0xbf958c(0x30c)]('Error\x20processing\x20Plisio\x20webhook:',_0x283887),loggerService_1[_0xbf958c(0x28f)]['logWebhookError']('plisio',_0x283887,_0x4d82b3);throw _0x283887;}}async[a64_0x538c23(0x23a)](_0x4f1f72){const _0x14440f=a64_0x538c23;console['log'](_0x14440f(0x261),_0x4f1f72);try{const _0x179422=await this[_0x14440f(0x2cd)][_0x14440f(0x295)](_0x4f1f72);if(!_0x179422[_0x14440f(0x29f)])throw new Error(_0x14440f(0x2be));const _0x4c9820=await database_1[_0x14440f(0x2de)][_0x14440f(0x30b)][_0x14440f(0x28c)]({'where':{'gatewayOrderId':_0x179422[_0x14440f(0x29f)]}});if(!_0x4c9820){console['error']('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x179422[_0x14440f(0x29f)]);return;}console['log'](_0x14440f(0x21b)+_0x4c9820['id']+_0x14440f(0x2ec)+_0x179422[_0x14440f(0x318)]),await this[_0x14440f(0x240)](_0x4c9820['id'],_0x179422[_0x14440f(0x318)],{'txUrls':_0x179422[_0x14440f(0x2a7)]}),loggerService_1[_0x14440f(0x28f)]['logWebhookProcessed'](_0x14440f(0x2d1),_0x4c9820['id'],_0x4c9820['status'],_0x179422[_0x14440f(0x318)],_0x4f1f72);}catch(_0x36f32d){console[_0x14440f(0x30c)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x36f32d),loggerService_1[_0x14440f(0x28f)][_0x14440f(0x2b6)](_0x14440f(0x2d1),_0x36f32d,_0x4f1f72);throw _0x36f32d;}}async[a64_0x538c23(0x312)](_0x249ba8){const _0xdcf233=a64_0x538c23;console[_0xdcf233(0x27f)](_0xdcf233(0x270),_0x249ba8);try{const _0x3e0969=await this[_0xdcf233(0x288)][_0xdcf233(0x295)](_0x249ba8);if(!_0x3e0969[_0xdcf233(0x29f)])throw new Error('No\x20payment\x20ID\x20in\x20Rapyd\x20webhook');const _0x59c62b=await database_1[_0xdcf233(0x2de)]['payment'][_0xdcf233(0x28c)]({'where':{'gatewayOrderId':_0x3e0969['paymentId']}});if(!_0x59c62b){console[_0xdcf233(0x30c)](_0xdcf233(0x259)+_0x3e0969['paymentId']);return;}console['log'](_0xdcf233(0x285)+_0x59c62b['id']+_0xdcf233(0x2ec)+_0x3e0969[_0xdcf233(0x318)]),await this['updatePaymentStatus'](_0x59c62b['id'],_0x3e0969['status'],{'failureMessage':_0x3e0969['failureMessage'],'cardLast4':_0x3e0969['additionalInfo']?.['cardLast4'],'paymentMethod':_0x3e0969[_0xdcf233(0x210)]?.[_0xdcf233(0x2a2)]}),loggerService_1[_0xdcf233(0x28f)][_0xdcf233(0x1e6)](_0xdcf233(0x255),_0x59c62b['id'],_0x59c62b[_0xdcf233(0x318)],_0x3e0969[_0xdcf233(0x318)],_0x249ba8);}catch(_0x2e3394){console[_0xdcf233(0x30c)](_0xdcf233(0x1f4),_0x2e3394),loggerService_1[_0xdcf233(0x28f)][_0xdcf233(0x2b6)](_0xdcf233(0x255),_0x2e3394,_0x249ba8);throw _0x2e3394;}}async[a64_0x538c23(0x1f8)](_0x53c8e1){const _0x3b1420=a64_0x538c23;console[_0x3b1420(0x27f)](_0x3b1420(0x2ca),_0x53c8e1);try{const _0x145a75=await this[_0x3b1420(0x291)][_0x3b1420(0x295)](_0x53c8e1);if(!_0x145a75['paymentId'])throw new Error(_0x3b1420(0x24c));const _0x1fbd69=await database_1[_0x3b1420(0x2de)]['payment'][_0x3b1420(0x28c)]({'where':{'gatewayOrderId':_0x145a75[_0x3b1420(0x29f)]}});if(!_0x1fbd69){console[_0x3b1420(0x30c)](_0x3b1420(0x2aa)+_0x145a75[_0x3b1420(0x29f)]);return;}console['log'](_0x3b1420(0x283)+_0x1fbd69['id']+_0x3b1420(0x2ec)+_0x145a75['status']),await this[_0x3b1420(0x240)](_0x1fbd69['id'],_0x145a75[_0x3b1420(0x318)],{'bankId':_0x145a75[_0x3b1420(0x210)]?.[_0x3b1420(0x22d)],'remitterIban':_0x145a75[_0x3b1420(0x210)]?.[_0x3b1420(0x22c)],'remitterName':_0x145a75[_0x3b1420(0x210)]?.[_0x3b1420(0x233)]}),loggerService_1[_0x3b1420(0x28f)][_0x3b1420(0x1e6)]('noda',_0x1fbd69['id'],_0x1fbd69[_0x3b1420(0x318)],_0x145a75[_0x3b1420(0x318)],_0x53c8e1);}catch(_0x387e05){console[_0x3b1420(0x30c)]('Error\x20processing\x20Noda\x20webhook:',_0x387e05),loggerService_1[_0x3b1420(0x28f)][_0x3b1420(0x2b6)](_0x3b1420(0x264),_0x387e05,_0x53c8e1);throw _0x387e05;}}async['processCoinToPayWebhook'](_0x398760){const _0x4b6770=a64_0x538c23;console[_0x4b6770(0x27f)](_0x4b6770(0x2c0),_0x398760);try{const _0x3b7034=await this[_0x4b6770(0x1ef)][_0x4b6770(0x295)](_0x398760);if(!_0x3b7034['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x17b161=await database_1[_0x4b6770(0x2de)]['payment'][_0x4b6770(0x28c)]({'where':{'gatewayOrderId':_0x3b7034[_0x4b6770(0x29f)]}});if(!_0x17b161){console[_0x4b6770(0x30c)](_0x4b6770(0x1f2)+_0x3b7034[_0x4b6770(0x29f)]);return;}console[_0x4b6770(0x27f)](_0x4b6770(0x1ed)+_0x17b161['id']+_0x4b6770(0x2ec)+_0x3b7034['status']),await this['updatePaymentStatus'](_0x17b161['id'],_0x3b7034[_0x4b6770(0x318)]),loggerService_1[_0x4b6770(0x28f)]['logWebhookProcessed'](_0x4b6770(0x1fc),_0x17b161['id'],_0x17b161[_0x4b6770(0x318)],_0x3b7034['status'],_0x398760);}catch(_0x410ce4){console[_0x4b6770(0x30c)](_0x4b6770(0x307),_0x410ce4),loggerService_1[_0x4b6770(0x28f)][_0x4b6770(0x2b6)](_0x4b6770(0x1fc),_0x410ce4,_0x398760);throw _0x410ce4;}}async['processCoinToPay2Webhook'](_0x1a0536){const _0x7252a4=a64_0x538c23;console[_0x7252a4(0x27f)](_0x7252a4(0x23f),_0x1a0536);try{const _0x5c744d=await this[_0x7252a4(0x227)]['processWebhook'](_0x1a0536);if(!_0x5c744d['paymentId'])throw new Error(_0x7252a4(0x23c));const _0x456ce1=await database_1[_0x7252a4(0x2de)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x5c744d['paymentId']}});if(!_0x456ce1){console[_0x7252a4(0x30c)](_0x7252a4(0x309)+_0x5c744d[_0x7252a4(0x29f)]);return;}console[_0x7252a4(0x27f)](_0x7252a4(0x2d4)+_0x456ce1['id']+_0x7252a4(0x2ec)+_0x5c744d['status']),await this['updatePaymentStatus'](_0x456ce1['id'],_0x5c744d[_0x7252a4(0x318)]),loggerService_1['loggerService'][_0x7252a4(0x1e6)](_0x7252a4(0x205),_0x456ce1['id'],_0x456ce1[_0x7252a4(0x318)],_0x5c744d[_0x7252a4(0x318)],_0x1a0536);}catch(_0x4a1813){console[_0x7252a4(0x30c)](_0x7252a4(0x203),_0x4a1813),loggerService_1['loggerService'][_0x7252a4(0x2b6)](_0x7252a4(0x205),_0x4a1813,_0x1a0536);throw _0x4a1813;}}async[a64_0x538c23(0x24b)](_0x4c11dd){const _0x1b1dfe=a64_0x538c23;console[_0x1b1dfe(0x27f)]('🔄\x20Processing\x20KLYME\x20webhook:',_0x4c11dd);try{const _0x4ef19d=await this[_0x1b1dfe(0x25b)][_0x1b1dfe(0x295)](_0x4c11dd);if(!_0x4ef19d['paymentId'])throw new Error(_0x1b1dfe(0x27a));const _0x159588=await database_1[_0x1b1dfe(0x2de)][_0x1b1dfe(0x30b)][_0x1b1dfe(0x28c)]({'where':{'gatewayOrderId':_0x4ef19d[_0x1b1dfe(0x29f)]}});if(!_0x159588){console[_0x1b1dfe(0x30c)](_0x1b1dfe(0x2cc)+_0x4ef19d[_0x1b1dfe(0x29f)]);return;}console['log'](_0x1b1dfe(0x28a)+_0x159588['id']+_0x1b1dfe(0x2ec)+_0x4ef19d[_0x1b1dfe(0x318)]),await this[_0x1b1dfe(0x240)](_0x159588['id'],_0x4ef19d[_0x1b1dfe(0x318)],{'paymentMethod':_0x4ef19d[_0x1b1dfe(0x210)]?.[_0x1b1dfe(0x278)]}),loggerService_1[_0x1b1dfe(0x28f)]['logWebhookProcessed'](_0x1b1dfe(0x2c5),_0x159588['id'],_0x159588[_0x1b1dfe(0x318)],_0x4ef19d[_0x1b1dfe(0x318)],_0x4c11dd);}catch(_0x590cf0){console[_0x1b1dfe(0x30c)](_0x1b1dfe(0x1f5),_0x590cf0),loggerService_1['loggerService']['logWebhookError'](_0x1b1dfe(0x2c5),_0x590cf0,_0x4c11dd);throw _0x590cf0;}}async[a64_0x538c23(0x20e)](_0x20e61a){const _0x49b821=a64_0x538c23;console['log']('🔄\x20Processing\x20VISA\x20webhook:',JSON[_0x49b821(0x246)](_0x20e61a,null,0x2));try{const _0x91510b=await this[_0x49b821(0x28d)][_0x49b821(0x295)](_0x20e61a,_0x49b821(0x275));console['log'](_0x49b821(0x2b9),_0x91510b);if(!_0x91510b[_0x49b821(0x29f)]){console['error']('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data'),console['error'](_0x49b821(0x243),Object[_0x49b821(0x2a4)](_0x20e61a));throw new Error(_0x49b821(0x30e));}let _0x19e0da=null;console[_0x49b821(0x27f)]('🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x91510b[_0x49b821(0x29f)]);if(_0x91510b[_0x49b821(0x29f)]){console[_0x49b821(0x27f)](_0x49b821(0x1e4)),console[_0x49b821(0x27f)](_0x49b821(0x2fe)),console[_0x49b821(0x27f)](_0x49b821(0x242)),console[_0x49b821(0x27f)](_0x49b821(0x2c3)+_0x91510b[_0x49b821(0x29f)]),console[_0x49b821(0x27f)]('\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId'),_0x19e0da=await database_1['default'][_0x49b821(0x30b)][_0x49b821(0x28c)]({'where':{'AND':[{'OR':[{'gateway':'visa/mastercard'},{'gateway':_0x49b821(0x220)}]},{'OR':[{'gatewayPaymentId':_0x91510b[_0x49b821(0x29f)]},{'gatewayOrderId':_0x91510b['paymentId']},{'id':_0x91510b[_0x49b821(0x29f)]},{'orderId':_0x91510b[_0x49b821(0x29f)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console['log'](_0x49b821(0x200));if(_0x19e0da)console['log']('✅\x20Found\x20payment:\x20ID='+_0x19e0da['id']+_0x49b821(0x209)+_0x19e0da[_0x49b821(0x249)]+',\x20GatewayPaymentId='+_0x19e0da[_0x49b821(0x212)]);else{console[_0x49b821(0x27f)](_0x49b821(0x308));const _0x985a31=await database_1[_0x49b821(0x2de)][_0x49b821(0x30b)][_0x49b821(0x27c)]({'where':{'gateway':'visa/mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x49b821(0x305)}});console[_0x49b821(0x27f)](_0x49b821(0x213),_0x985a31[_0x49b821(0x222)](_0x215f6f=>_0x215f6f['id']+_0x49b821(0x2c8)+_0x215f6f[_0x49b821(0x25e)]+_0x49b821(0x2a8)+_0x215f6f[_0x49b821(0x249)]+_0x49b821(0x1e5)+_0x215f6f[_0x49b821(0x212)]+_0x49b821(0x294)+_0x215f6f[_0x49b821(0x238)]+')'));}console[_0x49b821(0x27f)]('🔍\x20VISA\x20payment\x20search\x20result:\x20'+(_0x19e0da?_0x49b821(0x2e8):_0x49b821(0x230))),_0x19e0da&&console[_0x49b821(0x27f)](_0x49b821(0x263)+_0x19e0da['id']+_0x49b821(0x2df)+_0x19e0da['gateway']+_0x49b821(0x1fa)+_0x19e0da[_0x49b821(0x318)]+_0x49b821(0x2a1)+_0x19e0da['cardLast4']);}if(!_0x19e0da){console[_0x49b821(0x30c)](_0x49b821(0x216)+_0x91510b[_0x49b821(0x29f)]),loggerService_1['loggerService'][_0x49b821(0x2b6)](_0x49b821(0x29e),new Error(_0x49b821(0x293)+_0x91510b[_0x49b821(0x29f)]),_0x20e61a);throw new Error(_0x49b821(0x2dc)+_0x91510b[_0x49b821(0x29f)]);}console[_0x49b821(0x27f)](_0x49b821(0x29a)+_0x19e0da['id']+_0x49b821(0x20c)+_0x19e0da['status']+_0x49b821(0x24f)+_0x91510b['status']+')');const _0x4f8498={};_0x91510b[_0x49b821(0x289)]&&await database_1[_0x49b821(0x2de)][_0x49b821(0x30b)][_0x49b821(0x224)]({'where':{'id':_0x19e0da['id']},'data':{'amount':_0x91510b[_0x49b821(0x289)],'updatedAt':new Date()}}),_0x91510b[_0x49b821(0x300)]&&await database_1[_0x49b821(0x2de)]['payment']['update']({'where':{'id':_0x19e0da['id']},'data':{'currency':_0x91510b[_0x49b821(0x300)],'updatedAt':new Date()}}),_0x91510b[_0x49b821(0x318)]==='FAILED'&&_0x91510b[_0x49b821(0x260)]&&(_0x4f8498[_0x49b821(0x260)]=_0x91510b[_0x49b821(0x260)],console['log']('❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20'+_0x91510b[_0x49b821(0x260)])),_0x4f8498[_0x49b821(0x2a2)]=_0x49b821(0x29e),await this[_0x49b821(0x240)](_0x19e0da['id'],_0x91510b[_0x49b821(0x318)],_0x4f8498),await database_1[_0x49b821(0x2de)]['webhookLog'][_0x49b821(0x25d)]({'data':{'paymentId':_0x19e0da['id'],'shopId':_0x19e0da['shopId'],'event':'visa_'+_0x91510b[_0x49b821(0x318)][_0x49b821(0x2a5)](),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x91510b)}}),await this[_0x49b821(0x245)](_0x19e0da,_0x91510b[_0x49b821(0x318)]['toUpperCase']()),console[_0x49b821(0x27f)](_0x49b821(0x22f)+_0x19e0da['id']);}catch(_0x4100d3){console['error']('❌\x20VISA\x20webhook\x20processing\x20failed:',_0x4100d3),loggerService_1[_0x49b821(0x28f)][_0x49b821(0x2b6)](_0x49b821(0x29e),_0x4100d3,_0x20e61a);throw _0x4100d3;}}async[a64_0x538c23(0x265)](_0x52a5ad){const _0x1de0bb=a64_0x538c23;console[_0x1de0bb(0x27f)](_0x1de0bb(0x2af),JSON['stringify'](_0x52a5ad,null,0x2));try{const _0x51deea=await this[_0x1de0bb(0x28d)][_0x1de0bb(0x295)](_0x52a5ad,'MASTERCARD');console[_0x1de0bb(0x27f)](_0x1de0bb(0x239),_0x51deea);if(!_0x51deea[_0x1de0bb(0x29f)]){console['error'](_0x1de0bb(0x317)),console[_0x1de0bb(0x30c)](_0x1de0bb(0x243),Object[_0x1de0bb(0x2a4)](_0x52a5ad));throw new Error(_0x1de0bb(0x252));}let _0x47431a=null;console[_0x1de0bb(0x27f)](_0x1de0bb(0x1e7)+_0x51deea['paymentId']);_0x51deea[_0x1de0bb(0x29f)]&&(console[_0x1de0bb(0x27f)](_0x1de0bb(0x2f0)),_0x47431a=await database_1[_0x1de0bb(0x2de)][_0x1de0bb(0x30b)][_0x1de0bb(0x28c)]({'where':{'AND':[{'OR':[{'gateway':_0x1de0bb(0x2bc)},{'gateway':'mastercard'},{'gateway':_0x1de0bb(0x234)}]},{'OR':[{'gatewayPaymentId':_0x51deea[_0x1de0bb(0x29f)]},{'gatewayOrderId':_0x51deea[_0x1de0bb(0x29f)]},{'id':_0x51deea['paymentId']},{'orderId':_0x51deea['paymentId']}]}]}}),console['log'](_0x1de0bb(0x2e0)+(_0x47431a?_0x1de0bb(0x2b1)+_0x47431a['id']:'Payment\x20not\x20found')));if(!_0x47431a){console['error']('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x51deea['paymentId']),console[_0x1de0bb(0x30c)](_0x1de0bb(0x20d)+_0x51deea[_0x1de0bb(0x29f)]+_0x1de0bb(0x2cb)+_0x51deea[_0x1de0bb(0x29f)]+_0x1de0bb(0x20a)+_0x51deea['paymentId']+'\x22');const _0x3aac4e=await database_1['default'][_0x1de0bb(0x30b)][_0x1de0bb(0x27c)]({'where':{'OR':[{'gateway':'mastercard'},{'gateway':_0x1de0bb(0x2bc)},{'gateway':_0x1de0bb(0x234)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x1de0bb(0x305)},'take':0xf});console['log']('🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:',_0x3aac4e),loggerService_1['loggerService'][_0x1de0bb(0x2b6)](_0x1de0bb(0x220),new Error(_0x1de0bb(0x293)+_0x51deea[_0x1de0bb(0x29f)]),_0x52a5ad);throw new Error('MasterCard\x20payment\x20not\x20found:\x20'+_0x51deea[_0x1de0bb(0x29f)]);}console[_0x1de0bb(0x27f)]('✅\x20Found\x20payment\x20'+_0x47431a['id']+_0x1de0bb(0x2ce)+_0x47431a[_0x1de0bb(0x318)]+_0x1de0bb(0x2e9)+_0x51deea[_0x1de0bb(0x318)]);const _0xcb4b25={};_0x51deea[_0x1de0bb(0x289)]&&await database_1[_0x1de0bb(0x2de)][_0x1de0bb(0x30b)][_0x1de0bb(0x224)]({'where':{'id':_0x47431a['id']},'data':{'amount':_0x51deea[_0x1de0bb(0x289)],'updatedAt':new Date()}}),_0x51deea[_0x1de0bb(0x300)]&&await database_1['default'][_0x1de0bb(0x30b)][_0x1de0bb(0x224)]({'where':{'id':_0x47431a['id']},'data':{'currency':_0x51deea[_0x1de0bb(0x300)],'updatedAt':new Date()}}),_0x51deea[_0x1de0bb(0x318)]===_0x1de0bb(0x1f0)&&_0x51deea[_0x1de0bb(0x260)]&&(_0xcb4b25[_0x1de0bb(0x260)]=_0x51deea[_0x1de0bb(0x260)],console[_0x1de0bb(0x27f)](_0x1de0bb(0x1f6)+_0x51deea[_0x1de0bb(0x260)])),_0xcb4b25['paymentMethod']=_0x1de0bb(0x220),await this[_0x1de0bb(0x240)](_0x47431a['id'],_0x51deea['status'],_0xcb4b25),loggerService_1[_0x1de0bb(0x28f)][_0x1de0bb(0x1e6)]('mastercard',_0x47431a['id'],_0x47431a[_0x1de0bb(0x318)],_0x51deea[_0x1de0bb(0x318)],_0x52a5ad);}catch(_0x44a069){console[_0x1de0bb(0x30c)](_0x1de0bb(0x297),_0x44a069),loggerService_1[_0x1de0bb(0x28f)][_0x1de0bb(0x2b6)]('mastercard',_0x44a069,_0x52a5ad);throw _0x44a069;}}async['processAmerWebhook'](_0x2e6aef){const _0x430d78=a64_0x538c23;console[_0x430d78(0x27f)]('🔄\x20Processing\x20Amer\x20webhook:',JSON[_0x430d78(0x246)](_0x2e6aef,null,0x2));try{const _0x5a1d4c=await this['amerService'][_0x430d78(0x295)](_0x2e6aef);console[_0x430d78(0x27f)]('📊\x20Amer\x20webhook\x20result:',_0x5a1d4c);if(!_0x5a1d4c[_0x430d78(0x29f)]){console['error'](_0x430d78(0x2f7)),console[_0x430d78(0x30c)]('❌\x20Available\x20webhook\x20fields:',Object['keys'](_0x2e6aef));throw new Error(_0x430d78(0x1fb));}let _0x49c8ee=null;console['log']('🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x5a1d4c[_0x430d78(0x29f)]),_0x49c8ee=await database_1[_0x430d78(0x2de)][_0x430d78(0x30b)][_0x430d78(0x28c)]({'where':{'AND':[{'gateway':_0x430d78(0x2b7)},{'OR':[{'gatewayPaymentId':_0x5a1d4c[_0x430d78(0x29f)]},{'gatewayOrderId':_0x5a1d4c[_0x430d78(0x29f)]},{'id':_0x5a1d4c['paymentId']},{'orderId':_0x5a1d4c[_0x430d78(0x29f)]}]}]}}),console['log'](_0x430d78(0x2e0)+(_0x49c8ee?_0x430d78(0x2b1)+_0x49c8ee['id']:_0x430d78(0x29d)));if(!_0x49c8ee){console[_0x430d78(0x30c)](_0x430d78(0x248)+_0x5a1d4c['paymentId']);return;}console['log'](_0x430d78(0x232)+_0x49c8ee['id']+_0x430d78(0x2ec)+_0x5a1d4c['status']),await this[_0x430d78(0x240)](_0x49c8ee['id'],_0x5a1d4c['status'],{'cardLast4':_0x5a1d4c[_0x430d78(0x210)]?.[_0x430d78(0x238)],'paymentMethod':_0x5a1d4c[_0x430d78(0x210)]?.[_0x430d78(0x2a2)]});}catch(_0x961cf7){console['error'](_0x430d78(0x225),_0x961cf7),loggerService_1[_0x430d78(0x28f)]['logWebhookError']('amer',_0x961cf7,_0x2e6aef);throw _0x961cf7;}}async[a64_0x538c23(0x2f2)](_0x5bc3a5){const _0xc431d=a64_0x538c23;console[_0xc431d(0x27f)]('🔄\x20Processing\x20AmPay\x20webhook:',JSON[_0xc431d(0x246)](_0x5bc3a5,null,0x2));try{const _0x419dae=_0x5bc3a5[_0xc431d(0x318)],_0x15fad4=_0x5bc3a5['client_transaction_id'],_0x5eddcf=_0x5bc3a5[_0xc431d(0x2fa)],_0x558526=_0x5bc3a5[_0xc431d(0x278)],_0x15f8a0=_0x5bc3a5[_0xc431d(0x289)],_0x19737a=_0x5bc3a5[_0xc431d(0x300)],_0x210a65=_0x5bc3a5[_0xc431d(0x26e)],_0x43f719=_0x5bc3a5['status_addition_info'];if(!_0x15fad4){console[_0xc431d(0x30c)]('❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook');throw new Error(_0xc431d(0x276));}console[_0xc431d(0x27f)](_0xc431d(0x2d8),{'status':_0x419dae,'clientTransactionId':_0x15fad4,'systemId':_0x5eddcf,'paymentMethod':_0x558526,'amount':_0x15f8a0,'currency':_0x19737a,'commission':_0x210a65,'statusAdditionInfo':_0x43f719});const _0x5f6cbc=await database_1[_0xc431d(0x2de)][_0xc431d(0x30b)][_0xc431d(0x28c)]({'where':{'OR':[{'gatewayOrderId':_0x15fad4},{'orderId':_0x15fad4},{'id':_0x15fad4},{'gatewayPaymentId':_0x15fad4}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x5f6cbc){console[_0xc431d(0x30c)](_0xc431d(0x24a)+_0x15fad4);throw new Error(_0xc431d(0x293)+_0x15fad4);}console['log'](_0xc431d(0x23e)+_0x5f6cbc['id']+_0xc431d(0x2fb)),console[_0xc431d(0x27f)](_0xc431d(0x28e)+_0x5f6cbc['status']+'\x20→\x20'+_0x419dae),_0x419dae==='DECLINED'?(console[_0xc431d(0x27f)](_0xc431d(0x219)),await this[_0xc431d(0x240)](_0x5f6cbc['id'],_0xc431d(0x1f0)),console[_0xc431d(0x27f)](_0xc431d(0x26a)+_0x5f6cbc['id']+_0xc431d(0x2b8)),console[_0xc431d(0x27f)](_0xc431d(0x231)+(_0x43f719||_0xc431d(0x202)))):console['log'](_0xc431d(0x315)+_0x419dae+'\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)'),await database_1[_0xc431d(0x2de)][_0xc431d(0x271)]['create']({'data':{'paymentId':_0x5f6cbc['id'],'shopId':_0x5f6cbc[_0xc431d(0x2b2)],'event':_0xc431d(0x27e)+(_0x419dae?.[_0xc431d(0x2a5)]()||_0xc431d(0x30f)),'statusCode':0xc8,'responseBody':JSON[_0xc431d(0x246)](_0x5bc3a5)}}),loggerService_1[_0xc431d(0x28f)][_0xc431d(0x1e6)](_0xc431d(0x2c1),_0x5f6cbc['id'],_0x5f6cbc['status'],_0x419dae===_0xc431d(0x2c6)?_0xc431d(0x1f0):_0x419dae,_0x5bc3a5);}catch(_0x13c3d9){console['error'](_0xc431d(0x236),_0x13c3d9),loggerService_1[_0xc431d(0x28f)][_0xc431d(0x2b6)](_0xc431d(0x2c1),_0x13c3d9,_0x5bc3a5);throw _0x13c3d9;}}async[a64_0x538c23(0x2d0)](_0x4f4a30,_0x3cc262){const _0x2114fc=a64_0x538c23,_0x2d9cbe=Date['now']();try{const _0x45e1d6=_0x4f4a30[_0x2114fc(0x257)],_0x24e987=_0x45e1d6[_0x2114fc(0x2c2)];if(!_0x24e987?.[_0x2114fc(0x2bb)]){console['log'](_0x2114fc(0x2dd)+_0x45e1d6['id']);return;}const _0x31fdb1=_0x3cc262===_0x2114fc(0x241)?'payment.success':_0x3cc262===_0x2114fc(0x1f0)?_0x2114fc(0x2b0):_0x3cc262===_0x2114fc(0x2e1)?'payment.failed':_0x3cc262==='CHARGEBACK'?_0x2114fc(0x2b0):_0x3cc262===_0x2114fc(0x277)?_0x2114fc(0x2b0):_0x2114fc(0x1ff);let _0x128fd5=[];if(_0x24e987['webhookEvents'])try{_0x128fd5=Array[_0x2114fc(0x304)](_0x24e987[_0x2114fc(0x2bd)])?_0x24e987[_0x2114fc(0x2bd)]:JSON[_0x2114fc(0x2d3)](_0x24e987['webhookEvents']);}catch(_0x1fc82c){console[_0x2114fc(0x30c)](_0x2114fc(0x2b5),_0x1fc82c),_0x128fd5=[];}if(!_0x128fd5[_0x2114fc(0x302)](_0x31fdb1)){console[_0x2114fc(0x27f)]('Webhook\x20event\x20'+_0x31fdb1+_0x2114fc(0x301)+_0x45e1d6['id']);return;}const _0x16ae89={'event':_0x31fdb1,'payment':{'id':_0x4f4a30['id'],'order_id':_0x4f4a30['orderId'],'gateway_order_id':_0x4f4a30[_0x2114fc(0x249)],'gateway':_0x4f4a30[_0x2114fc(0x269)],'amount':_0x4f4a30[_0x2114fc(0x289)],'currency':_0x4f4a30[_0x2114fc(0x300)],'status':_0x3cc262[_0x2114fc(0x2a5)](),'customer_email':_0x4f4a30[_0x2114fc(0x26b)],'customer_name':_0x4f4a30[_0x2114fc(0x1f9)],'failure_message':_0x4f4a30[_0x2114fc(0x260)],'tx_urls':_0x4f4a30[_0x2114fc(0x2a7)]?JSON[_0x2114fc(0x2d3)](_0x4f4a30[_0x2114fc(0x2a7)]):null,'created_at':_0x4f4a30[_0x2114fc(0x2c7)],'updated_at':_0x4f4a30[_0x2114fc(0x26d)]}},_0x531a4b=await fetch(_0x24e987[_0x2114fc(0x2bb)],{'method':_0x2114fc(0x2d9),'headers':{'Content-Type':_0x2114fc(0x211),'User-Agent':_0x2114fc(0x1eb)},'body':JSON[_0x2114fc(0x246)](_0x16ae89)}),_0x423895=Date[_0x2114fc(0x2b4)]()-_0x2d9cbe,_0x32d92d=_0x531a4b['ok']?'Success':await _0x531a4b[_0x2114fc(0x1fe)]();loggerService_1[_0x2114fc(0x28f)][_0x2114fc(0x2f8)](_0x4f4a30[_0x2114fc(0x2b2)],_0x24e987[_0x2114fc(0x2bb)],_0x31fdb1,_0x531a4b[_0x2114fc(0x318)],_0x423895,_0x16ae89),console['log'](_0x2114fc(0x282)+_0x24e987[_0x2114fc(0x2bb)]+_0x2114fc(0x2ae)+_0x531a4b[_0x2114fc(0x318)]+'\x20('+_0x423895+_0x2114fc(0x22e));}catch(_0x1230a0){console[_0x2114fc(0x30c)](_0x2114fc(0x2e5),_0x1230a0),loggerService_1[_0x2114fc(0x28f)][_0x2114fc(0x2f4)](_0x4f4a30[_0x2114fc(0x2b2)],_0x4f4a30['shop']?.[_0x2114fc(0x2c2)]?.[_0x2114fc(0x2bb)]||_0x2114fc(0x30f),'webhook_send',_0x1230a0,{});}}async[a64_0x538c23(0x245)](_0x382b7e,_0x13ed35){const _0x554703=a64_0x538c23;try{const _0x1b4202={'PENDING':'created','PROCESSING':'processing','PAID':'paid','FAILED':_0x554703(0x296),'EXPIRED':_0x554703(0x2ff),'REFUND':_0x554703(0x2c4),'CHARGEBACK':_0x554703(0x316)},_0x584a6b=_0x1b4202[_0x13ed35];if(!_0x584a6b||_0x584a6b===_0x554703(0x299))return;await telegramBotService_1[_0x554703(0x1fd)][_0x554703(0x226)](_0x382b7e[_0x554703(0x2b2)],_0x382b7e,_0x584a6b);}catch(_0x4cda45){console[_0x554703(0x30c)](_0x554703(0x1e8),_0x4cda45);}}async[a64_0x538c23(0x2c9)](_0x493bf2,_0x4cd5dc){const _0x1bee82=a64_0x538c23;try{const _0x58d66b=await database_1[_0x1bee82(0x2de)][_0x1bee82(0x257)][_0x1bee82(0x280)]({'where':{'id':_0x493bf2},'select':{'gatewaySettings':!![]}});if(!_0x58d66b?.['gatewaySettings'])return console[_0x1bee82(0x27f)](_0x1bee82(0x314)+_0x493bf2+_0x1bee82(0x214)),0xa;const _0x425d40=JSON[_0x1bee82(0x2d3)](_0x58d66b[_0x1bee82(0x218)]);for(const [_0x1e4cc1,_0x47d79b]of Object[_0x1bee82(0x2f1)](_0x425d40)){if(_0x1e4cc1[_0x1bee82(0x2a5)]()===_0x4cd5dc['toLowerCase']()){const _0xad9647=_0x47d79b[_0x1bee82(0x26e)]||0xa;return console[_0x1bee82(0x27f)](_0x1bee82(0x258)+_0x4cd5dc+'\x20commission\x20for\x20shop\x20'+_0x493bf2+':\x20'+_0xad9647+'%'),_0xad9647;}}return console[_0x1bee82(0x27f)](_0x1bee82(0x2e6)+_0x4cd5dc+_0x1bee82(0x273)+_0x493bf2+',\x20using\x20default\x2010%'),0xa;}catch(_0xd00fc3){return console['error'](_0x1bee82(0x24d)+_0x493bf2+_0x1bee82(0x25f)+_0x4cd5dc+':',_0xd00fc3),0xa;}}async[a64_0x538c23(0x250)](_0x48e0c8,_0x536020){const _0xf5596b=a64_0x538c23;console[_0xf5596b(0x27f)]('🔄\x20Processing\x20MyXSpend\x20webhook:'),console[_0xf5596b(0x27f)](_0xf5596b(0x298),JSON[_0xf5596b(0x246)](_0x48e0c8,null,0x2)),console[_0xf5596b(0x27f)](_0xf5596b(0x206),JSON['stringify'](_0x536020,null,0x2));try{const _0x898803=_0x48e0c8[_0xf5596b(0x284)]||_0x536020[_0xf5596b(0x284)],_0x147d33=_0x48e0c8['status']||_0x536020['status'],_0x11a8c3=_0x48e0c8[_0xf5596b(0x289)]||_0x536020[_0xf5596b(0x289)],_0x3cd453=_0x48e0c8[_0xf5596b(0x300)]||_0x536020['currency'],_0x5c264e=_0x48e0c8[_0xf5596b(0x2f5)]||_0x536020[_0xf5596b(0x2f5)];if(!_0x898803){console['error'](_0xf5596b(0x251));throw new Error(_0xf5596b(0x2db));}console[_0xf5596b(0x27f)](_0xf5596b(0x1ee),{'customerOrderId':_0x898803,'status':_0x147d33,'amount':_0x11a8c3,'currency':_0x3cd453,'dateTime':_0x5c264e});const _0x4dc56a=await database_1[_0xf5596b(0x2de)][_0xf5596b(0x30b)][_0xf5596b(0x28c)]({'where':{'OR':[{'gatewayOrderId':_0x898803},{'orderId':_0x898803},{'id':_0x898803},{'gatewayPaymentId':_0x898803}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x4dc56a){console[_0xf5596b(0x30c)]('❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20'+_0x898803);throw new Error(_0xf5596b(0x293)+_0x898803);}console['log'](_0xf5596b(0x23e)+_0x4dc56a['id']+_0xf5596b(0x2e2)),console['log'](_0xf5596b(0x28e)+_0x4dc56a[_0xf5596b(0x318)]+'\x20→\x20'+_0x147d33);let _0x52d14c=_0x147d33?.[_0xf5596b(0x266)]();_0x147d33===_0xf5596b(0x1f0)||_0x147d33===_0xf5596b(0x2e1)?(_0x52d14c=_0xf5596b(0x1f0),console[_0xf5596b(0x27f)](_0xf5596b(0x2e3)+_0x147d33+_0xf5596b(0x21a)),await this[_0xf5596b(0x240)](_0x4dc56a['id'],_0x52d14c),console[_0xf5596b(0x27f)](_0xf5596b(0x256)+_0x4dc56a['id']+_0xf5596b(0x2b8))):console['log'](_0xf5596b(0x2ac)+_0x147d33+_0xf5596b(0x2b3)),await database_1['default'][_0xf5596b(0x271)][_0xf5596b(0x25d)]({'data':{'paymentId':_0x4dc56a['id'],'shopId':_0x4dc56a[_0xf5596b(0x2b2)],'event':'myxspend_'+(_0x147d33?.[_0xf5596b(0x2a5)]()||_0xf5596b(0x30f)),'statusCode':0xc8,'responseBody':JSON['stringify']({'queryParams':_0x48e0c8,'bodyData':_0x536020})}}),loggerService_1[_0xf5596b(0x28f)][_0xf5596b(0x1e6)](_0xf5596b(0x2ba),_0x4dc56a['id'],_0x4dc56a[_0xf5596b(0x318)],_0x52d14c||_0x147d33,{'queryParams':_0x48e0c8,'bodyData':_0x536020});}catch(_0x11c406){console[_0xf5596b(0x30c)](_0xf5596b(0x2d6),_0x11c406),loggerService_1[_0xf5596b(0x28f)]['logWebhookError'](_0xf5596b(0x2ba),_0x11c406,{'queryParams':_0x48e0c8,'bodyData':_0x536020});throw _0x11c406;}}}exports[a64_0x538c23(0x313)]=WebhookService;