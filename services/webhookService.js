'use strict';const a57_0x5a7722=a57_0x5c33;(function(_0x5c2bd5,_0x1d6a7c){const _0x21796=a57_0x5c33,_0x539e3e=_0x5c2bd5();while(!![]){try{const _0x2a65db=-parseInt(_0x21796(0x174))/0x1*(parseInt(_0x21796(0x186))/0x2)+-parseInt(_0x21796(0x1a8))/0x3+-parseInt(_0x21796(0x1ae))/0x4*(parseInt(_0x21796(0x140))/0x5)+parseInt(_0x21796(0x1ca))/0x6+-parseInt(_0x21796(0x161))/0x7*(parseInt(_0x21796(0x1c9))/0x8)+-parseInt(_0x21796(0x185))/0x9*(parseInt(_0x21796(0x166))/0xa)+parseInt(_0x21796(0x153))/0xb;if(_0x2a65db===_0x1d6a7c)break;else _0x539e3e['push'](_0x539e3e['shift']());}catch(_0x488bbf){_0x539e3e['push'](_0x539e3e['shift']());}}}(a57_0x3234,0xb6df0));var __importDefault=this&&this['__importDefault']||function(_0x5bbcb9){const _0xc99131=a57_0x5c33;return _0x5bbcb9&&_0x5bbcb9[_0xc99131(0x18e)]?_0x5bbcb9:{'default':_0x5bbcb9};};function a57_0x5c33(_0x52a3ab,_0x2882b9){const _0x323429=a57_0x3234();return a57_0x5c33=function(_0x5c3387,_0x2ce8cf){_0x5c3387=_0x5c3387-0x136;let _0x59fe9d=_0x323429[_0x5c3387];return _0x59fe9d;},a57_0x5c33(_0x52a3ab,_0x2882b9);}function a57_0x3234(){const _0x1f52cf=['Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','\x20not\x20found','refund','\x20and\x20-','🔄\x20Processing\x20MasterCard\x20webhook:','payment_method','processCoinToPayWebhook','WebhookService','🔄\x20Updating\x20payment\x20','$transaction','settings','rapyd','240270nHSiJR','Error\x20processing\x20Plisio\x20webhook:','masterCardService','Error\x20processing\x20MasterCard\x20webhook:','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','webhook_status_change_','logWebhookError','Error\x20processing\x20Noda\x20webhook:','username','processWebhook','logShopWebhookError','log','Failed\x20to\x20send\x20shop\x20webhook:','💰\x20Adding\x20to\x20balance:\x20','paymentId','\x20=\x20','stringify','plisio_gateway','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','23252581wTdAGk','../config/database','payment.pending','webhookEvents','klyme','bankId','findFirst','🔄\x20Processing\x20Rapyd\x20webhook:','created','No\x20payment\x20ID\x20in\x20Noda\x20webhook','toLowerCase','payment.success','\x20->\x20','🔄\x20Processing\x20Noda\x20webhook:','119378Omxjcp','Success','ms)','failed','remitterIban','527120eLCHEd','loggerService','plisioService','✅\x20Shop\x20','📝\x20Reason:\x20','processRapydWebhook','cointopay','💰\x20Removing\x20from\x20balance:\x20','./gateways/rapydService','📊\x20Noda\x20webhook:\x20Payment\x20','📊\x20CoinToPay\x20webhook:\x20Payment\x20','customerName','customerEmail','processNodaWebhook','1bFxsIz','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','paidAt','chargeback','chargebackAmount','orderId','Payment\x20','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','💰\x20Converting\x20','no\x20balance\x20change','processMasterCardWebhook','amountUSDT','currency','Error\x20processing\x20KLYME\x20webhook:','Payment\x20not\x20found\x20for\x20MasterCard\x20webhook:\x20','mastercard','Webhook\x20event\x20','9aKrPFS','1000394AWHUsF','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','klymeService','parse','sendShopWebhook','Error\x20parsing\x20webhook\x20events:','error','logWebhookProcessed','__esModule','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','NodaService','webhookLog','FAILED','cardLast4','\x20-\x20','Error\x20processing\x20Rapyd\x20webhook:','now','defineProperty','payment','processing','RapydService','🔄\x20Processing\x20Plisio\x20webhook:','shopId','failureMessage','processPlisioGatewayWebhook','nodaService','sendPaymentStatusNotification','system','webhookUrl','./gateways/plisioService','📊\x20Rapyd\x20webhook:\x20Payment\x20','updatedAt','amount','CHARGEBACK','759624mWDhFN','MasterCardService','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','POST','create','paid','28NBABqC','PAID','\x20not\x20enabled\x20for\x20shop\x20','status','logShopWebhookSent','default','convertToUSDT','update','./gateways/coinToPayService','EXPIRED','payment.failed','./currencyService','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','rapydService','./gateways/nodaService','webhook_send','shop','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','toUpperCase','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','\x20status\x20','paymentMethod','additionalInfo','\x20USDT','sendPaymentNotification','isArray','./telegramBotService','224SiioCd','1531056qIVrIK','updatePaymentStatus','\x20status\x20to\x20','\x20balance\x20updated:\x20','Error\x20processing\x20CoinToPay\x20webhook:','toFixed','💰\x20Payment\x20','txUrls','balance','includes','plisio','processPlisioWebhook','📊\x20MasterCard\x20webhook:\x20Payment\x20','remitterName','coinToPayService','noda','\x20USDT\x20(chargeback\x20penalty)','telegramBotService','processKlymeWebhook'];a57_0x3234=function(){return _0x1f52cf;};return a57_0x3234();}Object[a57_0x5a7722(0x197)](exports,a57_0x5a7722(0x18e),{'value':!![]}),exports[a57_0x5a7722(0x13b)]=void 0x0;const database_1=__importDefault(require(a57_0x5a7722(0x154))),plisioService_1=require(a57_0x5a7722(0x1a3)),rapydService_1=require(a57_0x5a7722(0x16e)),nodaService_1=require(a57_0x5a7722(0x1bc)),coinToPayService_1=require(a57_0x5a7722(0x1b6)),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require('./gateways/mastercardService'),telegramBotService_1=require(a57_0x5a7722(0x1c8)),currencyService_1=require(a57_0x5a7722(0x1b9)),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x418977=a57_0x5a7722;this[_0x418977(0x168)]=new plisioService_1['PlisioService'](),this[_0x418977(0x1bb)]=new rapydService_1[(_0x418977(0x19a))](),this[_0x418977(0x19f)]=new nodaService_1[(_0x418977(0x190))](),this[_0x418977(0x1d8)]=new coinToPayService_1['CoinToPayService'](),this[_0x418977(0x188)]=new klymeService_1['KlymeService'](),this['masterCardService']=new mastercardService_1[(_0x418977(0x1a9))]();}async[a57_0x5a7722(0x1cb)](_0x5b1d4c,_0xd5cbcd,_0x585f95){const _0x18d4b4=a57_0x5a7722;console['log'](_0x18d4b4(0x13c)+_0x5b1d4c+_0x18d4b4(0x1cc)+_0xd5cbcd),await database_1['default'][_0x18d4b4(0x13d)](async _0x3a9035=>{const _0x148a66=_0x18d4b4,_0x3bd32f=await _0x3a9035['payment']['findUnique']({'where':{'id':_0x5b1d4c},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3bd32f)throw new Error(_0x148a66(0x17a)+_0x5b1d4c+_0x148a66(0x1de));const _0xefb4f6=_0x3bd32f[_0x148a66(0x1b1)],_0x4d4e44=_0x3bd32f[_0x148a66(0x1be)];console[_0x148a66(0x14b)](_0x148a66(0x1d0)+_0x5b1d4c+':\x20'+_0xefb4f6+_0x148a66(0x15f)+_0xd5cbcd),console[_0x148a66(0x14b)]('🏪\x20Shop\x20'+_0x4d4e44['username']+'\x20current\x20balance:\x20'+_0x4d4e44[_0x148a66(0x1d2)]+_0x148a66(0x1c5));const _0x20b221={'status':_0xd5cbcd[_0x148a66(0x1c0)](),'updatedAt':new Date(),'statusChangedBy':_0x148a66(0x1a1),'statusChangedAt':new Date()};_0x585f95?.[_0x148a66(0x19d)]&&(_0x20b221[_0x148a66(0x19d)]=_0x585f95['failureMessage']);_0x585f95?.[_0x148a66(0x1d1)]&&(_0x20b221[_0x148a66(0x1d1)]=JSON['stringify'](_0x585f95[_0x148a66(0x1d1)]));_0x585f95?.['cardLast4']&&(_0x20b221[_0x148a66(0x193)]=_0x585f95[_0x148a66(0x193)]);_0x585f95?.[_0x148a66(0x1c3)]&&(_0x20b221['paymentMethod']=_0x585f95[_0x148a66(0x1c3)]);_0x585f95?.[_0x148a66(0x158)]&&(_0x20b221[_0x148a66(0x158)]=_0x585f95[_0x148a66(0x158)]);_0x585f95?.['remitterIban']&&(_0x20b221[_0x148a66(0x165)]=_0x585f95[_0x148a66(0x165)]);_0x585f95?.['remitterName']&&(_0x20b221['remitterName']=_0x585f95[_0x148a66(0x1d7)]);let _0x8ab6da=_0x4d4e44[_0x148a66(0x1d2)],_0x371404='';if(_0xd5cbcd[_0x148a66(0x1c0)]()===_0x148a66(0x1af)&&_0xefb4f6!==_0x148a66(0x1af)){const _0x4e15b9=await currencyService_1['currencyService'][_0x148a66(0x1b4)](_0x3bd32f[_0x148a66(0x1a6)],_0x3bd32f[_0x148a66(0x180)]);_0x8ab6da+=_0x4e15b9,_0x371404='+'+_0x4e15b9[_0x148a66(0x1cf)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID)',_0x20b221['amountUSDT']=_0x4e15b9,_0x20b221[_0x148a66(0x176)]=new Date(),console[_0x148a66(0x14b)](_0x148a66(0x17c)+_0x3bd32f['amount']+'\x20'+_0x3bd32f[_0x148a66(0x180)]+_0x148a66(0x15f)+_0x4e15b9[_0x148a66(0x1cf)](0x6)+_0x148a66(0x1c5)),console[_0x148a66(0x14b)](_0x148a66(0x14d)+_0x4d4e44[_0x148a66(0x1d2)]+'\x20+\x20'+_0x4e15b9[_0x148a66(0x1cf)](0x6)+_0x148a66(0x14f)+_0x8ab6da[_0x148a66(0x1cf)](0x6)+_0x148a66(0x1c5));}else{if(_0xefb4f6===_0x148a66(0x1af)&&_0xd5cbcd[_0x148a66(0x1c0)]()!==_0x148a66(0x1af)){const _0x2a3782=_0x3bd32f[_0x148a66(0x17f)];_0x2a3782&&(_0x8ab6da-=_0x2a3782,_0x371404='-'+_0x2a3782['toFixed'](0x6)+_0x148a66(0x187),_0x20b221['amountUSDT']=null,_0x20b221[_0x148a66(0x176)]=null,console[_0x148a66(0x14b)](_0x148a66(0x16d)+_0x4d4e44[_0x148a66(0x1d2)]+_0x148a66(0x194)+_0x2a3782['toFixed'](0x6)+_0x148a66(0x14f)+_0x8ab6da['toFixed'](0x6)+_0x148a66(0x1c5)));}}if(_0xd5cbcd['toUpperCase']()==='CHARGEBACK'){const _0x1f4bf2=_0x585f95?.[_0x148a66(0x178)]||0x0;_0x1f4bf2>0x0&&(_0x8ab6da-=_0x1f4bf2,_0x371404+=_0x148a66(0x137)+_0x1f4bf2[_0x148a66(0x1cf)](0x6)+_0x148a66(0x1da),_0x20b221[_0x148a66(0x178)]=_0x1f4bf2,console[_0x148a66(0x14b)]('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0x1f4bf2[_0x148a66(0x1cf)](0x6)+'\x20USDT'),console[_0x148a66(0x14b)]('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x8ab6da['toFixed'](0x6)+_0x148a66(0x1c5)));}const _0xf962df=await _0x3a9035['payment']['update']({'where':{'id':_0x5b1d4c},'data':_0x20b221});_0x8ab6da!==_0x4d4e44[_0x148a66(0x1d2)]&&(await _0x3a9035[_0x148a66(0x1be)][_0x148a66(0x1b5)]({'where':{'id':_0x4d4e44['id']},'data':{'balance':_0x8ab6da}}),console[_0x148a66(0x14b)](_0x148a66(0x169)+_0x4d4e44[_0x148a66(0x148)]+_0x148a66(0x1cd)+_0x4d4e44[_0x148a66(0x1d2)][_0x148a66(0x1cf)](0x6)+_0x148a66(0x15f)+_0x8ab6da[_0x148a66(0x1cf)](0x6)+_0x148a66(0x1c5)),console[_0x148a66(0x14b)](_0x148a66(0x16a)+_0x371404)),await _0x3a9035[_0x148a66(0x191)][_0x148a66(0x1ac)]({'data':{'paymentId':_0x5b1d4c,'shopId':_0x4d4e44['id'],'event':_0x148a66(0x145)+_0xd5cbcd['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x148a66(0x150)]({'oldStatus':_0xefb4f6,'newStatus':_0xd5cbcd[_0x148a66(0x1c0)](),'balanceChange':_0x371404||_0x148a66(0x17d),'oldBalance':_0x4d4e44[_0x148a66(0x1d2)],'newBalance':_0x8ab6da,'amountUSDT':_0x20b221[_0x148a66(0x17f)],'additionalData':_0x585f95,'timestamp':new Date()['toISOString']()})}}),await this[_0x148a66(0x18a)]({..._0x3bd32f,..._0xf962df,'shop':_0x4d4e44},_0xd5cbcd[_0x148a66(0x1c0)]()),await this[_0x148a66(0x1a0)]({..._0x3bd32f,..._0xf962df},_0xd5cbcd['toUpperCase']());});}async[a57_0x5a7722(0x1d5)](_0x29660a){const _0x52a87b=a57_0x5a7722;console[_0x52a87b(0x14b)](_0x52a87b(0x19b),_0x29660a);try{const _0x29c946=await this[_0x52a87b(0x168)][_0x52a87b(0x149)](_0x29660a);if(!_0x29c946['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x495e1c=await database_1['default']['payment'][_0x52a87b(0x159)]({'where':{'gatewayOrderId':_0x29c946[_0x52a87b(0x14e)]}});if(!_0x495e1c){console['error'](_0x52a87b(0x1bf)+_0x29c946[_0x52a87b(0x14e)]);return;}console[_0x52a87b(0x14b)]('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0x495e1c['id']+_0x52a87b(0x1c2)+_0x29c946[_0x52a87b(0x1b1)]),await this[_0x52a87b(0x1cb)](_0x495e1c['id'],_0x29c946['status'],{'txUrls':_0x29c946[_0x52a87b(0x1d1)]}),loggerService_1['loggerService'][_0x52a87b(0x18d)](_0x52a87b(0x1d4),_0x495e1c['id'],_0x495e1c[_0x52a87b(0x1b1)],_0x29c946[_0x52a87b(0x1b1)],_0x29660a);}catch(_0x5aedd9){console[_0x52a87b(0x18c)](_0x52a87b(0x141),_0x5aedd9),loggerService_1['loggerService']['logWebhookError'](_0x52a87b(0x1d4),_0x5aedd9,_0x29660a);throw _0x5aedd9;}}async[a57_0x5a7722(0x19e)](_0x3652b3){const _0x459baf=a57_0x5a7722;console[_0x459baf(0x14b)](_0x459baf(0x175),_0x3652b3);try{const _0x819689=await this[_0x459baf(0x168)][_0x459baf(0x149)](_0x3652b3);if(!_0x819689[_0x459baf(0x14e)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x1c62e4=await database_1[_0x459baf(0x1b3)][_0x459baf(0x198)]['findFirst']({'where':{'gatewayOrderId':_0x819689[_0x459baf(0x14e)]}});if(!_0x1c62e4){console['error'](_0x459baf(0x1dd)+_0x819689[_0x459baf(0x14e)]);return;}console[_0x459baf(0x14b)]('📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20'+_0x1c62e4['id']+_0x459baf(0x1c2)+_0x819689[_0x459baf(0x1b1)]),await this[_0x459baf(0x1cb)](_0x1c62e4['id'],_0x819689[_0x459baf(0x1b1)],{'txUrls':_0x819689['txUrls']}),loggerService_1[_0x459baf(0x167)]['logWebhookProcessed'](_0x459baf(0x151),_0x1c62e4['id'],_0x1c62e4[_0x459baf(0x1b1)],_0x819689['status'],_0x3652b3);}catch(_0xea7279){console['error'](_0x459baf(0x152),_0xea7279),loggerService_1[_0x459baf(0x167)][_0x459baf(0x146)](_0x459baf(0x151),_0xea7279,_0x3652b3);throw _0xea7279;}}async[a57_0x5a7722(0x16b)](_0x5965b9){const _0x5e2bb5=a57_0x5a7722;console[_0x5e2bb5(0x14b)](_0x5e2bb5(0x15a),_0x5965b9);try{const _0x4b0995=await this['rapydService'][_0x5e2bb5(0x149)](_0x5965b9);if(!_0x4b0995[_0x5e2bb5(0x14e)])throw new Error(_0x5e2bb5(0x1ba));const _0x5a93c9=await database_1[_0x5e2bb5(0x1b3)][_0x5e2bb5(0x198)][_0x5e2bb5(0x159)]({'where':{'gatewayOrderId':_0x4b0995[_0x5e2bb5(0x14e)]}});if(!_0x5a93c9){console['error']('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x4b0995[_0x5e2bb5(0x14e)]);return;}console[_0x5e2bb5(0x14b)](_0x5e2bb5(0x1a4)+_0x5a93c9['id']+_0x5e2bb5(0x1c2)+_0x4b0995['status']),await this[_0x5e2bb5(0x1cb)](_0x5a93c9['id'],_0x4b0995['status'],{'failureMessage':_0x4b0995[_0x5e2bb5(0x19d)],'cardLast4':_0x4b0995['additionalInfo']?.[_0x5e2bb5(0x193)],'paymentMethod':_0x4b0995[_0x5e2bb5(0x1c4)]?.[_0x5e2bb5(0x1c3)]}),loggerService_1['loggerService'][_0x5e2bb5(0x18d)](_0x5e2bb5(0x13f),_0x5a93c9['id'],_0x5a93c9[_0x5e2bb5(0x1b1)],_0x4b0995['status'],_0x5965b9);}catch(_0x3ad57d){console['error'](_0x5e2bb5(0x195),_0x3ad57d),loggerService_1[_0x5e2bb5(0x167)][_0x5e2bb5(0x146)](_0x5e2bb5(0x13f),_0x3ad57d,_0x5965b9);throw _0x3ad57d;}}async[a57_0x5a7722(0x173)](_0x50ae61){const _0x1e1008=a57_0x5a7722;console['log'](_0x1e1008(0x160),_0x50ae61);try{const _0x192f6e=await this[_0x1e1008(0x19f)][_0x1e1008(0x149)](_0x50ae61);if(!_0x192f6e[_0x1e1008(0x14e)])throw new Error(_0x1e1008(0x15c));const _0x3cc6cc=await database_1[_0x1e1008(0x1b3)][_0x1e1008(0x198)][_0x1e1008(0x159)]({'where':{'gatewayOrderId':_0x192f6e[_0x1e1008(0x14e)]}});if(!_0x3cc6cc){console[_0x1e1008(0x18c)](_0x1e1008(0x144)+_0x192f6e[_0x1e1008(0x14e)]);return;}console['log'](_0x1e1008(0x16f)+_0x3cc6cc['id']+_0x1e1008(0x1c2)+_0x192f6e[_0x1e1008(0x1b1)]),await this[_0x1e1008(0x1cb)](_0x3cc6cc['id'],_0x192f6e[_0x1e1008(0x1b1)],{'bankId':_0x192f6e[_0x1e1008(0x1c4)]?.[_0x1e1008(0x158)],'remitterIban':_0x192f6e['additionalInfo']?.[_0x1e1008(0x165)],'remitterName':_0x192f6e['additionalInfo']?.[_0x1e1008(0x1d7)]}),loggerService_1[_0x1e1008(0x167)]['logWebhookProcessed'](_0x1e1008(0x1d9),_0x3cc6cc['id'],_0x3cc6cc[_0x1e1008(0x1b1)],_0x192f6e[_0x1e1008(0x1b1)],_0x50ae61);}catch(_0x172fce){console[_0x1e1008(0x18c)](_0x1e1008(0x147),_0x172fce),loggerService_1[_0x1e1008(0x167)][_0x1e1008(0x146)](_0x1e1008(0x1d9),_0x172fce,_0x50ae61);throw _0x172fce;}}async[a57_0x5a7722(0x13a)](_0x2bbf3c){const _0x5b24cb=a57_0x5a7722;console[_0x5b24cb(0x14b)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x2bbf3c);try{const _0x29573f=await this['coinToPayService'][_0x5b24cb(0x149)](_0x2bbf3c);if(!_0x29573f[_0x5b24cb(0x14e)])throw new Error(_0x5b24cb(0x1aa));const _0x4e9d38=await database_1[_0x5b24cb(0x1b3)][_0x5b24cb(0x198)][_0x5b24cb(0x159)]({'where':{'gatewayOrderId':_0x29573f[_0x5b24cb(0x14e)]}});if(!_0x4e9d38){console['error'](_0x5b24cb(0x18f)+_0x29573f[_0x5b24cb(0x14e)]);return;}console[_0x5b24cb(0x14b)](_0x5b24cb(0x170)+_0x4e9d38['id']+_0x5b24cb(0x1c2)+_0x29573f['status']),await this[_0x5b24cb(0x1cb)](_0x4e9d38['id'],_0x29573f['status']),loggerService_1[_0x5b24cb(0x167)][_0x5b24cb(0x18d)](_0x5b24cb(0x16c),_0x4e9d38['id'],_0x4e9d38[_0x5b24cb(0x1b1)],_0x29573f['status'],_0x2bbf3c);}catch(_0xc0472){console['error'](_0x5b24cb(0x1ce),_0xc0472),loggerService_1[_0x5b24cb(0x167)][_0x5b24cb(0x146)](_0x5b24cb(0x16c),_0xc0472,_0x2bbf3c);throw _0xc0472;}}async[a57_0x5a7722(0x1dc)](_0x318a44){const _0x2408ed=a57_0x5a7722;console[_0x2408ed(0x14b)]('🔄\x20Processing\x20KLYME\x20webhook:',_0x318a44);try{const _0x2e1a51=await this['klymeService'][_0x2408ed(0x149)](_0x318a44);if(!_0x2e1a51[_0x2408ed(0x14e)])throw new Error(_0x2408ed(0x17b));const _0x10bb8b=await database_1[_0x2408ed(0x1b3)][_0x2408ed(0x198)][_0x2408ed(0x159)]({'where':{'gatewayOrderId':_0x2e1a51['paymentId']}});if(!_0x10bb8b){console[_0x2408ed(0x18c)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x2e1a51[_0x2408ed(0x14e)]);return;}console[_0x2408ed(0x14b)]('📊\x20KLYME\x20webhook:\x20Payment\x20'+_0x10bb8b['id']+_0x2408ed(0x1c2)+_0x2e1a51[_0x2408ed(0x1b1)]),await this[_0x2408ed(0x1cb)](_0x10bb8b['id'],_0x2e1a51['status'],{'paymentMethod':_0x2e1a51[_0x2408ed(0x1c4)]?.[_0x2408ed(0x139)]}),loggerService_1[_0x2408ed(0x167)]['logWebhookProcessed'](_0x2408ed(0x157),_0x10bb8b['id'],_0x10bb8b[_0x2408ed(0x1b1)],_0x2e1a51[_0x2408ed(0x1b1)],_0x318a44);}catch(_0x441600){console[_0x2408ed(0x18c)](_0x2408ed(0x181),_0x441600),loggerService_1[_0x2408ed(0x167)]['logWebhookError'](_0x2408ed(0x157),_0x441600,_0x318a44);throw _0x441600;}}async[a57_0x5a7722(0x17e)](_0x47feba){const _0x36a628=a57_0x5a7722;console['log'](_0x36a628(0x138),_0x47feba);try{const _0x14f7af=await this[_0x36a628(0x142)]['processWebhook'](_0x47feba);if(!_0x14f7af['paymentId'])throw new Error(_0x36a628(0x1c1));const _0x28613d=await database_1[_0x36a628(0x1b3)][_0x36a628(0x198)][_0x36a628(0x159)]({'where':{'gatewayOrderId':_0x14f7af['paymentId']}});if(!_0x28613d){console[_0x36a628(0x18c)](_0x36a628(0x182)+_0x14f7af[_0x36a628(0x14e)]);return;}console['log'](_0x36a628(0x1d6)+_0x28613d['id']+'\x20status\x20'+_0x14f7af[_0x36a628(0x1b1)]),await this[_0x36a628(0x1cb)](_0x28613d['id'],_0x14f7af[_0x36a628(0x1b1)]),loggerService_1['loggerService'][_0x36a628(0x18d)]('mastercard',_0x28613d['id'],_0x28613d[_0x36a628(0x1b1)],_0x14f7af[_0x36a628(0x1b1)],_0x47feba);}catch(_0x3e6aab){console[_0x36a628(0x18c)](_0x36a628(0x143),_0x3e6aab),loggerService_1[_0x36a628(0x167)][_0x36a628(0x146)](_0x36a628(0x183),_0x3e6aab,_0x47feba);throw _0x3e6aab;}}async[a57_0x5a7722(0x18a)](_0x5858f7,_0x4a9f4f){const _0x4dd1ec=a57_0x5a7722,_0xc752e9=Date[_0x4dd1ec(0x196)]();try{const _0x58ccd9=_0x5858f7[_0x4dd1ec(0x1be)],_0x421182=_0x58ccd9[_0x4dd1ec(0x13e)];if(!_0x421182?.[_0x4dd1ec(0x1a2)]){console[_0x4dd1ec(0x14b)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x58ccd9['id']);return;}const _0x1751bd=_0x4a9f4f===_0x4dd1ec(0x1af)?_0x4dd1ec(0x15e):_0x4a9f4f===_0x4dd1ec(0x192)?'payment.failed':_0x4a9f4f===_0x4dd1ec(0x1b7)?_0x4dd1ec(0x1b8):_0x4a9f4f===_0x4dd1ec(0x1a7)?_0x4dd1ec(0x1b8):_0x4a9f4f==='REFUND'?_0x4dd1ec(0x1b8):_0x4dd1ec(0x155);let _0x4d9186=[];if(_0x421182[_0x4dd1ec(0x156)])try{_0x4d9186=Array[_0x4dd1ec(0x1c7)](_0x421182[_0x4dd1ec(0x156)])?_0x421182[_0x4dd1ec(0x156)]:JSON[_0x4dd1ec(0x189)](_0x421182[_0x4dd1ec(0x156)]);}catch(_0x5d1415){console[_0x4dd1ec(0x18c)](_0x4dd1ec(0x18b),_0x5d1415),_0x4d9186=[];}if(!_0x4d9186[_0x4dd1ec(0x1d3)](_0x1751bd)){console[_0x4dd1ec(0x14b)](_0x4dd1ec(0x184)+_0x1751bd+_0x4dd1ec(0x1b0)+_0x58ccd9['id']);return;}const _0x2b3544={'event':_0x1751bd,'payment':{'id':_0x5858f7['id'],'order_id':_0x5858f7[_0x4dd1ec(0x179)],'gateway_order_id':_0x5858f7['gatewayOrderId'],'gateway':_0x5858f7['gateway'],'amount':_0x5858f7[_0x4dd1ec(0x1a6)],'currency':_0x5858f7['currency'],'status':_0x4a9f4f[_0x4dd1ec(0x15d)](),'customer_email':_0x5858f7[_0x4dd1ec(0x172)],'customer_name':_0x5858f7[_0x4dd1ec(0x171)],'failure_message':_0x5858f7['failureMessage'],'tx_urls':_0x5858f7[_0x4dd1ec(0x1d1)]?JSON[_0x4dd1ec(0x189)](_0x5858f7['txUrls']):null,'created_at':_0x5858f7['createdAt'],'updated_at':_0x5858f7[_0x4dd1ec(0x1a5)]}},_0x267f26=await fetch(_0x421182[_0x4dd1ec(0x1a2)],{'method':_0x4dd1ec(0x1ab),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x4dd1ec(0x150)](_0x2b3544)}),_0x683254=Date[_0x4dd1ec(0x196)]()-_0xc752e9,_0x29b5b3=_0x267f26['ok']?_0x4dd1ec(0x162):await _0x267f26['text']();loggerService_1[_0x4dd1ec(0x167)][_0x4dd1ec(0x1b2)](_0x5858f7[_0x4dd1ec(0x19c)],_0x421182['webhookUrl'],_0x1751bd,_0x267f26[_0x4dd1ec(0x1b1)],_0x683254,_0x2b3544),console[_0x4dd1ec(0x14b)]('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x421182[_0x4dd1ec(0x1a2)]+'\x20with\x20status\x20'+_0x267f26[_0x4dd1ec(0x1b1)]+'\x20('+_0x683254+_0x4dd1ec(0x163));}catch(_0x6859d8){console[_0x4dd1ec(0x18c)](_0x4dd1ec(0x14c),_0x6859d8),loggerService_1[_0x4dd1ec(0x167)][_0x4dd1ec(0x14a)](_0x5858f7[_0x4dd1ec(0x19c)],_0x5858f7['shop']?.['settings']?.[_0x4dd1ec(0x1a2)]||'unknown',_0x4dd1ec(0x1bd),_0x6859d8,{});}}async[a57_0x5a7722(0x1a0)](_0x47cb1e,_0x233f5b){const _0x4b7792=a57_0x5a7722;try{const _0x3d2cd4={'PENDING':'created','PROCESSING':_0x4b7792(0x199),'PAID':_0x4b7792(0x1ad),'FAILED':_0x4b7792(0x164),'EXPIRED':'expired','REFUND':_0x4b7792(0x136),'CHARGEBACK':_0x4b7792(0x177)},_0x3dc176=_0x3d2cd4[_0x233f5b];if(!_0x3dc176||_0x3dc176===_0x4b7792(0x15b))return;await telegramBotService_1[_0x4b7792(0x1db)][_0x4b7792(0x1c6)](_0x47cb1e['shopId'],_0x47cb1e,_0x3dc176);}catch(_0xfd665e){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0xfd665e);}}}exports[a57_0x5a7722(0x13b)]=WebhookService;