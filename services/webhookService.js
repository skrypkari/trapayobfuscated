'use strict';function a57_0x2c06(_0xe7f3d5,_0x47a811){const _0x421036=a57_0x4210();return a57_0x2c06=function(_0x2c0660,_0x1b84f7){_0x2c0660=_0x2c0660-0x185;let _0x58ba60=_0x421036[_0x2c0660];return _0x58ba60;},a57_0x2c06(_0xe7f3d5,_0x47a811);}const a57_0x502fde=a57_0x2c06;(function(_0x1c7438,_0x29f1dc){const _0x389fab=a57_0x2c06,_0x5e679b=_0x1c7438();while(!![]){try{const _0x1ab6e7=-parseInt(_0x389fab(0x21b))/0x1+-parseInt(_0x389fab(0x1f4))/0x2*(-parseInt(_0x389fab(0x21f))/0x3)+parseInt(_0x389fab(0x1d7))/0x4+parseInt(_0x389fab(0x1b4))/0x5*(parseInt(_0x389fab(0x1d4))/0x6)+parseInt(_0x389fab(0x188))/0x7*(-parseInt(_0x389fab(0x1af))/0x8)+-parseInt(_0x389fab(0x20b))/0x9+parseInt(_0x389fab(0x18e))/0xa;if(_0x1ab6e7===_0x29f1dc)break;else _0x5e679b['push'](_0x5e679b['shift']());}catch(_0x52047c){_0x5e679b['push'](_0x5e679b['shift']());}}}(a57_0x4210,0x5c0a2));function a57_0x4210(){const _0x37b048=['application/json','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','username','masterCardService','loggerService','refund','sendShopWebhook','üí∞\x20Converting\x20','ms)','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','nodaService','remitterName','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','create','\x20and\x20-','currencyService','customerEmail','\x20USDT\x20(payment\x20became\x20PAID)','rapydService','includes','log','\x20USDT','rapyd','klyme','shopId','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','defineProperty','6ySaBYQ','expired','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','1228572LdfVjU','findUnique','üìä\x20Plisio\x20webhook:\x20Payment\x20','üîÑ\x20Processing\x20Plisio\x20webhook:','PAID','chargebackAmount','currency','unknown','gateway','balance','amount','processNodaWebhook','üîÑ\x20Processing\x20Noda\x20webhook:','üìä\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','stringify','convertToUSDT','Error\x20processing\x20Noda\x20webhook:','sendPaymentStatusNotification','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','webhook_send','paidAt','paymentMethod','\x20status\x20to\x20','Success','./loggerService','CHARGEBACK','chargeback','payment','now','34nOqaIT','processRapydWebhook','Error\x20processing\x20Rapyd\x20webhook:','POST','webhookUrl','toLowerCase','processWebhook','failed','remitterIban','amountUSDT','TesSoft\x20Payment\x20System/1.0','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','\x20balance\x20updated:\x20','noda','EXPIRED','\x20=\x20','webhookLog','üí∞\x20Adding\x20to\x20balance:\x20','error','KlymeService','created','\x20-\x20','\x20not\x20enabled\x20for\x20shop\x20','4149774OggAfB','./gateways/klymeService','shop','üí∏\x20Additional\x20chargeback\x20penalty:\x20-','\x20USDT\x20(chargeback\x20penalty)','FAILED','üí∞\x20Final\x20balance\x20after\x20chargeback:\x20','bankId','./gateways/coinToPayService','cointopay','processPlisioGatewayWebhook','updatePaymentStatus','payment.failed','üìä\x20CoinToPay\x20webhook:\x20Payment\x20','MasterCardService','Error\x20parsing\x20webhook\x20events:','249579RcUJCV','üîÑ\x20Processing\x20Plisio\x20Gateway\x20webhook:','update','toUpperCase','64209hJxEFC','\x20->\x20','plisioService','txUrls','failureMessage','mastercard','./currencyService','payment.success','payment.pending','orderId','üí∞\x20Payment\x20','üí∞\x20Removing\x20from\x20balance:\x20','177324dNdCEh','processPlisioWebhook','parse','webhook_status_change_','No\x20payment\x20ID\x20in\x20Noda\x20webhook','__esModule','4952010xXKFSt','toFixed','üìä\x20Rapyd\x20webhook:\x20Payment\x20','additionalInfo','webhookEvents','processing','./gateways/nodaService','\x20+\x20','üîÑ\x20Processing\x20Rapyd\x20webhook:','./gateways/plisioService','logShopWebhookSent','text','üîÑ\x20Processing\x20MasterCard\x20webhook:','klymeService','‚úÖ\x20Shop\x20','processCoinToPayWebhook','settings','logWebhookError','cardLast4','createdAt','system','default','paid','NodaService','\x20status\x20','üîÑ\x20Processing\x20CoinToPay\x20webhook:','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','./gateways/mastercardService','paymentId','logWebhookProcessed','findFirst','coinToPayService','isArray','40yWHGSi','telegramBotService','processMasterCardWebhook','\x20current\x20balance:\x20','Error\x20processing\x20KLYME\x20webhook:','240620fTZaNj','plisio_gateway','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','üîÑ\x20Processing\x20KLYME\x20webhook:','status'];a57_0x4210=function(){return _0x37b048;};return a57_0x4210();}var __importDefault=this&&this['__importDefault']||function(_0x5d92d8){const _0x3bd089=a57_0x2c06;return _0x5d92d8&&_0x5d92d8[_0x3bd089(0x18d)]?_0x5d92d8:{'default':_0x5d92d8};};Object[a57_0x502fde(0x1d3)](exports,a57_0x502fde(0x18d),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a57_0x502fde(0x197)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a57_0x502fde(0x194)),coinToPayService_1=require(a57_0x502fde(0x213)),klymeService_1=require(a57_0x502fde(0x20c)),mastercardService_1=require(a57_0x502fde(0x1a9)),telegramBotService_1=require('./telegramBotService'),currencyService_1=require(a57_0x502fde(0x225)),loggerService_1=require(a57_0x502fde(0x1ef));class WebhookService{constructor(){const _0x1857ab=a57_0x502fde;this[_0x1857ab(0x221)]=new plisioService_1['PlisioService'](),this[_0x1857ab(0x1cb)]=new rapydService_1['RapydService'](),this[_0x1857ab(0x1c3)]=new nodaService_1[(_0x1857ab(0x1a5))](),this[_0x1857ab(0x1ad)]=new coinToPayService_1['CoinToPayService'](),this[_0x1857ab(0x19b)]=new klymeService_1[(_0x1857ab(0x207))](),this[_0x1857ab(0x1bc)]=new mastercardService_1[(_0x1857ab(0x219))]();}async['updatePaymentStatus'](_0x1a0b6d,_0x3fd39,_0x4a0836){const _0x13f4eb=a57_0x502fde;console[_0x13f4eb(0x1cd)]('üîÑ\x20Updating\x20payment\x20'+_0x1a0b6d+_0x13f4eb(0x1ed)+_0x3fd39),await database_1[_0x13f4eb(0x1a3)]['$transaction'](async _0x50425e=>{const _0x307b3d=_0x13f4eb,_0x554007=await _0x50425e[_0x307b3d(0x1f2)][_0x307b3d(0x1d8)]({'where':{'id':_0x1a0b6d},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x554007)throw new Error('Payment\x20'+_0x1a0b6d+'\x20not\x20found');const _0x5eafd7=_0x554007[_0x307b3d(0x1b8)],_0x4f46e3=_0x554007[_0x307b3d(0x20d)];console[_0x307b3d(0x1cd)](_0x307b3d(0x186)+_0x1a0b6d+':\x20'+_0x5eafd7+_0x307b3d(0x220)+_0x3fd39),console['log']('üè™\x20Shop\x20'+_0x4f46e3[_0x307b3d(0x1bb)]+_0x307b3d(0x1b2)+_0x4f46e3['balance']+_0x307b3d(0x1ce));const _0x5473af={'status':_0x3fd39[_0x307b3d(0x21e)](),'updatedAt':new Date(),'statusChangedBy':_0x307b3d(0x1a2),'statusChangedAt':new Date()};_0x4a0836?.[_0x307b3d(0x223)]&&(_0x5473af[_0x307b3d(0x223)]=_0x4a0836['failureMessage']);_0x4a0836?.[_0x307b3d(0x222)]&&(_0x5473af[_0x307b3d(0x222)]=JSON[_0x307b3d(0x1e5)](_0x4a0836[_0x307b3d(0x222)]));_0x4a0836?.[_0x307b3d(0x1a0)]&&(_0x5473af['cardLast4']=_0x4a0836[_0x307b3d(0x1a0)]);_0x4a0836?.[_0x307b3d(0x1ec)]&&(_0x5473af['paymentMethod']=_0x4a0836[_0x307b3d(0x1ec)]);_0x4a0836?.[_0x307b3d(0x212)]&&(_0x5473af[_0x307b3d(0x212)]=_0x4a0836[_0x307b3d(0x212)]);_0x4a0836?.[_0x307b3d(0x1fc)]&&(_0x5473af[_0x307b3d(0x1fc)]=_0x4a0836[_0x307b3d(0x1fc)]);_0x4a0836?.[_0x307b3d(0x1c4)]&&(_0x5473af[_0x307b3d(0x1c4)]=_0x4a0836['remitterName']);let _0x3839a7=_0x4f46e3[_0x307b3d(0x1e0)],_0x315d4a='';if(_0x3fd39[_0x307b3d(0x21e)]()==='PAID'&&_0x5eafd7!==_0x307b3d(0x1db)){const _0x2e55d8=await currencyService_1[_0x307b3d(0x1c8)][_0x307b3d(0x1e6)](_0x554007[_0x307b3d(0x1e1)],_0x554007[_0x307b3d(0x1dd)]);_0x3839a7+=_0x2e55d8,_0x315d4a='+'+_0x2e55d8[_0x307b3d(0x18f)](0x6)+_0x307b3d(0x1ca),_0x5473af[_0x307b3d(0x1fd)]=_0x2e55d8,_0x5473af['paidAt']=new Date(),console[_0x307b3d(0x1cd)](_0x307b3d(0x1c0)+_0x554007[_0x307b3d(0x1e1)]+'\x20'+_0x554007[_0x307b3d(0x1dd)]+_0x307b3d(0x220)+_0x2e55d8[_0x307b3d(0x18f)](0x6)+_0x307b3d(0x1ce)),console['log'](_0x307b3d(0x205)+_0x4f46e3[_0x307b3d(0x1e0)]+_0x307b3d(0x195)+_0x2e55d8[_0x307b3d(0x18f)](0x6)+_0x307b3d(0x203)+_0x3839a7[_0x307b3d(0x18f)](0x6)+_0x307b3d(0x1ce));}else{if(_0x5eafd7===_0x307b3d(0x1db)&&_0x3fd39[_0x307b3d(0x21e)]()!=='PAID'){const _0x41aea3=_0x554007[_0x307b3d(0x1fd)];_0x41aea3&&(_0x3839a7-=_0x41aea3,_0x315d4a='-'+_0x41aea3[_0x307b3d(0x18f)](0x6)+_0x307b3d(0x1c5),_0x5473af[_0x307b3d(0x1fd)]=null,_0x5473af[_0x307b3d(0x1eb)]=null,console[_0x307b3d(0x1cd)](_0x307b3d(0x187)+_0x4f46e3[_0x307b3d(0x1e0)]+_0x307b3d(0x209)+_0x41aea3[_0x307b3d(0x18f)](0x6)+_0x307b3d(0x203)+_0x3839a7[_0x307b3d(0x18f)](0x6)+_0x307b3d(0x1ce)));}}if(_0x3fd39[_0x307b3d(0x21e)]()==='CHARGEBACK'){const _0x112afa=_0x4a0836?.[_0x307b3d(0x1dc)]||0x0;_0x112afa>0x0&&(_0x3839a7-=_0x112afa,_0x315d4a+=_0x307b3d(0x1c7)+_0x112afa[_0x307b3d(0x18f)](0x6)+_0x307b3d(0x20f),_0x5473af[_0x307b3d(0x1dc)]=_0x112afa,console[_0x307b3d(0x1cd)](_0x307b3d(0x20e)+_0x112afa['toFixed'](0x6)+_0x307b3d(0x1ce)),console[_0x307b3d(0x1cd)](_0x307b3d(0x211)+_0x3839a7[_0x307b3d(0x18f)](0x6)+_0x307b3d(0x1ce)));}const _0x5c90cc=await _0x50425e[_0x307b3d(0x1f2)][_0x307b3d(0x21d)]({'where':{'id':_0x1a0b6d},'data':_0x5473af});_0x3839a7!==_0x4f46e3[_0x307b3d(0x1e0)]&&(await _0x50425e[_0x307b3d(0x20d)][_0x307b3d(0x21d)]({'where':{'id':_0x4f46e3['id']},'data':{'balance':_0x3839a7}}),console[_0x307b3d(0x1cd)](_0x307b3d(0x19c)+_0x4f46e3[_0x307b3d(0x1bb)]+_0x307b3d(0x200)+_0x4f46e3['balance'][_0x307b3d(0x18f)](0x6)+_0x307b3d(0x220)+_0x3839a7[_0x307b3d(0x18f)](0x6)+_0x307b3d(0x1ce)),console['log']('üìù\x20Reason:\x20'+_0x315d4a)),await _0x50425e[_0x307b3d(0x204)][_0x307b3d(0x1c6)]({'data':{'paymentId':_0x1a0b6d,'shopId':_0x4f46e3['id'],'event':_0x307b3d(0x18b)+_0x3fd39[_0x307b3d(0x1f9)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x5eafd7,'newStatus':_0x3fd39['toUpperCase'](),'balanceChange':_0x315d4a||'no\x20balance\x20change','oldBalance':_0x4f46e3[_0x307b3d(0x1e0)],'newBalance':_0x3839a7,'amountUSDT':_0x5473af['amountUSDT'],'additionalData':_0x4a0836,'timestamp':new Date()['toISOString']()})}}),await this[_0x307b3d(0x1bf)]({..._0x554007,..._0x5c90cc,'shop':_0x4f46e3},_0x3fd39[_0x307b3d(0x21e)]()),await this['sendPaymentStatusNotification']({..._0x554007,..._0x5c90cc},_0x3fd39[_0x307b3d(0x21e)]());});}async[a57_0x502fde(0x189)](_0x203e2b){const _0x3f4d3d=a57_0x502fde;console[_0x3f4d3d(0x1cd)](_0x3f4d3d(0x1da),_0x203e2b);try{const _0x5a6acf=await this[_0x3f4d3d(0x221)][_0x3f4d3d(0x1fa)](_0x203e2b);if(!_0x5a6acf[_0x3f4d3d(0x1aa)])throw new Error(_0x3f4d3d(0x1d2));const _0x35f822=await database_1[_0x3f4d3d(0x1a3)][_0x3f4d3d(0x1f2)][_0x3f4d3d(0x1ac)]({'where':{'gatewayOrderId':_0x5a6acf['paymentId']}});if(!_0x35f822){console[_0x3f4d3d(0x206)](_0x3f4d3d(0x1ba)+_0x5a6acf[_0x3f4d3d(0x1aa)]);return;}console['log'](_0x3f4d3d(0x1d9)+_0x35f822['id']+_0x3f4d3d(0x1a6)+_0x5a6acf[_0x3f4d3d(0x1b8)]),await this[_0x3f4d3d(0x216)](_0x35f822['id'],_0x5a6acf[_0x3f4d3d(0x1b8)],{'txUrls':_0x5a6acf[_0x3f4d3d(0x222)]}),loggerService_1[_0x3f4d3d(0x1bd)][_0x3f4d3d(0x1ab)]('plisio',_0x35f822['id'],_0x35f822['status'],_0x5a6acf[_0x3f4d3d(0x1b8)],_0x203e2b);}catch(_0x2bade0){console[_0x3f4d3d(0x206)]('Error\x20processing\x20Plisio\x20webhook:',_0x2bade0),loggerService_1[_0x3f4d3d(0x1bd)]['logWebhookError']('plisio',_0x2bade0,_0x203e2b);throw _0x2bade0;}}async[a57_0x502fde(0x215)](_0x2ca60b){const _0x44071d=a57_0x502fde;console[_0x44071d(0x1cd)](_0x44071d(0x21c),_0x2ca60b);try{const _0x3795de=await this['plisioService']['processWebhook'](_0x2ca60b);if(!_0x3795de[_0x44071d(0x1aa)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x3c5c9c=await database_1[_0x44071d(0x1a3)][_0x44071d(0x1f2)][_0x44071d(0x1ac)]({'where':{'gatewayOrderId':_0x3795de[_0x44071d(0x1aa)]}});if(!_0x3c5c9c){console[_0x44071d(0x206)]('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x3795de[_0x44071d(0x1aa)]);return;}console[_0x44071d(0x1cd)](_0x44071d(0x1e4)+_0x3c5c9c['id']+'\x20status\x20'+_0x3795de[_0x44071d(0x1b8)]),await this[_0x44071d(0x216)](_0x3c5c9c['id'],_0x3795de[_0x44071d(0x1b8)],{'txUrls':_0x3795de[_0x44071d(0x222)]}),loggerService_1['loggerService'][_0x44071d(0x1ab)](_0x44071d(0x1b5),_0x3c5c9c['id'],_0x3c5c9c[_0x44071d(0x1b8)],_0x3795de[_0x44071d(0x1b8)],_0x2ca60b);}catch(_0x388312){console['error']('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x388312),loggerService_1[_0x44071d(0x1bd)][_0x44071d(0x19f)](_0x44071d(0x1b5),_0x388312,_0x2ca60b);throw _0x388312;}}async[a57_0x502fde(0x1f5)](_0x14c9ac){const _0x56c57b=a57_0x502fde;console[_0x56c57b(0x1cd)](_0x56c57b(0x196),_0x14c9ac);try{const _0xd33ef6=await this[_0x56c57b(0x1cb)][_0x56c57b(0x1fa)](_0x14c9ac);if(!_0xd33ef6['paymentId'])throw new Error(_0x56c57b(0x1c2));const _0x25893f=await database_1['default'][_0x56c57b(0x1f2)][_0x56c57b(0x1ac)]({'where':{'gatewayOrderId':_0xd33ef6[_0x56c57b(0x1aa)]}});if(!_0x25893f){console[_0x56c57b(0x206)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0xd33ef6[_0x56c57b(0x1aa)]);return;}console[_0x56c57b(0x1cd)](_0x56c57b(0x190)+_0x25893f['id']+_0x56c57b(0x1a6)+_0xd33ef6['status']),await this[_0x56c57b(0x216)](_0x25893f['id'],_0xd33ef6[_0x56c57b(0x1b8)],{'failureMessage':_0xd33ef6[_0x56c57b(0x223)],'cardLast4':_0xd33ef6[_0x56c57b(0x191)]?.[_0x56c57b(0x1a0)],'paymentMethod':_0xd33ef6[_0x56c57b(0x191)]?.[_0x56c57b(0x1ec)]}),loggerService_1['loggerService'][_0x56c57b(0x1ab)]('rapyd',_0x25893f['id'],_0x25893f['status'],_0xd33ef6['status'],_0x14c9ac);}catch(_0xbbb756){console[_0x56c57b(0x206)](_0x56c57b(0x1f6),_0xbbb756),loggerService_1[_0x56c57b(0x1bd)]['logWebhookError'](_0x56c57b(0x1cf),_0xbbb756,_0x14c9ac);throw _0xbbb756;}}async[a57_0x502fde(0x1e2)](_0x2bc7ec){const _0x1c6267=a57_0x502fde;console[_0x1c6267(0x1cd)](_0x1c6267(0x1e3),_0x2bc7ec);try{const _0x599bdf=await this[_0x1c6267(0x1c3)][_0x1c6267(0x1fa)](_0x2bc7ec);if(!_0x599bdf[_0x1c6267(0x1aa)])throw new Error(_0x1c6267(0x18c));const _0x5170c8=await database_1[_0x1c6267(0x1a3)][_0x1c6267(0x1f2)][_0x1c6267(0x1ac)]({'where':{'gatewayOrderId':_0x599bdf[_0x1c6267(0x1aa)]}});if(!_0x5170c8){console['error'](_0x1c6267(0x1e9)+_0x599bdf[_0x1c6267(0x1aa)]);return;}console['log']('üìä\x20Noda\x20webhook:\x20Payment\x20'+_0x5170c8['id']+_0x1c6267(0x1a6)+_0x599bdf[_0x1c6267(0x1b8)]),await this[_0x1c6267(0x216)](_0x5170c8['id'],_0x599bdf[_0x1c6267(0x1b8)],{'bankId':_0x599bdf[_0x1c6267(0x191)]?.[_0x1c6267(0x212)],'remitterIban':_0x599bdf['additionalInfo']?.[_0x1c6267(0x1fc)],'remitterName':_0x599bdf[_0x1c6267(0x191)]?.['remitterName']}),loggerService_1[_0x1c6267(0x1bd)][_0x1c6267(0x1ab)]('noda',_0x5170c8['id'],_0x5170c8['status'],_0x599bdf[_0x1c6267(0x1b8)],_0x2bc7ec);}catch(_0x1331ee){console[_0x1c6267(0x206)](_0x1c6267(0x1e7),_0x1331ee),loggerService_1[_0x1c6267(0x1bd)][_0x1c6267(0x19f)](_0x1c6267(0x201),_0x1331ee,_0x2bc7ec);throw _0x1331ee;}}async[a57_0x502fde(0x19d)](_0x80771c){const _0x47bbf6=a57_0x502fde;console['log'](_0x47bbf6(0x1a7),_0x80771c);try{const _0x36c9ad=await this[_0x47bbf6(0x1ad)][_0x47bbf6(0x1fa)](_0x80771c);if(!_0x36c9ad[_0x47bbf6(0x1aa)])throw new Error(_0x47bbf6(0x1ff));const _0x40cedf=await database_1[_0x47bbf6(0x1a3)][_0x47bbf6(0x1f2)][_0x47bbf6(0x1ac)]({'where':{'gatewayOrderId':_0x36c9ad['paymentId']}});if(!_0x40cedf){console[_0x47bbf6(0x206)](_0x47bbf6(0x1b6)+_0x36c9ad[_0x47bbf6(0x1aa)]);return;}console[_0x47bbf6(0x1cd)](_0x47bbf6(0x218)+_0x40cedf['id']+_0x47bbf6(0x1a6)+_0x36c9ad[_0x47bbf6(0x1b8)]),await this[_0x47bbf6(0x216)](_0x40cedf['id'],_0x36c9ad['status']),loggerService_1['loggerService']['logWebhookProcessed'](_0x47bbf6(0x214),_0x40cedf['id'],_0x40cedf[_0x47bbf6(0x1b8)],_0x36c9ad[_0x47bbf6(0x1b8)],_0x80771c);}catch(_0x27ea61){console['error']('Error\x20processing\x20CoinToPay\x20webhook:',_0x27ea61),loggerService_1[_0x47bbf6(0x1bd)]['logWebhookError'](_0x47bbf6(0x214),_0x27ea61,_0x80771c);throw _0x27ea61;}}async['processKlymeWebhook'](_0x54d4e3){const _0x1c3a1f=a57_0x502fde;console[_0x1c3a1f(0x1cd)](_0x1c3a1f(0x1b7),_0x54d4e3);try{const _0x40a3e4=await this[_0x1c3a1f(0x19b)][_0x1c3a1f(0x1fa)](_0x54d4e3);if(!_0x40a3e4[_0x1c3a1f(0x1aa)])throw new Error(_0x1c3a1f(0x1a8));const _0x1abcbc=await database_1['default'][_0x1c3a1f(0x1f2)][_0x1c3a1f(0x1ac)]({'where':{'gatewayOrderId':_0x40a3e4[_0x1c3a1f(0x1aa)]}});if(!_0x1abcbc){console[_0x1c3a1f(0x206)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x40a3e4[_0x1c3a1f(0x1aa)]);return;}console[_0x1c3a1f(0x1cd)]('üìä\x20KLYME\x20webhook:\x20Payment\x20'+_0x1abcbc['id']+'\x20status\x20'+_0x40a3e4[_0x1c3a1f(0x1b8)]),await this['updatePaymentStatus'](_0x1abcbc['id'],_0x40a3e4[_0x1c3a1f(0x1b8)],{'paymentMethod':_0x40a3e4[_0x1c3a1f(0x191)]?.['payment_method']}),loggerService_1[_0x1c3a1f(0x1bd)]['logWebhookProcessed']('klyme',_0x1abcbc['id'],_0x1abcbc[_0x1c3a1f(0x1b8)],_0x40a3e4[_0x1c3a1f(0x1b8)],_0x54d4e3);}catch(_0x307bb7){console[_0x1c3a1f(0x206)](_0x1c3a1f(0x1b3),_0x307bb7),loggerService_1['loggerService'][_0x1c3a1f(0x19f)](_0x1c3a1f(0x1d0),_0x307bb7,_0x54d4e3);throw _0x307bb7;}}async[a57_0x502fde(0x1b1)](_0x29df21){const _0x2722bb=a57_0x502fde;console[_0x2722bb(0x1cd)](_0x2722bb(0x19a),_0x29df21);try{const _0x317336=await this[_0x2722bb(0x1bc)][_0x2722bb(0x1fa)](_0x29df21);if(!_0x317336[_0x2722bb(0x1aa)])throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');const _0x256164=await database_1[_0x2722bb(0x1a3)]['payment'][_0x2722bb(0x1ac)]({'where':{'gatewayOrderId':_0x317336[_0x2722bb(0x1aa)]}});if(!_0x256164){console[_0x2722bb(0x206)]('Payment\x20not\x20found\x20for\x20MasterCard\x20webhook:\x20'+_0x317336[_0x2722bb(0x1aa)]);return;}console[_0x2722bb(0x1cd)]('üìä\x20MasterCard\x20webhook:\x20Payment\x20'+_0x256164['id']+_0x2722bb(0x1a6)+_0x317336['status']),await this['updatePaymentStatus'](_0x256164['id'],_0x317336[_0x2722bb(0x1b8)]),loggerService_1[_0x2722bb(0x1bd)][_0x2722bb(0x1ab)]('mastercard',_0x256164['id'],_0x256164[_0x2722bb(0x1b8)],_0x317336[_0x2722bb(0x1b8)],_0x29df21);}catch(_0x1868c2){console[_0x2722bb(0x206)]('Error\x20processing\x20MasterCard\x20webhook:',_0x1868c2),loggerService_1[_0x2722bb(0x1bd)][_0x2722bb(0x19f)](_0x2722bb(0x224),_0x1868c2,_0x29df21);throw _0x1868c2;}}async[a57_0x502fde(0x1bf)](_0x585c15,_0x84adb0){const _0x1a4a32=a57_0x502fde,_0x40f150=Date[_0x1a4a32(0x1f3)]();try{const _0x5dae33=_0x585c15[_0x1a4a32(0x20d)],_0x50fbd6=_0x5dae33[_0x1a4a32(0x19e)];if(!_0x50fbd6?.['webhookUrl']){console['log'](_0x1a4a32(0x1d6)+_0x5dae33['id']);return;}const _0x53e12b=_0x84adb0===_0x1a4a32(0x1db)?_0x1a4a32(0x226):_0x84adb0===_0x1a4a32(0x210)?_0x1a4a32(0x217):_0x84adb0===_0x1a4a32(0x202)?_0x1a4a32(0x217):_0x84adb0===_0x1a4a32(0x1f0)?'payment.failed':_0x84adb0==='REFUND'?_0x1a4a32(0x217):_0x1a4a32(0x227);let _0x466e32=[];if(_0x50fbd6[_0x1a4a32(0x192)])try{_0x466e32=Array[_0x1a4a32(0x1ae)](_0x50fbd6[_0x1a4a32(0x192)])?_0x50fbd6[_0x1a4a32(0x192)]:JSON[_0x1a4a32(0x18a)](_0x50fbd6[_0x1a4a32(0x192)]);}catch(_0x48dda3){console['error'](_0x1a4a32(0x21a),_0x48dda3),_0x466e32=[];}if(!_0x466e32[_0x1a4a32(0x1cc)](_0x53e12b)){console[_0x1a4a32(0x1cd)]('Webhook\x20event\x20'+_0x53e12b+_0x1a4a32(0x20a)+_0x5dae33['id']);return;}const _0x19f2a6={'event':_0x53e12b,'payment':{'id':_0x585c15['id'],'order_id':_0x585c15[_0x1a4a32(0x185)],'gateway_order_id':_0x585c15['gatewayOrderId'],'gateway':_0x585c15[_0x1a4a32(0x1df)],'amount':_0x585c15[_0x1a4a32(0x1e1)],'currency':_0x585c15['currency'],'status':_0x84adb0['toLowerCase'](),'customer_email':_0x585c15[_0x1a4a32(0x1c9)],'customer_name':_0x585c15['customerName'],'failure_message':_0x585c15[_0x1a4a32(0x223)],'tx_urls':_0x585c15[_0x1a4a32(0x222)]?JSON[_0x1a4a32(0x18a)](_0x585c15['txUrls']):null,'created_at':_0x585c15[_0x1a4a32(0x1a1)],'updated_at':_0x585c15['updatedAt']}},_0x1796bb=await fetch(_0x50fbd6[_0x1a4a32(0x1f8)],{'method':_0x1a4a32(0x1f7),'headers':{'Content-Type':_0x1a4a32(0x1b9),'User-Agent':_0x1a4a32(0x1fe)},'body':JSON[_0x1a4a32(0x1e5)](_0x19f2a6)}),_0x77d4c1=Date[_0x1a4a32(0x1f3)]()-_0x40f150,_0x1f30d2=_0x1796bb['ok']?_0x1a4a32(0x1ee):await _0x1796bb[_0x1a4a32(0x199)]();loggerService_1[_0x1a4a32(0x1bd)][_0x1a4a32(0x198)](_0x585c15[_0x1a4a32(0x1d1)],_0x50fbd6[_0x1a4a32(0x1f8)],_0x53e12b,_0x1796bb[_0x1a4a32(0x1b8)],_0x77d4c1,_0x19f2a6),console['log']('üì§\x20Shop\x20webhook\x20sent\x20to\x20'+_0x50fbd6[_0x1a4a32(0x1f8)]+'\x20with\x20status\x20'+_0x1796bb[_0x1a4a32(0x1b8)]+'\x20('+_0x77d4c1+_0x1a4a32(0x1c1));}catch(_0x496829){console[_0x1a4a32(0x206)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x496829),loggerService_1[_0x1a4a32(0x1bd)]['logShopWebhookError'](_0x585c15[_0x1a4a32(0x1d1)],_0x585c15[_0x1a4a32(0x20d)]?.[_0x1a4a32(0x19e)]?.[_0x1a4a32(0x1f8)]||_0x1a4a32(0x1de),_0x1a4a32(0x1ea),_0x496829,{});}}async[a57_0x502fde(0x1e8)](_0x57def2,_0x2a313c){const _0x49fb61=a57_0x502fde;try{const _0x119f16={'PENDING':_0x49fb61(0x208),'PROCESSING':_0x49fb61(0x193),'PAID':_0x49fb61(0x1a4),'FAILED':_0x49fb61(0x1fb),'EXPIRED':_0x49fb61(0x1d5),'REFUND':_0x49fb61(0x1be),'CHARGEBACK':_0x49fb61(0x1f1)},_0x2b35dd=_0x119f16[_0x2a313c];if(!_0x2b35dd||_0x2b35dd==='created')return;await telegramBotService_1[_0x49fb61(0x1b0)]['sendPaymentNotification'](_0x57def2[_0x49fb61(0x1d1)],_0x57def2,_0x2b35dd);}catch(_0x387632){console[_0x49fb61(0x206)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x387632);}}}exports['WebhookService']=WebhookService;