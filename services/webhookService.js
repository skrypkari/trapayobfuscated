'use strict';const a52_0x490b1f=a52_0x270d;function a52_0x56df(){const _0x21ee3c=['shop','telegramBotService','Processing\x20Plisio\x20Gateway\x20webhook:','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','PlisioService','paid','Processing\x20KLYME\x20webhook:','./paymentLinkService','paymentMethod','Processing\x20Noda\x20webhook:','ðŸ’¾\x20Saving\x20failure\x20message:\x20','rapydService','failed','default','Success','Webhook\x20event\x20','paymentId','updatePaymentStatus','coinToPayService','FAILED','\x20and\x20gateway:\x20','Error\x20processing\x20Plisio\x20webhook:','13940QYpVOl','plisioService','noda','386190RXrHNk','Processing\x20CoinToPay\x20webhook:','1024774yGoIcJ','\x20webhook','includes','paymentLinkService','logWebhookError','plisio','remitterName','processPlisioGatewayWebhook','rapyd','sendPaymentStatusNotification','\x20->\x20','processCoinToPayWebhook','Processing\x20Plisio\x20webhook:','Processing\x20Rapyd\x20webhook:','status','now','gatewayOrderId','Error\x20parsing\x20tx_urls\x20for\x20webhook:','additionalInfo','toLowerCase','ðŸ’¾\x20Failure\x20message\x20saved:\x20','logWebhookProcessed','klymeService','No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook','Payment\x20','created','customerEmail','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','parse','WebhookService','\x20status\x20to\x20','\x20updated\x20successfully:\x20','ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20','ðŸ”„\x20Updating\x20payment\x20','payment','length','No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook','./telegramBotService','9864RHRfza','region','\x20transaction\x20URLs:','Error\x20processing\x20KLYME\x20webhook:','payment.success','nodaService','./loggerService','26912YYHlYQ','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Failed\x20to\x20update\x20payment\x20link\x20counter:','createdAt','amount','PAID','PENDING','error','PaymentLinkService','paidAt','380EFeKHx','isArray','cardLast4','No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook','\x20URLs','klyme','Shop\x20webhook\x20sent\x20to\x20','POST','__importDefault','failureMessage','\x20from\x20','create','application/json','currency','./gateways/nodaService','text','settings','ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20','processPlisioWebhook','unknown','stringify','Error\x20processing\x20Rapyd\x20webhook:','2442012UTofnX','1QARVPK','sendShopWebhook','11776bWKWlU','./gateways/plisioService','customerName','webhookUrl','bankId','processWebhook','./gateways/coinToPayService','cointopay','Error\x20processing\x20CoinToPay\x20webhook:','loggerService','ðŸ’¥\x20Payment\x20','orderId','remitterIban','webhookEvents','EXPIRED','KlymeService','gateway','payment.pending','defineProperty','2805429hdMAZp','log','webhookLog','expired','TesSoft\x20Payment\x20System/1.0','Error\x20processing\x20Noda\x20webhook:','txUrls','shopId','processNodaWebhook','__esModule','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook','plisio_gateway'];a52_0x56df=function(){return _0x21ee3c;};return a52_0x56df();}(function(_0x184319,_0x191fa5){const _0x22fad1=a52_0x270d,_0x425d41=_0x184319();while(!![]){try{const _0x42ac85=-parseInt(_0x22fad1(0xe6))/0x1*(parseInt(_0x22fad1(0x122))/0x2)+-parseInt(_0x22fad1(0xfb))/0x3+parseInt(_0x22fad1(0xe8))/0x4*(parseInt(_0x22fad1(0xcf))/0x5)+parseInt(_0x22fad1(0xe5))/0x6+parseInt(_0x22fad1(0x120))/0x7+-parseInt(_0x22fad1(0xc5))/0x8+parseInt(_0x22fad1(0x148))/0x9*(parseInt(_0x22fad1(0x11d))/0xa);if(_0x42ac85===_0x191fa5)break;else _0x425d41['push'](_0x425d41['shift']());}catch(_0x434d7d){_0x425d41['push'](_0x425d41['shift']());}}}(a52_0x56df,0xba3de));function a52_0x270d(_0xd7cf86,_0x2c39b3){const _0x56df86=a52_0x56df();return a52_0x270d=function(_0x270d4d,_0xd9a7f8){_0x270d4d=_0x270d4d-0xc5;let _0x496dae=_0x56df86[_0x270d4d];return _0x496dae;},a52_0x270d(_0xd7cf86,_0x2c39b3);}var __importDefault=this&&this[a52_0x490b1f(0xd7)]||function(_0x13116b){const _0x420ca8=a52_0x490b1f;return _0x13116b&&_0x13116b[_0x420ca8(0x104)]?_0x13116b:{'default':_0x13116b};};Object[a52_0x490b1f(0xfa)](exports,a52_0x490b1f(0x104),{'value':!![]}),exports[a52_0x490b1f(0x13f)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a52_0x490b1f(0xe9)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a52_0x490b1f(0xdd)),coinToPayService_1=require(a52_0x490b1f(0xee)),klymeService_1=require('./gateways/klymeService'),telegramBotService_1=require(a52_0x490b1f(0x147)),paymentLinkService_1=require(a52_0x490b1f(0x10e)),loggerService_1=require(a52_0x490b1f(0x14e));class WebhookService{constructor(){const _0x80d345=a52_0x490b1f;this[_0x80d345(0x11e)]=new plisioService_1[(_0x80d345(0x10b))](),this[_0x80d345(0x112)]=new rapydService_1['RapydService'](),this[_0x80d345(0x14d)]=new nodaService_1['NodaService'](),this[_0x80d345(0x119)]=new coinToPayService_1['CoinToPayService'](),this['klymeService']=new klymeService_1[(_0x80d345(0xf7))](),this[_0x80d345(0x125)]=new paymentLinkService_1[(_0x80d345(0xcd))]();}async[a52_0x490b1f(0xe1)](_0x175102){const _0x4ec1da=a52_0x490b1f;console['log'](_0x4ec1da(0x12e),_0x175102);try{const _0x567c35=await this[_0x4ec1da(0x11e)][_0x4ec1da(0xed)](_0x175102);if(!_0x567c35[_0x4ec1da(0x117)]){console[_0x4ec1da(0xcc)](_0x4ec1da(0x105));return;}await this[_0x4ec1da(0x118)](_0x567c35[_0x4ec1da(0x117)],_0x567c35['status'],'plisio',_0x175102,undefined,undefined,_0x567c35[_0x4ec1da(0x101)]),loggerService_1[_0x4ec1da(0xf1)]['logWebhookProcessed'](_0x4ec1da(0x127),_0x567c35[_0x4ec1da(0x117)],_0x4ec1da(0xcb),_0x567c35[_0x4ec1da(0x130)],_0x175102);}catch(_0x2db3f6){console[_0x4ec1da(0xcc)](_0x4ec1da(0x11c),_0x2db3f6),loggerService_1['loggerService'][_0x4ec1da(0x126)](_0x4ec1da(0x127),_0x2db3f6,_0x175102);throw _0x2db3f6;}}async[a52_0x490b1f(0x129)](_0x4a2d32){const _0x1d804c=a52_0x490b1f;console['log'](_0x1d804c(0x109),_0x4a2d32);try{const _0x2b1d77=await this[_0x1d804c(0x11e)][_0x1d804c(0xed)](_0x4a2d32);if(!_0x2b1d77['paymentId']){console[_0x1d804c(0xcc)]('No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook');return;}await this[_0x1d804c(0x118)](_0x2b1d77[_0x1d804c(0x117)],_0x2b1d77[_0x1d804c(0x130)],'plisio',_0x4a2d32,undefined,undefined,_0x2b1d77['txUrls']),loggerService_1[_0x1d804c(0xf1)][_0x1d804c(0x137)](_0x1d804c(0x106),_0x2b1d77[_0x1d804c(0x117)],_0x1d804c(0xcb),_0x2b1d77[_0x1d804c(0x130)],_0x4a2d32);}catch(_0xf2a19c){console[_0x1d804c(0xcc)](_0x1d804c(0x10a),_0xf2a19c),loggerService_1['loggerService'][_0x1d804c(0x126)](_0x1d804c(0x106),_0xf2a19c,_0x4a2d32);throw _0xf2a19c;}}async['processRapydWebhook'](_0xf3a8e9){const _0x2a3e06=a52_0x490b1f;console[_0x2a3e06(0xfc)](_0x2a3e06(0x12f),_0xf3a8e9);try{const _0xaf8576=await this[_0x2a3e06(0x112)][_0x2a3e06(0xed)](_0xf3a8e9);if(!_0xaf8576[_0x2a3e06(0x117)]){console['error']('No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook');return;}await this['updatePaymentStatus'](_0xaf8576[_0x2a3e06(0x117)],_0xaf8576['status'],_0x2a3e06(0x12a),_0xf3a8e9,_0xaf8576[_0x2a3e06(0xd8)],_0xaf8576['additionalInfo']),loggerService_1['loggerService']['logWebhookProcessed'](_0x2a3e06(0x12a),_0xaf8576[_0x2a3e06(0x117)],_0x2a3e06(0xcb),_0xaf8576[_0x2a3e06(0x130)],_0xf3a8e9);}catch(_0x300329){console['error'](_0x2a3e06(0xe4),_0x300329),loggerService_1[_0x2a3e06(0xf1)][_0x2a3e06(0x126)](_0x2a3e06(0x12a),_0x300329,_0xf3a8e9);throw _0x300329;}}async[a52_0x490b1f(0x103)](_0x2508dc){const _0x425770=a52_0x490b1f;console[_0x425770(0xfc)](_0x425770(0x110),_0x2508dc);try{const _0x410348=await this[_0x425770(0x14d)][_0x425770(0xed)](_0x2508dc);if(!_0x410348[_0x425770(0x117)]){console[_0x425770(0xcc)](_0x425770(0x146));return;}await this[_0x425770(0x118)](_0x410348[_0x425770(0x117)],_0x410348[_0x425770(0x130)],_0x425770(0x11f),_0x2508dc,undefined,_0x410348[_0x425770(0x134)]),loggerService_1[_0x425770(0xf1)][_0x425770(0x137)](_0x425770(0x11f),_0x410348[_0x425770(0x117)],_0x425770(0xcb),_0x410348['status'],_0x2508dc);}catch(_0x2c2978){console['error'](_0x425770(0x100),_0x2c2978),loggerService_1[_0x425770(0xf1)][_0x425770(0x126)](_0x425770(0x11f),_0x2c2978,_0x2508dc);throw _0x2c2978;}}async[a52_0x490b1f(0x12d)](_0x2fe986){const _0x2c9941=a52_0x490b1f;console[_0x2c9941(0xfc)](_0x2c9941(0x121),_0x2fe986);try{const _0x4d36a9=await this[_0x2c9941(0x119)][_0x2c9941(0xed)](_0x2fe986);if(!_0x4d36a9[_0x2c9941(0x117)]){console[_0x2c9941(0xcc)](_0x2c9941(0x139));return;}await this['updatePaymentStatus'](_0x4d36a9[_0x2c9941(0x117)],_0x4d36a9[_0x2c9941(0x130)],_0x2c9941(0xef),_0x2fe986),loggerService_1[_0x2c9941(0xf1)][_0x2c9941(0x137)](_0x2c9941(0xef),_0x4d36a9['paymentId'],_0x2c9941(0xcb),_0x4d36a9[_0x2c9941(0x130)],_0x2fe986);}catch(_0x22b9c7){console[_0x2c9941(0xcc)](_0x2c9941(0xf0),_0x22b9c7),loggerService_1[_0x2c9941(0xf1)][_0x2c9941(0x126)]('cointopay',_0x22b9c7,_0x2fe986);throw _0x22b9c7;}}async['processKlymeWebhook'](_0x314d49){const _0x5f28e2=a52_0x490b1f;console['log'](_0x5f28e2(0x10d),_0x314d49);try{const _0x304214=await this[_0x5f28e2(0x138)][_0x5f28e2(0xed)](_0x314d49);if(!_0x304214[_0x5f28e2(0x117)]){console[_0x5f28e2(0xcc)](_0x5f28e2(0xd2));return;}const _0x4797b8=_0x304214[_0x5f28e2(0x149)]?'klyme_'+_0x304214[_0x5f28e2(0x149)]['toLowerCase']():'klyme_eu';await this[_0x5f28e2(0x118)](_0x304214[_0x5f28e2(0x117)],_0x304214[_0x5f28e2(0x130)],_0x4797b8,_0x314d49,undefined,_0x304214[_0x5f28e2(0x134)]),loggerService_1[_0x5f28e2(0xf1)][_0x5f28e2(0x137)](_0x5f28e2(0xd4),_0x304214['paymentId'],'PENDING',_0x304214['status'],_0x314d49);}catch(_0x26cc05){console[_0x5f28e2(0xcc)](_0x5f28e2(0x14b),_0x26cc05),loggerService_1[_0x5f28e2(0xf1)][_0x5f28e2(0x126)](_0x5f28e2(0xd4),_0x26cc05,_0x314d49);throw _0x26cc05;}}async['updatePaymentStatus'](_0xacc8d0,_0x17abfc,_0x1ac779,_0x25e0d2,_0x3cf9c0,_0x301a5e,_0x4a90af){const _0x5321b2=a52_0x490b1f;console[_0x5321b2(0xfc)](_0x5321b2(0x143)+_0xacc8d0+_0x5321b2(0x140)+_0x17abfc+_0x5321b2(0xd9)+_0x1ac779+_0x5321b2(0x123));_0x3cf9c0&&console[_0x5321b2(0xfc)](_0x5321b2(0xf2)+_0xacc8d0+'\x20failure\x20message:\x20'+_0x3cf9c0);_0x4a90af&&_0x4a90af[_0x5321b2(0x145)]>0x0&&console[_0x5321b2(0xfc)]('ðŸ”—\x20Payment\x20'+_0xacc8d0+_0x5321b2(0x14a),_0x4a90af);const _0x418f77=await database_1[_0x5321b2(0x114)][_0x5321b2(0x144)]['findFirst']({'where':{'gatewayOrderId':_0xacc8d0,'gateway':_0x1ac779},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x418f77){console[_0x5321b2(0xcc)](_0x5321b2(0x13d)+_0xacc8d0+_0x5321b2(0x11b)+_0x1ac779);return;}const _0x2fbbd8=_0x418f77[_0x5321b2(0x130)];if(_0x2fbbd8===_0x17abfc){console[_0x5321b2(0xfc)](_0x5321b2(0x13a)+_0x418f77['id']+'\x20status\x20unchanged\x20('+_0x17abfc+')');return;}console[_0x5321b2(0xfc)]('Payment\x20'+_0x418f77['id']+'\x20status\x20change:\x20'+_0x2fbbd8+_0x5321b2(0x12c)+_0x17abfc);const _0x4fac7f={'status':_0x17abfc,'updatedAt':new Date()};_0x3cf9c0&&(_0x4fac7f[_0x5321b2(0xd8)]=_0x3cf9c0,console[_0x5321b2(0xfc)](_0x5321b2(0x111)+_0x3cf9c0));_0x4a90af&&_0x4a90af['length']>0x0&&(_0x4fac7f[_0x5321b2(0x101)]=JSON['stringify'](_0x4a90af),console[_0x5321b2(0xfc)](_0x5321b2(0xe0)+JSON['stringify'](_0x4a90af)));_0x17abfc===_0x5321b2(0xca)&&_0x2fbbd8!=='PAID'&&(_0x4fac7f[_0x5321b2(0xce)]=new Date());_0x301a5e&&(_0x301a5e['cardLast4']&&(_0x4fac7f[_0x5321b2(0xd1)]=_0x301a5e[_0x5321b2(0xd1)]),_0x301a5e[_0x5321b2(0x10f)]&&(_0x4fac7f['paymentMethod']=_0x301a5e[_0x5321b2(0x10f)]),_0x301a5e['bankId']&&(_0x4fac7f[_0x5321b2(0xec)]=_0x301a5e[_0x5321b2(0xec)]),_0x301a5e['remitterIban']&&(_0x4fac7f[_0x5321b2(0xf4)]=_0x301a5e[_0x5321b2(0xf4)]),_0x301a5e[_0x5321b2(0x128)]&&(_0x4fac7f[_0x5321b2(0x128)]=_0x301a5e[_0x5321b2(0x128)]));await database_1['default'][_0x5321b2(0x144)]['update']({'where':{'id':_0x418f77['id']},'data':_0x4fac7f});if(_0x17abfc===_0x5321b2(0xca)&&_0x2fbbd8!==_0x5321b2(0xca))try{await this[_0x5321b2(0x125)]['handleSuccessfulPayment'](_0x418f77['id']);}catch(_0x58ad5a){console['error'](_0x5321b2(0xc7),_0x58ad5a);}await database_1['default'][_0x5321b2(0xfd)][_0x5321b2(0xda)]({'data':{'paymentId':_0x418f77['id'],'shopId':_0x418f77[_0x5321b2(0x102)],'event':_0x1ac779+'_webhook_'+_0x17abfc[_0x5321b2(0x135)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x2fbbd8,'newStatus':_0x17abfc,'failureMessage':_0x3cf9c0,'txUrls':_0x4a90af,'webhookData':_0x25e0d2})}}),await this[_0x5321b2(0xe7)](_0x418f77,_0x17abfc),await this[_0x5321b2(0x12b)](_0x418f77,_0x17abfc),console[_0x5321b2(0xfc)]('âœ…\x20Payment\x20'+_0x418f77['id']+_0x5321b2(0x141)+_0x2fbbd8+_0x5321b2(0x12c)+_0x17abfc),_0x3cf9c0&&console[_0x5321b2(0xfc)](_0x5321b2(0x136)+_0x3cf9c0),_0x4a90af&&_0x4a90af[_0x5321b2(0x145)]>0x0&&console['log'](_0x5321b2(0x142)+_0x4a90af[_0x5321b2(0x145)]+_0x5321b2(0xd3));}async['sendShopWebhook'](_0x27889c,_0x5bc598){const _0x5e92d7=a52_0x490b1f,_0x39c955=Date['now']();try{const _0x1db113=_0x27889c[_0x5e92d7(0x107)],_0x16ad84=_0x1db113['settings'];if(!_0x16ad84?.[_0x5e92d7(0xeb)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1db113['id']);return;}const _0x5e9d28=_0x5bc598==='PAID'?_0x5e92d7(0x14c):_0x5bc598===_0x5e92d7(0x11a)?'payment.failed':_0x5bc598===_0x5e92d7(0xf6)?'payment.failed':_0x5e92d7(0xf9);let _0x5a9e96=[];if(_0x16ad84[_0x5e92d7(0xf5)])try{_0x5a9e96=Array[_0x5e92d7(0xd0)](_0x16ad84[_0x5e92d7(0xf5)])?_0x16ad84[_0x5e92d7(0xf5)]:JSON[_0x5e92d7(0x13e)](_0x16ad84[_0x5e92d7(0xf5)]);}catch(_0x2b1874){console[_0x5e92d7(0xcc)]('Error\x20parsing\x20webhook\x20events:',_0x2b1874),_0x5a9e96=[];}if(!_0x5a9e96[_0x5e92d7(0x124)](_0x5e9d28)){console[_0x5e92d7(0xfc)](_0x5e92d7(0x116)+_0x5e9d28+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1db113['id']);return;}let _0x8d0e13;if(_0x27889c[_0x5e92d7(0x101)])try{_0x8d0e13=JSON['parse'](_0x27889c[_0x5e92d7(0x101)]);}catch(_0x3d3aae){console[_0x5e92d7(0xcc)](_0x5e92d7(0x133),_0x3d3aae),_0x8d0e13=undefined;}const _0x33dd8d={'event':_0x5e9d28,'payment':{'id':_0x27889c['id'],'order_id':_0x27889c[_0x5e92d7(0xf3)],'gateway_order_id':_0x27889c[_0x5e92d7(0x132)],'gateway':_0x27889c[_0x5e92d7(0xf8)],'amount':_0x27889c[_0x5e92d7(0xc9)],'currency':_0x27889c[_0x5e92d7(0xdc)],'status':_0x5bc598[_0x5e92d7(0x135)](),'customer_email':_0x27889c[_0x5e92d7(0x13c)],'customer_name':_0x27889c[_0x5e92d7(0xea)],'failure_message':_0x27889c[_0x5e92d7(0xd8)],'tx_urls':_0x8d0e13,'created_at':_0x27889c[_0x5e92d7(0xc8)],'updated_at':new Date()}},_0xd0722a=await fetch(_0x16ad84[_0x5e92d7(0xeb)],{'method':_0x5e92d7(0xd6),'headers':{'Content-Type':_0x5e92d7(0xdb),'User-Agent':_0x5e92d7(0xff)},'body':JSON[_0x5e92d7(0xe3)](_0x33dd8d)}),_0x13c08b=Date[_0x5e92d7(0x131)]()-_0x39c955,_0xed4955=_0xd0722a['ok']?_0x5e92d7(0x115):await _0xd0722a[_0x5e92d7(0xde)]();loggerService_1[_0x5e92d7(0xf1)]['logShopWebhookSent'](_0x27889c[_0x5e92d7(0x102)],_0x16ad84['webhookUrl'],_0x5e9d28,_0xd0722a['status'],_0x13c08b,_0x33dd8d),console[_0x5e92d7(0xfc)](_0x5e92d7(0xd5)+_0x16ad84[_0x5e92d7(0xeb)]+'\x20with\x20status\x20'+_0xd0722a[_0x5e92d7(0x130)]+'\x20('+_0x13c08b+'ms)');}catch(_0x3161f0){console[_0x5e92d7(0xcc)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x3161f0),loggerService_1[_0x5e92d7(0xf1)]['logShopWebhookError'](_0x27889c[_0x5e92d7(0x102)],_0x27889c[_0x5e92d7(0x107)]?.[_0x5e92d7(0xdf)]?.[_0x5e92d7(0xeb)]||_0x5e92d7(0xe2),'webhook_send',_0x3161f0,{});}}async['sendPaymentStatusNotification'](_0x446025,_0x4a26a9){const _0x4772f2=a52_0x490b1f;try{const _0x5869a7={'PENDING':_0x4772f2(0x13b),'PAID':_0x4772f2(0x10c),'FAILED':_0x4772f2(0x113),'EXPIRED':_0x4772f2(0xfe)},_0x3adebd=_0x5869a7[_0x4a26a9];if(!_0x3adebd||_0x3adebd===_0x4772f2(0x13b))return;await telegramBotService_1[_0x4772f2(0x108)]['sendPaymentNotification'](_0x446025[_0x4772f2(0x102)],_0x446025,_0x3adebd);}catch(_0x2a005c){console[_0x4772f2(0xcc)](_0x4772f2(0xc6),_0x2a005c);}}}exports[a52_0x490b1f(0x13f)]=WebhookService;