'use strict';function a61_0x3947(_0x42d5c6,_0x38ddbd){const _0x341e08=a61_0x341e();return a61_0x3947=function(_0x394759,_0x5b7270){_0x394759=_0x394759-0xfc;let _0x4cb578=_0x341e08[_0x394759];return _0x4cb578;},a61_0x3947(_0x42d5c6,_0x38ddbd);}const a61_0x29e8b9=a61_0x3947;(function(_0xa45bce,_0x5e4275){const _0x45b42b=a61_0x3947,_0x211b1d=_0xa45bce();while(!![]){try{const _0xb933d5=parseInt(_0x45b42b(0x1e7))/0x1*(-parseInt(_0x45b42b(0x192))/0x2)+parseInt(_0x45b42b(0x1cc))/0x3+parseInt(_0x45b42b(0x18d))/0x4*(parseInt(_0x45b42b(0x1c0))/0x5)+parseInt(_0x45b42b(0x128))/0x6+-parseInt(_0x45b42b(0x164))/0x7*(parseInt(_0x45b42b(0x1c8))/0x8)+-parseInt(_0x45b42b(0x1d6))/0x9*(parseInt(_0x45b42b(0x166))/0xa)+parseInt(_0x45b42b(0x19d))/0xb*(parseInt(_0x45b42b(0x11e))/0xc);if(_0xb933d5===_0x5e4275)break;else _0x211b1d['push'](_0x211b1d['shift']());}catch(_0x544801){_0x211b1d['push'](_0x211b1d['shift']());}}}(a61_0x341e,0x208ab));var __importDefault=this&&this['__importDefault']||function(_0x229213){const _0x2dfa80=a61_0x3947;return _0x229213&&_0x229213[_0x2dfa80(0x19a)]?_0x229213:{'default':_0x229213};};Object[a61_0x29e8b9(0x157)](exports,a61_0x29e8b9(0x19a),{'value':!![]}),exports[a61_0x29e8b9(0x1dc)]=void 0x0;function a61_0x341e(){const _0x295944=['No\x20payment\x20ID\x20in\x20KLYME\x20webhook','\x20not\x20enabled\x20for\x20shop\x20','cointopay2','\x22,\x20paymentLinkId=\x22','failed','webhook_status_change_','loggerService','💰\x20Adding\x20to\x20balance:\x20','./gateways/amerService','chargebackAmount','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','error','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','sendPaymentStatusNotification','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','plisio_gateway','💰\x20Converting\x20','\x20->\x20','update','application/json','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','./gateways/mastercardService','\x20current\x20balance:\x20','paymentLinkId','paymentLink','failureMessage','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','./gateways/rapydService','📊\x20KLYME\x20webhook:\x20Payment\x20','📊\x20CoinToPay\x20webhook:\x20Payment\x20','orderId','rapydService','\x22,\x20newStatus=\x22','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','amountUSDT','14988fWqjBB','NodaService','cointopay','system','Success','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','./telegramBotService','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','Error\x20processing\x20CoinToPay2\x20webhook:','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','420606EYSgXi','💰\x20Removing\x20from\x20balance:\x20','\x20USDT','CHARGEBACK','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','createdAt','additionalInfo','rapyd','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','Error\x20processing\x20Plisio\x20webhook:','POST','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','\x20in\x20shop\x20','📊\x20Amer\x20webhook:\x20Payment\x20','keys','coinToPayService','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','Found\x20payment\x20','amerService','gateway','📊\x20Plisio\x20webhook:\x20Payment\x20','📤\x20Shop\x20webhook\x20sent\x20to\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','COMPLETED','masterCardService','txUrls','💰\x20Gateway\x20','logShopWebhookSent','webhookEvents','gatewaySettings','Payment\x20','webhookLog','Webhook\x20event\x20','mastercard','webhook_send','nodaService','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','klyme','🏪\x20Shop\x20','\x22,\x20orderId=\x22',',\x20using\x20default\x2010%','processWebhook','📊\x20Rapyd\x20webhook:\x20Payment\x20','paymentMethod','amer','\x20+\x20','defineProperty','webhookUrl','bankId',',\x20using\x20default\x20commission\x2010%','🔄\x20Processing\x20MasterCard\x20webhook:','🔍\x20Search\x20result:\x20','amountAfterGatewayCommissionUSDT','findUnique','updatePaymentStatus','settings','klymeService','./currencyService','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','336lqKqYb',',\x20status=','60NbGwVH','CoinToPay2Service','paidAt','\x20commission:\x20','ms)','stringify','getGatewayCommission','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook',',\x20newStatus=','../config/database','No\x20payment\x20ID\x20in\x20Noda\x20webhook','parse','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','Payment\x20not\x20found','sendShopWebhook','create','🔄\x20Processing\x20CoinToPay\x20webhook:','log','updatedAt','✅\x20Payment\x20link\x20','cardLast4','📊\x20Noda\x20webhook:\x20Payment\x20','logWebhookProcessed','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','plisio','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','\x20USDT\x20(chargeback\x20penalty)','$transaction','currencyService','REFUND','processing','commission','✅\x20Found\x20payment\x20','payment.success','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','paymentId','SINGLE','Error\x20processing\x20CoinToPay\x20webhook:','gatewayOrderId','8ohVTVg','remitterIban','./gateways/plisioService','plisioService','status','27652nQNfze','\x20not\x20found','logWebhookError','convertToUSDT','\x20updated:\x20currentPayments=','currency','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data',',\x20currentPayments=','__esModule','processCoinToPayWebhook','❌\x20Payment\x20link\x20','2189YAHvvK','\x20status\x20','❌\x20Error\x20processing\x20Amer\x20webhook:','PAID','shopId','📈\x20Found\x20payment\x20link\x20','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','\x20=\x20','toFixed','processPlisioGatewayWebhook','💸\x20Additional\x20chargeback\x20penalty:\x20-','🔄\x20Processing\x20KLYME\x20webhook:','type','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','payment_method','coinToPay2Service','Error\x20processing\x20Rapyd\x20webhook:','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','📈\x20Payment\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','refund','default','🔄\x20Processing\x20Plisio\x20webhook:','%\x20gateway\x20commission)','username','./gateways/coinToPayService','paid','payment.failed','\x20to\x20','EXPIRED',',\x20gateway\x20','now','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','\x20balance\x20updated:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','103165lhPhOt',':\x20type=','❌\x20Available\x20webhook\x20fields:','Error\x20parsing\x20webhook\x20events:','./gateways/klymeService','sendPaymentNotification','\x20-\x20','text','4416eTDIzP','No\x20payment\x20ID\x20in\x20Amer\x20webhook','❌\x20Error\x20processing\x20MasterCard\x20webhook:','🔄\x20Processing\x20Noda\x20webhook:','602937BqRmMy','💰\x20Amount\x20after\x20gateway\x20commission:\x20','balance','isArray','includes','noda','currentPayments','processKlymeWebhook','processMasterCardWebhook','./gateways/coinToPay2Service','311319ebLICh','processNodaWebhook','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','toLowerCase','TesSoft\x20Payment\x20System/1.0','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','WebhookService','amount','📈\x20Payment\x20details:\x20oldStatus=\x22','remitterName','CoinToPayService','✅\x20Shop\x20','findFirst','payment','logShopWebhookError','Error\x20processing\x20KLYME\x20webhook:','AmerService','14WdLDHF','shop','toUpperCase'];a61_0x341e=function(){return _0x295944;};return a61_0x341e();}const database_1=__importDefault(require(a61_0x29e8b9(0x16f))),plisioService_1=require(a61_0x29e8b9(0x18f)),rapydService_1=require(a61_0x29e8b9(0x116)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a61_0x29e8b9(0x1b6)),coinToPay2Service_1=require(a61_0x29e8b9(0x1d5)),klymeService_1=require(a61_0x29e8b9(0x1c4)),mastercardService_1=require(a61_0x29e8b9(0x110)),amerService_1=require(a61_0x29e8b9(0x103)),telegramBotService_1=require(a61_0x29e8b9(0x124)),currencyService_1=require(a61_0x29e8b9(0x162)),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x3d4500=a61_0x29e8b9;this[_0x3d4500(0x190)]=new plisioService_1['PlisioService'](),this['rapydService']=new rapydService_1['RapydService'](),this[_0x3d4500(0x14c)]=new nodaService_1[(_0x3d4500(0x11f))](),this[_0x3d4500(0x138)]=new coinToPayService_1[(_0x3d4500(0x1e0))](),this[_0x3d4500(0x1ac)]=new coinToPay2Service_1[(_0x3d4500(0x167))](),this[_0x3d4500(0x161)]=new klymeService_1['KlymeService'](),this[_0x3d4500(0x141)]=new mastercardService_1['MasterCardService'](),this[_0x3d4500(0x13b)]=new amerService_1[(_0x3d4500(0x1e6))]();}async[a61_0x29e8b9(0x15f)](_0xffc572,_0x1aee8c,_0x2eb971){const _0x5f4981=a61_0x29e8b9;console['log']('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0xffc572+_0x5f4981(0x16e)+_0x1aee8c),console['log']('🔄\x20Additional\x20data:',_0x2eb971),await database_1[_0x5f4981(0x1b2)][_0x5f4981(0x181)](async _0x1cab0d=>{const _0xc090d8=_0x5f4981,_0x5496b4=await _0x1cab0d[_0xc090d8(0x1e3)][_0xc090d8(0x15e)]({'where':{'id':_0xffc572},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5496b4)throw new Error(_0xc090d8(0x147)+_0xffc572+_0xc090d8(0x193));const _0x32ea8c=_0x5496b4['status'],_0x4a5e54=_0x5496b4[_0xc090d8(0x1e8)];console['log']('💰\x20Payment\x20'+_0xffc572+':\x20'+_0x32ea8c+'\x20->\x20'+_0x1aee8c),console[_0xc090d8(0x177)](_0xc090d8(0x14f)+_0x4a5e54[_0xc090d8(0x1b5)]+_0xc090d8(0x111)+_0x4a5e54[_0xc090d8(0x1ce)]+_0xc090d8(0x12a));const _0x412368={'status':_0x1aee8c['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0xc090d8(0x121),'statusChangedAt':new Date()};_0x2eb971?.[_0xc090d8(0x114)]&&(_0x412368[_0xc090d8(0x114)]=_0x2eb971['failureMessage']);_0x2eb971?.[_0xc090d8(0x142)]&&(_0x412368[_0xc090d8(0x142)]=JSON[_0xc090d8(0x16b)](_0x2eb971['txUrls']));_0x2eb971?.[_0xc090d8(0x17a)]&&(_0x412368[_0xc090d8(0x17a)]=_0x2eb971['cardLast4']);_0x2eb971?.[_0xc090d8(0x154)]&&(_0x412368[_0xc090d8(0x154)]=_0x2eb971[_0xc090d8(0x154)]);_0x2eb971?.['bankId']&&(_0x412368[_0xc090d8(0x159)]=_0x2eb971['bankId']);_0x2eb971?.[_0xc090d8(0x18e)]&&(_0x412368[_0xc090d8(0x18e)]=_0x2eb971[_0xc090d8(0x18e)]);_0x2eb971?.[_0xc090d8(0x1df)]&&(_0x412368['remitterName']=_0x2eb971[_0xc090d8(0x1df)]);let _0x31ed5a=_0x4a5e54[_0xc090d8(0x1ce)],_0x53ecf6='';if(_0x1aee8c[_0xc090d8(0x1e9)]()==='PAID'&&_0x32ea8c!==_0xc090d8(0x1a0)){const _0x5d39c6=await currencyService_1[_0xc090d8(0x182)][_0xc090d8(0x195)](_0x5496b4[_0xc090d8(0x1dd)],_0x5496b4[_0xc090d8(0x197)]),_0x21ef03=await this['getGatewayCommission'](_0x4a5e54['id'],_0x5496b4[_0xc090d8(0x13c)]),_0x160fcd=_0x5d39c6*(0x1-_0x21ef03/0x64);_0x31ed5a+=_0x160fcd,_0x53ecf6='+'+_0x160fcd['toFixed'](0x6)+_0xc090d8(0x17f)+_0x21ef03+_0xc090d8(0x1b4),_0x412368[_0xc090d8(0x11d)]=_0x5d39c6,_0x412368[_0xc090d8(0x15d)]=_0x160fcd,_0x412368[_0xc090d8(0x168)]=new Date(),console[_0xc090d8(0x177)](_0xc090d8(0x10b)+_0x5496b4[_0xc090d8(0x1dd)]+'\x20'+_0x5496b4[_0xc090d8(0x197)]+_0xc090d8(0x10c)+_0x5d39c6['toFixed'](0x6)+_0xc090d8(0x12a)),console['log'](_0xc090d8(0x143)+_0x5496b4['gateway']+_0xc090d8(0x169)+_0x21ef03+'%'),console[_0xc090d8(0x177)](_0xc090d8(0x1cd)+_0x160fcd[_0xc090d8(0x1a5)](0x6)+_0xc090d8(0x12a)),console['log'](_0xc090d8(0x102)+_0x4a5e54[_0xc090d8(0x1ce)]+_0xc090d8(0x156)+_0x160fcd[_0xc090d8(0x1a5)](0x6)+'\x20=\x20'+_0x31ed5a[_0xc090d8(0x1a5)](0x6)+_0xc090d8(0x12a));}else{if(_0x32ea8c===_0xc090d8(0x1a0)&&_0x1aee8c[_0xc090d8(0x1e9)]()!==_0xc090d8(0x1a0)){let _0x102a8f;if(_0x5496b4[_0xc090d8(0x15d)])_0x102a8f=_0x5496b4['amountAfterGatewayCommissionUSDT'];else{if(_0x5496b4[_0xc090d8(0x11d)]){const _0x468e13=await this[_0xc090d8(0x16c)](_0x4a5e54['id'],_0x5496b4[_0xc090d8(0x13c)]);_0x102a8f=_0x5496b4[_0xc090d8(0x11d)]*(0x1-_0x468e13/0x64);}else console[_0xc090d8(0x177)](_0xc090d8(0x163)),_0x102a8f=0x0;}_0x102a8f>0x0&&(_0x31ed5a-=_0x102a8f,_0x53ecf6='-'+_0x102a8f[_0xc090d8(0x1a5)](0x6)+_0xc090d8(0x125),_0x412368[_0xc090d8(0x11d)]=null,_0x412368[_0xc090d8(0x15d)]=null,_0x412368[_0xc090d8(0x168)]=null,console[_0xc090d8(0x177)](_0xc090d8(0x129)+_0x4a5e54[_0xc090d8(0x1ce)]+_0xc090d8(0x1c6)+_0x102a8f[_0xc090d8(0x1a5)](0x6)+_0xc090d8(0x1a4)+_0x31ed5a[_0xc090d8(0x1a5)](0x6)+_0xc090d8(0x12a)));}}if(_0x1aee8c['toUpperCase']()===_0xc090d8(0x12b)){const _0x37adc9=_0x2eb971?.[_0xc090d8(0x104)]||0x0;_0x37adc9>0x0&&(_0x31ed5a-=_0x37adc9,_0x53ecf6+='\x20and\x20-'+_0x37adc9[_0xc090d8(0x1a5)](0x6)+_0xc090d8(0x180),_0x412368[_0xc090d8(0x104)]=_0x37adc9,console['log'](_0xc090d8(0x1a7)+_0x37adc9['toFixed'](0x6)+_0xc090d8(0x12a)),console['log']('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x31ed5a[_0xc090d8(0x1a5)](0x6)+'\x20USDT'));}const _0x3ca4b4=await _0x1cab0d[_0xc090d8(0x1e3)]['update']({'where':{'id':_0xffc572},'data':_0x412368});_0x31ed5a!==_0x4a5e54[_0xc090d8(0x1ce)]&&(await _0x1cab0d['shop']['update']({'where':{'id':_0x4a5e54['id']},'data':{'balance':_0x31ed5a}}),console[_0xc090d8(0x177)](_0xc090d8(0x1e1)+_0x4a5e54['username']+_0xc090d8(0x1be)+_0x4a5e54[_0xc090d8(0x1ce)][_0xc090d8(0x1a5)](0x6)+'\x20->\x20'+_0x31ed5a['toFixed'](0x6)+_0xc090d8(0x12a)),console[_0xc090d8(0x177)]('📝\x20Reason:\x20'+_0x53ecf6));await _0x1cab0d[_0xc090d8(0x148)][_0xc090d8(0x175)]({'data':{'paymentId':_0xffc572,'shopId':_0x4a5e54['id'],'event':_0xc090d8(0x100)+_0x1aee8c[_0xc090d8(0x1d9)](),'statusCode':0xc8,'responseBody':JSON[_0xc090d8(0x16b)]({'oldStatus':_0x32ea8c,'newStatus':_0x1aee8c['toUpperCase'](),'balanceChange':_0x53ecf6||'no\x20balance\x20change','oldBalance':_0x4a5e54[_0xc090d8(0x1ce)],'newBalance':_0x31ed5a,'amountUSDT':_0x412368[_0xc090d8(0x11d)],'additionalData':_0x2eb971,'timestamp':new Date()['toISOString']()})}}),await this[_0xc090d8(0x174)]({..._0x5496b4,..._0x3ca4b4,'shop':_0x4a5e54},_0x1aee8c[_0xc090d8(0x1e9)]()),await this[_0xc090d8(0x108)]({..._0x5496b4,..._0x3ca4b4},_0x1aee8c[_0xc090d8(0x1e9)]());if(_0x32ea8c!==_0xc090d8(0x1a0)&&_0x1aee8c['toUpperCase']()==='PAID'){console['log']('📈\x20Payment\x20'+_0xffc572+_0xc090d8(0x188)),console['log'](_0xc090d8(0x1de)+_0x32ea8c+_0xc090d8(0x11b)+_0x1aee8c[_0xc090d8(0x1e9)]()+_0xc090d8(0xfe)+_0x5496b4[_0xc090d8(0x112)]+'\x22');if(_0x5496b4['paymentLinkId'])try{const _0x603e14=await _0x1cab0d['paymentLink'][_0xc090d8(0x15e)]({'where':{'id':_0x5496b4['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x603e14){console[_0xc090d8(0x177)](_0xc090d8(0x1a2)+_0x603e14['id']+_0xc090d8(0x1c1)+_0x603e14[_0xc090d8(0x1a9)]+_0xc090d8(0x199)+_0x603e14[_0xc090d8(0x1d2)]+_0xc090d8(0x165)+_0x603e14[_0xc090d8(0x191)]);const _0x43f534=_0x603e14[_0xc090d8(0x1d2)]+0x1,_0x334067=_0x603e14[_0xc090d8(0x1a9)]===_0xc090d8(0x18a)?_0xc090d8(0x140):_0x603e14[_0xc090d8(0x191)];await _0x1cab0d[_0xc090d8(0x113)][_0xc090d8(0x10d)]({'where':{'id':_0x5496b4[_0xc090d8(0x112)]},'data':{'currentPayments':_0x43f534,'status':_0x334067,'updatedAt':new Date()}}),console[_0xc090d8(0x177)](_0xc090d8(0x179)+_0x603e14['id']+_0xc090d8(0x196)+_0x603e14[_0xc090d8(0x1d2)]+_0xc090d8(0x10c)+_0x43f534+_0xc090d8(0x165)+_0x603e14[_0xc090d8(0x191)]+'\x20->\x20'+_0x334067);}else console[_0xc090d8(0x177)](_0xc090d8(0x19c)+_0x5496b4[_0xc090d8(0x112)]+_0xc090d8(0x193));}catch(_0x2f6a9d){console[_0xc090d8(0x106)](_0xc090d8(0x123),_0x2f6a9d);}else console[_0xc090d8(0x177)](_0xc090d8(0x1af)+_0xffc572+_0xc090d8(0x13f));}else console[_0xc090d8(0x177)]('📈\x20Payment\x20'+_0xffc572+_0xc090d8(0x11c)+_0x32ea8c+_0xc090d8(0x10c)+_0x1aee8c[_0xc090d8(0x1e9)]());});}async['processPlisioWebhook'](_0x293271){const _0x36fb6d=a61_0x29e8b9;console[_0x36fb6d(0x177)](_0x36fb6d(0x1b3),_0x293271);try{const _0xb258c7=await this['plisioService'][_0x36fb6d(0x152)](_0x293271);if(!_0xb258c7[_0x36fb6d(0x189)])throw new Error(_0x36fb6d(0x105));const _0x25352c=await database_1[_0x36fb6d(0x1b2)]['payment'][_0x36fb6d(0x1e2)]({'where':{'gatewayOrderId':_0xb258c7[_0x36fb6d(0x189)]}});if(!_0x25352c){console[_0x36fb6d(0x106)]('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0xb258c7[_0x36fb6d(0x189)]);return;}console['log'](_0x36fb6d(0x13d)+_0x25352c['id']+'\x20status\x20'+_0xb258c7[_0x36fb6d(0x191)]),await this[_0x36fb6d(0x15f)](_0x25352c['id'],_0xb258c7['status'],{'txUrls':_0xb258c7[_0x36fb6d(0x142)]}),loggerService_1[_0x36fb6d(0x101)]['logWebhookProcessed']('plisio',_0x25352c['id'],_0x25352c['status'],_0xb258c7[_0x36fb6d(0x191)],_0x293271);}catch(_0x3e1e07){console[_0x36fb6d(0x106)](_0x36fb6d(0x131),_0x3e1e07),loggerService_1[_0x36fb6d(0x101)][_0x36fb6d(0x194)](_0x36fb6d(0x17e),_0x3e1e07,_0x293271);throw _0x3e1e07;}}async[a61_0x29e8b9(0x1a6)](_0xd01625){const _0x2c5856=a61_0x29e8b9;console[_0x2c5856(0x177)](_0x2c5856(0x17d),_0xd01625);try{const _0x2b7c3f=await this[_0x2c5856(0x190)][_0x2c5856(0x152)](_0xd01625);if(!_0x2b7c3f['paymentId'])throw new Error(_0x2c5856(0x1bd));const _0xb650eb=await database_1[_0x2c5856(0x1b2)][_0x2c5856(0x1e3)][_0x2c5856(0x1e2)]({'where':{'gatewayOrderId':_0x2b7c3f['paymentId']}});if(!_0xb650eb){console['error'](_0x2c5856(0x134)+_0x2b7c3f['paymentId']);return;}console[_0x2c5856(0x177)](_0x2c5856(0x115)+_0xb650eb['id']+_0x2c5856(0x19e)+_0x2b7c3f[_0x2c5856(0x191)]),await this[_0x2c5856(0x15f)](_0xb650eb['id'],_0x2b7c3f[_0x2c5856(0x191)],{'txUrls':_0x2b7c3f[_0x2c5856(0x142)]}),loggerService_1[_0x2c5856(0x101)][_0x2c5856(0x17c)](_0x2c5856(0x10a),_0xb650eb['id'],_0xb650eb[_0x2c5856(0x191)],_0x2b7c3f[_0x2c5856(0x191)],_0xd01625);}catch(_0x570f6a){console['error']('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x570f6a),loggerService_1['loggerService'][_0x2c5856(0x194)](_0x2c5856(0x10a),_0x570f6a,_0xd01625);throw _0x570f6a;}}async['processRapydWebhook'](_0x270c92){const _0x4b715c=a61_0x29e8b9;console[_0x4b715c(0x177)]('🔄\x20Processing\x20Rapyd\x20webhook:',_0x270c92);try{const _0x4975db=await this[_0x4b715c(0x11a)][_0x4b715c(0x152)](_0x270c92);if(!_0x4975db[_0x4b715c(0x189)])throw new Error(_0x4b715c(0x16d));const _0xc53643=await database_1[_0x4b715c(0x1b2)][_0x4b715c(0x1e3)][_0x4b715c(0x1e2)]({'where':{'gatewayOrderId':_0x4975db['paymentId']}});if(!_0xc53643){console[_0x4b715c(0x106)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x4975db[_0x4b715c(0x189)]);return;}console[_0x4b715c(0x177)](_0x4b715c(0x153)+_0xc53643['id']+_0x4b715c(0x19e)+_0x4975db[_0x4b715c(0x191)]),await this[_0x4b715c(0x15f)](_0xc53643['id'],_0x4975db[_0x4b715c(0x191)],{'failureMessage':_0x4975db['failureMessage'],'cardLast4':_0x4975db[_0x4b715c(0x12e)]?.[_0x4b715c(0x17a)],'paymentMethod':_0x4975db[_0x4b715c(0x12e)]?.[_0x4b715c(0x154)]}),loggerService_1[_0x4b715c(0x101)][_0x4b715c(0x17c)](_0x4b715c(0x12f),_0xc53643['id'],_0xc53643['status'],_0x4975db[_0x4b715c(0x191)],_0x270c92);}catch(_0x110d5b){console[_0x4b715c(0x106)](_0x4b715c(0x1ad),_0x110d5b),loggerService_1['loggerService'][_0x4b715c(0x194)](_0x4b715c(0x12f),_0x110d5b,_0x270c92);throw _0x110d5b;}}async[a61_0x29e8b9(0x1d7)](_0x3d083b){const _0x548eea=a61_0x29e8b9;console[_0x548eea(0x177)](_0x548eea(0x1cb),_0x3d083b);try{const _0x2e959b=await this[_0x548eea(0x14c)][_0x548eea(0x152)](_0x3d083b);if(!_0x2e959b['paymentId'])throw new Error(_0x548eea(0x170));const _0x15e819=await database_1[_0x548eea(0x1b2)]['payment'][_0x548eea(0x1e2)]({'where':{'gatewayOrderId':_0x2e959b['paymentId']}});if(!_0x15e819){console[_0x548eea(0x106)]('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x2e959b[_0x548eea(0x189)]);return;}console[_0x548eea(0x177)](_0x548eea(0x17b)+_0x15e819['id']+_0x548eea(0x19e)+_0x2e959b[_0x548eea(0x191)]),await this[_0x548eea(0x15f)](_0x15e819['id'],_0x2e959b[_0x548eea(0x191)],{'bankId':_0x2e959b['additionalInfo']?.[_0x548eea(0x159)],'remitterIban':_0x2e959b[_0x548eea(0x12e)]?.[_0x548eea(0x18e)],'remitterName':_0x2e959b[_0x548eea(0x12e)]?.[_0x548eea(0x1df)]}),loggerService_1[_0x548eea(0x101)]['logWebhookProcessed'](_0x548eea(0x1d1),_0x15e819['id'],_0x15e819[_0x548eea(0x191)],_0x2e959b['status'],_0x3d083b);}catch(_0x46a294){console['error']('Error\x20processing\x20Noda\x20webhook:',_0x46a294),loggerService_1[_0x548eea(0x101)]['logWebhookError'](_0x548eea(0x1d1),_0x46a294,_0x3d083b);throw _0x46a294;}}async[a61_0x29e8b9(0x19b)](_0x218774){const _0x50c87b=a61_0x29e8b9;console[_0x50c87b(0x177)](_0x50c87b(0x176),_0x218774);try{const _0x13da49=await this[_0x50c87b(0x138)]['processWebhook'](_0x218774);if(!_0x13da49[_0x50c87b(0x189)])throw new Error(_0x50c87b(0x10f));const _0x12dca9=await database_1[_0x50c87b(0x1b2)][_0x50c87b(0x1e3)][_0x50c87b(0x1e2)]({'where':{'gatewayOrderId':_0x13da49[_0x50c87b(0x189)]}});if(!_0x12dca9){console[_0x50c87b(0x106)](_0x50c87b(0x12c)+_0x13da49[_0x50c87b(0x189)]);return;}console[_0x50c87b(0x177)](_0x50c87b(0x118)+_0x12dca9['id']+_0x50c87b(0x19e)+_0x13da49[_0x50c87b(0x191)]),await this[_0x50c87b(0x15f)](_0x12dca9['id'],_0x13da49[_0x50c87b(0x191)]),loggerService_1['loggerService'][_0x50c87b(0x17c)](_0x50c87b(0x120),_0x12dca9['id'],_0x12dca9[_0x50c87b(0x191)],_0x13da49[_0x50c87b(0x191)],_0x218774);}catch(_0x13aa15){console['error'](_0x50c87b(0x18b),_0x13aa15),loggerService_1['loggerService'][_0x50c87b(0x194)](_0x50c87b(0x120),_0x13aa15,_0x218774);throw _0x13aa15;}}async['processCoinToPay2Webhook'](_0x363974){const _0x82b04d=a61_0x29e8b9;console[_0x82b04d(0x177)]('🔄\x20Processing\x20CoinToPay2\x20webhook:',_0x363974);try{const _0x167b65=await this[_0x82b04d(0x1ac)][_0x82b04d(0x152)](_0x363974);if(!_0x167b65[_0x82b04d(0x189)])throw new Error(_0x82b04d(0x1b0));const _0x3a538f=await database_1['default'][_0x82b04d(0x1e3)][_0x82b04d(0x1e2)]({'where':{'gatewayOrderId':_0x167b65[_0x82b04d(0x189)]}});if(!_0x3a538f){console[_0x82b04d(0x106)](_0x82b04d(0x1ae)+_0x167b65[_0x82b04d(0x189)]);return;}console[_0x82b04d(0x177)](_0x82b04d(0x1db)+_0x3a538f['id']+_0x82b04d(0x19e)+_0x167b65[_0x82b04d(0x191)]),await this[_0x82b04d(0x15f)](_0x3a538f['id'],_0x167b65['status']),loggerService_1[_0x82b04d(0x101)][_0x82b04d(0x17c)](_0x82b04d(0xfd),_0x3a538f['id'],_0x3a538f[_0x82b04d(0x191)],_0x167b65[_0x82b04d(0x191)],_0x363974);}catch(_0x3f1daa){console[_0x82b04d(0x106)](_0x82b04d(0x126),_0x3f1daa),loggerService_1[_0x82b04d(0x101)][_0x82b04d(0x194)]('cointopay2',_0x3f1daa,_0x363974);throw _0x3f1daa;}}async[a61_0x29e8b9(0x1d3)](_0x3060c8){const _0x41a184=a61_0x29e8b9;console[_0x41a184(0x177)](_0x41a184(0x1a8),_0x3060c8);try{const _0x391bc2=await this['klymeService'][_0x41a184(0x152)](_0x3060c8);if(!_0x391bc2[_0x41a184(0x189)])throw new Error(_0x41a184(0x1ea));const _0x240218=await database_1[_0x41a184(0x1b2)][_0x41a184(0x1e3)][_0x41a184(0x1e2)]({'where':{'gatewayOrderId':_0x391bc2['paymentId']}});if(!_0x240218){console[_0x41a184(0x106)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x391bc2[_0x41a184(0x189)]);return;}console['log'](_0x41a184(0x117)+_0x240218['id']+_0x41a184(0x19e)+_0x391bc2[_0x41a184(0x191)]),await this[_0x41a184(0x15f)](_0x240218['id'],_0x391bc2[_0x41a184(0x191)],{'paymentMethod':_0x391bc2[_0x41a184(0x12e)]?.[_0x41a184(0x1ab)]}),loggerService_1[_0x41a184(0x101)][_0x41a184(0x17c)](_0x41a184(0x14e),_0x240218['id'],_0x240218[_0x41a184(0x191)],_0x391bc2[_0x41a184(0x191)],_0x3060c8);}catch(_0x136021){console[_0x41a184(0x106)](_0x41a184(0x1e5),_0x136021),loggerService_1[_0x41a184(0x101)]['logWebhookError'](_0x41a184(0x14e),_0x136021,_0x3060c8);throw _0x136021;}}async[a61_0x29e8b9(0x1d4)](_0x146410){const _0x541cd3=a61_0x29e8b9;console[_0x541cd3(0x177)](_0x541cd3(0x15b),JSON['stringify'](_0x146410,null,0x2));try{const _0x1c4da6=await this['masterCardService'][_0x541cd3(0x152)](_0x146410);console['log']('📊\x20MasterCard\x20webhook\x20result:',_0x1c4da6);if(!_0x1c4da6[_0x541cd3(0x189)]){console[_0x541cd3(0x106)](_0x541cd3(0x198)),console[_0x541cd3(0x106)](_0x541cd3(0x1c2),Object['keys'](_0x146410));throw new Error(_0x541cd3(0x14d));}let _0x27ad21=null;console[_0x541cd3(0x177)](_0x541cd3(0x1d8)+_0x1c4da6['paymentId']);_0x1c4da6[_0x541cd3(0x189)]&&(console['log'](_0x541cd3(0x127)),_0x27ad21=await database_1['default'][_0x541cd3(0x1e3)][_0x541cd3(0x1e2)]({'where':{'AND':[{'gateway':_0x541cd3(0x14a)},{'OR':[{'gatewayPaymentId':_0x1c4da6['paymentId']},{'gatewayOrderId':_0x1c4da6[_0x541cd3(0x189)]},{'id':_0x1c4da6[_0x541cd3(0x189)]},{'orderId':_0x1c4da6['paymentId']}]}]}}),console[_0x541cd3(0x177)](_0x541cd3(0x15c)+(_0x27ad21?_0x541cd3(0x13a)+_0x27ad21['id']:_0x541cd3(0x173))));if(!_0x27ad21){console[_0x541cd3(0x106)]('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x1c4da6[_0x541cd3(0x189)]),console[_0x541cd3(0x106)](_0x541cd3(0x1a3)+_0x1c4da6[_0x541cd3(0x189)]+'\x22,\x20id=\x22'+_0x1c4da6['paymentId']+_0x541cd3(0x150)+_0x1c4da6[_0x541cd3(0x189)]+'\x22');const _0x3dcae9=await database_1[_0x541cd3(0x1b2)][_0x541cd3(0x1e3)]['findMany']({'where':{'gateway':'mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x541cd3(0x177)](_0x541cd3(0x109),_0x3dcae9);return;}console['log'](_0x541cd3(0x186)+_0x27ad21['id']+_0x541cd3(0x1aa)+_0x27ad21[_0x541cd3(0x191)]+_0x541cd3(0x1b9)+_0x1c4da6[_0x541cd3(0x191)]),await this['updatePaymentStatus'](_0x27ad21['id'],_0x1c4da6['status']),loggerService_1[_0x541cd3(0x101)][_0x541cd3(0x17c)](_0x541cd3(0x14a),_0x27ad21['id'],_0x27ad21[_0x541cd3(0x191)],_0x1c4da6['status'],_0x146410);}catch(_0x1378ed){console[_0x541cd3(0x106)](_0x541cd3(0x1ca),_0x1378ed),loggerService_1['loggerService'][_0x541cd3(0x194)](_0x541cd3(0x14a),_0x1378ed,_0x146410);throw _0x1378ed;}}async['processAmerWebhook'](_0x805c4a){const _0x1b3083=a61_0x29e8b9;console[_0x1b3083(0x177)]('🔄\x20Processing\x20Amer\x20webhook:',JSON[_0x1b3083(0x16b)](_0x805c4a,null,0x2));try{const _0x592c0d=await this['amerService'][_0x1b3083(0x152)](_0x805c4a);console['log']('📊\x20Amer\x20webhook\x20result:',_0x592c0d);if(!_0x592c0d[_0x1b3083(0x189)]){console[_0x1b3083(0x106)](_0x1b3083(0x107)),console[_0x1b3083(0x106)](_0x1b3083(0x1c2),Object[_0x1b3083(0x137)](_0x805c4a));throw new Error(_0x1b3083(0x1c9));}let _0x23a8f0=null;console[_0x1b3083(0x177)](_0x1b3083(0x139)+_0x592c0d['paymentId']),_0x23a8f0=await database_1[_0x1b3083(0x1b2)][_0x1b3083(0x1e3)][_0x1b3083(0x1e2)]({'where':{'AND':[{'gateway':_0x1b3083(0x155)},{'OR':[{'gatewayPaymentId':_0x592c0d[_0x1b3083(0x189)]},{'gatewayOrderId':_0x592c0d[_0x1b3083(0x189)]},{'id':_0x592c0d['paymentId']},{'orderId':_0x592c0d[_0x1b3083(0x189)]}]}]}}),console[_0x1b3083(0x177)](_0x1b3083(0x15c)+(_0x23a8f0?_0x1b3083(0x13a)+_0x23a8f0['id']:_0x1b3083(0x173)));if(!_0x23a8f0){console[_0x1b3083(0x106)]('❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20'+_0x592c0d[_0x1b3083(0x189)]);return;}console[_0x1b3083(0x177)](_0x1b3083(0x136)+_0x23a8f0['id']+_0x1b3083(0x19e)+_0x592c0d['status']),await this[_0x1b3083(0x15f)](_0x23a8f0['id'],_0x592c0d['status'],{'cardLast4':_0x592c0d[_0x1b3083(0x12e)]?.[_0x1b3083(0x17a)],'paymentMethod':_0x592c0d['additionalInfo']?.[_0x1b3083(0x154)]});}catch(_0x29cf96){console['error'](_0x1b3083(0x19f),_0x29cf96),loggerService_1[_0x1b3083(0x101)]['logWebhookError'](_0x1b3083(0x155),_0x29cf96,_0x805c4a);throw _0x29cf96;}}async[a61_0x29e8b9(0x174)](_0x964aad,_0x7cdd80){const _0x4b2ce0=a61_0x29e8b9,_0x3053a4=Date[_0x4b2ce0(0x1bc)]();try{const _0x41ea25=_0x964aad[_0x4b2ce0(0x1e8)],_0x52456e=_0x41ea25[_0x4b2ce0(0x160)];if(!_0x52456e?.[_0x4b2ce0(0x158)]){console[_0x4b2ce0(0x177)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x41ea25['id']);return;}const _0x2d56ea=_0x7cdd80===_0x4b2ce0(0x1a0)?_0x4b2ce0(0x187):_0x7cdd80==='FAILED'?_0x4b2ce0(0x1b8):_0x7cdd80===_0x4b2ce0(0x1ba)?_0x4b2ce0(0x1b8):_0x7cdd80===_0x4b2ce0(0x12b)?_0x4b2ce0(0x1b8):_0x7cdd80===_0x4b2ce0(0x183)?_0x4b2ce0(0x1b8):'payment.pending';let _0x98ff81=[];if(_0x52456e['webhookEvents'])try{_0x98ff81=Array[_0x4b2ce0(0x1cf)](_0x52456e['webhookEvents'])?_0x52456e['webhookEvents']:JSON[_0x4b2ce0(0x171)](_0x52456e[_0x4b2ce0(0x145)]);}catch(_0x29b94b){console[_0x4b2ce0(0x106)](_0x4b2ce0(0x1c3),_0x29b94b),_0x98ff81=[];}if(!_0x98ff81[_0x4b2ce0(0x1d0)](_0x2d56ea)){console[_0x4b2ce0(0x177)](_0x4b2ce0(0x149)+_0x2d56ea+_0x4b2ce0(0xfc)+_0x41ea25['id']);return;}const _0x2d5b90={'event':_0x2d56ea,'payment':{'id':_0x964aad['id'],'order_id':_0x964aad[_0x4b2ce0(0x119)],'gateway_order_id':_0x964aad[_0x4b2ce0(0x18c)],'gateway':_0x964aad[_0x4b2ce0(0x13c)],'amount':_0x964aad['amount'],'currency':_0x964aad[_0x4b2ce0(0x197)],'status':_0x7cdd80[_0x4b2ce0(0x1d9)](),'customer_email':_0x964aad['customerEmail'],'customer_name':_0x964aad['customerName'],'failure_message':_0x964aad['failureMessage'],'tx_urls':_0x964aad[_0x4b2ce0(0x142)]?JSON[_0x4b2ce0(0x171)](_0x964aad[_0x4b2ce0(0x142)]):null,'created_at':_0x964aad[_0x4b2ce0(0x12d)],'updated_at':_0x964aad[_0x4b2ce0(0x178)]}},_0x1c7fc9=await fetch(_0x52456e['webhookUrl'],{'method':_0x4b2ce0(0x132),'headers':{'Content-Type':_0x4b2ce0(0x10e),'User-Agent':_0x4b2ce0(0x1da)},'body':JSON[_0x4b2ce0(0x16b)](_0x2d5b90)}),_0x273617=Date[_0x4b2ce0(0x1bc)]()-_0x3053a4,_0x315696=_0x1c7fc9['ok']?_0x4b2ce0(0x122):await _0x1c7fc9[_0x4b2ce0(0x1c7)]();loggerService_1[_0x4b2ce0(0x101)][_0x4b2ce0(0x144)](_0x964aad[_0x4b2ce0(0x1a1)],_0x52456e['webhookUrl'],_0x2d56ea,_0x1c7fc9[_0x4b2ce0(0x191)],_0x273617,_0x2d5b90),console[_0x4b2ce0(0x177)](_0x4b2ce0(0x13e)+_0x52456e[_0x4b2ce0(0x158)]+'\x20with\x20status\x20'+_0x1c7fc9['status']+'\x20('+_0x273617+_0x4b2ce0(0x16a));}catch(_0x4eb279){console[_0x4b2ce0(0x106)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x4eb279),loggerService_1[_0x4b2ce0(0x101)][_0x4b2ce0(0x1e4)](_0x964aad[_0x4b2ce0(0x1a1)],_0x964aad[_0x4b2ce0(0x1e8)]?.[_0x4b2ce0(0x160)]?.['webhookUrl']||'unknown',_0x4b2ce0(0x14b),_0x4eb279,{});}}async[a61_0x29e8b9(0x108)](_0x521f9a,_0x1e4058){const _0x234222=a61_0x29e8b9;try{const _0x319eb1={'PENDING':'created','PROCESSING':_0x234222(0x184),'PAID':_0x234222(0x1b7),'FAILED':_0x234222(0xff),'EXPIRED':'expired','REFUND':_0x234222(0x1b1),'CHARGEBACK':'chargeback'},_0xff12c6=_0x319eb1[_0x1e4058];if(!_0xff12c6||_0xff12c6==='created')return;await telegramBotService_1['telegramBotService'][_0x234222(0x1c5)](_0x521f9a['shopId'],_0x521f9a,_0xff12c6);}catch(_0x436641){console[_0x234222(0x106)](_0x234222(0x1bf),_0x436641);}}async[a61_0x29e8b9(0x16c)](_0x55b572,_0x39f582){const _0x1af1b0=a61_0x29e8b9;try{const _0x1ffd51=await database_1[_0x1af1b0(0x1b2)][_0x1af1b0(0x1e8)]['findUnique']({'where':{'id':_0x55b572},'select':{'gatewaySettings':!![]}});if(!_0x1ffd51?.[_0x1af1b0(0x146)])return console[_0x1af1b0(0x177)](_0x1af1b0(0x172)+_0x55b572+_0x1af1b0(0x15a)),0xa;const _0x2d64c1=JSON['parse'](_0x1ffd51[_0x1af1b0(0x146)]);for(const [_0x5806fd,_0x1c697b]of Object['entries'](_0x2d64c1)){if(_0x5806fd[_0x1af1b0(0x1d9)]()===_0x39f582[_0x1af1b0(0x1d9)]()){const _0x429c10=_0x1c697b[_0x1af1b0(0x185)]||0xa;return console[_0x1af1b0(0x177)]('Gateway\x20'+_0x39f582+'\x20commission\x20for\x20shop\x20'+_0x55b572+':\x20'+_0x429c10+'%'),_0x429c10;}}return console[_0x1af1b0(0x177)](_0x1af1b0(0x133)+_0x39f582+_0x1af1b0(0x135)+_0x55b572+_0x1af1b0(0x151)),0xa;}catch(_0x3b4d6c){return console[_0x1af1b0(0x106)](_0x1af1b0(0x130)+_0x55b572+_0x1af1b0(0x1bb)+_0x39f582+':',_0x3b4d6c),0xa;}}}exports['WebhookService']=WebhookService;