'use strict';function a52_0x42b3(){const _0x32efdd=['272371wvyqhS','txUrls','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','payment','PlisioService','status','paymentMethod','webhookLog','Processing\x20Rapyd\x20webhook:','ðŸ”„\x20Updating\x20payment\x20','plisio_gateway','expired','Payment\x20','log','969uNBxeg','WebhookService','telegramBotService','TesSoft\x20Payment\x20System/1.0','toLowerCase','sendShopWebhook','PaymentLinkService','../config/database','Processing\x20KLYME\x20webhook:','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook','Error\x20processing\x20KLYME\x20webhook:','\x20with\x20status\x20','settings','âœ…\x20Payment\x20','550nRewNa','Processing\x20Plisio\x20webhook:','ðŸ’¥\x20Payment\x20','21DKHHPC','./loggerService','processPlisioGatewayWebhook','bankId','loggerService','region','\x20webhook','klymeService','nodaService','Processing\x20CoinToPay\x20webhook:','Failed\x20to\x20send\x20shop\x20webhook:','parse','CoinToPayService','cardLast4','updatePaymentStatus','webhookUrl','unknown','webhook_send','application/json','./gateways/coinToPayService','rapyd','now','plisioService','\x20transaction\x20URLs:','gatewayOrderId','shop','ðŸ’¾\x20Saving\x20failure\x20message:\x20','_webhook_','remitterIban','5970852EpyeXS','logShopWebhookSent','\x20not\x20enabled\x20for\x20shop\x20','noda','2ikHjRg','payment.failed','paid','Success','4574735sYiUoe','No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook','logWebhookProcessed','\x20updated\x20successfully:\x20','PENDING','ðŸ”—\x20Payment\x20','NodaService','currency','text','Webhook\x20event\x20','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','\x20->\x20','21644qMyDyE','POST','paymentId','sendPaymentStatusNotification','750648NsJtWw','update','__esModule','remitterName','Error\x20processing\x20Rapyd\x20webhook:','created','create','Processing\x20Noda\x20webhook:','processWebhook','Shop\x20webhook\x20sent\x20to\x20','gateway','handleSuccessfulPayment','customerEmail','klyme_','error','paymentLinkService','EXPIRED','\x20status\x20change:\x20','includes','webhookEvents','length','shopId','Failed\x20to\x20update\x20payment\x20link\x20counter:','processRapydWebhook','additionalInfo','7621749Egmtzy','Processing\x20Plisio\x20Gateway\x20webhook:','stringify','No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook','ðŸ’¾\x20Failure\x20message\x20saved:\x20','coinToPayService','\x20URLs','PAID','failureMessage','Error\x20processing\x20Plisio\x20webhook:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20failure\x20message:\x20','klyme','rapydService','default','./telegramBotService','logWebhookError','cointopay','isArray','RapydService','paidAt','KlymeService','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','plisio','./gateways/nodaService','Error\x20parsing\x20webhook\x20events:','1448373EKWupr','customerName'];a52_0x42b3=function(){return _0x32efdd;};return a52_0x42b3();}const a52_0x10cbc7=a52_0x113c;(function(_0x3530a1,_0x294c4f){const _0x36f4ee=a52_0x113c,_0x877335=_0x3530a1();while(!![]){try{const _0x5810f9=parseInt(_0x36f4ee(0xea))/0x1*(-parseInt(_0x36f4ee(0x12c))/0x2)+parseInt(_0x36f4ee(0xfa))/0x3*(parseInt(_0x36f4ee(0x13c))/0x4)+-parseInt(_0x36f4ee(0x130))/0x5+-parseInt(_0x36f4ee(0x128))/0x6+parseInt(_0x36f4ee(0x10b))/0x7*(parseInt(_0x36f4ee(0x140))/0x8)+parseInt(_0x36f4ee(0x159))/0x9+parseInt(_0x36f4ee(0x108))/0xa*(parseInt(_0x36f4ee(0xec))/0xb);if(_0x5810f9===_0x294c4f)break;else _0x877335['push'](_0x877335['shift']());}catch(_0x2364fc){_0x877335['push'](_0x877335['shift']());}}}(a52_0x42b3,0xd6b8c));function a52_0x113c(_0x15f058,_0x134a1e){const _0x42b307=a52_0x42b3();return a52_0x113c=function(_0x113c0a,_0x464f4e){_0x113c0a=_0x113c0a-0xe3;let _0xb98d1=_0x42b307[_0x113c0a];return _0xb98d1;},a52_0x113c(_0x15f058,_0x134a1e);}var __importDefault=this&&this['__importDefault']||function(_0x4101d8){const _0x2fd809=a52_0x113c;return _0x4101d8&&_0x4101d8[_0x2fd809(0x142)]?_0x4101d8:{'default':_0x4101d8};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a52_0x10cbc7(0xfb)]=void 0x0;const database_1=__importDefault(require(a52_0x10cbc7(0x101))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a52_0x10cbc7(0xe8)),coinToPayService_1=require(a52_0x10cbc7(0x11e)),klymeService_1=require('./gateways/klymeService'),telegramBotService_1=require(a52_0x10cbc7(0x168)),paymentLinkService_1=require('./paymentLinkService'),loggerService_1=require(a52_0x10cbc7(0x10c));class WebhookService{constructor(){const _0x3b0ef6=a52_0x10cbc7;this[_0x3b0ef6(0x121)]=new plisioService_1[(_0x3b0ef6(0xf0))](),this[_0x3b0ef6(0x166)]=new rapydService_1[(_0x3b0ef6(0xe3))](),this[_0x3b0ef6(0x113)]=new nodaService_1[(_0x3b0ef6(0x136))](),this[_0x3b0ef6(0x15e)]=new coinToPayService_1[(_0x3b0ef6(0x117))](),this[_0x3b0ef6(0x112)]=new klymeService_1[(_0x3b0ef6(0xe5))](),this['paymentLinkService']=new paymentLinkService_1[(_0x3b0ef6(0x100))]();}async['processPlisioWebhook'](_0x5998eb){const _0x5c1ead=a52_0x10cbc7;console[_0x5c1ead(0xf9)](_0x5c1ead(0x109),_0x5998eb);try{const _0x34ab83=await this[_0x5c1ead(0x121)]['processWebhook'](_0x5998eb);if(!_0x34ab83[_0x5c1ead(0x13e)]){console['error'](_0x5c1ead(0x103));return;}await this[_0x5c1ead(0x119)](_0x34ab83[_0x5c1ead(0x13e)],_0x34ab83[_0x5c1ead(0xf1)],_0x5c1ead(0xe7),_0x5998eb,undefined,undefined,_0x34ab83['txUrls']),loggerService_1[_0x5c1ead(0x10f)]['logWebhookProcessed'](_0x5c1ead(0xe7),_0x34ab83[_0x5c1ead(0x13e)],_0x5c1ead(0x134),_0x34ab83['status'],_0x5998eb);}catch(_0xe7013a){console[_0x5c1ead(0x14e)](_0x5c1ead(0x162),_0xe7013a),loggerService_1[_0x5c1ead(0x10f)][_0x5c1ead(0x169)](_0x5c1ead(0xe7),_0xe7013a,_0x5998eb);throw _0xe7013a;}}async[a52_0x10cbc7(0x10d)](_0x307eea){const _0x3bae95=a52_0x10cbc7;console[_0x3bae95(0xf9)](_0x3bae95(0x15a),_0x307eea);try{const _0x1e764f=await this[_0x3bae95(0x121)][_0x3bae95(0x148)](_0x307eea);if(!_0x1e764f['paymentId']){console[_0x3bae95(0x14e)]('No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook');return;}await this[_0x3bae95(0x119)](_0x1e764f['paymentId'],_0x1e764f[_0x3bae95(0xf1)],'plisio',_0x307eea,undefined,undefined,_0x1e764f[_0x3bae95(0xed)]),loggerService_1[_0x3bae95(0x10f)]['logWebhookProcessed'](_0x3bae95(0xf6),_0x1e764f[_0x3bae95(0x13e)],'PENDING',_0x1e764f[_0x3bae95(0xf1)],_0x307eea);}catch(_0x3367b5){console[_0x3bae95(0x14e)](_0x3bae95(0xe6),_0x3367b5),loggerService_1[_0x3bae95(0x10f)][_0x3bae95(0x169)]('plisio_gateway',_0x3367b5,_0x307eea);throw _0x3367b5;}}async[a52_0x10cbc7(0x157)](_0x474d08){const _0x2f2ee0=a52_0x10cbc7;console[_0x2f2ee0(0xf9)](_0x2f2ee0(0xf4),_0x474d08);try{const _0x581300=await this[_0x2f2ee0(0x166)][_0x2f2ee0(0x148)](_0x474d08);if(!_0x581300['paymentId']){console['error'](_0x2f2ee0(0x15c));return;}await this[_0x2f2ee0(0x119)](_0x581300[_0x2f2ee0(0x13e)],_0x581300[_0x2f2ee0(0xf1)],_0x2f2ee0(0x11f),_0x474d08,_0x581300[_0x2f2ee0(0x161)],_0x581300[_0x2f2ee0(0x158)]),loggerService_1[_0x2f2ee0(0x10f)][_0x2f2ee0(0x132)](_0x2f2ee0(0x11f),_0x581300[_0x2f2ee0(0x13e)],_0x2f2ee0(0x134),_0x581300['status'],_0x474d08);}catch(_0x5a8713){console[_0x2f2ee0(0x14e)](_0x2f2ee0(0x144),_0x5a8713),loggerService_1[_0x2f2ee0(0x10f)]['logWebhookError'](_0x2f2ee0(0x11f),_0x5a8713,_0x474d08);throw _0x5a8713;}}async['processNodaWebhook'](_0x5283f7){const _0x466488=a52_0x10cbc7;console['log'](_0x466488(0x147),_0x5283f7);try{const _0x3427f6=await this[_0x466488(0x113)][_0x466488(0x148)](_0x5283f7);if(!_0x3427f6[_0x466488(0x13e)]){console[_0x466488(0x14e)]('No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook');return;}await this[_0x466488(0x119)](_0x3427f6['paymentId'],_0x3427f6[_0x466488(0xf1)],_0x466488(0x12b),_0x5283f7,undefined,_0x3427f6[_0x466488(0x158)]),loggerService_1[_0x466488(0x10f)][_0x466488(0x132)](_0x466488(0x12b),_0x3427f6[_0x466488(0x13e)],_0x466488(0x134),_0x3427f6[_0x466488(0xf1)],_0x5283f7);}catch(_0x518aef){console[_0x466488(0x14e)]('Error\x20processing\x20Noda\x20webhook:',_0x518aef),loggerService_1['loggerService']['logWebhookError']('noda',_0x518aef,_0x5283f7);throw _0x518aef;}}async['processCoinToPayWebhook'](_0xc4c479){const _0x2dbc80=a52_0x10cbc7;console[_0x2dbc80(0xf9)](_0x2dbc80(0x114),_0xc4c479);try{const _0x137034=await this['coinToPayService'][_0x2dbc80(0x148)](_0xc4c479);if(!_0x137034[_0x2dbc80(0x13e)]){console['error']('No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook');return;}await this[_0x2dbc80(0x119)](_0x137034[_0x2dbc80(0x13e)],_0x137034['status'],_0x2dbc80(0x16a),_0xc4c479),loggerService_1[_0x2dbc80(0x10f)][_0x2dbc80(0x132)](_0x2dbc80(0x16a),_0x137034[_0x2dbc80(0x13e)],_0x2dbc80(0x134),_0x137034[_0x2dbc80(0xf1)],_0xc4c479);}catch(_0x253276){console['error']('Error\x20processing\x20CoinToPay\x20webhook:',_0x253276),loggerService_1[_0x2dbc80(0x10f)]['logWebhookError'](_0x2dbc80(0x16a),_0x253276,_0xc4c479);throw _0x253276;}}async['processKlymeWebhook'](_0xc46fec){const _0xf0c294=a52_0x10cbc7;console[_0xf0c294(0xf9)](_0xf0c294(0x102),_0xc46fec);try{const _0x30997d=await this[_0xf0c294(0x112)][_0xf0c294(0x148)](_0xc46fec);if(!_0x30997d[_0xf0c294(0x13e)]){console[_0xf0c294(0x14e)](_0xf0c294(0x131));return;}const _0x42a79c=_0x30997d[_0xf0c294(0x110)]?_0xf0c294(0x14d)+_0x30997d[_0xf0c294(0x110)]['toLowerCase']():'klyme_eu';await this['updatePaymentStatus'](_0x30997d['paymentId'],_0x30997d[_0xf0c294(0xf1)],_0x42a79c,_0xc46fec,undefined,_0x30997d[_0xf0c294(0x158)]),loggerService_1[_0xf0c294(0x10f)][_0xf0c294(0x132)]('klyme',_0x30997d[_0xf0c294(0x13e)],_0xf0c294(0x134),_0x30997d[_0xf0c294(0xf1)],_0xc46fec);}catch(_0x572efc){console[_0xf0c294(0x14e)](_0xf0c294(0x104),_0x572efc),loggerService_1[_0xf0c294(0x10f)][_0xf0c294(0x169)](_0xf0c294(0x165),_0x572efc,_0xc46fec);throw _0x572efc;}}async[a52_0x10cbc7(0x119)](_0x5031fd,_0x27dff3,_0x5569e5,_0x221d61,_0x16fdc8,_0x29b6c8,_0x4885c3){const _0x2b553a=a52_0x10cbc7;console['log'](_0x2b553a(0xf5)+_0x5031fd+'\x20status\x20to\x20'+_0x27dff3+'\x20from\x20'+_0x5569e5+_0x2b553a(0x111));_0x16fdc8&&console[_0x2b553a(0xf9)](_0x2b553a(0x10a)+_0x5031fd+_0x2b553a(0x164)+_0x16fdc8);_0x4885c3&&_0x4885c3[_0x2b553a(0x154)]>0x0&&console[_0x2b553a(0xf9)](_0x2b553a(0x135)+_0x5031fd+_0x2b553a(0x122),_0x4885c3);const _0x2f479c=await database_1[_0x2b553a(0x167)][_0x2b553a(0xef)]['findFirst']({'where':{'gatewayOrderId':_0x5031fd,'gateway':_0x5569e5},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2f479c){console[_0x2b553a(0x14e)](_0x2b553a(0x13a)+_0x5031fd+'\x20and\x20gateway:\x20'+_0x5569e5);return;}const _0xd73285=_0x2f479c[_0x2b553a(0xf1)];if(_0xd73285===_0x27dff3){console[_0x2b553a(0xf9)](_0x2b553a(0xf8)+_0x2f479c['id']+'\x20status\x20unchanged\x20('+_0x27dff3+')');return;}console[_0x2b553a(0xf9)](_0x2b553a(0xf8)+_0x2f479c['id']+_0x2b553a(0x151)+_0xd73285+_0x2b553a(0x13b)+_0x27dff3);const _0x4e179e={'status':_0x27dff3,'updatedAt':new Date()};_0x16fdc8&&(_0x4e179e[_0x2b553a(0x161)]=_0x16fdc8,console[_0x2b553a(0xf9)](_0x2b553a(0x125)+_0x16fdc8));_0x4885c3&&_0x4885c3['length']>0x0&&(_0x4e179e['txUrls']=JSON[_0x2b553a(0x15b)](_0x4885c3),console[_0x2b553a(0xf9)]('ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20'+JSON[_0x2b553a(0x15b)](_0x4885c3)));_0x27dff3===_0x2b553a(0x160)&&_0xd73285!==_0x2b553a(0x160)&&(_0x4e179e[_0x2b553a(0xe4)]=new Date());_0x29b6c8&&(_0x29b6c8[_0x2b553a(0x118)]&&(_0x4e179e[_0x2b553a(0x118)]=_0x29b6c8[_0x2b553a(0x118)]),_0x29b6c8[_0x2b553a(0xf2)]&&(_0x4e179e['paymentMethod']=_0x29b6c8[_0x2b553a(0xf2)]),_0x29b6c8[_0x2b553a(0x10e)]&&(_0x4e179e['bankId']=_0x29b6c8[_0x2b553a(0x10e)]),_0x29b6c8[_0x2b553a(0x127)]&&(_0x4e179e[_0x2b553a(0x127)]=_0x29b6c8['remitterIban']),_0x29b6c8[_0x2b553a(0x143)]&&(_0x4e179e['remitterName']=_0x29b6c8[_0x2b553a(0x143)]));await database_1[_0x2b553a(0x167)][_0x2b553a(0xef)][_0x2b553a(0x141)]({'where':{'id':_0x2f479c['id']},'data':_0x4e179e});if(_0x27dff3===_0x2b553a(0x160)&&_0xd73285!==_0x2b553a(0x160))try{await this[_0x2b553a(0x14f)][_0x2b553a(0x14b)](_0x2f479c['id']);}catch(_0x11387c){console[_0x2b553a(0x14e)](_0x2b553a(0x156),_0x11387c);}await database_1[_0x2b553a(0x167)][_0x2b553a(0xf3)][_0x2b553a(0x146)]({'data':{'paymentId':_0x2f479c['id'],'shopId':_0x2f479c[_0x2b553a(0x155)],'event':_0x5569e5+_0x2b553a(0x126)+_0x27dff3[_0x2b553a(0xfe)](),'statusCode':0xc8,'responseBody':JSON[_0x2b553a(0x15b)]({'oldStatus':_0xd73285,'newStatus':_0x27dff3,'failureMessage':_0x16fdc8,'txUrls':_0x4885c3,'webhookData':_0x221d61})}}),await this[_0x2b553a(0xff)](_0x2f479c,_0x27dff3),await this[_0x2b553a(0x13f)](_0x2f479c,_0x27dff3),console[_0x2b553a(0xf9)](_0x2b553a(0x107)+_0x2f479c['id']+_0x2b553a(0x133)+_0xd73285+_0x2b553a(0x13b)+_0x27dff3),_0x16fdc8&&console[_0x2b553a(0xf9)](_0x2b553a(0x15d)+_0x16fdc8),_0x4885c3&&_0x4885c3[_0x2b553a(0x154)]>0x0&&console['log']('ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20'+_0x4885c3[_0x2b553a(0x154)]+_0x2b553a(0x15f));}async[a52_0x10cbc7(0xff)](_0x2a586e,_0x4e24ea){const _0x291ca2=a52_0x10cbc7,_0x1aa6e6=Date[_0x291ca2(0x120)]();try{const _0x28ecff=_0x2a586e[_0x291ca2(0x124)],_0x25e437=_0x28ecff[_0x291ca2(0x106)];if(!_0x25e437?.[_0x291ca2(0x11a)]){console[_0x291ca2(0xf9)](_0x291ca2(0xee)+_0x28ecff['id']);return;}const _0x17847f=_0x4e24ea===_0x291ca2(0x160)?'payment.success':_0x4e24ea==='FAILED'?_0x291ca2(0x12d):_0x4e24ea===_0x291ca2(0x150)?_0x291ca2(0x12d):'payment.pending';let _0x3eecc3=[];if(_0x25e437[_0x291ca2(0x153)])try{_0x3eecc3=Array[_0x291ca2(0x16b)](_0x25e437[_0x291ca2(0x153)])?_0x25e437[_0x291ca2(0x153)]:JSON[_0x291ca2(0x116)](_0x25e437['webhookEvents']);}catch(_0x1ecb87){console['error'](_0x291ca2(0xe9),_0x1ecb87),_0x3eecc3=[];}if(!_0x3eecc3[_0x291ca2(0x152)](_0x17847f)){console['log'](_0x291ca2(0x139)+_0x17847f+_0x291ca2(0x12a)+_0x28ecff['id']);return;}let _0xf07985;if(_0x2a586e[_0x291ca2(0xed)])try{_0xf07985=JSON[_0x291ca2(0x116)](_0x2a586e[_0x291ca2(0xed)]);}catch(_0x3d4df3){console[_0x291ca2(0x14e)]('Error\x20parsing\x20tx_urls\x20for\x20webhook:',_0x3d4df3),_0xf07985=undefined;}const _0x4a5936={'event':_0x17847f,'payment':{'id':_0x2a586e['id'],'order_id':_0x2a586e['orderId'],'gateway_order_id':_0x2a586e[_0x291ca2(0x123)],'gateway':_0x2a586e[_0x291ca2(0x14a)],'amount':_0x2a586e['amount'],'currency':_0x2a586e[_0x291ca2(0x137)],'status':_0x4e24ea[_0x291ca2(0xfe)](),'customer_email':_0x2a586e[_0x291ca2(0x14c)],'customer_name':_0x2a586e[_0x291ca2(0xeb)],'failure_message':_0x2a586e[_0x291ca2(0x161)],'tx_urls':_0xf07985,'created_at':_0x2a586e['createdAt'],'updated_at':new Date()}},_0x7ba33e=await fetch(_0x25e437[_0x291ca2(0x11a)],{'method':_0x291ca2(0x13d),'headers':{'Content-Type':_0x291ca2(0x11d),'User-Agent':_0x291ca2(0xfd)},'body':JSON[_0x291ca2(0x15b)](_0x4a5936)}),_0x8181a4=Date['now']()-_0x1aa6e6,_0x481c64=_0x7ba33e['ok']?_0x291ca2(0x12f):await _0x7ba33e[_0x291ca2(0x138)]();loggerService_1[_0x291ca2(0x10f)][_0x291ca2(0x129)](_0x2a586e[_0x291ca2(0x155)],_0x25e437['webhookUrl'],_0x17847f,_0x7ba33e[_0x291ca2(0xf1)],_0x8181a4,_0x4a5936),console[_0x291ca2(0xf9)](_0x291ca2(0x149)+_0x25e437[_0x291ca2(0x11a)]+_0x291ca2(0x105)+_0x7ba33e[_0x291ca2(0xf1)]+'\x20('+_0x8181a4+'ms)');}catch(_0x24cf10){console['error'](_0x291ca2(0x115),_0x24cf10),loggerService_1[_0x291ca2(0x10f)]['logShopWebhookError'](_0x2a586e[_0x291ca2(0x155)],_0x2a586e[_0x291ca2(0x124)]?.[_0x291ca2(0x106)]?.[_0x291ca2(0x11a)]||_0x291ca2(0x11b),_0x291ca2(0x11c),_0x24cf10,{});}}async[a52_0x10cbc7(0x13f)](_0x471cef,_0x519739){const _0xb3c1f4=a52_0x10cbc7;try{const _0x173649={'PENDING':_0xb3c1f4(0x145),'PAID':_0xb3c1f4(0x12e),'FAILED':'failed','EXPIRED':_0xb3c1f4(0xf7)},_0x5534c1=_0x173649[_0x519739];if(!_0x5534c1||_0x5534c1===_0xb3c1f4(0x145))return;await telegramBotService_1[_0xb3c1f4(0xfc)]['sendPaymentNotification'](_0x471cef[_0xb3c1f4(0x155)],_0x471cef,_0x5534c1);}catch(_0x3c55ca){console[_0xb3c1f4(0x14e)](_0xb3c1f4(0x163),_0x3c55ca);}}}exports[a52_0x10cbc7(0xfb)]=WebhookService;