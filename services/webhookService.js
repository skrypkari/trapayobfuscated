'use strict';const a66_0x382be0=a66_0x4a96;(function(_0x41a934,_0x216791){const _0x2d46b0=a66_0x4a96,_0x32d518=_0x41a934();while(!![]){try{const _0x49afb0=-parseInt(_0x2d46b0(0x194))/0x1*(parseInt(_0x2d46b0(0x1ee))/0x2)+parseInt(_0x2d46b0(0x19c))/0x3+parseInt(_0x2d46b0(0x1b1))/0x4+-parseInt(_0x2d46b0(0x262))/0x5*(-parseInt(_0x2d46b0(0x1f1))/0x6)+-parseInt(_0x2d46b0(0x1f7))/0x7*(-parseInt(_0x2d46b0(0x1c2))/0x8)+parseInt(_0x2d46b0(0x1c6))/0x9+-parseInt(_0x2d46b0(0x17e))/0xa*(parseInt(_0x2d46b0(0x225))/0xb);if(_0x49afb0===_0x216791)break;else _0x32d518['push'](_0x32d518['shift']());}catch(_0x595c13){_0x32d518['push'](_0x32d518['shift']());}}}(a66_0x421e,0x570ba));var __importDefault=this&&this[a66_0x382be0(0x243)]||function(_0x2f465a){const _0x1fc981=a66_0x382be0;return _0x2f465a&&_0x2f465a[_0x1fc981(0x19a)]?_0x2f465a:{'default':_0x2f465a};};function a66_0x421e(){const _0x47d139=['📊\x20Plisio\x20webhook:\x20Payment\x20','\x20status\x20updated\x20to\x20FAILED','mastercard','📈\x20Payment\x20details:\x20oldStatus=\x22','524780fWmziy','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','./gateways/amerService','payment','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','plisioService','\x20not\x20found','processMasterCardWebhook','includes','./currencyService','\x20commission:\x20','🔄\x20Processing\x20Amer\x20webhook:','loggerService',',\x20Card=****','688TJfCGa','defineProperty','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','29808NSVYJE','expired',',\x20gateway\x20','Found\x20payment\x20','visaMasterCardService','./loggerService','ℹ️\x20AmPay\x20status\x20','POST','📊\x20CoinToPay\x20webhook:\x20Payment\x20','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','processRapydWebhook','coinToPayService','sendPaymentStatusNotification','toISOString','webhookLog','\x20balance\x20updated:\x20','Payment\x20marked\x20as\x20CHARGEBACK\x20(no\x20penalty\x20specified)','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','client_transaction_id','VisaMasterCardService','errorMessage','txUrls','currencyService','🔄\x20Processing\x20AmPay\x20webhook:','visa','balance','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','findUnique','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','isArray','create','currentPayments','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','shopId','error','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','log','failed','💸\x20CHARGEBACK\x20penalty\x20ONLY:\x20-','2nPzQvN','system_id','payment_method','18UDdbAS','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','./gateways/coinToPayService','No\x20payment\x20ID\x20in\x20Noda\x20webhook','parse','34503anjaRW','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','default','gateway','Payment\x20System/1.0','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','created','customerOrderId','🔍\x20Search\x20result:\x20','💰\x20Payment\x20','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','📊\x20MyXSpend\x20webhook\x20data:','KlymeService','text','webhook_send','map','currency','AmPayTRYService','⚠️\x20CHARGEBACK\x20without\x20penalty\x20amount\x20-\x20no\x20balance\x20change','\x20=\x20','🏪\x20Shop\x20','\x20mapped\x20to\x20FAILED','amountAfterGatewayCommissionUSDT','🔄\x20Processing\x20CoinToPay2\x20webhook:',',\x20using\x20default\x2010%','Error\x20parsing\x20webhook\x20events:',',\x20status=','💰\x20Payment\x20amount\x20is\x20NOT\x20deducted\x20(chargeback\x20penalty\x20only)','updatePaymentStatus',',\x20card:\x20****','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','refund','\x20USDT','📊\x20VISA\x20webhook\x20result:','coinToPay2Service','telegramBotService','webhookEvents','findFirst','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','🔄\x20Processing\x20MyXSpend\x20webhook:','CoinToPay2Service','system','status','NodaService','PAID','RapydService','22dWzRLQ','\x20(Status:\x20','Query\x20params:','📊\x20Payment\x20status:\x20','📊\x20AmPay\x20webhook\x20data:','paidAt','shop','remitterName','./gateways/plisioService','no\x20balance\x20change','plisio_gateway','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','%\x20gateway\x20commission)','Success','amerService','ampay_','processing','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','dateTime','No\x20additional\x20info','Payment\x20not\x20found','🔄\x20Processing\x20Plisio\x20webhook:','DECLINED','📊\x20KLYME\x20webhook:\x20Payment\x20','\x20updated:\x20currentPayments=','🔄\x20Processing\x20CoinToPay\x20webhook:','\x20with\x20status\x20','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','webhook_status_change_','CoinToPayService','__importDefault',',\x20gatewayOrderId:\x20','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','toFixed','VISA\x20payment\x20not\x20found:\x20','🔄\x20Processing\x20AmPay\x20TRY\x20webhook:','\x22,\x20orderId=\x22','desc','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','./gateways/coinToPay2Service','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','💰\x20Converting\x20','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','klyme','nodaService','ms)','\x20in\x20shop\x20','\x20->\x20','🔄\x20Processing\x20MasterCard\x20webhook:','✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','🔍\x20Found\x20VISA\x20payment:\x20ID=','../config/database','gatewayOrderId','keys','📈\x20Payment\x20',',\x20gatewayPaymentId:\x20',',\x20GatewayOrderId=','logWebhookProcessed','paymentId','843055HzTXmD','failureMessage','❌\x20Error\x20processing\x20MasterCard\x20webhook:','processVisaWebhook','customerName','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','✅\x20Shop\x20','logWebhookError','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','klymeService','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','commission','\x20(orderId:\x20','./telegramBotService','paymentMethod','❌\x20VISA\x20webhook\x20processing\x20failed:','application/json','chargebackAmount','chargeback','cointopay2','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','stringify','orderId','VISA','processWebhook','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','noda','❌\x20Available\x20webhook\x20fields:','ampayService',',\x20Gateway=','Error\x20processing\x20CoinToPay\x20webhook:','additionalInfo','toUpperCase','\x20USDT\x20(chargeback\x20penalty\x20ONLY)','ampayTRYService','💰\x20Gateway\x20','unknown','No\x20payment\x20ID\x20in\x20VISA\x20webhook','bankId','sendPaymentNotification','getGatewayCommission','toLowerCase',',\x20newStatus=','./gateways/rapydService','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','myxspend_','payment.pending','EXPIRED','processAmPayTRYWebhook','cointopay','\x20-\x20','No\x20payment\x20ID\x20in\x20Amer\x20webhook','plisio','✅\x20Found\x20payment\x20','./gateways/mastercardService','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','ℹ️\x20Decline\x20reason:\x20','rapyd','customerEmail','paymentLinkId','MASTERCARD','ℹ️\x20MyXSpend\x20status\x20','Payment\x20','📤\x20Shop\x20webhook\x20sent\x20to\x20','gatewaySettings','COMPLETED','❌\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:','CHARGEBACK','ampay_try','\x20for\x20AmPay\x20webhook','Error\x20processing\x20Noda\x20webhook:','type','FAILED','gatewayPaymentId','\x20status\x20','\x22,\x20paymentLinkId=\x22','❌\x20Payment\x20link\x20','❌\x20Error\x20processing\x20AmPay\x20webhook:','username','SINGLE','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','payment.failed','\x22,\x20id=\x22','myxspend','webhookUrl','🔄\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','ℹ️\x20AmPay\x20TRY\x20status\x20','./gateways/nodaService','rapydService','update','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','✅\x20Payment\x20link\x20','settings','cardLast4','processKlymeWebhook','amount','ampay_try_','AmerService','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','2453130qWTFuE','processPlisioWebhook','AmPayService','visa/mastercard','💰\x20Final\x20balance\x20after\x20chargeback:\x20','visa_','🔄\x20MyXSpend\x20status\x20','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','📊\x20Noda\x20webhook:\x20Payment\x20','🔍\x20VISA\x20payment\x20search\x20executed','processAmerWebhook','📊\x20Amer\x20webhook:\x20Payment\x20','remitterIban','Not\x20found','./gateways/klymeService','amountUSDT','💰\x20Amount\x20after\x20gateway\x20commission:\x20','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','amer','Webhook\x20event\x20','findMany','Error\x20processing\x20Plisio\x20webhook:','438506nMOhYW','🔄\x20Processing\x20Rapyd\x20webhook:','\x20not\x20enabled\x20for\x20shop\x20','WebhookService','Body\x20data:','now','__esModule','ampay','664308wGEkKX','🔄\x20Processing\x20KLYME\x20webhook:','paymentLink','🔄\x20Processing\x20VISA\x20webhook:','✅\x20Found\x20payment:\x20ID=','Payment\x20not\x20found:\x20','\x20→\x20','sendShopWebhook',',\x20Status=','convertToUSDT','📊\x20Amer\x20webhook\x20result:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','$transaction','📊\x20VISA\x20payment\x20found:\x20',':\x20type=','Error\x20processing\x20CoinToPay2\x20webhook:','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20'];a66_0x421e=function(){return _0x47d139;};return a66_0x421e();}Object[a66_0x382be0(0x1c3)](exports,'__esModule',{'value':!![]}),exports[a66_0x382be0(0x197)]=void 0x0;const database_1=__importDefault(require(a66_0x382be0(0x25a))),plisioService_1=require(a66_0x382be0(0x22d)),rapydService_1=require(a66_0x382be0(0x144)),nodaService_1=require(a66_0x382be0(0x172)),coinToPayService_1=require(a66_0x382be0(0x1f4)),coinToPay2Service_1=require(a66_0x382be0(0x24c)),klymeService_1=require(a66_0x382be0(0x18c)),mastercardService_1=require(a66_0x382be0(0x151)),amerService_1=require(a66_0x382be0(0x1b3)),ampayService_1=require('./gateways/ampayService'),ampayTRYService_1=require('./gateways/ampayTRYService'),telegramBotService_1=require(a66_0x382be0(0x124)),currencyService_1=require(a66_0x382be0(0x1bd)),loggerService_1=require(a66_0x382be0(0x1cb));class WebhookService{constructor(){const _0x332904=a66_0x382be0;this[_0x332904(0x1b9)]=new plisioService_1['PlisioService'](),this['rapydService']=new rapydService_1[(_0x332904(0x224))](),this[_0x332904(0x253)]=new nodaService_1[(_0x332904(0x222))](),this['coinToPayService']=new coinToPayService_1[(_0x332904(0x242))](),this[_0x332904(0x219)]=new coinToPay2Service_1[(_0x332904(0x21f))](),this[_0x332904(0x26c)]=new klymeService_1[(_0x332904(0x203))](),this['visaMasterCardService']=new mastercardService_1[(_0x332904(0x1d9))](),this[_0x332904(0x233)]=new amerService_1[(_0x332904(0x17c))](),this[_0x332904(0x135)]=new ampayService_1[(_0x332904(0x180))](),this[_0x332904(0x13b)]=new ampayTRYService_1[(_0x332904(0x208))]();}async[a66_0x382be0(0x213)](_0x26d059,_0xa7fa4,_0x2b0783){const _0x158267=a66_0x382be0;console[_0x158267(0x1eb)]('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x26d059+_0x158267(0x143)+_0xa7fa4),console[_0x158267(0x1eb)]('🔄\x20Additional\x20data:',_0x2b0783),await database_1[_0x158267(0x1f9)][_0x158267(0x1a8)](async _0x4fe13a=>{const _0x1fee70=_0x158267,_0x5854d2=await _0x4fe13a[_0x1fee70(0x1b4)][_0x1fee70(0x1e2)]({'where':{'id':_0x26d059},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5854d2)throw new Error(_0x1fee70(0x159)+_0x26d059+_0x1fee70(0x1ba));const _0x140291=_0x5854d2[_0x1fee70(0x221)],_0x50a9f0=_0x5854d2[_0x1fee70(0x22b)];console[_0x1fee70(0x1eb)](_0x1fee70(0x200)+_0x26d059+':\x20'+_0x140291+_0x1fee70(0x256)+_0xa7fa4),console['log'](_0x1fee70(0x20b)+_0x50a9f0[_0x1fee70(0x169)]+'\x20current\x20balance:\x20'+_0x50a9f0[_0x1fee70(0x1df)]+_0x1fee70(0x217));const _0x1572ce={'status':_0xa7fa4[_0x1fee70(0x139)](),'updatedAt':new Date(),'statusChangedBy':_0x1fee70(0x220),'statusChangedAt':new Date()};_0x2b0783?.[_0x1fee70(0x263)]&&(_0x1572ce[_0x1fee70(0x263)]=_0x2b0783[_0x1fee70(0x263)]);_0x2b0783?.['txUrls']&&(_0x1572ce[_0x1fee70(0x1db)]=JSON[_0x1fee70(0x12d)](_0x2b0783[_0x1fee70(0x1db)]));_0x2b0783?.['cardLast4']&&(_0x1572ce['cardLast4']=_0x2b0783[_0x1fee70(0x178)]);_0x2b0783?.['paymentMethod']&&(_0x1572ce[_0x1fee70(0x125)]=_0x2b0783[_0x1fee70(0x125)]);_0x2b0783?.[_0x1fee70(0x13f)]&&(_0x1572ce[_0x1fee70(0x13f)]=_0x2b0783[_0x1fee70(0x13f)]);_0x2b0783?.[_0x1fee70(0x18a)]&&(_0x1572ce[_0x1fee70(0x18a)]=_0x2b0783[_0x1fee70(0x18a)]);_0x2b0783?.[_0x1fee70(0x22c)]&&(_0x1572ce[_0x1fee70(0x22c)]=_0x2b0783[_0x1fee70(0x22c)]);let _0x39add3=_0x50a9f0[_0x1fee70(0x1df)],_0xb54a97='';if(_0xa7fa4[_0x1fee70(0x139)]()==='PAID'&&_0x140291!==_0x1fee70(0x223)){const _0x13b514=await currencyService_1[_0x1fee70(0x1dc)][_0x1fee70(0x1a5)](_0x5854d2[_0x1fee70(0x17a)],_0x5854d2[_0x1fee70(0x207)]),_0x3f2ebf=await this[_0x1fee70(0x141)](_0x50a9f0['id'],_0x5854d2[_0x1fee70(0x1fa)]),_0x5176fe=_0x13b514*(0x1-_0x3f2ebf/0x64);_0x39add3+=_0x5176fe,_0xb54a97='+'+_0x5176fe[_0x1fee70(0x246)](0x6)+_0x1fee70(0x1f8)+_0x3f2ebf+_0x1fee70(0x231),_0x1572ce[_0x1fee70(0x18d)]=_0x13b514,_0x1572ce['amountAfterGatewayCommissionUSDT']=_0x5176fe,_0x1572ce['gatewayCommissionRate']=_0x3f2ebf,_0x1572ce['paidAt']=new Date(),console['log'](_0x1fee70(0x24e)+_0x5854d2['amount']+'\x20'+_0x5854d2['currency']+_0x1fee70(0x256)+_0x13b514['toFixed'](0x6)+_0x1fee70(0x217)),console[_0x1fee70(0x1eb)](_0x1fee70(0x13c)+_0x5854d2[_0x1fee70(0x1fa)]+_0x1fee70(0x1be)+_0x3f2ebf+'%'),console['log'](_0x1fee70(0x18e)+_0x5176fe[_0x1fee70(0x246)](0x6)+_0x1fee70(0x217)),console[_0x1fee70(0x1eb)]('💰\x20Adding\x20to\x20balance:\x20'+_0x50a9f0[_0x1fee70(0x1df)]+'\x20+\x20'+_0x5176fe[_0x1fee70(0x246)](0x6)+_0x1fee70(0x20a)+_0x39add3['toFixed'](0x6)+_0x1fee70(0x217));}else{if(_0x140291==='PAID'&&_0xa7fa4[_0x1fee70(0x139)]()!==_0x1fee70(0x223)&&_0xa7fa4['toUpperCase']()!==_0x1fee70(0x15e)){let _0x49b3ed;if(_0x5854d2['amountAfterGatewayCommissionUSDT'])_0x49b3ed=_0x5854d2[_0x1fee70(0x20d)];else{if(_0x5854d2[_0x1fee70(0x18d)]){const _0x39104c=await this[_0x1fee70(0x141)](_0x50a9f0['id'],_0x5854d2['gateway']);_0x49b3ed=_0x5854d2[_0x1fee70(0x18d)]*(0x1-_0x39104c/0x64);}else console[_0x1fee70(0x1eb)]('No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance'),_0x49b3ed=0x0;}_0x49b3ed>0x0&&(_0x39add3-=_0x49b3ed,_0xb54a97='-'+_0x49b3ed['toFixed'](0x6)+_0x1fee70(0x18f),_0x1572ce[_0x1fee70(0x22a)]=null,console[_0x1fee70(0x1eb)]('💰\x20Removing\x20from\x20balance:\x20'+_0x50a9f0[_0x1fee70(0x1df)]+_0x1fee70(0x14d)+_0x49b3ed['toFixed'](0x6)+_0x1fee70(0x20a)+_0x39add3[_0x1fee70(0x246)](0x6)+'\x20USDT'));}}if(_0xa7fa4[_0x1fee70(0x139)]()==='CHARGEBACK'){const _0x29fe49=_0x2b0783?.['chargebackAmount']||0x0;console[_0x1fee70(0x1eb)]('💸\x20CHARGEBACK:\x20Processing\x20penalty-only\x20deduction'),_0x29fe49>0x0?(_0x39add3-=_0x29fe49,_0xb54a97='-'+_0x29fe49[_0x1fee70(0x246)](0x6)+_0x1fee70(0x13a),_0x1572ce[_0x1fee70(0x128)]=_0x29fe49,console[_0x1fee70(0x1eb)](_0x1fee70(0x1ed)+_0x29fe49[_0x1fee70(0x246)](0x6)+_0x1fee70(0x217)),console[_0x1fee70(0x1eb)](_0x1fee70(0x212)),console['log'](_0x1fee70(0x182)+_0x39add3[_0x1fee70(0x246)](0x6)+'\x20USDT')):(console[_0x1fee70(0x1eb)](_0x1fee70(0x209)),_0xb54a97=_0x1fee70(0x1d6));}const _0x5698ac=await _0x4fe13a['payment'][_0x1fee70(0x174)]({'where':{'id':_0x26d059},'data':_0x1572ce});_0x39add3!==_0x50a9f0['balance']&&(await _0x4fe13a[_0x1fee70(0x22b)][_0x1fee70(0x174)]({'where':{'id':_0x50a9f0['id']},'data':{'balance':_0x39add3}}),console[_0x1fee70(0x1eb)](_0x1fee70(0x269)+_0x50a9f0[_0x1fee70(0x169)]+_0x1fee70(0x1d5)+_0x50a9f0['balance'][_0x1fee70(0x246)](0x6)+_0x1fee70(0x256)+_0x39add3[_0x1fee70(0x246)](0x6)+_0x1fee70(0x217)),console[_0x1fee70(0x1eb)]('📝\x20Reason:\x20'+_0xb54a97));await _0x4fe13a[_0x1fee70(0x1d4)][_0x1fee70(0x1e5)]({'data':{'paymentId':_0x26d059,'shopId':_0x50a9f0['id'],'event':_0x1fee70(0x241)+_0xa7fa4[_0x1fee70(0x142)](),'statusCode':0xc8,'responseBody':JSON[_0x1fee70(0x12d)]({'oldStatus':_0x140291,'newStatus':_0xa7fa4[_0x1fee70(0x139)](),'balanceChange':_0xb54a97||_0x1fee70(0x22e),'oldBalance':_0x50a9f0[_0x1fee70(0x1df)],'newBalance':_0x39add3,'amountUSDT':_0x1572ce[_0x1fee70(0x18d)],'additionalData':_0x2b0783,'timestamp':new Date()[_0x1fee70(0x1d3)]()})}}),await this[_0x1fee70(0x1a3)]({..._0x5854d2,..._0x5698ac,'shop':_0x50a9f0},_0xa7fa4[_0x1fee70(0x139)]()),await this[_0x1fee70(0x1d2)]({..._0x5854d2,..._0x5698ac},_0xa7fa4[_0x1fee70(0x139)]());if(_0x140291!==_0x1fee70(0x223)&&_0xa7fa4[_0x1fee70(0x139)]()===_0x1fee70(0x223)){console[_0x1fee70(0x1eb)]('📈\x20Payment\x20'+_0x26d059+_0x1fee70(0x17d)),console['log'](_0x1fee70(0x1b0)+_0x140291+'\x22,\x20newStatus=\x22'+_0xa7fa4['toUpperCase']()+_0x1fee70(0x166)+_0x5854d2[_0x1fee70(0x156)]+'\x22');if(_0x5854d2[_0x1fee70(0x156)])try{const _0x32f8f3=await _0x4fe13a[_0x1fee70(0x19e)][_0x1fee70(0x1e2)]({'where':{'id':_0x5854d2[_0x1fee70(0x156)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x32f8f3){console[_0x1fee70(0x1eb)]('📈\x20Found\x20payment\x20link\x20'+_0x32f8f3['id']+_0x1fee70(0x1aa)+_0x32f8f3['type']+',\x20currentPayments='+_0x32f8f3[_0x1fee70(0x1e6)]+_0x1fee70(0x211)+_0x32f8f3['status']);const _0x42920c=_0x32f8f3[_0x1fee70(0x1e6)]+0x1,_0x2f92fa=_0x32f8f3[_0x1fee70(0x162)]===_0x1fee70(0x16a)?_0x1fee70(0x15c):_0x32f8f3[_0x1fee70(0x221)];await _0x4fe13a[_0x1fee70(0x19e)][_0x1fee70(0x174)]({'where':{'id':_0x5854d2['paymentLinkId']},'data':{'currentPayments':_0x42920c,'status':_0x2f92fa,'updatedAt':new Date()}}),console['log'](_0x1fee70(0x176)+_0x32f8f3['id']+_0x1fee70(0x23d)+_0x32f8f3[_0x1fee70(0x1e6)]+'\x20->\x20'+_0x42920c+_0x1fee70(0x211)+_0x32f8f3[_0x1fee70(0x221)]+_0x1fee70(0x256)+_0x2f92fa);}else console[_0x1fee70(0x1eb)](_0x1fee70(0x167)+_0x5854d2['paymentLinkId']+'\x20not\x20found');}catch(_0x550af1){console[_0x1fee70(0x1e9)](_0x1fee70(0x1b6),_0x550af1);}else console[_0x1fee70(0x1eb)](_0x1fee70(0x25d)+_0x26d059+_0x1fee70(0x1ea));}else console[_0x1fee70(0x1eb)]('📈\x20Payment\x20'+_0x26d059+'\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20'+_0x140291+_0x1fee70(0x256)+_0xa7fa4['toUpperCase']());});}async[a66_0x382be0(0x17f)](_0x39dca9){const _0x5f2d58=a66_0x382be0;console[_0x5f2d58(0x1eb)](_0x5f2d58(0x23a),_0x39dca9);try{const _0x39b617=await this['plisioService']['processWebhook'](_0x39dca9);if(!_0x39b617[_0x5f2d58(0x261)])throw new Error(_0x5f2d58(0x245));const _0x489585=await database_1[_0x5f2d58(0x1f9)][_0x5f2d58(0x1b4)][_0x5f2d58(0x21c)]({'where':{'gatewayOrderId':_0x39b617[_0x5f2d58(0x261)]}});if(!_0x489585){console[_0x5f2d58(0x1e9)](_0x5f2d58(0x1f3)+_0x39b617[_0x5f2d58(0x261)]);return;}console['log'](_0x5f2d58(0x1ad)+_0x489585['id']+_0x5f2d58(0x165)+_0x39b617['status']),await this[_0x5f2d58(0x213)](_0x489585['id'],_0x39b617['status'],{'txUrls':_0x39b617[_0x5f2d58(0x1db)]}),loggerService_1[_0x5f2d58(0x1c0)][_0x5f2d58(0x260)](_0x5f2d58(0x14f),_0x489585['id'],_0x489585[_0x5f2d58(0x221)],_0x39b617[_0x5f2d58(0x221)],_0x39dca9);}catch(_0x494275){console[_0x5f2d58(0x1e9)](_0x5f2d58(0x193),_0x494275),loggerService_1[_0x5f2d58(0x1c0)][_0x5f2d58(0x26a)](_0x5f2d58(0x14f),_0x494275,_0x39dca9);throw _0x494275;}}async['processPlisioGatewayWebhook'](_0x4668e5){const _0x5eeb3c=a66_0x382be0;console[_0x5eeb3c(0x1eb)](_0x5eeb3c(0x1b8),_0x4668e5);try{const _0x513109=await this['plisioService'][_0x5eeb3c(0x130)](_0x4668e5);if(!_0x513109[_0x5eeb3c(0x261)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x47c266=await database_1['default'][_0x5eeb3c(0x1b4)][_0x5eeb3c(0x21c)]({'where':{'gatewayOrderId':_0x513109[_0x5eeb3c(0x261)]}});if(!_0x47c266){console['error']('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x513109[_0x5eeb3c(0x261)]);return;}console[_0x5eeb3c(0x1eb)](_0x5eeb3c(0x1ac)+_0x47c266['id']+_0x5eeb3c(0x165)+_0x513109[_0x5eeb3c(0x221)]),await this[_0x5eeb3c(0x213)](_0x47c266['id'],_0x513109[_0x5eeb3c(0x221)],{'txUrls':_0x513109[_0x5eeb3c(0x1db)]}),loggerService_1['loggerService']['logWebhookProcessed'](_0x5eeb3c(0x22f),_0x47c266['id'],_0x47c266[_0x5eeb3c(0x221)],_0x513109[_0x5eeb3c(0x221)],_0x4668e5);}catch(_0x509060){console['error']('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x509060),loggerService_1[_0x5eeb3c(0x1c0)][_0x5eeb3c(0x26a)]('plisio_gateway',_0x509060,_0x4668e5);throw _0x509060;}}async[a66_0x382be0(0x1d0)](_0x568d64){const _0x4031b5=a66_0x382be0;console['log'](_0x4031b5(0x195),_0x568d64);try{const _0x45ad12=await this[_0x4031b5(0x173)][_0x4031b5(0x130)](_0x568d64);if(!_0x45ad12[_0x4031b5(0x261)])throw new Error(_0x4031b5(0x1b7));const _0x1acc05=await database_1[_0x4031b5(0x1f9)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x45ad12[_0x4031b5(0x261)]}});if(!_0x1acc05){console[_0x4031b5(0x1e9)](_0x4031b5(0x1cf)+_0x45ad12[_0x4031b5(0x261)]);return;}console[_0x4031b5(0x1eb)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x1acc05['id']+_0x4031b5(0x165)+_0x45ad12['status']),await this['updatePaymentStatus'](_0x1acc05['id'],_0x45ad12[_0x4031b5(0x221)],{'failureMessage':_0x45ad12[_0x4031b5(0x263)],'cardLast4':_0x45ad12[_0x4031b5(0x138)]?.[_0x4031b5(0x178)],'paymentMethod':_0x45ad12['additionalInfo']?.[_0x4031b5(0x125)]}),loggerService_1['loggerService']['logWebhookProcessed'](_0x4031b5(0x154),_0x1acc05['id'],_0x1acc05['status'],_0x45ad12['status'],_0x568d64);}catch(_0x36c3be){console[_0x4031b5(0x1e9)]('Error\x20processing\x20Rapyd\x20webhook:',_0x36c3be),loggerService_1['loggerService']['logWebhookError'](_0x4031b5(0x154),_0x36c3be,_0x568d64);throw _0x36c3be;}}async['processNodaWebhook'](_0x182c60){const _0x354506=a66_0x382be0;console[_0x354506(0x1eb)]('🔄\x20Processing\x20Noda\x20webhook:',_0x182c60);try{const _0x4815ec=await this[_0x354506(0x253)][_0x354506(0x130)](_0x182c60);if(!_0x4815ec['paymentId'])throw new Error(_0x354506(0x1f5));const _0x5cc12b=await database_1[_0x354506(0x1f9)][_0x354506(0x1b4)][_0x354506(0x21c)]({'where':{'gatewayOrderId':_0x4815ec[_0x354506(0x261)]}});if(!_0x5cc12b){console[_0x354506(0x1e9)](_0x354506(0x215)+_0x4815ec[_0x354506(0x261)]);return;}console[_0x354506(0x1eb)](_0x354506(0x186)+_0x5cc12b['id']+_0x354506(0x165)+_0x4815ec[_0x354506(0x221)]),await this[_0x354506(0x213)](_0x5cc12b['id'],_0x4815ec[_0x354506(0x221)],{'bankId':_0x4815ec['additionalInfo']?.['bankId'],'remitterIban':_0x4815ec[_0x354506(0x138)]?.[_0x354506(0x18a)],'remitterName':_0x4815ec[_0x354506(0x138)]?.['remitterName']}),loggerService_1[_0x354506(0x1c0)]['logWebhookProcessed'](_0x354506(0x133),_0x5cc12b['id'],_0x5cc12b[_0x354506(0x221)],_0x4815ec['status'],_0x182c60);}catch(_0xa77b43){console[_0x354506(0x1e9)](_0x354506(0x161),_0xa77b43),loggerService_1[_0x354506(0x1c0)][_0x354506(0x26a)](_0x354506(0x133),_0xa77b43,_0x182c60);throw _0xa77b43;}}async['processCoinToPayWebhook'](_0x4c98ef){const _0x4530f0=a66_0x382be0;console['log'](_0x4530f0(0x23e),_0x4c98ef);try{const _0x5c8029=await this[_0x4530f0(0x1d1)][_0x4530f0(0x130)](_0x4c98ef);if(!_0x5c8029['paymentId'])throw new Error(_0x4530f0(0x1e7));const _0x2515f9=await database_1[_0x4530f0(0x1f9)][_0x4530f0(0x1b4)][_0x4530f0(0x21c)]({'where':{'gatewayOrderId':_0x5c8029['paymentId']}});if(!_0x2515f9){console['error'](_0x4530f0(0x12c)+_0x5c8029['paymentId']);return;}console[_0x4530f0(0x1eb)](_0x4530f0(0x1ce)+_0x2515f9['id']+'\x20status\x20'+_0x5c8029[_0x4530f0(0x221)]),await this[_0x4530f0(0x213)](_0x2515f9['id'],_0x5c8029[_0x4530f0(0x221)]),loggerService_1['loggerService'][_0x4530f0(0x260)](_0x4530f0(0x14c),_0x2515f9['id'],_0x2515f9[_0x4530f0(0x221)],_0x5c8029[_0x4530f0(0x221)],_0x4c98ef);}catch(_0x5861cf){console['error'](_0x4530f0(0x137),_0x5861cf),loggerService_1['loggerService'][_0x4530f0(0x26a)](_0x4530f0(0x14c),_0x5861cf,_0x4c98ef);throw _0x5861cf;}}async['processCoinToPay2Webhook'](_0x4b9b93){const _0x54d5d6=a66_0x382be0;console[_0x54d5d6(0x1eb)](_0x54d5d6(0x20e),_0x4b9b93);try{const _0x36c662=await this[_0x54d5d6(0x219)][_0x54d5d6(0x130)](_0x4b9b93);if(!_0x36c662['paymentId'])throw new Error(_0x54d5d6(0x251));const _0x2b18ce=await database_1['default'][_0x54d5d6(0x1b4)]['findFirst']({'where':{'gatewayOrderId':_0x36c662['paymentId']}});if(!_0x2b18ce){console[_0x54d5d6(0x1e9)]('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x36c662[_0x54d5d6(0x261)]);return;}console[_0x54d5d6(0x1eb)](_0x54d5d6(0x21d)+_0x2b18ce['id']+_0x54d5d6(0x165)+_0x36c662[_0x54d5d6(0x221)]),await this['updatePaymentStatus'](_0x2b18ce['id'],_0x36c662[_0x54d5d6(0x221)]),loggerService_1[_0x54d5d6(0x1c0)]['logWebhookProcessed'](_0x54d5d6(0x12a),_0x2b18ce['id'],_0x2b18ce[_0x54d5d6(0x221)],_0x36c662[_0x54d5d6(0x221)],_0x4b9b93);}catch(_0x10347d){console[_0x54d5d6(0x1e9)](_0x54d5d6(0x1ab),_0x10347d),loggerService_1[_0x54d5d6(0x1c0)][_0x54d5d6(0x26a)](_0x54d5d6(0x12a),_0x10347d,_0x4b9b93);throw _0x10347d;}}async[a66_0x382be0(0x179)](_0x1b1b51){const _0x226e8b=a66_0x382be0;console[_0x226e8b(0x1eb)](_0x226e8b(0x19d),_0x1b1b51);try{const _0xb78b7f=await this[_0x226e8b(0x26c)][_0x226e8b(0x130)](_0x1b1b51);if(!_0xb78b7f[_0x226e8b(0x261)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x10f9df=await database_1['default'][_0x226e8b(0x1b4)][_0x226e8b(0x21c)]({'where':{'gatewayOrderId':_0xb78b7f[_0x226e8b(0x261)]}});if(!_0x10f9df){console[_0x226e8b(0x1e9)](_0x226e8b(0x1c5)+_0xb78b7f[_0x226e8b(0x261)]);return;}console[_0x226e8b(0x1eb)](_0x226e8b(0x23c)+_0x10f9df['id']+_0x226e8b(0x165)+_0xb78b7f[_0x226e8b(0x221)]),await this[_0x226e8b(0x213)](_0x10f9df['id'],_0xb78b7f[_0x226e8b(0x221)],{'paymentMethod':_0xb78b7f[_0x226e8b(0x138)]?.['payment_method']}),loggerService_1['loggerService'][_0x226e8b(0x260)](_0x226e8b(0x252),_0x10f9df['id'],_0x10f9df[_0x226e8b(0x221)],_0xb78b7f[_0x226e8b(0x221)],_0x1b1b51);}catch(_0x255e43){console['error']('Error\x20processing\x20KLYME\x20webhook:',_0x255e43),loggerService_1[_0x226e8b(0x1c0)][_0x226e8b(0x26a)](_0x226e8b(0x252),_0x255e43,_0x1b1b51);throw _0x255e43;}}async[a66_0x382be0(0x265)](_0x2d2df0){const _0x3946c5=a66_0x382be0;console[_0x3946c5(0x1eb)](_0x3946c5(0x19f),JSON['stringify'](_0x2d2df0,null,0x2));try{const _0x5a8590=await this[_0x3946c5(0x1ca)][_0x3946c5(0x130)](_0x2d2df0,_0x3946c5(0x12f));console[_0x3946c5(0x1eb)](_0x3946c5(0x218),_0x5a8590);if(!_0x5a8590[_0x3946c5(0x261)]){console[_0x3946c5(0x1e9)](_0x3946c5(0x1fc)),console[_0x3946c5(0x1e9)]('❌\x20Available\x20webhook\x20fields:',Object['keys'](_0x2d2df0));throw new Error(_0x3946c5(0x13e));}let _0x49c7d7=null;console['log'](_0x3946c5(0x1b5)+_0x5a8590[_0x3946c5(0x261)]);if(_0x5a8590[_0x3946c5(0x261)]){console[_0x3946c5(0x1eb)](_0x3946c5(0x1d7)),console['log'](_0x3946c5(0x1c4)),console[_0x3946c5(0x1eb)](_0x3946c5(0x201)),console[_0x3946c5(0x1eb)](_0x3946c5(0x1b2)+_0x5a8590[_0x3946c5(0x261)]),console[_0x3946c5(0x1eb)](_0x3946c5(0x1e3)),_0x49c7d7=await database_1[_0x3946c5(0x1f9)]['payment'][_0x3946c5(0x21c)]({'where':{'AND':[{'OR':[{'gateway':_0x3946c5(0x181)},{'gateway':_0x3946c5(0x1af)}]},{'OR':[{'gatewayPaymentId':_0x5a8590[_0x3946c5(0x261)]},{'gatewayOrderId':_0x5a8590['paymentId']},{'id':_0x5a8590[_0x3946c5(0x261)]},{'orderId':_0x5a8590[_0x3946c5(0x261)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x3946c5(0x1eb)](_0x3946c5(0x187));if(_0x49c7d7)console['log'](_0x3946c5(0x1a0)+_0x49c7d7['id']+_0x3946c5(0x25f)+_0x49c7d7[_0x3946c5(0x25b)]+',\x20GatewayPaymentId='+_0x49c7d7[_0x3946c5(0x164)]);else{console['log'](_0x3946c5(0x1f2));const _0x3dd11d=await database_1[_0x3946c5(0x1f9)][_0x3946c5(0x1b4)]['findMany']({'where':{'gateway':'visa/mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x3946c5(0x24a)}});console['log']('🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:',_0x3dd11d[_0x3946c5(0x206)](_0xb33915=>_0xb33915['id']+_0x3946c5(0x26f)+_0xb33915[_0x3946c5(0x12e)]+_0x3946c5(0x244)+_0xb33915[_0x3946c5(0x25b)]+_0x3946c5(0x25e)+_0xb33915[_0x3946c5(0x164)]+_0x3946c5(0x214)+_0xb33915[_0x3946c5(0x178)]+')'));}console[_0x3946c5(0x1eb)]('🔍\x20VISA\x20payment\x20search\x20result:\x20'+(_0x49c7d7?'Found':_0x3946c5(0x18b))),_0x49c7d7&&console['log'](_0x3946c5(0x259)+_0x49c7d7['id']+_0x3946c5(0x136)+_0x49c7d7[_0x3946c5(0x1fa)]+_0x3946c5(0x1a4)+_0x49c7d7[_0x3946c5(0x221)]+_0x3946c5(0x1c1)+_0x49c7d7['cardLast4']);}if(!_0x49c7d7){console[_0x3946c5(0x1e9)](_0x3946c5(0x152)+_0x5a8590[_0x3946c5(0x261)]),loggerService_1[_0x3946c5(0x1c0)][_0x3946c5(0x26a)](_0x3946c5(0x1de),new Error(_0x3946c5(0x1a1)+_0x5a8590[_0x3946c5(0x261)]),_0x2d2df0);throw new Error(_0x3946c5(0x247)+_0x5a8590[_0x3946c5(0x261)]);}console[_0x3946c5(0x1eb)](_0x3946c5(0x1a9)+_0x49c7d7['id']+_0x3946c5(0x226)+_0x49c7d7[_0x3946c5(0x221)]+_0x3946c5(0x1a2)+_0x5a8590[_0x3946c5(0x221)]+')');const _0x3e20e1={};_0x5a8590[_0x3946c5(0x17a)]&&await database_1[_0x3946c5(0x1f9)]['payment'][_0x3946c5(0x174)]({'where':{'id':_0x49c7d7['id']},'data':{'amount':_0x5a8590[_0x3946c5(0x17a)],'updatedAt':new Date()}}),_0x5a8590[_0x3946c5(0x207)]&&await database_1[_0x3946c5(0x1f9)]['payment'][_0x3946c5(0x174)]({'where':{'id':_0x49c7d7['id']},'data':{'currency':_0x5a8590['currency'],'updatedAt':new Date()}}),_0x5a8590[_0x3946c5(0x221)]===_0x3946c5(0x163)&&_0x5a8590[_0x3946c5(0x1da)]&&(_0x3e20e1[_0x3946c5(0x263)]=_0x5a8590[_0x3946c5(0x1da)],console[_0x3946c5(0x1eb)](_0x3946c5(0x1e1)+_0x5a8590[_0x3946c5(0x1da)])),_0x3e20e1[_0x3946c5(0x125)]=_0x3946c5(0x1de),await this[_0x3946c5(0x213)](_0x49c7d7['id'],_0x5a8590[_0x3946c5(0x221)],_0x3e20e1),await database_1[_0x3946c5(0x1f9)][_0x3946c5(0x1d4)]['create']({'data':{'paymentId':_0x49c7d7['id'],'shopId':_0x49c7d7[_0x3946c5(0x1e8)],'event':_0x3946c5(0x183)+_0x5a8590[_0x3946c5(0x221)][_0x3946c5(0x142)](),'statusCode':0xc8,'responseBody':JSON[_0x3946c5(0x12d)](_0x5a8590)}}),await this['sendPaymentStatusNotification'](_0x49c7d7,_0x5a8590['status'][_0x3946c5(0x139)]()),console[_0x3946c5(0x1eb)](_0x3946c5(0x268)+_0x49c7d7['id']);}catch(_0x3ac39){console['error'](_0x3946c5(0x126),_0x3ac39),loggerService_1['loggerService'][_0x3946c5(0x26a)](_0x3946c5(0x1de),_0x3ac39,_0x2d2df0);throw _0x3ac39;}}async[a66_0x382be0(0x1bb)](_0x1a42ec){const _0x2b1c10=a66_0x382be0;console[_0x2b1c10(0x1eb)](_0x2b1c10(0x257),JSON[_0x2b1c10(0x12d)](_0x1a42ec,null,0x2));try{const _0x34ad07=await this['visaMasterCardService']['processWebhook'](_0x1a42ec,_0x2b1c10(0x157));console[_0x2b1c10(0x1eb)]('📊\x20MasterCard\x20webhook\x20result:',_0x34ad07);if(!_0x34ad07[_0x2b1c10(0x261)]){console[_0x2b1c10(0x1e9)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data'),console[_0x2b1c10(0x1e9)]('❌\x20Available\x20webhook\x20fields:',Object[_0x2b1c10(0x25c)](_0x1a42ec));throw new Error(_0x2b1c10(0x145));}let _0x30d790=null;console['log'](_0x2b1c10(0x132)+_0x34ad07['paymentId']);_0x34ad07[_0x2b1c10(0x261)]&&(console[_0x2b1c10(0x1eb)]('🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x30d790=await database_1[_0x2b1c10(0x1f9)][_0x2b1c10(0x1b4)][_0x2b1c10(0x21c)]({'where':{'AND':[{'OR':[{'gateway':'visa_mastercard'},{'gateway':_0x2b1c10(0x1af)},{'gateway':_0x2b1c10(0x181)}]},{'OR':[{'gatewayPaymentId':_0x34ad07[_0x2b1c10(0x261)]},{'gatewayOrderId':_0x34ad07[_0x2b1c10(0x261)]},{'id':_0x34ad07[_0x2b1c10(0x261)]},{'orderId':_0x34ad07['paymentId']}]}]}}),console[_0x2b1c10(0x1eb)](_0x2b1c10(0x1ff)+(_0x30d790?_0x2b1c10(0x1c9)+_0x30d790['id']:_0x2b1c10(0x239))));if(!_0x30d790){console[_0x2b1c10(0x1e9)](_0x2b1c10(0x240)+_0x34ad07['paymentId']),console[_0x2b1c10(0x1e9)]('🔍\x20Searched\x20by:\x20gatewayOrderId=\x22'+_0x34ad07[_0x2b1c10(0x261)]+_0x2b1c10(0x16d)+_0x34ad07[_0x2b1c10(0x261)]+_0x2b1c10(0x249)+_0x34ad07[_0x2b1c10(0x261)]+'\x22');const _0x202592=await database_1['default'][_0x2b1c10(0x1b4)][_0x2b1c10(0x192)]({'where':{'OR':[{'gateway':_0x2b1c10(0x1af)},{'gateway':'visa_mastercard'},{'gateway':_0x2b1c10(0x181)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':'desc'},'take':0xf});console['log']('🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:',_0x202592),loggerService_1['loggerService'][_0x2b1c10(0x26a)]('mastercard',new Error('Payment\x20not\x20found:\x20'+_0x34ad07[_0x2b1c10(0x261)]),_0x1a42ec);throw new Error('MasterCard\x20payment\x20not\x20found:\x20'+_0x34ad07[_0x2b1c10(0x261)]);}console[_0x2b1c10(0x1eb)](_0x2b1c10(0x150)+_0x30d790['id']+_0x2b1c10(0x26b)+_0x30d790[_0x2b1c10(0x221)]+'\x20to\x20'+_0x34ad07[_0x2b1c10(0x221)]);const _0x4a57d2={};_0x34ad07[_0x2b1c10(0x17a)]&&await database_1[_0x2b1c10(0x1f9)]['payment']['update']({'where':{'id':_0x30d790['id']},'data':{'amount':_0x34ad07[_0x2b1c10(0x17a)],'updatedAt':new Date()}}),_0x34ad07[_0x2b1c10(0x207)]&&await database_1[_0x2b1c10(0x1f9)][_0x2b1c10(0x1b4)][_0x2b1c10(0x174)]({'where':{'id':_0x30d790['id']},'data':{'currency':_0x34ad07[_0x2b1c10(0x207)],'updatedAt':new Date()}}),_0x34ad07[_0x2b1c10(0x221)]===_0x2b1c10(0x163)&&_0x34ad07[_0x2b1c10(0x1da)]&&(_0x4a57d2[_0x2b1c10(0x263)]=_0x34ad07[_0x2b1c10(0x1da)],console[_0x2b1c10(0x1eb)]('❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20'+_0x34ad07[_0x2b1c10(0x1da)])),_0x4a57d2['paymentMethod']=_0x2b1c10(0x1af),await this[_0x2b1c10(0x213)](_0x30d790['id'],_0x34ad07[_0x2b1c10(0x221)],_0x4a57d2),loggerService_1[_0x2b1c10(0x1c0)]['logWebhookProcessed'](_0x2b1c10(0x1af),_0x30d790['id'],_0x30d790[_0x2b1c10(0x221)],_0x34ad07[_0x2b1c10(0x221)],_0x1a42ec);}catch(_0x4dd31f){console[_0x2b1c10(0x1e9)](_0x2b1c10(0x264),_0x4dd31f),loggerService_1[_0x2b1c10(0x1c0)][_0x2b1c10(0x26a)](_0x2b1c10(0x1af),_0x4dd31f,_0x1a42ec);throw _0x4dd31f;}}async[a66_0x382be0(0x188)](_0xf3aade){const _0x2e1e61=a66_0x382be0;console[_0x2e1e61(0x1eb)](_0x2e1e61(0x1bf),JSON[_0x2e1e61(0x12d)](_0xf3aade,null,0x2));try{const _0x405948=await this[_0x2e1e61(0x233)][_0x2e1e61(0x130)](_0xf3aade);console[_0x2e1e61(0x1eb)](_0x2e1e61(0x1a6),_0x405948);if(!_0x405948[_0x2e1e61(0x261)]){console[_0x2e1e61(0x1e9)](_0x2e1e61(0x24b)),console[_0x2e1e61(0x1e9)](_0x2e1e61(0x134),Object[_0x2e1e61(0x25c)](_0xf3aade));throw new Error(_0x2e1e61(0x14e));}let _0x5ae71a=null;console[_0x2e1e61(0x1eb)](_0x2e1e61(0x12b)+_0x405948[_0x2e1e61(0x261)]),_0x5ae71a=await database_1[_0x2e1e61(0x1f9)][_0x2e1e61(0x1b4)]['findFirst']({'where':{'AND':[{'gateway':_0x2e1e61(0x190)},{'OR':[{'gatewayPaymentId':_0x405948['paymentId']},{'gatewayOrderId':_0x405948['paymentId']},{'id':_0x405948[_0x2e1e61(0x261)]},{'orderId':_0x405948['paymentId']}]}]}}),console[_0x2e1e61(0x1eb)]('🔍\x20Search\x20result:\x20'+(_0x5ae71a?_0x2e1e61(0x1c9)+_0x5ae71a['id']:_0x2e1e61(0x239)));if(!_0x5ae71a){console[_0x2e1e61(0x1e9)](_0x2e1e61(0x147)+_0x405948[_0x2e1e61(0x261)]);return;}console[_0x2e1e61(0x1eb)](_0x2e1e61(0x189)+_0x5ae71a['id']+_0x2e1e61(0x165)+_0x405948['status']),await this[_0x2e1e61(0x213)](_0x5ae71a['id'],_0x405948[_0x2e1e61(0x221)],{'cardLast4':_0x405948[_0x2e1e61(0x138)]?.['cardLast4'],'paymentMethod':_0x405948[_0x2e1e61(0x138)]?.[_0x2e1e61(0x125)]});}catch(_0x773c5e){console[_0x2e1e61(0x1e9)]('❌\x20Error\x20processing\x20Amer\x20webhook:',_0x773c5e),loggerService_1[_0x2e1e61(0x1c0)][_0x2e1e61(0x26a)](_0x2e1e61(0x190),_0x773c5e,_0xf3aade);throw _0x773c5e;}}async['processAmPayWebhook'](_0x13a585){const _0x314311=a66_0x382be0;console[_0x314311(0x1eb)](_0x314311(0x1dd),JSON['stringify'](_0x13a585,null,0x2));try{const _0x54c388=_0x13a585[_0x314311(0x221)],_0x4aa01d=_0x13a585[_0x314311(0x1d8)],_0x29974e=_0x13a585['system_id'],_0x44ea13=_0x13a585[_0x314311(0x1f0)],_0x30dc41=_0x13a585['amount'],_0x3ac72e=_0x13a585[_0x314311(0x207)],_0x3315c5=_0x13a585[_0x314311(0x26e)],_0x5bbf1e=_0x13a585['status_addition_info'];if(!_0x4aa01d){console[_0x314311(0x1e9)](_0x314311(0x26d));throw new Error(_0x314311(0x1e0));}console[_0x314311(0x1eb)](_0x314311(0x229),{'status':_0x54c388,'clientTransactionId':_0x4aa01d,'systemId':_0x29974e,'paymentMethod':_0x44ea13,'amount':_0x30dc41,'currency':_0x3ac72e,'commission':_0x3315c5,'statusAdditionInfo':_0x5bbf1e});const _0x11e2f6=await database_1['default'][_0x314311(0x1b4)][_0x314311(0x21c)]({'where':{'OR':[{'gatewayOrderId':_0x4aa01d},{'orderId':_0x4aa01d},{'id':_0x4aa01d},{'gatewayPaymentId':_0x4aa01d}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x11e2f6){console['error'](_0x314311(0x185)+_0x4aa01d);throw new Error(_0x314311(0x1a1)+_0x4aa01d);}console[_0x314311(0x1eb)]('✅\x20Found\x20payment\x20'+_0x11e2f6['id']+_0x314311(0x160)),console['log'](_0x314311(0x228)+_0x11e2f6[_0x314311(0x221)]+_0x314311(0x1a2)+_0x54c388),_0x54c388==='DECLINED'?(console[_0x314311(0x1eb)](_0x314311(0x24f)),await this[_0x314311(0x213)](_0x11e2f6['id'],_0x314311(0x163)),console[_0x314311(0x1eb)]('✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20'+_0x11e2f6['id']+_0x314311(0x1ae)),console[_0x314311(0x1eb)](_0x314311(0x153)+(_0x5bbf1e||'No\x20additional\x20info'))):console[_0x314311(0x1eb)](_0x314311(0x1cc)+_0x54c388+_0x314311(0x131)),await database_1['default'][_0x314311(0x1d4)][_0x314311(0x1e5)]({'data':{'paymentId':_0x11e2f6['id'],'shopId':_0x11e2f6[_0x314311(0x1e8)],'event':_0x314311(0x234)+(_0x54c388?.['toLowerCase']()||_0x314311(0x13d)),'statusCode':0xc8,'responseBody':JSON[_0x314311(0x12d)](_0x13a585)}}),loggerService_1[_0x314311(0x1c0)][_0x314311(0x260)](_0x314311(0x19b),_0x11e2f6['id'],_0x11e2f6[_0x314311(0x221)],_0x54c388===_0x314311(0x23b)?_0x314311(0x163):_0x54c388,_0x13a585);}catch(_0x521a50){console[_0x314311(0x1e9)](_0x314311(0x168),_0x521a50),loggerService_1[_0x314311(0x1c0)][_0x314311(0x26a)]('ampay',_0x521a50,_0x13a585);throw _0x521a50;}}async[a66_0x382be0(0x14b)](_0x1635f2){const _0xeb1ff7=a66_0x382be0;console[_0xeb1ff7(0x1eb)](_0xeb1ff7(0x248),JSON[_0xeb1ff7(0x12d)](_0x1635f2,null,0x2));try{const _0x37ae71=_0x1635f2[_0xeb1ff7(0x221)],_0x449c20=_0x1635f2['client_transaction_id'],_0x52e555=_0x1635f2[_0xeb1ff7(0x1ef)],_0xabf68c=_0x1635f2[_0xeb1ff7(0x1f0)],_0x27db57=_0x1635f2[_0xeb1ff7(0x17a)],_0x13a245=_0x1635f2['currency'],_0x3af487=_0x1635f2[_0xeb1ff7(0x26e)],_0x56fe99=_0x1635f2['status_addition_info'];if(!_0x449c20){console[_0xeb1ff7(0x1e9)]('❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook');throw new Error(_0xeb1ff7(0x267));}console[_0xeb1ff7(0x1eb)]('📊\x20AmPay\x20TRY\x20webhook\x20data:',{'status':_0x37ae71,'clientTransactionId':_0x449c20,'systemId':_0x52e555,'paymentMethod':_0xabf68c,'amount':_0x27db57,'currency':_0x13a245,'commission':_0x3af487,'statusAdditionInfo':_0x56fe99});const _0x5e4720=await database_1[_0xeb1ff7(0x1f9)][_0xeb1ff7(0x1b4)][_0xeb1ff7(0x21c)]({'where':{'OR':[{'gatewayOrderId':_0x449c20},{'orderId':_0x449c20},{'id':_0x449c20},{'gatewayPaymentId':_0x449c20}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x5e4720){console[_0xeb1ff7(0x1e9)]('❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20'+_0x449c20);throw new Error(_0xeb1ff7(0x1a1)+_0x449c20);}console['log']('✅\x20Found\x20payment\x20'+_0x5e4720['id']+'\x20for\x20AmPay\x20TRY\x20webhook'),console[_0xeb1ff7(0x1eb)](_0xeb1ff7(0x228)+_0x5e4720[_0xeb1ff7(0x221)]+_0xeb1ff7(0x1a2)+_0x37ae71),_0x37ae71==='DECLINED'?(console['log'](_0xeb1ff7(0x170)),await this['updatePaymentStatus'](_0x5e4720['id'],'FAILED'),console['log']('✅\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20'+_0x5e4720['id']+_0xeb1ff7(0x1ae)),console['log']('ℹ️\x20Decline\x20reason:\x20'+(_0x56fe99||_0xeb1ff7(0x238)))):console['log'](_0xeb1ff7(0x171)+_0x37ae71+_0xeb1ff7(0x131)),await database_1[_0xeb1ff7(0x1f9)][_0xeb1ff7(0x1d4)][_0xeb1ff7(0x1e5)]({'data':{'paymentId':_0x5e4720['id'],'shopId':_0x5e4720[_0xeb1ff7(0x1e8)],'event':_0xeb1ff7(0x17b)+(_0x37ae71?.[_0xeb1ff7(0x142)]()||_0xeb1ff7(0x13d)),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x1635f2)}}),loggerService_1[_0xeb1ff7(0x1c0)]['logWebhookProcessed'](_0xeb1ff7(0x15f),_0x5e4720['id'],_0x5e4720[_0xeb1ff7(0x221)],_0x37ae71==='DECLINED'?_0xeb1ff7(0x163):_0x37ae71,_0x1635f2);}catch(_0x8687d4){console['error'](_0xeb1ff7(0x15d),_0x8687d4),loggerService_1['loggerService'][_0xeb1ff7(0x26a)]('ampay_try',_0x8687d4,_0x1635f2);throw _0x8687d4;}}async[a66_0x382be0(0x1a3)](_0x52db99,_0x37b3be){const _0x176723=a66_0x382be0,_0x46480b=Date[_0x176723(0x199)]();try{const _0x5bdd93=_0x52db99[_0x176723(0x22b)],_0x3bece5=_0x5bdd93['settings'];if(!_0x3bece5?.[_0x176723(0x16f)]){console[_0x176723(0x1eb)](_0x176723(0x175)+_0x5bdd93['id']);return;}const _0x302f93=_0x37b3be===_0x176723(0x223)?'payment.success':_0x37b3be===_0x176723(0x163)?'payment.failed':_0x37b3be===_0x176723(0x14a)?_0x176723(0x16c):_0x37b3be===_0x176723(0x15e)?_0x176723(0x16c):_0x37b3be==='REFUND'?_0x176723(0x16c):_0x176723(0x149);let _0x157b11=[];if(_0x3bece5[_0x176723(0x21b)])try{_0x157b11=Array[_0x176723(0x1e4)](_0x3bece5[_0x176723(0x21b)])?_0x3bece5[_0x176723(0x21b)]:JSON['parse'](_0x3bece5[_0x176723(0x21b)]);}catch(_0x312ae3){console[_0x176723(0x1e9)](_0x176723(0x210),_0x312ae3),_0x157b11=[];}if(!_0x157b11[_0x176723(0x1bc)](_0x302f93)){console['log'](_0x176723(0x191)+_0x302f93+_0x176723(0x196)+_0x5bdd93['id']);return;}const _0x289022={'event':_0x302f93,'payment':{'id':_0x52db99['id'],'order_id':_0x52db99[_0x176723(0x12e)],'gateway_order_id':_0x52db99[_0x176723(0x25b)],'gateway':_0x52db99['gateway'],'amount':_0x52db99[_0x176723(0x17a)],'currency':_0x52db99[_0x176723(0x207)],'status':_0x37b3be[_0x176723(0x142)](),'customer_email':_0x52db99[_0x176723(0x155)],'customer_name':_0x52db99[_0x176723(0x266)],'failure_message':_0x52db99[_0x176723(0x263)],'tx_urls':_0x52db99[_0x176723(0x1db)]?JSON[_0x176723(0x1f6)](_0x52db99[_0x176723(0x1db)]):null,'created_at':_0x52db99['createdAt'],'updated_at':_0x52db99['updatedAt']}},_0x595028=await fetch(_0x3bece5['webhookUrl'],{'method':_0x176723(0x1cd),'headers':{'Content-Type':_0x176723(0x127),'User-Agent':_0x176723(0x1fb)},'body':JSON[_0x176723(0x12d)](_0x289022)}),_0x2b8620=Date[_0x176723(0x199)]()-_0x46480b,_0x449efc=_0x595028['ok']?_0x176723(0x232):await _0x595028[_0x176723(0x204)]();loggerService_1['loggerService']['logShopWebhookSent'](_0x52db99[_0x176723(0x1e8)],_0x3bece5['webhookUrl'],_0x302f93,_0x595028[_0x176723(0x221)],_0x2b8620,_0x289022),console[_0x176723(0x1eb)](_0x176723(0x15a)+_0x3bece5[_0x176723(0x16f)]+_0x176723(0x23f)+_0x595028['status']+'\x20('+_0x2b8620+_0x176723(0x254));}catch(_0x3671ac){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x3671ac),loggerService_1['loggerService']['logShopWebhookError'](_0x52db99['shopId'],_0x52db99[_0x176723(0x22b)]?.[_0x176723(0x177)]?.[_0x176723(0x16f)]||_0x176723(0x13d),_0x176723(0x205),_0x3671ac,{});}}async[a66_0x382be0(0x1d2)](_0x1bb482,_0x411397){const _0x4fbdb4=a66_0x382be0;try{const _0x17602b={'PENDING':_0x4fbdb4(0x1fd),'PROCESSING':_0x4fbdb4(0x235),'PAID':'paid','FAILED':_0x4fbdb4(0x1ec),'EXPIRED':_0x4fbdb4(0x1c7),'REFUND':_0x4fbdb4(0x216),'CHARGEBACK':_0x4fbdb4(0x129)},_0x2034cf=_0x17602b[_0x411397];if(!_0x2034cf||_0x2034cf===_0x4fbdb4(0x1fd))return;await telegramBotService_1[_0x4fbdb4(0x21a)][_0x4fbdb4(0x140)](_0x1bb482['shopId'],_0x1bb482,_0x2034cf);}catch(_0x4b2103){console[_0x4fbdb4(0x1e9)](_0x4fbdb4(0x1a7),_0x4b2103);}}async[a66_0x382be0(0x141)](_0x57cd2b,_0x45b9e9){const _0x6cf111=a66_0x382be0;try{const _0x3dc396=await database_1[_0x6cf111(0x1f9)][_0x6cf111(0x22b)][_0x6cf111(0x1e2)]({'where':{'id':_0x57cd2b},'select':{'gatewaySettings':!![]}});if(!_0x3dc396?.[_0x6cf111(0x15b)])return console[_0x6cf111(0x1eb)](_0x6cf111(0x24d)+_0x57cd2b+',\x20using\x20default\x20commission\x2010%'),0xa;const _0xceaf74=JSON['parse'](_0x3dc396[_0x6cf111(0x15b)]);for(const [_0x8c3487,_0x2d3588]of Object['entries'](_0xceaf74)){if(_0x8c3487[_0x6cf111(0x142)]()===_0x45b9e9[_0x6cf111(0x142)]()){const _0x205eaa=_0x2d3588[_0x6cf111(0x26e)]||0xa;return console[_0x6cf111(0x1eb)]('Gateway\x20'+_0x45b9e9+'\x20commission\x20for\x20shop\x20'+_0x57cd2b+':\x20'+_0x205eaa+'%'),_0x205eaa;}}return console[_0x6cf111(0x1eb)](_0x6cf111(0x16b)+_0x45b9e9+_0x6cf111(0x255)+_0x57cd2b+_0x6cf111(0x20f)),0xa;}catch(_0x4e1b3e){return console[_0x6cf111(0x1e9)](_0x6cf111(0x236)+_0x57cd2b+_0x6cf111(0x1c8)+_0x45b9e9+':',_0x4e1b3e),0xa;}}async['processMyXSpendWebhook'](_0x29b2e7,_0x4ff452){const _0x55801f=a66_0x382be0;console[_0x55801f(0x1eb)](_0x55801f(0x21e)),console[_0x55801f(0x1eb)](_0x55801f(0x227),JSON[_0x55801f(0x12d)](_0x29b2e7,null,0x2)),console[_0x55801f(0x1eb)](_0x55801f(0x198),JSON[_0x55801f(0x12d)](_0x4ff452,null,0x2));try{const _0x55af78=_0x29b2e7[_0x55801f(0x1fe)]||_0x4ff452[_0x55801f(0x1fe)],_0x29c6f6=_0x29b2e7[_0x55801f(0x221)]||_0x4ff452[_0x55801f(0x221)],_0x333387=_0x29b2e7[_0x55801f(0x17a)]||_0x4ff452[_0x55801f(0x17a)],_0x483544=_0x29b2e7[_0x55801f(0x207)]||_0x4ff452[_0x55801f(0x207)],_0x24ad59=_0x29b2e7[_0x55801f(0x237)]||_0x4ff452[_0x55801f(0x237)];if(!_0x55af78){console['error']('❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook');throw new Error(_0x55801f(0x146));}console[_0x55801f(0x1eb)](_0x55801f(0x202),{'customerOrderId':_0x55af78,'status':_0x29c6f6,'amount':_0x333387,'currency':_0x483544,'dateTime':_0x24ad59});const _0x9071a0=await database_1[_0x55801f(0x1f9)]['payment'][_0x55801f(0x21c)]({'where':{'OR':[{'gatewayOrderId':_0x55af78},{'orderId':_0x55af78},{'id':_0x55af78},{'gatewayPaymentId':_0x55af78}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x9071a0){console[_0x55801f(0x1e9)]('❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20'+_0x55af78);throw new Error(_0x55801f(0x1a1)+_0x55af78);}console[_0x55801f(0x1eb)]('✅\x20Found\x20payment\x20'+_0x9071a0['id']+'\x20for\x20MyXSpend\x20webhook'),console[_0x55801f(0x1eb)](_0x55801f(0x228)+_0x9071a0[_0x55801f(0x221)]+_0x55801f(0x1a2)+_0x29c6f6);let _0x503905=_0x29c6f6?.[_0x55801f(0x139)]();_0x29c6f6===_0x55801f(0x163)||_0x29c6f6===_0x55801f(0x14a)?(_0x503905='FAILED',console[_0x55801f(0x1eb)](_0x55801f(0x184)+_0x29c6f6+_0x55801f(0x20c)),await this[_0x55801f(0x213)](_0x9071a0['id'],_0x503905),console['log'](_0x55801f(0x258)+_0x9071a0['id']+_0x55801f(0x1ae))):console['log'](_0x55801f(0x158)+_0x29c6f6+_0x55801f(0x230)),await database_1[_0x55801f(0x1f9)]['webhookLog'][_0x55801f(0x1e5)]({'data':{'paymentId':_0x9071a0['id'],'shopId':_0x9071a0['shopId'],'event':_0x55801f(0x148)+(_0x29c6f6?.['toLowerCase']()||_0x55801f(0x13d)),'statusCode':0xc8,'responseBody':JSON[_0x55801f(0x12d)]({'queryParams':_0x29b2e7,'bodyData':_0x4ff452})}}),loggerService_1[_0x55801f(0x1c0)]['logWebhookProcessed'](_0x55801f(0x16e),_0x9071a0['id'],_0x9071a0[_0x55801f(0x221)],_0x503905||_0x29c6f6,{'queryParams':_0x29b2e7,'bodyData':_0x4ff452});}catch(_0x2d9aba){console[_0x55801f(0x1e9)](_0x55801f(0x250),_0x2d9aba),loggerService_1[_0x55801f(0x1c0)][_0x55801f(0x26a)]('myxspend',_0x2d9aba,{'queryParams':_0x29b2e7,'bodyData':_0x4ff452});throw _0x2d9aba;}}}function a66_0x4a96(_0x69ea04,_0x23f87a){const _0x421e73=a66_0x421e();return a66_0x4a96=function(_0x4a9654,_0xa96a93){_0x4a9654=_0x4a9654-0x124;let _0x1a179f=_0x421e73[_0x4a9654];return _0x1a179f;},a66_0x4a96(_0x69ea04,_0x23f87a);}exports[a66_0x382be0(0x197)]=WebhookService;