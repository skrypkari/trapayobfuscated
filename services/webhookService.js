'use strict';const a69_0x581154=a69_0xc2f2;(function(_0x1c606a,_0x4b4dd1){const _0x24fdd1=a69_0xc2f2,_0xe66a37=_0x1c606a();while(!![]){try{const _0x2c90b4=parseInt(_0x24fdd1(0x2c1))/0x1+-parseInt(_0x24fdd1(0x1cd))/0x2+-parseInt(_0x24fdd1(0x1f6))/0x3+parseInt(_0x24fdd1(0x1c0))/0x4*(parseInt(_0x24fdd1(0x2db))/0x5)+parseInt(_0x24fdd1(0x1d4))/0x6*(-parseInt(_0x24fdd1(0x2d6))/0x7)+parseInt(_0x24fdd1(0x232))/0x8*(-parseInt(_0x24fdd1(0x1f2))/0x9)+parseInt(_0x24fdd1(0x23d))/0xa;if(_0x2c90b4===_0x4b4dd1)break;else _0xe66a37['push'](_0xe66a37['shift']());}catch(_0x137294){_0xe66a37['push'](_0xe66a37['shift']());}}}(a69_0x23bc,0x6e1ed));function a69_0xc2f2(_0x411610,_0x367be1){const _0x23bc2a=a69_0x23bc();return a69_0xc2f2=function(_0xc2f230,_0x22e1ff){_0xc2f230=_0xc2f230-0x1af;let _0xacdc0a=_0x23bc2a[_0xc2f230];return _0xacdc0a;},a69_0xc2f2(_0x411610,_0x367be1);}function a69_0x23bc(){const _0x4af0e5=['toLowerCase',',\x20gateway\x20','Found\x20payment\x20','REFUND','logWebhookProcessed','\x20status\x20updated\x20to\x20FAILED','AmPayTRYService','\x22,\x20orderId=\x22','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','logShopWebhookSent','\x20mapped\x20to\x20FAILED','payment.pending',',\x20gatewayOrderId:\x20','ℹ️\x20Decline\x20reason:\x20','./telegramBotService','📊\x20Amer\x20webhook\x20result:','📈\x20Payment\x20','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','__esModule','gatewayOrderId','⚠️\x20CHARGEBACK\x20without\x20penalty\x20amount\x20-\x20no\x20balance\x20change','Gateway\x20','amountAfterGatewayCommissionUSDT','gatewayCommissionRate','54QWFMXj','updatePaymentStatus','error','🏪\x20Shop\x20','2398332bnAHMY','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','customerOrderId','📊\x20Rapyd\x20webhook:\x20Payment\x20','processAmPayTRYWebhook','myxspend','payment.success','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','stringify','🔄\x20Processing\x20Plisio\x20webhook:','entries','./gateways/plisioService','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','VISA\x20payment\x20not\x20found:\x20','SINGLE',',\x20GatewayOrderId=','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','\x20current\x20balance:\x20','🔄\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','../config/database','📈\x20Payment\x20details:\x20oldStatus=\x22','Error\x20processing\x20Rapyd\x20webhook:','\x22,\x20newStatus=\x22','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','rapydService','PAID','No\x20payment\x20ID\x20in\x20Amer\x20webhook','🔄\x20Processing\x20CoinToPay2\x20webhook:','webhookLog','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','processAmerWebhook','Payment\x20marked\x20as\x20CHARGEBACK\x20(no\x20penalty\x20specified)','sendPaymentNotification','visaMasterCardService','logShopWebhookError','Webhook\x20event\x20','commission','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','💸\x20CHARGEBACK:\x20Processing\x20penalty-only\x20deduction','type','system_id','createdAt','dateTime','defineProperty','toUpperCase','desc','📊\x20AmPay\x20webhook\x20data:','📊\x20Amer\x20webhook:\x20Payment\x20','mastercard','\x20for\x20AmPay\x20webhook','✅\x20Payment\x20link\x20','findMany','Failed\x20to\x20send\x20shop\x20webhook:','shop','\x20status\x20','🔍\x20Found\x20VISA\x20payment:\x20ID=','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','paidAt','convertToUSDT','telegramBotService','467872brVYcA','ℹ️\x20AmPay\x20status\x20','POST','bankId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','No\x20additional\x20info','❌\x20Error\x20processing\x20MasterCard\x20webhook:','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','🔄\x20Processing\x20CoinToPay\x20webhook:','rapyd','20637280ktEjYn',',\x20using\x20default\x20commission\x2010%','WebhookService','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','currency','📊\x20Payment\x20status:\x20','map','Payment\x20','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook','No\x20payment\x20ID\x20in\x20VISA\x20webhook','gatewaySettings','💸\x20CHARGEBACK\x20penalty\x20ONLY:\x20-','balance','processMyXSpendWebhook','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','./gateways/mastercardService','🔄\x20Processing\x20Amer\x20webhook:','nodaService','NodaService','default','parse','amount','remitterName','sendShopWebhook','noda','coinToPayService','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','klyme','ℹ️\x20MyXSpend\x20status\x20','amountUSDT','\x20in\x20shop\x20','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','🔄\x20Processing\x20AmPay\x20webhook:','customerEmail',',\x20Status=',',\x20gatewayPaymentId:\x20','🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:','cardLast4','KlymeService','✅\x20Found\x20payment\x20','processing','errorMessage','now','🔍\x20VISA\x20payment\x20search\x20result:\x20','updatedAt','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','Error\x20processing\x20Plisio\x20webhook:','❌\x20VISA\x20webhook\x20processing\x20failed:',',\x20Gateway=','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','✅\x20Shop\x20','paymentMethod','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','gatewayPaymentId','orderId','💰\x20Amount\x20after\x20gateway\x20commission:\x20','ms)','\x20→\x20','./gateways/klymeService','processKlymeWebhook','Query\x20params:','klymeService','🔄\x20Processing\x20KLYME\x20webhook:','AmerService','toFixed','ampay_try','ampay','./gateways/nodaService','✅\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20','\x20=\x20','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','💰\x20Final\x20balance\x20after\x20chargeback:\x20',',\x20GatewayPaymentId=','\x20->\x20','client_transaction_id','\x20(Status:\x20','CoinToPay2Service','visa_mastercard','__importDefault','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','🔄\x20Processing\x20MasterCard\x20webhook:','📊\x20Noda\x20webhook:\x20Payment\x20','create','amerService','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','🔄\x20Processing\x20Noda\x20webhook:','plisioService','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','./gateways/ampayTRYService','CoinToPayService','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20',',\x20currentPayments=','📊\x20VISA\x20payment\x20found:\x20','expired','failed','plisio_gateway','./loggerService','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','No\x20payment\x20ID\x20in\x20Noda\x20webhook','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20','webhookUrl','status','processCoinToPayWebhook',',\x20newStatus=','\x20+\x20','\x22,\x20id=\x22','FAILED','Error\x20processing\x20CoinToPay\x20webhook:','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','processVisaWebhook','gateway','paymentId','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','processCoinToPay2Webhook','\x20commission\x20for\x20shop\x20','RapydService','findFirst','\x20USDT','currentPayments','loggerService','additionalInfo','❌\x20Error\x20processing\x20AmPay\x20webhook:','✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20','processAmPayWebhook','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','828827EWbkOR','🔍\x20VISA\x20payment\x20search\x20executed','sendPaymentStatusNotification','text','update','./gateways/coinToPay2Service','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','Payment\x20not\x20found:\x20','🔄\x20MyXSpend\x20status\x20','paymentLink','\x20-\x20','❌\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:','shopId','ampayService','./gateways/rapydService','refund','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','remitterIban','EXPIRED','payment','coinToPay2Service','15673XhUeFs','\x20for\x20AmPay\x20TRY\x20webhook','txUrls','created','✅\x20Found\x20payment:\x20ID=','2505iZuEdD','COMPLETED','cointopay2',',\x20card:\x20****','logWebhookError','🔄\x20Processing\x20Rapyd\x20webhook:','Payment\x20System/1.0','\x20not\x20enabled\x20for\x20shop\x20','VisaMasterCardService','Not\x20found','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','\x20balance\x20updated:\x20','📝\x20Reason:\x20','visa/mastercard','webhookEvents','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','cointopay','payment.failed','Error\x20parsing\x20webhook\x20events:','📤\x20Shop\x20webhook\x20sent\x20to\x20','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','./gateways/ampayService','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','paymentLinkId','💰\x20Payment\x20','customerName','chargeback','\x20not\x20found','unknown','processPlisioWebhook','💰\x20Gateway\x20','findUnique','settings','ampay_try_','\x20(orderId:\x20','\x22,\x20paymentLinkId=\x22','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','keys','visa','log','AmPayService','Payment\x20not\x20found','💰\x20Adding\x20to\x20balance:\x20','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','username','❌\x20Available\x20webhook\x20fields:','no\x20balance\x20change','872ZXYZyh','📊\x20VISA\x20webhook\x20result:','ampayTRYService','VISA','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','🔄\x20Processing\x20AmPay\x20TRY\x20webhook:','processNodaWebhook','application/json','🔍\x20Search\x20result:\x20','📈\x20Found\x20payment\x20link\x20','getGatewayCommission','processWebhook','amer','1533470yocnYb','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','failureMessage','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','paid','CHARGEBACK','chargebackAmount','1698oNBgvi','\x20with\x20status\x20','DECLINED','currencyService','processPlisioGatewayWebhook'];a69_0x23bc=function(){return _0x4af0e5;};return a69_0x23bc();}var __importDefault=this&&this[a69_0x581154(0x28d)]||function(_0x10e0cd){const _0xb5de7f=a69_0x581154;return _0x10e0cd&&_0x10e0cd[_0xb5de7f(0x1ec)]?_0x10e0cd:{'default':_0x10e0cd};};Object[a69_0x581154(0x221)](exports,a69_0x581154(0x1ec),{'value':!![]}),exports[a69_0x581154(0x23f)]=void 0x0;const database_1=__importDefault(require(a69_0x581154(0x209))),plisioService_1=require(a69_0x581154(0x201)),rapydService_1=require(a69_0x581154(0x2cf)),nodaService_1=require(a69_0x581154(0x281)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a69_0x581154(0x2c6)),klymeService_1=require(a69_0x581154(0x278)),mastercardService_1=require(a69_0x581154(0x24c)),amerService_1=require('./gateways/amerService'),ampayService_1=require(a69_0x581154(0x2f3)),ampayTRYService_1=require(a69_0x581154(0x299)),telegramBotService_1=require(a69_0x581154(0x1e7)),currencyService_1=require('./currencyService'),loggerService_1=require(a69_0x581154(0x2a1));class WebhookService{constructor(){const _0x30aad8=a69_0x581154;this['plisioService']=new plisioService_1['PlisioService'](),this[_0x30aad8(0x20e)]=new rapydService_1[(_0x30aad8(0x2b7))](),this['nodaService']=new nodaService_1[(_0x30aad8(0x24f))](),this['coinToPayService']=new coinToPayService_1[(_0x30aad8(0x29a))](),this[_0x30aad8(0x2d5)]=new coinToPay2Service_1[(_0x30aad8(0x28b))](),this['klymeService']=new klymeService_1[(_0x30aad8(0x263))](),this[_0x30aad8(0x217)]=new mastercardService_1[(_0x30aad8(0x2e3))](),this[_0x30aad8(0x293)]=new amerService_1[(_0x30aad8(0x27d))](),this[_0x30aad8(0x2ce)]=new ampayService_1[(_0x30aad8(0x1b9))](),this[_0x30aad8(0x1c2)]=new ampayTRYService_1[(_0x30aad8(0x1df))]();}async[a69_0x581154(0x1f3)](_0xb3c344,_0x2ccef9,_0xcc986f){const _0x31a0e6=a69_0x581154;console[_0x31a0e6(0x1b8)](_0x31a0e6(0x298)+_0xb3c344+_0x31a0e6(0x2aa)+_0x2ccef9),console[_0x31a0e6(0x1b8)]('🔄\x20Additional\x20data:',_0xcc986f),await database_1['default']['$transaction'](async _0x5a3d2f=>{const _0x5809ff=_0x31a0e6,_0x3998c4=await _0x5a3d2f[_0x5809ff(0x2d4)]['findUnique']({'where':{'id':_0xb3c344},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3998c4)throw new Error(_0x5809ff(0x244)+_0xb3c344+_0x5809ff(0x2f9));const _0x56f221=_0x3998c4[_0x5809ff(0x2a8)],_0xce6586=_0x3998c4[_0x5809ff(0x22b)];console['log'](_0x5809ff(0x2f6)+_0xb3c344+':\x20'+_0x56f221+'\x20->\x20'+_0x2ccef9),console[_0x5809ff(0x1b8)](_0x5809ff(0x1f5)+_0xce6586[_0x5809ff(0x1bd)]+_0x5809ff(0x207)+_0xce6586[_0x5809ff(0x249)]+_0x5809ff(0x2b9));const _0x291cf6={'status':_0x2ccef9[_0x5809ff(0x222)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0xcc986f?.[_0x5809ff(0x1cf)]&&(_0x291cf6[_0x5809ff(0x1cf)]=_0xcc986f[_0x5809ff(0x1cf)]);_0xcc986f?.[_0x5809ff(0x2d8)]&&(_0x291cf6[_0x5809ff(0x2d8)]=JSON['stringify'](_0xcc986f[_0x5809ff(0x2d8)]));_0xcc986f?.[_0x5809ff(0x262)]&&(_0x291cf6[_0x5809ff(0x262)]=_0xcc986f['cardLast4']);_0xcc986f?.[_0x5809ff(0x271)]&&(_0x291cf6[_0x5809ff(0x271)]=_0xcc986f[_0x5809ff(0x271)]);_0xcc986f?.['bankId']&&(_0x291cf6['bankId']=_0xcc986f[_0x5809ff(0x235)]);_0xcc986f?.[_0x5809ff(0x2d2)]&&(_0x291cf6[_0x5809ff(0x2d2)]=_0xcc986f[_0x5809ff(0x2d2)]);_0xcc986f?.['remitterName']&&(_0x291cf6[_0x5809ff(0x253)]=_0xcc986f[_0x5809ff(0x253)]);let _0x6151b1=_0xce6586[_0x5809ff(0x249)],_0x40f2c6='';if(_0x2ccef9['toUpperCase']()===_0x5809ff(0x20f)&&_0x56f221!==_0x5809ff(0x20f)){const _0x325f4c=await currencyService_1[_0x5809ff(0x1d7)][_0x5809ff(0x230)](_0x3998c4['amount'],_0x3998c4[_0x5809ff(0x241)]),_0x9ed220=await this[_0x5809ff(0x1ca)](_0xce6586['id'],_0x3998c4['gateway']),_0x48a7f7=_0x325f4c*(0x1-_0x9ed220/0x64);_0x6151b1+=_0x48a7f7,_0x40f2c6='+'+_0x48a7f7[_0x5809ff(0x27e)](0x6)+_0x5809ff(0x26e)+_0x9ed220+'%\x20gateway\x20commission)',_0x291cf6[_0x5809ff(0x25a)]=_0x325f4c,_0x291cf6[_0x5809ff(0x1f0)]=_0x48a7f7,_0x291cf6[_0x5809ff(0x1f1)]=_0x9ed220,_0x291cf6[_0x5809ff(0x22f)]=new Date(),console[_0x5809ff(0x1b8)]('💰\x20Converting\x20'+_0x3998c4[_0x5809ff(0x252)]+'\x20'+_0x3998c4['currency']+_0x5809ff(0x288)+_0x325f4c[_0x5809ff(0x27e)](0x6)+_0x5809ff(0x2b9)),console[_0x5809ff(0x1b8)](_0x5809ff(0x1af)+_0x3998c4['gateway']+'\x20commission:\x20'+_0x9ed220+'%'),console[_0x5809ff(0x1b8)](_0x5809ff(0x275)+_0x48a7f7[_0x5809ff(0x27e)](0x6)+_0x5809ff(0x2b9)),console[_0x5809ff(0x1b8)](_0x5809ff(0x1bb)+_0xce6586[_0x5809ff(0x249)]+_0x5809ff(0x2ab)+_0x48a7f7['toFixed'](0x6)+_0x5809ff(0x283)+_0x6151b1[_0x5809ff(0x27e)](0x6)+'\x20USDT');}else{if(_0x56f221===_0x5809ff(0x20f)&&_0x2ccef9['toUpperCase']()!==_0x5809ff(0x20f)&&_0x2ccef9[_0x5809ff(0x222)]()!==_0x5809ff(0x1d2)){let _0x625bc6;if(_0x3998c4[_0x5809ff(0x1f0)])_0x625bc6=_0x3998c4[_0x5809ff(0x1f0)];else{if(_0x3998c4['amountUSDT']){const _0x1ed0e6=await this[_0x5809ff(0x1ca)](_0xce6586['id'],_0x3998c4['gateway']);_0x625bc6=_0x3998c4['amountUSDT']*(0x1-_0x1ed0e6/0x64);}else console['log'](_0x5809ff(0x1d0)),_0x625bc6=0x0;}_0x625bc6>0x0&&(_0x6151b1-=_0x625bc6,_0x40f2c6='-'+_0x625bc6[_0x5809ff(0x27e)](0x6)+_0x5809ff(0x22e),_0x291cf6[_0x5809ff(0x22f)]=null,console[_0x5809ff(0x1b8)]('💰\x20Removing\x20from\x20balance:\x20'+_0xce6586[_0x5809ff(0x249)]+_0x5809ff(0x2cb)+_0x625bc6['toFixed'](0x6)+_0x5809ff(0x283)+_0x6151b1[_0x5809ff(0x27e)](0x6)+_0x5809ff(0x2b9)));}}if(_0x2ccef9[_0x5809ff(0x222)]()===_0x5809ff(0x1d2)){const _0x437740=_0xcc986f?.[_0x5809ff(0x1d3)]||0x0;console[_0x5809ff(0x1b8)](_0x5809ff(0x21c)),_0x437740>0x0?(_0x6151b1-=_0x437740,_0x40f2c6='-'+_0x437740['toFixed'](0x6)+'\x20USDT\x20(chargeback\x20penalty\x20ONLY)',_0x291cf6['chargebackAmount']=_0x437740,console['log'](_0x5809ff(0x248)+_0x437740[_0x5809ff(0x27e)](0x6)+_0x5809ff(0x2b9)),console['log']('💰\x20Payment\x20amount\x20is\x20NOT\x20deducted\x20(chargeback\x20penalty\x20only)'),console[_0x5809ff(0x1b8)](_0x5809ff(0x286)+_0x6151b1['toFixed'](0x6)+_0x5809ff(0x2b9))):(console[_0x5809ff(0x1b8)](_0x5809ff(0x1ee)),_0x40f2c6=_0x5809ff(0x215));}const _0x5e2eaf=await _0x5a3d2f[_0x5809ff(0x2d4)][_0x5809ff(0x2c5)]({'where':{'id':_0xb3c344},'data':_0x291cf6});_0x6151b1!==_0xce6586['balance']&&(await _0x5a3d2f['shop'][_0x5809ff(0x2c5)]({'where':{'id':_0xce6586['id']},'data':{'balance':_0x6151b1}}),console[_0x5809ff(0x1b8)](_0x5809ff(0x270)+_0xce6586[_0x5809ff(0x1bd)]+_0x5809ff(0x2e6)+_0xce6586['balance'][_0x5809ff(0x27e)](0x6)+'\x20->\x20'+_0x6151b1['toFixed'](0x6)+_0x5809ff(0x2b9)),console[_0x5809ff(0x1b8)](_0x5809ff(0x2e7)+_0x40f2c6));await _0x5a3d2f[_0x5809ff(0x212)][_0x5809ff(0x292)]({'data':{'paymentId':_0xb3c344,'shopId':_0xce6586['id'],'event':'webhook_status_change_'+_0x2ccef9[_0x5809ff(0x1d9)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x56f221,'newStatus':_0x2ccef9[_0x5809ff(0x222)](),'balanceChange':_0x40f2c6||_0x5809ff(0x1bf),'oldBalance':_0xce6586[_0x5809ff(0x249)],'newBalance':_0x6151b1,'amountUSDT':_0x291cf6['amountUSDT'],'additionalData':_0xcc986f,'timestamp':new Date()['toISOString']()})}}),await this[_0x5809ff(0x254)]({..._0x3998c4,..._0x5e2eaf,'shop':_0xce6586},_0x2ccef9['toUpperCase']()),await this['sendPaymentStatusNotification']({..._0x3998c4,..._0x5e2eaf},_0x2ccef9[_0x5809ff(0x222)]());if(_0x56f221!==_0x5809ff(0x20f)&&_0x2ccef9[_0x5809ff(0x222)]()===_0x5809ff(0x20f)){console[_0x5809ff(0x1b8)](_0x5809ff(0x1e9)+_0xb3c344+_0x5809ff(0x294)),console['log'](_0x5809ff(0x20a)+_0x56f221+_0x5809ff(0x20c)+_0x2ccef9[_0x5809ff(0x222)]()+_0x5809ff(0x1b4)+_0x3998c4[_0x5809ff(0x2f5)]+'\x22');if(_0x3998c4['paymentLinkId'])try{const _0x3ed8e6=await _0x5a3d2f[_0x5809ff(0x2ca)][_0x5809ff(0x1b0)]({'where':{'id':_0x3998c4['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3ed8e6){console[_0x5809ff(0x1b8)](_0x5809ff(0x1c9)+_0x3ed8e6['id']+':\x20type='+_0x3ed8e6[_0x5809ff(0x21d)]+_0x5809ff(0x29c)+_0x3ed8e6[_0x5809ff(0x2ba)]+',\x20status='+_0x3ed8e6['status']);const _0x11960c=_0x3ed8e6[_0x5809ff(0x2ba)]+0x1,_0x44fcfd=_0x3ed8e6[_0x5809ff(0x21d)]===_0x5809ff(0x204)?_0x5809ff(0x2dc):_0x3ed8e6[_0x5809ff(0x2a8)];await _0x5a3d2f['paymentLink'][_0x5809ff(0x2c5)]({'where':{'id':_0x3998c4[_0x5809ff(0x2f5)]},'data':{'currentPayments':_0x11960c,'status':_0x44fcfd,'updatedAt':new Date()}}),console[_0x5809ff(0x1b8)](_0x5809ff(0x228)+_0x3ed8e6['id']+'\x20updated:\x20currentPayments='+_0x3ed8e6[_0x5809ff(0x2ba)]+'\x20->\x20'+_0x11960c+',\x20status='+_0x3ed8e6[_0x5809ff(0x2a8)]+_0x5809ff(0x288)+_0x44fcfd);}else console[_0x5809ff(0x1b8)]('❌\x20Payment\x20link\x20'+_0x3998c4[_0x5809ff(0x2f5)]+_0x5809ff(0x2f9));}catch(_0x4283bb){console[_0x5809ff(0x1f4)](_0x5809ff(0x2f1),_0x4283bb);}else console[_0x5809ff(0x1b8)](_0x5809ff(0x1e9)+_0xb3c344+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0x5809ff(0x1b8)](_0x5809ff(0x1e9)+_0xb3c344+_0x5809ff(0x1e1)+_0x56f221+_0x5809ff(0x288)+_0x2ccef9[_0x5809ff(0x222)]());});}async[a69_0x581154(0x2fb)](_0x126871){const _0x37f547=a69_0x581154;console[_0x37f547(0x1b8)](_0x37f547(0x1ff),_0x126871);try{const _0x2e3496=await this[_0x37f547(0x297)][_0x37f547(0x1cb)](_0x126871);if(!_0x2e3496[_0x37f547(0x2b2)])throw new Error(_0x37f547(0x240));const _0x41c958=await database_1['default']['payment'][_0x37f547(0x2b8)]({'where':{'gatewayOrderId':_0x2e3496[_0x37f547(0x2b2)]}});if(!_0x41c958){console[_0x37f547(0x1f4)](_0x37f547(0x1eb)+_0x2e3496[_0x37f547(0x2b2)]);return;}console[_0x37f547(0x1b8)]('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0x41c958['id']+'\x20status\x20'+_0x2e3496[_0x37f547(0x2a8)]),await this[_0x37f547(0x1f3)](_0x41c958['id'],_0x2e3496['status'],{'txUrls':_0x2e3496[_0x37f547(0x2d8)]}),loggerService_1[_0x37f547(0x2bb)][_0x37f547(0x1dd)]('plisio',_0x41c958['id'],_0x41c958[_0x37f547(0x2a8)],_0x2e3496[_0x37f547(0x2a8)],_0x126871);}catch(_0x3dc998){console[_0x37f547(0x1f4)](_0x37f547(0x26b),_0x3dc998),loggerService_1[_0x37f547(0x2bb)][_0x37f547(0x2df)]('plisio',_0x3dc998,_0x126871);throw _0x3dc998;}}async[a69_0x581154(0x1d8)](_0x5b682a){const _0x3b797c=a69_0x581154;console[_0x3b797c(0x1b8)](_0x3b797c(0x213),_0x5b682a);try{const _0x1330d7=await this[_0x3b797c(0x297)][_0x3b797c(0x1cb)](_0x5b682a);if(!_0x1330d7[_0x3b797c(0x2b2)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x30a7c5=await database_1['default'][_0x3b797c(0x2d4)][_0x3b797c(0x2b8)]({'where':{'gatewayOrderId':_0x1330d7[_0x3b797c(0x2b2)]}});if(!_0x30a7c5){console[_0x3b797c(0x1f4)](_0x3b797c(0x2c0)+_0x1330d7[_0x3b797c(0x2b2)]);return;}console[_0x3b797c(0x1b8)](_0x3b797c(0x2c7)+_0x30a7c5['id']+_0x3b797c(0x22c)+_0x1330d7['status']),await this[_0x3b797c(0x1f3)](_0x30a7c5['id'],_0x1330d7[_0x3b797c(0x2a8)],{'txUrls':_0x1330d7[_0x3b797c(0x2d8)]}),loggerService_1[_0x3b797c(0x2bb)][_0x3b797c(0x1dd)]('plisio_gateway',_0x30a7c5['id'],_0x30a7c5[_0x3b797c(0x2a8)],_0x1330d7[_0x3b797c(0x2a8)],_0x5b682a);}catch(_0x2357e1){console['error'](_0x3b797c(0x26f),_0x2357e1),loggerService_1[_0x3b797c(0x2bb)][_0x3b797c(0x2df)](_0x3b797c(0x2a0),_0x2357e1,_0x5b682a);throw _0x2357e1;}}async['processRapydWebhook'](_0x38cea3){const _0xef935d=a69_0x581154;console[_0xef935d(0x1b8)](_0xef935d(0x2e0),_0x38cea3);try{const _0x17a01e=await this[_0xef935d(0x20e)][_0xef935d(0x1cb)](_0x38cea3);if(!_0x17a01e['paymentId'])throw new Error(_0xef935d(0x2a5));const _0x1fa13b=await database_1['default'][_0xef935d(0x2d4)]['findFirst']({'where':{'gatewayOrderId':_0x17a01e[_0xef935d(0x2b2)]}});if(!_0x1fa13b){console[_0xef935d(0x1f4)](_0xef935d(0x285)+_0x17a01e[_0xef935d(0x2b2)]);return;}console[_0xef935d(0x1b8)](_0xef935d(0x1f9)+_0x1fa13b['id']+'\x20status\x20'+_0x17a01e[_0xef935d(0x2a8)]),await this['updatePaymentStatus'](_0x1fa13b['id'],_0x17a01e[_0xef935d(0x2a8)],{'failureMessage':_0x17a01e[_0xef935d(0x1cf)],'cardLast4':_0x17a01e[_0xef935d(0x2bc)]?.[_0xef935d(0x262)],'paymentMethod':_0x17a01e[_0xef935d(0x2bc)]?.[_0xef935d(0x271)]}),loggerService_1[_0xef935d(0x2bb)]['logWebhookProcessed']('rapyd',_0x1fa13b['id'],_0x1fa13b['status'],_0x17a01e[_0xef935d(0x2a8)],_0x38cea3);}catch(_0x1cd7dd){console[_0xef935d(0x1f4)](_0xef935d(0x20b),_0x1cd7dd),loggerService_1[_0xef935d(0x2bb)][_0xef935d(0x2df)](_0xef935d(0x23c),_0x1cd7dd,_0x38cea3);throw _0x1cd7dd;}}async[a69_0x581154(0x1c6)](_0x58eb49){const _0x53a6a8=a69_0x581154;console[_0x53a6a8(0x1b8)](_0x53a6a8(0x296),_0x58eb49);try{const _0x34c2e7=await this[_0x53a6a8(0x24e)]['processWebhook'](_0x58eb49);if(!_0x34c2e7[_0x53a6a8(0x2b2)])throw new Error(_0x53a6a8(0x2a4));const _0x4e26a4=await database_1[_0x53a6a8(0x250)][_0x53a6a8(0x2d4)][_0x53a6a8(0x2b8)]({'where':{'gatewayOrderId':_0x34c2e7[_0x53a6a8(0x2b2)]}});if(!_0x4e26a4){console[_0x53a6a8(0x1f4)](_0x53a6a8(0x295)+_0x34c2e7[_0x53a6a8(0x2b2)]);return;}console[_0x53a6a8(0x1b8)](_0x53a6a8(0x291)+_0x4e26a4['id']+'\x20status\x20'+_0x34c2e7['status']),await this['updatePaymentStatus'](_0x4e26a4['id'],_0x34c2e7['status'],{'bankId':_0x34c2e7[_0x53a6a8(0x2bc)]?.['bankId'],'remitterIban':_0x34c2e7[_0x53a6a8(0x2bc)]?.[_0x53a6a8(0x2d2)],'remitterName':_0x34c2e7[_0x53a6a8(0x2bc)]?.[_0x53a6a8(0x253)]}),loggerService_1[_0x53a6a8(0x2bb)][_0x53a6a8(0x1dd)](_0x53a6a8(0x255),_0x4e26a4['id'],_0x4e26a4['status'],_0x34c2e7[_0x53a6a8(0x2a8)],_0x58eb49);}catch(_0x46aeba){console[_0x53a6a8(0x1f4)]('Error\x20processing\x20Noda\x20webhook:',_0x46aeba),loggerService_1[_0x53a6a8(0x2bb)][_0x53a6a8(0x2df)]('noda',_0x46aeba,_0x58eb49);throw _0x46aeba;}}async[a69_0x581154(0x2a9)](_0xe94717){const _0x3327ad=a69_0x581154;console[_0x3327ad(0x1b8)](_0x3327ad(0x23b),_0xe94717);try{const _0x40343c=await this[_0x3327ad(0x256)][_0x3327ad(0x1cb)](_0xe94717);if(!_0x40343c[_0x3327ad(0x2b2)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x472eb1=await database_1[_0x3327ad(0x250)][_0x3327ad(0x2d4)]['findFirst']({'where':{'gatewayOrderId':_0x40343c[_0x3327ad(0x2b2)]}});if(!_0x472eb1){console['error'](_0x3327ad(0x257)+_0x40343c[_0x3327ad(0x2b2)]);return;}console[_0x3327ad(0x1b8)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x472eb1['id']+'\x20status\x20'+_0x40343c[_0x3327ad(0x2a8)]),await this[_0x3327ad(0x1f3)](_0x472eb1['id'],_0x40343c['status']),loggerService_1['loggerService'][_0x3327ad(0x1dd)](_0x3327ad(0x2eb),_0x472eb1['id'],_0x472eb1['status'],_0x40343c[_0x3327ad(0x2a8)],_0xe94717);}catch(_0x3b3327){console[_0x3327ad(0x1f4)](_0x3327ad(0x2ae),_0x3b3327),loggerService_1['loggerService'][_0x3327ad(0x2df)](_0x3327ad(0x2eb),_0x3b3327,_0xe94717);throw _0x3b3327;}}async[a69_0x581154(0x2b5)](_0x441338){const _0xdd4c5c=a69_0x581154;console['log'](_0xdd4c5c(0x211),_0x441338);try{const _0x5dd2d6=await this[_0xdd4c5c(0x2d5)][_0xdd4c5c(0x1cb)](_0x441338);if(!_0x5dd2d6[_0xdd4c5c(0x2b2)])throw new Error(_0xdd4c5c(0x28f));const _0x1ed357=await database_1[_0xdd4c5c(0x250)][_0xdd4c5c(0x2d4)][_0xdd4c5c(0x2b8)]({'where':{'gatewayOrderId':_0x5dd2d6[_0xdd4c5c(0x2b2)]}});if(!_0x1ed357){console[_0xdd4c5c(0x1f4)](_0xdd4c5c(0x2b3)+_0x5dd2d6[_0xdd4c5c(0x2b2)]);return;}console[_0xdd4c5c(0x1b8)](_0xdd4c5c(0x2a2)+_0x1ed357['id']+_0xdd4c5c(0x22c)+_0x5dd2d6[_0xdd4c5c(0x2a8)]),await this['updatePaymentStatus'](_0x1ed357['id'],_0x5dd2d6[_0xdd4c5c(0x2a8)]),loggerService_1[_0xdd4c5c(0x2bb)][_0xdd4c5c(0x1dd)](_0xdd4c5c(0x2dd),_0x1ed357['id'],_0x1ed357[_0xdd4c5c(0x2a8)],_0x5dd2d6[_0xdd4c5c(0x2a8)],_0x441338);}catch(_0x5e7c67){console['error']('Error\x20processing\x20CoinToPay2\x20webhook:',_0x5e7c67),loggerService_1[_0xdd4c5c(0x2bb)][_0xdd4c5c(0x2df)](_0xdd4c5c(0x2dd),_0x5e7c67,_0x441338);throw _0x5e7c67;}}async[a69_0x581154(0x279)](_0x4650f5){const _0x19b404=a69_0x581154;console[_0x19b404(0x1b8)](_0x19b404(0x27c),_0x4650f5);try{const _0x45cdc3=await this[_0x19b404(0x27b)]['processWebhook'](_0x4650f5);if(!_0x45cdc3[_0x19b404(0x2b2)])throw new Error(_0x19b404(0x24b));const _0xef50d2=await database_1['default'][_0x19b404(0x2d4)][_0x19b404(0x2b8)]({'where':{'gatewayOrderId':_0x45cdc3['paymentId']}});if(!_0xef50d2){console[_0x19b404(0x1f4)](_0x19b404(0x1c4)+_0x45cdc3['paymentId']);return;}console[_0x19b404(0x1b8)]('📊\x20KLYME\x20webhook:\x20Payment\x20'+_0xef50d2['id']+_0x19b404(0x22c)+_0x45cdc3[_0x19b404(0x2a8)]),await this[_0x19b404(0x1f3)](_0xef50d2['id'],_0x45cdc3[_0x19b404(0x2a8)],{'paymentMethod':_0x45cdc3[_0x19b404(0x2bc)]?.['payment_method']}),loggerService_1['loggerService'][_0x19b404(0x1dd)](_0x19b404(0x258),_0xef50d2['id'],_0xef50d2[_0x19b404(0x2a8)],_0x45cdc3[_0x19b404(0x2a8)],_0x4650f5);}catch(_0x366e5e){console[_0x19b404(0x1f4)]('Error\x20processing\x20KLYME\x20webhook:',_0x366e5e),loggerService_1['loggerService']['logWebhookError']('klyme',_0x366e5e,_0x4650f5);throw _0x366e5e;}}async[a69_0x581154(0x2b0)](_0x18c2ab){const _0x381af7=a69_0x581154;console['log']('🔄\x20Processing\x20VISA\x20webhook:',JSON[_0x381af7(0x1fe)](_0x18c2ab,null,0x2));try{const _0x191fea=await this['visaMasterCardService'][_0x381af7(0x1cb)](_0x18c2ab,_0x381af7(0x1c3));console[_0x381af7(0x1b8)](_0x381af7(0x1c1),_0x191fea);if(!_0x191fea[_0x381af7(0x2b2)]){console[_0x381af7(0x1f4)](_0x381af7(0x1ce)),console['error'](_0x381af7(0x1be),Object[_0x381af7(0x1b6)](_0x18c2ab));throw new Error(_0x381af7(0x246));}let _0x221931=null;console['log'](_0x381af7(0x1bc)+_0x191fea[_0x381af7(0x2b2)]);if(_0x191fea[_0x381af7(0x2b2)]){console['log'](_0x381af7(0x239)),console[_0x381af7(0x1b8)]('🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:'),console[_0x381af7(0x1b8)](_0x381af7(0x2d1)),console[_0x381af7(0x1b8)](_0x381af7(0x1fd)+_0x191fea[_0x381af7(0x2b2)]),console[_0x381af7(0x1b8)](_0x381af7(0x28e)),_0x221931=await database_1[_0x381af7(0x250)]['payment']['findFirst']({'where':{'AND':[{'OR':[{'gateway':_0x381af7(0x2e8)},{'gateway':_0x381af7(0x226)}]},{'OR':[{'gatewayPaymentId':_0x191fea['paymentId']},{'gatewayOrderId':_0x191fea[_0x381af7(0x2b2)]},{'id':_0x191fea[_0x381af7(0x2b2)]},{'orderId':_0x191fea[_0x381af7(0x2b2)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console['log'](_0x381af7(0x2c2));if(_0x221931)console['log'](_0x381af7(0x2da)+_0x221931['id']+_0x381af7(0x205)+_0x221931[_0x381af7(0x1ed)]+_0x381af7(0x287)+_0x221931[_0x381af7(0x273)]);else{console[_0x381af7(0x1b8)]('❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...');const _0x1af1c5=await database_1[_0x381af7(0x250)][_0x381af7(0x2d4)][_0x381af7(0x229)]({'where':{'gateway':'visa/mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x381af7(0x223)}});console[_0x381af7(0x1b8)](_0x381af7(0x261),_0x1af1c5[_0x381af7(0x243)](_0x23c2c7=>_0x23c2c7['id']+_0x381af7(0x1b3)+_0x23c2c7['orderId']+_0x381af7(0x1e5)+_0x23c2c7[_0x381af7(0x1ed)]+_0x381af7(0x260)+_0x23c2c7[_0x381af7(0x273)]+_0x381af7(0x2de)+_0x23c2c7[_0x381af7(0x262)]+')'));}console[_0x381af7(0x1b8)](_0x381af7(0x268)+(_0x221931?'Found':_0x381af7(0x2e4))),_0x221931&&console[_0x381af7(0x1b8)](_0x381af7(0x22d)+_0x221931['id']+_0x381af7(0x26d)+_0x221931[_0x381af7(0x2b1)]+_0x381af7(0x25f)+_0x221931[_0x381af7(0x2a8)]+',\x20Card=****'+_0x221931[_0x381af7(0x262)]);}if(!_0x221931){console[_0x381af7(0x1f4)]('❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20'+_0x191fea[_0x381af7(0x2b2)]),loggerService_1[_0x381af7(0x2bb)]['logWebhookError'](_0x381af7(0x1b7),new Error(_0x381af7(0x2c8)+_0x191fea[_0x381af7(0x2b2)]),_0x18c2ab);throw new Error(_0x381af7(0x203)+_0x191fea['paymentId']);}console[_0x381af7(0x1b8)](_0x381af7(0x29d)+_0x221931['id']+_0x381af7(0x28a)+_0x221931['status']+_0x381af7(0x277)+_0x191fea[_0x381af7(0x2a8)]+')');const _0x2f7126={};_0x191fea[_0x381af7(0x252)]&&await database_1[_0x381af7(0x250)][_0x381af7(0x2d4)][_0x381af7(0x2c5)]({'where':{'id':_0x221931['id']},'data':{'amount':_0x191fea[_0x381af7(0x252)],'updatedAt':new Date()}}),_0x191fea[_0x381af7(0x241)]&&await database_1['default'][_0x381af7(0x2d4)][_0x381af7(0x2c5)]({'where':{'id':_0x221931['id']},'data':{'currency':_0x191fea[_0x381af7(0x241)],'updatedAt':new Date()}}),_0x191fea[_0x381af7(0x2a8)]===_0x381af7(0x2ad)&&_0x191fea[_0x381af7(0x266)]&&(_0x2f7126[_0x381af7(0x1cf)]=_0x191fea['errorMessage'],console[_0x381af7(0x1b8)](_0x381af7(0x2f0)+_0x191fea[_0x381af7(0x266)])),_0x2f7126[_0x381af7(0x271)]=_0x381af7(0x1b7),await this['updatePaymentStatus'](_0x221931['id'],_0x191fea[_0x381af7(0x2a8)],_0x2f7126),await database_1[_0x381af7(0x250)][_0x381af7(0x212)][_0x381af7(0x292)]({'data':{'paymentId':_0x221931['id'],'shopId':_0x221931[_0x381af7(0x2cd)],'event':'visa_'+_0x191fea[_0x381af7(0x2a8)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x381af7(0x1fe)](_0x191fea)}}),await this[_0x381af7(0x2c3)](_0x221931,_0x191fea['status'][_0x381af7(0x222)]()),console[_0x381af7(0x1b8)]('✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20'+_0x221931['id']);}catch(_0x403d5b){console[_0x381af7(0x1f4)](_0x381af7(0x26c),_0x403d5b),loggerService_1[_0x381af7(0x2bb)][_0x381af7(0x2df)](_0x381af7(0x1b7),_0x403d5b,_0x18c2ab);throw _0x403d5b;}}async['processMasterCardWebhook'](_0xc32468){const _0x2515d6=a69_0x581154;console['log'](_0x2515d6(0x290),JSON['stringify'](_0xc32468,null,0x2));try{const _0x163f9b=await this[_0x2515d6(0x217)][_0x2515d6(0x1cb)](_0xc32468,'MASTERCARD');console['log']('📊\x20MasterCard\x20webhook\x20result:',_0x163f9b);if(!_0x163f9b[_0x2515d6(0x2b2)]){console[_0x2515d6(0x1f4)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data'),console[_0x2515d6(0x1f4)](_0x2515d6(0x1be),Object[_0x2515d6(0x1b6)](_0xc32468));throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');}let _0x3d1e67=null;console[_0x2515d6(0x1b8)](_0x2515d6(0x29b)+_0x163f9b['paymentId']);_0x163f9b['paymentId']&&(console['log'](_0x2515d6(0x25c)),_0x3d1e67=await database_1['default'][_0x2515d6(0x2d4)][_0x2515d6(0x2b8)]({'where':{'AND':[{'OR':[{'gateway':_0x2515d6(0x28c)},{'gateway':_0x2515d6(0x226)},{'gateway':'visa/mastercard'}]},{'OR':[{'gatewayPaymentId':_0x163f9b[_0x2515d6(0x2b2)]},{'gatewayOrderId':_0x163f9b['paymentId']},{'id':_0x163f9b[_0x2515d6(0x2b2)]},{'orderId':_0x163f9b[_0x2515d6(0x2b2)]}]}]}}),console[_0x2515d6(0x1b8)](_0x2515d6(0x1c8)+(_0x3d1e67?_0x2515d6(0x1db)+_0x3d1e67['id']:_0x2515d6(0x1ba))));if(!_0x3d1e67){console[_0x2515d6(0x1f4)](_0x2515d6(0x2e5)+_0x163f9b[_0x2515d6(0x2b2)]),console[_0x2515d6(0x1f4)](_0x2515d6(0x2ea)+_0x163f9b[_0x2515d6(0x2b2)]+_0x2515d6(0x2ac)+_0x163f9b[_0x2515d6(0x2b2)]+_0x2515d6(0x1e0)+_0x163f9b[_0x2515d6(0x2b2)]+'\x22');const _0x4520a5=await database_1[_0x2515d6(0x250)]['payment'][_0x2515d6(0x229)]({'where':{'OR':[{'gateway':_0x2515d6(0x226)},{'gateway':_0x2515d6(0x28c)},{'gateway':_0x2515d6(0x2e8)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x2515d6(0x223)},'take':0xf});console['log'](_0x2515d6(0x1b5),_0x4520a5),loggerService_1[_0x2515d6(0x2bb)][_0x2515d6(0x2df)](_0x2515d6(0x226),new Error(_0x2515d6(0x2c8)+_0x163f9b[_0x2515d6(0x2b2)]),_0xc32468);throw new Error('MasterCard\x20payment\x20not\x20found:\x20'+_0x163f9b[_0x2515d6(0x2b2)]);}console[_0x2515d6(0x1b8)](_0x2515d6(0x264)+_0x3d1e67['id']+_0x2515d6(0x206)+_0x3d1e67[_0x2515d6(0x2a8)]+'\x20to\x20'+_0x163f9b['status']);const _0x12ed34={};_0x163f9b['amount']&&await database_1[_0x2515d6(0x250)][_0x2515d6(0x2d4)][_0x2515d6(0x2c5)]({'where':{'id':_0x3d1e67['id']},'data':{'amount':_0x163f9b[_0x2515d6(0x252)],'updatedAt':new Date()}}),_0x163f9b[_0x2515d6(0x241)]&&await database_1['default'][_0x2515d6(0x2d4)]['update']({'where':{'id':_0x3d1e67['id']},'data':{'currency':_0x163f9b[_0x2515d6(0x241)],'updatedAt':new Date()}}),_0x163f9b[_0x2515d6(0x2a8)]===_0x2515d6(0x2ad)&&_0x163f9b['errorMessage']&&(_0x12ed34[_0x2515d6(0x1cf)]=_0x163f9b[_0x2515d6(0x266)],console['log'](_0x2515d6(0x2b4)+_0x163f9b[_0x2515d6(0x266)])),_0x12ed34[_0x2515d6(0x271)]=_0x2515d6(0x226),await this[_0x2515d6(0x1f3)](_0x3d1e67['id'],_0x163f9b[_0x2515d6(0x2a8)],_0x12ed34),loggerService_1[_0x2515d6(0x2bb)][_0x2515d6(0x1dd)](_0x2515d6(0x226),_0x3d1e67['id'],_0x3d1e67[_0x2515d6(0x2a8)],_0x163f9b['status'],_0xc32468);}catch(_0x26d632){console[_0x2515d6(0x1f4)](_0x2515d6(0x238),_0x26d632),loggerService_1[_0x2515d6(0x2bb)]['logWebhookError'](_0x2515d6(0x226),_0x26d632,_0xc32468);throw _0x26d632;}}async[a69_0x581154(0x214)](_0x3fba09){const _0x54df7f=a69_0x581154;console[_0x54df7f(0x1b8)](_0x54df7f(0x24d),JSON[_0x54df7f(0x1fe)](_0x3fba09,null,0x2));try{const _0x575e5c=await this[_0x54df7f(0x293)]['processWebhook'](_0x3fba09);console['log'](_0x54df7f(0x1e8),_0x575e5c);if(!_0x575e5c[_0x54df7f(0x2b2)]){console[_0x54df7f(0x1f4)](_0x54df7f(0x272)),console['error'](_0x54df7f(0x1be),Object[_0x54df7f(0x1b6)](_0x3fba09));throw new Error(_0x54df7f(0x210));}let _0x503a9b=null;console[_0x54df7f(0x1b8)]('🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x575e5c[_0x54df7f(0x2b2)]),_0x503a9b=await database_1[_0x54df7f(0x250)][_0x54df7f(0x2d4)][_0x54df7f(0x2b8)]({'where':{'AND':[{'gateway':'amer'},{'OR':[{'gatewayPaymentId':_0x575e5c[_0x54df7f(0x2b2)]},{'gatewayOrderId':_0x575e5c[_0x54df7f(0x2b2)]},{'id':_0x575e5c['paymentId']},{'orderId':_0x575e5c[_0x54df7f(0x2b2)]}]}]}}),console[_0x54df7f(0x1b8)](_0x54df7f(0x1c8)+(_0x503a9b?'Found\x20payment\x20'+_0x503a9b['id']:_0x54df7f(0x1ba)));if(!_0x503a9b){console[_0x54df7f(0x1f4)]('❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20'+_0x575e5c[_0x54df7f(0x2b2)]);return;}console[_0x54df7f(0x1b8)](_0x54df7f(0x225)+_0x503a9b['id']+'\x20status\x20'+_0x575e5c['status']),await this[_0x54df7f(0x1f3)](_0x503a9b['id'],_0x575e5c['status'],{'cardLast4':_0x575e5c[_0x54df7f(0x2bc)]?.['cardLast4'],'paymentMethod':_0x575e5c[_0x54df7f(0x2bc)]?.[_0x54df7f(0x271)]});}catch(_0x282569){console[_0x54df7f(0x1f4)]('❌\x20Error\x20processing\x20Amer\x20webhook:',_0x282569),loggerService_1[_0x54df7f(0x2bb)]['logWebhookError'](_0x54df7f(0x1cc),_0x282569,_0x3fba09);throw _0x282569;}}async[a69_0x581154(0x2bf)](_0x1ab924){const _0x1fe5b2=a69_0x581154;console['log'](_0x1fe5b2(0x25d),JSON[_0x1fe5b2(0x1fe)](_0x1ab924,null,0x2));try{const _0x188d27=_0x1ab924[_0x1fe5b2(0x2a8)],_0x25f2e0=_0x1ab924['client_transaction_id'],_0x4d3dab=_0x1ab924[_0x1fe5b2(0x21e)],_0x187c9a=_0x1ab924['payment_method'],_0x292c79=_0x1ab924['amount'],_0x349948=_0x1ab924['currency'],_0x397803=_0x1ab924['commission'],_0x5c52da=_0x1ab924['status_addition_info'];if(!_0x25f2e0){console[_0x1fe5b2(0x1f4)](_0x1fe5b2(0x2a3));throw new Error('Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook');}console[_0x1fe5b2(0x1b8)](_0x1fe5b2(0x224),{'status':_0x188d27,'clientTransactionId':_0x25f2e0,'systemId':_0x4d3dab,'paymentMethod':_0x187c9a,'amount':_0x292c79,'currency':_0x349948,'commission':_0x397803,'statusAdditionInfo':_0x5c52da});const _0x31397e=await database_1[_0x1fe5b2(0x250)][_0x1fe5b2(0x2d4)][_0x1fe5b2(0x2b8)]({'where':{'OR':[{'gatewayOrderId':_0x25f2e0},{'orderId':_0x25f2e0},{'id':_0x25f2e0},{'gatewayPaymentId':_0x25f2e0}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x31397e){console[_0x1fe5b2(0x1f4)](_0x1fe5b2(0x21b)+_0x25f2e0);throw new Error(_0x1fe5b2(0x2c8)+_0x25f2e0);}console['log']('✅\x20Found\x20payment\x20'+_0x31397e['id']+_0x1fe5b2(0x227)),console[_0x1fe5b2(0x1b8)](_0x1fe5b2(0x242)+_0x31397e[_0x1fe5b2(0x2a8)]+_0x1fe5b2(0x277)+_0x188d27),_0x188d27===_0x1fe5b2(0x1d6)?(console['log'](_0x1fe5b2(0x1ea)),await this[_0x1fe5b2(0x1f3)](_0x31397e['id'],_0x1fe5b2(0x2ad)),console[_0x1fe5b2(0x1b8)](_0x1fe5b2(0x2be)+_0x31397e['id']+_0x1fe5b2(0x1de)),console[_0x1fe5b2(0x1b8)](_0x1fe5b2(0x1e6)+(_0x5c52da||_0x1fe5b2(0x237)))):console[_0x1fe5b2(0x1b8)](_0x1fe5b2(0x233)+_0x188d27+_0x1fe5b2(0x20d)),await database_1[_0x1fe5b2(0x250)][_0x1fe5b2(0x212)]['create']({'data':{'paymentId':_0x31397e['id'],'shopId':_0x31397e[_0x1fe5b2(0x2cd)],'event':'ampay_'+(_0x188d27?.['toLowerCase']()||'unknown'),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x1ab924)}}),loggerService_1[_0x1fe5b2(0x2bb)]['logWebhookProcessed'](_0x1fe5b2(0x280),_0x31397e['id'],_0x31397e[_0x1fe5b2(0x2a8)],_0x188d27===_0x1fe5b2(0x1d6)?_0x1fe5b2(0x2ad):_0x188d27,_0x1ab924);}catch(_0x56679f){console[_0x1fe5b2(0x1f4)](_0x1fe5b2(0x2bd),_0x56679f),loggerService_1['loggerService'][_0x1fe5b2(0x2df)](_0x1fe5b2(0x280),_0x56679f,_0x1ab924);throw _0x56679f;}}async[a69_0x581154(0x1fa)](_0x5c052c){const _0x362a23=a69_0x581154;console[_0x362a23(0x1b8)](_0x362a23(0x1c5),JSON['stringify'](_0x5c052c,null,0x2));try{const _0x45844d=_0x5c052c[_0x362a23(0x2a8)],_0x3e6357=_0x5c052c[_0x362a23(0x289)],_0x4f895d=_0x5c052c[_0x362a23(0x21e)],_0x5e8917=_0x5c052c['payment_method'],_0x242447=_0x5c052c[_0x362a23(0x252)],_0x4598a9=_0x5c052c[_0x362a23(0x241)],_0x378228=_0x5c052c['commission'],_0x4f3e10=_0x5c052c['status_addition_info'];if(!_0x3e6357){console[_0x362a23(0x1f4)](_0x362a23(0x245));throw new Error(_0x362a23(0x1f7));}console[_0x362a23(0x1b8)]('📊\x20AmPay\x20TRY\x20webhook\x20data:',{'status':_0x45844d,'clientTransactionId':_0x3e6357,'systemId':_0x4f895d,'paymentMethod':_0x5e8917,'amount':_0x242447,'currency':_0x4598a9,'commission':_0x378228,'statusAdditionInfo':_0x4f3e10});const _0x2c0f65=await database_1[_0x362a23(0x250)][_0x362a23(0x2d4)][_0x362a23(0x2b8)]({'where':{'OR':[{'gatewayOrderId':_0x3e6357},{'orderId':_0x3e6357},{'id':_0x3e6357},{'gatewayPaymentId':_0x3e6357}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x2c0f65){console['error'](_0x362a23(0x2a6)+_0x3e6357);throw new Error(_0x362a23(0x2c8)+_0x3e6357);}console[_0x362a23(0x1b8)]('✅\x20Found\x20payment\x20'+_0x2c0f65['id']+_0x362a23(0x2d7)),console[_0x362a23(0x1b8)](_0x362a23(0x242)+_0x2c0f65[_0x362a23(0x2a8)]+_0x362a23(0x277)+_0x45844d),_0x45844d===_0x362a23(0x1d6)?(console[_0x362a23(0x1b8)](_0x362a23(0x208)),await this[_0x362a23(0x1f3)](_0x2c0f65['id'],_0x362a23(0x2ad)),console[_0x362a23(0x1b8)](_0x362a23(0x282)+_0x2c0f65['id']+_0x362a23(0x1de)),console[_0x362a23(0x1b8)](_0x362a23(0x1e6)+(_0x4f3e10||_0x362a23(0x237)))):console[_0x362a23(0x1b8)]('ℹ️\x20AmPay\x20TRY\x20status\x20'+_0x45844d+_0x362a23(0x20d)),await database_1[_0x362a23(0x250)][_0x362a23(0x212)][_0x362a23(0x292)]({'data':{'paymentId':_0x2c0f65['id'],'shopId':_0x2c0f65[_0x362a23(0x2cd)],'event':_0x362a23(0x1b2)+(_0x45844d?.[_0x362a23(0x1d9)]()||_0x362a23(0x2fa)),'statusCode':0xc8,'responseBody':JSON[_0x362a23(0x1fe)](_0x5c052c)}}),loggerService_1[_0x362a23(0x2bb)][_0x362a23(0x1dd)](_0x362a23(0x27f),_0x2c0f65['id'],_0x2c0f65[_0x362a23(0x2a8)],_0x45844d==='DECLINED'?_0x362a23(0x2ad):_0x45844d,_0x5c052c);}catch(_0x5948d7){console[_0x362a23(0x1f4)](_0x362a23(0x2cc),_0x5948d7),loggerService_1['loggerService'][_0x362a23(0x2df)](_0x362a23(0x27f),_0x5948d7,_0x5c052c);throw _0x5948d7;}}async[a69_0x581154(0x254)](_0x16e112,_0x2da2b0){const _0x55e940=a69_0x581154,_0x260ddd=Date[_0x55e940(0x267)]();try{const _0x33906c=_0x16e112[_0x55e940(0x22b)],_0x33adc5=_0x33906c[_0x55e940(0x1b1)];if(!_0x33adc5?.[_0x55e940(0x2a7)]){console[_0x55e940(0x1b8)](_0x55e940(0x236)+_0x33906c['id']);return;}const _0x30fc3f=_0x2da2b0===_0x55e940(0x20f)?_0x55e940(0x1fc):_0x2da2b0===_0x55e940(0x2ad)?_0x55e940(0x2ec):_0x2da2b0===_0x55e940(0x2d3)?_0x55e940(0x2ec):_0x2da2b0===_0x55e940(0x1d2)?'payment.failed':_0x2da2b0===_0x55e940(0x1dc)?_0x55e940(0x2ec):_0x55e940(0x1e4);let _0x2a6016=[];if(_0x33adc5['webhookEvents'])try{_0x2a6016=Array['isArray'](_0x33adc5['webhookEvents'])?_0x33adc5[_0x55e940(0x2e9)]:JSON[_0x55e940(0x251)](_0x33adc5['webhookEvents']);}catch(_0x31022a){console[_0x55e940(0x1f4)](_0x55e940(0x2ed),_0x31022a),_0x2a6016=[];}if(!_0x2a6016['includes'](_0x30fc3f)){console[_0x55e940(0x1b8)](_0x55e940(0x219)+_0x30fc3f+_0x55e940(0x2e2)+_0x33906c['id']);return;}const _0x1334f2={'event':_0x30fc3f,'payment':{'id':_0x16e112['id'],'order_id':_0x16e112[_0x55e940(0x274)],'gateway_order_id':_0x16e112[_0x55e940(0x1ed)],'gateway':_0x16e112['gateway'],'amount':_0x16e112['amount'],'currency':_0x16e112[_0x55e940(0x241)],'status':_0x2da2b0['toLowerCase'](),'customer_email':_0x16e112[_0x55e940(0x25e)],'customer_name':_0x16e112[_0x55e940(0x2f7)],'failure_message':_0x16e112[_0x55e940(0x1cf)],'tx_urls':_0x16e112[_0x55e940(0x2d8)]?JSON[_0x55e940(0x251)](_0x16e112[_0x55e940(0x2d8)]):null,'created_at':_0x16e112[_0x55e940(0x21f)],'updated_at':_0x16e112[_0x55e940(0x269)]}},_0x38cf01=await fetch(_0x33adc5[_0x55e940(0x2a7)],{'method':_0x55e940(0x234),'headers':{'Content-Type':_0x55e940(0x1c7),'User-Agent':_0x55e940(0x2e1)},'body':JSON[_0x55e940(0x1fe)](_0x1334f2)}),_0x1971af=Date[_0x55e940(0x267)]()-_0x260ddd,_0x5d4e9f=_0x38cf01['ok']?'Success':await _0x38cf01[_0x55e940(0x2c4)]();loggerService_1[_0x55e940(0x2bb)][_0x55e940(0x1e2)](_0x16e112[_0x55e940(0x2cd)],_0x33adc5[_0x55e940(0x2a7)],_0x30fc3f,_0x38cf01['status'],_0x1971af,_0x1334f2),console[_0x55e940(0x1b8)](_0x55e940(0x2ee)+_0x33adc5[_0x55e940(0x2a7)]+_0x55e940(0x1d5)+_0x38cf01[_0x55e940(0x2a8)]+'\x20('+_0x1971af+_0x55e940(0x276));}catch(_0x154809){console[_0x55e940(0x1f4)](_0x55e940(0x22a),_0x154809),loggerService_1[_0x55e940(0x2bb)][_0x55e940(0x218)](_0x16e112[_0x55e940(0x2cd)],_0x16e112['shop']?.[_0x55e940(0x1b1)]?.[_0x55e940(0x2a7)]||_0x55e940(0x2fa),'webhook_send',_0x154809,{});}}async[a69_0x581154(0x2c3)](_0x3649ba,_0x572048){const _0x44f4f6=a69_0x581154;try{const _0x198103={'PENDING':_0x44f4f6(0x2d9),'PROCESSING':_0x44f4f6(0x265),'PAID':_0x44f4f6(0x1d1),'FAILED':_0x44f4f6(0x29f),'EXPIRED':_0x44f4f6(0x29e),'REFUND':_0x44f4f6(0x2d0),'CHARGEBACK':_0x44f4f6(0x2f8)},_0x9810fe=_0x198103[_0x572048];if(!_0x9810fe||_0x9810fe==='created')return;await telegramBotService_1[_0x44f4f6(0x231)][_0x44f4f6(0x216)](_0x3649ba[_0x44f4f6(0x2cd)],_0x3649ba,_0x9810fe);}catch(_0x3b74fd){console[_0x44f4f6(0x1f4)](_0x44f4f6(0x2f2),_0x3b74fd);}}async[a69_0x581154(0x1ca)](_0x476a20,_0x35da7e){const _0x215fe4=a69_0x581154;try{const _0x2ba7c3=await database_1['default'][_0x215fe4(0x22b)][_0x215fe4(0x1b0)]({'where':{'id':_0x476a20},'select':{'gatewaySettings':!![]}});if(!_0x2ba7c3?.[_0x215fe4(0x247)])return console[_0x215fe4(0x1b8)](_0x215fe4(0x2af)+_0x476a20+_0x215fe4(0x23e)),0xa;const _0x104dcf=JSON['parse'](_0x2ba7c3[_0x215fe4(0x247)]);for(const [_0x1c413f,_0x451f66]of Object[_0x215fe4(0x200)](_0x104dcf)){if(_0x1c413f[_0x215fe4(0x1d9)]()===_0x35da7e[_0x215fe4(0x1d9)]()){const _0x7e91e3=_0x451f66[_0x215fe4(0x21a)]||0xa;return console[_0x215fe4(0x1b8)](_0x215fe4(0x1ef)+_0x35da7e+_0x215fe4(0x2b6)+_0x476a20+':\x20'+_0x7e91e3+'%'),_0x7e91e3;}}return console[_0x215fe4(0x1b8)](_0x215fe4(0x2f4)+_0x35da7e+_0x215fe4(0x25b)+_0x476a20+',\x20using\x20default\x2010%'),0xa;}catch(_0x53f18a){return console[_0x215fe4(0x1f4)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x476a20+_0x215fe4(0x1da)+_0x35da7e+':',_0x53f18a),0xa;}}async[a69_0x581154(0x24a)](_0x4144c0,_0x3067c6){const _0x4c8512=a69_0x581154;console[_0x4c8512(0x1b8)]('🔄\x20Processing\x20MyXSpend\x20webhook:'),console[_0x4c8512(0x1b8)](_0x4c8512(0x27a),JSON[_0x4c8512(0x1fe)](_0x4144c0,null,0x2)),console[_0x4c8512(0x1b8)]('Body\x20data:',JSON[_0x4c8512(0x1fe)](_0x3067c6,null,0x2));try{const _0x53cf24=_0x4144c0[_0x4c8512(0x1f8)]||_0x3067c6['customerOrderId'],_0xd2b73c=_0x4144c0[_0x4c8512(0x2a8)]||_0x3067c6[_0x4c8512(0x2a8)],_0x17d207=_0x4144c0['amount']||_0x3067c6[_0x4c8512(0x252)],_0xd6891f=_0x4144c0['currency']||_0x3067c6[_0x4c8512(0x241)],_0x1bf812=_0x4144c0[_0x4c8512(0x220)]||_0x3067c6[_0x4c8512(0x220)];if(!_0x53cf24){console[_0x4c8512(0x1f4)](_0x4c8512(0x202));throw new Error(_0x4c8512(0x26a));}console[_0x4c8512(0x1b8)]('📊\x20MyXSpend\x20webhook\x20data:',{'customerOrderId':_0x53cf24,'status':_0xd2b73c,'amount':_0x17d207,'currency':_0xd6891f,'dateTime':_0x1bf812});const _0x4d32b4=await database_1['default'][_0x4c8512(0x2d4)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x53cf24},{'orderId':_0x53cf24},{'id':_0x53cf24},{'gatewayPaymentId':_0x53cf24}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x4d32b4){console[_0x4c8512(0x1f4)](_0x4c8512(0x284)+_0x53cf24);throw new Error(_0x4c8512(0x2c8)+_0x53cf24);}console[_0x4c8512(0x1b8)](_0x4c8512(0x264)+_0x4d32b4['id']+'\x20for\x20MyXSpend\x20webhook'),console[_0x4c8512(0x1b8)](_0x4c8512(0x242)+_0x4d32b4[_0x4c8512(0x2a8)]+_0x4c8512(0x277)+_0xd2b73c);let _0x2bf21d=_0xd2b73c?.['toUpperCase']();_0xd2b73c===_0x4c8512(0x2ad)||_0xd2b73c===_0x4c8512(0x2d3)?(_0x2bf21d=_0x4c8512(0x2ad),console[_0x4c8512(0x1b8)](_0x4c8512(0x2c9)+_0xd2b73c+_0x4c8512(0x1e3)),await this['updatePaymentStatus'](_0x4d32b4['id'],_0x2bf21d),console[_0x4c8512(0x1b8)](_0x4c8512(0x23a)+_0x4d32b4['id']+'\x20status\x20updated\x20to\x20FAILED')):console['log'](_0x4c8512(0x259)+_0xd2b73c+'\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)'),await database_1[_0x4c8512(0x250)][_0x4c8512(0x212)]['create']({'data':{'paymentId':_0x4d32b4['id'],'shopId':_0x4d32b4[_0x4c8512(0x2cd)],'event':'myxspend_'+(_0xd2b73c?.[_0x4c8512(0x1d9)]()||_0x4c8512(0x2fa)),'statusCode':0xc8,'responseBody':JSON[_0x4c8512(0x1fe)]({'queryParams':_0x4144c0,'bodyData':_0x3067c6})}}),loggerService_1[_0x4c8512(0x2bb)][_0x4c8512(0x1dd)](_0x4c8512(0x1fb),_0x4d32b4['id'],_0x4d32b4[_0x4c8512(0x2a8)],_0x2bf21d||_0xd2b73c,{'queryParams':_0x4144c0,'bodyData':_0x3067c6});}catch(_0x25665c){console[_0x4c8512(0x1f4)](_0x4c8512(0x2ef),_0x25665c),loggerService_1['loggerService']['logWebhookError'](_0x4c8512(0x1fb),_0x25665c,{'queryParams':_0x4144c0,'bodyData':_0x3067c6});throw _0x25665c;}}}exports[a69_0x581154(0x23f)]=WebhookService;