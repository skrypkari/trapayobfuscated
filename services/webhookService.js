'use strict';const a62_0x46368f=a62_0x3dbd;(function(_0x30adb1,_0x1b629b){const _0x32904a=a62_0x3dbd,_0xdb924=_0x30adb1();while(!![]){try{const _0x422255=-parseInt(_0x32904a(0x25f))/0x1+-parseInt(_0x32904a(0x2ad))/0x2+-parseInt(_0x32904a(0x2b2))/0x3+parseInt(_0x32904a(0x2cd))/0x4*(-parseInt(_0x32904a(0x1f7))/0x5)+-parseInt(_0x32904a(0x2b6))/0x6+parseInt(_0x32904a(0x261))/0x7*(-parseInt(_0x32904a(0x299))/0x8)+parseInt(_0x32904a(0x297))/0x9;if(_0x422255===_0x1b629b)break;else _0xdb924['push'](_0xdb924['shift']());}catch(_0x2f8df2){_0xdb924['push'](_0xdb924['shift']());}}}(a62_0x11ee,0xaed88));var __importDefault=this&&this['__importDefault']||function(_0x1ec342){return _0x1ec342&&_0x1ec342['__esModule']?_0x1ec342:{'default':_0x1ec342};};Object['defineProperty'](exports,a62_0x46368f(0x244),{'value':!![]}),exports[a62_0x46368f(0x2a6)]=void 0x0;const database_1=__importDefault(require(a62_0x46368f(0x2db))),plisioService_1=require(a62_0x46368f(0x2cf)),rapydService_1=require(a62_0x46368f(0x230)),nodaService_1=require(a62_0x46368f(0x2af)),coinToPayService_1=require(a62_0x46368f(0x25c)),coinToPay2Service_1=require(a62_0x46368f(0x234)),klymeService_1=require(a62_0x46368f(0x1f4)),mastercardService_1=require(a62_0x46368f(0x26e)),amerService_1=require(a62_0x46368f(0x2be)),ampayService_1=require(a62_0x46368f(0x2d3)),telegramBotService_1=require(a62_0x46368f(0x236)),currencyService_1=require(a62_0x46368f(0x285)),loggerService_1=require('./loggerService');function a62_0x3dbd(_0x1a30d4,_0x217925){const _0x11eef3=a62_0x11ee();return a62_0x3dbd=function(_0x3dbddd,_0x269c16){_0x3dbddd=_0x3dbddd-0x1e8;let _0x422f2d=_0x11eef3[_0x3dbddd];return _0x422f2d;},a62_0x3dbd(_0x1a30d4,_0x217925);}function a62_0x11ee(){const _0x40b0c6=['Payment\x20not\x20found','customerName','Webhook\x20event\x20','✅\x20Found\x20payment\x20','paid','settings','remitterName','FAILED','💰\x20Payment\x20','processing','rapyd','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','processPlisioGatewayWebhook','coinToPayService',',\x20Card=****','amountAfterGatewayCommissionUSDT','shopId','includes','📊\x20CoinToPay\x20webhook:\x20Payment\x20','COMPLETED','🔄\x20Processing\x20AmPay\x20webhook:','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','./currencyService','status','paymentId','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','TesSoft\x20Payment\x20System/1.0','AmPayService','SINGLE','bankId','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','webhookUrl','processNodaWebhook','📊\x20VISA\x20webhook\x20result:','webhook_send','🏪\x20Shop\x20','klyme','RapydService','updatedAt','sendShopWebhook','59664384ScBcAi','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','2536GqPBjU','ms)','payment','remitterIban','📊\x20Plisio\x20webhook:\x20Payment\x20','ampayService','mastercard','📊\x20AmPay\x20webhook\x20result:','No\x20payment\x20ID\x20in\x20VISA\x20webhook','🔍\x20Found\x20VISA\x20payment:\x20ID=','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','orderId','length','WebhookService','loggerService','parse','🔍\x20Search\x20result:\x20','amount','chargeback','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','1820328OUHONJ','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','./gateways/nodaService','POST','text','340431REYCmZ','gatewaySettings','VisaMasterCardService','\x20(Status:\x20','6826356PlUcIi','🔄\x20updatePaymentStatus\x20called:\x20paymentId=',':\x20type=','webhook_status_change_','plisio','additionalInfo','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','nodaService','./gateways/amerService','paymentLink','🔄\x20Processing\x20VISA\x20webhook:','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','processWebhook','📊\x20VISA\x20payment\x20found:\x20','sendPaymentStatusNotification','📊\x20Amer\x20webhook\x20result:','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','entries','Failed\x20to\x20send\x20shop\x20webhook:','Payment\x20not\x20found:\x20','visa_','📈\x20Found\x20payment\x20link\x20','16jeqcxK','Error\x20processing\x20CoinToPay2\x20webhook:','./gateways/plisioService','system','❌\x20Error\x20processing\x20Amer\x20webhook:','telegramBotService','./gateways/ampayService','🔄\x20Processing\x20CoinToPay2\x20webhook:','isArray','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','balance','\x20-\x20','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','⚠️\x20AMPAY\x20WEBHOOKS\x20TEMPORARILY\x20DISABLED\x20-\x20No\x20status\x20updates\x20will\x20be\x20performed','../config/database','No\x20payment\x20ID\x20in\x20Noda\x20webhook','convertToUSDT','🔍\x20VISA\x20payment\x20search\x20result:\x20','getGatewayCommission','error','💰\x20Final\x20balance\x20after\x20chargeback:\x20','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','❌\x20Error\x20processing\x20AmPay\x20webhook:','type','❌\x20Payment\x20link\x20','\x20=\x20','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','\x20updated:\x20currentPayments=','🔄\x20Processing\x20Noda\x20webhook:','CoinToPay2Service','toFixed','amountUSDT','toUpperCase','📊\x20MasterCard\x20webhook\x20result:','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','logWebhookError','Error\x20processing\x20Noda\x20webhook:','Gateway\x20','stringify','\x20and\x20-','\x20current\x20balance:\x20','paidAt','processCoinToPay2Webhook','Success','❌\x20Available\x20webhook\x20fields:','🔄\x20Processing\x20Amer\x20webhook:','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','./gateways/klymeService','Found','update','1380595sagrQw','❌\x20Error\x20processing\x20MasterCard\x20webhook:','desc','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20',',\x20using\x20default\x2010%','📊\x20AmPay\x20webhook:\x20Payment\x20','unknown','payment.failed','visa','default','currency','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','processRapydWebhook','$transaction','\x20status\x20','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20AmPay\x20webhook\x20data','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','\x22,\x20newStatus=\x22',',\x20using\x20default\x20commission\x2010%','💰\x20Amount\x20after\x20gateway\x20commission:\x20','MasterCard\x20payment\x20not\x20found:\x20','amer','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','Found\x20payment\x20','plisioService','plisio_gateway','\x20not\x20enabled\x20for\x20shop\x20','expired','paymentMethod','processCoinToPayWebhook','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','currentPayments','visa/mastercard','\x20USDT','🔄\x20Additional\x20data:','PAID','KlymeService','amerService','No\x20payment\x20ID\x20in\x20AmPay\x20webhook','payment.success','visa_mastercard','\x20commission\x20for\x20shop\x20','Error\x20processing\x20Plisio\x20webhook:','Error\x20processing\x20CoinToPay\x20webhook:','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','keys','logWebhookProcessed','application/json','ampay','🔍\x20AmPay\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','klymeService','📝\x20Reason:\x20','processAmPayWebhook',',\x20Status=','cardLast4','updatePaymentStatus','📊\x20Amer\x20webhook:\x20Payment\x20','./gateways/rapydService','⚠️\x20Status\x20update\x20SKIPPED\x20-\x20webhooks\x20temporarily\x20disabled','💰\x20Converting\x20','VISA\x20payment\x20not\x20found:\x20','./gateways/coinToPay2Service','📈\x20Payment\x20','./telegramBotService','visa_webhook','created','paymentLinkId','chargebackAmount','\x20commission:\x20','findFirst',',\x20status=','📤\x20Shop\x20webhook\x20sent\x20to\x20','cointopay','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','🔄\x20Processing\x20Plisio\x20webhook:','username','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','__esModule','failed','Error\x20processing\x20Rapyd\x20webhook:','failureMessage','txUrls','webhookEvents','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','EXPIRED','rapydService','findUnique','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','processMasterCardWebhook','visaMasterCardService','refund','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','\x20→\x20','toLowerCase','gateway',',\x20Gateway=','\x20->\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','\x20not\x20found','commission',',\x20gateway\x20','./gateways/coinToPayService','coinToPay2Service','🔄\x20Processing\x20Rapyd\x20webhook:','1348616stWBRE','cointopay2','28679rWeNYY','currencyService','shop','📈\x20Payment\x20details:\x20oldStatus=\x22','Error\x20parsing\x20webhook\x20events:','processVisaWebhook','Not\x20found','💰\x20Removing\x20from\x20balance:\x20','\x22,\x20orderId=\x22','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','noda','log','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','./gateways/mastercardService'];a62_0x11ee=function(){return _0x40b0c6;};return a62_0x11ee();}class WebhookService{constructor(){const _0x1f3fd3=a62_0x46368f;this[_0x1f3fd3(0x20f)]=new plisioService_1['PlisioService'](),this[_0x1f3fd3(0x24c)]=new rapydService_1[(_0x1f3fd3(0x294))](),this[_0x1f3fd3(0x2bd)]=new nodaService_1['NodaService'](),this[_0x1f3fd3(0x27c)]=new coinToPayService_1['CoinToPayService'](),this[_0x1f3fd3(0x25d)]=new coinToPay2Service_1[(_0x1f3fd3(0x2ea))](),this[_0x1f3fd3(0x229)]=new klymeService_1[(_0x1f3fd3(0x21b))](),this[_0x1f3fd3(0x250)]=new mastercardService_1[(_0x1f3fd3(0x2b4))](),this[_0x1f3fd3(0x21c)]=new amerService_1['AmerService'](),this[_0x1f3fd3(0x29e)]=new ampayService_1[(_0x1f3fd3(0x28a))]();}async[a62_0x46368f(0x22e)](_0x5d776e,_0x41ee96,_0x457ac9){const _0x5b6784=a62_0x46368f;console['log'](_0x5b6784(0x2b7)+_0x5d776e+',\x20newStatus='+_0x41ee96),console[_0x5b6784(0x26c)](_0x5b6784(0x219),_0x457ac9),await database_1[_0x5b6784(0x200)][_0x5b6784(0x204)](async _0x13ea28=>{const _0x3fcd8c=_0x5b6784,_0x3fdfe0=await _0x13ea28['payment'][_0x3fcd8c(0x24d)]({'where':{'id':_0x5d776e},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3fdfe0)throw new Error('Payment\x20'+_0x5d776e+'\x20not\x20found');const _0x233f29=_0x3fdfe0[_0x3fcd8c(0x286)],_0x2526cc=_0x3fdfe0[_0x3fcd8c(0x263)];console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x277)+_0x5d776e+':\x20'+_0x233f29+'\x20->\x20'+_0x41ee96),console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x292)+_0x2526cc[_0x3fcd8c(0x242)]+_0x3fcd8c(0x1ed)+_0x2526cc[_0x3fcd8c(0x2d7)]+_0x3fcd8c(0x218));const _0xdd3bf4={'status':_0x41ee96[_0x3fcd8c(0x2ed)](),'updatedAt':new Date(),'statusChangedBy':_0x3fcd8c(0x2d0),'statusChangedAt':new Date()};_0x457ac9?.[_0x3fcd8c(0x247)]&&(_0xdd3bf4[_0x3fcd8c(0x247)]=_0x457ac9[_0x3fcd8c(0x247)]);_0x457ac9?.[_0x3fcd8c(0x248)]&&(_0xdd3bf4[_0x3fcd8c(0x248)]=JSON['stringify'](_0x457ac9[_0x3fcd8c(0x248)]));_0x457ac9?.['cardLast4']&&(_0xdd3bf4[_0x3fcd8c(0x22d)]=_0x457ac9['cardLast4']);_0x457ac9?.[_0x3fcd8c(0x213)]&&(_0xdd3bf4[_0x3fcd8c(0x213)]=_0x457ac9[_0x3fcd8c(0x213)]);_0x457ac9?.['bankId']&&(_0xdd3bf4[_0x3fcd8c(0x28c)]=_0x457ac9['bankId']);_0x457ac9?.[_0x3fcd8c(0x29c)]&&(_0xdd3bf4[_0x3fcd8c(0x29c)]=_0x457ac9[_0x3fcd8c(0x29c)]);_0x457ac9?.[_0x3fcd8c(0x275)]&&(_0xdd3bf4[_0x3fcd8c(0x275)]=_0x457ac9['remitterName']);let _0x2fe288=_0x2526cc['balance'],_0x4dd4cb='';if(_0x41ee96['toUpperCase']()==='PAID'&&_0x233f29!==_0x3fcd8c(0x21a)){const _0x3e9d0c=await currencyService_1[_0x3fcd8c(0x262)][_0x3fcd8c(0x2dd)](_0x3fdfe0[_0x3fcd8c(0x2aa)],_0x3fdfe0['currency']),_0x3c626b=await this['getGatewayCommission'](_0x2526cc['id'],_0x3fdfe0[_0x3fcd8c(0x255)]),_0x448fd3=_0x3e9d0c*(0x1-_0x3c626b/0x64);_0x2fe288+=_0x448fd3,_0x4dd4cb='+'+_0x448fd3[_0x3fcd8c(0x2eb)](0x6)+_0x3fcd8c(0x2ae)+_0x3c626b+'%\x20gateway\x20commission)',_0xdd3bf4[_0x3fcd8c(0x2ec)]=_0x3e9d0c,_0xdd3bf4['amountAfterGatewayCommissionUSDT']=_0x448fd3,_0xdd3bf4[_0x3fcd8c(0x1ee)]=new Date(),console['log'](_0x3fcd8c(0x232)+_0x3fdfe0[_0x3fcd8c(0x2aa)]+'\x20'+_0x3fdfe0['currency']+_0x3fcd8c(0x257)+_0x3e9d0c[_0x3fcd8c(0x2eb)](0x6)+_0x3fcd8c(0x218)),console[_0x3fcd8c(0x26c)]('💰\x20Gateway\x20'+_0x3fdfe0[_0x3fcd8c(0x255)]+_0x3fcd8c(0x23b)+_0x3c626b+'%'),console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x20a)+_0x448fd3['toFixed'](0x6)+'\x20USDT'),console[_0x3fcd8c(0x26c)]('💰\x20Adding\x20to\x20balance:\x20'+_0x2526cc['balance']+'\x20+\x20'+_0x448fd3['toFixed'](0x6)+'\x20=\x20'+_0x2fe288[_0x3fcd8c(0x2eb)](0x6)+_0x3fcd8c(0x218));}else{if(_0x233f29===_0x3fcd8c(0x21a)&&_0x41ee96[_0x3fcd8c(0x2ed)]()!=='PAID'){let _0x53f2d7;if(_0x3fdfe0['amountAfterGatewayCommissionUSDT'])_0x53f2d7=_0x3fdfe0[_0x3fcd8c(0x27e)];else{if(_0x3fdfe0[_0x3fcd8c(0x2ec)]){const _0x580753=await this[_0x3fcd8c(0x2df)](_0x2526cc['id'],_0x3fdfe0[_0x3fcd8c(0x255)]);_0x53f2d7=_0x3fdfe0[_0x3fcd8c(0x2ec)]*(0x1-_0x580753/0x64);}else console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x2e2)),_0x53f2d7=0x0;}_0x53f2d7>0x0&&(_0x2fe288-=_0x53f2d7,_0x4dd4cb='-'+_0x53f2d7[_0x3fcd8c(0x2eb)](0x6)+_0x3fcd8c(0x20d),_0xdd3bf4[_0x3fcd8c(0x2ec)]=null,_0xdd3bf4[_0x3fcd8c(0x27e)]=null,_0xdd3bf4[_0x3fcd8c(0x1ee)]=null,console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x268)+_0x2526cc[_0x3fcd8c(0x2d7)]+_0x3fcd8c(0x2d8)+_0x53f2d7[_0x3fcd8c(0x2eb)](0x6)+_0x3fcd8c(0x2e6)+_0x2fe288[_0x3fcd8c(0x2eb)](0x6)+'\x20USDT'));}}if(_0x41ee96['toUpperCase']()==='CHARGEBACK'){const _0x1f7b0d=_0x457ac9?.[_0x3fcd8c(0x23a)]||0x0;_0x1f7b0d>0x0&&(_0x2fe288-=_0x1f7b0d,_0x4dd4cb+=_0x3fcd8c(0x1ec)+_0x1f7b0d[_0x3fcd8c(0x2eb)](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0xdd3bf4[_0x3fcd8c(0x23a)]=_0x1f7b0d,console[_0x3fcd8c(0x26c)]('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0x1f7b0d['toFixed'](0x6)+_0x3fcd8c(0x218)),console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x2e1)+_0x2fe288[_0x3fcd8c(0x2eb)](0x6)+_0x3fcd8c(0x218)));}const _0x35dc0a=await _0x13ea28[_0x3fcd8c(0x29b)][_0x3fcd8c(0x1f6)]({'where':{'id':_0x5d776e},'data':_0xdd3bf4});_0x2fe288!==_0x2526cc[_0x3fcd8c(0x2d7)]&&(await _0x13ea28['shop']['update']({'where':{'id':_0x2526cc['id']},'data':{'balance':_0x2fe288}}),console[_0x3fcd8c(0x26c)]('✅\x20Shop\x20'+_0x2526cc['username']+'\x20balance\x20updated:\x20'+_0x2526cc['balance'][_0x3fcd8c(0x2eb)](0x6)+_0x3fcd8c(0x257)+_0x2fe288[_0x3fcd8c(0x2eb)](0x6)+'\x20USDT'),console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x22a)+_0x4dd4cb));await _0x13ea28['webhookLog']['create']({'data':{'paymentId':_0x5d776e,'shopId':_0x2526cc['id'],'event':_0x3fcd8c(0x2b9)+_0x41ee96[_0x3fcd8c(0x254)](),'statusCode':0xc8,'responseBody':JSON[_0x3fcd8c(0x1eb)]({'oldStatus':_0x233f29,'newStatus':_0x41ee96[_0x3fcd8c(0x2ed)](),'balanceChange':_0x4dd4cb||'no\x20balance\x20change','oldBalance':_0x2526cc['balance'],'newBalance':_0x2fe288,'amountUSDT':_0xdd3bf4[_0x3fcd8c(0x2ec)],'additionalData':_0x457ac9,'timestamp':new Date()['toISOString']()})}}),await this[_0x3fcd8c(0x296)]({..._0x3fdfe0,..._0x35dc0a,'shop':_0x2526cc},_0x41ee96['toUpperCase']()),await this['sendPaymentStatusNotification']({..._0x3fdfe0,..._0x35dc0a},_0x41ee96[_0x3fcd8c(0x2ed)]());if(_0x233f29!==_0x3fcd8c(0x21a)&&_0x41ee96[_0x3fcd8c(0x2ed)]()===_0x3fcd8c(0x21a)){console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x235)+_0x5d776e+_0x3fcd8c(0x27a)),console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x264)+_0x233f29+_0x3fcd8c(0x208)+_0x41ee96['toUpperCase']()+'\x22,\x20paymentLinkId=\x22'+_0x3fdfe0[_0x3fcd8c(0x239)]+'\x22');if(_0x3fdfe0[_0x3fcd8c(0x239)])try{const _0x25c103=await _0x13ea28[_0x3fcd8c(0x2bf)][_0x3fcd8c(0x24d)]({'where':{'id':_0x3fdfe0[_0x3fcd8c(0x239)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x25c103){console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x2cc)+_0x25c103['id']+_0x3fcd8c(0x2b8)+_0x25c103[_0x3fcd8c(0x2e4)]+',\x20currentPayments='+_0x25c103[_0x3fcd8c(0x216)]+_0x3fcd8c(0x23d)+_0x25c103[_0x3fcd8c(0x286)]);const _0x4d3d44=_0x25c103['currentPayments']+0x1,_0x580c59=_0x25c103[_0x3fcd8c(0x2e4)]===_0x3fcd8c(0x28b)?_0x3fcd8c(0x282):_0x25c103['status'];await _0x13ea28[_0x3fcd8c(0x2bf)]['update']({'where':{'id':_0x3fdfe0[_0x3fcd8c(0x239)]},'data':{'currentPayments':_0x4d3d44,'status':_0x580c59,'updatedAt':new Date()}}),console[_0x3fcd8c(0x26c)]('✅\x20Payment\x20link\x20'+_0x25c103['id']+_0x3fcd8c(0x2e8)+_0x25c103[_0x3fcd8c(0x216)]+_0x3fcd8c(0x257)+_0x4d3d44+_0x3fcd8c(0x23d)+_0x25c103['status']+'\x20->\x20'+_0x580c59);}else console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x2e5)+_0x3fdfe0[_0x3fcd8c(0x239)]+_0x3fcd8c(0x259));}catch(_0x503f8c){console['error'](_0x3fcd8c(0x284),_0x503f8c);}else console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x235)+_0x5d776e+_0x3fcd8c(0x298));}else console[_0x3fcd8c(0x26c)](_0x3fcd8c(0x235)+_0x5d776e+_0x3fcd8c(0x243)+_0x233f29+_0x3fcd8c(0x257)+_0x41ee96['toUpperCase']());});}async['processPlisioWebhook'](_0x5abbf9){const _0x31a3db=a62_0x46368f;console[_0x31a3db(0x26c)](_0x31a3db(0x241),_0x5abbf9);try{const _0x18129c=await this[_0x31a3db(0x20f)][_0x31a3db(0x2c2)](_0x5abbf9);if(!_0x18129c['paymentId'])throw new Error(_0x31a3db(0x2c6));const _0x2a815d=await database_1[_0x31a3db(0x200)][_0x31a3db(0x29b)][_0x31a3db(0x23c)]({'where':{'gatewayOrderId':_0x18129c['paymentId']}});if(!_0x2a815d){console[_0x31a3db(0x2e0)]('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x18129c['paymentId']);return;}console[_0x31a3db(0x26c)](_0x31a3db(0x29d)+_0x2a815d['id']+'\x20status\x20'+_0x18129c[_0x31a3db(0x286)]),await this[_0x31a3db(0x22e)](_0x2a815d['id'],_0x18129c[_0x31a3db(0x286)],{'txUrls':_0x18129c['txUrls']}),loggerService_1['loggerService'][_0x31a3db(0x225)](_0x31a3db(0x2ba),_0x2a815d['id'],_0x2a815d[_0x31a3db(0x286)],_0x18129c[_0x31a3db(0x286)],_0x5abbf9);}catch(_0x3a33fd){console[_0x31a3db(0x2e0)](_0x31a3db(0x221),_0x3a33fd),loggerService_1[_0x31a3db(0x2a7)]['logWebhookError'](_0x31a3db(0x2ba),_0x3a33fd,_0x5abbf9);throw _0x3a33fd;}}async[a62_0x46368f(0x27b)](_0x5e2d0b){const _0x399184=a62_0x46368f;console[_0x399184(0x26c)]('🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:',_0x5e2d0b);try{const _0x1fa944=await this['plisioService'][_0x399184(0x2c2)](_0x5e2d0b);if(!_0x1fa944['paymentId'])throw new Error(_0x399184(0x2c1));const _0x3f641f=await database_1[_0x399184(0x200)][_0x399184(0x29b)]['findFirst']({'where':{'gatewayOrderId':_0x1fa944[_0x399184(0x287)]}});if(!_0x3f641f){console['error'](_0x399184(0x2d9)+_0x1fa944['paymentId']);return;}console[_0x399184(0x26c)](_0x399184(0x2ef)+_0x3f641f['id']+_0x399184(0x205)+_0x1fa944[_0x399184(0x286)]),await this[_0x399184(0x22e)](_0x3f641f['id'],_0x1fa944[_0x399184(0x286)],{'txUrls':_0x1fa944[_0x399184(0x248)]}),loggerService_1[_0x399184(0x2a7)][_0x399184(0x225)](_0x399184(0x210),_0x3f641f['id'],_0x3f641f[_0x399184(0x286)],_0x1fa944['status'],_0x5e2d0b);}catch(_0x2442bc){console[_0x399184(0x2e0)](_0x399184(0x2a3),_0x2442bc),loggerService_1[_0x399184(0x2a7)][_0x399184(0x1e8)](_0x399184(0x210),_0x2442bc,_0x5e2d0b);throw _0x2442bc;}}async[a62_0x46368f(0x203)](_0x43dda8){const _0x359f17=a62_0x46368f;console['log'](_0x359f17(0x25e),_0x43dda8);try{const _0x1ffd14=await this[_0x359f17(0x24c)][_0x359f17(0x2c2)](_0x43dda8);if(!_0x1ffd14[_0x359f17(0x287)])throw new Error(_0x359f17(0x26a));const _0x26a49c=await database_1[_0x359f17(0x200)][_0x359f17(0x29b)][_0x359f17(0x23c)]({'where':{'gatewayOrderId':_0x1ffd14['paymentId']}});if(!_0x26a49c){console[_0x359f17(0x2e0)](_0x359f17(0x240)+_0x1ffd14['paymentId']);return;}console[_0x359f17(0x26c)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x26a49c['id']+_0x359f17(0x205)+_0x1ffd14[_0x359f17(0x286)]),await this['updatePaymentStatus'](_0x26a49c['id'],_0x1ffd14['status'],{'failureMessage':_0x1ffd14[_0x359f17(0x247)],'cardLast4':_0x1ffd14['additionalInfo']?.[_0x359f17(0x22d)],'paymentMethod':_0x1ffd14[_0x359f17(0x2bb)]?.[_0x359f17(0x213)]}),loggerService_1['loggerService'][_0x359f17(0x225)](_0x359f17(0x279),_0x26a49c['id'],_0x26a49c[_0x359f17(0x286)],_0x1ffd14[_0x359f17(0x286)],_0x43dda8);}catch(_0x44a3a4){console[_0x359f17(0x2e0)](_0x359f17(0x246),_0x44a3a4),loggerService_1[_0x359f17(0x2a7)][_0x359f17(0x1e8)]('rapyd',_0x44a3a4,_0x43dda8);throw _0x44a3a4;}}async[a62_0x46368f(0x28f)](_0x218ab8){const _0x192f5d=a62_0x46368f;console[_0x192f5d(0x26c)](_0x192f5d(0x2e9),_0x218ab8);try{const _0x142b83=await this[_0x192f5d(0x2bd)][_0x192f5d(0x2c2)](_0x218ab8);if(!_0x142b83[_0x192f5d(0x287)])throw new Error(_0x192f5d(0x2dc));const _0x37525a=await database_1[_0x192f5d(0x200)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x142b83[_0x192f5d(0x287)]}});if(!_0x37525a){console[_0x192f5d(0x2e0)](_0x192f5d(0x24e)+_0x142b83['paymentId']);return;}console['log']('📊\x20Noda\x20webhook:\x20Payment\x20'+_0x37525a['id']+'\x20status\x20'+_0x142b83['status']),await this[_0x192f5d(0x22e)](_0x37525a['id'],_0x142b83[_0x192f5d(0x286)],{'bankId':_0x142b83[_0x192f5d(0x2bb)]?.['bankId'],'remitterIban':_0x142b83['additionalInfo']?.[_0x192f5d(0x29c)],'remitterName':_0x142b83[_0x192f5d(0x2bb)]?.[_0x192f5d(0x275)]}),loggerService_1[_0x192f5d(0x2a7)][_0x192f5d(0x225)]('noda',_0x37525a['id'],_0x37525a[_0x192f5d(0x286)],_0x142b83[_0x192f5d(0x286)],_0x218ab8);}catch(_0x493676){console[_0x192f5d(0x2e0)](_0x192f5d(0x1e9),_0x493676),loggerService_1[_0x192f5d(0x2a7)][_0x192f5d(0x1e8)](_0x192f5d(0x26b),_0x493676,_0x218ab8);throw _0x493676;}}async[a62_0x46368f(0x214)](_0x5e4c57){const _0x576536=a62_0x46368f;console[_0x576536(0x26c)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x5e4c57);try{const _0x38aa1c=await this[_0x576536(0x27c)][_0x576536(0x2c2)](_0x5e4c57);if(!_0x38aa1c[_0x576536(0x287)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x2a5d27=await database_1[_0x576536(0x200)][_0x576536(0x29b)][_0x576536(0x23c)]({'where':{'gatewayOrderId':_0x38aa1c[_0x576536(0x287)]}});if(!_0x2a5d27){console[_0x576536(0x2e0)](_0x576536(0x26d)+_0x38aa1c[_0x576536(0x287)]);return;}console['log'](_0x576536(0x281)+_0x2a5d27['id']+_0x576536(0x205)+_0x38aa1c['status']),await this[_0x576536(0x22e)](_0x2a5d27['id'],_0x38aa1c['status']),loggerService_1[_0x576536(0x2a7)][_0x576536(0x225)](_0x576536(0x23f),_0x2a5d27['id'],_0x2a5d27[_0x576536(0x286)],_0x38aa1c[_0x576536(0x286)],_0x5e4c57);}catch(_0x48e11f){console[_0x576536(0x2e0)](_0x576536(0x222),_0x48e11f),loggerService_1[_0x576536(0x2a7)]['logWebhookError'](_0x576536(0x23f),_0x48e11f,_0x5e4c57);throw _0x48e11f;}}async[a62_0x46368f(0x1ef)](_0xbbb8ef){const _0x830169=a62_0x46368f;console['log'](_0x830169(0x2d4),_0xbbb8ef);try{const _0x2bb063=await this['coinToPay2Service'][_0x830169(0x2c2)](_0xbbb8ef);if(!_0x2bb063[_0x830169(0x287)])throw new Error(_0x830169(0x258));const _0x28ed6f=await database_1[_0x830169(0x200)]['payment'][_0x830169(0x23c)]({'where':{'gatewayOrderId':_0x2bb063[_0x830169(0x287)]}});if(!_0x28ed6f){console['error']('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x2bb063[_0x830169(0x287)]);return;}console[_0x830169(0x26c)](_0x830169(0x2e7)+_0x28ed6f['id']+'\x20status\x20'+_0x2bb063['status']),await this[_0x830169(0x22e)](_0x28ed6f['id'],_0x2bb063[_0x830169(0x286)]),loggerService_1[_0x830169(0x2a7)]['logWebhookProcessed']('cointopay2',_0x28ed6f['id'],_0x28ed6f['status'],_0x2bb063[_0x830169(0x286)],_0xbbb8ef);}catch(_0x31b552){console[_0x830169(0x2e0)](_0x830169(0x2ce),_0x31b552),loggerService_1[_0x830169(0x2a7)][_0x830169(0x1e8)](_0x830169(0x260),_0x31b552,_0xbbb8ef);throw _0x31b552;}}async['processKlymeWebhook'](_0x459050){const _0x1ede2c=a62_0x46368f;console[_0x1ede2c(0x26c)]('🔄\x20Processing\x20KLYME\x20webhook:',_0x459050);try{const _0x46bfc0=await this[_0x1ede2c(0x229)][_0x1ede2c(0x2c2)](_0x459050);if(!_0x46bfc0[_0x1ede2c(0x287)])throw new Error(_0x1ede2c(0x202));const _0x4bf015=await database_1[_0x1ede2c(0x200)][_0x1ede2c(0x29b)]['findFirst']({'where':{'gatewayOrderId':_0x46bfc0[_0x1ede2c(0x287)]}});if(!_0x4bf015){console[_0x1ede2c(0x2e0)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x46bfc0[_0x1ede2c(0x287)]);return;}console['log']('📊\x20KLYME\x20webhook:\x20Payment\x20'+_0x4bf015['id']+_0x1ede2c(0x205)+_0x46bfc0['status']),await this[_0x1ede2c(0x22e)](_0x4bf015['id'],_0x46bfc0[_0x1ede2c(0x286)],{'paymentMethod':_0x46bfc0[_0x1ede2c(0x2bb)]?.['payment_method']}),loggerService_1['loggerService'][_0x1ede2c(0x225)](_0x1ede2c(0x293),_0x4bf015['id'],_0x4bf015[_0x1ede2c(0x286)],_0x46bfc0[_0x1ede2c(0x286)],_0x459050);}catch(_0x152a73){console[_0x1ede2c(0x2e0)]('Error\x20processing\x20KLYME\x20webhook:',_0x152a73),loggerService_1[_0x1ede2c(0x2a7)][_0x1ede2c(0x1e8)](_0x1ede2c(0x293),_0x152a73,_0x459050);throw _0x152a73;}}async[a62_0x46368f(0x266)](_0xc9a0a6){const _0x33606b=a62_0x46368f;console[_0x33606b(0x26c)](_0x33606b(0x2c0),JSON[_0x33606b(0x1eb)](_0xc9a0a6,null,0x2));try{const _0x3296b3=await this[_0x33606b(0x250)][_0x33606b(0x2c2)](_0xc9a0a6);console[_0x33606b(0x26c)](_0x33606b(0x290),_0x3296b3);if(!_0x3296b3['paymentId']){console[_0x33606b(0x2e0)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data'),console['error'](_0x33606b(0x1f1),Object[_0x33606b(0x224)](_0xc9a0a6));throw new Error(_0x33606b(0x2a1));}let _0x409482=null;console['log'](_0x33606b(0x1f3)+_0x3296b3[_0x33606b(0x287)]);_0x3296b3[_0x33606b(0x287)]&&(console[_0x33606b(0x26c)](_0x33606b(0x223)),_0x409482=await database_1[_0x33606b(0x200)]['payment'][_0x33606b(0x23c)]({'where':{'AND':[{'OR':[{'gateway':_0x33606b(0x217)},{'gateway':_0x33606b(0x29f)}]},{'OR':[{'gatewayPaymentId':_0x3296b3[_0x33606b(0x287)]},{'gatewayOrderId':_0x3296b3[_0x33606b(0x287)]},{'id':_0x3296b3['paymentId']},{'orderId':_0x3296b3[_0x33606b(0x287)]}]},{'cardLast4':{'startsWith':'4'}}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x33606b(0x26c)](_0x33606b(0x2de)+(_0x409482?_0x33606b(0x1f5):_0x33606b(0x267))),_0x409482&&console[_0x33606b(0x26c)](_0x33606b(0x2a2)+_0x409482['id']+_0x33606b(0x256)+_0x409482['gateway']+_0x33606b(0x22c)+_0x409482['status']+_0x33606b(0x27d)+_0x409482['cardLast4']));if(!_0x409482){console[_0x33606b(0x2e0)](_0x33606b(0x252)+_0x3296b3[_0x33606b(0x287)]),loggerService_1[_0x33606b(0x2a7)][_0x33606b(0x1e8)](_0x33606b(0x1ff),new Error(_0x33606b(0x2ca)+_0x3296b3[_0x33606b(0x287)]),_0xc9a0a6);throw new Error(_0x33606b(0x233)+_0x3296b3[_0x33606b(0x287)]);}console[_0x33606b(0x26c)](_0x33606b(0x2c3)+_0x409482['id']+_0x33606b(0x2b5)+_0x409482[_0x33606b(0x286)]+_0x33606b(0x253)+_0x3296b3[_0x33606b(0x286)]+')');const _0x371b6b={'status':_0x3296b3['status'][_0x33606b(0x2ed)](),'updatedAt':new Date(),'statusChangedBy':_0x33606b(0x237),'statusChangedAt':new Date()};_0x3296b3[_0x33606b(0x286)]==='PAID'&&(_0x371b6b['paidAt']=new Date());_0x3296b3[_0x33606b(0x2aa)]&&(_0x371b6b[_0x33606b(0x2aa)]=_0x3296b3[_0x33606b(0x2aa)]);_0x3296b3[_0x33606b(0x201)]&&(_0x371b6b[_0x33606b(0x201)]=_0x3296b3[_0x33606b(0x201)]);const _0x299c93={};_0x3296b3[_0x33606b(0x286)]===_0x33606b(0x276)&&_0x3296b3[_0x33606b(0x247)]&&(_0x299c93['failureMessage']=_0x3296b3['failureMessage'],console[_0x33606b(0x26c)](_0x33606b(0x215)+_0x3296b3[_0x33606b(0x247)])),await database_1['default'][_0x33606b(0x29b)][_0x33606b(0x1f6)]({'where':{'id':_0x409482['id']},'data':_0x371b6b}),Object[_0x33606b(0x224)](_0x299c93)[_0x33606b(0x2a5)]>0x0&&await this[_0x33606b(0x22e)](_0x409482['id'],_0x3296b3[_0x33606b(0x286)],_0x299c93),await database_1[_0x33606b(0x200)]['webhookLog']['create']({'data':{'paymentId':_0x409482['id'],'shopId':_0x409482['shopId'],'event':_0x33606b(0x2cb)+_0x3296b3[_0x33606b(0x286)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x33606b(0x1eb)](_0x3296b3)}}),await this['sendPaymentStatusNotification'](_0x409482,_0x3296b3[_0x33606b(0x286)][_0x33606b(0x2ed)]()),console[_0x33606b(0x26c)](_0x33606b(0x24a)+_0x409482['id']);}catch(_0x381214){console['error']('❌\x20VISA\x20webhook\x20processing\x20failed:',_0x381214),loggerService_1[_0x33606b(0x2a7)][_0x33606b(0x1e8)](_0x33606b(0x1ff),_0x381214,_0xc9a0a6);throw _0x381214;}}async[a62_0x46368f(0x24f)](_0x513095){const _0x409fe7=a62_0x46368f;console['log']('🔄\x20Processing\x20MasterCard\x20webhook:',JSON[_0x409fe7(0x1eb)](_0x513095,null,0x2));try{const _0x3ce4d0=await this[_0x409fe7(0x250)][_0x409fe7(0x2c2)](_0x513095);console['log'](_0x409fe7(0x2ee),_0x3ce4d0);if(!_0x3ce4d0[_0x409fe7(0x287)]){console[_0x409fe7(0x2e0)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data'),console[_0x409fe7(0x2e0)]('❌\x20Available\x20webhook\x20fields:',Object[_0x409fe7(0x224)](_0x513095));throw new Error(_0x409fe7(0x288));}let _0x2a7673=null;console[_0x409fe7(0x26c)]('🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x3ce4d0[_0x409fe7(0x287)]);_0x3ce4d0[_0x409fe7(0x287)]&&(console[_0x409fe7(0x26c)]('🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x2a7673=await database_1[_0x409fe7(0x200)][_0x409fe7(0x29b)][_0x409fe7(0x23c)]({'where':{'AND':[{'OR':[{'gateway':_0x409fe7(0x21f)},{'gateway':'mastercard'},{'gateway':_0x409fe7(0x217)}]},{'OR':[{'gatewayPaymentId':_0x3ce4d0[_0x409fe7(0x287)]},{'gatewayOrderId':_0x3ce4d0[_0x409fe7(0x287)]},{'id':_0x3ce4d0[_0x409fe7(0x287)]},{'orderId':_0x3ce4d0[_0x409fe7(0x287)]}]}]}}),console[_0x409fe7(0x26c)](_0x409fe7(0x2a9)+(_0x2a7673?_0x409fe7(0x20e)+_0x2a7673['id']:_0x409fe7(0x26f))));if(!_0x2a7673){console[_0x409fe7(0x2e0)](_0x409fe7(0x28d)+_0x3ce4d0[_0x409fe7(0x287)]),console['error']('🔍\x20Searched\x20by:\x20gatewayOrderId=\x22'+_0x3ce4d0['paymentId']+'\x22,\x20id=\x22'+_0x3ce4d0[_0x409fe7(0x287)]+_0x409fe7(0x269)+_0x3ce4d0[_0x409fe7(0x287)]+'\x22');const _0x39a2f5=await database_1[_0x409fe7(0x200)]['payment']['findMany']({'where':{'OR':[{'gateway':_0x409fe7(0x29f)},{'gateway':'visa_mastercard'},{'gateway':_0x409fe7(0x217)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x409fe7(0x1f9)},'take':0xf});console[_0x409fe7(0x26c)](_0x409fe7(0x2bc),_0x39a2f5),loggerService_1[_0x409fe7(0x2a7)]['logWebhookError'](_0x409fe7(0x29f),new Error(_0x409fe7(0x2ca)+_0x3ce4d0[_0x409fe7(0x287)]),_0x513095);throw new Error(_0x409fe7(0x20b)+_0x3ce4d0[_0x409fe7(0x287)]);}console[_0x409fe7(0x26c)](_0x409fe7(0x272)+_0x2a7673['id']+_0x409fe7(0x2c7)+_0x2a7673[_0x409fe7(0x286)]+'\x20to\x20'+_0x3ce4d0['status']);const _0x56b2a8={};_0x3ce4d0['status']===_0x409fe7(0x276)&&_0x3ce4d0[_0x409fe7(0x247)]&&(_0x56b2a8['failureMessage']=_0x3ce4d0[_0x409fe7(0x247)],console['log']('❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20'+_0x3ce4d0[_0x409fe7(0x247)])),await this[_0x409fe7(0x22e)](_0x2a7673['id'],_0x3ce4d0[_0x409fe7(0x286)],Object[_0x409fe7(0x224)](_0x56b2a8)[_0x409fe7(0x2a5)]>0x0?_0x56b2a8:undefined),loggerService_1['loggerService']['logWebhookProcessed'](_0x409fe7(0x29f),_0x2a7673['id'],_0x2a7673[_0x409fe7(0x286)],_0x3ce4d0[_0x409fe7(0x286)],_0x513095);}catch(_0x48bc7b){console[_0x409fe7(0x2e0)](_0x409fe7(0x1f8),_0x48bc7b),loggerService_1[_0x409fe7(0x2a7)][_0x409fe7(0x1e8)](_0x409fe7(0x29f),_0x48bc7b,_0x513095);throw _0x48bc7b;}}async['processAmerWebhook'](_0x221b7e){const _0x4bb1e5=a62_0x46368f;console[_0x4bb1e5(0x26c)](_0x4bb1e5(0x1f2),JSON[_0x4bb1e5(0x1eb)](_0x221b7e,null,0x2));try{const _0x524d74=await this[_0x4bb1e5(0x21c)]['processWebhook'](_0x221b7e);console[_0x4bb1e5(0x26c)](_0x4bb1e5(0x2c5),_0x524d74);if(!_0x524d74['paymentId']){console[_0x4bb1e5(0x2e0)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data'),console[_0x4bb1e5(0x2e0)](_0x4bb1e5(0x1f1),Object[_0x4bb1e5(0x224)](_0x221b7e));throw new Error('No\x20payment\x20ID\x20in\x20Amer\x20webhook');}let _0x4574e3=null;console['log']('🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x524d74['paymentId']),_0x4574e3=await database_1[_0x4bb1e5(0x200)]['payment'][_0x4bb1e5(0x23c)]({'where':{'AND':[{'gateway':'amer'},{'OR':[{'gatewayPaymentId':_0x524d74[_0x4bb1e5(0x287)]},{'gatewayOrderId':_0x524d74[_0x4bb1e5(0x287)]},{'id':_0x524d74[_0x4bb1e5(0x287)]},{'orderId':_0x524d74[_0x4bb1e5(0x287)]}]}]}}),console[_0x4bb1e5(0x26c)](_0x4bb1e5(0x2a9)+(_0x4574e3?'Found\x20payment\x20'+_0x4574e3['id']:_0x4bb1e5(0x26f)));if(!_0x4574e3){console[_0x4bb1e5(0x2e0)](_0x4bb1e5(0x207)+_0x524d74[_0x4bb1e5(0x287)]);return;}console[_0x4bb1e5(0x26c)](_0x4bb1e5(0x22f)+_0x4574e3['id']+'\x20status\x20'+_0x524d74[_0x4bb1e5(0x286)]),await this[_0x4bb1e5(0x22e)](_0x4574e3['id'],_0x524d74[_0x4bb1e5(0x286)],{'cardLast4':_0x524d74[_0x4bb1e5(0x2bb)]?.['cardLast4'],'paymentMethod':_0x524d74[_0x4bb1e5(0x2bb)]?.[_0x4bb1e5(0x213)]});}catch(_0x3ebf7f){console[_0x4bb1e5(0x2e0)](_0x4bb1e5(0x2d1),_0x3ebf7f),loggerService_1['loggerService'][_0x4bb1e5(0x1e8)](_0x4bb1e5(0x20c),_0x3ebf7f,_0x221b7e);throw _0x3ebf7f;}}async[a62_0x46368f(0x22b)](_0x319e33){const _0x5e78d4=a62_0x46368f;console['log'](_0x5e78d4(0x283),JSON['stringify'](_0x319e33,null,0x2)),console[_0x5e78d4(0x26c)](_0x5e78d4(0x2da));try{const _0x540b2=await this['ampayService']['processWebhook'](_0x319e33);console[_0x5e78d4(0x26c)](_0x5e78d4(0x2a0),_0x540b2);if(!_0x540b2[_0x5e78d4(0x287)]){console[_0x5e78d4(0x2e0)](_0x5e78d4(0x206)),console[_0x5e78d4(0x2e0)]('❌\x20Available\x20webhook\x20fields:',Object[_0x5e78d4(0x224)](_0x319e33));throw new Error(_0x5e78d4(0x21d));}let _0x40bc88=null;console[_0x5e78d4(0x26c)](_0x5e78d4(0x228)+_0x540b2['paymentId']),_0x40bc88=await database_1['default'][_0x5e78d4(0x29b)][_0x5e78d4(0x23c)]({'where':{'AND':[{'gateway':'ampay'},{'OR':[{'gatewayPaymentId':_0x540b2[_0x5e78d4(0x287)]},{'gatewayOrderId':_0x540b2['paymentId']},{'id':_0x540b2['paymentId']},{'orderId':_0x540b2[_0x5e78d4(0x287)]}]}]}}),console['log']('🔍\x20Search\x20result:\x20'+(_0x40bc88?_0x5e78d4(0x20e)+_0x40bc88['id']:'Payment\x20not\x20found'));if(!_0x40bc88){console[_0x5e78d4(0x2e0)]('❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20webhook\x20with\x20ID:\x20'+_0x540b2[_0x5e78d4(0x287)]);return;}console['log'](_0x5e78d4(0x1fc)+_0x40bc88['id']+'\x20status\x20'+_0x540b2[_0x5e78d4(0x286)]),console[_0x5e78d4(0x26c)](_0x5e78d4(0x231)),loggerService_1[_0x5e78d4(0x2a7)][_0x5e78d4(0x225)](_0x5e78d4(0x227),_0x40bc88['id'],_0x40bc88['status'],'DISABLED',_0x319e33);}catch(_0x540cf5){console[_0x5e78d4(0x2e0)](_0x5e78d4(0x2e3),_0x540cf5),loggerService_1['loggerService']['logWebhookError'](_0x5e78d4(0x227),_0x540cf5,_0x319e33);throw _0x540cf5;}}async[a62_0x46368f(0x296)](_0x9995a7,_0x5ba3c4){const _0x443643=a62_0x46368f,_0x1a0384=Date['now']();try{const _0x1a7f96=_0x9995a7[_0x443643(0x263)],_0x171bde=_0x1a7f96[_0x443643(0x274)];if(!_0x171bde?.[_0x443643(0x28e)]){console[_0x443643(0x26c)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1a7f96['id']);return;}const _0x12594b=_0x5ba3c4===_0x443643(0x21a)?_0x443643(0x21e):_0x5ba3c4===_0x443643(0x276)?_0x443643(0x1fe):_0x5ba3c4===_0x443643(0x24b)?_0x443643(0x1fe):_0x5ba3c4==='CHARGEBACK'?_0x443643(0x1fe):_0x5ba3c4==='REFUND'?_0x443643(0x1fe):'payment.pending';let _0xd807fd=[];if(_0x171bde[_0x443643(0x249)])try{_0xd807fd=Array[_0x443643(0x2d5)](_0x171bde['webhookEvents'])?_0x171bde[_0x443643(0x249)]:JSON['parse'](_0x171bde[_0x443643(0x249)]);}catch(_0x54a5ca){console[_0x443643(0x2e0)](_0x443643(0x265),_0x54a5ca),_0xd807fd=[];}if(!_0xd807fd[_0x443643(0x280)](_0x12594b)){console[_0x443643(0x26c)](_0x443643(0x271)+_0x12594b+_0x443643(0x211)+_0x1a7f96['id']);return;}const _0x3e4e9e={'event':_0x12594b,'payment':{'id':_0x9995a7['id'],'order_id':_0x9995a7[_0x443643(0x2a4)],'gateway_order_id':_0x9995a7['gatewayOrderId'],'gateway':_0x9995a7[_0x443643(0x255)],'amount':_0x9995a7[_0x443643(0x2aa)],'currency':_0x9995a7[_0x443643(0x201)],'status':_0x5ba3c4[_0x443643(0x254)](),'customer_email':_0x9995a7['customerEmail'],'customer_name':_0x9995a7[_0x443643(0x270)],'failure_message':_0x9995a7[_0x443643(0x247)],'tx_urls':_0x9995a7[_0x443643(0x248)]?JSON[_0x443643(0x2a8)](_0x9995a7[_0x443643(0x248)]):null,'created_at':_0x9995a7['createdAt'],'updated_at':_0x9995a7[_0x443643(0x295)]}},_0x577bd7=await fetch(_0x171bde['webhookUrl'],{'method':_0x443643(0x2b0),'headers':{'Content-Type':_0x443643(0x226),'User-Agent':_0x443643(0x289)},'body':JSON[_0x443643(0x1eb)](_0x3e4e9e)}),_0x317fa9=Date['now']()-_0x1a0384,_0x34c37b=_0x577bd7['ok']?_0x443643(0x1f0):await _0x577bd7[_0x443643(0x2b1)]();loggerService_1[_0x443643(0x2a7)]['logShopWebhookSent'](_0x9995a7[_0x443643(0x27f)],_0x171bde[_0x443643(0x28e)],_0x12594b,_0x577bd7[_0x443643(0x286)],_0x317fa9,_0x3e4e9e),console[_0x443643(0x26c)](_0x443643(0x23e)+_0x171bde['webhookUrl']+'\x20with\x20status\x20'+_0x577bd7[_0x443643(0x286)]+'\x20('+_0x317fa9+_0x443643(0x29a));}catch(_0x71bb5a){console['error'](_0x443643(0x2c9),_0x71bb5a),loggerService_1[_0x443643(0x2a7)]['logShopWebhookError'](_0x9995a7['shopId'],_0x9995a7[_0x443643(0x263)]?.[_0x443643(0x274)]?.[_0x443643(0x28e)]||_0x443643(0x1fd),_0x443643(0x291),_0x71bb5a,{});}}async[a62_0x46368f(0x2c4)](_0x44342d,_0x508437){const _0x51cced=a62_0x46368f;try{const _0x443588={'PENDING':_0x51cced(0x238),'PROCESSING':_0x51cced(0x278),'PAID':_0x51cced(0x273),'FAILED':_0x51cced(0x245),'EXPIRED':_0x51cced(0x212),'REFUND':_0x51cced(0x251),'CHARGEBACK':_0x51cced(0x2ab)},_0x56147b=_0x443588[_0x508437];if(!_0x56147b||_0x56147b===_0x51cced(0x238))return;await telegramBotService_1[_0x51cced(0x2d2)]['sendPaymentNotification'](_0x44342d[_0x51cced(0x27f)],_0x44342d,_0x56147b);}catch(_0x34febd){console[_0x51cced(0x2e0)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x34febd);}}async[a62_0x46368f(0x2df)](_0x1d46ce,_0x281d7b){const _0x1c1268=a62_0x46368f;try{const _0x570107=await database_1[_0x1c1268(0x200)][_0x1c1268(0x263)][_0x1c1268(0x24d)]({'where':{'id':_0x1d46ce},'select':{'gatewaySettings':!![]}});if(!_0x570107?.[_0x1c1268(0x2b3)])return console[_0x1c1268(0x26c)](_0x1c1268(0x2d6)+_0x1d46ce+_0x1c1268(0x209)),0xa;const _0xbb9cb5=JSON[_0x1c1268(0x2a8)](_0x570107[_0x1c1268(0x2b3)]);for(const [_0x3f3506,_0x335e52]of Object[_0x1c1268(0x2c8)](_0xbb9cb5)){if(_0x3f3506[_0x1c1268(0x254)]()===_0x281d7b['toLowerCase']()){const _0x2665d4=_0x335e52[_0x1c1268(0x25a)]||0xa;return console[_0x1c1268(0x26c)](_0x1c1268(0x1ea)+_0x281d7b+_0x1c1268(0x220)+_0x1d46ce+':\x20'+_0x2665d4+'%'),_0x2665d4;}}return console[_0x1c1268(0x26c)](_0x1c1268(0x2ac)+_0x281d7b+'\x20in\x20shop\x20'+_0x1d46ce+_0x1c1268(0x1fb)),0xa;}catch(_0x1e17ff){return console['error'](_0x1c1268(0x1fa)+_0x1d46ce+_0x1c1268(0x25b)+_0x281d7b+':',_0x1e17ff),0xa;}}}exports[a62_0x46368f(0x2a6)]=WebhookService;