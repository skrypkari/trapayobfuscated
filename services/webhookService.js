'use strict';function a52_0x95f7(){const _0x5631e3=['webhook_send','POST','text','noda','PENDING','407883lPDPyP','sendPaymentStatusNotification','1771641InxTpR','processRapydWebhook','klyme_','processWebhook','plisio','payment.failed','Error\x20parsing\x20tx_urls\x20for\x20webhook:','../config/database','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook','sendShopWebhook','gatewayOrderId','cardLast4','customerName','toLowerCase','Failed\x20to\x20send\x20shop\x20webhook:','now','Webhook\x20event\x20','createdAt','bankId','RapydService','log','PaymentLinkService','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','webhookUrl','stringify','No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','processKlymeWebhook','amount','parse','created','paidAt','./loggerService','logShopWebhookError','klyme','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','telegramBotService','\x20status\x20to\x20','__importDefault','currency','721564lndujf','logWebhookProcessed','length','ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20','webhookEvents','CoinToPayService','__esModule','\x20webhook','cointopay','\x20failure\x20message:\x20','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','Error\x20processing\x20Plisio\x20webhook:','paymentMethod','PlisioService','30430630chXEuR','\x20status\x20change:\x20','payment.pending','Success','\x20->\x20','findFirst','5770780dzSfKQ','rapydService','989866ePXdxX','\x20updated\x20successfully:\x20','isArray','\x20not\x20enabled\x20for\x20shop\x20','./gateways/nodaService','./gateways/coinToPayService','PAID','No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook','Error\x20processing\x20CoinToPay\x20webhook:','settings','additionalInfo','includes','ðŸ”„\x20Updating\x20payment\x20','unknown','application/json','30102TLdepK','ðŸ’¾\x20Saving\x20failure\x20message:\x20','processPlisioWebhook','Failed\x20to\x20update\x20payment\x20link\x20counter:','\x20with\x20status\x20','shop','nodaService','Processing\x20CoinToPay\x20webhook:','Error\x20processing\x20Noda\x20webhook:','remitterIban','\x20and\x20gateway:\x20','ðŸ’¾\x20Failure\x20message\x20saved:\x20','default','klymeService','shopId','FAILED','ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20','Processing\x20Plisio\x20webhook:','status','processCoinToPayWebhook','\x20from\x20','loggerService','\x20URLs','failureMessage','failed','remitterName','txUrls','Error\x20processing\x20Rapyd\x20webhook:','error','2xsbPQl','expired','TesSoft\x20Payment\x20System/1.0','./gateways/rapydService','webhookLog','Payment\x20','processNodaWebhook','No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook','rapyd','logWebhookError','defineProperty','coinToPayService','plisioService','updatePaymentStatus','9dQcADu','update','24yoqqQS','plisio_gateway','\x20transaction\x20URLs:','./telegramBotService','region','Error\x20processing\x20KLYME\x20webhook:','paymentId','WebhookService','EXPIRED','payment','payment.success','paid','paymentLinkService'];a52_0x95f7=function(){return _0x5631e3;};return a52_0x95f7();}const a52_0x2454b9=a52_0x1b7f;(function(_0x4513ee,_0x43f63e){const _0x58b144=a52_0x1b7f,_0x1c0a1a=_0x4513ee();while(!![]){try{const _0x1a2327=parseInt(_0x58b144(0x194))/0x1*(-parseInt(_0x58b144(0x168))/0x2)+-parseInt(_0x58b144(0x114))/0x3*(-parseInt(_0x58b144(0x152))/0x4)+-parseInt(_0x58b144(0x166))/0x5+parseInt(_0x58b144(0x177))/0x6+parseInt(_0x58b144(0x128))/0x7+-parseInt(_0x58b144(0x116))/0x8*(parseInt(_0x58b144(0x12a))/0x9)+parseInt(_0x58b144(0x160))/0xa;if(_0x1a2327===_0x43f63e)break;else _0x1c0a1a['push'](_0x1c0a1a['shift']());}catch(_0x3fc28a){_0x1c0a1a['push'](_0x1c0a1a['shift']());}}}(a52_0x95f7,0xdee39));var __importDefault=this&&this[a52_0x2454b9(0x150)]||function(_0x4e6efc){const _0x253c54=a52_0x2454b9;return _0x4e6efc&&_0x4e6efc[_0x253c54(0x158)]?_0x4e6efc:{'default':_0x4e6efc};};Object[a52_0x2454b9(0x110)](exports,a52_0x2454b9(0x158),{'value':!![]}),exports[a52_0x2454b9(0x11d)]=void 0x0;const database_1=__importDefault(require(a52_0x2454b9(0x131))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a52_0x2454b9(0x197)),nodaService_1=require(a52_0x2454b9(0x16c)),coinToPayService_1=require(a52_0x2454b9(0x16d)),klymeService_1=require('./gateways/klymeService'),telegramBotService_1=require(a52_0x2454b9(0x119)),paymentLinkService_1=require('./paymentLinkService'),loggerService_1=require(a52_0x2454b9(0x14a));function a52_0x1b7f(_0x25735b,_0x414b09){const _0x95f7f6=a52_0x95f7();return a52_0x1b7f=function(_0x1b7fa4,_0x43d6dd){_0x1b7fa4=_0x1b7fa4-0x10c;let _0x2ff539=_0x95f7f6[_0x1b7fa4];return _0x2ff539;},a52_0x1b7f(_0x25735b,_0x414b09);}class WebhookService{constructor(){const _0x27d586=a52_0x2454b9;this['plisioService']=new plisioService_1[(_0x27d586(0x15f))](),this['rapydService']=new rapydService_1[(_0x27d586(0x13d))](),this['nodaService']=new nodaService_1['NodaService'](),this[_0x27d586(0x111)]=new coinToPayService_1[(_0x27d586(0x157))](),this[_0x27d586(0x184)]=new klymeService_1['KlymeService'](),this['paymentLinkService']=new paymentLinkService_1[(_0x27d586(0x13f))]();}async[a52_0x2454b9(0x179)](_0x220a44){const _0x358445=a52_0x2454b9;console[_0x358445(0x13e)](_0x358445(0x188),_0x220a44);try{const _0x3acd40=await this['plisioService'][_0x358445(0x12d)](_0x220a44);if(!_0x3acd40['paymentId']){console[_0x358445(0x193)](_0x358445(0x10d));return;}await this[_0x358445(0x113)](_0x3acd40[_0x358445(0x11c)],_0x3acd40[_0x358445(0x189)],'plisio',_0x220a44,undefined,undefined,_0x3acd40[_0x358445(0x191)]),loggerService_1['loggerService'][_0x358445(0x153)](_0x358445(0x12e),_0x3acd40[_0x358445(0x11c)],_0x358445(0x127),_0x3acd40[_0x358445(0x189)],_0x220a44);}catch(_0x2cb1ba){console[_0x358445(0x193)](_0x358445(0x15d),_0x2cb1ba),loggerService_1[_0x358445(0x18c)]['logWebhookError'](_0x358445(0x12e),_0x2cb1ba,_0x220a44);throw _0x2cb1ba;}}async['processPlisioGatewayWebhook'](_0x19780e){const _0x51f68e=a52_0x2454b9;console[_0x51f68e(0x13e)]('Processing\x20Plisio\x20Gateway\x20webhook:',_0x19780e);try{const _0x1a03ae=await this[_0x51f68e(0x112)][_0x51f68e(0x12d)](_0x19780e);if(!_0x1a03ae['paymentId']){console[_0x51f68e(0x193)](_0x51f68e(0x132));return;}await this[_0x51f68e(0x113)](_0x1a03ae[_0x51f68e(0x11c)],_0x1a03ae[_0x51f68e(0x189)],_0x51f68e(0x12e),_0x19780e,undefined,undefined,_0x1a03ae[_0x51f68e(0x191)]),loggerService_1[_0x51f68e(0x18c)][_0x51f68e(0x153)](_0x51f68e(0x117),_0x1a03ae[_0x51f68e(0x11c)],_0x51f68e(0x127),_0x1a03ae[_0x51f68e(0x189)],_0x19780e);}catch(_0x12e758){console[_0x51f68e(0x193)](_0x51f68e(0x15c),_0x12e758),loggerService_1[_0x51f68e(0x18c)][_0x51f68e(0x10f)]('plisio_gateway',_0x12e758,_0x19780e);throw _0x12e758;}}async[a52_0x2454b9(0x12b)](_0x23d8ef){const _0x39c33d=a52_0x2454b9;console[_0x39c33d(0x13e)]('Processing\x20Rapyd\x20webhook:',_0x23d8ef);try{const _0x118f97=await this[_0x39c33d(0x167)][_0x39c33d(0x12d)](_0x23d8ef);if(!_0x118f97[_0x39c33d(0x11c)]){console[_0x39c33d(0x193)](_0x39c33d(0x143));return;}await this[_0x39c33d(0x113)](_0x118f97[_0x39c33d(0x11c)],_0x118f97['status'],'rapyd',_0x23d8ef,_0x118f97[_0x39c33d(0x18e)],_0x118f97['additionalInfo']),loggerService_1[_0x39c33d(0x18c)][_0x39c33d(0x153)](_0x39c33d(0x10e),_0x118f97[_0x39c33d(0x11c)],_0x39c33d(0x127),_0x118f97['status'],_0x23d8ef);}catch(_0x21ef15){console['error'](_0x39c33d(0x192),_0x21ef15),loggerService_1[_0x39c33d(0x18c)][_0x39c33d(0x10f)]('rapyd',_0x21ef15,_0x23d8ef);throw _0x21ef15;}}async[a52_0x2454b9(0x19a)](_0x75afa1){const _0x2cb2a5=a52_0x2454b9;console[_0x2cb2a5(0x13e)]('Processing\x20Noda\x20webhook:',_0x75afa1);try{const _0xee551f=await this[_0x2cb2a5(0x17d)][_0x2cb2a5(0x12d)](_0x75afa1);if(!_0xee551f[_0x2cb2a5(0x11c)]){console[_0x2cb2a5(0x193)]('No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook');return;}await this[_0x2cb2a5(0x113)](_0xee551f['paymentId'],_0xee551f['status'],_0x2cb2a5(0x126),_0x75afa1,undefined,_0xee551f['additionalInfo']),loggerService_1[_0x2cb2a5(0x18c)][_0x2cb2a5(0x153)]('noda',_0xee551f[_0x2cb2a5(0x11c)],'PENDING',_0xee551f[_0x2cb2a5(0x189)],_0x75afa1);}catch(_0x3cda00){console[_0x2cb2a5(0x193)](_0x2cb2a5(0x17f),_0x3cda00),loggerService_1[_0x2cb2a5(0x18c)][_0x2cb2a5(0x10f)](_0x2cb2a5(0x126),_0x3cda00,_0x75afa1);throw _0x3cda00;}}async[a52_0x2454b9(0x18a)](_0x26c380){const _0x26e829=a52_0x2454b9;console[_0x26e829(0x13e)](_0x26e829(0x17e),_0x26c380);try{const _0x41b900=await this['coinToPayService'][_0x26e829(0x12d)](_0x26c380);if(!_0x41b900['paymentId']){console['error'](_0x26e829(0x10c));return;}await this[_0x26e829(0x113)](_0x41b900[_0x26e829(0x11c)],_0x41b900[_0x26e829(0x189)],'cointopay',_0x26c380),loggerService_1[_0x26e829(0x18c)]['logWebhookProcessed'](_0x26e829(0x15a),_0x41b900[_0x26e829(0x11c)],_0x26e829(0x127),_0x41b900['status'],_0x26c380);}catch(_0x568354){console['error'](_0x26e829(0x170),_0x568354),loggerService_1[_0x26e829(0x18c)][_0x26e829(0x10f)](_0x26e829(0x15a),_0x568354,_0x26c380);throw _0x568354;}}async[a52_0x2454b9(0x145)](_0x213b9e){const _0x16db83=a52_0x2454b9;console[_0x16db83(0x13e)]('Processing\x20KLYME\x20webhook:',_0x213b9e);try{const _0x1e28cc=await this[_0x16db83(0x184)][_0x16db83(0x12d)](_0x213b9e);if(!_0x1e28cc['paymentId']){console[_0x16db83(0x193)](_0x16db83(0x16f));return;}const _0xe95c53=_0x1e28cc[_0x16db83(0x11a)]?_0x16db83(0x12c)+_0x1e28cc[_0x16db83(0x11a)][_0x16db83(0x137)]():'klyme_eu';await this[_0x16db83(0x113)](_0x1e28cc[_0x16db83(0x11c)],_0x1e28cc[_0x16db83(0x189)],_0xe95c53,_0x213b9e,undefined,_0x1e28cc[_0x16db83(0x172)]),loggerService_1[_0x16db83(0x18c)][_0x16db83(0x153)](_0x16db83(0x14c),_0x1e28cc['paymentId'],_0x16db83(0x127),_0x1e28cc[_0x16db83(0x189)],_0x213b9e);}catch(_0x35d7fa){console[_0x16db83(0x193)](_0x16db83(0x11b),_0x35d7fa),loggerService_1[_0x16db83(0x18c)][_0x16db83(0x10f)](_0x16db83(0x14c),_0x35d7fa,_0x213b9e);throw _0x35d7fa;}}async[a52_0x2454b9(0x113)](_0x3666f7,_0x3a131d,_0x2a113a,_0x168fbf,_0x103ed6,_0x52b836,_0x99fda1){const _0x2c8509=a52_0x2454b9;console[_0x2c8509(0x13e)](_0x2c8509(0x174)+_0x3666f7+_0x2c8509(0x14f)+_0x3a131d+_0x2c8509(0x18b)+_0x2a113a+_0x2c8509(0x159));_0x103ed6&&console[_0x2c8509(0x13e)]('ðŸ’¥\x20Payment\x20'+_0x3666f7+_0x2c8509(0x15b)+_0x103ed6);_0x99fda1&&_0x99fda1['length']>0x0&&console['log']('ðŸ”—\x20Payment\x20'+_0x3666f7+_0x2c8509(0x118),_0x99fda1);const _0x550def=await database_1[_0x2c8509(0x183)][_0x2c8509(0x11f)][_0x2c8509(0x165)]({'where':{'gatewayOrderId':_0x3666f7,'gateway':_0x2a113a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x550def){console[_0x2c8509(0x193)](_0x2c8509(0x140)+_0x3666f7+_0x2c8509(0x181)+_0x2a113a);return;}const _0x3aa5be=_0x550def['status'];if(_0x3aa5be===_0x3a131d){console[_0x2c8509(0x13e)](_0x2c8509(0x199)+_0x550def['id']+'\x20status\x20unchanged\x20('+_0x3a131d+')');return;}console['log'](_0x2c8509(0x199)+_0x550def['id']+_0x2c8509(0x161)+_0x3aa5be+_0x2c8509(0x164)+_0x3a131d);const _0x40612b={'status':_0x3a131d,'updatedAt':new Date()};_0x103ed6&&(_0x40612b['failureMessage']=_0x103ed6,console['log'](_0x2c8509(0x178)+_0x103ed6));_0x99fda1&&_0x99fda1['length']>0x0&&(_0x40612b[_0x2c8509(0x191)]=JSON['stringify'](_0x99fda1),console[_0x2c8509(0x13e)](_0x2c8509(0x155)+JSON[_0x2c8509(0x142)](_0x99fda1)));_0x3a131d===_0x2c8509(0x16e)&&_0x3aa5be!==_0x2c8509(0x16e)&&(_0x40612b[_0x2c8509(0x149)]=new Date());_0x52b836&&(_0x52b836[_0x2c8509(0x135)]&&(_0x40612b[_0x2c8509(0x135)]=_0x52b836[_0x2c8509(0x135)]),_0x52b836['paymentMethod']&&(_0x40612b[_0x2c8509(0x15e)]=_0x52b836['paymentMethod']),_0x52b836[_0x2c8509(0x13c)]&&(_0x40612b['bankId']=_0x52b836[_0x2c8509(0x13c)]),_0x52b836[_0x2c8509(0x180)]&&(_0x40612b[_0x2c8509(0x180)]=_0x52b836['remitterIban']),_0x52b836[_0x2c8509(0x190)]&&(_0x40612b[_0x2c8509(0x190)]=_0x52b836[_0x2c8509(0x190)]));await database_1[_0x2c8509(0x183)][_0x2c8509(0x11f)][_0x2c8509(0x115)]({'where':{'id':_0x550def['id']},'data':_0x40612b});if(_0x3a131d===_0x2c8509(0x16e)&&_0x3aa5be!==_0x2c8509(0x16e))try{await this[_0x2c8509(0x122)]['handleSuccessfulPayment'](_0x550def['id']);}catch(_0x3ea6ea){console[_0x2c8509(0x193)](_0x2c8509(0x17a),_0x3ea6ea);}await database_1[_0x2c8509(0x183)][_0x2c8509(0x198)]['create']({'data':{'paymentId':_0x550def['id'],'shopId':_0x550def[_0x2c8509(0x185)],'event':_0x2a113a+'_webhook_'+_0x3a131d[_0x2c8509(0x137)](),'statusCode':0xc8,'responseBody':JSON[_0x2c8509(0x142)]({'oldStatus':_0x3aa5be,'newStatus':_0x3a131d,'failureMessage':_0x103ed6,'txUrls':_0x99fda1,'webhookData':_0x168fbf})}}),await this[_0x2c8509(0x133)](_0x550def,_0x3a131d),await this[_0x2c8509(0x129)](_0x550def,_0x3a131d),console[_0x2c8509(0x13e)]('âœ…\x20Payment\x20'+_0x550def['id']+_0x2c8509(0x169)+_0x3aa5be+'\x20->\x20'+_0x3a131d),_0x103ed6&&console[_0x2c8509(0x13e)](_0x2c8509(0x182)+_0x103ed6),_0x99fda1&&_0x99fda1[_0x2c8509(0x154)]>0x0&&console['log'](_0x2c8509(0x187)+_0x99fda1[_0x2c8509(0x154)]+_0x2c8509(0x18d));}async['sendShopWebhook'](_0xcb4f4a,_0xfa7101){const _0x5277fc=a52_0x2454b9,_0x170618=Date[_0x5277fc(0x139)]();try{const _0x14e0af=_0xcb4f4a[_0x5277fc(0x17c)],_0x3f06f0=_0x14e0af[_0x5277fc(0x171)];if(!_0x3f06f0?.['webhookUrl']){console[_0x5277fc(0x13e)](_0x5277fc(0x14d)+_0x14e0af['id']);return;}const _0x47fd15=_0xfa7101===_0x5277fc(0x16e)?_0x5277fc(0x120):_0xfa7101===_0x5277fc(0x186)?_0x5277fc(0x12f):_0xfa7101===_0x5277fc(0x11e)?_0x5277fc(0x12f):_0x5277fc(0x162);let _0x4307c1=[];if(_0x3f06f0[_0x5277fc(0x156)])try{_0x4307c1=Array[_0x5277fc(0x16a)](_0x3f06f0['webhookEvents'])?_0x3f06f0[_0x5277fc(0x156)]:JSON[_0x5277fc(0x147)](_0x3f06f0[_0x5277fc(0x156)]);}catch(_0x23a11e){console['error']('Error\x20parsing\x20webhook\x20events:',_0x23a11e),_0x4307c1=[];}if(!_0x4307c1[_0x5277fc(0x173)](_0x47fd15)){console[_0x5277fc(0x13e)](_0x5277fc(0x13a)+_0x47fd15+_0x5277fc(0x16b)+_0x14e0af['id']);return;}let _0x5b48a2;if(_0xcb4f4a[_0x5277fc(0x191)])try{_0x5b48a2=JSON[_0x5277fc(0x147)](_0xcb4f4a[_0x5277fc(0x191)]);}catch(_0x5d63bc){console[_0x5277fc(0x193)](_0x5277fc(0x130),_0x5d63bc),_0x5b48a2=undefined;}const _0x587bf1={'event':_0x47fd15,'payment':{'id':_0xcb4f4a['id'],'order_id':_0xcb4f4a['orderId'],'gateway_order_id':_0xcb4f4a[_0x5277fc(0x134)],'gateway':_0xcb4f4a['gateway'],'amount':_0xcb4f4a[_0x5277fc(0x146)],'currency':_0xcb4f4a[_0x5277fc(0x151)],'status':_0xfa7101[_0x5277fc(0x137)](),'customer_email':_0xcb4f4a['customerEmail'],'customer_name':_0xcb4f4a[_0x5277fc(0x136)],'failure_message':_0xcb4f4a[_0x5277fc(0x18e)],'tx_urls':_0x5b48a2,'created_at':_0xcb4f4a[_0x5277fc(0x13b)],'updated_at':new Date()}},_0x59908c=await fetch(_0x3f06f0[_0x5277fc(0x141)],{'method':_0x5277fc(0x124),'headers':{'Content-Type':_0x5277fc(0x176),'User-Agent':_0x5277fc(0x196)},'body':JSON[_0x5277fc(0x142)](_0x587bf1)}),_0x4c4486=Date[_0x5277fc(0x139)]()-_0x170618,_0x47960f=_0x59908c['ok']?_0x5277fc(0x163):await _0x59908c[_0x5277fc(0x125)]();loggerService_1['loggerService']['logShopWebhookSent'](_0xcb4f4a[_0x5277fc(0x185)],_0x3f06f0[_0x5277fc(0x141)],_0x47fd15,_0x59908c[_0x5277fc(0x189)],_0x4c4486,_0x587bf1),console[_0x5277fc(0x13e)]('Shop\x20webhook\x20sent\x20to\x20'+_0x3f06f0[_0x5277fc(0x141)]+_0x5277fc(0x17b)+_0x59908c[_0x5277fc(0x189)]+'\x20('+_0x4c4486+'ms)');}catch(_0x5b14f7){console['error'](_0x5277fc(0x138),_0x5b14f7),loggerService_1[_0x5277fc(0x18c)][_0x5277fc(0x14b)](_0xcb4f4a['shopId'],_0xcb4f4a[_0x5277fc(0x17c)]?.[_0x5277fc(0x171)]?.[_0x5277fc(0x141)]||_0x5277fc(0x175),_0x5277fc(0x123),_0x5b14f7,{});}}async[a52_0x2454b9(0x129)](_0x146242,_0x3a50a1){const _0x53116f=a52_0x2454b9;try{const _0x32912d={'PENDING':'created','PAID':_0x53116f(0x121),'FAILED':_0x53116f(0x18f),'EXPIRED':_0x53116f(0x195)},_0x503ac7=_0x32912d[_0x3a50a1];if(!_0x503ac7||_0x503ac7===_0x53116f(0x148))return;await telegramBotService_1[_0x53116f(0x14e)]['sendPaymentNotification'](_0x146242[_0x53116f(0x185)],_0x146242,_0x503ac7);}catch(_0x46ce22){console[_0x53116f(0x193)](_0x53116f(0x144),_0x46ce22);}}}exports[a52_0x2454b9(0x11d)]=WebhookService;