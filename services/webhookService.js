'use strict';function a60_0x34a0(){const _0x3a86fd=['entries','shopId','bankId','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','customerEmail','logWebhookProcessed','\x20to\x20','masterCardService','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','amountUSDT','371920CzTkqN','createdAt','cointopay2','18SvPeXd','üîÑ\x20Processing\x20CoinToPay2\x20webhook:','\x20not\x20found','‚ùå\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','Failed\x20to\x20send\x20shop\x20webhook:','webhookLog','paymentId','./gateways/plisioService','../config/database','shop','updatePaymentStatus','processAmerWebhook','2942296VYUcGp','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','üìà\x20Payment\x20details:\x20oldStatus=\x22','plisio_gateway','Error\x20processing\x20Noda\x20webhook:','additionalInfo','processNodaWebhook','amer','üîÑ\x20Processing\x20Plisio\x20webhook:','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','Success','üìä\x20Plisio\x20webhook:\x20Payment\x20','\x20USDT','keys','payment','processCoinToPayWebhook','\x20status\x20','WebhookService','gatewayOrderId','üìä\x20CoinToPay\x20webhook:\x20Payment\x20','payment_method','status','klyme','noda','created','processing','mastercard','üîÑ\x20Processing\x20CoinToPay\x20webhook:','Error\x20processing\x20Rapyd\x20webhook:','üìä\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','failureMessage','üìù\x20Reason:\x20','failed','CHARGEBACK','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','processMasterCardWebhook','paid','payment.failed','unknown','1004590NTkuRd','sendShopWebhook','./gateways/coinToPayService','loggerService','‚ùå\x20Error\x20processing\x20MasterCard\x20webhook:','coinToPayService','\x20not\x20enabled\x20for\x20shop\x20',',\x20currentPayments=','plisioService','MasterCardService','remitterIban','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','update','‚ùå\x20Error\x20processing\x20Amer\x20webhook:','\x20and\x20-','üí∞\x20Converting\x20','üîÑ\x20Processing\x20Amer\x20webhook:','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','webhookEvents','\x22,\x20id=\x22','rapydService','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','processCoinToPay2Webhook','Error\x20processing\x20CoinToPay\x20webhook:','üì§\x20Shop\x20webhook\x20sent\x20to\x20','%\x20gateway\x20commission)','logWebhookError','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','48czGCGh','Payment\x20','üí∞\x20Removing\x20from\x20balance:\x20','PlisioService','PAID','processPlisioWebhook','logShopWebhookError','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','error','amountAfterGatewayCommissionUSDT',',\x20newStatus=','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','orderId','\x20-\x20','webhook_status_change_','./gateways/mastercardService','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','paymentLink','No\x20payment\x20ID\x20in\x20Noda\x20webhook','Error\x20parsing\x20webhook\x20events:','paymentMethod','findFirst','CoinToPay2Service','üí∞\x20Adding\x20to\x20balance:\x20','settings','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','üîç\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','üîÑ\x20Processing\x20Plisio\x20Gateway\x20webhook:','commission','\x20USDT\x20(chargeback\x20penalty)','61647YJmomF','klymeService','\x20balance\x20updated:\x20','application/json','‚ùå\x20Available\x20webhook\x20fields:','üìä\x20CoinToPay2\x20webhook:\x20Payment\x20','681633xgJAKk','3546361poakkI','Found\x20payment\x20','NodaService','create','default','RapydService','üîç\x20Search\x20result:\x20','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','isArray','COMPLETED','currencyService','plisio','now','__esModule','Payment\x20not\x20found','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','system','gateway','cointopay','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','convertToUSDT','toISOString','webhookUrl','\x20->\x20','toLowerCase','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','üìà\x20Found\x20payment\x20link\x20','\x20commission\x20for\x20shop\x20','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','Gateway\x20','processKlymeWebhook','No\x20payment\x20ID\x20in\x20Amer\x20webhook','rapyd','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','üìä\x20MasterCard\x20webhook\x20result:','üîç\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','refund','./loggerService','\x20=\x20','AmerService','findUnique','CoinToPayService','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','\x20+\x20','currentPayments','findMany','username','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','cardLast4','Webhook\x20event\x20','toFixed','sendPaymentStatusNotification','sendPaymentNotification','nodaService','parse',',\x20using\x20default\x2010%','‚úÖ\x20Shop\x20','remitterName','77PvZjaE','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','üí∞\x20Final\x20balance\x20after\x20chargeback:\x20','gatewaySettings','paymentLinkId',',\x20status=','\x22,\x20paymentLinkId=\x22','toUpperCase','SINGLE','\x20with\x20status\x20','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','log','$transaction','coinToPay2Service','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','balance','no\x20balance\x20change','üîÑ\x20Processing\x20KLYME\x20webhook:','134285SpHMLM','getGatewayCommission','stringify','payment.pending','text','POST','72Unrjjy','chargebackAmount','amount','paidAt','defineProperty','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','processWebhook','type','amerService','‚ùå\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','üìä\x20Rapyd\x20webhook:\x20Payment\x20','\x20current\x20balance:\x20','\x22,\x20orderId=\x22','‚ùå\x20Payment\x20link\x20','üìà\x20Payment\x20','\x22,\x20newStatus=\x22','txUrls','Error\x20processing\x20Plisio\x20webhook:','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','üîÑ\x20Processing\x20Noda\x20webhook:','\x20updated:\x20currentPayments='];a60_0x34a0=function(){return _0x3a86fd;};return a60_0x34a0();}const a60_0x616bc2=a60_0x52ef;function a60_0x52ef(_0x2abc80,_0x4ed898){const _0x34a0a5=a60_0x34a0();return a60_0x52ef=function(_0x52ef81,_0x24b595){_0x52ef81=_0x52ef81-0x100;let _0x54fa0d=_0x34a0a5[_0x52ef81];return _0x54fa0d;},a60_0x52ef(_0x2abc80,_0x4ed898);}(function(_0x2b007c,_0x29527f){const _0x30e28c=a60_0x52ef,_0x29b0cb=_0x2b007c();while(!![]){try{const _0x138600=-parseInt(_0x30e28c(0x11a))/0x1+-parseInt(_0x30e28c(0x16d))/0x2*(-parseInt(_0x30e28c(0x114))/0x3)+parseInt(_0x30e28c(0x18d))/0x4+-parseInt(_0x30e28c(0x167))/0x5*(-parseInt(_0x30e28c(0x1df))/0x6)+parseInt(_0x30e28c(0x11b))/0x7+-parseInt(_0x30e28c(0x19c))/0x8*(-parseInt(_0x30e28c(0x190))/0x9)+parseInt(_0x30e28c(0x1c3))/0xa*(-parseInt(_0x30e28c(0x155))/0xb);if(_0x138600===_0x29527f)break;else _0x29b0cb['push'](_0x29b0cb['shift']());}catch(_0x426222){_0x29b0cb['push'](_0x29b0cb['shift']());}}}(a60_0x34a0,0xdcef7));var __importDefault=this&&this['__importDefault']||function(_0x23c175){const _0x143543=a60_0x52ef;return _0x23c175&&_0x23c175[_0x143543(0x128)]?_0x23c175:{'default':_0x23c175};};Object[a60_0x616bc2(0x171)](exports,a60_0x616bc2(0x128),{'value':!![]}),exports[a60_0x616bc2(0x1ad)]=void 0x0;const database_1=__importDefault(require(a60_0x616bc2(0x198))),plisioService_1=require(a60_0x616bc2(0x197)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a60_0x616bc2(0x1c5)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a60_0x616bc2(0x105)),amerService_1=require('./gateways/amerService'),telegramBotService_1=require('./telegramBotService'),currencyService_1=require('./currencyService'),loggerService_1=require(a60_0x616bc2(0x140));class WebhookService{constructor(){const _0xd50ef3=a60_0x616bc2;this[_0xd50ef3(0x1cb)]=new plisioService_1[(_0xd50ef3(0x1e2))](),this[_0xd50ef3(0x1d7)]=new rapydService_1[(_0xd50ef3(0x120))](),this[_0xd50ef3(0x150)]=new nodaService_1[(_0xd50ef3(0x11d))](),this[_0xd50ef3(0x1c8)]=new coinToPayService_1[(_0xd50ef3(0x144))](),this[_0xd50ef3(0x162)]=new coinToPay2Service_1[(_0xd50ef3(0x10c))](),this[_0xd50ef3(0x115)]=new klymeService_1['KlymeService'](),this[_0xd50ef3(0x18a)]=new mastercardService_1[(_0xd50ef3(0x1cc))](),this[_0xd50ef3(0x175)]=new amerService_1[(_0xd50ef3(0x142))]();}async[a60_0x616bc2(0x19a)](_0x43e60d,_0x5c3ee1,_0x1909f2){const _0x134286=a60_0x616bc2;console[_0x134286(0x160)]('üîÑ\x20updatePaymentStatus\x20called:\x20paymentId='+_0x43e60d+_0x134286(0x100)+_0x5c3ee1),console['log']('üîÑ\x20Additional\x20data:',_0x1909f2),await database_1[_0x134286(0x11f)][_0x134286(0x161)](async _0x11c853=>{const _0xc43c6a=_0x134286,_0x39ca76=await _0x11c853['payment']['findUnique']({'where':{'id':_0x43e60d},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x39ca76)throw new Error(_0xc43c6a(0x1e0)+_0x43e60d+'\x20not\x20found');const _0x369bac=_0x39ca76['status'],_0x58bf5d=_0x39ca76['shop'];console[_0xc43c6a(0x160)]('üí∞\x20Payment\x20'+_0x43e60d+':\x20'+_0x369bac+_0xc43c6a(0x132)+_0x5c3ee1),console[_0xc43c6a(0x160)]('üè™\x20Shop\x20'+_0x58bf5d[_0xc43c6a(0x149)]+_0xc43c6a(0x179)+_0x58bf5d[_0xc43c6a(0x164)]+'\x20USDT');const _0x4e8e87={'status':_0x5c3ee1[_0xc43c6a(0x15c)](),'updatedAt':new Date(),'statusChangedBy':_0xc43c6a(0x12b),'statusChangedAt':new Date()};_0x1909f2?.['failureMessage']&&(_0x4e8e87[_0xc43c6a(0x1ba)]=_0x1909f2[_0xc43c6a(0x1ba)]);_0x1909f2?.[_0xc43c6a(0x17e)]&&(_0x4e8e87['txUrls']=JSON[_0xc43c6a(0x169)](_0x1909f2[_0xc43c6a(0x17e)]));_0x1909f2?.['cardLast4']&&(_0x4e8e87[_0xc43c6a(0x14b)]=_0x1909f2['cardLast4']);_0x1909f2?.[_0xc43c6a(0x10a)]&&(_0x4e8e87[_0xc43c6a(0x10a)]=_0x1909f2[_0xc43c6a(0x10a)]);_0x1909f2?.[_0xc43c6a(0x185)]&&(_0x4e8e87['bankId']=_0x1909f2[_0xc43c6a(0x185)]);_0x1909f2?.[_0xc43c6a(0x1cd)]&&(_0x4e8e87[_0xc43c6a(0x1cd)]=_0x1909f2[_0xc43c6a(0x1cd)]);_0x1909f2?.['remitterName']&&(_0x4e8e87['remitterName']=_0x1909f2['remitterName']);let _0x2d7f85=_0x58bf5d[_0xc43c6a(0x164)],_0x59f51b='';if(_0x5c3ee1[_0xc43c6a(0x15c)]()==='PAID'&&_0x369bac!==_0xc43c6a(0x1e3)){const _0x10d010=await currencyService_1[_0xc43c6a(0x125)][_0xc43c6a(0x12f)](_0x39ca76[_0xc43c6a(0x16f)],_0x39ca76['currency']),_0x1e139f=await this[_0xc43c6a(0x168)](_0x58bf5d['id'],_0x39ca76[_0xc43c6a(0x12c)]),_0x216e8d=_0x10d010*(0x1-_0x1e139f/0x64);_0x2d7f85+=_0x216e8d,_0x59f51b='+'+_0x216e8d['toFixed'](0x6)+_0xc43c6a(0x145)+_0x1e139f+_0xc43c6a(0x1dc),_0x4e8e87[_0xc43c6a(0x18c)]=_0x10d010,_0x4e8e87[_0xc43c6a(0x1e8)]=_0x216e8d,_0x4e8e87[_0xc43c6a(0x170)]=new Date(),console[_0xc43c6a(0x160)](_0xc43c6a(0x1d2)+_0x39ca76[_0xc43c6a(0x16f)]+'\x20'+_0x39ca76['currency']+_0xc43c6a(0x132)+_0x10d010[_0xc43c6a(0x14d)](0x6)+_0xc43c6a(0x1a8)),console[_0xc43c6a(0x160)]('üí∞\x20Gateway\x20'+_0x39ca76[_0xc43c6a(0x12c)]+'\x20commission:\x20'+_0x1e139f+'%'),console[_0xc43c6a(0x160)](_0xc43c6a(0x1d8)+_0x216e8d['toFixed'](0x6)+_0xc43c6a(0x1a8)),console[_0xc43c6a(0x160)](_0xc43c6a(0x10d)+_0x58bf5d[_0xc43c6a(0x164)]+_0xc43c6a(0x146)+_0x216e8d[_0xc43c6a(0x14d)](0x6)+_0xc43c6a(0x141)+_0x2d7f85[_0xc43c6a(0x14d)](0x6)+_0xc43c6a(0x1a8));}else{if(_0x369bac==='PAID'&&_0x5c3ee1['toUpperCase']()!=='PAID'){let _0x1ac674;if(_0x39ca76[_0xc43c6a(0x1e8)])_0x1ac674=_0x39ca76[_0xc43c6a(0x1e8)];else{if(_0x39ca76[_0xc43c6a(0x18c)]){const _0x3133d8=await this[_0xc43c6a(0x168)](_0x58bf5d['id'],_0x39ca76[_0xc43c6a(0x12c)]);_0x1ac674=_0x39ca76['amountUSDT']*(0x1-_0x3133d8/0x64);}else console['log'](_0xc43c6a(0x13c)),_0x1ac674=0x0;}_0x1ac674>0x0&&(_0x2d7f85-=_0x1ac674,_0x59f51b='-'+_0x1ac674[_0xc43c6a(0x14d)](0x6)+_0xc43c6a(0x15f),_0x4e8e87[_0xc43c6a(0x18c)]=null,_0x4e8e87[_0xc43c6a(0x1e8)]=null,_0x4e8e87[_0xc43c6a(0x170)]=null,console[_0xc43c6a(0x160)](_0xc43c6a(0x1e1)+_0x58bf5d[_0xc43c6a(0x164)]+_0xc43c6a(0x103)+_0x1ac674[_0xc43c6a(0x14d)](0x6)+_0xc43c6a(0x141)+_0x2d7f85[_0xc43c6a(0x14d)](0x6)+_0xc43c6a(0x1a8)));}}if(_0x5c3ee1[_0xc43c6a(0x15c)]()===_0xc43c6a(0x1bd)){const _0x3472b2=_0x1909f2?.[_0xc43c6a(0x16e)]||0x0;_0x3472b2>0x0&&(_0x2d7f85-=_0x3472b2,_0x59f51b+=_0xc43c6a(0x1d1)+_0x3472b2[_0xc43c6a(0x14d)](0x6)+_0xc43c6a(0x113),_0x4e8e87[_0xc43c6a(0x16e)]=_0x3472b2,console[_0xc43c6a(0x160)]('üí∏\x20Additional\x20chargeback\x20penalty:\x20-'+_0x3472b2['toFixed'](0x6)+'\x20USDT'),console[_0xc43c6a(0x160)](_0xc43c6a(0x157)+_0x2d7f85[_0xc43c6a(0x14d)](0x6)+_0xc43c6a(0x1a8)));}const _0x51069c=await _0x11c853[_0xc43c6a(0x1aa)]['update']({'where':{'id':_0x43e60d},'data':_0x4e8e87});_0x2d7f85!==_0x58bf5d['balance']&&(await _0x11c853[_0xc43c6a(0x199)][_0xc43c6a(0x1cf)]({'where':{'id':_0x58bf5d['id']},'data':{'balance':_0x2d7f85}}),console[_0xc43c6a(0x160)](_0xc43c6a(0x153)+_0x58bf5d[_0xc43c6a(0x149)]+_0xc43c6a(0x116)+_0x58bf5d[_0xc43c6a(0x164)]['toFixed'](0x6)+_0xc43c6a(0x132)+_0x2d7f85[_0xc43c6a(0x14d)](0x6)+_0xc43c6a(0x1a8)),console[_0xc43c6a(0x160)](_0xc43c6a(0x1bb)+_0x59f51b));await _0x11c853[_0xc43c6a(0x195)][_0xc43c6a(0x11e)]({'data':{'paymentId':_0x43e60d,'shopId':_0x58bf5d['id'],'event':_0xc43c6a(0x104)+_0x5c3ee1['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0xc43c6a(0x169)]({'oldStatus':_0x369bac,'newStatus':_0x5c3ee1[_0xc43c6a(0x15c)](),'balanceChange':_0x59f51b||_0xc43c6a(0x165),'oldBalance':_0x58bf5d[_0xc43c6a(0x164)],'newBalance':_0x2d7f85,'amountUSDT':_0x4e8e87['amountUSDT'],'additionalData':_0x1909f2,'timestamp':new Date()[_0xc43c6a(0x130)]()})}}),await this[_0xc43c6a(0x1c4)]({..._0x39ca76,..._0x51069c,'shop':_0x58bf5d},_0x5c3ee1[_0xc43c6a(0x15c)]()),await this[_0xc43c6a(0x14e)]({..._0x39ca76,..._0x51069c},_0x5c3ee1[_0xc43c6a(0x15c)]());if(_0x369bac!==_0xc43c6a(0x1e3)&&_0x5c3ee1[_0xc43c6a(0x15c)]()===_0xc43c6a(0x1e3)){console[_0xc43c6a(0x160)](_0xc43c6a(0x17c)+_0x43e60d+_0xc43c6a(0x10f)),console[_0xc43c6a(0x160)](_0xc43c6a(0x19e)+_0x369bac+_0xc43c6a(0x17d)+_0x5c3ee1['toUpperCase']()+_0xc43c6a(0x15b)+_0x39ca76[_0xc43c6a(0x159)]+'\x22');if(_0x39ca76[_0xc43c6a(0x159)])try{const _0x33aaef=await _0x11c853[_0xc43c6a(0x107)][_0xc43c6a(0x143)]({'where':{'id':_0x39ca76[_0xc43c6a(0x159)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x33aaef){console['log'](_0xc43c6a(0x135)+_0x33aaef['id']+':\x20type='+_0x33aaef[_0xc43c6a(0x174)]+_0xc43c6a(0x1ca)+_0x33aaef[_0xc43c6a(0x147)]+_0xc43c6a(0x15a)+_0x33aaef['status']);const _0x5914b6=_0x33aaef[_0xc43c6a(0x147)]+0x1,_0x315b8b=_0x33aaef[_0xc43c6a(0x174)]===_0xc43c6a(0x15d)?_0xc43c6a(0x124):_0x33aaef['status'];await _0x11c853['paymentLink']['update']({'where':{'id':_0x39ca76['paymentLinkId']},'data':{'currentPayments':_0x5914b6,'status':_0x315b8b,'updatedAt':new Date()}}),console[_0xc43c6a(0x160)]('‚úÖ\x20Payment\x20link\x20'+_0x33aaef['id']+_0xc43c6a(0x182)+_0x33aaef[_0xc43c6a(0x147)]+_0xc43c6a(0x132)+_0x5914b6+',\x20status='+_0x33aaef[_0xc43c6a(0x1b1)]+_0xc43c6a(0x132)+_0x315b8b);}else console['log'](_0xc43c6a(0x17b)+_0x39ca76['paymentLinkId']+_0xc43c6a(0x192));}catch(_0x38b3d8){console['error'](_0xc43c6a(0x18b),_0x38b3d8);}else console['log'](_0xc43c6a(0x17c)+_0x43e60d+_0xc43c6a(0x1ce));}else console['log'](_0xc43c6a(0x17c)+_0x43e60d+_0xc43c6a(0x134)+_0x369bac+'\x20->\x20'+_0x5c3ee1[_0xc43c6a(0x15c)]());});}async[a60_0x616bc2(0x1e4)](_0x32a458){const _0x3d5420=a60_0x616bc2;console[_0x3d5420(0x160)](_0x3d5420(0x1a4),_0x32a458);try{const _0x569f01=await this[_0x3d5420(0x1cb)][_0x3d5420(0x173)](_0x32a458);if(!_0x569f01[_0x3d5420(0x196)])throw new Error(_0x3d5420(0x137));const _0x2992ed=await database_1[_0x3d5420(0x11f)][_0x3d5420(0x1aa)][_0x3d5420(0x10b)]({'where':{'gatewayOrderId':_0x569f01[_0x3d5420(0x196)]}});if(!_0x2992ed){console[_0x3d5420(0x1e7)](_0x3d5420(0x122)+_0x569f01[_0x3d5420(0x196)]);return;}console[_0x3d5420(0x160)](_0x3d5420(0x1a7)+_0x2992ed['id']+_0x3d5420(0x1ac)+_0x569f01['status']),await this[_0x3d5420(0x19a)](_0x2992ed['id'],_0x569f01[_0x3d5420(0x1b1)],{'txUrls':_0x569f01[_0x3d5420(0x17e)]}),loggerService_1[_0x3d5420(0x1c6)][_0x3d5420(0x188)]('plisio',_0x2992ed['id'],_0x2992ed['status'],_0x569f01[_0x3d5420(0x1b1)],_0x32a458);}catch(_0x474993){console[_0x3d5420(0x1e7)](_0x3d5420(0x17f),_0x474993),loggerService_1[_0x3d5420(0x1c6)][_0x3d5420(0x1dd)](_0x3d5420(0x126),_0x474993,_0x32a458);throw _0x474993;}}async['processPlisioGatewayWebhook'](_0x7fd079){const _0x1e1f48=a60_0x616bc2;console['log'](_0x1e1f48(0x111),_0x7fd079);try{const _0x531c5b=await this[_0x1e1f48(0x1cb)]['processWebhook'](_0x7fd079);if(!_0x531c5b[_0x1e1f48(0x196)])throw new Error(_0x1e1f48(0x180));const _0x41c5e1=await database_1[_0x1e1f48(0x11f)]['payment'][_0x1e1f48(0x10b)]({'where':{'gatewayOrderId':_0x531c5b[_0x1e1f48(0x196)]}});if(!_0x41c5e1){console['error']('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x531c5b['paymentId']);return;}console[_0x1e1f48(0x160)](_0x1e1f48(0x1b9)+_0x41c5e1['id']+_0x1e1f48(0x1ac)+_0x531c5b['status']),await this[_0x1e1f48(0x19a)](_0x41c5e1['id'],_0x531c5b['status'],{'txUrls':_0x531c5b['txUrls']}),loggerService_1[_0x1e1f48(0x1c6)][_0x1e1f48(0x188)](_0x1e1f48(0x19f),_0x41c5e1['id'],_0x41c5e1[_0x1e1f48(0x1b1)],_0x531c5b[_0x1e1f48(0x1b1)],_0x7fd079);}catch(_0x18fec6){console['error'](_0x1e1f48(0x1be),_0x18fec6),loggerService_1[_0x1e1f48(0x1c6)][_0x1e1f48(0x1dd)]('plisio_gateway',_0x18fec6,_0x7fd079);throw _0x18fec6;}}async['processRapydWebhook'](_0x4da88a){const _0x2b19a7=a60_0x616bc2;console[_0x2b19a7(0x160)]('üîÑ\x20Processing\x20Rapyd\x20webhook:',_0x4da88a);try{const _0x4179ef=await this[_0x2b19a7(0x1d7)]['processWebhook'](_0x4da88a);if(!_0x4179ef[_0x2b19a7(0x196)])throw new Error(_0x2b19a7(0x101));const _0x3dc4ab=await database_1['default'][_0x2b19a7(0x1aa)][_0x2b19a7(0x10b)]({'where':{'gatewayOrderId':_0x4179ef[_0x2b19a7(0x196)]}});if(!_0x3dc4ab){console[_0x2b19a7(0x1e7)](_0x2b19a7(0x172)+_0x4179ef[_0x2b19a7(0x196)]);return;}console['log'](_0x2b19a7(0x178)+_0x3dc4ab['id']+_0x2b19a7(0x1ac)+_0x4179ef['status']),await this[_0x2b19a7(0x19a)](_0x3dc4ab['id'],_0x4179ef['status'],{'failureMessage':_0x4179ef[_0x2b19a7(0x1ba)],'cardLast4':_0x4179ef[_0x2b19a7(0x1a1)]?.['cardLast4'],'paymentMethod':_0x4179ef[_0x2b19a7(0x1a1)]?.['paymentMethod']}),loggerService_1[_0x2b19a7(0x1c6)][_0x2b19a7(0x188)]('rapyd',_0x3dc4ab['id'],_0x3dc4ab['status'],_0x4179ef[_0x2b19a7(0x1b1)],_0x4da88a);}catch(_0x4c9e94){console['error'](_0x2b19a7(0x1b8),_0x4c9e94),loggerService_1[_0x2b19a7(0x1c6)][_0x2b19a7(0x1dd)](_0x2b19a7(0x13b),_0x4c9e94,_0x4da88a);throw _0x4c9e94;}}async[a60_0x616bc2(0x1a2)](_0x4af4ca){const _0x24a9b1=a60_0x616bc2;console[_0x24a9b1(0x160)](_0x24a9b1(0x181),_0x4af4ca);try{const _0x52fd3e=await this['nodaService'][_0x24a9b1(0x173)](_0x4af4ca);if(!_0x52fd3e[_0x24a9b1(0x196)])throw new Error(_0x24a9b1(0x108));const _0x4404ba=await database_1['default'][_0x24a9b1(0x1aa)][_0x24a9b1(0x10b)]({'where':{'gatewayOrderId':_0x52fd3e[_0x24a9b1(0x196)]}});if(!_0x4404ba){console[_0x24a9b1(0x1e7)](_0x24a9b1(0x12a)+_0x52fd3e[_0x24a9b1(0x196)]);return;}console[_0x24a9b1(0x160)]('üìä\x20Noda\x20webhook:\x20Payment\x20'+_0x4404ba['id']+_0x24a9b1(0x1ac)+_0x52fd3e['status']),await this[_0x24a9b1(0x19a)](_0x4404ba['id'],_0x52fd3e[_0x24a9b1(0x1b1)],{'bankId':_0x52fd3e['additionalInfo']?.['bankId'],'remitterIban':_0x52fd3e[_0x24a9b1(0x1a1)]?.[_0x24a9b1(0x1cd)],'remitterName':_0x52fd3e['additionalInfo']?.[_0x24a9b1(0x154)]}),loggerService_1['loggerService'][_0x24a9b1(0x188)]('noda',_0x4404ba['id'],_0x4404ba[_0x24a9b1(0x1b1)],_0x52fd3e[_0x24a9b1(0x1b1)],_0x4af4ca);}catch(_0x72ebad){console[_0x24a9b1(0x1e7)](_0x24a9b1(0x1a0),_0x72ebad),loggerService_1[_0x24a9b1(0x1c6)][_0x24a9b1(0x1dd)](_0x24a9b1(0x1b3),_0x72ebad,_0x4af4ca);throw _0x72ebad;}}async[a60_0x616bc2(0x1ab)](_0x1b0cce){const _0x42c3e1=a60_0x616bc2;console[_0x42c3e1(0x160)](_0x42c3e1(0x1b7),_0x1b0cce);try{const _0x30f27f=await this[_0x42c3e1(0x1c8)][_0x42c3e1(0x173)](_0x1b0cce);if(!_0x30f27f[_0x42c3e1(0x196)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x37a295=await database_1[_0x42c3e1(0x11f)][_0x42c3e1(0x1aa)][_0x42c3e1(0x10b)]({'where':{'gatewayOrderId':_0x30f27f[_0x42c3e1(0x196)]}});if(!_0x37a295){console[_0x42c3e1(0x1e7)](_0x42c3e1(0x163)+_0x30f27f[_0x42c3e1(0x196)]);return;}console[_0x42c3e1(0x160)](_0x42c3e1(0x1af)+_0x37a295['id']+'\x20status\x20'+_0x30f27f[_0x42c3e1(0x1b1)]),await this[_0x42c3e1(0x19a)](_0x37a295['id'],_0x30f27f[_0x42c3e1(0x1b1)]),loggerService_1[_0x42c3e1(0x1c6)]['logWebhookProcessed'](_0x42c3e1(0x12d),_0x37a295['id'],_0x37a295['status'],_0x30f27f[_0x42c3e1(0x1b1)],_0x1b0cce);}catch(_0x3785e4){console[_0x42c3e1(0x1e7)](_0x42c3e1(0x1da),_0x3785e4),loggerService_1['loggerService']['logWebhookError']('cointopay',_0x3785e4,_0x1b0cce);throw _0x3785e4;}}async[a60_0x616bc2(0x1d9)](_0x151c58){const _0x486b9b=a60_0x616bc2;console[_0x486b9b(0x160)](_0x486b9b(0x191),_0x151c58);try{const _0x5d9f88=await this[_0x486b9b(0x162)][_0x486b9b(0x173)](_0x151c58);if(!_0x5d9f88[_0x486b9b(0x196)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook');const _0x4d0089=await database_1[_0x486b9b(0x11f)][_0x486b9b(0x1aa)][_0x486b9b(0x10b)]({'where':{'gatewayOrderId':_0x5d9f88['paymentId']}});if(!_0x4d0089){console[_0x486b9b(0x1e7)](_0x486b9b(0x1de)+_0x5d9f88['paymentId']);return;}console[_0x486b9b(0x160)](_0x486b9b(0x119)+_0x4d0089['id']+_0x486b9b(0x1ac)+_0x5d9f88[_0x486b9b(0x1b1)]),await this['updatePaymentStatus'](_0x4d0089['id'],_0x5d9f88['status']),loggerService_1[_0x486b9b(0x1c6)][_0x486b9b(0x188)]('cointopay2',_0x4d0089['id'],_0x4d0089[_0x486b9b(0x1b1)],_0x5d9f88[_0x486b9b(0x1b1)],_0x151c58);}catch(_0x4f00f5){console[_0x486b9b(0x1e7)]('Error\x20processing\x20CoinToPay2\x20webhook:',_0x4f00f5),loggerService_1[_0x486b9b(0x1c6)]['logWebhookError'](_0x486b9b(0x18f),_0x4f00f5,_0x151c58);throw _0x4f00f5;}}async[a60_0x616bc2(0x139)](_0x3e3e3e){const _0x41a83e=a60_0x616bc2;console[_0x41a83e(0x160)](_0x41a83e(0x166),_0x3e3e3e);try{const _0x5c78cb=await this['klymeService']['processWebhook'](_0x3e3e3e);if(!_0x5c78cb[_0x41a83e(0x196)])throw new Error(_0x41a83e(0x19d));const _0x53f5d3=await database_1[_0x41a83e(0x11f)]['payment'][_0x41a83e(0x10b)]({'where':{'gatewayOrderId':_0x5c78cb[_0x41a83e(0x196)]}});if(!_0x53f5d3){console[_0x41a83e(0x1e7)](_0x41a83e(0x1d4)+_0x5c78cb[_0x41a83e(0x196)]);return;}console['log']('üìä\x20KLYME\x20webhook:\x20Payment\x20'+_0x53f5d3['id']+_0x41a83e(0x1ac)+_0x5c78cb[_0x41a83e(0x1b1)]),await this[_0x41a83e(0x19a)](_0x53f5d3['id'],_0x5c78cb[_0x41a83e(0x1b1)],{'paymentMethod':_0x5c78cb[_0x41a83e(0x1a1)]?.[_0x41a83e(0x1b0)]}),loggerService_1[_0x41a83e(0x1c6)][_0x41a83e(0x188)](_0x41a83e(0x1b2),_0x53f5d3['id'],_0x53f5d3[_0x41a83e(0x1b1)],_0x5c78cb[_0x41a83e(0x1b1)],_0x3e3e3e);}catch(_0x1c8e14){console[_0x41a83e(0x1e7)]('Error\x20processing\x20KLYME\x20webhook:',_0x1c8e14),loggerService_1['loggerService'][_0x41a83e(0x1dd)]('klyme',_0x1c8e14,_0x3e3e3e);throw _0x1c8e14;}}async[a60_0x616bc2(0x1bf)](_0x3ce3a6){const _0x480a72=a60_0x616bc2;console[_0x480a72(0x160)]('üîÑ\x20Processing\x20MasterCard\x20webhook:',JSON['stringify'](_0x3ce3a6,null,0x2));try{const _0x3bb681=await this[_0x480a72(0x18a)]['processWebhook'](_0x3ce3a6);console[_0x480a72(0x160)](_0x480a72(0x13d),_0x3bb681);if(!_0x3bb681[_0x480a72(0x196)]){console[_0x480a72(0x1e7)](_0x480a72(0x12e)),console['error'](_0x480a72(0x118),Object[_0x480a72(0x1a9)](_0x3ce3a6));throw new Error(_0x480a72(0x106));}let _0x598588=null;console[_0x480a72(0x160)]('üîç\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x3bb681[_0x480a72(0x196)]);_0x3bb681[_0x480a72(0x196)]&&(console[_0x480a72(0x160)](_0x480a72(0x110)),_0x598588=await database_1['default'][_0x480a72(0x1aa)]['findFirst']({'where':{'AND':[{'gateway':'mastercard'},{'OR':[{'gatewayPaymentId':_0x3bb681[_0x480a72(0x196)]},{'gatewayOrderId':_0x3bb681[_0x480a72(0x196)]},{'id':_0x3bb681[_0x480a72(0x196)]},{'orderId':_0x3bb681['paymentId']}]}]}}),console['log']('üîç\x20Search\x20result:\x20'+(_0x598588?_0x480a72(0x11c)+_0x598588['id']:_0x480a72(0x129))));if(!_0x598588){console[_0x480a72(0x1e7)](_0x480a72(0x176)+_0x3bb681[_0x480a72(0x196)]),console[_0x480a72(0x1e7)]('üîç\x20Searched\x20by:\x20gatewayOrderId=\x22'+_0x3bb681[_0x480a72(0x196)]+_0x480a72(0x1d6)+_0x3bb681[_0x480a72(0x196)]+_0x480a72(0x17a)+_0x3bb681[_0x480a72(0x196)]+'\x22');const _0x192cb5=await database_1[_0x480a72(0x11f)][_0x480a72(0x1aa)][_0x480a72(0x148)]({'where':{'gateway':'mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x480a72(0x160)]('üîç\x20Available\x20MasterCard\x20payments\x20for\x20debugging:',_0x192cb5);return;}console[_0x480a72(0x160)]('‚úÖ\x20Found\x20payment\x20'+_0x598588['id']+_0x480a72(0x177)+_0x598588[_0x480a72(0x1b1)]+_0x480a72(0x189)+_0x3bb681[_0x480a72(0x1b1)]),await this[_0x480a72(0x19a)](_0x598588['id'],_0x3bb681[_0x480a72(0x1b1)]),loggerService_1[_0x480a72(0x1c6)][_0x480a72(0x188)](_0x480a72(0x1b6),_0x598588['id'],_0x598588[_0x480a72(0x1b1)],_0x3bb681[_0x480a72(0x1b1)],_0x3ce3a6);}catch(_0x1bf1a0){console[_0x480a72(0x1e7)](_0x480a72(0x1c7),_0x1bf1a0),loggerService_1[_0x480a72(0x1c6)][_0x480a72(0x1dd)](_0x480a72(0x1b6),_0x1bf1a0,_0x3ce3a6);throw _0x1bf1a0;}}async[a60_0x616bc2(0x19b)](_0x39a456){const _0x3c97c8=a60_0x616bc2;console[_0x3c97c8(0x160)](_0x3c97c8(0x1d3),JSON[_0x3c97c8(0x169)](_0x39a456,null,0x2));try{const _0x4169ec=await this[_0x3c97c8(0x175)][_0x3c97c8(0x173)](_0x39a456);console[_0x3c97c8(0x160)]('üìä\x20Amer\x20webhook\x20result:',_0x4169ec);if(!_0x4169ec[_0x3c97c8(0x196)]){console[_0x3c97c8(0x1e7)](_0x3c97c8(0x186)),console['error'](_0x3c97c8(0x118),Object[_0x3c97c8(0x1a9)](_0x39a456));throw new Error(_0x3c97c8(0x13a));}let _0x5c0e8a=null;console[_0x3c97c8(0x160)](_0x3c97c8(0x13e)+_0x4169ec[_0x3c97c8(0x196)]),_0x5c0e8a=await database_1[_0x3c97c8(0x11f)][_0x3c97c8(0x1aa)]['findFirst']({'where':{'AND':[{'gateway':_0x3c97c8(0x1a3)},{'OR':[{'gatewayPaymentId':_0x4169ec['paymentId']},{'gatewayOrderId':_0x4169ec[_0x3c97c8(0x196)]},{'id':_0x4169ec[_0x3c97c8(0x196)]},{'orderId':_0x4169ec[_0x3c97c8(0x196)]}]}]}}),console['log'](_0x3c97c8(0x121)+(_0x5c0e8a?_0x3c97c8(0x11c)+_0x5c0e8a['id']:'Payment\x20not\x20found'));if(!_0x5c0e8a){console[_0x3c97c8(0x1e7)](_0x3c97c8(0x193)+_0x4169ec['paymentId']);return;}console[_0x3c97c8(0x160)]('üìä\x20Amer\x20webhook:\x20Payment\x20'+_0x5c0e8a['id']+_0x3c97c8(0x1ac)+_0x4169ec['status']),await this[_0x3c97c8(0x19a)](_0x5c0e8a['id'],_0x4169ec[_0x3c97c8(0x1b1)],{'cardLast4':_0x4169ec[_0x3c97c8(0x1a1)]?.['cardLast4'],'paymentMethod':_0x4169ec['additionalInfo']?.[_0x3c97c8(0x10a)]});}catch(_0x48433a){console[_0x3c97c8(0x1e7)](_0x3c97c8(0x1d0),_0x48433a),loggerService_1[_0x3c97c8(0x1c6)]['logWebhookError'](_0x3c97c8(0x1a3),_0x48433a,_0x39a456);throw _0x48433a;}}async['sendShopWebhook'](_0x1d1a25,_0x1f4aa5){const _0x32808b=a60_0x616bc2,_0x4527c3=Date[_0x32808b(0x127)]();try{const _0x1b9f0c=_0x1d1a25[_0x32808b(0x199)],_0x5409b2=_0x1b9f0c[_0x32808b(0x10e)];if(!_0x5409b2?.[_0x32808b(0x131)]){console[_0x32808b(0x160)](_0x32808b(0x156)+_0x1b9f0c['id']);return;}const _0x200307=_0x1f4aa5==='PAID'?'payment.success':_0x1f4aa5==='FAILED'?_0x32808b(0x1c1):_0x1f4aa5==='EXPIRED'?_0x32808b(0x1c1):_0x1f4aa5===_0x32808b(0x1bd)?'payment.failed':_0x1f4aa5==='REFUND'?_0x32808b(0x1c1):_0x32808b(0x16a);let _0x17e31d=[];if(_0x5409b2[_0x32808b(0x1d5)])try{_0x17e31d=Array[_0x32808b(0x123)](_0x5409b2['webhookEvents'])?_0x5409b2[_0x32808b(0x1d5)]:JSON[_0x32808b(0x151)](_0x5409b2['webhookEvents']);}catch(_0x4d9c4f){console['error'](_0x32808b(0x109),_0x4d9c4f),_0x17e31d=[];}if(!_0x17e31d['includes'](_0x200307)){console[_0x32808b(0x160)](_0x32808b(0x14c)+_0x200307+_0x32808b(0x1c9)+_0x1b9f0c['id']);return;}const _0x3d3ecf={'event':_0x200307,'payment':{'id':_0x1d1a25['id'],'order_id':_0x1d1a25[_0x32808b(0x102)],'gateway_order_id':_0x1d1a25[_0x32808b(0x1ae)],'gateway':_0x1d1a25[_0x32808b(0x12c)],'amount':_0x1d1a25[_0x32808b(0x16f)],'currency':_0x1d1a25['currency'],'status':_0x1f4aa5[_0x32808b(0x133)](),'customer_email':_0x1d1a25[_0x32808b(0x187)],'customer_name':_0x1d1a25['customerName'],'failure_message':_0x1d1a25[_0x32808b(0x1ba)],'tx_urls':_0x1d1a25['txUrls']?JSON[_0x32808b(0x151)](_0x1d1a25[_0x32808b(0x17e)]):null,'created_at':_0x1d1a25[_0x32808b(0x18e)],'updated_at':_0x1d1a25['updatedAt']}},_0x1507b3=await fetch(_0x5409b2[_0x32808b(0x131)],{'method':_0x32808b(0x16c),'headers':{'Content-Type':_0x32808b(0x117),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x32808b(0x169)](_0x3d3ecf)}),_0xdfe25f=Date[_0x32808b(0x127)]()-_0x4527c3,_0x2034b0=_0x1507b3['ok']?_0x32808b(0x1a6):await _0x1507b3[_0x32808b(0x16b)]();loggerService_1[_0x32808b(0x1c6)]['logShopWebhookSent'](_0x1d1a25[_0x32808b(0x184)],_0x5409b2[_0x32808b(0x131)],_0x200307,_0x1507b3[_0x32808b(0x1b1)],_0xdfe25f,_0x3d3ecf),console[_0x32808b(0x160)](_0x32808b(0x1db)+_0x5409b2[_0x32808b(0x131)]+_0x32808b(0x15e)+_0x1507b3['status']+'\x20('+_0xdfe25f+'ms)');}catch(_0x538641){console[_0x32808b(0x1e7)](_0x32808b(0x194),_0x538641),loggerService_1[_0x32808b(0x1c6)][_0x32808b(0x1e5)](_0x1d1a25['shopId'],_0x1d1a25[_0x32808b(0x199)]?.[_0x32808b(0x10e)]?.[_0x32808b(0x131)]||_0x32808b(0x1c2),'webhook_send',_0x538641,{});}}async[a60_0x616bc2(0x14e)](_0x3e0bd9,_0xb6021){const _0x2dc050=a60_0x616bc2;try{const _0xec527e={'PENDING':_0x2dc050(0x1b4),'PROCESSING':_0x2dc050(0x1b5),'PAID':_0x2dc050(0x1c0),'FAILED':_0x2dc050(0x1bc),'EXPIRED':'expired','REFUND':_0x2dc050(0x13f),'CHARGEBACK':'chargeback'},_0x2ea6e4=_0xec527e[_0xb6021];if(!_0x2ea6e4||_0x2ea6e4===_0x2dc050(0x1b4))return;await telegramBotService_1['telegramBotService'][_0x2dc050(0x14f)](_0x3e0bd9['shopId'],_0x3e0bd9,_0x2ea6e4);}catch(_0x66461b){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x66461b);}}async[a60_0x616bc2(0x168)](_0x14966c,_0x4b0e91){const _0x3adec4=a60_0x616bc2;try{const _0x5cc80a=await database_1[_0x3adec4(0x11f)]['shop'][_0x3adec4(0x143)]({'where':{'id':_0x14966c},'select':{'gatewaySettings':!![]}});if(!_0x5cc80a?.[_0x3adec4(0x158)])return console[_0x3adec4(0x160)](_0x3adec4(0x1e6)+_0x14966c+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x211390=JSON[_0x3adec4(0x151)](_0x5cc80a['gatewaySettings']);for(const [_0x4758ed,_0x1c0d3c]of Object[_0x3adec4(0x183)](_0x211390)){if(_0x4758ed[_0x3adec4(0x133)]()===_0x4b0e91[_0x3adec4(0x133)]()){const _0x3c09c3=_0x1c0d3c[_0x3adec4(0x112)]||0xa;return console[_0x3adec4(0x160)](_0x3adec4(0x138)+_0x4b0e91+_0x3adec4(0x136)+_0x14966c+':\x20'+_0x3c09c3+'%'),_0x3c09c3;}}return console['log'](_0x3adec4(0x14a)+_0x4b0e91+'\x20in\x20shop\x20'+_0x14966c+_0x3adec4(0x152)),0xa;}catch(_0x4fa2b){return console[_0x3adec4(0x1e7)](_0x3adec4(0x1a5)+_0x14966c+',\x20gateway\x20'+_0x4b0e91+':',_0x4fa2b),0xa;}}}exports[a60_0x616bc2(0x1ad)]=WebhookService;