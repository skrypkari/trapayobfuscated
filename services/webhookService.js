'use strict';const a64_0x1a66d6=a64_0xc650;(function(_0x19c456,_0xc0003c){const _0x1b7b21=a64_0xc650,_0x90492d=_0x19c456();while(!![]){try{const _0x4829ca=-parseInt(_0x1b7b21(0x10d))/0x1*(parseInt(_0x1b7b21(0xc4))/0x2)+parseInt(_0x1b7b21(0x16b))/0x3*(parseInt(_0x1b7b21(0x99))/0x4)+-parseInt(_0x1b7b21(0xe2))/0x5+parseInt(_0x1b7b21(0x112))/0x6*(parseInt(_0x1b7b21(0xe0))/0x7)+-parseInt(_0x1b7b21(0x167))/0x8*(parseInt(_0x1b7b21(0x11b))/0x9)+parseInt(_0x1b7b21(0x195))/0xa+parseInt(_0x1b7b21(0xeb))/0xb*(-parseInt(_0x1b7b21(0x101))/0xc);if(_0x4829ca===_0xc0003c)break;else _0x90492d['push'](_0x90492d['shift']());}catch(_0x207cc4){_0x90492d['push'](_0x90492d['shift']());}}}(a64_0x15e2,0xa4f7e));function a64_0xc650(_0x397765,_0x480fbd){const _0x15e22a=a64_0x15e2();return a64_0xc650=function(_0xc650b0,_0x1dad79){_0xc650b0=_0xc650b0-0x8b;let _0x293ff2=_0x15e22a[_0xc650b0];return _0x293ff2;},a64_0xc650(_0x397765,_0x480fbd);}function a64_0x15e2(){const _0x47bb59=['paidAt','nodaService','keys','🔍\x20VISA\x20payment\x20search\x20executed','📊\x20CoinToPay\x20webhook:\x20Payment\x20','status','No\x20payment\x20ID\x20in\x20Amer\x20webhook','✅\x20Shop\x20','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','toLowerCase','gatewayOrderId','create','\x20USDT\x20(chargeback\x20penalty)','🔄\x20Processing\x20CoinToPay2\x20webhook:','📊\x20MyXSpend\x20webhook\x20data:','log','📊\x20MasterCard\x20webhook\x20result:','AmPayService','gatewayPaymentId','findMany','defineProperty','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','myxspend','system','processRapydWebhook','ℹ️\x20AmPay\x20status\x20','paymentLinkId','remitterIban','toFixed','🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:','📊\x20Amer\x20webhook:\x20Payment\x20','ampay_','\x20->\x20','amerService','🏪\x20Shop\x20','\x20commission\x20for\x20shop\x20','now','failed','🔄\x20Processing\x20AmPay\x20webhook:','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','POST','mastercard','bankId','client_transaction_id','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','✅\x20Found\x20payment:\x20ID=','💰\x20Converting\x20','💰\x20Gateway\x20','toUpperCase','PAID','NodaService','EXPIRED',',\x20GatewayOrderId=','🔄\x20Processing\x20VISA\x20webhook:','\x20(orderId:\x20','processMasterCardWebhook','no\x20balance\x20change','📤\x20Shop\x20webhook\x20sent\x20to\x20','📊\x20KLYME\x20webhook:\x20Payment\x20','rapyd','VISA\x20payment\x20not\x20found:\x20','./gateways/klymeService','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','klymeService','processVisaWebhook','Payment\x20not\x20found','\x20USDT','updatePaymentStatus','2177256OgZqOp','❌\x20Error\x20processing\x20MasterCard\x20webhook:','currency','Error\x20processing\x20Noda\x20webhook:','3FMPshV','❌\x20Error\x20processing\x20Amer\x20webhook:','paymentId','$transaction','MasterCard\x20payment\x20not\x20found:\x20','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','gateway','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','balance','📈\x20Found\x20payment\x20link\x20',',\x20gateway\x20','shopId','Error\x20processing\x20KLYME\x20webhook:','webhookUrl','\x20to\x20','🔄\x20MyXSpend\x20status\x20','findUnique','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','💰\x20Payment\x20','\x20in\x20shop\x20','desc','./gateways/rapydService','amountUSDT','Found\x20payment\x20','parse',',\x20GatewayPaymentId=','Error\x20processing\x20Plisio\x20webhook:','coinToPay2Service','COMPLETED','getGatewayCommission','processPlisioWebhook','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','payment.success','./gateways/mastercardService','includes','payment.pending','%\x20gateway\x20commission)','additionalInfo',',\x20Status=','txUrls','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','3380360dRogTP','plisioService','REFUND','./gateways/coinToPay2Service','logWebhookError','\x22,\x20orderId=\x22','processing',',\x20gatewayPaymentId:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','plisio_gateway','chargeback','ampay','Webhook\x20event\x20','🔄\x20Processing\x20Noda\x20webhook:','update','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','failureMessage','WebhookService','logWebhookProcessed','./gateways/coinToPayService','processKlymeWebhook','\x20mapped\x20to\x20FAILED','default','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','orderId','sendShopWebhook','coinToPayService','webhookLog','ℹ️\x20MyXSpend\x20status\x20','payment','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','❌\x20VISA\x20webhook\x20processing\x20failed:','processPlisioGatewayWebhook','created','cointopay','\x20for\x20MyXSpend\x20webhook','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','📊\x20VISA\x20webhook\x20result:','processCoinToPayWebhook','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','processCoinToPay2Webhook','currencyService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','plisio','No\x20payment\x20ID\x20in\x20Noda\x20webhook','paymentLink','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','./telegramBotService','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','visa_mastercard',',\x20card:\x20****',',\x20using\x20default\x2010%','CoinToPay2Service','📊\x20Payment\x20status:\x20','\x20+\x20','shop','CHARGEBACK','🔄\x20Processing\x20Amer\x20webhook:','5292988DzMFJj','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','cointopay2','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','Payment\x20System/1.0','✅\x20Found\x20payment\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','dateTime','PlisioService','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','RapydService','\x20=\x20','📝\x20Reason:\x20','MASTERCARD','VISA','processWebhook','\x20current\x20balance:\x20','\x22,\x20paymentLinkId=\x22','map','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','./gateways/nodaService','Error\x20parsing\x20webhook\x20events:','cardLast4','\x20not\x20found','💰\x20Removing\x20from\x20balance:\x20','updatedAt','stringify','🔄\x20Processing\x20Rapyd\x20webhook:','✅\x20Payment\x20link\x20','ms)','🔍\x20VISA\x20payment\x20search\x20result:\x20',':\x20type=','./loggerService','klyme','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','createdAt','❌\x20Available\x20webhook\x20fields:','🔄\x20Processing\x20KLYME\x20webhook:','./gateways/amerService',',\x20Card=****','🔄\x20Additional\x20data:','Payment\x20not\x20found:\x20','46wHCZwz','username','📊\x20Noda\x20webhook:\x20Payment\x20','AmerService','processNodaWebhook','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','webhookEvents','✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','📈\x20Payment\x20','Error\x20processing\x20Rapyd\x20webhook:','remitterName','../config/database','DECLINED','findFirst','No\x20payment\x20ID\x20in\x20VISA\x20webhook','🔄\x20Processing\x20MasterCard\x20webhook:','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','sendPaymentNotification',',\x20gatewayOrderId:\x20','type','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','🔄\x20Processing\x20MyXSpend\x20webhook:','myxspend_','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','Body\x20data:','customerName','unknown','customerOrderId','338401awGhKm','noda','1179810gWARfu','status_addition_info','processAmPayWebhook','🔍\x20Search\x20result:\x20','\x20commission:\x20','paymentMethod','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','gatewayCommissionRate','3657962VtaVRz','\x20for\x20AmPay\x20webhook','rapydService','text','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','loggerService','FAILED','\x20status\x20','convertToUSDT','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','amount','💰\x20Adding\x20to\x20balance:\x20','currentPayments','visa','Error\x20processing\x20CoinToPay\x20webhook:','✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20','\x20status\x20updated\x20to\x20FAILED','./currencyService','visa/mastercard','chargebackAmount',',\x20status=','sendPaymentStatusNotification','12uLwZYM','📊\x20AmPay\x20webhook\x20data:','❌\x20Payment\x20link\x20','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','system_id','telegramBotService','__esModule','\x20updated:\x20currentPayments=','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','error','amountAfterGatewayCommissionUSDT','9959fLoFxw','🔄\x20Processing\x20Plisio\x20webhook:','visa_','visaMasterCardService','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','78xOLucY','settings','📊\x20Plisio\x20webhook:\x20Payment\x20','Payment\x20','./gateways/ampayService','payment.failed','refund','gatewaySettings','amer','27eDzWIN','entries',',\x20newStatus=','commission','expired','\x20→\x20'];a64_0x15e2=function(){return _0x47bb59;};return a64_0x15e2();}var __importDefault=this&&this['__importDefault']||function(_0x3cede5){return _0x3cede5&&_0x3cede5['__esModule']?_0x3cede5:{'default':_0x3cede5};};Object[a64_0x1a66d6(0x135)](exports,a64_0x1a66d6(0x108),{'value':!![]}),exports[a64_0x1a66d6(0x1a8)]=void 0x0;const database_1=__importDefault(require(a64_0x1a66d6(0xcf))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a64_0x1a66d6(0x180)),nodaService_1=require(a64_0x1a66d6(0xae)),coinToPayService_1=require(a64_0x1a66d6(0x1aa)),coinToPay2Service_1=require(a64_0x1a66d6(0x198)),klymeService_1=require(a64_0x1a66d6(0x15f)),mastercardService_1=require(a64_0x1a66d6(0x18c)),amerService_1=require(a64_0x1a66d6(0xc0)),ampayService_1=require(a64_0x1a66d6(0x116)),telegramBotService_1=require(a64_0x1a66d6(0x8e)),currencyService_1=require(a64_0x1a66d6(0xfc)),loggerService_1=require(a64_0x1a66d6(0xba));class WebhookService{constructor(){const _0x2206b5=a64_0x1a66d6;this[_0x2206b5(0x196)]=new plisioService_1[(_0x2206b5(0xa2))](),this[_0x2206b5(0xed)]=new rapydService_1[(_0x2206b5(0xa4))](),this['nodaService']=new nodaService_1[(_0x2206b5(0x154))](),this[_0x2206b5(0x1b1)]=new coinToPayService_1['CoinToPayService'](),this[_0x2206b5(0x186)]=new coinToPay2Service_1[(_0x2206b5(0x93))](),this[_0x2206b5(0x162)]=new klymeService_1['KlymeService'](),this['visaMasterCardService']=new mastercardService_1['VisaMasterCardService'](),this[_0x2206b5(0x142)]=new amerService_1[(_0x2206b5(0xc7))](),this['ampayService']=new ampayService_1[(_0x2206b5(0x132))]();}async[a64_0x1a66d6(0x166)](_0x210d5c,_0x14b95b,_0xfebfbb){const _0x503dd5=a64_0x1a66d6;console['log'](_0x503dd5(0xa3)+_0x210d5c+_0x503dd5(0x11d)+_0x14b95b),console[_0x503dd5(0x130)](_0x503dd5(0xc2),_0xfebfbb),await database_1[_0x503dd5(0x1ad)][_0x503dd5(0x16e)](async _0x41764c=>{const _0x363e04=_0x503dd5,_0x5c0c38=await _0x41764c['payment'][_0x363e04(0x17b)]({'where':{'id':_0x210d5c},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5c0c38)throw new Error(_0x363e04(0x115)+_0x210d5c+_0x363e04(0xb1));const _0x1c0cae=_0x5c0c38[_0x363e04(0x126)],_0x5e2609=_0x5c0c38[_0x363e04(0x96)];console[_0x363e04(0x130)](_0x363e04(0x17d)+_0x210d5c+':\x20'+_0x1c0cae+'\x20->\x20'+_0x14b95b),console[_0x363e04(0x130)](_0x363e04(0x143)+_0x5e2609[_0x363e04(0xc5)]+_0x363e04(0xaa)+_0x5e2609[_0x363e04(0x173)]+_0x363e04(0x165));const _0x3bced3={'status':_0x14b95b[_0x363e04(0x152)](),'updatedAt':new Date(),'statusChangedBy':_0x363e04(0x138),'statusChangedAt':new Date()};_0xfebfbb?.[_0x363e04(0x1a7)]&&(_0x3bced3[_0x363e04(0x1a7)]=_0xfebfbb[_0x363e04(0x1a7)]);_0xfebfbb?.['txUrls']&&(_0x3bced3[_0x363e04(0x192)]=JSON[_0x363e04(0xb4)](_0xfebfbb[_0x363e04(0x192)]));_0xfebfbb?.['cardLast4']&&(_0x3bced3[_0x363e04(0xb0)]=_0xfebfbb[_0x363e04(0xb0)]);_0xfebfbb?.[_0x363e04(0xe7)]&&(_0x3bced3[_0x363e04(0xe7)]=_0xfebfbb[_0x363e04(0xe7)]);_0xfebfbb?.[_0x363e04(0x14c)]&&(_0x3bced3[_0x363e04(0x14c)]=_0xfebfbb[_0x363e04(0x14c)]);_0xfebfbb?.[_0x363e04(0x13c)]&&(_0x3bced3[_0x363e04(0x13c)]=_0xfebfbb[_0x363e04(0x13c)]);_0xfebfbb?.[_0x363e04(0xce)]&&(_0x3bced3[_0x363e04(0xce)]=_0xfebfbb[_0x363e04(0xce)]);let _0x5554e1=_0x5e2609[_0x363e04(0x173)],_0x59a134='';if(_0x14b95b['toUpperCase']()===_0x363e04(0x153)&&_0x1c0cae!==_0x363e04(0x153)){const _0x182003=await currencyService_1[_0x363e04(0x1c2)][_0x363e04(0xf3)](_0x5c0c38[_0x363e04(0xf5)],_0x5c0c38[_0x363e04(0x169)]),_0x18f204=await this[_0x363e04(0x188)](_0x5e2609['id'],_0x5c0c38[_0x363e04(0x171)]),_0x273e0f=_0x182003*(0x1-_0x18f204/0x64);_0x5554e1+=_0x273e0f,_0x59a134='+'+_0x273e0f[_0x363e04(0x13d)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20'+_0x18f204+_0x363e04(0x18f),_0x3bced3[_0x363e04(0x181)]=_0x182003,_0x3bced3[_0x363e04(0x10c)]=_0x273e0f,_0x3bced3[_0x363e04(0xea)]=_0x18f204,_0x3bced3[_0x363e04(0x121)]=new Date(),console['log'](_0x363e04(0x150)+_0x5c0c38[_0x363e04(0xf5)]+'\x20'+_0x5c0c38[_0x363e04(0x169)]+_0x363e04(0x141)+_0x182003['toFixed'](0x6)+_0x363e04(0x165)),console['log'](_0x363e04(0x151)+_0x5c0c38[_0x363e04(0x171)]+_0x363e04(0xe6)+_0x18f204+'%'),console['log']('💰\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x273e0f[_0x363e04(0x13d)](0x6)+_0x363e04(0x165)),console[_0x363e04(0x130)](_0x363e04(0xf6)+_0x5e2609[_0x363e04(0x173)]+_0x363e04(0x95)+_0x273e0f[_0x363e04(0x13d)](0x6)+'\x20=\x20'+_0x5554e1[_0x363e04(0x13d)](0x6)+_0x363e04(0x165));}else{if(_0x1c0cae===_0x363e04(0x153)&&_0x14b95b['toUpperCase']()!=='PAID'){let _0x30e0d6;if(_0x5c0c38[_0x363e04(0x10c)])_0x30e0d6=_0x5c0c38['amountAfterGatewayCommissionUSDT'];else{if(_0x5c0c38[_0x363e04(0x181)]){const _0x11cf42=await this[_0x363e04(0x188)](_0x5e2609['id'],_0x5c0c38[_0x363e04(0x171)]);_0x30e0d6=_0x5c0c38[_0x363e04(0x181)]*(0x1-_0x11cf42/0x64);}else console[_0x363e04(0x130)](_0x363e04(0x14e)),_0x30e0d6=0x0;}_0x30e0d6>0x0&&(_0x5554e1-=_0x30e0d6,_0x59a134='-'+_0x30e0d6[_0x363e04(0x13d)](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x3bced3[_0x363e04(0x181)]=null,_0x3bced3[_0x363e04(0x10c)]=null,_0x3bced3[_0x363e04(0x121)]=null,console['log'](_0x363e04(0xb2)+_0x5e2609[_0x363e04(0x173)]+'\x20-\x20'+_0x30e0d6[_0x363e04(0x13d)](0x6)+_0x363e04(0xa5)+_0x5554e1[_0x363e04(0x13d)](0x6)+_0x363e04(0x165)));}}if(_0x14b95b[_0x363e04(0x152)]()===_0x363e04(0x97)){const _0x3eaca4=_0xfebfbb?.[_0x363e04(0xfe)]||0x0;_0x3eaca4>0x0&&(_0x5554e1-=_0x3eaca4,_0x59a134+='\x20and\x20-'+_0x3eaca4[_0x363e04(0x13d)](0x6)+_0x363e04(0x12d),_0x3bced3[_0x363e04(0xfe)]=_0x3eaca4,console[_0x363e04(0x130)]('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0x3eaca4['toFixed'](0x6)+_0x363e04(0x165)),console[_0x363e04(0x130)]('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x5554e1[_0x363e04(0x13d)](0x6)+_0x363e04(0x165)));}const _0x36da94=await _0x41764c['payment'][_0x363e04(0x1a3)]({'where':{'id':_0x210d5c},'data':_0x3bced3});_0x5554e1!==_0x5e2609[_0x363e04(0x173)]&&(await _0x41764c[_0x363e04(0x96)][_0x363e04(0x1a3)]({'where':{'id':_0x5e2609['id']},'data':{'balance':_0x5554e1}}),console[_0x363e04(0x130)](_0x363e04(0x128)+_0x5e2609[_0x363e04(0xc5)]+'\x20balance\x20updated:\x20'+_0x5e2609[_0x363e04(0x173)][_0x363e04(0x13d)](0x6)+_0x363e04(0x141)+_0x5554e1[_0x363e04(0x13d)](0x6)+_0x363e04(0x165)),console['log'](_0x363e04(0xa6)+_0x59a134));await _0x41764c[_0x363e04(0x1b2)][_0x363e04(0x12c)]({'data':{'paymentId':_0x210d5c,'shopId':_0x5e2609['id'],'event':'webhook_status_change_'+_0x14b95b['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x363e04(0xb4)]({'oldStatus':_0x1c0cae,'newStatus':_0x14b95b[_0x363e04(0x152)](),'balanceChange':_0x59a134||_0x363e04(0x15a),'oldBalance':_0x5e2609[_0x363e04(0x173)],'newBalance':_0x5554e1,'amountUSDT':_0x3bced3[_0x363e04(0x181)],'additionalData':_0xfebfbb,'timestamp':new Date()['toISOString']()})}}),await this[_0x363e04(0x1b0)]({..._0x5c0c38,..._0x36da94,'shop':_0x5e2609},_0x14b95b[_0x363e04(0x152)]()),await this[_0x363e04(0x100)]({..._0x5c0c38,..._0x36da94},_0x14b95b[_0x363e04(0x152)]());if(_0x1c0cae!=='PAID'&&_0x14b95b[_0x363e04(0x152)]()===_0x363e04(0x153)){console[_0x363e04(0x130)](_0x363e04(0xcc)+_0x210d5c+_0x363e04(0xd4)),console['log']('📈\x20Payment\x20details:\x20oldStatus=\x22'+_0x1c0cae+'\x22,\x20newStatus=\x22'+_0x14b95b[_0x363e04(0x152)]()+_0x363e04(0xab)+_0x5c0c38[_0x363e04(0x13b)]+'\x22');if(_0x5c0c38[_0x363e04(0x13b)])try{const _0x53c830=await _0x41764c[_0x363e04(0x8c)][_0x363e04(0x17b)]({'where':{'id':_0x5c0c38[_0x363e04(0x13b)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x53c830){console[_0x363e04(0x130)](_0x363e04(0x174)+_0x53c830['id']+_0x363e04(0xb9)+_0x53c830[_0x363e04(0xd7)]+',\x20currentPayments='+_0x53c830['currentPayments']+_0x363e04(0xff)+_0x53c830[_0x363e04(0x126)]);const _0x1c0e52=_0x53c830['currentPayments']+0x1,_0xc7f6c8=_0x53c830[_0x363e04(0xd7)]==='SINGLE'?_0x363e04(0x187):_0x53c830[_0x363e04(0x126)];await _0x41764c[_0x363e04(0x8c)]['update']({'where':{'id':_0x5c0c38['paymentLinkId']},'data':{'currentPayments':_0x1c0e52,'status':_0xc7f6c8,'updatedAt':new Date()}}),console[_0x363e04(0x130)](_0x363e04(0xb6)+_0x53c830['id']+_0x363e04(0x109)+_0x53c830[_0x363e04(0xf7)]+_0x363e04(0x141)+_0x1c0e52+_0x363e04(0xff)+_0x53c830[_0x363e04(0x126)]+_0x363e04(0x141)+_0xc7f6c8);}else console[_0x363e04(0x130)](_0x363e04(0x103)+_0x5c0c38[_0x363e04(0x13b)]+_0x363e04(0xb1));}catch(_0x35d0d4){console[_0x363e04(0x10b)](_0x363e04(0xef),_0x35d0d4);}else console['log'](_0x363e04(0xcc)+_0x210d5c+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0x363e04(0x130)]('📈\x20Payment\x20'+_0x210d5c+'\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20'+_0x1c0cae+_0x363e04(0x141)+_0x14b95b[_0x363e04(0x152)]());});}async[a64_0x1a66d6(0x189)](_0xbe443c){const _0x5db04b=a64_0x1a66d6;console[_0x5db04b(0x130)](_0x5db04b(0x10e),_0xbe443c);try{const _0x5f53a3=await this[_0x5db04b(0x196)][_0x5db04b(0xa9)](_0xbe443c);if(!_0x5f53a3[_0x5db04b(0x16d)])throw new Error(_0x5db04b(0x172));const _0x2538d1=await database_1['default'][_0x5db04b(0x1b4)]['findFirst']({'where':{'gatewayOrderId':_0x5f53a3[_0x5db04b(0x16d)]}});if(!_0x2538d1){console[_0x5db04b(0x10b)](_0x5db04b(0xe9)+_0x5f53a3[_0x5db04b(0x16d)]);return;}console[_0x5db04b(0x130)](_0x5db04b(0x114)+_0x2538d1['id']+_0x5db04b(0xf2)+_0x5f53a3[_0x5db04b(0x126)]),await this[_0x5db04b(0x166)](_0x2538d1['id'],_0x5f53a3[_0x5db04b(0x126)],{'txUrls':_0x5f53a3[_0x5db04b(0x192)]}),loggerService_1['loggerService'][_0x5db04b(0x1a9)](_0x5db04b(0x1c4),_0x2538d1['id'],_0x2538d1[_0x5db04b(0x126)],_0x5f53a3[_0x5db04b(0x126)],_0xbe443c);}catch(_0x347633){console[_0x5db04b(0x10b)](_0x5db04b(0x185),_0x347633),loggerService_1['loggerService']['logWebhookError'](_0x5db04b(0x1c4),_0x347633,_0xbe443c);throw _0x347633;}}async[a64_0x1a66d6(0x1b8)](_0x4fb932){const _0x547d81=a64_0x1a66d6;console['log'](_0x547d81(0x1bf),_0x4fb932);try{const _0x3aa946=await this[_0x547d81(0x196)]['processWebhook'](_0x4fb932);if(!_0x3aa946['paymentId'])throw new Error(_0x547d81(0x1a6));const _0x2c024a=await database_1['default'][_0x547d81(0x1b4)][_0x547d81(0xd1)]({'where':{'gatewayOrderId':_0x3aa946[_0x547d81(0x16d)]}});if(!_0x2c024a){console[_0x547d81(0x10b)]('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x3aa946['paymentId']);return;}console[_0x547d81(0x130)](_0x547d81(0x129)+_0x2c024a['id']+_0x547d81(0xf2)+_0x3aa946['status']),await this[_0x547d81(0x166)](_0x2c024a['id'],_0x3aa946[_0x547d81(0x126)],{'txUrls':_0x3aa946[_0x547d81(0x192)]}),loggerService_1['loggerService'][_0x547d81(0x1a9)](_0x547d81(0x19e),_0x2c024a['id'],_0x2c024a[_0x547d81(0x126)],_0x3aa946[_0x547d81(0x126)],_0x4fb932);}catch(_0x1e1f9a){console[_0x547d81(0x10b)](_0x547d81(0x1b5),_0x1e1f9a),loggerService_1[_0x547d81(0xf0)][_0x547d81(0x199)](_0x547d81(0x19e),_0x1e1f9a,_0x4fb932);throw _0x1e1f9a;}}async[a64_0x1a66d6(0x139)](_0x4326fe){const _0x2f1662=a64_0x1a66d6;console['log'](_0x2f1662(0xb5),_0x4326fe);try{const _0x3cd070=await this[_0x2f1662(0xed)][_0x2f1662(0xa9)](_0x4326fe);if(!_0x3cd070['paymentId'])throw new Error(_0x2f1662(0x1ae));const _0x1aeb20=await database_1['default']['payment']['findFirst']({'where':{'gatewayOrderId':_0x3cd070['paymentId']}});if(!_0x1aeb20){console[_0x2f1662(0x10b)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x3cd070[_0x2f1662(0x16d)]);return;}console[_0x2f1662(0x130)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x1aeb20['id']+_0x2f1662(0xf2)+_0x3cd070[_0x2f1662(0x126)]),await this['updatePaymentStatus'](_0x1aeb20['id'],_0x3cd070[_0x2f1662(0x126)],{'failureMessage':_0x3cd070[_0x2f1662(0x1a7)],'cardLast4':_0x3cd070['additionalInfo']?.[_0x2f1662(0xb0)],'paymentMethod':_0x3cd070['additionalInfo']?.[_0x2f1662(0xe7)]}),loggerService_1[_0x2f1662(0xf0)][_0x2f1662(0x1a9)](_0x2f1662(0x15d),_0x1aeb20['id'],_0x1aeb20[_0x2f1662(0x126)],_0x3cd070['status'],_0x4326fe);}catch(_0x325219){console[_0x2f1662(0x10b)](_0x2f1662(0xcd),_0x325219),loggerService_1['loggerService']['logWebhookError']('rapyd',_0x325219,_0x4326fe);throw _0x325219;}}async[a64_0x1a66d6(0xc8)](_0x5f4745){const _0x3cb0d8=a64_0x1a66d6;console[_0x3cb0d8(0x130)](_0x3cb0d8(0x1a2),_0x5f4745);try{const _0x470aa6=await this[_0x3cb0d8(0x122)][_0x3cb0d8(0xa9)](_0x5f4745);if(!_0x470aa6[_0x3cb0d8(0x16d)])throw new Error(_0x3cb0d8(0x8b));const _0x51a84e=await database_1['default'][_0x3cb0d8(0x1b4)][_0x3cb0d8(0xd1)]({'where':{'gatewayOrderId':_0x470aa6[_0x3cb0d8(0x16d)]}});if(!_0x51a84e){console[_0x3cb0d8(0x10b)](_0x3cb0d8(0xdb)+_0x470aa6[_0x3cb0d8(0x16d)]);return;}console[_0x3cb0d8(0x130)](_0x3cb0d8(0xc6)+_0x51a84e['id']+_0x3cb0d8(0xf2)+_0x470aa6[_0x3cb0d8(0x126)]),await this[_0x3cb0d8(0x166)](_0x51a84e['id'],_0x470aa6[_0x3cb0d8(0x126)],{'bankId':_0x470aa6['additionalInfo']?.['bankId'],'remitterIban':_0x470aa6[_0x3cb0d8(0x190)]?.['remitterIban'],'remitterName':_0x470aa6['additionalInfo']?.[_0x3cb0d8(0xce)]}),loggerService_1[_0x3cb0d8(0xf0)][_0x3cb0d8(0x1a9)](_0x3cb0d8(0xe1),_0x51a84e['id'],_0x51a84e[_0x3cb0d8(0x126)],_0x470aa6[_0x3cb0d8(0x126)],_0x5f4745);}catch(_0x351000){console[_0x3cb0d8(0x10b)](_0x3cb0d8(0x16a),_0x351000),loggerService_1['loggerService'][_0x3cb0d8(0x199)]('noda',_0x351000,_0x5f4745);throw _0x351000;}}async[a64_0x1a66d6(0x1be)](_0x47dce9){const _0x391108=a64_0x1a66d6;console['log']('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x47dce9);try{const _0x5508bb=await this['coinToPayService'][_0x391108(0xa9)](_0x47dce9);if(!_0x5508bb['paymentId'])throw new Error(_0x391108(0xf4));const _0x3907ec=await database_1[_0x391108(0x1ad)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x5508bb[_0x391108(0x16d)]}});if(!_0x3907ec){console[_0x391108(0x10b)](_0x391108(0x149)+_0x5508bb[_0x391108(0x16d)]);return;}console[_0x391108(0x130)](_0x391108(0x125)+_0x3907ec['id']+_0x391108(0xf2)+_0x5508bb[_0x391108(0x126)]),await this[_0x391108(0x166)](_0x3907ec['id'],_0x5508bb[_0x391108(0x126)]),loggerService_1[_0x391108(0xf0)][_0x391108(0x1a9)](_0x391108(0x1ba),_0x3907ec['id'],_0x3907ec[_0x391108(0x126)],_0x5508bb[_0x391108(0x126)],_0x47dce9);}catch(_0x46108b){console[_0x391108(0x10b)](_0x391108(0xf9),_0x46108b),loggerService_1[_0x391108(0xf0)][_0x391108(0x199)](_0x391108(0x1ba),_0x46108b,_0x47dce9);throw _0x46108b;}}async[a64_0x1a66d6(0x1c1)](_0x171604){const _0x529858=a64_0x1a66d6;console[_0x529858(0x130)](_0x529858(0x12e),_0x171604);try{const _0xfcfcf4=await this[_0x529858(0x186)]['processWebhook'](_0x171604);if(!_0xfcfcf4['paymentId'])throw new Error(_0x529858(0x9c));const _0x402bac=await database_1[_0x529858(0x1ad)][_0x529858(0x1b4)]['findFirst']({'where':{'gatewayOrderId':_0xfcfcf4[_0x529858(0x16d)]}});if(!_0x402bac){console[_0x529858(0x10b)]('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0xfcfcf4['paymentId']);return;}console[_0x529858(0x130)](_0x529858(0x136)+_0x402bac['id']+_0x529858(0xf2)+_0xfcfcf4['status']),await this[_0x529858(0x166)](_0x402bac['id'],_0xfcfcf4['status']),loggerService_1[_0x529858(0xf0)][_0x529858(0x1a9)](_0x529858(0x9b),_0x402bac['id'],_0x402bac['status'],_0xfcfcf4[_0x529858(0x126)],_0x171604);}catch(_0x9e5d5c){console[_0x529858(0x10b)]('Error\x20processing\x20CoinToPay2\x20webhook:',_0x9e5d5c),loggerService_1[_0x529858(0xf0)][_0x529858(0x199)](_0x529858(0x9b),_0x9e5d5c,_0x171604);throw _0x9e5d5c;}}async[a64_0x1a66d6(0x1ab)](_0x3d2c91){const _0x5d8d3f=a64_0x1a66d6;console[_0x5d8d3f(0x130)](_0x5d8d3f(0xbf),_0x3d2c91);try{const _0x3c2953=await this[_0x5d8d3f(0x162)][_0x5d8d3f(0xa9)](_0x3d2c91);if(!_0x3c2953[_0x5d8d3f(0x16d)])throw new Error(_0x5d8d3f(0x148));const _0x6e04b3=await database_1['default'][_0x5d8d3f(0x1b4)][_0x5d8d3f(0xd1)]({'where':{'gatewayOrderId':_0x3c2953['paymentId']}});if(!_0x6e04b3){console[_0x5d8d3f(0x10b)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x3c2953[_0x5d8d3f(0x16d)]);return;}console[_0x5d8d3f(0x130)](_0x5d8d3f(0x15c)+_0x6e04b3['id']+'\x20status\x20'+_0x3c2953['status']),await this[_0x5d8d3f(0x166)](_0x6e04b3['id'],_0x3c2953[_0x5d8d3f(0x126)],{'paymentMethod':_0x3c2953[_0x5d8d3f(0x190)]?.['payment_method']}),loggerService_1[_0x5d8d3f(0xf0)][_0x5d8d3f(0x1a9)](_0x5d8d3f(0xbb),_0x6e04b3['id'],_0x6e04b3[_0x5d8d3f(0x126)],_0x3c2953[_0x5d8d3f(0x126)],_0x3d2c91);}catch(_0x3d4dbf){console[_0x5d8d3f(0x10b)](_0x5d8d3f(0x177),_0x3d4dbf),loggerService_1[_0x5d8d3f(0xf0)][_0x5d8d3f(0x199)](_0x5d8d3f(0xbb),_0x3d4dbf,_0x3d2c91);throw _0x3d4dbf;}}async[a64_0x1a66d6(0x163)](_0x2c3513){const _0x54e2ad=a64_0x1a66d6;console['log'](_0x54e2ad(0x157),JSON[_0x54e2ad(0xb4)](_0x2c3513,null,0x2));try{const _0x457b94=await this[_0x54e2ad(0x110)][_0x54e2ad(0xa9)](_0x2c3513,_0x54e2ad(0xa8));console['log'](_0x54e2ad(0x1bd),_0x457b94);if(!_0x457b94[_0x54e2ad(0x16d)]){console[_0x54e2ad(0x10b)](_0x54e2ad(0xad)),console[_0x54e2ad(0x10b)]('❌\x20Available\x20webhook\x20fields:',Object['keys'](_0x2c3513));throw new Error(_0x54e2ad(0xd2));}let _0x3ce955=null;console[_0x54e2ad(0x130)](_0x54e2ad(0x1b6)+_0x457b94[_0x54e2ad(0x16d)]);if(_0x457b94[_0x54e2ad(0x16d)]){console[_0x54e2ad(0x130)](_0x54e2ad(0xbc)),console[_0x54e2ad(0x130)]('🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:'),console['log'](_0x54e2ad(0x105)),console['log'](_0x54e2ad(0x8d)+_0x457b94[_0x54e2ad(0x16d)]),console['log'](_0x54e2ad(0x160)),_0x3ce955=await database_1[_0x54e2ad(0x1ad)][_0x54e2ad(0x1b4)]['findFirst']({'where':{'AND':[{'OR':[{'gateway':_0x54e2ad(0xfd)},{'gateway':'mastercard'}]},{'OR':[{'gatewayPaymentId':_0x457b94[_0x54e2ad(0x16d)]},{'gatewayOrderId':_0x457b94[_0x54e2ad(0x16d)]},{'id':_0x457b94[_0x54e2ad(0x16d)]},{'orderId':_0x457b94[_0x54e2ad(0x16d)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x54e2ad(0x130)](_0x54e2ad(0x124));if(_0x3ce955)console['log'](_0x54e2ad(0x14f)+_0x3ce955['id']+_0x54e2ad(0x156)+_0x3ce955[_0x54e2ad(0x12b)]+_0x54e2ad(0x184)+_0x3ce955[_0x54e2ad(0x133)]);else{console[_0x54e2ad(0x130)]('❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...');const _0x167c29=await database_1[_0x54e2ad(0x1ad)][_0x54e2ad(0x1b4)][_0x54e2ad(0x134)]({'where':{'gateway':_0x54e2ad(0xfd)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x54e2ad(0x17f)}});console[_0x54e2ad(0x130)](_0x54e2ad(0x13e),_0x167c29[_0x54e2ad(0xac)](_0x4ec008=>_0x4ec008['id']+_0x54e2ad(0x158)+_0x4ec008['orderId']+_0x54e2ad(0xd6)+_0x4ec008[_0x54e2ad(0x12b)]+_0x54e2ad(0x19c)+_0x4ec008[_0x54e2ad(0x133)]+_0x54e2ad(0x91)+_0x4ec008[_0x54e2ad(0xb0)]+')'));}console[_0x54e2ad(0x130)](_0x54e2ad(0xb8)+(_0x3ce955?'Found':'Not\x20found')),_0x3ce955&&console['log']('🔍\x20Found\x20VISA\x20payment:\x20ID='+_0x3ce955['id']+',\x20Gateway='+_0x3ce955['gateway']+_0x54e2ad(0x191)+_0x3ce955[_0x54e2ad(0x126)]+_0x54e2ad(0xc1)+_0x3ce955[_0x54e2ad(0xb0)]);}if(!_0x3ce955){console['error'](_0x54e2ad(0x1c0)+_0x457b94[_0x54e2ad(0x16d)]),loggerService_1[_0x54e2ad(0xf0)]['logWebhookError'](_0x54e2ad(0xf8),new Error(_0x54e2ad(0xc3)+_0x457b94[_0x54e2ad(0x16d)]),_0x2c3513);throw new Error(_0x54e2ad(0x15e)+_0x457b94[_0x54e2ad(0x16d)]);}console[_0x54e2ad(0x130)]('📊\x20VISA\x20payment\x20found:\x20'+_0x3ce955['id']+'\x20(Status:\x20'+_0x3ce955[_0x54e2ad(0x126)]+_0x54e2ad(0x120)+_0x457b94[_0x54e2ad(0x126)]+')');const _0xd00392={};_0x457b94['amount']&&await database_1[_0x54e2ad(0x1ad)][_0x54e2ad(0x1b4)][_0x54e2ad(0x1a3)]({'where':{'id':_0x3ce955['id']},'data':{'amount':_0x457b94['amount'],'updatedAt':new Date()}}),_0x457b94[_0x54e2ad(0x169)]&&await database_1['default']['payment'][_0x54e2ad(0x1a3)]({'where':{'id':_0x3ce955['id']},'data':{'currency':_0x457b94[_0x54e2ad(0x169)],'updatedAt':new Date()}}),_0x457b94['status']===_0x54e2ad(0xf1)&&_0x457b94[_0x54e2ad(0x1a7)]&&(_0xd00392[_0x54e2ad(0x1a7)]=_0x457b94[_0x54e2ad(0x1a7)],console[_0x54e2ad(0x130)]('❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20'+_0x457b94[_0x54e2ad(0x1a7)])),_0xd00392[_0x54e2ad(0xe7)]='visa',await this['updatePaymentStatus'](_0x3ce955['id'],_0x457b94[_0x54e2ad(0x126)],_0xd00392),await database_1[_0x54e2ad(0x1ad)][_0x54e2ad(0x1b2)][_0x54e2ad(0x12c)]({'data':{'paymentId':_0x3ce955['id'],'shopId':_0x3ce955['shopId'],'event':_0x54e2ad(0x10f)+_0x457b94[_0x54e2ad(0x126)][_0x54e2ad(0x12a)](),'statusCode':0xc8,'responseBody':JSON[_0x54e2ad(0xb4)](_0x457b94)}}),await this[_0x54e2ad(0x100)](_0x3ce955,_0x457b94[_0x54e2ad(0x126)]['toUpperCase']()),console['log'](_0x54e2ad(0x111)+_0x3ce955['id']);}catch(_0x19b252){console['error'](_0x54e2ad(0x1b7),_0x19b252),loggerService_1[_0x54e2ad(0xf0)]['logWebhookError'](_0x54e2ad(0xf8),_0x19b252,_0x2c3513);throw _0x19b252;}}async[a64_0x1a66d6(0x159)](_0x36ecb6){const _0x783940=a64_0x1a66d6;console[_0x783940(0x130)](_0x783940(0xd3),JSON['stringify'](_0x36ecb6,null,0x2));try{const _0x3b6401=await this[_0x783940(0x110)]['processWebhook'](_0x36ecb6,_0x783940(0xa7));console['log'](_0x783940(0x131),_0x3b6401);if(!_0x3b6401['paymentId']){console['error']('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data'),console[_0x783940(0x10b)](_0x783940(0xbe),Object[_0x783940(0x123)](_0x36ecb6));throw new Error(_0x783940(0xa0));}let _0x334118=null;console[_0x783940(0x130)]('🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x3b6401[_0x783940(0x16d)]);_0x3b6401['paymentId']&&(console[_0x783940(0x130)](_0x783940(0x194)),_0x334118=await database_1[_0x783940(0x1ad)][_0x783940(0x1b4)][_0x783940(0xd1)]({'where':{'AND':[{'OR':[{'gateway':'visa_mastercard'},{'gateway':'mastercard'},{'gateway':_0x783940(0xfd)}]},{'OR':[{'gatewayPaymentId':_0x3b6401[_0x783940(0x16d)]},{'gatewayOrderId':_0x3b6401['paymentId']},{'id':_0x3b6401[_0x783940(0x16d)]},{'orderId':_0x3b6401[_0x783940(0x16d)]}]}]}}),console[_0x783940(0x130)](_0x783940(0xe5)+(_0x334118?_0x783940(0x182)+_0x334118['id']:_0x783940(0x164))));if(!_0x334118){console[_0x783940(0x10b)](_0x783940(0x104)+_0x3b6401[_0x783940(0x16d)]),console[_0x783940(0x10b)](_0x783940(0x9d)+_0x3b6401[_0x783940(0x16d)]+'\x22,\x20id=\x22'+_0x3b6401[_0x783940(0x16d)]+_0x783940(0x19a)+_0x3b6401[_0x783940(0x16d)]+'\x22');const _0x5aafa6=await database_1[_0x783940(0x1ad)][_0x783940(0x1b4)][_0x783940(0x134)]({'where':{'OR':[{'gateway':_0x783940(0x14b)},{'gateway':_0x783940(0x90)},{'gateway':'visa/mastercard'}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':'desc'},'take':0xf});console[_0x783940(0x130)](_0x783940(0x161),_0x5aafa6),loggerService_1[_0x783940(0xf0)][_0x783940(0x199)](_0x783940(0x14b),new Error(_0x783940(0xc3)+_0x3b6401[_0x783940(0x16d)]),_0x36ecb6);throw new Error(_0x783940(0x16f)+_0x3b6401[_0x783940(0x16d)]);}console[_0x783940(0x130)](_0x783940(0x9f)+_0x334118['id']+'\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20'+_0x334118[_0x783940(0x126)]+_0x783940(0x179)+_0x3b6401['status']);const _0x286911={};_0x3b6401[_0x783940(0xf5)]&&await database_1[_0x783940(0x1ad)][_0x783940(0x1b4)][_0x783940(0x1a3)]({'where':{'id':_0x334118['id']},'data':{'amount':_0x3b6401[_0x783940(0xf5)],'updatedAt':new Date()}}),_0x3b6401[_0x783940(0x169)]&&await database_1[_0x783940(0x1ad)][_0x783940(0x1b4)][_0x783940(0x1a3)]({'where':{'id':_0x334118['id']},'data':{'currency':_0x3b6401[_0x783940(0x169)],'updatedAt':new Date()}}),_0x3b6401[_0x783940(0x126)]===_0x783940(0xf1)&&_0x3b6401['failureMessage']&&(_0x286911['failureMessage']=_0x3b6401[_0x783940(0x1a7)],console[_0x783940(0x130)](_0x783940(0x1a5)+_0x3b6401[_0x783940(0x1a7)])),_0x286911[_0x783940(0xe7)]=_0x783940(0x14b),await this['updatePaymentStatus'](_0x334118['id'],_0x3b6401[_0x783940(0x126)],_0x286911),loggerService_1[_0x783940(0xf0)]['logWebhookProcessed'](_0x783940(0x14b),_0x334118['id'],_0x334118[_0x783940(0x126)],_0x3b6401[_0x783940(0x126)],_0x36ecb6);}catch(_0xd8fe91){console['error'](_0x783940(0x168),_0xd8fe91),loggerService_1[_0x783940(0xf0)][_0x783940(0x199)](_0x783940(0x14b),_0xd8fe91,_0x36ecb6);throw _0xd8fe91;}}async['processAmerWebhook'](_0x1ce4d2){const _0x3ca065=a64_0x1a66d6;console['log'](_0x3ca065(0x98),JSON[_0x3ca065(0xb4)](_0x1ce4d2,null,0x2));try{const _0x2e1f34=await this[_0x3ca065(0x142)][_0x3ca065(0xa9)](_0x1ce4d2);console['log']('📊\x20Amer\x20webhook\x20result:',_0x2e1f34);if(!_0x2e1f34[_0x3ca065(0x16d)]){console['error'](_0x3ca065(0x18a)),console[_0x3ca065(0x10b)](_0x3ca065(0xbe),Object[_0x3ca065(0x123)](_0x1ce4d2));throw new Error(_0x3ca065(0x127));}let _0x4ee082=null;console[_0x3ca065(0x130)](_0x3ca065(0x1bc)+_0x2e1f34[_0x3ca065(0x16d)]),_0x4ee082=await database_1[_0x3ca065(0x1ad)]['payment'][_0x3ca065(0xd1)]({'where':{'AND':[{'gateway':_0x3ca065(0x11a)},{'OR':[{'gatewayPaymentId':_0x2e1f34[_0x3ca065(0x16d)]},{'gatewayOrderId':_0x2e1f34[_0x3ca065(0x16d)]},{'id':_0x2e1f34[_0x3ca065(0x16d)]},{'orderId':_0x2e1f34[_0x3ca065(0x16d)]}]}]}}),console['log'](_0x3ca065(0xe5)+(_0x4ee082?_0x3ca065(0x182)+_0x4ee082['id']:_0x3ca065(0x164)));if(!_0x4ee082){console[_0x3ca065(0x10b)]('❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20'+_0x2e1f34[_0x3ca065(0x16d)]);return;}console[_0x3ca065(0x130)](_0x3ca065(0x13f)+_0x4ee082['id']+_0x3ca065(0xf2)+_0x2e1f34[_0x3ca065(0x126)]),await this[_0x3ca065(0x166)](_0x4ee082['id'],_0x2e1f34[_0x3ca065(0x126)],{'cardLast4':_0x2e1f34[_0x3ca065(0x190)]?.[_0x3ca065(0xb0)],'paymentMethod':_0x2e1f34['additionalInfo']?.[_0x3ca065(0xe7)]});}catch(_0x47abe6){console[_0x3ca065(0x10b)](_0x3ca065(0x16c),_0x47abe6),loggerService_1[_0x3ca065(0xf0)][_0x3ca065(0x199)]('amer',_0x47abe6,_0x1ce4d2);throw _0x47abe6;}}async[a64_0x1a66d6(0xe4)](_0x3932b6){const _0x2001ee=a64_0x1a66d6;console[_0x2001ee(0x130)](_0x2001ee(0x147),JSON[_0x2001ee(0xb4)](_0x3932b6,null,0x2));try{const _0x4b305c=_0x3932b6['status'],_0x3ca7da=_0x3932b6[_0x2001ee(0x14d)],_0x1de5a8=_0x3932b6[_0x2001ee(0x106)],_0x3eb889=_0x3932b6['payment_method'],_0x44a836=_0x3932b6[_0x2001ee(0xf5)],_0x4075b9=_0x3932b6['currency'],_0xc73205=_0x3932b6[_0x2001ee(0x11e)],_0xd042f3=_0x3932b6[_0x2001ee(0xe3)];if(!_0x3ca7da){console[_0x2001ee(0x10b)](_0x2001ee(0x1a4));throw new Error(_0x2001ee(0xc9));}console[_0x2001ee(0x130)](_0x2001ee(0x102),{'status':_0x4b305c,'clientTransactionId':_0x3ca7da,'systemId':_0x1de5a8,'paymentMethod':_0x3eb889,'amount':_0x44a836,'currency':_0x4075b9,'commission':_0xc73205,'statusAdditionInfo':_0xd042f3});const _0x1849a4=await database_1[_0x2001ee(0x1ad)][_0x2001ee(0x1b4)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x3ca7da},{'orderId':_0x3ca7da},{'id':_0x3ca7da},{'gatewayPaymentId':_0x3ca7da}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1849a4){console['error'](_0x2001ee(0x10a)+_0x3ca7da);throw new Error(_0x2001ee(0xc3)+_0x3ca7da);}console[_0x2001ee(0x130)](_0x2001ee(0x9f)+_0x1849a4['id']+_0x2001ee(0xec)),console[_0x2001ee(0x130)](_0x2001ee(0x94)+_0x1849a4[_0x2001ee(0x126)]+_0x2001ee(0x120)+_0x4b305c),_0x4b305c===_0x2001ee(0xd0)?(console['log'](_0x2001ee(0x193)),await this[_0x2001ee(0x166)](_0x1849a4['id'],_0x2001ee(0xf1)),console[_0x2001ee(0x130)](_0x2001ee(0xfa)+_0x1849a4['id']+_0x2001ee(0xfb)),console[_0x2001ee(0x130)]('ℹ️\x20Decline\x20reason:\x20'+(_0xd042f3||'No\x20additional\x20info'))):console[_0x2001ee(0x130)](_0x2001ee(0x13a)+_0x4b305c+'\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)'),await database_1[_0x2001ee(0x1ad)][_0x2001ee(0x1b2)][_0x2001ee(0x12c)]({'data':{'paymentId':_0x1849a4['id'],'shopId':_0x1849a4[_0x2001ee(0x176)],'event':_0x2001ee(0x140)+(_0x4b305c?.['toLowerCase']()||'unknown'),'statusCode':0xc8,'responseBody':JSON[_0x2001ee(0xb4)](_0x3932b6)}}),loggerService_1[_0x2001ee(0xf0)][_0x2001ee(0x1a9)](_0x2001ee(0x1a0),_0x1849a4['id'],_0x1849a4['status'],_0x4b305c===_0x2001ee(0xd0)?'FAILED':_0x4b305c,_0x3932b6);}catch(_0x1e215d){console['error']('❌\x20Error\x20processing\x20AmPay\x20webhook:',_0x1e215d),loggerService_1['loggerService'][_0x2001ee(0x199)](_0x2001ee(0x1a0),_0x1e215d,_0x3932b6);throw _0x1e215d;}}async[a64_0x1a66d6(0x1b0)](_0x809d3d,_0xde49c7){const _0x542729=a64_0x1a66d6,_0x3eaac9=Date['now']();try{const _0x53c835=_0x809d3d[_0x542729(0x96)],_0x215792=_0x53c835[_0x542729(0x113)];if(!_0x215792?.[_0x542729(0x178)]){console[_0x542729(0x130)](_0x542729(0x1c3)+_0x53c835['id']);return;}const _0x2766ce=_0xde49c7===_0x542729(0x153)?_0x542729(0x18b):_0xde49c7===_0x542729(0xf1)?'payment.failed':_0xde49c7==='EXPIRED'?_0x542729(0x117):_0xde49c7===_0x542729(0x97)?_0x542729(0x117):_0xde49c7===_0x542729(0x197)?_0x542729(0x117):_0x542729(0x18e);let _0xbffe65=[];if(_0x215792[_0x542729(0xca)])try{_0xbffe65=Array['isArray'](_0x215792['webhookEvents'])?_0x215792[_0x542729(0xca)]:JSON[_0x542729(0x183)](_0x215792[_0x542729(0xca)]);}catch(_0x5884e3){console[_0x542729(0x10b)](_0x542729(0xaf),_0x5884e3),_0xbffe65=[];}if(!_0xbffe65[_0x542729(0x18d)](_0x2766ce)){console[_0x542729(0x130)](_0x542729(0x1a1)+_0x2766ce+'\x20not\x20enabled\x20for\x20shop\x20'+_0x53c835['id']);return;}const _0x3b426c={'event':_0x2766ce,'payment':{'id':_0x809d3d['id'],'order_id':_0x809d3d[_0x542729(0x1af)],'gateway_order_id':_0x809d3d[_0x542729(0x12b)],'gateway':_0x809d3d['gateway'],'amount':_0x809d3d[_0x542729(0xf5)],'currency':_0x809d3d[_0x542729(0x169)],'status':_0xde49c7[_0x542729(0x12a)](),'customer_email':_0x809d3d['customerEmail'],'customer_name':_0x809d3d[_0x542729(0xdd)],'failure_message':_0x809d3d[_0x542729(0x1a7)],'tx_urls':_0x809d3d[_0x542729(0x192)]?JSON[_0x542729(0x183)](_0x809d3d[_0x542729(0x192)]):null,'created_at':_0x809d3d[_0x542729(0xbd)],'updated_at':_0x809d3d[_0x542729(0xb3)]}},_0x33ba00=await fetch(_0x215792[_0x542729(0x178)],{'method':_0x542729(0x14a),'headers':{'Content-Type':'application/json','User-Agent':_0x542729(0x9e)},'body':JSON['stringify'](_0x3b426c)}),_0x5c9e37=Date[_0x542729(0x145)]()-_0x3eaac9,_0x3d8aed=_0x33ba00['ok']?'Success':await _0x33ba00[_0x542729(0xee)]();loggerService_1[_0x542729(0xf0)]['logShopWebhookSent'](_0x809d3d[_0x542729(0x176)],_0x215792['webhookUrl'],_0x2766ce,_0x33ba00[_0x542729(0x126)],_0x5c9e37,_0x3b426c),console[_0x542729(0x130)](_0x542729(0x15b)+_0x215792[_0x542729(0x178)]+'\x20with\x20status\x20'+_0x33ba00['status']+'\x20('+_0x5c9e37+_0x542729(0xb7));}catch(_0x573c31){console[_0x542729(0x10b)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x573c31),loggerService_1[_0x542729(0xf0)]['logShopWebhookError'](_0x809d3d[_0x542729(0x176)],_0x809d3d[_0x542729(0x96)]?.[_0x542729(0x113)]?.['webhookUrl']||_0x542729(0xde),'webhook_send',_0x573c31,{});}}async[a64_0x1a66d6(0x100)](_0x161827,_0x4d8d9f){const _0x533635=a64_0x1a66d6;try{const _0x5164dc={'PENDING':_0x533635(0x1b9),'PROCESSING':_0x533635(0x19b),'PAID':'paid','FAILED':_0x533635(0x146),'EXPIRED':_0x533635(0x11f),'REFUND':_0x533635(0x118),'CHARGEBACK':_0x533635(0x19f)},_0x293bc5=_0x5164dc[_0x4d8d9f];if(!_0x293bc5||_0x293bc5===_0x533635(0x1b9))return;await telegramBotService_1[_0x533635(0x107)][_0x533635(0xd5)](_0x161827['shopId'],_0x161827,_0x293bc5);}catch(_0x5d520e){console[_0x533635(0x10b)](_0x533635(0x19d),_0x5d520e);}}async[a64_0x1a66d6(0x188)](_0x4b3e8c,_0x358379){const _0xa62b35=a64_0x1a66d6;try{const _0x286ee7=await database_1[_0xa62b35(0x1ad)][_0xa62b35(0x96)][_0xa62b35(0x17b)]({'where':{'id':_0x4b3e8c},'select':{'gatewaySettings':!![]}});if(!_0x286ee7?.[_0xa62b35(0x119)])return console[_0xa62b35(0x130)](_0xa62b35(0x9a)+_0x4b3e8c+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x3bf400=JSON[_0xa62b35(0x183)](_0x286ee7['gatewaySettings']);for(const [_0x38fd3a,_0x31a150]of Object[_0xa62b35(0x11c)](_0x3bf400)){if(_0x38fd3a['toLowerCase']()===_0x358379['toLowerCase']()){const _0x584fec=_0x31a150[_0xa62b35(0x11e)]||0xa;return console[_0xa62b35(0x130)]('Gateway\x20'+_0x358379+_0xa62b35(0x144)+_0x4b3e8c+':\x20'+_0x584fec+'%'),_0x584fec;}}return console[_0xa62b35(0x130)]('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0x358379+_0xa62b35(0x17e)+_0x4b3e8c+_0xa62b35(0x92)),0xa;}catch(_0x527a2b){return console[_0xa62b35(0x10b)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x4b3e8c+_0xa62b35(0x175)+_0x358379+':',_0x527a2b),0xa;}}async['processMyXSpendWebhook'](_0x24d3b7,_0x48c651){const _0x45923c=a64_0x1a66d6;console[_0x45923c(0x130)](_0x45923c(0xd9)),console[_0x45923c(0x130)]('Query\x20params:',JSON['stringify'](_0x24d3b7,null,0x2)),console[_0x45923c(0x130)](_0x45923c(0xdc),JSON[_0x45923c(0xb4)](_0x48c651,null,0x2));try{const _0x1dbb3e=_0x24d3b7[_0x45923c(0xdf)]||_0x48c651[_0x45923c(0xdf)],_0x167e5a=_0x24d3b7['status']||_0x48c651['status'],_0x301e76=_0x24d3b7[_0x45923c(0xf5)]||_0x48c651[_0x45923c(0xf5)],_0x4b8221=_0x24d3b7['currency']||_0x48c651[_0x45923c(0x169)],_0x148cbc=_0x24d3b7[_0x45923c(0xa1)]||_0x48c651[_0x45923c(0xa1)];if(!_0x1dbb3e){console[_0x45923c(0x10b)](_0x45923c(0xe8));throw new Error(_0x45923c(0x17c));}console[_0x45923c(0x130)](_0x45923c(0x12f),{'customerOrderId':_0x1dbb3e,'status':_0x167e5a,'amount':_0x301e76,'currency':_0x4b8221,'dateTime':_0x148cbc});const _0x186e1e=await database_1[_0x45923c(0x1ad)]['payment'][_0x45923c(0xd1)]({'where':{'OR':[{'gatewayOrderId':_0x1dbb3e},{'orderId':_0x1dbb3e},{'id':_0x1dbb3e},{'gatewayPaymentId':_0x1dbb3e}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x186e1e){console['error'](_0x45923c(0x170)+_0x1dbb3e);throw new Error('Payment\x20not\x20found:\x20'+_0x1dbb3e);}console['log'](_0x45923c(0x9f)+_0x186e1e['id']+_0x45923c(0x1bb)),console[_0x45923c(0x130)](_0x45923c(0x94)+_0x186e1e[_0x45923c(0x126)]+_0x45923c(0x120)+_0x167e5a);let _0x267e9b=_0x167e5a?.[_0x45923c(0x152)]();_0x167e5a==='FAILED'||_0x167e5a===_0x45923c(0x155)?(_0x267e9b=_0x45923c(0xf1),console[_0x45923c(0x130)](_0x45923c(0x17a)+_0x167e5a+_0x45923c(0x1ac)),await this['updatePaymentStatus'](_0x186e1e['id'],_0x267e9b),console[_0x45923c(0x130)](_0x45923c(0xcb)+_0x186e1e['id']+'\x20status\x20updated\x20to\x20FAILED')):console[_0x45923c(0x130)](_0x45923c(0x1b3)+_0x167e5a+_0x45923c(0xd8)),await database_1[_0x45923c(0x1ad)]['webhookLog']['create']({'data':{'paymentId':_0x186e1e['id'],'shopId':_0x186e1e[_0x45923c(0x176)],'event':_0x45923c(0xda)+(_0x167e5a?.['toLowerCase']()||_0x45923c(0xde)),'statusCode':0xc8,'responseBody':JSON[_0x45923c(0xb4)]({'queryParams':_0x24d3b7,'bodyData':_0x48c651})}}),loggerService_1[_0x45923c(0xf0)]['logWebhookProcessed'](_0x45923c(0x137),_0x186e1e['id'],_0x186e1e[_0x45923c(0x126)],_0x267e9b||_0x167e5a,{'queryParams':_0x24d3b7,'bodyData':_0x48c651});}catch(_0x16b8da){console['error'](_0x45923c(0x8f),_0x16b8da),loggerService_1[_0x45923c(0xf0)][_0x45923c(0x199)]('myxspend',_0x16b8da,{'queryParams':_0x24d3b7,'bodyData':_0x48c651});throw _0x16b8da;}}}exports[a64_0x1a66d6(0x1a8)]=WebhookService;