'use strict';function a58_0x1632(){const _0x248ffc=['txUrls','processCoinToPay2Webhook',',\x20status=','coinToPay2Service','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','📊\x20CoinToPay\x20webhook:\x20Payment\x20','payment','update','1923060gZnxlC','balance','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','webhook_status_change_','webhookEvents',',\x20currentPayments=','rapydService','📊\x20MasterCard\x20webhook\x20result:','FAILED','🔄\x20Processing\x20KLYME\x20webhook:','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','📝\x20Reason:\x20','webhookLog','cointopay2','username','payment.failed','2055210RHzIbr','includes','cardLast4','currency','Payment\x20not\x20found','🔄\x20Processing\x20CoinToPay\x20webhook:','unknown','📊\x20Rapyd\x20webhook:\x20Payment\x20','🔄\x20Processing\x20CoinToPay2\x20webhook:','status','toUpperCase','klymeService','chargeback','logShopWebhookSent','shopId','webhookUrl','TesSoft\x20Payment\x20System/1.0','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','CoinToPayService','PAID','💰\x20Removing\x20from\x20balance:\x20','klyme','remitterName','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','Error\x20processing\x20CoinToPay\x20webhook:','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','📊\x20Plisio\x20webhook:\x20Payment\x20','PlisioService','currencyService','./gateways/mastercardService','CoinToPay2Service','noda','refund','mastercard','\x22,\x20id=\x22','log','coinToPayService','plisio_gateway','16CSHJlq','Error\x20parsing\x20webhook\x20events:','parse','WebhookService','💰\x20Converting\x20','✅\x20Shop\x20','processCoinToPayWebhook','❌\x20Error\x20processing\x20MasterCard\x20webhook:','436413MsJQyy','isArray','MasterCardService','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','9584408wlaoEh','sendShopWebhook','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','nodaService','\x20and\x20-','\x20->\x20','SINGLE','created','logWebhookProcessed','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','default','paymentMethod','gateway','./gateways/coinToPay2Service','../config/database','currentPayments','shop','create','4865189KjytzP','CHARGEBACK','✅\x20Found\x20payment\x20','paymentId','\x20+\x20','failureMessage','\x20USDT','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','Success','6788406CgEBQB','type','paid','rapyd','convertToUSDT','ms)','Payment\x20','processMasterCardWebhook','\x20current\x20balance:\x20','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','🔄\x20Additional\x20data:','now','🔍\x20Search\x20result:\x20','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','./gateways/rapydService','processing','./gateways/klymeService','✅\x20Payment\x20link\x20','loggerService','updatePaymentStatus','\x20not\x20found','📊\x20Noda\x20webhook:\x20Payment\x20','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','\x20updated:\x20currentPayments=','📈\x20Payment\x20','masterCardService','💸\x20Additional\x20chargeback\x20penalty:\x20-','additionalInfo','processWebhook','REFUND','cointopay','toFixed','application/json','./gateways/coinToPayService','logWebhookError','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','findFirst','payment.pending','processPlisioGatewayWebhook','__esModule','chargebackAmount','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','EXPIRED','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','payment_method','sendPaymentStatusNotification','\x20to\x20','findUnique','\x20USDT\x20(chargeback\x20penalty)','Webhook\x20event\x20','KlymeService','amountUSDT','customerEmail','system','./telegramBotService','plisio','NodaService','./gateways/nodaService','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:',',\x20newStatus=',':\x20type=','logShopWebhookError','Failed\x20to\x20send\x20shop\x20webhook:','toISOString','./gateways/plisioService','\x20status\x20','customerName','💰\x20Payment\x20','telegramBotService','plisioService','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','remitterIban','amount','expired','\x20USDT\x20(payment\x20became\x20PAID)','paymentLinkId','❌\x20Available\x20webhook\x20fields:','stringify','\x22,\x20newStatus=\x22','\x20=\x20','error','\x20-\x20','settings','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','paidAt','🔄\x20Processing\x20MasterCard\x20webhook:','No\x20payment\x20ID\x20in\x20Noda\x20webhook','📤\x20Shop\x20webhook\x20sent\x20to\x20','\x20balance\x20updated:\x20','14664WnMsGW','findMany','orderId','📊\x20KLYME\x20webhook:\x20Payment\x20','paymentLink','❌\x20Payment\x20link\x20','sendPaymentNotification','bankId','webhook_send','createdAt','Found\x20payment\x20','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','💰\x20Adding\x20to\x20balance:\x20','updatedAt','Error\x20processing\x20Plisio\x20webhook:','processNodaWebhook'];a58_0x1632=function(){return _0x248ffc;};return a58_0x1632();}const a58_0x977efa=a58_0x4832;(function(_0x39a761,_0x41acf2){const _0x1dc0eb=a58_0x4832,_0x495d7a=_0x39a761();while(!![]){try{const _0x33507a=parseInt(_0x1dc0eb(0x192))/0x1*(-parseInt(_0x1dc0eb(0x212))/0x2)+-parseInt(_0x1dc0eb(0x19a))/0x3+parseInt(_0x1dc0eb(0x22b))/0x4+-parseInt(_0x1dc0eb(0x16c))/0x5+-parseInt(_0x1dc0eb(0x1b9))/0x6+parseInt(_0x1dc0eb(0x1b0))/0x7+parseInt(_0x1dc0eb(0x19e))/0x8;if(_0x33507a===_0x41acf2)break;else _0x495d7a['push'](_0x495d7a['shift']());}catch(_0x5c5e68){_0x495d7a['push'](_0x495d7a['shift']());}}}(a58_0x1632,0x8ad29));function a58_0x4832(_0x472ac4,_0xcfbff7){const _0x1632ef=a58_0x1632();return a58_0x4832=function(_0x483267,_0x4b514c){_0x483267=_0x483267-0x15d;let _0x5e59a9=_0x1632ef[_0x483267];return _0x5e59a9;},a58_0x4832(_0x472ac4,_0xcfbff7);}var __importDefault=this&&this['__importDefault']||function(_0x211001){const _0x2ba8c4=a58_0x4832;return _0x211001&&_0x211001[_0x2ba8c4(0x1e0)]?_0x211001:{'default':_0x211001};};Object['defineProperty'](exports,a58_0x977efa(0x1e0),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a58_0x977efa(0x1ac))),plisioService_1=require(a58_0x977efa(0x1f9)),rapydService_1=require(a58_0x977efa(0x1c7)),nodaService_1=require(a58_0x977efa(0x1f2)),coinToPayService_1=require(a58_0x977efa(0x1da)),coinToPay2Service_1=require(a58_0x977efa(0x1ab)),klymeService_1=require(a58_0x977efa(0x1c9)),mastercardService_1=require(a58_0x977efa(0x189)),telegramBotService_1=require(a58_0x977efa(0x1ef)),currencyService_1=require('./currencyService'),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x583c43=a58_0x977efa;this[_0x583c43(0x1fe)]=new plisioService_1[(_0x583c43(0x187))](),this['rapydService']=new rapydService_1['RapydService'](),this[_0x583c43(0x1a1)]=new nodaService_1[(_0x583c43(0x1f1))](),this['coinToPayService']=new coinToPayService_1[(_0x583c43(0x17e))](),this[_0x583c43(0x226)]=new coinToPay2Service_1[(_0x583c43(0x18a))](),this[_0x583c43(0x177)]=new klymeService_1[(_0x583c43(0x1eb))](),this[_0x583c43(0x1d2)]=new mastercardService_1[(_0x583c43(0x19c))]();}async['updatePaymentStatus'](_0x42e88c,_0x3aa0e6,_0x39c265){const _0x4e5976=a58_0x977efa;console[_0x4e5976(0x18f)]('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x42e88c+_0x4e5976(0x1f4)+_0x3aa0e6),console[_0x4e5976(0x18f)](_0x4e5976(0x1c3),_0x39c265),await database_1[_0x4e5976(0x1a8)]['$transaction'](async _0xac8e6e=>{const _0x2715c8=_0x4e5976,_0x5d688b=await _0xac8e6e[_0x2715c8(0x229)]['findUnique']({'where':{'id':_0x42e88c},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5d688b)throw new Error(_0x2715c8(0x1bf)+_0x42e88c+'\x20not\x20found');const _0x2cc1f5=_0x5d688b[_0x2715c8(0x175)],_0x1f00c1=_0x5d688b['shop'];console[_0x2715c8(0x18f)](_0x2715c8(0x1fc)+_0x42e88c+':\x20'+_0x2cc1f5+_0x2715c8(0x1a3)+_0x3aa0e6),console[_0x2715c8(0x18f)]('🏪\x20Shop\x20'+_0x1f00c1[_0x2715c8(0x16a)]+_0x2715c8(0x1c1)+_0x1f00c1[_0x2715c8(0x22c)]+_0x2715c8(0x1b6));const _0x3570c0={'status':_0x3aa0e6[_0x2715c8(0x176)](),'updatedAt':new Date(),'statusChangedBy':_0x2715c8(0x1ee),'statusChangedAt':new Date()};_0x39c265?.[_0x2715c8(0x1b5)]&&(_0x3570c0[_0x2715c8(0x1b5)]=_0x39c265[_0x2715c8(0x1b5)]);_0x39c265?.[_0x2715c8(0x223)]&&(_0x3570c0[_0x2715c8(0x223)]=JSON['stringify'](_0x39c265[_0x2715c8(0x223)]));_0x39c265?.['cardLast4']&&(_0x3570c0[_0x2715c8(0x16e)]=_0x39c265[_0x2715c8(0x16e)]);_0x39c265?.['paymentMethod']&&(_0x3570c0['paymentMethod']=_0x39c265[_0x2715c8(0x1a9)]);_0x39c265?.['bankId']&&(_0x3570c0[_0x2715c8(0x219)]=_0x39c265[_0x2715c8(0x219)]);_0x39c265?.[_0x2715c8(0x200)]&&(_0x3570c0[_0x2715c8(0x200)]=_0x39c265[_0x2715c8(0x200)]);_0x39c265?.[_0x2715c8(0x182)]&&(_0x3570c0[_0x2715c8(0x182)]=_0x39c265[_0x2715c8(0x182)]);let _0x3db659=_0x1f00c1[_0x2715c8(0x22c)],_0x463ae8='';if(_0x3aa0e6[_0x2715c8(0x176)]()===_0x2715c8(0x17f)&&_0x2cc1f5!==_0x2715c8(0x17f)){const _0x130e7d=await currencyService_1[_0x2715c8(0x188)][_0x2715c8(0x1bd)](_0x5d688b[_0x2715c8(0x201)],_0x5d688b[_0x2715c8(0x16f)]);_0x3db659+=_0x130e7d,_0x463ae8='+'+_0x130e7d[_0x2715c8(0x1d8)](0x6)+_0x2715c8(0x203),_0x3570c0[_0x2715c8(0x1ec)]=_0x130e7d,_0x3570c0[_0x2715c8(0x20d)]=new Date(),console[_0x2715c8(0x18f)](_0x2715c8(0x196)+_0x5d688b['amount']+'\x20'+_0x5d688b[_0x2715c8(0x16f)]+'\x20->\x20'+_0x130e7d[_0x2715c8(0x1d8)](0x6)+_0x2715c8(0x1b6)),console[_0x2715c8(0x18f)](_0x2715c8(0x21f)+_0x1f00c1[_0x2715c8(0x22c)]+_0x2715c8(0x1b4)+_0x130e7d['toFixed'](0x6)+_0x2715c8(0x208)+_0x3db659['toFixed'](0x6)+_0x2715c8(0x1b6));}else{if(_0x2cc1f5===_0x2715c8(0x17f)&&_0x3aa0e6[_0x2715c8(0x176)]()!=='PAID'){const _0x10a1a1=_0x5d688b[_0x2715c8(0x1ec)];_0x10a1a1&&(_0x3db659-=_0x10a1a1,_0x463ae8='-'+_0x10a1a1['toFixed'](0x6)+_0x2715c8(0x1a0),_0x3570c0[_0x2715c8(0x1ec)]=null,_0x3570c0[_0x2715c8(0x20d)]=null,console[_0x2715c8(0x18f)](_0x2715c8(0x180)+_0x1f00c1[_0x2715c8(0x22c)]+_0x2715c8(0x20a)+_0x10a1a1[_0x2715c8(0x1d8)](0x6)+'\x20=\x20'+_0x3db659[_0x2715c8(0x1d8)](0x6)+'\x20USDT'));}}if(_0x3aa0e6[_0x2715c8(0x176)]()==='CHARGEBACK'){const _0x51517a=_0x39c265?.[_0x2715c8(0x1e1)]||0x0;_0x51517a>0x0&&(_0x3db659-=_0x51517a,_0x463ae8+=_0x2715c8(0x1a2)+_0x51517a[_0x2715c8(0x1d8)](0x6)+_0x2715c8(0x1e9),_0x3570c0['chargebackAmount']=_0x51517a,console[_0x2715c8(0x18f)](_0x2715c8(0x1d3)+_0x51517a[_0x2715c8(0x1d8)](0x6)+_0x2715c8(0x1b6)),console[_0x2715c8(0x18f)]('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x3db659['toFixed'](0x6)+'\x20USDT'));}const _0x501a2a=await _0xac8e6e[_0x2715c8(0x229)]['update']({'where':{'id':_0x42e88c},'data':_0x3570c0});_0x3db659!==_0x1f00c1[_0x2715c8(0x22c)]&&(await _0xac8e6e[_0x2715c8(0x1ae)][_0x2715c8(0x22a)]({'where':{'id':_0x1f00c1['id']},'data':{'balance':_0x3db659}}),console['log'](_0x2715c8(0x197)+_0x1f00c1['username']+_0x2715c8(0x211)+_0x1f00c1[_0x2715c8(0x22c)][_0x2715c8(0x1d8)](0x6)+_0x2715c8(0x1a3)+_0x3db659[_0x2715c8(0x1d8)](0x6)+_0x2715c8(0x1b6)),console['log'](_0x2715c8(0x167)+_0x463ae8));await _0xac8e6e[_0x2715c8(0x168)][_0x2715c8(0x1af)]({'data':{'paymentId':_0x42e88c,'shopId':_0x1f00c1['id'],'event':_0x2715c8(0x15e)+_0x3aa0e6['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x2715c8(0x206)]({'oldStatus':_0x2cc1f5,'newStatus':_0x3aa0e6[_0x2715c8(0x176)](),'balanceChange':_0x463ae8||'no\x20balance\x20change','oldBalance':_0x1f00c1[_0x2715c8(0x22c)],'newBalance':_0x3db659,'amountUSDT':_0x3570c0['amountUSDT'],'additionalData':_0x39c265,'timestamp':new Date()[_0x2715c8(0x1f8)]()})}}),await this[_0x2715c8(0x19f)]({..._0x5d688b,..._0x501a2a,'shop':_0x1f00c1},_0x3aa0e6[_0x2715c8(0x176)]()),await this[_0x2715c8(0x1e6)]({..._0x5d688b,..._0x501a2a},_0x3aa0e6['toUpperCase']());if(_0x2cc1f5!==_0x2715c8(0x17f)&&_0x3aa0e6[_0x2715c8(0x176)]()===_0x2715c8(0x17f)){console[_0x2715c8(0x18f)](_0x2715c8(0x1d1)+_0x42e88c+_0x2715c8(0x17d)),console[_0x2715c8(0x18f)]('📈\x20Payment\x20details:\x20oldStatus=\x22'+_0x2cc1f5+_0x2715c8(0x207)+_0x3aa0e6[_0x2715c8(0x176)]()+'\x22,\x20paymentLinkId=\x22'+_0x5d688b[_0x2715c8(0x204)]+'\x22');if(_0x5d688b[_0x2715c8(0x204)])try{const _0x43f9fe=await _0xac8e6e[_0x2715c8(0x216)][_0x2715c8(0x1e8)]({'where':{'id':_0x5d688b[_0x2715c8(0x204)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x43f9fe){console['log']('📈\x20Found\x20payment\x20link\x20'+_0x43f9fe['id']+_0x2715c8(0x1f5)+_0x43f9fe[_0x2715c8(0x1ba)]+_0x2715c8(0x160)+_0x43f9fe[_0x2715c8(0x1ad)]+_0x2715c8(0x225)+_0x43f9fe[_0x2715c8(0x175)]);const _0x13ed64=_0x43f9fe['currentPayments']+0x1,_0x586d0f=_0x43f9fe['type']===_0x2715c8(0x1a4)?'COMPLETED':_0x43f9fe[_0x2715c8(0x175)];await _0xac8e6e['paymentLink']['update']({'where':{'id':_0x5d688b[_0x2715c8(0x204)]},'data':{'currentPayments':_0x13ed64,'status':_0x586d0f,'updatedAt':new Date()}}),console[_0x2715c8(0x18f)](_0x2715c8(0x1ca)+_0x43f9fe['id']+_0x2715c8(0x1d0)+_0x43f9fe['currentPayments']+_0x2715c8(0x1a3)+_0x13ed64+_0x2715c8(0x225)+_0x43f9fe['status']+_0x2715c8(0x1a3)+_0x586d0f);}else console['log'](_0x2715c8(0x217)+_0x5d688b[_0x2715c8(0x204)]+_0x2715c8(0x1cd));}catch(_0x387efe){console[_0x2715c8(0x209)](_0x2715c8(0x165),_0x387efe);}else console[_0x2715c8(0x18f)]('📈\x20Payment\x20'+_0x42e88c+_0x2715c8(0x1e4));}else console[_0x2715c8(0x18f)](_0x2715c8(0x1d1)+_0x42e88c+'\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20'+_0x2cc1f5+_0x2715c8(0x1a3)+_0x3aa0e6[_0x2715c8(0x176)]());});}async['processPlisioWebhook'](_0x25094e){const _0x150042=a58_0x977efa;console[_0x150042(0x18f)]('🔄\x20Processing\x20Plisio\x20webhook:',_0x25094e);try{const _0x3a8e47=await this[_0x150042(0x1fe)][_0x150042(0x1d5)](_0x25094e);if(!_0x3a8e47['paymentId'])throw new Error(_0x150042(0x1cf));const _0x572ba8=await database_1[_0x150042(0x1a8)][_0x150042(0x229)][_0x150042(0x1dd)]({'where':{'gatewayOrderId':_0x3a8e47[_0x150042(0x1b3)]}});if(!_0x572ba8){console['error'](_0x150042(0x1c6)+_0x3a8e47[_0x150042(0x1b3)]);return;}console[_0x150042(0x18f)](_0x150042(0x186)+_0x572ba8['id']+_0x150042(0x1fa)+_0x3a8e47[_0x150042(0x175)]),await this[_0x150042(0x1cc)](_0x572ba8['id'],_0x3a8e47[_0x150042(0x175)],{'txUrls':_0x3a8e47[_0x150042(0x223)]}),loggerService_1[_0x150042(0x1cb)][_0x150042(0x1a6)]('plisio',_0x572ba8['id'],_0x572ba8[_0x150042(0x175)],_0x3a8e47[_0x150042(0x175)],_0x25094e);}catch(_0x12a88a){console[_0x150042(0x209)](_0x150042(0x221),_0x12a88a),loggerService_1[_0x150042(0x1cb)][_0x150042(0x1db)](_0x150042(0x1f0),_0x12a88a,_0x25094e);throw _0x12a88a;}}async[a58_0x977efa(0x1df)](_0x5bc4a3){const _0x371a16=a58_0x977efa;console[_0x371a16(0x18f)](_0x371a16(0x1dc),_0x5bc4a3);try{const _0xa2381=await this[_0x371a16(0x1fe)][_0x371a16(0x1d5)](_0x5bc4a3);if(!_0xa2381[_0x371a16(0x1b3)])throw new Error(_0x371a16(0x20c));const _0x57d593=await database_1[_0x371a16(0x1a8)]['payment'][_0x371a16(0x1dd)]({'where':{'gatewayOrderId':_0xa2381['paymentId']}});if(!_0x57d593){console['error'](_0x371a16(0x1b7)+_0xa2381[_0x371a16(0x1b3)]);return;}console[_0x371a16(0x18f)](_0x371a16(0x1a7)+_0x57d593['id']+_0x371a16(0x1fa)+_0xa2381[_0x371a16(0x175)]),await this[_0x371a16(0x1cc)](_0x57d593['id'],_0xa2381[_0x371a16(0x175)],{'txUrls':_0xa2381[_0x371a16(0x223)]}),loggerService_1['loggerService']['logWebhookProcessed'](_0x371a16(0x191),_0x57d593['id'],_0x57d593['status'],_0xa2381[_0x371a16(0x175)],_0x5bc4a3);}catch(_0x455922){console['error']('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x455922),loggerService_1[_0x371a16(0x1cb)][_0x371a16(0x1db)](_0x371a16(0x191),_0x455922,_0x5bc4a3);throw _0x455922;}}async['processRapydWebhook'](_0x459c65){const _0x548cd1=a58_0x977efa;console[_0x548cd1(0x18f)]('🔄\x20Processing\x20Rapyd\x20webhook:',_0x459c65);try{const _0x17088f=await this[_0x548cd1(0x161)]['processWebhook'](_0x459c65);if(!_0x17088f[_0x548cd1(0x1b3)])throw new Error(_0x548cd1(0x15d));const _0x4b22ba=await database_1[_0x548cd1(0x1a8)][_0x548cd1(0x229)]['findFirst']({'where':{'gatewayOrderId':_0x17088f[_0x548cd1(0x1b3)]}});if(!_0x4b22ba){console[_0x548cd1(0x209)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x17088f['paymentId']);return;}console['log'](_0x548cd1(0x173)+_0x4b22ba['id']+_0x548cd1(0x1fa)+_0x17088f[_0x548cd1(0x175)]),await this['updatePaymentStatus'](_0x4b22ba['id'],_0x17088f[_0x548cd1(0x175)],{'failureMessage':_0x17088f[_0x548cd1(0x1b5)],'cardLast4':_0x17088f[_0x548cd1(0x1d4)]?.['cardLast4'],'paymentMethod':_0x17088f[_0x548cd1(0x1d4)]?.[_0x548cd1(0x1a9)]}),loggerService_1[_0x548cd1(0x1cb)][_0x548cd1(0x1a6)](_0x548cd1(0x1bc),_0x4b22ba['id'],_0x4b22ba[_0x548cd1(0x175)],_0x17088f[_0x548cd1(0x175)],_0x459c65);}catch(_0x4ab290){console[_0x548cd1(0x209)]('Error\x20processing\x20Rapyd\x20webhook:',_0x4ab290),loggerService_1[_0x548cd1(0x1cb)][_0x548cd1(0x1db)](_0x548cd1(0x1bc),_0x4ab290,_0x459c65);throw _0x4ab290;}}async[a58_0x977efa(0x222)](_0x267bfe){const _0x38c64d=a58_0x977efa;console[_0x38c64d(0x18f)]('🔄\x20Processing\x20Noda\x20webhook:',_0x267bfe);try{const _0x57dc58=await this[_0x38c64d(0x1a1)][_0x38c64d(0x1d5)](_0x267bfe);if(!_0x57dc58['paymentId'])throw new Error(_0x38c64d(0x20f));const _0x1aa158=await database_1[_0x38c64d(0x1a8)][_0x38c64d(0x229)][_0x38c64d(0x1dd)]({'where':{'gatewayOrderId':_0x57dc58[_0x38c64d(0x1b3)]}});if(!_0x1aa158){console[_0x38c64d(0x209)](_0x38c64d(0x21e)+_0x57dc58[_0x38c64d(0x1b3)]);return;}console[_0x38c64d(0x18f)](_0x38c64d(0x1ce)+_0x1aa158['id']+'\x20status\x20'+_0x57dc58[_0x38c64d(0x175)]),await this[_0x38c64d(0x1cc)](_0x1aa158['id'],_0x57dc58[_0x38c64d(0x175)],{'bankId':_0x57dc58[_0x38c64d(0x1d4)]?.['bankId'],'remitterIban':_0x57dc58[_0x38c64d(0x1d4)]?.[_0x38c64d(0x200)],'remitterName':_0x57dc58[_0x38c64d(0x1d4)]?.['remitterName']}),loggerService_1[_0x38c64d(0x1cb)][_0x38c64d(0x1a6)](_0x38c64d(0x18b),_0x1aa158['id'],_0x1aa158[_0x38c64d(0x175)],_0x57dc58[_0x38c64d(0x175)],_0x267bfe);}catch(_0x2005f2){console['error']('Error\x20processing\x20Noda\x20webhook:',_0x2005f2),loggerService_1[_0x38c64d(0x1cb)][_0x38c64d(0x1db)](_0x38c64d(0x18b),_0x2005f2,_0x267bfe);throw _0x2005f2;}}async[a58_0x977efa(0x198)](_0x2bd33d){const _0x56f34b=a58_0x977efa;console['log'](_0x56f34b(0x171),_0x2bd33d);try{const _0x4a6496=await this[_0x56f34b(0x190)][_0x56f34b(0x1d5)](_0x2bd33d);if(!_0x4a6496[_0x56f34b(0x1b3)])throw new Error(_0x56f34b(0x1c2));const _0x37e20c=await database_1[_0x56f34b(0x1a8)][_0x56f34b(0x229)][_0x56f34b(0x1dd)]({'where':{'gatewayOrderId':_0x4a6496[_0x56f34b(0x1b3)]}});if(!_0x37e20c){console[_0x56f34b(0x209)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x4a6496[_0x56f34b(0x1b3)]);return;}console[_0x56f34b(0x18f)](_0x56f34b(0x228)+_0x37e20c['id']+_0x56f34b(0x1fa)+_0x4a6496[_0x56f34b(0x175)]),await this[_0x56f34b(0x1cc)](_0x37e20c['id'],_0x4a6496[_0x56f34b(0x175)]),loggerService_1[_0x56f34b(0x1cb)][_0x56f34b(0x1a6)](_0x56f34b(0x1d7),_0x37e20c['id'],_0x37e20c[_0x56f34b(0x175)],_0x4a6496[_0x56f34b(0x175)],_0x2bd33d);}catch(_0x3427ea){console['error'](_0x56f34b(0x184),_0x3427ea),loggerService_1[_0x56f34b(0x1cb)][_0x56f34b(0x1db)]('cointopay',_0x3427ea,_0x2bd33d);throw _0x3427ea;}}async[a58_0x977efa(0x224)](_0x3d853d){const _0x5d08b9=a58_0x977efa;console[_0x5d08b9(0x18f)](_0x5d08b9(0x174),_0x3d853d);try{const _0x5103d9=await this[_0x5d08b9(0x226)]['processWebhook'](_0x3d853d);if(!_0x5103d9[_0x5d08b9(0x1b3)])throw new Error(_0x5d08b9(0x183));const _0x3afb9f=await database_1[_0x5d08b9(0x1a8)][_0x5d08b9(0x229)][_0x5d08b9(0x1dd)]({'where':{'gatewayOrderId':_0x5103d9[_0x5d08b9(0x1b3)]}});if(!_0x3afb9f){console[_0x5d08b9(0x209)]('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x5103d9[_0x5d08b9(0x1b3)]);return;}console[_0x5d08b9(0x18f)]('📊\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x3afb9f['id']+_0x5d08b9(0x1fa)+_0x5103d9[_0x5d08b9(0x175)]),await this['updatePaymentStatus'](_0x3afb9f['id'],_0x5103d9['status']),loggerService_1['loggerService'][_0x5d08b9(0x1a6)](_0x5d08b9(0x169),_0x3afb9f['id'],_0x3afb9f[_0x5d08b9(0x175)],_0x5103d9[_0x5d08b9(0x175)],_0x3d853d);}catch(_0x41e102){console[_0x5d08b9(0x209)]('Error\x20processing\x20CoinToPay2\x20webhook:',_0x41e102),loggerService_1[_0x5d08b9(0x1cb)][_0x5d08b9(0x1db)](_0x5d08b9(0x169),_0x41e102,_0x3d853d);throw _0x41e102;}}async['processKlymeWebhook'](_0x55b6cb){const _0x3e74d6=a58_0x977efa;console[_0x3e74d6(0x18f)](_0x3e74d6(0x164),_0x55b6cb);try{const _0x205f1a=await this[_0x3e74d6(0x177)][_0x3e74d6(0x1d5)](_0x55b6cb);if(!_0x205f1a[_0x3e74d6(0x1b3)])throw new Error(_0x3e74d6(0x227));const _0x46751f=await database_1[_0x3e74d6(0x1a8)][_0x3e74d6(0x229)][_0x3e74d6(0x1dd)]({'where':{'gatewayOrderId':_0x205f1a['paymentId']}});if(!_0x46751f){console['error']('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x205f1a[_0x3e74d6(0x1b3)]);return;}console[_0x3e74d6(0x18f)](_0x3e74d6(0x215)+_0x46751f['id']+'\x20status\x20'+_0x205f1a['status']),await this[_0x3e74d6(0x1cc)](_0x46751f['id'],_0x205f1a[_0x3e74d6(0x175)],{'paymentMethod':_0x205f1a[_0x3e74d6(0x1d4)]?.[_0x3e74d6(0x1e5)]}),loggerService_1[_0x3e74d6(0x1cb)]['logWebhookProcessed'](_0x3e74d6(0x181),_0x46751f['id'],_0x46751f[_0x3e74d6(0x175)],_0x205f1a[_0x3e74d6(0x175)],_0x55b6cb);}catch(_0x4ece72){console['error']('Error\x20processing\x20KLYME\x20webhook:',_0x4ece72),loggerService_1[_0x3e74d6(0x1cb)][_0x3e74d6(0x1db)](_0x3e74d6(0x181),_0x4ece72,_0x55b6cb);throw _0x4ece72;}}async[a58_0x977efa(0x1c0)](_0x26fcae){const _0x4568dc=a58_0x977efa;console[_0x4568dc(0x18f)](_0x4568dc(0x20e),JSON[_0x4568dc(0x206)](_0x26fcae,null,0x2));try{const _0x2b9c6d=await this[_0x4568dc(0x1d2)][_0x4568dc(0x1d5)](_0x26fcae);console['log'](_0x4568dc(0x162),_0x2b9c6d);if(!_0x2b9c6d[_0x4568dc(0x1b3)]){console['error'](_0x4568dc(0x21d)),console['error'](_0x4568dc(0x205),Object['keys'](_0x26fcae));throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');}let _0x452cab=null;console[_0x4568dc(0x18f)](_0x4568dc(0x1ff)+_0x2b9c6d['paymentId']);_0x2b9c6d['paymentId']&&(console[_0x4568dc(0x18f)](_0x4568dc(0x19d)),_0x452cab=await database_1[_0x4568dc(0x1a8)][_0x4568dc(0x229)]['findFirst']({'where':{'AND':[{'gateway':_0x4568dc(0x18d)},{'OR':[{'gatewayPaymentId':_0x2b9c6d[_0x4568dc(0x1b3)]},{'gatewayOrderId':_0x2b9c6d[_0x4568dc(0x1b3)]},{'id':_0x2b9c6d[_0x4568dc(0x1b3)]},{'orderId':_0x2b9c6d[_0x4568dc(0x1b3)]}]}]}}),console[_0x4568dc(0x18f)](_0x4568dc(0x1c5)+(_0x452cab?_0x4568dc(0x21c)+_0x452cab['id']:_0x4568dc(0x170))));if(!_0x452cab){console[_0x4568dc(0x209)](_0x4568dc(0x166)+_0x2b9c6d[_0x4568dc(0x1b3)]),console[_0x4568dc(0x209)](_0x4568dc(0x185)+_0x2b9c6d[_0x4568dc(0x1b3)]+_0x4568dc(0x18e)+_0x2b9c6d[_0x4568dc(0x1b3)]+'\x22,\x20orderId=\x22'+_0x2b9c6d[_0x4568dc(0x1b3)]+'\x22');const _0x569f43=await database_1[_0x4568dc(0x1a8)][_0x4568dc(0x229)][_0x4568dc(0x213)]({'where':{'gateway':_0x4568dc(0x18d)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x4568dc(0x18f)](_0x4568dc(0x1f3),_0x569f43);return;}console[_0x4568dc(0x18f)](_0x4568dc(0x1b2)+_0x452cab['id']+'\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20'+_0x452cab['status']+_0x4568dc(0x1e7)+_0x2b9c6d[_0x4568dc(0x175)]),await this[_0x4568dc(0x1cc)](_0x452cab['id'],_0x2b9c6d[_0x4568dc(0x175)]),loggerService_1[_0x4568dc(0x1cb)][_0x4568dc(0x1a6)](_0x4568dc(0x18d),_0x452cab['id'],_0x452cab['status'],_0x2b9c6d[_0x4568dc(0x175)],_0x26fcae);}catch(_0x5da9b3){console['error'](_0x4568dc(0x199),_0x5da9b3),loggerService_1['loggerService'][_0x4568dc(0x1db)](_0x4568dc(0x18d),_0x5da9b3,_0x26fcae);throw _0x5da9b3;}}async[a58_0x977efa(0x19f)](_0x2185bb,_0x11b3b3){const _0x513bc2=a58_0x977efa,_0x10a979=Date[_0x513bc2(0x1c4)]();try{const _0x58ade6=_0x2185bb[_0x513bc2(0x1ae)],_0xdc2960=_0x58ade6[_0x513bc2(0x20b)];if(!_0xdc2960?.[_0x513bc2(0x17b)]){console[_0x513bc2(0x18f)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x58ade6['id']);return;}const _0x54b6fa=_0x11b3b3===_0x513bc2(0x17f)?'payment.success':_0x11b3b3===_0x513bc2(0x163)?_0x513bc2(0x16b):_0x11b3b3===_0x513bc2(0x1e3)?'payment.failed':_0x11b3b3===_0x513bc2(0x1b1)?_0x513bc2(0x16b):_0x11b3b3===_0x513bc2(0x1d6)?_0x513bc2(0x16b):_0x513bc2(0x1de);let _0x2f30f8=[];if(_0xdc2960[_0x513bc2(0x15f)])try{_0x2f30f8=Array[_0x513bc2(0x19b)](_0xdc2960[_0x513bc2(0x15f)])?_0xdc2960[_0x513bc2(0x15f)]:JSON[_0x513bc2(0x194)](_0xdc2960[_0x513bc2(0x15f)]);}catch(_0x1e94f1){console[_0x513bc2(0x209)](_0x513bc2(0x193),_0x1e94f1),_0x2f30f8=[];}if(!_0x2f30f8[_0x513bc2(0x16d)](_0x54b6fa)){console[_0x513bc2(0x18f)](_0x513bc2(0x1ea)+_0x54b6fa+'\x20not\x20enabled\x20for\x20shop\x20'+_0x58ade6['id']);return;}const _0x125bc8={'event':_0x54b6fa,'payment':{'id':_0x2185bb['id'],'order_id':_0x2185bb[_0x513bc2(0x214)],'gateway_order_id':_0x2185bb['gatewayOrderId'],'gateway':_0x2185bb[_0x513bc2(0x1aa)],'amount':_0x2185bb[_0x513bc2(0x201)],'currency':_0x2185bb[_0x513bc2(0x16f)],'status':_0x11b3b3['toLowerCase'](),'customer_email':_0x2185bb[_0x513bc2(0x1ed)],'customer_name':_0x2185bb[_0x513bc2(0x1fb)],'failure_message':_0x2185bb[_0x513bc2(0x1b5)],'tx_urls':_0x2185bb['txUrls']?JSON[_0x513bc2(0x194)](_0x2185bb[_0x513bc2(0x223)]):null,'created_at':_0x2185bb[_0x513bc2(0x21b)],'updated_at':_0x2185bb[_0x513bc2(0x220)]}},_0x2d8f79=await fetch(_0xdc2960[_0x513bc2(0x17b)],{'method':'POST','headers':{'Content-Type':_0x513bc2(0x1d9),'User-Agent':_0x513bc2(0x17c)},'body':JSON['stringify'](_0x125bc8)}),_0xe72c57=Date[_0x513bc2(0x1c4)]()-_0x10a979,_0x56664f=_0x2d8f79['ok']?_0x513bc2(0x1b8):await _0x2d8f79['text']();loggerService_1[_0x513bc2(0x1cb)][_0x513bc2(0x179)](_0x2185bb['shopId'],_0xdc2960[_0x513bc2(0x17b)],_0x54b6fa,_0x2d8f79[_0x513bc2(0x175)],_0xe72c57,_0x125bc8),console[_0x513bc2(0x18f)](_0x513bc2(0x210)+_0xdc2960[_0x513bc2(0x17b)]+'\x20with\x20status\x20'+_0x2d8f79[_0x513bc2(0x175)]+'\x20('+_0xe72c57+_0x513bc2(0x1be));}catch(_0x3ee7be){console[_0x513bc2(0x209)](_0x513bc2(0x1f7),_0x3ee7be),loggerService_1[_0x513bc2(0x1cb)][_0x513bc2(0x1f6)](_0x2185bb[_0x513bc2(0x17a)],_0x2185bb['shop']?.[_0x513bc2(0x20b)]?.[_0x513bc2(0x17b)]||_0x513bc2(0x172),_0x513bc2(0x21a),_0x3ee7be,{});}}async['sendPaymentStatusNotification'](_0x39cb56,_0x33a242){const _0xfca8e8=a58_0x977efa;try{const _0x2661e8={'PENDING':'created','PROCESSING':_0xfca8e8(0x1c8),'PAID':_0xfca8e8(0x1bb),'FAILED':'failed','EXPIRED':_0xfca8e8(0x202),'REFUND':_0xfca8e8(0x18c),'CHARGEBACK':_0xfca8e8(0x178)},_0x51d358=_0x2661e8[_0x33a242];if(!_0x51d358||_0x51d358===_0xfca8e8(0x1a5))return;await telegramBotService_1[_0xfca8e8(0x1fd)][_0xfca8e8(0x218)](_0x39cb56['shopId'],_0x39cb56,_0x51d358);}catch(_0xa3498){console['error'](_0xfca8e8(0x1e2),_0xa3498);}}}exports[a58_0x977efa(0x195)]=WebhookService;