'use strict';const a52_0x5ccbc8=a52_0x4cea;(function(_0x23f2b9,_0x43684e){const _0x1abbe5=a52_0x4cea,_0x6c39d7=_0x23f2b9();while(!![]){try{const _0x31d997=-parseInt(_0x1abbe5(0x1a6))/0x1+parseInt(_0x1abbe5(0x1b3))/0x2*(parseInt(_0x1abbe5(0x1a7))/0x3)+parseInt(_0x1abbe5(0x140))/0x4+-parseInt(_0x1abbe5(0x176))/0x5+parseInt(_0x1abbe5(0x194))/0x6+parseInt(_0x1abbe5(0x152))/0x7*(parseInt(_0x1abbe5(0x174))/0x8)+-parseInt(_0x1abbe5(0x146))/0x9;if(_0x31d997===_0x43684e)break;else _0x6c39d7['push'](_0x6c39d7['shift']());}catch(_0x4689dc){_0x6c39d7['push'](_0x6c39d7['shift']());}}}(a52_0x3018,0xb6776));function a52_0x4cea(_0x5d8bb3,_0x156903){const _0x301820=a52_0x3018();return a52_0x4cea=function(_0x4cea8a,_0x3714ec){_0x4cea8a=_0x4cea8a-0x13d;let _0x870c82=_0x301820[_0x4cea8a];return _0x870c82;},a52_0x4cea(_0x5d8bb3,_0x156903);}var __importDefault=this&&this[a52_0x5ccbc8(0x1c3)]||function(_0x14a221){return _0x14a221&&_0x14a221['__esModule']?_0x14a221:{'default':_0x14a221};};Object['defineProperty'](exports,a52_0x5ccbc8(0x147),{'value':!![]}),exports[a52_0x5ccbc8(0x15c)]=void 0x0;const database_1=__importDefault(require(a52_0x5ccbc8(0x144))),plisioService_1=require(a52_0x5ccbc8(0x181)),rapydService_1=require(a52_0x5ccbc8(0x190)),nodaService_1=require(a52_0x5ccbc8(0x191)),coinToPayService_1=require(a52_0x5ccbc8(0x1b9)),klymeService_1=require(a52_0x5ccbc8(0x1a5)),telegramBotService_1=require(a52_0x5ccbc8(0x1a0)),paymentLinkService_1=require('./paymentLinkService'),loggerService_1=require(a52_0x5ccbc8(0x16f));class WebhookService{constructor(){const _0x5503f1=a52_0x5ccbc8;this['plisioService']=new plisioService_1[(_0x5503f1(0x1a8))](),this[_0x5503f1(0x14c)]=new rapydService_1['RapydService'](),this[_0x5503f1(0x19c)]=new nodaService_1['NodaService'](),this[_0x5503f1(0x13d)]=new coinToPayService_1[(_0x5503f1(0x16e))](),this['klymeService']=new klymeService_1[(_0x5503f1(0x175))](),this[_0x5503f1(0x1ba)]=new paymentLinkService_1[(_0x5503f1(0x195))]();}async['processPlisioWebhook'](_0x90202b){const _0x45d576=a52_0x5ccbc8;console[_0x45d576(0x15a)]('Processing\x20Plisio\x20webhook:',_0x90202b);try{const _0x16acee=await this[_0x45d576(0x1ab)][_0x45d576(0x165)](_0x90202b);if(!_0x16acee[_0x45d576(0x15e)]){console[_0x45d576(0x15d)](_0x45d576(0x14e));return;}await this[_0x45d576(0x1c2)](_0x16acee[_0x45d576(0x15e)],_0x16acee[_0x45d576(0x184)],_0x45d576(0x172),_0x90202b,undefined,undefined,_0x16acee[_0x45d576(0x1a2)]),loggerService_1[_0x45d576(0x14d)][_0x45d576(0x151)]('plisio',_0x16acee['paymentId'],'PENDING',_0x16acee['status'],_0x90202b);}catch(_0x140748){console[_0x45d576(0x15d)](_0x45d576(0x164),_0x140748),loggerService_1[_0x45d576(0x14d)]['logWebhookError'](_0x45d576(0x172),_0x140748,_0x90202b);throw _0x140748;}}async[a52_0x5ccbc8(0x168)](_0x19ae76){const _0x260b84=a52_0x5ccbc8;console[_0x260b84(0x15a)]('Processing\x20Plisio\x20Gateway\x20webhook:',_0x19ae76);try{const _0x30f993=await this[_0x260b84(0x1ab)]['processWebhook'](_0x19ae76);if(!_0x30f993[_0x260b84(0x15e)]){console['error'](_0x260b84(0x169));return;}await this[_0x260b84(0x1c2)](_0x30f993[_0x260b84(0x15e)],_0x30f993[_0x260b84(0x184)],'plisio',_0x19ae76,undefined,undefined,_0x30f993[_0x260b84(0x1a2)]),loggerService_1[_0x260b84(0x14d)][_0x260b84(0x151)]('plisio_gateway',_0x30f993[_0x260b84(0x15e)],'PENDING',_0x30f993[_0x260b84(0x184)],_0x19ae76);}catch(_0x20fec0){console[_0x260b84(0x15d)](_0x260b84(0x18c),_0x20fec0),loggerService_1[_0x260b84(0x14d)][_0x260b84(0x163)]('plisio_gateway',_0x20fec0,_0x19ae76);throw _0x20fec0;}}async[a52_0x5ccbc8(0x157)](_0x106090){const _0x2cb3d9=a52_0x5ccbc8;console[_0x2cb3d9(0x15a)](_0x2cb3d9(0x199),_0x106090);try{const _0xfe05ed=await this[_0x2cb3d9(0x14c)][_0x2cb3d9(0x165)](_0x106090);if(!_0xfe05ed[_0x2cb3d9(0x15e)]){console[_0x2cb3d9(0x15d)]('No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook');return;}await this[_0x2cb3d9(0x1c2)](_0xfe05ed[_0x2cb3d9(0x15e)],_0xfe05ed[_0x2cb3d9(0x184)],_0x2cb3d9(0x16c),_0x106090,_0xfe05ed[_0x2cb3d9(0x13f)],_0xfe05ed[_0x2cb3d9(0x1aa)]),loggerService_1[_0x2cb3d9(0x14d)]['logWebhookProcessed'](_0x2cb3d9(0x16c),_0xfe05ed['paymentId'],'PENDING',_0xfe05ed['status'],_0x106090);}catch(_0x2f59e8){console['error'](_0x2cb3d9(0x19f),_0x2f59e8),loggerService_1[_0x2cb3d9(0x14d)]['logWebhookError']('rapyd',_0x2f59e8,_0x106090);throw _0x2f59e8;}}async['processNodaWebhook'](_0x24cd4c){const _0x391891=a52_0x5ccbc8;console[_0x391891(0x15a)](_0x391891(0x1bd),_0x24cd4c);try{const _0x4a724d=await this[_0x391891(0x19c)]['processWebhook'](_0x24cd4c);if(!_0x4a724d[_0x391891(0x15e)]){console[_0x391891(0x15d)](_0x391891(0x179));return;}await this['updatePaymentStatus'](_0x4a724d[_0x391891(0x15e)],_0x4a724d[_0x391891(0x184)],_0x391891(0x198),_0x24cd4c,undefined,_0x4a724d['additionalInfo']),loggerService_1[_0x391891(0x14d)][_0x391891(0x151)]('noda',_0x4a724d[_0x391891(0x15e)],'PENDING',_0x4a724d[_0x391891(0x184)],_0x24cd4c);}catch(_0x3c0ef0){console[_0x391891(0x15d)]('Error\x20processing\x20Noda\x20webhook:',_0x3c0ef0),loggerService_1['loggerService'][_0x391891(0x163)]('noda',_0x3c0ef0,_0x24cd4c);throw _0x3c0ef0;}}async[a52_0x5ccbc8(0x187)](_0x537f26){const _0x592068=a52_0x5ccbc8;console[_0x592068(0x15a)](_0x592068(0x178),_0x537f26);try{const _0x12883f=await this[_0x592068(0x13d)]['processWebhook'](_0x537f26);if(!_0x12883f[_0x592068(0x15e)]){console['error']('No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook');return;}await this['updatePaymentStatus'](_0x12883f[_0x592068(0x15e)],_0x12883f[_0x592068(0x184)],_0x592068(0x1af),_0x537f26),loggerService_1[_0x592068(0x14d)]['logWebhookProcessed'](_0x592068(0x1af),_0x12883f[_0x592068(0x15e)],_0x592068(0x18d),_0x12883f[_0x592068(0x184)],_0x537f26);}catch(_0xd6d61a){console[_0x592068(0x15d)](_0x592068(0x17b),_0xd6d61a),loggerService_1[_0x592068(0x14d)]['logWebhookError'](_0x592068(0x1af),_0xd6d61a,_0x537f26);throw _0xd6d61a;}}async[a52_0x5ccbc8(0x148)](_0x2bbb58){const _0x6f01fc=a52_0x5ccbc8;console['log'](_0x6f01fc(0x1c4),_0x2bbb58);try{const _0x4e6bfa=await this['klymeService'][_0x6f01fc(0x165)](_0x2bbb58);if(!_0x4e6bfa['paymentId']){console[_0x6f01fc(0x15d)]('No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook');return;}const _0x3501ca=_0x4e6bfa['region']?_0x6f01fc(0x1b2)+_0x4e6bfa[_0x6f01fc(0x19d)]['toLowerCase']():_0x6f01fc(0x143);await this[_0x6f01fc(0x1c2)](_0x4e6bfa[_0x6f01fc(0x15e)],_0x4e6bfa[_0x6f01fc(0x184)],_0x3501ca,_0x2bbb58,undefined,_0x4e6bfa[_0x6f01fc(0x1aa)]),loggerService_1[_0x6f01fc(0x14d)][_0x6f01fc(0x151)]('klyme',_0x4e6bfa[_0x6f01fc(0x15e)],_0x6f01fc(0x18d),_0x4e6bfa[_0x6f01fc(0x184)],_0x2bbb58);}catch(_0x28627e){console[_0x6f01fc(0x15d)]('Error\x20processing\x20KLYME\x20webhook:',_0x28627e),loggerService_1[_0x6f01fc(0x14d)][_0x6f01fc(0x163)](_0x6f01fc(0x183),_0x28627e,_0x2bbb58);throw _0x28627e;}}async['updatePaymentStatus'](_0x2789c6,_0x2bdcb7,_0x1c6de6,_0x2c72d1,_0x3ddfdb,_0x15b3e1,_0x2b6810){const _0x150d85=a52_0x5ccbc8;console[_0x150d85(0x15a)](_0x150d85(0x150)+_0x2789c6+_0x150d85(0x1bf)+_0x2bdcb7+_0x150d85(0x170)+_0x1c6de6+_0x150d85(0x17f));_0x3ddfdb&&console[_0x150d85(0x15a)](_0x150d85(0x16d)+_0x2789c6+_0x150d85(0x18b)+_0x3ddfdb);_0x2b6810&&_0x2b6810[_0x150d85(0x15b)]>0x0&&console['log'](_0x150d85(0x14a)+_0x2789c6+_0x150d85(0x154),_0x2b6810);const _0x4d9df9=await database_1[_0x150d85(0x153)][_0x150d85(0x196)][_0x150d85(0x1b1)]({'where':{'gatewayOrderId':_0x2789c6,'gateway':_0x1c6de6},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4d9df9){console[_0x150d85(0x15d)](_0x150d85(0x1ad)+_0x2789c6+_0x150d85(0x193)+_0x1c6de6);return;}const _0x329847=_0x4d9df9[_0x150d85(0x184)];if(_0x329847===_0x2bdcb7){console[_0x150d85(0x15a)]('Payment\x20'+_0x4d9df9['id']+'\x20status\x20unchanged\x20('+_0x2bdcb7+')');return;}console[_0x150d85(0x15a)](_0x150d85(0x156)+_0x4d9df9['id']+_0x150d85(0x171)+_0x329847+_0x150d85(0x16b)+_0x2bdcb7);const _0x990c2c={'status':_0x2bdcb7,'updatedAt':new Date()};_0x3ddfdb&&(_0x990c2c[_0x150d85(0x13f)]=_0x3ddfdb,console[_0x150d85(0x15a)](_0x150d85(0x18f)+_0x3ddfdb));_0x2b6810&&_0x2b6810[_0x150d85(0x15b)]>0x0&&(_0x990c2c[_0x150d85(0x1a2)]=JSON['stringify'](_0x2b6810),console[_0x150d85(0x15a)](_0x150d85(0x1a9)+JSON['stringify'](_0x2b6810)));_0x2bdcb7==='PAID'&&_0x329847!==_0x150d85(0x155)&&(_0x990c2c['paidAt']=new Date());_0x15b3e1&&(_0x15b3e1['cardLast4']&&(_0x990c2c[_0x150d85(0x17d)]=_0x15b3e1[_0x150d85(0x17d)]),_0x15b3e1[_0x150d85(0x1bc)]&&(_0x990c2c[_0x150d85(0x1bc)]=_0x15b3e1['paymentMethod']),_0x15b3e1[_0x150d85(0x188)]&&(_0x990c2c[_0x150d85(0x188)]=_0x15b3e1[_0x150d85(0x188)]),_0x15b3e1['remitterIban']&&(_0x990c2c['remitterIban']=_0x15b3e1['remitterIban']),_0x15b3e1[_0x150d85(0x160)]&&(_0x990c2c[_0x150d85(0x160)]=_0x15b3e1[_0x150d85(0x160)]));await database_1[_0x150d85(0x153)][_0x150d85(0x196)][_0x150d85(0x180)]({'where':{'id':_0x4d9df9['id']},'data':_0x990c2c});if(_0x2bdcb7===_0x150d85(0x155)&&_0x329847!==_0x150d85(0x155))try{await this['paymentLinkService'][_0x150d85(0x13e)](_0x4d9df9['id']);}catch(_0x33d208){console[_0x150d85(0x15d)]('Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x33d208);}await database_1[_0x150d85(0x153)]['webhookLog'][_0x150d85(0x1b4)]({'data':{'paymentId':_0x4d9df9['id'],'shopId':_0x4d9df9[_0x150d85(0x189)],'event':_0x1c6de6+'_webhook_'+_0x2bdcb7[_0x150d85(0x1bb)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x329847,'newStatus':_0x2bdcb7,'failureMessage':_0x3ddfdb,'txUrls':_0x2b6810,'webhookData':_0x2c72d1})}}),await this[_0x150d85(0x19a)](_0x4d9df9,_0x2bdcb7),await this[_0x150d85(0x161)](_0x4d9df9,_0x2bdcb7),console['log'](_0x150d85(0x192)+_0x4d9df9['id']+'\x20updated\x20successfully:\x20'+_0x329847+_0x150d85(0x16b)+_0x2bdcb7),_0x3ddfdb&&console[_0x150d85(0x15a)](_0x150d85(0x182)+_0x3ddfdb),_0x2b6810&&_0x2b6810['length']>0x0&&console[_0x150d85(0x15a)]('ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20'+_0x2b6810[_0x150d85(0x15b)]+'\x20URLs');}async[a52_0x5ccbc8(0x19a)](_0x28b226,_0x8950cc){const _0x3e7124=a52_0x5ccbc8,_0x1c1734=Date[_0x3e7124(0x1c0)]();try{const _0x3961d2=_0x28b226[_0x3e7124(0x18e)],_0x5c3741=_0x3961d2[_0x3e7124(0x14b)];if(!_0x5c3741?.[_0x3e7124(0x158)]){console[_0x3e7124(0x15a)](_0x3e7124(0x1a1)+_0x3961d2['id']);return;}const _0x37f3ff=_0x8950cc==='PAID'?_0x3e7124(0x14f):_0x8950cc==='FAILED'?'payment.failed':_0x8950cc==='EXPIRED'?'payment.failed':_0x3e7124(0x142);let _0x393a87=[];if(_0x5c3741[_0x3e7124(0x197)])try{_0x393a87=Array[_0x3e7124(0x149)](_0x5c3741['webhookEvents'])?_0x5c3741[_0x3e7124(0x197)]:JSON[_0x3e7124(0x145)](_0x5c3741['webhookEvents']);}catch(_0x35345d){console['error'](_0x3e7124(0x167),_0x35345d),_0x393a87=[];}if(!_0x393a87[_0x3e7124(0x173)](_0x37f3ff)){console[_0x3e7124(0x15a)](_0x3e7124(0x1a3)+_0x37f3ff+_0x3e7124(0x186)+_0x3961d2['id']);return;}let _0x3b5287;if(_0x28b226['txUrls'])try{_0x3b5287=JSON[_0x3e7124(0x145)](_0x28b226[_0x3e7124(0x1a2)]);}catch(_0xcbd87b){console[_0x3e7124(0x15d)](_0x3e7124(0x162),_0xcbd87b),_0x3b5287=undefined;}const _0x3400da={'event':_0x37f3ff,'payment':{'id':_0x28b226['id'],'order_id':_0x28b226['orderId'],'gateway_order_id':_0x28b226[_0x3e7124(0x1b6)],'gateway':_0x28b226[_0x3e7124(0x177)],'amount':_0x28b226[_0x3e7124(0x1a4)],'currency':_0x28b226[_0x3e7124(0x1b7)],'status':_0x8950cc[_0x3e7124(0x1bb)](),'customer_email':_0x28b226['customerEmail'],'customer_name':_0x28b226[_0x3e7124(0x15f)],'failure_message':_0x28b226[_0x3e7124(0x13f)],'tx_urls':_0x3b5287,'created_at':_0x28b226[_0x3e7124(0x1be)],'updated_at':new Date()}},_0x24104f=await fetch(_0x5c3741['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x3e7124(0x17e),'User-Agent':_0x3e7124(0x1b5)},'body':JSON['stringify'](_0x3400da)}),_0x18eb10=Date[_0x3e7124(0x1c0)]()-_0x1c1734,_0x4e58ba=_0x24104f['ok']?_0x3e7124(0x19e):await _0x24104f[_0x3e7124(0x1ae)]();loggerService_1[_0x3e7124(0x14d)][_0x3e7124(0x16a)](_0x28b226['shopId'],_0x5c3741['webhookUrl'],_0x37f3ff,_0x24104f['status'],_0x18eb10,_0x3400da),console['log'](_0x3e7124(0x19b)+_0x5c3741['webhookUrl']+_0x3e7124(0x1ac)+_0x24104f['status']+'\x20('+_0x18eb10+_0x3e7124(0x141));}catch(_0x47fc13){console[_0x3e7124(0x15d)](_0x3e7124(0x1b0),_0x47fc13),loggerService_1[_0x3e7124(0x14d)][_0x3e7124(0x17a)](_0x28b226[_0x3e7124(0x189)],_0x28b226['shop']?.['settings']?.[_0x3e7124(0x158)]||_0x3e7124(0x166),_0x3e7124(0x17c),_0x47fc13,{});}}async['sendPaymentStatusNotification'](_0xdb966d,_0x58736a){const _0x579e72=a52_0x5ccbc8;try{const _0x557df6={'PENDING':'created','PAID':_0x579e72(0x1b8),'FAILED':_0x579e72(0x18a),'EXPIRED':'expired'},_0x208fdc=_0x557df6[_0x58736a];if(!_0x208fdc||_0x208fdc===_0x579e72(0x185))return;await telegramBotService_1[_0x579e72(0x1c1)]['sendPaymentNotification'](_0xdb966d[_0x579e72(0x189)],_0xdb966d,_0x208fdc);}catch(_0x13f058){console[_0x579e72(0x15d)](_0x579e72(0x159),_0x13f058);}}}exports['WebhookService']=WebhookService;function a52_0x3018(){const _0x31c408=['ðŸ’¾\x20Failure\x20message\x20saved:\x20','klyme','status','created','\x20not\x20enabled\x20for\x20shop\x20','processCoinToPayWebhook','bankId','shopId','failed','\x20failure\x20message:\x20','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','PENDING','shop','ðŸ’¾\x20Saving\x20failure\x20message:\x20','./gateways/rapydService','./gateways/nodaService','âœ…\x20Payment\x20','\x20and\x20gateway:\x20','2383320jqPKrR','PaymentLinkService','payment','webhookEvents','noda','Processing\x20Rapyd\x20webhook:','sendShopWebhook','Shop\x20webhook\x20sent\x20to\x20','nodaService','region','Success','Error\x20processing\x20Rapyd\x20webhook:','./telegramBotService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','txUrls','Webhook\x20event\x20','amount','./gateways/klymeService','311938mCaAkx','20931QNiOqz','PlisioService','ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20','additionalInfo','plisioService','\x20with\x20status\x20','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','text','cointopay','Failed\x20to\x20send\x20shop\x20webhook:','findFirst','klyme_','376wjgKrr','create','TesSoft\x20Payment\x20System/1.0','gatewayOrderId','currency','paid','./gateways/coinToPayService','paymentLinkService','toLowerCase','paymentMethod','Processing\x20Noda\x20webhook:','createdAt','\x20status\x20to\x20','now','telegramBotService','updatePaymentStatus','__importDefault','Processing\x20KLYME\x20webhook:','coinToPayService','handleSuccessfulPayment','failureMessage','2730684KAGngO','ms)','payment.pending','klyme_eu','../config/database','parse','16748451KvUzVw','__esModule','processKlymeWebhook','isArray','ðŸ”—\x20Payment\x20','settings','rapydService','loggerService','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook','payment.success','ðŸ”„\x20Updating\x20payment\x20','logWebhookProcessed','2476691vcMvql','default','\x20transaction\x20URLs:','PAID','Payment\x20','processRapydWebhook','webhookUrl','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','log','length','WebhookService','error','paymentId','customerName','remitterName','sendPaymentStatusNotification','Error\x20parsing\x20tx_urls\x20for\x20webhook:','logWebhookError','Error\x20processing\x20Plisio\x20webhook:','processWebhook','unknown','Error\x20parsing\x20webhook\x20events:','processPlisioGatewayWebhook','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook','logShopWebhookSent','\x20->\x20','rapyd','ðŸ’¥\x20Payment\x20','CoinToPayService','./loggerService','\x20from\x20','\x20status\x20change:\x20','plisio','includes','16paACyg','KlymeService','894670Ppwjkb','gateway','Processing\x20CoinToPay\x20webhook:','No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook','logShopWebhookError','Error\x20processing\x20CoinToPay\x20webhook:','webhook_send','cardLast4','application/json','\x20webhook','update','./gateways/plisioService'];a52_0x3018=function(){return _0x31c408;};return a52_0x3018();}