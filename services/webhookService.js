'use strict';function a86_0x423e(){const _0x4ab2e8=['\x22,\x20orderId=\x22','‚ùå\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','\x20in\x20shop\x20','‚ùå\x20Error\x20processing\x20AmPay\x20webhook:','currentPayments','processAmPayTRYWebhook','cointopay2','Error\x20processing\x20Plisio\x20webhook:','\x20commission\x20for\x20shop\x20','\x20=\x20','commission','üìà\x20Payment\x20details:\x20oldStatus=\x22','‚ùå\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','processCoinToPay2Webhook','üîç\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:','payment','system','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','üîÑ\x20Processing\x20Rapyd\x20webhook:','‚ùå\x20Payment\x20link\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook','üí∏\x20CHARGEBACK:\x20Processing\x20penalty-only\x20deduction','create','‚úÖ\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','logWebhookProcessed','\x20(Status:\x20','paid','shop',',\x20GatewayPaymentId=','txUrls','‚ÑπÔ∏è\x20AmPay\x20TRY\x20status\x20','cointopay','Webhook\x20event\x20','gateway','üí∞\x20Final\x20balance\x20after\x20chargeback:\x20','paymentLink','‚ùå\x20Available\x20webhook\x20fields:','gatewayPaymentId','\x20not\x20enabled\x20for\x20shop\x20','status_addition_info','./gateways/nodaService','./gateways/mastercardService','VISA','payment.failed','üí∞\x20Adding\x20to\x20balance:\x20',',\x20gatewayOrderId:\x20','customerName','plisio','./gateways/ampayService','now','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','EXPIRED','toUpperCase','\x22,\x20paymentLinkId=\x22','Payment\x20marked\x20as\x20CHARGEBACK\x20(no\x20penalty\x20specified)','‚ùå\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','customerOrderId','\x22,\x20id=\x22','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','üìä\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','cardLast4','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','\x20status\x20updated\x20to\x20FAILED','remitterName','CHARGEBACK','system_id','findMany','AmerService','\x20for\x20MyXSpend\x20webhook',',\x20using\x20default\x2010%','sendPaymentStatusNotification','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook',',\x20currentPayments=','\x20for\x20AmPay\x20webhook','30GkvOnM','‚úÖ\x20Found\x20payment\x20','üîÑ\x20Processing\x20Plisio\x20Gateway\x20webhook:','coinToPay2Service','üîÑ\x20Processing\x20CoinToPay2\x20webhook:','processCoinToPayWebhook','165130gvliPp','orderId','processAmerWebhook','payment.success','amerService',',\x20gatewayPaymentId:\x20','map','webhook_status_change_','OxaPayService','sendShopWebhook','paidAt','log','üîç\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','Payment\x20not\x20found:\x20','processKlymeWebhook','additionalInfo',',\x20card:\x20****','‚úÖ\x20Shop\x20','‚ùå\x20VISA\x20webhook\x20processing\x20failed:','üîÑ\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','digest','rapyd','toLowerCase','‚ùå\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:','logWebhookError','ampay_try_','üí≥\x20Card\x20brand\x20detected:\x20','application/json','üîÑ\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','cardIssuer','Payment\x20not\x20found\x20for\x20MaxPara\x20webhook:\x20','33ZqlkYj','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','settings','957uvzyZp','üîÑ\x20Processing\x20Amer\x20webhook:','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','\x20->\x20','\x20(orderId:\x20','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','üîç\x20Found\x20VISA\x20payment:\x20ID=','processMasterCardWebhook','ampay_try','amountAfterGatewayCommissionUSDT','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','üîç\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','./gateways/rapydService','üîç\x20VISA\x20payment\x20search\x20executed','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','rapydService','Error\x20parsing\x20webhook\x20events:','logShopWebhookError','2492qvvOYB','\x20+\x20','username','‚ÑπÔ∏è\x20MyXSpend\x20status\x20','currencyService','1376634kPKqgH','Payment\x20not\x20found\x20for\x20OxaPay\x20webhook:\x20','entries','PlisioService','Payment\x20not\x20found','myxspend_','chargebackAmount','cardType','üí∞\x20Removing\x20from\x20balance:\x20','REFUND','üìä\x20Amer\x20webhook\x20result:','shopId','convertToUSDT','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','‚úÖ\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','üîç\x20Searched\x20by:\x20gatewayOrderId=\x22','../config/database','Found\x20payment\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','$transaction','FAILED','./telegramBotService',',\x20GatewayOrderId=','‚ùå\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','__esModule','Failed\x20to\x20send\x20shop\x20webhook:','visa/mastercard','üìä\x20OxaPay\x20webhook:\x20Payment\x20',',\x20status=','S8jqtNdiYV1qZTkw1nPB','default','üîÑ\x20Processing\x20AmPay\x20TRY\x20webhook:','cardBrand','üîç\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','./gateways/plisioService','No\x20payment\x20ID\x20in\x20Amer\x20webhook','üîÑ\x20updatePaymentStatus\x20called:\x20paymentId=','visa_','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','failureMessage','üìä\x20Payment\x20status:\x20','\x20not\x20found','errorMessage','webhookEvents','üí∞\x20Converting\x20','‚ö†Ô∏è\x20CHARGEBACK\x20without\x20penalty\x20amount\x20-\x20no\x20balance\x20change','noda','gatewayCommissionRate','üìä\x20KLYME\x20webhook:\x20Payment\x20','105500kiziFf','nodaService','WebhookService','push','customerEmail','üîÑ\x20Processing\x20AmPay\x20webhook:','visa','VISA\x20payment\x20not\x20found:\x20','1364634syJoES','üì§\x20Shop\x20webhook\x20sent\x20to\x20','visaMasterCardService','MasterCard\x20payment\x20not\x20found:\x20','amount','üîç\x20Search\x20result:\x20',',\x20Card=****','üîÑ\x20Processing\x20MaxPara\x20webhook:','‚úÖ\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','paymentMethod','üí∞\x20Gateway\x20','./gateways/ampayTRYService','Bank\x20Card','\x20commission:\x20','type','payment.pending','üîÑ\x20Processing\x20Noda\x20webhook:','üí∏\x20CHARGEBACK\x20penalty\x20ONLY:\x20-','SINGLE','cb5d6df763cde0f752ebd71ac606e95ff6b73926abfb4621ad95e99c423a2965d6f153b1647f7dcff315bf65dd749f72dbb40576','\x20-\x20','no\x20balance\x20change','üîç\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','üìù\x20Reason:\x20','mastercard','No\x20payment\x20ID\x20in\x20VISA\x20webhook','CoinToPayService','üìä\x20Rapyd\x20webhook:\x20Payment\x20','üîç\x20VISA\x20payment\x20search\x20result:\x20','DECLINED','AmPayService','toFixed','\x20with\x20status\x20','‚ùå\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','\x20current\x20balance:\x20','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','sendPaymentNotification','No\x20additional\x20info','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','‚ùå\x20VISA\x20payment\x20failed\x20with\x20message:\x20','processPlisioWebhook','desc','failed','createHmac','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','defineProperty','AmPayTRYService','balance','\x20USDT','stringify','üìä\x20VISA\x20payment\x20found:\x20','ampay','üîç\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','cardBin','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','plisio_gateway','üîÑ\x20Processing\x20CoinToPay\x20webhook:','amountUSDT','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','‚ÑπÔ∏è\x20Decline\x20reason:\x20','cardCategory','loggerService','unknown',',\x20gateway\x20','%\x20gateway\x20commission)','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','myxspend','processVisaWebhook','No\x20payment\x20ID\x20in\x20MaxPara\x20webhook','Error\x20processing\x20KLYME\x20webhook:','chargeback','üîç\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20‚Üí\x20','./gateways/amerService','‚ÑπÔ∏è\x20AmPay\x20status\x20','NodaService','processMaxParaWebhook','\x20for\x20AmPay\x20TRY\x20webhook','Error\x20processing\x20CoinToPay2\x20webhook:','30782BvMVXo','\x20USDT\x20(chargeback\x20penalty\x20ONLY)','toISOString','text','isArray','klymeService','client_transaction_id','6lfVbQW','payment_method','üîÑ\x20Processing\x20Plisio\x20webhook:','amer','\x20mapped\x20to\x20FAILED','üìä\x20CoinToPay2\x20webhook:\x20Payment\x20','error','./gateways/klymeService','cardBinStatus','refund','‚úÖ\x20AmPay\x20webhook\x20processed:\x20Payment\x20','remitterIban','üìä\x20Plisio\x20webhook:\x20Payment\x20','crypto','PAID','oxapayService','bankId','webhookLog','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','visa_mastercard','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','status',',\x20Status=','tx_hash','updatePaymentStatus',',\x20using\x20default\x20commission\x2010%','webhookUrl','Payment\x20','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','KlymeService','dateTime','klyme','processMyXSpendWebhook','paymentId','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','coinToPayService','ampayService','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','üìà\x20Payment\x20','./gateways/maxParaService','maxParaService','keys','paymentLinkId','\x20balance\x20updated:\x20','‚ùå\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','maxpara',',\x20Gateway=','‚ùå\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','plisioService','getGatewayCommission','cardCountry','üìä\x20AmPay\x20TRY\x20webhook\x20data:','Payment\x20System/1.0','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','‚ùå\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','https://maxpara.co','‚ùå\x20Error\x20processing\x20MyXSpend\x20webhook:','üìä\x20Noda\x20webhook:\x20Payment\x20','processNodaWebhook','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','gatewaySettings','createdAt','üí∞\x20Payment\x20amount\x20is\x20NOT\x20deducted\x20(chargeback\x20penalty\x20only)','‚ùå\x20Error\x20processing\x20Amer\x20webhook:','üè™\x20Shop\x20','expired','message','processAmPayWebhook','processWebhook','getPaymentStatusFromCallback','1691392ICRCui','\x20to\x20','gatewayOrderId','sha256','Open\x20Banking','\x20status\x20','MaxParaService','üìä\x20AmPay\x20webhook\x20data:','currency','oxapay','update','üîÑ\x20MyXSpend\x20status\x20','üîÑ\x20Processing\x20VISA\x20webhook:','findFirst'];a86_0x423e=function(){return _0x4ab2e8;};return a86_0x423e();}const a86_0x25b9dd=a86_0x240c;(function(_0x4c4201,_0x4a075d){const _0x23b243=a86_0x240c,_0x497059=_0x4c4201();while(!![]){try{const _0x38035d=parseInt(_0x23b243(0x190))/0x1*(-parseInt(_0x23b243(0x189))/0x2)+parseInt(_0x23b243(0x25b))/0x3*(-parseInt(_0x23b243(0x26f))/0x4)+-parseInt(_0x23b243(0x2a5))/0x5*(-parseInt(_0x23b243(0x232))/0x6)+parseInt(_0x23b243(0x274))/0x7+parseInt(_0x23b243(0x1d8))/0x8+-parseInt(_0x23b243(0x2ad))/0x9+parseInt(_0x23b243(0x238))/0xa*(parseInt(_0x23b243(0x258))/0xb);if(_0x38035d===_0x4a075d)break;else _0x497059['push'](_0x497059['shift']());}catch(_0x496360){_0x497059['push'](_0x497059['shift']());}}}(a86_0x423e,0x1d660));var __importDefault=this&&this['__importDefault']||function(_0x14061f){const _0x25c9b0=a86_0x240c;return _0x14061f&&_0x14061f[_0x25c9b0(0x28c)]?_0x14061f:{'default':_0x14061f};};Object[a86_0x25b9dd(0x2db)](exports,a86_0x25b9dd(0x28c),{'value':!![]}),exports[a86_0x25b9dd(0x2a7)]=void 0x0;const database_1=__importDefault(require(a86_0x25b9dd(0x284))),crypto_1=__importDefault(require(a86_0x25b9dd(0x19d))),plisioService_1=require(a86_0x25b9dd(0x296)),rapydService_1=require(a86_0x25b9dd(0x269)),nodaService_1=require(a86_0x25b9dd(0x20e)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require(a86_0x25b9dd(0x197)),mastercardService_1=require(a86_0x25b9dd(0x20f)),amerService_1=require(a86_0x25b9dd(0x183)),ampayService_1=require(a86_0x25b9dd(0x216)),ampayTRYService_1=require(a86_0x25b9dd(0x2b9)),maxParaService_1=require(a86_0x25b9dd(0x1b8)),oxapayService_1=require('./gateways/oxapayService'),telegramBotService_1=require(a86_0x25b9dd(0x289)),currencyService_1=require('./currencyService'),loggerService_1=require('./loggerService');function a86_0x240c(_0x4fe67f,_0x43b6ee){_0x4fe67f=_0x4fe67f-0x178;const _0x423e2f=a86_0x423e();let _0x240ca8=_0x423e2f[_0x4fe67f];return _0x240ca8;}class WebhookService{constructor(){const _0x1bf457=a86_0x25b9dd;this['plisioService']=new plisioService_1[(_0x1bf457(0x277))](),this[_0x1bf457(0x26c)]=new rapydService_1['RapydService'](),this[_0x1bf457(0x2a6)]=new nodaService_1[(_0x1bf457(0x185))](),this[_0x1bf457(0x1b4)]=new coinToPayService_1[(_0x1bf457(0x2c8))](),this[_0x1bf457(0x235)]=new coinToPay2Service_1['CoinToPay2Service'](),this[_0x1bf457(0x18e)]=new klymeService_1[(_0x1bf457(0x1ae))](),this[_0x1bf457(0x2af)]=new mastercardService_1['VisaMasterCardService'](),this[_0x1bf457(0x23c)]=new amerService_1[(_0x1bf457(0x22b))](),this[_0x1bf457(0x1b5)]=new ampayService_1[(_0x1bf457(0x2cc))](),this['ampayTRYService']=new ampayTRYService_1[(_0x1bf457(0x2dc))](),this[_0x1bf457(0x1b9)]=new maxParaService_1[(_0x1bf457(0x1de))]({'apiKey':process.env.MAX_PARA_API_KEY||_0x1bf457(0x2c1),'secretKey':process.env.MAX_PARA_SECRET_KEY||_0x1bf457(0x291),'baseUrl':process.env.MAX_PARA_BASE_URL||_0x1bf457(0x1c9)}),this['oxapayService']=new oxapayService_1[(_0x1bf457(0x240))]();}async[a86_0x25b9dd(0x1a9)](_0x5995fa,_0x3f828e,_0x4c323f){const _0x3d165e=a86_0x25b9dd;console[_0x3d165e(0x243)](_0x3d165e(0x298)+_0x5995fa+',\x20newStatus='+_0x3f828e),console[_0x3d165e(0x243)]('üîÑ\x20Additional\x20data:',_0x4c323f),await database_1[_0x3d165e(0x292)][_0x3d165e(0x287)](async _0xca7479=>{const _0x16b633=_0x3d165e,_0x453823=await _0xca7479[_0x16b633(0x1f5)]['findUnique']({'where':{'id':_0x5995fa},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'secretKey':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x453823)throw new Error(_0x16b633(0x1ac)+_0x5995fa+'\x20not\x20found');const _0x36885a=_0x453823['status'],_0x38daa6=_0x453823[_0x16b633(0x201)];console['log']('üí∞\x20Payment\x20'+_0x5995fa+':\x20'+_0x36885a+'\x20->\x20'+_0x3f828e),console['log'](_0x16b633(0x1d2)+_0x38daa6[_0x16b633(0x271)]+_0x16b633(0x2d0)+_0x38daa6[_0x16b633(0x2dd)]+'\x20USDT');const _0x2398aa={'status':_0x3f828e[_0x16b633(0x21a)](),'updatedAt':new Date(),'statusChangedBy':_0x16b633(0x1f6),'statusChangedAt':new Date()};_0x4c323f?.[_0x16b633(0x29b)]&&(_0x2398aa[_0x16b633(0x29b)]=_0x4c323f['failureMessage']);_0x4c323f?.[_0x16b633(0x203)]&&(_0x2398aa[_0x16b633(0x203)]=JSON[_0x16b633(0x2df)](_0x4c323f[_0x16b633(0x203)]));_0x4c323f?.[_0x16b633(0x223)]&&(_0x2398aa['cardLast4']=_0x4c323f[_0x16b633(0x223)]);_0x4c323f?.[_0x16b633(0x294)]&&(_0x2398aa['cardBrand']=_0x4c323f['cardBrand']);_0x4c323f?.[_0x16b633(0x2b7)]&&(_0x2398aa[_0x16b633(0x2b7)]=_0x4c323f[_0x16b633(0x2b7)]);_0x4c323f?.['bankId']&&(_0x2398aa['bankId']=_0x4c323f[_0x16b633(0x1a0)]);_0x4c323f?.['remitterIban']&&(_0x2398aa['remitterIban']=_0x4c323f[_0x16b633(0x19b)]);_0x4c323f?.['remitterName']&&(_0x2398aa['remitterName']=_0x4c323f['remitterName']);_0x4c323f?.[_0x16b633(0x2e3)]&&(_0x2398aa[_0x16b633(0x2e3)]=_0x4c323f[_0x16b633(0x2e3)]);_0x4c323f?.['cardBinStatus']&&(_0x2398aa[_0x16b633(0x198)]=_0x4c323f['cardBinStatus']);_0x4c323f?.[_0x16b633(0x27b)]&&(_0x2398aa['cardType']=_0x4c323f['cardType']);_0x4c323f?.[_0x16b633(0x2ea)]&&(_0x2398aa[_0x16b633(0x2ea)]=_0x4c323f[_0x16b633(0x2ea)]);_0x4c323f?.[_0x16b633(0x1c3)]&&(_0x2398aa[_0x16b633(0x1c3)]=_0x4c323f['cardCountry']);_0x4c323f?.[_0x16b633(0x256)]&&(_0x2398aa[_0x16b633(0x256)]=_0x4c323f['cardIssuer']);let _0x158595=_0x38daa6[_0x16b633(0x2dd)],_0x54fe56='';if(_0x3f828e[_0x16b633(0x21a)]()==='PAID'&&_0x36885a!=='PAID'){const _0x227e87=await currencyService_1[_0x16b633(0x273)][_0x16b633(0x280)](_0x453823[_0x16b633(0x2b1)],_0x453823[_0x16b633(0x1e0)]),_0x34dac9=await this[_0x16b633(0x1c2)](_0x38daa6['id'],_0x453823[_0x16b633(0x207)]),_0x1176ed=_0x227e87*(0x1-_0x34dac9/0x64);_0x158595+=_0x1176ed,_0x54fe56='+'+_0x1176ed[_0x16b633(0x2cd)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20'+_0x34dac9+_0x16b633(0x17a),_0x2398aa['amountUSDT']=_0x227e87,_0x2398aa[_0x16b633(0x265)]=_0x1176ed,_0x2398aa[_0x16b633(0x2a3)]=_0x34dac9,_0x2398aa[_0x16b633(0x242)]=new Date(),console['log'](_0x16b633(0x2a0)+_0x453823['amount']+'\x20'+_0x453823[_0x16b633(0x1e0)]+_0x16b633(0x25f)+_0x227e87[_0x16b633(0x2cd)](0x6)+_0x16b633(0x2de)),console['log'](_0x16b633(0x2b8)+_0x453823[_0x16b633(0x207)]+_0x16b633(0x2bb)+_0x34dac9+'%'),console['log'](_0x16b633(0x281)+_0x1176ed['toFixed'](0x6)+_0x16b633(0x2de)),console[_0x16b633(0x243)](_0x16b633(0x212)+_0x38daa6[_0x16b633(0x2dd)]+_0x16b633(0x270)+_0x1176ed[_0x16b633(0x2cd)](0x6)+_0x16b633(0x1ef)+_0x158595['toFixed'](0x6)+'\x20USDT');}else{if(_0x36885a===_0x16b633(0x19e)&&_0x3f828e[_0x16b633(0x21a)]()!==_0x16b633(0x19e)&&_0x3f828e['toUpperCase']()!==_0x16b633(0x228)){let _0x352221;if(_0x453823['amountAfterGatewayCommissionUSDT'])_0x352221=_0x453823[_0x16b633(0x265)];else{if(_0x453823[_0x16b633(0x2e7)]){const _0x10c15e=await this[_0x16b633(0x1c2)](_0x38daa6['id'],_0x453823['gateway']);_0x352221=_0x453823[_0x16b633(0x2e7)]*(0x1-_0x10c15e/0x64);}else console['log'](_0x16b633(0x2d4)),_0x352221=0x0;}_0x352221>0x0&&(_0x158595-=_0x352221,_0x54fe56='-'+_0x352221['toFixed'](0x6)+_0x16b633(0x2d1),_0x2398aa['paidAt']=null,console[_0x16b633(0x243)](_0x16b633(0x27c)+_0x38daa6[_0x16b633(0x2dd)]+_0x16b633(0x2c2)+_0x352221[_0x16b633(0x2cd)](0x6)+_0x16b633(0x1ef)+_0x158595[_0x16b633(0x2cd)](0x6)+'\x20USDT'));}}if(_0x3f828e[_0x16b633(0x21a)]()===_0x16b633(0x228)){const _0x4d7b97=_0x4c323f?.[_0x16b633(0x27a)]||0x0;console[_0x16b633(0x243)](_0x16b633(0x1fb)),_0x4d7b97>0x0?(_0x158595-=_0x4d7b97,_0x54fe56='-'+_0x4d7b97['toFixed'](0x6)+_0x16b633(0x18a),_0x2398aa[_0x16b633(0x27a)]=_0x4d7b97,console[_0x16b633(0x243)](_0x16b633(0x2bf)+_0x4d7b97[_0x16b633(0x2cd)](0x6)+_0x16b633(0x2de)),console['log'](_0x16b633(0x1d0)),console[_0x16b633(0x243)](_0x16b633(0x208)+_0x158595['toFixed'](0x6)+_0x16b633(0x2de))):(console[_0x16b633(0x243)](_0x16b633(0x2a1)),_0x54fe56=_0x16b633(0x21c));}const _0x879a37=await _0xca7479[_0x16b633(0x1f5)][_0x16b633(0x1e2)]({'where':{'id':_0x5995fa},'data':_0x2398aa});_0x158595!==_0x38daa6['balance']&&(await _0xca7479['shop'][_0x16b633(0x1e2)]({'where':{'id':_0x38daa6['id']},'data':{'balance':_0x158595}}),console[_0x16b633(0x243)](_0x16b633(0x249)+_0x38daa6['username']+_0x16b633(0x1bc)+_0x38daa6['balance']['toFixed'](0x6)+_0x16b633(0x25f)+_0x158595[_0x16b633(0x2cd)](0x6)+_0x16b633(0x2de)),console['log'](_0x16b633(0x2c5)+_0x54fe56));await _0xca7479['webhookLog'][_0x16b633(0x1fc)]({'data':{'paymentId':_0x5995fa,'shopId':_0x38daa6['id'],'event':_0x16b633(0x23f)+_0x3f828e[_0x16b633(0x24e)](),'statusCode':0xc8,'responseBody':JSON[_0x16b633(0x2df)]({'oldStatus':_0x36885a,'newStatus':_0x3f828e[_0x16b633(0x21a)](),'balanceChange':_0x54fe56||_0x16b633(0x2c3),'oldBalance':_0x38daa6['balance'],'newBalance':_0x158595,'amountUSDT':_0x2398aa[_0x16b633(0x2e7)],'additionalData':_0x4c323f,'timestamp':new Date()[_0x16b633(0x18b)]()})}}),await this[_0x16b633(0x241)]({..._0x453823,..._0x879a37,'shop':_0x38daa6},_0x3f828e['toUpperCase']()),await this[_0x16b633(0x22e)]({..._0x453823,..._0x879a37},_0x3f828e[_0x16b633(0x21a)]());if(_0x36885a!==_0x16b633(0x19e)&&_0x3f828e[_0x16b633(0x21a)]()===_0x16b633(0x19e)){console[_0x16b633(0x243)](_0x16b633(0x1b7)+_0x5995fa+_0x16b633(0x29a)),console[_0x16b633(0x243)](_0x16b633(0x1f1)+_0x36885a+'\x22,\x20newStatus=\x22'+_0x3f828e['toUpperCase']()+_0x16b633(0x21b)+_0x453823[_0x16b633(0x1bb)]+'\x22');if(_0x453823['paymentLinkId'])try{const _0x560260=await _0xca7479[_0x16b633(0x209)]['findUnique']({'where':{'id':_0x453823[_0x16b633(0x1bb)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x560260){console[_0x16b633(0x243)]('üìà\x20Found\x20payment\x20link\x20'+_0x560260['id']+':\x20type='+_0x560260[_0x16b633(0x2bc)]+_0x16b633(0x230)+_0x560260[_0x16b633(0x1ea)]+_0x16b633(0x290)+_0x560260[_0x16b633(0x1a6)]);const _0x267cd6=_0x560260[_0x16b633(0x1ea)]+0x1,_0x570b9c=_0x560260[_0x16b633(0x2bc)]===_0x16b633(0x2c0)?'COMPLETED':_0x560260[_0x16b633(0x1a6)];await _0xca7479[_0x16b633(0x209)][_0x16b633(0x1e2)]({'where':{'id':_0x453823[_0x16b633(0x1bb)]},'data':{'currentPayments':_0x267cd6,'status':_0x570b9c,'updatedAt':new Date()}}),console[_0x16b633(0x243)]('‚úÖ\x20Payment\x20link\x20'+_0x560260['id']+'\x20updated:\x20currentPayments='+_0x560260[_0x16b633(0x1ea)]+_0x16b633(0x25f)+_0x267cd6+',\x20status='+_0x560260[_0x16b633(0x1a6)]+_0x16b633(0x25f)+_0x570b9c);}else console['log'](_0x16b633(0x1f9)+_0x453823['paymentLinkId']+_0x16b633(0x29d));}catch(_0x194f9f){console[_0x16b633(0x196)](_0x16b633(0x1a2),_0x194f9f);}else console[_0x16b633(0x243)]('üìà\x20Payment\x20'+_0x5995fa+_0x16b633(0x1f7));}else console[_0x16b633(0x243)](_0x16b633(0x1b7)+_0x5995fa+_0x16b633(0x1c6)+_0x36885a+_0x16b633(0x25f)+_0x3f828e['toUpperCase']());});}async[a86_0x25b9dd(0x2d6)](_0x54dd65){const _0x3cd236=a86_0x25b9dd;console[_0x3cd236(0x243)](_0x3cd236(0x192),_0x54dd65);try{const _0x306d4d=await this[_0x3cd236(0x1c1)]['processWebhook'](_0x54dd65);if(!_0x306d4d[_0x3cd236(0x1b2)])throw new Error(_0x3cd236(0x255));const _0x349da0=await database_1[_0x3cd236(0x292)][_0x3cd236(0x1f5)][_0x3cd236(0x1e5)]({'where':{'gatewayOrderId':_0x306d4d[_0x3cd236(0x1b2)]}});if(!_0x349da0){console[_0x3cd236(0x196)](_0x3cd236(0x259)+_0x306d4d[_0x3cd236(0x1b2)]);return;}console[_0x3cd236(0x243)](_0x3cd236(0x19c)+_0x349da0['id']+'\x20status\x20'+_0x306d4d[_0x3cd236(0x1a6)]),await this[_0x3cd236(0x1a9)](_0x349da0['id'],_0x306d4d[_0x3cd236(0x1a6)],{'txUrls':_0x306d4d[_0x3cd236(0x203)]}),loggerService_1[_0x3cd236(0x2eb)][_0x3cd236(0x1fe)]('plisio',_0x349da0['id'],_0x349da0[_0x3cd236(0x1a6)],_0x306d4d[_0x3cd236(0x1a6)],_0x54dd65);}catch(_0x1ecd79){console[_0x3cd236(0x196)](_0x3cd236(0x1ed),_0x1ecd79),loggerService_1[_0x3cd236(0x2eb)]['logWebhookError'](_0x3cd236(0x215),_0x1ecd79,_0x54dd65);throw _0x1ecd79;}}async['processPlisioGatewayWebhook'](_0x3b962d){const _0x139bde=a86_0x25b9dd;console['log'](_0x139bde(0x234),_0x3b962d);try{const _0x52e2c6=await this[_0x139bde(0x1c1)][_0x139bde(0x1d6)](_0x3b962d);if(!_0x52e2c6[_0x139bde(0x1b2)])throw new Error(_0x139bde(0x1a4));const _0x605c6c=await database_1[_0x139bde(0x292)][_0x139bde(0x1f5)][_0x139bde(0x1e5)]({'where':{'gatewayOrderId':_0x52e2c6[_0x139bde(0x1b2)]}});if(!_0x605c6c){console[_0x139bde(0x196)](_0x139bde(0x21e)+_0x52e2c6[_0x139bde(0x1b2)]);return;}console[_0x139bde(0x243)](_0x139bde(0x222)+_0x605c6c['id']+'\x20status\x20'+_0x52e2c6[_0x139bde(0x1a6)]),await this[_0x139bde(0x1a9)](_0x605c6c['id'],_0x52e2c6['status'],{'txUrls':_0x52e2c6[_0x139bde(0x203)]}),loggerService_1['loggerService'][_0x139bde(0x1fe)](_0x139bde(0x2e5),_0x605c6c['id'],_0x605c6c['status'],_0x52e2c6[_0x139bde(0x1a6)],_0x3b962d);}catch(_0x4e8e4b){console[_0x139bde(0x196)](_0x139bde(0x2e4),_0x4e8e4b),loggerService_1[_0x139bde(0x2eb)][_0x139bde(0x250)]('plisio_gateway',_0x4e8e4b,_0x3b962d);throw _0x4e8e4b;}}async['processRapydWebhook'](_0x5c81cd){const _0x5338f8=a86_0x25b9dd;console[_0x5338f8(0x243)](_0x5338f8(0x1f8),_0x5c81cd);try{const _0x1ea8cd=await this[_0x5338f8(0x26c)]['processWebhook'](_0x5c81cd);if(!_0x1ea8cd['paymentId'])throw new Error(_0x5338f8(0x261));const _0x586d03=await database_1['default'][_0x5338f8(0x1f5)]['findFirst']({'where':{'gatewayOrderId':_0x1ea8cd['paymentId']}});if(!_0x586d03){console['error'](_0x5338f8(0x2e8)+_0x1ea8cd[_0x5338f8(0x1b2)]);return;}console['log'](_0x5338f8(0x2c9)+_0x586d03['id']+_0x5338f8(0x1dd)+_0x1ea8cd[_0x5338f8(0x1a6)]),await this['updatePaymentStatus'](_0x586d03['id'],_0x1ea8cd['status'],{'failureMessage':_0x1ea8cd[_0x5338f8(0x29b)],'cardLast4':_0x1ea8cd[_0x5338f8(0x247)]?.['cardLast4'],'cardBrand':_0x1ea8cd[_0x5338f8(0x247)]?.['cardBrand'],'paymentMethod':_0x1ea8cd['additionalInfo']?.[_0x5338f8(0x2b7)],'cardBin':_0x1ea8cd['additionalInfo']?.[_0x5338f8(0x2e3)],'cardBinStatus':_0x1ea8cd['additionalInfo']?.['cardBinStatus'],'cardType':_0x1ea8cd['additionalInfo']?.['cardType'],'cardCategory':_0x1ea8cd['additionalInfo']?.[_0x5338f8(0x2ea)],'cardCountry':_0x1ea8cd['additionalInfo']?.[_0x5338f8(0x1c3)],'cardIssuer':_0x1ea8cd['additionalInfo']?.[_0x5338f8(0x256)]}),loggerService_1[_0x5338f8(0x2eb)]['logWebhookProcessed'](_0x5338f8(0x24d),_0x586d03['id'],_0x586d03['status'],_0x1ea8cd[_0x5338f8(0x1a6)],_0x5c81cd);}catch(_0x27fa64){console[_0x5338f8(0x196)]('Error\x20processing\x20Rapyd\x20webhook:',_0x27fa64),loggerService_1[_0x5338f8(0x2eb)][_0x5338f8(0x250)](_0x5338f8(0x24d),_0x27fa64,_0x5c81cd);throw _0x27fa64;}}async[a86_0x25b9dd(0x1cc)](_0x23ba57){const _0x2960c2=a86_0x25b9dd;console[_0x2960c2(0x243)](_0x2960c2(0x2be),_0x23ba57);try{const _0xed3f55=await this[_0x2960c2(0x2a6)][_0x2960c2(0x1d6)](_0x23ba57);if(!_0xed3f55['paymentId'])throw new Error(_0x2960c2(0x1fa));const _0xf091f7=await database_1['default'][_0x2960c2(0x1f5)][_0x2960c2(0x1e5)]({'where':{'gatewayOrderId':_0xed3f55[_0x2960c2(0x1b2)]}});if(!_0xf091f7){console['error'](_0x2960c2(0x25d)+_0xed3f55[_0x2960c2(0x1b2)]);return;}console[_0x2960c2(0x243)](_0x2960c2(0x1cb)+_0xf091f7['id']+_0x2960c2(0x1dd)+_0xed3f55['status']),await this[_0x2960c2(0x1a9)](_0xf091f7['id'],_0xed3f55[_0x2960c2(0x1a6)],{'bankId':_0xed3f55['additionalInfo']?.['bankId'],'remitterIban':_0xed3f55[_0x2960c2(0x247)]?.[_0x2960c2(0x19b)],'remitterName':_0xed3f55[_0x2960c2(0x247)]?.[_0x2960c2(0x227)],'paymentMethod':_0x2960c2(0x1dc)}),loggerService_1['loggerService'][_0x2960c2(0x1fe)]('noda',_0xf091f7['id'],_0xf091f7[_0x2960c2(0x1a6)],_0xed3f55[_0x2960c2(0x1a6)],_0x23ba57);}catch(_0x57b690){console[_0x2960c2(0x196)]('Error\x20processing\x20Noda\x20webhook:',_0x57b690),loggerService_1[_0x2960c2(0x2eb)][_0x2960c2(0x250)](_0x2960c2(0x2a2),_0x57b690,_0x23ba57);throw _0x57b690;}}async[a86_0x25b9dd(0x237)](_0x431cfa){const _0x2efd9c=a86_0x25b9dd;console[_0x2efd9c(0x243)](_0x2efd9c(0x2e6),_0x431cfa);try{const _0x2659e9=await this['coinToPayService']['processWebhook'](_0x431cfa);if(!_0x2659e9[_0x2efd9c(0x1b2)])throw new Error(_0x2efd9c(0x2da));const _0x336891=await database_1[_0x2efd9c(0x292)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x2659e9[_0x2efd9c(0x1b2)]}});if(!_0x336891){console[_0x2efd9c(0x196)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x2659e9[_0x2efd9c(0x1b2)]);return;}console[_0x2efd9c(0x243)]('üìä\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x336891['id']+_0x2efd9c(0x1dd)+_0x2659e9[_0x2efd9c(0x1a6)]),await this[_0x2efd9c(0x1a9)](_0x336891['id'],_0x2659e9[_0x2efd9c(0x1a6)],{'paymentMethod':_0x2efd9c(0x1dc)}),loggerService_1[_0x2efd9c(0x2eb)][_0x2efd9c(0x1fe)](_0x2efd9c(0x205),_0x336891['id'],_0x336891[_0x2efd9c(0x1a6)],_0x2659e9[_0x2efd9c(0x1a6)],_0x431cfa);}catch(_0x51cdf1){console[_0x2efd9c(0x196)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x51cdf1),loggerService_1[_0x2efd9c(0x2eb)]['logWebhookError'](_0x2efd9c(0x205),_0x51cdf1,_0x431cfa);throw _0x51cdf1;}}async[a86_0x25b9dd(0x1f3)](_0x122039){const _0x191232=a86_0x25b9dd;console[_0x191232(0x243)](_0x191232(0x236),_0x122039);try{const _0x24d435=await this[_0x191232(0x235)][_0x191232(0x1d6)](_0x122039);if(!_0x24d435[_0x191232(0x1b2)])throw new Error(_0x191232(0x1a5));const _0x429d36=await database_1['default']['payment']['findFirst']({'where':{'gatewayOrderId':_0x24d435['paymentId']}});if(!_0x429d36){console[_0x191232(0x196)](_0x191232(0x224)+_0x24d435[_0x191232(0x1b2)]);return;}console['log'](_0x191232(0x195)+_0x429d36['id']+_0x191232(0x1dd)+_0x24d435[_0x191232(0x1a6)]),await this[_0x191232(0x1a9)](_0x429d36['id'],_0x24d435['status'],{'paymentMethod':_0x191232(0x1dc)}),loggerService_1['loggerService']['logWebhookProcessed'](_0x191232(0x1ec),_0x429d36['id'],_0x429d36[_0x191232(0x1a6)],_0x24d435[_0x191232(0x1a6)],_0x122039);}catch(_0x2cd5aa){console['error'](_0x191232(0x188),_0x2cd5aa),loggerService_1[_0x191232(0x2eb)][_0x191232(0x250)](_0x191232(0x1ec),_0x2cd5aa,_0x122039);throw _0x2cd5aa;}}async[a86_0x25b9dd(0x246)](_0x10d8c7){const _0x411f3b=a86_0x25b9dd;console[_0x411f3b(0x243)]('üîÑ\x20Processing\x20KLYME\x20webhook:',_0x10d8c7);try{const _0x44e309=await this['klymeService'][_0x411f3b(0x1d6)](_0x10d8c7);if(!_0x44e309[_0x411f3b(0x1b2)])throw new Error(_0x411f3b(0x221));const _0x4ddc84=await database_1[_0x411f3b(0x292)][_0x411f3b(0x1f5)][_0x411f3b(0x1e5)]({'where':{'gatewayOrderId':_0x44e309['paymentId']}});if(!_0x4ddc84){console[_0x411f3b(0x196)](_0x411f3b(0x266)+_0x44e309[_0x411f3b(0x1b2)]);return;}console[_0x411f3b(0x243)](_0x411f3b(0x2a4)+_0x4ddc84['id']+_0x411f3b(0x1dd)+_0x44e309[_0x411f3b(0x1a6)]),await this[_0x411f3b(0x1a9)](_0x4ddc84['id'],_0x44e309['status'],{'paymentMethod':_0x44e309[_0x411f3b(0x247)]?.['payment_method']}),loggerService_1[_0x411f3b(0x2eb)][_0x411f3b(0x1fe)](_0x411f3b(0x1b0),_0x4ddc84['id'],_0x4ddc84[_0x411f3b(0x1a6)],_0x44e309[_0x411f3b(0x1a6)],_0x10d8c7);}catch(_0x4b9e04){console[_0x411f3b(0x196)](_0x411f3b(0x17f),_0x4b9e04),loggerService_1['loggerService'][_0x411f3b(0x250)](_0x411f3b(0x1b0),_0x4b9e04,_0x10d8c7);throw _0x4b9e04;}}async[a86_0x25b9dd(0x17d)](_0x451b9a){const _0x5bca6b=a86_0x25b9dd;console[_0x5bca6b(0x243)](_0x5bca6b(0x1e4),JSON[_0x5bca6b(0x2df)](_0x451b9a,null,0x2));try{const _0x2fdc02=await this['visaMasterCardService'][_0x5bca6b(0x1d6)](_0x451b9a,_0x5bca6b(0x210));console[_0x5bca6b(0x243)]('üìä\x20VISA\x20webhook\x20result:',_0x2fdc02);if(!_0x2fdc02[_0x5bca6b(0x1b2)]){console[_0x5bca6b(0x196)](_0x5bca6b(0x267)),console['error'](_0x5bca6b(0x20a),Object['keys'](_0x451b9a));throw new Error(_0x5bca6b(0x2c7));}let _0x27196b=null;console[_0x5bca6b(0x243)]('üîç\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x2fdc02[_0x5bca6b(0x1b2)]);if(_0x2fdc02[_0x5bca6b(0x1b2)]){console[_0x5bca6b(0x243)](_0x5bca6b(0x295)),console[_0x5bca6b(0x243)](_0x5bca6b(0x244)),console[_0x5bca6b(0x243)]('\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard'),console['log'](_0x5bca6b(0x17b)+_0x2fdc02['paymentId']),console['log'](_0x5bca6b(0x1ad)),_0x27196b=await database_1['default'][_0x5bca6b(0x1f5)][_0x5bca6b(0x1e5)]({'where':{'AND':[{'OR':[{'gateway':'visa/mastercard'},{'gateway':_0x5bca6b(0x2c6)}]},{'OR':[{'gatewayPaymentId':_0x2fdc02[_0x5bca6b(0x1b2)]},{'gatewayOrderId':_0x2fdc02[_0x5bca6b(0x1b2)]},{'id':_0x2fdc02[_0x5bca6b(0x1b2)]},{'orderId':_0x2fdc02['paymentId']}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x5bca6b(0x243)](_0x5bca6b(0x26a));if(_0x27196b)console[_0x5bca6b(0x243)]('‚úÖ\x20Found\x20payment:\x20ID='+_0x27196b['id']+_0x5bca6b(0x28a)+_0x27196b['gatewayOrderId']+_0x5bca6b(0x202)+_0x27196b[_0x5bca6b(0x20b)]);else{console['log']('‚ùå\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...');const _0x184629=await database_1[_0x5bca6b(0x292)][_0x5bca6b(0x1f5)]['findMany']({'where':{'gateway':_0x5bca6b(0x28e)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x5bca6b(0x2d7)}});console[_0x5bca6b(0x243)](_0x5bca6b(0x1f4),_0x184629[_0x5bca6b(0x23e)](_0x40c460=>_0x40c460['id']+_0x5bca6b(0x260)+_0x40c460['orderId']+_0x5bca6b(0x213)+_0x40c460[_0x5bca6b(0x1da)]+_0x5bca6b(0x23d)+_0x40c460[_0x5bca6b(0x20b)]+_0x5bca6b(0x248)+_0x40c460['cardLast4']+')'));}console['log'](_0x5bca6b(0x2ca)+(_0x27196b?'Found':'Not\x20found')),_0x27196b&&console[_0x5bca6b(0x243)](_0x5bca6b(0x262)+_0x27196b['id']+_0x5bca6b(0x1bf)+_0x27196b[_0x5bca6b(0x207)]+_0x5bca6b(0x1a7)+_0x27196b[_0x5bca6b(0x1a6)]+_0x5bca6b(0x2b3)+_0x27196b[_0x5bca6b(0x223)]);}if(!_0x27196b){console[_0x5bca6b(0x196)](_0x5bca6b(0x1e7)+_0x2fdc02[_0x5bca6b(0x1b2)]),loggerService_1['loggerService'][_0x5bca6b(0x250)](_0x5bca6b(0x2ab),new Error(_0x5bca6b(0x245)+_0x2fdc02[_0x5bca6b(0x1b2)]),_0x451b9a);throw new Error(_0x5bca6b(0x2ac)+_0x2fdc02[_0x5bca6b(0x1b2)]);}console[_0x5bca6b(0x243)](_0x5bca6b(0x2e0)+_0x27196b['id']+_0x5bca6b(0x1ff)+_0x27196b[_0x5bca6b(0x1a6)]+_0x5bca6b(0x182)+_0x2fdc02[_0x5bca6b(0x1a6)]+')');const _0x296d55={};_0x2fdc02[_0x5bca6b(0x2b1)]&&await database_1['default'][_0x5bca6b(0x1f5)][_0x5bca6b(0x1e2)]({'where':{'id':_0x27196b['id']},'data':{'amount':_0x2fdc02[_0x5bca6b(0x2b1)],'updatedAt':new Date()}}),_0x2fdc02[_0x5bca6b(0x1e0)]&&await database_1[_0x5bca6b(0x292)][_0x5bca6b(0x1f5)][_0x5bca6b(0x1e2)]({'where':{'id':_0x27196b['id']},'data':{'currency':_0x2fdc02[_0x5bca6b(0x1e0)],'updatedAt':new Date()}}),_0x2fdc02[_0x5bca6b(0x1a6)]===_0x5bca6b(0x288)&&_0x2fdc02[_0x5bca6b(0x29e)]&&(_0x296d55[_0x5bca6b(0x29b)]=_0x2fdc02[_0x5bca6b(0x29e)],console[_0x5bca6b(0x243)](_0x5bca6b(0x2d5)+_0x2fdc02[_0x5bca6b(0x29e)])),_0x2fdc02[_0x5bca6b(0x294)]&&(_0x296d55[_0x5bca6b(0x294)]=_0x2fdc02[_0x5bca6b(0x294)],console[_0x5bca6b(0x243)](_0x5bca6b(0x252)+_0x2fdc02[_0x5bca6b(0x294)])),_0x296d55[_0x5bca6b(0x2b7)]=_0x5bca6b(0x2ba),await this['updatePaymentStatus'](_0x27196b['id'],_0x2fdc02[_0x5bca6b(0x1a6)],_0x296d55),await database_1[_0x5bca6b(0x292)]['webhookLog'][_0x5bca6b(0x1fc)]({'data':{'paymentId':_0x27196b['id'],'shopId':_0x27196b[_0x5bca6b(0x27f)],'event':_0x5bca6b(0x299)+_0x2fdc02[_0x5bca6b(0x1a6)][_0x5bca6b(0x24e)](),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x2fdc02)}}),await this['sendPaymentStatusNotification'](_0x27196b,_0x2fdc02[_0x5bca6b(0x1a6)][_0x5bca6b(0x21a)]()),console[_0x5bca6b(0x243)](_0x5bca6b(0x1fd)+_0x27196b['id']);}catch(_0x504fd5){console[_0x5bca6b(0x196)](_0x5bca6b(0x24a),_0x504fd5),loggerService_1[_0x5bca6b(0x2eb)]['logWebhookError'](_0x5bca6b(0x2ab),_0x504fd5,_0x451b9a);throw _0x504fd5;}}async[a86_0x25b9dd(0x263)](_0x271d04){const _0x23bc77=a86_0x25b9dd;console['log']('üîÑ\x20Processing\x20MasterCard\x20webhook:',JSON[_0x23bc77(0x2df)](_0x271d04,null,0x2));try{const _0x2517d7=await this[_0x23bc77(0x2af)]['processWebhook'](_0x271d04,'MASTERCARD');console[_0x23bc77(0x243)]('üìä\x20MasterCard\x20webhook\x20result:',_0x2517d7);if(!_0x2517d7[_0x23bc77(0x1b2)]){console[_0x23bc77(0x196)](_0x23bc77(0x25e)),console[_0x23bc77(0x196)](_0x23bc77(0x20a),Object[_0x23bc77(0x1ba)](_0x271d04));throw new Error(_0x23bc77(0x22f));}let _0x300e5a=null;console[_0x23bc77(0x243)](_0x23bc77(0x268)+_0x2517d7[_0x23bc77(0x1b2)]);_0x2517d7['paymentId']&&(console[_0x23bc77(0x243)](_0x23bc77(0x2c4)),_0x300e5a=await database_1[_0x23bc77(0x292)][_0x23bc77(0x1f5)][_0x23bc77(0x1e5)]({'where':{'AND':[{'OR':[{'gateway':_0x23bc77(0x1a3)},{'gateway':'mastercard'},{'gateway':_0x23bc77(0x28e)}]},{'OR':[{'gatewayPaymentId':_0x2517d7['paymentId']},{'gatewayOrderId':_0x2517d7['paymentId']},{'id':_0x2517d7[_0x23bc77(0x1b2)]},{'orderId':_0x2517d7['paymentId']}]}]}}),console[_0x23bc77(0x243)](_0x23bc77(0x2b2)+(_0x300e5a?_0x23bc77(0x285)+_0x300e5a['id']:'Payment\x20not\x20found')));if(!_0x300e5a){console[_0x23bc77(0x196)](_0x23bc77(0x2cf)+_0x2517d7[_0x23bc77(0x1b2)]),console['error'](_0x23bc77(0x283)+_0x2517d7[_0x23bc77(0x1b2)]+_0x23bc77(0x220)+_0x2517d7[_0x23bc77(0x1b2)]+_0x23bc77(0x1e6)+_0x2517d7[_0x23bc77(0x1b2)]+'\x22');const _0x5f47b8=await database_1[_0x23bc77(0x292)][_0x23bc77(0x1f5)][_0x23bc77(0x22a)]({'where':{'OR':[{'gateway':_0x23bc77(0x2c6)},{'gateway':_0x23bc77(0x1a3)},{'gateway':_0x23bc77(0x28e)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x23bc77(0x2d7)},'take':0xf});console[_0x23bc77(0x243)](_0x23bc77(0x2e2),_0x5f47b8),loggerService_1['loggerService'][_0x23bc77(0x250)]('mastercard',new Error(_0x23bc77(0x245)+_0x2517d7[_0x23bc77(0x1b2)]),_0x271d04);throw new Error(_0x23bc77(0x2b0)+_0x2517d7[_0x23bc77(0x1b2)]);}console[_0x23bc77(0x243)]('‚úÖ\x20Found\x20payment\x20'+_0x300e5a['id']+_0x23bc77(0x1b6)+_0x300e5a[_0x23bc77(0x1a6)]+_0x23bc77(0x1d9)+_0x2517d7[_0x23bc77(0x1a6)]);const _0xf8c49={};_0x2517d7[_0x23bc77(0x2b1)]&&await database_1['default'][_0x23bc77(0x1f5)][_0x23bc77(0x1e2)]({'where':{'id':_0x300e5a['id']},'data':{'amount':_0x2517d7[_0x23bc77(0x2b1)],'updatedAt':new Date()}}),_0x2517d7[_0x23bc77(0x1e0)]&&await database_1[_0x23bc77(0x292)][_0x23bc77(0x1f5)][_0x23bc77(0x1e2)]({'where':{'id':_0x300e5a['id']},'data':{'currency':_0x2517d7[_0x23bc77(0x1e0)],'updatedAt':new Date()}}),_0x2517d7[_0x23bc77(0x1a6)]==='FAILED'&&_0x2517d7['errorMessage']&&(_0xf8c49[_0x23bc77(0x29b)]=_0x2517d7[_0x23bc77(0x29e)],console['log'](_0x23bc77(0x1c7)+_0x2517d7[_0x23bc77(0x29e)])),_0x2517d7['cardBrand']&&(_0xf8c49[_0x23bc77(0x294)]=_0x2517d7['cardBrand'],console[_0x23bc77(0x243)]('üí≥\x20Card\x20brand\x20detected:\x20'+_0x2517d7[_0x23bc77(0x294)])),_0xf8c49[_0x23bc77(0x2b7)]=_0x23bc77(0x2ba),await this[_0x23bc77(0x1a9)](_0x300e5a['id'],_0x2517d7[_0x23bc77(0x1a6)],_0xf8c49),loggerService_1['loggerService'][_0x23bc77(0x1fe)]('mastercard',_0x300e5a['id'],_0x300e5a[_0x23bc77(0x1a6)],_0x2517d7['status'],_0x271d04);}catch(_0x56e95b){console[_0x23bc77(0x196)]('‚ùå\x20Error\x20processing\x20MasterCard\x20webhook:',_0x56e95b),loggerService_1[_0x23bc77(0x2eb)]['logWebhookError']('mastercard',_0x56e95b,_0x271d04);throw _0x56e95b;}}async[a86_0x25b9dd(0x23a)](_0x295bd3){const _0x418329=a86_0x25b9dd;console['log'](_0x418329(0x25c),JSON[_0x418329(0x2df)](_0x295bd3,null,0x2));try{const _0x3d4d66=await this[_0x418329(0x23c)]['processWebhook'](_0x295bd3);console[_0x418329(0x243)](_0x418329(0x27e),_0x3d4d66);if(!_0x3d4d66[_0x418329(0x1b2)]){console[_0x418329(0x196)](_0x418329(0x1cd)),console[_0x418329(0x196)](_0x418329(0x20a),Object[_0x418329(0x1ba)](_0x295bd3));throw new Error(_0x418329(0x297));}let _0x5b571e=null;console[_0x418329(0x243)](_0x418329(0x181)+_0x3d4d66[_0x418329(0x1b2)]),_0x5b571e=await database_1[_0x418329(0x292)][_0x418329(0x1f5)][_0x418329(0x1e5)]({'where':{'AND':[{'gateway':_0x418329(0x193)},{'OR':[{'gatewayPaymentId':_0x3d4d66[_0x418329(0x1b2)]},{'gatewayOrderId':_0x3d4d66[_0x418329(0x1b2)]},{'id':_0x3d4d66[_0x418329(0x1b2)]},{'orderId':_0x3d4d66['paymentId']}]}]}}),console[_0x418329(0x243)](_0x418329(0x2b2)+(_0x5b571e?'Found\x20payment\x20'+_0x5b571e['id']:_0x418329(0x278)));if(!_0x5b571e){console[_0x418329(0x196)](_0x418329(0x1f2)+_0x3d4d66[_0x418329(0x1b2)]);return;}console[_0x418329(0x243)]('üìä\x20Amer\x20webhook:\x20Payment\x20'+_0x5b571e['id']+_0x418329(0x1dd)+_0x3d4d66[_0x418329(0x1a6)]),await this['updatePaymentStatus'](_0x5b571e['id'],_0x3d4d66['status'],{'cardLast4':_0x3d4d66[_0x418329(0x247)]?.[_0x418329(0x223)],'paymentMethod':_0x3d4d66[_0x418329(0x247)]?.[_0x418329(0x2b7)]});}catch(_0x2ab7ba){console[_0x418329(0x196)](_0x418329(0x1d1),_0x2ab7ba),loggerService_1[_0x418329(0x2eb)]['logWebhookError'](_0x418329(0x193),_0x2ab7ba,_0x295bd3);throw _0x2ab7ba;}}async[a86_0x25b9dd(0x1d5)](_0x41094c){const _0x53f1c0=a86_0x25b9dd;console['log'](_0x53f1c0(0x2aa),JSON[_0x53f1c0(0x2df)](_0x41094c,null,0x2));try{const _0x19e8e9=_0x41094c[_0x53f1c0(0x1a6)],_0x3c300e=_0x41094c[_0x53f1c0(0x18f)],_0x418948=_0x41094c[_0x53f1c0(0x229)],_0x5d56fc=_0x41094c[_0x53f1c0(0x191)],_0x39b8e9=_0x41094c[_0x53f1c0(0x2b1)],_0x17fd47=_0x41094c[_0x53f1c0(0x1e0)],_0x130aa4=_0x41094c[_0x53f1c0(0x1f0)],_0x90621c=_0x41094c[_0x53f1c0(0x20d)];if(!_0x3c300e){console[_0x53f1c0(0x196)]('‚ùå\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook');throw new Error(_0x53f1c0(0x218));}console[_0x53f1c0(0x243)](_0x53f1c0(0x1df),{'status':_0x19e8e9,'clientTransactionId':_0x3c300e,'systemId':_0x418948,'paymentMethod':_0x5d56fc,'amount':_0x39b8e9,'currency':_0x17fd47,'commission':_0x130aa4,'statusAdditionInfo':_0x90621c});const _0x4d596f=await database_1[_0x53f1c0(0x292)][_0x53f1c0(0x1f5)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x3c300e},{'orderId':_0x3c300e},{'id':_0x3c300e},{'gatewayPaymentId':_0x3c300e}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x4d596f){console[_0x53f1c0(0x196)](_0x53f1c0(0x1c0)+_0x3c300e);throw new Error(_0x53f1c0(0x245)+_0x3c300e);}console[_0x53f1c0(0x243)]('‚úÖ\x20Found\x20payment\x20'+_0x4d596f['id']+_0x53f1c0(0x231)),console['log'](_0x53f1c0(0x29c)+_0x4d596f[_0x53f1c0(0x1a6)]+_0x53f1c0(0x182)+_0x19e8e9),_0x19e8e9===_0x53f1c0(0x2cb)?(console[_0x53f1c0(0x243)](_0x53f1c0(0x254)),await this[_0x53f1c0(0x1a9)](_0x4d596f['id'],_0x53f1c0(0x288)),console[_0x53f1c0(0x243)](_0x53f1c0(0x19a)+_0x4d596f['id']+_0x53f1c0(0x226)),console[_0x53f1c0(0x243)](_0x53f1c0(0x2e9)+(_0x90621c||_0x53f1c0(0x2d3)))):console[_0x53f1c0(0x243)](_0x53f1c0(0x184)+_0x19e8e9+_0x53f1c0(0x1c8)),await database_1[_0x53f1c0(0x292)]['webhookLog'][_0x53f1c0(0x1fc)]({'data':{'paymentId':_0x4d596f['id'],'shopId':_0x4d596f[_0x53f1c0(0x27f)],'event':'ampay_'+(_0x19e8e9?.['toLowerCase']()||'unknown'),'statusCode':0xc8,'responseBody':JSON[_0x53f1c0(0x2df)](_0x41094c)}}),loggerService_1[_0x53f1c0(0x2eb)][_0x53f1c0(0x1fe)](_0x53f1c0(0x2e1),_0x4d596f['id'],_0x4d596f['status'],_0x19e8e9===_0x53f1c0(0x2cb)?_0x53f1c0(0x288):_0x19e8e9,_0x41094c);}catch(_0x22a986){console[_0x53f1c0(0x196)](_0x53f1c0(0x1e9),_0x22a986),loggerService_1[_0x53f1c0(0x2eb)][_0x53f1c0(0x250)]('ampay',_0x22a986,_0x41094c);throw _0x22a986;}}async[a86_0x25b9dd(0x1eb)](_0x3eec3e){const _0x26ba09=a86_0x25b9dd;console[_0x26ba09(0x243)](_0x26ba09(0x293),JSON[_0x26ba09(0x2df)](_0x3eec3e,null,0x2));try{const _0x31f7d0=_0x3eec3e[_0x26ba09(0x1a6)],_0x5ebcfc=_0x3eec3e[_0x26ba09(0x18f)],_0x14afc5=_0x3eec3e['system_id'],_0x33eddd=_0x3eec3e[_0x26ba09(0x191)],_0x201b88=_0x3eec3e[_0x26ba09(0x2b1)],_0xb340b2=_0x3eec3e['currency'],_0x256d69=_0x3eec3e['commission'],_0x57ebed=_0x3eec3e['status_addition_info'];if(!_0x5ebcfc){console['error'](_0x26ba09(0x21d));throw new Error(_0x26ba09(0x225));}console['log'](_0x26ba09(0x1c4),{'status':_0x31f7d0,'clientTransactionId':_0x5ebcfc,'systemId':_0x14afc5,'paymentMethod':_0x33eddd,'amount':_0x201b88,'currency':_0xb340b2,'commission':_0x256d69,'statusAdditionInfo':_0x57ebed});const _0xcdb330=await database_1[_0x26ba09(0x292)][_0x26ba09(0x1f5)][_0x26ba09(0x1e5)]({'where':{'OR':[{'gatewayOrderId':_0x5ebcfc},{'orderId':_0x5ebcfc},{'id':_0x5ebcfc},{'gatewayPaymentId':_0x5ebcfc}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0xcdb330){console[_0x26ba09(0x196)]('‚ùå\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20'+_0x5ebcfc);throw new Error('Payment\x20not\x20found:\x20'+_0x5ebcfc);}console[_0x26ba09(0x243)](_0x26ba09(0x233)+_0xcdb330['id']+_0x26ba09(0x187)),console[_0x26ba09(0x243)](_0x26ba09(0x29c)+_0xcdb330[_0x26ba09(0x1a6)]+_0x26ba09(0x182)+_0x31f7d0),_0x31f7d0===_0x26ba09(0x2cb)?(console[_0x26ba09(0x243)](_0x26ba09(0x24b)),await this['updatePaymentStatus'](_0xcdb330['id'],_0x26ba09(0x288)),console['log'](_0x26ba09(0x2b5)+_0xcdb330['id']+_0x26ba09(0x226)),console[_0x26ba09(0x243)](_0x26ba09(0x2e9)+(_0x57ebed||_0x26ba09(0x2d3)))):console[_0x26ba09(0x243)](_0x26ba09(0x204)+_0x31f7d0+'\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)'),await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0xcdb330['id'],'shopId':_0xcdb330[_0x26ba09(0x27f)],'event':_0x26ba09(0x251)+(_0x31f7d0?.['toLowerCase']()||_0x26ba09(0x178)),'statusCode':0xc8,'responseBody':JSON[_0x26ba09(0x2df)](_0x3eec3e)}}),loggerService_1[_0x26ba09(0x2eb)][_0x26ba09(0x1fe)](_0x26ba09(0x264),_0xcdb330['id'],_0xcdb330[_0x26ba09(0x1a6)],_0x31f7d0===_0x26ba09(0x2cb)?_0x26ba09(0x288):_0x31f7d0,_0x3eec3e);}catch(_0x289337){console['error'](_0x26ba09(0x24f),_0x289337),loggerService_1[_0x26ba09(0x2eb)][_0x26ba09(0x250)](_0x26ba09(0x264),_0x289337,_0x3eec3e);throw _0x289337;}}async[a86_0x25b9dd(0x241)](_0x25d196,_0x121a17){const _0x57550d=a86_0x25b9dd,_0x37d52e=Date[_0x57550d(0x217)]();try{const _0x2b3dd3=_0x25d196[_0x57550d(0x201)],_0x23b7ee=_0x2b3dd3[_0x57550d(0x25a)];if(!_0x23b7ee?.['webhookUrl']){console[_0x57550d(0x243)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x2b3dd3['id']);return;}const _0x47ab73=_0x121a17===_0x57550d(0x19e)?_0x57550d(0x23b):_0x121a17===_0x57550d(0x288)?'payment.failed':_0x121a17===_0x57550d(0x219)?_0x57550d(0x211):_0x121a17===_0x57550d(0x228)?_0x57550d(0x211):_0x121a17===_0x57550d(0x27d)?_0x57550d(0x211):_0x57550d(0x2bd);let _0x337cf4=[];if(_0x23b7ee[_0x57550d(0x29f)])try{_0x337cf4=Array[_0x57550d(0x18d)](_0x23b7ee['webhookEvents'])?_0x23b7ee['webhookEvents']:JSON['parse'](_0x23b7ee[_0x57550d(0x29f)]);}catch(_0x41e34e){console[_0x57550d(0x196)](_0x57550d(0x26d),_0x41e34e),_0x337cf4=[];}if(!_0x337cf4['includes'](_0x47ab73)){console[_0x57550d(0x243)](_0x57550d(0x206)+_0x47ab73+_0x57550d(0x20c)+_0x2b3dd3['id']);return;}const _0x263b8a={'event':_0x47ab73,'payment':{'id':_0x25d196['id'],'order_id':_0x25d196[_0x57550d(0x239)],'gateway_order_id':_0x25d196[_0x57550d(0x1da)],'gateway':_0x25d196['gateway'],'amount':_0x25d196[_0x57550d(0x2b1)],'currency':_0x25d196[_0x57550d(0x1e0)],'status':_0x121a17['toLowerCase'](),'customer_email':_0x25d196[_0x57550d(0x2a9)],'customer_name':_0x25d196[_0x57550d(0x214)],'failure_message':_0x25d196[_0x57550d(0x29b)],'tx_urls':_0x25d196[_0x57550d(0x203)]?JSON['parse'](_0x25d196['txUrls']):null,'created_at':_0x25d196[_0x57550d(0x1cf)],'updated_at':_0x25d196['updatedAt']}},_0x2ae363=JSON['stringify'](_0x263b8a),_0x4746ca=crypto_1[_0x57550d(0x292)][_0x57550d(0x2d9)](_0x57550d(0x1db),_0x2b3dd3['secretKey'])[_0x57550d(0x1e2)](_0x2ae363)[_0x57550d(0x24c)]('hex'),_0x2279a0=await fetch(_0x23b7ee['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x57550d(0x253),'User-Agent':_0x57550d(0x1c5),'X-Webhook-Signature':_0x4746ca},'body':_0x2ae363}),_0x2bb902=Date[_0x57550d(0x217)]()-_0x37d52e,_0x110fcf=_0x2279a0['ok']?'Success':await _0x2279a0[_0x57550d(0x18c)]();loggerService_1[_0x57550d(0x2eb)]['logShopWebhookSent'](_0x25d196[_0x57550d(0x27f)],_0x23b7ee[_0x57550d(0x1ab)],_0x47ab73,_0x2279a0[_0x57550d(0x1a6)],_0x2bb902,_0x263b8a),console[_0x57550d(0x243)](_0x57550d(0x2ae)+_0x23b7ee[_0x57550d(0x1ab)]+_0x57550d(0x2ce)+_0x2279a0[_0x57550d(0x1a6)]+'\x20('+_0x2bb902+'ms)');}catch(_0x3f6e11){console[_0x57550d(0x196)](_0x57550d(0x28d),_0x3f6e11),loggerService_1['loggerService'][_0x57550d(0x26e)](_0x25d196[_0x57550d(0x27f)],_0x25d196['shop']?.[_0x57550d(0x25a)]?.[_0x57550d(0x1ab)]||_0x57550d(0x178),'webhook_send',_0x3f6e11,{});}}async[a86_0x25b9dd(0x22e)](_0x3e6b79,_0x256ae8){const _0x5a8b15=a86_0x25b9dd;try{const _0x513cf3={'PENDING':'created','PROCESSING':'processing','PAID':_0x5a8b15(0x200),'FAILED':_0x5a8b15(0x2d8),'EXPIRED':_0x5a8b15(0x1d3),'REFUND':_0x5a8b15(0x199),'CHARGEBACK':_0x5a8b15(0x180)},_0x213b36=_0x513cf3[_0x256ae8];if(!_0x213b36||_0x213b36==='created')return;await telegramBotService_1['telegramBotService'][_0x5a8b15(0x2d2)](_0x3e6b79[_0x5a8b15(0x27f)],_0x3e6b79,_0x213b36);}catch(_0x2672a4){console[_0x5a8b15(0x196)](_0x5a8b15(0x2b6),_0x2672a4);}}async['getGatewayCommission'](_0x1f23ab,_0x419ca0){const _0x426c68=a86_0x25b9dd;try{const _0x2870f5=await database_1[_0x426c68(0x292)]['shop']['findUnique']({'where':{'id':_0x1f23ab},'select':{'gatewaySettings':!![]}});if(!_0x2870f5?.[_0x426c68(0x1ce)])return console[_0x426c68(0x243)](_0x426c68(0x286)+_0x1f23ab+_0x426c68(0x1aa)),0xa;const _0x224ce1=JSON['parse'](_0x2870f5[_0x426c68(0x1ce)]);for(const [_0xf968d1,_0x1b58ac]of Object[_0x426c68(0x276)](_0x224ce1)){if(_0xf968d1[_0x426c68(0x24e)]()===_0x419ca0['toLowerCase']()){const _0x2e7225=_0x1b58ac[_0x426c68(0x1f0)]||0xa;return console[_0x426c68(0x243)]('Gateway\x20'+_0x419ca0+_0x426c68(0x1ee)+_0x1f23ab+':\x20'+_0x2e7225+'%'),_0x2e7225;}}return console['log'](_0x426c68(0x1b3)+_0x419ca0+_0x426c68(0x1e8)+_0x1f23ab+_0x426c68(0x22d)),0xa;}catch(_0x5bc43c){return console[_0x426c68(0x196)](_0x426c68(0x26b)+_0x1f23ab+_0x426c68(0x179)+_0x419ca0+':',_0x5bc43c),0xa;}}async[a86_0x25b9dd(0x1b1)](_0x2102b1,_0x1c1684){const _0x5ed51a=a86_0x25b9dd;console['log']('üîÑ\x20Processing\x20MyXSpend\x20webhook:'),console[_0x5ed51a(0x243)]('Query\x20params:',JSON[_0x5ed51a(0x2df)](_0x2102b1,null,0x2)),console[_0x5ed51a(0x243)]('Body\x20data:',JSON[_0x5ed51a(0x2df)](_0x1c1684,null,0x2));try{const _0x46d83f=_0x2102b1[_0x5ed51a(0x21f)]||_0x1c1684[_0x5ed51a(0x21f)],_0x4788ad=_0x2102b1['status']||_0x1c1684['status'],_0xa82110=_0x2102b1[_0x5ed51a(0x2b1)]||_0x1c1684['amount'],_0x494347=_0x2102b1[_0x5ed51a(0x1e0)]||_0x1c1684[_0x5ed51a(0x1e0)],_0x3ca82a=_0x2102b1[_0x5ed51a(0x1af)]||_0x1c1684[_0x5ed51a(0x1af)];if(!_0x46d83f){console[_0x5ed51a(0x196)](_0x5ed51a(0x28b));throw new Error('Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook');}console[_0x5ed51a(0x243)]('üìä\x20MyXSpend\x20webhook\x20data:',{'customerOrderId':_0x46d83f,'status':_0x4788ad,'amount':_0xa82110,'currency':_0x494347,'dateTime':_0x3ca82a});const _0x1a70e1=await database_1[_0x5ed51a(0x292)][_0x5ed51a(0x1f5)][_0x5ed51a(0x1e5)]({'where':{'OR':[{'gatewayOrderId':_0x46d83f},{'orderId':_0x46d83f},{'id':_0x46d83f},{'gatewayPaymentId':_0x46d83f}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1a70e1){console[_0x5ed51a(0x196)](_0x5ed51a(0x1bd)+_0x46d83f);throw new Error(_0x5ed51a(0x245)+_0x46d83f);}console[_0x5ed51a(0x243)](_0x5ed51a(0x233)+_0x1a70e1['id']+_0x5ed51a(0x22c)),console[_0x5ed51a(0x243)]('üìä\x20Payment\x20status:\x20'+_0x1a70e1[_0x5ed51a(0x1a6)]+'\x20‚Üí\x20'+_0x4788ad);let _0x4244fc=_0x4788ad?.['toUpperCase']();_0x4788ad===_0x5ed51a(0x288)||_0x4788ad===_0x5ed51a(0x219)?(_0x4244fc=_0x5ed51a(0x288),console[_0x5ed51a(0x243)](_0x5ed51a(0x1e3)+_0x4788ad+_0x5ed51a(0x194)),await this[_0x5ed51a(0x1a9)](_0x1a70e1['id'],_0x4244fc),console['log'](_0x5ed51a(0x282)+_0x1a70e1['id']+_0x5ed51a(0x226))):console[_0x5ed51a(0x243)](_0x5ed51a(0x272)+_0x4788ad+'\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)'),await database_1['default'][_0x5ed51a(0x1a1)]['create']({'data':{'paymentId':_0x1a70e1['id'],'shopId':_0x1a70e1['shopId'],'event':_0x5ed51a(0x279)+(_0x4788ad?.[_0x5ed51a(0x24e)]()||'unknown'),'statusCode':0xc8,'responseBody':JSON[_0x5ed51a(0x2df)]({'queryParams':_0x2102b1,'bodyData':_0x1c1684})}}),loggerService_1[_0x5ed51a(0x2eb)]['logWebhookProcessed'](_0x5ed51a(0x17c),_0x1a70e1['id'],_0x1a70e1[_0x5ed51a(0x1a6)],_0x4244fc||_0x4788ad,{'queryParams':_0x2102b1,'bodyData':_0x1c1684});}catch(_0x17070e){console['error'](_0x5ed51a(0x1ca),_0x17070e),loggerService_1[_0x5ed51a(0x2eb)][_0x5ed51a(0x250)](_0x5ed51a(0x17c),_0x17070e,{'queryParams':_0x2102b1,'bodyData':_0x1c1684});throw _0x17070e;}}async[a86_0x25b9dd(0x186)](_0x14d362){const _0x5607a1=a86_0x25b9dd;console['log'](_0x5607a1(0x2b4),_0x14d362);try{const _0x46fb9b=this[_0x5607a1(0x1b9)][_0x5607a1(0x1d6)](_0x14d362);if(!_0x46fb9b[_0x5607a1(0x1b2)])throw new Error(_0x5607a1(0x17e));const _0x5e4fa3=await database_1[_0x5607a1(0x292)][_0x5607a1(0x1f5)][_0x5607a1(0x1e5)]({'where':{'gatewayOrderId':_0x46fb9b[_0x5607a1(0x1b2)]}});if(!_0x5e4fa3){console['error'](_0x5607a1(0x257)+_0x46fb9b['paymentId']);return;}console[_0x5607a1(0x243)]('üìä\x20MaxPara\x20webhook:\x20Payment\x20'+_0x5e4fa3['id']+_0x5607a1(0x1dd)+_0x46fb9b[_0x5607a1(0x1a6)]),await this['updatePaymentStatus'](_0x5e4fa3['id'],_0x46fb9b['status'],{'paymentMethod':'IBAN','failureMessage':_0x46fb9b['additionalInfo']?.[_0x5607a1(0x1d4)]}),loggerService_1[_0x5607a1(0x2eb)][_0x5607a1(0x1fe)](_0x5607a1(0x1be),_0x5e4fa3['id'],_0x5e4fa3[_0x5607a1(0x1a6)],_0x46fb9b[_0x5607a1(0x1a6)],_0x14d362);}catch(_0x165836){console[_0x5607a1(0x196)]('Error\x20processing\x20MaxPara\x20webhook:',_0x165836),loggerService_1[_0x5607a1(0x2eb)][_0x5607a1(0x250)](_0x5607a1(0x1be),_0x165836,_0x14d362);throw _0x165836;}}async['processOxaPayWebhook'](_0xd5d538){const _0xf35555=a86_0x25b9dd;console[_0xf35555(0x243)]('üîÑ\x20Processing\x20OxaPay\x20webhook:',_0xd5d538);try{const {track_id:_0x21b528,status:_0xe63146,order_id:_0x468503,txs:_0x41f3e8}=_0xd5d538;if(!_0x468503)throw new Error('No\x20order_id\x20in\x20OxaPay\x20webhook');const _0x228d02=await database_1['default']['payment'][_0xf35555(0x1e5)]({'where':{'gatewayOrderId':_0x468503}});if(!_0x228d02){console['error'](_0xf35555(0x275)+_0x468503);return;}console[_0xf35555(0x243)](_0xf35555(0x28f)+_0x228d02['id']+_0xf35555(0x1dd)+_0xe63146);const _0x5cb038=this[_0xf35555(0x19f)][_0xf35555(0x1d7)](_0xe63146),_0x4288e1=[];if(_0x41f3e8&&Array[_0xf35555(0x18d)](_0x41f3e8))for(const _0x2ce1c9 of _0x41f3e8){_0x2ce1c9[_0xf35555(0x1a8)]&&_0x4288e1[_0xf35555(0x2a8)](_0x2ce1c9['tx_hash']);}await this[_0xf35555(0x1a9)](_0x228d02['id'],_0x5cb038,{'txUrls':_0x4288e1['length']>0x0?_0x4288e1:undefined}),loggerService_1[_0xf35555(0x2eb)][_0xf35555(0x1fe)](_0xf35555(0x1e1),_0x228d02['id'],_0x228d02['status'],_0x5cb038,_0xd5d538);}catch(_0x1dac30){console['error']('Error\x20processing\x20OxaPay\x20webhook:',_0x1dac30),loggerService_1['loggerService'][_0xf35555(0x250)]('oxapay',_0x1dac30,_0xd5d538);throw _0x1dac30;}}}exports[a86_0x25b9dd(0x2a7)]=WebhookService;