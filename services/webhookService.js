'use strict';function a55_0x1056(){const _0x39a256=['PENDING','RapydService','Error\x20processing\x20CoinToPay\x20webhook:','214584oWIRJC','Processing\x20Plisio\x20webhook:','length','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook','296796DZZrDn','32fXtTec','settings','default','Webhook\x20event\x20','sendPaymentStatusNotification','payment','remitterName','NodaService','findFirst','remitterIban','processWebhook','paidAt','5333312EfRByn','now','bankId','Processing\x20Noda\x20webhook:','webhookLog','\x20failure\x20message:\x20','EXPIRED','klyme_eu','\x20->\x20','12jNodxf','91XykUCI','âœ…\x20Payment\x20','region','plisio_gateway','PlisioService','./telegramBotService','PAID','\x20URLs','update','KlymeService','status','__importDefault','Error\x20processing\x20Noda\x20webhook:','\x20status\x20to\x20','loggerService','processPlisioGatewayWebhook','rapydService','./paymentLinkService','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','currency','stringify','\x20webhook','CoinToPayService','FAILED','payment.failed','3CgVLim','Processing\x20KLYME\x20webhook:','\x20not\x20enabled\x20for\x20shop\x20','369345bBLozo','toLowerCase','Error\x20parsing\x20tx_urls\x20for\x20webhook:','processRapydWebhook','shop','logWebhookProcessed','Shop\x20webhook\x20sent\x20to\x20','TesSoft\x20Payment\x20System/1.0','\x20and\x20gateway:\x20','txUrls','parse','additionalInfo','\x20transaction\x20URLs:','logShopWebhookError','sendPaymentNotification','log','logWebhookError','Error\x20processing\x20Plisio\x20webhook:','Payment\x20','1152315RqFxer','amount','No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook','Error\x20parsing\x20webhook\x20events:','klyme_','noda','PaymentLinkService','50710clzjtV','processCoinToPayWebhook','created','ðŸ”„\x20Updating\x20payment\x20','webhookEvents','paid','isArray','shopId','paymentMethod','includes','POST','__esModule','webhookUrl','ðŸ’¾\x20Saving\x20failure\x20message:\x20','application/json','customerName','plisioService','gateway','rapyd','failureMessage','payment.success','failed','error','../config/database','\x20status\x20change:\x20','Error\x20processing\x20Rapyd\x20webhook:','defineProperty','ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20','handleSuccessfulPayment','\x20status\x20unchanged\x20(','No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook','Failed\x20to\x20update\x20payment\x20link\x20counter:','Error\x20processing\x20KLYME\x20webhook:','klyme','ðŸ’¾\x20Failure\x20message\x20saved:\x20','Processing\x20Plisio\x20Gateway\x20webhook:','coinToPayService','nodaService','unknown','create','Success','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook','42057015iUVJPk','plisio','1881WUkCdU','processKlymeWebhook','text','customerEmail','./gateways/coinToPayService','cardLast4','Processing\x20CoinToPay\x20webhook:','./gateways/klymeService','\x20updated\x20successfully:\x20','paymentLinkService','./gateways/nodaService','WebhookService','./loggerService','_webhook_','ms)','updatePaymentStatus','cointopay','paymentId','ðŸ’¥\x20Payment\x20'];a55_0x1056=function(){return _0x39a256;};return a55_0x1056();}const a55_0x557f2f=a55_0x3976;(function(_0x50c4de,_0x2ffb23){const _0x10aaef=a55_0x3976,_0x4b2366=_0x50c4de();while(!![]){try{const _0x33b089=-parseInt(_0x10aaef(0xc1))/0x1+parseInt(_0x10aaef(0x7b))/0x2*(-parseInt(_0x10aaef(0xab))/0x3)+-parseInt(_0x10aaef(0x7c))/0x4*(parseInt(_0x10aaef(0xae))/0x5)+parseInt(_0x10aaef(0x10a))/0x6*(parseInt(_0x10aaef(0x92))/0x7)+-parseInt(_0x10aaef(0x88))/0x8+-parseInt(_0x10aaef(0xf4))/0x9*(parseInt(_0x10aaef(0xc8))/0xa)+parseInt(_0x10aaef(0xf2))/0xb*(parseInt(_0x10aaef(0x91))/0xc);if(_0x33b089===_0x2ffb23)break;else _0x4b2366['push'](_0x4b2366['shift']());}catch(_0x584ea3){_0x4b2366['push'](_0x4b2366['shift']());}}}(a55_0x1056,0xa39b1));var __importDefault=this&&this[a55_0x557f2f(0x9d)]||function(_0x8fc0ec){const _0x241fbb=a55_0x557f2f;return _0x8fc0ec&&_0x8fc0ec[_0x241fbb(0xd3)]?_0x8fc0ec:{'default':_0x8fc0ec};};function a55_0x3976(_0x5d78b1,_0x115034){const _0x105621=a55_0x1056();return a55_0x3976=function(_0x3976fb,_0x35f705){_0x3976fb=_0x3976fb-0x79;let _0x2065f6=_0x105621[_0x3976fb];return _0x2065f6;},a55_0x3976(_0x5d78b1,_0x115034);}Object[a55_0x557f2f(0xe2)](exports,a55_0x557f2f(0xd3),{'value':!![]}),exports[a55_0x557f2f(0xff)]=void 0x0;const database_1=__importDefault(require(a55_0x557f2f(0xdf))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a55_0x557f2f(0xfe)),coinToPayService_1=require(a55_0x557f2f(0xf8)),klymeService_1=require(a55_0x557f2f(0xfb)),telegramBotService_1=require(a55_0x557f2f(0x97)),paymentLinkService_1=require(a55_0x557f2f(0xa3)),loggerService_1=require(a55_0x557f2f(0x100));class WebhookService{constructor(){const _0xcdc132=a55_0x557f2f;this['plisioService']=new plisioService_1[(_0xcdc132(0x96))](),this['rapydService']=new rapydService_1[(_0xcdc132(0x108))](),this[_0xcdc132(0xed)]=new nodaService_1[(_0xcdc132(0x83))](),this[_0xcdc132(0xec)]=new coinToPayService_1[(_0xcdc132(0xa8))](),this['klymeService']=new klymeService_1[(_0xcdc132(0x9b))](),this[_0xcdc132(0xfd)]=new paymentLinkService_1[(_0xcdc132(0xc7))]();}async['processPlisioWebhook'](_0x4d7127){const _0x27bc42=a55_0x557f2f;console[_0x27bc42(0xbd)](_0x27bc42(0x10b),_0x4d7127);try{const _0x3e5e98=await this[_0x27bc42(0xd8)][_0x27bc42(0x86)](_0x4d7127);if(!_0x3e5e98[_0x27bc42(0x105)]){console[_0x27bc42(0xde)](_0x27bc42(0xf1));return;}await this[_0x27bc42(0x103)](_0x3e5e98[_0x27bc42(0x105)],_0x3e5e98[_0x27bc42(0x9c)],_0x27bc42(0xf3),_0x4d7127,undefined,undefined,_0x3e5e98[_0x27bc42(0xb7)]),loggerService_1[_0x27bc42(0xa0)][_0x27bc42(0xb3)](_0x27bc42(0xf3),_0x3e5e98[_0x27bc42(0x105)],_0x27bc42(0x107),_0x3e5e98[_0x27bc42(0x9c)],_0x4d7127);}catch(_0xc1f4d9){console['error'](_0x27bc42(0xbf),_0xc1f4d9),loggerService_1[_0x27bc42(0xa0)]['logWebhookError'](_0x27bc42(0xf3),_0xc1f4d9,_0x4d7127);throw _0xc1f4d9;}}async[a55_0x557f2f(0xa1)](_0x404f19){const _0x4d197a=a55_0x557f2f;console['log'](_0x4d197a(0xeb),_0x404f19);try{const _0x151380=await this[_0x4d197a(0xd8)][_0x4d197a(0x86)](_0x404f19);if(!_0x151380[_0x4d197a(0x105)]){console['error'](_0x4d197a(0x7a));return;}await this[_0x4d197a(0x103)](_0x151380['paymentId'],_0x151380[_0x4d197a(0x9c)],_0x4d197a(0xf3),_0x404f19,undefined,undefined,_0x151380[_0x4d197a(0xb7)]),loggerService_1[_0x4d197a(0xa0)][_0x4d197a(0xb3)]('plisio_gateway',_0x151380[_0x4d197a(0x105)],'PENDING',_0x151380['status'],_0x404f19);}catch(_0x97fcf6){console[_0x4d197a(0xde)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x97fcf6),loggerService_1['loggerService'][_0x4d197a(0xbe)](_0x4d197a(0x95),_0x97fcf6,_0x404f19);throw _0x97fcf6;}}async[a55_0x557f2f(0xb1)](_0x27d9f0){const _0xf6e0b6=a55_0x557f2f;console[_0xf6e0b6(0xbd)]('Processing\x20Rapyd\x20webhook:',_0x27d9f0);try{const _0x1db884=await this[_0xf6e0b6(0xa2)]['processWebhook'](_0x27d9f0);if(!_0x1db884['paymentId']){console[_0xf6e0b6(0xde)](_0xf6e0b6(0xe6));return;}await this['updatePaymentStatus'](_0x1db884[_0xf6e0b6(0x105)],_0x1db884[_0xf6e0b6(0x9c)],_0xf6e0b6(0xda),_0x27d9f0,_0x1db884[_0xf6e0b6(0xdb)],_0x1db884[_0xf6e0b6(0xb9)]),loggerService_1[_0xf6e0b6(0xa0)][_0xf6e0b6(0xb3)]('rapyd',_0x1db884[_0xf6e0b6(0x105)],_0xf6e0b6(0x107),_0x1db884['status'],_0x27d9f0);}catch(_0x2a16e8){console['error'](_0xf6e0b6(0xe1),_0x2a16e8),loggerService_1[_0xf6e0b6(0xa0)][_0xf6e0b6(0xbe)](_0xf6e0b6(0xda),_0x2a16e8,_0x27d9f0);throw _0x2a16e8;}}async['processNodaWebhook'](_0x3cfe5c){const _0x1c1a8e=a55_0x557f2f;console[_0x1c1a8e(0xbd)](_0x1c1a8e(0x8b),_0x3cfe5c);try{const _0x131a8d=await this[_0x1c1a8e(0xed)][_0x1c1a8e(0x86)](_0x3cfe5c);if(!_0x131a8d['paymentId']){console[_0x1c1a8e(0xde)]('No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook');return;}await this[_0x1c1a8e(0x103)](_0x131a8d['paymentId'],_0x131a8d[_0x1c1a8e(0x9c)],_0x1c1a8e(0xc6),_0x3cfe5c,undefined,_0x131a8d[_0x1c1a8e(0xb9)]),loggerService_1[_0x1c1a8e(0xa0)]['logWebhookProcessed'](_0x1c1a8e(0xc6),_0x131a8d[_0x1c1a8e(0x105)],_0x1c1a8e(0x107),_0x131a8d[_0x1c1a8e(0x9c)],_0x3cfe5c);}catch(_0x3d9eb6){console[_0x1c1a8e(0xde)](_0x1c1a8e(0x9e),_0x3d9eb6),loggerService_1['loggerService'][_0x1c1a8e(0xbe)](_0x1c1a8e(0xc6),_0x3d9eb6,_0x3cfe5c);throw _0x3d9eb6;}}async[a55_0x557f2f(0xc9)](_0x1caf84){const _0x5baf94=a55_0x557f2f;console[_0x5baf94(0xbd)](_0x5baf94(0xfa),_0x1caf84);try{const _0x428f8b=await this[_0x5baf94(0xec)][_0x5baf94(0x86)](_0x1caf84);if(!_0x428f8b[_0x5baf94(0x105)]){console[_0x5baf94(0xde)](_0x5baf94(0xc3));return;}await this[_0x5baf94(0x103)](_0x428f8b[_0x5baf94(0x105)],_0x428f8b[_0x5baf94(0x9c)],'cointopay',_0x1caf84),loggerService_1[_0x5baf94(0xa0)][_0x5baf94(0xb3)](_0x5baf94(0x104),_0x428f8b[_0x5baf94(0x105)],'PENDING',_0x428f8b[_0x5baf94(0x9c)],_0x1caf84);}catch(_0x33e765){console['error'](_0x5baf94(0x109),_0x33e765),loggerService_1['loggerService'][_0x5baf94(0xbe)]('cointopay',_0x33e765,_0x1caf84);throw _0x33e765;}}async[a55_0x557f2f(0xf5)](_0xc98ff9){const _0x5997f7=a55_0x557f2f;console[_0x5997f7(0xbd)](_0x5997f7(0xac),_0xc98ff9);try{const _0x5dc739=await this['klymeService']['processWebhook'](_0xc98ff9);if(!_0x5dc739[_0x5997f7(0x105)]){console[_0x5997f7(0xde)]('No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook');return;}const _0x4a1a6a=_0x5dc739['region']?_0x5997f7(0xc5)+_0x5dc739[_0x5997f7(0x94)][_0x5997f7(0xaf)]():_0x5997f7(0x8f);await this[_0x5997f7(0x103)](_0x5dc739[_0x5997f7(0x105)],_0x5dc739['status'],_0x4a1a6a,_0xc98ff9,undefined,_0x5dc739[_0x5997f7(0xb9)]),loggerService_1[_0x5997f7(0xa0)][_0x5997f7(0xb3)](_0x5997f7(0xe9),_0x5dc739['paymentId'],_0x5997f7(0x107),_0x5dc739[_0x5997f7(0x9c)],_0xc98ff9);}catch(_0x455d16){console['error'](_0x5997f7(0xe8),_0x455d16),loggerService_1[_0x5997f7(0xa0)]['logWebhookError'](_0x5997f7(0xe9),_0x455d16,_0xc98ff9);throw _0x455d16;}}async[a55_0x557f2f(0x103)](_0x322c06,_0x19b7c8,_0x3f203e,_0x1de49c,_0x331aa0,_0x18b80d,_0xd82f6e){const _0x2c52b9=a55_0x557f2f;console[_0x2c52b9(0xbd)](_0x2c52b9(0xcb)+_0x322c06+_0x2c52b9(0x9f)+_0x19b7c8+'\x20from\x20'+_0x3f203e+_0x2c52b9(0xa7));_0x331aa0&&console[_0x2c52b9(0xbd)](_0x2c52b9(0x106)+_0x322c06+_0x2c52b9(0x8d)+_0x331aa0);_0xd82f6e&&_0xd82f6e['length']>0x0&&console[_0x2c52b9(0xbd)]('ðŸ”—\x20Payment\x20'+_0x322c06+_0x2c52b9(0xba),_0xd82f6e);const _0x5b31af=await database_1[_0x2c52b9(0x7e)][_0x2c52b9(0x81)][_0x2c52b9(0x84)]({'where':{'gatewayOrderId':_0x322c06,'gateway':_0x3f203e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5b31af){console[_0x2c52b9(0xde)](_0x2c52b9(0xa4)+_0x322c06+_0x2c52b9(0xb6)+_0x3f203e);return;}const _0x14c669=_0x5b31af[_0x2c52b9(0x9c)];if(_0x14c669===_0x19b7c8){console[_0x2c52b9(0xbd)](_0x2c52b9(0xc0)+_0x5b31af['id']+_0x2c52b9(0xe5)+_0x19b7c8+')');return;}console['log'](_0x2c52b9(0xc0)+_0x5b31af['id']+_0x2c52b9(0xe0)+_0x14c669+_0x2c52b9(0x90)+_0x19b7c8);const _0x32794e={'status':_0x19b7c8,'updatedAt':new Date()};_0x331aa0&&(_0x32794e[_0x2c52b9(0xdb)]=_0x331aa0,console['log'](_0x2c52b9(0xd5)+_0x331aa0));_0xd82f6e&&_0xd82f6e[_0x2c52b9(0x79)]>0x0&&(_0x32794e[_0x2c52b9(0xb7)]=JSON[_0x2c52b9(0xa6)](_0xd82f6e),console[_0x2c52b9(0xbd)]('ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20'+JSON['stringify'](_0xd82f6e)));_0x19b7c8===_0x2c52b9(0x98)&&_0x14c669!==_0x2c52b9(0x98)&&(_0x32794e[_0x2c52b9(0x87)]=new Date());_0x18b80d&&(_0x18b80d['cardLast4']&&(_0x32794e[_0x2c52b9(0xf9)]=_0x18b80d[_0x2c52b9(0xf9)]),_0x18b80d[_0x2c52b9(0xd0)]&&(_0x32794e[_0x2c52b9(0xd0)]=_0x18b80d[_0x2c52b9(0xd0)]),_0x18b80d[_0x2c52b9(0x8a)]&&(_0x32794e[_0x2c52b9(0x8a)]=_0x18b80d['bankId']),_0x18b80d[_0x2c52b9(0x85)]&&(_0x32794e[_0x2c52b9(0x85)]=_0x18b80d['remitterIban']),_0x18b80d[_0x2c52b9(0x82)]&&(_0x32794e['remitterName']=_0x18b80d['remitterName']));await database_1[_0x2c52b9(0x7e)][_0x2c52b9(0x81)][_0x2c52b9(0x9a)]({'where':{'id':_0x5b31af['id']},'data':_0x32794e});if(_0x19b7c8===_0x2c52b9(0x98)&&_0x14c669!==_0x2c52b9(0x98))try{await this[_0x2c52b9(0xfd)][_0x2c52b9(0xe4)](_0x5b31af['id']);}catch(_0x5543dd){console[_0x2c52b9(0xde)](_0x2c52b9(0xe7),_0x5543dd);}await database_1[_0x2c52b9(0x7e)][_0x2c52b9(0x8c)][_0x2c52b9(0xef)]({'data':{'paymentId':_0x5b31af['id'],'shopId':_0x5b31af[_0x2c52b9(0xcf)],'event':_0x3f203e+_0x2c52b9(0x101)+_0x19b7c8[_0x2c52b9(0xaf)](),'statusCode':0xc8,'responseBody':JSON[_0x2c52b9(0xa6)]({'oldStatus':_0x14c669,'newStatus':_0x19b7c8,'failureMessage':_0x331aa0,'txUrls':_0xd82f6e,'webhookData':_0x1de49c})}}),await this['sendShopWebhook'](_0x5b31af,_0x19b7c8),await this[_0x2c52b9(0x80)](_0x5b31af,_0x19b7c8),console[_0x2c52b9(0xbd)](_0x2c52b9(0x93)+_0x5b31af['id']+_0x2c52b9(0xfc)+_0x14c669+_0x2c52b9(0x90)+_0x19b7c8),_0x331aa0&&console[_0x2c52b9(0xbd)](_0x2c52b9(0xea)+_0x331aa0),_0xd82f6e&&_0xd82f6e['length']>0x0&&console['log'](_0x2c52b9(0xe3)+_0xd82f6e['length']+_0x2c52b9(0x99));}async['sendShopWebhook'](_0x809aa1,_0x24d619){const _0x19238c=a55_0x557f2f,_0x5be037=Date[_0x19238c(0x89)]();try{const _0x301841=_0x809aa1[_0x19238c(0xb2)],_0x1f54ec=_0x301841[_0x19238c(0x7d)];if(!_0x1f54ec?.[_0x19238c(0xd4)]){console[_0x19238c(0xbd)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x301841['id']);return;}const _0x37ca73=_0x24d619===_0x19238c(0x98)?_0x19238c(0xdc):_0x24d619===_0x19238c(0xa9)?'payment.failed':_0x24d619===_0x19238c(0x8e)?_0x19238c(0xaa):'payment.pending';let _0x4e482a=[];if(_0x1f54ec[_0x19238c(0xcc)])try{_0x4e482a=Array[_0x19238c(0xce)](_0x1f54ec[_0x19238c(0xcc)])?_0x1f54ec['webhookEvents']:JSON[_0x19238c(0xb8)](_0x1f54ec['webhookEvents']);}catch(_0x3b4ea2){console['error'](_0x19238c(0xc4),_0x3b4ea2),_0x4e482a=[];}if(!_0x4e482a[_0x19238c(0xd1)](_0x37ca73)){console[_0x19238c(0xbd)](_0x19238c(0x7f)+_0x37ca73+_0x19238c(0xad)+_0x301841['id']);return;}let _0x509925;if(_0x809aa1['txUrls'])try{_0x509925=JSON[_0x19238c(0xb8)](_0x809aa1[_0x19238c(0xb7)]);}catch(_0x9f29a5){console[_0x19238c(0xde)](_0x19238c(0xb0),_0x9f29a5),_0x509925=undefined;}const _0x485d8a={'event':_0x37ca73,'payment':{'id':_0x809aa1['id'],'order_id':_0x809aa1['orderId'],'gateway_order_id':_0x809aa1['gatewayOrderId'],'gateway':_0x809aa1[_0x19238c(0xd9)],'amount':_0x809aa1[_0x19238c(0xc2)],'currency':_0x809aa1[_0x19238c(0xa5)],'status':_0x24d619[_0x19238c(0xaf)](),'customer_email':_0x809aa1[_0x19238c(0xf7)],'customer_name':_0x809aa1[_0x19238c(0xd7)],'failure_message':_0x809aa1[_0x19238c(0xdb)],'tx_urls':_0x509925,'created_at':_0x809aa1['createdAt'],'updated_at':new Date()}},_0x3e885f=await fetch(_0x1f54ec[_0x19238c(0xd4)],{'method':_0x19238c(0xd2),'headers':{'Content-Type':_0x19238c(0xd6),'User-Agent':_0x19238c(0xb5)},'body':JSON[_0x19238c(0xa6)](_0x485d8a)}),_0x4994a5=Date[_0x19238c(0x89)]()-_0x5be037,_0x27b253=_0x3e885f['ok']?_0x19238c(0xf0):await _0x3e885f[_0x19238c(0xf6)]();loggerService_1[_0x19238c(0xa0)]['logShopWebhookSent'](_0x809aa1[_0x19238c(0xcf)],_0x1f54ec[_0x19238c(0xd4)],_0x37ca73,_0x3e885f[_0x19238c(0x9c)],_0x4994a5,_0x485d8a),console[_0x19238c(0xbd)](_0x19238c(0xb4)+_0x1f54ec[_0x19238c(0xd4)]+'\x20with\x20status\x20'+_0x3e885f[_0x19238c(0x9c)]+'\x20('+_0x4994a5+_0x19238c(0x102));}catch(_0x23e911){console[_0x19238c(0xde)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x23e911),loggerService_1[_0x19238c(0xa0)][_0x19238c(0xbb)](_0x809aa1[_0x19238c(0xcf)],_0x809aa1[_0x19238c(0xb2)]?.['settings']?.['webhookUrl']||_0x19238c(0xee),'webhook_send',_0x23e911,{});}}async[a55_0x557f2f(0x80)](_0x2a128a,_0x1edb6a){const _0x1e703d=a55_0x557f2f;try{const _0x78b2bd={'PENDING':_0x1e703d(0xca),'PAID':_0x1e703d(0xcd),'FAILED':_0x1e703d(0xdd),'EXPIRED':'expired'},_0x5b4d83=_0x78b2bd[_0x1edb6a];if(!_0x5b4d83||_0x5b4d83===_0x1e703d(0xca))return;await telegramBotService_1['telegramBotService'][_0x1e703d(0xbc)](_0x2a128a[_0x1e703d(0xcf)],_0x2a128a,_0x5b4d83);}catch(_0x2db492){console[_0x1e703d(0xde)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x2db492);}}}exports['WebhookService']=WebhookService;