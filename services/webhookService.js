'use strict';const a62_0x55fdca=a62_0x89dd;function a62_0x89dd(_0x212d3e,_0x9d4ba5){const _0x4d11a1=a62_0x4d11();return a62_0x89dd=function(_0x89dd16,_0x44c2c8){_0x89dd16=_0x89dd16-0x1de;let _0x591f8e=_0x4d11a1[_0x89dd16];return _0x591f8e;},a62_0x89dd(_0x212d3e,_0x9d4ba5);}(function(_0x259fae,_0x55a911){const _0x8fe226=a62_0x89dd,_0x3d612d=_0x259fae();while(!![]){try{const _0x5c10bc=parseInt(_0x8fe226(0x204))/0x1*(-parseInt(_0x8fe226(0x27c))/0x2)+-parseInt(_0x8fe226(0x21e))/0x3+parseInt(_0x8fe226(0x2ff))/0x4*(-parseInt(_0x8fe226(0x23d))/0x5)+parseInt(_0x8fe226(0x2b5))/0x6+parseInt(_0x8fe226(0x1f0))/0x7*(parseInt(_0x8fe226(0x232))/0x8)+parseInt(_0x8fe226(0x27e))/0x9*(parseInt(_0x8fe226(0x211))/0xa)+parseInt(_0x8fe226(0x28e))/0xb;if(_0x5c10bc===_0x55a911)break;else _0x3d612d['push'](_0x3d612d['shift']());}catch(_0x40528d){_0x3d612d['push'](_0x3d612d['shift']());}}}(a62_0x4d11,0x8174d));function a62_0x4d11(){const _0x11e5e4=['klymeService','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','getGatewayCommission','payment.success','Webhook\x20event\x20','update','__esModule','$transaction','🔄\x20Processing\x20Noda\x20webhook:','processRapydWebhook','loggerService','💰\x20Payment\x20','../config/database','toLowerCase','\x20=\x20','payment_method','✅\x20Found\x20payment\x20','📈\x20Payment\x20','✅\x20Payment\x20link\x20','failureMessage','✅\x20Found\x20payment:\x20ID=','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','./gateways/amerService','📊\x20VISA\x20webhook\x20result:','PAID','webhook_send','updatePaymentStatus','stringify','📈\x20Payment\x20details:\x20oldStatus=\x22','amer','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','settings','Error\x20parsing\x20webhook\x20events:','\x20in\x20shop\x20','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','sendShopWebhook','commission','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','CHARGEBACK','additionalInfo','🔄\x20Processing\x20Amer\x20webhook:','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','📊\x20Amer\x20webhook\x20result:','💰\x20Gateway\x20','🔄\x20Additional\x20data:','📊\x20AmPay\x20webhook\x20result:','plisio_gateway','📊\x20MasterCard\x20webhook\x20result:','refund','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','balance','plisio','💰\x20Removing\x20from\x20balance:\x20','🔄\x20updatePaymentStatus\x20called:\x20paymentId=',',\x20status=','💸\x20Additional\x20chargeback\x20penalty:\x20-','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','CoinToPay2Service','logWebhookProcessed','coinToPay2Service','rapyd','\x20status\x20','528112MbLyoR','plisioService','📊\x20Amer\x20webhook:\x20Payment\x20','visaMasterCardService','status','failed','customerEmail','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','\x20not\x20found','Success','klyme','bankId','💰\x20Converting\x20','visa',',\x20currentPayments=','txUrls','cointopay2','./currencyService',',\x20gatewayOrderId:\x20','81725UJRNBn','visa_','📊\x20Rapyd\x20webhook:\x20Payment\x20','Payment\x20not\x20found:\x20','VISA','paymentMethod','rapydService','username','chargebackAmount','Error\x20processing\x20CoinToPay2\x20webhook:','VISA\x20payment\x20not\x20found:\x20','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','TesSoft\x20Payment\x20System/1.0','entries','PlisioService','payment','\x22,\x20paymentLinkId=\x22','sendPaymentStatusNotification','📝\x20Reason:\x20','sendPaymentNotification','153212wcJZMz','logWebhookError','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','./gateways/ampayService','MasterCard\x20payment\x20not\x20found:\x20','Error\x20processing\x20CoinToPay\x20webhook:','No\x20payment\x20ID\x20in\x20VISA\x20webhook','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','toISOString','\x20balance\x20updated:\x20','__importDefault','webhookEvents','✅\x20Shop\x20','16220qzVCks',',\x20newStatus=','ampayService',',\x20using\x20default\x2010%','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20->\x20','processing','\x20not\x20enabled\x20for\x20shop\x20','paymentLink','\x20current\x20balance:\x20','system','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','gatewayPaymentId','1133433rhzOpI','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','nodaService','paymentLinkId','./gateways/plisioService','🔍\x20Found\x20VISA\x20payment:\x20ID=','includes','processMasterCardWebhook','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','processVisaWebhook','default','❌\x20Available\x20webhook\x20fields:','❌\x20Error\x20processing\x20AmPay\x20webhook:','keys','orderId','\x20→\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook','Payment\x20not\x20found','desc','272aklJkp','🔄\x20Processing\x20VISA\x20webhook:','🔄\x20Processing\x20AmPay\x20webhook:','./loggerService','unknown','telegramBotService','\x20USDT','gateway','\x20-\x20','ms)','ampay','25JwXrqw','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20webhook\x20with\x20ID:\x20','processPlisioWebhook','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','gatewayOrderId','REFUND','💰\x20Final\x20balance\x20after\x20chargeback:\x20',',\x20card:\x20****','Found','❌\x20Payment\x20link\x20','convertToUSDT','payment.pending','amountUSDT','text','create','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20',',\x20using\x20default\x20commission\x2010%','processAmPayWebhook','currencyService','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','map','amountAfterGatewayCommissionUSDT','COMPLETED','processWebhook','toUpperCase','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','findUnique','./gateways/nodaService','toFixed','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','\x20(Status:\x20','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','mastercard_webhook','DISABLED','findMany','⚠️\x20AMPAY\x20WEBHOOKS\x20TEMPORARILY\x20DISABLED\x20-\x20No\x20status\x20updates\x20will\x20be\x20performed','parse','FAILED','./gateways/mastercardService','webhookUrl','🔄\x20Processing\x20Rapyd\x20webhook:','currentPayments','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','🔍\x20VISA\x20payment\x20search\x20executed','log','type','Payment\x20','💰\x20Amount\x20after\x20gateway\x20commission:\x20','./gateways/coinToPay2Service','paymentId','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','amerService','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','./gateways/klymeService','\x20to\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','customerName','shopId','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','MASTERCARD','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20',',\x20GatewayOrderId=','4fvrTVP','now','2061jnQXUy','paidAt','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','paid','📊\x20CoinToPay\x20webhook:\x20Payment\x20','created','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','📊\x20Noda\x20webhook:\x20Payment\x20','KlymeService','visa_webhook','amount','./gateways/coinToPayService','no\x20balance\x20change','error','5020125FycJli','Gateway\x20','Error\x20processing\x20Noda\x20webhook:','❌\x20Error\x20processing\x20MasterCard\x20webhook:','gatewayCommissionRate','Error\x20processing\x20KLYME\x20webhook:','Found\x20payment\x20','visa/mastercard','\x20commission\x20for\x20shop\x20','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','./telegramBotService','📈\x20Found\x20payment\x20link\x20','cardLast4','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','noda','payment.failed','🔄\x20Processing\x20CoinToPay\x20webhook:','\x22,\x20newStatus=\x22',',\x20GatewayPaymentId=','\x20and\x20-','currency','application/json','🔍\x20Search\x20result:\x20','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','RapydService','webhookLog','findFirst','chargeback','📊\x20Plisio\x20webhook:\x20Payment\x20','remitterIban','🏪\x20Shop\x20','No\x20payment\x20ID\x20in\x20Amer\x20webhook','coinToPayService','updatedAt','🔄\x20Processing\x20CoinToPay2\x20webhook:',',\x20gatewayPaymentId:\x20','NodaService','\x20updated:\x20currentPayments=','CoinToPayService','3899190gtxelD','shop','mastercard','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','\x20USDT\x20(chargeback\x20penalty)','cointopay','VisaMasterCardService','🔍\x20VISA\x20payment\x20search\x20result:\x20','remitterName','visa_mastercard'];a62_0x4d11=function(){return _0x11e5e4;};return a62_0x4d11();}var __importDefault=this&&this[a62_0x55fdca(0x20e)]||function(_0x5a178b){const _0x42bc15=a62_0x55fdca;return _0x5a178b&&_0x5a178b[_0x42bc15(0x2c6)]?_0x5a178b:{'default':_0x5a178b};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a62_0x55fdca(0x2cc))),plisioService_1=require(a62_0x55fdca(0x222)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a62_0x55fdca(0x258)),coinToPayService_1=require(a62_0x55fdca(0x28b)),coinToPay2Service_1=require(a62_0x55fdca(0x26e)),klymeService_1=require(a62_0x55fdca(0x273)),mastercardService_1=require(a62_0x55fdca(0x264)),amerService_1=require(a62_0x55fdca(0x2d7)),ampayService_1=require(a62_0x55fdca(0x207)),telegramBotService_1=require(a62_0x55fdca(0x298)),currencyService_1=require(a62_0x55fdca(0x1ee)),loggerService_1=require(a62_0x55fdca(0x235));class WebhookService{constructor(){const _0x373cb8=a62_0x55fdca;this[_0x373cb8(0x1de)]=new plisioService_1[(_0x373cb8(0x1fe))](),this[_0x373cb8(0x1f6)]=new rapydService_1[(_0x373cb8(0x2a6))](),this['nodaService']=new nodaService_1[(_0x373cb8(0x2b2))](),this['coinToPayService']=new coinToPayService_1[(_0x373cb8(0x2b4))](),this[_0x373cb8(0x2fc)]=new coinToPay2Service_1[(_0x373cb8(0x2fa))](),this[_0x373cb8(0x2bf)]=new klymeService_1[(_0x373cb8(0x288))](),this[_0x373cb8(0x1e0)]=new mastercardService_1[(_0x373cb8(0x2bb))](),this[_0x373cb8(0x271)]=new amerService_1['AmerService'](),this[_0x373cb8(0x213)]=new ampayService_1['AmPayService']();}async[a62_0x55fdca(0x2db)](_0x287a8f,_0x582dd5,_0x2e9b3c){const _0x9004ab=a62_0x55fdca;console['log'](_0x9004ab(0x2f6)+_0x287a8f+_0x9004ab(0x212)+_0x582dd5),console['log'](_0x9004ab(0x2ed),_0x2e9b3c),await database_1[_0x9004ab(0x229)][_0x9004ab(0x2c7)](async _0x5f2823=>{const _0x4cc40d=_0x9004ab,_0xff1424=await _0x5f2823[_0x4cc40d(0x1ff)][_0x4cc40d(0x257)]({'where':{'id':_0x287a8f},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xff1424)throw new Error(_0x4cc40d(0x26c)+_0x287a8f+_0x4cc40d(0x1e5));const _0x22baeb=_0xff1424[_0x4cc40d(0x1e1)],_0x13ecdf=_0xff1424[_0x4cc40d(0x2b6)];console['log'](_0x4cc40d(0x2cb)+_0x287a8f+':\x20'+_0x22baeb+'\x20->\x20'+_0x582dd5),console[_0x4cc40d(0x26a)](_0x4cc40d(0x2ac)+_0x13ecdf[_0x4cc40d(0x1f7)]+_0x4cc40d(0x21a)+_0x13ecdf[_0x4cc40d(0x2f3)]+_0x4cc40d(0x238));const _0x4f19d8={'status':_0x582dd5[_0x4cc40d(0x255)](),'updatedAt':new Date(),'statusChangedBy':_0x4cc40d(0x21b),'statusChangedAt':new Date()};_0x2e9b3c?.[_0x4cc40d(0x2d3)]&&(_0x4f19d8['failureMessage']=_0x2e9b3c['failureMessage']);_0x2e9b3c?.[_0x4cc40d(0x1ec)]&&(_0x4f19d8['txUrls']=JSON[_0x4cc40d(0x2dc)](_0x2e9b3c['txUrls']));_0x2e9b3c?.['cardLast4']&&(_0x4f19d8['cardLast4']=_0x2e9b3c[_0x4cc40d(0x29a)]);_0x2e9b3c?.[_0x4cc40d(0x1f5)]&&(_0x4f19d8[_0x4cc40d(0x1f5)]=_0x2e9b3c['paymentMethod']);_0x2e9b3c?.[_0x4cc40d(0x1e8)]&&(_0x4f19d8[_0x4cc40d(0x1e8)]=_0x2e9b3c[_0x4cc40d(0x1e8)]);_0x2e9b3c?.[_0x4cc40d(0x2ab)]&&(_0x4f19d8[_0x4cc40d(0x2ab)]=_0x2e9b3c[_0x4cc40d(0x2ab)]);_0x2e9b3c?.['remitterName']&&(_0x4f19d8['remitterName']=_0x2e9b3c[_0x4cc40d(0x2bd)]);let _0x52ebff=_0x13ecdf[_0x4cc40d(0x2f3)],_0x554ae3='';if(_0x582dd5[_0x4cc40d(0x255)]()===_0x4cc40d(0x2d9)&&_0x22baeb!==_0x4cc40d(0x2d9)){const _0x22286a=await currencyService_1[_0x4cc40d(0x24f)][_0x4cc40d(0x247)](_0xff1424[_0x4cc40d(0x28a)],_0xff1424['currency']),_0x5a768a=await this['getGatewayCommission'](_0x13ecdf['id'],_0xff1424[_0x4cc40d(0x239)]),_0x1f8039=_0x22286a*(0x1-_0x5a768a/0x64);_0x52ebff+=_0x1f8039,_0x554ae3='+'+_0x1f8039[_0x4cc40d(0x259)](0x6)+_0x4cc40d(0x29b)+_0x5a768a+'%\x20gateway\x20commission)',_0x4f19d8[_0x4cc40d(0x249)]=_0x22286a,_0x4f19d8[_0x4cc40d(0x252)]=_0x1f8039,_0x4f19d8[_0x4cc40d(0x292)]=_0x5a768a,_0x4f19d8[_0x4cc40d(0x27f)]=new Date(),console['log'](_0x4cc40d(0x1e9)+_0xff1424['amount']+'\x20'+_0xff1424[_0x4cc40d(0x2a2)]+_0x4cc40d(0x216)+_0x22286a['toFixed'](0x6)+_0x4cc40d(0x238)),console[_0x4cc40d(0x26a)](_0x4cc40d(0x2ec)+_0xff1424[_0x4cc40d(0x239)]+'\x20commission:\x20'+_0x5a768a+'%'),console[_0x4cc40d(0x26a)](_0x4cc40d(0x26d)+_0x1f8039['toFixed'](0x6)+_0x4cc40d(0x238)),console[_0x4cc40d(0x26a)]('💰\x20Adding\x20to\x20balance:\x20'+_0x13ecdf['balance']+'\x20+\x20'+_0x1f8039[_0x4cc40d(0x259)](0x6)+_0x4cc40d(0x2ce)+_0x52ebff[_0x4cc40d(0x259)](0x6)+_0x4cc40d(0x238));}else{if(_0x22baeb===_0x4cc40d(0x2d9)&&_0x582dd5['toUpperCase']()!==_0x4cc40d(0x2d9)){let _0x5c7c23;if(_0xff1424[_0x4cc40d(0x252)])_0x5c7c23=_0xff1424[_0x4cc40d(0x252)];else{if(_0xff1424['amountUSDT']){const _0x595779=await this[_0x4cc40d(0x2c2)](_0x13ecdf['id'],_0xff1424[_0x4cc40d(0x239)]);_0x5c7c23=_0xff1424[_0x4cc40d(0x249)]*(0x1-_0x595779/0x64);}else console['log'](_0x4cc40d(0x2ea)),_0x5c7c23=0x0;}_0x5c7c23>0x0&&(_0x52ebff-=_0x5c7c23,_0x554ae3='-'+_0x5c7c23['toFixed'](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x4f19d8['amountUSDT']=null,_0x4f19d8[_0x4cc40d(0x252)]=null,_0x4f19d8['paidAt']=null,console[_0x4cc40d(0x26a)](_0x4cc40d(0x2f5)+_0x13ecdf[_0x4cc40d(0x2f3)]+_0x4cc40d(0x23a)+_0x5c7c23[_0x4cc40d(0x259)](0x6)+_0x4cc40d(0x2ce)+_0x52ebff['toFixed'](0x6)+_0x4cc40d(0x238)));}}if(_0x582dd5[_0x4cc40d(0x255)]()===_0x4cc40d(0x2e7)){const _0x1b1bfa=_0x2e9b3c?.[_0x4cc40d(0x1f8)]||0x0;_0x1b1bfa>0x0&&(_0x52ebff-=_0x1b1bfa,_0x554ae3+=_0x4cc40d(0x2a1)+_0x1b1bfa[_0x4cc40d(0x259)](0x6)+_0x4cc40d(0x2b9),_0x4f19d8[_0x4cc40d(0x1f8)]=_0x1b1bfa,console[_0x4cc40d(0x26a)](_0x4cc40d(0x2f8)+_0x1b1bfa[_0x4cc40d(0x259)](0x6)+_0x4cc40d(0x238)),console[_0x4cc40d(0x26a)](_0x4cc40d(0x243)+_0x52ebff[_0x4cc40d(0x259)](0x6)+_0x4cc40d(0x238)));}const _0x27962c=await _0x5f2823[_0x4cc40d(0x1ff)][_0x4cc40d(0x2c5)]({'where':{'id':_0x287a8f},'data':_0x4f19d8});_0x52ebff!==_0x13ecdf[_0x4cc40d(0x2f3)]&&(await _0x5f2823[_0x4cc40d(0x2b6)]['update']({'where':{'id':_0x13ecdf['id']},'data':{'balance':_0x52ebff}}),console[_0x4cc40d(0x26a)](_0x4cc40d(0x210)+_0x13ecdf[_0x4cc40d(0x1f7)]+_0x4cc40d(0x20d)+_0x13ecdf['balance'][_0x4cc40d(0x259)](0x6)+_0x4cc40d(0x216)+_0x52ebff[_0x4cc40d(0x259)](0x6)+_0x4cc40d(0x238)),console['log'](_0x4cc40d(0x202)+_0x554ae3));await _0x5f2823[_0x4cc40d(0x2a7)][_0x4cc40d(0x24b)]({'data':{'paymentId':_0x287a8f,'shopId':_0x13ecdf['id'],'event':'webhook_status_change_'+_0x582dd5['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x4cc40d(0x2dc)]({'oldStatus':_0x22baeb,'newStatus':_0x582dd5[_0x4cc40d(0x255)](),'balanceChange':_0x554ae3||_0x4cc40d(0x28c),'oldBalance':_0x13ecdf['balance'],'newBalance':_0x52ebff,'amountUSDT':_0x4f19d8[_0x4cc40d(0x249)],'additionalData':_0x2e9b3c,'timestamp':new Date()[_0x4cc40d(0x20c)]()})}}),await this[_0x4cc40d(0x2e4)]({..._0xff1424,..._0x27962c,'shop':_0x13ecdf},_0x582dd5[_0x4cc40d(0x255)]()),await this[_0x4cc40d(0x201)]({..._0xff1424,..._0x27962c},_0x582dd5[_0x4cc40d(0x255)]());if(_0x22baeb!==_0x4cc40d(0x2d9)&&_0x582dd5['toUpperCase']()===_0x4cc40d(0x2d9)){console['log'](_0x4cc40d(0x2d1)+_0x287a8f+_0x4cc40d(0x250)),console['log'](_0x4cc40d(0x2dd)+_0x22baeb+_0x4cc40d(0x29f)+_0x582dd5['toUpperCase']()+_0x4cc40d(0x200)+_0xff1424['paymentLinkId']+'\x22');if(_0xff1424[_0x4cc40d(0x221)])try{const _0x52d21d=await _0x5f2823[_0x4cc40d(0x219)]['findUnique']({'where':{'id':_0xff1424[_0x4cc40d(0x221)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x52d21d){console['log'](_0x4cc40d(0x299)+_0x52d21d['id']+':\x20type='+_0x52d21d[_0x4cc40d(0x26b)]+_0x4cc40d(0x1eb)+_0x52d21d[_0x4cc40d(0x267)]+',\x20status='+_0x52d21d[_0x4cc40d(0x1e1)]);const _0x4ff3aa=_0x52d21d[_0x4cc40d(0x267)]+0x1,_0x4c3f26=_0x52d21d[_0x4cc40d(0x26b)]==='SINGLE'?_0x4cc40d(0x253):_0x52d21d[_0x4cc40d(0x1e1)];await _0x5f2823['paymentLink'][_0x4cc40d(0x2c5)]({'where':{'id':_0xff1424[_0x4cc40d(0x221)]},'data':{'currentPayments':_0x4ff3aa,'status':_0x4c3f26,'updatedAt':new Date()}}),console[_0x4cc40d(0x26a)](_0x4cc40d(0x2d2)+_0x52d21d['id']+_0x4cc40d(0x2b3)+_0x52d21d[_0x4cc40d(0x267)]+_0x4cc40d(0x216)+_0x4ff3aa+_0x4cc40d(0x2f7)+_0x52d21d[_0x4cc40d(0x1e1)]+_0x4cc40d(0x216)+_0x4c3f26);}else console[_0x4cc40d(0x26a)](_0x4cc40d(0x246)+_0xff1424[_0x4cc40d(0x221)]+'\x20not\x20found');}catch(_0x58b869){console[_0x4cc40d(0x28d)](_0x4cc40d(0x25b),_0x58b869);}else console['log']('📈\x20Payment\x20'+_0x287a8f+_0x4cc40d(0x268));}else console['log'](_0x4cc40d(0x2d1)+_0x287a8f+'\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20'+_0x22baeb+_0x4cc40d(0x216)+_0x582dd5[_0x4cc40d(0x255)]());});}async[a62_0x55fdca(0x23f)](_0x178ebb){const _0x31eeae=a62_0x55fdca;console[_0x31eeae(0x26a)]('🔄\x20Processing\x20Plisio\x20webhook:',_0x178ebb);try{const _0x55b323=await this[_0x31eeae(0x1de)][_0x31eeae(0x254)](_0x178ebb);if(!_0x55b323[_0x31eeae(0x26f)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x18e08a=await database_1[_0x31eeae(0x229)]['payment'][_0x31eeae(0x2a8)]({'where':{'gatewayOrderId':_0x55b323['paymentId']}});if(!_0x18e08a){console[_0x31eeae(0x28d)](_0x31eeae(0x24c)+_0x55b323[_0x31eeae(0x26f)]);return;}console[_0x31eeae(0x26a)](_0x31eeae(0x2aa)+_0x18e08a['id']+_0x31eeae(0x2fe)+_0x55b323[_0x31eeae(0x1e1)]),await this[_0x31eeae(0x2db)](_0x18e08a['id'],_0x55b323[_0x31eeae(0x1e1)],{'txUrls':_0x55b323[_0x31eeae(0x1ec)]}),loggerService_1[_0x31eeae(0x2ca)][_0x31eeae(0x2fb)](_0x31eeae(0x2f4),_0x18e08a['id'],_0x18e08a[_0x31eeae(0x1e1)],_0x55b323[_0x31eeae(0x1e1)],_0x178ebb);}catch(_0xbe763d){console[_0x31eeae(0x28d)]('Error\x20processing\x20Plisio\x20webhook:',_0xbe763d),loggerService_1[_0x31eeae(0x2ca)][_0x31eeae(0x205)]('plisio',_0xbe763d,_0x178ebb);throw _0xbe763d;}}async['processPlisioGatewayWebhook'](_0x4e4255){const _0x5419d=a62_0x55fdca;console[_0x5419d(0x26a)](_0x5419d(0x240),_0x4e4255);try{const _0x4afcfc=await this['plisioService'][_0x5419d(0x254)](_0x4e4255);if(!_0x4afcfc[_0x5419d(0x26f)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x2ac3cb=await database_1[_0x5419d(0x229)][_0x5419d(0x1ff)][_0x5419d(0x2a8)]({'where':{'gatewayOrderId':_0x4afcfc[_0x5419d(0x26f)]}});if(!_0x2ac3cb){console['error']('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x4afcfc[_0x5419d(0x26f)]);return;}console[_0x5419d(0x26a)](_0x5419d(0x20b)+_0x2ac3cb['id']+'\x20status\x20'+_0x4afcfc['status']),await this['updatePaymentStatus'](_0x2ac3cb['id'],_0x4afcfc[_0x5419d(0x1e1)],{'txUrls':_0x4afcfc['txUrls']}),loggerService_1[_0x5419d(0x2ca)]['logWebhookProcessed'](_0x5419d(0x2ef),_0x2ac3cb['id'],_0x2ac3cb[_0x5419d(0x1e1)],_0x4afcfc[_0x5419d(0x1e1)],_0x4e4255);}catch(_0x587ee2){console[_0x5419d(0x28d)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x587ee2),loggerService_1[_0x5419d(0x2ca)]['logWebhookError'](_0x5419d(0x2ef),_0x587ee2,_0x4e4255);throw _0x587ee2;}}async[a62_0x55fdca(0x2c9)](_0x45a3b9){const _0x4d112a=a62_0x55fdca;console[_0x4d112a(0x26a)](_0x4d112a(0x266),_0x45a3b9);try{const _0x24283e=await this[_0x4d112a(0x1f6)][_0x4d112a(0x254)](_0x45a3b9);if(!_0x24283e[_0x4d112a(0x26f)])throw new Error(_0x4d112a(0x21f));const _0x2b9a72=await database_1[_0x4d112a(0x229)][_0x4d112a(0x1ff)][_0x4d112a(0x2a8)]({'where':{'gatewayOrderId':_0x24283e[_0x4d112a(0x26f)]}});if(!_0x2b9a72){console[_0x4d112a(0x28d)](_0x4d112a(0x21c)+_0x24283e[_0x4d112a(0x26f)]);return;}console['log'](_0x4d112a(0x1f2)+_0x2b9a72['id']+'\x20status\x20'+_0x24283e[_0x4d112a(0x1e1)]),await this[_0x4d112a(0x2db)](_0x2b9a72['id'],_0x24283e[_0x4d112a(0x1e1)],{'failureMessage':_0x24283e['failureMessage'],'cardLast4':_0x24283e[_0x4d112a(0x2e8)]?.[_0x4d112a(0x29a)],'paymentMethod':_0x24283e['additionalInfo']?.[_0x4d112a(0x1f5)]}),loggerService_1[_0x4d112a(0x2ca)][_0x4d112a(0x2fb)]('rapyd',_0x2b9a72['id'],_0x2b9a72[_0x4d112a(0x1e1)],_0x24283e[_0x4d112a(0x1e1)],_0x45a3b9);}catch(_0x40fc4c){console[_0x4d112a(0x28d)]('Error\x20processing\x20Rapyd\x20webhook:',_0x40fc4c),loggerService_1[_0x4d112a(0x2ca)]['logWebhookError'](_0x4d112a(0x2fd),_0x40fc4c,_0x45a3b9);throw _0x40fc4c;}}async['processNodaWebhook'](_0x339192){const _0x109ade=a62_0x55fdca;console[_0x109ade(0x26a)](_0x109ade(0x2c8),_0x339192);try{const _0x25469b=await this[_0x109ade(0x220)][_0x109ade(0x254)](_0x339192);if(!_0x25469b[_0x109ade(0x26f)])throw new Error(_0x109ade(0x22f));const _0x33b53e=await database_1[_0x109ade(0x229)][_0x109ade(0x1ff)][_0x109ade(0x2a8)]({'where':{'gatewayOrderId':_0x25469b[_0x109ade(0x26f)]}});if(!_0x33b53e){console[_0x109ade(0x28d)]('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x25469b['paymentId']);return;}console['log'](_0x109ade(0x287)+_0x33b53e['id']+'\x20status\x20'+_0x25469b[_0x109ade(0x1e1)]),await this[_0x109ade(0x2db)](_0x33b53e['id'],_0x25469b[_0x109ade(0x1e1)],{'bankId':_0x25469b[_0x109ade(0x2e8)]?.['bankId'],'remitterIban':_0x25469b[_0x109ade(0x2e8)]?.['remitterIban'],'remitterName':_0x25469b[_0x109ade(0x2e8)]?.[_0x109ade(0x2bd)]}),loggerService_1[_0x109ade(0x2ca)][_0x109ade(0x2fb)](_0x109ade(0x29c),_0x33b53e['id'],_0x33b53e[_0x109ade(0x1e1)],_0x25469b['status'],_0x339192);}catch(_0x2762a8){console['error'](_0x109ade(0x290),_0x2762a8),loggerService_1['loggerService'][_0x109ade(0x205)](_0x109ade(0x29c),_0x2762a8,_0x339192);throw _0x2762a8;}}async['processCoinToPayWebhook'](_0x7c3a09){const _0x42b3a0=a62_0x55fdca;console[_0x42b3a0(0x26a)](_0x42b3a0(0x29e),_0x7c3a09);try{const _0x2203bf=await this[_0x42b3a0(0x2ae)][_0x42b3a0(0x254)](_0x7c3a09);if(!_0x2203bf[_0x42b3a0(0x26f)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x22ff7d=await database_1[_0x42b3a0(0x229)][_0x42b3a0(0x1ff)][_0x42b3a0(0x2a8)]({'where':{'gatewayOrderId':_0x2203bf[_0x42b3a0(0x26f)]}});if(!_0x22ff7d){console['error'](_0x42b3a0(0x2d6)+_0x2203bf[_0x42b3a0(0x26f)]);return;}console['log'](_0x42b3a0(0x283)+_0x22ff7d['id']+_0x42b3a0(0x2fe)+_0x2203bf[_0x42b3a0(0x1e1)]),await this['updatePaymentStatus'](_0x22ff7d['id'],_0x2203bf[_0x42b3a0(0x1e1)]),loggerService_1[_0x42b3a0(0x2ca)][_0x42b3a0(0x2fb)](_0x42b3a0(0x2ba),_0x22ff7d['id'],_0x22ff7d[_0x42b3a0(0x1e1)],_0x2203bf[_0x42b3a0(0x1e1)],_0x7c3a09);}catch(_0x2a418c){console[_0x42b3a0(0x28d)](_0x42b3a0(0x209),_0x2a418c),loggerService_1['loggerService'][_0x42b3a0(0x205)](_0x42b3a0(0x2ba),_0x2a418c,_0x7c3a09);throw _0x2a418c;}}async['processCoinToPay2Webhook'](_0x68894b){const _0x34bf1c=a62_0x55fdca;console[_0x34bf1c(0x26a)](_0x34bf1c(0x2b0),_0x68894b);try{const _0x4e214a=await this[_0x34bf1c(0x2fc)][_0x34bf1c(0x254)](_0x68894b);if(!_0x4e214a[_0x34bf1c(0x26f)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook');const _0x2e35ec=await database_1[_0x34bf1c(0x229)]['payment'][_0x34bf1c(0x2a8)]({'where':{'gatewayOrderId':_0x4e214a[_0x34bf1c(0x26f)]}});if(!_0x2e35ec){console[_0x34bf1c(0x28d)]('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x4e214a['paymentId']);return;}console[_0x34bf1c(0x26a)](_0x34bf1c(0x270)+_0x2e35ec['id']+_0x34bf1c(0x2fe)+_0x4e214a[_0x34bf1c(0x1e1)]),await this[_0x34bf1c(0x2db)](_0x2e35ec['id'],_0x4e214a[_0x34bf1c(0x1e1)]),loggerService_1['loggerService'][_0x34bf1c(0x2fb)]('cointopay2',_0x2e35ec['id'],_0x2e35ec['status'],_0x4e214a[_0x34bf1c(0x1e1)],_0x68894b);}catch(_0x1545f4){console[_0x34bf1c(0x28d)](_0x34bf1c(0x1f9),_0x1545f4),loggerService_1[_0x34bf1c(0x2ca)][_0x34bf1c(0x205)](_0x34bf1c(0x1ed),_0x1545f4,_0x68894b);throw _0x1545f4;}}async['processKlymeWebhook'](_0x33f8a1){const _0xb9c4d0=a62_0x55fdca;console['log']('🔄\x20Processing\x20KLYME\x20webhook:',_0x33f8a1);try{const _0x3d8e08=await this[_0xb9c4d0(0x2bf)]['processWebhook'](_0x33f8a1);if(!_0x3d8e08[_0xb9c4d0(0x26f)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x387e50=await database_1[_0xb9c4d0(0x229)][_0xb9c4d0(0x1ff)]['findFirst']({'where':{'gatewayOrderId':_0x3d8e08['paymentId']}});if(!_0x387e50){console['error'](_0xb9c4d0(0x2a5)+_0x3d8e08[_0xb9c4d0(0x26f)]);return;}console[_0xb9c4d0(0x26a)]('📊\x20KLYME\x20webhook:\x20Payment\x20'+_0x387e50['id']+'\x20status\x20'+_0x3d8e08[_0xb9c4d0(0x1e1)]),await this[_0xb9c4d0(0x2db)](_0x387e50['id'],_0x3d8e08[_0xb9c4d0(0x1e1)],{'paymentMethod':_0x3d8e08[_0xb9c4d0(0x2e8)]?.[_0xb9c4d0(0x2cf)]}),loggerService_1[_0xb9c4d0(0x2ca)][_0xb9c4d0(0x2fb)](_0xb9c4d0(0x1e7),_0x387e50['id'],_0x387e50[_0xb9c4d0(0x1e1)],_0x3d8e08['status'],_0x33f8a1);}catch(_0x502858){console[_0xb9c4d0(0x28d)](_0xb9c4d0(0x293),_0x502858),loggerService_1[_0xb9c4d0(0x2ca)][_0xb9c4d0(0x205)](_0xb9c4d0(0x1e7),_0x502858,_0x33f8a1);throw _0x502858;}}async[a62_0x55fdca(0x228)](_0x653bbc){const _0x25ca53=a62_0x55fdca;console[_0x25ca53(0x26a)](_0x25ca53(0x233),JSON[_0x25ca53(0x2dc)](_0x653bbc,null,0x2));try{const _0x1ee51b=await this[_0x25ca53(0x1e0)][_0x25ca53(0x254)](_0x653bbc,_0x25ca53(0x1f4));console[_0x25ca53(0x26a)](_0x25ca53(0x2d8),_0x1ee51b);if(!_0x1ee51b[_0x25ca53(0x26f)]){console[_0x25ca53(0x28d)](_0x25ca53(0x2b8)),console[_0x25ca53(0x28d)]('❌\x20Available\x20webhook\x20fields:',Object[_0x25ca53(0x22c)](_0x653bbc));throw new Error(_0x25ca53(0x20a));}let _0xa8bbc8=null;console[_0x25ca53(0x26a)](_0x25ca53(0x256)+_0x1ee51b[_0x25ca53(0x26f)]);if(_0x1ee51b['paymentId']){console[_0x25ca53(0x26a)](_0x25ca53(0x227)),console['log'](_0x25ca53(0x25a)),console[_0x25ca53(0x26a)]('\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard'),console[_0x25ca53(0x26a)](_0x25ca53(0x25d)+_0x1ee51b[_0x25ca53(0x26f)]),console[_0x25ca53(0x26a)](_0x25ca53(0x280)),_0xa8bbc8=await database_1['default'][_0x25ca53(0x1ff)]['findFirst']({'where':{'AND':[{'OR':[{'gateway':_0x25ca53(0x295)},{'gateway':_0x25ca53(0x2b7)}]},{'OR':[{'gatewayPaymentId':_0x1ee51b[_0x25ca53(0x26f)]},{'gatewayOrderId':_0x1ee51b[_0x25ca53(0x26f)]},{'id':_0x1ee51b[_0x25ca53(0x26f)]},{'orderId':_0x1ee51b[_0x25ca53(0x26f)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x25ca53(0x26a)](_0x25ca53(0x269));if(_0xa8bbc8)console[_0x25ca53(0x26a)](_0x25ca53(0x2d4)+_0xa8bbc8['id']+_0x25ca53(0x27b)+_0xa8bbc8[_0x25ca53(0x241)]+_0x25ca53(0x2a0)+_0xa8bbc8[_0x25ca53(0x21d)]);else{console[_0x25ca53(0x26a)](_0x25ca53(0x226));const _0x49063d=await database_1['default'][_0x25ca53(0x1ff)][_0x25ca53(0x260)]({'where':{'gateway':'visa/mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x25ca53(0x231)}});console[_0x25ca53(0x26a)]('🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:',_0x49063d[_0x25ca53(0x251)](_0x590034=>_0x590034['id']+'\x20(orderId:\x20'+_0x590034[_0x25ca53(0x22d)]+_0x25ca53(0x1ef)+_0x590034[_0x25ca53(0x241)]+_0x25ca53(0x2b1)+_0x590034['gatewayPaymentId']+_0x25ca53(0x244)+_0x590034['cardLast4']+')'));}console[_0x25ca53(0x26a)](_0x25ca53(0x2bc)+(_0xa8bbc8?_0x25ca53(0x245):'Not\x20found')),_0xa8bbc8&&console['log'](_0x25ca53(0x223)+_0xa8bbc8['id']+',\x20Gateway='+_0xa8bbc8[_0x25ca53(0x239)]+',\x20Status='+_0xa8bbc8[_0x25ca53(0x1e1)]+',\x20Card=****'+_0xa8bbc8['cardLast4']);}if(!_0xa8bbc8){console[_0x25ca53(0x28d)](_0x25ca53(0x297)+_0x1ee51b[_0x25ca53(0x26f)]),loggerService_1['loggerService'][_0x25ca53(0x205)](_0x25ca53(0x1ea),new Error('Payment\x20not\x20found:\x20'+_0x1ee51b[_0x25ca53(0x26f)]),_0x653bbc);throw new Error(_0x25ca53(0x1fa)+_0x1ee51b[_0x25ca53(0x26f)]);}console[_0x25ca53(0x26a)]('📊\x20VISA\x20payment\x20found:\x20'+_0xa8bbc8['id']+_0x25ca53(0x25c)+_0xa8bbc8[_0x25ca53(0x1e1)]+_0x25ca53(0x22e)+_0x1ee51b['status']+')');const _0x3428b2={'status':_0x1ee51b['status'][_0x25ca53(0x255)](),'updatedAt':new Date(),'statusChangedBy':_0x25ca53(0x289),'statusChangedAt':new Date()};_0x1ee51b[_0x25ca53(0x1e1)]===_0x25ca53(0x2d9)&&(_0x3428b2[_0x25ca53(0x27f)]=new Date()),_0x1ee51b[_0x25ca53(0x28a)]&&(_0x3428b2[_0x25ca53(0x28a)]=_0x1ee51b[_0x25ca53(0x28a)]),_0x1ee51b[_0x25ca53(0x2a2)]&&(_0x3428b2[_0x25ca53(0x2a2)]=_0x1ee51b['currency']),_0x1ee51b[_0x25ca53(0x1e1)]===_0x25ca53(0x263)&&_0x1ee51b[_0x25ca53(0x2d3)]&&(_0x3428b2['failureMessage']=_0x1ee51b[_0x25ca53(0x2d3)],console[_0x25ca53(0x26a)](_0x25ca53(0x2f2)+_0x1ee51b[_0x25ca53(0x2d3)])),await database_1[_0x25ca53(0x229)][_0x25ca53(0x1ff)][_0x25ca53(0x2c5)]({'where':{'id':_0xa8bbc8['id']},'data':_0x3428b2}),await this[_0x25ca53(0x2db)](_0xa8bbc8['id'],_0x1ee51b[_0x25ca53(0x1e1)]),await database_1[_0x25ca53(0x229)]['webhookLog'][_0x25ca53(0x24b)]({'data':{'paymentId':_0xa8bbc8['id'],'shopId':_0xa8bbc8[_0x25ca53(0x277)],'event':_0x25ca53(0x1f1)+_0x1ee51b['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x25ca53(0x2dc)](_0x1ee51b)}}),await this[_0x25ca53(0x201)](_0xa8bbc8,_0x1ee51b[_0x25ca53(0x1e1)][_0x25ca53(0x255)]()),console[_0x25ca53(0x26a)](_0x25ca53(0x2f9)+_0xa8bbc8['id']);}catch(_0x468360){console[_0x25ca53(0x28d)]('❌\x20VISA\x20webhook\x20processing\x20failed:',_0x468360),loggerService_1['loggerService'][_0x25ca53(0x205)](_0x25ca53(0x1ea),_0x468360,_0x653bbc);throw _0x468360;}}async[a62_0x55fdca(0x225)](_0x1b5744){const _0x357eed=a62_0x55fdca;console[_0x357eed(0x26a)]('🔄\x20Processing\x20MasterCard\x20webhook:',JSON[_0x357eed(0x2dc)](_0x1b5744,null,0x2));try{const _0x13bc12=await this['visaMasterCardService']['processWebhook'](_0x1b5744,_0x357eed(0x279));console[_0x357eed(0x26a)](_0x357eed(0x2f0),_0x13bc12);if(!_0x13bc12[_0x357eed(0x26f)]){console['error'](_0x357eed(0x278)),console[_0x357eed(0x28d)](_0x357eed(0x22a),Object['keys'](_0x1b5744));throw new Error(_0x357eed(0x272));}let _0x1df118=null;console[_0x357eed(0x26a)](_0x357eed(0x1fb)+_0x13bc12[_0x357eed(0x26f)]);_0x13bc12[_0x357eed(0x26f)]&&(console[_0x357eed(0x26a)](_0x357eed(0x2e3)),_0x1df118=await database_1[_0x357eed(0x229)][_0x357eed(0x1ff)][_0x357eed(0x2a8)]({'where':{'AND':[{'OR':[{'gateway':_0x357eed(0x2be)},{'gateway':_0x357eed(0x2b7)},{'gateway':_0x357eed(0x295)}]},{'OR':[{'gatewayPaymentId':_0x13bc12[_0x357eed(0x26f)]},{'gatewayOrderId':_0x13bc12[_0x357eed(0x26f)]},{'id':_0x13bc12[_0x357eed(0x26f)]},{'orderId':_0x13bc12[_0x357eed(0x26f)]}]}]}}),console[_0x357eed(0x26a)](_0x357eed(0x2a4)+(_0x1df118?_0x357eed(0x294)+_0x1df118['id']:_0x357eed(0x230))));if(!_0x1df118){console[_0x357eed(0x28d)](_0x357eed(0x2c0)+_0x13bc12[_0x357eed(0x26f)]),console[_0x357eed(0x28d)](_0x357eed(0x286)+_0x13bc12['paymentId']+'\x22,\x20id=\x22'+_0x13bc12[_0x357eed(0x26f)]+'\x22,\x20orderId=\x22'+_0x13bc12['paymentId']+'\x22');const _0x4a9071=await database_1[_0x357eed(0x229)][_0x357eed(0x1ff)][_0x357eed(0x260)]({'where':{'OR':[{'gateway':_0x357eed(0x2b7)},{'gateway':_0x357eed(0x2be)},{'gateway':_0x357eed(0x295)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x357eed(0x231)},'take':0xf});console[_0x357eed(0x26a)](_0x357eed(0x2df),_0x4a9071),loggerService_1[_0x357eed(0x2ca)]['logWebhookError'](_0x357eed(0x2b7),new Error(_0x357eed(0x1f3)+_0x13bc12[_0x357eed(0x26f)]),_0x1b5744);throw new Error(_0x357eed(0x208)+_0x13bc12[_0x357eed(0x26f)]);}console['log'](_0x357eed(0x2d0)+_0x1df118['id']+_0x357eed(0x285)+_0x1df118[_0x357eed(0x1e1)]+_0x357eed(0x274)+_0x13bc12[_0x357eed(0x1e1)]);const _0x5ebc11={'status':_0x13bc12['status'][_0x357eed(0x255)](),'updatedAt':new Date(),'statusChangedBy':_0x357eed(0x25e),'statusChangedAt':new Date()};_0x13bc12[_0x357eed(0x1e1)]===_0x357eed(0x2d9)&&(_0x5ebc11[_0x357eed(0x27f)]=new Date()),_0x13bc12['amount']&&(_0x5ebc11[_0x357eed(0x28a)]=_0x13bc12[_0x357eed(0x28a)]),_0x13bc12['currency']&&(_0x5ebc11['currency']=_0x13bc12['currency']),_0x13bc12[_0x357eed(0x1e1)]===_0x357eed(0x263)&&_0x13bc12['failureMessage']&&(_0x5ebc11[_0x357eed(0x2d3)]=_0x13bc12[_0x357eed(0x2d3)],console['log'](_0x357eed(0x281)+_0x13bc12[_0x357eed(0x2d3)])),await database_1[_0x357eed(0x229)][_0x357eed(0x1ff)][_0x357eed(0x2c5)]({'where':{'id':_0x1df118['id']},'data':_0x5ebc11}),await this['updatePaymentStatus'](_0x1df118['id'],_0x13bc12[_0x357eed(0x1e1)]),loggerService_1['loggerService']['logWebhookProcessed'](_0x357eed(0x2b7),_0x1df118['id'],_0x1df118[_0x357eed(0x1e1)],_0x13bc12[_0x357eed(0x1e1)],_0x1b5744);}catch(_0x17aeb8){console[_0x357eed(0x28d)](_0x357eed(0x291),_0x17aeb8),loggerService_1['loggerService'][_0x357eed(0x205)]('mastercard',_0x17aeb8,_0x1b5744);throw _0x17aeb8;}}async['processAmerWebhook'](_0x347e5c){const _0x233391=a62_0x55fdca;console[_0x233391(0x26a)](_0x233391(0x2e9),JSON[_0x233391(0x2dc)](_0x347e5c,null,0x2));try{const _0x45f55f=await this[_0x233391(0x271)][_0x233391(0x254)](_0x347e5c);console[_0x233391(0x26a)](_0x233391(0x2eb),_0x45f55f);if(!_0x45f55f[_0x233391(0x26f)]){console[_0x233391(0x28d)](_0x233391(0x2e6)),console[_0x233391(0x28d)](_0x233391(0x22a),Object[_0x233391(0x22c)](_0x347e5c));throw new Error(_0x233391(0x2ad));}let _0x25dd84=null;console[_0x233391(0x26a)](_0x233391(0x27a)+_0x45f55f[_0x233391(0x26f)]),_0x25dd84=await database_1[_0x233391(0x229)][_0x233391(0x1ff)][_0x233391(0x2a8)]({'where':{'AND':[{'gateway':_0x233391(0x2de)},{'OR':[{'gatewayPaymentId':_0x45f55f[_0x233391(0x26f)]},{'gatewayOrderId':_0x45f55f[_0x233391(0x26f)]},{'id':_0x45f55f[_0x233391(0x26f)]},{'orderId':_0x45f55f['paymentId']}]}]}}),console[_0x233391(0x26a)]('🔍\x20Search\x20result:\x20'+(_0x25dd84?_0x233391(0x294)+_0x25dd84['id']:_0x233391(0x230)));if(!_0x25dd84){console['error'](_0x233391(0x206)+_0x45f55f[_0x233391(0x26f)]);return;}console[_0x233391(0x26a)](_0x233391(0x1df)+_0x25dd84['id']+'\x20status\x20'+_0x45f55f[_0x233391(0x1e1)]),await this[_0x233391(0x2db)](_0x25dd84['id'],_0x45f55f[_0x233391(0x1e1)],{'cardLast4':_0x45f55f['additionalInfo']?.[_0x233391(0x29a)],'paymentMethod':_0x45f55f[_0x233391(0x2e8)]?.[_0x233391(0x1f5)]});}catch(_0x1c3ec4){console[_0x233391(0x28d)]('❌\x20Error\x20processing\x20Amer\x20webhook:',_0x1c3ec4),loggerService_1[_0x233391(0x2ca)][_0x233391(0x205)]('amer',_0x1c3ec4,_0x347e5c);throw _0x1c3ec4;}}async[a62_0x55fdca(0x24e)](_0x1edd01){const _0x5a1eac=a62_0x55fdca;console[_0x5a1eac(0x26a)](_0x5a1eac(0x234),JSON[_0x5a1eac(0x2dc)](_0x1edd01,null,0x2)),console[_0x5a1eac(0x26a)](_0x5a1eac(0x261));try{const _0x4f85ad=await this[_0x5a1eac(0x213)][_0x5a1eac(0x254)](_0x1edd01);console[_0x5a1eac(0x26a)](_0x5a1eac(0x2ee),_0x4f85ad);if(!_0x4f85ad[_0x5a1eac(0x26f)]){console[_0x5a1eac(0x28d)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20AmPay\x20webhook\x20data'),console['error']('❌\x20Available\x20webhook\x20fields:',Object['keys'](_0x1edd01));throw new Error('No\x20payment\x20ID\x20in\x20AmPay\x20webhook');}let _0x3be5f8=null;console[_0x5a1eac(0x26a)]('🔍\x20AmPay\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x4f85ad[_0x5a1eac(0x26f)]),_0x3be5f8=await database_1[_0x5a1eac(0x229)][_0x5a1eac(0x1ff)][_0x5a1eac(0x2a8)]({'where':{'AND':[{'gateway':_0x5a1eac(0x23c)},{'OR':[{'gatewayPaymentId':_0x4f85ad[_0x5a1eac(0x26f)]},{'gatewayOrderId':_0x4f85ad[_0x5a1eac(0x26f)]},{'id':_0x4f85ad[_0x5a1eac(0x26f)]},{'orderId':_0x4f85ad[_0x5a1eac(0x26f)]}]}]}}),console[_0x5a1eac(0x26a)](_0x5a1eac(0x2a4)+(_0x3be5f8?_0x5a1eac(0x294)+_0x3be5f8['id']:_0x5a1eac(0x230)));if(!_0x3be5f8){console['error'](_0x5a1eac(0x23e)+_0x4f85ad[_0x5a1eac(0x26f)]);return;}console['log']('📊\x20AmPay\x20webhook:\x20Payment\x20'+_0x3be5f8['id']+_0x5a1eac(0x2fe)+_0x4f85ad[_0x5a1eac(0x1e1)]),loggerService_1[_0x5a1eac(0x2ca)][_0x5a1eac(0x2fb)]('ampay',_0x3be5f8['id'],_0x3be5f8[_0x5a1eac(0x1e1)],_0x5a1eac(0x25f),_0x1edd01);}catch(_0x351151){console[_0x5a1eac(0x28d)](_0x5a1eac(0x22b),_0x351151),loggerService_1[_0x5a1eac(0x2ca)][_0x5a1eac(0x205)]('ampay',_0x351151,_0x1edd01);throw _0x351151;}}async[a62_0x55fdca(0x2e4)](_0x1e2760,_0x51ad2b){const _0x2de51e=a62_0x55fdca,_0x200fa3=Date[_0x2de51e(0x27d)]();try{const _0x22e279=_0x1e2760['shop'],_0x439ad3=_0x22e279[_0x2de51e(0x2e0)];if(!_0x439ad3?.[_0x2de51e(0x265)]){console['log'](_0x2de51e(0x275)+_0x22e279['id']);return;}const _0x596988=_0x51ad2b===_0x2de51e(0x2d9)?_0x2de51e(0x2c3):_0x51ad2b===_0x2de51e(0x263)?_0x2de51e(0x29d):_0x51ad2b==='EXPIRED'?_0x2de51e(0x29d):_0x51ad2b===_0x2de51e(0x2e7)?_0x2de51e(0x29d):_0x51ad2b===_0x2de51e(0x242)?_0x2de51e(0x29d):_0x2de51e(0x248);let _0xd3c71b=[];if(_0x439ad3['webhookEvents'])try{_0xd3c71b=Array['isArray'](_0x439ad3['webhookEvents'])?_0x439ad3[_0x2de51e(0x20f)]:JSON['parse'](_0x439ad3[_0x2de51e(0x20f)]);}catch(_0x456b37){console[_0x2de51e(0x28d)](_0x2de51e(0x2e1),_0x456b37),_0xd3c71b=[];}if(!_0xd3c71b[_0x2de51e(0x224)](_0x596988)){console[_0x2de51e(0x26a)](_0x2de51e(0x2c4)+_0x596988+_0x2de51e(0x218)+_0x22e279['id']);return;}const _0x1b0809={'event':_0x596988,'payment':{'id':_0x1e2760['id'],'order_id':_0x1e2760[_0x2de51e(0x22d)],'gateway_order_id':_0x1e2760[_0x2de51e(0x241)],'gateway':_0x1e2760[_0x2de51e(0x239)],'amount':_0x1e2760['amount'],'currency':_0x1e2760[_0x2de51e(0x2a2)],'status':_0x51ad2b['toLowerCase'](),'customer_email':_0x1e2760[_0x2de51e(0x1e3)],'customer_name':_0x1e2760[_0x2de51e(0x276)],'failure_message':_0x1e2760[_0x2de51e(0x2d3)],'tx_urls':_0x1e2760['txUrls']?JSON[_0x2de51e(0x262)](_0x1e2760[_0x2de51e(0x1ec)]):null,'created_at':_0x1e2760['createdAt'],'updated_at':_0x1e2760[_0x2de51e(0x2af)]}},_0x22c261=await fetch(_0x439ad3[_0x2de51e(0x265)],{'method':'POST','headers':{'Content-Type':_0x2de51e(0x2a3),'User-Agent':_0x2de51e(0x1fc)},'body':JSON[_0x2de51e(0x2dc)](_0x1b0809)}),_0x3f9238=Date[_0x2de51e(0x27d)]()-_0x200fa3,_0x3d8c84=_0x22c261['ok']?_0x2de51e(0x1e6):await _0x22c261[_0x2de51e(0x24a)]();loggerService_1[_0x2de51e(0x2ca)]['logShopWebhookSent'](_0x1e2760['shopId'],_0x439ad3['webhookUrl'],_0x596988,_0x22c261[_0x2de51e(0x1e1)],_0x3f9238,_0x1b0809),console[_0x2de51e(0x26a)]('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x439ad3[_0x2de51e(0x265)]+'\x20with\x20status\x20'+_0x22c261['status']+'\x20('+_0x3f9238+_0x2de51e(0x23b));}catch(_0x47d551){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x47d551),loggerService_1[_0x2de51e(0x2ca)]['logShopWebhookError'](_0x1e2760['shopId'],_0x1e2760[_0x2de51e(0x2b6)]?.['settings']?.[_0x2de51e(0x265)]||_0x2de51e(0x236),_0x2de51e(0x2da),_0x47d551,{});}}async[a62_0x55fdca(0x201)](_0x5dff80,_0x518b4b){const _0x36a3ef=a62_0x55fdca;try{const _0x1276b9={'PENDING':_0x36a3ef(0x284),'PROCESSING':_0x36a3ef(0x217),'PAID':_0x36a3ef(0x282),'FAILED':_0x36a3ef(0x1e2),'EXPIRED':'expired','REFUND':_0x36a3ef(0x2f1),'CHARGEBACK':_0x36a3ef(0x2a9)},_0x4ff116=_0x1276b9[_0x518b4b];if(!_0x4ff116||_0x4ff116==='created')return;await telegramBotService_1[_0x36a3ef(0x237)][_0x36a3ef(0x203)](_0x5dff80[_0x36a3ef(0x277)],_0x5dff80,_0x4ff116);}catch(_0x31c41b){console[_0x36a3ef(0x28d)](_0x36a3ef(0x215),_0x31c41b);}}async[a62_0x55fdca(0x2c2)](_0x1d6842,_0x46e8ca){const _0x52303f=a62_0x55fdca;try{const _0x2930f0=await database_1['default'][_0x52303f(0x2b6)]['findUnique']({'where':{'id':_0x1d6842},'select':{'gatewaySettings':!![]}});if(!_0x2930f0?.['gatewaySettings'])return console['log'](_0x52303f(0x1e4)+_0x1d6842+_0x52303f(0x24d)),0xa;const _0x2832be=JSON[_0x52303f(0x262)](_0x2930f0['gatewaySettings']);for(const [_0x2db671,_0x5aba4e]of Object[_0x52303f(0x1fd)](_0x2832be)){if(_0x2db671[_0x52303f(0x2cd)]()===_0x46e8ca['toLowerCase']()){const _0x382df4=_0x5aba4e[_0x52303f(0x2e5)]||0xa;return console[_0x52303f(0x26a)](_0x52303f(0x28f)+_0x46e8ca+_0x52303f(0x296)+_0x1d6842+':\x20'+_0x382df4+'%'),_0x382df4;}}return console['log'](_0x52303f(0x2c1)+_0x46e8ca+_0x52303f(0x2e2)+_0x1d6842+_0x52303f(0x214)),0xa;}catch(_0x33551b){return console[_0x52303f(0x28d)](_0x52303f(0x2d5)+_0x1d6842+',\x20gateway\x20'+_0x46e8ca+':',_0x33551b),0xa;}}}exports['WebhookService']=WebhookService;