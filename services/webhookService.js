'use strict';const a69_0x417b24=a69_0x57f3;(function(_0x302a59,_0x49a766){const _0x1d6859=a69_0x57f3,_0x1bd758=_0x302a59();while(!![]){try{const _0x54af79=parseInt(_0x1d6859(0x1f2))/0x1*(parseInt(_0x1d6859(0x226))/0x2)+parseInt(_0x1d6859(0x1b2))/0x3*(parseInt(_0x1d6859(0x203))/0x4)+-parseInt(_0x1d6859(0x289))/0x5+parseInt(_0x1d6859(0x182))/0x6*(-parseInt(_0x1d6859(0x287))/0x7)+parseInt(_0x1d6859(0x1ab))/0x8+-parseInt(_0x1d6859(0x1fd))/0x9*(-parseInt(_0x1d6859(0x24c))/0xa)+-parseInt(_0x1d6859(0x201))/0xb*(parseInt(_0x1d6859(0x230))/0xc);if(_0x54af79===_0x49a766)break;else _0x1bd758['push'](_0x1bd758['shift']());}catch(_0x7c102){_0x1bd758['push'](_0x1bd758['shift']());}}}(a69_0x4d64,0xd226e));function a69_0x4d64(){const _0xaaea8a=['bankId','💰\x20Adding\x20to\x20balance:\x20','created','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','update','logShopWebhookSent','18Govorz','\x20not\x20found','💰\x20Converting\x20','\x20status\x20updated\x20to\x20FAILED','319253BpvQRH','ℹ️\x20Decline\x20reason:\x20','1207684LzxRys','status_addition_info','\x20->\x20','customerEmail','ms)','Error\x20processing\x20Noda\x20webhook:','💰\x20Payment\x20amount\x20is\x20NOT\x20deducted\x20(chargeback\x20penalty\x20only)','getGatewayCommission','\x20for\x20AmPay\x20webhook','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','💰\x20Payment\x20','COMPLETED','\x20status\x20','remitterName','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','WebhookService','create','📊\x20CoinToPay\x20webhook:\x20Payment\x20','📊\x20Payment\x20status:\x20','gatewayPaymentId','Error\x20processing\x20Plisio\x20webhook:','paymentId','❌\x20Error\x20processing\x20AmPay\x20webhook:','📊\x20MasterCard\x20webhook\x20result:','stringify','No\x20additional\x20info','logShopWebhookError','amountUSDT','🔍\x20VISA\x20payment\x20search\x20result:\x20','RapydService','No\x20payment\x20ID\x20in\x20Noda\x20webhook','📊\x20Plisio\x20webhook:\x20Payment\x20','payment_method','ℹ️\x20AmPay\x20status\x20','updatedAt','25374Nfvooy','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','📈\x20Payment\x20','toFixed','ampay_try_','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','desc','PAID','468iCTgIi','visaMasterCardService','processVisaWebhook','ℹ️\x20AmPay\x20TRY\x20status\x20','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','❌\x20Available\x20webhook\x20fields:','toLowerCase','./gateways/amerService','PlisioService','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','\x20commission\x20for\x20shop\x20','coinToPay2Service','./telegramBotService','Payment\x20','cardLast4','📊\x20Amer\x20webhook:\x20Payment\x20','📊\x20AmPay\x20TRY\x20webhook\x20data:','system',':\x20type=','\x20to\x20','VisaMasterCardService','\x22,\x20orderId=\x22','FAILED','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','⚠️\x20CHARGEBACK\x20without\x20penalty\x20amount\x20-\x20no\x20balance\x20change','myxspend','5636030BldixK','🔄\x20Processing\x20Rapyd\x20webhook:','processCoinToPayWebhook','unknown','noda','\x20USDT\x20(chargeback\x20penalty\x20ONLY)',',\x20gatewayOrderId:\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','💸\x20CHARGEBACK\x20penalty\x20ONLY:\x20-','🔍\x20Found\x20VISA\x20payment:\x20ID=','🔄\x20Processing\x20AmPay\x20TRY\x20webhook:','processing','processNodaWebhook','processRapydWebhook','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','sendPaymentNotification','includes','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','💰\x20Gateway\x20','now','sendShopWebhook','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','\x20commission:\x20','klymeService','./gateways/ampayTRYService','map','\x20not\x20enabled\x20for\x20shop\x20','remitterIban','client_transaction_id','Found\x20payment\x20','amountAfterGatewayCommissionUSDT','Error\x20processing\x20Rapyd\x20webhook:','🔍\x20Search\x20result:\x20','logWebhookProcessed','gateway','ampay','🔄\x20Processing\x20Plisio\x20webhook:','paymentMethod','No\x20gateway\x20settings\x20found\x20for\x20shop\x20',',\x20GatewayPaymentId=','📊\x20AmPay\x20webhook\x20data:','Success','shopId','payment.success','text','\x22,\x20id=\x22','MasterCard\x20payment\x20not\x20found:\x20',',\x20newStatus=','MASTERCARD','cointopay','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','\x20+\x20','\x22,\x20newStatus=\x22','webhookUrl','AmPayTRYService','system_id','plisioService','\x20in\x20shop\x20','findFirst','1830318jfEWaz','settings','3844175EEPqUR','coinToPayService','✅\x20Found\x20payment\x20','findMany','Not\x20found','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','💰\x20Removing\x20from\x20balance:\x20','processCoinToPay2Webhook','✅\x20Shop\x20','visa_','Payment\x20not\x20found:\x20','❌\x20VISA\x20webhook\x20processing\x20failed:','__esModule','updatePaymentStatus','processAmerWebhook','paymentLink','Error\x20processing\x20CoinToPay2\x20webhook:','mastercard','error','defineProperty','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','additionalInfo','toUpperCase','customerOrderId','VISA\x20payment\x20not\x20found:\x20','./gateways/rapydService',',\x20currentPayments=','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','📈\x20Found\x20payment\x20link\x20','myxspend_','cointopay2',',\x20using\x20default\x20commission\x2010%',',\x20card:\x20****','rapydService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhook_status_change_','log','EXPIRED','processKlymeWebhook',',\x20GatewayOrderId=','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','\x20=\x20','\x20for\x20AmPay\x20TRY\x20webhook','findUnique','REFUND','./gateways/plisioService','currentPayments',',\x20using\x20default\x2010%','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','🔄\x20Processing\x20Noda\x20webhook:','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','webhookLog','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','webhookEvents','CHARGEBACK','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','default','\x20-\x20','payment.failed','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','DECLINED','plisio','\x20with\x20status\x20','gatewayOrderId','Payment\x20System/1.0','commission','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','dateTime','❌\x20Error\x20processing\x20Amer\x20webhook:','12XKAJFU',',\x20gateway\x20','✅\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20','failed','processAmPayTRYWebhook','rapyd','ampayTRYService','amerService','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','\x20updated:\x20currentPayments=','errorMessage','processPlisioWebhook','ℹ️\x20MyXSpend\x20status\x20','VISA','💰\x20Amount\x20after\x20gateway\x20commission:\x20','🔄\x20Additional\x20data:',',\x20Status=','customerName','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','🔄\x20Processing\x20MasterCard\x20webhook:','Gateway\x20','../config/database','🔄\x20Processing\x20CoinToPay2\x20webhook:','No\x20payment\x20ID\x20in\x20Amer\x20webhook','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','convertToUSDT','chargebackAmount','CoinToPay2Service','CoinToPayService','entries','NodaService','🔄\x20Processing\x20MyXSpend\x20webhook:','AmerService','sendPaymentStatusNotification','🏪\x20Shop\x20','ampay_','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','amount','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','6215520ZFSYpg','currencyService','processPlisioGatewayWebhook','\x20(Status:\x20','visa','Payment\x20marked\x20as\x20CHARGEBACK\x20(no\x20penalty\x20specified)','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','3wVotTP','processAmPayWebhook','txUrls','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','gatewayCommissionRate','📊\x20VISA\x20webhook\x20result:','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','📊\x20Noda\x20webhook:\x20Payment\x20','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','❌\x20Payment\x20link\x20','\x20→\x20','failureMessage','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','nodaService','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','\x20(orderId:\x20','./gateways/klymeService','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','processMyXSpendWebhook','./gateways/nodaService','✅\x20Found\x20payment:\x20ID=','username','isArray',',\x20status=','paymentLinkId','❌\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:','paid','ampay_try','SINGLE','refund','balance','keys','🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:','shop','gatewaySettings','📈\x20Payment\x20details:\x20oldStatus=\x22','type','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','❌\x20Error\x20processing\x20MasterCard\x20webhook:','amer','🔍\x20VISA\x20payment\x20search\x20executed','loggerService','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','📊\x20MyXSpend\x20webhook\x20data:','✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','visa_mastercard','chargeback','processWebhook','Query\x20params:','ampayService','plisio_gateway','paidAt','📊\x20Rapyd\x20webhook:\x20Payment\x20','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','parse','🔄\x20Processing\x20KLYME\x20webhook:','\x20USDT','\x20current\x20balance:\x20','currency','status','visa/mastercard','🔄\x20Processing\x20Amer\x20webhook:','85mUJgmp','logWebhookError','klyme','./gateways/coinToPay2Service','payment'];a69_0x4d64=function(){return _0xaaea8a;};return a69_0x4d64();}var __importDefault=this&&this['__importDefault']||function(_0x3accb3){const _0x576b6c=a69_0x57f3;return _0x3accb3&&_0x3accb3[_0x576b6c(0x296)]?_0x3accb3:{'default':_0x3accb3};};function a69_0x57f3(_0x49e653,_0x111ada){const _0x4d6428=a69_0x4d64();return a69_0x57f3=function(_0x57f318,_0x4d3dd7){_0x57f318=_0x57f318-0x165;let _0x33132c=_0x4d6428[_0x57f318];return _0x33132c;},a69_0x57f3(_0x49e653,_0x111ada);}Object[a69_0x417b24(0x29d)](exports,'__esModule',{'value':!![]}),exports[a69_0x417b24(0x212)]=void 0x0;const database_1=__importDefault(require(a69_0x417b24(0x199))),plisioService_1=require(a69_0x417b24(0x16a)),rapydService_1=require(a69_0x417b24(0x2a3)),nodaService_1=require(a69_0x417b24(0x1c5)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a69_0x417b24(0x1f5)),klymeService_1=require(a69_0x417b24(0x1c2)),mastercardService_1=require('./gateways/mastercardService'),amerService_1=require(a69_0x417b24(0x238)),ampayService_1=require('./gateways/ampayService'),ampayTRYService_1=require(a69_0x417b24(0x264)),telegramBotService_1=require(a69_0x417b24(0x23d)),currencyService_1=require('./currencyService'),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x49dc72=a69_0x417b24;this['plisioService']=new plisioService_1[(_0x49dc72(0x239))](),this[_0x49dc72(0x2ab)]=new rapydService_1[(_0x49dc72(0x220))](),this[_0x49dc72(0x1bf)]=new nodaService_1[(_0x49dc72(0x1a2))](),this[_0x49dc72(0x28a)]=new coinToPayService_1[(_0x49dc72(0x1a0))](),this[_0x49dc72(0x23c)]=new coinToPay2Service_1[(_0x49dc72(0x19f))](),this[_0x49dc72(0x263)]=new klymeService_1['KlymeService'](),this['visaMasterCardService']=new mastercardService_1[(_0x49dc72(0x245))](),this[_0x49dc72(0x189)]=new amerService_1[(_0x49dc72(0x1a4))](),this[_0x49dc72(0x1e5)]=new ampayService_1['AmPayService'](),this[_0x49dc72(0x188)]=new ampayTRYService_1[(_0x49dc72(0x282))]();}async['updatePaymentStatus'](_0x557b5b,_0x2213cf,_0x1eb52d){const _0xd8953d=a69_0x417b24;console['log'](_0xd8953d(0x18a)+_0x557b5b+_0xd8953d(0x27b)+_0x2213cf),console[_0xd8953d(0x2ae)](_0xd8953d(0x192),_0x1eb52d),await database_1[_0xd8953d(0x175)]['$transaction'](async _0x157ce3=>{const _0xd0a9af=_0xd8953d,_0x3bdffd=await _0x157ce3[_0xd0a9af(0x1f6)][_0xd0a9af(0x168)]({'where':{'id':_0x557b5b},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3bdffd)throw new Error(_0xd0a9af(0x23e)+_0x557b5b+'\x20not\x20found');const _0x464e3b=_0x3bdffd[_0xd0a9af(0x1ef)],_0x362550=_0x3bdffd[_0xd0a9af(0x1d3)];console[_0xd0a9af(0x2ae)](_0xd0a9af(0x20d)+_0x557b5b+':\x20'+_0x464e3b+_0xd0a9af(0x205)+_0x2213cf),console['log'](_0xd0a9af(0x1a6)+_0x362550['username']+_0xd0a9af(0x1ed)+_0x362550[_0xd0a9af(0x1d0)]+_0xd0a9af(0x1ec));const _0x33d8bd={'status':_0x2213cf[_0xd0a9af(0x2a0)](),'updatedAt':new Date(),'statusChangedBy':_0xd0a9af(0x242),'statusChangedAt':new Date()};_0x1eb52d?.['failureMessage']&&(_0x33d8bd[_0xd0a9af(0x1bd)]=_0x1eb52d['failureMessage']);_0x1eb52d?.[_0xd0a9af(0x1b4)]&&(_0x33d8bd[_0xd0a9af(0x1b4)]=JSON[_0xd0a9af(0x21b)](_0x1eb52d[_0xd0a9af(0x1b4)]));_0x1eb52d?.['cardLast4']&&(_0x33d8bd[_0xd0a9af(0x23f)]=_0x1eb52d[_0xd0a9af(0x23f)]);_0x1eb52d?.['paymentMethod']&&(_0x33d8bd[_0xd0a9af(0x271)]=_0x1eb52d[_0xd0a9af(0x271)]);_0x1eb52d?.[_0xd0a9af(0x1f7)]&&(_0x33d8bd[_0xd0a9af(0x1f7)]=_0x1eb52d[_0xd0a9af(0x1f7)]);_0x1eb52d?.[_0xd0a9af(0x267)]&&(_0x33d8bd[_0xd0a9af(0x267)]=_0x1eb52d['remitterIban']);_0x1eb52d?.[_0xd0a9af(0x210)]&&(_0x33d8bd['remitterName']=_0x1eb52d[_0xd0a9af(0x210)]);let _0x5cc821=_0x362550[_0xd0a9af(0x1d0)],_0x5b5617='';if(_0x2213cf[_0xd0a9af(0x2a0)]()===_0xd0a9af(0x22f)&&_0x464e3b!=='PAID'){const _0x39f052=await currencyService_1[_0xd0a9af(0x1ac)][_0xd0a9af(0x19d)](_0x3bdffd[_0xd0a9af(0x1a9)],_0x3bdffd[_0xd0a9af(0x1ee)]),_0x53f4e9=await this[_0xd0a9af(0x20a)](_0x362550['id'],_0x3bdffd[_0xd0a9af(0x26e)]),_0x3e9cf1=_0x39f052*(0x1-_0x53f4e9/0x64);_0x5cc821+=_0x3e9cf1,_0x5b5617='+'+_0x3e9cf1[_0xd0a9af(0x22a)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20'+_0x53f4e9+'%\x20gateway\x20commission)',_0x33d8bd[_0xd0a9af(0x21e)]=_0x39f052,_0x33d8bd[_0xd0a9af(0x26a)]=_0x3e9cf1,_0x33d8bd[_0xd0a9af(0x1b6)]=_0x53f4e9,_0x33d8bd[_0xd0a9af(0x1e7)]=new Date(),console['log'](_0xd0a9af(0x1ff)+_0x3bdffd[_0xd0a9af(0x1a9)]+'\x20'+_0x3bdffd[_0xd0a9af(0x1ee)]+_0xd0a9af(0x205)+_0x39f052[_0xd0a9af(0x22a)](0x6)+_0xd0a9af(0x1ec)),console[_0xd0a9af(0x2ae)](_0xd0a9af(0x25e)+_0x3bdffd[_0xd0a9af(0x26e)]+_0xd0a9af(0x262)+_0x53f4e9+'%'),console[_0xd0a9af(0x2ae)](_0xd0a9af(0x191)+_0x3e9cf1[_0xd0a9af(0x22a)](0x6)+_0xd0a9af(0x1ec)),console['log'](_0xd0a9af(0x1f8)+_0x362550[_0xd0a9af(0x1d0)]+_0xd0a9af(0x27f)+_0x3e9cf1[_0xd0a9af(0x22a)](0x6)+_0xd0a9af(0x166)+_0x5cc821[_0xd0a9af(0x22a)](0x6)+_0xd0a9af(0x1ec));}else{if(_0x464e3b==='PAID'&&_0x2213cf['toUpperCase']()!==_0xd0a9af(0x22f)&&_0x2213cf[_0xd0a9af(0x2a0)]()!==_0xd0a9af(0x173)){let _0xb0d20;if(_0x3bdffd[_0xd0a9af(0x26a)])_0xb0d20=_0x3bdffd[_0xd0a9af(0x26a)];else{if(_0x3bdffd['amountUSDT']){const _0x22742b=await this['getGatewayCommission'](_0x362550['id'],_0x3bdffd[_0xd0a9af(0x26e)]);_0xb0d20=_0x3bdffd[_0xd0a9af(0x21e)]*(0x1-_0x22742b/0x64);}else console[_0xd0a9af(0x2ae)](_0xd0a9af(0x19c)),_0xb0d20=0x0;}_0xb0d20>0x0&&(_0x5cc821-=_0xb0d20,_0x5b5617='-'+_0xb0d20[_0xd0a9af(0x22a)](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x33d8bd[_0xd0a9af(0x1e7)]=null,console[_0xd0a9af(0x2ae)](_0xd0a9af(0x290)+_0x362550['balance']+_0xd0a9af(0x176)+_0xb0d20[_0xd0a9af(0x22a)](0x6)+_0xd0a9af(0x166)+_0x5cc821['toFixed'](0x6)+'\x20USDT'));}}if(_0x2213cf[_0xd0a9af(0x2a0)]()==='CHARGEBACK'){const _0x42d73d=_0x1eb52d?.['chargebackAmount']||0x0;console[_0xd0a9af(0x2ae)]('💸\x20CHARGEBACK:\x20Processing\x20penalty-only\x20deduction'),_0x42d73d>0x0?(_0x5cc821-=_0x42d73d,_0x5b5617='-'+_0x42d73d[_0xd0a9af(0x22a)](0x6)+_0xd0a9af(0x251),_0x33d8bd[_0xd0a9af(0x19e)]=_0x42d73d,console[_0xd0a9af(0x2ae)](_0xd0a9af(0x254)+_0x42d73d[_0xd0a9af(0x22a)](0x6)+_0xd0a9af(0x1ec)),console['log'](_0xd0a9af(0x209)),console[_0xd0a9af(0x2ae)]('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x5cc821['toFixed'](0x6)+'\x20USDT')):(console['log'](_0xd0a9af(0x24a)),_0x5b5617=_0xd0a9af(0x1b0));}const _0x59920a=await _0x157ce3[_0xd0a9af(0x1f6)][_0xd0a9af(0x1fb)]({'where':{'id':_0x557b5b},'data':_0x33d8bd});_0x5cc821!==_0x362550[_0xd0a9af(0x1d0)]&&(await _0x157ce3[_0xd0a9af(0x1d3)]['update']({'where':{'id':_0x362550['id']},'data':{'balance':_0x5cc821}}),console[_0xd0a9af(0x2ae)](_0xd0a9af(0x292)+_0x362550[_0xd0a9af(0x1c7)]+'\x20balance\x20updated:\x20'+_0x362550['balance'][_0xd0a9af(0x22a)](0x6)+'\x20->\x20'+_0x5cc821[_0xd0a9af(0x22a)](0x6)+_0xd0a9af(0x1ec)),console[_0xd0a9af(0x2ae)]('📝\x20Reason:\x20'+_0x5b5617));await _0x157ce3[_0xd0a9af(0x170)]['create']({'data':{'paymentId':_0x557b5b,'shopId':_0x362550['id'],'event':_0xd0a9af(0x2ad)+_0x2213cf[_0xd0a9af(0x237)](),'statusCode':0xc8,'responseBody':JSON[_0xd0a9af(0x21b)]({'oldStatus':_0x464e3b,'newStatus':_0x2213cf['toUpperCase'](),'balanceChange':_0x5b5617||'no\x20balance\x20change','oldBalance':_0x362550[_0xd0a9af(0x1d0)],'newBalance':_0x5cc821,'amountUSDT':_0x33d8bd['amountUSDT'],'additionalData':_0x1eb52d,'timestamp':new Date()['toISOString']()})}}),await this[_0xd0a9af(0x260)]({..._0x3bdffd,..._0x59920a,'shop':_0x362550},_0x2213cf[_0xd0a9af(0x2a0)]()),await this[_0xd0a9af(0x1a5)]({..._0x3bdffd,..._0x59920a},_0x2213cf[_0xd0a9af(0x2a0)]());if(_0x464e3b!=='PAID'&&_0x2213cf['toUpperCase']()===_0xd0a9af(0x22f)){console[_0xd0a9af(0x2ae)]('📈\x20Payment\x20'+_0x557b5b+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console[_0xd0a9af(0x2ae)](_0xd0a9af(0x1d5)+_0x464e3b+_0xd0a9af(0x280)+_0x2213cf[_0xd0a9af(0x2a0)]()+'\x22,\x20paymentLinkId=\x22'+_0x3bdffd[_0xd0a9af(0x1ca)]+'\x22');if(_0x3bdffd[_0xd0a9af(0x1ca)])try{const _0x1d087b=await _0x157ce3[_0xd0a9af(0x299)]['findUnique']({'where':{'id':_0x3bdffd[_0xd0a9af(0x1ca)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1d087b){console[_0xd0a9af(0x2ae)](_0xd0a9af(0x2a6)+_0x1d087b['id']+_0xd0a9af(0x243)+_0x1d087b['type']+_0xd0a9af(0x2a4)+_0x1d087b['currentPayments']+_0xd0a9af(0x1c9)+_0x1d087b[_0xd0a9af(0x1ef)]);const _0x220751=_0x1d087b[_0xd0a9af(0x16b)]+0x1,_0x2599b4=_0x1d087b[_0xd0a9af(0x1d6)]===_0xd0a9af(0x1ce)?_0xd0a9af(0x20e):_0x1d087b[_0xd0a9af(0x1ef)];await _0x157ce3[_0xd0a9af(0x299)]['update']({'where':{'id':_0x3bdffd[_0xd0a9af(0x1ca)]},'data':{'currentPayments':_0x220751,'status':_0x2599b4,'updatedAt':new Date()}}),console[_0xd0a9af(0x2ae)]('✅\x20Payment\x20link\x20'+_0x1d087b['id']+_0xd0a9af(0x18c)+_0x1d087b['currentPayments']+_0xd0a9af(0x205)+_0x220751+',\x20status='+_0x1d087b[_0xd0a9af(0x1ef)]+_0xd0a9af(0x205)+_0x2599b4);}else console['log'](_0xd0a9af(0x1bb)+_0x3bdffd[_0xd0a9af(0x1ca)]+_0xd0a9af(0x1fe));}catch(_0xeeca08){console[_0xd0a9af(0x29c)](_0xd0a9af(0x28e),_0xeeca08);}else console['log'](_0xd0a9af(0x229)+_0x557b5b+_0xd0a9af(0x22d));}else console[_0xd0a9af(0x2ae)](_0xd0a9af(0x229)+_0x557b5b+_0xd0a9af(0x211)+_0x464e3b+_0xd0a9af(0x205)+_0x2213cf[_0xd0a9af(0x2a0)]());});}async[a69_0x417b24(0x18e)](_0x4170c1){const _0x5a4578=a69_0x417b24;console['log'](_0x5a4578(0x270),_0x4170c1);try{const _0x2b4ae6=await this[_0x5a4578(0x284)]['processWebhook'](_0x4170c1);if(!_0x2b4ae6['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x347519=await database_1['default'][_0x5a4578(0x1f6)][_0x5a4578(0x286)]({'where':{'gatewayOrderId':_0x2b4ae6[_0x5a4578(0x218)]}});if(!_0x347519){console['error']('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x2b4ae6[_0x5a4578(0x218)]);return;}console[_0x5a4578(0x2ae)](_0x5a4578(0x222)+_0x347519['id']+_0x5a4578(0x20f)+_0x2b4ae6['status']),await this[_0x5a4578(0x297)](_0x347519['id'],_0x2b4ae6[_0x5a4578(0x1ef)],{'txUrls':_0x2b4ae6[_0x5a4578(0x1b4)]}),loggerService_1[_0x5a4578(0x1db)][_0x5a4578(0x26d)]('plisio',_0x347519['id'],_0x347519[_0x5a4578(0x1ef)],_0x2b4ae6[_0x5a4578(0x1ef)],_0x4170c1);}catch(_0x1615d1){console['error'](_0x5a4578(0x217),_0x1615d1),loggerService_1[_0x5a4578(0x1db)][_0x5a4578(0x1f3)](_0x5a4578(0x17a),_0x1615d1,_0x4170c1);throw _0x1615d1;}}async[a69_0x417b24(0x1ad)](_0x32bd30){const _0x2c7180=a69_0x417b24;console[_0x2c7180(0x2ae)](_0x2c7180(0x1d7),_0x32bd30);try{const _0x3301da=await this[_0x2c7180(0x284)][_0x2c7180(0x1e3)](_0x32bd30);if(!_0x3301da[_0x2c7180(0x218)])throw new Error(_0x2c7180(0x235));const _0x39c870=await database_1[_0x2c7180(0x175)][_0x2c7180(0x1f6)][_0x2c7180(0x286)]({'where':{'gatewayOrderId':_0x3301da[_0x2c7180(0x218)]}});if(!_0x39c870){console['error'](_0x2c7180(0x178)+_0x3301da[_0x2c7180(0x218)]);return;}console[_0x2c7180(0x2ae)](_0x2c7180(0x1b8)+_0x39c870['id']+_0x2c7180(0x20f)+_0x3301da['status']),await this[_0x2c7180(0x297)](_0x39c870['id'],_0x3301da['status'],{'txUrls':_0x3301da[_0x2c7180(0x1b4)]}),loggerService_1[_0x2c7180(0x1db)][_0x2c7180(0x26d)](_0x2c7180(0x1e6),_0x39c870['id'],_0x39c870['status'],_0x3301da['status'],_0x32bd30);}catch(_0x59c155){console[_0x2c7180(0x29c)](_0x2c7180(0x171),_0x59c155),loggerService_1[_0x2c7180(0x1db)][_0x2c7180(0x1f3)]('plisio_gateway',_0x59c155,_0x32bd30);throw _0x59c155;}}async[a69_0x417b24(0x259)](_0x138ab5){const _0x5034e6=a69_0x417b24;console[_0x5034e6(0x2ae)](_0x5034e6(0x24d),_0x138ab5);try{const _0x5c3280=await this[_0x5034e6(0x2ab)][_0x5034e6(0x1e3)](_0x138ab5);if(!_0x5c3280['paymentId'])throw new Error(_0x5034e6(0x228));const _0x2ed6c1=await database_1[_0x5034e6(0x175)][_0x5034e6(0x1f6)][_0x5034e6(0x286)]({'where':{'gatewayOrderId':_0x5c3280['paymentId']}});if(!_0x2ed6c1){console[_0x5034e6(0x29c)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x5c3280[_0x5034e6(0x218)]);return;}console['log'](_0x5034e6(0x1e8)+_0x2ed6c1['id']+'\x20status\x20'+_0x5c3280['status']),await this[_0x5034e6(0x297)](_0x2ed6c1['id'],_0x5c3280[_0x5034e6(0x1ef)],{'failureMessage':_0x5c3280['failureMessage'],'cardLast4':_0x5c3280[_0x5034e6(0x29f)]?.[_0x5034e6(0x23f)],'paymentMethod':_0x5c3280[_0x5034e6(0x29f)]?.[_0x5034e6(0x271)]}),loggerService_1['loggerService'][_0x5034e6(0x26d)](_0x5034e6(0x187),_0x2ed6c1['id'],_0x2ed6c1[_0x5034e6(0x1ef)],_0x5c3280['status'],_0x138ab5);}catch(_0x488c16){console[_0x5034e6(0x29c)](_0x5034e6(0x26b),_0x488c16),loggerService_1[_0x5034e6(0x1db)][_0x5034e6(0x1f3)]('rapyd',_0x488c16,_0x138ab5);throw _0x488c16;}}async[a69_0x417b24(0x258)](_0x1be541){const _0x181337=a69_0x417b24;console[_0x181337(0x2ae)](_0x181337(0x16e),_0x1be541);try{const _0x133bcc=await this[_0x181337(0x1bf)][_0x181337(0x1e3)](_0x1be541);if(!_0x133bcc['paymentId'])throw new Error(_0x181337(0x221));const _0x3956c2=await database_1[_0x181337(0x175)][_0x181337(0x1f6)]['findFirst']({'where':{'gatewayOrderId':_0x133bcc[_0x181337(0x218)]}});if(!_0x3956c2){console[_0x181337(0x29c)](_0x181337(0x174)+_0x133bcc[_0x181337(0x218)]);return;}console[_0x181337(0x2ae)](_0x181337(0x1b9)+_0x3956c2['id']+_0x181337(0x20f)+_0x133bcc[_0x181337(0x1ef)]),await this[_0x181337(0x297)](_0x3956c2['id'],_0x133bcc[_0x181337(0x1ef)],{'bankId':_0x133bcc[_0x181337(0x29f)]?.[_0x181337(0x1f7)],'remitterIban':_0x133bcc[_0x181337(0x29f)]?.[_0x181337(0x267)],'remitterName':_0x133bcc[_0x181337(0x29f)]?.[_0x181337(0x210)]}),loggerService_1[_0x181337(0x1db)][_0x181337(0x26d)](_0x181337(0x250),_0x3956c2['id'],_0x3956c2[_0x181337(0x1ef)],_0x133bcc[_0x181337(0x1ef)],_0x1be541);}catch(_0x34f890){console[_0x181337(0x29c)](_0x181337(0x208),_0x34f890),loggerService_1[_0x181337(0x1db)][_0x181337(0x1f3)](_0x181337(0x250),_0x34f890,_0x1be541);throw _0x34f890;}}async[a69_0x417b24(0x24e)](_0x4dc599){const _0x21a94f=a69_0x417b24;console[_0x21a94f(0x2ae)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x4dc599);try{const _0x5cae59=await this['coinToPayService']['processWebhook'](_0x4dc599);if(!_0x5cae59['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x58c364=await database_1[_0x21a94f(0x175)][_0x21a94f(0x1f6)]['findFirst']({'where':{'gatewayOrderId':_0x5cae59[_0x21a94f(0x218)]}});if(!_0x58c364){console[_0x21a94f(0x29c)](_0x21a94f(0x1dc)+_0x5cae59['paymentId']);return;}console['log'](_0x21a94f(0x214)+_0x58c364['id']+'\x20status\x20'+_0x5cae59['status']),await this['updatePaymentStatus'](_0x58c364['id'],_0x5cae59[_0x21a94f(0x1ef)]),loggerService_1[_0x21a94f(0x1db)]['logWebhookProcessed'](_0x21a94f(0x27d),_0x58c364['id'],_0x58c364[_0x21a94f(0x1ef)],_0x5cae59[_0x21a94f(0x1ef)],_0x4dc599);}catch(_0xa8997b){console[_0x21a94f(0x29c)]('Error\x20processing\x20CoinToPay\x20webhook:',_0xa8997b),loggerService_1[_0x21a94f(0x1db)]['logWebhookError'](_0x21a94f(0x27d),_0xa8997b,_0x4dc599);throw _0xa8997b;}}async[a69_0x417b24(0x291)](_0x21ebd9){const _0x51a592=a69_0x417b24;console[_0x51a592(0x2ae)](_0x51a592(0x19a),_0x21ebd9);try{const _0xca8efc=await this[_0x51a592(0x23c)]['processWebhook'](_0x21ebd9);if(!_0xca8efc['paymentId'])throw new Error(_0x51a592(0x253));const _0x13014e=await database_1['default'][_0x51a592(0x1f6)]['findFirst']({'where':{'gatewayOrderId':_0xca8efc[_0x51a592(0x218)]}});if(!_0x13014e){console[_0x51a592(0x29c)](_0x51a592(0x1ba)+_0xca8efc[_0x51a592(0x218)]);return;}console[_0x51a592(0x2ae)](_0x51a592(0x22c)+_0x13014e['id']+_0x51a592(0x20f)+_0xca8efc[_0x51a592(0x1ef)]),await this[_0x51a592(0x297)](_0x13014e['id'],_0xca8efc[_0x51a592(0x1ef)]),loggerService_1['loggerService'][_0x51a592(0x26d)](_0x51a592(0x2a8),_0x13014e['id'],_0x13014e[_0x51a592(0x1ef)],_0xca8efc['status'],_0x21ebd9);}catch(_0x54700d){console[_0x51a592(0x29c)](_0x51a592(0x29a),_0x54700d),loggerService_1[_0x51a592(0x1db)]['logWebhookError']('cointopay2',_0x54700d,_0x21ebd9);throw _0x54700d;}}async[a69_0x417b24(0x2b0)](_0x1b1198){const _0x47db4f=a69_0x417b24;console[_0x47db4f(0x2ae)](_0x47db4f(0x1eb),_0x1b1198);try{const _0x11f3bc=await this[_0x47db4f(0x263)][_0x47db4f(0x1e3)](_0x1b1198);if(!_0x11f3bc['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x10317c=await database_1[_0x47db4f(0x175)][_0x47db4f(0x1f6)][_0x47db4f(0x286)]({'where':{'gatewayOrderId':_0x11f3bc['paymentId']}});if(!_0x10317c){console[_0x47db4f(0x29c)](_0x47db4f(0x1a8)+_0x11f3bc['paymentId']);return;}console[_0x47db4f(0x2ae)]('📊\x20KLYME\x20webhook:\x20Payment\x20'+_0x10317c['id']+_0x47db4f(0x20f)+_0x11f3bc[_0x47db4f(0x1ef)]),await this[_0x47db4f(0x297)](_0x10317c['id'],_0x11f3bc[_0x47db4f(0x1ef)],{'paymentMethod':_0x11f3bc[_0x47db4f(0x29f)]?.['payment_method']}),loggerService_1['loggerService'][_0x47db4f(0x26d)](_0x47db4f(0x1f4),_0x10317c['id'],_0x10317c['status'],_0x11f3bc[_0x47db4f(0x1ef)],_0x1b1198);}catch(_0x27892e){console[_0x47db4f(0x29c)]('Error\x20processing\x20KLYME\x20webhook:',_0x27892e),loggerService_1[_0x47db4f(0x1db)][_0x47db4f(0x1f3)]('klyme',_0x27892e,_0x1b1198);throw _0x27892e;}}async[a69_0x417b24(0x232)](_0x4820cc){const _0xacede9=a69_0x417b24;console[_0xacede9(0x2ae)]('🔄\x20Processing\x20VISA\x20webhook:',JSON[_0xacede9(0x21b)](_0x4820cc,null,0x2));try{const _0xefe105=await this[_0xacede9(0x231)][_0xacede9(0x1e3)](_0x4820cc,_0xacede9(0x190));console['log'](_0xacede9(0x1b7),_0xefe105);if(!_0xefe105[_0xacede9(0x218)]){console['error'](_0xacede9(0x2a5)),console['error'](_0xacede9(0x236),Object[_0xacede9(0x1d1)](_0x4820cc));throw new Error('No\x20payment\x20ID\x20in\x20VISA\x20webhook');}let _0x11208e=null;console[_0xacede9(0x2ae)](_0xacede9(0x28f)+_0xefe105['paymentId']);if(_0xefe105[_0xacede9(0x218)]){console[_0xacede9(0x2ae)](_0xacede9(0x1be)),console['log'](_0xacede9(0x25d)),console[_0xacede9(0x2ae)](_0xacede9(0x234)),console[_0xacede9(0x2ae)](_0xacede9(0x1aa)+_0xefe105[_0xacede9(0x218)]),console[_0xacede9(0x2ae)](_0xacede9(0x196)),_0x11208e=await database_1[_0xacede9(0x175)][_0xacede9(0x1f6)][_0xacede9(0x286)]({'where':{'AND':[{'OR':[{'gateway':_0xacede9(0x1f0)},{'gateway':_0xacede9(0x29b)}]},{'OR':[{'gatewayPaymentId':_0xefe105[_0xacede9(0x218)]},{'gatewayOrderId':_0xefe105['paymentId']},{'id':_0xefe105[_0xacede9(0x218)]},{'orderId':_0xefe105[_0xacede9(0x218)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0xacede9(0x2ae)](_0xacede9(0x1da));if(_0x11208e)console['log'](_0xacede9(0x1c6)+_0x11208e['id']+_0xacede9(0x2b1)+_0x11208e['gatewayOrderId']+_0xacede9(0x273)+_0x11208e[_0xacede9(0x216)]);else{console[_0xacede9(0x2ae)](_0xacede9(0x1c0));const _0x317ec8=await database_1[_0xacede9(0x175)]['payment'][_0xacede9(0x28c)]({'where':{'gateway':_0xacede9(0x1f0)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0xacede9(0x22e)}});console[_0xacede9(0x2ae)](_0xacede9(0x1d2),_0x317ec8[_0xacede9(0x265)](_0x144823=>_0x144823['id']+_0xacede9(0x1c1)+_0x144823['orderId']+_0xacede9(0x252)+_0x144823[_0xacede9(0x17c)]+',\x20gatewayPaymentId:\x20'+_0x144823[_0xacede9(0x216)]+_0xacede9(0x2aa)+_0x144823[_0xacede9(0x23f)]+')'));}console[_0xacede9(0x2ae)](_0xacede9(0x21f)+(_0x11208e?'Found':_0xacede9(0x28d))),_0x11208e&&console[_0xacede9(0x2ae)](_0xacede9(0x255)+_0x11208e['id']+',\x20Gateway='+_0x11208e['gateway']+_0xacede9(0x193)+_0x11208e[_0xacede9(0x1ef)]+',\x20Card=****'+_0x11208e[_0xacede9(0x23f)]);}if(!_0x11208e){console[_0xacede9(0x29c)](_0xacede9(0x20c)+_0xefe105[_0xacede9(0x218)]),loggerService_1['loggerService'][_0xacede9(0x1f3)](_0xacede9(0x1af),new Error(_0xacede9(0x294)+_0xefe105['paymentId']),_0x4820cc);throw new Error(_0xacede9(0x2a2)+_0xefe105['paymentId']);}console['log']('📊\x20VISA\x20payment\x20found:\x20'+_0x11208e['id']+_0xacede9(0x1ae)+_0x11208e[_0xacede9(0x1ef)]+_0xacede9(0x1bc)+_0xefe105[_0xacede9(0x1ef)]+')');const _0x26298f={};_0xefe105[_0xacede9(0x1a9)]&&await database_1['default'][_0xacede9(0x1f6)]['update']({'where':{'id':_0x11208e['id']},'data':{'amount':_0xefe105[_0xacede9(0x1a9)],'updatedAt':new Date()}}),_0xefe105['currency']&&await database_1['default'][_0xacede9(0x1f6)][_0xacede9(0x1fb)]({'where':{'id':_0x11208e['id']},'data':{'currency':_0xefe105[_0xacede9(0x1ee)],'updatedAt':new Date()}}),_0xefe105[_0xacede9(0x1ef)]===_0xacede9(0x247)&&_0xefe105[_0xacede9(0x18d)]&&(_0x26298f[_0xacede9(0x1bd)]=_0xefe105['errorMessage'],console[_0xacede9(0x2ae)](_0xacede9(0x16d)+_0xefe105['errorMessage'])),_0x26298f[_0xacede9(0x271)]=_0xacede9(0x1af),await this[_0xacede9(0x297)](_0x11208e['id'],_0xefe105[_0xacede9(0x1ef)],_0x26298f),await database_1[_0xacede9(0x175)]['webhookLog'][_0xacede9(0x213)]({'data':{'paymentId':_0x11208e['id'],'shopId':_0x11208e[_0xacede9(0x276)],'event':_0xacede9(0x293)+_0xefe105[_0xacede9(0x1ef)][_0xacede9(0x237)](),'statusCode':0xc8,'responseBody':JSON[_0xacede9(0x21b)](_0xefe105)}}),await this[_0xacede9(0x1a5)](_0x11208e,_0xefe105[_0xacede9(0x1ef)][_0xacede9(0x2a0)]()),console[_0xacede9(0x2ae)]('✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20'+_0x11208e['id']);}catch(_0x3e1ebb){console[_0xacede9(0x29c)](_0xacede9(0x295),_0x3e1ebb),loggerService_1['loggerService'][_0xacede9(0x1f3)](_0xacede9(0x1af),_0x3e1ebb,_0x4820cc);throw _0x3e1ebb;}}async['processMasterCardWebhook'](_0x57ead8){const _0x1defed=a69_0x417b24;console[_0x1defed(0x2ae)](_0x1defed(0x197),JSON['stringify'](_0x57ead8,null,0x2));try{const _0x143119=await this['visaMasterCardService'][_0x1defed(0x1e3)](_0x57ead8,_0x1defed(0x27c));console['log'](_0x1defed(0x21a),_0x143119);if(!_0x143119['paymentId']){console[_0x1defed(0x29c)](_0x1defed(0x17f)),console['error'](_0x1defed(0x236),Object[_0x1defed(0x1d1)](_0x57ead8));throw new Error(_0x1defed(0x27e));}let _0x35f849=null;console[_0x1defed(0x2ae)](_0x1defed(0x1e9)+_0x143119[_0x1defed(0x218)]);_0x143119[_0x1defed(0x218)]&&(console['log']('🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x35f849=await database_1['default'][_0x1defed(0x1f6)]['findFirst']({'where':{'AND':[{'OR':[{'gateway':'visa_mastercard'},{'gateway':_0x1defed(0x29b)},{'gateway':_0x1defed(0x1f0)}]},{'OR':[{'gatewayPaymentId':_0x143119[_0x1defed(0x218)]},{'gatewayOrderId':_0x143119[_0x1defed(0x218)]},{'id':_0x143119[_0x1defed(0x218)]},{'orderId':_0x143119[_0x1defed(0x218)]}]}]}}),console[_0x1defed(0x2ae)](_0x1defed(0x26c)+(_0x35f849?'Found\x20payment\x20'+_0x35f849['id']:'Payment\x20not\x20found')));if(!_0x35f849){console[_0x1defed(0x29c)](_0x1defed(0x16f)+_0x143119[_0x1defed(0x218)]),console[_0x1defed(0x29c)](_0x1defed(0x1b5)+_0x143119[_0x1defed(0x218)]+_0x1defed(0x279)+_0x143119[_0x1defed(0x218)]+_0x1defed(0x246)+_0x143119[_0x1defed(0x218)]+'\x22');const _0x263c8a=await database_1[_0x1defed(0x175)][_0x1defed(0x1f6)][_0x1defed(0x28c)]({'where':{'OR':[{'gateway':_0x1defed(0x29b)},{'gateway':_0x1defed(0x1e1)},{'gateway':_0x1defed(0x1f0)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':'desc'},'take':0xf});console[_0x1defed(0x2ae)]('🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:',_0x263c8a),loggerService_1['loggerService'][_0x1defed(0x1f3)]('mastercard',new Error(_0x1defed(0x294)+_0x143119['paymentId']),_0x57ead8);throw new Error(_0x1defed(0x27a)+_0x143119[_0x1defed(0x218)]);}console['log'](_0x1defed(0x28b)+_0x35f849['id']+_0x1defed(0x23a)+_0x35f849['status']+_0x1defed(0x244)+_0x143119['status']);const _0x51324d={};_0x143119[_0x1defed(0x1a9)]&&await database_1[_0x1defed(0x175)][_0x1defed(0x1f6)][_0x1defed(0x1fb)]({'where':{'id':_0x35f849['id']},'data':{'amount':_0x143119[_0x1defed(0x1a9)],'updatedAt':new Date()}}),_0x143119['currency']&&await database_1[_0x1defed(0x175)]['payment'][_0x1defed(0x1fb)]({'where':{'id':_0x35f849['id']},'data':{'currency':_0x143119['currency'],'updatedAt':new Date()}}),_0x143119['status']===_0x1defed(0x247)&&_0x143119[_0x1defed(0x18d)]&&(_0x51324d[_0x1defed(0x1bd)]=_0x143119[_0x1defed(0x18d)],console['log'](_0x1defed(0x1b1)+_0x143119['errorMessage'])),_0x51324d[_0x1defed(0x271)]=_0x1defed(0x29b),await this[_0x1defed(0x297)](_0x35f849['id'],_0x143119[_0x1defed(0x1ef)],_0x51324d),loggerService_1[_0x1defed(0x1db)][_0x1defed(0x26d)]('mastercard',_0x35f849['id'],_0x35f849[_0x1defed(0x1ef)],_0x143119[_0x1defed(0x1ef)],_0x57ead8);}catch(_0xcf439a){console[_0x1defed(0x29c)](_0x1defed(0x1d8),_0xcf439a),loggerService_1['loggerService'][_0x1defed(0x1f3)](_0x1defed(0x29b),_0xcf439a,_0x57ead8);throw _0xcf439a;}}async[a69_0x417b24(0x298)](_0x167b78){const _0x202f0a=a69_0x417b24;console[_0x202f0a(0x2ae)](_0x202f0a(0x1f1),JSON[_0x202f0a(0x21b)](_0x167b78,null,0x2));try{const _0x1541fe=await this[_0x202f0a(0x189)][_0x202f0a(0x1e3)](_0x167b78);console['log']('📊\x20Amer\x20webhook\x20result:',_0x1541fe);if(!_0x1541fe['paymentId']){console[_0x202f0a(0x29c)](_0x202f0a(0x249)),console[_0x202f0a(0x29c)](_0x202f0a(0x236),Object[_0x202f0a(0x1d1)](_0x167b78));throw new Error(_0x202f0a(0x19b));}let _0x3ffd9f=null;console[_0x202f0a(0x2ae)](_0x202f0a(0x1fa)+_0x1541fe[_0x202f0a(0x218)]),_0x3ffd9f=await database_1[_0x202f0a(0x175)][_0x202f0a(0x1f6)][_0x202f0a(0x286)]({'where':{'AND':[{'gateway':_0x202f0a(0x1d9)},{'OR':[{'gatewayPaymentId':_0x1541fe[_0x202f0a(0x218)]},{'gatewayOrderId':_0x1541fe[_0x202f0a(0x218)]},{'id':_0x1541fe[_0x202f0a(0x218)]},{'orderId':_0x1541fe[_0x202f0a(0x218)]}]}]}}),console[_0x202f0a(0x2ae)]('🔍\x20Search\x20result:\x20'+(_0x3ffd9f?_0x202f0a(0x269)+_0x3ffd9f['id']:'Payment\x20not\x20found'));if(!_0x3ffd9f){console['error'](_0x202f0a(0x1c3)+_0x1541fe['paymentId']);return;}console[_0x202f0a(0x2ae)](_0x202f0a(0x240)+_0x3ffd9f['id']+_0x202f0a(0x20f)+_0x1541fe[_0x202f0a(0x1ef)]),await this['updatePaymentStatus'](_0x3ffd9f['id'],_0x1541fe[_0x202f0a(0x1ef)],{'cardLast4':_0x1541fe[_0x202f0a(0x29f)]?.[_0x202f0a(0x23f)],'paymentMethod':_0x1541fe[_0x202f0a(0x29f)]?.[_0x202f0a(0x271)]});}catch(_0x31b1cd){console[_0x202f0a(0x29c)](_0x202f0a(0x181),_0x31b1cd),loggerService_1[_0x202f0a(0x1db)][_0x202f0a(0x1f3)](_0x202f0a(0x1d9),_0x31b1cd,_0x167b78);throw _0x31b1cd;}}async[a69_0x417b24(0x1b3)](_0x1cdbfc){const _0x256388=a69_0x417b24;console[_0x256388(0x2ae)]('🔄\x20Processing\x20AmPay\x20webhook:',JSON[_0x256388(0x21b)](_0x1cdbfc,null,0x2));try{const _0x56df7b=_0x1cdbfc[_0x256388(0x1ef)],_0x4f1de5=_0x1cdbfc['client_transaction_id'],_0x313292=_0x1cdbfc['system_id'],_0x1752c6=_0x1cdbfc['payment_method'],_0x49e2f3=_0x1cdbfc[_0x256388(0x1a9)],_0x3aac70=_0x1cdbfc[_0x256388(0x1ee)],_0x562490=_0x1cdbfc[_0x256388(0x17e)],_0x3e522c=_0x1cdbfc[_0x256388(0x204)];if(!_0x4f1de5){console['error'](_0x256388(0x165));throw new Error('Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook');}console['log'](_0x256388(0x274),{'status':_0x56df7b,'clientTransactionId':_0x4f1de5,'systemId':_0x313292,'paymentMethod':_0x1752c6,'amount':_0x49e2f3,'currency':_0x3aac70,'commission':_0x562490,'statusAdditionInfo':_0x3e522c});const _0x32b672=await database_1[_0x256388(0x175)][_0x256388(0x1f6)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x4f1de5},{'orderId':_0x4f1de5},{'id':_0x4f1de5},{'gatewayPaymentId':_0x4f1de5}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x32b672){console[_0x256388(0x29c)]('❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20'+_0x4f1de5);throw new Error('Payment\x20not\x20found:\x20'+_0x4f1de5);}console[_0x256388(0x2ae)](_0x256388(0x28b)+_0x32b672['id']+_0x256388(0x20b)),console[_0x256388(0x2ae)](_0x256388(0x215)+_0x32b672[_0x256388(0x1ef)]+'\x20→\x20'+_0x56df7b),_0x56df7b===_0x256388(0x179)?(console[_0x256388(0x2ae)](_0x256388(0x18b)),await this[_0x256388(0x297)](_0x32b672['id'],_0x256388(0x247)),console[_0x256388(0x2ae)]('✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20'+_0x32b672['id']+_0x256388(0x200)),console[_0x256388(0x2ae)](_0x256388(0x202)+(_0x3e522c||_0x256388(0x21c)))):console['log'](_0x256388(0x224)+_0x56df7b+_0x256388(0x29e)),await database_1['default'][_0x256388(0x170)][_0x256388(0x213)]({'data':{'paymentId':_0x32b672['id'],'shopId':_0x32b672['shopId'],'event':_0x256388(0x1a7)+(_0x56df7b?.[_0x256388(0x237)]()||_0x256388(0x24f)),'statusCode':0xc8,'responseBody':JSON[_0x256388(0x21b)](_0x1cdbfc)}}),loggerService_1[_0x256388(0x1db)]['logWebhookProcessed'](_0x256388(0x26f),_0x32b672['id'],_0x32b672[_0x256388(0x1ef)],_0x56df7b==='DECLINED'?_0x256388(0x247):_0x56df7b,_0x1cdbfc);}catch(_0x1ec749){console[_0x256388(0x29c)](_0x256388(0x219),_0x1ec749),loggerService_1[_0x256388(0x1db)][_0x256388(0x1f3)](_0x256388(0x26f),_0x1ec749,_0x1cdbfc);throw _0x1ec749;}}async[a69_0x417b24(0x186)](_0x25e9f9){const _0x31aa37=a69_0x417b24;console[_0x31aa37(0x2ae)](_0x31aa37(0x256),JSON[_0x31aa37(0x21b)](_0x25e9f9,null,0x2));try{const _0x35a6f3=_0x25e9f9['status'],_0x3e9111=_0x25e9f9[_0x31aa37(0x268)],_0x2fdfe1=_0x25e9f9[_0x31aa37(0x283)],_0x1288c1=_0x25e9f9[_0x31aa37(0x223)],_0x539d28=_0x25e9f9[_0x31aa37(0x1a9)],_0x18faae=_0x25e9f9[_0x31aa37(0x1ee)],_0x1a7c28=_0x25e9f9[_0x31aa37(0x17e)],_0x2ad820=_0x25e9f9[_0x31aa37(0x204)];if(!_0x3e9111){console['error']('❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook');throw new Error(_0x31aa37(0x261));}console[_0x31aa37(0x2ae)](_0x31aa37(0x241),{'status':_0x35a6f3,'clientTransactionId':_0x3e9111,'systemId':_0x2fdfe1,'paymentMethod':_0x1288c1,'amount':_0x539d28,'currency':_0x18faae,'commission':_0x1a7c28,'statusAdditionInfo':_0x2ad820});const _0x53bcb5=await database_1[_0x31aa37(0x175)][_0x31aa37(0x1f6)][_0x31aa37(0x286)]({'where':{'OR':[{'gatewayOrderId':_0x3e9111},{'orderId':_0x3e9111},{'id':_0x3e9111},{'gatewayPaymentId':_0x3e9111}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x53bcb5){console[_0x31aa37(0x29c)]('❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20'+_0x3e9111);throw new Error(_0x31aa37(0x294)+_0x3e9111);}console['log']('✅\x20Found\x20payment\x20'+_0x53bcb5['id']+_0x31aa37(0x167)),console[_0x31aa37(0x2ae)](_0x31aa37(0x215)+_0x53bcb5[_0x31aa37(0x1ef)]+_0x31aa37(0x1bc)+_0x35a6f3),_0x35a6f3===_0x31aa37(0x179)?(console[_0x31aa37(0x2ae)]('🔄\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED'),await this[_0x31aa37(0x297)](_0x53bcb5['id'],_0x31aa37(0x247)),console[_0x31aa37(0x2ae)](_0x31aa37(0x184)+_0x53bcb5['id']+_0x31aa37(0x200)),console['log']('ℹ️\x20Decline\x20reason:\x20'+(_0x2ad820||_0x31aa37(0x21c)))):console[_0x31aa37(0x2ae)](_0x31aa37(0x233)+_0x35a6f3+'\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)'),await database_1['default'][_0x31aa37(0x170)][_0x31aa37(0x213)]({'data':{'paymentId':_0x53bcb5['id'],'shopId':_0x53bcb5['shopId'],'event':_0x31aa37(0x22b)+(_0x35a6f3?.[_0x31aa37(0x237)]()||_0x31aa37(0x24f)),'statusCode':0xc8,'responseBody':JSON[_0x31aa37(0x21b)](_0x25e9f9)}}),loggerService_1['loggerService']['logWebhookProcessed'](_0x31aa37(0x1cd),_0x53bcb5['id'],_0x53bcb5['status'],_0x35a6f3==='DECLINED'?_0x31aa37(0x247):_0x35a6f3,_0x25e9f9);}catch(_0x1ab549){console[_0x31aa37(0x29c)](_0x31aa37(0x1cb),_0x1ab549),loggerService_1[_0x31aa37(0x1db)]['logWebhookError'](_0x31aa37(0x1cd),_0x1ab549,_0x25e9f9);throw _0x1ab549;}}async[a69_0x417b24(0x260)](_0x17dfbe,_0x57ce6e){const _0xf21a21=a69_0x417b24,_0x3f4d05=Date['now']();try{const _0xa923ff=_0x17dfbe[_0xf21a21(0x1d3)],_0x24aa03=_0xa923ff[_0xf21a21(0x288)];if(!_0x24aa03?.[_0xf21a21(0x281)]){console[_0xf21a21(0x2ae)](_0xf21a21(0x2ac)+_0xa923ff['id']);return;}const _0x3d20f1=_0x57ce6e==='PAID'?_0xf21a21(0x277):_0x57ce6e===_0xf21a21(0x247)?_0xf21a21(0x177):_0x57ce6e==='EXPIRED'?_0xf21a21(0x177):_0x57ce6e==='CHARGEBACK'?'payment.failed':_0x57ce6e===_0xf21a21(0x169)?_0xf21a21(0x177):'payment.pending';let _0x1aa32e=[];if(_0x24aa03['webhookEvents'])try{_0x1aa32e=Array[_0xf21a21(0x1c8)](_0x24aa03['webhookEvents'])?_0x24aa03['webhookEvents']:JSON['parse'](_0x24aa03[_0xf21a21(0x172)]);}catch(_0x457db2){console[_0xf21a21(0x29c)]('Error\x20parsing\x20webhook\x20events:',_0x457db2),_0x1aa32e=[];}if(!_0x1aa32e[_0xf21a21(0x25c)](_0x3d20f1)){console[_0xf21a21(0x2ae)]('Webhook\x20event\x20'+_0x3d20f1+_0xf21a21(0x266)+_0xa923ff['id']);return;}const _0x1e288e={'event':_0x3d20f1,'payment':{'id':_0x17dfbe['id'],'order_id':_0x17dfbe['orderId'],'gateway_order_id':_0x17dfbe[_0xf21a21(0x17c)],'gateway':_0x17dfbe[_0xf21a21(0x26e)],'amount':_0x17dfbe[_0xf21a21(0x1a9)],'currency':_0x17dfbe[_0xf21a21(0x1ee)],'status':_0x57ce6e[_0xf21a21(0x237)](),'customer_email':_0x17dfbe[_0xf21a21(0x206)],'customer_name':_0x17dfbe[_0xf21a21(0x194)],'failure_message':_0x17dfbe[_0xf21a21(0x1bd)],'tx_urls':_0x17dfbe[_0xf21a21(0x1b4)]?JSON[_0xf21a21(0x1ea)](_0x17dfbe[_0xf21a21(0x1b4)]):null,'created_at':_0x17dfbe['createdAt'],'updated_at':_0x17dfbe[_0xf21a21(0x225)]}},_0x33529c=await fetch(_0x24aa03[_0xf21a21(0x281)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0xf21a21(0x17d)},'body':JSON[_0xf21a21(0x21b)](_0x1e288e)}),_0x374f87=Date[_0xf21a21(0x25f)]()-_0x3f4d05,_0x2caa7a=_0x33529c['ok']?_0xf21a21(0x275):await _0x33529c[_0xf21a21(0x278)]();loggerService_1['loggerService'][_0xf21a21(0x1fc)](_0x17dfbe['shopId'],_0x24aa03[_0xf21a21(0x281)],_0x3d20f1,_0x33529c[_0xf21a21(0x1ef)],_0x374f87,_0x1e288e),console[_0xf21a21(0x2ae)]('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x24aa03['webhookUrl']+_0xf21a21(0x17b)+_0x33529c[_0xf21a21(0x1ef)]+'\x20('+_0x374f87+_0xf21a21(0x207));}catch(_0x3e3879){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x3e3879),loggerService_1[_0xf21a21(0x1db)][_0xf21a21(0x21d)](_0x17dfbe[_0xf21a21(0x276)],_0x17dfbe[_0xf21a21(0x1d3)]?.[_0xf21a21(0x288)]?.[_0xf21a21(0x281)]||_0xf21a21(0x24f),'webhook_send',_0x3e3879,{});}}async[a69_0x417b24(0x1a5)](_0x528178,_0xf7c943){const _0x4b631a=a69_0x417b24;try{const _0x3517ae={'PENDING':_0x4b631a(0x1f9),'PROCESSING':_0x4b631a(0x257),'PAID':_0x4b631a(0x1cc),'FAILED':_0x4b631a(0x185),'EXPIRED':'expired','REFUND':_0x4b631a(0x1cf),'CHARGEBACK':_0x4b631a(0x1e2)},_0x36c18d=_0x3517ae[_0xf7c943];if(!_0x36c18d||_0x36c18d===_0x4b631a(0x1f9))return;await telegramBotService_1['telegramBotService'][_0x4b631a(0x25b)](_0x528178['shopId'],_0x528178,_0x36c18d);}catch(_0x15746e){console[_0x4b631a(0x29c)](_0x4b631a(0x195),_0x15746e);}}async[a69_0x417b24(0x20a)](_0x1b8749,_0x25e564){const _0x1b8e8d=a69_0x417b24;try{const _0x4203c=await database_1[_0x1b8e8d(0x175)][_0x1b8e8d(0x1d3)][_0x1b8e8d(0x168)]({'where':{'id':_0x1b8749},'select':{'gatewaySettings':!![]}});if(!_0x4203c?.[_0x1b8e8d(0x1d4)])return console[_0x1b8e8d(0x2ae)](_0x1b8e8d(0x272)+_0x1b8749+_0x1b8e8d(0x2a9)),0xa;const _0xfaad17=JSON[_0x1b8e8d(0x1ea)](_0x4203c[_0x1b8e8d(0x1d4)]);for(const [_0x15a8b3,_0x551a2b]of Object[_0x1b8e8d(0x1a1)](_0xfaad17)){if(_0x15a8b3[_0x1b8e8d(0x237)]()===_0x25e564[_0x1b8e8d(0x237)]()){const _0x5c4602=_0x551a2b['commission']||0xa;return console[_0x1b8e8d(0x2ae)](_0x1b8e8d(0x198)+_0x25e564+_0x1b8e8d(0x23b)+_0x1b8749+':\x20'+_0x5c4602+'%'),_0x5c4602;}}return console['log']('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0x25e564+_0x1b8e8d(0x285)+_0x1b8749+_0x1b8e8d(0x16c)),0xa;}catch(_0x46175e){return console[_0x1b8e8d(0x29c)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x1b8749+_0x1b8e8d(0x183)+_0x25e564+':',_0x46175e),0xa;}}async[a69_0x417b24(0x1c4)](_0x1831e5,_0x28d97e){const _0x153caa=a69_0x417b24;console[_0x153caa(0x2ae)](_0x153caa(0x1a3)),console[_0x153caa(0x2ae)](_0x153caa(0x1e4),JSON['stringify'](_0x1831e5,null,0x2)),console[_0x153caa(0x2ae)]('Body\x20data:',JSON[_0x153caa(0x21b)](_0x28d97e,null,0x2));try{const _0x57d498=_0x1831e5['customerOrderId']||_0x28d97e[_0x153caa(0x2a1)],_0x1323f7=_0x1831e5['status']||_0x28d97e['status'],_0x2e5775=_0x1831e5[_0x153caa(0x1a9)]||_0x28d97e[_0x153caa(0x1a9)],_0x3912f6=_0x1831e5[_0x153caa(0x1ee)]||_0x28d97e['currency'],_0x17d835=_0x1831e5[_0x153caa(0x180)]||_0x28d97e[_0x153caa(0x180)];if(!_0x57d498){console[_0x153caa(0x29c)](_0x153caa(0x227));throw new Error(_0x153caa(0x1de));}console[_0x153caa(0x2ae)](_0x153caa(0x1df),{'customerOrderId':_0x57d498,'status':_0x1323f7,'amount':_0x2e5775,'currency':_0x3912f6,'dateTime':_0x17d835});const _0x141c37=await database_1['default'][_0x153caa(0x1f6)][_0x153caa(0x286)]({'where':{'OR':[{'gatewayOrderId':_0x57d498},{'orderId':_0x57d498},{'id':_0x57d498},{'gatewayPaymentId':_0x57d498}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x141c37){console[_0x153caa(0x29c)](_0x153caa(0x248)+_0x57d498);throw new Error(_0x153caa(0x294)+_0x57d498);}console[_0x153caa(0x2ae)](_0x153caa(0x28b)+_0x141c37['id']+'\x20for\x20MyXSpend\x20webhook'),console[_0x153caa(0x2ae)]('📊\x20Payment\x20status:\x20'+_0x141c37['status']+_0x153caa(0x1bc)+_0x1323f7);let _0xd4be2=_0x1323f7?.[_0x153caa(0x2a0)]();_0x1323f7===_0x153caa(0x247)||_0x1323f7===_0x153caa(0x2af)?(_0xd4be2=_0x153caa(0x247),console[_0x153caa(0x2ae)]('🔄\x20MyXSpend\x20status\x20'+_0x1323f7+'\x20mapped\x20to\x20FAILED'),await this[_0x153caa(0x297)](_0x141c37['id'],_0xd4be2),console[_0x153caa(0x2ae)](_0x153caa(0x1e0)+_0x141c37['id']+_0x153caa(0x200))):console['log'](_0x153caa(0x18f)+_0x1323f7+_0x153caa(0x1dd)),await database_1[_0x153caa(0x175)]['webhookLog'][_0x153caa(0x213)]({'data':{'paymentId':_0x141c37['id'],'shopId':_0x141c37[_0x153caa(0x276)],'event':_0x153caa(0x2a7)+(_0x1323f7?.[_0x153caa(0x237)]()||_0x153caa(0x24f)),'statusCode':0xc8,'responseBody':JSON[_0x153caa(0x21b)]({'queryParams':_0x1831e5,'bodyData':_0x28d97e})}}),loggerService_1[_0x153caa(0x1db)][_0x153caa(0x26d)]('myxspend',_0x141c37['id'],_0x141c37[_0x153caa(0x1ef)],_0xd4be2||_0x1323f7,{'queryParams':_0x1831e5,'bodyData':_0x28d97e});}catch(_0x5d8ed4){console['error'](_0x153caa(0x25a),_0x5d8ed4),loggerService_1['loggerService']['logWebhookError'](_0x153caa(0x24b),_0x5d8ed4,{'queryParams':_0x1831e5,'bodyData':_0x28d97e});throw _0x5d8ed4;}}}exports[a69_0x417b24(0x212)]=WebhookService;