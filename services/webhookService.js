'use strict';function a57_0x5868(){const _0x5c4197=['amount','webhookEvents','application/json','📊\x20Noda\x20webhook:\x20Payment\x20','default','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','system','115953KzIUpd','amountUSDT','\x20-\x20','💸\x20Additional\x20chargeback\x20penalty:\x20-','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','rapyd','toUpperCase','logWebhookProcessed','\x20->\x20','📊\x20Plisio\x20webhook:\x20Payment\x20','🔄\x20Processing\x20Noda\x20webhook:','📊\x20CoinToPay\x20webhook:\x20Payment\x20','paymentLinkService','sendShopWebhook','./gateways/nodaService','💰\x20Removing\x20from\x20balance:\x20','balance','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','handleSuccessfulPayment','PAID','payment','includes','FAILED','currencyService','plisio','8845963KjnUyU','🔄\x20Processing\x20KLYME\x20webhook:','./gateways/klymeService','\x20USDT','📊\x20KLYME\x20webhook:\x20Payment\x20','expired','plisioService','text','processNodaWebhook','status','./telegramBotService','paymentMethod','additionalInfo','shop','POST','logShopWebhookSent','convertToUSDT','12YBADeb','username','payment.success','99TTMcUQ','8Rfbmnk','updatedAt','__esModule','coinToPayService','error','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','\x20USDT\x20(payment\x20became\x20PAID)','16LlMxed','📈\x20Payment\x20link\x20counter\x20updated\x20for\x20payment\x20','no\x20balance\x20change','log','\x20and\x20-','findFirst','../config/database','🔄\x20Processing\x20Rapyd\x20webhook:','📤\x20Shop\x20webhook\x20sent\x20to\x20','processing','\x20=\x20','plisio_gateway','\x20not\x20found','failureMessage','createdAt','\x20status\x20','paid','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','🔄\x20Updating\x20payment\x20','cointopay','\x20not\x20enabled\x20for\x20shop\x20','Error\x20processing\x20Plisio\x20webhook:','remitterName','processWebhook','cardLast4','300430qoRZdd','\x20balance\x20updated:\x20','update','toISOString','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','./currencyService','WebhookService','\x20status\x20to\x20','created','processKlymeWebhook','webhook_send','create','failed','klyme','processMasterCardWebhook','logWebhookError','payment.pending','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Error\x20processing\x20Rapyd\x20webhook:','__importDefault','unknown','now','shopId','refund','processPlisioWebhook','telegramBotService','$transaction','ms)','noda','🔄\x20Processing\x20MasterCard\x20webhook:','📊\x20Rapyd\x20webhook:\x20Payment\x20','loggerService','EXPIRED','payment_method','txUrls','Failed\x20to\x20send\x20shop\x20webhook:','1309398NssYLq','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','143485vdClIk','webhookUrl','currency','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','customerName','logShopWebhookError','./gateways/mastercardService','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','💰\x20Converting\x20','toFixed','klymeService','Payment\x20','mastercard','Error\x20processing\x20Noda\x20webhook:','bankId','settings','8RBGZZl','CoinToPayService','31564203UGSdKm','📊\x20MasterCard\x20webhook:\x20Payment\x20','sendPaymentStatusNotification','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','💰\x20Payment\x20','remitterIban','\x20with\x20status\x20','rapydService','PaymentLinkService','3429450meJEyr','\x20current\x20balance:\x20','./gateways/coinToPayService','customerEmail','updatePaymentStatus','defineProperty','gateway','sendPaymentNotification','Payment\x20not\x20found\x20for\x20MasterCard\x20webhook:\x20','paymentId','payment.failed','📝\x20Reason:\x20','nodaService','masterCardService','🔄\x20Processing\x20CoinToPay\x20webhook:','CHARGEBACK'];a57_0x5868=function(){return _0x5c4197;};return a57_0x5868();}function a57_0x1cc4(_0x23bd2d,_0x6d04f7){const _0x5868b7=a57_0x5868();return a57_0x1cc4=function(_0x1cc494,_0x3aaff6){_0x1cc494=_0x1cc494-0x1a2;let _0x8c17b6=_0x5868b7[_0x1cc494];return _0x8c17b6;},a57_0x1cc4(_0x23bd2d,_0x6d04f7);}const a57_0x3332b0=a57_0x1cc4;(function(_0xe4c892,_0x14f19e){const _0x4e7970=a57_0x1cc4,_0x5ce801=_0xe4c892();while(!![]){try{const _0x5cdcf0=-parseInt(_0x4e7970(0x244))/0x1*(-parseInt(_0x4e7970(0x204))/0x2)+-parseInt(_0x4e7970(0x1cf))/0x3*(parseInt(_0x4e7970(0x1fd))/0x4)+parseInt(_0x4e7970(0x1b8))/0x5+parseInt(_0x4e7970(0x242))/0x6+-parseInt(_0x4e7970(0x1e8))/0x7*(-parseInt(_0x4e7970(0x1ad))/0x8)+parseInt(_0x4e7970(0x1fc))/0x9*(parseInt(_0x4e7970(0x21e))/0xa)+-parseInt(_0x4e7970(0x1af))/0xb*(parseInt(_0x4e7970(0x1f9))/0xc);if(_0x5cdcf0===_0x14f19e)break;else _0x5ce801['push'](_0x5ce801['shift']());}catch(_0x738c41){_0x5ce801['push'](_0x5ce801['shift']());}}}(a57_0x5868,0xaac12));var __importDefault=this&&this[a57_0x3332b0(0x231)]||function(_0xc59e87){const _0xa452f8=a57_0x3332b0;return _0xc59e87&&_0xc59e87[_0xa452f8(0x1ff)]?_0xc59e87:{'default':_0xc59e87};};Object[a57_0x3332b0(0x1bd)](exports,a57_0x3332b0(0x1ff),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a57_0x3332b0(0x20a))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a57_0x3332b0(0x1dd)),coinToPayService_1=require(a57_0x3332b0(0x1ba)),klymeService_1=require(a57_0x3332b0(0x1ea)),mastercardService_1=require(a57_0x3332b0(0x1a3)),paymentLinkService_1=require('./paymentLinkService'),telegramBotService_1=require(a57_0x3332b0(0x1f2)),currencyService_1=require(a57_0x3332b0(0x223)),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x426a05=a57_0x3332b0;this[_0x426a05(0x1ee)]=new plisioService_1['PlisioService'](),this[_0x426a05(0x1b6)]=new rapydService_1['RapydService'](),this[_0x426a05(0x1c4)]=new nodaService_1['NodaService'](),this[_0x426a05(0x200)]=new coinToPayService_1[(_0x426a05(0x1ae))](),this['klymeService']=new klymeService_1['KlymeService'](),this[_0x426a05(0x1c5)]=new mastercardService_1['MasterCardService'](),this[_0x426a05(0x1db)]=new paymentLinkService_1[(_0x426a05(0x1b7))]();}async['updatePaymentStatus'](_0x3a0869,_0x221456,_0x495bdc){const _0x526d25=a57_0x3332b0;console['log'](_0x526d25(0x217)+_0x3a0869+_0x526d25(0x225)+_0x221456);const _0x12d675=await database_1[_0x526d25(0x1cc)]['payment']['findUnique']({'where':{'id':_0x3a0869},'select':{'status':!![],'paymentLinkId':!![]}});if(!_0x12d675)throw new Error('Payment\x20'+_0x3a0869+'\x20not\x20found');const _0x330958=_0x12d675['status'];await database_1[_0x526d25(0x1cc)][_0x526d25(0x238)](async _0x42ffc5=>{const _0x297550=_0x526d25,_0x86368e=await _0x42ffc5[_0x297550(0x1e3)]['findUnique']({'where':{'id':_0x3a0869},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x86368e)throw new Error(_0x297550(0x1a8)+_0x3a0869+_0x297550(0x210));const _0x37af02=_0x86368e[_0x297550(0x1f1)],_0x430bb3=_0x86368e[_0x297550(0x1f5)];console[_0x297550(0x207)](_0x297550(0x1b3)+_0x3a0869+':\x20'+_0x37af02+'\x20->\x20'+_0x221456),console['log']('🏪\x20Shop\x20'+_0x430bb3['username']+_0x297550(0x1b9)+_0x430bb3[_0x297550(0x1df)]+_0x297550(0x1eb));const _0x57a607={'status':_0x221456[_0x297550(0x1d5)](),'updatedAt':new Date(),'statusChangedBy':_0x297550(0x1ce),'statusChangedAt':new Date()};_0x495bdc?.[_0x297550(0x211)]&&(_0x57a607[_0x297550(0x211)]=_0x495bdc[_0x297550(0x211)]);_0x495bdc?.[_0x297550(0x240)]&&(_0x57a607[_0x297550(0x240)]=JSON['stringify'](_0x495bdc[_0x297550(0x240)]));_0x495bdc?.[_0x297550(0x21d)]&&(_0x57a607[_0x297550(0x21d)]=_0x495bdc[_0x297550(0x21d)]);_0x495bdc?.[_0x297550(0x1f3)]&&(_0x57a607[_0x297550(0x1f3)]=_0x495bdc[_0x297550(0x1f3)]);_0x495bdc?.['bankId']&&(_0x57a607['bankId']=_0x495bdc[_0x297550(0x1ab)]);_0x495bdc?.[_0x297550(0x1b4)]&&(_0x57a607['remitterIban']=_0x495bdc[_0x297550(0x1b4)]);_0x495bdc?.[_0x297550(0x21b)]&&(_0x57a607[_0x297550(0x21b)]=_0x495bdc['remitterName']);let _0x2de012=_0x430bb3[_0x297550(0x1df)],_0x1e68ff='';if(_0x221456[_0x297550(0x1d5)]()==='PAID'&&_0x37af02!==_0x297550(0x1e2)){const _0x2d1f3c=await currencyService_1[_0x297550(0x1e6)][_0x297550(0x1f8)](_0x86368e[_0x297550(0x1c8)],_0x86368e[_0x297550(0x246)]);_0x2de012+=_0x2d1f3c,_0x1e68ff='+'+_0x2d1f3c[_0x297550(0x1a6)](0x6)+_0x297550(0x203),_0x57a607[_0x297550(0x1d0)]=_0x2d1f3c,_0x57a607['paidAt']=new Date(),console['log'](_0x297550(0x1a5)+_0x86368e[_0x297550(0x1c8)]+'\x20'+_0x86368e[_0x297550(0x246)]+'\x20->\x20'+_0x2d1f3c['toFixed'](0x6)+'\x20USDT'),console[_0x297550(0x207)]('💰\x20Adding\x20to\x20balance:\x20'+_0x430bb3['balance']+'\x20+\x20'+_0x2d1f3c['toFixed'](0x6)+_0x297550(0x20e)+_0x2de012[_0x297550(0x1a6)](0x6)+_0x297550(0x1eb));}else{if(_0x37af02===_0x297550(0x1e2)&&_0x221456['toUpperCase']()!==_0x297550(0x1e2)){const _0x33f957=_0x86368e[_0x297550(0x1d0)];_0x33f957&&(_0x2de012-=_0x33f957,_0x1e68ff='-'+_0x33f957[_0x297550(0x1a6)](0x6)+_0x297550(0x222),_0x57a607[_0x297550(0x1d0)]=null,_0x57a607['paidAt']=null,console[_0x297550(0x207)](_0x297550(0x1de)+_0x430bb3[_0x297550(0x1df)]+_0x297550(0x1d1)+_0x33f957['toFixed'](0x6)+_0x297550(0x20e)+_0x2de012[_0x297550(0x1a6)](0x6)+_0x297550(0x1eb)));}}if(_0x221456[_0x297550(0x1d5)]()===_0x297550(0x1c7)){const _0x3b2f44=_0x495bdc?.['chargebackAmount']||0x0;_0x3b2f44>0x0&&(_0x2de012-=_0x3b2f44,_0x1e68ff+=_0x297550(0x208)+_0x3b2f44[_0x297550(0x1a6)](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0x57a607['chargebackAmount']=_0x3b2f44,console[_0x297550(0x207)](_0x297550(0x1d2)+_0x3b2f44['toFixed'](0x6)+_0x297550(0x1eb)),console[_0x297550(0x207)]('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x2de012[_0x297550(0x1a6)](0x6)+_0x297550(0x1eb)));}const _0x3ed7dd=await _0x42ffc5[_0x297550(0x1e3)][_0x297550(0x220)]({'where':{'id':_0x3a0869},'data':_0x57a607});_0x2de012!==_0x430bb3['balance']&&(await _0x42ffc5[_0x297550(0x1f5)]['update']({'where':{'id':_0x430bb3['id']},'data':{'balance':_0x2de012}}),console[_0x297550(0x207)]('✅\x20Shop\x20'+_0x430bb3[_0x297550(0x1fa)]+_0x297550(0x21f)+_0x430bb3['balance']['toFixed'](0x6)+_0x297550(0x1d7)+_0x2de012[_0x297550(0x1a6)](0x6)+_0x297550(0x1eb)),console['log'](_0x297550(0x1c3)+_0x1e68ff)),await _0x42ffc5['webhookLog'][_0x297550(0x229)]({'data':{'paymentId':_0x3a0869,'shopId':_0x430bb3['id'],'event':'webhook_status_change_'+_0x221456['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x37af02,'newStatus':_0x221456[_0x297550(0x1d5)](),'balanceChange':_0x1e68ff||_0x297550(0x206),'oldBalance':_0x430bb3[_0x297550(0x1df)],'newBalance':_0x2de012,'amountUSDT':_0x57a607[_0x297550(0x1d0)],'additionalData':_0x495bdc,'timestamp':new Date()[_0x297550(0x221)]()})}}),await this['sendShopWebhook']({..._0x86368e,..._0x3ed7dd,'shop':_0x430bb3},_0x221456[_0x297550(0x1d5)]()),await this[_0x297550(0x1b1)]({..._0x86368e,..._0x3ed7dd},_0x221456['toUpperCase']());});if(_0x221456[_0x526d25(0x1d5)]()==='PAID'&&_0x330958!=='PAID')try{await this[_0x526d25(0x1db)][_0x526d25(0x1e1)](_0x3a0869),console['log'](_0x526d25(0x205)+_0x3a0869);}catch(_0x36dde3){console[_0x526d25(0x201)](_0x526d25(0x247)+_0x3a0869+':',_0x36dde3);}}async[a57_0x3332b0(0x236)](_0x4e312e){const _0x22cc37=a57_0x3332b0;console[_0x22cc37(0x207)]('🔄\x20Processing\x20Plisio\x20webhook:',_0x4e312e);try{const _0x10f7c1=await this['plisioService']['processWebhook'](_0x4e312e);if(!_0x10f7c1[_0x22cc37(0x1c1)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x2bdb6d=await database_1[_0x22cc37(0x1cc)][_0x22cc37(0x1e3)]['findFirst']({'where':{'gatewayOrderId':_0x10f7c1[_0x22cc37(0x1c1)]}});if(!_0x2bdb6d){console['error'](_0x22cc37(0x1d3)+_0x10f7c1[_0x22cc37(0x1c1)]);return;}console[_0x22cc37(0x207)](_0x22cc37(0x1d8)+_0x2bdb6d['id']+_0x22cc37(0x213)+_0x10f7c1[_0x22cc37(0x1f1)]),await this[_0x22cc37(0x1bc)](_0x2bdb6d['id'],_0x10f7c1[_0x22cc37(0x1f1)],{'txUrls':_0x10f7c1['txUrls']}),loggerService_1[_0x22cc37(0x23d)][_0x22cc37(0x1d6)](_0x22cc37(0x1e7),_0x2bdb6d['id'],_0x2bdb6d[_0x22cc37(0x1f1)],_0x10f7c1[_0x22cc37(0x1f1)],_0x4e312e);}catch(_0x4a9f16){console[_0x22cc37(0x201)](_0x22cc37(0x21a),_0x4a9f16),loggerService_1['loggerService'][_0x22cc37(0x22d)]('plisio',_0x4a9f16,_0x4e312e);throw _0x4a9f16;}}async['processPlisioGatewayWebhook'](_0x4aa482){const _0x57586a=a57_0x3332b0;console[_0x57586a(0x207)]('🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:',_0x4aa482);try{const _0x2ece99=await this[_0x57586a(0x1ee)][_0x57586a(0x21c)](_0x4aa482);if(!_0x2ece99['paymentId'])throw new Error(_0x57586a(0x243));const _0x416214=await database_1[_0x57586a(0x1cc)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x2ece99[_0x57586a(0x1c1)]}});if(!_0x416214){console[_0x57586a(0x201)](_0x57586a(0x1e0)+_0x2ece99[_0x57586a(0x1c1)]);return;}console[_0x57586a(0x207)](_0x57586a(0x202)+_0x416214['id']+_0x57586a(0x213)+_0x2ece99[_0x57586a(0x1f1)]),await this[_0x57586a(0x1bc)](_0x416214['id'],_0x2ece99[_0x57586a(0x1f1)],{'txUrls':_0x2ece99[_0x57586a(0x240)]}),loggerService_1[_0x57586a(0x23d)][_0x57586a(0x1d6)](_0x57586a(0x20f),_0x416214['id'],_0x416214[_0x57586a(0x1f1)],_0x2ece99[_0x57586a(0x1f1)],_0x4aa482);}catch(_0x37680f){console[_0x57586a(0x201)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x37680f),loggerService_1[_0x57586a(0x23d)][_0x57586a(0x22d)](_0x57586a(0x20f),_0x37680f,_0x4aa482);throw _0x37680f;}}async['processRapydWebhook'](_0x50adaa){const _0x395714=a57_0x3332b0;console[_0x395714(0x207)](_0x395714(0x20b),_0x50adaa);try{const _0x3fdc81=await this[_0x395714(0x1b6)][_0x395714(0x21c)](_0x50adaa);if(!_0x3fdc81[_0x395714(0x1c1)])throw new Error('No\x20payment\x20ID\x20in\x20Rapyd\x20webhook');const _0xe95900=await database_1[_0x395714(0x1cc)][_0x395714(0x1e3)][_0x395714(0x209)]({'where':{'gatewayOrderId':_0x3fdc81[_0x395714(0x1c1)]}});if(!_0xe95900){console[_0x395714(0x201)](_0x395714(0x1b2)+_0x3fdc81[_0x395714(0x1c1)]);return;}console[_0x395714(0x207)](_0x395714(0x23c)+_0xe95900['id']+_0x395714(0x213)+_0x3fdc81[_0x395714(0x1f1)]),await this[_0x395714(0x1bc)](_0xe95900['id'],_0x3fdc81[_0x395714(0x1f1)],{'failureMessage':_0x3fdc81[_0x395714(0x211)],'cardLast4':_0x3fdc81[_0x395714(0x1f4)]?.['cardLast4'],'paymentMethod':_0x3fdc81[_0x395714(0x1f4)]?.[_0x395714(0x1f3)]}),loggerService_1[_0x395714(0x23d)]['logWebhookProcessed'](_0x395714(0x1d4),_0xe95900['id'],_0xe95900['status'],_0x3fdc81[_0x395714(0x1f1)],_0x50adaa);}catch(_0x51f2bf){console[_0x395714(0x201)](_0x395714(0x230),_0x51f2bf),loggerService_1[_0x395714(0x23d)][_0x395714(0x22d)](_0x395714(0x1d4),_0x51f2bf,_0x50adaa);throw _0x51f2bf;}}async[a57_0x3332b0(0x1f0)](_0x286058){const _0x329a67=a57_0x3332b0;console[_0x329a67(0x207)](_0x329a67(0x1d9),_0x286058);try{const _0x123384=await this[_0x329a67(0x1c4)][_0x329a67(0x21c)](_0x286058);if(!_0x123384[_0x329a67(0x1c1)])throw new Error('No\x20payment\x20ID\x20in\x20Noda\x20webhook');const _0x2a7b63=await database_1[_0x329a67(0x1cc)][_0x329a67(0x1e3)][_0x329a67(0x209)]({'where':{'gatewayOrderId':_0x123384[_0x329a67(0x1c1)]}});if(!_0x2a7b63){console[_0x329a67(0x201)]('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x123384[_0x329a67(0x1c1)]);return;}console[_0x329a67(0x207)](_0x329a67(0x1cb)+_0x2a7b63['id']+_0x329a67(0x213)+_0x123384[_0x329a67(0x1f1)]),await this[_0x329a67(0x1bc)](_0x2a7b63['id'],_0x123384[_0x329a67(0x1f1)],{'bankId':_0x123384[_0x329a67(0x1f4)]?.['bankId'],'remitterIban':_0x123384[_0x329a67(0x1f4)]?.[_0x329a67(0x1b4)],'remitterName':_0x123384[_0x329a67(0x1f4)]?.[_0x329a67(0x21b)]}),loggerService_1[_0x329a67(0x23d)]['logWebhookProcessed'](_0x329a67(0x23a),_0x2a7b63['id'],_0x2a7b63[_0x329a67(0x1f1)],_0x123384[_0x329a67(0x1f1)],_0x286058);}catch(_0x1980f3){console[_0x329a67(0x201)](_0x329a67(0x1aa),_0x1980f3),loggerService_1[_0x329a67(0x23d)][_0x329a67(0x22d)](_0x329a67(0x23a),_0x1980f3,_0x286058);throw _0x1980f3;}}async['processCoinToPayWebhook'](_0x5e3f1d){const _0x572406=a57_0x3332b0;console['log'](_0x572406(0x1c6),_0x5e3f1d);try{const _0x3f4e9a=await this['coinToPayService'][_0x572406(0x21c)](_0x5e3f1d);if(!_0x3f4e9a[_0x572406(0x1c1)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x2054cb=await database_1[_0x572406(0x1cc)]['payment'][_0x572406(0x209)]({'where':{'gatewayOrderId':_0x3f4e9a[_0x572406(0x1c1)]}});if(!_0x2054cb){console['error'](_0x572406(0x1a4)+_0x3f4e9a['paymentId']);return;}console[_0x572406(0x207)](_0x572406(0x1da)+_0x2054cb['id']+_0x572406(0x213)+_0x3f4e9a[_0x572406(0x1f1)]),await this[_0x572406(0x1bc)](_0x2054cb['id'],_0x3f4e9a[_0x572406(0x1f1)]),loggerService_1[_0x572406(0x23d)][_0x572406(0x1d6)](_0x572406(0x218),_0x2054cb['id'],_0x2054cb[_0x572406(0x1f1)],_0x3f4e9a[_0x572406(0x1f1)],_0x5e3f1d);}catch(_0x94d357){console['error']('Error\x20processing\x20CoinToPay\x20webhook:',_0x94d357),loggerService_1[_0x572406(0x23d)][_0x572406(0x22d)](_0x572406(0x218),_0x94d357,_0x5e3f1d);throw _0x94d357;}}async[a57_0x3332b0(0x227)](_0x30ad3d){const _0x1ba4a7=a57_0x3332b0;console[_0x1ba4a7(0x207)](_0x1ba4a7(0x1e9),_0x30ad3d);try{const _0x38984d=await this[_0x1ba4a7(0x1a7)][_0x1ba4a7(0x21c)](_0x30ad3d);if(!_0x38984d[_0x1ba4a7(0x1c1)])throw new Error(_0x1ba4a7(0x1cd));const _0x358068=await database_1[_0x1ba4a7(0x1cc)][_0x1ba4a7(0x1e3)][_0x1ba4a7(0x209)]({'where':{'gatewayOrderId':_0x38984d['paymentId']}});if(!_0x358068){console[_0x1ba4a7(0x201)](_0x1ba4a7(0x216)+_0x38984d['paymentId']);return;}console[_0x1ba4a7(0x207)](_0x1ba4a7(0x1ec)+_0x358068['id']+_0x1ba4a7(0x213)+_0x38984d[_0x1ba4a7(0x1f1)]),await this['updatePaymentStatus'](_0x358068['id'],_0x38984d['status'],{'paymentMethod':_0x38984d[_0x1ba4a7(0x1f4)]?.[_0x1ba4a7(0x23f)]}),loggerService_1[_0x1ba4a7(0x23d)][_0x1ba4a7(0x1d6)](_0x1ba4a7(0x22b),_0x358068['id'],_0x358068[_0x1ba4a7(0x1f1)],_0x38984d['status'],_0x30ad3d);}catch(_0x50b7bd){console['error']('Error\x20processing\x20KLYME\x20webhook:',_0x50b7bd),loggerService_1['loggerService'][_0x1ba4a7(0x22d)](_0x1ba4a7(0x22b),_0x50b7bd,_0x30ad3d);throw _0x50b7bd;}}async[a57_0x3332b0(0x22c)](_0x404779){const _0x3feb87=a57_0x3332b0;console['log'](_0x3feb87(0x23b),_0x404779);try{const _0x9d3ec2=await this['masterCardService'][_0x3feb87(0x21c)](_0x404779);if(!_0x9d3ec2[_0x3feb87(0x1c1)])throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');const _0x36f9e4=await database_1[_0x3feb87(0x1cc)]['payment'][_0x3feb87(0x209)]({'where':{'gatewayOrderId':_0x9d3ec2[_0x3feb87(0x1c1)]}});if(!_0x36f9e4){console[_0x3feb87(0x201)](_0x3feb87(0x1c0)+_0x9d3ec2[_0x3feb87(0x1c1)]);return;}console[_0x3feb87(0x207)](_0x3feb87(0x1b0)+_0x36f9e4['id']+'\x20status\x20'+_0x9d3ec2['status']),await this[_0x3feb87(0x1bc)](_0x36f9e4['id'],_0x9d3ec2[_0x3feb87(0x1f1)]),loggerService_1[_0x3feb87(0x23d)][_0x3feb87(0x1d6)](_0x3feb87(0x1a9),_0x36f9e4['id'],_0x36f9e4[_0x3feb87(0x1f1)],_0x9d3ec2[_0x3feb87(0x1f1)],_0x404779);}catch(_0x74d8b2){console[_0x3feb87(0x201)]('Error\x20processing\x20MasterCard\x20webhook:',_0x74d8b2),loggerService_1[_0x3feb87(0x23d)]['logWebhookError']('mastercard',_0x74d8b2,_0x404779);throw _0x74d8b2;}}async[a57_0x3332b0(0x1dc)](_0x761f2a,_0x53311a){const _0x13de39=a57_0x3332b0,_0x4a082b=Date[_0x13de39(0x233)]();try{const _0x2038d8=_0x761f2a['shop'],_0x44759f=_0x2038d8[_0x13de39(0x1ac)];if(!_0x44759f?.[_0x13de39(0x245)]){console[_0x13de39(0x207)](_0x13de39(0x22f)+_0x2038d8['id']);return;}const _0x3c9947=_0x53311a===_0x13de39(0x1e2)?_0x13de39(0x1fb):_0x53311a===_0x13de39(0x1e5)?_0x13de39(0x1c2):_0x53311a===_0x13de39(0x23e)?_0x13de39(0x1c2):_0x53311a==='CHARGEBACK'?_0x13de39(0x1c2):_0x53311a==='REFUND'?_0x13de39(0x1c2):_0x13de39(0x22e);let _0x106458=[];if(_0x44759f[_0x13de39(0x1c9)])try{_0x106458=Array['isArray'](_0x44759f[_0x13de39(0x1c9)])?_0x44759f[_0x13de39(0x1c9)]:JSON['parse'](_0x44759f[_0x13de39(0x1c9)]);}catch(_0x190ed7){console[_0x13de39(0x201)]('Error\x20parsing\x20webhook\x20events:',_0x190ed7),_0x106458=[];}if(!_0x106458[_0x13de39(0x1e4)](_0x3c9947)){console[_0x13de39(0x207)]('Webhook\x20event\x20'+_0x3c9947+_0x13de39(0x219)+_0x2038d8['id']);return;}const _0x24192d={'event':_0x3c9947,'payment':{'id':_0x761f2a['id'],'order_id':_0x761f2a['orderId'],'gateway_order_id':_0x761f2a['gatewayOrderId'],'gateway':_0x761f2a[_0x13de39(0x1be)],'amount':_0x761f2a[_0x13de39(0x1c8)],'currency':_0x761f2a[_0x13de39(0x246)],'status':_0x53311a['toLowerCase'](),'customer_email':_0x761f2a[_0x13de39(0x1bb)],'customer_name':_0x761f2a[_0x13de39(0x248)],'failure_message':_0x761f2a[_0x13de39(0x211)],'tx_urls':_0x761f2a[_0x13de39(0x240)]?JSON['parse'](_0x761f2a['txUrls']):null,'created_at':_0x761f2a[_0x13de39(0x212)],'updated_at':_0x761f2a[_0x13de39(0x1fe)]}},_0x59a5ce=await fetch(_0x44759f[_0x13de39(0x245)],{'method':_0x13de39(0x1f6),'headers':{'Content-Type':_0x13de39(0x1ca),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x24192d)}),_0x430ed0=Date[_0x13de39(0x233)]()-_0x4a082b,_0x3ea0fe=_0x59a5ce['ok']?'Success':await _0x59a5ce[_0x13de39(0x1ef)]();loggerService_1[_0x13de39(0x23d)][_0x13de39(0x1f7)](_0x761f2a[_0x13de39(0x234)],_0x44759f[_0x13de39(0x245)],_0x3c9947,_0x59a5ce[_0x13de39(0x1f1)],_0x430ed0,_0x24192d),console[_0x13de39(0x207)](_0x13de39(0x20c)+_0x44759f[_0x13de39(0x245)]+_0x13de39(0x1b5)+_0x59a5ce[_0x13de39(0x1f1)]+'\x20('+_0x430ed0+_0x13de39(0x239));}catch(_0x577bdd){console['error'](_0x13de39(0x241),_0x577bdd),loggerService_1[_0x13de39(0x23d)][_0x13de39(0x1a2)](_0x761f2a[_0x13de39(0x234)],_0x761f2a['shop']?.[_0x13de39(0x1ac)]?.[_0x13de39(0x245)]||_0x13de39(0x232),_0x13de39(0x228),_0x577bdd,{});}}async[a57_0x3332b0(0x1b1)](_0x3de607,_0x5ad2db){const _0x2679de=a57_0x3332b0;try{const _0x5b6b02={'PENDING':_0x2679de(0x226),'PROCESSING':_0x2679de(0x20d),'PAID':_0x2679de(0x214),'FAILED':_0x2679de(0x22a),'EXPIRED':_0x2679de(0x1ed),'REFUND':_0x2679de(0x235),'CHARGEBACK':'chargeback'},_0x3c8732=_0x5b6b02[_0x5ad2db];if(!_0x3c8732||_0x3c8732===_0x2679de(0x226))return;await telegramBotService_1[_0x2679de(0x237)][_0x2679de(0x1bf)](_0x3de607[_0x2679de(0x234)],_0x3de607,_0x3c8732);}catch(_0x560673){console[_0x2679de(0x201)](_0x2679de(0x215),_0x560673);}}}exports[a57_0x3332b0(0x224)]=WebhookService;