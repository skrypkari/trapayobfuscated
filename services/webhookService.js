'use strict';const a69_0x2c076e=a69_0x342c;(function(_0x90015,_0x2ec28e){const _0xb3c2c1=a69_0x342c,_0x2e3016=_0x90015();while(!![]){try{const _0x40bb8d=parseInt(_0xb3c2c1(0x1e0))/0x1+parseInt(_0xb3c2c1(0x238))/0x2*(parseInt(_0xb3c2c1(0x1cb))/0x3)+parseInt(_0xb3c2c1(0x280))/0x4+parseInt(_0xb3c2c1(0x237))/0x5+parseInt(_0xb3c2c1(0x28d))/0x6*(parseInt(_0xb3c2c1(0x1b7))/0x7)+parseInt(_0xb3c2c1(0x192))/0x8*(-parseInt(_0xb3c2c1(0x298))/0x9)+parseInt(_0xb3c2c1(0x232))/0xa*(-parseInt(_0xb3c2c1(0x2a0))/0xb);if(_0x40bb8d===_0x2ec28e)break;else _0x2e3016['push'](_0x2e3016['shift']());}catch(_0x37566d){_0x2e3016['push'](_0x2e3016['shift']());}}}(a69_0x1c0a,0x7f2a2));var __importDefault=this&&this[a69_0x2c076e(0x20e)]||function(_0x2af93e){const _0x24e35e=a69_0x2c076e;return _0x2af93e&&_0x2af93e[_0x24e35e(0x243)]?_0x2af93e:{'default':_0x2af93e};};Object['defineProperty'](exports,a69_0x2c076e(0x243),{'value':!![]}),exports[a69_0x2c076e(0x1f4)]=void 0x0;const database_1=__importDefault(require(a69_0x2c076e(0x203))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a69_0x2c076e(0x171)),nodaService_1=require(a69_0x2c076e(0x285)),coinToPayService_1=require(a69_0x2c076e(0x1d4)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require(a69_0x2c076e(0x170)),mastercardService_1=require(a69_0x2c076e(0x1a7)),amerService_1=require(a69_0x2c076e(0x1ba)),ampayService_1=require(a69_0x2c076e(0x1ca)),ampayTRYService_1=require(a69_0x2c076e(0x29d)),telegramBotService_1=require(a69_0x2c076e(0x1a6)),currencyService_1=require(a69_0x2c076e(0x1cf)),loggerService_1=require(a69_0x2c076e(0x1a3));class WebhookService{constructor(){const _0x3d1d66=a69_0x2c076e;this[_0x3d1d66(0x167)]=new plisioService_1[(_0x3d1d66(0x16a))](),this[_0x3d1d66(0x1c0)]=new rapydService_1['RapydService'](),this[_0x3d1d66(0x1aa)]=new nodaService_1['NodaService'](),this[_0x3d1d66(0x162)]=new coinToPayService_1[(_0x3d1d66(0x265))](),this[_0x3d1d66(0x1c5)]=new coinToPay2Service_1[(_0x3d1d66(0x23d))](),this[_0x3d1d66(0x1e9)]=new klymeService_1[(_0x3d1d66(0x1f6))](),this['visaMasterCardService']=new mastercardService_1[(_0x3d1d66(0x289))](),this[_0x3d1d66(0x18e)]=new amerService_1['AmerService'](),this[_0x3d1d66(0x1ef)]=new ampayService_1['AmPayService'](),this['ampayTRYService']=new ampayTRYService_1[(_0x3d1d66(0x1f8))]();}async['updatePaymentStatus'](_0x189fe0,_0xc69280,_0x5858cd){const _0x1b9b99=a69_0x2c076e;console[_0x1b9b99(0x29c)](_0x1b9b99(0x206)+_0x189fe0+_0x1b9b99(0x1d5)+_0xc69280),console['log'](_0x1b9b99(0x29e),_0x5858cd),await database_1[_0x1b9b99(0x1fd)][_0x1b9b99(0x16b)](async _0x13c9bc=>{const _0xba1def=_0x1b9b99,_0x3d973c=await _0x13c9bc[_0xba1def(0x1ed)][_0xba1def(0x15f)]({'where':{'id':_0x189fe0},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3d973c)throw new Error(_0xba1def(0x283)+_0x189fe0+_0xba1def(0x22c));const _0x347ca3=_0x3d973c[_0xba1def(0x20d)],_0x9d203b=_0x3d973c[_0xba1def(0x294)];console[_0xba1def(0x29c)]('💰\x20Payment\x20'+_0x189fe0+':\x20'+_0x347ca3+_0xba1def(0x15c)+_0xc69280),console['log'](_0xba1def(0x164)+_0x9d203b[_0xba1def(0x212)]+_0xba1def(0x260)+_0x9d203b[_0xba1def(0x16f)]+_0xba1def(0x27c));const _0x152257={'status':_0xc69280['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x5858cd?.[_0xba1def(0x26b)]&&(_0x152257[_0xba1def(0x26b)]=_0x5858cd['failureMessage']);_0x5858cd?.[_0xba1def(0x19a)]&&(_0x152257[_0xba1def(0x19a)]=JSON['stringify'](_0x5858cd[_0xba1def(0x19a)]));_0x5858cd?.[_0xba1def(0x166)]&&(_0x152257['cardLast4']=_0x5858cd[_0xba1def(0x166)]);_0x5858cd?.[_0xba1def(0x21e)]&&(_0x152257[_0xba1def(0x21e)]=_0x5858cd[_0xba1def(0x21e)]);_0x5858cd?.[_0xba1def(0x255)]&&(_0x152257[_0xba1def(0x255)]=_0x5858cd[_0xba1def(0x255)]);_0x5858cd?.[_0xba1def(0x257)]&&(_0x152257[_0xba1def(0x257)]=_0x5858cd[_0xba1def(0x257)]);_0x5858cd?.['remitterName']&&(_0x152257[_0xba1def(0x262)]=_0x5858cd['remitterName']);let _0x4b8816=_0x9d203b[_0xba1def(0x16f)],_0x147d73='';if(_0xc69280[_0xba1def(0x163)]()===_0xba1def(0x25c)&&_0x347ca3!==_0xba1def(0x25c)){const _0x28a937=await currencyService_1['currencyService'][_0xba1def(0x1f1)](_0x3d973c[_0xba1def(0x239)],_0x3d973c[_0xba1def(0x297)]),_0x3d611a=await this[_0xba1def(0x18d)](_0x9d203b['id'],_0x3d973c[_0xba1def(0x1b5)]),_0x5cf189=_0x28a937*(0x1-_0x3d611a/0x64);_0x4b8816+=_0x5cf189,_0x147d73='+'+_0x5cf189['toFixed'](0x6)+_0xba1def(0x1fc)+_0x3d611a+_0xba1def(0x236),_0x152257['amountUSDT']=_0x28a937,_0x152257['amountAfterGatewayCommissionUSDT']=_0x5cf189,_0x152257[_0xba1def(0x1a9)]=_0x3d611a,_0x152257['paidAt']=new Date(),console[_0xba1def(0x29c)](_0xba1def(0x1e2)+_0x3d973c['amount']+'\x20'+_0x3d973c[_0xba1def(0x297)]+'\x20->\x20'+_0x28a937[_0xba1def(0x214)](0x6)+_0xba1def(0x27c)),console[_0xba1def(0x29c)]('💰\x20Gateway\x20'+_0x3d973c[_0xba1def(0x1b5)]+_0xba1def(0x291)+_0x3d611a+'%'),console['log'](_0xba1def(0x20c)+_0x5cf189['toFixed'](0x6)+'\x20USDT'),console['log'](_0xba1def(0x29b)+_0x9d203b[_0xba1def(0x16f)]+_0xba1def(0x274)+_0x5cf189[_0xba1def(0x214)](0x6)+'\x20=\x20'+_0x4b8816[_0xba1def(0x214)](0x6)+_0xba1def(0x27c));}else{if(_0x347ca3===_0xba1def(0x25c)&&_0xc69280['toUpperCase']()!=='PAID'&&_0xc69280[_0xba1def(0x163)]()!==_0xba1def(0x295)){let _0x382239;if(_0x3d973c[_0xba1def(0x177)])_0x382239=_0x3d973c[_0xba1def(0x177)];else{if(_0x3d973c[_0xba1def(0x201)]){const _0x406a90=await this[_0xba1def(0x18d)](_0x9d203b['id'],_0x3d973c[_0xba1def(0x1b5)]);_0x382239=_0x3d973c[_0xba1def(0x201)]*(0x1-_0x406a90/0x64);}else console['log'](_0xba1def(0x28f)),_0x382239=0x0;}_0x382239>0x0&&(_0x4b8816-=_0x382239,_0x147d73='-'+_0x382239['toFixed'](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x152257[_0xba1def(0x284)]=null,console[_0xba1def(0x29c)](_0xba1def(0x263)+_0x9d203b['balance']+_0xba1def(0x159)+_0x382239[_0xba1def(0x214)](0x6)+_0xba1def(0x24d)+_0x4b8816[_0xba1def(0x214)](0x6)+_0xba1def(0x27c)));}}if(_0xc69280[_0xba1def(0x163)]()===_0xba1def(0x295)){const _0x24d159=_0x5858cd?.[_0xba1def(0x15d)]||0x0;console[_0xba1def(0x29c)](_0xba1def(0x18f)),_0x24d159>0x0?(_0x4b8816-=_0x24d159,_0x147d73='-'+_0x24d159['toFixed'](0x6)+_0xba1def(0x213),_0x152257[_0xba1def(0x15d)]=_0x24d159,console[_0xba1def(0x29c)]('💸\x20CHARGEBACK\x20penalty\x20ONLY:\x20-'+_0x24d159[_0xba1def(0x214)](0x6)+_0xba1def(0x27c)),console[_0xba1def(0x29c)](_0xba1def(0x16d)),console[_0xba1def(0x29c)](_0xba1def(0x1b0)+_0x4b8816[_0xba1def(0x214)](0x6)+_0xba1def(0x27c))):(console[_0xba1def(0x29c)]('⚠️\x20CHARGEBACK\x20without\x20penalty\x20amount\x20-\x20no\x20balance\x20change'),_0x147d73='Payment\x20marked\x20as\x20CHARGEBACK\x20(no\x20penalty\x20specified)');}const _0x5809df=await _0x13c9bc[_0xba1def(0x1ed)][_0xba1def(0x292)]({'where':{'id':_0x189fe0},'data':_0x152257});_0x4b8816!==_0x9d203b[_0xba1def(0x16f)]&&(await _0x13c9bc[_0xba1def(0x294)]['update']({'where':{'id':_0x9d203b['id']},'data':{'balance':_0x4b8816}}),console['log']('✅\x20Shop\x20'+_0x9d203b[_0xba1def(0x212)]+_0xba1def(0x23f)+_0x9d203b[_0xba1def(0x16f)][_0xba1def(0x214)](0x6)+'\x20->\x20'+_0x4b8816[_0xba1def(0x214)](0x6)+_0xba1def(0x27c)),console[_0xba1def(0x29c)](_0xba1def(0x19c)+_0x147d73));await _0x13c9bc['webhookLog'][_0xba1def(0x1d0)]({'data':{'paymentId':_0x189fe0,'shopId':_0x9d203b['id'],'event':'webhook_status_change_'+_0xc69280['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x347ca3,'newStatus':_0xc69280[_0xba1def(0x163)](),'balanceChange':_0x147d73||_0xba1def(0x176),'oldBalance':_0x9d203b[_0xba1def(0x16f)],'newBalance':_0x4b8816,'amountUSDT':_0x152257[_0xba1def(0x201)],'additionalData':_0x5858cd,'timestamp':new Date()[_0xba1def(0x1b3)]()})}}),await this[_0xba1def(0x1ec)]({..._0x3d973c,..._0x5809df,'shop':_0x9d203b},_0xc69280[_0xba1def(0x163)]()),await this['sendPaymentStatusNotification']({..._0x3d973c,..._0x5809df},_0xc69280[_0xba1def(0x163)]());if(_0x347ca3!==_0xba1def(0x25c)&&_0xc69280[_0xba1def(0x163)]()==='PAID'){console['log'](_0xba1def(0x228)+_0x189fe0+_0xba1def(0x259)),console['log'](_0xba1def(0x1b2)+_0x347ca3+_0xba1def(0x1b1)+_0xc69280[_0xba1def(0x163)]()+_0xba1def(0x15b)+_0x3d973c[_0xba1def(0x1e7)]+'\x22');if(_0x3d973c[_0xba1def(0x1e7)])try{const _0x4fe403=await _0x13c9bc[_0xba1def(0x220)]['findUnique']({'where':{'id':_0x3d973c['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4fe403){console[_0xba1def(0x29c)]('📈\x20Found\x20payment\x20link\x20'+_0x4fe403['id']+_0xba1def(0x191)+_0x4fe403[_0xba1def(0x209)]+_0xba1def(0x248)+_0x4fe403[_0xba1def(0x279)]+',\x20status='+_0x4fe403[_0xba1def(0x20d)]);const _0x3509d5=_0x4fe403[_0xba1def(0x279)]+0x1,_0x395a47=_0x4fe403[_0xba1def(0x209)]===_0xba1def(0x17e)?_0xba1def(0x293):_0x4fe403['status'];await _0x13c9bc['paymentLink']['update']({'where':{'id':_0x3d973c[_0xba1def(0x1e7)]},'data':{'currentPayments':_0x3509d5,'status':_0x395a47,'updatedAt':new Date()}}),console[_0xba1def(0x29c)](_0xba1def(0x18c)+_0x4fe403['id']+_0xba1def(0x249)+_0x4fe403[_0xba1def(0x279)]+_0xba1def(0x15c)+_0x3509d5+_0xba1def(0x275)+_0x4fe403[_0xba1def(0x20d)]+_0xba1def(0x15c)+_0x395a47);}else console[_0xba1def(0x29c)](_0xba1def(0x1f5)+_0x3d973c[_0xba1def(0x1e7)]+_0xba1def(0x22c));}catch(_0x36a8ad){console[_0xba1def(0x181)](_0xba1def(0x251),_0x36a8ad);}else console[_0xba1def(0x29c)](_0xba1def(0x228)+_0x189fe0+_0xba1def(0x15e));}else console[_0xba1def(0x29c)]('📈\x20Payment\x20'+_0x189fe0+_0xba1def(0x175)+_0x347ca3+_0xba1def(0x15c)+_0xc69280['toUpperCase']());});}async[a69_0x2c076e(0x1da)](_0x49a9c5){const _0x15cd5c=a69_0x2c076e;console['log'](_0x15cd5c(0x244),_0x49a9c5);try{const _0x375803=await this[_0x15cd5c(0x167)][_0x15cd5c(0x199)](_0x49a9c5);if(!_0x375803[_0x15cd5c(0x1e6)])throw new Error(_0x15cd5c(0x202));const _0xea3736=await database_1[_0x15cd5c(0x1fd)][_0x15cd5c(0x1ed)]['findFirst']({'where':{'gatewayOrderId':_0x375803[_0x15cd5c(0x1e6)]}});if(!_0xea3736){console['error'](_0x15cd5c(0x1fe)+_0x375803[_0x15cd5c(0x1e6)]);return;}console[_0x15cd5c(0x29c)](_0x15cd5c(0x247)+_0xea3736['id']+_0x15cd5c(0x224)+_0x375803[_0x15cd5c(0x20d)]),await this[_0x15cd5c(0x24e)](_0xea3736['id'],_0x375803[_0x15cd5c(0x20d)],{'txUrls':_0x375803[_0x15cd5c(0x19a)]}),loggerService_1[_0x15cd5c(0x241)][_0x15cd5c(0x1be)](_0x15cd5c(0x286),_0xea3736['id'],_0xea3736[_0x15cd5c(0x20d)],_0x375803[_0x15cd5c(0x20d)],_0x49a9c5);}catch(_0x52c31a){console[_0x15cd5c(0x181)](_0x15cd5c(0x1d1),_0x52c31a),loggerService_1[_0x15cd5c(0x241)][_0x15cd5c(0x174)](_0x15cd5c(0x286),_0x52c31a,_0x49a9c5);throw _0x52c31a;}}async['processPlisioGatewayWebhook'](_0x1c5e30){const _0x504d07=a69_0x2c076e;console['log'](_0x504d07(0x258),_0x1c5e30);try{const _0x14f556=await this[_0x504d07(0x167)][_0x504d07(0x199)](_0x1c5e30);if(!_0x14f556[_0x504d07(0x1e6)])throw new Error(_0x504d07(0x25a));const _0x15fb7a=await database_1[_0x504d07(0x1fd)][_0x504d07(0x1ed)][_0x504d07(0x218)]({'where':{'gatewayOrderId':_0x14f556['paymentId']}});if(!_0x15fb7a){console[_0x504d07(0x181)](_0x504d07(0x1fa)+_0x14f556[_0x504d07(0x1e6)]);return;}console[_0x504d07(0x29c)](_0x504d07(0x1c8)+_0x15fb7a['id']+_0x504d07(0x224)+_0x14f556[_0x504d07(0x20d)]),await this['updatePaymentStatus'](_0x15fb7a['id'],_0x14f556[_0x504d07(0x20d)],{'txUrls':_0x14f556[_0x504d07(0x19a)]}),loggerService_1[_0x504d07(0x241)]['logWebhookProcessed']('plisio_gateway',_0x15fb7a['id'],_0x15fb7a[_0x504d07(0x20d)],_0x14f556[_0x504d07(0x20d)],_0x1c5e30);}catch(_0x567af8){console[_0x504d07(0x181)](_0x504d07(0x24a),_0x567af8),loggerService_1[_0x504d07(0x241)][_0x504d07(0x174)](_0x504d07(0x1c2),_0x567af8,_0x1c5e30);throw _0x567af8;}}async[a69_0x2c076e(0x1e1)](_0x1e89f4){const _0xf01b79=a69_0x2c076e;console[_0xf01b79(0x29c)](_0xf01b79(0x23b),_0x1e89f4);try{const _0x4746cc=await this[_0xf01b79(0x1c0)]['processWebhook'](_0x1e89f4);if(!_0x4746cc[_0xf01b79(0x1e6)])throw new Error('No\x20payment\x20ID\x20in\x20Rapyd\x20webhook');const _0x17555c=await database_1['default']['payment'][_0xf01b79(0x218)]({'where':{'gatewayOrderId':_0x4746cc[_0xf01b79(0x1e6)]}});if(!_0x17555c){console[_0xf01b79(0x181)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x4746cc[_0xf01b79(0x1e6)]);return;}console[_0xf01b79(0x29c)](_0xf01b79(0x1df)+_0x17555c['id']+'\x20status\x20'+_0x4746cc[_0xf01b79(0x20d)]),await this[_0xf01b79(0x24e)](_0x17555c['id'],_0x4746cc[_0xf01b79(0x20d)],{'failureMessage':_0x4746cc[_0xf01b79(0x26b)],'cardLast4':_0x4746cc[_0xf01b79(0x23e)]?.[_0xf01b79(0x166)],'paymentMethod':_0x4746cc[_0xf01b79(0x23e)]?.[_0xf01b79(0x21e)]}),loggerService_1['loggerService'][_0xf01b79(0x1be)](_0xf01b79(0x28e),_0x17555c['id'],_0x17555c['status'],_0x4746cc[_0xf01b79(0x20d)],_0x1e89f4);}catch(_0xf02b10){console[_0xf01b79(0x181)](_0xf01b79(0x165),_0xf02b10),loggerService_1['loggerService'][_0xf01b79(0x174)](_0xf01b79(0x28e),_0xf02b10,_0x1e89f4);throw _0xf02b10;}}async['processNodaWebhook'](_0x48ee2f){const _0x3630e0=a69_0x2c076e;console[_0x3630e0(0x29c)](_0x3630e0(0x1d8),_0x48ee2f);try{const _0x169632=await this[_0x3630e0(0x1aa)][_0x3630e0(0x199)](_0x48ee2f);if(!_0x169632['paymentId'])throw new Error(_0x3630e0(0x235));const _0x277741=await database_1[_0x3630e0(0x1fd)]['payment'][_0x3630e0(0x218)]({'where':{'gatewayOrderId':_0x169632[_0x3630e0(0x1e6)]}});if(!_0x277741){console['error']('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x169632[_0x3630e0(0x1e6)]);return;}console[_0x3630e0(0x29c)]('📊\x20Noda\x20webhook:\x20Payment\x20'+_0x277741['id']+_0x3630e0(0x224)+_0x169632[_0x3630e0(0x20d)]),await this[_0x3630e0(0x24e)](_0x277741['id'],_0x169632[_0x3630e0(0x20d)],{'bankId':_0x169632[_0x3630e0(0x23e)]?.[_0x3630e0(0x255)],'remitterIban':_0x169632['additionalInfo']?.[_0x3630e0(0x257)],'remitterName':_0x169632[_0x3630e0(0x23e)]?.['remitterName']}),loggerService_1[_0x3630e0(0x241)][_0x3630e0(0x1be)](_0x3630e0(0x15a),_0x277741['id'],_0x277741[_0x3630e0(0x20d)],_0x169632[_0x3630e0(0x20d)],_0x48ee2f);}catch(_0x4ed23f){console[_0x3630e0(0x181)](_0x3630e0(0x184),_0x4ed23f),loggerService_1[_0x3630e0(0x241)]['logWebhookError'](_0x3630e0(0x15a),_0x4ed23f,_0x48ee2f);throw _0x4ed23f;}}async[a69_0x2c076e(0x17b)](_0xc42535){const _0x124a1a=a69_0x2c076e;console[_0x124a1a(0x29c)](_0x124a1a(0x22d),_0xc42535);try{const _0x42de19=await this[_0x124a1a(0x162)][_0x124a1a(0x199)](_0xc42535);if(!_0x42de19[_0x124a1a(0x1e6)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x29ec91=await database_1[_0x124a1a(0x1fd)][_0x124a1a(0x1ed)][_0x124a1a(0x218)]({'where':{'gatewayOrderId':_0x42de19['paymentId']}});if(!_0x29ec91){console['error']('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x42de19['paymentId']);return;}console['log'](_0x124a1a(0x1dc)+_0x29ec91['id']+_0x124a1a(0x224)+_0x42de19[_0x124a1a(0x20d)]),await this[_0x124a1a(0x24e)](_0x29ec91['id'],_0x42de19['status']),loggerService_1[_0x124a1a(0x241)][_0x124a1a(0x1be)](_0x124a1a(0x28c),_0x29ec91['id'],_0x29ec91['status'],_0x42de19[_0x124a1a(0x20d)],_0xc42535);}catch(_0x31b644){console['error'](_0x124a1a(0x1fb),_0x31b644),loggerService_1[_0x124a1a(0x241)]['logWebhookError'](_0x124a1a(0x28c),_0x31b644,_0xc42535);throw _0x31b644;}}async[a69_0x2c076e(0x1f3)](_0x10e57d){const _0xa54a07=a69_0x2c076e;console[_0xa54a07(0x29c)](_0xa54a07(0x234),_0x10e57d);try{const _0x4cecaa=await this['coinToPay2Service'][_0xa54a07(0x199)](_0x10e57d);if(!_0x4cecaa['paymentId'])throw new Error(_0xa54a07(0x26e));const _0x168a32=await database_1[_0xa54a07(0x1fd)][_0xa54a07(0x1ed)][_0xa54a07(0x218)]({'where':{'gatewayOrderId':_0x4cecaa[_0xa54a07(0x1e6)]}});if(!_0x168a32){console['error'](_0xa54a07(0x227)+_0x4cecaa[_0xa54a07(0x1e6)]);return;}console[_0xa54a07(0x29c)](_0xa54a07(0x25b)+_0x168a32['id']+'\x20status\x20'+_0x4cecaa[_0xa54a07(0x20d)]),await this['updatePaymentStatus'](_0x168a32['id'],_0x4cecaa[_0xa54a07(0x20d)]),loggerService_1[_0xa54a07(0x241)]['logWebhookProcessed']('cointopay2',_0x168a32['id'],_0x168a32[_0xa54a07(0x20d)],_0x4cecaa[_0xa54a07(0x20d)],_0x10e57d);}catch(_0x5076d1){console[_0xa54a07(0x181)]('Error\x20processing\x20CoinToPay2\x20webhook:',_0x5076d1),loggerService_1[_0xa54a07(0x241)][_0xa54a07(0x174)](_0xa54a07(0x194),_0x5076d1,_0x10e57d);throw _0x5076d1;}}async[a69_0x2c076e(0x28b)](_0x3065ab){const _0xbb6dd6=a69_0x2c076e;console[_0xbb6dd6(0x29c)](_0xbb6dd6(0x266),_0x3065ab);try{const _0x4cef63=await this['klymeService'][_0xbb6dd6(0x199)](_0x3065ab);if(!_0x4cef63[_0xbb6dd6(0x1e6)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x2d59a6=await database_1[_0xbb6dd6(0x1fd)][_0xbb6dd6(0x1ed)][_0xbb6dd6(0x218)]({'where':{'gatewayOrderId':_0x4cef63[_0xbb6dd6(0x1e6)]}});if(!_0x2d59a6){console['error']('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x4cef63[_0xbb6dd6(0x1e6)]);return;}console[_0xbb6dd6(0x29c)](_0xbb6dd6(0x1b9)+_0x2d59a6['id']+_0xbb6dd6(0x224)+_0x4cef63['status']),await this[_0xbb6dd6(0x24e)](_0x2d59a6['id'],_0x4cef63['status'],{'paymentMethod':_0x4cef63[_0xbb6dd6(0x23e)]?.[_0xbb6dd6(0x278)]}),loggerService_1['loggerService'][_0xbb6dd6(0x1be)](_0xbb6dd6(0x26a),_0x2d59a6['id'],_0x2d59a6['status'],_0x4cef63['status'],_0x3065ab);}catch(_0x3f7ff0){console['error'](_0xbb6dd6(0x21a),_0x3f7ff0),loggerService_1[_0xbb6dd6(0x241)]['logWebhookError'](_0xbb6dd6(0x26a),_0x3f7ff0,_0x3065ab);throw _0x3f7ff0;}}async[a69_0x2c076e(0x1db)](_0x42e0e2){const _0x4170c4=a69_0x2c076e;console[_0x4170c4(0x29c)](_0x4170c4(0x1ab),JSON['stringify'](_0x42e0e2,null,0x2));try{const _0xf6cf5f=await this[_0x4170c4(0x1ee)][_0x4170c4(0x199)](_0x42e0e2,_0x4170c4(0x1a4));console['log'](_0x4170c4(0x216),_0xf6cf5f);if(!_0xf6cf5f[_0x4170c4(0x1e6)]){console[_0x4170c4(0x181)](_0x4170c4(0x1de)),console[_0x4170c4(0x181)](_0x4170c4(0x296),Object['keys'](_0x42e0e2));throw new Error(_0x4170c4(0x1bb));}let _0x422ec9=null;console[_0x4170c4(0x29c)](_0x4170c4(0x1b6)+_0xf6cf5f[_0x4170c4(0x1e6)]);if(_0xf6cf5f[_0x4170c4(0x1e6)]){console[_0x4170c4(0x29c)]('🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...'),console['log'](_0x4170c4(0x156)),console[_0x4170c4(0x29c)]('\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard'),console['log']('\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20'+_0xf6cf5f[_0x4170c4(0x1e6)]),console[_0x4170c4(0x29c)](_0x4170c4(0x1a8)),_0x422ec9=await database_1['default'][_0x4170c4(0x1ed)][_0x4170c4(0x218)]({'where':{'AND':[{'OR':[{'gateway':'visa/mastercard'},{'gateway':'mastercard'}]},{'OR':[{'gatewayPaymentId':_0xf6cf5f[_0x4170c4(0x1e6)]},{'gatewayOrderId':_0xf6cf5f[_0x4170c4(0x1e6)]},{'id':_0xf6cf5f[_0x4170c4(0x1e6)]},{'orderId':_0xf6cf5f[_0x4170c4(0x1e6)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console['log'](_0x4170c4(0x19b));if(_0x422ec9)console[_0x4170c4(0x29c)](_0x4170c4(0x26f)+_0x422ec9['id']+_0x4170c4(0x154)+_0x422ec9['gatewayOrderId']+',\x20GatewayPaymentId='+_0x422ec9[_0x4170c4(0x277)]);else{console[_0x4170c4(0x29c)](_0x4170c4(0x1d6));const _0x25f70f=await database_1['default']['payment'][_0x4170c4(0x23c)]({'where':{'gateway':'visa/mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x4170c4(0x1ea)}});console[_0x4170c4(0x29c)](_0x4170c4(0x1d3),_0x25f70f[_0x4170c4(0x1c1)](_0x21fa03=>_0x21fa03['id']+_0x4170c4(0x225)+_0x21fa03[_0x4170c4(0x281)]+_0x4170c4(0x1e4)+_0x21fa03[_0x4170c4(0x1d9)]+',\x20gatewayPaymentId:\x20'+_0x21fa03[_0x4170c4(0x277)]+_0x4170c4(0x25e)+_0x21fa03['cardLast4']+')'));}console[_0x4170c4(0x29c)](_0x4170c4(0x193)+(_0x422ec9?_0x4170c4(0x183):_0x4170c4(0x1c4))),_0x422ec9&&console[_0x4170c4(0x29c)](_0x4170c4(0x20f)+_0x422ec9['id']+_0x4170c4(0x29f)+_0x422ec9[_0x4170c4(0x1b5)]+',\x20Status='+_0x422ec9[_0x4170c4(0x20d)]+_0x4170c4(0x1ae)+_0x422ec9[_0x4170c4(0x166)]);}if(!_0x422ec9){console[_0x4170c4(0x181)]('❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20'+_0xf6cf5f[_0x4170c4(0x1e6)]),loggerService_1[_0x4170c4(0x241)][_0x4170c4(0x174)](_0x4170c4(0x223),new Error(_0x4170c4(0x1cc)+_0xf6cf5f['paymentId']),_0x42e0e2);throw new Error(_0x4170c4(0x282)+_0xf6cf5f[_0x4170c4(0x1e6)]);}console[_0x4170c4(0x29c)](_0x4170c4(0x231)+_0x422ec9['id']+_0x4170c4(0x210)+_0x422ec9[_0x4170c4(0x20d)]+_0x4170c4(0x17c)+_0xf6cf5f[_0x4170c4(0x20d)]+')');const _0x28b28f={};_0xf6cf5f['amount']&&await database_1['default'][_0x4170c4(0x1ed)][_0x4170c4(0x292)]({'where':{'id':_0x422ec9['id']},'data':{'amount':_0xf6cf5f[_0x4170c4(0x239)],'updatedAt':new Date()}}),_0xf6cf5f[_0x4170c4(0x297)]&&await database_1[_0x4170c4(0x1fd)]['payment'][_0x4170c4(0x292)]({'where':{'id':_0x422ec9['id']},'data':{'currency':_0xf6cf5f[_0x4170c4(0x297)],'updatedAt':new Date()}}),_0xf6cf5f['status']===_0x4170c4(0x245)&&_0xf6cf5f[_0x4170c4(0x1c9)]&&(_0x28b28f[_0x4170c4(0x26b)]=_0xf6cf5f[_0x4170c4(0x1c9)],console['log'](_0x4170c4(0x19e)+_0xf6cf5f[_0x4170c4(0x1c9)])),_0x28b28f[_0x4170c4(0x21e)]='visa',await this[_0x4170c4(0x24e)](_0x422ec9['id'],_0xf6cf5f[_0x4170c4(0x20d)],_0x28b28f),await database_1[_0x4170c4(0x1fd)][_0x4170c4(0x196)][_0x4170c4(0x1d0)]({'data':{'paymentId':_0x422ec9['id'],'shopId':_0x422ec9[_0x4170c4(0x197)],'event':'visa_'+_0xf6cf5f[_0x4170c4(0x20d)][_0x4170c4(0x1a1)](),'statusCode':0xc8,'responseBody':JSON[_0x4170c4(0x182)](_0xf6cf5f)}}),await this[_0x4170c4(0x173)](_0x422ec9,_0xf6cf5f[_0x4170c4(0x20d)][_0x4170c4(0x163)]()),console[_0x4170c4(0x29c)](_0x4170c4(0x186)+_0x422ec9['id']);}catch(_0x2814d6){console[_0x4170c4(0x181)](_0x4170c4(0x23a),_0x2814d6),loggerService_1['loggerService'][_0x4170c4(0x174)]('visa',_0x2814d6,_0x42e0e2);throw _0x2814d6;}}async['processMasterCardWebhook'](_0x1275f6){const _0x758b51=a69_0x2c076e;console['log'](_0x758b51(0x161),JSON[_0x758b51(0x182)](_0x1275f6,null,0x2));try{const _0x4f1733=await this[_0x758b51(0x1ee)][_0x758b51(0x199)](_0x1275f6,_0x758b51(0x26c));console[_0x758b51(0x29c)](_0x758b51(0x1ad),_0x4f1733);if(!_0x4f1733[_0x758b51(0x1e6)]){console[_0x758b51(0x181)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data'),console[_0x758b51(0x181)]('❌\x20Available\x20webhook\x20fields:',Object['keys'](_0x1275f6));throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');}let _0x25fd0e=null;console[_0x758b51(0x29c)](_0x758b51(0x172)+_0x4f1733[_0x758b51(0x1e6)]);_0x4f1733[_0x758b51(0x1e6)]&&(console[_0x758b51(0x29c)](_0x758b51(0x169)),_0x25fd0e=await database_1[_0x758b51(0x1fd)][_0x758b51(0x1ed)][_0x758b51(0x218)]({'where':{'AND':[{'OR':[{'gateway':_0x758b51(0x160)},{'gateway':_0x758b51(0x180)},{'gateway':_0x758b51(0x1af)}]},{'OR':[{'gatewayPaymentId':_0x4f1733[_0x758b51(0x1e6)]},{'gatewayOrderId':_0x4f1733[_0x758b51(0x1e6)]},{'id':_0x4f1733[_0x758b51(0x1e6)]},{'orderId':_0x4f1733['paymentId']}]}]}}),console[_0x758b51(0x29c)]('🔍\x20Search\x20result:\x20'+(_0x25fd0e?_0x758b51(0x1d7)+_0x25fd0e['id']:'Payment\x20not\x20found')));if(!_0x25fd0e){console[_0x758b51(0x181)](_0x758b51(0x1eb)+_0x4f1733[_0x758b51(0x1e6)]),console['error'](_0x758b51(0x1e3)+_0x4f1733[_0x758b51(0x1e6)]+_0x758b51(0x21c)+_0x4f1733[_0x758b51(0x1e6)]+_0x758b51(0x215)+_0x4f1733[_0x758b51(0x1e6)]+'\x22');const _0x4d3ff9=await database_1[_0x758b51(0x1fd)]['payment']['findMany']({'where':{'OR':[{'gateway':_0x758b51(0x180)},{'gateway':_0x758b51(0x160)},{'gateway':_0x758b51(0x1af)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x758b51(0x1ea)},'take':0xf});console[_0x758b51(0x29c)](_0x758b51(0x1a0),_0x4d3ff9),loggerService_1[_0x758b51(0x241)][_0x758b51(0x174)](_0x758b51(0x180),new Error(_0x758b51(0x1cc)+_0x4f1733[_0x758b51(0x1e6)]),_0x1275f6);throw new Error(_0x758b51(0x157)+_0x4f1733[_0x758b51(0x1e6)]);}console['log'](_0x758b51(0x221)+_0x25fd0e['id']+'\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20'+_0x25fd0e[_0x758b51(0x20d)]+'\x20to\x20'+_0x4f1733[_0x758b51(0x20d)]);const _0x3f8fd9={};_0x4f1733['amount']&&await database_1['default'][_0x758b51(0x1ed)][_0x758b51(0x292)]({'where':{'id':_0x25fd0e['id']},'data':{'amount':_0x4f1733[_0x758b51(0x239)],'updatedAt':new Date()}}),_0x4f1733[_0x758b51(0x297)]&&await database_1[_0x758b51(0x1fd)]['payment'][_0x758b51(0x292)]({'where':{'id':_0x25fd0e['id']},'data':{'currency':_0x4f1733[_0x758b51(0x297)],'updatedAt':new Date()}}),_0x4f1733[_0x758b51(0x20d)]===_0x758b51(0x245)&&_0x4f1733[_0x758b51(0x1c9)]&&(_0x3f8fd9[_0x758b51(0x26b)]=_0x4f1733[_0x758b51(0x1c9)],console[_0x758b51(0x29c)](_0x758b51(0x1a2)+_0x4f1733['errorMessage'])),_0x3f8fd9['paymentMethod']=_0x758b51(0x180),await this[_0x758b51(0x24e)](_0x25fd0e['id'],_0x4f1733[_0x758b51(0x20d)],_0x3f8fd9),loggerService_1[_0x758b51(0x241)][_0x758b51(0x1be)](_0x758b51(0x180),_0x25fd0e['id'],_0x25fd0e[_0x758b51(0x20d)],_0x4f1733[_0x758b51(0x20d)],_0x1275f6);}catch(_0x328c62){console[_0x758b51(0x181)](_0x758b51(0x155),_0x328c62),loggerService_1[_0x758b51(0x241)][_0x758b51(0x174)](_0x758b51(0x180),_0x328c62,_0x1275f6);throw _0x328c62;}}async[a69_0x2c076e(0x233)](_0xc0c673){const _0x1db0b1=a69_0x2c076e;console[_0x1db0b1(0x29c)]('🔄\x20Processing\x20Amer\x20webhook:',JSON[_0x1db0b1(0x182)](_0xc0c673,null,0x2));try{const _0x131952=await this[_0x1db0b1(0x18e)]['processWebhook'](_0xc0c673);console['log'](_0x1db0b1(0x1e8),_0x131952);if(!_0x131952[_0x1db0b1(0x1e6)]){console[_0x1db0b1(0x181)](_0x1db0b1(0x190)),console[_0x1db0b1(0x181)](_0x1db0b1(0x296),Object[_0x1db0b1(0x211)](_0xc0c673));throw new Error(_0x1db0b1(0x24b));}let _0x5264dc=null;console[_0x1db0b1(0x29c)]('🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x131952[_0x1db0b1(0x1e6)]),_0x5264dc=await database_1['default'][_0x1db0b1(0x1ed)][_0x1db0b1(0x218)]({'where':{'AND':[{'gateway':_0x1db0b1(0x17f)},{'OR':[{'gatewayPaymentId':_0x131952[_0x1db0b1(0x1e6)]},{'gatewayOrderId':_0x131952[_0x1db0b1(0x1e6)]},{'id':_0x131952[_0x1db0b1(0x1e6)]},{'orderId':_0x131952[_0x1db0b1(0x1e6)]}]}]}}),console[_0x1db0b1(0x29c)]('🔍\x20Search\x20result:\x20'+(_0x5264dc?'Found\x20payment\x20'+_0x5264dc['id']:_0x1db0b1(0x1d2)));if(!_0x5264dc){console['error'](_0x1db0b1(0x273)+_0x131952[_0x1db0b1(0x1e6)]);return;}console[_0x1db0b1(0x29c)]('📊\x20Amer\x20webhook:\x20Payment\x20'+_0x5264dc['id']+_0x1db0b1(0x224)+_0x131952['status']),await this[_0x1db0b1(0x24e)](_0x5264dc['id'],_0x131952['status'],{'cardLast4':_0x131952[_0x1db0b1(0x23e)]?.[_0x1db0b1(0x166)],'paymentMethod':_0x131952[_0x1db0b1(0x23e)]?.[_0x1db0b1(0x21e)]});}catch(_0x33f430){console[_0x1db0b1(0x181)](_0x1db0b1(0x22a),_0x33f430),loggerService_1[_0x1db0b1(0x241)]['logWebhookError']('amer',_0x33f430,_0xc0c673);throw _0x33f430;}}async[a69_0x2c076e(0x268)](_0x3c3c55){const _0x484999=a69_0x2c076e;console['log'](_0x484999(0x1bf),JSON[_0x484999(0x182)](_0x3c3c55,null,0x2));try{const _0x4039de=_0x3c3c55[_0x484999(0x20d)],_0x58e927=_0x3c3c55[_0x484999(0x19d)],_0xb40e2b=_0x3c3c55['system_id'],_0x19f7dd=_0x3c3c55[_0x484999(0x278)],_0x51f26f=_0x3c3c55[_0x484999(0x239)],_0x1a18b7=_0x3c3c55['currency'],_0x11f905=_0x3c3c55['commission'],_0x5dd44d=_0x3c3c55[_0x484999(0x168)];if(!_0x58e927){console['error'](_0x484999(0x178));throw new Error(_0x484999(0x29a));}console[_0x484999(0x29c)](_0x484999(0x250),{'status':_0x4039de,'clientTransactionId':_0x58e927,'systemId':_0xb40e2b,'paymentMethod':_0x19f7dd,'amount':_0x51f26f,'currency':_0x1a18b7,'commission':_0x11f905,'statusAdditionInfo':_0x5dd44d});const _0x45792f=await database_1['default'][_0x484999(0x1ed)][_0x484999(0x218)]({'where':{'OR':[{'gatewayOrderId':_0x58e927},{'orderId':_0x58e927},{'id':_0x58e927},{'gatewayPaymentId':_0x58e927}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x45792f){console['error'](_0x484999(0x219)+_0x58e927);throw new Error(_0x484999(0x1cc)+_0x58e927);}console[_0x484999(0x29c)](_0x484999(0x221)+_0x45792f['id']+_0x484999(0x1c3)),console[_0x484999(0x29c)](_0x484999(0x269)+_0x45792f['status']+'\x20→\x20'+_0x4039de),_0x4039de===_0x484999(0x17d)?(console['log'](_0x484999(0x20a)),await this[_0x484999(0x24e)](_0x45792f['id'],'FAILED'),console['log'](_0x484999(0x195)+_0x45792f['id']+_0x484999(0x288)),console[_0x484999(0x29c)](_0x484999(0x267)+(_0x5dd44d||'No\x20additional\x20info'))):console['log']('ℹ️\x20AmPay\x20status\x20'+_0x4039de+_0x484999(0x27d)),await database_1[_0x484999(0x1fd)][_0x484999(0x196)][_0x484999(0x1d0)]({'data':{'paymentId':_0x45792f['id'],'shopId':_0x45792f['shopId'],'event':'ampay_'+(_0x4039de?.['toLowerCase']()||'unknown'),'statusCode':0xc8,'responseBody':JSON[_0x484999(0x182)](_0x3c3c55)}}),loggerService_1['loggerService'][_0x484999(0x1be)]('ampay',_0x45792f['id'],_0x45792f['status'],_0x4039de===_0x484999(0x17d)?'FAILED':_0x4039de,_0x3c3c55);}catch(_0x4a8591){console[_0x484999(0x181)](_0x484999(0x22e),_0x4a8591),loggerService_1[_0x484999(0x241)]['logWebhookError'](_0x484999(0x1cd),_0x4a8591,_0x3c3c55);throw _0x4a8591;}}async[a69_0x2c076e(0x256)](_0x494197){const _0x239cad=a69_0x2c076e;console[_0x239cad(0x29c)](_0x239cad(0x240),JSON['stringify'](_0x494197,null,0x2));try{const _0x5b8b12=_0x494197[_0x239cad(0x20d)],_0x1d2337=_0x494197[_0x239cad(0x19d)],_0x49c196=_0x494197[_0x239cad(0x18a)],_0x136750=_0x494197[_0x239cad(0x278)],_0x1730fd=_0x494197[_0x239cad(0x239)],_0x407a11=_0x494197[_0x239cad(0x297)],_0x1bac7c=_0x494197['commission'],_0x4c4e8d=_0x494197['status_addition_info'];if(!_0x1d2337){console[_0x239cad(0x181)]('❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook');throw new Error(_0x239cad(0x179));}console[_0x239cad(0x29c)]('📊\x20AmPay\x20TRY\x20webhook\x20data:',{'status':_0x5b8b12,'clientTransactionId':_0x1d2337,'systemId':_0x49c196,'paymentMethod':_0x136750,'amount':_0x1730fd,'currency':_0x407a11,'commission':_0x1bac7c,'statusAdditionInfo':_0x4c4e8d});const _0x4aa749=await database_1['default']['payment'][_0x239cad(0x218)]({'where':{'OR':[{'gatewayOrderId':_0x1d2337},{'orderId':_0x1d2337},{'id':_0x1d2337},{'gatewayPaymentId':_0x1d2337}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x4aa749){console['error']('❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20'+_0x1d2337);throw new Error(_0x239cad(0x1cc)+_0x1d2337);}console[_0x239cad(0x29c)](_0x239cad(0x221)+_0x4aa749['id']+'\x20for\x20AmPay\x20TRY\x20webhook'),console[_0x239cad(0x29c)](_0x239cad(0x269)+_0x4aa749['status']+_0x239cad(0x17c)+_0x5b8b12),_0x5b8b12===_0x239cad(0x17d)?(console[_0x239cad(0x29c)](_0x239cad(0x1bc)),await this[_0x239cad(0x24e)](_0x4aa749['id'],'FAILED'),console[_0x239cad(0x29c)]('✅\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20'+_0x4aa749['id']+_0x239cad(0x288)),console[_0x239cad(0x29c)](_0x239cad(0x267)+(_0x4c4e8d||'No\x20additional\x20info'))):console[_0x239cad(0x29c)](_0x239cad(0x1c7)+_0x5b8b12+_0x239cad(0x27d)),await database_1[_0x239cad(0x1fd)][_0x239cad(0x196)][_0x239cad(0x1d0)]({'data':{'paymentId':_0x4aa749['id'],'shopId':_0x4aa749[_0x239cad(0x197)],'event':_0x239cad(0x1ce)+(_0x5b8b12?.[_0x239cad(0x1a1)]()||_0x239cad(0x1c6)),'statusCode':0xc8,'responseBody':JSON[_0x239cad(0x182)](_0x494197)}}),loggerService_1[_0x239cad(0x241)]['logWebhookProcessed'](_0x239cad(0x27f),_0x4aa749['id'],_0x4aa749[_0x239cad(0x20d)],_0x5b8b12===_0x239cad(0x17d)?_0x239cad(0x245):_0x5b8b12,_0x494197);}catch(_0x41ccfd){console[_0x239cad(0x181)](_0x239cad(0x19f),_0x41ccfd),loggerService_1[_0x239cad(0x241)][_0x239cad(0x174)](_0x239cad(0x27f),_0x41ccfd,_0x494197);throw _0x41ccfd;}}async[a69_0x2c076e(0x1ec)](_0x8ef17b,_0x4c047c){const _0x21db5f=a69_0x2c076e,_0x59ff0a=Date[_0x21db5f(0x242)]();try{const _0x3d1083=_0x8ef17b[_0x21db5f(0x294)],_0x485809=_0x3d1083[_0x21db5f(0x21b)];if(!_0x485809?.[_0x21db5f(0x1bd)]){console['log'](_0x21db5f(0x271)+_0x3d1083['id']);return;}const _0x360d01=_0x4c047c===_0x21db5f(0x25c)?_0x21db5f(0x1ac):_0x4c047c==='FAILED'?_0x21db5f(0x207):_0x4c047c==='EXPIRED'?'payment.failed':_0x4c047c===_0x21db5f(0x295)?_0x21db5f(0x207):_0x4c047c===_0x21db5f(0x270)?_0x21db5f(0x207):_0x21db5f(0x1a5);let _0x234cf6=[];if(_0x485809[_0x21db5f(0x22f)])try{_0x234cf6=Array['isArray'](_0x485809[_0x21db5f(0x22f)])?_0x485809[_0x21db5f(0x22f)]:JSON[_0x21db5f(0x17a)](_0x485809[_0x21db5f(0x22f)]);}catch(_0x487f6){console[_0x21db5f(0x181)](_0x21db5f(0x272),_0x487f6),_0x234cf6=[];}if(!_0x234cf6[_0x21db5f(0x25d)](_0x360d01)){console[_0x21db5f(0x29c)]('Webhook\x20event\x20'+_0x360d01+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3d1083['id']);return;}const _0x4bc53a={'event':_0x360d01,'payment':{'id':_0x8ef17b['id'],'order_id':_0x8ef17b['orderId'],'gateway_order_id':_0x8ef17b[_0x21db5f(0x1d9)],'gateway':_0x8ef17b['gateway'],'amount':_0x8ef17b[_0x21db5f(0x239)],'currency':_0x8ef17b['currency'],'status':_0x4c047c[_0x21db5f(0x1a1)](),'customer_email':_0x8ef17b[_0x21db5f(0x261)],'customer_name':_0x8ef17b[_0x21db5f(0x26d)],'failure_message':_0x8ef17b[_0x21db5f(0x26b)],'tx_urls':_0x8ef17b[_0x21db5f(0x19a)]?JSON[_0x21db5f(0x17a)](_0x8ef17b[_0x21db5f(0x19a)]):null,'created_at':_0x8ef17b[_0x21db5f(0x1ff)],'updated_at':_0x8ef17b[_0x21db5f(0x16c)]}},_0xb765ce=await fetch(_0x485809[_0x21db5f(0x1bd)],{'method':_0x21db5f(0x20b),'headers':{'Content-Type':_0x21db5f(0x24f),'User-Agent':'Payment\x20System/1.0'},'body':JSON['stringify'](_0x4bc53a)}),_0x4d8932=Date[_0x21db5f(0x242)]()-_0x59ff0a,_0x104860=_0xb765ce['ok']?_0x21db5f(0x1f2):await _0xb765ce[_0x21db5f(0x1b4)]();loggerService_1[_0x21db5f(0x241)]['logShopWebhookSent'](_0x8ef17b[_0x21db5f(0x197)],_0x485809[_0x21db5f(0x1bd)],_0x360d01,_0xb765ce['status'],_0x4d8932,_0x4bc53a),console[_0x21db5f(0x29c)](_0x21db5f(0x189)+_0x485809[_0x21db5f(0x1bd)]+_0x21db5f(0x27e)+_0xb765ce[_0x21db5f(0x20d)]+'\x20('+_0x4d8932+_0x21db5f(0x18b));}catch(_0x11c237){console[_0x21db5f(0x181)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x11c237),loggerService_1['loggerService']['logShopWebhookError'](_0x8ef17b['shopId'],_0x8ef17b[_0x21db5f(0x294)]?.[_0x21db5f(0x21b)]?.[_0x21db5f(0x1bd)]||_0x21db5f(0x1c6),'webhook_send',_0x11c237,{});}}async[a69_0x2c076e(0x173)](_0x3d3af4,_0x51599a){const _0x112713=a69_0x2c076e;try{const _0xfaf292={'PENDING':'created','PROCESSING':_0x112713(0x229),'PAID':_0x112713(0x217),'FAILED':_0x112713(0x185),'EXPIRED':_0x112713(0x25f),'REFUND':_0x112713(0x1e5),'CHARGEBACK':_0x112713(0x27b)},_0x37a15b=_0xfaf292[_0x51599a];if(!_0x37a15b||_0x37a15b==='created')return;await telegramBotService_1['telegramBotService']['sendPaymentNotification'](_0x3d3af4[_0x112713(0x197)],_0x3d3af4,_0x37a15b);}catch(_0x2bf9e3){console['error'](_0x112713(0x299),_0x2bf9e3);}}async['getGatewayCommission'](_0x11a37a,_0x28ddd4){const _0x313250=a69_0x2c076e;try{const _0x4d058e=await database_1[_0x313250(0x1fd)][_0x313250(0x294)][_0x313250(0x15f)]({'where':{'id':_0x11a37a},'select':{'gatewaySettings':!![]}});if(!_0x4d058e?.[_0x313250(0x188)])return console[_0x313250(0x29c)](_0x313250(0x264)+_0x11a37a+_0x313250(0x1f0)),0xa;const _0x31d994=JSON[_0x313250(0x17a)](_0x4d058e[_0x313250(0x188)]);for(const [_0x107288,_0x3d33a9]of Object[_0x313250(0x290)](_0x31d994)){if(_0x107288[_0x313250(0x1a1)]()===_0x28ddd4[_0x313250(0x1a1)]()){const _0x48a94b=_0x3d33a9[_0x313250(0x205)]||0xa;return console[_0x313250(0x29c)](_0x313250(0x21d)+_0x28ddd4+_0x313250(0x24c)+_0x11a37a+':\x20'+_0x48a94b+'%'),_0x48a94b;}}return console[_0x313250(0x29c)](_0x313250(0x1f7)+_0x28ddd4+_0x313250(0x22b)+_0x11a37a+',\x20using\x20default\x2010%'),0xa;}catch(_0x1cef52){return console['error'](_0x313250(0x158)+_0x11a37a+_0x313250(0x230)+_0x28ddd4+':',_0x1cef52),0xa;}}async[a69_0x2c076e(0x252)](_0x22182f,_0x3ae10b){const _0x131025=a69_0x2c076e;console[_0x131025(0x29c)](_0x131025(0x222)),console[_0x131025(0x29c)](_0x131025(0x198),JSON[_0x131025(0x182)](_0x22182f,null,0x2)),console['log'](_0x131025(0x1dd),JSON[_0x131025(0x182)](_0x3ae10b,null,0x2));try{const _0x1071d4=_0x22182f['customerOrderId']||_0x3ae10b[_0x131025(0x1b8)],_0x50919c=_0x22182f[_0x131025(0x20d)]||_0x3ae10b[_0x131025(0x20d)],_0x2ed43e=_0x22182f[_0x131025(0x239)]||_0x3ae10b[_0x131025(0x239)],_0x40f767=_0x22182f[_0x131025(0x297)]||_0x3ae10b[_0x131025(0x297)],_0x4eb5bb=_0x22182f['dateTime']||_0x3ae10b[_0x131025(0x21f)];if(!_0x1071d4){console[_0x131025(0x181)](_0x131025(0x287));throw new Error(_0x131025(0x200));}console[_0x131025(0x29c)](_0x131025(0x208),{'customerOrderId':_0x1071d4,'status':_0x50919c,'amount':_0x2ed43e,'currency':_0x40f767,'dateTime':_0x4eb5bb});const _0x1ae374=await database_1[_0x131025(0x1fd)][_0x131025(0x1ed)][_0x131025(0x218)]({'where':{'OR':[{'gatewayOrderId':_0x1071d4},{'orderId':_0x1071d4},{'id':_0x1071d4},{'gatewayPaymentId':_0x1071d4}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1ae374){console[_0x131025(0x181)](_0x131025(0x254)+_0x1071d4);throw new Error('Payment\x20not\x20found:\x20'+_0x1071d4);}console[_0x131025(0x29c)](_0x131025(0x221)+_0x1ae374['id']+_0x131025(0x187)),console[_0x131025(0x29c)](_0x131025(0x269)+_0x1ae374[_0x131025(0x20d)]+_0x131025(0x17c)+_0x50919c);let _0x46fdea=_0x50919c?.[_0x131025(0x163)]();_0x50919c===_0x131025(0x245)||_0x50919c===_0x131025(0x204)?(_0x46fdea=_0x131025(0x245),console['log'](_0x131025(0x246)+_0x50919c+_0x131025(0x1f9)),await this['updatePaymentStatus'](_0x1ae374['id'],_0x46fdea),console[_0x131025(0x29c)](_0x131025(0x276)+_0x1ae374['id']+_0x131025(0x288))):console[_0x131025(0x29c)](_0x131025(0x253)+_0x50919c+_0x131025(0x16e)),await database_1[_0x131025(0x1fd)]['webhookLog'][_0x131025(0x1d0)]({'data':{'paymentId':_0x1ae374['id'],'shopId':_0x1ae374['shopId'],'event':_0x131025(0x28a)+(_0x50919c?.['toLowerCase']()||_0x131025(0x1c6)),'statusCode':0xc8,'responseBody':JSON[_0x131025(0x182)]({'queryParams':_0x22182f,'bodyData':_0x3ae10b})}}),loggerService_1[_0x131025(0x241)][_0x131025(0x1be)](_0x131025(0x226),_0x1ae374['id'],_0x1ae374[_0x131025(0x20d)],_0x46fdea||_0x50919c,{'queryParams':_0x22182f,'bodyData':_0x3ae10b});}catch(_0x3df75f){console['error'](_0x131025(0x27a),_0x3df75f),loggerService_1[_0x131025(0x241)][_0x131025(0x174)]('myxspend',_0x3df75f,{'queryParams':_0x22182f,'bodyData':_0x3ae10b});throw _0x3df75f;}}}exports[a69_0x2c076e(0x1f4)]=WebhookService;function a69_0x342c(_0x3dc23d,_0x24a3b4){const _0x1c0a63=a69_0x1c0a();return a69_0x342c=function(_0x342c50,_0x5cf03d){_0x342c50=_0x342c50-0x154;let _0x2eef8b=_0x1c0a63[_0x342c50];return _0x2eef8b;},a69_0x342c(_0x3dc23d,_0x24a3b4);}function a69_0x1c0a(){const _0xd761e9=['No\x20specific\x20commission\x20found\x20for\x20gateway\x20','AmPayTRYService','\x20mapped\x20to\x20FAILED','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','Error\x20processing\x20CoinToPay\x20webhook:','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','default','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','createdAt','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','amountUSDT','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','../config/database','EXPIRED','commission','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','payment.failed','📊\x20MyXSpend\x20webhook\x20data:','type','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','POST','💰\x20Amount\x20after\x20gateway\x20commission:\x20','status','__importDefault','🔍\x20Found\x20VISA\x20payment:\x20ID=','\x20(Status:\x20','keys','username','\x20USDT\x20(chargeback\x20penalty\x20ONLY)','toFixed','\x22,\x20orderId=\x22','📊\x20VISA\x20webhook\x20result:','paid','findFirst','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','Error\x20processing\x20KLYME\x20webhook:','settings','\x22,\x20id=\x22','Gateway\x20','paymentMethod','dateTime','paymentLink','✅\x20Found\x20payment\x20','🔄\x20Processing\x20MyXSpend\x20webhook:','visa','\x20status\x20','\x20(orderId:\x20','myxspend','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','📈\x20Payment\x20','processing','❌\x20Error\x20processing\x20Amer\x20webhook:','\x20in\x20shop\x20','\x20not\x20found','🔄\x20Processing\x20CoinToPay\x20webhook:','❌\x20Error\x20processing\x20AmPay\x20webhook:','webhookEvents',',\x20gateway\x20','📊\x20VISA\x20payment\x20found:\x20','66310jCNxmI','processAmerWebhook','🔄\x20Processing\x20CoinToPay2\x20webhook:','No\x20payment\x20ID\x20in\x20Noda\x20webhook','%\x20gateway\x20commission)','917420GWPhPm','10HsEreS','amount','❌\x20VISA\x20webhook\x20processing\x20failed:','🔄\x20Processing\x20Rapyd\x20webhook:','findMany','CoinToPay2Service','additionalInfo','\x20balance\x20updated:\x20','🔄\x20Processing\x20AmPay\x20TRY\x20webhook:','loggerService','now','__esModule','🔄\x20Processing\x20Plisio\x20webhook:','FAILED','🔄\x20MyXSpend\x20status\x20','📊\x20Plisio\x20webhook:\x20Payment\x20',',\x20currentPayments=','\x20updated:\x20currentPayments=','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','No\x20payment\x20ID\x20in\x20Amer\x20webhook','\x20commission\x20for\x20shop\x20','\x20=\x20','updatePaymentStatus','application/json','📊\x20AmPay\x20webhook\x20data:','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','processMyXSpendWebhook','ℹ️\x20MyXSpend\x20status\x20','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','bankId','processAmPayTRYWebhook','remitterIban','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','PAID','includes',',\x20card:\x20****','expired','\x20current\x20balance:\x20','customerEmail','remitterName','💰\x20Removing\x20from\x20balance:\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','CoinToPayService','🔄\x20Processing\x20KLYME\x20webhook:','ℹ️\x20Decline\x20reason:\x20','processAmPayWebhook','📊\x20Payment\x20status:\x20','klyme','failureMessage','MASTERCARD','customerName','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','✅\x20Found\x20payment:\x20ID=','REFUND','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Error\x20parsing\x20webhook\x20events:','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','\x20+\x20',',\x20status=','✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','gatewayPaymentId','payment_method','currentPayments','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','chargeback','\x20USDT','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','\x20with\x20status\x20','ampay_try','2207368frrFxH','orderId','VISA\x20payment\x20not\x20found:\x20','Payment\x20','paidAt','./gateways/nodaService','plisio','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','\x20status\x20updated\x20to\x20FAILED','VisaMasterCardService','myxspend_','processKlymeWebhook','cointopay','430044nymcXs','rapyd','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','entries','\x20commission:\x20','update','COMPLETED','shop','CHARGEBACK','❌\x20Available\x20webhook\x20fields:','currency','9621ITGgTY','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','💰\x20Adding\x20to\x20balance:\x20','log','./gateways/ampayTRYService','🔄\x20Additional\x20data:',',\x20Gateway=','2299tVqTOs',',\x20GatewayOrderId=','❌\x20Error\x20processing\x20MasterCard\x20webhook:','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','MasterCard\x20payment\x20not\x20found:\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','\x20-\x20','noda','\x22,\x20paymentLinkId=\x22','\x20->\x20','chargebackAmount','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','findUnique','visa_mastercard','🔄\x20Processing\x20MasterCard\x20webhook:','coinToPayService','toUpperCase','🏪\x20Shop\x20','Error\x20processing\x20Rapyd\x20webhook:','cardLast4','plisioService','status_addition_info','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','PlisioService','$transaction','updatedAt','💰\x20Payment\x20amount\x20is\x20NOT\x20deducted\x20(chargeback\x20penalty\x20only)','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','balance','./gateways/klymeService','./gateways/rapydService','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','sendPaymentStatusNotification','logWebhookError','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','no\x20balance\x20change','amountAfterGatewayCommissionUSDT','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','parse','processCoinToPayWebhook','\x20→\x20','DECLINED','SINGLE','amer','mastercard','error','stringify','Found','Error\x20processing\x20Noda\x20webhook:','failed','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','\x20for\x20MyXSpend\x20webhook','gatewaySettings','📤\x20Shop\x20webhook\x20sent\x20to\x20','system_id','ms)','✅\x20Payment\x20link\x20','getGatewayCommission','amerService','💸\x20CHARGEBACK:\x20Processing\x20penalty-only\x20deduction','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data',':\x20type=','5744jZYONb','🔍\x20VISA\x20payment\x20search\x20result:\x20','cointopay2','✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20','webhookLog','shopId','Query\x20params:','processWebhook','txUrls','🔍\x20VISA\x20payment\x20search\x20executed','📝\x20Reason:\x20','client_transaction_id','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','❌\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','toLowerCase','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','./loggerService','VISA','payment.pending','./telegramBotService','./gateways/mastercardService','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','gatewayCommissionRate','nodaService','🔄\x20Processing\x20VISA\x20webhook:','payment.success','📊\x20MasterCard\x20webhook\x20result:',',\x20Card=****','visa/mastercard','💰\x20Final\x20balance\x20after\x20chargeback:\x20','\x22,\x20newStatus=\x22','📈\x20Payment\x20details:\x20oldStatus=\x22','toISOString','text','gateway','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','91YOdlUf','customerOrderId','📊\x20KLYME\x20webhook:\x20Payment\x20','./gateways/amerService','No\x20payment\x20ID\x20in\x20VISA\x20webhook','🔄\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','webhookUrl','logWebhookProcessed','🔄\x20Processing\x20AmPay\x20webhook:','rapydService','map','plisio_gateway','\x20for\x20AmPay\x20webhook','Not\x20found','coinToPay2Service','unknown','ℹ️\x20AmPay\x20TRY\x20status\x20','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','errorMessage','./gateways/ampayService','68361FClPxH','Payment\x20not\x20found:\x20','ampay','ampay_try_','./currencyService','create','Error\x20processing\x20Plisio\x20webhook:','Payment\x20not\x20found','🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:','./gateways/coinToPayService',',\x20newStatus=','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','Found\x20payment\x20','🔄\x20Processing\x20Noda\x20webhook:','gatewayOrderId','processPlisioWebhook','processVisaWebhook','📊\x20CoinToPay\x20webhook:\x20Payment\x20','Body\x20data:','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','📊\x20Rapyd\x20webhook:\x20Payment\x20','893264FaitHZ','processRapydWebhook','💰\x20Converting\x20','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22',',\x20gatewayOrderId:\x20','refund','paymentId','paymentLinkId','📊\x20Amer\x20webhook\x20result:','klymeService','desc','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','sendShopWebhook','payment','visaMasterCardService','ampayService',',\x20using\x20default\x20commission\x2010%','convertToUSDT','Success','processCoinToPay2Webhook','WebhookService','❌\x20Payment\x20link\x20','KlymeService'];a69_0x1c0a=function(){return _0xd761e9;};return a69_0x1c0a();}