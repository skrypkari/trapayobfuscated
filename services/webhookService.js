'use strict';const a69_0x4709cf=a69_0x5306;(function(_0x14bc5e,_0x4995c6){const _0x5025d7=a69_0x5306,_0x1505f9=_0x14bc5e();while(!![]){try{const _0x4a5527=-parseInt(_0x5025d7(0x213))/0x1+-parseInt(_0x5025d7(0x207))/0x2+parseInt(_0x5025d7(0x13f))/0x3+-parseInt(_0x5025d7(0x1e8))/0x4*(parseInt(_0x5025d7(0x183))/0x5)+parseInt(_0x5025d7(0x125))/0x6*(parseInt(_0x5025d7(0x132))/0x7)+parseInt(_0x5025d7(0x1d6))/0x8*(-parseInt(_0x5025d7(0x19e))/0x9)+parseInt(_0x5025d7(0x1b6))/0xa;if(_0x4a5527===_0x4995c6)break;else _0x1505f9['push'](_0x1505f9['shift']());}catch(_0x211ccb){_0x1505f9['push'](_0x1505f9['shift']());}}}(a69_0x4671,0xeedd8));function a69_0x4671(){const _0x506f68=['sendPaymentNotification','webhookEvents','AmerService','sendShopWebhook','username','./gateways/nodaService','visa','❌\x20VISA\x20webhook\x20processing\x20failed:','unknown','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','plisio','🔄\x20Processing\x20Noda\x20webhook:','NodaService','ampayTRYService','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','payment_method','visa/mastercard','📊\x20VISA\x20payment\x20found:\x20','2128746UBGZjK','stringify','Error\x20processing\x20KLYME\x20webhook:','🔄\x20Processing\x20Plisio\x20webhook:','coinToPayService','payment.pending','processKlymeWebhook','ℹ️\x20Decline\x20reason:\x20','processAmerWebhook','rapyd','\x20mapped\x20to\x20FAILED','payment.failed','663773hGluxJ','no\x20balance\x20change','✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20','rapydService','\x20(orderId:\x20','ℹ️\x20AmPay\x20status\x20','\x20USDT\x20(chargeback\x20penalty\x20ONLY)','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','VISA','EXPIRED','logWebhookError','create','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','myxspend_','./gateways/ampayTRYService','\x20->\x20','CHARGEBACK','parse','log','⚠️\x20CHARGEBACK\x20without\x20penalty\x20amount\x20-\x20no\x20balance\x20change','Failed\x20to\x20send\x20shop\x20webhook:','📊\x20VISA\x20webhook\x20result:','bankId','VISA\x20payment\x20not\x20found:\x20','findFirst','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','KlymeService','customerOrderId','🔄\x20MyXSpend\x20status\x20','✅\x20Shop\x20','updatedAt','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','amer','amerService','logWebhookProcessed','\x20for\x20AmPay\x20webhook','Payment\x20not\x20found','\x20status\x20','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','\x20status\x20updated\x20to\x20FAILED','📊\x20Amer\x20webhook:\x20Payment\x20','\x22,\x20newStatus=\x22','paymentMethod','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','error','myxspend','sendPaymentStatusNotification','❌\x20Available\x20webhook\x20fields:','No\x20additional\x20info','\x20not\x20found','cardLast4','paidAt',',\x20GatewayPaymentId=','failed','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','plisioService','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','Payment\x20','isArray','visa_','✅\x20Payment\x20link\x20','additionalInfo','system','🔍\x20Found\x20VISA\x20payment:\x20ID=','noda','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','Found\x20payment\x20','customerName','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','processPlisioWebhook','gatewayPaymentId','failureMessage','./gateways/coinToPayService','💰\x20Converting\x20','\x20-\x20',',\x20newStatus=','\x20with\x20status\x20','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','findMany','77574QuktCI','ampayService','📊\x20Plisio\x20webhook:\x20Payment\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook','%\x20gateway\x20commission)','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','📊\x20MasterCard\x20webhook\x20result:','remitterName','AmPayTRYService','loggerService','findUnique','1043WrHdQE','default','webhook_send','amountUSDT','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','gatewayCommissionRate','__esModule','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','\x20in\x20shop\x20','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','paymentId','3543177LBZCSQ','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','processRapydWebhook','payment','remitterIban','❌\x20Error\x20processing\x20MasterCard\x20webhook:','ampay_try','VisaMasterCardService','📤\x20Shop\x20webhook\x20sent\x20to\x20','Body\x20data:','🔍\x20Search\x20result:\x20','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','telegramBotService','MASTERCARD','logShopWebhookSent','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','client_transaction_id','type','💰\x20Removing\x20from\x20balance:\x20',',\x20Status=','plisio_gateway','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','WebhookService','updatePaymentStatus','🔄\x20Processing\x20VISA\x20webhook:','ℹ️\x20AmPay\x20TRY\x20status\x20','klyme','system_id','orderId','update','No\x20payment\x20ID\x20in\x20Amer\x20webhook','./gateways/coinToPay2Service','shop','currency','processCoinToPay2Webhook','paymentLinkId','cointopay','entries','✅\x20Found\x20payment:\x20ID=','Error\x20processing\x20Plisio\x20webhook:','cointopay2','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','processWebhook','map','desc',',\x20using\x20default\x20commission\x2010%','PlisioService','💰\x20Final\x20balance\x20after\x20chargeback:\x20','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook',':\x20type=','💰\x20Payment\x20amount\x20is\x20NOT\x20deducted\x20(chargeback\x20penalty\x20only)','\x20current\x20balance:\x20','Payment\x20marked\x20as\x20CHARGEBACK\x20(no\x20penalty\x20specified)','expired','klymeService','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','📊\x20Noda\x20webhook:\x20Payment\x20','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','📊\x20Amer\x20webhook\x20result:','❌\x20Error\x20processing\x20Amer\x20webhook:','ampay_try_','🔄\x20Processing\x20CoinToPay\x20webhook:','dateTime','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','text','chargebackAmount','45AKgZxw','❌\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:','toUpperCase','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook','🔄\x20Processing\x20MasterCard\x20webhook:','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','📈\x20Payment\x20details:\x20oldStatus=\x22',',\x20gatewayOrderId:\x20',',\x20gateway\x20','settings','ms)','❌\x20Error\x20processing\x20AmPay\x20webhook:','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','🔄\x20Processing\x20KLYME\x20webhook:',',\x20GatewayOrderId=','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','Payment\x20not\x20found:\x20','PAID','toFixed',',\x20card:\x20****','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','🔄\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','visaMasterCardService','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','Not\x20found','Found','9OPaQAs','currentPayments','webhookUrl','\x20(Status:\x20','__importDefault','❌\x20Payment\x20link\x20','includes','ampay','balance','\x20commission:\x20','\x20commission\x20for\x20shop\x20','txUrls','DECLINED','Error\x20processing\x20CoinToPay2\x20webhook:','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','chargeback','\x20for\x20MyXSpend\x20webhook','toISOString','application/json','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','🔄\x20Additional\x20data:','convertToUSDT','../config/database','visa_mastercard','20036640uMWEyg','mastercard','\x20updated:\x20currentPayments=','📊\x20KLYME\x20webhook:\x20Payment\x20','processAmPayTRYWebhook','processAmPayWebhook','🔍\x20VISA\x20payment\x20search\x20executed','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','FAILED','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','🔄\x20Processing\x20MyXSpend\x20webhook:','📊\x20AmPay\x20TRY\x20webhook\x20data:','logShopWebhookError','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','\x20USDT','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','toLowerCase','🔄\x20Processing\x20Rapyd\x20webhook:','🔍\x20VISA\x20payment\x20search\x20result:\x20','\x20balance\x20updated:\x20','./gateways/klymeService','POST','📈\x20Payment\x20','getGatewayCommission','processMasterCardWebhook','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','errorMessage','SINGLE','status_addition_info','🔄\x20Processing\x20CoinToPay2\x20webhook:','keys','defineProperty','11209208ycWQvO','\x20for\x20AmPay\x20TRY\x20webhook',',\x20status=','🔄\x20Processing\x20AmPay\x20webhook:','processMyXSpendWebhook','amount','📈\x20Found\x20payment\x20link\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','amountAfterGatewayCommissionUSDT',',\x20gatewayPaymentId:\x20','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','coinToPay2Service','💰\x20Payment\x20',',\x20currentPayments=','status','\x20=\x20','📊\x20Payment\x20status:\x20','✅\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20','445980mlqsdj','✅\x20Found\x20payment\x20','payment.success','No\x20payment\x20ID\x20in\x20VISA\x20webhook','shopId','CoinToPay2Service','\x20→\x20','ℹ️\x20MyXSpend\x20status\x20','REFUND','webhookLog','gatewayOrderId','gateway','./telegramBotService'];a69_0x4671=function(){return _0x506f68;};return a69_0x4671();}function a69_0x5306(_0x1622b7,_0x1d4a80){const _0x46715d=a69_0x4671();return a69_0x5306=function(_0x53060c,_0x67f9fa){_0x53060c=_0x53060c-0x124;let _0x3d0386=_0x46715d[_0x53060c];return _0x3d0386;},a69_0x5306(_0x1622b7,_0x1d4a80);}var __importDefault=this&&this[a69_0x4709cf(0x1a2)]||function(_0x28a07c){return _0x28a07c&&_0x28a07c['__esModule']?_0x28a07c:{'default':_0x28a07c};};Object[a69_0x4709cf(0x1d5)](exports,a69_0x4709cf(0x139),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a69_0x4709cf(0x1b4))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a69_0x4709cf(0x1fa)),coinToPayService_1=require(a69_0x4709cf(0x25e)),coinToPay2Service_1=require(a69_0x4709cf(0x15f)),klymeService_1=require(a69_0x4709cf(0x1ca)),mastercardService_1=require('./gateways/mastercardService'),amerService_1=require('./gateways/amerService'),ampayService_1=require('./gateways/ampayService'),ampayTRYService_1=require(a69_0x4709cf(0x221)),telegramBotService_1=require(a69_0x4709cf(0x1f4)),currencyService_1=require('./currencyService'),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x169ef5=a69_0x4709cf;this[_0x169ef5(0x24c)]=new plisioService_1[(_0x169ef5(0x16e))](),this[_0x169ef5(0x216)]=new rapydService_1['RapydService'](),this['nodaService']=new nodaService_1[(_0x169ef5(0x201))](),this[_0x169ef5(0x20b)]=new coinToPayService_1['CoinToPayService'](),this[_0x169ef5(0x1e1)]=new coinToPay2Service_1[(_0x169ef5(0x1ed))](),this[_0x169ef5(0x176)]=new klymeService_1[(_0x169ef5(0x22e))](),this[_0x169ef5(0x19a)]=new mastercardService_1[(_0x169ef5(0x146))](),this[_0x169ef5(0x236)]=new amerService_1[(_0x169ef5(0x1f7))](),this[_0x169ef5(0x126)]=new ampayService_1['AmPayService'](),this[_0x169ef5(0x202)]=new ampayTRYService_1[(_0x169ef5(0x12f))]();}async[a69_0x4709cf(0x157)](_0x4b00d6,_0x14e8fd,_0x10cc5c){const _0xf0b867=a69_0x4709cf;console['log']('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x4b00d6+_0xf0b867(0x261)+_0x14e8fd),console[_0xf0b867(0x225)](_0xf0b867(0x1b2),_0x10cc5c),await database_1[_0xf0b867(0x133)]['$transaction'](async _0x4f2f70=>{const _0x553e90=_0xf0b867,_0x35c25c=await _0x4f2f70[_0x553e90(0x142)][_0x553e90(0x131)]({'where':{'id':_0x4b00d6},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x35c25c)throw new Error(_0x553e90(0x24e)+_0x4b00d6+_0x553e90(0x246));const _0x5043cb=_0x35c25c[_0x553e90(0x1e4)],_0x45bfd7=_0x35c25c['shop'];console['log'](_0x553e90(0x1e2)+_0x4b00d6+':\x20'+_0x5043cb+_0x553e90(0x222)+_0x14e8fd),console[_0x553e90(0x225)]('🏪\x20Shop\x20'+_0x45bfd7[_0x553e90(0x1f9)]+_0x553e90(0x173)+_0x45bfd7[_0x553e90(0x1a6)]+_0x553e90(0x1c4));const _0x322f8e={'status':_0x14e8fd['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x553e90(0x253),'statusChangedAt':new Date()};_0x10cc5c?.[_0x553e90(0x25d)]&&(_0x322f8e[_0x553e90(0x25d)]=_0x10cc5c[_0x553e90(0x25d)]);_0x10cc5c?.[_0x553e90(0x1a9)]&&(_0x322f8e[_0x553e90(0x1a9)]=JSON[_0x553e90(0x208)](_0x10cc5c['txUrls']));_0x10cc5c?.[_0x553e90(0x247)]&&(_0x322f8e[_0x553e90(0x247)]=_0x10cc5c[_0x553e90(0x247)]);_0x10cc5c?.['paymentMethod']&&(_0x322f8e[_0x553e90(0x23f)]=_0x10cc5c[_0x553e90(0x23f)]);_0x10cc5c?.[_0x553e90(0x229)]&&(_0x322f8e[_0x553e90(0x229)]=_0x10cc5c[_0x553e90(0x229)]);_0x10cc5c?.[_0x553e90(0x143)]&&(_0x322f8e['remitterIban']=_0x10cc5c[_0x553e90(0x143)]);_0x10cc5c?.['remitterName']&&(_0x322f8e[_0x553e90(0x12e)]=_0x10cc5c[_0x553e90(0x12e)]);let _0x24f0ba=_0x45bfd7[_0x553e90(0x1a6)],_0x24c0ef='';if(_0x14e8fd[_0x553e90(0x185)]()==='PAID'&&_0x5043cb!==_0x553e90(0x195)){const _0x2279fc=await currencyService_1['currencyService'][_0x553e90(0x1b3)](_0x35c25c[_0x553e90(0x1db)],_0x35c25c[_0x553e90(0x161)]),_0x1abb0b=await this['getGatewayCommission'](_0x45bfd7['id'],_0x35c25c[_0x553e90(0x1f3)]),_0x299f80=_0x2279fc*(0x1-_0x1abb0b/0x64);_0x24f0ba+=_0x299f80,_0x24c0ef='+'+_0x299f80[_0x553e90(0x196)](0x6)+_0x553e90(0x1b1)+_0x1abb0b+_0x553e90(0x129),_0x322f8e['amountUSDT']=_0x2279fc,_0x322f8e[_0x553e90(0x1de)]=_0x299f80,_0x322f8e[_0x553e90(0x138)]=_0x1abb0b,_0x322f8e[_0x553e90(0x248)]=new Date(),console[_0x553e90(0x225)](_0x553e90(0x25f)+_0x35c25c[_0x553e90(0x1db)]+'\x20'+_0x35c25c[_0x553e90(0x161)]+_0x553e90(0x222)+_0x2279fc[_0x553e90(0x196)](0x6)+'\x20USDT'),console[_0x553e90(0x225)]('💰\x20Gateway\x20'+_0x35c25c[_0x553e90(0x1f3)]+_0x553e90(0x1a7)+_0x1abb0b+'%'),console['log']('💰\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x299f80['toFixed'](0x6)+_0x553e90(0x1c4)),console[_0x553e90(0x225)]('💰\x20Adding\x20to\x20balance:\x20'+_0x45bfd7['balance']+'\x20+\x20'+_0x299f80[_0x553e90(0x196)](0x6)+'\x20=\x20'+_0x24f0ba[_0x553e90(0x196)](0x6)+_0x553e90(0x1c4));}else{if(_0x5043cb===_0x553e90(0x195)&&_0x14e8fd['toUpperCase']()!==_0x553e90(0x195)&&_0x14e8fd[_0x553e90(0x185)]()!=='CHARGEBACK'){let _0x5d0bdf;if(_0x35c25c[_0x553e90(0x1de)])_0x5d0bdf=_0x35c25c['amountAfterGatewayCommissionUSDT'];else{if(_0x35c25c[_0x553e90(0x135)]){const _0x23421=await this[_0x553e90(0x1cd)](_0x45bfd7['id'],_0x35c25c[_0x553e90(0x1f3)]);_0x5d0bdf=_0x35c25c[_0x553e90(0x135)]*(0x1-_0x23421/0x64);}else console[_0x553e90(0x225)](_0x553e90(0x19b)),_0x5d0bdf=0x0;}_0x5d0bdf>0x0&&(_0x24f0ba-=_0x5d0bdf,_0x24c0ef='-'+_0x5d0bdf[_0x553e90(0x196)](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x322f8e[_0x553e90(0x248)]=null,console[_0x553e90(0x225)](_0x553e90(0x152)+_0x45bfd7['balance']+_0x553e90(0x260)+_0x5d0bdf[_0x553e90(0x196)](0x6)+_0x553e90(0x1e5)+_0x24f0ba[_0x553e90(0x196)](0x6)+'\x20USDT'));}}if(_0x14e8fd[_0x553e90(0x185)]()===_0x553e90(0x223)){const _0x255c4d=_0x10cc5c?.[_0x553e90(0x182)]||0x0;console[_0x553e90(0x225)]('💸\x20CHARGEBACK:\x20Processing\x20penalty-only\x20deduction'),_0x255c4d>0x0?(_0x24f0ba-=_0x255c4d,_0x24c0ef='-'+_0x255c4d['toFixed'](0x6)+_0x553e90(0x219),_0x322f8e[_0x553e90(0x182)]=_0x255c4d,console['log']('💸\x20CHARGEBACK\x20penalty\x20ONLY:\x20-'+_0x255c4d['toFixed'](0x6)+_0x553e90(0x1c4)),console[_0x553e90(0x225)](_0x553e90(0x172)),console[_0x553e90(0x225)](_0x553e90(0x16f)+_0x24f0ba[_0x553e90(0x196)](0x6)+_0x553e90(0x1c4))):(console[_0x553e90(0x225)](_0x553e90(0x226)),_0x24c0ef=_0x553e90(0x174));}const _0x411fd0=await _0x4f2f70[_0x553e90(0x142)][_0x553e90(0x15d)]({'where':{'id':_0x4b00d6},'data':_0x322f8e});_0x24f0ba!==_0x45bfd7[_0x553e90(0x1a6)]&&(await _0x4f2f70['shop'][_0x553e90(0x15d)]({'where':{'id':_0x45bfd7['id']},'data':{'balance':_0x24f0ba}}),console[_0x553e90(0x225)](_0x553e90(0x231)+_0x45bfd7['username']+_0x553e90(0x1c9)+_0x45bfd7[_0x553e90(0x1a6)][_0x553e90(0x196)](0x6)+'\x20->\x20'+_0x24f0ba[_0x553e90(0x196)](0x6)+'\x20USDT'),console[_0x553e90(0x225)]('📝\x20Reason:\x20'+_0x24c0ef));await _0x4f2f70[_0x553e90(0x1f1)][_0x553e90(0x21e)]({'data':{'paymentId':_0x4b00d6,'shopId':_0x45bfd7['id'],'event':'webhook_status_change_'+_0x14e8fd[_0x553e90(0x1c6)](),'statusCode':0xc8,'responseBody':JSON[_0x553e90(0x208)]({'oldStatus':_0x5043cb,'newStatus':_0x14e8fd[_0x553e90(0x185)](),'balanceChange':_0x24c0ef||_0x553e90(0x214),'oldBalance':_0x45bfd7[_0x553e90(0x1a6)],'newBalance':_0x24f0ba,'amountUSDT':_0x322f8e['amountUSDT'],'additionalData':_0x10cc5c,'timestamp':new Date()[_0x553e90(0x1af)]()})}}),await this[_0x553e90(0x1f8)]({..._0x35c25c,..._0x411fd0,'shop':_0x45bfd7},_0x14e8fd[_0x553e90(0x185)]()),await this[_0x553e90(0x243)]({..._0x35c25c,..._0x411fd0},_0x14e8fd[_0x553e90(0x185)]());if(_0x5043cb!==_0x553e90(0x195)&&_0x14e8fd[_0x553e90(0x185)]()===_0x553e90(0x195)){console['log'](_0x553e90(0x1cc)+_0x4b00d6+_0x553e90(0x14a)),console['log'](_0x553e90(0x189)+_0x5043cb+_0x553e90(0x23e)+_0x14e8fd['toUpperCase']()+'\x22,\x20paymentLinkId=\x22'+_0x35c25c['paymentLinkId']+'\x22');if(_0x35c25c[_0x553e90(0x163)])try{const _0x1408c8=await _0x4f2f70['paymentLink'][_0x553e90(0x131)]({'where':{'id':_0x35c25c['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1408c8){console['log'](_0x553e90(0x1dc)+_0x1408c8['id']+_0x553e90(0x171)+_0x1408c8[_0x553e90(0x151)]+_0x553e90(0x1e3)+_0x1408c8[_0x553e90(0x19f)]+_0x553e90(0x1d8)+_0x1408c8[_0x553e90(0x1e4)]);const _0x2313da=_0x1408c8[_0x553e90(0x19f)]+0x1,_0x551726=_0x1408c8[_0x553e90(0x151)]===_0x553e90(0x1d1)?'COMPLETED':_0x1408c8[_0x553e90(0x1e4)];await _0x4f2f70['paymentLink'][_0x553e90(0x15d)]({'where':{'id':_0x35c25c[_0x553e90(0x163)]},'data':{'currentPayments':_0x2313da,'status':_0x551726,'updatedAt':new Date()}}),console['log'](_0x553e90(0x251)+_0x1408c8['id']+_0x553e90(0x1b8)+_0x1408c8[_0x553e90(0x19f)]+_0x553e90(0x222)+_0x2313da+_0x553e90(0x1d8)+_0x1408c8[_0x553e90(0x1e4)]+'\x20->\x20'+_0x551726);}else console[_0x553e90(0x225)](_0x553e90(0x1a3)+_0x35c25c['paymentLinkId']+_0x553e90(0x246));}catch(_0x3ff2cd){console[_0x553e90(0x241)]('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x3ff2cd);}else console[_0x553e90(0x225)](_0x553e90(0x1cc)+_0x4b00d6+_0x553e90(0x234));}else console[_0x553e90(0x225)](_0x553e90(0x1cc)+_0x4b00d6+_0x553e90(0x1ac)+_0x5043cb+'\x20->\x20'+_0x14e8fd[_0x553e90(0x185)]());});}async[a69_0x4709cf(0x25b)](_0x2d8b7e){const _0x53fb2f=a69_0x4709cf;console[_0x53fb2f(0x225)](_0x53fb2f(0x20a),_0x2d8b7e);try{const _0xd16b07=await this['plisioService'][_0x53fb2f(0x16a)](_0x2d8b7e);if(!_0xd16b07['paymentId'])throw new Error(_0x53fb2f(0x137));const _0x2eaedd=await database_1['default']['payment'][_0x53fb2f(0x22b)]({'where':{'gatewayOrderId':_0xd16b07[_0x53fb2f(0x13e)]}});if(!_0x2eaedd){console[_0x53fb2f(0x241)](_0x53fb2f(0x24b)+_0xd16b07['paymentId']);return;}console[_0x53fb2f(0x225)](_0x53fb2f(0x127)+_0x2eaedd['id']+_0x53fb2f(0x23a)+_0xd16b07[_0x53fb2f(0x1e4)]),await this[_0x53fb2f(0x157)](_0x2eaedd['id'],_0xd16b07['status'],{'txUrls':_0xd16b07[_0x53fb2f(0x1a9)]}),loggerService_1['loggerService']['logWebhookProcessed']('plisio',_0x2eaedd['id'],_0x2eaedd[_0x53fb2f(0x1e4)],_0xd16b07[_0x53fb2f(0x1e4)],_0x2d8b7e);}catch(_0x1aa103){console[_0x53fb2f(0x241)](_0x53fb2f(0x167),_0x1aa103),loggerService_1['loggerService'][_0x53fb2f(0x21d)](_0x53fb2f(0x1ff),_0x1aa103,_0x2d8b7e);throw _0x1aa103;}}async['processPlisioGatewayWebhook'](_0x4b89f1){const _0x2cd50e=a69_0x4709cf;console[_0x2cd50e(0x225)](_0x2cd50e(0x12b),_0x4b89f1);try{const _0x3fc97e=await this[_0x2cd50e(0x24c)][_0x2cd50e(0x16a)](_0x4b89f1);if(!_0x3fc97e[_0x2cd50e(0x13e)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x8d1c7c=await database_1[_0x2cd50e(0x133)][_0x2cd50e(0x142)]['findFirst']({'where':{'gatewayOrderId':_0x3fc97e['paymentId']}});if(!_0x8d1c7c){console[_0x2cd50e(0x241)](_0x2cd50e(0x190)+_0x3fc97e[_0x2cd50e(0x13e)]);return;}console[_0x2cd50e(0x225)](_0x2cd50e(0x1c3)+_0x8d1c7c['id']+_0x2cd50e(0x23a)+_0x3fc97e[_0x2cd50e(0x1e4)]),await this[_0x2cd50e(0x157)](_0x8d1c7c['id'],_0x3fc97e[_0x2cd50e(0x1e4)],{'txUrls':_0x3fc97e[_0x2cd50e(0x1a9)]}),loggerService_1[_0x2cd50e(0x130)][_0x2cd50e(0x237)](_0x2cd50e(0x154),_0x8d1c7c['id'],_0x8d1c7c['status'],_0x3fc97e[_0x2cd50e(0x1e4)],_0x4b89f1);}catch(_0x1886f5){console[_0x2cd50e(0x241)](_0x2cd50e(0x18f),_0x1886f5),loggerService_1[_0x2cd50e(0x130)][_0x2cd50e(0x21d)](_0x2cd50e(0x154),_0x1886f5,_0x4b89f1);throw _0x1886f5;}}async[a69_0x4709cf(0x141)](_0xdadb02){const _0x25a1c9=a69_0x4709cf;console[_0x25a1c9(0x225)](_0x25a1c9(0x1c7),_0xdadb02);try{const _0x3c60cf=await this['rapydService'][_0x25a1c9(0x16a)](_0xdadb02);if(!_0x3c60cf[_0x25a1c9(0x13e)])throw new Error(_0x25a1c9(0x1e0));const _0x1eec92=await database_1['default'][_0x25a1c9(0x142)][_0x25a1c9(0x22b)]({'where':{'gatewayOrderId':_0x3c60cf[_0x25a1c9(0x13e)]}});if(!_0x1eec92){console[_0x25a1c9(0x241)](_0x25a1c9(0x22c)+_0x3c60cf['paymentId']);return;}console[_0x25a1c9(0x225)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x1eec92['id']+_0x25a1c9(0x23a)+_0x3c60cf[_0x25a1c9(0x1e4)]),await this[_0x25a1c9(0x157)](_0x1eec92['id'],_0x3c60cf[_0x25a1c9(0x1e4)],{'failureMessage':_0x3c60cf[_0x25a1c9(0x25d)],'cardLast4':_0x3c60cf[_0x25a1c9(0x252)]?.['cardLast4'],'paymentMethod':_0x3c60cf[_0x25a1c9(0x252)]?.[_0x25a1c9(0x23f)]}),loggerService_1[_0x25a1c9(0x130)][_0x25a1c9(0x237)](_0x25a1c9(0x210),_0x1eec92['id'],_0x1eec92['status'],_0x3c60cf['status'],_0xdadb02);}catch(_0x41cae6){console[_0x25a1c9(0x241)]('Error\x20processing\x20Rapyd\x20webhook:',_0x41cae6),loggerService_1[_0x25a1c9(0x130)][_0x25a1c9(0x21d)]('rapyd',_0x41cae6,_0xdadb02);throw _0x41cae6;}}async['processNodaWebhook'](_0x2e48e0){const _0x5079b4=a69_0x4709cf;console[_0x5079b4(0x225)](_0x5079b4(0x200),_0x2e48e0);try{const _0x4756d0=await this['nodaService'][_0x5079b4(0x16a)](_0x2e48e0);if(!_0x4756d0[_0x5079b4(0x13e)])throw new Error(_0x5079b4(0x128));const _0x4368aa=await database_1[_0x5079b4(0x133)]['payment'][_0x5079b4(0x22b)]({'where':{'gatewayOrderId':_0x4756d0[_0x5079b4(0x13e)]}});if(!_0x4368aa){console[_0x5079b4(0x241)]('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x4756d0['paymentId']);return;}console[_0x5079b4(0x225)](_0x5079b4(0x178)+_0x4368aa['id']+_0x5079b4(0x23a)+_0x4756d0[_0x5079b4(0x1e4)]),await this['updatePaymentStatus'](_0x4368aa['id'],_0x4756d0[_0x5079b4(0x1e4)],{'bankId':_0x4756d0['additionalInfo']?.[_0x5079b4(0x229)],'remitterIban':_0x4756d0[_0x5079b4(0x252)]?.[_0x5079b4(0x143)],'remitterName':_0x4756d0[_0x5079b4(0x252)]?.[_0x5079b4(0x12e)]}),loggerService_1[_0x5079b4(0x130)][_0x5079b4(0x237)](_0x5079b4(0x255),_0x4368aa['id'],_0x4368aa['status'],_0x4756d0['status'],_0x2e48e0);}catch(_0x2d94dc){console[_0x5079b4(0x241)]('Error\x20processing\x20Noda\x20webhook:',_0x2d94dc),loggerService_1[_0x5079b4(0x130)][_0x5079b4(0x21d)](_0x5079b4(0x255),_0x2d94dc,_0x2e48e0);throw _0x2d94dc;}}async['processCoinToPayWebhook'](_0x19f3e4){const _0x4eb539=a69_0x4709cf;console['log'](_0x4eb539(0x17d),_0x19f3e4);try{const _0x28e5e9=await this[_0x4eb539(0x20b)][_0x4eb539(0x16a)](_0x19f3e4);if(!_0x28e5e9[_0x4eb539(0x13e)])throw new Error(_0x4eb539(0x14f));const _0xfa4345=await database_1[_0x4eb539(0x133)][_0x4eb539(0x142)][_0x4eb539(0x22b)]({'where':{'gatewayOrderId':_0x28e5e9[_0x4eb539(0x13e)]}});if(!_0xfa4345){console['error'](_0x4eb539(0x1fe)+_0x28e5e9[_0x4eb539(0x13e)]);return;}console[_0x4eb539(0x225)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0xfa4345['id']+'\x20status\x20'+_0x28e5e9[_0x4eb539(0x1e4)]),await this[_0x4eb539(0x157)](_0xfa4345['id'],_0x28e5e9['status']),loggerService_1[_0x4eb539(0x130)]['logWebhookProcessed']('cointopay',_0xfa4345['id'],_0xfa4345[_0x4eb539(0x1e4)],_0x28e5e9[_0x4eb539(0x1e4)],_0x19f3e4);}catch(_0x5d5ee0){console['error']('Error\x20processing\x20CoinToPay\x20webhook:',_0x5d5ee0),loggerService_1['loggerService']['logWebhookError'](_0x4eb539(0x164),_0x5d5ee0,_0x19f3e4);throw _0x5d5ee0;}}async[a69_0x4709cf(0x162)](_0x15ba32){const _0x2751ba=a69_0x4709cf;console[_0x2751ba(0x225)](_0x2751ba(0x1d3),_0x15ba32);try{const _0x143b98=await this['coinToPay2Service']['processWebhook'](_0x15ba32);if(!_0x143b98['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook');const _0x37349e=await database_1[_0x2751ba(0x133)][_0x2751ba(0x142)]['findFirst']({'where':{'gatewayOrderId':_0x143b98[_0x2751ba(0x13e)]}});if(!_0x37349e){console[_0x2751ba(0x241)](_0x2751ba(0x13a)+_0x143b98[_0x2751ba(0x13e)]);return;}console['log'](_0x2751ba(0x14e)+_0x37349e['id']+_0x2751ba(0x23a)+_0x143b98[_0x2751ba(0x1e4)]),await this[_0x2751ba(0x157)](_0x37349e['id'],_0x143b98['status']),loggerService_1[_0x2751ba(0x130)][_0x2751ba(0x237)](_0x2751ba(0x168),_0x37349e['id'],_0x37349e[_0x2751ba(0x1e4)],_0x143b98[_0x2751ba(0x1e4)],_0x15ba32);}catch(_0x12d072){console[_0x2751ba(0x241)](_0x2751ba(0x1ab),_0x12d072),loggerService_1[_0x2751ba(0x130)]['logWebhookError']('cointopay2',_0x12d072,_0x15ba32);throw _0x12d072;}}async[a69_0x4709cf(0x20d)](_0xa32254){const _0x474538=a69_0x4709cf;console[_0x474538(0x225)](_0x474538(0x191),_0xa32254);try{const _0x3b7af5=await this['klymeService']['processWebhook'](_0xa32254);if(!_0x3b7af5[_0x474538(0x13e)])throw new Error(_0x474538(0x256));const _0x323e7f=await database_1[_0x474538(0x133)][_0x474538(0x142)][_0x474538(0x22b)]({'where':{'gatewayOrderId':_0x3b7af5[_0x474538(0x13e)]}});if(!_0x323e7f){console[_0x474538(0x241)](_0x474538(0x169)+_0x3b7af5[_0x474538(0x13e)]);return;}console[_0x474538(0x225)](_0x474538(0x1b9)+_0x323e7f['id']+_0x474538(0x23a)+_0x3b7af5[_0x474538(0x1e4)]),await this['updatePaymentStatus'](_0x323e7f['id'],_0x3b7af5[_0x474538(0x1e4)],{'paymentMethod':_0x3b7af5[_0x474538(0x252)]?.[_0x474538(0x204)]}),loggerService_1[_0x474538(0x130)][_0x474538(0x237)](_0x474538(0x15a),_0x323e7f['id'],_0x323e7f['status'],_0x3b7af5['status'],_0xa32254);}catch(_0xf1eeea){console[_0x474538(0x241)](_0x474538(0x209),_0xf1eeea),loggerService_1[_0x474538(0x130)][_0x474538(0x21d)](_0x474538(0x15a),_0xf1eeea,_0xa32254);throw _0xf1eeea;}}async['processVisaWebhook'](_0x4c0080){const _0x7468fc=a69_0x4709cf;console[_0x7468fc(0x225)](_0x7468fc(0x158),JSON[_0x7468fc(0x208)](_0x4c0080,null,0x2));try{const _0x10051e=await this['visaMasterCardService'][_0x7468fc(0x16a)](_0x4c0080,_0x7468fc(0x21b));console[_0x7468fc(0x225)](_0x7468fc(0x228),_0x10051e);if(!_0x10051e['paymentId']){console[_0x7468fc(0x241)](_0x7468fc(0x233)),console[_0x7468fc(0x241)](_0x7468fc(0x244),Object[_0x7468fc(0x1d4)](_0x4c0080));throw new Error(_0x7468fc(0x1eb));}let _0x3c9102=null;console[_0x7468fc(0x225)](_0x7468fc(0x21f)+_0x10051e['paymentId']);if(_0x10051e[_0x7468fc(0x13e)]){console[_0x7468fc(0x225)](_0x7468fc(0x179)),console[_0x7468fc(0x225)]('🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:'),console[_0x7468fc(0x225)](_0x7468fc(0x13c)),console[_0x7468fc(0x225)](_0x7468fc(0x198)+_0x10051e[_0x7468fc(0x13e)]),console[_0x7468fc(0x225)](_0x7468fc(0x155)),_0x3c9102=await database_1['default'][_0x7468fc(0x142)]['findFirst']({'where':{'AND':[{'OR':[{'gateway':'visa/mastercard'},{'gateway':'mastercard'}]},{'OR':[{'gatewayPaymentId':_0x10051e['paymentId']},{'gatewayOrderId':_0x10051e[_0x7468fc(0x13e)]},{'id':_0x10051e[_0x7468fc(0x13e)]},{'orderId':_0x10051e[_0x7468fc(0x13e)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x7468fc(0x225)](_0x7468fc(0x1bc));if(_0x3c9102)console[_0x7468fc(0x225)](_0x7468fc(0x166)+_0x3c9102['id']+_0x7468fc(0x192)+_0x3c9102[_0x7468fc(0x1f2)]+_0x7468fc(0x249)+_0x3c9102[_0x7468fc(0x25c)]);else{console[_0x7468fc(0x225)](_0x7468fc(0x12c));const _0x1397b3=await database_1[_0x7468fc(0x133)][_0x7468fc(0x142)][_0x7468fc(0x124)]({'where':{'gateway':_0x7468fc(0x205)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x7468fc(0x16c)}});console['log']('🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:',_0x1397b3[_0x7468fc(0x16b)](_0x2ec34d=>_0x2ec34d['id']+_0x7468fc(0x217)+_0x2ec34d['orderId']+_0x7468fc(0x18a)+_0x2ec34d[_0x7468fc(0x1f2)]+_0x7468fc(0x1df)+_0x2ec34d[_0x7468fc(0x25c)]+_0x7468fc(0x197)+_0x2ec34d['cardLast4']+')'));}console[_0x7468fc(0x225)](_0x7468fc(0x1c8)+(_0x3c9102?_0x7468fc(0x19d):_0x7468fc(0x19c))),_0x3c9102&&console[_0x7468fc(0x225)](_0x7468fc(0x254)+_0x3c9102['id']+',\x20Gateway='+_0x3c9102[_0x7468fc(0x1f3)]+_0x7468fc(0x153)+_0x3c9102['status']+',\x20Card=****'+_0x3c9102[_0x7468fc(0x247)]);}if(!_0x3c9102){console[_0x7468fc(0x241)](_0x7468fc(0x13d)+_0x10051e['paymentId']),loggerService_1[_0x7468fc(0x130)][_0x7468fc(0x21d)](_0x7468fc(0x1fb),new Error(_0x7468fc(0x194)+_0x10051e['paymentId']),_0x4c0080);throw new Error(_0x7468fc(0x22a)+_0x10051e[_0x7468fc(0x13e)]);}console['log'](_0x7468fc(0x206)+_0x3c9102['id']+_0x7468fc(0x1a1)+_0x3c9102[_0x7468fc(0x1e4)]+_0x7468fc(0x1ee)+_0x10051e['status']+')');const _0x4ce92c={};_0x10051e[_0x7468fc(0x1db)]&&await database_1['default']['payment'][_0x7468fc(0x15d)]({'where':{'id':_0x3c9102['id']},'data':{'amount':_0x10051e[_0x7468fc(0x1db)],'updatedAt':new Date()}}),_0x10051e[_0x7468fc(0x161)]&&await database_1[_0x7468fc(0x133)][_0x7468fc(0x142)][_0x7468fc(0x15d)]({'where':{'id':_0x3c9102['id']},'data':{'currency':_0x10051e['currency'],'updatedAt':new Date()}}),_0x10051e[_0x7468fc(0x1e4)]===_0x7468fc(0x1be)&&_0x10051e[_0x7468fc(0x1d0)]&&(_0x4ce92c[_0x7468fc(0x25d)]=_0x10051e['errorMessage'],console[_0x7468fc(0x225)](_0x7468fc(0x24d)+_0x10051e[_0x7468fc(0x1d0)])),_0x4ce92c[_0x7468fc(0x23f)]=_0x7468fc(0x1fb),await this[_0x7468fc(0x157)](_0x3c9102['id'],_0x10051e[_0x7468fc(0x1e4)],_0x4ce92c),await database_1[_0x7468fc(0x133)]['webhookLog'][_0x7468fc(0x21e)]({'data':{'paymentId':_0x3c9102['id'],'shopId':_0x3c9102[_0x7468fc(0x1ec)],'event':_0x7468fc(0x250)+_0x10051e['status'][_0x7468fc(0x1c6)](),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x10051e)}}),await this['sendPaymentStatusNotification'](_0x3c9102,_0x10051e['status']['toUpperCase']()),console[_0x7468fc(0x225)](_0x7468fc(0x17f)+_0x3c9102['id']);}catch(_0x3eb637){console[_0x7468fc(0x241)](_0x7468fc(0x1fc),_0x3eb637),loggerService_1[_0x7468fc(0x130)][_0x7468fc(0x21d)](_0x7468fc(0x1fb),_0x3eb637,_0x4c0080);throw _0x3eb637;}}async[a69_0x4709cf(0x1ce)](_0x5cb103){const _0x3aa0b9=a69_0x4709cf;console[_0x3aa0b9(0x225)](_0x3aa0b9(0x187),JSON[_0x3aa0b9(0x208)](_0x5cb103,null,0x2));try{const _0x2d9a98=await this[_0x3aa0b9(0x19a)][_0x3aa0b9(0x16a)](_0x5cb103,_0x3aa0b9(0x14c));console[_0x3aa0b9(0x225)](_0x3aa0b9(0x12d),_0x2d9a98);if(!_0x2d9a98[_0x3aa0b9(0x13e)]){console['error']('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data'),console[_0x3aa0b9(0x241)](_0x3aa0b9(0x244),Object[_0x3aa0b9(0x1d4)](_0x5cb103));throw new Error(_0x3aa0b9(0x22d));}let _0x168b7f=null;console['log'](_0x3aa0b9(0x25a)+_0x2d9a98[_0x3aa0b9(0x13e)]);_0x2d9a98[_0x3aa0b9(0x13e)]&&(console['log']('🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x168b7f=await database_1[_0x3aa0b9(0x133)][_0x3aa0b9(0x142)][_0x3aa0b9(0x22b)]({'where':{'AND':[{'OR':[{'gateway':_0x3aa0b9(0x1b5)},{'gateway':_0x3aa0b9(0x1b7)},{'gateway':'visa/mastercard'}]},{'OR':[{'gatewayPaymentId':_0x2d9a98[_0x3aa0b9(0x13e)]},{'gatewayOrderId':_0x2d9a98[_0x3aa0b9(0x13e)]},{'id':_0x2d9a98[_0x3aa0b9(0x13e)]},{'orderId':_0x2d9a98[_0x3aa0b9(0x13e)]}]}]}}),console[_0x3aa0b9(0x225)]('🔍\x20Search\x20result:\x20'+(_0x168b7f?_0x3aa0b9(0x258)+_0x168b7f['id']:_0x3aa0b9(0x239))));if(!_0x168b7f){console['error'](_0x3aa0b9(0x1c5)+_0x2d9a98[_0x3aa0b9(0x13e)]),console[_0x3aa0b9(0x241)](_0x3aa0b9(0x1cf)+_0x2d9a98[_0x3aa0b9(0x13e)]+'\x22,\x20id=\x22'+_0x2d9a98[_0x3aa0b9(0x13e)]+'\x22,\x20orderId=\x22'+_0x2d9a98['paymentId']+'\x22');const _0x57517f=await database_1[_0x3aa0b9(0x133)]['payment'][_0x3aa0b9(0x124)]({'where':{'OR':[{'gateway':_0x3aa0b9(0x1b7)},{'gateway':'visa_mastercard'},{'gateway':'visa/mastercard'}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x3aa0b9(0x16c)},'take':0xf});console[_0x3aa0b9(0x225)]('🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:',_0x57517f),loggerService_1[_0x3aa0b9(0x130)]['logWebhookError'](_0x3aa0b9(0x1b7),new Error(_0x3aa0b9(0x194)+_0x2d9a98[_0x3aa0b9(0x13e)]),_0x5cb103);throw new Error('MasterCard\x20payment\x20not\x20found:\x20'+_0x2d9a98[_0x3aa0b9(0x13e)]);}console[_0x3aa0b9(0x225)](_0x3aa0b9(0x1e9)+_0x168b7f['id']+_0x3aa0b9(0x1bd)+_0x168b7f['status']+'\x20to\x20'+_0x2d9a98['status']);const _0x547f3d={};_0x2d9a98['amount']&&await database_1[_0x3aa0b9(0x133)][_0x3aa0b9(0x142)][_0x3aa0b9(0x15d)]({'where':{'id':_0x168b7f['id']},'data':{'amount':_0x2d9a98[_0x3aa0b9(0x1db)],'updatedAt':new Date()}}),_0x2d9a98[_0x3aa0b9(0x161)]&&await database_1[_0x3aa0b9(0x133)][_0x3aa0b9(0x142)][_0x3aa0b9(0x15d)]({'where':{'id':_0x168b7f['id']},'data':{'currency':_0x2d9a98[_0x3aa0b9(0x161)],'updatedAt':new Date()}}),_0x2d9a98[_0x3aa0b9(0x1e4)]==='FAILED'&&_0x2d9a98[_0x3aa0b9(0x1d0)]&&(_0x547f3d[_0x3aa0b9(0x25d)]=_0x2d9a98[_0x3aa0b9(0x1d0)],console['log']('❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20'+_0x2d9a98[_0x3aa0b9(0x1d0)])),_0x547f3d[_0x3aa0b9(0x23f)]=_0x3aa0b9(0x1b7),await this[_0x3aa0b9(0x157)](_0x168b7f['id'],_0x2d9a98[_0x3aa0b9(0x1e4)],_0x547f3d),loggerService_1[_0x3aa0b9(0x130)][_0x3aa0b9(0x237)](_0x3aa0b9(0x1b7),_0x168b7f['id'],_0x168b7f[_0x3aa0b9(0x1e4)],_0x2d9a98[_0x3aa0b9(0x1e4)],_0x5cb103);}catch(_0x183d24){console[_0x3aa0b9(0x241)](_0x3aa0b9(0x144),_0x183d24),loggerService_1[_0x3aa0b9(0x130)]['logWebhookError'](_0x3aa0b9(0x1b7),_0x183d24,_0x5cb103);throw _0x183d24;}}async[a69_0x4709cf(0x20f)](_0x2ab9b1){const _0x5c21e1=a69_0x4709cf;console['log']('🔄\x20Processing\x20Amer\x20webhook:',JSON['stringify'](_0x2ab9b1,null,0x2));try{const _0x56edf3=await this[_0x5c21e1(0x236)][_0x5c21e1(0x16a)](_0x2ab9b1);console[_0x5c21e1(0x225)](_0x5c21e1(0x17a),_0x56edf3);if(!_0x56edf3['paymentId']){console[_0x5c21e1(0x241)](_0x5c21e1(0x188)),console['error'](_0x5c21e1(0x244),Object[_0x5c21e1(0x1d4)](_0x2ab9b1));throw new Error(_0x5c21e1(0x15e));}let _0x17e449=null;console[_0x5c21e1(0x225)](_0x5c21e1(0x180)+_0x56edf3[_0x5c21e1(0x13e)]),_0x17e449=await database_1['default'][_0x5c21e1(0x142)][_0x5c21e1(0x22b)]({'where':{'AND':[{'gateway':'amer'},{'OR':[{'gatewayPaymentId':_0x56edf3['paymentId']},{'gatewayOrderId':_0x56edf3[_0x5c21e1(0x13e)]},{'id':_0x56edf3[_0x5c21e1(0x13e)]},{'orderId':_0x56edf3[_0x5c21e1(0x13e)]}]}]}}),console['log'](_0x5c21e1(0x149)+(_0x17e449?_0x5c21e1(0x258)+_0x17e449['id']:_0x5c21e1(0x239)));if(!_0x17e449){console[_0x5c21e1(0x241)](_0x5c21e1(0x21a)+_0x56edf3[_0x5c21e1(0x13e)]);return;}console[_0x5c21e1(0x225)](_0x5c21e1(0x23d)+_0x17e449['id']+_0x5c21e1(0x23a)+_0x56edf3[_0x5c21e1(0x1e4)]),await this['updatePaymentStatus'](_0x17e449['id'],_0x56edf3['status'],{'cardLast4':_0x56edf3[_0x5c21e1(0x252)]?.[_0x5c21e1(0x247)],'paymentMethod':_0x56edf3[_0x5c21e1(0x252)]?.[_0x5c21e1(0x23f)]});}catch(_0x3aa26b){console[_0x5c21e1(0x241)](_0x5c21e1(0x17b),_0x3aa26b),loggerService_1[_0x5c21e1(0x130)][_0x5c21e1(0x21d)](_0x5c21e1(0x235),_0x3aa26b,_0x2ab9b1);throw _0x3aa26b;}}async[a69_0x4709cf(0x1bb)](_0x26cc51){const _0x1f4735=a69_0x4709cf;console[_0x1f4735(0x225)](_0x1f4735(0x1d9),JSON[_0x1f4735(0x208)](_0x26cc51,null,0x2));try{const _0x1855e0=_0x26cc51[_0x1f4735(0x1e4)],_0x48daa8=_0x26cc51[_0x1f4735(0x150)],_0x22de5c=_0x26cc51[_0x1f4735(0x15b)],_0xdadd13=_0x26cc51[_0x1f4735(0x204)],_0x3904ca=_0x26cc51[_0x1f4735(0x1db)],_0x5029ec=_0x26cc51['currency'],_0x25f090=_0x26cc51['commission'],_0x5a635e=_0x26cc51[_0x1f4735(0x1d2)];if(!_0x48daa8){console[_0x1f4735(0x241)](_0x1f4735(0x257));throw new Error(_0x1f4735(0x177));}console[_0x1f4735(0x225)]('📊\x20AmPay\x20webhook\x20data:',{'status':_0x1855e0,'clientTransactionId':_0x48daa8,'systemId':_0x22de5c,'paymentMethod':_0xdadd13,'amount':_0x3904ca,'currency':_0x5029ec,'commission':_0x25f090,'statusAdditionInfo':_0x5a635e});const _0xe63e16=await database_1[_0x1f4735(0x133)][_0x1f4735(0x142)][_0x1f4735(0x22b)]({'where':{'OR':[{'gatewayOrderId':_0x48daa8},{'orderId':_0x48daa8},{'id':_0x48daa8},{'gatewayPaymentId':_0x48daa8}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0xe63e16){console[_0x1f4735(0x241)]('❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20'+_0x48daa8);throw new Error(_0x1f4735(0x194)+_0x48daa8);}console[_0x1f4735(0x225)]('✅\x20Found\x20payment\x20'+_0xe63e16['id']+_0x1f4735(0x238)),console[_0x1f4735(0x225)](_0x1f4735(0x1e6)+_0xe63e16[_0x1f4735(0x1e4)]+_0x1f4735(0x1ee)+_0x1855e0),_0x1855e0==='DECLINED'?(console[_0x1f4735(0x225)](_0x1f4735(0x193)),await this[_0x1f4735(0x157)](_0xe63e16['id'],_0x1f4735(0x1be)),console[_0x1f4735(0x225)](_0x1f4735(0x215)+_0xe63e16['id']+_0x1f4735(0x23c)),console[_0x1f4735(0x225)](_0x1f4735(0x20e)+(_0x5a635e||_0x1f4735(0x245)))):console[_0x1f4735(0x225)](_0x1f4735(0x218)+_0x1855e0+'\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)'),await database_1[_0x1f4735(0x133)][_0x1f4735(0x1f1)][_0x1f4735(0x21e)]({'data':{'paymentId':_0xe63e16['id'],'shopId':_0xe63e16[_0x1f4735(0x1ec)],'event':'ampay_'+(_0x1855e0?.[_0x1f4735(0x1c6)]()||_0x1f4735(0x1fd)),'statusCode':0xc8,'responseBody':JSON[_0x1f4735(0x208)](_0x26cc51)}}),loggerService_1[_0x1f4735(0x130)][_0x1f4735(0x237)](_0x1f4735(0x1a5),_0xe63e16['id'],_0xe63e16[_0x1f4735(0x1e4)],_0x1855e0==='DECLINED'?_0x1f4735(0x1be):_0x1855e0,_0x26cc51);}catch(_0x3f2385){console['error'](_0x1f4735(0x18e),_0x3f2385),loggerService_1[_0x1f4735(0x130)][_0x1f4735(0x21d)](_0x1f4735(0x1a5),_0x3f2385,_0x26cc51);throw _0x3f2385;}}async[a69_0x4709cf(0x1ba)](_0xc383f6){const _0x4663d9=a69_0x4709cf;console[_0x4663d9(0x225)]('🔄\x20Processing\x20AmPay\x20TRY\x20webhook:',JSON[_0x4663d9(0x208)](_0xc383f6,null,0x2));try{const _0x113b6a=_0xc383f6[_0x4663d9(0x1e4)],_0x390e87=_0xc383f6[_0x4663d9(0x150)],_0x5bbd81=_0xc383f6[_0x4663d9(0x15b)],_0x5e0a6c=_0xc383f6[_0x4663d9(0x204)],_0x5659c0=_0xc383f6[_0x4663d9(0x1db)],_0x2dc6b4=_0xc383f6[_0x4663d9(0x161)],_0x3140cf=_0xc383f6['commission'],_0x1af074=_0xc383f6[_0x4663d9(0x1d2)];if(!_0x390e87){console[_0x4663d9(0x241)](_0x4663d9(0x186));throw new Error(_0x4663d9(0x170));}console['log'](_0x4663d9(0x1c1),{'status':_0x113b6a,'clientTransactionId':_0x390e87,'systemId':_0x5bbd81,'paymentMethod':_0x5e0a6c,'amount':_0x5659c0,'currency':_0x2dc6b4,'commission':_0x3140cf,'statusAdditionInfo':_0x1af074});const _0x34633d=await database_1[_0x4663d9(0x133)]['payment'][_0x4663d9(0x22b)]({'where':{'OR':[{'gatewayOrderId':_0x390e87},{'orderId':_0x390e87},{'id':_0x390e87},{'gatewayPaymentId':_0x390e87}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x34633d){console[_0x4663d9(0x241)](_0x4663d9(0x136)+_0x390e87);throw new Error(_0x4663d9(0x194)+_0x390e87);}console[_0x4663d9(0x225)](_0x4663d9(0x1e9)+_0x34633d['id']+_0x4663d9(0x1d7)),console['log']('📊\x20Payment\x20status:\x20'+_0x34633d['status']+_0x4663d9(0x1ee)+_0x113b6a),_0x113b6a==='DECLINED'?(console[_0x4663d9(0x225)](_0x4663d9(0x199)),await this[_0x4663d9(0x157)](_0x34633d['id'],_0x4663d9(0x1be)),console[_0x4663d9(0x225)](_0x4663d9(0x1e7)+_0x34633d['id']+'\x20status\x20updated\x20to\x20FAILED'),console[_0x4663d9(0x225)](_0x4663d9(0x20e)+(_0x1af074||_0x4663d9(0x245)))):console[_0x4663d9(0x225)](_0x4663d9(0x159)+_0x113b6a+_0x4663d9(0x203)),await database_1[_0x4663d9(0x133)][_0x4663d9(0x1f1)]['create']({'data':{'paymentId':_0x34633d['id'],'shopId':_0x34633d[_0x4663d9(0x1ec)],'event':_0x4663d9(0x17c)+(_0x113b6a?.['toLowerCase']()||'unknown'),'statusCode':0xc8,'responseBody':JSON[_0x4663d9(0x208)](_0xc383f6)}}),loggerService_1[_0x4663d9(0x130)][_0x4663d9(0x237)](_0x4663d9(0x145),_0x34633d['id'],_0x34633d['status'],_0x113b6a===_0x4663d9(0x1aa)?'FAILED':_0x113b6a,_0xc383f6);}catch(_0x2873a5){console[_0x4663d9(0x241)](_0x4663d9(0x184),_0x2873a5),loggerService_1[_0x4663d9(0x130)][_0x4663d9(0x21d)]('ampay_try',_0x2873a5,_0xc383f6);throw _0x2873a5;}}async['sendShopWebhook'](_0x5db6fd,_0x81bc04){const _0x4b93a5=a69_0x4709cf,_0x192c20=Date['now']();try{const _0x4e0086=_0x5db6fd[_0x4b93a5(0x160)],_0x189055=_0x4e0086[_0x4b93a5(0x18c)];if(!_0x189055?.[_0x4b93a5(0x1a0)]){console['log'](_0x4b93a5(0x140)+_0x4e0086['id']);return;}const _0x35fdbe=_0x81bc04===_0x4b93a5(0x195)?_0x4b93a5(0x1ea):_0x81bc04===_0x4b93a5(0x1be)?_0x4b93a5(0x212):_0x81bc04===_0x4b93a5(0x21c)?'payment.failed':_0x81bc04===_0x4b93a5(0x223)?_0x4b93a5(0x212):_0x81bc04===_0x4b93a5(0x1f0)?_0x4b93a5(0x212):_0x4b93a5(0x20c);let _0x3acedd=[];if(_0x189055[_0x4b93a5(0x1f6)])try{_0x3acedd=Array[_0x4b93a5(0x24f)](_0x189055[_0x4b93a5(0x1f6)])?_0x189055[_0x4b93a5(0x1f6)]:JSON['parse'](_0x189055[_0x4b93a5(0x1f6)]);}catch(_0x54684e){console[_0x4b93a5(0x241)]('Error\x20parsing\x20webhook\x20events:',_0x54684e),_0x3acedd=[];}if(!_0x3acedd[_0x4b93a5(0x1a4)](_0x35fdbe)){console[_0x4b93a5(0x225)]('Webhook\x20event\x20'+_0x35fdbe+'\x20not\x20enabled\x20for\x20shop\x20'+_0x4e0086['id']);return;}const _0x3e482d={'event':_0x35fdbe,'payment':{'id':_0x5db6fd['id'],'order_id':_0x5db6fd[_0x4b93a5(0x15c)],'gateway_order_id':_0x5db6fd[_0x4b93a5(0x1f2)],'gateway':_0x5db6fd[_0x4b93a5(0x1f3)],'amount':_0x5db6fd['amount'],'currency':_0x5db6fd['currency'],'status':_0x81bc04[_0x4b93a5(0x1c6)](),'customer_email':_0x5db6fd['customerEmail'],'customer_name':_0x5db6fd[_0x4b93a5(0x259)],'failure_message':_0x5db6fd['failureMessage'],'tx_urls':_0x5db6fd['txUrls']?JSON[_0x4b93a5(0x224)](_0x5db6fd[_0x4b93a5(0x1a9)]):null,'created_at':_0x5db6fd['createdAt'],'updated_at':_0x5db6fd[_0x4b93a5(0x232)]}},_0x5f1add=await fetch(_0x189055['webhookUrl'],{'method':_0x4b93a5(0x1cb),'headers':{'Content-Type':_0x4b93a5(0x1b0),'User-Agent':'Payment\x20System/1.0'},'body':JSON[_0x4b93a5(0x208)](_0x3e482d)}),_0x435465=Date['now']()-_0x192c20,_0x519702=_0x5f1add['ok']?'Success':await _0x5f1add[_0x4b93a5(0x181)]();loggerService_1['loggerService'][_0x4b93a5(0x14d)](_0x5db6fd[_0x4b93a5(0x1ec)],_0x189055[_0x4b93a5(0x1a0)],_0x35fdbe,_0x5f1add[_0x4b93a5(0x1e4)],_0x435465,_0x3e482d),console[_0x4b93a5(0x225)](_0x4b93a5(0x147)+_0x189055[_0x4b93a5(0x1a0)]+_0x4b93a5(0x262)+_0x5f1add['status']+'\x20('+_0x435465+_0x4b93a5(0x18d));}catch(_0x240a60){console[_0x4b93a5(0x241)](_0x4b93a5(0x227),_0x240a60),loggerService_1[_0x4b93a5(0x130)][_0x4b93a5(0x1c2)](_0x5db6fd['shopId'],_0x5db6fd[_0x4b93a5(0x160)]?.[_0x4b93a5(0x18c)]?.[_0x4b93a5(0x1a0)]||_0x4b93a5(0x1fd),_0x4b93a5(0x134),_0x240a60,{});}}async[a69_0x4709cf(0x243)](_0x953862,_0x5d4338){const _0x8698e7=a69_0x4709cf;try{const _0x4fc541={'PENDING':'created','PROCESSING':'processing','PAID':'paid','FAILED':_0x8698e7(0x24a),'EXPIRED':_0x8698e7(0x175),'REFUND':'refund','CHARGEBACK':_0x8698e7(0x1ad)},_0x4cd4d6=_0x4fc541[_0x5d4338];if(!_0x4cd4d6||_0x4cd4d6==='created')return;await telegramBotService_1[_0x8698e7(0x14b)][_0x8698e7(0x1f5)](_0x953862[_0x8698e7(0x1ec)],_0x953862,_0x4cd4d6);}catch(_0xf3a958){console[_0x8698e7(0x241)](_0x8698e7(0x1dd),_0xf3a958);}}async[a69_0x4709cf(0x1cd)](_0xea30e9,_0x56cbdd){const _0x40956f=a69_0x4709cf;try{const _0x4d51fc=await database_1[_0x40956f(0x133)][_0x40956f(0x160)][_0x40956f(0x131)]({'where':{'id':_0xea30e9},'select':{'gatewaySettings':!![]}});if(!_0x4d51fc?.['gatewaySettings'])return console[_0x40956f(0x225)](_0x40956f(0x1bf)+_0xea30e9+_0x40956f(0x16d)),0xa;const _0x2aaeed=JSON[_0x40956f(0x224)](_0x4d51fc['gatewaySettings']);for(const [_0x59841b,_0x4dae51]of Object[_0x40956f(0x165)](_0x2aaeed)){if(_0x59841b[_0x40956f(0x1c6)]()===_0x56cbdd[_0x40956f(0x1c6)]()){const _0x3444a4=_0x4dae51['commission']||0xa;return console[_0x40956f(0x225)]('Gateway\x20'+_0x56cbdd+_0x40956f(0x1a8)+_0xea30e9+':\x20'+_0x3444a4+'%'),_0x3444a4;}}return console[_0x40956f(0x225)](_0x40956f(0x240)+_0x56cbdd+_0x40956f(0x13b)+_0xea30e9+',\x20using\x20default\x2010%'),0xa;}catch(_0x4192f3){return console[_0x40956f(0x241)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0xea30e9+_0x40956f(0x18b)+_0x56cbdd+':',_0x4192f3),0xa;}}async[a69_0x4709cf(0x1da)](_0x432122,_0xb1703d){const _0x4a4cb4=a69_0x4709cf;console[_0x4a4cb4(0x225)](_0x4a4cb4(0x1c0)),console[_0x4a4cb4(0x225)]('Query\x20params:',JSON[_0x4a4cb4(0x208)](_0x432122,null,0x2)),console[_0x4a4cb4(0x225)](_0x4a4cb4(0x148),JSON['stringify'](_0xb1703d,null,0x2));try{const _0x28fad9=_0x432122[_0x4a4cb4(0x22f)]||_0xb1703d['customerOrderId'],_0x126b0d=_0x432122['status']||_0xb1703d['status'],_0x318193=_0x432122['amount']||_0xb1703d[_0x4a4cb4(0x1db)],_0x5de00a=_0x432122['currency']||_0xb1703d[_0x4a4cb4(0x161)],_0x3eb2a4=_0x432122[_0x4a4cb4(0x17e)]||_0xb1703d['dateTime'];if(!_0x28fad9){console[_0x4a4cb4(0x241)](_0x4a4cb4(0x263));throw new Error(_0x4a4cb4(0x23b));}console[_0x4a4cb4(0x225)]('📊\x20MyXSpend\x20webhook\x20data:',{'customerOrderId':_0x28fad9,'status':_0x126b0d,'amount':_0x318193,'currency':_0x5de00a,'dateTime':_0x3eb2a4});const _0x45d32e=await database_1['default'][_0x4a4cb4(0x142)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x28fad9},{'orderId':_0x28fad9},{'id':_0x28fad9},{'gatewayPaymentId':_0x28fad9}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x45d32e){console[_0x4a4cb4(0x241)]('❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20'+_0x28fad9);throw new Error('Payment\x20not\x20found:\x20'+_0x28fad9);}console[_0x4a4cb4(0x225)](_0x4a4cb4(0x1e9)+_0x45d32e['id']+_0x4a4cb4(0x1ae)),console['log'](_0x4a4cb4(0x1e6)+_0x45d32e[_0x4a4cb4(0x1e4)]+_0x4a4cb4(0x1ee)+_0x126b0d);let _0x69af0b=_0x126b0d?.[_0x4a4cb4(0x185)]();_0x126b0d===_0x4a4cb4(0x1be)||_0x126b0d===_0x4a4cb4(0x21c)?(_0x69af0b=_0x4a4cb4(0x1be),console[_0x4a4cb4(0x225)](_0x4a4cb4(0x230)+_0x126b0d+_0x4a4cb4(0x211)),await this[_0x4a4cb4(0x157)](_0x45d32e['id'],_0x69af0b),console[_0x4a4cb4(0x225)]('✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20'+_0x45d32e['id']+'\x20status\x20updated\x20to\x20FAILED')):console[_0x4a4cb4(0x225)](_0x4a4cb4(0x1ef)+_0x126b0d+_0x4a4cb4(0x12a)),await database_1[_0x4a4cb4(0x133)]['webhookLog'][_0x4a4cb4(0x21e)]({'data':{'paymentId':_0x45d32e['id'],'shopId':_0x45d32e[_0x4a4cb4(0x1ec)],'event':_0x4a4cb4(0x220)+(_0x126b0d?.[_0x4a4cb4(0x1c6)]()||_0x4a4cb4(0x1fd)),'statusCode':0xc8,'responseBody':JSON[_0x4a4cb4(0x208)]({'queryParams':_0x432122,'bodyData':_0xb1703d})}}),loggerService_1['loggerService'][_0x4a4cb4(0x237)](_0x4a4cb4(0x242),_0x45d32e['id'],_0x45d32e[_0x4a4cb4(0x1e4)],_0x69af0b||_0x126b0d,{'queryParams':_0x432122,'bodyData':_0xb1703d});}catch(_0x69e16f){console[_0x4a4cb4(0x241)]('❌\x20Error\x20processing\x20MyXSpend\x20webhook:',_0x69e16f),loggerService_1[_0x4a4cb4(0x130)][_0x4a4cb4(0x21d)](_0x4a4cb4(0x242),_0x69e16f,{'queryParams':_0x432122,'bodyData':_0xb1703d});throw _0x69e16f;}}}exports[a69_0x4709cf(0x156)]=WebhookService;