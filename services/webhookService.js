'use strict';const a57_0x2ef368=a57_0x1eaa;function a57_0x1eaa(_0x49daff,_0x232548){const _0x3e2810=a57_0x3e28();return a57_0x1eaa=function(_0x1eaa80,_0x3b78a7){_0x1eaa80=_0x1eaa80-0x1c5;let _0x5e5d77=_0x3e2810[_0x1eaa80];return _0x5e5d77;},a57_0x1eaa(_0x49daff,_0x232548);}(function(_0x390a13,_0x4308da){const _0x29478d=a57_0x1eaa,_0x2fbeba=_0x390a13();while(!![]){try{const _0x9272e1=-parseInt(_0x29478d(0x21d))/0x1+parseInt(_0x29478d(0x202))/0x2*(-parseInt(_0x29478d(0x24d))/0x3)+parseInt(_0x29478d(0x1f8))/0x4+-parseInt(_0x29478d(0x20e))/0x5*(parseInt(_0x29478d(0x1fa))/0x6)+-parseInt(_0x29478d(0x26a))/0x7+parseInt(_0x29478d(0x1e3))/0x8*(parseInt(_0x29478d(0x1e2))/0x9)+parseInt(_0x29478d(0x23a))/0xa*(parseInt(_0x29478d(0x274))/0xb);if(_0x9272e1===_0x4308da)break;else _0x2fbeba['push'](_0x2fbeba['shift']());}catch(_0x4eda07){_0x2fbeba['push'](_0x2fbeba['shift']());}}}(a57_0x3e28,0x4895e));var __importDefault=this&&this['__importDefault']||function(_0x58a04a){const _0x46a3a1=a57_0x1eaa;return _0x58a04a&&_0x58a04a[_0x46a3a1(0x216)]?_0x58a04a:{'default':_0x58a04a};};Object[a57_0x2ef368(0x209)](exports,a57_0x2ef368(0x216),{'value':!![]}),exports[a57_0x2ef368(0x1ce)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a57_0x2ef368(0x1ff)),nodaService_1=require(a57_0x2ef368(0x1e0)),coinToPayService_1=require(a57_0x2ef368(0x259)),klymeService_1=require(a57_0x2ef368(0x203)),mastercardService_1=require(a57_0x2ef368(0x260)),telegramBotService_1=require(a57_0x2ef368(0x233)),currencyService_1=require(a57_0x2ef368(0x23d)),loggerService_1=require('./loggerService');function a57_0x3e28(){const _0x3f036f=['payment.failed','sendShopWebhook','\x20USDT','FAILED','customerName','CHARGEBACK','processPlisioGatewayWebhook','2083844CReCEH','settings','6iUJzeK','plisio','mastercard','remitterName','processRapydWebhook','./gateways/rapydService','toUpperCase','\x20not\x20found','30616nSCMkj','./gateways/klymeService','bankId','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','cointopay','error','cardLast4','defineProperty','🔄\x20Processing\x20MasterCard\x20webhook:','includes','CoinToPayService','KlymeService','409485DyEatG','failed','\x20+\x20','nodaService','toISOString','username','createdAt','sendPaymentNotification','__esModule','📊\x20Rapyd\x20webhook:\x20Payment\x20','🔄\x20Processing\x20Plisio\x20webhook:','processMasterCardWebhook','toLowerCase','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','72187BaihPe','Error\x20processing\x20KLYME\x20webhook:','PlisioService','Success','amountUSDT','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','Error\x20processing\x20MasterCard\x20webhook:','payment.pending','\x20current\x20balance:\x20','shopId','rapyd','amount','chargeback','Error\x20parsing\x20webhook\x20events:','\x20-\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','Error\x20processing\x20Plisio\x20webhook:','gateway','webhookEvents','log','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','expired','./telegramBotService','currencyService','\x20USDT\x20(chargeback\x20penalty)','paymentMethod','processPlisioWebhook','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook','51670tVBzpf','toFixed','orderId','./currencyService','📊\x20KLYME\x20webhook:\x20Payment\x20','Error\x20processing\x20Rapyd\x20webhook:','txUrls','text','🔄\x20Updating\x20payment\x20','NodaService','parse','sendPaymentStatusNotification','logWebhookProcessed','\x20USDT\x20(payment\x20became\x20PAID)','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','🔄\x20Processing\x20Rapyd\x20webhook:','additionalInfo','balance','111pCxluA','🔄\x20Processing\x20KLYME\x20webhook:','processNodaWebhook','created','coinToPayService','updatePaymentStatus','payment','RapydService','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','paymentId','no\x20balance\x20change','shop','./gateways/coinToPayService','logWebhookError','findFirst','✅\x20Shop\x20','payment.success','webhookLog','processWebhook','./gateways/mastercardService','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','default','plisioService','💸\x20Additional\x20chargeback\x20penalty:\x20-','💰\x20Payment\x20','rapydService','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','klyme','findUnique','778512ZeMLAf','logShopWebhookSent','currency','📊\x20Noda\x20webhook:\x20Payment\x20','plisio_gateway','updatedAt','\x20with\x20status\x20','masterCardService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20status\x20','385zowsHL','webhookUrl','telegramBotService','\x20=\x20','TesSoft\x20Payment\x20System/1.0','PAID','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','POST','paidAt','status','WebhookService','Payment\x20not\x20found\x20for\x20MasterCard\x20webhook:\x20','📊\x20CoinToPay\x20webhook:\x20Payment\x20','💰\x20Adding\x20to\x20balance:\x20','failureMessage','MasterCardService','chargebackAmount','Error\x20processing\x20Noda\x20webhook:','remitterIban','now','processCoinToPayWebhook','ms)','🔄\x20Processing\x20CoinToPay\x20webhook:','application/json','update','🔄\x20Processing\x20Noda\x20webhook:','📤\x20Shop\x20webhook\x20sent\x20to\x20','\x20not\x20enabled\x20for\x20shop\x20','./gateways/nodaService','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','1080KkbrTR','28480UKkDTy','noda','stringify','system','logShopWebhookError','\x20->\x20','loggerService','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','\x20and\x20-','processKlymeWebhook','📝\x20Reason:\x20','🏪\x20Shop\x20','EXPIRED','Failed\x20to\x20send\x20shop\x20webhook:'];a57_0x3e28=function(){return _0x3f036f;};return a57_0x3e28();}class WebhookService{constructor(){const _0x488de5=a57_0x2ef368;this[_0x488de5(0x263)]=new plisioService_1[(_0x488de5(0x21f))](),this[_0x488de5(0x266)]=new rapydService_1[(_0x488de5(0x254))](),this[_0x488de5(0x211)]=new nodaService_1[(_0x488de5(0x243))](),this[_0x488de5(0x251)]=new coinToPayService_1[(_0x488de5(0x20c))](),this['klymeService']=new klymeService_1[(_0x488de5(0x20d))](),this[_0x488de5(0x271)]=new mastercardService_1[(_0x488de5(0x1d3))]();}async[a57_0x2ef368(0x252)](_0x5bc7b2,_0x1a3ded,_0x517749){const _0x3c290f=a57_0x2ef368;console[_0x3c290f(0x230)](_0x3c290f(0x242)+_0x5bc7b2+'\x20status\x20to\x20'+_0x1a3ded),await database_1[_0x3c290f(0x262)]['$transaction'](async _0xdaea8c=>{const _0x5a6145=_0x3c290f,_0x3de8e3=await _0xdaea8c['payment'][_0x5a6145(0x269)]({'where':{'id':_0x5bc7b2},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3de8e3)throw new Error('Payment\x20'+_0x5bc7b2+_0x5a6145(0x201));const _0x474a30=_0x3de8e3[_0x5a6145(0x1cd)],_0x3ce9b6=_0x3de8e3[_0x5a6145(0x258)];console['log'](_0x5a6145(0x265)+_0x5bc7b2+':\x20'+_0x474a30+_0x5a6145(0x1e8)+_0x1a3ded),console['log'](_0x5a6145(0x1ee)+_0x3ce9b6['username']+_0x5a6145(0x225)+_0x3ce9b6[_0x5a6145(0x24c)]+_0x5a6145(0x1f3));const _0x21c8b5={'status':_0x1a3ded[_0x5a6145(0x200)](),'updatedAt':new Date(),'statusChangedBy':_0x5a6145(0x1e6),'statusChangedAt':new Date()};_0x517749?.['failureMessage']&&(_0x21c8b5[_0x5a6145(0x1d2)]=_0x517749[_0x5a6145(0x1d2)]);_0x517749?.[_0x5a6145(0x240)]&&(_0x21c8b5['txUrls']=JSON['stringify'](_0x517749[_0x5a6145(0x240)]));_0x517749?.[_0x5a6145(0x208)]&&(_0x21c8b5[_0x5a6145(0x208)]=_0x517749['cardLast4']);_0x517749?.[_0x5a6145(0x236)]&&(_0x21c8b5[_0x5a6145(0x236)]=_0x517749[_0x5a6145(0x236)]);_0x517749?.['bankId']&&(_0x21c8b5[_0x5a6145(0x204)]=_0x517749[_0x5a6145(0x204)]);_0x517749?.[_0x5a6145(0x1d6)]&&(_0x21c8b5['remitterIban']=_0x517749[_0x5a6145(0x1d6)]);_0x517749?.[_0x5a6145(0x1fd)]&&(_0x21c8b5[_0x5a6145(0x1fd)]=_0x517749[_0x5a6145(0x1fd)]);let _0x39a735=_0x3ce9b6[_0x5a6145(0x24c)],_0x269763='';if(_0x1a3ded[_0x5a6145(0x200)]()===_0x5a6145(0x1c9)&&_0x474a30!==_0x5a6145(0x1c9)){const _0x2463db=await currencyService_1[_0x5a6145(0x234)]['convertToUSDT'](_0x3de8e3[_0x5a6145(0x228)],_0x3de8e3[_0x5a6145(0x26c)]);_0x39a735+=_0x2463db,_0x269763='+'+_0x2463db[_0x5a6145(0x23b)](0x6)+_0x5a6145(0x247),_0x21c8b5['amountUSDT']=_0x2463db,_0x21c8b5['paidAt']=new Date(),console[_0x5a6145(0x230)]('💰\x20Converting\x20'+_0x3de8e3[_0x5a6145(0x228)]+'\x20'+_0x3de8e3[_0x5a6145(0x26c)]+_0x5a6145(0x1e8)+_0x2463db[_0x5a6145(0x23b)](0x6)+_0x5a6145(0x1f3)),console['log'](_0x5a6145(0x1d1)+_0x3ce9b6['balance']+_0x5a6145(0x210)+_0x2463db[_0x5a6145(0x23b)](0x6)+_0x5a6145(0x1c7)+_0x39a735[_0x5a6145(0x23b)](0x6)+_0x5a6145(0x1f3));}else{if(_0x474a30===_0x5a6145(0x1c9)&&_0x1a3ded['toUpperCase']()!==_0x5a6145(0x1c9)){const _0x50965c=_0x3de8e3[_0x5a6145(0x221)];_0x50965c&&(_0x39a735-=_0x50965c,_0x269763='-'+_0x50965c[_0x5a6145(0x23b)](0x6)+_0x5a6145(0x21c),_0x21c8b5[_0x5a6145(0x221)]=null,_0x21c8b5[_0x5a6145(0x1cc)]=null,console['log']('💰\x20Removing\x20from\x20balance:\x20'+_0x3ce9b6[_0x5a6145(0x24c)]+_0x5a6145(0x22b)+_0x50965c[_0x5a6145(0x23b)](0x6)+_0x5a6145(0x1c7)+_0x39a735[_0x5a6145(0x23b)](0x6)+_0x5a6145(0x1f3)));}}if(_0x1a3ded[_0x5a6145(0x200)]()===_0x5a6145(0x1f6)){const _0x113d92=_0x517749?.['chargebackAmount']||0x0;_0x113d92>0x0&&(_0x39a735-=_0x113d92,_0x269763+=_0x5a6145(0x1eb)+_0x113d92[_0x5a6145(0x23b)](0x6)+_0x5a6145(0x235),_0x21c8b5[_0x5a6145(0x1d4)]=_0x113d92,console[_0x5a6145(0x230)](_0x5a6145(0x264)+_0x113d92[_0x5a6145(0x23b)](0x6)+_0x5a6145(0x1f3)),console['log']('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x39a735[_0x5a6145(0x23b)](0x6)+'\x20USDT'));}const _0x14ea1c=await _0xdaea8c['payment'][_0x5a6145(0x1dc)]({'where':{'id':_0x5bc7b2},'data':_0x21c8b5});_0x39a735!==_0x3ce9b6[_0x5a6145(0x24c)]&&(await _0xdaea8c[_0x5a6145(0x258)][_0x5a6145(0x1dc)]({'where':{'id':_0x3ce9b6['id']},'data':{'balance':_0x39a735}}),console[_0x5a6145(0x230)](_0x5a6145(0x25c)+_0x3ce9b6[_0x5a6145(0x213)]+'\x20balance\x20updated:\x20'+_0x3ce9b6[_0x5a6145(0x24c)]['toFixed'](0x6)+_0x5a6145(0x1e8)+_0x39a735['toFixed'](0x6)+_0x5a6145(0x1f3)),console[_0x5a6145(0x230)](_0x5a6145(0x1ed)+_0x269763)),await _0xdaea8c[_0x5a6145(0x25e)]['create']({'data':{'paymentId':_0x5bc7b2,'shopId':_0x3ce9b6['id'],'event':'webhook_status_change_'+_0x1a3ded[_0x5a6145(0x21a)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x474a30,'newStatus':_0x1a3ded[_0x5a6145(0x200)](),'balanceChange':_0x269763||_0x5a6145(0x257),'oldBalance':_0x3ce9b6[_0x5a6145(0x24c)],'newBalance':_0x39a735,'amountUSDT':_0x21c8b5[_0x5a6145(0x221)],'additionalData':_0x517749,'timestamp':new Date()[_0x5a6145(0x212)]()})}}),await this[_0x5a6145(0x1f2)]({..._0x3de8e3,..._0x14ea1c,'shop':_0x3ce9b6},_0x1a3ded['toUpperCase']()),await this[_0x5a6145(0x245)]({..._0x3de8e3,..._0x14ea1c},_0x1a3ded[_0x5a6145(0x200)]());});}async[a57_0x2ef368(0x237)](_0x1969ff){const _0x35eac4=a57_0x2ef368;console['log'](_0x35eac4(0x218),_0x1969ff);try{const _0x3d0aaa=await this[_0x35eac4(0x263)]['processWebhook'](_0x1969ff);if(!_0x3d0aaa[_0x35eac4(0x256)])throw new Error(_0x35eac4(0x267));const _0x2b29db=await database_1[_0x35eac4(0x262)]['payment'][_0x35eac4(0x25b)]({'where':{'gatewayOrderId':_0x3d0aaa[_0x35eac4(0x256)]}});if(!_0x2b29db){console[_0x35eac4(0x207)](_0x35eac4(0x238)+_0x3d0aaa[_0x35eac4(0x256)]);return;}console['log']('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0x2b29db['id']+_0x35eac4(0x273)+_0x3d0aaa[_0x35eac4(0x1cd)]),await this['updatePaymentStatus'](_0x2b29db['id'],_0x3d0aaa[_0x35eac4(0x1cd)],{'txUrls':_0x3d0aaa['txUrls']}),loggerService_1[_0x35eac4(0x1e9)][_0x35eac4(0x246)](_0x35eac4(0x1fb),_0x2b29db['id'],_0x2b29db[_0x35eac4(0x1cd)],_0x3d0aaa[_0x35eac4(0x1cd)],_0x1969ff);}catch(_0x5bc134){console[_0x35eac4(0x207)](_0x35eac4(0x22d),_0x5bc134),loggerService_1['loggerService'][_0x35eac4(0x25a)](_0x35eac4(0x1fb),_0x5bc134,_0x1969ff);throw _0x5bc134;}}async[a57_0x2ef368(0x1f7)](_0xefac72){const _0x4e8902=a57_0x2ef368;console[_0x4e8902(0x230)](_0x4e8902(0x248),_0xefac72);try{const _0x101419=await this[_0x4e8902(0x263)][_0x4e8902(0x25f)](_0xefac72);if(!_0x101419[_0x4e8902(0x256)])throw new Error(_0x4e8902(0x1ea));const _0x19bd54=await database_1['default'][_0x4e8902(0x253)]['findFirst']({'where':{'gatewayOrderId':_0x101419[_0x4e8902(0x256)]}});if(!_0x19bd54){console[_0x4e8902(0x207)](_0x4e8902(0x249)+_0x101419[_0x4e8902(0x256)]);return;}console[_0x4e8902(0x230)](_0x4e8902(0x1e1)+_0x19bd54['id']+_0x4e8902(0x273)+_0x101419[_0x4e8902(0x1cd)]),await this['updatePaymentStatus'](_0x19bd54['id'],_0x101419[_0x4e8902(0x1cd)],{'txUrls':_0x101419[_0x4e8902(0x240)]}),loggerService_1['loggerService']['logWebhookProcessed'](_0x4e8902(0x26e),_0x19bd54['id'],_0x19bd54[_0x4e8902(0x1cd)],_0x101419['status'],_0xefac72);}catch(_0x994765){console[_0x4e8902(0x207)](_0x4e8902(0x261),_0x994765),loggerService_1['loggerService'][_0x4e8902(0x25a)](_0x4e8902(0x26e),_0x994765,_0xefac72);throw _0x994765;}}async[a57_0x2ef368(0x1fe)](_0x348df4){const _0x2b4e59=a57_0x2ef368;console[_0x2b4e59(0x230)](_0x2b4e59(0x24a),_0x348df4);try{const _0x559c67=await this[_0x2b4e59(0x266)]['processWebhook'](_0x348df4);if(!_0x559c67[_0x2b4e59(0x256)])throw new Error(_0x2b4e59(0x21b));const _0x49d3f9=await database_1[_0x2b4e59(0x262)][_0x2b4e59(0x253)][_0x2b4e59(0x25b)]({'where':{'gatewayOrderId':_0x559c67[_0x2b4e59(0x256)]}});if(!_0x49d3f9){console[_0x2b4e59(0x207)](_0x2b4e59(0x1ca)+_0x559c67['paymentId']);return;}console[_0x2b4e59(0x230)](_0x2b4e59(0x217)+_0x49d3f9['id']+_0x2b4e59(0x273)+_0x559c67['status']),await this[_0x2b4e59(0x252)](_0x49d3f9['id'],_0x559c67[_0x2b4e59(0x1cd)],{'failureMessage':_0x559c67['failureMessage'],'cardLast4':_0x559c67[_0x2b4e59(0x24b)]?.[_0x2b4e59(0x208)],'paymentMethod':_0x559c67['additionalInfo']?.[_0x2b4e59(0x236)]}),loggerService_1[_0x2b4e59(0x1e9)][_0x2b4e59(0x246)](_0x2b4e59(0x227),_0x49d3f9['id'],_0x49d3f9[_0x2b4e59(0x1cd)],_0x559c67[_0x2b4e59(0x1cd)],_0x348df4);}catch(_0x109107){console[_0x2b4e59(0x207)](_0x2b4e59(0x23f),_0x109107),loggerService_1[_0x2b4e59(0x1e9)][_0x2b4e59(0x25a)]('rapyd',_0x109107,_0x348df4);throw _0x109107;}}async[a57_0x2ef368(0x24f)](_0x3cce63){const _0x25ee0f=a57_0x2ef368;console[_0x25ee0f(0x230)](_0x25ee0f(0x1dd),_0x3cce63);try{const _0x254314=await this['nodaService']['processWebhook'](_0x3cce63);if(!_0x254314[_0x25ee0f(0x256)])throw new Error(_0x25ee0f(0x239));const _0x93a101=await database_1[_0x25ee0f(0x262)]['payment'][_0x25ee0f(0x25b)]({'where':{'gatewayOrderId':_0x254314[_0x25ee0f(0x256)]}});if(!_0x93a101){console[_0x25ee0f(0x207)](_0x25ee0f(0x222)+_0x254314[_0x25ee0f(0x256)]);return;}console[_0x25ee0f(0x230)](_0x25ee0f(0x26d)+_0x93a101['id']+_0x25ee0f(0x273)+_0x254314[_0x25ee0f(0x1cd)]),await this[_0x25ee0f(0x252)](_0x93a101['id'],_0x254314[_0x25ee0f(0x1cd)],{'bankId':_0x254314[_0x25ee0f(0x24b)]?.[_0x25ee0f(0x204)],'remitterIban':_0x254314[_0x25ee0f(0x24b)]?.['remitterIban'],'remitterName':_0x254314[_0x25ee0f(0x24b)]?.[_0x25ee0f(0x1fd)]}),loggerService_1['loggerService'][_0x25ee0f(0x246)](_0x25ee0f(0x1e4),_0x93a101['id'],_0x93a101[_0x25ee0f(0x1cd)],_0x254314[_0x25ee0f(0x1cd)],_0x3cce63);}catch(_0x5abb20){console[_0x25ee0f(0x207)](_0x25ee0f(0x1d5),_0x5abb20),loggerService_1['loggerService']['logWebhookError']('noda',_0x5abb20,_0x3cce63);throw _0x5abb20;}}async[a57_0x2ef368(0x1d8)](_0x2a9f69){const _0x4636c7=a57_0x2ef368;console[_0x4636c7(0x230)](_0x4636c7(0x1da),_0x2a9f69);try{const _0x257755=await this[_0x4636c7(0x251)]['processWebhook'](_0x2a9f69);if(!_0x257755['paymentId'])throw new Error(_0x4636c7(0x255));const _0x145e49=await database_1[_0x4636c7(0x262)][_0x4636c7(0x253)][_0x4636c7(0x25b)]({'where':{'gatewayOrderId':_0x257755[_0x4636c7(0x256)]}});if(!_0x145e49){console[_0x4636c7(0x207)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x257755[_0x4636c7(0x256)]);return;}console[_0x4636c7(0x230)](_0x4636c7(0x1d0)+_0x145e49['id']+_0x4636c7(0x273)+_0x257755[_0x4636c7(0x1cd)]),await this[_0x4636c7(0x252)](_0x145e49['id'],_0x257755[_0x4636c7(0x1cd)]),loggerService_1['loggerService'][_0x4636c7(0x246)](_0x4636c7(0x206),_0x145e49['id'],_0x145e49['status'],_0x257755[_0x4636c7(0x1cd)],_0x2a9f69);}catch(_0x56c826){console[_0x4636c7(0x207)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x56c826),loggerService_1[_0x4636c7(0x1e9)][_0x4636c7(0x25a)](_0x4636c7(0x206),_0x56c826,_0x2a9f69);throw _0x56c826;}}async[a57_0x2ef368(0x1ec)](_0x3a3c18){const _0x5d715d=a57_0x2ef368;console[_0x5d715d(0x230)](_0x5d715d(0x24e),_0x3a3c18);try{const _0x27d64c=await this['klymeService'][_0x5d715d(0x25f)](_0x3a3c18);if(!_0x27d64c[_0x5d715d(0x256)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0xc05e1c=await database_1[_0x5d715d(0x262)][_0x5d715d(0x253)]['findFirst']({'where':{'gatewayOrderId':_0x27d64c[_0x5d715d(0x256)]}});if(!_0xc05e1c){console['error'](_0x5d715d(0x231)+_0x27d64c[_0x5d715d(0x256)]);return;}console[_0x5d715d(0x230)](_0x5d715d(0x23e)+_0xc05e1c['id']+_0x5d715d(0x273)+_0x27d64c[_0x5d715d(0x1cd)]),await this[_0x5d715d(0x252)](_0xc05e1c['id'],_0x27d64c[_0x5d715d(0x1cd)],{'paymentMethod':_0x27d64c[_0x5d715d(0x24b)]?.['payment_method']}),loggerService_1[_0x5d715d(0x1e9)]['logWebhookProcessed'](_0x5d715d(0x268),_0xc05e1c['id'],_0xc05e1c[_0x5d715d(0x1cd)],_0x27d64c[_0x5d715d(0x1cd)],_0x3a3c18);}catch(_0x8f9f57){console[_0x5d715d(0x207)](_0x5d715d(0x21e),_0x8f9f57),loggerService_1[_0x5d715d(0x1e9)][_0x5d715d(0x25a)](_0x5d715d(0x268),_0x8f9f57,_0x3a3c18);throw _0x8f9f57;}}async[a57_0x2ef368(0x219)](_0x306d41){const _0x3386b3=a57_0x2ef368;console[_0x3386b3(0x230)](_0x3386b3(0x20a),_0x306d41);try{const _0x2ac8eb=await this['masterCardService'][_0x3386b3(0x25f)](_0x306d41);if(!_0x2ac8eb[_0x3386b3(0x256)])throw new Error(_0x3386b3(0x22c));const _0x126fc6=await database_1[_0x3386b3(0x262)][_0x3386b3(0x253)][_0x3386b3(0x25b)]({'where':{'gatewayOrderId':_0x2ac8eb['paymentId']}});if(!_0x126fc6){console[_0x3386b3(0x207)](_0x3386b3(0x1cf)+_0x2ac8eb[_0x3386b3(0x256)]);return;}console[_0x3386b3(0x230)]('📊\x20MasterCard\x20webhook:\x20Payment\x20'+_0x126fc6['id']+_0x3386b3(0x273)+_0x2ac8eb[_0x3386b3(0x1cd)]),await this[_0x3386b3(0x252)](_0x126fc6['id'],_0x2ac8eb[_0x3386b3(0x1cd)]),loggerService_1[_0x3386b3(0x1e9)][_0x3386b3(0x246)](_0x3386b3(0x1fc),_0x126fc6['id'],_0x126fc6['status'],_0x2ac8eb[_0x3386b3(0x1cd)],_0x306d41);}catch(_0x26d397){console[_0x3386b3(0x207)](_0x3386b3(0x223),_0x26d397),loggerService_1[_0x3386b3(0x1e9)][_0x3386b3(0x25a)](_0x3386b3(0x1fc),_0x26d397,_0x306d41);throw _0x26d397;}}async[a57_0x2ef368(0x1f2)](_0x210572,_0x2b6212){const _0xcd04b8=a57_0x2ef368,_0x384e97=Date['now']();try{const _0x4f858d=_0x210572['shop'],_0x1fb531=_0x4f858d[_0xcd04b8(0x1f9)];if(!_0x1fb531?.['webhookUrl']){console['log'](_0xcd04b8(0x272)+_0x4f858d['id']);return;}const _0x25ab1a=_0x2b6212===_0xcd04b8(0x1c9)?_0xcd04b8(0x25d):_0x2b6212===_0xcd04b8(0x1f4)?_0xcd04b8(0x1f1):_0x2b6212===_0xcd04b8(0x1ef)?'payment.failed':_0x2b6212==='CHARGEBACK'?_0xcd04b8(0x1f1):_0x2b6212==='REFUND'?_0xcd04b8(0x1f1):_0xcd04b8(0x224);let _0x4acc07=[];if(_0x1fb531[_0xcd04b8(0x22f)])try{_0x4acc07=Array['isArray'](_0x1fb531['webhookEvents'])?_0x1fb531[_0xcd04b8(0x22f)]:JSON['parse'](_0x1fb531[_0xcd04b8(0x22f)]);}catch(_0x46385b){console[_0xcd04b8(0x207)](_0xcd04b8(0x22a),_0x46385b),_0x4acc07=[];}if(!_0x4acc07[_0xcd04b8(0x20b)](_0x25ab1a)){console['log']('Webhook\x20event\x20'+_0x25ab1a+_0xcd04b8(0x1df)+_0x4f858d['id']);return;}const _0x669ace={'event':_0x25ab1a,'payment':{'id':_0x210572['id'],'order_id':_0x210572[_0xcd04b8(0x23c)],'gateway_order_id':_0x210572['gatewayOrderId'],'gateway':_0x210572[_0xcd04b8(0x22e)],'amount':_0x210572[_0xcd04b8(0x228)],'currency':_0x210572[_0xcd04b8(0x26c)],'status':_0x2b6212[_0xcd04b8(0x21a)](),'customer_email':_0x210572['customerEmail'],'customer_name':_0x210572[_0xcd04b8(0x1f5)],'failure_message':_0x210572['failureMessage'],'tx_urls':_0x210572[_0xcd04b8(0x240)]?JSON[_0xcd04b8(0x244)](_0x210572[_0xcd04b8(0x240)]):null,'created_at':_0x210572[_0xcd04b8(0x214)],'updated_at':_0x210572[_0xcd04b8(0x26f)]}},_0x5c3d63=await fetch(_0x1fb531[_0xcd04b8(0x1c5)],{'method':_0xcd04b8(0x1cb),'headers':{'Content-Type':_0xcd04b8(0x1db),'User-Agent':_0xcd04b8(0x1c8)},'body':JSON[_0xcd04b8(0x1e5)](_0x669ace)}),_0x394f1e=Date[_0xcd04b8(0x1d7)]()-_0x384e97,_0x1422d4=_0x5c3d63['ok']?_0xcd04b8(0x220):await _0x5c3d63[_0xcd04b8(0x241)]();loggerService_1['loggerService'][_0xcd04b8(0x26b)](_0x210572[_0xcd04b8(0x226)],_0x1fb531[_0xcd04b8(0x1c5)],_0x25ab1a,_0x5c3d63[_0xcd04b8(0x1cd)],_0x394f1e,_0x669ace),console[_0xcd04b8(0x230)](_0xcd04b8(0x1de)+_0x1fb531[_0xcd04b8(0x1c5)]+_0xcd04b8(0x270)+_0x5c3d63[_0xcd04b8(0x1cd)]+'\x20('+_0x394f1e+_0xcd04b8(0x1d9));}catch(_0x5cc85b){console[_0xcd04b8(0x207)](_0xcd04b8(0x1f0),_0x5cc85b),loggerService_1[_0xcd04b8(0x1e9)][_0xcd04b8(0x1e7)](_0x210572['shopId'],_0x210572[_0xcd04b8(0x258)]?.[_0xcd04b8(0x1f9)]?.[_0xcd04b8(0x1c5)]||'unknown','webhook_send',_0x5cc85b,{});}}async['sendPaymentStatusNotification'](_0x286401,_0x54a312){const _0x234b32=a57_0x2ef368;try{const _0x4fce12={'PENDING':_0x234b32(0x250),'PROCESSING':'processing','PAID':'paid','FAILED':_0x234b32(0x20f),'EXPIRED':_0x234b32(0x232),'REFUND':'refund','CHARGEBACK':_0x234b32(0x229)},_0x59292c=_0x4fce12[_0x54a312];if(!_0x59292c||_0x59292c===_0x234b32(0x250))return;await telegramBotService_1[_0x234b32(0x1c6)][_0x234b32(0x215)](_0x286401[_0x234b32(0x226)],_0x286401,_0x59292c);}catch(_0x263102){console['error'](_0x234b32(0x205),_0x263102);}}}exports[a57_0x2ef368(0x1ce)]=WebhookService;