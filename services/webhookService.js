'use strict';const a62_0x46f496=a62_0x314c;(function(_0x25ddd6,_0x5302a6){const _0xc71360=a62_0x314c,_0x373dfa=_0x25ddd6();while(!![]){try{const _0x431506=-parseInt(_0xc71360(0x1cd))/0x1+-parseInt(_0xc71360(0x24c))/0x2*(-parseInt(_0xc71360(0x2b7))/0x3)+parseInt(_0xc71360(0x223))/0x4*(parseInt(_0xc71360(0x2d7))/0x5)+parseInt(_0xc71360(0x2a1))/0x6+parseInt(_0xc71360(0x22e))/0x7*(-parseInt(_0xc71360(0x2d3))/0x8)+parseInt(_0xc71360(0x241))/0x9*(-parseInt(_0xc71360(0x294))/0xa)+-parseInt(_0xc71360(0x22a))/0xb*(-parseInt(_0xc71360(0x1c9))/0xc);if(_0x431506===_0x5302a6)break;else _0x373dfa['push'](_0x373dfa['shift']());}catch(_0x158bda){_0x373dfa['push'](_0x373dfa['shift']());}}}(a62_0x1c10,0xeb3d2));function a62_0x1c10(){const _0x4f7c87=['amerService','\x22,\x20orderId=\x22','no\x20balance\x20change','shopId','30wRrFpB','processRapydWebhook','\x20commission:\x20','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','webhookUrl','paid','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','rapydService','shop','./gateways/plisioService','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','ms)','4426800UeRKhb','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','currencyService','💰\x20Amount\x20after\x20gateway\x20commission:\x20','DECLINED','❌\x20Error\x20processing\x20MasterCard\x20webhook:','🔄\x20Processing\x20Plisio\x20webhook:','WebhookService','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:',',\x20status=','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','remitterIban','entries','CoinToPayService','plisioService','💸\x20Additional\x20chargeback\x20penalty:\x20-','remitterName','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','paidAt','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','\x22,\x20newStatus=\x22','3020172URAFwK','orderId','🔄\x20Processing\x20Noda\x20webhook:','gatewaySettings','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','defineProperty','VISA','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','AmPayService','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','logWebhookProcessed','mastercard','Error\x20processing\x20Rapyd\x20webhook:','Payment\x20not\x20found:\x20','Body\x20data:','Error\x20processing\x20Plisio\x20webhook:','commission','📊\x20MasterCard\x20webhook\x20result:','processAmerWebhook','myxspend','keys','❌\x20VISA\x20webhook\x20processing\x20failed:','visa_','./gateways/ampayService','🔄\x20Processing\x20MyXSpend\x20webhook:','VisaMasterCardService','processMasterCardWebhook','Webhook\x20event\x20','7526312nZQRKs','🔄\x20Additional\x20data:','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','./gateways/rapydService','103585IgBeDW','customerOrderId',',\x20currentPayments=','\x22,\x20paymentLinkId=\x22','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','payment.success','\x20USDT','\x20for\x20MyXSpend\x20webhook','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','payment.failed','✅\x20Found\x20payment\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','gateway','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20',',\x20Status=','%\x20gateway\x20commission)','Error\x20processing\x20Noda\x20webhook:','💰\x20Adding\x20to\x20balance:\x20','NodaService','./gateways/amerService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','./telegramBotService','📝\x20Reason:\x20','customerName','klyme','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','📊\x20Amer\x20webhook:\x20Payment\x20','findMany','chargeback','Failed\x20to\x20send\x20shop\x20webhook:','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','\x20USDT\x20(chargeback\x20penalty)','update','AmerService','\x20to\x20','getGatewayCommission','expired','create','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','✅\x20Payment\x20link\x20','VISA\x20payment\x20not\x20found:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','client_transaction_id','\x20=\x20','COMPLETED','sendShopWebhook','\x20(Status:\x20','toLowerCase','unknown','Error\x20processing\x20CoinToPay2\x20webhook:','1614396vEEMUf','visa','🔍\x20VISA\x20payment\x20search\x20result:\x20','logShopWebhookSent','1208873iSoCXA','additionalInfo','\x20with\x20status\x20','\x20in\x20shop\x20','🔄\x20Processing\x20VISA\x20webhook:','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','🔍\x20Search\x20result:\x20','dateTime','gatewayOrderId','📊\x20VISA\x20payment\x20found:\x20','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','🔄\x20Processing\x20CoinToPay2\x20webhook:','chargebackAmount','ℹ️\x20Decline\x20reason:\x20','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook',',\x20Card=****','./gateways/klymeService','noda','webhookLog','📤\x20Shop\x20webhook\x20sent\x20to\x20','cointopay2','username','ampay','\x20not\x20found','visaMasterCardService','FAILED',',\x20Gateway=','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','❌\x20Available\x20webhook\x20fields:','toISOString','currency','nodaService','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','findUnique','MASTERCARD','sendPaymentStatusNotification','CHARGEBACK','No\x20payment\x20ID\x20in\x20Noda\x20webhook','__importDefault','No\x20payment\x20ID\x20in\x20Amer\x20webhook','🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:','processing','error','📊\x20Amer\x20webhook\x20result:','💰\x20Final\x20balance\x20after\x20chargeback:\x20','./gateways/coinToPay2Service','💰\x20Payment\x20','🔍\x20Found\x20VISA\x20payment:\x20ID=','processAmPayWebhook','Success','coinToPayService','stringify','settings','SINGLE','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','default','currentPayments','ampay_','\x20->\x20','RapydService','❌\x20Error\x20processing\x20AmPay\x20webhook:','Gateway\x20','myxspend_','./currencyService','findFirst','amount','./gateways/mastercardService','paymentLink','coinToPay2Service','📊\x20Noda\x20webhook:\x20Payment\x20','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','balance','📈\x20Payment\x20','📈\x20Payment\x20details:\x20oldStatus=\x22','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','updatePaymentStatus','\x22,\x20id=\x22','klymeService','Not\x20found','status','cointopay','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','📊\x20AmPay\x20webhook\x20data:','PAID','152tefxfL','PlisioService','text','\x20mapped\x20to\x20FAILED','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','gatewayCommissionRate','system_id','99CqZTGz','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','Error\x20processing\x20KLYME\x20webhook:','📊\x20KLYME\x20webhook:\x20Payment\x20','7pWITBO','./gateways/coinToPayService','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','../config/database',',\x20gatewayOrderId:\x20','isArray','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','🔍\x20VISA\x20payment\x20search\x20executed','\x20and\x20-','cardLast4','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','toUpperCase','Error\x20parsing\x20webhook\x20events:','__esModule','Payment\x20not\x20found','CoinToPay2Service','amountUSDT','❌\x20Payment\x20link\x20','\x20→\x20','1888101yQwGTV','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','\x20for\x20AmPay\x20webhook','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','payment.pending','webhookEvents','created','log','processWebhook','\x20status\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','2KQhSWv','🔄\x20Processing\x20AmPay\x20webhook:','POST',',\x20gatewayPaymentId:\x20','processPlisioWebhook','payment','now','plisio','toFixed','logWebhookError','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','🔄\x20MyXSpend\x20status\x20','$transaction','\x20(orderId:\x20','📊\x20VISA\x20webhook\x20result:','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','paymentId','parse','amer','REFUND','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','processVisaWebhook','bankId','EXPIRED','payment_method','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','webhook_send','rapyd','processPlisioGatewayWebhook','txUrls','\x20current\x20balance:\x20','desc','\x20+\x20','visa_mastercard','gatewayPaymentId','🔄\x20Processing\x20KLYME\x20webhook:','No\x20additional\x20info','paymentMethod','convertToUSDT','amountAfterGatewayCommissionUSDT','📊\x20Payment\x20status:\x20',',\x20using\x20default\x20commission\x2010%','\x20status\x20updated\x20to\x20FAILED','plisio_gateway','✅\x20Shop\x20','🔄\x20Processing\x20Amer\x20webhook:','type','No\x20payment\x20ID\x20in\x20Plisio\x20webhook',',\x20GatewayPaymentId=','\x20-\x20','Found','paymentLinkId','updatedAt','visa/mastercard',',\x20GatewayOrderId=','application/json','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','📊\x20MyXSpend\x20webhook\x20data:','processCoinToPayWebhook','loggerService','processCoinToPay2Webhook','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','\x20commission\x20for\x20shop\x20','Error\x20processing\x20CoinToPay\x20webhook:','telegramBotService','status_addition_info','\x20balance\x20updated:\x20','failureMessage'];a62_0x1c10=function(){return _0x4f7c87;};return a62_0x1c10();}function a62_0x314c(_0x5c621a,_0x10e2f0){const _0x1c102f=a62_0x1c10();return a62_0x314c=function(_0x314ce6,_0x596c0d){_0x314ce6=_0x314ce6-0x198;let _0x37ff38=_0x1c102f[_0x314ce6];return _0x37ff38;},a62_0x314c(_0x5c621a,_0x10e2f0);}var __importDefault=this&&this[a62_0x46f496(0x1f3)]||function(_0x564f8a){return _0x564f8a&&_0x564f8a['__esModule']?_0x564f8a:{'default':_0x564f8a};};Object[a62_0x46f496(0x2bc)](exports,a62_0x46f496(0x23b),{'value':!![]}),exports[a62_0x46f496(0x2a8)]=void 0x0;const database_1=__importDefault(require(a62_0x46f496(0x231))),plisioService_1=require(a62_0x46f496(0x29e)),rapydService_1=require(a62_0x46f496(0x2d6)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a62_0x46f496(0x22f)),coinToPay2Service_1=require(a62_0x46f496(0x1fa)),klymeService_1=require(a62_0x46f496(0x1dd)),mastercardService_1=require(a62_0x46f496(0x20f)),amerService_1=require(a62_0x46f496(0x1aa)),ampayService_1=require(a62_0x46f496(0x2ce)),telegramBotService_1=require(a62_0x46f496(0x1ac)),currencyService_1=require(a62_0x46f496(0x20c)),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x24023d=a62_0x46f496;this[_0x24023d(0x2af)]=new plisioService_1[(_0x24023d(0x224))](),this[_0x24023d(0x29c)]=new rapydService_1[(_0x24023d(0x208))](),this['nodaService']=new nodaService_1[(_0x24023d(0x1a9))](),this[_0x24023d(0x1ff)]=new coinToPayService_1[(_0x24023d(0x2ae))](),this[_0x24023d(0x211)]=new coinToPay2Service_1[(_0x24023d(0x23d))](),this[_0x24023d(0x21c)]=new klymeService_1['KlymeService'](),this[_0x24023d(0x1e5)]=new mastercardService_1[(_0x24023d(0x2d0))](),this[_0x24023d(0x290)]=new amerService_1[(_0x24023d(0x1b8))](),this['ampayService']=new ampayService_1[(_0x24023d(0x2bf))]();}async[a62_0x46f496(0x21a)](_0x5d7dac,_0x114a06,_0x53edc3){const _0xd66358=a62_0x46f496;console[_0xd66358(0x248)](_0xd66358(0x284)+_0x5d7dac+',\x20newStatus='+_0x114a06),console[_0xd66358(0x248)](_0xd66358(0x2d4),_0x53edc3),await database_1[_0xd66358(0x204)][_0xd66358(0x258)](async _0x5cde20=>{const _0x29510c=_0xd66358,_0x1b730d=await _0x5cde20[_0x29510c(0x251)][_0x29510c(0x1ee)]({'where':{'id':_0x5d7dac},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1b730d)throw new Error('Payment\x20'+_0x5d7dac+_0x29510c(0x1e4));const _0x192577=_0x1b730d[_0x29510c(0x21e)],_0x5dde31=_0x1b730d[_0x29510c(0x29d)];console[_0x29510c(0x248)](_0x29510c(0x1fb)+_0x5d7dac+':\x20'+_0x192577+_0x29510c(0x207)+_0x114a06),console[_0x29510c(0x248)]('🏪\x20Shop\x20'+_0x5dde31[_0x29510c(0x1e2)]+_0x29510c(0x26a)+_0x5dde31[_0x29510c(0x215)]+'\x20USDT');const _0x583786={'status':_0x114a06[_0x29510c(0x239)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x53edc3?.[_0x29510c(0x28f)]&&(_0x583786['failureMessage']=_0x53edc3[_0x29510c(0x28f)]);_0x53edc3?.[_0x29510c(0x269)]&&(_0x583786[_0x29510c(0x269)]=JSON['stringify'](_0x53edc3['txUrls']));_0x53edc3?.[_0x29510c(0x237)]&&(_0x583786[_0x29510c(0x237)]=_0x53edc3['cardLast4']);_0x53edc3?.[_0x29510c(0x271)]&&(_0x583786['paymentMethod']=_0x53edc3[_0x29510c(0x271)]);_0x53edc3?.[_0x29510c(0x262)]&&(_0x583786[_0x29510c(0x262)]=_0x53edc3[_0x29510c(0x262)]);_0x53edc3?.['remitterIban']&&(_0x583786['remitterIban']=_0x53edc3[_0x29510c(0x2ac)]);_0x53edc3?.[_0x29510c(0x2b1)]&&(_0x583786[_0x29510c(0x2b1)]=_0x53edc3[_0x29510c(0x2b1)]);let _0x4e53f3=_0x5dde31[_0x29510c(0x215)],_0x2057d9='';if(_0x114a06[_0x29510c(0x239)]()===_0x29510c(0x222)&&_0x192577!==_0x29510c(0x222)){const _0x2d3353=await currencyService_1[_0x29510c(0x2a3)][_0x29510c(0x272)](_0x1b730d[_0x29510c(0x20e)],_0x1b730d[_0x29510c(0x1eb)]),_0x351e06=await this[_0x29510c(0x1ba)](_0x5dde31['id'],_0x1b730d[_0x29510c(0x1a3)]),_0x57ef2a=_0x2d3353*(0x1-_0x351e06/0x64);_0x4e53f3+=_0x57ef2a,_0x2057d9='+'+_0x57ef2a[_0x29510c(0x254)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20'+_0x351e06+_0x29510c(0x1a6),_0x583786[_0x29510c(0x23e)]=_0x2d3353,_0x583786['amountAfterGatewayCommissionUSDT']=_0x57ef2a,_0x583786[_0x29510c(0x228)]=_0x351e06,_0x583786[_0x29510c(0x2b3)]=new Date(),console[_0x29510c(0x248)]('💰\x20Converting\x20'+_0x1b730d['amount']+'\x20'+_0x1b730d[_0x29510c(0x1eb)]+'\x20->\x20'+_0x2d3353[_0x29510c(0x254)](0x6)+'\x20USDT'),console[_0x29510c(0x248)]('💰\x20Gateway\x20'+_0x1b730d[_0x29510c(0x1a3)]+_0x29510c(0x296)+_0x351e06+'%'),console[_0x29510c(0x248)](_0x29510c(0x2a4)+_0x57ef2a[_0x29510c(0x254)](0x6)+'\x20USDT'),console[_0x29510c(0x248)](_0x29510c(0x1a8)+_0x5dde31[_0x29510c(0x215)]+_0x29510c(0x26c)+_0x57ef2a['toFixed'](0x6)+_0x29510c(0x1c2)+_0x4e53f3[_0x29510c(0x254)](0x6)+'\x20USDT');}else{if(_0x192577===_0x29510c(0x222)&&_0x114a06[_0x29510c(0x239)]()!==_0x29510c(0x222)){let _0x10c81a;if(_0x1b730d[_0x29510c(0x273)])_0x10c81a=_0x1b730d[_0x29510c(0x273)];else{if(_0x1b730d[_0x29510c(0x23e)]){const _0x4f7a7a=await this['getGatewayCommission'](_0x5dde31['id'],_0x1b730d[_0x29510c(0x1a3)]);_0x10c81a=_0x1b730d[_0x29510c(0x23e)]*(0x1-_0x4f7a7a/0x64);}else console['log'](_0x29510c(0x214)),_0x10c81a=0x0;}_0x10c81a>0x0&&(_0x4e53f3-=_0x10c81a,_0x2057d9='-'+_0x10c81a[_0x29510c(0x254)](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x583786[_0x29510c(0x23e)]=null,_0x583786[_0x29510c(0x273)]=null,_0x583786[_0x29510c(0x2b3)]=null,console['log']('💰\x20Removing\x20from\x20balance:\x20'+_0x5dde31[_0x29510c(0x215)]+_0x29510c(0x27d)+_0x10c81a['toFixed'](0x6)+_0x29510c(0x1c2)+_0x4e53f3[_0x29510c(0x254)](0x6)+'\x20USDT'));}}if(_0x114a06[_0x29510c(0x239)]()==='CHARGEBACK'){const _0x2d9026=_0x53edc3?.[_0x29510c(0x1d9)]||0x0;_0x2d9026>0x0&&(_0x4e53f3-=_0x2d9026,_0x2057d9+=_0x29510c(0x236)+_0x2d9026[_0x29510c(0x254)](0x6)+_0x29510c(0x1b6),_0x583786['chargebackAmount']=_0x2d9026,console[_0x29510c(0x248)](_0x29510c(0x2b0)+_0x2d9026['toFixed'](0x6)+_0x29510c(0x19d)),console[_0x29510c(0x248)](_0x29510c(0x1f9)+_0x4e53f3[_0x29510c(0x254)](0x6)+_0x29510c(0x19d)));}const _0x52bfe2=await _0x5cde20['payment'][_0x29510c(0x1b7)]({'where':{'id':_0x5d7dac},'data':_0x583786});_0x4e53f3!==_0x5dde31[_0x29510c(0x215)]&&(await _0x5cde20[_0x29510c(0x29d)]['update']({'where':{'id':_0x5dde31['id']},'data':{'balance':_0x4e53f3}}),console[_0x29510c(0x248)](_0x29510c(0x278)+_0x5dde31[_0x29510c(0x1e2)]+_0x29510c(0x28e)+_0x5dde31['balance'][_0x29510c(0x254)](0x6)+_0x29510c(0x207)+_0x4e53f3[_0x29510c(0x254)](0x6)+_0x29510c(0x19d)),console[_0x29510c(0x248)](_0x29510c(0x1ad)+_0x2057d9));await _0x5cde20['webhookLog'][_0x29510c(0x1bc)]({'data':{'paymentId':_0x5d7dac,'shopId':_0x5dde31['id'],'event':'webhook_status_change_'+_0x114a06[_0x29510c(0x1c6)](),'statusCode':0xc8,'responseBody':JSON[_0x29510c(0x200)]({'oldStatus':_0x192577,'newStatus':_0x114a06['toUpperCase'](),'balanceChange':_0x2057d9||_0x29510c(0x292),'oldBalance':_0x5dde31[_0x29510c(0x215)],'newBalance':_0x4e53f3,'amountUSDT':_0x583786[_0x29510c(0x23e)],'additionalData':_0x53edc3,'timestamp':new Date()[_0x29510c(0x1ea)]()})}}),await this[_0x29510c(0x1c4)]({..._0x1b730d,..._0x52bfe2,'shop':_0x5dde31},_0x114a06[_0x29510c(0x239)]()),await this[_0x29510c(0x1f0)]({..._0x1b730d,..._0x52bfe2},_0x114a06[_0x29510c(0x239)]());if(_0x192577!==_0x29510c(0x222)&&_0x114a06[_0x29510c(0x239)]()==='PAID'){console['log']('📈\x20Payment\x20'+_0x5d7dac+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console[_0x29510c(0x248)](_0x29510c(0x217)+_0x192577+_0x29510c(0x2b6)+_0x114a06[_0x29510c(0x239)]()+_0x29510c(0x19a)+_0x1b730d[_0x29510c(0x27f)]+'\x22');if(_0x1b730d[_0x29510c(0x27f)])try{const _0x41f175=await _0x5cde20[_0x29510c(0x210)][_0x29510c(0x1ee)]({'where':{'id':_0x1b730d['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x41f175){console['log']('📈\x20Found\x20payment\x20link\x20'+_0x41f175['id']+':\x20type='+_0x41f175[_0x29510c(0x27a)]+_0x29510c(0x199)+_0x41f175[_0x29510c(0x205)]+_0x29510c(0x2aa)+_0x41f175['status']);const _0x19148a=_0x41f175[_0x29510c(0x205)]+0x1,_0x1a4012=_0x41f175[_0x29510c(0x27a)]===_0x29510c(0x202)?_0x29510c(0x1c3):_0x41f175['status'];await _0x5cde20[_0x29510c(0x210)][_0x29510c(0x1b7)]({'where':{'id':_0x1b730d[_0x29510c(0x27f)]},'data':{'currentPayments':_0x19148a,'status':_0x1a4012,'updatedAt':new Date()}}),console[_0x29510c(0x248)](_0x29510c(0x1be)+_0x41f175['id']+'\x20updated:\x20currentPayments='+_0x41f175[_0x29510c(0x205)]+_0x29510c(0x207)+_0x19148a+_0x29510c(0x2aa)+_0x41f175[_0x29510c(0x21e)]+_0x29510c(0x207)+_0x1a4012);}else console['log'](_0x29510c(0x23f)+_0x1b730d[_0x29510c(0x27f)]+_0x29510c(0x1e4));}catch(_0x450d87){console['error'](_0x29510c(0x1b0),_0x450d87);}else console['log'](_0x29510c(0x216)+_0x5d7dac+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0x29510c(0x248)](_0x29510c(0x216)+_0x5d7dac+_0x29510c(0x242)+_0x192577+_0x29510c(0x207)+_0x114a06['toUpperCase']());});}async[a62_0x46f496(0x250)](_0x18c862){const _0x56b3d1=a62_0x46f496;console[_0x56b3d1(0x248)](_0x56b3d1(0x2a7),_0x18c862);try{const _0xee2504=await this[_0x56b3d1(0x2af)]['processWebhook'](_0x18c862);if(!_0xee2504[_0x56b3d1(0x25c)])throw new Error(_0x56b3d1(0x27b));const _0x1b66c8=await database_1[_0x56b3d1(0x204)][_0x56b3d1(0x251)][_0x56b3d1(0x20d)]({'where':{'gatewayOrderId':_0xee2504[_0x56b3d1(0x25c)]}});if(!_0x1b66c8){console[_0x56b3d1(0x1f7)](_0x56b3d1(0x1e8)+_0xee2504['paymentId']);return;}console['log']('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0x1b66c8['id']+_0x56b3d1(0x24a)+_0xee2504[_0x56b3d1(0x21e)]),await this['updatePaymentStatus'](_0x1b66c8['id'],_0xee2504[_0x56b3d1(0x21e)],{'txUrls':_0xee2504[_0x56b3d1(0x269)]}),loggerService_1[_0x56b3d1(0x287)][_0x56b3d1(0x2c1)](_0x56b3d1(0x253),_0x1b66c8['id'],_0x1b66c8[_0x56b3d1(0x21e)],_0xee2504['status'],_0x18c862);}catch(_0x26e026){console[_0x56b3d1(0x1f7)](_0x56b3d1(0x2c6),_0x26e026),loggerService_1[_0x56b3d1(0x287)][_0x56b3d1(0x255)](_0x56b3d1(0x253),_0x26e026,_0x18c862);throw _0x26e026;}}async[a62_0x46f496(0x268)](_0xe29ca8){const _0x1a6cd7=a62_0x46f496;console[_0x1a6cd7(0x248)](_0x1a6cd7(0x2a9),_0xe29ca8);try{const _0x46cb73=await this[_0x1a6cd7(0x2af)][_0x1a6cd7(0x249)](_0xe29ca8);if(!_0x46cb73['paymentId'])throw new Error(_0x1a6cd7(0x1db));const _0x3e5c43=await database_1['default'][_0x1a6cd7(0x251)][_0x1a6cd7(0x20d)]({'where':{'gatewayOrderId':_0x46cb73[_0x1a6cd7(0x25c)]}});if(!_0x3e5c43){console[_0x1a6cd7(0x1f7)](_0x1a6cd7(0x230)+_0x46cb73['paymentId']);return;}console[_0x1a6cd7(0x248)](_0x1a6cd7(0x220)+_0x3e5c43['id']+'\x20status\x20'+_0x46cb73['status']),await this[_0x1a6cd7(0x21a)](_0x3e5c43['id'],_0x46cb73[_0x1a6cd7(0x21e)],{'txUrls':_0x46cb73[_0x1a6cd7(0x269)]}),loggerService_1['loggerService'][_0x1a6cd7(0x2c1)](_0x1a6cd7(0x277),_0x3e5c43['id'],_0x3e5c43[_0x1a6cd7(0x21e)],_0x46cb73[_0x1a6cd7(0x21e)],_0xe29ca8);}catch(_0x57e5d0){console[_0x1a6cd7(0x1f7)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x57e5d0),loggerService_1[_0x1a6cd7(0x287)]['logWebhookError'](_0x1a6cd7(0x277),_0x57e5d0,_0xe29ca8);throw _0x57e5d0;}}async[a62_0x46f496(0x295)](_0x54d09d){const _0x462478=a62_0x46f496;console['log']('🔄\x20Processing\x20Rapyd\x20webhook:',_0x54d09d);try{const _0x330c04=await this['rapydService'][_0x462478(0x249)](_0x54d09d);if(!_0x330c04[_0x462478(0x25c)])throw new Error(_0x462478(0x289));const _0x34a167=await database_1[_0x462478(0x204)][_0x462478(0x251)]['findFirst']({'where':{'gatewayOrderId':_0x330c04[_0x462478(0x25c)]}});if(!_0x34a167){console[_0x462478(0x1f7)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x330c04['paymentId']);return;}console[_0x462478(0x248)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x34a167['id']+'\x20status\x20'+_0x330c04['status']),await this[_0x462478(0x21a)](_0x34a167['id'],_0x330c04[_0x462478(0x21e)],{'failureMessage':_0x330c04[_0x462478(0x28f)],'cardLast4':_0x330c04['additionalInfo']?.[_0x462478(0x237)],'paymentMethod':_0x330c04[_0x462478(0x1ce)]?.[_0x462478(0x271)]}),loggerService_1[_0x462478(0x287)][_0x462478(0x2c1)](_0x462478(0x267),_0x34a167['id'],_0x34a167['status'],_0x330c04[_0x462478(0x21e)],_0x54d09d);}catch(_0x53f7ed){console[_0x462478(0x1f7)](_0x462478(0x2c3),_0x53f7ed),loggerService_1['loggerService'][_0x462478(0x255)]('rapyd',_0x53f7ed,_0x54d09d);throw _0x53f7ed;}}async['processNodaWebhook'](_0x53b413){const _0x259d1d=a62_0x46f496;console[_0x259d1d(0x248)](_0x259d1d(0x2b9),_0x53b413);try{const _0x274815=await this[_0x259d1d(0x1ec)][_0x259d1d(0x249)](_0x53b413);if(!_0x274815['paymentId'])throw new Error(_0x259d1d(0x1f2));const _0xac4523=await database_1[_0x259d1d(0x204)]['payment'][_0x259d1d(0x20d)]({'where':{'gatewayOrderId':_0x274815[_0x259d1d(0x25c)]}});if(!_0xac4523){console['error'](_0x259d1d(0x2be)+_0x274815[_0x259d1d(0x25c)]);return;}console[_0x259d1d(0x248)](_0x259d1d(0x212)+_0xac4523['id']+_0x259d1d(0x24a)+_0x274815[_0x259d1d(0x21e)]),await this['updatePaymentStatus'](_0xac4523['id'],_0x274815[_0x259d1d(0x21e)],{'bankId':_0x274815[_0x259d1d(0x1ce)]?.[_0x259d1d(0x262)],'remitterIban':_0x274815[_0x259d1d(0x1ce)]?.[_0x259d1d(0x2ac)],'remitterName':_0x274815[_0x259d1d(0x1ce)]?.['remitterName']}),loggerService_1[_0x259d1d(0x287)]['logWebhookProcessed'](_0x259d1d(0x1de),_0xac4523['id'],_0xac4523['status'],_0x274815[_0x259d1d(0x21e)],_0x53b413);}catch(_0xb9ce2){console['error'](_0x259d1d(0x1a7),_0xb9ce2),loggerService_1[_0x259d1d(0x287)][_0x259d1d(0x255)](_0x259d1d(0x1de),_0xb9ce2,_0x53b413);throw _0xb9ce2;}}async[a62_0x46f496(0x286)](_0x32c0dd){const _0xcf5279=a62_0x46f496;console['log']('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x32c0dd);try{const _0x4112f8=await this[_0xcf5279(0x1ff)][_0xcf5279(0x249)](_0x32c0dd);if(!_0x4112f8[_0xcf5279(0x25c)])throw new Error(_0xcf5279(0x2b5));const _0xad0b5c=await database_1[_0xcf5279(0x204)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x4112f8['paymentId']}});if(!_0xad0b5c){console['error'](_0xcf5279(0x25b)+_0x4112f8[_0xcf5279(0x25c)]);return;}console[_0xcf5279(0x248)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0xad0b5c['id']+'\x20status\x20'+_0x4112f8[_0xcf5279(0x21e)]),await this[_0xcf5279(0x21a)](_0xad0b5c['id'],_0x4112f8[_0xcf5279(0x21e)]),loggerService_1[_0xcf5279(0x287)][_0xcf5279(0x2c1)]('cointopay',_0xad0b5c['id'],_0xad0b5c[_0xcf5279(0x21e)],_0x4112f8[_0xcf5279(0x21e)],_0x32c0dd);}catch(_0x24647b){console[_0xcf5279(0x1f7)](_0xcf5279(0x28b),_0x24647b),loggerService_1[_0xcf5279(0x287)][_0xcf5279(0x255)](_0xcf5279(0x21f),_0x24647b,_0x32c0dd);throw _0x24647b;}}async[a62_0x46f496(0x288)](_0x5db8b6){const _0x2fba57=a62_0x46f496;console[_0x2fba57(0x248)](_0x2fba57(0x1d8),_0x5db8b6);try{const _0x4c7367=await this[_0x2fba57(0x211)][_0x2fba57(0x249)](_0x5db8b6);if(!_0x4c7367['paymentId'])throw new Error(_0x2fba57(0x1a2));const _0x4abc66=await database_1[_0x2fba57(0x204)][_0x2fba57(0x251)][_0x2fba57(0x20d)]({'where':{'gatewayOrderId':_0x4c7367[_0x2fba57(0x25c)]}});if(!_0x4abc66){console[_0x2fba57(0x1f7)](_0x2fba57(0x260)+_0x4c7367[_0x2fba57(0x25c)]);return;}console[_0x2fba57(0x248)](_0x2fba57(0x2b2)+_0x4abc66['id']+'\x20status\x20'+_0x4c7367[_0x2fba57(0x21e)]),await this['updatePaymentStatus'](_0x4abc66['id'],_0x4c7367[_0x2fba57(0x21e)]),loggerService_1[_0x2fba57(0x287)][_0x2fba57(0x2c1)](_0x2fba57(0x1e1),_0x4abc66['id'],_0x4abc66[_0x2fba57(0x21e)],_0x4c7367[_0x2fba57(0x21e)],_0x5db8b6);}catch(_0x1116b1){console[_0x2fba57(0x1f7)](_0x2fba57(0x1c8),_0x1116b1),loggerService_1[_0x2fba57(0x287)][_0x2fba57(0x255)](_0x2fba57(0x1e1),_0x1116b1,_0x5db8b6);throw _0x1116b1;}}async['processKlymeWebhook'](_0x5244e5){const _0x1ca1a9=a62_0x46f496;console[_0x1ca1a9(0x248)](_0x1ca1a9(0x26f),_0x5244e5);try{const _0x40b57a=await this['klymeService']['processWebhook'](_0x5244e5);if(!_0x40b57a['paymentId'])throw new Error(_0x1ca1a9(0x244));const _0x52a51d=await database_1[_0x1ca1a9(0x204)][_0x1ca1a9(0x251)]['findFirst']({'where':{'gatewayOrderId':_0x40b57a[_0x1ca1a9(0x25c)]}});if(!_0x52a51d){console[_0x1ca1a9(0x1f7)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x40b57a[_0x1ca1a9(0x25c)]);return;}console[_0x1ca1a9(0x248)](_0x1ca1a9(0x22d)+_0x52a51d['id']+_0x1ca1a9(0x24a)+_0x40b57a[_0x1ca1a9(0x21e)]),await this[_0x1ca1a9(0x21a)](_0x52a51d['id'],_0x40b57a[_0x1ca1a9(0x21e)],{'paymentMethod':_0x40b57a['additionalInfo']?.[_0x1ca1a9(0x264)]}),loggerService_1[_0x1ca1a9(0x287)]['logWebhookProcessed'](_0x1ca1a9(0x1af),_0x52a51d['id'],_0x52a51d[_0x1ca1a9(0x21e)],_0x40b57a[_0x1ca1a9(0x21e)],_0x5244e5);}catch(_0x154640){console['error'](_0x1ca1a9(0x22c),_0x154640),loggerService_1[_0x1ca1a9(0x287)][_0x1ca1a9(0x255)](_0x1ca1a9(0x1af),_0x154640,_0x5244e5);throw _0x154640;}}async[a62_0x46f496(0x261)](_0x14f40c){const _0x8775fe=a62_0x46f496;console['log'](_0x8775fe(0x1d1),JSON[_0x8775fe(0x200)](_0x14f40c,null,0x2));try{const _0x825305=await this[_0x8775fe(0x1e5)][_0x8775fe(0x249)](_0x14f40c,_0x8775fe(0x2bd));console[_0x8775fe(0x248)](_0x8775fe(0x25a),_0x825305);if(!_0x825305['paymentId']){console[_0x8775fe(0x1f7)](_0x8775fe(0x1d7)),console['error'](_0x8775fe(0x1e9),Object[_0x8775fe(0x2cb)](_0x14f40c));throw new Error('No\x20payment\x20ID\x20in\x20VISA\x20webhook');}let _0x5a8807=null;console[_0x8775fe(0x248)](_0x8775fe(0x2b4)+_0x825305[_0x8775fe(0x25c)]);if(_0x825305['paymentId']){console['log'](_0x8775fe(0x203)),console[_0x8775fe(0x248)](_0x8775fe(0x297)),console[_0x8775fe(0x248)](_0x8775fe(0x2ab)),console['log']('\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20'+_0x825305[_0x8775fe(0x25c)]),console[_0x8775fe(0x248)](_0x8775fe(0x1bd)),_0x5a8807=await database_1['default'][_0x8775fe(0x251)][_0x8775fe(0x20d)]({'where':{'AND':[{'OR':[{'gateway':_0x8775fe(0x281)},{'gateway':_0x8775fe(0x2c2)}]},{'OR':[{'gatewayPaymentId':_0x825305[_0x8775fe(0x25c)]},{'gatewayOrderId':_0x825305[_0x8775fe(0x25c)]},{'id':_0x825305[_0x8775fe(0x25c)]},{'orderId':_0x825305[_0x8775fe(0x25c)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x8775fe(0x248)](_0x8775fe(0x235));if(_0x5a8807)console['log']('✅\x20Found\x20payment:\x20ID='+_0x5a8807['id']+_0x8775fe(0x282)+_0x5a8807[_0x8775fe(0x1d5)]+_0x8775fe(0x27c)+_0x5a8807[_0x8775fe(0x26e)]);else{console[_0x8775fe(0x248)](_0x8775fe(0x298));const _0x37757f=await database_1[_0x8775fe(0x204)]['payment'][_0x8775fe(0x1b2)]({'where':{'gateway':_0x8775fe(0x281)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x8775fe(0x26b)}});console[_0x8775fe(0x248)](_0x8775fe(0x1f5),_0x37757f['map'](_0x29c756=>_0x29c756['id']+_0x8775fe(0x259)+_0x29c756[_0x8775fe(0x2b8)]+_0x8775fe(0x232)+_0x29c756[_0x8775fe(0x1d5)]+_0x8775fe(0x24f)+_0x29c756[_0x8775fe(0x26e)]+',\x20card:\x20****'+_0x29c756[_0x8775fe(0x237)]+')'));}console['log'](_0x8775fe(0x1cb)+(_0x5a8807?_0x8775fe(0x27e):_0x8775fe(0x21d))),_0x5a8807&&console[_0x8775fe(0x248)](_0x8775fe(0x1fc)+_0x5a8807['id']+_0x8775fe(0x1e7)+_0x5a8807[_0x8775fe(0x1a3)]+_0x8775fe(0x1a5)+_0x5a8807[_0x8775fe(0x21e)]+_0x8775fe(0x1dc)+_0x5a8807[_0x8775fe(0x237)]);}if(!_0x5a8807){console['error'](_0x8775fe(0x2d5)+_0x825305[_0x8775fe(0x25c)]),loggerService_1['loggerService'][_0x8775fe(0x255)]('visa',new Error('Payment\x20not\x20found:\x20'+_0x825305[_0x8775fe(0x25c)]),_0x14f40c);throw new Error(_0x8775fe(0x1bf)+_0x825305[_0x8775fe(0x25c)]);}console[_0x8775fe(0x248)](_0x8775fe(0x1d6)+_0x5a8807['id']+_0x8775fe(0x1c5)+_0x5a8807[_0x8775fe(0x21e)]+'\x20→\x20'+_0x825305[_0x8775fe(0x21e)]+')');const _0x4d202f={};_0x825305[_0x8775fe(0x20e)]&&await database_1[_0x8775fe(0x204)][_0x8775fe(0x251)][_0x8775fe(0x1b7)]({'where':{'id':_0x5a8807['id']},'data':{'amount':_0x825305[_0x8775fe(0x20e)],'updatedAt':new Date()}}),_0x825305[_0x8775fe(0x1eb)]&&await database_1[_0x8775fe(0x204)]['payment'][_0x8775fe(0x1b7)]({'where':{'id':_0x5a8807['id']},'data':{'currency':_0x825305[_0x8775fe(0x1eb)],'updatedAt':new Date()}}),_0x825305[_0x8775fe(0x21e)]==='FAILED'&&_0x825305[_0x8775fe(0x28f)]&&(_0x4d202f[_0x8775fe(0x28f)]=_0x825305[_0x8775fe(0x28f)],console[_0x8775fe(0x248)]('❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20'+_0x825305[_0x8775fe(0x28f)])),_0x4d202f[_0x8775fe(0x271)]=_0x8775fe(0x1ca),await this[_0x8775fe(0x21a)](_0x5a8807['id'],_0x825305[_0x8775fe(0x21e)],_0x4d202f),await database_1['default'][_0x8775fe(0x1df)][_0x8775fe(0x1bc)]({'data':{'paymentId':_0x5a8807['id'],'shopId':_0x5a8807['shopId'],'event':_0x8775fe(0x2cd)+_0x825305[_0x8775fe(0x21e)][_0x8775fe(0x1c6)](),'statusCode':0xc8,'responseBody':JSON[_0x8775fe(0x200)](_0x825305)}}),await this[_0x8775fe(0x1f0)](_0x5a8807,_0x825305['status']['toUpperCase']()),console[_0x8775fe(0x248)](_0x8775fe(0x29f)+_0x5a8807['id']);}catch(_0x101f4d){console['error'](_0x8775fe(0x2cc),_0x101f4d),loggerService_1[_0x8775fe(0x287)][_0x8775fe(0x255)](_0x8775fe(0x1ca),_0x101f4d,_0x14f40c);throw _0x101f4d;}}async[a62_0x46f496(0x2d1)](_0x1c9b3b){const _0x26c308=a62_0x46f496;console['log']('🔄\x20Processing\x20MasterCard\x20webhook:',JSON[_0x26c308(0x200)](_0x1c9b3b,null,0x2));try{const _0x137f08=await this['visaMasterCardService'][_0x26c308(0x249)](_0x1c9b3b,_0x26c308(0x1ef));console['log'](_0x26c308(0x2c8),_0x137f08);if(!_0x137f08[_0x26c308(0x25c)]){console[_0x26c308(0x1f7)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data'),console[_0x26c308(0x1f7)]('❌\x20Available\x20webhook\x20fields:',Object[_0x26c308(0x2cb)](_0x1c9b3b));throw new Error(_0x26c308(0x24b));}let _0x1118bc=null;console[_0x26c308(0x248)](_0x26c308(0x29b)+_0x137f08['paymentId']);_0x137f08[_0x26c308(0x25c)]&&(console[_0x26c308(0x248)]('🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x1118bc=await database_1['default'][_0x26c308(0x251)][_0x26c308(0x20d)]({'where':{'AND':[{'OR':[{'gateway':_0x26c308(0x26d)},{'gateway':_0x26c308(0x2c2)},{'gateway':'visa/mastercard'}]},{'OR':[{'gatewayPaymentId':_0x137f08[_0x26c308(0x25c)]},{'gatewayOrderId':_0x137f08[_0x26c308(0x25c)]},{'id':_0x137f08['paymentId']},{'orderId':_0x137f08['paymentId']}]}]}}),console['log'](_0x26c308(0x1d3)+(_0x1118bc?'Found\x20payment\x20'+_0x1118bc['id']:_0x26c308(0x23c))));if(!_0x1118bc){console['error'](_0x26c308(0x22b)+_0x137f08['paymentId']),console[_0x26c308(0x1f7)](_0x26c308(0x19b)+_0x137f08[_0x26c308(0x25c)]+_0x26c308(0x21b)+_0x137f08[_0x26c308(0x25c)]+_0x26c308(0x291)+_0x137f08['paymentId']+'\x22');const _0x487622=await database_1[_0x26c308(0x204)]['payment']['findMany']({'where':{'OR':[{'gateway':_0x26c308(0x2c2)},{'gateway':_0x26c308(0x26d)},{'gateway':_0x26c308(0x281)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x26c308(0x26b)},'take':0xf});console[_0x26c308(0x248)](_0x26c308(0x2c0),_0x487622),loggerService_1[_0x26c308(0x287)][_0x26c308(0x255)](_0x26c308(0x2c2),new Error(_0x26c308(0x2c4)+_0x137f08[_0x26c308(0x25c)]),_0x1c9b3b);throw new Error('MasterCard\x20payment\x20not\x20found:\x20'+_0x137f08[_0x26c308(0x25c)]);}console[_0x26c308(0x248)]('✅\x20Found\x20payment\x20'+_0x1118bc['id']+_0x26c308(0x2bb)+_0x1118bc[_0x26c308(0x21e)]+_0x26c308(0x1b9)+_0x137f08[_0x26c308(0x21e)]);const _0x23df28={};_0x137f08[_0x26c308(0x20e)]&&await database_1[_0x26c308(0x204)]['payment']['update']({'where':{'id':_0x1118bc['id']},'data':{'amount':_0x137f08['amount'],'updatedAt':new Date()}}),_0x137f08[_0x26c308(0x1eb)]&&await database_1[_0x26c308(0x204)][_0x26c308(0x251)][_0x26c308(0x1b7)]({'where':{'id':_0x1118bc['id']},'data':{'currency':_0x137f08[_0x26c308(0x1eb)],'updatedAt':new Date()}}),_0x137f08[_0x26c308(0x21e)]===_0x26c308(0x1e6)&&_0x137f08[_0x26c308(0x28f)]&&(_0x23df28[_0x26c308(0x28f)]=_0x137f08[_0x26c308(0x28f)],console[_0x26c308(0x248)]('❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20'+_0x137f08['failureMessage'])),_0x23df28[_0x26c308(0x271)]=_0x26c308(0x2c2),await this[_0x26c308(0x21a)](_0x1118bc['id'],_0x137f08['status'],_0x23df28),loggerService_1[_0x26c308(0x287)][_0x26c308(0x2c1)](_0x26c308(0x2c2),_0x1118bc['id'],_0x1118bc['status'],_0x137f08[_0x26c308(0x21e)],_0x1c9b3b);}catch(_0x295fa3){console[_0x26c308(0x1f7)](_0x26c308(0x2a6),_0x295fa3),loggerService_1['loggerService'][_0x26c308(0x255)](_0x26c308(0x2c2),_0x295fa3,_0x1c9b3b);throw _0x295fa3;}}async[a62_0x46f496(0x2c9)](_0x339e4a){const _0x22b718=a62_0x46f496;console[_0x22b718(0x248)](_0x22b718(0x279),JSON[_0x22b718(0x200)](_0x339e4a,null,0x2));try{const _0x319cdf=await this[_0x22b718(0x290)][_0x22b718(0x249)](_0x339e4a);console[_0x22b718(0x248)](_0x22b718(0x1f8),_0x319cdf);if(!_0x319cdf[_0x22b718(0x25c)]){console[_0x22b718(0x1f7)](_0x22b718(0x2a2)),console[_0x22b718(0x1f7)]('❌\x20Available\x20webhook\x20fields:',Object[_0x22b718(0x2cb)](_0x339e4a));throw new Error(_0x22b718(0x1f4));}let _0x4ef438=null;console[_0x22b718(0x248)](_0x22b718(0x213)+_0x319cdf[_0x22b718(0x25c)]),_0x4ef438=await database_1[_0x22b718(0x204)][_0x22b718(0x251)][_0x22b718(0x20d)]({'where':{'AND':[{'gateway':_0x22b718(0x25e)},{'OR':[{'gatewayPaymentId':_0x319cdf[_0x22b718(0x25c)]},{'gatewayOrderId':_0x319cdf[_0x22b718(0x25c)]},{'id':_0x319cdf[_0x22b718(0x25c)]},{'orderId':_0x319cdf['paymentId']}]}]}}),console[_0x22b718(0x248)](_0x22b718(0x1d3)+(_0x4ef438?'Found\x20payment\x20'+_0x4ef438['id']:_0x22b718(0x23c)));if(!_0x4ef438){console[_0x22b718(0x1f7)](_0x22b718(0x234)+_0x319cdf[_0x22b718(0x25c)]);return;}console['log'](_0x22b718(0x1b1)+_0x4ef438['id']+_0x22b718(0x24a)+_0x319cdf[_0x22b718(0x21e)]),await this[_0x22b718(0x21a)](_0x4ef438['id'],_0x319cdf['status'],{'cardLast4':_0x319cdf[_0x22b718(0x1ce)]?.['cardLast4'],'paymentMethod':_0x319cdf[_0x22b718(0x1ce)]?.['paymentMethod']});}catch(_0x76a89e){console[_0x22b718(0x1f7)]('❌\x20Error\x20processing\x20Amer\x20webhook:',_0x76a89e),loggerService_1['loggerService'][_0x22b718(0x255)](_0x22b718(0x25e),_0x76a89e,_0x339e4a);throw _0x76a89e;}}async[a62_0x46f496(0x1fd)](_0x5277b6){const _0x3b8b64=a62_0x46f496;console[_0x3b8b64(0x248)](_0x3b8b64(0x24d),JSON[_0x3b8b64(0x200)](_0x5277b6,null,0x2));try{const _0x3b9ad6=_0x5277b6['status'],_0x5b98a3=_0x5277b6[_0x3b8b64(0x1c1)],_0x2347b2=_0x5277b6[_0x3b8b64(0x229)],_0x3fc794=_0x5277b6[_0x3b8b64(0x264)],_0x349634=_0x5277b6[_0x3b8b64(0x20e)],_0x466e1a=_0x5277b6[_0x3b8b64(0x1eb)],_0x26f2b5=_0x5277b6['commission'],_0xe24299=_0x5277b6[_0x3b8b64(0x28d)];if(!_0x5b98a3){console['error'](_0x3b8b64(0x1d2));throw new Error(_0x3b8b64(0x1ed));}console[_0x3b8b64(0x248)](_0x3b8b64(0x221),{'status':_0x3b9ad6,'clientTransactionId':_0x5b98a3,'systemId':_0x2347b2,'paymentMethod':_0x3fc794,'amount':_0x349634,'currency':_0x466e1a,'commission':_0x26f2b5,'statusAdditionInfo':_0xe24299});const _0x2833b7=await database_1[_0x3b8b64(0x204)][_0x3b8b64(0x251)][_0x3b8b64(0x20d)]({'where':{'OR':[{'gatewayOrderId':_0x5b98a3},{'orderId':_0x5b98a3},{'id':_0x5b98a3},{'gatewayPaymentId':_0x5b98a3}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x2833b7){console[_0x3b8b64(0x1f7)](_0x3b8b64(0x1a4)+_0x5b98a3);throw new Error(_0x3b8b64(0x2c4)+_0x5b98a3);}console[_0x3b8b64(0x248)](_0x3b8b64(0x1a1)+_0x2833b7['id']+_0x3b8b64(0x243)),console['log']('📊\x20Payment\x20status:\x20'+_0x2833b7[_0x3b8b64(0x21e)]+_0x3b8b64(0x240)+_0x3b9ad6),_0x3b9ad6===_0x3b8b64(0x2a5)?(console[_0x3b8b64(0x248)]('🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED'),await this[_0x3b8b64(0x21a)](_0x2833b7['id'],_0x3b8b64(0x1e6)),console['log']('✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20'+_0x2833b7['id']+_0x3b8b64(0x276)),console[_0x3b8b64(0x248)](_0x3b8b64(0x1da)+(_0xe24299||_0x3b8b64(0x270)))):console[_0x3b8b64(0x248)]('ℹ️\x20AmPay\x20status\x20'+_0x3b9ad6+_0x3b8b64(0x238)),await database_1[_0x3b8b64(0x204)]['webhookLog'][_0x3b8b64(0x1bc)]({'data':{'paymentId':_0x2833b7['id'],'shopId':_0x2833b7[_0x3b8b64(0x293)],'event':_0x3b8b64(0x206)+(_0x3b9ad6?.[_0x3b8b64(0x1c6)]()||_0x3b8b64(0x1c7)),'statusCode':0xc8,'responseBody':JSON[_0x3b8b64(0x200)](_0x5277b6)}}),loggerService_1['loggerService'][_0x3b8b64(0x2c1)](_0x3b8b64(0x1e3),_0x2833b7['id'],_0x2833b7[_0x3b8b64(0x21e)],_0x3b9ad6===_0x3b8b64(0x2a5)?_0x3b8b64(0x1e6):_0x3b9ad6,_0x5277b6);}catch(_0x2d55fc){console[_0x3b8b64(0x1f7)](_0x3b8b64(0x209),_0x2d55fc),loggerService_1[_0x3b8b64(0x287)]['logWebhookError'](_0x3b8b64(0x1e3),_0x2d55fc,_0x5277b6);throw _0x2d55fc;}}async['sendShopWebhook'](_0x48e23a,_0x9866a2){const _0x3255e8=a62_0x46f496,_0x585f22=Date[_0x3255e8(0x252)]();try{const _0x1a9e8f=_0x48e23a['shop'],_0x5f530f=_0x1a9e8f[_0x3255e8(0x201)];if(!_0x5f530f?.[_0x3255e8(0x299)]){console[_0x3255e8(0x248)](_0x3255e8(0x1ab)+_0x1a9e8f['id']);return;}const _0x1f92fc=_0x9866a2===_0x3255e8(0x222)?_0x3255e8(0x19c):_0x9866a2===_0x3255e8(0x1e6)?_0x3255e8(0x1a0):_0x9866a2===_0x3255e8(0x263)?_0x3255e8(0x1a0):_0x9866a2===_0x3255e8(0x1f1)?'payment.failed':_0x9866a2===_0x3255e8(0x25f)?'payment.failed':_0x3255e8(0x245);let _0x4ba768=[];if(_0x5f530f[_0x3255e8(0x246)])try{_0x4ba768=Array[_0x3255e8(0x233)](_0x5f530f[_0x3255e8(0x246)])?_0x5f530f[_0x3255e8(0x246)]:JSON['parse'](_0x5f530f[_0x3255e8(0x246)]);}catch(_0x538854){console[_0x3255e8(0x1f7)](_0x3255e8(0x23a),_0x538854),_0x4ba768=[];}if(!_0x4ba768['includes'](_0x1f92fc)){console[_0x3255e8(0x248)](_0x3255e8(0x2d2)+_0x1f92fc+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1a9e8f['id']);return;}const _0x48ad55={'event':_0x1f92fc,'payment':{'id':_0x48e23a['id'],'order_id':_0x48e23a[_0x3255e8(0x2b8)],'gateway_order_id':_0x48e23a[_0x3255e8(0x1d5)],'gateway':_0x48e23a['gateway'],'amount':_0x48e23a['amount'],'currency':_0x48e23a[_0x3255e8(0x1eb)],'status':_0x9866a2[_0x3255e8(0x1c6)](),'customer_email':_0x48e23a['customerEmail'],'customer_name':_0x48e23a[_0x3255e8(0x1ae)],'failure_message':_0x48e23a[_0x3255e8(0x28f)],'tx_urls':_0x48e23a[_0x3255e8(0x269)]?JSON[_0x3255e8(0x25d)](_0x48e23a[_0x3255e8(0x269)]):null,'created_at':_0x48e23a['createdAt'],'updated_at':_0x48e23a[_0x3255e8(0x280)]}},_0x2d7644=await fetch(_0x5f530f[_0x3255e8(0x299)],{'method':_0x3255e8(0x24e),'headers':{'Content-Type':_0x3255e8(0x283),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x3255e8(0x200)](_0x48ad55)}),_0x57a2ba=Date[_0x3255e8(0x252)]()-_0x585f22,_0x2e1f04=_0x2d7644['ok']?_0x3255e8(0x1fe):await _0x2d7644[_0x3255e8(0x225)]();loggerService_1[_0x3255e8(0x287)][_0x3255e8(0x1cc)](_0x48e23a[_0x3255e8(0x293)],_0x5f530f[_0x3255e8(0x299)],_0x1f92fc,_0x2d7644[_0x3255e8(0x21e)],_0x57a2ba,_0x48ad55),console[_0x3255e8(0x248)](_0x3255e8(0x1e0)+_0x5f530f[_0x3255e8(0x299)]+_0x3255e8(0x1cf)+_0x2d7644[_0x3255e8(0x21e)]+'\x20('+_0x57a2ba+_0x3255e8(0x2a0));}catch(_0x44de43){console[_0x3255e8(0x1f7)](_0x3255e8(0x1b4),_0x44de43),loggerService_1['loggerService']['logShopWebhookError'](_0x48e23a[_0x3255e8(0x293)],_0x48e23a['shop']?.[_0x3255e8(0x201)]?.[_0x3255e8(0x299)]||_0x3255e8(0x1c7),_0x3255e8(0x266),_0x44de43,{});}}async[a62_0x46f496(0x1f0)](_0x348bfd,_0x246b06){const _0x38fb83=a62_0x46f496;try{const _0x34b9ef={'PENDING':_0x38fb83(0x247),'PROCESSING':_0x38fb83(0x1f6),'PAID':_0x38fb83(0x29a),'FAILED':'failed','EXPIRED':_0x38fb83(0x1bb),'REFUND':'refund','CHARGEBACK':_0x38fb83(0x1b3)},_0x57f976=_0x34b9ef[_0x246b06];if(!_0x57f976||_0x57f976===_0x38fb83(0x247))return;await telegramBotService_1[_0x38fb83(0x28c)]['sendPaymentNotification'](_0x348bfd['shopId'],_0x348bfd,_0x57f976);}catch(_0x5d9a27){console[_0x38fb83(0x1f7)](_0x38fb83(0x1c0),_0x5d9a27);}}async['getGatewayCommission'](_0x212f90,_0x4ba584){const _0x441ee1=a62_0x46f496;try{const _0x3709d8=await database_1['default'][_0x441ee1(0x29d)][_0x441ee1(0x1ee)]({'where':{'id':_0x212f90},'select':{'gatewaySettings':!![]}});if(!_0x3709d8?.[_0x441ee1(0x2ba)])return console['log'](_0x441ee1(0x218)+_0x212f90+_0x441ee1(0x275)),0xa;const _0x30c9ad=JSON[_0x441ee1(0x25d)](_0x3709d8[_0x441ee1(0x2ba)]);for(const [_0x5ca247,_0x296135]of Object[_0x441ee1(0x2ad)](_0x30c9ad)){if(_0x5ca247[_0x441ee1(0x1c6)]()===_0x4ba584[_0x441ee1(0x1c6)]()){const _0x593b98=_0x296135[_0x441ee1(0x2c7)]||0xa;return console[_0x441ee1(0x248)](_0x441ee1(0x20a)+_0x4ba584+_0x441ee1(0x28a)+_0x212f90+':\x20'+_0x593b98+'%'),_0x593b98;}}return console[_0x441ee1(0x248)](_0x441ee1(0x256)+_0x4ba584+_0x441ee1(0x1d0)+_0x212f90+',\x20using\x20default\x2010%'),0xa;}catch(_0x29b624){return console[_0x441ee1(0x1f7)](_0x441ee1(0x227)+_0x212f90+',\x20gateway\x20'+_0x4ba584+':',_0x29b624),0xa;}}async['processMyXSpendWebhook'](_0x768e6d,_0x3ef031){const _0x31806c=a62_0x46f496;console['log'](_0x31806c(0x2cf)),console[_0x31806c(0x248)]('Query\x20params:',JSON[_0x31806c(0x200)](_0x768e6d,null,0x2)),console[_0x31806c(0x248)](_0x31806c(0x2c5),JSON[_0x31806c(0x200)](_0x3ef031,null,0x2));try{const _0x1f3826=_0x768e6d['customerOrderId']||_0x3ef031[_0x31806c(0x198)],_0xcef357=_0x768e6d['status']||_0x3ef031[_0x31806c(0x21e)],_0x53a80f=_0x768e6d[_0x31806c(0x20e)]||_0x3ef031[_0x31806c(0x20e)],_0x44297c=_0x768e6d[_0x31806c(0x1eb)]||_0x3ef031['currency'],_0x1fe5e9=_0x768e6d[_0x31806c(0x1d4)]||_0x3ef031[_0x31806c(0x1d4)];if(!_0x1f3826){console[_0x31806c(0x1f7)](_0x31806c(0x19f));throw new Error(_0x31806c(0x1b5));}console['log'](_0x31806c(0x285),{'customerOrderId':_0x1f3826,'status':_0xcef357,'amount':_0x53a80f,'currency':_0x44297c,'dateTime':_0x1fe5e9});const _0x1a7dcc=await database_1[_0x31806c(0x204)][_0x31806c(0x251)][_0x31806c(0x20d)]({'where':{'OR':[{'gatewayOrderId':_0x1f3826},{'orderId':_0x1f3826},{'id':_0x1f3826},{'gatewayPaymentId':_0x1f3826}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1a7dcc){console[_0x31806c(0x1f7)](_0x31806c(0x219)+_0x1f3826);throw new Error(_0x31806c(0x2c4)+_0x1f3826);}console['log']('✅\x20Found\x20payment\x20'+_0x1a7dcc['id']+_0x31806c(0x19e)),console[_0x31806c(0x248)](_0x31806c(0x274)+_0x1a7dcc['status']+_0x31806c(0x240)+_0xcef357);let _0x3a76a9=_0xcef357?.[_0x31806c(0x239)]();_0xcef357===_0x31806c(0x1e6)||_0xcef357===_0x31806c(0x263)?(_0x3a76a9=_0x31806c(0x1e6),console['log'](_0x31806c(0x257)+_0xcef357+_0x31806c(0x226)),await this[_0x31806c(0x21a)](_0x1a7dcc['id'],_0x3a76a9),console[_0x31806c(0x248)]('✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20'+_0x1a7dcc['id']+_0x31806c(0x276))):console[_0x31806c(0x248)]('ℹ️\x20MyXSpend\x20status\x20'+_0xcef357+'\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)'),await database_1[_0x31806c(0x204)][_0x31806c(0x1df)][_0x31806c(0x1bc)]({'data':{'paymentId':_0x1a7dcc['id'],'shopId':_0x1a7dcc[_0x31806c(0x293)],'event':_0x31806c(0x20b)+(_0xcef357?.[_0x31806c(0x1c6)]()||'unknown'),'statusCode':0xc8,'responseBody':JSON[_0x31806c(0x200)]({'queryParams':_0x768e6d,'bodyData':_0x3ef031})}}),loggerService_1['loggerService'][_0x31806c(0x2c1)](_0x31806c(0x2ca),_0x1a7dcc['id'],_0x1a7dcc[_0x31806c(0x21e)],_0x3a76a9||_0xcef357,{'queryParams':_0x768e6d,'bodyData':_0x3ef031});}catch(_0x293c0a){console[_0x31806c(0x1f7)](_0x31806c(0x265),_0x293c0a),loggerService_1['loggerService'][_0x31806c(0x255)](_0x31806c(0x2ca),_0x293c0a,{'queryParams':_0x768e6d,'bodyData':_0x3ef031});throw _0x293c0a;}}}exports[a62_0x46f496(0x2a8)]=WebhookService;