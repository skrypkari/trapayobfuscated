'use strict';const a58_0x59f751=a58_0x1d16;function a58_0x1d16(_0x5d7e53,_0x53586c){const _0xdb7185=a58_0xdb71();return a58_0x1d16=function(_0x1d16f4,_0x1c3615){_0x1d16f4=_0x1d16f4-0x155;let _0x141e8a=_0xdb7185[_0x1d16f4];return _0x141e8a;},a58_0x1d16(_0x5d7e53,_0x53586c);}(function(_0x149350,_0x5e7cf9){const _0x4199a9=a58_0x1d16,_0x3cc486=_0x149350();while(!![]){try{const _0x5dee0b=-parseInt(_0x4199a9(0x211))/0x1+parseInt(_0x4199a9(0x1cd))/0x2*(-parseInt(_0x4199a9(0x1eb))/0x3)+-parseInt(_0x4199a9(0x20e))/0x4+-parseInt(_0x4199a9(0x1f1))/0x5*(parseInt(_0x4199a9(0x182))/0x6)+-parseInt(_0x4199a9(0x166))/0x7*(-parseInt(_0x4199a9(0x196))/0x8)+parseInt(_0x4199a9(0x206))/0x9*(parseInt(_0x4199a9(0x19b))/0xa)+parseInt(_0x4199a9(0x162))/0xb;if(_0x5dee0b===_0x5e7cf9)break;else _0x3cc486['push'](_0x3cc486['shift']());}catch(_0x2486f5){_0x3cc486['push'](_0x3cc486['shift']());}}}(a58_0xdb71,0x357f0));var __importDefault=this&&this['__importDefault']||function(_0x49896e){const _0x4a1959=a58_0x1d16;return _0x49896e&&_0x49896e[_0x4a1959(0x1af)]?_0x49896e:{'default':_0x49896e};};Object[a58_0x59f751(0x1a5)](exports,a58_0x59f751(0x1af),{'value':!![]}),exports[a58_0x59f751(0x1ce)]=void 0x0;const database_1=__importDefault(require(a58_0x59f751(0x167))),plisioService_1=require(a58_0x59f751(0x220)),rapydService_1=require(a58_0x59f751(0x195)),nodaService_1=require(a58_0x59f751(0x1e5)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a58_0x59f751(0x177)),klymeService_1=require(a58_0x59f751(0x1f6)),mastercardService_1=require(a58_0x59f751(0x1bc)),telegramBotService_1=require(a58_0x59f751(0x22a)),currencyService_1=require(a58_0x59f751(0x1cb)),loggerService_1=require(a58_0x59f751(0x17f));class WebhookService{constructor(){const _0x4cdbba=a58_0x59f751;this[_0x4cdbba(0x1de)]=new plisioService_1[(_0x4cdbba(0x236))](),this['rapydService']=new rapydService_1[(_0x4cdbba(0x22b))](),this[_0x4cdbba(0x190)]=new nodaService_1[(_0x4cdbba(0x229))](),this[_0x4cdbba(0x175)]=new coinToPayService_1['CoinToPayService'](),this['coinToPay2Service']=new coinToPay2Service_1['CoinToPay2Service'](),this['klymeService']=new klymeService_1['KlymeService'](),this[_0x4cdbba(0x1e4)]=new mastercardService_1[(_0x4cdbba(0x1c4))]();}async[a58_0x59f751(0x1b2)](_0x5a6d02,_0x4361cd,_0x31f5ef){const _0x3dfb3f=a58_0x59f751;console['log']('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x5a6d02+_0x3dfb3f(0x1e1)+_0x4361cd),console[_0x3dfb3f(0x227)](_0x3dfb3f(0x1fc),_0x31f5ef),await database_1[_0x3dfb3f(0x19a)][_0x3dfb3f(0x1df)](async _0x52bd7c=>{const _0x393e8c=_0x3dfb3f,_0x194c85=await _0x52bd7c[_0x393e8c(0x1cc)][_0x393e8c(0x234)]({'where':{'id':_0x5a6d02},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x194c85)throw new Error(_0x393e8c(0x21a)+_0x5a6d02+_0x393e8c(0x1ac));const _0x6edb65=_0x194c85[_0x393e8c(0x215)],_0x36744e=_0x194c85[_0x393e8c(0x183)];console[_0x393e8c(0x227)]('💰\x20Payment\x20'+_0x5a6d02+':\x20'+_0x6edb65+_0x393e8c(0x171)+_0x4361cd),console[_0x393e8c(0x227)](_0x393e8c(0x197)+_0x36744e[_0x393e8c(0x226)]+'\x20current\x20balance:\x20'+_0x36744e[_0x393e8c(0x230)]+'\x20USDT');const _0x44637e={'status':_0x4361cd[_0x393e8c(0x1f2)](),'updatedAt':new Date(),'statusChangedBy':_0x393e8c(0x213),'statusChangedAt':new Date()};_0x31f5ef?.['failureMessage']&&(_0x44637e[_0x393e8c(0x1c7)]=_0x31f5ef[_0x393e8c(0x1c7)]);_0x31f5ef?.[_0x393e8c(0x202)]&&(_0x44637e['txUrls']=JSON[_0x393e8c(0x1bd)](_0x31f5ef[_0x393e8c(0x202)]));_0x31f5ef?.[_0x393e8c(0x1f3)]&&(_0x44637e[_0x393e8c(0x1f3)]=_0x31f5ef[_0x393e8c(0x1f3)]);_0x31f5ef?.[_0x393e8c(0x225)]&&(_0x44637e[_0x393e8c(0x225)]=_0x31f5ef[_0x393e8c(0x225)]);_0x31f5ef?.[_0x393e8c(0x1c1)]&&(_0x44637e[_0x393e8c(0x1c1)]=_0x31f5ef['bankId']);_0x31f5ef?.['remitterIban']&&(_0x44637e[_0x393e8c(0x1b4)]=_0x31f5ef[_0x393e8c(0x1b4)]);_0x31f5ef?.[_0x393e8c(0x189)]&&(_0x44637e[_0x393e8c(0x189)]=_0x31f5ef['remitterName']);let _0x5796c7=_0x36744e[_0x393e8c(0x230)],_0x25a9aa='';if(_0x4361cd[_0x393e8c(0x1f2)]()===_0x393e8c(0x174)&&_0x6edb65!==_0x393e8c(0x174)){const _0x393b2b=await currencyService_1[_0x393e8c(0x1d2)]['convertToUSDT'](_0x194c85[_0x393e8c(0x224)],_0x194c85[_0x393e8c(0x1a3)]),_0x4e1ee3=await this[_0x393e8c(0x20b)](_0x36744e['id'],_0x194c85['gateway']),_0x3dd893=_0x393b2b*(0x1-_0x4e1ee3/0x64);_0x5796c7+=_0x3dd893,_0x25a9aa='+'+_0x3dd893['toFixed'](0x6)+_0x393e8c(0x181)+_0x4e1ee3+_0x393e8c(0x1a9),_0x44637e[_0x393e8c(0x169)]=_0x393b2b,_0x44637e[_0x393e8c(0x21d)]=_0x3dd893,_0x44637e['paidAt']=new Date(),console[_0x393e8c(0x227)](_0x393e8c(0x212)+_0x194c85[_0x393e8c(0x224)]+'\x20'+_0x194c85[_0x393e8c(0x1a3)]+_0x393e8c(0x171)+_0x393b2b['toFixed'](0x6)+'\x20USDT'),console[_0x393e8c(0x227)]('💰\x20Gateway\x20'+_0x194c85[_0x393e8c(0x1b9)]+_0x393e8c(0x1c9)+_0x4e1ee3+'%'),console[_0x393e8c(0x227)](_0x393e8c(0x1f5)+_0x3dd893[_0x393e8c(0x15d)](0x6)+_0x393e8c(0x1ec)),console[_0x393e8c(0x227)]('💰\x20Adding\x20to\x20balance:\x20'+_0x36744e[_0x393e8c(0x230)]+_0x393e8c(0x1a7)+_0x3dd893[_0x393e8c(0x15d)](0x6)+_0x393e8c(0x16e)+_0x5796c7[_0x393e8c(0x15d)](0x6)+_0x393e8c(0x1ec));}else{if(_0x6edb65==='PAID'&&_0x4361cd[_0x393e8c(0x1f2)]()!=='PAID'){let _0x5e0891;if(_0x194c85['amountAfterGatewayCommissionUSDT'])_0x5e0891=_0x194c85['amountAfterGatewayCommissionUSDT'];else{if(_0x194c85[_0x393e8c(0x169)]){const _0x591173=await this[_0x393e8c(0x20b)](_0x36744e['id'],_0x194c85['gateway']);_0x5e0891=_0x194c85[_0x393e8c(0x169)]*(0x1-_0x591173/0x64);}else console[_0x393e8c(0x227)](_0x393e8c(0x22c)),_0x5e0891=0x0;}_0x5e0891>0x0&&(_0x5796c7-=_0x5e0891,_0x25a9aa='-'+_0x5e0891[_0x393e8c(0x15d)](0x6)+_0x393e8c(0x17b),_0x44637e[_0x393e8c(0x169)]=null,_0x44637e[_0x393e8c(0x21d)]=null,_0x44637e[_0x393e8c(0x1dd)]=null,console['log'](_0x393e8c(0x1ea)+_0x36744e[_0x393e8c(0x230)]+_0x393e8c(0x161)+_0x5e0891[_0x393e8c(0x15d)](0x6)+_0x393e8c(0x16e)+_0x5796c7[_0x393e8c(0x15d)](0x6)+_0x393e8c(0x1ec)));}}if(_0x4361cd[_0x393e8c(0x1f2)]()==='CHARGEBACK'){const _0x434737=_0x31f5ef?.[_0x393e8c(0x1e9)]||0x0;_0x434737>0x0&&(_0x5796c7-=_0x434737,_0x25a9aa+=_0x393e8c(0x192)+_0x434737[_0x393e8c(0x15d)](0x6)+_0x393e8c(0x15a),_0x44637e['chargebackAmount']=_0x434737,console['log']('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0x434737[_0x393e8c(0x15d)](0x6)+'\x20USDT'),console[_0x393e8c(0x227)](_0x393e8c(0x1f0)+_0x5796c7[_0x393e8c(0x15d)](0x6)+_0x393e8c(0x1ec)));}const _0x28a228=await _0x52bd7c[_0x393e8c(0x1cc)][_0x393e8c(0x221)]({'where':{'id':_0x5a6d02},'data':_0x44637e});_0x5796c7!==_0x36744e[_0x393e8c(0x230)]&&(await _0x52bd7c[_0x393e8c(0x183)][_0x393e8c(0x221)]({'where':{'id':_0x36744e['id']},'data':{'balance':_0x5796c7}}),console['log']('✅\x20Shop\x20'+_0x36744e[_0x393e8c(0x226)]+'\x20balance\x20updated:\x20'+_0x36744e[_0x393e8c(0x230)][_0x393e8c(0x15d)](0x6)+_0x393e8c(0x171)+_0x5796c7[_0x393e8c(0x15d)](0x6)+_0x393e8c(0x1ec)),console['log'](_0x393e8c(0x21b)+_0x25a9aa));await _0x52bd7c[_0x393e8c(0x1bf)][_0x393e8c(0x19f)]({'data':{'paymentId':_0x5a6d02,'shopId':_0x36744e['id'],'event':'webhook_status_change_'+_0x4361cd[_0x393e8c(0x203)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x6edb65,'newStatus':_0x4361cd[_0x393e8c(0x1f2)](),'balanceChange':_0x25a9aa||'no\x20balance\x20change','oldBalance':_0x36744e[_0x393e8c(0x230)],'newBalance':_0x5796c7,'amountUSDT':_0x44637e[_0x393e8c(0x169)],'additionalData':_0x31f5ef,'timestamp':new Date()[_0x393e8c(0x19e)]()})}}),await this[_0x393e8c(0x16f)]({..._0x194c85,..._0x28a228,'shop':_0x36744e},_0x4361cd[_0x393e8c(0x1f2)]()),await this[_0x393e8c(0x187)]({..._0x194c85,..._0x28a228},_0x4361cd['toUpperCase']());if(_0x6edb65!==_0x393e8c(0x174)&&_0x4361cd[_0x393e8c(0x1f2)]()===_0x393e8c(0x174)){console[_0x393e8c(0x227)]('📈\x20Payment\x20'+_0x5a6d02+_0x393e8c(0x20a)),console[_0x393e8c(0x227)](_0x393e8c(0x22d)+_0x6edb65+_0x393e8c(0x158)+_0x4361cd[_0x393e8c(0x1f2)]()+'\x22,\x20paymentLinkId=\x22'+_0x194c85['paymentLinkId']+'\x22');if(_0x194c85[_0x393e8c(0x194)])try{const _0x5a8e23=await _0x52bd7c[_0x393e8c(0x22f)][_0x393e8c(0x234)]({'where':{'id':_0x194c85[_0x393e8c(0x194)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5a8e23){console[_0x393e8c(0x227)](_0x393e8c(0x18f)+_0x5a8e23['id']+':\x20type='+_0x5a8e23[_0x393e8c(0x1c5)]+_0x393e8c(0x1d4)+_0x5a8e23['currentPayments']+',\x20status='+_0x5a8e23[_0x393e8c(0x215)]);const _0x36707a=_0x5a8e23['currentPayments']+0x1,_0x2cd106=_0x5a8e23['type']===_0x393e8c(0x1e6)?_0x393e8c(0x1fe):_0x5a8e23[_0x393e8c(0x215)];await _0x52bd7c[_0x393e8c(0x22f)][_0x393e8c(0x221)]({'where':{'id':_0x194c85['paymentLinkId']},'data':{'currentPayments':_0x36707a,'status':_0x2cd106,'updatedAt':new Date()}}),console[_0x393e8c(0x227)](_0x393e8c(0x204)+_0x5a8e23['id']+_0x393e8c(0x19c)+_0x5a8e23[_0x393e8c(0x198)]+'\x20->\x20'+_0x36707a+_0x393e8c(0x1c3)+_0x5a8e23[_0x393e8c(0x215)]+_0x393e8c(0x171)+_0x2cd106);}else console['log'](_0x393e8c(0x16c)+_0x194c85[_0x393e8c(0x194)]+_0x393e8c(0x1ac));}catch(_0x10845c){console[_0x393e8c(0x1b5)](_0x393e8c(0x1d7),_0x10845c);}else console[_0x393e8c(0x227)](_0x393e8c(0x165)+_0x5a6d02+_0x393e8c(0x1d8));}else console['log'](_0x393e8c(0x165)+_0x5a6d02+_0x393e8c(0x19d)+_0x6edb65+_0x393e8c(0x171)+_0x4361cd['toUpperCase']());});}async['processPlisioWebhook'](_0x3c5d19){const _0x1d88c6=a58_0x59f751;console[_0x1d88c6(0x227)](_0x1d88c6(0x1d3),_0x3c5d19);try{const _0x29d886=await this['plisioService']['processWebhook'](_0x3c5d19);if(!_0x29d886['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x5dd051=await database_1['default'][_0x1d88c6(0x1cc)][_0x1d88c6(0x17d)]({'where':{'gatewayOrderId':_0x29d886['paymentId']}});if(!_0x5dd051){console[_0x1d88c6(0x1b5)](_0x1d88c6(0x200)+_0x29d886[_0x1d88c6(0x188)]);return;}console[_0x1d88c6(0x227)](_0x1d88c6(0x1ae)+_0x5dd051['id']+'\x20status\x20'+_0x29d886['status']),await this[_0x1d88c6(0x1b2)](_0x5dd051['id'],_0x29d886[_0x1d88c6(0x215)],{'txUrls':_0x29d886[_0x1d88c6(0x202)]}),loggerService_1[_0x1d88c6(0x160)][_0x1d88c6(0x180)]('plisio',_0x5dd051['id'],_0x5dd051['status'],_0x29d886[_0x1d88c6(0x215)],_0x3c5d19);}catch(_0x121e96){console['error'](_0x1d88c6(0x1c0),_0x121e96),loggerService_1[_0x1d88c6(0x160)][_0x1d88c6(0x1ad)](_0x1d88c6(0x1a1),_0x121e96,_0x3c5d19);throw _0x121e96;}}async['processPlisioGatewayWebhook'](_0x25846c){const _0x44f706=a58_0x59f751;console[_0x44f706(0x227)](_0x44f706(0x218),_0x25846c);try{const _0x2b2e9d=await this[_0x44f706(0x1de)][_0x44f706(0x217)](_0x25846c);if(!_0x2b2e9d[_0x44f706(0x188)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x46e400=await database_1[_0x44f706(0x19a)][_0x44f706(0x1cc)][_0x44f706(0x17d)]({'where':{'gatewayOrderId':_0x2b2e9d[_0x44f706(0x188)]}});if(!_0x46e400){console['error'](_0x44f706(0x191)+_0x2b2e9d[_0x44f706(0x188)]);return;}console['log'](_0x44f706(0x17c)+_0x46e400['id']+_0x44f706(0x1dc)+_0x2b2e9d['status']),await this[_0x44f706(0x1b2)](_0x46e400['id'],_0x2b2e9d['status'],{'txUrls':_0x2b2e9d['txUrls']}),loggerService_1[_0x44f706(0x160)]['logWebhookProcessed']('plisio_gateway',_0x46e400['id'],_0x46e400['status'],_0x2b2e9d[_0x44f706(0x215)],_0x25846c);}catch(_0x3b763d){console[_0x44f706(0x1b5)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x3b763d),loggerService_1[_0x44f706(0x160)][_0x44f706(0x1ad)](_0x44f706(0x1a6),_0x3b763d,_0x25846c);throw _0x3b763d;}}async[a58_0x59f751(0x1da)](_0x344662){const _0x2bfad2=a58_0x59f751;console['log'](_0x2bfad2(0x1b0),_0x344662);try{const _0x52e687=await this[_0x2bfad2(0x214)][_0x2bfad2(0x217)](_0x344662);if(!_0x52e687[_0x2bfad2(0x188)])throw new Error(_0x2bfad2(0x1fb));const _0x58d843=await database_1[_0x2bfad2(0x19a)][_0x2bfad2(0x1cc)]['findFirst']({'where':{'gatewayOrderId':_0x52e687[_0x2bfad2(0x188)]}});if(!_0x58d843){console['error']('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x52e687[_0x2bfad2(0x188)]);return;}console[_0x2bfad2(0x227)](_0x2bfad2(0x1e8)+_0x58d843['id']+_0x2bfad2(0x1dc)+_0x52e687[_0x2bfad2(0x215)]),await this[_0x2bfad2(0x1b2)](_0x58d843['id'],_0x52e687[_0x2bfad2(0x215)],{'failureMessage':_0x52e687[_0x2bfad2(0x1c7)],'cardLast4':_0x52e687['additionalInfo']?.[_0x2bfad2(0x1f3)],'paymentMethod':_0x52e687[_0x2bfad2(0x18d)]?.[_0x2bfad2(0x225)]}),loggerService_1['loggerService'][_0x2bfad2(0x180)](_0x2bfad2(0x157),_0x58d843['id'],_0x58d843[_0x2bfad2(0x215)],_0x52e687[_0x2bfad2(0x215)],_0x344662);}catch(_0x94837e){console[_0x2bfad2(0x1b5)](_0x2bfad2(0x168),_0x94837e),loggerService_1[_0x2bfad2(0x160)][_0x2bfad2(0x1ad)]('rapyd',_0x94837e,_0x344662);throw _0x94837e;}}async[a58_0x59f751(0x216)](_0x12b334){const _0x11e29c=a58_0x59f751;console[_0x11e29c(0x227)](_0x11e29c(0x1e0),_0x12b334);try{const _0x5a899f=await this[_0x11e29c(0x190)][_0x11e29c(0x217)](_0x12b334);if(!_0x5a899f[_0x11e29c(0x188)])throw new Error('No\x20payment\x20ID\x20in\x20Noda\x20webhook');const _0xa23f8d=await database_1[_0x11e29c(0x19a)]['payment'][_0x11e29c(0x17d)]({'where':{'gatewayOrderId':_0x5a899f[_0x11e29c(0x188)]}});if(!_0xa23f8d){console[_0x11e29c(0x1b5)](_0x11e29c(0x1f4)+_0x5a899f[_0x11e29c(0x188)]);return;}console[_0x11e29c(0x227)](_0x11e29c(0x208)+_0xa23f8d['id']+_0x11e29c(0x1dc)+_0x5a899f[_0x11e29c(0x215)]),await this[_0x11e29c(0x1b2)](_0xa23f8d['id'],_0x5a899f[_0x11e29c(0x215)],{'bankId':_0x5a899f[_0x11e29c(0x18d)]?.[_0x11e29c(0x1c1)],'remitterIban':_0x5a899f[_0x11e29c(0x18d)]?.[_0x11e29c(0x1b4)],'remitterName':_0x5a899f[_0x11e29c(0x18d)]?.[_0x11e29c(0x189)]}),loggerService_1[_0x11e29c(0x160)]['logWebhookProcessed'](_0x11e29c(0x21f),_0xa23f8d['id'],_0xa23f8d['status'],_0x5a899f[_0x11e29c(0x215)],_0x12b334);}catch(_0x3afac6){console[_0x11e29c(0x1b5)](_0x11e29c(0x1b1),_0x3afac6),loggerService_1[_0x11e29c(0x160)][_0x11e29c(0x1ad)](_0x11e29c(0x21f),_0x3afac6,_0x12b334);throw _0x3afac6;}}async[a58_0x59f751(0x155)](_0x37cf51){const _0x5cc47a=a58_0x59f751;console[_0x5cc47a(0x227)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x37cf51);try{const _0x279cd3=await this['coinToPayService'][_0x5cc47a(0x217)](_0x37cf51);if(!_0x279cd3[_0x5cc47a(0x188)])throw new Error(_0x5cc47a(0x176));const _0x187139=await database_1['default']['payment']['findFirst']({'where':{'gatewayOrderId':_0x279cd3['paymentId']}});if(!_0x187139){console[_0x5cc47a(0x1b5)](_0x5cc47a(0x228)+_0x279cd3['paymentId']);return;}console[_0x5cc47a(0x227)](_0x5cc47a(0x1f8)+_0x187139['id']+_0x5cc47a(0x1dc)+_0x279cd3['status']),await this[_0x5cc47a(0x1b2)](_0x187139['id'],_0x279cd3['status']),loggerService_1[_0x5cc47a(0x160)][_0x5cc47a(0x180)](_0x5cc47a(0x164),_0x187139['id'],_0x187139[_0x5cc47a(0x215)],_0x279cd3[_0x5cc47a(0x215)],_0x37cf51);}catch(_0x4715b9){console[_0x5cc47a(0x1b5)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x4715b9),loggerService_1[_0x5cc47a(0x160)][_0x5cc47a(0x1ad)](_0x5cc47a(0x164),_0x4715b9,_0x37cf51);throw _0x4715b9;}}async[a58_0x59f751(0x223)](_0x5b502e){const _0x552da3=a58_0x59f751;console[_0x552da3(0x227)](_0x552da3(0x1ff),_0x5b502e);try{const _0x1dce7e=await this[_0x552da3(0x20f)]['processWebhook'](_0x5b502e);if(!_0x1dce7e[_0x552da3(0x188)])throw new Error(_0x552da3(0x1b3));const _0x4e06fc=await database_1[_0x552da3(0x19a)][_0x552da3(0x1cc)]['findFirst']({'where':{'gatewayOrderId':_0x1dce7e[_0x552da3(0x188)]}});if(!_0x4e06fc){console['error'](_0x552da3(0x159)+_0x1dce7e[_0x552da3(0x188)]);return;}console[_0x552da3(0x227)](_0x552da3(0x219)+_0x4e06fc['id']+_0x552da3(0x1dc)+_0x1dce7e[_0x552da3(0x215)]),await this[_0x552da3(0x1b2)](_0x4e06fc['id'],_0x1dce7e[_0x552da3(0x215)]),loggerService_1[_0x552da3(0x160)][_0x552da3(0x180)](_0x552da3(0x1f9),_0x4e06fc['id'],_0x4e06fc[_0x552da3(0x215)],_0x1dce7e[_0x552da3(0x215)],_0x5b502e);}catch(_0x117a09){console[_0x552da3(0x1b5)]('Error\x20processing\x20CoinToPay2\x20webhook:',_0x117a09),loggerService_1[_0x552da3(0x160)]['logWebhookError'](_0x552da3(0x1f9),_0x117a09,_0x5b502e);throw _0x117a09;}}async[a58_0x59f751(0x1a2)](_0x54ed93){const _0x57a7bc=a58_0x59f751;console['log'](_0x57a7bc(0x15c),_0x54ed93);try{const _0x320023=await this[_0x57a7bc(0x15b)][_0x57a7bc(0x217)](_0x54ed93);if(!_0x320023[_0x57a7bc(0x188)])throw new Error(_0x57a7bc(0x21c));const _0x3ff022=await database_1[_0x57a7bc(0x19a)][_0x57a7bc(0x1cc)][_0x57a7bc(0x17d)]({'where':{'gatewayOrderId':_0x320023[_0x57a7bc(0x188)]}});if(!_0x3ff022){console[_0x57a7bc(0x1b5)](_0x57a7bc(0x18c)+_0x320023['paymentId']);return;}console[_0x57a7bc(0x227)](_0x57a7bc(0x1e2)+_0x3ff022['id']+_0x57a7bc(0x1dc)+_0x320023[_0x57a7bc(0x215)]),await this['updatePaymentStatus'](_0x3ff022['id'],_0x320023[_0x57a7bc(0x215)],{'paymentMethod':_0x320023['additionalInfo']?.[_0x57a7bc(0x205)]}),loggerService_1['loggerService'][_0x57a7bc(0x180)](_0x57a7bc(0x1bb),_0x3ff022['id'],_0x3ff022[_0x57a7bc(0x215)],_0x320023[_0x57a7bc(0x215)],_0x54ed93);}catch(_0x53b543){console['error'](_0x57a7bc(0x1d0),_0x53b543),loggerService_1[_0x57a7bc(0x160)]['logWebhookError'](_0x57a7bc(0x1bb),_0x53b543,_0x54ed93);throw _0x53b543;}}async['processMasterCardWebhook'](_0x2fc514){const _0xb1063b=a58_0x59f751;console[_0xb1063b(0x227)](_0xb1063b(0x184),JSON[_0xb1063b(0x1bd)](_0x2fc514,null,0x2));try{const _0x1d8aa4=await this[_0xb1063b(0x1e4)]['processWebhook'](_0x2fc514);console[_0xb1063b(0x227)](_0xb1063b(0x235),_0x1d8aa4);if(!_0x1d8aa4[_0xb1063b(0x188)]){console[_0xb1063b(0x1b5)](_0xb1063b(0x210)),console[_0xb1063b(0x1b5)]('❌\x20Available\x20webhook\x20fields:',Object[_0xb1063b(0x173)](_0x2fc514));throw new Error(_0xb1063b(0x1fd));}let _0x1ff806=null;console[_0xb1063b(0x227)](_0xb1063b(0x1c8)+_0x1d8aa4[_0xb1063b(0x188)]);_0x1d8aa4['paymentId']&&(console[_0xb1063b(0x227)](_0xb1063b(0x16b)),_0x1ff806=await database_1[_0xb1063b(0x19a)]['payment'][_0xb1063b(0x17d)]({'where':{'AND':[{'gateway':'mastercard'},{'OR':[{'gatewayPaymentId':_0x1d8aa4[_0xb1063b(0x188)]},{'gatewayOrderId':_0x1d8aa4[_0xb1063b(0x188)]},{'id':_0x1d8aa4['paymentId']},{'orderId':_0x1d8aa4[_0xb1063b(0x188)]}]}]}}),console[_0xb1063b(0x227)](_0xb1063b(0x1ed)+(_0x1ff806?'Found\x20payment\x20'+_0x1ff806['id']:_0xb1063b(0x1ca))));if(!_0x1ff806){console['error']('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x1d8aa4[_0xb1063b(0x188)]),console[_0xb1063b(0x1b5)](_0xb1063b(0x1d6)+_0x1d8aa4[_0xb1063b(0x188)]+_0xb1063b(0x186)+_0x1d8aa4[_0xb1063b(0x188)]+_0xb1063b(0x18b)+_0x1d8aa4['paymentId']+'\x22');const _0x17b919=await database_1[_0xb1063b(0x19a)][_0xb1063b(0x1cc)][_0xb1063b(0x1be)]({'where':{'gateway':'mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console['log']('🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:',_0x17b919);return;}console[_0xb1063b(0x227)](_0xb1063b(0x1fa)+_0x1ff806['id']+_0xb1063b(0x1db)+_0x1ff806['status']+_0xb1063b(0x15f)+_0x1d8aa4[_0xb1063b(0x215)]),await this[_0xb1063b(0x1b2)](_0x1ff806['id'],_0x1d8aa4['status']),loggerService_1[_0xb1063b(0x160)]['logWebhookProcessed'](_0xb1063b(0x209),_0x1ff806['id'],_0x1ff806[_0xb1063b(0x215)],_0x1d8aa4[_0xb1063b(0x215)],_0x2fc514);}catch(_0x481724){console[_0xb1063b(0x1b5)](_0xb1063b(0x178),_0x481724),loggerService_1['loggerService'][_0xb1063b(0x1ad)]('mastercard',_0x481724,_0x2fc514);throw _0x481724;}}async[a58_0x59f751(0x16f)](_0x1877aa,_0x41bde7){const _0x234927=a58_0x59f751,_0x4be002=Date[_0x234927(0x1b6)]();try{const _0x17a577=_0x1877aa[_0x234927(0x183)],_0x5eaff7=_0x17a577[_0x234927(0x1c2)];if(!_0x5eaff7?.[_0x234927(0x201)]){console[_0x234927(0x227)](_0x234927(0x20d)+_0x17a577['id']);return;}const _0x190f64=_0x41bde7==='PAID'?_0x234927(0x1f7):_0x41bde7==='FAILED'?_0x234927(0x1d5):_0x41bde7==='EXPIRED'?_0x234927(0x1d5):_0x41bde7===_0x234927(0x20c)?_0x234927(0x1d5):_0x41bde7===_0x234927(0x207)?_0x234927(0x1d5):'payment.pending';let _0x41dea2=[];if(_0x5eaff7[_0x234927(0x232)])try{_0x41dea2=Array[_0x234927(0x1d1)](_0x5eaff7[_0x234927(0x232)])?_0x5eaff7[_0x234927(0x232)]:JSON[_0x234927(0x18e)](_0x5eaff7['webhookEvents']);}catch(_0x2d75b9){console[_0x234927(0x1b5)](_0x234927(0x1a4),_0x2d75b9),_0x41dea2=[];}if(!_0x41dea2[_0x234927(0x18a)](_0x190f64)){console['log'](_0x234927(0x233)+_0x190f64+_0x234927(0x163)+_0x17a577['id']);return;}const _0x305eab={'event':_0x190f64,'payment':{'id':_0x1877aa['id'],'order_id':_0x1877aa['orderId'],'gateway_order_id':_0x1877aa['gatewayOrderId'],'gateway':_0x1877aa[_0x234927(0x1b9)],'amount':_0x1877aa[_0x234927(0x224)],'currency':_0x1877aa[_0x234927(0x1a3)],'status':_0x41bde7['toLowerCase'](),'customer_email':_0x1877aa['customerEmail'],'customer_name':_0x1877aa['customerName'],'failure_message':_0x1877aa[_0x234927(0x1c7)],'tx_urls':_0x1877aa[_0x234927(0x202)]?JSON[_0x234927(0x18e)](_0x1877aa['txUrls']):null,'created_at':_0x1877aa['createdAt'],'updated_at':_0x1877aa[_0x234927(0x1c6)]}},_0x5ef8ec=await fetch(_0x5eaff7[_0x234927(0x201)],{'method':_0x234927(0x1cf),'headers':{'Content-Type':_0x234927(0x1a8),'User-Agent':_0x234927(0x1ab)},'body':JSON['stringify'](_0x305eab)}),_0x40aee0=Date[_0x234927(0x1b6)]()-_0x4be002,_0x4553c0=_0x5ef8ec['ok']?_0x234927(0x1d9):await _0x5ef8ec[_0x234927(0x22e)]();loggerService_1[_0x234927(0x160)]['logShopWebhookSent'](_0x1877aa[_0x234927(0x156)],_0x5eaff7[_0x234927(0x201)],_0x190f64,_0x5ef8ec[_0x234927(0x215)],_0x40aee0,_0x305eab),console['log'](_0x234927(0x231)+_0x5eaff7['webhookUrl']+_0x234927(0x1e7)+_0x5ef8ec[_0x234927(0x215)]+'\x20('+_0x40aee0+_0x234927(0x16d));}catch(_0x4427b4){console[_0x234927(0x1b5)](_0x234927(0x1aa),_0x4427b4),loggerService_1[_0x234927(0x160)][_0x234927(0x1a0)](_0x1877aa[_0x234927(0x156)],_0x1877aa[_0x234927(0x183)]?.[_0x234927(0x1c2)]?.[_0x234927(0x201)]||_0x234927(0x172),_0x234927(0x1e3),_0x4427b4,{});}}async[a58_0x59f751(0x187)](_0x3d8c6a,_0x3eb57a){const _0x439eb4=a58_0x59f751;try{const _0x4a829b={'PENDING':_0x439eb4(0x1b7),'PROCESSING':_0x439eb4(0x222),'PAID':'paid','FAILED':_0x439eb4(0x15e),'EXPIRED':_0x439eb4(0x185),'REFUND':'refund','CHARGEBACK':_0x439eb4(0x17e)},_0x22cdbd=_0x4a829b[_0x3eb57a];if(!_0x22cdbd||_0x22cdbd===_0x439eb4(0x1b7))return;await telegramBotService_1[_0x439eb4(0x1b8)][_0x439eb4(0x16a)](_0x3d8c6a['shopId'],_0x3d8c6a,_0x22cdbd);}catch(_0x52a5d0){console[_0x439eb4(0x1b5)](_0x439eb4(0x193),_0x52a5d0);}}async[a58_0x59f751(0x20b)](_0x51dec7,_0x159d4d){const _0x5cdd61=a58_0x59f751;try{const _0x21991e=await database_1[_0x5cdd61(0x19a)][_0x5cdd61(0x183)]['findUnique']({'where':{'id':_0x51dec7},'select':{'gatewaySettings':!![]}});if(!_0x21991e?.[_0x5cdd61(0x1ef)])return console['log']('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x51dec7+_0x5cdd61(0x170)),0xa;const _0x201b85=JSON[_0x5cdd61(0x18e)](_0x21991e[_0x5cdd61(0x1ef)]);for(const [_0x5bcafd,_0x1797f1]of Object['entries'](_0x201b85)){if(_0x5bcafd[_0x5cdd61(0x203)]()===_0x159d4d[_0x5cdd61(0x203)]()){const _0x516776=_0x1797f1[_0x5cdd61(0x1ba)]||0xa;return console['log'](_0x5cdd61(0x21e)+_0x159d4d+_0x5cdd61(0x1ee)+_0x51dec7+':\x20'+_0x516776+'%'),_0x516776;}}return console[_0x5cdd61(0x227)]('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0x159d4d+_0x5cdd61(0x179)+_0x51dec7+',\x20using\x20default\x2010%'),0xa;}catch(_0x32513a){return console['error'](_0x5cdd61(0x17a)+_0x51dec7+_0x5cdd61(0x199)+_0x159d4d+':',_0x32513a),0xa;}}}function a58_0xdb71(){const _0x328d20=['loggerService','\x20-\x20','8456734xtergj','\x20not\x20enabled\x20for\x20shop\x20','cointopay','📈\x20Payment\x20','315462efArck','../config/database','Error\x20processing\x20Rapyd\x20webhook:','amountUSDT','sendPaymentNotification','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','❌\x20Payment\x20link\x20','ms)','\x20=\x20','sendShopWebhook',',\x20using\x20default\x20commission\x2010%','\x20->\x20','unknown','keys','PAID','coinToPayService','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','./gateways/coinToPay2Service','❌\x20Error\x20processing\x20MasterCard\x20webhook:','\x20in\x20shop\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','findFirst','chargeback','./loggerService','logWebhookProcessed','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','426PtZEBg','shop','🔄\x20Processing\x20MasterCard\x20webhook:','expired','\x22,\x20id=\x22','sendPaymentStatusNotification','paymentId','remitterName','includes','\x22,\x20orderId=\x22','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','additionalInfo','parse','📈\x20Found\x20payment\x20link\x20','nodaService','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','\x20and\x20-','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','paymentLinkId','./gateways/rapydService','32bYbBva','🏪\x20Shop\x20','currentPayments',',\x20gateway\x20','default','279430DWqWXn','\x20updated:\x20currentPayments=','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','toISOString','create','logShopWebhookError','plisio','processKlymeWebhook','currency','Error\x20parsing\x20webhook\x20events:','defineProperty','plisio_gateway','\x20+\x20','application/json','%\x20gateway\x20commission)','Failed\x20to\x20send\x20shop\x20webhook:','TesSoft\x20Payment\x20System/1.0','\x20not\x20found','logWebhookError','📊\x20Plisio\x20webhook:\x20Payment\x20','__esModule','🔄\x20Processing\x20Rapyd\x20webhook:','Error\x20processing\x20Noda\x20webhook:','updatePaymentStatus','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','remitterIban','error','now','created','telegramBotService','gateway','commission','klyme','./gateways/mastercardService','stringify','findMany','webhookLog','Error\x20processing\x20Plisio\x20webhook:','bankId','settings',',\x20status=','MasterCardService','type','updatedAt','failureMessage','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20commission:\x20','Payment\x20not\x20found','./currencyService','payment','256qWXnHu','WebhookService','POST','Error\x20processing\x20KLYME\x20webhook:','isArray','currencyService','🔄\x20Processing\x20Plisio\x20webhook:',',\x20currentPayments=','payment.failed','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','Success','processRapydWebhook','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','\x20status\x20','paidAt','plisioService','$transaction','🔄\x20Processing\x20Noda\x20webhook:',',\x20newStatus=','📊\x20KLYME\x20webhook:\x20Payment\x20','webhook_send','masterCardService','./gateways/nodaService','SINGLE','\x20with\x20status\x20','📊\x20Rapyd\x20webhook:\x20Payment\x20','chargebackAmount','💰\x20Removing\x20from\x20balance:\x20','9192jQHovC','\x20USDT','🔍\x20Search\x20result:\x20','\x20commission\x20for\x20shop\x20','gatewaySettings','💰\x20Final\x20balance\x20after\x20chargeback:\x20','26205xgMllZ','toUpperCase','cardLast4','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','💰\x20Amount\x20after\x20gateway\x20commission:\x20','./gateways/klymeService','payment.success','📊\x20CoinToPay\x20webhook:\x20Payment\x20','cointopay2','✅\x20Found\x20payment\x20','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','🔄\x20Additional\x20data:','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','COMPLETED','🔄\x20Processing\x20CoinToPay2\x20webhook:','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','webhookUrl','txUrls','toLowerCase','✅\x20Payment\x20link\x20','payment_method','72PfWzjU','REFUND','📊\x20Noda\x20webhook:\x20Payment\x20','mastercard','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','getGatewayCommission','CHARGEBACK','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','367712yMfpqw','coinToPay2Service','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','97251BVUzsF','💰\x20Converting\x20','system','rapydService','status','processNodaWebhook','processWebhook','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','Payment\x20','📝\x20Reason:\x20','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','amountAfterGatewayCommissionUSDT','Gateway\x20','noda','./gateways/plisioService','update','processing','processCoinToPay2Webhook','amount','paymentMethod','username','log','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','NodaService','./telegramBotService','RapydService','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','📈\x20Payment\x20details:\x20oldStatus=\x22','text','paymentLink','balance','📤\x20Shop\x20webhook\x20sent\x20to\x20','webhookEvents','Webhook\x20event\x20','findUnique','📊\x20MasterCard\x20webhook\x20result:','PlisioService','processCoinToPayWebhook','shopId','rapyd','\x22,\x20newStatus=\x22','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','\x20USDT\x20(chargeback\x20penalty)','klymeService','🔄\x20Processing\x20KLYME\x20webhook:','toFixed','failed','\x20to\x20'];a58_0xdb71=function(){return _0x328d20;};return a58_0xdb71();}exports[a58_0x59f751(0x1ce)]=WebhookService;