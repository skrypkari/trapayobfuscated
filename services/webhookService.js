'use strict';function a58_0x25bd(_0x1e60d3,_0x52dbc0){const _0x28fb15=a58_0x28fb();return a58_0x25bd=function(_0x25bdfd,_0x24d1ac){_0x25bdfd=_0x25bdfd-0xa4;let _0x39154a=_0x28fb15[_0x25bdfd];return _0x39154a;},a58_0x25bd(_0x1e60d3,_0x52dbc0);}const a58_0x403dfc=a58_0x25bd;(function(_0x2f5b73,_0x1e5961){const _0xf8b4e0=a58_0x25bd,_0x27648f=_0x2f5b73();while(!![]){try{const _0x5d9560=parseInt(_0xf8b4e0(0xe6))/0x1*(-parseInt(_0xf8b4e0(0xe0))/0x2)+parseInt(_0xf8b4e0(0x151))/0x3*(-parseInt(_0xf8b4e0(0xc2))/0x4)+-parseInt(_0xf8b4e0(0x15e))/0x5*(parseInt(_0xf8b4e0(0xe9))/0x6)+-parseInt(_0xf8b4e0(0xff))/0x7*(parseInt(_0xf8b4e0(0x162))/0x8)+parseInt(_0xf8b4e0(0x130))/0x9+parseInt(_0xf8b4e0(0x16e))/0xa+parseInt(_0xf8b4e0(0xdc))/0xb;if(_0x5d9560===_0x1e5961)break;else _0x27648f['push'](_0x27648f['shift']());}catch(_0x36e891){_0x27648f['push'](_0x27648f['shift']());}}}(a58_0x28fb,0x97d36));var __importDefault=this&&this[a58_0x403dfc(0xb5)]||function(_0x58316f){const _0x5cc079=a58_0x403dfc;return _0x58316f&&_0x58316f[_0x5cc079(0x118)]?_0x58316f:{'default':_0x58316f};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a58_0x403dfc(0xd5)]=void 0x0;const database_1=__importDefault(require(a58_0x403dfc(0xea))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a58_0x403dfc(0xd0)),nodaService_1=require(a58_0x403dfc(0x156)),coinToPayService_1=require(a58_0x403dfc(0xcb)),coinToPay2Service_1=require(a58_0x403dfc(0xf5)),klymeService_1=require(a58_0x403dfc(0x11c)),mastercardService_1=require(a58_0x403dfc(0xbe)),telegramBotService_1=require(a58_0x403dfc(0x14b)),currencyService_1=require(a58_0x403dfc(0x128)),loggerService_1=require(a58_0x403dfc(0xb1));function a58_0x28fb(){const _0x17fb4d=['sendPaymentNotification','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','\x20to\x20','mastercard','parse','📤\x20Shop\x20webhook\x20sent\x20to\x20','chargeback','592065AUuYFs','💰\x20Payment\x20','processWebhook','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','📝\x20Reason:\x20','refund','txUrls','$transaction','PlisioService','toLowerCase','Webhook\x20event\x20','payment.success','❌\x20Payment\x20link\x20','📊\x20Noda\x20webhook:\x20Payment\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook','telegramBotService','sendShopWebhook','processCoinToPay2Webhook','klyme','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','\x20-\x20',':\x20type=','Error\x20processing\x20KLYME\x20webhook:','webhook_send','shopId','payment','gatewayOrderId','./telegramBotService','Error\x20processing\x20CoinToPay2\x20webhook:','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','sendPaymentStatusNotification','POST','settings','1857507WhVwCr','gateway','EXPIRED','stringify','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','./gateways/nodaService','toFixed','keys','\x20USDT','🔄\x20Processing\x20Noda\x20webhook:','masterCardService','plisio_gateway','noda','53905PemmxG','expired','cardLast4','updatePaymentStatus','408wIlaDx','failed','NodaService','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','webhook_status_change_','SINGLE','\x20current\x20balance:\x20','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','rapyd','createdAt','✅\x20Shop\x20','6013610RnYctw','\x20USDT\x20(chargeback\x20penalty)','🔄\x20Additional\x20data:','processRapydWebhook','findFirst','failureMessage','✅\x20Found\x20payment\x20','📊\x20MasterCard\x20webhook\x20result:','customerEmail','processKlymeWebhook','username','\x20and\x20-','default','\x22,\x20orderId=\x22','paymentMethod','./loggerService','🔄\x20Processing\x20Rapyd\x20webhook:','💰\x20Adding\x20to\x20balance:\x20','currentPayments','__importDefault','CHARGEBACK','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','FAILED','logWebhookError','🏪\x20Shop\x20','remitterIban','error','🔄\x20Processing\x20MasterCard\x20webhook:','./gateways/mastercardService','cointopay','log','amount','8DyplBI','📊\x20KLYME\x20webhook:\x20Payment\x20','\x22,\x20newStatus=\x22','📊\x20Plisio\x20webhook:\x20Payment\x20','update','webhookUrl','klymeService','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','./gateways/coinToPayService','Payment\x20','coinToPayService','logWebhookProcessed','\x20not\x20found','./gateways/rapydService',',\x20status=','\x20status\x20','isArray','logShopWebhookError','WebhookService','\x20updated:\x20currentPayments=','\x20->\x20','remitterName','paymentLink','paymentId','bankId','31798426Nipwca','📈\x20Found\x20payment\x20link\x20','logShopWebhookSent','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','1105642oRidRc','Error\x20processing\x20Noda\x20webhook:','Failed\x20to\x20send\x20shop\x20webhook:','currencyService','unknown','additionalInfo','1fgohkf','toUpperCase','chargebackAmount','54OfWcVy','../config/database','loggerService','balance','🔄\x20Processing\x20KLYME\x20webhook:','findUnique','CoinToPay2Service','no\x20balance\x20change','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','📈\x20Payment\x20','\x22,\x20paymentLinkId=\x22','amountUSDT','./gateways/coinToPay2Service','MasterCardService','application/json','processPlisioGatewayWebhook','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','💸\x20Additional\x20chargeback\x20penalty:\x20-','currency','PAID','system','Error\x20processing\x20Rapyd\x20webhook:','143822EBCqMq','COMPLETED','toISOString','nodaService','status','now',',\x20newStatus=','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','created','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','cointopay2','create','🔄\x20Processing\x20CoinToPay2\x20webhook:','paid','processMasterCardWebhook','processCoinToPayWebhook','\x20with\x20status\x20','ms)','payment.failed','\x20balance\x20updated:\x20','rapydService','findMany','processing','webhookEvents','orderId','__esModule','💰\x20Final\x20balance\x20after\x20chargeback:\x20','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','updatedAt','./gateways/klymeService','plisioService','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','paymentLinkId','Success','shop','✅\x20Payment\x20link\x20','🔄\x20Processing\x20CoinToPay\x20webhook:','type','plisio','coinToPay2Service','❌\x20Error\x20processing\x20MasterCard\x20webhook:','./currencyService'];a58_0x28fb=function(){return _0x17fb4d;};return a58_0x28fb();}class WebhookService{constructor(){const _0x215094=a58_0x403dfc;this[_0x215094(0x11d)]=new plisioService_1[(_0x215094(0x138))](),this['rapydService']=new rapydService_1['RapydService'](),this[_0x215094(0x102)]=new nodaService_1[(_0x215094(0x164))](),this['coinToPayService']=new coinToPayService_1['CoinToPayService'](),this[_0x215094(0x126)]=new coinToPay2Service_1[(_0x215094(0xef))](),this[_0x215094(0xc8)]=new klymeService_1['KlymeService'](),this[_0x215094(0x15b)]=new mastercardService_1[(_0x215094(0xf6))]();}async[a58_0x403dfc(0x161)](_0x5de886,_0x216b4b,_0x287edb){const _0x320c04=a58_0x403dfc;console[_0x320c04(0xc0)](_0x320c04(0x169)+_0x5de886+_0x320c04(0x105)+_0x216b4b),console[_0x320c04(0xc0)](_0x320c04(0xa4),_0x287edb),await database_1[_0x320c04(0xae)][_0x320c04(0x137)](async _0x45a463=>{const _0x4bdb42=_0x320c04,_0x24c4d2=await _0x45a463[_0x4bdb42(0x149)][_0x4bdb42(0xee)]({'where':{'id':_0x5de886},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x24c4d2)throw new Error(_0x4bdb42(0xcc)+_0x5de886+_0x4bdb42(0xcf));const _0x543738=_0x24c4d2[_0x4bdb42(0x103)],_0xcaf080=_0x24c4d2[_0x4bdb42(0x121)];console[_0x4bdb42(0xc0)](_0x4bdb42(0x131)+_0x5de886+':\x20'+_0x543738+_0x4bdb42(0xd7)+_0x216b4b),console['log'](_0x4bdb42(0xba)+_0xcaf080[_0x4bdb42(0xac)]+_0x4bdb42(0x168)+_0xcaf080['balance']+'\x20USDT');const _0x3a175a={'status':_0x216b4b[_0x4bdb42(0xe7)](),'updatedAt':new Date(),'statusChangedBy':_0x4bdb42(0xfd),'statusChangedAt':new Date()};_0x287edb?.['failureMessage']&&(_0x3a175a[_0x4bdb42(0xa7)]=_0x287edb[_0x4bdb42(0xa7)]);_0x287edb?.['txUrls']&&(_0x3a175a['txUrls']=JSON[_0x4bdb42(0x154)](_0x287edb['txUrls']));_0x287edb?.['cardLast4']&&(_0x3a175a['cardLast4']=_0x287edb[_0x4bdb42(0x160)]);_0x287edb?.['paymentMethod']&&(_0x3a175a[_0x4bdb42(0xb0)]=_0x287edb[_0x4bdb42(0xb0)]);_0x287edb?.[_0x4bdb42(0xdb)]&&(_0x3a175a[_0x4bdb42(0xdb)]=_0x287edb[_0x4bdb42(0xdb)]);_0x287edb?.[_0x4bdb42(0xbb)]&&(_0x3a175a[_0x4bdb42(0xbb)]=_0x287edb[_0x4bdb42(0xbb)]);_0x287edb?.[_0x4bdb42(0xd8)]&&(_0x3a175a['remitterName']=_0x287edb[_0x4bdb42(0xd8)]);let _0x1d9050=_0xcaf080[_0x4bdb42(0xec)],_0x150ea4='';if(_0x216b4b[_0x4bdb42(0xe7)]()===_0x4bdb42(0xfc)&&_0x543738!==_0x4bdb42(0xfc)){const _0x325e4b=await currencyService_1[_0x4bdb42(0xe3)]['convertToUSDT'](_0x24c4d2[_0x4bdb42(0xc1)],_0x24c4d2[_0x4bdb42(0xfb)]);_0x1d9050+=_0x325e4b,_0x150ea4='+'+_0x325e4b[_0x4bdb42(0x157)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID)',_0x3a175a[_0x4bdb42(0xf4)]=_0x325e4b,_0x3a175a['paidAt']=new Date(),console['log']('💰\x20Converting\x20'+_0x24c4d2[_0x4bdb42(0xc1)]+'\x20'+_0x24c4d2[_0x4bdb42(0xfb)]+_0x4bdb42(0xd7)+_0x325e4b[_0x4bdb42(0x157)](0x6)+_0x4bdb42(0x159)),console['log'](_0x4bdb42(0xb3)+_0xcaf080['balance']+'\x20+\x20'+_0x325e4b[_0x4bdb42(0x157)](0x6)+'\x20=\x20'+_0x1d9050[_0x4bdb42(0x157)](0x6)+_0x4bdb42(0x159));}else{if(_0x543738===_0x4bdb42(0xfc)&&_0x216b4b['toUpperCase']()!==_0x4bdb42(0xfc)){const _0x3333d2=_0x24c4d2[_0x4bdb42(0xf4)];_0x3333d2&&(_0x1d9050-=_0x3333d2,_0x150ea4='-'+_0x3333d2[_0x4bdb42(0x157)](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x3a175a['amountUSDT']=null,_0x3a175a['paidAt']=null,console[_0x4bdb42(0xc0)]('💰\x20Removing\x20from\x20balance:\x20'+_0xcaf080[_0x4bdb42(0xec)]+_0x4bdb42(0x144)+_0x3333d2[_0x4bdb42(0x157)](0x6)+'\x20=\x20'+_0x1d9050[_0x4bdb42(0x157)](0x6)+_0x4bdb42(0x159)));}}if(_0x216b4b['toUpperCase']()===_0x4bdb42(0xb6)){const _0x283056=_0x287edb?.[_0x4bdb42(0xe8)]||0x0;_0x283056>0x0&&(_0x1d9050-=_0x283056,_0x150ea4+=_0x4bdb42(0xad)+_0x283056[_0x4bdb42(0x157)](0x6)+_0x4bdb42(0x16f),_0x3a175a[_0x4bdb42(0xe8)]=_0x283056,console['log'](_0x4bdb42(0xfa)+_0x283056[_0x4bdb42(0x157)](0x6)+_0x4bdb42(0x159)),console[_0x4bdb42(0xc0)](_0x4bdb42(0x119)+_0x1d9050[_0x4bdb42(0x157)](0x6)+_0x4bdb42(0x159)));}const _0xa4d3fd=await _0x45a463[_0x4bdb42(0x149)][_0x4bdb42(0xc6)]({'where':{'id':_0x5de886},'data':_0x3a175a});_0x1d9050!==_0xcaf080['balance']&&(await _0x45a463[_0x4bdb42(0x121)]['update']({'where':{'id':_0xcaf080['id']},'data':{'balance':_0x1d9050}}),console[_0x4bdb42(0xc0)](_0x4bdb42(0x16d)+_0xcaf080[_0x4bdb42(0xac)]+_0x4bdb42(0x112)+_0xcaf080[_0x4bdb42(0xec)][_0x4bdb42(0x157)](0x6)+_0x4bdb42(0xd7)+_0x1d9050[_0x4bdb42(0x157)](0x6)+'\x20USDT'),console[_0x4bdb42(0xc0)](_0x4bdb42(0x134)+_0x150ea4));await _0x45a463['webhookLog'][_0x4bdb42(0x10a)]({'data':{'paymentId':_0x5de886,'shopId':_0xcaf080['id'],'event':_0x4bdb42(0x166)+_0x216b4b[_0x4bdb42(0x139)](),'statusCode':0xc8,'responseBody':JSON[_0x4bdb42(0x154)]({'oldStatus':_0x543738,'newStatus':_0x216b4b[_0x4bdb42(0xe7)](),'balanceChange':_0x150ea4||_0x4bdb42(0xf0),'oldBalance':_0xcaf080['balance'],'newBalance':_0x1d9050,'amountUSDT':_0x3a175a[_0x4bdb42(0xf4)],'additionalData':_0x287edb,'timestamp':new Date()[_0x4bdb42(0x101)]()})}}),await this['sendShopWebhook']({..._0x24c4d2,..._0xa4d3fd,'shop':_0xcaf080},_0x216b4b[_0x4bdb42(0xe7)]()),await this['sendPaymentStatusNotification']({..._0x24c4d2,..._0xa4d3fd},_0x216b4b[_0x4bdb42(0xe7)]());if(_0x543738!==_0x4bdb42(0xfc)&&_0x216b4b[_0x4bdb42(0xe7)]()===_0x4bdb42(0xfc)){console[_0x4bdb42(0xc0)](_0x4bdb42(0xf2)+_0x5de886+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console[_0x4bdb42(0xc0)]('📈\x20Payment\x20details:\x20oldStatus=\x22'+_0x543738+_0x4bdb42(0xc4)+_0x216b4b['toUpperCase']()+_0x4bdb42(0xf3)+_0x24c4d2[_0x4bdb42(0x11f)]+'\x22');if(_0x24c4d2[_0x4bdb42(0x11f)])try{const _0x36c331=await _0x45a463[_0x4bdb42(0xd9)][_0x4bdb42(0xee)]({'where':{'id':_0x24c4d2['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x36c331){console[_0x4bdb42(0xc0)](_0x4bdb42(0xdd)+_0x36c331['id']+_0x4bdb42(0x145)+_0x36c331[_0x4bdb42(0x124)]+',\x20currentPayments='+_0x36c331[_0x4bdb42(0xb4)]+',\x20status='+_0x36c331[_0x4bdb42(0x103)]);const _0x1c38a8=_0x36c331[_0x4bdb42(0xb4)]+0x1,_0x5606c0=_0x36c331[_0x4bdb42(0x124)]===_0x4bdb42(0x167)?_0x4bdb42(0x100):_0x36c331[_0x4bdb42(0x103)];await _0x45a463[_0x4bdb42(0xd9)][_0x4bdb42(0xc6)]({'where':{'id':_0x24c4d2['paymentLinkId']},'data':{'currentPayments':_0x1c38a8,'status':_0x5606c0,'updatedAt':new Date()}}),console[_0x4bdb42(0xc0)](_0x4bdb42(0x122)+_0x36c331['id']+_0x4bdb42(0xd6)+_0x36c331[_0x4bdb42(0xb4)]+_0x4bdb42(0xd7)+_0x1c38a8+_0x4bdb42(0xd1)+_0x36c331['status']+_0x4bdb42(0xd7)+_0x5606c0);}else console[_0x4bdb42(0xc0)](_0x4bdb42(0x13c)+_0x24c4d2[_0x4bdb42(0x11f)]+_0x4bdb42(0xcf));}catch(_0x594eed){console[_0x4bdb42(0xbc)]('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x594eed);}else console[_0x4bdb42(0xc0)]('📈\x20Payment\x20'+_0x5de886+_0x4bdb42(0x155));}else console['log'](_0x4bdb42(0xf2)+_0x5de886+_0x4bdb42(0xf1)+_0x543738+_0x4bdb42(0xd7)+_0x216b4b['toUpperCase']());});}async['processPlisioWebhook'](_0x30c479){const _0x4de67c=a58_0x403dfc;console[_0x4de67c(0xc0)]('🔄\x20Processing\x20Plisio\x20webhook:',_0x30c479);try{const _0x2247af=await this[_0x4de67c(0x11d)][_0x4de67c(0x132)](_0x30c479);if(!_0x2247af[_0x4de67c(0xda)])throw new Error(_0x4de67c(0x106));const _0xd55600=await database_1[_0x4de67c(0xae)][_0x4de67c(0x149)][_0x4de67c(0xa6)]({'where':{'gatewayOrderId':_0x2247af['paymentId']}});if(!_0xd55600){console[_0x4de67c(0xbc)](_0x4de67c(0x11e)+_0x2247af[_0x4de67c(0xda)]);return;}console[_0x4de67c(0xc0)](_0x4de67c(0xc5)+_0xd55600['id']+_0x4de67c(0xd2)+_0x2247af[_0x4de67c(0x103)]),await this[_0x4de67c(0x161)](_0xd55600['id'],_0x2247af[_0x4de67c(0x103)],{'txUrls':_0x2247af['txUrls']}),loggerService_1[_0x4de67c(0xeb)]['logWebhookProcessed'](_0x4de67c(0x125),_0xd55600['id'],_0xd55600[_0x4de67c(0x103)],_0x2247af['status'],_0x30c479);}catch(_0x4342f0){console[_0x4de67c(0xbc)]('Error\x20processing\x20Plisio\x20webhook:',_0x4342f0),loggerService_1['loggerService'][_0x4de67c(0xb9)](_0x4de67c(0x125),_0x4342f0,_0x30c479);throw _0x4342f0;}}async[a58_0x403dfc(0xf8)](_0x523545){const _0x378cc8=a58_0x403dfc;console['log'](_0x378cc8(0xf9),_0x523545);try{const _0x55b2a6=await this[_0x378cc8(0x11d)][_0x378cc8(0x132)](_0x523545);if(!_0x55b2a6[_0x378cc8(0xda)])throw new Error(_0x378cc8(0x108));const _0x2f6cc2=await database_1[_0x378cc8(0xae)][_0x378cc8(0x149)][_0x378cc8(0xa6)]({'where':{'gatewayOrderId':_0x55b2a6['paymentId']}});if(!_0x2f6cc2){console[_0x378cc8(0xbc)]('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x55b2a6[_0x378cc8(0xda)]);return;}console[_0x378cc8(0xc0)](_0x378cc8(0xb7)+_0x2f6cc2['id']+_0x378cc8(0xd2)+_0x55b2a6['status']),await this[_0x378cc8(0x161)](_0x2f6cc2['id'],_0x55b2a6['status'],{'txUrls':_0x55b2a6[_0x378cc8(0x136)]}),loggerService_1[_0x378cc8(0xeb)]['logWebhookProcessed'](_0x378cc8(0x15c),_0x2f6cc2['id'],_0x2f6cc2[_0x378cc8(0x103)],_0x55b2a6['status'],_0x523545);}catch(_0x15a087){console[_0x378cc8(0xbc)](_0x378cc8(0x16a),_0x15a087),loggerService_1[_0x378cc8(0xeb)][_0x378cc8(0xb9)](_0x378cc8(0x15c),_0x15a087,_0x523545);throw _0x15a087;}}async[a58_0x403dfc(0xa5)](_0x21989e){const _0x30b374=a58_0x403dfc;console[_0x30b374(0xc0)](_0x30b374(0xb2),_0x21989e);try{const _0xaad8fc=await this[_0x30b374(0x113)][_0x30b374(0x132)](_0x21989e);if(!_0xaad8fc[_0x30b374(0xda)])throw new Error(_0x30b374(0x165));const _0x1e805=await database_1[_0x30b374(0xae)]['payment'][_0x30b374(0xa6)]({'where':{'gatewayOrderId':_0xaad8fc[_0x30b374(0xda)]}});if(!_0x1e805){console[_0x30b374(0xbc)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0xaad8fc[_0x30b374(0xda)]);return;}console[_0x30b374(0xc0)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x1e805['id']+'\x20status\x20'+_0xaad8fc['status']),await this[_0x30b374(0x161)](_0x1e805['id'],_0xaad8fc[_0x30b374(0x103)],{'failureMessage':_0xaad8fc['failureMessage'],'cardLast4':_0xaad8fc[_0x30b374(0xe5)]?.['cardLast4'],'paymentMethod':_0xaad8fc[_0x30b374(0xe5)]?.[_0x30b374(0xb0)]}),loggerService_1[_0x30b374(0xeb)][_0x30b374(0xce)](_0x30b374(0x16b),_0x1e805['id'],_0x1e805['status'],_0xaad8fc[_0x30b374(0x103)],_0x21989e);}catch(_0x5745dc){console[_0x30b374(0xbc)](_0x30b374(0xfe),_0x5745dc),loggerService_1[_0x30b374(0xeb)]['logWebhookError'](_0x30b374(0x16b),_0x5745dc,_0x21989e);throw _0x5745dc;}}async['processNodaWebhook'](_0xb01ff4){const _0x35a0a8=a58_0x403dfc;console[_0x35a0a8(0xc0)](_0x35a0a8(0x15a),_0xb01ff4);try{const _0x234a21=await this[_0x35a0a8(0x102)][_0x35a0a8(0x132)](_0xb01ff4);if(!_0x234a21[_0x35a0a8(0xda)])throw new Error(_0x35a0a8(0x13e));const _0x2b8558=await database_1[_0x35a0a8(0xae)]['payment'][_0x35a0a8(0xa6)]({'where':{'gatewayOrderId':_0x234a21[_0x35a0a8(0xda)]}});if(!_0x2b8558){console['error'](_0x35a0a8(0x11a)+_0x234a21[_0x35a0a8(0xda)]);return;}console[_0x35a0a8(0xc0)](_0x35a0a8(0x13d)+_0x2b8558['id']+'\x20status\x20'+_0x234a21[_0x35a0a8(0x103)]),await this['updatePaymentStatus'](_0x2b8558['id'],_0x234a21[_0x35a0a8(0x103)],{'bankId':_0x234a21[_0x35a0a8(0xe5)]?.['bankId'],'remitterIban':_0x234a21[_0x35a0a8(0xe5)]?.[_0x35a0a8(0xbb)],'remitterName':_0x234a21['additionalInfo']?.[_0x35a0a8(0xd8)]}),loggerService_1[_0x35a0a8(0xeb)]['logWebhookProcessed'](_0x35a0a8(0x15d),_0x2b8558['id'],_0x2b8558['status'],_0x234a21[_0x35a0a8(0x103)],_0xb01ff4);}catch(_0x1fecd2){console[_0x35a0a8(0xbc)](_0x35a0a8(0xe1),_0x1fecd2),loggerService_1[_0x35a0a8(0xeb)][_0x35a0a8(0xb9)](_0x35a0a8(0x15d),_0x1fecd2,_0xb01ff4);throw _0x1fecd2;}}async[a58_0x403dfc(0x10e)](_0x3f664d){const _0x15a933=a58_0x403dfc;console['log'](_0x15a933(0x123),_0x3f664d);try{const _0x4abf8b=await this[_0x15a933(0xcd)][_0x15a933(0x132)](_0x3f664d);if(!_0x4abf8b['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x1f16c0=await database_1['default'][_0x15a933(0x149)][_0x15a933(0xa6)]({'where':{'gatewayOrderId':_0x4abf8b['paymentId']}});if(!_0x1f16c0){console['error'](_0x15a933(0x133)+_0x4abf8b[_0x15a933(0xda)]);return;}console[_0x15a933(0xc0)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x1f16c0['id']+'\x20status\x20'+_0x4abf8b[_0x15a933(0x103)]),await this[_0x15a933(0x161)](_0x1f16c0['id'],_0x4abf8b[_0x15a933(0x103)]),loggerService_1[_0x15a933(0xeb)]['logWebhookProcessed'](_0x15a933(0xbf),_0x1f16c0['id'],_0x1f16c0[_0x15a933(0x103)],_0x4abf8b['status'],_0x3f664d);}catch(_0x116b38){console[_0x15a933(0xbc)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x116b38),loggerService_1[_0x15a933(0xeb)][_0x15a933(0xb9)](_0x15a933(0xbf),_0x116b38,_0x3f664d);throw _0x116b38;}}async[a58_0x403dfc(0x141)](_0x664784){const _0x4f08bb=a58_0x403dfc;console[_0x4f08bb(0xc0)](_0x4f08bb(0x10b),_0x664784);try{const _0x368702=await this[_0x4f08bb(0x126)][_0x4f08bb(0x132)](_0x664784);if(!_0x368702[_0x4f08bb(0xda)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook');const _0x29c7f5=await database_1[_0x4f08bb(0xae)][_0x4f08bb(0x149)][_0x4f08bb(0xa6)]({'where':{'gatewayOrderId':_0x368702[_0x4f08bb(0xda)]}});if(!_0x29c7f5){console['error']('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x368702['paymentId']);return;}console[_0x4f08bb(0xc0)]('📊\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x29c7f5['id']+'\x20status\x20'+_0x368702[_0x4f08bb(0x103)]),await this[_0x4f08bb(0x161)](_0x29c7f5['id'],_0x368702[_0x4f08bb(0x103)]),loggerService_1[_0x4f08bb(0xeb)][_0x4f08bb(0xce)](_0x4f08bb(0x109),_0x29c7f5['id'],_0x29c7f5[_0x4f08bb(0x103)],_0x368702['status'],_0x664784);}catch(_0x13db6a){console[_0x4f08bb(0xbc)](_0x4f08bb(0x14c),_0x13db6a),loggerService_1[_0x4f08bb(0xeb)][_0x4f08bb(0xb9)](_0x4f08bb(0x109),_0x13db6a,_0x664784);throw _0x13db6a;}}async[a58_0x403dfc(0xab)](_0x601316){const _0x1a64ec=a58_0x403dfc;console[_0x1a64ec(0xc0)](_0x1a64ec(0xed),_0x601316);try{const _0x292f20=await this['klymeService'][_0x1a64ec(0x132)](_0x601316);if(!_0x292f20[_0x1a64ec(0xda)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x1bddef=await database_1[_0x1a64ec(0xae)][_0x1a64ec(0x149)][_0x1a64ec(0xa6)]({'where':{'gatewayOrderId':_0x292f20[_0x1a64ec(0xda)]}});if(!_0x1bddef){console[_0x1a64ec(0xbc)](_0x1a64ec(0x143)+_0x292f20[_0x1a64ec(0xda)]);return;}console['log'](_0x1a64ec(0xc3)+_0x1bddef['id']+'\x20status\x20'+_0x292f20[_0x1a64ec(0x103)]),await this[_0x1a64ec(0x161)](_0x1bddef['id'],_0x292f20['status'],{'paymentMethod':_0x292f20[_0x1a64ec(0xe5)]?.['payment_method']}),loggerService_1[_0x1a64ec(0xeb)]['logWebhookProcessed'](_0x1a64ec(0x142),_0x1bddef['id'],_0x1bddef[_0x1a64ec(0x103)],_0x292f20[_0x1a64ec(0x103)],_0x601316);}catch(_0x349f7b){console[_0x1a64ec(0xbc)](_0x1a64ec(0x146),_0x349f7b),loggerService_1[_0x1a64ec(0xeb)][_0x1a64ec(0xb9)](_0x1a64ec(0x142),_0x349f7b,_0x601316);throw _0x349f7b;}}async[a58_0x403dfc(0x10d)](_0x3f419c){const _0x1daa48=a58_0x403dfc;console[_0x1daa48(0xc0)](_0x1daa48(0xbd),JSON['stringify'](_0x3f419c,null,0x2));try{const _0x55c0c3=await this[_0x1daa48(0x15b)][_0x1daa48(0x132)](_0x3f419c);console[_0x1daa48(0xc0)](_0x1daa48(0xa9),_0x55c0c3);if(!_0x55c0c3[_0x1daa48(0xda)]){console[_0x1daa48(0xbc)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data'),console[_0x1daa48(0xbc)]('❌\x20Available\x20webhook\x20fields:',Object[_0x1daa48(0x158)](_0x3f419c));throw new Error(_0x1daa48(0x14d));}let _0x4dae6b=null;_0x55c0c3[_0x1daa48(0xda)]&&(_0x4dae6b=await database_1[_0x1daa48(0xae)][_0x1daa48(0x149)][_0x1daa48(0xa6)]({'where':{'AND':[{'gateway':_0x1daa48(0x12c)},{'OR':[{'gatewayPaymentId':_0x55c0c3[_0x1daa48(0xda)]},{'gatewayOrderId':_0x55c0c3[_0x1daa48(0xda)]},{'id':_0x55c0c3[_0x1daa48(0xda)]},{'orderId':_0x55c0c3[_0x1daa48(0xda)]}]}]}}));if(!_0x4dae6b){console[_0x1daa48(0xbc)](_0x1daa48(0xdf)+_0x55c0c3[_0x1daa48(0xda)]),console[_0x1daa48(0xbc)](_0x1daa48(0xc9)+_0x55c0c3['paymentId']+'\x22,\x20id=\x22'+_0x55c0c3['paymentId']+_0x1daa48(0xaf)+_0x55c0c3[_0x1daa48(0xda)]+'\x22');const _0x4f9060=await database_1[_0x1daa48(0xae)]['payment'][_0x1daa48(0x114)]({'where':{'gateway':_0x1daa48(0x12c)},'select':{'id':!![],'gatewayOrderId':!![],'orderId':!![],'status':!![]},'take':0xa});console['log']('�\x20Available\x20MasterCard\x20payments\x20for\x20debugging:',_0x4f9060);return;}console[_0x1daa48(0xc0)](_0x1daa48(0xa8)+_0x4dae6b['id']+_0x1daa48(0x12a)+_0x4dae6b[_0x1daa48(0x103)]+_0x1daa48(0x12b)+_0x55c0c3[_0x1daa48(0x103)]),await this[_0x1daa48(0x161)](_0x4dae6b['id'],_0x55c0c3['status']),loggerService_1[_0x1daa48(0xeb)]['logWebhookProcessed'](_0x1daa48(0x12c),_0x4dae6b['id'],_0x4dae6b['status'],_0x55c0c3[_0x1daa48(0x103)],_0x3f419c);}catch(_0x497593){console[_0x1daa48(0xbc)](_0x1daa48(0x127),_0x497593),loggerService_1['loggerService'][_0x1daa48(0xb9)](_0x1daa48(0x12c),_0x497593,_0x3f419c);throw _0x497593;}}async[a58_0x403dfc(0x140)](_0x1b6c91,_0x14cb83){const _0x85e624=a58_0x403dfc,_0x278277=Date[_0x85e624(0x104)]();try{const _0x49b36c=_0x1b6c91[_0x85e624(0x121)],_0x3557f5=_0x49b36c[_0x85e624(0x150)];if(!_0x3557f5?.[_0x85e624(0xc7)]){console[_0x85e624(0xc0)](_0x85e624(0xca)+_0x49b36c['id']);return;}const _0xde10a2=_0x14cb83===_0x85e624(0xfc)?_0x85e624(0x13b):_0x14cb83===_0x85e624(0xb8)?_0x85e624(0x111):_0x14cb83===_0x85e624(0x153)?'payment.failed':_0x14cb83===_0x85e624(0xb6)?'payment.failed':_0x14cb83==='REFUND'?'payment.failed':'payment.pending';let _0x3c0509=[];if(_0x3557f5[_0x85e624(0x116)])try{_0x3c0509=Array[_0x85e624(0xd3)](_0x3557f5[_0x85e624(0x116)])?_0x3557f5['webhookEvents']:JSON['parse'](_0x3557f5[_0x85e624(0x116)]);}catch(_0x4bb405){console[_0x85e624(0xbc)]('Error\x20parsing\x20webhook\x20events:',_0x4bb405),_0x3c0509=[];}if(!_0x3c0509['includes'](_0xde10a2)){console[_0x85e624(0xc0)](_0x85e624(0x13a)+_0xde10a2+'\x20not\x20enabled\x20for\x20shop\x20'+_0x49b36c['id']);return;}const _0x5ef645={'event':_0xde10a2,'payment':{'id':_0x1b6c91['id'],'order_id':_0x1b6c91[_0x85e624(0x117)],'gateway_order_id':_0x1b6c91[_0x85e624(0x14a)],'gateway':_0x1b6c91[_0x85e624(0x152)],'amount':_0x1b6c91[_0x85e624(0xc1)],'currency':_0x1b6c91['currency'],'status':_0x14cb83['toLowerCase'](),'customer_email':_0x1b6c91[_0x85e624(0xaa)],'customer_name':_0x1b6c91['customerName'],'failure_message':_0x1b6c91[_0x85e624(0xa7)],'tx_urls':_0x1b6c91[_0x85e624(0x136)]?JSON[_0x85e624(0x12d)](_0x1b6c91[_0x85e624(0x136)]):null,'created_at':_0x1b6c91[_0x85e624(0x16c)],'updated_at':_0x1b6c91[_0x85e624(0x11b)]}},_0x4b6286=await fetch(_0x3557f5[_0x85e624(0xc7)],{'method':_0x85e624(0x14f),'headers':{'Content-Type':_0x85e624(0xf7),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x85e624(0x154)](_0x5ef645)}),_0x3d03d1=Date[_0x85e624(0x104)]()-_0x278277,_0x4b1dc7=_0x4b6286['ok']?_0x85e624(0x120):await _0x4b6286['text']();loggerService_1[_0x85e624(0xeb)][_0x85e624(0xde)](_0x1b6c91[_0x85e624(0x148)],_0x3557f5[_0x85e624(0xc7)],_0xde10a2,_0x4b6286[_0x85e624(0x103)],_0x3d03d1,_0x5ef645),console[_0x85e624(0xc0)](_0x85e624(0x12e)+_0x3557f5[_0x85e624(0xc7)]+_0x85e624(0x10f)+_0x4b6286['status']+'\x20('+_0x3d03d1+_0x85e624(0x110));}catch(_0x292830){console[_0x85e624(0xbc)](_0x85e624(0xe2),_0x292830),loggerService_1[_0x85e624(0xeb)][_0x85e624(0xd4)](_0x1b6c91['shopId'],_0x1b6c91[_0x85e624(0x121)]?.[_0x85e624(0x150)]?.[_0x85e624(0xc7)]||_0x85e624(0xe4),_0x85e624(0x147),_0x292830,{});}}async[a58_0x403dfc(0x14e)](_0x31c167,_0x4fb204){const _0x4b13e6=a58_0x403dfc;try{const _0x2cc951={'PENDING':'created','PROCESSING':_0x4b13e6(0x115),'PAID':_0x4b13e6(0x10c),'FAILED':_0x4b13e6(0x163),'EXPIRED':_0x4b13e6(0x15f),'REFUND':_0x4b13e6(0x135),'CHARGEBACK':_0x4b13e6(0x12f)},_0x13a785=_0x2cc951[_0x4fb204];if(!_0x13a785||_0x13a785===_0x4b13e6(0x107))return;await telegramBotService_1[_0x4b13e6(0x13f)][_0x4b13e6(0x129)](_0x31c167[_0x4b13e6(0x148)],_0x31c167,_0x13a785);}catch(_0x2753c5){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x2753c5);}}}exports['WebhookService']=WebhookService;