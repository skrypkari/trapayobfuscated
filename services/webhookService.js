'use strict';const a69_0xa9883=a69_0x92aa;(function(_0x3cbe00,_0x3f7d68){const _0x5d5849=a69_0x92aa,_0x2d5734=_0x3cbe00();while(!![]){try{const _0x47046d=parseInt(_0x5d5849(0x27f))/0x1+-parseInt(_0x5d5849(0x296))/0x2+parseInt(_0x5d5849(0x25e))/0x3*(-parseInt(_0x5d5849(0x240))/0x4)+-parseInt(_0x5d5849(0x263))/0x5+-parseInt(_0x5d5849(0x1fd))/0x6*(parseInt(_0x5d5849(0x1f8))/0x7)+parseInt(_0x5d5849(0x1de))/0x8+parseInt(_0x5d5849(0x1fa))/0x9*(parseInt(_0x5d5849(0x29f))/0xa);if(_0x47046d===_0x3f7d68)break;else _0x2d5734['push'](_0x2d5734['shift']());}catch(_0x1b4eaf){_0x2d5734['push'](_0x2d5734['shift']());}}}(a69_0x3582,0xbe5fa));function a69_0x3582(){const _0x1e307e=['create','‚úÖ\x20AmPay\x20webhook\x20processed:\x20Payment\x20','üîç\x20Search\x20result:\x20','now','Error\x20parsing\x20webhook\x20events:','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','logShopWebhookSent','paymentId','cardLast4','../config/database','loggerService','\x20+\x20','processWebhook','refund','üí∏\x20CHARGEBACK:\x20Processing\x20penalty-only\x20deduction','COMPLETED','‚ùå\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','paymentLink','\x20to\x20','‚úÖ\x20Found\x20payment:\x20ID=','processMasterCardWebhook',',\x20card:\x20****','Payment\x20not\x20found:\x20',',\x20newStatus=','nodaService','klymeService','updatePaymentStatus','payment_method','getGatewayCommission','./gateways/ampayService','chargebackAmount','Payment\x20not\x20found','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','AmPayTRYService','6438336HPLJkl','EXPIRED','error','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','‚ùå\x20Error\x20processing\x20MasterCard\x20webhook:','updatedAt','Payment\x20','default','üîÑ\x20Processing\x20Amer\x20webhook:','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','noda','customerOrderId','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','./gateways/nodaService','üìä\x20MasterCard\x20webhook\x20result:','./gateways/rapydService','processing','CoinToPay2Service','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','üìà\x20Found\x20payment\x20link\x20','webhookEvents','\x20‚Üí\x20','üîÑ\x20MyXSpend\x20status\x20','type','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','üîç\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','525945QKzjFp','üîÑ\x20updatePaymentStatus\x20called:\x20paymentId=','63bemFug','üìä\x20Amer\x20webhook:\x20Payment\x20','üí∞\x20Payment\x20amount\x20is\x20NOT\x20deducted\x20(chargeback\x20penalty\x20only)','72IvrRkt','errorMessage','findMany','ampay','RapydService','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','chargeback','gatewayCommissionRate','./gateways/coinToPay2Service',',\x20currentPayments=','üìä\x20VISA\x20payment\x20found:\x20','FAILED','Found','üí∞\x20Final\x20balance\x20after\x20chargeback:\x20','dateTime','payment.failed','REFUND','amountUSDT','Error\x20processing\x20Plisio\x20webhook:','coinToPayService','findUnique','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','currencyService','rapydService','üìä\x20CoinToPay\x20webhook:\x20Payment\x20','findFirst','visaMasterCardService','Found\x20payment\x20','üîç\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','‚úÖ\x20Shop\x20','Query\x20params:','status','\x22,\x20id=\x22','üìä\x20MyXSpend\x20webhook\x20data:','\x20(Status:\x20','toUpperCase','üìä\x20Amer\x20webhook\x20result:','‚ùå\x20Error\x20processing\x20Amer\x20webhook:','balance','parse','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','toFixed','‚ùå\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','logShopWebhookError','Error\x20processing\x20CoinToPay2\x20webhook:','\x20mapped\x20to\x20FAILED','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','‚ùå\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','customerName','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','plisioService','Gateway\x20','amount','sendPaymentStatusNotification','paidAt','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',',\x20gatewayPaymentId:\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook','entries','update','Payment\x20System/1.0','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','üì§\x20Shop\x20webhook\x20sent\x20to\x20','processAmerWebhook','failureMessage','AmPayService','60MUhqOn','visa','PAID','keys',',\x20Gateway=','VISA','ampayTRYService','üîÑ\x20Additional\x20data:','expired',',\x20GatewayOrderId=','__esModule','üìä\x20KLYME\x20webhook:\x20Payment\x20','remitterName','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','gatewaySettings','‚úÖ\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','üîÑ\x20Processing\x20AmPay\x20webhook:',':\x20type=','desc','status_addition_info','stringify','\x20=\x20','plisio','‚ùå\x20Payment\x20link\x20','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','rapyd','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','AmerService','client_transaction_id','üìä\x20Rapyd\x20webhook:\x20Payment\x20','283494NzbceG','visa_mastercard','orderId','üîç\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','\x20with\x20status\x20','6704260erEpkP','‚ùå\x20VISA\x20payment\x20failed\x20with\x20message:\x20','sendPaymentNotification','üìà\x20Payment\x20','üîç\x20Found\x20VISA\x20payment:\x20ID=','isArray','No\x20payment\x20ID\x20in\x20Amer\x20webhook','system_id','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','toISOString','üîÑ\x20Processing\x20VISA\x20webhook:','webhookUrl','log','üí∞\x20Adding\x20to\x20balance:\x20','‚úÖ\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','Not\x20found','additionalInfo','klyme','\x20not\x20enabled\x20for\x20shop\x20','processKlymeWebhook','cointopay2','\x20updated:\x20currentPayments=','amountAfterGatewayCommissionUSDT','üîÑ\x20Processing\x20Plisio\x20Gateway\x20webhook:','payment.pending','‚ùå\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:','‚úÖ\x20Found\x20payment\x20','paymentMethod','489238IXdWas','processCoinToPay2Webhook','\x22,\x20newStatus=\x22','\x20for\x20AmPay\x20webhook','‚ùå\x20Available\x20webhook\x20fields:','‚ùå\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','logWebhookProcessed','üîÑ\x20Processing\x20MasterCard\x20webhook:','gateway','‚ùå\x20VISA\x20webhook\x20processing\x20failed:','DECLINED','./loggerService','webhookLog','Failed\x20to\x20send\x20shop\x20webhook:','webhook_send','processCoinToPayWebhook','Webhook\x20event\x20','\x20not\x20found','settings','map','shopId','1373538dwZVUl','gatewayOrderId','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','‚úÖ\x20Payment\x20link\x20','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','üìä\x20Payment\x20status:\x20','PlisioService','ampay_try','system','5474930OJElii','\x20status\x20','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','üìä\x20VISA\x20webhook\x20result:','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','NodaService','myxspend','‚úÖ\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20','Body\x20data:','MasterCard\x20payment\x20not\x20found:\x20','gatewayPaymentId','üìä\x20AmPay\x20TRY\x20webhook\x20data:','üìä\x20CoinToPay2\x20webhook:\x20Payment\x20','üìù\x20Reason:\x20','üîÑ\x20Processing\x20Noda\x20webhook:','ampay_try_','‚ùå\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','processPlisioGatewayWebhook','cointopay','üîÑ\x20Processing\x20CoinToPay2\x20webhook:','visa/mastercard','‚ÑπÔ∏è\x20AmPay\x20TRY\x20status\x20','webhook_status_change_','shop','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','\x20for\x20AmPay\x20TRY\x20webhook','‚ùå\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','MASTERCARD','\x20balance\x20updated:\x20','sendShopWebhook','remitterIban','commission','createdAt','__importDefault',',\x20gatewayOrderId:\x20','paymentLinkId','üí∞\x20Payment\x20','$transaction','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','mastercard','üîÑ\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','\x20(orderId:\x20','./gateways/plisioService','üîÑ\x20Processing\x20KLYME\x20webhook:','no\x20balance\x20change','\x20USDT\x20(chargeback\x20penalty\x20ONLY)','CHARGEBACK',',\x20Status=','unknown','convertToUSDT','No\x20additional\x20info','toLowerCase','üìä\x20Plisio\x20webhook:\x20Payment\x20','‚ÑπÔ∏è\x20MyXSpend\x20status\x20','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','üîÑ\x20Processing\x20MyXSpend\x20webhook:','üí∞\x20Converting\x20','txUrls','created','üìä\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','ampayService','amerService','./gateways/ampayTRYService','processNodaWebhook','\x20-\x20','üìä\x20AmPay\x20webhook\x20data:',',\x20using\x20default\x2010%','Success','logWebhookError','customerEmail','processRapydWebhook','VISA\x20payment\x20not\x20found:\x20','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','üîÑ\x20Processing\x20Rapyd\x20webhook:','‚ùå\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','%\x20gateway\x20commission)','plisio_gateway','processVisaWebhook','coinToPay2Service','telegramBotService','\x20->\x20','currentPayments','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','\x20USDT','‚ùå\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','‚ÑπÔ∏è\x20Decline\x20reason:\x20','payment.success','\x20status\x20updated\x20to\x20FAILED','payment','amer','./gateways/coinToPayService','Error\x20processing\x20Noda\x20webhook:','currency','üìä\x20Noda\x20webhook:\x20Payment\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook',',\x20Card=****',',\x20status=','üîÑ\x20Processing\x20CoinToPay\x20webhook:','username','\x20current\x20balance:\x20'];a69_0x3582=function(){return _0x1e307e;};return a69_0x3582();}var __importDefault=this&&this[a69_0xa9883(0x179)]||function(_0x1137c5){const _0x314816=a69_0xa9883;return _0x1137c5&&_0x1137c5[_0x314816(0x24a)]?_0x1137c5:{'default':_0x1137c5};};function a69_0x92aa(_0x2c6b3b,_0x38497e){const _0x35821d=a69_0x3582();return a69_0x92aa=function(_0x92aad0,_0x49fe29){_0x92aad0=_0x92aad0-0x16b;let _0x5cb573=_0x35821d[_0x92aad0];return _0x5cb573;},a69_0x92aa(_0x2c6b3b,_0x38497e);}Object['defineProperty'](exports,a69_0xa9883(0x24a),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a69_0xa9883(0x1c5))),plisioService_1=require(a69_0xa9883(0x182)),rapydService_1=require(a69_0xa9883(0x1ed)),nodaService_1=require(a69_0xa9883(0x1eb)),coinToPayService_1=require(a69_0xa9883(0x1b2)),coinToPay2Service_1=require(a69_0xa9883(0x205)),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require('./gateways/mastercardService'),amerService_1=require('./gateways/amerService'),ampayService_1=require(a69_0xa9883(0x1d9)),ampayTRYService_1=require(a69_0xa9883(0x196)),telegramBotService_1=require('./telegramBotService'),currencyService_1=require('./currencyService'),loggerService_1=require(a69_0xa9883(0x28c));class WebhookService{constructor(){const _0x34a187=a69_0xa9883;this[_0x34a187(0x230)]=new plisioService_1[(_0x34a187(0x29c))](),this['rapydService']=new rapydService_1[(_0x34a187(0x201))](),this[_0x34a187(0x1d4)]=new nodaService_1[(_0x34a187(0x2a5))](),this[_0x34a187(0x210)]=new coinToPayService_1['CoinToPayService'](),this[_0x34a187(0x1a6)]=new coinToPay2Service_1[(_0x34a187(0x1ef))](),this[_0x34a187(0x1d5)]=new klymeService_1['KlymeService'](),this[_0x34a187(0x217)]=new mastercardService_1['VisaMasterCardService'](),this[_0x34a187(0x195)]=new amerService_1[(_0x34a187(0x25b))](),this[_0x34a187(0x194)]=new ampayService_1[(_0x34a187(0x23f))](),this[_0x34a187(0x246)]=new ampayTRYService_1[(_0x34a187(0x1dd))]();}async[a69_0xa9883(0x1d6)](_0x35d42d,_0x5eeeec,_0x136f40){const _0xf04d84=a69_0xa9883;console[_0xf04d84(0x26f)](_0xf04d84(0x1f9)+_0x35d42d+_0xf04d84(0x1d3)+_0x5eeeec),console[_0xf04d84(0x26f)](_0xf04d84(0x247),_0x136f40),await database_1[_0xf04d84(0x1e5)][_0xf04d84(0x17d)](async _0x38f362=>{const _0x335610=_0xf04d84,_0x5df71d=await _0x38f362[_0x335610(0x1b0)][_0x335610(0x211)]({'where':{'id':_0x35d42d},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5df71d)throw new Error(_0x335610(0x1e4)+_0x35d42d+_0x335610(0x292));const _0x944460=_0x5df71d[_0x335610(0x21c)],_0x393572=_0x5df71d[_0x335610(0x16f)];console[_0x335610(0x26f)](_0x335610(0x17c)+_0x35d42d+':\x20'+_0x944460+_0x335610(0x1a8)+_0x5eeeec),console[_0x335610(0x26f)]('üè™\x20Shop\x20'+_0x393572['username']+_0x335610(0x1bb)+_0x393572[_0x335610(0x223)]+_0x335610(0x1ab));const _0x22e33f={'status':_0x5eeeec[_0x335610(0x220)](),'updatedAt':new Date(),'statusChangedBy':_0x335610(0x29e),'statusChangedAt':new Date()};_0x136f40?.['failureMessage']&&(_0x22e33f['failureMessage']=_0x136f40['failureMessage']);_0x136f40?.[_0x335610(0x191)]&&(_0x22e33f[_0x335610(0x191)]=JSON[_0x335610(0x254)](_0x136f40['txUrls']));_0x136f40?.[_0x335610(0x1c4)]&&(_0x22e33f[_0x335610(0x1c4)]=_0x136f40[_0x335610(0x1c4)]);_0x136f40?.[_0x335610(0x27e)]&&(_0x22e33f[_0x335610(0x27e)]=_0x136f40[_0x335610(0x27e)]);_0x136f40?.['bankId']&&(_0x22e33f['bankId']=_0x136f40['bankId']);_0x136f40?.[_0x335610(0x176)]&&(_0x22e33f[_0x335610(0x176)]=_0x136f40[_0x335610(0x176)]);_0x136f40?.['remitterName']&&(_0x22e33f[_0x335610(0x24c)]=_0x136f40[_0x335610(0x24c)]);let _0x11d532=_0x393572['balance'],_0x1e4846='';if(_0x5eeeec['toUpperCase']()===_0x335610(0x242)&&_0x944460!==_0x335610(0x242)){const _0x1ac35c=await currencyService_1[_0x335610(0x213)][_0x335610(0x189)](_0x5df71d[_0x335610(0x232)],_0x5df71d[_0x335610(0x1b4)]),_0x1db156=await this[_0x335610(0x1d8)](_0x393572['id'],_0x5df71d[_0x335610(0x289)]),_0x385400=_0x1ac35c*(0x1-_0x1db156/0x64);_0x11d532+=_0x385400,_0x1e4846='+'+_0x385400[_0x335610(0x226)](0x6)+_0x335610(0x1c1)+_0x1db156+_0x335610(0x1a3),_0x22e33f['amountUSDT']=_0x1ac35c,_0x22e33f['amountAfterGatewayCommissionUSDT']=_0x385400,_0x22e33f[_0x335610(0x204)]=_0x1db156,_0x22e33f[_0x335610(0x234)]=new Date(),console['log'](_0x335610(0x190)+_0x5df71d[_0x335610(0x232)]+'\x20'+_0x5df71d[_0x335610(0x1b4)]+_0x335610(0x1a8)+_0x1ac35c[_0x335610(0x226)](0x6)+_0x335610(0x1ab)),console['log']('üí∞\x20Gateway\x20'+_0x5df71d['gateway']+'\x20commission:\x20'+_0x1db156+'%'),console[_0x335610(0x26f)]('üí∞\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x385400[_0x335610(0x226)](0x6)+_0x335610(0x1ab)),console['log'](_0x335610(0x270)+_0x393572[_0x335610(0x223)]+_0x335610(0x1c7)+_0x385400[_0x335610(0x226)](0x6)+'\x20=\x20'+_0x11d532['toFixed'](0x6)+_0x335610(0x1ab));}else{if(_0x944460===_0x335610(0x242)&&_0x5eeeec['toUpperCase']()!==_0x335610(0x242)&&_0x5eeeec[_0x335610(0x220)]()!==_0x335610(0x186)){let _0x210682;if(_0x5df71d['amountAfterGatewayCommissionUSDT'])_0x210682=_0x5df71d[_0x335610(0x279)];else{if(_0x5df71d[_0x335610(0x20e)]){const _0x44aa0b=await this[_0x335610(0x1d8)](_0x393572['id'],_0x5df71d[_0x335610(0x289)]);_0x210682=_0x5df71d[_0x335610(0x20e)]*(0x1-_0x44aa0b/0x64);}else console[_0x335610(0x26f)](_0x335610(0x212)),_0x210682=0x0;}_0x210682>0x0&&(_0x11d532-=_0x210682,_0x1e4846='-'+_0x210682[_0x335610(0x226)](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x22e33f[_0x335610(0x234)]=null,console[_0x335610(0x26f)]('üí∞\x20Removing\x20from\x20balance:\x20'+_0x393572[_0x335610(0x223)]+_0x335610(0x198)+_0x210682[_0x335610(0x226)](0x6)+_0x335610(0x255)+_0x11d532[_0x335610(0x226)](0x6)+_0x335610(0x1ab)));}}if(_0x5eeeec[_0x335610(0x220)]()===_0x335610(0x186)){const _0x5eea5b=_0x136f40?.['chargebackAmount']||0x0;console[_0x335610(0x26f)](_0x335610(0x1ca)),_0x5eea5b>0x0?(_0x11d532-=_0x5eea5b,_0x1e4846='-'+_0x5eea5b[_0x335610(0x226)](0x6)+_0x335610(0x185),_0x22e33f[_0x335610(0x1da)]=_0x5eea5b,console[_0x335610(0x26f)]('üí∏\x20CHARGEBACK\x20penalty\x20ONLY:\x20-'+_0x5eea5b[_0x335610(0x226)](0x6)+_0x335610(0x1ab)),console[_0x335610(0x26f)](_0x335610(0x1fc)),console[_0x335610(0x26f)](_0x335610(0x20a)+_0x11d532[_0x335610(0x226)](0x6)+_0x335610(0x1ab))):(console[_0x335610(0x26f)]('‚ö†Ô∏è\x20CHARGEBACK\x20without\x20penalty\x20amount\x20-\x20no\x20balance\x20change'),_0x1e4846='Payment\x20marked\x20as\x20CHARGEBACK\x20(no\x20penalty\x20specified)');}const _0x554897=await _0x38f362[_0x335610(0x1b0)][_0x335610(0x239)]({'where':{'id':_0x35d42d},'data':_0x22e33f});_0x11d532!==_0x393572[_0x335610(0x223)]&&(await _0x38f362['shop']['update']({'where':{'id':_0x393572['id']},'data':{'balance':_0x11d532}}),console[_0x335610(0x26f)](_0x335610(0x21a)+_0x393572[_0x335610(0x1ba)]+_0x335610(0x174)+_0x393572[_0x335610(0x223)][_0x335610(0x226)](0x6)+_0x335610(0x1a8)+_0x11d532['toFixed'](0x6)+'\x20USDT'),console[_0x335610(0x26f)](_0x335610(0x2ad)+_0x1e4846));await _0x38f362['webhookLog'][_0x335610(0x1bc)]({'data':{'paymentId':_0x35d42d,'shopId':_0x393572['id'],'event':_0x335610(0x16e)+_0x5eeeec[_0x335610(0x18b)](),'statusCode':0xc8,'responseBody':JSON[_0x335610(0x254)]({'oldStatus':_0x944460,'newStatus':_0x5eeeec[_0x335610(0x220)](),'balanceChange':_0x1e4846||_0x335610(0x184),'oldBalance':_0x393572[_0x335610(0x223)],'newBalance':_0x11d532,'amountUSDT':_0x22e33f[_0x335610(0x20e)],'additionalData':_0x136f40,'timestamp':new Date()[_0x335610(0x26c)]()})}}),await this[_0x335610(0x175)]({..._0x5df71d,..._0x554897,'shop':_0x393572},_0x5eeeec[_0x335610(0x220)]()),await this[_0x335610(0x233)]({..._0x5df71d,..._0x554897},_0x5eeeec[_0x335610(0x220)]());if(_0x944460!==_0x335610(0x242)&&_0x5eeeec[_0x335610(0x220)]()==='PAID'){console[_0x335610(0x26f)]('üìà\x20Payment\x20'+_0x35d42d+_0x335610(0x26b)),console[_0x335610(0x26f)]('üìà\x20Payment\x20details:\x20oldStatus=\x22'+_0x944460+_0x335610(0x281)+_0x5eeeec[_0x335610(0x220)]()+'\x22,\x20paymentLinkId=\x22'+_0x5df71d[_0x335610(0x17b)]+'\x22');if(_0x5df71d[_0x335610(0x17b)])try{const _0x14a040=await _0x38f362[_0x335610(0x1cd)]['findUnique']({'where':{'id':_0x5df71d[_0x335610(0x17b)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x14a040){console[_0x335610(0x26f)](_0x335610(0x1f1)+_0x14a040['id']+_0x335610(0x251)+_0x14a040[_0x335610(0x1f5)]+_0x335610(0x206)+_0x14a040[_0x335610(0x1a9)]+_0x335610(0x1b8)+_0x14a040['status']);const _0x41ab66=_0x14a040[_0x335610(0x1a9)]+0x1,_0x5a5064=_0x14a040[_0x335610(0x1f5)]==='SINGLE'?_0x335610(0x1cb):_0x14a040[_0x335610(0x21c)];await _0x38f362[_0x335610(0x1cd)]['update']({'where':{'id':_0x5df71d[_0x335610(0x17b)]},'data':{'currentPayments':_0x41ab66,'status':_0x5a5064,'updatedAt':new Date()}}),console[_0x335610(0x26f)](_0x335610(0x299)+_0x14a040['id']+_0x335610(0x278)+_0x14a040[_0x335610(0x1a9)]+_0x335610(0x1a8)+_0x41ab66+_0x335610(0x1b8)+_0x14a040[_0x335610(0x21c)]+'\x20->\x20'+_0x5a5064);}else console[_0x335610(0x26f)](_0x335610(0x257)+_0x5df71d[_0x335610(0x17b)]+_0x335610(0x292));}catch(_0x52f743){console[_0x335610(0x1e0)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x52f743);}else console[_0x335610(0x26f)]('üìà\x20Payment\x20'+_0x35d42d+_0x335610(0x1f0));}else console['log'](_0x335610(0x266)+_0x35d42d+_0x335610(0x298)+_0x944460+_0x335610(0x1a8)+_0x5eeeec[_0x335610(0x220)]());});}async['processPlisioWebhook'](_0x308cff){const _0x1bfed0=a69_0xa9883;console[_0x1bfed0(0x26f)]('üîÑ\x20Processing\x20Plisio\x20webhook:',_0x308cff);try{const _0x18094e=await this[_0x1bfed0(0x230)][_0x1bfed0(0x1c8)](_0x308cff);if(!_0x18094e[_0x1bfed0(0x1c3)])throw new Error(_0x1bfed0(0x285));const _0x3fdd90=await database_1[_0x1bfed0(0x1e5)]['payment'][_0x1bfed0(0x216)]({'where':{'gatewayOrderId':_0x18094e['paymentId']}});if(!_0x3fdd90){console[_0x1bfed0(0x1e0)](_0x1bfed0(0x23b)+_0x18094e[_0x1bfed0(0x1c3)]);return;}console[_0x1bfed0(0x26f)](_0x1bfed0(0x18c)+_0x3fdd90['id']+_0x1bfed0(0x2a0)+_0x18094e[_0x1bfed0(0x21c)]),await this[_0x1bfed0(0x1d6)](_0x3fdd90['id'],_0x18094e[_0x1bfed0(0x21c)],{'txUrls':_0x18094e['txUrls']}),loggerService_1['loggerService']['logWebhookProcessed'](_0x1bfed0(0x256),_0x3fdd90['id'],_0x3fdd90['status'],_0x18094e[_0x1bfed0(0x21c)],_0x308cff);}catch(_0xf8a609){console[_0x1bfed0(0x1e0)](_0x1bfed0(0x20f),_0xf8a609),loggerService_1[_0x1bfed0(0x1c6)][_0x1bfed0(0x19c)](_0x1bfed0(0x256),_0xf8a609,_0x308cff);throw _0xf8a609;}}async[a69_0xa9883(0x2b1)](_0x926642){const _0x1e2f98=a69_0xa9883;console[_0x1e2f98(0x26f)](_0x1e2f98(0x27a),_0x926642);try{const _0x2fa3e0=await this[_0x1e2f98(0x230)][_0x1e2f98(0x1c8)](_0x926642);if(!_0x2fa3e0[_0x1e2f98(0x1c3)])throw new Error(_0x1e2f98(0x18e));const _0x3230d5=await database_1[_0x1e2f98(0x1e5)][_0x1e2f98(0x1b0)]['findFirst']({'where':{'gatewayOrderId':_0x2fa3e0[_0x1e2f98(0x1c3)]}});if(!_0x3230d5){console['error'](_0x1e2f98(0x24d)+_0x2fa3e0[_0x1e2f98(0x1c3)]);return;}console['log'](_0x1e2f98(0x193)+_0x3230d5['id']+_0x1e2f98(0x2a0)+_0x2fa3e0[_0x1e2f98(0x21c)]),await this[_0x1e2f98(0x1d6)](_0x3230d5['id'],_0x2fa3e0[_0x1e2f98(0x21c)],{'txUrls':_0x2fa3e0[_0x1e2f98(0x191)]}),loggerService_1[_0x1e2f98(0x1c6)][_0x1e2f98(0x287)](_0x1e2f98(0x1a4),_0x3230d5['id'],_0x3230d5[_0x1e2f98(0x21c)],_0x2fa3e0['status'],_0x926642);}catch(_0x414b31){console[_0x1e2f98(0x1e0)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x414b31),loggerService_1[_0x1e2f98(0x1c6)][_0x1e2f98(0x19c)](_0x1e2f98(0x1a4),_0x414b31,_0x926642);throw _0x414b31;}}async[a69_0xa9883(0x19e)](_0xe524b6){const _0x200672=a69_0xa9883;console[_0x200672(0x26f)](_0x200672(0x1a1),_0xe524b6);try{const _0x53f703=await this[_0x200672(0x214)][_0x200672(0x1c8)](_0xe524b6);if(!_0x53f703[_0x200672(0x1c3)])throw new Error(_0x200672(0x286));const _0x483368=await database_1[_0x200672(0x1e5)]['payment'][_0x200672(0x216)]({'where':{'gatewayOrderId':_0x53f703[_0x200672(0x1c3)]}});if(!_0x483368){console[_0x200672(0x1e0)](_0x200672(0x22b)+_0x53f703[_0x200672(0x1c3)]);return;}console[_0x200672(0x26f)](_0x200672(0x25d)+_0x483368['id']+_0x200672(0x2a0)+_0x53f703[_0x200672(0x21c)]),await this[_0x200672(0x1d6)](_0x483368['id'],_0x53f703[_0x200672(0x21c)],{'failureMessage':_0x53f703[_0x200672(0x23e)],'cardLast4':_0x53f703[_0x200672(0x273)]?.[_0x200672(0x1c4)],'paymentMethod':_0x53f703[_0x200672(0x273)]?.[_0x200672(0x27e)]}),loggerService_1[_0x200672(0x1c6)][_0x200672(0x287)](_0x200672(0x259),_0x483368['id'],_0x483368[_0x200672(0x21c)],_0x53f703['status'],_0xe524b6);}catch(_0x3d22da){console[_0x200672(0x1e0)]('Error\x20processing\x20Rapyd\x20webhook:',_0x3d22da),loggerService_1[_0x200672(0x1c6)]['logWebhookError'](_0x200672(0x259),_0x3d22da,_0xe524b6);throw _0x3d22da;}}async[a69_0xa9883(0x197)](_0x58d45c){const _0x11e1ea=a69_0xa9883;console['log'](_0x11e1ea(0x2ae),_0x58d45c);try{const _0x183813=await this[_0x11e1ea(0x1d4)][_0x11e1ea(0x1c8)](_0x58d45c);if(!_0x183813['paymentId'])throw new Error(_0x11e1ea(0x237));const _0x5c59de=await database_1['default'][_0x11e1ea(0x1b0)][_0x11e1ea(0x216)]({'where':{'gatewayOrderId':_0x183813[_0x11e1ea(0x1c3)]}});if(!_0x5c59de){console[_0x11e1ea(0x1e0)]('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x183813[_0x11e1ea(0x1c3)]);return;}console[_0x11e1ea(0x26f)](_0x11e1ea(0x1b5)+_0x5c59de['id']+_0x11e1ea(0x2a0)+_0x183813['status']),await this['updatePaymentStatus'](_0x5c59de['id'],_0x183813['status'],{'bankId':_0x183813[_0x11e1ea(0x273)]?.['bankId'],'remitterIban':_0x183813[_0x11e1ea(0x273)]?.[_0x11e1ea(0x176)],'remitterName':_0x183813['additionalInfo']?.[_0x11e1ea(0x24c)]}),loggerService_1[_0x11e1ea(0x1c6)]['logWebhookProcessed'](_0x11e1ea(0x1e8),_0x5c59de['id'],_0x5c59de[_0x11e1ea(0x21c)],_0x183813[_0x11e1ea(0x21c)],_0x58d45c);}catch(_0x58690a){console[_0x11e1ea(0x1e0)](_0x11e1ea(0x1b3),_0x58690a),loggerService_1[_0x11e1ea(0x1c6)]['logWebhookError']('noda',_0x58690a,_0x58d45c);throw _0x58690a;}}async[a69_0xa9883(0x290)](_0x3ae110){const _0x5aecbe=a69_0xa9883;console[_0x5aecbe(0x26f)](_0x5aecbe(0x1b9),_0x3ae110);try{const _0x394734=await this[_0x5aecbe(0x210)][_0x5aecbe(0x1c8)](_0x3ae110);if(!_0x394734['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x3a0c1a=await database_1[_0x5aecbe(0x1e5)][_0x5aecbe(0x1b0)][_0x5aecbe(0x216)]({'where':{'gatewayOrderId':_0x394734['paymentId']}});if(!_0x3a0c1a){console['error'](_0x5aecbe(0x29a)+_0x394734[_0x5aecbe(0x1c3)]);return;}console['log'](_0x5aecbe(0x215)+_0x3a0c1a['id']+_0x5aecbe(0x2a0)+_0x394734['status']),await this[_0x5aecbe(0x1d6)](_0x3a0c1a['id'],_0x394734[_0x5aecbe(0x21c)]),loggerService_1[_0x5aecbe(0x1c6)]['logWebhookProcessed'](_0x5aecbe(0x2b2),_0x3a0c1a['id'],_0x3a0c1a['status'],_0x394734[_0x5aecbe(0x21c)],_0x3ae110);}catch(_0x2d5981){console[_0x5aecbe(0x1e0)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x2d5981),loggerService_1[_0x5aecbe(0x1c6)][_0x5aecbe(0x19c)](_0x5aecbe(0x2b2),_0x2d5981,_0x3ae110);throw _0x2d5981;}}async[a69_0xa9883(0x280)](_0x43d62d){const _0x44a8e3=a69_0xa9883;console[_0x44a8e3(0x26f)](_0x44a8e3(0x16b),_0x43d62d);try{const _0x18227a=await this[_0x44a8e3(0x1a6)][_0x44a8e3(0x1c8)](_0x43d62d);if(!_0x18227a[_0x44a8e3(0x1c3)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook');const _0x40c642=await database_1[_0x44a8e3(0x1e5)][_0x44a8e3(0x1b0)]['findFirst']({'where':{'gatewayOrderId':_0x18227a[_0x44a8e3(0x1c3)]}});if(!_0x40c642){console['error'](_0x44a8e3(0x1aa)+_0x18227a['paymentId']);return;}console[_0x44a8e3(0x26f)](_0x44a8e3(0x2ac)+_0x40c642['id']+_0x44a8e3(0x2a0)+_0x18227a[_0x44a8e3(0x21c)]),await this[_0x44a8e3(0x1d6)](_0x40c642['id'],_0x18227a[_0x44a8e3(0x21c)]),loggerService_1[_0x44a8e3(0x1c6)]['logWebhookProcessed']('cointopay2',_0x40c642['id'],_0x40c642[_0x44a8e3(0x21c)],_0x18227a[_0x44a8e3(0x21c)],_0x43d62d);}catch(_0x4d475b){console[_0x44a8e3(0x1e0)](_0x44a8e3(0x229),_0x4d475b),loggerService_1[_0x44a8e3(0x1c6)][_0x44a8e3(0x19c)](_0x44a8e3(0x277),_0x4d475b,_0x43d62d);throw _0x4d475b;}}async[a69_0xa9883(0x276)](_0x45d991){const _0x5575a6=a69_0xa9883;console[_0x5575a6(0x26f)](_0x5575a6(0x183),_0x45d991);try{const _0x1b4d38=await this['klymeService']['processWebhook'](_0x45d991);if(!_0x1b4d38[_0x5575a6(0x1c3)])throw new Error(_0x5575a6(0x258));const _0x224766=await database_1['default']['payment'][_0x5575a6(0x216)]({'where':{'gatewayOrderId':_0x1b4d38['paymentId']}});if(!_0x224766){console[_0x5575a6(0x1e0)](_0x5575a6(0x22f)+_0x1b4d38['paymentId']);return;}console['log'](_0x5575a6(0x24b)+_0x224766['id']+'\x20status\x20'+_0x1b4d38[_0x5575a6(0x21c)]),await this['updatePaymentStatus'](_0x224766['id'],_0x1b4d38[_0x5575a6(0x21c)],{'paymentMethod':_0x1b4d38[_0x5575a6(0x273)]?.['payment_method']}),loggerService_1[_0x5575a6(0x1c6)]['logWebhookProcessed'](_0x5575a6(0x274),_0x224766['id'],_0x224766['status'],_0x1b4d38[_0x5575a6(0x21c)],_0x45d991);}catch(_0x352cae){console[_0x5575a6(0x1e0)]('Error\x20processing\x20KLYME\x20webhook:',_0x352cae),loggerService_1[_0x5575a6(0x1c6)]['logWebhookError'](_0x5575a6(0x274),_0x352cae,_0x45d991);throw _0x352cae;}}async[a69_0xa9883(0x1a5)](_0x95f15b){const _0x462123=a69_0xa9883;console[_0x462123(0x26f)](_0x462123(0x26d),JSON['stringify'](_0x95f15b,null,0x2));try{const _0x32f95b=await this[_0x462123(0x217)][_0x462123(0x1c8)](_0x95f15b,_0x462123(0x245));console['log'](_0x462123(0x2a3),_0x32f95b);if(!_0x32f95b['paymentId']){console['error']('‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data'),console[_0x462123(0x1e0)](_0x462123(0x283),Object[_0x462123(0x243)](_0x95f15b));throw new Error('No\x20payment\x20ID\x20in\x20VISA\x20webhook');}let _0x13eb8e=null;console[_0x462123(0x26f)](_0x462123(0x219)+_0x32f95b[_0x462123(0x1c3)]);if(_0x32f95b[_0x462123(0x1c3)]){console[_0x462123(0x26f)](_0x462123(0x1f7)),console[_0x462123(0x26f)]('üîç\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:'),console[_0x462123(0x26f)](_0x462123(0x1a0)),console[_0x462123(0x26f)](_0x462123(0x2a1)+_0x32f95b[_0x462123(0x1c3)]),console[_0x462123(0x26f)](_0x462123(0x170)),_0x13eb8e=await database_1[_0x462123(0x1e5)][_0x462123(0x1b0)][_0x462123(0x216)]({'where':{'AND':[{'OR':[{'gateway':_0x462123(0x16c)},{'gateway':_0x462123(0x17f)}]},{'OR':[{'gatewayPaymentId':_0x32f95b[_0x462123(0x1c3)]},{'gatewayOrderId':_0x32f95b[_0x462123(0x1c3)]},{'id':_0x32f95b['paymentId']},{'orderId':_0x32f95b[_0x462123(0x1c3)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x462123(0x26f)]('üîç\x20VISA\x20payment\x20search\x20executed');if(_0x13eb8e)console['log'](_0x462123(0x1cf)+_0x13eb8e['id']+_0x462123(0x249)+_0x13eb8e[_0x462123(0x297)]+',\x20GatewayPaymentId='+_0x13eb8e[_0x462123(0x2aa)]);else{console['log'](_0x462123(0x2b0));const _0x1d7baf=await database_1[_0x462123(0x1e5)][_0x462123(0x1b0)][_0x462123(0x1ff)]({'where':{'gateway':'visa/mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x462123(0x252)}});console[_0x462123(0x26f)]('üîç\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:',_0x1d7baf[_0x462123(0x294)](_0x5361bd=>_0x5361bd['id']+_0x462123(0x181)+_0x5361bd[_0x462123(0x260)]+_0x462123(0x17a)+_0x5361bd[_0x462123(0x297)]+_0x462123(0x236)+_0x5361bd[_0x462123(0x2aa)]+_0x462123(0x1d1)+_0x5361bd[_0x462123(0x1c4)]+')'));}console[_0x462123(0x26f)]('üîç\x20VISA\x20payment\x20search\x20result:\x20'+(_0x13eb8e?_0x462123(0x209):_0x462123(0x272))),_0x13eb8e&&console[_0x462123(0x26f)](_0x462123(0x267)+_0x13eb8e['id']+_0x462123(0x244)+_0x13eb8e[_0x462123(0x289)]+_0x462123(0x187)+_0x13eb8e['status']+_0x462123(0x1b7)+_0x13eb8e[_0x462123(0x1c4)]);}if(!_0x13eb8e){console[_0x462123(0x1e0)](_0x462123(0x1a2)+_0x32f95b['paymentId']),loggerService_1[_0x462123(0x1c6)][_0x462123(0x19c)](_0x462123(0x241),new Error(_0x462123(0x1d2)+_0x32f95b[_0x462123(0x1c3)]),_0x95f15b);throw new Error(_0x462123(0x19f)+_0x32f95b['paymentId']);}console['log'](_0x462123(0x207)+_0x13eb8e['id']+_0x462123(0x21f)+_0x13eb8e[_0x462123(0x21c)]+_0x462123(0x1f3)+_0x32f95b[_0x462123(0x21c)]+')');const _0x14f9d3={};_0x32f95b[_0x462123(0x232)]&&await database_1[_0x462123(0x1e5)][_0x462123(0x1b0)][_0x462123(0x239)]({'where':{'id':_0x13eb8e['id']},'data':{'amount':_0x32f95b['amount'],'updatedAt':new Date()}}),_0x32f95b[_0x462123(0x1b4)]&&await database_1[_0x462123(0x1e5)][_0x462123(0x1b0)]['update']({'where':{'id':_0x13eb8e['id']},'data':{'currency':_0x32f95b[_0x462123(0x1b4)],'updatedAt':new Date()}}),_0x32f95b['status']==='FAILED'&&_0x32f95b[_0x462123(0x1fe)]&&(_0x14f9d3[_0x462123(0x23e)]=_0x32f95b[_0x462123(0x1fe)],console[_0x462123(0x26f)](_0x462123(0x264)+_0x32f95b[_0x462123(0x1fe)])),_0x14f9d3['paymentMethod']=_0x462123(0x241),await this['updatePaymentStatus'](_0x13eb8e['id'],_0x32f95b['status'],_0x14f9d3),await database_1[_0x462123(0x1e5)][_0x462123(0x28d)][_0x462123(0x1bc)]({'data':{'paymentId':_0x13eb8e['id'],'shopId':_0x13eb8e['shopId'],'event':'visa_'+_0x32f95b[_0x462123(0x21c)][_0x462123(0x18b)](),'statusCode':0xc8,'responseBody':JSON[_0x462123(0x254)](_0x32f95b)}}),await this[_0x462123(0x233)](_0x13eb8e,_0x32f95b[_0x462123(0x21c)][_0x462123(0x220)]()),console[_0x462123(0x26f)](_0x462123(0x24f)+_0x13eb8e['id']);}catch(_0x3cf7e3){console[_0x462123(0x1e0)](_0x462123(0x28a),_0x3cf7e3),loggerService_1[_0x462123(0x1c6)][_0x462123(0x19c)](_0x462123(0x241),_0x3cf7e3,_0x95f15b);throw _0x3cf7e3;}}async[a69_0xa9883(0x1d0)](_0x930273){const _0xe5f506=a69_0xa9883;console[_0xe5f506(0x26f)](_0xe5f506(0x288),JSON[_0xe5f506(0x254)](_0x930273,null,0x2));try{const _0x2a3666=await this['visaMasterCardService'][_0xe5f506(0x1c8)](_0x930273,_0xe5f506(0x173));console['log'](_0xe5f506(0x1ec),_0x2a3666);if(!_0x2a3666['paymentId']){console[_0xe5f506(0x1e0)](_0xe5f506(0x1e7)),console[_0xe5f506(0x1e0)](_0xe5f506(0x283),Object[_0xe5f506(0x243)](_0x930273));throw new Error(_0xe5f506(0x1b6));}let _0x4a5293=null;console[_0xe5f506(0x26f)]('üîç\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x2a3666[_0xe5f506(0x1c3)]);_0x2a3666['paymentId']&&(console[_0xe5f506(0x26f)]('üîç\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x4a5293=await database_1[_0xe5f506(0x1e5)]['payment'][_0xe5f506(0x216)]({'where':{'AND':[{'OR':[{'gateway':_0xe5f506(0x25f)},{'gateway':_0xe5f506(0x17f)},{'gateway':_0xe5f506(0x16c)}]},{'OR':[{'gatewayPaymentId':_0x2a3666['paymentId']},{'gatewayOrderId':_0x2a3666[_0xe5f506(0x1c3)]},{'id':_0x2a3666['paymentId']},{'orderId':_0x2a3666[_0xe5f506(0x1c3)]}]}]}}),console[_0xe5f506(0x26f)](_0xe5f506(0x1be)+(_0x4a5293?_0xe5f506(0x218)+_0x4a5293['id']:_0xe5f506(0x1db))));if(!_0x4a5293){console[_0xe5f506(0x1e0)](_0xe5f506(0x1cc)+_0x2a3666['paymentId']),console[_0xe5f506(0x1e0)]('üîç\x20Searched\x20by:\x20gatewayOrderId=\x22'+_0x2a3666[_0xe5f506(0x1c3)]+_0xe5f506(0x21d)+_0x2a3666[_0xe5f506(0x1c3)]+'\x22,\x20orderId=\x22'+_0x2a3666['paymentId']+'\x22');const _0x44c97e=await database_1[_0xe5f506(0x1e5)]['payment'][_0xe5f506(0x1ff)]({'where':{'OR':[{'gateway':'mastercard'},{'gateway':_0xe5f506(0x25f)},{'gateway':_0xe5f506(0x16c)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0xe5f506(0x252)},'take':0xf});console[_0xe5f506(0x26f)](_0xe5f506(0x261),_0x44c97e),loggerService_1[_0xe5f506(0x1c6)][_0xe5f506(0x19c)]('mastercard',new Error('Payment\x20not\x20found:\x20'+_0x2a3666['paymentId']),_0x930273);throw new Error(_0xe5f506(0x2a9)+_0x2a3666[_0xe5f506(0x1c3)]);}console[_0xe5f506(0x26f)](_0xe5f506(0x27d)+_0x4a5293['id']+_0xe5f506(0x2a2)+_0x4a5293[_0xe5f506(0x21c)]+_0xe5f506(0x1ce)+_0x2a3666[_0xe5f506(0x21c)]);const _0x42fa84={};_0x2a3666['amount']&&await database_1['default'][_0xe5f506(0x1b0)][_0xe5f506(0x239)]({'where':{'id':_0x4a5293['id']},'data':{'amount':_0x2a3666[_0xe5f506(0x232)],'updatedAt':new Date()}}),_0x2a3666[_0xe5f506(0x1b4)]&&await database_1[_0xe5f506(0x1e5)]['payment'][_0xe5f506(0x239)]({'where':{'id':_0x4a5293['id']},'data':{'currency':_0x2a3666['currency'],'updatedAt':new Date()}}),_0x2a3666[_0xe5f506(0x21c)]===_0xe5f506(0x208)&&_0x2a3666[_0xe5f506(0x1fe)]&&(_0x42fa84[_0xe5f506(0x23e)]=_0x2a3666[_0xe5f506(0x1fe)],console[_0xe5f506(0x26f)]('‚ùå\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20'+_0x2a3666[_0xe5f506(0x1fe)])),_0x42fa84[_0xe5f506(0x27e)]=_0xe5f506(0x17f),await this[_0xe5f506(0x1d6)](_0x4a5293['id'],_0x2a3666[_0xe5f506(0x21c)],_0x42fa84),loggerService_1['loggerService']['logWebhookProcessed'](_0xe5f506(0x17f),_0x4a5293['id'],_0x4a5293[_0xe5f506(0x21c)],_0x2a3666[_0xe5f506(0x21c)],_0x930273);}catch(_0x51b638){console['error'](_0xe5f506(0x1e2),_0x51b638),loggerService_1[_0xe5f506(0x1c6)][_0xe5f506(0x19c)](_0xe5f506(0x17f),_0x51b638,_0x930273);throw _0x51b638;}}async[a69_0xa9883(0x23d)](_0x159f92){const _0x174c28=a69_0xa9883;console[_0x174c28(0x26f)](_0x174c28(0x1e6),JSON[_0x174c28(0x254)](_0x159f92,null,0x2));try{const _0x3ba250=await this[_0x174c28(0x195)][_0x174c28(0x1c8)](_0x159f92);console[_0x174c28(0x26f)](_0x174c28(0x221),_0x3ba250);if(!_0x3ba250[_0x174c28(0x1c3)]){console[_0x174c28(0x1e0)](_0x174c28(0x225)),console[_0x174c28(0x1e0)](_0x174c28(0x283),Object[_0x174c28(0x243)](_0x159f92));throw new Error(_0x174c28(0x269));}let _0x506948=null;console[_0x174c28(0x26f)]('üîç\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x3ba250[_0x174c28(0x1c3)]),_0x506948=await database_1['default'][_0x174c28(0x1b0)][_0x174c28(0x216)]({'where':{'AND':[{'gateway':'amer'},{'OR':[{'gatewayPaymentId':_0x3ba250[_0x174c28(0x1c3)]},{'gatewayOrderId':_0x3ba250['paymentId']},{'id':_0x3ba250[_0x174c28(0x1c3)]},{'orderId':_0x3ba250[_0x174c28(0x1c3)]}]}]}}),console[_0x174c28(0x26f)](_0x174c28(0x1be)+(_0x506948?_0x174c28(0x218)+_0x506948['id']:_0x174c28(0x1db)));if(!_0x506948){console[_0x174c28(0x1e0)](_0x174c28(0x227)+_0x3ba250[_0x174c28(0x1c3)]);return;}console[_0x174c28(0x26f)](_0x174c28(0x1fb)+_0x506948['id']+'\x20status\x20'+_0x3ba250['status']),await this['updatePaymentStatus'](_0x506948['id'],_0x3ba250[_0x174c28(0x21c)],{'cardLast4':_0x3ba250[_0x174c28(0x273)]?.[_0x174c28(0x1c4)],'paymentMethod':_0x3ba250[_0x174c28(0x273)]?.[_0x174c28(0x27e)]});}catch(_0x8b520b){console[_0x174c28(0x1e0)](_0x174c28(0x222),_0x8b520b),loggerService_1[_0x174c28(0x1c6)][_0x174c28(0x19c)](_0x174c28(0x1b1),_0x8b520b,_0x159f92);throw _0x8b520b;}}async['processAmPayWebhook'](_0x39dc96){const _0x374e40=a69_0xa9883;console[_0x374e40(0x26f)](_0x374e40(0x250),JSON['stringify'](_0x39dc96,null,0x2));try{const _0x6f1af6=_0x39dc96[_0x374e40(0x21c)],_0x133929=_0x39dc96[_0x374e40(0x25c)],_0x429e22=_0x39dc96[_0x374e40(0x26a)],_0x27694d=_0x39dc96[_0x374e40(0x1d7)],_0x315f20=_0x39dc96['amount'],_0x312f1e=_0x39dc96['currency'],_0xc0feb6=_0x39dc96[_0x374e40(0x177)],_0x19091d=_0x39dc96[_0x374e40(0x253)];if(!_0x133929){console[_0x374e40(0x1e0)](_0x374e40(0x22c));throw new Error(_0x374e40(0x17e));}console[_0x374e40(0x26f)](_0x374e40(0x199),{'status':_0x6f1af6,'clientTransactionId':_0x133929,'systemId':_0x429e22,'paymentMethod':_0x27694d,'amount':_0x315f20,'currency':_0x312f1e,'commission':_0xc0feb6,'statusAdditionInfo':_0x19091d});const _0x1f1b79=await database_1[_0x374e40(0x1e5)]['payment']['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x133929},{'orderId':_0x133929},{'id':_0x133929},{'gatewayPaymentId':_0x133929}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1f1b79){console[_0x374e40(0x1e0)](_0x374e40(0x172)+_0x133929);throw new Error(_0x374e40(0x1d2)+_0x133929);}console[_0x374e40(0x26f)](_0x374e40(0x27d)+_0x1f1b79['id']+_0x374e40(0x282)),console[_0x374e40(0x26f)](_0x374e40(0x29b)+_0x1f1b79[_0x374e40(0x21c)]+_0x374e40(0x1f3)+_0x6f1af6),_0x6f1af6===_0x374e40(0x28b)?(console[_0x374e40(0x26f)]('üîÑ\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED'),await this[_0x374e40(0x1d6)](_0x1f1b79['id'],_0x374e40(0x208)),console[_0x374e40(0x26f)](_0x374e40(0x1bd)+_0x1f1b79['id']+_0x374e40(0x1af)),console['log'](_0x374e40(0x1ad)+(_0x19091d||_0x374e40(0x18a)))):console['log']('‚ÑπÔ∏è\x20AmPay\x20status\x20'+_0x6f1af6+'\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)'),await database_1['default'][_0x374e40(0x28d)]['create']({'data':{'paymentId':_0x1f1b79['id'],'shopId':_0x1f1b79[_0x374e40(0x295)],'event':'ampay_'+(_0x6f1af6?.[_0x374e40(0x18b)]()||_0x374e40(0x188)),'statusCode':0xc8,'responseBody':JSON[_0x374e40(0x254)](_0x39dc96)}}),loggerService_1[_0x374e40(0x1c6)]['logWebhookProcessed'](_0x374e40(0x200),_0x1f1b79['id'],_0x1f1b79[_0x374e40(0x21c)],_0x6f1af6===_0x374e40(0x28b)?_0x374e40(0x208):_0x6f1af6,_0x39dc96);}catch(_0x2f9070){console['error']('‚ùå\x20Error\x20processing\x20AmPay\x20webhook:',_0x2f9070),loggerService_1[_0x374e40(0x1c6)][_0x374e40(0x19c)](_0x374e40(0x200),_0x2f9070,_0x39dc96);throw _0x2f9070;}}async['processAmPayTRYWebhook'](_0x4df4c3){const _0x57fda9=a69_0xa9883;console['log']('üîÑ\x20Processing\x20AmPay\x20TRY\x20webhook:',JSON[_0x57fda9(0x254)](_0x4df4c3,null,0x2));try{const _0x29b906=_0x4df4c3[_0x57fda9(0x21c)],_0x4dc405=_0x4df4c3[_0x57fda9(0x25c)],_0x4541b6=_0x4df4c3[_0x57fda9(0x26a)],_0x55173c=_0x4df4c3[_0x57fda9(0x1d7)],_0x315b76=_0x4df4c3[_0x57fda9(0x232)],_0xb8ad3e=_0x4df4c3['currency'],_0x2e7059=_0x4df4c3['commission'],_0x264b1e=_0x4df4c3['status_addition_info'];if(!_0x4dc405){console[_0x57fda9(0x1e0)]('‚ùå\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook');throw new Error(_0x57fda9(0x1ea));}console[_0x57fda9(0x26f)](_0x57fda9(0x2ab),{'status':_0x29b906,'clientTransactionId':_0x4dc405,'systemId':_0x4541b6,'paymentMethod':_0x55173c,'amount':_0x315b76,'currency':_0xb8ad3e,'commission':_0x2e7059,'statusAdditionInfo':_0x264b1e});const _0x37c2d0=await database_1[_0x57fda9(0x1e5)]['payment'][_0x57fda9(0x216)]({'where':{'OR':[{'gatewayOrderId':_0x4dc405},{'orderId':_0x4dc405},{'id':_0x4dc405},{'gatewayPaymentId':_0x4dc405}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x37c2d0){console[_0x57fda9(0x1e0)]('‚ùå\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20'+_0x4dc405);throw new Error(_0x57fda9(0x1d2)+_0x4dc405);}console[_0x57fda9(0x26f)](_0x57fda9(0x27d)+_0x37c2d0['id']+_0x57fda9(0x171)),console['log'](_0x57fda9(0x29b)+_0x37c2d0[_0x57fda9(0x21c)]+_0x57fda9(0x1f3)+_0x29b906),_0x29b906==='DECLINED'?(console[_0x57fda9(0x26f)](_0x57fda9(0x180)),await this['updatePaymentStatus'](_0x37c2d0['id'],_0x57fda9(0x208)),console[_0x57fda9(0x26f)](_0x57fda9(0x2a7)+_0x37c2d0['id']+_0x57fda9(0x1af)),console[_0x57fda9(0x26f)](_0x57fda9(0x1ad)+(_0x264b1e||_0x57fda9(0x18a)))):console[_0x57fda9(0x26f)](_0x57fda9(0x16d)+_0x29b906+_0x57fda9(0x22e)),await database_1[_0x57fda9(0x1e5)][_0x57fda9(0x28d)][_0x57fda9(0x1bc)]({'data':{'paymentId':_0x37c2d0['id'],'shopId':_0x37c2d0['shopId'],'event':_0x57fda9(0x2af)+(_0x29b906?.[_0x57fda9(0x18b)]()||_0x57fda9(0x188)),'statusCode':0xc8,'responseBody':JSON[_0x57fda9(0x254)](_0x4df4c3)}}),loggerService_1[_0x57fda9(0x1c6)]['logWebhookProcessed'](_0x57fda9(0x29d),_0x37c2d0['id'],_0x37c2d0['status'],_0x29b906===_0x57fda9(0x28b)?_0x57fda9(0x208):_0x29b906,_0x4df4c3);}catch(_0x5a1da5){console['error'](_0x57fda9(0x27c),_0x5a1da5),loggerService_1[_0x57fda9(0x1c6)]['logWebhookError']('ampay_try',_0x5a1da5,_0x4df4c3);throw _0x5a1da5;}}async[a69_0xa9883(0x175)](_0x1b1bf,_0x108c99){const _0x284da9=a69_0xa9883,_0x263ea3=Date[_0x284da9(0x1bf)]();try{const _0x4233b9=_0x1b1bf[_0x284da9(0x16f)],_0x4d4c8c=_0x4233b9['settings'];if(!_0x4d4c8c?.[_0x284da9(0x26e)]){console[_0x284da9(0x26f)](_0x284da9(0x1f6)+_0x4233b9['id']);return;}const _0x14f8f5=_0x108c99==='PAID'?_0x284da9(0x1ae):_0x108c99==='FAILED'?_0x284da9(0x20c):_0x108c99===_0x284da9(0x1df)?_0x284da9(0x20c):_0x108c99===_0x284da9(0x186)?'payment.failed':_0x108c99===_0x284da9(0x20d)?_0x284da9(0x20c):_0x284da9(0x27b);let _0x378652=[];if(_0x4d4c8c['webhookEvents'])try{_0x378652=Array[_0x284da9(0x268)](_0x4d4c8c[_0x284da9(0x1f2)])?_0x4d4c8c['webhookEvents']:JSON['parse'](_0x4d4c8c[_0x284da9(0x1f2)]);}catch(_0x26622e){console[_0x284da9(0x1e0)](_0x284da9(0x1c0),_0x26622e),_0x378652=[];}if(!_0x378652['includes'](_0x14f8f5)){console[_0x284da9(0x26f)](_0x284da9(0x291)+_0x14f8f5+_0x284da9(0x275)+_0x4233b9['id']);return;}const _0x37ce60={'event':_0x14f8f5,'payment':{'id':_0x1b1bf['id'],'order_id':_0x1b1bf[_0x284da9(0x260)],'gateway_order_id':_0x1b1bf[_0x284da9(0x297)],'gateway':_0x1b1bf[_0x284da9(0x289)],'amount':_0x1b1bf[_0x284da9(0x232)],'currency':_0x1b1bf[_0x284da9(0x1b4)],'status':_0x108c99[_0x284da9(0x18b)](),'customer_email':_0x1b1bf[_0x284da9(0x19d)],'customer_name':_0x1b1bf[_0x284da9(0x22d)],'failure_message':_0x1b1bf[_0x284da9(0x23e)],'tx_urls':_0x1b1bf[_0x284da9(0x191)]?JSON[_0x284da9(0x224)](_0x1b1bf['txUrls']):null,'created_at':_0x1b1bf[_0x284da9(0x178)],'updated_at':_0x1b1bf[_0x284da9(0x1e3)]}},_0x5f395c=await fetch(_0x4d4c8c[_0x284da9(0x26e)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x284da9(0x23a)},'body':JSON[_0x284da9(0x254)](_0x37ce60)}),_0x33681c=Date[_0x284da9(0x1bf)]()-_0x263ea3,_0x544796=_0x5f395c['ok']?_0x284da9(0x19b):await _0x5f395c['text']();loggerService_1['loggerService'][_0x284da9(0x1c2)](_0x1b1bf['shopId'],_0x4d4c8c[_0x284da9(0x26e)],_0x14f8f5,_0x5f395c[_0x284da9(0x21c)],_0x33681c,_0x37ce60),console[_0x284da9(0x26f)](_0x284da9(0x23c)+_0x4d4c8c[_0x284da9(0x26e)]+_0x284da9(0x262)+_0x5f395c['status']+'\x20('+_0x33681c+'ms)');}catch(_0x348ebf){console[_0x284da9(0x1e0)](_0x284da9(0x28e),_0x348ebf),loggerService_1[_0x284da9(0x1c6)][_0x284da9(0x228)](_0x1b1bf[_0x284da9(0x295)],_0x1b1bf['shop']?.[_0x284da9(0x293)]?.[_0x284da9(0x26e)]||_0x284da9(0x188),_0x284da9(0x28f),_0x348ebf,{});}}async[a69_0xa9883(0x233)](_0x252d7a,_0x7cab9a){const _0x5ffc20=a69_0xa9883;try{const _0xf35995={'PENDING':_0x5ffc20(0x192),'PROCESSING':_0x5ffc20(0x1ee),'PAID':'paid','FAILED':'failed','EXPIRED':_0x5ffc20(0x248),'REFUND':_0x5ffc20(0x1c9),'CHARGEBACK':_0x5ffc20(0x203)},_0x187ab3=_0xf35995[_0x7cab9a];if(!_0x187ab3||_0x187ab3===_0x5ffc20(0x192))return;await telegramBotService_1[_0x5ffc20(0x1a7)][_0x5ffc20(0x265)](_0x252d7a[_0x5ffc20(0x295)],_0x252d7a,_0x187ab3);}catch(_0x3630b4){console[_0x5ffc20(0x1e0)](_0x5ffc20(0x235),_0x3630b4);}}async['getGatewayCommission'](_0x1ffc22,_0xbeba45){const _0x685ae6=a69_0xa9883;try{const _0x5e4740=await database_1[_0x685ae6(0x1e5)]['shop'][_0x685ae6(0x211)]({'where':{'id':_0x1ffc22},'select':{'gatewaySettings':!![]}});if(!_0x5e4740?.[_0x685ae6(0x24e)])return console[_0x685ae6(0x26f)](_0x685ae6(0x202)+_0x1ffc22+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x4e3587=JSON['parse'](_0x5e4740[_0x685ae6(0x24e)]);for(const [_0x50dd6e,_0x389ca5]of Object[_0x685ae6(0x238)](_0x4e3587)){if(_0x50dd6e[_0x685ae6(0x18b)]()===_0xbeba45['toLowerCase']()){const _0x49f739=_0x389ca5[_0x685ae6(0x177)]||0xa;return console[_0x685ae6(0x26f)](_0x685ae6(0x231)+_0xbeba45+'\x20commission\x20for\x20shop\x20'+_0x1ffc22+':\x20'+_0x49f739+'%'),_0x49f739;}}return console[_0x685ae6(0x26f)](_0x685ae6(0x1dc)+_0xbeba45+'\x20in\x20shop\x20'+_0x1ffc22+_0x685ae6(0x19a)),0xa;}catch(_0x42a9b2){return console[_0x685ae6(0x1e0)](_0x685ae6(0x25a)+_0x1ffc22+',\x20gateway\x20'+_0xbeba45+':',_0x42a9b2),0xa;}}async['processMyXSpendWebhook'](_0x32ec14,_0x469561){const _0x491da8=a69_0xa9883;console[_0x491da8(0x26f)](_0x491da8(0x18f)),console[_0x491da8(0x26f)](_0x491da8(0x21b),JSON[_0x491da8(0x254)](_0x32ec14,null,0x2)),console[_0x491da8(0x26f)](_0x491da8(0x2a8),JSON[_0x491da8(0x254)](_0x469561,null,0x2));try{const _0x379977=_0x32ec14[_0x491da8(0x1e9)]||_0x469561[_0x491da8(0x1e9)],_0xb22857=_0x32ec14[_0x491da8(0x21c)]||_0x469561[_0x491da8(0x21c)],_0x30cfe0=_0x32ec14[_0x491da8(0x232)]||_0x469561[_0x491da8(0x232)],_0x2c3da6=_0x32ec14[_0x491da8(0x1b4)]||_0x469561['currency'],_0x1c96ae=_0x32ec14[_0x491da8(0x20b)]||_0x469561[_0x491da8(0x20b)];if(!_0x379977){console[_0x491da8(0x1e0)](_0x491da8(0x1ac));throw new Error(_0x491da8(0x2a4));}console[_0x491da8(0x26f)](_0x491da8(0x21e),{'customerOrderId':_0x379977,'status':_0xb22857,'amount':_0x30cfe0,'currency':_0x2c3da6,'dateTime':_0x1c96ae});const _0x2ccfaf=await database_1[_0x491da8(0x1e5)][_0x491da8(0x1b0)][_0x491da8(0x216)]({'where':{'OR':[{'gatewayOrderId':_0x379977},{'orderId':_0x379977},{'id':_0x379977},{'gatewayPaymentId':_0x379977}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x2ccfaf){console[_0x491da8(0x1e0)](_0x491da8(0x284)+_0x379977);throw new Error('Payment\x20not\x20found:\x20'+_0x379977);}console['log'](_0x491da8(0x27d)+_0x2ccfaf['id']+'\x20for\x20MyXSpend\x20webhook'),console[_0x491da8(0x26f)](_0x491da8(0x29b)+_0x2ccfaf['status']+_0x491da8(0x1f3)+_0xb22857);let _0x2c40f7=_0xb22857?.[_0x491da8(0x220)]();_0xb22857===_0x491da8(0x208)||_0xb22857===_0x491da8(0x1df)?(_0x2c40f7=_0x491da8(0x208),console[_0x491da8(0x26f)](_0x491da8(0x1f4)+_0xb22857+_0x491da8(0x22a)),await this[_0x491da8(0x1d6)](_0x2ccfaf['id'],_0x2c40f7),console[_0x491da8(0x26f)](_0x491da8(0x271)+_0x2ccfaf['id']+_0x491da8(0x1af))):console[_0x491da8(0x26f)](_0x491da8(0x18d)+_0xb22857+_0x491da8(0x1e1)),await database_1[_0x491da8(0x1e5)][_0x491da8(0x28d)][_0x491da8(0x1bc)]({'data':{'paymentId':_0x2ccfaf['id'],'shopId':_0x2ccfaf[_0x491da8(0x295)],'event':'myxspend_'+(_0xb22857?.[_0x491da8(0x18b)]()||_0x491da8(0x188)),'statusCode':0xc8,'responseBody':JSON['stringify']({'queryParams':_0x32ec14,'bodyData':_0x469561})}}),loggerService_1[_0x491da8(0x1c6)]['logWebhookProcessed'](_0x491da8(0x2a6),_0x2ccfaf['id'],_0x2ccfaf[_0x491da8(0x21c)],_0x2c40f7||_0xb22857,{'queryParams':_0x32ec14,'bodyData':_0x469561});}catch(_0x1fde2){console['error']('‚ùå\x20Error\x20processing\x20MyXSpend\x20webhook:',_0x1fde2),loggerService_1[_0x491da8(0x1c6)][_0x491da8(0x19c)]('myxspend',_0x1fde2,{'queryParams':_0x32ec14,'bodyData':_0x469561});throw _0x1fde2;}}}exports['WebhookService']=WebhookService;