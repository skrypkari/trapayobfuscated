'use strict';const a58_0x285ef7=a58_0x1313;(function(_0x2355dd,_0x3c067c){const _0x4d9a80=a58_0x1313,_0x5b4255=_0x2355dd();while(!![]){try{const _0x20ee2b=-parseInt(_0x4d9a80(0x208))/0x1+parseInt(_0x4d9a80(0x269))/0x2*(-parseInt(_0x4d9a80(0x1e1))/0x3)+parseInt(_0x4d9a80(0x1ec))/0x4+parseInt(_0x4d9a80(0x253))/0x5+parseInt(_0x4d9a80(0x1df))/0x6+-parseInt(_0x4d9a80(0x1fb))/0x7+parseInt(_0x4d9a80(0x263))/0x8;if(_0x20ee2b===_0x3c067c)break;else _0x5b4255['push'](_0x5b4255['shift']());}catch(_0x4f6092){_0x5b4255['push'](_0x5b4255['shift']());}}}(a58_0xd20e,0x65b0a));var __importDefault=this&&this[a58_0x285ef7(0x202)]||function(_0x3a4926){const _0x5402dd=a58_0x285ef7;return _0x3a4926&&_0x3a4926[_0x5402dd(0x273)]?_0x3a4926:{'default':_0x3a4926};};function a58_0xd20e(){const _0x4a73b0=['PAID','./currencyService','\x20current\x20balance:\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','webhook_status_change_','✅\x20Payment\x20link\x20','📊\x20Noda\x20webhook:\x20Payment\x20','nodaService','txUrls','isArray','\x20updated:\x20currentPayments=','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','paymentLink','📊\x20MasterCard\x20webhook\x20result:','\x20-\x20','updatePaymentStatus','paymentMethod','payment','webhookEvents','📊\x20CoinToPay2\x20webhook:\x20Payment\x20',',\x20currentPayments=','Webhook\x20event\x20','Found\x20payment\x20','customerName','\x20status\x20','\x20USDT\x20(payment\x20became\x20PAID)','update','expired','\x20USDT','2042460bTMbxa','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','7731wrsrxE','updatedAt','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','📝\x20Reason:\x20','chargebackAmount','❌\x20Available\x20webhook\x20fields:','remitterName','$transaction','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','settings','paid','2373580futijw','plisioService','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','coinToPay2Service','chargeback','\x20with\x20status\x20','\x22,\x20id=\x22','klyme','cointopay','currency','./gateways/klymeService','klymeService','findFirst','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','📈\x20Payment\x20details:\x20oldStatus=\x22','2759855QInTTn','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','📊\x20Plisio\x20webhook:\x20Payment\x20','masterCardService','Error\x20processing\x20Plisio\x20webhook:','\x20and\x20-','cointopay2','__importDefault','Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','webhookLog','280205MqdbZy','toLowerCase','Error\x20processing\x20Rapyd\x20webhook:','logShopWebhookError','keys','🔄\x20Processing\x20KLYME\x20webhook:','findMany','\x20to\x20','Error\x20processing\x20CoinToPay2\x20webhook:','❌\x20Payment\x20link\x20','paymentLinkId','🔄\x20Processing\x20Plisio\x20webhook:','includes','type','./gateways/rapydService','remitterIban','📈\x20Found\x20payment\x20link\x20','💰\x20Converting\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','now','\x20not\x20found','✅\x20Found\x20payment\x20','✅\x20Shop\x20',',\x20status=','FAILED','system','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','processKlymeWebhook','coinToPayService','📊\x20KLYME\x20webhook:\x20Payment\x20','ms)','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','\x20->\x20','mastercard','🔍\x20Search\x20result:\x20','additionalInfo','💰\x20Payment\x20','🔄\x20Processing\x20MasterCard\x20webhook:','parse','💸\x20Additional\x20chargeback\x20penalty:\x20-','balance','currencyService','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','orderId','../config/database','Error\x20processing\x20KLYME\x20webhook:','Payment\x20not\x20found','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','processing','\x20USDT\x20(chargeback\x20penalty)','Success','\x20balance\x20updated:\x20','Error\x20processing\x20Noda\x20webhook:','refund','\x22,\x20newStatus=\x22','\x20=\x20','no\x20balance\x20change','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','stringify','failureMessage','shopId','WebhookService','MasterCardService','gateway','payment.failed','CoinToPay2Service','./gateways/nodaService','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','CHARGEBACK','plisio_gateway','plisio','create','logWebhookProcessed','💰\x20Adding\x20to\x20balance:\x20','863080iHecIV','currentPayments','application/json','toFixed','rapydService','convertToUSDT','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','NodaService','logWebhookError','🏪\x20Shop\x20','RapydService','toUpperCase','processCoinToPay2Webhook','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','💰\x20Final\x20balance\x20after\x20chargeback:\x20','🔄\x20Processing\x20Noda\x20webhook:','2391720huZOgB','paidAt','./loggerService','webhookUrl','amountUSDT','📤\x20Shop\x20webhook\x20sent\x20to\x20','244yoghgn','Failed\x20to\x20send\x20shop\x20webhook:','sendPaymentNotification','./gateways/plisioService','\x20not\x20enabled\x20for\x20shop\x20','toISOString','log','logShopWebhookSent','\x20+\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook','__esModule','unknown','COMPLETED','EXPIRED','cardLast4','🔄\x20Processing\x20Rapyd\x20webhook:','processWebhook','loggerService','username','🔄\x20Processing\x20CoinToPay\x20webhook:','noda','findUnique','📊\x20CoinToPay\x20webhook:\x20Payment\x20','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','POST','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','amount','shop','createdAt','paymentId','KlymeService','sendPaymentStatusNotification','❌\x20Error\x20processing\x20MasterCard\x20webhook:','processRapydWebhook','sendShopWebhook','default','rapyd','📈\x20Payment\x20','\x22,\x20orderId=\x22','failed','processPlisioGatewayWebhook','error','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','📊\x20Rapyd\x20webhook:\x20Payment\x20','payment.pending','status','bankId','text','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','defineProperty','SINGLE','🔄\x20Additional\x20data:'];a58_0xd20e=function(){return _0x4a73b0;};return a58_0xd20e();}Object[a58_0x285ef7(0x29a)](exports,'__esModule',{'value':!![]}),exports[a58_0x285ef7(0x246)]=void 0x0;const database_1=__importDefault(require(a58_0x285ef7(0x234))),plisioService_1=require(a58_0x285ef7(0x26c)),rapydService_1=require(a58_0x285ef7(0x216)),nodaService_1=require(a58_0x285ef7(0x24b)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require(a58_0x285ef7(0x1f6)),mastercardService_1=require('./gateways/mastercardService'),telegramBotService_1=require('./telegramBotService'),currencyService_1=require(a58_0x285ef7(0x29e)),loggerService_1=require(a58_0x285ef7(0x265));class WebhookService{constructor(){const _0x4627d3=a58_0x285ef7;this['plisioService']=new plisioService_1['PlisioService'](),this[_0x4627d3(0x257)]=new rapydService_1[(_0x4627d3(0x25d))](),this['nodaService']=new nodaService_1[(_0x4627d3(0x25a))](),this[_0x4627d3(0x224)]=new coinToPayService_1['CoinToPayService'](),this[_0x4627d3(0x1ef)]=new coinToPay2Service_1[(_0x4627d3(0x24a))](),this[_0x4627d3(0x1f7)]=new klymeService_1[(_0x4627d3(0x287))](),this['masterCardService']=new mastercardService_1[(_0x4627d3(0x247))]();}async['updatePaymentStatus'](_0x5cc4a7,_0x14c87f,_0x4f62ad){const _0x53f680=a58_0x285ef7;console[_0x53f680(0x26f)](_0x53f680(0x222)+_0x5cc4a7+',\x20newStatus='+_0x14c87f),console['log'](_0x53f680(0x29c),_0x4f62ad),await database_1[_0x53f680(0x28c)][_0x53f680(0x1e8)](async _0x250935=>{const _0x6ab68=_0x53f680,_0x5db067=await _0x250935[_0x6ab68(0x1d3)][_0x6ab68(0x27e)]({'where':{'id':_0x5cc4a7},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5db067)throw new Error(_0x6ab68(0x203)+_0x5cc4a7+_0x6ab68(0x21c));const _0x4daa11=_0x5db067[_0x6ab68(0x296)],_0x3b1655=_0x5db067[_0x6ab68(0x284)];console['log'](_0x6ab68(0x22c)+_0x5cc4a7+':\x20'+_0x4daa11+'\x20->\x20'+_0x14c87f),console[_0x6ab68(0x26f)](_0x6ab68(0x25c)+_0x3b1655[_0x6ab68(0x27b)]+_0x6ab68(0x29f)+_0x3b1655[_0x6ab68(0x230)]+_0x6ab68(0x1de));const _0x4fe8db={'status':_0x14c87f[_0x6ab68(0x25e)](),'updatedAt':new Date(),'statusChangedBy':_0x6ab68(0x221),'statusChangedAt':new Date()};_0x4f62ad?.[_0x6ab68(0x244)]&&(_0x4fe8db[_0x6ab68(0x244)]=_0x4f62ad['failureMessage']);_0x4f62ad?.['txUrls']&&(_0x4fe8db[_0x6ab68(0x2a5)]=JSON[_0x6ab68(0x243)](_0x4f62ad[_0x6ab68(0x2a5)]));_0x4f62ad?.[_0x6ab68(0x277)]&&(_0x4fe8db[_0x6ab68(0x277)]=_0x4f62ad['cardLast4']);_0x4f62ad?.['paymentMethod']&&(_0x4fe8db[_0x6ab68(0x1d2)]=_0x4f62ad[_0x6ab68(0x1d2)]);_0x4f62ad?.[_0x6ab68(0x297)]&&(_0x4fe8db[_0x6ab68(0x297)]=_0x4f62ad[_0x6ab68(0x297)]);_0x4f62ad?.[_0x6ab68(0x217)]&&(_0x4fe8db[_0x6ab68(0x217)]=_0x4f62ad['remitterIban']);_0x4f62ad?.[_0x6ab68(0x1e7)]&&(_0x4fe8db[_0x6ab68(0x1e7)]=_0x4f62ad[_0x6ab68(0x1e7)]);let _0x5e2042=_0x3b1655[_0x6ab68(0x230)],_0x33ea65='';if(_0x14c87f[_0x6ab68(0x25e)]()==='PAID'&&_0x4daa11!==_0x6ab68(0x29d)){const _0xa7b1a8=await currencyService_1[_0x6ab68(0x231)][_0x6ab68(0x258)](_0x5db067[_0x6ab68(0x283)],_0x5db067[_0x6ab68(0x1f5)]);_0x5e2042+=_0xa7b1a8,_0x33ea65='+'+_0xa7b1a8[_0x6ab68(0x256)](0x6)+_0x6ab68(0x1db),_0x4fe8db['amountUSDT']=_0xa7b1a8,_0x4fe8db[_0x6ab68(0x264)]=new Date(),console['log'](_0x6ab68(0x219)+_0x5db067[_0x6ab68(0x283)]+'\x20'+_0x5db067[_0x6ab68(0x1f5)]+_0x6ab68(0x228)+_0xa7b1a8[_0x6ab68(0x256)](0x6)+_0x6ab68(0x1de)),console[_0x6ab68(0x26f)](_0x6ab68(0x252)+_0x3b1655['balance']+_0x6ab68(0x271)+_0xa7b1a8[_0x6ab68(0x256)](0x6)+_0x6ab68(0x240)+_0x5e2042[_0x6ab68(0x256)](0x6)+_0x6ab68(0x1de));}else{if(_0x4daa11===_0x6ab68(0x29d)&&_0x14c87f['toUpperCase']()!=='PAID'){const _0x3a87e0=_0x5db067[_0x6ab68(0x267)];_0x3a87e0&&(_0x5e2042-=_0x3a87e0,_0x33ea65='-'+_0x3a87e0['toFixed'](0x6)+_0x6ab68(0x1e3),_0x4fe8db['amountUSDT']=null,_0x4fe8db[_0x6ab68(0x264)]=null,console[_0x6ab68(0x26f)]('💰\x20Removing\x20from\x20balance:\x20'+_0x3b1655['balance']+_0x6ab68(0x1d0)+_0x3a87e0[_0x6ab68(0x256)](0x6)+'\x20=\x20'+_0x5e2042[_0x6ab68(0x256)](0x6)+_0x6ab68(0x1de)));}}if(_0x14c87f['toUpperCase']()===_0x6ab68(0x24d)){const _0x34dac0=_0x4f62ad?.['chargebackAmount']||0x0;_0x34dac0>0x0&&(_0x5e2042-=_0x34dac0,_0x33ea65+=_0x6ab68(0x200)+_0x34dac0[_0x6ab68(0x256)](0x6)+_0x6ab68(0x23a),_0x4fe8db[_0x6ab68(0x1e5)]=_0x34dac0,console[_0x6ab68(0x26f)](_0x6ab68(0x22f)+_0x34dac0[_0x6ab68(0x256)](0x6)+_0x6ab68(0x1de)),console['log'](_0x6ab68(0x261)+_0x5e2042[_0x6ab68(0x256)](0x6)+'\x20USDT'));}const _0x3eff0a=await _0x250935[_0x6ab68(0x1d3)]['update']({'where':{'id':_0x5cc4a7},'data':_0x4fe8db});_0x5e2042!==_0x3b1655[_0x6ab68(0x230)]&&(await _0x250935[_0x6ab68(0x284)][_0x6ab68(0x1dc)]({'where':{'id':_0x3b1655['id']},'data':{'balance':_0x5e2042}}),console[_0x6ab68(0x26f)](_0x6ab68(0x21e)+_0x3b1655['username']+_0x6ab68(0x23c)+_0x3b1655[_0x6ab68(0x230)]['toFixed'](0x6)+_0x6ab68(0x228)+_0x5e2042[_0x6ab68(0x256)](0x6)+_0x6ab68(0x1de)),console[_0x6ab68(0x26f)](_0x6ab68(0x1e4)+_0x33ea65));await _0x250935[_0x6ab68(0x207)][_0x6ab68(0x250)]({'data':{'paymentId':_0x5cc4a7,'shopId':_0x3b1655['id'],'event':_0x6ab68(0x2a1)+_0x14c87f[_0x6ab68(0x209)](),'statusCode':0xc8,'responseBody':JSON[_0x6ab68(0x243)]({'oldStatus':_0x4daa11,'newStatus':_0x14c87f[_0x6ab68(0x25e)](),'balanceChange':_0x33ea65||_0x6ab68(0x241),'oldBalance':_0x3b1655['balance'],'newBalance':_0x5e2042,'amountUSDT':_0x4fe8db['amountUSDT'],'additionalData':_0x4f62ad,'timestamp':new Date()[_0x6ab68(0x26e)]()})}}),await this[_0x6ab68(0x28b)]({..._0x5db067,..._0x3eff0a,'shop':_0x3b1655},_0x14c87f[_0x6ab68(0x25e)]()),await this[_0x6ab68(0x288)]({..._0x5db067,..._0x3eff0a},_0x14c87f['toUpperCase']());if(_0x4daa11!=='PAID'&&_0x14c87f['toUpperCase']()===_0x6ab68(0x29d)){console['log'](_0x6ab68(0x28e)+_0x5cc4a7+_0x6ab68(0x1ee)),console[_0x6ab68(0x26f)](_0x6ab68(0x1fa)+_0x4daa11+_0x6ab68(0x23f)+_0x14c87f['toUpperCase']()+'\x22,\x20paymentLinkId=\x22'+_0x5db067[_0x6ab68(0x212)]+'\x22');if(_0x5db067[_0x6ab68(0x212)])try{const _0x5ce1f7=await _0x250935[_0x6ab68(0x2aa)][_0x6ab68(0x27e)]({'where':{'id':_0x5db067[_0x6ab68(0x212)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5ce1f7){console[_0x6ab68(0x26f)](_0x6ab68(0x218)+_0x5ce1f7['id']+':\x20type='+_0x5ce1f7[_0x6ab68(0x215)]+_0x6ab68(0x1d6)+_0x5ce1f7[_0x6ab68(0x254)]+_0x6ab68(0x21f)+_0x5ce1f7[_0x6ab68(0x296)]);const _0x4cf65c=_0x5ce1f7[_0x6ab68(0x254)]+0x1,_0x1995cb=_0x5ce1f7['type']===_0x6ab68(0x29b)?_0x6ab68(0x275):_0x5ce1f7[_0x6ab68(0x296)];await _0x250935[_0x6ab68(0x2aa)][_0x6ab68(0x1dc)]({'where':{'id':_0x5db067[_0x6ab68(0x212)]},'data':{'currentPayments':_0x4cf65c,'status':_0x1995cb,'updatedAt':new Date()}}),console['log'](_0x6ab68(0x2a2)+_0x5ce1f7['id']+_0x6ab68(0x2a7)+_0x5ce1f7[_0x6ab68(0x254)]+_0x6ab68(0x228)+_0x4cf65c+_0x6ab68(0x21f)+_0x5ce1f7[_0x6ab68(0x296)]+_0x6ab68(0x228)+_0x1995cb);}else console[_0x6ab68(0x26f)](_0x6ab68(0x211)+_0x5db067[_0x6ab68(0x212)]+_0x6ab68(0x21c));}catch(_0x2c0611){console[_0x6ab68(0x292)](_0x6ab68(0x21a),_0x2c0611);}else console[_0x6ab68(0x26f)](_0x6ab68(0x28e)+_0x5cc4a7+_0x6ab68(0x227));}else console[_0x6ab68(0x26f)](_0x6ab68(0x28e)+_0x5cc4a7+_0x6ab68(0x2a8)+_0x4daa11+'\x20->\x20'+_0x14c87f[_0x6ab68(0x25e)]());});}async['processPlisioWebhook'](_0xd2c6a4){const _0x2fbeaf=a58_0x285ef7;console['log'](_0x2fbeaf(0x213),_0xd2c6a4);try{const _0xb97812=await this[_0x2fbeaf(0x1ed)][_0x2fbeaf(0x279)](_0xd2c6a4);if(!_0xb97812[_0x2fbeaf(0x286)])throw new Error(_0x2fbeaf(0x206));const _0x5d2389=await database_1[_0x2fbeaf(0x28c)][_0x2fbeaf(0x1d3)][_0x2fbeaf(0x1f8)]({'where':{'gatewayOrderId':_0xb97812[_0x2fbeaf(0x286)]}});if(!_0x5d2389){console[_0x2fbeaf(0x292)](_0x2fbeaf(0x242)+_0xb97812[_0x2fbeaf(0x286)]);return;}console[_0x2fbeaf(0x26f)](_0x2fbeaf(0x1fd)+_0x5d2389['id']+_0x2fbeaf(0x1da)+_0xb97812[_0x2fbeaf(0x296)]),await this['updatePaymentStatus'](_0x5d2389['id'],_0xb97812[_0x2fbeaf(0x296)],{'txUrls':_0xb97812[_0x2fbeaf(0x2a5)]}),loggerService_1[_0x2fbeaf(0x27a)][_0x2fbeaf(0x251)](_0x2fbeaf(0x24f),_0x5d2389['id'],_0x5d2389[_0x2fbeaf(0x296)],_0xb97812[_0x2fbeaf(0x296)],_0xd2c6a4);}catch(_0x4061be){console[_0x2fbeaf(0x292)](_0x2fbeaf(0x1ff),_0x4061be),loggerService_1[_0x2fbeaf(0x27a)][_0x2fbeaf(0x25b)](_0x2fbeaf(0x24f),_0x4061be,_0xd2c6a4);throw _0x4061be;}}async[a58_0x285ef7(0x291)](_0x3adc22){const _0x17c4c1=a58_0x285ef7;console[_0x17c4c1(0x26f)]('🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:',_0x3adc22);try{const _0x456e8c=await this['plisioService']['processWebhook'](_0x3adc22);if(!_0x456e8c[_0x17c4c1(0x286)])throw new Error(_0x17c4c1(0x260));const _0x437fe7=await database_1[_0x17c4c1(0x28c)]['payment'][_0x17c4c1(0x1f8)]({'where':{'gatewayOrderId':_0x456e8c[_0x17c4c1(0x286)]}});if(!_0x437fe7){console[_0x17c4c1(0x292)](_0x17c4c1(0x232)+_0x456e8c[_0x17c4c1(0x286)]);return;}console['log']('📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20'+_0x437fe7['id']+_0x17c4c1(0x1da)+_0x456e8c[_0x17c4c1(0x296)]),await this[_0x17c4c1(0x1d1)](_0x437fe7['id'],_0x456e8c[_0x17c4c1(0x296)],{'txUrls':_0x456e8c['txUrls']}),loggerService_1['loggerService'][_0x17c4c1(0x251)]('plisio_gateway',_0x437fe7['id'],_0x437fe7[_0x17c4c1(0x296)],_0x456e8c['status'],_0x3adc22);}catch(_0x3acb6b){console[_0x17c4c1(0x292)](_0x17c4c1(0x1f9),_0x3acb6b),loggerService_1['loggerService'][_0x17c4c1(0x25b)](_0x17c4c1(0x24e),_0x3acb6b,_0x3adc22);throw _0x3acb6b;}}async[a58_0x285ef7(0x28a)](_0x534958){const _0x2e902b=a58_0x285ef7;console[_0x2e902b(0x26f)](_0x2e902b(0x278),_0x534958);try{const _0x37262c=await this['rapydService'][_0x2e902b(0x279)](_0x534958);if(!_0x37262c[_0x2e902b(0x286)])throw new Error(_0x2e902b(0x24c));const _0x2283b0=await database_1[_0x2e902b(0x28c)][_0x2e902b(0x1d3)][_0x2e902b(0x1f8)]({'where':{'gatewayOrderId':_0x37262c[_0x2e902b(0x286)]}});if(!_0x2283b0){console['error'](_0x2e902b(0x1e0)+_0x37262c[_0x2e902b(0x286)]);return;}console[_0x2e902b(0x26f)](_0x2e902b(0x294)+_0x2283b0['id']+_0x2e902b(0x1da)+_0x37262c[_0x2e902b(0x296)]),await this[_0x2e902b(0x1d1)](_0x2283b0['id'],_0x37262c[_0x2e902b(0x296)],{'failureMessage':_0x37262c[_0x2e902b(0x244)],'cardLast4':_0x37262c[_0x2e902b(0x22b)]?.[_0x2e902b(0x277)],'paymentMethod':_0x37262c[_0x2e902b(0x22b)]?.[_0x2e902b(0x1d2)]}),loggerService_1[_0x2e902b(0x27a)][_0x2e902b(0x251)](_0x2e902b(0x28d),_0x2283b0['id'],_0x2283b0[_0x2e902b(0x296)],_0x37262c['status'],_0x534958);}catch(_0x2f6db3){console[_0x2e902b(0x292)](_0x2e902b(0x20a),_0x2f6db3),loggerService_1[_0x2e902b(0x27a)][_0x2e902b(0x25b)](_0x2e902b(0x28d),_0x2f6db3,_0x534958);throw _0x2f6db3;}}async['processNodaWebhook'](_0x24f620){const _0x33a9b7=a58_0x285ef7;console['log'](_0x33a9b7(0x262),_0x24f620);try{const _0x40512a=await this[_0x33a9b7(0x2a4)][_0x33a9b7(0x279)](_0x24f620);if(!_0x40512a[_0x33a9b7(0x286)])throw new Error(_0x33a9b7(0x272));const _0x3ba6fd=await database_1['default'][_0x33a9b7(0x1d3)]['findFirst']({'where':{'gatewayOrderId':_0x40512a[_0x33a9b7(0x286)]}});if(!_0x3ba6fd){console[_0x33a9b7(0x292)](_0x33a9b7(0x238)+_0x40512a[_0x33a9b7(0x286)]);return;}console[_0x33a9b7(0x26f)](_0x33a9b7(0x2a3)+_0x3ba6fd['id']+_0x33a9b7(0x1da)+_0x40512a[_0x33a9b7(0x296)]),await this[_0x33a9b7(0x1d1)](_0x3ba6fd['id'],_0x40512a[_0x33a9b7(0x296)],{'bankId':_0x40512a[_0x33a9b7(0x22b)]?.[_0x33a9b7(0x297)],'remitterIban':_0x40512a[_0x33a9b7(0x22b)]?.[_0x33a9b7(0x217)],'remitterName':_0x40512a[_0x33a9b7(0x22b)]?.['remitterName']}),loggerService_1['loggerService']['logWebhookProcessed'](_0x33a9b7(0x27d),_0x3ba6fd['id'],_0x3ba6fd['status'],_0x40512a['status'],_0x24f620);}catch(_0x599526){console['error'](_0x33a9b7(0x23d),_0x599526),loggerService_1[_0x33a9b7(0x27a)][_0x33a9b7(0x25b)](_0x33a9b7(0x27d),_0x599526,_0x24f620);throw _0x599526;}}async['processCoinToPayWebhook'](_0x4a2d89){const _0x6617bf=a58_0x285ef7;console[_0x6617bf(0x26f)](_0x6617bf(0x27c),_0x4a2d89);try{const _0x245c95=await this[_0x6617bf(0x224)]['processWebhook'](_0x4a2d89);if(!_0x245c95[_0x6617bf(0x286)])throw new Error(_0x6617bf(0x280));const _0x430d21=await database_1['default'][_0x6617bf(0x1d3)]['findFirst']({'where':{'gatewayOrderId':_0x245c95[_0x6617bf(0x286)]}});if(!_0x430d21){console[_0x6617bf(0x292)](_0x6617bf(0x1fc)+_0x245c95[_0x6617bf(0x286)]);return;}console[_0x6617bf(0x26f)](_0x6617bf(0x27f)+_0x430d21['id']+_0x6617bf(0x1da)+_0x245c95[_0x6617bf(0x296)]),await this[_0x6617bf(0x1d1)](_0x430d21['id'],_0x245c95[_0x6617bf(0x296)]),loggerService_1['loggerService']['logWebhookProcessed'](_0x6617bf(0x1f4),_0x430d21['id'],_0x430d21[_0x6617bf(0x296)],_0x245c95[_0x6617bf(0x296)],_0x4a2d89);}catch(_0xfb1ba6){console[_0x6617bf(0x292)]('Error\x20processing\x20CoinToPay\x20webhook:',_0xfb1ba6),loggerService_1[_0x6617bf(0x27a)]['logWebhookError'](_0x6617bf(0x1f4),_0xfb1ba6,_0x4a2d89);throw _0xfb1ba6;}}async[a58_0x285ef7(0x25f)](_0x1c5abf){const _0x443c9f=a58_0x285ef7;console[_0x443c9f(0x26f)]('🔄\x20Processing\x20CoinToPay2\x20webhook:',_0x1c5abf);try{const _0x340a94=await this[_0x443c9f(0x1ef)][_0x443c9f(0x279)](_0x1c5abf);if(!_0x340a94['paymentId'])throw new Error(_0x443c9f(0x2a0));const _0x235e70=await database_1[_0x443c9f(0x28c)][_0x443c9f(0x1d3)][_0x443c9f(0x1f8)]({'where':{'gatewayOrderId':_0x340a94[_0x443c9f(0x286)]}});if(!_0x235e70){console[_0x443c9f(0x292)](_0x443c9f(0x237)+_0x340a94['paymentId']);return;}console[_0x443c9f(0x26f)](_0x443c9f(0x1d5)+_0x235e70['id']+_0x443c9f(0x1da)+_0x340a94[_0x443c9f(0x296)]),await this[_0x443c9f(0x1d1)](_0x235e70['id'],_0x340a94[_0x443c9f(0x296)]),loggerService_1[_0x443c9f(0x27a)][_0x443c9f(0x251)](_0x443c9f(0x201),_0x235e70['id'],_0x235e70[_0x443c9f(0x296)],_0x340a94[_0x443c9f(0x296)],_0x1c5abf);}catch(_0x3abe05){console['error'](_0x443c9f(0x210),_0x3abe05),loggerService_1['loggerService'][_0x443c9f(0x25b)]('cointopay2',_0x3abe05,_0x1c5abf);throw _0x3abe05;}}async[a58_0x285ef7(0x223)](_0x1480c5){const _0x186bf2=a58_0x285ef7;console[_0x186bf2(0x26f)](_0x186bf2(0x20d),_0x1480c5);try{const _0xf10de4=await this[_0x186bf2(0x1f7)][_0x186bf2(0x279)](_0x1480c5);if(!_0xf10de4[_0x186bf2(0x286)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x5541fb=await database_1[_0x186bf2(0x28c)][_0x186bf2(0x1d3)][_0x186bf2(0x1f8)]({'where':{'gatewayOrderId':_0xf10de4[_0x186bf2(0x286)]}});if(!_0x5541fb){console[_0x186bf2(0x292)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0xf10de4[_0x186bf2(0x286)]);return;}console[_0x186bf2(0x26f)](_0x186bf2(0x225)+_0x5541fb['id']+'\x20status\x20'+_0xf10de4[_0x186bf2(0x296)]),await this[_0x186bf2(0x1d1)](_0x5541fb['id'],_0xf10de4[_0x186bf2(0x296)],{'paymentMethod':_0xf10de4[_0x186bf2(0x22b)]?.['payment_method']}),loggerService_1[_0x186bf2(0x27a)][_0x186bf2(0x251)](_0x186bf2(0x1f3),_0x5541fb['id'],_0x5541fb[_0x186bf2(0x296)],_0xf10de4['status'],_0x1480c5);}catch(_0x8cd12e){console['error'](_0x186bf2(0x235),_0x8cd12e),loggerService_1['loggerService'][_0x186bf2(0x25b)](_0x186bf2(0x1f3),_0x8cd12e,_0x1480c5);throw _0x8cd12e;}}async['processMasterCardWebhook'](_0xc792b3){const _0x374f3c=a58_0x285ef7;console[_0x374f3c(0x26f)](_0x374f3c(0x22d),JSON['stringify'](_0xc792b3,null,0x2));try{const _0x4a1c6a=await this[_0x374f3c(0x1fe)][_0x374f3c(0x279)](_0xc792b3);console[_0x374f3c(0x26f)](_0x374f3c(0x2ab),_0x4a1c6a);if(!_0x4a1c6a[_0x374f3c(0x286)]){console['error'](_0x374f3c(0x259)),console[_0x374f3c(0x292)](_0x374f3c(0x1e6),Object[_0x374f3c(0x20c)](_0xc792b3));throw new Error(_0x374f3c(0x299));}let _0x58f81f=null;console[_0x374f3c(0x26f)](_0x374f3c(0x205)+_0x4a1c6a[_0x374f3c(0x286)]);_0x4a1c6a['paymentId']&&(console['log'](_0x374f3c(0x2a9)),_0x58f81f=await database_1['default'][_0x374f3c(0x1d3)][_0x374f3c(0x1f8)]({'where':{'AND':[{'gateway':'mastercard'},{'OR':[{'gatewayPaymentId':_0x4a1c6a[_0x374f3c(0x286)]},{'gatewayOrderId':_0x4a1c6a['paymentId']},{'id':_0x4a1c6a[_0x374f3c(0x286)]},{'orderId':_0x4a1c6a[_0x374f3c(0x286)]}]}]}}),console[_0x374f3c(0x26f)](_0x374f3c(0x22a)+(_0x58f81f?_0x374f3c(0x1d8)+_0x58f81f['id']:_0x374f3c(0x236))));if(!_0x58f81f){console[_0x374f3c(0x292)]('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x4a1c6a['paymentId']),console['error'](_0x374f3c(0x293)+_0x4a1c6a[_0x374f3c(0x286)]+_0x374f3c(0x1f2)+_0x4a1c6a[_0x374f3c(0x286)]+_0x374f3c(0x28f)+_0x4a1c6a[_0x374f3c(0x286)]+'\x22');const _0x1870b0=await database_1['default'][_0x374f3c(0x1d3)][_0x374f3c(0x20e)]({'where':{'gateway':_0x374f3c(0x229)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x374f3c(0x26f)](_0x374f3c(0x282),_0x1870b0);return;}console[_0x374f3c(0x26f)](_0x374f3c(0x21d)+_0x58f81f['id']+_0x374f3c(0x1e9)+_0x58f81f[_0x374f3c(0x296)]+_0x374f3c(0x20f)+_0x4a1c6a[_0x374f3c(0x296)]),await this['updatePaymentStatus'](_0x58f81f['id'],_0x4a1c6a[_0x374f3c(0x296)]),loggerService_1[_0x374f3c(0x27a)][_0x374f3c(0x251)](_0x374f3c(0x229),_0x58f81f['id'],_0x58f81f[_0x374f3c(0x296)],_0x4a1c6a[_0x374f3c(0x296)],_0xc792b3);}catch(_0x8d4a9a){console[_0x374f3c(0x292)](_0x374f3c(0x289),_0x8d4a9a),loggerService_1['loggerService']['logWebhookError'](_0x374f3c(0x229),_0x8d4a9a,_0xc792b3);throw _0x8d4a9a;}}async['sendShopWebhook'](_0x3cd8b3,_0x418ba6){const _0x5ad819=a58_0x285ef7,_0x189f4c=Date[_0x5ad819(0x21b)]();try{const _0x3c5463=_0x3cd8b3[_0x5ad819(0x284)],_0x10eaf0=_0x3c5463['settings'];if(!_0x10eaf0?.['webhookUrl']){console[_0x5ad819(0x26f)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3c5463['id']);return;}const _0x38ef5d=_0x418ba6===_0x5ad819(0x29d)?'payment.success':_0x418ba6===_0x5ad819(0x220)?'payment.failed':_0x418ba6===_0x5ad819(0x276)?_0x5ad819(0x249):_0x418ba6===_0x5ad819(0x24d)?_0x5ad819(0x249):_0x418ba6==='REFUND'?'payment.failed':_0x5ad819(0x295);let _0x3a802f=[];if(_0x10eaf0[_0x5ad819(0x1d4)])try{_0x3a802f=Array[_0x5ad819(0x2a6)](_0x10eaf0['webhookEvents'])?_0x10eaf0[_0x5ad819(0x1d4)]:JSON['parse'](_0x10eaf0[_0x5ad819(0x1d4)]);}catch(_0x51305f){console['error']('Error\x20parsing\x20webhook\x20events:',_0x51305f),_0x3a802f=[];}if(!_0x3a802f[_0x5ad819(0x214)](_0x38ef5d)){console['log'](_0x5ad819(0x1d7)+_0x38ef5d+_0x5ad819(0x26d)+_0x3c5463['id']);return;}const _0x5d5f43={'event':_0x38ef5d,'payment':{'id':_0x3cd8b3['id'],'order_id':_0x3cd8b3[_0x5ad819(0x233)],'gateway_order_id':_0x3cd8b3['gatewayOrderId'],'gateway':_0x3cd8b3[_0x5ad819(0x248)],'amount':_0x3cd8b3[_0x5ad819(0x283)],'currency':_0x3cd8b3[_0x5ad819(0x1f5)],'status':_0x418ba6[_0x5ad819(0x209)](),'customer_email':_0x3cd8b3['customerEmail'],'customer_name':_0x3cd8b3[_0x5ad819(0x1d9)],'failure_message':_0x3cd8b3[_0x5ad819(0x244)],'tx_urls':_0x3cd8b3['txUrls']?JSON[_0x5ad819(0x22e)](_0x3cd8b3['txUrls']):null,'created_at':_0x3cd8b3[_0x5ad819(0x285)],'updated_at':_0x3cd8b3[_0x5ad819(0x1e2)]}},_0x2e89ed=await fetch(_0x10eaf0['webhookUrl'],{'method':_0x5ad819(0x281),'headers':{'Content-Type':_0x5ad819(0x255),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x5ad819(0x243)](_0x5d5f43)}),_0x59b5b3=Date[_0x5ad819(0x21b)]()-_0x189f4c,_0x37c939=_0x2e89ed['ok']?_0x5ad819(0x23b):await _0x2e89ed[_0x5ad819(0x298)]();loggerService_1['loggerService'][_0x5ad819(0x270)](_0x3cd8b3[_0x5ad819(0x245)],_0x10eaf0[_0x5ad819(0x266)],_0x38ef5d,_0x2e89ed[_0x5ad819(0x296)],_0x59b5b3,_0x5d5f43),console[_0x5ad819(0x26f)](_0x5ad819(0x268)+_0x10eaf0[_0x5ad819(0x266)]+_0x5ad819(0x1f1)+_0x2e89ed[_0x5ad819(0x296)]+'\x20('+_0x59b5b3+_0x5ad819(0x226));}catch(_0x50672f){console[_0x5ad819(0x292)](_0x5ad819(0x26a),_0x50672f),loggerService_1[_0x5ad819(0x27a)][_0x5ad819(0x20b)](_0x3cd8b3[_0x5ad819(0x245)],_0x3cd8b3[_0x5ad819(0x284)]?.[_0x5ad819(0x1ea)]?.[_0x5ad819(0x266)]||_0x5ad819(0x274),'webhook_send',_0x50672f,{});}}async[a58_0x285ef7(0x288)](_0x58521e,_0x35fdde){const _0x265af7=a58_0x285ef7;try{const _0x5ebf84={'PENDING':'created','PROCESSING':_0x265af7(0x239),'PAID':_0x265af7(0x1eb),'FAILED':_0x265af7(0x290),'EXPIRED':_0x265af7(0x1dd),'REFUND':_0x265af7(0x23e),'CHARGEBACK':_0x265af7(0x1f0)},_0x15e18f=_0x5ebf84[_0x35fdde];if(!_0x15e18f||_0x15e18f==='created')return;await telegramBotService_1['telegramBotService'][_0x265af7(0x26b)](_0x58521e[_0x265af7(0x245)],_0x58521e,_0x15e18f);}catch(_0x4d3764){console[_0x265af7(0x292)](_0x265af7(0x204),_0x4d3764);}}}function a58_0x1313(_0x951159,_0x592844){const _0xd20e06=a58_0xd20e();return a58_0x1313=function(_0x1313cd,_0x361f2c){_0x1313cd=_0x1313cd-0x1d0;let _0x5a3a85=_0xd20e06[_0x1313cd];return _0x5a3a85;},a58_0x1313(_0x951159,_0x592844);}exports[a58_0x285ef7(0x246)]=WebhookService;