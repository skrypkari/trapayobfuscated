'use strict';function a55_0x4c99(){const _0x5c9ca7=['No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','ms)','failed','Processing\x20CoinToPay\x20webhook:','klyme','./paymentLinkService','Error\x20processing\x20Rapyd\x20webhook:','ðŸ”„\x20Updating\x20payment\x20','ðŸ”—\x20Payment\x20','gatewayOrderId','cointopay','remitterIban','Processing\x20Plisio\x20Gateway\x20webhook:','PENDING','coinToPayService','defineProperty','./gateways/coinToPayService','update','plisio_gateway','text','No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook','rapydService','length','additionalInfo','paymentMethod','./telegramBotService','sendShopWebhook','17815sHmwUO','payment','Failed\x20to\x20send\x20shop\x20webhook:','includes','../config/database','./loggerService','bankId','log','klymeService','processPlisioGatewayWebhook','Shop\x20webhook\x20sent\x20to\x20','\x20from\x20','./gateways/klymeService','Error\x20processing\x20KLYME\x20webhook:','plisio','create','1377173zmZuHo','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','Processing\x20KLYME\x20webhook:','\x20->\x20','Payment\x20','KlymeService','1552SqswGX','No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook','region','webhookLog','shopId','settings','paidAt','cardLast4','__importDefault','14217507TgTxJb','No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook','processCoinToPayWebhook','payment.failed','ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20','klyme_','ðŸ’¾\x20Failure\x20message\x20saved:\x20','sendPaymentNotification','shop','ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20','processKlymeWebhook','payment.pending','20WRPTYq','paymentId','logWebhookError','\x20not\x20enabled\x20for\x20shop\x20','parse','__esModule','\x20transaction\x20URLs:','NodaService','noda','1484282uqSQNd','paid','_webhook_','./gateways/rapydService','txUrls','customerName','customerEmail','logShopWebhookSent','CoinToPayService','TesSoft\x20Payment\x20System/1.0','loggerService','payment.success','sendPaymentStatusNotification','nodaService','FAILED','ðŸ’¥\x20Payment\x20','created','status','processNodaWebhook','WebhookService','handleSuccessfulPayment','failureMessage','2hwFmvw','findFirst','9474072VBvsxx','telegramBotService','processWebhook','\x20updated\x20successfully:\x20','updatePaymentStatus','webhook_send','webhookUrl','EXPIRED','Error\x20processing\x20Noda\x20webhook:','stringify','remitterName','logWebhookProcessed','amount','logShopWebhookError','error','webhookEvents','Success','4041666BZgedZ','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook','\x20and\x20gateway:\x20','6719142SsaMXW','\x20with\x20status\x20','RapydService','toLowerCase','default','createdAt','PAID','rapyd','\x20URLs','klyme_eu','âœ…\x20Payment\x20','now','Error\x20processing\x20Plisio\x20webhook:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Error\x20parsing\x20webhook\x20events:','\x20failure\x20message:\x20','plisioService'];a55_0x4c99=function(){return _0x5c9ca7;};return a55_0x4c99();}const a55_0x4d8531=a55_0x385d;(function(_0x2b3aee,_0x28e494){const _0x5f0c01=a55_0x385d,_0x5780e6=_0x2b3aee();while(!![]){try{const _0x591ee9=parseInt(_0x5f0c01(0x1b3))/0x1+-parseInt(_0x5f0c01(0x13c))/0x2*(parseInt(_0x5f0c01(0x14f))/0x3)+-parseInt(_0x5f0c01(0x195))/0x4*(-parseInt(_0x5f0c01(0x17f))/0x5)+parseInt(_0x5f0c01(0x152))/0x6+parseInt(_0x5f0c01(0x18f))/0x7+parseInt(_0x5f0c01(0x13e))/0x8+-parseInt(_0x5f0c01(0x19e))/0x9*(parseInt(_0x5f0c01(0x1aa))/0xa);if(_0x591ee9===_0x28e494)break;else _0x5780e6['push'](_0x5780e6['shift']());}catch(_0x21813f){_0x5780e6['push'](_0x5780e6['shift']());}}}(a55_0x4c99,0xd22f1));function a55_0x385d(_0x33557a,_0x4b7cbf){const _0x4c99af=a55_0x4c99();return a55_0x385d=function(_0x385d14,_0x3acd54){_0x385d14=_0x385d14-0x132;let _0x99540d=_0x4c99af[_0x385d14];return _0x99540d;},a55_0x385d(_0x33557a,_0x4b7cbf);}var __importDefault=this&&this[a55_0x4d8531(0x19d)]||function(_0x3c83f6){const _0x3eee84=a55_0x4d8531;return _0x3c83f6&&_0x3c83f6[_0x3eee84(0x1af)]?_0x3c83f6:{'default':_0x3c83f6};};Object[a55_0x4d8531(0x173)](exports,a55_0x4d8531(0x1af),{'value':!![]}),exports[a55_0x4d8531(0x139)]=void 0x0;const database_1=__importDefault(require(a55_0x4d8531(0x183))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a55_0x4d8531(0x1b6)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a55_0x4d8531(0x174)),klymeService_1=require(a55_0x4d8531(0x18b)),telegramBotService_1=require(a55_0x4d8531(0x17d)),paymentLinkService_1=require(a55_0x4d8531(0x169)),loggerService_1=require(a55_0x4d8531(0x184));class WebhookService{constructor(){const _0x536423=a55_0x4d8531;this[_0x536423(0x162)]=new plisioService_1['PlisioService'](),this['rapydService']=new rapydService_1[(_0x536423(0x154))](),this[_0x536423(0x133)]=new nodaService_1[(_0x536423(0x1b1))](),this[_0x536423(0x172)]=new coinToPayService_1[(_0x536423(0x1bb))](),this['klymeService']=new klymeService_1[(_0x536423(0x194))](),this['paymentLinkService']=new paymentLinkService_1['PaymentLinkService']();}async['processPlisioWebhook'](_0x397084){const _0x4fc8be=a55_0x4d8531;console[_0x4fc8be(0x186)]('Processing\x20Plisio\x20webhook:',_0x397084);try{const _0x461e92=await this[_0x4fc8be(0x162)][_0x4fc8be(0x140)](_0x397084);if(!_0x461e92['paymentId']){console[_0x4fc8be(0x14c)]('No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook');return;}await this[_0x4fc8be(0x142)](_0x461e92['paymentId'],_0x461e92['status'],'plisio',_0x397084,undefined,undefined,_0x461e92['txUrls']),loggerService_1[_0x4fc8be(0x1bd)]['logWebhookProcessed'](_0x4fc8be(0x18d),_0x461e92[_0x4fc8be(0x1ab)],'PENDING',_0x461e92[_0x4fc8be(0x137)],_0x397084);}catch(_0xd097bb){console[_0x4fc8be(0x14c)](_0x4fc8be(0x15e),_0xd097bb),loggerService_1[_0x4fc8be(0x1bd)][_0x4fc8be(0x1ac)](_0x4fc8be(0x18d),_0xd097bb,_0x397084);throw _0xd097bb;}}async[a55_0x4d8531(0x188)](_0x19d7bd){const _0x1bec8f=a55_0x4d8531;console[_0x1bec8f(0x186)](_0x1bec8f(0x170),_0x19d7bd);try{const _0x1723a8=await this['plisioService']['processWebhook'](_0x19d7bd);if(!_0x1723a8['paymentId']){console[_0x1bec8f(0x14c)](_0x1bec8f(0x150));return;}await this[_0x1bec8f(0x142)](_0x1723a8[_0x1bec8f(0x1ab)],_0x1723a8[_0x1bec8f(0x137)],_0x1bec8f(0x18d),_0x19d7bd,undefined,undefined,_0x1723a8[_0x1bec8f(0x1b7)]),loggerService_1['loggerService'][_0x1bec8f(0x149)](_0x1bec8f(0x176),_0x1723a8[_0x1bec8f(0x1ab)],_0x1bec8f(0x171),_0x1723a8['status'],_0x19d7bd);}catch(_0x254686){console[_0x1bec8f(0x14c)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x254686),loggerService_1[_0x1bec8f(0x1bd)][_0x1bec8f(0x1ac)](_0x1bec8f(0x176),_0x254686,_0x19d7bd);throw _0x254686;}}async['processRapydWebhook'](_0x20045a){const _0x1adf83=a55_0x4d8531;console['log']('Processing\x20Rapyd\x20webhook:',_0x20045a);try{const _0x51f069=await this[_0x1adf83(0x179)][_0x1adf83(0x140)](_0x20045a);if(!_0x51f069[_0x1adf83(0x1ab)]){console[_0x1adf83(0x14c)](_0x1adf83(0x163));return;}await this[_0x1adf83(0x142)](_0x51f069['paymentId'],_0x51f069[_0x1adf83(0x137)],_0x1adf83(0x159),_0x20045a,_0x51f069[_0x1adf83(0x13b)],_0x51f069[_0x1adf83(0x17b)]),loggerService_1[_0x1adf83(0x1bd)][_0x1adf83(0x149)](_0x1adf83(0x159),_0x51f069['paymentId'],'PENDING',_0x51f069[_0x1adf83(0x137)],_0x20045a);}catch(_0x28b0dc){console[_0x1adf83(0x14c)](_0x1adf83(0x16a),_0x28b0dc),loggerService_1['loggerService'][_0x1adf83(0x1ac)]('rapyd',_0x28b0dc,_0x20045a);throw _0x28b0dc;}}async[a55_0x4d8531(0x138)](_0x43ff1c){const _0x2d7b8d=a55_0x4d8531;console[_0x2d7b8d(0x186)]('Processing\x20Noda\x20webhook:',_0x43ff1c);try{const _0xe2eaaf=await this[_0x2d7b8d(0x133)][_0x2d7b8d(0x140)](_0x43ff1c);if(!_0xe2eaaf[_0x2d7b8d(0x1ab)]){console[_0x2d7b8d(0x14c)](_0x2d7b8d(0x196));return;}await this['updatePaymentStatus'](_0xe2eaaf[_0x2d7b8d(0x1ab)],_0xe2eaaf['status'],_0x2d7b8d(0x1b2),_0x43ff1c,undefined,_0xe2eaaf['additionalInfo']),loggerService_1[_0x2d7b8d(0x1bd)][_0x2d7b8d(0x149)](_0x2d7b8d(0x1b2),_0xe2eaaf[_0x2d7b8d(0x1ab)],'PENDING',_0xe2eaaf[_0x2d7b8d(0x137)],_0x43ff1c);}catch(_0xe4eec3){console['error'](_0x2d7b8d(0x146),_0xe4eec3),loggerService_1[_0x2d7b8d(0x1bd)][_0x2d7b8d(0x1ac)](_0x2d7b8d(0x1b2),_0xe4eec3,_0x43ff1c);throw _0xe4eec3;}}async[a55_0x4d8531(0x1a0)](_0x12c2e3){const _0x1ea713=a55_0x4d8531;console[_0x1ea713(0x186)](_0x1ea713(0x167),_0x12c2e3);try{const _0x1b9647=await this[_0x1ea713(0x172)][_0x1ea713(0x140)](_0x12c2e3);if(!_0x1b9647[_0x1ea713(0x1ab)]){console[_0x1ea713(0x14c)](_0x1ea713(0x19f));return;}await this['updatePaymentStatus'](_0x1b9647[_0x1ea713(0x1ab)],_0x1b9647[_0x1ea713(0x137)],_0x1ea713(0x16e),_0x12c2e3),loggerService_1['loggerService']['logWebhookProcessed']('cointopay',_0x1b9647[_0x1ea713(0x1ab)],'PENDING',_0x1b9647[_0x1ea713(0x137)],_0x12c2e3);}catch(_0x5edf42){console[_0x1ea713(0x14c)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x5edf42),loggerService_1['loggerService']['logWebhookError'](_0x1ea713(0x16e),_0x5edf42,_0x12c2e3);throw _0x5edf42;}}async[a55_0x4d8531(0x1a8)](_0x4c61ad){const _0x3b7399=a55_0x4d8531;console['log'](_0x3b7399(0x191),_0x4c61ad);try{const _0x35b67c=await this[_0x3b7399(0x187)][_0x3b7399(0x140)](_0x4c61ad);if(!_0x35b67c[_0x3b7399(0x1ab)]){console[_0x3b7399(0x14c)](_0x3b7399(0x178));return;}const _0x4a1c9c=_0x35b67c[_0x3b7399(0x197)]?_0x3b7399(0x1a3)+_0x35b67c[_0x3b7399(0x197)][_0x3b7399(0x155)]():_0x3b7399(0x15b);await this['updatePaymentStatus'](_0x35b67c[_0x3b7399(0x1ab)],_0x35b67c[_0x3b7399(0x137)],_0x4a1c9c,_0x4c61ad,undefined,_0x35b67c[_0x3b7399(0x17b)]),loggerService_1[_0x3b7399(0x1bd)][_0x3b7399(0x149)](_0x3b7399(0x168),_0x35b67c[_0x3b7399(0x1ab)],'PENDING',_0x35b67c[_0x3b7399(0x137)],_0x4c61ad);}catch(_0xbb40f8){console[_0x3b7399(0x14c)](_0x3b7399(0x18c),_0xbb40f8),loggerService_1[_0x3b7399(0x1bd)]['logWebhookError'](_0x3b7399(0x168),_0xbb40f8,_0x4c61ad);throw _0xbb40f8;}}async[a55_0x4d8531(0x142)](_0x139ee9,_0x27d517,_0x5d6223,_0x549421,_0x450493,_0xa58dff,_0x4d4ca9){const _0x4ca3a8=a55_0x4d8531;console['log'](_0x4ca3a8(0x16b)+_0x139ee9+'\x20status\x20to\x20'+_0x27d517+_0x4ca3a8(0x18a)+_0x5d6223+'\x20webhook');_0x450493&&console[_0x4ca3a8(0x186)](_0x4ca3a8(0x135)+_0x139ee9+_0x4ca3a8(0x161)+_0x450493);_0x4d4ca9&&_0x4d4ca9[_0x4ca3a8(0x17a)]>0x0&&console[_0x4ca3a8(0x186)](_0x4ca3a8(0x16c)+_0x139ee9+_0x4ca3a8(0x1b0),_0x4d4ca9);const _0x26ee6a=await database_1[_0x4ca3a8(0x156)][_0x4ca3a8(0x180)][_0x4ca3a8(0x13d)]({'where':{'gatewayOrderId':_0x139ee9,'gateway':_0x5d6223},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x26ee6a){console[_0x4ca3a8(0x14c)](_0x4ca3a8(0x190)+_0x139ee9+_0x4ca3a8(0x151)+_0x5d6223);return;}const _0x18ccff=_0x26ee6a['status'];if(_0x18ccff===_0x27d517){console[_0x4ca3a8(0x186)](_0x4ca3a8(0x193)+_0x26ee6a['id']+'\x20status\x20unchanged\x20('+_0x27d517+')');return;}console[_0x4ca3a8(0x186)](_0x4ca3a8(0x193)+_0x26ee6a['id']+'\x20status\x20change:\x20'+_0x18ccff+_0x4ca3a8(0x192)+_0x27d517);const _0x4f3848={'status':_0x27d517,'updatedAt':new Date()};_0x450493&&(_0x4f3848[_0x4ca3a8(0x13b)]=_0x450493,console[_0x4ca3a8(0x186)]('ðŸ’¾\x20Saving\x20failure\x20message:\x20'+_0x450493));_0x4d4ca9&&_0x4d4ca9[_0x4ca3a8(0x17a)]>0x0&&(_0x4f3848[_0x4ca3a8(0x1b7)]=JSON[_0x4ca3a8(0x147)](_0x4d4ca9),console[_0x4ca3a8(0x186)](_0x4ca3a8(0x1a2)+JSON[_0x4ca3a8(0x147)](_0x4d4ca9)));_0x27d517===_0x4ca3a8(0x158)&&_0x18ccff!=='PAID'&&(_0x4f3848[_0x4ca3a8(0x19b)]=new Date());_0xa58dff&&(_0xa58dff['cardLast4']&&(_0x4f3848[_0x4ca3a8(0x19c)]=_0xa58dff[_0x4ca3a8(0x19c)]),_0xa58dff[_0x4ca3a8(0x17c)]&&(_0x4f3848['paymentMethod']=_0xa58dff[_0x4ca3a8(0x17c)]),_0xa58dff[_0x4ca3a8(0x185)]&&(_0x4f3848[_0x4ca3a8(0x185)]=_0xa58dff[_0x4ca3a8(0x185)]),_0xa58dff[_0x4ca3a8(0x16f)]&&(_0x4f3848[_0x4ca3a8(0x16f)]=_0xa58dff['remitterIban']),_0xa58dff['remitterName']&&(_0x4f3848['remitterName']=_0xa58dff[_0x4ca3a8(0x148)]));await database_1['default'][_0x4ca3a8(0x180)][_0x4ca3a8(0x175)]({'where':{'id':_0x26ee6a['id']},'data':_0x4f3848});if(_0x27d517===_0x4ca3a8(0x158)&&_0x18ccff!==_0x4ca3a8(0x158))try{await this['paymentLinkService'][_0x4ca3a8(0x13a)](_0x26ee6a['id']);}catch(_0x207d28){console[_0x4ca3a8(0x14c)]('Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x207d28);}await database_1[_0x4ca3a8(0x156)][_0x4ca3a8(0x198)][_0x4ca3a8(0x18e)]({'data':{'paymentId':_0x26ee6a['id'],'shopId':_0x26ee6a['shopId'],'event':_0x5d6223+_0x4ca3a8(0x1b5)+_0x27d517[_0x4ca3a8(0x155)](),'statusCode':0xc8,'responseBody':JSON[_0x4ca3a8(0x147)]({'oldStatus':_0x18ccff,'newStatus':_0x27d517,'failureMessage':_0x450493,'txUrls':_0x4d4ca9,'webhookData':_0x549421})}}),await this[_0x4ca3a8(0x17e)](_0x26ee6a,_0x27d517),await this[_0x4ca3a8(0x132)](_0x26ee6a,_0x27d517),console['log'](_0x4ca3a8(0x15c)+_0x26ee6a['id']+_0x4ca3a8(0x141)+_0x18ccff+_0x4ca3a8(0x192)+_0x27d517),_0x450493&&console['log'](_0x4ca3a8(0x1a4)+_0x450493),_0x4d4ca9&&_0x4d4ca9[_0x4ca3a8(0x17a)]>0x0&&console[_0x4ca3a8(0x186)](_0x4ca3a8(0x1a7)+_0x4d4ca9['length']+_0x4ca3a8(0x15a));}async[a55_0x4d8531(0x17e)](_0x5b0f07,_0x544c6c){const _0x2333e6=a55_0x4d8531,_0x3d9979=Date[_0x2333e6(0x15d)]();try{const _0x1e1b42=_0x5b0f07[_0x2333e6(0x1a6)],_0x35e78b=_0x1e1b42[_0x2333e6(0x19a)];if(!_0x35e78b?.[_0x2333e6(0x144)]){console[_0x2333e6(0x186)](_0x2333e6(0x164)+_0x1e1b42['id']);return;}const _0x4f6e68=_0x544c6c===_0x2333e6(0x158)?_0x2333e6(0x1be):_0x544c6c===_0x2333e6(0x134)?_0x2333e6(0x1a1):_0x544c6c===_0x2333e6(0x145)?_0x2333e6(0x1a1):_0x2333e6(0x1a9);let _0x505975=[];if(_0x35e78b[_0x2333e6(0x14d)])try{_0x505975=Array['isArray'](_0x35e78b['webhookEvents'])?_0x35e78b[_0x2333e6(0x14d)]:JSON[_0x2333e6(0x1ae)](_0x35e78b[_0x2333e6(0x14d)]);}catch(_0x42e9a2){console[_0x2333e6(0x14c)](_0x2333e6(0x160),_0x42e9a2),_0x505975=[];}if(!_0x505975[_0x2333e6(0x182)](_0x4f6e68)){console[_0x2333e6(0x186)]('Webhook\x20event\x20'+_0x4f6e68+_0x2333e6(0x1ad)+_0x1e1b42['id']);return;}let _0x4fb5e0;if(_0x5b0f07[_0x2333e6(0x1b7)])try{_0x4fb5e0=JSON[_0x2333e6(0x1ae)](_0x5b0f07['txUrls']);}catch(_0x1efd96){console[_0x2333e6(0x14c)]('Error\x20parsing\x20tx_urls\x20for\x20webhook:',_0x1efd96),_0x4fb5e0=undefined;}const _0x423c4c={'event':_0x4f6e68,'payment':{'id':_0x5b0f07['id'],'order_id':_0x5b0f07['orderId'],'gateway_order_id':_0x5b0f07[_0x2333e6(0x16d)],'gateway':_0x5b0f07['gateway'],'amount':_0x5b0f07[_0x2333e6(0x14a)],'currency':_0x5b0f07['currency'],'status':_0x544c6c[_0x2333e6(0x155)](),'customer_email':_0x5b0f07[_0x2333e6(0x1b9)],'customer_name':_0x5b0f07[_0x2333e6(0x1b8)],'failure_message':_0x5b0f07['failureMessage'],'tx_urls':_0x4fb5e0,'created_at':_0x5b0f07[_0x2333e6(0x157)],'updated_at':new Date()}},_0x4cd259=await fetch(_0x35e78b['webhookUrl'],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x2333e6(0x1bc)},'body':JSON[_0x2333e6(0x147)](_0x423c4c)}),_0x1afbf6=Date[_0x2333e6(0x15d)]()-_0x3d9979,_0x183d15=_0x4cd259['ok']?_0x2333e6(0x14e):await _0x4cd259[_0x2333e6(0x177)]();loggerService_1[_0x2333e6(0x1bd)][_0x2333e6(0x1ba)](_0x5b0f07[_0x2333e6(0x199)],_0x35e78b['webhookUrl'],_0x4f6e68,_0x4cd259[_0x2333e6(0x137)],_0x1afbf6,_0x423c4c),console[_0x2333e6(0x186)](_0x2333e6(0x189)+_0x35e78b[_0x2333e6(0x144)]+_0x2333e6(0x153)+_0x4cd259[_0x2333e6(0x137)]+'\x20('+_0x1afbf6+_0x2333e6(0x165));}catch(_0xff9d8){console[_0x2333e6(0x14c)](_0x2333e6(0x181),_0xff9d8),loggerService_1[_0x2333e6(0x1bd)][_0x2333e6(0x14b)](_0x5b0f07[_0x2333e6(0x199)],_0x5b0f07['shop']?.[_0x2333e6(0x19a)]?.[_0x2333e6(0x144)]||'unknown',_0x2333e6(0x143),_0xff9d8,{});}}async[a55_0x4d8531(0x132)](_0x48a2c4,_0x3c3115){const _0x49c7a3=a55_0x4d8531;try{const _0x271fbe={'PENDING':_0x49c7a3(0x136),'PAID':_0x49c7a3(0x1b4),'FAILED':_0x49c7a3(0x166),'EXPIRED':'expired'},_0x17bb62=_0x271fbe[_0x3c3115];if(!_0x17bb62||_0x17bb62===_0x49c7a3(0x136))return;await telegramBotService_1[_0x49c7a3(0x13f)][_0x49c7a3(0x1a5)](_0x48a2c4[_0x49c7a3(0x199)],_0x48a2c4,_0x17bb62);}catch(_0x52dd05){console['error'](_0x49c7a3(0x15f),_0x52dd05);}}}exports['WebhookService']=WebhookService;