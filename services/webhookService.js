'use strict';function a60_0x35a5(_0x4e52e2,_0x47de01){const _0x32775b=a60_0x3277();return a60_0x35a5=function(_0x35a5e4,_0x4bf458){_0x35a5e4=_0x35a5e4-0x194;let _0x282540=_0x32775b[_0x35a5e4];return _0x282540;},a60_0x35a5(_0x4e52e2,_0x47de01);}function a60_0x3277(){const _0x3383af=['isArray','amer','💰\x20Amount\x20after\x20gateway\x20commission:\x20','\x22,\x20newStatus=\x22','plisioService','🔄\x20Processing\x20Noda\x20webhook:','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','payment','remitterName','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','currentPayments','./gateways/amerService','📊\x20Noda\x20webhook:\x20Payment\x20','additionalInfo','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',':\x20type=','🔄\x20Processing\x20KLYME\x20webhook:','\x20-\x20','failed','3231yksQLu','Error\x20processing\x20CoinToPay\x20webhook:','amountAfterGatewayCommissionUSDT','processRapydWebhook','paymentLinkId','🔄\x20Additional\x20data:','Error\x20processing\x20CoinToPay2\x20webhook:','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','noda','updatedAt','expired','gateway','keys','payment.success','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','klymeService','🔄\x20Processing\x20CoinToPay\x20webhook:','6465925bjsbzu','processCoinToPayWebhook','nodaService','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','💰\x20Gateway\x20','balance','default','payment_method','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','paymentId','📊\x20Plisio\x20webhook:\x20Payment\x20','2132352ZxcWXI','cardLast4',',\x20newStatus=','processMasterCardWebhook',',\x20gateway\x20','\x20->\x20','$transaction','shopId','webhookEvents','text','logWebhookProcessed','commission','now','createdAt','🔄\x20Processing\x20Plisio\x20webhook:','status','stringify','❌\x20Payment\x20link\x20','__esModule','webhook_status_change_','🔍\x20Search\x20result:\x20','log','\x20in\x20shop\x20','toFixed','Error\x20processing\x20KLYME\x20webhook:','📈\x20Found\x20payment\x20link\x20','Failed\x20to\x20send\x20shop\x20webhook:','mastercard','logWebhookError','\x20=\x20','processWebhook','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','payment.failed','TesSoft\x20Payment\x20System/1.0','📝\x20Reason:\x20','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','📊\x20Rapyd\x20webhook:\x20Payment\x20','NodaService','✅\x20Shop\x20','application/json','paymentMethod','COMPLETED','failureMessage','Found\x20payment\x20','./gateways/rapydService','toLowerCase','41052AmBwDO','PlisioService','webhookUrl','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','2587963ctRuSG','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','Success','🏪\x20Shop\x20','getGatewayCommission','KlymeService','./gateways/coinToPayService','./gateways/plisioService','\x22,\x20orderId=\x22','./gateways/mastercardService','❌\x20Error\x20processing\x20MasterCard\x20webhook:','cointopay2','processKlymeWebhook','📈\x20Payment\x20details:\x20oldStatus=\x22','plisio','\x20commission:\x20',',\x20currentPayments=','includes','toISOString','sendPaymentStatusNotification','EXPIRED','No\x20payment\x20ID\x20in\x20Noda\x20webhook','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','paymentLink','sendShopWebhook','orderId','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','username','No\x20payment\x20ID\x20in\x20Amer\x20webhook','telegramBotService','💰\x20Converting\x20','remitterIban','webhookLog','plisio_gateway','logShopWebhookSent','5837337xjVLrv','cointopay','%\x20gateway\x20commission)','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','Payment\x20not\x20found','PAID','🔄\x20Processing\x20MasterCard\x20webhook:','loggerService',',\x20status=','Webhook\x20event\x20','findFirst','SINGLE','findMany','📈\x20Payment\x20','WebhookService','💰\x20Payment\x20','logShopWebhookError','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','error','ms)','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20updated:\x20currentPayments=','📊\x20CoinToPay\x20webhook:\x20Payment\x20','webhook_send','12hFGfwN','no\x20balance\x20change','💰\x20Adding\x20to\x20balance:\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','coinToPayService','MasterCardService','694PKDlgY','shop','\x20to\x20','settings','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','gatewayOrderId','findUnique','REFUND','\x20not\x20enabled\x20for\x20shop\x20','customerName','klyme','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','POST','customerEmail','./telegramBotService','parse','\x20USDT','./loggerService','16qtpcbK','📊\x20KLYME\x20webhook:\x20Payment\x20','💰\x20Removing\x20from\x20balance:\x20','❌\x20Error\x20processing\x20Amer\x20webhook:','chargeback','rapydService','entries','type','unknown','amountUSDT','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','created','CHARGEBACK','__importDefault','toUpperCase','\x20USDT\x20(chargeback\x20penalty)','\x20commission\x20for\x20shop\x20','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','CoinToPayService','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','19021800RhtXcL','\x20not\x20found','bankId','../config/database','txUrls','create','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','processPlisioGatewayWebhook','currency','defineProperty','Error\x20parsing\x20webhook\x20events:','processPlisioWebhook','❌\x20Available\x20webhook\x20fields:','AmerService','📊\x20MasterCard\x20webhook\x20result:','💰\x20Final\x20balance\x20after\x20chargeback:\x20','paidAt','coinToPay2Service','update','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','amount','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','\x20balance\x20updated:\x20','\x20status\x20','updatePaymentStatus','Error\x20processing\x20Plisio\x20webhook:','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','masterCardService','📊\x20Amer\x20webhook:\x20Payment\x20'];a60_0x3277=function(){return _0x3383af;};return a60_0x3277();}const a60_0x4c4a64=a60_0x35a5;(function(_0x3cdc47,_0xfc400c){const _0x17d1de=a60_0x35a5,_0x424399=_0x3cdc47();while(!![]){try{const _0x11a253=parseInt(_0x17d1de(0x216))/0x1*(parseInt(_0x17d1de(0x1bf))/0x2)+parseInt(_0x17d1de(0x260))/0x3+-parseInt(_0x17d1de(0x232))/0x4+-parseInt(_0x17d1de(0x227))/0x5+-parseInt(_0x17d1de(0x1b9))/0x6*(-parseInt(_0x17d1de(0x265))/0x7)+-parseInt(_0x17d1de(0x1d2))/0x8*(parseInt(_0x17d1de(0x1a1))/0x9)+parseInt(_0x17d1de(0x1e6))/0xa;if(_0x11a253===_0xfc400c)break;else _0x424399['push'](_0x424399['shift']());}catch(_0x47b864){_0x424399['push'](_0x424399['shift']());}}}(a60_0x3277,0x9f6b4));var __importDefault=this&&this[a60_0x4c4a64(0x1df)]||function(_0x4a0f27){const _0x495dc3=a60_0x4c4a64;return _0x4a0f27&&_0x4a0f27[_0x495dc3(0x244)]?_0x4a0f27:{'default':_0x4a0f27};};Object[a60_0x4c4a64(0x1ef)](exports,'__esModule',{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a60_0x4c4a64(0x1e9))),plisioService_1=require(a60_0x4c4a64(0x26c)),rapydService_1=require(a60_0x4c4a64(0x25e)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a60_0x4c4a64(0x26b)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a60_0x4c4a64(0x26e)),amerService_1=require(a60_0x4c4a64(0x20e)),telegramBotService_1=require(a60_0x4c4a64(0x1ce)),currencyService_1=require('./currencyService'),loggerService_1=require(a60_0x4c4a64(0x1d1));class WebhookService{constructor(){const _0x117527=a60_0x4c4a64;this['plisioService']=new plisioService_1[(_0x117527(0x261))](),this[_0x117527(0x1d7)]=new rapydService_1['RapydService'](),this[_0x117527(0x229)]=new nodaService_1[(_0x117527(0x257))](),this['coinToPayService']=new coinToPayService_1[(_0x117527(0x1e4))](),this[_0x117527(0x1f7)]=new coinToPay2Service_1['CoinToPay2Service'](),this['klymeService']=new klymeService_1[(_0x117527(0x26a))](),this[_0x117527(0x201)]=new mastercardService_1[(_0x117527(0x1be))](),this['amerService']=new amerService_1[(_0x117527(0x1f3))]();}async[a60_0x4c4a64(0x1fe)](_0x45515a,_0x2cd571,_0x580f76){const _0x5a9d12=a60_0x4c4a64;console['log'](_0x5a9d12(0x21d)+_0x45515a+_0x5a9d12(0x234)+_0x2cd571),console[_0x5a9d12(0x247)](_0x5a9d12(0x21b),_0x580f76),await database_1[_0x5a9d12(0x22d)][_0x5a9d12(0x238)](async _0x232b07=>{const _0x2ca5ec=_0x5a9d12,_0x56c23d=await _0x232b07['payment'][_0x2ca5ec(0x1c5)]({'where':{'id':_0x45515a},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x56c23d)throw new Error('Payment\x20'+_0x45515a+_0x2ca5ec(0x1e7));const _0x46d005=_0x56c23d[_0x2ca5ec(0x241)],_0x49787c=_0x56c23d['shop'];console[_0x2ca5ec(0x247)](_0x2ca5ec(0x1b0)+_0x45515a+':\x20'+_0x46d005+_0x2ca5ec(0x237)+_0x2cd571),console[_0x2ca5ec(0x247)](_0x2ca5ec(0x268)+_0x49787c[_0x2ca5ec(0x199)]+'\x20current\x20balance:\x20'+_0x49787c[_0x2ca5ec(0x22c)]+'\x20USDT');const _0x1bc244={'status':_0x2cd571[_0x2ca5ec(0x1e0)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x580f76?.['failureMessage']&&(_0x1bc244[_0x2ca5ec(0x25c)]=_0x580f76['failureMessage']);_0x580f76?.[_0x2ca5ec(0x1ea)]&&(_0x1bc244['txUrls']=JSON[_0x2ca5ec(0x242)](_0x580f76['txUrls']));_0x580f76?.['cardLast4']&&(_0x1bc244['cardLast4']=_0x580f76['cardLast4']);_0x580f76?.[_0x2ca5ec(0x25a)]&&(_0x1bc244[_0x2ca5ec(0x25a)]=_0x580f76['paymentMethod']);_0x580f76?.['bankId']&&(_0x1bc244[_0x2ca5ec(0x1e8)]=_0x580f76[_0x2ca5ec(0x1e8)]);_0x580f76?.[_0x2ca5ec(0x19d)]&&(_0x1bc244[_0x2ca5ec(0x19d)]=_0x580f76['remitterIban']);_0x580f76?.[_0x2ca5ec(0x20b)]&&(_0x1bc244[_0x2ca5ec(0x20b)]=_0x580f76[_0x2ca5ec(0x20b)]);let _0x50acfa=_0x49787c[_0x2ca5ec(0x22c)],_0x2148ac='';if(_0x2cd571[_0x2ca5ec(0x1e0)]()==='PAID'&&_0x46d005!==_0x2ca5ec(0x1a6)){const _0x4915a3=await currencyService_1['currencyService']['convertToUSDT'](_0x56c23d[_0x2ca5ec(0x1fa)],_0x56c23d[_0x2ca5ec(0x1ee)]),_0x251db1=await this[_0x2ca5ec(0x269)](_0x49787c['id'],_0x56c23d['gateway']),_0x4db6dd=_0x4915a3*(0x1-_0x251db1/0x64);_0x50acfa+=_0x4db6dd,_0x2148ac='+'+_0x4db6dd[_0x2ca5ec(0x249)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20'+_0x251db1+_0x2ca5ec(0x1a3),_0x1bc244[_0x2ca5ec(0x1db)]=_0x4915a3,_0x1bc244[_0x2ca5ec(0x218)]=_0x4db6dd,_0x1bc244[_0x2ca5ec(0x1f6)]=new Date(),console[_0x2ca5ec(0x247)](_0x2ca5ec(0x19c)+_0x56c23d['amount']+'\x20'+_0x56c23d[_0x2ca5ec(0x1ee)]+_0x2ca5ec(0x237)+_0x4915a3[_0x2ca5ec(0x249)](0x6)+_0x2ca5ec(0x1d0)),console[_0x2ca5ec(0x247)](_0x2ca5ec(0x22b)+_0x56c23d[_0x2ca5ec(0x221)]+_0x2ca5ec(0x274)+_0x251db1+'%'),console[_0x2ca5ec(0x247)](_0x2ca5ec(0x205)+_0x4db6dd[_0x2ca5ec(0x249)](0x6)+_0x2ca5ec(0x1d0)),console[_0x2ca5ec(0x247)](_0x2ca5ec(0x1bb)+_0x49787c[_0x2ca5ec(0x22c)]+'\x20+\x20'+_0x4db6dd[_0x2ca5ec(0x249)](0x6)+_0x2ca5ec(0x24f)+_0x50acfa[_0x2ca5ec(0x249)](0x6)+'\x20USDT');}else{if(_0x46d005===_0x2ca5ec(0x1a6)&&_0x2cd571['toUpperCase']()!==_0x2ca5ec(0x1a6)){let _0x1ef935;if(_0x56c23d['amountAfterGatewayCommissionUSDT'])_0x1ef935=_0x56c23d[_0x2ca5ec(0x218)];else{if(_0x56c23d[_0x2ca5ec(0x1db)]){const _0x4fb7ba=await this[_0x2ca5ec(0x269)](_0x49787c['id'],_0x56c23d[_0x2ca5ec(0x221)]);_0x1ef935=_0x56c23d['amountUSDT']*(0x1-_0x4fb7ba/0x64);}else console['log']('No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance'),_0x1ef935=0x0;}_0x1ef935>0x0&&(_0x50acfa-=_0x1ef935,_0x2148ac='-'+_0x1ef935[_0x2ca5ec(0x249)](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x1bc244[_0x2ca5ec(0x1db)]=null,_0x1bc244['amountAfterGatewayCommissionUSDT']=null,_0x1bc244[_0x2ca5ec(0x1f6)]=null,console[_0x2ca5ec(0x247)](_0x2ca5ec(0x1d4)+_0x49787c[_0x2ca5ec(0x22c)]+_0x2ca5ec(0x214)+_0x1ef935['toFixed'](0x6)+_0x2ca5ec(0x24f)+_0x50acfa[_0x2ca5ec(0x249)](0x6)+'\x20USDT'));}}if(_0x2cd571[_0x2ca5ec(0x1e0)]()===_0x2ca5ec(0x1de)){const _0x187cf2=_0x580f76?.['chargebackAmount']||0x0;_0x187cf2>0x0&&(_0x50acfa-=_0x187cf2,_0x2148ac+='\x20and\x20-'+_0x187cf2[_0x2ca5ec(0x249)](0x6)+_0x2ca5ec(0x1e1),_0x1bc244['chargebackAmount']=_0x187cf2,console[_0x2ca5ec(0x247)]('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0x187cf2['toFixed'](0x6)+_0x2ca5ec(0x1d0)),console[_0x2ca5ec(0x247)](_0x2ca5ec(0x1f5)+_0x50acfa['toFixed'](0x6)+_0x2ca5ec(0x1d0)));}const _0x55c362=await _0x232b07[_0x2ca5ec(0x20a)][_0x2ca5ec(0x1f8)]({'where':{'id':_0x45515a},'data':_0x1bc244});_0x50acfa!==_0x49787c[_0x2ca5ec(0x22c)]&&(await _0x232b07[_0x2ca5ec(0x1c0)]['update']({'where':{'id':_0x49787c['id']},'data':{'balance':_0x50acfa}}),console['log'](_0x2ca5ec(0x258)+_0x49787c[_0x2ca5ec(0x199)]+_0x2ca5ec(0x1fc)+_0x49787c['balance']['toFixed'](0x6)+_0x2ca5ec(0x237)+_0x50acfa[_0x2ca5ec(0x249)](0x6)+_0x2ca5ec(0x1d0)),console[_0x2ca5ec(0x247)](_0x2ca5ec(0x254)+_0x2148ac));await _0x232b07[_0x2ca5ec(0x19e)][_0x2ca5ec(0x1eb)]({'data':{'paymentId':_0x45515a,'shopId':_0x49787c['id'],'event':_0x2ca5ec(0x245)+_0x2cd571[_0x2ca5ec(0x25f)](),'statusCode':0xc8,'responseBody':JSON[_0x2ca5ec(0x242)]({'oldStatus':_0x46d005,'newStatus':_0x2cd571['toUpperCase'](),'balanceChange':_0x2148ac||_0x2ca5ec(0x1ba),'oldBalance':_0x49787c[_0x2ca5ec(0x22c)],'newBalance':_0x50acfa,'amountUSDT':_0x1bc244['amountUSDT'],'additionalData':_0x580f76,'timestamp':new Date()[_0x2ca5ec(0x277)]()})}}),await this[_0x2ca5ec(0x196)]({..._0x56c23d,..._0x55c362,'shop':_0x49787c},_0x2cd571[_0x2ca5ec(0x1e0)]()),await this[_0x2ca5ec(0x278)]({..._0x56c23d,..._0x55c362},_0x2cd571[_0x2ca5ec(0x1e0)]());if(_0x46d005!=='PAID'&&_0x2cd571[_0x2ca5ec(0x1e0)]()===_0x2ca5ec(0x1a6)){console[_0x2ca5ec(0x247)](_0x2ca5ec(0x1ae)+_0x45515a+_0x2ca5ec(0x1e5)),console[_0x2ca5ec(0x247)](_0x2ca5ec(0x272)+_0x46d005+_0x2ca5ec(0x206)+_0x2cd571[_0x2ca5ec(0x1e0)]()+'\x22,\x20paymentLinkId=\x22'+_0x56c23d[_0x2ca5ec(0x21a)]+'\x22');if(_0x56c23d[_0x2ca5ec(0x21a)])try{const _0x4df50d=await _0x232b07[_0x2ca5ec(0x195)][_0x2ca5ec(0x1c5)]({'where':{'id':_0x56c23d[_0x2ca5ec(0x21a)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4df50d){console[_0x2ca5ec(0x247)](_0x2ca5ec(0x24b)+_0x4df50d['id']+_0x2ca5ec(0x212)+_0x4df50d['type']+_0x2ca5ec(0x275)+_0x4df50d[_0x2ca5ec(0x20d)]+_0x2ca5ec(0x1a9)+_0x4df50d[_0x2ca5ec(0x241)]);const _0xcde9b1=_0x4df50d['currentPayments']+0x1,_0x13e24e=_0x4df50d[_0x2ca5ec(0x1d9)]===_0x2ca5ec(0x1ac)?_0x2ca5ec(0x25b):_0x4df50d[_0x2ca5ec(0x241)];await _0x232b07[_0x2ca5ec(0x195)][_0x2ca5ec(0x1f8)]({'where':{'id':_0x56c23d[_0x2ca5ec(0x21a)]},'data':{'currentPayments':_0xcde9b1,'status':_0x13e24e,'updatedAt':new Date()}}),console[_0x2ca5ec(0x247)]('✅\x20Payment\x20link\x20'+_0x4df50d['id']+_0x2ca5ec(0x1b6)+_0x4df50d['currentPayments']+'\x20->\x20'+_0xcde9b1+',\x20status='+_0x4df50d[_0x2ca5ec(0x241)]+'\x20->\x20'+_0x13e24e);}else console[_0x2ca5ec(0x247)](_0x2ca5ec(0x243)+_0x56c23d['paymentLinkId']+'\x20not\x20found');}catch(_0x238ab9){console[_0x2ca5ec(0x1b3)](_0x2ca5ec(0x211),_0x238ab9);}else console[_0x2ca5ec(0x247)](_0x2ca5ec(0x1ae)+_0x45515a+_0x2ca5ec(0x1bc));}else console['log'](_0x2ca5ec(0x1ae)+_0x45515a+_0x2ca5ec(0x1cb)+_0x46d005+_0x2ca5ec(0x237)+_0x2cd571[_0x2ca5ec(0x1e0)]());});}async[a60_0x4c4a64(0x1f1)](_0x3ff1c3){const _0x1f12a6=a60_0x4c4a64;console[_0x1f12a6(0x247)](_0x1f12a6(0x240),_0x3ff1c3);try{const _0x4931d6=await this[_0x1f12a6(0x207)][_0x1f12a6(0x250)](_0x3ff1c3);if(!_0x4931d6[_0x1f12a6(0x230)])throw new Error(_0x1f12a6(0x200));const _0x3fb3a9=await database_1['default'][_0x1f12a6(0x20a)][_0x1f12a6(0x1ab)]({'where':{'gatewayOrderId':_0x4931d6[_0x1f12a6(0x230)]}});if(!_0x3fb3a9){console['error'](_0x1f12a6(0x198)+_0x4931d6[_0x1f12a6(0x230)]);return;}console[_0x1f12a6(0x247)](_0x1f12a6(0x231)+_0x3fb3a9['id']+_0x1f12a6(0x1fd)+_0x4931d6[_0x1f12a6(0x241)]),await this[_0x1f12a6(0x1fe)](_0x3fb3a9['id'],_0x4931d6['status'],{'txUrls':_0x4931d6[_0x1f12a6(0x1ea)]}),loggerService_1[_0x1f12a6(0x1a8)][_0x1f12a6(0x23c)]('plisio',_0x3fb3a9['id'],_0x3fb3a9[_0x1f12a6(0x241)],_0x4931d6[_0x1f12a6(0x241)],_0x3ff1c3);}catch(_0x308464){console['error'](_0x1f12a6(0x1ff),_0x308464),loggerService_1['loggerService'][_0x1f12a6(0x24e)](_0x1f12a6(0x273),_0x308464,_0x3ff1c3);throw _0x308464;}}async[a60_0x4c4a64(0x1ed)](_0x4c8dfe){const _0x56a2ee=a60_0x4c4a64;console[_0x56a2ee(0x247)](_0x56a2ee(0x255),_0x4c8dfe);try{const _0x611d45=await this[_0x56a2ee(0x207)][_0x56a2ee(0x250)](_0x4c8dfe);if(!_0x611d45[_0x56a2ee(0x230)])throw new Error(_0x56a2ee(0x194));const _0x122b79=await database_1[_0x56a2ee(0x22d)][_0x56a2ee(0x20a)][_0x56a2ee(0x1ab)]({'where':{'gatewayOrderId':_0x611d45[_0x56a2ee(0x230)]}});if(!_0x122b79){console[_0x56a2ee(0x1b3)](_0x56a2ee(0x1b2)+_0x611d45['paymentId']);return;}console[_0x56a2ee(0x247)](_0x56a2ee(0x224)+_0x122b79['id']+_0x56a2ee(0x1fd)+_0x611d45[_0x56a2ee(0x241)]),await this[_0x56a2ee(0x1fe)](_0x122b79['id'],_0x611d45[_0x56a2ee(0x241)],{'txUrls':_0x611d45[_0x56a2ee(0x1ea)]}),loggerService_1[_0x56a2ee(0x1a8)][_0x56a2ee(0x23c)](_0x56a2ee(0x19f),_0x122b79['id'],_0x122b79[_0x56a2ee(0x241)],_0x611d45['status'],_0x4c8dfe);}catch(_0xd00726){console[_0x56a2ee(0x1b3)](_0x56a2ee(0x264),_0xd00726),loggerService_1['loggerService'][_0x56a2ee(0x24e)](_0x56a2ee(0x19f),_0xd00726,_0x4c8dfe);throw _0xd00726;}}async[a60_0x4c4a64(0x219)](_0x2a5379){const _0x2f6744=a60_0x4c4a64;console[_0x2f6744(0x247)]('🔄\x20Processing\x20Rapyd\x20webhook:',_0x2a5379);try{const _0x8000f1=await this['rapydService'][_0x2f6744(0x250)](_0x2a5379);if(!_0x8000f1[_0x2f6744(0x230)])throw new Error(_0x2f6744(0x251));const _0x4f715f=await database_1['default'][_0x2f6744(0x20a)][_0x2f6744(0x1ab)]({'where':{'gatewayOrderId':_0x8000f1[_0x2f6744(0x230)]}});if(!_0x4f715f){console[_0x2f6744(0x1b3)](_0x2f6744(0x1ec)+_0x8000f1[_0x2f6744(0x230)]);return;}console[_0x2f6744(0x247)](_0x2f6744(0x256)+_0x4f715f['id']+_0x2f6744(0x1fd)+_0x8000f1[_0x2f6744(0x241)]),await this[_0x2f6744(0x1fe)](_0x4f715f['id'],_0x8000f1[_0x2f6744(0x241)],{'failureMessage':_0x8000f1['failureMessage'],'cardLast4':_0x8000f1[_0x2f6744(0x210)]?.['cardLast4'],'paymentMethod':_0x8000f1[_0x2f6744(0x210)]?.[_0x2f6744(0x25a)]}),loggerService_1['loggerService']['logWebhookProcessed']('rapyd',_0x4f715f['id'],_0x4f715f[_0x2f6744(0x241)],_0x8000f1[_0x2f6744(0x241)],_0x2a5379);}catch(_0x5e47d9){console[_0x2f6744(0x1b3)]('Error\x20processing\x20Rapyd\x20webhook:',_0x5e47d9),loggerService_1[_0x2f6744(0x1a8)][_0x2f6744(0x24e)]('rapyd',_0x5e47d9,_0x2a5379);throw _0x5e47d9;}}async['processNodaWebhook'](_0x51dfd7){const _0x4a7b12=a60_0x4c4a64;console[_0x4a7b12(0x247)](_0x4a7b12(0x208),_0x51dfd7);try{const _0x5bdf1c=await this[_0x4a7b12(0x229)][_0x4a7b12(0x250)](_0x51dfd7);if(!_0x5bdf1c[_0x4a7b12(0x230)])throw new Error(_0x4a7b12(0x27a));const _0x34fe1a=await database_1['default']['payment'][_0x4a7b12(0x1ab)]({'where':{'gatewayOrderId':_0x5bdf1c[_0x4a7b12(0x230)]}});if(!_0x34fe1a){console['error']('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x5bdf1c[_0x4a7b12(0x230)]);return;}console['log'](_0x4a7b12(0x20f)+_0x34fe1a['id']+_0x4a7b12(0x1fd)+_0x5bdf1c[_0x4a7b12(0x241)]),await this[_0x4a7b12(0x1fe)](_0x34fe1a['id'],_0x5bdf1c[_0x4a7b12(0x241)],{'bankId':_0x5bdf1c[_0x4a7b12(0x210)]?.[_0x4a7b12(0x1e8)],'remitterIban':_0x5bdf1c[_0x4a7b12(0x210)]?.[_0x4a7b12(0x19d)],'remitterName':_0x5bdf1c['additionalInfo']?.[_0x4a7b12(0x20b)]}),loggerService_1[_0x4a7b12(0x1a8)][_0x4a7b12(0x23c)](_0x4a7b12(0x21e),_0x34fe1a['id'],_0x34fe1a[_0x4a7b12(0x241)],_0x5bdf1c[_0x4a7b12(0x241)],_0x51dfd7);}catch(_0x5b1584){console[_0x4a7b12(0x1b3)]('Error\x20processing\x20Noda\x20webhook:',_0x5b1584),loggerService_1[_0x4a7b12(0x1a8)]['logWebhookError'](_0x4a7b12(0x21e),_0x5b1584,_0x51dfd7);throw _0x5b1584;}}async[a60_0x4c4a64(0x228)](_0x51b1b0){const _0x16d793=a60_0x4c4a64;console[_0x16d793(0x247)](_0x16d793(0x226),_0x51b1b0);try{const _0x223c25=await this[_0x16d793(0x1bd)]['processWebhook'](_0x51b1b0);if(!_0x223c25[_0x16d793(0x230)])throw new Error(_0x16d793(0x263));const _0x2838dc=await database_1[_0x16d793(0x22d)][_0x16d793(0x20a)][_0x16d793(0x1ab)]({'where':{'gatewayOrderId':_0x223c25['paymentId']}});if(!_0x2838dc){console[_0x16d793(0x1b3)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x223c25['paymentId']);return;}console[_0x16d793(0x247)](_0x16d793(0x1b7)+_0x2838dc['id']+'\x20status\x20'+_0x223c25['status']),await this['updatePaymentStatus'](_0x2838dc['id'],_0x223c25['status']),loggerService_1[_0x16d793(0x1a8)][_0x16d793(0x23c)](_0x16d793(0x1a2),_0x2838dc['id'],_0x2838dc[_0x16d793(0x241)],_0x223c25['status'],_0x51b1b0);}catch(_0x477a40){console[_0x16d793(0x1b3)](_0x16d793(0x217),_0x477a40),loggerService_1[_0x16d793(0x1a8)]['logWebhookError'](_0x16d793(0x1a2),_0x477a40,_0x51b1b0);throw _0x477a40;}}async['processCoinToPay2Webhook'](_0x349098){const _0x1a40ff=a60_0x4c4a64;console[_0x1a40ff(0x247)]('🔄\x20Processing\x20CoinToPay2\x20webhook:',_0x349098);try{const _0x51bd95=await this[_0x1a40ff(0x1f7)][_0x1a40ff(0x250)](_0x349098);if(!_0x51bd95['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook');const _0x3bee3f=await database_1[_0x1a40ff(0x22d)][_0x1a40ff(0x20a)][_0x1a40ff(0x1ab)]({'where':{'gatewayOrderId':_0x51bd95[_0x1a40ff(0x230)]}});if(!_0x3bee3f){console[_0x1a40ff(0x1b3)]('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x51bd95[_0x1a40ff(0x230)]);return;}console[_0x1a40ff(0x247)](_0x1a40ff(0x266)+_0x3bee3f['id']+'\x20status\x20'+_0x51bd95['status']),await this[_0x1a40ff(0x1fe)](_0x3bee3f['id'],_0x51bd95['status']),loggerService_1[_0x1a40ff(0x1a8)][_0x1a40ff(0x23c)](_0x1a40ff(0x270),_0x3bee3f['id'],_0x3bee3f['status'],_0x51bd95['status'],_0x349098);}catch(_0x3ebefb){console['error'](_0x1a40ff(0x21c),_0x3ebefb),loggerService_1[_0x1a40ff(0x1a8)][_0x1a40ff(0x24e)](_0x1a40ff(0x270),_0x3ebefb,_0x349098);throw _0x3ebefb;}}async[a60_0x4c4a64(0x271)](_0x4586ff){const _0x3cf64f=a60_0x4c4a64;console[_0x3cf64f(0x247)](_0x3cf64f(0x213),_0x4586ff);try{const _0x5bc298=await this[_0x3cf64f(0x225)][_0x3cf64f(0x250)](_0x4586ff);if(!_0x5bc298[_0x3cf64f(0x230)])throw new Error(_0x3cf64f(0x22a));const _0x72e210=await database_1['default'][_0x3cf64f(0x20a)][_0x3cf64f(0x1ab)]({'where':{'gatewayOrderId':_0x5bc298[_0x3cf64f(0x230)]}});if(!_0x72e210){console['error'](_0x3cf64f(0x1e3)+_0x5bc298[_0x3cf64f(0x230)]);return;}console[_0x3cf64f(0x247)](_0x3cf64f(0x1d3)+_0x72e210['id']+_0x3cf64f(0x1fd)+_0x5bc298[_0x3cf64f(0x241)]),await this[_0x3cf64f(0x1fe)](_0x72e210['id'],_0x5bc298[_0x3cf64f(0x241)],{'paymentMethod':_0x5bc298[_0x3cf64f(0x210)]?.[_0x3cf64f(0x22e)]}),loggerService_1[_0x3cf64f(0x1a8)][_0x3cf64f(0x23c)](_0x3cf64f(0x1c9),_0x72e210['id'],_0x72e210[_0x3cf64f(0x241)],_0x5bc298['status'],_0x4586ff);}catch(_0xc19a00){console['error'](_0x3cf64f(0x24a),_0xc19a00),loggerService_1[_0x3cf64f(0x1a8)][_0x3cf64f(0x24e)](_0x3cf64f(0x1c9),_0xc19a00,_0x4586ff);throw _0xc19a00;}}async[a60_0x4c4a64(0x235)](_0x5bc8a4){const _0x4c9853=a60_0x4c4a64;console[_0x4c9853(0x247)](_0x4c9853(0x1a7),JSON[_0x4c9853(0x242)](_0x5bc8a4,null,0x2));try{const _0x58fc82=await this[_0x4c9853(0x201)][_0x4c9853(0x250)](_0x5bc8a4);console[_0x4c9853(0x247)](_0x4c9853(0x1f4),_0x58fc82);if(!_0x58fc82[_0x4c9853(0x230)]){console[_0x4c9853(0x1b3)](_0x4c9853(0x1a4)),console[_0x4c9853(0x1b3)](_0x4c9853(0x1f2),Object[_0x4c9853(0x222)](_0x5bc8a4));throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');}let _0x4f1d77=null;console[_0x4c9853(0x247)](_0x4c9853(0x22f)+_0x58fc82[_0x4c9853(0x230)]);_0x58fc82[_0x4c9853(0x230)]&&(console[_0x4c9853(0x247)]('🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x4f1d77=await database_1['default']['payment'][_0x4c9853(0x1ab)]({'where':{'AND':[{'gateway':'mastercard'},{'OR':[{'gatewayPaymentId':_0x58fc82[_0x4c9853(0x230)]},{'gatewayOrderId':_0x58fc82[_0x4c9853(0x230)]},{'id':_0x58fc82['paymentId']},{'orderId':_0x58fc82[_0x4c9853(0x230)]}]}]}}),console[_0x4c9853(0x247)](_0x4c9853(0x246)+(_0x4f1d77?_0x4c9853(0x25d)+_0x4f1d77['id']:_0x4c9853(0x1a5))));if(!_0x4f1d77){console[_0x4c9853(0x1b3)](_0x4c9853(0x209)+_0x58fc82[_0x4c9853(0x230)]),console[_0x4c9853(0x1b3)](_0x4c9853(0x1ca)+_0x58fc82[_0x4c9853(0x230)]+'\x22,\x20id=\x22'+_0x58fc82[_0x4c9853(0x230)]+_0x4c9853(0x26d)+_0x58fc82[_0x4c9853(0x230)]+'\x22');const _0x407bd4=await database_1[_0x4c9853(0x22d)]['payment'][_0x4c9853(0x1ad)]({'where':{'gateway':_0x4c9853(0x24d)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x4c9853(0x247)](_0x4c9853(0x1f9),_0x407bd4);return;}console[_0x4c9853(0x247)]('✅\x20Found\x20payment\x20'+_0x4f1d77['id']+'\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20'+_0x4f1d77[_0x4c9853(0x241)]+_0x4c9853(0x1c1)+_0x58fc82[_0x4c9853(0x241)]),await this['updatePaymentStatus'](_0x4f1d77['id'],_0x58fc82[_0x4c9853(0x241)]),loggerService_1[_0x4c9853(0x1a8)][_0x4c9853(0x23c)](_0x4c9853(0x24d),_0x4f1d77['id'],_0x4f1d77['status'],_0x58fc82[_0x4c9853(0x241)],_0x5bc8a4);}catch(_0x1149c2){console[_0x4c9853(0x1b3)](_0x4c9853(0x26f),_0x1149c2),loggerService_1[_0x4c9853(0x1a8)][_0x4c9853(0x24e)](_0x4c9853(0x24d),_0x1149c2,_0x5bc8a4);throw _0x1149c2;}}async['processAmerWebhook'](_0x377a11){const _0x11f30d=a60_0x4c4a64;console[_0x11f30d(0x247)]('🔄\x20Processing\x20Amer\x20webhook:',JSON[_0x11f30d(0x242)](_0x377a11,null,0x2));try{const _0x46d5de=await this['amerService']['processWebhook'](_0x377a11);console[_0x11f30d(0x247)]('📊\x20Amer\x20webhook\x20result:',_0x46d5de);if(!_0x46d5de[_0x11f30d(0x230)]){console[_0x11f30d(0x1b3)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data'),console['error'](_0x11f30d(0x1f2),Object[_0x11f30d(0x222)](_0x377a11));throw new Error(_0x11f30d(0x19a));}let _0x1628b5=null;console['log'](_0x11f30d(0x1b5)+_0x46d5de['paymentId']),_0x1628b5=await database_1[_0x11f30d(0x22d)]['payment']['findFirst']({'where':{'AND':[{'gateway':'amer'},{'OR':[{'gatewayPaymentId':_0x46d5de[_0x11f30d(0x230)]},{'gatewayOrderId':_0x46d5de[_0x11f30d(0x230)]},{'id':_0x46d5de['paymentId']},{'orderId':_0x46d5de['paymentId']}]}]}}),console['log'](_0x11f30d(0x246)+(_0x1628b5?_0x11f30d(0x25d)+_0x1628b5['id']:_0x11f30d(0x1a5)));if(!_0x1628b5){console[_0x11f30d(0x1b3)](_0x11f30d(0x1c3)+_0x46d5de['paymentId']);return;}console[_0x11f30d(0x247)](_0x11f30d(0x202)+_0x1628b5['id']+_0x11f30d(0x1fd)+_0x46d5de[_0x11f30d(0x241)]),await this['updatePaymentStatus'](_0x1628b5['id'],_0x46d5de[_0x11f30d(0x241)],{'cardLast4':_0x46d5de[_0x11f30d(0x210)]?.[_0x11f30d(0x233)],'paymentMethod':_0x46d5de[_0x11f30d(0x210)]?.['paymentMethod']});}catch(_0x4fcb4d){console[_0x11f30d(0x1b3)](_0x11f30d(0x1d5),_0x4fcb4d),loggerService_1[_0x11f30d(0x1a8)]['logWebhookError'](_0x11f30d(0x204),_0x4fcb4d,_0x377a11);throw _0x4fcb4d;}}async[a60_0x4c4a64(0x196)](_0x3717f9,_0x2f3af3){const _0x236775=a60_0x4c4a64,_0x5b6c75=Date[_0x236775(0x23e)]();try{const _0x389de9=_0x3717f9[_0x236775(0x1c0)],_0x10cce0=_0x389de9[_0x236775(0x1c2)];if(!_0x10cce0?.[_0x236775(0x262)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x389de9['id']);return;}const _0x4d4c5c=_0x2f3af3===_0x236775(0x1a6)?_0x236775(0x223):_0x2f3af3==='FAILED'?_0x236775(0x252):_0x2f3af3===_0x236775(0x279)?_0x236775(0x252):_0x2f3af3===_0x236775(0x1de)?'payment.failed':_0x2f3af3===_0x236775(0x1c6)?_0x236775(0x252):'payment.pending';let _0x2635f3=[];if(_0x10cce0[_0x236775(0x23a)])try{_0x2635f3=Array[_0x236775(0x203)](_0x10cce0[_0x236775(0x23a)])?_0x10cce0['webhookEvents']:JSON[_0x236775(0x1cf)](_0x10cce0[_0x236775(0x23a)]);}catch(_0x248c82){console['error'](_0x236775(0x1f0),_0x248c82),_0x2635f3=[];}if(!_0x2635f3[_0x236775(0x276)](_0x4d4c5c)){console[_0x236775(0x247)](_0x236775(0x1aa)+_0x4d4c5c+_0x236775(0x1c7)+_0x389de9['id']);return;}const _0x4a25e4={'event':_0x4d4c5c,'payment':{'id':_0x3717f9['id'],'order_id':_0x3717f9[_0x236775(0x197)],'gateway_order_id':_0x3717f9[_0x236775(0x1c4)],'gateway':_0x3717f9['gateway'],'amount':_0x3717f9[_0x236775(0x1fa)],'currency':_0x3717f9[_0x236775(0x1ee)],'status':_0x2f3af3[_0x236775(0x25f)](),'customer_email':_0x3717f9[_0x236775(0x1cd)],'customer_name':_0x3717f9[_0x236775(0x1c8)],'failure_message':_0x3717f9[_0x236775(0x25c)],'tx_urls':_0x3717f9[_0x236775(0x1ea)]?JSON['parse'](_0x3717f9[_0x236775(0x1ea)]):null,'created_at':_0x3717f9[_0x236775(0x23f)],'updated_at':_0x3717f9[_0x236775(0x21f)]}},_0x52c744=await fetch(_0x10cce0[_0x236775(0x262)],{'method':_0x236775(0x1cc),'headers':{'Content-Type':_0x236775(0x259),'User-Agent':_0x236775(0x253)},'body':JSON['stringify'](_0x4a25e4)}),_0x546d1b=Date[_0x236775(0x23e)]()-_0x5b6c75,_0x1ba29b=_0x52c744['ok']?_0x236775(0x267):await _0x52c744[_0x236775(0x23b)]();loggerService_1['loggerService'][_0x236775(0x1a0)](_0x3717f9[_0x236775(0x239)],_0x10cce0[_0x236775(0x262)],_0x4d4c5c,_0x52c744[_0x236775(0x241)],_0x546d1b,_0x4a25e4),console[_0x236775(0x247)]('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x10cce0[_0x236775(0x262)]+'\x20with\x20status\x20'+_0x52c744['status']+'\x20('+_0x546d1b+_0x236775(0x1b4));}catch(_0x57a3a9){console[_0x236775(0x1b3)](_0x236775(0x24c),_0x57a3a9),loggerService_1[_0x236775(0x1a8)][_0x236775(0x1b1)](_0x3717f9[_0x236775(0x239)],_0x3717f9[_0x236775(0x1c0)]?.[_0x236775(0x1c2)]?.['webhookUrl']||_0x236775(0x1da),_0x236775(0x1b8),_0x57a3a9,{});}}async['sendPaymentStatusNotification'](_0x3f0c2c,_0x50a300){const _0x4d2eb2=a60_0x4c4a64;try{const _0x5c4882={'PENDING':_0x4d2eb2(0x1dd),'PROCESSING':'processing','PAID':'paid','FAILED':_0x4d2eb2(0x215),'EXPIRED':_0x4d2eb2(0x220),'REFUND':'refund','CHARGEBACK':_0x4d2eb2(0x1d6)},_0x311202=_0x5c4882[_0x50a300];if(!_0x311202||_0x311202===_0x4d2eb2(0x1dd))return;await telegramBotService_1[_0x4d2eb2(0x19b)]['sendPaymentNotification'](_0x3f0c2c['shopId'],_0x3f0c2c,_0x311202);}catch(_0x4df9b5){console[_0x4d2eb2(0x1b3)](_0x4d2eb2(0x1dc),_0x4df9b5);}}async[a60_0x4c4a64(0x269)](_0x3ff15c,_0x1aaf86){const _0x337026=a60_0x4c4a64;try{const _0x38365e=await database_1['default'][_0x337026(0x1c0)][_0x337026(0x1c5)]({'where':{'id':_0x3ff15c},'select':{'gatewaySettings':!![]}});if(!_0x38365e?.['gatewaySettings'])return console[_0x337026(0x247)](_0x337026(0x20c)+_0x3ff15c+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x144495=JSON['parse'](_0x38365e['gatewaySettings']);for(const [_0x4057a0,_0x1f0969]of Object[_0x337026(0x1d8)](_0x144495)){if(_0x4057a0['toLowerCase']()===_0x1aaf86[_0x337026(0x25f)]()){const _0x243d02=_0x1f0969[_0x337026(0x23d)]||0xa;return console[_0x337026(0x247)]('Gateway\x20'+_0x1aaf86+_0x337026(0x1e2)+_0x3ff15c+':\x20'+_0x243d02+'%'),_0x243d02;}}return console[_0x337026(0x247)](_0x337026(0x1fb)+_0x1aaf86+_0x337026(0x248)+_0x3ff15c+',\x20using\x20default\x2010%'),0xa;}catch(_0x5c4078){return console[_0x337026(0x1b3)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x3ff15c+_0x337026(0x236)+_0x1aaf86+':',_0x5c4078),0xa;}}}exports[a60_0x4c4a64(0x1af)]=WebhookService;