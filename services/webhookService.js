'use strict';const a69_0x558331=a69_0x500a;(function(_0x52327a,_0x36d861){const _0x2f4280=a69_0x500a,_0x26607b=_0x52327a();while(!![]){try{const _0x1228cd=parseInt(_0x2f4280(0xe8))/0x1*(-parseInt(_0x2f4280(0x189))/0x2)+parseInt(_0x2f4280(0x9f))/0x3+parseInt(_0x2f4280(0x133))/0x4+parseInt(_0x2f4280(0x6a))/0x5+-parseInt(_0x2f4280(0x1a7))/0x6+parseInt(_0x2f4280(0xe2))/0x7+-parseInt(_0x2f4280(0x187))/0x8*(parseInt(_0x2f4280(0xc2))/0x9);if(_0x1228cd===_0x36d861)break;else _0x26607b['push'](_0x26607b['shift']());}catch(_0x308bb9){_0x26607b['push'](_0x26607b['shift']());}}}(a69_0x556d,0x2a709));function a69_0x500a(_0x63ba56,_0x4b5136){const _0x556dcd=a69_0x556d();return a69_0x500a=function(_0x500a80,_0x31dd8d){_0x500a80=_0x500a80-0x67;let _0x2c836d=_0x556dcd[_0x500a80];return _0x2c836d;},a69_0x500a(_0x63ba56,_0x4b5136);}var __importDefault=this&&this[a69_0x558331(0x147)]||function(_0x4edfc2){const _0xe51c0f=a69_0x558331;return _0x4edfc2&&_0x4edfc2[_0xe51c0f(0x1a3)]?_0x4edfc2:{'default':_0x4edfc2};};Object[a69_0x558331(0x17e)](exports,a69_0x558331(0x1a3),{'value':!![]}),exports[a69_0x558331(0xdb)]=void 0x0;const database_1=__importDefault(require(a69_0x558331(0x13c))),plisioService_1=require(a69_0x558331(0x166)),rapydService_1=require(a69_0x558331(0xdd)),nodaService_1=require(a69_0x558331(0xa5)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a69_0x558331(0x17c)),klymeService_1=require(a69_0x558331(0xee)),mastercardService_1=require('./gateways/mastercardService'),amerService_1=require(a69_0x558331(0x162)),ampayService_1=require('./gateways/ampayService'),ampayTRYService_1=require(a69_0x558331(0x7b)),telegramBotService_1=require('./telegramBotService'),currencyService_1=require('./currencyService'),loggerService_1=require(a69_0x558331(0x10a));class WebhookService{constructor(){const _0x4e2068=a69_0x558331;this[_0x4e2068(0xd7)]=new plisioService_1[(_0x4e2068(0x81))](),this[_0x4e2068(0x9a)]=new rapydService_1[(_0x4e2068(0x130))](),this[_0x4e2068(0x8c)]=new nodaService_1[(_0x4e2068(0x89))](),this[_0x4e2068(0x139)]=new coinToPayService_1[(_0x4e2068(0xfe))](),this[_0x4e2068(0x1a8)]=new coinToPay2Service_1[(_0x4e2068(0x123))](),this['klymeService']=new klymeService_1[(_0x4e2068(0xde))](),this[_0x4e2068(0xcd)]=new mastercardService_1[(_0x4e2068(0x11c))](),this[_0x4e2068(0x91)]=new amerService_1[(_0x4e2068(0x78))](),this['ampayService']=new ampayService_1['AmPayService'](),this[_0x4e2068(0x14e)]=new ampayTRYService_1[(_0x4e2068(0x12e))]();}async[a69_0x558331(0x18a)](_0x4f865c,_0x2f9918,_0x5e9d32){const _0x22110d=a69_0x558331;console[_0x22110d(0x104)](_0x22110d(0x88)+_0x4f865c+_0x22110d(0xe0)+_0x2f9918),console[_0x22110d(0x104)]('üîÑ\x20Additional\x20data:',_0x5e9d32),await database_1[_0x22110d(0x119)]['$transaction'](async _0x2ffa20=>{const _0x5c2508=_0x22110d,_0x2a25b1=await _0x2ffa20[_0x5c2508(0xfb)][_0x5c2508(0xb6)]({'where':{'id':_0x4f865c},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2a25b1)throw new Error(_0x5c2508(0x108)+_0x4f865c+_0x5c2508(0x82));const _0x52f839=_0x2a25b1['status'],_0x3602e8=_0x2a25b1[_0x5c2508(0xf3)];console[_0x5c2508(0x104)](_0x5c2508(0x13f)+_0x4f865c+':\x20'+_0x52f839+_0x5c2508(0x121)+_0x2f9918),console[_0x5c2508(0x104)](_0x5c2508(0xef)+_0x3602e8['username']+_0x5c2508(0x100)+_0x3602e8['balance']+'\x20USDT');const _0x470d28={'status':_0x2f9918['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x5c2508(0x199),'statusChangedAt':new Date()};_0x5e9d32?.[_0x5c2508(0x182)]&&(_0x470d28[_0x5c2508(0x182)]=_0x5e9d32[_0x5c2508(0x182)]);_0x5e9d32?.[_0x5c2508(0x68)]&&(_0x470d28[_0x5c2508(0x68)]=JSON['stringify'](_0x5e9d32[_0x5c2508(0x68)]));_0x5e9d32?.[_0x5c2508(0x184)]&&(_0x470d28[_0x5c2508(0x184)]=_0x5e9d32[_0x5c2508(0x184)]);_0x5e9d32?.[_0x5c2508(0xc7)]&&(_0x470d28['paymentMethod']=_0x5e9d32[_0x5c2508(0xc7)]);_0x5e9d32?.[_0x5c2508(0x80)]&&(_0x470d28[_0x5c2508(0x80)]=_0x5e9d32[_0x5c2508(0x80)]);_0x5e9d32?.[_0x5c2508(0x10b)]&&(_0x470d28['remitterIban']=_0x5e9d32['remitterIban']);_0x5e9d32?.[_0x5c2508(0x15a)]&&(_0x470d28[_0x5c2508(0x15a)]=_0x5e9d32[_0x5c2508(0x15a)]);let _0x276091=_0x3602e8[_0x5c2508(0x190)],_0x253338='';if(_0x2f9918[_0x5c2508(0x192)]()===_0x5c2508(0xed)&&_0x52f839!==_0x5c2508(0xed)){const _0x2982db=await currencyService_1['currencyService'][_0x5c2508(0x74)](_0x2a25b1[_0x5c2508(0x188)],_0x2a25b1[_0x5c2508(0x163)]),_0x4a02b6=await this[_0x5c2508(0x17a)](_0x3602e8['id'],_0x2a25b1['gateway']),_0x417c19=_0x2982db*(0x1-_0x4a02b6/0x64);_0x276091+=_0x417c19,_0x253338='+'+_0x417c19['toFixed'](0x6)+_0x5c2508(0x18e)+_0x4a02b6+_0x5c2508(0x195),_0x470d28[_0x5c2508(0xac)]=_0x2982db,_0x470d28[_0x5c2508(0x114)]=_0x417c19,_0x470d28[_0x5c2508(0x110)]=_0x4a02b6,_0x470d28['paidAt']=new Date(),console[_0x5c2508(0x104)](_0x5c2508(0x70)+_0x2a25b1[_0x5c2508(0x188)]+'\x20'+_0x2a25b1[_0x5c2508(0x163)]+_0x5c2508(0x121)+_0x2982db[_0x5c2508(0x128)](0x6)+_0x5c2508(0x96)),console[_0x5c2508(0x104)](_0x5c2508(0xb8)+_0x2a25b1['gateway']+'\x20commission:\x20'+_0x4a02b6+'%'),console['log']('üí∞\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x417c19[_0x5c2508(0x128)](0x6)+_0x5c2508(0x96)),console[_0x5c2508(0x104)](_0x5c2508(0xc9)+_0x3602e8[_0x5c2508(0x190)]+_0x5c2508(0xb5)+_0x417c19['toFixed'](0x6)+'\x20=\x20'+_0x276091[_0x5c2508(0x128)](0x6)+_0x5c2508(0x96));}else{if(_0x52f839===_0x5c2508(0xed)&&_0x2f9918['toUpperCase']()!==_0x5c2508(0xed)&&_0x2f9918[_0x5c2508(0x192)]()!==_0x5c2508(0x157)){let _0x2a665c;if(_0x2a25b1['amountAfterGatewayCommissionUSDT'])_0x2a665c=_0x2a25b1['amountAfterGatewayCommissionUSDT'];else{if(_0x2a25b1[_0x5c2508(0xac)]){const _0x10e6cb=await this[_0x5c2508(0x17a)](_0x3602e8['id'],_0x2a25b1[_0x5c2508(0x177)]);_0x2a665c=_0x2a25b1[_0x5c2508(0xac)]*(0x1-_0x10e6cb/0x64);}else console[_0x5c2508(0x104)](_0x5c2508(0xb4)),_0x2a665c=0x0;}_0x2a665c>0x0&&(_0x276091-=_0x2a665c,_0x253338='-'+_0x2a665c[_0x5c2508(0x128)](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x470d28[_0x5c2508(0x155)]=null,console[_0x5c2508(0x104)]('üí∞\x20Removing\x20from\x20balance:\x20'+_0x3602e8[_0x5c2508(0x190)]+_0x5c2508(0x15b)+_0x2a665c['toFixed'](0x6)+_0x5c2508(0x71)+_0x276091[_0x5c2508(0x128)](0x6)+_0x5c2508(0x96)));}}if(_0x2f9918[_0x5c2508(0x192)]()===_0x5c2508(0x157)){const _0x2d01b0=_0x5e9d32?.['chargebackAmount']||0x0;console['log'](_0x5c2508(0x191)),_0x2d01b0>0x0?(_0x276091-=_0x2d01b0,_0x253338='-'+_0x2d01b0[_0x5c2508(0x128)](0x6)+_0x5c2508(0x9b),_0x470d28[_0x5c2508(0x12d)]=_0x2d01b0,console[_0x5c2508(0x104)]('üí∏\x20CHARGEBACK\x20penalty\x20ONLY:\x20-'+_0x2d01b0[_0x5c2508(0x128)](0x6)+_0x5c2508(0x96)),console[_0x5c2508(0x104)](_0x5c2508(0xa7)),console[_0x5c2508(0x104)](_0x5c2508(0xdc)+_0x276091[_0x5c2508(0x128)](0x6)+_0x5c2508(0x96))):(console['log'](_0x5c2508(0xe5)),_0x253338='Payment\x20marked\x20as\x20CHARGEBACK\x20(no\x20penalty\x20specified)');}const _0x27ccd0=await _0x2ffa20['payment'][_0x5c2508(0x73)]({'where':{'id':_0x4f865c},'data':_0x470d28});_0x276091!==_0x3602e8[_0x5c2508(0x190)]&&(await _0x2ffa20['shop'][_0x5c2508(0x73)]({'where':{'id':_0x3602e8['id']},'data':{'balance':_0x276091}}),console[_0x5c2508(0x104)](_0x5c2508(0x19b)+_0x3602e8[_0x5c2508(0x6e)]+_0x5c2508(0x103)+_0x3602e8['balance']['toFixed'](0x6)+'\x20->\x20'+_0x276091[_0x5c2508(0x128)](0x6)+'\x20USDT'),console[_0x5c2508(0x104)](_0x5c2508(0xcb)+_0x253338));await _0x2ffa20['webhookLog'][_0x5c2508(0xbd)]({'data':{'paymentId':_0x4f865c,'shopId':_0x3602e8['id'],'event':_0x5c2508(0xf9)+_0x2f9918[_0x5c2508(0x12c)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x52f839,'newStatus':_0x2f9918[_0x5c2508(0x192)](),'balanceChange':_0x253338||_0x5c2508(0xc3),'oldBalance':_0x3602e8[_0x5c2508(0x190)],'newBalance':_0x276091,'amountUSDT':_0x470d28[_0x5c2508(0xac)],'additionalData':_0x5e9d32,'timestamp':new Date()[_0x5c2508(0x172)]()})}}),await this[_0x5c2508(0xba)]({..._0x2a25b1,..._0x27ccd0,'shop':_0x3602e8},_0x2f9918['toUpperCase']()),await this[_0x5c2508(0x1ab)]({..._0x2a25b1,..._0x27ccd0},_0x2f9918[_0x5c2508(0x192)]());if(_0x52f839!==_0x5c2508(0xed)&&_0x2f9918[_0x5c2508(0x192)]()==='PAID'){console['log']('üìà\x20Payment\x20'+_0x4f865c+_0x5c2508(0x16b)),console[_0x5c2508(0x104)]('üìà\x20Payment\x20details:\x20oldStatus=\x22'+_0x52f839+_0x5c2508(0x6f)+_0x2f9918[_0x5c2508(0x192)]()+_0x5c2508(0xfa)+_0x2a25b1[_0x5c2508(0x198)]+'\x22');if(_0x2a25b1[_0x5c2508(0x198)])try{const _0x55b2b7=await _0x2ffa20[_0x5c2508(0xd2)]['findUnique']({'where':{'id':_0x2a25b1[_0x5c2508(0x198)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x55b2b7){console[_0x5c2508(0x104)](_0x5c2508(0x173)+_0x55b2b7['id']+_0x5c2508(0x194)+_0x55b2b7['type']+_0x5c2508(0xa3)+_0x55b2b7['currentPayments']+_0x5c2508(0xa9)+_0x55b2b7[_0x5c2508(0xf5)]);const _0x11f138=_0x55b2b7[_0x5c2508(0x149)]+0x1,_0x27c29d=_0x55b2b7[_0x5c2508(0x19d)]===_0x5c2508(0x185)?_0x5c2508(0x12a):_0x55b2b7['status'];await _0x2ffa20[_0x5c2508(0xd2)]['update']({'where':{'id':_0x2a25b1[_0x5c2508(0x198)]},'data':{'currentPayments':_0x11f138,'status':_0x27c29d,'updatedAt':new Date()}}),console[_0x5c2508(0x104)](_0x5c2508(0x170)+_0x55b2b7['id']+'\x20updated:\x20currentPayments='+_0x55b2b7[_0x5c2508(0x149)]+'\x20->\x20'+_0x11f138+',\x20status='+_0x55b2b7[_0x5c2508(0xf5)]+_0x5c2508(0x121)+_0x27c29d);}else console[_0x5c2508(0x104)]('‚ùå\x20Payment\x20link\x20'+_0x2a25b1[_0x5c2508(0x198)]+_0x5c2508(0x82));}catch(_0x12aee4){console[_0x5c2508(0xe1)](_0x5c2508(0x15e),_0x12aee4);}else console[_0x5c2508(0x104)](_0x5c2508(0xaf)+_0x4f865c+_0x5c2508(0x126));}else console[_0x5c2508(0x104)](_0x5c2508(0xaf)+_0x4f865c+_0x5c2508(0x14c)+_0x52f839+_0x5c2508(0x121)+_0x2f9918[_0x5c2508(0x192)]());});}async[a69_0x558331(0x1a4)](_0x3e5386){const _0x4a0972=a69_0x558331;console[_0x4a0972(0x104)](_0x4a0972(0xaa),_0x3e5386);try{const _0x43c72a=await this[_0x4a0972(0xd7)][_0x4a0972(0x7a)](_0x3e5386);if(!_0x43c72a[_0x4a0972(0x179)])throw new Error(_0x4a0972(0x16a));const _0x2f690e=await database_1['default'][_0x4a0972(0xfb)]['findFirst']({'where':{'gatewayOrderId':_0x43c72a[_0x4a0972(0x179)]}});if(!_0x2f690e){console[_0x4a0972(0xe1)](_0x4a0972(0xf1)+_0x43c72a[_0x4a0972(0x179)]);return;}console['log'](_0x4a0972(0xa4)+_0x2f690e['id']+_0x4a0972(0x138)+_0x43c72a[_0x4a0972(0xf5)]),await this['updatePaymentStatus'](_0x2f690e['id'],_0x43c72a[_0x4a0972(0xf5)],{'txUrls':_0x43c72a[_0x4a0972(0x68)]}),loggerService_1[_0x4a0972(0xca)]['logWebhookProcessed'](_0x4a0972(0x143),_0x2f690e['id'],_0x2f690e[_0x4a0972(0xf5)],_0x43c72a[_0x4a0972(0xf5)],_0x3e5386);}catch(_0x463519){console[_0x4a0972(0xe1)](_0x4a0972(0x1a5),_0x463519),loggerService_1[_0x4a0972(0xca)][_0x4a0972(0x160)](_0x4a0972(0x143),_0x463519,_0x3e5386);throw _0x463519;}}async[a69_0x558331(0x17b)](_0x1c1b7e){const _0x217c69=a69_0x558331;console[_0x217c69(0x104)](_0x217c69(0x116),_0x1c1b7e);try{const _0x2e4368=await this[_0x217c69(0xd7)][_0x217c69(0x7a)](_0x1c1b7e);if(!_0x2e4368[_0x217c69(0x179)])throw new Error(_0x217c69(0x1a2));const _0x27db77=await database_1['default'][_0x217c69(0xfb)][_0x217c69(0x144)]({'where':{'gatewayOrderId':_0x2e4368[_0x217c69(0x179)]}});if(!_0x27db77){console[_0x217c69(0xe1)]('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x2e4368[_0x217c69(0x179)]);return;}console[_0x217c69(0x104)](_0x217c69(0x9e)+_0x27db77['id']+'\x20status\x20'+_0x2e4368['status']),await this[_0x217c69(0x18a)](_0x27db77['id'],_0x2e4368[_0x217c69(0xf5)],{'txUrls':_0x2e4368[_0x217c69(0x68)]}),loggerService_1['loggerService']['logWebhookProcessed'](_0x217c69(0x17d),_0x27db77['id'],_0x27db77[_0x217c69(0xf5)],_0x2e4368[_0x217c69(0xf5)],_0x1c1b7e);}catch(_0x3d1541){console['error'](_0x217c69(0xa0),_0x3d1541),loggerService_1['loggerService']['logWebhookError'](_0x217c69(0x17d),_0x3d1541,_0x1c1b7e);throw _0x3d1541;}}async[a69_0x558331(0x1ac)](_0x5d8ea0){const _0x323972=a69_0x558331;console[_0x323972(0x104)](_0x323972(0xeb),_0x5d8ea0);try{const _0x5d9f48=await this[_0x323972(0x9a)][_0x323972(0x7a)](_0x5d8ea0);if(!_0x5d9f48[_0x323972(0x179)])throw new Error(_0x323972(0xb9));const _0x48afa4=await database_1[_0x323972(0x119)][_0x323972(0xfb)][_0x323972(0x144)]({'where':{'gatewayOrderId':_0x5d9f48[_0x323972(0x179)]}});if(!_0x48afa4){console[_0x323972(0xe1)](_0x323972(0x11f)+_0x5d9f48[_0x323972(0x179)]);return;}console[_0x323972(0x104)](_0x323972(0x148)+_0x48afa4['id']+_0x323972(0x138)+_0x5d9f48[_0x323972(0xf5)]),await this[_0x323972(0x18a)](_0x48afa4['id'],_0x5d9f48[_0x323972(0xf5)],{'failureMessage':_0x5d9f48['failureMessage'],'cardLast4':_0x5d9f48[_0x323972(0x84)]?.[_0x323972(0x184)],'paymentMethod':_0x5d9f48[_0x323972(0x84)]?.['paymentMethod']}),loggerService_1[_0x323972(0xca)]['logWebhookProcessed'](_0x323972(0x7e),_0x48afa4['id'],_0x48afa4[_0x323972(0xf5)],_0x5d9f48[_0x323972(0xf5)],_0x5d8ea0);}catch(_0x495bd3){console[_0x323972(0xe1)](_0x323972(0x16d),_0x495bd3),loggerService_1[_0x323972(0xca)][_0x323972(0x160)](_0x323972(0x7e),_0x495bd3,_0x5d8ea0);throw _0x495bd3;}}async[a69_0x558331(0xce)](_0x193c49){const _0x432a83=a69_0x558331;console[_0x432a83(0x104)](_0x432a83(0x1a6),_0x193c49);try{const _0x342062=await this['nodaService'][_0x432a83(0x7a)](_0x193c49);if(!_0x342062['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Noda\x20webhook');const _0x5d62f6=await database_1[_0x432a83(0x119)][_0x432a83(0xfb)]['findFirst']({'where':{'gatewayOrderId':_0x342062[_0x432a83(0x179)]}});if(!_0x5d62f6){console[_0x432a83(0xe1)](_0x432a83(0xab)+_0x342062['paymentId']);return;}console[_0x432a83(0x104)](_0x432a83(0x11e)+_0x5d62f6['id']+'\x20status\x20'+_0x342062[_0x432a83(0xf5)]),await this[_0x432a83(0x18a)](_0x5d62f6['id'],_0x342062['status'],{'bankId':_0x342062[_0x432a83(0x84)]?.[_0x432a83(0x80)],'remitterIban':_0x342062[_0x432a83(0x84)]?.[_0x432a83(0x10b)],'remitterName':_0x342062[_0x432a83(0x84)]?.[_0x432a83(0x15a)]}),loggerService_1[_0x432a83(0xca)][_0x432a83(0x86)]('noda',_0x5d62f6['id'],_0x5d62f6[_0x432a83(0xf5)],_0x342062[_0x432a83(0xf5)],_0x193c49);}catch(_0x1eced2){console[_0x432a83(0xe1)](_0x432a83(0x14a),_0x1eced2),loggerService_1['loggerService'][_0x432a83(0x160)](_0x432a83(0x158),_0x1eced2,_0x193c49);throw _0x1eced2;}}async[a69_0x558331(0x1a1)](_0x4e44c6){const _0x491b52=a69_0x558331;console[_0x491b52(0x104)](_0x491b52(0x178),_0x4e44c6);try{const _0x1f1842=await this[_0x491b52(0x139)]['processWebhook'](_0x4e44c6);if(!_0x1f1842['paymentId'])throw new Error(_0x491b52(0x18f));const _0x1c63b7=await database_1[_0x491b52(0x119)][_0x491b52(0xfb)][_0x491b52(0x144)]({'where':{'gatewayOrderId':_0x1f1842[_0x491b52(0x179)]}});if(!_0x1c63b7){console[_0x491b52(0xe1)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x1f1842[_0x491b52(0x179)]);return;}console[_0x491b52(0x104)](_0x491b52(0x1a9)+_0x1c63b7['id']+_0x491b52(0x138)+_0x1f1842[_0x491b52(0xf5)]),await this[_0x491b52(0x18a)](_0x1c63b7['id'],_0x1f1842[_0x491b52(0xf5)]),loggerService_1['loggerService'][_0x491b52(0x86)](_0x491b52(0x18c),_0x1c63b7['id'],_0x1c63b7[_0x491b52(0xf5)],_0x1f1842[_0x491b52(0xf5)],_0x4e44c6);}catch(_0x47dc6f){console[_0x491b52(0xe1)](_0x491b52(0xe9),_0x47dc6f),loggerService_1[_0x491b52(0xca)]['logWebhookError']('cointopay',_0x47dc6f,_0x4e44c6);throw _0x47dc6f;}}async[a69_0x558331(0x16f)](_0x6112e5){const _0x367a9c=a69_0x558331;console[_0x367a9c(0x104)](_0x367a9c(0x165),_0x6112e5);try{const _0x31f2c9=await this[_0x367a9c(0x1a8)]['processWebhook'](_0x6112e5);if(!_0x31f2c9[_0x367a9c(0x179)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook');const _0x27cc49=await database_1[_0x367a9c(0x119)][_0x367a9c(0xfb)][_0x367a9c(0x144)]({'where':{'gatewayOrderId':_0x31f2c9[_0x367a9c(0x179)]}});if(!_0x27cc49){console['error']('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x31f2c9[_0x367a9c(0x179)]);return;}console[_0x367a9c(0x104)]('üìä\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x27cc49['id']+_0x367a9c(0x138)+_0x31f2c9[_0x367a9c(0xf5)]),await this['updatePaymentStatus'](_0x27cc49['id'],_0x31f2c9['status']),loggerService_1[_0x367a9c(0xca)][_0x367a9c(0x86)](_0x367a9c(0xd6),_0x27cc49['id'],_0x27cc49[_0x367a9c(0xf5)],_0x31f2c9[_0x367a9c(0xf5)],_0x6112e5);}catch(_0x308705){console['error'](_0x367a9c(0xc0),_0x308705),loggerService_1['loggerService'][_0x367a9c(0x160)](_0x367a9c(0xd6),_0x308705,_0x6112e5);throw _0x308705;}}async[a69_0x558331(0xad)](_0x3f33e5){const _0x1235ad=a69_0x558331;console[_0x1235ad(0x104)](_0x1235ad(0x134),_0x3f33e5);try{const _0x278956=await this[_0x1235ad(0x9c)]['processWebhook'](_0x3f33e5);if(!_0x278956[_0x1235ad(0x179)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x1e57f4=await database_1['default'][_0x1235ad(0xfb)][_0x1235ad(0x144)]({'where':{'gatewayOrderId':_0x278956['paymentId']}});if(!_0x1e57f4){console[_0x1235ad(0xe1)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x278956[_0x1235ad(0x179)]);return;}console[_0x1235ad(0x104)]('üìä\x20KLYME\x20webhook:\x20Payment\x20'+_0x1e57f4['id']+_0x1235ad(0x138)+_0x278956[_0x1235ad(0xf5)]),await this['updatePaymentStatus'](_0x1e57f4['id'],_0x278956[_0x1235ad(0xf5)],{'paymentMethod':_0x278956[_0x1235ad(0x84)]?.['payment_method']}),loggerService_1[_0x1235ad(0xca)][_0x1235ad(0x86)]('klyme',_0x1e57f4['id'],_0x1e57f4[_0x1235ad(0xf5)],_0x278956[_0x1235ad(0xf5)],_0x3f33e5);}catch(_0x3b4b7d){console[_0x1235ad(0xe1)](_0x1235ad(0xf0),_0x3b4b7d),loggerService_1[_0x1235ad(0xca)][_0x1235ad(0x160)](_0x1235ad(0xe7),_0x3b4b7d,_0x3f33e5);throw _0x3b4b7d;}}async[a69_0x558331(0x136)](_0x40ad48){const _0x41efde=a69_0x558331;console[_0x41efde(0x104)](_0x41efde(0x15f),JSON[_0x41efde(0x171)](_0x40ad48,null,0x2));try{const _0x2b06ef=await this[_0x41efde(0xcd)][_0x41efde(0x7a)](_0x40ad48,_0x41efde(0x112));console[_0x41efde(0x104)](_0x41efde(0xa6),_0x2b06ef);if(!_0x2b06ef[_0x41efde(0x179)]){console[_0x41efde(0xe1)](_0x41efde(0xb2)),console[_0x41efde(0xe1)](_0x41efde(0xbf),Object[_0x41efde(0xc1)](_0x40ad48));throw new Error(_0x41efde(0xbe));}let _0x4355d0=null;console[_0x41efde(0x104)]('üîç\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x2b06ef[_0x41efde(0x179)]);if(_0x2b06ef[_0x41efde(0x179)]){console['log'](_0x41efde(0x181)),console[_0x41efde(0x104)]('üîç\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:'),console[_0x41efde(0x104)]('\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard'),console[_0x41efde(0x104)]('\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20'+_0x2b06ef[_0x41efde(0x179)]),console[_0x41efde(0x104)]('\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId'),_0x4355d0=await database_1[_0x41efde(0x119)]['payment'][_0x41efde(0x144)]({'where':{'AND':[{'OR':[{'gateway':_0x41efde(0x115)},{'gateway':_0x41efde(0xf4)}]},{'OR':[{'gatewayPaymentId':_0x2b06ef[_0x41efde(0x179)]},{'gatewayOrderId':_0x2b06ef[_0x41efde(0x179)]},{'id':_0x2b06ef[_0x41efde(0x179)]},{'orderId':_0x2b06ef[_0x41efde(0x179)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x41efde(0x104)](_0x41efde(0x99));if(_0x4355d0)console[_0x41efde(0x104)](_0x41efde(0xb3)+_0x4355d0['id']+_0x41efde(0x156)+_0x4355d0[_0x41efde(0x8a)]+_0x41efde(0x10f)+_0x4355d0[_0x41efde(0x154)]);else{console[_0x41efde(0x104)](_0x41efde(0xd4));const _0xf6ade8=await database_1['default'][_0x41efde(0xfb)]['findMany']({'where':{'gateway':'visa/mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':'desc'}});console['log'](_0x41efde(0x6d),_0xf6ade8[_0x41efde(0x167)](_0x3a228b=>_0x3a228b['id']+_0x41efde(0xc5)+_0x3a228b[_0x41efde(0x196)]+_0x41efde(0x90)+_0x3a228b[_0x41efde(0x8a)]+',\x20gatewayPaymentId:\x20'+_0x3a228b[_0x41efde(0x154)]+_0x41efde(0x16c)+_0x3a228b[_0x41efde(0x184)]+')'));}console[_0x41efde(0x104)](_0x41efde(0x159)+(_0x4355d0?_0x41efde(0x146):_0x41efde(0x67))),_0x4355d0&&console[_0x41efde(0x104)](_0x41efde(0x19c)+_0x4355d0['id']+_0x41efde(0x16e)+_0x4355d0[_0x41efde(0x177)]+_0x41efde(0x77)+_0x4355d0['status']+_0x41efde(0x176)+_0x4355d0[_0x41efde(0x184)]);}if(!_0x4355d0){console[_0x41efde(0xe1)](_0x41efde(0x95)+_0x2b06ef[_0x41efde(0x179)]),loggerService_1[_0x41efde(0xca)][_0x41efde(0x160)](_0x41efde(0xcf),new Error(_0x41efde(0xdf)+_0x2b06ef[_0x41efde(0x179)]),_0x40ad48);throw new Error(_0x41efde(0x137)+_0x2b06ef[_0x41efde(0x179)]);}console[_0x41efde(0x104)]('üìä\x20VISA\x20payment\x20found:\x20'+_0x4355d0['id']+_0x41efde(0x169)+_0x4355d0[_0x41efde(0xf5)]+_0x41efde(0x75)+_0x2b06ef[_0x41efde(0xf5)]+')');const _0x56f3fb={};_0x2b06ef['amount']&&await database_1[_0x41efde(0x119)][_0x41efde(0xfb)][_0x41efde(0x73)]({'where':{'id':_0x4355d0['id']},'data':{'amount':_0x2b06ef[_0x41efde(0x188)],'updatedAt':new Date()}}),_0x2b06ef[_0x41efde(0x163)]&&await database_1[_0x41efde(0x119)][_0x41efde(0xfb)]['update']({'where':{'id':_0x4355d0['id']},'data':{'currency':_0x2b06ef[_0x41efde(0x163)],'updatedAt':new Date()}}),_0x2b06ef[_0x41efde(0xf5)]===_0x41efde(0x1aa)&&_0x2b06ef[_0x41efde(0xd0)]&&(_0x56f3fb['failureMessage']=_0x2b06ef['errorMessage'],console[_0x41efde(0x104)](_0x41efde(0x18d)+_0x2b06ef[_0x41efde(0xd0)])),_0x56f3fb['paymentMethod']=_0x41efde(0xcf),await this[_0x41efde(0x18a)](_0x4355d0['id'],_0x2b06ef[_0x41efde(0xf5)],_0x56f3fb),await database_1['default'][_0x41efde(0xd5)][_0x41efde(0xbd)]({'data':{'paymentId':_0x4355d0['id'],'shopId':_0x4355d0[_0x41efde(0x19a)],'event':'visa_'+_0x2b06ef[_0x41efde(0xf5)][_0x41efde(0x12c)](),'statusCode':0xc8,'responseBody':JSON[_0x41efde(0x171)](_0x2b06ef)}}),await this[_0x41efde(0x1ab)](_0x4355d0,_0x2b06ef[_0x41efde(0xf5)][_0x41efde(0x192)]()),console[_0x41efde(0x104)]('‚úÖ\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20'+_0x4355d0['id']);}catch(_0x4bfc8b){console[_0x41efde(0xe1)](_0x41efde(0x7d),_0x4bfc8b),loggerService_1[_0x41efde(0xca)]['logWebhookError']('visa',_0x4bfc8b,_0x40ad48);throw _0x4bfc8b;}}async[a69_0x558331(0x97)](_0x4ec256){const _0x452d03=a69_0x558331;console['log'](_0x452d03(0xa1),JSON[_0x452d03(0x171)](_0x4ec256,null,0x2));try{const _0x2e9a8e=await this[_0x452d03(0xcd)][_0x452d03(0x7a)](_0x4ec256,_0x452d03(0x83));console[_0x452d03(0x104)]('üìä\x20MasterCard\x20webhook\x20result:',_0x2e9a8e);if(!_0x2e9a8e[_0x452d03(0x179)]){console[_0x452d03(0xe1)]('‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data'),console[_0x452d03(0xe1)](_0x452d03(0xbf),Object[_0x452d03(0xc1)](_0x4ec256));throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');}let _0x45a566=null;console['log'](_0x452d03(0x161)+_0x2e9a8e[_0x452d03(0x179)]);_0x2e9a8e['paymentId']&&(console['log'](_0x452d03(0x152)),_0x45a566=await database_1[_0x452d03(0x119)][_0x452d03(0xfb)][_0x452d03(0x144)]({'where':{'AND':[{'OR':[{'gateway':_0x452d03(0xf8)},{'gateway':'mastercard'},{'gateway':_0x452d03(0x115)}]},{'OR':[{'gatewayPaymentId':_0x2e9a8e[_0x452d03(0x179)]},{'gatewayOrderId':_0x2e9a8e[_0x452d03(0x179)]},{'id':_0x2e9a8e[_0x452d03(0x179)]},{'orderId':_0x2e9a8e[_0x452d03(0x179)]}]}]}}),console[_0x452d03(0x104)](_0x452d03(0xd1)+(_0x45a566?_0x452d03(0x153)+_0x45a566['id']:'Payment\x20not\x20found')));if(!_0x45a566){console[_0x452d03(0xe1)](_0x452d03(0xe6)+_0x2e9a8e[_0x452d03(0x179)]),console[_0x452d03(0xe1)](_0x452d03(0x15d)+_0x2e9a8e[_0x452d03(0x179)]+_0x452d03(0xa8)+_0x2e9a8e[_0x452d03(0x179)]+'\x22,\x20orderId=\x22'+_0x2e9a8e[_0x452d03(0x179)]+'\x22');const _0x50fd67=await database_1[_0x452d03(0x119)]['payment'][_0x452d03(0xbc)]({'where':{'OR':[{'gateway':_0x452d03(0xf4)},{'gateway':_0x452d03(0xf8)},{'gateway':_0x452d03(0x115)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x452d03(0x122)},'take':0xf});console[_0x452d03(0x104)]('üîç\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:',_0x50fd67),loggerService_1[_0x452d03(0xca)]['logWebhookError'](_0x452d03(0xf4),new Error(_0x452d03(0xdf)+_0x2e9a8e[_0x452d03(0x179)]),_0x4ec256);throw new Error(_0x452d03(0x186)+_0x2e9a8e[_0x452d03(0x179)]);}console['log']('‚úÖ\x20Found\x20payment\x20'+_0x45a566['id']+'\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20'+_0x45a566[_0x452d03(0xf5)]+'\x20to\x20'+_0x2e9a8e['status']);const _0x9a1af0={};_0x2e9a8e['amount']&&await database_1['default'][_0x452d03(0xfb)][_0x452d03(0x73)]({'where':{'id':_0x45a566['id']},'data':{'amount':_0x2e9a8e[_0x452d03(0x188)],'updatedAt':new Date()}}),_0x2e9a8e[_0x452d03(0x163)]&&await database_1['default'][_0x452d03(0xfb)]['update']({'where':{'id':_0x45a566['id']},'data':{'currency':_0x2e9a8e[_0x452d03(0x163)],'updatedAt':new Date()}}),_0x2e9a8e[_0x452d03(0xf5)]===_0x452d03(0x1aa)&&_0x2e9a8e['errorMessage']&&(_0x9a1af0[_0x452d03(0x182)]=_0x2e9a8e[_0x452d03(0xd0)],console[_0x452d03(0x104)](_0x452d03(0x175)+_0x2e9a8e['errorMessage'])),_0x9a1af0[_0x452d03(0xc7)]='mastercard',await this[_0x452d03(0x18a)](_0x45a566['id'],_0x2e9a8e['status'],_0x9a1af0),loggerService_1[_0x452d03(0xca)][_0x452d03(0x86)]('mastercard',_0x45a566['id'],_0x45a566[_0x452d03(0xf5)],_0x2e9a8e[_0x452d03(0xf5)],_0x4ec256);}catch(_0xb1a32e){console[_0x452d03(0xe1)](_0x452d03(0x94),_0xb1a32e),loggerService_1['loggerService']['logWebhookError'](_0x452d03(0xf4),_0xb1a32e,_0x4ec256);throw _0xb1a32e;}}async[a69_0x558331(0x109)](_0x11fa1c){const _0x2896d8=a69_0x558331;console[_0x2896d8(0x104)](_0x2896d8(0x8e),JSON[_0x2896d8(0x171)](_0x11fa1c,null,0x2));try{const _0x360e22=await this[_0x2896d8(0x91)]['processWebhook'](_0x11fa1c);console[_0x2896d8(0x104)]('üìä\x20Amer\x20webhook\x20result:',_0x360e22);if(!_0x360e22[_0x2896d8(0x179)]){console[_0x2896d8(0xe1)]('‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data'),console[_0x2896d8(0xe1)](_0x2896d8(0xbf),Object['keys'](_0x11fa1c));throw new Error('No\x20payment\x20ID\x20in\x20Amer\x20webhook');}let _0x487b50=null;console[_0x2896d8(0x104)]('üîç\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x360e22['paymentId']),_0x487b50=await database_1[_0x2896d8(0x119)][_0x2896d8(0xfb)][_0x2896d8(0x144)]({'where':{'AND':[{'gateway':_0x2896d8(0x8b)},{'OR':[{'gatewayPaymentId':_0x360e22[_0x2896d8(0x179)]},{'gatewayOrderId':_0x360e22[_0x2896d8(0x179)]},{'id':_0x360e22['paymentId']},{'orderId':_0x360e22['paymentId']}]}]}}),console['log'](_0x2896d8(0xd1)+(_0x487b50?_0x2896d8(0x153)+_0x487b50['id']:'Payment\x20not\x20found'));if(!_0x487b50){console[_0x2896d8(0xe1)](_0x2896d8(0x193)+_0x360e22['paymentId']);return;}console['log'](_0x2896d8(0x113)+_0x487b50['id']+'\x20status\x20'+_0x360e22[_0x2896d8(0xf5)]),await this[_0x2896d8(0x18a)](_0x487b50['id'],_0x360e22['status'],{'cardLast4':_0x360e22[_0x2896d8(0x84)]?.[_0x2896d8(0x184)],'paymentMethod':_0x360e22[_0x2896d8(0x84)]?.['paymentMethod']});}catch(_0x1fd4c0){console['error'](_0x2896d8(0x76),_0x1fd4c0),loggerService_1[_0x2896d8(0xca)]['logWebhookError'](_0x2896d8(0x8b),_0x1fd4c0,_0x11fa1c);throw _0x1fd4c0;}}async[a69_0x558331(0xfd)](_0x4cefcd){const _0x553573=a69_0x558331;console[_0x553573(0x104)](_0x553573(0x1a0),JSON[_0x553573(0x171)](_0x4cefcd,null,0x2));try{const _0x25a16d=_0x4cefcd[_0x553573(0xf5)],_0xb8b59a=_0x4cefcd['client_transaction_id'],_0x5799e8=_0x4cefcd['system_id'],_0x208b9c=_0x4cefcd[_0x553573(0x79)],_0x5c4561=_0x4cefcd[_0x553573(0x188)],_0x266fc8=_0x4cefcd[_0x553573(0x163)],_0x42b59f=_0x4cefcd[_0x553573(0x8f)],_0x74178c=_0x4cefcd[_0x553573(0xe4)];if(!_0xb8b59a){console[_0x553573(0xe1)]('‚ùå\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook');throw new Error('Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook');}console[_0x553573(0x104)](_0x553573(0x8d),{'status':_0x25a16d,'clientTransactionId':_0xb8b59a,'systemId':_0x5799e8,'paymentMethod':_0x208b9c,'amount':_0x5c4561,'currency':_0x266fc8,'commission':_0x42b59f,'statusAdditionInfo':_0x74178c});const _0x5ac8d8=await database_1[_0x553573(0x119)][_0x553573(0xfb)][_0x553573(0x144)]({'where':{'OR':[{'gatewayOrderId':_0xb8b59a},{'orderId':_0xb8b59a},{'id':_0xb8b59a},{'gatewayPaymentId':_0xb8b59a}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x5ac8d8){console['error'](_0x553573(0x11b)+_0xb8b59a);throw new Error('Payment\x20not\x20found:\x20'+_0xb8b59a);}console[_0x553573(0x104)]('‚úÖ\x20Found\x20payment\x20'+_0x5ac8d8['id']+_0x553573(0x85)),console['log'](_0x553573(0xff)+_0x5ac8d8[_0x553573(0xf5)]+_0x553573(0x75)+_0x25a16d),_0x25a16d===_0x553573(0xb0)?(console[_0x553573(0x104)](_0x553573(0x87)),await this[_0x553573(0x18a)](_0x5ac8d8['id'],_0x553573(0x1aa)),console['log'](_0x553573(0xec)+_0x5ac8d8['id']+_0x553573(0x14f)),console[_0x553573(0x104)](_0x553573(0xd9)+(_0x74178c||_0x553573(0xc8)))):console[_0x553573(0x104)](_0x553573(0x101)+_0x25a16d+_0x553573(0x15c)),await database_1[_0x553573(0x119)][_0x553573(0xd5)][_0x553573(0xbd)]({'data':{'paymentId':_0x5ac8d8['id'],'shopId':_0x5ac8d8[_0x553573(0x19a)],'event':'ampay_'+(_0x25a16d?.[_0x553573(0x12c)]()||_0x553573(0x183)),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x4cefcd)}}),loggerService_1[_0x553573(0xca)][_0x553573(0x86)]('ampay',_0x5ac8d8['id'],_0x5ac8d8[_0x553573(0xf5)],_0x25a16d===_0x553573(0xb0)?_0x553573(0x1aa):_0x25a16d,_0x4cefcd);}catch(_0x2c2738){console['error'](_0x553573(0x118),_0x2c2738),loggerService_1[_0x553573(0xca)][_0x553573(0x160)]('ampay',_0x2c2738,_0x4cefcd);throw _0x2c2738;}}async[a69_0x558331(0x168)](_0x51049b){const _0x4ca068=a69_0x558331;console['log']('üîÑ\x20Processing\x20AmPay\x20TRY\x20webhook:',JSON[_0x4ca068(0x171)](_0x51049b,null,0x2));try{const _0x5e4afb=_0x51049b[_0x4ca068(0xf5)],_0x5c8571=_0x51049b[_0x4ca068(0xea)],_0x4572f0=_0x51049b[_0x4ca068(0xe3)],_0x2b2830=_0x51049b[_0x4ca068(0x79)],_0x5cb471=_0x51049b[_0x4ca068(0x188)],_0x216742=_0x51049b[_0x4ca068(0x163)],_0x2f4e2f=_0x51049b[_0x4ca068(0x8f)],_0x4323d2=_0x51049b[_0x4ca068(0xe4)];if(!_0x5c8571){console[_0x4ca068(0xe1)]('‚ùå\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook');throw new Error('Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook');}console[_0x4ca068(0x104)]('üìä\x20AmPay\x20TRY\x20webhook\x20data:',{'status':_0x5e4afb,'clientTransactionId':_0x5c8571,'systemId':_0x4572f0,'paymentMethod':_0x2b2830,'amount':_0x5cb471,'currency':_0x216742,'commission':_0x2f4e2f,'statusAdditionInfo':_0x4323d2});const _0x58388b=await database_1[_0x4ca068(0x119)][_0x4ca068(0xfb)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x5c8571},{'orderId':_0x5c8571},{'id':_0x5c8571},{'gatewayPaymentId':_0x5c8571}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x58388b){console[_0x4ca068(0xe1)]('‚ùå\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20'+_0x5c8571);throw new Error(_0x4ca068(0xdf)+_0x5c8571);}console['log'](_0x4ca068(0x145)+_0x58388b['id']+'\x20for\x20AmPay\x20TRY\x20webhook'),console[_0x4ca068(0x104)](_0x4ca068(0xff)+_0x58388b['status']+_0x4ca068(0x75)+_0x5e4afb),_0x5e4afb==='DECLINED'?(console['log'](_0x4ca068(0x180)),await this[_0x4ca068(0x18a)](_0x58388b['id'],_0x4ca068(0x1aa)),console[_0x4ca068(0x104)](_0x4ca068(0x13d)+_0x58388b['id']+'\x20status\x20updated\x20to\x20FAILED'),console[_0x4ca068(0x104)]('‚ÑπÔ∏è\x20Decline\x20reason:\x20'+(_0x4323d2||_0x4ca068(0xc8)))):console[_0x4ca068(0x104)](_0x4ca068(0x19f)+_0x5e4afb+_0x4ca068(0x15c)),await database_1[_0x4ca068(0x119)][_0x4ca068(0xd5)][_0x4ca068(0xbd)]({'data':{'paymentId':_0x58388b['id'],'shopId':_0x58388b[_0x4ca068(0x19a)],'event':_0x4ca068(0x10c)+(_0x5e4afb?.[_0x4ca068(0x12c)]()||_0x4ca068(0x183)),'statusCode':0xc8,'responseBody':JSON[_0x4ca068(0x171)](_0x51049b)}}),loggerService_1[_0x4ca068(0xca)]['logWebhookProcessed']('ampay_try',_0x58388b['id'],_0x58388b['status'],_0x5e4afb==='DECLINED'?'FAILED':_0x5e4afb,_0x51049b);}catch(_0x52df16){console['error'](_0x4ca068(0x102),_0x52df16),loggerService_1[_0x4ca068(0xca)][_0x4ca068(0x160)](_0x4ca068(0x197),_0x52df16,_0x51049b);throw _0x52df16;}}async[a69_0x558331(0xba)](_0x5a4e52,_0x29916f){const _0x9d8a9d=a69_0x558331,_0x3b43c5=Date[_0x9d8a9d(0x13e)]();try{const _0x151edb=_0x5a4e52['shop'],_0x415382=_0x151edb[_0x9d8a9d(0x6c)];if(!_0x415382?.['webhookUrl']){console[_0x9d8a9d(0x104)](_0x9d8a9d(0x7c)+_0x151edb['id']);return;}const _0x33d75d=_0x29916f==='PAID'?_0x9d8a9d(0x93):_0x29916f===_0x9d8a9d(0x1aa)?'payment.failed':_0x29916f==='EXPIRED'?_0x9d8a9d(0x107):_0x29916f===_0x9d8a9d(0x157)?_0x9d8a9d(0x107):_0x29916f===_0x9d8a9d(0x10d)?_0x9d8a9d(0x107):_0x9d8a9d(0x12f);let _0x38131c=[];if(_0x415382[_0x9d8a9d(0x11d)])try{_0x38131c=Array[_0x9d8a9d(0x151)](_0x415382[_0x9d8a9d(0x11d)])?_0x415382[_0x9d8a9d(0x11d)]:JSON['parse'](_0x415382['webhookEvents']);}catch(_0x1dc764){console[_0x9d8a9d(0xe1)](_0x9d8a9d(0x106),_0x1dc764),_0x38131c=[];}if(!_0x38131c[_0x9d8a9d(0x124)](_0x33d75d)){console[_0x9d8a9d(0x104)](_0x9d8a9d(0x164)+_0x33d75d+_0x9d8a9d(0x13b)+_0x151edb['id']);return;}const _0x136c1e={'event':_0x33d75d,'payment':{'id':_0x5a4e52['id'],'order_id':_0x5a4e52['orderId'],'gateway_order_id':_0x5a4e52[_0x9d8a9d(0x8a)],'gateway':_0x5a4e52[_0x9d8a9d(0x177)],'amount':_0x5a4e52[_0x9d8a9d(0x188)],'currency':_0x5a4e52[_0x9d8a9d(0x163)],'status':_0x29916f[_0x9d8a9d(0x12c)](),'customer_email':_0x5a4e52[_0x9d8a9d(0x174)],'customer_name':_0x5a4e52[_0x9d8a9d(0x14d)],'failure_message':_0x5a4e52[_0x9d8a9d(0x182)],'tx_urls':_0x5a4e52[_0x9d8a9d(0x68)]?JSON['parse'](_0x5a4e52[_0x9d8a9d(0x68)]):null,'created_at':_0x5a4e52[_0x9d8a9d(0x127)],'updated_at':_0x5a4e52[_0x9d8a9d(0x131)]}},_0x243cfb=await fetch(_0x415382[_0x9d8a9d(0x19e)],{'method':_0x9d8a9d(0xb7),'headers':{'Content-Type':_0x9d8a9d(0x14b),'User-Agent':_0x9d8a9d(0x141)},'body':JSON['stringify'](_0x136c1e)}),_0x556da3=Date[_0x9d8a9d(0x13e)]()-_0x3b43c5,_0x4ec34a=_0x243cfb['ok']?'Success':await _0x243cfb[_0x9d8a9d(0x72)]();loggerService_1['loggerService'][_0x9d8a9d(0xf6)](_0x5a4e52[_0x9d8a9d(0x19a)],_0x415382[_0x9d8a9d(0x19e)],_0x33d75d,_0x243cfb[_0x9d8a9d(0xf5)],_0x556da3,_0x136c1e),console['log']('üì§\x20Shop\x20webhook\x20sent\x20to\x20'+_0x415382[_0x9d8a9d(0x19e)]+_0x9d8a9d(0xb1)+_0x243cfb['status']+'\x20('+_0x556da3+'ms)');}catch(_0x500e96){console[_0x9d8a9d(0xe1)](_0x9d8a9d(0x7f),_0x500e96),loggerService_1[_0x9d8a9d(0xca)][_0x9d8a9d(0x142)](_0x5a4e52[_0x9d8a9d(0x19a)],_0x5a4e52[_0x9d8a9d(0xf3)]?.[_0x9d8a9d(0x6c)]?.[_0x9d8a9d(0x19e)]||'unknown',_0x9d8a9d(0xc4),_0x500e96,{});}}async[a69_0x558331(0x1ab)](_0x134288,_0x48bdda){const _0x37a407=a69_0x558331;try{const _0x90646c={'PENDING':_0x37a407(0xf2),'PROCESSING':'processing','PAID':_0x37a407(0x150),'FAILED':_0x37a407(0x105),'EXPIRED':_0x37a407(0x18b),'REFUND':_0x37a407(0x13a),'CHARGEBACK':_0x37a407(0xc6)},_0x56bef1=_0x90646c[_0x48bdda];if(!_0x56bef1||_0x56bef1==='created')return;await telegramBotService_1['telegramBotService'][_0x37a407(0xfc)](_0x134288[_0x37a407(0x19a)],_0x134288,_0x56bef1);}catch(_0x41a392){console[_0x37a407(0xe1)](_0x37a407(0x117),_0x41a392);}}async['getGatewayCommission'](_0x4d163e,_0x1a51f6){const _0x3d0777=a69_0x558331;try{const _0x4efcd4=await database_1[_0x3d0777(0x119)][_0x3d0777(0xf3)][_0x3d0777(0xb6)]({'where':{'id':_0x4d163e},'select':{'gatewaySettings':!![]}});if(!_0x4efcd4?.['gatewaySettings'])return console[_0x3d0777(0x104)](_0x3d0777(0x135)+_0x4d163e+_0x3d0777(0xd8)),0xa;const _0x28cc50=JSON['parse'](_0x4efcd4[_0x3d0777(0x10e)]);for(const [_0x8bbb17,_0x1c971f]of Object[_0x3d0777(0xcc)](_0x28cc50)){if(_0x8bbb17[_0x3d0777(0x12c)]()===_0x1a51f6[_0x3d0777(0x12c)]()){const _0x5d0c24=_0x1c971f[_0x3d0777(0x8f)]||0xa;return console['log'](_0x3d0777(0xf7)+_0x1a51f6+_0x3d0777(0x17f)+_0x4d163e+':\x20'+_0x5d0c24+'%'),_0x5d0c24;}}return console[_0x3d0777(0x104)](_0x3d0777(0x11a)+_0x1a51f6+_0x3d0777(0x140)+_0x4d163e+_0x3d0777(0x12b)),0xa;}catch(_0x2b5df6){return console[_0x3d0777(0xe1)](_0x3d0777(0xa2)+_0x4d163e+',\x20gateway\x20'+_0x1a51f6+':',_0x2b5df6),0xa;}}async[a69_0x558331(0x6b)](_0x393385,_0x458f1b){const _0xe1edeb=a69_0x558331;console[_0xe1edeb(0x104)](_0xe1edeb(0x98)),console['log']('Query\x20params:',JSON[_0xe1edeb(0x171)](_0x393385,null,0x2)),console[_0xe1edeb(0x104)](_0xe1edeb(0x132),JSON['stringify'](_0x458f1b,null,0x2));try{const _0x2cfe1d=_0x393385['customerOrderId']||_0x458f1b[_0xe1edeb(0x125)],_0x5ecea1=_0x393385[_0xe1edeb(0xf5)]||_0x458f1b['status'],_0x655b93=_0x393385[_0xe1edeb(0x188)]||_0x458f1b[_0xe1edeb(0x188)],_0x27fc33=_0x393385[_0xe1edeb(0x163)]||_0x458f1b[_0xe1edeb(0x163)],_0x184799=_0x393385[_0xe1edeb(0x120)]||_0x458f1b[_0xe1edeb(0x120)];if(!_0x2cfe1d){console[_0xe1edeb(0xe1)](_0xe1edeb(0x69));throw new Error(_0xe1edeb(0xbb));}console[_0xe1edeb(0x104)]('üìä\x20MyXSpend\x20webhook\x20data:',{'customerOrderId':_0x2cfe1d,'status':_0x5ecea1,'amount':_0x655b93,'currency':_0x27fc33,'dateTime':_0x184799});const _0x3b043b=await database_1[_0xe1edeb(0x119)][_0xe1edeb(0xfb)][_0xe1edeb(0x144)]({'where':{'OR':[{'gatewayOrderId':_0x2cfe1d},{'orderId':_0x2cfe1d},{'id':_0x2cfe1d},{'gatewayPaymentId':_0x2cfe1d}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x3b043b){console[_0xe1edeb(0xe1)](_0xe1edeb(0x9d)+_0x2cfe1d);throw new Error(_0xe1edeb(0xdf)+_0x2cfe1d);}console['log']('‚úÖ\x20Found\x20payment\x20'+_0x3b043b['id']+_0xe1edeb(0x129)),console[_0xe1edeb(0x104)](_0xe1edeb(0xff)+_0x3b043b[_0xe1edeb(0xf5)]+_0xe1edeb(0x75)+_0x5ecea1);let _0x195de7=_0x5ecea1?.[_0xe1edeb(0x192)]();_0x5ecea1===_0xe1edeb(0x1aa)||_0x5ecea1===_0xe1edeb(0xd3)?(_0x195de7=_0xe1edeb(0x1aa),console[_0xe1edeb(0x104)]('üîÑ\x20MyXSpend\x20status\x20'+_0x5ecea1+'\x20mapped\x20to\x20FAILED'),await this[_0xe1edeb(0x18a)](_0x3b043b['id'],_0x195de7),console['log'](_0xe1edeb(0x92)+_0x3b043b['id']+_0xe1edeb(0x14f))):console[_0xe1edeb(0x104)]('‚ÑπÔ∏è\x20MyXSpend\x20status\x20'+_0x5ecea1+'\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)'),await database_1['default'][_0xe1edeb(0xd5)]['create']({'data':{'paymentId':_0x3b043b['id'],'shopId':_0x3b043b['shopId'],'event':_0xe1edeb(0x111)+(_0x5ecea1?.[_0xe1edeb(0x12c)]()||_0xe1edeb(0x183)),'statusCode':0xc8,'responseBody':JSON['stringify']({'queryParams':_0x393385,'bodyData':_0x458f1b})}}),loggerService_1[_0xe1edeb(0xca)][_0xe1edeb(0x86)](_0xe1edeb(0xae),_0x3b043b['id'],_0x3b043b[_0xe1edeb(0xf5)],_0x195de7||_0x5ecea1,{'queryParams':_0x393385,'bodyData':_0x458f1b});}catch(_0x33446d){console[_0xe1edeb(0xe1)](_0xe1edeb(0xda),_0x33446d),loggerService_1[_0xe1edeb(0xca)][_0xe1edeb(0x160)](_0xe1edeb(0xae),_0x33446d,{'queryParams':_0x393385,'bodyData':_0x458f1b});throw _0x33446d;}}}exports[a69_0x558331(0xdb)]=WebhookService;function a69_0x556d(){const _0x13ab56=[',\x20using\x20default\x2010%','toLowerCase','chargebackAmount','AmPayTRYService','payment.pending','RapydService','updatedAt','Body\x20data:','59308SWotlU','üîÑ\x20Processing\x20KLYME\x20webhook:','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','processVisaWebhook','VISA\x20payment\x20not\x20found:\x20','\x20status\x20','coinToPayService','refund','\x20not\x20enabled\x20for\x20shop\x20','../config/database','‚úÖ\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20','now','üí∞\x20Payment\x20','\x20in\x20shop\x20','Payment\x20System/1.0','logShopWebhookError','plisio','findFirst','‚úÖ\x20Found\x20payment\x20','Found','__importDefault','üìä\x20Rapyd\x20webhook:\x20Payment\x20','currentPayments','Error\x20processing\x20Noda\x20webhook:','application/json','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','customerName','ampayTRYService','\x20status\x20updated\x20to\x20FAILED','paid','isArray','üîç\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','Found\x20payment\x20','gatewayPaymentId','paidAt',',\x20GatewayOrderId=','CHARGEBACK','noda','üîç\x20VISA\x20payment\x20search\x20result:\x20','remitterName','\x20-\x20','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','üîç\x20Searched\x20by:\x20gatewayOrderId=\x22','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','üîÑ\x20Processing\x20VISA\x20webhook:','logWebhookError','üîç\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','./gateways/amerService','currency','Webhook\x20event\x20','üîÑ\x20Processing\x20CoinToPay2\x20webhook:','./gateways/plisioService','map','processAmPayTRYWebhook','\x20(Status:\x20','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter',',\x20card:\x20****','Error\x20processing\x20Rapyd\x20webhook:',',\x20Gateway=','processCoinToPay2Webhook','‚úÖ\x20Payment\x20link\x20','stringify','toISOString','üìà\x20Found\x20payment\x20link\x20','customerEmail','‚ùå\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20',',\x20Card=****','gateway','üîÑ\x20Processing\x20CoinToPay\x20webhook:','paymentId','getGatewayCommission','processPlisioGatewayWebhook','./gateways/coinToPay2Service','plisio_gateway','defineProperty','\x20commission\x20for\x20shop\x20','üîÑ\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','üîç\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','failureMessage','unknown','cardLast4','SINGLE','MasterCard\x20payment\x20not\x20found:\x20','396088xLIhEm','amount','16mpzzEg','updatePaymentStatus','expired','cointopay','‚ùå\x20VISA\x20payment\x20failed\x20with\x20message:\x20','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','balance','üí∏\x20CHARGEBACK:\x20Processing\x20penalty-only\x20deduction','toUpperCase','‚ùå\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20',':\x20type=','%\x20gateway\x20commission)','orderId','ampay_try','paymentLinkId','system','shopId','‚úÖ\x20Shop\x20','üîç\x20Found\x20VISA\x20payment:\x20ID=','type','webhookUrl','‚ÑπÔ∏è\x20AmPay\x20TRY\x20status\x20','üîÑ\x20Processing\x20AmPay\x20webhook:','processCoinToPayWebhook','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','__esModule','processPlisioWebhook','Error\x20processing\x20Plisio\x20webhook:','üîÑ\x20Processing\x20Noda\x20webhook:','1036362miibRz','coinToPay2Service','üìä\x20CoinToPay\x20webhook:\x20Payment\x20','FAILED','sendPaymentStatusNotification','processRapydWebhook','Not\x20found','txUrls','‚ùå\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','716525dPAWOb','processMyXSpendWebhook','settings','üîç\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:','username','\x22,\x20newStatus=\x22','üí∞\x20Converting\x20','\x20=\x20','text','update','convertToUSDT','\x20‚Üí\x20','‚ùå\x20Error\x20processing\x20Amer\x20webhook:',',\x20Status=','AmerService','payment_method','processWebhook','./gateways/ampayTRYService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','‚ùå\x20VISA\x20webhook\x20processing\x20failed:','rapyd','Failed\x20to\x20send\x20shop\x20webhook:','bankId','PlisioService','\x20not\x20found','MASTERCARD','additionalInfo','\x20for\x20AmPay\x20webhook','logWebhookProcessed','üîÑ\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','üîÑ\x20updatePaymentStatus\x20called:\x20paymentId=','NodaService','gatewayOrderId','amer','nodaService','üìä\x20AmPay\x20webhook\x20data:','üîÑ\x20Processing\x20Amer\x20webhook:','commission',',\x20gatewayOrderId:\x20','amerService','‚úÖ\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','payment.success','‚ùå\x20Error\x20processing\x20MasterCard\x20webhook:','‚ùå\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','\x20USDT','processMasterCardWebhook','üîÑ\x20Processing\x20MyXSpend\x20webhook:','üîç\x20VISA\x20payment\x20search\x20executed','rapydService','\x20USDT\x20(chargeback\x20penalty\x20ONLY)','klymeService','‚ùå\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','üìä\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','791346foKIuP','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','üîÑ\x20Processing\x20MasterCard\x20webhook:','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20',',\x20currentPayments=','üìä\x20Plisio\x20webhook:\x20Payment\x20','./gateways/nodaService','üìä\x20VISA\x20webhook\x20result:','üí∞\x20Payment\x20amount\x20is\x20NOT\x20deducted\x20(chargeback\x20penalty\x20only)','\x22,\x20id=\x22',',\x20status=','üîÑ\x20Processing\x20Plisio\x20webhook:','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','amountUSDT','processKlymeWebhook','myxspend','üìà\x20Payment\x20','DECLINED','\x20with\x20status\x20','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','‚úÖ\x20Found\x20payment:\x20ID=','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','\x20+\x20','findUnique','POST','üí∞\x20Gateway\x20','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','sendShopWebhook','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','findMany','create','No\x20payment\x20ID\x20in\x20VISA\x20webhook','‚ùå\x20Available\x20webhook\x20fields:','Error\x20processing\x20CoinToPay2\x20webhook:','keys','45QLzcrf','no\x20balance\x20change','webhook_send','\x20(orderId:\x20','chargeback','paymentMethod','No\x20additional\x20info','üí∞\x20Adding\x20to\x20balance:\x20','loggerService','üìù\x20Reason:\x20','entries','visaMasterCardService','processNodaWebhook','visa','errorMessage','üîç\x20Search\x20result:\x20','paymentLink','EXPIRED','‚ùå\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','webhookLog','cointopay2','plisioService',',\x20using\x20default\x20commission\x2010%','‚ÑπÔ∏è\x20Decline\x20reason:\x20','‚ùå\x20Error\x20processing\x20MyXSpend\x20webhook:','WebhookService','üí∞\x20Final\x20balance\x20after\x20chargeback:\x20','./gateways/rapydService','KlymeService','Payment\x20not\x20found:\x20',',\x20newStatus=','error','1959671LRXSZy','system_id','status_addition_info','‚ö†Ô∏è\x20CHARGEBACK\x20without\x20penalty\x20amount\x20-\x20no\x20balance\x20change','‚ùå\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','klyme','13469duaYMT','Error\x20processing\x20CoinToPay\x20webhook:','client_transaction_id','üîÑ\x20Processing\x20Rapyd\x20webhook:','‚úÖ\x20AmPay\x20webhook\x20processed:\x20Payment\x20','PAID','./gateways/klymeService','üè™\x20Shop\x20','Error\x20processing\x20KLYME\x20webhook:','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','created','shop','mastercard','status','logShopWebhookSent','Gateway\x20','visa_mastercard','webhook_status_change_','\x22,\x20paymentLinkId=\x22','payment','sendPaymentNotification','processAmPayWebhook','CoinToPayService','üìä\x20Payment\x20status:\x20','\x20current\x20balance:\x20','‚ÑπÔ∏è\x20AmPay\x20status\x20','‚ùå\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:','\x20balance\x20updated:\x20','log','failed','Error\x20parsing\x20webhook\x20events:','payment.failed','Payment\x20','processAmerWebhook','./loggerService','remitterIban','ampay_try_','REFUND','gatewaySettings',',\x20GatewayPaymentId=','gatewayCommissionRate','myxspend_','VISA','üìä\x20Amer\x20webhook:\x20Payment\x20','amountAfterGatewayCommissionUSDT','visa/mastercard','üîÑ\x20Processing\x20Plisio\x20Gateway\x20webhook:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','‚ùå\x20Error\x20processing\x20AmPay\x20webhook:','default','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','‚ùå\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','VisaMasterCardService','webhookEvents','üìä\x20Noda\x20webhook:\x20Payment\x20','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','dateTime','\x20->\x20','desc','CoinToPay2Service','includes','customerOrderId','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','createdAt','toFixed','\x20for\x20MyXSpend\x20webhook','COMPLETED'];a69_0x556d=function(){return _0x13ab56;};return a69_0x556d();}