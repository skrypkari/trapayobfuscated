'use strict';const a61_0x12967e=a61_0x1424;(function(_0x272acf,_0x34a3d4){const _0x51d60e=a61_0x1424,_0x5ea95e=_0x272acf();while(!![]){try{const _0x44c4c1=-parseInt(_0x51d60e(0x179))/0x1+parseInt(_0x51d60e(0x136))/0x2*(-parseInt(_0x51d60e(0x1b8))/0x3)+-parseInt(_0x51d60e(0x162))/0x4+-parseInt(_0x51d60e(0x189))/0x5+parseInt(_0x51d60e(0x12d))/0x6+-parseInt(_0x51d60e(0x198))/0x7+parseInt(_0x51d60e(0x185))/0x8;if(_0x44c4c1===_0x34a3d4)break;else _0x5ea95e['push'](_0x5ea95e['shift']());}catch(_0x56c361){_0x5ea95e['push'](_0x5ea95e['shift']());}}}(a61_0x5e30,0x49e07));var __importDefault=this&&this['__importDefault']||function(_0x49f8af){const _0x1650be=a61_0x1424;return _0x49f8af&&_0x49f8af[_0x1650be(0x1cc)]?_0x49f8af:{'default':_0x49f8af};};Object[a61_0x12967e(0x10d)](exports,'__esModule',{'value':!![]}),exports[a61_0x12967e(0x1cd)]=void 0x0;const database_1=__importDefault(require(a61_0x12967e(0x1df))),plisioService_1=require(a61_0x12967e(0x137)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a61_0x12967e(0x1c5)),coinToPay2Service_1=require(a61_0x12967e(0x147)),klymeService_1=require(a61_0x12967e(0x195)),mastercardService_1=require('./gateways/mastercardService'),amerService_1=require(a61_0x12967e(0x1bf)),telegramBotService_1=require('./telegramBotService'),currencyService_1=require(a61_0x12967e(0x175)),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x28ccda=a61_0x12967e;this[_0x28ccda(0x181)]=new plisioService_1['PlisioService'](),this[_0x28ccda(0x12f)]=new rapydService_1['RapydService'](),this[_0x28ccda(0x111)]=new nodaService_1['NodaService'](),this['coinToPayService']=new coinToPayService_1['CoinToPayService'](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x28ccda(0x1af))](),this[_0x28ccda(0x10e)]=new klymeService_1[(_0x28ccda(0x161))](),this[_0x28ccda(0x127)]=new mastercardService_1['MasterCardService'](),this['amerService']=new amerService_1[(_0x28ccda(0x115))]();}async[a61_0x12967e(0x17a)](_0x28f75b,_0xdb6cfe,_0x4cdcfe){const _0xb6a756=a61_0x12967e;console['log'](_0xb6a756(0x122)+_0x28f75b+_0xb6a756(0x14c)+_0xdb6cfe),console[_0xb6a756(0x109)](_0xb6a756(0x119),_0x4cdcfe),await database_1[_0xb6a756(0xfc)][_0xb6a756(0x142)](async _0x4cb4cd=>{const _0x4ca8fc=_0xb6a756,_0x2d54e3=await _0x4cb4cd[_0x4ca8fc(0x168)][_0x4ca8fc(0x149)]({'where':{'id':_0x28f75b},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2d54e3)throw new Error('Payment\x20'+_0x28f75b+_0x4ca8fc(0x1a3));const _0x4901d8=_0x2d54e3[_0x4ca8fc(0x14a)],_0x486270=_0x2d54e3[_0x4ca8fc(0x151)];console[_0x4ca8fc(0x109)](_0x4ca8fc(0x16d)+_0x28f75b+':\x20'+_0x4901d8+_0x4ca8fc(0x191)+_0xdb6cfe),console[_0x4ca8fc(0x109)]('🏪\x20Shop\x20'+_0x486270[_0x4ca8fc(0xff)]+'\x20current\x20balance:\x20'+_0x486270[_0x4ca8fc(0x15b)]+_0x4ca8fc(0x133));const _0x2a0c52={'status':_0xdb6cfe['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x4cdcfe?.[_0x4ca8fc(0x10c)]&&(_0x2a0c52[_0x4ca8fc(0x10c)]=_0x4cdcfe['failureMessage']);_0x4cdcfe?.['txUrls']&&(_0x2a0c52[_0x4ca8fc(0x107)]=JSON[_0x4ca8fc(0x187)](_0x4cdcfe[_0x4ca8fc(0x107)]));_0x4cdcfe?.[_0x4ca8fc(0x12a)]&&(_0x2a0c52[_0x4ca8fc(0x12a)]=_0x4cdcfe[_0x4ca8fc(0x12a)]);_0x4cdcfe?.[_0x4ca8fc(0x1ae)]&&(_0x2a0c52['paymentMethod']=_0x4cdcfe[_0x4ca8fc(0x1ae)]);_0x4cdcfe?.[_0x4ca8fc(0x165)]&&(_0x2a0c52[_0x4ca8fc(0x165)]=_0x4cdcfe[_0x4ca8fc(0x165)]);_0x4cdcfe?.[_0x4ca8fc(0x159)]&&(_0x2a0c52[_0x4ca8fc(0x159)]=_0x4cdcfe[_0x4ca8fc(0x159)]);_0x4cdcfe?.[_0x4ca8fc(0x16b)]&&(_0x2a0c52['remitterName']=_0x4cdcfe[_0x4ca8fc(0x16b)]);let _0x2f7ef6=_0x486270[_0x4ca8fc(0x15b)],_0x3138eb='';if(_0xdb6cfe['toUpperCase']()===_0x4ca8fc(0x148)&&_0x4901d8!==_0x4ca8fc(0x148)){const _0xe3b5c0=await currencyService_1[_0x4ca8fc(0x1b7)][_0x4ca8fc(0x154)](_0x2d54e3['amount'],_0x2d54e3[_0x4ca8fc(0x11a)]),_0x17335d=await this[_0x4ca8fc(0x17b)](_0x486270['id'],_0x2d54e3[_0x4ca8fc(0x1b4)]),_0x48aef4=_0xe3b5c0*(0x1-_0x17335d/0x64);_0x2f7ef6+=_0x48aef4,_0x3138eb='+'+_0x48aef4[_0x4ca8fc(0x16a)](0x6)+_0x4ca8fc(0x152)+_0x17335d+_0x4ca8fc(0x170),_0x2a0c52[_0x4ca8fc(0x130)]=_0xe3b5c0,_0x2a0c52['amountAfterGatewayCommissionUSDT']=_0x48aef4,_0x2a0c52[_0x4ca8fc(0x17e)]=new Date(),console[_0x4ca8fc(0x109)](_0x4ca8fc(0x155)+_0x2d54e3['amount']+'\x20'+_0x2d54e3[_0x4ca8fc(0x11a)]+_0x4ca8fc(0x191)+_0xe3b5c0[_0x4ca8fc(0x16a)](0x6)+_0x4ca8fc(0x133)),console[_0x4ca8fc(0x109)]('💰\x20Gateway\x20'+_0x2d54e3[_0x4ca8fc(0x1b4)]+'\x20commission:\x20'+_0x17335d+'%'),console[_0x4ca8fc(0x109)](_0x4ca8fc(0x11c)+_0x48aef4['toFixed'](0x6)+_0x4ca8fc(0x133)),console['log'](_0x4ca8fc(0x158)+_0x486270[_0x4ca8fc(0x15b)]+_0x4ca8fc(0xfd)+_0x48aef4[_0x4ca8fc(0x16a)](0x6)+_0x4ca8fc(0x106)+_0x2f7ef6['toFixed'](0x6)+_0x4ca8fc(0x133));}else{if(_0x4901d8===_0x4ca8fc(0x148)&&_0xdb6cfe[_0x4ca8fc(0x1ac)]()!==_0x4ca8fc(0x148)){let _0x45ac82;if(_0x2d54e3[_0x4ca8fc(0x1da)])_0x45ac82=_0x2d54e3[_0x4ca8fc(0x1da)];else{if(_0x2d54e3[_0x4ca8fc(0x130)]){const _0x1b8b4c=await this[_0x4ca8fc(0x17b)](_0x486270['id'],_0x2d54e3[_0x4ca8fc(0x1b4)]);_0x45ac82=_0x2d54e3[_0x4ca8fc(0x130)]*(0x1-_0x1b8b4c/0x64);}else console[_0x4ca8fc(0x109)](_0x4ca8fc(0x1b5)),_0x45ac82=0x0;}_0x45ac82>0x0&&(_0x2f7ef6-=_0x45ac82,_0x3138eb='-'+_0x45ac82[_0x4ca8fc(0x16a)](0x6)+_0x4ca8fc(0x1b3),_0x2a0c52[_0x4ca8fc(0x130)]=null,_0x2a0c52[_0x4ca8fc(0x1da)]=null,_0x2a0c52[_0x4ca8fc(0x17e)]=null,console['log'](_0x4ca8fc(0x1be)+_0x486270['balance']+_0x4ca8fc(0x18f)+_0x45ac82[_0x4ca8fc(0x16a)](0x6)+_0x4ca8fc(0x106)+_0x2f7ef6[_0x4ca8fc(0x16a)](0x6)+'\x20USDT'));}}if(_0xdb6cfe[_0x4ca8fc(0x1ac)]()===_0x4ca8fc(0x1db)){const _0x55f03c=_0x4cdcfe?.['chargebackAmount']||0x0;_0x55f03c>0x0&&(_0x2f7ef6-=_0x55f03c,_0x3138eb+=_0x4ca8fc(0x177)+_0x55f03c[_0x4ca8fc(0x16a)](0x6)+_0x4ca8fc(0x1ca),_0x2a0c52['chargebackAmount']=_0x55f03c,console[_0x4ca8fc(0x109)]('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0x55f03c[_0x4ca8fc(0x16a)](0x6)+_0x4ca8fc(0x133)),console[_0x4ca8fc(0x109)](_0x4ca8fc(0x112)+_0x2f7ef6[_0x4ca8fc(0x16a)](0x6)+_0x4ca8fc(0x133)));}const _0x117580=await _0x4cb4cd[_0x4ca8fc(0x168)]['update']({'where':{'id':_0x28f75b},'data':_0x2a0c52});_0x2f7ef6!==_0x486270[_0x4ca8fc(0x15b)]&&(await _0x4cb4cd[_0x4ca8fc(0x151)][_0x4ca8fc(0x12b)]({'where':{'id':_0x486270['id']},'data':{'balance':_0x2f7ef6}}),console[_0x4ca8fc(0x109)]('✅\x20Shop\x20'+_0x486270['username']+_0x4ca8fc(0x1d6)+_0x486270[_0x4ca8fc(0x15b)][_0x4ca8fc(0x16a)](0x6)+_0x4ca8fc(0x191)+_0x2f7ef6['toFixed'](0x6)+'\x20USDT'),console[_0x4ca8fc(0x109)](_0x4ca8fc(0x138)+_0x3138eb));await _0x4cb4cd['webhookLog']['create']({'data':{'paymentId':_0x28f75b,'shopId':_0x486270['id'],'event':_0x4ca8fc(0x13c)+_0xdb6cfe['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x4ca8fc(0x187)]({'oldStatus':_0x4901d8,'newStatus':_0xdb6cfe[_0x4ca8fc(0x1ac)](),'balanceChange':_0x3138eb||_0x4ca8fc(0x100),'oldBalance':_0x486270['balance'],'newBalance':_0x2f7ef6,'amountUSDT':_0x2a0c52[_0x4ca8fc(0x130)],'additionalData':_0x4cdcfe,'timestamp':new Date()[_0x4ca8fc(0x1ba)]()})}}),await this['sendShopWebhook']({..._0x2d54e3,..._0x117580,'shop':_0x486270},_0xdb6cfe[_0x4ca8fc(0x1ac)]()),await this[_0x4ca8fc(0x15e)]({..._0x2d54e3,..._0x117580},_0xdb6cfe['toUpperCase']());if(_0x4901d8!=='PAID'&&_0xdb6cfe['toUpperCase']()===_0x4ca8fc(0x148)){console[_0x4ca8fc(0x109)](_0x4ca8fc(0x113)+_0x28f75b+_0x4ca8fc(0x171)),console[_0x4ca8fc(0x109)](_0x4ca8fc(0x132)+_0x4901d8+_0x4ca8fc(0x19d)+_0xdb6cfe[_0x4ca8fc(0x1ac)]()+'\x22,\x20paymentLinkId=\x22'+_0x2d54e3[_0x4ca8fc(0x157)]+'\x22');if(_0x2d54e3[_0x4ca8fc(0x157)])try{const _0x4838ac=await _0x4cb4cd[_0x4ca8fc(0x11e)][_0x4ca8fc(0x149)]({'where':{'id':_0x2d54e3[_0x4ca8fc(0x157)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4838ac){console[_0x4ca8fc(0x109)](_0x4ca8fc(0x1c9)+_0x4838ac['id']+':\x20type='+_0x4838ac[_0x4ca8fc(0x140)]+_0x4ca8fc(0x164)+_0x4838ac['currentPayments']+_0x4ca8fc(0x1d5)+_0x4838ac[_0x4ca8fc(0x14a)]);const _0x6b6005=_0x4838ac['currentPayments']+0x1,_0x7b4cad=_0x4838ac['type']===_0x4ca8fc(0x1a6)?_0x4ca8fc(0x19c):_0x4838ac[_0x4ca8fc(0x14a)];await _0x4cb4cd[_0x4ca8fc(0x11e)]['update']({'where':{'id':_0x2d54e3[_0x4ca8fc(0x157)]},'data':{'currentPayments':_0x6b6005,'status':_0x7b4cad,'updatedAt':new Date()}}),console['log'](_0x4ca8fc(0x13e)+_0x4838ac['id']+_0x4ca8fc(0x1bd)+_0x4838ac[_0x4ca8fc(0x1d4)]+_0x4ca8fc(0x191)+_0x6b6005+_0x4ca8fc(0x1d5)+_0x4838ac[_0x4ca8fc(0x14a)]+_0x4ca8fc(0x191)+_0x7b4cad);}else console['log'](_0x4ca8fc(0x13b)+_0x2d54e3[_0x4ca8fc(0x157)]+_0x4ca8fc(0x1a3));}catch(_0x545ec3){console[_0x4ca8fc(0x146)](_0x4ca8fc(0x1bb),_0x545ec3);}else console[_0x4ca8fc(0x109)](_0x4ca8fc(0x113)+_0x28f75b+_0x4ca8fc(0x1d3));}else console[_0x4ca8fc(0x109)](_0x4ca8fc(0x113)+_0x28f75b+_0x4ca8fc(0x190)+_0x4901d8+'\x20->\x20'+_0xdb6cfe[_0x4ca8fc(0x1ac)]());});}async[a61_0x12967e(0x178)](_0x19103a){const _0x5dc235=a61_0x12967e;console[_0x5dc235(0x109)](_0x5dc235(0x1d1),_0x19103a);try{const _0x1b6cc2=await this[_0x5dc235(0x181)][_0x5dc235(0x13d)](_0x19103a);if(!_0x1b6cc2[_0x5dc235(0x108)])throw new Error(_0x5dc235(0x101));const _0x1c93bd=await database_1[_0x5dc235(0xfc)][_0x5dc235(0x168)][_0x5dc235(0x1e0)]({'where':{'gatewayOrderId':_0x1b6cc2['paymentId']}});if(!_0x1c93bd){console[_0x5dc235(0x146)](_0x5dc235(0x169)+_0x1b6cc2['paymentId']);return;}console['log']('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0x1c93bd['id']+_0x5dc235(0x1d9)+_0x1b6cc2[_0x5dc235(0x14a)]),await this[_0x5dc235(0x17a)](_0x1c93bd['id'],_0x1b6cc2[_0x5dc235(0x14a)],{'txUrls':_0x1b6cc2[_0x5dc235(0x107)]}),loggerService_1[_0x5dc235(0x163)][_0x5dc235(0x17c)](_0x5dc235(0x1c1),_0x1c93bd['id'],_0x1c93bd['status'],_0x1b6cc2[_0x5dc235(0x14a)],_0x19103a);}catch(_0x1a500e){console['error'](_0x5dc235(0x1de),_0x1a500e),loggerService_1['loggerService'][_0x5dc235(0x141)]('plisio',_0x1a500e,_0x19103a);throw _0x1a500e;}}async[a61_0x12967e(0x139)](_0x5ca205){const _0x14f38c=a61_0x12967e;console[_0x14f38c(0x109)](_0x14f38c(0x1dc),_0x5ca205);try{const _0xb28fd4=await this[_0x14f38c(0x181)][_0x14f38c(0x13d)](_0x5ca205);if(!_0xb28fd4[_0x14f38c(0x108)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x3107f0=await database_1['default'][_0x14f38c(0x168)][_0x14f38c(0x1e0)]({'where':{'gatewayOrderId':_0xb28fd4[_0x14f38c(0x108)]}});if(!_0x3107f0){console[_0x14f38c(0x146)](_0x14f38c(0x160)+_0xb28fd4[_0x14f38c(0x108)]);return;}console[_0x14f38c(0x109)](_0x14f38c(0x180)+_0x3107f0['id']+'\x20status\x20'+_0xb28fd4[_0x14f38c(0x14a)]),await this[_0x14f38c(0x17a)](_0x3107f0['id'],_0xb28fd4[_0x14f38c(0x14a)],{'txUrls':_0xb28fd4[_0x14f38c(0x107)]}),loggerService_1[_0x14f38c(0x163)][_0x14f38c(0x17c)]('plisio_gateway',_0x3107f0['id'],_0x3107f0[_0x14f38c(0x14a)],_0xb28fd4[_0x14f38c(0x14a)],_0x5ca205);}catch(_0x12f5b6){console[_0x14f38c(0x146)](_0x14f38c(0x1d2),_0x12f5b6),loggerService_1[_0x14f38c(0x163)][_0x14f38c(0x141)](_0x14f38c(0x15d),_0x12f5b6,_0x5ca205);throw _0x12f5b6;}}async[a61_0x12967e(0x1c7)](_0xc81fdf){const _0x4e2969=a61_0x12967e;console[_0x4e2969(0x109)](_0x4e2969(0x153),_0xc81fdf);try{const _0x3df60c=await this['rapydService']['processWebhook'](_0xc81fdf);if(!_0x3df60c['paymentId'])throw new Error(_0x4e2969(0x14f));const _0x5cd4c1=await database_1[_0x4e2969(0xfc)][_0x4e2969(0x168)]['findFirst']({'where':{'gatewayOrderId':_0x3df60c[_0x4e2969(0x108)]}});if(!_0x5cd4c1){console['error'](_0x4e2969(0x1a8)+_0x3df60c['paymentId']);return;}console[_0x4e2969(0x109)](_0x4e2969(0x144)+_0x5cd4c1['id']+_0x4e2969(0x1d9)+_0x3df60c[_0x4e2969(0x14a)]),await this[_0x4e2969(0x17a)](_0x5cd4c1['id'],_0x3df60c[_0x4e2969(0x14a)],{'failureMessage':_0x3df60c['failureMessage'],'cardLast4':_0x3df60c[_0x4e2969(0x199)]?.[_0x4e2969(0x12a)],'paymentMethod':_0x3df60c[_0x4e2969(0x199)]?.['paymentMethod']}),loggerService_1[_0x4e2969(0x163)][_0x4e2969(0x17c)](_0x4e2969(0x135),_0x5cd4c1['id'],_0x5cd4c1[_0x4e2969(0x14a)],_0x3df60c[_0x4e2969(0x14a)],_0xc81fdf);}catch(_0x28b35b){console[_0x4e2969(0x146)](_0x4e2969(0x1c4),_0x28b35b),loggerService_1[_0x4e2969(0x163)][_0x4e2969(0x141)](_0x4e2969(0x135),_0x28b35b,_0xc81fdf);throw _0x28b35b;}}async['processNodaWebhook'](_0x9a9099){const _0x2e1ded=a61_0x12967e;console[_0x2e1ded(0x109)](_0x2e1ded(0x182),_0x9a9099);try{const _0x13b90d=await this[_0x2e1ded(0x111)]['processWebhook'](_0x9a9099);if(!_0x13b90d[_0x2e1ded(0x108)])throw new Error(_0x2e1ded(0x123));const _0x275499=await database_1[_0x2e1ded(0xfc)][_0x2e1ded(0x168)]['findFirst']({'where':{'gatewayOrderId':_0x13b90d['paymentId']}});if(!_0x275499){console['error'](_0x2e1ded(0x143)+_0x13b90d[_0x2e1ded(0x108)]);return;}console[_0x2e1ded(0x109)](_0x2e1ded(0x1d0)+_0x275499['id']+'\x20status\x20'+_0x13b90d[_0x2e1ded(0x14a)]),await this[_0x2e1ded(0x17a)](_0x275499['id'],_0x13b90d[_0x2e1ded(0x14a)],{'bankId':_0x13b90d[_0x2e1ded(0x199)]?.[_0x2e1ded(0x165)],'remitterIban':_0x13b90d[_0x2e1ded(0x199)]?.[_0x2e1ded(0x159)],'remitterName':_0x13b90d[_0x2e1ded(0x199)]?.[_0x2e1ded(0x16b)]}),loggerService_1['loggerService'][_0x2e1ded(0x17c)](_0x2e1ded(0x121),_0x275499['id'],_0x275499[_0x2e1ded(0x14a)],_0x13b90d[_0x2e1ded(0x14a)],_0x9a9099);}catch(_0x39723c){console['error']('Error\x20processing\x20Noda\x20webhook:',_0x39723c),loggerService_1[_0x2e1ded(0x163)][_0x2e1ded(0x141)](_0x2e1ded(0x121),_0x39723c,_0x9a9099);throw _0x39723c;}}async[a61_0x12967e(0x1c2)](_0x591e53){const _0x44f12b=a61_0x12967e;console['log']('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x591e53);try{const _0x5859c9=await this[_0x44f12b(0x11d)][_0x44f12b(0x13d)](_0x591e53);if(!_0x5859c9['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x21ce61=await database_1['default'][_0x44f12b(0x168)][_0x44f12b(0x1e0)]({'where':{'gatewayOrderId':_0x5859c9[_0x44f12b(0x108)]}});if(!_0x21ce61){console[_0x44f12b(0x146)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x5859c9[_0x44f12b(0x108)]);return;}console[_0x44f12b(0x109)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x21ce61['id']+_0x44f12b(0x1d9)+_0x5859c9[_0x44f12b(0x14a)]),await this[_0x44f12b(0x17a)](_0x21ce61['id'],_0x5859c9[_0x44f12b(0x14a)]),loggerService_1[_0x44f12b(0x163)]['logWebhookProcessed'](_0x44f12b(0x173),_0x21ce61['id'],_0x21ce61[_0x44f12b(0x14a)],_0x5859c9['status'],_0x591e53);}catch(_0x3283ec){console['error'](_0x44f12b(0x10b),_0x3283ec),loggerService_1[_0x44f12b(0x163)]['logWebhookError']('cointopay',_0x3283ec,_0x591e53);throw _0x3283ec;}}async['processCoinToPay2Webhook'](_0x2e2164){const _0x4566f6=a61_0x12967e;console[_0x4566f6(0x109)](_0x4566f6(0x19b),_0x2e2164);try{const _0x33686f=await this[_0x4566f6(0x15a)][_0x4566f6(0x13d)](_0x2e2164);if(!_0x33686f[_0x4566f6(0x108)])throw new Error(_0x4566f6(0x18b));const _0x49d3f2=await database_1[_0x4566f6(0xfc)][_0x4566f6(0x168)][_0x4566f6(0x1e0)]({'where':{'gatewayOrderId':_0x33686f[_0x4566f6(0x108)]}});if(!_0x49d3f2){console[_0x4566f6(0x146)](_0x4566f6(0x1b9)+_0x33686f[_0x4566f6(0x108)]);return;}console[_0x4566f6(0x109)]('📊\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x49d3f2['id']+_0x4566f6(0x1d9)+_0x33686f[_0x4566f6(0x14a)]),await this[_0x4566f6(0x17a)](_0x49d3f2['id'],_0x33686f[_0x4566f6(0x14a)]),loggerService_1['loggerService'][_0x4566f6(0x17c)](_0x4566f6(0x14d),_0x49d3f2['id'],_0x49d3f2['status'],_0x33686f[_0x4566f6(0x14a)],_0x2e2164);}catch(_0x1b3025){console[_0x4566f6(0x146)](_0x4566f6(0x117),_0x1b3025),loggerService_1['loggerService'][_0x4566f6(0x141)](_0x4566f6(0x14d),_0x1b3025,_0x2e2164);throw _0x1b3025;}}async['processKlymeWebhook'](_0x308483){const _0x3d566f=a61_0x12967e;console['log']('🔄\x20Processing\x20KLYME\x20webhook:',_0x308483);try{const _0x4d13d9=await this[_0x3d566f(0x10e)]['processWebhook'](_0x308483);if(!_0x4d13d9['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x4b54a1=await database_1[_0x3d566f(0xfc)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x4d13d9['paymentId']}});if(!_0x4b54a1){console[_0x3d566f(0x146)](_0x3d566f(0x15f)+_0x4d13d9[_0x3d566f(0x108)]);return;}console[_0x3d566f(0x109)](_0x3d566f(0x183)+_0x4b54a1['id']+'\x20status\x20'+_0x4d13d9[_0x3d566f(0x14a)]),await this[_0x3d566f(0x17a)](_0x4b54a1['id'],_0x4d13d9[_0x3d566f(0x14a)],{'paymentMethod':_0x4d13d9[_0x3d566f(0x199)]?.[_0x3d566f(0x1cb)]}),loggerService_1[_0x3d566f(0x163)][_0x3d566f(0x17c)](_0x3d566f(0x1b2),_0x4b54a1['id'],_0x4b54a1[_0x3d566f(0x14a)],_0x4d13d9['status'],_0x308483);}catch(_0x299f10){console[_0x3d566f(0x146)](_0x3d566f(0x18a),_0x299f10),loggerService_1[_0x3d566f(0x163)][_0x3d566f(0x141)]('klyme',_0x299f10,_0x308483);throw _0x299f10;}}async['processMasterCardWebhook'](_0x556b01){const _0x257e13=a61_0x12967e;console['log'](_0x257e13(0x1ad),JSON[_0x257e13(0x187)](_0x556b01,null,0x2));try{const _0x150df1=await this[_0x257e13(0x127)][_0x257e13(0x13d)](_0x556b01);console['log']('📊\x20MasterCard\x20webhook\x20result:',_0x150df1);if(!_0x150df1[_0x257e13(0x108)]){console[_0x257e13(0x146)](_0x257e13(0x1c8)),console[_0x257e13(0x146)](_0x257e13(0x12c),Object[_0x257e13(0x1c3)](_0x556b01));throw new Error(_0x257e13(0x1b0));}let _0x3442a3=null;console[_0x257e13(0x109)](_0x257e13(0x13f)+_0x150df1[_0x257e13(0x108)]);_0x150df1['paymentId']&&(console[_0x257e13(0x109)]('🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x3442a3=await database_1[_0x257e13(0xfc)][_0x257e13(0x168)][_0x257e13(0x1e0)]({'where':{'AND':[{'gateway':'mastercard'},{'OR':[{'gatewayPaymentId':_0x150df1[_0x257e13(0x108)]},{'gatewayOrderId':_0x150df1[_0x257e13(0x108)]},{'id':_0x150df1['paymentId']},{'orderId':_0x150df1[_0x257e13(0x108)]}]}]}}),console[_0x257e13(0x109)](_0x257e13(0x102)+(_0x3442a3?_0x257e13(0x104)+_0x3442a3['id']:_0x257e13(0x19a))));if(!_0x3442a3){console['error'](_0x257e13(0x125)+_0x150df1[_0x257e13(0x108)]),console[_0x257e13(0x146)]('🔍\x20Searched\x20by:\x20gatewayOrderId=\x22'+_0x150df1['paymentId']+_0x257e13(0x18e)+_0x150df1[_0x257e13(0x108)]+_0x257e13(0x16c)+_0x150df1['paymentId']+'\x22');const _0x5d83bf=await database_1['default'][_0x257e13(0x168)][_0x257e13(0x1a2)]({'where':{'gateway':_0x257e13(0x16e)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x257e13(0x109)]('🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:',_0x5d83bf);return;}console[_0x257e13(0x109)](_0x257e13(0x197)+_0x3442a3['id']+_0x257e13(0x10a)+_0x3442a3['status']+_0x257e13(0x1a4)+_0x150df1[_0x257e13(0x14a)]),await this[_0x257e13(0x17a)](_0x3442a3['id'],_0x150df1[_0x257e13(0x14a)]),loggerService_1[_0x257e13(0x163)][_0x257e13(0x17c)](_0x257e13(0x16e),_0x3442a3['id'],_0x3442a3[_0x257e13(0x14a)],_0x150df1[_0x257e13(0x14a)],_0x556b01);}catch(_0x410328){console[_0x257e13(0x146)](_0x257e13(0x1dd),_0x410328),loggerService_1[_0x257e13(0x163)]['logWebhookError'](_0x257e13(0x16e),_0x410328,_0x556b01);throw _0x410328;}}async[a61_0x12967e(0x14b)](_0x436089){const _0x180a1b=a61_0x12967e;console[_0x180a1b(0x109)](_0x180a1b(0x1ab),JSON['stringify'](_0x436089,null,0x2));try{const _0xd33d73=await this[_0x180a1b(0x186)][_0x180a1b(0x13d)](_0x436089);console['log'](_0x180a1b(0x167),_0xd33d73);if(!_0xd33d73[_0x180a1b(0x108)]){console[_0x180a1b(0x146)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data'),console['error'](_0x180a1b(0x12c),Object[_0x180a1b(0x1c3)](_0x436089));throw new Error(_0x180a1b(0x192));}let _0x521b2f=null;console[_0x180a1b(0x109)](_0x180a1b(0x15c)+_0xd33d73[_0x180a1b(0x108)]),_0x521b2f=await database_1[_0x180a1b(0xfc)][_0x180a1b(0x168)][_0x180a1b(0x1e0)]({'where':{'AND':[{'gateway':_0x180a1b(0x120)},{'OR':[{'gatewayPaymentId':_0xd33d73['paymentId']},{'gatewayOrderId':_0xd33d73[_0x180a1b(0x108)]},{'id':_0xd33d73[_0x180a1b(0x108)]},{'orderId':_0xd33d73[_0x180a1b(0x108)]}]}]}}),console[_0x180a1b(0x109)](_0x180a1b(0x102)+(_0x521b2f?'Found\x20payment\x20'+_0x521b2f['id']:_0x180a1b(0x19a)));if(!_0x521b2f){console[_0x180a1b(0x146)](_0x180a1b(0x174)+_0xd33d73[_0x180a1b(0x108)]);return;}console[_0x180a1b(0x109)]('📊\x20Amer\x20webhook:\x20Payment\x20'+_0x521b2f['id']+_0x180a1b(0x1d9)+_0xd33d73[_0x180a1b(0x14a)]),await this['updatePaymentStatus'](_0x521b2f['id'],_0xd33d73[_0x180a1b(0x14a)],{'cardLast4':_0xd33d73[_0x180a1b(0x199)]?.[_0x180a1b(0x12a)],'paymentMethod':_0xd33d73[_0x180a1b(0x199)]?.[_0x180a1b(0x1ae)]});}catch(_0x1ba713){console['error'](_0x180a1b(0x129),_0x1ba713),loggerService_1[_0x180a1b(0x163)]['logWebhookError'](_0x180a1b(0x120),_0x1ba713,_0x436089);throw _0x1ba713;}}async[a61_0x12967e(0x1c6)](_0x1a5ac5,_0x435981){const _0x3db78b=a61_0x12967e,_0x2af4eb=Date['now']();try{const _0x345106=_0x1a5ac5['shop'],_0x13d1cc=_0x345106[_0x3db78b(0x19e)];if(!_0x13d1cc?.['webhookUrl']){console['log'](_0x3db78b(0x105)+_0x345106['id']);return;}const _0x3dab7d=_0x435981===_0x3db78b(0x148)?_0x3db78b(0xfe):_0x435981==='FAILED'?_0x3db78b(0x1c0):_0x435981===_0x3db78b(0x12e)?'payment.failed':_0x435981==='CHARGEBACK'?_0x3db78b(0x1c0):_0x435981===_0x3db78b(0x196)?_0x3db78b(0x1c0):_0x3db78b(0x128);let _0x2a98b9=[];if(_0x13d1cc['webhookEvents'])try{_0x2a98b9=Array[_0x3db78b(0x14e)](_0x13d1cc[_0x3db78b(0x18d)])?_0x13d1cc['webhookEvents']:JSON[_0x3db78b(0x118)](_0x13d1cc[_0x3db78b(0x18d)]);}catch(_0xdef9d3){console[_0x3db78b(0x146)](_0x3db78b(0x1a1),_0xdef9d3),_0x2a98b9=[];}if(!_0x2a98b9[_0x3db78b(0x18c)](_0x3dab7d)){console[_0x3db78b(0x109)](_0x3db78b(0x1b6)+_0x3dab7d+'\x20not\x20enabled\x20for\x20shop\x20'+_0x345106['id']);return;}const _0x521e1d={'event':_0x3dab7d,'payment':{'id':_0x1a5ac5['id'],'order_id':_0x1a5ac5[_0x3db78b(0x1a0)],'gateway_order_id':_0x1a5ac5[_0x3db78b(0x145)],'gateway':_0x1a5ac5[_0x3db78b(0x1b4)],'amount':_0x1a5ac5[_0x3db78b(0x114)],'currency':_0x1a5ac5[_0x3db78b(0x11a)],'status':_0x435981['toLowerCase'](),'customer_email':_0x1a5ac5['customerEmail'],'customer_name':_0x1a5ac5[_0x3db78b(0x193)],'failure_message':_0x1a5ac5[_0x3db78b(0x10c)],'tx_urls':_0x1a5ac5['txUrls']?JSON[_0x3db78b(0x118)](_0x1a5ac5[_0x3db78b(0x107)]):null,'created_at':_0x1a5ac5[_0x3db78b(0x1e1)],'updated_at':_0x1a5ac5[_0x3db78b(0x1d8)]}},_0x14c33c=await fetch(_0x13d1cc[_0x3db78b(0x116)],{'method':_0x3db78b(0x1cf),'headers':{'Content-Type':_0x3db78b(0x19f),'User-Agent':_0x3db78b(0x1aa)},'body':JSON[_0x3db78b(0x187)](_0x521e1d)}),_0x4ebacd=Date['now']()-_0x2af4eb,_0x65cc03=_0x14c33c['ok']?_0x3db78b(0x110):await _0x14c33c[_0x3db78b(0x124)]();loggerService_1['loggerService'][_0x3db78b(0x16f)](_0x1a5ac5[_0x3db78b(0x17d)],_0x13d1cc[_0x3db78b(0x116)],_0x3dab7d,_0x14c33c[_0x3db78b(0x14a)],_0x4ebacd,_0x521e1d),console['log'](_0x3db78b(0x131)+_0x13d1cc[_0x3db78b(0x116)]+_0x3db78b(0x103)+_0x14c33c[_0x3db78b(0x14a)]+'\x20('+_0x4ebacd+_0x3db78b(0x166));}catch(_0x1f28f3){console['error'](_0x3db78b(0x126),_0x1f28f3),loggerService_1[_0x3db78b(0x163)]['logShopWebhookError'](_0x1a5ac5[_0x3db78b(0x17d)],_0x1a5ac5[_0x3db78b(0x151)]?.['settings']?.[_0x3db78b(0x116)]||_0x3db78b(0x17f),'webhook_send',_0x1f28f3,{});}}async[a61_0x12967e(0x15e)](_0xb2c139,_0x51af8d){const _0x3b7770=a61_0x12967e;try{const _0x73a612={'PENDING':'created','PROCESSING':'processing','PAID':_0x3b7770(0x1b1),'FAILED':_0x3b7770(0x194),'EXPIRED':_0x3b7770(0x1d7),'REFUND':_0x3b7770(0x1a7),'CHARGEBACK':_0x3b7770(0x134)},_0x1423b9=_0x73a612[_0x51af8d];if(!_0x1423b9||_0x1423b9===_0x3b7770(0x1ce))return;await telegramBotService_1[_0x3b7770(0x172)][_0x3b7770(0x1a9)](_0xb2c139['shopId'],_0xb2c139,_0x1423b9);}catch(_0xf5c7ee){console[_0x3b7770(0x146)](_0x3b7770(0x1a5),_0xf5c7ee);}}async[a61_0x12967e(0x17b)](_0x48f041,_0x140b10){const _0xa5a8d0=a61_0x12967e;try{const _0x43a312=await database_1[_0xa5a8d0(0xfc)]['shop'][_0xa5a8d0(0x149)]({'where':{'id':_0x48f041},'select':{'gatewaySettings':!![]}});if(!_0x43a312?.[_0xa5a8d0(0x188)])return console['log'](_0xa5a8d0(0x11b)+_0x48f041+_0xa5a8d0(0x184)),0xa;const _0x59afc9=JSON['parse'](_0x43a312[_0xa5a8d0(0x188)]);for(const [_0x1dca0a,_0x32ec0d]of Object[_0xa5a8d0(0x1bc)](_0x59afc9)){if(_0x1dca0a[_0xa5a8d0(0x176)]()===_0x140b10[_0xa5a8d0(0x176)]()){const _0x2925fa=_0x32ec0d['commission']||0xa;return console[_0xa5a8d0(0x109)](_0xa5a8d0(0x13a)+_0x140b10+'\x20commission\x20for\x20shop\x20'+_0x48f041+':\x20'+_0x2925fa+'%'),_0x2925fa;}}return console[_0xa5a8d0(0x109)](_0xa5a8d0(0x156)+_0x140b10+'\x20in\x20shop\x20'+_0x48f041+_0xa5a8d0(0x11f)),0xa;}catch(_0x2664bb){return console[_0xa5a8d0(0x146)](_0xa5a8d0(0x10f)+_0x48f041+_0xa5a8d0(0x150)+_0x140b10+':',_0x2664bb),0xa;}}}exports[a61_0x12967e(0x1cd)]=WebhookService;function a61_0x1424(_0xcf04ef,_0x5dacd4){const _0x5e301a=a61_0x5e30();return a61_0x1424=function(_0x142423,_0x208c66){_0x142423=_0x142423-0xfc;let _0x4864f0=_0x5e301a[_0x142423];return _0x4864f0;},a61_0x1424(_0xcf04ef,_0x5dacd4);}function a61_0x5e30(){const _0x2bcfa0=['Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','toFixed','remitterName','\x22,\x20orderId=\x22','💰\x20Payment\x20','mastercard','logShopWebhookSent','%\x20gateway\x20commission)','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','telegramBotService','cointopay','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','./currencyService','toLowerCase','\x20and\x20-','processPlisioWebhook','323349oILUXJ','updatePaymentStatus','getGatewayCommission','logWebhookProcessed','shopId','paidAt','unknown','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','plisioService','🔄\x20Processing\x20Noda\x20webhook:','📊\x20KLYME\x20webhook:\x20Payment\x20',',\x20using\x20default\x20commission\x2010%','11473784JNawKI','amerService','stringify','gatewaySettings','1176200TqvfJB','Error\x20processing\x20KLYME\x20webhook:','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','includes','webhookEvents','\x22,\x20id=\x22','\x20-\x20','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','\x20->\x20','No\x20payment\x20ID\x20in\x20Amer\x20webhook','customerName','failed','./gateways/klymeService','REFUND','✅\x20Found\x20payment\x20','1220681lNjgfy','additionalInfo','Payment\x20not\x20found','🔄\x20Processing\x20CoinToPay2\x20webhook:','COMPLETED','\x22,\x20newStatus=\x22','settings','application/json','orderId','Error\x20parsing\x20webhook\x20events:','findMany','\x20not\x20found','\x20to\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','SINGLE','refund','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','sendPaymentNotification','TesSoft\x20Payment\x20System/1.0','🔄\x20Processing\x20Amer\x20webhook:','toUpperCase','🔄\x20Processing\x20MasterCard\x20webhook:','paymentMethod','CoinToPay2Service','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','paid','klyme','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','gateway','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','Webhook\x20event\x20','currencyService','3ZavSMg','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','toISOString','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','entries','\x20updated:\x20currentPayments=','💰\x20Removing\x20from\x20balance:\x20','./gateways/amerService','payment.failed','plisio','processCoinToPayWebhook','keys','Error\x20processing\x20Rapyd\x20webhook:','./gateways/coinToPayService','sendShopWebhook','processRapydWebhook','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','📈\x20Found\x20payment\x20link\x20','\x20USDT\x20(chargeback\x20penalty)','payment_method','__esModule','WebhookService','created','POST','📊\x20Noda\x20webhook:\x20Payment\x20','🔄\x20Processing\x20Plisio\x20webhook:','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','currentPayments',',\x20status=','\x20balance\x20updated:\x20','expired','updatedAt','\x20status\x20','amountAfterGatewayCommissionUSDT','CHARGEBACK','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','❌\x20Error\x20processing\x20MasterCard\x20webhook:','Error\x20processing\x20Plisio\x20webhook:','../config/database','findFirst','createdAt','default','\x20+\x20','payment.success','username','no\x20balance\x20change','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','🔍\x20Search\x20result:\x20','\x20with\x20status\x20','Found\x20payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20=\x20','txUrls','paymentId','log','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','Error\x20processing\x20CoinToPay\x20webhook:','failureMessage','defineProperty','klymeService','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','Success','nodaService','💰\x20Final\x20balance\x20after\x20chargeback:\x20','📈\x20Payment\x20','amount','AmerService','webhookUrl','Error\x20processing\x20CoinToPay2\x20webhook:','parse','🔄\x20Additional\x20data:','currency','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','💰\x20Amount\x20after\x20gateway\x20commission:\x20','coinToPayService','paymentLink',',\x20using\x20default\x2010%','amer','noda','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','No\x20payment\x20ID\x20in\x20Noda\x20webhook','text','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','Failed\x20to\x20send\x20shop\x20webhook:','masterCardService','payment.pending','❌\x20Error\x20processing\x20Amer\x20webhook:','cardLast4','update','❌\x20Available\x20webhook\x20fields:','876858UHaSRk','EXPIRED','rapydService','amountUSDT','📤\x20Shop\x20webhook\x20sent\x20to\x20','📈\x20Payment\x20details:\x20oldStatus=\x22','\x20USDT','chargeback','rapyd','968372FIaHAe','./gateways/plisioService','📝\x20Reason:\x20','processPlisioGatewayWebhook','Gateway\x20','❌\x20Payment\x20link\x20','webhook_status_change_','processWebhook','✅\x20Payment\x20link\x20','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','type','logWebhookError','$transaction','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','📊\x20Rapyd\x20webhook:\x20Payment\x20','gatewayOrderId','error','./gateways/coinToPay2Service','PAID','findUnique','status','processAmerWebhook',',\x20newStatus=','cointopay2','isArray','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook',',\x20gateway\x20','shop','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','🔄\x20Processing\x20Rapyd\x20webhook:','convertToUSDT','💰\x20Converting\x20','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','paymentLinkId','💰\x20Adding\x20to\x20balance:\x20','remitterIban','coinToPay2Service','balance','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','plisio_gateway','sendPaymentStatusNotification','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','KlymeService','242436jeRMdE','loggerService',',\x20currentPayments=','bankId','ms)','📊\x20Amer\x20webhook\x20result:','payment'];a61_0x5e30=function(){return _0x2bcfa0;};return a61_0x5e30();}