'use strict';const a52_0xc57733=a52_0x11bb;(function(_0x47e0ce,_0x1d1b33){const _0x142d8e=a52_0x11bb,_0x49fca8=_0x47e0ce();while(!![]){try{const _0x360a72=parseInt(_0x142d8e(0x247))/0x1*(parseInt(_0x142d8e(0x25c))/0x2)+-parseInt(_0x142d8e(0x236))/0x3+-parseInt(_0x142d8e(0x209))/0x4+parseInt(_0x142d8e(0x246))/0x5*(parseInt(_0x142d8e(0x22a))/0x6)+parseInt(_0x142d8e(0x267))/0x7+parseInt(_0x142d8e(0x254))/0x8*(parseInt(_0x142d8e(0x234))/0x9)+parseInt(_0x142d8e(0x227))/0xa;if(_0x360a72===_0x1d1b33)break;else _0x49fca8['push'](_0x49fca8['shift']());}catch(_0x4a9cb7){_0x49fca8['push'](_0x49fca8['shift']());}}}(a52_0x4192,0x48907));function a52_0x11bb(_0x383c9f,_0x282bda){const _0x41928d=a52_0x4192();return a52_0x11bb=function(_0x11bb69,_0x11cb44){_0x11bb69=_0x11bb69-0x1e3;let _0x37f94b=_0x41928d[_0x11bb69];return _0x37f94b;},a52_0x11bb(_0x383c9f,_0x282bda);}var __importDefault=this&&this[a52_0xc57733(0x21c)]||function(_0x250200){const _0x15b09f=a52_0xc57733;return _0x250200&&_0x250200[_0x15b09f(0x230)]?_0x250200:{'default':_0x250200};};function a52_0x4192(){const _0x5641e0=['ðŸ”—\x20Payment\x20','logWebhookError','coinToPayService','currency','failureMessage','plisioService','\x20and\x20gateway:\x20','16tcUros','text','Error\x20processing\x20Noda\x20webhook:','createdAt','stringify','processNodaWebhook','Webhook\x20event\x20','webhookEvents','2KUFSiV','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','shop','defineProperty','cardLast4','findFirst','No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook','customerEmail','txUrls','orderId','PENDING','3096618GshMqA','ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20','RapydService','EXPIRED','processWebhook','rapydService','rapyd','loggerService','webhookUrl','FAILED','./gateways/klymeService','plisio_gateway','bankId','klymeService','WebhookService','No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook','Payment\x20','NodaService','customerName','processKlymeWebhook','additionalInfo','toLowerCase','klyme_eu','ðŸ’¾\x20Failure\x20message\x20saved:\x20','application/json','../config/database','ms)','klyme','expired','handleSuccessfulPayment','Shop\x20webhook\x20sent\x20to\x20','\x20with\x20status\x20','paymentId','processCoinToPayWebhook','Error\x20parsing\x20tx_urls\x20for\x20webhook:','shopId','length','\x20from\x20','_webhook_','No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook','isArray','\x20status\x20change:\x20','status','Processing\x20Plisio\x20Gateway\x20webhook:','Processing\x20Plisio\x20webhook:','plisio','\x20webhook','ðŸ’¥\x20Payment\x20','Error\x20parsing\x20webhook\x20events:','âœ…\x20Payment\x20','failed','1810636GmVMRF','Processing\x20Noda\x20webhook:','./gateways/coinToPayService','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','update','default','noda','paymentMethod','Processing\x20Rapyd\x20webhook:','PAID','./gateways/plisioService','klyme_','payment','nodaService','./telegramBotService','settings','ðŸ”„\x20Updating\x20payment\x20','cointopay','remitterName','__importDefault','Error\x20processing\x20KLYME\x20webhook:','error','paymentLinkService','KlymeService','webhook_send','log','parse','CoinToPayService','\x20transaction\x20URLs:','./paymentLinkService','138790tUFxha','paid','processRapydWebhook','6pgDeqa','payment.pending','gatewayOrderId','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20','\x20status\x20to\x20','__esModule','updatePaymentStatus','logWebhookProcessed','payment.failed','1214361pCLgXv','created','1039266JsrnXB','now','processPlisioWebhook','includes','\x20status\x20unchanged\x20(','\x20not\x20enabled\x20for\x20shop\x20','\x20URLs','gateway','No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook','region','./gateways/rapydService','\x20failure\x20message:\x20','\x20->\x20','logShopWebhookSent','remitterIban','sendPaymentStatusNotification','928775foUIXh','184438HXNiYS','webhookLog','unknown','logShopWebhookError','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook','amount'];a52_0x4192=function(){return _0x5641e0;};return a52_0x4192();}Object[a52_0xc57733(0x25f)](exports,a52_0xc57733(0x230),{'value':!![]}),exports[a52_0xc57733(0x1e4)]=void 0x0;const database_1=__importDefault(require(a52_0xc57733(0x1ef))),plisioService_1=require(a52_0xc57733(0x213)),rapydService_1=require(a52_0xc57733(0x240)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a52_0xc57733(0x20b)),klymeService_1=require(a52_0xc57733(0x271)),telegramBotService_1=require(a52_0xc57733(0x217)),paymentLinkService_1=require(a52_0xc57733(0x226)),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x5c192c=a52_0xc57733;this['plisioService']=new plisioService_1['PlisioService'](),this[_0x5c192c(0x26c)]=new rapydService_1[(_0x5c192c(0x269))](),this['nodaService']=new nodaService_1[(_0x5c192c(0x1e7))](),this[_0x5c192c(0x24f)]=new coinToPayService_1[(_0x5c192c(0x224))](),this[_0x5c192c(0x1e3)]=new klymeService_1[(_0x5c192c(0x220))](),this[_0x5c192c(0x21f)]=new paymentLinkService_1['PaymentLinkService']();}async[a52_0xc57733(0x238)](_0x1480f7){const _0x105f72=a52_0xc57733;console[_0x105f72(0x222)](_0x105f72(0x202),_0x1480f7);try{const _0x56510a=await this['plisioService'][_0x105f72(0x26b)](_0x1480f7);if(!_0x56510a[_0x105f72(0x1f6)]){console[_0x105f72(0x21e)](_0x105f72(0x24b));return;}await this[_0x105f72(0x231)](_0x56510a[_0x105f72(0x1f6)],_0x56510a[_0x105f72(0x200)],'plisio',_0x1480f7,undefined,undefined,_0x56510a[_0x105f72(0x264)]),loggerService_1[_0x105f72(0x26e)][_0x105f72(0x232)](_0x105f72(0x203),_0x56510a[_0x105f72(0x1f6)],_0x105f72(0x266),_0x56510a[_0x105f72(0x200)],_0x1480f7);}catch(_0x4691f5){console['error']('Error\x20processing\x20Plisio\x20webhook:',_0x4691f5),loggerService_1[_0x105f72(0x26e)][_0x105f72(0x24e)](_0x105f72(0x203),_0x4691f5,_0x1480f7);throw _0x4691f5;}}async['processPlisioGatewayWebhook'](_0x2fd234){const _0x5a564b=a52_0xc57733;console['log'](_0x5a564b(0x201),_0x2fd234);try{const _0x71a180=await this[_0x5a564b(0x252)][_0x5a564b(0x26b)](_0x2fd234);if(!_0x71a180[_0x5a564b(0x1f6)]){console[_0x5a564b(0x21e)]('No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook');return;}await this[_0x5a564b(0x231)](_0x71a180[_0x5a564b(0x1f6)],_0x71a180[_0x5a564b(0x200)],_0x5a564b(0x203),_0x2fd234,undefined,undefined,_0x71a180['txUrls']),loggerService_1[_0x5a564b(0x26e)][_0x5a564b(0x232)](_0x5a564b(0x272),_0x71a180[_0x5a564b(0x1f6)],'PENDING',_0x71a180[_0x5a564b(0x200)],_0x2fd234);}catch(_0x1621b6){console[_0x5a564b(0x21e)](_0x5a564b(0x22d),_0x1621b6),loggerService_1['loggerService'][_0x5a564b(0x24e)]('plisio_gateway',_0x1621b6,_0x2fd234);throw _0x1621b6;}}async[a52_0xc57733(0x229)](_0x351535){const _0x5bc4cb=a52_0xc57733;console[_0x5bc4cb(0x222)](_0x5bc4cb(0x211),_0x351535);try{const _0x2aa31a=await this[_0x5bc4cb(0x26c)][_0x5bc4cb(0x26b)](_0x351535);if(!_0x2aa31a[_0x5bc4cb(0x1f6)]){console['error'](_0x5bc4cb(0x1fd));return;}await this[_0x5bc4cb(0x231)](_0x2aa31a[_0x5bc4cb(0x1f6)],_0x2aa31a[_0x5bc4cb(0x200)],_0x5bc4cb(0x26d),_0x351535,_0x2aa31a[_0x5bc4cb(0x251)],_0x2aa31a[_0x5bc4cb(0x1ea)]),loggerService_1[_0x5bc4cb(0x26e)][_0x5bc4cb(0x232)](_0x5bc4cb(0x26d),_0x2aa31a[_0x5bc4cb(0x1f6)],_0x5bc4cb(0x266),_0x2aa31a[_0x5bc4cb(0x200)],_0x351535);}catch(_0xa915f2){console[_0x5bc4cb(0x21e)]('Error\x20processing\x20Rapyd\x20webhook:',_0xa915f2),loggerService_1['loggerService']['logWebhookError'](_0x5bc4cb(0x26d),_0xa915f2,_0x351535);throw _0xa915f2;}}async[a52_0xc57733(0x259)](_0xfd3f5e){const _0x302652=a52_0xc57733;console[_0x302652(0x222)](_0x302652(0x20a),_0xfd3f5e);try{const _0x46f42c=await this[_0x302652(0x216)]['processWebhook'](_0xfd3f5e);if(!_0x46f42c[_0x302652(0x1f6)]){console['error'](_0x302652(0x23e));return;}await this[_0x302652(0x231)](_0x46f42c[_0x302652(0x1f6)],_0x46f42c[_0x302652(0x200)],'noda',_0xfd3f5e,undefined,_0x46f42c['additionalInfo']),loggerService_1[_0x302652(0x26e)][_0x302652(0x232)](_0x302652(0x20f),_0x46f42c[_0x302652(0x1f6)],'PENDING',_0x46f42c[_0x302652(0x200)],_0xfd3f5e);}catch(_0x5121f8){console['error'](_0x302652(0x256),_0x5121f8),loggerService_1[_0x302652(0x26e)][_0x302652(0x24e)](_0x302652(0x20f),_0x5121f8,_0xfd3f5e);throw _0x5121f8;}}async[a52_0xc57733(0x1f7)](_0x2dc935){const _0x4f4525=a52_0xc57733;console[_0x4f4525(0x222)]('Processing\x20CoinToPay\x20webhook:',_0x2dc935);try{const _0x587f5b=await this[_0x4f4525(0x24f)]['processWebhook'](_0x2dc935);if(!_0x587f5b[_0x4f4525(0x1f6)]){console[_0x4f4525(0x21e)](_0x4f4525(0x1e5));return;}await this[_0x4f4525(0x231)](_0x587f5b[_0x4f4525(0x1f6)],_0x587f5b[_0x4f4525(0x200)],_0x4f4525(0x21a),_0x2dc935),loggerService_1[_0x4f4525(0x26e)][_0x4f4525(0x232)](_0x4f4525(0x21a),_0x587f5b[_0x4f4525(0x1f6)],_0x4f4525(0x266),_0x587f5b[_0x4f4525(0x200)],_0x2dc935);}catch(_0x3e7576){console['error']('Error\x20processing\x20CoinToPay\x20webhook:',_0x3e7576),loggerService_1['loggerService'][_0x4f4525(0x24e)](_0x4f4525(0x21a),_0x3e7576,_0x2dc935);throw _0x3e7576;}}async[a52_0xc57733(0x1e9)](_0x4ca4a0){const _0x34a858=a52_0xc57733;console[_0x34a858(0x222)]('Processing\x20KLYME\x20webhook:',_0x4ca4a0);try{const _0x3dc974=await this[_0x34a858(0x1e3)][_0x34a858(0x26b)](_0x4ca4a0);if(!_0x3dc974['paymentId']){console['error'](_0x34a858(0x262));return;}const _0x2189f0=_0x3dc974['region']?_0x34a858(0x214)+_0x3dc974[_0x34a858(0x23f)][_0x34a858(0x1eb)]():_0x34a858(0x1ec);await this[_0x34a858(0x231)](_0x3dc974[_0x34a858(0x1f6)],_0x3dc974['status'],_0x2189f0,_0x4ca4a0,undefined,_0x3dc974['additionalInfo']),loggerService_1[_0x34a858(0x26e)][_0x34a858(0x232)](_0x34a858(0x1f1),_0x3dc974[_0x34a858(0x1f6)],_0x34a858(0x266),_0x3dc974[_0x34a858(0x200)],_0x4ca4a0);}catch(_0x22aa15){console[_0x34a858(0x21e)](_0x34a858(0x21d),_0x22aa15),loggerService_1[_0x34a858(0x26e)][_0x34a858(0x24e)](_0x34a858(0x1f1),_0x22aa15,_0x4ca4a0);throw _0x22aa15;}}async['updatePaymentStatus'](_0x3a4972,_0x18adba,_0x5e7917,_0x23770c,_0x570f5c,_0x2340e2,_0x1a8894){const _0xb4ecaa=a52_0xc57733;console[_0xb4ecaa(0x222)](_0xb4ecaa(0x219)+_0x3a4972+_0xb4ecaa(0x22f)+_0x18adba+_0xb4ecaa(0x1fb)+_0x5e7917+_0xb4ecaa(0x204));_0x570f5c&&console[_0xb4ecaa(0x222)](_0xb4ecaa(0x205)+_0x3a4972+_0xb4ecaa(0x241)+_0x570f5c);_0x1a8894&&_0x1a8894[_0xb4ecaa(0x1fa)]>0x0&&console[_0xb4ecaa(0x222)](_0xb4ecaa(0x24d)+_0x3a4972+_0xb4ecaa(0x225),_0x1a8894);const _0x43c4a8=await database_1[_0xb4ecaa(0x20e)]['payment'][_0xb4ecaa(0x261)]({'where':{'gatewayOrderId':_0x3a4972,'gateway':_0x5e7917},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x43c4a8){console[_0xb4ecaa(0x21e)](_0xb4ecaa(0x20c)+_0x3a4972+_0xb4ecaa(0x253)+_0x5e7917);return;}const _0x21853d=_0x43c4a8[_0xb4ecaa(0x200)];if(_0x21853d===_0x18adba){console[_0xb4ecaa(0x222)](_0xb4ecaa(0x1e6)+_0x43c4a8['id']+_0xb4ecaa(0x23a)+_0x18adba+')');return;}console[_0xb4ecaa(0x222)](_0xb4ecaa(0x1e6)+_0x43c4a8['id']+_0xb4ecaa(0x1ff)+_0x21853d+_0xb4ecaa(0x242)+_0x18adba);const _0x1af88b={'status':_0x18adba,'updatedAt':new Date()};_0x570f5c&&(_0x1af88b['failureMessage']=_0x570f5c,console['log']('ðŸ’¾\x20Saving\x20failure\x20message:\x20'+_0x570f5c));_0x1a8894&&_0x1a8894[_0xb4ecaa(0x1fa)]>0x0&&(_0x1af88b['txUrls']=JSON[_0xb4ecaa(0x258)](_0x1a8894),console[_0xb4ecaa(0x222)](_0xb4ecaa(0x268)+JSON['stringify'](_0x1a8894)));_0x18adba==='PAID'&&_0x21853d!==_0xb4ecaa(0x212)&&(_0x1af88b['paidAt']=new Date());_0x2340e2&&(_0x2340e2[_0xb4ecaa(0x260)]&&(_0x1af88b[_0xb4ecaa(0x260)]=_0x2340e2[_0xb4ecaa(0x260)]),_0x2340e2['paymentMethod']&&(_0x1af88b[_0xb4ecaa(0x210)]=_0x2340e2['paymentMethod']),_0x2340e2[_0xb4ecaa(0x273)]&&(_0x1af88b['bankId']=_0x2340e2[_0xb4ecaa(0x273)]),_0x2340e2[_0xb4ecaa(0x244)]&&(_0x1af88b[_0xb4ecaa(0x244)]=_0x2340e2[_0xb4ecaa(0x244)]),_0x2340e2[_0xb4ecaa(0x21b)]&&(_0x1af88b[_0xb4ecaa(0x21b)]=_0x2340e2[_0xb4ecaa(0x21b)]));await database_1[_0xb4ecaa(0x20e)][_0xb4ecaa(0x215)][_0xb4ecaa(0x20d)]({'where':{'id':_0x43c4a8['id']},'data':_0x1af88b});if(_0x18adba===_0xb4ecaa(0x212)&&_0x21853d!==_0xb4ecaa(0x212))try{await this['paymentLinkService'][_0xb4ecaa(0x1f3)](_0x43c4a8['id']);}catch(_0x56dbc1){console[_0xb4ecaa(0x21e)]('Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x56dbc1);}await database_1[_0xb4ecaa(0x20e)][_0xb4ecaa(0x248)]['create']({'data':{'paymentId':_0x43c4a8['id'],'shopId':_0x43c4a8[_0xb4ecaa(0x1f9)],'event':_0x5e7917+_0xb4ecaa(0x1fc)+_0x18adba[_0xb4ecaa(0x1eb)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x21853d,'newStatus':_0x18adba,'failureMessage':_0x570f5c,'txUrls':_0x1a8894,'webhookData':_0x23770c})}}),await this['sendShopWebhook'](_0x43c4a8,_0x18adba),await this[_0xb4ecaa(0x245)](_0x43c4a8,_0x18adba),console[_0xb4ecaa(0x222)](_0xb4ecaa(0x207)+_0x43c4a8['id']+'\x20updated\x20successfully:\x20'+_0x21853d+_0xb4ecaa(0x242)+_0x18adba),_0x570f5c&&console[_0xb4ecaa(0x222)](_0xb4ecaa(0x1ed)+_0x570f5c),_0x1a8894&&_0x1a8894[_0xb4ecaa(0x1fa)]>0x0&&console[_0xb4ecaa(0x222)](_0xb4ecaa(0x22e)+_0x1a8894[_0xb4ecaa(0x1fa)]+_0xb4ecaa(0x23c));}async['sendShopWebhook'](_0x9f8a97,_0x7894ad){const _0x33495a=a52_0xc57733,_0x125279=Date['now']();try{const _0x265b27=_0x9f8a97['shop'],_0xde247c=_0x265b27[_0x33495a(0x218)];if(!_0xde247c?.['webhookUrl']){console[_0x33495a(0x222)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x265b27['id']);return;}const _0x22014d=_0x7894ad===_0x33495a(0x212)?'payment.success':_0x7894ad===_0x33495a(0x270)?_0x33495a(0x233):_0x7894ad===_0x33495a(0x26a)?_0x33495a(0x233):_0x33495a(0x22b);let _0x1489af=[];if(_0xde247c[_0x33495a(0x25b)])try{_0x1489af=Array[_0x33495a(0x1fe)](_0xde247c[_0x33495a(0x25b)])?_0xde247c[_0x33495a(0x25b)]:JSON[_0x33495a(0x223)](_0xde247c[_0x33495a(0x25b)]);}catch(_0x3fb720){console[_0x33495a(0x21e)](_0x33495a(0x206),_0x3fb720),_0x1489af=[];}if(!_0x1489af[_0x33495a(0x239)](_0x22014d)){console[_0x33495a(0x222)](_0x33495a(0x25a)+_0x22014d+_0x33495a(0x23b)+_0x265b27['id']);return;}let _0x514995;if(_0x9f8a97[_0x33495a(0x264)])try{_0x514995=JSON['parse'](_0x9f8a97[_0x33495a(0x264)]);}catch(_0x7ee00f){console[_0x33495a(0x21e)](_0x33495a(0x1f8),_0x7ee00f),_0x514995=undefined;}const _0x4c6c9b={'event':_0x22014d,'payment':{'id':_0x9f8a97['id'],'order_id':_0x9f8a97[_0x33495a(0x265)],'gateway_order_id':_0x9f8a97[_0x33495a(0x22c)],'gateway':_0x9f8a97[_0x33495a(0x23d)],'amount':_0x9f8a97[_0x33495a(0x24c)],'currency':_0x9f8a97[_0x33495a(0x250)],'status':_0x7894ad[_0x33495a(0x1eb)](),'customer_email':_0x9f8a97[_0x33495a(0x263)],'customer_name':_0x9f8a97[_0x33495a(0x1e8)],'failure_message':_0x9f8a97[_0x33495a(0x251)],'tx_urls':_0x514995,'created_at':_0x9f8a97[_0x33495a(0x257)],'updated_at':new Date()}},_0x1a65ba=await fetch(_0xde247c[_0x33495a(0x26f)],{'method':'POST','headers':{'Content-Type':_0x33495a(0x1ee),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x4c6c9b)}),_0x2409b3=Date[_0x33495a(0x237)]()-_0x125279,_0x398f14=_0x1a65ba['ok']?'Success':await _0x1a65ba[_0x33495a(0x255)]();loggerService_1['loggerService'][_0x33495a(0x243)](_0x9f8a97[_0x33495a(0x1f9)],_0xde247c[_0x33495a(0x26f)],_0x22014d,_0x1a65ba[_0x33495a(0x200)],_0x2409b3,_0x4c6c9b),console[_0x33495a(0x222)](_0x33495a(0x1f4)+_0xde247c[_0x33495a(0x26f)]+_0x33495a(0x1f5)+_0x1a65ba[_0x33495a(0x200)]+'\x20('+_0x2409b3+_0x33495a(0x1f0));}catch(_0x371cd9){console[_0x33495a(0x21e)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x371cd9),loggerService_1['loggerService'][_0x33495a(0x24a)](_0x9f8a97[_0x33495a(0x1f9)],_0x9f8a97[_0x33495a(0x25e)]?.['settings']?.[_0x33495a(0x26f)]||_0x33495a(0x249),_0x33495a(0x221),_0x371cd9,{});}}async[a52_0xc57733(0x245)](_0xc17e3e,_0x579579){const _0x38790a=a52_0xc57733;try{const _0x78a250={'PENDING':'created','PAID':_0x38790a(0x228),'FAILED':_0x38790a(0x208),'EXPIRED':_0x38790a(0x1f2)},_0x43a8ec=_0x78a250[_0x579579];if(!_0x43a8ec||_0x43a8ec===_0x38790a(0x235))return;await telegramBotService_1['telegramBotService']['sendPaymentNotification'](_0xc17e3e['shopId'],_0xc17e3e,_0x43a8ec);}catch(_0xe9d317){console[_0x38790a(0x21e)](_0x38790a(0x25d),_0xe9d317);}}}exports[a52_0xc57733(0x1e4)]=WebhookService;