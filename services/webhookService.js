'use strict';const a58_0x72cb28=a58_0x5630;function a58_0x4713(){const _0x366440=['bankId','created','./currencyService','\x20=\x20','create','amountUSDT','Payment\x20not\x20found','Failed\x20to\x20send\x20shop\x20webhook:','processPlisioWebhook','PlisioService','RapydService','\x20updated:\x20currentPayments=','üí∞\x20Adding\x20to\x20balance:\x20','POST','gatewayOrderId','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','TesSoft\x20Payment\x20System/1.0','cardLast4','‚ùå\x20Payment\x20link\x20','../config/database','noda','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','orderId','gateway','update','4968546mhgDHX','./gateways/mastercardService','findMany','üí∞\x20Payment\x20','amount','üîÑ\x20Processing\x20Noda\x20webhook:','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','webhookEvents','Error\x20processing\x20CoinToPay2\x20webhook:','REFUND','shopId','findFirst','üìà\x20Payment\x20details:\x20oldStatus=\x22','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','üîç\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','plisio','üí∏\x20Additional\x20chargeback\x20penalty:\x20-','error','448xAoTkc','updatePaymentStatus','currencyService','webhook_status_change_','\x20and\x20-','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','Payment\x20','username','__importDefault','now','default','telegramBotService','processNodaWebhook','üîÑ\x20Additional\x20data:','payment.success','processMasterCardWebhook','failed','14517HNoCgL','payment_method','./telegramBotService','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','290194xbQziB','\x20->\x20','üìä\x20Plisio\x20webhook:\x20Payment\x20','\x20USDT\x20(payment\x20became\x20PAID)','4779dGdJJG','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','__esModule','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','no\x20balance\x20change','coinToPayService','üì§\x20Shop\x20webhook\x20sent\x20to\x20','\x20status\x20','\x20to\x20','nodaService','loggerService','webhookUrl','SINGLE','defineProperty','coinToPay2Service','75mnxYoB','\x20not\x20enabled\x20for\x20shop\x20','üîç\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','17870NVGEzw','CoinToPay2Service','processing','parse','chargeback','logWebhookError','üîÑ\x20Processing\x20CoinToPay2\x20webhook:','PAID','paymentLinkId','üîÑ\x20updatePaymentStatus\x20called:\x20paymentId=','type','payment.failed','paymentLink','\x20-\x20','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','settings','CHARGEBACK','ms)','üìù\x20Reason:\x20','paid','./gateways/klymeService','$transaction','\x22,\x20orderId=\x22','üîç\x20Search\x20result:\x20','Error\x20processing\x20KLYME\x20webhook:','üìä\x20Noda\x20webhook:\x20Payment\x20','customerName','currency','‚úÖ\x20Payment\x20link\x20','\x20not\x20found','system','processWebhook','sendShopWebhook','txUrls','toISOString','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20',',\x20status=','üìà\x20Payment\x20','paidAt','webhookLog','payment','processCoinToPayWebhook','üìä\x20MasterCard\x20webhook\x20result:','unknown','findUnique','sendPaymentStatusNotification','\x20USDT','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','refund','toLowerCase','mastercard','üìà\x20Found\x20payment\x20link\x20','text','masterCardService','\x20with\x20status\x20','klyme','klymeService','./gateways/coinToPayService','remitterIban','log','NodaService','processKlymeWebhook','WebhookService','failureMessage','rapydService','additionalInfo','stringify','application/json','Error\x20processing\x20Rapyd\x20webhook:','toUpperCase','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','Found\x20payment\x20','üìä\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','üí∞\x20Removing\x20from\x20balance:\x20','\x20+\x20','üîÑ\x20Processing\x20Plisio\x20Gateway\x20webhook:','EXPIRED','convertToUSDT','No\x20payment\x20ID\x20in\x20Noda\x20webhook','Error\x20processing\x20CoinToPay\x20webhook:','keys','6979665GtSzop','expired',',\x20newStatus=','üîÑ\x20Processing\x20MasterCard\x20webhook:','rapyd','715758ltqXBX','chargebackAmount','paymentMethod','webhook_send','plisioService','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','Error\x20processing\x20Plisio\x20webhook:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x22,\x20newStatus=\x22','6cVppfx','logShopWebhookError','status','toFixed','üìä\x20CoinToPay\x20webhook:\x20Payment\x20','‚ùå\x20Available\x20webhook\x20fields:','üîÑ\x20Processing\x20CoinToPay\x20webhook:','12590816MUakSi','isArray','üí∞\x20Final\x20balance\x20after\x20chargeback:\x20','./gateways/plisioService','currentPayments','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','shop','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','processRapydWebhook','logWebhookProcessed','paymentId','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','‚ùå\x20Error\x20processing\x20MasterCard\x20webhook:','üìä\x20KLYME\x20webhook:\x20Payment\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','processCoinToPay2Webhook','plisio_gateway','FAILED','balance','includes','‚úÖ\x20Found\x20payment\x20','\x20balance\x20updated:\x20'];a58_0x4713=function(){return _0x366440;};return a58_0x4713();}(function(_0x51692c,_0x12b6dd){const _0x19d9a8=a58_0x5630,_0x47f6fb=_0x51692c();while(!![]){try{const _0x3b5fd1=-parseInt(_0x19d9a8(0x1ba))/0x1*(parseInt(_0x19d9a8(0x15d))/0x2)+parseInt(_0x19d9a8(0x1b6))/0x3*(parseInt(_0x19d9a8(0x1a5))/0x4)+-parseInt(_0x19d9a8(0x1ce))/0x5*(parseInt(_0x19d9a8(0x154))/0x6)+parseInt(_0x19d9a8(0x14f))/0x7+parseInt(_0x19d9a8(0x164))/0x8+parseInt(_0x19d9a8(0x1be))/0x9*(parseInt(_0x19d9a8(0x1d1))/0xa)+-parseInt(_0x19d9a8(0x193))/0xb;if(_0x3b5fd1===_0x12b6dd)break;else _0x47f6fb['push'](_0x47f6fb['shift']());}catch(_0x52c0f0){_0x47f6fb['push'](_0x47f6fb['shift']());}}}(a58_0x4713,0xe7f85));var __importDefault=this&&this[a58_0x72cb28(0x1ad)]||function(_0x41d6d0){const _0x2e5938=a58_0x72cb28;return _0x41d6d0&&_0x41d6d0[_0x2e5938(0x1c1)]?_0x41d6d0:{'default':_0x41d6d0};};function a58_0x5630(_0x32dc7f,_0x1e282d){const _0x471393=a58_0x4713();return a58_0x5630=function(_0x563001,_0x292c3c){_0x563001=_0x563001-0x140;let _0x47a483=_0x471393[_0x563001];return _0x47a483;},a58_0x5630(_0x32dc7f,_0x1e282d);}Object[a58_0x72cb28(0x1cc)](exports,a58_0x72cb28(0x1c1),{'value':!![]}),exports[a58_0x72cb28(0x20f)]=void 0x0;const database_1=__importDefault(require(a58_0x72cb28(0x18d))),plisioService_1=require(a58_0x72cb28(0x167)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a58_0x72cb28(0x20a)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require(a58_0x72cb28(0x1e5)),mastercardService_1=require(a58_0x72cb28(0x194)),telegramBotService_1=require(a58_0x72cb28(0x1b8)),currencyService_1=require(a58_0x72cb28(0x17c)),loggerService_1=require('./loggerService');class WebhookService{constructor(){const _0x10b804=a58_0x72cb28;this[_0x10b804(0x158)]=new plisioService_1[(_0x10b804(0x183))](),this[_0x10b804(0x211)]=new rapydService_1[(_0x10b804(0x184))](),this[_0x10b804(0x1c8)]=new nodaService_1[(_0x10b804(0x20d))](),this[_0x10b804(0x1c4)]=new coinToPayService_1['CoinToPayService'](),this[_0x10b804(0x1cd)]=new coinToPay2Service_1[(_0x10b804(0x1d2))](),this[_0x10b804(0x209)]=new klymeService_1['KlymeService'](),this['masterCardService']=new mastercardService_1['MasterCardService']();}async[a58_0x72cb28(0x1a6)](_0x68942,_0x3e7a4c,_0x450616){const _0x44f95e=a58_0x72cb28;console[_0x44f95e(0x20c)](_0x44f95e(0x1da)+_0x68942+_0x44f95e(0x151)+_0x3e7a4c),console['log'](_0x44f95e(0x1b2),_0x450616),await database_1['default'][_0x44f95e(0x1e6)](async _0xea7dd5=>{const _0x555e07=_0x44f95e,_0x3578f4=await _0xea7dd5[_0x555e07(0x1f9)][_0x555e07(0x1fd)]({'where':{'id':_0x68942},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3578f4)throw new Error(_0x555e07(0x1ab)+_0x68942+_0x555e07(0x1ee));const _0x26fd8e=_0x3578f4[_0x555e07(0x15f)],_0x49fdef=_0x3578f4[_0x555e07(0x16a)];console[_0x555e07(0x20c)](_0x555e07(0x196)+_0x68942+':\x20'+_0x26fd8e+_0x555e07(0x1bb)+_0x3e7a4c),console[_0x555e07(0x20c)]('üè™\x20Shop\x20'+_0x49fdef[_0x555e07(0x1ac)]+'\x20current\x20balance:\x20'+_0x49fdef['balance']+_0x555e07(0x1ff));const _0x562a58={'status':_0x3e7a4c['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x555e07(0x1ef),'statusChangedAt':new Date()};_0x450616?.[_0x555e07(0x210)]&&(_0x562a58[_0x555e07(0x210)]=_0x450616[_0x555e07(0x210)]);_0x450616?.[_0x555e07(0x1f2)]&&(_0x562a58[_0x555e07(0x1f2)]=JSON['stringify'](_0x450616[_0x555e07(0x1f2)]));_0x450616?.['cardLast4']&&(_0x562a58[_0x555e07(0x18b)]=_0x450616[_0x555e07(0x18b)]);_0x450616?.['paymentMethod']&&(_0x562a58[_0x555e07(0x156)]=_0x450616[_0x555e07(0x156)]);_0x450616?.[_0x555e07(0x17a)]&&(_0x562a58[_0x555e07(0x17a)]=_0x450616[_0x555e07(0x17a)]);_0x450616?.[_0x555e07(0x20b)]&&(_0x562a58['remitterIban']=_0x450616['remitterIban']);_0x450616?.['remitterName']&&(_0x562a58['remitterName']=_0x450616['remitterName']);let _0x20e02d=_0x49fdef[_0x555e07(0x176)],_0x5e5c5f='';if(_0x3e7a4c[_0x555e07(0x143)]()===_0x555e07(0x1d8)&&_0x26fd8e!==_0x555e07(0x1d8)){const _0x2ebb18=await currencyService_1[_0x555e07(0x1a7)][_0x555e07(0x14b)](_0x3578f4[_0x555e07(0x197)],_0x3578f4[_0x555e07(0x1ec)]);_0x20e02d+=_0x2ebb18,_0x5e5c5f='+'+_0x2ebb18[_0x555e07(0x160)](0x6)+_0x555e07(0x1bd),_0x562a58[_0x555e07(0x17f)]=_0x2ebb18,_0x562a58[_0x555e07(0x1f7)]=new Date(),console['log']('üí∞\x20Converting\x20'+_0x3578f4['amount']+'\x20'+_0x3578f4[_0x555e07(0x1ec)]+_0x555e07(0x1bb)+_0x2ebb18[_0x555e07(0x160)](0x6)+_0x555e07(0x1ff)),console[_0x555e07(0x20c)](_0x555e07(0x186)+_0x49fdef[_0x555e07(0x176)]+_0x555e07(0x148)+_0x2ebb18[_0x555e07(0x160)](0x6)+_0x555e07(0x17d)+_0x20e02d['toFixed'](0x6)+'\x20USDT');}else{if(_0x26fd8e===_0x555e07(0x1d8)&&_0x3e7a4c['toUpperCase']()!==_0x555e07(0x1d8)){const _0x36b80d=_0x3578f4[_0x555e07(0x17f)];_0x36b80d&&(_0x20e02d-=_0x36b80d,_0x5e5c5f='-'+_0x36b80d[_0x555e07(0x160)](0x6)+_0x555e07(0x1bf),_0x562a58[_0x555e07(0x17f)]=null,_0x562a58['paidAt']=null,console[_0x555e07(0x20c)](_0x555e07(0x147)+_0x49fdef[_0x555e07(0x176)]+_0x555e07(0x1de)+_0x36b80d['toFixed'](0x6)+'\x20=\x20'+_0x20e02d[_0x555e07(0x160)](0x6)+_0x555e07(0x1ff)));}}if(_0x3e7a4c[_0x555e07(0x143)]()==='CHARGEBACK'){const _0x1ed2d8=_0x450616?.[_0x555e07(0x155)]||0x0;_0x1ed2d8>0x0&&(_0x20e02d-=_0x1ed2d8,_0x5e5c5f+=_0x555e07(0x1a9)+_0x1ed2d8[_0x555e07(0x160)](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0x562a58['chargebackAmount']=_0x1ed2d8,console[_0x555e07(0x20c)](_0x555e07(0x1a3)+_0x1ed2d8[_0x555e07(0x160)](0x6)+_0x555e07(0x1ff)),console[_0x555e07(0x20c)](_0x555e07(0x166)+_0x20e02d[_0x555e07(0x160)](0x6)+_0x555e07(0x1ff)));}const _0x178223=await _0xea7dd5[_0x555e07(0x1f9)]['update']({'where':{'id':_0x68942},'data':_0x562a58});_0x20e02d!==_0x49fdef[_0x555e07(0x176)]&&(await _0xea7dd5[_0x555e07(0x16a)][_0x555e07(0x192)]({'where':{'id':_0x49fdef['id']},'data':{'balance':_0x20e02d}}),console[_0x555e07(0x20c)]('‚úÖ\x20Shop\x20'+_0x49fdef[_0x555e07(0x1ac)]+_0x555e07(0x179)+_0x49fdef[_0x555e07(0x176)][_0x555e07(0x160)](0x6)+'\x20->\x20'+_0x20e02d[_0x555e07(0x160)](0x6)+_0x555e07(0x1ff)),console[_0x555e07(0x20c)](_0x555e07(0x1e3)+_0x5e5c5f));await _0xea7dd5[_0x555e07(0x1f8)][_0x555e07(0x17e)]({'data':{'paymentId':_0x68942,'shopId':_0x49fdef['id'],'event':_0x555e07(0x1a8)+_0x3e7a4c[_0x555e07(0x202)](),'statusCode':0xc8,'responseBody':JSON[_0x555e07(0x140)]({'oldStatus':_0x26fd8e,'newStatus':_0x3e7a4c[_0x555e07(0x143)](),'balanceChange':_0x5e5c5f||_0x555e07(0x1c3),'oldBalance':_0x49fdef[_0x555e07(0x176)],'newBalance':_0x20e02d,'amountUSDT':_0x562a58[_0x555e07(0x17f)],'additionalData':_0x450616,'timestamp':new Date()[_0x555e07(0x1f3)]()})}}),await this[_0x555e07(0x1f1)]({..._0x3578f4,..._0x178223,'shop':_0x49fdef},_0x3e7a4c[_0x555e07(0x143)]()),await this[_0x555e07(0x1fe)]({..._0x3578f4,..._0x178223},_0x3e7a4c['toUpperCase']());if(_0x26fd8e!==_0x555e07(0x1d8)&&_0x3e7a4c['toUpperCase']()===_0x555e07(0x1d8)){console[_0x555e07(0x20c)](_0x555e07(0x1f6)+_0x68942+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console['log'](_0x555e07(0x19f)+_0x26fd8e+_0x555e07(0x15c)+_0x3e7a4c['toUpperCase']()+'\x22,\x20paymentLinkId=\x22'+_0x3578f4['paymentLinkId']+'\x22');if(_0x3578f4['paymentLinkId'])try{const _0x19ec51=await _0xea7dd5[_0x555e07(0x1dd)][_0x555e07(0x1fd)]({'where':{'id':_0x3578f4[_0x555e07(0x1d9)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x19ec51){console[_0x555e07(0x20c)](_0x555e07(0x204)+_0x19ec51['id']+':\x20type='+_0x19ec51[_0x555e07(0x1db)]+',\x20currentPayments='+_0x19ec51[_0x555e07(0x168)]+_0x555e07(0x1f5)+_0x19ec51[_0x555e07(0x15f)]);const _0x1d5d8f=_0x19ec51['currentPayments']+0x1,_0x12d7ac=_0x19ec51[_0x555e07(0x1db)]===_0x555e07(0x1cb)?'COMPLETED':_0x19ec51[_0x555e07(0x15f)];await _0xea7dd5[_0x555e07(0x1dd)][_0x555e07(0x192)]({'where':{'id':_0x3578f4[_0x555e07(0x1d9)]},'data':{'currentPayments':_0x1d5d8f,'status':_0x12d7ac,'updatedAt':new Date()}}),console[_0x555e07(0x20c)](_0x555e07(0x1ed)+_0x19ec51['id']+_0x555e07(0x185)+_0x19ec51['currentPayments']+_0x555e07(0x1bb)+_0x1d5d8f+_0x555e07(0x1f5)+_0x19ec51[_0x555e07(0x15f)]+_0x555e07(0x1bb)+_0x12d7ac);}else console[_0x555e07(0x20c)](_0x555e07(0x18c)+_0x3578f4['paymentLinkId']+_0x555e07(0x1ee));}catch(_0x191de5){console[_0x555e07(0x1a4)](_0x555e07(0x1df),_0x191de5);}else console[_0x555e07(0x20c)](_0x555e07(0x1f6)+_0x68942+_0x555e07(0x144));}else console[_0x555e07(0x20c)]('üìà\x20Payment\x20'+_0x68942+_0x555e07(0x16b)+_0x26fd8e+_0x555e07(0x1bb)+_0x3e7a4c['toUpperCase']());});}async[a58_0x72cb28(0x182)](_0xe4ca1f){const _0x12e319=a58_0x72cb28;console['log']('üîÑ\x20Processing\x20Plisio\x20webhook:',_0xe4ca1f);try{const _0x4942fb=await this['plisioService']['processWebhook'](_0xe4ca1f);if(!_0x4942fb[_0x12e319(0x16e)])throw new Error(_0x12e319(0x169));const _0x4ddb33=await database_1[_0x12e319(0x1af)][_0x12e319(0x1f9)][_0x12e319(0x19e)]({'where':{'gatewayOrderId':_0x4942fb['paymentId']}});if(!_0x4ddb33){console[_0x12e319(0x1a4)]('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x4942fb[_0x12e319(0x16e)]);return;}console['log'](_0x12e319(0x1bc)+_0x4ddb33['id']+_0x12e319(0x1c6)+_0x4942fb[_0x12e319(0x15f)]),await this[_0x12e319(0x1a6)](_0x4ddb33['id'],_0x4942fb[_0x12e319(0x15f)],{'txUrls':_0x4942fb[_0x12e319(0x1f2)]}),loggerService_1[_0x12e319(0x1c9)][_0x12e319(0x16d)](_0x12e319(0x1a2),_0x4ddb33['id'],_0x4ddb33[_0x12e319(0x15f)],_0x4942fb[_0x12e319(0x15f)],_0xe4ca1f);}catch(_0x14b666){console[_0x12e319(0x1a4)](_0x12e319(0x15a),_0x14b666),loggerService_1['loggerService'][_0x12e319(0x1d6)](_0x12e319(0x1a2),_0x14b666,_0xe4ca1f);throw _0x14b666;}}async['processPlisioGatewayWebhook'](_0x44d356){const _0x3d43ae=a58_0x72cb28;console['log'](_0x3d43ae(0x149),_0x44d356);try{const _0x2180c8=await this['plisioService']['processWebhook'](_0x44d356);if(!_0x2180c8[_0x3d43ae(0x16e)])throw new Error(_0x3d43ae(0x1aa));const _0x329d06=await database_1['default'][_0x3d43ae(0x1f9)][_0x3d43ae(0x19e)]({'where':{'gatewayOrderId':_0x2180c8[_0x3d43ae(0x16e)]}});if(!_0x329d06){console[_0x3d43ae(0x1a4)](_0x3d43ae(0x159)+_0x2180c8[_0x3d43ae(0x16e)]);return;}console[_0x3d43ae(0x20c)](_0x3d43ae(0x146)+_0x329d06['id']+_0x3d43ae(0x1c6)+_0x2180c8[_0x3d43ae(0x15f)]),await this[_0x3d43ae(0x1a6)](_0x329d06['id'],_0x2180c8[_0x3d43ae(0x15f)],{'txUrls':_0x2180c8[_0x3d43ae(0x1f2)]}),loggerService_1[_0x3d43ae(0x1c9)][_0x3d43ae(0x16d)](_0x3d43ae(0x174),_0x329d06['id'],_0x329d06[_0x3d43ae(0x15f)],_0x2180c8[_0x3d43ae(0x15f)],_0x44d356);}catch(_0x49f448){console['error']('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x49f448),loggerService_1[_0x3d43ae(0x1c9)][_0x3d43ae(0x1d6)](_0x3d43ae(0x174),_0x49f448,_0x44d356);throw _0x49f448;}}async[a58_0x72cb28(0x16c)](_0x331184){const _0x1b988d=a58_0x72cb28;console['log']('üîÑ\x20Processing\x20Rapyd\x20webhook:',_0x331184);try{const _0x2b9c15=await this[_0x1b988d(0x211)][_0x1b988d(0x1f0)](_0x331184);if(!_0x2b9c15[_0x1b988d(0x16e)])throw new Error(_0x1b988d(0x1c0));const _0x8df288=await database_1[_0x1b988d(0x1af)][_0x1b988d(0x1f9)][_0x1b988d(0x19e)]({'where':{'gatewayOrderId':_0x2b9c15['paymentId']}});if(!_0x8df288){console[_0x1b988d(0x1a4)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x2b9c15[_0x1b988d(0x16e)]);return;}console['log']('üìä\x20Rapyd\x20webhook:\x20Payment\x20'+_0x8df288['id']+_0x1b988d(0x1c6)+_0x2b9c15['status']),await this['updatePaymentStatus'](_0x8df288['id'],_0x2b9c15[_0x1b988d(0x15f)],{'failureMessage':_0x2b9c15[_0x1b988d(0x210)],'cardLast4':_0x2b9c15[_0x1b988d(0x212)]?.['cardLast4'],'paymentMethod':_0x2b9c15[_0x1b988d(0x212)]?.[_0x1b988d(0x156)]}),loggerService_1[_0x1b988d(0x1c9)][_0x1b988d(0x16d)](_0x1b988d(0x153),_0x8df288['id'],_0x8df288[_0x1b988d(0x15f)],_0x2b9c15[_0x1b988d(0x15f)],_0x331184);}catch(_0x3e5b5c){console[_0x1b988d(0x1a4)](_0x1b988d(0x142),_0x3e5b5c),loggerService_1[_0x1b988d(0x1c9)]['logWebhookError'](_0x1b988d(0x153),_0x3e5b5c,_0x331184);throw _0x3e5b5c;}}async[a58_0x72cb28(0x1b1)](_0x9c0cca){const _0x4cce1e=a58_0x72cb28;console[_0x4cce1e(0x20c)](_0x4cce1e(0x198),_0x9c0cca);try{const _0x3de0e8=await this['nodaService'][_0x4cce1e(0x1f0)](_0x9c0cca);if(!_0x3de0e8['paymentId'])throw new Error(_0x4cce1e(0x14c));const _0x484bbd=await database_1['default'][_0x4cce1e(0x1f9)][_0x4cce1e(0x19e)]({'where':{'gatewayOrderId':_0x3de0e8[_0x4cce1e(0x16e)]}});if(!_0x484bbd){console[_0x4cce1e(0x1a4)](_0x4cce1e(0x1f4)+_0x3de0e8[_0x4cce1e(0x16e)]);return;}console['log'](_0x4cce1e(0x1ea)+_0x484bbd['id']+'\x20status\x20'+_0x3de0e8[_0x4cce1e(0x15f)]),await this[_0x4cce1e(0x1a6)](_0x484bbd['id'],_0x3de0e8['status'],{'bankId':_0x3de0e8[_0x4cce1e(0x212)]?.[_0x4cce1e(0x17a)],'remitterIban':_0x3de0e8['additionalInfo']?.[_0x4cce1e(0x20b)],'remitterName':_0x3de0e8[_0x4cce1e(0x212)]?.['remitterName']}),loggerService_1[_0x4cce1e(0x1c9)][_0x4cce1e(0x16d)](_0x4cce1e(0x18e),_0x484bbd['id'],_0x484bbd['status'],_0x3de0e8[_0x4cce1e(0x15f)],_0x9c0cca);}catch(_0x4d022a){console[_0x4cce1e(0x1a4)]('Error\x20processing\x20Noda\x20webhook:',_0x4d022a),loggerService_1['loggerService']['logWebhookError']('noda',_0x4d022a,_0x9c0cca);throw _0x4d022a;}}async[a58_0x72cb28(0x1fa)](_0x2f9c2d){const _0x5a6db8=a58_0x72cb28;console['log'](_0x5a6db8(0x163),_0x2f9c2d);try{const _0x5e035c=await this[_0x5a6db8(0x1c4)][_0x5a6db8(0x1f0)](_0x2f9c2d);if(!_0x5e035c[_0x5a6db8(0x16e)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x25c148=await database_1[_0x5a6db8(0x1af)][_0x5a6db8(0x1f9)][_0x5a6db8(0x19e)]({'where':{'gatewayOrderId':_0x5e035c[_0x5a6db8(0x16e)]}});if(!_0x25c148){console[_0x5a6db8(0x1a4)](_0x5a6db8(0x199)+_0x5e035c[_0x5a6db8(0x16e)]);return;}console[_0x5a6db8(0x20c)](_0x5a6db8(0x161)+_0x25c148['id']+_0x5a6db8(0x1c6)+_0x5e035c[_0x5a6db8(0x15f)]),await this[_0x5a6db8(0x1a6)](_0x25c148['id'],_0x5e035c[_0x5a6db8(0x15f)]),loggerService_1['loggerService'][_0x5a6db8(0x16d)]('cointopay',_0x25c148['id'],_0x25c148[_0x5a6db8(0x15f)],_0x5e035c['status'],_0x2f9c2d);}catch(_0x42509c){console['error'](_0x5a6db8(0x14d),_0x42509c),loggerService_1[_0x5a6db8(0x1c9)][_0x5a6db8(0x1d6)]('cointopay',_0x42509c,_0x2f9c2d);throw _0x42509c;}}async[a58_0x72cb28(0x173)](_0x48977e){const _0x38fece=a58_0x72cb28;console['log'](_0x38fece(0x1d7),_0x48977e);try{const _0x371e75=await this[_0x38fece(0x1cd)][_0x38fece(0x1f0)](_0x48977e);if(!_0x371e75[_0x38fece(0x16e)])throw new Error(_0x38fece(0x189));const _0x180dbf=await database_1[_0x38fece(0x1af)]['payment'][_0x38fece(0x19e)]({'where':{'gatewayOrderId':_0x371e75['paymentId']}});if(!_0x180dbf){console[_0x38fece(0x1a4)](_0x38fece(0x16f)+_0x371e75['paymentId']);return;}console[_0x38fece(0x20c)]('üìä\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x180dbf['id']+_0x38fece(0x1c6)+_0x371e75['status']),await this['updatePaymentStatus'](_0x180dbf['id'],_0x371e75[_0x38fece(0x15f)]),loggerService_1[_0x38fece(0x1c9)][_0x38fece(0x16d)]('cointopay2',_0x180dbf['id'],_0x180dbf[_0x38fece(0x15f)],_0x371e75[_0x38fece(0x15f)],_0x48977e);}catch(_0x220204){console[_0x38fece(0x1a4)](_0x38fece(0x19b),_0x220204),loggerService_1[_0x38fece(0x1c9)][_0x38fece(0x1d6)]('cointopay2',_0x220204,_0x48977e);throw _0x220204;}}async[a58_0x72cb28(0x20e)](_0x549e1f){const _0x5ee3bf=a58_0x72cb28;console[_0x5ee3bf(0x20c)]('üîÑ\x20Processing\x20KLYME\x20webhook:',_0x549e1f);try{const _0x5ac20d=await this[_0x5ee3bf(0x209)][_0x5ee3bf(0x1f0)](_0x549e1f);if(!_0x5ac20d['paymentId'])throw new Error(_0x5ee3bf(0x1c2));const _0x35d257=await database_1[_0x5ee3bf(0x1af)][_0x5ee3bf(0x1f9)][_0x5ee3bf(0x19e)]({'where':{'gatewayOrderId':_0x5ac20d[_0x5ee3bf(0x16e)]}});if(!_0x35d257){console[_0x5ee3bf(0x1a4)](_0x5ee3bf(0x18f)+_0x5ac20d[_0x5ee3bf(0x16e)]);return;}console[_0x5ee3bf(0x20c)](_0x5ee3bf(0x171)+_0x35d257['id']+'\x20status\x20'+_0x5ac20d[_0x5ee3bf(0x15f)]),await this[_0x5ee3bf(0x1a6)](_0x35d257['id'],_0x5ac20d[_0x5ee3bf(0x15f)],{'paymentMethod':_0x5ac20d[_0x5ee3bf(0x212)]?.[_0x5ee3bf(0x1b7)]}),loggerService_1[_0x5ee3bf(0x1c9)]['logWebhookProcessed'](_0x5ee3bf(0x208),_0x35d257['id'],_0x35d257[_0x5ee3bf(0x15f)],_0x5ac20d[_0x5ee3bf(0x15f)],_0x549e1f);}catch(_0x5ad3b2){console[_0x5ee3bf(0x1a4)](_0x5ee3bf(0x1e9),_0x5ad3b2),loggerService_1[_0x5ee3bf(0x1c9)][_0x5ee3bf(0x1d6)](_0x5ee3bf(0x208),_0x5ad3b2,_0x549e1f);throw _0x5ad3b2;}}async[a58_0x72cb28(0x1b4)](_0x3f2dc9){const _0x3255b4=a58_0x72cb28;console[_0x3255b4(0x20c)](_0x3255b4(0x152),JSON[_0x3255b4(0x140)](_0x3f2dc9,null,0x2));try{const _0x29c6b7=await this[_0x3255b4(0x206)]['processWebhook'](_0x3f2dc9);console[_0x3255b4(0x20c)](_0x3255b4(0x1fb),_0x29c6b7);if(!_0x29c6b7[_0x3255b4(0x16e)]){console[_0x3255b4(0x1a4)](_0x3255b4(0x200)),console['error'](_0x3255b4(0x162),Object[_0x3255b4(0x14e)](_0x3f2dc9));throw new Error(_0x3255b4(0x172));}let _0x381a24=null;console[_0x3255b4(0x20c)]('üîç\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x29c6b7[_0x3255b4(0x16e)]);_0x29c6b7[_0x3255b4(0x16e)]&&(console[_0x3255b4(0x20c)](_0x3255b4(0x1a1)),_0x381a24=await database_1[_0x3255b4(0x1af)][_0x3255b4(0x1f9)][_0x3255b4(0x19e)]({'where':{'AND':[{'gateway':'mastercard'},{'OR':[{'gatewayPaymentId':_0x29c6b7[_0x3255b4(0x16e)]},{'gatewayOrderId':_0x29c6b7[_0x3255b4(0x16e)]},{'id':_0x29c6b7[_0x3255b4(0x16e)]},{'orderId':_0x29c6b7['paymentId']}]}]}}),console['log'](_0x3255b4(0x1e8)+(_0x381a24?_0x3255b4(0x145)+_0x381a24['id']:_0x3255b4(0x180))));if(!_0x381a24){console['error']('‚ùå\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x29c6b7['paymentId']),console[_0x3255b4(0x1a4)]('üîç\x20Searched\x20by:\x20gatewayOrderId=\x22'+_0x29c6b7[_0x3255b4(0x16e)]+'\x22,\x20id=\x22'+_0x29c6b7['paymentId']+_0x3255b4(0x1e7)+_0x29c6b7['paymentId']+'\x22');const _0x4885b2=await database_1[_0x3255b4(0x1af)][_0x3255b4(0x1f9)][_0x3255b4(0x195)]({'where':{'gateway':_0x3255b4(0x203)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x3255b4(0x20c)](_0x3255b4(0x1d0),_0x4885b2);return;}console['log'](_0x3255b4(0x178)+_0x381a24['id']+_0x3255b4(0x1b9)+_0x381a24[_0x3255b4(0x15f)]+_0x3255b4(0x1c7)+_0x29c6b7[_0x3255b4(0x15f)]),await this[_0x3255b4(0x1a6)](_0x381a24['id'],_0x29c6b7[_0x3255b4(0x15f)]),loggerService_1[_0x3255b4(0x1c9)][_0x3255b4(0x16d)](_0x3255b4(0x203),_0x381a24['id'],_0x381a24['status'],_0x29c6b7[_0x3255b4(0x15f)],_0x3f2dc9);}catch(_0xbcb6e1){console[_0x3255b4(0x1a4)](_0x3255b4(0x170),_0xbcb6e1),loggerService_1[_0x3255b4(0x1c9)]['logWebhookError'](_0x3255b4(0x203),_0xbcb6e1,_0x3f2dc9);throw _0xbcb6e1;}}async[a58_0x72cb28(0x1f1)](_0x1d5b19,_0x3235fe){const _0x41dfc0=a58_0x72cb28,_0x37afaa=Date['now']();try{const _0x27cc75=_0x1d5b19[_0x41dfc0(0x16a)],_0x1f6a01=_0x27cc75['settings'];if(!_0x1f6a01?.['webhookUrl']){console[_0x41dfc0(0x20c)](_0x41dfc0(0x1a0)+_0x27cc75['id']);return;}const _0x24bc03=_0x3235fe===_0x41dfc0(0x1d8)?_0x41dfc0(0x1b3):_0x3235fe===_0x41dfc0(0x175)?_0x41dfc0(0x1dc):_0x3235fe===_0x41dfc0(0x14a)?_0x41dfc0(0x1dc):_0x3235fe===_0x41dfc0(0x1e1)?_0x41dfc0(0x1dc):_0x3235fe===_0x41dfc0(0x19c)?_0x41dfc0(0x1dc):'payment.pending';let _0x5b3351=[];if(_0x1f6a01['webhookEvents'])try{_0x5b3351=Array[_0x41dfc0(0x165)](_0x1f6a01[_0x41dfc0(0x19a)])?_0x1f6a01[_0x41dfc0(0x19a)]:JSON[_0x41dfc0(0x1d4)](_0x1f6a01['webhookEvents']);}catch(_0x53fd13){console[_0x41dfc0(0x1a4)]('Error\x20parsing\x20webhook\x20events:',_0x53fd13),_0x5b3351=[];}if(!_0x5b3351[_0x41dfc0(0x177)](_0x24bc03)){console[_0x41dfc0(0x20c)]('Webhook\x20event\x20'+_0x24bc03+_0x41dfc0(0x1cf)+_0x27cc75['id']);return;}const _0x4df814={'event':_0x24bc03,'payment':{'id':_0x1d5b19['id'],'order_id':_0x1d5b19[_0x41dfc0(0x190)],'gateway_order_id':_0x1d5b19[_0x41dfc0(0x188)],'gateway':_0x1d5b19[_0x41dfc0(0x191)],'amount':_0x1d5b19[_0x41dfc0(0x197)],'currency':_0x1d5b19['currency'],'status':_0x3235fe[_0x41dfc0(0x202)](),'customer_email':_0x1d5b19['customerEmail'],'customer_name':_0x1d5b19[_0x41dfc0(0x1eb)],'failure_message':_0x1d5b19[_0x41dfc0(0x210)],'tx_urls':_0x1d5b19[_0x41dfc0(0x1f2)]?JSON[_0x41dfc0(0x1d4)](_0x1d5b19[_0x41dfc0(0x1f2)]):null,'created_at':_0x1d5b19['createdAt'],'updated_at':_0x1d5b19['updatedAt']}},_0xa775af=await fetch(_0x1f6a01[_0x41dfc0(0x1ca)],{'method':_0x41dfc0(0x187),'headers':{'Content-Type':_0x41dfc0(0x141),'User-Agent':_0x41dfc0(0x18a)},'body':JSON[_0x41dfc0(0x140)](_0x4df814)}),_0x1e07a6=Date[_0x41dfc0(0x1ae)]()-_0x37afaa,_0x2a93e8=_0xa775af['ok']?'Success':await _0xa775af[_0x41dfc0(0x205)]();loggerService_1[_0x41dfc0(0x1c9)]['logShopWebhookSent'](_0x1d5b19['shopId'],_0x1f6a01[_0x41dfc0(0x1ca)],_0x24bc03,_0xa775af[_0x41dfc0(0x15f)],_0x1e07a6,_0x4df814),console['log'](_0x41dfc0(0x1c5)+_0x1f6a01['webhookUrl']+_0x41dfc0(0x207)+_0xa775af[_0x41dfc0(0x15f)]+'\x20('+_0x1e07a6+_0x41dfc0(0x1e2));}catch(_0x42acce){console['error'](_0x41dfc0(0x181),_0x42acce),loggerService_1[_0x41dfc0(0x1c9)][_0x41dfc0(0x15e)](_0x1d5b19[_0x41dfc0(0x19d)],_0x1d5b19[_0x41dfc0(0x16a)]?.[_0x41dfc0(0x1e0)]?.['webhookUrl']||_0x41dfc0(0x1fc),_0x41dfc0(0x157),_0x42acce,{});}}async[a58_0x72cb28(0x1fe)](_0x2d552c,_0x3de4ac){const _0x3ec02c=a58_0x72cb28;try{const _0x16563d={'PENDING':_0x3ec02c(0x17b),'PROCESSING':_0x3ec02c(0x1d3),'PAID':_0x3ec02c(0x1e4),'FAILED':_0x3ec02c(0x1b5),'EXPIRED':_0x3ec02c(0x150),'REFUND':_0x3ec02c(0x201),'CHARGEBACK':_0x3ec02c(0x1d5)},_0x35cbae=_0x16563d[_0x3de4ac];if(!_0x35cbae||_0x35cbae===_0x3ec02c(0x17b))return;await telegramBotService_1[_0x3ec02c(0x1b0)]['sendPaymentNotification'](_0x2d552c[_0x3ec02c(0x19d)],_0x2d552c,_0x35cbae);}catch(_0x2cd3aa){console[_0x3ec02c(0x1a4)](_0x3ec02c(0x15b),_0x2cd3aa);}}}exports[a58_0x72cb28(0x20f)]=WebhookService;