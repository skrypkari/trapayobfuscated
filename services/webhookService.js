'use strict';const a58_0x55bf2a=a58_0x24ea;(function(_0x1de5c3,_0x22e625){const _0x372916=a58_0x24ea,_0x3fb948=_0x1de5c3();while(!![]){try{const _0x2c56ea=-parseInt(_0x372916(0x1fb))/0x1+-parseInt(_0x372916(0x1ba))/0x2*(parseInt(_0x372916(0x1f6))/0x3)+-parseInt(_0x372916(0x228))/0x4*(-parseInt(_0x372916(0x1cd))/0x5)+parseInt(_0x372916(0x225))/0x6+parseInt(_0x372916(0x22d))/0x7+parseInt(_0x372916(0x1b6))/0x8+parseInt(_0x372916(0x231))/0x9*(-parseInt(_0x372916(0x1ea))/0xa);if(_0x2c56ea===_0x22e625)break;else _0x3fb948['push'](_0x3fb948['shift']());}catch(_0x5e61c6){_0x3fb948['push'](_0x3fb948['shift']());}}}(a58_0x520e,0x5d3c3));function a58_0x24ea(_0x5d11fa,_0x223998){const _0x520e3d=a58_0x520e();return a58_0x24ea=function(_0x24eaba,_0x5e034e){_0x24eaba=_0x24eaba-0x196;let _0x41436c=_0x520e3d[_0x24eaba];return _0x41436c;},a58_0x24ea(_0x5d11fa,_0x223998);}var __importDefault=this&&this[a58_0x55bf2a(0x261)]||function(_0x50c928){return _0x50c928&&_0x50c928['__esModule']?_0x50c928:{'default':_0x50c928};};Object[a58_0x55bf2a(0x1b2)](exports,a58_0x55bf2a(0x1e7),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a58_0x55bf2a(0x25a))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a58_0x55bf2a(0x20c)),coinToPayService_1=require(a58_0x55bf2a(0x1e9)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require(a58_0x55bf2a(0x1c9)),mastercardService_1=require(a58_0x55bf2a(0x26f)),telegramBotService_1=require('./telegramBotService'),currencyService_1=require('./currencyService'),loggerService_1=require(a58_0x55bf2a(0x202));function a58_0x520e(){const _0x5c4b24=[',\x20gateway\x20','Error\x20processing\x20Plisio\x20webhook:','🔄\x20Processing\x20CoinToPay\x20webhook:','toFixed','currency','💰\x20Removing\x20from\x20balance:\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','\x20-\x20','klyme','🔄\x20Processing\x20CoinToPay2\x20webhook:','cardLast4','🔄\x20Processing\x20MasterCard\x20webhook:','shop','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','gatewayOrderId','entries','🏪\x20Shop\x20','settings','../config/database','\x20in\x20shop\x20','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','sendPaymentStatusNotification','balance','📈\x20Payment\x20','\x22,\x20orderId=\x22','__importDefault','updatePaymentStatus','amount','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','EXPIRED','TesSoft\x20Payment\x20System/1.0','findFirst','processWebhook','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','%\x20gateway\x20commission)','mastercard','findUnique','\x22,\x20newStatus=\x22','includes','./gateways/mastercardService','📝\x20Reason:\x20','processPlisioWebhook','💰\x20Amount\x20after\x20gateway\x20commission:\x20','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','coinToPayService','klymeService','PlisioService','currentPayments','getGatewayCommission','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','cointopay','update','logWebhookError','\x20balance\x20updated:\x20','failureMessage','Webhook\x20event\x20','📊\x20Plisio\x20webhook:\x20Payment\x20','loggerService','processCoinToPayWebhook','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','\x20status\x20','❌\x20Payment\x20link\x20','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','amountUSDT','\x20current\x20balance:\x20','logShopWebhookError','MasterCardService','\x20and\x20-','stringify','keys','log','🔄\x20Processing\x20Noda\x20webhook:','\x20to\x20','additionalInfo',',\x20using\x20default\x20commission\x2010%','\x20+\x20','default','shopId','txUrls','defineProperty','\x20not\x20found','CHARGEBACK','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','5633032uEhReu','Error\x20processing\x20CoinToPay\x20webhook:','\x20->\x20','text','70meYmny','gateway','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','webhookEvents',',\x20status=','logWebhookProcessed','updatedAt','paymentMethod','✅\x20Payment\x20link\x20','webhook_send','paymentLink','processing','toISOString','telegramBotService','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','./gateways/klymeService',',\x20newStatus=','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','PAID','942290GFPUoy','Error\x20parsing\x20webhook\x20events:','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','FAILED','processRapydWebhook','processNodaWebhook','webhookLog','status','$transaction','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','findMany','toUpperCase','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','coinToPay2Service','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','📤\x20Shop\x20webhook\x20sent\x20to\x20','NodaService','logShopWebhookSent','username','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','remitterIban','createdAt','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','paidAt','plisio','__esModule','CoinToPay2Service','./gateways/coinToPayService','4540yBroMg','Payment\x20not\x20found','💰\x20Adding\x20to\x20balance:\x20','nodaService','cointopay2','Success','Gateway\x20','paid','💰\x20Gateway\x20','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','chargeback','43761SBZyqk','masterCardService','📊\x20KLYME\x20webhook:\x20Payment\x20','KlymeService','No\x20payment\x20ID\x20in\x20Noda\x20webhook','613193xZeUZU','paymentLinkId','Found\x20payment\x20','remitterName','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','type','📊\x20Noda\x20webhook:\x20Payment\x20','./loggerService','processKlymeWebhook','error','orderId','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','REFUND','📊\x20MasterCard\x20webhook\x20result:','ms)','payment.failed','processMasterCardWebhook','./gateways/nodaService','now','\x20updated:\x20currentPayments=','chargebackAmount','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','application/json','Failed\x20to\x20send\x20shop\x20webhook:','webhook_status_change_','toLowerCase','unknown','\x20=\x20','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','Error\x20processing\x20Rapyd\x20webhook:','Error\x20processing\x20KLYME\x20webhook:','🔍\x20Search\x20result:\x20',':\x20type=','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Error\x20processing\x20Noda\x20webhook:','noda','refund','paymentId','💰\x20Converting\x20','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','bankId','🔄\x20Processing\x20KLYME\x20webhook:','3064926iVYOKx','rapyd','parse','4BNApgD','webhookUrl','📈\x20Payment\x20details:\x20oldStatus=\x22','payment','system','5082119ExMLEu','customerName','💰\x20Final\x20balance\x20after\x20chargeback:\x20','isArray','12366CmjrHp','rapydService','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','currencyService','\x20not\x20enabled\x20for\x20shop\x20','amountAfterGatewayCommissionUSDT','customerEmail','\x20USDT','CoinToPayService','payment.pending','Error\x20processing\x20CoinToPay2\x20webhook:','💸\x20Additional\x20chargeback\x20penalty:\x20-','processCoinToPay2Webhook','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','sendShopWebhook','plisioService','❌\x20Error\x20processing\x20MasterCard\x20webhook:','RapydService','created','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','\x20commission:\x20','convertToUSDT','create'];a58_0x520e=function(){return _0x5c4b24;};return a58_0x520e();}class WebhookService{constructor(){const _0x8a7c2=a58_0x55bf2a;this[_0x8a7c2(0x240)]=new plisioService_1[(_0x8a7c2(0x276))](),this['rapydService']=new rapydService_1[(_0x8a7c2(0x242))](),this[_0x8a7c2(0x1ed)]=new nodaService_1[(_0x8a7c2(0x1dd))](),this['coinToPayService']=new coinToPayService_1[(_0x8a7c2(0x239))](),this[_0x8a7c2(0x1da)]=new coinToPay2Service_1[(_0x8a7c2(0x1e8))](),this[_0x8a7c2(0x275)]=new klymeService_1[(_0x8a7c2(0x1f9))](),this[_0x8a7c2(0x1f7)]=new mastercardService_1[(_0x8a7c2(0x1a5))]();}async[a58_0x55bf2a(0x262)](_0x1b5836,_0x3f8526,_0x4e702c){const _0x3d7570=a58_0x55bf2a;console['log']('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x1b5836+_0x3d7570(0x1ca)+_0x3f8526),console[_0x3d7570(0x1a9)]('🔄\x20Additional\x20data:',_0x4e702c),await database_1[_0x3d7570(0x1af)][_0x3d7570(0x1d5)](async _0x136535=>{const _0x542991=_0x3d7570,_0x481a8d=await _0x136535[_0x542991(0x22b)][_0x542991(0x26c)]({'where':{'id':_0x1b5836},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x481a8d)throw new Error('Payment\x20'+_0x1b5836+_0x542991(0x1b3));const _0x17f294=_0x481a8d[_0x542991(0x1d4)],_0x40218f=_0x481a8d[_0x542991(0x254)];console[_0x542991(0x1a9)]('💰\x20Payment\x20'+_0x1b5836+':\x20'+_0x17f294+_0x542991(0x1b8)+_0x3f8526),console[_0x542991(0x1a9)](_0x542991(0x258)+_0x40218f['username']+_0x542991(0x1a3)+_0x40218f[_0x542991(0x25e)]+_0x542991(0x238));const _0x251814={'status':_0x3f8526[_0x542991(0x1d8)](),'updatedAt':new Date(),'statusChangedBy':_0x542991(0x22c),'statusChangedAt':new Date()};_0x4e702c?.[_0x542991(0x198)]&&(_0x251814[_0x542991(0x198)]=_0x4e702c[_0x542991(0x198)]);_0x4e702c?.[_0x542991(0x1b1)]&&(_0x251814[_0x542991(0x1b1)]=JSON[_0x542991(0x1a7)](_0x4e702c[_0x542991(0x1b1)]));_0x4e702c?.[_0x542991(0x252)]&&(_0x251814[_0x542991(0x252)]=_0x4e702c[_0x542991(0x252)]);_0x4e702c?.['paymentMethod']&&(_0x251814[_0x542991(0x1c1)]=_0x4e702c['paymentMethod']);_0x4e702c?.[_0x542991(0x223)]&&(_0x251814['bankId']=_0x4e702c['bankId']);_0x4e702c?.['remitterIban']&&(_0x251814[_0x542991(0x1e2)]=_0x4e702c['remitterIban']);_0x4e702c?.[_0x542991(0x1fe)]&&(_0x251814[_0x542991(0x1fe)]=_0x4e702c[_0x542991(0x1fe)]);let _0xba6951=_0x40218f['balance'],_0x22a36d='';if(_0x3f8526[_0x542991(0x1d8)]()===_0x542991(0x1cc)&&_0x17f294!=='PAID'){const _0xe12337=await currencyService_1[_0x542991(0x234)][_0x542991(0x246)](_0x481a8d['amount'],_0x481a8d[_0x542991(0x24c)]),_0x1c1219=await this['getGatewayCommission'](_0x40218f['id'],_0x481a8d[_0x542991(0x1bb)]),_0x4a8cac=_0xe12337*(0x1-_0x1c1219/0x64);_0xba6951+=_0x4a8cac,_0x22a36d='+'+_0x4a8cac[_0x542991(0x24b)](0x6)+_0x542991(0x1a0)+_0x1c1219+_0x542991(0x26a),_0x251814[_0x542991(0x1a2)]=_0xe12337,_0x251814[_0x542991(0x236)]=_0x4a8cac,_0x251814['paidAt']=new Date(),console[_0x542991(0x1a9)](_0x542991(0x221)+_0x481a8d['amount']+'\x20'+_0x481a8d[_0x542991(0x24c)]+'\x20->\x20'+_0xe12337[_0x542991(0x24b)](0x6)+_0x542991(0x238)),console[_0x542991(0x1a9)](_0x542991(0x1f2)+_0x481a8d[_0x542991(0x1bb)]+_0x542991(0x245)+_0x1c1219+'%'),console[_0x542991(0x1a9)](_0x542991(0x272)+_0x4a8cac[_0x542991(0x24b)](0x6)+'\x20USDT'),console[_0x542991(0x1a9)](_0x542991(0x1ec)+_0x40218f[_0x542991(0x25e)]+_0x542991(0x1ae)+_0x4a8cac['toFixed'](0x6)+_0x542991(0x216)+_0xba6951[_0x542991(0x24b)](0x6)+_0x542991(0x238));}else{if(_0x17f294==='PAID'&&_0x3f8526[_0x542991(0x1d8)]()!=='PAID'){let _0xdede44;if(_0x481a8d[_0x542991(0x236)])_0xdede44=_0x481a8d[_0x542991(0x236)];else{if(_0x481a8d[_0x542991(0x1a2)]){const _0x5473b4=await this[_0x542991(0x278)](_0x40218f['id'],_0x481a8d[_0x542991(0x1bb)]);_0xdede44=_0x481a8d[_0x542991(0x1a2)]*(0x1-_0x5473b4/0x64);}else console[_0x542991(0x1a9)]('No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance'),_0xdede44=0x0;}_0xdede44>0x0&&(_0xba6951-=_0xdede44,_0x22a36d='-'+_0xdede44[_0x542991(0x24b)](0x6)+_0x542991(0x1c8),_0x251814['amountUSDT']=null,_0x251814['amountAfterGatewayCommissionUSDT']=null,_0x251814[_0x542991(0x1e5)]=null,console[_0x542991(0x1a9)](_0x542991(0x24d)+_0x40218f[_0x542991(0x25e)]+_0x542991(0x24f)+_0xdede44[_0x542991(0x24b)](0x6)+_0x542991(0x216)+_0xba6951[_0x542991(0x24b)](0x6)+_0x542991(0x238)));}}if(_0x3f8526[_0x542991(0x1d8)]()===_0x542991(0x1b4)){const _0x4d009e=_0x4e702c?.[_0x542991(0x20f)]||0x0;_0x4d009e>0x0&&(_0xba6951-=_0x4d009e,_0x22a36d+=_0x542991(0x1a6)+_0x4d009e[_0x542991(0x24b)](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0x251814[_0x542991(0x20f)]=_0x4d009e,console[_0x542991(0x1a9)](_0x542991(0x23c)+_0x4d009e[_0x542991(0x24b)](0x6)+_0x542991(0x238)),console[_0x542991(0x1a9)](_0x542991(0x22f)+_0xba6951[_0x542991(0x24b)](0x6)+_0x542991(0x238)));}const _0x57de53=await _0x136535['payment'][_0x542991(0x27b)]({'where':{'id':_0x1b5836},'data':_0x251814});_0xba6951!==_0x40218f[_0x542991(0x25e)]&&(await _0x136535[_0x542991(0x254)][_0x542991(0x27b)]({'where':{'id':_0x40218f['id']},'data':{'balance':_0xba6951}}),console[_0x542991(0x1a9)]('✅\x20Shop\x20'+_0x40218f[_0x542991(0x1df)]+_0x542991(0x197)+_0x40218f[_0x542991(0x25e)][_0x542991(0x24b)](0x6)+_0x542991(0x1b8)+_0xba6951[_0x542991(0x24b)](0x6)+_0x542991(0x238)),console[_0x542991(0x1a9)](_0x542991(0x270)+_0x22a36d));await _0x136535[_0x542991(0x1d3)][_0x542991(0x247)]({'data':{'paymentId':_0x1b5836,'shopId':_0x40218f['id'],'event':_0x542991(0x213)+_0x3f8526[_0x542991(0x214)](),'statusCode':0xc8,'responseBody':JSON[_0x542991(0x1a7)]({'oldStatus':_0x17f294,'newStatus':_0x3f8526['toUpperCase'](),'balanceChange':_0x22a36d||'no\x20balance\x20change','oldBalance':_0x40218f[_0x542991(0x25e)],'newBalance':_0xba6951,'amountUSDT':_0x251814[_0x542991(0x1a2)],'additionalData':_0x4e702c,'timestamp':new Date()[_0x542991(0x1c6)]()})}}),await this[_0x542991(0x23f)]({..._0x481a8d,..._0x57de53,'shop':_0x40218f},_0x3f8526[_0x542991(0x1d8)]()),await this[_0x542991(0x25d)]({..._0x481a8d,..._0x57de53},_0x3f8526[_0x542991(0x1d8)]());if(_0x17f294!=='PAID'&&_0x3f8526[_0x542991(0x1d8)]()==='PAID'){console[_0x542991(0x1a9)]('📈\x20Payment\x20'+_0x1b5836+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console[_0x542991(0x1a9)](_0x542991(0x22a)+_0x17f294+_0x542991(0x26d)+_0x3f8526['toUpperCase']()+'\x22,\x20paymentLinkId=\x22'+_0x481a8d['paymentLinkId']+'\x22');if(_0x481a8d['paymentLinkId'])try{const _0x451b46=await _0x136535['paymentLink']['findUnique']({'where':{'id':_0x481a8d[_0x542991(0x1fc)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x451b46){console['log']('📈\x20Found\x20payment\x20link\x20'+_0x451b46['id']+_0x542991(0x21b)+_0x451b46[_0x542991(0x200)]+',\x20currentPayments='+_0x451b46[_0x542991(0x277)]+_0x542991(0x1be)+_0x451b46['status']);const _0xca2332=_0x451b46[_0x542991(0x277)]+0x1,_0xef9047=_0x451b46['type']==='SINGLE'?'COMPLETED':_0x451b46[_0x542991(0x1d4)];await _0x136535[_0x542991(0x1c4)][_0x542991(0x27b)]({'where':{'id':_0x481a8d[_0x542991(0x1fc)]},'data':{'currentPayments':_0xca2332,'status':_0xef9047,'updatedAt':new Date()}}),console['log'](_0x542991(0x1c2)+_0x451b46['id']+_0x542991(0x20e)+_0x451b46[_0x542991(0x277)]+_0x542991(0x1b8)+_0xca2332+_0x542991(0x1be)+_0x451b46[_0x542991(0x1d4)]+_0x542991(0x1b8)+_0xef9047);}else console[_0x542991(0x1a9)](_0x542991(0x19f)+_0x481a8d[_0x542991(0x1fc)]+_0x542991(0x1b3));}catch(_0x361070){console[_0x542991(0x204)](_0x542991(0x1e1),_0x361070);}else console[_0x542991(0x1a9)](_0x542991(0x25f)+_0x1b5836+_0x542991(0x1f4));}else console[_0x542991(0x1a9)](_0x542991(0x25f)+_0x1b5836+_0x542991(0x1d6)+_0x17f294+_0x542991(0x1b8)+_0x3f8526[_0x542991(0x1d8)]());});}async[a58_0x55bf2a(0x271)](_0x46dc79){const _0x1bb43e=a58_0x55bf2a;console[_0x1bb43e(0x1a9)]('🔄\x20Processing\x20Plisio\x20webhook:',_0x46dc79);try{const _0x2b7b87=await this[_0x1bb43e(0x240)][_0x1bb43e(0x268)](_0x46dc79);if(!_0x2b7b87[_0x1bb43e(0x220)])throw new Error(_0x1bb43e(0x1b5));const _0x1fe6f9=await database_1[_0x1bb43e(0x1af)]['payment'][_0x1bb43e(0x267)]({'where':{'gatewayOrderId':_0x2b7b87['paymentId']}});if(!_0x1fe6f9){console[_0x1bb43e(0x204)](_0x1bb43e(0x1cf)+_0x2b7b87[_0x1bb43e(0x220)]);return;}console[_0x1bb43e(0x1a9)](_0x1bb43e(0x19a)+_0x1fe6f9['id']+_0x1bb43e(0x19e)+_0x2b7b87[_0x1bb43e(0x1d4)]),await this[_0x1bb43e(0x262)](_0x1fe6f9['id'],_0x2b7b87['status'],{'txUrls':_0x2b7b87[_0x1bb43e(0x1b1)]}),loggerService_1[_0x1bb43e(0x19b)][_0x1bb43e(0x1bf)](_0x1bb43e(0x1e6),_0x1fe6f9['id'],_0x1fe6f9[_0x1bb43e(0x1d4)],_0x2b7b87[_0x1bb43e(0x1d4)],_0x46dc79);}catch(_0xf5dccc){console[_0x1bb43e(0x204)](_0x1bb43e(0x249),_0xf5dccc),loggerService_1[_0x1bb43e(0x19b)][_0x1bb43e(0x196)]('plisio',_0xf5dccc,_0x46dc79);throw _0xf5dccc;}}async['processPlisioGatewayWebhook'](_0x48f90d){const _0x482698=a58_0x55bf2a;console[_0x482698(0x1a9)](_0x482698(0x206),_0x48f90d);try{const _0x5802f4=await this[_0x482698(0x240)][_0x482698(0x268)](_0x48f90d);if(!_0x5802f4[_0x482698(0x220)])throw new Error(_0x482698(0x1bc));const _0x251cbe=await database_1[_0x482698(0x1af)][_0x482698(0x22b)]['findFirst']({'where':{'gatewayOrderId':_0x5802f4['paymentId']}});if(!_0x251cbe){console[_0x482698(0x204)](_0x482698(0x233)+_0x5802f4[_0x482698(0x220)]);return;}console[_0x482698(0x1a9)](_0x482698(0x1db)+_0x251cbe['id']+_0x482698(0x19e)+_0x5802f4[_0x482698(0x1d4)]),await this[_0x482698(0x262)](_0x251cbe['id'],_0x5802f4['status'],{'txUrls':_0x5802f4['txUrls']}),loggerService_1[_0x482698(0x19b)][_0x482698(0x1bf)]('plisio_gateway',_0x251cbe['id'],_0x251cbe['status'],_0x5802f4[_0x482698(0x1d4)],_0x48f90d);}catch(_0x31e0d0){console[_0x482698(0x204)](_0x482698(0x1a1),_0x31e0d0),loggerService_1[_0x482698(0x19b)]['logWebhookError']('plisio_gateway',_0x31e0d0,_0x48f90d);throw _0x31e0d0;}}async[a58_0x55bf2a(0x1d1)](_0x26f406){const _0x319d52=a58_0x55bf2a;console[_0x319d52(0x1a9)]('🔄\x20Processing\x20Rapyd\x20webhook:',_0x26f406);try{const _0x1e7bef=await this[_0x319d52(0x232)][_0x319d52(0x268)](_0x26f406);if(!_0x1e7bef[_0x319d52(0x220)])throw new Error(_0x319d52(0x19d));const _0x28df7f=await database_1['default']['payment'][_0x319d52(0x267)]({'where':{'gatewayOrderId':_0x1e7bef[_0x319d52(0x220)]}});if(!_0x28df7f){console[_0x319d52(0x204)](_0x319d52(0x1e0)+_0x1e7bef[_0x319d52(0x220)]);return;}console[_0x319d52(0x1a9)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x28df7f['id']+'\x20status\x20'+_0x1e7bef[_0x319d52(0x1d4)]),await this[_0x319d52(0x262)](_0x28df7f['id'],_0x1e7bef[_0x319d52(0x1d4)],{'failureMessage':_0x1e7bef['failureMessage'],'cardLast4':_0x1e7bef[_0x319d52(0x1ac)]?.[_0x319d52(0x252)],'paymentMethod':_0x1e7bef[_0x319d52(0x1ac)]?.[_0x319d52(0x1c1)]}),loggerService_1[_0x319d52(0x19b)][_0x319d52(0x1bf)](_0x319d52(0x226),_0x28df7f['id'],_0x28df7f['status'],_0x1e7bef[_0x319d52(0x1d4)],_0x26f406);}catch(_0x5d9ffc){console[_0x319d52(0x204)](_0x319d52(0x218),_0x5d9ffc),loggerService_1['loggerService'][_0x319d52(0x196)](_0x319d52(0x226),_0x5d9ffc,_0x26f406);throw _0x5d9ffc;}}async[a58_0x55bf2a(0x1d2)](_0x2d6d89){const _0x35b120=a58_0x55bf2a;console['log'](_0x35b120(0x1aa),_0x2d6d89);try{const _0x3e7b70=await this[_0x35b120(0x1ed)][_0x35b120(0x268)](_0x2d6d89);if(!_0x3e7b70[_0x35b120(0x220)])throw new Error(_0x35b120(0x1fa));const _0x3cfb11=await database_1[_0x35b120(0x1af)][_0x35b120(0x22b)]['findFirst']({'where':{'gatewayOrderId':_0x3e7b70[_0x35b120(0x220)]}});if(!_0x3cfb11){console[_0x35b120(0x204)](_0x35b120(0x1e4)+_0x3e7b70[_0x35b120(0x220)]);return;}console[_0x35b120(0x1a9)](_0x35b120(0x201)+_0x3cfb11['id']+_0x35b120(0x19e)+_0x3e7b70['status']),await this[_0x35b120(0x262)](_0x3cfb11['id'],_0x3e7b70[_0x35b120(0x1d4)],{'bankId':_0x3e7b70[_0x35b120(0x1ac)]?.[_0x35b120(0x223)],'remitterIban':_0x3e7b70[_0x35b120(0x1ac)]?.['remitterIban'],'remitterName':_0x3e7b70['additionalInfo']?.[_0x35b120(0x1fe)]}),loggerService_1['loggerService']['logWebhookProcessed'](_0x35b120(0x21e),_0x3cfb11['id'],_0x3cfb11['status'],_0x3e7b70[_0x35b120(0x1d4)],_0x2d6d89);}catch(_0x4a764d){console[_0x35b120(0x204)](_0x35b120(0x21d),_0x4a764d),loggerService_1[_0x35b120(0x19b)]['logWebhookError'](_0x35b120(0x21e),_0x4a764d,_0x2d6d89);throw _0x4a764d;}}async[a58_0x55bf2a(0x19c)](_0x138a6f){const _0x1a6b00=a58_0x55bf2a;console[_0x1a6b00(0x1a9)](_0x1a6b00(0x24a),_0x138a6f);try{const _0x26cda8=await this[_0x1a6b00(0x274)][_0x1a6b00(0x268)](_0x138a6f);if(!_0x26cda8['paymentId'])throw new Error(_0x1a6b00(0x264));const _0x5c4e47=await database_1['default'][_0x1a6b00(0x22b)][_0x1a6b00(0x267)]({'where':{'gatewayOrderId':_0x26cda8[_0x1a6b00(0x220)]}});if(!_0x5c4e47){console[_0x1a6b00(0x204)](_0x1a6b00(0x255)+_0x26cda8[_0x1a6b00(0x220)]);return;}console[_0x1a6b00(0x1a9)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x5c4e47['id']+_0x1a6b00(0x19e)+_0x26cda8[_0x1a6b00(0x1d4)]),await this[_0x1a6b00(0x262)](_0x5c4e47['id'],_0x26cda8[_0x1a6b00(0x1d4)]),loggerService_1[_0x1a6b00(0x19b)][_0x1a6b00(0x1bf)](_0x1a6b00(0x27a),_0x5c4e47['id'],_0x5c4e47[_0x1a6b00(0x1d4)],_0x26cda8[_0x1a6b00(0x1d4)],_0x138a6f);}catch(_0x5a6942){console['error'](_0x1a6b00(0x1b7),_0x5a6942),loggerService_1[_0x1a6b00(0x19b)]['logWebhookError']('cointopay',_0x5a6942,_0x138a6f);throw _0x5a6942;}}async[a58_0x55bf2a(0x23d)](_0x18d9a0){const _0x553447=a58_0x55bf2a;console[_0x553447(0x1a9)](_0x553447(0x251),_0x18d9a0);try{const _0x5dbe05=await this[_0x553447(0x1da)][_0x553447(0x268)](_0x18d9a0);if(!_0x5dbe05[_0x553447(0x220)])throw new Error(_0x553447(0x269));const _0x207d7d=await database_1[_0x553447(0x1af)]['payment'][_0x553447(0x267)]({'where':{'gatewayOrderId':_0x5dbe05[_0x553447(0x220)]}});if(!_0x207d7d){console['error'](_0x553447(0x273)+_0x5dbe05[_0x553447(0x220)]);return;}console[_0x553447(0x1a9)](_0x553447(0x217)+_0x207d7d['id']+_0x553447(0x19e)+_0x5dbe05[_0x553447(0x1d4)]),await this[_0x553447(0x262)](_0x207d7d['id'],_0x5dbe05[_0x553447(0x1d4)]),loggerService_1[_0x553447(0x19b)][_0x553447(0x1bf)]('cointopay2',_0x207d7d['id'],_0x207d7d[_0x553447(0x1d4)],_0x5dbe05[_0x553447(0x1d4)],_0x18d9a0);}catch(_0x166ad9){console[_0x553447(0x204)](_0x553447(0x23b),_0x166ad9),loggerService_1[_0x553447(0x19b)]['logWebhookError'](_0x553447(0x1ee),_0x166ad9,_0x18d9a0);throw _0x166ad9;}}async[a58_0x55bf2a(0x203)](_0x1c0268){const _0x5140a6=a58_0x55bf2a;console[_0x5140a6(0x1a9)](_0x5140a6(0x224),_0x1c0268);try{const _0x55c372=await this[_0x5140a6(0x275)][_0x5140a6(0x268)](_0x1c0268);if(!_0x55c372[_0x5140a6(0x220)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x564ea3=await database_1[_0x5140a6(0x1af)]['payment'][_0x5140a6(0x267)]({'where':{'gatewayOrderId':_0x55c372[_0x5140a6(0x220)]}});if(!_0x564ea3){console['error'](_0x5140a6(0x1f3)+_0x55c372[_0x5140a6(0x220)]);return;}console[_0x5140a6(0x1a9)](_0x5140a6(0x1f8)+_0x564ea3['id']+_0x5140a6(0x19e)+_0x55c372[_0x5140a6(0x1d4)]),await this['updatePaymentStatus'](_0x564ea3['id'],_0x55c372[_0x5140a6(0x1d4)],{'paymentMethod':_0x55c372['additionalInfo']?.['payment_method']}),loggerService_1[_0x5140a6(0x19b)]['logWebhookProcessed'](_0x5140a6(0x250),_0x564ea3['id'],_0x564ea3[_0x5140a6(0x1d4)],_0x55c372['status'],_0x1c0268);}catch(_0xf6c105){console['error'](_0x5140a6(0x219),_0xf6c105),loggerService_1[_0x5140a6(0x19b)][_0x5140a6(0x196)](_0x5140a6(0x250),_0xf6c105,_0x1c0268);throw _0xf6c105;}}async[a58_0x55bf2a(0x20b)](_0x12bbae){const _0x548696=a58_0x55bf2a;console[_0x548696(0x1a9)](_0x548696(0x253),JSON[_0x548696(0x1a7)](_0x12bbae,null,0x2));try{const _0x1a50fb=await this['masterCardService']['processWebhook'](_0x12bbae);console[_0x548696(0x1a9)](_0x548696(0x208),_0x1a50fb);if(!_0x1a50fb[_0x548696(0x220)]){console['error'](_0x548696(0x222)),console[_0x548696(0x204)]('❌\x20Available\x20webhook\x20fields:',Object[_0x548696(0x1a8)](_0x12bbae));throw new Error(_0x548696(0x1cb));}let _0x47756a=null;console['log'](_0x548696(0x210)+_0x1a50fb[_0x548696(0x220)]);_0x1a50fb[_0x548696(0x220)]&&(console[_0x548696(0x1a9)]('🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x47756a=await database_1[_0x548696(0x1af)][_0x548696(0x22b)][_0x548696(0x267)]({'where':{'AND':[{'gateway':_0x548696(0x26b)},{'OR':[{'gatewayPaymentId':_0x1a50fb['paymentId']},{'gatewayOrderId':_0x1a50fb[_0x548696(0x220)]},{'id':_0x1a50fb[_0x548696(0x220)]},{'orderId':_0x1a50fb['paymentId']}]}]}}),console[_0x548696(0x1a9)](_0x548696(0x21a)+(_0x47756a?_0x548696(0x1fd)+_0x47756a['id']:_0x548696(0x1eb))));if(!_0x47756a){console[_0x548696(0x204)](_0x548696(0x1d9)+_0x1a50fb[_0x548696(0x220)]),console[_0x548696(0x204)](_0x548696(0x244)+_0x1a50fb[_0x548696(0x220)]+'\x22,\x20id=\x22'+_0x1a50fb[_0x548696(0x220)]+_0x548696(0x260)+_0x1a50fb[_0x548696(0x220)]+'\x22');const _0x345603=await database_1['default']['payment'][_0x548696(0x1d7)]({'where':{'gateway':_0x548696(0x26b)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x548696(0x1a9)](_0x548696(0x25c),_0x345603);return;}console[_0x548696(0x1a9)]('✅\x20Found\x20payment\x20'+_0x47756a['id']+_0x548696(0x279)+_0x47756a['status']+_0x548696(0x1ab)+_0x1a50fb[_0x548696(0x1d4)]),await this[_0x548696(0x262)](_0x47756a['id'],_0x1a50fb[_0x548696(0x1d4)]),loggerService_1['loggerService'][_0x548696(0x1bf)](_0x548696(0x26b),_0x47756a['id'],_0x47756a['status'],_0x1a50fb[_0x548696(0x1d4)],_0x12bbae);}catch(_0x206533){console[_0x548696(0x204)](_0x548696(0x241),_0x206533),loggerService_1[_0x548696(0x19b)][_0x548696(0x196)]('mastercard',_0x206533,_0x12bbae);throw _0x206533;}}async[a58_0x55bf2a(0x23f)](_0x353dda,_0x205322){const _0xb2fd10=a58_0x55bf2a,_0x57a6f0=Date[_0xb2fd10(0x20d)]();try{const _0x9d2a78=_0x353dda[_0xb2fd10(0x254)],_0x486f46=_0x9d2a78[_0xb2fd10(0x259)];if(!_0x486f46?.[_0xb2fd10(0x229)]){console[_0xb2fd10(0x1a9)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x9d2a78['id']);return;}const _0x4bb478=_0x205322===_0xb2fd10(0x1cc)?'payment.success':_0x205322===_0xb2fd10(0x1d0)?_0xb2fd10(0x20a):_0x205322===_0xb2fd10(0x265)?_0xb2fd10(0x20a):_0x205322===_0xb2fd10(0x1b4)?_0xb2fd10(0x20a):_0x205322===_0xb2fd10(0x207)?'payment.failed':_0xb2fd10(0x23a);let _0x587f54=[];if(_0x486f46[_0xb2fd10(0x1bd)])try{_0x587f54=Array[_0xb2fd10(0x230)](_0x486f46[_0xb2fd10(0x1bd)])?_0x486f46[_0xb2fd10(0x1bd)]:JSON[_0xb2fd10(0x227)](_0x486f46[_0xb2fd10(0x1bd)]);}catch(_0x38caa2){console[_0xb2fd10(0x204)](_0xb2fd10(0x1ce),_0x38caa2),_0x587f54=[];}if(!_0x587f54[_0xb2fd10(0x26e)](_0x4bb478)){console['log'](_0xb2fd10(0x199)+_0x4bb478+_0xb2fd10(0x235)+_0x9d2a78['id']);return;}const _0x2a3af2={'event':_0x4bb478,'payment':{'id':_0x353dda['id'],'order_id':_0x353dda[_0xb2fd10(0x205)],'gateway_order_id':_0x353dda[_0xb2fd10(0x256)],'gateway':_0x353dda['gateway'],'amount':_0x353dda[_0xb2fd10(0x263)],'currency':_0x353dda[_0xb2fd10(0x24c)],'status':_0x205322[_0xb2fd10(0x214)](),'customer_email':_0x353dda[_0xb2fd10(0x237)],'customer_name':_0x353dda[_0xb2fd10(0x22e)],'failure_message':_0x353dda[_0xb2fd10(0x198)],'tx_urls':_0x353dda[_0xb2fd10(0x1b1)]?JSON[_0xb2fd10(0x227)](_0x353dda[_0xb2fd10(0x1b1)]):null,'created_at':_0x353dda[_0xb2fd10(0x1e3)],'updated_at':_0x353dda[_0xb2fd10(0x1c0)]}},_0x40bdfb=await fetch(_0x486f46[_0xb2fd10(0x229)],{'method':'POST','headers':{'Content-Type':_0xb2fd10(0x211),'User-Agent':_0xb2fd10(0x266)},'body':JSON[_0xb2fd10(0x1a7)](_0x2a3af2)}),_0x39c075=Date[_0xb2fd10(0x20d)]()-_0x57a6f0,_0x2e4d97=_0x40bdfb['ok']?_0xb2fd10(0x1ef):await _0x40bdfb[_0xb2fd10(0x1b9)]();loggerService_1[_0xb2fd10(0x19b)][_0xb2fd10(0x1de)](_0x353dda[_0xb2fd10(0x1b0)],_0x486f46[_0xb2fd10(0x229)],_0x4bb478,_0x40bdfb['status'],_0x39c075,_0x2a3af2),console['log'](_0xb2fd10(0x1dc)+_0x486f46[_0xb2fd10(0x229)]+'\x20with\x20status\x20'+_0x40bdfb[_0xb2fd10(0x1d4)]+'\x20('+_0x39c075+_0xb2fd10(0x209));}catch(_0x41e526){console[_0xb2fd10(0x204)](_0xb2fd10(0x212),_0x41e526),loggerService_1[_0xb2fd10(0x19b)][_0xb2fd10(0x1a4)](_0x353dda[_0xb2fd10(0x1b0)],_0x353dda['shop']?.[_0xb2fd10(0x259)]?.[_0xb2fd10(0x229)]||_0xb2fd10(0x215),_0xb2fd10(0x1c3),_0x41e526,{});}}async[a58_0x55bf2a(0x25d)](_0x1387b2,_0x55261e){const _0x73c86a=a58_0x55bf2a;try{const _0x2f565a={'PENDING':_0x73c86a(0x243),'PROCESSING':_0x73c86a(0x1c5),'PAID':_0x73c86a(0x1f1),'FAILED':'failed','EXPIRED':'expired','REFUND':_0x73c86a(0x21f),'CHARGEBACK':_0x73c86a(0x1f5)},_0x4c1f04=_0x2f565a[_0x55261e];if(!_0x4c1f04||_0x4c1f04==='created')return;await telegramBotService_1[_0x73c86a(0x1c7)]['sendPaymentNotification'](_0x1387b2[_0x73c86a(0x1b0)],_0x1387b2,_0x4c1f04);}catch(_0x1b9785){console[_0x73c86a(0x204)](_0x73c86a(0x21c),_0x1b9785);}}async[a58_0x55bf2a(0x278)](_0x35e880,_0x43f6d9){const _0x1f4e01=a58_0x55bf2a;try{const _0x4c25e7=await database_1[_0x1f4e01(0x1af)]['shop'][_0x1f4e01(0x26c)]({'where':{'id':_0x35e880},'select':{'gatewaySettings':!![]}});if(!_0x4c25e7?.['gatewaySettings'])return console[_0x1f4e01(0x1a9)](_0x1f4e01(0x24e)+_0x35e880+_0x1f4e01(0x1ad)),0xa;const _0x5b0c47=JSON['parse'](_0x4c25e7['gatewaySettings']);for(const [_0x2921ef,_0xf7693a]of Object[_0x1f4e01(0x257)](_0x5b0c47)){if(_0x2921ef[_0x1f4e01(0x214)]()===_0x43f6d9[_0x1f4e01(0x214)]()){const _0x59c9bb=_0xf7693a['commission']||0xa;return console['log'](_0x1f4e01(0x1f0)+_0x43f6d9+'\x20commission\x20for\x20shop\x20'+_0x35e880+':\x20'+_0x59c9bb+'%'),_0x59c9bb;}}return console[_0x1f4e01(0x1a9)](_0x1f4e01(0x23e)+_0x43f6d9+_0x1f4e01(0x25b)+_0x35e880+',\x20using\x20default\x2010%'),0xa;}catch(_0x23bfc3){return console['error'](_0x1f4e01(0x1ff)+_0x35e880+_0x1f4e01(0x248)+_0x43f6d9+':',_0x23bfc3),0xa;}}}exports['WebhookService']=WebhookService;