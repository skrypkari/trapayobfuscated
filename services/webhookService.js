'use strict';const a69_0x38c209=a69_0x4ee6;(function(_0x56f1b0,_0x481169){const _0x27b309=a69_0x4ee6,_0x2698af=_0x56f1b0();while(!![]){try{const _0x11ec52=-parseInt(_0x27b309(0x7d))/0x1+parseInt(_0x27b309(0xf0))/0x2*(-parseInt(_0x27b309(0x167))/0x3)+parseInt(_0x27b309(0x75))/0x4*(-parseInt(_0x27b309(0x12e))/0x5)+parseInt(_0x27b309(0xd1))/0x6*(parseInt(_0x27b309(0xf6))/0x7)+parseInt(_0x27b309(0x1b2))/0x8+parseInt(_0x27b309(0x117))/0x9+parseInt(_0x27b309(0x134))/0xa*(parseInt(_0x27b309(0xdd))/0xb);if(_0x11ec52===_0x481169)break;else _0x2698af['push'](_0x2698af['shift']());}catch(_0xea0d81){_0x2698af['push'](_0x2698af['shift']());}}}(a69_0x4b9c,0x7096b));var __importDefault=this&&this[a69_0x38c209(0x179)]||function(_0x1ed147){const _0x6ddaa6=a69_0x38c209;return _0x1ed147&&_0x1ed147[_0x6ddaa6(0xbd)]?_0x1ed147:{'default':_0x1ed147};};Object['defineProperty'](exports,a69_0x38c209(0xbd),{'value':!![]}),exports[a69_0x38c209(0x1b0)]=void 0x0;const database_1=__importDefault(require(a69_0x38c209(0xe7))),plisioService_1=require(a69_0x38c209(0xef)),rapydService_1=require(a69_0x38c209(0x162)),nodaService_1=require(a69_0x38c209(0xc6)),coinToPayService_1=require(a69_0x38c209(0x150)),coinToPay2Service_1=require(a69_0x38c209(0x163)),klymeService_1=require(a69_0x38c209(0x1ad)),mastercardService_1=require(a69_0x38c209(0x159)),amerService_1=require(a69_0x38c209(0xde)),ampayService_1=require(a69_0x38c209(0x13f)),ampayTRYService_1=require(a69_0x38c209(0x112)),telegramBotService_1=require(a69_0x38c209(0xe2)),currencyService_1=require('./currencyService'),loggerService_1=require(a69_0x38c209(0x10a));function a69_0x4ee6(_0x46c59b,_0x36a150){const _0x4b9cf4=a69_0x4b9c();return a69_0x4ee6=function(_0x4ee6f2,_0xb041bd){_0x4ee6f2=_0x4ee6f2-0x6d;let _0x1f0c6c=_0x4b9cf4[_0x4ee6f2];return _0x1f0c6c;},a69_0x4ee6(_0x46c59b,_0x36a150);}function a69_0x4b9c(){const _0x384d6b=['ampayTRYService','233274PFEwCR','Body\x20data:','paid','processing','💰\x20Amount\x20after\x20gateway\x20commission:\x20','findUnique','noda','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','\x22,\x20newStatus=\x22','MASTERCARD','gatewayOrderId','🔄\x20Processing\x20KLYME\x20webhook:','857186TITkdv','./gateways/amerService','type','payment.success','webhookEvents','./telegramBotService','📊\x20AmPay\x20webhook\x20data:','application/json','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','\x20status\x20updated\x20to\x20FAILED','../config/database','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','SINGLE',',\x20GatewayOrderId=','bankId','payment_method','currency','./gateways/plisioService','266578BtJhGa','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','system_id','txUrls','\x20not\x20enabled\x20for\x20shop\x20','7vQgsfr','plisio_gateway','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook',',\x20status=','processRapydWebhook','processWebhook','VisaMasterCardService','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','\x20for\x20AmPay\x20TRY\x20webhook','NodaService','❌\x20Available\x20webhook\x20fields:','$transaction','Not\x20found','update','📊\x20VISA\x20payment\x20found:\x20','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','webhook_send','Error\x20processing\x20CoinToPay2\x20webhook:','mastercard','processMyXSpendWebhook','./loggerService','CoinToPay2Service','errorMessage','amountAfterGatewayCommissionUSDT','visa_','gateway','customerOrderId','\x20for\x20MyXSpend\x20webhook','./gateways/ampayTRYService','Error\x20processing\x20KLYME\x20webhook:','❌\x20Error\x20processing\x20MasterCard\x20webhook:','🔍\x20VISA\x20payment\x20search\x20result:\x20','💸\x20CHARGEBACK:\x20Processing\x20penalty-only\x20deduction','7459128FlEPEa',',\x20gateway\x20','✅\x20Found\x20payment\x20','create','toUpperCase','Failed\x20to\x20send\x20shop\x20webhook:',',\x20using\x20default\x2010%','🏪\x20Shop\x20','📊\x20AmPay\x20TRY\x20webhook\x20data:','rapyd','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','log','shop','🔍\x20Found\x20VISA\x20payment:\x20ID=','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','created','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook',',\x20Gateway=','convertToUSDT','📊\x20Amer\x20webhook:\x20Payment\x20','Found\x20payment\x20','5LSfrzY','telegramBotService','\x20updated:\x20currentPayments=','system','webhookLog','Payment\x20not\x20found:\x20','70LdpbmD','cointopay','shopId','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20',',\x20GatewayPaymentId=','📝\x20Reason:\x20','myxspend_','ms)','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','\x22,\x20paymentLinkId=\x22','processAmPayWebhook','./gateways/ampayService','📊\x20Rapyd\x20webhook:\x20Payment\x20','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','Payment\x20System/1.0','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','\x22,\x20orderId=\x22','FAILED','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','klymeService','findMany','amount','sendPaymentNotification','MasterCard\x20payment\x20not\x20found:\x20','\x20USDT\x20(chargeback\x20penalty\x20ONLY)','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','balance','%\x20gateway\x20commission)','./gateways/coinToPayService','VISA','ℹ️\x20AmPay\x20TRY\x20status\x20','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','currentPayments','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','\x20->\x20','payment.failed','client_transaction_id','./gateways/mastercardService','unknown','\x20-\x20','username','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','webhookUrl','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','./gateways/rapydService','./gateways/coinToPay2Service','visa/mastercard','Success','logWebhookError','15vsophQ','paymentMethod','🔄\x20Processing\x20VISA\x20webhook:','status','\x20mapped\x20to\x20FAILED','🔄\x20Processing\x20MyXSpend\x20webhook:','processMasterCardWebhook','📈\x20Payment\x20','🔄\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','desc','🔄\x20MyXSpend\x20status\x20','📊\x20KLYME\x20webhook:\x20Payment\x20','amerService','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','🔄\x20Processing\x20Amer\x20webhook:','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','toLowerCase','Webhook\x20event\x20','__importDefault','paymentLinkId','🔄\x20Processing\x20Noda\x20webhook:','chargeback','loggerService','rapydService','logShopWebhookSent','✅\x20Payment\x20link\x20','💰\x20Payment\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','\x20→\x20','No\x20additional\x20info','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','keys','\x20status\x20','map','amer','✅\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20',',\x20Card=****','nodaService','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','🔄\x20Processing\x20Plisio\x20webhook:','myxspend',',\x20card:\x20****','updatePaymentStatus','amountUSDT','paymentLink','ampay_try_','customerEmail','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20commission\x20for\x20shop\x20','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','payment','remitterName','sendShopWebhook','remitterIban','AmPayTRYService','No\x20payment\x20ID\x20in\x20Amer\x20webhook','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','\x20for\x20AmPay\x20webhook','ampay_try','🔍\x20VISA\x20payment\x20search\x20executed','cardLast4','visa','createdAt','status_addition_info','\x20commission:\x20','📈\x20Payment\x20details:\x20oldStatus=\x22','paidAt','CoinToPayService','📊\x20MyXSpend\x20webhook\x20data:','./gateways/klymeService','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','now','WebhookService','🔄\x20Processing\x20AmPay\x20webhook:','3640408yYybNc','PAID','📊\x20MasterCard\x20webhook\x20result:','processAmerWebhook','Error\x20processing\x20Noda\x20webhook:','settings','\x20USDT','❌\x20VISA\x20webhook\x20processing\x20failed:','getGatewayCommission','COMPLETED',',\x20newStatus=','findFirst','1306328ZMNsyF','chargebackAmount','gatewaySettings','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','\x20(orderId:\x20','processAmPayTRYWebhook','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','\x22,\x20id=\x22','414014FGCQBU','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','❌\x20Error\x20processing\x20Amer\x20webhook:','default','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','coinToPay2Service','stringify','logWebhookProcessed','toFixed','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','📈\x20Found\x20payment\x20link\x20','currencyService','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','📊\x20VISA\x20webhook\x20result:','Payment\x20','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','Error\x20processing\x20Rapyd\x20webhook:','💰\x20Converting\x20','AmPayService','ampay_','payment.pending','Error\x20processing\x20Plisio\x20webhook:','💰\x20Gateway\x20','additionalInfo','processNodaWebhook','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','paymentId','✅\x20Found\x20payment:\x20ID=','ampayService','No\x20payment\x20ID\x20in\x20VISA\x20webhook','CHARGEBACK','updatedAt','Payment\x20not\x20found','❌\x20Error\x20processing\x20AmPay\x20webhook:','no\x20balance\x20change','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20','\x20with\x20status\x20','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','\x20(Status:\x20','\x20=\x20','Gateway\x20','gatewayCommissionRate','ℹ️\x20AmPay\x20status\x20','commission','visa_mastercard','EXPIRED','\x20in\x20shop\x20','expired','failed','RapydService','gatewayPaymentId','\x20not\x20found','processCoinToPay2Webhook','cointopay2','plisioService','customerName','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','visaMasterCardService','⚠️\x20CHARGEBACK\x20without\x20penalty\x20amount\x20-\x20no\x20balance\x20change','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','processKlymeWebhook','__esModule','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','Query\x20params:','📊\x20Plisio\x20webhook:\x20Payment\x20','failureMessage','DECLINED','includes','ampay','📊\x20Payment\x20status:\x20','./gateways/nodaService','error','processPlisioGatewayWebhook','parse','✅\x20Shop\x20','klyme','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','coinToPayService','orderId','sendPaymentStatusNotification'];a69_0x4b9c=function(){return _0x384d6b;};return a69_0x4b9c();}class WebhookService{constructor(){const _0x2e0ff1=a69_0x38c209;this[_0x2e0ff1(0xb5)]=new plisioService_1['PlisioService'](),this[_0x2e0ff1(0x17e)]=new rapydService_1[(_0x2e0ff1(0xb0))](),this[_0x2e0ff1(0x18d)]=new nodaService_1[(_0x2e0ff1(0xff))](),this[_0x2e0ff1(0xcd)]=new coinToPayService_1[(_0x2e0ff1(0x1ab))](),this[_0x2e0ff1(0x82)]=new coinToPay2Service_1[(_0x2e0ff1(0x10b))](),this[_0x2e0ff1(0x147)]=new klymeService_1['KlymeService'](),this[_0x2e0ff1(0xb9)]=new mastercardService_1[(_0x2e0ff1(0xfc))](),this[_0x2e0ff1(0x173)]=new amerService_1['AmerService'](),this[_0x2e0ff1(0x99)]=new ampayService_1[(_0x2e0ff1(0x8f))](),this[_0x2e0ff1(0xd0)]=new ampayTRYService_1[(_0x2e0ff1(0x19e))]();}async['updatePaymentStatus'](_0x2060b1,_0x1ccd36,_0x15ad57){const _0x150783=a69_0x38c209;console[_0x150783(0x122)](_0x150783(0x143)+_0x2060b1+_0x150783(0x73)+_0x1ccd36),console[_0x150783(0x122)]('🔄\x20Additional\x20data:',_0x15ad57),await database_1[_0x150783(0x80)][_0x150783(0x101)](async _0x227005=>{const _0x5b5a8f=_0x150783,_0x4c599f=await _0x227005[_0x5b5a8f(0x19a)]['findUnique']({'where':{'id':_0x2060b1},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4c599f)throw new Error(_0x5b5a8f(0x8b)+_0x2060b1+'\x20not\x20found');const _0x51c289=_0x4c599f[_0x5b5a8f(0x16a)],_0x3f530a=_0x4c599f[_0x5b5a8f(0x123)];console['log'](_0x5b5a8f(0x181)+_0x2060b1+':\x20'+_0x51c289+_0x5b5a8f(0x156)+_0x1ccd36),console['log'](_0x5b5a8f(0x11e)+_0x3f530a[_0x5b5a8f(0x15c)]+'\x20current\x20balance:\x20'+_0x3f530a['balance']+_0x5b5a8f(0x6f));const _0x4314d0={'status':_0x1ccd36[_0x5b5a8f(0x11b)](),'updatedAt':new Date(),'statusChangedBy':_0x5b5a8f(0x131),'statusChangedAt':new Date()};_0x15ad57?.[_0x5b5a8f(0xc1)]&&(_0x4314d0[_0x5b5a8f(0xc1)]=_0x15ad57['failureMessage']);_0x15ad57?.['txUrls']&&(_0x4314d0[_0x5b5a8f(0xf4)]=JSON['stringify'](_0x15ad57['txUrls']));_0x15ad57?.[_0x5b5a8f(0x1a4)]&&(_0x4314d0[_0x5b5a8f(0x1a4)]=_0x15ad57[_0x5b5a8f(0x1a4)]);_0x15ad57?.['paymentMethod']&&(_0x4314d0[_0x5b5a8f(0x168)]=_0x15ad57[_0x5b5a8f(0x168)]);_0x15ad57?.[_0x5b5a8f(0xec)]&&(_0x4314d0[_0x5b5a8f(0xec)]=_0x15ad57[_0x5b5a8f(0xec)]);_0x15ad57?.[_0x5b5a8f(0x19d)]&&(_0x4314d0['remitterIban']=_0x15ad57['remitterIban']);_0x15ad57?.[_0x5b5a8f(0x19b)]&&(_0x4314d0[_0x5b5a8f(0x19b)]=_0x15ad57[_0x5b5a8f(0x19b)]);let _0x2d98d8=_0x3f530a[_0x5b5a8f(0x14e)],_0x369667='';if(_0x1ccd36['toUpperCase']()===_0x5b5a8f(0x1b3)&&_0x51c289!=='PAID'){const _0x187e07=await currencyService_1[_0x5b5a8f(0x88)][_0x5b5a8f(0x12b)](_0x4c599f[_0x5b5a8f(0x149)],_0x4c599f[_0x5b5a8f(0xee)]),_0x592b63=await this[_0x5b5a8f(0x71)](_0x3f530a['id'],_0x4c599f[_0x5b5a8f(0x10f)]),_0x352853=_0x187e07*(0x1-_0x592b63/0x64);_0x2d98d8+=_0x352853,_0x369667='+'+_0x352853[_0x5b5a8f(0x85)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20'+_0x592b63+_0x5b5a8f(0x14f),_0x4314d0[_0x5b5a8f(0x193)]=_0x187e07,_0x4314d0[_0x5b5a8f(0x10d)]=_0x352853,_0x4314d0[_0x5b5a8f(0xa8)]=_0x592b63,_0x4314d0[_0x5b5a8f(0x1aa)]=new Date(),console[_0x5b5a8f(0x122)](_0x5b5a8f(0x8e)+_0x4c599f['amount']+'\x20'+_0x4c599f['currency']+_0x5b5a8f(0x156)+_0x187e07[_0x5b5a8f(0x85)](0x6)+'\x20USDT'),console['log'](_0x5b5a8f(0x93)+_0x4c599f[_0x5b5a8f(0x10f)]+_0x5b5a8f(0x1a8)+_0x592b63+'%'),console['log'](_0x5b5a8f(0xd5)+_0x352853[_0x5b5a8f(0x85)](0x6)+_0x5b5a8f(0x6f)),console[_0x5b5a8f(0x122)]('💰\x20Adding\x20to\x20balance:\x20'+_0x3f530a[_0x5b5a8f(0x14e)]+'\x20+\x20'+_0x352853[_0x5b5a8f(0x85)](0x6)+_0x5b5a8f(0xa6)+_0x2d98d8[_0x5b5a8f(0x85)](0x6)+_0x5b5a8f(0x6f));}else{if(_0x51c289===_0x5b5a8f(0x1b3)&&_0x1ccd36[_0x5b5a8f(0x11b)]()!==_0x5b5a8f(0x1b3)&&_0x1ccd36[_0x5b5a8f(0x11b)]()!==_0x5b5a8f(0x9b)){let _0x4d9ae8;if(_0x4c599f[_0x5b5a8f(0x10d)])_0x4d9ae8=_0x4c599f[_0x5b5a8f(0x10d)];else{if(_0x4c599f[_0x5b5a8f(0x193)]){const _0x5baf54=await this[_0x5b5a8f(0x71)](_0x3f530a['id'],_0x4c599f['gateway']);_0x4d9ae8=_0x4c599f[_0x5b5a8f(0x193)]*(0x1-_0x5baf54/0x64);}else console[_0x5b5a8f(0x122)](_0x5b5a8f(0xcc)),_0x4d9ae8=0x0;}_0x4d9ae8>0x0&&(_0x2d98d8-=_0x4d9ae8,_0x369667='-'+_0x4d9ae8['toFixed'](0x6)+_0x5b5a8f(0x186),_0x4314d0[_0x5b5a8f(0x1aa)]=null,console[_0x5b5a8f(0x122)]('💰\x20Removing\x20from\x20balance:\x20'+_0x3f530a[_0x5b5a8f(0x14e)]+_0x5b5a8f(0x15b)+_0x4d9ae8['toFixed'](0x6)+_0x5b5a8f(0xa6)+_0x2d98d8['toFixed'](0x6)+_0x5b5a8f(0x6f)));}}if(_0x1ccd36[_0x5b5a8f(0x11b)]()===_0x5b5a8f(0x9b)){const _0x4208fd=_0x15ad57?.['chargebackAmount']||0x0;console[_0x5b5a8f(0x122)](_0x5b5a8f(0x116)),_0x4208fd>0x0?(_0x2d98d8-=_0x4208fd,_0x369667='-'+_0x4208fd[_0x5b5a8f(0x85)](0x6)+_0x5b5a8f(0x14c),_0x4314d0[_0x5b5a8f(0x76)]=_0x4208fd,console['log']('💸\x20CHARGEBACK\x20penalty\x20ONLY:\x20-'+_0x4208fd[_0x5b5a8f(0x85)](0x6)+_0x5b5a8f(0x6f)),console['log']('💰\x20Payment\x20amount\x20is\x20NOT\x20deducted\x20(chargeback\x20penalty\x20only)'),console[_0x5b5a8f(0x122)]('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x2d98d8[_0x5b5a8f(0x85)](0x6)+_0x5b5a8f(0x6f))):(console['log'](_0x5b5a8f(0xba)),_0x369667='Payment\x20marked\x20as\x20CHARGEBACK\x20(no\x20penalty\x20specified)');}const _0xf9ace2=await _0x227005['payment'][_0x5b5a8f(0x103)]({'where':{'id':_0x2060b1},'data':_0x4314d0});_0x2d98d8!==_0x3f530a[_0x5b5a8f(0x14e)]&&(await _0x227005[_0x5b5a8f(0x123)][_0x5b5a8f(0x103)]({'where':{'id':_0x3f530a['id']},'data':{'balance':_0x2d98d8}}),console[_0x5b5a8f(0x122)](_0x5b5a8f(0xca)+_0x3f530a[_0x5b5a8f(0x15c)]+'\x20balance\x20updated:\x20'+_0x3f530a[_0x5b5a8f(0x14e)][_0x5b5a8f(0x85)](0x6)+_0x5b5a8f(0x156)+_0x2d98d8[_0x5b5a8f(0x85)](0x6)+'\x20USDT'),console[_0x5b5a8f(0x122)](_0x5b5a8f(0x139)+_0x369667));await _0x227005['webhookLog'][_0x5b5a8f(0x11a)]({'data':{'paymentId':_0x2060b1,'shopId':_0x3f530a['id'],'event':'webhook_status_change_'+_0x1ccd36['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x5b5a8f(0x83)]({'oldStatus':_0x51c289,'newStatus':_0x1ccd36[_0x5b5a8f(0x11b)](),'balanceChange':_0x369667||_0x5b5a8f(0x9f),'oldBalance':_0x3f530a[_0x5b5a8f(0x14e)],'newBalance':_0x2d98d8,'amountUSDT':_0x4314d0['amountUSDT'],'additionalData':_0x15ad57,'timestamp':new Date()['toISOString']()})}}),await this[_0x5b5a8f(0x19c)]({..._0x4c599f,..._0xf9ace2,'shop':_0x3f530a},_0x1ccd36[_0x5b5a8f(0x11b)]()),await this[_0x5b5a8f(0xcf)]({..._0x4c599f,..._0xf9ace2},_0x1ccd36[_0x5b5a8f(0x11b)]());if(_0x51c289!==_0x5b5a8f(0x1b3)&&_0x1ccd36['toUpperCase']()===_0x5b5a8f(0x1b3)){console[_0x5b5a8f(0x122)](_0x5b5a8f(0x16e)+_0x2060b1+_0x5b5a8f(0x105)),console[_0x5b5a8f(0x122)](_0x5b5a8f(0x1a9)+_0x51c289+_0x5b5a8f(0xd9)+_0x1ccd36[_0x5b5a8f(0x11b)]()+_0x5b5a8f(0x13d)+_0x4c599f[_0x5b5a8f(0x17a)]+'\x22');if(_0x4c599f[_0x5b5a8f(0x17a)])try{const _0x140b34=await _0x227005[_0x5b5a8f(0x194)][_0x5b5a8f(0xd6)]({'where':{'id':_0x4c599f[_0x5b5a8f(0x17a)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x140b34){console[_0x5b5a8f(0x122)](_0x5b5a8f(0x87)+_0x140b34['id']+':\x20type='+_0x140b34[_0x5b5a8f(0xdf)]+',\x20currentPayments='+_0x140b34[_0x5b5a8f(0x154)]+',\x20status='+_0x140b34[_0x5b5a8f(0x16a)]);const _0x1cfb70=_0x140b34[_0x5b5a8f(0x154)]+0x1,_0x4122b9=_0x140b34[_0x5b5a8f(0xdf)]===_0x5b5a8f(0xea)?_0x5b5a8f(0x72):_0x140b34[_0x5b5a8f(0x16a)];await _0x227005['paymentLink'][_0x5b5a8f(0x103)]({'where':{'id':_0x4c599f[_0x5b5a8f(0x17a)]},'data':{'currentPayments':_0x1cfb70,'status':_0x4122b9,'updatedAt':new Date()}}),console[_0x5b5a8f(0x122)](_0x5b5a8f(0x180)+_0x140b34['id']+_0x5b5a8f(0x130)+_0x140b34[_0x5b5a8f(0x154)]+_0x5b5a8f(0x156)+_0x1cfb70+_0x5b5a8f(0xf9)+_0x140b34[_0x5b5a8f(0x16a)]+_0x5b5a8f(0x156)+_0x4122b9);}else console[_0x5b5a8f(0x122)]('❌\x20Payment\x20link\x20'+_0x4c599f[_0x5b5a8f(0x17a)]+_0x5b5a8f(0xb2));}catch(_0x108cf4){console[_0x5b5a8f(0xc7)]('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x108cf4);}else console[_0x5b5a8f(0x122)]('📈\x20Payment\x20'+_0x2060b1+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0x5b5a8f(0x122)](_0x5b5a8f(0x16e)+_0x2060b1+'\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20'+_0x51c289+_0x5b5a8f(0x156)+_0x1ccd36[_0x5b5a8f(0x11b)]());});}async['processPlisioWebhook'](_0x244e67){const _0x58e6d1=a69_0x38c209;console[_0x58e6d1(0x122)](_0x58e6d1(0x18f),_0x244e67);try{const _0x303465=await this[_0x58e6d1(0xb5)][_0x58e6d1(0xfb)](_0x244e67);if(!_0x303465[_0x58e6d1(0x97)])throw new Error(_0x58e6d1(0x13c));const _0x2fee7b=await database_1[_0x58e6d1(0x80)][_0x58e6d1(0x19a)]['findFirst']({'where':{'gatewayOrderId':_0x303465['paymentId']}});if(!_0x2fee7b){console[_0x58e6d1(0xc7)](_0x58e6d1(0xa0)+_0x303465[_0x58e6d1(0x97)]);return;}console['log'](_0x58e6d1(0xc0)+_0x2fee7b['id']+_0x58e6d1(0x188)+_0x303465['status']),await this[_0x58e6d1(0x192)](_0x2fee7b['id'],_0x303465[_0x58e6d1(0x16a)],{'txUrls':_0x303465[_0x58e6d1(0xf4)]}),loggerService_1[_0x58e6d1(0x17d)]['logWebhookProcessed']('plisio',_0x2fee7b['id'],_0x2fee7b['status'],_0x303465['status'],_0x244e67);}catch(_0x4e39fd){console[_0x58e6d1(0xc7)](_0x58e6d1(0x92),_0x4e39fd),loggerService_1[_0x58e6d1(0x17d)][_0x58e6d1(0x166)]('plisio',_0x4e39fd,_0x244e67);throw _0x4e39fd;}}async[a69_0x38c209(0xc8)](_0x177a9a){const _0x2dc1cf=a69_0x38c209;console['log'](_0x2dc1cf(0xfd),_0x177a9a);try{const _0x3a8368=await this[_0x2dc1cf(0xb5)][_0x2dc1cf(0xfb)](_0x177a9a);if(!_0x3a8368[_0x2dc1cf(0x97)])throw new Error(_0x2dc1cf(0x146));const _0x36f6bc=await database_1[_0x2dc1cf(0x80)][_0x2dc1cf(0x19a)]['findFirst']({'where':{'gatewayOrderId':_0x3a8368['paymentId']}});if(!_0x36f6bc){console['error'](_0x2dc1cf(0x137)+_0x3a8368[_0x2dc1cf(0x97)]);return;}console[_0x2dc1cf(0x122)]('📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20'+_0x36f6bc['id']+_0x2dc1cf(0x188)+_0x3a8368['status']),await this[_0x2dc1cf(0x192)](_0x36f6bc['id'],_0x3a8368[_0x2dc1cf(0x16a)],{'txUrls':_0x3a8368['txUrls']}),loggerService_1[_0x2dc1cf(0x17d)][_0x2dc1cf(0x84)](_0x2dc1cf(0xf7),_0x36f6bc['id'],_0x36f6bc[_0x2dc1cf(0x16a)],_0x3a8368[_0x2dc1cf(0x16a)],_0x177a9a);}catch(_0xf05d15){console[_0x2dc1cf(0xc7)](_0x2dc1cf(0x7b),_0xf05d15),loggerService_1[_0x2dc1cf(0x17d)][_0x2dc1cf(0x166)](_0x2dc1cf(0xf7),_0xf05d15,_0x177a9a);throw _0xf05d15;}}async[a69_0x38c209(0xfa)](_0x13f299){const _0x25725f=a69_0x38c209;console[_0x25725f(0x122)]('🔄\x20Processing\x20Rapyd\x20webhook:',_0x13f299);try{const _0x3897e2=await this[_0x25725f(0x17e)][_0x25725f(0xfb)](_0x13f299);if(!_0x3897e2[_0x25725f(0x97)])throw new Error(_0x25725f(0xf8));const _0x500dc7=await database_1[_0x25725f(0x80)][_0x25725f(0x19a)]['findFirst']({'where':{'gatewayOrderId':_0x3897e2['paymentId']}});if(!_0x500dc7){console[_0x25725f(0xc7)](_0x25725f(0xd8)+_0x3897e2['paymentId']);return;}console[_0x25725f(0x122)](_0x25725f(0x140)+_0x500dc7['id']+'\x20status\x20'+_0x3897e2['status']),await this['updatePaymentStatus'](_0x500dc7['id'],_0x3897e2[_0x25725f(0x16a)],{'failureMessage':_0x3897e2[_0x25725f(0xc1)],'cardLast4':_0x3897e2[_0x25725f(0x94)]?.['cardLast4'],'paymentMethod':_0x3897e2[_0x25725f(0x94)]?.[_0x25725f(0x168)]}),loggerService_1['loggerService'][_0x25725f(0x84)](_0x25725f(0x120),_0x500dc7['id'],_0x500dc7[_0x25725f(0x16a)],_0x3897e2[_0x25725f(0x16a)],_0x13f299);}catch(_0x196a15){console[_0x25725f(0xc7)](_0x25725f(0x8d),_0x196a15),loggerService_1[_0x25725f(0x17d)][_0x25725f(0x166)](_0x25725f(0x120),_0x196a15,_0x13f299);throw _0x196a15;}}async[a69_0x38c209(0x95)](_0x4ad166){const _0x47dd70=a69_0x38c209;console['log'](_0x47dd70(0x17b),_0x4ad166);try{const _0xde385=await this[_0x47dd70(0x18d)]['processWebhook'](_0x4ad166);if(!_0xde385[_0x47dd70(0x97)])throw new Error('No\x20payment\x20ID\x20in\x20Noda\x20webhook');const _0x427448=await database_1[_0x47dd70(0x80)][_0x47dd70(0x19a)][_0x47dd70(0x74)]({'where':{'gatewayOrderId':_0xde385[_0x47dd70(0x97)]}});if(!_0x427448){console[_0x47dd70(0xc7)]('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0xde385[_0x47dd70(0x97)]);return;}console['log']('📊\x20Noda\x20webhook:\x20Payment\x20'+_0x427448['id']+_0x47dd70(0x188)+_0xde385['status']),await this[_0x47dd70(0x192)](_0x427448['id'],_0xde385[_0x47dd70(0x16a)],{'bankId':_0xde385[_0x47dd70(0x94)]?.[_0x47dd70(0xec)],'remitterIban':_0xde385['additionalInfo']?.[_0x47dd70(0x19d)],'remitterName':_0xde385[_0x47dd70(0x94)]?.[_0x47dd70(0x19b)]}),loggerService_1['loggerService'][_0x47dd70(0x84)](_0x47dd70(0xd7),_0x427448['id'],_0x427448['status'],_0xde385[_0x47dd70(0x16a)],_0x4ad166);}catch(_0x49c76d){console['error'](_0x47dd70(0x6d),_0x49c76d),loggerService_1['loggerService'][_0x47dd70(0x166)](_0x47dd70(0xd7),_0x49c76d,_0x4ad166);throw _0x49c76d;}}async['processCoinToPayWebhook'](_0x31b435){const _0x386fc8=a69_0x38c209;console[_0x386fc8(0x122)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x31b435);try{const _0x19456c=await this[_0x386fc8(0xcd)][_0x386fc8(0xfb)](_0x31b435);if(!_0x19456c['paymentId'])throw new Error(_0x386fc8(0xe5));const _0x242b7b=await database_1[_0x386fc8(0x80)][_0x386fc8(0x19a)][_0x386fc8(0x74)]({'where':{'gatewayOrderId':_0x19456c[_0x386fc8(0x97)]}});if(!_0x242b7b){console[_0x386fc8(0xc7)](_0x386fc8(0x126)+_0x19456c[_0x386fc8(0x97)]);return;}console['log']('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x242b7b['id']+_0x386fc8(0x188)+_0x19456c[_0x386fc8(0x16a)]),await this[_0x386fc8(0x192)](_0x242b7b['id'],_0x19456c[_0x386fc8(0x16a)]),loggerService_1[_0x386fc8(0x17d)][_0x386fc8(0x84)](_0x386fc8(0x135),_0x242b7b['id'],_0x242b7b[_0x386fc8(0x16a)],_0x19456c[_0x386fc8(0x16a)],_0x31b435);}catch(_0x18e4a6){console[_0x386fc8(0xc7)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x18e4a6),loggerService_1[_0x386fc8(0x17d)][_0x386fc8(0x166)](_0x386fc8(0x135),_0x18e4a6,_0x31b435);throw _0x18e4a6;}}async[a69_0x38c209(0xb3)](_0x25f588){const _0xd1e6a0=a69_0x38c209;console['log']('🔄\x20Processing\x20CoinToPay2\x20webhook:',_0x25f588);try{const _0x5e773d=await this['coinToPay2Service'][_0xd1e6a0(0xfb)](_0x25f588);if(!_0x5e773d['paymentId'])throw new Error(_0xd1e6a0(0x14d));const _0x26024e=await database_1[_0xd1e6a0(0x80)][_0xd1e6a0(0x19a)][_0xd1e6a0(0x74)]({'where':{'gatewayOrderId':_0x5e773d[_0xd1e6a0(0x97)]}});if(!_0x26024e){console[_0xd1e6a0(0xc7)](_0xd1e6a0(0xa4)+_0x5e773d['paymentId']);return;}console[_0xd1e6a0(0x122)](_0xd1e6a0(0x128)+_0x26024e['id']+_0xd1e6a0(0x188)+_0x5e773d['status']),await this[_0xd1e6a0(0x192)](_0x26024e['id'],_0x5e773d[_0xd1e6a0(0x16a)]),loggerService_1[_0xd1e6a0(0x17d)]['logWebhookProcessed'](_0xd1e6a0(0xb4),_0x26024e['id'],_0x26024e[_0xd1e6a0(0x16a)],_0x5e773d[_0xd1e6a0(0x16a)],_0x25f588);}catch(_0x3723ea){console[_0xd1e6a0(0xc7)](_0xd1e6a0(0x107),_0x3723ea),loggerService_1[_0xd1e6a0(0x17d)][_0xd1e6a0(0x166)](_0xd1e6a0(0xb4),_0x3723ea,_0x25f588);throw _0x3723ea;}}async[a69_0x38c209(0xbc)](_0x1677d4){const _0x278c4c=a69_0x38c209;console[_0x278c4c(0x122)](_0x278c4c(0xdc),_0x1677d4);try{const _0x52757e=await this['klymeService'][_0x278c4c(0xfb)](_0x1677d4);if(!_0x52757e[_0x278c4c(0x97)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0xef6c8f=await database_1[_0x278c4c(0x80)][_0x278c4c(0x19a)][_0x278c4c(0x74)]({'where':{'gatewayOrderId':_0x52757e[_0x278c4c(0x97)]}});if(!_0xef6c8f){console[_0x278c4c(0xc7)](_0x278c4c(0x121)+_0x52757e[_0x278c4c(0x97)]);return;}console['log'](_0x278c4c(0x172)+_0xef6c8f['id']+_0x278c4c(0x188)+_0x52757e['status']),await this[_0x278c4c(0x192)](_0xef6c8f['id'],_0x52757e[_0x278c4c(0x16a)],{'paymentMethod':_0x52757e['additionalInfo']?.['payment_method']}),loggerService_1[_0x278c4c(0x17d)][_0x278c4c(0x84)](_0x278c4c(0xcb),_0xef6c8f['id'],_0xef6c8f[_0x278c4c(0x16a)],_0x52757e[_0x278c4c(0x16a)],_0x1677d4);}catch(_0x415d8d){console[_0x278c4c(0xc7)](_0x278c4c(0x113),_0x415d8d),loggerService_1[_0x278c4c(0x17d)]['logWebhookError'](_0x278c4c(0xcb),_0x415d8d,_0x1677d4);throw _0x415d8d;}}async['processVisaWebhook'](_0x1de35a){const _0x1b5809=a69_0x38c209;console[_0x1b5809(0x122)](_0x1b5809(0x169),JSON[_0x1b5809(0x83)](_0x1de35a,null,0x2));try{const _0x1c4b4a=await this[_0x1b5809(0xb9)][_0x1b5809(0xfb)](_0x1de35a,_0x1b5809(0x151));console['log'](_0x1b5809(0x8a),_0x1c4b4a);if(!_0x1c4b4a[_0x1b5809(0x97)]){console[_0x1b5809(0xc7)](_0x1b5809(0xf1)),console['error'](_0x1b5809(0x100),Object[_0x1b5809(0x187)](_0x1de35a));throw new Error(_0x1b5809(0x9a));}let _0x3c5269=null;console[_0x1b5809(0x122)](_0x1b5809(0x197)+_0x1c4b4a[_0x1b5809(0x97)]);if(_0x1c4b4a[_0x1b5809(0x97)]){console['log'](_0x1b5809(0xa1)),console['log'](_0x1b5809(0x155)),console[_0x1b5809(0x122)](_0x1b5809(0x86)),console[_0x1b5809(0x122)]('\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20'+_0x1c4b4a[_0x1b5809(0x97)]),console[_0x1b5809(0x122)](_0x1b5809(0x185)),_0x3c5269=await database_1[_0x1b5809(0x80)][_0x1b5809(0x19a)]['findFirst']({'where':{'AND':[{'OR':[{'gateway':_0x1b5809(0x164)},{'gateway':_0x1b5809(0x108)}]},{'OR':[{'gatewayPaymentId':_0x1c4b4a[_0x1b5809(0x97)]},{'gatewayOrderId':_0x1c4b4a['paymentId']},{'id':_0x1c4b4a[_0x1b5809(0x97)]},{'orderId':_0x1c4b4a[_0x1b5809(0x97)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x1b5809(0x122)](_0x1b5809(0x1a3));if(_0x3c5269)console[_0x1b5809(0x122)](_0x1b5809(0x98)+_0x3c5269['id']+_0x1b5809(0xeb)+_0x3c5269[_0x1b5809(0xdb)]+_0x1b5809(0x138)+_0x3c5269['gatewayPaymentId']);else{console[_0x1b5809(0x122)](_0x1b5809(0x81));const _0x24270a=await database_1[_0x1b5809(0x80)][_0x1b5809(0x19a)][_0x1b5809(0x148)]({'where':{'gateway':'visa/mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x1b5809(0x170)}});console['log']('🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:',_0x24270a[_0x1b5809(0x189)](_0x1da182=>_0x1da182['id']+_0x1b5809(0x79)+_0x1da182['orderId']+',\x20gatewayOrderId:\x20'+_0x1da182[_0x1b5809(0xdb)]+',\x20gatewayPaymentId:\x20'+_0x1da182[_0x1b5809(0xb1)]+_0x1b5809(0x191)+_0x1da182[_0x1b5809(0x1a4)]+')'));}console[_0x1b5809(0x122)](_0x1b5809(0x115)+(_0x3c5269?'Found':_0x1b5809(0x102))),_0x3c5269&&console['log'](_0x1b5809(0x124)+_0x3c5269['id']+_0x1b5809(0x12a)+_0x3c5269[_0x1b5809(0x10f)]+',\x20Status='+_0x3c5269[_0x1b5809(0x16a)]+_0x1b5809(0x18c)+_0x3c5269[_0x1b5809(0x1a4)]);}if(!_0x3c5269){console['error'](_0x1b5809(0x7e)+_0x1c4b4a[_0x1b5809(0x97)]),loggerService_1[_0x1b5809(0x17d)][_0x1b5809(0x166)]('visa',new Error(_0x1b5809(0x133)+_0x1c4b4a[_0x1b5809(0x97)]),_0x1de35a);throw new Error('VISA\x20payment\x20not\x20found:\x20'+_0x1c4b4a['paymentId']);}console['log'](_0x1b5809(0x104)+_0x3c5269['id']+_0x1b5809(0xa5)+_0x3c5269[_0x1b5809(0x16a)]+_0x1b5809(0x183)+_0x1c4b4a[_0x1b5809(0x16a)]+')');const _0x2e2ac0={};_0x1c4b4a[_0x1b5809(0x149)]&&await database_1['default'][_0x1b5809(0x19a)][_0x1b5809(0x103)]({'where':{'id':_0x3c5269['id']},'data':{'amount':_0x1c4b4a['amount'],'updatedAt':new Date()}}),_0x1c4b4a[_0x1b5809(0xee)]&&await database_1['default'][_0x1b5809(0x19a)][_0x1b5809(0x103)]({'where':{'id':_0x3c5269['id']},'data':{'currency':_0x1c4b4a[_0x1b5809(0xee)],'updatedAt':new Date()}}),_0x1c4b4a['status']===_0x1b5809(0x145)&&_0x1c4b4a[_0x1b5809(0x10c)]&&(_0x2e2ac0[_0x1b5809(0xc1)]=_0x1c4b4a[_0x1b5809(0x10c)],console[_0x1b5809(0x122)](_0x1b5809(0xbb)+_0x1c4b4a[_0x1b5809(0x10c)])),_0x2e2ac0[_0x1b5809(0x168)]=_0x1b5809(0x1a5),await this['updatePaymentStatus'](_0x3c5269['id'],_0x1c4b4a[_0x1b5809(0x16a)],_0x2e2ac0),await database_1[_0x1b5809(0x80)]['webhookLog'][_0x1b5809(0x11a)]({'data':{'paymentId':_0x3c5269['id'],'shopId':_0x3c5269['shopId'],'event':_0x1b5809(0x10e)+_0x1c4b4a[_0x1b5809(0x16a)][_0x1b5809(0x177)](),'statusCode':0xc8,'responseBody':JSON[_0x1b5809(0x83)](_0x1c4b4a)}}),await this[_0x1b5809(0xcf)](_0x3c5269,_0x1c4b4a[_0x1b5809(0x16a)][_0x1b5809(0x11b)]()),console[_0x1b5809(0x122)](_0x1b5809(0xf2)+_0x3c5269['id']);}catch(_0x4f98db){console['error'](_0x1b5809(0x70),_0x4f98db),loggerService_1[_0x1b5809(0x17d)][_0x1b5809(0x166)](_0x1b5809(0x1a5),_0x4f98db,_0x1de35a);throw _0x4f98db;}}async[a69_0x38c209(0x16d)](_0x45ad9e){const _0x3c41d2=a69_0x38c209;console['log']('🔄\x20Processing\x20MasterCard\x20webhook:',JSON['stringify'](_0x45ad9e,null,0x2));try{const _0x39aebe=await this['visaMasterCardService'][_0x3c41d2(0xfb)](_0x45ad9e,_0x3c41d2(0xda));console[_0x3c41d2(0x122)](_0x3c41d2(0x1b4),_0x39aebe);if(!_0x39aebe[_0x3c41d2(0x97)]){console[_0x3c41d2(0xc7)](_0x3c41d2(0x125)),console[_0x3c41d2(0xc7)](_0x3c41d2(0x100),Object[_0x3c41d2(0x187)](_0x45ad9e));throw new Error(_0x3c41d2(0xb8));}let _0x15b856=null;console[_0x3c41d2(0x122)](_0x3c41d2(0xb7)+_0x39aebe[_0x3c41d2(0x97)]);_0x39aebe['paymentId']&&(console[_0x3c41d2(0x122)](_0x3c41d2(0x199)),_0x15b856=await database_1[_0x3c41d2(0x80)]['payment']['findFirst']({'where':{'AND':[{'OR':[{'gateway':_0x3c41d2(0xab)},{'gateway':_0x3c41d2(0x108)},{'gateway':'visa/mastercard'}]},{'OR':[{'gatewayPaymentId':_0x39aebe[_0x3c41d2(0x97)]},{'gatewayOrderId':_0x39aebe['paymentId']},{'id':_0x39aebe[_0x3c41d2(0x97)]},{'orderId':_0x39aebe[_0x3c41d2(0x97)]}]}]}}),console[_0x3c41d2(0x122)]('🔍\x20Search\x20result:\x20'+(_0x15b856?_0x3c41d2(0x12d)+_0x15b856['id']:_0x3c41d2(0x9d))));if(!_0x15b856){console['error'](_0x3c41d2(0x174)+_0x39aebe['paymentId']),console['error'](_0x3c41d2(0x176)+_0x39aebe[_0x3c41d2(0x97)]+_0x3c41d2(0x7c)+_0x39aebe[_0x3c41d2(0x97)]+_0x3c41d2(0x144)+_0x39aebe[_0x3c41d2(0x97)]+'\x22');const _0x55ad1c=await database_1[_0x3c41d2(0x80)][_0x3c41d2(0x19a)]['findMany']({'where':{'OR':[{'gateway':_0x3c41d2(0x108)},{'gateway':_0x3c41d2(0xab)},{'gateway':_0x3c41d2(0x164)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':'desc'},'take':0xf});console[_0x3c41d2(0x122)](_0x3c41d2(0x96),_0x55ad1c),loggerService_1[_0x3c41d2(0x17d)][_0x3c41d2(0x166)](_0x3c41d2(0x108),new Error(_0x3c41d2(0x133)+_0x39aebe[_0x3c41d2(0x97)]),_0x45ad9e);throw new Error(_0x3c41d2(0x14b)+_0x39aebe['paymentId']);}console['log'](_0x3c41d2(0x119)+_0x15b856['id']+_0x3c41d2(0x1ae)+_0x15b856[_0x3c41d2(0x16a)]+'\x20to\x20'+_0x39aebe[_0x3c41d2(0x16a)]);const _0x14fdb8={};_0x39aebe[_0x3c41d2(0x149)]&&await database_1['default'][_0x3c41d2(0x19a)]['update']({'where':{'id':_0x15b856['id']},'data':{'amount':_0x39aebe[_0x3c41d2(0x149)],'updatedAt':new Date()}}),_0x39aebe[_0x3c41d2(0xee)]&&await database_1[_0x3c41d2(0x80)][_0x3c41d2(0x19a)][_0x3c41d2(0x103)]({'where':{'id':_0x15b856['id']},'data':{'currency':_0x39aebe[_0x3c41d2(0xee)],'updatedAt':new Date()}}),_0x39aebe[_0x3c41d2(0x16a)]===_0x3c41d2(0x145)&&_0x39aebe[_0x3c41d2(0x10c)]&&(_0x14fdb8['failureMessage']=_0x39aebe[_0x3c41d2(0x10c)],console['log'](_0x3c41d2(0x15d)+_0x39aebe[_0x3c41d2(0x10c)])),_0x14fdb8[_0x3c41d2(0x168)]=_0x3c41d2(0x108),await this['updatePaymentStatus'](_0x15b856['id'],_0x39aebe[_0x3c41d2(0x16a)],_0x14fdb8),loggerService_1[_0x3c41d2(0x17d)]['logWebhookProcessed'](_0x3c41d2(0x108),_0x15b856['id'],_0x15b856['status'],_0x39aebe[_0x3c41d2(0x16a)],_0x45ad9e);}catch(_0x55a111){console[_0x3c41d2(0xc7)](_0x3c41d2(0x114),_0x55a111),loggerService_1[_0x3c41d2(0x17d)][_0x3c41d2(0x166)]('mastercard',_0x55a111,_0x45ad9e);throw _0x55a111;}}async[a69_0x38c209(0x1b5)](_0x3dbbd9){const _0x3e6b14=a69_0x38c209;console[_0x3e6b14(0x122)](_0x3e6b14(0x175),JSON[_0x3e6b14(0x83)](_0x3dbbd9,null,0x2));try{const _0x4ee607=await this['amerService'][_0x3e6b14(0xfb)](_0x3dbbd9);console[_0x3e6b14(0x122)]('📊\x20Amer\x20webhook\x20result:',_0x4ee607);if(!_0x4ee607['paymentId']){console[_0x3e6b14(0xc7)]('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data'),console[_0x3e6b14(0xc7)](_0x3e6b14(0x100),Object[_0x3e6b14(0x187)](_0x3dbbd9));throw new Error(_0x3e6b14(0x19f));}let _0x540d9a=null;console[_0x3e6b14(0x122)]('🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x4ee607[_0x3e6b14(0x97)]),_0x540d9a=await database_1['default'][_0x3e6b14(0x19a)]['findFirst']({'where':{'AND':[{'gateway':_0x3e6b14(0x18a)},{'OR':[{'gatewayPaymentId':_0x4ee607['paymentId']},{'gatewayOrderId':_0x4ee607[_0x3e6b14(0x97)]},{'id':_0x4ee607[_0x3e6b14(0x97)]},{'orderId':_0x4ee607[_0x3e6b14(0x97)]}]}]}}),console['log']('🔍\x20Search\x20result:\x20'+(_0x540d9a?_0x3e6b14(0x12d)+_0x540d9a['id']:_0x3e6b14(0x9d)));if(!_0x540d9a){console['error']('❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20'+_0x4ee607[_0x3e6b14(0x97)]);return;}console[_0x3e6b14(0x122)](_0x3e6b14(0x12c)+_0x540d9a['id']+'\x20status\x20'+_0x4ee607[_0x3e6b14(0x16a)]),await this['updatePaymentStatus'](_0x540d9a['id'],_0x4ee607[_0x3e6b14(0x16a)],{'cardLast4':_0x4ee607['additionalInfo']?.[_0x3e6b14(0x1a4)],'paymentMethod':_0x4ee607[_0x3e6b14(0x94)]?.[_0x3e6b14(0x168)]});}catch(_0x46664e){console[_0x3e6b14(0xc7)](_0x3e6b14(0x7f),_0x46664e),loggerService_1[_0x3e6b14(0x17d)][_0x3e6b14(0x166)](_0x3e6b14(0x18a),_0x46664e,_0x3dbbd9);throw _0x46664e;}}async[a69_0x38c209(0x13e)](_0x28e6a4){const _0x4436af=a69_0x38c209;console[_0x4436af(0x122)](_0x4436af(0x1b1),JSON[_0x4436af(0x83)](_0x28e6a4,null,0x2));try{const _0x39c7e3=_0x28e6a4[_0x4436af(0x16a)],_0x524e6c=_0x28e6a4['client_transaction_id'],_0x104608=_0x28e6a4[_0x4436af(0xf3)],_0x41bc76=_0x28e6a4['payment_method'],_0x168677=_0x28e6a4['amount'],_0x5b7fa4=_0x28e6a4[_0x4436af(0xee)],_0x55220b=_0x28e6a4[_0x4436af(0xaa)],_0x6aa2a0=_0x28e6a4[_0x4436af(0x1a7)];if(!_0x524e6c){console[_0x4436af(0xc7)]('❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook');throw new Error(_0x4436af(0x15f));}console[_0x4436af(0x122)](_0x4436af(0xe3),{'status':_0x39c7e3,'clientTransactionId':_0x524e6c,'systemId':_0x104608,'paymentMethod':_0x41bc76,'amount':_0x168677,'currency':_0x5b7fa4,'commission':_0x55220b,'statusAdditionInfo':_0x6aa2a0});const _0x2784d5=await database_1['default'][_0x4436af(0x19a)][_0x4436af(0x74)]({'where':{'OR':[{'gatewayOrderId':_0x524e6c},{'orderId':_0x524e6c},{'id':_0x524e6c},{'gatewayPaymentId':_0x524e6c}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x2784d5){console['error'](_0x4436af(0x153)+_0x524e6c);throw new Error(_0x4436af(0x133)+_0x524e6c);}console['log'](_0x4436af(0x119)+_0x2784d5['id']+_0x4436af(0x1a1)),console[_0x4436af(0x122)]('📊\x20Payment\x20status:\x20'+_0x2784d5[_0x4436af(0x16a)]+_0x4436af(0x183)+_0x39c7e3),_0x39c7e3===_0x4436af(0xc2)?(console[_0x4436af(0x122)]('🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED'),await this[_0x4436af(0x192)](_0x2784d5['id'],_0x4436af(0x145)),console[_0x4436af(0x122)]('✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20'+_0x2784d5['id']+_0x4436af(0xe6)),console[_0x4436af(0x122)]('ℹ️\x20Decline\x20reason:\x20'+(_0x6aa2a0||_0x4436af(0x184)))):console[_0x4436af(0x122)](_0x4436af(0xa9)+_0x39c7e3+'\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)'),await database_1[_0x4436af(0x80)][_0x4436af(0x132)][_0x4436af(0x11a)]({'data':{'paymentId':_0x2784d5['id'],'shopId':_0x2784d5['shopId'],'event':_0x4436af(0x90)+(_0x39c7e3?.[_0x4436af(0x177)]()||_0x4436af(0x15a)),'statusCode':0xc8,'responseBody':JSON[_0x4436af(0x83)](_0x28e6a4)}}),loggerService_1['loggerService'][_0x4436af(0x84)](_0x4436af(0xc4),_0x2784d5['id'],_0x2784d5[_0x4436af(0x16a)],_0x39c7e3==='DECLINED'?_0x4436af(0x145):_0x39c7e3,_0x28e6a4);}catch(_0x5a8899){console[_0x4436af(0xc7)](_0x4436af(0x9e),_0x5a8899),loggerService_1[_0x4436af(0x17d)][_0x4436af(0x166)](_0x4436af(0xc4),_0x5a8899,_0x28e6a4);throw _0x5a8899;}}async[a69_0x38c209(0x7a)](_0xe16a42){const _0x4e946b=a69_0x38c209;console[_0x4e946b(0x122)]('🔄\x20Processing\x20AmPay\x20TRY\x20webhook:',JSON['stringify'](_0xe16a42,null,0x2));try{const _0x33479e=_0xe16a42[_0x4e946b(0x16a)],_0xf96cd3=_0xe16a42[_0x4e946b(0x158)],_0x485648=_0xe16a42['system_id'],_0x1eaa52=_0xe16a42[_0x4e946b(0xed)],_0x4b5213=_0xe16a42[_0x4e946b(0x149)],_0x4a36aa=_0xe16a42[_0x4e946b(0xee)],_0x48e011=_0xe16a42[_0x4e946b(0xaa)],_0x1fed8f=_0xe16a42[_0x4e946b(0x1a7)];if(!_0xf96cd3){console[_0x4e946b(0xc7)](_0x4e946b(0x160));throw new Error(_0x4e946b(0x141));}console[_0x4e946b(0x122)](_0x4e946b(0x11f),{'status':_0x33479e,'clientTransactionId':_0xf96cd3,'systemId':_0x485648,'paymentMethod':_0x1eaa52,'amount':_0x4b5213,'currency':_0x4a36aa,'commission':_0x48e011,'statusAdditionInfo':_0x1fed8f});const _0x1af03b=await database_1['default'][_0x4e946b(0x19a)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0xf96cd3},{'orderId':_0xf96cd3},{'id':_0xf96cd3},{'gatewayPaymentId':_0xf96cd3}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x1af03b){console[_0x4e946b(0xc7)](_0x4e946b(0xa2)+_0xf96cd3);throw new Error(_0x4e946b(0x133)+_0xf96cd3);}console['log']('✅\x20Found\x20payment\x20'+_0x1af03b['id']+_0x4e946b(0xfe)),console[_0x4e946b(0x122)](_0x4e946b(0xc5)+_0x1af03b[_0x4e946b(0x16a)]+_0x4e946b(0x183)+_0x33479e),_0x33479e===_0x4e946b(0xc2)?(console[_0x4e946b(0x122)](_0x4e946b(0x16f)),await this[_0x4e946b(0x192)](_0x1af03b['id'],_0x4e946b(0x145)),console[_0x4e946b(0x122)](_0x4e946b(0x18b)+_0x1af03b['id']+_0x4e946b(0xe6)),console['log']('ℹ️\x20Decline\x20reason:\x20'+(_0x1fed8f||_0x4e946b(0x184)))):console[_0x4e946b(0x122)](_0x4e946b(0x152)+_0x33479e+_0x4e946b(0x78)),await database_1[_0x4e946b(0x80)][_0x4e946b(0x132)][_0x4e946b(0x11a)]({'data':{'paymentId':_0x1af03b['id'],'shopId':_0x1af03b['shopId'],'event':_0x4e946b(0x195)+(_0x33479e?.['toLowerCase']()||_0x4e946b(0x15a)),'statusCode':0xc8,'responseBody':JSON[_0x4e946b(0x83)](_0xe16a42)}}),loggerService_1[_0x4e946b(0x17d)][_0x4e946b(0x84)](_0x4e946b(0x1a2),_0x1af03b['id'],_0x1af03b['status'],_0x33479e===_0x4e946b(0xc2)?_0x4e946b(0x145):_0x33479e,_0xe16a42);}catch(_0x44acee){console['error']('❌\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:',_0x44acee),loggerService_1[_0x4e946b(0x17d)][_0x4e946b(0x166)](_0x4e946b(0x1a2),_0x44acee,_0xe16a42);throw _0x44acee;}}async['sendShopWebhook'](_0x12077d,_0x315ef1){const _0x1bfaa6=a69_0x38c209,_0x5430b1=Date[_0x1bfaa6(0x1af)]();try{const _0x9219be=_0x12077d[_0x1bfaa6(0x123)],_0x59e0ee=_0x9219be[_0x1bfaa6(0x6e)];if(!_0x59e0ee?.[_0x1bfaa6(0x15e)]){console['log'](_0x1bfaa6(0xe8)+_0x9219be['id']);return;}const _0x558dd9=_0x315ef1===_0x1bfaa6(0x1b3)?_0x1bfaa6(0xe0):_0x315ef1===_0x1bfaa6(0x145)?_0x1bfaa6(0x157):_0x315ef1===_0x1bfaa6(0xac)?_0x1bfaa6(0x157):_0x315ef1===_0x1bfaa6(0x9b)?_0x1bfaa6(0x157):_0x315ef1==='REFUND'?_0x1bfaa6(0x157):_0x1bfaa6(0x91);let _0x230682=[];if(_0x59e0ee[_0x1bfaa6(0xe1)])try{_0x230682=Array['isArray'](_0x59e0ee[_0x1bfaa6(0xe1)])?_0x59e0ee['webhookEvents']:JSON[_0x1bfaa6(0xc9)](_0x59e0ee['webhookEvents']);}catch(_0x4974c8){console[_0x1bfaa6(0xc7)]('Error\x20parsing\x20webhook\x20events:',_0x4974c8),_0x230682=[];}if(!_0x230682[_0x1bfaa6(0xc3)](_0x558dd9)){console['log'](_0x1bfaa6(0x178)+_0x558dd9+_0x1bfaa6(0xf5)+_0x9219be['id']);return;}const _0x5f2c30={'event':_0x558dd9,'payment':{'id':_0x12077d['id'],'order_id':_0x12077d[_0x1bfaa6(0xce)],'gateway_order_id':_0x12077d['gatewayOrderId'],'gateway':_0x12077d[_0x1bfaa6(0x10f)],'amount':_0x12077d[_0x1bfaa6(0x149)],'currency':_0x12077d[_0x1bfaa6(0xee)],'status':_0x315ef1['toLowerCase'](),'customer_email':_0x12077d[_0x1bfaa6(0x196)],'customer_name':_0x12077d[_0x1bfaa6(0xb6)],'failure_message':_0x12077d[_0x1bfaa6(0xc1)],'tx_urls':_0x12077d[_0x1bfaa6(0xf4)]?JSON[_0x1bfaa6(0xc9)](_0x12077d[_0x1bfaa6(0xf4)]):null,'created_at':_0x12077d[_0x1bfaa6(0x1a6)],'updated_at':_0x12077d[_0x1bfaa6(0x9c)]}},_0x3d6d7c=await fetch(_0x59e0ee['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x1bfaa6(0xe4),'User-Agent':_0x1bfaa6(0x142)},'body':JSON[_0x1bfaa6(0x83)](_0x5f2c30)}),_0x5804ef=Date['now']()-_0x5430b1,_0x24e26d=_0x3d6d7c['ok']?_0x1bfaa6(0x165):await _0x3d6d7c['text']();loggerService_1[_0x1bfaa6(0x17d)][_0x1bfaa6(0x17f)](_0x12077d[_0x1bfaa6(0x136)],_0x59e0ee[_0x1bfaa6(0x15e)],_0x558dd9,_0x3d6d7c[_0x1bfaa6(0x16a)],_0x5804ef,_0x5f2c30),console[_0x1bfaa6(0x122)]('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x59e0ee[_0x1bfaa6(0x15e)]+_0x1bfaa6(0xa3)+_0x3d6d7c[_0x1bfaa6(0x16a)]+'\x20('+_0x5804ef+_0x1bfaa6(0x13b));}catch(_0x3a6722){console[_0x1bfaa6(0xc7)](_0x1bfaa6(0x11c),_0x3a6722),loggerService_1[_0x1bfaa6(0x17d)]['logShopWebhookError'](_0x12077d[_0x1bfaa6(0x136)],_0x12077d[_0x1bfaa6(0x123)]?.['settings']?.[_0x1bfaa6(0x15e)]||'unknown',_0x1bfaa6(0x106),_0x3a6722,{});}}async[a69_0x38c209(0xcf)](_0x14bc7b,_0x45643b){const _0x56243d=a69_0x38c209;try{const _0x2524b8={'PENDING':_0x56243d(0x127),'PROCESSING':_0x56243d(0xd4),'PAID':_0x56243d(0xd3),'FAILED':_0x56243d(0xaf),'EXPIRED':_0x56243d(0xae),'REFUND':'refund','CHARGEBACK':_0x56243d(0x17c)},_0x546101=_0x2524b8[_0x45643b];if(!_0x546101||_0x546101===_0x56243d(0x127))return;await telegramBotService_1[_0x56243d(0x12f)][_0x56243d(0x14a)](_0x14bc7b[_0x56243d(0x136)],_0x14bc7b,_0x546101);}catch(_0xcfbe57){console[_0x56243d(0xc7)](_0x56243d(0xe9),_0xcfbe57);}}async['getGatewayCommission'](_0xffbe40,_0x47d2c0){const _0x373ada=a69_0x38c209;try{const _0x4cb54a=await database_1[_0x373ada(0x80)]['shop'][_0x373ada(0xd6)]({'where':{'id':_0xffbe40},'select':{'gatewaySettings':!![]}});if(!_0x4cb54a?.[_0x373ada(0x77)])return console[_0x373ada(0x122)](_0x373ada(0x182)+_0xffbe40+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x5b1381=JSON[_0x373ada(0xc9)](_0x4cb54a[_0x373ada(0x77)]);for(const [_0x9125d1,_0x51c7c3]of Object['entries'](_0x5b1381)){if(_0x9125d1[_0x373ada(0x177)]()===_0x47d2c0['toLowerCase']()){const _0x498350=_0x51c7c3['commission']||0xa;return console['log'](_0x373ada(0xa7)+_0x47d2c0+_0x373ada(0x198)+_0xffbe40+':\x20'+_0x498350+'%'),_0x498350;}}return console[_0x373ada(0x122)](_0x373ada(0x161)+_0x47d2c0+_0x373ada(0xad)+_0xffbe40+_0x373ada(0x11d)),0xa;}catch(_0x20c6eb){return console['error'](_0x373ada(0xbe)+_0xffbe40+_0x373ada(0x118)+_0x47d2c0+':',_0x20c6eb),0xa;}}async[a69_0x38c209(0x109)](_0x1f1104,_0x5e3801){const _0x47e8f0=a69_0x38c209;console[_0x47e8f0(0x122)](_0x47e8f0(0x16c)),console[_0x47e8f0(0x122)](_0x47e8f0(0xbf),JSON['stringify'](_0x1f1104,null,0x2)),console[_0x47e8f0(0x122)](_0x47e8f0(0xd2),JSON[_0x47e8f0(0x83)](_0x5e3801,null,0x2));try{const _0x3f6299=_0x1f1104['customerOrderId']||_0x5e3801[_0x47e8f0(0x110)],_0x5903af=_0x1f1104[_0x47e8f0(0x16a)]||_0x5e3801[_0x47e8f0(0x16a)],_0x5276bf=_0x1f1104[_0x47e8f0(0x149)]||_0x5e3801[_0x47e8f0(0x149)],_0xccd321=_0x1f1104[_0x47e8f0(0xee)]||_0x5e3801['currency'],_0x55db73=_0x1f1104['dateTime']||_0x5e3801['dateTime'];if(!_0x3f6299){console[_0x47e8f0(0xc7)](_0x47e8f0(0x129));throw new Error(_0x47e8f0(0x1a0));}console[_0x47e8f0(0x122)](_0x47e8f0(0x1ac),{'customerOrderId':_0x3f6299,'status':_0x5903af,'amount':_0x5276bf,'currency':_0xccd321,'dateTime':_0x55db73});const _0x2d1e6b=await database_1['default'][_0x47e8f0(0x19a)][_0x47e8f0(0x74)]({'where':{'OR':[{'gatewayOrderId':_0x3f6299},{'orderId':_0x3f6299},{'id':_0x3f6299},{'gatewayPaymentId':_0x3f6299}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x2d1e6b){console[_0x47e8f0(0xc7)](_0x47e8f0(0x18e)+_0x3f6299);throw new Error(_0x47e8f0(0x133)+_0x3f6299);}console[_0x47e8f0(0x122)]('✅\x20Found\x20payment\x20'+_0x2d1e6b['id']+_0x47e8f0(0x111)),console[_0x47e8f0(0x122)](_0x47e8f0(0xc5)+_0x2d1e6b['status']+_0x47e8f0(0x183)+_0x5903af);let _0x2ae377=_0x5903af?.['toUpperCase']();_0x5903af==='FAILED'||_0x5903af===_0x47e8f0(0xac)?(_0x2ae377='FAILED',console[_0x47e8f0(0x122)](_0x47e8f0(0x171)+_0x5903af+_0x47e8f0(0x16b)),await this[_0x47e8f0(0x192)](_0x2d1e6b['id'],_0x2ae377),console[_0x47e8f0(0x122)]('✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20'+_0x2d1e6b['id']+_0x47e8f0(0xe6))):console['log']('ℹ️\x20MyXSpend\x20status\x20'+_0x5903af+_0x47e8f0(0x89)),await database_1['default'][_0x47e8f0(0x132)][_0x47e8f0(0x11a)]({'data':{'paymentId':_0x2d1e6b['id'],'shopId':_0x2d1e6b[_0x47e8f0(0x136)],'event':_0x47e8f0(0x13a)+(_0x5903af?.['toLowerCase']()||_0x47e8f0(0x15a)),'statusCode':0xc8,'responseBody':JSON[_0x47e8f0(0x83)]({'queryParams':_0x1f1104,'bodyData':_0x5e3801})}}),loggerService_1[_0x47e8f0(0x17d)][_0x47e8f0(0x84)](_0x47e8f0(0x190),_0x2d1e6b['id'],_0x2d1e6b[_0x47e8f0(0x16a)],_0x2ae377||_0x5903af,{'queryParams':_0x1f1104,'bodyData':_0x5e3801});}catch(_0x137435){console['error'](_0x47e8f0(0x8c),_0x137435),loggerService_1[_0x47e8f0(0x17d)]['logWebhookError'](_0x47e8f0(0x190),_0x137435,{'queryParams':_0x1f1104,'bodyData':_0x5e3801});throw _0x137435;}}}exports[a69_0x38c209(0x1b0)]=WebhookService;