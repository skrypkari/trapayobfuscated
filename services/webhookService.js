'use strict';const a60_0x4c6952=a60_0x52bb;(function(_0x50f34b,_0x59a63d){const _0x4180f0=a60_0x52bb,_0x2de5e1=_0x50f34b();while(!![]){try{const _0x294440=-parseInt(_0x4180f0(0x27c))/0x1*(parseInt(_0x4180f0(0x271))/0x2)+parseInt(_0x4180f0(0x2a2))/0x3+-parseInt(_0x4180f0(0x20d))/0x4+parseInt(_0x4180f0(0x274))/0x5+-parseInt(_0x4180f0(0x22d))/0x6+-parseInt(_0x4180f0(0x25b))/0x7*(-parseInt(_0x4180f0(0x209))/0x8)+-parseInt(_0x4180f0(0x272))/0x9*(-parseInt(_0x4180f0(0x268))/0xa);if(_0x294440===_0x59a63d)break;else _0x2de5e1['push'](_0x2de5e1['shift']());}catch(_0x2eb94c){_0x2de5e1['push'](_0x2de5e1['shift']());}}}(a60_0x2fb4,0xb53a9));var __importDefault=this&&this['__importDefault']||function(_0x3c4a1f){return _0x3c4a1f&&_0x3c4a1f['__esModule']?_0x3c4a1f:{'default':_0x3c4a1f};};Object[a60_0x4c6952(0x22c)](exports,a60_0x4c6952(0x1f9),{'value':!![]}),exports[a60_0x4c6952(0x298)]=void 0x0;function a60_0x52bb(_0x44dfee,_0x368855){const _0x2fb4d0=a60_0x2fb4();return a60_0x52bb=function(_0x52bb32,_0x37fb1c){_0x52bb32=_0x52bb32-0x1bc;let _0x1cc067=_0x2fb4d0[_0x52bb32];return _0x1cc067;},a60_0x52bb(_0x44dfee,_0x368855);}const database_1=__importDefault(require(a60_0x4c6952(0x1be))),plisioService_1=require(a60_0x4c6952(0x23a)),rapydService_1=require(a60_0x4c6952(0x278)),nodaService_1=require(a60_0x4c6952(0x1ca)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a60_0x4c6952(0x28c)),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a60_0x4c6952(0x1c2)),amerService_1=require(a60_0x4c6952(0x1f7)),telegramBotService_1=require(a60_0x4c6952(0x1f4)),currencyService_1=require('./currencyService'),loggerService_1=require('./loggerService');function a60_0x2fb4(){const _0x32dcf2=['processCoinToPayWebhook','./gateways/mastercardService','Error\x20processing\x20CoinToPay2\x20webhook:','failureMessage','Error\x20parsing\x20webhook\x20events:','📈\x20Payment\x20','nodaService','Failed\x20to\x20send\x20shop\x20webhook:','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','./gateways/nodaService','toFixed','\x20-\x20','CoinToPayService','PAID','expired','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20not\x20enabled\x20for\x20shop\x20','Success','loggerService','plisio','\x22,\x20paymentLinkId=\x22','application/json','isArray','🔄\x20Processing\x20Rapyd\x20webhook:','SINGLE','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','📊\x20KLYME\x20webhook:\x20Payment\x20','💰\x20Adding\x20to\x20balance:\x20','bankId','paymentMethod','customerName','\x22,\x20newStatus=\x22','💰\x20Removing\x20from\x20balance:\x20','📤\x20Shop\x20webhook\x20sent\x20to\x20','createdAt','findFirst','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','No\x20payment\x20ID\x20in\x20Noda\x20webhook','amountUSDT','🔄\x20Processing\x20KLYME\x20webhook:','failed','Found\x20payment\x20','paymentId','masterCardService','logShopWebhookSent',',\x20gateway\x20','system','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','logWebhookProcessed','./telegramBotService','amer','📈\x20Payment\x20details:\x20oldStatus=\x22','./gateways/amerService','COMPLETED','__esModule','webhook_send','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','sendPaymentStatusNotification','No\x20payment\x20ID\x20in\x20Amer\x20webhook','paymentLinkId','rapyd','❌\x20Error\x20processing\x20MasterCard\x20webhook:','mastercard','noda','logWebhookError','REFUND','create','🔄\x20Processing\x20CoinToPay2\x20webhook:','\x20with\x20status\x20','default','1277984XbLVaY','getGatewayCommission',',\x20currentPayments=','txUrls','3698936EVwcZE',',\x20newStatus=','currency','📊\x20Amer\x20webhook\x20result:','additionalInfo','✅\x20Shop\x20','paidAt','includes','\x20in\x20shop\x20','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','toUpperCase','cointopay2','processCoinToPay2Webhook','📊\x20Amer\x20webhook:\x20Payment\x20','🏪\x20Shop\x20','cointopay','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','currentPayments','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','\x20not\x20found','\x20status\x20','🔄\x20Processing\x20Plisio\x20webhook:','webhookUrl','💰\x20Payment\x20','💰\x20Gateway\x20','telegramBotService','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','📊\x20Plisio\x20webhook:\x20Payment\x20','payment.failed','update','updatedAt','defineProperty','3672954luGHzd','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','\x22,\x20id=\x22','📊\x20Noda\x20webhook:\x20Payment\x20','plisioService','chargeback','updatePaymentStatus','toLowerCase','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','MasterCardService','entries','unknown','NodaService','./gateways/plisioService','cardLast4','Error\x20processing\x20CoinToPay\x20webhook:','status','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','findUnique','RapydService','type','🔄\x20Additional\x20data:','🔄\x20Processing\x20Amer\x20webhook:','chargebackAmount','webhook_status_change_','processAmerWebhook','processKlymeWebhook','logShopWebhookError','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','FAILED','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','now','created','processNodaWebhook','klyme',',\x20using\x20default\x2010%','💰\x20Amount\x20after\x20gateway\x20commission:\x20','gateway','gatewaySettings','📊\x20MasterCard\x20webhook\x20result:','rapydService','customerEmail','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20',',\x20status=','convertToUSDT','\x20USDT','7LYhZGE','💰\x20Final\x20balance\x20after\x20chargeback:\x20','webhookLog','❌\x20Payment\x20link\x20','amountAfterGatewayCommissionUSDT','💰\x20Converting\x20','balance','\x20->\x20','sendPaymentNotification','amount','AmerService','\x20commission:\x20',',\x20using\x20default\x20commission\x2010%','10wkHdDS','🔄\x20Processing\x20MasterCard\x20webhook:','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','payment.pending','🔄\x20Processing\x20Noda\x20webhook:','🔍\x20Search\x20result:\x20','CHARGEBACK','📈\x20Found\x20payment\x20link\x20','findMany','10kAWZQS','14945922ebyVDc','error','4593690nUehzu','klymeService','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','./gateways/rapydService','username','amerService','toISOString','100591AWTEEB','stringify','Webhook\x20event\x20','\x20balance\x20updated:\x20','plisio_gateway','Payment\x20','TesSoft\x20Payment\x20System/1.0','sendShopWebhook','log','orderId','\x20=\x20','POST','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','parse','\x20updated:\x20currentPayments=','webhookEvents','./gateways/coinToPay2Service','📊\x20CoinToPay\x20webhook:\x20Payment\x20','shop','refund','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','processing','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','commission','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','Error\x20processing\x20Rapyd\x20webhook:','PlisioService','WebhookService','Gateway\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','💸\x20Additional\x20chargeback\x20penalty:\x20-','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','✅\x20Payment\x20link\x20','shopId','paymentLink','currencyService','129051gGqVTq','\x20+\x20','remitterName','payment','\x20USDT\x20(chargeback\x20penalty)','processWebhook','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','processRapydWebhook','remitterIban','paid','Payment\x20not\x20found','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','../config/database','keys','%\x20gateway\x20commission)'];a60_0x2fb4=function(){return _0x32dcf2;};return a60_0x2fb4();}class WebhookService{constructor(){const _0x2cb4bd=a60_0x4c6952;this[_0x2cb4bd(0x231)]=new plisioService_1[(_0x2cb4bd(0x297))](),this['rapydService']=new rapydService_1[(_0x2cb4bd(0x240))](),this[_0x2cb4bd(0x1c7)]=new nodaService_1[(_0x2cb4bd(0x239))](),this['coinToPayService']=new coinToPayService_1[(_0x2cb4bd(0x1cd))](),this['coinToPay2Service']=new coinToPay2Service_1['CoinToPay2Service'](),this[_0x2cb4bd(0x275)]=new klymeService_1['KlymeService'](),this[_0x2cb4bd(0x1ee)]=new mastercardService_1[(_0x2cb4bd(0x236))](),this[_0x2cb4bd(0x27a)]=new amerService_1[(_0x2cb4bd(0x265))]();}async[a60_0x4c6952(0x233)](_0x27472f,_0x59842a,_0x398b12){const _0x172067=a60_0x4c6952;console[_0x172067(0x284)](_0x172067(0x2a8)+_0x27472f+_0x172067(0x20e)+_0x59842a),console[_0x172067(0x284)](_0x172067(0x242),_0x398b12),await database_1[_0x172067(0x208)]['$transaction'](async _0x43ab93=>{const _0x608722=_0x172067,_0x1cc9f8=await _0x43ab93['payment'][_0x608722(0x23f)]({'where':{'id':_0x27472f},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1cc9f8)throw new Error(_0x608722(0x281)+_0x27472f+_0x608722(0x220));const _0x3dbce3=_0x1cc9f8[_0x608722(0x23d)],_0x336f5d=_0x1cc9f8[_0x608722(0x28e)];console['log'](_0x608722(0x224)+_0x27472f+':\x20'+_0x3dbce3+_0x608722(0x262)+_0x59842a),console[_0x608722(0x284)](_0x608722(0x21b)+_0x336f5d[_0x608722(0x279)]+'\x20current\x20balance:\x20'+_0x336f5d[_0x608722(0x261)]+_0x608722(0x25a));const _0x1ef4dc={'status':_0x59842a[_0x608722(0x217)](),'updatedAt':new Date(),'statusChangedBy':_0x608722(0x1f1),'statusChangedAt':new Date()};_0x398b12?.[_0x608722(0x1c4)]&&(_0x1ef4dc[_0x608722(0x1c4)]=_0x398b12[_0x608722(0x1c4)]);_0x398b12?.[_0x608722(0x20c)]&&(_0x1ef4dc[_0x608722(0x20c)]=JSON[_0x608722(0x27d)](_0x398b12[_0x608722(0x20c)]));_0x398b12?.[_0x608722(0x23b)]&&(_0x1ef4dc[_0x608722(0x23b)]=_0x398b12['cardLast4']);_0x398b12?.['paymentMethod']&&(_0x1ef4dc[_0x608722(0x1e0)]=_0x398b12[_0x608722(0x1e0)]);_0x398b12?.[_0x608722(0x1df)]&&(_0x1ef4dc[_0x608722(0x1df)]=_0x398b12[_0x608722(0x1df)]);_0x398b12?.['remitterIban']&&(_0x1ef4dc[_0x608722(0x2aa)]=_0x398b12[_0x608722(0x2aa)]);_0x398b12?.[_0x608722(0x2a4)]&&(_0x1ef4dc[_0x608722(0x2a4)]=_0x398b12[_0x608722(0x2a4)]);let _0x5bee7d=_0x336f5d['balance'],_0x14f1e4='';if(_0x59842a[_0x608722(0x217)]()==='PAID'&&_0x3dbce3!==_0x608722(0x1ce)){const _0x14073f=await currencyService_1[_0x608722(0x2a1)][_0x608722(0x259)](_0x1cc9f8[_0x608722(0x264)],_0x1cc9f8[_0x608722(0x20f)]),_0x117f77=await this[_0x608722(0x20a)](_0x336f5d['id'],_0x1cc9f8[_0x608722(0x252)]),_0x48ffff=_0x14073f*(0x1-_0x117f77/0x64);_0x5bee7d+=_0x48ffff,_0x14f1e4='+'+_0x48ffff['toFixed'](0x6)+_0x608722(0x1da)+_0x117f77+_0x608722(0x1c0),_0x1ef4dc[_0x608722(0x1e9)]=_0x14073f,_0x1ef4dc[_0x608722(0x25f)]=_0x48ffff,_0x1ef4dc['paidAt']=new Date(),console[_0x608722(0x284)](_0x608722(0x260)+_0x1cc9f8[_0x608722(0x264)]+'\x20'+_0x1cc9f8[_0x608722(0x20f)]+_0x608722(0x262)+_0x14073f[_0x608722(0x1cb)](0x6)+'\x20USDT'),console[_0x608722(0x284)](_0x608722(0x225)+_0x1cc9f8[_0x608722(0x252)]+_0x608722(0x266)+_0x117f77+'%'),console[_0x608722(0x284)](_0x608722(0x251)+_0x48ffff[_0x608722(0x1cb)](0x6)+_0x608722(0x25a)),console[_0x608722(0x284)](_0x608722(0x1de)+_0x336f5d[_0x608722(0x261)]+_0x608722(0x2a3)+_0x48ffff[_0x608722(0x1cb)](0x6)+_0x608722(0x286)+_0x5bee7d[_0x608722(0x1cb)](0x6)+_0x608722(0x25a));}else{if(_0x3dbce3===_0x608722(0x1ce)&&_0x59842a['toUpperCase']()!=='PAID'){let _0x5898b6;if(_0x1cc9f8[_0x608722(0x25f)])_0x5898b6=_0x1cc9f8['amountAfterGatewayCommissionUSDT'];else{if(_0x1cc9f8['amountUSDT']){const _0x71110d=await this['getGatewayCommission'](_0x336f5d['id'],_0x1cc9f8[_0x608722(0x252)]);_0x5898b6=_0x1cc9f8[_0x608722(0x1e9)]*(0x1-_0x71110d/0x64);}else console['log']('No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance'),_0x5898b6=0x0;}_0x5898b6>0x0&&(_0x5bee7d-=_0x5898b6,_0x14f1e4='-'+_0x5898b6['toFixed'](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x1ef4dc[_0x608722(0x1e9)]=null,_0x1ef4dc['amountAfterGatewayCommissionUSDT']=null,_0x1ef4dc[_0x608722(0x213)]=null,console['log'](_0x608722(0x1e3)+_0x336f5d[_0x608722(0x261)]+_0x608722(0x1cc)+_0x5898b6[_0x608722(0x1cb)](0x6)+_0x608722(0x286)+_0x5bee7d[_0x608722(0x1cb)](0x6)+_0x608722(0x25a)));}}if(_0x59842a[_0x608722(0x217)]()===_0x608722(0x26e)){const _0x560622=_0x398b12?.[_0x608722(0x244)]||0x0;_0x560622>0x0&&(_0x5bee7d-=_0x560622,_0x14f1e4+='\x20and\x20-'+_0x560622['toFixed'](0x6)+_0x608722(0x2a6),_0x1ef4dc['chargebackAmount']=_0x560622,console[_0x608722(0x284)](_0x608722(0x29b)+_0x560622['toFixed'](0x6)+_0x608722(0x25a)),console[_0x608722(0x284)](_0x608722(0x25c)+_0x5bee7d[_0x608722(0x1cb)](0x6)+_0x608722(0x25a)));}const _0x5b06b9=await _0x43ab93[_0x608722(0x2a5)][_0x608722(0x22a)]({'where':{'id':_0x27472f},'data':_0x1ef4dc});_0x5bee7d!==_0x336f5d[_0x608722(0x261)]&&(await _0x43ab93[_0x608722(0x28e)][_0x608722(0x22a)]({'where':{'id':_0x336f5d['id']},'data':{'balance':_0x5bee7d}}),console['log'](_0x608722(0x212)+_0x336f5d['username']+_0x608722(0x27f)+_0x336f5d['balance'][_0x608722(0x1cb)](0x6)+'\x20->\x20'+_0x5bee7d['toFixed'](0x6)+'\x20USDT'),console[_0x608722(0x284)]('📝\x20Reason:\x20'+_0x14f1e4));await _0x43ab93[_0x608722(0x25d)][_0x608722(0x205)]({'data':{'paymentId':_0x27472f,'shopId':_0x336f5d['id'],'event':_0x608722(0x245)+_0x59842a[_0x608722(0x234)](),'statusCode':0xc8,'responseBody':JSON[_0x608722(0x27d)]({'oldStatus':_0x3dbce3,'newStatus':_0x59842a[_0x608722(0x217)](),'balanceChange':_0x14f1e4||'no\x20balance\x20change','oldBalance':_0x336f5d[_0x608722(0x261)],'newBalance':_0x5bee7d,'amountUSDT':_0x1ef4dc[_0x608722(0x1e9)],'additionalData':_0x398b12,'timestamp':new Date()[_0x608722(0x27b)]()})}}),await this[_0x608722(0x283)]({..._0x1cc9f8,..._0x5b06b9,'shop':_0x336f5d},_0x59842a[_0x608722(0x217)]()),await this['sendPaymentStatusNotification']({..._0x1cc9f8,..._0x5b06b9},_0x59842a[_0x608722(0x217)]());if(_0x3dbce3!=='PAID'&&_0x59842a['toUpperCase']()===_0x608722(0x1ce)){console[_0x608722(0x284)](_0x608722(0x1c6)+_0x27472f+_0x608722(0x29c)),console[_0x608722(0x284)](_0x608722(0x1f6)+_0x3dbce3+_0x608722(0x1e2)+_0x59842a[_0x608722(0x217)]()+_0x608722(0x1d5)+_0x1cc9f8['paymentLinkId']+'\x22');if(_0x1cc9f8[_0x608722(0x1fe)])try{const _0x2f1f28=await _0x43ab93[_0x608722(0x2a0)][_0x608722(0x23f)]({'where':{'id':_0x1cc9f8[_0x608722(0x1fe)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x2f1f28){console[_0x608722(0x284)](_0x608722(0x26f)+_0x2f1f28['id']+':\x20type='+_0x2f1f28[_0x608722(0x241)]+_0x608722(0x20b)+_0x2f1f28['currentPayments']+_0x608722(0x258)+_0x2f1f28['status']);const _0xd033b4=_0x2f1f28[_0x608722(0x21e)]+0x1,_0x4c2e15=_0x2f1f28[_0x608722(0x241)]===_0x608722(0x1d9)?_0x608722(0x1f8):_0x2f1f28['status'];await _0x43ab93[_0x608722(0x2a0)]['update']({'where':{'id':_0x1cc9f8[_0x608722(0x1fe)]},'data':{'currentPayments':_0xd033b4,'status':_0x4c2e15,'updatedAt':new Date()}}),console[_0x608722(0x284)](_0x608722(0x29e)+_0x2f1f28['id']+_0x608722(0x28a)+_0x2f1f28[_0x608722(0x21e)]+_0x608722(0x262)+_0xd033b4+_0x608722(0x258)+_0x2f1f28[_0x608722(0x23d)]+_0x608722(0x262)+_0x4c2e15);}else console[_0x608722(0x284)](_0x608722(0x25e)+_0x1cc9f8[_0x608722(0x1fe)]+'\x20not\x20found');}catch(_0x30f6c7){console[_0x608722(0x273)](_0x608722(0x23e),_0x30f6c7);}else console[_0x608722(0x284)](_0x608722(0x1c6)+_0x27472f+_0x608722(0x295));}else console['log']('📈\x20Payment\x20'+_0x27472f+_0x608722(0x21f)+_0x3dbce3+'\x20->\x20'+_0x59842a[_0x608722(0x217)]());});}async['processPlisioWebhook'](_0x14f399){const _0x598157=a60_0x4c6952;console[_0x598157(0x284)](_0x598157(0x222),_0x14f399);try{const _0x2235f8=await this[_0x598157(0x231)]['processWebhook'](_0x14f399);if(!_0x2235f8['paymentId'])throw new Error(_0x598157(0x26a));const _0x1cffb1=await database_1[_0x598157(0x208)][_0x598157(0x2a5)][_0x598157(0x1e6)]({'where':{'gatewayOrderId':_0x2235f8[_0x598157(0x1ed)]}});if(!_0x1cffb1){console[_0x598157(0x273)]('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x2235f8[_0x598157(0x1ed)]);return;}console['log'](_0x598157(0x228)+_0x1cffb1['id']+_0x598157(0x221)+_0x2235f8[_0x598157(0x23d)]),await this[_0x598157(0x233)](_0x1cffb1['id'],_0x2235f8[_0x598157(0x23d)],{'txUrls':_0x2235f8['txUrls']}),loggerService_1['loggerService'][_0x598157(0x1f3)](_0x598157(0x1d4),_0x1cffb1['id'],_0x1cffb1[_0x598157(0x23d)],_0x2235f8[_0x598157(0x23d)],_0x14f399);}catch(_0x86d5de){console['error']('Error\x20processing\x20Plisio\x20webhook:',_0x86d5de),loggerService_1['loggerService'][_0x598157(0x203)](_0x598157(0x1d4),_0x86d5de,_0x14f399);throw _0x86d5de;}}async['processPlisioGatewayWebhook'](_0x1c2508){const _0x5f4e10=a60_0x4c6952;console[_0x5f4e10(0x284)](_0x5f4e10(0x227),_0x1c2508);try{const _0x50be62=await this['plisioService'][_0x5f4e10(0x2a7)](_0x1c2508);if(!_0x50be62[_0x5f4e10(0x1ed)])throw new Error(_0x5f4e10(0x1e7));const _0x2020ca=await database_1[_0x5f4e10(0x208)]['payment'][_0x5f4e10(0x1e6)]({'where':{'gatewayOrderId':_0x50be62[_0x5f4e10(0x1ed)]}});if(!_0x2020ca){console[_0x5f4e10(0x273)](_0x5f4e10(0x216)+_0x50be62[_0x5f4e10(0x1ed)]);return;}console[_0x5f4e10(0x284)]('📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20'+_0x2020ca['id']+_0x5f4e10(0x221)+_0x50be62[_0x5f4e10(0x23d)]),await this[_0x5f4e10(0x233)](_0x2020ca['id'],_0x50be62[_0x5f4e10(0x23d)],{'txUrls':_0x50be62[_0x5f4e10(0x20c)]}),loggerService_1['loggerService']['logWebhookProcessed'](_0x5f4e10(0x280),_0x2020ca['id'],_0x2020ca[_0x5f4e10(0x23d)],_0x50be62[_0x5f4e10(0x23d)],_0x1c2508);}catch(_0x510b6a){console[_0x5f4e10(0x273)](_0x5f4e10(0x294),_0x510b6a),loggerService_1[_0x5f4e10(0x1d3)][_0x5f4e10(0x203)](_0x5f4e10(0x280),_0x510b6a,_0x1c2508);throw _0x510b6a;}}async[a60_0x4c6952(0x2a9)](_0x486a1d){const _0x29b30f=a60_0x4c6952;console['log'](_0x29b30f(0x1d8),_0x486a1d);try{const _0x19ab5a=await this[_0x29b30f(0x255)]['processWebhook'](_0x486a1d);if(!_0x19ab5a[_0x29b30f(0x1ed)])throw new Error(_0x29b30f(0x292));const _0x46d00b=await database_1[_0x29b30f(0x208)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x19ab5a[_0x29b30f(0x1ed)]}});if(!_0x46d00b){console['error'](_0x29b30f(0x1bd)+_0x19ab5a[_0x29b30f(0x1ed)]);return;}console[_0x29b30f(0x284)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x46d00b['id']+_0x29b30f(0x221)+_0x19ab5a[_0x29b30f(0x23d)]),await this['updatePaymentStatus'](_0x46d00b['id'],_0x19ab5a[_0x29b30f(0x23d)],{'failureMessage':_0x19ab5a['failureMessage'],'cardLast4':_0x19ab5a[_0x29b30f(0x211)]?.[_0x29b30f(0x23b)],'paymentMethod':_0x19ab5a[_0x29b30f(0x211)]?.[_0x29b30f(0x1e0)]}),loggerService_1[_0x29b30f(0x1d3)][_0x29b30f(0x1f3)](_0x29b30f(0x1ff),_0x46d00b['id'],_0x46d00b[_0x29b30f(0x23d)],_0x19ab5a[_0x29b30f(0x23d)],_0x486a1d);}catch(_0xb90d40){console[_0x29b30f(0x273)](_0x29b30f(0x296),_0xb90d40),loggerService_1['loggerService']['logWebhookError'](_0x29b30f(0x1ff),_0xb90d40,_0x486a1d);throw _0xb90d40;}}async[a60_0x4c6952(0x24e)](_0x45a61b){const _0x556775=a60_0x4c6952;console[_0x556775(0x284)](_0x556775(0x26c),_0x45a61b);try{const _0x2c6c01=await this['nodaService'][_0x556775(0x2a7)](_0x45a61b);if(!_0x2c6c01[_0x556775(0x1ed)])throw new Error(_0x556775(0x1e8));const _0x1d261e=await database_1[_0x556775(0x208)][_0x556775(0x2a5)]['findFirst']({'where':{'gatewayOrderId':_0x2c6c01[_0x556775(0x1ed)]}});if(!_0x1d261e){console[_0x556775(0x273)](_0x556775(0x276)+_0x2c6c01['paymentId']);return;}console[_0x556775(0x284)](_0x556775(0x230)+_0x1d261e['id']+_0x556775(0x221)+_0x2c6c01[_0x556775(0x23d)]),await this[_0x556775(0x233)](_0x1d261e['id'],_0x2c6c01[_0x556775(0x23d)],{'bankId':_0x2c6c01[_0x556775(0x211)]?.['bankId'],'remitterIban':_0x2c6c01[_0x556775(0x211)]?.[_0x556775(0x2aa)],'remitterName':_0x2c6c01[_0x556775(0x211)]?.[_0x556775(0x2a4)]}),loggerService_1[_0x556775(0x1d3)]['logWebhookProcessed'](_0x556775(0x202),_0x1d261e['id'],_0x1d261e[_0x556775(0x23d)],_0x2c6c01['status'],_0x45a61b);}catch(_0x2a327b){console[_0x556775(0x273)]('Error\x20processing\x20Noda\x20webhook:',_0x2a327b),loggerService_1[_0x556775(0x1d3)][_0x556775(0x203)](_0x556775(0x202),_0x2a327b,_0x45a61b);throw _0x2a327b;}}async[a60_0x4c6952(0x1c1)](_0x427ddf){const _0x1ff5ff=a60_0x4c6952;console[_0x1ff5ff(0x284)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x427ddf);try{const _0x93524f=await this['coinToPayService'][_0x1ff5ff(0x2a7)](_0x427ddf);if(!_0x93524f[_0x1ff5ff(0x1ed)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x5b0d76=await database_1[_0x1ff5ff(0x208)]['payment'][_0x1ff5ff(0x1e6)]({'where':{'gatewayOrderId':_0x93524f[_0x1ff5ff(0x1ed)]}});if(!_0x5b0d76){console[_0x1ff5ff(0x273)](_0x1ff5ff(0x1fb)+_0x93524f[_0x1ff5ff(0x1ed)]);return;}console[_0x1ff5ff(0x284)](_0x1ff5ff(0x28d)+_0x5b0d76['id']+_0x1ff5ff(0x221)+_0x93524f[_0x1ff5ff(0x23d)]),await this['updatePaymentStatus'](_0x5b0d76['id'],_0x93524f[_0x1ff5ff(0x23d)]),loggerService_1[_0x1ff5ff(0x1d3)][_0x1ff5ff(0x1f3)](_0x1ff5ff(0x21c),_0x5b0d76['id'],_0x5b0d76['status'],_0x93524f[_0x1ff5ff(0x23d)],_0x427ddf);}catch(_0x3abd1d){console[_0x1ff5ff(0x273)](_0x1ff5ff(0x23c),_0x3abd1d),loggerService_1['loggerService']['logWebhookError'](_0x1ff5ff(0x21c),_0x3abd1d,_0x427ddf);throw _0x3abd1d;}}async[a60_0x4c6952(0x219)](_0x21ada8){const _0xda0fa6=a60_0x4c6952;console[_0xda0fa6(0x284)](_0xda0fa6(0x206),_0x21ada8);try{const _0x22c4bb=await this['coinToPay2Service'][_0xda0fa6(0x2a7)](_0x21ada8);if(!_0x22c4bb[_0xda0fa6(0x1ed)])throw new Error(_0xda0fa6(0x29a));const _0x640cdc=await database_1[_0xda0fa6(0x208)][_0xda0fa6(0x2a5)][_0xda0fa6(0x1e6)]({'where':{'gatewayOrderId':_0x22c4bb[_0xda0fa6(0x1ed)]}});if(!_0x640cdc){console['error'](_0xda0fa6(0x1dc)+_0x22c4bb[_0xda0fa6(0x1ed)]);return;}console[_0xda0fa6(0x284)](_0xda0fa6(0x22e)+_0x640cdc['id']+_0xda0fa6(0x221)+_0x22c4bb[_0xda0fa6(0x23d)]),await this['updatePaymentStatus'](_0x640cdc['id'],_0x22c4bb[_0xda0fa6(0x23d)]),loggerService_1[_0xda0fa6(0x1d3)][_0xda0fa6(0x1f3)]('cointopay2',_0x640cdc['id'],_0x640cdc['status'],_0x22c4bb[_0xda0fa6(0x23d)],_0x21ada8);}catch(_0x22c465){console['error'](_0xda0fa6(0x1c3),_0x22c465),loggerService_1[_0xda0fa6(0x1d3)][_0xda0fa6(0x203)](_0xda0fa6(0x218),_0x22c465,_0x21ada8);throw _0x22c465;}}async[a60_0x4c6952(0x247)](_0x2de5c7){const _0x25e89b=a60_0x4c6952;console['log'](_0x25e89b(0x1ea),_0x2de5c7);try{const _0x4378f8=await this[_0x25e89b(0x275)][_0x25e89b(0x2a7)](_0x2de5c7);if(!_0x4378f8[_0x25e89b(0x1ed)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x473caf=await database_1[_0x25e89b(0x208)][_0x25e89b(0x2a5)]['findFirst']({'where':{'gatewayOrderId':_0x4378f8['paymentId']}});if(!_0x473caf){console[_0x25e89b(0x273)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x4378f8[_0x25e89b(0x1ed)]);return;}console['log'](_0x25e89b(0x1dd)+_0x473caf['id']+_0x25e89b(0x221)+_0x4378f8[_0x25e89b(0x23d)]),await this[_0x25e89b(0x233)](_0x473caf['id'],_0x4378f8[_0x25e89b(0x23d)],{'paymentMethod':_0x4378f8[_0x25e89b(0x211)]?.['payment_method']}),loggerService_1[_0x25e89b(0x1d3)][_0x25e89b(0x1f3)](_0x25e89b(0x24f),_0x473caf['id'],_0x473caf[_0x25e89b(0x23d)],_0x4378f8[_0x25e89b(0x23d)],_0x2de5c7);}catch(_0x4bd654){console[_0x25e89b(0x273)]('Error\x20processing\x20KLYME\x20webhook:',_0x4bd654),loggerService_1[_0x25e89b(0x1d3)]['logWebhookError'](_0x25e89b(0x24f),_0x4bd654,_0x2de5c7);throw _0x4bd654;}}async['processMasterCardWebhook'](_0x3d72b7){const _0x581862=a60_0x4c6952;console['log'](_0x581862(0x269),JSON[_0x581862(0x27d)](_0x3d72b7,null,0x2));try{const _0x507056=await this[_0x581862(0x1ee)]['processWebhook'](_0x3d72b7);console[_0x581862(0x284)](_0x581862(0x254),_0x507056);if(!_0x507056['paymentId']){console[_0x581862(0x273)](_0x581862(0x1c9)),console[_0x581862(0x273)]('❌\x20Available\x20webhook\x20fields:',Object['keys'](_0x3d72b7));throw new Error(_0x581862(0x24b));}let _0x211ae0=null;console[_0x581862(0x284)](_0x581862(0x1d0)+_0x507056['paymentId']);_0x507056[_0x581862(0x1ed)]&&(console[_0x581862(0x284)](_0x581862(0x29d)),_0x211ae0=await database_1['default'][_0x581862(0x2a5)][_0x581862(0x1e6)]({'where':{'AND':[{'gateway':_0x581862(0x201)},{'OR':[{'gatewayPaymentId':_0x507056[_0x581862(0x1ed)]},{'gatewayOrderId':_0x507056['paymentId']},{'id':_0x507056[_0x581862(0x1ed)]},{'orderId':_0x507056[_0x581862(0x1ed)]}]}]}}),console['log'](_0x581862(0x26d)+(_0x211ae0?'Found\x20payment\x20'+_0x211ae0['id']:'Payment\x20not\x20found')));if(!_0x211ae0){console['error']('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x507056[_0x581862(0x1ed)]),console[_0x581862(0x273)]('🔍\x20Searched\x20by:\x20gatewayOrderId=\x22'+_0x507056['paymentId']+_0x581862(0x22f)+_0x507056['paymentId']+'\x22,\x20orderId=\x22'+_0x507056['paymentId']+'\x22');const _0x163659=await database_1[_0x581862(0x208)][_0x581862(0x2a5)][_0x581862(0x270)]({'where':{'gateway':_0x581862(0x201)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console['log'](_0x581862(0x288),_0x163659);return;}console[_0x581862(0x284)]('✅\x20Found\x20payment\x20'+_0x211ae0['id']+_0x581862(0x277)+_0x211ae0['status']+'\x20to\x20'+_0x507056[_0x581862(0x23d)]),await this[_0x581862(0x233)](_0x211ae0['id'],_0x507056[_0x581862(0x23d)]),loggerService_1['loggerService'][_0x581862(0x1f3)](_0x581862(0x201),_0x211ae0['id'],_0x211ae0['status'],_0x507056[_0x581862(0x23d)],_0x3d72b7);}catch(_0x254756){console[_0x581862(0x273)](_0x581862(0x200),_0x254756),loggerService_1[_0x581862(0x1d3)][_0x581862(0x203)](_0x581862(0x201),_0x254756,_0x3d72b7);throw _0x254756;}}async[a60_0x4c6952(0x246)](_0x3c0a00){const _0xf252ad=a60_0x4c6952;console[_0xf252ad(0x284)](_0xf252ad(0x243),JSON[_0xf252ad(0x27d)](_0x3c0a00,null,0x2));try{const _0x4ab8b7=await this[_0xf252ad(0x27a)][_0xf252ad(0x2a7)](_0x3c0a00);console[_0xf252ad(0x284)](_0xf252ad(0x210),_0x4ab8b7);if(!_0x4ab8b7['paymentId']){console['error'](_0xf252ad(0x1f2)),console[_0xf252ad(0x273)]('❌\x20Available\x20webhook\x20fields:',Object[_0xf252ad(0x1bf)](_0x3c0a00));throw new Error(_0xf252ad(0x1fd));}let _0x295735=null;console[_0xf252ad(0x284)](_0xf252ad(0x257)+_0x4ab8b7['paymentId']),_0x295735=await database_1['default'][_0xf252ad(0x2a5)][_0xf252ad(0x1e6)]({'where':{'AND':[{'gateway':_0xf252ad(0x1f5)},{'OR':[{'gatewayPaymentId':_0x4ab8b7[_0xf252ad(0x1ed)]},{'gatewayOrderId':_0x4ab8b7['paymentId']},{'id':_0x4ab8b7[_0xf252ad(0x1ed)]},{'orderId':_0x4ab8b7['paymentId']}]}]}}),console[_0xf252ad(0x284)](_0xf252ad(0x26d)+(_0x295735?_0xf252ad(0x1ec)+_0x295735['id']:_0xf252ad(0x1bc)));if(!_0x295735){console['error']('❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20'+_0x4ab8b7[_0xf252ad(0x1ed)]);return;}console[_0xf252ad(0x284)](_0xf252ad(0x21a)+_0x295735['id']+_0xf252ad(0x221)+_0x4ab8b7[_0xf252ad(0x23d)]),await this[_0xf252ad(0x233)](_0x295735['id'],_0x4ab8b7[_0xf252ad(0x23d)],{'cardLast4':_0x4ab8b7[_0xf252ad(0x211)]?.[_0xf252ad(0x23b)],'paymentMethod':_0x4ab8b7[_0xf252ad(0x211)]?.[_0xf252ad(0x1e0)]});}catch(_0x25b729){console[_0xf252ad(0x273)]('❌\x20Error\x20processing\x20Amer\x20webhook:',_0x25b729),loggerService_1[_0xf252ad(0x1d3)][_0xf252ad(0x203)](_0xf252ad(0x1f5),_0x25b729,_0x3c0a00);throw _0x25b729;}}async[a60_0x4c6952(0x283)](_0x37ec0f,_0x552670){const _0x2fabc1=a60_0x4c6952,_0x62d293=Date[_0x2fabc1(0x24c)]();try{const _0x2b7053=_0x37ec0f[_0x2fabc1(0x28e)],_0x38f909=_0x2b7053['settings'];if(!_0x38f909?.[_0x2fabc1(0x223)]){console[_0x2fabc1(0x284)](_0x2fabc1(0x1db)+_0x2b7053['id']);return;}const _0x11289a=_0x552670==='PAID'?'payment.success':_0x552670===_0x2fabc1(0x24a)?_0x2fabc1(0x229):_0x552670==='EXPIRED'?_0x2fabc1(0x229):_0x552670===_0x2fabc1(0x26e)?_0x2fabc1(0x229):_0x552670===_0x2fabc1(0x204)?_0x2fabc1(0x229):_0x2fabc1(0x26b);let _0x17500a=[];if(_0x38f909[_0x2fabc1(0x28b)])try{_0x17500a=Array[_0x2fabc1(0x1d7)](_0x38f909[_0x2fabc1(0x28b)])?_0x38f909[_0x2fabc1(0x28b)]:JSON[_0x2fabc1(0x289)](_0x38f909[_0x2fabc1(0x28b)]);}catch(_0x20ce8b){console[_0x2fabc1(0x273)](_0x2fabc1(0x1c5),_0x20ce8b),_0x17500a=[];}if(!_0x17500a[_0x2fabc1(0x214)](_0x11289a)){console[_0x2fabc1(0x284)](_0x2fabc1(0x27e)+_0x11289a+_0x2fabc1(0x1d1)+_0x2b7053['id']);return;}const _0x3e04ae={'event':_0x11289a,'payment':{'id':_0x37ec0f['id'],'order_id':_0x37ec0f[_0x2fabc1(0x285)],'gateway_order_id':_0x37ec0f['gatewayOrderId'],'gateway':_0x37ec0f[_0x2fabc1(0x252)],'amount':_0x37ec0f[_0x2fabc1(0x264)],'currency':_0x37ec0f['currency'],'status':_0x552670['toLowerCase'](),'customer_email':_0x37ec0f[_0x2fabc1(0x256)],'customer_name':_0x37ec0f[_0x2fabc1(0x1e1)],'failure_message':_0x37ec0f[_0x2fabc1(0x1c4)],'tx_urls':_0x37ec0f[_0x2fabc1(0x20c)]?JSON[_0x2fabc1(0x289)](_0x37ec0f[_0x2fabc1(0x20c)]):null,'created_at':_0x37ec0f[_0x2fabc1(0x1e5)],'updated_at':_0x37ec0f[_0x2fabc1(0x22b)]}},_0x1e8867=await fetch(_0x38f909[_0x2fabc1(0x223)],{'method':_0x2fabc1(0x287),'headers':{'Content-Type':_0x2fabc1(0x1d6),'User-Agent':_0x2fabc1(0x282)},'body':JSON['stringify'](_0x3e04ae)}),_0x190895=Date[_0x2fabc1(0x24c)]()-_0x62d293,_0x78408a=_0x1e8867['ok']?_0x2fabc1(0x1d2):await _0x1e8867['text']();loggerService_1['loggerService'][_0x2fabc1(0x1ef)](_0x37ec0f[_0x2fabc1(0x29f)],_0x38f909[_0x2fabc1(0x223)],_0x11289a,_0x1e8867[_0x2fabc1(0x23d)],_0x190895,_0x3e04ae),console[_0x2fabc1(0x284)](_0x2fabc1(0x1e4)+_0x38f909[_0x2fabc1(0x223)]+_0x2fabc1(0x207)+_0x1e8867[_0x2fabc1(0x23d)]+'\x20('+_0x190895+'ms)');}catch(_0x2e0364){console[_0x2fabc1(0x273)](_0x2fabc1(0x1c8),_0x2e0364),loggerService_1[_0x2fabc1(0x1d3)][_0x2fabc1(0x248)](_0x37ec0f[_0x2fabc1(0x29f)],_0x37ec0f[_0x2fabc1(0x28e)]?.['settings']?.[_0x2fabc1(0x223)]||_0x2fabc1(0x238),_0x2fabc1(0x1fa),_0x2e0364,{});}}async[a60_0x4c6952(0x1fc)](_0x1df1a0,_0x16c0e2){const _0x355b23=a60_0x4c6952;try{const _0x5b4ee9={'PENDING':_0x355b23(0x24d),'PROCESSING':_0x355b23(0x291),'PAID':_0x355b23(0x2ab),'FAILED':_0x355b23(0x1eb),'EXPIRED':_0x355b23(0x1cf),'REFUND':_0x355b23(0x28f),'CHARGEBACK':_0x355b23(0x232)},_0x5351e4=_0x5b4ee9[_0x16c0e2];if(!_0x5351e4||_0x5351e4===_0x355b23(0x24d))return;await telegramBotService_1[_0x355b23(0x226)][_0x355b23(0x263)](_0x1df1a0[_0x355b23(0x29f)],_0x1df1a0,_0x5351e4);}catch(_0x5ea855){console[_0x355b23(0x273)](_0x355b23(0x21d),_0x5ea855);}}async[a60_0x4c6952(0x20a)](_0x5d6948,_0xcbf87e){const _0x47c867=a60_0x4c6952;try{const _0x24fbdb=await database_1[_0x47c867(0x208)][_0x47c867(0x28e)][_0x47c867(0x23f)]({'where':{'id':_0x5d6948},'select':{'gatewaySettings':!![]}});if(!_0x24fbdb?.[_0x47c867(0x253)])return console['log'](_0x47c867(0x249)+_0x5d6948+_0x47c867(0x267)),0xa;const _0x54c4b3=JSON['parse'](_0x24fbdb[_0x47c867(0x253)]);for(const [_0x517872,_0x5b7e46]of Object[_0x47c867(0x237)](_0x54c4b3)){if(_0x517872[_0x47c867(0x234)]()===_0xcbf87e['toLowerCase']()){const _0x5d2b1a=_0x5b7e46[_0x47c867(0x293)]||0xa;return console[_0x47c867(0x284)](_0x47c867(0x299)+_0xcbf87e+'\x20commission\x20for\x20shop\x20'+_0x5d6948+':\x20'+_0x5d2b1a+'%'),_0x5d2b1a;}}return console[_0x47c867(0x284)](_0x47c867(0x235)+_0xcbf87e+_0x47c867(0x215)+_0x5d6948+_0x47c867(0x250)),0xa;}catch(_0x368172){return console[_0x47c867(0x273)](_0x47c867(0x290)+_0x5d6948+_0x47c867(0x1f0)+_0xcbf87e+':',_0x368172),0xa;}}}exports[a60_0x4c6952(0x298)]=WebhookService;