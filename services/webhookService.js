'use strict';const a66_0x24067e=a66_0x1664;(function(_0x4ea733,_0x498828){const _0x598a77=a66_0x1664,_0x360179=_0x4ea733();while(!![]){try{const _0x28df53=-parseInt(_0x598a77(0x28b))/0x1*(parseInt(_0x598a77(0x2eb))/0x2)+parseInt(_0x598a77(0x31e))/0x3+-parseInt(_0x598a77(0x2cb))/0x4+-parseInt(_0x598a77(0x27d))/0x5+parseInt(_0x598a77(0x21c))/0x6+parseInt(_0x598a77(0x25d))/0x7*(parseInt(_0x598a77(0x26b))/0x8)+parseInt(_0x598a77(0x301))/0x9;if(_0x28df53===_0x498828)break;else _0x360179['push'](_0x360179['shift']());}catch(_0x2c2c06){_0x360179['push'](_0x360179['shift']());}}}(a66_0x1851,0xdc237));var __importDefault=this&&this[a66_0x24067e(0x2a2)]||function(_0x103e4d){return _0x103e4d&&_0x103e4d['__esModule']?_0x103e4d:{'default':_0x103e4d};};function a66_0x1664(_0x47f4cc,_0x11c89b){const _0x1851eb=a66_0x1851();return a66_0x1664=function(_0x1664d3,_0x1cfc3b){_0x1664d3=_0x1664d3-0x1e1;let _0x3a9b20=_0x1851eb[_0x1664d3];return _0x3a9b20;},a66_0x1664(_0x47f4cc,_0x11c89b);}Object[a66_0x24067e(0x2a4)](exports,a66_0x24067e(0x2a8),{'value':!![]}),exports[a66_0x24067e(0x1e9)]=void 0x0;const database_1=__importDefault(require(a66_0x24067e(0x1fe))),plisioService_1=require(a66_0x24067e(0x2d3)),rapydService_1=require(a66_0x24067e(0x25e)),nodaService_1=require(a66_0x24067e(0x28e)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a66_0x24067e(0x25a)),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a66_0x24067e(0x214)),amerService_1=require(a66_0x24067e(0x202)),ampayService_1=require(a66_0x24067e(0x24a)),ampayTRYService_1=require(a66_0x24067e(0x2d6)),telegramBotService_1=require(a66_0x24067e(0x286)),currencyService_1=require(a66_0x24067e(0x2ed)),loggerService_1=require(a66_0x24067e(0x287));class WebhookService{constructor(){const _0x4bb38c=a66_0x24067e;this[_0x4bb38c(0x29b)]=new plisioService_1[(_0x4bb38c(0x1ee))](),this[_0x4bb38c(0x247)]=new rapydService_1[(_0x4bb38c(0x2ef))](),this[_0x4bb38c(0x320)]=new nodaService_1[(_0x4bb38c(0x250))](),this[_0x4bb38c(0x314)]=new coinToPayService_1[(_0x4bb38c(0x2fd))](),this[_0x4bb38c(0x1f6)]=new coinToPay2Service_1['CoinToPay2Service'](),this[_0x4bb38c(0x283)]=new klymeService_1[(_0x4bb38c(0x2e6))](),this[_0x4bb38c(0x2c3)]=new mastercardService_1[(_0x4bb38c(0x246))](),this[_0x4bb38c(0x30d)]=new amerService_1[(_0x4bb38c(0x259))](),this['ampayService']=new ampayService_1[(_0x4bb38c(0x20d))](),this[_0x4bb38c(0x2f2)]=new ampayTRYService_1[(_0x4bb38c(0x20e))]();}async[a66_0x24067e(0x21e)](_0x5bf242,_0x58c203,_0x3d80a0){const _0x3290b7=a66_0x24067e;console[_0x3290b7(0x208)](_0x3290b7(0x216)+_0x5bf242+_0x3290b7(0x22e)+_0x58c203),console[_0x3290b7(0x208)]('🔄\x20Additional\x20data:',_0x3d80a0),await database_1['default'][_0x3290b7(0x28a)](async _0x543acb=>{const _0xa255d9=_0x3290b7,_0x583881=await _0x543acb['payment'][_0xa255d9(0x1f0)]({'where':{'id':_0x5bf242},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x583881)throw new Error('Payment\x20'+_0x5bf242+_0xa255d9(0x230));const _0x3f7c95=_0x583881[_0xa255d9(0x251)],_0x36973b=_0x583881['shop'];console[_0xa255d9(0x208)](_0xa255d9(0x24f)+_0x5bf242+':\x20'+_0x3f7c95+'\x20->\x20'+_0x58c203),console[_0xa255d9(0x208)](_0xa255d9(0x319)+_0x36973b[_0xa255d9(0x215)]+_0xa255d9(0x25f)+_0x36973b[_0xa255d9(0x23d)]+_0xa255d9(0x2f4));const _0x47ad75={'status':_0x58c203[_0xa255d9(0x248)](),'updatedAt':new Date(),'statusChangedBy':_0xa255d9(0x2e2),'statusChangedAt':new Date()};_0x3d80a0?.['failureMessage']&&(_0x47ad75[_0xa255d9(0x2ae)]=_0x3d80a0[_0xa255d9(0x2ae)]);_0x3d80a0?.[_0xa255d9(0x210)]&&(_0x47ad75[_0xa255d9(0x210)]=JSON['stringify'](_0x3d80a0[_0xa255d9(0x210)]));_0x3d80a0?.['cardLast4']&&(_0x47ad75[_0xa255d9(0x24b)]=_0x3d80a0['cardLast4']);_0x3d80a0?.[_0xa255d9(0x26c)]&&(_0x47ad75['paymentMethod']=_0x3d80a0[_0xa255d9(0x26c)]);_0x3d80a0?.['bankId']&&(_0x47ad75[_0xa255d9(0x298)]=_0x3d80a0[_0xa255d9(0x298)]);_0x3d80a0?.['remitterIban']&&(_0x47ad75[_0xa255d9(0x270)]=_0x3d80a0[_0xa255d9(0x270)]);_0x3d80a0?.[_0xa255d9(0x1f9)]&&(_0x47ad75[_0xa255d9(0x1f9)]=_0x3d80a0[_0xa255d9(0x1f9)]);let _0x2ae630=_0x36973b[_0xa255d9(0x23d)],_0x18bd81='';if(_0x58c203[_0xa255d9(0x248)]()===_0xa255d9(0x2a9)&&_0x3f7c95!==_0xa255d9(0x2a9)){const _0x2efa50=await currencyService_1[_0xa255d9(0x326)][_0xa255d9(0x217)](_0x583881['amount'],_0x583881[_0xa255d9(0x297)]),_0x4f9d7e=await this[_0xa255d9(0x1f7)](_0x36973b['id'],_0x583881[_0xa255d9(0x20a)]),_0x4841d6=_0x2efa50*(0x1-_0x4f9d7e/0x64);_0x2ae630+=_0x4841d6,_0x18bd81='+'+_0x4841d6[_0xa255d9(0x313)](0x6)+_0xa255d9(0x200)+_0x4f9d7e+'%\x20gateway\x20commission)',_0x47ad75[_0xa255d9(0x271)]=_0x2efa50,_0x47ad75[_0xa255d9(0x29c)]=_0x4841d6,_0x47ad75[_0xa255d9(0x21b)]=_0x4f9d7e,_0x47ad75['paidAt']=new Date(),console[_0xa255d9(0x208)](_0xa255d9(0x25c)+_0x583881[_0xa255d9(0x27c)]+'\x20'+_0x583881[_0xa255d9(0x297)]+_0xa255d9(0x303)+_0x2efa50[_0xa255d9(0x313)](0x6)+_0xa255d9(0x2f4)),console[_0xa255d9(0x208)](_0xa255d9(0x25b)+_0x583881[_0xa255d9(0x20a)]+_0xa255d9(0x289)+_0x4f9d7e+'%'),console[_0xa255d9(0x208)](_0xa255d9(0x2bd)+_0x4841d6[_0xa255d9(0x313)](0x6)+_0xa255d9(0x2f4)),console[_0xa255d9(0x208)](_0xa255d9(0x1e1)+_0x36973b['balance']+_0xa255d9(0x2aa)+_0x4841d6[_0xa255d9(0x313)](0x6)+_0xa255d9(0x315)+_0x2ae630['toFixed'](0x6)+_0xa255d9(0x2f4));}else{if(_0x3f7c95===_0xa255d9(0x2a9)&&_0x58c203[_0xa255d9(0x248)]()!==_0xa255d9(0x2a9)){let _0x4100bd;if(_0x583881[_0xa255d9(0x29c)])_0x4100bd=_0x583881[_0xa255d9(0x29c)];else{if(_0x583881[_0xa255d9(0x271)]){const _0x4504f2=await this[_0xa255d9(0x1f7)](_0x36973b['id'],_0x583881[_0xa255d9(0x20a)]);_0x4100bd=_0x583881[_0xa255d9(0x271)]*(0x1-_0x4504f2/0x64);}else console[_0xa255d9(0x208)](_0xa255d9(0x312)),_0x4100bd=0x0;}_0x4100bd>0x0&&(_0x2ae630-=_0x4100bd,_0x18bd81='-'+_0x4100bd['toFixed'](0x6)+_0xa255d9(0x329),_0x47ad75[_0xa255d9(0x271)]=null,_0x47ad75[_0xa255d9(0x29c)]=null,_0x47ad75['paidAt']=null,console[_0xa255d9(0x208)](_0xa255d9(0x1ea)+_0x36973b['balance']+_0xa255d9(0x227)+_0x4100bd[_0xa255d9(0x313)](0x6)+_0xa255d9(0x315)+_0x2ae630[_0xa255d9(0x313)](0x6)+_0xa255d9(0x2f4)));}}if(_0x58c203['toUpperCase']()===_0xa255d9(0x275)){const _0x1bd180=_0x3d80a0?.[_0xa255d9(0x2e0)]||0x0;_0x1bd180>0x0&&(_0x2ae630-=_0x1bd180,_0x18bd81+='\x20and\x20-'+_0x1bd180[_0xa255d9(0x313)](0x6)+_0xa255d9(0x324),_0x47ad75[_0xa255d9(0x2e0)]=_0x1bd180,console[_0xa255d9(0x208)]('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0x1bd180[_0xa255d9(0x313)](0x6)+'\x20USDT'),console[_0xa255d9(0x208)](_0xa255d9(0x272)+_0x2ae630[_0xa255d9(0x313)](0x6)+_0xa255d9(0x2f4)));}const _0x3e418c=await _0x543acb[_0xa255d9(0x261)][_0xa255d9(0x2ff)]({'where':{'id':_0x5bf242},'data':_0x47ad75});_0x2ae630!==_0x36973b[_0xa255d9(0x23d)]&&(await _0x543acb[_0xa255d9(0x278)][_0xa255d9(0x2ff)]({'where':{'id':_0x36973b['id']},'data':{'balance':_0x2ae630}}),console[_0xa255d9(0x208)](_0xa255d9(0x2e4)+_0x36973b['username']+_0xa255d9(0x2bb)+_0x36973b[_0xa255d9(0x23d)][_0xa255d9(0x313)](0x6)+_0xa255d9(0x303)+_0x2ae630[_0xa255d9(0x313)](0x6)+_0xa255d9(0x2f4)),console['log'](_0xa255d9(0x308)+_0x18bd81));await _0x543acb[_0xa255d9(0x327)][_0xa255d9(0x26d)]({'data':{'paymentId':_0x5bf242,'shopId':_0x36973b['id'],'event':_0xa255d9(0x201)+_0x58c203['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0xa255d9(0x22c)]({'oldStatus':_0x3f7c95,'newStatus':_0x58c203[_0xa255d9(0x248)](),'balanceChange':_0x18bd81||_0xa255d9(0x299),'oldBalance':_0x36973b[_0xa255d9(0x23d)],'newBalance':_0x2ae630,'amountUSDT':_0x47ad75['amountUSDT'],'additionalData':_0x3d80a0,'timestamp':new Date()[_0xa255d9(0x258)]()})}}),await this['sendShopWebhook']({..._0x583881,..._0x3e418c,'shop':_0x36973b},_0x58c203[_0xa255d9(0x248)]()),await this['sendPaymentStatusNotification']({..._0x583881,..._0x3e418c},_0x58c203[_0xa255d9(0x248)]());if(_0x3f7c95!==_0xa255d9(0x2a9)&&_0x58c203[_0xa255d9(0x248)]()===_0xa255d9(0x2a9)){console[_0xa255d9(0x208)](_0xa255d9(0x2bc)+_0x5bf242+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console['log'](_0xa255d9(0x27b)+_0x3f7c95+_0xa255d9(0x265)+_0x58c203[_0xa255d9(0x248)]()+_0xa255d9(0x322)+_0x583881[_0xa255d9(0x23e)]+'\x22');if(_0x583881['paymentLinkId'])try{const _0x19676e=await _0x543acb['paymentLink'][_0xa255d9(0x1f0)]({'where':{'id':_0x583881[_0xa255d9(0x23e)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x19676e){console['log']('📈\x20Found\x20payment\x20link\x20'+_0x19676e['id']+':\x20type='+_0x19676e['type']+',\x20currentPayments='+_0x19676e[_0xa255d9(0x220)]+_0xa255d9(0x2d1)+_0x19676e['status']);const _0x110882=_0x19676e['currentPayments']+0x1,_0x5558a7=_0x19676e[_0xa255d9(0x284)]===_0xa255d9(0x2b8)?'COMPLETED':_0x19676e[_0xa255d9(0x251)];await _0x543acb[_0xa255d9(0x2ea)][_0xa255d9(0x2ff)]({'where':{'id':_0x583881[_0xa255d9(0x23e)]},'data':{'currentPayments':_0x110882,'status':_0x5558a7,'updatedAt':new Date()}}),console[_0xa255d9(0x208)](_0xa255d9(0x328)+_0x19676e['id']+'\x20updated:\x20currentPayments='+_0x19676e[_0xa255d9(0x220)]+_0xa255d9(0x303)+_0x110882+_0xa255d9(0x2d1)+_0x19676e[_0xa255d9(0x251)]+_0xa255d9(0x303)+_0x5558a7);}else console[_0xa255d9(0x208)](_0xa255d9(0x276)+_0x583881[_0xa255d9(0x23e)]+'\x20not\x20found');}catch(_0x1a91fb){console[_0xa255d9(0x266)](_0xa255d9(0x273),_0x1a91fb);}else console['log'](_0xa255d9(0x2bc)+_0x5bf242+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0xa255d9(0x208)](_0xa255d9(0x2bc)+_0x5bf242+'\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20'+_0x3f7c95+_0xa255d9(0x303)+_0x58c203[_0xa255d9(0x248)]());});}async[a66_0x24067e(0x1e6)](_0x316690){const _0x267d12=a66_0x24067e;console[_0x267d12(0x208)](_0x267d12(0x2fa),_0x316690);try{const _0x1ea628=await this[_0x267d12(0x29b)][_0x267d12(0x225)](_0x316690);if(!_0x1ea628[_0x267d12(0x2e7)])throw new Error(_0x267d12(0x240));const _0x416e3d=await database_1[_0x267d12(0x269)]['payment'][_0x267d12(0x304)]({'where':{'gatewayOrderId':_0x1ea628[_0x267d12(0x2e7)]}});if(!_0x416e3d){console[_0x267d12(0x266)](_0x267d12(0x1eb)+_0x1ea628[_0x267d12(0x2e7)]);return;}console['log']('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0x416e3d['id']+_0x267d12(0x1ed)+_0x1ea628[_0x267d12(0x251)]),await this[_0x267d12(0x21e)](_0x416e3d['id'],_0x1ea628['status'],{'txUrls':_0x1ea628[_0x267d12(0x210)]}),loggerService_1[_0x267d12(0x32b)][_0x267d12(0x32a)](_0x267d12(0x280),_0x416e3d['id'],_0x416e3d['status'],_0x1ea628[_0x267d12(0x251)],_0x316690);}catch(_0x148ad7){console[_0x267d12(0x266)](_0x267d12(0x2a7),_0x148ad7),loggerService_1['loggerService']['logWebhookError']('plisio',_0x148ad7,_0x316690);throw _0x148ad7;}}async[a66_0x24067e(0x27e)](_0x217e7e){const _0x843433=a66_0x24067e;console[_0x843433(0x208)](_0x843433(0x30f),_0x217e7e);try{const _0xcf30a2=await this['plisioService'][_0x843433(0x225)](_0x217e7e);if(!_0xcf30a2[_0x843433(0x2e7)])throw new Error(_0x843433(0x294));const _0x4bf21e=await database_1[_0x843433(0x269)][_0x843433(0x261)][_0x843433(0x304)]({'where':{'gatewayOrderId':_0xcf30a2['paymentId']}});if(!_0x4bf21e){console[_0x843433(0x266)](_0x843433(0x221)+_0xcf30a2['paymentId']);return;}console['log'](_0x843433(0x2fb)+_0x4bf21e['id']+'\x20status\x20'+_0xcf30a2[_0x843433(0x251)]),await this[_0x843433(0x21e)](_0x4bf21e['id'],_0xcf30a2[_0x843433(0x251)],{'txUrls':_0xcf30a2[_0x843433(0x210)]}),loggerService_1['loggerService']['logWebhookProcessed']('plisio_gateway',_0x4bf21e['id'],_0x4bf21e[_0x843433(0x251)],_0xcf30a2[_0x843433(0x251)],_0x217e7e);}catch(_0x26b202){console[_0x843433(0x266)](_0x843433(0x2e3),_0x26b202),loggerService_1[_0x843433(0x32b)][_0x843433(0x219)](_0x843433(0x20b),_0x26b202,_0x217e7e);throw _0x26b202;}}async['processRapydWebhook'](_0x376762){const _0x38acfd=a66_0x24067e;console[_0x38acfd(0x208)](_0x38acfd(0x256),_0x376762);try{const _0x1b83b2=await this[_0x38acfd(0x247)][_0x38acfd(0x225)](_0x376762);if(!_0x1b83b2[_0x38acfd(0x2e7)])throw new Error(_0x38acfd(0x1e2));const _0x1f3cf0=await database_1[_0x38acfd(0x269)][_0x38acfd(0x261)][_0x38acfd(0x304)]({'where':{'gatewayOrderId':_0x1b83b2[_0x38acfd(0x2e7)]}});if(!_0x1f3cf0){console[_0x38acfd(0x266)](_0x38acfd(0x205)+_0x1b83b2[_0x38acfd(0x2e7)]);return;}console[_0x38acfd(0x208)](_0x38acfd(0x2c9)+_0x1f3cf0['id']+_0x38acfd(0x1ed)+_0x1b83b2[_0x38acfd(0x251)]),await this['updatePaymentStatus'](_0x1f3cf0['id'],_0x1b83b2['status'],{'failureMessage':_0x1b83b2[_0x38acfd(0x2ae)],'cardLast4':_0x1b83b2[_0x38acfd(0x2b1)]?.['cardLast4'],'paymentMethod':_0x1b83b2[_0x38acfd(0x2b1)]?.[_0x38acfd(0x26c)]}),loggerService_1['loggerService'][_0x38acfd(0x32a)]('rapyd',_0x1f3cf0['id'],_0x1f3cf0[_0x38acfd(0x251)],_0x1b83b2[_0x38acfd(0x251)],_0x376762);}catch(_0x3a82c8){console[_0x38acfd(0x266)]('Error\x20processing\x20Rapyd\x20webhook:',_0x3a82c8),loggerService_1[_0x38acfd(0x32b)]['logWebhookError'](_0x38acfd(0x235),_0x3a82c8,_0x376762);throw _0x3a82c8;}}async['processNodaWebhook'](_0x473819){const _0x136e02=a66_0x24067e;console[_0x136e02(0x208)](_0x136e02(0x2da),_0x473819);try{const _0x548ee0=await this[_0x136e02(0x320)][_0x136e02(0x225)](_0x473819);if(!_0x548ee0['paymentId'])throw new Error(_0x136e02(0x239));const _0x1128fb=await database_1['default'][_0x136e02(0x261)][_0x136e02(0x304)]({'where':{'gatewayOrderId':_0x548ee0[_0x136e02(0x2e7)]}});if(!_0x1128fb){console[_0x136e02(0x266)](_0x136e02(0x300)+_0x548ee0[_0x136e02(0x2e7)]);return;}console['log'](_0x136e02(0x2cd)+_0x1128fb['id']+_0x136e02(0x1ed)+_0x548ee0[_0x136e02(0x251)]),await this['updatePaymentStatus'](_0x1128fb['id'],_0x548ee0[_0x136e02(0x251)],{'bankId':_0x548ee0[_0x136e02(0x2b1)]?.['bankId'],'remitterIban':_0x548ee0['additionalInfo']?.[_0x136e02(0x270)],'remitterName':_0x548ee0['additionalInfo']?.[_0x136e02(0x1f9)]}),loggerService_1[_0x136e02(0x32b)]['logWebhookProcessed'](_0x136e02(0x2d8),_0x1128fb['id'],_0x1128fb[_0x136e02(0x251)],_0x548ee0[_0x136e02(0x251)],_0x473819);}catch(_0x6de678){console[_0x136e02(0x266)]('Error\x20processing\x20Noda\x20webhook:',_0x6de678),loggerService_1[_0x136e02(0x32b)][_0x136e02(0x219)](_0x136e02(0x2d8),_0x6de678,_0x473819);throw _0x6de678;}}async['processCoinToPayWebhook'](_0xe6bbba){const _0x3b244b=a66_0x24067e;console[_0x3b244b(0x208)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0xe6bbba);try{const _0x54c40d=await this[_0x3b244b(0x314)][_0x3b244b(0x225)](_0xe6bbba);if(!_0x54c40d['paymentId'])throw new Error(_0x3b244b(0x2ee));const _0x3a1028=await database_1[_0x3b244b(0x269)][_0x3b244b(0x261)]['findFirst']({'where':{'gatewayOrderId':_0x54c40d[_0x3b244b(0x2e7)]}});if(!_0x3a1028){console[_0x3b244b(0x266)](_0x3b244b(0x2db)+_0x54c40d[_0x3b244b(0x2e7)]);return;}console[_0x3b244b(0x208)](_0x3b244b(0x2c0)+_0x3a1028['id']+'\x20status\x20'+_0x54c40d[_0x3b244b(0x251)]),await this[_0x3b244b(0x21e)](_0x3a1028['id'],_0x54c40d[_0x3b244b(0x251)]),loggerService_1[_0x3b244b(0x32b)]['logWebhookProcessed'](_0x3b244b(0x2f3),_0x3a1028['id'],_0x3a1028[_0x3b244b(0x251)],_0x54c40d['status'],_0xe6bbba);}catch(_0x3572a3){console['error'](_0x3b244b(0x288),_0x3572a3),loggerService_1['loggerService'][_0x3b244b(0x219)]('cointopay',_0x3572a3,_0xe6bbba);throw _0x3572a3;}}async[a66_0x24067e(0x203)](_0x571c0d){const _0x17f318=a66_0x24067e;console[_0x17f318(0x208)](_0x17f318(0x213),_0x571c0d);try{const _0x4dd54d=await this[_0x17f318(0x1f6)][_0x17f318(0x225)](_0x571c0d);if(!_0x4dd54d['paymentId'])throw new Error(_0x17f318(0x1fc));const _0x557c6b=await database_1[_0x17f318(0x269)][_0x17f318(0x261)]['findFirst']({'where':{'gatewayOrderId':_0x4dd54d['paymentId']}});if(!_0x557c6b){console[_0x17f318(0x266)](_0x17f318(0x2d9)+_0x4dd54d['paymentId']);return;}console[_0x17f318(0x208)]('📊\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x557c6b['id']+_0x17f318(0x1ed)+_0x4dd54d[_0x17f318(0x251)]),await this['updatePaymentStatus'](_0x557c6b['id'],_0x4dd54d['status']),loggerService_1[_0x17f318(0x32b)][_0x17f318(0x32a)]('cointopay2',_0x557c6b['id'],_0x557c6b[_0x17f318(0x251)],_0x4dd54d[_0x17f318(0x251)],_0x571c0d);}catch(_0x318bd2){console[_0x17f318(0x266)](_0x17f318(0x24c),_0x318bd2),loggerService_1[_0x17f318(0x32b)][_0x17f318(0x219)](_0x17f318(0x21f),_0x318bd2,_0x571c0d);throw _0x318bd2;}}async[a66_0x24067e(0x2c4)](_0x5c7b2a){const _0x1314a7=a66_0x24067e;console[_0x1314a7(0x208)]('🔄\x20Processing\x20KLYME\x20webhook:',_0x5c7b2a);try{const _0x14b2ef=await this[_0x1314a7(0x283)][_0x1314a7(0x225)](_0x5c7b2a);if(!_0x14b2ef[_0x1314a7(0x2e7)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x43697a=await database_1[_0x1314a7(0x269)][_0x1314a7(0x261)][_0x1314a7(0x304)]({'where':{'gatewayOrderId':_0x14b2ef['paymentId']}});if(!_0x43697a){console['error'](_0x1314a7(0x2dc)+_0x14b2ef[_0x1314a7(0x2e7)]);return;}console[_0x1314a7(0x208)](_0x1314a7(0x31d)+_0x43697a['id']+'\x20status\x20'+_0x14b2ef[_0x1314a7(0x251)]),await this[_0x1314a7(0x21e)](_0x43697a['id'],_0x14b2ef[_0x1314a7(0x251)],{'paymentMethod':_0x14b2ef[_0x1314a7(0x2b1)]?.['payment_method']}),loggerService_1[_0x1314a7(0x32b)][_0x1314a7(0x32a)](_0x1314a7(0x23b),_0x43697a['id'],_0x43697a['status'],_0x14b2ef[_0x1314a7(0x251)],_0x5c7b2a);}catch(_0x3ff565){console[_0x1314a7(0x266)](_0x1314a7(0x242),_0x3ff565),loggerService_1[_0x1314a7(0x32b)][_0x1314a7(0x219)](_0x1314a7(0x23b),_0x3ff565,_0x5c7b2a);throw _0x3ff565;}}async[a66_0x24067e(0x30b)](_0x19c9b3){const _0x14b795=a66_0x24067e;console[_0x14b795(0x208)](_0x14b795(0x310),JSON[_0x14b795(0x22c)](_0x19c9b3,null,0x2));try{const _0x1fb094=await this[_0x14b795(0x2c3)][_0x14b795(0x225)](_0x19c9b3,'VISA');console['log'](_0x14b795(0x2ba),_0x1fb094);if(!_0x1fb094[_0x14b795(0x2e7)]){console[_0x14b795(0x266)](_0x14b795(0x2e1)),console[_0x14b795(0x266)](_0x14b795(0x2e8),Object['keys'](_0x19c9b3));throw new Error(_0x14b795(0x268));}let _0x53e2b5=null;console['log']('🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x1fb094['paymentId']);if(_0x1fb094[_0x14b795(0x2e7)]){console[_0x14b795(0x208)](_0x14b795(0x1f3)),console[_0x14b795(0x208)](_0x14b795(0x291)),console[_0x14b795(0x208)](_0x14b795(0x1f5)),console[_0x14b795(0x208)]('\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20'+_0x1fb094[_0x14b795(0x2e7)]),console[_0x14b795(0x208)](_0x14b795(0x252)),_0x53e2b5=await database_1[_0x14b795(0x269)][_0x14b795(0x261)][_0x14b795(0x304)]({'where':{'AND':[{'OR':[{'gateway':'visa/mastercard'},{'gateway':_0x14b795(0x2e5)}]},{'OR':[{'gatewayPaymentId':_0x1fb094[_0x14b795(0x2e7)]},{'gatewayOrderId':_0x1fb094['paymentId']},{'id':_0x1fb094[_0x14b795(0x2e7)]},{'orderId':_0x1fb094['paymentId']}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x14b795(0x208)]('🔍\x20VISA\x20payment\x20search\x20executed');if(_0x53e2b5)console[_0x14b795(0x208)](_0x14b795(0x2be)+_0x53e2b5['id']+_0x14b795(0x2c2)+_0x53e2b5[_0x14b795(0x28f)]+_0x14b795(0x29a)+_0x53e2b5[_0x14b795(0x245)]);else{console[_0x14b795(0x208)](_0x14b795(0x309));const _0x407e54=await database_1[_0x14b795(0x269)][_0x14b795(0x261)][_0x14b795(0x23c)]({'where':{'gateway':_0x14b795(0x26e)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':'desc'}});console[_0x14b795(0x208)]('🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:',_0x407e54[_0x14b795(0x26f)](_0x273409=>_0x273409['id']+_0x14b795(0x2fc)+_0x273409[_0x14b795(0x281)]+_0x14b795(0x226)+_0x273409[_0x14b795(0x28f)]+',\x20gatewayPaymentId:\x20'+_0x273409[_0x14b795(0x245)]+_0x14b795(0x2f1)+_0x273409[_0x14b795(0x24b)]+')'));}console['log']('🔍\x20VISA\x20payment\x20search\x20result:\x20'+(_0x53e2b5?_0x14b795(0x1ff):'Not\x20found')),_0x53e2b5&&console[_0x14b795(0x208)](_0x14b795(0x32c)+_0x53e2b5['id']+_0x14b795(0x2b7)+_0x53e2b5[_0x14b795(0x20a)]+_0x14b795(0x2c7)+_0x53e2b5[_0x14b795(0x251)]+_0x14b795(0x222)+_0x53e2b5[_0x14b795(0x24b)]);}if(!_0x53e2b5){console[_0x14b795(0x266)](_0x14b795(0x1fa)+_0x1fb094[_0x14b795(0x2e7)]),loggerService_1[_0x14b795(0x32b)][_0x14b795(0x219)]('visa',new Error('Payment\x20not\x20found:\x20'+_0x1fb094[_0x14b795(0x2e7)]),_0x19c9b3);throw new Error(_0x14b795(0x28c)+_0x1fb094[_0x14b795(0x2e7)]);}console[_0x14b795(0x208)](_0x14b795(0x2cc)+_0x53e2b5['id']+_0x14b795(0x2ab)+_0x53e2b5[_0x14b795(0x251)]+_0x14b795(0x20c)+_0x1fb094[_0x14b795(0x251)]+')');const _0x2cc84b={};_0x1fb094['amount']&&await database_1[_0x14b795(0x269)][_0x14b795(0x261)]['update']({'where':{'id':_0x53e2b5['id']},'data':{'amount':_0x1fb094[_0x14b795(0x27c)],'updatedAt':new Date()}}),_0x1fb094[_0x14b795(0x297)]&&await database_1[_0x14b795(0x269)][_0x14b795(0x261)]['update']({'where':{'id':_0x53e2b5['id']},'data':{'currency':_0x1fb094[_0x14b795(0x297)],'updatedAt':new Date()}}),_0x1fb094[_0x14b795(0x251)]===_0x14b795(0x2ca)&&_0x1fb094[_0x14b795(0x29e)]&&(_0x2cc84b[_0x14b795(0x2ae)]=_0x1fb094[_0x14b795(0x29e)],console[_0x14b795(0x208)](_0x14b795(0x292)+_0x1fb094['errorMessage'])),_0x2cc84b[_0x14b795(0x26c)]=_0x14b795(0x204),await this[_0x14b795(0x21e)](_0x53e2b5['id'],_0x1fb094[_0x14b795(0x251)],_0x2cc84b),await database_1[_0x14b795(0x269)]['webhookLog'][_0x14b795(0x26d)]({'data':{'paymentId':_0x53e2b5['id'],'shopId':_0x53e2b5[_0x14b795(0x238)],'event':'visa_'+_0x1fb094[_0x14b795(0x251)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x14b795(0x22c)](_0x1fb094)}}),await this[_0x14b795(0x257)](_0x53e2b5,_0x1fb094[_0x14b795(0x251)][_0x14b795(0x248)]()),console[_0x14b795(0x208)](_0x14b795(0x2f9)+_0x53e2b5['id']);}catch(_0x5eb3cd){console[_0x14b795(0x266)](_0x14b795(0x2c5),_0x5eb3cd),loggerService_1[_0x14b795(0x32b)]['logWebhookError'](_0x14b795(0x204),_0x5eb3cd,_0x19c9b3);throw _0x5eb3cd;}}async[a66_0x24067e(0x23f)](_0x40b419){const _0x3fd340=a66_0x24067e;console[_0x3fd340(0x208)]('🔄\x20Processing\x20MasterCard\x20webhook:',JSON[_0x3fd340(0x22c)](_0x40b419,null,0x2));try{const _0xb0b394=await this[_0x3fd340(0x2c3)]['processWebhook'](_0x40b419,'MASTERCARD');console['log'](_0x3fd340(0x27f),_0xb0b394);if(!_0xb0b394[_0x3fd340(0x2e7)]){console[_0x3fd340(0x266)](_0x3fd340(0x1e7)),console[_0x3fd340(0x266)](_0x3fd340(0x2e8),Object[_0x3fd340(0x1e5)](_0x40b419));throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');}let _0x453fbe=null;console[_0x3fd340(0x208)](_0x3fd340(0x2bf)+_0xb0b394['paymentId']);_0xb0b394[_0x3fd340(0x2e7)]&&(console['log'](_0x3fd340(0x2ce)),_0x453fbe=await database_1[_0x3fd340(0x269)][_0x3fd340(0x261)][_0x3fd340(0x304)]({'where':{'AND':[{'OR':[{'gateway':_0x3fd340(0x2ec)},{'gateway':_0x3fd340(0x2e5)},{'gateway':_0x3fd340(0x26e)}]},{'OR':[{'gatewayPaymentId':_0xb0b394[_0x3fd340(0x2e7)]},{'gatewayOrderId':_0xb0b394[_0x3fd340(0x2e7)]},{'id':_0xb0b394[_0x3fd340(0x2e7)]},{'orderId':_0xb0b394[_0x3fd340(0x2e7)]}]}]}}),console[_0x3fd340(0x208)](_0x3fd340(0x2c8)+(_0x453fbe?_0x3fd340(0x279)+_0x453fbe['id']:_0x3fd340(0x2f6))));if(!_0x453fbe){console[_0x3fd340(0x266)](_0x3fd340(0x206)+_0xb0b394[_0x3fd340(0x2e7)]),console[_0x3fd340(0x266)](_0x3fd340(0x2de)+_0xb0b394[_0x3fd340(0x2e7)]+_0x3fd340(0x32f)+_0xb0b394[_0x3fd340(0x2e7)]+_0x3fd340(0x2cf)+_0xb0b394[_0x3fd340(0x2e7)]+'\x22');const _0x3b9bf6=await database_1[_0x3fd340(0x269)][_0x3fd340(0x261)][_0x3fd340(0x23c)]({'where':{'OR':[{'gateway':_0x3fd340(0x2e5)},{'gateway':_0x3fd340(0x2ec)},{'gateway':'visa/mastercard'}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x3fd340(0x254)},'take':0xf});console[_0x3fd340(0x208)](_0x3fd340(0x2b0),_0x3b9bf6),loggerService_1[_0x3fd340(0x32b)]['logWebhookError']('mastercard',new Error(_0x3fd340(0x321)+_0xb0b394[_0x3fd340(0x2e7)]),_0x40b419);throw new Error(_0x3fd340(0x212)+_0xb0b394[_0x3fd340(0x2e7)]);}console[_0x3fd340(0x208)](_0x3fd340(0x2a3)+_0x453fbe['id']+_0x3fd340(0x274)+_0x453fbe[_0x3fd340(0x251)]+_0x3fd340(0x31c)+_0xb0b394[_0x3fd340(0x251)]);const _0x3ec891={};_0xb0b394[_0x3fd340(0x27c)]&&await database_1['default'][_0x3fd340(0x261)][_0x3fd340(0x2ff)]({'where':{'id':_0x453fbe['id']},'data':{'amount':_0xb0b394[_0x3fd340(0x27c)],'updatedAt':new Date()}}),_0xb0b394[_0x3fd340(0x297)]&&await database_1[_0x3fd340(0x269)][_0x3fd340(0x261)][_0x3fd340(0x2ff)]({'where':{'id':_0x453fbe['id']},'data':{'currency':_0xb0b394[_0x3fd340(0x297)],'updatedAt':new Date()}}),_0xb0b394[_0x3fd340(0x251)]===_0x3fd340(0x2ca)&&_0xb0b394['errorMessage']&&(_0x3ec891[_0x3fd340(0x2ae)]=_0xb0b394[_0x3fd340(0x29e)],console[_0x3fd340(0x208)](_0x3fd340(0x2b3)+_0xb0b394[_0x3fd340(0x29e)])),_0x3ec891[_0x3fd340(0x26c)]=_0x3fd340(0x2e5),await this[_0x3fd340(0x21e)](_0x453fbe['id'],_0xb0b394[_0x3fd340(0x251)],_0x3ec891),loggerService_1['loggerService'][_0x3fd340(0x32a)]('mastercard',_0x453fbe['id'],_0x453fbe[_0x3fd340(0x251)],_0xb0b394['status'],_0x40b419);}catch(_0x13f499){console[_0x3fd340(0x266)](_0x3fd340(0x231),_0x13f499),loggerService_1['loggerService']['logWebhookError'](_0x3fd340(0x2e5),_0x13f499,_0x40b419);throw _0x13f499;}}async['processAmerWebhook'](_0x2e8a77){const _0x2576b9=a66_0x24067e;console['log'](_0x2576b9(0x2d5),JSON['stringify'](_0x2e8a77,null,0x2));try{const _0x5b2c63=await this['amerService'][_0x2576b9(0x225)](_0x2e8a77);console[_0x2576b9(0x208)](_0x2576b9(0x31f),_0x5b2c63);if(!_0x5b2c63[_0x2576b9(0x2e7)]){console['error'](_0x2576b9(0x229)),console[_0x2576b9(0x266)](_0x2576b9(0x2e8),Object[_0x2576b9(0x1e5)](_0x2e8a77));throw new Error(_0x2576b9(0x285));}let _0x2fe684=null;console[_0x2576b9(0x208)](_0x2576b9(0x2a5)+_0x5b2c63[_0x2576b9(0x2e7)]),_0x2fe684=await database_1[_0x2576b9(0x269)][_0x2576b9(0x261)][_0x2576b9(0x304)]({'where':{'AND':[{'gateway':_0x2576b9(0x262)},{'OR':[{'gatewayPaymentId':_0x5b2c63['paymentId']},{'gatewayOrderId':_0x5b2c63['paymentId']},{'id':_0x5b2c63[_0x2576b9(0x2e7)]},{'orderId':_0x5b2c63[_0x2576b9(0x2e7)]}]}]}}),console[_0x2576b9(0x208)]('🔍\x20Search\x20result:\x20'+(_0x2fe684?_0x2576b9(0x279)+_0x2fe684['id']:_0x2576b9(0x2f6)));if(!_0x2fe684){console[_0x2576b9(0x266)](_0x2576b9(0x311)+_0x5b2c63[_0x2576b9(0x2e7)]);return;}console['log'](_0x2576b9(0x1ef)+_0x2fe684['id']+_0x2576b9(0x1ed)+_0x5b2c63[_0x2576b9(0x251)]),await this[_0x2576b9(0x21e)](_0x2fe684['id'],_0x5b2c63['status'],{'cardLast4':_0x5b2c63[_0x2576b9(0x2b1)]?.[_0x2576b9(0x24b)],'paymentMethod':_0x5b2c63[_0x2576b9(0x2b1)]?.[_0x2576b9(0x26c)]});}catch(_0x4b9345){console[_0x2576b9(0x266)](_0x2576b9(0x2c6),_0x4b9345),loggerService_1[_0x2576b9(0x32b)][_0x2576b9(0x219)]('amer',_0x4b9345,_0x2e8a77);throw _0x4b9345;}}async[a66_0x24067e(0x1e4)](_0x5832b1){const _0x116672=a66_0x24067e;console[_0x116672(0x208)](_0x116672(0x2ac),JSON['stringify'](_0x5832b1,null,0x2));try{const _0x33bdbd=_0x5832b1[_0x116672(0x251)],_0x6120ab=_0x5832b1[_0x116672(0x323)],_0x3e2f57=_0x5832b1['system_id'],_0x3f136b=_0x5832b1[_0x116672(0x316)],_0x561216=_0x5832b1[_0x116672(0x27c)],_0x31af12=_0x5832b1[_0x116672(0x297)],_0x4e49ab=_0x5832b1[_0x116672(0x1f4)],_0x404004=_0x5832b1[_0x116672(0x2a0)];if(!_0x6120ab){console['error'](_0x116672(0x2af));throw new Error(_0x116672(0x302));}console[_0x116672(0x208)](_0x116672(0x1f8),{'status':_0x33bdbd,'clientTransactionId':_0x6120ab,'systemId':_0x3e2f57,'paymentMethod':_0x3f136b,'amount':_0x561216,'currency':_0x31af12,'commission':_0x4e49ab,'statusAdditionInfo':_0x404004});const _0x14cf9e=await database_1[_0x116672(0x269)][_0x116672(0x261)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x6120ab},{'orderId':_0x6120ab},{'id':_0x6120ab},{'gatewayPaymentId':_0x6120ab}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x14cf9e){console[_0x116672(0x266)](_0x116672(0x21a)+_0x6120ab);throw new Error('Payment\x20not\x20found:\x20'+_0x6120ab);}console[_0x116672(0x208)](_0x116672(0x2a3)+_0x14cf9e['id']+_0x116672(0x24e)),console[_0x116672(0x208)](_0x116672(0x32e)+_0x14cf9e[_0x116672(0x251)]+_0x116672(0x20c)+_0x33bdbd),_0x33bdbd==='DECLINED'?(console[_0x116672(0x208)](_0x116672(0x325)),await this[_0x116672(0x21e)](_0x14cf9e['id'],_0x116672(0x2ca)),console['log'](_0x116672(0x1e8)+_0x14cf9e['id']+'\x20status\x20updated\x20to\x20FAILED'),console['log']('ℹ️\x20Decline\x20reason:\x20'+(_0x404004||_0x116672(0x263)))):console['log']('ℹ️\x20AmPay\x20status\x20'+_0x33bdbd+_0x116672(0x244)),await database_1['default'][_0x116672(0x327)][_0x116672(0x26d)]({'data':{'paymentId':_0x14cf9e['id'],'shopId':_0x14cf9e[_0x116672(0x238)],'event':_0x116672(0x20f)+(_0x33bdbd?.['toLowerCase']()||_0x116672(0x27a)),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x5832b1)}}),loggerService_1['loggerService'][_0x116672(0x32a)]('ampay',_0x14cf9e['id'],_0x14cf9e['status'],_0x33bdbd===_0x116672(0x2f8)?_0x116672(0x2ca):_0x33bdbd,_0x5832b1);}catch(_0x36f713){console[_0x116672(0x266)]('❌\x20Error\x20processing\x20AmPay\x20webhook:',_0x36f713),loggerService_1['loggerService'][_0x116672(0x219)](_0x116672(0x22f),_0x36f713,_0x5832b1);throw _0x36f713;}}async[a66_0x24067e(0x255)](_0x5d27c5){const _0x476866=a66_0x24067e;console[_0x476866(0x208)](_0x476866(0x2d2),JSON['stringify'](_0x5d27c5,null,0x2));try{const _0x96b028=_0x5d27c5[_0x476866(0x251)],_0x2d99ef=_0x5d27c5[_0x476866(0x323)],_0x3b337a=_0x5d27c5[_0x476866(0x2f7)],_0x15a8bd=_0x5d27c5[_0x476866(0x316)],_0x216b30=_0x5d27c5[_0x476866(0x27c)],_0x47a57a=_0x5d27c5[_0x476866(0x297)],_0x3f9fd1=_0x5d27c5[_0x476866(0x1f4)],_0x3a89eb=_0x5d27c5[_0x476866(0x2a0)];if(!_0x2d99ef){console[_0x476866(0x266)](_0x476866(0x28d));throw new Error(_0x476866(0x22a));}console[_0x476866(0x208)](_0x476866(0x30c),{'status':_0x96b028,'clientTransactionId':_0x2d99ef,'systemId':_0x3b337a,'paymentMethod':_0x15a8bd,'amount':_0x216b30,'currency':_0x47a57a,'commission':_0x3f9fd1,'statusAdditionInfo':_0x3a89eb});const _0x20c7c4=await database_1[_0x476866(0x269)][_0x476866(0x261)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x2d99ef},{'orderId':_0x2d99ef},{'id':_0x2d99ef},{'gatewayPaymentId':_0x2d99ef}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x20c7c4){console[_0x476866(0x266)](_0x476866(0x282)+_0x2d99ef);throw new Error(_0x476866(0x321)+_0x2d99ef);}console['log']('✅\x20Found\x20payment\x20'+_0x20c7c4['id']+_0x476866(0x232)),console[_0x476866(0x208)](_0x476866(0x32e)+_0x20c7c4[_0x476866(0x251)]+'\x20→\x20'+_0x96b028),_0x96b028==='DECLINED'?(console[_0x476866(0x208)](_0x476866(0x307)),await this[_0x476866(0x21e)](_0x20c7c4['id'],_0x476866(0x2ca)),console[_0x476866(0x208)](_0x476866(0x2d4)+_0x20c7c4['id']+_0x476866(0x2c1)),console[_0x476866(0x208)](_0x476866(0x29d)+(_0x3a89eb||_0x476866(0x263)))):console[_0x476866(0x208)](_0x476866(0x224)+_0x96b028+_0x476866(0x244)),await database_1[_0x476866(0x269)][_0x476866(0x327)]['create']({'data':{'paymentId':_0x20c7c4['id'],'shopId':_0x20c7c4[_0x476866(0x238)],'event':'ampay_try_'+(_0x96b028?.[_0x476866(0x209)]()||_0x476866(0x27a)),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x5d27c5)}}),loggerService_1[_0x476866(0x32b)][_0x476866(0x32a)](_0x476866(0x330),_0x20c7c4['id'],_0x20c7c4['status'],_0x96b028===_0x476866(0x2f8)?'FAILED':_0x96b028,_0x5d27c5);}catch(_0x4fdee0){console[_0x476866(0x266)](_0x476866(0x2d7),_0x4fdee0),loggerService_1['loggerService']['logWebhookError'](_0x476866(0x330),_0x4fdee0,_0x5d27c5);throw _0x4fdee0;}}async[a66_0x24067e(0x26a)](_0x5c4cbd,_0x992443){const _0x5095cd=a66_0x24067e,_0x5b38a1=Date[_0x5095cd(0x260)]();try{const _0x2510df=_0x5c4cbd[_0x5095cd(0x278)],_0x520048=_0x2510df['settings'];if(!_0x520048?.[_0x5095cd(0x21d)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x2510df['id']);return;}const _0x277b19=_0x992443==='PAID'?_0x5095cd(0x2b2):_0x992443===_0x5095cd(0x2ca)?_0x5095cd(0x305):_0x992443==='EXPIRED'?_0x5095cd(0x305):_0x992443===_0x5095cd(0x275)?_0x5095cd(0x305):_0x992443===_0x5095cd(0x290)?'payment.failed':_0x5095cd(0x267);let _0x5fdd3e=[];if(_0x520048['webhookEvents'])try{_0x5fdd3e=Array[_0x5095cd(0x1ec)](_0x520048['webhookEvents'])?_0x520048[_0x5095cd(0x236)]:JSON['parse'](_0x520048['webhookEvents']);}catch(_0x1e7c03){console[_0x5095cd(0x266)](_0x5095cd(0x2b5),_0x1e7c03),_0x5fdd3e=[];}if(!_0x5fdd3e[_0x5095cd(0x2a1)](_0x277b19)){console['log'](_0x5095cd(0x296)+_0x277b19+_0x5095cd(0x1f2)+_0x2510df['id']);return;}const _0x495fca={'event':_0x277b19,'payment':{'id':_0x5c4cbd['id'],'order_id':_0x5c4cbd['orderId'],'gateway_order_id':_0x5c4cbd[_0x5095cd(0x28f)],'gateway':_0x5c4cbd['gateway'],'amount':_0x5c4cbd[_0x5095cd(0x27c)],'currency':_0x5c4cbd[_0x5095cd(0x297)],'status':_0x992443[_0x5095cd(0x209)](),'customer_email':_0x5c4cbd[_0x5095cd(0x2fe)],'customer_name':_0x5c4cbd['customerName'],'failure_message':_0x5c4cbd[_0x5095cd(0x2ae)],'tx_urls':_0x5c4cbd[_0x5095cd(0x210)]?JSON[_0x5095cd(0x234)](_0x5c4cbd[_0x5095cd(0x210)]):null,'created_at':_0x5c4cbd['createdAt'],'updated_at':_0x5c4cbd[_0x5095cd(0x1fb)]}},_0x11e571=await fetch(_0x520048['webhookUrl'],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x5095cd(0x2b9)},'body':JSON[_0x5095cd(0x22c)](_0x495fca)}),_0x5b9274=Date['now']()-_0x5b38a1,_0x540bc9=_0x11e571['ok']?_0x5095cd(0x306):await _0x11e571[_0x5095cd(0x223)]();loggerService_1[_0x5095cd(0x32b)][_0x5095cd(0x249)](_0x5c4cbd[_0x5095cd(0x238)],_0x520048['webhookUrl'],_0x277b19,_0x11e571['status'],_0x5b9274,_0x495fca),console[_0x5095cd(0x208)](_0x5095cd(0x22b)+_0x520048[_0x5095cd(0x21d)]+_0x5095cd(0x23a)+_0x11e571[_0x5095cd(0x251)]+'\x20('+_0x5b9274+_0x5095cd(0x2ad));}catch(_0x1748de){console[_0x5095cd(0x266)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x1748de),loggerService_1[_0x5095cd(0x32b)][_0x5095cd(0x277)](_0x5c4cbd['shopId'],_0x5c4cbd[_0x5095cd(0x278)]?.[_0x5095cd(0x2b6)]?.[_0x5095cd(0x21d)]||_0x5095cd(0x27a),_0x5095cd(0x264),_0x1748de,{});}}async[a66_0x24067e(0x257)](_0x52b739,_0x4650a6){const _0x6f44be=a66_0x24067e;try{const _0x401362={'PENDING':'created','PROCESSING':_0x6f44be(0x233),'PAID':'paid','FAILED':'failed','EXPIRED':_0x6f44be(0x2e9),'REFUND':'refund','CHARGEBACK':_0x6f44be(0x228)},_0x3caf82=_0x401362[_0x4650a6];if(!_0x3caf82||_0x3caf82==='created')return;await telegramBotService_1['telegramBotService'][_0x6f44be(0x24d)](_0x52b739[_0x6f44be(0x238)],_0x52b739,_0x3caf82);}catch(_0x20d34b){console[_0x6f44be(0x266)](_0x6f44be(0x243),_0x20d34b);}}async['getGatewayCommission'](_0x10e9c0,_0x50d398){const _0x3ba90b=a66_0x24067e;try{const _0x5c359f=await database_1['default'][_0x3ba90b(0x278)][_0x3ba90b(0x1f0)]({'where':{'id':_0x10e9c0},'select':{'gatewaySettings':!![]}});if(!_0x5c359f?.[_0x3ba90b(0x211)])return console[_0x3ba90b(0x208)](_0x3ba90b(0x293)+_0x10e9c0+_0x3ba90b(0x29f)),0xa;const _0x1c6994=JSON[_0x3ba90b(0x234)](_0x5c359f[_0x3ba90b(0x211)]);for(const [_0x28097c,_0x1a3525]of Object[_0x3ba90b(0x31b)](_0x1c6994)){if(_0x28097c['toLowerCase']()===_0x50d398[_0x3ba90b(0x209)]()){const _0x2bc385=_0x1a3525[_0x3ba90b(0x1f4)]||0xa;return console[_0x3ba90b(0x208)](_0x3ba90b(0x207)+_0x50d398+_0x3ba90b(0x2f5)+_0x10e9c0+':\x20'+_0x2bc385+'%'),_0x2bc385;}}return console[_0x3ba90b(0x208)](_0x3ba90b(0x2d0)+_0x50d398+'\x20in\x20shop\x20'+_0x10e9c0+_0x3ba90b(0x317)),0xa;}catch(_0x2938a5){return console[_0x3ba90b(0x266)](_0x3ba90b(0x2df)+_0x10e9c0+_0x3ba90b(0x1f1)+_0x50d398+':',_0x2938a5),0xa;}}async[a66_0x24067e(0x31a)](_0xa262c5,_0xc51ce){const _0x45dc2e=a66_0x24067e;console[_0x45dc2e(0x208)](_0x45dc2e(0x32d)),console['log'](_0x45dc2e(0x237),JSON[_0x45dc2e(0x22c)](_0xa262c5,null,0x2)),console[_0x45dc2e(0x208)](_0x45dc2e(0x295),JSON[_0x45dc2e(0x22c)](_0xc51ce,null,0x2));try{const _0x5d63c1=_0xa262c5[_0x45dc2e(0x1e3)]||_0xc51ce[_0x45dc2e(0x1e3)],_0x5dba8b=_0xa262c5[_0x45dc2e(0x251)]||_0xc51ce['status'],_0x74d2e6=_0xa262c5['amount']||_0xc51ce[_0x45dc2e(0x27c)],_0x1d65ed=_0xa262c5[_0x45dc2e(0x297)]||_0xc51ce[_0x45dc2e(0x297)],_0x22711a=_0xa262c5[_0x45dc2e(0x2b4)]||_0xc51ce[_0x45dc2e(0x2b4)];if(!_0x5d63c1){console[_0x45dc2e(0x266)](_0x45dc2e(0x2dd));throw new Error('Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook');}console['log'](_0x45dc2e(0x253),{'customerOrderId':_0x5d63c1,'status':_0x5dba8b,'amount':_0x74d2e6,'currency':_0x1d65ed,'dateTime':_0x22711a});const _0x46eb12=await database_1[_0x45dc2e(0x269)][_0x45dc2e(0x261)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x5d63c1},{'orderId':_0x5d63c1},{'id':_0x5d63c1},{'gatewayPaymentId':_0x5d63c1}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x46eb12){console['error'](_0x45dc2e(0x241)+_0x5d63c1);throw new Error(_0x45dc2e(0x321)+_0x5d63c1);}console[_0x45dc2e(0x208)]('✅\x20Found\x20payment\x20'+_0x46eb12['id']+_0x45dc2e(0x30a)),console[_0x45dc2e(0x208)]('📊\x20Payment\x20status:\x20'+_0x46eb12[_0x45dc2e(0x251)]+_0x45dc2e(0x20c)+_0x5dba8b);let _0x464034=_0x5dba8b?.['toUpperCase']();_0x5dba8b===_0x45dc2e(0x2ca)||_0x5dba8b===_0x45dc2e(0x318)?(_0x464034=_0x45dc2e(0x2ca),console[_0x45dc2e(0x208)](_0x45dc2e(0x2f0)+_0x5dba8b+'\x20mapped\x20to\x20FAILED'),await this['updatePaymentStatus'](_0x46eb12['id'],_0x464034),console[_0x45dc2e(0x208)](_0x45dc2e(0x2a6)+_0x46eb12['id']+_0x45dc2e(0x2c1))):console[_0x45dc2e(0x208)](_0x45dc2e(0x30e)+_0x5dba8b+_0x45dc2e(0x218)),await database_1[_0x45dc2e(0x269)][_0x45dc2e(0x327)][_0x45dc2e(0x26d)]({'data':{'paymentId':_0x46eb12['id'],'shopId':_0x46eb12[_0x45dc2e(0x238)],'event':'myxspend_'+(_0x5dba8b?.[_0x45dc2e(0x209)]()||_0x45dc2e(0x27a)),'statusCode':0xc8,'responseBody':JSON[_0x45dc2e(0x22c)]({'queryParams':_0xa262c5,'bodyData':_0xc51ce})}}),loggerService_1[_0x45dc2e(0x32b)][_0x45dc2e(0x32a)](_0x45dc2e(0x22d),_0x46eb12['id'],_0x46eb12[_0x45dc2e(0x251)],_0x464034||_0x5dba8b,{'queryParams':_0xa262c5,'bodyData':_0xc51ce});}catch(_0x524d5d){console[_0x45dc2e(0x266)](_0x45dc2e(0x1fd),_0x524d5d),loggerService_1[_0x45dc2e(0x32b)][_0x45dc2e(0x219)](_0x45dc2e(0x22d),_0x524d5d,{'queryParams':_0xa262c5,'bodyData':_0xc51ce});throw _0x524d5d;}}}function a66_0x1851(){const _0x14e656=['client_transaction_id','\x20USDT\x20(chargeback\x20penalty)','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','currencyService','webhookLog','✅\x20Payment\x20link\x20','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','logWebhookProcessed','loggerService','🔍\x20Found\x20VISA\x20payment:\x20ID=','🔄\x20Processing\x20MyXSpend\x20webhook:','📊\x20Payment\x20status:\x20','\x22,\x20id=\x22','ampay_try','💰\x20Adding\x20to\x20balance:\x20','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','customerOrderId','processAmPayWebhook','keys','processPlisioWebhook','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20','WebhookService','💰\x20Removing\x20from\x20balance:\x20','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','isArray','\x20status\x20','PlisioService','📊\x20Amer\x20webhook:\x20Payment\x20','findUnique',',\x20gateway\x20','\x20not\x20enabled\x20for\x20shop\x20','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','commission','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','coinToPay2Service','getGatewayCommission','📊\x20AmPay\x20webhook\x20data:','remitterName','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','updatedAt','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','../config/database','Found','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','webhook_status_change_','./gateways/amerService','processCoinToPay2Webhook','visa','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','Gateway\x20','log','toLowerCase','gateway','plisio_gateway','\x20→\x20','AmPayService','AmPayTRYService','ampay_','txUrls','gatewaySettings','MasterCard\x20payment\x20not\x20found:\x20','🔄\x20Processing\x20CoinToPay2\x20webhook:','./gateways/mastercardService','username','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','convertToUSDT','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','logWebhookError','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','gatewayCommissionRate','1886166ecPQmQ','webhookUrl','updatePaymentStatus','cointopay2','currentPayments','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20',',\x20Card=****','text','ℹ️\x20AmPay\x20TRY\x20status\x20','processWebhook',',\x20gatewayOrderId:\x20','\x20-\x20','chargeback','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','📤\x20Shop\x20webhook\x20sent\x20to\x20','stringify','myxspend',',\x20newStatus=','ampay','\x20not\x20found','❌\x20Error\x20processing\x20MasterCard\x20webhook:','\x20for\x20AmPay\x20TRY\x20webhook','processing','parse','rapyd','webhookEvents','Query\x20params:','shopId','No\x20payment\x20ID\x20in\x20Noda\x20webhook','\x20with\x20status\x20','klyme','findMany','balance','paymentLinkId','processMasterCardWebhook','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','Error\x20processing\x20KLYME\x20webhook:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','gatewayPaymentId','VisaMasterCardService','rapydService','toUpperCase','logShopWebhookSent','./gateways/ampayService','cardLast4','Error\x20processing\x20CoinToPay2\x20webhook:','sendPaymentNotification','\x20for\x20AmPay\x20webhook','💰\x20Payment\x20','NodaService','status','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','📊\x20MyXSpend\x20webhook\x20data:','desc','processAmPayTRYWebhook','🔄\x20Processing\x20Rapyd\x20webhook:','sendPaymentStatusNotification','toISOString','AmerService','./gateways/coinToPay2Service','💰\x20Gateway\x20','💰\x20Converting\x20','1575651JTmLwP','./gateways/rapydService','\x20current\x20balance:\x20','now','payment','amer','No\x20additional\x20info','webhook_send','\x22,\x20newStatus=\x22','error','payment.pending','No\x20payment\x20ID\x20in\x20VISA\x20webhook','default','sendShopWebhook','24DsdMtH','paymentMethod','create','visa/mastercard','map','remitterIban','amountUSDT','💰\x20Final\x20balance\x20after\x20chargeback:\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','CHARGEBACK','❌\x20Payment\x20link\x20','logShopWebhookError','shop','Found\x20payment\x20','unknown','📈\x20Payment\x20details:\x20oldStatus=\x22','amount','4976580RkDbrU','processPlisioGatewayWebhook','📊\x20MasterCard\x20webhook\x20result:','plisio','orderId','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20','klymeService','type','No\x20payment\x20ID\x20in\x20Amer\x20webhook','./telegramBotService','./loggerService','Error\x20processing\x20CoinToPay\x20webhook:','\x20commission:\x20','$transaction','190491pXzNKI','VISA\x20payment\x20not\x20found:\x20','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook','./gateways/nodaService','gatewayOrderId','REFUND','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','Body\x20data:','Webhook\x20event\x20','currency','bankId','no\x20balance\x20change',',\x20GatewayPaymentId=','plisioService','amountAfterGatewayCommissionUSDT','ℹ️\x20Decline\x20reason:\x20','errorMessage',',\x20using\x20default\x20commission\x2010%','status_addition_info','includes','__importDefault','✅\x20Found\x20payment\x20','defineProperty','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','Error\x20processing\x20Plisio\x20webhook:','__esModule','PAID','\x20+\x20','\x20(Status:\x20','🔄\x20Processing\x20AmPay\x20webhook:','ms)','failureMessage','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','additionalInfo','payment.success','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','dateTime','Error\x20parsing\x20webhook\x20events:','settings',',\x20Gateway=','SINGLE','Payment\x20System/1.0','📊\x20VISA\x20webhook\x20result:','\x20balance\x20updated:\x20','📈\x20Payment\x20','💰\x20Amount\x20after\x20gateway\x20commission:\x20','✅\x20Found\x20payment:\x20ID=','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','📊\x20CoinToPay\x20webhook:\x20Payment\x20','\x20status\x20updated\x20to\x20FAILED',',\x20GatewayOrderId=','visaMasterCardService','processKlymeWebhook','❌\x20VISA\x20webhook\x20processing\x20failed:','❌\x20Error\x20processing\x20Amer\x20webhook:',',\x20Status=','🔍\x20Search\x20result:\x20','📊\x20Rapyd\x20webhook:\x20Payment\x20','FAILED','6262028GHMDdP','📊\x20VISA\x20payment\x20found:\x20','📊\x20Noda\x20webhook:\x20Payment\x20','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','\x22,\x20orderId=\x22','No\x20specific\x20commission\x20found\x20for\x20gateway\x20',',\x20status=','🔄\x20Processing\x20AmPay\x20TRY\x20webhook:','./gateways/plisioService','✅\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20','🔄\x20Processing\x20Amer\x20webhook:','./gateways/ampayTRYService','❌\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:','noda','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','🔄\x20Processing\x20Noda\x20webhook:','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','chargebackAmount','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','system','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','✅\x20Shop\x20','mastercard','KlymeService','paymentId','❌\x20Available\x20webhook\x20fields:','expired','paymentLink','18rlOUvh','visa_mastercard','./currencyService','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','RapydService','🔄\x20MyXSpend\x20status\x20',',\x20card:\x20****','ampayTRYService','cointopay','\x20USDT','\x20commission\x20for\x20shop\x20','Payment\x20not\x20found','system_id','DECLINED','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','🔄\x20Processing\x20Plisio\x20webhook:','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','\x20(orderId:\x20','CoinToPayService','customerEmail','update','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','31834350SusdHV','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','\x20->\x20','findFirst','payment.failed','Success','🔄\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','📝\x20Reason:\x20','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','\x20for\x20MyXSpend\x20webhook','processVisaWebhook','📊\x20AmPay\x20TRY\x20webhook\x20data:','amerService','ℹ️\x20MyXSpend\x20status\x20','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','🔄\x20Processing\x20VISA\x20webhook:','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','toFixed','coinToPayService','\x20=\x20','payment_method',',\x20using\x20default\x2010%','EXPIRED','🏪\x20Shop\x20','processMyXSpendWebhook','entries','\x20to\x20','📊\x20KLYME\x20webhook:\x20Payment\x20','1950417UrnrQF','📊\x20Amer\x20webhook\x20result:','nodaService','Payment\x20not\x20found:\x20','\x22,\x20paymentLinkId=\x22'];a66_0x1851=function(){return _0x14e656;};return a66_0x1851();}exports['WebhookService']=WebhookService;