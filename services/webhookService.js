'use strict';const a52_0x37dc5e=a52_0x454f;(function(_0x3e6561,_0x4b719c){const _0x53e4d1=a52_0x454f,_0x2245ee=_0x3e6561();while(!![]){try{const _0x2199af=parseInt(_0x53e4d1(0x1c6))/0x1*(parseInt(_0x53e4d1(0x282))/0x2)+-parseInt(_0x53e4d1(0x23a))/0x3+parseInt(_0x53e4d1(0x298))/0x4+parseInt(_0x53e4d1(0x241))/0x5*(-parseInt(_0x53e4d1(0x205))/0x6)+parseInt(_0x53e4d1(0x27b))/0x7+parseInt(_0x53e4d1(0x28c))/0x8*(-parseInt(_0x53e4d1(0x1d6))/0x9)+parseInt(_0x53e4d1(0x1c8))/0xa;if(_0x2199af===_0x4b719c)break;else _0x2245ee['push'](_0x2245ee['shift']());}catch(_0x240045){_0x2245ee['push'](_0x2245ee['shift']());}}}(a52_0x12b8,0xec838));var __importDefault=this&&this[a52_0x37dc5e(0x260)]||function(_0x2a3349){const _0xec37ee=a52_0x37dc5e;return _0x2a3349&&_0x2a3349[_0xec37ee(0x217)]?_0x2a3349:{'default':_0x2a3349};};Object[a52_0x37dc5e(0x1b7)](exports,'__esModule',{'value':!![]}),exports[a52_0x37dc5e(0x20e)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a52_0x37dc5e(0x25f)),rapydService_1=require(a52_0x37dc5e(0x25a)),nodaService_1=require(a52_0x37dc5e(0x20a)),coinToPayService_1=require(a52_0x37dc5e(0x1ee)),klymeService_1=require(a52_0x37dc5e(0x219)),paymentLinkService_1=require(a52_0x37dc5e(0x1e7)),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService'),gateway_1=require(a52_0x37dc5e(0x2a9));function a52_0x12b8(){const _0x3eb070=[',\x20method=','refund','Failed\x20to\x20log\x20CoinToPay\x20webhook\x20error:','pending','noda_',',\x20Settled:\x20','findFirst','\x20marked\x20as\x20paid\x20at:\x20','processNodaWebhook','cardLast4','Processing\x20Plisio\x20gateway\x20webhook:','9502842dfwqon','üè¶\x20Bank\x20ID:\x20','processPlisioGatewayWebhook','ACT','PENDING','./gateways/nodaService','\x20\x20\x20-\x20MerchantPaymentId:\x20','handleSuccessfulPayment','gatewayOrderId','WebhookService','plisio','üîó\x20Sending\x20webhook\x20to\x20shop\x20with\x20gateway\x20ID:\x20','processRapydWebhook','loggerService',',\x20Transaction\x20ID:\x20','customerEmail','created','customerName','__esModule',',\x20Status:\x20','./gateways/klymeService','ERR','klyme_error','Failed\x20to\x20log\x20webhook\x20error:','notificationPaymentFailed','üí≥\x20Extracted\x20card\x20last\x204\x20digits:\x20****','üí≥\x20Payment\x20method:\x20','bankId','CAN','paymentLinkService','pending\x20internal','processCoinToPayWebhook','gateway','processKlymeWebhook','paid','CoinToPay\x20webhook\x20processing\x20error:','Iban','Payment\x20not\x20found\x20for\x20order_id:\x20','logShopWebhookSent','cointopay_error','Payment\x20not\x20found\x20for\x20order_number:\x20','Shop\x20webhook\x20sent\x20to\x20','application/json','successful','payment_method_data','remitterIban',',\x20merchant_reference_id:\x20','\x20(gateway:\x20','üîç\x20Searching\x20for\x20Noda\x20payment:','KlymeService','REFUND','toISOString','FAILED','3907989iYMEin','payment.pending','confirmed','processPlisioWebhook','\x20->\x20','now','Missing\x20required\x20webhook\x20data:\x20PaymentId\x20or\x20MerchantPaymentId','5cRPRtt','üîç\x20Searching\x20for\x20KLYME\x20','\x20in\x20shop\x20settings','completed','EUR','default','\x20details\x20updated:\x20payment_method=','webhookUrl','findUnique','isArray','notificationPayout','text','Processing\x20Plisio\x20webhook:','\x20\x20\x20-\x20OrderId:\x20','webhook_send','Success','update','\x20\x20\x20-\x20gatewayPaymentId:\x20',',\x20payment_method=','Processing\x20Noda\x20webhook:','logWebhookError','rapydService','Failed\x20to\x20log\x20gateway\x20webhook\x20error:','\x20\x20\x20-\x20gatewayOrderId:\x20','processing','./gateways/rapydService','create','canceled','merchant_reference_id','failed','./gateways/plisioService','__importDefault','status','webhookLog','getGatewayIdByName','cointopay_','ms)','Failed\x20to\x20send\x20shop\x20webhook:','üì±\x20Telegram\x20notification\x20disabled\x20for\x20status:\x20',',\x20name=','notificationLogin','new','string','parseWebhookEvents','\x20not\x20enabled\x20for\x20shop\x20','amount','Processing\x20Rapyd\x20webhook:','coinToPayService','\x20details\x20updated:\x20iban=','settings','Gateway\x20webhook\x20processing\x20error:','done','plisio_gateway_','remitterName','NEW','expired','PAYMENT_COMPLETED','‚úÖ\x20Found\x20payment:\x20','5863207Xccrqt','rapyd_error',',\x20GatewayPaymentId:\x20','Failed\x20to\x20log\x20Rapyd\x20webhook\x20error:','EXP','cancelled',',\x20Amount:\x20','2WOwlXy','Missing\x20required\x20webhook\x20data:\x20order_id\x20or\x20gateway_payment_id','Unknown\x20error','nodaService',',\x20Gateway:\x20','Missing\x20required\x20webhook\x20data:\x20txn_id\x20or\x20order_number','PaymentLinkService','\x20status\x20updated\x20from\x20','\x20details\x20updated:\x20card_last4=','rapyd','3761312bMLOMA','shop','klymeService','type','error','üë§\x20Remitter\x20name:\x20','notificationApiError','\x20\x20\x20-\x20id:\x20','Noda\x20webhook\x20processing\x20error:','chargeback','timeout','active','6380064gegMCR','stringify','Processing\x20CoinToPay\x20webhook:','Missing\x20required\x20webhook\x20data:\x20data.id',',\x20MerchantPaymentId:\x20','noda_error','noda','\x20with\x20status\x20',',\x20skipping\x20Telegram\x20notification','includes','plisio_gateway','payment','sendShopWebhook','CoinToPay\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','payment_method_type','parse','Payment\x20','../types/gateway','desc','toUpperCase','waiting','Payment\x20not\x20found\x20for\x20PaymentId:\x20','cointopay','‚úÖ\x20Found\x20KLYME\x20payment:\x20','plisio_gateway_error',',\x20status:\x20','plisio_error','shop_webhook_','üîç\x20Last\x2010\x20payments\x20in\x20database\x20for\x20debugging:','defineProperty','sendNotificationToShop','CLO','paymentMethod','\x20\x20\x20-\x20orderId:\x20','shopId',',\x20Region:\x20','mismatch','findMany','toLowerCase','klyme','üè¶\x20Extracted\x20remitter\x20IBAN:\x20','in_progress','createdAt','\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','619769mJIUeK','rapyd_','12730080nMCXlk','EXPIRED','KLYME\x20webhook\x20processing\x20error:','notificationPaymentSuccess','webhookEvents','\x20status\x20changed\x20to\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20\x20\x20-\x20ID:\x20','CHARGEBACK',',\x20Settlement\x20Date:\x20','shop_webhook_error','Noda\x20webhook\x20processed\x20successfully\x20for\x20payment\x20',',\x20bank=','Remitter:\x20','9MdlNHF','\x20to\x20','shopSettings','paidAt','\x20\x20\x20-\x20PaymentId:\x20','unknown','PAID','üì±\x20Processing\x20Telegram\x20notification\x20for\x20payment\x20','success','üí∞\x20Payment\x20','NodaService','sendPaymentStatusNotification','last4','sendPaymentNotification','üì±\x20No\x20shop\x20settings\x20found\x20for\x20shop\x20','message','updatedAt','./paymentLinkService','orderId','TesSoft\x20Payment\x20System/1.0','\x20(was:\x20','\x20payment:','Status:\x20','Failed\x20to\x20log\x20Noda\x20webhook\x20error:','./gateways/coinToPayService','Payment\x20not\x20found\x20for\x20payment_id:\x20','log',',\x20order_id:\x20','notificationRefund','CoinToPayService','logWebhookProcessed','logWebhookReceived','PAYMENT_FAILED','Webhook\x20processing\x20error:','currency','Notification:\x20Payment\x20'];a52_0x12b8=function(){return _0x3eb070;};return a52_0x12b8();}function a52_0x454f(_0xf9b5d1,_0x58325d){const _0x12b850=a52_0x12b8();return a52_0x454f=function(_0x454f07,_0x46f20f){_0x454f07=_0x454f07-0x1b5;let _0x2b2afc=_0x12b850[_0x454f07];return _0x2b2afc;},a52_0x454f(_0xf9b5d1,_0x58325d);}class WebhookService{constructor(){const _0x50aff6=a52_0x37dc5e;this['plisioService']=new plisioService_1['PlisioService'](),this[_0x50aff6(0x256)]=new rapydService_1['RapydService'](),this[_0x50aff6(0x285)]=new nodaService_1[(_0x50aff6(0x1e0))](),this[_0x50aff6(0x270)]=new coinToPayService_1[(_0x50aff6(0x1f3))](),this[_0x50aff6(0x28e)]=new klymeService_1[(_0x50aff6(0x236))](),this[_0x50aff6(0x222)]=new paymentLinkService_1[(_0x50aff6(0x288))]();}[a52_0x37dc5e(0x26c)](_0xa0a5b4){const _0x3647f8=a52_0x37dc5e;if(!_0xa0a5b4)return[];if(Array[_0x3647f8(0x24a)](_0xa0a5b4))return _0xa0a5b4;if(typeof _0xa0a5b4===_0x3647f8(0x26b))try{const _0x5d0ff4=JSON[_0x3647f8(0x2a7)](_0xa0a5b4);return Array[_0x3647f8(0x24a)](_0x5d0ff4)?_0x5d0ff4:[];}catch{return[];}return[];}async[a52_0x37dc5e(0x23d)](_0x364644){const _0xa8c490=a52_0x37dc5e;try{loggerService_1[_0xa8c490(0x212)][_0xa8c490(0x1f5)](_0xa8c490(0x20f),_0x364644),console[_0xa8c490(0x1f0)](_0xa8c490(0x24d),_0x364644);const {txn_id:_0x297647,order_number:_0x599405,status:_0x71fd33,amount:_0x45047b,currency:_0x5e3dd5}=_0x364644;if(!_0x297647||!_0x599405){const _0x167ff3=new Error('Missing\x20required\x20webhook\x20data:\x20txn_id\x20or\x20order_number');loggerService_1[_0xa8c490(0x212)][_0xa8c490(0x255)](_0xa8c490(0x20f),_0x167ff3,_0x364644);throw _0x167ff3;}const _0x4d341d=await database_1[_0xa8c490(0x246)][_0xa8c490(0x2a3)]['findFirst']({'where':{'OR':[{'gatewayPaymentId':_0x297647},{'orderId':_0x599405}]},'include':{'shop':{'select':{'id':!![],'name':!![]}}}});if(!_0x4d341d){const _0x43703a=new Error('Payment\x20not\x20found\x20for\x20gateway_id:\x20'+_0x297647+_0xa8c490(0x1f1)+_0x599405);loggerService_1[_0xa8c490(0x212)]['logWebhookError'](_0xa8c490(0x20f),_0x43703a,_0x364644);throw _0x43703a;}let _0x5355b2;switch(_0x71fd33){case _0xa8c490(0x244):case _0xa8c490(0x1be):_0x5355b2='PAID';break;case'expired':_0x5355b2='EXPIRED';break;case'error':case'cancelled':_0x5355b2=_0xa8c490(0x239);break;case'new':case _0xa8c490(0x1fd):default:_0x5355b2=_0xa8c490(0x209);break;}const _0x4d4b83={'status':_0x5355b2,'updatedAt':new Date()};_0x5355b2==='PAID'&&_0x4d341d[_0xa8c490(0x261)]!==_0xa8c490(0x1dc)&&(_0x4d4b83[_0xa8c490(0x1d9)]=new Date(),console[_0xa8c490(0x1f0)]('üí∞\x20Payment\x20'+_0x4d341d['id']+_0xa8c490(0x201)+_0x4d4b83[_0xa8c490(0x1d9)][_0xa8c490(0x238)]())),_0x4d341d[_0xa8c490(0x261)]!==_0x5355b2&&(await database_1['default'][_0xa8c490(0x2a3)][_0xa8c490(0x251)]({'where':{'id':_0x4d341d['id']},'data':_0x4d4b83}),console[_0xa8c490(0x1f0)]('Payment\x20'+_0x4d341d['id']+_0xa8c490(0x289)+_0x4d341d[_0xa8c490(0x261)]+_0xa8c490(0x1d7)+_0x5355b2),loggerService_1[_0xa8c490(0x212)]['logWebhookProcessed'](_0xa8c490(0x20f),_0x4d341d['id'],_0x4d341d[_0xa8c490(0x261)],_0x5355b2,_0x364644),_0x5355b2===_0xa8c490(0x1dc)&&await this[_0xa8c490(0x222)][_0xa8c490(0x20c)](_0x4d341d['id']),await this[_0xa8c490(0x1e1)](_0x4d341d,_0x5355b2)),await database_1[_0xa8c490(0x246)]['webhookLog'][_0xa8c490(0x25b)]({'data':{'paymentId':_0x4d341d['id'],'shopId':_0x4d341d[_0xa8c490(0x1bc)],'event':'plisio_'+_0x71fd33,'statusCode':0xc8,'responseBody':JSON[_0xa8c490(0x299)](_0x364644)}});}catch(_0x1a811c){console[_0xa8c490(0x290)](_0xa8c490(0x1f7),_0x1a811c),loggerService_1[_0xa8c490(0x212)][_0xa8c490(0x255)]('plisio',_0x1a811c,_0x364644);try{await database_1[_0xa8c490(0x246)][_0xa8c490(0x262)][_0xa8c490(0x25b)]({'data':{'paymentId':_0xa8c490(0x1db),'shopId':'unknown','event':_0xa8c490(0x2b2),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x1a811c instanceof Error?_0x1a811c[_0xa8c490(0x1e5)]:'Unknown\x20error','webhookData':_0x364644})}});}catch(_0x4746ff){console[_0xa8c490(0x290)](_0xa8c490(0x21c),_0x4746ff);}throw _0x1a811c;}}async[a52_0x37dc5e(0x207)](_0x1ac53c){const _0x2b35a9=a52_0x37dc5e;try{loggerService_1['loggerService'][_0x2b35a9(0x1f5)](_0x2b35a9(0x2a2),_0x1ac53c),console[_0x2b35a9(0x1f0)](_0x2b35a9(0x204),_0x1ac53c);const {txn_id:_0x5e83e5,order_number:_0x117300,status:_0x18f6b6,amount:_0x5e468e,currency:_0x52e9fa,source_currency:_0x3d5a28,source_amount:_0x328dff,invoice_total_sum:_0x4ff3c5,invoice_commission:_0x4eee86,invoice_sum:_0x2e0798,confirmations:_0x1e4355,verify_hash:_0x109649,merchant:_0x333886,merchant_id:_0xb3bb80,ipn_type:_0x3f7c96,order_name:_0x3e0306,comment:_0x4ad904}=_0x1ac53c;if(!_0x5e83e5||!_0x117300){const _0xd3ac04=new Error(_0x2b35a9(0x287));loggerService_1[_0x2b35a9(0x212)][_0x2b35a9(0x255)](_0x2b35a9(0x2a2),_0xd3ac04,_0x1ac53c);throw _0xd3ac04;}const _0x21eed8=await database_1[_0x2b35a9(0x246)][_0x2b35a9(0x2a3)][_0x2b35a9(0x200)]({'where':{'OR':[{'id':_0x117300},{'gatewayPaymentId':_0x5e83e5},{'gatewayOrderId':_0x117300}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x21eed8){const _0x4301fc=new Error(_0x2b35a9(0x22d)+_0x117300+',\x20txn_id:\x20'+_0x5e83e5);loggerService_1[_0x2b35a9(0x212)]['logWebhookError']('plisio_gateway',_0x4301fc,_0x1ac53c);throw _0x4301fc;}let _0x5ad5a0;switch(_0x18f6b6?.['toLowerCase']()){case _0x2b35a9(0x244):case'mismatch':_0x5ad5a0=_0x2b35a9(0x1dc);break;case _0x2b35a9(0x278):_0x5ad5a0='EXPIRED';break;case'error':case _0x2b35a9(0x280):_0x5ad5a0=_0x2b35a9(0x239);break;case _0x2b35a9(0x26a):case _0x2b35a9(0x1fd):case _0x2b35a9(0x223):default:_0x5ad5a0=_0x2b35a9(0x209);break;}const _0x4be105={'status':_0x5ad5a0,'updatedAt':new Date()};_0x5ad5a0===_0x2b35a9(0x1dc)&&_0x21eed8[_0x2b35a9(0x261)]!==_0x2b35a9(0x1dc)&&(_0x4be105[_0x2b35a9(0x1d9)]=new Date(),console['log'](_0x2b35a9(0x1df)+_0x21eed8['id']+_0x2b35a9(0x201)+_0x4be105['paidAt']['toISOString']())),_0x21eed8['status']!==_0x5ad5a0&&(await database_1[_0x2b35a9(0x246)][_0x2b35a9(0x2a3)]['update']({'where':{'id':_0x21eed8['id']},'data':_0x4be105}),console['log'](_0x2b35a9(0x2a8)+_0x21eed8['id']+'\x20status\x20updated\x20from\x20'+_0x21eed8[_0x2b35a9(0x261)]+'\x20to\x20'+_0x5ad5a0),loggerService_1['loggerService'][_0x2b35a9(0x1f4)](_0x2b35a9(0x2a2),_0x21eed8['id'],_0x21eed8['status'],_0x5ad5a0,_0x1ac53c),_0x5ad5a0===_0x2b35a9(0x1dc)&&await this[_0x2b35a9(0x222)][_0x2b35a9(0x20c)](_0x21eed8['id']),await this['sendShopWebhook'](_0x21eed8,_0x5ad5a0,_0x1ac53c),await this['sendPaymentStatusNotification'](_0x21eed8,_0x5ad5a0)),await database_1[_0x2b35a9(0x246)][_0x2b35a9(0x262)][_0x2b35a9(0x25b)]({'data':{'paymentId':_0x21eed8['id'],'shopId':_0x21eed8[_0x2b35a9(0x1bc)],'event':_0x2b35a9(0x275)+_0x18f6b6,'statusCode':0xc8,'responseBody':JSON[_0x2b35a9(0x299)](_0x1ac53c)}});}catch(_0x3d429b){console[_0x2b35a9(0x290)](_0x2b35a9(0x273),_0x3d429b),loggerService_1['loggerService'][_0x2b35a9(0x255)]('plisio_gateway',_0x3d429b,_0x1ac53c);try{await database_1[_0x2b35a9(0x246)][_0x2b35a9(0x262)][_0x2b35a9(0x25b)]({'data':{'paymentId':_0x2b35a9(0x1db),'shopId':_0x2b35a9(0x1db),'event':_0x2b35a9(0x2b0),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x3d429b instanceof Error?_0x3d429b[_0x2b35a9(0x1e5)]:_0x2b35a9(0x284),'webhookData':_0x1ac53c})}});}catch(_0x51e2b5){console[_0x2b35a9(0x290)](_0x2b35a9(0x257),_0x51e2b5);}throw _0x3d429b;}}async[a52_0x37dc5e(0x211)](_0x159ef4){const _0x336c7a=a52_0x37dc5e;try{loggerService_1[_0x336c7a(0x212)][_0x336c7a(0x1f5)]('rapyd',_0x159ef4),console[_0x336c7a(0x1f0)](_0x336c7a(0x26f),_0x159ef4);const {id:_0x2657d3,type:_0x1df5a3,data:_0x27c763,created_at:_0x264cf3}=_0x159ef4;if(!_0x27c763?.['id']){const _0x405922=new Error(_0x336c7a(0x29b));loggerService_1[_0x336c7a(0x212)]['logWebhookError'](_0x336c7a(0x28b),_0x405922,_0x159ef4);throw _0x405922;}const _0xf7deac=_0x27c763['id'],_0x428abe=_0x27c763[_0x336c7a(0x25d)],_0x324eeb=await database_1['default']['payment']['findFirst']({'where':{'OR':[{'gatewayPaymentId':_0xf7deac},{'id':_0x428abe},{'gatewayOrderId':_0x428abe}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x324eeb){const _0x5706e5=new Error('Payment\x20not\x20found\x20for\x20gateway_id:\x20'+_0xf7deac+_0x336c7a(0x233)+_0x428abe);loggerService_1['loggerService'][_0x336c7a(0x255)]('rapyd',_0x5706e5,_0x159ef4);throw _0x5706e5;}let _0x2926a6=null,_0x2ff647=null;_0x27c763[_0x336c7a(0x231)]&&(_0x2926a6=_0x27c763[_0x336c7a(0x231)][_0x336c7a(0x1e2)]||null,_0x2ff647=_0x27c763[_0x336c7a(0x231)][_0x336c7a(0x28f)]||_0x27c763[_0x336c7a(0x2a6)]||null);let _0x246090;switch(_0x1df5a3?.[_0x336c7a(0x2ab)]()){case _0x336c7a(0x279):_0x27c763['paid']===!![]&&_0x27c763[_0x336c7a(0x261)]===_0x336c7a(0x1b9)?_0x246090=_0x336c7a(0x1dc):_0x246090=_0x336c7a(0x209);break;case'PAYMENT_CANCELED':_0x246090=_0x336c7a(0x239);break;case'PAYMENT_EXPIRED':_0x246090=_0x336c7a(0x1c9);break;case _0x336c7a(0x1f6):_0x246090=_0x336c7a(0x239);break;default:switch(_0x27c763['status']?.[_0x336c7a(0x2ab)]()){case _0x336c7a(0x1b9):_0x27c763['paid']===!![]?_0x246090=_0x336c7a(0x1dc):_0x246090=_0x336c7a(0x239);break;case _0x336c7a(0x221):_0x246090=_0x336c7a(0x239);break;case _0x336c7a(0x27f):_0x246090=_0x336c7a(0x1c9);break;case _0x336c7a(0x21a):_0x246090='FAILED';break;case _0x336c7a(0x277):case _0x336c7a(0x208):default:_0x246090=_0x336c7a(0x209);break;}break;}const _0x5f533d={'status':_0x246090,'updatedAt':new Date()};_0x2926a6&&(_0x5f533d[_0x336c7a(0x203)]=_0x2926a6,console[_0x336c7a(0x1f0)](_0x336c7a(0x21e)+_0x2926a6)),_0x2ff647&&(_0x5f533d[_0x336c7a(0x1ba)]=_0x2ff647,console['log']('üí≥\x20Payment\x20method:\x20'+_0x2ff647)),_0x246090==='PAID'&&_0x324eeb[_0x336c7a(0x261)]!==_0x336c7a(0x1dc)&&(_0x5f533d[_0x336c7a(0x1d9)]=new Date(),console[_0x336c7a(0x1f0)](_0x336c7a(0x1df)+_0x324eeb['id']+_0x336c7a(0x201)+_0x5f533d[_0x336c7a(0x1d9)][_0x336c7a(0x238)]())),(_0x324eeb['status']!==_0x246090||_0x2926a6||_0x2ff647)&&(await database_1['default']['payment'][_0x336c7a(0x251)]({'where':{'id':_0x324eeb['id']},'data':_0x5f533d}),_0x324eeb[_0x336c7a(0x261)]!==_0x246090&&(console['log'](_0x336c7a(0x2a8)+_0x324eeb['id']+_0x336c7a(0x289)+_0x324eeb[_0x336c7a(0x261)]+_0x336c7a(0x1d7)+_0x246090),loggerService_1[_0x336c7a(0x212)][_0x336c7a(0x1f4)](_0x336c7a(0x28b),_0x324eeb['id'],_0x324eeb['status'],_0x246090,_0x159ef4),_0x246090===_0x336c7a(0x1dc)&&await this[_0x336c7a(0x222)][_0x336c7a(0x20c)](_0x324eeb['id']),await this[_0x336c7a(0x2a4)](_0x324eeb,_0x246090,_0x159ef4),await this[_0x336c7a(0x1e1)](_0x324eeb,_0x246090)),(_0x2926a6||_0x2ff647)&&console['log']('Payment\x20'+_0x324eeb['id']+_0x336c7a(0x28a)+_0x2926a6+_0x336c7a(0x253)+_0x2ff647)),await database_1['default']['webhookLog'][_0x336c7a(0x25b)]({'data':{'paymentId':_0x324eeb['id'],'shopId':_0x324eeb[_0x336c7a(0x1bc)],'event':_0x336c7a(0x1c7)+_0x1df5a3,'statusCode':0xc8,'responseBody':JSON[_0x336c7a(0x299)](_0x159ef4)}});}catch(_0x9187e8){console['error']('Rapyd\x20webhook\x20processing\x20error:',_0x9187e8),loggerService_1[_0x336c7a(0x212)][_0x336c7a(0x255)](_0x336c7a(0x28b),_0x9187e8,_0x159ef4);try{await database_1['default'][_0x336c7a(0x262)][_0x336c7a(0x25b)]({'data':{'paymentId':'unknown','shopId':_0x336c7a(0x1db),'event':_0x336c7a(0x27c),'statusCode':0x1f4,'responseBody':JSON[_0x336c7a(0x299)]({'error':_0x9187e8 instanceof Error?_0x9187e8[_0x336c7a(0x1e5)]:_0x336c7a(0x284),'webhookData':_0x159ef4})}});}catch(_0x4a6679){console[_0x336c7a(0x290)](_0x336c7a(0x27e),_0x4a6679);}throw _0x9187e8;}}async[a52_0x37dc5e(0x202)](_0x259e03){const _0x4dde73=a52_0x37dc5e;try{loggerService_1[_0x4dde73(0x212)][_0x4dde73(0x1f5)]('noda',_0x259e03),console['log'](_0x4dde73(0x254),_0x259e03);const {PaymentId:_0x3d6c6f,Status:_0x2b1998,Signature:_0x3f2a8b,MerchantPaymentId:_0x831516,Reference:_0x2d560a,Amount:_0x4292fc,Currency:_0x3aa1a3,CardId:_0x1c8ca9,Remitter:_0x20e402,AdditionalData:_0x1d7039,DetailedInfo:_0x2f3190,Method:_0x10a3cb,BankId:_0x5916a8,IsSenderBank:_0x3caab9,BankTransactionId:_0x1c6c16,Settled:_0x152497,SettlementDate:_0x3a3817}=_0x259e03;if(!_0x3d6c6f&&!_0x831516){const _0x30603e=new Error(_0x4dde73(0x240));loggerService_1[_0x4dde73(0x212)][_0x4dde73(0x255)](_0x4dde73(0x29e),_0x30603e,_0x259e03);throw _0x30603e;}console[_0x4dde73(0x1f0)](_0x4dde73(0x235)),console['log'](_0x4dde73(0x1da)+_0x3d6c6f),console[_0x4dde73(0x1f0)](_0x4dde73(0x20b)+_0x831516);const _0x329fc7=await database_1[_0x4dde73(0x246)]['payment'][_0x4dde73(0x200)]({'where':{'OR':[{'gatewayPaymentId':_0x3d6c6f},{'id':_0x831516},{'gatewayOrderId':_0x831516},{'orderId':_0x831516}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x329fc7){console['log']('‚ùå\x20Payment\x20not\x20found\x20with\x20any\x20of\x20the\x20following\x20criteria:'),console[_0x4dde73(0x1f0)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x3d6c6f),console[_0x4dde73(0x1f0)]('\x20\x20\x20-\x20id:\x20'+_0x831516),console[_0x4dde73(0x1f0)]('\x20\x20\x20-\x20gatewayOrderId:\x20'+_0x831516),console[_0x4dde73(0x1f0)](_0x4dde73(0x1bb)+_0x831516);const _0x10dfb0=await database_1[_0x4dde73(0x246)][_0x4dde73(0x2a3)][_0x4dde73(0x1bf)]({'select':{'id':!![],'gatewayPaymentId':!![],'gatewayOrderId':!![],'orderId':!![],'gateway':!![],'status':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x4dde73(0x2aa)},'take':0xa});console[_0x4dde73(0x1f0)](_0x4dde73(0x1b6)),_0x10dfb0['forEach'](_0x51710f=>{const _0x5b03da=_0x4dde73;console[_0x5b03da(0x1f0)](_0x5b03da(0x1cf)+_0x51710f['id']+_0x5b03da(0x286)+_0x51710f[_0x5b03da(0x225)]+_0x5b03da(0x27d)+_0x51710f['gatewayPaymentId']+',\x20GatewayOrderId:\x20'+_0x51710f[_0x5b03da(0x20d)]+',\x20OrderId:\x20'+_0x51710f[_0x5b03da(0x1e8)]+_0x5b03da(0x218)+_0x51710f[_0x5b03da(0x261)]);});const _0x194a38=new Error(_0x4dde73(0x2ad)+_0x3d6c6f+_0x4dde73(0x29c)+_0x831516);loggerService_1[_0x4dde73(0x212)][_0x4dde73(0x255)](_0x4dde73(0x29e),_0x194a38,_0x259e03);throw _0x194a38;}console[_0x4dde73(0x1f0)](_0x4dde73(0x27a)+_0x329fc7['id']+'\x20(gateway:\x20'+_0x329fc7[_0x4dde73(0x225)]+')'),console[_0x4dde73(0x1f0)](_0x4dde73(0x252)+_0x329fc7['gatewayPaymentId']),console[_0x4dde73(0x1f0)](_0x4dde73(0x258)+_0x329fc7[_0x4dde73(0x20d)]),console[_0x4dde73(0x1f0)](_0x4dde73(0x1bb)+_0x329fc7['orderId']);let _0x55e784=null,_0x20a04c=null;_0x20e402&&(_0x55e784=_0x20e402['Iban']||null,_0x20a04c=_0x20e402['Name']||null);let _0x55be55;switch(_0x2b1998?.[_0x4dde73(0x1c0)]()){case _0x4dde73(0x274):case _0x4dde73(0x244):case'paid':case _0x4dde73(0x1de):case _0x4dde73(0x230):_0x152497==='Yes'||_0x152497===!![]?_0x55be55=_0x4dde73(0x1dc):_0x55be55=_0x4dde73(0x209);break;case _0x4dde73(0x280):case _0x4dde73(0x25c):case _0x4dde73(0x25e):case _0x4dde73(0x290):case'rejected':_0x55be55=_0x4dde73(0x239);break;case _0x4dde73(0x278):case'timeout':_0x55be55=_0x4dde73(0x1c9);break;case'pending':case _0x4dde73(0x215):case _0x4dde73(0x297):case _0x4dde73(0x259):case'in_progress':default:_0x55be55=_0x4dde73(0x209);break;}const _0x1e2a52={'status':_0x55be55,'updatedAt':new Date()};_0x55e784&&(_0x1e2a52[_0x4dde73(0x232)]=_0x55e784,console[_0x4dde73(0x1f0)](_0x4dde73(0x1c2)+_0x55e784)),_0x20a04c&&(_0x1e2a52[_0x4dde73(0x276)]=_0x20a04c,console['log'](_0x4dde73(0x291)+_0x20a04c)),_0x5916a8&&(_0x1e2a52['bankId']=_0x5916a8,console[_0x4dde73(0x1f0)](_0x4dde73(0x206)+_0x5916a8)),_0x10a3cb&&(_0x1e2a52['paymentMethod']=_0x10a3cb,console['log'](_0x4dde73(0x21f)+_0x10a3cb)),_0x55be55===_0x4dde73(0x1dc)&&_0x329fc7[_0x4dde73(0x261)]!==_0x4dde73(0x1dc)&&(_0x1e2a52[_0x4dde73(0x1d9)]=new Date(),console['log'](_0x4dde73(0x1df)+_0x329fc7['id']+_0x4dde73(0x201)+_0x1e2a52['paidAt']['toISOString']())),(_0x329fc7[_0x4dde73(0x261)]!==_0x55be55||_0x55e784||_0x20a04c||_0x5916a8||_0x10a3cb)&&(await database_1[_0x4dde73(0x246)]['payment'][_0x4dde73(0x251)]({'where':{'id':_0x329fc7['id']},'data':_0x1e2a52}),_0x329fc7[_0x4dde73(0x261)]!==_0x55be55&&(console['log'](_0x4dde73(0x2a8)+_0x329fc7['id']+_0x4dde73(0x289)+_0x329fc7[_0x4dde73(0x261)]+'\x20to\x20'+_0x55be55),loggerService_1['loggerService']['logWebhookProcessed'](_0x4dde73(0x29e),_0x329fc7['id'],_0x329fc7[_0x4dde73(0x261)],_0x55be55,_0x259e03),_0x55be55===_0x4dde73(0x1dc)&&await this[_0x4dde73(0x222)]['handleSuccessfulPayment'](_0x329fc7['id']),await this[_0x4dde73(0x2a4)](_0x329fc7,_0x55be55,_0x259e03),await this[_0x4dde73(0x1e1)](_0x329fc7,_0x55be55)),(_0x55e784||_0x20a04c||_0x5916a8||_0x10a3cb)&&console['log'](_0x4dde73(0x2a8)+_0x329fc7['id']+_0x4dde73(0x271)+_0x55e784+_0x4dde73(0x268)+_0x20a04c+_0x4dde73(0x1d4)+_0x5916a8+_0x4dde73(0x1fa)+_0x10a3cb)),await database_1[_0x4dde73(0x246)]['webhookLog']['create']({'data':{'paymentId':_0x329fc7['id'],'shopId':_0x329fc7[_0x4dde73(0x1bc)],'event':_0x4dde73(0x1fe)+_0x2b1998,'statusCode':0xc8,'responseBody':JSON[_0x4dde73(0x299)]({..._0x259e03,'parsed':{'nodaPaymentId':_0x3d6c6f,'merchantPaymentId':_0x831516,'status':_0x2b1998,'amount':_0x4292fc,'currency':_0x3aa1a3,'method':_0x10a3cb,'bankId':_0x5916a8,'settled':_0x152497,'settlementDate':_0x3a3817,'remitterName':_0x20e402?.['Name'],'remitterIban':_0x20e402?.[_0x4dde73(0x229)]}})}}),console[_0x4dde73(0x1f0)](_0x4dde73(0x1d3)+_0x329fc7['id']),console['log'](_0x4dde73(0x1ec)+_0x2b1998+'\x20->\x20'+_0x55be55+_0x4dde73(0x281)+_0x4292fc+'\x20'+_0x3aa1a3+',\x20Method:\x20'+_0x10a3cb),console[_0x4dde73(0x1f0)]('Bank:\x20'+_0x5916a8+_0x4dde73(0x1ff)+_0x152497+_0x4dde73(0x1d1)+_0x3a3817),console[_0x4dde73(0x1f0)](_0x4dde73(0x1d5)+_0x20a04c+'\x20('+_0x55e784+')');}catch(_0x348149){console[_0x4dde73(0x290)](_0x4dde73(0x294),_0x348149),loggerService_1['loggerService'][_0x4dde73(0x255)](_0x4dde73(0x29e),_0x348149,_0x259e03);try{await database_1[_0x4dde73(0x246)]['webhookLog'][_0x4dde73(0x25b)]({'data':{'paymentId':_0x4dde73(0x1db),'shopId':_0x4dde73(0x1db),'event':_0x4dde73(0x29d),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x348149 instanceof Error?_0x348149[_0x4dde73(0x1e5)]:_0x4dde73(0x284),'webhookData':_0x259e03})}});}catch(_0x3ff045){console[_0x4dde73(0x290)](_0x4dde73(0x1ed),_0x3ff045);}throw _0x348149;}}async[a52_0x37dc5e(0x224)](_0x339d2e){const _0x36794e=a52_0x37dc5e;try{loggerService_1[_0x36794e(0x212)][_0x36794e(0x1f5)](_0x36794e(0x2ae),_0x339d2e),console[_0x36794e(0x1f0)](_0x36794e(0x29a),_0x339d2e);const {order_id:_0x5dd303,gateway_payment_id:_0x59bf73,status:_0xdf2d5c,amount:_0x18466e,currency:_0x20774d,transaction_id:_0xf4a247,confirmation_count:_0x5d7e66}=_0x339d2e;if(!_0x5dd303&&!_0x59bf73){const _0x2b9a9e=new Error(_0x36794e(0x283));loggerService_1['loggerService']['logWebhookError']('cointopay',_0x2b9a9e,_0x339d2e);throw _0x2b9a9e;}const _0x1d44b5=await database_1[_0x36794e(0x246)]['payment'][_0x36794e(0x200)]({'where':{'OR':[{'gatewayPaymentId':_0x59bf73},{'id':_0x5dd303},{'gatewayOrderId':_0x5dd303},{'orderId':_0x5dd303}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1d44b5){const _0x459dac=new Error(_0x36794e(0x22a)+_0x5dd303+',\x20gateway_payment_id:\x20'+_0x59bf73);loggerService_1[_0x36794e(0x212)][_0x36794e(0x255)]('cointopay',_0x459dac,_0x339d2e);throw _0x459dac;}let _0xf5f503;switch(_0xdf2d5c?.[_0x36794e(0x1c0)]()){case _0x36794e(0x227):case _0x36794e(0x244):case _0x36794e(0x23c):_0xf5f503=_0x36794e(0x1dc);break;case _0x36794e(0x280):case _0x36794e(0x25e):case'error':_0xf5f503=_0x36794e(0x239);break;case _0x36794e(0x278):case _0x36794e(0x296):_0xf5f503=_0x36794e(0x1c9);break;case _0x36794e(0x1fd):case _0x36794e(0x2ac):case _0x36794e(0x215):default:_0xf5f503=_0x36794e(0x209);break;}const _0x5d87b5={'status':_0xf5f503,'updatedAt':new Date()};_0xf5f503===_0x36794e(0x1dc)&&_0x1d44b5[_0x36794e(0x261)]!==_0x36794e(0x1dc)&&(_0x5d87b5[_0x36794e(0x1d9)]=new Date(),console[_0x36794e(0x1f0)]('üí∞\x20Payment\x20'+_0x1d44b5['id']+_0x36794e(0x201)+_0x5d87b5[_0x36794e(0x1d9)]['toISOString']())),_0x1d44b5[_0x36794e(0x261)]!==_0xf5f503&&(await database_1[_0x36794e(0x246)][_0x36794e(0x2a3)][_0x36794e(0x251)]({'where':{'id':_0x1d44b5['id']},'data':_0x5d87b5}),console['log'](_0x36794e(0x2a8)+_0x1d44b5['id']+'\x20status\x20updated\x20from\x20'+_0x1d44b5[_0x36794e(0x261)]+_0x36794e(0x1d7)+_0xf5f503),loggerService_1['loggerService']['logWebhookProcessed']('cointopay',_0x1d44b5['id'],_0x1d44b5[_0x36794e(0x261)],_0xf5f503,_0x339d2e),_0xf5f503===_0x36794e(0x1dc)&&await this[_0x36794e(0x222)][_0x36794e(0x20c)](_0x1d44b5['id']),await this['sendShopWebhook'](_0x1d44b5,_0xf5f503,_0x339d2e),await this[_0x36794e(0x1e1)](_0x1d44b5,_0xf5f503)),await database_1['default'][_0x36794e(0x262)]['create']({'data':{'paymentId':_0x1d44b5['id'],'shopId':_0x1d44b5[_0x36794e(0x1bc)],'event':_0x36794e(0x264)+_0xdf2d5c,'statusCode':0xc8,'responseBody':JSON[_0x36794e(0x299)](_0x339d2e)}}),console[_0x36794e(0x1f0)](_0x36794e(0x2a5)+_0x1d44b5['id']),console[_0x36794e(0x1f0)](_0x36794e(0x1ec)+_0xdf2d5c+_0x36794e(0x23e)+_0xf5f503+_0x36794e(0x281)+_0x18466e+'\x20'+(_0x20774d||_0x36794e(0x245)));}catch(_0xf84c24){console[_0x36794e(0x290)](_0x36794e(0x228),_0xf84c24),loggerService_1['loggerService'][_0x36794e(0x255)]('cointopay',_0xf84c24,_0x339d2e);try{await database_1['default'][_0x36794e(0x262)]['create']({'data':{'paymentId':_0x36794e(0x1db),'shopId':_0x36794e(0x1db),'event':_0x36794e(0x22c),'statusCode':0x1f4,'responseBody':JSON[_0x36794e(0x299)]({'error':_0xf84c24 instanceof Error?_0xf84c24[_0x36794e(0x1e5)]:'Unknown\x20error','webhookData':_0x339d2e})}});}catch(_0x372530){console[_0x36794e(0x290)](_0x36794e(0x1fc),_0x372530);}throw _0xf84c24;}}async[a52_0x37dc5e(0x226)](_0x14b9b8){const _0x14e04f=a52_0x37dc5e;try{loggerService_1[_0x14e04f(0x212)][_0x14e04f(0x1f5)](_0x14e04f(0x1c1),_0x14b9b8),console[_0x14e04f(0x1f0)]('Processing\x20KLYME\x20webhook:',_0x14b9b8);const {payment_id:_0xb098ee,order_id:_0x537f13,status:_0x2166e3,amount:_0x5d1b51,currency:_0x39eb97,region:_0x1fd254,customer_email:_0x44cd6a,customer_name:_0x5a42f5,payment_method:_0x11a7a8,transaction_id:_0x4495bc}=_0x14b9b8;if(!_0x537f13&&!_0xb098ee){const _0x51b132=new Error('Missing\x20required\x20webhook\x20data:\x20order_id\x20or\x20payment_id');loggerService_1[_0x14e04f(0x212)][_0x14e04f(0x255)](_0x14e04f(0x1c1),_0x51b132,_0x14b9b8);throw _0x51b132;}console['log'](_0x14e04f(0x242)+_0x1fd254+_0x14e04f(0x1eb)),console[_0x14e04f(0x1f0)](_0x14e04f(0x1da)+_0xb098ee),console[_0x14e04f(0x1f0)](_0x14e04f(0x24e)+_0x537f13);const _0x52c80=await database_1[_0x14e04f(0x246)][_0x14e04f(0x2a3)][_0x14e04f(0x200)]({'where':{'OR':[{'gatewayPaymentId':_0xb098ee},{'id':_0x537f13},{'gatewayOrderId':_0x537f13},{'orderId':_0x537f13}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x52c80){console[_0x14e04f(0x1f0)]('‚ùå\x20KLYME\x20payment\x20not\x20found\x20with\x20any\x20of\x20the\x20following\x20criteria:'),console[_0x14e04f(0x1f0)](_0x14e04f(0x252)+_0xb098ee),console[_0x14e04f(0x1f0)](_0x14e04f(0x293)+_0x537f13),console[_0x14e04f(0x1f0)]('\x20\x20\x20-\x20gatewayOrderId:\x20'+_0x537f13),console[_0x14e04f(0x1f0)](_0x14e04f(0x1bb)+_0x537f13);const _0x5b8136=new Error(_0x14e04f(0x1ef)+_0xb098ee+_0x14e04f(0x1f1)+_0x537f13);loggerService_1[_0x14e04f(0x212)]['logWebhookError'](_0x14e04f(0x1c1),_0x5b8136,_0x14b9b8);throw _0x5b8136;}console[_0x14e04f(0x1f0)](_0x14e04f(0x2af)+_0x52c80['id']+_0x14e04f(0x234)+_0x52c80[_0x14e04f(0x225)]+')');let _0x188a11;switch(_0x2166e3?.[_0x14e04f(0x1c0)]()){case'paid':case _0x14e04f(0x244):case _0x14e04f(0x23c):case'success':case _0x14e04f(0x230):_0x188a11=_0x14e04f(0x1dc);break;case _0x14e04f(0x280):case _0x14e04f(0x25c):case _0x14e04f(0x25e):case'error':case'rejected':_0x188a11=_0x14e04f(0x239);break;case _0x14e04f(0x278):case'timeout':_0x188a11=_0x14e04f(0x1c9);break;case'pending':case _0x14e04f(0x215):case'active':case'processing':case _0x14e04f(0x1c3):default:_0x188a11=_0x14e04f(0x209);break;}const _0x57fb3d={'status':_0x188a11,'updatedAt':new Date()};_0x11a7a8&&(_0x57fb3d[_0x14e04f(0x1ba)]=_0x11a7a8,console[_0x14e04f(0x1f0)]('üí≥\x20KLYME\x20payment\x20method:\x20'+_0x11a7a8)),_0x188a11===_0x14e04f(0x1dc)&&_0x52c80[_0x14e04f(0x261)]!==_0x14e04f(0x1dc)&&(_0x57fb3d['paidAt']=new Date(),console[_0x14e04f(0x1f0)](_0x14e04f(0x1df)+_0x52c80['id']+_0x14e04f(0x201)+_0x57fb3d[_0x14e04f(0x1d9)][_0x14e04f(0x238)]())),(_0x52c80['status']!==_0x188a11||_0x11a7a8)&&(await database_1[_0x14e04f(0x246)]['payment'][_0x14e04f(0x251)]({'where':{'id':_0x52c80['id']},'data':_0x57fb3d}),_0x52c80[_0x14e04f(0x261)]!==_0x188a11&&(console[_0x14e04f(0x1f0)](_0x14e04f(0x2a8)+_0x52c80['id']+_0x14e04f(0x289)+_0x52c80[_0x14e04f(0x261)]+_0x14e04f(0x1d7)+_0x188a11),loggerService_1[_0x14e04f(0x212)][_0x14e04f(0x1f4)](_0x14e04f(0x1c1),_0x52c80['id'],_0x52c80[_0x14e04f(0x261)],_0x188a11,_0x14b9b8),_0x188a11===_0x14e04f(0x1dc)&&await this[_0x14e04f(0x222)][_0x14e04f(0x20c)](_0x52c80['id']),await this[_0x14e04f(0x2a4)](_0x52c80,_0x188a11,_0x14b9b8),await this[_0x14e04f(0x1e1)](_0x52c80,_0x188a11)),_0x11a7a8&&console['log'](_0x14e04f(0x2a8)+_0x52c80['id']+_0x14e04f(0x247)+_0x11a7a8)),await database_1['default'][_0x14e04f(0x262)][_0x14e04f(0x25b)]({'data':{'paymentId':_0x52c80['id'],'shopId':_0x52c80[_0x14e04f(0x1bc)],'event':'klyme_'+_0x1fd254?.[_0x14e04f(0x1c0)]()+'_'+_0x2166e3,'statusCode':0xc8,'responseBody':JSON['stringify']({..._0x14b9b8,'parsed':{'klymePaymentId':_0xb098ee,'orderId':_0x537f13,'status':_0x2166e3,'amount':_0x5d1b51,'currency':_0x39eb97,'region':_0x1fd254,'payment_method':_0x11a7a8,'transaction_id':_0x4495bc}})}}),console['log']('KLYME\x20'+_0x1fd254+_0x14e04f(0x1c5)+_0x52c80['id']),console[_0x14e04f(0x1f0)](_0x14e04f(0x1ec)+_0x2166e3+_0x14e04f(0x23e)+_0x188a11+_0x14e04f(0x281)+_0x5d1b51+'\x20'+_0x39eb97+_0x14e04f(0x1bd)+_0x1fd254),console[_0x14e04f(0x1f0)]('Payment\x20Method:\x20'+_0x11a7a8+_0x14e04f(0x213)+_0x4495bc);}catch(_0x12ddeb){console[_0x14e04f(0x290)](_0x14e04f(0x1ca),_0x12ddeb),loggerService_1[_0x14e04f(0x212)][_0x14e04f(0x255)](_0x14e04f(0x1c1),_0x12ddeb,_0x14b9b8);try{await database_1[_0x14e04f(0x246)]['webhookLog'][_0x14e04f(0x25b)]({'data':{'paymentId':_0x14e04f(0x1db),'shopId':'unknown','event':_0x14e04f(0x21b),'statusCode':0x1f4,'responseBody':JSON[_0x14e04f(0x299)]({'error':_0x12ddeb instanceof Error?_0x12ddeb[_0x14e04f(0x1e5)]:_0x14e04f(0x284),'webhookData':_0x14b9b8})}});}catch(_0xfe1cef){console[_0x14e04f(0x290)]('Failed\x20to\x20log\x20KLYME\x20webhook\x20error:',_0xfe1cef);}throw _0x12ddeb;}}async[a52_0x37dc5e(0x2a4)](_0x49eb83,_0x1ccbfd,_0x406b32){const _0x4d0011=a52_0x37dc5e,_0x16f35c=Date[_0x4d0011(0x23f)]();try{const _0xca3816=_0x49eb83['shop'],_0x49fee1=_0xca3816[_0x4d0011(0x272)];if(!_0x49fee1?.[_0x4d0011(0x248)]){console[_0x4d0011(0x1f0)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0xca3816['id']);return;}const _0x51569a=this['parseWebhookEvents'](_0x49fee1[_0x4d0011(0x1cc)]),_0x436802=_0x1ccbfd===_0x4d0011(0x1dc)?'payment.success':_0x1ccbfd===_0x4d0011(0x239)?'payment.failed':_0x4d0011(0x23b);if(!_0x51569a[_0x4d0011(0x2a1)](_0x436802)){console[_0x4d0011(0x1f0)]('Webhook\x20event\x20'+_0x436802+_0x4d0011(0x26d)+_0xca3816['id']);return;}const _0x209cb5=(0x0,gateway_1[_0x4d0011(0x263)])(_0x49eb83[_0x4d0011(0x225)]),_0x360668={'event':_0x436802,'payment':{'id':_0x49eb83['id'],'order_id':_0x49eb83[_0x4d0011(0x1e8)],'gateway_order_id':_0x49eb83['gatewayOrderId'],'gateway':_0x209cb5||_0x49eb83['gateway'],'amount':_0x49eb83[_0x4d0011(0x26e)],'currency':_0x49eb83[_0x4d0011(0x1f8)],'status':_0x1ccbfd[_0x4d0011(0x1c0)](),'customer_email':_0x49eb83[_0x4d0011(0x214)],'customer_name':_0x49eb83[_0x4d0011(0x216)],'card_last4':_0x49eb83[_0x4d0011(0x203)],'payment_method':_0x49eb83[_0x4d0011(0x1ba)],'bank_id':_0x49eb83[_0x4d0011(0x220)],'remitter_iban':_0x49eb83[_0x4d0011(0x232)],'remitter_name':_0x49eb83[_0x4d0011(0x276)],'created_at':_0x49eb83[_0x4d0011(0x1c4)],'updated_at':_0x49eb83[_0x4d0011(0x1e6)]}};console[_0x4d0011(0x1f0)](_0x4d0011(0x210)+_0x209cb5+_0x4d0011(0x1ea)+_0x49eb83['gateway']+')');const _0x4f2d44=await fetch(_0x49fee1[_0x4d0011(0x248)],{'method':'POST','headers':{'Content-Type':_0x4d0011(0x22f),'User-Agent':_0x4d0011(0x1e9)},'body':JSON[_0x4d0011(0x299)](_0x360668)}),_0x8e3351=Date[_0x4d0011(0x23f)]()-_0x16f35c,_0x5ccc58=_0x4f2d44['ok']?_0x4d0011(0x250):await _0x4f2d44[_0x4d0011(0x24c)]();loggerService_1[_0x4d0011(0x212)][_0x4d0011(0x22b)](_0x49eb83[_0x4d0011(0x1bc)],_0x49fee1[_0x4d0011(0x248)],_0x436802,_0x4f2d44['status'],_0x8e3351,_0x360668),await database_1[_0x4d0011(0x246)][_0x4d0011(0x262)][_0x4d0011(0x25b)]({'data':{'paymentId':_0x49eb83['id'],'shopId':_0x49eb83[_0x4d0011(0x1bc)],'event':_0x4d0011(0x1b5)+_0x436802,'statusCode':_0x4f2d44['status'],'responseBody':_0x5ccc58}}),console[_0x4d0011(0x1f0)](_0x4d0011(0x22e)+_0x49fee1[_0x4d0011(0x248)]+_0x4d0011(0x29f)+_0x4f2d44['status']+'\x20('+_0x8e3351+_0x4d0011(0x265));}catch(_0x2087dd){const _0x15f189=Date[_0x4d0011(0x23f)]()-_0x16f35c;console[_0x4d0011(0x290)](_0x4d0011(0x266),_0x2087dd),loggerService_1[_0x4d0011(0x212)]['logShopWebhookError'](_0x49eb83[_0x4d0011(0x1bc)],_0x49eb83[_0x4d0011(0x28d)]?.['settings']?.[_0x4d0011(0x248)]||_0x4d0011(0x1db),_0x4d0011(0x24f),_0x2087dd,{});try{await database_1[_0x4d0011(0x246)][_0x4d0011(0x262)][_0x4d0011(0x25b)]({'data':{'paymentId':_0x49eb83['id'],'shopId':_0x49eb83[_0x4d0011(0x1bc)],'event':_0x4d0011(0x1d2),'statusCode':0x0,'responseBody':JSON['stringify']({'error':_0x2087dd instanceof Error?_0x2087dd[_0x4d0011(0x1e5)]:'Unknown\x20error','responseTime':_0x15f189})}});}catch(_0x39390e){console['error']('Failed\x20to\x20log\x20shop\x20webhook\x20error:',_0x39390e);}}}async[a52_0x37dc5e(0x1e1)](_0x4a3772,_0x15ef6c){const _0x1ecf9e=a52_0x37dc5e;try{console[_0x1ecf9e(0x1f0)](_0x1ecf9e(0x1dd)+_0x4a3772['id']+_0x1ecf9e(0x2b1)+_0x15ef6c);const _0x3936cf=await database_1[_0x1ecf9e(0x246)][_0x1ecf9e(0x1d8)][_0x1ecf9e(0x249)]({'where':{'shopId':_0x4a3772['shopId']},'select':{'notificationPaymentSuccess':!![],'notificationPaymentFailed':!![],'notificationRefund':!![],'notificationPayout':!![],'notificationLogin':!![],'notificationApiError':!![]}});if(!_0x3936cf){console['log'](_0x1ecf9e(0x1e4)+_0x4a3772[_0x1ecf9e(0x1bc)]+_0x1ecf9e(0x2a0));return;}console[_0x1ecf9e(0x1f0)]('üì±\x20Shop\x20notification\x20settings:',{'payment_success':_0x3936cf[_0x1ecf9e(0x1cb)],'payment_failed':_0x3936cf[_0x1ecf9e(0x21d)],'refund':_0x3936cf[_0x1ecf9e(0x1f2)],'payout':_0x3936cf[_0x1ecf9e(0x24b)],'login':_0x3936cf[_0x1ecf9e(0x269)],'api_error':_0x3936cf[_0x1ecf9e(0x292)]});let _0x55648c=![],_0x3eb524;switch(_0x15ef6c){case'PENDING':_0x3936cf['notificationPaymentFailed']&&(_0x55648c=!![],_0x3eb524=_0x1ecf9e(0x215));break;case'PAID':_0x3936cf['notificationPaymentSuccess']&&(_0x55648c=!![],_0x3eb524=_0x1ecf9e(0x227));break;case _0x1ecf9e(0x239):_0x3936cf[_0x1ecf9e(0x21d)]&&(_0x55648c=!![],_0x3eb524=_0x1ecf9e(0x25e));break;case _0x1ecf9e(0x1c9):_0x3936cf[_0x1ecf9e(0x21d)]&&(_0x55648c=!![],_0x3eb524=_0x1ecf9e(0x278));break;case _0x1ecf9e(0x237):_0x3936cf[_0x1ecf9e(0x1f2)]&&(_0x55648c=!![],_0x3eb524=_0x1ecf9e(0x1fb));break;case _0x1ecf9e(0x1d0):_0x3936cf[_0x1ecf9e(0x1f2)]&&(_0x55648c=!![],_0x3eb524=_0x1ecf9e(0x295));break;default:console[_0x1ecf9e(0x1f0)]('üì±\x20Unknown\x20payment\x20status:\x20'+_0x15ef6c+_0x1ecf9e(0x2a0));return;}if(!_0x55648c){console[_0x1ecf9e(0x1f0)](_0x1ecf9e(0x267)+_0x15ef6c+_0x1ecf9e(0x243));return;}await telegramBotService_1['telegramBotService'][_0x1ecf9e(0x1e3)](_0x4a3772['shopId'],_0x4a3772,_0x3eb524),console[_0x1ecf9e(0x1f0)]('‚úÖ\x20Telegram\x20notification\x20sent\x20successfully\x20for\x20payment\x20'+_0x4a3772['id']);}catch(_0x230bc9){console[_0x1ecf9e(0x290)](_0x1ecf9e(0x1ce),_0x230bc9);}}async[a52_0x37dc5e(0x1b8)](_0x430ab6,_0x93a262){const _0x14e0bd=a52_0x37dc5e;console[_0x14e0bd(0x1f0)](_0x14e0bd(0x1f9)+_0x430ab6['id']+_0x14e0bd(0x1cd)+_0x93a262);}}exports['WebhookService']=WebhookService;