'use strict';function a52_0x1649(_0x49a83a,_0x269143){const _0x255eec=a52_0x255e();return a52_0x1649=function(_0x164989,_0x2a6501){_0x164989=_0x164989-0x131;let _0x1f9f6=_0x255eec[_0x164989];return _0x1f9f6;},a52_0x1649(_0x49a83a,_0x269143);}function a52_0x255e(){const _0x59f9d4=['logWebhookReceived','plisio_error','PAYMENT_EXPIRED','waiting','KLYME\x20webhook\x20processing\x20error:','Noda\x20webhook\x20processing\x20error:','processPlisioGatewayWebhook','payment.pending','\x20->\x20','sendNotificationToShop','Payment\x20not\x20found\x20for\x20order_id:\x20','notificationRefund','payment_method_data','remitterName','Failed\x20to\x20send\x20shop\x20webhook:','Name','notificationPaymentSuccess','payment','orderId','Unknown\x20error','cointopay_error','Iban','plisioService','__importDefault','REFUND','Payment\x20not\x20found\x20for\x20payment_id:\x20','\x20to\x20','cointopay','Shop\x20webhook\x20sent\x20to\x20','Failed\x20to\x20log\x20gateway\x20webhook\x20error:','\x20webhook\x20processed\x20successfully\x20for\x20payment\x20',',\x20MerchantPaymentId:\x20','pending','./gateways/plisioService','\x20\x20\x20-\x20ID:\x20','webhookUrl','findMany','Payment\x20Method:\x20','findFirst','Failed\x20to\x20log\x20CoinToPay\x20webhook\x20error:','\x20not\x20enabled\x20for\x20shop\x20','stringify','./loggerService','Remitter:\x20',',\x20GatewayPaymentId:\x20','üì±\x20Unknown\x20payment\x20status:\x20','notificationPayout','EXP','merchant_reference_id','customerEmail','KlymeService','processCoinToPayWebhook','../config/database','type','Failed\x20to\x20log\x20Noda\x20webhook\x20error:','Failed\x20to\x20log\x20webhook\x20error:','timeout','pending\x20internal',',\x20status:\x20','active','üè¶\x20Bank\x20ID:\x20','toISOString','klyme_','Failed\x20to\x20log\x20Rapyd\x20webhook\x20error:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','üîç\x20Searching\x20for\x20Noda\x20payment:','RapydService','CoinToPay\x20webhook\x20processing\x20error:','sendPaymentNotification',',\x20Region:\x20','processing','canceled','110800JAMJgP','isArray','__esModule','CHARGEBACK','refund','customerName','webhook_send','27xWgiBP','Success','loggerService','shop_webhook_error','\x20with\x20status\x20','remitterIban','processKlymeWebhook','PAYMENT_CANCELED','Gateway\x20webhook\x20processing\x20error:','\x20status\x20updated\x20from\x20','shop_webhook_','sendShopWebhook','text','CoinToPay\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','PlisioService','EUR','\x20\x20\x20-\x20orderId:\x20',',\x20Amount:\x20','klyme','PAID','\x20status\x20changed\x20to\x20','status','Status:\x20','shopId','KLYME\x20','notificationPaymentFailed','plisio','shop','default','last4','EXPIRED','Processing\x20Noda\x20webhook:','üí∞\x20Payment\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','Missing\x20required\x20webhook\x20data:\x20txn_id\x20or\x20order_number','Missing\x20required\x20webhook\x20data:\x20data.id','notificationApiError','\x20\x20\x20-\x20PaymentId:\x20','message','created','cardLast4','Processing\x20Rapyd\x20webhook:','gatewayPaymentId','WebhookService','logWebhookError','üí≥\x20Extracted\x20card\x20last\x204\x20digits:\x20****',',\x20Settlement\x20Date:\x20','üí≥\x20Payment\x20method:\x20','rapyd_error','logShopWebhookSent',',\x20skipping\x20Telegram\x20notification','plisio_','payment.failed','../types/gateway','üîó\x20Sending\x20webhook\x20to\x20shop\x20with\x20gateway\x20ID:\x20',',\x20OrderId:\x20','successful','Processing\x20KLYME\x20webhook:','noda','\x20(gateway:\x20','CAN','handleSuccessfulPayment','plisio_gateway_','currency','‚úÖ\x20Telegram\x20notification\x20sent\x20successfully\x20for\x20payment\x20','4OnlYdG','expired',',\x20order_id:\x20','3692490tozzyR','CLO','NodaService','\x20\x20\x20-\x20gatewayOrderId:\x20','gateway','Webhook\x20event\x20','payment.success','Payment\x20not\x20found\x20for\x20gateway_id:\x20','telegramBotService','\x20marked\x20as\x20paid\x20at:\x20','webhookEvents','failed','Payment\x20',',\x20Settled:\x20','‚ùå\x20Payment\x20not\x20found\x20with\x20any\x20of\x20the\x20following\x20criteria:','FAILED','296842AZrbRt','Failed\x20to\x20log\x20KLYME\x20webhook\x20error:','bankId','TesSoft\x20Payment\x20System/1.0','\x20details\x20updated:\x20payment_method=','Yes','gatewayOrderId','üí≥\x20KLYME\x20payment\x20method:\x20','3251352ZZCFTR','plisio_gateway','logWebhookProcessed','confirmed','cancelled','done','defineProperty','\x20\x20\x20-\x20MerchantPaymentId:\x20','completed','paidAt','Rapyd\x20webhook\x20processing\x20error:','error','38aFxwCl','paid',',\x20Transaction\x20ID:\x20','toLowerCase','createdAt','./gateways/nodaService','paymentMethod',',\x20Gateway:\x20','klymeService','‚ùå\x20KLYME\x20payment\x20not\x20found\x20with\x20any\x20of\x20the\x20following\x20criteria:','\x20payment:','Processing\x20CoinToPay\x20webhook:','üè¶\x20Extracted\x20remitter\x20IBAN:\x20','PENDING',',\x20bank=','\x20\x20\x20-\x20OrderId:\x20','rapyd','parseWebhookEvents','now','PaymentLinkService','üë§\x20Remitter\x20name:\x20','./telegramBotService','POST','webhookLog',',\x20method=','string',',\x20merchant_reference_id:\x20','1395672wEPdRj','log','Processing\x20Plisio\x20webhook:','226440fRZNVt','in_progress','update','Bank:\x20',',\x20name=','Processing\x20Plisio\x20gateway\x20webhook:','‚úÖ\x20Found\x20payment:\x20','rejected','NEW','create','klyme_error','unknown','\x20(was:\x20','2044OMaxAa','toUpperCase','üì±\x20Shop\x20notification\x20settings:',',\x20GatewayOrderId:\x20','new','application/json','üì±\x20Telegram\x20notification\x20disabled\x20for\x20status:\x20',',\x20txn_id:\x20','sendPaymentStatusNotification','paymentLinkService','‚úÖ\x20Found\x20KLYME\x20payment:\x20','amount','rapyd_'];a52_0x255e=function(){return _0x59f9d4;};return a52_0x255e();}const a52_0x5de975=a52_0x1649;(function(_0x26a603,_0x274a2d){const _0x31b1ca=a52_0x1649,_0x3c1a3e=_0x26a603();while(!![]){try{const _0x2e6f72=parseInt(_0x31b1ca(0x1cf))/0x1*(parseInt(_0x31b1ca(0x1fa))/0x2)+parseInt(_0x31b1ca(0x1ea))/0x3*(-parseInt(_0x31b1ca(0x1a8))/0x4)+-parseInt(_0x31b1ca(0x160))/0x5+-parseInt(_0x31b1ca(0x1ed))/0x6+parseInt(_0x31b1ca(0x1bb))/0x7+-parseInt(_0x31b1ca(0x1c3))/0x8+parseInt(_0x31b1ca(0x167))/0x9*(parseInt(_0x31b1ca(0x1ab))/0xa);if(_0x2e6f72===_0x274a2d)break;else _0x3c1a3e['push'](_0x3c1a3e['shift']());}catch(_0x47783b){_0x3c1a3e['push'](_0x3c1a3e['shift']());}}}(a52_0x255e,0x3eda6));var __importDefault=this&&this[a52_0x5de975(0x21e)]||function(_0x2efa10){const _0x435a27=a52_0x5de975;return _0x2efa10&&_0x2efa10[_0x435a27(0x162)]?_0x2efa10:{'default':_0x2efa10};};Object[a52_0x5de975(0x1c9)](exports,a52_0x5de975(0x162),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a52_0x5de975(0x14c))),plisioService_1=require(a52_0x5de975(0x139)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a52_0x5de975(0x1d4)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require('./gateways/klymeService'),paymentLinkService_1=require('./paymentLinkService'),telegramBotService_1=require(a52_0x5de975(0x1e4)),loggerService_1=require(a52_0x5de975(0x142)),gateway_1=require(a52_0x5de975(0x19c));class WebhookService{constructor(){const _0x1af574=a52_0x5de975;this[_0x1af574(0x21d)]=new plisioService_1[(_0x1af574(0x175))](),this['rapydService']=new rapydService_1[(_0x1af574(0x15a))](),this['nodaService']=new nodaService_1[(_0x1af574(0x1ad))](),this['coinToPayService']=new coinToPayService_1['CoinToPayService'](),this[_0x1af574(0x1d7)]=new klymeService_1[(_0x1af574(0x14a))](),this[_0x1af574(0x203)]=new paymentLinkService_1[(_0x1af574(0x1e2))]();}['parseWebhookEvents'](_0x4d65b2){const _0x4c0edf=a52_0x5de975;if(!_0x4d65b2)return[];if(Array['isArray'](_0x4d65b2))return _0x4d65b2;if(typeof _0x4d65b2===_0x4c0edf(0x1e8))try{const _0x39ddde=JSON['parse'](_0x4d65b2);return Array[_0x4c0edf(0x161)](_0x39ddde)?_0x39ddde:[];}catch{return[];}return[];}async['processPlisioWebhook'](_0x185fd4){const _0x45d53b=a52_0x5de975;try{loggerService_1[_0x45d53b(0x169)]['logWebhookReceived']('plisio',_0x185fd4),console[_0x45d53b(0x1eb)](_0x45d53b(0x1ec),_0x185fd4);const {txn_id:_0x727693,order_number:_0x50142d,status:_0x5345bb,amount:_0x42ab2c,currency:_0x2c67e5}=_0x185fd4;if(!_0x727693||!_0x50142d){const _0x501742=new Error('Missing\x20required\x20webhook\x20data:\x20txn_id\x20or\x20order_number');loggerService_1[_0x45d53b(0x169)][_0x45d53b(0x193)](_0x45d53b(0x181),_0x501742,_0x185fd4);throw _0x501742;}const _0x2b1144=await database_1['default']['payment'][_0x45d53b(0x13e)]({'where':{'OR':[{'gatewayPaymentId':_0x727693},{'orderId':_0x50142d}]},'include':{'shop':{'select':{'id':!![],'name':!![]}}}});if(!_0x2b1144){const _0x2e0271=new Error(_0x45d53b(0x1b2)+_0x727693+_0x45d53b(0x1aa)+_0x50142d);loggerService_1[_0x45d53b(0x169)]['logWebhookError'](_0x45d53b(0x181),_0x2e0271,_0x185fd4);throw _0x2e0271;}let _0x5f1450;switch(_0x5345bb){case _0x45d53b(0x1cb):case'mismatch':_0x5f1450=_0x45d53b(0x17a);break;case _0x45d53b(0x1a9):_0x5f1450='EXPIRED';break;case _0x45d53b(0x1ce):case _0x45d53b(0x1c7):_0x5f1450=_0x45d53b(0x1ba);break;case _0x45d53b(0x1fe):case _0x45d53b(0x138):default:_0x5f1450=_0x45d53b(0x1dc);break;}const _0x55aa4c={'status':_0x5f1450,'updatedAt':new Date()};_0x5f1450===_0x45d53b(0x17a)&&_0x2b1144['status']!==_0x45d53b(0x17a)&&(_0x55aa4c[_0x45d53b(0x1cc)]=new Date(),console['log'](_0x45d53b(0x187)+_0x2b1144['id']+_0x45d53b(0x1b4)+_0x55aa4c[_0x45d53b(0x1cc)][_0x45d53b(0x155)]())),_0x2b1144[_0x45d53b(0x17c)]!==_0x5f1450&&(await database_1['default'][_0x45d53b(0x218)][_0x45d53b(0x1ef)]({'where':{'id':_0x2b1144['id']},'data':_0x55aa4c}),console[_0x45d53b(0x1eb)](_0x45d53b(0x1b7)+_0x2b1144['id']+_0x45d53b(0x170)+_0x2b1144[_0x45d53b(0x17c)]+_0x45d53b(0x132)+_0x5f1450),loggerService_1['loggerService'][_0x45d53b(0x1c5)](_0x45d53b(0x181),_0x2b1144['id'],_0x2b1144[_0x45d53b(0x17c)],_0x5f1450,_0x185fd4),_0x5f1450===_0x45d53b(0x17a)&&await this[_0x45d53b(0x203)][_0x45d53b(0x1a4)](_0x2b1144['id']),await this[_0x45d53b(0x202)](_0x2b1144,_0x5f1450)),await database_1['default'][_0x45d53b(0x1e6)]['create']({'data':{'paymentId':_0x2b1144['id'],'shopId':_0x2b1144[_0x45d53b(0x17e)],'event':_0x45d53b(0x19a)+_0x5345bb,'statusCode':0xc8,'responseBody':JSON['stringify'](_0x185fd4)}});}catch(_0x2abf5d){console[_0x45d53b(0x1ce)]('Webhook\x20processing\x20error:',_0x2abf5d),loggerService_1[_0x45d53b(0x169)][_0x45d53b(0x193)]('plisio',_0x2abf5d,_0x185fd4);try{await database_1[_0x45d53b(0x183)][_0x45d53b(0x1e6)][_0x45d53b(0x1f6)]({'data':{'paymentId':'unknown','shopId':_0x45d53b(0x1f8),'event':_0x45d53b(0x208),'statusCode':0x1f4,'responseBody':JSON[_0x45d53b(0x141)]({'error':_0x2abf5d instanceof Error?_0x2abf5d[_0x45d53b(0x18d)]:_0x45d53b(0x21a),'webhookData':_0x185fd4})}});}catch(_0x1df9fd){console['error'](_0x45d53b(0x14f),_0x1df9fd);}throw _0x2abf5d;}}async[a52_0x5de975(0x20d)](_0x5b045b){const _0x3390ca=a52_0x5de975;try{loggerService_1[_0x3390ca(0x169)]['logWebhookReceived']('plisio_gateway',_0x5b045b),console[_0x3390ca(0x1eb)](_0x3390ca(0x1f2),_0x5b045b);const {txn_id:_0x171036,order_number:_0x1bb385,status:_0x1124c4,amount:_0x50af9d,currency:_0x32a52d,source_currency:_0x3eb680,source_amount:_0x5c77f4,invoice_total_sum:_0x40a6db,invoice_commission:_0x161c82,invoice_sum:_0x1cbcb7,confirmations:_0x3ecdc2,verify_hash:_0x1ce0b1,merchant:_0x313a2f,merchant_id:_0x37e1ed,ipn_type:_0xa5d3eb,order_name:_0x1146ad,comment:_0x25955a}=_0x5b045b;if(!_0x171036||!_0x1bb385){const _0xfe8af8=new Error(_0x3390ca(0x189));loggerService_1['loggerService']['logWebhookError']('plisio_gateway',_0xfe8af8,_0x5b045b);throw _0xfe8af8;}const _0xe8e42b=await database_1[_0x3390ca(0x183)][_0x3390ca(0x218)][_0x3390ca(0x13e)]({'where':{'OR':[{'id':_0x1bb385},{'gatewayPaymentId':_0x171036},{'gatewayOrderId':_0x1bb385}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xe8e42b){const _0x39c97b=new Error('Payment\x20not\x20found\x20for\x20order_number:\x20'+_0x1bb385+_0x3390ca(0x201)+_0x171036);loggerService_1[_0x3390ca(0x169)][_0x3390ca(0x193)](_0x3390ca(0x1c4),_0x39c97b,_0x5b045b);throw _0x39c97b;}let _0x4ac68f;switch(_0x1124c4?.['toLowerCase']()){case'completed':case'mismatch':_0x4ac68f=_0x3390ca(0x17a);break;case _0x3390ca(0x1a9):_0x4ac68f=_0x3390ca(0x185);break;case _0x3390ca(0x1ce):case'cancelled':_0x4ac68f=_0x3390ca(0x1ba);break;case _0x3390ca(0x1fe):case _0x3390ca(0x138):case _0x3390ca(0x151):default:_0x4ac68f='PENDING';break;}const _0x77b10={'status':_0x4ac68f,'updatedAt':new Date()};_0x4ac68f===_0x3390ca(0x17a)&&_0xe8e42b[_0x3390ca(0x17c)]!==_0x3390ca(0x17a)&&(_0x77b10[_0x3390ca(0x1cc)]=new Date(),console[_0x3390ca(0x1eb)](_0x3390ca(0x187)+_0xe8e42b['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x77b10['paidAt'][_0x3390ca(0x155)]())),_0xe8e42b[_0x3390ca(0x17c)]!==_0x4ac68f&&(await database_1[_0x3390ca(0x183)][_0x3390ca(0x218)][_0x3390ca(0x1ef)]({'where':{'id':_0xe8e42b['id']},'data':_0x77b10}),console[_0x3390ca(0x1eb)](_0x3390ca(0x1b7)+_0xe8e42b['id']+'\x20status\x20updated\x20from\x20'+_0xe8e42b[_0x3390ca(0x17c)]+_0x3390ca(0x132)+_0x4ac68f),loggerService_1[_0x3390ca(0x169)]['logWebhookProcessed'](_0x3390ca(0x1c4),_0xe8e42b['id'],_0xe8e42b['status'],_0x4ac68f,_0x5b045b),_0x4ac68f==='PAID'&&await this[_0x3390ca(0x203)]['handleSuccessfulPayment'](_0xe8e42b['id']),await this[_0x3390ca(0x172)](_0xe8e42b,_0x4ac68f,_0x5b045b),await this[_0x3390ca(0x202)](_0xe8e42b,_0x4ac68f)),await database_1['default'][_0x3390ca(0x1e6)][_0x3390ca(0x1f6)]({'data':{'paymentId':_0xe8e42b['id'],'shopId':_0xe8e42b[_0x3390ca(0x17e)],'event':_0x3390ca(0x1a5)+_0x1124c4,'statusCode':0xc8,'responseBody':JSON[_0x3390ca(0x141)](_0x5b045b)}});}catch(_0x3c76c7){console['error'](_0x3390ca(0x16f),_0x3c76c7),loggerService_1[_0x3390ca(0x169)][_0x3390ca(0x193)](_0x3390ca(0x1c4),_0x3c76c7,_0x5b045b);try{await database_1['default'][_0x3390ca(0x1e6)][_0x3390ca(0x1f6)]({'data':{'paymentId':_0x3390ca(0x1f8),'shopId':_0x3390ca(0x1f8),'event':'plisio_gateway_error','statusCode':0x1f4,'responseBody':JSON[_0x3390ca(0x141)]({'error':_0x3c76c7 instanceof Error?_0x3c76c7[_0x3390ca(0x18d)]:_0x3390ca(0x21a),'webhookData':_0x5b045b})}});}catch(_0x47daff){console['error'](_0x3390ca(0x135),_0x47daff);}throw _0x3c76c7;}}async['processRapydWebhook'](_0x3c67dc){const _0x1c2cdb=a52_0x5de975;try{loggerService_1['loggerService'][_0x1c2cdb(0x207)](_0x1c2cdb(0x1df),_0x3c67dc),console['log'](_0x1c2cdb(0x190),_0x3c67dc);const {id:_0x2a452a,type:_0x39d6e6,data:_0x2cc3b9,created_at:_0x1bdbf5}=_0x3c67dc;if(!_0x2cc3b9?.['id']){const _0x25258e=new Error(_0x1c2cdb(0x18a));loggerService_1['loggerService'][_0x1c2cdb(0x193)](_0x1c2cdb(0x1df),_0x25258e,_0x3c67dc);throw _0x25258e;}const _0x30714d=_0x2cc3b9['id'],_0x431616=_0x2cc3b9[_0x1c2cdb(0x148)],_0x389344=await database_1['default'][_0x1c2cdb(0x218)]['findFirst']({'where':{'OR':[{'gatewayPaymentId':_0x30714d},{'id':_0x431616},{'gatewayOrderId':_0x431616}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x389344){const _0x302cbb=new Error(_0x1c2cdb(0x1b2)+_0x30714d+_0x1c2cdb(0x1e9)+_0x431616);loggerService_1[_0x1c2cdb(0x169)]['logWebhookError'](_0x1c2cdb(0x1df),_0x302cbb,_0x3c67dc);throw _0x302cbb;}let _0x201b95=null,_0x1da8c9=null;_0x2cc3b9[_0x1c2cdb(0x213)]&&(_0x201b95=_0x2cc3b9[_0x1c2cdb(0x213)][_0x1c2cdb(0x184)]||null,_0x1da8c9=_0x2cc3b9[_0x1c2cdb(0x213)][_0x1c2cdb(0x14d)]||_0x2cc3b9['payment_method_type']||null);let _0x79aec7;switch(_0x39d6e6?.[_0x1c2cdb(0x1fb)]()){case'PAYMENT_COMPLETED':_0x2cc3b9[_0x1c2cdb(0x1d0)]===!![]&&_0x2cc3b9[_0x1c2cdb(0x17c)]===_0x1c2cdb(0x1ac)?_0x79aec7='PAID':_0x79aec7='PENDING';break;case _0x1c2cdb(0x16e):_0x79aec7='FAILED';break;case _0x1c2cdb(0x209):_0x79aec7=_0x1c2cdb(0x185);break;case'PAYMENT_FAILED':_0x79aec7=_0x1c2cdb(0x1ba);break;default:switch(_0x2cc3b9['status']?.[_0x1c2cdb(0x1fb)]()){case _0x1c2cdb(0x1ac):_0x2cc3b9['paid']===!![]?_0x79aec7=_0x1c2cdb(0x17a):_0x79aec7=_0x1c2cdb(0x1ba);break;case _0x1c2cdb(0x1a3):_0x79aec7=_0x1c2cdb(0x1ba);break;case _0x1c2cdb(0x147):_0x79aec7='EXPIRED';break;case'ERR':_0x79aec7=_0x1c2cdb(0x1ba);break;case _0x1c2cdb(0x1f5):case'ACT':default:_0x79aec7=_0x1c2cdb(0x1dc);break;}break;}const _0x7fc253={'status':_0x79aec7,'updatedAt':new Date()};_0x201b95&&(_0x7fc253[_0x1c2cdb(0x18f)]=_0x201b95,console[_0x1c2cdb(0x1eb)](_0x1c2cdb(0x194)+_0x201b95)),_0x1da8c9&&(_0x7fc253[_0x1c2cdb(0x1d5)]=_0x1da8c9,console['log'](_0x1c2cdb(0x196)+_0x1da8c9)),_0x79aec7==='PAID'&&_0x389344[_0x1c2cdb(0x17c)]!==_0x1c2cdb(0x17a)&&(_0x7fc253['paidAt']=new Date(),console[_0x1c2cdb(0x1eb)](_0x1c2cdb(0x187)+_0x389344['id']+_0x1c2cdb(0x1b4)+_0x7fc253[_0x1c2cdb(0x1cc)]['toISOString']())),(_0x389344[_0x1c2cdb(0x17c)]!==_0x79aec7||_0x201b95||_0x1da8c9)&&(await database_1[_0x1c2cdb(0x183)][_0x1c2cdb(0x218)][_0x1c2cdb(0x1ef)]({'where':{'id':_0x389344['id']},'data':_0x7fc253}),_0x389344['status']!==_0x79aec7&&(console[_0x1c2cdb(0x1eb)]('Payment\x20'+_0x389344['id']+_0x1c2cdb(0x170)+_0x389344['status']+_0x1c2cdb(0x132)+_0x79aec7),loggerService_1[_0x1c2cdb(0x169)][_0x1c2cdb(0x1c5)]('rapyd',_0x389344['id'],_0x389344[_0x1c2cdb(0x17c)],_0x79aec7,_0x3c67dc),_0x79aec7===_0x1c2cdb(0x17a)&&await this['paymentLinkService'][_0x1c2cdb(0x1a4)](_0x389344['id']),await this['sendShopWebhook'](_0x389344,_0x79aec7,_0x3c67dc),await this['sendPaymentStatusNotification'](_0x389344,_0x79aec7)),(_0x201b95||_0x1da8c9)&&console[_0x1c2cdb(0x1eb)](_0x1c2cdb(0x1b7)+_0x389344['id']+'\x20details\x20updated:\x20card_last4='+_0x201b95+',\x20payment_method='+_0x1da8c9)),await database_1[_0x1c2cdb(0x183)][_0x1c2cdb(0x1e6)][_0x1c2cdb(0x1f6)]({'data':{'paymentId':_0x389344['id'],'shopId':_0x389344[_0x1c2cdb(0x17e)],'event':_0x1c2cdb(0x206)+_0x39d6e6,'statusCode':0xc8,'responseBody':JSON[_0x1c2cdb(0x141)](_0x3c67dc)}});}catch(_0x4f18c6){console['error'](_0x1c2cdb(0x1cd),_0x4f18c6),loggerService_1[_0x1c2cdb(0x169)][_0x1c2cdb(0x193)]('rapyd',_0x4f18c6,_0x3c67dc);try{await database_1[_0x1c2cdb(0x183)]['webhookLog'][_0x1c2cdb(0x1f6)]({'data':{'paymentId':_0x1c2cdb(0x1f8),'shopId':_0x1c2cdb(0x1f8),'event':_0x1c2cdb(0x197),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x4f18c6 instanceof Error?_0x4f18c6['message']:'Unknown\x20error','webhookData':_0x3c67dc})}});}catch(_0x4413b4){console[_0x1c2cdb(0x1ce)](_0x1c2cdb(0x157),_0x4413b4);}throw _0x4f18c6;}}async['processNodaWebhook'](_0x1f5d4f){const _0x24ef11=a52_0x5de975;try{loggerService_1[_0x24ef11(0x169)][_0x24ef11(0x207)]('noda',_0x1f5d4f),console[_0x24ef11(0x1eb)](_0x24ef11(0x186),_0x1f5d4f);const {PaymentId:_0x4dc7aa,Status:_0x5e1cc3,Signature:_0x5e54a7,MerchantPaymentId:_0x2f24cc,Reference:_0x524ab5,Amount:_0x464291,Currency:_0x43d4ac,CardId:_0x26b04b,Remitter:_0x1a385b,AdditionalData:_0x2b37a3,DetailedInfo:_0x38b35e,Method:_0x2249c6,BankId:_0x111d78,IsSenderBank:_0x44507e,BankTransactionId:_0x81264f,Settled:_0x4a4dc2,SettlementDate:_0x1a9bf7}=_0x1f5d4f;if(!_0x4dc7aa&&!_0x2f24cc){const _0x2c7b8f=new Error('Missing\x20required\x20webhook\x20data:\x20PaymentId\x20or\x20MerchantPaymentId');loggerService_1[_0x24ef11(0x169)][_0x24ef11(0x193)](_0x24ef11(0x1a1),_0x2c7b8f,_0x1f5d4f);throw _0x2c7b8f;}console[_0x24ef11(0x1eb)](_0x24ef11(0x159)),console[_0x24ef11(0x1eb)](_0x24ef11(0x18c)+_0x4dc7aa),console[_0x24ef11(0x1eb)](_0x24ef11(0x1ca)+_0x2f24cc);const _0x58be49=await database_1[_0x24ef11(0x183)]['payment']['findFirst']({'where':{'OR':[{'gatewayPaymentId':_0x4dc7aa},{'id':_0x2f24cc},{'gatewayOrderId':_0x2f24cc},{'orderId':_0x2f24cc}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x58be49){console[_0x24ef11(0x1eb)](_0x24ef11(0x1b9)),console[_0x24ef11(0x1eb)](_0x24ef11(0x188)+_0x4dc7aa),console['log']('\x20\x20\x20-\x20id:\x20'+_0x2f24cc),console[_0x24ef11(0x1eb)]('\x20\x20\x20-\x20gatewayOrderId:\x20'+_0x2f24cc),console[_0x24ef11(0x1eb)](_0x24ef11(0x177)+_0x2f24cc);const _0x14a2cb=await database_1['default'][_0x24ef11(0x218)][_0x24ef11(0x13c)]({'select':{'id':!![],'gatewayPaymentId':!![],'gatewayOrderId':!![],'orderId':!![],'gateway':!![],'status':!![],'createdAt':!![]},'orderBy':{'createdAt':'desc'},'take':0xa});console[_0x24ef11(0x1eb)]('üîç\x20Last\x2010\x20payments\x20in\x20database\x20for\x20debugging:'),_0x14a2cb['forEach'](_0x39ae56=>{const _0x493fd4=_0x24ef11;console[_0x493fd4(0x1eb)](_0x493fd4(0x13a)+_0x39ae56['id']+_0x493fd4(0x1d6)+_0x39ae56[_0x493fd4(0x1af)]+_0x493fd4(0x144)+_0x39ae56[_0x493fd4(0x191)]+_0x493fd4(0x1fd)+_0x39ae56[_0x493fd4(0x1c1)]+_0x493fd4(0x19e)+_0x39ae56[_0x493fd4(0x219)]+',\x20Status:\x20'+_0x39ae56[_0x493fd4(0x17c)]);});const _0x197ddc=new Error('Payment\x20not\x20found\x20for\x20PaymentId:\x20'+_0x4dc7aa+_0x24ef11(0x137)+_0x2f24cc);loggerService_1[_0x24ef11(0x169)][_0x24ef11(0x193)](_0x24ef11(0x1a1),_0x197ddc,_0x1f5d4f);throw _0x197ddc;}console[_0x24ef11(0x1eb)](_0x24ef11(0x1f3)+_0x58be49['id']+_0x24ef11(0x1a2)+_0x58be49[_0x24ef11(0x1af)]+')'),console['log'](_0x24ef11(0x188)+_0x58be49[_0x24ef11(0x191)]),console[_0x24ef11(0x1eb)]('\x20\x20\x20-\x20gatewayOrderId:\x20'+_0x58be49[_0x24ef11(0x1c1)]),console[_0x24ef11(0x1eb)](_0x24ef11(0x177)+_0x58be49[_0x24ef11(0x219)]);let _0x29e0ea=null,_0x39a73e=null;_0x1a385b&&(_0x29e0ea=_0x1a385b[_0x24ef11(0x21c)]||null,_0x39a73e=_0x1a385b[_0x24ef11(0x216)]||null);let _0xdb32d;switch(_0x5e1cc3?.[_0x24ef11(0x1d2)]()){case _0x24ef11(0x1c8):case _0x24ef11(0x1cb):case'paid':case'success':case'successful':_0x4a4dc2===_0x24ef11(0x1c0)||_0x4a4dc2===!![]?_0xdb32d=_0x24ef11(0x17a):_0xdb32d='PENDING';break;case _0x24ef11(0x1c7):case _0x24ef11(0x15f):case _0x24ef11(0x1b6):case _0x24ef11(0x1ce):case _0x24ef11(0x1f4):_0xdb32d='FAILED';break;case _0x24ef11(0x1a9):case _0x24ef11(0x150):_0xdb32d='EXPIRED';break;case'pending':case _0x24ef11(0x18e):case _0x24ef11(0x153):case _0x24ef11(0x15e):case _0x24ef11(0x1ee):default:_0xdb32d=_0x24ef11(0x1dc);break;}const _0x398490={'status':_0xdb32d,'updatedAt':new Date()};_0x29e0ea&&(_0x398490[_0x24ef11(0x16c)]=_0x29e0ea,console['log'](_0x24ef11(0x1db)+_0x29e0ea)),_0x39a73e&&(_0x398490[_0x24ef11(0x214)]=_0x39a73e,console['log'](_0x24ef11(0x1e3)+_0x39a73e)),_0x111d78&&(_0x398490[_0x24ef11(0x1bd)]=_0x111d78,console[_0x24ef11(0x1eb)](_0x24ef11(0x154)+_0x111d78)),_0x2249c6&&(_0x398490[_0x24ef11(0x1d5)]=_0x2249c6,console[_0x24ef11(0x1eb)](_0x24ef11(0x196)+_0x2249c6)),_0xdb32d===_0x24ef11(0x17a)&&_0x58be49[_0x24ef11(0x17c)]!==_0x24ef11(0x17a)&&(_0x398490[_0x24ef11(0x1cc)]=new Date(),console['log'](_0x24ef11(0x187)+_0x58be49['id']+_0x24ef11(0x1b4)+_0x398490[_0x24ef11(0x1cc)][_0x24ef11(0x155)]())),(_0x58be49[_0x24ef11(0x17c)]!==_0xdb32d||_0x29e0ea||_0x39a73e||_0x111d78||_0x2249c6)&&(await database_1['default'][_0x24ef11(0x218)]['update']({'where':{'id':_0x58be49['id']},'data':_0x398490}),_0x58be49[_0x24ef11(0x17c)]!==_0xdb32d&&(console[_0x24ef11(0x1eb)](_0x24ef11(0x1b7)+_0x58be49['id']+_0x24ef11(0x170)+_0x58be49[_0x24ef11(0x17c)]+_0x24ef11(0x132)+_0xdb32d),loggerService_1[_0x24ef11(0x169)][_0x24ef11(0x1c5)](_0x24ef11(0x1a1),_0x58be49['id'],_0x58be49['status'],_0xdb32d,_0x1f5d4f),_0xdb32d===_0x24ef11(0x17a)&&await this[_0x24ef11(0x203)]['handleSuccessfulPayment'](_0x58be49['id']),await this[_0x24ef11(0x172)](_0x58be49,_0xdb32d,_0x1f5d4f),await this['sendPaymentStatusNotification'](_0x58be49,_0xdb32d)),(_0x29e0ea||_0x39a73e||_0x111d78||_0x2249c6)&&console[_0x24ef11(0x1eb)](_0x24ef11(0x1b7)+_0x58be49['id']+'\x20details\x20updated:\x20iban='+_0x29e0ea+_0x24ef11(0x1f1)+_0x39a73e+_0x24ef11(0x1dd)+_0x111d78+_0x24ef11(0x1e7)+_0x2249c6)),await database_1['default'][_0x24ef11(0x1e6)][_0x24ef11(0x1f6)]({'data':{'paymentId':_0x58be49['id'],'shopId':_0x58be49[_0x24ef11(0x17e)],'event':'noda_'+_0x5e1cc3,'statusCode':0xc8,'responseBody':JSON[_0x24ef11(0x141)]({..._0x1f5d4f,'parsed':{'nodaPaymentId':_0x4dc7aa,'merchantPaymentId':_0x2f24cc,'status':_0x5e1cc3,'amount':_0x464291,'currency':_0x43d4ac,'method':_0x2249c6,'bankId':_0x111d78,'settled':_0x4a4dc2,'settlementDate':_0x1a9bf7,'remitterName':_0x1a385b?.[_0x24ef11(0x216)],'remitterIban':_0x1a385b?.['Iban']}})}}),console[_0x24ef11(0x1eb)]('Noda\x20webhook\x20processed\x20successfully\x20for\x20payment\x20'+_0x58be49['id']),console[_0x24ef11(0x1eb)](_0x24ef11(0x17d)+_0x5e1cc3+'\x20->\x20'+_0xdb32d+_0x24ef11(0x178)+_0x464291+'\x20'+_0x43d4ac+',\x20Method:\x20'+_0x2249c6),console[_0x24ef11(0x1eb)](_0x24ef11(0x1f0)+_0x111d78+_0x24ef11(0x1b8)+_0x4a4dc2+_0x24ef11(0x195)+_0x1a9bf7),console[_0x24ef11(0x1eb)](_0x24ef11(0x143)+_0x39a73e+'\x20('+_0x29e0ea+')');}catch(_0xe853e2){console[_0x24ef11(0x1ce)](_0x24ef11(0x20c),_0xe853e2),loggerService_1[_0x24ef11(0x169)]['logWebhookError'](_0x24ef11(0x1a1),_0xe853e2,_0x1f5d4f);try{await database_1['default']['webhookLog'][_0x24ef11(0x1f6)]({'data':{'paymentId':_0x24ef11(0x1f8),'shopId':_0x24ef11(0x1f8),'event':'noda_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0xe853e2 instanceof Error?_0xe853e2[_0x24ef11(0x18d)]:_0x24ef11(0x21a),'webhookData':_0x1f5d4f})}});}catch(_0xa5830d){console[_0x24ef11(0x1ce)](_0x24ef11(0x14e),_0xa5830d);}throw _0xe853e2;}}async[a52_0x5de975(0x14b)](_0x593344){const _0x441bde=a52_0x5de975;try{loggerService_1[_0x441bde(0x169)][_0x441bde(0x207)]('cointopay',_0x593344),console[_0x441bde(0x1eb)](_0x441bde(0x1da),_0x593344);const {order_id:_0x33e7e0,gateway_payment_id:_0x2fc5eb,status:_0x788b5d,amount:_0x3c29b9,currency:_0x13af7f,transaction_id:_0x1fdf48,confirmation_count:_0x4e8ef7}=_0x593344;if(!_0x33e7e0&&!_0x2fc5eb){const _0x54ae79=new Error('Missing\x20required\x20webhook\x20data:\x20order_id\x20or\x20gateway_payment_id');loggerService_1['loggerService'][_0x441bde(0x193)](_0x441bde(0x133),_0x54ae79,_0x593344);throw _0x54ae79;}const _0x449c47=await database_1[_0x441bde(0x183)][_0x441bde(0x218)]['findFirst']({'where':{'OR':[{'gatewayPaymentId':_0x2fc5eb},{'id':_0x33e7e0},{'gatewayOrderId':_0x33e7e0},{'orderId':_0x33e7e0}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x449c47){const _0xe97b4f=new Error(_0x441bde(0x211)+_0x33e7e0+',\x20gateway_payment_id:\x20'+_0x2fc5eb);loggerService_1[_0x441bde(0x169)][_0x441bde(0x193)](_0x441bde(0x133),_0xe97b4f,_0x593344);throw _0xe97b4f;}let _0x370918;switch(_0x788b5d?.[_0x441bde(0x1d2)]()){case _0x441bde(0x1d0):case _0x441bde(0x1cb):case _0x441bde(0x1c6):_0x370918='PAID';break;case _0x441bde(0x1c7):case _0x441bde(0x1b6):case'error':_0x370918=_0x441bde(0x1ba);break;case _0x441bde(0x1a9):case _0x441bde(0x150):_0x370918=_0x441bde(0x185);break;case'pending':case _0x441bde(0x20a):case _0x441bde(0x18e):default:_0x370918='PENDING';break;}const _0x2e9d9b={'status':_0x370918,'updatedAt':new Date()};_0x370918===_0x441bde(0x17a)&&_0x449c47['status']!==_0x441bde(0x17a)&&(_0x2e9d9b[_0x441bde(0x1cc)]=new Date(),console['log'](_0x441bde(0x187)+_0x449c47['id']+_0x441bde(0x1b4)+_0x2e9d9b[_0x441bde(0x1cc)][_0x441bde(0x155)]())),_0x449c47['status']!==_0x370918&&(await database_1[_0x441bde(0x183)][_0x441bde(0x218)][_0x441bde(0x1ef)]({'where':{'id':_0x449c47['id']},'data':_0x2e9d9b}),console[_0x441bde(0x1eb)](_0x441bde(0x1b7)+_0x449c47['id']+_0x441bde(0x170)+_0x449c47[_0x441bde(0x17c)]+'\x20to\x20'+_0x370918),loggerService_1['loggerService'][_0x441bde(0x1c5)](_0x441bde(0x133),_0x449c47['id'],_0x449c47[_0x441bde(0x17c)],_0x370918,_0x593344),_0x370918===_0x441bde(0x17a)&&await this[_0x441bde(0x203)]['handleSuccessfulPayment'](_0x449c47['id']),await this[_0x441bde(0x172)](_0x449c47,_0x370918,_0x593344),await this['sendPaymentStatusNotification'](_0x449c47,_0x370918)),await database_1[_0x441bde(0x183)][_0x441bde(0x1e6)][_0x441bde(0x1f6)]({'data':{'paymentId':_0x449c47['id'],'shopId':_0x449c47[_0x441bde(0x17e)],'event':'cointopay_'+_0x788b5d,'statusCode':0xc8,'responseBody':JSON[_0x441bde(0x141)](_0x593344)}}),console[_0x441bde(0x1eb)](_0x441bde(0x174)+_0x449c47['id']),console[_0x441bde(0x1eb)](_0x441bde(0x17d)+_0x788b5d+_0x441bde(0x20f)+_0x370918+_0x441bde(0x178)+_0x3c29b9+'\x20'+(_0x13af7f||_0x441bde(0x176)));}catch(_0x17f597){console[_0x441bde(0x1ce)](_0x441bde(0x15b),_0x17f597),loggerService_1['loggerService'][_0x441bde(0x193)](_0x441bde(0x133),_0x17f597,_0x593344);try{await database_1[_0x441bde(0x183)][_0x441bde(0x1e6)][_0x441bde(0x1f6)]({'data':{'paymentId':_0x441bde(0x1f8),'shopId':'unknown','event':_0x441bde(0x21b),'statusCode':0x1f4,'responseBody':JSON[_0x441bde(0x141)]({'error':_0x17f597 instanceof Error?_0x17f597[_0x441bde(0x18d)]:_0x441bde(0x21a),'webhookData':_0x593344})}});}catch(_0x3a3ae5){console[_0x441bde(0x1ce)](_0x441bde(0x13f),_0x3a3ae5);}throw _0x17f597;}}async[a52_0x5de975(0x16d)](_0xd11e51){const _0x360661=a52_0x5de975;try{loggerService_1[_0x360661(0x169)][_0x360661(0x207)](_0x360661(0x179),_0xd11e51),console[_0x360661(0x1eb)](_0x360661(0x1a0),_0xd11e51);const {payment_id:_0xfccfbb,order_id:_0x182720,status:_0xbbee6f,amount:_0x59b2d5,currency:_0x679815,region:_0x484bf0,customer_email:_0x41662a,customer_name:_0x3c515c,payment_method:_0x20de2b,transaction_id:_0x1777ed}=_0xd11e51;if(!_0x182720&&!_0xfccfbb){const _0x560208=new Error('Missing\x20required\x20webhook\x20data:\x20order_id\x20or\x20payment_id');loggerService_1[_0x360661(0x169)]['logWebhookError'](_0x360661(0x179),_0x560208,_0xd11e51);throw _0x560208;}console[_0x360661(0x1eb)]('üîç\x20Searching\x20for\x20KLYME\x20'+_0x484bf0+_0x360661(0x1d9)),console[_0x360661(0x1eb)](_0x360661(0x18c)+_0xfccfbb),console[_0x360661(0x1eb)](_0x360661(0x1de)+_0x182720);const _0x703592=await database_1['default']['payment']['findFirst']({'where':{'OR':[{'gatewayPaymentId':_0xfccfbb},{'id':_0x182720},{'gatewayOrderId':_0x182720},{'orderId':_0x182720}]},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x703592){console[_0x360661(0x1eb)](_0x360661(0x1d8)),console[_0x360661(0x1eb)](_0x360661(0x188)+_0xfccfbb),console[_0x360661(0x1eb)]('\x20\x20\x20-\x20id:\x20'+_0x182720),console[_0x360661(0x1eb)](_0x360661(0x1ae)+_0x182720),console[_0x360661(0x1eb)](_0x360661(0x177)+_0x182720);const _0x7fcbd5=new Error(_0x360661(0x131)+_0xfccfbb+_0x360661(0x1aa)+_0x182720);loggerService_1['loggerService'][_0x360661(0x193)](_0x360661(0x179),_0x7fcbd5,_0xd11e51);throw _0x7fcbd5;}console[_0x360661(0x1eb)](_0x360661(0x204)+_0x703592['id']+_0x360661(0x1a2)+_0x703592[_0x360661(0x1af)]+')');let _0x23507c;switch(_0xbbee6f?.[_0x360661(0x1d2)]()){case _0x360661(0x1d0):case'completed':case _0x360661(0x1c6):case'success':case _0x360661(0x19f):_0x23507c=_0x360661(0x17a);break;case _0x360661(0x1c7):case'canceled':case _0x360661(0x1b6):case _0x360661(0x1ce):case'rejected':_0x23507c=_0x360661(0x1ba);break;case'expired':case _0x360661(0x150):_0x23507c=_0x360661(0x185);break;case _0x360661(0x138):case _0x360661(0x18e):case _0x360661(0x153):case'processing':case _0x360661(0x1ee):default:_0x23507c='PENDING';break;}const _0x490bac={'status':_0x23507c,'updatedAt':new Date()};_0x20de2b&&(_0x490bac[_0x360661(0x1d5)]=_0x20de2b,console[_0x360661(0x1eb)](_0x360661(0x1c2)+_0x20de2b)),_0x23507c===_0x360661(0x17a)&&_0x703592[_0x360661(0x17c)]!==_0x360661(0x17a)&&(_0x490bac[_0x360661(0x1cc)]=new Date(),console[_0x360661(0x1eb)](_0x360661(0x187)+_0x703592['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x490bac[_0x360661(0x1cc)]['toISOString']())),(_0x703592['status']!==_0x23507c||_0x20de2b)&&(await database_1[_0x360661(0x183)]['payment'][_0x360661(0x1ef)]({'where':{'id':_0x703592['id']},'data':_0x490bac}),_0x703592[_0x360661(0x17c)]!==_0x23507c&&(console['log']('Payment\x20'+_0x703592['id']+_0x360661(0x170)+_0x703592[_0x360661(0x17c)]+_0x360661(0x132)+_0x23507c),loggerService_1['loggerService'][_0x360661(0x1c5)](_0x360661(0x179),_0x703592['id'],_0x703592[_0x360661(0x17c)],_0x23507c,_0xd11e51),_0x23507c==='PAID'&&await this[_0x360661(0x203)]['handleSuccessfulPayment'](_0x703592['id']),await this['sendShopWebhook'](_0x703592,_0x23507c,_0xd11e51),await this[_0x360661(0x202)](_0x703592,_0x23507c)),_0x20de2b&&console[_0x360661(0x1eb)](_0x360661(0x1b7)+_0x703592['id']+_0x360661(0x1bf)+_0x20de2b)),await database_1['default']['webhookLog'][_0x360661(0x1f6)]({'data':{'paymentId':_0x703592['id'],'shopId':_0x703592['shopId'],'event':_0x360661(0x156)+_0x484bf0?.[_0x360661(0x1d2)]()+'_'+_0xbbee6f,'statusCode':0xc8,'responseBody':JSON[_0x360661(0x141)]({..._0xd11e51,'parsed':{'klymePaymentId':_0xfccfbb,'orderId':_0x182720,'status':_0xbbee6f,'amount':_0x59b2d5,'currency':_0x679815,'region':_0x484bf0,'payment_method':_0x20de2b,'transaction_id':_0x1777ed}})}}),console[_0x360661(0x1eb)](_0x360661(0x17f)+_0x484bf0+_0x360661(0x136)+_0x703592['id']),console[_0x360661(0x1eb)](_0x360661(0x17d)+_0xbbee6f+_0x360661(0x20f)+_0x23507c+_0x360661(0x178)+_0x59b2d5+'\x20'+_0x679815+_0x360661(0x15d)+_0x484bf0),console['log'](_0x360661(0x13d)+_0x20de2b+_0x360661(0x1d1)+_0x1777ed);}catch(_0x56ed3f){console[_0x360661(0x1ce)](_0x360661(0x20b),_0x56ed3f),loggerService_1[_0x360661(0x169)]['logWebhookError']('klyme',_0x56ed3f,_0xd11e51);try{await database_1[_0x360661(0x183)]['webhookLog'][_0x360661(0x1f6)]({'data':{'paymentId':_0x360661(0x1f8),'shopId':_0x360661(0x1f8),'event':_0x360661(0x1f7),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x56ed3f instanceof Error?_0x56ed3f[_0x360661(0x18d)]:_0x360661(0x21a),'webhookData':_0xd11e51})}});}catch(_0x43fb19){console[_0x360661(0x1ce)](_0x360661(0x1bc),_0x43fb19);}throw _0x56ed3f;}}async[a52_0x5de975(0x172)](_0x36c090,_0x5be3de,_0x58358d){const _0x1dcdb0=a52_0x5de975,_0x227dda=Date['now']();try{const _0x411989=_0x36c090[_0x1dcdb0(0x182)],_0x5ac458=_0x411989['settings'];if(!_0x5ac458?.[_0x1dcdb0(0x13b)]){console[_0x1dcdb0(0x1eb)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x411989['id']);return;}const _0x5bab9c=this[_0x1dcdb0(0x1e0)](_0x5ac458[_0x1dcdb0(0x1b5)]),_0x25b4e9=_0x5be3de===_0x1dcdb0(0x17a)?_0x1dcdb0(0x1b1):_0x5be3de==='FAILED'?_0x1dcdb0(0x19b):_0x1dcdb0(0x20e);if(!_0x5bab9c['includes'](_0x25b4e9)){console[_0x1dcdb0(0x1eb)](_0x1dcdb0(0x1b0)+_0x25b4e9+_0x1dcdb0(0x140)+_0x411989['id']);return;}const _0x5b2823=(0x0,gateway_1['getGatewayIdByName'])(_0x36c090[_0x1dcdb0(0x1af)]),_0x4f196c={'event':_0x25b4e9,'payment':{'id':_0x36c090['id'],'order_id':_0x36c090[_0x1dcdb0(0x219)],'gateway_order_id':_0x36c090['gatewayOrderId'],'gateway':_0x5b2823||_0x36c090[_0x1dcdb0(0x1af)],'amount':_0x36c090[_0x1dcdb0(0x205)],'currency':_0x36c090[_0x1dcdb0(0x1a6)],'status':_0x5be3de[_0x1dcdb0(0x1d2)](),'customer_email':_0x36c090[_0x1dcdb0(0x149)],'customer_name':_0x36c090[_0x1dcdb0(0x165)],'card_last4':_0x36c090[_0x1dcdb0(0x18f)],'payment_method':_0x36c090[_0x1dcdb0(0x1d5)],'bank_id':_0x36c090[_0x1dcdb0(0x1bd)],'remitter_iban':_0x36c090[_0x1dcdb0(0x16c)],'remitter_name':_0x36c090[_0x1dcdb0(0x214)],'created_at':_0x36c090[_0x1dcdb0(0x1d3)],'updated_at':_0x36c090['updatedAt']}};console['log'](_0x1dcdb0(0x19d)+_0x5b2823+_0x1dcdb0(0x1f9)+_0x36c090[_0x1dcdb0(0x1af)]+')');const _0x49211b=await fetch(_0x5ac458['webhookUrl'],{'method':_0x1dcdb0(0x1e5),'headers':{'Content-Type':_0x1dcdb0(0x1ff),'User-Agent':_0x1dcdb0(0x1be)},'body':JSON[_0x1dcdb0(0x141)](_0x4f196c)}),_0x219d58=Date[_0x1dcdb0(0x1e1)]()-_0x227dda,_0x5ae541=_0x49211b['ok']?_0x1dcdb0(0x168):await _0x49211b[_0x1dcdb0(0x173)]();loggerService_1[_0x1dcdb0(0x169)][_0x1dcdb0(0x198)](_0x36c090[_0x1dcdb0(0x17e)],_0x5ac458[_0x1dcdb0(0x13b)],_0x25b4e9,_0x49211b['status'],_0x219d58,_0x4f196c),await database_1['default']['webhookLog'][_0x1dcdb0(0x1f6)]({'data':{'paymentId':_0x36c090['id'],'shopId':_0x36c090[_0x1dcdb0(0x17e)],'event':_0x1dcdb0(0x171)+_0x25b4e9,'statusCode':_0x49211b['status'],'responseBody':_0x5ae541}}),console[_0x1dcdb0(0x1eb)](_0x1dcdb0(0x134)+_0x5ac458[_0x1dcdb0(0x13b)]+_0x1dcdb0(0x16b)+_0x49211b[_0x1dcdb0(0x17c)]+'\x20('+_0x219d58+'ms)');}catch(_0x3eb952){const _0x5ac3b7=Date['now']()-_0x227dda;console['error'](_0x1dcdb0(0x215),_0x3eb952),loggerService_1[_0x1dcdb0(0x169)]['logShopWebhookError'](_0x36c090['shopId'],_0x36c090['shop']?.['settings']?.[_0x1dcdb0(0x13b)]||_0x1dcdb0(0x1f8),_0x1dcdb0(0x166),_0x3eb952,{});try{await database_1[_0x1dcdb0(0x183)][_0x1dcdb0(0x1e6)][_0x1dcdb0(0x1f6)]({'data':{'paymentId':_0x36c090['id'],'shopId':_0x36c090[_0x1dcdb0(0x17e)],'event':_0x1dcdb0(0x16a),'statusCode':0x0,'responseBody':JSON[_0x1dcdb0(0x141)]({'error':_0x3eb952 instanceof Error?_0x3eb952[_0x1dcdb0(0x18d)]:'Unknown\x20error','responseTime':_0x5ac3b7})}});}catch(_0x5316bd){console['error']('Failed\x20to\x20log\x20shop\x20webhook\x20error:',_0x5316bd);}}}async[a52_0x5de975(0x202)](_0x611b10,_0x318b9a){const _0x51f091=a52_0x5de975;try{console[_0x51f091(0x1eb)]('üì±\x20Processing\x20Telegram\x20notification\x20for\x20payment\x20'+_0x611b10['id']+_0x51f091(0x152)+_0x318b9a);const _0x57d62f=await database_1[_0x51f091(0x183)]['shopSettings']['findUnique']({'where':{'shopId':_0x611b10[_0x51f091(0x17e)]},'select':{'notificationPaymentSuccess':!![],'notificationPaymentFailed':!![],'notificationRefund':!![],'notificationPayout':!![],'notificationLogin':!![],'notificationApiError':!![]}});if(!_0x57d62f){console['log']('üì±\x20No\x20shop\x20settings\x20found\x20for\x20shop\x20'+_0x611b10['shopId']+_0x51f091(0x199));return;}console[_0x51f091(0x1eb)](_0x51f091(0x1fc),{'payment_success':_0x57d62f[_0x51f091(0x217)],'payment_failed':_0x57d62f[_0x51f091(0x180)],'refund':_0x57d62f[_0x51f091(0x212)],'payout':_0x57d62f[_0x51f091(0x146)],'login':_0x57d62f['notificationLogin'],'api_error':_0x57d62f[_0x51f091(0x18b)]});let _0x55b10f=![],_0x3e0134;switch(_0x318b9a){case _0x51f091(0x1dc):_0x57d62f['notificationPaymentFailed']&&(_0x55b10f=!![],_0x3e0134=_0x51f091(0x18e));break;case _0x51f091(0x17a):_0x57d62f[_0x51f091(0x217)]&&(_0x55b10f=!![],_0x3e0134=_0x51f091(0x1d0));break;case _0x51f091(0x1ba):_0x57d62f[_0x51f091(0x180)]&&(_0x55b10f=!![],_0x3e0134=_0x51f091(0x1b6));break;case _0x51f091(0x185):_0x57d62f[_0x51f091(0x180)]&&(_0x55b10f=!![],_0x3e0134=_0x51f091(0x1a9));break;case _0x51f091(0x21f):_0x57d62f['notificationRefund']&&(_0x55b10f=!![],_0x3e0134=_0x51f091(0x164));break;case _0x51f091(0x163):_0x57d62f[_0x51f091(0x212)]&&(_0x55b10f=!![],_0x3e0134='chargeback');break;default:console[_0x51f091(0x1eb)](_0x51f091(0x145)+_0x318b9a+',\x20skipping\x20Telegram\x20notification');return;}if(!_0x55b10f){console[_0x51f091(0x1eb)](_0x51f091(0x200)+_0x318b9a+'\x20in\x20shop\x20settings');return;}await telegramBotService_1[_0x51f091(0x1b3)][_0x51f091(0x15c)](_0x611b10['shopId'],_0x611b10,_0x3e0134),console[_0x51f091(0x1eb)](_0x51f091(0x1a7)+_0x611b10['id']);}catch(_0x23a0a7){console[_0x51f091(0x1ce)](_0x51f091(0x158),_0x23a0a7);}}async[a52_0x5de975(0x210)](_0xdfdf52,_0x5a60a3){const _0x288750=a52_0x5de975;console[_0x288750(0x1eb)]('Notification:\x20Payment\x20'+_0xdfdf52['id']+_0x288750(0x17b)+_0x5a60a3);}}exports[a52_0x5de975(0x192)]=WebhookService;