'use strict';function a56_0x581e(){const _0x250a2b=['🔄\x20Processing\x20MasterCard\x20webhook:','./telegramBotService','stringify','TesSoft\x20Payment\x20System/1.0','__esModule','amount','mastercard','Error\x20processing\x20Plisio\x20webhook:','remitterIban','10355992TRRhyk','💰\x20Removing\x20from\x20balance:\x20','$transaction','POST','CHARGEBACK','paymentMethod','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','CoinToPayService','webhookEvents','plisioService','now','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','chargeback','✅\x20Shop\x20','toUpperCase','\x20balance\x20updated:\x20','./gateways/mastercardService','created','orderId','Webhook\x20event\x20','__importDefault','payment','payment.failed','\x20-\x20','\x20status\x20','cointopay','Failed\x20to\x20send\x20shop\x20webhook:','isArray','MasterCardService','payment_method','./loggerService','EXPIRED','logShopWebhookError','💰\x20Payment\x20','PAID','sendShopWebhook','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','findUnique','47199OqLCbh','📝\x20Reason:\x20','shopId','chargebackAmount','processMasterCardWebhook','💰\x20Adding\x20to\x20balance:\x20','logShopWebhookSent','Success','\x20->\x20','customerName','default','📊\x20KLYME\x20webhook:\x20Payment\x20','loggerService','🏪\x20Shop\x20','74agZsOk','logWebhookProcessed','NodaService','Error\x20parsing\x20webhook\x20events:','🔄\x20Processing\x20Rapyd\x20webhook:','klymeService','\x20USDT\x20(chargeback\x20penalty)','6036304CgUfJR','coinToPayService','updatePaymentStatus','processKlymeWebhook','\x20status\x20to\x20','18358434oQKvvO','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','plisio','gatewayOrderId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20not\x20found','convertToUSDT','refund','./gateways/klymeService','Payment\x20','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','additionalInfo','webhookLog','settings','klyme','Error\x20processing\x20CoinToPay\x20webhook:','shop','processNodaWebhook','Payment\x20not\x20found\x20for\x20MasterCard\x20webhook:\x20','./gateways/plisioService','toFixed','amountUSDT','2633226kQrmGi','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','processPlisioGatewayWebhook','processWebhook','🔄\x20Processing\x20Noda\x20webhook:','5rczgho','ms)','failed','bankId','webhookUrl','paymentId','WebhookService','masterCardService','processRapydWebhook','📊\x20Plisio\x20webhook:\x20Payment\x20','💰\x20Converting\x20','findFirst','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','paid','\x20USDT','username','log','toLowerCase','RapydService','Error\x20processing\x20KLYME\x20webhook:','Error\x20processing\x20Rapyd\x20webhook:','parse','🔄\x20Updating\x20payment\x20','./currencyService','paidAt','sendPaymentNotification','rapydService','plisio_gateway','noda','currencyService','currency','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','update','\x20USDT\x20(payment\x20became\x20PAID)','updatedAt','defineProperty','\x20not\x20enabled\x20for\x20shop\x20','txUrls','🔄\x20Processing\x20Plisio\x20webhook:','📤\x20Shop\x20webhook\x20sent\x20to\x20','logWebhookError','sendPaymentStatusNotification','PlisioService','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','failureMessage','error','Error\x20processing\x20MasterCard\x20webhook:','460348CJikba','📊\x20Noda\x20webhook:\x20Payment\x20','KlymeService','remitterName','balance','\x20=\x20','cardLast4','💸\x20Additional\x20chargeback\x20penalty:\x20-','create','./gateways/rapydService','includes','Error\x20processing\x20Noda\x20webhook:','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','application/json','3510878Mahgsp','toISOString','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','status','expired','../config/database','\x20current\x20balance:\x20','telegramBotService'];a56_0x581e=function(){return _0x250a2b;};return a56_0x581e();}const a56_0x601527=a56_0x1d6e;(function(_0x2153a5,_0x4e996f){const _0x46781c=a56_0x1d6e,_0xb258c7=_0x2153a5();while(!![]){try{const _0x11937f=parseInt(_0x46781c(0x1bf))/0x1+parseInt(_0x46781c(0x212))/0x2*(-parseInt(_0x46781c(0x204))/0x3)+-parseInt(_0x46781c(0x219))/0x4+-parseInt(_0x46781c(0x23a))/0x5*(parseInt(_0x46781c(0x234))/0x6)+-parseInt(_0x46781c(0x1cd))/0x7+parseInt(_0x46781c(0x1de))/0x8+parseInt(_0x46781c(0x21e))/0x9;if(_0x11937f===_0x4e996f)break;else _0xb258c7['push'](_0xb258c7['shift']());}catch(_0x246d17){_0xb258c7['push'](_0xb258c7['shift']());}}}(a56_0x581e,0xba4ab));function a56_0x1d6e(_0x38ca39,_0x30d1d9){const _0x581eed=a56_0x581e();return a56_0x1d6e=function(_0x1d6efc,_0x1e09c9){_0x1d6efc=_0x1d6efc-0x192;let _0x2cc1a8=_0x581eed[_0x1d6efc];return _0x2cc1a8;},a56_0x1d6e(_0x38ca39,_0x30d1d9);}var __importDefault=this&&this[a56_0x601527(0x1f2)]||function(_0x4aae50){const _0x1bdbb6=a56_0x601527;return _0x4aae50&&_0x4aae50[_0x1bdbb6(0x1d9)]?_0x4aae50:{'default':_0x4aae50};};Object[a56_0x601527(0x1b2)](exports,a56_0x601527(0x1d9),{'value':!![]}),exports[a56_0x601527(0x195)]=void 0x0;const database_1=__importDefault(require(a56_0x601527(0x1d2))),plisioService_1=require(a56_0x601527(0x231)),rapydService_1=require(a56_0x601527(0x1c8)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require(a56_0x601527(0x226)),mastercardService_1=require(a56_0x601527(0x1ee)),telegramBotService_1=require(a56_0x601527(0x1d6)),currencyService_1=require(a56_0x601527(0x1a6)),loggerService_1=require(a56_0x601527(0x1fc));class WebhookService{constructor(){const _0x1d89f8=a56_0x601527;this[_0x1d89f8(0x1e7)]=new plisioService_1[(_0x1d89f8(0x1b9))](),this[_0x1d89f8(0x1a9)]=new rapydService_1[(_0x1d89f8(0x1a1))](),this['nodaService']=new nodaService_1[(_0x1d89f8(0x214))](),this[_0x1d89f8(0x21a)]=new coinToPayService_1[(_0x1d89f8(0x1e5))](),this[_0x1d89f8(0x217)]=new klymeService_1[(_0x1d89f8(0x1c1))](),this[_0x1d89f8(0x196)]=new mastercardService_1[(_0x1d89f8(0x1fa))]();}async[a56_0x601527(0x21b)](_0x2105e4,_0x1bbe86,_0x3d116f){const _0x5c2fe7=a56_0x601527;console[_0x5c2fe7(0x19f)](_0x5c2fe7(0x1a5)+_0x2105e4+_0x5c2fe7(0x21d)+_0x1bbe86),await database_1[_0x5c2fe7(0x20e)][_0x5c2fe7(0x1e0)](async _0xec5ec9=>{const _0x6e3588=_0x5c2fe7,_0xda531a=await _0xec5ec9['payment'][_0x6e3588(0x203)]({'where':{'id':_0x2105e4},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xda531a)throw new Error(_0x6e3588(0x227)+_0x2105e4+_0x6e3588(0x223));const _0x468866=_0xda531a[_0x6e3588(0x1d0)],_0x34b976=_0xda531a[_0x6e3588(0x22e)];console[_0x6e3588(0x19f)](_0x6e3588(0x1ff)+_0x2105e4+':\x20'+_0x468866+_0x6e3588(0x20c)+_0x1bbe86),console[_0x6e3588(0x19f)](_0x6e3588(0x211)+_0x34b976[_0x6e3588(0x19e)]+_0x6e3588(0x1d3)+_0x34b976['balance']+_0x6e3588(0x19d));const _0x590c4f={'status':_0x1bbe86[_0x6e3588(0x1ec)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x3d116f?.[_0x6e3588(0x1bc)]&&(_0x590c4f[_0x6e3588(0x1bc)]=_0x3d116f['failureMessage']);_0x3d116f?.[_0x6e3588(0x1b4)]&&(_0x590c4f[_0x6e3588(0x1b4)]=JSON[_0x6e3588(0x1d7)](_0x3d116f[_0x6e3588(0x1b4)]));_0x3d116f?.['cardLast4']&&(_0x590c4f[_0x6e3588(0x1c5)]=_0x3d116f[_0x6e3588(0x1c5)]);_0x3d116f?.[_0x6e3588(0x1e3)]&&(_0x590c4f['paymentMethod']=_0x3d116f[_0x6e3588(0x1e3)]);_0x3d116f?.[_0x6e3588(0x192)]&&(_0x590c4f[_0x6e3588(0x192)]=_0x3d116f['bankId']);_0x3d116f?.['remitterIban']&&(_0x590c4f[_0x6e3588(0x1dd)]=_0x3d116f[_0x6e3588(0x1dd)]);_0x3d116f?.[_0x6e3588(0x1c2)]&&(_0x590c4f[_0x6e3588(0x1c2)]=_0x3d116f['remitterName']);let _0x3a1a02=_0x34b976[_0x6e3588(0x1c3)],_0x222b0c='';if(_0x1bbe86['toUpperCase']()===_0x6e3588(0x200)&&_0x468866!==_0x6e3588(0x200)){const _0x4970b4=await currencyService_1[_0x6e3588(0x1ac)][_0x6e3588(0x224)](_0xda531a[_0x6e3588(0x1da)],_0xda531a[_0x6e3588(0x1ad)]);_0x3a1a02+=_0x4970b4,_0x222b0c='+'+_0x4970b4[_0x6e3588(0x232)](0x6)+_0x6e3588(0x1b0),_0x590c4f['amountUSDT']=_0x4970b4,_0x590c4f[_0x6e3588(0x1a7)]=new Date(),console['log'](_0x6e3588(0x199)+_0xda531a[_0x6e3588(0x1da)]+'\x20'+_0xda531a[_0x6e3588(0x1ad)]+_0x6e3588(0x20c)+_0x4970b4[_0x6e3588(0x232)](0x6)+_0x6e3588(0x19d)),console[_0x6e3588(0x19f)](_0x6e3588(0x209)+_0x34b976[_0x6e3588(0x1c3)]+'\x20+\x20'+_0x4970b4[_0x6e3588(0x232)](0x6)+_0x6e3588(0x1c4)+_0x3a1a02[_0x6e3588(0x232)](0x6)+_0x6e3588(0x19d));}else{if(_0x468866===_0x6e3588(0x200)&&_0x1bbe86[_0x6e3588(0x1ec)]()!==_0x6e3588(0x200)){const _0xc489a=_0xda531a[_0x6e3588(0x233)];_0xc489a&&(_0x3a1a02-=_0xc489a,_0x222b0c='-'+_0xc489a['toFixed'](0x6)+_0x6e3588(0x235),_0x590c4f['amountUSDT']=null,_0x590c4f['paidAt']=null,console[_0x6e3588(0x19f)](_0x6e3588(0x1df)+_0x34b976[_0x6e3588(0x1c3)]+_0x6e3588(0x1f5)+_0xc489a['toFixed'](0x6)+_0x6e3588(0x1c4)+_0x3a1a02[_0x6e3588(0x232)](0x6)+_0x6e3588(0x19d)));}}if(_0x1bbe86[_0x6e3588(0x1ec)]()===_0x6e3588(0x1e2)){const _0x16332c=_0x3d116f?.[_0x6e3588(0x207)]||0x0;_0x16332c>0x0&&(_0x3a1a02-=_0x16332c,_0x222b0c+='\x20and\x20-'+_0x16332c[_0x6e3588(0x232)](0x6)+_0x6e3588(0x218),_0x590c4f[_0x6e3588(0x207)]=_0x16332c,console['log'](_0x6e3588(0x1c6)+_0x16332c['toFixed'](0x6)+_0x6e3588(0x19d)),console['log']('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x3a1a02[_0x6e3588(0x232)](0x6)+_0x6e3588(0x19d)));}const _0x5d8eac=await _0xec5ec9[_0x6e3588(0x1f3)][_0x6e3588(0x1af)]({'where':{'id':_0x2105e4},'data':_0x590c4f});_0x3a1a02!==_0x34b976[_0x6e3588(0x1c3)]&&(await _0xec5ec9[_0x6e3588(0x22e)]['update']({'where':{'id':_0x34b976['id']},'data':{'balance':_0x3a1a02}}),console['log'](_0x6e3588(0x1eb)+_0x34b976['username']+_0x6e3588(0x1ed)+_0x34b976['balance'][_0x6e3588(0x232)](0x6)+_0x6e3588(0x20c)+_0x3a1a02[_0x6e3588(0x232)](0x6)+_0x6e3588(0x19d)),console['log'](_0x6e3588(0x205)+_0x222b0c)),await _0xec5ec9[_0x6e3588(0x22a)][_0x6e3588(0x1c7)]({'data':{'paymentId':_0x2105e4,'shopId':_0x34b976['id'],'event':'webhook_status_change_'+_0x1bbe86[_0x6e3588(0x1a0)](),'statusCode':0xc8,'responseBody':JSON[_0x6e3588(0x1d7)]({'oldStatus':_0x468866,'newStatus':_0x1bbe86[_0x6e3588(0x1ec)](),'balanceChange':_0x222b0c||'no\x20balance\x20change','oldBalance':_0x34b976['balance'],'newBalance':_0x3a1a02,'amountUSDT':_0x590c4f[_0x6e3588(0x233)],'additionalData':_0x3d116f,'timestamp':new Date()[_0x6e3588(0x1ce)]()})}}),await this[_0x6e3588(0x201)]({..._0xda531a,..._0x5d8eac,'shop':_0x34b976},_0x1bbe86[_0x6e3588(0x1ec)]()),await this[_0x6e3588(0x1b8)]({..._0xda531a,..._0x5d8eac},_0x1bbe86[_0x6e3588(0x1ec)]());});}async['processPlisioWebhook'](_0x466047){const _0x24a400=a56_0x601527;console[_0x24a400(0x19f)](_0x24a400(0x1b5),_0x466047);try{const _0x402551=await this[_0x24a400(0x1e7)][_0x24a400(0x238)](_0x466047);if(!_0x402551['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x18954a=await database_1[_0x24a400(0x20e)][_0x24a400(0x1f3)][_0x24a400(0x19a)]({'where':{'gatewayOrderId':_0x402551['paymentId']}});if(!_0x18954a){console[_0x24a400(0x1bd)](_0x24a400(0x236)+_0x402551[_0x24a400(0x194)]);return;}console[_0x24a400(0x19f)](_0x24a400(0x198)+_0x18954a['id']+'\x20status\x20'+_0x402551[_0x24a400(0x1d0)]),await this[_0x24a400(0x21b)](_0x18954a['id'],_0x402551[_0x24a400(0x1d0)],{'txUrls':_0x402551[_0x24a400(0x1b4)]}),loggerService_1[_0x24a400(0x210)][_0x24a400(0x213)](_0x24a400(0x220),_0x18954a['id'],_0x18954a[_0x24a400(0x1d0)],_0x402551['status'],_0x466047);}catch(_0x4779b8){console[_0x24a400(0x1bd)](_0x24a400(0x1dc),_0x4779b8),loggerService_1[_0x24a400(0x210)][_0x24a400(0x1b7)](_0x24a400(0x220),_0x4779b8,_0x466047);throw _0x4779b8;}}async[a56_0x601527(0x237)](_0x5db63f){const _0x7fd7ea=a56_0x601527;console[_0x7fd7ea(0x19f)](_0x7fd7ea(0x1e4),_0x5db63f);try{const _0x1aa335=await this[_0x7fd7ea(0x1e7)][_0x7fd7ea(0x238)](_0x5db63f);if(!_0x1aa335[_0x7fd7ea(0x194)])throw new Error(_0x7fd7ea(0x1cb));const _0x17a222=await database_1[_0x7fd7ea(0x20e)][_0x7fd7ea(0x1f3)][_0x7fd7ea(0x19a)]({'where':{'gatewayOrderId':_0x1aa335[_0x7fd7ea(0x194)]}});if(!_0x17a222){console[_0x7fd7ea(0x1bd)](_0x7fd7ea(0x1ba)+_0x1aa335[_0x7fd7ea(0x194)]);return;}console[_0x7fd7ea(0x19f)](_0x7fd7ea(0x228)+_0x17a222['id']+_0x7fd7ea(0x1f6)+_0x1aa335[_0x7fd7ea(0x1d0)]),await this[_0x7fd7ea(0x21b)](_0x17a222['id'],_0x1aa335['status'],{'txUrls':_0x1aa335['txUrls']}),loggerService_1[_0x7fd7ea(0x210)]['logWebhookProcessed'](_0x7fd7ea(0x1aa),_0x17a222['id'],_0x17a222[_0x7fd7ea(0x1d0)],_0x1aa335[_0x7fd7ea(0x1d0)],_0x5db63f);}catch(_0x523ec3){console['error'](_0x7fd7ea(0x1ae),_0x523ec3),loggerService_1['loggerService']['logWebhookError']('plisio_gateway',_0x523ec3,_0x5db63f);throw _0x523ec3;}}async[a56_0x601527(0x197)](_0x982ae9){const _0x2a0609=a56_0x601527;console[_0x2a0609(0x19f)](_0x2a0609(0x216),_0x982ae9);try{const _0x5e1451=await this[_0x2a0609(0x1a9)][_0x2a0609(0x238)](_0x982ae9);if(!_0x5e1451[_0x2a0609(0x194)])throw new Error(_0x2a0609(0x1bb));const _0x3fd195=await database_1[_0x2a0609(0x20e)][_0x2a0609(0x1f3)][_0x2a0609(0x19a)]({'where':{'gatewayOrderId':_0x5e1451[_0x2a0609(0x194)]}});if(!_0x3fd195){console[_0x2a0609(0x1bd)](_0x2a0609(0x1cf)+_0x5e1451[_0x2a0609(0x194)]);return;}console[_0x2a0609(0x19f)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x3fd195['id']+_0x2a0609(0x1f6)+_0x5e1451[_0x2a0609(0x1d0)]),await this[_0x2a0609(0x21b)](_0x3fd195['id'],_0x5e1451[_0x2a0609(0x1d0)],{'failureMessage':_0x5e1451[_0x2a0609(0x1bc)],'cardLast4':_0x5e1451[_0x2a0609(0x229)]?.['cardLast4'],'paymentMethod':_0x5e1451[_0x2a0609(0x229)]?.[_0x2a0609(0x1e3)]}),loggerService_1[_0x2a0609(0x210)][_0x2a0609(0x213)]('rapyd',_0x3fd195['id'],_0x3fd195[_0x2a0609(0x1d0)],_0x5e1451['status'],_0x982ae9);}catch(_0xadd71d){console['error'](_0x2a0609(0x1a3),_0xadd71d),loggerService_1[_0x2a0609(0x210)][_0x2a0609(0x1b7)]('rapyd',_0xadd71d,_0x982ae9);throw _0xadd71d;}}async[a56_0x601527(0x22f)](_0x208c0e){const _0x233ddc=a56_0x601527;console['log'](_0x233ddc(0x239),_0x208c0e);try{const _0x37aa9a=await this['nodaService']['processWebhook'](_0x208c0e);if(!_0x37aa9a['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Noda\x20webhook');const _0x54b5eb=await database_1[_0x233ddc(0x20e)][_0x233ddc(0x1f3)][_0x233ddc(0x19a)]({'where':{'gatewayOrderId':_0x37aa9a['paymentId']}});if(!_0x54b5eb){console[_0x233ddc(0x1bd)]('Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20'+_0x37aa9a[_0x233ddc(0x194)]);return;}console[_0x233ddc(0x19f)](_0x233ddc(0x1c0)+_0x54b5eb['id']+'\x20status\x20'+_0x37aa9a['status']),await this[_0x233ddc(0x21b)](_0x54b5eb['id'],_0x37aa9a[_0x233ddc(0x1d0)],{'bankId':_0x37aa9a[_0x233ddc(0x229)]?.['bankId'],'remitterIban':_0x37aa9a[_0x233ddc(0x229)]?.['remitterIban'],'remitterName':_0x37aa9a[_0x233ddc(0x229)]?.['remitterName']}),loggerService_1[_0x233ddc(0x210)][_0x233ddc(0x213)](_0x233ddc(0x1ab),_0x54b5eb['id'],_0x54b5eb[_0x233ddc(0x1d0)],_0x37aa9a[_0x233ddc(0x1d0)],_0x208c0e);}catch(_0x5028c3){console[_0x233ddc(0x1bd)](_0x233ddc(0x1ca),_0x5028c3),loggerService_1[_0x233ddc(0x210)][_0x233ddc(0x1b7)](_0x233ddc(0x1ab),_0x5028c3,_0x208c0e);throw _0x5028c3;}}async['processCoinToPayWebhook'](_0x20403a){const _0x52d49e=a56_0x601527;console[_0x52d49e(0x19f)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x20403a);try{const _0x5326c0=await this[_0x52d49e(0x21a)][_0x52d49e(0x238)](_0x20403a);if(!_0x5326c0[_0x52d49e(0x194)])throw new Error(_0x52d49e(0x1e9));const _0x5a7c0d=await database_1[_0x52d49e(0x20e)][_0x52d49e(0x1f3)][_0x52d49e(0x19a)]({'where':{'gatewayOrderId':_0x5326c0['paymentId']}});if(!_0x5a7c0d){console['error'](_0x52d49e(0x202)+_0x5326c0[_0x52d49e(0x194)]);return;}console[_0x52d49e(0x19f)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x5a7c0d['id']+'\x20status\x20'+_0x5326c0['status']),await this[_0x52d49e(0x21b)](_0x5a7c0d['id'],_0x5326c0[_0x52d49e(0x1d0)]),loggerService_1[_0x52d49e(0x210)]['logWebhookProcessed'](_0x52d49e(0x1f7),_0x5a7c0d['id'],_0x5a7c0d['status'],_0x5326c0['status'],_0x20403a);}catch(_0x443cca){console[_0x52d49e(0x1bd)](_0x52d49e(0x22d),_0x443cca),loggerService_1[_0x52d49e(0x210)][_0x52d49e(0x1b7)](_0x52d49e(0x1f7),_0x443cca,_0x20403a);throw _0x443cca;}}async[a56_0x601527(0x21c)](_0x33f22d){const _0x4f4855=a56_0x601527;console['log']('🔄\x20Processing\x20KLYME\x20webhook:',_0x33f22d);try{const _0x69207d=await this[_0x4f4855(0x217)][_0x4f4855(0x238)](_0x33f22d);if(!_0x69207d['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x58bb9a=await database_1[_0x4f4855(0x20e)][_0x4f4855(0x1f3)][_0x4f4855(0x19a)]({'where':{'gatewayOrderId':_0x69207d['paymentId']}});if(!_0x58bb9a){console[_0x4f4855(0x1bd)](_0x4f4855(0x19b)+_0x69207d[_0x4f4855(0x194)]);return;}console[_0x4f4855(0x19f)](_0x4f4855(0x20f)+_0x58bb9a['id']+_0x4f4855(0x1f6)+_0x69207d['status']),await this[_0x4f4855(0x21b)](_0x58bb9a['id'],_0x69207d[_0x4f4855(0x1d0)],{'paymentMethod':_0x69207d['additionalInfo']?.[_0x4f4855(0x1fb)]}),loggerService_1[_0x4f4855(0x210)]['logWebhookProcessed'](_0x4f4855(0x22c),_0x58bb9a['id'],_0x58bb9a[_0x4f4855(0x1d0)],_0x69207d[_0x4f4855(0x1d0)],_0x33f22d);}catch(_0x3cb3a4){console[_0x4f4855(0x1bd)](_0x4f4855(0x1a2),_0x3cb3a4),loggerService_1[_0x4f4855(0x210)][_0x4f4855(0x1b7)](_0x4f4855(0x22c),_0x3cb3a4,_0x33f22d);throw _0x3cb3a4;}}async[a56_0x601527(0x208)](_0x1d7fcd){const _0x4d55b5=a56_0x601527;console[_0x4d55b5(0x19f)](_0x4d55b5(0x1d5),_0x1d7fcd);try{const _0x32403e=await this[_0x4d55b5(0x196)][_0x4d55b5(0x238)](_0x1d7fcd);if(!_0x32403e[_0x4d55b5(0x194)])throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');const _0x29657b=await database_1[_0x4d55b5(0x20e)][_0x4d55b5(0x1f3)]['findFirst']({'where':{'gatewayOrderId':_0x32403e['paymentId']}});if(!_0x29657b){console[_0x4d55b5(0x1bd)](_0x4d55b5(0x230)+_0x32403e['paymentId']);return;}console['log']('📊\x20MasterCard\x20webhook:\x20Payment\x20'+_0x29657b['id']+_0x4d55b5(0x1f6)+_0x32403e[_0x4d55b5(0x1d0)]),await this['updatePaymentStatus'](_0x29657b['id'],_0x32403e[_0x4d55b5(0x1d0)]),loggerService_1['loggerService'][_0x4d55b5(0x213)](_0x4d55b5(0x1db),_0x29657b['id'],_0x29657b[_0x4d55b5(0x1d0)],_0x32403e[_0x4d55b5(0x1d0)],_0x1d7fcd);}catch(_0x254e9c){console[_0x4d55b5(0x1bd)](_0x4d55b5(0x1be),_0x254e9c),loggerService_1[_0x4d55b5(0x210)][_0x4d55b5(0x1b7)](_0x4d55b5(0x1db),_0x254e9c,_0x1d7fcd);throw _0x254e9c;}}async[a56_0x601527(0x201)](_0x39e025,_0x126b34){const _0x5eaef8=a56_0x601527,_0x4db3fa=Date[_0x5eaef8(0x1e8)]();try{const _0x4ef596=_0x39e025[_0x5eaef8(0x22e)],_0x14f79e=_0x4ef596[_0x5eaef8(0x22b)];if(!_0x14f79e?.[_0x5eaef8(0x193)]){console['log'](_0x5eaef8(0x222)+_0x4ef596['id']);return;}const _0x400a99=_0x126b34===_0x5eaef8(0x200)?'payment.success':_0x126b34==='FAILED'?_0x5eaef8(0x1f4):_0x126b34===_0x5eaef8(0x1fd)?_0x5eaef8(0x1f4):_0x126b34===_0x5eaef8(0x1e2)?'payment.failed':_0x126b34==='REFUND'?_0x5eaef8(0x1f4):'payment.pending';let _0x493cd3=[];if(_0x14f79e[_0x5eaef8(0x1e6)])try{_0x493cd3=Array[_0x5eaef8(0x1f9)](_0x14f79e['webhookEvents'])?_0x14f79e['webhookEvents']:JSON[_0x5eaef8(0x1a4)](_0x14f79e['webhookEvents']);}catch(_0x13e4bc){console['error'](_0x5eaef8(0x215),_0x13e4bc),_0x493cd3=[];}if(!_0x493cd3[_0x5eaef8(0x1c9)](_0x400a99)){console[_0x5eaef8(0x19f)](_0x5eaef8(0x1f1)+_0x400a99+_0x5eaef8(0x1b3)+_0x4ef596['id']);return;}const _0x1d9d19={'event':_0x400a99,'payment':{'id':_0x39e025['id'],'order_id':_0x39e025[_0x5eaef8(0x1f0)],'gateway_order_id':_0x39e025[_0x5eaef8(0x221)],'gateway':_0x39e025['gateway'],'amount':_0x39e025[_0x5eaef8(0x1da)],'currency':_0x39e025['currency'],'status':_0x126b34[_0x5eaef8(0x1a0)](),'customer_email':_0x39e025['customerEmail'],'customer_name':_0x39e025[_0x5eaef8(0x20d)],'failure_message':_0x39e025[_0x5eaef8(0x1bc)],'tx_urls':_0x39e025[_0x5eaef8(0x1b4)]?JSON[_0x5eaef8(0x1a4)](_0x39e025[_0x5eaef8(0x1b4)]):null,'created_at':_0x39e025['createdAt'],'updated_at':_0x39e025[_0x5eaef8(0x1b1)]}},_0x553153=await fetch(_0x14f79e[_0x5eaef8(0x193)],{'method':_0x5eaef8(0x1e1),'headers':{'Content-Type':_0x5eaef8(0x1cc),'User-Agent':_0x5eaef8(0x1d8)},'body':JSON['stringify'](_0x1d9d19)}),_0x31579e=Date[_0x5eaef8(0x1e8)]()-_0x4db3fa,_0x39a88a=_0x553153['ok']?_0x5eaef8(0x20b):await _0x553153['text']();loggerService_1[_0x5eaef8(0x210)][_0x5eaef8(0x20a)](_0x39e025[_0x5eaef8(0x206)],_0x14f79e[_0x5eaef8(0x193)],_0x400a99,_0x553153[_0x5eaef8(0x1d0)],_0x31579e,_0x1d9d19),console[_0x5eaef8(0x19f)](_0x5eaef8(0x1b6)+_0x14f79e[_0x5eaef8(0x193)]+'\x20with\x20status\x20'+_0x553153[_0x5eaef8(0x1d0)]+'\x20('+_0x31579e+_0x5eaef8(0x23b));}catch(_0x1a627f){console[_0x5eaef8(0x1bd)](_0x5eaef8(0x1f8),_0x1a627f),loggerService_1[_0x5eaef8(0x210)][_0x5eaef8(0x1fe)](_0x39e025['shopId'],_0x39e025[_0x5eaef8(0x22e)]?.[_0x5eaef8(0x22b)]?.[_0x5eaef8(0x193)]||'unknown','webhook_send',_0x1a627f,{});}}async[a56_0x601527(0x1b8)](_0x2c13f1,_0x361dce){const _0x3862b9=a56_0x601527;try{const _0x47d31b={'PENDING':_0x3862b9(0x1ef),'PROCESSING':'processing','PAID':_0x3862b9(0x19c),'FAILED':_0x3862b9(0x23c),'EXPIRED':_0x3862b9(0x1d1),'REFUND':_0x3862b9(0x225),'CHARGEBACK':_0x3862b9(0x1ea)},_0x4279b0=_0x47d31b[_0x361dce];if(!_0x4279b0||_0x4279b0===_0x3862b9(0x1ef))return;await telegramBotService_1[_0x3862b9(0x1d4)][_0x3862b9(0x1a8)](_0x2c13f1[_0x3862b9(0x206)],_0x2c13f1,_0x4279b0);}catch(_0x121ace){console[_0x3862b9(0x1bd)](_0x3862b9(0x21f),_0x121ace);}}}exports[a56_0x601527(0x195)]=WebhookService;