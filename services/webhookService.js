'use strict';const a64_0x40996c=a64_0x2b99;(function(_0x58008c,_0xad1138){const _0x2063a3=a64_0x2b99,_0xbbce04=_0x58008c();while(!![]){try{const _0xec8548=-parseInt(_0x2063a3(0x187))/0x1+-parseInt(_0x2063a3(0x242))/0x2+parseInt(_0x2063a3(0x213))/0x3*(-parseInt(_0x2063a3(0x1e7))/0x4)+-parseInt(_0x2063a3(0x182))/0x5+parseInt(_0x2063a3(0x291))/0x6*(parseInt(_0x2063a3(0x28c))/0x7)+parseInt(_0x2063a3(0x299))/0x8+parseInt(_0x2063a3(0x220))/0x9*(parseInt(_0x2063a3(0x253))/0xa);if(_0xec8548===_0xad1138)break;else _0xbbce04['push'](_0xbbce04['shift']());}catch(_0x7057b2){_0xbbce04['push'](_0xbbce04['shift']());}}}(a64_0x5009,0xb87ed));function a64_0x2b99(_0x2a3b3a,_0x5e1159){const _0x500994=a64_0x5009();return a64_0x2b99=function(_0x2b9951,_0x43e178){_0x2b9951=_0x2b9951-0x175;let _0x146e62=_0x500994[_0x2b9951];return _0x146e62;},a64_0x2b99(_0x2a3b3a,_0x5e1159);}var __importDefault=this&&this[a64_0x40996c(0x1d8)]||function(_0x33619f){const _0x4a97d2=a64_0x40996c;return _0x33619f&&_0x33619f[_0x4a97d2(0x1dd)]?_0x33619f:{'default':_0x33619f};};Object[a64_0x40996c(0x23c)](exports,a64_0x40996c(0x1dd),{'value':!![]}),exports[a64_0x40996c(0x1d5)]=void 0x0;const database_1=__importDefault(require(a64_0x40996c(0x193))),plisioService_1=require(a64_0x40996c(0x1e1)),rapydService_1=require(a64_0x40996c(0x216)),nodaService_1=require(a64_0x40996c(0x261)),coinToPayService_1=require(a64_0x40996c(0x20c)),coinToPay2Service_1=require(a64_0x40996c(0x1bb)),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a64_0x40996c(0x1ea)),amerService_1=require(a64_0x40996c(0x21e)),ampayService_1=require(a64_0x40996c(0x1f4)),telegramBotService_1=require('./telegramBotService'),currencyService_1=require(a64_0x40996c(0x27e)),loggerService_1=require(a64_0x40996c(0x25a));class WebhookService{constructor(){const _0x349616=a64_0x40996c;this['plisioService']=new plisioService_1[(_0x349616(0x1d3))](),this[_0x349616(0x1ab)]=new rapydService_1[(_0x349616(0x243))](),this[_0x349616(0x284)]=new nodaService_1['NodaService'](),this[_0x349616(0x263)]=new coinToPayService_1[(_0x349616(0x19c))](),this[_0x349616(0x26b)]=new coinToPay2Service_1[(_0x349616(0x1c9))](),this[_0x349616(0x21f)]=new klymeService_1['KlymeService'](),this[_0x349616(0x27b)]=new mastercardService_1[(_0x349616(0x27d))](),this[_0x349616(0x239)]=new amerService_1[(_0x349616(0x237))](),this[_0x349616(0x224)]=new ampayService_1[(_0x349616(0x222))]();}async['updatePaymentStatus'](_0x20d06d,_0x40f506,_0x42e0d8){const _0x597bc5=a64_0x40996c;console['log'](_0x597bc5(0x274)+_0x20d06d+_0x597bc5(0x289)+_0x40f506),console[_0x597bc5(0x292)](_0x597bc5(0x1db),_0x42e0d8),await database_1[_0x597bc5(0x199)][_0x597bc5(0x25f)](async _0x292cda=>{const _0x70ffb1=_0x597bc5,_0x50e306=await _0x292cda['payment'][_0x70ffb1(0x275)]({'where':{'id':_0x20d06d},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x50e306)throw new Error('Payment\x20'+_0x20d06d+'\x20not\x20found');const _0x2c79ed=_0x50e306[_0x70ffb1(0x1a5)],_0x17c615=_0x50e306[_0x70ffb1(0x22b)];console['log'](_0x70ffb1(0x1e6)+_0x20d06d+':\x20'+_0x2c79ed+_0x70ffb1(0x21b)+_0x40f506),console[_0x70ffb1(0x292)](_0x70ffb1(0x249)+_0x17c615[_0x70ffb1(0x1ca)]+_0x70ffb1(0x1ef)+_0x17c615['balance']+_0x70ffb1(0x245));const _0x142460={'status':_0x40f506[_0x70ffb1(0x17f)](),'updatedAt':new Date(),'statusChangedBy':_0x70ffb1(0x1f7),'statusChangedAt':new Date()};_0x42e0d8?.[_0x70ffb1(0x26a)]&&(_0x142460[_0x70ffb1(0x26a)]=_0x42e0d8['failureMessage']);_0x42e0d8?.[_0x70ffb1(0x1bf)]&&(_0x142460[_0x70ffb1(0x1bf)]=JSON[_0x70ffb1(0x21c)](_0x42e0d8[_0x70ffb1(0x1bf)]));_0x42e0d8?.[_0x70ffb1(0x1f9)]&&(_0x142460['cardLast4']=_0x42e0d8[_0x70ffb1(0x1f9)]);_0x42e0d8?.[_0x70ffb1(0x1c3)]&&(_0x142460['paymentMethod']=_0x42e0d8[_0x70ffb1(0x1c3)]);_0x42e0d8?.[_0x70ffb1(0x21d)]&&(_0x142460[_0x70ffb1(0x21d)]=_0x42e0d8['bankId']);_0x42e0d8?.[_0x70ffb1(0x265)]&&(_0x142460['remitterIban']=_0x42e0d8[_0x70ffb1(0x265)]);_0x42e0d8?.[_0x70ffb1(0x2a4)]&&(_0x142460['remitterName']=_0x42e0d8[_0x70ffb1(0x2a4)]);let _0x21a5e3=_0x17c615[_0x70ffb1(0x1b6)],_0x423f4b='';if(_0x40f506['toUpperCase']()===_0x70ffb1(0x1c1)&&_0x2c79ed!==_0x70ffb1(0x1c1)){const _0xb539fc=await currencyService_1[_0x70ffb1(0x244)][_0x70ffb1(0x285)](_0x50e306['amount'],_0x50e306[_0x70ffb1(0x188)]),_0x222596=await this['getGatewayCommission'](_0x17c615['id'],_0x50e306[_0x70ffb1(0x17e)]),_0x2ccdf7=_0xb539fc*(0x1-_0x222596/0x64);_0x21a5e3+=_0x2ccdf7,_0x423f4b='+'+_0x2ccdf7['toFixed'](0x6)+_0x70ffb1(0x28f)+_0x222596+_0x70ffb1(0x1b4),_0x142460['amountUSDT']=_0xb539fc,_0x142460['amountAfterGatewayCommissionUSDT']=_0x2ccdf7,_0x142460['gatewayCommissionRate']=_0x222596,_0x142460['paidAt']=new Date(),console[_0x70ffb1(0x292)](_0x70ffb1(0x1df)+_0x50e306[_0x70ffb1(0x29b)]+'\x20'+_0x50e306[_0x70ffb1(0x188)]+_0x70ffb1(0x21b)+_0xb539fc[_0x70ffb1(0x18c)](0x6)+'\x20USDT'),console[_0x70ffb1(0x292)]('💰\x20Gateway\x20'+_0x50e306['gateway']+_0x70ffb1(0x256)+_0x222596+'%'),console[_0x70ffb1(0x292)](_0x70ffb1(0x1a6)+_0x2ccdf7['toFixed'](0x6)+_0x70ffb1(0x245)),console[_0x70ffb1(0x292)](_0x70ffb1(0x1b7)+_0x17c615[_0x70ffb1(0x1b6)]+'\x20+\x20'+_0x2ccdf7[_0x70ffb1(0x18c)](0x6)+_0x70ffb1(0x1f0)+_0x21a5e3[_0x70ffb1(0x18c)](0x6)+_0x70ffb1(0x245));}else{if(_0x2c79ed===_0x70ffb1(0x1c1)&&_0x40f506[_0x70ffb1(0x17f)]()!==_0x70ffb1(0x1c1)){let _0x579d27;if(_0x50e306['amountAfterGatewayCommissionUSDT'])_0x579d27=_0x50e306['amountAfterGatewayCommissionUSDT'];else{if(_0x50e306[_0x70ffb1(0x232)]){const _0x5004d2=await this[_0x70ffb1(0x254)](_0x17c615['id'],_0x50e306['gateway']);_0x579d27=_0x50e306['amountUSDT']*(0x1-_0x5004d2/0x64);}else console[_0x70ffb1(0x292)](_0x70ffb1(0x1bd)),_0x579d27=0x0;}_0x579d27>0x0&&(_0x21a5e3-=_0x579d27,_0x423f4b='-'+_0x579d27[_0x70ffb1(0x18c)](0x6)+_0x70ffb1(0x1eb),_0x142460[_0x70ffb1(0x232)]=null,_0x142460[_0x70ffb1(0x1a7)]=null,_0x142460[_0x70ffb1(0x191)]=null,console[_0x70ffb1(0x292)](_0x70ffb1(0x1ba)+_0x17c615[_0x70ffb1(0x1b6)]+_0x70ffb1(0x22d)+_0x579d27[_0x70ffb1(0x18c)](0x6)+'\x20=\x20'+_0x21a5e3[_0x70ffb1(0x18c)](0x6)+_0x70ffb1(0x245)));}}if(_0x40f506[_0x70ffb1(0x17f)]()===_0x70ffb1(0x24b)){const _0x187a29=_0x42e0d8?.[_0x70ffb1(0x268)]||0x0;_0x187a29>0x0&&(_0x21a5e3-=_0x187a29,_0x423f4b+=_0x70ffb1(0x236)+_0x187a29[_0x70ffb1(0x18c)](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0x142460[_0x70ffb1(0x268)]=_0x187a29,console[_0x70ffb1(0x292)](_0x70ffb1(0x27c)+_0x187a29[_0x70ffb1(0x18c)](0x6)+'\x20USDT'),console[_0x70ffb1(0x292)]('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x21a5e3[_0x70ffb1(0x18c)](0x6)+'\x20USDT'));}const _0x26bb55=await _0x292cda['payment'][_0x70ffb1(0x290)]({'where':{'id':_0x20d06d},'data':_0x142460});_0x21a5e3!==_0x17c615[_0x70ffb1(0x1b6)]&&(await _0x292cda['shop'][_0x70ffb1(0x290)]({'where':{'id':_0x17c615['id']},'data':{'balance':_0x21a5e3}}),console[_0x70ffb1(0x292)](_0x70ffb1(0x1ff)+_0x17c615[_0x70ffb1(0x1ca)]+_0x70ffb1(0x201)+_0x17c615['balance'][_0x70ffb1(0x18c)](0x6)+_0x70ffb1(0x21b)+_0x21a5e3[_0x70ffb1(0x18c)](0x6)+_0x70ffb1(0x245)),console[_0x70ffb1(0x292)](_0x70ffb1(0x260)+_0x423f4b));await _0x292cda[_0x70ffb1(0x1d4)][_0x70ffb1(0x190)]({'data':{'paymentId':_0x20d06d,'shopId':_0x17c615['id'],'event':_0x70ffb1(0x1d7)+_0x40f506[_0x70ffb1(0x1cb)](),'statusCode':0xc8,'responseBody':JSON[_0x70ffb1(0x21c)]({'oldStatus':_0x2c79ed,'newStatus':_0x40f506['toUpperCase'](),'balanceChange':_0x423f4b||'no\x20balance\x20change','oldBalance':_0x17c615['balance'],'newBalance':_0x21a5e3,'amountUSDT':_0x142460[_0x70ffb1(0x232)],'additionalData':_0x42e0d8,'timestamp':new Date()[_0x70ffb1(0x264)]()})}}),await this['sendShopWebhook']({..._0x50e306,..._0x26bb55,'shop':_0x17c615},_0x40f506['toUpperCase']()),await this[_0x70ffb1(0x1a2)]({..._0x50e306,..._0x26bb55},_0x40f506[_0x70ffb1(0x17f)]());if(_0x2c79ed!==_0x70ffb1(0x1c1)&&_0x40f506[_0x70ffb1(0x17f)]()==='PAID'){console['log'](_0x70ffb1(0x231)+_0x20d06d+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console[_0x70ffb1(0x292)](_0x70ffb1(0x207)+_0x2c79ed+'\x22,\x20newStatus=\x22'+_0x40f506[_0x70ffb1(0x17f)]()+_0x70ffb1(0x1e5)+_0x50e306[_0x70ffb1(0x23f)]+'\x22');if(_0x50e306[_0x70ffb1(0x23f)])try{const _0x1bac56=await _0x292cda['paymentLink'][_0x70ffb1(0x275)]({'where':{'id':_0x50e306[_0x70ffb1(0x23f)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1bac56){console['log'](_0x70ffb1(0x28e)+_0x1bac56['id']+_0x70ffb1(0x214)+_0x1bac56[_0x70ffb1(0x19e)]+_0x70ffb1(0x179)+_0x1bac56[_0x70ffb1(0x29e)]+_0x70ffb1(0x1c6)+_0x1bac56[_0x70ffb1(0x1a5)]);const _0x178be5=_0x1bac56[_0x70ffb1(0x29e)]+0x1,_0x579cc0=_0x1bac56[_0x70ffb1(0x19e)]===_0x70ffb1(0x1e4)?_0x70ffb1(0x194):_0x1bac56[_0x70ffb1(0x1a5)];await _0x292cda[_0x70ffb1(0x1e8)]['update']({'where':{'id':_0x50e306[_0x70ffb1(0x23f)]},'data':{'currentPayments':_0x178be5,'status':_0x579cc0,'updatedAt':new Date()}}),console[_0x70ffb1(0x292)](_0x70ffb1(0x257)+_0x1bac56['id']+'\x20updated:\x20currentPayments='+_0x1bac56[_0x70ffb1(0x29e)]+'\x20->\x20'+_0x178be5+_0x70ffb1(0x1c6)+_0x1bac56['status']+_0x70ffb1(0x21b)+_0x579cc0);}else console[_0x70ffb1(0x292)](_0x70ffb1(0x202)+_0x50e306[_0x70ffb1(0x23f)]+_0x70ffb1(0x205));}catch(_0x3a697a){console[_0x70ffb1(0x252)](_0x70ffb1(0x192),_0x3a697a);}else console[_0x70ffb1(0x292)](_0x70ffb1(0x231)+_0x20d06d+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0x70ffb1(0x292)](_0x70ffb1(0x231)+_0x20d06d+'\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20'+_0x2c79ed+'\x20->\x20'+_0x40f506[_0x70ffb1(0x17f)]());});}async[a64_0x40996c(0x267)](_0x3d6d19){const _0x110597=a64_0x40996c;console['log']('🔄\x20Processing\x20Plisio\x20webhook:',_0x3d6d19);try{const _0xa32861=await this[_0x110597(0x279)][_0x110597(0x25b)](_0x3d6d19);if(!_0xa32861[_0x110597(0x1cf)])throw new Error(_0x110597(0x17b));const _0x53317a=await database_1[_0x110597(0x199)]['payment'][_0x110597(0x195)]({'where':{'gatewayOrderId':_0xa32861[_0x110597(0x1cf)]}});if(!_0x53317a){console[_0x110597(0x252)](_0x110597(0x1cc)+_0xa32861[_0x110597(0x1cf)]);return;}console['log'](_0x110597(0x25e)+_0x53317a['id']+_0x110597(0x1ed)+_0xa32861['status']),await this[_0x110597(0x281)](_0x53317a['id'],_0xa32861['status'],{'txUrls':_0xa32861[_0x110597(0x1bf)]}),loggerService_1[_0x110597(0x1a3)]['logWebhookProcessed'](_0x110597(0x1bc),_0x53317a['id'],_0x53317a[_0x110597(0x1a5)],_0xa32861[_0x110597(0x1a5)],_0x3d6d19);}catch(_0x1fd181){console[_0x110597(0x252)](_0x110597(0x196),_0x1fd181),loggerService_1['loggerService'][_0x110597(0x25d)](_0x110597(0x1bc),_0x1fd181,_0x3d6d19);throw _0x1fd181;}}async[a64_0x40996c(0x1cd)](_0x1771cc){const _0x459f91=a64_0x40996c;console[_0x459f91(0x292)]('🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:',_0x1771cc);try{const _0x4a3aa5=await this['plisioService'][_0x459f91(0x25b)](_0x1771cc);if(!_0x4a3aa5[_0x459f91(0x1cf)])throw new Error(_0x459f91(0x282));const _0x267e51=await database_1['default']['payment'][_0x459f91(0x195)]({'where':{'gatewayOrderId':_0x4a3aa5['paymentId']}});if(!_0x267e51){console[_0x459f91(0x252)](_0x459f91(0x1c7)+_0x4a3aa5[_0x459f91(0x1cf)]);return;}console['log'](_0x459f91(0x186)+_0x267e51['id']+_0x459f91(0x1ed)+_0x4a3aa5['status']),await this['updatePaymentStatus'](_0x267e51['id'],_0x4a3aa5['status'],{'txUrls':_0x4a3aa5[_0x459f91(0x1bf)]}),loggerService_1['loggerService']['logWebhookProcessed'](_0x459f91(0x1ce),_0x267e51['id'],_0x267e51[_0x459f91(0x1a5)],_0x4a3aa5['status'],_0x1771cc);}catch(_0x9f79b5){console[_0x459f91(0x252)](_0x459f91(0x226),_0x9f79b5),loggerService_1[_0x459f91(0x1a3)][_0x459f91(0x25d)](_0x459f91(0x1ce),_0x9f79b5,_0x1771cc);throw _0x9f79b5;}}async['processRapydWebhook'](_0x6cd8a5){const _0x6cb1c3=a64_0x40996c;console[_0x6cb1c3(0x292)](_0x6cb1c3(0x1b9),_0x6cd8a5);try{const _0x6ca819=await this[_0x6cb1c3(0x1ab)]['processWebhook'](_0x6cd8a5);if(!_0x6ca819[_0x6cb1c3(0x1cf)])throw new Error(_0x6cb1c3(0x219));const _0x4d0f16=await database_1[_0x6cb1c3(0x199)][_0x6cb1c3(0x178)][_0x6cb1c3(0x195)]({'where':{'gatewayOrderId':_0x6ca819[_0x6cb1c3(0x1cf)]}});if(!_0x4d0f16){console[_0x6cb1c3(0x252)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x6ca819[_0x6cb1c3(0x1cf)]);return;}console[_0x6cb1c3(0x292)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0x4d0f16['id']+'\x20status\x20'+_0x6ca819[_0x6cb1c3(0x1a5)]),await this[_0x6cb1c3(0x281)](_0x4d0f16['id'],_0x6ca819[_0x6cb1c3(0x1a5)],{'failureMessage':_0x6ca819[_0x6cb1c3(0x26a)],'cardLast4':_0x6ca819[_0x6cb1c3(0x177)]?.[_0x6cb1c3(0x1f9)],'paymentMethod':_0x6ca819['additionalInfo']?.['paymentMethod']}),loggerService_1['loggerService'][_0x6cb1c3(0x259)](_0x6cb1c3(0x209),_0x4d0f16['id'],_0x4d0f16[_0x6cb1c3(0x1a5)],_0x6ca819[_0x6cb1c3(0x1a5)],_0x6cd8a5);}catch(_0x2be2ac){console[_0x6cb1c3(0x252)](_0x6cb1c3(0x1d6),_0x2be2ac),loggerService_1[_0x6cb1c3(0x1a3)]['logWebhookError']('rapyd',_0x2be2ac,_0x6cd8a5);throw _0x2be2ac;}}async[a64_0x40996c(0x1f8)](_0x1c1e6d){const _0x3600e3=a64_0x40996c;console[_0x3600e3(0x292)](_0x3600e3(0x273),_0x1c1e6d);try{const _0xe2282d=await this[_0x3600e3(0x284)][_0x3600e3(0x25b)](_0x1c1e6d);if(!_0xe2282d[_0x3600e3(0x1cf)])throw new Error(_0x3600e3(0x22c));const _0x569e1d=await database_1['default'][_0x3600e3(0x178)][_0x3600e3(0x195)]({'where':{'gatewayOrderId':_0xe2282d[_0x3600e3(0x1cf)]}});if(!_0x569e1d){console[_0x3600e3(0x252)](_0x3600e3(0x229)+_0xe2282d[_0x3600e3(0x1cf)]);return;}console[_0x3600e3(0x292)]('📊\x20Noda\x20webhook:\x20Payment\x20'+_0x569e1d['id']+_0x3600e3(0x1ed)+_0xe2282d['status']),await this[_0x3600e3(0x281)](_0x569e1d['id'],_0xe2282d['status'],{'bankId':_0xe2282d['additionalInfo']?.[_0x3600e3(0x21d)],'remitterIban':_0xe2282d[_0x3600e3(0x177)]?.[_0x3600e3(0x265)],'remitterName':_0xe2282d[_0x3600e3(0x177)]?.[_0x3600e3(0x2a4)]}),loggerService_1[_0x3600e3(0x1a3)][_0x3600e3(0x259)](_0x3600e3(0x206),_0x569e1d['id'],_0x569e1d['status'],_0xe2282d[_0x3600e3(0x1a5)],_0x1c1e6d);}catch(_0xe3e07d){console[_0x3600e3(0x252)](_0x3600e3(0x23e),_0xe3e07d),loggerService_1['loggerService'][_0x3600e3(0x25d)](_0x3600e3(0x206),_0xe3e07d,_0x1c1e6d);throw _0xe3e07d;}}async[a64_0x40996c(0x235)](_0x3d05e5){const _0x46c9d2=a64_0x40996c;console[_0x46c9d2(0x292)](_0x46c9d2(0x197),_0x3d05e5);try{const _0x3dcf57=await this[_0x46c9d2(0x263)][_0x46c9d2(0x25b)](_0x3d05e5);if(!_0x3dcf57[_0x46c9d2(0x1cf)])throw new Error(_0x46c9d2(0x1f1));const _0x821f1f=await database_1[_0x46c9d2(0x199)]['payment'][_0x46c9d2(0x195)]({'where':{'gatewayOrderId':_0x3dcf57['paymentId']}});if(!_0x821f1f){console[_0x46c9d2(0x252)](_0x46c9d2(0x29f)+_0x3dcf57[_0x46c9d2(0x1cf)]);return;}console[_0x46c9d2(0x292)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x821f1f['id']+_0x46c9d2(0x1ed)+_0x3dcf57['status']),await this[_0x46c9d2(0x281)](_0x821f1f['id'],_0x3dcf57[_0x46c9d2(0x1a5)]),loggerService_1[_0x46c9d2(0x1a3)]['logWebhookProcessed']('cointopay',_0x821f1f['id'],_0x821f1f[_0x46c9d2(0x1a5)],_0x3dcf57[_0x46c9d2(0x1a5)],_0x3d05e5);}catch(_0x31667a){console[_0x46c9d2(0x252)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x31667a),loggerService_1[_0x46c9d2(0x1a3)]['logWebhookError'](_0x46c9d2(0x1f6),_0x31667a,_0x3d05e5);throw _0x31667a;}}async[a64_0x40996c(0x225)](_0x52fdf9){const _0x150dbb=a64_0x40996c;console[_0x150dbb(0x292)]('🔄\x20Processing\x20CoinToPay2\x20webhook:',_0x52fdf9);try{const _0x16746c=await this[_0x150dbb(0x26b)]['processWebhook'](_0x52fdf9);if(!_0x16746c['paymentId'])throw new Error(_0x150dbb(0x185));const _0x1d715=await database_1[_0x150dbb(0x199)][_0x150dbb(0x178)][_0x150dbb(0x195)]({'where':{'gatewayOrderId':_0x16746c['paymentId']}});if(!_0x1d715){console[_0x150dbb(0x252)]('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x16746c[_0x150dbb(0x1cf)]);return;}console[_0x150dbb(0x292)](_0x150dbb(0x241)+_0x1d715['id']+_0x150dbb(0x1ed)+_0x16746c[_0x150dbb(0x1a5)]),await this[_0x150dbb(0x281)](_0x1d715['id'],_0x16746c[_0x150dbb(0x1a5)]),loggerService_1[_0x150dbb(0x1a3)][_0x150dbb(0x259)](_0x150dbb(0x176),_0x1d715['id'],_0x1d715[_0x150dbb(0x1a5)],_0x16746c[_0x150dbb(0x1a5)],_0x52fdf9);}catch(_0x3931a0){console[_0x150dbb(0x252)](_0x150dbb(0x271),_0x3931a0),loggerService_1[_0x150dbb(0x1a3)]['logWebhookError'](_0x150dbb(0x176),_0x3931a0,_0x52fdf9);throw _0x3931a0;}}async[a64_0x40996c(0x24f)](_0x58e605){const _0x1f3ace=a64_0x40996c;console[_0x1f3ace(0x292)]('🔄\x20Processing\x20KLYME\x20webhook:',_0x58e605);try{const _0x366b95=await this[_0x1f3ace(0x21f)][_0x1f3ace(0x25b)](_0x58e605);if(!_0x366b95[_0x1f3ace(0x1cf)])throw new Error(_0x1f3ace(0x208));const _0x5c4298=await database_1[_0x1f3ace(0x199)][_0x1f3ace(0x178)]['findFirst']({'where':{'gatewayOrderId':_0x366b95[_0x1f3ace(0x1cf)]}});if(!_0x5c4298){console[_0x1f3ace(0x252)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x366b95[_0x1f3ace(0x1cf)]);return;}console[_0x1f3ace(0x292)](_0x1f3ace(0x19d)+_0x5c4298['id']+_0x1f3ace(0x1ed)+_0x366b95[_0x1f3ace(0x1a5)]),await this[_0x1f3ace(0x281)](_0x5c4298['id'],_0x366b95[_0x1f3ace(0x1a5)],{'paymentMethod':_0x366b95[_0x1f3ace(0x177)]?.[_0x1f3ace(0x25c)]}),loggerService_1[_0x1f3ace(0x1a3)][_0x1f3ace(0x259)](_0x1f3ace(0x21a),_0x5c4298['id'],_0x5c4298['status'],_0x366b95[_0x1f3ace(0x1a5)],_0x58e605);}catch(_0x495cbc){console[_0x1f3ace(0x252)]('Error\x20processing\x20KLYME\x20webhook:',_0x495cbc),loggerService_1[_0x1f3ace(0x1a3)][_0x1f3ace(0x25d)](_0x1f3ace(0x21a),_0x495cbc,_0x58e605);throw _0x495cbc;}}async[a64_0x40996c(0x22a)](_0x4f8057){const _0x387ec4=a64_0x40996c;console[_0x387ec4(0x292)](_0x387ec4(0x1d2),JSON[_0x387ec4(0x21c)](_0x4f8057,null,0x2));try{const _0x2e3140=await this[_0x387ec4(0x27b)][_0x387ec4(0x25b)](_0x4f8057,_0x387ec4(0x1e3));console[_0x387ec4(0x292)]('📊\x20VISA\x20webhook\x20result:',_0x2e3140);if(!_0x2e3140[_0x387ec4(0x1cf)]){console[_0x387ec4(0x252)](_0x387ec4(0x1c0)),console[_0x387ec4(0x252)](_0x387ec4(0x294),Object[_0x387ec4(0x24a)](_0x4f8057));throw new Error('No\x20payment\x20ID\x20in\x20VISA\x20webhook');}let _0x52459f=null;console[_0x387ec4(0x292)]('🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x2e3140[_0x387ec4(0x1cf)]);if(_0x2e3140[_0x387ec4(0x1cf)]){console[_0x387ec4(0x292)](_0x387ec4(0x1f2)),console[_0x387ec4(0x292)]('🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:'),console[_0x387ec4(0x292)]('\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard'),console[_0x387ec4(0x292)](_0x387ec4(0x1b8)+_0x2e3140[_0x387ec4(0x1cf)]),console[_0x387ec4(0x292)](_0x387ec4(0x1b2)),_0x52459f=await database_1['default'][_0x387ec4(0x178)][_0x387ec4(0x195)]({'where':{'AND':[{'OR':[{'gateway':_0x387ec4(0x24e)},{'gateway':_0x387ec4(0x298)}]},{'OR':[{'gatewayPaymentId':_0x2e3140[_0x387ec4(0x1cf)]},{'gatewayOrderId':_0x2e3140[_0x387ec4(0x1cf)]},{'id':_0x2e3140[_0x387ec4(0x1cf)]},{'orderId':_0x2e3140[_0x387ec4(0x1cf)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x387ec4(0x292)](_0x387ec4(0x22e));if(_0x52459f)console[_0x387ec4(0x292)](_0x387ec4(0x276)+_0x52459f['id']+_0x387ec4(0x22f)+_0x52459f[_0x387ec4(0x1e9)]+_0x387ec4(0x1fd)+_0x52459f['gatewayPaymentId']);else{console[_0x387ec4(0x292)](_0x387ec4(0x1a4));const _0x28b367=await database_1[_0x387ec4(0x199)]['payment'][_0x387ec4(0x1fc)]({'where':{'gateway':'visa/mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x387ec4(0x277)}});console[_0x387ec4(0x292)]('🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:',_0x28b367[_0x387ec4(0x20d)](_0xed80a2=>_0xed80a2['id']+_0x387ec4(0x247)+_0xed80a2[_0x387ec4(0x1af)]+_0x387ec4(0x198)+_0xed80a2[_0x387ec4(0x1e9)]+',\x20gatewayPaymentId:\x20'+_0xed80a2[_0x387ec4(0x280)]+_0x387ec4(0x246)+_0xed80a2[_0x387ec4(0x1f9)]+')'));}console[_0x387ec4(0x292)]('🔍\x20VISA\x20payment\x20search\x20result:\x20'+(_0x52459f?'Found':'Not\x20found')),_0x52459f&&console[_0x387ec4(0x292)](_0x387ec4(0x203)+_0x52459f['id']+',\x20Gateway='+_0x52459f['gateway']+_0x387ec4(0x255)+_0x52459f['status']+',\x20Card=****'+_0x52459f[_0x387ec4(0x1f9)]);}if(!_0x52459f){console[_0x387ec4(0x252)]('❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20'+_0x2e3140['paymentId']),loggerService_1[_0x387ec4(0x1a3)]['logWebhookError'](_0x387ec4(0x1f3),new Error(_0x387ec4(0x200)+_0x2e3140['paymentId']),_0x4f8057);throw new Error('VISA\x20payment\x20not\x20found:\x20'+_0x2e3140[_0x387ec4(0x1cf)]);}console['log'](_0x387ec4(0x28d)+_0x52459f['id']+_0x387ec4(0x1d9)+_0x52459f[_0x387ec4(0x1a5)]+_0x387ec4(0x28b)+_0x2e3140[_0x387ec4(0x1a5)]+')');const _0xe7c8e9={};_0x2e3140['amount']&&await database_1[_0x387ec4(0x199)][_0x387ec4(0x178)][_0x387ec4(0x290)]({'where':{'id':_0x52459f['id']},'data':{'amount':_0x2e3140[_0x387ec4(0x29b)],'updatedAt':new Date()}}),_0x2e3140[_0x387ec4(0x188)]&&await database_1[_0x387ec4(0x199)][_0x387ec4(0x178)]['update']({'where':{'id':_0x52459f['id']},'data':{'currency':_0x2e3140[_0x387ec4(0x188)],'updatedAt':new Date()}}),_0x2e3140['status']===_0x387ec4(0x27a)&&_0x2e3140['failureMessage']&&(_0xe7c8e9[_0x387ec4(0x26a)]=_0x2e3140['failureMessage'],console[_0x387ec4(0x292)]('❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20'+_0x2e3140[_0x387ec4(0x26a)])),_0xe7c8e9[_0x387ec4(0x1c3)]=_0x387ec4(0x1f3),await this['updatePaymentStatus'](_0x52459f['id'],_0x2e3140[_0x387ec4(0x1a5)],_0xe7c8e9),await database_1[_0x387ec4(0x199)][_0x387ec4(0x1d4)][_0x387ec4(0x190)]({'data':{'paymentId':_0x52459f['id'],'shopId':_0x52459f[_0x387ec4(0x250)],'event':'visa_'+_0x2e3140['status'][_0x387ec4(0x1cb)](),'statusCode':0xc8,'responseBody':JSON[_0x387ec4(0x21c)](_0x2e3140)}}),await this[_0x387ec4(0x1a2)](_0x52459f,_0x2e3140[_0x387ec4(0x1a5)][_0x387ec4(0x17f)]()),console[_0x387ec4(0x292)](_0x387ec4(0x1d1)+_0x52459f['id']);}catch(_0x416152){console[_0x387ec4(0x252)]('❌\x20VISA\x20webhook\x20processing\x20failed:',_0x416152),loggerService_1[_0x387ec4(0x1a3)][_0x387ec4(0x25d)](_0x387ec4(0x1f3),_0x416152,_0x4f8057);throw _0x416152;}}async[a64_0x40996c(0x296)](_0xea2f00){const _0x369a36=a64_0x40996c;console[_0x369a36(0x292)](_0x369a36(0x1aa),JSON[_0x369a36(0x21c)](_0xea2f00,null,0x2));try{const _0x4a0f90=await this['visaMasterCardService'][_0x369a36(0x25b)](_0xea2f00,_0x369a36(0x1ac));console[_0x369a36(0x292)](_0x369a36(0x20a),_0x4a0f90);if(!_0x4a0f90[_0x369a36(0x1cf)]){console[_0x369a36(0x252)](_0x369a36(0x215)),console[_0x369a36(0x252)]('❌\x20Available\x20webhook\x20fields:',Object[_0x369a36(0x24a)](_0xea2f00));throw new Error(_0x369a36(0x1c2));}let _0x31c494=null;console[_0x369a36(0x292)]('🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x4a0f90['paymentId']);_0x4a0f90[_0x369a36(0x1cf)]&&(console[_0x369a36(0x292)](_0x369a36(0x1be)),_0x31c494=await database_1[_0x369a36(0x199)][_0x369a36(0x178)][_0x369a36(0x195)]({'where':{'AND':[{'OR':[{'gateway':'visa_mastercard'},{'gateway':_0x369a36(0x298)},{'gateway':_0x369a36(0x24e)}]},{'OR':[{'gatewayPaymentId':_0x4a0f90[_0x369a36(0x1cf)]},{'gatewayOrderId':_0x4a0f90[_0x369a36(0x1cf)]},{'id':_0x4a0f90[_0x369a36(0x1cf)]},{'orderId':_0x4a0f90[_0x369a36(0x1cf)]}]}]}}),console[_0x369a36(0x292)](_0x369a36(0x19a)+(_0x31c494?_0x369a36(0x26e)+_0x31c494['id']:'Payment\x20not\x20found')));if(!_0x31c494){console[_0x369a36(0x252)](_0x369a36(0x18a)+_0x4a0f90[_0x369a36(0x1cf)]),console['error'](_0x369a36(0x17a)+_0x4a0f90[_0x369a36(0x1cf)]+_0x369a36(0x19b)+_0x4a0f90[_0x369a36(0x1cf)]+'\x22,\x20orderId=\x22'+_0x4a0f90[_0x369a36(0x1cf)]+'\x22');const _0x5484a7=await database_1[_0x369a36(0x199)][_0x369a36(0x178)][_0x369a36(0x1fc)]({'where':{'OR':[{'gateway':'mastercard'},{'gateway':'visa_mastercard'},{'gateway':_0x369a36(0x24e)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x369a36(0x277)},'take':0xf});console[_0x369a36(0x292)](_0x369a36(0x1fe),_0x5484a7),loggerService_1[_0x369a36(0x1a3)][_0x369a36(0x25d)](_0x369a36(0x298),new Error(_0x369a36(0x200)+_0x4a0f90['paymentId']),_0xea2f00);throw new Error(_0x369a36(0x29d)+_0x4a0f90[_0x369a36(0x1cf)]);}console[_0x369a36(0x292)](_0x369a36(0x183)+_0x31c494['id']+'\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20'+_0x31c494[_0x369a36(0x1a5)]+_0x369a36(0x1ee)+_0x4a0f90[_0x369a36(0x1a5)]);const _0x2c766c={};_0x4a0f90[_0x369a36(0x29b)]&&await database_1[_0x369a36(0x199)][_0x369a36(0x178)][_0x369a36(0x290)]({'where':{'id':_0x31c494['id']},'data':{'amount':_0x4a0f90[_0x369a36(0x29b)],'updatedAt':new Date()}}),_0x4a0f90[_0x369a36(0x188)]&&await database_1[_0x369a36(0x199)][_0x369a36(0x178)]['update']({'where':{'id':_0x31c494['id']},'data':{'currency':_0x4a0f90[_0x369a36(0x188)],'updatedAt':new Date()}}),_0x4a0f90[_0x369a36(0x1a5)]===_0x369a36(0x27a)&&_0x4a0f90[_0x369a36(0x26a)]&&(_0x2c766c[_0x369a36(0x26a)]=_0x4a0f90['failureMessage'],console[_0x369a36(0x292)]('❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20'+_0x4a0f90[_0x369a36(0x26a)])),_0x2c766c[_0x369a36(0x1c3)]=_0x369a36(0x298),await this[_0x369a36(0x281)](_0x31c494['id'],_0x4a0f90[_0x369a36(0x1a5)],_0x2c766c),loggerService_1[_0x369a36(0x1a3)][_0x369a36(0x259)](_0x369a36(0x298),_0x31c494['id'],_0x31c494[_0x369a36(0x1a5)],_0x4a0f90[_0x369a36(0x1a5)],_0xea2f00);}catch(_0x3307ac){console[_0x369a36(0x252)]('❌\x20Error\x20processing\x20MasterCard\x20webhook:',_0x3307ac),loggerService_1[_0x369a36(0x1a3)][_0x369a36(0x25d)](_0x369a36(0x298),_0x3307ac,_0xea2f00);throw _0x3307ac;}}async['processAmerWebhook'](_0x4b6fdc){const _0x3dc1ba=a64_0x40996c;console['log'](_0x3dc1ba(0x1c5),JSON[_0x3dc1ba(0x21c)](_0x4b6fdc,null,0x2));try{const _0x18bfc7=await this['amerService'][_0x3dc1ba(0x25b)](_0x4b6fdc);console[_0x3dc1ba(0x292)]('📊\x20Amer\x20webhook\x20result:',_0x18bfc7);if(!_0x18bfc7[_0x3dc1ba(0x1cf)]){console['error'](_0x3dc1ba(0x297)),console[_0x3dc1ba(0x252)]('❌\x20Available\x20webhook\x20fields:',Object[_0x3dc1ba(0x24a)](_0x4b6fdc));throw new Error(_0x3dc1ba(0x223));}let _0x129ecb=null;console[_0x3dc1ba(0x292)](_0x3dc1ba(0x1fa)+_0x18bfc7[_0x3dc1ba(0x1cf)]),_0x129ecb=await database_1['default']['payment']['findFirst']({'where':{'AND':[{'gateway':'amer'},{'OR':[{'gatewayPaymentId':_0x18bfc7[_0x3dc1ba(0x1cf)]},{'gatewayOrderId':_0x18bfc7[_0x3dc1ba(0x1cf)]},{'id':_0x18bfc7[_0x3dc1ba(0x1cf)]},{'orderId':_0x18bfc7[_0x3dc1ba(0x1cf)]}]}]}}),console[_0x3dc1ba(0x292)]('🔍\x20Search\x20result:\x20'+(_0x129ecb?'Found\x20payment\x20'+_0x129ecb['id']:'Payment\x20not\x20found'));if(!_0x129ecb){console[_0x3dc1ba(0x252)]('❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20'+_0x18bfc7[_0x3dc1ba(0x1cf)]);return;}console['log'](_0x3dc1ba(0x262)+_0x129ecb['id']+_0x3dc1ba(0x1ed)+_0x18bfc7[_0x3dc1ba(0x1a5)]),await this[_0x3dc1ba(0x281)](_0x129ecb['id'],_0x18bfc7[_0x3dc1ba(0x1a5)],{'cardLast4':_0x18bfc7[_0x3dc1ba(0x177)]?.[_0x3dc1ba(0x1f9)],'paymentMethod':_0x18bfc7[_0x3dc1ba(0x177)]?.[_0x3dc1ba(0x1c3)]});}catch(_0xdf173d){console['error'](_0x3dc1ba(0x1c4),_0xdf173d),loggerService_1[_0x3dc1ba(0x1a3)][_0x3dc1ba(0x25d)](_0x3dc1ba(0x20e),_0xdf173d,_0x4b6fdc);throw _0xdf173d;}}async[a64_0x40996c(0x283)](_0xc66036){const _0x17ca6d=a64_0x40996c;console[_0x17ca6d(0x292)]('🔄\x20Processing\x20AmPay\x20webhook:',JSON['stringify'](_0xc66036,null,0x2));try{const _0x218674=_0xc66036[_0x17ca6d(0x1a5)],_0x3b6d14=_0xc66036[_0x17ca6d(0x2a1)],_0x418e35=_0xc66036[_0x17ca6d(0x1a1)],_0x2e2707=_0xc66036[_0x17ca6d(0x25c)],_0x2b022b=_0xc66036[_0x17ca6d(0x29b)],_0x316afa=_0xc66036[_0x17ca6d(0x188)],_0x6dd690=_0xc66036[_0x17ca6d(0x29a)],_0x5c14b3=_0xc66036[_0x17ca6d(0x1ad)];if(!_0x3b6d14){console[_0x17ca6d(0x252)]('❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook');throw new Error(_0x17ca6d(0x175));}console[_0x17ca6d(0x292)]('📊\x20AmPay\x20webhook\x20data:',{'status':_0x218674,'clientTransactionId':_0x3b6d14,'systemId':_0x418e35,'paymentMethod':_0x2e2707,'amount':_0x2b022b,'currency':_0x316afa,'commission':_0x6dd690,'statusAdditionInfo':_0x5c14b3});const _0x5df3b8=await database_1['default']['payment'][_0x17ca6d(0x195)]({'where':{'OR':[{'gatewayOrderId':_0x3b6d14},{'orderId':_0x3b6d14},{'id':_0x3b6d14},{'gatewayPaymentId':_0x3b6d14}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x5df3b8){console[_0x17ca6d(0x252)]('❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20'+_0x3b6d14);throw new Error(_0x17ca6d(0x200)+_0x3b6d14);}console['log'](_0x17ca6d(0x183)+_0x5df3b8['id']+_0x17ca6d(0x1da)),console['log'](_0x17ca6d(0x1d0)+_0x5df3b8['status']+_0x17ca6d(0x28b)+_0x218674),_0x218674==='DECLINED'?(console[_0x17ca6d(0x292)](_0x17ca6d(0x17c)),await this[_0x17ca6d(0x281)](_0x5df3b8['id'],_0x17ca6d(0x27a)),console[_0x17ca6d(0x292)](_0x17ca6d(0x1c8)+_0x5df3b8['id']+_0x17ca6d(0x248)),console[_0x17ca6d(0x292)](_0x17ca6d(0x1a8)+(_0x5c14b3||_0x17ca6d(0x1b3)))):console[_0x17ca6d(0x292)](_0x17ca6d(0x2a0)+_0x218674+_0x17ca6d(0x1dc)),await database_1['default'][_0x17ca6d(0x1d4)]['create']({'data':{'paymentId':_0x5df3b8['id'],'shopId':_0x5df3b8[_0x17ca6d(0x250)],'event':_0x17ca6d(0x26f)+(_0x218674?.['toLowerCase']()||_0x17ca6d(0x287)),'statusCode':0xc8,'responseBody':JSON['stringify'](_0xc66036)}}),loggerService_1['loggerService'][_0x17ca6d(0x259)]('ampay',_0x5df3b8['id'],_0x5df3b8[_0x17ca6d(0x1a5)],_0x218674==='DECLINED'?_0x17ca6d(0x27a):_0x218674,_0xc66036);}catch(_0x26314d){console[_0x17ca6d(0x252)](_0x17ca6d(0x230),_0x26314d),loggerService_1[_0x17ca6d(0x1a3)][_0x17ca6d(0x25d)](_0x17ca6d(0x204),_0x26314d,_0xc66036);throw _0x26314d;}}async[a64_0x40996c(0x286)](_0x2223c5,_0x510f0f){const _0x45db42=a64_0x40996c,_0x2cec5d=Date[_0x45db42(0x234)]();try{const _0x2057e3=_0x2223c5[_0x45db42(0x22b)],_0x450676=_0x2057e3[_0x45db42(0x2a2)];if(!_0x450676?.[_0x45db42(0x2a3)]){console['log'](_0x45db42(0x270)+_0x2057e3['id']);return;}const _0x15c74b=_0x510f0f===_0x45db42(0x1c1)?_0x45db42(0x1b5):_0x510f0f==='FAILED'?_0x45db42(0x17d):_0x510f0f===_0x45db42(0x221)?_0x45db42(0x17d):_0x510f0f===_0x45db42(0x24b)?_0x45db42(0x17d):_0x510f0f===_0x45db42(0x218)?'payment.failed':_0x45db42(0x23a);let _0x21dbfd=[];if(_0x450676[_0x45db42(0x269)])try{_0x21dbfd=Array[_0x45db42(0x184)](_0x450676[_0x45db42(0x269)])?_0x450676['webhookEvents']:JSON[_0x45db42(0x211)](_0x450676[_0x45db42(0x269)]);}catch(_0x12cdfd){console[_0x45db42(0x252)](_0x45db42(0x20f),_0x12cdfd),_0x21dbfd=[];}if(!_0x21dbfd[_0x45db42(0x1f5)](_0x15c74b)){console['log'](_0x45db42(0x1a0)+_0x15c74b+_0x45db42(0x210)+_0x2057e3['id']);return;}const _0x191201={'event':_0x15c74b,'payment':{'id':_0x2223c5['id'],'order_id':_0x2223c5[_0x45db42(0x1af)],'gateway_order_id':_0x2223c5['gatewayOrderId'],'gateway':_0x2223c5['gateway'],'amount':_0x2223c5['amount'],'currency':_0x2223c5[_0x45db42(0x188)],'status':_0x510f0f[_0x45db42(0x1cb)](),'customer_email':_0x2223c5['customerEmail'],'customer_name':_0x2223c5[_0x45db42(0x29c)],'failure_message':_0x2223c5[_0x45db42(0x26a)],'tx_urls':_0x2223c5[_0x45db42(0x1bf)]?JSON[_0x45db42(0x211)](_0x2223c5[_0x45db42(0x1bf)]):null,'created_at':_0x2223c5['createdAt'],'updated_at':_0x2223c5[_0x45db42(0x20b)]}},_0x415f0b=await fetch(_0x450676[_0x45db42(0x2a3)],{'method':_0x45db42(0x18d),'headers':{'Content-Type':_0x45db42(0x26d),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x45db42(0x21c)](_0x191201)}),_0x5d80c8=Date[_0x45db42(0x234)]()-_0x2cec5d,_0x14fa73=_0x415f0b['ok']?_0x45db42(0x293):await _0x415f0b[_0x45db42(0x233)]();loggerService_1[_0x45db42(0x1a3)][_0x45db42(0x258)](_0x2223c5[_0x45db42(0x250)],_0x450676[_0x45db42(0x2a3)],_0x15c74b,_0x415f0b['status'],_0x5d80c8,_0x191201),console[_0x45db42(0x292)](_0x45db42(0x212)+_0x450676[_0x45db42(0x2a3)]+_0x45db42(0x227)+_0x415f0b[_0x45db42(0x1a5)]+'\x20('+_0x5d80c8+_0x45db42(0x18e));}catch(_0x539f86){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x539f86),loggerService_1[_0x45db42(0x1a3)]['logShopWebhookError'](_0x2223c5[_0x45db42(0x250)],_0x2223c5[_0x45db42(0x22b)]?.['settings']?.['webhookUrl']||_0x45db42(0x287),'webhook_send',_0x539f86,{});}}async[a64_0x40996c(0x1a2)](_0x328916,_0xcd4617){const _0x154d63=a64_0x40996c;try{const _0x2e2fd6={'PENDING':_0x154d63(0x26c),'PROCESSING':'processing','PAID':_0x154d63(0x228),'FAILED':_0x154d63(0x217),'EXPIRED':_0x154d63(0x18f),'REFUND':_0x154d63(0x266),'CHARGEBACK':_0x154d63(0x1fb)},_0x1a6361=_0x2e2fd6[_0xcd4617];if(!_0x1a6361||_0x1a6361===_0x154d63(0x26c))return;await telegramBotService_1[_0x154d63(0x23d)][_0x154d63(0x19f)](_0x328916['shopId'],_0x328916,_0x1a6361);}catch(_0x1ae272){console[_0x154d63(0x252)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x1ae272);}}async[a64_0x40996c(0x254)](_0x29308d,_0x48031d){const _0xb1a496=a64_0x40996c;try{const _0x3eb23c=await database_1[_0xb1a496(0x199)]['shop'][_0xb1a496(0x275)]({'where':{'id':_0x29308d},'select':{'gatewaySettings':!![]}});if(!_0x3eb23c?.[_0xb1a496(0x18b)])return console[_0xb1a496(0x292)]('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x29308d+_0xb1a496(0x181)),0xa;const _0x3cede9=JSON[_0xb1a496(0x211)](_0x3eb23c[_0xb1a496(0x18b)]);for(const [_0xce91bf,_0x107374]of Object[_0xb1a496(0x1ec)](_0x3cede9)){if(_0xce91bf[_0xb1a496(0x1cb)]()===_0x48031d[_0xb1a496(0x1cb)]()){const _0x44330b=_0x107374[_0xb1a496(0x29a)]||0xa;return console[_0xb1a496(0x292)](_0xb1a496(0x28a)+_0x48031d+_0xb1a496(0x272)+_0x29308d+':\x20'+_0x44330b+'%'),_0x44330b;}}return console[_0xb1a496(0x292)](_0xb1a496(0x1de)+_0x48031d+_0xb1a496(0x189)+_0x29308d+_0xb1a496(0x24c)),0xa;}catch(_0x238c85){return console[_0xb1a496(0x252)](_0xb1a496(0x1ae)+_0x29308d+_0xb1a496(0x251)+_0x48031d+':',_0x238c85),0xa;}}async[a64_0x40996c(0x180)](_0x2397d3,_0x4a0a45){const _0x1b9613=a64_0x40996c;console[_0x1b9613(0x292)]('🔄\x20Processing\x20MyXSpend\x20webhook:'),console[_0x1b9613(0x292)]('Query\x20params:',JSON[_0x1b9613(0x21c)](_0x2397d3,null,0x2)),console[_0x1b9613(0x292)](_0x1b9613(0x1b1),JSON[_0x1b9613(0x21c)](_0x4a0a45,null,0x2));try{const _0x1cec79=_0x2397d3['customerOrderId']||_0x4a0a45['customerOrderId'],_0xf51a85=_0x2397d3['status']||_0x4a0a45[_0x1b9613(0x1a5)],_0x4f9842=_0x2397d3[_0x1b9613(0x29b)]||_0x4a0a45[_0x1b9613(0x29b)],_0x3efe07=_0x2397d3[_0x1b9613(0x188)]||_0x4a0a45['currency'],_0x562565=_0x2397d3['dateTime']||_0x4a0a45['dateTime'];if(!_0x1cec79){console['error'](_0x1b9613(0x23b));throw new Error(_0x1b9613(0x278));}console[_0x1b9613(0x292)](_0x1b9613(0x240),{'customerOrderId':_0x1cec79,'status':_0xf51a85,'amount':_0x4f9842,'currency':_0x3efe07,'dateTime':_0x562565});const _0x57fc4b=await database_1[_0x1b9613(0x199)][_0x1b9613(0x178)][_0x1b9613(0x195)]({'where':{'OR':[{'gatewayOrderId':_0x1cec79},{'orderId':_0x1cec79},{'id':_0x1cec79},{'gatewayPaymentId':_0x1cec79}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x57fc4b){console[_0x1b9613(0x252)](_0x1b9613(0x238)+_0x1cec79);throw new Error(_0x1b9613(0x200)+_0x1cec79);}console[_0x1b9613(0x292)](_0x1b9613(0x183)+_0x57fc4b['id']+_0x1b9613(0x1a9)),console[_0x1b9613(0x292)](_0x1b9613(0x1d0)+_0x57fc4b['status']+_0x1b9613(0x28b)+_0xf51a85);let _0x2c66f7=_0xf51a85?.[_0x1b9613(0x17f)]();_0xf51a85===_0x1b9613(0x27a)||_0xf51a85===_0x1b9613(0x221)?(_0x2c66f7=_0x1b9613(0x27a),console[_0x1b9613(0x292)](_0x1b9613(0x288)+_0xf51a85+'\x20mapped\x20to\x20FAILED'),await this['updatePaymentStatus'](_0x57fc4b['id'],_0x2c66f7),console[_0x1b9613(0x292)](_0x1b9613(0x1e0)+_0x57fc4b['id']+_0x1b9613(0x248))):console['log'](_0x1b9613(0x24d)+_0xf51a85+_0x1b9613(0x27f)),await database_1['default']['webhookLog'][_0x1b9613(0x190)]({'data':{'paymentId':_0x57fc4b['id'],'shopId':_0x57fc4b['shopId'],'event':_0x1b9613(0x1b0)+(_0xf51a85?.[_0x1b9613(0x1cb)]()||_0x1b9613(0x287)),'statusCode':0xc8,'responseBody':JSON[_0x1b9613(0x21c)]({'queryParams':_0x2397d3,'bodyData':_0x4a0a45})}}),loggerService_1[_0x1b9613(0x1a3)][_0x1b9613(0x259)](_0x1b9613(0x1e2),_0x57fc4b['id'],_0x57fc4b[_0x1b9613(0x1a5)],_0x2c66f7||_0xf51a85,{'queryParams':_0x2397d3,'bodyData':_0x4a0a45});}catch(_0x21735a){console[_0x1b9613(0x252)](_0x1b9613(0x295),_0x21735a),loggerService_1[_0x1b9613(0x1a3)][_0x1b9613(0x25d)](_0x1b9613(0x1e2),_0x21735a,{'queryParams':_0x2397d3,'bodyData':_0x4a0a45});throw _0x21735a;}}}exports[a64_0x40996c(0x1d5)]=WebhookService;function a64_0x5009(){const _0x13e65a=['created','application/json','Found\x20payment\x20','ampay_','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Error\x20processing\x20CoinToPay2\x20webhook:','\x20commission\x20for\x20shop\x20','🔄\x20Processing\x20Noda\x20webhook:','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','findUnique','✅\x20Found\x20payment:\x20ID=','desc','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','plisioService','FAILED','visaMasterCardService','💸\x20Additional\x20chargeback\x20penalty:\x20-','VisaMasterCardService','./currencyService','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','gatewayPaymentId','updatePaymentStatus','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','processAmPayWebhook','nodaService','convertToUSDT','sendShopWebhook','unknown','🔄\x20MyXSpend\x20status\x20',',\x20newStatus=','Gateway\x20','\x20→\x20','4666669aPcqOB','📊\x20VISA\x20payment\x20found:\x20','📈\x20Found\x20payment\x20link\x20','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','update','6UaimQH','log','Success','❌\x20Available\x20webhook\x20fields:','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','processMasterCardWebhook','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','mastercard','22096IKKivW','commission','amount','customerName','MasterCard\x20payment\x20not\x20found:\x20','currentPayments','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','ℹ️\x20AmPay\x20status\x20','client_transaction_id','settings','webhookUrl','remitterName','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','cointopay2','additionalInfo','payment',',\x20currentPayments=','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','payment.failed','gateway','toUpperCase','processMyXSpendWebhook',',\x20using\x20default\x20commission\x2010%','2282270Emyycd','✅\x20Found\x20payment\x20','isArray','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','845331jbbkPa','currency','\x20in\x20shop\x20','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','gatewaySettings','toFixed','POST','ms)','expired','create','paidAt','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','../config/database','COMPLETED','findFirst','Error\x20processing\x20Plisio\x20webhook:','🔄\x20Processing\x20CoinToPay\x20webhook:',',\x20gatewayOrderId:\x20','default','🔍\x20Search\x20result:\x20','\x22,\x20id=\x22','CoinToPayService','📊\x20KLYME\x20webhook:\x20Payment\x20','type','sendPaymentNotification','Webhook\x20event\x20','system_id','sendPaymentStatusNotification','loggerService','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','status','💰\x20Amount\x20after\x20gateway\x20commission:\x20','amountAfterGatewayCommissionUSDT','ℹ️\x20Decline\x20reason:\x20','\x20for\x20MyXSpend\x20webhook','🔄\x20Processing\x20MasterCard\x20webhook:','rapydService','MASTERCARD','status_addition_info','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','orderId','myxspend_','Body\x20data:','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','No\x20additional\x20info','%\x20gateway\x20commission)','payment.success','balance','💰\x20Adding\x20to\x20balance:\x20','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','🔄\x20Processing\x20Rapyd\x20webhook:','💰\x20Removing\x20from\x20balance:\x20','./gateways/coinToPay2Service','plisio','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','txUrls','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','PAID','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','paymentMethod','❌\x20Error\x20processing\x20Amer\x20webhook:','🔄\x20Processing\x20Amer\x20webhook:',',\x20status=','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20','CoinToPay2Service','username','toLowerCase','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','processPlisioGatewayWebhook','plisio_gateway','paymentId','📊\x20Payment\x20status:\x20','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','🔄\x20Processing\x20VISA\x20webhook:','PlisioService','webhookLog','WebhookService','Error\x20processing\x20Rapyd\x20webhook:','webhook_status_change_','__importDefault','\x20(Status:\x20','\x20for\x20AmPay\x20webhook','🔄\x20Additional\x20data:','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','__esModule','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','💰\x20Converting\x20','✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','./gateways/plisioService','myxspend','VISA','SINGLE','\x22,\x20paymentLinkId=\x22','💰\x20Payment\x20','248804jnprME','paymentLink','gatewayOrderId','./gateways/mastercardService','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','entries','\x20status\x20','\x20to\x20','\x20current\x20balance:\x20','\x20=\x20','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','visa','./gateways/ampayService','includes','cointopay','system','processNodaWebhook','cardLast4','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','chargeback','findMany',',\x20GatewayPaymentId=','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','✅\x20Shop\x20','Payment\x20not\x20found:\x20','\x20balance\x20updated:\x20','❌\x20Payment\x20link\x20','🔍\x20Found\x20VISA\x20payment:\x20ID=','ampay','\x20not\x20found','noda','📈\x20Payment\x20details:\x20oldStatus=\x22','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','rapyd','📊\x20MasterCard\x20webhook\x20result:','updatedAt','./gateways/coinToPayService','map','amer','Error\x20parsing\x20webhook\x20events:','\x20not\x20enabled\x20for\x20shop\x20','parse','📤\x20Shop\x20webhook\x20sent\x20to\x20','3bzykkD',':\x20type=','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','./gateways/rapydService','failed','REFUND','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','klyme','\x20->\x20','stringify','bankId','./gateways/amerService','klymeService','15387309nzgLBR','EXPIRED','AmPayService','No\x20payment\x20ID\x20in\x20Amer\x20webhook','ampayService','processCoinToPay2Webhook','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','\x20with\x20status\x20','paid','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','processVisaWebhook','shop','No\x20payment\x20ID\x20in\x20Noda\x20webhook','\x20-\x20','🔍\x20VISA\x20payment\x20search\x20executed',',\x20GatewayOrderId=','❌\x20Error\x20processing\x20AmPay\x20webhook:','📈\x20Payment\x20','amountUSDT','text','now','processCoinToPayWebhook','\x20and\x20-','AmerService','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','amerService','payment.pending','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','defineProperty','telegramBotService','Error\x20processing\x20Noda\x20webhook:','paymentLinkId','📊\x20MyXSpend\x20webhook\x20data:','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','518902LYbjAt','RapydService','currencyService','\x20USDT',',\x20card:\x20****','\x20(orderId:\x20','\x20status\x20updated\x20to\x20FAILED','🏪\x20Shop\x20','keys','CHARGEBACK',',\x20using\x20default\x2010%','ℹ️\x20MyXSpend\x20status\x20','visa/mastercard','processKlymeWebhook','shopId',',\x20gateway\x20','error','10VdpVTH','getGatewayCommission',',\x20Status=','\x20commission:\x20','✅\x20Payment\x20link\x20','logShopWebhookSent','logWebhookProcessed','./loggerService','processWebhook','payment_method','logWebhookError','📊\x20Plisio\x20webhook:\x20Payment\x20','$transaction','📝\x20Reason:\x20','./gateways/nodaService','📊\x20Amer\x20webhook:\x20Payment\x20','coinToPayService','toISOString','remitterIban','refund','processPlisioWebhook','chargebackAmount','webhookEvents','failureMessage','coinToPay2Service'];a64_0x5009=function(){return _0x13e65a;};return a64_0x5009();}