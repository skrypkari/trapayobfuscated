'use strict';const a57_0x20d765=a57_0x5717;(function(_0x4304c6,_0x1e3798){const _0x1c636b=a57_0x5717,_0x5d757a=_0x4304c6();while(!![]){try{const _0xf53edf=-parseInt(_0x1c636b(0x216))/0x1+-parseInt(_0x1c636b(0x187))/0x2*(parseInt(_0x1c636b(0x19c))/0x3)+parseInt(_0x1c636b(0x1e8))/0x4+parseInt(_0x1c636b(0x1fe))/0x5*(-parseInt(_0x1c636b(0x1d4))/0x6)+-parseInt(_0x1c636b(0x1bb))/0x7+-parseInt(_0x1c636b(0x1a1))/0x8+parseInt(_0x1c636b(0x211))/0x9;if(_0xf53edf===_0x1e3798)break;else _0x5d757a['push'](_0x5d757a['shift']());}catch(_0x4a682c){_0x5d757a['push'](_0x5d757a['shift']());}}}(a57_0x7766,0x2bcc8));function a57_0x5717(_0x266fc9,_0x1148a7){const _0x7766db=a57_0x7766();return a57_0x5717=function(_0x5717d7,_0x5a593d){_0x5717d7=_0x5717d7-0x180;let _0x3eea24=_0x7766db[_0x5717d7];return _0x3eea24;},a57_0x5717(_0x266fc9,_0x1148a7);}var __importDefault=this&&this[a57_0x20d765(0x188)]||function(_0x2ffd8a){const _0x310bdb=a57_0x20d765;return _0x2ffd8a&&_0x2ffd8a[_0x310bdb(0x1d7)]?_0x2ffd8a:{'default':_0x2ffd8a};};function a57_0x7766(){const _0x95d1c7=['toUpperCase','processNodaWebhook','./loggerService','log','expired','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','create','1636334wYyTDp','bankId','customerEmail','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','no\x20balance\x20change','username','orderId','📊\x20MasterCard\x20webhook:\x20Payment\x20','toFixed','🔄\x20Processing\x20Noda\x20webhook:','processKlymeWebhook','📈\x20Payment\x20link\x20counter\x20updated\x20for\x20payment\x20','logWebhookProcessed','webhook_status_change_','processing','💰\x20Payment\x20','nodaService','failed','\x20USDT','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','paymentId','\x20and\x20-','created','🔄\x20Processing\x20MasterCard\x20webhook:','payment','1446FWAWop','PAID','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','__esModule','masterCardService','🔄\x20Processing\x20KLYME\x20webhook:','Payment\x20','./gateways/plisioService','paid','payment.success','convertToUSDT','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','💰\x20Removing\x20from\x20balance:\x20','sendPaymentStatusNotification','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','CoinToPayService','paidAt','./gateways/rapydService','💰\x20Adding\x20to\x20balance:\x20','\x20status\x20','1264164TWWlQJ','📊\x20CoinToPay\x20webhook:\x20Payment\x20','Error\x20processing\x20MasterCard\x20webhook:','\x20balance\x20updated:\x20','coinToPayService','Error\x20processing\x20Plisio\x20webhook:','refund','currency','cardLast4','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','remitterName','findUnique','\x20=\x20','./gateways/coinToPayService','Success','processPlisioGatewayWebhook','plisioService','loggerService','REFUND','default','balance','now','5755gQIevw','MasterCardService','amountUSDT','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','currencyService','💰\x20Final\x20balance\x20after\x20chargeback:\x20','failureMessage','No\x20payment\x20ID\x20in\x20Noda\x20webhook','./gateways/klymeService','Error\x20processing\x20CoinToPay\x20webhook:','WebhookService','KlymeService','PaymentLinkService','PlisioService','chargebackAmount','klymeService','./telegramBotService','findFirst','Error\x20processing\x20Noda\x20webhook:','11427813UPuqDG','logWebhookError','POST','processPlisioWebhook','status','314336glfrtf','./gateways/mastercardService','📊\x20Plisio\x20webhook:\x20Payment\x20','plisio','Failed\x20to\x20send\x20shop\x20webhook:','toLowerCase','remitterIban','paymentLinkService','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','shopId','telegramBotService','system','update','noda','toISOString','Error\x20processing\x20KLYME\x20webhook:','📝\x20Reason:\x20','🔄\x20Updating\x20payment\x20','webhookLog','mastercard','2NJppQB','__importDefault','📊\x20Noda\x20webhook:\x20Payment\x20','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','paymentMethod','rapydService','processRapydWebhook','\x20not\x20found','payment.failed','webhookEvents','updatePaymentStatus','./gateways/nodaService','additionalInfo','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','shop','💰\x20Converting\x20','text','sendShopWebhook','cointopay','includes','sendPaymentNotification','755223gSkaJH','📊\x20KLYME\x20webhook:\x20Payment\x20','rapyd','customerName','klyme','2633344bepaRR','CHARGEBACK','Webhook\x20event\x20','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','isArray','logShopWebhookSent','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','Error\x20processing\x20Rapyd\x20webhook:','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','processWebhook','plisio_gateway','TesSoft\x20Payment\x20System/1.0','📊\x20Rapyd\x20webhook:\x20Payment\x20','webhookUrl','./currencyService','amount','\x20USDT\x20(payment\x20became\x20PAID)','error','txUrls'];a57_0x7766=function(){return _0x95d1c7;};return a57_0x7766();}Object['defineProperty'](exports,a57_0x20d765(0x1d7),{'value':!![]}),exports[a57_0x20d765(0x208)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a57_0x20d765(0x1db)),rapydService_1=require(a57_0x20d765(0x1e5)),nodaService_1=require(a57_0x20d765(0x192)),coinToPayService_1=require(a57_0x20d765(0x1f5)),klymeService_1=require(a57_0x20d765(0x206)),mastercardService_1=require(a57_0x20d765(0x217)),paymentLinkService_1=require('./paymentLinkService'),telegramBotService_1=require(a57_0x20d765(0x20e)),currencyService_1=require(a57_0x20d765(0x1af)),loggerService_1=require(a57_0x20d765(0x1b6));class WebhookService{constructor(){const _0x184e4a=a57_0x20d765;this['plisioService']=new plisioService_1[(_0x184e4a(0x20b))](),this[_0x184e4a(0x18c)]=new rapydService_1['RapydService'](),this['nodaService']=new nodaService_1['NodaService'](),this[_0x184e4a(0x1ec)]=new coinToPayService_1[(_0x184e4a(0x1e3))](),this[_0x184e4a(0x20d)]=new klymeService_1[(_0x184e4a(0x209))](),this[_0x184e4a(0x1d8)]=new mastercardService_1[(_0x184e4a(0x1ff))](),this[_0x184e4a(0x21d)]=new paymentLinkService_1[(_0x184e4a(0x20a))]();}async['updatePaymentStatus'](_0x334faa,_0x197414,_0x260494){const _0x403ba0=a57_0x20d765;console[_0x403ba0(0x1b7)](_0x403ba0(0x184)+_0x334faa+'\x20status\x20to\x20'+_0x197414);const _0x576365=await database_1[_0x403ba0(0x1fb)][_0x403ba0(0x1d3)][_0x403ba0(0x1f3)]({'where':{'id':_0x334faa},'select':{'status':!![],'paymentLinkId':!![]}});if(!_0x576365)throw new Error('Payment\x20'+_0x334faa+_0x403ba0(0x18e));const _0xcd30d3=_0x576365[_0x403ba0(0x215)];await database_1[_0x403ba0(0x1fb)]['$transaction'](async _0x13a3d4=>{const _0xbdf486=_0x403ba0,_0x2cae56=await _0x13a3d4['payment'][_0xbdf486(0x1f3)]({'where':{'id':_0x334faa},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2cae56)throw new Error(_0xbdf486(0x1da)+_0x334faa+_0xbdf486(0x18e));const _0xc44432=_0x2cae56[_0xbdf486(0x215)],_0x5ecd50=_0x2cae56[_0xbdf486(0x195)];console[_0xbdf486(0x1b7)](_0xbdf486(0x1ca)+_0x334faa+':\x20'+_0xc44432+'\x20->\x20'+_0x197414),console[_0xbdf486(0x1b7)]('🏪\x20Shop\x20'+_0x5ecd50['username']+'\x20current\x20balance:\x20'+_0x5ecd50[_0xbdf486(0x1fc)]+_0xbdf486(0x1cd));const _0x3ac826={'status':_0x197414[_0xbdf486(0x1b4)](),'updatedAt':new Date(),'statusChangedBy':_0xbdf486(0x221),'statusChangedAt':new Date()};_0x260494?.[_0xbdf486(0x204)]&&(_0x3ac826[_0xbdf486(0x204)]=_0x260494[_0xbdf486(0x204)]);_0x260494?.[_0xbdf486(0x1b3)]&&(_0x3ac826['txUrls']=JSON['stringify'](_0x260494[_0xbdf486(0x1b3)]));_0x260494?.[_0xbdf486(0x1f0)]&&(_0x3ac826['cardLast4']=_0x260494[_0xbdf486(0x1f0)]);_0x260494?.[_0xbdf486(0x18b)]&&(_0x3ac826[_0xbdf486(0x18b)]=_0x260494[_0xbdf486(0x18b)]);_0x260494?.[_0xbdf486(0x1bc)]&&(_0x3ac826['bankId']=_0x260494['bankId']);_0x260494?.[_0xbdf486(0x21c)]&&(_0x3ac826[_0xbdf486(0x21c)]=_0x260494[_0xbdf486(0x21c)]);_0x260494?.[_0xbdf486(0x1f2)]&&(_0x3ac826['remitterName']=_0x260494[_0xbdf486(0x1f2)]);let _0x1e77e8=_0x5ecd50[_0xbdf486(0x1fc)],_0x5a7df4='';if(_0x197414[_0xbdf486(0x1b4)]()===_0xbdf486(0x1d5)&&_0xc44432!==_0xbdf486(0x1d5)){const _0x4fc98c=await currencyService_1[_0xbdf486(0x202)][_0xbdf486(0x1de)](_0x2cae56[_0xbdf486(0x1b0)],_0x2cae56['currency']);_0x1e77e8+=_0x4fc98c,_0x5a7df4='+'+_0x4fc98c['toFixed'](0x6)+_0xbdf486(0x1b1),_0x3ac826[_0xbdf486(0x200)]=_0x4fc98c,_0x3ac826[_0xbdf486(0x1e4)]=new Date(),console[_0xbdf486(0x1b7)](_0xbdf486(0x196)+_0x2cae56[_0xbdf486(0x1b0)]+'\x20'+_0x2cae56[_0xbdf486(0x1ef)]+'\x20->\x20'+_0x4fc98c[_0xbdf486(0x1c3)](0x6)+_0xbdf486(0x1cd)),console[_0xbdf486(0x1b7)](_0xbdf486(0x1e6)+_0x5ecd50[_0xbdf486(0x1fc)]+'\x20+\x20'+_0x4fc98c['toFixed'](0x6)+_0xbdf486(0x1f4)+_0x1e77e8[_0xbdf486(0x1c3)](0x6)+'\x20USDT');}else{if(_0xc44432===_0xbdf486(0x1d5)&&_0x197414[_0xbdf486(0x1b4)]()!==_0xbdf486(0x1d5)){const _0x12525b=_0x2cae56[_0xbdf486(0x200)];_0x12525b&&(_0x1e77e8-=_0x12525b,_0x5a7df4='-'+_0x12525b[_0xbdf486(0x1c3)](0x6)+_0xbdf486(0x201),_0x3ac826[_0xbdf486(0x200)]=null,_0x3ac826['paidAt']=null,console[_0xbdf486(0x1b7)](_0xbdf486(0x1e0)+_0x5ecd50[_0xbdf486(0x1fc)]+'\x20-\x20'+_0x12525b[_0xbdf486(0x1c3)](0x6)+_0xbdf486(0x1f4)+_0x1e77e8['toFixed'](0x6)+_0xbdf486(0x1cd)));}}if(_0x197414[_0xbdf486(0x1b4)]()===_0xbdf486(0x1a2)){const _0x166d27=_0x260494?.['chargebackAmount']||0x0;_0x166d27>0x0&&(_0x1e77e8-=_0x166d27,_0x5a7df4+=_0xbdf486(0x1d0)+_0x166d27[_0xbdf486(0x1c3)](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0x3ac826[_0xbdf486(0x20c)]=_0x166d27,console[_0xbdf486(0x1b7)]('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0x166d27[_0xbdf486(0x1c3)](0x6)+'\x20USDT'),console[_0xbdf486(0x1b7)](_0xbdf486(0x203)+_0x1e77e8[_0xbdf486(0x1c3)](0x6)+_0xbdf486(0x1cd)));}const _0x74314f=await _0x13a3d4[_0xbdf486(0x1d3)][_0xbdf486(0x222)]({'where':{'id':_0x334faa},'data':_0x3ac826});_0x1e77e8!==_0x5ecd50[_0xbdf486(0x1fc)]&&(await _0x13a3d4[_0xbdf486(0x195)][_0xbdf486(0x222)]({'where':{'id':_0x5ecd50['id']},'data':{'balance':_0x1e77e8}}),console[_0xbdf486(0x1b7)]('✅\x20Shop\x20'+_0x5ecd50[_0xbdf486(0x1c0)]+_0xbdf486(0x1eb)+_0x5ecd50[_0xbdf486(0x1fc)]['toFixed'](0x6)+'\x20->\x20'+_0x1e77e8[_0xbdf486(0x1c3)](0x6)+'\x20USDT'),console[_0xbdf486(0x1b7)](_0xbdf486(0x183)+_0x5a7df4)),await _0x13a3d4[_0xbdf486(0x185)][_0xbdf486(0x1ba)]({'data':{'paymentId':_0x334faa,'shopId':_0x5ecd50['id'],'event':_0xbdf486(0x1c8)+_0x197414[_0xbdf486(0x21b)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0xc44432,'newStatus':_0x197414[_0xbdf486(0x1b4)](),'balanceChange':_0x5a7df4||_0xbdf486(0x1bf),'oldBalance':_0x5ecd50[_0xbdf486(0x1fc)],'newBalance':_0x1e77e8,'amountUSDT':_0x3ac826['amountUSDT'],'additionalData':_0x260494,'timestamp':new Date()[_0xbdf486(0x181)]()})}}),await this['sendShopWebhook']({..._0x2cae56,..._0x74314f,'shop':_0x5ecd50},_0x197414[_0xbdf486(0x1b4)]()),await this[_0xbdf486(0x1e1)]({..._0x2cae56,..._0x74314f},_0x197414[_0xbdf486(0x1b4)]());});if(_0x197414[_0x403ba0(0x1b4)]()===_0x403ba0(0x1d5)&&_0xcd30d3!=='PAID')try{await this[_0x403ba0(0x21d)]['handleSuccessfulPayment'](_0x334faa),console[_0x403ba0(0x1b7)](_0x403ba0(0x1c6)+_0x334faa);}catch(_0x168aaa){console[_0x403ba0(0x1b2)](_0x403ba0(0x1a7)+_0x334faa+':',_0x168aaa);}}async[a57_0x20d765(0x214)](_0x5612f9){const _0x157787=a57_0x20d765;console[_0x157787(0x1b7)]('🔄\x20Processing\x20Plisio\x20webhook:',_0x5612f9);try{const _0x39ab4c=await this[_0x157787(0x1f8)][_0x157787(0x1aa)](_0x5612f9);if(!_0x39ab4c[_0x157787(0x1cf)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x44201e=await database_1[_0x157787(0x1fb)][_0x157787(0x1d3)][_0x157787(0x20f)]({'where':{'gatewayOrderId':_0x39ab4c['paymentId']}});if(!_0x44201e){console[_0x157787(0x1b2)](_0x157787(0x1f1)+_0x39ab4c[_0x157787(0x1cf)]);return;}console[_0x157787(0x1b7)](_0x157787(0x218)+_0x44201e['id']+_0x157787(0x1e7)+_0x39ab4c[_0x157787(0x215)]),await this[_0x157787(0x191)](_0x44201e['id'],_0x39ab4c[_0x157787(0x215)],{'txUrls':_0x39ab4c[_0x157787(0x1b3)]}),loggerService_1[_0x157787(0x1f9)]['logWebhookProcessed'](_0x157787(0x219),_0x44201e['id'],_0x44201e[_0x157787(0x215)],_0x39ab4c[_0x157787(0x215)],_0x5612f9);}catch(_0x21b31e){console['error'](_0x157787(0x1ed),_0x21b31e),loggerService_1[_0x157787(0x1f9)]['logWebhookError'](_0x157787(0x219),_0x21b31e,_0x5612f9);throw _0x21b31e;}}async[a57_0x20d765(0x1f7)](_0x387cfb){const _0x4b8ce2=a57_0x20d765;console['log']('🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:',_0x387cfb);try{const _0x4c2e28=await this[_0x4b8ce2(0x1f8)][_0x4b8ce2(0x1aa)](_0x387cfb);if(!_0x4c2e28[_0x4b8ce2(0x1cf)])throw new Error(_0x4b8ce2(0x1e2));const _0x28b5d6=await database_1[_0x4b8ce2(0x1fb)][_0x4b8ce2(0x1d3)][_0x4b8ce2(0x20f)]({'where':{'gatewayOrderId':_0x4c2e28[_0x4b8ce2(0x1cf)]}});if(!_0x28b5d6){console[_0x4b8ce2(0x1b2)](_0x4b8ce2(0x1d6)+_0x4c2e28[_0x4b8ce2(0x1cf)]);return;}console['log'](_0x4b8ce2(0x18a)+_0x28b5d6['id']+_0x4b8ce2(0x1e7)+_0x4c2e28['status']),await this[_0x4b8ce2(0x191)](_0x28b5d6['id'],_0x4c2e28[_0x4b8ce2(0x215)],{'txUrls':_0x4c2e28[_0x4b8ce2(0x1b3)]}),loggerService_1[_0x4b8ce2(0x1f9)][_0x4b8ce2(0x1c7)]('plisio_gateway',_0x28b5d6['id'],_0x28b5d6[_0x4b8ce2(0x215)],_0x4c2e28[_0x4b8ce2(0x215)],_0x387cfb);}catch(_0x30485f){console[_0x4b8ce2(0x1b2)](_0x4b8ce2(0x21e),_0x30485f),loggerService_1[_0x4b8ce2(0x1f9)][_0x4b8ce2(0x212)](_0x4b8ce2(0x1ab),_0x30485f,_0x387cfb);throw _0x30485f;}}async[a57_0x20d765(0x18d)](_0x520117){const _0x5f03b0=a57_0x20d765;console[_0x5f03b0(0x1b7)]('🔄\x20Processing\x20Rapyd\x20webhook:',_0x520117);try{const _0x13e76a=await this[_0x5f03b0(0x18c)][_0x5f03b0(0x1aa)](_0x520117);if(!_0x13e76a[_0x5f03b0(0x1cf)])throw new Error(_0x5f03b0(0x1a4));const _0x2a0378=await database_1['default'][_0x5f03b0(0x1d3)]['findFirst']({'where':{'gatewayOrderId':_0x13e76a[_0x5f03b0(0x1cf)]}});if(!_0x2a0378){console['error'](_0x5f03b0(0x1ce)+_0x13e76a[_0x5f03b0(0x1cf)]);return;}console[_0x5f03b0(0x1b7)](_0x5f03b0(0x1ad)+_0x2a0378['id']+_0x5f03b0(0x1e7)+_0x13e76a[_0x5f03b0(0x215)]),await this[_0x5f03b0(0x191)](_0x2a0378['id'],_0x13e76a['status'],{'failureMessage':_0x13e76a[_0x5f03b0(0x204)],'cardLast4':_0x13e76a[_0x5f03b0(0x193)]?.[_0x5f03b0(0x1f0)],'paymentMethod':_0x13e76a[_0x5f03b0(0x193)]?.[_0x5f03b0(0x18b)]}),loggerService_1[_0x5f03b0(0x1f9)][_0x5f03b0(0x1c7)]('rapyd',_0x2a0378['id'],_0x2a0378[_0x5f03b0(0x215)],_0x13e76a[_0x5f03b0(0x215)],_0x520117);}catch(_0x1c9923){console['error'](_0x5f03b0(0x1a8),_0x1c9923),loggerService_1[_0x5f03b0(0x1f9)][_0x5f03b0(0x212)](_0x5f03b0(0x19e),_0x1c9923,_0x520117);throw _0x1c9923;}}async[a57_0x20d765(0x1b5)](_0x29c0ae){const _0x1e6bcf=a57_0x20d765;console[_0x1e6bcf(0x1b7)](_0x1e6bcf(0x1c4),_0x29c0ae);try{const _0x4e594e=await this[_0x1e6bcf(0x1cb)][_0x1e6bcf(0x1aa)](_0x29c0ae);if(!_0x4e594e['paymentId'])throw new Error(_0x1e6bcf(0x205));const _0x10734d=await database_1[_0x1e6bcf(0x1fb)][_0x1e6bcf(0x1d3)]['findFirst']({'where':{'gatewayOrderId':_0x4e594e['paymentId']}});if(!_0x10734d){console[_0x1e6bcf(0x1b2)](_0x1e6bcf(0x194)+_0x4e594e[_0x1e6bcf(0x1cf)]);return;}console[_0x1e6bcf(0x1b7)](_0x1e6bcf(0x189)+_0x10734d['id']+_0x1e6bcf(0x1e7)+_0x4e594e[_0x1e6bcf(0x215)]),await this[_0x1e6bcf(0x191)](_0x10734d['id'],_0x4e594e[_0x1e6bcf(0x215)],{'bankId':_0x4e594e[_0x1e6bcf(0x193)]?.[_0x1e6bcf(0x1bc)],'remitterIban':_0x4e594e[_0x1e6bcf(0x193)]?.[_0x1e6bcf(0x21c)],'remitterName':_0x4e594e[_0x1e6bcf(0x193)]?.[_0x1e6bcf(0x1f2)]}),loggerService_1[_0x1e6bcf(0x1f9)][_0x1e6bcf(0x1c7)]('noda',_0x10734d['id'],_0x10734d[_0x1e6bcf(0x215)],_0x4e594e[_0x1e6bcf(0x215)],_0x29c0ae);}catch(_0x3ff287){console['error'](_0x1e6bcf(0x210),_0x3ff287),loggerService_1['loggerService']['logWebhookError'](_0x1e6bcf(0x180),_0x3ff287,_0x29c0ae);throw _0x3ff287;}}async['processCoinToPayWebhook'](_0x3e95de){const _0x36fc24=a57_0x20d765;console[_0x36fc24(0x1b7)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x3e95de);try{const _0x26db36=await this['coinToPayService'][_0x36fc24(0x1aa)](_0x3e95de);if(!_0x26db36[_0x36fc24(0x1cf)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x53dc59=await database_1[_0x36fc24(0x1fb)][_0x36fc24(0x1d3)][_0x36fc24(0x20f)]({'where':{'gatewayOrderId':_0x26db36[_0x36fc24(0x1cf)]}});if(!_0x53dc59){console[_0x36fc24(0x1b2)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x26db36[_0x36fc24(0x1cf)]);return;}console[_0x36fc24(0x1b7)](_0x36fc24(0x1e9)+_0x53dc59['id']+_0x36fc24(0x1e7)+_0x26db36[_0x36fc24(0x215)]),await this[_0x36fc24(0x191)](_0x53dc59['id'],_0x26db36[_0x36fc24(0x215)]),loggerService_1[_0x36fc24(0x1f9)][_0x36fc24(0x1c7)](_0x36fc24(0x199),_0x53dc59['id'],_0x53dc59[_0x36fc24(0x215)],_0x26db36[_0x36fc24(0x215)],_0x3e95de);}catch(_0x57cc06){console[_0x36fc24(0x1b2)](_0x36fc24(0x207),_0x57cc06),loggerService_1[_0x36fc24(0x1f9)][_0x36fc24(0x212)](_0x36fc24(0x199),_0x57cc06,_0x3e95de);throw _0x57cc06;}}async[a57_0x20d765(0x1c5)](_0x3bb149){const _0x27a789=a57_0x20d765;console['log'](_0x27a789(0x1d9),_0x3bb149);try{const _0x4fc040=await this[_0x27a789(0x20d)]['processWebhook'](_0x3bb149);if(!_0x4fc040[_0x27a789(0x1cf)])throw new Error(_0x27a789(0x1a9));const _0x2df2fa=await database_1[_0x27a789(0x1fb)][_0x27a789(0x1d3)][_0x27a789(0x20f)]({'where':{'gatewayOrderId':_0x4fc040[_0x27a789(0x1cf)]}});if(!_0x2df2fa){console[_0x27a789(0x1b2)](_0x27a789(0x1be)+_0x4fc040[_0x27a789(0x1cf)]);return;}console['log'](_0x27a789(0x19d)+_0x2df2fa['id']+_0x27a789(0x1e7)+_0x4fc040[_0x27a789(0x215)]),await this['updatePaymentStatus'](_0x2df2fa['id'],_0x4fc040['status'],{'paymentMethod':_0x4fc040['additionalInfo']?.['payment_method']}),loggerService_1['loggerService']['logWebhookProcessed'](_0x27a789(0x1a0),_0x2df2fa['id'],_0x2df2fa['status'],_0x4fc040[_0x27a789(0x215)],_0x3bb149);}catch(_0x547171){console[_0x27a789(0x1b2)](_0x27a789(0x182),_0x547171),loggerService_1[_0x27a789(0x1f9)][_0x27a789(0x212)](_0x27a789(0x1a0),_0x547171,_0x3bb149);throw _0x547171;}}async['processMasterCardWebhook'](_0x5af893){const _0x5efaf3=a57_0x20d765;console[_0x5efaf3(0x1b7)](_0x5efaf3(0x1d2),_0x5af893);try{const _0x3d492a=await this['masterCardService'][_0x5efaf3(0x1aa)](_0x5af893);if(!_0x3d492a[_0x5efaf3(0x1cf)])throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');const _0x21317f=await database_1[_0x5efaf3(0x1fb)][_0x5efaf3(0x1d3)][_0x5efaf3(0x20f)]({'where':{'gatewayOrderId':_0x3d492a[_0x5efaf3(0x1cf)]}});if(!_0x21317f){console[_0x5efaf3(0x1b2)]('Payment\x20not\x20found\x20for\x20MasterCard\x20webhook:\x20'+_0x3d492a[_0x5efaf3(0x1cf)]);return;}console[_0x5efaf3(0x1b7)](_0x5efaf3(0x1c2)+_0x21317f['id']+_0x5efaf3(0x1e7)+_0x3d492a[_0x5efaf3(0x215)]),await this['updatePaymentStatus'](_0x21317f['id'],_0x3d492a['status']),loggerService_1[_0x5efaf3(0x1f9)][_0x5efaf3(0x1c7)](_0x5efaf3(0x186),_0x21317f['id'],_0x21317f[_0x5efaf3(0x215)],_0x3d492a[_0x5efaf3(0x215)],_0x5af893);}catch(_0x1fb4fd){console['error'](_0x5efaf3(0x1ea),_0x1fb4fd),loggerService_1[_0x5efaf3(0x1f9)]['logWebhookError']('mastercard',_0x1fb4fd,_0x5af893);throw _0x1fb4fd;}}async[a57_0x20d765(0x198)](_0xf81076,_0xf45978){const _0x3a8eda=a57_0x20d765,_0xe6915d=Date[_0x3a8eda(0x1fd)]();try{const _0x3a9a28=_0xf81076[_0x3a8eda(0x195)],_0x30aef8=_0x3a9a28['settings'];if(!_0x30aef8?.[_0x3a8eda(0x1ae)]){console[_0x3a8eda(0x1b7)](_0x3a8eda(0x1b9)+_0x3a9a28['id']);return;}const _0x7ba64c=_0xf45978===_0x3a8eda(0x1d5)?_0x3a8eda(0x1dd):_0xf45978==='FAILED'?_0x3a8eda(0x18f):_0xf45978==='EXPIRED'?'payment.failed':_0xf45978==='CHARGEBACK'?_0x3a8eda(0x18f):_0xf45978===_0x3a8eda(0x1fa)?'payment.failed':'payment.pending';let _0x54869a=[];if(_0x30aef8[_0x3a8eda(0x190)])try{_0x54869a=Array[_0x3a8eda(0x1a5)](_0x30aef8['webhookEvents'])?_0x30aef8[_0x3a8eda(0x190)]:JSON['parse'](_0x30aef8[_0x3a8eda(0x190)]);}catch(_0x29210d){console[_0x3a8eda(0x1b2)]('Error\x20parsing\x20webhook\x20events:',_0x29210d),_0x54869a=[];}if(!_0x54869a[_0x3a8eda(0x19a)](_0x7ba64c)){console[_0x3a8eda(0x1b7)](_0x3a8eda(0x1a3)+_0x7ba64c+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3a9a28['id']);return;}const _0x126c75={'event':_0x7ba64c,'payment':{'id':_0xf81076['id'],'order_id':_0xf81076[_0x3a8eda(0x1c1)],'amount':_0xf81076['amount'],'currency':_0xf81076[_0x3a8eda(0x1ef)],'status':_0xf45978[_0x3a8eda(0x21b)](),'customer_email':_0xf81076[_0x3a8eda(0x1bd)],'customer_name':_0xf81076[_0x3a8eda(0x19f)],'created_at':_0xf81076['createdAt'],'updated_at':_0xf81076['updatedAt']}},_0x177233=await fetch(_0x30aef8[_0x3a8eda(0x1ae)],{'method':_0x3a8eda(0x213),'headers':{'Content-Type':'application/json','User-Agent':_0x3a8eda(0x1ac)},'body':JSON['stringify'](_0x126c75)}),_0x20c16a=Date[_0x3a8eda(0x1fd)]()-_0xe6915d,_0x19a04f=_0x177233['ok']?_0x3a8eda(0x1f6):await _0x177233[_0x3a8eda(0x197)]();loggerService_1[_0x3a8eda(0x1f9)][_0x3a8eda(0x1a6)](_0xf81076[_0x3a8eda(0x21f)],_0x30aef8[_0x3a8eda(0x1ae)],_0x7ba64c,_0x177233[_0x3a8eda(0x215)],_0x20c16a,_0x126c75),console[_0x3a8eda(0x1b7)]('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0x30aef8[_0x3a8eda(0x1ae)]+'\x20with\x20status\x20'+_0x177233[_0x3a8eda(0x215)]+'\x20('+_0x20c16a+'ms)');}catch(_0x41c75a){console[_0x3a8eda(0x1b2)](_0x3a8eda(0x21a),_0x41c75a),loggerService_1['loggerService']['logShopWebhookError'](_0xf81076[_0x3a8eda(0x21f)],_0xf81076['shop']?.['settings']?.[_0x3a8eda(0x1ae)]||'unknown','webhook_send',_0x41c75a,{});}}async['sendPaymentStatusNotification'](_0x2852c9,_0xfa107d){const _0x332298=a57_0x20d765;try{const _0x4775d8={'PENDING':_0x332298(0x1d1),'PROCESSING':_0x332298(0x1c9),'PAID':_0x332298(0x1dc),'FAILED':_0x332298(0x1cc),'EXPIRED':_0x332298(0x1b8),'REFUND':_0x332298(0x1ee),'CHARGEBACK':'chargeback'},_0x41ee90=_0x4775d8[_0xfa107d];if(!_0x41ee90||_0x41ee90==='created')return;await telegramBotService_1[_0x332298(0x220)][_0x332298(0x19b)](_0x2852c9['shopId'],_0x2852c9,_0x41ee90);}catch(_0x28c632){console['error'](_0x332298(0x1df),_0x28c632);}}}exports[a57_0x20d765(0x208)]=WebhookService;