'use strict';const a61_0x21a438=a61_0x1740;(function(_0x133530,_0x16f38a){const _0xa0e7df=a61_0x1740,_0x1e9afd=_0x133530();while(!![]){try{const _0x4da4c0=-parseInt(_0xa0e7df(0x1d0))/0x1*(-parseInt(_0xa0e7df(0x190))/0x2)+-parseInt(_0xa0e7df(0x1b6))/0x3+parseInt(_0xa0e7df(0x1de))/0x4*(-parseInt(_0xa0e7df(0x1f2))/0x5)+parseInt(_0xa0e7df(0x20e))/0x6*(-parseInt(_0xa0e7df(0x212))/0x7)+-parseInt(_0xa0e7df(0x1bd))/0x8+parseInt(_0xa0e7df(0x180))/0x9+parseInt(_0xa0e7df(0x19c))/0xa;if(_0x4da4c0===_0x16f38a)break;else _0x1e9afd['push'](_0x1e9afd['shift']());}catch(_0x2f3383){_0x1e9afd['push'](_0x1e9afd['shift']());}}}(a61_0x2388,0xd9611));var __importDefault=this&&this[a61_0x21a438(0x145)]||function(_0x2d30ff){const _0x289260=a61_0x21a438;return _0x2d30ff&&_0x2d30ff[_0x289260(0x152)]?_0x2d30ff:{'default':_0x2d30ff};};Object[a61_0x21a438(0x16b)](exports,a61_0x21a438(0x152),{'value':!![]}),exports[a61_0x21a438(0x1f4)]=void 0x0;const database_1=__importDefault(require(a61_0x21a438(0x1cc))),plisioService_1=require(a61_0x21a438(0x193)),rapydService_1=require(a61_0x21a438(0x12b)),nodaService_1=require(a61_0x21a438(0x1ab)),coinToPayService_1=require(a61_0x21a438(0x1e8)),coinToPay2Service_1=require(a61_0x21a438(0x215)),klymeService_1=require(a61_0x21a438(0x15f)),mastercardService_1=require(a61_0x21a438(0x1ce)),amerService_1=require(a61_0x21a438(0x19f)),telegramBotService_1=require(a61_0x21a438(0x182)),currencyService_1=require(a61_0x21a438(0x1e0)),loggerService_1=require(a61_0x21a438(0x18e));class WebhookService{constructor(){const _0x1dfc71=a61_0x21a438;this[_0x1dfc71(0x1ba)]=new plisioService_1[(_0x1dfc71(0x1fe))](),this[_0x1dfc71(0x176)]=new rapydService_1['RapydService'](),this[_0x1dfc71(0x13c)]=new nodaService_1[(_0x1dfc71(0x1f5))](),this['coinToPayService']=new coinToPayService_1[(_0x1dfc71(0x1ff))](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x1dfc71(0x181))](),this[_0x1dfc71(0x17f)]=new klymeService_1[(_0x1dfc71(0x171))](),this[_0x1dfc71(0x19d)]=new mastercardService_1[(_0x1dfc71(0x167))](),this[_0x1dfc71(0x130)]=new amerService_1[(_0x1dfc71(0x20b))]();}async[a61_0x21a438(0x1f3)](_0x580f9b,_0x2e0024,_0x57365e){const _0x1bc7b2=a61_0x21a438;console[_0x1bc7b2(0x196)](_0x1bc7b2(0x17d)+_0x580f9b+_0x1bc7b2(0x1b4)+_0x2e0024),console[_0x1bc7b2(0x196)](_0x1bc7b2(0x18b),_0x57365e),await database_1[_0x1bc7b2(0x1ee)][_0x1bc7b2(0x1d8)](async _0x2a9c96=>{const _0x5d7434=_0x1bc7b2,_0xbaa463=await _0x2a9c96[_0x5d7434(0x1dd)][_0x5d7434(0x1e9)]({'where':{'id':_0x580f9b},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xbaa463)throw new Error(_0x5d7434(0x20f)+_0x580f9b+'\x20not\x20found');const _0x4d49f4=_0xbaa463[_0x5d7434(0x1e1)],_0x20f7d6=_0xbaa463[_0x5d7434(0x163)];console[_0x5d7434(0x196)](_0x5d7434(0x139)+_0x580f9b+':\x20'+_0x4d49f4+_0x5d7434(0x1b8)+_0x2e0024),console[_0x5d7434(0x196)](_0x5d7434(0x183)+_0x20f7d6[_0x5d7434(0x16c)]+_0x5d7434(0x177)+_0x20f7d6[_0x5d7434(0x202)]+_0x5d7434(0x210));const _0x3db4ab={'status':_0x2e0024['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x57365e?.[_0x5d7434(0x136)]&&(_0x3db4ab[_0x5d7434(0x136)]=_0x57365e[_0x5d7434(0x136)]);_0x57365e?.['txUrls']&&(_0x3db4ab[_0x5d7434(0x1eb)]=JSON[_0x5d7434(0x195)](_0x57365e[_0x5d7434(0x1eb)]));_0x57365e?.[_0x5d7434(0x17a)]&&(_0x3db4ab[_0x5d7434(0x17a)]=_0x57365e['cardLast4']);_0x57365e?.['paymentMethod']&&(_0x3db4ab[_0x5d7434(0x169)]=_0x57365e[_0x5d7434(0x169)]);_0x57365e?.[_0x5d7434(0x14a)]&&(_0x3db4ab[_0x5d7434(0x14a)]=_0x57365e[_0x5d7434(0x14a)]);_0x57365e?.[_0x5d7434(0x1bb)]&&(_0x3db4ab[_0x5d7434(0x1bb)]=_0x57365e[_0x5d7434(0x1bb)]);_0x57365e?.[_0x5d7434(0x14c)]&&(_0x3db4ab[_0x5d7434(0x14c)]=_0x57365e['remitterName']);let _0x40f49c=_0x20f7d6['balance'],_0x5555b3='';if(_0x2e0024[_0x5d7434(0x1d9)]()===_0x5d7434(0x1b0)&&_0x4d49f4!=='PAID'){const _0x419825=await currencyService_1[_0x5d7434(0x1d4)]['convertToUSDT'](_0xbaa463[_0x5d7434(0x1ac)],_0xbaa463['currency']),_0x37d1d3=await this[_0x5d7434(0x1b2)](_0x20f7d6['id'],_0xbaa463[_0x5d7434(0x207)]),_0x5d8247=_0x419825*(0x1-_0x37d1d3/0x64);_0x40f49c+=_0x5d8247,_0x5555b3='+'+_0x5d8247[_0x5d7434(0x1ea)](0x6)+_0x5d7434(0x14f)+_0x37d1d3+_0x5d7434(0x14e),_0x3db4ab['amountUSDT']=_0x419825,_0x3db4ab[_0x5d7434(0x1c1)]=_0x5d8247,_0x3db4ab[_0x5d7434(0x170)]=new Date(),console[_0x5d7434(0x196)](_0x5d7434(0x1d2)+_0xbaa463[_0x5d7434(0x1ac)]+'\x20'+_0xbaa463['currency']+_0x5d7434(0x1b8)+_0x419825[_0x5d7434(0x1ea)](0x6)+_0x5d7434(0x210)),console[_0x5d7434(0x196)]('üí∞\x20Gateway\x20'+_0xbaa463['gateway']+_0x5d7434(0x1b1)+_0x37d1d3+'%'),console[_0x5d7434(0x196)](_0x5d7434(0x20d)+_0x5d8247['toFixed'](0x6)+_0x5d7434(0x210)),console[_0x5d7434(0x196)](_0x5d7434(0x174)+_0x20f7d6[_0x5d7434(0x202)]+_0x5d7434(0x1af)+_0x5d8247[_0x5d7434(0x1ea)](0x6)+'\x20=\x20'+_0x40f49c[_0x5d7434(0x1ea)](0x6)+_0x5d7434(0x210));}else{if(_0x4d49f4===_0x5d7434(0x1b0)&&_0x2e0024[_0x5d7434(0x1d9)]()!==_0x5d7434(0x1b0)){let _0x1cf30c;if(_0xbaa463[_0x5d7434(0x1c1)])_0x1cf30c=_0xbaa463[_0x5d7434(0x1c1)];else{if(_0xbaa463[_0x5d7434(0x1e4)]){const _0x56acd1=await this[_0x5d7434(0x1b2)](_0x20f7d6['id'],_0xbaa463[_0x5d7434(0x207)]);_0x1cf30c=_0xbaa463['amountUSDT']*(0x1-_0x56acd1/0x64);}else console[_0x5d7434(0x196)](_0x5d7434(0x1d1)),_0x1cf30c=0x0;}_0x1cf30c>0x0&&(_0x40f49c-=_0x1cf30c,_0x5555b3='-'+_0x1cf30c['toFixed'](0x6)+_0x5d7434(0x1f0),_0x3db4ab[_0x5d7434(0x1e4)]=null,_0x3db4ab[_0x5d7434(0x1c1)]=null,_0x3db4ab[_0x5d7434(0x170)]=null,console['log'](_0x5d7434(0x1aa)+_0x20f7d6[_0x5d7434(0x202)]+_0x5d7434(0x218)+_0x1cf30c[_0x5d7434(0x1ea)](0x6)+_0x5d7434(0x213)+_0x40f49c['toFixed'](0x6)+_0x5d7434(0x210)));}}if(_0x2e0024[_0x5d7434(0x1d9)]()===_0x5d7434(0x1a6)){const _0x52624d=_0x57365e?.[_0x5d7434(0x1be)]||0x0;_0x52624d>0x0&&(_0x40f49c-=_0x52624d,_0x5555b3+=_0x5d7434(0x199)+_0x52624d['toFixed'](0x6)+_0x5d7434(0x1d6),_0x3db4ab[_0x5d7434(0x1be)]=_0x52624d,console[_0x5d7434(0x196)](_0x5d7434(0x1fc)+_0x52624d['toFixed'](0x6)+_0x5d7434(0x210)),console[_0x5d7434(0x196)](_0x5d7434(0x1e2)+_0x40f49c[_0x5d7434(0x1ea)](0x6)+_0x5d7434(0x210)));}const _0x397715=await _0x2a9c96['payment']['update']({'where':{'id':_0x580f9b},'data':_0x3db4ab});_0x40f49c!==_0x20f7d6['balance']&&(await _0x2a9c96[_0x5d7434(0x163)]['update']({'where':{'id':_0x20f7d6['id']},'data':{'balance':_0x40f49c}}),console[_0x5d7434(0x196)](_0x5d7434(0x1d5)+_0x20f7d6[_0x5d7434(0x16c)]+'\x20balance\x20updated:\x20'+_0x20f7d6[_0x5d7434(0x202)][_0x5d7434(0x1ea)](0x6)+_0x5d7434(0x1b8)+_0x40f49c['toFixed'](0x6)+'\x20USDT'),console[_0x5d7434(0x196)](_0x5d7434(0x14d)+_0x5555b3));await _0x2a9c96[_0x5d7434(0x198)]['create']({'data':{'paymentId':_0x580f9b,'shopId':_0x20f7d6['id'],'event':_0x5d7434(0x153)+_0x2e0024[_0x5d7434(0x1c6)](),'statusCode':0xc8,'responseBody':JSON[_0x5d7434(0x195)]({'oldStatus':_0x4d49f4,'newStatus':_0x2e0024['toUpperCase'](),'balanceChange':_0x5555b3||_0x5d7434(0x1da),'oldBalance':_0x20f7d6[_0x5d7434(0x202)],'newBalance':_0x40f49c,'amountUSDT':_0x3db4ab['amountUSDT'],'additionalData':_0x57365e,'timestamp':new Date()[_0x5d7434(0x13f)]()})}}),await this[_0x5d7434(0x14b)]({..._0xbaa463,..._0x397715,'shop':_0x20f7d6},_0x2e0024[_0x5d7434(0x1d9)]()),await this[_0x5d7434(0x1a1)]({..._0xbaa463,..._0x397715},_0x2e0024[_0x5d7434(0x1d9)]());if(_0x4d49f4!==_0x5d7434(0x1b0)&&_0x2e0024['toUpperCase']()===_0x5d7434(0x1b0)){console[_0x5d7434(0x196)](_0x5d7434(0x135)+_0x580f9b+_0x5d7434(0x1cf)),console[_0x5d7434(0x196)](_0x5d7434(0x1a9)+_0x4d49f4+_0x5d7434(0x1df)+_0x2e0024[_0x5d7434(0x1d9)]()+_0x5d7434(0x1ec)+_0xbaa463[_0x5d7434(0x12c)]+'\x22');if(_0xbaa463[_0x5d7434(0x12c)])try{const _0x5c112b=await _0x2a9c96[_0x5d7434(0x147)][_0x5d7434(0x1e9)]({'where':{'id':_0xbaa463['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5c112b){console['log'](_0x5d7434(0x149)+_0x5c112b['id']+_0x5d7434(0x131)+_0x5c112b[_0x5d7434(0x134)]+',\x20currentPayments='+_0x5c112b[_0x5d7434(0x156)]+',\x20status='+_0x5c112b[_0x5d7434(0x1e1)]);const _0x2c4c3f=_0x5c112b[_0x5d7434(0x156)]+0x1,_0x422b9b=_0x5c112b[_0x5d7434(0x134)]===_0x5d7434(0x21a)?_0x5d7434(0x1fb):_0x5c112b[_0x5d7434(0x1e1)];await _0x2a9c96[_0x5d7434(0x147)][_0x5d7434(0x1a0)]({'where':{'id':_0xbaa463[_0x5d7434(0x12c)]},'data':{'currentPayments':_0x2c4c3f,'status':_0x422b9b,'updatedAt':new Date()}}),console[_0x5d7434(0x196)](_0x5d7434(0x1a8)+_0x5c112b['id']+'\x20updated:\x20currentPayments='+_0x5c112b[_0x5d7434(0x156)]+_0x5d7434(0x1b8)+_0x2c4c3f+_0x5d7434(0x18a)+_0x5c112b['status']+_0x5d7434(0x1b8)+_0x422b9b);}else console[_0x5d7434(0x196)](_0x5d7434(0x220)+_0xbaa463['paymentLinkId']+'\x20not\x20found');}catch(_0x3b5e73){console['error']('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x3b5e73);}else console[_0x5d7434(0x196)]('üìà\x20Payment\x20'+_0x580f9b+_0x5d7434(0x1c7));}else console[_0x5d7434(0x196)](_0x5d7434(0x135)+_0x580f9b+_0x5d7434(0x1d3)+_0x4d49f4+_0x5d7434(0x1b8)+_0x2e0024[_0x5d7434(0x1d9)]());});}async[a61_0x21a438(0x141)](_0x27fc18){const _0x2a59a3=a61_0x21a438;console[_0x2a59a3(0x196)](_0x2a59a3(0x20a),_0x27fc18);try{const _0x15db8e=await this[_0x2a59a3(0x1ba)][_0x2a59a3(0x1a3)](_0x27fc18);if(!_0x15db8e[_0x2a59a3(0x187)])throw new Error(_0x2a59a3(0x133));const _0x10c5f9=await database_1[_0x2a59a3(0x1ee)][_0x2a59a3(0x1dd)][_0x2a59a3(0x142)]({'where':{'gatewayOrderId':_0x15db8e['paymentId']}});if(!_0x10c5f9){console[_0x2a59a3(0x1bf)](_0x2a59a3(0x1c5)+_0x15db8e[_0x2a59a3(0x187)]);return;}console['log']('üìä\x20Plisio\x20webhook:\x20Payment\x20'+_0x10c5f9['id']+_0x2a59a3(0x211)+_0x15db8e[_0x2a59a3(0x1e1)]),await this[_0x2a59a3(0x1f3)](_0x10c5f9['id'],_0x15db8e[_0x2a59a3(0x1e1)],{'txUrls':_0x15db8e[_0x2a59a3(0x1eb)]}),loggerService_1['loggerService'][_0x2a59a3(0x162)]('plisio',_0x10c5f9['id'],_0x10c5f9[_0x2a59a3(0x1e1)],_0x15db8e['status'],_0x27fc18);}catch(_0x3d9604){console['error']('Error\x20processing\x20Plisio\x20webhook:',_0x3d9604),loggerService_1[_0x2a59a3(0x12a)][_0x2a59a3(0x1e6)]('plisio',_0x3d9604,_0x27fc18);throw _0x3d9604;}}async[a61_0x21a438(0x146)](_0x499edb){const _0x1e3693=a61_0x21a438;console[_0x1e3693(0x196)](_0x1e3693(0x15b),_0x499edb);try{const _0x1bfcd0=await this['plisioService']['processWebhook'](_0x499edb);if(!_0x1bfcd0[_0x1e3693(0x187)])throw new Error(_0x1e3693(0x1ae));const _0xafe1e4=await database_1[_0x1e3693(0x1ee)][_0x1e3693(0x1dd)]['findFirst']({'where':{'gatewayOrderId':_0x1bfcd0['paymentId']}});if(!_0xafe1e4){console[_0x1e3693(0x1bf)](_0x1e3693(0x19a)+_0x1bfcd0[_0x1e3693(0x187)]);return;}console[_0x1e3693(0x196)](_0x1e3693(0x15e)+_0xafe1e4['id']+'\x20status\x20'+_0x1bfcd0[_0x1e3693(0x1e1)]),await this[_0x1e3693(0x1f3)](_0xafe1e4['id'],_0x1bfcd0[_0x1e3693(0x1e1)],{'txUrls':_0x1bfcd0[_0x1e3693(0x1eb)]}),loggerService_1[_0x1e3693(0x12a)][_0x1e3693(0x162)](_0x1e3693(0x16f),_0xafe1e4['id'],_0xafe1e4['status'],_0x1bfcd0[_0x1e3693(0x1e1)],_0x499edb);}catch(_0x2fdd44){console[_0x1e3693(0x1bf)](_0x1e3693(0x1b3),_0x2fdd44),loggerService_1['loggerService']['logWebhookError'](_0x1e3693(0x16f),_0x2fdd44,_0x499edb);throw _0x2fdd44;}}async['processRapydWebhook'](_0x2f4115){const _0xe76a7=a61_0x21a438;console[_0xe76a7(0x196)](_0xe76a7(0x12e),_0x2f4115);try{const _0x47da20=await this[_0xe76a7(0x176)]['processWebhook'](_0x2f4115);if(!_0x47da20[_0xe76a7(0x187)])throw new Error(_0xe76a7(0x159));const _0x408b31=await database_1[_0xe76a7(0x1ee)][_0xe76a7(0x1dd)]['findFirst']({'where':{'gatewayOrderId':_0x47da20[_0xe76a7(0x187)]}});if(!_0x408b31){console[_0xe76a7(0x1bf)](_0xe76a7(0x1db)+_0x47da20[_0xe76a7(0x187)]);return;}console[_0xe76a7(0x196)]('üìä\x20Rapyd\x20webhook:\x20Payment\x20'+_0x408b31['id']+_0xe76a7(0x211)+_0x47da20[_0xe76a7(0x1e1)]),await this[_0xe76a7(0x1f3)](_0x408b31['id'],_0x47da20[_0xe76a7(0x1e1)],{'failureMessage':_0x47da20['failureMessage'],'cardLast4':_0x47da20[_0xe76a7(0x1cb)]?.[_0xe76a7(0x17a)],'paymentMethod':_0x47da20[_0xe76a7(0x1cb)]?.[_0xe76a7(0x169)]}),loggerService_1[_0xe76a7(0x12a)][_0xe76a7(0x162)](_0xe76a7(0x17c),_0x408b31['id'],_0x408b31[_0xe76a7(0x1e1)],_0x47da20[_0xe76a7(0x1e1)],_0x2f4115);}catch(_0x2ca355){console[_0xe76a7(0x1bf)](_0xe76a7(0x1ad),_0x2ca355),loggerService_1[_0xe76a7(0x12a)][_0xe76a7(0x1e6)](_0xe76a7(0x17c),_0x2ca355,_0x2f4115);throw _0x2ca355;}}async[a61_0x21a438(0x1e7)](_0xd3511a){const _0x437728=a61_0x21a438;console[_0x437728(0x196)](_0x437728(0x144),_0xd3511a);try{const _0x41f2e3=await this[_0x437728(0x13c)]['processWebhook'](_0xd3511a);if(!_0x41f2e3[_0x437728(0x187)])throw new Error(_0x437728(0x172));const _0x8f5f79=await database_1[_0x437728(0x1ee)][_0x437728(0x1dd)]['findFirst']({'where':{'gatewayOrderId':_0x41f2e3[_0x437728(0x187)]}});if(!_0x8f5f79){console[_0x437728(0x1bf)](_0x437728(0x138)+_0x41f2e3[_0x437728(0x187)]);return;}console['log'](_0x437728(0x1c3)+_0x8f5f79['id']+_0x437728(0x211)+_0x41f2e3[_0x437728(0x1e1)]),await this[_0x437728(0x1f3)](_0x8f5f79['id'],_0x41f2e3[_0x437728(0x1e1)],{'bankId':_0x41f2e3[_0x437728(0x1cb)]?.[_0x437728(0x14a)],'remitterIban':_0x41f2e3[_0x437728(0x1cb)]?.[_0x437728(0x1bb)],'remitterName':_0x41f2e3['additionalInfo']?.[_0x437728(0x14c)]}),loggerService_1['loggerService']['logWebhookProcessed'](_0x437728(0x219),_0x8f5f79['id'],_0x8f5f79[_0x437728(0x1e1)],_0x41f2e3[_0x437728(0x1e1)],_0xd3511a);}catch(_0x2de101){console[_0x437728(0x1bf)](_0x437728(0x15a),_0x2de101),loggerService_1[_0x437728(0x12a)][_0x437728(0x1e6)]('noda',_0x2de101,_0xd3511a);throw _0x2de101;}}async[a61_0x21a438(0x1c9)](_0x56f9a7){const _0x36e5b2=a61_0x21a438;console[_0x36e5b2(0x196)](_0x36e5b2(0x1ed),_0x56f9a7);try{const _0x3aa1c0=await this[_0x36e5b2(0x165)][_0x36e5b2(0x1a3)](_0x56f9a7);if(!_0x3aa1c0[_0x36e5b2(0x187)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0xfbec47=await database_1[_0x36e5b2(0x1ee)]['payment'][_0x36e5b2(0x142)]({'where':{'gatewayOrderId':_0x3aa1c0[_0x36e5b2(0x187)]}});if(!_0xfbec47){console[_0x36e5b2(0x1bf)](_0x36e5b2(0x178)+_0x3aa1c0['paymentId']);return;}console['log'](_0x36e5b2(0x21e)+_0xfbec47['id']+_0x36e5b2(0x211)+_0x3aa1c0[_0x36e5b2(0x1e1)]),await this[_0x36e5b2(0x1f3)](_0xfbec47['id'],_0x3aa1c0['status']),loggerService_1[_0x36e5b2(0x12a)][_0x36e5b2(0x162)](_0x36e5b2(0x21d),_0xfbec47['id'],_0xfbec47[_0x36e5b2(0x1e1)],_0x3aa1c0['status'],_0x56f9a7);}catch(_0xa24554){console[_0x36e5b2(0x1bf)]('Error\x20processing\x20CoinToPay\x20webhook:',_0xa24554),loggerService_1[_0x36e5b2(0x12a)][_0x36e5b2(0x1e6)](_0x36e5b2(0x21d),_0xa24554,_0x56f9a7);throw _0xa24554;}}async[a61_0x21a438(0x18d)](_0x110e85){const _0x357c94=a61_0x21a438;console[_0x357c94(0x196)](_0x357c94(0x16e),_0x110e85);try{const _0x45626f=await this[_0x357c94(0x214)][_0x357c94(0x1a3)](_0x110e85);if(!_0x45626f['paymentId'])throw new Error(_0x357c94(0x13a));const _0x1acaad=await database_1['default'][_0x357c94(0x1dd)][_0x357c94(0x142)]({'where':{'gatewayOrderId':_0x45626f[_0x357c94(0x187)]}});if(!_0x1acaad){console['error']('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x45626f[_0x357c94(0x187)]);return;}console[_0x357c94(0x196)](_0x357c94(0x194)+_0x1acaad['id']+_0x357c94(0x211)+_0x45626f[_0x357c94(0x1e1)]),await this[_0x357c94(0x1f3)](_0x1acaad['id'],_0x45626f['status']),loggerService_1[_0x357c94(0x12a)][_0x357c94(0x162)](_0x357c94(0x166),_0x1acaad['id'],_0x1acaad[_0x357c94(0x1e1)],_0x45626f[_0x357c94(0x1e1)],_0x110e85);}catch(_0x1966fd){console[_0x357c94(0x1bf)]('Error\x20processing\x20CoinToPay2\x20webhook:',_0x1966fd),loggerService_1[_0x357c94(0x12a)]['logWebhookError'](_0x357c94(0x166),_0x1966fd,_0x110e85);throw _0x1966fd;}}async[a61_0x21a438(0x168)](_0x3f602e){const _0x10d334=a61_0x21a438;console[_0x10d334(0x196)]('üîÑ\x20Processing\x20KLYME\x20webhook:',_0x3f602e);try{const _0x462cce=await this['klymeService'][_0x10d334(0x1a3)](_0x3f602e);if(!_0x462cce[_0x10d334(0x187)])throw new Error(_0x10d334(0x1fa));const _0x32bda0=await database_1[_0x10d334(0x1ee)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x462cce[_0x10d334(0x187)]}});if(!_0x32bda0){console['error'](_0x10d334(0x19e)+_0x462cce[_0x10d334(0x187)]);return;}console[_0x10d334(0x196)](_0x10d334(0x157)+_0x32bda0['id']+_0x10d334(0x211)+_0x462cce[_0x10d334(0x1e1)]),await this[_0x10d334(0x1f3)](_0x32bda0['id'],_0x462cce[_0x10d334(0x1e1)],{'paymentMethod':_0x462cce[_0x10d334(0x1cb)]?.[_0x10d334(0x1b9)]}),loggerService_1['loggerService'][_0x10d334(0x162)]('klyme',_0x32bda0['id'],_0x32bda0[_0x10d334(0x1e1)],_0x462cce[_0x10d334(0x1e1)],_0x3f602e);}catch(_0x471db2){console['error'](_0x10d334(0x15c),_0x471db2),loggerService_1[_0x10d334(0x12a)]['logWebhookError'](_0x10d334(0x155),_0x471db2,_0x3f602e);throw _0x471db2;}}async['processMasterCardWebhook'](_0x23a53f){const _0x29ad1f=a61_0x21a438;console[_0x29ad1f(0x196)]('üîÑ\x20Processing\x20MasterCard\x20webhook:',JSON[_0x29ad1f(0x195)](_0x23a53f,null,0x2));try{const _0x7a0ec=await this[_0x29ad1f(0x19d)][_0x29ad1f(0x1a3)](_0x23a53f);console['log'](_0x29ad1f(0x1b7),_0x7a0ec);if(!_0x7a0ec[_0x29ad1f(0x187)]){console[_0x29ad1f(0x1bf)](_0x29ad1f(0x143)),console[_0x29ad1f(0x1bf)](_0x29ad1f(0x1a2),Object['keys'](_0x23a53f));throw new Error(_0x29ad1f(0x1fd));}let _0x37685a=null;console[_0x29ad1f(0x196)]('üîç\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x7a0ec[_0x29ad1f(0x187)]);_0x7a0ec[_0x29ad1f(0x187)]&&(console['log'](_0x29ad1f(0x188)),_0x37685a=await database_1[_0x29ad1f(0x1ee)][_0x29ad1f(0x1dd)]['findFirst']({'where':{'AND':[{'gateway':_0x29ad1f(0x206)},{'OR':[{'gatewayPaymentId':_0x7a0ec[_0x29ad1f(0x187)]},{'gatewayOrderId':_0x7a0ec[_0x29ad1f(0x187)]},{'id':_0x7a0ec[_0x29ad1f(0x187)]},{'orderId':_0x7a0ec['paymentId']}]}]}}),console[_0x29ad1f(0x196)](_0x29ad1f(0x158)+(_0x37685a?_0x29ad1f(0x18c)+_0x37685a['id']:'Payment\x20not\x20found')));if(!_0x37685a){console[_0x29ad1f(0x1bf)](_0x29ad1f(0x1ca)+_0x7a0ec['paymentId']),console[_0x29ad1f(0x1bf)]('üîç\x20Searched\x20by:\x20gatewayOrderId=\x22'+_0x7a0ec['paymentId']+_0x29ad1f(0x1f6)+_0x7a0ec['paymentId']+'\x22,\x20orderId=\x22'+_0x7a0ec[_0x29ad1f(0x187)]+'\x22');const _0x386e89=await database_1[_0x29ad1f(0x1ee)][_0x29ad1f(0x1dd)][_0x29ad1f(0x160)]({'where':{'gateway':_0x29ad1f(0x206)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x29ad1f(0x196)](_0x29ad1f(0x191),_0x386e89);return;}console[_0x29ad1f(0x196)](_0x29ad1f(0x16d)+_0x37685a['id']+_0x29ad1f(0x201)+_0x37685a[_0x29ad1f(0x1e1)]+_0x29ad1f(0x13e)+_0x7a0ec[_0x29ad1f(0x1e1)]),await this[_0x29ad1f(0x1f3)](_0x37685a['id'],_0x7a0ec[_0x29ad1f(0x1e1)]),loggerService_1['loggerService']['logWebhookProcessed'](_0x29ad1f(0x206),_0x37685a['id'],_0x37685a[_0x29ad1f(0x1e1)],_0x7a0ec['status'],_0x23a53f);}catch(_0x26016d){console[_0x29ad1f(0x1bf)]('‚ùå\x20Error\x20processing\x20MasterCard\x20webhook:',_0x26016d),loggerService_1['loggerService'][_0x29ad1f(0x1e6)](_0x29ad1f(0x206),_0x26016d,_0x23a53f);throw _0x26016d;}}async['processAmerWebhook'](_0x41c9a7){const _0x32d9c1=a61_0x21a438;console['log']('üîÑ\x20Processing\x20Amer\x20webhook:',JSON['stringify'](_0x41c9a7,null,0x2));try{const _0x5b954e=await this['amerService'][_0x32d9c1(0x1a3)](_0x41c9a7);console['log'](_0x32d9c1(0x140),_0x5b954e);if(!_0x5b954e[_0x32d9c1(0x187)]){console[_0x32d9c1(0x1bf)](_0x32d9c1(0x154)),console[_0x32d9c1(0x1bf)](_0x32d9c1(0x1a2),Object[_0x32d9c1(0x13b)](_0x41c9a7));throw new Error(_0x32d9c1(0x1d7));}let _0x3180d9=null;console[_0x32d9c1(0x196)]('üîç\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x5b954e[_0x32d9c1(0x187)]),_0x3180d9=await database_1[_0x32d9c1(0x1ee)][_0x32d9c1(0x1dd)][_0x32d9c1(0x142)]({'where':{'AND':[{'gateway':'amer'},{'OR':[{'gatewayPaymentId':_0x5b954e['paymentId']},{'gatewayOrderId':_0x5b954e[_0x32d9c1(0x187)]},{'id':_0x5b954e[_0x32d9c1(0x187)]},{'orderId':_0x5b954e[_0x32d9c1(0x187)]}]}]}}),console[_0x32d9c1(0x196)](_0x32d9c1(0x158)+(_0x3180d9?_0x32d9c1(0x18c)+_0x3180d9['id']:_0x32d9c1(0x19b)));if(!_0x3180d9){console[_0x32d9c1(0x1bf)](_0x32d9c1(0x21f)+_0x5b954e[_0x32d9c1(0x187)]);return;}console[_0x32d9c1(0x196)]('üìä\x20Amer\x20webhook:\x20Payment\x20'+_0x3180d9['id']+_0x32d9c1(0x211)+_0x5b954e[_0x32d9c1(0x1e1)]),await this[_0x32d9c1(0x1f3)](_0x3180d9['id'],_0x5b954e[_0x32d9c1(0x1e1)],{'cardLast4':_0x5b954e[_0x32d9c1(0x1cb)]?.[_0x32d9c1(0x17a)],'paymentMethod':_0x5b954e[_0x32d9c1(0x1cb)]?.['paymentMethod']});}catch(_0x4a8cd9){console[_0x32d9c1(0x1bf)](_0x32d9c1(0x17e),_0x4a8cd9),loggerService_1['loggerService'][_0x32d9c1(0x1e6)](_0x32d9c1(0x1b5),_0x4a8cd9,_0x41c9a7);throw _0x4a8cd9;}}async[a61_0x21a438(0x14b)](_0x234472,_0x5561a6){const _0x359016=a61_0x21a438,_0x14700c=Date[_0x359016(0x197)]();try{const _0x5dc381=_0x234472[_0x359016(0x163)],_0x52375b=_0x5dc381[_0x359016(0x173)];if(!_0x52375b?.[_0x359016(0x192)]){console[_0x359016(0x196)](_0x359016(0x148)+_0x5dc381['id']);return;}const _0x33f463=_0x5561a6==='PAID'?_0x359016(0x189):_0x5561a6===_0x359016(0x13d)?'payment.failed':_0x5561a6===_0x359016(0x18f)?_0x359016(0x209):_0x5561a6===_0x359016(0x1a6)?_0x359016(0x209):_0x5561a6===_0x359016(0x216)?_0x359016(0x209):_0x359016(0x1f7);let _0x3e8bbb=[];if(_0x52375b[_0x359016(0x203)])try{_0x3e8bbb=Array[_0x359016(0x17b)](_0x52375b[_0x359016(0x203)])?_0x52375b['webhookEvents']:JSON['parse'](_0x52375b[_0x359016(0x203)]);}catch(_0x3c15c6){console[_0x359016(0x1bf)](_0x359016(0x21b),_0x3c15c6),_0x3e8bbb=[];}if(!_0x3e8bbb[_0x359016(0x1a4)](_0x33f463)){console['log'](_0x359016(0x151)+_0x33f463+_0x359016(0x217)+_0x5dc381['id']);return;}const _0x44fe72={'event':_0x33f463,'payment':{'id':_0x234472['id'],'order_id':_0x234472[_0x359016(0x137)],'gateway_order_id':_0x234472['gatewayOrderId'],'gateway':_0x234472[_0x359016(0x207)],'amount':_0x234472[_0x359016(0x1ac)],'currency':_0x234472['currency'],'status':_0x5561a6[_0x359016(0x1c6)](),'customer_email':_0x234472[_0x359016(0x205)],'customer_name':_0x234472['customerName'],'failure_message':_0x234472[_0x359016(0x136)],'tx_urls':_0x234472[_0x359016(0x1eb)]?JSON[_0x359016(0x132)](_0x234472[_0x359016(0x1eb)]):null,'created_at':_0x234472['createdAt'],'updated_at':_0x234472[_0x359016(0x150)]}},_0x49821e=await fetch(_0x52375b[_0x359016(0x192)],{'method':_0x359016(0x1e3),'headers':{'Content-Type':_0x359016(0x204),'User-Agent':_0x359016(0x1f1)},'body':JSON[_0x359016(0x195)](_0x44fe72)}),_0x269b79=Date[_0x359016(0x197)]()-_0x14700c,_0x1c011d=_0x49821e['ok']?_0x359016(0x179):await _0x49821e[_0x359016(0x175)]();loggerService_1[_0x359016(0x12a)][_0x359016(0x1dc)](_0x234472['shopId'],_0x52375b[_0x359016(0x192)],_0x33f463,_0x49821e[_0x359016(0x1e1)],_0x269b79,_0x44fe72),console[_0x359016(0x196)](_0x359016(0x1f9)+_0x52375b['webhookUrl']+_0x359016(0x164)+_0x49821e[_0x359016(0x1e1)]+'\x20('+_0x269b79+_0x359016(0x1c0));}catch(_0x221eb3){console[_0x359016(0x1bf)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x221eb3),loggerService_1[_0x359016(0x12a)][_0x359016(0x1bc)](_0x234472[_0x359016(0x21c)],_0x234472[_0x359016(0x163)]?.[_0x359016(0x173)]?.[_0x359016(0x192)]||_0x359016(0x12f),_0x359016(0x12d),_0x221eb3,{});}}async['sendPaymentStatusNotification'](_0x4cab77,_0x2e621f){const _0x1dd282=a61_0x21a438;try{const _0x593412={'PENDING':_0x1dd282(0x16a),'PROCESSING':_0x1dd282(0x185),'PAID':'paid','FAILED':_0x1dd282(0x208),'EXPIRED':_0x1dd282(0x186),'REFUND':_0x1dd282(0x200),'CHARGEBACK':_0x1dd282(0x15d)},_0x14afb1=_0x593412[_0x2e621f];if(!_0x14afb1||_0x14afb1===_0x1dd282(0x16a))return;await telegramBotService_1[_0x1dd282(0x1c4)][_0x1dd282(0x1f8)](_0x4cab77[_0x1dd282(0x21c)],_0x4cab77,_0x14afb1);}catch(_0x41664b){console[_0x1dd282(0x1bf)](_0x1dd282(0x161),_0x41664b);}}async[a61_0x21a438(0x1b2)](_0xac0238,_0x42a9b6){const _0x5b5c26=a61_0x21a438;try{const _0x1851b1=await database_1[_0x5b5c26(0x1ee)][_0x5b5c26(0x163)][_0x5b5c26(0x1e9)]({'where':{'id':_0xac0238},'select':{'gatewaySettings':!![]}});if(!_0x1851b1?.[_0x5b5c26(0x1ef)])return console[_0x5b5c26(0x196)](_0x5b5c26(0x1a7)+_0xac0238+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x5a45a2=JSON[_0x5b5c26(0x132)](_0x1851b1[_0x5b5c26(0x1ef)]);for(const [_0x1daa98,_0x23f11f]of Object[_0x5b5c26(0x1cd)](_0x5a45a2)){if(_0x1daa98[_0x5b5c26(0x1c6)]()===_0x42a9b6[_0x5b5c26(0x1c6)]()){const _0x509ea0=_0x23f11f['commission']||0xa;return console[_0x5b5c26(0x196)](_0x5b5c26(0x184)+_0x42a9b6+_0x5b5c26(0x1a5)+_0xac0238+':\x20'+_0x509ea0+'%'),_0x509ea0;}}return console[_0x5b5c26(0x196)](_0x5b5c26(0x1c2)+_0x42a9b6+_0x5b5c26(0x20c)+_0xac0238+',\x20using\x20default\x2010%'),0xa;}catch(_0x2bc172){return console[_0x5b5c26(0x1bf)](_0x5b5c26(0x1c8)+_0xac0238+_0x5b5c26(0x1e5)+_0x42a9b6+':',_0x2bc172),0xa;}}}exports[a61_0x21a438(0x1f4)]=WebhookService;function a61_0x1740(_0x44c3f4,_0x3e62ee){const _0x238847=a61_0x2388();return a61_0x1740=function(_0x17406a,_0x3b2043){_0x17406a=_0x17406a-0x12a;let _0x58709f=_0x238847[_0x17406a];return _0x58709f;},a61_0x1740(_0x44c3f4,_0x3e62ee);}function a61_0x2388(){const _0x1884a7=['paymentLinkId','webhook_send','üîÑ\x20Processing\x20Rapyd\x20webhook:','unknown','amerService',':\x20type=','parse','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','type','üìà\x20Payment\x20','failureMessage','orderId','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','üí∞\x20Payment\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','keys','nodaService','FAILED','\x20to\x20','toISOString','üìä\x20Amer\x20webhook\x20result:','processPlisioWebhook','findFirst','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','üîÑ\x20Processing\x20Noda\x20webhook:','__importDefault','processPlisioGatewayWebhook','paymentLink','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','üìà\x20Found\x20payment\x20link\x20','bankId','sendShopWebhook','remitterName','üìù\x20Reason:\x20','%\x20gateway\x20commission)','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','updatedAt','Webhook\x20event\x20','__esModule','webhook_status_change_','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','klyme','currentPayments','üìä\x20KLYME\x20webhook:\x20Payment\x20','üîç\x20Search\x20result:\x20','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','Error\x20processing\x20Noda\x20webhook:','üîÑ\x20Processing\x20Plisio\x20Gateway\x20webhook:','Error\x20processing\x20KLYME\x20webhook:','chargeback','üìä\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','./gateways/klymeService','findMany','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','logWebhookProcessed','shop','\x20with\x20status\x20','coinToPayService','cointopay2','MasterCardService','processKlymeWebhook','paymentMethod','created','defineProperty','username','‚úÖ\x20Found\x20payment\x20','üîÑ\x20Processing\x20CoinToPay2\x20webhook:','plisio_gateway','paidAt','KlymeService','No\x20payment\x20ID\x20in\x20Noda\x20webhook','settings','üí∞\x20Adding\x20to\x20balance:\x20','text','rapydService','\x20current\x20balance:\x20','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','Success','cardLast4','isArray','rapyd','üîÑ\x20updatePaymentStatus\x20called:\x20paymentId=','‚ùå\x20Error\x20processing\x20Amer\x20webhook:','klymeService','8611578fCtbdl','CoinToPay2Service','./telegramBotService','üè™\x20Shop\x20','Gateway\x20','processing','expired','paymentId','üîç\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','payment.success',',\x20status=','üîÑ\x20Additional\x20data:','Found\x20payment\x20','processCoinToPay2Webhook','./loggerService','EXPIRED','2obDVNc','üîç\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','webhookUrl','./gateways/plisioService','üìä\x20CoinToPay2\x20webhook:\x20Payment\x20','stringify','log','now','webhookLog','\x20and\x20-','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','Payment\x20not\x20found','48732620IyIyKk','masterCardService','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','./gateways/amerService','update','sendPaymentStatusNotification','‚ùå\x20Available\x20webhook\x20fields:','processWebhook','includes','\x20commission\x20for\x20shop\x20','CHARGEBACK','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','‚úÖ\x20Payment\x20link\x20','üìà\x20Payment\x20details:\x20oldStatus=\x22','üí∞\x20Removing\x20from\x20balance:\x20','./gateways/nodaService','amount','Error\x20processing\x20Rapyd\x20webhook:','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','\x20+\x20','PAID','\x20commission:\x20','getGatewayCommission','Error\x20processing\x20Plisio\x20Gateway\x20webhook:',',\x20newStatus=','amer','4377537lgimFz','üìä\x20MasterCard\x20webhook\x20result:','\x20->\x20','payment_method','plisioService','remitterIban','logShopWebhookError','11051064nvzpIZ','chargebackAmount','error','ms)','amountAfterGatewayCommissionUSDT','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','üìä\x20Noda\x20webhook:\x20Payment\x20','telegramBotService','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','toLowerCase','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','processCoinToPayWebhook','‚ùå\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','additionalInfo','../config/database','entries','./gateways/mastercardService','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','223798eVsouA','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','üí∞\x20Converting\x20','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','currencyService','‚úÖ\x20Shop\x20','\x20USDT\x20(chargeback\x20penalty)','No\x20payment\x20ID\x20in\x20Amer\x20webhook','$transaction','toUpperCase','no\x20balance\x20change','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','logShopWebhookSent','payment','4ETQnCl','\x22,\x20newStatus=\x22','./currencyService','status','üí∞\x20Final\x20balance\x20after\x20chargeback:\x20','POST','amountUSDT',',\x20gateway\x20','logWebhookError','processNodaWebhook','./gateways/coinToPayService','findUnique','toFixed','txUrls','\x22,\x20paymentLinkId=\x22','üîÑ\x20Processing\x20CoinToPay\x20webhook:','default','gatewaySettings','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','TesSoft\x20Payment\x20System/1.0','6131060QaoDtM','updatePaymentStatus','WebhookService','NodaService','\x22,\x20id=\x22','payment.pending','sendPaymentNotification','üì§\x20Shop\x20webhook\x20sent\x20to\x20','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','COMPLETED','üí∏\x20Additional\x20chargeback\x20penalty:\x20-','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','PlisioService','CoinToPayService','refund','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','balance','webhookEvents','application/json','customerEmail','mastercard','gateway','failed','payment.failed','üîÑ\x20Processing\x20Plisio\x20webhook:','AmerService','\x20in\x20shop\x20','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','23418IqBvJo','Payment\x20','\x20USDT','\x20status\x20','1967YHMXgC','\x20=\x20','coinToPay2Service','./gateways/coinToPay2Service','REFUND','\x20not\x20enabled\x20for\x20shop\x20','\x20-\x20','noda','SINGLE','Error\x20parsing\x20webhook\x20events:','shopId','cointopay','üìä\x20CoinToPay\x20webhook:\x20Payment\x20','‚ùå\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','‚ùå\x20Payment\x20link\x20','loggerService','./gateways/rapydService'];a61_0x2388=function(){return _0x1884a7;};return a61_0x2388();}