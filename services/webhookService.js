'use strict';function a65_0x4057(){const _0x3467f9=['‚ÑπÔ∏è\x20AmPay\x20status\x20','findFirst','DECLINED','refund','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','‚ùå\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','AmPayTRYService','üîç\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20for\x20MyXSpend\x20webhook','system_id','error','application/json','gateway','32081DhbcNe','gatewayPaymentId','ampay_try_','ampay_try','rapydService','currentPayments','getGatewayCommission','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','\x20commission\x20for\x20shop\x20','currency','./telegramBotService','created','updatePaymentStatus','payment.failed','‚ùå\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...',',\x20currentPayments=','Payment\x20not\x20found:\x20','client_transaction_id','üîÑ\x20Processing\x20KLYME\x20webhook:','EXPIRED','üí∞\x20Adding\x20to\x20balance:\x20','ampay','ampayService','amountUSDT','processNodaWebhook','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','üîÑ\x20MyXSpend\x20status\x20','processMyXSpendWebhook','toFixed','üîç\x20Search\x20result:\x20','paymentMethod','Error\x20processing\x20Rapyd\x20webhook:','‚ùå\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','WebhookService','username','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','KlymeService','failed','9159250cXyeyN','üîÑ\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','cardLast4','gatewaySettings','‚ùå\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','\x20updated:\x20currentPayments=','amerService','payment.success','createdAt','üîÑ\x20Processing\x20MyXSpend\x20webhook:','plisio_gateway','MasterCard\x20payment\x20not\x20found:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','149697mrNMDX','‚ùå\x20Payment\x20link\x20','‚ùå\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','paid','‚ùå\x20Available\x20webhook\x20fields:','remitterIban','txUrls','visa_mastercard','üîç\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','toUpperCase','text','\x20in\x20shop\x20','./loggerService','1578360OeUUMX','chargeback','logWebhookError','NodaService','üîÑ\x20Processing\x20Amer\x20webhook:','12bEUBMm','paymentLinkId','bankId',',\x20GatewayPaymentId=','visa_','üìà\x20Payment\x20','remitterName','üí∞\x20Final\x20balance\x20after\x20chargeback:\x20','paymentLink','üîç\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','\x20USDT','shopId','\x20status\x20','üîç\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','status_addition_info','‚ùå\x20Error\x20processing\x20AmPay\x20webhook:','Failed\x20to\x20send\x20shop\x20webhook:','‚úÖ\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','ampayTRYService','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','coinToPay2Service','üîç\x20VISA\x20payment\x20search\x20executed','‚ÑπÔ∏è\x20MyXSpend\x20status\x20','VisaMasterCardService','keys','SINGLE','./gateways/mastercardService','üìä\x20VISA\x20payment\x20found:\x20','logShopWebhookSent','plisioService','Payment\x20System/1.0','üîÑ\x20Processing\x20CoinToPay\x20webhook:','‚ùå\x20VISA\x20webhook\x20processing\x20failed:','webhookUrl','‚ùå\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20','shop',',\x20newStatus=',',\x20Status=','customerName','üîÑ\x20Processing\x20Rapyd\x20webhook:','cointopay2','No\x20additional\x20info','processPlisioWebhook','commission','\x20=\x20','klymeService','\x20mapped\x20to\x20FAILED','noda',',\x20Gateway=','./gateways/coinToPayService','payment_method','Payment\x20not\x20found','./currencyService','myxspend_','amountAfterGatewayCommissionUSDT','üîÑ\x20Processing\x20Plisio\x20Gateway\x20webhook:','__importDefault','nodaService','üîç\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:','Not\x20found','parse','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','üí∞\x20Removing\x20from\x20balance:\x20','üí∞\x20Payment\x20','\x20to\x20','Success','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','./gateways/ampayTRYService','474388HMwTxT',',\x20gatewayOrderId:\x20','findMany','\x20not\x20found','CHARGEBACK','entries','PAID','No\x20payment\x20ID\x20in\x20Noda\x20webhook','cointopay','üìä\x20Noda\x20webhook:\x20Payment\x20','klyme','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','./gateways/amerService','\x20with\x20status\x20','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','VISA\x20payment\x20not\x20found:\x20','üí∞\x20Gateway\x20','convertToUSDT','464mFvvXD','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','payment','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','\x20‚Üí\x20','No\x20payment\x20ID\x20in\x20Amer\x20webhook','Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook','üîÑ\x20updatePaymentStatus\x20called:\x20paymentId=','desc','coinToPayService','visa/mastercard','webhookEvents','üîç\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','‚ùå\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook','settings','üìä\x20AmPay\x20webhook\x20data:','$transaction','üîÑ\x20Processing\x20AmPay\x20webhook:','Body\x20data:','‚ùå\x20Error\x20processing\x20Amer\x20webhook:',':\x20type=','webhook_status_change_','üìä\x20Plisio\x20webhook:\x20Payment\x20','‚ùå\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','balance','\x20(Status:\x20','processCoinToPayWebhook','üìä\x20Payment\x20status:\x20','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','webhook_send','processing','Payment\x20','telegramBotService','update','üìä\x20Amer\x20webhook\x20result:','üìà\x20Found\x20payment\x20link\x20','default','__esModule','\x20USDT\x20(chargeback\x20penalty)','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','‚ùå\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','sendPaymentStatusNotification','\x22,\x20newStatus=\x22','updatedAt','AmPayService','./gateways/coinToPay2Service','loggerService','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','214109LZXjwa','plisio','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','üì§\x20Shop\x20webhook\x20sent\x20to\x20','üìà\x20Payment\x20details:\x20oldStatus=\x22','sendPaymentNotification','sendShopWebhook','type','üîÑ\x20Processing\x20AmPay\x20TRY\x20webhook:',',\x20card:\x20****','processCoinToPay2Webhook','errorMessage','üìù\x20Reason:\x20','üîç\x20Searched\x20by:\x20gatewayOrderId=\x22','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','status','üìä\x20Amer\x20webhook:\x20Payment\x20','dateTime','map','2178215MVkOhF','üí∏\x20Additional\x20chargeback\x20penalty:\x20-','amer','‚ùå\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','üìä\x20CoinToPay\x20webhook:\x20Payment\x20','‚ùå\x20VISA\x20payment\x20failed\x20with\x20message:\x20','\x20->\x20','üîÑ\x20Processing\x20CoinToPay2\x20webhook:','\x22,\x20orderId=\x22','orderId','\x20not\x20enabled\x20for\x20shop\x20','create',',\x20status=','FAILED','Query\x20params:','paymentId','system','ampay_','REFUND','no\x20balance\x20change','rapyd','üîÑ\x20Processing\x20MasterCard\x20webhook:','CoinToPayService',',\x20using\x20default\x2010%','Gateway\x20','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','ms)','processMasterCardWebhook','stringify','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','CoinToPay2Service','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','9UIGMLx','toLowerCase','findUnique','Webhook\x20event\x20','Found','logWebhookProcessed','‚úÖ\x20Shop\x20','‚ùå\x20Error\x20processing\x20MyXSpend\x20webhook:','visa','processPlisioGatewayWebhook','üîÑ\x20Processing\x20VISA\x20webhook:','üîç\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','./gateways/klymeService','‚ùå\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','chargebackAmount','Found\x20payment\x20','‚ÑπÔ∏è\x20Decline\x20reason:\x20','\x20status\x20updated\x20to\x20FAILED','üìä\x20AmPay\x20TRY\x20webhook\x20data:','log','‚úÖ\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','‚úÖ\x20Found\x20payment\x20','myxspend','gatewayOrderId','Error\x20processing\x20CoinToPay2\x20webhook:','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','üìä\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','\x22,\x20paymentLinkId=\x22','failureMessage','additionalInfo','processWebhook','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','currencyService','amount','visaMasterCardService','expired','‚úÖ\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20','mastercard','unknown','webhookLog'];a65_0x4057=function(){return _0x3467f9;};return a65_0x4057();}const a65_0xe7502a=a65_0x288e;(function(_0xa0db33,_0x590c6e){const _0x5b56ba=a65_0x288e,_0x2a7bb0=_0xa0db33();while(!![]){try{const _0x23c8a0=parseInt(_0x5b56ba(0x25c))/0x1+parseInt(_0x5b56ba(0x219))/0x2+-parseInt(_0x5b56ba(0x1c3))/0x3*(parseInt(_0x5b56ba(0x1d5))/0x4)+-parseInt(_0x5b56ba(0x26f))/0x5+-parseInt(_0x5b56ba(0x1d0))/0x6+parseInt(_0x5b56ba(0x18f))/0x7*(-parseInt(_0x5b56ba(0x22b))/0x8)+-parseInt(_0x5b56ba(0x15a))/0x9*(-parseInt(_0x5b56ba(0x1b6))/0xa);if(_0x23c8a0===_0x590c6e)break;else _0x2a7bb0['push'](_0x2a7bb0['shift']());}catch(_0x60c9b6){_0x2a7bb0['push'](_0x2a7bb0['shift']());}}}(a65_0x4057,0x3dc56));var __importDefault=this&&this[a65_0xe7502a(0x20d)]||function(_0x1c4bf3){const _0x2b2c90=a65_0xe7502a;return _0x1c4bf3&&_0x1c4bf3[_0x2b2c90(0x251)]?_0x1c4bf3:{'default':_0x1c4bf3};};Object['defineProperty'](exports,a65_0xe7502a(0x251),{'value':!![]}),exports[a65_0xe7502a(0x1b1)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require('./gateways/plisioService'),rapydService_1=require('./gateways/rapydService'),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a65_0xe7502a(0x206)),coinToPay2Service_1=require(a65_0xe7502a(0x259)),klymeService_1=require(a65_0xe7502a(0x166)),mastercardService_1=require(a65_0xe7502a(0x1ef)),amerService_1=require(a65_0xe7502a(0x225)),ampayService_1=require('./gateways/ampayService'),ampayTRYService_1=require(a65_0xe7502a(0x218)),telegramBotService_1=require(a65_0xe7502a(0x199)),currencyService_1=require(a65_0xe7502a(0x209)),loggerService_1=require(a65_0xe7502a(0x1cf));function a65_0x288e(_0x1805b7,_0x172591){const _0x40572d=a65_0x4057();return a65_0x288e=function(_0x288e87,_0xf82fea){_0x288e87=_0x288e87-0x13e;let _0x1746a7=_0x40572d[_0x288e87];return _0x1746a7;},a65_0x288e(_0x1805b7,_0x172591);}class WebhookService{constructor(){const _0x1d4519=a65_0xe7502a;this['plisioService']=new plisioService_1['PlisioService'](),this[_0x1d4519(0x193)]=new rapydService_1['RapydService'](),this[_0x1d4519(0x20e)]=new nodaService_1[(_0x1d4519(0x1d3))](),this[_0x1d4519(0x235)]=new coinToPayService_1[(_0x1d4519(0x150))](),this[_0x1d4519(0x1e9)]=new coinToPay2Service_1[(_0x1d4519(0x158))](),this['klymeService']=new klymeService_1[(_0x1d4519(0x1b4))](),this[_0x1d4519(0x17c)]=new mastercardService_1[(_0x1d4519(0x1ec))](),this[_0x1d4519(0x1bc)]=new amerService_1['AmerService'](),this[_0x1d4519(0x1a5)]=new ampayService_1[(_0x1d4519(0x258))](),this[_0x1d4519(0x1e7)]=new ampayTRYService_1[(_0x1d4519(0x188))]();}async[a65_0xe7502a(0x19b)](_0x2ce7ce,_0x57c01e,_0x5a8940){const _0x285dcc=a65_0xe7502a;console['log'](_0x285dcc(0x233)+_0x2ce7ce+_0x285dcc(0x1f9)+_0x57c01e),console[_0x285dcc(0x16d)]('üîÑ\x20Additional\x20data:',_0x5a8940),await database_1['default'][_0x285dcc(0x23c)](async _0x11d0cf=>{const _0x2aa5cb=_0x285dcc,_0x437330=await _0x11d0cf[_0x2aa5cb(0x22d)][_0x2aa5cb(0x15c)]({'where':{'id':_0x2ce7ce},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x437330)throw new Error(_0x2aa5cb(0x24b)+_0x2ce7ce+'\x20not\x20found');const _0x2ece61=_0x437330[_0x2aa5cb(0x26b)],_0x2eed19=_0x437330[_0x2aa5cb(0x1f8)];console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x214)+_0x2ce7ce+':\x20'+_0x2ece61+'\x20->\x20'+_0x57c01e),console[_0x2aa5cb(0x16d)]('üè™\x20Shop\x20'+_0x2eed19[_0x2aa5cb(0x1b2)]+'\x20current\x20balance:\x20'+_0x2eed19[_0x2aa5cb(0x244)]+_0x2aa5cb(0x1df));const _0x5d42a0={'status':_0x57c01e['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x2aa5cb(0x14a),'statusChangedAt':new Date()};_0x5a8940?.[_0x2aa5cb(0x176)]&&(_0x5d42a0['failureMessage']=_0x5a8940[_0x2aa5cb(0x176)]);_0x5a8940?.['txUrls']&&(_0x5d42a0[_0x2aa5cb(0x1c9)]=JSON[_0x2aa5cb(0x156)](_0x5a8940[_0x2aa5cb(0x1c9)]));_0x5a8940?.[_0x2aa5cb(0x1b8)]&&(_0x5d42a0[_0x2aa5cb(0x1b8)]=_0x5a8940[_0x2aa5cb(0x1b8)]);_0x5a8940?.[_0x2aa5cb(0x1ad)]&&(_0x5d42a0['paymentMethod']=_0x5a8940[_0x2aa5cb(0x1ad)]);_0x5a8940?.[_0x2aa5cb(0x1d7)]&&(_0x5d42a0['bankId']=_0x5a8940[_0x2aa5cb(0x1d7)]);_0x5a8940?.[_0x2aa5cb(0x1c8)]&&(_0x5d42a0['remitterIban']=_0x5a8940['remitterIban']);_0x5a8940?.[_0x2aa5cb(0x1db)]&&(_0x5d42a0[_0x2aa5cb(0x1db)]=_0x5a8940[_0x2aa5cb(0x1db)]);let _0x3aae96=_0x2eed19[_0x2aa5cb(0x244)],_0x104627='';if(_0x57c01e[_0x2aa5cb(0x1cc)]()===_0x2aa5cb(0x21f)&&_0x2ece61!==_0x2aa5cb(0x21f)){const _0x1915eb=await currencyService_1[_0x2aa5cb(0x17a)][_0x2aa5cb(0x22a)](_0x437330[_0x2aa5cb(0x17b)],_0x437330[_0x2aa5cb(0x198)]),_0x8ed25e=await this[_0x2aa5cb(0x195)](_0x2eed19['id'],_0x437330[_0x2aa5cb(0x18e)]),_0xe99c05=_0x1915eb*(0x1-_0x8ed25e/0x64);_0x3aae96+=_0xe99c05,_0x104627='+'+_0xe99c05[_0x2aa5cb(0x1ab)](0x6)+'\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20'+_0x8ed25e+'%\x20gateway\x20commission)',_0x5d42a0[_0x2aa5cb(0x1a6)]=_0x1915eb,_0x5d42a0['amountAfterGatewayCommissionUSDT']=_0xe99c05,_0x5d42a0['gatewayCommissionRate']=_0x8ed25e,_0x5d42a0['paidAt']=new Date(),console[_0x2aa5cb(0x16d)]('üí∞\x20Converting\x20'+_0x437330['amount']+'\x20'+_0x437330[_0x2aa5cb(0x198)]+'\x20->\x20'+_0x1915eb[_0x2aa5cb(0x1ab)](0x6)+_0x2aa5cb(0x1df)),console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x229)+_0x437330[_0x2aa5cb(0x18e)]+'\x20commission:\x20'+_0x8ed25e+'%'),console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x212)+_0xe99c05[_0x2aa5cb(0x1ab)](0x6)+_0x2aa5cb(0x1df)),console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x1a3)+_0x2eed19[_0x2aa5cb(0x244)]+'\x20+\x20'+_0xe99c05[_0x2aa5cb(0x1ab)](0x6)+'\x20=\x20'+_0x3aae96[_0x2aa5cb(0x1ab)](0x6)+_0x2aa5cb(0x1df));}else{if(_0x2ece61==='PAID'&&_0x57c01e[_0x2aa5cb(0x1cc)]()!==_0x2aa5cb(0x21f)){let _0x177abd;if(_0x437330[_0x2aa5cb(0x20b)])_0x177abd=_0x437330['amountAfterGatewayCommissionUSDT'];else{if(_0x437330[_0x2aa5cb(0x1a6)]){const _0x47fb0e=await this[_0x2aa5cb(0x195)](_0x2eed19['id'],_0x437330[_0x2aa5cb(0x18e)]);_0x177abd=_0x437330[_0x2aa5cb(0x1a6)]*(0x1-_0x47fb0e/0x64);}else console[_0x2aa5cb(0x16d)]('No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance'),_0x177abd=0x0;}_0x177abd>0x0&&(_0x3aae96-=_0x177abd,_0x104627='-'+_0x177abd[_0x2aa5cb(0x1ab)](0x6)+_0x2aa5cb(0x224),_0x5d42a0[_0x2aa5cb(0x1a6)]=null,_0x5d42a0[_0x2aa5cb(0x20b)]=null,_0x5d42a0['paidAt']=null,console['log'](_0x2aa5cb(0x213)+_0x2eed19[_0x2aa5cb(0x244)]+'\x20-\x20'+_0x177abd[_0x2aa5cb(0x1ab)](0x6)+_0x2aa5cb(0x201)+_0x3aae96[_0x2aa5cb(0x1ab)](0x6)+_0x2aa5cb(0x1df)));}}if(_0x57c01e[_0x2aa5cb(0x1cc)]()===_0x2aa5cb(0x21d)){const _0x5c1d1e=_0x5a8940?.['chargebackAmount']||0x0;_0x5c1d1e>0x0&&(_0x3aae96-=_0x5c1d1e,_0x104627+='\x20and\x20-'+_0x5c1d1e[_0x2aa5cb(0x1ab)](0x6)+_0x2aa5cb(0x252),_0x5d42a0[_0x2aa5cb(0x168)]=_0x5c1d1e,console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x270)+_0x5c1d1e['toFixed'](0x6)+'\x20USDT'),console['log'](_0x2aa5cb(0x1dc)+_0x3aae96['toFixed'](0x6)+_0x2aa5cb(0x1df)));}const _0x3f29dc=await _0x11d0cf[_0x2aa5cb(0x22d)][_0x2aa5cb(0x24d)]({'where':{'id':_0x2ce7ce},'data':_0x5d42a0});_0x3aae96!==_0x2eed19[_0x2aa5cb(0x244)]&&(await _0x11d0cf[_0x2aa5cb(0x1f8)][_0x2aa5cb(0x24d)]({'where':{'id':_0x2eed19['id']},'data':{'balance':_0x3aae96}}),console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x160)+_0x2eed19[_0x2aa5cb(0x1b2)]+'\x20balance\x20updated:\x20'+_0x2eed19[_0x2aa5cb(0x244)][_0x2aa5cb(0x1ab)](0x6)+'\x20->\x20'+_0x3aae96[_0x2aa5cb(0x1ab)](0x6)+'\x20USDT'),console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x268)+_0x104627));await _0x11d0cf[_0x2aa5cb(0x181)][_0x2aa5cb(0x145)]({'data':{'paymentId':_0x2ce7ce,'shopId':_0x2eed19['id'],'event':_0x2aa5cb(0x241)+_0x57c01e[_0x2aa5cb(0x15b)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x2ece61,'newStatus':_0x57c01e['toUpperCase'](),'balanceChange':_0x104627||_0x2aa5cb(0x14d),'oldBalance':_0x2eed19['balance'],'newBalance':_0x3aae96,'amountUSDT':_0x5d42a0[_0x2aa5cb(0x1a6)],'additionalData':_0x5a8940,'timestamp':new Date()['toISOString']()})}}),await this[_0x2aa5cb(0x262)]({..._0x437330,..._0x3f29dc,'shop':_0x2eed19},_0x57c01e[_0x2aa5cb(0x1cc)]()),await this[_0x2aa5cb(0x255)]({..._0x437330,..._0x3f29dc},_0x57c01e[_0x2aa5cb(0x1cc)]());if(_0x2ece61!==_0x2aa5cb(0x21f)&&_0x57c01e[_0x2aa5cb(0x1cc)]()===_0x2aa5cb(0x21f)){console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x1da)+_0x2ce7ce+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x260)+_0x2ece61+_0x2aa5cb(0x256)+_0x57c01e[_0x2aa5cb(0x1cc)]()+_0x2aa5cb(0x175)+_0x437330['paymentLinkId']+'\x22');if(_0x437330[_0x2aa5cb(0x1d6)])try{const _0x32b5ad=await _0x11d0cf['paymentLink']['findUnique']({'where':{'id':_0x437330['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x32b5ad){console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x24f)+_0x32b5ad['id']+_0x2aa5cb(0x240)+_0x32b5ad[_0x2aa5cb(0x263)]+_0x2aa5cb(0x19e)+_0x32b5ad[_0x2aa5cb(0x194)]+_0x2aa5cb(0x146)+_0x32b5ad[_0x2aa5cb(0x26b)]);const _0x4f9f56=_0x32b5ad[_0x2aa5cb(0x194)]+0x1,_0x54ae80=_0x32b5ad['type']===_0x2aa5cb(0x1ee)?'COMPLETED':_0x32b5ad[_0x2aa5cb(0x26b)];await _0x11d0cf[_0x2aa5cb(0x1dd)]['update']({'where':{'id':_0x437330[_0x2aa5cb(0x1d6)]},'data':{'currentPayments':_0x4f9f56,'status':_0x54ae80,'updatedAt':new Date()}}),console[_0x2aa5cb(0x16d)]('‚úÖ\x20Payment\x20link\x20'+_0x32b5ad['id']+_0x2aa5cb(0x1bb)+_0x32b5ad['currentPayments']+'\x20->\x20'+_0x4f9f56+',\x20status='+_0x32b5ad[_0x2aa5cb(0x26b)]+'\x20->\x20'+_0x54ae80);}else console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x1c4)+_0x437330[_0x2aa5cb(0x1d6)]+_0x2aa5cb(0x21c));}catch(_0x17e647){console[_0x2aa5cb(0x18c)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x17e647);}else console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x1da)+_0x2ce7ce+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0x2aa5cb(0x16d)](_0x2aa5cb(0x1da)+_0x2ce7ce+_0x2aa5cb(0x157)+_0x2ece61+_0x2aa5cb(0x140)+_0x57c01e[_0x2aa5cb(0x1cc)]());});}async[a65_0xe7502a(0x1ff)](_0x2fa448){const _0x36d2d4=a65_0xe7502a;console['log']('üîÑ\x20Processing\x20Plisio\x20webhook:',_0x2fa448);try{const _0x34e84f=await this[_0x36d2d4(0x1f2)][_0x36d2d4(0x178)](_0x2fa448);if(!_0x34e84f[_0x36d2d4(0x149)])throw new Error(_0x36d2d4(0x173));const _0x441eca=await database_1['default'][_0x36d2d4(0x22d)][_0x36d2d4(0x183)]({'where':{'gatewayOrderId':_0x34e84f[_0x36d2d4(0x149)]}});if(!_0x441eca){console[_0x36d2d4(0x18c)]('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x34e84f[_0x36d2d4(0x149)]);return;}console['log'](_0x36d2d4(0x242)+_0x441eca['id']+_0x36d2d4(0x1e1)+_0x34e84f[_0x36d2d4(0x26b)]),await this[_0x36d2d4(0x19b)](_0x441eca['id'],_0x34e84f[_0x36d2d4(0x26b)],{'txUrls':_0x34e84f[_0x36d2d4(0x1c9)]}),loggerService_1[_0x36d2d4(0x25a)][_0x36d2d4(0x15f)](_0x36d2d4(0x25d),_0x441eca['id'],_0x441eca['status'],_0x34e84f[_0x36d2d4(0x26b)],_0x2fa448);}catch(_0x5bf894){console[_0x36d2d4(0x18c)]('Error\x20processing\x20Plisio\x20webhook:',_0x5bf894),loggerService_1[_0x36d2d4(0x25a)]['logWebhookError'](_0x36d2d4(0x25d),_0x5bf894,_0x2fa448);throw _0x5bf894;}}async[a65_0xe7502a(0x163)](_0x2e1195){const _0x5457b7=a65_0xe7502a;console[_0x5457b7(0x16d)](_0x5457b7(0x20c),_0x2e1195);try{const _0x4cef9f=await this[_0x5457b7(0x1f2)][_0x5457b7(0x178)](_0x2e1195);if(!_0x4cef9f[_0x5457b7(0x149)])throw new Error(_0x5457b7(0x179));const _0x4e41d4=await database_1[_0x5457b7(0x250)][_0x5457b7(0x22d)][_0x5457b7(0x183)]({'where':{'gatewayOrderId':_0x4cef9f[_0x5457b7(0x149)]}});if(!_0x4e41d4){console[_0x5457b7(0x18c)]('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x4cef9f['paymentId']);return;}console[_0x5457b7(0x16d)](_0x5457b7(0x174)+_0x4e41d4['id']+_0x5457b7(0x1e1)+_0x4cef9f['status']),await this['updatePaymentStatus'](_0x4e41d4['id'],_0x4cef9f[_0x5457b7(0x26b)],{'txUrls':_0x4cef9f[_0x5457b7(0x1c9)]}),loggerService_1[_0x5457b7(0x25a)]['logWebhookProcessed'](_0x5457b7(0x1c0),_0x4e41d4['id'],_0x4e41d4[_0x5457b7(0x26b)],_0x4cef9f['status'],_0x2e1195);}catch(_0x7e121d){console[_0x5457b7(0x18c)](_0x5457b7(0x196),_0x7e121d),loggerService_1['loggerService'][_0x5457b7(0x1d2)](_0x5457b7(0x1c0),_0x7e121d,_0x2e1195);throw _0x7e121d;}}async['processRapydWebhook'](_0x324891){const _0x24616e=a65_0xe7502a;console['log'](_0x24616e(0x1fc),_0x324891);try{const _0x17b888=await this['rapydService']['processWebhook'](_0x324891);if(!_0x17b888[_0x24616e(0x149)])throw new Error(_0x24616e(0x1e8));const _0x719cdb=await database_1[_0x24616e(0x250)][_0x24616e(0x22d)][_0x24616e(0x183)]({'where':{'gatewayOrderId':_0x17b888[_0x24616e(0x149)]}});if(!_0x719cdb){console[_0x24616e(0x18c)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x17b888[_0x24616e(0x149)]);return;}console[_0x24616e(0x16d)]('üìä\x20Rapyd\x20webhook:\x20Payment\x20'+_0x719cdb['id']+_0x24616e(0x1e1)+_0x17b888[_0x24616e(0x26b)]),await this['updatePaymentStatus'](_0x719cdb['id'],_0x17b888[_0x24616e(0x26b)],{'failureMessage':_0x17b888['failureMessage'],'cardLast4':_0x17b888['additionalInfo']?.['cardLast4'],'paymentMethod':_0x17b888[_0x24616e(0x177)]?.[_0x24616e(0x1ad)]}),loggerService_1[_0x24616e(0x25a)][_0x24616e(0x15f)]('rapyd',_0x719cdb['id'],_0x719cdb[_0x24616e(0x26b)],_0x17b888['status'],_0x324891);}catch(_0x154f1a){console[_0x24616e(0x18c)](_0x24616e(0x1ae),_0x154f1a),loggerService_1[_0x24616e(0x25a)][_0x24616e(0x1d2)](_0x24616e(0x14e),_0x154f1a,_0x324891);throw _0x154f1a;}}async[a65_0xe7502a(0x1a7)](_0x55e68b){const _0x1be648=a65_0xe7502a;console['log']('üîÑ\x20Processing\x20Noda\x20webhook:',_0x55e68b);try{const _0x5d8bff=await this[_0x1be648(0x20e)][_0x1be648(0x178)](_0x55e68b);if(!_0x5d8bff[_0x1be648(0x149)])throw new Error(_0x1be648(0x220));const _0x47b5da=await database_1['default']['payment']['findFirst']({'where':{'gatewayOrderId':_0x5d8bff[_0x1be648(0x149)]}});if(!_0x47b5da){console['error'](_0x1be648(0x153)+_0x5d8bff[_0x1be648(0x149)]);return;}console[_0x1be648(0x16d)](_0x1be648(0x222)+_0x47b5da['id']+'\x20status\x20'+_0x5d8bff[_0x1be648(0x26b)]),await this[_0x1be648(0x19b)](_0x47b5da['id'],_0x5d8bff['status'],{'bankId':_0x5d8bff[_0x1be648(0x177)]?.[_0x1be648(0x1d7)],'remitterIban':_0x5d8bff['additionalInfo']?.[_0x1be648(0x1c8)],'remitterName':_0x5d8bff[_0x1be648(0x177)]?.[_0x1be648(0x1db)]}),loggerService_1[_0x1be648(0x25a)][_0x1be648(0x15f)](_0x1be648(0x204),_0x47b5da['id'],_0x47b5da[_0x1be648(0x26b)],_0x5d8bff[_0x1be648(0x26b)],_0x55e68b);}catch(_0x1b3efb){console[_0x1be648(0x18c)]('Error\x20processing\x20Noda\x20webhook:',_0x1b3efb),loggerService_1[_0x1be648(0x25a)][_0x1be648(0x1d2)]('noda',_0x1b3efb,_0x55e68b);throw _0x1b3efb;}}async[a65_0xe7502a(0x246)](_0x38196d){const _0x2970d1=a65_0xe7502a;console[_0x2970d1(0x16d)](_0x2970d1(0x1f4),_0x38196d);try{const _0x5c83f8=await this[_0x2970d1(0x235)][_0x2970d1(0x178)](_0x38196d);if(!_0x5c83f8[_0x2970d1(0x149)])throw new Error(_0x2970d1(0x25b));const _0x29a2a3=await database_1['default'][_0x2970d1(0x22d)]['findFirst']({'where':{'gatewayOrderId':_0x5c83f8[_0x2970d1(0x149)]}});if(!_0x29a2a3){console[_0x2970d1(0x18c)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x5c83f8['paymentId']);return;}console['log'](_0x2970d1(0x13e)+_0x29a2a3['id']+_0x2970d1(0x1e1)+_0x5c83f8[_0x2970d1(0x26b)]),await this[_0x2970d1(0x19b)](_0x29a2a3['id'],_0x5c83f8['status']),loggerService_1[_0x2970d1(0x25a)][_0x2970d1(0x15f)]('cointopay',_0x29a2a3['id'],_0x29a2a3[_0x2970d1(0x26b)],_0x5c83f8[_0x2970d1(0x26b)],_0x38196d);}catch(_0x93285a){console[_0x2970d1(0x18c)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x93285a),loggerService_1[_0x2970d1(0x25a)]['logWebhookError'](_0x2970d1(0x221),_0x93285a,_0x38196d);throw _0x93285a;}}async[a65_0xe7502a(0x266)](_0x50be8b){const _0x222352=a65_0xe7502a;console[_0x222352(0x16d)](_0x222352(0x141),_0x50be8b);try{const _0x1f61bf=await this[_0x222352(0x1e9)][_0x222352(0x178)](_0x50be8b);if(!_0x1f61bf['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook');const _0x2a7561=await database_1['default'][_0x222352(0x22d)][_0x222352(0x183)]({'where':{'gatewayOrderId':_0x1f61bf[_0x222352(0x149)]}});if(!_0x2a7561){console[_0x222352(0x18c)](_0x222352(0x1b0)+_0x1f61bf[_0x222352(0x149)]);return;}console[_0x222352(0x16d)]('üìä\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x2a7561['id']+_0x222352(0x1e1)+_0x1f61bf[_0x222352(0x26b)]),await this[_0x222352(0x19b)](_0x2a7561['id'],_0x1f61bf['status']),loggerService_1[_0x222352(0x25a)][_0x222352(0x15f)]('cointopay2',_0x2a7561['id'],_0x2a7561[_0x222352(0x26b)],_0x1f61bf['status'],_0x50be8b);}catch(_0x21a3f2){console[_0x222352(0x18c)](_0x222352(0x172),_0x21a3f2),loggerService_1['loggerService']['logWebhookError'](_0x222352(0x1fd),_0x21a3f2,_0x50be8b);throw _0x21a3f2;}}async['processKlymeWebhook'](_0x4e1f77){const _0x452b31=a65_0xe7502a;console[_0x452b31(0x16d)](_0x452b31(0x1a1),_0x4e1f77);try{const _0x155569=await this[_0x452b31(0x202)][_0x452b31(0x178)](_0x4e1f77);if(!_0x155569[_0x452b31(0x149)])throw new Error(_0x452b31(0x227));const _0x5bc874=await database_1[_0x452b31(0x250)][_0x452b31(0x22d)][_0x452b31(0x183)]({'where':{'gatewayOrderId':_0x155569[_0x452b31(0x149)]}});if(!_0x5bc874){console[_0x452b31(0x18c)](_0x452b31(0x159)+_0x155569[_0x452b31(0x149)]);return;}console['log']('üìä\x20KLYME\x20webhook:\x20Payment\x20'+_0x5bc874['id']+_0x452b31(0x1e1)+_0x155569[_0x452b31(0x26b)]),await this[_0x452b31(0x19b)](_0x5bc874['id'],_0x155569['status'],{'paymentMethod':_0x155569[_0x452b31(0x177)]?.['payment_method']}),loggerService_1['loggerService'][_0x452b31(0x15f)](_0x452b31(0x223),_0x5bc874['id'],_0x5bc874[_0x452b31(0x26b)],_0x155569[_0x452b31(0x26b)],_0x4e1f77);}catch(_0x25eec0){console[_0x452b31(0x18c)]('Error\x20processing\x20KLYME\x20webhook:',_0x25eec0),loggerService_1[_0x452b31(0x25a)][_0x452b31(0x1d2)](_0x452b31(0x223),_0x25eec0,_0x4e1f77);throw _0x25eec0;}}async['processVisaWebhook'](_0xbb98c5){const _0x3d2139=a65_0xe7502a;console[_0x3d2139(0x16d)](_0x3d2139(0x164),JSON[_0x3d2139(0x156)](_0xbb98c5,null,0x2));try{const _0xf6e424=await this[_0x3d2139(0x17c)]['processWebhook'](_0xbb98c5,'VISA');console[_0x3d2139(0x16d)]('üìä\x20VISA\x20webhook\x20result:',_0xf6e424);if(!_0xf6e424['paymentId']){console['error'](_0x3d2139(0x1a8)),console[_0x3d2139(0x18c)]('‚ùå\x20Available\x20webhook\x20fields:',Object[_0x3d2139(0x1ed)](_0xbb98c5));throw new Error('No\x20payment\x20ID\x20in\x20VISA\x20webhook');}let _0x27a719=null;console[_0x3d2139(0x16d)]('üîç\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0xf6e424[_0x3d2139(0x149)]);if(_0xf6e424['paymentId']){console[_0x3d2139(0x16d)](_0x3d2139(0x1cb)),console[_0x3d2139(0x16d)](_0x3d2139(0x1de)),console[_0x3d2139(0x16d)](_0x3d2139(0x22e)),console[_0x3d2139(0x16d)](_0x3d2139(0x25e)+_0xf6e424['paymentId']),console[_0x3d2139(0x16d)](_0x3d2139(0x22f)),_0x27a719=await database_1[_0x3d2139(0x250)][_0x3d2139(0x22d)][_0x3d2139(0x183)]({'where':{'AND':[{'OR':[{'gateway':_0x3d2139(0x236)},{'gateway':_0x3d2139(0x17f)}]},{'OR':[{'gatewayPaymentId':_0xf6e424[_0x3d2139(0x149)]},{'gatewayOrderId':_0xf6e424['paymentId']},{'id':_0xf6e424[_0x3d2139(0x149)]},{'orderId':_0xf6e424[_0x3d2139(0x149)]}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console['log'](_0x3d2139(0x1ea));if(_0x27a719)console[_0x3d2139(0x16d)]('‚úÖ\x20Found\x20payment:\x20ID='+_0x27a719['id']+',\x20GatewayOrderId='+_0x27a719['gatewayOrderId']+_0x3d2139(0x1d8)+_0x27a719[_0x3d2139(0x190)]);else{console[_0x3d2139(0x16d)](_0x3d2139(0x19d));const _0x61213=await database_1[_0x3d2139(0x250)][_0x3d2139(0x22d)]['findMany']({'where':{'gateway':_0x3d2139(0x236)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x3d2139(0x234)}});console['log'](_0x3d2139(0x20f),_0x61213[_0x3d2139(0x26e)](_0x1bc97b=>_0x1bc97b['id']+'\x20(orderId:\x20'+_0x1bc97b[_0x3d2139(0x143)]+_0x3d2139(0x21a)+_0x1bc97b['gatewayOrderId']+',\x20gatewayPaymentId:\x20'+_0x1bc97b[_0x3d2139(0x190)]+_0x3d2139(0x265)+_0x1bc97b[_0x3d2139(0x1b8)]+')'));}console[_0x3d2139(0x16d)]('üîç\x20VISA\x20payment\x20search\x20result:\x20'+(_0x27a719?_0x3d2139(0x15e):_0x3d2139(0x210))),_0x27a719&&console[_0x3d2139(0x16d)]('üîç\x20Found\x20VISA\x20payment:\x20ID='+_0x27a719['id']+_0x3d2139(0x205)+_0x27a719[_0x3d2139(0x18e)]+_0x3d2139(0x1fa)+_0x27a719[_0x3d2139(0x26b)]+',\x20Card=****'+_0x27a719[_0x3d2139(0x1b8)]);}if(!_0x27a719){console['error'](_0x3d2139(0x243)+_0xf6e424[_0x3d2139(0x149)]),loggerService_1['loggerService'][_0x3d2139(0x1d2)](_0x3d2139(0x162),new Error(_0x3d2139(0x19f)+_0xf6e424[_0x3d2139(0x149)]),_0xbb98c5);throw new Error(_0x3d2139(0x228)+_0xf6e424[_0x3d2139(0x149)]);}console['log'](_0x3d2139(0x1f0)+_0x27a719['id']+_0x3d2139(0x245)+_0x27a719[_0x3d2139(0x26b)]+_0x3d2139(0x230)+_0xf6e424[_0x3d2139(0x26b)]+')');const _0x17c689={};_0xf6e424[_0x3d2139(0x17b)]&&await database_1[_0x3d2139(0x250)][_0x3d2139(0x22d)][_0x3d2139(0x24d)]({'where':{'id':_0x27a719['id']},'data':{'amount':_0xf6e424['amount'],'updatedAt':new Date()}}),_0xf6e424[_0x3d2139(0x198)]&&await database_1[_0x3d2139(0x250)][_0x3d2139(0x22d)]['update']({'where':{'id':_0x27a719['id']},'data':{'currency':_0xf6e424[_0x3d2139(0x198)],'updatedAt':new Date()}}),_0xf6e424[_0x3d2139(0x26b)]===_0x3d2139(0x147)&&_0xf6e424['errorMessage']&&(_0x17c689[_0x3d2139(0x176)]=_0xf6e424[_0x3d2139(0x267)],console[_0x3d2139(0x16d)](_0x3d2139(0x13f)+_0xf6e424[_0x3d2139(0x267)])),_0x17c689[_0x3d2139(0x1ad)]='visa',await this[_0x3d2139(0x19b)](_0x27a719['id'],_0xf6e424[_0x3d2139(0x26b)],_0x17c689),await database_1[_0x3d2139(0x250)][_0x3d2139(0x181)][_0x3d2139(0x145)]({'data':{'paymentId':_0x27a719['id'],'shopId':_0x27a719[_0x3d2139(0x1e0)],'event':_0x3d2139(0x1d9)+_0xf6e424[_0x3d2139(0x26b)][_0x3d2139(0x15b)](),'statusCode':0xc8,'responseBody':JSON[_0x3d2139(0x156)](_0xf6e424)}}),await this[_0x3d2139(0x255)](_0x27a719,_0xf6e424[_0x3d2139(0x26b)][_0x3d2139(0x1cc)]()),console[_0x3d2139(0x16d)](_0x3d2139(0x1e6)+_0x27a719['id']);}catch(_0x1d032e){console[_0x3d2139(0x18c)](_0x3d2139(0x1f5),_0x1d032e),loggerService_1[_0x3d2139(0x25a)][_0x3d2139(0x1d2)](_0x3d2139(0x162),_0x1d032e,_0xbb98c5);throw _0x1d032e;}}async[a65_0xe7502a(0x155)](_0x12f3c0){const _0x1915b9=a65_0xe7502a;console['log'](_0x1915b9(0x14f),JSON['stringify'](_0x12f3c0,null,0x2));try{const _0x18a66f=await this['visaMasterCardService'][_0x1915b9(0x178)](_0x12f3c0,'MASTERCARD');console[_0x1915b9(0x16d)]('üìä\x20MasterCard\x20webhook\x20result:',_0x18a66f);if(!_0x18a66f[_0x1915b9(0x149)]){console[_0x1915b9(0x18c)](_0x1915b9(0x253)),console['error'](_0x1915b9(0x1c7),Object[_0x1915b9(0x1ed)](_0x12f3c0));throw new Error(_0x1915b9(0x22c));}let _0x351621=null;console[_0x1915b9(0x16d)](_0x1915b9(0x238)+_0x18a66f[_0x1915b9(0x149)]);_0x18a66f[_0x1915b9(0x149)]&&(console[_0x1915b9(0x16d)](_0x1915b9(0x165)),_0x351621=await database_1[_0x1915b9(0x250)]['payment']['findFirst']({'where':{'AND':[{'OR':[{'gateway':'visa_mastercard'},{'gateway':_0x1915b9(0x17f)},{'gateway':_0x1915b9(0x236)}]},{'OR':[{'gatewayPaymentId':_0x18a66f['paymentId']},{'gatewayOrderId':_0x18a66f[_0x1915b9(0x149)]},{'id':_0x18a66f[_0x1915b9(0x149)]},{'orderId':_0x18a66f[_0x1915b9(0x149)]}]}]}}),console[_0x1915b9(0x16d)](_0x1915b9(0x1ac)+(_0x351621?_0x1915b9(0x169)+_0x351621['id']:'Payment\x20not\x20found')));if(!_0x351621){console[_0x1915b9(0x18c)](_0x1915b9(0x1af)+_0x18a66f[_0x1915b9(0x149)]),console['error'](_0x1915b9(0x269)+_0x18a66f['paymentId']+'\x22,\x20id=\x22'+_0x18a66f[_0x1915b9(0x149)]+_0x1915b9(0x142)+_0x18a66f['paymentId']+'\x22');const _0x3a27d6=await database_1[_0x1915b9(0x250)][_0x1915b9(0x22d)][_0x1915b9(0x21b)]({'where':{'OR':[{'gateway':_0x1915b9(0x17f)},{'gateway':_0x1915b9(0x1ca)},{'gateway':_0x1915b9(0x236)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':'desc'},'take':0xf});console[_0x1915b9(0x16d)](_0x1915b9(0x1e2),_0x3a27d6),loggerService_1[_0x1915b9(0x25a)]['logWebhookError']('mastercard',new Error(_0x1915b9(0x19f)+_0x18a66f[_0x1915b9(0x149)]),_0x12f3c0);throw new Error(_0x1915b9(0x1c1)+_0x18a66f[_0x1915b9(0x149)]);}console[_0x1915b9(0x16d)]('‚úÖ\x20Found\x20payment\x20'+_0x351621['id']+_0x1915b9(0x26a)+_0x351621[_0x1915b9(0x26b)]+_0x1915b9(0x215)+_0x18a66f['status']);const _0x135176={};_0x18a66f[_0x1915b9(0x17b)]&&await database_1[_0x1915b9(0x250)][_0x1915b9(0x22d)]['update']({'where':{'id':_0x351621['id']},'data':{'amount':_0x18a66f['amount'],'updatedAt':new Date()}}),_0x18a66f[_0x1915b9(0x198)]&&await database_1[_0x1915b9(0x250)][_0x1915b9(0x22d)][_0x1915b9(0x24d)]({'where':{'id':_0x351621['id']},'data':{'currency':_0x18a66f[_0x1915b9(0x198)],'updatedAt':new Date()}}),_0x18a66f['status']===_0x1915b9(0x147)&&_0x18a66f[_0x1915b9(0x267)]&&(_0x135176[_0x1915b9(0x176)]=_0x18a66f['errorMessage'],console[_0x1915b9(0x16d)](_0x1915b9(0x1ba)+_0x18a66f[_0x1915b9(0x267)])),_0x135176[_0x1915b9(0x1ad)]=_0x1915b9(0x17f),await this['updatePaymentStatus'](_0x351621['id'],_0x18a66f['status'],_0x135176),loggerService_1[_0x1915b9(0x25a)][_0x1915b9(0x15f)](_0x1915b9(0x17f),_0x351621['id'],_0x351621[_0x1915b9(0x26b)],_0x18a66f[_0x1915b9(0x26b)],_0x12f3c0);}catch(_0x149cb9){console[_0x1915b9(0x18c)]('‚ùå\x20Error\x20processing\x20MasterCard\x20webhook:',_0x149cb9),loggerService_1[_0x1915b9(0x25a)][_0x1915b9(0x1d2)](_0x1915b9(0x17f),_0x149cb9,_0x12f3c0);throw _0x149cb9;}}async['processAmerWebhook'](_0x44a410){const _0x4ce540=a65_0xe7502a;console[_0x4ce540(0x16d)](_0x4ce540(0x1d4),JSON['stringify'](_0x44a410,null,0x2));try{const _0x10d2ba=await this[_0x4ce540(0x1bc)]['processWebhook'](_0x44a410);console[_0x4ce540(0x16d)](_0x4ce540(0x24e),_0x10d2ba);if(!_0x10d2ba[_0x4ce540(0x149)]){console[_0x4ce540(0x18c)](_0x4ce540(0x186)),console[_0x4ce540(0x18c)]('‚ùå\x20Available\x20webhook\x20fields:',Object[_0x4ce540(0x1ed)](_0x44a410));throw new Error(_0x4ce540(0x231));}let _0x3e3ad7=null;console[_0x4ce540(0x16d)](_0x4ce540(0x189)+_0x10d2ba[_0x4ce540(0x149)]),_0x3e3ad7=await database_1['default'][_0x4ce540(0x22d)][_0x4ce540(0x183)]({'where':{'AND':[{'gateway':_0x4ce540(0x271)},{'OR':[{'gatewayPaymentId':_0x10d2ba[_0x4ce540(0x149)]},{'gatewayOrderId':_0x10d2ba[_0x4ce540(0x149)]},{'id':_0x10d2ba[_0x4ce540(0x149)]},{'orderId':_0x10d2ba[_0x4ce540(0x149)]}]}]}}),console['log'](_0x4ce540(0x1ac)+(_0x3e3ad7?_0x4ce540(0x169)+_0x3e3ad7['id']:_0x4ce540(0x208)));if(!_0x3e3ad7){console[_0x4ce540(0x18c)](_0x4ce540(0x272)+_0x10d2ba[_0x4ce540(0x149)]);return;}console['log'](_0x4ce540(0x26c)+_0x3e3ad7['id']+'\x20status\x20'+_0x10d2ba[_0x4ce540(0x26b)]),await this['updatePaymentStatus'](_0x3e3ad7['id'],_0x10d2ba[_0x4ce540(0x26b)],{'cardLast4':_0x10d2ba[_0x4ce540(0x177)]?.[_0x4ce540(0x1b8)],'paymentMethod':_0x10d2ba[_0x4ce540(0x177)]?.[_0x4ce540(0x1ad)]});}catch(_0x2600be){console[_0x4ce540(0x18c)](_0x4ce540(0x23f),_0x2600be),loggerService_1[_0x4ce540(0x25a)][_0x4ce540(0x1d2)](_0x4ce540(0x271),_0x2600be,_0x44a410);throw _0x2600be;}}async['processAmPayWebhook'](_0x44c6cb){const _0x5c3fad=a65_0xe7502a;console['log'](_0x5c3fad(0x23d),JSON[_0x5c3fad(0x156)](_0x44c6cb,null,0x2));try{const _0x21baed=_0x44c6cb[_0x5c3fad(0x26b)],_0x473b06=_0x44c6cb[_0x5c3fad(0x1a0)],_0x312cc0=_0x44c6cb['system_id'],_0x7c253=_0x44c6cb['payment_method'],_0x5f0626=_0x44c6cb[_0x5c3fad(0x17b)],_0x46e6d5=_0x44c6cb[_0x5c3fad(0x198)],_0x58b745=_0x44c6cb[_0x5c3fad(0x200)],_0x24b08b=_0x44c6cb[_0x5c3fad(0x1e3)];if(!_0x473b06){console[_0x5c3fad(0x18c)](_0x5c3fad(0x1c5));throw new Error('Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook');}console[_0x5c3fad(0x16d)](_0x5c3fad(0x23b),{'status':_0x21baed,'clientTransactionId':_0x473b06,'systemId':_0x312cc0,'paymentMethod':_0x7c253,'amount':_0x5f0626,'currency':_0x46e6d5,'commission':_0x58b745,'statusAdditionInfo':_0x24b08b});const _0x15831e=await database_1[_0x5c3fad(0x250)][_0x5c3fad(0x22d)][_0x5c3fad(0x183)]({'where':{'OR':[{'gatewayOrderId':_0x473b06},{'orderId':_0x473b06},{'id':_0x473b06},{'gatewayPaymentId':_0x473b06}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x15831e){console[_0x5c3fad(0x18c)](_0x5c3fad(0x187)+_0x473b06);throw new Error('Payment\x20not\x20found:\x20'+_0x473b06);}console['log'](_0x5c3fad(0x16f)+_0x15831e['id']+'\x20for\x20AmPay\x20webhook'),console[_0x5c3fad(0x16d)](_0x5c3fad(0x247)+_0x15831e[_0x5c3fad(0x26b)]+_0x5c3fad(0x230)+_0x21baed),_0x21baed===_0x5c3fad(0x184)?(console[_0x5c3fad(0x16d)]('üîÑ\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED'),await this[_0x5c3fad(0x19b)](_0x15831e['id'],_0x5c3fad(0x147)),console['log']('‚úÖ\x20AmPay\x20webhook\x20processed:\x20Payment\x20'+_0x15831e['id']+'\x20status\x20updated\x20to\x20FAILED'),console[_0x5c3fad(0x16d)](_0x5c3fad(0x16a)+(_0x24b08b||_0x5c3fad(0x1fe)))):console[_0x5c3fad(0x16d)](_0x5c3fad(0x182)+_0x21baed+_0x5c3fad(0x1b3)),await database_1['default'][_0x5c3fad(0x181)]['create']({'data':{'paymentId':_0x15831e['id'],'shopId':_0x15831e[_0x5c3fad(0x1e0)],'event':_0x5c3fad(0x14b)+(_0x21baed?.[_0x5c3fad(0x15b)]()||'unknown'),'statusCode':0xc8,'responseBody':JSON[_0x5c3fad(0x156)](_0x44c6cb)}}),loggerService_1['loggerService'][_0x5c3fad(0x15f)](_0x5c3fad(0x1a4),_0x15831e['id'],_0x15831e[_0x5c3fad(0x26b)],_0x21baed===_0x5c3fad(0x184)?'FAILED':_0x21baed,_0x44c6cb);}catch(_0x1f43ec){console[_0x5c3fad(0x18c)](_0x5c3fad(0x1e4),_0x1f43ec),loggerService_1['loggerService']['logWebhookError'](_0x5c3fad(0x1a4),_0x1f43ec,_0x44c6cb);throw _0x1f43ec;}}async['processAmPayTRYWebhook'](_0x3c05e3){const _0x2e2904=a65_0xe7502a;console['log'](_0x2e2904(0x264),JSON['stringify'](_0x3c05e3,null,0x2));try{const _0x407d31=_0x3c05e3[_0x2e2904(0x26b)],_0x46cb23=_0x3c05e3['client_transaction_id'],_0x356013=_0x3c05e3[_0x2e2904(0x18b)],_0x211762=_0x3c05e3[_0x2e2904(0x207)],_0x476d6e=_0x3c05e3[_0x2e2904(0x17b)],_0x3d66b1=_0x3c05e3['currency'],_0x3e57ee=_0x3c05e3['commission'],_0x86155a=_0x3c05e3[_0x2e2904(0x1e3)];if(!_0x46cb23){console[_0x2e2904(0x18c)](_0x2e2904(0x239));throw new Error(_0x2e2904(0x232));}console[_0x2e2904(0x16d)](_0x2e2904(0x16c),{'status':_0x407d31,'clientTransactionId':_0x46cb23,'systemId':_0x356013,'paymentMethod':_0x211762,'amount':_0x476d6e,'currency':_0x3d66b1,'commission':_0x3e57ee,'statusAdditionInfo':_0x86155a});const _0x23c569=await database_1['default'][_0x2e2904(0x22d)][_0x2e2904(0x183)]({'where':{'OR':[{'gatewayOrderId':_0x46cb23},{'orderId':_0x46cb23},{'id':_0x46cb23},{'gatewayPaymentId':_0x46cb23}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x23c569){console['error'](_0x2e2904(0x1f7)+_0x46cb23);throw new Error('Payment\x20not\x20found:\x20'+_0x46cb23);}console[_0x2e2904(0x16d)](_0x2e2904(0x16f)+_0x23c569['id']+'\x20for\x20AmPay\x20TRY\x20webhook'),console['log']('üìä\x20Payment\x20status:\x20'+_0x23c569[_0x2e2904(0x26b)]+_0x2e2904(0x230)+_0x407d31),_0x407d31===_0x2e2904(0x184)?(console[_0x2e2904(0x16d)](_0x2e2904(0x1b7)),await this[_0x2e2904(0x19b)](_0x23c569['id'],_0x2e2904(0x147)),console[_0x2e2904(0x16d)](_0x2e2904(0x17e)+_0x23c569['id']+_0x2e2904(0x16b)),console[_0x2e2904(0x16d)](_0x2e2904(0x16a)+(_0x86155a||'No\x20additional\x20info'))):console[_0x2e2904(0x16d)]('‚ÑπÔ∏è\x20AmPay\x20TRY\x20status\x20'+_0x407d31+_0x2e2904(0x1b3)),await database_1[_0x2e2904(0x250)][_0x2e2904(0x181)][_0x2e2904(0x145)]({'data':{'paymentId':_0x23c569['id'],'shopId':_0x23c569[_0x2e2904(0x1e0)],'event':_0x2e2904(0x191)+(_0x407d31?.[_0x2e2904(0x15b)]()||_0x2e2904(0x180)),'statusCode':0xc8,'responseBody':JSON[_0x2e2904(0x156)](_0x3c05e3)}}),loggerService_1['loggerService'][_0x2e2904(0x15f)](_0x2e2904(0x192),_0x23c569['id'],_0x23c569[_0x2e2904(0x26b)],_0x407d31===_0x2e2904(0x184)?_0x2e2904(0x147):_0x407d31,_0x3c05e3);}catch(_0x36df5a){console[_0x2e2904(0x18c)]('‚ùå\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:',_0x36df5a),loggerService_1[_0x2e2904(0x25a)]['logWebhookError'](_0x2e2904(0x192),_0x36df5a,_0x3c05e3);throw _0x36df5a;}}async[a65_0xe7502a(0x262)](_0x450742,_0x3c3388){const _0x14249f=a65_0xe7502a,_0x38cbca=Date['now']();try{const _0x5d76be=_0x450742['shop'],_0x2d05aa=_0x5d76be['settings'];if(!_0x2d05aa?.[_0x14249f(0x1f6)]){console[_0x14249f(0x16d)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x5d76be['id']);return;}const _0x50166e=_0x3c3388==='PAID'?_0x14249f(0x1bd):_0x3c3388==='FAILED'?_0x14249f(0x19c):_0x3c3388==='EXPIRED'?_0x14249f(0x19c):_0x3c3388==='CHARGEBACK'?_0x14249f(0x19c):_0x3c3388===_0x14249f(0x14c)?_0x14249f(0x19c):'payment.pending';let _0x128fff=[];if(_0x2d05aa[_0x14249f(0x237)])try{_0x128fff=Array['isArray'](_0x2d05aa[_0x14249f(0x237)])?_0x2d05aa[_0x14249f(0x237)]:JSON[_0x14249f(0x211)](_0x2d05aa[_0x14249f(0x237)]);}catch(_0xc5ab6c){console['error']('Error\x20parsing\x20webhook\x20events:',_0xc5ab6c),_0x128fff=[];}if(!_0x128fff['includes'](_0x50166e)){console[_0x14249f(0x16d)](_0x14249f(0x15d)+_0x50166e+_0x14249f(0x144)+_0x5d76be['id']);return;}const _0xbdd019={'event':_0x50166e,'payment':{'id':_0x450742['id'],'order_id':_0x450742['orderId'],'gateway_order_id':_0x450742[_0x14249f(0x171)],'gateway':_0x450742[_0x14249f(0x18e)],'amount':_0x450742['amount'],'currency':_0x450742['currency'],'status':_0x3c3388[_0x14249f(0x15b)](),'customer_email':_0x450742['customerEmail'],'customer_name':_0x450742[_0x14249f(0x1fb)],'failure_message':_0x450742[_0x14249f(0x176)],'tx_urls':_0x450742[_0x14249f(0x1c9)]?JSON['parse'](_0x450742['txUrls']):null,'created_at':_0x450742[_0x14249f(0x1be)],'updated_at':_0x450742[_0x14249f(0x257)]}},_0x2fe243=await fetch(_0x2d05aa[_0x14249f(0x1f6)],{'method':'POST','headers':{'Content-Type':_0x14249f(0x18d),'User-Agent':_0x14249f(0x1f3)},'body':JSON[_0x14249f(0x156)](_0xbdd019)}),_0x28b2ee=Date['now']()-_0x38cbca,_0x4db038=_0x2fe243['ok']?_0x14249f(0x216):await _0x2fe243[_0x14249f(0x1cd)]();loggerService_1['loggerService'][_0x14249f(0x1f1)](_0x450742[_0x14249f(0x1e0)],_0x2d05aa[_0x14249f(0x1f6)],_0x50166e,_0x2fe243[_0x14249f(0x26b)],_0x28b2ee,_0xbdd019),console[_0x14249f(0x16d)](_0x14249f(0x25f)+_0x2d05aa['webhookUrl']+_0x14249f(0x226)+_0x2fe243[_0x14249f(0x26b)]+'\x20('+_0x28b2ee+_0x14249f(0x154));}catch(_0x2ece24){console[_0x14249f(0x18c)](_0x14249f(0x1e5),_0x2ece24),loggerService_1[_0x14249f(0x25a)]['logShopWebhookError'](_0x450742[_0x14249f(0x1e0)],_0x450742[_0x14249f(0x1f8)]?.[_0x14249f(0x23a)]?.[_0x14249f(0x1f6)]||'unknown',_0x14249f(0x249),_0x2ece24,{});}}async[a65_0xe7502a(0x255)](_0x33c9b4,_0x3662cd){const _0x23e684=a65_0xe7502a;try{const _0x1392f3={'PENDING':'created','PROCESSING':_0x23e684(0x24a),'PAID':_0x23e684(0x1c6),'FAILED':_0x23e684(0x1b5),'EXPIRED':_0x23e684(0x17d),'REFUND':_0x23e684(0x185),'CHARGEBACK':_0x23e684(0x1d1)},_0x55857a=_0x1392f3[_0x3662cd];if(!_0x55857a||_0x55857a===_0x23e684(0x19a))return;await telegramBotService_1[_0x23e684(0x24c)][_0x23e684(0x261)](_0x33c9b4[_0x23e684(0x1e0)],_0x33c9b4,_0x55857a);}catch(_0x445467){console[_0x23e684(0x18c)](_0x23e684(0x1c2),_0x445467);}}async[a65_0xe7502a(0x195)](_0x135d26,_0x437082){const _0x2c5ce9=a65_0xe7502a;try{const _0x285a89=await database_1[_0x2c5ce9(0x250)]['shop'][_0x2c5ce9(0x15c)]({'where':{'id':_0x135d26},'select':{'gatewaySettings':!![]}});if(!_0x285a89?.[_0x2c5ce9(0x1b9)])return console[_0x2c5ce9(0x16d)]('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x135d26+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x1929f0=JSON['parse'](_0x285a89[_0x2c5ce9(0x1b9)]);for(const [_0x512c56,_0x534f5e]of Object[_0x2c5ce9(0x21e)](_0x1929f0)){if(_0x512c56[_0x2c5ce9(0x15b)]()===_0x437082['toLowerCase']()){const _0x25bf89=_0x534f5e[_0x2c5ce9(0x200)]||0xa;return console[_0x2c5ce9(0x16d)](_0x2c5ce9(0x152)+_0x437082+_0x2c5ce9(0x197)+_0x135d26+':\x20'+_0x25bf89+'%'),_0x25bf89;}}return console[_0x2c5ce9(0x16d)](_0x2c5ce9(0x248)+_0x437082+_0x2c5ce9(0x1ce)+_0x135d26+_0x2c5ce9(0x151)),0xa;}catch(_0x535c40){return console['error']('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x135d26+',\x20gateway\x20'+_0x437082+':',_0x535c40),0xa;}}async[a65_0xe7502a(0x1aa)](_0x4077a5,_0x2f1eb8){const _0x3d2f7a=a65_0xe7502a;console[_0x3d2f7a(0x16d)](_0x3d2f7a(0x1bf)),console[_0x3d2f7a(0x16d)](_0x3d2f7a(0x148),JSON[_0x3d2f7a(0x156)](_0x4077a5,null,0x2)),console[_0x3d2f7a(0x16d)](_0x3d2f7a(0x23e),JSON[_0x3d2f7a(0x156)](_0x2f1eb8,null,0x2));try{const _0x7ba540=_0x4077a5['customerOrderId']||_0x2f1eb8['customerOrderId'],_0x2bbe78=_0x4077a5[_0x3d2f7a(0x26b)]||_0x2f1eb8[_0x3d2f7a(0x26b)],_0x5b16ce=_0x4077a5[_0x3d2f7a(0x17b)]||_0x2f1eb8[_0x3d2f7a(0x17b)],_0x396834=_0x4077a5[_0x3d2f7a(0x198)]||_0x2f1eb8[_0x3d2f7a(0x198)],_0x552372=_0x4077a5[_0x3d2f7a(0x26d)]||_0x2f1eb8[_0x3d2f7a(0x26d)];if(!_0x7ba540){console['error'](_0x3d2f7a(0x167));throw new Error('Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook');}console['log']('üìä\x20MyXSpend\x20webhook\x20data:',{'customerOrderId':_0x7ba540,'status':_0x2bbe78,'amount':_0x5b16ce,'currency':_0x396834,'dateTime':_0x552372});const _0x312f47=await database_1[_0x3d2f7a(0x250)]['payment']['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x7ba540},{'orderId':_0x7ba540},{'id':_0x7ba540},{'gatewayPaymentId':_0x7ba540}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x312f47){console[_0x3d2f7a(0x18c)](_0x3d2f7a(0x254)+_0x7ba540);throw new Error(_0x3d2f7a(0x19f)+_0x7ba540);}console['log'](_0x3d2f7a(0x16f)+_0x312f47['id']+_0x3d2f7a(0x18a)),console['log'](_0x3d2f7a(0x247)+_0x312f47[_0x3d2f7a(0x26b)]+_0x3d2f7a(0x230)+_0x2bbe78);let _0x5154b2=_0x2bbe78?.['toUpperCase']();_0x2bbe78===_0x3d2f7a(0x147)||_0x2bbe78===_0x3d2f7a(0x1a2)?(_0x5154b2=_0x3d2f7a(0x147),console[_0x3d2f7a(0x16d)](_0x3d2f7a(0x1a9)+_0x2bbe78+_0x3d2f7a(0x203)),await this[_0x3d2f7a(0x19b)](_0x312f47['id'],_0x5154b2),console[_0x3d2f7a(0x16d)](_0x3d2f7a(0x16e)+_0x312f47['id']+'\x20status\x20updated\x20to\x20FAILED')):console['log'](_0x3d2f7a(0x1eb)+_0x2bbe78+_0x3d2f7a(0x217)),await database_1[_0x3d2f7a(0x250)][_0x3d2f7a(0x181)][_0x3d2f7a(0x145)]({'data':{'paymentId':_0x312f47['id'],'shopId':_0x312f47[_0x3d2f7a(0x1e0)],'event':_0x3d2f7a(0x20a)+(_0x2bbe78?.['toLowerCase']()||'unknown'),'statusCode':0xc8,'responseBody':JSON['stringify']({'queryParams':_0x4077a5,'bodyData':_0x2f1eb8})}}),loggerService_1[_0x3d2f7a(0x25a)][_0x3d2f7a(0x15f)](_0x3d2f7a(0x170),_0x312f47['id'],_0x312f47['status'],_0x5154b2||_0x2bbe78,{'queryParams':_0x4077a5,'bodyData':_0x2f1eb8});}catch(_0x2ab239){console[_0x3d2f7a(0x18c)](_0x3d2f7a(0x161),_0x2ab239),loggerService_1[_0x3d2f7a(0x25a)]['logWebhookError'](_0x3d2f7a(0x170),_0x2ab239,{'queryParams':_0x4077a5,'bodyData':_0x2f1eb8});throw _0x2ab239;}}}exports[a65_0xe7502a(0x1b1)]=WebhookService;