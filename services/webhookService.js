'use strict';const a56_0x1e9e3f=a56_0x5862;function a56_0x3a02(){const _0x1c7132=['\x20USDT\x20(payment\x20no\x20longer\x20PAID)','📊\x20KLYME\x20webhook:\x20Payment\x20','$transaction','REFUND','29935650yPqcJO','RapydService','create','additionalInfo','No\x20payment\x20ID\x20in\x20Noda\x20webhook','MasterCardService','webhookUrl','\x20status\x20','sendShopWebhook','application/json','processRapydWebhook','rapydService','NodaService','Payment\x20not\x20found\x20for\x20MasterCard\x20webhook:\x20','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','CoinToPayService','🔄\x20Processing\x20Rapyd\x20webhook:','cointopay','TesSoft\x20Payment\x20System/1.0','createdAt','\x20current\x20balance:\x20','updatePaymentStatus','paymentMethod','plisio','Error\x20processing\x20Rapyd\x20webhook:','KlymeService','defineProperty','default','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','webhook_send','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','📝\x20Reason:\x20','🔄\x20Processing\x20Noda\x20webhook:','coinToPayService','📊\x20MasterCard\x20webhook:\x20Payment\x20','nodaService','2338vZmzkM','Error\x20processing\x20CoinToPay\x20webhook:','currency','plisio_gateway','settings','1973493ZJLDxN','\x20->\x20','processPlisioGatewayWebhook','\x20status\x20to\x20','failed','stringify','Error\x20processing\x20Plisio\x20webhook:','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','refund','system','processing','processWebhook','klyme','Error\x20processing\x20KLYME\x20webhook:','processMasterCardWebhook','log','payment','sendPaymentNotification','toISOString','paymentId','mastercard','amount','chargebackAmount','webhookLog','sendPaymentStatusNotification','toUpperCase','remitterName','🔄\x20Processing\x20KLYME\x20webhook:','text','🏪\x20Shop\x20','klymeService','🔄\x20Updating\x20payment\x20','loggerService','💸\x20Additional\x20chargeback\x20penalty:\x20-','username','__esModule','isArray','Webhook\x20event\x20','Failed\x20to\x20send\x20shop\x20webhook:','masterCardService','💰\x20Converting\x20','status','\x20USDT\x20(payment\x20became\x20PAID)','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','webhookEvents','bankId','updatedAt','includes','1468PFrDzO','📊\x20Rapyd\x20webhook:\x20Payment\x20','logWebhookError','parse','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','processNodaWebhook','toFixed','findUnique','POST','✅\x20Shop\x20','Error\x20processing\x20MasterCard\x20webhook:','failureMessage','no\x20balance\x20change','./telegramBotService','3362718TnZpMu','error','Error\x20processing\x20Noda\x20webhook:','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','payment.failed','plisioService','838ArrJbp','Error\x20parsing\x20webhook\x20events:','remitterIban','logShopWebhookError','./gateways/rapydService','📊\x20Noda\x20webhook:\x20Payment\x20','cardLast4','shopId','2859oXYmNT','now','CHARGEBACK','webhook_status_change_','💰\x20Payment\x20','7445VuJxWJ','balance','./loggerService','processKlymeWebhook','🔄\x20Processing\x20CoinToPay\x20webhook:','rapyd','unknown','created','472VYACdf','gateway','\x20-\x20','708750DzQEYE','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','\x20USDT','💰\x20Final\x20balance\x20after\x20chargeback:\x20','\x20with\x20status\x20','PAID','\x20+\x20','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','WebhookService','txUrls','customerName','shop','./gateways/klymeService','logWebhookProcessed','toLowerCase','update','paidAt','__importDefault','💰\x20Removing\x20from\x20balance:\x20','\x20USDT\x20(chargeback\x20penalty)','logShopWebhookSent','PlisioService','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','noda','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','payment_method','💰\x20Adding\x20to\x20balance:\x20','amountUSDT','../config/database','./gateways/plisioService','./gateways/mastercardService','./gateways/nodaService','findFirst'];a56_0x3a02=function(){return _0x1c7132;};return a56_0x3a02();}(function(_0x1e03cf,_0x5924ba){const _0x5b6687=a56_0x5862,_0x3c5d95=_0x1e03cf();while(!![]){try{const _0x439b6b=-parseInt(_0x5b6687(0x1b2))/0x1+parseInt(_0x5b6687(0x19a))/0x2*(-parseInt(_0x5b6687(0x1a2))/0x3)+parseInt(_0x5b6687(0x186))/0x4*(-parseInt(_0x5b6687(0x1a7))/0x5)+-parseInt(_0x5b6687(0x194))/0x6+parseInt(_0x5b6687(0x1fc))/0x7*(-parseInt(_0x5b6687(0x1af))/0x8)+-parseInt(_0x5b6687(0x201))/0x9+parseInt(_0x5b6687(0x1d8))/0xa;if(_0x439b6b===_0x5924ba)break;else _0x3c5d95['push'](_0x3c5d95['shift']());}catch(_0x2745b8){_0x3c5d95['push'](_0x3c5d95['shift']());}}}(a56_0x3a02,0x83bd9));function a56_0x5862(_0x2710f3,_0x255970){const _0x3a02e5=a56_0x3a02();return a56_0x5862=function(_0x58628e,_0x2f9c48){_0x58628e=_0x58628e-0x165;let _0x967c08=_0x3a02e5[_0x58628e];return _0x967c08;},a56_0x5862(_0x2710f3,_0x255970);}var __importDefault=this&&this[a56_0x1e9e3f(0x1c3)]||function(_0x2891b3){return _0x2891b3&&_0x2891b3['__esModule']?_0x2891b3:{'default':_0x2891b3};};Object[a56_0x1e9e3f(0x1f2)](exports,a56_0x1e9e3f(0x179),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a56_0x1e9e3f(0x1cf))),plisioService_1=require(a56_0x1e9e3f(0x1d0)),rapydService_1=require(a56_0x1e9e3f(0x19e)),nodaService_1=require(a56_0x1e9e3f(0x1d2)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require(a56_0x1e9e3f(0x1be)),mastercardService_1=require(a56_0x1e9e3f(0x1d1)),telegramBotService_1=require(a56_0x1e9e3f(0x193)),currencyService_1=require('./currencyService'),loggerService_1=require(a56_0x1e9e3f(0x1a9));class WebhookService{constructor(){const _0x517f98=a56_0x1e9e3f;this[_0x517f98(0x199)]=new plisioService_1[(_0x517f98(0x1c7))](),this[_0x517f98(0x1e3)]=new rapydService_1[(_0x517f98(0x1d9))](),this[_0x517f98(0x1fb)]=new nodaService_1[(_0x517f98(0x1e4))](),this[_0x517f98(0x1f9)]=new coinToPayService_1[(_0x517f98(0x1e7))](),this[_0x517f98(0x174)]=new klymeService_1[(_0x517f98(0x1f1))](),this['masterCardService']=new mastercardService_1[(_0x517f98(0x1dd))]();}async[a56_0x1e9e3f(0x1ed)](_0x4da9e7,_0x1c054c,_0x2eca14){const _0x14fd5b=a56_0x1e9e3f;console['log'](_0x14fd5b(0x175)+_0x4da9e7+_0x14fd5b(0x204)+_0x1c054c),await database_1[_0x14fd5b(0x1f3)][_0x14fd5b(0x1d6)](async _0x366b2e=>{const _0x5a9968=_0x14fd5b,_0x3a0c0d=await _0x366b2e[_0x5a9968(0x166)][_0x5a9968(0x18d)]({'where':{'id':_0x4da9e7},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3a0c0d)throw new Error('Payment\x20'+_0x4da9e7+'\x20not\x20found');const _0x2ad2fd=_0x3a0c0d[_0x5a9968(0x17f)],_0x5f34ef=_0x3a0c0d[_0x5a9968(0x1bd)];console[_0x5a9968(0x165)](_0x5a9968(0x1a6)+_0x4da9e7+':\x20'+_0x2ad2fd+'\x20->\x20'+_0x1c054c),console[_0x5a9968(0x165)](_0x5a9968(0x173)+_0x5f34ef['username']+_0x5a9968(0x1ec)+_0x5f34ef[_0x5a9968(0x1a8)]+'\x20USDT');const _0x2a657e={'status':_0x1c054c[_0x5a9968(0x16f)](),'updatedAt':new Date(),'statusChangedBy':_0x5a9968(0x20a),'statusChangedAt':new Date()};_0x2eca14?.[_0x5a9968(0x191)]&&(_0x2a657e[_0x5a9968(0x191)]=_0x2eca14[_0x5a9968(0x191)]);_0x2eca14?.['txUrls']&&(_0x2a657e['txUrls']=JSON[_0x5a9968(0x206)](_0x2eca14[_0x5a9968(0x1bb)]));_0x2eca14?.[_0x5a9968(0x1a0)]&&(_0x2a657e[_0x5a9968(0x1a0)]=_0x2eca14['cardLast4']);_0x2eca14?.[_0x5a9968(0x1ee)]&&(_0x2a657e[_0x5a9968(0x1ee)]=_0x2eca14[_0x5a9968(0x1ee)]);_0x2eca14?.[_0x5a9968(0x183)]&&(_0x2a657e[_0x5a9968(0x183)]=_0x2eca14['bankId']);_0x2eca14?.[_0x5a9968(0x19c)]&&(_0x2a657e[_0x5a9968(0x19c)]=_0x2eca14[_0x5a9968(0x19c)]);_0x2eca14?.['remitterName']&&(_0x2a657e[_0x5a9968(0x170)]=_0x2eca14[_0x5a9968(0x170)]);let _0x5411c2=_0x5f34ef[_0x5a9968(0x1a8)],_0x510109='';if(_0x1c054c[_0x5a9968(0x16f)]()===_0x5a9968(0x1b7)&&_0x2ad2fd!==_0x5a9968(0x1b7)){const _0xaedfbd=await currencyService_1['currencyService']['convertToUSDT'](_0x3a0c0d[_0x5a9968(0x16b)],_0x3a0c0d[_0x5a9968(0x1fe)]);_0x5411c2+=_0xaedfbd,_0x510109='+'+_0xaedfbd[_0x5a9968(0x18c)](0x6)+_0x5a9968(0x180),_0x2a657e[_0x5a9968(0x1ce)]=_0xaedfbd,_0x2a657e[_0x5a9968(0x1c2)]=new Date(),console[_0x5a9968(0x165)](_0x5a9968(0x17e)+_0x3a0c0d[_0x5a9968(0x16b)]+'\x20'+_0x3a0c0d[_0x5a9968(0x1fe)]+_0x5a9968(0x202)+_0xaedfbd[_0x5a9968(0x18c)](0x6)+_0x5a9968(0x1b4)),console[_0x5a9968(0x165)](_0x5a9968(0x1cd)+_0x5f34ef['balance']+_0x5a9968(0x1b8)+_0xaedfbd['toFixed'](0x6)+'\x20=\x20'+_0x5411c2[_0x5a9968(0x18c)](0x6)+_0x5a9968(0x1b4));}else{if(_0x2ad2fd==='PAID'&&_0x1c054c[_0x5a9968(0x16f)]()!==_0x5a9968(0x1b7)){const _0x39202b=_0x3a0c0d[_0x5a9968(0x1ce)];_0x39202b&&(_0x5411c2-=_0x39202b,_0x510109='-'+_0x39202b[_0x5a9968(0x18c)](0x6)+_0x5a9968(0x1d4),_0x2a657e['amountUSDT']=null,_0x2a657e['paidAt']=null,console[_0x5a9968(0x165)](_0x5a9968(0x1c4)+_0x5f34ef[_0x5a9968(0x1a8)]+_0x5a9968(0x1b1)+_0x39202b[_0x5a9968(0x18c)](0x6)+'\x20=\x20'+_0x5411c2[_0x5a9968(0x18c)](0x6)+_0x5a9968(0x1b4)));}}if(_0x1c054c[_0x5a9968(0x16f)]()===_0x5a9968(0x1a4)){const _0x149bd7=_0x2eca14?.['chargebackAmount']||0x0;_0x149bd7>0x0&&(_0x5411c2-=_0x149bd7,_0x510109+='\x20and\x20-'+_0x149bd7[_0x5a9968(0x18c)](0x6)+_0x5a9968(0x1c5),_0x2a657e[_0x5a9968(0x16c)]=_0x149bd7,console[_0x5a9968(0x165)](_0x5a9968(0x177)+_0x149bd7['toFixed'](0x6)+'\x20USDT'),console[_0x5a9968(0x165)](_0x5a9968(0x1b5)+_0x5411c2[_0x5a9968(0x18c)](0x6)+'\x20USDT'));}const _0x5ea5de=await _0x366b2e[_0x5a9968(0x166)][_0x5a9968(0x1c1)]({'where':{'id':_0x4da9e7},'data':_0x2a657e});_0x5411c2!==_0x5f34ef[_0x5a9968(0x1a8)]&&(await _0x366b2e[_0x5a9968(0x1bd)][_0x5a9968(0x1c1)]({'where':{'id':_0x5f34ef['id']},'data':{'balance':_0x5411c2}}),console[_0x5a9968(0x165)](_0x5a9968(0x18f)+_0x5f34ef[_0x5a9968(0x178)]+'\x20balance\x20updated:\x20'+_0x5f34ef[_0x5a9968(0x1a8)][_0x5a9968(0x18c)](0x6)+'\x20->\x20'+_0x5411c2[_0x5a9968(0x18c)](0x6)+'\x20USDT'),console[_0x5a9968(0x165)](_0x5a9968(0x1f7)+_0x510109)),await _0x366b2e[_0x5a9968(0x16d)][_0x5a9968(0x1da)]({'data':{'paymentId':_0x4da9e7,'shopId':_0x5f34ef['id'],'event':_0x5a9968(0x1a5)+_0x1c054c['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x5a9968(0x206)]({'oldStatus':_0x2ad2fd,'newStatus':_0x1c054c[_0x5a9968(0x16f)](),'balanceChange':_0x510109||_0x5a9968(0x192),'oldBalance':_0x5f34ef['balance'],'newBalance':_0x5411c2,'amountUSDT':_0x2a657e[_0x5a9968(0x1ce)],'additionalData':_0x2eca14,'timestamp':new Date()[_0x5a9968(0x168)]()})}}),await this[_0x5a9968(0x1e0)]({..._0x3a0c0d,..._0x5ea5de,'shop':_0x5f34ef},_0x1c054c['toUpperCase']()),await this[_0x5a9968(0x16e)]({..._0x3a0c0d,..._0x5ea5de},_0x1c054c['toUpperCase']());});}async['processPlisioWebhook'](_0xa20071){const _0x135abb=a56_0x1e9e3f;console['log']('🔄\x20Processing\x20Plisio\x20webhook:',_0xa20071);try{const _0x41e3be=await this[_0x135abb(0x199)][_0x135abb(0x20c)](_0xa20071);if(!_0x41e3be['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x30ab9f=await database_1[_0x135abb(0x1f3)]['payment'][_0x135abb(0x1d3)]({'where':{'gatewayOrderId':_0x41e3be[_0x135abb(0x169)]}});if(!_0x30ab9f){console['error'](_0x135abb(0x18a)+_0x41e3be['paymentId']);return;}console[_0x135abb(0x165)]('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0x30ab9f['id']+_0x135abb(0x1df)+_0x41e3be[_0x135abb(0x17f)]),await this[_0x135abb(0x1ed)](_0x30ab9f['id'],_0x41e3be[_0x135abb(0x17f)],{'txUrls':_0x41e3be[_0x135abb(0x1bb)]}),loggerService_1[_0x135abb(0x176)][_0x135abb(0x1bf)]('plisio',_0x30ab9f['id'],_0x30ab9f['status'],_0x41e3be[_0x135abb(0x17f)],_0xa20071);}catch(_0x31ed49){console[_0x135abb(0x195)](_0x135abb(0x207),_0x31ed49),loggerService_1[_0x135abb(0x176)][_0x135abb(0x188)](_0x135abb(0x1ef),_0x31ed49,_0xa20071);throw _0x31ed49;}}async[a56_0x1e9e3f(0x203)](_0x444b28){const _0x4d6dae=a56_0x1e9e3f;console[_0x4d6dae(0x165)]('🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:',_0x444b28);try{const _0xa9ae73=await this[_0x4d6dae(0x199)][_0x4d6dae(0x20c)](_0x444b28);if(!_0xa9ae73['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x5825d7=await database_1[_0x4d6dae(0x1f3)][_0x4d6dae(0x166)][_0x4d6dae(0x1d3)]({'where':{'gatewayOrderId':_0xa9ae73[_0x4d6dae(0x169)]}});if(!_0x5825d7){console[_0x4d6dae(0x195)]('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0xa9ae73['paymentId']);return;}console[_0x4d6dae(0x165)](_0x4d6dae(0x1c8)+_0x5825d7['id']+_0x4d6dae(0x1df)+_0xa9ae73[_0x4d6dae(0x17f)]),await this[_0x4d6dae(0x1ed)](_0x5825d7['id'],_0xa9ae73['status'],{'txUrls':_0xa9ae73[_0x4d6dae(0x1bb)]}),loggerService_1[_0x4d6dae(0x176)]['logWebhookProcessed']('plisio_gateway',_0x5825d7['id'],_0x5825d7[_0x4d6dae(0x17f)],_0xa9ae73['status'],_0x444b28);}catch(_0x10f769){console['error'](_0x4d6dae(0x1e6),_0x10f769),loggerService_1[_0x4d6dae(0x176)][_0x4d6dae(0x188)](_0x4d6dae(0x1ff),_0x10f769,_0x444b28);throw _0x10f769;}}async[a56_0x1e9e3f(0x1e2)](_0x32cb57){const _0x27acce=a56_0x1e9e3f;console[_0x27acce(0x165)](_0x27acce(0x1e8),_0x32cb57);try{const _0x12b8a3=await this[_0x27acce(0x1e3)][_0x27acce(0x20c)](_0x32cb57);if(!_0x12b8a3['paymentId'])throw new Error(_0x27acce(0x1b3));const _0x3be584=await database_1[_0x27acce(0x1f3)]['payment'][_0x27acce(0x1d3)]({'where':{'gatewayOrderId':_0x12b8a3[_0x27acce(0x169)]}});if(!_0x3be584){console[_0x27acce(0x195)](_0x27acce(0x197)+_0x12b8a3[_0x27acce(0x169)]);return;}console[_0x27acce(0x165)](_0x27acce(0x187)+_0x3be584['id']+_0x27acce(0x1df)+_0x12b8a3[_0x27acce(0x17f)]),await this[_0x27acce(0x1ed)](_0x3be584['id'],_0x12b8a3[_0x27acce(0x17f)],{'failureMessage':_0x12b8a3[_0x27acce(0x191)],'cardLast4':_0x12b8a3[_0x27acce(0x1db)]?.[_0x27acce(0x1a0)],'paymentMethod':_0x12b8a3[_0x27acce(0x1db)]?.['paymentMethod']}),loggerService_1[_0x27acce(0x176)][_0x27acce(0x1bf)](_0x27acce(0x1ac),_0x3be584['id'],_0x3be584[_0x27acce(0x17f)],_0x12b8a3[_0x27acce(0x17f)],_0x32cb57);}catch(_0x27a584){console['error'](_0x27acce(0x1f0),_0x27a584),loggerService_1[_0x27acce(0x176)][_0x27acce(0x188)](_0x27acce(0x1ac),_0x27a584,_0x32cb57);throw _0x27a584;}}async[a56_0x1e9e3f(0x18b)](_0x48f30e){const _0x384df8=a56_0x1e9e3f;console[_0x384df8(0x165)](_0x384df8(0x1f8),_0x48f30e);try{const _0x1cbbbf=await this[_0x384df8(0x1fb)]['processWebhook'](_0x48f30e);if(!_0x1cbbbf['paymentId'])throw new Error(_0x384df8(0x1dc));const _0x21e80c=await database_1[_0x384df8(0x1f3)][_0x384df8(0x166)][_0x384df8(0x1d3)]({'where':{'gatewayOrderId':_0x1cbbbf[_0x384df8(0x169)]}});if(!_0x21e80c){console[_0x384df8(0x195)](_0x384df8(0x181)+_0x1cbbbf['paymentId']);return;}console[_0x384df8(0x165)](_0x384df8(0x19f)+_0x21e80c['id']+'\x20status\x20'+_0x1cbbbf[_0x384df8(0x17f)]),await this['updatePaymentStatus'](_0x21e80c['id'],_0x1cbbbf[_0x384df8(0x17f)],{'bankId':_0x1cbbbf[_0x384df8(0x1db)]?.[_0x384df8(0x183)],'remitterIban':_0x1cbbbf[_0x384df8(0x1db)]?.[_0x384df8(0x19c)],'remitterName':_0x1cbbbf[_0x384df8(0x1db)]?.[_0x384df8(0x170)]}),loggerService_1['loggerService'][_0x384df8(0x1bf)](_0x384df8(0x1c9),_0x21e80c['id'],_0x21e80c[_0x384df8(0x17f)],_0x1cbbbf[_0x384df8(0x17f)],_0x48f30e);}catch(_0x3c5f3){console[_0x384df8(0x195)](_0x384df8(0x196),_0x3c5f3),loggerService_1[_0x384df8(0x176)][_0x384df8(0x188)](_0x384df8(0x1c9),_0x3c5f3,_0x48f30e);throw _0x3c5f3;}}async['processCoinToPayWebhook'](_0x7a30f0){const _0x28c3a5=a56_0x1e9e3f;console[_0x28c3a5(0x165)](_0x28c3a5(0x1ab),_0x7a30f0);try{const _0x12dac9=await this['coinToPayService'][_0x28c3a5(0x20c)](_0x7a30f0);if(!_0x12dac9[_0x28c3a5(0x169)])throw new Error(_0x28c3a5(0x1b9));const _0xfc1e79=await database_1[_0x28c3a5(0x1f3)][_0x28c3a5(0x166)][_0x28c3a5(0x1d3)]({'where':{'gatewayOrderId':_0x12dac9['paymentId']}});if(!_0xfc1e79){console[_0x28c3a5(0x195)](_0x28c3a5(0x1f6)+_0x12dac9[_0x28c3a5(0x169)]);return;}console[_0x28c3a5(0x165)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0xfc1e79['id']+'\x20status\x20'+_0x12dac9[_0x28c3a5(0x17f)]),await this[_0x28c3a5(0x1ed)](_0xfc1e79['id'],_0x12dac9[_0x28c3a5(0x17f)]),loggerService_1[_0x28c3a5(0x176)][_0x28c3a5(0x1bf)](_0x28c3a5(0x1e9),_0xfc1e79['id'],_0xfc1e79[_0x28c3a5(0x17f)],_0x12dac9[_0x28c3a5(0x17f)],_0x7a30f0);}catch(_0x24a2de){console[_0x28c3a5(0x195)](_0x28c3a5(0x1fd),_0x24a2de),loggerService_1[_0x28c3a5(0x176)]['logWebhookError']('cointopay',_0x24a2de,_0x7a30f0);throw _0x24a2de;}}async[a56_0x1e9e3f(0x1aa)](_0x2df6bc){const _0x111c8e=a56_0x1e9e3f;console[_0x111c8e(0x165)](_0x111c8e(0x171),_0x2df6bc);try{const _0x13592a=await this['klymeService'][_0x111c8e(0x20c)](_0x2df6bc);if(!_0x13592a[_0x111c8e(0x169)])throw new Error(_0x111c8e(0x1cb));const _0x20a111=await database_1[_0x111c8e(0x1f3)]['payment'][_0x111c8e(0x1d3)]({'where':{'gatewayOrderId':_0x13592a[_0x111c8e(0x169)]}});if(!_0x20a111){console[_0x111c8e(0x195)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x13592a[_0x111c8e(0x169)]);return;}console['log'](_0x111c8e(0x1d5)+_0x20a111['id']+_0x111c8e(0x1df)+_0x13592a['status']),await this[_0x111c8e(0x1ed)](_0x20a111['id'],_0x13592a[_0x111c8e(0x17f)],{'paymentMethod':_0x13592a[_0x111c8e(0x1db)]?.[_0x111c8e(0x1cc)]}),loggerService_1[_0x111c8e(0x176)]['logWebhookProcessed'](_0x111c8e(0x20d),_0x20a111['id'],_0x20a111[_0x111c8e(0x17f)],_0x13592a[_0x111c8e(0x17f)],_0x2df6bc);}catch(_0x24ed07){console[_0x111c8e(0x195)](_0x111c8e(0x20e),_0x24ed07),loggerService_1[_0x111c8e(0x176)][_0x111c8e(0x188)](_0x111c8e(0x20d),_0x24ed07,_0x2df6bc);throw _0x24ed07;}}async[a56_0x1e9e3f(0x20f)](_0x146162){const _0x18523f=a56_0x1e9e3f;console[_0x18523f(0x165)]('🔄\x20Processing\x20MasterCard\x20webhook:',_0x146162);try{const _0x48e2c5=await this[_0x18523f(0x17d)][_0x18523f(0x20c)](_0x146162);if(!_0x48e2c5['paymentId'])throw new Error(_0x18523f(0x208));const _0x17ec0f=await database_1[_0x18523f(0x1f3)][_0x18523f(0x166)][_0x18523f(0x1d3)]({'where':{'gatewayOrderId':_0x48e2c5[_0x18523f(0x169)]}});if(!_0x17ec0f){console[_0x18523f(0x195)](_0x18523f(0x1e5)+_0x48e2c5['paymentId']);return;}console['log'](_0x18523f(0x1fa)+_0x17ec0f['id']+'\x20status\x20'+_0x48e2c5[_0x18523f(0x17f)]),await this[_0x18523f(0x1ed)](_0x17ec0f['id'],_0x48e2c5['status']),loggerService_1[_0x18523f(0x176)][_0x18523f(0x1bf)](_0x18523f(0x16a),_0x17ec0f['id'],_0x17ec0f[_0x18523f(0x17f)],_0x48e2c5[_0x18523f(0x17f)],_0x146162);}catch(_0x122879){console[_0x18523f(0x195)](_0x18523f(0x190),_0x122879),loggerService_1[_0x18523f(0x176)][_0x18523f(0x188)](_0x18523f(0x16a),_0x122879,_0x146162);throw _0x122879;}}async['sendShopWebhook'](_0x1f937e,_0x70714c){const _0x240e76=a56_0x1e9e3f,_0x1a26bb=Date['now']();try{const _0x16c8b7=_0x1f937e['shop'],_0xff6bd1=_0x16c8b7[_0x240e76(0x200)];if(!_0xff6bd1?.['webhookUrl']){console[_0x240e76(0x165)](_0x240e76(0x1ca)+_0x16c8b7['id']);return;}const _0x44d51e=_0x70714c===_0x240e76(0x1b7)?'payment.success':_0x70714c==='FAILED'?_0x240e76(0x198):_0x70714c==='EXPIRED'?_0x240e76(0x198):_0x70714c===_0x240e76(0x1a4)?'payment.failed':_0x70714c===_0x240e76(0x1d7)?_0x240e76(0x198):'payment.pending';let _0x3173fb=[];if(_0xff6bd1[_0x240e76(0x182)])try{_0x3173fb=Array[_0x240e76(0x17a)](_0xff6bd1['webhookEvents'])?_0xff6bd1['webhookEvents']:JSON[_0x240e76(0x189)](_0xff6bd1[_0x240e76(0x182)]);}catch(_0x4d84d5){console[_0x240e76(0x195)](_0x240e76(0x19b),_0x4d84d5),_0x3173fb=[];}if(!_0x3173fb[_0x240e76(0x185)](_0x44d51e)){console[_0x240e76(0x165)](_0x240e76(0x17b)+_0x44d51e+'\x20not\x20enabled\x20for\x20shop\x20'+_0x16c8b7['id']);return;}const _0x3a986e={'event':_0x44d51e,'payment':{'id':_0x1f937e['id'],'order_id':_0x1f937e['orderId'],'gateway_order_id':_0x1f937e['gatewayOrderId'],'gateway':_0x1f937e[_0x240e76(0x1b0)],'amount':_0x1f937e[_0x240e76(0x16b)],'currency':_0x1f937e[_0x240e76(0x1fe)],'status':_0x70714c[_0x240e76(0x1c0)](),'customer_email':_0x1f937e['customerEmail'],'customer_name':_0x1f937e[_0x240e76(0x1bc)],'failure_message':_0x1f937e['failureMessage'],'tx_urls':_0x1f937e[_0x240e76(0x1bb)]?JSON['parse'](_0x1f937e['txUrls']):null,'created_at':_0x1f937e[_0x240e76(0x1eb)],'updated_at':_0x1f937e[_0x240e76(0x184)]}},_0x3ef4ec=await fetch(_0xff6bd1[_0x240e76(0x1de)],{'method':_0x240e76(0x18e),'headers':{'Content-Type':_0x240e76(0x1e1),'User-Agent':_0x240e76(0x1ea)},'body':JSON[_0x240e76(0x206)](_0x3a986e)}),_0x394291=Date[_0x240e76(0x1a3)]()-_0x1a26bb,_0x3643c1=_0x3ef4ec['ok']?'Success':await _0x3ef4ec[_0x240e76(0x172)]();loggerService_1[_0x240e76(0x176)][_0x240e76(0x1c6)](_0x1f937e['shopId'],_0xff6bd1[_0x240e76(0x1de)],_0x44d51e,_0x3ef4ec['status'],_0x394291,_0x3a986e),console[_0x240e76(0x165)]('📤\x20Shop\x20webhook\x20sent\x20to\x20'+_0xff6bd1[_0x240e76(0x1de)]+_0x240e76(0x1b6)+_0x3ef4ec[_0x240e76(0x17f)]+'\x20('+_0x394291+'ms)');}catch(_0x5a32c0){console[_0x240e76(0x195)](_0x240e76(0x17c),_0x5a32c0),loggerService_1['loggerService'][_0x240e76(0x19d)](_0x1f937e[_0x240e76(0x1a1)],_0x1f937e[_0x240e76(0x1bd)]?.[_0x240e76(0x200)]?.[_0x240e76(0x1de)]||_0x240e76(0x1ad),_0x240e76(0x1f5),_0x5a32c0,{});}}async[a56_0x1e9e3f(0x16e)](_0x4043df,_0x364a0c){const _0x43d071=a56_0x1e9e3f;try{const _0x2a3139={'PENDING':_0x43d071(0x1ae),'PROCESSING':_0x43d071(0x20b),'PAID':'paid','FAILED':_0x43d071(0x205),'EXPIRED':'expired','REFUND':_0x43d071(0x209),'CHARGEBACK':'chargeback'},_0x325f97=_0x2a3139[_0x364a0c];if(!_0x325f97||_0x325f97==='created')return;await telegramBotService_1['telegramBotService'][_0x43d071(0x167)](_0x4043df[_0x43d071(0x1a1)],_0x4043df,_0x325f97);}catch(_0x5a8a02){console[_0x43d071(0x195)](_0x43d071(0x1f4),_0x5a8a02);}}}exports[a56_0x1e9e3f(0x1ba)]=WebhookService;