'use strict';function a65_0x2dd8(_0x19e0ed,_0x505f61){const _0x4a05dd=a65_0x4a05();return a65_0x2dd8=function(_0x2dd837,_0x160e77){_0x2dd837=_0x2dd837-0x124;let _0x1fd55e=_0x4a05dd[_0x2dd837];return _0x1fd55e;},a65_0x2dd8(_0x19e0ed,_0x505f61);}const a65_0x16fb31=a65_0x2dd8;(function(_0x51a90a,_0x2866fe){const _0x234d68=a65_0x2dd8,_0x24ccdd=_0x51a90a();while(!![]){try{const _0xd9f698=-parseInt(_0x234d68(0x12f))/0x1+-parseInt(_0x234d68(0x14c))/0x2+parseInt(_0x234d68(0x229))/0x3+parseInt(_0x234d68(0x126))/0x4*(parseInt(_0x234d68(0x15f))/0x5)+-parseInt(_0x234d68(0x251))/0x6*(parseInt(_0x234d68(0x136))/0x7)+-parseInt(_0x234d68(0x225))/0x8+parseInt(_0x234d68(0x20a))/0x9*(parseInt(_0x234d68(0x250))/0xa);if(_0xd9f698===_0x2866fe)break;else _0x24ccdd['push'](_0x24ccdd['shift']());}catch(_0x5573b6){_0x24ccdd['push'](_0x24ccdd['shift']());}}}(a65_0x4a05,0x58927));var __importDefault=this&&this[a65_0x16fb31(0x1ca)]||function(_0xdbe5dd){const _0x5b441d=a65_0x16fb31;return _0xdbe5dd&&_0xdbe5dd[_0x5b441d(0x201)]?_0xdbe5dd:{'default':_0xdbe5dd};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a65_0x16fb31(0x1b4)]=void 0x0;const database_1=__importDefault(require(a65_0x16fb31(0x25b))),plisioService_1=require(a65_0x16fb31(0x1e0)),rapydService_1=require(a65_0x16fb31(0x1d6)),nodaService_1=require(a65_0x16fb31(0x239)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a65_0x16fb31(0x246)),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a65_0x16fb31(0x1ed)),amerService_1=require(a65_0x16fb31(0x1f2)),ampayService_1=require(a65_0x16fb31(0x156)),ampayTRYService_1=require(a65_0x16fb31(0x260)),telegramBotService_1=require(a65_0x16fb31(0x223)),currencyService_1=require(a65_0x16fb31(0x15b)),loggerService_1=require(a65_0x16fb31(0x19a));class WebhookService{constructor(){const _0x24b384=a65_0x16fb31;this[_0x24b384(0x216)]=new plisioService_1[(_0x24b384(0x191))](),this[_0x24b384(0x249)]=new rapydService_1[(_0x24b384(0x25e))](),this[_0x24b384(0x18f)]=new nodaService_1[(_0x24b384(0x1da))](),this[_0x24b384(0x15c)]=new coinToPayService_1[(_0x24b384(0x164))](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x24b384(0x162))](),this[_0x24b384(0x22d)]=new klymeService_1[(_0x24b384(0x139))](),this[_0x24b384(0x1fa)]=new mastercardService_1['VisaMasterCardService'](),this[_0x24b384(0x1cd)]=new amerService_1[(_0x24b384(0x132))](),this[_0x24b384(0x245)]=new ampayService_1[(_0x24b384(0x209))](),this[_0x24b384(0x20c)]=new ampayTRYService_1['AmPayTRYService']();}async[a65_0x16fb31(0x12e)](_0x43f925,_0x506166,_0x2783ea){const _0xf9c0c1=a65_0x16fb31;console[_0xf9c0c1(0x13e)](_0xf9c0c1(0x18d)+_0x43f925+',\x20newStatus='+_0x506166),console['log'](_0xf9c0c1(0x1ae),_0x2783ea),await database_1[_0xf9c0c1(0x241)][_0xf9c0c1(0x137)](async _0x46211d=>{const _0x3e9bd9=_0xf9c0c1,_0x385ff2=await _0x46211d[_0x3e9bd9(0x146)]['findUnique']({'where':{'id':_0x43f925},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x385ff2)throw new Error('Payment\x20'+_0x43f925+_0x3e9bd9(0x228));const _0x4665ff=_0x385ff2[_0x3e9bd9(0x1f7)],_0x1fa16b=_0x385ff2['shop'];console[_0x3e9bd9(0x13e)](_0x3e9bd9(0x134)+_0x43f925+':\x20'+_0x4665ff+_0x3e9bd9(0x1cb)+_0x506166),console[_0x3e9bd9(0x13e)](_0x3e9bd9(0x1a9)+_0x1fa16b[_0x3e9bd9(0x1c6)]+'\x20current\x20balance:\x20'+_0x1fa16b[_0x3e9bd9(0x1b3)]+'\x20USDT');const _0x3dac86={'status':_0x506166['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x3e9bd9(0x1b2),'statusChangedAt':new Date()};_0x2783ea?.['failureMessage']&&(_0x3dac86['failureMessage']=_0x2783ea[_0x3e9bd9(0x206)]);_0x2783ea?.[_0x3e9bd9(0x1b0)]&&(_0x3dac86[_0x3e9bd9(0x1b0)]=JSON[_0x3e9bd9(0x1d2)](_0x2783ea[_0x3e9bd9(0x1b0)]));_0x2783ea?.[_0x3e9bd9(0x17d)]&&(_0x3dac86['cardLast4']=_0x2783ea[_0x3e9bd9(0x17d)]);_0x2783ea?.['paymentMethod']&&(_0x3dac86[_0x3e9bd9(0x1ba)]=_0x2783ea[_0x3e9bd9(0x1ba)]);_0x2783ea?.[_0x3e9bd9(0x150)]&&(_0x3dac86[_0x3e9bd9(0x150)]=_0x2783ea[_0x3e9bd9(0x150)]);_0x2783ea?.[_0x3e9bd9(0x1eb)]&&(_0x3dac86[_0x3e9bd9(0x1eb)]=_0x2783ea['remitterIban']);_0x2783ea?.[_0x3e9bd9(0x1ee)]&&(_0x3dac86['remitterName']=_0x2783ea[_0x3e9bd9(0x1ee)]);let _0x1fe2a1=_0x1fa16b[_0x3e9bd9(0x1b3)],_0x1a9273='';if(_0x506166['toUpperCase']()==='PAID'&&_0x4665ff!=='PAID'){const _0x102371=await currencyService_1[_0x3e9bd9(0x1ab)][_0x3e9bd9(0x255)](_0x385ff2['amount'],_0x385ff2['currency']),_0x2bf096=await this[_0x3e9bd9(0x1e7)](_0x1fa16b['id'],_0x385ff2[_0x3e9bd9(0x15e)]),_0x6b27e9=_0x102371*(0x1-_0x2bf096/0x64);_0x1fe2a1+=_0x6b27e9,_0x1a9273='+'+_0x6b27e9[_0x3e9bd9(0x14f)](0x6)+_0x3e9bd9(0x1b8)+_0x2bf096+_0x3e9bd9(0x1a5),_0x3dac86[_0x3e9bd9(0x247)]=_0x102371,_0x3dac86[_0x3e9bd9(0x261)]=_0x6b27e9,_0x3dac86[_0x3e9bd9(0x1f6)]=_0x2bf096,_0x3dac86[_0x3e9bd9(0x1dc)]=new Date(),console['log'](_0x3e9bd9(0x128)+_0x385ff2[_0x3e9bd9(0x149)]+'\x20'+_0x385ff2[_0x3e9bd9(0x14e)]+_0x3e9bd9(0x1cb)+_0x102371[_0x3e9bd9(0x14f)](0x6)+_0x3e9bd9(0x1e3)),console[_0x3e9bd9(0x13e)]('💰\x20Gateway\x20'+_0x385ff2[_0x3e9bd9(0x15e)]+'\x20commission:\x20'+_0x2bf096+'%'),console[_0x3e9bd9(0x13e)](_0x3e9bd9(0x22a)+_0x6b27e9[_0x3e9bd9(0x14f)](0x6)+'\x20USDT'),console[_0x3e9bd9(0x13e)]('💰\x20Adding\x20to\x20balance:\x20'+_0x1fa16b['balance']+'\x20+\x20'+_0x6b27e9['toFixed'](0x6)+_0x3e9bd9(0x13a)+_0x1fe2a1[_0x3e9bd9(0x14f)](0x6)+_0x3e9bd9(0x1e3));}else{if(_0x4665ff===_0x3e9bd9(0x22b)&&_0x506166[_0x3e9bd9(0x227)]()!==_0x3e9bd9(0x22b)){let _0x320fb9;if(_0x385ff2['amountAfterGatewayCommissionUSDT'])_0x320fb9=_0x385ff2[_0x3e9bd9(0x261)];else{if(_0x385ff2[_0x3e9bd9(0x247)]){const _0x420af1=await this['getGatewayCommission'](_0x1fa16b['id'],_0x385ff2[_0x3e9bd9(0x15e)]);_0x320fb9=_0x385ff2[_0x3e9bd9(0x247)]*(0x1-_0x420af1/0x64);}else console[_0x3e9bd9(0x13e)]('No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance'),_0x320fb9=0x0;}_0x320fb9>0x0&&(_0x1fe2a1-=_0x320fb9,_0x1a9273='-'+_0x320fb9[_0x3e9bd9(0x14f)](0x6)+_0x3e9bd9(0x129),_0x3dac86['amountUSDT']=null,_0x3dac86[_0x3e9bd9(0x261)]=null,_0x3dac86[_0x3e9bd9(0x1dc)]=null,console['log'](_0x3e9bd9(0x238)+_0x1fa16b['balance']+_0x3e9bd9(0x1a8)+_0x320fb9[_0x3e9bd9(0x14f)](0x6)+_0x3e9bd9(0x13a)+_0x1fe2a1[_0x3e9bd9(0x14f)](0x6)+_0x3e9bd9(0x1e3)));}}if(_0x506166['toUpperCase']()==='CHARGEBACK'){const _0x55aaf3=_0x2783ea?.[_0x3e9bd9(0x188)]||0x0;_0x55aaf3>0x0&&(_0x1fe2a1-=_0x55aaf3,_0x1a9273+=_0x3e9bd9(0x166)+_0x55aaf3['toFixed'](0x6)+_0x3e9bd9(0x198),_0x3dac86[_0x3e9bd9(0x188)]=_0x55aaf3,console[_0x3e9bd9(0x13e)](_0x3e9bd9(0x1fe)+_0x55aaf3['toFixed'](0x6)+_0x3e9bd9(0x1e3)),console['log'](_0x3e9bd9(0x142)+_0x1fe2a1[_0x3e9bd9(0x14f)](0x6)+_0x3e9bd9(0x1e3)));}const _0x199d08=await _0x46211d[_0x3e9bd9(0x146)][_0x3e9bd9(0x20f)]({'where':{'id':_0x43f925},'data':_0x3dac86});_0x1fe2a1!==_0x1fa16b[_0x3e9bd9(0x1b3)]&&(await _0x46211d[_0x3e9bd9(0x1e4)][_0x3e9bd9(0x20f)]({'where':{'id':_0x1fa16b['id']},'data':{'balance':_0x1fe2a1}}),console['log'](_0x3e9bd9(0x1db)+_0x1fa16b[_0x3e9bd9(0x1c6)]+_0x3e9bd9(0x1fb)+_0x1fa16b[_0x3e9bd9(0x1b3)]['toFixed'](0x6)+_0x3e9bd9(0x1cb)+_0x1fe2a1['toFixed'](0x6)+'\x20USDT'),console[_0x3e9bd9(0x13e)](_0x3e9bd9(0x1ce)+_0x1a9273));await _0x46211d[_0x3e9bd9(0x1a1)][_0x3e9bd9(0x215)]({'data':{'paymentId':_0x43f925,'shopId':_0x1fa16b['id'],'event':_0x3e9bd9(0x257)+_0x506166[_0x3e9bd9(0x182)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x4665ff,'newStatus':_0x506166['toUpperCase'](),'balanceChange':_0x1a9273||'no\x20balance\x20change','oldBalance':_0x1fa16b[_0x3e9bd9(0x1b3)],'newBalance':_0x1fe2a1,'amountUSDT':_0x3dac86[_0x3e9bd9(0x247)],'additionalData':_0x2783ea,'timestamp':new Date()[_0x3e9bd9(0x1d5)]()})}}),await this[_0x3e9bd9(0x176)]({..._0x385ff2,..._0x199d08,'shop':_0x1fa16b},_0x506166['toUpperCase']()),await this[_0x3e9bd9(0x20e)]({..._0x385ff2,..._0x199d08},_0x506166[_0x3e9bd9(0x227)]());if(_0x4665ff!==_0x3e9bd9(0x22b)&&_0x506166[_0x3e9bd9(0x227)]()===_0x3e9bd9(0x22b)){console['log'](_0x3e9bd9(0x1c1)+_0x43f925+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console[_0x3e9bd9(0x13e)]('📈\x20Payment\x20details:\x20oldStatus=\x22'+_0x4665ff+_0x3e9bd9(0x208)+_0x506166[_0x3e9bd9(0x227)]()+_0x3e9bd9(0x18a)+_0x385ff2[_0x3e9bd9(0x1e2)]+'\x22');if(_0x385ff2[_0x3e9bd9(0x1e2)])try{const _0xb001c5=await _0x46211d[_0x3e9bd9(0x175)][_0x3e9bd9(0x19f)]({'where':{'id':_0x385ff2[_0x3e9bd9(0x1e2)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0xb001c5){console['log']('📈\x20Found\x20payment\x20link\x20'+_0xb001c5['id']+_0x3e9bd9(0x19e)+_0xb001c5['type']+_0x3e9bd9(0x254)+_0xb001c5[_0x3e9bd9(0x151)]+_0x3e9bd9(0x145)+_0xb001c5[_0x3e9bd9(0x1f7)]);const _0x2c9a4d=_0xb001c5[_0x3e9bd9(0x151)]+0x1,_0x3770bf=_0xb001c5[_0x3e9bd9(0x16e)]===_0x3e9bd9(0x155)?_0x3e9bd9(0x1d7):_0xb001c5[_0x3e9bd9(0x1f7)];await _0x46211d[_0x3e9bd9(0x175)]['update']({'where':{'id':_0x385ff2[_0x3e9bd9(0x1e2)]},'data':{'currentPayments':_0x2c9a4d,'status':_0x3770bf,'updatedAt':new Date()}}),console[_0x3e9bd9(0x13e)]('✅\x20Payment\x20link\x20'+_0xb001c5['id']+_0x3e9bd9(0x159)+_0xb001c5['currentPayments']+_0x3e9bd9(0x1cb)+_0x2c9a4d+_0x3e9bd9(0x145)+_0xb001c5[_0x3e9bd9(0x1f7)]+_0x3e9bd9(0x1cb)+_0x3770bf);}else console[_0x3e9bd9(0x13e)](_0x3e9bd9(0x1ea)+_0x385ff2['paymentLinkId']+_0x3e9bd9(0x228));}catch(_0x495619){console[_0x3e9bd9(0x230)](_0x3e9bd9(0x1ec),_0x495619);}else console['log'](_0x3e9bd9(0x1c1)+_0x43f925+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0x3e9bd9(0x13e)](_0x3e9bd9(0x1c1)+_0x43f925+_0x3e9bd9(0x220)+_0x4665ff+_0x3e9bd9(0x1cb)+_0x506166[_0x3e9bd9(0x227)]());});}async['processPlisioWebhook'](_0x205b64){const _0x5e6430=a65_0x16fb31;console[_0x5e6430(0x13e)](_0x5e6430(0x183),_0x205b64);try{const _0x2027f7=await this[_0x5e6430(0x216)][_0x5e6430(0x141)](_0x205b64);if(!_0x2027f7[_0x5e6430(0x1a7)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x42e584=await database_1[_0x5e6430(0x241)][_0x5e6430(0x146)][_0x5e6430(0x24d)]({'where':{'gatewayOrderId':_0x2027f7[_0x5e6430(0x1a7)]}});if(!_0x42e584){console[_0x5e6430(0x230)](_0x5e6430(0x165)+_0x2027f7['paymentId']);return;}console[_0x5e6430(0x13e)]('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0x42e584['id']+_0x5e6430(0x16c)+_0x2027f7[_0x5e6430(0x1f7)]),await this['updatePaymentStatus'](_0x42e584['id'],_0x2027f7[_0x5e6430(0x1f7)],{'txUrls':_0x2027f7[_0x5e6430(0x1b0)]}),loggerService_1[_0x5e6430(0x15d)][_0x5e6430(0x1a0)]('plisio',_0x42e584['id'],_0x42e584['status'],_0x2027f7[_0x5e6430(0x1f7)],_0x205b64);}catch(_0x102afb){console['error'](_0x5e6430(0x243),_0x102afb),loggerService_1[_0x5e6430(0x15d)][_0x5e6430(0x25a)](_0x5e6430(0x21d),_0x102afb,_0x205b64);throw _0x102afb;}}async[a65_0x16fb31(0x212)](_0x3f2045){const _0x17f86a=a65_0x16fb31;console[_0x17f86a(0x13e)](_0x17f86a(0x160),_0x3f2045);try{const _0x261162=await this[_0x17f86a(0x216)][_0x17f86a(0x141)](_0x3f2045);if(!_0x261162['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x12b3e1=await database_1['default'][_0x17f86a(0x146)][_0x17f86a(0x24d)]({'where':{'gatewayOrderId':_0x261162[_0x17f86a(0x1a7)]}});if(!_0x12b3e1){console[_0x17f86a(0x230)](_0x17f86a(0x1e6)+_0x261162[_0x17f86a(0x1a7)]);return;}console[_0x17f86a(0x13e)]('📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20'+_0x12b3e1['id']+_0x17f86a(0x16c)+_0x261162[_0x17f86a(0x1f7)]),await this[_0x17f86a(0x12e)](_0x12b3e1['id'],_0x261162[_0x17f86a(0x1f7)],{'txUrls':_0x261162['txUrls']}),loggerService_1[_0x17f86a(0x15d)][_0x17f86a(0x1a0)](_0x17f86a(0x22c),_0x12b3e1['id'],_0x12b3e1[_0x17f86a(0x1f7)],_0x261162[_0x17f86a(0x1f7)],_0x3f2045);}catch(_0x26e913){console['error']('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x26e913),loggerService_1[_0x17f86a(0x15d)][_0x17f86a(0x25a)](_0x17f86a(0x22c),_0x26e913,_0x3f2045);throw _0x26e913;}}async[a65_0x16fb31(0x1c8)](_0x492e31){const _0x4088d7=a65_0x16fb31;console[_0x4088d7(0x13e)](_0x4088d7(0x17f),_0x492e31);try{const _0x5a72d7=await this[_0x4088d7(0x249)]['processWebhook'](_0x492e31);if(!_0x5a72d7[_0x4088d7(0x1a7)])throw new Error(_0x4088d7(0x205));const _0x52c14d=await database_1[_0x4088d7(0x241)]['payment'][_0x4088d7(0x24d)]({'where':{'gatewayOrderId':_0x5a72d7['paymentId']}});if(!_0x52c14d){console[_0x4088d7(0x230)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x5a72d7['paymentId']);return;}console[_0x4088d7(0x13e)](_0x4088d7(0x221)+_0x52c14d['id']+_0x4088d7(0x16c)+_0x5a72d7['status']),await this[_0x4088d7(0x12e)](_0x52c14d['id'],_0x5a72d7[_0x4088d7(0x1f7)],{'failureMessage':_0x5a72d7['failureMessage'],'cardLast4':_0x5a72d7[_0x4088d7(0x1cc)]?.[_0x4088d7(0x17d)],'paymentMethod':_0x5a72d7[_0x4088d7(0x1cc)]?.[_0x4088d7(0x1ba)]}),loggerService_1[_0x4088d7(0x15d)][_0x4088d7(0x1a0)]('rapyd',_0x52c14d['id'],_0x52c14d['status'],_0x5a72d7[_0x4088d7(0x1f7)],_0x492e31);}catch(_0xa92805){console[_0x4088d7(0x230)](_0x4088d7(0x1d4),_0xa92805),loggerService_1[_0x4088d7(0x15d)]['logWebhookError']('rapyd',_0xa92805,_0x492e31);throw _0xa92805;}}async[a65_0x16fb31(0x152)](_0x4d0b98){const _0x258078=a65_0x16fb31;console['log']('🔄\x20Processing\x20Noda\x20webhook:',_0x4d0b98);try{const _0x281597=await this['nodaService'][_0x258078(0x141)](_0x4d0b98);if(!_0x281597[_0x258078(0x1a7)])throw new Error(_0x258078(0x124));const _0x6b205=await database_1['default'][_0x258078(0x146)]['findFirst']({'where':{'gatewayOrderId':_0x281597[_0x258078(0x1a7)]}});if(!_0x6b205){console[_0x258078(0x230)](_0x258078(0x23c)+_0x281597['paymentId']);return;}console[_0x258078(0x13e)](_0x258078(0x13c)+_0x6b205['id']+_0x258078(0x16c)+_0x281597[_0x258078(0x1f7)]),await this[_0x258078(0x12e)](_0x6b205['id'],_0x281597[_0x258078(0x1f7)],{'bankId':_0x281597[_0x258078(0x1cc)]?.[_0x258078(0x150)],'remitterIban':_0x281597['additionalInfo']?.['remitterIban'],'remitterName':_0x281597['additionalInfo']?.[_0x258078(0x1ee)]}),loggerService_1[_0x258078(0x15d)][_0x258078(0x1a0)](_0x258078(0x16b),_0x6b205['id'],_0x6b205[_0x258078(0x1f7)],_0x281597['status'],_0x4d0b98);}catch(_0x11a45c){console[_0x258078(0x230)](_0x258078(0x1a4),_0x11a45c),loggerService_1[_0x258078(0x15d)][_0x258078(0x25a)](_0x258078(0x16b),_0x11a45c,_0x4d0b98);throw _0x11a45c;}}async[a65_0x16fb31(0x21f)](_0x388155){const _0x10c94e=a65_0x16fb31;console['log']('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x388155);try{const _0x364935=await this[_0x10c94e(0x15c)][_0x10c94e(0x141)](_0x388155);if(!_0x364935[_0x10c94e(0x1a7)])throw new Error(_0x10c94e(0x14d));const _0x2fa07e=await database_1['default'][_0x10c94e(0x146)]['findFirst']({'where':{'gatewayOrderId':_0x364935[_0x10c94e(0x1a7)]}});if(!_0x2fa07e){console['error'](_0x10c94e(0x1dd)+_0x364935[_0x10c94e(0x1a7)]);return;}console['log'](_0x10c94e(0x231)+_0x2fa07e['id']+'\x20status\x20'+_0x364935[_0x10c94e(0x1f7)]),await this[_0x10c94e(0x12e)](_0x2fa07e['id'],_0x364935[_0x10c94e(0x1f7)]),loggerService_1[_0x10c94e(0x15d)][_0x10c94e(0x1a0)]('cointopay',_0x2fa07e['id'],_0x2fa07e[_0x10c94e(0x1f7)],_0x364935[_0x10c94e(0x1f7)],_0x388155);}catch(_0x1aedb0){console[_0x10c94e(0x230)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x1aedb0),loggerService_1['loggerService']['logWebhookError'](_0x10c94e(0x21b),_0x1aedb0,_0x388155);throw _0x1aedb0;}}async['processCoinToPay2Webhook'](_0x121a54){const _0x236a98=a65_0x16fb31;console[_0x236a98(0x13e)](_0x236a98(0x1f8),_0x121a54);try{const _0x161f95=await this[_0x236a98(0x178)][_0x236a98(0x141)](_0x121a54);if(!_0x161f95[_0x236a98(0x1a7)])throw new Error(_0x236a98(0x23e));const _0x519b17=await database_1['default'][_0x236a98(0x146)]['findFirst']({'where':{'gatewayOrderId':_0x161f95['paymentId']}});if(!_0x519b17){console[_0x236a98(0x230)]('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x161f95['paymentId']);return;}console[_0x236a98(0x13e)]('📊\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x519b17['id']+_0x236a98(0x16c)+_0x161f95['status']),await this[_0x236a98(0x12e)](_0x519b17['id'],_0x161f95[_0x236a98(0x1f7)]),loggerService_1[_0x236a98(0x15d)]['logWebhookProcessed'](_0x236a98(0x1f5),_0x519b17['id'],_0x519b17['status'],_0x161f95[_0x236a98(0x1f7)],_0x121a54);}catch(_0xa39634){console[_0x236a98(0x230)](_0x236a98(0x180),_0xa39634),loggerService_1[_0x236a98(0x15d)]['logWebhookError']('cointopay2',_0xa39634,_0x121a54);throw _0xa39634;}}async[a65_0x16fb31(0x12a)](_0x59658a){const _0x6731e8=a65_0x16fb31;console[_0x6731e8(0x13e)]('🔄\x20Processing\x20KLYME\x20webhook:',_0x59658a);try{const _0x330699=await this[_0x6731e8(0x22d)][_0x6731e8(0x141)](_0x59658a);if(!_0x330699['paymentId'])throw new Error(_0x6731e8(0x24e));const _0x1b6042=await database_1[_0x6731e8(0x241)][_0x6731e8(0x146)][_0x6731e8(0x24d)]({'where':{'gatewayOrderId':_0x330699['paymentId']}});if(!_0x1b6042){console[_0x6731e8(0x230)](_0x6731e8(0x163)+_0x330699[_0x6731e8(0x1a7)]);return;}console[_0x6731e8(0x13e)](_0x6731e8(0x13b)+_0x1b6042['id']+_0x6731e8(0x16c)+_0x330699[_0x6731e8(0x1f7)]),await this[_0x6731e8(0x12e)](_0x1b6042['id'],_0x330699[_0x6731e8(0x1f7)],{'paymentMethod':_0x330699[_0x6731e8(0x1cc)]?.[_0x6731e8(0x1a6)]}),loggerService_1[_0x6731e8(0x15d)][_0x6731e8(0x1a0)](_0x6731e8(0x161),_0x1b6042['id'],_0x1b6042[_0x6731e8(0x1f7)],_0x330699[_0x6731e8(0x1f7)],_0x59658a);}catch(_0x5ce045){console[_0x6731e8(0x230)](_0x6731e8(0x23f),_0x5ce045),loggerService_1[_0x6731e8(0x15d)][_0x6731e8(0x25a)](_0x6731e8(0x161),_0x5ce045,_0x59658a);throw _0x5ce045;}}async['processVisaWebhook'](_0xb79310){const _0x5685e5=a65_0x16fb31;console[_0x5685e5(0x13e)](_0x5685e5(0x25d),JSON['stringify'](_0xb79310,null,0x2));try{const _0x45b5e5=await this[_0x5685e5(0x1fa)][_0x5685e5(0x141)](_0xb79310,'VISA');console[_0x5685e5(0x13e)](_0x5685e5(0x204),_0x45b5e5);if(!_0x45b5e5[_0x5685e5(0x1a7)]){console['error']('❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data'),console[_0x5685e5(0x230)](_0x5685e5(0x148),Object[_0x5685e5(0x1b1)](_0xb79310));throw new Error('No\x20payment\x20ID\x20in\x20VISA\x20webhook');}let _0x108e1a=null;console[_0x5685e5(0x13e)](_0x5685e5(0x1ac)+_0x45b5e5['paymentId']);if(_0x45b5e5[_0x5685e5(0x1a7)]){console[_0x5685e5(0x13e)](_0x5685e5(0x1e1)),console['log'](_0x5685e5(0x14b)),console[_0x5685e5(0x13e)](_0x5685e5(0x1d1)),console['log'](_0x5685e5(0x133)+_0x45b5e5[_0x5685e5(0x1a7)]),console[_0x5685e5(0x13e)](_0x5685e5(0x174)),_0x108e1a=await database_1[_0x5685e5(0x241)][_0x5685e5(0x146)][_0x5685e5(0x24d)]({'where':{'AND':[{'OR':[{'gateway':_0x5685e5(0x187)},{'gateway':'mastercard'}]},{'OR':[{'gatewayPaymentId':_0x45b5e5['paymentId']},{'gatewayOrderId':_0x45b5e5[_0x5685e5(0x1a7)]},{'id':_0x45b5e5[_0x5685e5(0x1a7)]},{'orderId':_0x45b5e5['paymentId']}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x5685e5(0x13e)]('🔍\x20VISA\x20payment\x20search\x20executed');if(_0x108e1a)console[_0x5685e5(0x13e)](_0x5685e5(0x1bb)+_0x108e1a['id']+_0x5685e5(0x169)+_0x108e1a[_0x5685e5(0x127)]+_0x5685e5(0x170)+_0x108e1a[_0x5685e5(0x1bf)]);else{console[_0x5685e5(0x13e)]('❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...');const _0x1f5136=await database_1[_0x5685e5(0x241)][_0x5685e5(0x146)][_0x5685e5(0x20b)]({'where':{'gateway':_0x5685e5(0x187)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x5685e5(0x21e)}});console[_0x5685e5(0x13e)]('🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:',_0x1f5136[_0x5685e5(0x23b)](_0x56a734=>_0x56a734['id']+_0x5685e5(0x1fd)+_0x56a734[_0x5685e5(0x218)]+_0x5685e5(0x1c4)+_0x56a734[_0x5685e5(0x127)]+_0x5685e5(0x15a)+_0x56a734[_0x5685e5(0x1bf)]+',\x20card:\x20****'+_0x56a734[_0x5685e5(0x17d)]+')'));}console[_0x5685e5(0x13e)]('🔍\x20VISA\x20payment\x20search\x20result:\x20'+(_0x108e1a?_0x5685e5(0x222):_0x5685e5(0x259))),_0x108e1a&&console[_0x5685e5(0x13e)](_0x5685e5(0x13d)+_0x108e1a['id']+_0x5685e5(0x1f3)+_0x108e1a['gateway']+_0x5685e5(0x1f4)+_0x108e1a['status']+_0x5685e5(0x1ad)+_0x108e1a['cardLast4']);}if(!_0x108e1a){console[_0x5685e5(0x230)]('❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20'+_0x45b5e5[_0x5685e5(0x1a7)]),loggerService_1['loggerService']['logWebhookError'](_0x5685e5(0x167),new Error(_0x5685e5(0x16f)+_0x45b5e5[_0x5685e5(0x1a7)]),_0xb79310);throw new Error(_0x5685e5(0x12c)+_0x45b5e5['paymentId']);}console[_0x5685e5(0x13e)](_0x5685e5(0x19b)+_0x108e1a['id']+_0x5685e5(0x158)+_0x108e1a['status']+_0x5685e5(0x214)+_0x45b5e5[_0x5685e5(0x1f7)]+')');const _0x3797a8={};_0x45b5e5[_0x5685e5(0x149)]&&await database_1['default']['payment'][_0x5685e5(0x20f)]({'where':{'id':_0x108e1a['id']},'data':{'amount':_0x45b5e5['amount'],'updatedAt':new Date()}}),_0x45b5e5['currency']&&await database_1[_0x5685e5(0x241)][_0x5685e5(0x146)]['update']({'where':{'id':_0x108e1a['id']},'data':{'currency':_0x45b5e5['currency'],'updatedAt':new Date()}}),_0x45b5e5[_0x5685e5(0x1f7)]==='FAILED'&&_0x45b5e5['errorMessage']&&(_0x3797a8[_0x5685e5(0x206)]=_0x45b5e5[_0x5685e5(0x1f9)],console[_0x5685e5(0x13e)](_0x5685e5(0x1c0)+_0x45b5e5[_0x5685e5(0x1f9)])),_0x3797a8[_0x5685e5(0x1ba)]=_0x5685e5(0x167),await this[_0x5685e5(0x12e)](_0x108e1a['id'],_0x45b5e5['status'],_0x3797a8),await database_1[_0x5685e5(0x241)][_0x5685e5(0x1a1)][_0x5685e5(0x215)]({'data':{'paymentId':_0x108e1a['id'],'shopId':_0x108e1a[_0x5685e5(0x143)],'event':_0x5685e5(0x1c7)+_0x45b5e5[_0x5685e5(0x1f7)][_0x5685e5(0x182)](),'statusCode':0xc8,'responseBody':JSON['stringify'](_0x45b5e5)}}),await this['sendPaymentStatusNotification'](_0x108e1a,_0x45b5e5[_0x5685e5(0x1f7)][_0x5685e5(0x227)]()),console['log'](_0x5685e5(0x233)+_0x108e1a['id']);}catch(_0x4e8ce9){console[_0x5685e5(0x230)](_0x5685e5(0x1aa),_0x4e8ce9),loggerService_1[_0x5685e5(0x15d)]['logWebhookError'](_0x5685e5(0x167),_0x4e8ce9,_0xb79310);throw _0x4e8ce9;}}async[a65_0x16fb31(0x147)](_0x344e63){const _0x4c473c=a65_0x16fb31;console[_0x4c473c(0x13e)]('🔄\x20Processing\x20MasterCard\x20webhook:',JSON[_0x4c473c(0x1d2)](_0x344e63,null,0x2));try{const _0x18d2c3=await this['visaMasterCardService']['processWebhook'](_0x344e63,'MASTERCARD');console[_0x4c473c(0x13e)](_0x4c473c(0x184),_0x18d2c3);if(!_0x18d2c3[_0x4c473c(0x1a7)]){console['error'](_0x4c473c(0x21a)),console[_0x4c473c(0x230)]('❌\x20Available\x20webhook\x20fields:',Object[_0x4c473c(0x1b1)](_0x344e63));throw new Error(_0x4c473c(0x24b));}let _0x456357=null;console[_0x4c473c(0x13e)](_0x4c473c(0x1fc)+_0x18d2c3[_0x4c473c(0x1a7)]);_0x18d2c3[_0x4c473c(0x1a7)]&&(console[_0x4c473c(0x13e)]('🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x456357=await database_1['default'][_0x4c473c(0x146)][_0x4c473c(0x24d)]({'where':{'AND':[{'OR':[{'gateway':_0x4c473c(0x253)},{'gateway':_0x4c473c(0x235)},{'gateway':_0x4c473c(0x187)}]},{'OR':[{'gatewayPaymentId':_0x18d2c3[_0x4c473c(0x1a7)]},{'gatewayOrderId':_0x18d2c3['paymentId']},{'id':_0x18d2c3[_0x4c473c(0x1a7)]},{'orderId':_0x18d2c3[_0x4c473c(0x1a7)]}]}]}}),console[_0x4c473c(0x13e)](_0x4c473c(0x23a)+(_0x456357?'Found\x20payment\x20'+_0x456357['id']:'Payment\x20not\x20found')));if(!_0x456357){console[_0x4c473c(0x230)](_0x4c473c(0x1c9)+_0x18d2c3[_0x4c473c(0x1a7)]),console[_0x4c473c(0x230)](_0x4c473c(0x17a)+_0x18d2c3['paymentId']+'\x22,\x20id=\x22'+_0x18d2c3['paymentId']+'\x22,\x20orderId=\x22'+_0x18d2c3['paymentId']+'\x22');const _0x15c7c0=await database_1['default']['payment'][_0x4c473c(0x20b)]({'where':{'OR':[{'gateway':'mastercard'},{'gateway':_0x4c473c(0x253)},{'gateway':'visa/mastercard'}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0x4c473c(0x21e)},'take':0xf});console[_0x4c473c(0x13e)](_0x4c473c(0x1c5),_0x15c7c0),loggerService_1[_0x4c473c(0x15d)][_0x4c473c(0x25a)]('mastercard',new Error('Payment\x20not\x20found:\x20'+_0x18d2c3[_0x4c473c(0x1a7)]),_0x344e63);throw new Error(_0x4c473c(0x18e)+_0x18d2c3[_0x4c473c(0x1a7)]);}console[_0x4c473c(0x13e)](_0x4c473c(0x195)+_0x456357['id']+_0x4c473c(0x23d)+_0x456357['status']+_0x4c473c(0x17c)+_0x18d2c3[_0x4c473c(0x1f7)]);const _0xaa48f8={};_0x18d2c3[_0x4c473c(0x149)]&&await database_1['default'][_0x4c473c(0x146)][_0x4c473c(0x20f)]({'where':{'id':_0x456357['id']},'data':{'amount':_0x18d2c3[_0x4c473c(0x149)],'updatedAt':new Date()}}),_0x18d2c3['currency']&&await database_1[_0x4c473c(0x241)]['payment'][_0x4c473c(0x20f)]({'where':{'id':_0x456357['id']},'data':{'currency':_0x18d2c3[_0x4c473c(0x14e)],'updatedAt':new Date()}}),_0x18d2c3[_0x4c473c(0x1f7)]===_0x4c473c(0x25f)&&_0x18d2c3[_0x4c473c(0x1f9)]&&(_0xaa48f8['failureMessage']=_0x18d2c3[_0x4c473c(0x1f9)],console[_0x4c473c(0x13e)](_0x4c473c(0x12b)+_0x18d2c3['errorMessage'])),_0xaa48f8[_0x4c473c(0x1ba)]='mastercard',await this[_0x4c473c(0x12e)](_0x456357['id'],_0x18d2c3[_0x4c473c(0x1f7)],_0xaa48f8),loggerService_1['loggerService'][_0x4c473c(0x1a0)](_0x4c473c(0x235),_0x456357['id'],_0x456357[_0x4c473c(0x1f7)],_0x18d2c3[_0x4c473c(0x1f7)],_0x344e63);}catch(_0x5f1f0a){console['error'](_0x4c473c(0x24f),_0x5f1f0a),loggerService_1[_0x4c473c(0x15d)]['logWebhookError'](_0x4c473c(0x235),_0x5f1f0a,_0x344e63);throw _0x5f1f0a;}}async[a65_0x16fb31(0x172)](_0x4ab927){const _0x1501dc=a65_0x16fb31;console[_0x1501dc(0x13e)](_0x1501dc(0x1cf),JSON[_0x1501dc(0x1d2)](_0x4ab927,null,0x2));try{const _0x279a2c=await this[_0x1501dc(0x1cd)][_0x1501dc(0x141)](_0x4ab927);console['log'](_0x1501dc(0x157),_0x279a2c);if(!_0x279a2c[_0x1501dc(0x1a7)]){console[_0x1501dc(0x230)](_0x1501dc(0x1d3)),console['error'](_0x1501dc(0x148),Object[_0x1501dc(0x1b1)](_0x4ab927));throw new Error(_0x1501dc(0x1a3));}let _0x4c3472=null;console[_0x1501dc(0x13e)](_0x1501dc(0x256)+_0x279a2c[_0x1501dc(0x1a7)]),_0x4c3472=await database_1['default'][_0x1501dc(0x146)][_0x1501dc(0x24d)]({'where':{'AND':[{'gateway':_0x1501dc(0x135)},{'OR':[{'gatewayPaymentId':_0x279a2c[_0x1501dc(0x1a7)]},{'gatewayOrderId':_0x279a2c[_0x1501dc(0x1a7)]},{'id':_0x279a2c['paymentId']},{'orderId':_0x279a2c['paymentId']}]}]}}),console[_0x1501dc(0x13e)](_0x1501dc(0x23a)+(_0x4c3472?_0x1501dc(0x138)+_0x4c3472['id']:_0x1501dc(0x14a)));if(!_0x4c3472){console[_0x1501dc(0x230)]('❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20'+_0x279a2c[_0x1501dc(0x1a7)]);return;}console[_0x1501dc(0x13e)](_0x1501dc(0x217)+_0x4c3472['id']+_0x1501dc(0x16c)+_0x279a2c[_0x1501dc(0x1f7)]),await this[_0x1501dc(0x12e)](_0x4c3472['id'],_0x279a2c[_0x1501dc(0x1f7)],{'cardLast4':_0x279a2c['additionalInfo']?.[_0x1501dc(0x17d)],'paymentMethod':_0x279a2c[_0x1501dc(0x1cc)]?.[_0x1501dc(0x1ba)]});}catch(_0x3e26dd){console[_0x1501dc(0x230)](_0x1501dc(0x224),_0x3e26dd),loggerService_1[_0x1501dc(0x15d)][_0x1501dc(0x25a)]('amer',_0x3e26dd,_0x4ab927);throw _0x3e26dd;}}async[a65_0x16fb31(0x1ff)](_0x1c3b2e){const _0x19f124=a65_0x16fb31;console['log']('🔄\x20Processing\x20AmPay\x20webhook:',JSON[_0x19f124(0x1d2)](_0x1c3b2e,null,0x2));try{const _0x29b5c1=_0x1c3b2e[_0x19f124(0x1f7)],_0xe3679a=_0x1c3b2e[_0x19f124(0x173)],_0x1343e8=_0x1c3b2e[_0x19f124(0x171)],_0x595c2a=_0x1c3b2e[_0x19f124(0x1a6)],_0x3edac9=_0x1c3b2e[_0x19f124(0x149)],_0x1c6730=_0x1c3b2e[_0x19f124(0x14e)],_0x2a5b2b=_0x1c3b2e[_0x19f124(0x1bc)],_0xc98ae8=_0x1c3b2e[_0x19f124(0x177)];if(!_0xe3679a){console['error']('❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook');throw new Error('Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook');}console[_0x19f124(0x13e)](_0x19f124(0x203),{'status':_0x29b5c1,'clientTransactionId':_0xe3679a,'systemId':_0x1343e8,'paymentMethod':_0x595c2a,'amount':_0x3edac9,'currency':_0x1c6730,'commission':_0x2a5b2b,'statusAdditionInfo':_0xc98ae8});const _0xcfcf6c=await database_1['default'][_0x19f124(0x146)][_0x19f124(0x24d)]({'where':{'OR':[{'gatewayOrderId':_0xe3679a},{'orderId':_0xe3679a},{'id':_0xe3679a},{'gatewayPaymentId':_0xe3679a}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0xcfcf6c){console[_0x19f124(0x230)](_0x19f124(0x20d)+_0xe3679a);throw new Error(_0x19f124(0x16f)+_0xe3679a);}console[_0x19f124(0x13e)]('✅\x20Found\x20payment\x20'+_0xcfcf6c['id']+_0x19f124(0x22e)),console[_0x19f124(0x13e)](_0x19f124(0x144)+_0xcfcf6c['status']+_0x19f124(0x214)+_0x29b5c1),_0x29b5c1===_0x19f124(0x237)?(console[_0x19f124(0x13e)]('🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED'),await this[_0x19f124(0x12e)](_0xcfcf6c['id'],_0x19f124(0x25f)),console[_0x19f124(0x13e)](_0x19f124(0x211)+_0xcfcf6c['id']+_0x19f124(0x194)),console[_0x19f124(0x13e)](_0x19f124(0x21c)+(_0xc98ae8||_0x19f124(0x130)))):console[_0x19f124(0x13e)]('ℹ️\x20AmPay\x20status\x20'+_0x29b5c1+_0x19f124(0x213)),await database_1[_0x19f124(0x241)][_0x19f124(0x1a1)][_0x19f124(0x215)]({'data':{'paymentId':_0xcfcf6c['id'],'shopId':_0xcfcf6c[_0x19f124(0x143)],'event':_0x19f124(0x234)+(_0x29b5c1?.['toLowerCase']()||_0x19f124(0x1b7)),'statusCode':0xc8,'responseBody':JSON[_0x19f124(0x1d2)](_0x1c3b2e)}}),loggerService_1['loggerService'][_0x19f124(0x1a0)](_0x19f124(0x240),_0xcfcf6c['id'],_0xcfcf6c[_0x19f124(0x1f7)],_0x29b5c1==='DECLINED'?_0x19f124(0x25f):_0x29b5c1,_0x1c3b2e);}catch(_0x3065ff){console[_0x19f124(0x230)](_0x19f124(0x16a),_0x3065ff),loggerService_1[_0x19f124(0x15d)][_0x19f124(0x25a)](_0x19f124(0x240),_0x3065ff,_0x1c3b2e);throw _0x3065ff;}}async['processAmPayTRYWebhook'](_0x2261d9){const _0x497801=a65_0x16fb31;console['log'](_0x497801(0x1bd),JSON['stringify'](_0x2261d9,null,0x2));try{const _0x490cd5=_0x2261d9['status'],_0x58207a=_0x2261d9[_0x497801(0x173)],_0x507523=_0x2261d9['system_id'],_0x458a4f=_0x2261d9[_0x497801(0x1a6)],_0x9bc8f6=_0x2261d9[_0x497801(0x149)],_0x5d3968=_0x2261d9[_0x497801(0x14e)],_0x3fda0d=_0x2261d9[_0x497801(0x1bc)],_0x2ae399=_0x2261d9[_0x497801(0x177)];if(!_0x58207a){console['error'](_0x497801(0x19d));throw new Error('Missing\x20client_transaction_id\x20in\x20AmPay\x20TRY\x20webhook');}console[_0x497801(0x13e)](_0x497801(0x22f),{'status':_0x490cd5,'clientTransactionId':_0x58207a,'systemId':_0x507523,'paymentMethod':_0x458a4f,'amount':_0x9bc8f6,'currency':_0x5d3968,'commission':_0x3fda0d,'statusAdditionInfo':_0x2ae399});const _0x4a8ee5=await database_1[_0x497801(0x241)][_0x497801(0x146)][_0x497801(0x24d)]({'where':{'OR':[{'gatewayOrderId':_0x58207a},{'orderId':_0x58207a},{'id':_0x58207a},{'gatewayPaymentId':_0x58207a}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x4a8ee5){console['error'](_0x497801(0x232)+_0x58207a);throw new Error(_0x497801(0x16f)+_0x58207a);}console['log'](_0x497801(0x195)+_0x4a8ee5['id']+_0x497801(0x248)),console[_0x497801(0x13e)](_0x497801(0x144)+_0x4a8ee5[_0x497801(0x1f7)]+_0x497801(0x214)+_0x490cd5),_0x490cd5===_0x497801(0x237)?(console[_0x497801(0x13e)]('🔄\x20AmPay\x20TRY\x20status\x20DECLINED\x20mapped\x20to\x20FAILED'),await this[_0x497801(0x12e)](_0x4a8ee5['id'],_0x497801(0x25f)),console[_0x497801(0x13e)](_0x497801(0x1b9)+_0x4a8ee5['id']+_0x497801(0x194)),console[_0x497801(0x13e)]('ℹ️\x20Decline\x20reason:\x20'+(_0x2ae399||_0x497801(0x130)))):console[_0x497801(0x13e)](_0x497801(0x219)+_0x490cd5+'\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)'),await database_1[_0x497801(0x241)][_0x497801(0x1a1)][_0x497801(0x215)]({'data':{'paymentId':_0x4a8ee5['id'],'shopId':_0x4a8ee5[_0x497801(0x143)],'event':_0x497801(0x1f1)+(_0x490cd5?.[_0x497801(0x182)]()||_0x497801(0x1b7)),'statusCode':0xc8,'responseBody':JSON[_0x497801(0x1d2)](_0x2261d9)}}),loggerService_1[_0x497801(0x15d)]['logWebhookProcessed'](_0x497801(0x196),_0x4a8ee5['id'],_0x4a8ee5[_0x497801(0x1f7)],_0x490cd5===_0x497801(0x237)?_0x497801(0x25f):_0x490cd5,_0x2261d9);}catch(_0x2d396a){console[_0x497801(0x230)](_0x497801(0x18c),_0x2d396a),loggerService_1['loggerService']['logWebhookError'](_0x497801(0x196),_0x2d396a,_0x2261d9);throw _0x2d396a;}}async[a65_0x16fb31(0x176)](_0x34bb99,_0x427fa3){const _0x452819=a65_0x16fb31,_0x9666aa=Date['now']();try{const _0x1d0e16=_0x34bb99[_0x452819(0x1e4)],_0x2b3e17=_0x1d0e16[_0x452819(0x18b)];if(!_0x2b3e17?.['webhookUrl']){console[_0x452819(0x13e)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1d0e16['id']);return;}const _0x3cf4e3=_0x427fa3===_0x452819(0x22b)?_0x452819(0x202):_0x427fa3===_0x452819(0x25f)?_0x452819(0x1df):_0x427fa3===_0x452819(0x244)?_0x452819(0x1df):_0x427fa3===_0x452819(0x17e)?_0x452819(0x1df):_0x427fa3===_0x452819(0x186)?_0x452819(0x1df):'payment.pending';let _0x93700e=[];if(_0x2b3e17[_0x452819(0x207)])try{_0x93700e=Array[_0x452819(0x1de)](_0x2b3e17[_0x452819(0x207)])?_0x2b3e17['webhookEvents']:JSON[_0x452819(0x1e5)](_0x2b3e17[_0x452819(0x207)]);}catch(_0x1256c1){console[_0x452819(0x230)]('Error\x20parsing\x20webhook\x20events:',_0x1256c1),_0x93700e=[];}if(!_0x93700e['includes'](_0x3cf4e3)){console['log'](_0x452819(0x226)+_0x3cf4e3+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1d0e16['id']);return;}const _0x59e965={'event':_0x3cf4e3,'payment':{'id':_0x34bb99['id'],'order_id':_0x34bb99[_0x452819(0x218)],'gateway_order_id':_0x34bb99[_0x452819(0x127)],'gateway':_0x34bb99[_0x452819(0x15e)],'amount':_0x34bb99['amount'],'currency':_0x34bb99[_0x452819(0x14e)],'status':_0x427fa3[_0x452819(0x182)](),'customer_email':_0x34bb99[_0x452819(0x1c2)],'customer_name':_0x34bb99[_0x452819(0x1c3)],'failure_message':_0x34bb99[_0x452819(0x206)],'tx_urls':_0x34bb99[_0x452819(0x1b0)]?JSON[_0x452819(0x1e5)](_0x34bb99[_0x452819(0x1b0)]):null,'created_at':_0x34bb99[_0x452819(0x179)],'updated_at':_0x34bb99['updatedAt']}},_0x3fc88e=await fetch(_0x2b3e17[_0x452819(0x181)],{'method':_0x452819(0x154),'headers':{'Content-Type':_0x452819(0x1d0),'User-Agent':'Payment\x20System/1.0'},'body':JSON[_0x452819(0x1d2)](_0x59e965)}),_0x44a5bc=Date['now']()-_0x9666aa,_0x19c583=_0x3fc88e['ok']?'Success':await _0x3fc88e['text']();loggerService_1[_0x452819(0x15d)][_0x452819(0x125)](_0x34bb99[_0x452819(0x143)],_0x2b3e17[_0x452819(0x181)],_0x3cf4e3,_0x3fc88e['status'],_0x44a5bc,_0x59e965),console['log'](_0x452819(0x197)+_0x2b3e17[_0x452819(0x181)]+'\x20with\x20status\x20'+_0x3fc88e[_0x452819(0x1f7)]+'\x20('+_0x44a5bc+_0x452819(0x1af));}catch(_0x246e6b){console[_0x452819(0x230)](_0x452819(0x1f0),_0x246e6b),loggerService_1[_0x452819(0x15d)][_0x452819(0x252)](_0x34bb99[_0x452819(0x143)],_0x34bb99['shop']?.[_0x452819(0x18b)]?.[_0x452819(0x181)]||_0x452819(0x1b7),_0x452819(0x168),_0x246e6b,{});}}async[a65_0x16fb31(0x20e)](_0x1eb6dd,_0x3b8e7b){const _0x4afaf1=a65_0x16fb31;try{const _0xe356be={'PENDING':_0x4afaf1(0x193),'PROCESSING':_0x4afaf1(0x1e9),'PAID':_0x4afaf1(0x25c),'FAILED':_0x4afaf1(0x192),'EXPIRED':_0x4afaf1(0x236),'REFUND':'refund','CHARGEBACK':_0x4afaf1(0x1ef)},_0x150e50=_0xe356be[_0x3b8e7b];if(!_0x150e50||_0x150e50===_0x4afaf1(0x193))return;await telegramBotService_1[_0x4afaf1(0x13f)][_0x4afaf1(0x16d)](_0x1eb6dd[_0x4afaf1(0x143)],_0x1eb6dd,_0x150e50);}catch(_0x3fba99){console[_0x4afaf1(0x230)](_0x4afaf1(0x200),_0x3fba99);}}async[a65_0x16fb31(0x1e7)](_0x55a8a1,_0x1a8746){const _0x29ca5c=a65_0x16fb31;try{const _0x1cdd60=await database_1[_0x29ca5c(0x241)][_0x29ca5c(0x1e4)]['findUnique']({'where':{'id':_0x55a8a1},'select':{'gatewaySettings':!![]}});if(!_0x1cdd60?.['gatewaySettings'])return console[_0x29ca5c(0x13e)](_0x29ca5c(0x1d9)+_0x55a8a1+_0x29ca5c(0x199)),0xa;const _0x132cfd=JSON[_0x29ca5c(0x1e5)](_0x1cdd60[_0x29ca5c(0x242)]);for(const [_0x13341b,_0x27257e]of Object[_0x29ca5c(0x24a)](_0x132cfd)){if(_0x13341b[_0x29ca5c(0x182)]()===_0x1a8746[_0x29ca5c(0x182)]()){const _0x240c20=_0x27257e['commission']||0xa;return console[_0x29ca5c(0x13e)]('Gateway\x20'+_0x1a8746+'\x20commission\x20for\x20shop\x20'+_0x55a8a1+':\x20'+_0x240c20+'%'),_0x240c20;}}return console[_0x29ca5c(0x13e)](_0x29ca5c(0x131)+_0x1a8746+'\x20in\x20shop\x20'+_0x55a8a1+_0x29ca5c(0x189)),0xa;}catch(_0x9af77b){return console[_0x29ca5c(0x230)](_0x29ca5c(0x153)+_0x55a8a1+_0x29ca5c(0x17b)+_0x1a8746+':',_0x9af77b),0xa;}}async[a65_0x16fb31(0x1b6)](_0x2c1417,_0x1193cf){const _0x20a13b=a65_0x16fb31;console[_0x20a13b(0x13e)]('🔄\x20Processing\x20MyXSpend\x20webhook:'),console[_0x20a13b(0x13e)](_0x20a13b(0x190),JSON[_0x20a13b(0x1d2)](_0x2c1417,null,0x2)),console[_0x20a13b(0x13e)](_0x20a13b(0x210),JSON[_0x20a13b(0x1d2)](_0x1193cf,null,0x2));try{const _0xba7306=_0x2c1417[_0x20a13b(0x1a2)]||_0x1193cf[_0x20a13b(0x1a2)],_0x2b5783=_0x2c1417[_0x20a13b(0x1f7)]||_0x1193cf[_0x20a13b(0x1f7)],_0x3f302e=_0x2c1417[_0x20a13b(0x149)]||_0x1193cf[_0x20a13b(0x149)],_0x256e2c=_0x2c1417[_0x20a13b(0x14e)]||_0x1193cf['currency'],_0x31703c=_0x2c1417[_0x20a13b(0x1d8)]||_0x1193cf['dateTime'];if(!_0xba7306){console[_0x20a13b(0x230)](_0x20a13b(0x262));throw new Error(_0x20a13b(0x258));}console[_0x20a13b(0x13e)](_0x20a13b(0x185),{'customerOrderId':_0xba7306,'status':_0x2b5783,'amount':_0x3f302e,'currency':_0x256e2c,'dateTime':_0x31703c});const _0x349f95=await database_1[_0x20a13b(0x241)][_0x20a13b(0x146)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0xba7306},{'orderId':_0xba7306},{'id':_0xba7306},{'gatewayPaymentId':_0xba7306}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x349f95){console[_0x20a13b(0x230)](_0x20a13b(0x12d)+_0xba7306);throw new Error(_0x20a13b(0x16f)+_0xba7306);}console['log'](_0x20a13b(0x195)+_0x349f95['id']+_0x20a13b(0x1b5)),console[_0x20a13b(0x13e)](_0x20a13b(0x144)+_0x349f95[_0x20a13b(0x1f7)]+_0x20a13b(0x214)+_0x2b5783);let _0x57632e=_0x2b5783?.[_0x20a13b(0x227)]();_0x2b5783==='FAILED'||_0x2b5783===_0x20a13b(0x244)?(_0x57632e='FAILED',console['log'](_0x20a13b(0x140)+_0x2b5783+_0x20a13b(0x1e8)),await this['updatePaymentStatus'](_0x349f95['id'],_0x57632e),console['log']('✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20'+_0x349f95['id']+_0x20a13b(0x194))):console['log'](_0x20a13b(0x24c)+_0x2b5783+_0x20a13b(0x19c)),await database_1[_0x20a13b(0x241)][_0x20a13b(0x1a1)][_0x20a13b(0x215)]({'data':{'paymentId':_0x349f95['id'],'shopId':_0x349f95['shopId'],'event':'myxspend_'+(_0x2b5783?.[_0x20a13b(0x182)]()||'unknown'),'statusCode':0xc8,'responseBody':JSON[_0x20a13b(0x1d2)]({'queryParams':_0x2c1417,'bodyData':_0x1193cf})}}),loggerService_1[_0x20a13b(0x15d)][_0x20a13b(0x1a0)]('myxspend',_0x349f95['id'],_0x349f95[_0x20a13b(0x1f7)],_0x57632e||_0x2b5783,{'queryParams':_0x2c1417,'bodyData':_0x1193cf});}catch(_0x345f82){console[_0x20a13b(0x230)]('❌\x20Error\x20processing\x20MyXSpend\x20webhook:',_0x345f82),loggerService_1[_0x20a13b(0x15d)]['logWebhookError'](_0x20a13b(0x1be),_0x345f82,{'queryParams':_0x2c1417,'bodyData':_0x1193cf});throw _0x345f82;}}}function a65_0x4a05(){const _0x3920ca=['❌\x20Payment\x20link\x20','remitterIban','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','./gateways/mastercardService','remitterName','chargeback','Failed\x20to\x20send\x20shop\x20webhook:','ampay_try_','./gateways/amerService',',\x20Gateway=',',\x20Status=','cointopay2','gatewayCommissionRate','status','🔄\x20Processing\x20CoinToPay2\x20webhook:','errorMessage','visaMasterCardService','\x20balance\x20updated:\x20','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20(orderId:\x20','💸\x20Additional\x20chargeback\x20penalty:\x20-','processAmPayWebhook','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','__esModule','payment.success','📊\x20AmPay\x20webhook\x20data:','📊\x20VISA\x20webhook\x20result:','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','failureMessage','webhookEvents','\x22,\x20newStatus=\x22','AmPayService','48141ilsHsZ','findMany','ampayTRYService','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','sendPaymentStatusNotification','update','Body\x20data:','✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20','processPlisioGatewayWebhook','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','\x20→\x20','create','plisioService','📊\x20Amer\x20webhook:\x20Payment\x20','orderId','ℹ️\x20AmPay\x20TRY\x20status\x20','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','cointopay','ℹ️\x20Decline\x20reason:\x20','plisio','desc','processCoinToPayWebhook','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','📊\x20Rapyd\x20webhook:\x20Payment\x20','Found','./telegramBotService','❌\x20Error\x20processing\x20Amer\x20webhook:','253224owjsSE','Webhook\x20event\x20','toUpperCase','\x20not\x20found','354546MgocrX','💰\x20Amount\x20after\x20gateway\x20commission:\x20','PAID','plisio_gateway','klymeService','\x20for\x20AmPay\x20webhook','📊\x20AmPay\x20TRY\x20webhook\x20data:','error','📊\x20CoinToPay\x20webhook:\x20Payment\x20','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20TRY\x20client_transaction_id:\x20','✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20','ampay_','mastercard','expired','DECLINED','💰\x20Removing\x20from\x20balance:\x20','./gateways/nodaService','🔍\x20Search\x20result:\x20','map','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','Error\x20processing\x20KLYME\x20webhook:','ampay','default','gatewaySettings','Error\x20processing\x20Plisio\x20webhook:','EXPIRED','ampayService','./gateways/coinToPay2Service','amountUSDT','\x20for\x20AmPay\x20TRY\x20webhook','rapydService','entries','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','ℹ️\x20MyXSpend\x20status\x20','findFirst','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','❌\x20Error\x20processing\x20MasterCard\x20webhook:','1460fEtZDe','17688KYQvqY','logShopWebhookError','visa_mastercard',',\x20currentPayments=','convertToUSDT','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','webhook_status_change_','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','Not\x20found','logWebhookError','../config/database','paid','🔄\x20Processing\x20VISA\x20webhook:','RapydService','FAILED','./gateways/ampayTRYService','amountAfterGatewayCommissionUSDT','❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook','No\x20payment\x20ID\x20in\x20Noda\x20webhook','logShopWebhookSent','2353184YDIaIM','gatewayOrderId','💰\x20Converting\x20','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','processKlymeWebhook','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','VISA\x20payment\x20not\x20found:\x20','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','updatePaymentStatus','503894TSRLzT','No\x20additional\x20info','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','AmerService','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','💰\x20Payment\x20','amer','203rykEHG','$transaction','Found\x20payment\x20','KlymeService','\x20=\x20','📊\x20KLYME\x20webhook:\x20Payment\x20','📊\x20Noda\x20webhook:\x20Payment\x20','🔍\x20Found\x20VISA\x20payment:\x20ID=','log','telegramBotService','🔄\x20MyXSpend\x20status\x20','processWebhook','💰\x20Final\x20balance\x20after\x20chargeback:\x20','shopId','📊\x20Payment\x20status:\x20',',\x20status=','payment','processMasterCardWebhook','❌\x20Available\x20webhook\x20fields:','amount','Payment\x20not\x20found','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','1007204DkrFCD','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','currency','toFixed','bankId','currentPayments','processNodaWebhook','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','POST','SINGLE','./gateways/ampayService','📊\x20Amer\x20webhook\x20result:','\x20(Status:\x20','\x20updated:\x20currentPayments=',',\x20gatewayPaymentId:\x20','./currencyService','coinToPayService','loggerService','gateway','5pSwTEm','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','klyme','CoinToPay2Service','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','CoinToPayService','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','\x20and\x20-','visa','webhook_send',',\x20GatewayOrderId=','❌\x20Error\x20processing\x20AmPay\x20webhook:','noda','\x20status\x20','sendPaymentNotification','type','Payment\x20not\x20found:\x20',',\x20GatewayPaymentId=','system_id','processAmerWebhook','client_transaction_id','\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId','paymentLink','sendShopWebhook','status_addition_info','coinToPay2Service','createdAt','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22',',\x20gateway\x20','\x20to\x20','cardLast4','CHARGEBACK','🔄\x20Processing\x20Rapyd\x20webhook:','Error\x20processing\x20CoinToPay2\x20webhook:','webhookUrl','toLowerCase','🔄\x20Processing\x20Plisio\x20webhook:','📊\x20MasterCard\x20webhook\x20result:','📊\x20MyXSpend\x20webhook\x20data:','REFUND','visa/mastercard','chargebackAmount',',\x20using\x20default\x2010%','\x22,\x20paymentLinkId=\x22','settings','❌\x20Error\x20processing\x20AmPay\x20TRY\x20webhook:','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','MasterCard\x20payment\x20not\x20found:\x20','nodaService','Query\x20params:','PlisioService','failed','created','\x20status\x20updated\x20to\x20FAILED','✅\x20Found\x20payment\x20','ampay_try','📤\x20Shop\x20webhook\x20sent\x20to\x20','\x20USDT\x20(chargeback\x20penalty)',',\x20using\x20default\x20commission\x2010%','./loggerService','📊\x20VISA\x20payment\x20found:\x20','\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20TRY\x20webhook',':\x20type=','findUnique','logWebhookProcessed','webhookLog','customerOrderId','No\x20payment\x20ID\x20in\x20Amer\x20webhook','Error\x20processing\x20Noda\x20webhook:','%\x20gateway\x20commission)','payment_method','paymentId','\x20-\x20','🏪\x20Shop\x20','❌\x20VISA\x20webhook\x20processing\x20failed:','currencyService','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20',',\x20Card=****','🔄\x20Additional\x20data:','ms)','txUrls','keys','system','balance','WebhookService','\x20for\x20MyXSpend\x20webhook','processMyXSpendWebhook','unknown','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','✅\x20AmPay\x20TRY\x20webhook\x20processed:\x20Payment\x20','paymentMethod','✅\x20Found\x20payment:\x20ID=','commission','🔄\x20Processing\x20AmPay\x20TRY\x20webhook:','myxspend','gatewayPaymentId','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','📈\x20Payment\x20','customerEmail','customerName',',\x20gatewayOrderId:\x20','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','username','visa_','processRapydWebhook','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','__importDefault','\x20->\x20','additionalInfo','amerService','📝\x20Reason:\x20','🔄\x20Processing\x20Amer\x20webhook:','application/json','\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard','stringify','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','Error\x20processing\x20Rapyd\x20webhook:','toISOString','./gateways/rapydService','COMPLETED','dateTime','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','NodaService','✅\x20Shop\x20','paidAt','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','isArray','payment.failed','./gateways/plisioService','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','paymentLinkId','\x20USDT','shop','parse','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','getGatewayCommission','\x20mapped\x20to\x20FAILED','processing'];a65_0x4a05=function(){return _0x3920ca;};return a65_0x4a05();}exports[a65_0x16fb31(0x1b4)]=WebhookService;