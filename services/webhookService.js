'use strict';function a55_0x2b16(_0x393808,_0xa58bad){const _0x5828e9=a55_0x5828();return a55_0x2b16=function(_0x2b1659,_0x5e79aa){_0x2b1659=_0x2b1659-0xfc;let _0x2bfd5b=_0x5828e9[_0x2b1659];return _0x2bfd5b;},a55_0x2b16(_0x393808,_0xa58bad);}const a55_0x192d6e=a55_0x2b16;(function(_0x1606d8,_0x17047e){const _0x1abe95=a55_0x2b16,_0x27e97a=_0x1606d8();while(!![]){try{const _0x58178a=parseInt(_0x1abe95(0x147))/0x1+parseInt(_0x1abe95(0x157))/0x2*(parseInt(_0x1abe95(0x110))/0x3)+-parseInt(_0x1abe95(0x151))/0x4+parseInt(_0x1abe95(0x17a))/0x5*(parseInt(_0x1abe95(0x165))/0x6)+parseInt(_0x1abe95(0x140))/0x7*(parseInt(_0x1abe95(0x117))/0x8)+parseInt(_0x1abe95(0x145))/0x9+-parseInt(_0x1abe95(0x11f))/0xa;if(_0x58178a===_0x17047e)break;else _0x27e97a['push'](_0x27e97a['shift']());}catch(_0x281f6c){_0x27e97a['push'](_0x27e97a['shift']());}}}(a55_0x5828,0x2e55a));function a55_0x5828(){const _0x1b03f1=['./paymentLinkService','\x20status\x20change:\x20','sendShopWebhook','ðŸ’¾\x20Failure\x20message\x20saved:\x20','processWebhook','webhook_send','No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook','additionalInfo','ðŸ’¾\x20Saving\x20failure\x20message:\x20','processPlisioGatewayWebhook','created','./loggerService','No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook','Failed\x20to\x20update\x20payment\x20link\x20counter:','PENDING','\x20status\x20to\x20','NodaService','settings','\x20->\x20','processPlisioWebhook','now','currency','klyme_','cointopay','status','./gateways/nodaService','parse','createdAt','loggerService','No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook','Processing\x20Rapyd\x20webhook:','bankId','Error\x20processing\x20Plisio\x20webhook:','processCoinToPayWebhook','3YiNrUD','coinToPayService','rapyd','txUrls','findFirst','ðŸ”„\x20Updating\x20payment\x20','plisioService','8yTFLtG','_webhook_','logShopWebhookError','./telegramBotService','gatewayOrderId','plisio_gateway','processKlymeWebhook','unknown','7401670KdofDD','Processing\x20Plisio\x20webhook:','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','nodaService','create','toLowerCase','../config/database','Processing\x20CoinToPay\x20webhook:','payment.pending','CoinToPayService','remitterIban','log','Failed\x20to\x20send\x20shop\x20webhook:','Error\x20processing\x20Rapyd\x20webhook:','klymeService','Webhook\x20event\x20','RapydService','shop','stringify','\x20not\x20enabled\x20for\x20shop\x20','Processing\x20Noda\x20webhook:','Processing\x20Plisio\x20Gateway\x20webhook:','\x20with\x20status\x20','âœ…\x20Payment\x20','__esModule','\x20updated\x20successfully:\x20','\x20failure\x20message:\x20','paymentId','\x20webhook','paymentLinkService','logShopWebhookSent','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook','failureMessage','2200128LaktmG','Error\x20processing\x20CoinToPay\x20webhook:','noda','\x20and\x20gateway:\x20','webhookUrl','1776204IygLPp','paid','118962onvhbz','./gateways/rapydService','customerEmail','TesSoft\x20Payment\x20System/1.0','No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook','payment','shopId','default','error','616380ffgudP','WebhookService','\x20URLs','Error\x20processing\x20KLYME\x20webhook:','webhookEvents','\x20status\x20unchanged\x20(','231958xkMwEA','Error\x20parsing\x20tx_urls\x20for\x20webhook:','logWebhookError','customerName','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','PAID','POST','Error\x20parsing\x20webhook\x20events:','paidAt','ðŸ”—\x20Payment\x20','payment.failed','rapydService','amount','Payment\x20','66JPurun','isArray','paymentMethod','\x20transaction\x20URLs:','webhookLog','klyme_eu','EXPIRED','logWebhookProcessed','processNodaWebhook','orderId','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','remitterName','updatePaymentStatus','region','application/json','text','ðŸ’¥\x20Payment\x20','PlisioService','payment.success','./gateways/plisioService','sendPaymentStatusNotification','153385vRcspY','ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20','cardLast4','failed','Processing\x20KLYME\x20webhook:','klyme','plisio','\x20from\x20'];a55_0x5828=function(){return _0x1b03f1;};return a55_0x5828();}var __importDefault=this&&this['__importDefault']||function(_0x2bdf9){const _0x165b9c=a55_0x2b16;return _0x2bdf9&&_0x2bdf9[_0x165b9c(0x137)]?_0x2bdf9:{'default':_0x2bdf9};};Object['defineProperty'](exports,a55_0x192d6e(0x137),{'value':!![]}),exports[a55_0x192d6e(0x152)]=void 0x0;const database_1=__importDefault(require(a55_0x192d6e(0x125))),plisioService_1=require(a55_0x192d6e(0x178)),rapydService_1=require(a55_0x192d6e(0x148)),nodaService_1=require(a55_0x192d6e(0x107)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require('./gateways/klymeService'),telegramBotService_1=require(a55_0x192d6e(0x11a)),paymentLinkService_1=require(a55_0x192d6e(0x182)),loggerService_1=require(a55_0x192d6e(0x18d));class WebhookService{constructor(){const _0x11ec36=a55_0x192d6e;this['plisioService']=new plisioService_1[(_0x11ec36(0x176))](),this[_0x11ec36(0x162)]=new rapydService_1[(_0x11ec36(0x12f))](),this['nodaService']=new nodaService_1[(_0x11ec36(0xfe))](),this['coinToPayService']=new coinToPayService_1[(_0x11ec36(0x128))](),this[_0x11ec36(0x12d)]=new klymeService_1['KlymeService'](),this[_0x11ec36(0x13c)]=new paymentLinkService_1['PaymentLinkService']();}async[a55_0x192d6e(0x101)](_0x3e6b87){const _0x592692=a55_0x192d6e;console[_0x592692(0x12a)](_0x592692(0x120),_0x3e6b87);try{const _0x4c6c5b=await this[_0x592692(0x116)]['processWebhook'](_0x3e6b87);if(!_0x4c6c5b[_0x592692(0x13a)]){console['error'](_0x592692(0x14c));return;}await this[_0x592692(0x171)](_0x4c6c5b[_0x592692(0x13a)],_0x4c6c5b[_0x592692(0x106)],_0x592692(0x180),_0x3e6b87,undefined,undefined,_0x4c6c5b[_0x592692(0x113)]),loggerService_1[_0x592692(0x10a)]['logWebhookProcessed'](_0x592692(0x180),_0x4c6c5b[_0x592692(0x13a)],_0x592692(0xfc),_0x4c6c5b[_0x592692(0x106)],_0x3e6b87);}catch(_0x3708be){console[_0x592692(0x150)](_0x592692(0x10e),_0x3708be),loggerService_1[_0x592692(0x10a)][_0x592692(0x159)](_0x592692(0x180),_0x3708be,_0x3e6b87);throw _0x3708be;}}async[a55_0x192d6e(0x18b)](_0x446226){const _0xe58184=a55_0x192d6e;console[_0xe58184(0x12a)](_0xe58184(0x134),_0x446226);try{const _0x48aa37=await this[_0xe58184(0x116)][_0xe58184(0x186)](_0x446226);if(!_0x48aa37[_0xe58184(0x13a)]){console['error'](_0xe58184(0x13e));return;}await this[_0xe58184(0x171)](_0x48aa37[_0xe58184(0x13a)],_0x48aa37[_0xe58184(0x106)],_0xe58184(0x180),_0x446226,undefined,undefined,_0x48aa37['txUrls']),loggerService_1['loggerService'][_0xe58184(0x16c)](_0xe58184(0x11c),_0x48aa37[_0xe58184(0x13a)],_0xe58184(0xfc),_0x48aa37[_0xe58184(0x106)],_0x446226);}catch(_0x5a2a3d){console['error'](_0xe58184(0x16f),_0x5a2a3d),loggerService_1[_0xe58184(0x10a)][_0xe58184(0x159)](_0xe58184(0x11c),_0x5a2a3d,_0x446226);throw _0x5a2a3d;}}async['processRapydWebhook'](_0x2a42e9){const _0x5dcb24=a55_0x192d6e;console[_0x5dcb24(0x12a)](_0x5dcb24(0x10c),_0x2a42e9);try{const _0x565b70=await this[_0x5dcb24(0x162)]['processWebhook'](_0x2a42e9);if(!_0x565b70['paymentId']){console[_0x5dcb24(0x150)](_0x5dcb24(0x14b));return;}await this[_0x5dcb24(0x171)](_0x565b70[_0x5dcb24(0x13a)],_0x565b70[_0x5dcb24(0x106)],_0x5dcb24(0x112),_0x2a42e9,_0x565b70[_0x5dcb24(0x13f)],_0x565b70['additionalInfo']),loggerService_1[_0x5dcb24(0x10a)]['logWebhookProcessed'](_0x5dcb24(0x112),_0x565b70[_0x5dcb24(0x13a)],_0x5dcb24(0xfc),_0x565b70[_0x5dcb24(0x106)],_0x2a42e9);}catch(_0x3fc52e){console[_0x5dcb24(0x150)](_0x5dcb24(0x12c),_0x3fc52e),loggerService_1[_0x5dcb24(0x10a)][_0x5dcb24(0x159)](_0x5dcb24(0x112),_0x3fc52e,_0x2a42e9);throw _0x3fc52e;}}async[a55_0x192d6e(0x16d)](_0x1893df){const _0x4c5253=a55_0x192d6e;console['log'](_0x4c5253(0x133),_0x1893df);try{const _0x1fc09d=await this[_0x4c5253(0x122)][_0x4c5253(0x186)](_0x1893df);if(!_0x1fc09d[_0x4c5253(0x13a)]){console[_0x4c5253(0x150)](_0x4c5253(0x188));return;}await this[_0x4c5253(0x171)](_0x1fc09d[_0x4c5253(0x13a)],_0x1fc09d[_0x4c5253(0x106)],_0x4c5253(0x142),_0x1893df,undefined,_0x1fc09d[_0x4c5253(0x189)]),loggerService_1[_0x4c5253(0x10a)][_0x4c5253(0x16c)]('noda',_0x1fc09d[_0x4c5253(0x13a)],_0x4c5253(0xfc),_0x1fc09d[_0x4c5253(0x106)],_0x1893df);}catch(_0xb3b2e){console[_0x4c5253(0x150)]('Error\x20processing\x20Noda\x20webhook:',_0xb3b2e),loggerService_1[_0x4c5253(0x10a)][_0x4c5253(0x159)](_0x4c5253(0x142),_0xb3b2e,_0x1893df);throw _0xb3b2e;}}async[a55_0x192d6e(0x10f)](_0x55676c){const _0x4520a7=a55_0x192d6e;console['log'](_0x4520a7(0x126),_0x55676c);try{const _0x2d11fb=await this[_0x4520a7(0x111)][_0x4520a7(0x186)](_0x55676c);if(!_0x2d11fb[_0x4520a7(0x13a)]){console[_0x4520a7(0x150)](_0x4520a7(0x10b));return;}await this[_0x4520a7(0x171)](_0x2d11fb['paymentId'],_0x2d11fb[_0x4520a7(0x106)],_0x4520a7(0x105),_0x55676c),loggerService_1[_0x4520a7(0x10a)]['logWebhookProcessed'](_0x4520a7(0x105),_0x2d11fb[_0x4520a7(0x13a)],_0x4520a7(0xfc),_0x2d11fb[_0x4520a7(0x106)],_0x55676c);}catch(_0x81ff65){console[_0x4520a7(0x150)](_0x4520a7(0x141),_0x81ff65),loggerService_1[_0x4520a7(0x10a)][_0x4520a7(0x159)](_0x4520a7(0x105),_0x81ff65,_0x55676c);throw _0x81ff65;}}async[a55_0x192d6e(0x11d)](_0x2b60a3){const _0x877398=a55_0x192d6e;console[_0x877398(0x12a)](_0x877398(0x17e),_0x2b60a3);try{const _0x57c7cc=await this[_0x877398(0x12d)][_0x877398(0x186)](_0x2b60a3);if(!_0x57c7cc[_0x877398(0x13a)]){console['error'](_0x877398(0x18e));return;}const _0x27091a=_0x57c7cc[_0x877398(0x172)]?_0x877398(0x104)+_0x57c7cc['region'][_0x877398(0x124)]():_0x877398(0x16a);await this[_0x877398(0x171)](_0x57c7cc[_0x877398(0x13a)],_0x57c7cc[_0x877398(0x106)],_0x27091a,_0x2b60a3,undefined,_0x57c7cc[_0x877398(0x189)]),loggerService_1[_0x877398(0x10a)][_0x877398(0x16c)](_0x877398(0x17f),_0x57c7cc['paymentId'],'PENDING',_0x57c7cc[_0x877398(0x106)],_0x2b60a3);}catch(_0x39f9df){console[_0x877398(0x150)](_0x877398(0x154),_0x39f9df),loggerService_1[_0x877398(0x10a)]['logWebhookError'](_0x877398(0x17f),_0x39f9df,_0x2b60a3);throw _0x39f9df;}}async[a55_0x192d6e(0x171)](_0x4dd7a3,_0x2ddad6,_0x241b73,_0x2659d0,_0x3141fa,_0x19c1b5,_0x5d9ab1){const _0x6f11bd=a55_0x192d6e;console[_0x6f11bd(0x12a)](_0x6f11bd(0x115)+_0x4dd7a3+_0x6f11bd(0xfd)+_0x2ddad6+_0x6f11bd(0x181)+_0x241b73+_0x6f11bd(0x13b));_0x3141fa&&console[_0x6f11bd(0x12a)](_0x6f11bd(0x175)+_0x4dd7a3+_0x6f11bd(0x139)+_0x3141fa);_0x5d9ab1&&_0x5d9ab1['length']>0x0&&console[_0x6f11bd(0x12a)](_0x6f11bd(0x160)+_0x4dd7a3+_0x6f11bd(0x168),_0x5d9ab1);const _0x273179=await database_1['default'][_0x6f11bd(0x14d)][_0x6f11bd(0x114)]({'where':{'gatewayOrderId':_0x4dd7a3,'gateway':_0x241b73},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x273179){console[_0x6f11bd(0x150)](_0x6f11bd(0x121)+_0x4dd7a3+_0x6f11bd(0x143)+_0x241b73);return;}const _0x34a9de=_0x273179[_0x6f11bd(0x106)];if(_0x34a9de===_0x2ddad6){console[_0x6f11bd(0x12a)]('Payment\x20'+_0x273179['id']+_0x6f11bd(0x156)+_0x2ddad6+')');return;}console['log'](_0x6f11bd(0x164)+_0x273179['id']+_0x6f11bd(0x183)+_0x34a9de+_0x6f11bd(0x100)+_0x2ddad6);const _0x31ca63={'status':_0x2ddad6,'updatedAt':new Date()};_0x3141fa&&(_0x31ca63[_0x6f11bd(0x13f)]=_0x3141fa,console[_0x6f11bd(0x12a)](_0x6f11bd(0x18a)+_0x3141fa));_0x5d9ab1&&_0x5d9ab1['length']>0x0&&(_0x31ca63[_0x6f11bd(0x113)]=JSON[_0x6f11bd(0x131)](_0x5d9ab1),console[_0x6f11bd(0x12a)]('ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20'+JSON['stringify'](_0x5d9ab1)));_0x2ddad6===_0x6f11bd(0x15c)&&_0x34a9de!=='PAID'&&(_0x31ca63[_0x6f11bd(0x15f)]=new Date());_0x19c1b5&&(_0x19c1b5[_0x6f11bd(0x17c)]&&(_0x31ca63[_0x6f11bd(0x17c)]=_0x19c1b5[_0x6f11bd(0x17c)]),_0x19c1b5['paymentMethod']&&(_0x31ca63[_0x6f11bd(0x167)]=_0x19c1b5[_0x6f11bd(0x167)]),_0x19c1b5[_0x6f11bd(0x10d)]&&(_0x31ca63[_0x6f11bd(0x10d)]=_0x19c1b5[_0x6f11bd(0x10d)]),_0x19c1b5[_0x6f11bd(0x129)]&&(_0x31ca63[_0x6f11bd(0x129)]=_0x19c1b5[_0x6f11bd(0x129)]),_0x19c1b5['remitterName']&&(_0x31ca63[_0x6f11bd(0x170)]=_0x19c1b5['remitterName']));await database_1[_0x6f11bd(0x14f)][_0x6f11bd(0x14d)]['update']({'where':{'id':_0x273179['id']},'data':_0x31ca63});if(_0x2ddad6===_0x6f11bd(0x15c)&&_0x34a9de!==_0x6f11bd(0x15c))try{await this['paymentLinkService']['handleSuccessfulPayment'](_0x273179['id']);}catch(_0x5ee865){console[_0x6f11bd(0x150)](_0x6f11bd(0x18f),_0x5ee865);}await database_1['default'][_0x6f11bd(0x169)][_0x6f11bd(0x123)]({'data':{'paymentId':_0x273179['id'],'shopId':_0x273179['shopId'],'event':_0x241b73+_0x6f11bd(0x118)+_0x2ddad6[_0x6f11bd(0x124)](),'statusCode':0xc8,'responseBody':JSON[_0x6f11bd(0x131)]({'oldStatus':_0x34a9de,'newStatus':_0x2ddad6,'failureMessage':_0x3141fa,'txUrls':_0x5d9ab1,'webhookData':_0x2659d0})}}),await this['sendShopWebhook'](_0x273179,_0x2ddad6),await this[_0x6f11bd(0x179)](_0x273179,_0x2ddad6),console[_0x6f11bd(0x12a)](_0x6f11bd(0x136)+_0x273179['id']+_0x6f11bd(0x138)+_0x34a9de+'\x20->\x20'+_0x2ddad6),_0x3141fa&&console['log'](_0x6f11bd(0x185)+_0x3141fa),_0x5d9ab1&&_0x5d9ab1['length']>0x0&&console['log'](_0x6f11bd(0x17b)+_0x5d9ab1['length']+_0x6f11bd(0x153));}async[a55_0x192d6e(0x184)](_0x2f40a3,_0x14b9bb){const _0x186c87=a55_0x192d6e,_0x35b805=Date[_0x186c87(0x102)]();try{const _0x5d8c8c=_0x2f40a3[_0x186c87(0x130)],_0x2021c4=_0x5d8c8c[_0x186c87(0xff)];if(!_0x2021c4?.[_0x186c87(0x144)]){console[_0x186c87(0x12a)](_0x186c87(0x15b)+_0x5d8c8c['id']);return;}const _0x201191=_0x14b9bb===_0x186c87(0x15c)?_0x186c87(0x177):_0x14b9bb==='FAILED'?_0x186c87(0x161):_0x14b9bb===_0x186c87(0x16b)?_0x186c87(0x161):_0x186c87(0x127);let _0x4b8afb=[];if(_0x2021c4[_0x186c87(0x155)])try{_0x4b8afb=Array[_0x186c87(0x166)](_0x2021c4[_0x186c87(0x155)])?_0x2021c4[_0x186c87(0x155)]:JSON[_0x186c87(0x108)](_0x2021c4[_0x186c87(0x155)]);}catch(_0xf41847){console[_0x186c87(0x150)](_0x186c87(0x15e),_0xf41847),_0x4b8afb=[];}if(!_0x4b8afb['includes'](_0x201191)){console[_0x186c87(0x12a)](_0x186c87(0x12e)+_0x201191+_0x186c87(0x132)+_0x5d8c8c['id']);return;}let _0x18abee;if(_0x2f40a3[_0x186c87(0x113)])try{_0x18abee=JSON['parse'](_0x2f40a3[_0x186c87(0x113)]);}catch(_0x262b76){console[_0x186c87(0x150)](_0x186c87(0x158),_0x262b76),_0x18abee=undefined;}const _0x66aa8c={'event':_0x201191,'payment':{'id':_0x2f40a3['id'],'order_id':_0x2f40a3[_0x186c87(0x16e)],'gateway_order_id':_0x2f40a3[_0x186c87(0x11b)],'gateway':_0x2f40a3['gateway'],'amount':_0x2f40a3[_0x186c87(0x163)],'currency':_0x2f40a3[_0x186c87(0x103)],'status':_0x14b9bb[_0x186c87(0x124)](),'customer_email':_0x2f40a3[_0x186c87(0x149)],'customer_name':_0x2f40a3[_0x186c87(0x15a)],'failure_message':_0x2f40a3['failureMessage'],'tx_urls':_0x18abee,'created_at':_0x2f40a3[_0x186c87(0x109)],'updated_at':new Date()}},_0x4a004a=await fetch(_0x2021c4[_0x186c87(0x144)],{'method':_0x186c87(0x15d),'headers':{'Content-Type':_0x186c87(0x173),'User-Agent':_0x186c87(0x14a)},'body':JSON[_0x186c87(0x131)](_0x66aa8c)}),_0x531daf=Date[_0x186c87(0x102)]()-_0x35b805,_0x48f22e=_0x4a004a['ok']?'Success':await _0x4a004a[_0x186c87(0x174)]();loggerService_1[_0x186c87(0x10a)][_0x186c87(0x13d)](_0x2f40a3[_0x186c87(0x14e)],_0x2021c4[_0x186c87(0x144)],_0x201191,_0x4a004a[_0x186c87(0x106)],_0x531daf,_0x66aa8c),console[_0x186c87(0x12a)]('Shop\x20webhook\x20sent\x20to\x20'+_0x2021c4[_0x186c87(0x144)]+_0x186c87(0x135)+_0x4a004a[_0x186c87(0x106)]+'\x20('+_0x531daf+'ms)');}catch(_0x4e17a5){console[_0x186c87(0x150)](_0x186c87(0x12b),_0x4e17a5),loggerService_1[_0x186c87(0x10a)][_0x186c87(0x119)](_0x2f40a3['shopId'],_0x2f40a3[_0x186c87(0x130)]?.[_0x186c87(0xff)]?.['webhookUrl']||_0x186c87(0x11e),_0x186c87(0x187),_0x4e17a5,{});}}async[a55_0x192d6e(0x179)](_0x4b3a4c,_0x412813){const _0xce205=a55_0x192d6e;try{const _0x19cb80={'PENDING':_0xce205(0x18c),'PAID':_0xce205(0x146),'FAILED':_0xce205(0x17d),'EXPIRED':'expired'},_0x246a95=_0x19cb80[_0x412813];if(!_0x246a95||_0x246a95===_0xce205(0x18c))return;await telegramBotService_1['telegramBotService']['sendPaymentNotification'](_0x4b3a4c[_0xce205(0x14e)],_0x4b3a4c,_0x246a95);}catch(_0x412cf8){console[_0xce205(0x150)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x412cf8);}}}exports[a55_0x192d6e(0x152)]=WebhookService;