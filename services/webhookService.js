'use strict';const a60_0x401dd6=a60_0x3023;(function(_0x16d4a0,_0x15916a){const _0x595d53=a60_0x3023,_0x36f47d=_0x16d4a0();while(!![]){try{const _0x20520a=parseInt(_0x595d53(0xd1))/0x1*(-parseInt(_0x595d53(0xbf))/0x2)+parseInt(_0x595d53(0x80))/0x3+parseInt(_0x595d53(0xc8))/0x4*(parseInt(_0x595d53(0xcf))/0x5)+-parseInt(_0x595d53(0x132))/0x6*(parseInt(_0x595d53(0x13c))/0x7)+-parseInt(_0x595d53(0x14c))/0x8+parseInt(_0x595d53(0x82))/0x9*(parseInt(_0x595d53(0x146))/0xa)+parseInt(_0x595d53(0x8e))/0xb;if(_0x20520a===_0x15916a)break;else _0x36f47d['push'](_0x36f47d['shift']());}catch(_0x2eada0){_0x36f47d['push'](_0x36f47d['shift']());}}}(a60_0x43bc,0x350f6));function a60_0x43bc(){const _0x53f724=['webhookEvents','EXPIRED','2637987njlrDt','processPlisioGatewayWebhook','No\x20payment\x20ID\x20in\x20Amer\x20webhook','üìä\x20MasterCard\x20webhook\x20result:','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','Found\x20payment\x20','AmerService','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','üìà\x20Payment\x20','‚ùå\x20Error\x20processing\x20MasterCard\x20webhook:','rapydService','üìä\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','createdAt','paymentLinkId','\x20=\x20','amount','payment.failed','üîç\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','failureMessage','üí∞\x20Adding\x20to\x20balance:\x20','üìä\x20Rapyd\x20webhook:\x20Payment\x20','üîç\x20Search\x20result:\x20','üí∞\x20Removing\x20from\x20balance:\x20','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','plisioService','‚ùå\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','parse','POST','\x20to\x20','‚ùå\x20Available\x20webhook\x20fields:','\x20+\x20','gateway','plisio','Payment\x20','üîÑ\x20Processing\x20Rapyd\x20webhook:','paidAt','webhookLog','processKlymeWebhook','__esModule','üîÑ\x20Processing\x20Amer\x20webhook:','no\x20balance\x20change','settings','processWebhook','loggerService','üí∞\x20Payment\x20','refund','chargeback','Error\x20processing\x20Noda\x20webhook:','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','2aXgcOu','mastercard','error','WebhookService','findUnique','toUpperCase','‚úÖ\x20Shop\x20','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','4GBCBRP','paid','\x20status\x20','CoinToPayService','üìä\x20Noda\x20webhook:\x20Payment\x20','processNodaWebhook','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','150405qdIvvy','gatewaySettings','192959WJmSgA','coinToPay2Service','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','findFirst','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','type','$transaction',',\x20currentPayments=','stringify','remitterName','üîÑ\x20Processing\x20CoinToPay2\x20webhook:','toFixed','default','processMasterCardWebhook','remitterIban','üìä\x20Amer\x20webhook\x20result:','log','shopId','customerName','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','paymentId','\x22,\x20paymentLinkId=\x22','\x20commission:\x20','updatePaymentStatus','Error\x20processing\x20Rapyd\x20webhook:','logWebhookProcessed','üîÑ\x20Processing\x20KLYME\x20webhook:','üí∞\x20Gateway\x20','entries','./gateways/klymeService','‚ùå\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','CHARGEBACK','\x20->\x20',',\x20using\x20default\x20commission\x2010%','FAILED','shop','nodaService','\x20commission\x20for\x20shop\x20','üîÑ\x20Additional\x20data:','üì§\x20Shop\x20webhook\x20sent\x20to\x20','failed','‚ùå\x20Payment\x20link\x20','%\x20gateway\x20commission)','coinToPayService','now','webhook_status_change_','üîÑ\x20Processing\x20Plisio\x20Gateway\x20webhook:','./gateways/mastercardService','paymentMethod','toLowerCase','No\x20payment\x20ID\x20in\x20Noda\x20webhook','üìà\x20Found\x20payment\x20link\x20','üîç\x20Searched\x20by:\x20gatewayOrderId=\x22','amer','additionalInfo','includes','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','üîÑ\x20Processing\x20CoinToPay\x20webhook:','klyme','klymeService','processCoinToPayWebhook','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','üìä\x20Plisio\x20webhook:\x20Payment\x20','\x20balance\x20updated:\x20','webhook_send','amountUSDT','REFUND','../config/database','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','üìù\x20Reason:\x20','status','./currencyService',':\x20type=','payment.pending','username','üîç\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20USDT\x20(chargeback\x20penalty)','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','gatewayOrderId','./gateways/coinToPay2Service','\x20not\x20enabled\x20for\x20shop\x20','cointopay','paymentLink','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','cardLast4','Webhook\x20event\x20','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','plisio_gateway','logShopWebhookError','chargebackAmount','amountAfterGatewayCommissionUSDT','\x20and\x20-',',\x20status=','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','üìà\x20Payment\x20details:\x20oldStatus=\x22','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','4770bhalJD','‚ùå\x20Error\x20processing\x20Amer\x20webhook:','CoinToPay2Service','Payment\x20not\x20found','masterCardService','PlisioService','payment','‚úÖ\x20Payment\x20link\x20','\x20updated:\x20currentPayments=','payment_method','1799wfkjRf','./telegramBotService','bankId','‚úÖ\x20Found\x20payment\x20','processCoinToPay2Webhook','processing','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','\x22,\x20orderId=\x22','\x20-\x20','KlymeService','668660xRyiSI','üí∞\x20Converting\x20','./gateways/amerService','COMPLETED','sendPaymentStatusNotification','created','568512wGwHCj','currency','Error\x20processing\x20KLYME\x20webhook:','sendShopWebhook','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','üîÑ\x20updatePaymentStatus\x20called:\x20paymentId=','balance','rapyd','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20in\x20shop\x20','Success','üìä\x20CoinToPay\x20webhook:\x20Payment\x20','Gateway\x20','Failed\x20to\x20send\x20shop\x20webhook:','üîÑ\x20Processing\x20Noda\x20webhook:','update','\x20USDT','üîç\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','Error\x20parsing\x20webhook\x20events:','PAID','getGatewayCommission',',\x20gateway\x20','ms)','\x20with\x20status\x20','webhookUrl','amerService','üìä\x20CoinToPay2\x20webhook:\x20Payment\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','cointopay2','\x22,\x20id=\x22',',\x20newStatus=','processPlisioWebhook','keys','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','customerEmail','txUrls','43734VLEGHA','./gateways/plisioService','54Bwdjjk','isArray','./gateways/nodaService','processAmerWebhook','RapydService','NodaService','noda','currentPayments','üìä\x20KLYME\x20webhook:\x20Payment\x20','logWebhookError'];a60_0x43bc=function(){return _0x53f724;};return a60_0x43bc();}var __importDefault=this&&this['__importDefault']||function(_0x409216){const _0x5d75b1=a60_0x3023;return _0x409216&&_0x409216[_0x5d75b1(0xb4)]?_0x409216:{'default':_0x409216};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a60_0x401dd6(0x114))),plisioService_1=require(a60_0x401dd6(0x81)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a60_0x401dd6(0x84)),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a60_0x401dd6(0x120)),klymeService_1=require(a60_0x401dd6(0xee)),mastercardService_1=require(a60_0x401dd6(0x100)),amerService_1=require(a60_0x401dd6(0x148)),telegramBotService_1=require(a60_0x401dd6(0x13d)),currencyService_1=require(a60_0x401dd6(0x118)),loggerService_1=require('./loggerService');function a60_0x3023(_0x3b4789,_0xfa9b48){const _0x43bc7a=a60_0x43bc();return a60_0x3023=function(_0x3023ad,_0x2bdf91){_0x3023ad=_0x3023ad-0x7d;let _0x1ca673=_0x43bc7a[_0x3023ad];return _0x1ca673;},a60_0x3023(_0x3b4789,_0xfa9b48);}class WebhookService{constructor(){const _0x46af74=a60_0x401dd6;this[_0x46af74(0xa6)]=new plisioService_1[(_0x46af74(0x137))](),this['rapydService']=new rapydService_1[(_0x46af74(0x86))](),this['nodaService']=new nodaService_1[(_0x46af74(0x87))](),this[_0x46af74(0xfc)]=new coinToPayService_1[(_0x46af74(0xcb))](),this[_0x46af74(0xd2)]=new coinToPay2Service_1[(_0x46af74(0x134))](),this[_0x46af74(0x10c)]=new klymeService_1[(_0x46af74(0x145))](),this[_0x46af74(0x136)]=new mastercardService_1['MasterCardService'](),this[_0x46af74(0x165)]=new amerService_1[(_0x46af74(0x94))]();}async[a60_0x401dd6(0xe8)](_0x30a951,_0x4f44cf,_0x20f8c9){const _0xd617cc=a60_0x401dd6;console[_0xd617cc(0xe1)](_0xd617cc(0x151)+_0x30a951+_0xd617cc(0x16a)+_0x4f44cf),console[_0xd617cc(0xe1)](_0xd617cc(0xf7),_0x20f8c9),await database_1[_0xd617cc(0xdd)][_0xd617cc(0xd7)](async _0x10e8b8=>{const _0x4ce24f=_0xd617cc,_0x3b0c0d=await _0x10e8b8[_0x4ce24f(0x138)][_0x4ce24f(0xc3)]({'where':{'id':_0x30a951},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3b0c0d)throw new Error(_0x4ce24f(0xaf)+_0x30a951+'\x20not\x20found');const _0x5cd218=_0x3b0c0d['status'],_0x4f0ecd=_0x3b0c0d['shop'];console[_0x4ce24f(0xe1)](_0x4ce24f(0xba)+_0x30a951+':\x20'+_0x5cd218+_0x4ce24f(0xf1)+_0x4f44cf),console[_0x4ce24f(0xe1)]('üè™\x20Shop\x20'+_0x4f0ecd[_0x4ce24f(0x11b)]+'\x20current\x20balance:\x20'+_0x4f0ecd['balance']+_0x4ce24f(0x15c));const _0xddc12b={'status':_0x4f44cf['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x20f8c9?.[_0x4ce24f(0xa0)]&&(_0xddc12b[_0x4ce24f(0xa0)]=_0x20f8c9[_0x4ce24f(0xa0)]);_0x20f8c9?.['txUrls']&&(_0xddc12b['txUrls']=JSON['stringify'](_0x20f8c9['txUrls']));_0x20f8c9?.[_0x4ce24f(0x125)]&&(_0xddc12b[_0x4ce24f(0x125)]=_0x20f8c9[_0x4ce24f(0x125)]);_0x20f8c9?.[_0x4ce24f(0x101)]&&(_0xddc12b[_0x4ce24f(0x101)]=_0x20f8c9['paymentMethod']);_0x20f8c9?.['bankId']&&(_0xddc12b[_0x4ce24f(0x13e)]=_0x20f8c9[_0x4ce24f(0x13e)]);_0x20f8c9?.[_0x4ce24f(0xdf)]&&(_0xddc12b[_0x4ce24f(0xdf)]=_0x20f8c9[_0x4ce24f(0xdf)]);_0x20f8c9?.[_0x4ce24f(0xda)]&&(_0xddc12b[_0x4ce24f(0xda)]=_0x20f8c9['remitterName']);let _0x33d3bc=_0x4f0ecd['balance'],_0x80aeac='';if(_0x4f44cf[_0x4ce24f(0xc4)]()===_0x4ce24f(0x15f)&&_0x5cd218!==_0x4ce24f(0x15f)){const _0x14b9eb=await currencyService_1['currencyService']['convertToUSDT'](_0x3b0c0d[_0x4ce24f(0x9d)],_0x3b0c0d[_0x4ce24f(0x14d)]),_0x3db1ff=await this[_0x4ce24f(0x160)](_0x4f0ecd['id'],_0x3b0c0d['gateway']),_0x27434e=_0x14b9eb*(0x1-_0x3db1ff/0x64);_0x33d3bc+=_0x27434e,_0x80aeac='+'+_0x27434e[_0x4ce24f(0xdc)](0x6)+_0x4ce24f(0x95)+_0x3db1ff+_0x4ce24f(0xfb),_0xddc12b['amountUSDT']=_0x14b9eb,_0xddc12b[_0x4ce24f(0x12b)]=_0x27434e,_0xddc12b[_0x4ce24f(0xb1)]=new Date(),console[_0x4ce24f(0xe1)](_0x4ce24f(0x147)+_0x3b0c0d[_0x4ce24f(0x9d)]+'\x20'+_0x3b0c0d[_0x4ce24f(0x14d)]+_0x4ce24f(0xf1)+_0x14b9eb['toFixed'](0x6)+_0x4ce24f(0x15c)),console[_0x4ce24f(0xe1)](_0x4ce24f(0xec)+_0x3b0c0d['gateway']+_0x4ce24f(0xe7)+_0x3db1ff+'%'),console['log'](_0x4ce24f(0x10e)+_0x27434e[_0x4ce24f(0xdc)](0x6)+'\x20USDT'),console[_0x4ce24f(0xe1)](_0x4ce24f(0xa1)+_0x4f0ecd[_0x4ce24f(0x152)]+_0x4ce24f(0xac)+_0x27434e[_0x4ce24f(0xdc)](0x6)+_0x4ce24f(0x9c)+_0x33d3bc[_0x4ce24f(0xdc)](0x6)+'\x20USDT');}else{if(_0x5cd218===_0x4ce24f(0x15f)&&_0x4f44cf[_0x4ce24f(0xc4)]()!==_0x4ce24f(0x15f)){let _0x425440;if(_0x3b0c0d[_0x4ce24f(0x12b)])_0x425440=_0x3b0c0d[_0x4ce24f(0x12b)];else{if(_0x3b0c0d[_0x4ce24f(0x112)]){const _0x520a08=await this['getGatewayCommission'](_0x4f0ecd['id'],_0x3b0c0d[_0x4ce24f(0xad)]);_0x425440=_0x3b0c0d[_0x4ce24f(0x112)]*(0x1-_0x520a08/0x64);}else console[_0x4ce24f(0xe1)]('No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance'),_0x425440=0x0;}_0x425440>0x0&&(_0x33d3bc-=_0x425440,_0x80aeac='-'+_0x425440[_0x4ce24f(0xdc)](0x6)+_0x4ce24f(0xc7),_0xddc12b['amountUSDT']=null,_0xddc12b[_0x4ce24f(0x12b)]=null,_0xddc12b[_0x4ce24f(0xb1)]=null,console[_0x4ce24f(0xe1)](_0x4ce24f(0xa4)+_0x4f0ecd[_0x4ce24f(0x152)]+_0x4ce24f(0x144)+_0x425440[_0x4ce24f(0xdc)](0x6)+_0x4ce24f(0x9c)+_0x33d3bc['toFixed'](0x6)+_0x4ce24f(0x15c)));}}if(_0x4f44cf[_0x4ce24f(0xc4)]()===_0x4ce24f(0xf0)){const _0x274cee=_0x20f8c9?.[_0x4ce24f(0x12a)]||0x0;_0x274cee>0x0&&(_0x33d3bc-=_0x274cee,_0x80aeac+=_0x4ce24f(0x12c)+_0x274cee['toFixed'](0x6)+_0x4ce24f(0x11d),_0xddc12b['chargebackAmount']=_0x274cee,console['log']('üí∏\x20Additional\x20chargeback\x20penalty:\x20-'+_0x274cee[_0x4ce24f(0xdc)](0x6)+'\x20USDT'),console['log']('üí∞\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x33d3bc['toFixed'](0x6)+_0x4ce24f(0x15c)));}const _0x4dd7f5=await _0x10e8b8[_0x4ce24f(0x138)][_0x4ce24f(0x15b)]({'where':{'id':_0x30a951},'data':_0xddc12b});_0x33d3bc!==_0x4f0ecd[_0x4ce24f(0x152)]&&(await _0x10e8b8[_0x4ce24f(0xf4)][_0x4ce24f(0x15b)]({'where':{'id':_0x4f0ecd['id']},'data':{'balance':_0x33d3bc}}),console[_0x4ce24f(0xe1)](_0x4ce24f(0xc5)+_0x4f0ecd['username']+_0x4ce24f(0x110)+_0x4f0ecd[_0x4ce24f(0x152)]['toFixed'](0x6)+_0x4ce24f(0xf1)+_0x33d3bc[_0x4ce24f(0xdc)](0x6)+_0x4ce24f(0x15c)),console[_0x4ce24f(0xe1)](_0x4ce24f(0x116)+_0x80aeac));await _0x10e8b8[_0x4ce24f(0xb2)]['create']({'data':{'paymentId':_0x30a951,'shopId':_0x4f0ecd['id'],'event':_0x4ce24f(0xfe)+_0x4f44cf[_0x4ce24f(0x102)](),'statusCode':0xc8,'responseBody':JSON[_0x4ce24f(0xd9)]({'oldStatus':_0x5cd218,'newStatus':_0x4f44cf['toUpperCase'](),'balanceChange':_0x80aeac||_0x4ce24f(0xb6),'oldBalance':_0x4f0ecd[_0x4ce24f(0x152)],'newBalance':_0x33d3bc,'amountUSDT':_0xddc12b[_0x4ce24f(0x112)],'additionalData':_0x20f8c9,'timestamp':new Date()['toISOString']()})}}),await this[_0x4ce24f(0x14f)]({..._0x3b0c0d,..._0x4dd7f5,'shop':_0x4f0ecd},_0x4f44cf[_0x4ce24f(0xc4)]()),await this[_0x4ce24f(0x14a)]({..._0x3b0c0d,..._0x4dd7f5},_0x4f44cf[_0x4ce24f(0xc4)]());if(_0x5cd218!=='PAID'&&_0x4f44cf[_0x4ce24f(0xc4)]()===_0x4ce24f(0x15f)){console[_0x4ce24f(0xe1)](_0x4ce24f(0x96)+_0x30a951+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console[_0x4ce24f(0xe1)](_0x4ce24f(0x12f)+_0x5cd218+'\x22,\x20newStatus=\x22'+_0x4f44cf[_0x4ce24f(0xc4)]()+_0x4ce24f(0xe6)+_0x3b0c0d['paymentLinkId']+'\x22');if(_0x3b0c0d['paymentLinkId'])try{const _0x1eba6f=await _0x10e8b8['paymentLink']['findUnique']({'where':{'id':_0x3b0c0d['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1eba6f){console[_0x4ce24f(0xe1)](_0x4ce24f(0x104)+_0x1eba6f['id']+_0x4ce24f(0x119)+_0x1eba6f[_0x4ce24f(0xd6)]+_0x4ce24f(0xd8)+_0x1eba6f[_0x4ce24f(0x89)]+_0x4ce24f(0x12d)+_0x1eba6f[_0x4ce24f(0x117)]);const _0x38d09a=_0x1eba6f[_0x4ce24f(0x89)]+0x1,_0x10a125=_0x1eba6f[_0x4ce24f(0xd6)]==='SINGLE'?_0x4ce24f(0x149):_0x1eba6f['status'];await _0x10e8b8[_0x4ce24f(0x123)][_0x4ce24f(0x15b)]({'where':{'id':_0x3b0c0d['paymentLinkId']},'data':{'currentPayments':_0x38d09a,'status':_0x10a125,'updatedAt':new Date()}}),console['log'](_0x4ce24f(0x139)+_0x1eba6f['id']+_0x4ce24f(0x13a)+_0x1eba6f['currentPayments']+_0x4ce24f(0xf1)+_0x38d09a+',\x20status='+_0x1eba6f['status']+'\x20->\x20'+_0x10a125);}else console[_0x4ce24f(0xe1)](_0x4ce24f(0xfa)+_0x3b0c0d[_0x4ce24f(0x9b)]+'\x20not\x20found');}catch(_0x1194c7){console[_0x4ce24f(0xc1)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x1194c7);}else console['log'](_0x4ce24f(0x96)+_0x30a951+_0x4ce24f(0x12e));}else console[_0x4ce24f(0xe1)]('üìà\x20Payment\x20'+_0x30a951+_0x4ce24f(0xc6)+_0x5cd218+_0x4ce24f(0xf1)+_0x4f44cf[_0x4ce24f(0xc4)]());});}async[a60_0x401dd6(0x16b)](_0x37fc69){const _0x29c22c=a60_0x401dd6;console['log']('üîÑ\x20Processing\x20Plisio\x20webhook:',_0x37fc69);try{const _0x4a164e=await this[_0x29c22c(0xa6)][_0x29c22c(0xb8)](_0x37fc69);if(!_0x4a164e[_0x29c22c(0xe5)])throw new Error(_0x29c22c(0x11e));const _0x535168=await database_1[_0x29c22c(0xdd)][_0x29c22c(0x138)]['findFirst']({'where':{'gatewayOrderId':_0x4a164e['paymentId']}});if(!_0x535168){console['error']('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x4a164e[_0x29c22c(0xe5)]);return;}console[_0x29c22c(0xe1)](_0x29c22c(0x10f)+_0x535168['id']+'\x20status\x20'+_0x4a164e[_0x29c22c(0x117)]),await this[_0x29c22c(0xe8)](_0x535168['id'],_0x4a164e[_0x29c22c(0x117)],{'txUrls':_0x4a164e[_0x29c22c(0x7f)]}),loggerService_1['loggerService'][_0x29c22c(0xea)](_0x29c22c(0xae),_0x535168['id'],_0x535168['status'],_0x4a164e[_0x29c22c(0x117)],_0x37fc69);}catch(_0x166e84){console[_0x29c22c(0xc1)]('Error\x20processing\x20Plisio\x20webhook:',_0x166e84),loggerService_1['loggerService'][_0x29c22c(0x8b)](_0x29c22c(0xae),_0x166e84,_0x37fc69);throw _0x166e84;}}async[a60_0x401dd6(0x8f)](_0x3b2126){const _0x51815f=a60_0x401dd6;console['log'](_0x51815f(0xff),_0x3b2126);try{const _0x1e8862=await this['plisioService']['processWebhook'](_0x3b2126);if(!_0x1e8862['paymentId'])throw new Error(_0x51815f(0x92));const _0x553f62=await database_1['default'][_0x51815f(0x138)]['findFirst']({'where':{'gatewayOrderId':_0x1e8862[_0x51815f(0xe5)]}});if(!_0x553f62){console[_0x51815f(0xc1)]('Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20'+_0x1e8862[_0x51815f(0xe5)]);return;}console[_0x51815f(0xe1)](_0x51815f(0x99)+_0x553f62['id']+_0x51815f(0xca)+_0x1e8862[_0x51815f(0x117)]),await this[_0x51815f(0xe8)](_0x553f62['id'],_0x1e8862[_0x51815f(0x117)],{'txUrls':_0x1e8862[_0x51815f(0x7f)]}),loggerService_1[_0x51815f(0xb9)][_0x51815f(0xea)]('plisio_gateway',_0x553f62['id'],_0x553f62[_0x51815f(0x117)],_0x1e8862[_0x51815f(0x117)],_0x3b2126);}catch(_0x2010bc){console['error'](_0x51815f(0x124),_0x2010bc),loggerService_1[_0x51815f(0xb9)][_0x51815f(0x8b)](_0x51815f(0x128),_0x2010bc,_0x3b2126);throw _0x2010bc;}}async['processRapydWebhook'](_0x84d5a4){const _0x51b45e=a60_0x401dd6;console['log'](_0x51b45e(0xb0),_0x84d5a4);try{const _0x30ae69=await this[_0x51b45e(0x98)][_0x51b45e(0xb8)](_0x84d5a4);if(!_0x30ae69[_0x51b45e(0xe5)])throw new Error('No\x20payment\x20ID\x20in\x20Rapyd\x20webhook');const _0x5df298=await database_1['default'][_0x51b45e(0x138)][_0x51b45e(0xd4)]({'where':{'gatewayOrderId':_0x30ae69['paymentId']}});if(!_0x5df298){console[_0x51b45e(0xc1)](_0x51b45e(0x109)+_0x30ae69[_0x51b45e(0xe5)]);return;}console[_0x51b45e(0xe1)](_0x51b45e(0xa2)+_0x5df298['id']+_0x51b45e(0xca)+_0x30ae69['status']),await this[_0x51b45e(0xe8)](_0x5df298['id'],_0x30ae69[_0x51b45e(0x117)],{'failureMessage':_0x30ae69[_0x51b45e(0xa0)],'cardLast4':_0x30ae69[_0x51b45e(0x107)]?.[_0x51b45e(0x125)],'paymentMethod':_0x30ae69['additionalInfo']?.[_0x51b45e(0x101)]}),loggerService_1[_0x51b45e(0xb9)][_0x51b45e(0xea)]('rapyd',_0x5df298['id'],_0x5df298[_0x51b45e(0x117)],_0x30ae69[_0x51b45e(0x117)],_0x84d5a4);}catch(_0x3bfe02){console[_0x51b45e(0xc1)](_0x51b45e(0xe9),_0x3bfe02),loggerService_1['loggerService'][_0x51b45e(0x8b)](_0x51b45e(0x153),_0x3bfe02,_0x84d5a4);throw _0x3bfe02;}}async[a60_0x401dd6(0xcd)](_0x4170d9){const _0x44bda1=a60_0x401dd6;console['log'](_0x44bda1(0x15a),_0x4170d9);try{const _0x86e46c=await this[_0x44bda1(0xf5)][_0x44bda1(0xb8)](_0x4170d9);if(!_0x86e46c[_0x44bda1(0xe5)])throw new Error(_0x44bda1(0x103));const _0x39a4ad=await database_1[_0x44bda1(0xdd)][_0x44bda1(0x138)]['findFirst']({'where':{'gatewayOrderId':_0x86e46c['paymentId']}});if(!_0x39a4ad){console['error'](_0x44bda1(0x142)+_0x86e46c[_0x44bda1(0xe5)]);return;}console[_0x44bda1(0xe1)](_0x44bda1(0xcc)+_0x39a4ad['id']+_0x44bda1(0xca)+_0x86e46c[_0x44bda1(0x117)]),await this['updatePaymentStatus'](_0x39a4ad['id'],_0x86e46c[_0x44bda1(0x117)],{'bankId':_0x86e46c[_0x44bda1(0x107)]?.[_0x44bda1(0x13e)],'remitterIban':_0x86e46c[_0x44bda1(0x107)]?.[_0x44bda1(0xdf)],'remitterName':_0x86e46c['additionalInfo']?.[_0x44bda1(0xda)]}),loggerService_1[_0x44bda1(0xb9)]['logWebhookProcessed'](_0x44bda1(0x88),_0x39a4ad['id'],_0x39a4ad[_0x44bda1(0x117)],_0x86e46c[_0x44bda1(0x117)],_0x4170d9);}catch(_0x3326cf){console[_0x44bda1(0xc1)](_0x44bda1(0xbd),_0x3326cf),loggerService_1['loggerService']['logWebhookError'](_0x44bda1(0x88),_0x3326cf,_0x4170d9);throw _0x3326cf;}}async[a60_0x401dd6(0x10d)](_0x53ea07){const _0xf06393=a60_0x401dd6;console[_0xf06393(0xe1)](_0xf06393(0x10a),_0x53ea07);try{const _0x1b1c84=await this[_0xf06393(0xfc)]['processWebhook'](_0x53ea07);if(!_0x1b1c84[_0xf06393(0xe5)])throw new Error(_0xf06393(0x150));const _0x2d39a1=await database_1[_0xf06393(0xdd)][_0xf06393(0x138)][_0xf06393(0xd4)]({'where':{'gatewayOrderId':_0x1b1c84[_0xf06393(0xe5)]}});if(!_0x2d39a1){console[_0xf06393(0xc1)](_0xf06393(0x7d)+_0x1b1c84[_0xf06393(0xe5)]);return;}console[_0xf06393(0xe1)](_0xf06393(0x157)+_0x2d39a1['id']+_0xf06393(0xca)+_0x1b1c84[_0xf06393(0x117)]),await this[_0xf06393(0xe8)](_0x2d39a1['id'],_0x1b1c84['status']),loggerService_1[_0xf06393(0xb9)][_0xf06393(0xea)](_0xf06393(0x122),_0x2d39a1['id'],_0x2d39a1[_0xf06393(0x117)],_0x1b1c84[_0xf06393(0x117)],_0x53ea07);}catch(_0x5e3829){console[_0xf06393(0xc1)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x5e3829),loggerService_1['loggerService'][_0xf06393(0x8b)](_0xf06393(0x122),_0x5e3829,_0x53ea07);throw _0x5e3829;}}async[a60_0x401dd6(0x140)](_0x4d67b9){const _0x4832da=a60_0x401dd6;console[_0x4832da(0xe1)](_0x4832da(0xdb),_0x4d67b9);try{const _0x13f698=await this[_0x4832da(0xd2)][_0x4832da(0xb8)](_0x4d67b9);if(!_0x13f698['paymentId'])throw new Error(_0x4832da(0xd3));const _0x24def4=await database_1[_0x4832da(0xdd)][_0x4832da(0x138)]['findFirst']({'where':{'gatewayOrderId':_0x13f698[_0x4832da(0xe5)]}});if(!_0x24def4){console[_0x4832da(0xc1)](_0x4832da(0x115)+_0x13f698[_0x4832da(0xe5)]);return;}console[_0x4832da(0xe1)](_0x4832da(0x166)+_0x24def4['id']+_0x4832da(0xca)+_0x13f698['status']),await this[_0x4832da(0xe8)](_0x24def4['id'],_0x13f698['status']),loggerService_1['loggerService'][_0x4832da(0xea)](_0x4832da(0x168),_0x24def4['id'],_0x24def4[_0x4832da(0x117)],_0x13f698[_0x4832da(0x117)],_0x4d67b9);}catch(_0x52f0ed){console[_0x4832da(0xc1)]('Error\x20processing\x20CoinToPay2\x20webhook:',_0x52f0ed),loggerService_1['loggerService']['logWebhookError'](_0x4832da(0x168),_0x52f0ed,_0x4d67b9);throw _0x52f0ed;}}async[a60_0x401dd6(0xb3)](_0x8187b0){const _0x42fbae=a60_0x401dd6;console['log'](_0x42fbae(0xeb),_0x8187b0);try{const _0x8b7550=await this[_0x42fbae(0x10c)][_0x42fbae(0xb8)](_0x8187b0);if(!_0x8b7550[_0x42fbae(0xe5)])throw new Error(_0x42fbae(0x130));const _0x17088b=await database_1[_0x42fbae(0xdd)][_0x42fbae(0x138)][_0x42fbae(0xd4)]({'where':{'gatewayOrderId':_0x8b7550[_0x42fbae(0xe5)]}});if(!_0x17088b){console[_0x42fbae(0xc1)](_0x42fbae(0xe4)+_0x8b7550[_0x42fbae(0xe5)]);return;}console[_0x42fbae(0xe1)](_0x42fbae(0x8a)+_0x17088b['id']+_0x42fbae(0xca)+_0x8b7550[_0x42fbae(0x117)]),await this[_0x42fbae(0xe8)](_0x17088b['id'],_0x8b7550[_0x42fbae(0x117)],{'paymentMethod':_0x8b7550[_0x42fbae(0x107)]?.[_0x42fbae(0x13b)]}),loggerService_1[_0x42fbae(0xb9)][_0x42fbae(0xea)](_0x42fbae(0x10b),_0x17088b['id'],_0x17088b[_0x42fbae(0x117)],_0x8b7550['status'],_0x8187b0);}catch(_0x5bd6b4){console['error'](_0x42fbae(0x14e),_0x5bd6b4),loggerService_1[_0x42fbae(0xb9)][_0x42fbae(0x8b)](_0x42fbae(0x10b),_0x5bd6b4,_0x8187b0);throw _0x5bd6b4;}}async[a60_0x401dd6(0xde)](_0x591bcb){const _0xea803a=a60_0x401dd6;console[_0xea803a(0xe1)]('üîÑ\x20Processing\x20MasterCard\x20webhook:',JSON[_0xea803a(0xd9)](_0x591bcb,null,0x2));try{const _0x259eca=await this[_0xea803a(0x136)][_0xea803a(0xb8)](_0x591bcb);console[_0xea803a(0xe1)](_0xea803a(0x91),_0x259eca);if(!_0x259eca[_0xea803a(0xe5)]){console['error'](_0xea803a(0x127)),console[_0xea803a(0xc1)](_0xea803a(0xab),Object[_0xea803a(0x16c)](_0x591bcb));throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');}let _0x582863=null;console['log'](_0xea803a(0x11c)+_0x259eca['paymentId']);_0x259eca[_0xea803a(0xe5)]&&(console[_0xea803a(0xe1)]('üîç\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x582863=await database_1[_0xea803a(0xdd)][_0xea803a(0x138)]['findFirst']({'where':{'AND':[{'gateway':'mastercard'},{'OR':[{'gatewayPaymentId':_0x259eca[_0xea803a(0xe5)]},{'gatewayOrderId':_0x259eca[_0xea803a(0xe5)]},{'id':_0x259eca['paymentId']},{'orderId':_0x259eca[_0xea803a(0xe5)]}]}]}}),console[_0xea803a(0xe1)](_0xea803a(0xa3)+(_0x582863?_0xea803a(0x93)+_0x582863['id']:_0xea803a(0x135))));if(!_0x582863){console['error'](_0xea803a(0xef)+_0x259eca[_0xea803a(0xe5)]),console[_0xea803a(0xc1)](_0xea803a(0x105)+_0x259eca[_0xea803a(0xe5)]+_0xea803a(0x169)+_0x259eca[_0xea803a(0xe5)]+_0xea803a(0x143)+_0x259eca['paymentId']+'\x22');const _0x161455=await database_1['default']['payment']['findMany']({'where':{'gateway':'mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console['log'](_0xea803a(0x9f),_0x161455);return;}console[_0xea803a(0xe1)](_0xea803a(0x13f)+_0x582863['id']+_0xea803a(0xa5)+_0x582863[_0xea803a(0x117)]+_0xea803a(0xaa)+_0x259eca[_0xea803a(0x117)]),await this[_0xea803a(0xe8)](_0x582863['id'],_0x259eca[_0xea803a(0x117)]),loggerService_1[_0xea803a(0xb9)][_0xea803a(0xea)]('mastercard',_0x582863['id'],_0x582863[_0xea803a(0x117)],_0x259eca[_0xea803a(0x117)],_0x591bcb);}catch(_0x529f17){console[_0xea803a(0xc1)](_0xea803a(0x97),_0x529f17),loggerService_1[_0xea803a(0xb9)]['logWebhookError'](_0xea803a(0xc0),_0x529f17,_0x591bcb);throw _0x529f17;}}async[a60_0x401dd6(0x85)](_0x191a74){const _0xa6f3f3=a60_0x401dd6;console[_0xa6f3f3(0xe1)](_0xa6f3f3(0xb5),JSON[_0xa6f3f3(0xd9)](_0x191a74,null,0x2));try{const _0x53810b=await this[_0xa6f3f3(0x165)][_0xa6f3f3(0xb8)](_0x191a74);console[_0xa6f3f3(0xe1)](_0xa6f3f3(0xe0),_0x53810b);if(!_0x53810b[_0xa6f3f3(0xe5)]){console[_0xa6f3f3(0xc1)](_0xa6f3f3(0xbe)),console[_0xa6f3f3(0xc1)](_0xa6f3f3(0xab),Object[_0xa6f3f3(0x16c)](_0x191a74));throw new Error(_0xa6f3f3(0x90));}let _0x2e952c=null;console['log'](_0xa6f3f3(0x15d)+_0x53810b[_0xa6f3f3(0xe5)]),_0x2e952c=await database_1[_0xa6f3f3(0xdd)][_0xa6f3f3(0x138)][_0xa6f3f3(0xd4)]({'where':{'AND':[{'gateway':_0xa6f3f3(0x106)},{'OR':[{'gatewayPaymentId':_0x53810b[_0xa6f3f3(0xe5)]},{'gatewayOrderId':_0x53810b[_0xa6f3f3(0xe5)]},{'id':_0x53810b[_0xa6f3f3(0xe5)]},{'orderId':_0x53810b['paymentId']}]}]}}),console[_0xa6f3f3(0xe1)](_0xa6f3f3(0xa3)+(_0x2e952c?_0xa6f3f3(0x93)+_0x2e952c['id']:_0xa6f3f3(0x135)));if(!_0x2e952c){console[_0xa6f3f3(0xc1)](_0xa6f3f3(0xa7)+_0x53810b[_0xa6f3f3(0xe5)]);return;}console[_0xa6f3f3(0xe1)]('üìä\x20Amer\x20webhook:\x20Payment\x20'+_0x2e952c['id']+_0xa6f3f3(0xca)+_0x53810b['status']),await this[_0xa6f3f3(0xe8)](_0x2e952c['id'],_0x53810b[_0xa6f3f3(0x117)],{'cardLast4':_0x53810b[_0xa6f3f3(0x107)]?.['cardLast4'],'paymentMethod':_0x53810b[_0xa6f3f3(0x107)]?.[_0xa6f3f3(0x101)]});}catch(_0x35c761){console[_0xa6f3f3(0xc1)](_0xa6f3f3(0x133),_0x35c761),loggerService_1[_0xa6f3f3(0xb9)][_0xa6f3f3(0x8b)](_0xa6f3f3(0x106),_0x35c761,_0x191a74);throw _0x35c761;}}async['sendShopWebhook'](_0x18ef43,_0x4afe26){const _0x4fb0d5=a60_0x401dd6,_0x5a8657=Date[_0x4fb0d5(0xfd)]();try{const _0x32ac3a=_0x18ef43[_0x4fb0d5(0xf4)],_0x260234=_0x32ac3a[_0x4fb0d5(0xb7)];if(!_0x260234?.['webhookUrl']){console[_0x4fb0d5(0xe1)](_0x4fb0d5(0x154)+_0x32ac3a['id']);return;}const _0x1f6703=_0x4afe26===_0x4fb0d5(0x15f)?'payment.success':_0x4afe26===_0x4fb0d5(0xf3)?_0x4fb0d5(0x9e):_0x4afe26===_0x4fb0d5(0x8d)?'payment.failed':_0x4afe26===_0x4fb0d5(0xf0)?_0x4fb0d5(0x9e):_0x4afe26===_0x4fb0d5(0x113)?_0x4fb0d5(0x9e):_0x4fb0d5(0x11a);let _0x58cab9=[];if(_0x260234['webhookEvents'])try{_0x58cab9=Array[_0x4fb0d5(0x83)](_0x260234['webhookEvents'])?_0x260234[_0x4fb0d5(0x8c)]:JSON[_0x4fb0d5(0xa8)](_0x260234[_0x4fb0d5(0x8c)]);}catch(_0x45fb6d){console[_0x4fb0d5(0xc1)](_0x4fb0d5(0x15e),_0x45fb6d),_0x58cab9=[];}if(!_0x58cab9[_0x4fb0d5(0x108)](_0x1f6703)){console[_0x4fb0d5(0xe1)](_0x4fb0d5(0x126)+_0x1f6703+_0x4fb0d5(0x121)+_0x32ac3a['id']);return;}const _0x45ec14={'event':_0x1f6703,'payment':{'id':_0x18ef43['id'],'order_id':_0x18ef43['orderId'],'gateway_order_id':_0x18ef43[_0x4fb0d5(0x11f)],'gateway':_0x18ef43[_0x4fb0d5(0xad)],'amount':_0x18ef43[_0x4fb0d5(0x9d)],'currency':_0x18ef43[_0x4fb0d5(0x14d)],'status':_0x4afe26[_0x4fb0d5(0x102)](),'customer_email':_0x18ef43[_0x4fb0d5(0x7e)],'customer_name':_0x18ef43[_0x4fb0d5(0xe3)],'failure_message':_0x18ef43['failureMessage'],'tx_urls':_0x18ef43[_0x4fb0d5(0x7f)]?JSON[_0x4fb0d5(0xa8)](_0x18ef43['txUrls']):null,'created_at':_0x18ef43[_0x4fb0d5(0x9a)],'updated_at':_0x18ef43['updatedAt']}},_0x29d929=await fetch(_0x260234[_0x4fb0d5(0x164)],{'method':_0x4fb0d5(0xa9),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x4fb0d5(0xd9)](_0x45ec14)}),_0x3aba93=Date[_0x4fb0d5(0xfd)]()-_0x5a8657,_0x36b7c0=_0x29d929['ok']?_0x4fb0d5(0x156):await _0x29d929['text']();loggerService_1[_0x4fb0d5(0xb9)]['logShopWebhookSent'](_0x18ef43['shopId'],_0x260234[_0x4fb0d5(0x164)],_0x1f6703,_0x29d929['status'],_0x3aba93,_0x45ec14),console['log'](_0x4fb0d5(0xf8)+_0x260234[_0x4fb0d5(0x164)]+_0x4fb0d5(0x163)+_0x29d929[_0x4fb0d5(0x117)]+'\x20('+_0x3aba93+_0x4fb0d5(0x162));}catch(_0x5491d1){console['error'](_0x4fb0d5(0x159),_0x5491d1),loggerService_1[_0x4fb0d5(0xb9)][_0x4fb0d5(0x129)](_0x18ef43[_0x4fb0d5(0xe2)],_0x18ef43[_0x4fb0d5(0xf4)]?.[_0x4fb0d5(0xb7)]?.[_0x4fb0d5(0x164)]||'unknown',_0x4fb0d5(0x111),_0x5491d1,{});}}async[a60_0x401dd6(0x14a)](_0x48834a,_0x2b30bd){const _0x25dfa3=a60_0x401dd6;try{const _0x3d0c67={'PENDING':_0x25dfa3(0x14b),'PROCESSING':_0x25dfa3(0x141),'PAID':_0x25dfa3(0xc9),'FAILED':_0x25dfa3(0xf9),'EXPIRED':'expired','REFUND':_0x25dfa3(0xbb),'CHARGEBACK':_0x25dfa3(0xbc)},_0x3caf4=_0x3d0c67[_0x2b30bd];if(!_0x3caf4||_0x3caf4==='created')return;await telegramBotService_1['telegramBotService']['sendPaymentNotification'](_0x48834a[_0x25dfa3(0xe2)],_0x48834a,_0x3caf4);}catch(_0x22c9b1){console[_0x25dfa3(0xc1)](_0x25dfa3(0x131),_0x22c9b1);}}async[a60_0x401dd6(0x160)](_0xd392fd,_0x5f1c05){const _0x2204cd=a60_0x401dd6;try{const _0x426ace=await database_1[_0x2204cd(0xdd)][_0x2204cd(0xf4)][_0x2204cd(0xc3)]({'where':{'id':_0xd392fd},'select':{'gatewaySettings':!![]}});if(!_0x426ace?.[_0x2204cd(0xd0)])return console['log'](_0x2204cd(0x167)+_0xd392fd+_0x2204cd(0xf2)),0xa;const _0x4e286f=JSON['parse'](_0x426ace[_0x2204cd(0xd0)]);for(const [_0x455b7c,_0x50dbdd]of Object[_0x2204cd(0xed)](_0x4e286f)){if(_0x455b7c['toLowerCase']()===_0x5f1c05[_0x2204cd(0x102)]()){const _0x40286c=_0x50dbdd['commission']||0xa;return console[_0x2204cd(0xe1)](_0x2204cd(0x158)+_0x5f1c05+_0x2204cd(0xf6)+_0xd392fd+':\x20'+_0x40286c+'%'),_0x40286c;}}return console['log'](_0x2204cd(0xce)+_0x5f1c05+_0x2204cd(0x155)+_0xd392fd+',\x20using\x20default\x2010%'),0xa;}catch(_0x1a940d){return console[_0x2204cd(0xc1)](_0x2204cd(0xd5)+_0xd392fd+_0x2204cd(0x161)+_0x5f1c05+':',_0x1a940d),0xa;}}}exports[a60_0x401dd6(0xc2)]=WebhookService;