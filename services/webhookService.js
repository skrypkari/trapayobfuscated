'use strict';const a58_0xab4bbd=a58_0x5150;(function(_0x5aa3b9,_0x42ba12){const _0xeca5d1=a58_0x5150,_0x2446fb=_0x5aa3b9();while(!![]){try{const _0xa6fc=parseInt(_0xeca5d1(0x1e9))/0x1+-parseInt(_0xeca5d1(0x185))/0x2*(parseInt(_0xeca5d1(0x1c4))/0x3)+parseInt(_0xeca5d1(0x12f))/0x4*(parseInt(_0xeca5d1(0x152))/0x5)+parseInt(_0xeca5d1(0x168))/0x6+parseInt(_0xeca5d1(0x18b))/0x7+parseInt(_0xeca5d1(0x15a))/0x8*(-parseInt(_0xeca5d1(0x120))/0x9)+parseInt(_0xeca5d1(0x1a5))/0xa;if(_0xa6fc===_0x42ba12)break;else _0x2446fb['push'](_0x2446fb['shift']());}catch(_0x42f510){_0x2446fb['push'](_0x2446fb['shift']());}}}(a58_0x2f38,0x556cc));var __importDefault=this&&this[a58_0xab4bbd(0x1bc)]||function(_0x2baab0){return _0x2baab0&&_0x2baab0['__esModule']?_0x2baab0:{'default':_0x2baab0};};function a58_0x2f38(){const _0x5df5d1=['created','Error\x20processing\x20CoinToPay2\x20webhook:','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','error','processRapydWebhook','\x22,\x20newStatus=\x22','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','bankId','📈\x20Payment\x20details:\x20oldStatus=\x22','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','🔄\x20Processing\x20CoinToPay\x20webhook:','Error\x20processing\x20Plisio\x20webhook:','webhook_send','settings','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','amount','paymentMethod','❌\x20Payment\x20link\x20','🏪\x20Shop\x20','remitterIban','545285ipdjBo','__esModule','\x20and\x20-','\x20balance\x20updated:\x20','FAILED','\x20USDT\x20(payment\x20became\x20PAID)','amountUSDT','✅\x20Shop\x20','unknown','paymentId','processWebhook','now','payment.pending','currency','defineProperty','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','shop','./gateways/rapydService','./gateways/plisioService','27BHAgEy','processCoinToPay2Webhook','✅\x20Payment\x20link\x20','./gateways/klymeService','\x22,\x20paymentLinkId=\x22','💰\x20Adding\x20to\x20balance:\x20','\x22,\x20id=\x22','Error\x20processing\x20Noda\x20webhook:','updatedAt','includes','🔄\x20Processing\x20Plisio\x20webhook:','findFirst','payment_method','processNodaWebhook','paymentLinkId','292LFqxTF','application/json','rapyd','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','text','../config/database','PAID','orderId','loggerService','📈\x20Found\x20payment\x20link\x20','📊\x20Noda\x20webhook:\x20Payment\x20','Found\x20payment\x20','updatePaymentStatus','🔄\x20Additional\x20data:','currencyService','💰\x20Final\x20balance\x20after\x20chargeback:\x20','toLowerCase','\x20-\x20','TesSoft\x20Payment\x20System/1.0','COMPLETED','paid','failed','Error\x20parsing\x20webhook\x20events:','processKlymeWebhook','💰\x20Payment\x20','createdAt','cointopay2','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','paidAt','\x20USDT\x20(chargeback\x20penalty)','Error\x20processing\x20KLYME\x20webhook:','currentPayments','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','chargeback','./loggerService','6510qRJBLt','🔍\x20Search\x20result:\x20','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','./telegramBotService','gateway','No\x20payment\x20ID\x20in\x20Noda\x20webhook','klyme','449336RFBJBW','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','balance','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','logShopWebhookError','\x20USDT','processMasterCardWebhook','expired','\x20not\x20found','noda','📊\x20CoinToPay\x20webhook:\x20Payment\x20','payment','create','PlisioService','505848dnWtgJ','refund','\x20status\x20','NodaService','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20',':\x20type=','\x20=\x20','CoinToPayService','cointopay','webhookLog','additionalInfo',',\x20status=','\x20to\x20','💰\x20Converting\x20','REFUND','CHARGEBACK','username','Error\x20processing\x20CoinToPay\x20webhook:','📊\x20MasterCard\x20webhook\x20result:','status','mastercard','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook',',\x20newStatus=','log','rapydService','🔄\x20Processing\x20KLYME\x20webhook:','klymeService',',\x20currentPayments=','stringify','26tNFUxV','📊\x20KLYME\x20webhook:\x20Payment\x20','Payment\x20','failureMessage','customerEmail','💰\x20Removing\x20from\x20balance:\x20','2629144ZbVEVU','parse','sendShopWebhook','system','📈\x20Payment\x20','update','EXPIRED','chargebackAmount','RapydService','🔄\x20Processing\x20MasterCard\x20webhook:','paymentLink','masterCardService','\x20updated:\x20currentPayments=','Webhook\x20event\x20','SINGLE','coinToPayService','plisioService','isArray','./gateways/coinToPayService','logWebhookError','❌\x20Error\x20processing\x20MasterCard\x20webhook:','Failed\x20to\x20send\x20shop\x20webhook:','webhookEvents','keys','\x20->\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','401290TrkGPk','shopId','payment.success','🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','❌\x20Available\x20webhook\x20fields:','nodaService','🔄\x20Processing\x20Noda\x20webhook:','🔄\x20Processing\x20CoinToPay2\x20webhook:','./gateways/nodaService','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','no\x20balance\x20change','toFixed','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','💸\x20Additional\x20chargeback\x20penalty:\x20-','convertToUSDT','type','txUrls','default','findUnique','Error\x20processing\x20Rapyd\x20webhook:','\x20current\x20balance:\x20','telegramBotService','__importDefault','coinToPay2Service','logWebhookProcessed','./gateways/coinToPay2Service','cardLast4','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','toUpperCase','payment.failed','143529dzgUqs','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','📤\x20Shop\x20webhook\x20sent\x20to\x20','webhookUrl','📝\x20Reason:\x20','\x20with\x20status\x20','WebhookService','✅\x20Found\x20payment\x20','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','Success','plisio_gateway','🔄\x20Processing\x20Rapyd\x20webhook:','processPlisioWebhook','plisio','remitterName'];a58_0x2f38=function(){return _0x5df5d1;};return a58_0x2f38();}Object[a58_0xab4bbd(0x1f7)](exports,a58_0xab4bbd(0x1ea),{'value':!![]}),exports[a58_0xab4bbd(0x1cb)]=void 0x0;function a58_0x5150(_0xc550a8,_0x318c3e){const _0x2f389e=a58_0x2f38();return a58_0x5150=function(_0x5150af,_0x3b7e10){_0x5150af=_0x5150af-0x11d;let _0xd4c477=_0x2f389e[_0x5150af];return _0xd4c477;},a58_0x5150(_0xc550a8,_0x318c3e);}const database_1=__importDefault(require(a58_0xab4bbd(0x134))),plisioService_1=require(a58_0xab4bbd(0x11f)),rapydService_1=require(a58_0xab4bbd(0x11e)),nodaService_1=require(a58_0xab4bbd(0x1ad)),coinToPayService_1=require(a58_0xab4bbd(0x19d)),coinToPay2Service_1=require(a58_0xab4bbd(0x1bf)),klymeService_1=require(a58_0xab4bbd(0x123)),mastercardService_1=require('./gateways/mastercardService'),telegramBotService_1=require(a58_0xab4bbd(0x156)),currencyService_1=require('./currencyService'),loggerService_1=require(a58_0xab4bbd(0x151));class WebhookService{constructor(){const _0x14c2d9=a58_0xab4bbd;this[_0x14c2d9(0x19b)]=new plisioService_1[(_0x14c2d9(0x167))](),this[_0x14c2d9(0x180)]=new rapydService_1[(_0x14c2d9(0x193))](),this[_0x14c2d9(0x1aa)]=new nodaService_1[(_0x14c2d9(0x16b))](),this['coinToPayService']=new coinToPayService_1[(_0x14c2d9(0x16f))](),this[_0x14c2d9(0x1bd)]=new coinToPay2Service_1['CoinToPay2Service'](),this[_0x14c2d9(0x182)]=new klymeService_1['KlymeService'](),this[_0x14c2d9(0x196)]=new mastercardService_1['MasterCardService']();}async[a58_0xab4bbd(0x13b)](_0x22fb64,_0x5d124c,_0x8b6f63){const _0xee9b06=a58_0xab4bbd;console[_0xee9b06(0x17f)]('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x22fb64+_0xee9b06(0x17e)+_0x5d124c),console[_0xee9b06(0x17f)](_0xee9b06(0x13c),_0x8b6f63),await database_1[_0xee9b06(0x1b7)]['$transaction'](async _0x1e9bc3=>{const _0x4a55b1=_0xee9b06,_0x3f908c=await _0x1e9bc3[_0x4a55b1(0x165)]['findUnique']({'where':{'id':_0x22fb64},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3f908c)throw new Error(_0x4a55b1(0x187)+_0x22fb64+'\x20not\x20found');const _0x5e3240=_0x3f908c['status'],_0x21e08a=_0x3f908c['shop'];console['log'](_0x4a55b1(0x147)+_0x22fb64+':\x20'+_0x5e3240+'\x20->\x20'+_0x5d124c),console[_0x4a55b1(0x17f)](_0x4a55b1(0x1e7)+_0x21e08a['username']+_0x4a55b1(0x1ba)+_0x21e08a['balance']+_0x4a55b1(0x15f));const _0x59ed13={'status':_0x5d124c['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x4a55b1(0x18e),'statusChangedAt':new Date()};_0x8b6f63?.['failureMessage']&&(_0x59ed13['failureMessage']=_0x8b6f63[_0x4a55b1(0x188)]);_0x8b6f63?.[_0x4a55b1(0x1b6)]&&(_0x59ed13['txUrls']=JSON['stringify'](_0x8b6f63[_0x4a55b1(0x1b6)]));_0x8b6f63?.['cardLast4']&&(_0x59ed13[_0x4a55b1(0x1c0)]=_0x8b6f63['cardLast4']);_0x8b6f63?.[_0x4a55b1(0x1e5)]&&(_0x59ed13[_0x4a55b1(0x1e5)]=_0x8b6f63[_0x4a55b1(0x1e5)]);_0x8b6f63?.[_0x4a55b1(0x1dc)]&&(_0x59ed13[_0x4a55b1(0x1dc)]=_0x8b6f63[_0x4a55b1(0x1dc)]);_0x8b6f63?.[_0x4a55b1(0x1e8)]&&(_0x59ed13['remitterIban']=_0x8b6f63[_0x4a55b1(0x1e8)]);_0x8b6f63?.[_0x4a55b1(0x1d3)]&&(_0x59ed13[_0x4a55b1(0x1d3)]=_0x8b6f63[_0x4a55b1(0x1d3)]);let _0x2e3552=_0x21e08a[_0x4a55b1(0x15c)],_0x47bff6='';if(_0x5d124c[_0x4a55b1(0x1c2)]()===_0x4a55b1(0x135)&&_0x5e3240!==_0x4a55b1(0x135)){const _0x2e4f15=await currencyService_1[_0x4a55b1(0x13d)][_0x4a55b1(0x1b4)](_0x3f908c[_0x4a55b1(0x1e4)],_0x3f908c['currency']);_0x2e3552+=_0x2e4f15,_0x47bff6='+'+_0x2e4f15[_0x4a55b1(0x1b0)](0x6)+_0x4a55b1(0x1ee),_0x59ed13['amountUSDT']=_0x2e4f15,_0x59ed13[_0x4a55b1(0x14b)]=new Date(),console[_0x4a55b1(0x17f)](_0x4a55b1(0x175)+_0x3f908c[_0x4a55b1(0x1e4)]+'\x20'+_0x3f908c[_0x4a55b1(0x1f6)]+'\x20->\x20'+_0x2e4f15[_0x4a55b1(0x1b0)](0x6)+_0x4a55b1(0x15f)),console['log'](_0x4a55b1(0x125)+_0x21e08a[_0x4a55b1(0x15c)]+'\x20+\x20'+_0x2e4f15[_0x4a55b1(0x1b0)](0x6)+_0x4a55b1(0x16e)+_0x2e3552['toFixed'](0x6)+_0x4a55b1(0x15f));}else{if(_0x5e3240===_0x4a55b1(0x135)&&_0x5d124c[_0x4a55b1(0x1c2)]()!==_0x4a55b1(0x135)){const _0x1cc8be=_0x3f908c[_0x4a55b1(0x1ef)];_0x1cc8be&&(_0x2e3552-=_0x1cc8be,_0x47bff6='-'+_0x1cc8be[_0x4a55b1(0x1b0)](0x6)+_0x4a55b1(0x1c6),_0x59ed13[_0x4a55b1(0x1ef)]=null,_0x59ed13['paidAt']=null,console['log'](_0x4a55b1(0x18a)+_0x21e08a[_0x4a55b1(0x15c)]+_0x4a55b1(0x140)+_0x1cc8be['toFixed'](0x6)+_0x4a55b1(0x16e)+_0x2e3552[_0x4a55b1(0x1b0)](0x6)+_0x4a55b1(0x15f)));}}if(_0x5d124c['toUpperCase']()===_0x4a55b1(0x177)){const _0x4df838=_0x8b6f63?.[_0x4a55b1(0x192)]||0x0;_0x4df838>0x0&&(_0x2e3552-=_0x4df838,_0x47bff6+=_0x4a55b1(0x1eb)+_0x4df838['toFixed'](0x6)+_0x4a55b1(0x14c),_0x59ed13['chargebackAmount']=_0x4df838,console[_0x4a55b1(0x17f)](_0x4a55b1(0x1b3)+_0x4df838[_0x4a55b1(0x1b0)](0x6)+_0x4a55b1(0x15f)),console['log'](_0x4a55b1(0x13e)+_0x2e3552['toFixed'](0x6)+_0x4a55b1(0x15f)));}const _0x237ccb=await _0x1e9bc3['payment'][_0x4a55b1(0x190)]({'where':{'id':_0x22fb64},'data':_0x59ed13});_0x2e3552!==_0x21e08a[_0x4a55b1(0x15c)]&&(await _0x1e9bc3[_0x4a55b1(0x11d)][_0x4a55b1(0x190)]({'where':{'id':_0x21e08a['id']},'data':{'balance':_0x2e3552}}),console[_0x4a55b1(0x17f)](_0x4a55b1(0x1f0)+_0x21e08a[_0x4a55b1(0x178)]+_0x4a55b1(0x1ec)+_0x21e08a[_0x4a55b1(0x15c)]['toFixed'](0x6)+_0x4a55b1(0x1a3)+_0x2e3552[_0x4a55b1(0x1b0)](0x6)+_0x4a55b1(0x15f)),console[_0x4a55b1(0x17f)](_0x4a55b1(0x1c9)+_0x47bff6));await _0x1e9bc3[_0x4a55b1(0x171)][_0x4a55b1(0x166)]({'data':{'paymentId':_0x22fb64,'shopId':_0x21e08a['id'],'event':'webhook_status_change_'+_0x5d124c[_0x4a55b1(0x13f)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x5e3240,'newStatus':_0x5d124c[_0x4a55b1(0x1c2)](),'balanceChange':_0x47bff6||_0x4a55b1(0x1af),'oldBalance':_0x21e08a[_0x4a55b1(0x15c)],'newBalance':_0x2e3552,'amountUSDT':_0x59ed13[_0x4a55b1(0x1ef)],'additionalData':_0x8b6f63,'timestamp':new Date()['toISOString']()})}}),await this[_0x4a55b1(0x18d)]({..._0x3f908c,..._0x237ccb,'shop':_0x21e08a},_0x5d124c[_0x4a55b1(0x1c2)]()),await this['sendPaymentStatusNotification']({..._0x3f908c,..._0x237ccb},_0x5d124c[_0x4a55b1(0x1c2)]());if(_0x5e3240!==_0x4a55b1(0x135)&&_0x5d124c[_0x4a55b1(0x1c2)]()===_0x4a55b1(0x135)){console[_0x4a55b1(0x17f)](_0x4a55b1(0x18f)+_0x22fb64+_0x4a55b1(0x1ae)),console[_0x4a55b1(0x17f)](_0x4a55b1(0x1dd)+_0x5e3240+_0x4a55b1(0x1da)+_0x5d124c[_0x4a55b1(0x1c2)]()+_0x4a55b1(0x124)+_0x3f908c[_0x4a55b1(0x12e)]+'\x22');if(_0x3f908c[_0x4a55b1(0x12e)])try{const _0x2c4e63=await _0x1e9bc3[_0x4a55b1(0x195)][_0x4a55b1(0x1b8)]({'where':{'id':_0x3f908c[_0x4a55b1(0x12e)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x2c4e63){console[_0x4a55b1(0x17f)](_0x4a55b1(0x138)+_0x2c4e63['id']+_0x4a55b1(0x16d)+_0x2c4e63['type']+_0x4a55b1(0x183)+_0x2c4e63[_0x4a55b1(0x14e)]+_0x4a55b1(0x173)+_0x2c4e63[_0x4a55b1(0x17b)]);const _0x3518c7=_0x2c4e63[_0x4a55b1(0x14e)]+0x1,_0x137ea4=_0x2c4e63[_0x4a55b1(0x1b5)]===_0x4a55b1(0x199)?_0x4a55b1(0x142):_0x2c4e63[_0x4a55b1(0x17b)];await _0x1e9bc3[_0x4a55b1(0x195)]['update']({'where':{'id':_0x3f908c['paymentLinkId']},'data':{'currentPayments':_0x3518c7,'status':_0x137ea4,'updatedAt':new Date()}}),console[_0x4a55b1(0x17f)](_0x4a55b1(0x122)+_0x2c4e63['id']+_0x4a55b1(0x197)+_0x2c4e63[_0x4a55b1(0x14e)]+_0x4a55b1(0x1a3)+_0x3518c7+_0x4a55b1(0x173)+_0x2c4e63[_0x4a55b1(0x17b)]+_0x4a55b1(0x1a3)+_0x137ea4);}else console[_0x4a55b1(0x17f)](_0x4a55b1(0x1e6)+_0x3f908c['paymentLinkId']+_0x4a55b1(0x162));}catch(_0x12e263){console[_0x4a55b1(0x1d8)](_0x4a55b1(0x15d),_0x12e263);}else console[_0x4a55b1(0x17f)](_0x4a55b1(0x18f)+_0x22fb64+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0x4a55b1(0x17f)](_0x4a55b1(0x18f)+_0x22fb64+_0x4a55b1(0x1c1)+_0x5e3240+_0x4a55b1(0x1a3)+_0x5d124c[_0x4a55b1(0x1c2)]());});}async[a58_0xab4bbd(0x1d1)](_0xe312c6){const _0x43c1b0=a58_0xab4bbd;console[_0x43c1b0(0x17f)](_0x43c1b0(0x12a),_0xe312c6);try{const _0x5ad8b8=await this[_0x43c1b0(0x19b)]['processWebhook'](_0xe312c6);if(!_0x5ad8b8[_0x43c1b0(0x1f2)])throw new Error(_0x43c1b0(0x1db));const _0x215719=await database_1[_0x43c1b0(0x1b7)][_0x43c1b0(0x165)]['findFirst']({'where':{'gatewayOrderId':_0x5ad8b8['paymentId']}});if(!_0x215719){console[_0x43c1b0(0x1d8)](_0x43c1b0(0x1de)+_0x5ad8b8[_0x43c1b0(0x1f2)]);return;}console[_0x43c1b0(0x17f)]('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0x215719['id']+_0x43c1b0(0x16a)+_0x5ad8b8[_0x43c1b0(0x17b)]),await this[_0x43c1b0(0x13b)](_0x215719['id'],_0x5ad8b8['status'],{'txUrls':_0x5ad8b8[_0x43c1b0(0x1b6)]}),loggerService_1[_0x43c1b0(0x137)][_0x43c1b0(0x1be)](_0x43c1b0(0x1d2),_0x215719['id'],_0x215719[_0x43c1b0(0x17b)],_0x5ad8b8[_0x43c1b0(0x17b)],_0xe312c6);}catch(_0x53b611){console[_0x43c1b0(0x1d8)](_0x43c1b0(0x1e0),_0x53b611),loggerService_1[_0x43c1b0(0x137)][_0x43c1b0(0x19e)](_0x43c1b0(0x1d2),_0x53b611,_0xe312c6);throw _0x53b611;}}async['processPlisioGatewayWebhook'](_0x3e35c7){const _0x4f55a7=a58_0xab4bbd;console[_0x4f55a7(0x17f)](_0x4f55a7(0x154),_0x3e35c7);try{const _0x2a2d96=await this[_0x4f55a7(0x19b)]['processWebhook'](_0x3e35c7);if(!_0x2a2d96[_0x4f55a7(0x1f2)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x143e05=await database_1[_0x4f55a7(0x1b7)][_0x4f55a7(0x165)][_0x4f55a7(0x12b)]({'where':{'gatewayOrderId':_0x2a2d96[_0x4f55a7(0x1f2)]}});if(!_0x143e05){console['error'](_0x4f55a7(0x1d7)+_0x2a2d96[_0x4f55a7(0x1f2)]);return;}console[_0x4f55a7(0x17f)](_0x4f55a7(0x14f)+_0x143e05['id']+_0x4f55a7(0x16a)+_0x2a2d96['status']),await this['updatePaymentStatus'](_0x143e05['id'],_0x2a2d96[_0x4f55a7(0x17b)],{'txUrls':_0x2a2d96[_0x4f55a7(0x1b6)]}),loggerService_1[_0x4f55a7(0x137)]['logWebhookProcessed'](_0x4f55a7(0x1cf),_0x143e05['id'],_0x143e05[_0x4f55a7(0x17b)],_0x2a2d96[_0x4f55a7(0x17b)],_0x3e35c7);}catch(_0x52d27e){console[_0x4f55a7(0x1d8)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x52d27e),loggerService_1[_0x4f55a7(0x137)]['logWebhookError'](_0x4f55a7(0x1cf),_0x52d27e,_0x3e35c7);throw _0x52d27e;}}async[a58_0xab4bbd(0x1d9)](_0x5dd96e){const _0x2930b8=a58_0xab4bbd;console[_0x2930b8(0x17f)](_0x2930b8(0x1d0),_0x5dd96e);try{const _0x568e31=await this[_0x2930b8(0x180)][_0x2930b8(0x1f3)](_0x5dd96e);if(!_0x568e31[_0x2930b8(0x1f2)])throw new Error(_0x2930b8(0x1f9));const _0xaf47c6=await database_1[_0x2930b8(0x1b7)][_0x2930b8(0x165)][_0x2930b8(0x12b)]({'where':{'gatewayOrderId':_0x568e31[_0x2930b8(0x1f2)]}});if(!_0xaf47c6){console['error']('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x568e31[_0x2930b8(0x1f2)]);return;}console[_0x2930b8(0x17f)]('📊\x20Rapyd\x20webhook:\x20Payment\x20'+_0xaf47c6['id']+_0x2930b8(0x16a)+_0x568e31[_0x2930b8(0x17b)]),await this['updatePaymentStatus'](_0xaf47c6['id'],_0x568e31[_0x2930b8(0x17b)],{'failureMessage':_0x568e31[_0x2930b8(0x188)],'cardLast4':_0x568e31[_0x2930b8(0x172)]?.[_0x2930b8(0x1c0)],'paymentMethod':_0x568e31['additionalInfo']?.[_0x2930b8(0x1e5)]}),loggerService_1[_0x2930b8(0x137)][_0x2930b8(0x1be)](_0x2930b8(0x131),_0xaf47c6['id'],_0xaf47c6[_0x2930b8(0x17b)],_0x568e31['status'],_0x5dd96e);}catch(_0x2f3769){console[_0x2930b8(0x1d8)](_0x2930b8(0x1b9),_0x2f3769),loggerService_1[_0x2930b8(0x137)]['logWebhookError'](_0x2930b8(0x131),_0x2f3769,_0x5dd96e);throw _0x2f3769;}}async[a58_0xab4bbd(0x12d)](_0x3751c0){const _0x1375c1=a58_0xab4bbd;console['log'](_0x1375c1(0x1ab),_0x3751c0);try{const _0x26a97d=await this[_0x1375c1(0x1aa)][_0x1375c1(0x1f3)](_0x3751c0);if(!_0x26a97d[_0x1375c1(0x1f2)])throw new Error(_0x1375c1(0x158));const _0x28bc25=await database_1[_0x1375c1(0x1b7)][_0x1375c1(0x165)]['findFirst']({'where':{'gatewayOrderId':_0x26a97d[_0x1375c1(0x1f2)]}});if(!_0x28bc25){console['error'](_0x1375c1(0x1cd)+_0x26a97d[_0x1375c1(0x1f2)]);return;}console[_0x1375c1(0x17f)](_0x1375c1(0x139)+_0x28bc25['id']+_0x1375c1(0x16a)+_0x26a97d[_0x1375c1(0x17b)]),await this['updatePaymentStatus'](_0x28bc25['id'],_0x26a97d['status'],{'bankId':_0x26a97d[_0x1375c1(0x172)]?.[_0x1375c1(0x1dc)],'remitterIban':_0x26a97d['additionalInfo']?.[_0x1375c1(0x1e8)],'remitterName':_0x26a97d[_0x1375c1(0x172)]?.['remitterName']}),loggerService_1['loggerService']['logWebhookProcessed'](_0x1375c1(0x163),_0x28bc25['id'],_0x28bc25['status'],_0x26a97d[_0x1375c1(0x17b)],_0x3751c0);}catch(_0x57d7c2){console['error'](_0x1375c1(0x127),_0x57d7c2),loggerService_1[_0x1375c1(0x137)][_0x1375c1(0x19e)](_0x1375c1(0x163),_0x57d7c2,_0x3751c0);throw _0x57d7c2;}}async['processCoinToPayWebhook'](_0x10d8dc){const _0x42e784=a58_0xab4bbd;console[_0x42e784(0x17f)](_0x42e784(0x1df),_0x10d8dc);try{const _0x438bd9=await this[_0x42e784(0x19a)]['processWebhook'](_0x10d8dc);if(!_0x438bd9[_0x42e784(0x1f2)])throw new Error(_0x42e784(0x17d));const _0x47a869=await database_1[_0x42e784(0x1b7)][_0x42e784(0x165)][_0x42e784(0x12b)]({'where':{'gatewayOrderId':_0x438bd9[_0x42e784(0x1f2)]}});if(!_0x47a869){console[_0x42e784(0x1d8)](_0x42e784(0x14a)+_0x438bd9[_0x42e784(0x1f2)]);return;}console[_0x42e784(0x17f)](_0x42e784(0x164)+_0x47a869['id']+_0x42e784(0x16a)+_0x438bd9[_0x42e784(0x17b)]),await this[_0x42e784(0x13b)](_0x47a869['id'],_0x438bd9[_0x42e784(0x17b)]),loggerService_1['loggerService'][_0x42e784(0x1be)]('cointopay',_0x47a869['id'],_0x47a869[_0x42e784(0x17b)],_0x438bd9[_0x42e784(0x17b)],_0x10d8dc);}catch(_0x5cc335){console[_0x42e784(0x1d8)](_0x42e784(0x179),_0x5cc335),loggerService_1[_0x42e784(0x137)][_0x42e784(0x19e)](_0x42e784(0x170),_0x5cc335,_0x10d8dc);throw _0x5cc335;}}async[a58_0xab4bbd(0x121)](_0x29cf4a){const _0x210123=a58_0xab4bbd;console[_0x210123(0x17f)](_0x210123(0x1ac),_0x29cf4a);try{const _0x22d1ab=await this['coinToPay2Service']['processWebhook'](_0x29cf4a);if(!_0x22d1ab[_0x210123(0x1f2)])throw new Error(_0x210123(0x155));const _0x390fcb=await database_1[_0x210123(0x1b7)][_0x210123(0x165)][_0x210123(0x12b)]({'where':{'gatewayOrderId':_0x22d1ab[_0x210123(0x1f2)]}});if(!_0x390fcb){console[_0x210123(0x1d8)](_0x210123(0x1d6)+_0x22d1ab[_0x210123(0x1f2)]);return;}console['log'](_0x210123(0x15b)+_0x390fcb['id']+_0x210123(0x16a)+_0x22d1ab[_0x210123(0x17b)]),await this[_0x210123(0x13b)](_0x390fcb['id'],_0x22d1ab[_0x210123(0x17b)]),loggerService_1[_0x210123(0x137)]['logWebhookProcessed'](_0x210123(0x149),_0x390fcb['id'],_0x390fcb['status'],_0x22d1ab[_0x210123(0x17b)],_0x29cf4a);}catch(_0x274ab1){console[_0x210123(0x1d8)](_0x210123(0x1d5),_0x274ab1),loggerService_1[_0x210123(0x137)][_0x210123(0x19e)]('cointopay2',_0x274ab1,_0x29cf4a);throw _0x274ab1;}}async[a58_0xab4bbd(0x146)](_0x3b1d81){const _0x3316af=a58_0xab4bbd;console[_0x3316af(0x17f)](_0x3316af(0x181),_0x3b1d81);try{const _0x493171=await this[_0x3316af(0x182)]['processWebhook'](_0x3b1d81);if(!_0x493171[_0x3316af(0x1f2)])throw new Error(_0x3316af(0x1e3));const _0x483f58=await database_1['default'][_0x3316af(0x165)][_0x3316af(0x12b)]({'where':{'gatewayOrderId':_0x493171[_0x3316af(0x1f2)]}});if(!_0x483f58){console['error'](_0x3316af(0x16c)+_0x493171[_0x3316af(0x1f2)]);return;}console['log'](_0x3316af(0x186)+_0x483f58['id']+'\x20status\x20'+_0x493171['status']),await this[_0x3316af(0x13b)](_0x483f58['id'],_0x493171[_0x3316af(0x17b)],{'paymentMethod':_0x493171[_0x3316af(0x172)]?.[_0x3316af(0x12c)]}),loggerService_1[_0x3316af(0x137)]['logWebhookProcessed'](_0x3316af(0x159),_0x483f58['id'],_0x483f58[_0x3316af(0x17b)],_0x493171[_0x3316af(0x17b)],_0x3b1d81);}catch(_0xbfe31e){console['error'](_0x3316af(0x14d),_0xbfe31e),loggerService_1[_0x3316af(0x137)][_0x3316af(0x19e)]('klyme',_0xbfe31e,_0x3b1d81);throw _0xbfe31e;}}async[a58_0xab4bbd(0x160)](_0x264be9){const _0x53ed69=a58_0xab4bbd;console['log'](_0x53ed69(0x194),JSON[_0x53ed69(0x184)](_0x264be9,null,0x2));try{const _0x4b8645=await this[_0x53ed69(0x196)][_0x53ed69(0x1f3)](_0x264be9);console[_0x53ed69(0x17f)](_0x53ed69(0x17a),_0x4b8645);if(!_0x4b8645['paymentId']){console[_0x53ed69(0x1d8)](_0x53ed69(0x1c5)),console['error'](_0x53ed69(0x1a9),Object[_0x53ed69(0x1a2)](_0x264be9));throw new Error(_0x53ed69(0x1b1));}let _0x259e42=null;console[_0x53ed69(0x17f)]('🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x4b8645[_0x53ed69(0x1f2)]);_0x4b8645['paymentId']&&(console[_0x53ed69(0x17f)](_0x53ed69(0x1f8)),_0x259e42=await database_1[_0x53ed69(0x1b7)][_0x53ed69(0x165)][_0x53ed69(0x12b)]({'where':{'AND':[{'gateway':_0x53ed69(0x17c)},{'OR':[{'gatewayPaymentId':_0x4b8645['paymentId']},{'gatewayOrderId':_0x4b8645['paymentId']},{'id':_0x4b8645['paymentId']},{'orderId':_0x4b8645[_0x53ed69(0x1f2)]}]}]}}),console[_0x53ed69(0x17f)](_0x53ed69(0x153)+(_0x259e42?_0x53ed69(0x13a)+_0x259e42['id']:'Payment\x20not\x20found')));if(!_0x259e42){console[_0x53ed69(0x1d8)]('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x4b8645['paymentId']),console[_0x53ed69(0x1d8)](_0x53ed69(0x1b2)+_0x4b8645['paymentId']+_0x53ed69(0x126)+_0x4b8645[_0x53ed69(0x1f2)]+'\x22,\x20orderId=\x22'+_0x4b8645[_0x53ed69(0x1f2)]+'\x22');const _0x1fbcaa=await database_1[_0x53ed69(0x1b7)][_0x53ed69(0x165)]['findMany']({'where':{'gateway':_0x53ed69(0x17c)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console['log'](_0x53ed69(0x1a8),_0x1fbcaa);return;}console['log'](_0x53ed69(0x1cc)+_0x259e42['id']+'\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20'+_0x259e42[_0x53ed69(0x17b)]+_0x53ed69(0x174)+_0x4b8645['status']),await this['updatePaymentStatus'](_0x259e42['id'],_0x4b8645[_0x53ed69(0x17b)]),loggerService_1[_0x53ed69(0x137)][_0x53ed69(0x1be)]('mastercard',_0x259e42['id'],_0x259e42['status'],_0x4b8645['status'],_0x264be9);}catch(_0x5145be){console[_0x53ed69(0x1d8)](_0x53ed69(0x19f),_0x5145be),loggerService_1[_0x53ed69(0x137)][_0x53ed69(0x19e)](_0x53ed69(0x17c),_0x5145be,_0x264be9);throw _0x5145be;}}async['sendShopWebhook'](_0x851dec,_0x40f72c){const _0x504a82=a58_0xab4bbd,_0x22240f=Date[_0x504a82(0x1f4)]();try{const _0x1191cc=_0x851dec[_0x504a82(0x11d)],_0x12e492=_0x1191cc['settings'];if(!_0x12e492?.[_0x504a82(0x1c8)]){console[_0x504a82(0x17f)](_0x504a82(0x132)+_0x1191cc['id']);return;}const _0x128bd8=_0x40f72c===_0x504a82(0x135)?_0x504a82(0x1a7):_0x40f72c===_0x504a82(0x1ed)?'payment.failed':_0x40f72c===_0x504a82(0x191)?_0x504a82(0x1c3):_0x40f72c===_0x504a82(0x177)?_0x504a82(0x1c3):_0x40f72c===_0x504a82(0x176)?_0x504a82(0x1c3):_0x504a82(0x1f5);let _0x20709a=[];if(_0x12e492[_0x504a82(0x1a1)])try{_0x20709a=Array[_0x504a82(0x19c)](_0x12e492[_0x504a82(0x1a1)])?_0x12e492[_0x504a82(0x1a1)]:JSON[_0x504a82(0x18c)](_0x12e492[_0x504a82(0x1a1)]);}catch(_0x4c74f9){console[_0x504a82(0x1d8)](_0x504a82(0x145),_0x4c74f9),_0x20709a=[];}if(!_0x20709a[_0x504a82(0x129)](_0x128bd8)){console['log'](_0x504a82(0x198)+_0x128bd8+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1191cc['id']);return;}const _0x51f0f4={'event':_0x128bd8,'payment':{'id':_0x851dec['id'],'order_id':_0x851dec[_0x504a82(0x136)],'gateway_order_id':_0x851dec['gatewayOrderId'],'gateway':_0x851dec[_0x504a82(0x157)],'amount':_0x851dec[_0x504a82(0x1e4)],'currency':_0x851dec[_0x504a82(0x1f6)],'status':_0x40f72c['toLowerCase'](),'customer_email':_0x851dec[_0x504a82(0x189)],'customer_name':_0x851dec['customerName'],'failure_message':_0x851dec[_0x504a82(0x188)],'tx_urls':_0x851dec[_0x504a82(0x1b6)]?JSON[_0x504a82(0x18c)](_0x851dec[_0x504a82(0x1b6)]):null,'created_at':_0x851dec[_0x504a82(0x148)],'updated_at':_0x851dec[_0x504a82(0x128)]}},_0x420cdc=await fetch(_0x12e492[_0x504a82(0x1c8)],{'method':'POST','headers':{'Content-Type':_0x504a82(0x130),'User-Agent':_0x504a82(0x141)},'body':JSON[_0x504a82(0x184)](_0x51f0f4)}),_0x10f0e2=Date[_0x504a82(0x1f4)]()-_0x22240f,_0x5e35b8=_0x420cdc['ok']?_0x504a82(0x1ce):await _0x420cdc[_0x504a82(0x133)]();loggerService_1[_0x504a82(0x137)]['logShopWebhookSent'](_0x851dec[_0x504a82(0x1a6)],_0x12e492[_0x504a82(0x1c8)],_0x128bd8,_0x420cdc[_0x504a82(0x17b)],_0x10f0e2,_0x51f0f4),console['log'](_0x504a82(0x1c7)+_0x12e492[_0x504a82(0x1c8)]+_0x504a82(0x1ca)+_0x420cdc[_0x504a82(0x17b)]+'\x20('+_0x10f0e2+'ms)');}catch(_0x4005dd){console[_0x504a82(0x1d8)](_0x504a82(0x1a0),_0x4005dd),loggerService_1[_0x504a82(0x137)][_0x504a82(0x15e)](_0x851dec[_0x504a82(0x1a6)],_0x851dec[_0x504a82(0x11d)]?.[_0x504a82(0x1e2)]?.[_0x504a82(0x1c8)]||_0x504a82(0x1f1),_0x504a82(0x1e1),_0x4005dd,{});}}async['sendPaymentStatusNotification'](_0x33740c,_0x42df46){const _0x532096=a58_0xab4bbd;try{const _0xdeef24={'PENDING':_0x532096(0x1d4),'PROCESSING':'processing','PAID':_0x532096(0x143),'FAILED':_0x532096(0x144),'EXPIRED':_0x532096(0x161),'REFUND':_0x532096(0x169),'CHARGEBACK':_0x532096(0x150)},_0x22d79b=_0xdeef24[_0x42df46];if(!_0x22d79b||_0x22d79b==='created')return;await telegramBotService_1[_0x532096(0x1bb)]['sendPaymentNotification'](_0x33740c[_0x532096(0x1a6)],_0x33740c,_0x22d79b);}catch(_0x5c88e2){console['error'](_0x532096(0x1a4),_0x5c88e2);}}}exports[a58_0xab4bbd(0x1cb)]=WebhookService;