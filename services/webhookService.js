'use strict';const a60_0x5d58e5=a60_0x5f48;(function(_0x23f010,_0x17b375){const _0x2f9a09=a60_0x5f48,_0x26ad00=_0x23f010();while(!![]){try{const _0x45c06f=parseInt(_0x2f9a09(0x285))/0x1+-parseInt(_0x2f9a09(0x2d8))/0x2+-parseInt(_0x2f9a09(0x24f))/0x3+-parseInt(_0x2f9a09(0x1f8))/0x4+parseInt(_0x2f9a09(0x2c3))/0x5+-parseInt(_0x2f9a09(0x27c))/0x6*(-parseInt(_0x2f9a09(0x247))/0x7)+parseInt(_0x2f9a09(0x2b2))/0x8;if(_0x45c06f===_0x17b375)break;else _0x26ad00['push'](_0x26ad00['shift']());}catch(_0x40e474){_0x26ad00['push'](_0x26ad00['shift']());}}}(a60_0xd6af,0x4c308));function a60_0xd6af(){const _0x422ffc=['❌\x20Error\x20processing\x20Amer\x20webhook:',':\x20type=','findUnique','📤\x20Shop\x20webhook\x20sent\x20to\x20','🔄\x20Processing\x20Amer\x20webhook:','remitterName','includes','🔄\x20Processing\x20Rapyd\x20webhook:','🔄\x20updatePaymentStatus\x20called:\x20paymentId=','processWebhook','PAID','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','default','processMasterCardWebhook','getGatewayCommission','toUpperCase','✅\x20Shop\x20','gatewayOrderId','refund','processRapydWebhook','stringify','failureMessage','orderId','plisio_gateway','processing','5123136mwiFtA','💰\x20Amount\x20after\x20gateway\x20commission:\x20','📊\x20CoinToPay\x20webhook:\x20Payment\x20','payment','masterCardService','\x20USDT','🔄\x20Additional\x20data:','createdAt','Success','\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter','currency','AmerService','__importDefault','findFirst','updatePaymentStatus','klyme','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','1430295lOrTMf','\x20to\x20',',\x20currentPayments=','loggerService','processCoinToPay2Webhook','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','webhook_send','ms)','🔄\x20Processing\x20Plisio\x20webhook:','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','remitterIban','💰\x20Converting\x20','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','convertToUSDT','🔍\x20Search\x20result:\x20','noda','error','paymentLink','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','1102418DDxvYK','🔄\x20Processing\x20Noda\x20webhook:','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','webhook_status_change_',',\x20newStatus=','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','logWebhookProcessed','./loggerService','./gateways/coinToPayService','\x20commission:\x20','POST','amountUSDT','sendPaymentStatusNotification','1976352hpFSsZ','payment_method','payment.pending','\x20commission\x20for\x20shop\x20','rapydService','toISOString','txUrls','./gateways/mastercardService','🏪\x20Shop\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook',',\x20status=','\x20=\x20','chargebackAmount','additionalInfo','entries','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','🔄\x20Processing\x20CoinToPay2\x20webhook:','__esModule','application/json','paymentLinkId','TesSoft\x20Payment\x20System/1.0','webhookUrl','log','COMPLETED','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','shopId','status','./gateways/rapydService','🔄\x20Processing\x20KLYME\x20webhook:','\x22,\x20paymentLinkId=\x22','gatewaySettings','bankId','KlymeService','unknown','✅\x20Payment\x20link\x20','isArray','processAmerWebhook','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','🔄\x20Processing\x20MasterCard\x20webhook:','\x20current\x20balance:\x20','failed','processNodaWebhook','NodaService','Error\x20processing\x20Noda\x20webhook:','amountAfterGatewayCommissionUSDT','currencyService','amer','parse','Found\x20payment\x20','paidAt','system','update','create','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','./gateways/amerService','rapyd','MasterCardService','\x20with\x20status\x20','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','payment.failed','PlisioService','webhookLog','amount','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','\x20status\x20','CoinToPay2Service','paymentId','SINGLE','💰\x20Adding\x20to\x20balance:\x20','customerName','toFixed','keys','cardLast4','REFUND','logShopWebhookError','settings','gateway','1253YbOMMr','\x20not\x20enabled\x20for\x20shop\x20','sendShopWebhook','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','./gateways/klymeService','commission','coinToPay2Service','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','806388gsOdDV','no\x20balance\x20change','🔄\x20Processing\x20CoinToPay\x20webhook:','📊\x20Noda\x20webhook:\x20Payment\x20','plisio','logWebhookError','📈\x20Payment\x20','📈\x20Found\x20payment\x20link\x20','cointopay','telegramBotService','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','Error\x20processing\x20CoinToPay2\x20webhook:','%\x20gateway\x20commission)','No\x20payment\x20ID\x20in\x20Amer\x20webhook','shop','balance','\x20->\x20','paymentMethod','💸\x20Additional\x20chargeback\x20penalty:\x20-','💰\x20Payment\x20','amerService','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','RapydService','nodaService','defineProperty','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','created','updatedAt','Error\x20processing\x20Plisio\x20webhook:','📊\x20Rapyd\x20webhook:\x20Payment\x20','Webhook\x20event\x20','FAILED','klymeService',',\x20gateway\x20','💰\x20Final\x20balance\x20after\x20chargeback:\x20','./gateways/plisioService','💰\x20Removing\x20from\x20balance:\x20','sendPaymentNotification','mastercard','\x20USDT\x20(chargeback\x20penalty)','findMany','processPlisioGatewayWebhook','webhookEvents','Error\x20parsing\x20webhook\x20events:','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','6294AyybpS','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20and\x20-','📈\x20Payment\x20details:\x20oldStatus=\x22','❌\x20Payment\x20link\x20','currentPayments','processCoinToPayWebhook','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22',',\x20using\x20default\x20commission\x2010%','511943uxeCtX','payment.success','plisioService','CoinToPayService','type','Payment\x20not\x20found','./gateways/coinToPay2Service','📊\x20MasterCard\x20webhook\x20result:','📊\x20Amer\x20webhook:\x20Payment\x20','toLowerCase','./gateways/nodaService','logShopWebhookSent','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','❌\x20Available\x20webhook\x20fields:','text','EXPIRED','now','\x22,\x20orderId=\x22','cointopay2'];a60_0xd6af=function(){return _0x422ffc;};return a60_0xd6af();}var __importDefault=this&&this[a60_0x5d58e5(0x2be)]||function(_0x16d072){const _0x59d17d=a60_0x5d58e5;return _0x16d072&&_0x16d072[_0x59d17d(0x20a)]?_0x16d072:{'default':_0x16d072};};Object[a60_0x5d58e5(0x267)](exports,a60_0x5d58e5(0x20a),{'value':!![]}),exports['WebhookService']=void 0x0;function a60_0x5f48(_0x1d344f,_0x2483ca){const _0xd6af73=a60_0xd6af();return a60_0x5f48=function(_0x5f48f3,_0x14d036){_0x5f48f3=_0x5f48f3-0x1ec;let _0x2639ff=_0xd6af73[_0x5f48f3];return _0x2639ff;},a60_0x5f48(_0x1d344f,_0x2483ca);}const database_1=__importDefault(require('../config/database')),plisioService_1=require(a60_0x5d58e5(0x272)),rapydService_1=require(a60_0x5d58e5(0x214)),nodaService_1=require(a60_0x5d58e5(0x28f)),coinToPayService_1=require(a60_0x5d58e5(0x1f3)),coinToPay2Service_1=require(a60_0x5d58e5(0x28b)),klymeService_1=require(a60_0x5d58e5(0x24b)),mastercardService_1=require(a60_0x5d58e5(0x1ff)),amerService_1=require(a60_0x5d58e5(0x22f)),telegramBotService_1=require('./telegramBotService'),currencyService_1=require('./currencyService'),loggerService_1=require(a60_0x5d58e5(0x1f2));class WebhookService{constructor(){const _0x5550d5=a60_0x5d58e5;this[_0x5550d5(0x287)]=new plisioService_1[(_0x5550d5(0x235))](),this[_0x5550d5(0x1fc)]=new rapydService_1[(_0x5550d5(0x265))](),this[_0x5550d5(0x266)]=new nodaService_1[(_0x5550d5(0x223))](),this['coinToPayService']=new coinToPayService_1[(_0x5550d5(0x288))](),this[_0x5550d5(0x24d)]=new coinToPay2Service_1[(_0x5550d5(0x23b))](),this[_0x5550d5(0x26f)]=new klymeService_1[(_0x5550d5(0x219))](),this[_0x5550d5(0x2b6)]=new mastercardService_1[(_0x5550d5(0x231))](),this[_0x5550d5(0x263)]=new amerService_1[(_0x5550d5(0x2bd))]();}async[a60_0x5d58e5(0x2c0)](_0x36c741,_0x5767ea,_0x826e82){const _0x1218f0=a60_0x5d58e5;console[_0x1218f0(0x20f)](_0x1218f0(0x2a0)+_0x36c741+_0x1218f0(0x1ef)+_0x5767ea),console['log'](_0x1218f0(0x2b8),_0x826e82),await database_1['default']['$transaction'](async _0x4fa30c=>{const _0x963964=_0x1218f0,_0x517f0a=await _0x4fa30c[_0x963964(0x2b5)][_0x963964(0x29a)]({'where':{'id':_0x36c741},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x517f0a)throw new Error('Payment\x20'+_0x36c741+'\x20not\x20found');const _0x1b5e6f=_0x517f0a[_0x963964(0x213)],_0x5cdfc8=_0x517f0a[_0x963964(0x25d)];console[_0x963964(0x20f)](_0x963964(0x262)+_0x36c741+':\x20'+_0x1b5e6f+_0x963964(0x25f)+_0x5767ea),console['log'](_0x963964(0x200)+_0x5cdfc8['username']+_0x963964(0x220)+_0x5cdfc8[_0x963964(0x25e)]+_0x963964(0x2b7));const _0x57bf99={'status':_0x5767ea['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x963964(0x22b),'statusChangedAt':new Date()};_0x826e82?.[_0x963964(0x2ae)]&&(_0x57bf99[_0x963964(0x2ae)]=_0x826e82['failureMessage']);_0x826e82?.['txUrls']&&(_0x57bf99[_0x963964(0x1fe)]=JSON[_0x963964(0x2ad)](_0x826e82['txUrls']));_0x826e82?.[_0x963964(0x242)]&&(_0x57bf99[_0x963964(0x242)]=_0x826e82['cardLast4']);_0x826e82?.['paymentMethod']&&(_0x57bf99['paymentMethod']=_0x826e82['paymentMethod']);_0x826e82?.[_0x963964(0x218)]&&(_0x57bf99[_0x963964(0x218)]=_0x826e82[_0x963964(0x218)]);_0x826e82?.[_0x963964(0x2cd)]&&(_0x57bf99[_0x963964(0x2cd)]=_0x826e82[_0x963964(0x2cd)]);_0x826e82?.[_0x963964(0x29d)]&&(_0x57bf99[_0x963964(0x29d)]=_0x826e82[_0x963964(0x29d)]);let _0x5c402a=_0x5cdfc8[_0x963964(0x25e)],_0x14b128='';if(_0x5767ea[_0x963964(0x2a8)]()===_0x963964(0x2a2)&&_0x1b5e6f!==_0x963964(0x2a2)){const _0x379eaf=await currencyService_1[_0x963964(0x226)][_0x963964(0x2d2)](_0x517f0a[_0x963964(0x237)],_0x517f0a[_0x963964(0x2bc)]),_0x39275d=await this[_0x963964(0x2a7)](_0x5cdfc8['id'],_0x517f0a[_0x963964(0x246)]),_0x3e70bc=_0x379eaf*(0x1-_0x39275d/0x64);_0x5c402a+=_0x3e70bc,_0x14b128='+'+_0x3e70bc[_0x963964(0x240)](0x6)+_0x963964(0x238)+_0x39275d+_0x963964(0x25b),_0x57bf99[_0x963964(0x1f6)]=_0x379eaf,_0x57bf99[_0x963964(0x225)]=_0x3e70bc,_0x57bf99['paidAt']=new Date(),console[_0x963964(0x20f)](_0x963964(0x2ce)+_0x517f0a[_0x963964(0x237)]+'\x20'+_0x517f0a[_0x963964(0x2bc)]+_0x963964(0x25f)+_0x379eaf['toFixed'](0x6)+_0x963964(0x2b7)),console[_0x963964(0x20f)]('💰\x20Gateway\x20'+_0x517f0a[_0x963964(0x246)]+_0x963964(0x1f4)+_0x39275d+'%'),console['log'](_0x963964(0x2b3)+_0x3e70bc[_0x963964(0x240)](0x6)+_0x963964(0x2b7)),console[_0x963964(0x20f)](_0x963964(0x23e)+_0x5cdfc8['balance']+'\x20+\x20'+_0x3e70bc['toFixed'](0x6)+_0x963964(0x203)+_0x5c402a['toFixed'](0x6)+_0x963964(0x2b7));}else{if(_0x1b5e6f===_0x963964(0x2a2)&&_0x5767ea['toUpperCase']()!==_0x963964(0x2a2)){let _0x38e27e;if(_0x517f0a['amountAfterGatewayCommissionUSDT'])_0x38e27e=_0x517f0a[_0x963964(0x225)];else{if(_0x517f0a['amountUSDT']){const _0x1fb432=await this[_0x963964(0x2a7)](_0x5cdfc8['id'],_0x517f0a[_0x963964(0x246)]);_0x38e27e=_0x517f0a['amountUSDT']*(0x1-_0x1fb432/0x64);}else console['log'](_0x963964(0x24e)),_0x38e27e=0x0;}_0x38e27e>0x0&&(_0x5c402a-=_0x38e27e,_0x14b128='-'+_0x38e27e[_0x963964(0x240)](0x6)+'\x20USDT\x20(payment\x20no\x20longer\x20PAID)',_0x57bf99[_0x963964(0x1f6)]=null,_0x57bf99[_0x963964(0x225)]=null,_0x57bf99[_0x963964(0x22a)]=null,console['log'](_0x963964(0x273)+_0x5cdfc8[_0x963964(0x25e)]+'\x20-\x20'+_0x38e27e[_0x963964(0x240)](0x6)+_0x963964(0x203)+_0x5c402a[_0x963964(0x240)](0x6)+_0x963964(0x2b7)));}}if(_0x5767ea[_0x963964(0x2a8)]()==='CHARGEBACK'){const _0x4f088=_0x826e82?.[_0x963964(0x204)]||0x0;_0x4f088>0x0&&(_0x5c402a-=_0x4f088,_0x14b128+=_0x963964(0x27e)+_0x4f088[_0x963964(0x240)](0x6)+_0x963964(0x276),_0x57bf99[_0x963964(0x204)]=_0x4f088,console[_0x963964(0x20f)](_0x963964(0x261)+_0x4f088[_0x963964(0x240)](0x6)+_0x963964(0x2b7)),console[_0x963964(0x20f)](_0x963964(0x271)+_0x5c402a[_0x963964(0x240)](0x6)+_0x963964(0x2b7)));}const _0x2f7205=await _0x4fa30c[_0x963964(0x2b5)][_0x963964(0x22c)]({'where':{'id':_0x36c741},'data':_0x57bf99});_0x5c402a!==_0x5cdfc8[_0x963964(0x25e)]&&(await _0x4fa30c[_0x963964(0x25d)]['update']({'where':{'id':_0x5cdfc8['id']},'data':{'balance':_0x5c402a}}),console['log'](_0x963964(0x2a9)+_0x5cdfc8['username']+'\x20balance\x20updated:\x20'+_0x5cdfc8['balance'][_0x963964(0x240)](0x6)+'\x20->\x20'+_0x5c402a[_0x963964(0x240)](0x6)+_0x963964(0x2b7)),console[_0x963964(0x20f)]('📝\x20Reason:\x20'+_0x14b128));await _0x4fa30c[_0x963964(0x236)][_0x963964(0x22d)]({'data':{'paymentId':_0x36c741,'shopId':_0x5cdfc8['id'],'event':_0x963964(0x1ee)+_0x5767ea[_0x963964(0x28e)](),'statusCode':0xc8,'responseBody':JSON[_0x963964(0x2ad)]({'oldStatus':_0x1b5e6f,'newStatus':_0x5767ea[_0x963964(0x2a8)](),'balanceChange':_0x14b128||_0x963964(0x250),'oldBalance':_0x5cdfc8[_0x963964(0x25e)],'newBalance':_0x5c402a,'amountUSDT':_0x57bf99[_0x963964(0x1f6)],'additionalData':_0x826e82,'timestamp':new Date()[_0x963964(0x1fd)]()})}}),await this[_0x963964(0x249)]({..._0x517f0a,..._0x2f7205,'shop':_0x5cdfc8},_0x5767ea[_0x963964(0x2a8)]()),await this[_0x963964(0x1f7)]({..._0x517f0a,..._0x2f7205},_0x5767ea[_0x963964(0x2a8)]());if(_0x1b5e6f!==_0x963964(0x2a2)&&_0x5767ea[_0x963964(0x2a8)]()==='PAID'){console[_0x963964(0x20f)](_0x963964(0x255)+_0x36c741+_0x963964(0x2bb)),console[_0x963964(0x20f)](_0x963964(0x27f)+_0x1b5e6f+'\x22,\x20newStatus=\x22'+_0x5767ea['toUpperCase']()+_0x963964(0x216)+_0x517f0a['paymentLinkId']+'\x22');if(_0x517f0a['paymentLinkId'])try{const _0x31f176=await _0x4fa30c[_0x963964(0x2d6)][_0x963964(0x29a)]({'where':{'id':_0x517f0a['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x31f176){console[_0x963964(0x20f)](_0x963964(0x256)+_0x31f176['id']+_0x963964(0x299)+_0x31f176['type']+_0x963964(0x2c5)+_0x31f176[_0x963964(0x281)]+_0x963964(0x202)+_0x31f176[_0x963964(0x213)]);const _0xc48b3c=_0x31f176[_0x963964(0x281)]+0x1,_0x2703dd=_0x31f176[_0x963964(0x289)]===_0x963964(0x23d)?_0x963964(0x210):_0x31f176[_0x963964(0x213)];await _0x4fa30c[_0x963964(0x2d6)][_0x963964(0x22c)]({'where':{'id':_0x517f0a['paymentLinkId']},'data':{'currentPayments':_0xc48b3c,'status':_0x2703dd,'updatedAt':new Date()}}),console[_0x963964(0x20f)](_0x963964(0x21b)+_0x31f176['id']+'\x20updated:\x20currentPayments='+_0x31f176['currentPayments']+_0x963964(0x25f)+_0xc48b3c+_0x963964(0x202)+_0x31f176[_0x963964(0x213)]+'\x20->\x20'+_0x2703dd);}else console[_0x963964(0x20f)](_0x963964(0x280)+_0x517f0a[_0x963964(0x20c)]+'\x20not\x20found');}catch(_0x35760e){console[_0x963964(0x2d5)](_0x963964(0x1ed),_0x35760e);}else console[_0x963964(0x20f)](_0x963964(0x255)+_0x36c741+_0x963964(0x2a3));}else console[_0x963964(0x20f)](_0x963964(0x255)+_0x36c741+_0x963964(0x2c2)+_0x1b5e6f+'\x20->\x20'+_0x5767ea[_0x963964(0x2a8)]());});}async['processPlisioWebhook'](_0x14ac51){const _0x4f9701=a60_0x5d58e5;console[_0x4f9701(0x20f)](_0x4f9701(0x2cb),_0x14ac51);try{const _0x56cf6d=await this[_0x4f9701(0x287)]['processWebhook'](_0x14ac51);if(!_0x56cf6d['paymentId'])throw new Error(_0x4f9701(0x2c8));const _0x53a8f3=await database_1[_0x4f9701(0x2a5)][_0x4f9701(0x2b5)][_0x4f9701(0x2bf)]({'where':{'gatewayOrderId':_0x56cf6d[_0x4f9701(0x23c)]}});if(!_0x53a8f3){console[_0x4f9701(0x2d5)]('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x56cf6d[_0x4f9701(0x23c)]);return;}console[_0x4f9701(0x20f)]('📊\x20Plisio\x20webhook:\x20Payment\x20'+_0x53a8f3['id']+_0x4f9701(0x23a)+_0x56cf6d[_0x4f9701(0x213)]),await this[_0x4f9701(0x2c0)](_0x53a8f3['id'],_0x56cf6d['status'],{'txUrls':_0x56cf6d[_0x4f9701(0x1fe)]}),loggerService_1[_0x4f9701(0x2c6)]['logWebhookProcessed'](_0x4f9701(0x253),_0x53a8f3['id'],_0x53a8f3[_0x4f9701(0x213)],_0x56cf6d[_0x4f9701(0x213)],_0x14ac51);}catch(_0x317574){console['error'](_0x4f9701(0x26b),_0x317574),loggerService_1['loggerService'][_0x4f9701(0x254)](_0x4f9701(0x253),_0x317574,_0x14ac51);throw _0x317574;}}async[a60_0x5d58e5(0x278)](_0x43f22a){const _0x19888b=a60_0x5d58e5;console[_0x19888b(0x20f)]('🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:',_0x43f22a);try{const _0x40b817=await this['plisioService'][_0x19888b(0x2a1)](_0x43f22a);if(!_0x40b817[_0x19888b(0x23c)])throw new Error(_0x19888b(0x2d1));const _0x86caf4=await database_1[_0x19888b(0x2a5)][_0x19888b(0x2b5)][_0x19888b(0x2bf)]({'where':{'gatewayOrderId':_0x40b817['paymentId']}});if(!_0x86caf4){console[_0x19888b(0x2d5)](_0x19888b(0x291)+_0x40b817[_0x19888b(0x23c)]);return;}console[_0x19888b(0x20f)](_0x19888b(0x2cf)+_0x86caf4['id']+_0x19888b(0x23a)+_0x40b817[_0x19888b(0x213)]),await this[_0x19888b(0x2c0)](_0x86caf4['id'],_0x40b817[_0x19888b(0x213)],{'txUrls':_0x40b817[_0x19888b(0x1fe)]}),loggerService_1[_0x19888b(0x2c6)][_0x19888b(0x1f1)](_0x19888b(0x2b0),_0x86caf4['id'],_0x86caf4[_0x19888b(0x213)],_0x40b817['status'],_0x43f22a);}catch(_0x374069){console[_0x19888b(0x2d5)](_0x19888b(0x27b),_0x374069),loggerService_1[_0x19888b(0x2c6)]['logWebhookError'](_0x19888b(0x2b0),_0x374069,_0x43f22a);throw _0x374069;}}async[a60_0x5d58e5(0x2ac)](_0x588d04){const _0x252478=a60_0x5d58e5;console[_0x252478(0x20f)](_0x252478(0x29f),_0x588d04);try{const _0x22ddae=await this[_0x252478(0x1fc)][_0x252478(0x2a1)](_0x588d04);if(!_0x22ddae[_0x252478(0x23c)])throw new Error('No\x20payment\x20ID\x20in\x20Rapyd\x20webhook');const _0x2073ef=await database_1[_0x252478(0x2a5)][_0x252478(0x2b5)][_0x252478(0x2bf)]({'where':{'gatewayOrderId':_0x22ddae[_0x252478(0x23c)]}});if(!_0x2073ef){console[_0x252478(0x2d5)]('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x22ddae['paymentId']);return;}console['log'](_0x252478(0x26c)+_0x2073ef['id']+'\x20status\x20'+_0x22ddae[_0x252478(0x213)]),await this['updatePaymentStatus'](_0x2073ef['id'],_0x22ddae[_0x252478(0x213)],{'failureMessage':_0x22ddae[_0x252478(0x2ae)],'cardLast4':_0x22ddae[_0x252478(0x205)]?.[_0x252478(0x242)],'paymentMethod':_0x22ddae['additionalInfo']?.[_0x252478(0x260)]}),loggerService_1[_0x252478(0x2c6)]['logWebhookProcessed']('rapyd',_0x2073ef['id'],_0x2073ef[_0x252478(0x213)],_0x22ddae[_0x252478(0x213)],_0x588d04);}catch(_0x4b37db){console['error']('Error\x20processing\x20Rapyd\x20webhook:',_0x4b37db),loggerService_1[_0x252478(0x2c6)][_0x252478(0x254)](_0x252478(0x230),_0x4b37db,_0x588d04);throw _0x4b37db;}}async[a60_0x5d58e5(0x222)](_0xaa49a0){const _0x215df8=a60_0x5d58e5;console[_0x215df8(0x20f)](_0x215df8(0x1ec),_0xaa49a0);try{const _0x26515e=await this[_0x215df8(0x266)][_0x215df8(0x2a1)](_0xaa49a0);if(!_0x26515e[_0x215df8(0x23c)])throw new Error(_0x215df8(0x201));const _0x51aecb=await database_1[_0x215df8(0x2a5)]['payment'][_0x215df8(0x2bf)]({'where':{'gatewayOrderId':_0x26515e[_0x215df8(0x23c)]}});if(!_0x51aecb){console[_0x215df8(0x2d5)](_0x215df8(0x21e)+_0x26515e[_0x215df8(0x23c)]);return;}console[_0x215df8(0x20f)](_0x215df8(0x252)+_0x51aecb['id']+_0x215df8(0x23a)+_0x26515e[_0x215df8(0x213)]),await this[_0x215df8(0x2c0)](_0x51aecb['id'],_0x26515e[_0x215df8(0x213)],{'bankId':_0x26515e['additionalInfo']?.[_0x215df8(0x218)],'remitterIban':_0x26515e['additionalInfo']?.[_0x215df8(0x2cd)],'remitterName':_0x26515e[_0x215df8(0x205)]?.[_0x215df8(0x29d)]}),loggerService_1[_0x215df8(0x2c6)][_0x215df8(0x1f1)]('noda',_0x51aecb['id'],_0x51aecb[_0x215df8(0x213)],_0x26515e[_0x215df8(0x213)],_0xaa49a0);}catch(_0x25f8c3){console[_0x215df8(0x2d5)](_0x215df8(0x224),_0x25f8c3),loggerService_1[_0x215df8(0x2c6)][_0x215df8(0x254)](_0x215df8(0x2d4),_0x25f8c3,_0xaa49a0);throw _0x25f8c3;}}async[a60_0x5d58e5(0x282)](_0x2342c7){const _0x439ea5=a60_0x5d58e5;console['log'](_0x439ea5(0x251),_0x2342c7);try{const _0x4d8864=await this['coinToPayService']['processWebhook'](_0x2342c7);if(!_0x4d8864['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x484077=await database_1[_0x439ea5(0x2a5)][_0x439ea5(0x2b5)][_0x439ea5(0x2bf)]({'where':{'gatewayOrderId':_0x4d8864[_0x439ea5(0x23c)]}});if(!_0x484077){console[_0x439ea5(0x2d5)](_0x439ea5(0x207)+_0x4d8864[_0x439ea5(0x23c)]);return;}console[_0x439ea5(0x20f)](_0x439ea5(0x2b4)+_0x484077['id']+'\x20status\x20'+_0x4d8864[_0x439ea5(0x213)]),await this[_0x439ea5(0x2c0)](_0x484077['id'],_0x4d8864[_0x439ea5(0x213)]),loggerService_1['loggerService'][_0x439ea5(0x1f1)](_0x439ea5(0x257),_0x484077['id'],_0x484077[_0x439ea5(0x213)],_0x4d8864[_0x439ea5(0x213)],_0x2342c7);}catch(_0x349fde){console['error']('Error\x20processing\x20CoinToPay\x20webhook:',_0x349fde),loggerService_1['loggerService'][_0x439ea5(0x254)](_0x439ea5(0x257),_0x349fde,_0x2342c7);throw _0x349fde;}}async[a60_0x5d58e5(0x2c7)](_0x1ac9a7){const _0x885813=a60_0x5d58e5;console[_0x885813(0x20f)](_0x885813(0x209),_0x1ac9a7);try{const _0x22e0ec=await this[_0x885813(0x24d)]['processWebhook'](_0x1ac9a7);if(!_0x22e0ec['paymentId'])throw new Error(_0x885813(0x239));const _0x52f94f=await database_1[_0x885813(0x2a5)][_0x885813(0x2b5)][_0x885813(0x2bf)]({'where':{'gatewayOrderId':_0x22e0ec[_0x885813(0x23c)]}});if(!_0x52f94f){console['error']('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x22e0ec[_0x885813(0x23c)]);return;}console['log'](_0x885813(0x1f0)+_0x52f94f['id']+_0x885813(0x23a)+_0x22e0ec[_0x885813(0x213)]),await this[_0x885813(0x2c0)](_0x52f94f['id'],_0x22e0ec[_0x885813(0x213)]),loggerService_1[_0x885813(0x2c6)][_0x885813(0x1f1)](_0x885813(0x297),_0x52f94f['id'],_0x52f94f[_0x885813(0x213)],_0x22e0ec[_0x885813(0x213)],_0x1ac9a7);}catch(_0x5d8c2d){console[_0x885813(0x2d5)](_0x885813(0x25a),_0x5d8c2d),loggerService_1[_0x885813(0x2c6)][_0x885813(0x254)](_0x885813(0x297),_0x5d8c2d,_0x1ac9a7);throw _0x5d8c2d;}}async['processKlymeWebhook'](_0x189065){const _0x495731=a60_0x5d58e5;console[_0x495731(0x20f)](_0x495731(0x215),_0x189065);try{const _0x56cb05=await this[_0x495731(0x26f)][_0x495731(0x2a1)](_0x189065);if(!_0x56cb05[_0x495731(0x23c)])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x3fcadc=await database_1[_0x495731(0x2a5)][_0x495731(0x2b5)][_0x495731(0x2bf)]({'where':{'gatewayOrderId':_0x56cb05[_0x495731(0x23c)]}});if(!_0x3fcadc){console[_0x495731(0x2d5)](_0x495731(0x2cc)+_0x56cb05[_0x495731(0x23c)]);return;}console['log']('📊\x20KLYME\x20webhook:\x20Payment\x20'+_0x3fcadc['id']+'\x20status\x20'+_0x56cb05['status']),await this['updatePaymentStatus'](_0x3fcadc['id'],_0x56cb05[_0x495731(0x213)],{'paymentMethod':_0x56cb05[_0x495731(0x205)]?.[_0x495731(0x1f9)]}),loggerService_1['loggerService']['logWebhookProcessed'](_0x495731(0x2c1),_0x3fcadc['id'],_0x3fcadc[_0x495731(0x213)],_0x56cb05[_0x495731(0x213)],_0x189065);}catch(_0x300077){console[_0x495731(0x2d5)]('Error\x20processing\x20KLYME\x20webhook:',_0x300077),loggerService_1[_0x495731(0x2c6)][_0x495731(0x254)]('klyme',_0x300077,_0x189065);throw _0x300077;}}async[a60_0x5d58e5(0x2a6)](_0x1a114d){const _0x1fc448=a60_0x5d58e5;console['log'](_0x1fc448(0x21f),JSON[_0x1fc448(0x2ad)](_0x1a114d,null,0x2));try{const _0x18c589=await this['masterCardService'][_0x1fc448(0x2a1)](_0x1a114d);console[_0x1fc448(0x20f)](_0x1fc448(0x28c),_0x18c589);if(!_0x18c589['paymentId']){console[_0x1fc448(0x2d5)](_0x1fc448(0x211)),console[_0x1fc448(0x2d5)](_0x1fc448(0x292),Object[_0x1fc448(0x241)](_0x1a114d));throw new Error(_0x1fc448(0x264));}let _0x437602=null;console[_0x1fc448(0x20f)](_0x1fc448(0x27d)+_0x18c589['paymentId']);_0x18c589[_0x1fc448(0x23c)]&&(console[_0x1fc448(0x20f)](_0x1fc448(0x2d0)),_0x437602=await database_1[_0x1fc448(0x2a5)]['payment']['findFirst']({'where':{'AND':[{'gateway':_0x1fc448(0x275)},{'OR':[{'gatewayPaymentId':_0x18c589['paymentId']},{'gatewayOrderId':_0x18c589['paymentId']},{'id':_0x18c589[_0x1fc448(0x23c)]},{'orderId':_0x18c589['paymentId']}]}]}}),console[_0x1fc448(0x20f)]('🔍\x20Search\x20result:\x20'+(_0x437602?_0x1fc448(0x229)+_0x437602['id']:_0x1fc448(0x28a))));if(!_0x437602){console[_0x1fc448(0x2d5)](_0x1fc448(0x233)+_0x18c589[_0x1fc448(0x23c)]),console['error'](_0x1fc448(0x283)+_0x18c589[_0x1fc448(0x23c)]+'\x22,\x20id=\x22'+_0x18c589[_0x1fc448(0x23c)]+_0x1fc448(0x296)+_0x18c589['paymentId']+'\x22');const _0x2c6d10=await database_1[_0x1fc448(0x2a5)][_0x1fc448(0x2b5)][_0x1fc448(0x277)]({'where':{'gateway':'mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x1fc448(0x20f)]('🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:',_0x2c6d10);return;}console['log']('✅\x20Found\x20payment\x20'+_0x437602['id']+_0x1fc448(0x268)+_0x437602[_0x1fc448(0x213)]+_0x1fc448(0x2c4)+_0x18c589['status']),await this[_0x1fc448(0x2c0)](_0x437602['id'],_0x18c589[_0x1fc448(0x213)]),loggerService_1[_0x1fc448(0x2c6)][_0x1fc448(0x1f1)](_0x1fc448(0x275),_0x437602['id'],_0x437602['status'],_0x18c589[_0x1fc448(0x213)],_0x1a114d);}catch(_0x2f9ab6){console[_0x1fc448(0x2d5)]('❌\x20Error\x20processing\x20MasterCard\x20webhook:',_0x2f9ab6),loggerService_1[_0x1fc448(0x2c6)][_0x1fc448(0x254)](_0x1fc448(0x275),_0x2f9ab6,_0x1a114d);throw _0x2f9ab6;}}async[a60_0x5d58e5(0x21d)](_0x5df80a){const _0x10d00b=a60_0x5d58e5;console['log'](_0x10d00b(0x29c),JSON[_0x10d00b(0x2ad)](_0x5df80a,null,0x2));try{const _0x4ad504=await this[_0x10d00b(0x263)][_0x10d00b(0x2a1)](_0x5df80a);console[_0x10d00b(0x20f)]('📊\x20Amer\x20webhook\x20result:',_0x4ad504);if(!_0x4ad504[_0x10d00b(0x23c)]){console[_0x10d00b(0x2d5)](_0x10d00b(0x22e)),console[_0x10d00b(0x2d5)](_0x10d00b(0x292),Object[_0x10d00b(0x241)](_0x5df80a));throw new Error(_0x10d00b(0x25c));}let _0x266af8=null;console[_0x10d00b(0x20f)]('🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0x4ad504[_0x10d00b(0x23c)]),_0x266af8=await database_1[_0x10d00b(0x2a5)][_0x10d00b(0x2b5)][_0x10d00b(0x2bf)]({'where':{'AND':[{'gateway':_0x10d00b(0x227)},{'OR':[{'gatewayPaymentId':_0x4ad504[_0x10d00b(0x23c)]},{'gatewayOrderId':_0x4ad504[_0x10d00b(0x23c)]},{'id':_0x4ad504[_0x10d00b(0x23c)]},{'orderId':_0x4ad504[_0x10d00b(0x23c)]}]}]}}),console[_0x10d00b(0x20f)](_0x10d00b(0x2d3)+(_0x266af8?_0x10d00b(0x229)+_0x266af8['id']:_0x10d00b(0x28a)));if(!_0x266af8){console['error'](_0x10d00b(0x259)+_0x4ad504[_0x10d00b(0x23c)]);return;}console[_0x10d00b(0x20f)](_0x10d00b(0x28d)+_0x266af8['id']+_0x10d00b(0x23a)+_0x4ad504['status']),await this[_0x10d00b(0x2c0)](_0x266af8['id'],_0x4ad504[_0x10d00b(0x213)],{'cardLast4':_0x4ad504[_0x10d00b(0x205)]?.[_0x10d00b(0x242)],'paymentMethod':_0x4ad504[_0x10d00b(0x205)]?.[_0x10d00b(0x260)]});}catch(_0x4af8d1){console[_0x10d00b(0x2d5)](_0x10d00b(0x298),_0x4af8d1),loggerService_1[_0x10d00b(0x2c6)][_0x10d00b(0x254)]('amer',_0x4af8d1,_0x5df80a);throw _0x4af8d1;}}async[a60_0x5d58e5(0x249)](_0x92f736,_0x3373d9){const _0x58c08d=a60_0x5d58e5,_0x517b85=Date[_0x58c08d(0x295)]();try{const _0xc363b2=_0x92f736[_0x58c08d(0x25d)],_0x239994=_0xc363b2[_0x58c08d(0x245)];if(!_0x239994?.[_0x58c08d(0x20e)]){console[_0x58c08d(0x20f)](_0x58c08d(0x2d7)+_0xc363b2['id']);return;}const _0x496f3f=_0x3373d9===_0x58c08d(0x2a2)?_0x58c08d(0x286):_0x3373d9===_0x58c08d(0x26e)?_0x58c08d(0x234):_0x3373d9===_0x58c08d(0x294)?_0x58c08d(0x234):_0x3373d9==='CHARGEBACK'?_0x58c08d(0x234):_0x3373d9===_0x58c08d(0x243)?'payment.failed':_0x58c08d(0x1fa);let _0x5bfd53=[];if(_0x239994['webhookEvents'])try{_0x5bfd53=Array[_0x58c08d(0x21c)](_0x239994[_0x58c08d(0x279)])?_0x239994[_0x58c08d(0x279)]:JSON[_0x58c08d(0x228)](_0x239994[_0x58c08d(0x279)]);}catch(_0x54587d){console[_0x58c08d(0x2d5)](_0x58c08d(0x27a),_0x54587d),_0x5bfd53=[];}if(!_0x5bfd53[_0x58c08d(0x29e)](_0x496f3f)){console[_0x58c08d(0x20f)](_0x58c08d(0x26d)+_0x496f3f+_0x58c08d(0x248)+_0xc363b2['id']);return;}const _0x2d512c={'event':_0x496f3f,'payment':{'id':_0x92f736['id'],'order_id':_0x92f736[_0x58c08d(0x2af)],'gateway_order_id':_0x92f736[_0x58c08d(0x2aa)],'gateway':_0x92f736[_0x58c08d(0x246)],'amount':_0x92f736[_0x58c08d(0x237)],'currency':_0x92f736[_0x58c08d(0x2bc)],'status':_0x3373d9[_0x58c08d(0x28e)](),'customer_email':_0x92f736['customerEmail'],'customer_name':_0x92f736[_0x58c08d(0x23f)],'failure_message':_0x92f736[_0x58c08d(0x2ae)],'tx_urls':_0x92f736[_0x58c08d(0x1fe)]?JSON[_0x58c08d(0x228)](_0x92f736[_0x58c08d(0x1fe)]):null,'created_at':_0x92f736[_0x58c08d(0x2b9)],'updated_at':_0x92f736[_0x58c08d(0x26a)]}},_0x1690ff=await fetch(_0x239994[_0x58c08d(0x20e)],{'method':_0x58c08d(0x1f5),'headers':{'Content-Type':_0x58c08d(0x20b),'User-Agent':_0x58c08d(0x20d)},'body':JSON[_0x58c08d(0x2ad)](_0x2d512c)}),_0x495aa9=Date[_0x58c08d(0x295)]()-_0x517b85,_0x2d895d=_0x1690ff['ok']?_0x58c08d(0x2ba):await _0x1690ff[_0x58c08d(0x293)]();loggerService_1['loggerService'][_0x58c08d(0x290)](_0x92f736[_0x58c08d(0x212)],_0x239994['webhookUrl'],_0x496f3f,_0x1690ff[_0x58c08d(0x213)],_0x495aa9,_0x2d512c),console[_0x58c08d(0x20f)](_0x58c08d(0x29b)+_0x239994['webhookUrl']+_0x58c08d(0x232)+_0x1690ff[_0x58c08d(0x213)]+'\x20('+_0x495aa9+_0x58c08d(0x2ca));}catch(_0xc5da1e){console[_0x58c08d(0x2d5)]('Failed\x20to\x20send\x20shop\x20webhook:',_0xc5da1e),loggerService_1[_0x58c08d(0x2c6)][_0x58c08d(0x244)](_0x92f736[_0x58c08d(0x212)],_0x92f736[_0x58c08d(0x25d)]?.[_0x58c08d(0x245)]?.[_0x58c08d(0x20e)]||_0x58c08d(0x21a),_0x58c08d(0x2c9),_0xc5da1e,{});}}async[a60_0x5d58e5(0x1f7)](_0x50287f,_0x19a60e){const _0x4b2d0e=a60_0x5d58e5;try{const _0x5e9079={'PENDING':_0x4b2d0e(0x269),'PROCESSING':_0x4b2d0e(0x2b1),'PAID':'paid','FAILED':_0x4b2d0e(0x221),'EXPIRED':'expired','REFUND':_0x4b2d0e(0x2ab),'CHARGEBACK':'chargeback'},_0x3bad13=_0x5e9079[_0x19a60e];if(!_0x3bad13||_0x3bad13===_0x4b2d0e(0x269))return;await telegramBotService_1[_0x4b2d0e(0x258)][_0x4b2d0e(0x274)](_0x50287f[_0x4b2d0e(0x212)],_0x50287f,_0x3bad13);}catch(_0x3250ac){console[_0x4b2d0e(0x2d5)](_0x4b2d0e(0x24a),_0x3250ac);}}async[a60_0x5d58e5(0x2a7)](_0x4c2edb,_0x296e41){const _0x527586=a60_0x5d58e5;try{const _0x511a10=await database_1[_0x527586(0x2a5)][_0x527586(0x25d)][_0x527586(0x29a)]({'where':{'id':_0x4c2edb},'select':{'gatewaySettings':!![]}});if(!_0x511a10?.[_0x527586(0x217)])return console['log'](_0x527586(0x208)+_0x4c2edb+_0x527586(0x284)),0xa;const _0xc6ca94=JSON['parse'](_0x511a10[_0x527586(0x217)]);for(const [_0x204b23,_0x14ba03]of Object[_0x527586(0x206)](_0xc6ca94)){if(_0x204b23[_0x527586(0x28e)]()===_0x296e41[_0x527586(0x28e)]()){const _0x182de7=_0x14ba03[_0x527586(0x24c)]||0xa;return console[_0x527586(0x20f)]('Gateway\x20'+_0x296e41+_0x527586(0x1fb)+_0x4c2edb+':\x20'+_0x182de7+'%'),_0x182de7;}}return console[_0x527586(0x20f)](_0x527586(0x2a4)+_0x296e41+'\x20in\x20shop\x20'+_0x4c2edb+',\x20using\x20default\x2010%'),0xa;}catch(_0xfcf18b){return console[_0x527586(0x2d5)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x4c2edb+_0x527586(0x270)+_0x296e41+':',_0xfcf18b),0xa;}}}exports['WebhookService']=WebhookService;