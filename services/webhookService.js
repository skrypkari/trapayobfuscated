'use strict';const a64_0x5065a3=a64_0x40c1;(function(_0x3fea6f,_0x20f61e){const _0x5f4cc7=a64_0x40c1,_0x362c95=_0x3fea6f();while(!![]){try{const _0x15f332=-parseInt(_0x5f4cc7(0xb6))/0x1+parseInt(_0x5f4cc7(0xae))/0x2+-parseInt(_0x5f4cc7(0x88))/0x3+parseInt(_0x5f4cc7(0xc6))/0x4*(parseInt(_0x5f4cc7(0xa3))/0x5)+-parseInt(_0x5f4cc7(0x156))/0x6+-parseInt(_0x5f4cc7(0x116))/0x7*(-parseInt(_0x5f4cc7(0x164))/0x8)+-parseInt(_0x5f4cc7(0x10e))/0x9;if(_0x15f332===_0x20f61e)break;else _0x362c95['push'](_0x362c95['shift']());}catch(_0x4ea03c){_0x362c95['push'](_0x362c95['shift']());}}}(a64_0x5a63,0x3ac2e));function a64_0x5a63(){const _0x36f4d1=['default','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','customerOrderId','stringify','currentPayments','🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...','failureMessage','./telegramBotService','visaMasterCardService','No\x20additional\x20info','💰\x20Gateway\x20','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','includes','chargebackAmount','ampayService','gatewaySettings','visa/mastercard','PAID','💰\x20Removing\x20from\x20balance:\x20','application/json','shopId','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','$transaction','\x22,\x20id=\x22','🔍\x20Searching\x20for\x20VISA\x20payment\x20with\x20the\x20following\x20criteria:','payment.success','klymeService','133497NjoZYZ','\x20not\x20found','❌\x20Error\x20processing\x20Amer\x20webhook:','❌\x20Payment\x20link\x20','💰\x20Converting\x20','\x20(Status:\x20','status_addition_info','\x20USDT','plisio_gateway','📊\x20Plisio\x20webhook:\x20Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','DECLINED','Failed\x20to\x20send\x20shop\x20webhook:','entries','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20VISA\x20webhook\x20data','❌\x20Payment\x20not\x20found\x20for\x20MyXSpend\x20customerOrderId:\x20','remitterIban','commission','💰\x20Amount\x20after\x20gateway\x20commission:\x20','amountUSDT','toLowerCase','MasterCard\x20payment\x20not\x20found:\x20','coinToPayService','🔄\x20Processing\x20Plisio\x20webhook:','./gateways/plisioService','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','✅\x20Found\x20payment:\x20ID=','10JiEeev','expired','visa','rapydService','📝\x20Reason:\x20','Error\x20processing\x20KLYME\x20webhook:','🔍\x20VISA\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','\x20→\x20',':\x20type=','\x20-\x20','🔄\x20AmPay\x20status\x20DECLINED\x20mapped\x20to\x20FAILED','665712QRkChm','Success','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','📊\x20Amer\x20webhook\x20result:','❌\x20VISA\x20payment\x20failed\x20with\x20message:\x20','logWebhookProcessed','AmerService','processWebhook','390540HBxqJh','EXPIRED','cointopay2','Gateway\x20','failed',',\x20using\x20default\x2010%','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','gatewayCommissionRate','CoinToPay2Service','FAILED','🔄\x20Processing\x20Rapyd\x20webhook:','Found\x20payment\x20','sendShopWebhook','__esModule','paid','Not\x20found','903384GuipKF',',\x20newStatus=','balance','webhook_send','noda','CHARGEBACK','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','📊\x20KLYME\x20webhook:\x20Payment\x20','desc','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','./loggerService','POST','customerName','📊\x20VISA\x20payment\x20found:\x20','🔄\x20Processing\x20MasterCard\x20webhook:','WebhookService','📊\x20Amer\x20webhook:\x20Payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20and\x20-','shop','webhookUrl','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','findFirst','telegramBotService','toUpperCase','\x20+\x20','🔍\x20Trying\x20to\x20find\x20VISA\x20payment\x20by\x20various\x20fields...','payment','webhookLog','payment.failed','✅\x20AmPay\x20webhook\x20processed:\x20Payment\x20','unknown','getGatewayCommission','additionalInfo','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','now','Error\x20parsing\x20webhook\x20events:','❌\x20Error\x20processing\x20MyXSpend\x20webhook:','\x22,\x20paymentLinkId=\x22','updatePaymentStatus','\x20->\x20','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','❌\x20Error\x20processing\x20AmPay\x20webhook:','ℹ️\x20Decline\x20reason:\x20','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','cardLast4','❌\x20MasterCard\x20payment\x20failed\x20with\x20message:\x20','\x20=\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook','klyme','Missing\x20client_transaction_id\x20in\x20AmPay\x20webhook','logWebhookError','PlisioService','✅\x20Payment\x20link\x20','created',',\x20gatewayPaymentId:\x20','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20',',\x20GatewayOrderId=','client_transaction_id','isArray','🔍\x20Found\x20VISA\x20payment:\x20ID=','amer',',\x20Gateway=','Error\x20processing\x20Plisio\x20webhook:','dateTime','📤\x20Shop\x20webhook\x20sent\x20to\x20','./currencyService','cointopay','🔍\x20VISA\x20payment\x20search\x20result:\x20','\x20mapped\x20to\x20FAILED','2799963jpDuuZ','TesSoft\x20Payment\x20System/1.0','📊\x20Rapyd\x20webhook:\x20Payment\x20','amount','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','txUrls','📈\x20Payment\x20','RapydService','35TuZcfg','❌\x20VISA\x20payment\x20not\x20found\x20for\x20ID:\x20','no\x20balance\x20change','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','nodaService','COMPLETED','plisioService','\x20for\x20MyXSpend\x20webhook','parse','Error\x20processing\x20Rapyd\x20webhook:','🔄\x20MyXSpend\x20status\x20',',\x20GatewayPaymentId=','❌\x20No\x20client_transaction_id\x20found\x20in\x20AmPay\x20webhook','visa_','./gateways/ampayService','\x20-\x20no\x20action\x20taken\x20(only\x20DECLINED\x20is\x20processed)','Error\x20processing\x20CoinToPay\x20webhook:','logShopWebhookSent','orderId','\x20(orderId:\x20','loggerService','sendPaymentNotification','processVisaWebhook','💰\x20Payment\x20','gatewayPaymentId','processPlisioGatewayWebhook','✅\x20Found\x20payment\x20','VisaMasterCardService','plisio','createdAt','🔄\x20Processing\x20AmPay\x20webhook:','./gateways/coinToPay2Service','❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','log',',\x20Status=','Payment\x20not\x20found:\x20','%\x20gateway\x20commission)','VISA\x20payment\x20not\x20found:\x20','\x20status\x20','KlymeService','map','❌\x20VISA\x20webhook\x20processing\x20failed:','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','customerEmail','ampay','rapyd','❌\x20No\x20payment\x20found,\x20checking\x20all\x20payments\x20for\x20debugging...','keys','🔄\x20Processing\x20KLYME\x20webhook:','status','update','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','./gateways/mastercardService','\x20in\x20shop\x20','username','visa_mastercard','paidAt',',\x20status=','payment_method','remitterName','\x20current\x20balance:\x20','Payment\x20not\x20found','1435566tZZKbN','findMany','processRapydWebhook','logShopWebhookError','findUnique','./gateways/rapydService','error','🔄\x20Processing\x20MyXSpend\x20webhook:','paymentId','\x20balance\x20updated:\x20','ℹ️\x20AmPay\x20status\x20','processMasterCardWebhook','type','mastercard','706472cAwhGl','settings','🔍\x20Recent\x20visa/mastercard\x20payments\x20for\x20debugging:','📊\x20MasterCard\x20webhook\x20result:','myxspend_','🔍\x20Available\x20VISA/MasterCard\x20payments\x20for\x20debugging:','🏪\x20Shop\x20','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','coinToPay2Service','currency','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','✅\x20MyXSpend\x20webhook\x20processed:\x20Payment\x20','CoinToPayService','chargeback','📊\x20Payment\x20status:\x20','🔄\x20Processing\x20CoinToPay2\x20webhook:','Error\x20processing\x20CoinToPay2\x20webhook:','refund','toFixed','paymentLink','amountAfterGatewayCommissionUSDT','\x20updated:\x20currentPayments=','🔍\x20Search\x20result:\x20','paymentLinkId','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','bankId','\x22,\x20orderId=\x22','processMyXSpendWebhook','gateway','processing','create','Found','paymentMethod','gatewayOrderId','MASTERCARD','\x22,\x20newStatus=\x22','sendPaymentStatusNotification','📈\x20Found\x20payment\x20link\x20',',\x20gateway\x20','Webhook\x20event\x20','❌\x20Payment\x20not\x20found\x20for\x20AmPay\x20client_transaction_id:\x20','amerService','webhookEvents','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','ampay_','\x20\x20\x20-\x20Payment\x20ID\x20to\x20match:\x20','💰\x20Final\x20balance\x20after\x20chargeback:\x20','Missing\x20customerOrderId\x20in\x20MyXSpend\x20webhook','NodaService','\x20commission\x20for\x20shop\x20','__importDefault','\x20status\x20updated\x20to\x20FAILED','ms)','Body\x20data:'];a64_0x5a63=function(){return _0x36f4d1;};return a64_0x5a63();}function a64_0x40c1(_0x1e67eb,_0xf9342){const _0x5a631c=a64_0x5a63();return a64_0x40c1=function(_0x40c11a,_0x3cd13d){_0x40c11a=_0x40c11a-0x6b;let _0x48f842=_0x5a631c[_0x40c11a];return _0x48f842;},a64_0x40c1(_0x1e67eb,_0xf9342);}var __importDefault=this&&this[a64_0x5065a3(0x196)]||function(_0x55de4b){return _0x55de4b&&_0x55de4b['__esModule']?_0x55de4b:{'default':_0x55de4b};};Object['defineProperty'](exports,a64_0x5065a3(0xc3),{'value':!![]}),exports[a64_0x5065a3(0xd7)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require(a64_0x5065a3(0xa0)),rapydService_1=require(a64_0x5065a3(0x15b)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a64_0x5065a3(0x135)),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a64_0x5065a3(0x14c)),amerService_1=require('./gateways/amerService'),ampayService_1=require(a64_0x5065a3(0x124)),telegramBotService_1=require(a64_0x5065a3(0x73)),currencyService_1=require(a64_0x5065a3(0x10a)),loggerService_1=require(a64_0x5065a3(0xd2));class WebhookService{constructor(){const _0x48e153=a64_0x5065a3;this[_0x48e153(0x11c)]=new plisioService_1[(_0x48e153(0xfc))](),this[_0x48e153(0xa6)]=new rapydService_1[(_0x48e153(0x115))](),this[_0x48e153(0x11a)]=new nodaService_1[(_0x48e153(0x194))](),this[_0x48e153(0x9e)]=new coinToPayService_1[(_0x48e153(0x170))](),this[_0x48e153(0x16c)]=new coinToPay2Service_1[(_0x48e153(0xbe))](),this['klymeService']=new klymeService_1[(_0x48e153(0x13d))](),this[_0x48e153(0x74)]=new mastercardService_1[(_0x48e153(0x131))](),this[_0x48e153(0x18d)]=new amerService_1[(_0x48e153(0xb4))](),this[_0x48e153(0x7a)]=new ampayService_1['AmPayService']();}async[a64_0x5065a3(0xef)](_0x48f166,_0x41b56a,_0x507a8e){const _0x13558b=a64_0x5065a3;console[_0x13558b(0x137)]('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x48f166+_0x13558b(0xc7)+_0x41b56a),console['log']('🔄\x20Additional\x20data:',_0x507a8e),await database_1['default'][_0x13558b(0x83)](async _0x2145c1=>{const _0x276947=_0x13558b,_0x168b1f=await _0x2145c1[_0x276947(0xe3)][_0x276947(0x15a)]({'where':{'id':_0x48f166},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x168b1f)throw new Error('Payment\x20'+_0x48f166+_0x276947(0x89));const _0x50e4a8=_0x168b1f['status'],_0x32c7fb=_0x168b1f[_0x276947(0xdb)];console[_0x276947(0x137)](_0x276947(0x12d)+_0x48f166+':\x20'+_0x50e4a8+_0x276947(0xf0)+_0x41b56a),console[_0x276947(0x137)](_0x276947(0x16a)+_0x32c7fb[_0x276947(0x14e)]+_0x276947(0x154)+_0x32c7fb['balance']+_0x276947(0x8f));const _0x5014ac={'status':_0x41b56a[_0x276947(0xe0)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x507a8e?.['failureMessage']&&(_0x5014ac['failureMessage']=_0x507a8e[_0x276947(0x72)]);_0x507a8e?.['txUrls']&&(_0x5014ac[_0x276947(0x113)]=JSON[_0x276947(0x6f)](_0x507a8e['txUrls']));_0x507a8e?.[_0x276947(0xf5)]&&(_0x5014ac[_0x276947(0xf5)]=_0x507a8e[_0x276947(0xf5)]);_0x507a8e?.[_0x276947(0x184)]&&(_0x5014ac[_0x276947(0x184)]=_0x507a8e['paymentMethod']);_0x507a8e?.[_0x276947(0x17d)]&&(_0x5014ac[_0x276947(0x17d)]=_0x507a8e['bankId']);_0x507a8e?.[_0x276947(0x98)]&&(_0x5014ac['remitterIban']=_0x507a8e[_0x276947(0x98)]);_0x507a8e?.[_0x276947(0x153)]&&(_0x5014ac[_0x276947(0x153)]=_0x507a8e[_0x276947(0x153)]);let _0x493519=_0x32c7fb[_0x276947(0xc8)],_0x3d7c3e='';if(_0x41b56a['toUpperCase']()===_0x276947(0x7d)&&_0x50e4a8!==_0x276947(0x7d)){const _0x3fca10=await currencyService_1['currencyService']['convertToUSDT'](_0x168b1f[_0x276947(0x111)],_0x168b1f[_0x276947(0x16d)]),_0x30a692=await this[_0x276947(0xe8)](_0x32c7fb['id'],_0x168b1f[_0x276947(0x180)]),_0x4e6ac8=_0x3fca10*(0x1-_0x30a692/0x64);_0x493519+=_0x4e6ac8,_0x3d7c3e='+'+_0x4e6ac8['toFixed'](0x6)+_0x276947(0x149)+_0x30a692+_0x276947(0x13a),_0x5014ac[_0x276947(0x9b)]=_0x3fca10,_0x5014ac[_0x276947(0x178)]=_0x4e6ac8,_0x5014ac[_0x276947(0xbd)]=_0x30a692,_0x5014ac[_0x276947(0x150)]=new Date(),console[_0x276947(0x137)](_0x276947(0x8c)+_0x168b1f[_0x276947(0x111)]+'\x20'+_0x168b1f[_0x276947(0x16d)]+_0x276947(0xf0)+_0x3fca10[_0x276947(0x176)](0x6)+_0x276947(0x8f)),console[_0x276947(0x137)](_0x276947(0x76)+_0x168b1f[_0x276947(0x180)]+'\x20commission:\x20'+_0x30a692+'%'),console[_0x276947(0x137)](_0x276947(0x9a)+_0x4e6ac8[_0x276947(0x176)](0x6)+_0x276947(0x8f)),console[_0x276947(0x137)]('💰\x20Adding\x20to\x20balance:\x20'+_0x32c7fb[_0x276947(0xc8)]+_0x276947(0xe1)+_0x4e6ac8[_0x276947(0x176)](0x6)+_0x276947(0xf7)+_0x493519[_0x276947(0x176)](0x6)+_0x276947(0x8f));}else{if(_0x50e4a8==='PAID'&&_0x41b56a['toUpperCase']()!=='PAID'){let _0x236983;if(_0x168b1f['amountAfterGatewayCommissionUSDT'])_0x236983=_0x168b1f[_0x276947(0x178)];else{if(_0x168b1f[_0x276947(0x9b)]){const _0x45fd15=await this[_0x276947(0xe8)](_0x32c7fb['id'],_0x168b1f[_0x276947(0x180)]);_0x236983=_0x168b1f[_0x276947(0x9b)]*(0x1-_0x45fd15/0x64);}else console[_0x276947(0x137)](_0x276947(0x16b)),_0x236983=0x0;}_0x236983>0x0&&(_0x493519-=_0x236983,_0x3d7c3e='-'+_0x236983[_0x276947(0x176)](0x6)+_0x276947(0xd1),_0x5014ac[_0x276947(0x9b)]=null,_0x5014ac[_0x276947(0x178)]=null,_0x5014ac[_0x276947(0x150)]=null,console[_0x276947(0x137)](_0x276947(0x7e)+_0x32c7fb[_0x276947(0xc8)]+_0x276947(0xac)+_0x236983[_0x276947(0x176)](0x6)+_0x276947(0xf7)+_0x493519[_0x276947(0x176)](0x6)+_0x276947(0x8f)));}}if(_0x41b56a[_0x276947(0xe0)]()==='CHARGEBACK'){const _0x1fe004=_0x507a8e?.['chargebackAmount']||0x0;_0x1fe004>0x0&&(_0x493519-=_0x1fe004,_0x3d7c3e+=_0x276947(0xda)+_0x1fe004[_0x276947(0x176)](0x6)+'\x20USDT\x20(chargeback\x20penalty)',_0x5014ac[_0x276947(0x79)]=_0x1fe004,console[_0x276947(0x137)]('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0x1fe004[_0x276947(0x176)](0x6)+_0x276947(0x8f)),console['log'](_0x276947(0x192)+_0x493519[_0x276947(0x176)](0x6)+'\x20USDT'));}const _0x124671=await _0x2145c1[_0x276947(0xe3)][_0x276947(0x148)]({'where':{'id':_0x48f166},'data':_0x5014ac});_0x493519!==_0x32c7fb['balance']&&(await _0x2145c1[_0x276947(0xdb)]['update']({'where':{'id':_0x32c7fb['id']},'data':{'balance':_0x493519}}),console['log']('✅\x20Shop\x20'+_0x32c7fb[_0x276947(0x14e)]+_0x276947(0x15f)+_0x32c7fb[_0x276947(0xc8)][_0x276947(0x176)](0x6)+_0x276947(0xf0)+_0x493519[_0x276947(0x176)](0x6)+_0x276947(0x8f)),console[_0x276947(0x137)](_0x276947(0xa7)+_0x3d7c3e));await _0x2145c1[_0x276947(0xe4)][_0x276947(0x182)]({'data':{'paymentId':_0x48f166,'shopId':_0x32c7fb['id'],'event':'webhook_status_change_'+_0x41b56a[_0x276947(0x9c)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x50e4a8,'newStatus':_0x41b56a[_0x276947(0xe0)](),'balanceChange':_0x3d7c3e||_0x276947(0x118),'oldBalance':_0x32c7fb[_0x276947(0xc8)],'newBalance':_0x493519,'amountUSDT':_0x5014ac['amountUSDT'],'additionalData':_0x507a8e,'timestamp':new Date()['toISOString']()})}}),await this['sendShopWebhook']({..._0x168b1f,..._0x124671,'shop':_0x32c7fb},_0x41b56a[_0x276947(0xe0)]()),await this[_0x276947(0x188)]({..._0x168b1f,..._0x124671},_0x41b56a['toUpperCase']());if(_0x50e4a8!==_0x276947(0x7d)&&_0x41b56a[_0x276947(0xe0)]()===_0x276947(0x7d)){console[_0x276947(0x137)]('📈\x20Payment\x20'+_0x48f166+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console['log']('📈\x20Payment\x20details:\x20oldStatus=\x22'+_0x50e4a8+_0x276947(0x187)+_0x41b56a[_0x276947(0xe0)]()+_0x276947(0xee)+_0x168b1f[_0x276947(0x17b)]+'\x22');if(_0x168b1f[_0x276947(0x17b)])try{const _0x43bcfa=await _0x2145c1[_0x276947(0x177)]['findUnique']({'where':{'id':_0x168b1f[_0x276947(0x17b)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x43bcfa){console[_0x276947(0x137)](_0x276947(0x189)+_0x43bcfa['id']+_0x276947(0xab)+_0x43bcfa[_0x276947(0x162)]+',\x20currentPayments='+_0x43bcfa[_0x276947(0x70)]+_0x276947(0x151)+_0x43bcfa[_0x276947(0x147)]);const _0x5d8fa2=_0x43bcfa[_0x276947(0x70)]+0x1,_0x34a048=_0x43bcfa[_0x276947(0x162)]==='SINGLE'?_0x276947(0x11b):_0x43bcfa[_0x276947(0x147)];await _0x2145c1[_0x276947(0x177)][_0x276947(0x148)]({'where':{'id':_0x168b1f['paymentLinkId']},'data':{'currentPayments':_0x5d8fa2,'status':_0x34a048,'updatedAt':new Date()}}),console['log'](_0x276947(0xfd)+_0x43bcfa['id']+_0x276947(0x179)+_0x43bcfa[_0x276947(0x70)]+_0x276947(0xf0)+_0x5d8fa2+_0x276947(0x151)+_0x43bcfa[_0x276947(0x147)]+_0x276947(0xf0)+_0x34a048);}else console[_0x276947(0x137)](_0x276947(0x8b)+_0x168b1f[_0x276947(0x17b)]+_0x276947(0x89));}catch(_0x265c0b){console[_0x276947(0x15c)]('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x265c0b);}else console['log'](_0x276947(0x114)+_0x48f166+_0x276947(0xbc));}else console['log'](_0x276947(0x114)+_0x48f166+_0x276947(0x16e)+_0x50e4a8+_0x276947(0xf0)+_0x41b56a[_0x276947(0xe0)]());});}async['processPlisioWebhook'](_0x4bd89f){const _0x1ab4ec=a64_0x5065a3;console[_0x1ab4ec(0x137)](_0x1ab4ec(0x9f),_0x4bd89f);try{const _0x1d0104=await this['plisioService'][_0x1ab4ec(0xb5)](_0x4bd89f);if(!_0x1d0104[_0x1ab4ec(0x15e)])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20webhook');const _0x368b09=await database_1['default'][_0x1ab4ec(0xe3)][_0x1ab4ec(0xde)]({'where':{'gatewayOrderId':_0x1d0104[_0x1ab4ec(0x15e)]}});if(!_0x368b09){console[_0x1ab4ec(0x15c)](_0x1ab4ec(0xdd)+_0x1d0104[_0x1ab4ec(0x15e)]);return;}console['log'](_0x1ab4ec(0x91)+_0x368b09['id']+_0x1ab4ec(0x13c)+_0x1d0104['status']),await this[_0x1ab4ec(0xef)](_0x368b09['id'],_0x1d0104[_0x1ab4ec(0x147)],{'txUrls':_0x1d0104[_0x1ab4ec(0x113)]}),loggerService_1['loggerService'][_0x1ab4ec(0xb3)](_0x1ab4ec(0x132),_0x368b09['id'],_0x368b09[_0x1ab4ec(0x147)],_0x1d0104[_0x1ab4ec(0x147)],_0x4bd89f);}catch(_0x775d97){console[_0x1ab4ec(0x15c)](_0x1ab4ec(0x107),_0x775d97),loggerService_1[_0x1ab4ec(0x12a)][_0x1ab4ec(0xfb)](_0x1ab4ec(0x132),_0x775d97,_0x4bd89f);throw _0x775d97;}}async[a64_0x5065a3(0x12f)](_0x5854e2){const _0x5950d6=a64_0x5065a3;console['log'](_0x5950d6(0xf1),_0x5854e2);try{const _0x12de2b=await this[_0x5950d6(0x11c)][_0x5950d6(0xb5)](_0x5854e2);if(!_0x12de2b[_0x5950d6(0x15e)])throw new Error(_0x5950d6(0x6d));const _0x539dfd=await database_1[_0x5950d6(0x6c)][_0x5950d6(0xe3)]['findFirst']({'where':{'gatewayOrderId':_0x12de2b[_0x5950d6(0x15e)]}});if(!_0x539dfd){console['error'](_0x5950d6(0x77)+_0x12de2b[_0x5950d6(0x15e)]);return;}console[_0x5950d6(0x137)](_0x5950d6(0x81)+_0x539dfd['id']+_0x5950d6(0x13c)+_0x12de2b['status']),await this[_0x5950d6(0xef)](_0x539dfd['id'],_0x12de2b[_0x5950d6(0x147)],{'txUrls':_0x12de2b[_0x5950d6(0x113)]}),loggerService_1[_0x5950d6(0x12a)][_0x5950d6(0xb3)](_0x5950d6(0x90),_0x539dfd['id'],_0x539dfd[_0x5950d6(0x147)],_0x12de2b['status'],_0x5854e2);}catch(_0x3c2d32){console[_0x5950d6(0x15c)](_0x5950d6(0x112),_0x3c2d32),loggerService_1[_0x5950d6(0x12a)]['logWebhookError']('plisio_gateway',_0x3c2d32,_0x5854e2);throw _0x3c2d32;}}async[a64_0x5065a3(0x158)](_0x2b948d){const _0xf7f2c=a64_0x5065a3;console[_0xf7f2c(0x137)](_0xf7f2c(0xc0),_0x2b948d);try{const _0x45ceca=await this[_0xf7f2c(0xa6)]['processWebhook'](_0x2b948d);if(!_0x45ceca[_0xf7f2c(0x15e)])throw new Error(_0xf7f2c(0xf4));const _0x1d47de=await database_1[_0xf7f2c(0x6c)]['payment'][_0xf7f2c(0xde)]({'where':{'gatewayOrderId':_0x45ceca[_0xf7f2c(0x15e)]}});if(!_0x1d47de){console[_0xf7f2c(0x15c)](_0xf7f2c(0xcd)+_0x45ceca[_0xf7f2c(0x15e)]);return;}console[_0xf7f2c(0x137)](_0xf7f2c(0x110)+_0x1d47de['id']+'\x20status\x20'+_0x45ceca[_0xf7f2c(0x147)]),await this[_0xf7f2c(0xef)](_0x1d47de['id'],_0x45ceca[_0xf7f2c(0x147)],{'failureMessage':_0x45ceca['failureMessage'],'cardLast4':_0x45ceca['additionalInfo']?.[_0xf7f2c(0xf5)],'paymentMethod':_0x45ceca[_0xf7f2c(0xe9)]?.[_0xf7f2c(0x184)]}),loggerService_1[_0xf7f2c(0x12a)][_0xf7f2c(0xb3)](_0xf7f2c(0x143),_0x1d47de['id'],_0x1d47de[_0xf7f2c(0x147)],_0x45ceca[_0xf7f2c(0x147)],_0x2b948d);}catch(_0x352607){console[_0xf7f2c(0x15c)](_0xf7f2c(0x11f),_0x352607),loggerService_1[_0xf7f2c(0x12a)][_0xf7f2c(0xfb)](_0xf7f2c(0x143),_0x352607,_0x2b948d);throw _0x352607;}}async['processNodaWebhook'](_0x5dce50){const _0x1a20d0=a64_0x5065a3;console[_0x1a20d0(0x137)]('🔄\x20Processing\x20Noda\x20webhook:',_0x5dce50);try{const _0x5b0049=await this['nodaService'][_0x1a20d0(0xb5)](_0x5dce50);if(!_0x5b0049[_0x1a20d0(0x15e)])throw new Error(_0x1a20d0(0xf8));const _0xbeb95d=await database_1[_0x1a20d0(0x6c)][_0x1a20d0(0xe3)][_0x1a20d0(0xde)]({'where':{'gatewayOrderId':_0x5b0049['paymentId']}});if(!_0xbeb95d){console[_0x1a20d0(0x15c)](_0x1a20d0(0xcc)+_0x5b0049[_0x1a20d0(0x15e)]);return;}console[_0x1a20d0(0x137)]('📊\x20Noda\x20webhook:\x20Payment\x20'+_0xbeb95d['id']+_0x1a20d0(0x13c)+_0x5b0049[_0x1a20d0(0x147)]),await this[_0x1a20d0(0xef)](_0xbeb95d['id'],_0x5b0049['status'],{'bankId':_0x5b0049[_0x1a20d0(0xe9)]?.[_0x1a20d0(0x17d)],'remitterIban':_0x5b0049[_0x1a20d0(0xe9)]?.['remitterIban'],'remitterName':_0x5b0049[_0x1a20d0(0xe9)]?.[_0x1a20d0(0x153)]}),loggerService_1[_0x1a20d0(0x12a)][_0x1a20d0(0xb3)](_0x1a20d0(0xca),_0xbeb95d['id'],_0xbeb95d['status'],_0x5b0049[_0x1a20d0(0x147)],_0x5dce50);}catch(_0x4582d5){console[_0x1a20d0(0x15c)]('Error\x20processing\x20Noda\x20webhook:',_0x4582d5),loggerService_1[_0x1a20d0(0x12a)]['logWebhookError'](_0x1a20d0(0xca),_0x4582d5,_0x5dce50);throw _0x4582d5;}}async['processCoinToPayWebhook'](_0x154549){const _0x40b9ce=a64_0x5065a3;console[_0x40b9ce(0x137)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x154549);try{const _0x1895b0=await this[_0x40b9ce(0x9e)][_0x40b9ce(0xb5)](_0x154549);if(!_0x1895b0[_0x40b9ce(0x15e)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x57c039=await database_1[_0x40b9ce(0x6c)][_0x40b9ce(0xe3)]['findFirst']({'where':{'gatewayOrderId':_0x1895b0['paymentId']}});if(!_0x57c039){console[_0x40b9ce(0x15c)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x1895b0[_0x40b9ce(0x15e)]);return;}console[_0x40b9ce(0x137)]('📊\x20CoinToPay\x20webhook:\x20Payment\x20'+_0x57c039['id']+_0x40b9ce(0x13c)+_0x1895b0[_0x40b9ce(0x147)]),await this['updatePaymentStatus'](_0x57c039['id'],_0x1895b0['status']),loggerService_1[_0x40b9ce(0x12a)][_0x40b9ce(0xb3)](_0x40b9ce(0x10b),_0x57c039['id'],_0x57c039[_0x40b9ce(0x147)],_0x1895b0[_0x40b9ce(0x147)],_0x154549);}catch(_0x579549){console[_0x40b9ce(0x15c)](_0x40b9ce(0x126),_0x579549),loggerService_1[_0x40b9ce(0x12a)][_0x40b9ce(0xfb)](_0x40b9ce(0x10b),_0x579549,_0x154549);throw _0x579549;}}async['processCoinToPay2Webhook'](_0x28bc9f){const _0x54109c=a64_0x5065a3;console['log'](_0x54109c(0x173),_0x28bc9f);try{const _0x2dba11=await this['coinToPay2Service'][_0x54109c(0xb5)](_0x28bc9f);if(!_0x2dba11['paymentId'])throw new Error(_0x54109c(0x140));const _0x162ba5=await database_1[_0x54109c(0x6c)]['payment'][_0x54109c(0xde)]({'where':{'gatewayOrderId':_0x2dba11[_0x54109c(0x15e)]}});if(!_0x162ba5){console[_0x54109c(0x15c)](_0x54109c(0x18f)+_0x2dba11[_0x54109c(0x15e)]);return;}console[_0x54109c(0x137)](_0x54109c(0x17c)+_0x162ba5['id']+_0x54109c(0x13c)+_0x2dba11['status']),await this[_0x54109c(0xef)](_0x162ba5['id'],_0x2dba11[_0x54109c(0x147)]),loggerService_1['loggerService'][_0x54109c(0xb3)](_0x54109c(0xb8),_0x162ba5['id'],_0x162ba5[_0x54109c(0x147)],_0x2dba11[_0x54109c(0x147)],_0x28bc9f);}catch(_0x376ed0){console['error'](_0x54109c(0x174),_0x376ed0),loggerService_1['loggerService'][_0x54109c(0xfb)]('cointopay2',_0x376ed0,_0x28bc9f);throw _0x376ed0;}}async['processKlymeWebhook'](_0x15091b){const _0x5d0c8c=a64_0x5065a3;console['log'](_0x5d0c8c(0x146),_0x15091b);try{const _0x528717=await this[_0x5d0c8c(0x87)]['processWebhook'](_0x15091b);if(!_0x528717['paymentId'])throw new Error(_0x5d0c8c(0x14a));const _0x1add6a=await database_1[_0x5d0c8c(0x6c)][_0x5d0c8c(0xe3)][_0x5d0c8c(0xde)]({'where':{'gatewayOrderId':_0x528717[_0x5d0c8c(0x15e)]}});if(!_0x1add6a){console[_0x5d0c8c(0x15c)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x528717[_0x5d0c8c(0x15e)]);return;}console[_0x5d0c8c(0x137)](_0x5d0c8c(0xcf)+_0x1add6a['id']+'\x20status\x20'+_0x528717[_0x5d0c8c(0x147)]),await this[_0x5d0c8c(0xef)](_0x1add6a['id'],_0x528717[_0x5d0c8c(0x147)],{'paymentMethod':_0x528717[_0x5d0c8c(0xe9)]?.[_0x5d0c8c(0x152)]}),loggerService_1[_0x5d0c8c(0x12a)][_0x5d0c8c(0xb3)](_0x5d0c8c(0xf9),_0x1add6a['id'],_0x1add6a['status'],_0x528717['status'],_0x15091b);}catch(_0x4f0fcc){console[_0x5d0c8c(0x15c)](_0x5d0c8c(0xa8),_0x4f0fcc),loggerService_1[_0x5d0c8c(0x12a)]['logWebhookError'](_0x5d0c8c(0xf9),_0x4f0fcc,_0x15091b);throw _0x4f0fcc;}}async[a64_0x5065a3(0x12c)](_0x20bd7b){const _0x28dcd7=a64_0x5065a3;console[_0x28dcd7(0x137)]('🔄\x20Processing\x20VISA\x20webhook:',JSON[_0x28dcd7(0x6f)](_0x20bd7b,null,0x2));try{const _0x3d0a92=await this['visaMasterCardService']['processWebhook'](_0x20bd7b,'VISA');console[_0x28dcd7(0x137)]('📊\x20VISA\x20webhook\x20result:',_0x3d0a92);if(!_0x3d0a92[_0x28dcd7(0x15e)]){console[_0x28dcd7(0x15c)](_0x28dcd7(0x96)),console[_0x28dcd7(0x15c)]('❌\x20Available\x20webhook\x20fields:',Object['keys'](_0x20bd7b));throw new Error('No\x20payment\x20ID\x20in\x20VISA\x20webhook');}let _0x5b3191=null;console['log'](_0x28dcd7(0xa9)+_0x3d0a92[_0x28dcd7(0x15e)]);if(_0x3d0a92[_0x28dcd7(0x15e)]){console[_0x28dcd7(0x137)](_0x28dcd7(0xe2)),console[_0x28dcd7(0x137)](_0x28dcd7(0x85)),console[_0x28dcd7(0x137)]('\x20\x20\x20-\x20Gateway:\x20visa/mastercard\x20or\x20mastercard'),console[_0x28dcd7(0x137)](_0x28dcd7(0x191)+_0x3d0a92[_0x28dcd7(0x15e)]),console[_0x28dcd7(0x137)]('\x20\x20\x20-\x20Will\x20search\x20in:\x20gatewayPaymentId,\x20gatewayOrderId,\x20id,\x20orderId'),_0x5b3191=await database_1[_0x28dcd7(0x6c)][_0x28dcd7(0xe3)][_0x28dcd7(0xde)]({'where':{'AND':[{'OR':[{'gateway':_0x28dcd7(0x7c)},{'gateway':'mastercard'}]},{'OR':[{'gatewayPaymentId':_0x3d0a92['paymentId']},{'gatewayOrderId':_0x3d0a92[_0x28dcd7(0x15e)]},{'id':_0x3d0a92[_0x28dcd7(0x15e)]},{'orderId':_0x3d0a92['paymentId']}]}]},'include':{'shop':{'include':{'settings':!![]}}}}),console[_0x28dcd7(0x137)]('🔍\x20VISA\x20payment\x20search\x20executed');if(_0x5b3191)console['log'](_0x28dcd7(0xa2)+_0x5b3191['id']+_0x28dcd7(0x101)+_0x5b3191[_0x28dcd7(0x185)]+_0x28dcd7(0x121)+_0x5b3191[_0x28dcd7(0x12e)]);else{console['log'](_0x28dcd7(0x144));const _0x13dd91=await database_1['default'][_0x28dcd7(0xe3)][_0x28dcd7(0x157)]({'where':{'gateway':_0x28dcd7(0x7c)},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'cardLast4':!![],'status':!![]},'take':0xa,'orderBy':{'createdAt':_0x28dcd7(0xd0)}});console['log'](_0x28dcd7(0x166),_0x13dd91[_0x28dcd7(0x13e)](_0x64f3f0=>_0x64f3f0['id']+_0x28dcd7(0x129)+_0x64f3f0[_0x28dcd7(0x128)]+',\x20gatewayOrderId:\x20'+_0x64f3f0[_0x28dcd7(0x185)]+_0x28dcd7(0xff)+_0x64f3f0[_0x28dcd7(0x12e)]+',\x20card:\x20****'+_0x64f3f0[_0x28dcd7(0xf5)]+')'));}console['log'](_0x28dcd7(0x10c)+(_0x5b3191?_0x28dcd7(0x183):_0x28dcd7(0xc5))),_0x5b3191&&console[_0x28dcd7(0x137)](_0x28dcd7(0x104)+_0x5b3191['id']+_0x28dcd7(0x106)+_0x5b3191[_0x28dcd7(0x180)]+_0x28dcd7(0x138)+_0x5b3191['status']+',\x20Card=****'+_0x5b3191['cardLast4']);}if(!_0x5b3191){console[_0x28dcd7(0x15c)](_0x28dcd7(0x117)+_0x3d0a92[_0x28dcd7(0x15e)]),loggerService_1[_0x28dcd7(0x12a)][_0x28dcd7(0xfb)](_0x28dcd7(0xa5),new Error(_0x28dcd7(0x139)+_0x3d0a92['paymentId']),_0x20bd7b);throw new Error(_0x28dcd7(0x13b)+_0x3d0a92[_0x28dcd7(0x15e)]);}console['log'](_0x28dcd7(0xd5)+_0x5b3191['id']+_0x28dcd7(0x8d)+_0x5b3191[_0x28dcd7(0x147)]+_0x28dcd7(0xaa)+_0x3d0a92[_0x28dcd7(0x147)]+')');const _0x4ead13={};_0x3d0a92[_0x28dcd7(0x111)]&&await database_1[_0x28dcd7(0x6c)][_0x28dcd7(0xe3)][_0x28dcd7(0x148)]({'where':{'id':_0x5b3191['id']},'data':{'amount':_0x3d0a92[_0x28dcd7(0x111)],'updatedAt':new Date()}}),_0x3d0a92[_0x28dcd7(0x16d)]&&await database_1[_0x28dcd7(0x6c)][_0x28dcd7(0xe3)]['update']({'where':{'id':_0x5b3191['id']},'data':{'currency':_0x3d0a92[_0x28dcd7(0x16d)],'updatedAt':new Date()}}),_0x3d0a92[_0x28dcd7(0x147)]===_0x28dcd7(0xbf)&&_0x3d0a92[_0x28dcd7(0x72)]&&(_0x4ead13['failureMessage']=_0x3d0a92[_0x28dcd7(0x72)],console[_0x28dcd7(0x137)](_0x28dcd7(0xb2)+_0x3d0a92[_0x28dcd7(0x72)])),_0x4ead13[_0x28dcd7(0x184)]=_0x28dcd7(0xa5),await this['updatePaymentStatus'](_0x5b3191['id'],_0x3d0a92[_0x28dcd7(0x147)],_0x4ead13),await database_1['default']['webhookLog'][_0x28dcd7(0x182)]({'data':{'paymentId':_0x5b3191['id'],'shopId':_0x5b3191[_0x28dcd7(0x80)],'event':_0x28dcd7(0x123)+_0x3d0a92['status'][_0x28dcd7(0x9c)](),'statusCode':0xc8,'responseBody':JSON[_0x28dcd7(0x6f)](_0x3d0a92)}}),await this['sendPaymentStatusNotification'](_0x5b3191,_0x3d0a92[_0x28dcd7(0x147)][_0x28dcd7(0xe0)]()),console[_0x28dcd7(0x137)]('✅\x20VISA\x20webhook\x20processed\x20successfully\x20for\x20payment\x20'+_0x5b3191['id']);}catch(_0x1b9028){console[_0x28dcd7(0x15c)](_0x28dcd7(0x13f),_0x1b9028),loggerService_1[_0x28dcd7(0x12a)][_0x28dcd7(0xfb)](_0x28dcd7(0xa5),_0x1b9028,_0x20bd7b);throw _0x1b9028;}}async[a64_0x5065a3(0x161)](_0x13e390){const _0xb8922=a64_0x5065a3;console[_0xb8922(0x137)](_0xb8922(0xd6),JSON[_0xb8922(0x6f)](_0x13e390,null,0x2));try{const _0xec5214=await this['visaMasterCardService'][_0xb8922(0xb5)](_0x13e390,_0xb8922(0x186));console[_0xb8922(0x137)](_0xb8922(0x167),_0xec5214);if(!_0xec5214[_0xb8922(0x15e)]){console[_0xb8922(0x15c)](_0xb8922(0xea)),console[_0xb8922(0x15c)]('❌\x20Available\x20webhook\x20fields:',Object[_0xb8922(0x145)](_0x13e390));throw new Error(_0xb8922(0xa1));}let _0x18b9b8=null;console[_0xb8922(0x137)]('🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20'+_0xec5214[_0xb8922(0x15e)]);_0xec5214[_0xb8922(0x15e)]&&(console[_0xb8922(0x137)](_0xb8922(0x71)),_0x18b9b8=await database_1['default'][_0xb8922(0xe3)][_0xb8922(0xde)]({'where':{'AND':[{'OR':[{'gateway':_0xb8922(0x14f)},{'gateway':_0xb8922(0x163)},{'gateway':_0xb8922(0x7c)}]},{'OR':[{'gatewayPaymentId':_0xec5214[_0xb8922(0x15e)]},{'gatewayOrderId':_0xec5214[_0xb8922(0x15e)]},{'id':_0xec5214[_0xb8922(0x15e)]},{'orderId':_0xec5214['paymentId']}]}]}}),console[_0xb8922(0x137)](_0xb8922(0x17a)+(_0x18b9b8?_0xb8922(0xc1)+_0x18b9b8['id']:'Payment\x20not\x20found')));if(!_0x18b9b8){console[_0xb8922(0x15c)](_0xb8922(0x136)+_0xec5214[_0xb8922(0x15e)]),console[_0xb8922(0x15c)](_0xb8922(0xb0)+_0xec5214['paymentId']+_0xb8922(0x84)+_0xec5214['paymentId']+_0xb8922(0x17e)+_0xec5214[_0xb8922(0x15e)]+'\x22');const _0x537fae=await database_1[_0xb8922(0x6c)]['payment']['findMany']({'where':{'OR':[{'gateway':_0xb8922(0x163)},{'gateway':_0xb8922(0x14f)},{'gateway':_0xb8922(0x7c)}]},'select':{'id':!![],'gateway':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'orderBy':{'id':_0xb8922(0xd0)},'take':0xf});console[_0xb8922(0x137)](_0xb8922(0x169),_0x537fae),loggerService_1['loggerService'][_0xb8922(0xfb)](_0xb8922(0x163),new Error(_0xb8922(0x139)+_0xec5214[_0xb8922(0x15e)]),_0x13e390);throw new Error(_0xb8922(0x9d)+_0xec5214[_0xb8922(0x15e)]);}console[_0xb8922(0x137)]('✅\x20Found\x20payment\x20'+_0x18b9b8['id']+_0xb8922(0x100)+_0x18b9b8[_0xb8922(0x147)]+'\x20to\x20'+_0xec5214[_0xb8922(0x147)]);const _0x396654={};_0xec5214[_0xb8922(0x111)]&&await database_1[_0xb8922(0x6c)][_0xb8922(0xe3)]['update']({'where':{'id':_0x18b9b8['id']},'data':{'amount':_0xec5214[_0xb8922(0x111)],'updatedAt':new Date()}}),_0xec5214[_0xb8922(0x16d)]&&await database_1[_0xb8922(0x6c)][_0xb8922(0xe3)]['update']({'where':{'id':_0x18b9b8['id']},'data':{'currency':_0xec5214['currency'],'updatedAt':new Date()}}),_0xec5214[_0xb8922(0x147)]==='FAILED'&&_0xec5214[_0xb8922(0x72)]&&(_0x396654[_0xb8922(0x72)]=_0xec5214[_0xb8922(0x72)],console[_0xb8922(0x137)](_0xb8922(0xf6)+_0xec5214['failureMessage'])),_0x396654[_0xb8922(0x184)]=_0xb8922(0x163),await this['updatePaymentStatus'](_0x18b9b8['id'],_0xec5214[_0xb8922(0x147)],_0x396654),loggerService_1[_0xb8922(0x12a)][_0xb8922(0xb3)]('mastercard',_0x18b9b8['id'],_0x18b9b8[_0xb8922(0x147)],_0xec5214['status'],_0x13e390);}catch(_0xafbd6c){console['error']('❌\x20Error\x20processing\x20MasterCard\x20webhook:',_0xafbd6c),loggerService_1[_0xb8922(0x12a)][_0xb8922(0xfb)](_0xb8922(0x163),_0xafbd6c,_0x13e390);throw _0xafbd6c;}}async['processAmerWebhook'](_0x4b10f3){const _0x29b259=a64_0x5065a3;console[_0x29b259(0x137)]('🔄\x20Processing\x20Amer\x20webhook:',JSON[_0x29b259(0x6f)](_0x4b10f3,null,0x2));try{const _0x17a159=await this[_0x29b259(0x18d)][_0x29b259(0xb5)](_0x4b10f3);console[_0x29b259(0x137)](_0x29b259(0xb1),_0x17a159);if(!_0x17a159[_0x29b259(0x15e)]){console['error'](_0x29b259(0x119)),console[_0x29b259(0x15c)]('❌\x20Available\x20webhook\x20fields:',Object[_0x29b259(0x145)](_0x4b10f3));throw new Error('No\x20payment\x20ID\x20in\x20Amer\x20webhook');}let _0x4e68af=null;console[_0x29b259(0x137)](_0x29b259(0x14b)+_0x17a159[_0x29b259(0x15e)]),_0x4e68af=await database_1[_0x29b259(0x6c)][_0x29b259(0xe3)][_0x29b259(0xde)]({'where':{'AND':[{'gateway':_0x29b259(0x105)},{'OR':[{'gatewayPaymentId':_0x17a159[_0x29b259(0x15e)]},{'gatewayOrderId':_0x17a159[_0x29b259(0x15e)]},{'id':_0x17a159[_0x29b259(0x15e)]},{'orderId':_0x17a159[_0x29b259(0x15e)]}]}]}}),console[_0x29b259(0x137)](_0x29b259(0x17a)+(_0x4e68af?_0x29b259(0xc1)+_0x4e68af['id']:_0x29b259(0x155)));if(!_0x4e68af){console[_0x29b259(0x15c)]('❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20'+_0x17a159['paymentId']);return;}console[_0x29b259(0x137)](_0x29b259(0xd8)+_0x4e68af['id']+_0x29b259(0x13c)+_0x17a159[_0x29b259(0x147)]),await this[_0x29b259(0xef)](_0x4e68af['id'],_0x17a159['status'],{'cardLast4':_0x17a159['additionalInfo']?.[_0x29b259(0xf5)],'paymentMethod':_0x17a159[_0x29b259(0xe9)]?.['paymentMethod']});}catch(_0x14f5ce){console[_0x29b259(0x15c)](_0x29b259(0x8a),_0x14f5ce),loggerService_1['loggerService'][_0x29b259(0xfb)](_0x29b259(0x105),_0x14f5ce,_0x4b10f3);throw _0x14f5ce;}}async['processAmPayWebhook'](_0x431eff){const _0x3eaa9e=a64_0x5065a3;console[_0x3eaa9e(0x137)](_0x3eaa9e(0x134),JSON[_0x3eaa9e(0x6f)](_0x431eff,null,0x2));try{const _0x4d50d0=_0x431eff[_0x3eaa9e(0x147)],_0x5d9276=_0x431eff[_0x3eaa9e(0x102)],_0x581d52=_0x431eff['system_id'],_0x3c1a4f=_0x431eff[_0x3eaa9e(0x152)],_0x521f3b=_0x431eff[_0x3eaa9e(0x111)],_0x196229=_0x431eff[_0x3eaa9e(0x16d)],_0x45f5f9=_0x431eff[_0x3eaa9e(0x99)],_0x35a163=_0x431eff[_0x3eaa9e(0x8e)];if(!_0x5d9276){console[_0x3eaa9e(0x15c)](_0x3eaa9e(0x122));throw new Error(_0x3eaa9e(0xfa));}console[_0x3eaa9e(0x137)]('📊\x20AmPay\x20webhook\x20data:',{'status':_0x4d50d0,'clientTransactionId':_0x5d9276,'systemId':_0x581d52,'paymentMethod':_0x3c1a4f,'amount':_0x521f3b,'currency':_0x196229,'commission':_0x45f5f9,'statusAdditionInfo':_0x35a163});const _0x2b86cf=await database_1['default'][_0x3eaa9e(0xe3)]['findFirst']({'where':{'OR':[{'gatewayOrderId':_0x5d9276},{'orderId':_0x5d9276},{'id':_0x5d9276},{'gatewayPaymentId':_0x5d9276}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x2b86cf){console['error'](_0x3eaa9e(0x18c)+_0x5d9276);throw new Error(_0x3eaa9e(0x139)+_0x5d9276);}console[_0x3eaa9e(0x137)](_0x3eaa9e(0x130)+_0x2b86cf['id']+'\x20for\x20AmPay\x20webhook'),console['log'](_0x3eaa9e(0x172)+_0x2b86cf[_0x3eaa9e(0x147)]+_0x3eaa9e(0xaa)+_0x4d50d0),_0x4d50d0===_0x3eaa9e(0x93)?(console[_0x3eaa9e(0x137)](_0x3eaa9e(0xad)),await this[_0x3eaa9e(0xef)](_0x2b86cf['id'],'FAILED'),console[_0x3eaa9e(0x137)](_0x3eaa9e(0xe6)+_0x2b86cf['id']+_0x3eaa9e(0x197)),console['log'](_0x3eaa9e(0xf3)+(_0x35a163||_0x3eaa9e(0x75)))):console['log'](_0x3eaa9e(0x160)+_0x4d50d0+_0x3eaa9e(0x125)),await database_1[_0x3eaa9e(0x6c)]['webhookLog'][_0x3eaa9e(0x182)]({'data':{'paymentId':_0x2b86cf['id'],'shopId':_0x2b86cf['shopId'],'event':_0x3eaa9e(0x190)+(_0x4d50d0?.[_0x3eaa9e(0x9c)]()||_0x3eaa9e(0xe7)),'statusCode':0xc8,'responseBody':JSON[_0x3eaa9e(0x6f)](_0x431eff)}}),loggerService_1['loggerService']['logWebhookProcessed'](_0x3eaa9e(0x142),_0x2b86cf['id'],_0x2b86cf['status'],_0x4d50d0===_0x3eaa9e(0x93)?_0x3eaa9e(0xbf):_0x4d50d0,_0x431eff);}catch(_0x2e1f6e){console[_0x3eaa9e(0x15c)](_0x3eaa9e(0xf2),_0x2e1f6e),loggerService_1[_0x3eaa9e(0x12a)][_0x3eaa9e(0xfb)](_0x3eaa9e(0x142),_0x2e1f6e,_0x431eff);throw _0x2e1f6e;}}async[a64_0x5065a3(0xc2)](_0x49d653,_0x4c7996){const _0x2f45f8=a64_0x5065a3,_0x472003=Date['now']();try{const _0x50de8c=_0x49d653[_0x2f45f8(0xdb)],_0x4dfb1c=_0x50de8c['settings'];if(!_0x4dfb1c?.['webhookUrl']){console[_0x2f45f8(0x137)](_0x2f45f8(0xd9)+_0x50de8c['id']);return;}const _0x5e0c99=_0x4c7996==='PAID'?_0x2f45f8(0x86):_0x4c7996===_0x2f45f8(0xbf)?_0x2f45f8(0xe5):_0x4c7996===_0x2f45f8(0xb7)?_0x2f45f8(0xe5):_0x4c7996===_0x2f45f8(0xcb)?'payment.failed':_0x4c7996==='REFUND'?_0x2f45f8(0xe5):'payment.pending';let _0x15c0e2=[];if(_0x4dfb1c['webhookEvents'])try{_0x15c0e2=Array[_0x2f45f8(0x103)](_0x4dfb1c[_0x2f45f8(0x18e)])?_0x4dfb1c[_0x2f45f8(0x18e)]:JSON['parse'](_0x4dfb1c[_0x2f45f8(0x18e)]);}catch(_0x344ae5){console[_0x2f45f8(0x15c)](_0x2f45f8(0xec),_0x344ae5),_0x15c0e2=[];}if(!_0x15c0e2[_0x2f45f8(0x78)](_0x5e0c99)){console['log'](_0x2f45f8(0x18b)+_0x5e0c99+'\x20not\x20enabled\x20for\x20shop\x20'+_0x50de8c['id']);return;}const _0x2cce78={'event':_0x5e0c99,'payment':{'id':_0x49d653['id'],'order_id':_0x49d653['orderId'],'gateway_order_id':_0x49d653[_0x2f45f8(0x185)],'gateway':_0x49d653[_0x2f45f8(0x180)],'amount':_0x49d653[_0x2f45f8(0x111)],'currency':_0x49d653[_0x2f45f8(0x16d)],'status':_0x4c7996[_0x2f45f8(0x9c)](),'customer_email':_0x49d653[_0x2f45f8(0x141)],'customer_name':_0x49d653[_0x2f45f8(0xd4)],'failure_message':_0x49d653[_0x2f45f8(0x72)],'tx_urls':_0x49d653[_0x2f45f8(0x113)]?JSON[_0x2f45f8(0x11e)](_0x49d653[_0x2f45f8(0x113)]):null,'created_at':_0x49d653[_0x2f45f8(0x133)],'updated_at':_0x49d653['updatedAt']}},_0x2fb172=await fetch(_0x4dfb1c[_0x2f45f8(0xdc)],{'method':_0x2f45f8(0xd3),'headers':{'Content-Type':_0x2f45f8(0x7f),'User-Agent':_0x2f45f8(0x10f)},'body':JSON[_0x2f45f8(0x6f)](_0x2cce78)}),_0x33bfc7=Date[_0x2f45f8(0xeb)]()-_0x472003,_0x3ee4dd=_0x2fb172['ok']?_0x2f45f8(0xaf):await _0x2fb172['text']();loggerService_1[_0x2f45f8(0x12a)][_0x2f45f8(0x127)](_0x49d653[_0x2f45f8(0x80)],_0x4dfb1c[_0x2f45f8(0xdc)],_0x5e0c99,_0x2fb172[_0x2f45f8(0x147)],_0x33bfc7,_0x2cce78),console[_0x2f45f8(0x137)](_0x2f45f8(0x109)+_0x4dfb1c['webhookUrl']+'\x20with\x20status\x20'+_0x2fb172[_0x2f45f8(0x147)]+'\x20('+_0x33bfc7+_0x2f45f8(0x198));}catch(_0x489779){console[_0x2f45f8(0x15c)](_0x2f45f8(0x94),_0x489779),loggerService_1[_0x2f45f8(0x12a)][_0x2f45f8(0x159)](_0x49d653[_0x2f45f8(0x80)],_0x49d653[_0x2f45f8(0xdb)]?.[_0x2f45f8(0x165)]?.['webhookUrl']||_0x2f45f8(0xe7),_0x2f45f8(0xc9),_0x489779,{});}}async[a64_0x5065a3(0x188)](_0x59ebf9,_0xd421dd){const _0x129166=a64_0x5065a3;try{const _0x62e51f={'PENDING':'created','PROCESSING':_0x129166(0x181),'PAID':_0x129166(0xc4),'FAILED':_0x129166(0xba),'EXPIRED':_0x129166(0xa4),'REFUND':_0x129166(0x175),'CHARGEBACK':_0x129166(0x171)},_0x2f704d=_0x62e51f[_0xd421dd];if(!_0x2f704d||_0x2f704d===_0x129166(0xfe))return;await telegramBotService_1[_0x129166(0xdf)][_0x129166(0x12b)](_0x59ebf9[_0x129166(0x80)],_0x59ebf9,_0x2f704d);}catch(_0x182fdf){console[_0x129166(0x15c)](_0x129166(0x92),_0x182fdf);}}async[a64_0x5065a3(0xe8)](_0x1ca1a2,_0x1dd8ae){const _0x3d8fbb=a64_0x5065a3;try{const _0x122cd8=await database_1[_0x3d8fbb(0x6c)][_0x3d8fbb(0xdb)][_0x3d8fbb(0x15a)]({'where':{'id':_0x1ca1a2},'select':{'gatewaySettings':!![]}});if(!_0x122cd8?.[_0x3d8fbb(0x7b)])return console[_0x3d8fbb(0x137)](_0x3d8fbb(0xce)+_0x1ca1a2+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x40d2dc=JSON[_0x3d8fbb(0x11e)](_0x122cd8[_0x3d8fbb(0x7b)]);for(const [_0x426664,_0x3d6ba6]of Object[_0x3d8fbb(0x95)](_0x40d2dc)){if(_0x426664[_0x3d8fbb(0x9c)]()===_0x1dd8ae[_0x3d8fbb(0x9c)]()){const _0x41bae5=_0x3d6ba6['commission']||0xa;return console['log'](_0x3d8fbb(0xb9)+_0x1dd8ae+_0x3d8fbb(0x195)+_0x1ca1a2+':\x20'+_0x41bae5+'%'),_0x41bae5;}}return console['log'](_0x3d8fbb(0x82)+_0x1dd8ae+_0x3d8fbb(0x14d)+_0x1ca1a2+_0x3d8fbb(0xbb)),0xa;}catch(_0x42f763){return console['error']('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x1ca1a2+_0x3d8fbb(0x18a)+_0x1dd8ae+':',_0x42f763),0xa;}}async[a64_0x5065a3(0x17f)](_0x2078cc,_0x4ca695){const _0x20b95e=a64_0x5065a3;console[_0x20b95e(0x137)](_0x20b95e(0x15d)),console[_0x20b95e(0x137)]('Query\x20params:',JSON[_0x20b95e(0x6f)](_0x2078cc,null,0x2)),console[_0x20b95e(0x137)](_0x20b95e(0x6b),JSON[_0x20b95e(0x6f)](_0x4ca695,null,0x2));try{const _0x293549=_0x2078cc[_0x20b95e(0x6e)]||_0x4ca695[_0x20b95e(0x6e)],_0x192a29=_0x2078cc[_0x20b95e(0x147)]||_0x4ca695[_0x20b95e(0x147)],_0x35e0ec=_0x2078cc[_0x20b95e(0x111)]||_0x4ca695[_0x20b95e(0x111)],_0x1c86ae=_0x2078cc[_0x20b95e(0x16d)]||_0x4ca695[_0x20b95e(0x16d)],_0x5d761d=_0x2078cc[_0x20b95e(0x108)]||_0x4ca695[_0x20b95e(0x108)];if(!_0x293549){console[_0x20b95e(0x15c)]('❌\x20No\x20customerOrderId\x20found\x20in\x20MyXSpend\x20webhook');throw new Error(_0x20b95e(0x193));}console['log']('📊\x20MyXSpend\x20webhook\x20data:',{'customerOrderId':_0x293549,'status':_0x192a29,'amount':_0x35e0ec,'currency':_0x1c86ae,'dateTime':_0x5d761d});const _0x17978c=await database_1[_0x20b95e(0x6c)][_0x20b95e(0xe3)][_0x20b95e(0xde)]({'where':{'OR':[{'gatewayOrderId':_0x293549},{'orderId':_0x293549},{'id':_0x293549},{'gatewayPaymentId':_0x293549}]},'include':{'shop':{'include':{'settings':!![]}}}});if(!_0x17978c){console[_0x20b95e(0x15c)](_0x20b95e(0x97)+_0x293549);throw new Error(_0x20b95e(0x139)+_0x293549);}console['log'](_0x20b95e(0x130)+_0x17978c['id']+_0x20b95e(0x11d)),console[_0x20b95e(0x137)](_0x20b95e(0x172)+_0x17978c[_0x20b95e(0x147)]+'\x20→\x20'+_0x192a29);let _0x4c2523=_0x192a29?.[_0x20b95e(0xe0)]();_0x192a29===_0x20b95e(0xbf)||_0x192a29===_0x20b95e(0xb7)?(_0x4c2523=_0x20b95e(0xbf),console[_0x20b95e(0x137)](_0x20b95e(0x120)+_0x192a29+_0x20b95e(0x10d)),await this[_0x20b95e(0xef)](_0x17978c['id'],_0x4c2523),console['log'](_0x20b95e(0x16f)+_0x17978c['id']+_0x20b95e(0x197))):console[_0x20b95e(0x137)]('ℹ️\x20MyXSpend\x20status\x20'+_0x192a29+'\x20-\x20no\x20action\x20taken\x20(only\x20FAILED/EXPIRED\x20are\x20processed)'),await database_1[_0x20b95e(0x6c)][_0x20b95e(0xe4)]['create']({'data':{'paymentId':_0x17978c['id'],'shopId':_0x17978c['shopId'],'event':_0x20b95e(0x168)+(_0x192a29?.[_0x20b95e(0x9c)]()||_0x20b95e(0xe7)),'statusCode':0xc8,'responseBody':JSON[_0x20b95e(0x6f)]({'queryParams':_0x2078cc,'bodyData':_0x4ca695})}}),loggerService_1[_0x20b95e(0x12a)]['logWebhookProcessed']('myxspend',_0x17978c['id'],_0x17978c[_0x20b95e(0x147)],_0x4c2523||_0x192a29,{'queryParams':_0x2078cc,'bodyData':_0x4ca695});}catch(_0x463cdb){console[_0x20b95e(0x15c)](_0x20b95e(0xed),_0x463cdb),loggerService_1[_0x20b95e(0x12a)][_0x20b95e(0xfb)]('myxspend',_0x463cdb,{'queryParams':_0x2078cc,'bodyData':_0x4ca695});throw _0x463cdb;}}}exports[a64_0x5065a3(0xd7)]=WebhookService;