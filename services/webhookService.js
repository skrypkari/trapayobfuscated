'use strict';const a52_0x121711=a52_0x12e4;(function(_0x1047fa,_0x30a004){const _0x363a78=a52_0x12e4,_0x166a7a=_0x1047fa();while(!![]){try{const _0x3ebead=-parseInt(_0x363a78(0xc5))/0x1*(-parseInt(_0x363a78(0x11e))/0x2)+-parseInt(_0x363a78(0x130))/0x3+-parseInt(_0x363a78(0x108))/0x4+-parseInt(_0x363a78(0xf7))/0x5*(parseInt(_0x363a78(0xd1))/0x6)+-parseInt(_0x363a78(0xe2))/0x7+-parseInt(_0x363a78(0xcc))/0x8+parseInt(_0x363a78(0x135))/0x9*(parseInt(_0x363a78(0xe5))/0xa);if(_0x3ebead===_0x30a004)break;else _0x166a7a['push'](_0x166a7a['shift']());}catch(_0x17cf6e){_0x166a7a['push'](_0x166a7a['shift']());}}}(a52_0x4ccb,0xabdaa));var __importDefault=this&&this['__importDefault']||function(_0x377692){return _0x377692&&_0x377692['__esModule']?_0x377692:{'default':_0x377692};};Object['defineProperty'](exports,a52_0x121711(0x137),{'value':!![]}),exports[a52_0x121711(0xcd)]=void 0x0;function a52_0x12e4(_0x79a86b,_0xd8478d){const _0x4ccbf3=a52_0x4ccb();return a52_0x12e4=function(_0x12e4a9,_0x1b8fd4){_0x12e4a9=_0x12e4a9-0xad;let _0x3cc0d4=_0x4ccbf3[_0x12e4a9];return _0x3cc0d4;},a52_0x12e4(_0x79a86b,_0xd8478d);}function a52_0x4ccb(){const _0x24e1fe=['PaymentLinkService','Error\x20processing\x20KLYME\x20webhook:','\x20failure\x20message:\x20','./gateways/nodaService','webhookLog','processKlymeWebhook','ðŸ’¾\x20Saving\x20failure\x20message:\x20','klyme','398169xDCdVK','./gateways/coinToPayService','Processing\x20CoinToPay\x20webhook:','currency','KlymeService','9IKeYeg','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20Gateway\x20webhook','__esModule','gatewayOrderId','txUrls','settings','default','processPlisioWebhook','length','status','includes','ðŸ’¾\x20Failure\x20message\x20saved:\x20','amount','klyme_','Shop\x20webhook\x20sent\x20to\x20','Error\x20processing\x20Rapyd\x20webhook:','CoinToPayService','ðŸ’¾\x20Transaction\x20URLs\x20saved:\x20','coinToPayService','\x20status\x20change:\x20','klyme_eu','rapyd','./telegramBotService','./gateways/plisioService','\x20->\x20','\x20not\x20enabled\x20for\x20shop\x20','./paymentLinkService','webhook_send','logWebhookProcessed','findFirst','12IChDyB','ðŸ’¥\x20Payment\x20','No\x20payment\x20ID\x20found\x20in\x20Plisio\x20webhook','log','No\x20payment\x20ID\x20found\x20in\x20Noda\x20webhook','../config/database','processNodaWebhook','1128832VJSPnI','WebhookService','\x20with\x20status\x20','updatePaymentStatus','PAID','18BLxvfd','PlisioService','plisio','bankId','now','klymeService','\x20status\x20to\x20','\x20transaction\x20URLs:','additionalInfo','cointopay','Error\x20processing\x20CoinToPay\x20webhook:','unknown','error','payment.success','gateway','paymentMethod','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','5812205AukpZx','logWebhookError','Payment\x20','14157640VmoTrX','Error\x20processing\x20Plisio\x20webhook:','./loggerService','payment.pending','TesSoft\x20Payment\x20System/1.0','paymentId','No\x20payment\x20ID\x20found\x20in\x20KLYME\x20webhook','update','Error\x20parsing\x20webhook\x20events:','toLowerCase','customerEmail','Processing\x20Plisio\x20Gateway\x20webhook:','NodaService','failed','rapydService','cardLast4','\x20and\x20gateway:\x20','shopId','102895ZMXmjA','Processing\x20Rapyd\x20webhook:','processWebhook','processPlisioGatewayWebhook','stringify','FAILED','plisio_gateway','paymentLinkService','Payment\x20not\x20found\x20for\x20gatewayOrderId:\x20','processRapydWebhook','remitterIban','sendPaymentNotification','isArray','./gateways/rapydService','RapydService','Failed\x20to\x20send\x20shop\x20webhook:','sendPaymentStatusNotification','2933532HzUdPn','No\x20payment\x20ID\x20found\x20in\x20CoinToPay\x20webhook','sendShopWebhook','created','payment.failed','failureMessage','orderId','nodaService','loggerService','paidAt','parse','webhookEvents','expired','text','processCoinToPayWebhook','region','createdAt','\x20status\x20unchanged\x20(','Error\x20parsing\x20tx_urls\x20for\x20webhook:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','ðŸ”„\x20Updating\x20payment\x20','plisioService','197902fUAiui','Success','./gateways/klymeService','telegramBotService','PENDING','Processing\x20Noda\x20webhook:','paid','payment','remitterName','webhookUrl'];a52_0x4ccb=function(){return _0x24e1fe;};return a52_0x4ccb();}const database_1=__importDefault(require(a52_0x121711(0xca))),plisioService_1=require(a52_0x121711(0xbe)),rapydService_1=require(a52_0x121711(0x104)),nodaService_1=require(a52_0x121711(0x12b)),coinToPayService_1=require(a52_0x121711(0x131)),klymeService_1=require(a52_0x121711(0x120)),telegramBotService_1=require(a52_0x121711(0xbd)),paymentLinkService_1=require(a52_0x121711(0xc1)),loggerService_1=require(a52_0x121711(0xe7));class WebhookService{constructor(){const _0x6b0323=a52_0x121711;this[_0x6b0323(0x11d)]=new plisioService_1[(_0x6b0323(0xd2))](),this[_0x6b0323(0xf3)]=new rapydService_1[(_0x6b0323(0x105))](),this[_0x6b0323(0x10f)]=new nodaService_1[(_0x6b0323(0xf1))](),this['coinToPayService']=new coinToPayService_1[(_0x6b0323(0xb7))](),this[_0x6b0323(0xd6)]=new klymeService_1[(_0x6b0323(0x134))](),this[_0x6b0323(0xfe)]=new paymentLinkService_1[(_0x6b0323(0x128))]();}async[a52_0x121711(0xae)](_0x2c7dd4){const _0x30b226=a52_0x121711;console[_0x30b226(0xc8)]('Processing\x20Plisio\x20webhook:',_0x2c7dd4);try{const _0x49cc08=await this[_0x30b226(0x11d)]['processWebhook'](_0x2c7dd4);if(!_0x49cc08[_0x30b226(0xea)]){console[_0x30b226(0xdd)](_0x30b226(0xc7));return;}await this[_0x30b226(0xcf)](_0x49cc08[_0x30b226(0xea)],_0x49cc08[_0x30b226(0xb0)],_0x30b226(0xd3),_0x2c7dd4,undefined,undefined,_0x49cc08[_0x30b226(0x139)]),loggerService_1[_0x30b226(0x110)]['logWebhookProcessed'](_0x30b226(0xd3),_0x49cc08[_0x30b226(0xea)],_0x30b226(0x122),_0x49cc08['status'],_0x2c7dd4);}catch(_0xefb02e){console['error'](_0x30b226(0xe6),_0xefb02e),loggerService_1[_0x30b226(0x110)][_0x30b226(0xe3)]('plisio',_0xefb02e,_0x2c7dd4);throw _0xefb02e;}}async[a52_0x121711(0xfa)](_0x514a24){const _0x170b94=a52_0x121711;console[_0x170b94(0xc8)](_0x170b94(0xf0),_0x514a24);try{const _0x421d2c=await this[_0x170b94(0x11d)]['processWebhook'](_0x514a24);if(!_0x421d2c[_0x170b94(0xea)]){console[_0x170b94(0xdd)](_0x170b94(0x136));return;}await this[_0x170b94(0xcf)](_0x421d2c[_0x170b94(0xea)],_0x421d2c[_0x170b94(0xb0)],_0x170b94(0xd3),_0x514a24,undefined,undefined,_0x421d2c[_0x170b94(0x139)]),loggerService_1[_0x170b94(0x110)][_0x170b94(0xc3)](_0x170b94(0xfd),_0x421d2c[_0x170b94(0xea)],_0x170b94(0x122),_0x421d2c['status'],_0x514a24);}catch(_0x3e9ca3){console['error']('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x3e9ca3),loggerService_1[_0x170b94(0x110)][_0x170b94(0xe3)]('plisio_gateway',_0x3e9ca3,_0x514a24);throw _0x3e9ca3;}}async[a52_0x121711(0x100)](_0x447364){const _0x599ee9=a52_0x121711;console[_0x599ee9(0xc8)](_0x599ee9(0xf8),_0x447364);try{const _0x3aee9e=await this[_0x599ee9(0xf3)]['processWebhook'](_0x447364);if(!_0x3aee9e[_0x599ee9(0xea)]){console['error']('No\x20payment\x20ID\x20found\x20in\x20Rapyd\x20webhook');return;}await this[_0x599ee9(0xcf)](_0x3aee9e['paymentId'],_0x3aee9e[_0x599ee9(0xb0)],_0x599ee9(0xbc),_0x447364,_0x3aee9e[_0x599ee9(0x10d)],_0x3aee9e[_0x599ee9(0xd9)]),loggerService_1[_0x599ee9(0x110)][_0x599ee9(0xc3)](_0x599ee9(0xbc),_0x3aee9e[_0x599ee9(0xea)],_0x599ee9(0x122),_0x3aee9e[_0x599ee9(0xb0)],_0x447364);}catch(_0x49363e){console['error'](_0x599ee9(0xb6),_0x49363e),loggerService_1[_0x599ee9(0x110)][_0x599ee9(0xe3)](_0x599ee9(0xbc),_0x49363e,_0x447364);throw _0x49363e;}}async[a52_0x121711(0xcb)](_0x1cf7e0){const _0x5c60cf=a52_0x121711;console[_0x5c60cf(0xc8)](_0x5c60cf(0x123),_0x1cf7e0);try{const _0x116548=await this[_0x5c60cf(0x10f)][_0x5c60cf(0xf9)](_0x1cf7e0);if(!_0x116548[_0x5c60cf(0xea)]){console[_0x5c60cf(0xdd)](_0x5c60cf(0xc9));return;}await this['updatePaymentStatus'](_0x116548[_0x5c60cf(0xea)],_0x116548[_0x5c60cf(0xb0)],'noda',_0x1cf7e0,undefined,_0x116548[_0x5c60cf(0xd9)]),loggerService_1['loggerService'][_0x5c60cf(0xc3)]('noda',_0x116548['paymentId'],_0x5c60cf(0x122),_0x116548[_0x5c60cf(0xb0)],_0x1cf7e0);}catch(_0x1bf1a9){console[_0x5c60cf(0xdd)]('Error\x20processing\x20Noda\x20webhook:',_0x1bf1a9),loggerService_1[_0x5c60cf(0x110)][_0x5c60cf(0xe3)]('noda',_0x1bf1a9,_0x1cf7e0);throw _0x1bf1a9;}}async[a52_0x121711(0x116)](_0x15882a){const _0x4e9dc8=a52_0x121711;console[_0x4e9dc8(0xc8)](_0x4e9dc8(0x132),_0x15882a);try{const _0x46c185=await this[_0x4e9dc8(0xb9)][_0x4e9dc8(0xf9)](_0x15882a);if(!_0x46c185[_0x4e9dc8(0xea)]){console[_0x4e9dc8(0xdd)](_0x4e9dc8(0x109));return;}await this['updatePaymentStatus'](_0x46c185[_0x4e9dc8(0xea)],_0x46c185[_0x4e9dc8(0xb0)],'cointopay',_0x15882a),loggerService_1['loggerService'][_0x4e9dc8(0xc3)](_0x4e9dc8(0xda),_0x46c185[_0x4e9dc8(0xea)],'PENDING',_0x46c185['status'],_0x15882a);}catch(_0x3bdd75){console['error'](_0x4e9dc8(0xdb),_0x3bdd75),loggerService_1[_0x4e9dc8(0x110)][_0x4e9dc8(0xe3)](_0x4e9dc8(0xda),_0x3bdd75,_0x15882a);throw _0x3bdd75;}}async[a52_0x121711(0x12d)](_0x4bb4a2){const _0x1141e7=a52_0x121711;console[_0x1141e7(0xc8)]('Processing\x20KLYME\x20webhook:',_0x4bb4a2);try{const _0x88052b=await this[_0x1141e7(0xd6)][_0x1141e7(0xf9)](_0x4bb4a2);if(!_0x88052b[_0x1141e7(0xea)]){console[_0x1141e7(0xdd)](_0x1141e7(0xeb));return;}const _0x5e4a9e=_0x88052b[_0x1141e7(0x117)]?_0x1141e7(0xb4)+_0x88052b['region'][_0x1141e7(0xee)]():_0x1141e7(0xbb);await this[_0x1141e7(0xcf)](_0x88052b['paymentId'],_0x88052b['status'],_0x5e4a9e,_0x4bb4a2,undefined,_0x88052b[_0x1141e7(0xd9)]),loggerService_1[_0x1141e7(0x110)][_0x1141e7(0xc3)]('klyme',_0x88052b['paymentId'],_0x1141e7(0x122),_0x88052b[_0x1141e7(0xb0)],_0x4bb4a2);}catch(_0x50c9c1){console[_0x1141e7(0xdd)](_0x1141e7(0x129),_0x50c9c1),loggerService_1[_0x1141e7(0x110)][_0x1141e7(0xe3)](_0x1141e7(0x12f),_0x50c9c1,_0x4bb4a2);throw _0x50c9c1;}}async[a52_0x121711(0xcf)](_0x33cfaa,_0xf236,_0x16bfee,_0x52ec8f,_0x2e284f,_0x11c6e9,_0x2f7383){const _0x3ea82a=a52_0x121711;console[_0x3ea82a(0xc8)](_0x3ea82a(0x11c)+_0x33cfaa+_0x3ea82a(0xd7)+_0xf236+'\x20from\x20'+_0x16bfee+'\x20webhook');_0x2e284f&&console[_0x3ea82a(0xc8)](_0x3ea82a(0xc6)+_0x33cfaa+_0x3ea82a(0x12a)+_0x2e284f);_0x2f7383&&_0x2f7383['length']>0x0&&console['log']('ðŸ”—\x20Payment\x20'+_0x33cfaa+_0x3ea82a(0xd8),_0x2f7383);const _0x1cf2a5=await database_1[_0x3ea82a(0xad)][_0x3ea82a(0x125)][_0x3ea82a(0xc4)]({'where':{'gatewayOrderId':_0x33cfaa,'gateway':_0x16bfee},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1cf2a5){console[_0x3ea82a(0xdd)](_0x3ea82a(0xff)+_0x33cfaa+_0x3ea82a(0xf5)+_0x16bfee);return;}const _0x3074a4=_0x1cf2a5[_0x3ea82a(0xb0)];if(_0x3074a4===_0xf236){console['log'](_0x3ea82a(0xe4)+_0x1cf2a5['id']+_0x3ea82a(0x119)+_0xf236+')');return;}console['log'](_0x3ea82a(0xe4)+_0x1cf2a5['id']+_0x3ea82a(0xba)+_0x3074a4+_0x3ea82a(0xbf)+_0xf236);const _0x3b20cd={'status':_0xf236,'updatedAt':new Date()};_0x2e284f&&(_0x3b20cd['failureMessage']=_0x2e284f,console[_0x3ea82a(0xc8)](_0x3ea82a(0x12e)+_0x2e284f));_0x2f7383&&_0x2f7383['length']>0x0&&(_0x3b20cd['txUrls']=JSON[_0x3ea82a(0xfb)](_0x2f7383),console['log']('ðŸ’¾\x20Saving\x20transaction\x20URLs:\x20'+JSON[_0x3ea82a(0xfb)](_0x2f7383)));_0xf236===_0x3ea82a(0xd0)&&_0x3074a4!==_0x3ea82a(0xd0)&&(_0x3b20cd[_0x3ea82a(0x111)]=new Date());_0x11c6e9&&(_0x11c6e9[_0x3ea82a(0xf4)]&&(_0x3b20cd['cardLast4']=_0x11c6e9[_0x3ea82a(0xf4)]),_0x11c6e9[_0x3ea82a(0xe0)]&&(_0x3b20cd[_0x3ea82a(0xe0)]=_0x11c6e9[_0x3ea82a(0xe0)]),_0x11c6e9['bankId']&&(_0x3b20cd['bankId']=_0x11c6e9[_0x3ea82a(0xd4)]),_0x11c6e9[_0x3ea82a(0x101)]&&(_0x3b20cd[_0x3ea82a(0x101)]=_0x11c6e9[_0x3ea82a(0x101)]),_0x11c6e9[_0x3ea82a(0x126)]&&(_0x3b20cd[_0x3ea82a(0x126)]=_0x11c6e9[_0x3ea82a(0x126)]));await database_1[_0x3ea82a(0xad)][_0x3ea82a(0x125)][_0x3ea82a(0xec)]({'where':{'id':_0x1cf2a5['id']},'data':_0x3b20cd});if(_0xf236===_0x3ea82a(0xd0)&&_0x3074a4!==_0x3ea82a(0xd0))try{await this[_0x3ea82a(0xfe)]['handleSuccessfulPayment'](_0x1cf2a5['id']);}catch(_0x39491f){console[_0x3ea82a(0xdd)]('Failed\x20to\x20update\x20payment\x20link\x20counter:',_0x39491f);}await database_1['default'][_0x3ea82a(0x12c)]['create']({'data':{'paymentId':_0x1cf2a5['id'],'shopId':_0x1cf2a5[_0x3ea82a(0xf6)],'event':_0x16bfee+'_webhook_'+_0xf236[_0x3ea82a(0xee)](),'statusCode':0xc8,'responseBody':JSON[_0x3ea82a(0xfb)]({'oldStatus':_0x3074a4,'newStatus':_0xf236,'failureMessage':_0x2e284f,'txUrls':_0x2f7383,'webhookData':_0x52ec8f})}}),await this['sendShopWebhook'](_0x1cf2a5,_0xf236),await this[_0x3ea82a(0x107)](_0x1cf2a5,_0xf236),console[_0x3ea82a(0xc8)]('âœ…\x20Payment\x20'+_0x1cf2a5['id']+'\x20updated\x20successfully:\x20'+_0x3074a4+_0x3ea82a(0xbf)+_0xf236),_0x2e284f&&console[_0x3ea82a(0xc8)](_0x3ea82a(0xb2)+_0x2e284f),_0x2f7383&&_0x2f7383[_0x3ea82a(0xaf)]>0x0&&console['log'](_0x3ea82a(0xb8)+_0x2f7383['length']+'\x20URLs');}async[a52_0x121711(0x10a)](_0x3e3270,_0x1e7ed0){const _0x10e148=a52_0x121711,_0x4a7edb=Date[_0x10e148(0xd5)]();try{const _0x142bc8=_0x3e3270['shop'],_0x3df9c6=_0x142bc8['settings'];if(!_0x3df9c6?.[_0x10e148(0x127)]){console[_0x10e148(0xc8)](_0x10e148(0xe1)+_0x142bc8['id']);return;}const _0x55b01d=_0x1e7ed0===_0x10e148(0xd0)?_0x10e148(0xde):_0x1e7ed0===_0x10e148(0xfc)?_0x10e148(0x10c):_0x1e7ed0==='EXPIRED'?_0x10e148(0x10c):_0x10e148(0xe8);let _0x379233=[];if(_0x3df9c6[_0x10e148(0x113)])try{_0x379233=Array[_0x10e148(0x103)](_0x3df9c6[_0x10e148(0x113)])?_0x3df9c6[_0x10e148(0x113)]:JSON[_0x10e148(0x112)](_0x3df9c6[_0x10e148(0x113)]);}catch(_0x29ec82){console[_0x10e148(0xdd)](_0x10e148(0xed),_0x29ec82),_0x379233=[];}if(!_0x379233[_0x10e148(0xb1)](_0x55b01d)){console[_0x10e148(0xc8)]('Webhook\x20event\x20'+_0x55b01d+_0x10e148(0xc0)+_0x142bc8['id']);return;}let _0x5c2c59;if(_0x3e3270[_0x10e148(0x139)])try{_0x5c2c59=JSON[_0x10e148(0x112)](_0x3e3270[_0x10e148(0x139)]);}catch(_0xada4ea){console[_0x10e148(0xdd)](_0x10e148(0x11a),_0xada4ea),_0x5c2c59=undefined;}const _0x311bf9={'event':_0x55b01d,'payment':{'id':_0x3e3270['id'],'order_id':_0x3e3270[_0x10e148(0x10e)],'gateway_order_id':_0x3e3270[_0x10e148(0x138)],'gateway':_0x3e3270[_0x10e148(0xdf)],'amount':_0x3e3270[_0x10e148(0xb3)],'currency':_0x3e3270[_0x10e148(0x133)],'status':_0x1e7ed0['toLowerCase'](),'customer_email':_0x3e3270[_0x10e148(0xef)],'customer_name':_0x3e3270['customerName'],'failure_message':_0x3e3270['failureMessage'],'tx_urls':_0x5c2c59,'created_at':_0x3e3270[_0x10e148(0x118)],'updated_at':new Date()}},_0x3a69e3=await fetch(_0x3df9c6[_0x10e148(0x127)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x10e148(0xe9)},'body':JSON[_0x10e148(0xfb)](_0x311bf9)}),_0x3fafdb=Date['now']()-_0x4a7edb,_0x806309=_0x3a69e3['ok']?_0x10e148(0x11f):await _0x3a69e3[_0x10e148(0x115)]();loggerService_1[_0x10e148(0x110)]['logShopWebhookSent'](_0x3e3270['shopId'],_0x3df9c6[_0x10e148(0x127)],_0x55b01d,_0x3a69e3[_0x10e148(0xb0)],_0x3fafdb,_0x311bf9),console[_0x10e148(0xc8)](_0x10e148(0xb5)+_0x3df9c6[_0x10e148(0x127)]+_0x10e148(0xce)+_0x3a69e3[_0x10e148(0xb0)]+'\x20('+_0x3fafdb+'ms)');}catch(_0x3b9960){console['error'](_0x10e148(0x106),_0x3b9960),loggerService_1[_0x10e148(0x110)]['logShopWebhookError'](_0x3e3270['shopId'],_0x3e3270['shop']?.[_0x10e148(0x13a)]?.['webhookUrl']||_0x10e148(0xdc),_0x10e148(0xc2),_0x3b9960,{});}}async[a52_0x121711(0x107)](_0x52e6d0,_0x134e62){const _0x194e00=a52_0x121711;try{const _0x455fba={'PENDING':_0x194e00(0x10b),'PAID':_0x194e00(0x124),'FAILED':_0x194e00(0xf2),'EXPIRED':_0x194e00(0x114)},_0x17270f=_0x455fba[_0x134e62];if(!_0x17270f||_0x17270f===_0x194e00(0x10b))return;await telegramBotService_1[_0x194e00(0x121)][_0x194e00(0x102)](_0x52e6d0['shopId'],_0x52e6d0,_0x17270f);}catch(_0x28980d){console[_0x194e00(0xdd)](_0x194e00(0x11b),_0x28980d);}}}exports[a52_0x121711(0xcd)]=WebhookService;