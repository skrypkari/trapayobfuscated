'use strict';function a60_0x4a27(_0x3af859,_0x2c2303){const _0x3103cf=a60_0x3103();return a60_0x4a27=function(_0x4a27c2,_0x153598){_0x4a27c2=_0x4a27c2-0x181;let _0x45a716=_0x3103cf[_0x4a27c2];return _0x45a716;},a60_0x4a27(_0x3af859,_0x2c2303);}const a60_0x27aa7a=a60_0x4a27;(function(_0x48a571,_0x21bbbf){const _0x5b8efe=a60_0x4a27,_0x2311f0=_0x48a571();while(!![]){try{const _0x2befa2=parseInt(_0x5b8efe(0x202))/0x1*(parseInt(_0x5b8efe(0x1da))/0x2)+-parseInt(_0x5b8efe(0x1bb))/0x3*(-parseInt(_0x5b8efe(0x206))/0x4)+-parseInt(_0x5b8efe(0x186))/0x5*(parseInt(_0x5b8efe(0x1b8))/0x6)+parseInt(_0x5b8efe(0x26b))/0x7+-parseInt(_0x5b8efe(0x219))/0x8+parseInt(_0x5b8efe(0x22c))/0x9*(-parseInt(_0x5b8efe(0x26d))/0xa)+-parseInt(_0x5b8efe(0x1ce))/0xb*(-parseInt(_0x5b8efe(0x24e))/0xc);if(_0x2befa2===_0x21bbbf)break;else _0x2311f0['push'](_0x2311f0['shift']());}catch(_0x322b44){_0x2311f0['push'](_0x2311f0['shift']());}}}(a60_0x3103,0xa1c4a));function a60_0x3103(){const _0x48930d=['unknown','📊\x20MasterCard\x20webhook\x20result:','\x22,\x20paymentLinkId=\x22','\x20not\x20enabled\x20for\x20shop\x20','../config/database','\x20-\x20','Error\x20processing\x20KLYME\x20webhook:','❌\x20Error\x20processing\x20Amer\x20webhook:','processCoinToPayWebhook','toLowerCase','refund','🔄\x20Processing\x20Amer\x20webhook:','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','No\x20payment\x20ID\x20in\x20MasterCard\x20webhook','FAILED','customerName','rapyd','processNodaWebhook','currency','currencyService','expired','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','updatePaymentStatus','shopId','processWebhook','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','NodaService','CHARGEBACK','paymentLink','\x20not\x20found','📊\x20Noda\x20webhook:\x20Payment\x20','722640VQQcAR','failureMessage','📊\x20Amer\x20webhook:\x20Payment\x20','453elDvWH','klymeService','REFUND','findFirst','TesSoft\x20Payment\x20System/1.0','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','🏪\x20Shop\x20','webhook_status_change_','💰\x20Amount\x20after\x20gateway\x20commission:\x20','stringify','No\x20payment\x20ID\x20in\x20Amer\x20webhook','createdAt','./gateways/rapydService','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','coinToPayService','mastercard','💰\x20Final\x20balance\x20after\x20chargeback:\x20','created','findUnique','11cGeKQE','paymentLinkId','%\x20gateway\x20commission)','📊\x20KLYME\x20webhook:\x20Payment\x20','cointopay','./loggerService','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','💰\x20Adding\x20to\x20balance:\x20','📊\x20CoinToPay\x20webhook:\x20Payment\x20','./gateways/klymeService','\x22,\x20orderId=\x22','WebhookService','43526eoQZMN','entries','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','failed','✅\x20Shop\x20','📈\x20Payment\x20details:\x20oldStatus=\x22','\x20status\x20','processAmerWebhook','📊\x20CoinToPay2\x20webhook:\x20Payment\x20','plisioService','gatewayOrderId','Success','webhook_send','📊\x20Plisio\x20webhook:\x20Payment\x20','Found\x20payment\x20','defineProperty','\x20balance\x20updated:\x20','📈\x20Payment\x20','✅\x20Payment\x20link\x20','type','system','Error\x20processing\x20Noda\x20webhook:','txUrls','masterCardService','now','💰\x20Payment\x20','\x20current\x20balance:\x20','AmerService','paymentMethod','📊\x20Rapyd\x20webhook:\x20Payment\x20','No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook','🔄\x20Processing\x20MasterCard\x20webhook:','sendShopWebhook','PAID','webhookEvents','klyme','❌\x20Available\x20webhook\x20fields:','Gateway\x20','logShopWebhookSent','__esModule','55Dfxcoi','toUpperCase','KlymeService','logWebhookProcessed','26928aoqhoR','Error\x20processing\x20CoinToPay2\x20webhook:','noda','./telegramBotService','cointopay2','update',',\x20gateway\x20','parse','shop','sendPaymentNotification','payment.failed','📤\x20Shop\x20webhook\x20sent\x20to\x20','\x20USDT\x20(chargeback\x20penalty)','username','settings','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','./gateways/plisioService','paymentId','🔄\x20Processing\x20KLYME\x20webhook:','9998920FOAJWa','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','🔄\x20Processing\x20Rapyd\x20webhook:','\x20with\x20status\x20','default','\x20+\x20',',\x20using\x20default\x20commission\x2010%','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','rapydService',',\x20currentPayments=','💰\x20Gateway\x20','🔍\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','__importDefault','webhookLog','payment','remitterName','gatewaySettings','$transaction','45BdKQhS','nodaService','No\x20payment\x20ID\x20in\x20Noda\x20webhook','no\x20balance\x20change','currentPayments','keys','🔍\x20Searched\x20by:\x20gatewayOrderId=\x22','telegramBotService','📊\x20Amer\x20webhook\x20result:','getGatewayCommission','application/json','paidAt','🔄\x20Processing\x20CoinToPay2\x20webhook:','EXPIRED','create','ms)','📈\x20Found\x20payment\x20link\x20','findMany','🔄\x20Processing\x20Noda\x20webhook:','🔍\x20Search\x20result:\x20',',\x20status=','plisio_gateway','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','💰\x20Converting\x20','\x20=\x20','SINGLE','status','payment_method','💰\x20Removing\x20from\x20balance:\x20','\x20commission\x20for\x20shop\x20','toFixed','./gateways/coinToPayService','amer','🔍\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','9906048CMVbjL','❌\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','gateway','balance','chargebackAmount','coinToPay2Service','Payment\x20not\x20found','toISOString','processRapydWebhook','✅\x20Found\x20payment\x20','webhookUrl','amountUSDT','cardLast4','sendPaymentStatusNotification','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','❌\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','remitterIban','\x20in\x20shop\x20','amount','./currencyService','loggerService','processing','./gateways/mastercardService','📝\x20Reason:\x20','amountAfterGatewayCommissionUSDT','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','payment.success','COMPLETED','7619227nZpcyw','logWebhookError','2502950MYubsL','error','log','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','amerService','PlisioService','40EZxFal','POST','🔄\x20Processing\x20Plisio\x20webhook:','convertToUSDT','text','processPlisioWebhook','bankId','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','logShopWebhookError','Error\x20parsing\x20webhook\x20events:','isArray','additionalInfo','\x20and\x20-','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','\x20->\x20','Webhook\x20event\x20','\x20USDT'];a60_0x3103=function(){return _0x48930d;};return a60_0x3103();}var __importDefault=this&&this[a60_0x27aa7a(0x226)]||function(_0x2a2744){const _0x54fc69=a60_0x27aa7a;return _0x2a2744&&_0x2a2744[_0x54fc69(0x201)]?_0x2a2744:{'default':_0x2a2744};};Object[a60_0x27aa7a(0x1e9)](exports,a60_0x27aa7a(0x201),{'value':!![]}),exports[a60_0x27aa7a(0x1d9)]=void 0x0;const database_1=__importDefault(require(a60_0x27aa7a(0x19b))),plisioService_1=require(a60_0x27aa7a(0x216)),rapydService_1=require(a60_0x27aa7a(0x1c7)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a60_0x27aa7a(0x24b)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require(a60_0x27aa7a(0x1d7)),mastercardService_1=require(a60_0x27aa7a(0x265)),amerService_1=require('./gateways/amerService'),telegramBotService_1=require(a60_0x27aa7a(0x209)),currencyService_1=require(a60_0x27aa7a(0x262)),loggerService_1=require(a60_0x27aa7a(0x1d3));class WebhookService{constructor(){const _0x53f798=a60_0x27aa7a;this[_0x53f798(0x1e3)]=new plisioService_1[(_0x53f798(0x185))](),this[_0x53f798(0x221)]=new rapydService_1['RapydService'](),this['nodaService']=new nodaService_1[(_0x53f798(0x1b3))](),this[_0x53f798(0x1c9)]=new coinToPayService_1['CoinToPayService'](),this[_0x53f798(0x254)]=new coinToPay2Service_1['CoinToPay2Service'](),this[_0x53f798(0x1bc)]=new klymeService_1[(_0x53f798(0x204))](),this[_0x53f798(0x1f1)]=new mastercardService_1['MasterCardService'](),this[_0x53f798(0x184)]=new amerService_1[(_0x53f798(0x1f5))]();}async['updatePaymentStatus'](_0x437f69,_0x457c01,_0x2c40c7){const _0x5afc4d=a60_0x27aa7a;console['log']('🔄\x20updatePaymentStatus\x20called:\x20paymentId='+_0x437f69+',\x20newStatus='+_0x457c01),console[_0x5afc4d(0x182)]('🔄\x20Additional\x20data:',_0x2c40c7),await database_1[_0x5afc4d(0x21d)][_0x5afc4d(0x22b)](async _0x568929=>{const _0x88582c=_0x5afc4d,_0x2b2a61=await _0x568929[_0x88582c(0x228)][_0x88582c(0x1cd)]({'where':{'id':_0x437f69},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2b2a61)throw new Error('Payment\x20'+_0x437f69+_0x88582c(0x1b6));const _0x287a8c=_0x2b2a61['status'],_0x37ef98=_0x2b2a61[_0x88582c(0x20e)];console[_0x88582c(0x182)](_0x88582c(0x1f3)+_0x437f69+':\x20'+_0x287a8c+_0x88582c(0x194)+_0x457c01),console['log'](_0x88582c(0x1c1)+_0x37ef98[_0x88582c(0x213)]+_0x88582c(0x1f4)+_0x37ef98[_0x88582c(0x252)]+_0x88582c(0x196));const _0x59dc0e={'status':_0x457c01[_0x88582c(0x203)](),'updatedAt':new Date(),'statusChangedBy':_0x88582c(0x1ee),'statusChangedAt':new Date()};_0x2c40c7?.[_0x88582c(0x1b9)]&&(_0x59dc0e['failureMessage']=_0x2c40c7['failureMessage']);_0x2c40c7?.[_0x88582c(0x1f0)]&&(_0x59dc0e[_0x88582c(0x1f0)]=JSON[_0x88582c(0x1c4)](_0x2c40c7[_0x88582c(0x1f0)]));_0x2c40c7?.['cardLast4']&&(_0x59dc0e[_0x88582c(0x25b)]=_0x2c40c7[_0x88582c(0x25b)]);_0x2c40c7?.['paymentMethod']&&(_0x59dc0e['paymentMethod']=_0x2c40c7['paymentMethod']);_0x2c40c7?.[_0x88582c(0x18c)]&&(_0x59dc0e['bankId']=_0x2c40c7[_0x88582c(0x18c)]);_0x2c40c7?.[_0x88582c(0x25f)]&&(_0x59dc0e['remitterIban']=_0x2c40c7[_0x88582c(0x25f)]);_0x2c40c7?.['remitterName']&&(_0x59dc0e[_0x88582c(0x229)]=_0x2c40c7['remitterName']);let _0x5334f7=_0x37ef98[_0x88582c(0x252)],_0xd7152e='';if(_0x457c01[_0x88582c(0x203)]()===_0x88582c(0x1fb)&&_0x287a8c!==_0x88582c(0x1fb)){const _0x497115=await currencyService_1[_0x88582c(0x1ab)][_0x88582c(0x189)](_0x2b2a61['amount'],_0x2b2a61[_0x88582c(0x1aa)]),_0x58cf2c=await this['getGatewayCommission'](_0x37ef98['id'],_0x2b2a61[_0x88582c(0x251)]),_0x286262=_0x497115*(0x1-_0x58cf2c/0x64);_0x5334f7+=_0x286262,_0xd7152e='+'+_0x286262['toFixed'](0x6)+_0x88582c(0x1a4)+_0x58cf2c+_0x88582c(0x1d0),_0x59dc0e[_0x88582c(0x25a)]=_0x497115,_0x59dc0e['amountAfterGatewayCommissionUSDT']=_0x286262,_0x59dc0e[_0x88582c(0x237)]=new Date(),console[_0x88582c(0x182)](_0x88582c(0x243)+_0x2b2a61[_0x88582c(0x261)]+'\x20'+_0x2b2a61[_0x88582c(0x1aa)]+'\x20->\x20'+_0x497115['toFixed'](0x6)+_0x88582c(0x196)),console[_0x88582c(0x182)](_0x88582c(0x223)+_0x2b2a61[_0x88582c(0x251)]+'\x20commission:\x20'+_0x58cf2c+'%'),console[_0x88582c(0x182)](_0x88582c(0x1c3)+_0x286262['toFixed'](0x6)+_0x88582c(0x196)),console['log'](_0x88582c(0x1d5)+_0x37ef98[_0x88582c(0x252)]+_0x88582c(0x21e)+_0x286262[_0x88582c(0x24a)](0x6)+_0x88582c(0x244)+_0x5334f7[_0x88582c(0x24a)](0x6)+_0x88582c(0x196));}else{if(_0x287a8c===_0x88582c(0x1fb)&&_0x457c01[_0x88582c(0x203)]()!==_0x88582c(0x1fb)){let _0x32ee4d;if(_0x2b2a61[_0x88582c(0x267)])_0x32ee4d=_0x2b2a61[_0x88582c(0x267)];else{if(_0x2b2a61[_0x88582c(0x25a)]){const _0x14e351=await this[_0x88582c(0x235)](_0x37ef98['id'],_0x2b2a61[_0x88582c(0x251)]);_0x32ee4d=_0x2b2a61[_0x88582c(0x25a)]*(0x1-_0x14e351/0x64);}else console['log'](_0x88582c(0x21a)),_0x32ee4d=0x0;}_0x32ee4d>0x0&&(_0x5334f7-=_0x32ee4d,_0xd7152e='-'+_0x32ee4d[_0x88582c(0x24a)](0x6)+_0x88582c(0x1d4),_0x59dc0e['amountUSDT']=null,_0x59dc0e['amountAfterGatewayCommissionUSDT']=null,_0x59dc0e[_0x88582c(0x237)]=null,console[_0x88582c(0x182)](_0x88582c(0x248)+_0x37ef98[_0x88582c(0x252)]+_0x88582c(0x19c)+_0x32ee4d[_0x88582c(0x24a)](0x6)+'\x20=\x20'+_0x5334f7[_0x88582c(0x24a)](0x6)+_0x88582c(0x196)));}}if(_0x457c01[_0x88582c(0x203)]()===_0x88582c(0x1b4)){const _0x4571c6=_0x2c40c7?.[_0x88582c(0x253)]||0x0;_0x4571c6>0x0&&(_0x5334f7-=_0x4571c6,_0xd7152e+=_0x88582c(0x192)+_0x4571c6[_0x88582c(0x24a)](0x6)+_0x88582c(0x212),_0x59dc0e[_0x88582c(0x253)]=_0x4571c6,console['log']('💸\x20Additional\x20chargeback\x20penalty:\x20-'+_0x4571c6[_0x88582c(0x24a)](0x6)+_0x88582c(0x196)),console[_0x88582c(0x182)](_0x88582c(0x1cb)+_0x5334f7[_0x88582c(0x24a)](0x6)+_0x88582c(0x196)));}const _0x7652a6=await _0x568929['payment'][_0x88582c(0x20b)]({'where':{'id':_0x437f69},'data':_0x59dc0e});_0x5334f7!==_0x37ef98[_0x88582c(0x252)]&&(await _0x568929[_0x88582c(0x20e)]['update']({'where':{'id':_0x37ef98['id']},'data':{'balance':_0x5334f7}}),console[_0x88582c(0x182)](_0x88582c(0x1de)+_0x37ef98['username']+_0x88582c(0x1ea)+_0x37ef98[_0x88582c(0x252)][_0x88582c(0x24a)](0x6)+_0x88582c(0x194)+_0x5334f7['toFixed'](0x6)+_0x88582c(0x196)),console[_0x88582c(0x182)](_0x88582c(0x266)+_0xd7152e));await _0x568929[_0x88582c(0x227)][_0x88582c(0x23a)]({'data':{'paymentId':_0x437f69,'shopId':_0x37ef98['id'],'event':_0x88582c(0x1c2)+_0x457c01['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x287a8c,'newStatus':_0x457c01[_0x88582c(0x203)](),'balanceChange':_0xd7152e||_0x88582c(0x22f),'oldBalance':_0x37ef98[_0x88582c(0x252)],'newBalance':_0x5334f7,'amountUSDT':_0x59dc0e[_0x88582c(0x25a)],'additionalData':_0x2c40c7,'timestamp':new Date()[_0x88582c(0x256)]()})}}),await this[_0x88582c(0x1fa)]({..._0x2b2a61,..._0x7652a6,'shop':_0x37ef98},_0x457c01['toUpperCase']()),await this['sendPaymentStatusNotification']({..._0x2b2a61,..._0x7652a6},_0x457c01['toUpperCase']());if(_0x287a8c!==_0x88582c(0x1fb)&&_0x457c01[_0x88582c(0x203)]()===_0x88582c(0x1fb)){console[_0x88582c(0x182)](_0x88582c(0x1eb)+_0x437f69+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console[_0x88582c(0x182)](_0x88582c(0x1df)+_0x287a8c+'\x22,\x20newStatus=\x22'+_0x457c01['toUpperCase']()+_0x88582c(0x199)+_0x2b2a61[_0x88582c(0x1cf)]+'\x22');if(_0x2b2a61[_0x88582c(0x1cf)])try{const _0x387603=await _0x568929[_0x88582c(0x1b5)][_0x88582c(0x1cd)]({'where':{'id':_0x2b2a61['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x387603){console['log'](_0x88582c(0x23c)+_0x387603['id']+':\x20type='+_0x387603[_0x88582c(0x1ed)]+_0x88582c(0x222)+_0x387603[_0x88582c(0x230)]+',\x20status='+_0x387603[_0x88582c(0x246)]);const _0x237cf4=_0x387603[_0x88582c(0x230)]+0x1,_0x51bc29=_0x387603['type']===_0x88582c(0x245)?_0x88582c(0x26a):_0x387603[_0x88582c(0x246)];await _0x568929[_0x88582c(0x1b5)][_0x88582c(0x20b)]({'where':{'id':_0x2b2a61[_0x88582c(0x1cf)]},'data':{'currentPayments':_0x237cf4,'status':_0x51bc29,'updatedAt':new Date()}}),console[_0x88582c(0x182)](_0x88582c(0x1ec)+_0x387603['id']+'\x20updated:\x20currentPayments='+_0x387603[_0x88582c(0x230)]+'\x20->\x20'+_0x237cf4+_0x88582c(0x240)+_0x387603['status']+_0x88582c(0x194)+_0x51bc29);}else console[_0x88582c(0x182)]('❌\x20Payment\x20link\x20'+_0x2b2a61[_0x88582c(0x1cf)]+_0x88582c(0x1b6));}catch(_0x5497e1){console[_0x88582c(0x181)](_0x88582c(0x25d),_0x5497e1);}else console[_0x88582c(0x182)](_0x88582c(0x1eb)+_0x437f69+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0x88582c(0x182)](_0x88582c(0x1eb)+_0x437f69+'\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20'+_0x287a8c+'\x20->\x20'+_0x457c01[_0x88582c(0x203)]());});}async[a60_0x27aa7a(0x18b)](_0x372e9f){const _0x1c1e0a=a60_0x27aa7a;console[_0x1c1e0a(0x182)](_0x1c1e0a(0x188),_0x372e9f);try{const _0x5b8943=await this[_0x1c1e0a(0x1e3)][_0x1c1e0a(0x1b1)](_0x372e9f);if(!_0x5b8943[_0x1c1e0a(0x217)])throw new Error(_0x1c1e0a(0x1b2));const _0x24e0d1=await database_1['default'][_0x1c1e0a(0x228)][_0x1c1e0a(0x1be)]({'where':{'gatewayOrderId':_0x5b8943[_0x1c1e0a(0x217)]}});if(!_0x24e0d1){console['error']('Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20'+_0x5b8943[_0x1c1e0a(0x217)]);return;}console[_0x1c1e0a(0x182)](_0x1c1e0a(0x1e7)+_0x24e0d1['id']+'\x20status\x20'+_0x5b8943['status']),await this[_0x1c1e0a(0x1af)](_0x24e0d1['id'],_0x5b8943[_0x1c1e0a(0x246)],{'txUrls':_0x5b8943['txUrls']}),loggerService_1[_0x1c1e0a(0x263)][_0x1c1e0a(0x205)]('plisio',_0x24e0d1['id'],_0x24e0d1[_0x1c1e0a(0x246)],_0x5b8943[_0x1c1e0a(0x246)],_0x372e9f);}catch(_0x5a6ff8){console[_0x1c1e0a(0x181)]('Error\x20processing\x20Plisio\x20webhook:',_0x5a6ff8),loggerService_1['loggerService'][_0x1c1e0a(0x26c)]('plisio',_0x5a6ff8,_0x372e9f);throw _0x5a6ff8;}}async['processPlisioGatewayWebhook'](_0x386126){const _0xd66598=a60_0x27aa7a;console['log'](_0xd66598(0x215),_0x386126);try{const _0x593bfc=await this['plisioService'][_0xd66598(0x1b1)](_0x386126);if(!_0x593bfc['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook');const _0x46d0b3=await database_1[_0xd66598(0x21d)][_0xd66598(0x228)][_0xd66598(0x1be)]({'where':{'gatewayOrderId':_0x593bfc[_0xd66598(0x217)]}});if(!_0x46d0b3){console[_0xd66598(0x181)](_0xd66598(0x1c0)+_0x593bfc[_0xd66598(0x217)]);return;}console[_0xd66598(0x182)](_0xd66598(0x1a3)+_0x46d0b3['id']+_0xd66598(0x1e0)+_0x593bfc['status']),await this[_0xd66598(0x1af)](_0x46d0b3['id'],_0x593bfc[_0xd66598(0x246)],{'txUrls':_0x593bfc['txUrls']}),loggerService_1[_0xd66598(0x263)][_0xd66598(0x205)](_0xd66598(0x241),_0x46d0b3['id'],_0x46d0b3[_0xd66598(0x246)],_0x593bfc[_0xd66598(0x246)],_0x386126);}catch(_0x16f2ba){console[_0xd66598(0x181)](_0xd66598(0x1dc),_0x16f2ba),loggerService_1[_0xd66598(0x263)][_0xd66598(0x26c)](_0xd66598(0x241),_0x16f2ba,_0x386126);throw _0x16f2ba;}}async[a60_0x27aa7a(0x257)](_0x13032e){const _0x36a921=a60_0x27aa7a;console[_0x36a921(0x182)](_0x36a921(0x21b),_0x13032e);try{const _0x39b80d=await this[_0x36a921(0x221)][_0x36a921(0x1b1)](_0x13032e);if(!_0x39b80d[_0x36a921(0x217)])throw new Error('No\x20payment\x20ID\x20in\x20Rapyd\x20webhook');const _0x15627b=await database_1[_0x36a921(0x21d)][_0x36a921(0x228)][_0x36a921(0x1be)]({'where':{'gatewayOrderId':_0x39b80d['paymentId']}});if(!_0x15627b){console['error'](_0x36a921(0x1ad)+_0x39b80d[_0x36a921(0x217)]);return;}console['log'](_0x36a921(0x1f7)+_0x15627b['id']+_0x36a921(0x1e0)+_0x39b80d[_0x36a921(0x246)]),await this[_0x36a921(0x1af)](_0x15627b['id'],_0x39b80d[_0x36a921(0x246)],{'failureMessage':_0x39b80d[_0x36a921(0x1b9)],'cardLast4':_0x39b80d[_0x36a921(0x191)]?.[_0x36a921(0x25b)],'paymentMethod':_0x39b80d[_0x36a921(0x191)]?.[_0x36a921(0x1f6)]}),loggerService_1['loggerService']['logWebhookProcessed']('rapyd',_0x15627b['id'],_0x15627b['status'],_0x39b80d[_0x36a921(0x246)],_0x13032e);}catch(_0x306d3c){console[_0x36a921(0x181)]('Error\x20processing\x20Rapyd\x20webhook:',_0x306d3c),loggerService_1[_0x36a921(0x263)][_0x36a921(0x26c)](_0x36a921(0x1a8),_0x306d3c,_0x13032e);throw _0x306d3c;}}async[a60_0x27aa7a(0x1a9)](_0x27b673){const _0x128b16=a60_0x27aa7a;console[_0x128b16(0x182)](_0x128b16(0x23e),_0x27b673);try{const _0x5bcd19=await this[_0x128b16(0x22d)][_0x128b16(0x1b1)](_0x27b673);if(!_0x5bcd19['paymentId'])throw new Error(_0x128b16(0x22e));const _0x3c8b8a=await database_1['default'][_0x128b16(0x228)][_0x128b16(0x1be)]({'where':{'gatewayOrderId':_0x5bcd19[_0x128b16(0x217)]}});if(!_0x3c8b8a){console[_0x128b16(0x181)](_0x128b16(0x242)+_0x5bcd19[_0x128b16(0x217)]);return;}console[_0x128b16(0x182)](_0x128b16(0x1b7)+_0x3c8b8a['id']+'\x20status\x20'+_0x5bcd19[_0x128b16(0x246)]),await this['updatePaymentStatus'](_0x3c8b8a['id'],_0x5bcd19[_0x128b16(0x246)],{'bankId':_0x5bcd19[_0x128b16(0x191)]?.[_0x128b16(0x18c)],'remitterIban':_0x5bcd19[_0x128b16(0x191)]?.[_0x128b16(0x25f)],'remitterName':_0x5bcd19['additionalInfo']?.['remitterName']}),loggerService_1[_0x128b16(0x263)][_0x128b16(0x205)](_0x128b16(0x208),_0x3c8b8a['id'],_0x3c8b8a[_0x128b16(0x246)],_0x5bcd19[_0x128b16(0x246)],_0x27b673);}catch(_0x33b3eb){console[_0x128b16(0x181)](_0x128b16(0x1ef),_0x33b3eb),loggerService_1[_0x128b16(0x263)][_0x128b16(0x26c)](_0x128b16(0x208),_0x33b3eb,_0x27b673);throw _0x33b3eb;}}async[a60_0x27aa7a(0x19f)](_0x445828){const _0xb51c67=a60_0x27aa7a;console[_0xb51c67(0x182)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x445828);try{const _0x3f17b7=await this['coinToPayService'][_0xb51c67(0x1b1)](_0x445828);if(!_0x3f17b7['paymentId'])throw new Error(_0xb51c67(0x18d));const _0x492b68=await database_1['default'][_0xb51c67(0x228)][_0xb51c67(0x1be)]({'where':{'gatewayOrderId':_0x3f17b7[_0xb51c67(0x217)]}});if(!_0x492b68){console[_0xb51c67(0x181)](_0xb51c67(0x183)+_0x3f17b7['paymentId']);return;}console[_0xb51c67(0x182)](_0xb51c67(0x1d6)+_0x492b68['id']+_0xb51c67(0x1e0)+_0x3f17b7[_0xb51c67(0x246)]),await this[_0xb51c67(0x1af)](_0x492b68['id'],_0x3f17b7[_0xb51c67(0x246)]),loggerService_1['loggerService'][_0xb51c67(0x205)](_0xb51c67(0x1d2),_0x492b68['id'],_0x492b68['status'],_0x3f17b7['status'],_0x445828);}catch(_0x21e105){console[_0xb51c67(0x181)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x21e105),loggerService_1[_0xb51c67(0x263)][_0xb51c67(0x26c)]('cointopay',_0x21e105,_0x445828);throw _0x21e105;}}async['processCoinToPay2Webhook'](_0x537306){const _0x1c2e49=a60_0x27aa7a;console[_0x1c2e49(0x182)](_0x1c2e49(0x238),_0x537306);try{const _0x155609=await this[_0x1c2e49(0x254)][_0x1c2e49(0x1b1)](_0x537306);if(!_0x155609['paymentId'])throw new Error(_0x1c2e49(0x1f8));const _0x4f3380=await database_1['default']['payment'][_0x1c2e49(0x1be)]({'where':{'gatewayOrderId':_0x155609[_0x1c2e49(0x217)]}});if(!_0x4f3380){console['error']('Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20'+_0x155609[_0x1c2e49(0x217)]);return;}console[_0x1c2e49(0x182)](_0x1c2e49(0x1e2)+_0x4f3380['id']+'\x20status\x20'+_0x155609[_0x1c2e49(0x246)]),await this[_0x1c2e49(0x1af)](_0x4f3380['id'],_0x155609['status']),loggerService_1[_0x1c2e49(0x263)]['logWebhookProcessed']('cointopay2',_0x4f3380['id'],_0x4f3380[_0x1c2e49(0x246)],_0x155609[_0x1c2e49(0x246)],_0x537306);}catch(_0x17cd9a){console[_0x1c2e49(0x181)](_0x1c2e49(0x207),_0x17cd9a),loggerService_1['loggerService'][_0x1c2e49(0x26c)](_0x1c2e49(0x20a),_0x17cd9a,_0x537306);throw _0x17cd9a;}}async['processKlymeWebhook'](_0x211a78){const _0x147938=a60_0x27aa7a;console[_0x147938(0x182)](_0x147938(0x218),_0x211a78);try{const _0x4c5f67=await this[_0x147938(0x1bc)][_0x147938(0x1b1)](_0x211a78);if(!_0x4c5f67['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20KLYME\x20webhook');const _0x55a412=await database_1['default'][_0x147938(0x228)][_0x147938(0x1be)]({'where':{'gatewayOrderId':_0x4c5f67[_0x147938(0x217)]}});if(!_0x55a412){console[_0x147938(0x181)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x4c5f67['paymentId']);return;}console[_0x147938(0x182)](_0x147938(0x1d1)+_0x55a412['id']+_0x147938(0x1e0)+_0x4c5f67[_0x147938(0x246)]),await this['updatePaymentStatus'](_0x55a412['id'],_0x4c5f67[_0x147938(0x246)],{'paymentMethod':_0x4c5f67[_0x147938(0x191)]?.[_0x147938(0x247)]}),loggerService_1['loggerService'][_0x147938(0x205)](_0x147938(0x1fd),_0x55a412['id'],_0x55a412[_0x147938(0x246)],_0x4c5f67['status'],_0x211a78);}catch(_0x2574dc){console[_0x147938(0x181)](_0x147938(0x19d),_0x2574dc),loggerService_1['loggerService'][_0x147938(0x26c)](_0x147938(0x1fd),_0x2574dc,_0x211a78);throw _0x2574dc;}}async['processMasterCardWebhook'](_0x37fa59){const _0x1adb17=a60_0x27aa7a;console[_0x1adb17(0x182)](_0x1adb17(0x1f9),JSON[_0x1adb17(0x1c4)](_0x37fa59,null,0x2));try{const _0x176995=await this[_0x1adb17(0x1f1)]['processWebhook'](_0x37fa59);console['log'](_0x1adb17(0x198),_0x176995);if(!_0x176995[_0x1adb17(0x217)]){console[_0x1adb17(0x181)](_0x1adb17(0x25e)),console[_0x1adb17(0x181)]('❌\x20Available\x20webhook\x20fields:',Object[_0x1adb17(0x231)](_0x37fa59));throw new Error(_0x1adb17(0x1a5));}let _0x4591b2=null;console['log'](_0x1adb17(0x24d)+_0x176995[_0x1adb17(0x217)]);_0x176995[_0x1adb17(0x217)]&&(console[_0x1adb17(0x182)]('🔍\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x4591b2=await database_1[_0x1adb17(0x21d)][_0x1adb17(0x228)][_0x1adb17(0x1be)]({'where':{'AND':[{'gateway':'mastercard'},{'OR':[{'gatewayPaymentId':_0x176995[_0x1adb17(0x217)]},{'gatewayOrderId':_0x176995['paymentId']},{'id':_0x176995[_0x1adb17(0x217)]},{'orderId':_0x176995[_0x1adb17(0x217)]}]}]}}),console[_0x1adb17(0x182)](_0x1adb17(0x23f)+(_0x4591b2?'Found\x20payment\x20'+_0x4591b2['id']:_0x1adb17(0x255))));if(!_0x4591b2){console[_0x1adb17(0x181)]('❌\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20'+_0x176995[_0x1adb17(0x217)]),console[_0x1adb17(0x181)](_0x1adb17(0x232)+_0x176995[_0x1adb17(0x217)]+'\x22,\x20id=\x22'+_0x176995['paymentId']+_0x1adb17(0x1d8)+_0x176995[_0x1adb17(0x217)]+'\x22');const _0x1b2268=await database_1[_0x1adb17(0x21d)][_0x1adb17(0x228)][_0x1adb17(0x23d)]({'where':{'gateway':'mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console['log']('🔍\x20Available\x20MasterCard\x20payments\x20for\x20debugging:',_0x1b2268);return;}console[_0x1adb17(0x182)](_0x1adb17(0x258)+_0x4591b2['id']+_0x1adb17(0x193)+_0x4591b2[_0x1adb17(0x246)]+'\x20to\x20'+_0x176995[_0x1adb17(0x246)]),await this[_0x1adb17(0x1af)](_0x4591b2['id'],_0x176995[_0x1adb17(0x246)]),loggerService_1[_0x1adb17(0x263)][_0x1adb17(0x205)](_0x1adb17(0x1ca),_0x4591b2['id'],_0x4591b2['status'],_0x176995['status'],_0x37fa59);}catch(_0x29c96e){console[_0x1adb17(0x181)]('❌\x20Error\x20processing\x20MasterCard\x20webhook:',_0x29c96e),loggerService_1[_0x1adb17(0x263)]['logWebhookError'](_0x1adb17(0x1ca),_0x29c96e,_0x37fa59);throw _0x29c96e;}}async[a60_0x27aa7a(0x1e1)](_0x41f912){const _0x1dc230=a60_0x27aa7a;console['log'](_0x1dc230(0x1a2),JSON[_0x1dc230(0x1c4)](_0x41f912,null,0x2));try{const _0x5cfb3c=await this[_0x1dc230(0x184)]['processWebhook'](_0x41f912);console[_0x1dc230(0x182)](_0x1dc230(0x234),_0x5cfb3c);if(!_0x5cfb3c[_0x1dc230(0x217)]){console['error'](_0x1dc230(0x220)),console[_0x1dc230(0x181)](_0x1dc230(0x1fe),Object[_0x1dc230(0x231)](_0x41f912));throw new Error(_0x1dc230(0x1c5));}let _0xd3b839=null;console[_0x1dc230(0x182)](_0x1dc230(0x224)+_0x5cfb3c[_0x1dc230(0x217)]),_0xd3b839=await database_1['default']['payment'][_0x1dc230(0x1be)]({'where':{'AND':[{'gateway':'amer'},{'OR':[{'gatewayPaymentId':_0x5cfb3c[_0x1dc230(0x217)]},{'gatewayOrderId':_0x5cfb3c[_0x1dc230(0x217)]},{'id':_0x5cfb3c[_0x1dc230(0x217)]},{'orderId':_0x5cfb3c[_0x1dc230(0x217)]}]}]}}),console['log'](_0x1dc230(0x23f)+(_0xd3b839?_0x1dc230(0x1e8)+_0xd3b839['id']:'Payment\x20not\x20found'));if(!_0xd3b839){console[_0x1dc230(0x181)](_0x1dc230(0x24f)+_0x5cfb3c[_0x1dc230(0x217)]);return;}console['log'](_0x1dc230(0x1ba)+_0xd3b839['id']+_0x1dc230(0x1e0)+_0x5cfb3c['status']),await this[_0x1dc230(0x1af)](_0xd3b839['id'],_0x5cfb3c[_0x1dc230(0x246)],{'cardLast4':_0x5cfb3c[_0x1dc230(0x191)]?.[_0x1dc230(0x25b)],'paymentMethod':_0x5cfb3c[_0x1dc230(0x191)]?.['paymentMethod']});}catch(_0x3c089b){console['error'](_0x1dc230(0x19e),_0x3c089b),loggerService_1[_0x1dc230(0x263)][_0x1dc230(0x26c)](_0x1dc230(0x24c),_0x3c089b,_0x41f912);throw _0x3c089b;}}async[a60_0x27aa7a(0x1fa)](_0x174aaa,_0x23b4f6){const _0x302626=a60_0x27aa7a,_0x36c454=Date[_0x302626(0x1f2)]();try{const _0x23d52d=_0x174aaa[_0x302626(0x20e)],_0x5c0aad=_0x23d52d['settings'];if(!_0x5c0aad?.[_0x302626(0x259)]){console[_0x302626(0x182)](_0x302626(0x225)+_0x23d52d['id']);return;}const _0x25e545=_0x23b4f6===_0x302626(0x1fb)?_0x302626(0x269):_0x23b4f6===_0x302626(0x1a6)?_0x302626(0x210):_0x23b4f6===_0x302626(0x239)?'payment.failed':_0x23b4f6==='CHARGEBACK'?_0x302626(0x210):_0x23b4f6===_0x302626(0x1bd)?_0x302626(0x210):'payment.pending';let _0xdd9937=[];if(_0x5c0aad['webhookEvents'])try{_0xdd9937=Array[_0x302626(0x190)](_0x5c0aad['webhookEvents'])?_0x5c0aad[_0x302626(0x1fc)]:JSON[_0x302626(0x20d)](_0x5c0aad[_0x302626(0x1fc)]);}catch(_0x3b2a11){console['error'](_0x302626(0x18f),_0x3b2a11),_0xdd9937=[];}if(!_0xdd9937['includes'](_0x25e545)){console['log'](_0x302626(0x195)+_0x25e545+_0x302626(0x19a)+_0x23d52d['id']);return;}const _0x1da5cf={'event':_0x25e545,'payment':{'id':_0x174aaa['id'],'order_id':_0x174aaa['orderId'],'gateway_order_id':_0x174aaa[_0x302626(0x1e4)],'gateway':_0x174aaa['gateway'],'amount':_0x174aaa[_0x302626(0x261)],'currency':_0x174aaa[_0x302626(0x1aa)],'status':_0x23b4f6[_0x302626(0x1a0)](),'customer_email':_0x174aaa['customerEmail'],'customer_name':_0x174aaa[_0x302626(0x1a7)],'failure_message':_0x174aaa[_0x302626(0x1b9)],'tx_urls':_0x174aaa[_0x302626(0x1f0)]?JSON[_0x302626(0x20d)](_0x174aaa[_0x302626(0x1f0)]):null,'created_at':_0x174aaa[_0x302626(0x1c6)],'updated_at':_0x174aaa['updatedAt']}},_0x2121fe=await fetch(_0x5c0aad[_0x302626(0x259)],{'method':_0x302626(0x187),'headers':{'Content-Type':_0x302626(0x236),'User-Agent':_0x302626(0x1bf)},'body':JSON[_0x302626(0x1c4)](_0x1da5cf)}),_0x18cb67=Date[_0x302626(0x1f2)]()-_0x36c454,_0x524874=_0x2121fe['ok']?_0x302626(0x1e5):await _0x2121fe[_0x302626(0x18a)]();loggerService_1['loggerService'][_0x302626(0x200)](_0x174aaa[_0x302626(0x1b0)],_0x5c0aad[_0x302626(0x259)],_0x25e545,_0x2121fe[_0x302626(0x246)],_0x18cb67,_0x1da5cf),console[_0x302626(0x182)](_0x302626(0x211)+_0x5c0aad[_0x302626(0x259)]+_0x302626(0x21c)+_0x2121fe[_0x302626(0x246)]+'\x20('+_0x18cb67+_0x302626(0x23b));}catch(_0x5c72a7){console[_0x302626(0x181)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x5c72a7),loggerService_1['loggerService'][_0x302626(0x18e)](_0x174aaa[_0x302626(0x1b0)],_0x174aaa['shop']?.[_0x302626(0x214)]?.[_0x302626(0x259)]||_0x302626(0x197),_0x302626(0x1e6),_0x5c72a7,{});}}async[a60_0x27aa7a(0x25c)](_0x6e0e15,_0x2fc8bb){const _0xd16e1=a60_0x27aa7a;try{const _0x1c07e7={'PENDING':'created','PROCESSING':_0xd16e1(0x264),'PAID':'paid','FAILED':_0xd16e1(0x1dd),'EXPIRED':_0xd16e1(0x1ac),'REFUND':_0xd16e1(0x1a1),'CHARGEBACK':'chargeback'},_0x63c7ad=_0x1c07e7[_0x2fc8bb];if(!_0x63c7ad||_0x63c7ad===_0xd16e1(0x1cc))return;await telegramBotService_1[_0xd16e1(0x233)][_0xd16e1(0x20f)](_0x6e0e15[_0xd16e1(0x1b0)],_0x6e0e15,_0x63c7ad);}catch(_0x3c2eda){console['error'](_0xd16e1(0x1ae),_0x3c2eda);}}async['getGatewayCommission'](_0x265691,_0x419c02){const _0x5a8794=a60_0x27aa7a;try{const _0x3d92c6=await database_1[_0x5a8794(0x21d)]['shop'][_0x5a8794(0x1cd)]({'where':{'id':_0x265691},'select':{'gatewaySettings':!![]}});if(!_0x3d92c6?.[_0x5a8794(0x22a)])return console[_0x5a8794(0x182)](_0x5a8794(0x1c8)+_0x265691+_0x5a8794(0x21f)),0xa;const _0x2c25d9=JSON[_0x5a8794(0x20d)](_0x3d92c6[_0x5a8794(0x22a)]);for(const [_0x3e6a61,_0x57a0a9]of Object[_0x5a8794(0x1db)](_0x2c25d9)){if(_0x3e6a61[_0x5a8794(0x1a0)]()===_0x419c02[_0x5a8794(0x1a0)]()){const _0x3c1d24=_0x57a0a9['commission']||0xa;return console[_0x5a8794(0x182)](_0x5a8794(0x1ff)+_0x419c02+_0x5a8794(0x249)+_0x265691+':\x20'+_0x3c1d24+'%'),_0x3c1d24;}}return console['log'](_0x5a8794(0x268)+_0x419c02+_0x5a8794(0x260)+_0x265691+',\x20using\x20default\x2010%'),0xa;}catch(_0x21d5e7){return console['error'](_0x5a8794(0x250)+_0x265691+_0x5a8794(0x20c)+_0x419c02+':',_0x21d5e7),0xa;}}}exports[a60_0x27aa7a(0x1d9)]=WebhookService;