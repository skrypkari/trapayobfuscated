'use strict';const a60_0x3f0979=a60_0x3019;function a60_0x3019(_0x187d6e,_0x114fa1){const _0x256a82=a60_0x256a();return a60_0x3019=function(_0x301960,_0x4e3d3e){_0x301960=_0x301960-0xf6;let _0x3810e0=_0x256a82[_0x301960];return _0x3810e0;},a60_0x3019(_0x187d6e,_0x114fa1);}(function(_0x4dde97,_0x26e8f5){const _0x43fcd7=a60_0x3019,_0x4ae3be=_0x4dde97();while(!![]){try{const _0x4c14f8=parseInt(_0x43fcd7(0x15e))/0x1*(-parseInt(_0x43fcd7(0x1c2))/0x2)+parseInt(_0x43fcd7(0x177))/0x3*(-parseInt(_0x43fcd7(0x1ac))/0x4)+parseInt(_0x43fcd7(0x198))/0x5+-parseInt(_0x43fcd7(0x1d0))/0x6+-parseInt(_0x43fcd7(0x1b2))/0x7+-parseInt(_0x43fcd7(0xff))/0x8*(-parseInt(_0x43fcd7(0x169))/0x9)+parseInt(_0x43fcd7(0x10c))/0xa*(parseInt(_0x43fcd7(0x100))/0xb);if(_0x4c14f8===_0x26e8f5)break;else _0x4ae3be['push'](_0x4ae3be['shift']());}catch(_0x2b827e){_0x4ae3be['push'](_0x4ae3be['shift']());}}}(a60_0x256a,0xf2b78));function a60_0x256a(){const _0x5d35fb=['webhookLog','webhook_send','shop','unknown','\x20commission\x20for\x20shop\x20','173000OCpyEj','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20Amer\x20webhook\x20data','PAID','üí∞\x20Gateway\x20','\x20in\x20shop\x20','cointopay','bankId','amount','txUrls','\x20->\x20','type','üìä\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','\x20to\x20','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','customerName','RapydService','ms)','üìä\x20KLYME\x20webhook:\x20Payment\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','Failed\x20to\x20send\x20shop\x20webhook:','‚ùå\x20Payment\x20not\x20found\x20for\x20MasterCard\x20webhook\x20with\x20ID:\x20','coinToPay2Service','sendShopWebhook','Error\x20processing\x20KLYME\x20webhook:','paymentLinkId','webhookEvents','\x20updated:\x20currentPayments=','amountUSDT','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','‚ùå\x20Error\x20processing\x20Amer\x20webhook:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','system','üì§\x20Shop\x20webhook\x20sent\x20to\x20','üîÑ\x20Processing\x20Rapyd\x20webhook:','logWebhookProcessed','expired',',\x20using\x20default\x2010%','$transaction','Error\x20processing\x20Plisio\x20webhook:','\x20+\x20','log','\x20balance\x20updated:\x20','TesSoft\x20Payment\x20System/1.0','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','üìà\x20Payment\x20','currency','\x20status\x20','paymentId','‚ùå\x20No\x20payment\x20ID\x20extracted\x20from\x20MasterCard\x20webhook\x20data','gateway','settings','create','status','payment.success','./currencyService','Found\x20payment\x20','üí∞\x20Removing\x20from\x20balance:\x20','mastercard','customerEmail','gatewayOrderId','currentPayments','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','./gateways/coinToPayService','Webhook\x20event\x20','payment.pending','amer','default','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20not\x20enabled\x20for\x20shop\x20','gatewaySettings','SINGLE','createdAt','‚ùå\x20Payment\x20not\x20found\x20for\x20Amer\x20webhook\x20with\x20ID:\x20','processKlymeWebhook','commission','updatedAt','remitterIban',':\x20type=','rapyd','./loggerService','plisioService','32408OvCrOR','üí∏\x20Additional\x20chargeback\x20penalty:\x20-','created','rapydService','username','FAILED','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','toUpperCase','remitterName','\x22,\x20orderId=\x22','payment.failed','63EYWNgz','Gateway\x20','Error\x20processing\x20Noda\x20webhook:','üìà\x20Payment\x20details:\x20oldStatus=\x22','nodaService','refund','payment','\x20-\x20','‚ùå\x20Available\x20webhook\x20fields:','KlymeService','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','AmerService','./gateways/mastercardService','keys','757959SCULaI','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter:','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','chargebackAmount','__esModule','üìä\x20Amer\x20webhook\x20result:','paymentMethod','processCoinToPay2Webhook','chargeback','üìä\x20MasterCard\x20webhook\x20result:','failureMessage','Error\x20processing\x20CoinToPay\x20webhook:','\x22,\x20id=\x22','üîç\x20Available\x20MasterCard\x20payments\x20for\x20debugging:','findFirst','payment_method','üîç\x20MasterCard\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','plisio','noda','üìù\x20Reason:\x20','COMPLETED','processNodaWebhook','üîç\x20Amer\x20webhook:\x20Searching\x20for\x20payment\x20with\x20ID:\x20','WebhookService','./gateways/rapydService','Payment\x20not\x20found\x20for\x20CoinToPay2\x20webhook:\x20','plisio_gateway','CHARGEBACK','\x20current\x20balance:\x20','toLowerCase','‚ùå\x20Payment\x20link\x20','POST','üìä\x20Noda\x20webhook:\x20Payment\x20','4703565SZKBuw','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','cardLast4','üìà\x20Found\x20payment\x20link\x20','‚ùå\x20Error\x20processing\x20MasterCard\x20webhook:','üîç\x20Search\x20result:\x20','üîÑ\x20Processing\x20CoinToPay2\x20webhook:','application/json','webhookUrl','\x20status\x20change\x20does\x20not\x20trigger\x20payment\x20link\x20counter\x20update:\x20','toFixed','currencyService','processRapydWebhook','paymentLink','telegramBotService','Payment\x20','üìä\x20Amer\x20webhook:\x20Payment\x20','üîÑ\x20Processing\x20MasterCard\x20webhook:','__importDefault','findUnique','20MtbtXT','üîÑ\x20Processing\x20CoinToPay\x20webhook:',',\x20gateway\x20','PlisioService','getGatewayCommission','defineProperty','10382988HKgjqn','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','now','Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20','MasterCardService','coinToPayService','logShopWebhookError','\x22,\x20paymentLinkId=\x22','sendPaymentNotification','masterCardService','balance','Error\x20processing\x20CoinToPay2\x20webhook:','klyme','./gateways/nodaService','\x20for\x20MasterCard\x20webhook,\x20updating\x20status\x20from\x20','processWebhook','8DOXlxe','\x20=\x20','error','üìä\x20CoinToPay\x20webhook:\x20Payment\x20','stringify','logWebhookError','üîç\x20Searched\x20by:\x20gatewayOrderId=\x22','orderId','shopId','\x20and\x20-','üîÑ\x20Additional\x20data:','processAmerWebhook','processMasterCardWebhook','additionalInfo','2812770kcGYhD','No\x20amountUSDT\x20found\x20for\x20payment,\x20nothing\x20to\x20remove\x20from\x20balance','CoinToPayService','processPlisioGatewayWebhook','‚úÖ\x20Found\x20payment\x20','üîÑ\x20Processing\x20Plisio\x20Gateway\x20webhook:','paidAt','üîÑ\x20Processing\x20Amer\x20webhook:','üìä\x20Rapyd\x20webhook:\x20Payment\x20','üîÑ\x20Processing\x20KLYME\x20webhook:',',\x20status=','update','./gateways/klymeService','sendPaymentStatusNotification','amountAfterGatewayCommissionUSDT','\x20USDT','loggerService','amerService',',\x20currentPayments=','NodaService','CoinToPay2Service','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','toISOString','entries','klymeService','üí∞\x20Adding\x20to\x20balance:\x20','\x20USDT\x20(chargeback\x20penalty)','\x20not\x20found','No\x20payment\x20ID\x20in\x20Noda\x20webhook','2262664DEjXtn','902dPBTis',',\x20newStatus=','\x20USDT\x20(payment\x20became\x20PAID,\x20after\x20','updatePaymentStatus','parse','text','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook'];a60_0x256a=function(){return _0x5d35fb;};return a60_0x256a();}var __importDefault=this&&this[a60_0x3f0979(0x1aa)]||function(_0x3f5060){return _0x3f5060&&_0x3f5060['__esModule']?_0x3f5060:{'default':_0x3f5060};};Object[a60_0x3f0979(0x1b1)](exports,a60_0x3f0979(0x17b),{'value':!![]}),exports[a60_0x3f0979(0x18e)]=void 0x0;const database_1=__importDefault(require('../config/database')),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a60_0x3f0979(0x18f)),nodaService_1=require(a60_0x3f0979(0x1bf)),coinToPayService_1=require(a60_0x3f0979(0x14b)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),klymeService_1=require(a60_0x3f0979(0x1dc)),mastercardService_1=require(a60_0x3f0979(0x175)),amerService_1=require('./gateways/amerService'),telegramBotService_1=require('./telegramBotService'),currencyService_1=require(a60_0x3f0979(0x143)),loggerService_1=require(a60_0x3f0979(0x15c));class WebhookService{constructor(){const _0xdf1ee8=a60_0x3f0979;this['plisioService']=new plisioService_1[(_0xdf1ee8(0x1af))](),this[_0xdf1ee8(0x161)]=new rapydService_1[(_0xdf1ee8(0x11b))](),this[_0xdf1ee8(0x16d)]=new nodaService_1[(_0xdf1ee8(0x1e3))](),this[_0xdf1ee8(0x1b7)]=new coinToPayService_1[(_0xdf1ee8(0x1d2))](),this[_0xdf1ee8(0x121)]=new coinToPay2Service_1[(_0xdf1ee8(0xf6))](),this[_0xdf1ee8(0xfa)]=new klymeService_1[(_0xdf1ee8(0x172))](),this['masterCardService']=new mastercardService_1[(_0xdf1ee8(0x1b6))](),this[_0xdf1ee8(0x1e1)]=new amerService_1[(_0xdf1ee8(0x174))]();}async[a60_0x3f0979(0x103)](_0x276a59,_0x1e1a86,_0x567e5b){const _0x3fff7f=a60_0x3f0979;console[_0x3fff7f(0x135)]('üîÑ\x20updatePaymentStatus\x20called:\x20paymentId='+_0x276a59+_0x3fff7f(0x101)+_0x1e1a86),console[_0x3fff7f(0x135)](_0x3fff7f(0x1cc),_0x567e5b),await database_1[_0x3fff7f(0x14f)][_0x3fff7f(0x132)](async _0x48ae57=>{const _0x673c2f=_0x3fff7f,_0xb2c001=await _0x48ae57['payment']['findUnique']({'where':{'id':_0x276a59},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xb2c001)throw new Error(_0x673c2f(0x1a7)+_0x276a59+'\x20not\x20found');const _0x455809=_0xb2c001[_0x673c2f(0x141)],_0x2869e9=_0xb2c001[_0x673c2f(0x109)];console[_0x673c2f(0x135)]('üí∞\x20Payment\x20'+_0x276a59+':\x20'+_0x455809+_0x673c2f(0x115)+_0x1e1a86),console['log']('üè™\x20Shop\x20'+_0x2869e9['username']+_0x673c2f(0x193)+_0x2869e9[_0x673c2f(0x1bc)]+_0x673c2f(0x1df));const _0x2ac570={'status':_0x1e1a86['toUpperCase'](),'updatedAt':new Date(),'statusChangedBy':_0x673c2f(0x12c),'statusChangedAt':new Date()};_0x567e5b?.[_0x673c2f(0x181)]&&(_0x2ac570[_0x673c2f(0x181)]=_0x567e5b[_0x673c2f(0x181)]);_0x567e5b?.[_0x673c2f(0x114)]&&(_0x2ac570['txUrls']=JSON[_0x673c2f(0x1c6)](_0x567e5b[_0x673c2f(0x114)]));_0x567e5b?.[_0x673c2f(0x19a)]&&(_0x2ac570[_0x673c2f(0x19a)]=_0x567e5b['cardLast4']);_0x567e5b?.[_0x673c2f(0x17d)]&&(_0x2ac570['paymentMethod']=_0x567e5b[_0x673c2f(0x17d)]);_0x567e5b?.[_0x673c2f(0x112)]&&(_0x2ac570['bankId']=_0x567e5b['bankId']);_0x567e5b?.[_0x673c2f(0x159)]&&(_0x2ac570['remitterIban']=_0x567e5b[_0x673c2f(0x159)]);_0x567e5b?.[_0x673c2f(0x166)]&&(_0x2ac570[_0x673c2f(0x166)]=_0x567e5b[_0x673c2f(0x166)]);let _0x2bdd24=_0x2869e9['balance'],_0x34a633='';if(_0x1e1a86[_0x673c2f(0x165)]()===_0x673c2f(0x10e)&&_0x455809!==_0x673c2f(0x10e)){const _0x3c4bad=await currencyService_1[_0x673c2f(0x1a3)]['convertToUSDT'](_0xb2c001['amount'],_0xb2c001['currency']),_0x4d1267=await this[_0x673c2f(0x1b0)](_0x2869e9['id'],_0xb2c001['gateway']),_0x39639c=_0x3c4bad*(0x1-_0x4d1267/0x64);_0x2bdd24+=_0x39639c,_0x34a633='+'+_0x39639c[_0x673c2f(0x1a2)](0x6)+_0x673c2f(0x102)+_0x4d1267+'%\x20gateway\x20commission)',_0x2ac570[_0x673c2f(0x127)]=_0x3c4bad,_0x2ac570[_0x673c2f(0x1de)]=_0x39639c,_0x2ac570[_0x673c2f(0x1d6)]=new Date(),console[_0x673c2f(0x135)]('üí∞\x20Converting\x20'+_0xb2c001[_0x673c2f(0x113)]+'\x20'+_0xb2c001[_0x673c2f(0x13a)]+_0x673c2f(0x115)+_0x3c4bad[_0x673c2f(0x1a2)](0x6)+_0x673c2f(0x1df)),console['log'](_0x673c2f(0x10f)+_0xb2c001['gateway']+'\x20commission:\x20'+_0x4d1267+'%'),console[_0x673c2f(0x135)]('üí∞\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x39639c[_0x673c2f(0x1a2)](0x6)+_0x673c2f(0x1df)),console[_0x673c2f(0x135)](_0x673c2f(0xfb)+_0x2869e9[_0x673c2f(0x1bc)]+_0x673c2f(0x134)+_0x39639c['toFixed'](0x6)+'\x20=\x20'+_0x2bdd24[_0x673c2f(0x1a2)](0x6)+'\x20USDT');}else{if(_0x455809==='PAID'&&_0x1e1a86['toUpperCase']()!==_0x673c2f(0x10e)){let _0x5c9e44;if(_0xb2c001[_0x673c2f(0x1de)])_0x5c9e44=_0xb2c001[_0x673c2f(0x1de)];else{if(_0xb2c001[_0x673c2f(0x127)]){const _0x554f07=await this['getGatewayCommission'](_0x2869e9['id'],_0xb2c001[_0x673c2f(0x13e)]);_0x5c9e44=_0xb2c001[_0x673c2f(0x127)]*(0x1-_0x554f07/0x64);}else console[_0x673c2f(0x135)](_0x673c2f(0x1d1)),_0x5c9e44=0x0;}_0x5c9e44>0x0&&(_0x2bdd24-=_0x5c9e44,_0x34a633='-'+_0x5c9e44[_0x673c2f(0x1a2)](0x6)+_0x673c2f(0xf7),_0x2ac570[_0x673c2f(0x127)]=null,_0x2ac570[_0x673c2f(0x1de)]=null,_0x2ac570['paidAt']=null,console[_0x673c2f(0x135)](_0x673c2f(0x145)+_0x2869e9[_0x673c2f(0x1bc)]+_0x673c2f(0x170)+_0x5c9e44[_0x673c2f(0x1a2)](0x6)+_0x673c2f(0x1c3)+_0x2bdd24[_0x673c2f(0x1a2)](0x6)+'\x20USDT'));}}if(_0x1e1a86['toUpperCase']()===_0x673c2f(0x192)){const _0x13da76=_0x567e5b?.[_0x673c2f(0x17a)]||0x0;_0x13da76>0x0&&(_0x2bdd24-=_0x13da76,_0x34a633+=_0x673c2f(0x1cb)+_0x13da76[_0x673c2f(0x1a2)](0x6)+_0x673c2f(0xfc),_0x2ac570[_0x673c2f(0x17a)]=_0x13da76,console[_0x673c2f(0x135)](_0x673c2f(0x15f)+_0x13da76[_0x673c2f(0x1a2)](0x6)+_0x673c2f(0x1df)),console['log']('üí∞\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x2bdd24[_0x673c2f(0x1a2)](0x6)+_0x673c2f(0x1df)));}const _0x3eb7fa=await _0x48ae57[_0x673c2f(0x16f)][_0x673c2f(0x1db)]({'where':{'id':_0x276a59},'data':_0x2ac570});_0x2bdd24!==_0x2869e9[_0x673c2f(0x1bc)]&&(await _0x48ae57[_0x673c2f(0x109)][_0x673c2f(0x1db)]({'where':{'id':_0x2869e9['id']},'data':{'balance':_0x2bdd24}}),console[_0x673c2f(0x135)]('‚úÖ\x20Shop\x20'+_0x2869e9[_0x673c2f(0x162)]+_0x673c2f(0x136)+_0x2869e9['balance'][_0x673c2f(0x1a2)](0x6)+_0x673c2f(0x115)+_0x2bdd24[_0x673c2f(0x1a2)](0x6)+_0x673c2f(0x1df)),console['log'](_0x673c2f(0x18a)+_0x34a633));await _0x48ae57[_0x673c2f(0x107)][_0x673c2f(0x140)]({'data':{'paymentId':_0x276a59,'shopId':_0x2869e9['id'],'event':'webhook_status_change_'+_0x1e1a86[_0x673c2f(0x194)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x455809,'newStatus':_0x1e1a86[_0x673c2f(0x165)](),'balanceChange':_0x34a633||'no\x20balance\x20change','oldBalance':_0x2869e9['balance'],'newBalance':_0x2bdd24,'amountUSDT':_0x2ac570[_0x673c2f(0x127)],'additionalData':_0x567e5b,'timestamp':new Date()[_0x673c2f(0xf8)]()})}}),await this[_0x673c2f(0x122)]({..._0xb2c001,..._0x3eb7fa,'shop':_0x2869e9},_0x1e1a86[_0x673c2f(0x165)]()),await this[_0x673c2f(0x1dd)]({..._0xb2c001,..._0x3eb7fa},_0x1e1a86['toUpperCase']());if(_0x455809!==_0x673c2f(0x10e)&&_0x1e1a86['toUpperCase']()===_0x673c2f(0x10e)){console[_0x673c2f(0x135)](_0x673c2f(0x139)+_0x276a59+'\x20became\x20PAID\x20via\x20webhook,\x20updating\x20payment\x20link\x20counter'),console[_0x673c2f(0x135)](_0x673c2f(0x16c)+_0x455809+'\x22,\x20newStatus=\x22'+_0x1e1a86[_0x673c2f(0x165)]()+_0x673c2f(0x1b9)+_0xb2c001[_0x673c2f(0x124)]+'\x22');if(_0xb2c001[_0x673c2f(0x124)])try{const _0x4cca66=await _0x48ae57[_0x673c2f(0x1a5)][_0x673c2f(0x1ab)]({'where':{'id':_0xb2c001[_0x673c2f(0x124)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4cca66){console[_0x673c2f(0x135)](_0x673c2f(0x19b)+_0x4cca66['id']+_0x673c2f(0x15a)+_0x4cca66[_0x673c2f(0x116)]+_0x673c2f(0x1e2)+_0x4cca66[_0x673c2f(0x149)]+_0x673c2f(0x1da)+_0x4cca66[_0x673c2f(0x141)]);const _0x5f45d3=_0x4cca66['currentPayments']+0x1,_0x31b6ca=_0x4cca66['type']===_0x673c2f(0x153)?_0x673c2f(0x18b):_0x4cca66['status'];await _0x48ae57['paymentLink'][_0x673c2f(0x1db)]({'where':{'id':_0xb2c001[_0x673c2f(0x124)]},'data':{'currentPayments':_0x5f45d3,'status':_0x31b6ca,'updatedAt':new Date()}}),console[_0x673c2f(0x135)]('‚úÖ\x20Payment\x20link\x20'+_0x4cca66['id']+_0x673c2f(0x126)+_0x4cca66[_0x673c2f(0x149)]+'\x20->\x20'+_0x5f45d3+',\x20status='+_0x4cca66[_0x673c2f(0x141)]+_0x673c2f(0x115)+_0x31b6ca);}else console[_0x673c2f(0x135)](_0x673c2f(0x195)+_0xb2c001[_0x673c2f(0x124)]+_0x673c2f(0xfd));}catch(_0x227b08){console[_0x673c2f(0x1c4)](_0x673c2f(0x178),_0x227b08);}else console[_0x673c2f(0x135)](_0x673c2f(0x139)+_0x276a59+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}else console[_0x673c2f(0x135)]('üìà\x20Payment\x20'+_0x276a59+_0x673c2f(0x1a1)+_0x455809+_0x673c2f(0x115)+_0x1e1a86[_0x673c2f(0x165)]());});}async['processPlisioWebhook'](_0x4535ec){const _0x3ea1d2=a60_0x3f0979;console[_0x3ea1d2(0x135)]('üîÑ\x20Processing\x20Plisio\x20webhook:',_0x4535ec);try{const _0x4f1b6c=await this[_0x3ea1d2(0x15d)]['processWebhook'](_0x4535ec);if(!_0x4f1b6c[_0x3ea1d2(0x13c)])throw new Error(_0x3ea1d2(0x12b));const _0x186623=await database_1[_0x3ea1d2(0x14f)][_0x3ea1d2(0x16f)][_0x3ea1d2(0x185)]({'where':{'gatewayOrderId':_0x4f1b6c['paymentId']}});if(!_0x186623){console[_0x3ea1d2(0x1c4)](_0x3ea1d2(0x138)+_0x4f1b6c['paymentId']);return;}console['log']('üìä\x20Plisio\x20webhook:\x20Payment\x20'+_0x186623['id']+_0x3ea1d2(0x13b)+_0x4f1b6c[_0x3ea1d2(0x141)]),await this['updatePaymentStatus'](_0x186623['id'],_0x4f1b6c['status'],{'txUrls':_0x4f1b6c[_0x3ea1d2(0x114)]}),loggerService_1[_0x3ea1d2(0x1e0)][_0x3ea1d2(0x12f)](_0x3ea1d2(0x188),_0x186623['id'],_0x186623[_0x3ea1d2(0x141)],_0x4f1b6c[_0x3ea1d2(0x141)],_0x4535ec);}catch(_0x5901a1){console[_0x3ea1d2(0x1c4)](_0x3ea1d2(0x133),_0x5901a1),loggerService_1['loggerService'][_0x3ea1d2(0x1c7)](_0x3ea1d2(0x188),_0x5901a1,_0x4535ec);throw _0x5901a1;}}async[a60_0x3f0979(0x1d3)](_0x50959e){const _0x170c34=a60_0x3f0979;console[_0x170c34(0x135)](_0x170c34(0x1d5),_0x50959e);try{const _0x1aa880=await this['plisioService']['processWebhook'](_0x50959e);if(!_0x1aa880[_0x170c34(0x13c)])throw new Error(_0x170c34(0x1b3));const _0x4b3189=await database_1[_0x170c34(0x14f)][_0x170c34(0x16f)][_0x170c34(0x185)]({'where':{'gatewayOrderId':_0x1aa880[_0x170c34(0x13c)]}});if(!_0x4b3189){console[_0x170c34(0x1c4)](_0x170c34(0x179)+_0x1aa880['paymentId']);return;}console[_0x170c34(0x135)](_0x170c34(0x117)+_0x4b3189['id']+_0x170c34(0x13b)+_0x1aa880['status']),await this[_0x170c34(0x103)](_0x4b3189['id'],_0x1aa880[_0x170c34(0x141)],{'txUrls':_0x1aa880[_0x170c34(0x114)]}),loggerService_1[_0x170c34(0x1e0)][_0x170c34(0x12f)](_0x170c34(0x191),_0x4b3189['id'],_0x4b3189['status'],_0x1aa880[_0x170c34(0x141)],_0x50959e);}catch(_0x5419cb){console['error']('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x5419cb),loggerService_1[_0x170c34(0x1e0)][_0x170c34(0x1c7)](_0x170c34(0x191),_0x5419cb,_0x50959e);throw _0x5419cb;}}async[a60_0x3f0979(0x1a4)](_0x5a6537){const _0x173d51=a60_0x3f0979;console[_0x173d51(0x135)](_0x173d51(0x12e),_0x5a6537);try{const _0x121721=await this['rapydService'][_0x173d51(0x1c1)](_0x5a6537);if(!_0x121721['paymentId'])throw new Error(_0x173d51(0x106));const _0x5b51ee=await database_1[_0x173d51(0x14f)][_0x173d51(0x16f)]['findFirst']({'where':{'gatewayOrderId':_0x121721['paymentId']}});if(!_0x5b51ee){console['error']('Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20'+_0x121721['paymentId']);return;}console['log'](_0x173d51(0x1d8)+_0x5b51ee['id']+'\x20status\x20'+_0x121721[_0x173d51(0x141)]),await this[_0x173d51(0x103)](_0x5b51ee['id'],_0x121721[_0x173d51(0x141)],{'failureMessage':_0x121721['failureMessage'],'cardLast4':_0x121721[_0x173d51(0x1cf)]?.[_0x173d51(0x19a)],'paymentMethod':_0x121721['additionalInfo']?.[_0x173d51(0x17d)]}),loggerService_1['loggerService'][_0x173d51(0x12f)]('rapyd',_0x5b51ee['id'],_0x5b51ee['status'],_0x121721['status'],_0x5a6537);}catch(_0x18fb20){console[_0x173d51(0x1c4)]('Error\x20processing\x20Rapyd\x20webhook:',_0x18fb20),loggerService_1[_0x173d51(0x1e0)]['logWebhookError'](_0x173d51(0x15b),_0x18fb20,_0x5a6537);throw _0x18fb20;}}async[a60_0x3f0979(0x18c)](_0x20f8bf){const _0x50a99a=a60_0x3f0979;console[_0x50a99a(0x135)]('üîÑ\x20Processing\x20Noda\x20webhook:',_0x20f8bf);try{const _0x8b4385=await this['nodaService'][_0x50a99a(0x1c1)](_0x20f8bf);if(!_0x8b4385['paymentId'])throw new Error(_0x50a99a(0xfe));const _0x5a2666=await database_1['default']['payment'][_0x50a99a(0x185)]({'where':{'gatewayOrderId':_0x8b4385['paymentId']}});if(!_0x5a2666){console[_0x50a99a(0x1c4)](_0x50a99a(0x164)+_0x8b4385[_0x50a99a(0x13c)]);return;}console['log'](_0x50a99a(0x197)+_0x5a2666['id']+_0x50a99a(0x13b)+_0x8b4385[_0x50a99a(0x141)]),await this[_0x50a99a(0x103)](_0x5a2666['id'],_0x8b4385[_0x50a99a(0x141)],{'bankId':_0x8b4385['additionalInfo']?.[_0x50a99a(0x112)],'remitterIban':_0x8b4385[_0x50a99a(0x1cf)]?.[_0x50a99a(0x159)],'remitterName':_0x8b4385[_0x50a99a(0x1cf)]?.[_0x50a99a(0x166)]}),loggerService_1[_0x50a99a(0x1e0)][_0x50a99a(0x12f)](_0x50a99a(0x189),_0x5a2666['id'],_0x5a2666[_0x50a99a(0x141)],_0x8b4385[_0x50a99a(0x141)],_0x20f8bf);}catch(_0x482d59){console[_0x50a99a(0x1c4)](_0x50a99a(0x16b),_0x482d59),loggerService_1[_0x50a99a(0x1e0)][_0x50a99a(0x1c7)](_0x50a99a(0x189),_0x482d59,_0x20f8bf);throw _0x482d59;}}async['processCoinToPayWebhook'](_0x19ce45){const _0x1425c8=a60_0x3f0979;console['log'](_0x1425c8(0x1ad),_0x19ce45);try{const _0x37809e=await this[_0x1425c8(0x1b7)][_0x1425c8(0x1c1)](_0x19ce45);if(!_0x37809e[_0x1425c8(0x13c)])throw new Error(_0x1425c8(0x128));const _0x143564=await database_1[_0x1425c8(0x14f)]['payment'][_0x1425c8(0x185)]({'where':{'gatewayOrderId':_0x37809e[_0x1425c8(0x13c)]}});if(!_0x143564){console[_0x1425c8(0x1c4)](_0x1425c8(0x173)+_0x37809e[_0x1425c8(0x13c)]);return;}console['log'](_0x1425c8(0x1c5)+_0x143564['id']+_0x1425c8(0x13b)+_0x37809e[_0x1425c8(0x141)]),await this[_0x1425c8(0x103)](_0x143564['id'],_0x37809e[_0x1425c8(0x141)]),loggerService_1['loggerService']['logWebhookProcessed'](_0x1425c8(0x111),_0x143564['id'],_0x143564[_0x1425c8(0x141)],_0x37809e[_0x1425c8(0x141)],_0x19ce45);}catch(_0x281d71){console[_0x1425c8(0x1c4)](_0x1425c8(0x182),_0x281d71),loggerService_1[_0x1425c8(0x1e0)]['logWebhookError'](_0x1425c8(0x111),_0x281d71,_0x19ce45);throw _0x281d71;}}async[a60_0x3f0979(0x17e)](_0x5d04e7){const _0x4a4955=a60_0x3f0979;console[_0x4a4955(0x135)](_0x4a4955(0x19e),_0x5d04e7);try{const _0x4729d6=await this[_0x4a4955(0x121)][_0x4a4955(0x1c1)](_0x5d04e7);if(!_0x4729d6[_0x4a4955(0x13c)])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay2\x20webhook');const _0x502ae9=await database_1[_0x4a4955(0x14f)][_0x4a4955(0x16f)][_0x4a4955(0x185)]({'where':{'gatewayOrderId':_0x4729d6[_0x4a4955(0x13c)]}});if(!_0x502ae9){console['error'](_0x4a4955(0x190)+_0x4729d6[_0x4a4955(0x13c)]);return;}console['log']('üìä\x20CoinToPay2\x20webhook:\x20Payment\x20'+_0x502ae9['id']+_0x4a4955(0x13b)+_0x4729d6[_0x4a4955(0x141)]),await this[_0x4a4955(0x103)](_0x502ae9['id'],_0x4729d6[_0x4a4955(0x141)]),loggerService_1[_0x4a4955(0x1e0)][_0x4a4955(0x12f)]('cointopay2',_0x502ae9['id'],_0x502ae9[_0x4a4955(0x141)],_0x4729d6['status'],_0x5d04e7);}catch(_0x4a3880){console[_0x4a4955(0x1c4)](_0x4a4955(0x1bd),_0x4a3880),loggerService_1[_0x4a4955(0x1e0)][_0x4a4955(0x1c7)]('cointopay2',_0x4a3880,_0x5d04e7);throw _0x4a3880;}}async[a60_0x3f0979(0x156)](_0xbf842d){const _0x5671c9=a60_0x3f0979;console[_0x5671c9(0x135)](_0x5671c9(0x1d9),_0xbf842d);try{const _0x3bf111=await this[_0x5671c9(0xfa)][_0x5671c9(0x1c1)](_0xbf842d);if(!_0x3bf111[_0x5671c9(0x13c)])throw new Error(_0x5671c9(0x119));const _0x47b9fc=await database_1['default'][_0x5671c9(0x16f)][_0x5671c9(0x185)]({'where':{'gatewayOrderId':_0x3bf111[_0x5671c9(0x13c)]}});if(!_0x47b9fc){console[_0x5671c9(0x1c4)](_0x5671c9(0x1b5)+_0x3bf111[_0x5671c9(0x13c)]);return;}console[_0x5671c9(0x135)](_0x5671c9(0x11d)+_0x47b9fc['id']+_0x5671c9(0x13b)+_0x3bf111[_0x5671c9(0x141)]),await this['updatePaymentStatus'](_0x47b9fc['id'],_0x3bf111[_0x5671c9(0x141)],{'paymentMethod':_0x3bf111[_0x5671c9(0x1cf)]?.[_0x5671c9(0x186)]}),loggerService_1[_0x5671c9(0x1e0)][_0x5671c9(0x12f)](_0x5671c9(0x1be),_0x47b9fc['id'],_0x47b9fc[_0x5671c9(0x141)],_0x3bf111[_0x5671c9(0x141)],_0xbf842d);}catch(_0x5320eb){console[_0x5671c9(0x1c4)](_0x5671c9(0x123),_0x5320eb),loggerService_1[_0x5671c9(0x1e0)][_0x5671c9(0x1c7)]('klyme',_0x5320eb,_0xbf842d);throw _0x5320eb;}}async[a60_0x3f0979(0x1ce)](_0x5944ad){const _0x15f8d3=a60_0x3f0979;console[_0x15f8d3(0x135)](_0x15f8d3(0x1a9),JSON[_0x15f8d3(0x1c6)](_0x5944ad,null,0x2));try{const _0x55b9e2=await this[_0x15f8d3(0x1bb)][_0x15f8d3(0x1c1)](_0x5944ad);console['log'](_0x15f8d3(0x180),_0x55b9e2);if(!_0x55b9e2[_0x15f8d3(0x13c)]){console[_0x15f8d3(0x1c4)](_0x15f8d3(0x13d)),console['error'](_0x15f8d3(0x171),Object[_0x15f8d3(0x176)](_0x5944ad));throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');}let _0x111965=null;console[_0x15f8d3(0x135)](_0x15f8d3(0x187)+_0x55b9e2[_0x15f8d3(0x13c)]);_0x55b9e2[_0x15f8d3(0x13c)]&&(console[_0x15f8d3(0x135)]('üîç\x20Trying\x20to\x20find\x20MasterCard\x20payment\x20by\x20various\x20fields...'),_0x111965=await database_1[_0x15f8d3(0x14f)][_0x15f8d3(0x16f)][_0x15f8d3(0x185)]({'where':{'AND':[{'gateway':_0x15f8d3(0x146)},{'OR':[{'gatewayPaymentId':_0x55b9e2['paymentId']},{'gatewayOrderId':_0x55b9e2[_0x15f8d3(0x13c)]},{'id':_0x55b9e2[_0x15f8d3(0x13c)]},{'orderId':_0x55b9e2[_0x15f8d3(0x13c)]}]}]}}),console[_0x15f8d3(0x135)]('üîç\x20Search\x20result:\x20'+(_0x111965?_0x15f8d3(0x144)+_0x111965['id']:'Payment\x20not\x20found')));if(!_0x111965){console[_0x15f8d3(0x1c4)](_0x15f8d3(0x120)+_0x55b9e2['paymentId']),console['error'](_0x15f8d3(0x1c8)+_0x55b9e2['paymentId']+_0x15f8d3(0x183)+_0x55b9e2[_0x15f8d3(0x13c)]+_0x15f8d3(0x167)+_0x55b9e2[_0x15f8d3(0x13c)]+'\x22');const _0x55c7fb=await database_1[_0x15f8d3(0x14f)][_0x15f8d3(0x16f)]['findMany']({'where':{'gateway':'mastercard'},'select':{'id':!![],'gatewayOrderId':!![],'gatewayPaymentId':!![],'orderId':!![],'status':!![]},'take':0xa});console[_0x15f8d3(0x135)](_0x15f8d3(0x184),_0x55c7fb);return;}console[_0x15f8d3(0x135)](_0x15f8d3(0x1d4)+_0x111965['id']+_0x15f8d3(0x1c0)+_0x111965['status']+_0x15f8d3(0x118)+_0x55b9e2[_0x15f8d3(0x141)]),await this[_0x15f8d3(0x103)](_0x111965['id'],_0x55b9e2['status']),loggerService_1[_0x15f8d3(0x1e0)][_0x15f8d3(0x12f)](_0x15f8d3(0x146),_0x111965['id'],_0x111965['status'],_0x55b9e2[_0x15f8d3(0x141)],_0x5944ad);}catch(_0x601be4){console[_0x15f8d3(0x1c4)](_0x15f8d3(0x19c),_0x601be4),loggerService_1[_0x15f8d3(0x1e0)][_0x15f8d3(0x1c7)](_0x15f8d3(0x146),_0x601be4,_0x5944ad);throw _0x601be4;}}async[a60_0x3f0979(0x1cd)](_0x58d12e){const _0x109468=a60_0x3f0979;console[_0x109468(0x135)](_0x109468(0x1d7),JSON[_0x109468(0x1c6)](_0x58d12e,null,0x2));try{const _0x5cf4b3=await this[_0x109468(0x1e1)][_0x109468(0x1c1)](_0x58d12e);console[_0x109468(0x135)](_0x109468(0x17c),_0x5cf4b3);if(!_0x5cf4b3[_0x109468(0x13c)]){console['error'](_0x109468(0x10d)),console[_0x109468(0x1c4)](_0x109468(0x171),Object['keys'](_0x58d12e));throw new Error('No\x20payment\x20ID\x20in\x20Amer\x20webhook');}let _0x4364dd=null;console[_0x109468(0x135)](_0x109468(0x18d)+_0x5cf4b3[_0x109468(0x13c)]),_0x4364dd=await database_1[_0x109468(0x14f)]['payment']['findFirst']({'where':{'AND':[{'gateway':_0x109468(0x14e)},{'OR':[{'gatewayPaymentId':_0x5cf4b3[_0x109468(0x13c)]},{'gatewayOrderId':_0x5cf4b3[_0x109468(0x13c)]},{'id':_0x5cf4b3[_0x109468(0x13c)]},{'orderId':_0x5cf4b3['paymentId']}]}]}}),console[_0x109468(0x135)](_0x109468(0x19d)+(_0x4364dd?_0x109468(0x144)+_0x4364dd['id']:'Payment\x20not\x20found'));if(!_0x4364dd){console[_0x109468(0x1c4)](_0x109468(0x155)+_0x5cf4b3['paymentId']);return;}console['log'](_0x109468(0x1a8)+_0x4364dd['id']+_0x109468(0x13b)+_0x5cf4b3[_0x109468(0x141)]),await this[_0x109468(0x103)](_0x4364dd['id'],_0x5cf4b3['status'],{'cardLast4':_0x5cf4b3[_0x109468(0x1cf)]?.['cardLast4'],'paymentMethod':_0x5cf4b3[_0x109468(0x1cf)]?.[_0x109468(0x17d)]});}catch(_0x45fb55){console[_0x109468(0x1c4)](_0x109468(0x129),_0x45fb55),loggerService_1[_0x109468(0x1e0)][_0x109468(0x1c7)](_0x109468(0x14e),_0x45fb55,_0x58d12e);throw _0x45fb55;}}async['sendShopWebhook'](_0x281860,_0x2c325b){const _0xb8b804=a60_0x3f0979,_0x56ee00=Date['now']();try{const _0x4eaa26=_0x281860[_0xb8b804(0x109)],_0x466c8c=_0x4eaa26['settings'];if(!_0x466c8c?.['webhookUrl']){console[_0xb8b804(0x135)](_0xb8b804(0x12a)+_0x4eaa26['id']);return;}const _0x36b3c3=_0x2c325b===_0xb8b804(0x10e)?_0xb8b804(0x142):_0x2c325b===_0xb8b804(0x163)?_0xb8b804(0x168):_0x2c325b==='EXPIRED'?_0xb8b804(0x168):_0x2c325b===_0xb8b804(0x192)?'payment.failed':_0x2c325b==='REFUND'?'payment.failed':_0xb8b804(0x14d);let _0x4f7255=[];if(_0x466c8c[_0xb8b804(0x125)])try{_0x4f7255=Array['isArray'](_0x466c8c['webhookEvents'])?_0x466c8c[_0xb8b804(0x125)]:JSON[_0xb8b804(0x104)](_0x466c8c['webhookEvents']);}catch(_0x4a1f24){console['error']('Error\x20parsing\x20webhook\x20events:',_0x4a1f24),_0x4f7255=[];}if(!_0x4f7255['includes'](_0x36b3c3)){console[_0xb8b804(0x135)](_0xb8b804(0x14c)+_0x36b3c3+_0xb8b804(0x151)+_0x4eaa26['id']);return;}const _0x4cd8b4={'event':_0x36b3c3,'payment':{'id':_0x281860['id'],'order_id':_0x281860[_0xb8b804(0x1c9)],'gateway_order_id':_0x281860[_0xb8b804(0x148)],'gateway':_0x281860[_0xb8b804(0x13e)],'amount':_0x281860[_0xb8b804(0x113)],'currency':_0x281860[_0xb8b804(0x13a)],'status':_0x2c325b[_0xb8b804(0x194)](),'customer_email':_0x281860[_0xb8b804(0x147)],'customer_name':_0x281860[_0xb8b804(0x11a)],'failure_message':_0x281860[_0xb8b804(0x181)],'tx_urls':_0x281860[_0xb8b804(0x114)]?JSON[_0xb8b804(0x104)](_0x281860[_0xb8b804(0x114)]):null,'created_at':_0x281860[_0xb8b804(0x154)],'updated_at':_0x281860[_0xb8b804(0x158)]}},_0xedea3c=await fetch(_0x466c8c[_0xb8b804(0x1a0)],{'method':_0xb8b804(0x196),'headers':{'Content-Type':_0xb8b804(0x19f),'User-Agent':_0xb8b804(0x137)},'body':JSON[_0xb8b804(0x1c6)](_0x4cd8b4)}),_0x38a43a=Date[_0xb8b804(0x1b4)]()-_0x56ee00,_0x9ac844=_0xedea3c['ok']?'Success':await _0xedea3c[_0xb8b804(0x105)]();loggerService_1[_0xb8b804(0x1e0)]['logShopWebhookSent'](_0x281860[_0xb8b804(0x1ca)],_0x466c8c['webhookUrl'],_0x36b3c3,_0xedea3c[_0xb8b804(0x141)],_0x38a43a,_0x4cd8b4),console[_0xb8b804(0x135)](_0xb8b804(0x12d)+_0x466c8c[_0xb8b804(0x1a0)]+'\x20with\x20status\x20'+_0xedea3c[_0xb8b804(0x141)]+'\x20('+_0x38a43a+_0xb8b804(0x11c));}catch(_0x53de45){console[_0xb8b804(0x1c4)](_0xb8b804(0x11f),_0x53de45),loggerService_1[_0xb8b804(0x1e0)][_0xb8b804(0x1b8)](_0x281860[_0xb8b804(0x1ca)],_0x281860['shop']?.[_0xb8b804(0x13f)]?.['webhookUrl']||_0xb8b804(0x10a),_0xb8b804(0x108),_0x53de45,{});}}async[a60_0x3f0979(0x1dd)](_0x20dd5a,_0x5d52f5){const _0x4cca0a=a60_0x3f0979;try{const _0x381c2e={'PENDING':'created','PROCESSING':'processing','PAID':'paid','FAILED':'failed','EXPIRED':_0x4cca0a(0x130),'REFUND':_0x4cca0a(0x16e),'CHARGEBACK':_0x4cca0a(0x17f)},_0x116b09=_0x381c2e[_0x5d52f5];if(!_0x116b09||_0x116b09===_0x4cca0a(0x160))return;await telegramBotService_1[_0x4cca0a(0x1a6)][_0x4cca0a(0x1ba)](_0x20dd5a[_0x4cca0a(0x1ca)],_0x20dd5a,_0x116b09);}catch(_0x1abfac){console['error'](_0x4cca0a(0x150),_0x1abfac);}}async['getGatewayCommission'](_0x391f53,_0x5c18ce){const _0x10aac2=a60_0x3f0979;try{const _0x51d145=await database_1[_0x10aac2(0x14f)][_0x10aac2(0x109)][_0x10aac2(0x1ab)]({'where':{'id':_0x391f53},'select':{'gatewaySettings':!![]}});if(!_0x51d145?.[_0x10aac2(0x152)])return console[_0x10aac2(0x135)](_0x10aac2(0x11e)+_0x391f53+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x111cad=JSON[_0x10aac2(0x104)](_0x51d145['gatewaySettings']);for(const [_0x2176c4,_0xa735a5]of Object[_0x10aac2(0xf9)](_0x111cad)){if(_0x2176c4[_0x10aac2(0x194)]()===_0x5c18ce[_0x10aac2(0x194)]()){const _0x47eb3a=_0xa735a5[_0x10aac2(0x157)]||0xa;return console['log'](_0x10aac2(0x16a)+_0x5c18ce+_0x10aac2(0x10b)+_0x391f53+':\x20'+_0x47eb3a+'%'),_0x47eb3a;}}return console['log'](_0x10aac2(0x14a)+_0x5c18ce+_0x10aac2(0x110)+_0x391f53+_0x10aac2(0x131)),0xa;}catch(_0x1150bc){return console[_0x10aac2(0x1c4)](_0x10aac2(0x199)+_0x391f53+_0x10aac2(0x1ae)+_0x5c18ce+':',_0x1150bc),0xa;}}}exports['WebhookService']=WebhookService;