'use strict';const a57_0x4f4229=a57_0x1f57;(function(_0x346874,_0x359260){const _0x328e8b=a57_0x1f57,_0x4e65c0=_0x346874();while(!![]){try{const _0x3fef8c=parseInt(_0x328e8b(0x12b))/0x1+parseInt(_0x328e8b(0xe9))/0x2*(parseInt(_0x328e8b(0x16d))/0x3)+parseInt(_0x328e8b(0x153))/0x4*(-parseInt(_0x328e8b(0x11a))/0x5)+-parseInt(_0x328e8b(0xe6))/0x6+parseInt(_0x328e8b(0xfa))/0x7*(parseInt(_0x328e8b(0xc7))/0x8)+parseInt(_0x328e8b(0x107))/0x9*(-parseInt(_0x328e8b(0x10c))/0xa)+parseInt(_0x328e8b(0x157))/0xb*(-parseInt(_0x328e8b(0xea))/0xc);if(_0x3fef8c===_0x359260)break;else _0x4e65c0['push'](_0x4e65c0['shift']());}catch(_0x3f8bc9){_0x4e65c0['push'](_0x4e65c0['shift']());}}}(a57_0x281e,0x631c3));var __importDefault=this&&this[a57_0x4f4229(0x15a)]||function(_0x341ce1){return _0x341ce1&&_0x341ce1['__esModule']?_0x341ce1:{'default':_0x341ce1};};function a57_0x1f57(_0x2828f5,_0x256188){const _0x281eee=a57_0x281e();return a57_0x1f57=function(_0x1f5756,_0x27a43f){_0x1f5756=_0x1f5756-0xc6;let _0x253ae9=_0x281eee[_0x1f5756];return _0x253ae9;},a57_0x1f57(_0x2828f5,_0x256188);}function a57_0x281e(){const _0x138398=['paymentLinkService','sendPaymentNotification','paid','Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20','sendShopWebhook','created','\x20not\x20enabled\x20for\x20shop\x20','9aajnVN','findFirst','📈\x20Payment\x20link\x20counter\x20updated\x20for\x20payment\x20','plisio','balance','1956820LfpqfE','gatewayOrderId','txUrls','\x20status\x20','🔄\x20Processing\x20Noda\x20webhook:','orderId','Error\x20processing\x20Plisio\x20webhook:','defineProperty','log','MasterCardService','toLowerCase','klyme','chargeback','toFixed','74015dVTlbN','\x20not\x20found','now','additionalInfo','paidAt','\x20current\x20balance:\x20','Success','parse','Failed\x20to\x20send\x20shop\x20webhook:','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','📊\x20Rapyd\x20webhook:\x20Payment\x20','💰\x20Adding\x20to\x20balance:\x20','shopId','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','\x20=\x20','processPlisioGatewayWebhook','rapyd','486996XHwFjt','\x20with\x20status\x20','📊\x20CoinToPay\x20webhook:\x20Payment\x20','./loggerService','customerName','REFUND','./currencyService','processing','\x20USDT\x20(chargeback\x20penalty)','📤\x20Shop\x20webhook\x20sent\x20to\x20','noda','failed','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','processPlisioWebhook','plisio_gateway','chargebackAmount','./telegramBotService','🔄\x20Processing\x20Plisio\x20webhook:','includes','logShopWebhookError','🔄\x20Updating\x20payment\x20','remitterIban','remitterName','status','WebhookService','cardLast4','cointopay','error','Error\x20processing\x20KLYME\x20webhook:','./gateways/rapydService','📊\x20KLYME\x20webhook:\x20Payment\x20','./gateways/klymeService','nodaService','update','payment.failed','💰\x20Payment\x20','💸\x20Additional\x20chargeback\x20penalty:\x20-','processKlymeWebhook','Webhook\x20event\x20','\x20USDT','172kNsgzS','paymentId','gateway','klymeService','77ysaUIx','telegramBotService','bankId','__importDefault','masterCardService','./gateways/nodaService','Error\x20processing\x20MasterCard\x20webhook:','\x20+\x20','logWebhookProcessed','webhookUrl','__esModule','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','processRapydWebhook','failureMessage','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','toUpperCase','handleSuccessfulPayment','plisioService','🔄\x20Processing\x20Rapyd\x20webhook:','Error\x20parsing\x20webhook\x20events:','mastercard','../config/database','3ZLdoXP','No\x20payment\x20ID\x20in\x20Noda\x20webhook','unknown','Payment\x20not\x20found\x20for\x20MasterCard\x20webhook:\x20','logWebhookError','stringify','\x20->\x20','$transaction','payment.success','PlisioService','Error\x20processing\x20CoinToPay\x20webhook:','processWebhook','PaymentLinkService','webhookEvents','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','📊\x20Plisio\x20webhook:\x20Payment\x20','8XHWWiJ','\x20balance\x20updated:\x20','CHARGEBACK','🔄\x20Processing\x20KLYME\x20webhook:','refund','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','settings','processNodaWebhook','default','isArray','./gateways/coinToPayService','create','PAID','📝\x20Reason:\x20','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','\x20-\x20','POST','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','findUnique','KlymeService','Payment\x20','processCoinToPayWebhook','currency','logShopWebhookSent','./gateways/mastercardService','amountUSDT','application/json','coinToPayService','rapydService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookLog','2526246PHonnu','./gateways/plisioService','payment.pending','1170142uBAWTT','290484bgWfwq','convertToUSDT','payment','\x20status\x20to\x20','NodaService','updatedAt','no\x20balance\x20change','\x20and\x20-','shop','expired','FAILED','amount','webhook_send','paymentMethod','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','username','5296123IyXFCD','updatePaymentStatus','webhook_status_change_','📊\x20Noda\x20webhook:\x20Payment\x20','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','loggerService'];a57_0x281e=function(){return _0x138398;};return a57_0x281e();}Object[a57_0x4f4229(0x113)](exports,a57_0x4f4229(0x161),{'value':!![]}),exports[a57_0x4f4229(0x143)]=void 0x0;const database_1=__importDefault(require(a57_0x4f4229(0x16c))),plisioService_1=require(a57_0x4f4229(0xe7)),rapydService_1=require(a57_0x4f4229(0x148)),nodaService_1=require(a57_0x4f4229(0x15c)),coinToPayService_1=require(a57_0x4f4229(0xd1)),klymeService_1=require(a57_0x4f4229(0x14a)),mastercardService_1=require(a57_0x4f4229(0xdf)),paymentLinkService_1=require('./paymentLinkService'),telegramBotService_1=require(a57_0x4f4229(0x13b)),currencyService_1=require(a57_0x4f4229(0x131)),loggerService_1=require(a57_0x4f4229(0x12e));class WebhookService{constructor(){const _0x4408a4=a57_0x4f4229;this[_0x4408a4(0x168)]=new plisioService_1[(_0x4408a4(0x176))](),this[_0x4408a4(0xe3)]=new rapydService_1['RapydService'](),this[_0x4408a4(0x14b)]=new nodaService_1[(_0x4408a4(0xee))](),this[_0x4408a4(0xe2)]=new coinToPayService_1['CoinToPayService'](),this['klymeService']=new klymeService_1[(_0x4408a4(0xda))](),this[_0x4408a4(0x15b)]=new mastercardService_1[(_0x4408a4(0x115))](),this[_0x4408a4(0x100)]=new paymentLinkService_1[(_0x4408a4(0x179))]();}async[a57_0x4f4229(0xfb)](_0x2bc6c6,_0x5ebcf2,_0x113f1b){const _0x496ea0=a57_0x4f4229;console[_0x496ea0(0x114)](_0x496ea0(0x13f)+_0x2bc6c6+_0x496ea0(0xed)+_0x5ebcf2);const _0x11bc23=await database_1['default'][_0x496ea0(0xec)][_0x496ea0(0xd9)]({'where':{'id':_0x2bc6c6},'select':{'status':!![],'paymentLinkId':!![]}});if(!_0x11bc23)throw new Error('Payment\x20'+_0x2bc6c6+_0x496ea0(0x11b));const _0x5236f8=_0x11bc23['status'];await database_1[_0x496ea0(0xcf)][_0x496ea0(0x174)](async _0x523c92=>{const _0x1f2ed7=_0x496ea0,_0x40a569=await _0x523c92[_0x1f2ed7(0xec)][_0x1f2ed7(0xd9)]({'where':{'id':_0x2bc6c6},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x40a569)throw new Error(_0x1f2ed7(0xdb)+_0x2bc6c6+_0x1f2ed7(0x11b));const _0x5b945e=_0x40a569[_0x1f2ed7(0x142)],_0x5a0464=_0x40a569['shop'];console['log'](_0x1f2ed7(0x14e)+_0x2bc6c6+':\x20'+_0x5b945e+_0x1f2ed7(0x173)+_0x5ebcf2),console['log']('🏪\x20Shop\x20'+_0x5a0464[_0x1f2ed7(0xf9)]+_0x1f2ed7(0x11f)+_0x5a0464[_0x1f2ed7(0x10b)]+_0x1f2ed7(0x152));const _0x41e9bb={'status':_0x5ebcf2[_0x1f2ed7(0x166)](),'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x113f1b?.[_0x1f2ed7(0x164)]&&(_0x41e9bb[_0x1f2ed7(0x164)]=_0x113f1b['failureMessage']);_0x113f1b?.[_0x1f2ed7(0x10e)]&&(_0x41e9bb['txUrls']=JSON[_0x1f2ed7(0x172)](_0x113f1b[_0x1f2ed7(0x10e)]));_0x113f1b?.[_0x1f2ed7(0x144)]&&(_0x41e9bb[_0x1f2ed7(0x144)]=_0x113f1b[_0x1f2ed7(0x144)]);_0x113f1b?.[_0x1f2ed7(0xf7)]&&(_0x41e9bb[_0x1f2ed7(0xf7)]=_0x113f1b[_0x1f2ed7(0xf7)]);_0x113f1b?.[_0x1f2ed7(0x159)]&&(_0x41e9bb[_0x1f2ed7(0x159)]=_0x113f1b[_0x1f2ed7(0x159)]);_0x113f1b?.[_0x1f2ed7(0x140)]&&(_0x41e9bb[_0x1f2ed7(0x140)]=_0x113f1b['remitterIban']);_0x113f1b?.['remitterName']&&(_0x41e9bb[_0x1f2ed7(0x141)]=_0x113f1b[_0x1f2ed7(0x141)]);let _0x4d7b4d=_0x5a0464[_0x1f2ed7(0x10b)],_0x4e50c8='';if(_0x5ebcf2['toUpperCase']()==='PAID'&&_0x5b945e!==_0x1f2ed7(0xd3)){const _0x2afea9=await currencyService_1['currencyService'][_0x1f2ed7(0xeb)](_0x40a569[_0x1f2ed7(0xf5)],_0x40a569['currency']);_0x4d7b4d+=_0x2afea9,_0x4e50c8='+'+_0x2afea9['toFixed'](0x6)+'\x20USDT\x20(payment\x20became\x20PAID)',_0x41e9bb[_0x1f2ed7(0xe0)]=_0x2afea9,_0x41e9bb['paidAt']=new Date(),console[_0x1f2ed7(0x114)]('💰\x20Converting\x20'+_0x40a569[_0x1f2ed7(0xf5)]+'\x20'+_0x40a569[_0x1f2ed7(0xdd)]+_0x1f2ed7(0x173)+_0x2afea9[_0x1f2ed7(0x119)](0x6)+'\x20USDT'),console[_0x1f2ed7(0x114)](_0x1f2ed7(0x125)+_0x5a0464[_0x1f2ed7(0x10b)]+_0x1f2ed7(0x15e)+_0x2afea9[_0x1f2ed7(0x119)](0x6)+_0x1f2ed7(0x128)+_0x4d7b4d[_0x1f2ed7(0x119)](0x6)+'\x20USDT');}else{if(_0x5b945e==='PAID'&&_0x5ebcf2[_0x1f2ed7(0x166)]()!==_0x1f2ed7(0xd3)){const _0x42f33e=_0x40a569[_0x1f2ed7(0xe0)];_0x42f33e&&(_0x4d7b4d-=_0x42f33e,_0x4e50c8='-'+_0x42f33e[_0x1f2ed7(0x119)](0x6)+_0x1f2ed7(0xd5),_0x41e9bb[_0x1f2ed7(0xe0)]=null,_0x41e9bb[_0x1f2ed7(0x11e)]=null,console[_0x1f2ed7(0x114)]('💰\x20Removing\x20from\x20balance:\x20'+_0x5a0464['balance']+_0x1f2ed7(0xd6)+_0x42f33e[_0x1f2ed7(0x119)](0x6)+_0x1f2ed7(0x128)+_0x4d7b4d[_0x1f2ed7(0x119)](0x6)+_0x1f2ed7(0x152)));}}if(_0x5ebcf2[_0x1f2ed7(0x166)]()===_0x1f2ed7(0xc9)){const _0x3fe70b=_0x113f1b?.[_0x1f2ed7(0x13a)]||0x0;_0x3fe70b>0x0&&(_0x4d7b4d-=_0x3fe70b,_0x4e50c8+=_0x1f2ed7(0xf1)+_0x3fe70b[_0x1f2ed7(0x119)](0x6)+_0x1f2ed7(0x133),_0x41e9bb[_0x1f2ed7(0x13a)]=_0x3fe70b,console[_0x1f2ed7(0x114)](_0x1f2ed7(0x14f)+_0x3fe70b[_0x1f2ed7(0x119)](0x6)+'\x20USDT'),console[_0x1f2ed7(0x114)]('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x4d7b4d[_0x1f2ed7(0x119)](0x6)+_0x1f2ed7(0x152)));}const _0x2eed55=await _0x523c92[_0x1f2ed7(0xec)][_0x1f2ed7(0x14c)]({'where':{'id':_0x2bc6c6},'data':_0x41e9bb});_0x4d7b4d!==_0x5a0464[_0x1f2ed7(0x10b)]&&(await _0x523c92[_0x1f2ed7(0xf2)]['update']({'where':{'id':_0x5a0464['id']},'data':{'balance':_0x4d7b4d}}),console['log']('✅\x20Shop\x20'+_0x5a0464[_0x1f2ed7(0xf9)]+_0x1f2ed7(0xc8)+_0x5a0464['balance'][_0x1f2ed7(0x119)](0x6)+_0x1f2ed7(0x173)+_0x4d7b4d[_0x1f2ed7(0x119)](0x6)+'\x20USDT'),console[_0x1f2ed7(0x114)](_0x1f2ed7(0xd4)+_0x4e50c8)),await _0x523c92[_0x1f2ed7(0xe5)][_0x1f2ed7(0xd2)]({'data':{'paymentId':_0x2bc6c6,'shopId':_0x5a0464['id'],'event':_0x1f2ed7(0xfc)+_0x5ebcf2['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x1f2ed7(0x172)]({'oldStatus':_0x5b945e,'newStatus':_0x5ebcf2['toUpperCase'](),'balanceChange':_0x4e50c8||_0x1f2ed7(0xf0),'oldBalance':_0x5a0464[_0x1f2ed7(0x10b)],'newBalance':_0x4d7b4d,'amountUSDT':_0x41e9bb[_0x1f2ed7(0xe0)],'additionalData':_0x113f1b,'timestamp':new Date()['toISOString']()})}}),await this[_0x1f2ed7(0x104)]({..._0x40a569,..._0x2eed55,'shop':_0x5a0464},_0x5ebcf2[_0x1f2ed7(0x166)]()),await this['sendPaymentStatusNotification']({..._0x40a569,..._0x2eed55},_0x5ebcf2['toUpperCase']());});if(_0x5ebcf2[_0x496ea0(0x166)]()===_0x496ea0(0xd3)&&_0x5236f8!=='PAID')try{await this['paymentLinkService'][_0x496ea0(0x167)](_0x2bc6c6),console[_0x496ea0(0x114)](_0x496ea0(0x109)+_0x2bc6c6);}catch(_0x14298d){console[_0x496ea0(0x146)](_0x496ea0(0x17b)+_0x2bc6c6+':',_0x14298d);}}async[a57_0x4f4229(0x138)](_0x452048){const _0xf8daee=a57_0x4f4229;console[_0xf8daee(0x114)](_0xf8daee(0x13c),_0x452048);try{const _0x4abcf6=await this[_0xf8daee(0x168)][_0xf8daee(0x178)](_0x452048);if(!_0x4abcf6[_0xf8daee(0x154)])throw new Error(_0xf8daee(0x165));const _0x536d9b=await database_1[_0xf8daee(0xcf)]['payment'][_0xf8daee(0x108)]({'where':{'gatewayOrderId':_0x4abcf6[_0xf8daee(0x154)]}});if(!_0x536d9b){console['error'](_0xf8daee(0xd8)+_0x4abcf6[_0xf8daee(0x154)]);return;}console['log'](_0xf8daee(0xc6)+_0x536d9b['id']+_0xf8daee(0x10f)+_0x4abcf6[_0xf8daee(0x142)]),await this[_0xf8daee(0xfb)](_0x536d9b['id'],_0x4abcf6[_0xf8daee(0x142)],{'txUrls':_0x4abcf6[_0xf8daee(0x10e)]}),loggerService_1[_0xf8daee(0xff)][_0xf8daee(0x15f)]('plisio',_0x536d9b['id'],_0x536d9b[_0xf8daee(0x142)],_0x4abcf6[_0xf8daee(0x142)],_0x452048);}catch(_0x4b86b7){console['error'](_0xf8daee(0x112),_0x4b86b7),loggerService_1[_0xf8daee(0xff)]['logWebhookError'](_0xf8daee(0x10a),_0x4b86b7,_0x452048);throw _0x4b86b7;}}async[a57_0x4f4229(0x129)](_0x5e8e4f){const _0x239759=a57_0x4f4229;console[_0x239759(0x114)](_0x239759(0x162),_0x5e8e4f);try{const _0x4ae6ae=await this[_0x239759(0x168)][_0x239759(0x178)](_0x5e8e4f);if(!_0x4ae6ae[_0x239759(0x154)])throw new Error(_0x239759(0x137));const _0x4c2d7c=await database_1[_0x239759(0xcf)][_0x239759(0xec)][_0x239759(0x108)]({'where':{'gatewayOrderId':_0x4ae6ae[_0x239759(0x154)]}});if(!_0x4c2d7c){console[_0x239759(0x146)](_0x239759(0xf8)+_0x4ae6ae[_0x239759(0x154)]);return;}console['log']('📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20'+_0x4c2d7c['id']+_0x239759(0x10f)+_0x4ae6ae[_0x239759(0x142)]),await this['updatePaymentStatus'](_0x4c2d7c['id'],_0x4ae6ae['status'],{'txUrls':_0x4ae6ae[_0x239759(0x10e)]}),loggerService_1[_0x239759(0xff)][_0x239759(0x15f)](_0x239759(0x139),_0x4c2d7c['id'],_0x4c2d7c[_0x239759(0x142)],_0x4ae6ae['status'],_0x5e8e4f);}catch(_0x4c3cfe){console[_0x239759(0x146)]('Error\x20processing\x20Plisio\x20Gateway\x20webhook:',_0x4c3cfe),loggerService_1['loggerService']['logWebhookError'](_0x239759(0x139),_0x4c3cfe,_0x5e8e4f);throw _0x4c3cfe;}}async[a57_0x4f4229(0x163)](_0x494be9){const _0x465367=a57_0x4f4229;console[_0x465367(0x114)](_0x465367(0x169),_0x494be9);try{const _0x2794ae=await this[_0x465367(0xe3)][_0x465367(0x178)](_0x494be9);if(!_0x2794ae[_0x465367(0x154)])throw new Error(_0x465367(0x127));const _0x113187=await database_1[_0x465367(0xcf)][_0x465367(0xec)]['findFirst']({'where':{'gatewayOrderId':_0x2794ae[_0x465367(0x154)]}});if(!_0x113187){console[_0x465367(0x146)](_0x465367(0xfe)+_0x2794ae[_0x465367(0x154)]);return;}console['log'](_0x465367(0x124)+_0x113187['id']+_0x465367(0x10f)+_0x2794ae['status']),await this[_0x465367(0xfb)](_0x113187['id'],_0x2794ae[_0x465367(0x142)],{'failureMessage':_0x2794ae[_0x465367(0x164)],'cardLast4':_0x2794ae['additionalInfo']?.['cardLast4'],'paymentMethod':_0x2794ae[_0x465367(0x11d)]?.[_0x465367(0xf7)]}),loggerService_1[_0x465367(0xff)][_0x465367(0x15f)](_0x465367(0x12a),_0x113187['id'],_0x113187[_0x465367(0x142)],_0x2794ae[_0x465367(0x142)],_0x494be9);}catch(_0x510d8b){console[_0x465367(0x146)]('Error\x20processing\x20Rapyd\x20webhook:',_0x510d8b),loggerService_1[_0x465367(0xff)][_0x465367(0x171)]('rapyd',_0x510d8b,_0x494be9);throw _0x510d8b;}}async[a57_0x4f4229(0xce)](_0x426adb){const _0x52d5c8=a57_0x4f4229;console[_0x52d5c8(0x114)](_0x52d5c8(0x110),_0x426adb);try{const _0xf330b6=await this[_0x52d5c8(0x14b)][_0x52d5c8(0x178)](_0x426adb);if(!_0xf330b6[_0x52d5c8(0x154)])throw new Error(_0x52d5c8(0x16e));const _0x247937=await database_1[_0x52d5c8(0xcf)][_0x52d5c8(0xec)][_0x52d5c8(0x108)]({'where':{'gatewayOrderId':_0xf330b6[_0x52d5c8(0x154)]}});if(!_0x247937){console[_0x52d5c8(0x146)](_0x52d5c8(0x123)+_0xf330b6['paymentId']);return;}console[_0x52d5c8(0x114)](_0x52d5c8(0xfd)+_0x247937['id']+_0x52d5c8(0x10f)+_0xf330b6[_0x52d5c8(0x142)]),await this[_0x52d5c8(0xfb)](_0x247937['id'],_0xf330b6[_0x52d5c8(0x142)],{'bankId':_0xf330b6[_0x52d5c8(0x11d)]?.['bankId'],'remitterIban':_0xf330b6['additionalInfo']?.[_0x52d5c8(0x140)],'remitterName':_0xf330b6[_0x52d5c8(0x11d)]?.['remitterName']}),loggerService_1[_0x52d5c8(0xff)][_0x52d5c8(0x15f)](_0x52d5c8(0x135),_0x247937['id'],_0x247937[_0x52d5c8(0x142)],_0xf330b6['status'],_0x426adb);}catch(_0x300b77){console[_0x52d5c8(0x146)]('Error\x20processing\x20Noda\x20webhook:',_0x300b77),loggerService_1[_0x52d5c8(0xff)][_0x52d5c8(0x171)](_0x52d5c8(0x135),_0x300b77,_0x426adb);throw _0x300b77;}}async[a57_0x4f4229(0xdc)](_0x2a5457){const _0x4fddc6=a57_0x4f4229;console[_0x4fddc6(0x114)]('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x2a5457);try{const _0x1a72c6=await this[_0x4fddc6(0xe2)][_0x4fddc6(0x178)](_0x2a5457);if(!_0x1a72c6['paymentId'])throw new Error('No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook');const _0x3d3191=await database_1['default'][_0x4fddc6(0xec)][_0x4fddc6(0x108)]({'where':{'gatewayOrderId':_0x1a72c6[_0x4fddc6(0x154)]}});if(!_0x3d3191){console['error'](_0x4fddc6(0x103)+_0x1a72c6[_0x4fddc6(0x154)]);return;}console[_0x4fddc6(0x114)](_0x4fddc6(0x12d)+_0x3d3191['id']+_0x4fddc6(0x10f)+_0x1a72c6[_0x4fddc6(0x142)]),await this['updatePaymentStatus'](_0x3d3191['id'],_0x1a72c6['status']),loggerService_1[_0x4fddc6(0xff)]['logWebhookProcessed'](_0x4fddc6(0x145),_0x3d3191['id'],_0x3d3191[_0x4fddc6(0x142)],_0x1a72c6[_0x4fddc6(0x142)],_0x2a5457);}catch(_0x4972e3){console[_0x4fddc6(0x146)](_0x4fddc6(0x177),_0x4972e3),loggerService_1['loggerService']['logWebhookError'](_0x4fddc6(0x145),_0x4972e3,_0x2a5457);throw _0x4972e3;}}async[a57_0x4f4229(0x150)](_0x41179e){const _0x420654=a57_0x4f4229;console[_0x420654(0x114)](_0x420654(0xca),_0x41179e);try{const _0x2b710f=await this[_0x420654(0x156)][_0x420654(0x178)](_0x41179e);if(!_0x2b710f[_0x420654(0x154)])throw new Error(_0x420654(0xcc));const _0x47b5b8=await database_1[_0x420654(0xcf)][_0x420654(0xec)][_0x420654(0x108)]({'where':{'gatewayOrderId':_0x2b710f[_0x420654(0x154)]}});if(!_0x47b5b8){console[_0x420654(0x146)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x2b710f[_0x420654(0x154)]);return;}console[_0x420654(0x114)](_0x420654(0x149)+_0x47b5b8['id']+'\x20status\x20'+_0x2b710f[_0x420654(0x142)]),await this['updatePaymentStatus'](_0x47b5b8['id'],_0x2b710f[_0x420654(0x142)],{'paymentMethod':_0x2b710f[_0x420654(0x11d)]?.['payment_method']}),loggerService_1[_0x420654(0xff)][_0x420654(0x15f)](_0x420654(0x117),_0x47b5b8['id'],_0x47b5b8[_0x420654(0x142)],_0x2b710f['status'],_0x41179e);}catch(_0x3c3467){console[_0x420654(0x146)](_0x420654(0x147),_0x3c3467),loggerService_1[_0x420654(0xff)]['logWebhookError'](_0x420654(0x117),_0x3c3467,_0x41179e);throw _0x3c3467;}}async['processMasterCardWebhook'](_0x453c19){const _0x33e214=a57_0x4f4229;console['log']('🔄\x20Processing\x20MasterCard\x20webhook:',_0x453c19);try{const _0x2d3ae4=await this[_0x33e214(0x15b)]['processWebhook'](_0x453c19);if(!_0x2d3ae4[_0x33e214(0x154)])throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');const _0x163328=await database_1[_0x33e214(0xcf)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x2d3ae4[_0x33e214(0x154)]}});if(!_0x163328){console['error'](_0x33e214(0x170)+_0x2d3ae4[_0x33e214(0x154)]);return;}console[_0x33e214(0x114)]('📊\x20MasterCard\x20webhook:\x20Payment\x20'+_0x163328['id']+_0x33e214(0x10f)+_0x2d3ae4[_0x33e214(0x142)]),await this['updatePaymentStatus'](_0x163328['id'],_0x2d3ae4[_0x33e214(0x142)]),loggerService_1['loggerService'][_0x33e214(0x15f)]('mastercard',_0x163328['id'],_0x163328['status'],_0x2d3ae4['status'],_0x453c19);}catch(_0x68f624){console[_0x33e214(0x146)](_0x33e214(0x15d),_0x68f624),loggerService_1[_0x33e214(0xff)][_0x33e214(0x171)](_0x33e214(0x16b),_0x68f624,_0x453c19);throw _0x68f624;}}async[a57_0x4f4229(0x104)](_0x236108,_0x504ddb){const _0xe0e2a9=a57_0x4f4229,_0x4f2025=Date[_0xe0e2a9(0x11c)]();try{const _0xe0bacd=_0x236108[_0xe0e2a9(0xf2)],_0x4cef11=_0xe0bacd[_0xe0e2a9(0xcd)];if(!_0x4cef11?.[_0xe0e2a9(0x160)]){console['log'](_0xe0e2a9(0xe4)+_0xe0bacd['id']);return;}const _0x4d4db8=_0x504ddb==='PAID'?_0xe0e2a9(0x175):_0x504ddb===_0xe0e2a9(0xf4)?'payment.failed':_0x504ddb==='EXPIRED'?'payment.failed':_0x504ddb===_0xe0e2a9(0xc9)?_0xe0e2a9(0x14d):_0x504ddb===_0xe0e2a9(0x130)?_0xe0e2a9(0x14d):_0xe0e2a9(0xe8);let _0x2e4cbd=[];if(_0x4cef11['webhookEvents'])try{_0x2e4cbd=Array[_0xe0e2a9(0xd0)](_0x4cef11[_0xe0e2a9(0x17a)])?_0x4cef11['webhookEvents']:JSON[_0xe0e2a9(0x121)](_0x4cef11[_0xe0e2a9(0x17a)]);}catch(_0x5cf976){console[_0xe0e2a9(0x146)](_0xe0e2a9(0x16a),_0x5cf976),_0x2e4cbd=[];}if(!_0x2e4cbd[_0xe0e2a9(0x13d)](_0x4d4db8)){console['log'](_0xe0e2a9(0x151)+_0x4d4db8+_0xe0e2a9(0x106)+_0xe0bacd['id']);return;}const _0x32aea4={'event':_0x4d4db8,'payment':{'id':_0x236108['id'],'order_id':_0x236108[_0xe0e2a9(0x111)],'gateway_order_id':_0x236108[_0xe0e2a9(0x10d)],'gateway':_0x236108[_0xe0e2a9(0x155)],'amount':_0x236108['amount'],'currency':_0x236108[_0xe0e2a9(0xdd)],'status':_0x504ddb[_0xe0e2a9(0x116)](),'customer_email':_0x236108['customerEmail'],'customer_name':_0x236108[_0xe0e2a9(0x12f)],'failure_message':_0x236108[_0xe0e2a9(0x164)],'tx_urls':_0x236108['txUrls']?JSON[_0xe0e2a9(0x121)](_0x236108[_0xe0e2a9(0x10e)]):null,'created_at':_0x236108['createdAt'],'updated_at':_0x236108[_0xe0e2a9(0xef)]}},_0x56cd32=await fetch(_0x4cef11[_0xe0e2a9(0x160)],{'method':_0xe0e2a9(0xd7),'headers':{'Content-Type':_0xe0e2a9(0xe1),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0xe0e2a9(0x172)](_0x32aea4)}),_0x4175d3=Date[_0xe0e2a9(0x11c)]()-_0x4f2025,_0x3ad5e7=_0x56cd32['ok']?_0xe0e2a9(0x120):await _0x56cd32['text']();loggerService_1[_0xe0e2a9(0xff)][_0xe0e2a9(0xde)](_0x236108['shopId'],_0x4cef11[_0xe0e2a9(0x160)],_0x4d4db8,_0x56cd32[_0xe0e2a9(0x142)],_0x4175d3,_0x32aea4),console[_0xe0e2a9(0x114)](_0xe0e2a9(0x134)+_0x4cef11[_0xe0e2a9(0x160)]+_0xe0e2a9(0x12c)+_0x56cd32[_0xe0e2a9(0x142)]+'\x20('+_0x4175d3+'ms)');}catch(_0xa5b0c5){console[_0xe0e2a9(0x146)](_0xe0e2a9(0x122),_0xa5b0c5),loggerService_1[_0xe0e2a9(0xff)][_0xe0e2a9(0x13e)](_0x236108[_0xe0e2a9(0x126)],_0x236108[_0xe0e2a9(0xf2)]?.[_0xe0e2a9(0xcd)]?.[_0xe0e2a9(0x160)]||_0xe0e2a9(0x16f),_0xe0e2a9(0xf6),_0xa5b0c5,{});}}async['sendPaymentStatusNotification'](_0x569fdf,_0xa2e665){const _0x1b006f=a57_0x4f4229;try{const _0x5de319={'PENDING':_0x1b006f(0x105),'PROCESSING':_0x1b006f(0x132),'PAID':_0x1b006f(0x102),'FAILED':_0x1b006f(0x136),'EXPIRED':_0x1b006f(0xf3),'REFUND':_0x1b006f(0xcb),'CHARGEBACK':_0x1b006f(0x118)},_0x5632f8=_0x5de319[_0xa2e665];if(!_0x5632f8||_0x5632f8===_0x1b006f(0x105))return;await telegramBotService_1[_0x1b006f(0x158)][_0x1b006f(0x101)](_0x569fdf[_0x1b006f(0x126)],_0x569fdf,_0x5632f8);}catch(_0x298775){console[_0x1b006f(0x146)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x298775);}}}exports[a57_0x4f4229(0x143)]=WebhookService;