'use strict';const a57_0x8c702e=a57_0xc1bb;function a57_0x4885(){const _0x1fe4e6=['default','\x20USDT\x20(payment\x20no\x20longer\x20PAID)','🏪\x20Shop\x20','No\x20payment\x20ID\x20in\x20Plisio\x20webhook','No\x20payment\x20ID\x20in\x20CoinToPay\x20webhook','settings','\x20USDT\x20(payment\x20became\x20PAID)','rapyd','toUpperCase','failureMessage','application/json','\x20USDT','shop','convertToUSDT','sendPaymentNotification','masterCardService','🔄\x20Processing\x20Plisio\x20Gateway\x20webhook:','📊\x20Rapyd\x20webhook:\x20Payment\x20','logWebhookProcessed','failed','error','noda','telegramBotService','Error\x20processing\x20Plisio\x20Gateway\x20webhook:','Error\x20parsing\x20webhook\x20events:','paymentMethod','Failed\x20to\x20send\x20shop\x20webhook:','Error\x20processing\x20Plisio\x20webhook:','No\x20payment\x20ID\x20in\x20Plisio\x20Gateway\x20webhook','No\x20payment\x20ID\x20in\x20KLYME\x20webhook','refund','payment_method','./telegramBotService','webhook_status_change_','KlymeService','update','4090482vhGDqt','loggerService','🔄\x20Processing\x20MasterCard\x20webhook:','\x20status\x20','Payment\x20','defineProperty','NodaService','payment.pending','🔄\x20Processing\x20Plisio\x20webhook:','\x20and\x20-','logWebhookError','logShopWebhookError','customerEmail','10WAAqUT','sendPaymentStatusNotification','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','📝\x20Reason:\x20','No\x20payment\x20ID\x20in\x20Noda\x20webhook','payment.failed','📊\x20CoinToPay\x20webhook:\x20Payment\x20','\x20-\x20','📤\x20Shop\x20webhook\x20sent\x20to\x20','99671KOfgDn','393812wQbGDS','💸\x20Additional\x20chargeback\x20penalty:\x20-','TesSoft\x20Payment\x20System/1.0','38292pdJZwi','PaymentLinkService','remitterName','webhookUrl','klyme','balance','💰\x20Converting\x20','findUnique','\x20not\x20found','createdAt','10176184PFjaPk','processPlisioGatewayWebhook','\x20+\x20','cardLast4','payment.success','currencyService','Payment\x20not\x20found\x20for\x20Noda\x20webhook:\x20','updatedAt','payment','webhookLog','unknown','\x20->\x20','handleSuccessfulPayment','now','mastercard','chargebackAmount','FAILED','processPlisioWebhook','amountUSDT','📊\x20Plisio\x20Gateway\x20webhook:\x20Payment\x20','924366qRLlho','Error\x20processing\x20MasterCard\x20webhook:','47jzZwHk','./paymentLinkService','../config/database','__esModule','paymentId','txUrls','✅\x20Shop\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20','./loggerService','expired','nodaService','parse','\x20not\x20enabled\x20for\x20shop\x20','includes','status','🔄\x20Processing\x20Rapyd\x20webhook:','paid','no\x20balance\x20change','stringify','ms)','Payment\x20not\x20found\x20for\x20Plisio\x20Gateway\x20webhook:\x20','PAID','./gateways/rapydService','log','processNodaWebhook','7412251YtQNPg','sendShopWebhook','REFUND','📊\x20KLYME\x20webhook:\x20Payment\x20','created','amount','create','paymentLinkService','EXPIRED','text','username','webhookEvents','🔄\x20Updating\x20payment\x20','findFirst','__importDefault','shopId','cointopay','updatePaymentStatus','additionalInfo','39uDKXVi','processing','bankId','toISOString','processCoinToPayWebhook','POST','rapydService','toFixed','💰\x20Payment\x20','chargeback','📊\x20Plisio\x20webhook:\x20Payment\x20','processKlymeWebhook','CHARGEBACK','plisioService','coinToPayService','No\x20payment\x20ID\x20in\x20Rapyd\x20webhook','remitterIban','\x20USDT\x20(chargeback\x20penalty)','\x20=\x20','currency','toLowerCase','webhook_send','🔄\x20Processing\x20Noda\x20webhook:','Payment\x20not\x20found\x20for\x20Plisio\x20webhook:\x20','📊\x20MasterCard\x20webhook:\x20Payment\x20','\x20with\x20status\x20','PlisioService','📈\x20Payment\x20link\x20counter\x20updated\x20for\x20payment\x20','Payment\x20not\x20found\x20for\x20Rapyd\x20webhook:\x20','processWebhook','2150RmzWzS','plisio_gateway','\x20balance\x20updated:\x20','\x20status\x20to\x20','system','logShopWebhookSent','🔄\x20Processing\x20KLYME\x20webhook:','Success','./gateways/mastercardService','Error\x20processing\x20Rapyd\x20webhook:'];a57_0x4885=function(){return _0x1fe4e6;};return a57_0x4885();}(function(_0x2dafb3,_0x1f3144){const _0x2e4ba6=a57_0xc1bb,_0x3e33c7=_0x2dafb3();while(!![]){try{const _0xb29b5d=-parseInt(_0x2e4ba6(0x14c))/0x1*(parseInt(_0x2e4ba6(0x12c))/0x2)+parseInt(_0x2e4ba6(0x178))/0x3*(parseInt(_0x2e4ba6(0x129))/0x4)+-parseInt(_0x2e4ba6(0x11f))/0x5*(-parseInt(_0x2e4ba6(0x14a))/0x6)+-parseInt(_0x2e4ba6(0x165))/0x7+-parseInt(_0x2e4ba6(0x136))/0x8+parseInt(_0x2e4ba6(0x1c4))/0x9+-parseInt(_0x2e4ba6(0x196))/0xa*(-parseInt(_0x2e4ba6(0x128))/0xb);if(_0xb29b5d===_0x1f3144)break;else _0x3e33c7['push'](_0x3e33c7['shift']());}catch(_0x70ed2d){_0x3e33c7['push'](_0x3e33c7['shift']());}}}(a57_0x4885,0xb9826));function a57_0xc1bb(_0x1eb059,_0x30d225){const _0x488517=a57_0x4885();return a57_0xc1bb=function(_0xc1bb2b,_0x3cac7e){_0xc1bb2b=_0xc1bb2b-0x119;let _0x5beb4b=_0x488517[_0xc1bb2b];return _0x5beb4b;},a57_0xc1bb(_0x1eb059,_0x30d225);}var __importDefault=this&&this[a57_0x8c702e(0x173)]||function(_0x44a3ae){const _0x4b5e1e=a57_0x8c702e;return _0x44a3ae&&_0x44a3ae[_0x4b5e1e(0x14f)]?_0x44a3ae:{'default':_0x44a3ae};};Object[a57_0x8c702e(0x1c9)](exports,a57_0x8c702e(0x14f),{'value':!![]}),exports['WebhookService']=void 0x0;const database_1=__importDefault(require(a57_0x8c702e(0x14e))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a57_0x8c702e(0x162)),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require('./gateways/klymeService'),mastercardService_1=require(a57_0x8c702e(0x19e)),paymentLinkService_1=require(a57_0x8c702e(0x14d)),telegramBotService_1=require(a57_0x8c702e(0x1c0)),currencyService_1=require('./currencyService'),loggerService_1=require(a57_0x8c702e(0x154));class WebhookService{constructor(){const _0x2485de=a57_0x8c702e;this[_0x2485de(0x185)]=new plisioService_1[(_0x2485de(0x192))](),this[_0x2485de(0x17e)]=new rapydService_1['RapydService'](),this[_0x2485de(0x156)]=new nodaService_1[(_0x2485de(0x1ca))](),this[_0x2485de(0x186)]=new coinToPayService_1['CoinToPayService'](),this['klymeService']=new klymeService_1[(_0x2485de(0x1c2))](),this[_0x2485de(0x1af)]=new mastercardService_1['MasterCardService'](),this[_0x2485de(0x16c)]=new paymentLinkService_1[(_0x2485de(0x12d))]();}async['updatePaymentStatus'](_0x209b2e,_0x293dcb,_0x54fd7e){const _0x41d720=a57_0x8c702e;console[_0x41d720(0x163)](_0x41d720(0x171)+_0x209b2e+_0x41d720(0x199)+_0x293dcb);const _0x3dd889=await database_1[_0x41d720(0x1a0)]['payment']['findUnique']({'where':{'id':_0x209b2e},'select':{'status':!![],'paymentLinkId':!![]}});if(!_0x3dd889)throw new Error(_0x41d720(0x1c8)+_0x209b2e+_0x41d720(0x134));const _0x5c5b36=_0x3dd889[_0x41d720(0x15a)];await database_1[_0x41d720(0x1a0)]['$transaction'](async _0x220a7b=>{const _0x25e441=_0x41d720,_0x42df5c=await _0x220a7b[_0x25e441(0x13e)][_0x25e441(0x133)]({'where':{'id':_0x209b2e},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x42df5c)throw new Error(_0x25e441(0x1c8)+_0x209b2e+_0x25e441(0x134));const _0x493af6=_0x42df5c[_0x25e441(0x15a)],_0x413685=_0x42df5c['shop'];console[_0x25e441(0x163)](_0x25e441(0x180)+_0x209b2e+':\x20'+_0x493af6+_0x25e441(0x141)+_0x293dcb),console[_0x25e441(0x163)](_0x25e441(0x1a2)+_0x413685[_0x25e441(0x16f)]+'\x20current\x20balance:\x20'+_0x413685[_0x25e441(0x131)]+_0x25e441(0x1ab));const _0x57b269={'status':_0x293dcb[_0x25e441(0x1a8)](),'updatedAt':new Date(),'statusChangedBy':_0x25e441(0x19a),'statusChangedAt':new Date()};_0x54fd7e?.[_0x25e441(0x1a9)]&&(_0x57b269[_0x25e441(0x1a9)]=_0x54fd7e['failureMessage']);_0x54fd7e?.['txUrls']&&(_0x57b269['txUrls']=JSON['stringify'](_0x54fd7e[_0x25e441(0x151)]));_0x54fd7e?.[_0x25e441(0x139)]&&(_0x57b269[_0x25e441(0x139)]=_0x54fd7e[_0x25e441(0x139)]);_0x54fd7e?.[_0x25e441(0x1b9)]&&(_0x57b269[_0x25e441(0x1b9)]=_0x54fd7e[_0x25e441(0x1b9)]);_0x54fd7e?.[_0x25e441(0x17a)]&&(_0x57b269['bankId']=_0x54fd7e[_0x25e441(0x17a)]);_0x54fd7e?.[_0x25e441(0x188)]&&(_0x57b269[_0x25e441(0x188)]=_0x54fd7e['remitterIban']);_0x54fd7e?.[_0x25e441(0x12e)]&&(_0x57b269['remitterName']=_0x54fd7e[_0x25e441(0x12e)]);let _0x158e6e=_0x413685[_0x25e441(0x131)],_0x21f1de='';if(_0x293dcb[_0x25e441(0x1a8)]()===_0x25e441(0x161)&&_0x493af6!==_0x25e441(0x161)){const _0x2792c3=await currencyService_1[_0x25e441(0x13b)][_0x25e441(0x1ad)](_0x42df5c[_0x25e441(0x16a)],_0x42df5c[_0x25e441(0x18b)]);_0x158e6e+=_0x2792c3,_0x21f1de='+'+_0x2792c3['toFixed'](0x6)+_0x25e441(0x1a6),_0x57b269[_0x25e441(0x148)]=_0x2792c3,_0x57b269['paidAt']=new Date(),console['log'](_0x25e441(0x132)+_0x42df5c['amount']+'\x20'+_0x42df5c['currency']+_0x25e441(0x141)+_0x2792c3[_0x25e441(0x17f)](0x6)+_0x25e441(0x1ab)),console[_0x25e441(0x163)]('💰\x20Adding\x20to\x20balance:\x20'+_0x413685[_0x25e441(0x131)]+_0x25e441(0x138)+_0x2792c3[_0x25e441(0x17f)](0x6)+_0x25e441(0x18a)+_0x158e6e[_0x25e441(0x17f)](0x6)+_0x25e441(0x1ab));}else{if(_0x493af6===_0x25e441(0x161)&&_0x293dcb['toUpperCase']()!==_0x25e441(0x161)){const _0x244734=_0x42df5c['amountUSDT'];_0x244734&&(_0x158e6e-=_0x244734,_0x21f1de='-'+_0x244734[_0x25e441(0x17f)](0x6)+_0x25e441(0x1a1),_0x57b269['amountUSDT']=null,_0x57b269['paidAt']=null,console['log']('💰\x20Removing\x20from\x20balance:\x20'+_0x413685[_0x25e441(0x131)]+_0x25e441(0x126)+_0x244734['toFixed'](0x6)+'\x20=\x20'+_0x158e6e[_0x25e441(0x17f)](0x6)+'\x20USDT'));}}if(_0x293dcb[_0x25e441(0x1a8)]()===_0x25e441(0x184)){const _0x274bd4=_0x54fd7e?.[_0x25e441(0x145)]||0x0;_0x274bd4>0x0&&(_0x158e6e-=_0x274bd4,_0x21f1de+=_0x25e441(0x11b)+_0x274bd4[_0x25e441(0x17f)](0x6)+_0x25e441(0x189),_0x57b269[_0x25e441(0x145)]=_0x274bd4,console[_0x25e441(0x163)](_0x25e441(0x12a)+_0x274bd4[_0x25e441(0x17f)](0x6)+_0x25e441(0x1ab)),console['log']('💰\x20Final\x20balance\x20after\x20chargeback:\x20'+_0x158e6e['toFixed'](0x6)+'\x20USDT'));}const _0x267f7a=await _0x220a7b[_0x25e441(0x13e)][_0x25e441(0x1c3)]({'where':{'id':_0x209b2e},'data':_0x57b269});_0x158e6e!==_0x413685[_0x25e441(0x131)]&&(await _0x220a7b['shop'][_0x25e441(0x1c3)]({'where':{'id':_0x413685['id']},'data':{'balance':_0x158e6e}}),console['log'](_0x25e441(0x152)+_0x413685[_0x25e441(0x16f)]+_0x25e441(0x198)+_0x413685[_0x25e441(0x131)]['toFixed'](0x6)+_0x25e441(0x141)+_0x158e6e[_0x25e441(0x17f)](0x6)+_0x25e441(0x1ab)),console[_0x25e441(0x163)](_0x25e441(0x122)+_0x21f1de)),await _0x220a7b[_0x25e441(0x13f)][_0x25e441(0x16b)]({'data':{'paymentId':_0x209b2e,'shopId':_0x413685['id'],'event':_0x25e441(0x1c1)+_0x293dcb[_0x25e441(0x18c)](),'statusCode':0xc8,'responseBody':JSON[_0x25e441(0x15e)]({'oldStatus':_0x493af6,'newStatus':_0x293dcb[_0x25e441(0x1a8)](),'balanceChange':_0x21f1de||_0x25e441(0x15d),'oldBalance':_0x413685['balance'],'newBalance':_0x158e6e,'amountUSDT':_0x57b269[_0x25e441(0x148)],'additionalData':_0x54fd7e,'timestamp':new Date()[_0x25e441(0x17b)]()})}}),await this[_0x25e441(0x166)]({..._0x42df5c,..._0x267f7a,'shop':_0x413685},_0x293dcb['toUpperCase']()),await this[_0x25e441(0x120)]({..._0x42df5c,..._0x267f7a},_0x293dcb[_0x25e441(0x1a8)]());});if(_0x293dcb[_0x41d720(0x1a8)]()===_0x41d720(0x161)&&_0x5c5b36!==_0x41d720(0x161))try{await this[_0x41d720(0x16c)][_0x41d720(0x142)](_0x209b2e),console[_0x41d720(0x163)](_0x41d720(0x193)+_0x209b2e);}catch(_0x5a56db){console[_0x41d720(0x1b4)](_0x41d720(0x153)+_0x209b2e+':',_0x5a56db);}}async[a57_0x8c702e(0x147)](_0x6beb7f){const _0x398126=a57_0x8c702e;console['log'](_0x398126(0x11a),_0x6beb7f);try{const _0x4be405=await this[_0x398126(0x185)][_0x398126(0x195)](_0x6beb7f);if(!_0x4be405[_0x398126(0x150)])throw new Error(_0x398126(0x1a3));const _0x1d5ccd=await database_1[_0x398126(0x1a0)][_0x398126(0x13e)]['findFirst']({'where':{'gatewayOrderId':_0x4be405[_0x398126(0x150)]}});if(!_0x1d5ccd){console[_0x398126(0x1b4)](_0x398126(0x18f)+_0x4be405['paymentId']);return;}console[_0x398126(0x163)](_0x398126(0x182)+_0x1d5ccd['id']+_0x398126(0x1c7)+_0x4be405[_0x398126(0x15a)]),await this[_0x398126(0x176)](_0x1d5ccd['id'],_0x4be405[_0x398126(0x15a)],{'txUrls':_0x4be405['txUrls']}),loggerService_1[_0x398126(0x1c5)][_0x398126(0x1b2)]('plisio',_0x1d5ccd['id'],_0x1d5ccd[_0x398126(0x15a)],_0x4be405[_0x398126(0x15a)],_0x6beb7f);}catch(_0x125a79){console['error'](_0x398126(0x1bb),_0x125a79),loggerService_1[_0x398126(0x1c5)]['logWebhookError']('plisio',_0x125a79,_0x6beb7f);throw _0x125a79;}}async[a57_0x8c702e(0x137)](_0x38c01e){const _0x400268=a57_0x8c702e;console[_0x400268(0x163)](_0x400268(0x1b0),_0x38c01e);try{const _0x30422e=await this['plisioService'][_0x400268(0x195)](_0x38c01e);if(!_0x30422e[_0x400268(0x150)])throw new Error(_0x400268(0x1bc));const _0x186fd1=await database_1[_0x400268(0x1a0)][_0x400268(0x13e)][_0x400268(0x172)]({'where':{'gatewayOrderId':_0x30422e[_0x400268(0x150)]}});if(!_0x186fd1){console[_0x400268(0x1b4)](_0x400268(0x160)+_0x30422e[_0x400268(0x150)]);return;}console[_0x400268(0x163)](_0x400268(0x149)+_0x186fd1['id']+_0x400268(0x1c7)+_0x30422e[_0x400268(0x15a)]),await this[_0x400268(0x176)](_0x186fd1['id'],_0x30422e[_0x400268(0x15a)],{'txUrls':_0x30422e[_0x400268(0x151)]}),loggerService_1[_0x400268(0x1c5)][_0x400268(0x1b2)]('plisio_gateway',_0x186fd1['id'],_0x186fd1[_0x400268(0x15a)],_0x30422e[_0x400268(0x15a)],_0x38c01e);}catch(_0x5bed14){console[_0x400268(0x1b4)](_0x400268(0x1b7),_0x5bed14),loggerService_1[_0x400268(0x1c5)][_0x400268(0x11c)](_0x400268(0x197),_0x5bed14,_0x38c01e);throw _0x5bed14;}}async['processRapydWebhook'](_0x451180){const _0x4f6b62=a57_0x8c702e;console[_0x4f6b62(0x163)](_0x4f6b62(0x15b),_0x451180);try{const _0x50eadc=await this[_0x4f6b62(0x17e)]['processWebhook'](_0x451180);if(!_0x50eadc[_0x4f6b62(0x150)])throw new Error(_0x4f6b62(0x187));const _0x2e5ca9=await database_1[_0x4f6b62(0x1a0)][_0x4f6b62(0x13e)][_0x4f6b62(0x172)]({'where':{'gatewayOrderId':_0x50eadc[_0x4f6b62(0x150)]}});if(!_0x2e5ca9){console['error'](_0x4f6b62(0x194)+_0x50eadc['paymentId']);return;}console[_0x4f6b62(0x163)](_0x4f6b62(0x1b1)+_0x2e5ca9['id']+'\x20status\x20'+_0x50eadc['status']),await this['updatePaymentStatus'](_0x2e5ca9['id'],_0x50eadc[_0x4f6b62(0x15a)],{'failureMessage':_0x50eadc[_0x4f6b62(0x1a9)],'cardLast4':_0x50eadc['additionalInfo']?.['cardLast4'],'paymentMethod':_0x50eadc[_0x4f6b62(0x177)]?.['paymentMethod']}),loggerService_1[_0x4f6b62(0x1c5)]['logWebhookProcessed'](_0x4f6b62(0x1a7),_0x2e5ca9['id'],_0x2e5ca9[_0x4f6b62(0x15a)],_0x50eadc[_0x4f6b62(0x15a)],_0x451180);}catch(_0x2cbdeb){console[_0x4f6b62(0x1b4)](_0x4f6b62(0x19f),_0x2cbdeb),loggerService_1[_0x4f6b62(0x1c5)][_0x4f6b62(0x11c)](_0x4f6b62(0x1a7),_0x2cbdeb,_0x451180);throw _0x2cbdeb;}}async[a57_0x8c702e(0x164)](_0x5636e2){const _0x1936b6=a57_0x8c702e;console[_0x1936b6(0x163)](_0x1936b6(0x18e),_0x5636e2);try{const _0x1108fb=await this['nodaService'][_0x1936b6(0x195)](_0x5636e2);if(!_0x1108fb[_0x1936b6(0x150)])throw new Error(_0x1936b6(0x123));const _0x183e33=await database_1[_0x1936b6(0x1a0)][_0x1936b6(0x13e)][_0x1936b6(0x172)]({'where':{'gatewayOrderId':_0x1108fb[_0x1936b6(0x150)]}});if(!_0x183e33){console[_0x1936b6(0x1b4)](_0x1936b6(0x13c)+_0x1108fb[_0x1936b6(0x150)]);return;}console[_0x1936b6(0x163)]('📊\x20Noda\x20webhook:\x20Payment\x20'+_0x183e33['id']+_0x1936b6(0x1c7)+_0x1108fb[_0x1936b6(0x15a)]),await this[_0x1936b6(0x176)](_0x183e33['id'],_0x1108fb['status'],{'bankId':_0x1108fb[_0x1936b6(0x177)]?.[_0x1936b6(0x17a)],'remitterIban':_0x1108fb[_0x1936b6(0x177)]?.[_0x1936b6(0x188)],'remitterName':_0x1108fb[_0x1936b6(0x177)]?.[_0x1936b6(0x12e)]}),loggerService_1[_0x1936b6(0x1c5)][_0x1936b6(0x1b2)](_0x1936b6(0x1b5),_0x183e33['id'],_0x183e33[_0x1936b6(0x15a)],_0x1108fb['status'],_0x5636e2);}catch(_0x5849ce){console[_0x1936b6(0x1b4)]('Error\x20processing\x20Noda\x20webhook:',_0x5849ce),loggerService_1[_0x1936b6(0x1c5)][_0x1936b6(0x11c)](_0x1936b6(0x1b5),_0x5849ce,_0x5636e2);throw _0x5849ce;}}async[a57_0x8c702e(0x17c)](_0x419b2e){const _0x5b4e08=a57_0x8c702e;console['log']('🔄\x20Processing\x20CoinToPay\x20webhook:',_0x419b2e);try{const _0x36c2ea=await this[_0x5b4e08(0x186)]['processWebhook'](_0x419b2e);if(!_0x36c2ea['paymentId'])throw new Error(_0x5b4e08(0x1a4));const _0x3f6279=await database_1[_0x5b4e08(0x1a0)][_0x5b4e08(0x13e)][_0x5b4e08(0x172)]({'where':{'gatewayOrderId':_0x36c2ea[_0x5b4e08(0x150)]}});if(!_0x3f6279){console[_0x5b4e08(0x1b4)]('Payment\x20not\x20found\x20for\x20CoinToPay\x20webhook:\x20'+_0x36c2ea[_0x5b4e08(0x150)]);return;}console[_0x5b4e08(0x163)](_0x5b4e08(0x125)+_0x3f6279['id']+'\x20status\x20'+_0x36c2ea[_0x5b4e08(0x15a)]),await this[_0x5b4e08(0x176)](_0x3f6279['id'],_0x36c2ea['status']),loggerService_1['loggerService']['logWebhookProcessed'](_0x5b4e08(0x175),_0x3f6279['id'],_0x3f6279[_0x5b4e08(0x15a)],_0x36c2ea[_0x5b4e08(0x15a)],_0x419b2e);}catch(_0x423653){console[_0x5b4e08(0x1b4)]('Error\x20processing\x20CoinToPay\x20webhook:',_0x423653),loggerService_1[_0x5b4e08(0x1c5)][_0x5b4e08(0x11c)](_0x5b4e08(0x175),_0x423653,_0x419b2e);throw _0x423653;}}async[a57_0x8c702e(0x183)](_0x5a665f){const _0x339f24=a57_0x8c702e;console[_0x339f24(0x163)](_0x339f24(0x19c),_0x5a665f);try{const _0x44db4a=await this['klymeService'][_0x339f24(0x195)](_0x5a665f);if(!_0x44db4a[_0x339f24(0x150)])throw new Error(_0x339f24(0x1bd));const _0x1072eb=await database_1[_0x339f24(0x1a0)]['payment']['findFirst']({'where':{'gatewayOrderId':_0x44db4a['paymentId']}});if(!_0x1072eb){console[_0x339f24(0x1b4)]('Payment\x20not\x20found\x20for\x20KLYME\x20webhook:\x20'+_0x44db4a[_0x339f24(0x150)]);return;}console['log'](_0x339f24(0x168)+_0x1072eb['id']+_0x339f24(0x1c7)+_0x44db4a[_0x339f24(0x15a)]),await this[_0x339f24(0x176)](_0x1072eb['id'],_0x44db4a['status'],{'paymentMethod':_0x44db4a[_0x339f24(0x177)]?.[_0x339f24(0x1bf)]}),loggerService_1[_0x339f24(0x1c5)][_0x339f24(0x1b2)](_0x339f24(0x130),_0x1072eb['id'],_0x1072eb[_0x339f24(0x15a)],_0x44db4a[_0x339f24(0x15a)],_0x5a665f);}catch(_0x5ee9bb){console[_0x339f24(0x1b4)]('Error\x20processing\x20KLYME\x20webhook:',_0x5ee9bb),loggerService_1[_0x339f24(0x1c5)][_0x339f24(0x11c)](_0x339f24(0x130),_0x5ee9bb,_0x5a665f);throw _0x5ee9bb;}}async['processMasterCardWebhook'](_0x4d6c13){const _0x3ee389=a57_0x8c702e;console['log'](_0x3ee389(0x1c6),_0x4d6c13);try{const _0x521dc6=await this[_0x3ee389(0x1af)][_0x3ee389(0x195)](_0x4d6c13);if(!_0x521dc6[_0x3ee389(0x150)])throw new Error('No\x20payment\x20ID\x20in\x20MasterCard\x20webhook');const _0x1cd814=await database_1['default'][_0x3ee389(0x13e)]['findFirst']({'where':{'gatewayOrderId':_0x521dc6[_0x3ee389(0x150)]}});if(!_0x1cd814){console['error']('Payment\x20not\x20found\x20for\x20MasterCard\x20webhook:\x20'+_0x521dc6[_0x3ee389(0x150)]);return;}console[_0x3ee389(0x163)](_0x3ee389(0x190)+_0x1cd814['id']+_0x3ee389(0x1c7)+_0x521dc6['status']),await this['updatePaymentStatus'](_0x1cd814['id'],_0x521dc6['status']),loggerService_1[_0x3ee389(0x1c5)][_0x3ee389(0x1b2)](_0x3ee389(0x144),_0x1cd814['id'],_0x1cd814['status'],_0x521dc6[_0x3ee389(0x15a)],_0x4d6c13);}catch(_0x42e535){console[_0x3ee389(0x1b4)](_0x3ee389(0x14b),_0x42e535),loggerService_1[_0x3ee389(0x1c5)][_0x3ee389(0x11c)](_0x3ee389(0x144),_0x42e535,_0x4d6c13);throw _0x42e535;}}async[a57_0x8c702e(0x166)](_0x423764,_0x488c22){const _0x23201e=a57_0x8c702e,_0x1c502f=Date[_0x23201e(0x143)]();try{const _0x29e6b7=_0x423764[_0x23201e(0x1ac)],_0x5deb45=_0x29e6b7[_0x23201e(0x1a5)];if(!_0x5deb45?.['webhookUrl']){console[_0x23201e(0x163)](_0x23201e(0x121)+_0x29e6b7['id']);return;}const _0x3eb809=_0x488c22===_0x23201e(0x161)?_0x23201e(0x13a):_0x488c22===_0x23201e(0x146)?_0x23201e(0x124):_0x488c22===_0x23201e(0x16d)?_0x23201e(0x124):_0x488c22===_0x23201e(0x184)?_0x23201e(0x124):_0x488c22===_0x23201e(0x167)?_0x23201e(0x124):_0x23201e(0x119);let _0xe2c272=[];if(_0x5deb45[_0x23201e(0x170)])try{_0xe2c272=Array['isArray'](_0x5deb45[_0x23201e(0x170)])?_0x5deb45[_0x23201e(0x170)]:JSON[_0x23201e(0x157)](_0x5deb45['webhookEvents']);}catch(_0x49c09e){console['error'](_0x23201e(0x1b8),_0x49c09e),_0xe2c272=[];}if(!_0xe2c272[_0x23201e(0x159)](_0x3eb809)){console['log']('Webhook\x20event\x20'+_0x3eb809+_0x23201e(0x158)+_0x29e6b7['id']);return;}const _0x49b800={'event':_0x3eb809,'payment':{'id':_0x423764['id'],'order_id':_0x423764['orderId'],'amount':_0x423764[_0x23201e(0x16a)],'currency':_0x423764[_0x23201e(0x18b)],'status':_0x488c22['toLowerCase'](),'customer_email':_0x423764[_0x23201e(0x11e)],'customer_name':_0x423764['customerName'],'created_at':_0x423764[_0x23201e(0x135)],'updated_at':_0x423764[_0x23201e(0x13d)]}},_0x3d1b97=await fetch(_0x5deb45[_0x23201e(0x12f)],{'method':_0x23201e(0x17d),'headers':{'Content-Type':_0x23201e(0x1aa),'User-Agent':_0x23201e(0x12b)},'body':JSON[_0x23201e(0x15e)](_0x49b800)}),_0x3ea66b=Date[_0x23201e(0x143)]()-_0x1c502f,_0x385c31=_0x3d1b97['ok']?_0x23201e(0x19d):await _0x3d1b97[_0x23201e(0x16e)]();loggerService_1[_0x23201e(0x1c5)][_0x23201e(0x19b)](_0x423764[_0x23201e(0x174)],_0x5deb45[_0x23201e(0x12f)],_0x3eb809,_0x3d1b97[_0x23201e(0x15a)],_0x3ea66b,_0x49b800),console[_0x23201e(0x163)](_0x23201e(0x127)+_0x5deb45['webhookUrl']+_0x23201e(0x191)+_0x3d1b97[_0x23201e(0x15a)]+'\x20('+_0x3ea66b+_0x23201e(0x15f));}catch(_0x3d7d0b){console[_0x23201e(0x1b4)](_0x23201e(0x1ba),_0x3d7d0b),loggerService_1[_0x23201e(0x1c5)][_0x23201e(0x11d)](_0x423764['shopId'],_0x423764[_0x23201e(0x1ac)]?.[_0x23201e(0x1a5)]?.[_0x23201e(0x12f)]||_0x23201e(0x140),_0x23201e(0x18d),_0x3d7d0b,{});}}async['sendPaymentStatusNotification'](_0x3c5afc,_0x250cff){const _0x24dcde=a57_0x8c702e;try{const _0x55486c={'PENDING':_0x24dcde(0x169),'PROCESSING':_0x24dcde(0x179),'PAID':_0x24dcde(0x15c),'FAILED':_0x24dcde(0x1b3),'EXPIRED':_0x24dcde(0x155),'REFUND':_0x24dcde(0x1be),'CHARGEBACK':_0x24dcde(0x181)},_0x4644ad=_0x55486c[_0x250cff];if(!_0x4644ad||_0x4644ad===_0x24dcde(0x169))return;await telegramBotService_1[_0x24dcde(0x1b6)][_0x24dcde(0x1ae)](_0x3c5afc['shopId'],_0x3c5afc,_0x4644ad);}catch(_0x3c67fe){console[_0x24dcde(0x1b4)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x3c67fe);}}}exports['WebhookService']=WebhookService;