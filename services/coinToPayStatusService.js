'use strict';const a37_0x269d5f=a37_0x264c;function a37_0x264c(_0x484e8d,_0x5b8982){const _0x11610a=a37_0x1161();return a37_0x264c=function(_0x264c2a,_0x2e44d3){_0x264c2a=_0x264c2a-0x12e;let _0x1a3d72=_0x11610a[_0x264c2a];return _0x1a3d72;},a37_0x264c(_0x484e8d,_0x5b8982);}function a37_0x1161(){const _0x3593dd=['‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','customerName','./loggerService','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','checkAllPendingPayments','\x20(after\x20','paidAt','loggerService','1343855eSgikC','payment.success','\x20to\x20clear','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','gatewayPaymentId','\x20individual\x20payment\x20timers','timers','payment.failed','Automatically\x20expired\x20after\x20','toLowerCase','\x20\x20\x20-\x20Amount:\x20','\x20\x20\x20üìù\x20Details:','iban','cointopay_status_check_error','default','\x20->\x20','\x20\x20\x20üìù\x20Context:','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','webhookUrl','COINTOPAY_ERROR','\x20days,\x20marking\x20as\x20EXPIRED','\x20\x20\x20-\x20ShopId:\x20','paid','shop','adminNotes','webhookLog','has','\x20to\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','webhook_send','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','gateway','Unknown\x20error','2\x20minutes','checkSinglePaymentById','\x20\x20\x20-\x20Status:\x20','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','h),\x20skipping\x20global\x20check','\x20expired\x20CoinToPay\x20payments','FAILED','size','\x20status\x20from\x20','CoinToPayService','\x20not\x20found\x20in\x20database','stopPeriodicStatusCheck','schedulePaymentChecks','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','__importDefault','update','not\x20confirmed','ü™ô\x20[GLOBAL]\x20Found\x20','\x20skipped,\x20','Failed\x20to\x20send\x20shop\x20webhook:','floor','‚úÖ\x20[HOURLY]\x20Payment\x20','create','coinToPayService','sendPaymentNotification','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20found:','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','paymentDetails','\x20is\x20older\x20than\x20','get','ms)','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','‚ùå\x20[HOURLY]\x20Payment\x20','üõë\x20[SHUTDOWN]\x20Cleared\x20','\x20pending\x20CoinToPay\x20payments','checkExpiredPayments','unknown','\x20for\x20payment\x20','../config/database','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','created','0100','.\x20Remaining\x20active\x20timers:\x20','shopId','/status/','ü™ô\x20CoinToPayStatusService\x20initialized','\x20current\x20status:\x20','\x20\x20\x20üìÖ\x20Time:\x20','./gateways/coinToPayService','toISOString',',\x20stopping\x20individual\x20checks','\x20not\x20found,\x20clearing\x20timers','sendPaymentStatusNotification','paymentId','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','coinToPayStatusService','customerEmail','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20has\x20no\x20gatewayPaymentId','\x20expired','\x20not\x20enabled\x20for\x20shop\x20','\x20status\x20is\x20','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','now','stringify','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','TesSoft\x20Payment\x20System/1.0','\x20\x20\x20üìç\x20Source:\x20','text','Webhook\x20event\x20','createdOn','-day\x20timeout','COINTOPAY_STATUS_CHANGE','üí∞\x20[CHECK]\x20Payment\x20','‚è∞\x20[HOURLY]\x20Payment\x20','payment','üìä\x20[CHECK]\x20Payment\x20','\x20details:','\x20status\x20unchanged\x20(','message','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','status','error','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','‚è∞\x20[GLOBAL]\x20Payment\x20','\x20seconds\x20(','‚úÖ\x20[CHECK]\x20Payment\x20','PAID','settings','globalCheckInterval','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','Success','GLOBAL_CHECK_INTERVAL_MS','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','Payment\x20older\x20than\x20','bankDetails','sendShopWebhook','1054518jIGoVj','1420264nUkFPT','‚ùå\x20[CHECK]\x20Payment\x20','log','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20completed\x20for\x20payment\x20','length','transactionId','üßπ\x20[CHECK]\x20Payment\x20','cointopay_status_check_','\x20with\x20status\x20',',\x20clearing\x20individual\x20timers','amount','\x20days\x20(created\x20before\x20','PENDING','\x20\x20\x20-\x20gatewayPaymentId:\x20','logShopWebhookError','80XhtUdB','logCoinToPayError','./telegramBotService','POST','startPeriodicStatusCheck','getServiceStats','clearPaymentTimers','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20days\x20without\x20payment\x20confirmation','\x20\x20\x20-\x20GatewayPaymentId:\x20','getTime','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','forEach','\x20(age:\x20','description','\x20updated\x20successfully','üßπ\x20[DEBUG]\x20Clearing\x20','\x20\x20\x20-\x20Gateway:\x20','delay','checkPaymentStatus','\x20days','application/json','5148234hZuCJA','logWhiteDomainError','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','gatewayOrderId','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','logCoinToPayStatus','stack','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','checkPaymentById','‚è∞\x20[GLOBAL]\x20Found\x20','expired','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','1857296LpGOxf','checkSinglePayment','‚è∞\x20[EXPIRY]\x20Payment\x20','toFixed','remitterIban','values','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','findUnique','\x20timers\x20for\x20payment\x20','4XJYzMs','paymentTimers','getDate','telegramBotService','\x20checked,\x20','EXPIRED','ü™ô\x20[DEBUG]\x20Creating\x20','currency','Bank\x20Details:\x20','from','\x20\x20\x20üìä\x20Status:\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20marked\x20as\x20paid\x20at:\x20','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','delete','\x20has\x20no\x20gatewayPaymentId,\x20skipping','push','1235541JyZepl','set','createdAt','cointopay','Payment\x20not\x20found','status_check','5\x20minutes','404451WolhLc','__esModule','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20\x20\x20‚ùå\x20Error:\x20','EXPIRY_DAYS','confirmedOn'];a37_0x1161=function(){return _0x3593dd;};return a37_0x1161();}(function(_0x41ef44,_0x22d309){const _0xfecd0e=a37_0x264c,_0x110aa6=_0x41ef44();while(!![]){try{const _0x419d9d=-parseInt(_0xfecd0e(0x147))/0x1+-parseInt(_0xfecd0e(0x183))/0x2*(-parseInt(_0xfecd0e(0x195))/0x3)+parseInt(_0xfecd0e(0x148))/0x4+parseInt(_0xfecd0e(0x1ab))/0x5+parseInt(_0xfecd0e(0x16e))/0x6+-parseInt(_0xfecd0e(0x17a))/0x7+-parseInt(_0xfecd0e(0x158))/0x8*(parseInt(_0xfecd0e(0x19c))/0x9);if(_0x419d9d===_0x22d309)break;else _0x110aa6['push'](_0x110aa6['shift']());}catch(_0x478ebb){_0x110aa6['push'](_0x110aa6['shift']());}}}(a37_0x1161,0x82f0e));var __importDefault=this&&this[a37_0x269d5f(0x1dc)]||function(_0x467341){const _0x70b96e=a37_0x269d5f;return _0x467341&&_0x467341[_0x70b96e(0x19d)]?_0x467341:{'default':_0x467341};};Object['defineProperty'](exports,a37_0x269d5f(0x19d),{'value':!![]}),exports[a37_0x269d5f(0x206)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a37_0x269d5f(0x1ff)),database_1=__importDefault(require(a37_0x269d5f(0x1f5))),telegramBotService_1=require(a37_0x269d5f(0x15a)),loggerService_1=require(a37_0x269d5f(0x1a4));class CoinToPayStatusService{constructor(){const _0x5ec8da=a37_0x269d5f;this[_0x5ec8da(0x13f)]=null,this[_0x5ec8da(0x142)]=0x3c*0x3c*0x3e8,this[_0x5ec8da(0x1a0)]=0x5,this[_0x5ec8da(0x184)]=new Map(),this[_0x5ec8da(0x1e5)]=new coinToPayService_1[(_0x5ec8da(0x1d6))](),console['log'](_0x5ec8da(0x1fc));}[a37_0x269d5f(0x1d9)](_0x199e06,_0x5b6ee8){const _0x50e9e0=a37_0x269d5f;console[_0x50e9e0(0x14a)](_0x50e9e0(0x1e9)),console['log']('\x20\x20\x20-\x20paymentId:\x20'+_0x199e06),console[_0x50e9e0(0x14a)](_0x50e9e0(0x156)+_0x5b6ee8),this[_0x50e9e0(0x15e)](_0x199e06);const _0x5690d9=[],_0x330880=new Date(),_0x42229e=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x50e9e0(0x1cd)},{'delay':0x5*0x3c*0x3e8,'description':_0x50e9e0(0x19b)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x50e9e0(0x14a)](_0x50e9e0(0x189)+_0x42229e[_0x50e9e0(0x14d)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x199e06);let _0x2cdfaa=0x0;_0x42229e[_0x50e9e0(0x164)]((_0x206438,_0x4cb7d4)=>{const _0x458ddb=_0x50e9e0;_0x2cdfaa+=_0x206438[_0x458ddb(0x16a)];const _0x5eb04b=setTimeout(async()=>{const _0x1a492f=_0x458ddb;console[_0x1a492f(0x14a)]('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x4cb7d4+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x199e06+_0x1a492f(0x1a8)+_0x206438['description']+')');try{await this[_0x1a492f(0x1ce)](_0x199e06),console['log'](_0x1a492f(0x1da)+(_0x4cb7d4+0x1)+_0x1a492f(0x14c)+_0x199e06);}catch(_0x2f3e6e){console['error'](_0x1a492f(0x1d0)+(_0x4cb7d4+0x1)+_0x1a492f(0x1f4)+_0x199e06+':',_0x2f3e6e),this['logCoinToPayError'](_0x199e06,_0x5b6ee8,_0x2f3e6e,'status_check',{'checkNumber':_0x4cb7d4+0x1,'scheduledAfter':_0x206438[_0x1a492f(0x166)],'isIndividualCheck':!![]});}},_0x2cdfaa);_0x5690d9[_0x458ddb(0x194)](_0x5eb04b),console['log']('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x4cb7d4+0x1)+_0x458ddb(0x1f4)+_0x199e06+'\x20in\x20'+_0x2cdfaa/0x3e8+_0x458ddb(0x13b)+_0x206438['description']+')');});const _0x18d2d6=setInterval(async()=>{const _0xa7b145=_0x50e9e0;console[_0xa7b145(0x14a)](_0xa7b145(0x1ae)+_0x199e06);try{const _0x52e621=await database_1[_0xa7b145(0x1b9)][_0xa7b145(0x12f)][_0xa7b145(0x181)]({'where':{'id':_0x199e06},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x52e621){console[_0xa7b145(0x14a)](_0xa7b145(0x1ef)+_0x199e06+_0xa7b145(0x202)),this[_0xa7b145(0x15e)](_0x199e06);return;}console[_0xa7b145(0x14a)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x199e06+_0xa7b145(0x1fd)+_0x52e621[_0xa7b145(0x137)]);if(_0x52e621[_0xa7b145(0x137)]!==_0xa7b145(0x155)){console[_0xa7b145(0x14a)](_0xa7b145(0x1e3)+_0x199e06+'\x20status\x20is\x20'+_0x52e621[_0xa7b145(0x137)]+_0xa7b145(0x201)),this[_0xa7b145(0x15e)](_0x199e06);return;}const _0x2ff39a=Math['floor']((Date[_0xa7b145(0x20e)]()-_0x52e621[_0xa7b145(0x197)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x2ff39a>=this[_0xa7b145(0x1a0)]){console['log'](_0xa7b145(0x12e)+_0x199e06+'\x20is\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0xa7b145(0x15e)](_0x199e06);return;}await this[_0xa7b145(0x1ce)](_0x199e06),console[_0xa7b145(0x14a)]('‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x199e06);}catch(_0x2e85b9){console[_0xa7b145(0x138)](_0xa7b145(0x1bc)+_0x199e06+':',_0x2e85b9),this[_0xa7b145(0x159)](_0x199e06,_0x5b6ee8,_0x2e85b9,_0xa7b145(0x19a),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x5690d9['push'](_0x18d2d6),this['paymentTimers'][_0x50e9e0(0x196)](_0x199e06,{'timers':_0x5690d9,'paymentId':_0x199e06,'gatewayPaymentId':_0x5b6ee8,'createdAt':_0x330880}),console[_0x50e9e0(0x14a)](_0x50e9e0(0x140)+_0x42229e[_0x50e9e0(0x14d)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x199e06),console[_0x50e9e0(0x14a)](_0x50e9e0(0x205)+this[_0x50e9e0(0x184)]['size']),this['logCoinToPayStatus'](_0x199e06,_0x5b6ee8,_0x50e9e0(0x155),_0x50e9e0(0x155),_0x50e9e0(0x19a),{'action':'schedule_created','scheduledChecks':_0x42229e['length'],'firstCheckIn':_0x42229e[0x0]['delay']/0x3e8,'totalTimers':this['paymentTimers']['size']});}[a37_0x269d5f(0x15e)](_0x2a2a93){const _0x111aca=a37_0x269d5f,_0x19ae86=this[_0x111aca(0x184)]['get'](_0x2a2a93);_0x19ae86?(console[_0x111aca(0x14a)](_0x111aca(0x168)+_0x19ae86[_0x111aca(0x1b1)]['length']+_0x111aca(0x182)+_0x2a2a93),_0x19ae86[_0x111aca(0x1b1)]['forEach']((_0x66a01a,_0x498444)=>{const _0x14fd58=_0x111aca;_0x66a01a&&(clearTimeout(_0x66a01a),clearInterval(_0x66a01a),console[_0x14fd58(0x14a)](_0x14fd58(0x191)+(_0x498444+0x1)+_0x14fd58(0x1f4)+_0x2a2a93));}),this[_0x111aca(0x184)][_0x111aca(0x192)](_0x2a2a93),console[_0x111aca(0x14a)](_0x111aca(0x1a2)+_0x2a2a93+_0x111aca(0x1f9)+this[_0x111aca(0x184)][_0x111aca(0x1d4)])):console['log'](_0x111aca(0x19e)+_0x2a2a93+_0x111aca(0x1ad));}async[a37_0x269d5f(0x1ce)](_0x4cb436){const _0x741461=a37_0x269d5f;console[_0x741461(0x14a)](_0x741461(0x172)+_0x4cb436);const _0x31dcf4=await database_1[_0x741461(0x1b9)]['payment'][_0x741461(0x181)]({'where':{'id':_0x4cb436},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x31dcf4){console[_0x741461(0x14a)](_0x741461(0x149)+_0x4cb436+_0x741461(0x1d7));return;}console[_0x741461(0x14a)](_0x741461(0x130)+_0x4cb436+_0x741461(0x1e8)),console[_0x741461(0x14a)](_0x741461(0x169)+_0x31dcf4['gateway']),console[_0x741461(0x14a)](_0x741461(0x1cf)+_0x31dcf4['status']),console[_0x741461(0x14a)](_0x741461(0x161)+_0x31dcf4['gatewayPaymentId']),console[_0x741461(0x14a)](_0x741461(0x1b5)+_0x31dcf4[_0x741461(0x153)]+'\x20'+_0x31dcf4[_0x741461(0x18a)]),console['log'](_0x741461(0x1c0)+_0x31dcf4[_0x741461(0x1fa)]);if(_0x31dcf4[_0x741461(0x1cb)]!==_0x741461(0x198)){console[_0x741461(0x14a)](_0x741461(0x1a6)+_0x4cb436+_0x741461(0x1f6)+_0x31dcf4[_0x741461(0x1cb)]+')');return;}if(_0x31dcf4[_0x741461(0x137)]!==_0x741461(0x155)){console[_0x741461(0x14a)](_0x741461(0x1a6)+_0x4cb436+_0x741461(0x20c)+_0x31dcf4['status']+',\x20stopping\x20individual\x20checks'),this[_0x741461(0x15e)](_0x4cb436);return;}if(!_0x31dcf4[_0x741461(0x1af)]){console['log'](_0x741461(0x1a6)+_0x4cb436+_0x741461(0x209));return;}console['log'](_0x741461(0x13c)+_0x4cb436+_0x741461(0x1e7)),await this[_0x741461(0x17b)](_0x31dcf4);}[a37_0x269d5f(0x173)](_0x305540,_0xcba852,_0x14c646,_0x3e60ae,_0x6193ca,_0xa4e070){const _0x494a32=a37_0x269d5f,_0x8c2e63={'type':_0x494a32(0x218),'paymentId':_0x305540,'gatewayPaymentId':_0xcba852,'oldStatus':_0x14c646,'newStatus':_0x3e60ae,'source':_0x6193ca,'timestamp':new Date()[_0x494a32(0x200)](),'details':_0xa4e070||{}};loggerService_1['loggerService']['logCoinToPayStatus'](_0x8c2e63),console[_0x494a32(0x14a)](_0x494a32(0x139)+_0x305540+'\x20('+_0xcba852+')'),console[_0x494a32(0x14a)](_0x494a32(0x18d)+_0x14c646+_0x494a32(0x1ba)+_0x3e60ae),console['log'](_0x494a32(0x213)+_0x6193ca),console['log'](_0x494a32(0x1fe)+_0x8c2e63['timestamp']),_0xa4e070&&console[_0x494a32(0x14a)](_0x494a32(0x1b6),_0xa4e070);}[a37_0x269d5f(0x159)](_0x10bb8e,_0x1f0e5d,_0x20ab48,_0x3bba06,_0x2d87e3){const _0x487619=a37_0x269d5f,_0x5d5e47={'type':_0x487619(0x1be),'paymentId':_0x10bb8e,'gatewayPaymentId':_0x1f0e5d,'error':_0x20ab48 instanceof Error?{'message':_0x20ab48[_0x487619(0x133)],'stack':_0x20ab48[_0x487619(0x174)]}:_0x20ab48,'source':_0x3bba06,'timestamp':new Date()[_0x487619(0x200)](),'context':_0x2d87e3||{}};loggerService_1[_0x487619(0x1aa)][_0x487619(0x159)](_0x5d5e47),console[_0x487619(0x138)](_0x487619(0x136)+_0x10bb8e+'\x20('+_0x1f0e5d+')'),console['error'](_0x487619(0x19f)+(_0x20ab48 instanceof Error?_0x20ab48[_0x487619(0x133)]:_0x20ab48)),console[_0x487619(0x138)](_0x487619(0x213)+_0x3bba06),console[_0x487619(0x138)](_0x487619(0x1fe)+_0x5d5e47['timestamp']),_0x2d87e3&&console[_0x487619(0x138)](_0x487619(0x1bb),_0x2d87e3);}[a37_0x269d5f(0x15c)](){const _0x4d88b6=a37_0x269d5f;console['log']('ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x4d88b6(0x1a7)]()['catch'](_0x767cfe=>{const _0x1c9a23=_0x4d88b6;console[_0x1c9a23(0x138)]('‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x767cfe);}),this[_0x4d88b6(0x13f)]=setInterval(async()=>{const _0xea0ebf=_0x4d88b6;try{console[_0xea0ebf(0x14a)](_0xea0ebf(0x170)),await this[_0xea0ebf(0x1a7)](),console[_0xea0ebf(0x14a)](_0xea0ebf(0x1c9));}catch(_0x5a4268){console[_0xea0ebf(0x138)](_0xea0ebf(0x210),_0x5a4268);}},this[_0x4d88b6(0x142)]),console[_0x4d88b6(0x14a)](_0x4d88b6(0x1a5));}[a37_0x269d5f(0x1d8)](){const _0x256b7c=a37_0x269d5f;console[_0x256b7c(0x14a)](_0x256b7c(0x20d));this[_0x256b7c(0x13f)]&&(clearInterval(this[_0x256b7c(0x13f)]),this['globalCheckInterval']=null,console[_0x256b7c(0x14a)](_0x256b7c(0x1ca)));const _0x1c05dc=this[_0x256b7c(0x184)][_0x256b7c(0x1d4)];for(const [_0x4d2bac]of this[_0x256b7c(0x184)]){this[_0x256b7c(0x15e)](_0x4d2bac);}console[_0x256b7c(0x14a)](_0x256b7c(0x1f0)+_0x1c05dc+_0x256b7c(0x1b0));}async[a37_0x269d5f(0x1a7)](){const _0x5a4793=a37_0x269d5f;try{console[_0x5a4793(0x14a)]('ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x15e749=await database_1[_0x5a4793(0x1b9)][_0x5a4793(0x12f)]['findMany']({'where':{'gateway':_0x5a4793(0x198),'status':_0x5a4793(0x155),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x5a4793(0x1df)+_0x15e749[_0x5a4793(0x14d)]+_0x5a4793(0x1f1));if(_0x15e749[_0x5a4793(0x14d)]===0x0){console[_0x5a4793(0x14a)](_0x5a4793(0x175));return;}const _0x180b10=await this[_0x5a4793(0x1f2)](_0x15e749);console[_0x5a4793(0x14a)](_0x5a4793(0x177)+_0x180b10[_0x5a4793(0x14d)]+_0x5a4793(0x1d2));let _0x7b65b0=0x0,_0x55a2eb=0x0;for(const _0x2908c1 of _0x15e749){try{if(_0x180b10['includes'](_0x2908c1['id'])){console[_0x5a4793(0x14a)](_0x5a4793(0x13a)+_0x2908c1['id']+_0x5a4793(0x134)),_0x55a2eb++;continue;}if(this['paymentTimers'][_0x5a4793(0x1c5)](_0x2908c1['id'])){console[_0x5a4793(0x14a)](_0x5a4793(0x13a)+_0x2908c1['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x55a2eb++;continue;}const _0x24e1b3=(Date[_0x5a4793(0x20e)]()-_0x2908c1['createdAt']['getTime']())/(0x3e8*0x3c*0x3c);if(_0x24e1b3<0x1){console[_0x5a4793(0x14a)](_0x5a4793(0x13a)+_0x2908c1['id']+'\x20is\x20too\x20new\x20('+_0x24e1b3[_0x5a4793(0x17d)](0x1)+_0x5a4793(0x1d1)),_0x55a2eb++;continue;}console[_0x5a4793(0x14a)]('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x2908c1['id']+_0x5a4793(0x165)+_0x24e1b3[_0x5a4793(0x17d)](0x1)+'h)'),await this[_0x5a4793(0x17b)](_0x2908c1),_0x7b65b0++,await new Promise(_0x738a5d=>setTimeout(_0x738a5d,0x7d0));}catch(_0x5f0c14){console[_0x5a4793(0x138)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x2908c1['id']+':',_0x5f0c14),this[_0x5a4793(0x159)](_0x2908c1['id'],_0x2908c1[_0x5a4793(0x1af)]||_0x5a4793(0x1f3),_0x5f0c14,_0x5a4793(0x19a),{'isGlobalCheck':!![],'paymentAmount':_0x2908c1[_0x5a4793(0x153)],'paymentCurrency':_0x2908c1['currency'],'shopId':_0x2908c1[_0x5a4793(0x1fa)],'createdAt':_0x2908c1[_0x5a4793(0x197)]}),loggerService_1['loggerService'][_0x5a4793(0x16f)]('cointopay',_0x5a4793(0x1fb)+_0x2908c1[_0x5a4793(0x1af)],_0x5f0c14);}}console[_0x5a4793(0x14a)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x7b65b0+_0x5a4793(0x187)+_0x55a2eb+_0x5a4793(0x1e0)+_0x180b10[_0x5a4793(0x14d)]+_0x5a4793(0x20a));}catch(_0x4e70ce){console[_0x5a4793(0x138)](_0x5a4793(0x163),_0x4e70ce);}}async[a37_0x269d5f(0x1f2)](_0x148e2b){const _0x5d4e6c=a37_0x269d5f,_0x169582=[],_0x3986d7=new Date();_0x3986d7['setDate'](_0x3986d7[_0x5d4e6c(0x185)]()-this[_0x5d4e6c(0x1a0)]),console[_0x5d4e6c(0x14a)](_0x5d4e6c(0x135)+this[_0x5d4e6c(0x1a0)]+_0x5d4e6c(0x154)+_0x3986d7[_0x5d4e6c(0x200)]()+')');for(const _0x4aa8d1 of _0x148e2b){if(_0x4aa8d1[_0x5d4e6c(0x197)]<_0x3986d7){console[_0x5d4e6c(0x14a)](_0x5d4e6c(0x17c)+_0x4aa8d1['id']+_0x5d4e6c(0x1eb)+this[_0x5d4e6c(0x1a0)]+_0x5d4e6c(0x1bf));try{this['logCoinToPayStatus'](_0x4aa8d1['id'],_0x4aa8d1[_0x5d4e6c(0x1af)]||_0x5d4e6c(0x1f3),_0x5d4e6c(0x155),'EXPIRED','auto_expire',{'reason':'Payment\x20older\x20than\x20'+this[_0x5d4e6c(0x1a0)]+_0x5d4e6c(0x16c),'createdAt':_0x4aa8d1[_0x5d4e6c(0x197)],'daysSinceCreation':Math['floor']((Date[_0x5d4e6c(0x20e)]()-_0x4aa8d1[_0x5d4e6c(0x197)][_0x5d4e6c(0x162)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x4aa8d1[_0x5d4e6c(0x153)],'paymentCurrency':_0x4aa8d1[_0x5d4e6c(0x18a)],'shopId':_0x4aa8d1['shopId']}),await database_1[_0x5d4e6c(0x1b9)][_0x5d4e6c(0x12f)][_0x5d4e6c(0x1dd)]({'where':{'id':_0x4aa8d1['id']},'data':{'status':_0x5d4e6c(0x188),'updatedAt':new Date(),'adminNotes':_0x5d4e6c(0x1b3)+this['EXPIRY_DAYS']+_0x5d4e6c(0x160)}}),await database_1[_0x5d4e6c(0x1b9)]['webhookLog'][_0x5d4e6c(0x1e4)]({'data':{'paymentId':_0x4aa8d1['id'],'shopId':_0x4aa8d1[_0x5d4e6c(0x1fa)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x5d4e6c(0x20f)]({'reason':_0x5d4e6c(0x144)+this[_0x5d4e6c(0x1a0)]+_0x5d4e6c(0x16c),'createdAt':_0x4aa8d1[_0x5d4e6c(0x197)],'expiredAt':new Date()[_0x5d4e6c(0x200)](),'daysSinceCreation':Math[_0x5d4e6c(0x1e2)]((Date[_0x5d4e6c(0x20e)]()-_0x4aa8d1[_0x5d4e6c(0x197)][_0x5d4e6c(0x162)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x5d4e6c(0x146)](_0x4aa8d1,_0x5d4e6c(0x188)),await this[_0x5d4e6c(0x203)](_0x4aa8d1,_0x5d4e6c(0x188)),this[_0x5d4e6c(0x15e)](_0x4aa8d1['id']),_0x169582[_0x5d4e6c(0x194)](_0x4aa8d1['id']),console[_0x5d4e6c(0x14a)]('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x4aa8d1['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this['EXPIRY_DAYS']+_0x5d4e6c(0x217));}catch(_0x476489){console[_0x5d4e6c(0x138)](_0x5d4e6c(0x180)+_0x4aa8d1['id']+':',_0x476489),this[_0x5d4e6c(0x159)](_0x4aa8d1['id'],_0x4aa8d1[_0x5d4e6c(0x1af)]||_0x5d4e6c(0x1f3),_0x476489,'auto_expire',{'reason':_0x5d4e6c(0x18e),'createdAt':_0x4aa8d1[_0x5d4e6c(0x197)],'daysSinceCreation':Math['floor']((Date['now']()-_0x4aa8d1[_0x5d4e6c(0x197)][_0x5d4e6c(0x162)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x169582;}async[a37_0x269d5f(0x17b)](_0x131440){const _0x4b8caa=a37_0x269d5f;if(!_0x131440['gatewayPaymentId']){console[_0x4b8caa(0x14a)](_0x4b8caa(0x1a6)+_0x131440['id']+_0x4b8caa(0x193));return;}console[_0x4b8caa(0x14a)]('üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x131440['id']+'\x20('+_0x131440[_0x4b8caa(0x1af)]+')');try{const _0x15a60a=await this[_0x4b8caa(0x1e5)][_0x4b8caa(0x16b)](_0x131440[_0x4b8caa(0x1af)]);console['log']('üìä\x20[CHECK]\x20Payment\x20'+_0x131440['id']+'\x20status:\x20'+_0x15a60a['status']);_0x15a60a[_0x4b8caa(0x1ea)]&&console[_0x4b8caa(0x14a)](_0x4b8caa(0x130)+_0x131440['id']+_0x4b8caa(0x131),{'iban':_0x15a60a['paymentDetails'][_0x4b8caa(0x1b7)]||'not\x20found','transactionId':_0x15a60a['paymentDetails'][_0x4b8caa(0x14e)],'createdOn':_0x15a60a[_0x4b8caa(0x1ea)][_0x4b8caa(0x216)],'confirmedOn':_0x15a60a[_0x4b8caa(0x1ea)]['confirmedOn']||_0x4b8caa(0x1de)});if(_0x15a60a[_0x4b8caa(0x137)]!==_0x131440[_0x4b8caa(0x137)]){console['log'](_0x4b8caa(0x1ee)+_0x131440['id']+_0x4b8caa(0x1d5)+_0x131440['status']+_0x4b8caa(0x1c6)+_0x15a60a[_0x4b8caa(0x137)]),this['logCoinToPayStatus'](_0x131440['id'],_0x131440['gatewayPaymentId'],_0x131440[_0x4b8caa(0x137)],_0x15a60a['status'],'status_check',{'paymentDetails':_0x15a60a[_0x4b8caa(0x1ea)],'amount':_0x15a60a[_0x4b8caa(0x153)],'currency':_0x15a60a[_0x4b8caa(0x18a)],'shopId':_0x131440[_0x4b8caa(0x1fa)],'checkTimestamp':new Date()[_0x4b8caa(0x200)]()});const _0x4701d2={'status':_0x15a60a[_0x4b8caa(0x137)],'updatedAt':new Date()};_0x15a60a['status']===_0x4b8caa(0x13d)&&_0x131440[_0x4b8caa(0x137)]!==_0x4b8caa(0x13d)&&(_0x4701d2[_0x4b8caa(0x1a9)]=new Date(),console[_0x4b8caa(0x14a)](_0x4b8caa(0x219)+_0x131440['id']+_0x4b8caa(0x18f)+_0x4701d2[_0x4b8caa(0x1a9)]['toISOString']()));if(_0x15a60a[_0x4b8caa(0x1ea)]){const _0x3055b2=_0x15a60a[_0x4b8caa(0x1ea)];_0x3055b2[_0x4b8caa(0x1b7)]&&(_0x4701d2[_0x4b8caa(0x17e)]=_0x3055b2[_0x4b8caa(0x1b7)],console[_0x4b8caa(0x14a)]('üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x3055b2[_0x4b8caa(0x1b7)]));if(_0x3055b2[_0x4b8caa(0x145)]){const _0x1c4bac=_0x131440[_0x4b8caa(0x1c3)]||'',_0x1dfebe=_0x4b8caa(0x18b)+_0x3055b2[_0x4b8caa(0x145)];_0x4701d2['adminNotes']=_0x1c4bac?_0x1c4bac+'\x0a\x0a'+_0x1dfebe:_0x1dfebe,console['log'](_0x4b8caa(0x190));}_0x3055b2['transactionId']&&console[_0x4b8caa(0x14a)](_0x4b8caa(0x1db)+_0x3055b2['transactionId']),_0x3055b2['confirmedOn']&&console['log'](_0x4b8caa(0x208)+_0x3055b2[_0x4b8caa(0x1a1)]);}await database_1[_0x4b8caa(0x1b9)][_0x4b8caa(0x12f)][_0x4b8caa(0x1dd)]({'where':{'id':_0x131440['id']},'data':_0x4701d2}),await database_1[_0x4b8caa(0x1b9)][_0x4b8caa(0x1c4)][_0x4b8caa(0x1e4)]({'data':{'paymentId':_0x131440['id'],'shopId':_0x131440[_0x4b8caa(0x1fa)],'event':_0x4b8caa(0x150)+_0x15a60a[_0x4b8caa(0x137)][_0x4b8caa(0x1b4)](),'statusCode':0xc8,'responseBody':JSON[_0x4b8caa(0x20f)]({'oldStatus':_0x131440[_0x4b8caa(0x137)],'newStatus':_0x15a60a[_0x4b8caa(0x137)],'paymentDetails':_0x15a60a[_0x4b8caa(0x1ea)],'checkedAt':new Date()[_0x4b8caa(0x200)]()})}}),await this[_0x4b8caa(0x146)](_0x131440,_0x15a60a[_0x4b8caa(0x137)]),await this['sendPaymentStatusNotification'](_0x131440,_0x15a60a[_0x4b8caa(0x137)]),_0x15a60a[_0x4b8caa(0x137)]!=='PENDING'&&(console['log'](_0x4b8caa(0x14f)+_0x131440['id']+'\x20status\x20changed\x20to\x20'+_0x15a60a[_0x4b8caa(0x137)]+_0x4b8caa(0x152)),this[_0x4b8caa(0x15e)](_0x131440['id'])),console['log'](_0x4b8caa(0x13c)+_0x131440['id']+_0x4b8caa(0x167));}else console[_0x4b8caa(0x14a)](_0x4b8caa(0x130)+_0x131440['id']+_0x4b8caa(0x132)+_0x15a60a[_0x4b8caa(0x137)]+')'),this[_0x4b8caa(0x173)](_0x131440['id'],_0x131440[_0x4b8caa(0x1af)],_0x131440['status'],_0x15a60a[_0x4b8caa(0x137)],_0x4b8caa(0x19a),{'statusUnchanged':!![],'paymentDetails':_0x15a60a['paymentDetails'],'amount':_0x15a60a[_0x4b8caa(0x153)],'currency':_0x15a60a['currency'],'shopId':_0x131440['shopId'],'checkTimestamp':new Date()[_0x4b8caa(0x200)]()});}catch(_0x20c1d2){console[_0x4b8caa(0x138)]('‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x131440['id']+':',_0x20c1d2),this[_0x4b8caa(0x159)](_0x131440['id'],_0x131440[_0x4b8caa(0x1af)],_0x20c1d2,'status_check',{'paymentAmount':_0x131440[_0x4b8caa(0x153)],'paymentCurrency':_0x131440[_0x4b8caa(0x18a)],'shopId':_0x131440[_0x4b8caa(0x1fa)],'createdAt':_0x131440[_0x4b8caa(0x197)]}),await database_1[_0x4b8caa(0x1b9)]['webhookLog'][_0x4b8caa(0x1e4)]({'data':{'paymentId':_0x131440['id'],'shopId':_0x131440[_0x4b8caa(0x1fa)],'event':_0x4b8caa(0x1b8),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x20c1d2 instanceof Error?_0x20c1d2[_0x4b8caa(0x133)]:_0x4b8caa(0x1cc),'gatewayPaymentId':_0x131440['gatewayPaymentId'],'checkedAt':new Date()[_0x4b8caa(0x200)]()})}});}}async[a37_0x269d5f(0x146)](_0x3f0d7b,_0x97992f){const _0x597c8a=a37_0x269d5f,_0x3929c6=Date['now']();try{const _0x5f2181=_0x3f0d7b[_0x597c8a(0x1c2)],_0x353235=_0x5f2181[_0x597c8a(0x13e)];if(!_0x353235?.[_0x597c8a(0x1bd)]){console[_0x597c8a(0x14a)](_0x597c8a(0x14b)+_0x5f2181['id']);return;}const _0xfd3dc=_0x97992f===_0x597c8a(0x13d)?_0x597c8a(0x1ac):_0x97992f===_0x597c8a(0x1d3)?_0x597c8a(0x1b2):_0x97992f===_0x597c8a(0x188)?_0x597c8a(0x1b2):'payment.pending';if(!_0x353235['webhookEvents']?.['includes'](_0xfd3dc)){console[_0x597c8a(0x14a)](_0x597c8a(0x215)+_0xfd3dc+_0x597c8a(0x20b)+_0x5f2181['id']);return;}const _0x12e26c={'event':_0xfd3dc,'payment':{'id':_0x3f0d7b['id'],'order_id':_0x3f0d7b['orderId'],'gateway_order_id':_0x3f0d7b[_0x597c8a(0x171)],'gateway':_0x597c8a(0x1f8),'amount':_0x3f0d7b[_0x597c8a(0x153)],'currency':_0x3f0d7b[_0x597c8a(0x18a)],'status':_0x97992f['toLowerCase'](),'customer_email':_0x3f0d7b[_0x597c8a(0x207)],'customer_name':_0x3f0d7b[_0x597c8a(0x1a3)],'created_at':_0x3f0d7b['createdAt'],'updated_at':new Date()}},_0x486b55=await fetch(_0x353235[_0x597c8a(0x1bd)],{'method':_0x597c8a(0x15b),'headers':{'Content-Type':_0x597c8a(0x16d),'User-Agent':_0x597c8a(0x212)},'body':JSON[_0x597c8a(0x20f)](_0x12e26c)}),_0x423036=Date['now']()-_0x3929c6,_0x53ada4=_0x486b55['ok']?_0x597c8a(0x141):await _0x486b55[_0x597c8a(0x214)]();loggerService_1[_0x597c8a(0x1aa)]['logShopWebhookSent'](_0x3f0d7b[_0x597c8a(0x1fa)],_0x353235[_0x597c8a(0x1bd)],_0xfd3dc,_0x486b55[_0x597c8a(0x137)],_0x423036,_0x12e26c),console['log']('Shop\x20webhook\x20sent\x20to\x20'+_0x353235[_0x597c8a(0x1bd)]+_0x597c8a(0x151)+_0x486b55[_0x597c8a(0x137)]+'\x20('+_0x423036+_0x597c8a(0x1ed));}catch(_0x79894c){console[_0x597c8a(0x138)](_0x597c8a(0x1e1),_0x79894c),loggerService_1['loggerService'][_0x597c8a(0x157)](_0x3f0d7b['shopId'],_0x3f0d7b[_0x597c8a(0x1c2)]?.['settings']?.[_0x597c8a(0x1bd)]||_0x597c8a(0x1f3),_0x597c8a(0x1c8),_0x79894c,{});}}async[a37_0x269d5f(0x203)](_0x23ea41,_0x262893){const _0x4cc24d=a37_0x269d5f;try{const _0x193208={'PENDING':_0x4cc24d(0x1f7),'PAID':_0x4cc24d(0x1c1),'FAILED':'failed','EXPIRED':_0x4cc24d(0x178)},_0x30e6d4=_0x193208[_0x262893];if(!_0x30e6d4||_0x30e6d4===_0x4cc24d(0x1f7))return;await telegramBotService_1[_0x4cc24d(0x186)][_0x4cc24d(0x1e6)](_0x23ea41[_0x4cc24d(0x1fa)],_0x23ea41,_0x30e6d4);}catch(_0x224704){console[_0x4cc24d(0x138)](_0x4cc24d(0x1c7),_0x224704);}}async[a37_0x269d5f(0x176)](_0x510a12){const _0x38f1bf=a37_0x269d5f;console['log'](_0x38f1bf(0x211)+_0x510a12);const _0x390c8f=await database_1[_0x38f1bf(0x1b9)][_0x38f1bf(0x12f)][_0x38f1bf(0x181)]({'where':{'id':_0x510a12},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x390c8f)throw new Error(_0x38f1bf(0x199));if(_0x390c8f['gateway']!==_0x38f1bf(0x198))throw new Error(_0x38f1bf(0x143));console[_0x38f1bf(0x14a)](_0x38f1bf(0x15f)+_0x510a12),await this[_0x38f1bf(0x17b)](_0x390c8f),console[_0x38f1bf(0x14a)](_0x38f1bf(0x179)+_0x510a12);}[a37_0x269d5f(0x15d)](){const _0x4bb687=a37_0x269d5f,_0x1c600d=this[_0x4bb687(0x13f)]?this[_0x4bb687(0x142)]:undefined,_0x5957a6=Array[_0x4bb687(0x18c)](this[_0x4bb687(0x184)][_0x4bb687(0x17f)]())['map'](_0x13039b=>({'paymentId':_0x13039b[_0x4bb687(0x204)],'gatewayPaymentId':_0x13039b[_0x4bb687(0x1af)],'createdAt':_0x13039b[_0x4bb687(0x197)],'timersCount':_0x13039b[_0x4bb687(0x1b1)][_0x4bb687(0x14d)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x4bb687(0x1a0)],'activeIndividualTimers':this[_0x4bb687(0x184)]['size'],'nextGlobalCheckIn':_0x1c600d,'paymentTimersDetails':_0x5957a6};}['getPaymentTimerInfo'](_0x4638eb){const _0x23baf7=a37_0x269d5f,_0x4aca9b=this[_0x23baf7(0x184)][_0x23baf7(0x1ec)](_0x4638eb);if(_0x4aca9b)return{'hasTimers':!![],'timersCount':_0x4aca9b[_0x23baf7(0x1b1)][_0x23baf7(0x14d)],'createdAt':_0x4aca9b['createdAt'],'gatewayPaymentId':_0x4aca9b[_0x23baf7(0x1af)]};return{'hasTimers':![]};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a37_0x269d5f(0x206)]=new CoinToPayStatusService();