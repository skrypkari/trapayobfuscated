'use strict';function a35_0x1666(){const _0x31bc4f=['getTime','../config/database','EXPIRY_DAYS','üõë\x20CoinToPay\x20status\x20checking\x20stopped','default','üîÑ\x20Updating\x20payment\x20','not\x20confirmed','unknown','adminNotes','./gateways/coinToPayService','webhookEvents','üÜî\x20Transaction\x20ID:\x20','\x20marked\x20as\x20paid\x20at:\x20','PENDING','./telegramBotService','coinToPayService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','toLowerCase','getDate','CHECK_INTERVAL_MS','\x20status\x20from\x20','\x20to\x20','text','./loggerService','CoinToPayService','paidAt','cointopay_auto_expired','‚úÖ\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','üè¶\x20Saved\x20IBAN:\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','cointopay_status_check_','not\x20found','checkExpiredPayments','1230hvZhPw','paid','customerName','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20pending\x20CoinToPay\x20payments','catch','9085280QQtKHV','Initial\x20CoinToPay\x20status\x20check\x20failed:','iban','\x20with\x20status\x20','gateway','webhookLog','401100iNAZsS','Shop\x20webhook\x20sent\x20to\x20','CoinToPayStatusService','\x20days','__esModule','bankDetails','message','checkAllPendingPayments','-day\x20timeout','amount','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','TesSoft\x20Payment\x20System/1.0','defineProperty','11830dcsWgZ','now','failed','payment.success','sendPaymentStatusNotification','coinToPayStatusService','telegramBotService','createdAt','/status/','log','gatewayOrderId','sendPaymentNotification','toISOString','\x20details:','99ZDPWNg','transactionId','includes','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20days\x20without\x20payment\x20confirmation','FAILED','1448648CkpFSL','PAID','checkPaymentById','customerEmail','error','webhookUrl','status','Failed\x20to\x20send\x20shop\x20webhook:','__importDefault','‚úÖ\x20Payment\x20','Bank\x20Details:\x20','startPeriodicStatusCheck','checkSinglePayment','setDate','gatewayPaymentId','ü™ô\x20Checking\x20','created','EXPIRED','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','create','orderId','checkInterval','\x20status:\x20','21914oStQiF','push','1178685sKaCng','length','Payment\x20not\x20found','\x20days\x20(created\x20before\x20','Payment\x20older\x20than\x20','‚ö†Ô∏è\x20Payment\x20','üìä\x20Payment\x20','payment.pending','sendShopWebhook','webhook_send','Periodic\x20CoinToPay\x20status\x20check\x20failed:','stringify','confirmedOn','‚è∞\x20Payment\x20','expired','payment.failed','Failed\x20to\x20expire\x20payment\x20','remitterIban','application/json','Automatically\x20expired\x20after\x20','loggerService','‚úÖ\x20Completed\x20checking\x20','settings','0100','stopPeriodicStatusCheck','shop','payment','ü™ô\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20CoinToPay\x20payments','shopId','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','Failed\x20to\x20check\x20payment\x20','update','Webhook\x20event\x20','\x20updated\x20successfully','findMany','18BrHrNV','currency','createdOn','ms)','cointopay','\x20status\x20unchanged\x20(','28270MwOIQR','paymentDetails','\x20expired\x20CoinToPay\x20payments'];a35_0x1666=function(){return _0x31bc4f;};return a35_0x1666();}const a35_0x38524a=a35_0x2162;(function(_0x306c2a,_0x244e79){const _0x43b701=a35_0x2162,_0x3242c2=_0x306c2a();while(!![]){try{const _0x2c33f6=parseInt(_0x43b701(0x263))/0x1+parseInt(_0x43b701(0x237))/0x2*(-parseInt(_0x43b701(0x21a))/0x3)+-parseInt(_0x43b701(0x1ff))/0x4+-parseInt(_0x43b701(0x239))/0x5+parseInt(_0x43b701(0x1f3))/0x6*(parseInt(_0x43b701(0x20c))/0x7)+-parseInt(_0x43b701(0x220))/0x8*(parseInt(_0x43b701(0x25d))/0x9)+parseInt(_0x43b701(0x1f9))/0xa;if(_0x2c33f6===_0x244e79)break;else _0x3242c2['push'](_0x3242c2['shift']());}catch(_0x4280fc){_0x3242c2['push'](_0x3242c2['shift']());}}}(a35_0x1666,0x36905));var __importDefault=this&&this[a35_0x38524a(0x228)]||function(_0x5cda34){const _0x52cf5e=a35_0x38524a;return _0x5cda34&&_0x5cda34[_0x52cf5e(0x203)]?_0x5cda34:{'default':_0x5cda34};};Object[a35_0x38524a(0x20b)](exports,a35_0x38524a(0x203),{'value':!![]}),exports[a35_0x38524a(0x211)]=exports[a35_0x38524a(0x201)]=void 0x0;const coinToPayService_1=require(a35_0x38524a(0x1db)),database_1=__importDefault(require(a35_0x38524a(0x267))),telegramBotService_1=require(a35_0x38524a(0x1e0)),loggerService_1=require(a35_0x38524a(0x1e9));function a35_0x2162(_0x4fae58,_0x29c1c5){const _0x166612=a35_0x1666();return a35_0x2162=function(_0x2162ec,_0x3ee9b4){_0x2162ec=_0x2162ec-0x1d6;let _0x3e0cbc=_0x166612[_0x2162ec];return _0x3e0cbc;},a35_0x2162(_0x4fae58,_0x29c1c5);}class CoinToPayStatusService{constructor(){const _0x5b04fa=a35_0x38524a;this[_0x5b04fa(0x235)]=null,this[_0x5b04fa(0x1e5)]=0x3c*0x3c*0x3e8,this[_0x5b04fa(0x268)]=0x5,this[_0x5b04fa(0x1e1)]=new coinToPayService_1[(_0x5b04fa(0x1ea))]();}[a35_0x38524a(0x22b)](){const _0x5756e0=a35_0x38524a;console[_0x5756e0(0x215)]('ü™ô\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)'),this['checkAllPendingPayments']()[_0x5756e0(0x1f8)](_0x8d1b96=>{const _0x9fbbc8=_0x5756e0;console[_0x9fbbc8(0x224)](_0x9fbbc8(0x1fa),_0x8d1b96);}),this['checkInterval']=setInterval(async()=>{const _0x287249=_0x5756e0;try{await this[_0x287249(0x206)]();}catch(_0x3f8042){console[_0x287249(0x224)](_0x287249(0x243),_0x3f8042);}},this['CHECK_INTERVAL_MS']),console[_0x5756e0(0x215)](_0x5756e0(0x1ed));}[a35_0x38524a(0x251)](){const _0xb4902e=a35_0x38524a;this[_0xb4902e(0x235)]&&(clearInterval(this[_0xb4902e(0x235)]),this[_0xb4902e(0x235)]=null,console['log'](_0xb4902e(0x269)));}async[a35_0x38524a(0x206)](){const _0x39890e=a35_0x38524a;try{const _0x39fd75=await database_1[_0x39890e(0x1d6)][_0x39890e(0x253)][_0x39890e(0x25c)]({'where':{'gateway':_0x39890e(0x261),'status':_0x39890e(0x1df),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x39fd75[_0x39890e(0x23a)]===0x0){console[_0x39890e(0x215)](_0x39890e(0x254));return;}console[_0x39890e(0x215)](_0x39890e(0x22f)+_0x39fd75[_0x39890e(0x23a)]+_0x39890e(0x1f7));const _0x5bad27=await this[_0x39890e(0x1f2)](_0x39fd75);console[_0x39890e(0x215)]('‚è∞\x20Found\x20'+_0x5bad27[_0x39890e(0x23a)]+_0x39890e(0x265));for(const _0x4c85c4 of _0x39fd75){try{if(_0x5bad27[_0x39890e(0x21c)](_0x4c85c4['id'])){console['log'](_0x39890e(0x246)+_0x4c85c4['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check');continue;}await this[_0x39890e(0x22c)](_0x4c85c4),await new Promise(_0x11ee05=>setTimeout(_0x11ee05,0x7d0));}catch(_0x5a27c7){console[_0x39890e(0x224)](_0x39890e(0x1f6)+_0x4c85c4['id']+':',_0x5a27c7),loggerService_1[_0x39890e(0x24d)]['logWhiteDomainError']('cointopay',_0x39890e(0x214)+_0x4c85c4[_0x39890e(0x22e)],_0x5a27c7);}}console[_0x39890e(0x215)](_0x39890e(0x24e)+_0x39fd75[_0x39890e(0x23a)]+_0x39890e(0x255));}catch(_0xb0b2f5){console[_0x39890e(0x224)](_0x39890e(0x21d),_0xb0b2f5);}}async[a35_0x38524a(0x1f2)](_0x1301e4){const _0xae4a58=a35_0x38524a,_0x18e692=[],_0x469e38=new Date();_0x469e38[_0xae4a58(0x22d)](_0x469e38[_0xae4a58(0x1e4)]()-this['EXPIRY_DAYS']),console[_0xae4a58(0x215)]('‚è∞\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0xae4a58(0x23c)+_0x469e38[_0xae4a58(0x218)]()+')');for(const _0x44c17b of _0x1301e4){if(_0x44c17b[_0xae4a58(0x213)]<_0x469e38){console[_0xae4a58(0x215)](_0xae4a58(0x246)+_0x44c17b['id']+'\x20is\x20older\x20than\x20'+this[_0xae4a58(0x268)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{await database_1[_0xae4a58(0x1d6)]['payment'][_0xae4a58(0x259)]({'where':{'id':_0x44c17b['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0xae4a58(0x24c)+this[_0xae4a58(0x268)]+_0xae4a58(0x21e)}}),await database_1[_0xae4a58(0x1d6)][_0xae4a58(0x1fe)][_0xae4a58(0x233)]({'data':{'paymentId':_0x44c17b['id'],'shopId':_0x44c17b[_0xae4a58(0x256)],'event':_0xae4a58(0x1ec),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0xae4a58(0x23d)+this[_0xae4a58(0x268)]+_0xae4a58(0x202),'createdAt':_0x44c17b[_0xae4a58(0x213)],'expiredAt':new Date()[_0xae4a58(0x218)](),'daysSinceCreation':Math['floor']((Date[_0xae4a58(0x20d)]()-_0x44c17b[_0xae4a58(0x213)][_0xae4a58(0x266)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0xae4a58(0x241)](_0x44c17b,_0xae4a58(0x231)),await this[_0xae4a58(0x210)](_0x44c17b,_0xae4a58(0x231)),_0x18e692[_0xae4a58(0x238)](_0x44c17b['id']),console[_0xae4a58(0x215)](_0xae4a58(0x229)+_0x44c17b['id']+_0xae4a58(0x257)+this[_0xae4a58(0x268)]+_0xae4a58(0x207));}catch(_0x1f5f12){console[_0xae4a58(0x224)](_0xae4a58(0x249)+_0x44c17b['id']+':',_0x1f5f12);}}}return _0x18e692;}async[a35_0x38524a(0x22c)](_0x4a4593){const _0x17762a=a35_0x38524a;if(!_0x4a4593[_0x17762a(0x22e)]){console[_0x17762a(0x215)](_0x17762a(0x23e)+_0x4a4593['id']+_0x17762a(0x1ef));return;}console[_0x17762a(0x215)]('üîç\x20Checking\x20CoinToPay\x20payment\x20'+_0x4a4593['id']+'\x20('+_0x4a4593[_0x17762a(0x22e)]+')');try{const _0x1fbfc4=await this[_0x17762a(0x1e1)]['checkPaymentStatus'](_0x4a4593['gatewayPaymentId']);console[_0x17762a(0x215)](_0x17762a(0x23f)+_0x4a4593['id']+_0x17762a(0x236)+_0x1fbfc4[_0x17762a(0x226)]);_0x1fbfc4[_0x17762a(0x264)]&&console[_0x17762a(0x215)](_0x17762a(0x23f)+_0x4a4593['id']+_0x17762a(0x219),{'iban':_0x1fbfc4[_0x17762a(0x264)][_0x17762a(0x1fb)]||_0x17762a(0x1f1),'transactionId':_0x1fbfc4[_0x17762a(0x264)][_0x17762a(0x21b)],'createdOn':_0x1fbfc4['paymentDetails'][_0x17762a(0x25f)],'confirmedOn':_0x1fbfc4['paymentDetails'][_0x17762a(0x245)]||_0x17762a(0x1d8)});if(_0x1fbfc4[_0x17762a(0x226)]!==_0x4a4593[_0x17762a(0x226)]){console[_0x17762a(0x215)](_0x17762a(0x1d7)+_0x4a4593['id']+_0x17762a(0x1e6)+_0x4a4593[_0x17762a(0x226)]+_0x17762a(0x1e7)+_0x1fbfc4[_0x17762a(0x226)]);const _0x2ef761={'status':_0x1fbfc4[_0x17762a(0x226)],'updatedAt':new Date()};_0x1fbfc4['status']===_0x17762a(0x221)&&_0x4a4593['status']!==_0x17762a(0x221)&&(_0x2ef761[_0x17762a(0x1eb)]=new Date(),console[_0x17762a(0x215)]('üí∞\x20Payment\x20'+_0x4a4593['id']+_0x17762a(0x1de)+_0x2ef761[_0x17762a(0x1eb)][_0x17762a(0x218)]()));if(_0x1fbfc4['paymentDetails']){const _0xf83a38=_0x1fbfc4[_0x17762a(0x264)];_0xf83a38[_0x17762a(0x1fb)]&&(_0x2ef761[_0x17762a(0x24a)]=_0xf83a38[_0x17762a(0x1fb)],console[_0x17762a(0x215)](_0x17762a(0x1ee)+_0xf83a38[_0x17762a(0x1fb)]));if(_0xf83a38[_0x17762a(0x204)]){const _0xb230c9=_0x4a4593[_0x17762a(0x1da)]||'',_0x5653ec=_0x17762a(0x22a)+_0xf83a38[_0x17762a(0x204)];_0x2ef761[_0x17762a(0x1da)]=_0xb230c9?_0xb230c9+'\x0a\x0a'+_0x5653ec:_0x5653ec,console[_0x17762a(0x215)]('üè¶\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0xf83a38[_0x17762a(0x21b)]&&console['log'](_0x17762a(0x1dd)+_0xf83a38[_0x17762a(0x21b)]),_0xf83a38[_0x17762a(0x245)]&&console['log']('‚úÖ\x20Transaction\x20confirmed\x20on:\x20'+_0xf83a38['confirmedOn']);}await database_1[_0x17762a(0x1d6)]['payment'][_0x17762a(0x259)]({'where':{'id':_0x4a4593['id']},'data':_0x2ef761}),await database_1['default']['webhookLog'][_0x17762a(0x233)]({'data':{'paymentId':_0x4a4593['id'],'shopId':_0x4a4593[_0x17762a(0x256)],'event':_0x17762a(0x1f0)+_0x1fbfc4['status'][_0x17762a(0x1e3)](),'statusCode':0xc8,'responseBody':JSON[_0x17762a(0x244)]({'oldStatus':_0x4a4593[_0x17762a(0x226)],'newStatus':_0x1fbfc4[_0x17762a(0x226)],'paymentDetails':_0x1fbfc4[_0x17762a(0x264)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x17762a(0x241)](_0x4a4593,_0x1fbfc4[_0x17762a(0x226)]),await this[_0x17762a(0x210)](_0x4a4593,_0x1fbfc4[_0x17762a(0x226)]),console[_0x17762a(0x215)](_0x17762a(0x229)+_0x4a4593['id']+_0x17762a(0x25b));}else console['log'](_0x17762a(0x23f)+_0x4a4593['id']+_0x17762a(0x262)+_0x1fbfc4[_0x17762a(0x226)]+')');}catch(_0xf76bd4){console[_0x17762a(0x224)](_0x17762a(0x258)+_0x4a4593['id']+':',_0xf76bd4),await database_1['default'][_0x17762a(0x1fe)]['create']({'data':{'paymentId':_0x4a4593['id'],'shopId':_0x4a4593[_0x17762a(0x256)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0xf76bd4 instanceof Error?_0xf76bd4[_0x17762a(0x205)]:'Unknown\x20error','gatewayPaymentId':_0x4a4593['gatewayPaymentId'],'checkedAt':new Date()[_0x17762a(0x218)]()})}});}}async[a35_0x38524a(0x241)](_0x3a544c,_0x117bd9){const _0x10d6a7=a35_0x38524a,_0x40fb13=Date[_0x10d6a7(0x20d)]();try{const _0x4cd457=_0x3a544c[_0x10d6a7(0x252)],_0x57d051=_0x4cd457[_0x10d6a7(0x24f)];if(!_0x57d051?.[_0x10d6a7(0x225)]){console[_0x10d6a7(0x215)](_0x10d6a7(0x209)+_0x4cd457['id']);return;}const _0x55d394=_0x117bd9==='PAID'?_0x10d6a7(0x20f):_0x117bd9===_0x10d6a7(0x21f)?_0x10d6a7(0x248):_0x117bd9==='EXPIRED'?_0x10d6a7(0x248):_0x10d6a7(0x240);if(!_0x57d051[_0x10d6a7(0x1dc)]?.[_0x10d6a7(0x21c)](_0x55d394)){console['log'](_0x10d6a7(0x25a)+_0x55d394+'\x20not\x20enabled\x20for\x20shop\x20'+_0x4cd457['id']);return;}const _0x26e7c6={'event':_0x55d394,'payment':{'id':_0x3a544c['id'],'order_id':_0x3a544c[_0x10d6a7(0x234)],'gateway_order_id':_0x3a544c[_0x10d6a7(0x216)],'gateway':_0x10d6a7(0x250),'amount':_0x3a544c[_0x10d6a7(0x208)],'currency':_0x3a544c[_0x10d6a7(0x25e)],'status':_0x117bd9[_0x10d6a7(0x1e3)](),'customer_email':_0x3a544c[_0x10d6a7(0x223)],'customer_name':_0x3a544c[_0x10d6a7(0x1f5)],'created_at':_0x3a544c[_0x10d6a7(0x213)],'updated_at':new Date()}},_0x356db3=await fetch(_0x57d051[_0x10d6a7(0x225)],{'method':'POST','headers':{'Content-Type':_0x10d6a7(0x24b),'User-Agent':_0x10d6a7(0x20a)},'body':JSON[_0x10d6a7(0x244)](_0x26e7c6)}),_0x1d1646=Date[_0x10d6a7(0x20d)]()-_0x40fb13,_0x4fc07a=_0x356db3['ok']?'Success':await _0x356db3[_0x10d6a7(0x1e8)]();loggerService_1[_0x10d6a7(0x24d)]['logShopWebhookSent'](_0x3a544c['shopId'],_0x57d051[_0x10d6a7(0x225)],_0x55d394,_0x356db3['status'],_0x1d1646,_0x26e7c6),console[_0x10d6a7(0x215)](_0x10d6a7(0x200)+_0x57d051[_0x10d6a7(0x225)]+_0x10d6a7(0x1fc)+_0x356db3[_0x10d6a7(0x226)]+'\x20('+_0x1d1646+_0x10d6a7(0x260));}catch(_0xa86de8){console[_0x10d6a7(0x224)](_0x10d6a7(0x227),_0xa86de8),loggerService_1[_0x10d6a7(0x24d)]['logShopWebhookError'](_0x3a544c[_0x10d6a7(0x256)],_0x3a544c[_0x10d6a7(0x252)]?.[_0x10d6a7(0x24f)]?.[_0x10d6a7(0x225)]||_0x10d6a7(0x1d9),_0x10d6a7(0x242),_0xa86de8,{});}}async[a35_0x38524a(0x210)](_0xe3c363,_0x3bb429){const _0x3014e6=a35_0x38524a;try{const _0x190c41={'PENDING':_0x3014e6(0x230),'PAID':_0x3014e6(0x1f4),'FAILED':_0x3014e6(0x20e),'EXPIRED':_0x3014e6(0x247)},_0x44879f=_0x190c41[_0x3bb429];if(!_0x44879f||_0x44879f===_0x3014e6(0x230))return;await telegramBotService_1[_0x3014e6(0x212)][_0x3014e6(0x217)](_0xe3c363[_0x3014e6(0x256)],_0xe3c363,_0x44879f);}catch(_0x86e2d3){console[_0x3014e6(0x224)](_0x3014e6(0x1e2),_0x86e2d3);}}async[a35_0x38524a(0x222)](_0x3eb9be){const _0x26449e=a35_0x38524a,_0x56bbf8=await database_1[_0x26449e(0x1d6)][_0x26449e(0x253)]['findUnique']({'where':{'id':_0x3eb9be},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x56bbf8)throw new Error(_0x26449e(0x23b));if(_0x56bbf8[_0x26449e(0x1fd)]!=='cointopay')throw new Error(_0x26449e(0x232));await this['checkSinglePayment'](_0x56bbf8);}['getServiceStats'](){const _0x344ff0=a35_0x38524a,_0x277e43=this[_0x344ff0(0x235)]?this[_0x344ff0(0x1e5)]:undefined;return{'isActive':!!this[_0x344ff0(0x235)],'checkIntervalMinutes':this[_0x344ff0(0x1e5)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'nextCheckIn':_0x277e43};}}exports[a35_0x38524a(0x201)]=CoinToPayStatusService,exports[a35_0x38524a(0x211)]=new CoinToPayStatusService();