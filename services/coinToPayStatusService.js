'use strict';const a40_0x4d2c31=a40_0x3c08;(function(_0x233bac,_0x537c73){const _0x7ed48c=a40_0x3c08,_0x255114=_0x233bac();while(!![]){try{const _0x111d2e=parseInt(_0x7ed48c(0x15a))/0x1*(-parseInt(_0x7ed48c(0x219))/0x2)+-parseInt(_0x7ed48c(0x1db))/0x3*(-parseInt(_0x7ed48c(0x1dd))/0x4)+parseInt(_0x7ed48c(0x185))/0x5*(parseInt(_0x7ed48c(0x1d6))/0x6)+parseInt(_0x7ed48c(0x1fe))/0x7+-parseInt(_0x7ed48c(0x1ea))/0x8*(-parseInt(_0x7ed48c(0x212))/0x9)+parseInt(_0x7ed48c(0x1af))/0xa*(-parseInt(_0x7ed48c(0x19b))/0xb)+-parseInt(_0x7ed48c(0x188))/0xc;if(_0x111d2e===_0x537c73)break;else _0x255114['push'](_0x255114['shift']());}catch(_0x2be852){_0x255114['push'](_0x255114['shift']());}}}(a40_0x5ed4,0xcb0dc));var __importDefault=this&&this[a40_0x4d2c31(0x172)]||function(_0x12b5f8){return _0x12b5f8&&_0x12b5f8['__esModule']?_0x12b5f8:{'default':_0x12b5f8};};Object[a40_0x4d2c31(0x1cb)](exports,a40_0x4d2c31(0x157),{'value':!![]}),exports[a40_0x4d2c31(0x184)]=exports[a40_0x4d2c31(0x1bf)]=void 0x0;const coinToPayService_1=require(a40_0x4d2c31(0x12f)),coinToPay2Service_1=require(a40_0x4d2c31(0x1fa)),gateway_1=require(a40_0x4d2c31(0x204)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a40_0x4d2c31(0x1f5)),loggerService_1=require(a40_0x4d2c31(0x13f)),currencyService_1=require('./currencyService');function a40_0x5ed4(){const _0x585650=['has','defineProperty','Failed\x20to\x20mark\x20payment\x20as\x20expired','iban','from','toFixed','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','createdAt','currencyService','💰\x20[CHECK]\x20Payment\x20','toISOString','error','3110772CaCBrB','findMany','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20in\x20shop\x20','paymentLink','495jXgvbB','currency','23404ICbAuM',',\x20clearing\x20individual\x20timers','\x20initial\x20timers\x20for\x20payment\x20','\x20to\x20','CoinToPay2Service','not\x20found','\x20to\x20clear','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','webhookUrl','\x20\x20\x20-\x20ShopId:\x20','delay','\x20days\x20without\x20payment\x20confirmation','transactionId','7608pQmDZu','status','🔍\x20[CHECK]\x20Checking\x20','application/json','map','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','toLowerCase','coinToPay2Service','expired','customerName','✅\x20[EXPIRY]\x20Payment\x20','./telegramBotService','2\x20minutes','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','convertToUSDT','failed','./gateways/coinToPay2Service','cointopay2','getGatewayCommission','\x20found:','3303888awAQdi','getTime','size','values','\x20status\x20is\x20','entries','../types/gateway','5\x20minutes','\x20updated\x20successfully','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','paymentDetails','✅\x20[HOURLY]\x20Payment\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','1\x20minute','checkSinglePaymentById','auto_expire',',\x20currentPayments=','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','payment.success','timers','6948YGOKJw','adminNotes','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','status_check','gateway','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','69686uVykIn','catch','length','\x20\x20\x20Amount:\x20','findUnique','amount','create','\x20pending\x20CoinToPay\x20payments','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','created','\x20details:','\x20not\x20found\x20in\x20database','startPeriodicStatusCheck','-day\x20timeout','FAILED','\x20timers\x20for\x20payment\x20','checkSinglePayment','message','\x20is\x20older\x20than\x20','loggerService','paymentLinkId','\x20expired\x20CoinToPay\x20payments','sendPaymentNotification','\x20\x20\x20📅\x20Time:\x20','./gateways/coinToPayService','📊\x20[CHECK]\x20Payment\x20',':\x20type=','commission','customerEmail','📊\x20[HOURLY]\x20Payment\x20','paid','logShopWebhookSent','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20\x20\x20-\x20Amount:\x20','clearPaymentTimers','webhookLog','\x20status\x20changed\x20to\x20','COMPLETED','push','./loggerService','⏰\x20[GLOBAL]\x20Found\x20','✅\x20[CHECK]\x20Payment\x20','Bank\x20Details:\x20','shopId','gatewaySettings','log','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20\x20\x20-\x20paymentId:\x20','parse','\x20\x20\x20📍\x20Source:\x20','sendShopWebhook','set','amountUSDT','settings','globalCheckInterval','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20updated:\x20currentPayments=','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','PENDING','\x20\x20\x20📝\x20Details:','\x20with\x20status\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','checkAllPendingPayments','__esModule','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','5xgPASn','default','update','schedule_created','logWhiteDomainError','\x20(age:\x20','EXPIRY_DAYS','⏰\x20[GLOBAL]\x20Payment\x20','GLOBAL_CHECK_INTERVAL_MS','gatewayPaymentId','getServiceStats','webhookEvents','cointopay','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20is\x20too\x20new\x20(','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20\x20\x20📊\x20Status:\x20','floor','📈\x20[COINTOPAY]\x20Payment\x20','\x20not\x20found,\x20clearing\x20timers','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','text','gatewayOrderId','Gateway\x20','__importDefault','\x20days','PAID','logShopWebhookError','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20commission:\x20','includes','confirmedOn','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','bankDetails','\x20\x20\x20-\x20Status:\x20','\x20USDT','payment','get','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','coinToPayStatusService','5gimeQU','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','🧹\x20[DEBUG]\x20Clearing\x20','2904516pzBLhl','checkExpiredPayments','unknown','stopPeriodicStatusCheck','paymentTimers','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','\x20\x20\x20❌\x20Error:\x20','ms)','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20',',\x20stopping\x20individual\x20checks','Webhook\x20event\x20','cointopay_status_check_error','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','paidAt','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','orderId','description','\x20->\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','32307HiSpGU','\x20individual\x20payment\x20timers','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','\x20\x20\x20Gateway\x20','gatewayCommissionRate','\x20for\x20payment\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','CoinToPayService','cointopay_auto_expired','\x20in\x20','\x20completed\x20for\x20payment\x20','now','stringify','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20not\x20enabled\x20for\x20shop\x20','coinToPayService','\x20\x20\x20Amount\x20after\x20commission:\x20',',\x20status=','forEach','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','4910hHDpdC','timestamp','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','checkPaymentStatus','✅\x20[COINTOPAY]\x20Payment\x20link\x20','createdOn','shop','h),\x20skipping\x20global\x20check','EXPIRED','logCoinToPayError','sendPaymentStatusNotification','⚠️\x20[CHECK]\x20Payment\x20','\x20triggered\x20for\x20payment\x20','Payment\x20older\x20than\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','type','CoinToPayStatusService','logCoinToPayStatus','Failed\x20to\x20send\x20shop\x20webhook:','stack','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20payment\x20','SINGLE','payment.failed','\x20current\x20status:\x20','\x20status:\x20','COINTOPAY_ERROR'];a40_0x5ed4=function(){return _0x585650;};return a40_0x5ed4();}class CoinToPayStatusService{constructor(){const _0x1497c5=a40_0x4d2c31;this['globalCheckInterval']=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x1497c5(0x160)]=0x5,this[_0x1497c5(0x18c)]=new Map(),this[_0x1497c5(0x1aa)]=new coinToPayService_1[(_0x1497c5(0x1a2))](),this[_0x1497c5(0x1f1)]=new coinToPay2Service_1[(_0x1497c5(0x1e1))](),console[_0x1497c5(0x145)](_0x1497c5(0x18d));}['schedulePaymentChecks'](_0xb44a0,_0x110c43){const _0xfc1815=a40_0x4d2c31;console[_0xfc1815(0x145)](_0xfc1815(0x1b1)),console[_0xfc1815(0x145)](_0xfc1815(0x147)+_0xb44a0),console[_0xfc1815(0x145)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x110c43),this[_0xfc1815(0x13a)](_0xb44a0);const _0x587031=[],_0xa351d8=new Date(),_0x5cbe78=[{'delay':0x1*0x3c*0x3e8,'description':_0xfc1815(0x20b)},{'delay':0x2*0x3c*0x3e8,'description':_0xfc1815(0x1f6)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0xfc1815(0x205)}];console[_0xfc1815(0x145)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x5cbe78[_0xfc1815(0x21b)]+_0xfc1815(0x1df)+_0xb44a0);let _0xdd1f3c=0x0;_0x5cbe78['forEach']((_0x4ba7e4,_0x3bdd0b)=>{const _0x5058a9=_0xfc1815;_0xdd1f3c+=_0x4ba7e4[_0x5058a9(0x1e7)];const _0x70554=setTimeout(async()=>{const _0x5afe93=_0x5058a9;console[_0x5afe93(0x145)](_0x5afe93(0x177)+(_0x3bdd0b+0x1)+_0x5afe93(0x1bb)+_0xb44a0+'\x20(after\x20'+_0x4ba7e4[_0x5afe93(0x198)]+')');try{await this[_0x5afe93(0x20c)](_0xb44a0),console[_0x5afe93(0x145)]('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x3bdd0b+0x1)+_0x5afe93(0x1a5)+_0xb44a0);}catch(_0x3918a4){console['error']('❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x3bdd0b+0x1)+_0x5afe93(0x1a0)+_0xb44a0+':',_0x3918a4),this['logCoinToPayError'](_0xb44a0,_0x110c43,_0x3918a4,_0x5afe93(0x216),{'checkNumber':_0x3bdd0b+0x1,'scheduledAfter':_0x4ba7e4[_0x5afe93(0x198)],'isIndividualCheck':!![]});}},_0xdd1f3c);_0x587031[_0x5058a9(0x13e)](_0x70554),console[_0x5058a9(0x145)](_0x5058a9(0x20f)+(_0x3bdd0b+0x1)+'\x20for\x20payment\x20'+_0xb44a0+_0x5058a9(0x1a4)+_0xdd1f3c/0x3e8+'\x20seconds\x20('+_0x4ba7e4[_0x5058a9(0x198)]+')');});const _0x553bc7=setInterval(async()=>{const _0x13c303=_0xfc1815;console[_0x13c303(0x145)]('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0xb44a0);try{const _0x1564cb=await database_1[_0x13c303(0x15b)][_0x13c303(0x181)]['findUnique']({'where':{'id':_0xb44a0},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x1564cb){console[_0x13c303(0x145)]('❌\x20[HOURLY]\x20Payment\x20'+_0xb44a0+_0x13c303(0x16d)),this['clearPaymentTimers'](_0xb44a0);return;}console[_0x13c303(0x145)](_0x13c303(0x134)+_0xb44a0+_0x13c303(0x1c7)+_0x1564cb[_0x13c303(0x1eb)]);if(_0x1564cb[_0x13c303(0x1eb)]!=='PENDING'){console[_0x13c303(0x145)](_0x13c303(0x209)+_0xb44a0+_0x13c303(0x202)+_0x1564cb[_0x13c303(0x1eb)]+_0x13c303(0x191)),this[_0x13c303(0x13a)](_0xb44a0);return;}const _0x16700f=Math[_0x13c303(0x16b)]((Date[_0x13c303(0x1a6)]()-_0x1564cb[_0x13c303(0x1d1)][_0x13c303(0x1ff)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x16700f>=this['EXPIRY_DAYS']){console['log']('⏰\x20[HOURLY]\x20Payment\x20'+_0xb44a0+_0x13c303(0x129)+this[_0x13c303(0x160)]+_0x13c303(0x1ef)),this[_0x13c303(0x13a)](_0xb44a0);return;}await this[_0x13c303(0x20c)](_0xb44a0),console['log'](_0x13c303(0x1bd)+_0xb44a0);}catch(_0x33e244){console[_0x13c303(0x1d5)](_0x13c303(0x137)+_0xb44a0+':',_0x33e244),this[_0x13c303(0x1b8)](_0xb44a0,_0x110c43,_0x33e244,_0x13c303(0x216),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x587031[_0xfc1815(0x13e)](_0x553bc7),this[_0xfc1815(0x18c)][_0xfc1815(0x14b)](_0xb44a0,{'timers':_0x587031,'paymentId':_0xb44a0,'gatewayPaymentId':_0x110c43,'createdAt':_0xa351d8}),console[_0xfc1815(0x145)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x5cbe78[_0xfc1815(0x21b)]+_0xfc1815(0x1e4)+_0xb44a0),console[_0xfc1815(0x145)](_0xfc1815(0x190)+this['paymentTimers']['size']),this['logCoinToPayStatus'](_0xb44a0,_0x110c43,'PENDING',_0xfc1815(0x152),'status_check',{'action':_0xfc1815(0x15d),'scheduledChecks':_0x5cbe78[_0xfc1815(0x21b)],'firstCheckIn':_0x5cbe78[0x0]['delay']/0x3e8,'totalTimers':this[_0xfc1815(0x18c)][_0xfc1815(0x200)]});}[a40_0x4d2c31(0x13a)](_0x3decfb){const _0x5586ed=a40_0x4d2c31,_0x12c9e2=this[_0x5586ed(0x18c)][_0x5586ed(0x182)](_0x3decfb);_0x12c9e2?(console[_0x5586ed(0x145)](_0x5586ed(0x187)+_0x12c9e2['timers']['length']+_0x5586ed(0x228)+_0x3decfb),_0x12c9e2[_0x5586ed(0x211)][_0x5586ed(0x1ad)]((_0x74c032,_0x2e3715)=>{const _0x1ac685=_0x5586ed;_0x74c032&&(clearTimeout(_0x74c032),clearInterval(_0x74c032),console[_0x1ac685(0x145)](_0x1ac685(0x167)+(_0x2e3715+0x1)+_0x1ac685(0x1a0)+_0x3decfb));}),this[_0x5586ed(0x18c)]['delete'](_0x3decfb),console[_0x5586ed(0x145)](_0x5586ed(0x207)+_0x3decfb+'.\x20Remaining\x20active\x20timers:\x20'+this['paymentTimers'][_0x5586ed(0x200)])):console[_0x5586ed(0x145)]('⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x3decfb+_0x5586ed(0x1e3));}async[a40_0x4d2c31(0x20c)](_0x54bc15){const _0x178ac9=a40_0x4d2c31;console[_0x178ac9(0x145)](_0x178ac9(0x1f7)+_0x54bc15);const _0x12fc89=await database_1[_0x178ac9(0x15b)]['payment'][_0x178ac9(0x21d)]({'where':{'id':_0x54bc15},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x12fc89){console['log']('❌\x20[CHECK]\x20Payment\x20'+_0x54bc15+_0x178ac9(0x224));return;}console[_0x178ac9(0x145)](_0x178ac9(0x130)+_0x54bc15+_0x178ac9(0x1fd)),console[_0x178ac9(0x145)]('\x20\x20\x20-\x20Gateway:\x20'+_0x12fc89[_0x178ac9(0x217)]),console['log'](_0x178ac9(0x17f)+_0x12fc89['status']),console['log'](_0x178ac9(0x14f)+_0x12fc89['gatewayPaymentId']),console[_0x178ac9(0x145)](_0x178ac9(0x139)+_0x12fc89['amount']+'\x20'+_0x12fc89[_0x178ac9(0x1dc)]),console['log'](_0x178ac9(0x1e6)+_0x12fc89[_0x178ac9(0x143)]);if(_0x12fc89[_0x178ac9(0x217)]!==_0x178ac9(0x166)&&_0x12fc89[_0x178ac9(0x217)]!==_0x178ac9(0x1fb)){console[_0x178ac9(0x145)](_0x178ac9(0x1ba)+_0x54bc15+'\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20'+_0x12fc89[_0x178ac9(0x217)]+')');return;}if(_0x12fc89[_0x178ac9(0x1eb)]!==_0x178ac9(0x152)){console[_0x178ac9(0x145)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x54bc15+'\x20status\x20is\x20'+_0x12fc89[_0x178ac9(0x1eb)]+_0x178ac9(0x191)),this[_0x178ac9(0x13a)](_0x54bc15);return;}if(!_0x12fc89[_0x178ac9(0x163)]){console['log'](_0x178ac9(0x1ba)+_0x54bc15+'\x20has\x20no\x20gatewayPaymentId');return;}console['log'](_0x178ac9(0x141)+_0x54bc15+_0x178ac9(0x1c3)),await this['checkSinglePayment'](_0x12fc89);}['logCoinToPayStatus'](_0xd9b7b2,_0x167f99,_0x14fbbd,_0x5b3713,_0x355b80,_0x30e2d4){const _0x146878=a40_0x4d2c31,_0x23180f={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0xd9b7b2,'gatewayPaymentId':_0x167f99,'oldStatus':_0x14fbbd,'newStatus':_0x5b3713,'source':_0x355b80,'timestamp':new Date()['toISOString'](),'details':_0x30e2d4||{}};loggerService_1[_0x146878(0x12a)][_0x146878(0x1c0)](_0x23180f),console[_0x146878(0x145)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0xd9b7b2+'\x20('+_0x167f99+')'),console[_0x146878(0x145)](_0x146878(0x16a)+_0x14fbbd+_0x146878(0x199)+_0x5b3713),console[_0x146878(0x145)](_0x146878(0x149)+_0x355b80),console[_0x146878(0x145)](_0x146878(0x12e)+_0x23180f[_0x146878(0x1b0)]),_0x30e2d4&&console['log'](_0x146878(0x153),_0x30e2d4);}[a40_0x4d2c31(0x1b8)](_0x2d31ac,_0x38ffca,_0x4e1ead,_0x13f29d,_0x3b66dd){const _0x3add47=a40_0x4d2c31,_0x43228e={'type':_0x3add47(0x1c9),'paymentId':_0x2d31ac,'gatewayPaymentId':_0x38ffca,'error':_0x4e1ead instanceof Error?{'message':_0x4e1ead[_0x3add47(0x128)],'stack':_0x4e1ead[_0x3add47(0x1c2)]}:_0x4e1ead,'source':_0x13f29d,'timestamp':new Date()[_0x3add47(0x1d4)](),'context':_0x3b66dd||{}};loggerService_1['loggerService'][_0x3add47(0x1b8)](_0x43228e),console[_0x3add47(0x1d5)](_0x3add47(0x1a1)+_0x2d31ac+'\x20('+_0x38ffca+')'),console['error'](_0x3add47(0x18e)+(_0x4e1ead instanceof Error?_0x4e1ead[_0x3add47(0x128)]:_0x4e1ead)),console['error'](_0x3add47(0x149)+_0x13f29d),console[_0x3add47(0x1d5)](_0x3add47(0x12e)+_0x43228e[_0x3add47(0x1b0)]),_0x3b66dd&&console[_0x3add47(0x1d5)]('\x20\x20\x20📝\x20Context:',_0x3b66dd);}[a40_0x4d2c31(0x225)](){const _0x396b14=a40_0x4d2c31;console[_0x396b14(0x145)](_0x396b14(0x194)),this[_0x396b14(0x156)]()[_0x396b14(0x21a)](_0x597b9c=>{const _0xf73ce3=_0x396b14;console['error'](_0xf73ce3(0x214),_0x597b9c);}),this[_0x396b14(0x14e)]=setInterval(async()=>{const _0x54f223=_0x396b14;try{console[_0x54f223(0x145)]('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x54f223(0x156)](),console[_0x54f223(0x145)](_0x54f223(0x221));}catch(_0x7b3d6f){console[_0x54f223(0x1d5)]('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x7b3d6f);}},this[_0x396b14(0x162)]),console[_0x396b14(0x145)](_0x396b14(0x146));}[a40_0x4d2c31(0x18b)](){const _0x6a7e26=a40_0x4d2c31;console['log'](_0x6a7e26(0x19a));this[_0x6a7e26(0x14e)]&&(clearInterval(this[_0x6a7e26(0x14e)]),this[_0x6a7e26(0x14e)]=null,console[_0x6a7e26(0x145)](_0x6a7e26(0x16e)));const _0x40b0fc=this[_0x6a7e26(0x18c)]['size'];for(const [_0x5a9793]of this[_0x6a7e26(0x18c)]){this[_0x6a7e26(0x13a)](_0x5a9793);}console['log']('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x40b0fc+_0x6a7e26(0x19c));}async[a40_0x4d2c31(0x156)](){const _0x2107c7=a40_0x4d2c31;try{console[_0x2107c7(0x145)](_0x2107c7(0x1a8));const _0x4a1de2=await database_1[_0x2107c7(0x15b)][_0x2107c7(0x181)][_0x2107c7(0x1d7)]({'where':{'gateway':{'in':['cointopay',_0x2107c7(0x1fb)]},'status':_0x2107c7(0x152),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x2107c7(0x145)]('🪙\x20[GLOBAL]\x20Found\x20'+_0x4a1de2[_0x2107c7(0x21b)]+_0x2107c7(0x220));if(_0x4a1de2[_0x2107c7(0x21b)]===0x0){console[_0x2107c7(0x145)](_0x2107c7(0x196));return;}const _0x3cff3d=await this['checkExpiredPayments'](_0x4a1de2);console[_0x2107c7(0x145)](_0x2107c7(0x140)+_0x3cff3d[_0x2107c7(0x21b)]+_0x2107c7(0x12c));let _0x4f8067=0x0,_0x52080f=0x0;for(const _0x397d98 of _0x4a1de2){try{if(_0x3cff3d['includes'](_0x397d98['id'])){console[_0x2107c7(0x145)](_0x2107c7(0x161)+_0x397d98['id']+_0x2107c7(0x159)),_0x52080f++;continue;}if(this['paymentTimers'][_0x2107c7(0x1ca)](_0x397d98['id'])){console[_0x2107c7(0x145)](_0x2107c7(0x161)+_0x397d98['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x52080f++;continue;}const _0x3aa676=(Date[_0x2107c7(0x1a6)]()-_0x397d98[_0x2107c7(0x1d1)][_0x2107c7(0x1ff)]())/(0x3e8*0x3c*0x3c);if(_0x3aa676<0x1){console['log'](_0x2107c7(0x161)+_0x397d98['id']+_0x2107c7(0x168)+_0x3aa676[_0x2107c7(0x1cf)](0x1)+_0x2107c7(0x1b6)),_0x52080f++;continue;}console[_0x2107c7(0x145)](_0x2107c7(0x183)+_0x397d98['id']+_0x2107c7(0x15f)+_0x3aa676[_0x2107c7(0x1cf)](0x1)+'h)'),await this[_0x2107c7(0x127)](_0x397d98),_0x4f8067++,await new Promise(_0x41ffb2=>setTimeout(_0x41ffb2,0x7d0));}catch(_0x4bbea6){console['error']('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x397d98['id']+':',_0x4bbea6),this[_0x2107c7(0x1b8)](_0x397d98['id'],_0x397d98[_0x2107c7(0x163)]||_0x2107c7(0x18a),_0x4bbea6,_0x2107c7(0x216),{'isGlobalCheck':!![],'paymentAmount':_0x397d98[_0x2107c7(0x21e)],'paymentCurrency':_0x397d98[_0x2107c7(0x1dc)],'shopId':_0x397d98[_0x2107c7(0x143)],'createdAt':_0x397d98[_0x2107c7(0x1d1)]}),loggerService_1[_0x2107c7(0x12a)][_0x2107c7(0x15e)](_0x2107c7(0x166),'/status/'+_0x397d98[_0x2107c7(0x163)],_0x4bbea6);}}console['log'](_0x2107c7(0x138)+_0x4f8067+'\x20checked,\x20'+_0x52080f+'\x20skipped,\x20'+_0x3cff3d[_0x2107c7(0x21b)]+'\x20expired');}catch(_0xc36e1d){console[_0x2107c7(0x1d5)](_0x2107c7(0x218),_0xc36e1d);}}async[a40_0x4d2c31(0x189)](_0x5351da){const _0x45471d=a40_0x4d2c31,_0x2f4027=[],_0x8b8094=new Date();_0x8b8094['setDate'](_0x8b8094['getDate']()-this[_0x45471d(0x160)]),console[_0x45471d(0x145)](_0x45471d(0x155)+this[_0x45471d(0x160)]+'\x20days\x20(created\x20before\x20'+_0x8b8094[_0x45471d(0x1d4)]()+')');for(const _0x277333 of _0x5351da){if(_0x277333[_0x45471d(0x1d1)]<_0x8b8094){console[_0x45471d(0x145)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x277333['id']+_0x45471d(0x129)+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{this['logCoinToPayStatus'](_0x277333['id'],_0x277333[_0x45471d(0x163)]||'unknown',_0x45471d(0x152),'EXPIRED','auto_expire',{'reason':_0x45471d(0x1bc)+this[_0x45471d(0x160)]+_0x45471d(0x173),'createdAt':_0x277333[_0x45471d(0x1d1)],'daysSinceCreation':Math['floor']((Date['now']()-_0x277333[_0x45471d(0x1d1)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x277333['amount'],'paymentCurrency':_0x277333[_0x45471d(0x1dc)],'shopId':_0x277333[_0x45471d(0x143)]}),await database_1[_0x45471d(0x15b)]['payment'][_0x45471d(0x15c)]({'where':{'id':_0x277333['id']},'data':{'status':_0x45471d(0x1b7),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x45471d(0x160)]+_0x45471d(0x1e8)}}),await database_1['default'][_0x45471d(0x13b)]['create']({'data':{'paymentId':_0x277333['id'],'shopId':_0x277333[_0x45471d(0x143)],'event':_0x45471d(0x1a3),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x45471d(0x1bc)+this[_0x45471d(0x160)]+_0x45471d(0x173),'createdAt':_0x277333[_0x45471d(0x1d1)],'expiredAt':new Date()[_0x45471d(0x1d4)](),'daysSinceCreation':Math[_0x45471d(0x16b)]((Date[_0x45471d(0x1a6)]()-_0x277333['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x45471d(0x14a)](_0x277333,_0x45471d(0x1b7)),await this[_0x45471d(0x1b9)](_0x277333,_0x45471d(0x1b7)),this['clearPaymentTimers'](_0x277333['id']),_0x2f4027[_0x45471d(0x13e)](_0x277333['id']),console[_0x45471d(0x145)](_0x45471d(0x1f4)+_0x277333['id']+_0x45471d(0x1d8)+this['EXPIRY_DAYS']+_0x45471d(0x226));}catch(_0x57bd53){console['error']('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x277333['id']+':',_0x57bd53),this['logCoinToPayError'](_0x277333['id'],_0x277333[_0x45471d(0x163)]||_0x45471d(0x18a),_0x57bd53,_0x45471d(0x20d),{'reason':_0x45471d(0x1cc),'createdAt':_0x277333[_0x45471d(0x1d1)],'daysSinceCreation':Math[_0x45471d(0x16b)]((Date[_0x45471d(0x1a6)]()-_0x277333['createdAt'][_0x45471d(0x1ff)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x2f4027;}async[a40_0x4d2c31(0x127)](_0x5e57eb){const _0x31fba3=a40_0x4d2c31;if(!_0x5e57eb[_0x31fba3(0x163)]){console['log'](_0x31fba3(0x1ba)+_0x5e57eb['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x31fba3(0x145)](_0x31fba3(0x1ec)+_0x5e57eb[_0x31fba3(0x217)]+_0x31fba3(0x1c4)+_0x5e57eb['id']+'\x20('+_0x5e57eb[_0x31fba3(0x163)]+')');try{let _0x12a256;_0x5e57eb['gateway']===_0x31fba3(0x1fb)?(_0x12a256=await this[_0x31fba3(0x1f1)][_0x31fba3(0x1b2)](_0x5e57eb[_0x31fba3(0x163)]),console[_0x31fba3(0x145)](_0x31fba3(0x1d0)+_0x5e57eb['id']+_0x31fba3(0x1c8)+_0x12a256['status'])):(_0x12a256=await this['coinToPayService'][_0x31fba3(0x1b2)](_0x5e57eb[_0x31fba3(0x163)]),console[_0x31fba3(0x145)](_0x31fba3(0x169)+_0x5e57eb['id']+_0x31fba3(0x1c8)+_0x12a256[_0x31fba3(0x1eb)]));_0x12a256[_0x31fba3(0x208)]&&console[_0x31fba3(0x145)](_0x31fba3(0x130)+_0x5e57eb['id']+_0x31fba3(0x223),{'iban':_0x12a256['paymentDetails'][_0x31fba3(0x1cd)]||_0x31fba3(0x1e2),'transactionId':_0x12a256[_0x31fba3(0x208)][_0x31fba3(0x1e9)],'createdOn':_0x12a256[_0x31fba3(0x208)][_0x31fba3(0x1b4)],'confirmedOn':_0x12a256[_0x31fba3(0x208)][_0x31fba3(0x17c)]||'not\x20confirmed'});if(_0x12a256[_0x31fba3(0x1eb)]!==_0x5e57eb['status']){console[_0x31fba3(0x145)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x5e57eb['id']+'\x20status\x20from\x20'+_0x5e57eb[_0x31fba3(0x1eb)]+_0x31fba3(0x1e0)+_0x12a256[_0x31fba3(0x1eb)]),this[_0x31fba3(0x1c0)](_0x5e57eb['id'],_0x5e57eb[_0x31fba3(0x163)],_0x5e57eb['status'],_0x12a256[_0x31fba3(0x1eb)],'status_check',{'paymentDetails':_0x12a256['paymentDetails'],'amount':_0x12a256[_0x31fba3(0x21e)],'currency':_0x12a256[_0x31fba3(0x1dc)],'shopId':_0x5e57eb[_0x31fba3(0x143)],'checkTimestamp':new Date()[_0x31fba3(0x1d4)]()});const _0x47f037={'status':_0x12a256['status'],'updatedAt':new Date()};if(_0x12a256[_0x31fba3(0x1eb)]===_0x31fba3(0x174)&&_0x5e57eb[_0x31fba3(0x1eb)]!==_0x31fba3(0x174)){_0x47f037[_0x31fba3(0x195)]=new Date();if(!_0x5e57eb[_0x31fba3(0x14c)]){const _0xab97a=await currencyService_1[_0x31fba3(0x1d2)][_0x31fba3(0x1f8)](_0x5e57eb[_0x31fba3(0x21e)],_0x5e57eb[_0x31fba3(0x1dc)]);_0x47f037[_0x31fba3(0x14c)]=_0xab97a;const _0xf3cab3=await this[_0x31fba3(0x1fc)](_0x5e57eb['shopId'],_0x5e57eb[_0x31fba3(0x217)]),_0x56550b=_0xab97a*(0x1-_0xf3cab3/0x64);_0x47f037['amountAfterGatewayCommissionUSDT']=_0x56550b,_0x47f037[_0x31fba3(0x19f)]=_0xf3cab3,console[_0x31fba3(0x145)](_0x31fba3(0x1d3)+_0x5e57eb['id']+'\x20amounts\x20calculated:'),console[_0x31fba3(0x145)](_0x31fba3(0x21c)+_0x5e57eb['amount']+'\x20'+_0x5e57eb['currency']+'\x20->\x20'+_0xab97a[_0x31fba3(0x1cf)](0x6)+_0x31fba3(0x180)),console[_0x31fba3(0x145)](_0x31fba3(0x19e)+_0x5e57eb['gateway']+_0x31fba3(0x17a)+_0xf3cab3+'%'),console['log'](_0x31fba3(0x1ab)+_0x56550b[_0x31fba3(0x1cf)](0x6)+'\x20USDT');}console[_0x31fba3(0x145)](_0x31fba3(0x1d3)+_0x5e57eb['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x47f037['paidAt']['toISOString']());}if(_0x12a256[_0x31fba3(0x208)]){const _0x1bfa57=_0x12a256[_0x31fba3(0x208)];_0x1bfa57[_0x31fba3(0x1cd)]&&(_0x47f037['remitterIban']=_0x1bfa57['iban'],console[_0x31fba3(0x145)](_0x31fba3(0x179)+_0x1bfa57[_0x31fba3(0x1cd)]));if(_0x1bfa57[_0x31fba3(0x17e)]){const _0x3d7299=_0x5e57eb[_0x31fba3(0x213)]||'',_0x1f0271=_0x31fba3(0x142)+_0x1bfa57[_0x31fba3(0x17e)];_0x47f037[_0x31fba3(0x213)]=_0x3d7299?_0x3d7299+'\x0a\x0a'+_0x1f0271:_0x1f0271,console[_0x31fba3(0x145)](_0x31fba3(0x178));}_0x1bfa57[_0x31fba3(0x1e9)]&&console[_0x31fba3(0x145)](_0x31fba3(0x20a)+_0x1bfa57[_0x31fba3(0x1e9)]),_0x1bfa57[_0x31fba3(0x17c)]&&console[_0x31fba3(0x145)](_0x31fba3(0x215)+_0x1bfa57['confirmedOn']);}await database_1[_0x31fba3(0x15b)]['payment'][_0x31fba3(0x15c)]({'where':{'id':_0x5e57eb['id']},'data':_0x47f037});if(_0x12a256[_0x31fba3(0x1eb)]===_0x31fba3(0x174)&&_0x5e57eb[_0x31fba3(0x1eb)]!==_0x31fba3(0x174)){console[_0x31fba3(0x145)](_0x31fba3(0x16c)+_0x5e57eb['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x463bdc=await database_1[_0x31fba3(0x15b)][_0x31fba3(0x181)][_0x31fba3(0x21d)]({'where':{'id':_0x5e57eb['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x463bdc?.[_0x31fba3(0x12b)]&&_0x463bdc[_0x31fba3(0x1da)])try{const _0x1466f2=_0x463bdc[_0x31fba3(0x1da)];console[_0x31fba3(0x145)]('📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x1466f2['id']+_0x31fba3(0x131)+_0x1466f2['type']+_0x31fba3(0x20e)+_0x1466f2['currentPayments']+',\x20status='+_0x1466f2[_0x31fba3(0x1eb)]);const _0x48718c=_0x1466f2['currentPayments']+0x1,_0x1ed27c=_0x1466f2[_0x31fba3(0x1be)]===_0x31fba3(0x1c5)?_0x31fba3(0x13d):_0x1466f2[_0x31fba3(0x1eb)];await database_1[_0x31fba3(0x15b)][_0x31fba3(0x1da)][_0x31fba3(0x15c)]({'where':{'id':_0x1466f2['id']},'data':{'currentPayments':_0x48718c,'status':_0x1ed27c,'updatedAt':new Date()}}),console[_0x31fba3(0x145)](_0x31fba3(0x1b3)+_0x1466f2['id']+_0x31fba3(0x150)+_0x1466f2['currentPayments']+'\x20->\x20'+_0x48718c+_0x31fba3(0x1ac)+_0x1466f2['status']+'\x20->\x20'+_0x1ed27c);}catch(_0x3dc3e9){console[_0x31fba3(0x1d5)](_0x31fba3(0x19d),_0x3dc3e9);}else console[_0x31fba3(0x145)]('📈\x20[COINTOPAY]\x20Payment\x20'+_0x5e57eb['id']+_0x31fba3(0x17d));}await database_1['default'][_0x31fba3(0x13b)][_0x31fba3(0x21f)]({'data':{'paymentId':_0x5e57eb['id'],'shopId':_0x5e57eb[_0x31fba3(0x143)],'event':'cointopay_status_check_'+_0x12a256[_0x31fba3(0x1eb)][_0x31fba3(0x1f0)](),'statusCode':0xc8,'responseBody':JSON[_0x31fba3(0x1a7)]({'oldStatus':_0x5e57eb[_0x31fba3(0x1eb)],'newStatus':_0x12a256[_0x31fba3(0x1eb)],'paymentDetails':_0x12a256['paymentDetails'],'checkedAt':new Date()[_0x31fba3(0x1d4)]()})}}),await this['sendShopWebhook'](_0x5e57eb,_0x12a256[_0x31fba3(0x1eb)]),await this[_0x31fba3(0x1b9)](_0x5e57eb,_0x12a256[_0x31fba3(0x1eb)]),_0x12a256[_0x31fba3(0x1eb)]!=='PENDING'&&(console[_0x31fba3(0x145)]('🧹\x20[CHECK]\x20Payment\x20'+_0x5e57eb['id']+_0x31fba3(0x13c)+_0x12a256[_0x31fba3(0x1eb)]+_0x31fba3(0x1de)),this[_0x31fba3(0x13a)](_0x5e57eb['id'])),console['log'](_0x31fba3(0x141)+_0x5e57eb['id']+_0x31fba3(0x206));}else console[_0x31fba3(0x145)](_0x31fba3(0x130)+_0x5e57eb['id']+'\x20status\x20unchanged\x20('+_0x12a256[_0x31fba3(0x1eb)]+')'),this[_0x31fba3(0x1c0)](_0x5e57eb['id'],_0x5e57eb['gatewayPaymentId'],_0x5e57eb[_0x31fba3(0x1eb)],_0x12a256[_0x31fba3(0x1eb)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x12a256[_0x31fba3(0x208)],'amount':_0x12a256[_0x31fba3(0x21e)],'currency':_0x12a256[_0x31fba3(0x1dc)],'shopId':_0x5e57eb[_0x31fba3(0x143)],'checkTimestamp':new Date()[_0x31fba3(0x1d4)]()});}catch(_0x3f4cd1){console[_0x31fba3(0x1d5)]('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x5e57eb['id']+':',_0x3f4cd1),this[_0x31fba3(0x1b8)](_0x5e57eb['id'],_0x5e57eb[_0x31fba3(0x163)],_0x3f4cd1,_0x31fba3(0x216),{'paymentAmount':_0x5e57eb[_0x31fba3(0x21e)],'paymentCurrency':_0x5e57eb[_0x31fba3(0x1dc)],'shopId':_0x5e57eb[_0x31fba3(0x143)],'createdAt':_0x5e57eb[_0x31fba3(0x1d1)]}),await database_1[_0x31fba3(0x15b)]['webhookLog'][_0x31fba3(0x21f)]({'data':{'paymentId':_0x5e57eb['id'],'shopId':_0x5e57eb[_0x31fba3(0x143)],'event':_0x31fba3(0x193),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x3f4cd1 instanceof Error?_0x3f4cd1[_0x31fba3(0x128)]:'Unknown\x20error','gatewayPaymentId':_0x5e57eb[_0x31fba3(0x163)],'checkedAt':new Date()['toISOString']()})}});}}async[a40_0x4d2c31(0x14a)](_0x28f2fe,_0x3acb19){const _0x399bf5=a40_0x4d2c31,_0xe0e7f5=Date[_0x399bf5(0x1a6)]();try{const _0x1c9512=_0x28f2fe['shop'],_0x435d62=_0x1c9512[_0x399bf5(0x14d)];if(!_0x435d62?.[_0x399bf5(0x1e5)]){console[_0x399bf5(0x145)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1c9512['id']);return;}const _0x5d5c47=_0x3acb19===_0x399bf5(0x174)?_0x399bf5(0x210):_0x3acb19===_0x399bf5(0x227)?_0x399bf5(0x1c6):_0x3acb19==='EXPIRED'?_0x399bf5(0x1c6):'payment.pending';if(!_0x435d62[_0x399bf5(0x165)]?.[_0x399bf5(0x17b)](_0x5d5c47)){console[_0x399bf5(0x145)](_0x399bf5(0x192)+_0x5d5c47+_0x399bf5(0x1a9)+_0x1c9512['id']);return;}const _0x10c80d=(0x0,gateway_1['getGatewayIdByName'])(_0x28f2fe['gateway'])||_0x28f2fe['gateway'],_0x437c16={'event':_0x5d5c47,'payment':{'id':_0x28f2fe['id'],'order_id':_0x28f2fe[_0x399bf5(0x197)],'gateway_order_id':_0x28f2fe[_0x399bf5(0x170)],'gateway':_0x10c80d,'amount':_0x28f2fe[_0x399bf5(0x21e)],'currency':_0x28f2fe[_0x399bf5(0x1dc)],'status':_0x3acb19['toLowerCase'](),'customer_email':_0x28f2fe[_0x399bf5(0x133)],'customer_name':_0x28f2fe[_0x399bf5(0x1f3)],'created_at':_0x28f2fe[_0x399bf5(0x1d1)],'updated_at':new Date()}},_0x1fc29d=await fetch(_0x435d62[_0x399bf5(0x1e5)],{'method':'POST','headers':{'Content-Type':_0x399bf5(0x1ed),'User-Agent':'Payment\x20System/1.0'},'body':JSON[_0x399bf5(0x1a7)](_0x437c16)}),_0x2d1548=Date[_0x399bf5(0x1a6)]()-_0xe0e7f5,_0x176ab6=_0x1fc29d['ok']?'Success':await _0x1fc29d[_0x399bf5(0x16f)]();loggerService_1[_0x399bf5(0x12a)][_0x399bf5(0x136)](_0x28f2fe[_0x399bf5(0x143)],_0x435d62['webhookUrl'],_0x5d5c47,_0x1fc29d[_0x399bf5(0x1eb)],_0x2d1548,_0x437c16),console[_0x399bf5(0x145)]('Shop\x20webhook\x20sent\x20to\x20'+_0x435d62[_0x399bf5(0x1e5)]+_0x399bf5(0x154)+_0x1fc29d[_0x399bf5(0x1eb)]+'\x20('+_0x2d1548+_0x399bf5(0x18f));}catch(_0x1eea4c){console[_0x399bf5(0x1d5)](_0x399bf5(0x1c1),_0x1eea4c),loggerService_1[_0x399bf5(0x12a)][_0x399bf5(0x175)](_0x28f2fe['shopId'],_0x28f2fe['shop']?.[_0x399bf5(0x14d)]?.['webhookUrl']||_0x399bf5(0x18a),'webhook_send',_0x1eea4c,{});}}async['sendPaymentStatusNotification'](_0x5e3110,_0x3ebe54){const _0x387a0b=a40_0x4d2c31;try{const _0x53b0c8={'PENDING':_0x387a0b(0x222),'PAID':_0x387a0b(0x135),'FAILED':_0x387a0b(0x1f9),'EXPIRED':_0x387a0b(0x1f2)},_0x4cf43f=_0x53b0c8[_0x3ebe54];if(!_0x4cf43f||_0x4cf43f===_0x387a0b(0x222))return;await telegramBotService_1['telegramBotService'][_0x387a0b(0x12d)](_0x5e3110[_0x387a0b(0x143)],_0x5e3110,_0x4cf43f);}catch(_0x5e7d6e){console[_0x387a0b(0x1d5)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x5e7d6e);}}async['checkPaymentById'](_0x540945){const _0x328bfe=a40_0x4d2c31;console['log'](_0x328bfe(0x151)+_0x540945);const _0x5cf79a=await database_1[_0x328bfe(0x15b)]['payment']['findUnique']({'where':{'id':_0x540945},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5cf79a)throw new Error('Payment\x20not\x20found');if(_0x5cf79a[_0x328bfe(0x217)]!==_0x328bfe(0x166)&&_0x5cf79a[_0x328bfe(0x217)]!=='cointopay2')throw new Error(_0x328bfe(0x158));console[_0x328bfe(0x145)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20'+_0x5cf79a['gateway']+_0x328bfe(0x1c4)+_0x540945),await this['checkSinglePayment'](_0x5cf79a),console[_0x328bfe(0x145)](_0x328bfe(0x186)+_0x540945);}[a40_0x4d2c31(0x164)](){const _0x3ae39f=a40_0x4d2c31,_0x25274d=this['globalCheckInterval']?this[_0x3ae39f(0x162)]:undefined,_0x3ae77a=Array[_0x3ae39f(0x1ce)](this[_0x3ae39f(0x18c)][_0x3ae39f(0x201)]())[_0x3ae39f(0x1ee)](_0x174a55=>({'paymentId':_0x174a55['paymentId'],'gatewayPaymentId':_0x174a55[_0x3ae39f(0x163)],'createdAt':_0x174a55[_0x3ae39f(0x1d1)],'timersCount':_0x174a55['timers'][_0x3ae39f(0x21b)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x3ae39f(0x162)]/(0x3e8*0x3c),'expiryDays':this[_0x3ae39f(0x160)],'activeIndividualTimers':this[_0x3ae39f(0x18c)][_0x3ae39f(0x200)],'nextGlobalCheckIn':_0x25274d,'paymentTimersDetails':_0x3ae77a};}['getPaymentTimerInfo'](_0x255f59){const _0x12bc33=a40_0x4d2c31,_0x311712=this[_0x12bc33(0x18c)]['get'](_0x255f59);if(_0x311712)return{'hasTimers':!![],'timersCount':_0x311712[_0x12bc33(0x211)]['length'],'createdAt':_0x311712['createdAt'],'gatewayPaymentId':_0x311712[_0x12bc33(0x163)]};return{'hasTimers':![]};}async[a40_0x4d2c31(0x1fc)](_0x348f52,_0x2de80a){const _0x2141e0=a40_0x4d2c31;try{const _0x47ddcd=await database_1[_0x2141e0(0x15b)][_0x2141e0(0x1b5)]['findUnique']({'where':{'id':_0x348f52},'select':{'gatewaySettings':!![]}});if(!_0x47ddcd?.[_0x2141e0(0x144)])return console['log'](_0x2141e0(0x1ae)+_0x348f52+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x1c20af=JSON[_0x2141e0(0x148)](_0x47ddcd[_0x2141e0(0x144)]);for(const [_0x44c066,_0x1c524b]of Object[_0x2141e0(0x203)](_0x1c20af)){if(_0x44c066['toLowerCase']()===_0x2de80a['toLowerCase']()){const _0x9f15e0=_0x1c524b[_0x2141e0(0x132)]||0xa;return console[_0x2141e0(0x145)](_0x2141e0(0x171)+_0x2de80a+'\x20commission\x20for\x20shop\x20'+_0x348f52+':\x20'+_0x9f15e0+'%'),_0x9f15e0;}}return console[_0x2141e0(0x145)]('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0x2de80a+_0x2141e0(0x1d9)+_0x348f52+',\x20using\x20default\x2010%'),0xa;}catch(_0x26164a){return console['error'](_0x2141e0(0x176)+_0x348f52+',\x20gateway\x20'+_0x2de80a+':',_0x26164a),0xa;}}}function a40_0x3c08(_0x4bae4c,_0x15aadf){const _0x5ed47a=a40_0x5ed4();return a40_0x3c08=function(_0x3c08ea,_0x313df5){_0x3c08ea=_0x3c08ea-0x127;let _0x981f12=_0x5ed47a[_0x3c08ea];return _0x981f12;},a40_0x3c08(_0x4bae4c,_0x15aadf);}exports[a40_0x4d2c31(0x1bf)]=CoinToPayStatusService,exports[a40_0x4d2c31(0x184)]=new CoinToPayStatusService();