'use strict';function a35_0x51c3(){const _0x62f851=['Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20CoinToPay\x20payments','Failed\x20to\x20expire\x20payment\x20','floor','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','4386447mOCxKN','âš ï¸\x20Payment\x20','8331510oNmesI','bankDetails','Payment\x20older\x20than\x20','shop','checkExpiredPayments','__importDefault','ms)','shopId','-day\x20timeout','now','ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped','webhookUrl','coinToPayStatusService','message','push','\x20status\x20unchanged\x20(','__esModule','toISOString','2334792JBWjir','currency','error','ðŸ†”\x20Transaction\x20ID:\x20','Shop\x20webhook\x20sent\x20to\x20','PAID','\x20not\x20enabled\x20for\x20shop\x20','\x20days\x20(created\x20before\x20','payment.success','ðŸ”„\x20Updating\x20payment\x20','length','âœ…\x20Payment\x20','FAILED','failed','CoinToPayStatusService','Automatically\x20expired\x20after\x20','unknown','PENDING','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','create','findMany','cointopay_auto_expired','customerEmail','remitterIban','iban','paidAt','ðŸ“Š\x20Payment\x20','transactionId','status','gateway','\x20days\x20without\x20payment\x20confirmation','cointopay','amount','getDate','\x20status:\x20','\x20days,\x20marking\x20as\x20EXPIRED','/status/','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','ðŸ”\x20Checking\x20CoinToPay\x20payment\x20','createdOn','./gateways/coinToPayService','ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','21266498tGXtfd','Payment\x20not\x20found','\x20expired\x20CoinToPay\x20payments','startPeriodicStatusCheck','\x20days','ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','loggerService','\x20has\x20no\x20gatewayPaymentId,\x20skipping','cointopay_status_check_','EXPIRY_DAYS','\x20to\x20','update','adminNotes','âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','stopPeriodicStatusCheck','webhook_send','checkSinglePayment','\x20marked\x20as\x20paid\x20at:\x20','logShopWebhookSent','setDate','24EkEAWm','42DueFXj','checkAllPendingPayments','catch','defineProperty','default','application/json','âœ…\x20Completed\x20checking\x20','âœ…\x20Transaction\x20confirmed\x20on:\x20','45392ejFOEF','./telegramBotService','Failed\x20to\x20send\x20shop\x20webhook:','created','Initial\x20CoinToPay\x20status\x20check\x20failed:','sendShopWebhook','sendPaymentStatusNotification','payment','\x20pending\x20CoinToPay\x20payments','Webhook\x20event\x20','gatewayPaymentId','payment.pending','Unknown\x20error','payment.failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20status\x20from\x20','webhookEvents','orderId','â°\x20Found\x20','\x20is\x20older\x20than\x20','checkInterval','Bank\x20Details:\x20','EXPIRED','8yRhqRe','createdAt','paymentDetails','516820mtUJrq','paid','cointopay_status_check_error','stringify','coinToPayService','POST','sendPaymentNotification','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','expired','\x20updated\x20successfully','includes','logShopWebhookError','settings','â°\x20Payment\x20','log','CHECK_INTERVAL_MS','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','getServiceStats','\x20with\x20status\x20','webhookLog','confirmedOn','3037468ZMMfwf','findUnique','4BJIbnn'];a35_0x51c3=function(){return _0x62f851;};return a35_0x51c3();}const a35_0x12966a=a35_0x26d1;function a35_0x26d1(_0x1e1095,_0x7c809){const _0x51c3da=a35_0x51c3();return a35_0x26d1=function(_0x26d1f7,_0x4a1d33){_0x26d1f7=_0x26d1f7-0x12e;let _0x33383a=_0x51c3da[_0x26d1f7];return _0x33383a;},a35_0x26d1(_0x1e1095,_0x7c809);}(function(_0x680cda,_0x39c2b9){const _0x413ecc=a35_0x26d1,_0x1fd868=_0x680cda();while(!![]){try{const _0x111fb8=-parseInt(_0x413ecc(0x195))/0x1*(parseInt(_0x413ecc(0x19e))/0x2)+-parseInt(_0x413ecc(0x157))/0x3*(parseInt(_0x413ecc(0x13d))/0x4)+-parseInt(_0x413ecc(0x1b8))/0x5*(-parseInt(_0x413ecc(0x196))/0x6)+parseInt(_0x413ecc(0x13b))/0x7+parseInt(_0x413ecc(0x1b5))/0x8*(-parseInt(_0x413ecc(0x143))/0x9)+-parseInt(_0x413ecc(0x145))/0xa+parseInt(_0x413ecc(0x181))/0xb;if(_0x111fb8===_0x39c2b9)break;else _0x1fd868['push'](_0x1fd868['shift']());}catch(_0x1e3316){_0x1fd868['push'](_0x1fd868['shift']());}}}(a35_0x51c3,0x6d338));var __importDefault=this&&this[a35_0x12966a(0x14a)]||function(_0xcb5f2d){const _0x1fa7e2=a35_0x12966a;return _0xcb5f2d&&_0xcb5f2d[_0x1fa7e2(0x155)]?_0xcb5f2d:{'default':_0xcb5f2d};};Object[a35_0x12966a(0x199)](exports,a35_0x12966a(0x155),{'value':!![]}),exports['coinToPayStatusService']=exports[a35_0x12966a(0x165)]=void 0x0;const coinToPayService_1=require(a35_0x12966a(0x17f)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a35_0x12966a(0x19f)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0xedd34e=a35_0x12966a;this['checkInterval']=null,this[_0xedd34e(0x135)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0xedd34e(0x1bc)]=new coinToPayService_1['CoinToPayService']();}[a35_0x12966a(0x184)](){const _0x4facd5=a35_0x12966a;console[_0x4facd5(0x134)]('ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)'),this[_0x4facd5(0x197)]()[_0x4facd5(0x198)](_0x259d29=>{const _0x50845c=_0x4facd5;console[_0x50845c(0x159)](_0x50845c(0x1a2),_0x259d29);}),this[_0x4facd5(0x1b2)]=setInterval(async()=>{const _0x3fd40e=_0x4facd5;try{await this[_0x3fd40e(0x197)]();}catch(_0x39b306){console[_0x3fd40e(0x159)](_0x3fd40e(0x13e),_0x39b306);}},this[_0x4facd5(0x135)]),console[_0x4facd5(0x134)](_0x4facd5(0x18e));}[a35_0x12966a(0x18f)](){const _0x322e61=a35_0x12966a;this[_0x322e61(0x1b2)]&&(clearInterval(this[_0x322e61(0x1b2)]),this['checkInterval']=null,console[_0x322e61(0x134)](_0x322e61(0x14f)));}async['checkAllPendingPayments'](){const _0x226529=a35_0x12966a;try{const _0x20e0c2=await database_1[_0x226529(0x19a)]['payment'][_0x226529(0x16b)]({'where':{'gateway':'cointopay','status':_0x226529(0x168),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x20e0c2[_0x226529(0x161)]===0x0){console[_0x226529(0x134)](_0x226529(0x180));return;}console['log']('ðŸª™\x20Checking\x20'+_0x20e0c2[_0x226529(0x161)]+_0x226529(0x1a6));const _0x4b5aed=await this[_0x226529(0x149)](_0x20e0c2);console[_0x226529(0x134)](_0x226529(0x1b0)+_0x4b5aed[_0x226529(0x161)]+_0x226529(0x183));for(const _0x1873bd of _0x20e0c2){try{if(_0x4b5aed['includes'](_0x1873bd['id'])){console[_0x226529(0x134)](_0x226529(0x133)+_0x1873bd['id']+_0x226529(0x169));continue;}await this[_0x226529(0x191)](_0x1873bd),await new Promise(_0x4b0532=>setTimeout(_0x4b0532,0x7d0));}catch(_0x404ec2){console['error']('Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x1873bd['id']+':',_0x404ec2),loggerService_1[_0x226529(0x187)]['logWhiteDomainError'](_0x226529(0x176),_0x226529(0x17b)+_0x1873bd[_0x226529(0x1a8)],_0x404ec2);}}console[_0x226529(0x134)](_0x226529(0x19c)+_0x20e0c2['length']+_0x226529(0x13f));}catch(_0x2de6e7){console['error'](_0x226529(0x1bf),_0x2de6e7);}}async['checkExpiredPayments'](_0x2eb235){const _0x4bbb92=a35_0x12966a,_0x3b993e=[],_0x51d9e2=new Date();_0x51d9e2[_0x4bbb92(0x194)](_0x51d9e2[_0x4bbb92(0x178)]()-this[_0x4bbb92(0x18a)]),console['log'](_0x4bbb92(0x142)+this[_0x4bbb92(0x18a)]+_0x4bbb92(0x15e)+_0x51d9e2['toISOString']()+')');for(const _0x12dc11 of _0x2eb235){if(_0x12dc11[_0x4bbb92(0x1b6)]<_0x51d9e2){console[_0x4bbb92(0x134)]('â°\x20Payment\x20'+_0x12dc11['id']+_0x4bbb92(0x1b1)+this['EXPIRY_DAYS']+_0x4bbb92(0x17a));try{await database_1[_0x4bbb92(0x19a)][_0x4bbb92(0x1a5)][_0x4bbb92(0x18c)]({'where':{'id':_0x12dc11['id']},'data':{'status':_0x4bbb92(0x1b4),'updatedAt':new Date(),'adminNotes':_0x4bbb92(0x166)+this['EXPIRY_DAYS']+_0x4bbb92(0x175)}}),await database_1['default'][_0x4bbb92(0x139)][_0x4bbb92(0x16a)]({'data':{'paymentId':_0x12dc11['id'],'shopId':_0x12dc11['shopId'],'event':_0x4bbb92(0x16c),'statusCode':0xc8,'responseBody':JSON[_0x4bbb92(0x1bb)]({'reason':_0x4bbb92(0x147)+this[_0x4bbb92(0x18a)]+_0x4bbb92(0x185),'createdAt':_0x12dc11['createdAt'],'expiredAt':new Date()[_0x4bbb92(0x156)](),'daysSinceCreation':Math[_0x4bbb92(0x141)]((Date[_0x4bbb92(0x14e)]()-_0x12dc11[_0x4bbb92(0x1b6)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4bbb92(0x1a3)](_0x12dc11,_0x4bbb92(0x1b4)),await this[_0x4bbb92(0x1a4)](_0x12dc11,'EXPIRED'),_0x3b993e[_0x4bbb92(0x153)](_0x12dc11['id']),console[_0x4bbb92(0x134)](_0x4bbb92(0x162)+_0x12dc11['id']+_0x4bbb92(0x17c)+this[_0x4bbb92(0x18a)]+_0x4bbb92(0x14d));}catch(_0x1eb9b5){console[_0x4bbb92(0x159)](_0x4bbb92(0x140)+_0x12dc11['id']+':',_0x1eb9b5);}}}return _0x3b993e;}async[a35_0x12966a(0x191)](_0x27e255){const _0x7efb7e=a35_0x12966a;if(!_0x27e255['gatewayPaymentId']){console[_0x7efb7e(0x134)](_0x7efb7e(0x144)+_0x27e255['id']+_0x7efb7e(0x188));return;}console[_0x7efb7e(0x134)](_0x7efb7e(0x17d)+_0x27e255['id']+'\x20('+_0x27e255[_0x7efb7e(0x1a8)]+')');try{const _0x4bcc71=await this[_0x7efb7e(0x1bc)]['checkPaymentStatus'](_0x27e255[_0x7efb7e(0x1a8)]);console[_0x7efb7e(0x134)]('ðŸ“Š\x20Payment\x20'+_0x27e255['id']+_0x7efb7e(0x179)+_0x4bcc71[_0x7efb7e(0x173)]);_0x4bcc71[_0x7efb7e(0x1b7)]&&console[_0x7efb7e(0x134)](_0x7efb7e(0x171)+_0x27e255['id']+'\x20details:',{'iban':_0x4bcc71['paymentDetails'][_0x7efb7e(0x16f)]||'not\x20found','transactionId':_0x4bcc71[_0x7efb7e(0x1b7)][_0x7efb7e(0x172)],'createdOn':_0x4bcc71[_0x7efb7e(0x1b7)][_0x7efb7e(0x17e)],'confirmedOn':_0x4bcc71[_0x7efb7e(0x1b7)][_0x7efb7e(0x13a)]||'not\x20confirmed'});if(_0x4bcc71['status']!==_0x27e255[_0x7efb7e(0x173)]){console[_0x7efb7e(0x134)](_0x7efb7e(0x160)+_0x27e255['id']+_0x7efb7e(0x1ad)+_0x27e255[_0x7efb7e(0x173)]+_0x7efb7e(0x18b)+_0x4bcc71[_0x7efb7e(0x173)]);const _0x197b26={'status':_0x4bcc71['status'],'updatedAt':new Date()};_0x4bcc71['status']==='PAID'&&_0x27e255[_0x7efb7e(0x173)]!=='PAID'&&(_0x197b26['paidAt']=new Date(),console[_0x7efb7e(0x134)]('ðŸ’°\x20Payment\x20'+_0x27e255['id']+_0x7efb7e(0x192)+_0x197b26[_0x7efb7e(0x170)][_0x7efb7e(0x156)]()));if(_0x4bcc71[_0x7efb7e(0x1b7)]){const _0x2093ef=_0x4bcc71[_0x7efb7e(0x1b7)];_0x2093ef['iban']&&(_0x197b26[_0x7efb7e(0x16e)]=_0x2093ef[_0x7efb7e(0x16f)],console[_0x7efb7e(0x134)]('ðŸ¦\x20Saved\x20IBAN:\x20'+_0x2093ef[_0x7efb7e(0x16f)]));if(_0x2093ef[_0x7efb7e(0x146)]){const _0x12e91b=_0x27e255[_0x7efb7e(0x18d)]||'',_0x3c3264=_0x7efb7e(0x1b3)+_0x2093ef['bankDetails'];_0x197b26[_0x7efb7e(0x18d)]=_0x12e91b?_0x12e91b+'\x0a\x0a'+_0x3c3264:_0x3c3264,console[_0x7efb7e(0x134)](_0x7efb7e(0x186));}_0x2093ef[_0x7efb7e(0x172)]&&console['log'](_0x7efb7e(0x15a)+_0x2093ef['transactionId']),_0x2093ef[_0x7efb7e(0x13a)]&&console[_0x7efb7e(0x134)](_0x7efb7e(0x19d)+_0x2093ef['confirmedOn']);}await database_1[_0x7efb7e(0x19a)][_0x7efb7e(0x1a5)][_0x7efb7e(0x18c)]({'where':{'id':_0x27e255['id']},'data':_0x197b26}),await database_1['default'][_0x7efb7e(0x139)][_0x7efb7e(0x16a)]({'data':{'paymentId':_0x27e255['id'],'shopId':_0x27e255[_0x7efb7e(0x14c)],'event':_0x7efb7e(0x189)+_0x4bcc71['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x7efb7e(0x1bb)]({'oldStatus':_0x27e255['status'],'newStatus':_0x4bcc71[_0x7efb7e(0x173)],'paymentDetails':_0x4bcc71[_0x7efb7e(0x1b7)],'checkedAt':new Date()[_0x7efb7e(0x156)]()})}}),await this[_0x7efb7e(0x1a3)](_0x27e255,_0x4bcc71[_0x7efb7e(0x173)]),await this['sendPaymentStatusNotification'](_0x27e255,_0x4bcc71['status']),console[_0x7efb7e(0x134)](_0x7efb7e(0x162)+_0x27e255['id']+_0x7efb7e(0x12f));}else console['log']('ðŸ“Š\x20Payment\x20'+_0x27e255['id']+_0x7efb7e(0x154)+_0x4bcc71[_0x7efb7e(0x173)]+')');}catch(_0x59fe1b){console[_0x7efb7e(0x159)]('Failed\x20to\x20check\x20payment\x20'+_0x27e255['id']+':',_0x59fe1b),await database_1[_0x7efb7e(0x19a)][_0x7efb7e(0x139)][_0x7efb7e(0x16a)]({'data':{'paymentId':_0x27e255['id'],'shopId':_0x27e255[_0x7efb7e(0x14c)],'event':_0x7efb7e(0x1ba),'statusCode':0x1f4,'responseBody':JSON[_0x7efb7e(0x1bb)]({'error':_0x59fe1b instanceof Error?_0x59fe1b[_0x7efb7e(0x152)]:_0x7efb7e(0x1aa),'gatewayPaymentId':_0x27e255[_0x7efb7e(0x1a8)],'checkedAt':new Date()['toISOString']()})}});}}async[a35_0x12966a(0x1a3)](_0x550d5f,_0xfd2379){const _0x49defa=a35_0x12966a,_0x143210=Date['now']();try{const _0x1f90d1=_0x550d5f['shop'],_0x2b931b=_0x1f90d1[_0x49defa(0x132)];if(!_0x2b931b?.[_0x49defa(0x150)]){console[_0x49defa(0x134)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1f90d1['id']);return;}const _0x26e4fc=_0xfd2379===_0x49defa(0x15c)?_0x49defa(0x15f):_0xfd2379===_0x49defa(0x163)?_0x49defa(0x1ab):_0xfd2379===_0x49defa(0x1b4)?_0x49defa(0x1ab):_0x49defa(0x1a9);if(!_0x2b931b[_0x49defa(0x1ae)]?.[_0x49defa(0x130)](_0x26e4fc)){console[_0x49defa(0x134)](_0x49defa(0x1a7)+_0x26e4fc+_0x49defa(0x15d)+_0x1f90d1['id']);return;}const _0x46cc85={'event':_0x26e4fc,'payment':{'id':_0x550d5f['id'],'order_id':_0x550d5f[_0x49defa(0x1af)],'gateway_order_id':_0x550d5f['gatewayOrderId'],'gateway':'0100','amount':_0x550d5f[_0x49defa(0x177)],'currency':_0x550d5f[_0x49defa(0x158)],'status':_0xfd2379['toLowerCase'](),'customer_email':_0x550d5f[_0x49defa(0x16d)],'customer_name':_0x550d5f['customerName'],'created_at':_0x550d5f['createdAt'],'updated_at':new Date()}},_0x5b542d=await fetch(_0x2b931b[_0x49defa(0x150)],{'method':_0x49defa(0x1bd),'headers':{'Content-Type':_0x49defa(0x19b),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x49defa(0x1bb)](_0x46cc85)}),_0x52c9a6=Date[_0x49defa(0x14e)]()-_0x143210,_0x1b8db3=_0x5b542d['ok']?'Success':await _0x5b542d['text']();loggerService_1[_0x49defa(0x187)][_0x49defa(0x193)](_0x550d5f[_0x49defa(0x14c)],_0x2b931b[_0x49defa(0x150)],_0x26e4fc,_0x5b542d[_0x49defa(0x173)],_0x52c9a6,_0x46cc85),console['log'](_0x49defa(0x15b)+_0x2b931b[_0x49defa(0x150)]+_0x49defa(0x138)+_0x5b542d[_0x49defa(0x173)]+'\x20('+_0x52c9a6+_0x49defa(0x14b));}catch(_0x519154){console[_0x49defa(0x159)](_0x49defa(0x1a0),_0x519154),loggerService_1['loggerService'][_0x49defa(0x131)](_0x550d5f[_0x49defa(0x14c)],_0x550d5f[_0x49defa(0x148)]?.[_0x49defa(0x132)]?.[_0x49defa(0x150)]||_0x49defa(0x167),_0x49defa(0x190),_0x519154,{});}}async[a35_0x12966a(0x1a4)](_0x3ad1cf,_0x18ca4f){const _0x432e7a=a35_0x12966a;try{const _0x517cfe={'PENDING':_0x432e7a(0x1a1),'PAID':_0x432e7a(0x1b9),'FAILED':_0x432e7a(0x164),'EXPIRED':_0x432e7a(0x12e)},_0x409848=_0x517cfe[_0x18ca4f];if(!_0x409848||_0x409848===_0x432e7a(0x1a1))return;await telegramBotService_1['telegramBotService'][_0x432e7a(0x1be)](_0x3ad1cf[_0x432e7a(0x14c)],_0x3ad1cf,_0x409848);}catch(_0x5c54ec){console[_0x432e7a(0x159)](_0x432e7a(0x1ac),_0x5c54ec);}}async['checkPaymentById'](_0x2cfe8b){const _0x47134f=a35_0x12966a,_0x87e4da=await database_1[_0x47134f(0x19a)][_0x47134f(0x1a5)][_0x47134f(0x13c)]({'where':{'id':_0x2cfe8b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x87e4da)throw new Error(_0x47134f(0x182));if(_0x87e4da[_0x47134f(0x174)]!==_0x47134f(0x176))throw new Error(_0x47134f(0x136));await this[_0x47134f(0x191)](_0x87e4da);}[a35_0x12966a(0x137)](){const _0x505009=a35_0x12966a,_0x59c045=this[_0x505009(0x1b2)]?this[_0x505009(0x135)]:undefined;return{'isActive':!!this['checkInterval'],'checkIntervalMinutes':this[_0x505009(0x135)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'nextCheckIn':_0x59c045};}}exports[a35_0x12966a(0x165)]=CoinToPayStatusService,exports[a35_0x12966a(0x151)]=new CoinToPayStatusService();