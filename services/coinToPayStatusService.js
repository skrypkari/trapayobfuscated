'use strict';const a40_0x51ce11=a40_0xd64b;function a40_0x30d8(){const _0x1ca42d=['\x20\x20\x20📝\x20Context:','📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','🛑\x20[SHUTDOWN]\x20Cleared\x20','\x20completed\x20for\x20payment\x20','stopPeriodicStatusCheck','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','confirmedOn','\x20checked,\x20','get','default','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','findUnique','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','schedulePaymentChecks','ms)','findMany','\x20expired','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','currencyService','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','forEach','toISOString','\x20\x20\x20-\x20Amount:\x20','Shop\x20webhook\x20sent\x20to\x20','💰\x20[CHECK]\x20Payment\x20','amount','COINTOPAY_STATUS_CHANGE','\x20commission\x20for\x20shop\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','\x20to\x20','floor','\x20\x20\x20📅\x20Time:\x20','./gateways/coinToPayService','stack','timers','failed','\x20pending\x20CoinToPay\x20payments','update','cointopay_auto_expired','not\x20confirmed','\x20days','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','toLowerCase','gatewaySettings','⏰\x20[HOURLY]\x20Payment\x20','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','getDate','status','orderId','\x20\x20\x20-\x20Gateway:\x20','CoinToPayService','\x20\x20\x20-\x20Status:\x20','adminNotes','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','getTime','cointopay2','has','payment.failed','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20is\x20older\x20than\x20','currency','43784388LZstCx','checkAllPendingPayments','🔍\x20[CHECK]\x20Checking\x20','\x20days\x20without\x20payment\x20confirmation','7LzgmdK','❌\x20[HOURLY]\x20Payment\x20','\x20in\x20shop\x20','message','paymentDetails','payment.pending','globalCheckInterval','\x20\x20\x20📍\x20Source:\x20','set',',\x20status=','loggerService','\x20\x20\x20-\x20ShopId:\x20','getGatewayCommission','\x20is\x20valid\x20for\x20checking,\x20proceeding...','/status/','\x20for\x20payment\x20','\x20days\x20(created\x20before\x20','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','🪙\x20[GLOBAL]\x20Found\x20','cointopay_status_check_','gatewayPaymentId','🧹\x20[DEBUG]\x20Clearing\x20','auto_expire','parse','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','\x20expired\x20CoinToPay\x20payments','\x20in\x20','\x20commission:\x20','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','\x20individual\x20payment\x20timers','POST','now','\x20current\x20status:\x20','./loggerService','customerEmail','4844QDINrW','COINTOPAY_ERROR','includes','checkSinglePayment','entries','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20status\x20unchanged\x20(',':\x20type=','from','application/json','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','\x20payment\x20','payment.success','EXPIRED','\x20days,\x20marking\x20as\x20EXPIRED','defineProperty','GLOBAL_CHECK_INTERVAL_MS','amountUSDT','⏰\x20[GLOBAL]\x20Found\x20','paymentId','webhook_send','webhookEvents','sendShopWebhook','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','status_check','currentPayments','checkSinglePaymentById','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','./telegramBotService','\x20updated:\x20currentPayments=','\x20triggered\x20for\x20payment\x20','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','-day\x20timeout','Automatically\x20expired\x20after\x20','3581424tpxXtC','⏰\x20[GLOBAL]\x20Payment\x20','checkPaymentById','\x20\x20\x20-\x20paymentId:\x20','paymentLink','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','clearPaymentTimers','logCoinToPayError','EXPIRY_DAYS','\x20->\x20','paidAt','Unknown\x20error','error','\x20details:','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','log','\x20not\x20found,\x20clearing\x20timers','\x20marked\x20as\x20paid\x20at:\x20','getPaymentTimerInfo','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','toFixed','Gateway\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20\x20\x20📊\x20Status:\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','coinToPayService','🪙\x20[TIMER]\x20Individual\x20check\x20#','\x20\x20\x20Amount\x20after\x20commission:\x20','checkPaymentStatus','push','payment','h),\x20skipping\x20global\x20check','timestamp',',\x20using\x20default\x20commission\x2010%','unknown','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','./gateways/coinToPay2Service','📊\x20[CHECK]\x20Payment\x20','\x20found:','\x20USDT','\x20initial\x20timers\x20for\x20payment\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','\x20status\x20is\x20','logShopWebhookSent','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20to\x20clear','gatewayCommissionRate','2717304LtBNvw','155JVGOcS','COMPLETED','checkExpiredPayments','stringify','Bank\x20Details:\x20','created','PAID','logCoinToPayStatus','coinToPayStatusService','Webhook\x20event\x20','5\x20minutes','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20has\x20no\x20gatewayPaymentId','__importDefault','remitterIban','❌\x20[CHECK]\x20Payment\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','webhookUrl','SINGLE','settings','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','sendPaymentStatusNotification','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20updated\x20successfully','delete','coinToPay2Service','✅\x20[EXPIRY]\x20Payment\x20','create','webhookLog','CoinToPayStatusService','iban','1302837UPsAKo','Payment\x20not\x20found','⚠️\x20[CHECK]\x20Payment\x20','Payment\x20older\x20than\x20','.\x20Remaining\x20active\x20timers:\x20','logShopWebhookError','cointopay','PENDING','🪙\x20[DEBUG]\x20Creating\x20','paid','\x20not\x20found\x20in\x20database','startPeriodicStatusCheck','6665082ummbCe','\x20\x20\x20-\x20gatewayPaymentId:\x20','✅\x20[CHECK]\x20Payment\x20','size','shop','delay','length','\x20status:\x20',',\x20gateway\x20','customerName','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20',',\x20stopping\x20individual\x20checks','1\x20minute','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','shopId','__esModule','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','setDate','createdOn','expired','📈\x20[COINTOPAY]\x20Payment\x20','\x20not\x20enabled\x20for\x20shop\x20','getGatewayIdByName','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20',',\x20currentPayments=','createdAt','description','\x20\x20\x20Amount:\x20','type','transactionId','579868XMsMLW','paymentTimers','gateway','📊\x20[HOURLY]\x20Payment\x20','./currencyService','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','bankDetails','convertToUSDT'];a40_0x30d8=function(){return _0x1ca42d;};return a40_0x30d8();}(function(_0x31c6c4,_0x54357d){const _0x5a59be=a40_0xd64b,_0x24deff=_0x31c6c4();while(!![]){try{const _0x59e7b6=-parseInt(_0x5a59be(0x2d4))/0x1+-parseInt(_0x5a59be(0x1ef))/0x2+-parseInt(_0x5a59be(0x281))/0x3+-parseInt(_0x5a59be(0x25e))/0x4*(-parseInt(_0x5a59be(0x2b4))/0x5)+-parseInt(_0x5a59be(0x2e0))/0x6*(parseInt(_0x5a59be(0x239))/0x7)+-parseInt(_0x5a59be(0x2b3))/0x8+parseInt(_0x5a59be(0x235))/0x9;if(_0x59e7b6===_0x54357d)break;else _0x24deff['push'](_0x24deff['shift']());}catch(_0x4b8ace){_0x24deff['push'](_0x24deff['shift']());}}}(a40_0x30d8,0xa2728));var __importDefault=this&&this[a40_0x51ce11(0x2c1)]||function(_0x4b6125){const _0x54208c=a40_0x51ce11;return _0x4b6125&&_0x4b6125[_0x54208c(0x2ef)]?_0x4b6125:{'default':_0x4b6125};};Object[a40_0x51ce11(0x26e)](exports,a40_0x51ce11(0x2ef),{'value':!![]}),exports[a40_0x51ce11(0x2bc)]=exports[a40_0x51ce11(0x2d2)]=void 0x0;const coinToPayService_1=require(a40_0x51ce11(0x218)),coinToPay2Service_1=require(a40_0x51ce11(0x2a8)),gateway_1=require('../types/gateway'),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a40_0x51ce11(0x27b)),loggerService_1=require(a40_0x51ce11(0x25c)),currencyService_1=require(a40_0x51ce11(0x1f3));class CoinToPayStatusService{constructor(){const _0x162dd3=a40_0x51ce11;this['globalCheckInterval']=null,this[_0x162dd3(0x26f)]=0x3c*0x3c*0x3e8,this[_0x162dd3(0x289)]=0x5,this[_0x162dd3(0x1f0)]=new Map(),this[_0x162dd3(0x29c)]=new coinToPayService_1[(_0x162dd3(0x22a))](),this[_0x162dd3(0x2ce)]=new coinToPay2Service_1['CoinToPay2Service'](),console['log'](_0x162dd3(0x27e));}[a40_0x51ce11(0x204)](_0x29bb27,_0x3ba89f){const _0x324dab=a40_0x51ce11;console[_0x324dab(0x292)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x324dab(0x292)](_0x324dab(0x284)+_0x29bb27),console['log'](_0x324dab(0x2e1)+_0x3ba89f),this[_0x324dab(0x287)](_0x29bb27);const _0x5f489c=[],_0x5e9cd3=new Date(),_0x4fc6c2=[{'delay':0x1*0x3c*0x3e8,'description':_0x324dab(0x2ec)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x324dab(0x2be)},{'delay':0x5*0x3c*0x3e8,'description':_0x324dab(0x2be)}];console['log'](_0x324dab(0x2dc)+_0x4fc6c2[_0x324dab(0x2e6)]+_0x324dab(0x2ac)+_0x29bb27);let _0x2ea12a=0x0;_0x4fc6c2[_0x324dab(0x20c)]((_0x1c993a,_0x20d6fc)=>{const _0x5f10a2=_0x324dab;_0x2ea12a+=_0x1c993a[_0x5f10a2(0x2e5)];const _0x3daa30=setTimeout(async()=>{const _0x2568a6=_0x5f10a2;console[_0x2568a6(0x292)](_0x2568a6(0x29d)+(_0x20d6fc+0x1)+_0x2568a6(0x27d)+_0x29bb27+'\x20(after\x20'+_0x1c993a[_0x2568a6(0x2fa)]+')');try{await this[_0x2568a6(0x279)](_0x29bb27),console[_0x2568a6(0x292)](_0x2568a6(0x214)+(_0x20d6fc+0x1)+_0x2568a6(0x1fa)+_0x29bb27);}catch(_0x4c25b2){console['error'](_0x2568a6(0x290)+(_0x20d6fc+0x1)+_0x2568a6(0x248)+_0x29bb27+':',_0x4c25b2),this['logCoinToPayError'](_0x29bb27,_0x3ba89f,_0x4c25b2,_0x2568a6(0x277),{'checkNumber':_0x20d6fc+0x1,'scheduledAfter':_0x1c993a[_0x2568a6(0x2fa)],'isIndividualCheck':!![]});}},_0x2ea12a);_0x5f489c[_0x5f10a2(0x2a0)](_0x3daa30),console['log'](_0x5f10a2(0x264)+(_0x20d6fc+0x1)+_0x5f10a2(0x248)+_0x29bb27+_0x5f10a2(0x255)+_0x2ea12a/0x3e8+'\x20seconds\x20('+_0x1c993a[_0x5f10a2(0x2fa)]+')');});const _0x232993=setInterval(async()=>{const _0x1d3e07=_0x324dab;console[_0x1d3e07(0x292)](_0x1d3e07(0x299)+_0x29bb27);try{const _0x555d25=await database_1[_0x1d3e07(0x200)]['payment']['findUnique']({'where':{'id':_0x29bb27},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x555d25){console[_0x1d3e07(0x292)](_0x1d3e07(0x23a)+_0x29bb27+_0x1d3e07(0x293)),this['clearPaymentTimers'](_0x29bb27);return;}console[_0x1d3e07(0x292)](_0x1d3e07(0x1f2)+_0x29bb27+_0x1d3e07(0x25b)+_0x555d25[_0x1d3e07(0x227)]);if(_0x555d25[_0x1d3e07(0x227)]!==_0x1d3e07(0x2db)){console['log']('✅\x20[HOURLY]\x20Payment\x20'+_0x29bb27+_0x1d3e07(0x2ae)+_0x555d25[_0x1d3e07(0x227)]+_0x1d3e07(0x2eb)),this['clearPaymentTimers'](_0x29bb27);return;}const _0x33c2ed=Math['floor']((Date['now']()-_0x555d25['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x33c2ed>=this[_0x1d3e07(0x289)]){console[_0x1d3e07(0x292)](_0x1d3e07(0x224)+_0x29bb27+'\x20is\x20older\x20than\x20'+this[_0x1d3e07(0x289)]+_0x1d3e07(0x263)),this['clearPaymentTimers'](_0x29bb27);return;}await this[_0x1d3e07(0x279)](_0x29bb27),console['log']('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x29bb27);}catch(_0x5da90d){console[_0x1d3e07(0x28d)](_0x1d3e07(0x2f0)+_0x29bb27+':',_0x5da90d),this[_0x1d3e07(0x288)](_0x29bb27,_0x3ba89f,_0x5da90d,_0x1d3e07(0x277),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x5f489c[_0x324dab(0x2a0)](_0x232993),this['paymentTimers'][_0x324dab(0x241)](_0x29bb27,{'timers':_0x5f489c,'paymentId':_0x29bb27,'gatewayPaymentId':_0x3ba89f,'createdAt':_0x5e9cd3}),console[_0x324dab(0x292)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x4fc6c2[_0x324dab(0x2e6)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x29bb27),console[_0x324dab(0x292)](_0x324dab(0x2f7)+this['paymentTimers'][_0x324dab(0x2e3)]),this[_0x324dab(0x2bb)](_0x29bb27,_0x3ba89f,_0x324dab(0x2db),_0x324dab(0x2db),'status_check',{'action':'schedule_created','scheduledChecks':_0x4fc6c2[_0x324dab(0x2e6)],'firstCheckIn':_0x4fc6c2[0x0][_0x324dab(0x2e5)]/0x3e8,'totalTimers':this['paymentTimers'][_0x324dab(0x2e3)]});}[a40_0x51ce11(0x287)](_0x23c83e){const _0x316ee2=a40_0x51ce11,_0xd4c4d8=this[_0x316ee2(0x1f0)][_0x316ee2(0x1ff)](_0x23c83e);_0xd4c4d8?(console[_0x316ee2(0x292)](_0x316ee2(0x24e)+_0xd4c4d8[_0x316ee2(0x21a)][_0x316ee2(0x2e6)]+'\x20timers\x20for\x20payment\x20'+_0x23c83e),_0xd4c4d8[_0x316ee2(0x21a)][_0x316ee2(0x20c)]((_0x11df64,_0x394e8f)=>{const _0x32aac0=_0x316ee2;_0x11df64&&(clearTimeout(_0x11df64),clearInterval(_0x11df64),console[_0x32aac0(0x292)]('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x394e8f+0x1)+_0x32aac0(0x248)+_0x23c83e));}),this['paymentTimers'][_0x316ee2(0x2cd)](_0x23c83e),console[_0x316ee2(0x292)](_0x316ee2(0x2cb)+_0x23c83e+_0x316ee2(0x2d8)+this['paymentTimers'][_0x316ee2(0x2e3)])):console[_0x316ee2(0x292)](_0x316ee2(0x252)+_0x23c83e+_0x316ee2(0x2b1));}async['checkSinglePaymentById'](_0x16b849){const _0x273836=a40_0x51ce11;console[_0x273836(0x292)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x16b849);const _0x178764=await database_1['default'][_0x273836(0x2a1)][_0x273836(0x202)]({'where':{'id':_0x16b849},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x178764){console['log'](_0x273836(0x2c3)+_0x16b849+_0x273836(0x2de));return;}console[_0x273836(0x292)]('📊\x20[CHECK]\x20Payment\x20'+_0x16b849+_0x273836(0x2aa)),console[_0x273836(0x292)](_0x273836(0x229)+_0x178764[_0x273836(0x1f1)]),console[_0x273836(0x292)](_0x273836(0x22b)+_0x178764[_0x273836(0x227)]),console['log'](_0x273836(0x209)+_0x178764[_0x273836(0x24d)]),console[_0x273836(0x292)](_0x273836(0x20e)+_0x178764[_0x273836(0x211)]+'\x20'+_0x178764['currency']),console[_0x273836(0x292)](_0x273836(0x244)+_0x178764[_0x273836(0x2ee)]);if(_0x178764[_0x273836(0x1f1)]!==_0x273836(0x2da)&&_0x178764[_0x273836(0x1f1)]!==_0x273836(0x22f)){console['log'](_0x273836(0x2d6)+_0x16b849+_0x273836(0x225)+_0x178764['gateway']+')');return;}if(_0x178764[_0x273836(0x227)]!==_0x273836(0x2db)){console[_0x273836(0x292)](_0x273836(0x2d6)+_0x16b849+'\x20status\x20is\x20'+_0x178764[_0x273836(0x227)]+_0x273836(0x2eb)),this['clearPaymentTimers'](_0x16b849);return;}if(!_0x178764[_0x273836(0x24d)]){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x16b849+_0x273836(0x2c0));return;}console[_0x273836(0x292)]('✅\x20[CHECK]\x20Payment\x20'+_0x16b849+_0x273836(0x246)),await this[_0x273836(0x261)](_0x178764);}['logCoinToPayStatus'](_0x2108c4,_0x5e6902,_0x5024ff,_0x50dec9,_0x2e63d2,_0x4248be){const _0x21cb5f=a40_0x51ce11,_0x3ba44e={'type':_0x21cb5f(0x212),'paymentId':_0x2108c4,'gatewayPaymentId':_0x5e6902,'oldStatus':_0x5024ff,'newStatus':_0x50dec9,'source':_0x2e63d2,'timestamp':new Date()[_0x21cb5f(0x20d)](),'details':_0x4248be||{}};loggerService_1['loggerService'][_0x21cb5f(0x2bb)](_0x3ba44e),console[_0x21cb5f(0x292)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x2108c4+'\x20('+_0x5e6902+')'),console[_0x21cb5f(0x292)](_0x21cb5f(0x29a)+_0x5024ff+'\x20->\x20'+_0x50dec9),console[_0x21cb5f(0x292)](_0x21cb5f(0x240)+_0x2e63d2),console[_0x21cb5f(0x292)](_0x21cb5f(0x217)+_0x3ba44e[_0x21cb5f(0x2a3)]),_0x4248be&&console[_0x21cb5f(0x292)]('\x20\x20\x20📝\x20Details:',_0x4248be);}[a40_0x51ce11(0x288)](_0xa4f408,_0x336697,_0x9117f,_0x3f84b2,_0x34c166){const _0x14bcc7=a40_0x51ce11,_0x22a095={'type':_0x14bcc7(0x25f),'paymentId':_0xa4f408,'gatewayPaymentId':_0x336697,'error':_0x9117f instanceof Error?{'message':_0x9117f[_0x14bcc7(0x23c)],'stack':_0x9117f[_0x14bcc7(0x219)]}:_0x9117f,'source':_0x3f84b2,'timestamp':new Date()['toISOString'](),'context':_0x34c166||{}};loggerService_1[_0x14bcc7(0x243)]['logCoinToPayError'](_0x22a095),console[_0x14bcc7(0x28d)](_0x14bcc7(0x291)+_0xa4f408+'\x20('+_0x336697+')'),console['error']('\x20\x20\x20❌\x20Error:\x20'+(_0x9117f instanceof Error?_0x9117f['message']:_0x9117f)),console[_0x14bcc7(0x28d)](_0x14bcc7(0x240)+_0x3f84b2),console[_0x14bcc7(0x28d)](_0x14bcc7(0x217)+_0x22a095[_0x14bcc7(0x2a3)]),_0x34c166&&console['error'](_0x14bcc7(0x1f7),_0x34c166);}[a40_0x51ce11(0x2df)](){const _0x487a74=a40_0x51ce11;console['log'](_0x487a74(0x2c5)),this[_0x487a74(0x236)]()['catch'](_0x2eb333=>{const _0x2da5fb=_0x487a74;console[_0x2da5fb(0x28d)](_0x2da5fb(0x1fc),_0x2eb333);}),this[_0x487a74(0x23f)]=setInterval(async()=>{const _0x54c95b=_0x487a74;try{console[_0x54c95b(0x292)](_0x54c95b(0x2bf)),await this[_0x54c95b(0x236)](),console['log']('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x1e214d){console[_0x54c95b(0x28d)](_0x54c95b(0x2a6),_0x1e214d);}},this['GLOBAL_CHECK_INTERVAL_MS']),console['log']('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a40_0x51ce11(0x1fb)](){const _0x1043ba=a40_0x51ce11;console[_0x1043ba(0x292)](_0x1043ba(0x2c9));this[_0x1043ba(0x23f)]&&(clearInterval(this[_0x1043ba(0x23f)]),this[_0x1043ba(0x23f)]=null,console[_0x1043ba(0x292)](_0x1043ba(0x276)));const _0x25171a=this['paymentTimers']['size'];for(const [_0x556936]of this[_0x1043ba(0x1f0)]){this[_0x1043ba(0x287)](_0x556936);}console[_0x1043ba(0x292)](_0x1043ba(0x1f9)+_0x25171a+_0x1043ba(0x258));}async[a40_0x51ce11(0x236)](){const _0x3d973b=a40_0x51ce11;try{console[_0x3d973b(0x292)]('🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x3729f3=await database_1['default'][_0x3d973b(0x2a1)][_0x3d973b(0x206)]({'where':{'gateway':{'in':[_0x3d973b(0x2da),'cointopay2']},'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x3d973b(0x292)](_0x3d973b(0x24b)+_0x3729f3[_0x3d973b(0x2e6)]+_0x3d973b(0x21c));if(_0x3729f3[_0x3d973b(0x2e6)]===0x0){console[_0x3d973b(0x292)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x17ed71=await this[_0x3d973b(0x2b6)](_0x3729f3);console[_0x3d973b(0x292)](_0x3d973b(0x271)+_0x17ed71['length']+_0x3d973b(0x254));let _0x50db99=0x0,_0x12bcce=0x0;for(const _0x39085d of _0x3729f3){try{if(_0x17ed71['includes'](_0x39085d['id'])){console[_0x3d973b(0x292)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x39085d['id']+_0x3d973b(0x22d)),_0x12bcce++;continue;}if(this['paymentTimers'][_0x3d973b(0x230)](_0x39085d['id'])){console['log'](_0x3d973b(0x282)+_0x39085d['id']+_0x3d973b(0x232)),_0x12bcce++;continue;}const _0x3fa2e8=(Date[_0x3d973b(0x25a)]()-_0x39085d[_0x3d973b(0x2f9)][_0x3d973b(0x22e)]())/(0x3e8*0x3c*0x3c);if(_0x3fa2e8<0x1){console[_0x3d973b(0x292)](_0x3d973b(0x282)+_0x39085d['id']+'\x20is\x20too\x20new\x20('+_0x3fa2e8[_0x3d973b(0x297)](0x1)+_0x3d973b(0x2a2)),_0x12bcce++;continue;}console['log'](_0x3d973b(0x269)+_0x39085d['id']+'\x20(age:\x20'+_0x3fa2e8[_0x3d973b(0x297)](0x1)+'h)'),await this[_0x3d973b(0x261)](_0x39085d),_0x50db99++,await new Promise(_0x5c41e8=>setTimeout(_0x5c41e8,0x7d0));}catch(_0x116be2){console['error']('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x39085d['id']+':',_0x116be2),this[_0x3d973b(0x288)](_0x39085d['id'],_0x39085d['gatewayPaymentId']||'unknown',_0x116be2,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x39085d['amount'],'paymentCurrency':_0x39085d[_0x3d973b(0x234)],'shopId':_0x39085d[_0x3d973b(0x2ee)],'createdAt':_0x39085d['createdAt']}),loggerService_1['loggerService']['logWhiteDomainError'](_0x3d973b(0x2da),_0x3d973b(0x247)+_0x39085d[_0x3d973b(0x24d)],_0x116be2);}}console[_0x3d973b(0x292)](_0x3d973b(0x251)+_0x50db99+_0x3d973b(0x1fe)+_0x12bcce+'\x20skipped,\x20'+_0x17ed71[_0x3d973b(0x2e6)]+_0x3d973b(0x207));}catch(_0x4813de){console['error']('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x4813de);}}async[a40_0x51ce11(0x2b6)](_0x56f72b){const _0x80d3fa=a40_0x51ce11,_0x59611f=[],_0x5ff328=new Date();_0x5ff328[_0x80d3fa(0x2f1)](_0x5ff328[_0x80d3fa(0x226)]()-this[_0x80d3fa(0x289)]),console['log'](_0x80d3fa(0x28f)+this[_0x80d3fa(0x289)]+_0x80d3fa(0x249)+_0x5ff328[_0x80d3fa(0x20d)]()+')');for(const _0x4c4803 of _0x56f72b){if(_0x4c4803[_0x80d3fa(0x2f9)]<_0x5ff328){console['log']('⏰\x20[EXPIRY]\x20Payment\x20'+_0x4c4803['id']+_0x80d3fa(0x233)+this[_0x80d3fa(0x289)]+_0x80d3fa(0x26d));try{this[_0x80d3fa(0x2bb)](_0x4c4803['id'],_0x4c4803[_0x80d3fa(0x24d)]||_0x80d3fa(0x2a5),'PENDING',_0x80d3fa(0x26c),_0x80d3fa(0x24f),{'reason':'Payment\x20older\x20than\x20'+this[_0x80d3fa(0x289)]+_0x80d3fa(0x220),'createdAt':_0x4c4803['createdAt'],'daysSinceCreation':Math['floor']((Date[_0x80d3fa(0x25a)]()-_0x4c4803[_0x80d3fa(0x2f9)][_0x80d3fa(0x22e)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x4c4803[_0x80d3fa(0x211)],'paymentCurrency':_0x4c4803[_0x80d3fa(0x234)],'shopId':_0x4c4803[_0x80d3fa(0x2ee)]}),await database_1[_0x80d3fa(0x200)][_0x80d3fa(0x2a1)][_0x80d3fa(0x21d)]({'where':{'id':_0x4c4803['id']},'data':{'status':_0x80d3fa(0x26c),'updatedAt':new Date(),'adminNotes':_0x80d3fa(0x280)+this[_0x80d3fa(0x289)]+_0x80d3fa(0x238)}}),await database_1['default'][_0x80d3fa(0x2d1)][_0x80d3fa(0x2d0)]({'data':{'paymentId':_0x4c4803['id'],'shopId':_0x4c4803[_0x80d3fa(0x2ee)],'event':_0x80d3fa(0x21e),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x80d3fa(0x2d7)+this['EXPIRY_DAYS']+_0x80d3fa(0x220),'createdAt':_0x4c4803[_0x80d3fa(0x2f9)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math['floor']((Date[_0x80d3fa(0x25a)]()-_0x4c4803['createdAt'][_0x80d3fa(0x22e)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x80d3fa(0x275)](_0x4c4803,_0x80d3fa(0x26c)),await this[_0x80d3fa(0x2ca)](_0x4c4803,_0x80d3fa(0x26c)),this['clearPaymentTimers'](_0x4c4803['id']),_0x59611f[_0x80d3fa(0x2a0)](_0x4c4803['id']),console[_0x80d3fa(0x292)](_0x80d3fa(0x2cf)+_0x4c4803['id']+_0x80d3fa(0x2c4)+this['EXPIRY_DAYS']+_0x80d3fa(0x27f));}catch(_0x2d3654){console['error']('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x4c4803['id']+':',_0x2d3654),this['logCoinToPayError'](_0x4c4803['id'],_0x4c4803[_0x80d3fa(0x24d)]||_0x80d3fa(0x2a5),_0x2d3654,_0x80d3fa(0x24f),{'reason':_0x80d3fa(0x29b),'createdAt':_0x4c4803[_0x80d3fa(0x2f9)],'daysSinceCreation':Math[_0x80d3fa(0x216)]((Date[_0x80d3fa(0x25a)]()-_0x4c4803[_0x80d3fa(0x2f9)][_0x80d3fa(0x22e)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x59611f;}async[a40_0x51ce11(0x261)](_0x4ae2f3){const _0x28b72d=a40_0x51ce11;if(!_0x4ae2f3[_0x28b72d(0x24d)]){console[_0x28b72d(0x292)](_0x28b72d(0x2d6)+_0x4ae2f3['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x28b72d(0x292)](_0x28b72d(0x237)+_0x4ae2f3[_0x28b72d(0x1f1)]+_0x28b72d(0x26a)+_0x4ae2f3['id']+'\x20('+_0x4ae2f3[_0x28b72d(0x24d)]+')');try{let _0x2850e2;_0x4ae2f3['gateway']===_0x28b72d(0x22f)?(_0x2850e2=await this['coinToPay2Service'][_0x28b72d(0x29f)](_0x4ae2f3[_0x28b72d(0x24d)]),console[_0x28b72d(0x292)](_0x28b72d(0x296)+_0x4ae2f3['id']+_0x28b72d(0x2e7)+_0x2850e2[_0x28b72d(0x227)])):(_0x2850e2=await this[_0x28b72d(0x29c)][_0x28b72d(0x29f)](_0x4ae2f3[_0x28b72d(0x24d)]),console[_0x28b72d(0x292)](_0x28b72d(0x24a)+_0x4ae2f3['id']+_0x28b72d(0x2e7)+_0x2850e2[_0x28b72d(0x227)]));_0x2850e2[_0x28b72d(0x23d)]&&console['log'](_0x28b72d(0x2a9)+_0x4ae2f3['id']+_0x28b72d(0x28e),{'iban':_0x2850e2['paymentDetails'][_0x28b72d(0x2d3)]||'not\x20found','transactionId':_0x2850e2[_0x28b72d(0x23d)][_0x28b72d(0x2fd)],'createdOn':_0x2850e2[_0x28b72d(0x23d)][_0x28b72d(0x2f2)],'confirmedOn':_0x2850e2[_0x28b72d(0x23d)]['confirmedOn']||_0x28b72d(0x21f)});if(_0x2850e2[_0x28b72d(0x227)]!==_0x4ae2f3[_0x28b72d(0x227)]){console[_0x28b72d(0x292)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x4ae2f3['id']+'\x20status\x20from\x20'+_0x4ae2f3['status']+_0x28b72d(0x215)+_0x2850e2[_0x28b72d(0x227)]),this[_0x28b72d(0x2bb)](_0x4ae2f3['id'],_0x4ae2f3[_0x28b72d(0x24d)],_0x4ae2f3[_0x28b72d(0x227)],_0x2850e2[_0x28b72d(0x227)],_0x28b72d(0x277),{'paymentDetails':_0x2850e2[_0x28b72d(0x23d)],'amount':_0x2850e2[_0x28b72d(0x211)],'currency':_0x2850e2[_0x28b72d(0x234)],'shopId':_0x4ae2f3[_0x28b72d(0x2ee)],'checkTimestamp':new Date()[_0x28b72d(0x20d)]()});const _0x3dccaa={'status':_0x2850e2[_0x28b72d(0x227)],'updatedAt':new Date()};if(_0x2850e2[_0x28b72d(0x227)]===_0x28b72d(0x2ba)&&_0x4ae2f3[_0x28b72d(0x227)]!==_0x28b72d(0x2ba)){_0x3dccaa[_0x28b72d(0x28b)]=new Date();if(!_0x4ae2f3[_0x28b72d(0x270)]){const _0x1e2663=await currencyService_1[_0x28b72d(0x20a)][_0x28b72d(0x1f6)](_0x4ae2f3[_0x28b72d(0x211)],_0x4ae2f3[_0x28b72d(0x234)]);_0x3dccaa[_0x28b72d(0x270)]=_0x1e2663;const _0x20a7c1=await this[_0x28b72d(0x245)](_0x4ae2f3[_0x28b72d(0x2ee)],_0x4ae2f3[_0x28b72d(0x1f1)]),_0x52fecc=_0x1e2663*(0x1-_0x20a7c1/0x64);_0x3dccaa['amountAfterGatewayCommissionUSDT']=_0x52fecc,_0x3dccaa[_0x28b72d(0x2b2)]=_0x20a7c1,console[_0x28b72d(0x292)]('💰\x20[CHECK]\x20Payment\x20'+_0x4ae2f3['id']+'\x20amounts\x20calculated:'),console[_0x28b72d(0x292)](_0x28b72d(0x2fb)+_0x4ae2f3[_0x28b72d(0x211)]+'\x20'+_0x4ae2f3['currency']+_0x28b72d(0x28a)+_0x1e2663[_0x28b72d(0x297)](0x6)+_0x28b72d(0x2ab)),console[_0x28b72d(0x292)]('\x20\x20\x20Gateway\x20'+_0x4ae2f3[_0x28b72d(0x1f1)]+_0x28b72d(0x256)+_0x20a7c1+'%'),console[_0x28b72d(0x292)](_0x28b72d(0x29e)+_0x52fecc[_0x28b72d(0x297)](0x6)+_0x28b72d(0x2ab));}console[_0x28b72d(0x292)](_0x28b72d(0x210)+_0x4ae2f3['id']+_0x28b72d(0x294)+_0x3dccaa[_0x28b72d(0x28b)][_0x28b72d(0x20d)]());}if(_0x2850e2[_0x28b72d(0x23d)]){const _0x30a87c=_0x2850e2[_0x28b72d(0x23d)];_0x30a87c[_0x28b72d(0x2d3)]&&(_0x3dccaa[_0x28b72d(0x2c2)]=_0x30a87c[_0x28b72d(0x2d3)],console[_0x28b72d(0x292)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x30a87c[_0x28b72d(0x2d3)]));if(_0x30a87c[_0x28b72d(0x1f5)]){const _0x2e8a1a=_0x4ae2f3[_0x28b72d(0x22c)]||'',_0x1103ac=_0x28b72d(0x2b8)+_0x30a87c[_0x28b72d(0x1f5)];_0x3dccaa[_0x28b72d(0x22c)]=_0x2e8a1a?_0x2e8a1a+'\x0a\x0a'+_0x1103ac:_0x1103ac,console[_0x28b72d(0x292)](_0x28b72d(0x1f4));}_0x30a87c[_0x28b72d(0x2fd)]&&console[_0x28b72d(0x292)](_0x28b72d(0x203)+_0x30a87c['transactionId']),_0x30a87c[_0x28b72d(0x1fd)]&&console[_0x28b72d(0x292)](_0x28b72d(0x208)+_0x30a87c[_0x28b72d(0x1fd)]);}await database_1[_0x28b72d(0x200)][_0x28b72d(0x2a1)][_0x28b72d(0x21d)]({'where':{'id':_0x4ae2f3['id']},'data':_0x3dccaa});if(_0x2850e2[_0x28b72d(0x227)]==='PAID'&&_0x4ae2f3[_0x28b72d(0x227)]!==_0x28b72d(0x2ba)){console[_0x28b72d(0x292)](_0x28b72d(0x2f4)+_0x4ae2f3['id']+_0x28b72d(0x257));const _0x4c3557=await database_1[_0x28b72d(0x200)]['payment']['findUnique']({'where':{'id':_0x4ae2f3['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x4c3557?.['paymentLinkId']&&_0x4c3557[_0x28b72d(0x285)])try{const _0xefedbf=_0x4c3557[_0x28b72d(0x285)];console[_0x28b72d(0x292)](_0x28b72d(0x1f8)+_0xefedbf['id']+_0x28b72d(0x266)+_0xefedbf[_0x28b72d(0x2fc)]+_0x28b72d(0x2f8)+_0xefedbf[_0x28b72d(0x278)]+_0x28b72d(0x242)+_0xefedbf[_0x28b72d(0x227)]);const _0x3ad14b=_0xefedbf['currentPayments']+0x1,_0x5e659a=_0xefedbf[_0x28b72d(0x2fc)]===_0x28b72d(0x2c7)?_0x28b72d(0x2b5):_0xefedbf[_0x28b72d(0x227)];await database_1[_0x28b72d(0x200)][_0x28b72d(0x285)][_0x28b72d(0x21d)]({'where':{'id':_0xefedbf['id']},'data':{'currentPayments':_0x3ad14b,'status':_0x5e659a,'updatedAt':new Date()}}),console['log']('✅\x20[COINTOPAY]\x20Payment\x20link\x20'+_0xefedbf['id']+_0x28b72d(0x27c)+_0xefedbf[_0x28b72d(0x278)]+_0x28b72d(0x28a)+_0x3ad14b+_0x28b72d(0x242)+_0xefedbf[_0x28b72d(0x227)]+_0x28b72d(0x28a)+_0x5e659a);}catch(_0x59f960){console[_0x28b72d(0x28d)](_0x28b72d(0x253),_0x59f960);}else console[_0x28b72d(0x292)]('📈\x20[COINTOPAY]\x20Payment\x20'+_0x4ae2f3['id']+_0x28b72d(0x2ed));}await database_1[_0x28b72d(0x200)][_0x28b72d(0x2d1)]['create']({'data':{'paymentId':_0x4ae2f3['id'],'shopId':_0x4ae2f3[_0x28b72d(0x2ee)],'event':_0x28b72d(0x24c)+_0x2850e2[_0x28b72d(0x227)][_0x28b72d(0x222)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x4ae2f3['status'],'newStatus':_0x2850e2[_0x28b72d(0x227)],'paymentDetails':_0x2850e2['paymentDetails'],'checkedAt':new Date()[_0x28b72d(0x20d)]()})}}),await this[_0x28b72d(0x275)](_0x4ae2f3,_0x2850e2['status']),await this[_0x28b72d(0x2ca)](_0x4ae2f3,_0x2850e2['status']),_0x2850e2[_0x28b72d(0x227)]!==_0x28b72d(0x2db)&&(console[_0x28b72d(0x292)]('🧹\x20[CHECK]\x20Payment\x20'+_0x4ae2f3['id']+'\x20status\x20changed\x20to\x20'+_0x2850e2['status']+',\x20clearing\x20individual\x20timers'),this[_0x28b72d(0x287)](_0x4ae2f3['id'])),console[_0x28b72d(0x292)](_0x28b72d(0x2e2)+_0x4ae2f3['id']+_0x28b72d(0x2cc));}else console[_0x28b72d(0x292)](_0x28b72d(0x2a9)+_0x4ae2f3['id']+_0x28b72d(0x265)+_0x2850e2[_0x28b72d(0x227)]+')'),this['logCoinToPayStatus'](_0x4ae2f3['id'],_0x4ae2f3[_0x28b72d(0x24d)],_0x4ae2f3[_0x28b72d(0x227)],_0x2850e2[_0x28b72d(0x227)],_0x28b72d(0x277),{'statusUnchanged':!![],'paymentDetails':_0x2850e2[_0x28b72d(0x23d)],'amount':_0x2850e2['amount'],'currency':_0x2850e2[_0x28b72d(0x234)],'shopId':_0x4ae2f3['shopId'],'checkTimestamp':new Date()[_0x28b72d(0x20d)]()});}catch(_0x2bf123){console[_0x28b72d(0x28d)](_0x28b72d(0x2ea)+_0x4ae2f3['id']+':',_0x2bf123),this[_0x28b72d(0x288)](_0x4ae2f3['id'],_0x4ae2f3[_0x28b72d(0x24d)],_0x2bf123,_0x28b72d(0x277),{'paymentAmount':_0x4ae2f3[_0x28b72d(0x211)],'paymentCurrency':_0x4ae2f3[_0x28b72d(0x234)],'shopId':_0x4ae2f3['shopId'],'createdAt':_0x4ae2f3[_0x28b72d(0x2f9)]}),await database_1[_0x28b72d(0x200)][_0x28b72d(0x2d1)][_0x28b72d(0x2d0)]({'data':{'paymentId':_0x4ae2f3['id'],'shopId':_0x4ae2f3[_0x28b72d(0x2ee)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x2bf123 instanceof Error?_0x2bf123[_0x28b72d(0x23c)]:_0x28b72d(0x28c),'gatewayPaymentId':_0x4ae2f3['gatewayPaymentId'],'checkedAt':new Date()[_0x28b72d(0x20d)]()})}});}}async[a40_0x51ce11(0x275)](_0x2a66cf,_0x180f25){const _0x3d587c=a40_0x51ce11,_0x20443b=Date[_0x3d587c(0x25a)]();try{const _0x47e0d5=_0x2a66cf[_0x3d587c(0x2e4)],_0x48dea6=_0x47e0d5[_0x3d587c(0x2c8)];if(!_0x48dea6?.[_0x3d587c(0x2c6)]){console[_0x3d587c(0x292)](_0x3d587c(0x221)+_0x47e0d5['id']);return;}const _0x130c4b=_0x180f25===_0x3d587c(0x2ba)?_0x3d587c(0x26b):_0x180f25==='FAILED'?_0x3d587c(0x231):_0x180f25===_0x3d587c(0x26c)?_0x3d587c(0x231):_0x3d587c(0x23e);if(!_0x48dea6[_0x3d587c(0x274)]?.[_0x3d587c(0x260)](_0x130c4b)){console[_0x3d587c(0x292)](_0x3d587c(0x2bd)+_0x130c4b+_0x3d587c(0x2f5)+_0x47e0d5['id']);return;}const _0x4e6a9c=(0x0,gateway_1[_0x3d587c(0x2f6)])(_0x2a66cf[_0x3d587c(0x1f1)])||_0x2a66cf['gateway'],_0x4bfeb8={'event':_0x130c4b,'payment':{'id':_0x2a66cf['id'],'order_id':_0x2a66cf[_0x3d587c(0x228)],'gateway_order_id':_0x2a66cf['gatewayOrderId'],'gateway':_0x4e6a9c,'amount':_0x2a66cf[_0x3d587c(0x211)],'currency':_0x2a66cf['currency'],'status':_0x180f25[_0x3d587c(0x222)](),'customer_email':_0x2a66cf[_0x3d587c(0x25d)],'customer_name':_0x2a66cf[_0x3d587c(0x2e9)],'created_at':_0x2a66cf[_0x3d587c(0x2f9)],'updated_at':new Date()}},_0x56f3ef=await fetch(_0x48dea6[_0x3d587c(0x2c6)],{'method':_0x3d587c(0x259),'headers':{'Content-Type':_0x3d587c(0x268),'User-Agent':'Payment\x20System/1.0'},'body':JSON[_0x3d587c(0x2b7)](_0x4bfeb8)}),_0x7a6d88=Date[_0x3d587c(0x25a)]()-_0x20443b,_0x351afe=_0x56f3ef['ok']?'Success':await _0x56f3ef['text']();loggerService_1[_0x3d587c(0x243)][_0x3d587c(0x2af)](_0x2a66cf['shopId'],_0x48dea6['webhookUrl'],_0x130c4b,_0x56f3ef['status'],_0x7a6d88,_0x4bfeb8),console['log'](_0x3d587c(0x20f)+_0x48dea6['webhookUrl']+'\x20with\x20status\x20'+_0x56f3ef[_0x3d587c(0x227)]+'\x20('+_0x7a6d88+_0x3d587c(0x205));}catch(_0x52dc4d){console[_0x3d587c(0x28d)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x52dc4d),loggerService_1[_0x3d587c(0x243)][_0x3d587c(0x2d9)](_0x2a66cf[_0x3d587c(0x2ee)],_0x2a66cf[_0x3d587c(0x2e4)]?.[_0x3d587c(0x2c8)]?.['webhookUrl']||_0x3d587c(0x2a5),_0x3d587c(0x273),_0x52dc4d,{});}}async[a40_0x51ce11(0x2ca)](_0xb86d78,_0x4549b2){const _0x1f7d97=a40_0x51ce11;try{const _0x4396eb={'PENDING':_0x1f7d97(0x2b9),'PAID':_0x1f7d97(0x2dd),'FAILED':_0x1f7d97(0x21b),'EXPIRED':_0x1f7d97(0x2f3)},_0x19ac35=_0x4396eb[_0x4549b2];if(!_0x19ac35||_0x19ac35===_0x1f7d97(0x2b9))return;await telegramBotService_1['telegramBotService']['sendPaymentNotification'](_0xb86d78[_0x1f7d97(0x2ee)],_0xb86d78,_0x19ac35);}catch(_0x11e9d6){console[_0x1f7d97(0x28d)](_0x1f7d97(0x2b0),_0x11e9d6);}}async[a40_0x51ce11(0x283)](_0x2e4438){const _0x33c1dc=a40_0x51ce11;console['log'](_0x33c1dc(0x2a7)+_0x2e4438);const _0x447bee=await database_1[_0x33c1dc(0x200)][_0x33c1dc(0x2a1)]['findUnique']({'where':{'id':_0x2e4438},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x447bee)throw new Error(_0x33c1dc(0x2d5));if(_0x447bee['gateway']!=='cointopay'&&_0x447bee[_0x33c1dc(0x1f1)]!=='cointopay2')throw new Error(_0x33c1dc(0x201));console[_0x33c1dc(0x292)](_0x33c1dc(0x2ad)+_0x447bee[_0x33c1dc(0x1f1)]+_0x33c1dc(0x26a)+_0x2e4438),await this[_0x33c1dc(0x261)](_0x447bee),console[_0x33c1dc(0x292)]('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x2e4438);}['getServiceStats'](){const _0x571a70=a40_0x51ce11,_0x590b1b=this['globalCheckInterval']?this[_0x571a70(0x26f)]:undefined,_0x4c35a3=Array[_0x571a70(0x267)](this['paymentTimers']['values']())['map'](_0x34577a=>({'paymentId':_0x34577a[_0x571a70(0x272)],'gatewayPaymentId':_0x34577a[_0x571a70(0x24d)],'createdAt':_0x34577a[_0x571a70(0x2f9)],'timersCount':_0x34577a[_0x571a70(0x21a)][_0x571a70(0x2e6)]}));return{'isActive':!!this[_0x571a70(0x23f)],'globalCheckIntervalMinutes':this[_0x571a70(0x26f)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x571a70(0x1f0)][_0x571a70(0x2e3)],'nextGlobalCheckIn':_0x590b1b,'paymentTimersDetails':_0x4c35a3};}[a40_0x51ce11(0x295)](_0x266b58){const _0x162ec4=a40_0x51ce11,_0x3b35de=this[_0x162ec4(0x1f0)][_0x162ec4(0x1ff)](_0x266b58);if(_0x3b35de)return{'hasTimers':!![],'timersCount':_0x3b35de[_0x162ec4(0x21a)][_0x162ec4(0x2e6)],'createdAt':_0x3b35de[_0x162ec4(0x2f9)],'gatewayPaymentId':_0x3b35de[_0x162ec4(0x24d)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0x1ae1cf,_0x56f340){const _0x482e6c=a40_0x51ce11;try{const _0x193ed3=await database_1[_0x482e6c(0x200)][_0x482e6c(0x2e4)][_0x482e6c(0x202)]({'where':{'id':_0x1ae1cf},'select':{'gatewaySettings':!![]}});if(!_0x193ed3?.[_0x482e6c(0x223)])return console['log'](_0x482e6c(0x286)+_0x1ae1cf+_0x482e6c(0x2a4)),0xa;const _0x35b4a9=JSON[_0x482e6c(0x250)](_0x193ed3['gatewaySettings']);for(const [_0x268af0,_0x4d2900]of Object[_0x482e6c(0x262)](_0x35b4a9)){if(_0x268af0[_0x482e6c(0x222)]()===_0x56f340['toLowerCase']()){const _0x2fe08f=_0x4d2900['commission']||0xa;return console[_0x482e6c(0x292)](_0x482e6c(0x298)+_0x56f340+_0x482e6c(0x213)+_0x1ae1cf+':\x20'+_0x2fe08f+'%'),_0x2fe08f;}}return console[_0x482e6c(0x292)](_0x482e6c(0x27a)+_0x56f340+_0x482e6c(0x23b)+_0x1ae1cf+',\x20using\x20default\x2010%'),0xa;}catch(_0x499461){return console['error'](_0x482e6c(0x20b)+_0x1ae1cf+_0x482e6c(0x2e8)+_0x56f340+':',_0x499461),0xa;}}}function a40_0xd64b(_0x3daceb,_0x61fff4){const _0x30d877=a40_0x30d8();return a40_0xd64b=function(_0xd64b3d,_0x447b90){_0xd64b3d=_0xd64b3d-0x1ef;let _0x288bd7=_0x30d877[_0xd64b3d];return _0x288bd7;},a40_0xd64b(_0x3daceb,_0x61fff4);}exports['CoinToPayStatusService']=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();