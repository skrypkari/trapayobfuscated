'use strict';const a37_0x375869=a37_0x1363;(function(_0x58b1ad,_0x4d1c61){const _0x17904f=a37_0x1363,_0x1a017b=_0x58b1ad();while(!![]){try{const _0x4b16b6=-parseInt(_0x17904f(0x15d))/0x1*(parseInt(_0x17904f(0x14b))/0x2)+-parseInt(_0x17904f(0x12a))/0x3*(-parseInt(_0x17904f(0x1f9))/0x4)+-parseInt(_0x17904f(0x145))/0x5+parseInt(_0x17904f(0x1ca))/0x6+parseInt(_0x17904f(0x148))/0x7+parseInt(_0x17904f(0x1d4))/0x8*(-parseInt(_0x17904f(0x188))/0x9)+parseInt(_0x17904f(0x1ee))/0xa;if(_0x4b16b6===_0x4d1c61)break;else _0x1a017b['push'](_0x1a017b['shift']());}catch(_0x2db70e){_0x1a017b['push'](_0x1a017b['shift']());}}}(a37_0x3fa2,0x39be7));var __importDefault=this&&this[a37_0x375869(0x1af)]||function(_0x56a175){const _0x403d68=a37_0x375869;return _0x56a175&&_0x56a175[_0x403d68(0x1b8)]?_0x56a175:{'default':_0x56a175};};function a37_0x1363(_0x277753,_0x3d3d4c){const _0x3fa2dc=a37_0x3fa2();return a37_0x1363=function(_0x136351,_0x17b49e){_0x136351=_0x136351-0x11d;let _0x4bed48=_0x3fa2dc[_0x136351];return _0x4bed48;},a37_0x1363(_0x277753,_0x3d3d4c);}Object[a37_0x375869(0x165)](exports,a37_0x375869(0x1b8),{'value':!![]}),exports[a37_0x375869(0x1ed)]=exports[a37_0x375869(0x15c)]=void 0x0;const coinToPayService_1=require(a37_0x375869(0x1a4)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require(a37_0x375869(0x178)),database_1=__importDefault(require(a37_0x375869(0x187))),telegramBotService_1=require(a37_0x375869(0x132)),loggerService_1=require(a37_0x375869(0x1ef));function a37_0x3fa2(){const _0x3ada4d=['\x20current\x20status:\x20','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','../config/database','18rUEWMq','\x20days\x20without\x20payment\x20confirmation','settings','TesSoft\x20Payment\x20System/1.0','🧹\x20[DEBUG]\x20Clearing\x20','\x20\x20\x20❌\x20Error:\x20','✅\x20[CHECK]\x20Payment\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','h),\x20skipping\x20global\x20check','\x20status\x20unchanged\x20(','cointopay2','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','currency','POST','payment.failed','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','💰\x20[CHECK]\x20Payment\x20','schedulePaymentChecks','not\x20found','\x20\x20\x20-\x20paymentId:\x20','map','⚠️\x20[CHECK]\x20Payment\x20','checkSinglePaymentById',',\x20clearing\x20individual\x20timers','cointopay_status_check_error','payment','⏰\x20[GLOBAL]\x20Payment\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','./gateways/coinToPayService','paymentDetails','✅\x20[HOURLY]\x20Payment\x20','createdAt','sendPaymentStatusNotification','adminNotes','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','2\x20minutes','toLowerCase','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','__importDefault','\x20updated\x20successfully','⏰\x20[EXPIRY]\x20Payment\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20',',\x20stopping\x20individual\x20checks','\x20checked,\x20','\x20found:','transactionId','\x20initial\x20timers\x20for\x20payment\x20','__esModule','Failed\x20to\x20mark\x20payment\x20as\x20expired','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20not\x20found,\x20clearing\x20timers','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','5\x20minutes','\x20\x20\x20📝\x20Details:','cointopay_status_check_','\x20days\x20(created\x20before\x20','sendShopWebhook','logWhiteDomainError','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20not\x20found\x20in\x20database','customerEmail','checkPaymentById','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20\x20\x20-\x20Gateway:\x20','orderId','1362444HUIabH','remitterIban','CoinToPayService','timers','update','findUnique','🧹\x20[CHECK]\x20Payment\x20','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','PENDING','\x20seconds\x20(','595048DAAmmt','\x20is\x20valid\x20for\x20checking,\x20proceeding...','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','GLOBAL_CHECK_INTERVAL_MS','\x20(after\x20','toFixed','Payment\x20older\x20than\x20','status_check','customerName','\x20details:','coinToPayService','checkAllPendingPayments','\x20days,\x20marking\x20as\x20EXPIRED','paidAt','not\x20confirmed','\x20\x20\x20-\x20gatewayPaymentId:\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','webhookEvents','✅\x20[TIMER]\x20Individual\x20check\x20#','cointopay','gateway','error','\x20to\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','ms)','coinToPayStatusService','822700xGTLOO','./loggerService','\x20in\x20','Shop\x20webhook\x20sent\x20to\x20','set','gatewayPaymentId','logShopWebhookError','size','logCoinToPayError','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','4afjkyR','created','COINTOPAY_ERROR','\x20marked\x20as\x20paid\x20at:\x20','/status/','setDate','\x20skipped,\x20','shop','.\x20Remaining\x20active\x20timers:\x20','checkExpiredPayments','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','🪙\x20[DEBUG]\x20Creating\x20','clearPaymentTimers','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','Webhook\x20event\x20','Automatically\x20expired\x20after\x20','🔄\x20[CHECK]\x20Updating\x20payment\x20','Failed\x20to\x20send\x20shop\x20webhook:','CoinToPay2Service','forEach','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20to\x20clear','\x20with\x20status\x20','status','\x20triggered\x20for\x20payment\x20','length','📊\x20[HOURLY]\x20Payment\x20','globalCheckInterval','description','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','sendPaymentNotification','EXPIRY_DAYS','\x20\x20\x20📊\x20Status:\x20','confirmedOn','EXPIRED','floor','789213GOebpA','message','checkSinglePayment','has','log','checkPaymentStatus','schedule_created','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','./telegramBotService','\x20\x20\x20-\x20Amount:\x20','\x20\x20\x20📝\x20Context:','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20pending\x20CoinToPay\x20payments','payment.pending','default','\x20for\x20payment\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20status\x20from\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','createdOn','catch','iban','timestamp','unknown','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','gatewayOrderId','bankDetails','487425kfDBKc','-day\x20timeout','amount','762629wGvLmn','push','getDate','262VLoZYO','getPaymentTimerInfo','loggerService','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','payment.success','shopId','\x20\x20\x20📍\x20Source:\x20','1\x20minute','logCoinToPayStatus','toISOString','FAILED','paymentTimers','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20status:\x20','telegramBotService','COINTOPAY_STATUS_CHANGE','\x20\x20\x20-\x20ShopId:\x20','CoinToPayStatusService','1516KixQzJ','findMany','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','coinToPay2Service','\x20has\x20no\x20gatewayPaymentId','webhookUrl','Unknown\x20error','auto_expire','defineProperty','\x20status\x20changed\x20to\x20','❌\x20[HOURLY]\x20Payment\x20','stringify','includes','\x20days','\x20->\x20','webhook_send','delay','stack','📊\x20[CHECK]\x20Payment\x20','create','text','getGatewayIdByName','now','\x20status\x20is\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','webhookLog','../types/gateway','\x20completed\x20for\x20payment\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20payment\x20','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','getTime','\x20expired\x20CoinToPay\x20payments','Success','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','PAID','paid','⏰\x20[HOURLY]\x20Payment\x20','\x20is\x20older\x20than\x20'];a37_0x3fa2=function(){return _0x3ada4d;};return a37_0x3fa2();}class CoinToPayStatusService{constructor(){const _0x2e0d5e=a37_0x375869;this[_0x2e0d5e(0x120)]=null,this[_0x2e0d5e(0x1d7)]=0x3c*0x3c*0x3e8,this[_0x2e0d5e(0x125)]=0x5,this[_0x2e0d5e(0x156)]=new Map(),this[_0x2e0d5e(0x1de)]=new coinToPayService_1[(_0x2e0d5e(0x1cc))](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x2e0d5e(0x20c))](),console[_0x2e0d5e(0x12e)]('🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}[a37_0x375869(0x199)](_0x1750a9,_0x25604a){const _0x358b03=a37_0x375869;console[_0x358b03(0x12e)](_0x358b03(0x1f7)),console[_0x358b03(0x12e)](_0x358b03(0x19b)+_0x1750a9),console['log'](_0x358b03(0x1e3)+_0x25604a),this[_0x358b03(0x206)](_0x1750a9);const _0x7fc5d4=[],_0x49bfd2=new Date(),_0x7f4e13=[{'delay':0x1*0x3c*0x3e8,'description':_0x358b03(0x152)},{'delay':0x2*0x3c*0x3e8,'description':_0x358b03(0x1ab)},{'delay':0x5*0x3c*0x3e8,'description':_0x358b03(0x1bd)},{'delay':0x5*0x3c*0x3e8,'description':_0x358b03(0x1bd)}];console[_0x358b03(0x12e)](_0x358b03(0x205)+_0x7f4e13[_0x358b03(0x11e)]+_0x358b03(0x1b7)+_0x1750a9);let _0x2bd94a=0x0;_0x7f4e13[_0x358b03(0x20d)]((_0x1c2c77,_0x38f055)=>{const _0x4fa282=_0x358b03;_0x2bd94a+=_0x1c2c77[_0x4fa282(0x16d)];const _0x465de6=setTimeout(async()=>{const _0x17ade8=_0x4fa282;console['log']('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x38f055+0x1)+_0x17ade8(0x11d)+_0x1750a9+_0x17ade8(0x1d8)+_0x1c2c77[_0x17ade8(0x121)]+')');try{await this[_0x17ade8(0x19e)](_0x1750a9),console[_0x17ade8(0x12e)](_0x17ade8(0x1e6)+(_0x38f055+0x1)+_0x17ade8(0x179)+_0x1750a9);}catch(_0xd8d1cf){console[_0x17ade8(0x1e9)](_0x17ade8(0x203)+(_0x38f055+0x1)+'\x20for\x20payment\x20'+_0x1750a9+':',_0xd8d1cf),this[_0x17ade8(0x1f6)](_0x1750a9,_0x25604a,_0xd8d1cf,'status_check',{'checkNumber':_0x38f055+0x1,'scheduledAfter':_0x1c2c77['description'],'isIndividualCheck':!![]});}},_0x2bd94a);_0x7fc5d4[_0x4fa282(0x149)](_0x465de6),console[_0x4fa282(0x12e)](_0x4fa282(0x180)+(_0x38f055+0x1)+_0x4fa282(0x139)+_0x1750a9+_0x4fa282(0x1f0)+_0x2bd94a/0x3e8+_0x4fa282(0x1d3)+_0x1c2c77[_0x4fa282(0x121)]+')');});const _0x37bb93=setInterval(async()=>{const _0x522d66=_0x358b03;console[_0x522d66(0x12e)](_0x522d66(0x1c3)+_0x1750a9);try{const _0x3580ab=await database_1[_0x522d66(0x138)][_0x522d66(0x1a1)][_0x522d66(0x1cf)]({'where':{'id':_0x1750a9},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x3580ab){console[_0x522d66(0x12e)](_0x522d66(0x167)+_0x1750a9+_0x522d66(0x1bb)),this[_0x522d66(0x206)](_0x1750a9);return;}console['log'](_0x522d66(0x11f)+_0x1750a9+_0x522d66(0x185)+_0x3580ab[_0x522d66(0x212)]);if(_0x3580ab[_0x522d66(0x212)]!==_0x522d66(0x1d2)){console[_0x522d66(0x12e)](_0x522d66(0x1a6)+_0x1750a9+_0x522d66(0x174)+_0x3580ab[_0x522d66(0x212)]+_0x522d66(0x1b3)),this['clearPaymentTimers'](_0x1750a9);return;}const _0x1bd0ce=Math[_0x522d66(0x129)]((Date[_0x522d66(0x173)]()-_0x3580ab['createdAt'][_0x522d66(0x17d)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1bd0ce>=this['EXPIRY_DAYS']){console['log'](_0x522d66(0x183)+_0x1750a9+_0x522d66(0x184)+this[_0x522d66(0x125)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x522d66(0x206)](_0x1750a9);return;}await this['checkSinglePaymentById'](_0x1750a9),console[_0x522d66(0x12e)](_0x522d66(0x142)+_0x1750a9);}catch(_0x109223){console[_0x522d66(0x1e9)](_0x522d66(0x186)+_0x1750a9+':',_0x109223),this['logCoinToPayError'](_0x1750a9,_0x25604a,_0x109223,_0x522d66(0x1db),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x7fc5d4[_0x358b03(0x149)](_0x37bb93),this[_0x358b03(0x156)][_0x358b03(0x1f2)](_0x1750a9,{'timers':_0x7fc5d4,'paymentId':_0x1750a9,'gatewayPaymentId':_0x25604a,'createdAt':_0x49bfd2}),console[_0x358b03(0x12e)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x7f4e13['length']+_0x358b03(0x13a)+_0x1750a9),console['log']('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this['paymentTimers'][_0x358b03(0x1f5)]),this[_0x358b03(0x153)](_0x1750a9,_0x25604a,'PENDING',_0x358b03(0x1d2),_0x358b03(0x1db),{'action':_0x358b03(0x130),'scheduledChecks':_0x7f4e13['length'],'firstCheckIn':_0x7f4e13[0x0][_0x358b03(0x16d)]/0x3e8,'totalTimers':this[_0x358b03(0x156)][_0x358b03(0x1f5)]});}[a37_0x375869(0x206)](_0x16142b){const _0x364611=a37_0x375869,_0x507544=this['paymentTimers']['get'](_0x16142b);_0x507544?(console[_0x364611(0x12e)](_0x364611(0x18c)+_0x507544['timers'][_0x364611(0x11e)]+'\x20timers\x20for\x20payment\x20'+_0x16142b),_0x507544[_0x364611(0x1cd)][_0x364611(0x20d)]((_0x2daf64,_0x53f8ae)=>{const _0x59579f=_0x364611;_0x2daf64&&(clearTimeout(_0x2daf64),clearInterval(_0x2daf64),console[_0x59579f(0x12e)](_0x59579f(0x18f)+(_0x53f8ae+0x1)+_0x59579f(0x139)+_0x16142b));}),this['paymentTimers']['delete'](_0x16142b),console[_0x364611(0x12e)](_0x364611(0x1ba)+_0x16142b+_0x364611(0x201)+this[_0x364611(0x156)]['size'])):console[_0x364611(0x12e)](_0x364611(0x1b2)+_0x16142b+_0x364611(0x210));}async[a37_0x375869(0x19e)](_0x2b7807){const _0x87e8ad=a37_0x375869;console[_0x87e8ad(0x12e)](_0x87e8ad(0x13c)+_0x2b7807);const _0x5b47c4=await database_1[_0x87e8ad(0x138)][_0x87e8ad(0x1a1)][_0x87e8ad(0x1cf)]({'where':{'id':_0x2b7807},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5b47c4){console['log']('❌\x20[CHECK]\x20Payment\x20'+_0x2b7807+_0x87e8ad(0x1c4));return;}console[_0x87e8ad(0x12e)](_0x87e8ad(0x16f)+_0x2b7807+_0x87e8ad(0x1b5)),console['log'](_0x87e8ad(0x1c8)+_0x5b47c4[_0x87e8ad(0x1e8)]),console[_0x87e8ad(0x12e)]('\x20\x20\x20-\x20Status:\x20'+_0x5b47c4[_0x87e8ad(0x212)]),console[_0x87e8ad(0x12e)](_0x87e8ad(0x17a)+_0x5b47c4[_0x87e8ad(0x1f3)]),console[_0x87e8ad(0x12e)](_0x87e8ad(0x133)+_0x5b47c4[_0x87e8ad(0x147)]+'\x20'+_0x5b47c4['currency']),console[_0x87e8ad(0x12e)](_0x87e8ad(0x15b)+_0x5b47c4[_0x87e8ad(0x150)]);if(_0x5b47c4[_0x87e8ad(0x1e8)]!==_0x87e8ad(0x1e7)&&_0x5b47c4[_0x87e8ad(0x1e8)]!==_0x87e8ad(0x192)){console[_0x87e8ad(0x12e)](_0x87e8ad(0x19d)+_0x2b7807+'\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20'+_0x5b47c4[_0x87e8ad(0x1e8)]+')');return;}if(_0x5b47c4[_0x87e8ad(0x212)]!==_0x87e8ad(0x1d2)){console[_0x87e8ad(0x12e)](_0x87e8ad(0x19d)+_0x2b7807+_0x87e8ad(0x174)+_0x5b47c4[_0x87e8ad(0x212)]+_0x87e8ad(0x1b3)),this[_0x87e8ad(0x206)](_0x2b7807);return;}if(!_0x5b47c4[_0x87e8ad(0x1f3)]){console[_0x87e8ad(0x12e)](_0x87e8ad(0x19d)+_0x2b7807+_0x87e8ad(0x161));return;}console[_0x87e8ad(0x12e)](_0x87e8ad(0x18e)+_0x2b7807+_0x87e8ad(0x1d5)),await this[_0x87e8ad(0x12c)](_0x5b47c4);}[a37_0x375869(0x153)](_0x38247f,_0x2916ee,_0x4b27df,_0x4925e5,_0x4af0bb,_0x2ff5a3){const _0x5851a3=a37_0x375869,_0x3d3e8f={'type':_0x5851a3(0x15a),'paymentId':_0x38247f,'gatewayPaymentId':_0x2916ee,'oldStatus':_0x4b27df,'newStatus':_0x4925e5,'source':_0x4af0bb,'timestamp':new Date()[_0x5851a3(0x154)](),'details':_0x2ff5a3||{}};loggerService_1[_0x5851a3(0x14d)][_0x5851a3(0x153)](_0x3d3e8f),console['log'](_0x5851a3(0x197)+_0x38247f+'\x20('+_0x2916ee+')'),console[_0x5851a3(0x12e)](_0x5851a3(0x126)+_0x4b27df+_0x5851a3(0x16b)+_0x4925e5),console[_0x5851a3(0x12e)]('\x20\x20\x20📍\x20Source:\x20'+_0x4af0bb),console[_0x5851a3(0x12e)]('\x20\x20\x20📅\x20Time:\x20'+_0x3d3e8f[_0x5851a3(0x140)]),_0x2ff5a3&&console[_0x5851a3(0x12e)](_0x5851a3(0x1be),_0x2ff5a3);}[a37_0x375869(0x1f6)](_0x2cac27,_0xf645ff,_0x42b4ce,_0x313732,_0x5bb479){const _0x130d14=a37_0x375869,_0x26194c={'type':_0x130d14(0x1fb),'paymentId':_0x2cac27,'gatewayPaymentId':_0xf645ff,'error':_0x42b4ce instanceof Error?{'message':_0x42b4ce[_0x130d14(0x12b)],'stack':_0x42b4ce[_0x130d14(0x16e)]}:_0x42b4ce,'source':_0x313732,'timestamp':new Date()[_0x130d14(0x154)](),'context':_0x5bb479||{}};loggerService_1['loggerService'][_0x130d14(0x1f6)](_0x26194c),console[_0x130d14(0x1e9)](_0x130d14(0x1ad)+_0x2cac27+'\x20('+_0xf645ff+')'),console[_0x130d14(0x1e9)](_0x130d14(0x18d)+(_0x42b4ce instanceof Error?_0x42b4ce[_0x130d14(0x12b)]:_0x42b4ce)),console['error'](_0x130d14(0x151)+_0x313732),console[_0x130d14(0x1e9)]('\x20\x20\x20📅\x20Time:\x20'+_0x26194c[_0x130d14(0x140)]),_0x5bb479&&console['error'](_0x130d14(0x134),_0x5bb479);}['startPeriodicStatusCheck'](){const _0x5c6ebf=a37_0x375869;console[_0x5c6ebf(0x12e)]('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this['checkAllPendingPayments']()[_0x5c6ebf(0x13e)](_0x37323e=>{const _0x432a9d=_0x5c6ebf;console['error'](_0x432a9d(0x1a3),_0x37323e);}),this[_0x5c6ebf(0x120)]=setInterval(async()=>{const _0x4928aa=_0x5c6ebf;try{console['log'](_0x4928aa(0x20e)),await this[_0x4928aa(0x1df)](),console[_0x4928aa(0x12e)](_0x4928aa(0x1ae));}catch(_0x58468f){console['error']('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x58468f);}},this[_0x5c6ebf(0x1d7)]),console[_0x5c6ebf(0x12e)](_0x5c6ebf(0x1aa));}['stopPeriodicStatusCheck'](){const _0x597629=a37_0x375869;console[_0x597629(0x12e)](_0x597629(0x1e4));this[_0x597629(0x120)]&&(clearInterval(this[_0x597629(0x120)]),this['globalCheckInterval']=null,console[_0x597629(0x12e)](_0x597629(0x123)));const _0x57e2b6=this[_0x597629(0x156)][_0x597629(0x1f5)];for(const [_0x291920]of this[_0x597629(0x156)]){this[_0x597629(0x206)](_0x291920);}console[_0x597629(0x12e)]('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x57e2b6+'\x20individual\x20payment\x20timers');}async[a37_0x375869(0x1df)](){const _0x368955=a37_0x375869;try{console[_0x368955(0x12e)]('🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x2f96a1=await database_1[_0x368955(0x138)]['payment'][_0x368955(0x15e)]({'where':{'gateway':{'in':[_0x368955(0x1e7),_0x368955(0x192)]},'status':_0x368955(0x1d2),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x368955(0x12e)]('🪙\x20[GLOBAL]\x20Found\x20'+_0x2f96a1['length']+_0x368955(0x136));if(_0x2f96a1[_0x368955(0x11e)]===0x0){console[_0x368955(0x12e)](_0x368955(0x1eb));return;}const _0x980683=await this[_0x368955(0x202)](_0x2f96a1);console['log']('⏰\x20[GLOBAL]\x20Found\x20'+_0x980683[_0x368955(0x11e)]+_0x368955(0x17e));let _0x5ea531=0x0,_0x4460a9=0x0;for(const _0x582e6c of _0x2f96a1){try{if(_0x980683[_0x368955(0x169)](_0x582e6c['id'])){console[_0x368955(0x12e)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x582e6c['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x4460a9++;continue;}if(this[_0x368955(0x156)][_0x368955(0x12d)](_0x582e6c['id'])){console[_0x368955(0x12e)](_0x368955(0x1a2)+_0x582e6c['id']+_0x368955(0x175)),_0x4460a9++;continue;}const _0x3b8f20=(Date['now']()-_0x582e6c[_0x368955(0x1a7)][_0x368955(0x17d)]())/(0x3e8*0x3c*0x3c);if(_0x3b8f20<0x1){console[_0x368955(0x12e)](_0x368955(0x1a2)+_0x582e6c['id']+'\x20is\x20too\x20new\x20('+_0x3b8f20[_0x368955(0x1d9)](0x1)+_0x368955(0x190)),_0x4460a9++;continue;}console[_0x368955(0x12e)](_0x368955(0x14e)+_0x582e6c['id']+'\x20(age:\x20'+_0x3b8f20['toFixed'](0x1)+'h)'),await this[_0x368955(0x12c)](_0x582e6c),_0x5ea531++,await new Promise(_0x1fc091=>setTimeout(_0x1fc091,0x7d0));}catch(_0x1c807d){console[_0x368955(0x1e9)](_0x368955(0x1f8)+_0x582e6c['id']+':',_0x1c807d),this['logCoinToPayError'](_0x582e6c['id'],_0x582e6c[_0x368955(0x1f3)]||_0x368955(0x141),_0x1c807d,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x582e6c[_0x368955(0x147)],'paymentCurrency':_0x582e6c[_0x368955(0x194)],'shopId':_0x582e6c[_0x368955(0x150)],'createdAt':_0x582e6c[_0x368955(0x1a7)]}),loggerService_1[_0x368955(0x14d)][_0x368955(0x1c2)](_0x368955(0x1e7),_0x368955(0x1fd)+_0x582e6c[_0x368955(0x1f3)],_0x1c807d);}}console['log']('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x5ea531+_0x368955(0x1b4)+_0x4460a9+_0x368955(0x1ff)+_0x980683[_0x368955(0x11e)]+'\x20expired');}catch(_0xe4436d){console[_0x368955(0x1e9)](_0x368955(0x204),_0xe4436d);}}async[a37_0x375869(0x202)](_0x5425b9){const _0x3bdf09=a37_0x375869,_0x5d6c67=[],_0x4bab37=new Date();_0x4bab37[_0x3bdf09(0x1fe)](_0x4bab37[_0x3bdf09(0x14a)]()-this[_0x3bdf09(0x125)]),console[_0x3bdf09(0x12e)](_0x3bdf09(0x176)+this[_0x3bdf09(0x125)]+_0x3bdf09(0x1c0)+_0x4bab37[_0x3bdf09(0x154)]()+')');for(const _0x199a84 of _0x5425b9){if(_0x199a84[_0x3bdf09(0x1a7)]<_0x4bab37){console['log'](_0x3bdf09(0x1b1)+_0x199a84['id']+'\x20is\x20older\x20than\x20'+this[_0x3bdf09(0x125)]+_0x3bdf09(0x1e0));try{this[_0x3bdf09(0x153)](_0x199a84['id'],_0x199a84[_0x3bdf09(0x1f3)]||_0x3bdf09(0x141),_0x3bdf09(0x1d2),'EXPIRED','auto_expire',{'reason':_0x3bdf09(0x1da)+this['EXPIRY_DAYS']+_0x3bdf09(0x16a),'createdAt':_0x199a84[_0x3bdf09(0x1a7)],'daysSinceCreation':Math[_0x3bdf09(0x129)]((Date[_0x3bdf09(0x173)]()-_0x199a84[_0x3bdf09(0x1a7)][_0x3bdf09(0x17d)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x199a84[_0x3bdf09(0x147)],'paymentCurrency':_0x199a84[_0x3bdf09(0x194)],'shopId':_0x199a84['shopId']}),await database_1['default']['payment'][_0x3bdf09(0x1ce)]({'where':{'id':_0x199a84['id']},'data':{'status':_0x3bdf09(0x128),'updatedAt':new Date(),'adminNotes':_0x3bdf09(0x209)+this[_0x3bdf09(0x125)]+_0x3bdf09(0x189)}}),await database_1['default'][_0x3bdf09(0x177)][_0x3bdf09(0x170)]({'data':{'paymentId':_0x199a84['id'],'shopId':_0x199a84[_0x3bdf09(0x150)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x3bdf09(0x168)]({'reason':_0x3bdf09(0x1da)+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x199a84[_0x3bdf09(0x1a7)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math['floor']((Date['now']()-_0x199a84[_0x3bdf09(0x1a7)][_0x3bdf09(0x17d)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x3bdf09(0x1c1)](_0x199a84,_0x3bdf09(0x128)),await this[_0x3bdf09(0x1a8)](_0x199a84,_0x3bdf09(0x128)),this['clearPaymentTimers'](_0x199a84['id']),_0x5d6c67[_0x3bdf09(0x149)](_0x199a84['id']),console['log']('✅\x20[EXPIRY]\x20Payment\x20'+_0x199a84['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x3bdf09(0x125)]+_0x3bdf09(0x146));}catch(_0x246def){console['error']('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x199a84['id']+':',_0x246def),this[_0x3bdf09(0x1f6)](_0x199a84['id'],_0x199a84[_0x3bdf09(0x1f3)]||_0x3bdf09(0x141),_0x246def,_0x3bdf09(0x164),{'reason':_0x3bdf09(0x1b9),'createdAt':_0x199a84[_0x3bdf09(0x1a7)],'daysSinceCreation':Math[_0x3bdf09(0x129)]((Date[_0x3bdf09(0x173)]()-_0x199a84[_0x3bdf09(0x1a7)][_0x3bdf09(0x17d)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5d6c67;}async[a37_0x375869(0x12c)](_0x267a4d){const _0x293a25=a37_0x375869;if(!_0x267a4d[_0x293a25(0x1f3)]){console[_0x293a25(0x12e)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x267a4d['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console['log']('🔍\x20[CHECK]\x20Checking\x20'+_0x267a4d[_0x293a25(0x1e8)]+_0x293a25(0x17b)+_0x267a4d['id']+'\x20('+_0x267a4d[_0x293a25(0x1f3)]+')');try{let _0x49bf76;_0x267a4d['gateway']==='cointopay2'?(_0x49bf76=await this[_0x293a25(0x160)][_0x293a25(0x12f)](_0x267a4d[_0x293a25(0x1f3)]),console[_0x293a25(0x12e)](_0x293a25(0x131)+_0x267a4d['id']+_0x293a25(0x158)+_0x49bf76['status'])):(_0x49bf76=await this[_0x293a25(0x1de)]['checkPaymentStatus'](_0x267a4d[_0x293a25(0x1f3)]),console[_0x293a25(0x12e)](_0x293a25(0x135)+_0x267a4d['id']+'\x20status:\x20'+_0x49bf76[_0x293a25(0x212)]));_0x49bf76[_0x293a25(0x1a5)]&&console['log'](_0x293a25(0x16f)+_0x267a4d['id']+_0x293a25(0x1dd),{'iban':_0x49bf76[_0x293a25(0x1a5)][_0x293a25(0x13f)]||_0x293a25(0x19a),'transactionId':_0x49bf76[_0x293a25(0x1a5)]['transactionId'],'createdOn':_0x49bf76[_0x293a25(0x1a5)][_0x293a25(0x13d)],'confirmedOn':_0x49bf76[_0x293a25(0x1a5)][_0x293a25(0x127)]||_0x293a25(0x1e2)});if(_0x49bf76[_0x293a25(0x212)]!==_0x267a4d[_0x293a25(0x212)]){console[_0x293a25(0x12e)](_0x293a25(0x20a)+_0x267a4d['id']+_0x293a25(0x13b)+_0x267a4d[_0x293a25(0x212)]+_0x293a25(0x1ea)+_0x49bf76[_0x293a25(0x212)]),this[_0x293a25(0x153)](_0x267a4d['id'],_0x267a4d['gatewayPaymentId'],_0x267a4d[_0x293a25(0x212)],_0x49bf76[_0x293a25(0x212)],_0x293a25(0x1db),{'paymentDetails':_0x49bf76[_0x293a25(0x1a5)],'amount':_0x49bf76['amount'],'currency':_0x49bf76[_0x293a25(0x194)],'shopId':_0x267a4d[_0x293a25(0x150)],'checkTimestamp':new Date()[_0x293a25(0x154)]()});const _0x37b54c={'status':_0x49bf76[_0x293a25(0x212)],'updatedAt':new Date()};_0x49bf76[_0x293a25(0x212)]===_0x293a25(0x181)&&_0x267a4d['status']!==_0x293a25(0x181)&&(_0x37b54c['paidAt']=new Date(),console[_0x293a25(0x12e)](_0x293a25(0x198)+_0x267a4d['id']+_0x293a25(0x1fc)+_0x37b54c[_0x293a25(0x1e1)][_0x293a25(0x154)]()));if(_0x49bf76[_0x293a25(0x1a5)]){const _0x5a920e=_0x49bf76[_0x293a25(0x1a5)];_0x5a920e[_0x293a25(0x13f)]&&(_0x37b54c[_0x293a25(0x1cb)]=_0x5a920e[_0x293a25(0x13f)],console[_0x293a25(0x12e)](_0x293a25(0x15f)+_0x5a920e[_0x293a25(0x13f)]));if(_0x5a920e['bankDetails']){const _0x879e2e=_0x267a4d[_0x293a25(0x1a9)]||'',_0x333b43='Bank\x20Details:\x20'+_0x5a920e[_0x293a25(0x144)];_0x37b54c[_0x293a25(0x1a9)]=_0x879e2e?_0x879e2e+'\x0a\x0a'+_0x333b43:_0x333b43,console[_0x293a25(0x12e)](_0x293a25(0x1bc));}_0x5a920e[_0x293a25(0x1b6)]&&console['log'](_0x293a25(0x1d6)+_0x5a920e[_0x293a25(0x1b6)]),_0x5a920e[_0x293a25(0x127)]&&console[_0x293a25(0x12e)](_0x293a25(0x17c)+_0x5a920e[_0x293a25(0x127)]);}await database_1['default']['payment'][_0x293a25(0x1ce)]({'where':{'id':_0x267a4d['id']},'data':_0x37b54c}),await database_1[_0x293a25(0x138)]['webhookLog'][_0x293a25(0x170)]({'data':{'paymentId':_0x267a4d['id'],'shopId':_0x267a4d['shopId'],'event':_0x293a25(0x1bf)+_0x49bf76[_0x293a25(0x212)][_0x293a25(0x1ac)](),'statusCode':0xc8,'responseBody':JSON[_0x293a25(0x168)]({'oldStatus':_0x267a4d[_0x293a25(0x212)],'newStatus':_0x49bf76['status'],'paymentDetails':_0x49bf76[_0x293a25(0x1a5)],'checkedAt':new Date()[_0x293a25(0x154)]()})}}),await this[_0x293a25(0x1c1)](_0x267a4d,_0x49bf76[_0x293a25(0x212)]),await this[_0x293a25(0x1a8)](_0x267a4d,_0x49bf76['status']),_0x49bf76[_0x293a25(0x212)]!==_0x293a25(0x1d2)&&(console['log'](_0x293a25(0x1d0)+_0x267a4d['id']+_0x293a25(0x166)+_0x49bf76[_0x293a25(0x212)]+_0x293a25(0x19f)),this[_0x293a25(0x206)](_0x267a4d['id'])),console[_0x293a25(0x12e)](_0x293a25(0x18e)+_0x267a4d['id']+_0x293a25(0x1b0));}else console[_0x293a25(0x12e)](_0x293a25(0x16f)+_0x267a4d['id']+_0x293a25(0x191)+_0x49bf76[_0x293a25(0x212)]+')'),this[_0x293a25(0x153)](_0x267a4d['id'],_0x267a4d[_0x293a25(0x1f3)],_0x267a4d[_0x293a25(0x212)],_0x49bf76['status'],_0x293a25(0x1db),{'statusUnchanged':!![],'paymentDetails':_0x49bf76['paymentDetails'],'amount':_0x49bf76[_0x293a25(0x147)],'currency':_0x49bf76['currency'],'shopId':_0x267a4d[_0x293a25(0x150)],'checkTimestamp':new Date()[_0x293a25(0x154)]()});}catch(_0x52c535){console[_0x293a25(0x1e9)](_0x293a25(0x207)+_0x267a4d['id']+':',_0x52c535),this[_0x293a25(0x1f6)](_0x267a4d['id'],_0x267a4d[_0x293a25(0x1f3)],_0x52c535,'status_check',{'paymentAmount':_0x267a4d[_0x293a25(0x147)],'paymentCurrency':_0x267a4d['currency'],'shopId':_0x267a4d[_0x293a25(0x150)],'createdAt':_0x267a4d[_0x293a25(0x1a7)]}),await database_1[_0x293a25(0x138)][_0x293a25(0x177)][_0x293a25(0x170)]({'data':{'paymentId':_0x267a4d['id'],'shopId':_0x267a4d[_0x293a25(0x150)],'event':_0x293a25(0x1a0),'statusCode':0x1f4,'responseBody':JSON[_0x293a25(0x168)]({'error':_0x52c535 instanceof Error?_0x52c535['message']:_0x293a25(0x163),'gatewayPaymentId':_0x267a4d[_0x293a25(0x1f3)],'checkedAt':new Date()[_0x293a25(0x154)]()})}});}}async[a37_0x375869(0x1c1)](_0x5261e4,_0x21fd4f){const _0x32fbe3=a37_0x375869,_0x273eec=Date[_0x32fbe3(0x173)]();try{const _0x21dae5=_0x5261e4['shop'],_0x275cda=_0x21dae5[_0x32fbe3(0x18a)];if(!_0x275cda?.[_0x32fbe3(0x162)]){console[_0x32fbe3(0x12e)](_0x32fbe3(0x193)+_0x21dae5['id']);return;}const _0x5a8274=_0x21fd4f===_0x32fbe3(0x181)?_0x32fbe3(0x14f):_0x21fd4f===_0x32fbe3(0x155)?'payment.failed':_0x21fd4f===_0x32fbe3(0x128)?_0x32fbe3(0x196):_0x32fbe3(0x137);if(!_0x275cda[_0x32fbe3(0x1e5)]?.['includes'](_0x5a8274)){console[_0x32fbe3(0x12e)](_0x32fbe3(0x208)+_0x5a8274+'\x20not\x20enabled\x20for\x20shop\x20'+_0x21dae5['id']);return;}const _0x1bdd73=(0x0,gateway_1[_0x32fbe3(0x172)])(_0x5261e4[_0x32fbe3(0x1e8)])||_0x5261e4[_0x32fbe3(0x1e8)],_0x3e885a={'event':_0x5a8274,'payment':{'id':_0x5261e4['id'],'order_id':_0x5261e4[_0x32fbe3(0x1c9)],'gateway_order_id':_0x5261e4[_0x32fbe3(0x143)],'gateway':_0x1bdd73,'amount':_0x5261e4[_0x32fbe3(0x147)],'currency':_0x5261e4[_0x32fbe3(0x194)],'status':_0x21fd4f['toLowerCase'](),'customer_email':_0x5261e4[_0x32fbe3(0x1c5)],'customer_name':_0x5261e4[_0x32fbe3(0x1dc)],'created_at':_0x5261e4[_0x32fbe3(0x1a7)],'updated_at':new Date()}},_0x17366a=await fetch(_0x275cda[_0x32fbe3(0x162)],{'method':_0x32fbe3(0x195),'headers':{'Content-Type':'application/json','User-Agent':_0x32fbe3(0x18b)},'body':JSON[_0x32fbe3(0x168)](_0x3e885a)}),_0x60ae64=Date['now']()-_0x273eec,_0xa56cea=_0x17366a['ok']?_0x32fbe3(0x17f):await _0x17366a[_0x32fbe3(0x171)]();loggerService_1[_0x32fbe3(0x14d)]['logShopWebhookSent'](_0x5261e4[_0x32fbe3(0x150)],_0x275cda[_0x32fbe3(0x162)],_0x5a8274,_0x17366a[_0x32fbe3(0x212)],_0x60ae64,_0x3e885a),console['log'](_0x32fbe3(0x1f1)+_0x275cda[_0x32fbe3(0x162)]+_0x32fbe3(0x211)+_0x17366a['status']+'\x20('+_0x60ae64+_0x32fbe3(0x1ec));}catch(_0x3b8377){console[_0x32fbe3(0x1e9)](_0x32fbe3(0x20b),_0x3b8377),loggerService_1[_0x32fbe3(0x14d)][_0x32fbe3(0x1f4)](_0x5261e4[_0x32fbe3(0x150)],_0x5261e4[_0x32fbe3(0x200)]?.[_0x32fbe3(0x18a)]?.[_0x32fbe3(0x162)]||_0x32fbe3(0x141),_0x32fbe3(0x16c),_0x3b8377,{});}}async[a37_0x375869(0x1a8)](_0x20bd62,_0x3f21fe){const _0x20cdd7=a37_0x375869;try{const _0x40c555={'PENDING':'created','PAID':_0x20cdd7(0x182),'FAILED':'failed','EXPIRED':'expired'},_0x2f6df6=_0x40c555[_0x3f21fe];if(!_0x2f6df6||_0x2f6df6===_0x20cdd7(0x1fa))return;await telegramBotService_1[_0x20cdd7(0x159)][_0x20cdd7(0x124)](_0x20bd62['shopId'],_0x20bd62,_0x2f6df6);}catch(_0x48adbe){console[_0x20cdd7(0x1e9)](_0x20cdd7(0x20f),_0x48adbe);}}async[a37_0x375869(0x1c6)](_0x4094fb){const _0x3a6b0b=a37_0x375869;console[_0x3a6b0b(0x12e)](_0x3a6b0b(0x157)+_0x4094fb);const _0x51fd5f=await database_1[_0x3a6b0b(0x138)][_0x3a6b0b(0x1a1)][_0x3a6b0b(0x1cf)]({'where':{'id':_0x4094fb},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x51fd5f)throw new Error('Payment\x20not\x20found');if(_0x51fd5f['gateway']!==_0x3a6b0b(0x1e7)&&_0x51fd5f[_0x3a6b0b(0x1e8)]!==_0x3a6b0b(0x192))throw new Error(_0x3a6b0b(0x1d1));console[_0x3a6b0b(0x12e)](_0x3a6b0b(0x122)+_0x51fd5f['gateway']+_0x3a6b0b(0x17b)+_0x4094fb),await this['checkSinglePayment'](_0x51fd5f),console[_0x3a6b0b(0x12e)](_0x3a6b0b(0x1c7)+_0x4094fb);}['getServiceStats'](){const _0x45999b=a37_0x375869,_0x50716a=this[_0x45999b(0x120)]?this[_0x45999b(0x1d7)]:undefined,_0x1baae6=Array['from'](this[_0x45999b(0x156)]['values']())[_0x45999b(0x19c)](_0x447153=>({'paymentId':_0x447153['paymentId'],'gatewayPaymentId':_0x447153[_0x45999b(0x1f3)],'createdAt':_0x447153[_0x45999b(0x1a7)],'timersCount':_0x447153[_0x45999b(0x1cd)]['length']}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x45999b(0x1d7)]/(0x3e8*0x3c),'expiryDays':this[_0x45999b(0x125)],'activeIndividualTimers':this[_0x45999b(0x156)]['size'],'nextGlobalCheckIn':_0x50716a,'paymentTimersDetails':_0x1baae6};}[a37_0x375869(0x14c)](_0x312673){const _0x5d46be=a37_0x375869,_0x23c8fc=this[_0x5d46be(0x156)]['get'](_0x312673);if(_0x23c8fc)return{'hasTimers':!![],'timersCount':_0x23c8fc[_0x5d46be(0x1cd)][_0x5d46be(0x11e)],'createdAt':_0x23c8fc[_0x5d46be(0x1a7)],'gatewayPaymentId':_0x23c8fc[_0x5d46be(0x1f3)]};return{'hasTimers':![]};}}exports[a37_0x375869(0x15c)]=CoinToPayStatusService,exports[a37_0x375869(0x1ed)]=new CoinToPayStatusService();