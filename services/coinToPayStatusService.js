'use strict';const a35_0x4deeb0=a35_0x2f6b;(function(_0x1317bc,_0x2361a7){const _0x46b6b7=a35_0x2f6b,_0x1c583f=_0x1317bc();while(!![]){try{const _0x20ff64=-parseInt(_0x46b6b7(0x1c9))/0x1+parseInt(_0x46b6b7(0x1bc))/0x2*(-parseInt(_0x46b6b7(0x143))/0x3)+-parseInt(_0x46b6b7(0x1fa))/0x4*(-parseInt(_0x46b6b7(0x216))/0x5)+parseInt(_0x46b6b7(0x1dd))/0x6+parseInt(_0x46b6b7(0x1d5))/0x7+-parseInt(_0x46b6b7(0x182))/0x8*(-parseInt(_0x46b6b7(0x185))/0x9)+-parseInt(_0x46b6b7(0x1ba))/0xa;if(_0x20ff64===_0x2361a7)break;else _0x1c583f['push'](_0x1c583f['shift']());}catch(_0x109bc1){_0x1c583f['push'](_0x1c583f['shift']());}}}(a35_0x3f2d,0xdec2d));function a35_0x3f2d(){const _0x4343ad=['logShopWebhookSent','toFixed','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','globalCheckInterval','update','\x20days\x20(created\x20before\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','6025vOKoTU','\x20\x20\x20-\x20paymentId:\x20','1\x20minute','\x20status\x20changed\x20to\x20','2\x20minutes','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','\x20is\x20too\x20new\x20(','\x20marked\x20as\x20paid\x20at:\x20','sendPaymentNotification','toISOString','currency','logWhiteDomainError','delay','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','gateway','\x20\x20\x20-\x20Status:\x20','2685utXLgy','\x20(after\x20','h),\x20skipping\x20global\x20check','‚è∞\x20[GLOBAL]\x20Found\x20','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','not\x20found','\x20completed\x20for\x20payment\x20','checkExpiredPayments','status_check','schedule_created','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20days\x20without\x20payment\x20confirmation','bankDetails','\x20\x20\x20üìÖ\x20Time:\x20','\x20status\x20is\x20','shopId','toLowerCase','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','üßπ\x20[DEBUG]\x20Clearing\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','not\x20confirmed','\x20\x20\x20-\x20Amount:\x20','error','timers','\x20is\x20valid\x20for\x20checking,\x20proceeding...','‚è∞\x20[EXPIRY]\x20Payment\x20','ü™ô\x20[DEBUG]\x20Creating\x20','webhookUrl','failed','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','getTime','./gateways/coinToPayService','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','\x20is\x20older\x20than\x20','text','coinToPayStatusService','\x20pending\x20CoinToPay\x20payments','loggerService','logCoinToPayStatus','COINTOPAY_ERROR','\x20\x20\x20-\x20ShopId:\x20','payment','\x20current\x20status:\x20','unknown','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','üßπ\x20[CHECK]\x20Payment\x20','‚úÖ\x20[HOURLY]\x20Payment\x20','clearPaymentTimers','coinToPayService','timestamp','5\x20minutes','default','checkPaymentStatus','\x20in\x20','confirmedOn','\x20status\x20from\x20','FAILED','checkSinglePayment','amount','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','__esModule','232mfOsec','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','COINTOPAY_STATUS_CHANGE','15354BvNOkU','üí∞\x20[CHECK]\x20Payment\x20','\x20skipped,\x20','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','paymentDetails','üìä\x20[HOURLY]\x20Payment\x20','create','message','checkPaymentById','CoinToPayStatusService','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20with\x20status\x20','\x20\x20\x20-\x20Gateway:\x20','sendPaymentStatusNotification','now','EXPIRY_DAYS','\x20status:\x20','length','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','customerName','webhookEvents','Success','\x20timers\x20for\x20payment\x20','\x20not\x20found\x20in\x20database','Webhook\x20event\x20','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','log','gatewayPaymentId','\x20to\x20','\x20\x20\x20üìç\x20Source:\x20','ms)','includes','\x20\x20\x20üìä\x20Status:\x20','PAID','CoinToPayService','webhookLog','description','stringify','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20updated\x20successfully','logCoinToPayError','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','stopPeriodicStatusCheck','map','status','\x20to\x20clear','\x20has\x20no\x20gatewayPaymentId','paid','checkSinglePaymentById','30386390jLKVek','getServiceStats','1022yPjbXW','../config/database','shop','customerEmail','createdAt','remitterIban','cointopay_status_check_','floor','\x20expired','\x20days','üìä\x20[CHECK]\x20Payment\x20','EXPIRED','expired','370166AqLlxf','checkAllPendingPayments','Failed\x20to\x20send\x20shop\x20webhook:','‚úÖ\x20[CHECK]\x20Payment\x20','auto_expire','has','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','findMany','gatewayOrderId','paymentTimers','Unknown\x20error','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','11718959GVDKii','POST','Shop\x20webhook\x20sent\x20to\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','startPeriodicStatusCheck','size','\x20\x20\x20‚ùå\x20Error:\x20','Automatically\x20expired\x20after\x20','10297278FmELfR','\x20not\x20found,\x20clearing\x20timers','set','settings','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','PENDING','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20individual\x20payment\x20timers','\x20found:','schedulePaymentChecks','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20',',\x20stopping\x20individual\x20checks','GLOBAL_CHECK_INTERVAL_MS','Payment\x20older\x20than\x20','\x20->\x20','payment.failed','payment.success','\x20initial\x20timers\x20for\x20payment\x20','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','webhook_send','setDate','sendShopWebhook','findUnique','iban','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','cointopay','-day\x20timeout','4444DgoWxB','\x20(age:\x20','\x20checked,\x20','stack','‚è∞\x20[GLOBAL]\x20Payment\x20','ü™ô\x20[GLOBAL]\x20Found\x20','transactionId','\x20seconds\x20(','./telegramBotService','push','getDate','\x20\x20\x20üìù\x20Details:',',\x20clearing\x20individual\x20timers','values','created','\x20for\x20payment\x20','\x20\x20\x20üìù\x20Context:','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','ü™ô\x20CoinToPayStatusService\x20initialized','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','forEach'];a35_0x3f2d=function(){return _0x4343ad;};return a35_0x3f2d();}var __importDefault=this&&this['__importDefault']||function(_0x443a6e){const _0x1e0f01=a35_0x2f6b;return _0x443a6e&&_0x443a6e[_0x1e0f01(0x181)]?_0x443a6e:{'default':_0x443a6e};};Object['defineProperty'](exports,a35_0x4deeb0(0x181),{'value':!![]}),exports[a35_0x4deeb0(0x168)]=exports[a35_0x4deeb0(0x18e)]=void 0x0;const coinToPayService_1=require(a35_0x4deeb0(0x164)),database_1=__importDefault(require(a35_0x4deeb0(0x1bd))),telegramBotService_1=require(a35_0x4deeb0(0x202)),loggerService_1=require('./loggerService');function a35_0x2f6b(_0x116058,_0x1cb8a6){const _0x3f2dcb=a35_0x3f2d();return a35_0x2f6b=function(_0x2f6b46,_0x2b88b1){_0x2f6b46=_0x2f6b46-0x13e;let _0x1b5488=_0x3f2dcb[_0x2f6b46];return _0x1b5488;},a35_0x2f6b(_0x116058,_0x1cb8a6);}class CoinToPayStatusService{constructor(){const _0x3bb3ab=a35_0x4deeb0;this[_0x3bb3ab(0x212)]=null,this[_0x3bb3ab(0x1ea)]=0x3c*0x3c*0x3e8,this[_0x3bb3ab(0x194)]=0x5,this[_0x3bb3ab(0x1d2)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x3bb3ab(0x1a9))](),console['log'](_0x3bb3ab(0x20c));}[a35_0x4deeb0(0x1e7)](_0x1976ba,_0x5b6a47){const _0x935781=a35_0x4deeb0;console[_0x935781(0x1a1)](_0x935781(0x183)),console[_0x935781(0x1a1)](_0x935781(0x217)+_0x1976ba),console['log'](_0x935781(0x1ae)+_0x5b6a47),this[_0x935781(0x174)](_0x1976ba);const _0x1674eb=[],_0x1c4378=new Date(),_0x68082c=[{'delay':0x1*0x3c*0x3e8,'description':_0x935781(0x218)},{'delay':0x2*0x3c*0x3e8,'description':_0x935781(0x21a)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x935781(0x177)}];console[_0x935781(0x1a1)](_0x935781(0x15e)+_0x68082c[_0x935781(0x196)]+_0x935781(0x1ef)+_0x1976ba);let _0x30d147=0x0;_0x68082c[_0x935781(0x20e)]((_0x3513b6,_0x3783ae)=>{const _0x546fbe=_0x935781;_0x30d147+=_0x3513b6[_0x546fbe(0x13f)];const _0x3a4634=setTimeout(async()=>{const _0x4e112c=_0x546fbe;console[_0x4e112c(0x1a1)]('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x3783ae+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x1976ba+_0x4e112c(0x144)+_0x3513b6[_0x4e112c(0x1ab)]+')');try{await this[_0x4e112c(0x1b9)](_0x1976ba),console[_0x4e112c(0x1a1)](_0x4e112c(0x155)+(_0x3783ae+0x1)+_0x4e112c(0x14a)+_0x1976ba);}catch(_0x2c6c9c){console[_0x4e112c(0x15a)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x3783ae+0x1)+_0x4e112c(0x209)+_0x1976ba+':',_0x2c6c9c),this[_0x4e112c(0x1b1)](_0x1976ba,_0x5b6a47,_0x2c6c9c,_0x4e112c(0x14c),{'checkNumber':_0x3783ae+0x1,'scheduledAfter':_0x3513b6[_0x4e112c(0x1ab)],'isIndividualCheck':!![]});}},_0x30d147);_0x1674eb['push'](_0x3a4634),console[_0x546fbe(0x1a1)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x3783ae+0x1)+_0x546fbe(0x209)+_0x1976ba+_0x546fbe(0x17a)+_0x30d147/0x3e8+_0x546fbe(0x201)+_0x3513b6[_0x546fbe(0x1ab)]+')');});const _0x14fc4b=setInterval(async()=>{const _0xee675a=_0x935781;console[_0xee675a(0x1a1)](_0xee675a(0x1af)+_0x1976ba);try{const _0x41ea96=await database_1[_0xee675a(0x178)][_0xee675a(0x16e)][_0xee675a(0x1f5)]({'where':{'id':_0x1976ba},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x41ea96){console[_0xee675a(0x1a1)]('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x1976ba+_0xee675a(0x1de)),this['clearPaymentTimers'](_0x1976ba);return;}console[_0xee675a(0x1a1)](_0xee675a(0x18a)+_0x1976ba+_0xee675a(0x16f)+_0x41ea96[_0xee675a(0x1b5)]);if(_0x41ea96[_0xee675a(0x1b5)]!==_0xee675a(0x1e3)){console[_0xee675a(0x1a1)](_0xee675a(0x173)+_0x1976ba+_0xee675a(0x152)+_0x41ea96[_0xee675a(0x1b5)]+_0xee675a(0x1e9)),this[_0xee675a(0x174)](_0x1976ba);return;}const _0xaab852=Math[_0xee675a(0x1c3)]((Date[_0xee675a(0x193)]()-_0x41ea96[_0xee675a(0x1c0)][_0xee675a(0x163)]())/(0x3e8*0x3c*0x3c*0x18));if(_0xaab852>=this[_0xee675a(0x194)]){console[_0xee675a(0x1a1)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x1976ba+'\x20is\x20older\x20than\x20'+this[_0xee675a(0x194)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this['clearPaymentTimers'](_0x1976ba);return;}await this[_0xee675a(0x1b9)](_0x1976ba),console[_0xee675a(0x1a1)](_0xee675a(0x1cf)+_0x1976ba);}catch(_0x262556){console[_0xee675a(0x15a)]('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x1976ba+':',_0x262556),this[_0xee675a(0x1b1)](_0x1976ba,_0x5b6a47,_0x262556,_0xee675a(0x14c),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x1674eb[_0x935781(0x203)](_0x14fc4b),this[_0x935781(0x1d2)][_0x935781(0x1df)](_0x1976ba,{'timers':_0x1674eb,'paymentId':_0x1976ba,'gatewayPaymentId':_0x5b6a47,'createdAt':_0x1c4378}),console[_0x935781(0x1a1)](_0x935781(0x1ad)+_0x68082c[_0x935781(0x196)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x1976ba),console[_0x935781(0x1a1)](_0x935781(0x1f1)+this['paymentTimers'][_0x935781(0x1da)]),this[_0x935781(0x16b)](_0x1976ba,_0x5b6a47,_0x935781(0x1e3),'PENDING','status_check',{'action':_0x935781(0x14d),'scheduledChecks':_0x68082c[_0x935781(0x196)],'firstCheckIn':_0x68082c[0x0][_0x935781(0x13f)]/0x3e8,'totalTimers':this['paymentTimers']['size']});}[a35_0x4deeb0(0x174)](_0x4ac44e){const _0xdff80e=a35_0x4deeb0,_0x126956=this[_0xdff80e(0x1d2)]['get'](_0x4ac44e);_0x126956?(console[_0xdff80e(0x1a1)](_0xdff80e(0x156)+_0x126956['timers'][_0xdff80e(0x196)]+_0xdff80e(0x19c)+_0x4ac44e),_0x126956[_0xdff80e(0x15b)]['forEach']((_0x318b96,_0x69d11b)=>{const _0x34d059=_0xdff80e;_0x318b96&&(clearTimeout(_0x318b96),clearInterval(_0x318b96),console[_0x34d059(0x1a1)](_0x34d059(0x18f)+(_0x69d11b+0x1)+_0x34d059(0x209)+_0x4ac44e));}),this[_0xdff80e(0x1d2)]['delete'](_0x4ac44e),console[_0xdff80e(0x1a1)](_0xdff80e(0x180)+_0x4ac44e+'.\x20Remaining\x20active\x20timers:\x20'+this[_0xdff80e(0x1d2)]['size'])):console[_0xdff80e(0x1a1)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x4ac44e+_0xdff80e(0x1b6));}async[a35_0x4deeb0(0x1b9)](_0x12e17e){const _0x9b90d7=a35_0x4deeb0;console[_0x9b90d7(0x1a1)]('üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x12e17e);const _0x33f5e4=await database_1[_0x9b90d7(0x178)][_0x9b90d7(0x16e)][_0x9b90d7(0x1f5)]({'where':{'id':_0x12e17e},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x33f5e4){console[_0x9b90d7(0x1a1)]('‚ùå\x20[CHECK]\x20Payment\x20'+_0x12e17e+_0x9b90d7(0x19d));return;}console[_0x9b90d7(0x1a1)](_0x9b90d7(0x1c6)+_0x12e17e+_0x9b90d7(0x1e6)),console[_0x9b90d7(0x1a1)](_0x9b90d7(0x191)+_0x33f5e4['gateway']),console[_0x9b90d7(0x1a1)](_0x9b90d7(0x142)+_0x33f5e4[_0x9b90d7(0x1b5)]),console[_0x9b90d7(0x1a1)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x33f5e4[_0x9b90d7(0x1a2)]),console[_0x9b90d7(0x1a1)](_0x9b90d7(0x159)+_0x33f5e4[_0x9b90d7(0x17f)]+'\x20'+_0x33f5e4[_0x9b90d7(0x220)]),console[_0x9b90d7(0x1a1)](_0x9b90d7(0x16d)+_0x33f5e4[_0x9b90d7(0x153)]);if(_0x33f5e4[_0x9b90d7(0x141)]!==_0x9b90d7(0x1f8)){console['log'](_0x9b90d7(0x1b2)+_0x12e17e+_0x9b90d7(0x21b)+_0x33f5e4[_0x9b90d7(0x141)]+')');return;}if(_0x33f5e4['status']!==_0x9b90d7(0x1e3)){console[_0x9b90d7(0x1a1)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x12e17e+'\x20status\x20is\x20'+_0x33f5e4[_0x9b90d7(0x1b5)]+',\x20stopping\x20individual\x20checks'),this[_0x9b90d7(0x174)](_0x12e17e);return;}if(!_0x33f5e4[_0x9b90d7(0x1a2)]){console[_0x9b90d7(0x1a1)](_0x9b90d7(0x1b2)+_0x12e17e+_0x9b90d7(0x1b7));return;}console[_0x9b90d7(0x1a1)](_0x9b90d7(0x1cc)+_0x12e17e+_0x9b90d7(0x15c)),await this['checkSinglePayment'](_0x33f5e4);}[a35_0x4deeb0(0x16b)](_0xe3064e,_0x194125,_0x424796,_0x1278f8,_0x442848,_0x40c181){const _0x1b70ee=a35_0x4deeb0,_0x4a54f4={'type':_0x1b70ee(0x184),'paymentId':_0xe3064e,'gatewayPaymentId':_0x194125,'oldStatus':_0x424796,'newStatus':_0x1278f8,'source':_0x442848,'timestamp':new Date()[_0x1b70ee(0x21f)](),'details':_0x40c181||{}};loggerService_1[_0x1b70ee(0x16a)][_0x1b70ee(0x16b)](_0x4a54f4),console[_0x1b70ee(0x1a1)](_0x1b70ee(0x198)+_0xe3064e+'\x20('+_0x194125+')'),console['log'](_0x1b70ee(0x1a7)+_0x424796+_0x1b70ee(0x1ec)+_0x1278f8),console[_0x1b70ee(0x1a1)](_0x1b70ee(0x1a4)+_0x442848),console['log'](_0x1b70ee(0x151)+_0x4a54f4[_0x1b70ee(0x176)]),_0x40c181&&console['log'](_0x1b70ee(0x205),_0x40c181);}[a35_0x4deeb0(0x1b1)](_0x505a64,_0x1a6eb7,_0x2d504d,_0x3d5d23,_0x20777d){const _0x5d2d21=a35_0x4deeb0,_0x518818={'type':_0x5d2d21(0x16c),'paymentId':_0x505a64,'gatewayPaymentId':_0x1a6eb7,'error':_0x2d504d instanceof Error?{'message':_0x2d504d[_0x5d2d21(0x18c)],'stack':_0x2d504d[_0x5d2d21(0x1fd)]}:_0x2d504d,'source':_0x3d5d23,'timestamp':new Date()['toISOString'](),'context':_0x20777d||{}};loggerService_1['loggerService'][_0x5d2d21(0x1b1)](_0x518818),console['error'](_0x5d2d21(0x211)+_0x505a64+'\x20('+_0x1a6eb7+')'),console[_0x5d2d21(0x15a)](_0x5d2d21(0x1db)+(_0x2d504d instanceof Error?_0x2d504d['message']:_0x2d504d)),console[_0x5d2d21(0x15a)](_0x5d2d21(0x1a4)+_0x3d5d23),console[_0x5d2d21(0x15a)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x518818[_0x5d2d21(0x176)]),_0x20777d&&console['error'](_0x5d2d21(0x20a),_0x20777d);}[a35_0x4deeb0(0x1d9)](){const _0x4eca08=a35_0x4deeb0;console[_0x4eca08(0x1a1)](_0x4eca08(0x148)),this[_0x4eca08(0x1ca)]()['catch'](_0x15c0a6=>{const _0x3a8808=_0x4eca08;console['error'](_0x3a8808(0x188),_0x15c0a6);}),this['globalCheckInterval']=setInterval(async()=>{const _0x2e9335=_0x4eca08;try{console[_0x2e9335(0x1a1)](_0x2e9335(0x1e1)),await this[_0x2e9335(0x1ca)](),console[_0x2e9335(0x1a1)](_0x2e9335(0x157));}catch(_0x27ffd0){console[_0x2e9335(0x15a)](_0x2e9335(0x1e2),_0x27ffd0);}},this[_0x4eca08(0x1ea)]),console['log']('‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a35_0x4deeb0(0x1b3)](){const _0x12baa4=a35_0x4deeb0;console['log'](_0x12baa4(0x14e));this[_0x12baa4(0x212)]&&(clearInterval(this[_0x12baa4(0x212)]),this[_0x12baa4(0x212)]=null,console[_0x12baa4(0x1a1)](_0x12baa4(0x215)));const _0x2acb7a=this[_0x12baa4(0x1d2)][_0x12baa4(0x1da)];for(const [_0xbb5503]of this[_0x12baa4(0x1d2)]){this[_0x12baa4(0x174)](_0xbb5503);}console[_0x12baa4(0x1a1)]('üõë\x20[SHUTDOWN]\x20Cleared\x20'+_0x2acb7a+_0x12baa4(0x1e5));}async[a35_0x4deeb0(0x1ca)](){const _0x2fdd1b=a35_0x4deeb0;try{console[_0x2fdd1b(0x1a1)](_0x2fdd1b(0x20d));const _0x510e31=await database_1['default'][_0x2fdd1b(0x16e)][_0x2fdd1b(0x1d0)]({'where':{'gateway':'cointopay','status':_0x2fdd1b(0x1e3),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x2fdd1b(0x1a1)](_0x2fdd1b(0x1ff)+_0x510e31[_0x2fdd1b(0x196)]+_0x2fdd1b(0x169));if(_0x510e31[_0x2fdd1b(0x196)]===0x0){console[_0x2fdd1b(0x1a1)](_0x2fdd1b(0x162));return;}const _0x3ea750=await this[_0x2fdd1b(0x14b)](_0x510e31);console['log'](_0x2fdd1b(0x146)+_0x3ea750[_0x2fdd1b(0x196)]+'\x20expired\x20CoinToPay\x20payments');let _0x5dd7e3=0x0,_0x30c5ad=0x0;for(const _0x14d18f of _0x510e31){try{if(_0x3ea750[_0x2fdd1b(0x1a6)](_0x14d18f['id'])){console['log'](_0x2fdd1b(0x1fe)+_0x14d18f['id']+_0x2fdd1b(0x1d8)),_0x30c5ad++;continue;}if(this['paymentTimers'][_0x2fdd1b(0x1ce)](_0x14d18f['id'])){console['log'](_0x2fdd1b(0x1fe)+_0x14d18f['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x30c5ad++;continue;}const _0x4e6315=(Date[_0x2fdd1b(0x193)]()-_0x14d18f[_0x2fdd1b(0x1c0)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x4e6315<0x1){console[_0x2fdd1b(0x1a1)](_0x2fdd1b(0x1fe)+_0x14d18f['id']+_0x2fdd1b(0x21c)+_0x4e6315[_0x2fdd1b(0x210)](0x1)+_0x2fdd1b(0x145)),_0x30c5ad++;continue;}console[_0x2fdd1b(0x1a1)](_0x2fdd1b(0x165)+_0x14d18f['id']+_0x2fdd1b(0x1fb)+_0x4e6315[_0x2fdd1b(0x210)](0x1)+'h)'),await this[_0x2fdd1b(0x17e)](_0x14d18f),_0x5dd7e3++,await new Promise(_0x169893=>setTimeout(_0x169893,0x7d0));}catch(_0xd6a11d){console[_0x2fdd1b(0x15a)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x14d18f['id']+':',_0xd6a11d),this['logCoinToPayError'](_0x14d18f['id'],_0x14d18f[_0x2fdd1b(0x1a2)]||_0x2fdd1b(0x170),_0xd6a11d,_0x2fdd1b(0x14c),{'isGlobalCheck':!![],'paymentAmount':_0x14d18f[_0x2fdd1b(0x17f)],'paymentCurrency':_0x14d18f['currency'],'shopId':_0x14d18f[_0x2fdd1b(0x153)],'createdAt':_0x14d18f[_0x2fdd1b(0x1c0)]}),loggerService_1[_0x2fdd1b(0x16a)][_0x2fdd1b(0x13e)](_0x2fdd1b(0x1f8),'/status/'+_0x14d18f[_0x2fdd1b(0x1a2)],_0xd6a11d);}}console['log'](_0x2fdd1b(0x1e8)+_0x5dd7e3+_0x2fdd1b(0x1fc)+_0x30c5ad+_0x2fdd1b(0x187)+_0x3ea750[_0x2fdd1b(0x196)]+_0x2fdd1b(0x1c4));}catch(_0x1c6a53){console[_0x2fdd1b(0x15a)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x1c6a53);}}async[a35_0x4deeb0(0x14b)](_0x420736){const _0x6b1177=a35_0x4deeb0,_0x1d1ffa=[],_0x359879=new Date();_0x359879[_0x6b1177(0x1f3)](_0x359879[_0x6b1177(0x204)]()-this[_0x6b1177(0x194)]),console[_0x6b1177(0x1a1)](_0x6b1177(0x1d4)+this[_0x6b1177(0x194)]+_0x6b1177(0x214)+_0x359879['toISOString']()+')');for(const _0x2d89c1 of _0x420736){if(_0x2d89c1[_0x6b1177(0x1c0)]<_0x359879){console['log'](_0x6b1177(0x15d)+_0x2d89c1['id']+_0x6b1177(0x166)+this[_0x6b1177(0x194)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x6b1177(0x16b)](_0x2d89c1['id'],_0x2d89c1['gatewayPaymentId']||_0x6b1177(0x170),_0x6b1177(0x1e3),_0x6b1177(0x1c7),_0x6b1177(0x1cd),{'reason':_0x6b1177(0x1eb)+this[_0x6b1177(0x194)]+_0x6b1177(0x1c5),'createdAt':_0x2d89c1[_0x6b1177(0x1c0)],'daysSinceCreation':Math[_0x6b1177(0x1c3)]((Date['now']()-_0x2d89c1[_0x6b1177(0x1c0)][_0x6b1177(0x163)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x2d89c1['amount'],'paymentCurrency':_0x2d89c1['currency'],'shopId':_0x2d89c1[_0x6b1177(0x153)]}),await database_1[_0x6b1177(0x178)][_0x6b1177(0x16e)][_0x6b1177(0x213)]({'where':{'id':_0x2d89c1['id']},'data':{'status':_0x6b1177(0x1c7),'updatedAt':new Date(),'adminNotes':_0x6b1177(0x1dc)+this[_0x6b1177(0x194)]+_0x6b1177(0x14f)}}),await database_1[_0x6b1177(0x178)][_0x6b1177(0x1aa)][_0x6b1177(0x18b)]({'data':{'paymentId':_0x2d89c1['id'],'shopId':_0x2d89c1[_0x6b1177(0x153)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x6b1177(0x1ac)]({'reason':_0x6b1177(0x1eb)+this[_0x6b1177(0x194)]+_0x6b1177(0x1c5),'createdAt':_0x2d89c1[_0x6b1177(0x1c0)],'expiredAt':new Date()[_0x6b1177(0x21f)](),'daysSinceCreation':Math['floor']((Date[_0x6b1177(0x193)]()-_0x2d89c1[_0x6b1177(0x1c0)][_0x6b1177(0x163)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x6b1177(0x1f4)](_0x2d89c1,'EXPIRED'),await this['sendPaymentStatusNotification'](_0x2d89c1,_0x6b1177(0x1c7)),this[_0x6b1177(0x174)](_0x2d89c1['id']),_0x1d1ffa[_0x6b1177(0x203)](_0x2d89c1['id']),console[_0x6b1177(0x1a1)]('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x2d89c1['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x6b1177(0x194)]+_0x6b1177(0x1f9));}catch(_0x274144){console[_0x6b1177(0x15a)](_0x6b1177(0x20b)+_0x2d89c1['id']+':',_0x274144),this[_0x6b1177(0x1b1)](_0x2d89c1['id'],_0x2d89c1[_0x6b1177(0x1a2)]||'unknown',_0x274144,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x2d89c1[_0x6b1177(0x1c0)],'daysSinceCreation':Math[_0x6b1177(0x1c3)]((Date[_0x6b1177(0x193)]()-_0x2d89c1['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x1d1ffa;}async[a35_0x4deeb0(0x17e)](_0x3b1970){const _0x3a3890=a35_0x4deeb0;if(!_0x3b1970[_0x3a3890(0x1a2)]){console[_0x3a3890(0x1a1)](_0x3a3890(0x1b2)+_0x3b1970['id']+_0x3a3890(0x1a0));return;}console['log']('üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x3b1970['id']+'\x20('+_0x3b1970[_0x3a3890(0x1a2)]+')');try{const _0x109c09=await this[_0x3a3890(0x175)][_0x3a3890(0x179)](_0x3b1970['gatewayPaymentId']);console[_0x3a3890(0x1a1)](_0x3a3890(0x1c6)+_0x3b1970['id']+_0x3a3890(0x195)+_0x109c09[_0x3a3890(0x1b5)]);_0x109c09['paymentDetails']&&console['log'](_0x3a3890(0x1c6)+_0x3b1970['id']+'\x20details:',{'iban':_0x109c09[_0x3a3890(0x189)]['iban']||_0x3a3890(0x149),'transactionId':_0x109c09[_0x3a3890(0x189)][_0x3a3890(0x200)],'createdOn':_0x109c09[_0x3a3890(0x189)]['createdOn'],'confirmedOn':_0x109c09[_0x3a3890(0x189)][_0x3a3890(0x17b)]||_0x3a3890(0x158)});if(_0x109c09[_0x3a3890(0x1b5)]!==_0x3b1970[_0x3a3890(0x1b5)]){console[_0x3a3890(0x1a1)](_0x3a3890(0x147)+_0x3b1970['id']+_0x3a3890(0x17c)+_0x3b1970[_0x3a3890(0x1b5)]+_0x3a3890(0x1a3)+_0x109c09['status']),this[_0x3a3890(0x16b)](_0x3b1970['id'],_0x3b1970['gatewayPaymentId'],_0x3b1970[_0x3a3890(0x1b5)],_0x109c09[_0x3a3890(0x1b5)],_0x3a3890(0x14c),{'paymentDetails':_0x109c09[_0x3a3890(0x189)],'amount':_0x109c09[_0x3a3890(0x17f)],'currency':_0x109c09[_0x3a3890(0x220)],'shopId':_0x3b1970['shopId'],'checkTimestamp':new Date()[_0x3a3890(0x21f)]()});const _0x51ca22={'status':_0x109c09['status'],'updatedAt':new Date()};_0x109c09[_0x3a3890(0x1b5)]===_0x3a3890(0x1a8)&&_0x3b1970[_0x3a3890(0x1b5)]!==_0x3a3890(0x1a8)&&(_0x51ca22['paidAt']=new Date(),console[_0x3a3890(0x1a1)](_0x3a3890(0x186)+_0x3b1970['id']+_0x3a3890(0x21d)+_0x51ca22['paidAt']['toISOString']()));if(_0x109c09[_0x3a3890(0x189)]){const _0x149f79=_0x109c09[_0x3a3890(0x189)];_0x149f79[_0x3a3890(0x1f6)]&&(_0x51ca22[_0x3a3890(0x1c1)]=_0x149f79[_0x3a3890(0x1f6)],console[_0x3a3890(0x1a1)](_0x3a3890(0x197)+_0x149f79[_0x3a3890(0x1f6)]));if(_0x149f79['bankDetails']){const _0x4ec676=_0x3b1970['adminNotes']||'',_0x5e5cde='Bank\x20Details:\x20'+_0x149f79[_0x3a3890(0x150)];_0x51ca22['adminNotes']=_0x4ec676?_0x4ec676+'\x0a\x0a'+_0x5e5cde:_0x5e5cde,console[_0x3a3890(0x1a1)](_0x3a3890(0x161));}_0x149f79['transactionId']&&console['log'](_0x3a3890(0x171)+_0x149f79['transactionId']),_0x149f79[_0x3a3890(0x17b)]&&console['log'](_0x3a3890(0x1f0)+_0x149f79[_0x3a3890(0x17b)]);}await database_1['default'][_0x3a3890(0x16e)][_0x3a3890(0x213)]({'where':{'id':_0x3b1970['id']},'data':_0x51ca22}),await database_1[_0x3a3890(0x178)]['webhookLog'][_0x3a3890(0x18b)]({'data':{'paymentId':_0x3b1970['id'],'shopId':_0x3b1970[_0x3a3890(0x153)],'event':_0x3a3890(0x1c2)+_0x109c09[_0x3a3890(0x1b5)][_0x3a3890(0x154)](),'statusCode':0xc8,'responseBody':JSON[_0x3a3890(0x1ac)]({'oldStatus':_0x3b1970[_0x3a3890(0x1b5)],'newStatus':_0x109c09[_0x3a3890(0x1b5)],'paymentDetails':_0x109c09[_0x3a3890(0x189)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x3a3890(0x1f4)](_0x3b1970,_0x109c09[_0x3a3890(0x1b5)]),await this[_0x3a3890(0x192)](_0x3b1970,_0x109c09[_0x3a3890(0x1b5)]),_0x109c09[_0x3a3890(0x1b5)]!==_0x3a3890(0x1e3)&&(console[_0x3a3890(0x1a1)](_0x3a3890(0x172)+_0x3b1970['id']+_0x3a3890(0x219)+_0x109c09[_0x3a3890(0x1b5)]+_0x3a3890(0x206)),this[_0x3a3890(0x174)](_0x3b1970['id'])),console['log'](_0x3a3890(0x1cc)+_0x3b1970['id']+_0x3a3890(0x1b0));}else console[_0x3a3890(0x1a1)](_0x3a3890(0x1c6)+_0x3b1970['id']+'\x20status\x20unchanged\x20('+_0x109c09[_0x3a3890(0x1b5)]+')'),this[_0x3a3890(0x16b)](_0x3b1970['id'],_0x3b1970[_0x3a3890(0x1a2)],_0x3b1970['status'],_0x109c09[_0x3a3890(0x1b5)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x109c09[_0x3a3890(0x189)],'amount':_0x109c09[_0x3a3890(0x17f)],'currency':_0x109c09[_0x3a3890(0x220)],'shopId':_0x3b1970['shopId'],'checkTimestamp':new Date()[_0x3a3890(0x21f)]()});}catch(_0x2af8b8){console['error'](_0x3a3890(0x19f)+_0x3b1970['id']+':',_0x2af8b8),this[_0x3a3890(0x1b1)](_0x3b1970['id'],_0x3b1970[_0x3a3890(0x1a2)],_0x2af8b8,_0x3a3890(0x14c),{'paymentAmount':_0x3b1970['amount'],'paymentCurrency':_0x3b1970['currency'],'shopId':_0x3b1970[_0x3a3890(0x153)],'createdAt':_0x3b1970[_0x3a3890(0x1c0)]}),await database_1[_0x3a3890(0x178)][_0x3a3890(0x1aa)][_0x3a3890(0x18b)]({'data':{'paymentId':_0x3b1970['id'],'shopId':_0x3b1970['shopId'],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x3a3890(0x1ac)]({'error':_0x2af8b8 instanceof Error?_0x2af8b8[_0x3a3890(0x18c)]:_0x3a3890(0x1d3),'gatewayPaymentId':_0x3b1970[_0x3a3890(0x1a2)],'checkedAt':new Date()[_0x3a3890(0x21f)]()})}});}}async[a35_0x4deeb0(0x1f4)](_0xc0b5c5,_0x2efa2c){const _0x192ac2=a35_0x4deeb0,_0x149e06=Date[_0x192ac2(0x193)]();try{const _0x1a011a=_0xc0b5c5[_0x192ac2(0x1be)],_0x58ed87=_0x1a011a[_0x192ac2(0x1e0)];if(!_0x58ed87?.[_0x192ac2(0x15f)]){console[_0x192ac2(0x1a1)](_0x192ac2(0x1e4)+_0x1a011a['id']);return;}const _0x9f8c7b=_0x2efa2c===_0x192ac2(0x1a8)?_0x192ac2(0x1ee):_0x2efa2c===_0x192ac2(0x17d)?_0x192ac2(0x1ed):_0x2efa2c==='EXPIRED'?_0x192ac2(0x1ed):'payment.pending';if(!_0x58ed87[_0x192ac2(0x19a)]?.[_0x192ac2(0x1a6)](_0x9f8c7b)){console['log'](_0x192ac2(0x19e)+_0x9f8c7b+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1a011a['id']);return;}const _0x485e7f={'event':_0x9f8c7b,'payment':{'id':_0xc0b5c5['id'],'order_id':_0xc0b5c5['orderId'],'gateway_order_id':_0xc0b5c5[_0x192ac2(0x1d1)],'gateway':'0100','amount':_0xc0b5c5['amount'],'currency':_0xc0b5c5['currency'],'status':_0x2efa2c[_0x192ac2(0x154)](),'customer_email':_0xc0b5c5[_0x192ac2(0x1bf)],'customer_name':_0xc0b5c5[_0x192ac2(0x199)],'created_at':_0xc0b5c5['createdAt'],'updated_at':new Date()}},_0x1977ed=await fetch(_0x58ed87['webhookUrl'],{'method':_0x192ac2(0x1d6),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x485e7f)}),_0x2b626b=Date[_0x192ac2(0x193)]()-_0x149e06,_0x475190=_0x1977ed['ok']?_0x192ac2(0x19b):await _0x1977ed[_0x192ac2(0x167)]();loggerService_1[_0x192ac2(0x16a)][_0x192ac2(0x20f)](_0xc0b5c5['shopId'],_0x58ed87[_0x192ac2(0x15f)],_0x9f8c7b,_0x1977ed[_0x192ac2(0x1b5)],_0x2b626b,_0x485e7f),console[_0x192ac2(0x1a1)](_0x192ac2(0x1d7)+_0x58ed87[_0x192ac2(0x15f)]+_0x192ac2(0x190)+_0x1977ed['status']+'\x20('+_0x2b626b+_0x192ac2(0x1a5));}catch(_0x301904){console[_0x192ac2(0x15a)](_0x192ac2(0x1cb),_0x301904),loggerService_1[_0x192ac2(0x16a)]['logShopWebhookError'](_0xc0b5c5[_0x192ac2(0x153)],_0xc0b5c5['shop']?.[_0x192ac2(0x1e0)]?.[_0x192ac2(0x15f)]||'unknown',_0x192ac2(0x1f2),_0x301904,{});}}async['sendPaymentStatusNotification'](_0x3c0354,_0x21ad44){const _0x52df0c=a35_0x4deeb0;try{const _0x4745ec={'PENDING':'created','PAID':_0x52df0c(0x1b8),'FAILED':_0x52df0c(0x160),'EXPIRED':_0x52df0c(0x1c8)},_0x292bbf=_0x4745ec[_0x21ad44];if(!_0x292bbf||_0x292bbf===_0x52df0c(0x208))return;await telegramBotService_1['telegramBotService'][_0x52df0c(0x21e)](_0x3c0354[_0x52df0c(0x153)],_0x3c0354,_0x292bbf);}catch(_0x1dcf8c){console[_0x52df0c(0x15a)](_0x52df0c(0x1f7),_0x1dcf8c);}}async[a35_0x4deeb0(0x18d)](_0x231e10){const _0x1ff23b=a35_0x4deeb0;console[_0x1ff23b(0x1a1)]('üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x231e10);const _0x349c39=await database_1[_0x1ff23b(0x178)][_0x1ff23b(0x16e)][_0x1ff23b(0x1f5)]({'where':{'id':_0x231e10},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x349c39)throw new Error('Payment\x20not\x20found');if(_0x349c39['gateway']!==_0x1ff23b(0x1f8))throw new Error(_0x1ff23b(0x140));console['log']('‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x231e10),await this[_0x1ff23b(0x17e)](_0x349c39),console[_0x1ff23b(0x1a1)]('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x231e10);}[a35_0x4deeb0(0x1bb)](){const _0x3d9417=a35_0x4deeb0,_0x2a6fe0=this[_0x3d9417(0x212)]?this[_0x3d9417(0x1ea)]:undefined,_0x4d67c6=Array['from'](this[_0x3d9417(0x1d2)][_0x3d9417(0x207)]())[_0x3d9417(0x1b4)](_0x46daf8=>({'paymentId':_0x46daf8['paymentId'],'gatewayPaymentId':_0x46daf8[_0x3d9417(0x1a2)],'createdAt':_0x46daf8[_0x3d9417(0x1c0)],'timersCount':_0x46daf8['timers']['length']}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x3d9417(0x1ea)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this['paymentTimers'][_0x3d9417(0x1da)],'nextGlobalCheckIn':_0x2a6fe0,'paymentTimersDetails':_0x4d67c6};}['getPaymentTimerInfo'](_0x1bab43){const _0x311a30=a35_0x4deeb0,_0x5bd66c=this['paymentTimers']['get'](_0x1bab43);if(_0x5bd66c)return{'hasTimers':!![],'timersCount':_0x5bd66c[_0x311a30(0x15b)][_0x311a30(0x196)],'createdAt':_0x5bd66c[_0x311a30(0x1c0)],'gatewayPaymentId':_0x5bd66c['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a35_0x4deeb0(0x18e)]=CoinToPayStatusService,exports[a35_0x4deeb0(0x168)]=new CoinToPayStatusService();