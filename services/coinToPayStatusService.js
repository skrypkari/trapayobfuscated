'use strict';const a48_0xae1340=a48_0x521d;(function(_0x45581b,_0x5e340c){const _0x47ec11=a48_0x521d,_0x135bfa=_0x45581b();while(!![]){try{const _0x3f69b8=-parseInt(_0x47ec11(0x245))/0x1*(-parseInt(_0x47ec11(0x298))/0x2)+parseInt(_0x47ec11(0x2c9))/0x3*(-parseInt(_0x47ec11(0x21b))/0x4)+parseInt(_0x47ec11(0x20d))/0x5+parseInt(_0x47ec11(0x258))/0x6*(parseInt(_0x47ec11(0x26e))/0x7)+parseInt(_0x47ec11(0x1ed))/0x8*(-parseInt(_0x47ec11(0x1e7))/0x9)+-parseInt(_0x47ec11(0x1e4))/0xa*(parseInt(_0x47ec11(0x200))/0xb)+parseInt(_0x47ec11(0x2a2))/0xc;if(_0x3f69b8===_0x5e340c)break;else _0x135bfa['push'](_0x135bfa['shift']());}catch(_0x2934cd){_0x135bfa['push'](_0x135bfa['shift']());}}}(a48_0x10e7,0x587a5));function a48_0x521d(_0x17198b,_0x41692a){_0x17198b=_0x17198b-0x1de;const _0x10e768=a48_0x10e7();let _0x521d8a=_0x10e768[_0x17198b];return _0x521d8a;}function a48_0x10e7(){const _0x2aba36=['toISOString','COINTOPAY_ERROR','findMany','/status/','ðŸª™\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','675618AaEjrM','â°\x20[DEBUG]\x20Scheduled\x20check\x20#','webhookLog','toLowerCase','application/json','sendPaymentStatusNotification','PAID','\x20\x20\x20ðŸ“…\x20Time:\x20','message','âœ…\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','timers','createdAt','\x20marked\x20as\x20paid\x20at:\x20','getServiceStats','âŒ\x20[HOURLY]\x20Payment\x20','paymentDetails','setDate','ðŸª™\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','â°\x20[GLOBAL]\x20Payment\x20','âœ…\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','Webhook\x20event\x20','paidAt','7nnZoan','âš ï¸\x20[CHECK]\x20Payment\x20','ðŸ¦\x20[CHECK]\x20Bank\x20details\x20provided:\x20','\x20\x20\x20-\x20ShopId:\x20','paymentId','gateway','logCoinToPayStatus','gatewayCommissionRate','âœ…\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','orderId','created','Failed\x20to\x20mark\x20payment\x20as\x20expired','âŒ\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','unknown','get','CoinToPay2Service','length','./gateways/coinToPay2Service','\x20\x20\x20ðŸ“\x20Source:\x20','â°\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','ðŸª™\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20(after\x20','amountAfterGatewayCommissionUSDT','âŒ\x20[CHECK]\x20Payment\x20','values','coinToPay2Service','map','ðŸ“Š\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','../config/database','./gateways/coinToPayService','transactionId','âœ…\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','getGatewayCommission','parse','ðŸ§¹\x20[DEBUG]\x20Clearing\x20','checkSinglePaymentById','paid','stringify','\x20updated:\x20currentPayments=','expired','SINGLE','ðŸ’°\x20[CHECK]\x20Payment\x20','471178cXarhY','create','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','\x20status\x20changed\x20to\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','âœ…\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','../types/gateway','cointopay_status_check_','â°\x20[HOURLY]\x20Payment\x20','1\x20minute','2869860ONlVFb','size','commission','gatewaySettings','cointopay','\x20for\x20payment\x20','schedule_created','getGatewayIdByName','shopId','globalCheckInterval','schedulePaymentChecks','ðŸª™\x20[DEBUG]\x20Creating\x20','âŒ\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','ðŸª™\x20[GLOBAL]\x20Found\x20','\x20in\x20shop\x20','\x20pending\x20CoinToPay\x20payments','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','\x20\x20\x20-\x20Gateway:\x20','getPaymentTimerInfo','ðŸ”\x20[CHECK]\x20Checking\x20','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','Unknown\x20error','payment.success','ðŸ†”\x20[CHECK]\x20Transaction\x20ID:\x20','__esModule','currentPayments','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','\x20details:','paymentLink','EXPIRED','âœ…\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','Success','CoinToPayService','paymentTimers','ðŸ”\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','payment','ðŸ“Š\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20\x20\x20Gateway\x20','forEach','3XtlhQJ','checkSinglePayment','ðŸª™\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','__importDefault','\x20updated\x20successfully','delete','entries','update','CoinToPayStatusService','\x20->\x20','cointopay2','ðŸ“Š\x20[CHECK]\x20Payment\x20','POST','Payment\x20older\x20than\x20','\x20checked,\x20','sendShopWebhook','\x20payment\x20','customerName','\x20expired','ðŸ“Š\x20[CHECK]\x20CoinToPay2\x20payment\x20','\x20\x20\x20-\x20paymentId:\x20','\x20to\x20clear','\x20days','â°\x20[GLOBAL]\x20Found\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','settings',',\x20clearing\x20individual\x20timers','remitterIban','status_check','ðŸª™\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20\x20\x20ðŸ“\x20Context:','timestamp','âŒ\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','\x20with\x20status\x20','\x20current\x20status:\x20','â°\x20[EXPIRY]\x20Payment\x20','\x20expired\x20CoinToPay\x20payments','currency','\x20\x20\x20-\x20Amount:\x20','confirmedOn','âœ…\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','gatewayPaymentId','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','âœ…\x20[CHECK]\x20Payment\x20',',\x20gateway\x20','checkAllPendingPayments','10qHLNSZ','\x20\x20\x20ðŸ“\x20Details:','\x20amounts\x20calculated:','576027kDkLeQ','\x20not\x20found\x20in\x20database','âŒ\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','from','ðŸ“Š\x20[HOURLY]\x20Payment\x20','createdOn','56VTXyqK','webhook_send','-day\x20timeout','GLOBAL_CHECK_INTERVAL_MS','âŒ\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20is\x20too\x20new\x20(','\x20status\x20is\x20','ðŸ›‘\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','checkPaymentStatus','toFixed','\x20not\x20found,\x20clearing\x20timers','\x20USDT','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','auto_expire','Shop\x20webhook\x20sent\x20to\x20','shop','\x20is\x20older\x20than\x20','1001CdJzAT','\x20status\x20from\x20','Payment\x20System/1.0','ms)','ðŸª™\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','\x20\x20\x20âŒ\x20Error:\x20','findUnique','not\x20found','\x20timers\x20for\x20payment\x20','\x20found:','default','h),\x20skipping\x20global\x20check','has','142460awzdne','push','iban','error','ðŸ§¹\x20[DEBUG]\x20Cleared\x20timer\x20#','currencyService','Failed\x20to\x20send\x20shop\x20webhook:','getTime','delay','webhookUrl','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','ðŸª™\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20has\x20no\x20gatewayPaymentId,\x20skipping','customerEmail','163644aNiuTS','set','.\x20Remaining\x20active\x20timers:\x20','coinToPayService','amount',',\x20using\x20default\x2010%','floor','âŒ\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','logWhiteDomainError','ðŸ“ˆ\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','description','PENDING','âœ…\x20[EXPIRY]\x20Payment\x20','startPeriodicStatusCheck','\x20skipped,\x20','\x20commission\x20for\x20shop\x20','ðŸ›‘\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','ðŸ”„\x20[CHECK]\x20Updating\x20payment\x20','ðŸª™\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20\x20\x20-\x20gatewayPaymentId:\x20','logCoinToPayError','getDate','âŒ\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','log','COMPLETED','./telegramBotService','clearPaymentTimers','failed','ðŸª™\x20[TIMER]\x20Individual\x20check\x20#','amountUSDT','status','\x20status:\x20','ðŸ“ˆ\x20[COINTOPAY]\x20Payment\x20','webhookEvents','checkExpiredPayments','EXPIRY_DAYS','defineProperty','ðŸ›‘\x20[SHUTDOWN]\x20Cleared\x20','payment.pending','type','coinToPayStatusService','\x20\x20\x20Amount:\x20','2VfQgEI','ðŸª™\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','âŒ\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','sendPaymentNotification','stack','2\x20minutes','now','5\x20minutes','ðŸ¦\x20[CHECK]\x20Saved\x20IBAN:\x20','bankDetails','loggerService','âœ…\x20[COINTOPAY]\x20Payment\x20link\x20','FAILED','\x20not\x20enabled\x20for\x20shop\x20'];a48_0x10e7=function(){return _0x2aba36;};return a48_0x10e7();}var __importDefault=this&&this[a48_0xae1340(0x2cc)]||function(_0x20eaf8){const _0x239308=a48_0xae1340;return _0x20eaf8&&_0x20eaf8[_0x239308(0x2ba)]?_0x20eaf8:{'default':_0x20eaf8};};Object[a48_0xae1340(0x23f)](exports,'__esModule',{'value':!![]}),exports['coinToPayStatusService']=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a48_0xae1340(0x28b)),coinToPay2Service_1=require(a48_0xae1340(0x27f)),gateway_1=require(a48_0xae1340(0x29e)),database_1=__importDefault(require(a48_0xae1340(0x28a))),telegramBotService_1=require(a48_0xae1340(0x234)),loggerService_1=require('./loggerService'),currencyService_1=require('./currencyService');class CoinToPayStatusService{constructor(){const _0x430b58=a48_0xae1340;this[_0x430b58(0x2ab)]=null,this[_0x430b58(0x1f0)]=0x3c*0x3c*0x3e8,this[_0x430b58(0x23e)]=0x5,this[_0x430b58(0x2c3)]=new Map(),this[_0x430b58(0x21e)]=new coinToPayService_1[(_0x430b58(0x2c2))](),this[_0x430b58(0x287)]=new coinToPay2Service_1[(_0x430b58(0x27d))](),console[_0x430b58(0x232)](_0x430b58(0x204));}[a48_0xae1340(0x2ac)](_0x27abf0,_0x51c089){const _0x58280e=a48_0xae1340;console[_0x58280e(0x232)](_0x58280e(0x22d)),console[_0x58280e(0x232)](_0x58280e(0x2dd)+_0x27abf0),console['log'](_0x58280e(0x22e)+_0x51c089),this[_0x58280e(0x235)](_0x27abf0);const _0x3852a6=[],_0x139ecf=new Date(),_0x581fca=[{'delay':0x1*0x3c*0x3e8,'description':_0x58280e(0x2a1)},{'delay':0x2*0x3c*0x3e8,'description':_0x58280e(0x24a)},{'delay':0x5*0x3c*0x3e8,'description':_0x58280e(0x24c)},{'delay':0x5*0x3c*0x3e8,'description':_0x58280e(0x24c)}];console[_0x58280e(0x232)](_0x58280e(0x2ad)+_0x581fca[_0x58280e(0x27e)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x27abf0);let _0x21612c=0x0;_0x581fca[_0x58280e(0x2c8)]((_0x5764dd,_0x1c3ecc)=>{const _0x2c5fd9=_0x58280e;_0x21612c+=_0x5764dd[_0x2c5fd9(0x215)];const _0x1e25e1=setTimeout(async()=>{const _0x439138=_0x2c5fd9;console[_0x439138(0x232)](_0x439138(0x237)+(_0x1c3ecc+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x27abf0+_0x439138(0x283)+_0x5764dd['description']+')');try{await this[_0x439138(0x291)](_0x27abf0),console['log']('âœ…\x20[TIMER]\x20Individual\x20check\x20#'+(_0x1c3ecc+0x1)+'\x20completed\x20for\x20payment\x20'+_0x27abf0);}catch(_0x376205){console[_0x439138(0x210)]('âŒ\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x1c3ecc+0x1)+_0x439138(0x2a7)+_0x27abf0+':',_0x376205),this[_0x439138(0x22f)](_0x27abf0,_0x51c089,_0x376205,'status_check',{'checkNumber':_0x1c3ecc+0x1,'scheduledAfter':_0x5764dd[_0x439138(0x225)],'isIndividualCheck':!![]});}},_0x21612c);_0x3852a6[_0x2c5fd9(0x20e)](_0x1e25e1),console[_0x2c5fd9(0x232)](_0x2c5fd9(0x259)+(_0x1c3ecc+0x1)+'\x20for\x20payment\x20'+_0x27abf0+'\x20in\x20'+_0x21612c/0x3e8+'\x20seconds\x20('+_0x5764dd[_0x2c5fd9(0x225)]+')');});const _0x179d1a=setInterval(async()=>{const _0x148cb9=_0x58280e;console['log'](_0x148cb9(0x2cb)+_0x27abf0);try{const _0x97c37e=await database_1[_0x148cb9(0x20a)][_0x148cb9(0x2c5)][_0x148cb9(0x206)]({'where':{'id':_0x27abf0},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x97c37e){console[_0x148cb9(0x232)](_0x148cb9(0x266)+_0x27abf0+_0x148cb9(0x1f8)),this[_0x148cb9(0x235)](_0x27abf0);return;}console[_0x148cb9(0x232)](_0x148cb9(0x1eb)+_0x27abf0+_0x148cb9(0x2eb)+_0x97c37e['status']);if(_0x97c37e[_0x148cb9(0x239)]!=='PENDING'){console['log']('âœ…\x20[HOURLY]\x20Payment\x20'+_0x27abf0+_0x148cb9(0x1f3)+_0x97c37e[_0x148cb9(0x239)]+',\x20stopping\x20individual\x20checks'),this['clearPaymentTimers'](_0x27abf0);return;}const _0x2b7f5f=Math['floor']((Date[_0x148cb9(0x24b)]()-_0x97c37e[_0x148cb9(0x263)][_0x148cb9(0x214)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x2b7f5f>=this[_0x148cb9(0x23e)]){console[_0x148cb9(0x232)](_0x148cb9(0x2a0)+_0x27abf0+'\x20is\x20older\x20than\x20'+this[_0x148cb9(0x23e)]+_0x148cb9(0x1e0)),this['clearPaymentTimers'](_0x27abf0);return;}await this['checkSinglePaymentById'](_0x27abf0),console[_0x148cb9(0x232)](_0x148cb9(0x276)+_0x27abf0);}catch(_0x2a4f2e){console[_0x148cb9(0x210)](_0x148cb9(0x1e9)+_0x27abf0+':',_0x2a4f2e),this[_0x148cb9(0x22f)](_0x27abf0,_0x51c089,_0x2a4f2e,_0x148cb9(0x2e5),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3852a6[_0x58280e(0x20e)](_0x179d1a),this[_0x58280e(0x2c3)][_0x58280e(0x21c)](_0x27abf0,{'timers':_0x3852a6,'paymentId':_0x27abf0,'gatewayPaymentId':_0x51c089,'createdAt':_0x139ecf}),console[_0x58280e(0x232)]('âœ…\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x581fca['length']+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x27abf0),console['log'](_0x58280e(0x289)+this['paymentTimers'][_0x58280e(0x2a3)]),this['logCoinToPayStatus'](_0x27abf0,_0x51c089,_0x58280e(0x226),_0x58280e(0x226),_0x58280e(0x2e5),{'action':_0x58280e(0x2a8),'scheduledChecks':_0x581fca[_0x58280e(0x27e)],'firstCheckIn':_0x581fca[0x0]['delay']/0x3e8,'totalTimers':this[_0x58280e(0x2c3)][_0x58280e(0x2a3)]});}[a48_0xae1340(0x235)](_0x2c2061){const _0x57c4eb=a48_0xae1340,_0x151234=this[_0x57c4eb(0x2c3)][_0x57c4eb(0x27c)](_0x2c2061);_0x151234?(console[_0x57c4eb(0x232)](_0x57c4eb(0x290)+_0x151234[_0x57c4eb(0x262)]['length']+_0x57c4eb(0x208)+_0x2c2061),_0x151234[_0x57c4eb(0x262)]['forEach']((_0x273f39,_0x453d7a)=>{const _0x240de1=_0x57c4eb;_0x273f39&&(clearTimeout(_0x273f39),clearInterval(_0x273f39),console['log'](_0x240de1(0x211)+(_0x453d7a+0x1)+'\x20for\x20payment\x20'+_0x2c2061));}),this[_0x57c4eb(0x2c3)][_0x57c4eb(0x2ce)](_0x2c2061),console[_0x57c4eb(0x232)](_0x57c4eb(0x28d)+_0x2c2061+_0x57c4eb(0x21d)+this[_0x57c4eb(0x2c3)][_0x57c4eb(0x2a3)])):console[_0x57c4eb(0x232)]('âš ï¸\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x2c2061+_0x57c4eb(0x2de));}async['checkSinglePaymentById'](_0x483a9f){const _0x3e52e1=a48_0xae1340;console[_0x3e52e1(0x232)]('ðŸ”\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x483a9f);const _0x162bf7=await database_1['default']['payment'][_0x3e52e1(0x206)]({'where':{'id':_0x483a9f},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x162bf7){console[_0x3e52e1(0x232)](_0x3e52e1(0x285)+_0x483a9f+_0x3e52e1(0x1e8));return;}console[_0x3e52e1(0x232)](_0x3e52e1(0x2d4)+_0x483a9f+_0x3e52e1(0x209)),console['log'](_0x3e52e1(0x2b3)+_0x162bf7[_0x3e52e1(0x273)]),console[_0x3e52e1(0x232)]('\x20\x20\x20-\x20Status:\x20'+_0x162bf7[_0x3e52e1(0x239)]),console[_0x3e52e1(0x232)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x162bf7[_0x3e52e1(0x1df)]),console[_0x3e52e1(0x232)](_0x3e52e1(0x2ef)+_0x162bf7[_0x3e52e1(0x21f)]+'\x20'+_0x162bf7['currency']),console[_0x3e52e1(0x232)](_0x3e52e1(0x271)+_0x162bf7[_0x3e52e1(0x2aa)]);if(_0x162bf7[_0x3e52e1(0x273)]!=='cointopay'&&_0x162bf7[_0x3e52e1(0x273)]!=='cointopay2'){console[_0x3e52e1(0x232)](_0x3e52e1(0x26f)+_0x483a9f+_0x3e52e1(0x2b6)+_0x162bf7[_0x3e52e1(0x273)]+')');return;}if(_0x162bf7[_0x3e52e1(0x239)]!=='PENDING'){console['log'](_0x3e52e1(0x26f)+_0x483a9f+_0x3e52e1(0x1f3)+_0x162bf7[_0x3e52e1(0x239)]+',\x20stopping\x20individual\x20checks'),this[_0x3e52e1(0x235)](_0x483a9f);return;}if(!_0x162bf7[_0x3e52e1(0x1df)]){console[_0x3e52e1(0x232)](_0x3e52e1(0x26f)+_0x483a9f+'\x20has\x20no\x20gatewayPaymentId');return;}console['log'](_0x3e52e1(0x1e1)+_0x483a9f+_0x3e52e1(0x1de)),await this[_0x3e52e1(0x2ca)](_0x162bf7);}[a48_0xae1340(0x274)](_0x2101fc,_0x184611,_0x151499,_0x4fae39,_0xa731db,_0x1bac1e){const _0x52b8f7=a48_0xae1340,_0x1d349f={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x2101fc,'gatewayPaymentId':_0x184611,'oldStatus':_0x151499,'newStatus':_0x4fae39,'source':_0xa731db,'timestamp':new Date()[_0x52b8f7(0x253)](),'details':_0x1bac1e||{}};loggerService_1[_0x52b8f7(0x24f)][_0x52b8f7(0x274)](_0x1d349f),console[_0x52b8f7(0x232)](_0x52b8f7(0x269)+_0x2101fc+'\x20('+_0x184611+')'),console[_0x52b8f7(0x232)]('\x20\x20\x20ðŸ“Š\x20Status:\x20'+_0x151499+_0x52b8f7(0x2d2)+_0x4fae39),console[_0x52b8f7(0x232)]('\x20\x20\x20ðŸ“\x20Source:\x20'+_0xa731db),console[_0x52b8f7(0x232)](_0x52b8f7(0x25f)+_0x1d349f[_0x52b8f7(0x2e8)]),_0x1bac1e&&console[_0x52b8f7(0x232)](_0x52b8f7(0x1e5),_0x1bac1e);}[a48_0xae1340(0x22f)](_0x44bfe6,_0x45c2bb,_0x466321,_0x5aa7de,_0x7c7f8a){const _0x329aa5=a48_0xae1340,_0x3164f7={'type':_0x329aa5(0x254),'paymentId':_0x44bfe6,'gatewayPaymentId':_0x45c2bb,'error':_0x466321 instanceof Error?{'message':_0x466321['message'],'stack':_0x466321[_0x329aa5(0x249)]}:_0x466321,'source':_0x5aa7de,'timestamp':new Date()[_0x329aa5(0x253)](),'context':_0x7c7f8a||{}};loggerService_1[_0x329aa5(0x24f)][_0x329aa5(0x22f)](_0x3164f7),console[_0x329aa5(0x210)](_0x329aa5(0x282)+_0x44bfe6+'\x20('+_0x45c2bb+')'),console[_0x329aa5(0x210)](_0x329aa5(0x205)+(_0x466321 instanceof Error?_0x466321['message']:_0x466321)),console[_0x329aa5(0x210)](_0x329aa5(0x280)+_0x5aa7de),console[_0x329aa5(0x210)](_0x329aa5(0x25f)+_0x3164f7[_0x329aa5(0x2e8)]),_0x7c7f8a&&console['error'](_0x329aa5(0x2e7),_0x7c7f8a);}[a48_0xae1340(0x228)](){const _0x15dbb9=a48_0xae1340;console[_0x15dbb9(0x232)](_0x15dbb9(0x2e6)),this['checkAllPendingPayments']()['catch'](_0x3db6d5=>{const _0xe5a1eb=_0x15dbb9;console['error'](_0xe5a1eb(0x27a),_0x3db6d5);}),this['globalCheckInterval']=setInterval(async()=>{const _0x1b3401=_0x15dbb9;try{console[_0x1b3401(0x232)](_0x1b3401(0x257)),await this[_0x1b3401(0x1e3)](),console[_0x1b3401(0x232)](_0x1b3401(0x26b));}catch(_0x141f16){console['error'](_0x1b3401(0x222),_0x141f16);}},this[_0x15dbb9(0x1f0)]),console[_0x15dbb9(0x232)](_0x15dbb9(0x2c0));}['stopPeriodicStatusCheck'](){const _0x5d7037=a48_0xae1340;console[_0x5d7037(0x232)](_0x5d7037(0x22b));this[_0x5d7037(0x2ab)]&&(clearInterval(this['globalCheckInterval']),this[_0x5d7037(0x2ab)]=null,console[_0x5d7037(0x232)](_0x5d7037(0x1f4)));const _0x3acb41=this[_0x5d7037(0x2c3)]['size'];for(const [_0x4ef464]of this[_0x5d7037(0x2c3)]){this['clearPaymentTimers'](_0x4ef464);}console[_0x5d7037(0x232)](_0x5d7037(0x240)+_0x3acb41+'\x20individual\x20payment\x20timers');}async[a48_0xae1340(0x1e3)](){const _0x3131d9=a48_0xae1340;try{console[_0x3131d9(0x232)](_0x3131d9(0x218));const _0x22fb0e=await database_1['default'][_0x3131d9(0x2c5)][_0x3131d9(0x255)]({'where':{'gateway':{'in':[_0x3131d9(0x2a6),_0x3131d9(0x2d3)]},'status':_0x3131d9(0x226),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x3131d9(0x232)](_0x3131d9(0x2af)+_0x22fb0e[_0x3131d9(0x27e)]+_0x3131d9(0x2b1));if(_0x22fb0e[_0x3131d9(0x27e)]===0x0){console[_0x3131d9(0x232)](_0x3131d9(0x246));return;}const _0x119ff9=await this[_0x3131d9(0x23d)](_0x22fb0e);console[_0x3131d9(0x232)](_0x3131d9(0x2e0)+_0x119ff9['length']+_0x3131d9(0x2ed));let _0x3df8c2=0x0,_0x67cecd=0x0;for(const _0x1c8dae of _0x22fb0e){try{if(_0x119ff9['includes'](_0x1c8dae['id'])){console['log'](_0x3131d9(0x26a)+_0x1c8dae['id']+_0x3131d9(0x1fb)),_0x67cecd++;continue;}if(this['paymentTimers'][_0x3131d9(0x20c)](_0x1c8dae['id'])){console[_0x3131d9(0x232)](_0x3131d9(0x26a)+_0x1c8dae['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x67cecd++;continue;}const _0x55aac9=(Date[_0x3131d9(0x24b)]()-_0x1c8dae[_0x3131d9(0x263)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x55aac9<0x1){console[_0x3131d9(0x232)](_0x3131d9(0x26a)+_0x1c8dae['id']+_0x3131d9(0x1f2)+_0x55aac9['toFixed'](0x1)+_0x3131d9(0x20b)),_0x67cecd++;continue;}console[_0x3131d9(0x232)](_0x3131d9(0x2c4)+_0x1c8dae['id']+'\x20(age:\x20'+_0x55aac9[_0x3131d9(0x1f7)](0x1)+'h)'),await this[_0x3131d9(0x2ca)](_0x1c8dae),_0x3df8c2++,await new Promise(_0x5b532a=>setTimeout(_0x5b532a,0x7d0));}catch(_0x4d80ae){console[_0x3131d9(0x210)](_0x3131d9(0x247)+_0x1c8dae['id']+':',_0x4d80ae),this[_0x3131d9(0x22f)](_0x1c8dae['id'],_0x1c8dae[_0x3131d9(0x1df)]||_0x3131d9(0x27b),_0x4d80ae,_0x3131d9(0x2e5),{'isGlobalCheck':!![],'paymentAmount':_0x1c8dae['amount'],'paymentCurrency':_0x1c8dae['currency'],'shopId':_0x1c8dae[_0x3131d9(0x2aa)],'createdAt':_0x1c8dae[_0x3131d9(0x263)]}),loggerService_1[_0x3131d9(0x24f)][_0x3131d9(0x223)](_0x3131d9(0x2a6),_0x3131d9(0x256)+_0x1c8dae[_0x3131d9(0x1df)],_0x4d80ae);}}console[_0x3131d9(0x232)](_0x3131d9(0x2f1)+_0x3df8c2+_0x3131d9(0x2d7)+_0x67cecd+_0x3131d9(0x229)+_0x119ff9[_0x3131d9(0x27e)]+_0x3131d9(0x2db));}catch(_0x31767d){console[_0x3131d9(0x210)](_0x3131d9(0x231),_0x31767d);}}async['checkExpiredPayments'](_0x4a2528){const _0x37d3cd=a48_0xae1340,_0x2f5407=[],_0x194d8d=new Date();_0x194d8d[_0x37d3cd(0x268)](_0x194d8d[_0x37d3cd(0x230)]()-this['EXPIRY_DAYS']),console[_0x37d3cd(0x232)](_0x37d3cd(0x281)+this[_0x37d3cd(0x23e)]+'\x20days\x20(created\x20before\x20'+_0x194d8d[_0x37d3cd(0x253)]()+')');for(const _0x32fbfc of _0x4a2528){if(_0x32fbfc[_0x37d3cd(0x263)]<_0x194d8d){console[_0x37d3cd(0x232)](_0x37d3cd(0x2ec)+_0x32fbfc['id']+_0x37d3cd(0x1ff)+this[_0x37d3cd(0x23e)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x37d3cd(0x274)](_0x32fbfc['id'],_0x32fbfc[_0x37d3cd(0x1df)]||_0x37d3cd(0x27b),'PENDING',_0x37d3cd(0x2bf),_0x37d3cd(0x1fc),{'reason':_0x37d3cd(0x2d6)+this[_0x37d3cd(0x23e)]+_0x37d3cd(0x2df),'createdAt':_0x32fbfc[_0x37d3cd(0x263)],'daysSinceCreation':Math[_0x37d3cd(0x221)]((Date['now']()-_0x32fbfc['createdAt'][_0x37d3cd(0x214)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x32fbfc[_0x37d3cd(0x21f)],'paymentCurrency':_0x32fbfc['currency'],'shopId':_0x32fbfc['shopId']}),await database_1['default'][_0x37d3cd(0x2c5)]['update']({'where':{'id':_0x32fbfc['id']},'data':{'status':_0x37d3cd(0x2bf),'updatedAt':new Date()}}),await database_1[_0x37d3cd(0x20a)][_0x37d3cd(0x25a)][_0x37d3cd(0x299)]({'data':{'paymentId':_0x32fbfc['id'],'shopId':_0x32fbfc['shopId'],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x37d3cd(0x293)]({'reason':'Payment\x20older\x20than\x20'+this[_0x37d3cd(0x23e)]+'\x20days','createdAt':_0x32fbfc[_0x37d3cd(0x263)],'expiredAt':new Date()[_0x37d3cd(0x253)](),'daysSinceCreation':Math[_0x37d3cd(0x221)]((Date[_0x37d3cd(0x24b)]()-_0x32fbfc[_0x37d3cd(0x263)][_0x37d3cd(0x214)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x37d3cd(0x2d8)](_0x32fbfc,_0x37d3cd(0x2bf)),await this[_0x37d3cd(0x25d)](_0x32fbfc,'EXPIRED'),this['clearPaymentTimers'](_0x32fbfc['id']),_0x2f5407[_0x37d3cd(0x20e)](_0x32fbfc['id']),console[_0x37d3cd(0x232)](_0x37d3cd(0x227)+_0x32fbfc['id']+_0x37d3cd(0x29c)+this[_0x37d3cd(0x23e)]+_0x37d3cd(0x1ef));}catch(_0x14b1e4){console[_0x37d3cd(0x210)](_0x37d3cd(0x2e9)+_0x32fbfc['id']+':',_0x14b1e4),this[_0x37d3cd(0x22f)](_0x32fbfc['id'],_0x32fbfc[_0x37d3cd(0x1df)]||_0x37d3cd(0x27b),_0x14b1e4,_0x37d3cd(0x1fc),{'reason':_0x37d3cd(0x279),'createdAt':_0x32fbfc[_0x37d3cd(0x263)],'daysSinceCreation':Math[_0x37d3cd(0x221)]((Date[_0x37d3cd(0x24b)]()-_0x32fbfc[_0x37d3cd(0x263)][_0x37d3cd(0x214)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x2f5407;}async['checkSinglePayment'](_0x2f67a8){const _0x2d911a=a48_0xae1340;if(!_0x2f67a8[_0x2d911a(0x1df)]){console['log'](_0x2d911a(0x26f)+_0x2f67a8['id']+_0x2d911a(0x219));return;}console[_0x2d911a(0x232)](_0x2d911a(0x2b5)+_0x2f67a8[_0x2d911a(0x273)]+'\x20payment\x20'+_0x2f67a8['id']+'\x20('+_0x2f67a8[_0x2d911a(0x1df)]+')');try{let _0x533e68;_0x2f67a8[_0x2d911a(0x273)]===_0x2d911a(0x2d3)?(_0x533e68=await this[_0x2d911a(0x287)]['checkPaymentStatus'](_0x2f67a8[_0x2d911a(0x1df)]),console[_0x2d911a(0x232)](_0x2d911a(0x2dc)+_0x2f67a8['id']+_0x2d911a(0x23a)+_0x533e68[_0x2d911a(0x239)])):(_0x533e68=await this['coinToPayService'][_0x2d911a(0x1f6)](_0x2f67a8[_0x2d911a(0x1df)]),console[_0x2d911a(0x232)](_0x2d911a(0x2c6)+_0x2f67a8['id']+_0x2d911a(0x23a)+_0x533e68[_0x2d911a(0x239)]));_0x533e68['paymentDetails']&&console[_0x2d911a(0x232)](_0x2d911a(0x2d4)+_0x2f67a8['id']+_0x2d911a(0x2bd),{'iban':_0x533e68['paymentDetails'][_0x2d911a(0x20f)]||_0x2d911a(0x207),'transactionId':_0x533e68[_0x2d911a(0x267)]['transactionId'],'createdOn':_0x533e68[_0x2d911a(0x267)][_0x2d911a(0x1ec)],'confirmedOn':_0x533e68[_0x2d911a(0x267)][_0x2d911a(0x2f0)]||'not\x20confirmed'});if(_0x533e68['status']!==_0x2f67a8[_0x2d911a(0x239)]){console[_0x2d911a(0x232)](_0x2d911a(0x22c)+_0x2f67a8['id']+_0x2d911a(0x201)+_0x2f67a8[_0x2d911a(0x239)]+'\x20to\x20'+_0x533e68['status']),this[_0x2d911a(0x274)](_0x2f67a8['id'],_0x2f67a8[_0x2d911a(0x1df)],_0x2f67a8[_0x2d911a(0x239)],_0x533e68[_0x2d911a(0x239)],_0x2d911a(0x2e5),{'paymentDetails':_0x533e68[_0x2d911a(0x267)],'amount':_0x533e68[_0x2d911a(0x21f)],'currency':_0x533e68[_0x2d911a(0x2ee)],'shopId':_0x2f67a8['shopId'],'checkTimestamp':new Date()['toISOString']()});const _0x3b8223={'status':_0x533e68['status'],'updatedAt':new Date()};if(_0x533e68['status']===_0x2d911a(0x25e)&&_0x2f67a8[_0x2d911a(0x239)]!==_0x2d911a(0x25e)){_0x3b8223[_0x2d911a(0x26d)]=new Date();if(!_0x2f67a8[_0x2d911a(0x238)]){const _0x20cd6e=await currencyService_1[_0x2d911a(0x212)]['convertToUSDT'](_0x2f67a8[_0x2d911a(0x21f)],_0x2f67a8[_0x2d911a(0x2ee)]);_0x3b8223[_0x2d911a(0x238)]=_0x20cd6e;const _0x1c4b4b=await this['getGatewayCommission'](_0x2f67a8[_0x2d911a(0x2aa)],_0x2f67a8[_0x2d911a(0x273)]),_0x3edc4e=_0x20cd6e*(0x1-_0x1c4b4b/0x64);_0x3b8223[_0x2d911a(0x284)]=_0x3edc4e,_0x3b8223[_0x2d911a(0x275)]=_0x1c4b4b,console[_0x2d911a(0x232)](_0x2d911a(0x297)+_0x2f67a8['id']+_0x2d911a(0x1e6)),console['log'](_0x2d911a(0x244)+_0x2f67a8[_0x2d911a(0x21f)]+'\x20'+_0x2f67a8[_0x2d911a(0x2ee)]+'\x20->\x20'+_0x20cd6e[_0x2d911a(0x1f7)](0x6)+_0x2d911a(0x1f9)),console[_0x2d911a(0x232)](_0x2d911a(0x2c7)+_0x2f67a8[_0x2d911a(0x273)]+'\x20commission:\x20'+_0x1c4b4b+'%'),console[_0x2d911a(0x232)]('\x20\x20\x20Amount\x20after\x20commission:\x20'+_0x3edc4e[_0x2d911a(0x1f7)](0x6)+_0x2d911a(0x1f9));}console[_0x2d911a(0x232)](_0x2d911a(0x297)+_0x2f67a8['id']+_0x2d911a(0x264)+_0x3b8223['paidAt'][_0x2d911a(0x253)]());}if(_0x533e68['paymentDetails']){const _0x34918d=_0x533e68[_0x2d911a(0x267)];_0x34918d['iban']&&(_0x3b8223[_0x2d911a(0x2e4)]=_0x34918d[_0x2d911a(0x20f)],console['log'](_0x2d911a(0x24d)+_0x34918d['iban'])),_0x34918d[_0x2d911a(0x24e)]&&console[_0x2d911a(0x232)](_0x2d911a(0x270)+_0x34918d['bankDetails']),_0x34918d[_0x2d911a(0x28c)]&&console[_0x2d911a(0x232)](_0x2d911a(0x2b9)+_0x34918d[_0x2d911a(0x28c)]),_0x34918d['confirmedOn']&&console[_0x2d911a(0x232)](_0x2d911a(0x29d)+_0x34918d[_0x2d911a(0x2f0)]);}await database_1['default'][_0x2d911a(0x2c5)][_0x2d911a(0x2d0)]({'where':{'id':_0x2f67a8['id']},'data':_0x3b8223});if(_0x533e68[_0x2d911a(0x239)]==='PAID'&&_0x2f67a8[_0x2d911a(0x239)]!==_0x2d911a(0x25e)){console['log'](_0x2d911a(0x23b)+_0x2f67a8['id']+_0x2d911a(0x29a));const _0x39bebc=await database_1['default'][_0x2d911a(0x2c5)][_0x2d911a(0x206)]({'where':{'id':_0x2f67a8['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x39bebc?.['paymentLinkId']&&_0x39bebc[_0x2d911a(0x2be)])try{const _0x1144aa=_0x39bebc[_0x2d911a(0x2be)];console['log'](_0x2d911a(0x224)+_0x1144aa['id']+':\x20type='+_0x1144aa[_0x2d911a(0x242)]+',\x20currentPayments='+_0x1144aa[_0x2d911a(0x2bb)]+',\x20status='+_0x1144aa[_0x2d911a(0x239)]);const _0x19d7cf=_0x1144aa[_0x2d911a(0x2bb)]+0x1,_0xf1d28a=_0x1144aa[_0x2d911a(0x242)]===_0x2d911a(0x296)?_0x2d911a(0x233):_0x1144aa[_0x2d911a(0x239)];await database_1['default']['paymentLink'][_0x2d911a(0x2d0)]({'where':{'id':_0x1144aa['id']},'data':{'currentPayments':_0x19d7cf,'status':_0xf1d28a,'updatedAt':new Date()}}),console[_0x2d911a(0x232)](_0x2d911a(0x250)+_0x1144aa['id']+_0x2d911a(0x294)+_0x1144aa[_0x2d911a(0x2bb)]+_0x2d911a(0x2d2)+_0x19d7cf+',\x20status='+_0x1144aa[_0x2d911a(0x239)]+_0x2d911a(0x2d2)+_0xf1d28a);}catch(_0x23820f){console['error'](_0x2d911a(0x2ae),_0x23820f);}else console[_0x2d911a(0x232)](_0x2d911a(0x23b)+_0x2f67a8['id']+_0x2d911a(0x2b2));}await database_1[_0x2d911a(0x20a)][_0x2d911a(0x25a)][_0x2d911a(0x299)]({'data':{'paymentId':_0x2f67a8['id'],'shopId':_0x2f67a8['shopId'],'event':_0x2d911a(0x29f)+_0x533e68[_0x2d911a(0x239)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x2d911a(0x293)]({'oldStatus':_0x2f67a8[_0x2d911a(0x239)],'newStatus':_0x533e68['status'],'paymentDetails':_0x533e68[_0x2d911a(0x267)],'checkedAt':new Date()[_0x2d911a(0x253)]()})}}),await this[_0x2d911a(0x2d8)](_0x2f67a8,_0x533e68[_0x2d911a(0x239)]),await this[_0x2d911a(0x25d)](_0x2f67a8,_0x533e68[_0x2d911a(0x239)]),_0x533e68[_0x2d911a(0x239)]!==_0x2d911a(0x226)&&(console['log']('ðŸ§¹\x20[CHECK]\x20Payment\x20'+_0x2f67a8['id']+_0x2d911a(0x29b)+_0x533e68['status']+_0x2d911a(0x2e3)),this[_0x2d911a(0x235)](_0x2f67a8['id'])),console['log'](_0x2d911a(0x1e1)+_0x2f67a8['id']+_0x2d911a(0x2cd));}else console[_0x2d911a(0x232)]('ðŸ“Š\x20[CHECK]\x20Payment\x20'+_0x2f67a8['id']+'\x20status\x20unchanged\x20('+_0x533e68[_0x2d911a(0x239)]+')'),this[_0x2d911a(0x274)](_0x2f67a8['id'],_0x2f67a8[_0x2d911a(0x1df)],_0x2f67a8[_0x2d911a(0x239)],_0x533e68[_0x2d911a(0x239)],_0x2d911a(0x2e5),{'statusUnchanged':!![],'paymentDetails':_0x533e68[_0x2d911a(0x267)],'amount':_0x533e68[_0x2d911a(0x21f)],'currency':_0x533e68[_0x2d911a(0x2ee)],'shopId':_0x2f67a8[_0x2d911a(0x2aa)],'checkTimestamp':new Date()[_0x2d911a(0x253)]()});}catch(_0x2a9b23){console[_0x2d911a(0x210)](_0x2d911a(0x1f1)+_0x2f67a8['id']+':',_0x2a9b23),this[_0x2d911a(0x22f)](_0x2f67a8['id'],_0x2f67a8[_0x2d911a(0x1df)],_0x2a9b23,'status_check',{'paymentAmount':_0x2f67a8[_0x2d911a(0x21f)],'paymentCurrency':_0x2f67a8[_0x2d911a(0x2ee)],'shopId':_0x2f67a8[_0x2d911a(0x2aa)],'createdAt':_0x2f67a8[_0x2d911a(0x263)]}),await database_1[_0x2d911a(0x20a)]['webhookLog'][_0x2d911a(0x299)]({'data':{'paymentId':_0x2f67a8['id'],'shopId':_0x2f67a8[_0x2d911a(0x2aa)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x2a9b23 instanceof Error?_0x2a9b23[_0x2d911a(0x260)]:_0x2d911a(0x2b7),'gatewayPaymentId':_0x2f67a8[_0x2d911a(0x1df)],'checkedAt':new Date()[_0x2d911a(0x253)]()})}});}}async[a48_0xae1340(0x2d8)](_0x5c8c12,_0x4f0b9d){const _0x597347=a48_0xae1340,_0x4caf4a=Date[_0x597347(0x24b)]();try{const _0x27f9fb=_0x5c8c12[_0x597347(0x1fe)],_0x5f4b8a=_0x27f9fb[_0x597347(0x2e2)];if(!_0x5f4b8a?.[_0x597347(0x216)]){console['log'](_0x597347(0x1fa)+_0x27f9fb['id']);return;}const _0x22a250=_0x4f0b9d==='PAID'?_0x597347(0x2b8):_0x4f0b9d===_0x597347(0x251)?'payment.failed':_0x4f0b9d===_0x597347(0x2bf)?'payment.failed':_0x597347(0x241);if(!_0x5f4b8a[_0x597347(0x23c)]?.['includes'](_0x22a250)){console[_0x597347(0x232)](_0x597347(0x26c)+_0x22a250+_0x597347(0x252)+_0x27f9fb['id']);return;}const _0x409f22=(0x0,gateway_1[_0x597347(0x2a9)])(_0x5c8c12[_0x597347(0x273)])||_0x5c8c12[_0x597347(0x273)],_0x14a925={'event':_0x22a250,'payment':{'id':_0x5c8c12['id'],'order_id':_0x5c8c12[_0x597347(0x277)],'gateway_order_id':_0x5c8c12['gatewayOrderId'],'gateway':_0x409f22,'amount':_0x5c8c12[_0x597347(0x21f)],'currency':_0x5c8c12[_0x597347(0x2ee)],'status':_0x4f0b9d['toLowerCase'](),'customer_email':_0x5c8c12[_0x597347(0x21a)],'customer_name':_0x5c8c12[_0x597347(0x2da)],'created_at':_0x5c8c12[_0x597347(0x263)],'updated_at':new Date()}},_0x571101=await fetch(_0x5f4b8a[_0x597347(0x216)],{'method':_0x597347(0x2d5),'headers':{'Content-Type':_0x597347(0x25c),'User-Agent':_0x597347(0x202)},'body':JSON[_0x597347(0x293)](_0x14a925)}),_0x23671e=Date['now']()-_0x4caf4a,_0x16f757=_0x571101['ok']?_0x597347(0x2c1):await _0x571101['text']();loggerService_1['loggerService']['logShopWebhookSent'](_0x5c8c12['shopId'],_0x5f4b8a[_0x597347(0x216)],_0x22a250,_0x571101[_0x597347(0x239)],_0x23671e,_0x14a925),console['log'](_0x597347(0x1fd)+_0x5f4b8a['webhookUrl']+_0x597347(0x2ea)+_0x571101[_0x597347(0x239)]+'\x20('+_0x23671e+_0x597347(0x203));}catch(_0x530d6b){console[_0x597347(0x210)](_0x597347(0x213),_0x530d6b),loggerService_1[_0x597347(0x24f)]['logShopWebhookError'](_0x5c8c12[_0x597347(0x2aa)],_0x5c8c12[_0x597347(0x1fe)]?.['settings']?.['webhookUrl']||_0x597347(0x27b),_0x597347(0x1ee),_0x530d6b,{});}}async[a48_0xae1340(0x25d)](_0x38a8dc,_0x480264){const _0xd9969e=a48_0xae1340;try{const _0x2e970d={'PENDING':'created','PAID':_0xd9969e(0x292),'FAILED':_0xd9969e(0x236),'EXPIRED':_0xd9969e(0x295)},_0x58e32a=_0x2e970d[_0x480264];if(!_0x58e32a||_0x58e32a===_0xd9969e(0x278))return;await telegramBotService_1['telegramBotService'][_0xd9969e(0x248)](_0x38a8dc['shopId'],_0x38a8dc,_0x58e32a);}catch(_0x459c0e){console['error'](_0xd9969e(0x217),_0x459c0e);}}async['checkPaymentById'](_0x3daae0){const _0x36667e=a48_0xae1340;console[_0x36667e(0x232)]('ðŸ”\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x3daae0);const _0x1df7ba=await database_1[_0x36667e(0x20a)]['payment'][_0x36667e(0x206)]({'where':{'id':_0x3daae0},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1df7ba)throw new Error('Payment\x20not\x20found');if(_0x1df7ba['gateway']!==_0x36667e(0x2a6)&&_0x1df7ba[_0x36667e(0x273)]!==_0x36667e(0x2d3))throw new Error(_0x36667e(0x1f5));console[_0x36667e(0x232)]('âœ…\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20'+_0x1df7ba[_0x36667e(0x273)]+_0x36667e(0x2d9)+_0x3daae0),await this['checkSinglePayment'](_0x1df7ba),console[_0x36667e(0x232)](_0x36667e(0x261)+_0x3daae0);}[a48_0xae1340(0x265)](){const _0x1b6d8e=a48_0xae1340,_0x24277b=this['globalCheckInterval']?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x332b7e=Array[_0x1b6d8e(0x1ea)](this[_0x1b6d8e(0x2c3)][_0x1b6d8e(0x286)]())[_0x1b6d8e(0x288)](_0x47056d=>({'paymentId':_0x47056d[_0x1b6d8e(0x272)],'gatewayPaymentId':_0x47056d[_0x1b6d8e(0x1df)],'createdAt':_0x47056d['createdAt'],'timersCount':_0x47056d[_0x1b6d8e(0x262)]['length']}));return{'isActive':!!this[_0x1b6d8e(0x2ab)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x1b6d8e(0x23e)],'activeIndividualTimers':this[_0x1b6d8e(0x2c3)][_0x1b6d8e(0x2a3)],'nextGlobalCheckIn':_0x24277b,'paymentTimersDetails':_0x332b7e};}[a48_0xae1340(0x2b4)](_0x3adac6){const _0x1b1b96=a48_0xae1340,_0x5b0e25=this[_0x1b1b96(0x2c3)][_0x1b1b96(0x27c)](_0x3adac6);if(_0x5b0e25)return{'hasTimers':!![],'timersCount':_0x5b0e25[_0x1b1b96(0x262)][_0x1b1b96(0x27e)],'createdAt':_0x5b0e25['createdAt'],'gatewayPaymentId':_0x5b0e25[_0x1b1b96(0x1df)]};return{'hasTimers':![]};}async[a48_0xae1340(0x28e)](_0x302cfb,_0x4220b0){const _0x52c8b6=a48_0xae1340;try{const _0x14eb85=await database_1[_0x52c8b6(0x20a)]['shop']['findUnique']({'where':{'id':_0x302cfb},'select':{'gatewaySettings':!![]}});if(!_0x14eb85?.[_0x52c8b6(0x2a5)])return console[_0x52c8b6(0x232)](_0x52c8b6(0x2bc)+_0x302cfb+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x3783e3=JSON[_0x52c8b6(0x28f)](_0x14eb85[_0x52c8b6(0x2a5)]);for(const [_0x18bad7,_0x261505]of Object[_0x52c8b6(0x2cf)](_0x3783e3)){if(_0x18bad7[_0x52c8b6(0x25b)]()===_0x4220b0[_0x52c8b6(0x25b)]()){const _0x51973f=_0x261505[_0x52c8b6(0x2a4)]||0xa;return console['log']('Gateway\x20'+_0x4220b0+_0x52c8b6(0x22a)+_0x302cfb+':\x20'+_0x51973f+'%'),_0x51973f;}}return console['log']('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0x4220b0+_0x52c8b6(0x2b0)+_0x302cfb+_0x52c8b6(0x220)),0xa;}catch(_0x47b73a){return console[_0x52c8b6(0x210)](_0x52c8b6(0x2e1)+_0x302cfb+_0x52c8b6(0x1e2)+_0x4220b0+':',_0x47b73a),0xa;}}}exports[a48_0xae1340(0x2d1)]=CoinToPayStatusService,exports[a48_0xae1340(0x243)]=new CoinToPayStatusService();