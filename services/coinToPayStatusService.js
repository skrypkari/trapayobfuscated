'use strict';function a35_0x4c79(){const _0x2dff9b=['\x20details:','checkPaymentStatus','\x20status\x20unchanged\x20(','âš ï¸\x20Payment\x20','495324efewxd','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','coinToPayService','__esModule','1629UPZaOM','./gateways/coinToPayService','create','bankDetails','created','webhookLog','sendPaymentNotification','default','telegramBotService','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','payment.pending','ms)','payment.failed','\x20status\x20from\x20','ðŸ“Š\x20Payment\x20','2824LUvgcy','transactionId','ðŸ’°\x20Payment\x20','âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','Unknown\x20error','shop','Initial\x20CoinToPay\x20status\x20check\x20failed:','109754iuzGyH','\x20with\x20status\x20','ðŸ”\x20Checking\x20CoinToPay\x20payment\x20','âœ…\x20Completed\x20checking\x20','toLowerCase','\x20marked\x20as\x20paid\x20at:\x20','../config/database','./telegramBotService','customerName','amount','coinToPayStatusService','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','now','Success','createdAt','checkExpiredPayments','__importDefault','status','ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped','CHECK_INTERVAL_MS','âœ…\x20Payment\x20','log','1883845RKKaMV','\x20pending\x20CoinToPay\x20payments','floor','\x20status:\x20','adminNotes','stopPeriodicStatusCheck','getTime','77angYbU','\x20days','paymentDetails','\x20days\x20(created\x20before\x20','\x20days\x20without\x20payment\x20confirmation','payment','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','EXPIRY_DAYS','checkInterval','checkPaymentById','PAID','payment.success','ðŸ¦\x20Saved\x20IBAN:\x20','Failed\x20to\x20send\x20shop\x20webhook:','includes','settings','0100','63MRytPw','webhookEvents','application/json','failed','loggerService','logShopWebhookError','./loggerService','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','cointopay_status_check_','\x20expired\x20CoinToPay\x20payments','checkAllPendingPayments','ðŸª™\x20Checking\x20','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','not\x20confirmed','âœ…\x20Transaction\x20confirmed\x20on:\x20','EXPIRED','ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','sendShopWebhook','defineProperty','gatewayPaymentId','currency','12RGzfaL','remitterIban','â°\x20Payment\x20','\x20to\x20','Payment\x20older\x20than\x20','toISOString','webhookUrl','\x20days,\x20marking\x20as\x20EXPIRED','Automatically\x20expired\x20after\x20','CoinToPayStatusService','cointopay_auto_expired','webhook_send','CoinToPayService','unknown','checkSinglePayment','error','stringify','Failed\x20to\x20check\x20payment\x20','length','1wyETBZ','confirmedOn','Bank\x20Details:\x20','catch','â°\x20Found\x20','expired','setDate','449270AVEGgK','POST','paid','paidAt','gatewayOrderId','startPeriodicStatusCheck','createdOn','update','shopId','Payment\x20not\x20found','cointopay','iban','getDate','logShopWebhookSent','28832284mSHMbF','sendPaymentStatusNotification','Shop\x20webhook\x20sent\x20to\x20','108dMmtvU','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','25989nexnQV','\x20not\x20enabled\x20for\x20shop\x20','ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','PENDING','\x20CoinToPay\x20payments'];a35_0x4c79=function(){return _0x2dff9b;};return a35_0x4c79();}const a35_0x197c06=a35_0x1161;(function(_0x520af9,_0x113fc5){const _0x10a9aa=a35_0x1161,_0x1f546f=_0x520af9();while(!![]){try{const _0x2602ed=-parseInt(_0x10a9aa(0x196))/0x1*(parseInt(_0x10a9aa(0x1d3))/0x2)+parseInt(_0x10a9aa(0x1b0))/0x3*(-parseInt(_0x10a9aa(0x1ae))/0x4)+-parseInt(_0x10a9aa(0x156))/0x5+parseInt(_0x10a9aa(0x1b9))/0x6*(-parseInt(_0x10a9aa(0x16e))/0x7)+-parseInt(_0x10a9aa(0x1cc))/0x8*(parseInt(_0x10a9aa(0x1bd))/0x9)+-parseInt(_0x10a9aa(0x19d))/0xa*(parseInt(_0x10a9aa(0x15d))/0xb)+parseInt(_0x10a9aa(0x183))/0xc*(parseInt(_0x10a9aa(0x1ab))/0xd);if(_0x2602ed===_0x113fc5)break;else _0x1f546f['push'](_0x1f546f['shift']());}catch(_0x11456a){_0x1f546f['push'](_0x1f546f['shift']());}}}(a35_0x4c79,0x69369));function a35_0x1161(_0x54221,_0x3e4d6e){const _0x4c797d=a35_0x4c79();return a35_0x1161=function(_0x1161ae,_0x30c76a){_0x1161ae=_0x1161ae-0x153;let _0x4037c8=_0x4c797d[_0x1161ae];return _0x4037c8;},a35_0x1161(_0x54221,_0x3e4d6e);}var __importDefault=this&&this[a35_0x197c06(0x1e3)]||function(_0x39e61a){const _0x5df884=a35_0x197c06;return _0x39e61a&&_0x39e61a[_0x5df884(0x1bc)]?_0x39e61a:{'default':_0x39e61a};};Object[a35_0x197c06(0x180)](exports,a35_0x197c06(0x1bc),{'value':!![]}),exports[a35_0x197c06(0x1dd)]=exports[a35_0x197c06(0x18c)]=void 0x0;const coinToPayService_1=require(a35_0x197c06(0x1be)),database_1=__importDefault(require(a35_0x197c06(0x1d9))),telegramBotService_1=require(a35_0x197c06(0x1da)),loggerService_1=require(a35_0x197c06(0x174));class CoinToPayStatusService{constructor(){const _0x53b3f0=a35_0x197c06;this[_0x53b3f0(0x165)]=null,this['CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x53b3f0(0x164)]=0x5,this[_0x53b3f0(0x1bb)]=new coinToPayService_1[(_0x53b3f0(0x18f))]();}[a35_0x197c06(0x1a2)](){const _0x110c45=a35_0x197c06;console[_0x110c45(0x155)](_0x110c45(0x175)),this[_0x110c45(0x178)]()[_0x110c45(0x199)](_0x2a93db=>{const _0x2d2c3a=_0x110c45;console[_0x2d2c3a(0x192)](_0x2d2c3a(0x1d2),_0x2a93db);}),this[_0x110c45(0x165)]=setInterval(async()=>{const _0x33b21b=_0x110c45;try{await this[_0x33b21b(0x178)]();}catch(_0x5977f3){console[_0x33b21b(0x192)]('Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x5977f3);}},this[_0x110c45(0x153)]),console['log'](_0x110c45(0x1cf));}[a35_0x197c06(0x15b)](){const _0x339812=a35_0x197c06;this['checkInterval']&&(clearInterval(this['checkInterval']),this['checkInterval']=null,console[_0x339812(0x155)](_0x339812(0x1e5)));}async[a35_0x197c06(0x178)](){const _0x1b4c52=a35_0x197c06;try{const _0x40c1d6=await database_1[_0x1b4c52(0x1c4)][_0x1b4c52(0x162)]['findMany']({'where':{'gateway':_0x1b4c52(0x1a7),'status':_0x1b4c52(0x1b3),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x40c1d6[_0x1b4c52(0x195)]===0x0){console[_0x1b4c52(0x155)](_0x1b4c52(0x17e));return;}console[_0x1b4c52(0x155)](_0x1b4c52(0x179)+_0x40c1d6['length']+_0x1b4c52(0x157));const _0x4bd9ea=await this[_0x1b4c52(0x1e2)](_0x40c1d6);console[_0x1b4c52(0x155)](_0x1b4c52(0x19a)+_0x4bd9ea[_0x1b4c52(0x195)]+_0x1b4c52(0x177));for(const _0x464f9f of _0x40c1d6){try{if(_0x4bd9ea[_0x1b4c52(0x16b)](_0x464f9f['id'])){console[_0x1b4c52(0x155)](_0x1b4c52(0x185)+_0x464f9f['id']+_0x1b4c52(0x1c6));continue;}await this[_0x1b4c52(0x191)](_0x464f9f),await new Promise(_0x2cd3ef=>setTimeout(_0x2cd3ef,0x7d0));}catch(_0x138586){console['error'](_0x1b4c52(0x1de)+_0x464f9f['id']+':',_0x138586),loggerService_1[_0x1b4c52(0x172)]['logWhiteDomainError'](_0x1b4c52(0x1a7),'/status/'+_0x464f9f['gatewayPaymentId'],_0x138586);}}console['log'](_0x1b4c52(0x1d6)+_0x40c1d6[_0x1b4c52(0x195)]+_0x1b4c52(0x1b4));}catch(_0x41f6cd){console[_0x1b4c52(0x192)](_0x1b4c52(0x163),_0x41f6cd);}}async['checkExpiredPayments'](_0x575d35){const _0x2f0bc4=a35_0x197c06,_0x5631a9=[],_0x12c4d9=new Date();_0x12c4d9[_0x2f0bc4(0x19c)](_0x12c4d9[_0x2f0bc4(0x1a9)]()-this[_0x2f0bc4(0x164)]),console['log'](_0x2f0bc4(0x17a)+this[_0x2f0bc4(0x164)]+_0x2f0bc4(0x160)+_0x12c4d9['toISOString']()+')');for(const _0x2d4ed8 of _0x575d35){if(_0x2d4ed8['createdAt']<_0x12c4d9){console[_0x2f0bc4(0x155)]('â°\x20Payment\x20'+_0x2d4ed8['id']+'\x20is\x20older\x20than\x20'+this[_0x2f0bc4(0x164)]+_0x2f0bc4(0x18a));try{await database_1[_0x2f0bc4(0x1c4)][_0x2f0bc4(0x162)][_0x2f0bc4(0x1a4)]({'where':{'id':_0x2d4ed8['id']},'data':{'status':_0x2f0bc4(0x17d),'updatedAt':new Date(),'adminNotes':_0x2f0bc4(0x18b)+this['EXPIRY_DAYS']+_0x2f0bc4(0x161)}}),await database_1[_0x2f0bc4(0x1c4)][_0x2f0bc4(0x1c2)][_0x2f0bc4(0x1bf)]({'data':{'paymentId':_0x2d4ed8['id'],'shopId':_0x2d4ed8[_0x2f0bc4(0x1a5)],'event':_0x2f0bc4(0x18d),'statusCode':0xc8,'responseBody':JSON[_0x2f0bc4(0x193)]({'reason':_0x2f0bc4(0x187)+this[_0x2f0bc4(0x164)]+_0x2f0bc4(0x15e),'createdAt':_0x2d4ed8[_0x2f0bc4(0x1e1)],'expiredAt':new Date()[_0x2f0bc4(0x188)](),'daysSinceCreation':Math[_0x2f0bc4(0x158)]((Date['now']()-_0x2d4ed8[_0x2f0bc4(0x1e1)][_0x2f0bc4(0x15c)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x2d4ed8,'EXPIRED'),await this[_0x2f0bc4(0x1ac)](_0x2d4ed8,'EXPIRED'),_0x5631a9['push'](_0x2d4ed8['id']),console[_0x2f0bc4(0x155)](_0x2f0bc4(0x154)+_0x2d4ed8['id']+_0x2f0bc4(0x1ba)+this[_0x2f0bc4(0x164)]+'-day\x20timeout');}catch(_0x2f58b5){console['error']('Failed\x20to\x20expire\x20payment\x20'+_0x2d4ed8['id']+':',_0x2f58b5);}}}return _0x5631a9;}async[a35_0x197c06(0x191)](_0x480b1d){const _0x461053=a35_0x197c06;if(!_0x480b1d['gatewayPaymentId']){console[_0x461053(0x155)](_0x461053(0x1b8)+_0x480b1d['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x461053(0x155)](_0x461053(0x1d5)+_0x480b1d['id']+'\x20('+_0x480b1d['gatewayPaymentId']+')');try{const _0x488259=await this[_0x461053(0x1bb)][_0x461053(0x1b6)](_0x480b1d[_0x461053(0x181)]);console[_0x461053(0x155)](_0x461053(0x1cb)+_0x480b1d['id']+_0x461053(0x159)+_0x488259[_0x461053(0x1e4)]);_0x488259['paymentDetails']&&console[_0x461053(0x155)]('ðŸ“Š\x20Payment\x20'+_0x480b1d['id']+_0x461053(0x1b5),{'iban':_0x488259[_0x461053(0x15f)][_0x461053(0x1a8)]||'not\x20found','transactionId':_0x488259['paymentDetails']['transactionId'],'createdOn':_0x488259[_0x461053(0x15f)][_0x461053(0x1a3)],'confirmedOn':_0x488259['paymentDetails'][_0x461053(0x197)]||_0x461053(0x17b)});if(_0x488259[_0x461053(0x1e4)]!==_0x480b1d[_0x461053(0x1e4)]){console[_0x461053(0x155)]('ðŸ”„\x20Updating\x20payment\x20'+_0x480b1d['id']+_0x461053(0x1ca)+_0x480b1d['status']+_0x461053(0x186)+_0x488259[_0x461053(0x1e4)]);const _0x287a1c={'status':_0x488259['status'],'updatedAt':new Date()};_0x488259[_0x461053(0x1e4)]===_0x461053(0x167)&&_0x480b1d[_0x461053(0x1e4)]!==_0x461053(0x167)&&(_0x287a1c[_0x461053(0x1a0)]=new Date(),console[_0x461053(0x155)](_0x461053(0x1ce)+_0x480b1d['id']+_0x461053(0x1d8)+_0x287a1c[_0x461053(0x1a0)][_0x461053(0x188)]()));if(_0x488259[_0x461053(0x15f)]){const _0x2216d4=_0x488259[_0x461053(0x15f)];_0x2216d4['iban']&&(_0x287a1c[_0x461053(0x184)]=_0x2216d4[_0x461053(0x1a8)],console['log'](_0x461053(0x169)+_0x2216d4[_0x461053(0x1a8)]));if(_0x2216d4[_0x461053(0x1c0)]){const _0x38f444=_0x480b1d[_0x461053(0x15a)]||'',_0x54b185=_0x461053(0x198)+_0x2216d4[_0x461053(0x1c0)];_0x287a1c[_0x461053(0x15a)]=_0x38f444?_0x38f444+'\x0a\x0a'+_0x54b185:_0x54b185,console[_0x461053(0x155)](_0x461053(0x1b2));}_0x2216d4[_0x461053(0x1cd)]&&console['log']('ðŸ†”\x20Transaction\x20ID:\x20'+_0x2216d4['transactionId']),_0x2216d4[_0x461053(0x197)]&&console['log'](_0x461053(0x17c)+_0x2216d4[_0x461053(0x197)]);}await database_1[_0x461053(0x1c4)][_0x461053(0x162)][_0x461053(0x1a4)]({'where':{'id':_0x480b1d['id']},'data':_0x287a1c}),await database_1[_0x461053(0x1c4)]['webhookLog'][_0x461053(0x1bf)]({'data':{'paymentId':_0x480b1d['id'],'shopId':_0x480b1d['shopId'],'event':_0x461053(0x176)+_0x488259[_0x461053(0x1e4)][_0x461053(0x1d7)](),'statusCode':0xc8,'responseBody':JSON[_0x461053(0x193)]({'oldStatus':_0x480b1d[_0x461053(0x1e4)],'newStatus':_0x488259[_0x461053(0x1e4)],'paymentDetails':_0x488259[_0x461053(0x15f)],'checkedAt':new Date()[_0x461053(0x188)]()})}}),await this['sendShopWebhook'](_0x480b1d,_0x488259[_0x461053(0x1e4)]),await this[_0x461053(0x1ac)](_0x480b1d,_0x488259['status']),console[_0x461053(0x155)]('âœ…\x20Payment\x20'+_0x480b1d['id']+'\x20updated\x20successfully');}else console[_0x461053(0x155)](_0x461053(0x1cb)+_0x480b1d['id']+_0x461053(0x1b7)+_0x488259['status']+')');}catch(_0x49e81a){console[_0x461053(0x192)](_0x461053(0x194)+_0x480b1d['id']+':',_0x49e81a),await database_1[_0x461053(0x1c4)][_0x461053(0x1c2)][_0x461053(0x1bf)]({'data':{'paymentId':_0x480b1d['id'],'shopId':_0x480b1d[_0x461053(0x1a5)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x461053(0x193)]({'error':_0x49e81a instanceof Error?_0x49e81a['message']:_0x461053(0x1d0),'gatewayPaymentId':_0x480b1d['gatewayPaymentId'],'checkedAt':new Date()[_0x461053(0x188)]()})}});}}async[a35_0x197c06(0x17f)](_0x180b2c,_0x41efe1){const _0x3d7d45=a35_0x197c06,_0xcd42ee=Date[_0x3d7d45(0x1df)]();try{const _0x212a6d=_0x180b2c[_0x3d7d45(0x1d1)],_0x1560d1=_0x212a6d[_0x3d7d45(0x16c)];if(!_0x1560d1?.[_0x3d7d45(0x189)]){console[_0x3d7d45(0x155)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x212a6d['id']);return;}const _0x52bc7e=_0x41efe1===_0x3d7d45(0x167)?_0x3d7d45(0x168):_0x41efe1==='FAILED'?'payment.failed':_0x41efe1===_0x3d7d45(0x17d)?_0x3d7d45(0x1c9):_0x3d7d45(0x1c7);if(!_0x1560d1[_0x3d7d45(0x16f)]?.[_0x3d7d45(0x16b)](_0x52bc7e)){console[_0x3d7d45(0x155)]('Webhook\x20event\x20'+_0x52bc7e+_0x3d7d45(0x1b1)+_0x212a6d['id']);return;}const _0x262908={'event':_0x52bc7e,'payment':{'id':_0x180b2c['id'],'order_id':_0x180b2c['orderId'],'gateway_order_id':_0x180b2c[_0x3d7d45(0x1a1)],'gateway':_0x3d7d45(0x16d),'amount':_0x180b2c[_0x3d7d45(0x1dc)],'currency':_0x180b2c[_0x3d7d45(0x182)],'status':_0x41efe1[_0x3d7d45(0x1d7)](),'customer_email':_0x180b2c['customerEmail'],'customer_name':_0x180b2c[_0x3d7d45(0x1db)],'created_at':_0x180b2c[_0x3d7d45(0x1e1)],'updated_at':new Date()}},_0x36307b=await fetch(_0x1560d1[_0x3d7d45(0x189)],{'method':_0x3d7d45(0x19e),'headers':{'Content-Type':_0x3d7d45(0x170),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x3d7d45(0x193)](_0x262908)}),_0x3b108b=Date[_0x3d7d45(0x1df)]()-_0xcd42ee,_0x4c0695=_0x36307b['ok']?_0x3d7d45(0x1e0):await _0x36307b['text']();loggerService_1[_0x3d7d45(0x172)][_0x3d7d45(0x1aa)](_0x180b2c[_0x3d7d45(0x1a5)],_0x1560d1[_0x3d7d45(0x189)],_0x52bc7e,_0x36307b[_0x3d7d45(0x1e4)],_0x3b108b,_0x262908),console[_0x3d7d45(0x155)](_0x3d7d45(0x1ad)+_0x1560d1[_0x3d7d45(0x189)]+_0x3d7d45(0x1d4)+_0x36307b[_0x3d7d45(0x1e4)]+'\x20('+_0x3b108b+_0x3d7d45(0x1c8));}catch(_0x19d379){console[_0x3d7d45(0x192)](_0x3d7d45(0x16a),_0x19d379),loggerService_1['loggerService'][_0x3d7d45(0x173)](_0x180b2c[_0x3d7d45(0x1a5)],_0x180b2c[_0x3d7d45(0x1d1)]?.['settings']?.[_0x3d7d45(0x189)]||_0x3d7d45(0x190),_0x3d7d45(0x18e),_0x19d379,{});}}async[a35_0x197c06(0x1ac)](_0x5b3f17,_0x185d8b){const _0x58377e=a35_0x197c06;try{const _0x473490={'PENDING':_0x58377e(0x1c1),'PAID':_0x58377e(0x19f),'FAILED':_0x58377e(0x171),'EXPIRED':_0x58377e(0x19b)},_0x42b681=_0x473490[_0x185d8b];if(!_0x42b681||_0x42b681===_0x58377e(0x1c1))return;await telegramBotService_1[_0x58377e(0x1c5)][_0x58377e(0x1c3)](_0x5b3f17['shopId'],_0x5b3f17,_0x42b681);}catch(_0x581b96){console[_0x58377e(0x192)](_0x58377e(0x1af),_0x581b96);}}async[a35_0x197c06(0x166)](_0x58b585){const _0x4408e0=a35_0x197c06,_0x39f857=await database_1[_0x4408e0(0x1c4)][_0x4408e0(0x162)]['findUnique']({'where':{'id':_0x58b585},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x39f857)throw new Error(_0x4408e0(0x1a6));if(_0x39f857['gateway']!=='cointopay')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');await this['checkSinglePayment'](_0x39f857);}['getServiceStats'](){const _0x22417f=a35_0x197c06,_0x10be75=this[_0x22417f(0x165)]?this[_0x22417f(0x153)]:undefined;return{'isActive':!!this['checkInterval'],'checkIntervalMinutes':this[_0x22417f(0x153)]/(0x3e8*0x3c),'expiryDays':this[_0x22417f(0x164)],'nextCheckIn':_0x10be75};}}exports[a35_0x197c06(0x18c)]=CoinToPayStatusService,exports[a35_0x197c06(0x1dd)]=new CoinToPayStatusService();