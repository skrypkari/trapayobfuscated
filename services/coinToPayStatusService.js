'use strict';function a37_0x2742(){const _0x3faf83=['10uEzRep','73185mWckrx','coinToPayStatusService','2\x20minutes','\x20seconds\x20(','forEach','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','findMany','includes','remitterIban','\x20has\x20no\x20gatewayPaymentId,\x20skipping','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','42KGoPCT','checkPaymentById','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20details:','checkAllPendingPayments','checkExpiredPayments','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20\x20\x20📝\x20Context:','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','getPaymentTimerInfo','✅\x20[EXPIRY]\x20Payment\x20','h),\x20skipping\x20global\x20check','\x20is\x20too\x20new\x20(','timers','paymentId','telegramBotService','\x20for\x20payment\x20','\x20current\x20status:\x20','timestamp','created','PENDING','sendShopWebhook','message','Payment\x20older\x20than\x20','push','\x20status\x20unchanged\x20(','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','⚠️\x20[CHECK]\x20Payment\x20','\x20updated\x20successfully','customerName','Failed\x20to\x20send\x20shop\x20webhook:','log','0100','\x20\x20\x20📍\x20Source:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','checkSinglePayment','checkPaymentStatus','bankDetails','iban','gatewayOrderId','837960EXmuEp','toISOString','✅\x20[HOURLY]\x20Payment\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','gatewayPaymentId','\x20(age:\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','payment.pending','\x20days\x20(created\x20before\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','delay','delete','unknown','findUnique','coinToPayService','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','auto_expire','\x20skipped,\x20','❌\x20[HOURLY]\x20Payment\x20','\x20\x20\x20-\x20Status:\x20','description','1974198OhSYXN','stringify','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','2098965zOhPHS','\x20days','create','confirmedOn','customerEmail','createdAt','./gateways/coinToPayService','paymentTimers','payment','set','checkSinglePaymentById','cointopay_auto_expired','\x20individual\x20payment\x20timers','from','__importDefault','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','logShopWebhookSent','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','createdOn','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20marked\x20as\x20paid\x20at:\x20','loggerService','error','5\x20minutes','📊\x20[CHECK]\x20Payment\x20','EXPIRED','adminNotes','clearPaymentTimers','./telegramBotService','\x20\x20\x20❌\x20Error:\x20','🛑\x20[SHUTDOWN]\x20Cleared\x20','default','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','CoinToPayService','failed','shop','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','1\x20minute','🧹\x20[DEBUG]\x20Clearing\x20','🪙\x20[DEBUG]\x20Creating\x20','GLOBAL_CHECK_INTERVAL_MS','Payment\x20not\x20found','\x20to\x20clear','TesSoft\x20Payment\x20System/1.0','\x20with\x20status\x20','orderId','\x20expired','transactionId','webhookEvents','6SGJTQx','webhook_send','logWhiteDomainError','size','⏰\x20[GLOBAL]\x20Payment\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','4040361SNoYlg','status','COINTOPAY_ERROR','FAILED','\x20not\x20enabled\x20for\x20shop\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20completed\x20for\x20payment\x20','Shop\x20webhook\x20sent\x20to\x20','4643298QBazdy','\x20\x20\x20-\x20paymentId:\x20','toFixed','\x20expired\x20CoinToPay\x20payments','sendPaymentStatusNotification','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','globalCheckInterval','./loggerService','status_check','catch','\x20\x20\x20-\x20ShopId:\x20','getTime','\x20pending\x20CoinToPay\x20payments','\x20status:\x20','EXPIRY_DAYS','sendPaymentNotification','COINTOPAY_STATUS_CHANGE','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','Success','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','logCoinToPayError','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','__esModule','floor','-day\x20timeout','amount','logShopWebhookError','\x20->\x20','\x20is\x20older\x20than\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','paid','1653672CMOjQY','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','Automatically\x20expired\x20after\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','Unknown\x20error','currency','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','\x20triggered\x20for\x20payment\x20','paymentDetails','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20timers\x20for\x20payment\x20','settings','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','startPeriodicStatusCheck','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','/status/','\x20days\x20without\x20payment\x20confirmation','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes',',\x20clearing\x20individual\x20timers','\x20\x20\x20-\x20Amount:\x20','not\x20found','logCoinToPayStatus','payment.failed','\x20has\x20no\x20gatewayPaymentId','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','length','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20not\x20found,\x20clearing\x20timers','📊\x20[HOURLY]\x20Payment\x20','shopId','.\x20Remaining\x20active\x20timers:\x20','\x20\x20\x20📅\x20Time:\x20','\x20status\x20is\x20','PAID','\x20in\x20','text','get','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','payment.success','cointopay','\x20not\x20found\x20in\x20database','\x20initial\x20timers\x20for\x20payment\x20','webhookUrl','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','webhookLog','\x20checked,\x20','CoinToPayStatusService','now','gateway','3VQCLdG','🧹\x20[CHECK]\x20Payment\x20','💰\x20[CHECK]\x20Payment\x20','✅\x20[CHECK]\x20Payment\x20','values','not\x20confirmed','update','\x20days,\x20marking\x20as\x20EXPIRED','getDate','\x20\x20\x20-\x20Gateway:\x20','\x20\x20\x20📝\x20Details:'];a37_0x2742=function(){return _0x3faf83;};return a37_0x2742();}const a37_0xba7ac2=a37_0x3ce2;(function(_0x40899e,_0xe0ea1a){const _0x51a81b=a37_0x3ce2,_0x5cee18=_0x40899e();while(!![]){try{const _0x25fbe3=-parseInt(_0x51a81b(0x108))/0x1*(parseInt(_0x51a81b(0x9d))/0x2)+parseInt(_0x51a81b(0xfc))/0x3*(-parseInt(_0x51a81b(0xca))/0x4)+parseInt(_0x51a81b(0x155))/0x5+parseInt(_0x51a81b(0x151))/0x6+parseInt(_0x51a81b(0x113))/0x7*(-parseInt(_0x51a81b(0x13c))/0x8)+parseInt(_0x51a81b(0xa3))/0x9+-parseInt(_0x51a81b(0x107))/0xa*(-parseInt(_0x51a81b(0xab))/0xb);if(_0x25fbe3===_0xe0ea1a)break;else _0x5cee18['push'](_0x5cee18['shift']());}catch(_0x14b760){_0x5cee18['push'](_0x5cee18['shift']());}}}(a37_0x2742,0x5781e));var __importDefault=this&&this[a37_0xba7ac2(0x163)]||function(_0x489b53){const _0x25131f=a37_0xba7ac2;return _0x489b53&&_0x489b53[_0x25131f(0xc1)]?_0x489b53:{'default':_0x489b53};};Object['defineProperty'](exports,a37_0xba7ac2(0xc1),{'value':!![]}),exports[a37_0xba7ac2(0x109)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a37_0xba7ac2(0x15b)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0xba7ac2(0x171)),loggerService_1=require(a37_0xba7ac2(0xb2));class CoinToPayStatusService{constructor(){const _0x505f15=a37_0xba7ac2;this[_0x505f15(0xb1)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x505f15(0x15c)]=new Map(),this[_0x505f15(0x14a)]=new coinToPayService_1[(_0x505f15(0x176))](),console[_0x505f15(0x133)]('🪙\x20CoinToPayStatusService\x20initialized');}['schedulePaymentChecks'](_0x5ab5ac,_0x132475){const _0x374341=a37_0xba7ac2;console[_0x374341(0x133)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x374341(0x133)](_0x374341(0xac)+_0x5ab5ac),console['log'](_0x374341(0xa2)+_0x132475),this[_0x374341(0x170)](_0x5ab5ac);const _0x19650c=[],_0x5b3bc1=new Date(),_0xb804e=[{'delay':0x1*0x3c*0x3e8,'description':_0x374341(0x91)},{'delay':0x2*0x3c*0x3e8,'description':_0x374341(0x10a)},{'delay':0x5*0x3c*0x3e8,'description':_0x374341(0x16c)},{'delay':0x5*0x3c*0x3e8,'description':_0x374341(0x16c)}];console[_0x374341(0x133)](_0x374341(0x93)+_0xb804e[_0x374341(0xe4)]+_0x374341(0xf4)+_0x5ab5ac);let _0x48d854=0x0;_0xb804e[_0x374341(0x10c)]((_0x20a7fc,_0x38a879)=>{const _0x3ee88e=_0x374341;_0x48d854+=_0x20a7fc[_0x3ee88e(0x146)];const _0x338230=setTimeout(async()=>{const _0x365399=_0x3ee88e;console[_0x365399(0x133)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x38a879+0x1)+_0x365399(0xd1)+_0x5ab5ac+'\x20(after\x20'+_0x20a7fc['description']+')');try{await this['checkSinglePaymentById'](_0x5ab5ac),console[_0x365399(0x133)](_0x365399(0x13f)+(_0x38a879+0x1)+_0x365399(0xa9)+_0x5ab5ac);}catch(_0xa4ca20){console[_0x365399(0x16b)](_0x365399(0x164)+(_0x38a879+0x1)+_0x365399(0x124)+_0x5ab5ac+':',_0xa4ca20),this[_0x365399(0xbf)](_0x5ab5ac,_0x132475,_0xa4ca20,'status_check',{'checkNumber':_0x38a879+0x1,'scheduledAfter':_0x20a7fc[_0x365399(0x150)],'isIndividualCheck':!![]});}},_0x48d854);_0x19650c[_0x3ee88e(0x12c)](_0x338230),console[_0x3ee88e(0x133)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x38a879+0x1)+_0x3ee88e(0x124)+_0x5ab5ac+_0x3ee88e(0xed)+_0x48d854/0x3e8+_0x3ee88e(0x10b)+_0x20a7fc['description']+')');});const _0x332c76=setInterval(async()=>{const _0x589341=_0x374341;console[_0x589341(0x133)](_0x589341(0x168)+_0x5ab5ac);try{const _0x5ea9f7=await database_1['default'][_0x589341(0x15d)][_0x589341(0x149)]({'where':{'id':_0x5ab5ac},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x5ea9f7){console[_0x589341(0x133)](_0x589341(0x14e)+_0x5ab5ac+_0x589341(0xe6)),this['clearPaymentTimers'](_0x5ab5ac);return;}console[_0x589341(0x133)](_0x589341(0xe7)+_0x5ab5ac+_0x589341(0x125)+_0x5ea9f7[_0x589341(0xa4)]);if(_0x5ea9f7['status']!=='PENDING'){console['log'](_0x589341(0x13e)+_0x5ab5ac+_0x589341(0xeb)+_0x5ea9f7[_0x589341(0xa4)]+',\x20stopping\x20individual\x20checks'),this[_0x589341(0x170)](_0x5ab5ac);return;}const _0x177d75=Math[_0x589341(0xc2)]((Date['now']()-_0x5ea9f7[_0x589341(0x15a)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x177d75>=this[_0x589341(0xb9)]){console[_0x589341(0x133)]('⏰\x20[HOURLY]\x20Payment\x20'+_0x5ab5ac+_0x589341(0xc7)+this[_0x589341(0xb9)]+_0x589341(0x175)),this[_0x589341(0x170)](_0x5ab5ac);return;}await this[_0x589341(0x15f)](_0x5ab5ac),console[_0x589341(0x133)](_0x589341(0x12e)+_0x5ab5ac);}catch(_0x3bd8f6){console[_0x589341(0x16b)](_0x589341(0xd6)+_0x5ab5ac+':',_0x3bd8f6),this['logCoinToPayError'](_0x5ab5ac,_0x132475,_0x3bd8f6,_0x589341(0xb3),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x19650c['push'](_0x332c76),this[_0x374341(0x15c)][_0x374341(0x15e)](_0x5ab5ac,{'timers':_0x19650c,'paymentId':_0x5ab5ac,'gatewayPaymentId':_0x132475,'createdAt':_0x5b3bc1}),console[_0x374341(0x133)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0xb804e[_0x374341(0xe4)]+_0x374341(0xe3)+_0x5ab5ac),console[_0x374341(0x133)](_0x374341(0xc8)+this['paymentTimers'][_0x374341(0xa0)]),this['logCoinToPayStatus'](_0x5ab5ac,_0x132475,_0x374341(0x128),_0x374341(0x128),_0x374341(0xb3),{'action':'schedule_created','scheduledChecks':_0xb804e[_0x374341(0xe4)],'firstCheckIn':_0xb804e[0x0]['delay']/0x3e8,'totalTimers':this[_0x374341(0x15c)][_0x374341(0xa0)]});}[a37_0xba7ac2(0x170)](_0x5b3d0e){const _0x286cf8=a37_0xba7ac2,_0x3307a1=this[_0x286cf8(0x15c)][_0x286cf8(0xef)](_0x5b3d0e);_0x3307a1?(console[_0x286cf8(0x133)](_0x286cf8(0x92)+_0x3307a1['timers']['length']+_0x286cf8(0xd4)+_0x5b3d0e),_0x3307a1['timers']['forEach']((_0x383ff5,_0x2c46a3)=>{const _0xf013de=_0x286cf8;_0x383ff5&&(clearTimeout(_0x383ff5),clearInterval(_0x383ff5),console[_0xf013de(0x133)](_0xf013de(0xe5)+(_0x2c46a3+0x1)+'\x20for\x20payment\x20'+_0x5b3d0e));}),this[_0x286cf8(0x15c)][_0x286cf8(0x147)](_0x5b3d0e),console[_0x286cf8(0x133)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x5b3d0e+_0x286cf8(0xe9)+this[_0x286cf8(0x15c)][_0x286cf8(0xa0)])):console[_0x286cf8(0x133)](_0x286cf8(0xcb)+_0x5b3d0e+_0x286cf8(0x96));}async['checkSinglePaymentById'](_0x559df7){const _0x1acd40=a37_0xba7ac2;console[_0x1acd40(0x133)](_0x1acd40(0xb0)+_0x559df7);const _0x152450=await database_1['default'][_0x1acd40(0x15d)][_0x1acd40(0x149)]({'where':{'id':_0x559df7},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x152450){console['log']('❌\x20[CHECK]\x20Payment\x20'+_0x559df7+_0x1acd40(0xf3));return;}console[_0x1acd40(0x133)](_0x1acd40(0x16d)+_0x559df7+'\x20found:'),console[_0x1acd40(0x133)](_0x1acd40(0x105)+_0x152450[_0x1acd40(0xfb)]),console[_0x1acd40(0x133)](_0x1acd40(0x14f)+_0x152450[_0x1acd40(0xa4)]),console[_0x1acd40(0x133)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x152450[_0x1acd40(0x140)]),console[_0x1acd40(0x133)](_0x1acd40(0xde)+_0x152450[_0x1acd40(0xc4)]+'\x20'+_0x152450[_0x1acd40(0xcf)]),console[_0x1acd40(0x133)](_0x1acd40(0xb5)+_0x152450['shopId']);if(_0x152450[_0x1acd40(0xfb)]!==_0x1acd40(0xf2)){console[_0x1acd40(0x133)](_0x1acd40(0x12f)+_0x559df7+_0x1acd40(0x166)+_0x152450[_0x1acd40(0xfb)]+')');return;}if(_0x152450[_0x1acd40(0xa4)]!=='PENDING'){console[_0x1acd40(0x133)](_0x1acd40(0x12f)+_0x559df7+_0x1acd40(0xeb)+_0x152450[_0x1acd40(0xa4)]+',\x20stopping\x20individual\x20checks'),this[_0x1acd40(0x170)](_0x559df7);return;}if(!_0x152450[_0x1acd40(0x140)]){console[_0x1acd40(0x133)](_0x1acd40(0x12f)+_0x559df7+_0x1acd40(0xe2));return;}console[_0x1acd40(0x133)](_0x1acd40(0xff)+_0x559df7+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x1acd40(0x137)](_0x152450);}[a37_0xba7ac2(0xe0)](_0x1c84b2,_0x43e1af,_0x39b6f4,_0x496bae,_0x5dc020,_0x288f96){const _0xb70acb=a37_0xba7ac2,_0x3cef5e={'type':_0xb70acb(0xbb),'paymentId':_0x1c84b2,'gatewayPaymentId':_0x43e1af,'oldStatus':_0x39b6f4,'newStatus':_0x496bae,'source':_0x5dc020,'timestamp':new Date()[_0xb70acb(0x13d)](),'details':_0x288f96||{}};loggerService_1['loggerService'][_0xb70acb(0xe0)](_0x3cef5e),console[_0xb70acb(0x133)](_0xb70acb(0x10d)+_0x1c84b2+'\x20('+_0x43e1af+')'),console[_0xb70acb(0x133)]('\x20\x20\x20📊\x20Status:\x20'+_0x39b6f4+_0xb70acb(0xc6)+_0x496bae),console[_0xb70acb(0x133)](_0xb70acb(0x135)+_0x5dc020),console[_0xb70acb(0x133)]('\x20\x20\x20📅\x20Time:\x20'+_0x3cef5e['timestamp']),_0x288f96&&console[_0xb70acb(0x133)](_0xb70acb(0x106),_0x288f96);}[a37_0xba7ac2(0xbf)](_0x37459f,_0x579e07,_0x1ee258,_0x1a1b49,_0x132ded){const _0x2aaf09=a37_0xba7ac2,_0xbf9b75={'type':_0x2aaf09(0xa5),'paymentId':_0x37459f,'gatewayPaymentId':_0x579e07,'error':_0x1ee258 instanceof Error?{'message':_0x1ee258[_0x2aaf09(0x12a)],'stack':_0x1ee258['stack']}:_0x1ee258,'source':_0x1a1b49,'timestamp':new Date()['toISOString'](),'context':_0x132ded||{}};loggerService_1[_0x2aaf09(0x16a)][_0x2aaf09(0xbf)](_0xbf9b75),console[_0x2aaf09(0x16b)](_0x2aaf09(0x115)+_0x37459f+'\x20('+_0x579e07+')'),console[_0x2aaf09(0x16b)](_0x2aaf09(0x172)+(_0x1ee258 instanceof Error?_0x1ee258[_0x2aaf09(0x12a)]:_0x1ee258)),console[_0x2aaf09(0x16b)](_0x2aaf09(0x135)+_0x1a1b49),console[_0x2aaf09(0x16b)](_0x2aaf09(0xea)+_0xbf9b75[_0x2aaf09(0x126)]),_0x132ded&&console[_0x2aaf09(0x16b)](_0x2aaf09(0x11b),_0x132ded);}[a37_0xba7ac2(0xd7)](){const _0x5ee60f=a37_0xba7ac2;console['log'](_0x5ee60f(0x154)),this['checkAllPendingPayments']()[_0x5ee60f(0xb4)](_0x22811e=>{const _0x4f6914=_0x5ee60f;console[_0x4f6914(0x16b)](_0x4f6914(0xf0),_0x22811e);}),this[_0x5ee60f(0xb1)]=setInterval(async()=>{const _0x15fc0a=_0x5ee60f;try{console[_0x15fc0a(0x133)](_0x15fc0a(0x153)),await this[_0x15fc0a(0x117)](),console[_0x15fc0a(0x133)](_0x15fc0a(0xd3));}catch(_0x508c80){console['error'](_0x15fc0a(0xdb),_0x508c80);}},this[_0x5ee60f(0x94)]),console['log'](_0x5ee60f(0x119));}['stopPeriodicStatusCheck'](){const _0x350d48=a37_0xba7ac2;console['log'](_0x350d48(0xd8));this[_0x350d48(0xb1)]&&(clearInterval(this[_0x350d48(0xb1)]),this[_0x350d48(0xb1)]=null,console[_0x350d48(0x133)](_0x350d48(0xbe)));const _0x190e22=this['paymentTimers'][_0x350d48(0xa0)];for(const [_0x5b34c6]of this[_0x350d48(0x15c)]){this['clearPaymentTimers'](_0x5b34c6);}console[_0x350d48(0x133)](_0x350d48(0x173)+_0x190e22+_0x350d48(0x161));}async[a37_0xba7ac2(0x117)](){const _0x8201eb=a37_0xba7ac2;try{console[_0x8201eb(0x133)](_0x8201eb(0xbc));const _0x4e23ee=await database_1[_0x8201eb(0x174)][_0x8201eb(0x15d)][_0x8201eb(0x10e)]({'where':{'gateway':_0x8201eb(0xf2),'status':_0x8201eb(0x128),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x8201eb(0x133)]('🪙\x20[GLOBAL]\x20Found\x20'+_0x4e23ee[_0x8201eb(0xe4)]+_0x8201eb(0xb7));if(_0x4e23ee[_0x8201eb(0xe4)]===0x0){console[_0x8201eb(0x133)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x53324e=await this[_0x8201eb(0x118)](_0x4e23ee);console['log']('⏰\x20[GLOBAL]\x20Found\x20'+_0x53324e['length']+_0x8201eb(0xae));let _0x537db1=0x0,_0x324945=0x0;for(const _0xa9884d of _0x4e23ee){try{if(_0x53324e[_0x8201eb(0x10f)](_0xa9884d['id'])){console[_0x8201eb(0x133)](_0x8201eb(0xa1)+_0xa9884d['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x324945++;continue;}if(this['paymentTimers']['has'](_0xa9884d['id'])){console['log'](_0x8201eb(0xa1)+_0xa9884d['id']+_0x8201eb(0xc0)),_0x324945++;continue;}const _0x4bf59a=(Date[_0x8201eb(0xfa)]()-_0xa9884d[_0x8201eb(0x15a)][_0x8201eb(0xb6)]())/(0x3e8*0x3c*0x3c);if(_0x4bf59a<0x1){console['log'](_0x8201eb(0xa1)+_0xa9884d['id']+_0x8201eb(0x120)+_0x4bf59a[_0x8201eb(0xad)](0x1)+_0x8201eb(0x11f)),_0x324945++;continue;}console[_0x8201eb(0x133)](_0x8201eb(0xf6)+_0xa9884d['id']+_0x8201eb(0x141)+_0x4bf59a[_0x8201eb(0xad)](0x1)+'h)'),await this[_0x8201eb(0x137)](_0xa9884d),_0x537db1++,await new Promise(_0x19e07c=>setTimeout(_0x19e07c,0x7d0));}catch(_0x353033){console[_0x8201eb(0x16b)](_0x8201eb(0xa8)+_0xa9884d['id']+':',_0x353033),this[_0x8201eb(0xbf)](_0xa9884d['id'],_0xa9884d[_0x8201eb(0x140)]||_0x8201eb(0x148),_0x353033,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0xa9884d[_0x8201eb(0xc4)],'paymentCurrency':_0xa9884d['currency'],'shopId':_0xa9884d['shopId'],'createdAt':_0xa9884d['createdAt']}),loggerService_1[_0x8201eb(0x16a)][_0x8201eb(0x9f)](_0x8201eb(0xf2),_0x8201eb(0xd9)+_0xa9884d[_0x8201eb(0x140)],_0x353033);}}console[_0x8201eb(0x133)](_0x8201eb(0x14b)+_0x537db1+_0x8201eb(0xf8)+_0x324945+_0x8201eb(0x14d)+_0x53324e[_0x8201eb(0xe4)]+_0x8201eb(0x9a));}catch(_0x30ab34){console[_0x8201eb(0x16b)]('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x30ab34);}}async['checkExpiredPayments'](_0x5bf6bc){const _0x50dbbb=a37_0xba7ac2,_0x1ffa5a=[],_0x50a817=new Date();_0x50a817['setDate'](_0x50a817[_0x50dbbb(0x104)]()-this[_0x50dbbb(0xb9)]),console[_0x50dbbb(0x133)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x50dbbb(0xb9)]+_0x50dbbb(0x144)+_0x50a817['toISOString']()+')');for(const _0x526d11 of _0x5bf6bc){if(_0x526d11[_0x50dbbb(0x15a)]<_0x50a817){console[_0x50dbbb(0x133)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x526d11['id']+_0x50dbbb(0xc7)+this['EXPIRY_DAYS']+_0x50dbbb(0x103));try{this[_0x50dbbb(0xe0)](_0x526d11['id'],_0x526d11['gatewayPaymentId']||_0x50dbbb(0x148),_0x50dbbb(0x128),_0x50dbbb(0x16e),_0x50dbbb(0x14c),{'reason':_0x50dbbb(0x12b)+this[_0x50dbbb(0xb9)]+'\x20days','createdAt':_0x526d11['createdAt'],'daysSinceCreation':Math[_0x50dbbb(0xc2)]((Date[_0x50dbbb(0xfa)]()-_0x526d11['createdAt'][_0x50dbbb(0xb6)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x526d11[_0x50dbbb(0xc4)],'paymentCurrency':_0x526d11[_0x50dbbb(0xcf)],'shopId':_0x526d11[_0x50dbbb(0xe8)]}),await database_1[_0x50dbbb(0x174)][_0x50dbbb(0x15d)]['update']({'where':{'id':_0x526d11['id']},'data':{'status':_0x50dbbb(0x16e),'updatedAt':new Date(),'adminNotes':_0x50dbbb(0xcc)+this[_0x50dbbb(0xb9)]+_0x50dbbb(0xda)}}),await database_1[_0x50dbbb(0x174)]['webhookLog'][_0x50dbbb(0x157)]({'data':{'paymentId':_0x526d11['id'],'shopId':_0x526d11[_0x50dbbb(0xe8)],'event':_0x50dbbb(0x160),'statusCode':0xc8,'responseBody':JSON[_0x50dbbb(0x152)]({'reason':_0x50dbbb(0x12b)+this[_0x50dbbb(0xb9)]+_0x50dbbb(0x156),'createdAt':_0x526d11[_0x50dbbb(0x15a)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x50dbbb(0xc2)]((Date[_0x50dbbb(0xfa)]()-_0x526d11[_0x50dbbb(0x15a)][_0x50dbbb(0xb6)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x526d11,'EXPIRED'),await this[_0x50dbbb(0xaf)](_0x526d11,'EXPIRED'),this['clearPaymentTimers'](_0x526d11['id']),_0x1ffa5a[_0x50dbbb(0x12c)](_0x526d11['id']),console[_0x50dbbb(0x133)](_0x50dbbb(0x11e)+_0x526d11['id']+_0x50dbbb(0x142)+this[_0x50dbbb(0xb9)]+_0x50dbbb(0xc3));}catch(_0x4faedc){console[_0x50dbbb(0x16b)]('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x526d11['id']+':',_0x4faedc),this[_0x50dbbb(0xbf)](_0x526d11['id'],_0x526d11[_0x50dbbb(0x140)]||_0x50dbbb(0x148),_0x4faedc,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x526d11[_0x50dbbb(0x15a)],'daysSinceCreation':Math[_0x50dbbb(0xc2)]((Date[_0x50dbbb(0xfa)]()-_0x526d11[_0x50dbbb(0x15a)][_0x50dbbb(0xb6)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x1ffa5a;}async[a37_0xba7ac2(0x137)](_0x2f6620){const _0x3de161=a37_0xba7ac2;if(!_0x2f6620['gatewayPaymentId']){console['log'](_0x3de161(0x12f)+_0x2f6620['id']+_0x3de161(0x111));return;}console[_0x3de161(0x133)]('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x2f6620['id']+'\x20('+_0x2f6620['gatewayPaymentId']+')');try{const _0x45b368=await this['coinToPayService'][_0x3de161(0x138)](_0x2f6620[_0x3de161(0x140)]);console[_0x3de161(0x133)]('📊\x20[CHECK]\x20Payment\x20'+_0x2f6620['id']+_0x3de161(0xb8)+_0x45b368['status']);_0x45b368[_0x3de161(0xd2)]&&console[_0x3de161(0x133)](_0x3de161(0x16d)+_0x2f6620['id']+_0x3de161(0x116),{'iban':_0x45b368['paymentDetails'][_0x3de161(0x13a)]||_0x3de161(0xdf),'transactionId':_0x45b368[_0x3de161(0xd2)]['transactionId'],'createdOn':_0x45b368['paymentDetails'][_0x3de161(0x167)],'confirmedOn':_0x45b368[_0x3de161(0xd2)]['confirmedOn']||_0x3de161(0x101)});if(_0x45b368[_0x3de161(0xa4)]!==_0x2f6620[_0x3de161(0xa4)]){console[_0x3de161(0x133)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x2f6620['id']+'\x20status\x20from\x20'+_0x2f6620['status']+'\x20to\x20'+_0x45b368[_0x3de161(0xa4)]),this['logCoinToPayStatus'](_0x2f6620['id'],_0x2f6620[_0x3de161(0x140)],_0x2f6620['status'],_0x45b368[_0x3de161(0xa4)],_0x3de161(0xb3),{'paymentDetails':_0x45b368[_0x3de161(0xd2)],'amount':_0x45b368[_0x3de161(0xc4)],'currency':_0x45b368[_0x3de161(0xcf)],'shopId':_0x2f6620['shopId'],'checkTimestamp':new Date()['toISOString']()});const _0x1af56b={'status':_0x45b368[_0x3de161(0xa4)],'updatedAt':new Date()};_0x45b368[_0x3de161(0xa4)]===_0x3de161(0xec)&&_0x2f6620[_0x3de161(0xa4)]!==_0x3de161(0xec)&&(_0x1af56b['paidAt']=new Date(),console[_0x3de161(0x133)](_0x3de161(0xfe)+_0x2f6620['id']+_0x3de161(0x169)+_0x1af56b['paidAt'][_0x3de161(0x13d)]()));if(_0x45b368[_0x3de161(0xd2)]){const _0x2f7d8c=_0x45b368[_0x3de161(0xd2)];_0x2f7d8c[_0x3de161(0x13a)]&&(_0x1af56b[_0x3de161(0x110)]=_0x2f7d8c['iban'],console[_0x3de161(0x133)](_0x3de161(0x11c)+_0x2f7d8c[_0x3de161(0x13a)]));if(_0x2f7d8c[_0x3de161(0x139)]){const _0x38b9c3=_0x2f6620['adminNotes']||'',_0x1650de='Bank\x20Details:\x20'+_0x2f7d8c[_0x3de161(0x139)];_0x1af56b[_0x3de161(0x16f)]=_0x38b9c3?_0x38b9c3+'\x0a\x0a'+_0x1650de:_0x1650de,console['log'](_0x3de161(0xdc));}_0x2f7d8c[_0x3de161(0x9b)]&&console[_0x3de161(0x133)](_0x3de161(0xd0)+_0x2f7d8c[_0x3de161(0x9b)]),_0x2f7d8c[_0x3de161(0x158)]&&console[_0x3de161(0x133)](_0x3de161(0x11a)+_0x2f7d8c[_0x3de161(0x158)]);}await database_1[_0x3de161(0x174)][_0x3de161(0x15d)][_0x3de161(0x102)]({'where':{'id':_0x2f6620['id']},'data':_0x1af56b}),await database_1['default'][_0x3de161(0xf7)][_0x3de161(0x157)]({'data':{'paymentId':_0x2f6620['id'],'shopId':_0x2f6620[_0x3de161(0xe8)],'event':'cointopay_status_check_'+_0x45b368[_0x3de161(0xa4)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x2f6620[_0x3de161(0xa4)],'newStatus':_0x45b368['status'],'paymentDetails':_0x45b368[_0x3de161(0xd2)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x3de161(0x129)](_0x2f6620,_0x45b368[_0x3de161(0xa4)]),await this[_0x3de161(0xaf)](_0x2f6620,_0x45b368[_0x3de161(0xa4)]),_0x45b368[_0x3de161(0xa4)]!==_0x3de161(0x128)&&(console[_0x3de161(0x133)](_0x3de161(0xfd)+_0x2f6620['id']+'\x20status\x20changed\x20to\x20'+_0x45b368['status']+_0x3de161(0xdd)),this[_0x3de161(0x170)](_0x2f6620['id'])),console[_0x3de161(0x133)](_0x3de161(0xff)+_0x2f6620['id']+_0x3de161(0x130));}else console[_0x3de161(0x133)](_0x3de161(0x16d)+_0x2f6620['id']+_0x3de161(0x12d)+_0x45b368[_0x3de161(0xa4)]+')'),this[_0x3de161(0xe0)](_0x2f6620['id'],_0x2f6620[_0x3de161(0x140)],_0x2f6620[_0x3de161(0xa4)],_0x45b368[_0x3de161(0xa4)],_0x3de161(0xb3),{'statusUnchanged':!![],'paymentDetails':_0x45b368[_0x3de161(0xd2)],'amount':_0x45b368[_0x3de161(0xc4)],'currency':_0x45b368[_0x3de161(0xcf)],'shopId':_0x2f6620[_0x3de161(0xe8)],'checkTimestamp':new Date()[_0x3de161(0x13d)]()});}catch(_0x1f37bd){console[_0x3de161(0x16b)](_0x3de161(0x90)+_0x2f6620['id']+':',_0x1f37bd),this[_0x3de161(0xbf)](_0x2f6620['id'],_0x2f6620[_0x3de161(0x140)],_0x1f37bd,_0x3de161(0xb3),{'paymentAmount':_0x2f6620[_0x3de161(0xc4)],'paymentCurrency':_0x2f6620['currency'],'shopId':_0x2f6620[_0x3de161(0xe8)],'createdAt':_0x2f6620[_0x3de161(0x15a)]}),await database_1[_0x3de161(0x174)][_0x3de161(0xf7)][_0x3de161(0x157)]({'data':{'paymentId':_0x2f6620['id'],'shopId':_0x2f6620[_0x3de161(0xe8)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x3de161(0x152)]({'error':_0x1f37bd instanceof Error?_0x1f37bd[_0x3de161(0x12a)]:_0x3de161(0xce),'gatewayPaymentId':_0x2f6620[_0x3de161(0x140)],'checkedAt':new Date()[_0x3de161(0x13d)]()})}});}}async[a37_0xba7ac2(0x129)](_0x377dc9,_0x5a1d38){const _0x3c09fb=a37_0xba7ac2,_0x10ac38=Date[_0x3c09fb(0xfa)]();try{const _0x2b1c06=_0x377dc9[_0x3c09fb(0x8f)],_0xe12a21=_0x2b1c06[_0x3c09fb(0xd5)];if(!_0xe12a21?.['webhookUrl']){console[_0x3c09fb(0x133)](_0x3c09fb(0x145)+_0x2b1c06['id']);return;}const _0x284b8d=_0x5a1d38===_0x3c09fb(0xec)?_0x3c09fb(0xf1):_0x5a1d38===_0x3c09fb(0xa6)?'payment.failed':_0x5a1d38===_0x3c09fb(0x16e)?_0x3c09fb(0xe1):_0x3c09fb(0x143);if(!_0xe12a21[_0x3c09fb(0x9c)]?.['includes'](_0x284b8d)){console[_0x3c09fb(0x133)]('Webhook\x20event\x20'+_0x284b8d+_0x3c09fb(0xa7)+_0x2b1c06['id']);return;}const _0x44dcba={'event':_0x284b8d,'payment':{'id':_0x377dc9['id'],'order_id':_0x377dc9[_0x3c09fb(0x99)],'gateway_order_id':_0x377dc9[_0x3c09fb(0x13b)],'gateway':_0x3c09fb(0x134),'amount':_0x377dc9[_0x3c09fb(0xc4)],'currency':_0x377dc9['currency'],'status':_0x5a1d38['toLowerCase'](),'customer_email':_0x377dc9[_0x3c09fb(0x159)],'customer_name':_0x377dc9[_0x3c09fb(0x131)],'created_at':_0x377dc9[_0x3c09fb(0x15a)],'updated_at':new Date()}},_0x28b148=await fetch(_0xe12a21[_0x3c09fb(0xf5)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x3c09fb(0x97)},'body':JSON['stringify'](_0x44dcba)}),_0x340b00=Date[_0x3c09fb(0xfa)]()-_0x10ac38,_0x5aec4b=_0x28b148['ok']?_0x3c09fb(0xbd):await _0x28b148[_0x3c09fb(0xee)]();loggerService_1['loggerService'][_0x3c09fb(0x165)](_0x377dc9[_0x3c09fb(0xe8)],_0xe12a21['webhookUrl'],_0x284b8d,_0x28b148[_0x3c09fb(0xa4)],_0x340b00,_0x44dcba),console[_0x3c09fb(0x133)](_0x3c09fb(0xaa)+_0xe12a21[_0x3c09fb(0xf5)]+_0x3c09fb(0x98)+_0x28b148['status']+'\x20('+_0x340b00+'ms)');}catch(_0x42e658){console['error'](_0x3c09fb(0x132),_0x42e658),loggerService_1[_0x3c09fb(0x16a)][_0x3c09fb(0xc5)](_0x377dc9['shopId'],_0x377dc9[_0x3c09fb(0x8f)]?.[_0x3c09fb(0xd5)]?.['webhookUrl']||_0x3c09fb(0x148),_0x3c09fb(0x9e),_0x42e658,{});}}async[a37_0xba7ac2(0xaf)](_0x5bf445,_0x5a655d){const _0x5d9dc9=a37_0xba7ac2;try{const _0x49c268={'PENDING':'created','PAID':_0x5d9dc9(0xc9),'FAILED':_0x5d9dc9(0x8e),'EXPIRED':'expired'},_0x2839cb=_0x49c268[_0x5a655d];if(!_0x2839cb||_0x2839cb===_0x5d9dc9(0x127))return;await telegramBotService_1[_0x5d9dc9(0x123)][_0x5d9dc9(0xba)](_0x5bf445['shopId'],_0x5bf445,_0x2839cb);}catch(_0x1aa307){console['error'](_0x5d9dc9(0x136),_0x1aa307);}}async[a37_0xba7ac2(0x114)](_0x693390){const _0x480256=a37_0xba7ac2;console[_0x480256(0x133)]('🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x693390);const _0x2a2ffa=await database_1['default'][_0x480256(0x15d)][_0x480256(0x149)]({'where':{'id':_0x693390},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2a2ffa)throw new Error(_0x480256(0x95));if(_0x2a2ffa['gateway']!==_0x480256(0xf2))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x480256(0x133)](_0x480256(0xcd)+_0x693390),await this[_0x480256(0x137)](_0x2a2ffa),console[_0x480256(0x133)](_0x480256(0x112)+_0x693390);}['getServiceStats'](){const _0x3f538b=a37_0xba7ac2,_0x36ea3a=this[_0x3f538b(0xb1)]?this[_0x3f538b(0x94)]:undefined,_0x38d731=Array[_0x3f538b(0x162)](this[_0x3f538b(0x15c)][_0x3f538b(0x100)]())['map'](_0x372932=>({'paymentId':_0x372932[_0x3f538b(0x122)],'gatewayPaymentId':_0x372932[_0x3f538b(0x140)],'createdAt':_0x372932[_0x3f538b(0x15a)],'timersCount':_0x372932[_0x3f538b(0x121)][_0x3f538b(0xe4)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x3f538b(0x94)]/(0x3e8*0x3c),'expiryDays':this[_0x3f538b(0xb9)],'activeIndividualTimers':this[_0x3f538b(0x15c)][_0x3f538b(0xa0)],'nextGlobalCheckIn':_0x36ea3a,'paymentTimersDetails':_0x38d731};}[a37_0xba7ac2(0x11d)](_0x45356b){const _0x3b743c=a37_0xba7ac2,_0x52babc=this['paymentTimers']['get'](_0x45356b);if(_0x52babc)return{'hasTimers':!![],'timersCount':_0x52babc[_0x3b743c(0x121)][_0x3b743c(0xe4)],'createdAt':_0x52babc[_0x3b743c(0x15a)],'gatewayPaymentId':_0x52babc[_0x3b743c(0x140)]};return{'hasTimers':![]};}}function a37_0x3ce2(_0x462f96,_0x3d8e4f){const _0x27427d=a37_0x2742();return a37_0x3ce2=function(_0x3ce2f7,_0x6ff2e5){_0x3ce2f7=_0x3ce2f7-0x8e;let _0x169d80=_0x27427d[_0x3ce2f7];return _0x169d80;},a37_0x3ce2(_0x462f96,_0x3d8e4f);}exports[a37_0xba7ac2(0xf9)]=CoinToPayStatusService,exports[a37_0xba7ac2(0x109)]=new CoinToPayStatusService();