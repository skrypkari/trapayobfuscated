'use strict';const a37_0x495c20=a37_0x3a9a;(function(_0x4634d7,_0x369daa){const _0x3f5662=a37_0x3a9a,_0x3855cd=_0x4634d7();while(!![]){try{const _0x23efa7=parseInt(_0x3f5662(0x19b))/0x1+-parseInt(_0x3f5662(0x1c4))/0x2*(-parseInt(_0x3f5662(0x13c))/0x3)+-parseInt(_0x3f5662(0x1d6))/0x4*(-parseInt(_0x3f5662(0x18e))/0x5)+-parseInt(_0x3f5662(0x1a1))/0x6*(-parseInt(_0x3f5662(0x12a))/0x7)+-parseInt(_0x3f5662(0x147))/0x8*(-parseInt(_0x3f5662(0x194))/0x9)+parseInt(_0x3f5662(0x182))/0xa+parseInt(_0x3f5662(0x114))/0xb*(-parseInt(_0x3f5662(0x134))/0xc);if(_0x23efa7===_0x369daa)break;else _0x3855cd['push'](_0x3855cd['shift']());}catch(_0x10d8a2){_0x3855cd['push'](_0x3855cd['shift']());}}}(a37_0x4e3c,0x68f02));var __importDefault=this&&this[a37_0x495c20(0x1ec)]||function(_0x4c966f){const _0x30b227=a37_0x495c20;return _0x4c966f&&_0x4c966f[_0x30b227(0x13e)]?_0x4c966f:{'default':_0x4c966f};};Object[a37_0x495c20(0x1f4)](exports,a37_0x495c20(0x13e),{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0x495c20(0x12e)]=void 0x0;const coinToPayService_1=require(a37_0x495c20(0x1cc)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x495c20(0x1dd)),loggerService_1=require('./loggerService');function a37_0x3a9a(_0x18db9d,_0x1cb625){const _0x4e3c8e=a37_0x4e3c();return a37_0x3a9a=function(_0x3a9a09,_0x46108a){_0x3a9a09=_0x3a9a09-0x10d;let _0xc61942=_0x4e3c8e[_0x3a9a09];return _0xc61942;},a37_0x3a9a(_0x18db9d,_0x1cb625);}class CoinToPayStatusService{constructor(){const _0x31d43d=a37_0x495c20;this['globalCheckInterval']=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x31d43d(0x112)]=0x5,this['paymentTimers']=new Map(),this[_0x31d43d(0x1aa)]=new coinToPayService_1[(_0x31d43d(0x16d))](),console[_0x31d43d(0x18f)]('🪙\x20CoinToPayStatusService\x20initialized');}[a37_0x495c20(0x198)](_0x40ded2,_0x2672ae){const _0x147a8d=a37_0x495c20;console['log'](_0x147a8d(0x1b3)),console[_0x147a8d(0x18f)](_0x147a8d(0x136)+_0x40ded2),console[_0x147a8d(0x18f)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x2672ae),this['clearPaymentTimers'](_0x40ded2);const _0x3e2daa=[],_0x14b97a=new Date(),_0x4f9b72=[{'delay':0x1*0x3c*0x3e8,'description':_0x147a8d(0x193)},{'delay':0x2*0x3c*0x3e8,'description':_0x147a8d(0x174)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x147a8d(0x1c3)}];console[_0x147a8d(0x18f)](_0x147a8d(0x1e6)+_0x4f9b72[_0x147a8d(0x1f7)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x40ded2);let _0x61d44f=0x0;_0x4f9b72[_0x147a8d(0x115)]((_0x695730,_0x57d0bf)=>{const _0x274aa0=_0x147a8d;_0x61d44f+=_0x695730[_0x274aa0(0x190)];const _0x249d48=setTimeout(async()=>{const _0x2d67b8=_0x274aa0;console['log'](_0x2d67b8(0x10f)+(_0x57d0bf+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x40ded2+_0x2d67b8(0x16f)+_0x695730[_0x2d67b8(0x156)]+')');try{await this[_0x2d67b8(0x1b1)](_0x40ded2),console[_0x2d67b8(0x18f)](_0x2d67b8(0x1ce)+(_0x57d0bf+0x1)+_0x2d67b8(0x1e1)+_0x40ded2);}catch(_0x20ec8){console[_0x2d67b8(0x1bc)](_0x2d67b8(0x169)+(_0x57d0bf+0x1)+_0x2d67b8(0x1ef)+_0x40ded2+':',_0x20ec8),this[_0x2d67b8(0x1a6)](_0x40ded2,_0x2672ae,_0x20ec8,'status_check',{'checkNumber':_0x57d0bf+0x1,'scheduledAfter':_0x695730[_0x2d67b8(0x156)],'isIndividualCheck':!![]});}},_0x61d44f);_0x3e2daa[_0x274aa0(0x167)](_0x249d48),console[_0x274aa0(0x18f)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x57d0bf+0x1)+'\x20for\x20payment\x20'+_0x40ded2+_0x274aa0(0x1f2)+_0x61d44f/0x3e8+_0x274aa0(0x18b)+_0x695730[_0x274aa0(0x156)]+')');});const _0x3027d6=setInterval(async()=>{const _0x97bb8f=_0x147a8d;console[_0x97bb8f(0x18f)](_0x97bb8f(0x1d7)+_0x40ded2);try{const _0x4c88d4=await database_1['default'][_0x97bb8f(0x153)][_0x97bb8f(0x1de)]({'where':{'id':_0x40ded2},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x4c88d4){console[_0x97bb8f(0x18f)]('❌\x20[HOURLY]\x20Payment\x20'+_0x40ded2+'\x20not\x20found,\x20clearing\x20timers'),this[_0x97bb8f(0x140)](_0x40ded2);return;}console['log'](_0x97bb8f(0x19e)+_0x40ded2+_0x97bb8f(0x11c)+_0x4c88d4[_0x97bb8f(0x1d8)]);if(_0x4c88d4['status']!==_0x97bb8f(0x1eb)){console[_0x97bb8f(0x18f)](_0x97bb8f(0x1cf)+_0x40ded2+_0x97bb8f(0x1b5)+_0x4c88d4[_0x97bb8f(0x1d8)]+',\x20stopping\x20individual\x20checks'),this['clearPaymentTimers'](_0x40ded2);return;}const _0x17c56c=Math['floor']((Date['now']()-_0x4c88d4[_0x97bb8f(0x161)][_0x97bb8f(0x1e8)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x17c56c>=this['EXPIRY_DAYS']){console[_0x97bb8f(0x18f)]('⏰\x20[HOURLY]\x20Payment\x20'+_0x40ded2+_0x97bb8f(0x1b0)+this['EXPIRY_DAYS']+_0x97bb8f(0x149)),this[_0x97bb8f(0x140)](_0x40ded2);return;}await this[_0x97bb8f(0x1b1)](_0x40ded2),console[_0x97bb8f(0x18f)](_0x97bb8f(0x1dc)+_0x40ded2);}catch(_0x348eaf){console[_0x97bb8f(0x1bc)](_0x97bb8f(0x157)+_0x40ded2+':',_0x348eaf),this['logCoinToPayError'](_0x40ded2,_0x2672ae,_0x348eaf,_0x97bb8f(0x1ea),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3e2daa['push'](_0x3027d6),this['paymentTimers'][_0x147a8d(0x1da)](_0x40ded2,{'timers':_0x3e2daa,'paymentId':_0x40ded2,'gatewayPaymentId':_0x2672ae,'createdAt':_0x14b97a}),console[_0x147a8d(0x18f)](_0x147a8d(0x14e)+_0x4f9b72['length']+_0x147a8d(0x1e5)+_0x40ded2),console[_0x147a8d(0x18f)]('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x147a8d(0x1b9)][_0x147a8d(0x1d4)]),this[_0x147a8d(0x122)](_0x40ded2,_0x2672ae,_0x147a8d(0x1eb),'PENDING',_0x147a8d(0x1ea),{'action':_0x147a8d(0x144),'scheduledChecks':_0x4f9b72[_0x147a8d(0x1f7)],'firstCheckIn':_0x4f9b72[0x0][_0x147a8d(0x190)]/0x3e8,'totalTimers':this[_0x147a8d(0x1b9)][_0x147a8d(0x1d4)]});}['clearPaymentTimers'](_0x21a758){const _0x1cc430=a37_0x495c20,_0x837003=this[_0x1cc430(0x1b9)][_0x1cc430(0x13b)](_0x21a758);_0x837003?(console['log']('🧹\x20[DEBUG]\x20Clearing\x20'+_0x837003[_0x1cc430(0x17a)]['length']+_0x1cc430(0x11d)+_0x21a758),_0x837003[_0x1cc430(0x17a)][_0x1cc430(0x115)]((_0x50b684,_0x23321c)=>{const _0xd26686=_0x1cc430;_0x50b684&&(clearTimeout(_0x50b684),clearInterval(_0x50b684),console['log'](_0xd26686(0x132)+(_0x23321c+0x1)+_0xd26686(0x1ef)+_0x21a758));}),this[_0x1cc430(0x1b9)][_0x1cc430(0x1ed)](_0x21a758),console[_0x1cc430(0x18f)](_0x1cc430(0x163)+_0x21a758+_0x1cc430(0x12c)+this[_0x1cc430(0x1b9)][_0x1cc430(0x1d4)])):console[_0x1cc430(0x18f)](_0x1cc430(0x11b)+_0x21a758+'\x20to\x20clear');}async[a37_0x495c20(0x1b1)](_0x207d44){const _0x2d518f=a37_0x495c20;console[_0x2d518f(0x18f)](_0x2d518f(0x165)+_0x207d44);const _0x69fedc=await database_1['default']['payment'][_0x2d518f(0x1de)]({'where':{'id':_0x207d44},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x69fedc){console[_0x2d518f(0x18f)](_0x2d518f(0x160)+_0x207d44+'\x20not\x20found\x20in\x20database');return;}console[_0x2d518f(0x18f)](_0x2d518f(0x158)+_0x207d44+_0x2d518f(0x120)),console['log'](_0x2d518f(0x1c7)+_0x69fedc[_0x2d518f(0x1a5)]),console[_0x2d518f(0x18f)]('\x20\x20\x20-\x20Status:\x20'+_0x69fedc[_0x2d518f(0x1d8)]),console['log'](_0x2d518f(0x172)+_0x69fedc['gatewayPaymentId']),console[_0x2d518f(0x18f)](_0x2d518f(0x110)+_0x69fedc[_0x2d518f(0x186)]+'\x20'+_0x69fedc[_0x2d518f(0x1be)]),console['log']('\x20\x20\x20-\x20ShopId:\x20'+_0x69fedc[_0x2d518f(0x1e2)]);if(_0x69fedc['gateway']!==_0x2d518f(0x1d2)){console[_0x2d518f(0x18f)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x207d44+_0x2d518f(0x1d1)+_0x69fedc['gateway']+')');return;}if(_0x69fedc[_0x2d518f(0x1d8)]!==_0x2d518f(0x1eb)){console[_0x2d518f(0x18f)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x207d44+_0x2d518f(0x1b5)+_0x69fedc['status']+_0x2d518f(0x1f1)),this[_0x2d518f(0x140)](_0x207d44);return;}if(!_0x69fedc['gatewayPaymentId']){console[_0x2d518f(0x18f)](_0x2d518f(0x179)+_0x207d44+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x2d518f(0x18f)](_0x2d518f(0x19f)+_0x207d44+_0x2d518f(0x1e9)),await this['checkSinglePayment'](_0x69fedc);}[a37_0x495c20(0x122)](_0x561dc6,_0x348cfa,_0x21a79f,_0x48a413,_0x32d500,_0x4dcd4d){const _0x32fda6=a37_0x495c20,_0x7fb31a={'type':_0x32fda6(0x127),'paymentId':_0x561dc6,'gatewayPaymentId':_0x348cfa,'oldStatus':_0x21a79f,'newStatus':_0x48a413,'source':_0x32d500,'timestamp':new Date()[_0x32fda6(0x19d)](),'details':_0x4dcd4d||{}};loggerService_1[_0x32fda6(0x16a)][_0x32fda6(0x122)](_0x7fb31a),console[_0x32fda6(0x18f)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x561dc6+'\x20('+_0x348cfa+')'),console['log'](_0x32fda6(0x1c2)+_0x21a79f+_0x32fda6(0x130)+_0x48a413),console['log'](_0x32fda6(0x1db)+_0x32d500),console['log'](_0x32fda6(0x1ad)+_0x7fb31a[_0x32fda6(0x189)]),_0x4dcd4d&&console[_0x32fda6(0x18f)](_0x32fda6(0x1ba),_0x4dcd4d);}['logCoinToPayError'](_0x2ffa59,_0x3f6624,_0x170ca7,_0x2adae3,_0x5b250d){const _0x395b70=a37_0x495c20,_0x53dacf={'type':_0x395b70(0x1c5),'paymentId':_0x2ffa59,'gatewayPaymentId':_0x3f6624,'error':_0x170ca7 instanceof Error?{'message':_0x170ca7[_0x395b70(0x1cd)],'stack':_0x170ca7[_0x395b70(0x138)]}:_0x170ca7,'source':_0x2adae3,'timestamp':new Date()['toISOString'](),'context':_0x5b250d||{}};loggerService_1[_0x395b70(0x16a)][_0x395b70(0x1a6)](_0x53dacf),console[_0x395b70(0x1bc)](_0x395b70(0x14a)+_0x2ffa59+'\x20('+_0x3f6624+')'),console[_0x395b70(0x1bc)]('\x20\x20\x20❌\x20Error:\x20'+(_0x170ca7 instanceof Error?_0x170ca7[_0x395b70(0x1cd)]:_0x170ca7)),console[_0x395b70(0x1bc)]('\x20\x20\x20📍\x20Source:\x20'+_0x2adae3),console[_0x395b70(0x1bc)](_0x395b70(0x1ad)+_0x53dacf[_0x395b70(0x189)]),_0x5b250d&&console['error']('\x20\x20\x20📝\x20Context:',_0x5b250d);}[a37_0x495c20(0x162)](){const _0x2a7bda=a37_0x495c20;console[_0x2a7bda(0x18f)](_0x2a7bda(0x14f)),this[_0x2a7bda(0x13f)]()[_0x2a7bda(0x16c)](_0x3d59dd=>{const _0xf5a500=_0x2a7bda;console['error'](_0xf5a500(0x15c),_0x3d59dd);}),this[_0x2a7bda(0x17e)]=setInterval(async()=>{const _0xf79207=_0x2a7bda;try{console[_0xf79207(0x18f)](_0xf79207(0x1cb)),await this[_0xf79207(0x13f)](),console[_0xf79207(0x18f)](_0xf79207(0x175));}catch(_0x1d295f){console[_0xf79207(0x1bc)](_0xf79207(0x123),_0x1d295f);}},this[_0x2a7bda(0x12d)]),console[_0x2a7bda(0x18f)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}['stopPeriodicStatusCheck'](){const _0x4dd616=a37_0x495c20;console[_0x4dd616(0x18f)](_0x4dd616(0x199));this['globalCheckInterval']&&(clearInterval(this['globalCheckInterval']),this['globalCheckInterval']=null,console[_0x4dd616(0x18f)](_0x4dd616(0x1f0)));const _0x1d1ae4=this[_0x4dd616(0x1b9)][_0x4dd616(0x1d4)];for(const [_0x598c3a]of this[_0x4dd616(0x1b9)]){this[_0x4dd616(0x140)](_0x598c3a);}console['log'](_0x4dd616(0x1ac)+_0x1d1ae4+_0x4dd616(0x119));}async[a37_0x495c20(0x13f)](){const _0x1b1f09=a37_0x495c20;try{console[_0x1b1f09(0x18f)](_0x1b1f09(0x185));const _0x4edab5=await database_1['default'][_0x1b1f09(0x153)][_0x1b1f09(0x1b8)]({'where':{'gateway':_0x1b1f09(0x1d2),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x1b1f09(0x1b6)+_0x4edab5[_0x1b1f09(0x1f7)]+_0x1b1f09(0x11f));if(_0x4edab5[_0x1b1f09(0x1f7)]===0x0){console[_0x1b1f09(0x18f)](_0x1b1f09(0x124));return;}const _0x3a51a3=await this[_0x1b1f09(0x1a9)](_0x4edab5);console[_0x1b1f09(0x18f)](_0x1b1f09(0x15b)+_0x3a51a3[_0x1b1f09(0x1f7)]+'\x20expired\x20CoinToPay\x20payments');let _0x15a185=0x0,_0x4db9d2=0x0;for(const _0x120a3d of _0x4edab5){try{if(_0x3a51a3[_0x1b1f09(0x178)](_0x120a3d['id'])){console[_0x1b1f09(0x18f)](_0x1b1f09(0x1c0)+_0x120a3d['id']+_0x1b1f09(0x180)),_0x4db9d2++;continue;}if(this['paymentTimers'][_0x1b1f09(0x17b)](_0x120a3d['id'])){console['log'](_0x1b1f09(0x1c0)+_0x120a3d['id']+_0x1b1f09(0x10e)),_0x4db9d2++;continue;}const _0x4d9b35=(Date[_0x1b1f09(0x15d)]()-_0x120a3d[_0x1b1f09(0x161)][_0x1b1f09(0x1e8)]())/(0x3e8*0x3c*0x3c);if(_0x4d9b35<0x1){console['log'](_0x1b1f09(0x1c0)+_0x120a3d['id']+_0x1b1f09(0x18c)+_0x4d9b35[_0x1b1f09(0x1af)](0x1)+_0x1b1f09(0x118)),_0x4db9d2++;continue;}console[_0x1b1f09(0x18f)](_0x1b1f09(0x14c)+_0x120a3d['id']+_0x1b1f09(0x183)+_0x4d9b35[_0x1b1f09(0x1af)](0x1)+'h)'),await this[_0x1b1f09(0x173)](_0x120a3d),_0x15a185++,await new Promise(_0x172a9d=>setTimeout(_0x172a9d,0x7d0));}catch(_0xac8efd){console[_0x1b1f09(0x1bc)](_0x1b1f09(0x1a4)+_0x120a3d['id']+':',_0xac8efd),this[_0x1b1f09(0x1a6)](_0x120a3d['id'],_0x120a3d[_0x1b1f09(0x1e3)]||'unknown',_0xac8efd,_0x1b1f09(0x1ea),{'isGlobalCheck':!![],'paymentAmount':_0x120a3d[_0x1b1f09(0x186)],'paymentCurrency':_0x120a3d['currency'],'shopId':_0x120a3d[_0x1b1f09(0x1e2)],'createdAt':_0x120a3d[_0x1b1f09(0x161)]}),loggerService_1[_0x1b1f09(0x16a)][_0x1b1f09(0x12f)]('cointopay',_0x1b1f09(0x15f)+_0x120a3d[_0x1b1f09(0x1e3)],_0xac8efd);}}console[_0x1b1f09(0x18f)](_0x1b1f09(0x133)+_0x15a185+_0x1b1f09(0x1ae)+_0x4db9d2+_0x1b1f09(0x16b)+_0x3a51a3[_0x1b1f09(0x1f7)]+_0x1b1f09(0x1bf));}catch(_0x203d54){console['error'](_0x1b1f09(0x146),_0x203d54);}}async[a37_0x495c20(0x1a9)](_0xc7c793){const _0x46a228=a37_0x495c20,_0x26b8af=[],_0x28b107=new Date();_0x28b107[_0x46a228(0x11a)](_0x28b107['getDate']()-this[_0x46a228(0x112)]),console[_0x46a228(0x18f)](_0x46a228(0x192)+this['EXPIRY_DAYS']+'\x20days\x20(created\x20before\x20'+_0x28b107[_0x46a228(0x19d)]()+')');for(const _0x476885 of _0xc7c793){if(_0x476885[_0x46a228(0x161)]<_0x28b107){console['log']('⏰\x20[EXPIRY]\x20Payment\x20'+_0x476885['id']+_0x46a228(0x1b0)+this[_0x46a228(0x112)]+_0x46a228(0x121));try{this['logCoinToPayStatus'](_0x476885['id'],_0x476885['gatewayPaymentId']||_0x46a228(0x168),_0x46a228(0x1eb),'EXPIRED','auto_expire',{'reason':_0x46a228(0x131)+this['EXPIRY_DAYS']+_0x46a228(0x181),'createdAt':_0x476885[_0x46a228(0x161)],'daysSinceCreation':Math['floor']((Date['now']()-_0x476885['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x476885[_0x46a228(0x186)],'paymentCurrency':_0x476885['currency'],'shopId':_0x476885[_0x46a228(0x1e2)]}),await database_1[_0x46a228(0x12b)]['payment']['update']({'where':{'id':_0x476885['id']},'data':{'status':_0x46a228(0x1e4),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x46a228(0x112)]+_0x46a228(0x1a3)}}),await database_1[_0x46a228(0x12b)]['webhookLog'][_0x46a228(0x164)]({'data':{'paymentId':_0x476885['id'],'shopId':_0x476885['shopId'],'event':_0x46a228(0x1c8),'statusCode':0xc8,'responseBody':JSON[_0x46a228(0x11e)]({'reason':_0x46a228(0x131)+this[_0x46a228(0x112)]+_0x46a228(0x181),'createdAt':_0x476885[_0x46a228(0x161)],'expiredAt':new Date()[_0x46a228(0x19d)](),'daysSinceCreation':Math[_0x46a228(0x1bb)]((Date[_0x46a228(0x15d)]()-_0x476885[_0x46a228(0x161)][_0x46a228(0x1e8)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x46a228(0x139)](_0x476885,_0x46a228(0x1e4)),await this[_0x46a228(0x1c6)](_0x476885,_0x46a228(0x1e4)),this['clearPaymentTimers'](_0x476885['id']),_0x26b8af[_0x46a228(0x167)](_0x476885['id']),console[_0x46a228(0x18f)](_0x46a228(0x13d)+_0x476885['id']+_0x46a228(0x137)+this[_0x46a228(0x112)]+_0x46a228(0x129));}catch(_0x128c7a){console[_0x46a228(0x1bc)](_0x46a228(0x152)+_0x476885['id']+':',_0x128c7a),this['logCoinToPayError'](_0x476885['id'],_0x476885[_0x46a228(0x1e3)]||_0x46a228(0x168),_0x128c7a,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x476885[_0x46a228(0x161)],'daysSinceCreation':Math['floor']((Date[_0x46a228(0x15d)]()-_0x476885[_0x46a228(0x161)][_0x46a228(0x1e8)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x26b8af;}async[a37_0x495c20(0x173)](_0x365a86){const _0x4cd656=a37_0x495c20;if(!_0x365a86[_0x4cd656(0x1e3)]){console['log'](_0x4cd656(0x179)+_0x365a86['id']+_0x4cd656(0x19a));return;}console[_0x4cd656(0x18f)](_0x4cd656(0x1f5)+_0x365a86['id']+'\x20('+_0x365a86[_0x4cd656(0x1e3)]+')');try{const _0x343635=await this[_0x4cd656(0x1aa)][_0x4cd656(0x126)](_0x365a86[_0x4cd656(0x1e3)]);console['log'](_0x4cd656(0x158)+_0x365a86['id']+'\x20status:\x20'+_0x343635[_0x4cd656(0x1d8)]);_0x343635['paymentDetails']&&console[_0x4cd656(0x18f)]('📊\x20[CHECK]\x20Payment\x20'+_0x365a86['id']+_0x4cd656(0x166),{'iban':_0x343635[_0x4cd656(0x15a)][_0x4cd656(0x143)]||_0x4cd656(0x1df),'transactionId':_0x343635[_0x4cd656(0x15a)][_0x4cd656(0x1a8)],'createdOn':_0x343635['paymentDetails']['createdOn'],'confirmedOn':_0x343635[_0x4cd656(0x15a)][_0x4cd656(0x150)]||_0x4cd656(0x159)});if(_0x343635[_0x4cd656(0x1d8)]!==_0x365a86[_0x4cd656(0x1d8)]){console['log'](_0x4cd656(0x17d)+_0x365a86['id']+_0x4cd656(0x116)+_0x365a86[_0x4cd656(0x1d8)]+'\x20to\x20'+_0x343635[_0x4cd656(0x1d8)]),this[_0x4cd656(0x122)](_0x365a86['id'],_0x365a86['gatewayPaymentId'],_0x365a86['status'],_0x343635[_0x4cd656(0x1d8)],_0x4cd656(0x1ea),{'paymentDetails':_0x343635[_0x4cd656(0x15a)],'amount':_0x343635[_0x4cd656(0x186)],'currency':_0x343635['currency'],'shopId':_0x365a86[_0x4cd656(0x1e2)],'checkTimestamp':new Date()[_0x4cd656(0x19d)]()});const _0x844cf4={'status':_0x343635[_0x4cd656(0x1d8)],'updatedAt':new Date()};_0x343635[_0x4cd656(0x1d8)]==='PAID'&&_0x365a86[_0x4cd656(0x1d8)]!==_0x4cd656(0x113)&&(_0x844cf4['paidAt']=new Date(),console[_0x4cd656(0x18f)](_0x4cd656(0x191)+_0x365a86['id']+_0x4cd656(0x1bd)+_0x844cf4[_0x4cd656(0x177)][_0x4cd656(0x19d)]()));if(_0x343635[_0x4cd656(0x15a)]){const _0x4e3387=_0x343635[_0x4cd656(0x15a)];_0x4e3387[_0x4cd656(0x143)]&&(_0x844cf4[_0x4cd656(0x19c)]=_0x4e3387[_0x4cd656(0x143)],console[_0x4cd656(0x18f)](_0x4cd656(0x17c)+_0x4e3387[_0x4cd656(0x143)]));if(_0x4e3387[_0x4cd656(0x1a7)]){const _0x5ea2c0=_0x365a86[_0x4cd656(0x10d)]||'',_0x4b9f8a=_0x4cd656(0x1f6)+_0x4e3387[_0x4cd656(0x1a7)];_0x844cf4[_0x4cd656(0x10d)]=_0x5ea2c0?_0x5ea2c0+'\x0a\x0a'+_0x4b9f8a:_0x4b9f8a,console[_0x4cd656(0x18f)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x4e3387[_0x4cd656(0x1a8)]&&console[_0x4cd656(0x18f)](_0x4cd656(0x18a)+_0x4e3387[_0x4cd656(0x1a8)]),_0x4e3387[_0x4cd656(0x150)]&&console['log']('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x4e3387[_0x4cd656(0x150)]);}await database_1['default'][_0x4cd656(0x153)]['update']({'where':{'id':_0x365a86['id']},'data':_0x844cf4}),await database_1[_0x4cd656(0x12b)][_0x4cd656(0x1ab)][_0x4cd656(0x164)]({'data':{'paymentId':_0x365a86['id'],'shopId':_0x365a86[_0x4cd656(0x1e2)],'event':_0x4cd656(0x13a)+_0x343635[_0x4cd656(0x1d8)][_0x4cd656(0x117)](),'statusCode':0xc8,'responseBody':JSON[_0x4cd656(0x11e)]({'oldStatus':_0x365a86[_0x4cd656(0x1d8)],'newStatus':_0x343635[_0x4cd656(0x1d8)],'paymentDetails':_0x343635[_0x4cd656(0x15a)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x4cd656(0x139)](_0x365a86,_0x343635[_0x4cd656(0x1d8)]),await this[_0x4cd656(0x1c6)](_0x365a86,_0x343635[_0x4cd656(0x1d8)]),_0x343635[_0x4cd656(0x1d8)]!=='PENDING'&&(console[_0x4cd656(0x18f)](_0x4cd656(0x16e)+_0x365a86['id']+_0x4cd656(0x1b4)+_0x343635[_0x4cd656(0x1d8)]+_0x4cd656(0x141)),this[_0x4cd656(0x140)](_0x365a86['id'])),console[_0x4cd656(0x18f)](_0x4cd656(0x19f)+_0x365a86['id']+_0x4cd656(0x1e7));}else console[_0x4cd656(0x18f)](_0x4cd656(0x158)+_0x365a86['id']+'\x20status\x20unchanged\x20('+_0x343635['status']+')'),this[_0x4cd656(0x122)](_0x365a86['id'],_0x365a86['gatewayPaymentId'],_0x365a86['status'],_0x343635[_0x4cd656(0x1d8)],_0x4cd656(0x1ea),{'statusUnchanged':!![],'paymentDetails':_0x343635[_0x4cd656(0x15a)],'amount':_0x343635[_0x4cd656(0x186)],'currency':_0x343635['currency'],'shopId':_0x365a86[_0x4cd656(0x1e2)],'checkTimestamp':new Date()[_0x4cd656(0x19d)]()});}catch(_0x276255){console[_0x4cd656(0x1bc)](_0x4cd656(0x1b7)+_0x365a86['id']+':',_0x276255),this['logCoinToPayError'](_0x365a86['id'],_0x365a86[_0x4cd656(0x1e3)],_0x276255,'status_check',{'paymentAmount':_0x365a86[_0x4cd656(0x186)],'paymentCurrency':_0x365a86[_0x4cd656(0x1be)],'shopId':_0x365a86['shopId'],'createdAt':_0x365a86[_0x4cd656(0x161)]}),await database_1[_0x4cd656(0x12b)][_0x4cd656(0x1ab)][_0x4cd656(0x164)]({'data':{'paymentId':_0x365a86['id'],'shopId':_0x365a86[_0x4cd656(0x1e2)],'event':_0x4cd656(0x135),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x276255 instanceof Error?_0x276255[_0x4cd656(0x1cd)]:_0x4cd656(0x142),'gatewayPaymentId':_0x365a86[_0x4cd656(0x1e3)],'checkedAt':new Date()['toISOString']()})}});}}async['sendShopWebhook'](_0x150da2,_0x5b4f22){const _0x30789c=a37_0x495c20,_0x47b0f8=Date['now']();try{const _0x16f248=_0x150da2['shop'],_0x167c95=_0x16f248['settings'];if(!_0x167c95?.[_0x30789c(0x1b2)]){console['log'](_0x30789c(0x14b)+_0x16f248['id']);return;}const _0x512f0c=_0x5b4f22===_0x30789c(0x113)?_0x30789c(0x148):_0x5b4f22===_0x30789c(0x187)?_0x30789c(0x1e0):_0x5b4f22===_0x30789c(0x1e4)?'payment.failed':_0x30789c(0x196);if(!_0x167c95[_0x30789c(0x145)]?.['includes'](_0x512f0c)){console[_0x30789c(0x18f)]('Webhook\x20event\x20'+_0x512f0c+_0x30789c(0x111)+_0x16f248['id']);return;}const _0x1798f6={'event':_0x512f0c,'payment':{'id':_0x150da2['id'],'order_id':_0x150da2['orderId'],'gateway_order_id':_0x150da2[_0x30789c(0x170)],'gateway':'0100','amount':_0x150da2['amount'],'currency':_0x150da2['currency'],'status':_0x5b4f22['toLowerCase'](),'customer_email':_0x150da2['customerEmail'],'customer_name':_0x150da2[_0x30789c(0x17f)],'created_at':_0x150da2['createdAt'],'updated_at':new Date()}},_0x368045=await fetch(_0x167c95['webhookUrl'],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x30789c(0x184)},'body':JSON[_0x30789c(0x11e)](_0x1798f6)}),_0x533307=Date['now']()-_0x47b0f8,_0x5d90df=_0x368045['ok']?_0x30789c(0x1a0):await _0x368045['text']();loggerService_1[_0x30789c(0x16a)][_0x30789c(0x1d3)](_0x150da2[_0x30789c(0x1e2)],_0x167c95['webhookUrl'],_0x512f0c,_0x368045[_0x30789c(0x1d8)],_0x533307,_0x1798f6),console[_0x30789c(0x18f)](_0x30789c(0x1d0)+_0x167c95[_0x30789c(0x1b2)]+_0x30789c(0x1c1)+_0x368045['status']+'\x20('+_0x533307+'ms)');}catch(_0x521454){console['error'](_0x30789c(0x1d9),_0x521454),loggerService_1[_0x30789c(0x16a)][_0x30789c(0x128)](_0x150da2[_0x30789c(0x1e2)],_0x150da2[_0x30789c(0x188)]?.[_0x30789c(0x1d5)]?.['webhookUrl']||_0x30789c(0x168),_0x30789c(0x14d),_0x521454,{});}}async[a37_0x495c20(0x1c6)](_0x422bcd,_0x513772){const _0x492af7=a37_0x495c20;try{const _0x35c5f7={'PENDING':'created','PAID':'paid','FAILED':_0x492af7(0x176),'EXPIRED':_0x492af7(0x151)},_0x4ac72a=_0x35c5f7[_0x513772];if(!_0x4ac72a||_0x4ac72a===_0x492af7(0x18d))return;await telegramBotService_1[_0x492af7(0x15e)][_0x492af7(0x154)](_0x422bcd[_0x492af7(0x1e2)],_0x422bcd,_0x4ac72a);}catch(_0x1f6d77){console[_0x492af7(0x1bc)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x1f6d77);}}async[a37_0x495c20(0x1c9)](_0x158135){const _0x507828=a37_0x495c20;console[_0x507828(0x18f)](_0x507828(0x155)+_0x158135);const _0x25ecbc=await database_1[_0x507828(0x12b)][_0x507828(0x153)][_0x507828(0x1de)]({'where':{'id':_0x158135},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x25ecbc)throw new Error(_0x507828(0x1ee));if(_0x25ecbc[_0x507828(0x1a5)]!==_0x507828(0x1d2))throw new Error(_0x507828(0x1a2));console['log'](_0x507828(0x1f3)+_0x158135),await this['checkSinglePayment'](_0x25ecbc),console['log'](_0x507828(0x171)+_0x158135);}[a37_0x495c20(0x125)](){const _0x221e9f=a37_0x495c20,_0x3b401f=this[_0x221e9f(0x17e)]?this[_0x221e9f(0x12d)]:undefined,_0x119584=Array['from'](this[_0x221e9f(0x1b9)]['values']())[_0x221e9f(0x197)](_0x5a0608=>({'paymentId':_0x5a0608['paymentId'],'gatewayPaymentId':_0x5a0608[_0x221e9f(0x1e3)],'createdAt':_0x5a0608[_0x221e9f(0x161)],'timersCount':_0x5a0608[_0x221e9f(0x17a)][_0x221e9f(0x1f7)]}));return{'isActive':!!this[_0x221e9f(0x17e)],'globalCheckIntervalMinutes':this[_0x221e9f(0x12d)]/(0x3e8*0x3c),'expiryDays':this[_0x221e9f(0x112)],'activeIndividualTimers':this['paymentTimers'][_0x221e9f(0x1d4)],'nextGlobalCheckIn':_0x3b401f,'paymentTimersDetails':_0x119584};}[a37_0x495c20(0x1ca)](_0x2595b8){const _0x5d747e=a37_0x495c20,_0x5e2dee=this['paymentTimers'][_0x5d747e(0x13b)](_0x2595b8);if(_0x5e2dee)return{'hasTimers':!![],'timersCount':_0x5e2dee[_0x5d747e(0x17a)][_0x5d747e(0x1f7)],'createdAt':_0x5e2dee[_0x5d747e(0x161)],'gatewayPaymentId':_0x5e2dee[_0x5d747e(0x1e3)]};return{'hasTimers':![]};}}function a37_0x4e3c(){const _0x45012b=['\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','webhook_send','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','confirmedOn','expired','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','payment','sendPaymentNotification','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','description','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','📊\x20[CHECK]\x20Payment\x20','not\x20confirmed','paymentDetails','⏰\x20[GLOBAL]\x20Found\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','now','telegramBotService','/status/','❌\x20[CHECK]\x20Payment\x20','createdAt','startPeriodicStatusCheck','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','create','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20details:','push','unknown','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','loggerService','\x20skipped,\x20','catch','CoinToPayService','🧹\x20[CHECK]\x20Payment\x20','\x20(after\x20','gatewayOrderId','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','checkSinglePayment','2\x20minutes','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','failed','paidAt','includes','⚠️\x20[CHECK]\x20Payment\x20','timers','has','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','🔄\x20[CHECK]\x20Updating\x20payment\x20','globalCheckInterval','customerName','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20days','5534980OjaMle','\x20(age:\x20','TesSoft\x20Payment\x20System/1.0','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','amount','FAILED','shop','timestamp','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','\x20seconds\x20(','\x20is\x20too\x20new\x20(','created','1312595IJDzRW','log','delay','💰\x20[CHECK]\x20Payment\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','1\x20minute','812394SPtwtC','coinToPayStatusService','payment.pending','map','schedulePaymentChecks','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20has\x20no\x20gatewayPaymentId,\x20skipping','254119jNZWpV','remitterIban','toISOString','📊\x20[HOURLY]\x20Payment\x20','✅\x20[CHECK]\x20Payment\x20','Success','33510nQTmoO','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20days\x20without\x20payment\x20confirmation','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','gateway','logCoinToPayError','bankDetails','transactionId','checkExpiredPayments','coinToPayService','webhookLog','🛑\x20[SHUTDOWN]\x20Cleared\x20','\x20\x20\x20📅\x20Time:\x20','\x20checked,\x20','toFixed','\x20is\x20older\x20than\x20','checkSinglePaymentById','webhookUrl','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20status\x20changed\x20to\x20','\x20status\x20is\x20','🪙\x20[GLOBAL]\x20Found\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','findMany','paymentTimers','\x20\x20\x20📝\x20Details:','floor','error','\x20marked\x20as\x20paid\x20at:\x20','currency','\x20expired','⏰\x20[GLOBAL]\x20Payment\x20','\x20with\x20status\x20','\x20\x20\x20📊\x20Status:\x20','5\x20minutes','106YxZanm','COINTOPAY_ERROR','sendPaymentStatusNotification','\x20\x20\x20-\x20Gateway:\x20','cointopay_auto_expired','checkPaymentById','getPaymentTimerInfo','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','./gateways/coinToPayService','message','✅\x20[TIMER]\x20Individual\x20check\x20#','✅\x20[HOURLY]\x20Payment\x20','Shop\x20webhook\x20sent\x20to\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','cointopay','logShopWebhookSent','size','settings','8HEKbbo','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','status','Failed\x20to\x20send\x20shop\x20webhook:','set','\x20\x20\x20📍\x20Source:\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','./telegramBotService','findUnique','not\x20found','payment.failed','\x20completed\x20for\x20payment\x20','shopId','gatewayPaymentId','EXPIRED','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','🪙\x20[DEBUG]\x20Creating\x20','\x20updated\x20successfully','getTime','\x20is\x20valid\x20for\x20checking,\x20proceeding...','status_check','PENDING','__importDefault','delete','Payment\x20not\x20found','\x20for\x20payment\x20','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped',',\x20stopping\x20individual\x20checks','\x20in\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','defineProperty','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','Bank\x20Details:\x20','length','adminNotes','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','🪙\x20[TIMER]\x20Individual\x20check\x20#','\x20\x20\x20-\x20Amount:\x20','\x20not\x20enabled\x20for\x20shop\x20','EXPIRY_DAYS','PAID','11DbFJYP','forEach','\x20status\x20from\x20','toLowerCase','h),\x20skipping\x20global\x20check','\x20individual\x20payment\x20timers','setDate','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20current\x20status:\x20','\x20timers\x20for\x20payment\x20','stringify','\x20pending\x20CoinToPay\x20payments','\x20found:','\x20days,\x20marking\x20as\x20EXPIRED','logCoinToPayStatus','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','getServiceStats','checkPaymentStatus','COINTOPAY_STATUS_CHANGE','logShopWebhookError','-day\x20timeout','7mHIBKs','default','.\x20Remaining\x20active\x20timers:\x20','GLOBAL_CHECK_INTERVAL_MS','CoinToPayStatusService','logWhiteDomainError','\x20->\x20','Payment\x20older\x20than\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','21727044CokLkO','cointopay_status_check_error','\x20\x20\x20-\x20paymentId:\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','stack','sendShopWebhook','cointopay_status_check_','get','45957hCVhJv','✅\x20[EXPIRY]\x20Payment\x20','__esModule','checkAllPendingPayments','clearPaymentTimers',',\x20clearing\x20individual\x20timers','Unknown\x20error','iban','schedule_created','webhookEvents','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','8hTXLkz','payment.success'];a37_0x4e3c=function(){return _0x45012b;};return a37_0x4e3c();}exports[a37_0x495c20(0x12e)]=CoinToPayStatusService,exports[a37_0x495c20(0x195)]=new CoinToPayStatusService();