'use strict';function a37_0x1903(){const _0x237be2=['status','error','CoinToPayService','🪙\x20[TIMER]\x20Individual\x20check\x20#','clearPaymentTimers','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','sendShopWebhook','⏰\x20[EXPIRY]\x20Payment\x20','\x20expired','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20has\x20no\x20gatewayPaymentId','\x20is\x20too\x20new\x20(','coinToPayService','sendPaymentNotification','shop','\x20\x20\x20❌\x20Error:\x20','startPeriodicStatusCheck','\x20skipped,\x20','setDate','./telegramBotService','❌\x20[HOURLY]\x20Payment\x20','customerEmail','push','POST','size','toISOString','cointopay_auto_expired','payment','schedulePaymentChecks','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','toLowerCase','includes','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','5\x20minutes','\x20not\x20found\x20in\x20database','/status/','h),\x20skipping\x20global\x20check','\x20status\x20changed\x20to\x20','payment.failed','gateway','0100','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','set','\x20\x20\x20📝\x20Context:','create','\x20not\x20enabled\x20for\x20shop\x20','Unknown\x20error','default','telegramBotService','update','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20initial\x20timers\x20for\x20payment\x20','COINTOPAY_ERROR','values','\x20\x20\x20-\x20Status:\x20','gatewayOrderId','logCoinToPayStatus','status_check','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','from','gatewayPaymentId','\x20days,\x20marking\x20as\x20EXPIRED','\x20\x20\x20-\x20ShopId:\x20','\x20status\x20from\x20','EXPIRED','8369805kXPcwk','paymentTimers','\x20pending\x20CoinToPay\x20payments','\x20(age:\x20','💰\x20[CHECK]\x20Payment\x20','\x20with\x20status\x20','customerName','\x20has\x20no\x20gatewayPaymentId,\x20skipping','cointopay','shopId','stack','❌\x20[CHECK]\x20Payment\x20','message','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','webhookLog','PAID','\x20\x20\x20-\x20gatewayPaymentId:\x20','294204nngrwn','checkSinglePaymentById','description','\x20(after\x20','expired','timers','findUnique','created','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','530370TUlqSx','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20checked,\x20','101pBrTMb','paidAt','⏰\x20[GLOBAL]\x20Payment\x20','stopPeriodicStatusCheck','transactionId','\x20individual\x20payment\x20timers','webhookEvents','44gaXEKY','loggerService','getDate','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20status:\x20','\x20updated\x20successfully','EXPIRY_DAYS','auto_expire','\x20seconds\x20(','📊\x20[HOURLY]\x20Payment\x20','payment.pending','\x20in\x20','✅\x20[HOURLY]\x20Payment\x20','log','\x20to\x20clear','paymentDetails','getTime','🪙\x20[GLOBAL]\x20Found\x20','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','coinToPayStatusService','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','has','✅\x20[EXPIRY]\x20Payment\x20','length','currency','CoinToPayStatusService','\x20\x20\x20-\x20paymentId:\x20','text','GLOBAL_CHECK_INTERVAL_MS','getServiceStats','PENDING','\x20to\x20','delay','checkAllPendingPayments','52oJdmRS','\x20\x20\x20-\x20Amount:\x20','6526330hsjNdX','\x20details:','application/json','unknown','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','⚠️\x20[CHECK]\x20Payment\x20','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','13246040hEHToa','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','createdAt','amount','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','🛑\x20[SHUTDOWN]\x20Cleared\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','orderId','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','logShopWebhookError','stringify','Success','bankDetails','🪙\x20CoinToPayStatusService\x20initialized','\x20for\x20payment\x20','./loggerService','findMany','📊\x20[CHECK]\x20Payment\x20','failed','\x20\x20\x20📅\x20Time:\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','get','\x20status\x20unchanged\x20(','⏰\x20[GLOBAL]\x20Found\x20','../config/database','\x20days\x20(created\x20before\x20','\x20status\x20is\x20','\x20\x20\x20📍\x20Source:\x20','✅\x20[CHECK]\x20Payment\x20','now','map','__importDefault','logWhiteDomainError','\x20expired\x20CoinToPay\x20payments','\x20marked\x20as\x20paid\x20at:\x20','forEach',',\x20stopping\x20individual\x20checks','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','-day\x20timeout','floor','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','__esModule','\x20is\x20older\x20than\x20','adminNotes','282lxtBTA','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','catch','sendPaymentStatusNotification',',\x20clearing\x20individual\x20timers','paymentId','globalCheckInterval','paid','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20\x20\x20-\x20GatewayPaymentId:\x20','cointopay_status_check_','logCoinToPayError','201222YetPxs','\x20not\x20found,\x20clearing\x20timers','webhookUrl','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','checkPaymentById','33762rwQRpy','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20days\x20without\x20payment\x20confirmation','🪙\x20[DEBUG]\x20Creating\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','Payment\x20older\x20than\x20','confirmedOn','🧹\x20[DEBUG]\x20Clearing\x20','not\x20confirmed','toFixed','remitterIban','timestamp','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','settings','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','iban','cointopay_status_check_error','Automatically\x20expired\x20after\x20','✅\x20[TIMER]\x20Individual\x20check\x20#'];a37_0x1903=function(){return _0x237be2;};return a37_0x1903();}const a37_0x2f9b1c=a37_0xc615;function a37_0xc615(_0x16dc5b,_0x454ac7){const _0x1903db=a37_0x1903();return a37_0xc615=function(_0xc61522,_0x3d6b37){_0xc61522=_0xc61522-0x1a4;let _0x35cb87=_0x1903db[_0xc61522];return _0x35cb87;},a37_0xc615(_0x16dc5b,_0x454ac7);}(function(_0x4e3489,_0x5e1e03){const _0xc42566=a37_0xc615,_0xf2a818=_0x4e3489();while(!![]){try{const _0x2c42df=-parseInt(_0xc42566(0x201))/0x1*(parseInt(_0xc42566(0x277))/0x2)+-parseInt(_0xc42566(0x1f5))/0x3*(-parseInt(_0xc42566(0x22d))/0x4)+-parseInt(_0xc42566(0x1e4))/0x5+-parseInt(_0xc42566(0x266))/0x6*(parseInt(_0xc42566(0x272))/0x7)+parseInt(_0xc42566(0x239))/0x8+parseInt(_0xc42566(0x1fe))/0x9+-parseInt(_0xc42566(0x22f))/0xa*(-parseInt(_0xc42566(0x208))/0xb);if(_0x2c42df===_0x5e1e03)break;else _0xf2a818['push'](_0xf2a818['shift']());}catch(_0x2ab3ee){_0xf2a818['push'](_0xf2a818['shift']());}}}(a37_0x1903,0xd46d1));var __importDefault=this&&this[a37_0x2f9b1c(0x259)]||function(_0x11c268){const _0x6d3494=a37_0x2f9b1c;return _0x11c268&&_0x11c268[_0x6d3494(0x263)]?_0x11c268:{'default':_0x11c268};};Object['defineProperty'](exports,a37_0x2f9b1c(0x263),{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0x2f9b1c(0x224)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a37_0x2f9b1c(0x252))),telegramBotService_1=require(a37_0x2f9b1c(0x1b5)),loggerService_1=require(a37_0x2f9b1c(0x249));class CoinToPayStatusService{constructor(){const _0x8ee705=a37_0x2f9b1c;this['globalCheckInterval']=null,this[_0x8ee705(0x227)]=0x3c*0x3c*0x3e8,this[_0x8ee705(0x20e)]=0x5,this[_0x8ee705(0x1e5)]=new Map(),this[_0x8ee705(0x1ae)]=new coinToPayService_1[(_0x8ee705(0x28d))](),console[_0x8ee705(0x215)](_0x8ee705(0x247));}[a37_0x2f9b1c(0x1be)](_0x20cdb1,_0x112bc7){const _0x3540a8=a37_0x2f9b1c;console[_0x3540a8(0x215)](_0x3540a8(0x1bf)),console[_0x3540a8(0x215)](_0x3540a8(0x225)+_0x20cdb1),console['log'](_0x3540a8(0x1f4)+_0x112bc7),this[_0x3540a8(0x1a5)](_0x20cdb1);const _0x31a667=[],_0x5afac5=new Date(),_0x2b2907=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x3540a8(0x1c3)},{'delay':0x5*0x3c*0x3e8,'description':_0x3540a8(0x1c3)}];console[_0x3540a8(0x215)](_0x3540a8(0x27b)+_0x2b2907['length']+_0x3540a8(0x1d6)+_0x20cdb1);let _0x37d543=0x0;_0x2b2907[_0x3540a8(0x25d)]((_0x3705f8,_0x10f308)=>{const _0x339517=_0x3540a8;_0x37d543+=_0x3705f8[_0x339517(0x22b)];const _0x442c1a=setTimeout(async()=>{const _0x2dc9c0=_0x339517;console['log'](_0x2dc9c0(0x1a4)+(_0x10f308+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x20cdb1+_0x2dc9c0(0x1f8)+_0x3705f8[_0x2dc9c0(0x1f7)]+')');try{await this['checkSinglePaymentById'](_0x20cdb1),console[_0x2dc9c0(0x215)](_0x2dc9c0(0x28a)+(_0x10f308+0x1)+'\x20completed\x20for\x20payment\x20'+_0x20cdb1);}catch(_0x397d8e){console[_0x2dc9c0(0x28c)](_0x2dc9c0(0x235)+(_0x10f308+0x1)+_0x2dc9c0(0x248)+_0x20cdb1+':',_0x397d8e),this[_0x2dc9c0(0x271)](_0x20cdb1,_0x112bc7,_0x397d8e,_0x2dc9c0(0x1dc),{'checkNumber':_0x10f308+0x1,'scheduledAfter':_0x3705f8[_0x2dc9c0(0x1f7)],'isIndividualCheck':!![]});}},_0x37d543);_0x31a667[_0x339517(0x1b8)](_0x442c1a),console[_0x339517(0x215)](_0x339517(0x1cb)+(_0x10f308+0x1)+_0x339517(0x248)+_0x20cdb1+_0x339517(0x213)+_0x37d543/0x3e8+_0x339517(0x210)+_0x3705f8[_0x339517(0x1f7)]+')');});const _0x5a2ee9=setInterval(async()=>{const _0x1be41b=_0x3540a8;console['log'](_0x1be41b(0x1ff)+_0x20cdb1);try{const _0x46e0ac=await database_1['default'][_0x1be41b(0x1bd)]['findUnique']({'where':{'id':_0x20cdb1},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x46e0ac){console['log'](_0x1be41b(0x1b6)+_0x20cdb1+_0x1be41b(0x273)),this[_0x1be41b(0x1a5)](_0x20cdb1);return;}console[_0x1be41b(0x215)](_0x1be41b(0x211)+_0x20cdb1+'\x20current\x20status:\x20'+_0x46e0ac[_0x1be41b(0x28b)]);if(_0x46e0ac['status']!==_0x1be41b(0x229)){console[_0x1be41b(0x215)](_0x1be41b(0x214)+_0x20cdb1+_0x1be41b(0x254)+_0x46e0ac[_0x1be41b(0x28b)]+_0x1be41b(0x25e)),this[_0x1be41b(0x1a5)](_0x20cdb1);return;}const _0x2a2c21=Math[_0x1be41b(0x261)]((Date['now']()-_0x46e0ac[_0x1be41b(0x23b)][_0x1be41b(0x218)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x2a2c21>=this['EXPIRY_DAYS']){console[_0x1be41b(0x215)]('⏰\x20[HOURLY]\x20Payment\x20'+_0x20cdb1+_0x1be41b(0x264)+this[_0x1be41b(0x20e)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x1be41b(0x1a5)](_0x20cdb1);return;}await this[_0x1be41b(0x1f6)](_0x20cdb1),console[_0x1be41b(0x215)](_0x1be41b(0x21c)+_0x20cdb1);}catch(_0x212e9c){console[_0x1be41b(0x28c)](_0x1be41b(0x1fd)+_0x20cdb1+':',_0x212e9c),this[_0x1be41b(0x271)](_0x20cdb1,_0x112bc7,_0x212e9c,_0x1be41b(0x1dc),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x31a667[_0x3540a8(0x1b8)](_0x5a2ee9),this[_0x3540a8(0x1e5)][_0x3540a8(0x1cd)](_0x20cdb1,{'timers':_0x31a667,'paymentId':_0x20cdb1,'gatewayPaymentId':_0x112bc7,'createdAt':_0x5afac5}),console[_0x3540a8(0x215)](_0x3540a8(0x25f)+_0x2b2907[_0x3540a8(0x222)]+_0x3540a8(0x21b)+_0x20cdb1),console[_0x3540a8(0x215)](_0x3540a8(0x234)+this['paymentTimers']['size']),this[_0x3540a8(0x1db)](_0x20cdb1,_0x112bc7,_0x3540a8(0x229),_0x3540a8(0x229),_0x3540a8(0x1dc),{'action':'schedule_created','scheduledChecks':_0x2b2907[_0x3540a8(0x222)],'firstCheckIn':_0x2b2907[0x0][_0x3540a8(0x22b)]/0x3e8,'totalTimers':this['paymentTimers'][_0x3540a8(0x1ba)]});}[a37_0x2f9b1c(0x1a5)](_0x3ef4ea){const _0x30ac78=a37_0x2f9b1c,_0x38ba2c=this['paymentTimers'][_0x30ac78(0x24f)](_0x3ef4ea);_0x38ba2c?(console['log'](_0x30ac78(0x27f)+_0x38ba2c[_0x30ac78(0x1fa)][_0x30ac78(0x222)]+'\x20timers\x20for\x20payment\x20'+_0x3ef4ea),_0x38ba2c['timers']['forEach']((_0x10e831,_0x51114e)=>{const _0x37afb5=_0x30ac78;_0x10e831&&(clearTimeout(_0x10e831),clearInterval(_0x10e831),console[_0x37afb5(0x215)]('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x51114e+0x1)+_0x37afb5(0x248)+_0x3ef4ea));}),this[_0x30ac78(0x1e5)]['delete'](_0x3ef4ea),console[_0x30ac78(0x215)](_0x30ac78(0x262)+_0x3ef4ea+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x30ac78(0x1e5)][_0x30ac78(0x1ba)])):console[_0x30ac78(0x215)](_0x30ac78(0x233)+_0x3ef4ea+_0x30ac78(0x216));}async[a37_0x2f9b1c(0x1f6)](_0x428624){const _0x166824=a37_0x2f9b1c;console[_0x166824(0x215)](_0x166824(0x27c)+_0x428624);const _0x43ea29=await database_1['default'][_0x166824(0x1bd)]['findUnique']({'where':{'id':_0x428624},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x43ea29){console[_0x166824(0x215)](_0x166824(0x1ef)+_0x428624+_0x166824(0x1c4));return;}console[_0x166824(0x215)](_0x166824(0x24b)+_0x428624+'\x20found:'),console[_0x166824(0x215)]('\x20\x20\x20-\x20Gateway:\x20'+_0x43ea29['gateway']),console[_0x166824(0x215)](_0x166824(0x1d9)+_0x43ea29[_0x166824(0x28b)]),console[_0x166824(0x215)](_0x166824(0x26f)+_0x43ea29['gatewayPaymentId']),console[_0x166824(0x215)](_0x166824(0x22e)+_0x43ea29[_0x166824(0x23c)]+'\x20'+_0x43ea29['currency']),console[_0x166824(0x215)](_0x166824(0x1e1)+_0x43ea29[_0x166824(0x1ed)]);if(_0x43ea29[_0x166824(0x1c9)]!==_0x166824(0x1ec)){console[_0x166824(0x215)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x428624+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x43ea29['gateway']+')');return;}if(_0x43ea29[_0x166824(0x28b)]!==_0x166824(0x229)){console['log'](_0x166824(0x236)+_0x428624+'\x20status\x20is\x20'+_0x43ea29[_0x166824(0x28b)]+_0x166824(0x25e)),this[_0x166824(0x1a5)](_0x428624);return;}if(!_0x43ea29[_0x166824(0x1df)]){console[_0x166824(0x215)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x428624+_0x166824(0x1ac));return;}console[_0x166824(0x215)]('✅\x20[CHECK]\x20Payment\x20'+_0x428624+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this['checkSinglePayment'](_0x43ea29);}[a37_0x2f9b1c(0x1db)](_0x471ffa,_0x5af29c,_0x511cd8,_0x3fcf60,_0x2e5c68,_0x1788bb){const _0x23aa3b=a37_0x2f9b1c,_0x580ac0={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x471ffa,'gatewayPaymentId':_0x5af29c,'oldStatus':_0x511cd8,'newStatus':_0x3fcf60,'source':_0x2e5c68,'timestamp':new Date()[_0x23aa3b(0x1bb)](),'details':_0x1788bb||{}};loggerService_1['loggerService'][_0x23aa3b(0x1db)](_0x580ac0),console[_0x23aa3b(0x215)](_0x23aa3b(0x238)+_0x471ffa+'\x20('+_0x5af29c+')'),console[_0x23aa3b(0x215)]('\x20\x20\x20📊\x20Status:\x20'+_0x511cd8+'\x20->\x20'+_0x3fcf60),console[_0x23aa3b(0x215)]('\x20\x20\x20📍\x20Source:\x20'+_0x2e5c68),console[_0x23aa3b(0x215)]('\x20\x20\x20📅\x20Time:\x20'+_0x580ac0[_0x23aa3b(0x283)]),_0x1788bb&&console[_0x23aa3b(0x215)]('\x20\x20\x20📝\x20Details:',_0x1788bb);}['logCoinToPayError'](_0x130752,_0x22c7a8,_0x291d47,_0x1e50b5,_0x4cbf32){const _0x5e0753=a37_0x2f9b1c,_0x59ce29={'type':_0x5e0753(0x1d7),'paymentId':_0x130752,'gatewayPaymentId':_0x22c7a8,'error':_0x291d47 instanceof Error?{'message':_0x291d47['message'],'stack':_0x291d47[_0x5e0753(0x1ee)]}:_0x291d47,'source':_0x1e50b5,'timestamp':new Date()[_0x5e0753(0x1bb)](),'context':_0x4cbf32||{}};loggerService_1[_0x5e0753(0x209)][_0x5e0753(0x271)](_0x59ce29),console[_0x5e0753(0x28c)](_0x5e0753(0x275)+_0x130752+'\x20('+_0x22c7a8+')'),console[_0x5e0753(0x28c)](_0x5e0753(0x1b1)+(_0x291d47 instanceof Error?_0x291d47[_0x5e0753(0x1f0)]:_0x291d47)),console[_0x5e0753(0x28c)](_0x5e0753(0x255)+_0x1e50b5),console['error'](_0x5e0753(0x24d)+_0x59ce29['timestamp']),_0x4cbf32&&console[_0x5e0753(0x28c)](_0x5e0753(0x1ce),_0x4cbf32);}[a37_0x2f9b1c(0x1b2)](){const _0x4df1a9=a37_0x2f9b1c;console[_0x4df1a9(0x215)](_0x4df1a9(0x1ab)),this['checkAllPendingPayments']()[_0x4df1a9(0x268)](_0x5d1460=>{const _0x2abbc2=_0x4df1a9;console[_0x2abbc2(0x28c)](_0x2abbc2(0x284),_0x5d1460);}),this[_0x4df1a9(0x26c)]=setInterval(async()=>{const _0x18ab13=_0x4df1a9;try{console['log']('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x18ab13(0x22c)](),console['log'](_0x18ab13(0x1dd));}catch(_0x4b17ac){console[_0x18ab13(0x28c)](_0x18ab13(0x242),_0x4b17ac);}},this[_0x4df1a9(0x227)]),console[_0x4df1a9(0x215)](_0x4df1a9(0x237));}[a37_0x2f9b1c(0x204)](){const _0x58d723=a37_0x2f9b1c;console[_0x58d723(0x215)](_0x58d723(0x240));this['globalCheckInterval']&&(clearInterval(this[_0x58d723(0x26c)]),this['globalCheckInterval']=null,console[_0x58d723(0x215)](_0x58d723(0x278)));const _0x5511ca=this[_0x58d723(0x1e5)][_0x58d723(0x1ba)];for(const [_0x8a5dfd]of this[_0x58d723(0x1e5)]){this[_0x58d723(0x1a5)](_0x8a5dfd);}console['log'](_0x58d723(0x23f)+_0x5511ca+_0x58d723(0x206));}async['checkAllPendingPayments'](){const _0x429e46=a37_0x2f9b1c;try{console[_0x429e46(0x215)](_0x429e46(0x24e));const _0x583bdf=await database_1[_0x429e46(0x1d2)]['payment'][_0x429e46(0x24a)]({'where':{'gateway':_0x429e46(0x1ec),'status':_0x429e46(0x229),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x429e46(0x219)+_0x583bdf[_0x429e46(0x222)]+_0x429e46(0x1e6));if(_0x583bdf['length']===0x0){console[_0x429e46(0x215)](_0x429e46(0x23e));return;}const _0x24320e=await this['checkExpiredPayments'](_0x583bdf);console['log'](_0x429e46(0x251)+_0x24320e[_0x429e46(0x222)]+_0x429e46(0x25b));let _0x5300ea=0x0,_0xbba120=0x0;for(const _0x112ace of _0x583bdf){try{if(_0x24320e[_0x429e46(0x1c1)](_0x112ace['id'])){console[_0x429e46(0x215)](_0x429e46(0x203)+_0x112ace['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0xbba120++;continue;}if(this[_0x429e46(0x1e5)][_0x429e46(0x220)](_0x112ace['id'])){console[_0x429e46(0x215)](_0x429e46(0x203)+_0x112ace['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0xbba120++;continue;}const _0x1426ae=(Date[_0x429e46(0x257)]()-_0x112ace['createdAt'][_0x429e46(0x218)]())/(0x3e8*0x3c*0x3c);if(_0x1426ae<0x1){console[_0x429e46(0x215)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x112ace['id']+_0x429e46(0x1ad)+_0x1426ae[_0x429e46(0x281)](0x1)+_0x429e46(0x1c6)),_0xbba120++;continue;}console[_0x429e46(0x215)](_0x429e46(0x23d)+_0x112ace['id']+_0x429e46(0x1e7)+_0x1426ae[_0x429e46(0x281)](0x1)+'h)'),await this['checkSinglePayment'](_0x112ace),_0x5300ea++,await new Promise(_0x59a4f6=>setTimeout(_0x59a4f6,0x7d0));}catch(_0x4e7a8e){console[_0x429e46(0x28c)](_0x429e46(0x1cc)+_0x112ace['id']+':',_0x4e7a8e),this['logCoinToPayError'](_0x112ace['id'],_0x112ace[_0x429e46(0x1df)]||_0x429e46(0x232),_0x4e7a8e,_0x429e46(0x1dc),{'isGlobalCheck':!![],'paymentAmount':_0x112ace['amount'],'paymentCurrency':_0x112ace[_0x429e46(0x223)],'shopId':_0x112ace[_0x429e46(0x1ed)],'createdAt':_0x112ace[_0x429e46(0x23b)]}),loggerService_1[_0x429e46(0x209)][_0x429e46(0x25a)](_0x429e46(0x1ec),_0x429e46(0x1c5)+_0x112ace[_0x429e46(0x1df)],_0x4e7a8e);}}console[_0x429e46(0x215)](_0x429e46(0x23a)+_0x5300ea+_0x429e46(0x200)+_0xbba120+_0x429e46(0x1b3)+_0x24320e[_0x429e46(0x222)]+_0x429e46(0x1a9));}catch(_0x25928c){console[_0x429e46(0x28c)](_0x429e46(0x1a6),_0x25928c);}}async['checkExpiredPayments'](_0x42c612){const _0x236500=a37_0x2f9b1c,_0x2ade03=[],_0x444f6d=new Date();_0x444f6d[_0x236500(0x1b4)](_0x444f6d[_0x236500(0x20a)]()-this['EXPIRY_DAYS']),console[_0x236500(0x215)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x236500(0x20e)]+_0x236500(0x253)+_0x444f6d[_0x236500(0x1bb)]()+')');for(const _0x483e35 of _0x42c612){if(_0x483e35['createdAt']<_0x444f6d){console[_0x236500(0x215)](_0x236500(0x1a8)+_0x483e35['id']+_0x236500(0x264)+this['EXPIRY_DAYS']+_0x236500(0x1e0));try{this[_0x236500(0x1db)](_0x483e35['id'],_0x483e35[_0x236500(0x1df)]||_0x236500(0x232),_0x236500(0x229),_0x236500(0x1e3),_0x236500(0x20f),{'reason':_0x236500(0x27d)+this[_0x236500(0x20e)]+'\x20days','createdAt':_0x483e35['createdAt'],'daysSinceCreation':Math[_0x236500(0x261)]((Date[_0x236500(0x257)]()-_0x483e35[_0x236500(0x23b)][_0x236500(0x218)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x483e35[_0x236500(0x23c)],'paymentCurrency':_0x483e35[_0x236500(0x223)],'shopId':_0x483e35[_0x236500(0x1ed)]}),await database_1[_0x236500(0x1d2)][_0x236500(0x1bd)][_0x236500(0x1d4)]({'where':{'id':_0x483e35['id']},'data':{'status':_0x236500(0x1e3),'updatedAt':new Date(),'adminNotes':_0x236500(0x289)+this[_0x236500(0x20e)]+_0x236500(0x27a)}}),await database_1[_0x236500(0x1d2)][_0x236500(0x1f2)][_0x236500(0x1cf)]({'data':{'paymentId':_0x483e35['id'],'shopId':_0x483e35[_0x236500(0x1ed)],'event':_0x236500(0x1bc),'statusCode':0xc8,'responseBody':JSON[_0x236500(0x244)]({'reason':_0x236500(0x27d)+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x483e35[_0x236500(0x23b)],'expiredAt':new Date()[_0x236500(0x1bb)](),'daysSinceCreation':Math[_0x236500(0x261)]((Date[_0x236500(0x257)]()-_0x483e35[_0x236500(0x23b)][_0x236500(0x218)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x236500(0x1a7)](_0x483e35,'EXPIRED'),await this[_0x236500(0x269)](_0x483e35,'EXPIRED'),this[_0x236500(0x1a5)](_0x483e35['id']),_0x2ade03[_0x236500(0x1b8)](_0x483e35['id']),console[_0x236500(0x215)](_0x236500(0x221)+_0x483e35['id']+_0x236500(0x1f1)+this[_0x236500(0x20e)]+_0x236500(0x260));}catch(_0x26548f){console['error']('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x483e35['id']+':',_0x26548f),this['logCoinToPayError'](_0x483e35['id'],_0x483e35[_0x236500(0x1df)]||_0x236500(0x232),_0x26548f,_0x236500(0x20f),{'reason':_0x236500(0x20b),'createdAt':_0x483e35[_0x236500(0x23b)],'daysSinceCreation':Math[_0x236500(0x261)]((Date[_0x236500(0x257)]()-_0x483e35[_0x236500(0x23b)][_0x236500(0x218)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x2ade03;}async['checkSinglePayment'](_0x1d2a1e){const _0x2feaab=a37_0x2f9b1c;if(!_0x1d2a1e[_0x2feaab(0x1df)]){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x1d2a1e['id']+_0x2feaab(0x1eb));return;}console[_0x2feaab(0x215)](_0x2feaab(0x21a)+_0x1d2a1e['id']+'\x20('+_0x1d2a1e[_0x2feaab(0x1df)]+')');try{const _0x2b4d1d=await this[_0x2feaab(0x1ae)]['checkPaymentStatus'](_0x1d2a1e[_0x2feaab(0x1df)]);console[_0x2feaab(0x215)]('📊\x20[CHECK]\x20Payment\x20'+_0x1d2a1e['id']+_0x2feaab(0x20c)+_0x2b4d1d[_0x2feaab(0x28b)]);_0x2b4d1d[_0x2feaab(0x217)]&&console[_0x2feaab(0x215)]('📊\x20[CHECK]\x20Payment\x20'+_0x1d2a1e['id']+_0x2feaab(0x230),{'iban':_0x2b4d1d[_0x2feaab(0x217)][_0x2feaab(0x287)]||'not\x20found','transactionId':_0x2b4d1d[_0x2feaab(0x217)][_0x2feaab(0x205)],'createdOn':_0x2b4d1d[_0x2feaab(0x217)]['createdOn'],'confirmedOn':_0x2b4d1d[_0x2feaab(0x217)]['confirmedOn']||_0x2feaab(0x280)});if(_0x2b4d1d['status']!==_0x1d2a1e[_0x2feaab(0x28b)]){console[_0x2feaab(0x215)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x1d2a1e['id']+_0x2feaab(0x1e2)+_0x1d2a1e[_0x2feaab(0x28b)]+_0x2feaab(0x22a)+_0x2b4d1d['status']),this['logCoinToPayStatus'](_0x1d2a1e['id'],_0x1d2a1e[_0x2feaab(0x1df)],_0x1d2a1e[_0x2feaab(0x28b)],_0x2b4d1d[_0x2feaab(0x28b)],_0x2feaab(0x1dc),{'paymentDetails':_0x2b4d1d[_0x2feaab(0x217)],'amount':_0x2b4d1d[_0x2feaab(0x23c)],'currency':_0x2b4d1d[_0x2feaab(0x223)],'shopId':_0x1d2a1e[_0x2feaab(0x1ed)],'checkTimestamp':new Date()['toISOString']()});const _0x5de8d9={'status':_0x2b4d1d['status'],'updatedAt':new Date()};_0x2b4d1d[_0x2feaab(0x28b)]==='PAID'&&_0x1d2a1e['status']!==_0x2feaab(0x1f3)&&(_0x5de8d9[_0x2feaab(0x202)]=new Date(),console[_0x2feaab(0x215)](_0x2feaab(0x1e8)+_0x1d2a1e['id']+_0x2feaab(0x25c)+_0x5de8d9[_0x2feaab(0x202)][_0x2feaab(0x1bb)]()));if(_0x2b4d1d['paymentDetails']){const _0x5274cf=_0x2b4d1d[_0x2feaab(0x217)];_0x5274cf[_0x2feaab(0x287)]&&(_0x5de8d9[_0x2feaab(0x282)]=_0x5274cf[_0x2feaab(0x287)],console[_0x2feaab(0x215)](_0x2feaab(0x286)+_0x5274cf[_0x2feaab(0x287)]));if(_0x5274cf[_0x2feaab(0x246)]){const _0x835e7e=_0x1d2a1e['adminNotes']||'',_0x54ca3d='Bank\x20Details:\x20'+_0x5274cf[_0x2feaab(0x246)];_0x5de8d9[_0x2feaab(0x265)]=_0x835e7e?_0x835e7e+'\x0a\x0a'+_0x54ca3d:_0x54ca3d,console['log'](_0x2feaab(0x1c2));}_0x5274cf[_0x2feaab(0x205)]&&console['log'](_0x2feaab(0x1aa)+_0x5274cf[_0x2feaab(0x205)]),_0x5274cf[_0x2feaab(0x27e)]&&console[_0x2feaab(0x215)](_0x2feaab(0x21d)+_0x5274cf[_0x2feaab(0x27e)]);}await database_1['default']['payment'][_0x2feaab(0x1d4)]({'where':{'id':_0x1d2a1e['id']},'data':_0x5de8d9}),await database_1[_0x2feaab(0x1d2)][_0x2feaab(0x1f2)][_0x2feaab(0x1cf)]({'data':{'paymentId':_0x1d2a1e['id'],'shopId':_0x1d2a1e['shopId'],'event':_0x2feaab(0x270)+_0x2b4d1d[_0x2feaab(0x28b)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1d2a1e[_0x2feaab(0x28b)],'newStatus':_0x2b4d1d['status'],'paymentDetails':_0x2b4d1d['paymentDetails'],'checkedAt':new Date()[_0x2feaab(0x1bb)]()})}}),await this[_0x2feaab(0x1a7)](_0x1d2a1e,_0x2b4d1d[_0x2feaab(0x28b)]),await this[_0x2feaab(0x269)](_0x1d2a1e,_0x2b4d1d[_0x2feaab(0x28b)]),_0x2b4d1d['status']!=='PENDING'&&(console[_0x2feaab(0x215)]('🧹\x20[CHECK]\x20Payment\x20'+_0x1d2a1e['id']+_0x2feaab(0x1c7)+_0x2b4d1d[_0x2feaab(0x28b)]+_0x2feaab(0x26a)),this[_0x2feaab(0x1a5)](_0x1d2a1e['id'])),console['log'](_0x2feaab(0x256)+_0x1d2a1e['id']+_0x2feaab(0x20d));}else console[_0x2feaab(0x215)](_0x2feaab(0x24b)+_0x1d2a1e['id']+_0x2feaab(0x250)+_0x2b4d1d[_0x2feaab(0x28b)]+')'),this[_0x2feaab(0x1db)](_0x1d2a1e['id'],_0x1d2a1e[_0x2feaab(0x1df)],_0x1d2a1e[_0x2feaab(0x28b)],_0x2b4d1d[_0x2feaab(0x28b)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x2b4d1d['paymentDetails'],'amount':_0x2b4d1d[_0x2feaab(0x23c)],'currency':_0x2b4d1d[_0x2feaab(0x223)],'shopId':_0x1d2a1e['shopId'],'checkTimestamp':new Date()['toISOString']()});}catch(_0x1db85c){console['error']('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x1d2a1e['id']+':',_0x1db85c),this[_0x2feaab(0x271)](_0x1d2a1e['id'],_0x1d2a1e[_0x2feaab(0x1df)],_0x1db85c,'status_check',{'paymentAmount':_0x1d2a1e['amount'],'paymentCurrency':_0x1d2a1e[_0x2feaab(0x223)],'shopId':_0x1d2a1e[_0x2feaab(0x1ed)],'createdAt':_0x1d2a1e[_0x2feaab(0x23b)]}),await database_1[_0x2feaab(0x1d2)]['webhookLog']['create']({'data':{'paymentId':_0x1d2a1e['id'],'shopId':_0x1d2a1e[_0x2feaab(0x1ed)],'event':_0x2feaab(0x288),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x1db85c instanceof Error?_0x1db85c[_0x2feaab(0x1f0)]:_0x2feaab(0x1d1),'gatewayPaymentId':_0x1d2a1e['gatewayPaymentId'],'checkedAt':new Date()[_0x2feaab(0x1bb)]()})}});}}async['sendShopWebhook'](_0x9342f8,_0x1e35e9){const _0x5da96b=a37_0x2f9b1c,_0x1e89c7=Date['now']();try{const _0x37f7a7=_0x9342f8[_0x5da96b(0x1b0)],_0x3688b7=_0x37f7a7[_0x5da96b(0x285)];if(!_0x3688b7?.[_0x5da96b(0x274)]){console[_0x5da96b(0x215)](_0x5da96b(0x1d5)+_0x37f7a7['id']);return;}const _0x31d303=_0x1e35e9===_0x5da96b(0x1f3)?'payment.success':_0x1e35e9==='FAILED'?_0x5da96b(0x1c8):_0x1e35e9===_0x5da96b(0x1e3)?_0x5da96b(0x1c8):_0x5da96b(0x212);if(!_0x3688b7[_0x5da96b(0x207)]?.[_0x5da96b(0x1c1)](_0x31d303)){console[_0x5da96b(0x215)]('Webhook\x20event\x20'+_0x31d303+_0x5da96b(0x1d0)+_0x37f7a7['id']);return;}const _0x17262c={'event':_0x31d303,'payment':{'id':_0x9342f8['id'],'order_id':_0x9342f8[_0x5da96b(0x241)],'gateway_order_id':_0x9342f8[_0x5da96b(0x1da)],'gateway':_0x5da96b(0x1ca),'amount':_0x9342f8['amount'],'currency':_0x9342f8[_0x5da96b(0x223)],'status':_0x1e35e9[_0x5da96b(0x1c0)](),'customer_email':_0x9342f8[_0x5da96b(0x1b7)],'customer_name':_0x9342f8[_0x5da96b(0x1ea)],'created_at':_0x9342f8['createdAt'],'updated_at':new Date()}},_0x168d04=await fetch(_0x3688b7[_0x5da96b(0x274)],{'method':_0x5da96b(0x1b9),'headers':{'Content-Type':_0x5da96b(0x231),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x5da96b(0x244)](_0x17262c)}),_0x2a216d=Date['now']()-_0x1e89c7,_0x21cdcb=_0x168d04['ok']?_0x5da96b(0x245):await _0x168d04[_0x5da96b(0x226)]();loggerService_1[_0x5da96b(0x209)]['logShopWebhookSent'](_0x9342f8[_0x5da96b(0x1ed)],_0x3688b7[_0x5da96b(0x274)],_0x31d303,_0x168d04[_0x5da96b(0x28b)],_0x2a216d,_0x17262c),console['log']('Shop\x20webhook\x20sent\x20to\x20'+_0x3688b7['webhookUrl']+_0x5da96b(0x1e9)+_0x168d04['status']+'\x20('+_0x2a216d+'ms)');}catch(_0xa29391){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0xa29391),loggerService_1['loggerService'][_0x5da96b(0x243)](_0x9342f8[_0x5da96b(0x1ed)],_0x9342f8[_0x5da96b(0x1b0)]?.[_0x5da96b(0x285)]?.[_0x5da96b(0x274)]||_0x5da96b(0x232),'webhook_send',_0xa29391,{});}}async[a37_0x2f9b1c(0x269)](_0x1d9372,_0x1ac5c4){const _0x5eeacb=a37_0x2f9b1c;try{const _0x3f4822={'PENDING':_0x5eeacb(0x1fc),'PAID':_0x5eeacb(0x26d),'FAILED':_0x5eeacb(0x24c),'EXPIRED':_0x5eeacb(0x1f9)},_0x43e6fa=_0x3f4822[_0x1ac5c4];if(!_0x43e6fa||_0x43e6fa===_0x5eeacb(0x1fc))return;await telegramBotService_1[_0x5eeacb(0x1d3)][_0x5eeacb(0x1af)](_0x1d9372['shopId'],_0x1d9372,_0x43e6fa);}catch(_0x1f4273){console[_0x5eeacb(0x28c)](_0x5eeacb(0x267),_0x1f4273);}}async[a37_0x2f9b1c(0x276)](_0x59788f){const _0x6d00ea=a37_0x2f9b1c;console[_0x6d00ea(0x215)](_0x6d00ea(0x279)+_0x59788f);const _0x447bf0=await database_1[_0x6d00ea(0x1d2)]['payment'][_0x6d00ea(0x1fb)]({'where':{'id':_0x59788f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x447bf0)throw new Error('Payment\x20not\x20found');if(_0x447bf0[_0x6d00ea(0x1c9)]!==_0x6d00ea(0x1ec))throw new Error(_0x6d00ea(0x26e));console[_0x6d00ea(0x215)](_0x6d00ea(0x21f)+_0x59788f),await this['checkSinglePayment'](_0x447bf0),console[_0x6d00ea(0x215)]('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x59788f);}[a37_0x2f9b1c(0x228)](){const _0x2a504e=a37_0x2f9b1c,_0x1916d1=this[_0x2a504e(0x26c)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x122067=Array[_0x2a504e(0x1de)](this[_0x2a504e(0x1e5)][_0x2a504e(0x1d8)]())[_0x2a504e(0x258)](_0x531ecd=>({'paymentId':_0x531ecd[_0x2a504e(0x26b)],'gatewayPaymentId':_0x531ecd[_0x2a504e(0x1df)],'createdAt':_0x531ecd[_0x2a504e(0x23b)],'timersCount':_0x531ecd[_0x2a504e(0x1fa)][_0x2a504e(0x222)]}));return{'isActive':!!this[_0x2a504e(0x26c)],'globalCheckIntervalMinutes':this[_0x2a504e(0x227)]/(0x3e8*0x3c),'expiryDays':this[_0x2a504e(0x20e)],'activeIndividualTimers':this[_0x2a504e(0x1e5)][_0x2a504e(0x1ba)],'nextGlobalCheckIn':_0x1916d1,'paymentTimersDetails':_0x122067};}['getPaymentTimerInfo'](_0x1eec2f){const _0x2a1e55=a37_0x2f9b1c,_0x1acd24=this['paymentTimers'][_0x2a1e55(0x24f)](_0x1eec2f);if(_0x1acd24)return{'hasTimers':!![],'timersCount':_0x1acd24[_0x2a1e55(0x1fa)][_0x2a1e55(0x222)],'createdAt':_0x1acd24['createdAt'],'gatewayPaymentId':_0x1acd24['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a37_0x2f9b1c(0x224)]=CoinToPayStatusService,exports[a37_0x2f9b1c(0x21e)]=new CoinToPayStatusService();