'use strict';const a37_0x2bb313=a37_0x59bc;(function(_0x14c06d,_0x263b39){const _0x3628fd=a37_0x59bc,_0x180ab4=_0x14c06d();while(!![]){try{const _0x3ba4f7=parseInt(_0x3628fd(0x24c))/0x1+parseInt(_0x3628fd(0x27f))/0x2+parseInt(_0x3628fd(0x215))/0x3*(parseInt(_0x3628fd(0x253))/0x4)+-parseInt(_0x3628fd(0x27d))/0x5+parseInt(_0x3628fd(0x1cc))/0x6*(-parseInt(_0x3628fd(0x209))/0x7)+-parseInt(_0x3628fd(0x256))/0x8+parseInt(_0x3628fd(0x25b))/0x9;if(_0x3ba4f7===_0x263b39)break;else _0x180ab4['push'](_0x180ab4['shift']());}catch(_0x37eb66){_0x180ab4['push'](_0x180ab4['shift']());}}}(a37_0x4563,0xcd13d));function a37_0x4563(){const _0x454e9c=['\x20->\x20','webhookLog','\x20with\x20status\x20','\x20seconds\x20(','ü™ô\x20[GLOBAL]\x20Found\x20','CoinToPayStatusService','\x20not\x20found\x20in\x20database','\x20to\x20clear','createdOn','globalCheckInterval','findMany','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','size','4801930naLOjt','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','555348mpmcey','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','1\x20minute','loggerService','payment.failed','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20expired','\x20is\x20too\x20new\x20(','Automatically\x20expired\x20after\x20','logShopWebhookError','EXPIRED','shopId','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','adminNotes','\x20days\x20(created\x20before\x20','toFixed','logWhiteDomainError','\x20\x20\x20-\x20ShopId:\x20','\x20is\x20older\x20than\x20','setDate','getPaymentTimerInfo','paymentDetails','gatewayOrderId','\x20\x20\x20-\x20paymentId:\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20\x20\x20-\x20Gateway:\x20','gateway','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','paid','sendPaymentStatusNotification','\x20\x20\x20üìä\x20Status:\x20','\x20\x20\x20üìç\x20Source:\x20','set','‚úÖ\x20[HOURLY]\x20Payment\x20','auto_expire','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','status','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','paymentTimers','getServiceStats','checkSinglePaymentById','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','shop','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','clearPaymentTimers','push','iban','remitterIban','\x20completed\x20for\x20payment\x20','failed','toISOString','schedulePaymentChecks','defineProperty','values','checkPaymentStatus','\x20initial\x20timers\x20for\x20payment\x20','sendPaymentNotification','Success','738zBCmUk','FAILED','Unknown\x20error','‚è∞\x20[GLOBAL]\x20Payment\x20','‚ùå\x20[CHECK]\x20Payment\x20','\x20to\x20','\x20\x20\x20‚ùå\x20Error:\x20','checkSinglePayment','sendShopWebhook','üßπ\x20[DEBUG]\x20Clearing\x20','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','cointopay_status_check_error','now','status_check','\x20not\x20found,\x20clearing\x20timers','üìä\x20[HOURLY]\x20Payment\x20','GLOBAL_CHECK_INTERVAL_MS','orderId','message','üìä\x20[CHECK]\x20Payment\x20','\x20status\x20from\x20','\x20\x20\x20üìù\x20Details:','EXPIRY_DAYS','map','‚è∞\x20[HOURLY]\x20Payment\x20','\x20status\x20changed\x20to\x20','PENDING','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','findUnique','includes','gatewayPaymentId','\x20days\x20without\x20payment\x20confirmation','./gateways/coinToPayService','Failed\x20to\x20send\x20shop\x20webhook:','\x20expired\x20CoinToPay\x20payments','__esModule','\x20pending\x20CoinToPay\x20payments','\x20found:','payment','PAID','cointopay_auto_expired',',\x20stopping\x20individual\x20checks','\x20status:\x20','timestamp','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20status\x20is\x20','bankDetails','\x20\x20\x20üìÖ\x20Time:\x20','text','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','logShopWebhookSent','floor','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','telegramBotService','getDate','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','currency','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','5\x20minutes','\x20\x20\x20-\x20Status:\x20','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','11767tmbcmM','schedule_created','Webhook\x20event\x20','webhook_send','getTime','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','amount','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','startPeriodicStatusCheck','log','‚è∞\x20[GLOBAL]\x20Found\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','2049CtcXGc','‚úÖ\x20[EXPIRY]\x20Payment\x20','\x20(after\x20','__importDefault','\x20marked\x20as\x20paid\x20at:\x20','confirmedOn','\x20individual\x20payment\x20timers','cointopay','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','description','\x20details:','Shop\x20webhook\x20sent\x20to\x20','transactionId','create','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','update','logCoinToPayStatus','Bank\x20Details:\x20','timers','stringify','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','logCoinToPayError','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','customerName','\x20for\x20payment\x20','CoinToPayService','\x20has\x20no\x20gatewayPaymentId','\x20days','default','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','expired','unknown','createdAt','üí∞\x20[CHECK]\x20Payment\x20','/status/','\x20checked,\x20','delete','get','\x20triggered\x20for\x20payment\x20','coinToPayStatusService','delay','\x20current\x20status:\x20','checkPaymentById','\x20status\x20unchanged\x20(','TesSoft\x20Payment\x20System/1.0','POST','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','error','length','payment.success','created','\x20updated\x20successfully','stopPeriodicStatusCheck','895698peAUiS','paidAt','\x20\x20\x20-\x20GatewayPaymentId:\x20','toLowerCase','not\x20found','cointopay_status_check_','../config/database','1192lnMcnZ','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','webhookEvents','3784880WzoAGC','COINTOPAY_ERROR','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','checkExpiredPayments','9930150RZcPBN','webhookUrl','checkAllPendingPayments','\x20\x20\x20-\x20Amount:\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','.\x20Remaining\x20active\x20timers:\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','paymentId','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','./loggerService','Payment\x20older\x20than\x20','ü™ô\x20CoinToPayStatusService\x20initialized','0100','\x20\x20\x20-\x20gatewayPaymentId:\x20','\x20in\x20','\x20\x20\x20üìù\x20Context:','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','üõë\x20[SHUTDOWN]\x20Cleared\x20','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','not\x20confirmed'];a37_0x4563=function(){return _0x454e9c;};return a37_0x4563();}function a37_0x59bc(_0x1a8020,_0x157de9){const _0x45633e=a37_0x4563();return a37_0x59bc=function(_0x59bc91,_0x53b651){_0x59bc91=_0x59bc91-0x19c;let _0x5f4800=_0x45633e[_0x59bc91];return _0x5f4800;},a37_0x59bc(_0x1a8020,_0x157de9);}var __importDefault=this&&this[a37_0x2bb313(0x218)]||function(_0xcb6e70){const _0x2e5b84=a37_0x2bb313;return _0xcb6e70&&_0xcb6e70[_0x2e5b84(0x1ef)]?_0xcb6e70:{'default':_0xcb6e70};};Object[a37_0x2bb313(0x1c6)](exports,a37_0x2bb313(0x1ef),{'value':!![]}),exports[a37_0x2bb313(0x23e)]=exports[a37_0x2bb313(0x275)]=void 0x0;const coinToPayService_1=require(a37_0x2bb313(0x1ec)),database_1=__importDefault(require(a37_0x2bb313(0x252))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a37_0x2bb313(0x264));class CoinToPayStatusService{constructor(){const _0x15963e=a37_0x2bb313;this[_0x15963e(0x279)]=null,this[_0x15963e(0x1dc)]=0x3c*0x3c*0x3e8,this[_0x15963e(0x1e2)]=0x5,this[_0x15963e(0x1b8)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x15963e(0x22f))](),console[_0x15963e(0x212)](_0x15963e(0x266));}[a37_0x2bb313(0x1c5)](_0x162fa8,_0x4e18eb){const _0x1cb43a=a37_0x2bb313;console[_0x1cb43a(0x212)](_0x1cb43a(0x21d)),console['log'](_0x1cb43a(0x1a9)+_0x162fa8),console[_0x1cb43a(0x212)](_0x1cb43a(0x268)+_0x4e18eb),this['clearPaymentTimers'](_0x162fa8);const _0x1dba8d=[],_0x59eaa6=new Date(),_0x5cad9d=[{'delay':0x1*0x3c*0x3e8,'description':_0x1cb43a(0x281)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x1cb43a(0x206)},{'delay':0x5*0x3c*0x3e8,'description':_0x1cb43a(0x206)}];console[_0x1cb43a(0x212)]('ü™ô\x20[DEBUG]\x20Creating\x20'+_0x5cad9d['length']+_0x1cb43a(0x1c9)+_0x162fa8);let _0x2a4f11=0x0;_0x5cad9d['forEach']((_0x571030,_0x177c8f)=>{const _0x1c0c76=_0x1cb43a;_0x2a4f11+=_0x571030[_0x1c0c76(0x23f)];const _0x18b0ed=setTimeout(async()=>{const _0x1c4e96=_0x1c0c76;console[_0x1c4e96(0x212)]('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x177c8f+0x1)+_0x1c4e96(0x23d)+_0x162fa8+_0x1c4e96(0x217)+_0x571030[_0x1c4e96(0x21e)]+')');try{await this[_0x1c4e96(0x1ba)](_0x162fa8),console[_0x1c4e96(0x212)](_0x1c4e96(0x27e)+(_0x177c8f+0x1)+_0x1c4e96(0x1c2)+_0x162fa8);}catch(_0x5ea1c0){console['error']('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x177c8f+0x1)+_0x1c4e96(0x22e)+_0x162fa8+':',_0x5ea1c0),this[_0x1c4e96(0x22a)](_0x162fa8,_0x4e18eb,_0x5ea1c0,_0x1c4e96(0x1d9),{'checkNumber':_0x177c8f+0x1,'scheduledAfter':_0x571030['description'],'isIndividualCheck':!![]});}},_0x2a4f11);_0x1dba8d[_0x1c0c76(0x1bf)](_0x18b0ed),console[_0x1c0c76(0x212)](_0x1c0c76(0x22c)+(_0x177c8f+0x1)+_0x1c0c76(0x22e)+_0x162fa8+_0x1c0c76(0x269)+_0x2a4f11/0x3e8+_0x1c0c76(0x273)+_0x571030[_0x1c0c76(0x21e)]+')');});const _0x5cba4f=setInterval(async()=>{const _0x5a7d0b=_0x1cb43a;console['log'](_0x5a7d0b(0x280)+_0x162fa8);try{const _0x52f0ad=await database_1['default']['payment'][_0x5a7d0b(0x1e8)]({'where':{'id':_0x162fa8},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x52f0ad){console[_0x5a7d0b(0x212)]('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x162fa8+_0x5a7d0b(0x1da)),this['clearPaymentTimers'](_0x162fa8);return;}console[_0x5a7d0b(0x212)](_0x5a7d0b(0x1db)+_0x162fa8+_0x5a7d0b(0x240)+_0x52f0ad[_0x5a7d0b(0x1b6)]);if(_0x52f0ad[_0x5a7d0b(0x1b6)]!==_0x5a7d0b(0x1e6)){console[_0x5a7d0b(0x212)](_0x5a7d0b(0x1b3)+_0x162fa8+_0x5a7d0b(0x1f9)+_0x52f0ad[_0x5a7d0b(0x1b6)]+_0x5a7d0b(0x1f5)),this[_0x5a7d0b(0x1be)](_0x162fa8);return;}const _0x1fa817=Math[_0x5a7d0b(0x1ff)]((Date[_0x5a7d0b(0x1d8)]()-_0x52f0ad[_0x5a7d0b(0x237)][_0x5a7d0b(0x20d)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1fa817>=this[_0x5a7d0b(0x1e2)]){console[_0x5a7d0b(0x212)](_0x5a7d0b(0x1e4)+_0x162fa8+'\x20is\x20older\x20than\x20'+this[_0x5a7d0b(0x1e2)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this['clearPaymentTimers'](_0x162fa8);return;}await this[_0x5a7d0b(0x1ba)](_0x162fa8),console[_0x5a7d0b(0x212)]('‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x162fa8);}catch(_0x523ad4){console[_0x5a7d0b(0x246)]('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x162fa8+':',_0x523ad4),this[_0x5a7d0b(0x22a)](_0x162fa8,_0x4e18eb,_0x523ad4,_0x5a7d0b(0x1d9),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x1dba8d['push'](_0x5cba4f),this[_0x1cb43a(0x1b8)][_0x1cb43a(0x1b2)](_0x162fa8,{'timers':_0x1dba8d,'paymentId':_0x162fa8,'gatewayPaymentId':_0x4e18eb,'createdAt':_0x59eaa6}),console['log'](_0x1cb43a(0x26e)+_0x5cad9d[_0x1cb43a(0x247)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x162fa8),console[_0x1cb43a(0x212)](_0x1cb43a(0x1fd)+this[_0x1cb43a(0x1b8)][_0x1cb43a(0x27c)]),this['logCoinToPayStatus'](_0x162fa8,_0x4e18eb,_0x1cb43a(0x1e6),'PENDING',_0x1cb43a(0x1d9),{'action':_0x1cb43a(0x20a),'scheduledChecks':_0x5cad9d[_0x1cb43a(0x247)],'firstCheckIn':_0x5cad9d[0x0][_0x1cb43a(0x23f)]/0x3e8,'totalTimers':this[_0x1cb43a(0x1b8)][_0x1cb43a(0x27c)]});}[a37_0x2bb313(0x1be)](_0x46c815){const _0x2d5650=a37_0x2bb313,_0x1987b3=this[_0x2d5650(0x1b8)][_0x2d5650(0x23c)](_0x46c815);_0x1987b3?(console[_0x2d5650(0x212)](_0x2d5650(0x1d5)+_0x1987b3[_0x2d5650(0x227)]['length']+'\x20timers\x20for\x20payment\x20'+_0x46c815),_0x1987b3[_0x2d5650(0x227)]['forEach']((_0x52cc29,_0x4c63a6)=>{const _0x4054ec=_0x2d5650;_0x52cc29&&(clearTimeout(_0x52cc29),clearInterval(_0x52cc29),console[_0x4054ec(0x212)](_0x4054ec(0x214)+(_0x4c63a6+0x1)+'\x20for\x20payment\x20'+_0x46c815));}),this[_0x2d5650(0x1b8)][_0x2d5650(0x23b)](_0x46c815),console[_0x2d5650(0x212)]('‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x46c815+_0x2d5650(0x260)+this[_0x2d5650(0x1b8)][_0x2d5650(0x27c)])):console[_0x2d5650(0x212)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x46c815+_0x2d5650(0x277));}async[a37_0x2bb313(0x1ba)](_0x450e4d){const _0x2f3e51=a37_0x2bb313;console[_0x2f3e51(0x212)](_0x2f3e51(0x26b)+_0x450e4d);const _0x1cce69=await database_1[_0x2f3e51(0x232)]['payment'][_0x2f3e51(0x1e8)]({'where':{'id':_0x450e4d},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1cce69){console['log'](_0x2f3e51(0x1d0)+_0x450e4d+_0x2f3e51(0x276));return;}console[_0x2f3e51(0x212)](_0x2f3e51(0x1df)+_0x450e4d+_0x2f3e51(0x1f1)),console[_0x2f3e51(0x212)](_0x2f3e51(0x1ab)+_0x1cce69['gateway']),console[_0x2f3e51(0x212)](_0x2f3e51(0x207)+_0x1cce69[_0x2f3e51(0x1b6)]),console[_0x2f3e51(0x212)](_0x2f3e51(0x24e)+_0x1cce69[_0x2f3e51(0x1ea)]),console[_0x2f3e51(0x212)](_0x2f3e51(0x25e)+_0x1cce69[_0x2f3e51(0x20f)]+'\x20'+_0x1cce69['currency']),console[_0x2f3e51(0x212)](_0x2f3e51(0x1a3)+_0x1cce69[_0x2f3e51(0x19d)]);if(_0x1cce69[_0x2f3e51(0x1ac)]!==_0x2f3e51(0x21c)){console[_0x2f3e51(0x212)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x450e4d+_0x2f3e51(0x25f)+_0x1cce69[_0x2f3e51(0x1ac)]+')');return;}if(_0x1cce69[_0x2f3e51(0x1b6)]!==_0x2f3e51(0x1e6)){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x450e4d+_0x2f3e51(0x1f9)+_0x1cce69[_0x2f3e51(0x1b6)]+_0x2f3e51(0x1f5)),this['clearPaymentTimers'](_0x450e4d);return;}if(!_0x1cce69[_0x2f3e51(0x1ea)]){console['log'](_0x2f3e51(0x1d6)+_0x450e4d+_0x2f3e51(0x230));return;}console[_0x2f3e51(0x212)]('‚úÖ\x20[CHECK]\x20Payment\x20'+_0x450e4d+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x2f3e51(0x1d3)](_0x1cce69);}[a37_0x2bb313(0x225)](_0x267e26,_0xcaf285,_0x5d4f95,_0x21cab0,_0x4c3c4f,_0x336ffb){const _0x23f974=a37_0x2bb313,_0x8894aa={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x267e26,'gatewayPaymentId':_0xcaf285,'oldStatus':_0x5d4f95,'newStatus':_0x21cab0,'source':_0x4c3c4f,'timestamp':new Date()[_0x23f974(0x1c4)](),'details':_0x336ffb||{}};loggerService_1[_0x23f974(0x282)][_0x23f974(0x225)](_0x8894aa),console[_0x23f974(0x212)](_0x23f974(0x1b7)+_0x267e26+'\x20('+_0xcaf285+')'),console[_0x23f974(0x212)](_0x23f974(0x1b0)+_0x5d4f95+_0x23f974(0x270)+_0x21cab0),console['log']('\x20\x20\x20üìç\x20Source:\x20'+_0x4c3c4f),console['log'](_0x23f974(0x1fb)+_0x8894aa[_0x23f974(0x1f7)]),_0x336ffb&&console[_0x23f974(0x212)](_0x23f974(0x1e1),_0x336ffb);}[a37_0x2bb313(0x22a)](_0x4d9323,_0x4bb20b,_0x5dcd9b,_0x3f748c,_0x4c2131){const _0x3486b4=a37_0x2bb313,_0x32ab76={'type':_0x3486b4(0x257),'paymentId':_0x4d9323,'gatewayPaymentId':_0x4bb20b,'error':_0x5dcd9b instanceof Error?{'message':_0x5dcd9b['message'],'stack':_0x5dcd9b['stack']}:_0x5dcd9b,'source':_0x3f748c,'timestamp':new Date()[_0x3486b4(0x1c4)](),'context':_0x4c2131||{}};loggerService_1[_0x3486b4(0x282)]['logCoinToPayError'](_0x32ab76),console[_0x3486b4(0x246)](_0x3486b4(0x234)+_0x4d9323+'\x20('+_0x4bb20b+')'),console['error'](_0x3486b4(0x1d2)+(_0x5dcd9b instanceof Error?_0x5dcd9b['message']:_0x5dcd9b)),console[_0x3486b4(0x246)](_0x3486b4(0x1b1)+_0x3f748c),console[_0x3486b4(0x246)](_0x3486b4(0x1fb)+_0x32ab76[_0x3486b4(0x1f7)]),_0x4c2131&&console[_0x3486b4(0x246)](_0x3486b4(0x26a),_0x4c2131);}[a37_0x2bb313(0x211)](){const _0x3e290e=a37_0x2bb313;console[_0x3e290e(0x212)](_0x3e290e(0x200)),this['checkAllPendingPayments']()['catch'](_0x4cf62a=>{const _0x598d61=_0x3e290e;console[_0x598d61(0x246)](_0x598d61(0x203),_0x4cf62a);}),this[_0x3e290e(0x279)]=setInterval(async()=>{const _0x2c5191=_0x3e290e;try{console[_0x2c5191(0x212)](_0x2c5191(0x229)),await this['checkAllPendingPayments'](),console['log']('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x4d7380){console['error'](_0x2c5191(0x223),_0x4d7380);}},this[_0x3e290e(0x1dc)]),console[_0x3e290e(0x212)](_0x3e290e(0x1ad));}[a37_0x2bb313(0x24b)](){const _0x5c26eb=a37_0x2bb313;console['log']('üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x5c26eb(0x279)]&&(clearInterval(this['globalCheckInterval']),this['globalCheckInterval']=null,console[_0x5c26eb(0x212)](_0x5c26eb(0x1b5)));const _0xb6b2a2=this['paymentTimers'][_0x5c26eb(0x27c)];for(const [_0x252acf]of this[_0x5c26eb(0x1b8)]){this['clearPaymentTimers'](_0x252acf);}console['log'](_0x5c26eb(0x26c)+_0xb6b2a2+_0x5c26eb(0x21b));}async[a37_0x2bb313(0x25d)](){const _0x26b073=a37_0x2bb313;try{console['log'](_0x26b073(0x258));const _0x1e8e47=await database_1[_0x26b073(0x232)]['payment'][_0x26b073(0x27a)]({'where':{'gateway':_0x26b073(0x21c),'status':_0x26b073(0x1e6),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x26b073(0x274)+_0x1e8e47[_0x26b073(0x247)]+_0x26b073(0x1f0));if(_0x1e8e47['length']===0x0){console[_0x26b073(0x212)](_0x26b073(0x26d));return;}const _0x4996e6=await this[_0x26b073(0x25a)](_0x1e8e47);console[_0x26b073(0x212)](_0x26b073(0x213)+_0x4996e6[_0x26b073(0x247)]+_0x26b073(0x1ee));let _0x352f78=0x0,_0x138a90=0x0;for(const _0x5d8cce of _0x1e8e47){try{if(_0x4996e6['includes'](_0x5d8cce['id'])){console[_0x26b073(0x212)](_0x26b073(0x1cf)+_0x5d8cce['id']+_0x26b073(0x259)),_0x138a90++;continue;}if(this[_0x26b073(0x1b8)]['has'](_0x5d8cce['id'])){console[_0x26b073(0x212)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x5d8cce['id']+_0x26b073(0x263)),_0x138a90++;continue;}const _0x4d7020=(Date['now']()-_0x5d8cce[_0x26b073(0x237)][_0x26b073(0x20d)]())/(0x3e8*0x3c*0x3c);if(_0x4d7020<0x1){console[_0x26b073(0x212)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x5d8cce['id']+_0x26b073(0x286)+_0x4d7020[_0x26b073(0x1a1)](0x1)+'h),\x20skipping\x20global\x20check'),_0x138a90++;continue;}console['log'](_0x26b073(0x254)+_0x5d8cce['id']+'\x20(age:\x20'+_0x4d7020[_0x26b073(0x1a1)](0x1)+'h)'),await this[_0x26b073(0x1d3)](_0x5d8cce),_0x352f78++,await new Promise(_0x55767b=>setTimeout(_0x55767b,0x7d0));}catch(_0x43488e){console[_0x26b073(0x246)](_0x26b073(0x205)+_0x5d8cce['id']+':',_0x43488e),this[_0x26b073(0x22a)](_0x5d8cce['id'],_0x5d8cce[_0x26b073(0x1ea)]||_0x26b073(0x236),_0x43488e,_0x26b073(0x1d9),{'isGlobalCheck':!![],'paymentAmount':_0x5d8cce[_0x26b073(0x20f)],'paymentCurrency':_0x5d8cce[_0x26b073(0x204)],'shopId':_0x5d8cce[_0x26b073(0x19d)],'createdAt':_0x5d8cce[_0x26b073(0x237)]}),loggerService_1[_0x26b073(0x282)][_0x26b073(0x1a2)](_0x26b073(0x21c),_0x26b073(0x239)+_0x5d8cce['gatewayPaymentId'],_0x43488e);}}console['log']('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x352f78+_0x26b073(0x23a)+_0x138a90+'\x20skipped,\x20'+_0x4996e6[_0x26b073(0x247)]+_0x26b073(0x285));}catch(_0x15db1f){console['error'](_0x26b073(0x22b),_0x15db1f);}}async[a37_0x2bb313(0x25a)](_0x21c760){const _0x9705a0=a37_0x2bb313,_0x24b891=[],_0x31f347=new Date();_0x31f347[_0x9705a0(0x1a5)](_0x31f347[_0x9705a0(0x202)]()-this[_0x9705a0(0x1e2)]),console[_0x9705a0(0x212)](_0x9705a0(0x208)+this['EXPIRY_DAYS']+_0x9705a0(0x1a0)+_0x31f347['toISOString']()+')');for(const _0x57be25 of _0x21c760){if(_0x57be25[_0x9705a0(0x237)]<_0x31f347){console[_0x9705a0(0x212)]('‚è∞\x20[EXPIRY]\x20Payment\x20'+_0x57be25['id']+_0x9705a0(0x1a4)+this[_0x9705a0(0x1e2)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x9705a0(0x225)](_0x57be25['id'],_0x57be25[_0x9705a0(0x1ea)]||_0x9705a0(0x236),'PENDING',_0x9705a0(0x19c),_0x9705a0(0x1b4),{'reason':'Payment\x20older\x20than\x20'+this[_0x9705a0(0x1e2)]+'\x20days','createdAt':_0x57be25[_0x9705a0(0x237)],'daysSinceCreation':Math[_0x9705a0(0x1ff)]((Date[_0x9705a0(0x1d8)]()-_0x57be25[_0x9705a0(0x237)][_0x9705a0(0x20d)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x57be25[_0x9705a0(0x20f)],'paymentCurrency':_0x57be25['currency'],'shopId':_0x57be25['shopId']}),await database_1['default'][_0x9705a0(0x1f2)][_0x9705a0(0x224)]({'where':{'id':_0x57be25['id']},'data':{'status':_0x9705a0(0x19c),'updatedAt':new Date(),'adminNotes':_0x9705a0(0x287)+this[_0x9705a0(0x1e2)]+_0x9705a0(0x1eb)}}),await database_1['default']['webhookLog'][_0x9705a0(0x222)]({'data':{'paymentId':_0x57be25['id'],'shopId':_0x57be25[_0x9705a0(0x19d)],'event':_0x9705a0(0x1f4),'statusCode':0xc8,'responseBody':JSON[_0x9705a0(0x228)]({'reason':_0x9705a0(0x265)+this[_0x9705a0(0x1e2)]+_0x9705a0(0x231),'createdAt':_0x57be25[_0x9705a0(0x237)],'expiredAt':new Date()[_0x9705a0(0x1c4)](),'daysSinceCreation':Math[_0x9705a0(0x1ff)]((Date[_0x9705a0(0x1d8)]()-_0x57be25[_0x9705a0(0x237)][_0x9705a0(0x20d)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x9705a0(0x1d4)](_0x57be25,'EXPIRED'),await this[_0x9705a0(0x1af)](_0x57be25,_0x9705a0(0x19c)),this[_0x9705a0(0x1be)](_0x57be25['id']),_0x24b891[_0x9705a0(0x1bf)](_0x57be25['id']),console[_0x9705a0(0x212)](_0x9705a0(0x216)+_0x57be25['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this['EXPIRY_DAYS']+'-day\x20timeout');}catch(_0x46e909){console['error']('‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x57be25['id']+':',_0x46e909),this['logCoinToPayError'](_0x57be25['id'],_0x57be25[_0x9705a0(0x1ea)]||'unknown',_0x46e909,_0x9705a0(0x1b4),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x57be25[_0x9705a0(0x237)],'daysSinceCreation':Math[_0x9705a0(0x1ff)]((Date['now']()-_0x57be25[_0x9705a0(0x237)][_0x9705a0(0x20d)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x24b891;}async[a37_0x2bb313(0x1d3)](_0x2447bf){const _0x28859d=a37_0x2bb313;if(!_0x2447bf[_0x28859d(0x1ea)]){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x2447bf['id']+_0x28859d(0x1aa));return;}console['log'](_0x28859d(0x233)+_0x2447bf['id']+'\x20('+_0x2447bf[_0x28859d(0x1ea)]+')');try{const _0x2699e9=await this['coinToPayService'][_0x28859d(0x1c8)](_0x2447bf[_0x28859d(0x1ea)]);console[_0x28859d(0x212)](_0x28859d(0x1df)+_0x2447bf['id']+_0x28859d(0x1f6)+_0x2699e9[_0x28859d(0x1b6)]);_0x2699e9[_0x28859d(0x1a7)]&&console[_0x28859d(0x212)]('üìä\x20[CHECK]\x20Payment\x20'+_0x2447bf['id']+_0x28859d(0x21f),{'iban':_0x2699e9[_0x28859d(0x1a7)][_0x28859d(0x1c0)]||_0x28859d(0x250),'transactionId':_0x2699e9[_0x28859d(0x1a7)][_0x28859d(0x221)],'createdOn':_0x2699e9[_0x28859d(0x1a7)][_0x28859d(0x278)],'confirmedOn':_0x2699e9[_0x28859d(0x1a7)][_0x28859d(0x21a)]||_0x28859d(0x26f)});if(_0x2699e9['status']!==_0x2447bf[_0x28859d(0x1b6)]){console[_0x28859d(0x212)](_0x28859d(0x210)+_0x2447bf['id']+_0x28859d(0x1e0)+_0x2447bf[_0x28859d(0x1b6)]+_0x28859d(0x1d1)+_0x2699e9[_0x28859d(0x1b6)]),this[_0x28859d(0x225)](_0x2447bf['id'],_0x2447bf[_0x28859d(0x1ea)],_0x2447bf[_0x28859d(0x1b6)],_0x2699e9[_0x28859d(0x1b6)],_0x28859d(0x1d9),{'paymentDetails':_0x2699e9['paymentDetails'],'amount':_0x2699e9[_0x28859d(0x20f)],'currency':_0x2699e9['currency'],'shopId':_0x2447bf[_0x28859d(0x19d)],'checkTimestamp':new Date()[_0x28859d(0x1c4)]()});const _0x27c9d2={'status':_0x2699e9[_0x28859d(0x1b6)],'updatedAt':new Date()};_0x2699e9[_0x28859d(0x1b6)]===_0x28859d(0x1f3)&&_0x2447bf[_0x28859d(0x1b6)]!==_0x28859d(0x1f3)&&(_0x27c9d2[_0x28859d(0x24d)]=new Date(),console['log'](_0x28859d(0x238)+_0x2447bf['id']+_0x28859d(0x219)+_0x27c9d2['paidAt'][_0x28859d(0x1c4)]()));if(_0x2699e9[_0x28859d(0x1a7)]){const _0x21b1d0=_0x2699e9[_0x28859d(0x1a7)];_0x21b1d0[_0x28859d(0x1c0)]&&(_0x27c9d2[_0x28859d(0x1c1)]=_0x21b1d0[_0x28859d(0x1c0)],console[_0x28859d(0x212)](_0x28859d(0x261)+_0x21b1d0[_0x28859d(0x1c0)]));if(_0x21b1d0[_0x28859d(0x1fa)]){const _0x307906=_0x2447bf[_0x28859d(0x19f)]||'',_0x442845=_0x28859d(0x226)+_0x21b1d0['bankDetails'];_0x27c9d2[_0x28859d(0x19f)]=_0x307906?_0x307906+'\x0a\x0a'+_0x442845:_0x442845,console['log'](_0x28859d(0x284));}_0x21b1d0[_0x28859d(0x221)]&&console[_0x28859d(0x212)](_0x28859d(0x1bd)+_0x21b1d0[_0x28859d(0x221)]),_0x21b1d0[_0x28859d(0x21a)]&&console[_0x28859d(0x212)](_0x28859d(0x20e)+_0x21b1d0[_0x28859d(0x21a)]);}await database_1[_0x28859d(0x232)][_0x28859d(0x1f2)][_0x28859d(0x224)]({'where':{'id':_0x2447bf['id']},'data':_0x27c9d2}),await database_1[_0x28859d(0x232)]['webhookLog'][_0x28859d(0x222)]({'data':{'paymentId':_0x2447bf['id'],'shopId':_0x2447bf['shopId'],'event':_0x28859d(0x251)+_0x2699e9[_0x28859d(0x1b6)][_0x28859d(0x24f)](),'statusCode':0xc8,'responseBody':JSON[_0x28859d(0x228)]({'oldStatus':_0x2447bf['status'],'newStatus':_0x2699e9[_0x28859d(0x1b6)],'paymentDetails':_0x2699e9[_0x28859d(0x1a7)],'checkedAt':new Date()[_0x28859d(0x1c4)]()})}}),await this[_0x28859d(0x1d4)](_0x2447bf,_0x2699e9[_0x28859d(0x1b6)]),await this[_0x28859d(0x1af)](_0x2447bf,_0x2699e9[_0x28859d(0x1b6)]),_0x2699e9[_0x28859d(0x1b6)]!=='PENDING'&&(console[_0x28859d(0x212)]('üßπ\x20[CHECK]\x20Payment\x20'+_0x2447bf['id']+_0x28859d(0x1e5)+_0x2699e9[_0x28859d(0x1b6)]+',\x20clearing\x20individual\x20timers'),this[_0x28859d(0x1be)](_0x2447bf['id'])),console[_0x28859d(0x212)]('‚úÖ\x20[CHECK]\x20Payment\x20'+_0x2447bf['id']+_0x28859d(0x24a));}else console['log'](_0x28859d(0x1df)+_0x2447bf['id']+_0x28859d(0x242)+_0x2699e9['status']+')'),this[_0x28859d(0x225)](_0x2447bf['id'],_0x2447bf['gatewayPaymentId'],_0x2447bf[_0x28859d(0x1b6)],_0x2699e9['status'],_0x28859d(0x1d9),{'statusUnchanged':!![],'paymentDetails':_0x2699e9[_0x28859d(0x1a7)],'amount':_0x2699e9[_0x28859d(0x20f)],'currency':_0x2699e9[_0x28859d(0x204)],'shopId':_0x2447bf[_0x28859d(0x19d)],'checkTimestamp':new Date()[_0x28859d(0x1c4)]()});}catch(_0x5dc42f){console[_0x28859d(0x246)](_0x28859d(0x1f8)+_0x2447bf['id']+':',_0x5dc42f),this['logCoinToPayError'](_0x2447bf['id'],_0x2447bf['gatewayPaymentId'],_0x5dc42f,_0x28859d(0x1d9),{'paymentAmount':_0x2447bf['amount'],'paymentCurrency':_0x2447bf[_0x28859d(0x204)],'shopId':_0x2447bf[_0x28859d(0x19d)],'createdAt':_0x2447bf['createdAt']}),await database_1['default'][_0x28859d(0x271)]['create']({'data':{'paymentId':_0x2447bf['id'],'shopId':_0x2447bf[_0x28859d(0x19d)],'event':_0x28859d(0x1d7),'statusCode':0x1f4,'responseBody':JSON[_0x28859d(0x228)]({'error':_0x5dc42f instanceof Error?_0x5dc42f[_0x28859d(0x1de)]:_0x28859d(0x1ce),'gatewayPaymentId':_0x2447bf[_0x28859d(0x1ea)],'checkedAt':new Date()[_0x28859d(0x1c4)]()})}});}}async[a37_0x2bb313(0x1d4)](_0x6ed5ba,_0x359fdd){const _0x9e079e=a37_0x2bb313,_0x3e2cc3=Date[_0x9e079e(0x1d8)]();try{const _0x12d56b=_0x6ed5ba[_0x9e079e(0x1bc)],_0x18a989=_0x12d56b['settings'];if(!_0x18a989?.[_0x9e079e(0x25c)]){console[_0x9e079e(0x212)](_0x9e079e(0x1e7)+_0x12d56b['id']);return;}const _0x1f6c81=_0x359fdd==='PAID'?_0x9e079e(0x248):_0x359fdd===_0x9e079e(0x1cd)?_0x9e079e(0x283):_0x359fdd===_0x9e079e(0x19c)?'payment.failed':'payment.pending';if(!_0x18a989[_0x9e079e(0x255)]?.[_0x9e079e(0x1e9)](_0x1f6c81)){console[_0x9e079e(0x212)](_0x9e079e(0x20b)+_0x1f6c81+'\x20not\x20enabled\x20for\x20shop\x20'+_0x12d56b['id']);return;}const _0xa79af8={'event':_0x1f6c81,'payment':{'id':_0x6ed5ba['id'],'order_id':_0x6ed5ba[_0x9e079e(0x1dd)],'gateway_order_id':_0x6ed5ba[_0x9e079e(0x1a8)],'gateway':_0x9e079e(0x267),'amount':_0x6ed5ba[_0x9e079e(0x20f)],'currency':_0x6ed5ba[_0x9e079e(0x204)],'status':_0x359fdd[_0x9e079e(0x24f)](),'customer_email':_0x6ed5ba['customerEmail'],'customer_name':_0x6ed5ba[_0x9e079e(0x22d)],'created_at':_0x6ed5ba[_0x9e079e(0x237)],'updated_at':new Date()}},_0x2c9cef=await fetch(_0x18a989[_0x9e079e(0x25c)],{'method':_0x9e079e(0x244),'headers':{'Content-Type':'application/json','User-Agent':_0x9e079e(0x243)},'body':JSON[_0x9e079e(0x228)](_0xa79af8)}),_0x85cf9=Date[_0x9e079e(0x1d8)]()-_0x3e2cc3,_0x19b2b3=_0x2c9cef['ok']?_0x9e079e(0x1cb):await _0x2c9cef[_0x9e079e(0x1fc)]();loggerService_1[_0x9e079e(0x282)][_0x9e079e(0x1fe)](_0x6ed5ba[_0x9e079e(0x19d)],_0x18a989['webhookUrl'],_0x1f6c81,_0x2c9cef[_0x9e079e(0x1b6)],_0x85cf9,_0xa79af8),console[_0x9e079e(0x212)](_0x9e079e(0x220)+_0x18a989[_0x9e079e(0x25c)]+_0x9e079e(0x272)+_0x2c9cef[_0x9e079e(0x1b6)]+'\x20('+_0x85cf9+'ms)');}catch(_0x1d18f0){console[_0x9e079e(0x246)](_0x9e079e(0x1ed),_0x1d18f0),loggerService_1[_0x9e079e(0x282)][_0x9e079e(0x288)](_0x6ed5ba[_0x9e079e(0x19d)],_0x6ed5ba['shop']?.['settings']?.[_0x9e079e(0x25c)]||_0x9e079e(0x236),_0x9e079e(0x20c),_0x1d18f0,{});}}async[a37_0x2bb313(0x1af)](_0x4ac861,_0x13fa5b){const _0x4d2136=a37_0x2bb313;try{const _0x624caa={'PENDING':_0x4d2136(0x249),'PAID':_0x4d2136(0x1ae),'FAILED':_0x4d2136(0x1c3),'EXPIRED':_0x4d2136(0x235)},_0x43c68e=_0x624caa[_0x13fa5b];if(!_0x43c68e||_0x43c68e===_0x4d2136(0x249))return;await telegramBotService_1[_0x4d2136(0x201)][_0x4d2136(0x1ca)](_0x4ac861['shopId'],_0x4ac861,_0x43c68e);}catch(_0x4c224d){console[_0x4d2136(0x246)](_0x4d2136(0x19e),_0x4c224d);}}async[a37_0x2bb313(0x241)](_0x16e5dd){const _0x5a33ac=a37_0x2bb313;console[_0x5a33ac(0x212)](_0x5a33ac(0x245)+_0x16e5dd);const _0x5e0b7d=await database_1[_0x5a33ac(0x232)][_0x5a33ac(0x1f2)][_0x5a33ac(0x1e8)]({'where':{'id':_0x16e5dd},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5e0b7d)throw new Error('Payment\x20not\x20found');if(_0x5e0b7d[_0x5a33ac(0x1ac)]!=='cointopay')throw new Error(_0x5a33ac(0x27b));console[_0x5a33ac(0x212)](_0x5a33ac(0x1bb)+_0x16e5dd),await this[_0x5a33ac(0x1d3)](_0x5e0b7d),console[_0x5a33ac(0x212)]('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x16e5dd);}[a37_0x2bb313(0x1b9)](){const _0x57a7be=a37_0x2bb313,_0x255bc0=this[_0x57a7be(0x279)]?this[_0x57a7be(0x1dc)]:undefined,_0x4142c5=Array['from'](this[_0x57a7be(0x1b8)][_0x57a7be(0x1c7)]())[_0x57a7be(0x1e3)](_0x431a37=>({'paymentId':_0x431a37[_0x57a7be(0x262)],'gatewayPaymentId':_0x431a37['gatewayPaymentId'],'createdAt':_0x431a37[_0x57a7be(0x237)],'timersCount':_0x431a37[_0x57a7be(0x227)][_0x57a7be(0x247)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x57a7be(0x1dc)]/(0x3e8*0x3c),'expiryDays':this[_0x57a7be(0x1e2)],'activeIndividualTimers':this[_0x57a7be(0x1b8)][_0x57a7be(0x27c)],'nextGlobalCheckIn':_0x255bc0,'paymentTimersDetails':_0x4142c5};}[a37_0x2bb313(0x1a6)](_0x51bafa){const _0x2322a5=a37_0x2bb313,_0x28ee74=this[_0x2322a5(0x1b8)][_0x2322a5(0x23c)](_0x51bafa);if(_0x28ee74)return{'hasTimers':!![],'timersCount':_0x28ee74[_0x2322a5(0x227)][_0x2322a5(0x247)],'createdAt':_0x28ee74['createdAt'],'gatewayPaymentId':_0x28ee74['gatewayPaymentId']};return{'hasTimers':![]};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();