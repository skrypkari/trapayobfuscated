'use strict';const a37_0x421b96=a37_0x50f7;(function(_0x46e952,_0x5ed582){const _0x390a00=a37_0x50f7,_0x2911ea=_0x46e952();while(!![]){try{const _0x351005=-parseInt(_0x390a00(0x290))/0x1+parseInt(_0x390a00(0x257))/0x2+parseInt(_0x390a00(0x1ff))/0x3*(parseInt(_0x390a00(0x22f))/0x4)+-parseInt(_0x390a00(0x20b))/0x5+parseInt(_0x390a00(0x24c))/0x6*(-parseInt(_0x390a00(0x1d7))/0x7)+parseInt(_0x390a00(0x248))/0x8*(-parseInt(_0x390a00(0x28a))/0x9)+-parseInt(_0x390a00(0x275))/0xa*(-parseInt(_0x390a00(0x209))/0xb);if(_0x351005===_0x5ed582)break;else _0x2911ea['push'](_0x2911ea['shift']());}catch(_0x410e27){_0x2911ea['push'](_0x2911ea['shift']());}}}(a37_0x1d91,0x98482));function a37_0x50f7(_0x4498dd,_0x3eb66a){const _0x1d91f4=a37_0x1d91();return a37_0x50f7=function(_0x50f799,_0x1a886c){_0x50f799=_0x50f799-0x1cc;let _0x33482b=_0x1d91f4[_0x50f799];return _0x33482b;},a37_0x50f7(_0x4498dd,_0x3eb66a);}var __importDefault=this&&this[a37_0x421b96(0x299)]||function(_0xfbff06){return _0xfbff06&&_0xfbff06['__esModule']?_0xfbff06:{'default':_0xfbff06};};Object[a37_0x421b96(0x231)](exports,a37_0x421b96(0x200),{'value':!![]}),exports[a37_0x421b96(0x230)]=exports[a37_0x421b96(0x24f)]=void 0x0;const coinToPayService_1=require(a37_0x421b96(0x282)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require(a37_0x421b96(0x1fc)),database_1=__importDefault(require(a37_0x421b96(0x285))),telegramBotService_1=require(a37_0x421b96(0x29f)),loggerService_1=require(a37_0x421b96(0x210));class CoinToPayStatusService{constructor(){const _0x1308e0=a37_0x421b96;this[_0x1308e0(0x2a9)]=null,this[_0x1308e0(0x262)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x1308e0(0x28c)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x1308e0(0x1d9))](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x1308e0(0x271))](),console[_0x1308e0(0x295)]('ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}['schedulePaymentChecks'](_0x249e22,_0x149a53){const _0x29db30=a37_0x421b96;console[_0x29db30(0x295)](_0x29db30(0x296)),console[_0x29db30(0x295)]('\x20\x20\x20-\x20paymentId:\x20'+_0x249e22),console['log'](_0x29db30(0x203)+_0x149a53),this[_0x29db30(0x2a1)](_0x249e22);const _0x398758=[],_0x3cb85a=new Date(),_0xff155=[{'delay':0x1*0x3c*0x3e8,'description':_0x29db30(0x232)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x29db30(0x2a6)}];console['log'](_0x29db30(0x2af)+_0xff155[_0x29db30(0x283)]+_0x29db30(0x26a)+_0x249e22);let _0x28b7d8=0x0;_0xff155[_0x29db30(0x267)]((_0x2fdf11,_0x5747f9)=>{const _0x4d53a6=_0x29db30;_0x28b7d8+=_0x2fdf11[_0x4d53a6(0x228)];const _0xe8d0ca=setTimeout(async()=>{const _0x10246c=_0x4d53a6;console['log'](_0x10246c(0x1cf)+(_0x5747f9+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x249e22+'\x20(after\x20'+_0x2fdf11[_0x10246c(0x292)]+')');try{await this[_0x10246c(0x298)](_0x249e22),console['log']('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x5747f9+0x1)+_0x10246c(0x261)+_0x249e22);}catch(_0x1a8601){console[_0x10246c(0x239)](_0x10246c(0x1d4)+(_0x5747f9+0x1)+_0x10246c(0x272)+_0x249e22+':',_0x1a8601),this[_0x10246c(0x1fe)](_0x249e22,_0x149a53,_0x1a8601,'status_check',{'checkNumber':_0x5747f9+0x1,'scheduledAfter':_0x2fdf11[_0x10246c(0x292)],'isIndividualCheck':!![]});}},_0x28b7d8);_0x398758['push'](_0xe8d0ca),console[_0x4d53a6(0x295)](_0x4d53a6(0x20f)+(_0x5747f9+0x1)+_0x4d53a6(0x272)+_0x249e22+_0x4d53a6(0x247)+_0x28b7d8/0x3e8+'\x20seconds\x20('+_0x2fdf11[_0x4d53a6(0x292)]+')');});const _0x5f3467=setInterval(async()=>{const _0x280c50=_0x29db30;console[_0x280c50(0x295)](_0x280c50(0x2a3)+_0x249e22);try{const _0x12b504=await database_1['default'][_0x280c50(0x268)]['findUnique']({'where':{'id':_0x249e22},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x12b504){console['log'](_0x280c50(0x205)+_0x249e22+_0x280c50(0x207)),this['clearPaymentTimers'](_0x249e22);return;}console[_0x280c50(0x295)](_0x280c50(0x26b)+_0x249e22+'\x20current\x20status:\x20'+_0x12b504[_0x280c50(0x28b)]);if(_0x12b504[_0x280c50(0x28b)]!=='PENDING'){console['log'](_0x280c50(0x1fa)+_0x249e22+_0x280c50(0x1f4)+_0x12b504['status']+_0x280c50(0x1e0)),this[_0x280c50(0x2a1)](_0x249e22);return;}const _0x324c2a=Math[_0x280c50(0x1cc)]((Date[_0x280c50(0x208)]()-_0x12b504[_0x280c50(0x21f)][_0x280c50(0x1eb)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x324c2a>=this[_0x280c50(0x29e)]){console[_0x280c50(0x295)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x249e22+'\x20is\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x280c50(0x1ec)),this[_0x280c50(0x2a1)](_0x249e22);return;}await this['checkSinglePaymentById'](_0x249e22),console[_0x280c50(0x295)](_0x280c50(0x293)+_0x249e22);}catch(_0x33bdeb){console[_0x280c50(0x239)](_0x280c50(0x286)+_0x249e22+':',_0x33bdeb),this[_0x280c50(0x1fe)](_0x249e22,_0x149a53,_0x33bdeb,_0x280c50(0x2ab),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x398758[_0x29db30(0x23c)](_0x5f3467),this[_0x29db30(0x28c)]['set'](_0x249e22,{'timers':_0x398758,'paymentId':_0x249e22,'gatewayPaymentId':_0x149a53,'createdAt':_0x3cb85a}),console[_0x29db30(0x295)](_0x29db30(0x278)+_0xff155[_0x29db30(0x283)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x249e22),console[_0x29db30(0x295)]('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x29db30(0x28c)][_0x29db30(0x1ea)]),this[_0x29db30(0x252)](_0x249e22,_0x149a53,'PENDING',_0x29db30(0x26c),'status_check',{'action':_0x29db30(0x2a2),'scheduledChecks':_0xff155[_0x29db30(0x283)],'firstCheckIn':_0xff155[0x0]['delay']/0x3e8,'totalTimers':this[_0x29db30(0x28c)][_0x29db30(0x1ea)]});}[a37_0x421b96(0x2a1)](_0x597e3f){const _0x554336=a37_0x421b96,_0x1d5d98=this['paymentTimers'][_0x554336(0x22d)](_0x597e3f);_0x1d5d98?(console[_0x554336(0x295)](_0x554336(0x23a)+_0x1d5d98[_0x554336(0x1f8)]['length']+'\x20timers\x20for\x20payment\x20'+_0x597e3f),_0x1d5d98[_0x554336(0x1f8)][_0x554336(0x267)]((_0x662af1,_0x58f218)=>{const _0x598810=_0x554336;_0x662af1&&(clearTimeout(_0x662af1),clearInterval(_0x662af1),console[_0x598810(0x295)](_0x598810(0x1f6)+(_0x58f218+0x1)+_0x598810(0x272)+_0x597e3f));}),this['paymentTimers'][_0x554336(0x288)](_0x597e3f),console[_0x554336(0x295)](_0x554336(0x265)+_0x597e3f+_0x554336(0x243)+this[_0x554336(0x28c)][_0x554336(0x1ea)])):console[_0x554336(0x295)](_0x554336(0x1e3)+_0x597e3f+_0x554336(0x1ee));}async[a37_0x421b96(0x298)](_0x50dcf5){const _0x54dcc4=a37_0x421b96;console[_0x54dcc4(0x295)](_0x54dcc4(0x297)+_0x50dcf5);const _0x23341d=await database_1['default']['payment'][_0x54dcc4(0x1f9)]({'where':{'id':_0x50dcf5},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x23341d){console[_0x54dcc4(0x295)](_0x54dcc4(0x237)+_0x50dcf5+_0x54dcc4(0x28d));return;}console[_0x54dcc4(0x295)](_0x54dcc4(0x1e6)+_0x50dcf5+_0x54dcc4(0x2ad)),console[_0x54dcc4(0x295)]('\x20\x20\x20-\x20Gateway:\x20'+_0x23341d[_0x54dcc4(0x20a)]),console[_0x54dcc4(0x295)]('\x20\x20\x20-\x20Status:\x20'+_0x23341d[_0x54dcc4(0x28b)]),console[_0x54dcc4(0x295)](_0x54dcc4(0x284)+_0x23341d[_0x54dcc4(0x217)]),console[_0x54dcc4(0x295)](_0x54dcc4(0x25c)+_0x23341d[_0x54dcc4(0x224)]+'\x20'+_0x23341d[_0x54dcc4(0x2a8)]),console['log'](_0x54dcc4(0x24a)+_0x23341d['shopId']);if(_0x23341d['gateway']!==_0x54dcc4(0x21a)&&_0x23341d[_0x54dcc4(0x20a)]!=='cointopay2'){console[_0x54dcc4(0x295)](_0x54dcc4(0x266)+_0x50dcf5+_0x54dcc4(0x276)+_0x23341d['gateway']+')');return;}if(_0x23341d[_0x54dcc4(0x28b)]!=='PENDING'){console[_0x54dcc4(0x295)](_0x54dcc4(0x266)+_0x50dcf5+_0x54dcc4(0x1f4)+_0x23341d[_0x54dcc4(0x28b)]+_0x54dcc4(0x1e0)),this[_0x54dcc4(0x2a1)](_0x50dcf5);return;}if(!_0x23341d[_0x54dcc4(0x217)]){console[_0x54dcc4(0x295)](_0x54dcc4(0x266)+_0x50dcf5+_0x54dcc4(0x273));return;}console[_0x54dcc4(0x295)](_0x54dcc4(0x25d)+_0x50dcf5+_0x54dcc4(0x23d)),await this[_0x54dcc4(0x1f5)](_0x23341d);}[a37_0x421b96(0x252)](_0x59b033,_0x433971,_0x2c3ea9,_0x381151,_0x12a2c1,_0x3296ff){const _0x460117=a37_0x421b96,_0x578063={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x59b033,'gatewayPaymentId':_0x433971,'oldStatus':_0x2c3ea9,'newStatus':_0x381151,'source':_0x12a2c1,'timestamp':new Date()['toISOString'](),'details':_0x3296ff||{}};loggerService_1['loggerService'][_0x460117(0x252)](_0x578063),console[_0x460117(0x295)](_0x460117(0x1de)+_0x59b033+'\x20('+_0x433971+')'),console['log'](_0x460117(0x24b)+_0x2c3ea9+_0x460117(0x226)+_0x381151),console[_0x460117(0x295)](_0x460117(0x2b5)+_0x12a2c1),console[_0x460117(0x295)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x578063[_0x460117(0x26d)]),_0x3296ff&&console['log'](_0x460117(0x1e8),_0x3296ff);}[a37_0x421b96(0x1fe)](_0x5b0d75,_0x1a0801,_0x4bb519,_0x2154d8,_0x117ba5){const _0x4841ea=a37_0x421b96,_0x25a9d={'type':'COINTOPAY_ERROR','paymentId':_0x5b0d75,'gatewayPaymentId':_0x1a0801,'error':_0x4bb519 instanceof Error?{'message':_0x4bb519[_0x4841ea(0x213)],'stack':_0x4bb519[_0x4841ea(0x1e5)]}:_0x4bb519,'source':_0x2154d8,'timestamp':new Date()[_0x4841ea(0x25a)](),'context':_0x117ba5||{}};loggerService_1[_0x4841ea(0x1fd)][_0x4841ea(0x1fe)](_0x25a9d),console[_0x4841ea(0x239)](_0x4841ea(0x21c)+_0x5b0d75+'\x20('+_0x1a0801+')'),console['error'](_0x4841ea(0x23e)+(_0x4bb519 instanceof Error?_0x4bb519['message']:_0x4bb519)),console[_0x4841ea(0x239)]('\x20\x20\x20üìç\x20Source:\x20'+_0x2154d8),console[_0x4841ea(0x239)](_0x4841ea(0x2a5)+_0x25a9d[_0x4841ea(0x26d)]),_0x117ba5&&console[_0x4841ea(0x239)](_0x4841ea(0x22e),_0x117ba5);}[a37_0x421b96(0x241)](){const _0x7b4a9c=a37_0x421b96;console[_0x7b4a9c(0x295)]('ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this['checkAllPendingPayments']()[_0x7b4a9c(0x215)](_0x3cc57d=>{const _0x309391=_0x7b4a9c;console[_0x309391(0x239)](_0x309391(0x2b4),_0x3cc57d);}),this[_0x7b4a9c(0x2a9)]=setInterval(async()=>{const _0x40a55b=_0x7b4a9c;try{console[_0x40a55b(0x295)](_0x40a55b(0x2b3)),await this['checkAllPendingPayments'](),console[_0x40a55b(0x295)](_0x40a55b(0x20d));}catch(_0x5599ab){console[_0x40a55b(0x239)](_0x40a55b(0x1d6),_0x5599ab);}},this[_0x7b4a9c(0x262)]),console[_0x7b4a9c(0x295)](_0x7b4a9c(0x235));}['stopPeriodicStatusCheck'](){const _0x2bd222=a37_0x421b96;console['log']('üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x2bd222(0x2a9)]&&(clearInterval(this[_0x2bd222(0x2a9)]),this[_0x2bd222(0x2a9)]=null,console[_0x2bd222(0x295)]('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x42c76e=this[_0x2bd222(0x28c)][_0x2bd222(0x1ea)];for(const [_0xda9ec8]of this[_0x2bd222(0x28c)]){this[_0x2bd222(0x2a1)](_0xda9ec8);}console[_0x2bd222(0x295)](_0x2bd222(0x260)+_0x42c76e+_0x2bd222(0x277));}async[a37_0x421b96(0x289)](){const _0x8edc6=a37_0x421b96;try{console[_0x8edc6(0x295)]('ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x134883=await database_1['default'][_0x8edc6(0x268)]['findMany']({'where':{'gateway':{'in':[_0x8edc6(0x21a),_0x8edc6(0x1cd)]},'status':_0x8edc6(0x26c),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x8edc6(0x295)](_0x8edc6(0x2b1)+_0x134883['length']+'\x20pending\x20CoinToPay\x20payments');if(_0x134883[_0x8edc6(0x283)]===0x0){console[_0x8edc6(0x295)](_0x8edc6(0x20e));return;}const _0x3acfe4=await this[_0x8edc6(0x259)](_0x134883);console[_0x8edc6(0x295)](_0x8edc6(0x270)+_0x3acfe4[_0x8edc6(0x283)]+'\x20expired\x20CoinToPay\x20payments');let _0x162def=0x0,_0x3d55ff=0x0;for(const _0x42ce04 of _0x134883){try{if(_0x3acfe4[_0x8edc6(0x1fb)](_0x42ce04['id'])){console[_0x8edc6(0x295)](_0x8edc6(0x1ed)+_0x42ce04['id']+_0x8edc6(0x1d3)),_0x3d55ff++;continue;}if(this[_0x8edc6(0x28c)][_0x8edc6(0x218)](_0x42ce04['id'])){console[_0x8edc6(0x295)](_0x8edc6(0x1ed)+_0x42ce04['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x3d55ff++;continue;}const _0x11b3fc=(Date[_0x8edc6(0x208)]()-_0x42ce04['createdAt'][_0x8edc6(0x1eb)]())/(0x3e8*0x3c*0x3c);if(_0x11b3fc<0x1){console[_0x8edc6(0x295)](_0x8edc6(0x1ed)+_0x42ce04['id']+_0x8edc6(0x2a7)+_0x11b3fc[_0x8edc6(0x1e9)](0x1)+_0x8edc6(0x253)),_0x3d55ff++;continue;}console[_0x8edc6(0x295)](_0x8edc6(0x27e)+_0x42ce04['id']+_0x8edc6(0x220)+_0x11b3fc['toFixed'](0x1)+'h)'),await this[_0x8edc6(0x1f5)](_0x42ce04),_0x162def++,await new Promise(_0x5bdecc=>setTimeout(_0x5bdecc,0x7d0));}catch(_0x24c7ef){console['error'](_0x8edc6(0x206)+_0x42ce04['id']+':',_0x24c7ef),this[_0x8edc6(0x1fe)](_0x42ce04['id'],_0x42ce04[_0x8edc6(0x217)]||_0x8edc6(0x246),_0x24c7ef,_0x8edc6(0x2ab),{'isGlobalCheck':!![],'paymentAmount':_0x42ce04[_0x8edc6(0x224)],'paymentCurrency':_0x42ce04[_0x8edc6(0x2a8)],'shopId':_0x42ce04[_0x8edc6(0x1d1)],'createdAt':_0x42ce04['createdAt']}),loggerService_1['loggerService']['logWhiteDomainError'](_0x8edc6(0x21a),'/status/'+_0x42ce04[_0x8edc6(0x217)],_0x24c7ef);}}console[_0x8edc6(0x295)](_0x8edc6(0x223)+_0x162def+_0x8edc6(0x25f)+_0x3d55ff+_0x8edc6(0x23b)+_0x3acfe4[_0x8edc6(0x283)]+'\x20expired');}catch(_0x2cc2bc){console[_0x8edc6(0x239)](_0x8edc6(0x1d8),_0x2cc2bc);}}async[a37_0x421b96(0x259)](_0x114531){const _0x4d2a53=a37_0x421b96,_0x477853=[],_0x397355=new Date();_0x397355[_0x4d2a53(0x269)](_0x397355[_0x4d2a53(0x1f2)]()-this[_0x4d2a53(0x29e)]),console[_0x4d2a53(0x295)](_0x4d2a53(0x1f3)+this[_0x4d2a53(0x29e)]+'\x20days\x20(created\x20before\x20'+_0x397355[_0x4d2a53(0x25a)]()+')');for(const _0x186d03 of _0x114531){if(_0x186d03['createdAt']<_0x397355){console['log']('‚è∞\x20[EXPIRY]\x20Payment\x20'+_0x186d03['id']+_0x4d2a53(0x1da)+this[_0x4d2a53(0x29e)]+_0x4d2a53(0x26f));try{this[_0x4d2a53(0x252)](_0x186d03['id'],_0x186d03['gatewayPaymentId']||_0x4d2a53(0x246),_0x4d2a53(0x26c),_0x4d2a53(0x1e1),_0x4d2a53(0x1ef),{'reason':_0x4d2a53(0x204)+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x186d03['createdAt'],'daysSinceCreation':Math[_0x4d2a53(0x1cc)]((Date['now']()-_0x186d03[_0x4d2a53(0x21f)][_0x4d2a53(0x1eb)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x186d03[_0x4d2a53(0x224)],'paymentCurrency':_0x186d03[_0x4d2a53(0x2a8)],'shopId':_0x186d03[_0x4d2a53(0x1d1)]}),await database_1[_0x4d2a53(0x1d5)][_0x4d2a53(0x268)][_0x4d2a53(0x25e)]({'where':{'id':_0x186d03['id']},'data':{'status':_0x4d2a53(0x1e1),'updatedAt':new Date(),'adminNotes':_0x4d2a53(0x1dc)+this[_0x4d2a53(0x29e)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x4d2a53(0x1d5)][_0x4d2a53(0x2ac)][_0x4d2a53(0x29d)]({'data':{'paymentId':_0x186d03['id'],'shopId':_0x186d03[_0x4d2a53(0x1d1)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x4d2a53(0x24e)]({'reason':_0x4d2a53(0x204)+this[_0x4d2a53(0x29e)]+_0x4d2a53(0x1e2),'createdAt':_0x186d03[_0x4d2a53(0x21f)],'expiredAt':new Date()[_0x4d2a53(0x25a)](),'daysSinceCreation':Math['floor']((Date[_0x4d2a53(0x208)]()-_0x186d03[_0x4d2a53(0x21f)][_0x4d2a53(0x1eb)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4d2a53(0x255)](_0x186d03,'EXPIRED'),await this['sendPaymentStatusNotification'](_0x186d03,_0x4d2a53(0x1e1)),this[_0x4d2a53(0x2a1)](_0x186d03['id']),_0x477853[_0x4d2a53(0x23c)](_0x186d03['id']),console['log']('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x186d03['id']+_0x4d2a53(0x26e)+this[_0x4d2a53(0x29e)]+'-day\x20timeout');}catch(_0x1e1775){console[_0x4d2a53(0x239)](_0x4d2a53(0x211)+_0x186d03['id']+':',_0x1e1775),this['logCoinToPayError'](_0x186d03['id'],_0x186d03['gatewayPaymentId']||_0x4d2a53(0x246),_0x1e1775,_0x4d2a53(0x1ef),{'reason':_0x4d2a53(0x219),'createdAt':_0x186d03['createdAt'],'daysSinceCreation':Math[_0x4d2a53(0x1cc)]((Date[_0x4d2a53(0x208)]()-_0x186d03[_0x4d2a53(0x21f)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x477853;}async['checkSinglePayment'](_0x356a94){const _0x3dfea3=a37_0x421b96;if(!_0x356a94[_0x3dfea3(0x217)]){console['log'](_0x3dfea3(0x266)+_0x356a94['id']+_0x3dfea3(0x281));return;}console['log'](_0x3dfea3(0x1f0)+_0x356a94[_0x3dfea3(0x20a)]+_0x3dfea3(0x202)+_0x356a94['id']+'\x20('+_0x356a94[_0x3dfea3(0x217)]+')');try{let _0x59abd0;_0x356a94[_0x3dfea3(0x20a)]==='cointopay2'?(_0x59abd0=await this[_0x3dfea3(0x27f)][_0x3dfea3(0x222)](_0x356a94[_0x3dfea3(0x217)]),console[_0x3dfea3(0x295)]('üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x356a94['id']+'\x20status:\x20'+_0x59abd0['status'])):(_0x59abd0=await this[_0x3dfea3(0x244)]['checkPaymentStatus'](_0x356a94[_0x3dfea3(0x217)]),console[_0x3dfea3(0x295)](_0x3dfea3(0x229)+_0x356a94['id']+_0x3dfea3(0x287)+_0x59abd0[_0x3dfea3(0x28b)]));_0x59abd0[_0x3dfea3(0x254)]&&console['log'](_0x3dfea3(0x1e6)+_0x356a94['id']+_0x3dfea3(0x1d0),{'iban':_0x59abd0[_0x3dfea3(0x254)][_0x3dfea3(0x214)]||_0x3dfea3(0x29b),'transactionId':_0x59abd0[_0x3dfea3(0x254)][_0x3dfea3(0x291)],'createdOn':_0x59abd0['paymentDetails'][_0x3dfea3(0x2a0)],'confirmedOn':_0x59abd0[_0x3dfea3(0x254)]['confirmedOn']||_0x3dfea3(0x280)});if(_0x59abd0[_0x3dfea3(0x28b)]!==_0x356a94[_0x3dfea3(0x28b)]){console['log'](_0x3dfea3(0x29c)+_0x356a94['id']+_0x3dfea3(0x27c)+_0x356a94[_0x3dfea3(0x28b)]+_0x3dfea3(0x2b0)+_0x59abd0['status']),this['logCoinToPayStatus'](_0x356a94['id'],_0x356a94[_0x3dfea3(0x217)],_0x356a94[_0x3dfea3(0x28b)],_0x59abd0[_0x3dfea3(0x28b)],_0x3dfea3(0x2ab),{'paymentDetails':_0x59abd0[_0x3dfea3(0x254)],'amount':_0x59abd0['amount'],'currency':_0x59abd0['currency'],'shopId':_0x356a94[_0x3dfea3(0x1d1)],'checkTimestamp':new Date()['toISOString']()});const _0x36526b={'status':_0x59abd0[_0x3dfea3(0x28b)],'updatedAt':new Date()};_0x59abd0['status']===_0x3dfea3(0x216)&&_0x356a94[_0x3dfea3(0x28b)]!==_0x3dfea3(0x216)&&(_0x36526b[_0x3dfea3(0x24d)]=new Date(),console[_0x3dfea3(0x295)](_0x3dfea3(0x22b)+_0x356a94['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x36526b[_0x3dfea3(0x24d)][_0x3dfea3(0x25a)]()));if(_0x59abd0['paymentDetails']){const _0x5e503f=_0x59abd0[_0x3dfea3(0x254)];_0x5e503f[_0x3dfea3(0x214)]&&(_0x36526b[_0x3dfea3(0x221)]=_0x5e503f[_0x3dfea3(0x214)],console[_0x3dfea3(0x295)](_0x3dfea3(0x21b)+_0x5e503f[_0x3dfea3(0x214)]));if(_0x5e503f[_0x3dfea3(0x236)]){const _0xab5381=_0x356a94[_0x3dfea3(0x240)]||'',_0x37c40a=_0x3dfea3(0x2a4)+_0x5e503f[_0x3dfea3(0x236)];_0x36526b[_0x3dfea3(0x240)]=_0xab5381?_0xab5381+'\x0a\x0a'+_0x37c40a:_0x37c40a,console[_0x3dfea3(0x295)](_0x3dfea3(0x1dd));}_0x5e503f[_0x3dfea3(0x291)]&&console['log']('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x5e503f[_0x3dfea3(0x291)]),_0x5e503f[_0x3dfea3(0x1ce)]&&console[_0x3dfea3(0x295)](_0x3dfea3(0x263)+_0x5e503f[_0x3dfea3(0x1ce)]);}await database_1[_0x3dfea3(0x1d5)][_0x3dfea3(0x268)]['update']({'where':{'id':_0x356a94['id']},'data':_0x36526b}),await database_1[_0x3dfea3(0x1d5)][_0x3dfea3(0x2ac)][_0x3dfea3(0x29d)]({'data':{'paymentId':_0x356a94['id'],'shopId':_0x356a94[_0x3dfea3(0x1d1)],'event':'cointopay_status_check_'+_0x59abd0['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x3dfea3(0x24e)]({'oldStatus':_0x356a94[_0x3dfea3(0x28b)],'newStatus':_0x59abd0[_0x3dfea3(0x28b)],'paymentDetails':_0x59abd0[_0x3dfea3(0x254)],'checkedAt':new Date()[_0x3dfea3(0x25a)]()})}}),await this['sendShopWebhook'](_0x356a94,_0x59abd0['status']),await this[_0x3dfea3(0x21d)](_0x356a94,_0x59abd0['status']),_0x59abd0[_0x3dfea3(0x28b)]!==_0x3dfea3(0x26c)&&(console['log']('üßπ\x20[CHECK]\x20Payment\x20'+_0x356a94['id']+_0x3dfea3(0x27b)+_0x59abd0[_0x3dfea3(0x28b)]+_0x3dfea3(0x22a)),this[_0x3dfea3(0x2a1)](_0x356a94['id'])),console[_0x3dfea3(0x295)](_0x3dfea3(0x25d)+_0x356a94['id']+_0x3dfea3(0x227));}else console[_0x3dfea3(0x295)]('üìä\x20[CHECK]\x20Payment\x20'+_0x356a94['id']+_0x3dfea3(0x1d2)+_0x59abd0['status']+')'),this[_0x3dfea3(0x252)](_0x356a94['id'],_0x356a94['gatewayPaymentId'],_0x356a94[_0x3dfea3(0x28b)],_0x59abd0[_0x3dfea3(0x28b)],_0x3dfea3(0x2ab),{'statusUnchanged':!![],'paymentDetails':_0x59abd0[_0x3dfea3(0x254)],'amount':_0x59abd0[_0x3dfea3(0x224)],'currency':_0x59abd0['currency'],'shopId':_0x356a94[_0x3dfea3(0x1d1)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x2d3367){console[_0x3dfea3(0x239)](_0x3dfea3(0x250)+_0x356a94['id']+':',_0x2d3367),this['logCoinToPayError'](_0x356a94['id'],_0x356a94['gatewayPaymentId'],_0x2d3367,'status_check',{'paymentAmount':_0x356a94[_0x3dfea3(0x224)],'paymentCurrency':_0x356a94[_0x3dfea3(0x2a8)],'shopId':_0x356a94[_0x3dfea3(0x1d1)],'createdAt':_0x356a94[_0x3dfea3(0x21f)]}),await database_1[_0x3dfea3(0x1d5)][_0x3dfea3(0x2ac)][_0x3dfea3(0x29d)]({'data':{'paymentId':_0x356a94['id'],'shopId':_0x356a94[_0x3dfea3(0x1d1)],'event':_0x3dfea3(0x279),'statusCode':0x1f4,'responseBody':JSON[_0x3dfea3(0x24e)]({'error':_0x2d3367 instanceof Error?_0x2d3367[_0x3dfea3(0x213)]:_0x3dfea3(0x28f),'gatewayPaymentId':_0x356a94[_0x3dfea3(0x217)],'checkedAt':new Date()[_0x3dfea3(0x25a)]()})}});}}async[a37_0x421b96(0x255)](_0x4b5c8c,_0x3a380d){const _0x228725=a37_0x421b96,_0x304bd2=Date[_0x228725(0x208)]();try{const _0x4f6b71=_0x4b5c8c['shop'],_0x485985=_0x4f6b71[_0x228725(0x242)];if(!_0x485985?.['webhookUrl']){console[_0x228725(0x295)](_0x228725(0x212)+_0x4f6b71['id']);return;}const _0x24bc83=_0x3a380d===_0x228725(0x216)?'payment.success':_0x3a380d==='FAILED'?'payment.failed':_0x3a380d===_0x228725(0x1e1)?_0x228725(0x21e):'payment.pending';if(!_0x485985['webhookEvents']?.[_0x228725(0x1fb)](_0x24bc83)){console['log'](_0x228725(0x1db)+_0x24bc83+'\x20not\x20enabled\x20for\x20shop\x20'+_0x4f6b71['id']);return;}const _0x165e27=(0x0,gateway_1[_0x228725(0x29a)])(_0x4b5c8c[_0x228725(0x20a)])||_0x4b5c8c[_0x228725(0x20a)],_0x2d5113={'event':_0x24bc83,'payment':{'id':_0x4b5c8c['id'],'order_id':_0x4b5c8c[_0x228725(0x23f)],'gateway_order_id':_0x4b5c8c[_0x228725(0x234)],'gateway':_0x165e27,'amount':_0x4b5c8c[_0x228725(0x224)],'currency':_0x4b5c8c['currency'],'status':_0x3a380d['toLowerCase'](),'customer_email':_0x4b5c8c[_0x228725(0x1e7)],'customer_name':_0x4b5c8c[_0x228725(0x201)],'created_at':_0x4b5c8c[_0x228725(0x21f)],'updated_at':new Date()}},_0x1e3717=await fetch(_0x485985[_0x228725(0x258)],{'method':_0x228725(0x20c),'headers':{'Content-Type':_0x228725(0x233),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x228725(0x24e)](_0x2d5113)}),_0x2b97ff=Date[_0x228725(0x208)]()-_0x304bd2,_0x171ef4=_0x1e3717['ok']?'Success':await _0x1e3717[_0x228725(0x238)]();loggerService_1[_0x228725(0x1fd)][_0x228725(0x28e)](_0x4b5c8c['shopId'],_0x485985['webhookUrl'],_0x24bc83,_0x1e3717['status'],_0x2b97ff,_0x2d5113),console[_0x228725(0x295)](_0x228725(0x2ae)+_0x485985[_0x228725(0x258)]+_0x228725(0x2aa)+_0x1e3717['status']+'\x20('+_0x2b97ff+'ms)');}catch(_0x1f6877){console[_0x228725(0x239)](_0x228725(0x264),_0x1f6877),loggerService_1[_0x228725(0x1fd)][_0x228725(0x27d)](_0x4b5c8c[_0x228725(0x1d1)],_0x4b5c8c[_0x228725(0x249)]?.[_0x228725(0x242)]?.[_0x228725(0x258)]||_0x228725(0x246),'webhook_send',_0x1f6877,{});}}async[a37_0x421b96(0x21d)](_0x2eba0b,_0x4eb82d){const _0x29282c=a37_0x421b96;try{const _0x156511={'PENDING':_0x29282c(0x251),'PAID':_0x29282c(0x1e4),'FAILED':_0x29282c(0x27a),'EXPIRED':_0x29282c(0x1df)},_0x2e6585=_0x156511[_0x4eb82d];if(!_0x2e6585||_0x2e6585===_0x29282c(0x251))return;await telegramBotService_1[_0x29282c(0x294)]['sendPaymentNotification'](_0x2eba0b[_0x29282c(0x1d1)],_0x2eba0b,_0x2e6585);}catch(_0x24ffdc){console[_0x29282c(0x239)](_0x29282c(0x1f7),_0x24ffdc);}}async[a37_0x421b96(0x245)](_0x4f67aa){const _0x5adfee=a37_0x421b96;console[_0x5adfee(0x295)](_0x5adfee(0x1f1)+_0x4f67aa);const _0x567f58=await database_1[_0x5adfee(0x1d5)][_0x5adfee(0x268)]['findUnique']({'where':{'id':_0x4f67aa},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x567f58)throw new Error(_0x5adfee(0x25b));if(_0x567f58['gateway']!==_0x5adfee(0x21a)&&_0x567f58[_0x5adfee(0x20a)]!=='cointopay2')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x5adfee(0x295)](_0x5adfee(0x2b2)+_0x567f58[_0x5adfee(0x20a)]+_0x5adfee(0x202)+_0x4f67aa),await this['checkSinglePayment'](_0x567f58),console['log']('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x4f67aa);}['getServiceStats'](){const _0x534471=a37_0x421b96,_0x314211=this['globalCheckInterval']?this[_0x534471(0x262)]:undefined,_0x351faa=Array[_0x534471(0x256)](this[_0x534471(0x28c)][_0x534471(0x274)]())[_0x534471(0x22c)](_0xd6d547=>({'paymentId':_0xd6d547[_0x534471(0x225)],'gatewayPaymentId':_0xd6d547[_0x534471(0x217)],'createdAt':_0xd6d547[_0x534471(0x21f)],'timersCount':_0xd6d547[_0x534471(0x1f8)][_0x534471(0x283)]}));return{'isActive':!!this[_0x534471(0x2a9)],'globalCheckIntervalMinutes':this[_0x534471(0x262)]/(0x3e8*0x3c),'expiryDays':this[_0x534471(0x29e)],'activeIndividualTimers':this[_0x534471(0x28c)][_0x534471(0x1ea)],'nextGlobalCheckIn':_0x314211,'paymentTimersDetails':_0x351faa};}['getPaymentTimerInfo'](_0x2b0c81){const _0x119b0a=a37_0x421b96,_0x1521f9=this['paymentTimers']['get'](_0x2b0c81);if(_0x1521f9)return{'hasTimers':!![],'timersCount':_0x1521f9[_0x119b0a(0x1f8)]['length'],'createdAt':_0x1521f9['createdAt'],'gatewayPaymentId':_0x1521f9[_0x119b0a(0x217)]};return{'hasTimers':![]};}}function a37_0x1d91(){const _0x1c95d0=['telegramBotService','log','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','checkSinglePaymentById','__importDefault','getGatewayIdByName','not\x20found','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','create','EXPIRY_DAYS','./telegramBotService','createdOn','clearPaymentTimers','schedule_created','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','Bank\x20Details:\x20','\x20\x20\x20üìÖ\x20Time:\x20','5\x20minutes','\x20is\x20too\x20new\x20(','currency','globalCheckInterval','\x20with\x20status\x20','status_check','webhookLog','\x20found:','Shop\x20webhook\x20sent\x20to\x20','ü™ô\x20[DEBUG]\x20Creating\x20','\x20to\x20','ü™ô\x20[GLOBAL]\x20Found\x20','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20\x20\x20üìç\x20Source:\x20','floor','cointopay2','confirmedOn','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','\x20details:','shopId','\x20status\x20unchanged\x20(','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','default','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','14Ffhxxh','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','CoinToPayService','\x20is\x20older\x20than\x20','Webhook\x20event\x20','Automatically\x20expired\x20after\x20','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','expired',',\x20stopping\x20individual\x20checks','EXPIRED','\x20days','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','paid','stack','üìä\x20[CHECK]\x20Payment\x20','customerEmail','\x20\x20\x20üìù\x20Details:','toFixed','size','getTime','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','‚è∞\x20[GLOBAL]\x20Payment\x20','\x20to\x20clear','auto_expire','üîç\x20[CHECK]\x20Checking\x20','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','getDate','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20status\x20is\x20','checkSinglePayment','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','timers','findUnique','‚úÖ\x20[HOURLY]\x20Payment\x20','includes','../types/gateway','loggerService','logCoinToPayError','900492uwnewo','__esModule','customerName','\x20payment\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','Payment\x20older\x20than\x20','‚ùå\x20[HOURLY]\x20Payment\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20not\x20found,\x20clearing\x20timers','now','165PCqLxJ','gateway','4220160ubvVAI','POST','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','./loggerService','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','message','iban','catch','PAID','gatewayPaymentId','has','Failed\x20to\x20mark\x20payment\x20as\x20expired','cointopay','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','sendPaymentStatusNotification','payment.failed','createdAt','\x20(age:\x20','remitterIban','checkPaymentStatus','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','amount','paymentId','\x20->\x20','\x20updated\x20successfully','delay','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20',',\x20clearing\x20individual\x20timers','üí∞\x20[CHECK]\x20Payment\x20','map','get','\x20\x20\x20üìù\x20Context:','4fSCNoJ','coinToPayStatusService','defineProperty','1\x20minute','application/json','gatewayOrderId','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','bankDetails','‚ùå\x20[CHECK]\x20Payment\x20','text','error','üßπ\x20[DEBUG]\x20Clearing\x20','\x20skipped,\x20','push','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20\x20\x20‚ùå\x20Error:\x20','orderId','adminNotes','startPeriodicStatusCheck','settings','.\x20Remaining\x20active\x20timers:\x20','coinToPayService','checkPaymentById','unknown','\x20in\x20','96wZWKbP','shop','\x20\x20\x20-\x20ShopId:\x20','\x20\x20\x20üìä\x20Status:\x20','589710XypNDW','paidAt','stringify','CoinToPayStatusService','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','created','logCoinToPayStatus','h),\x20skipping\x20global\x20check','paymentDetails','sendShopWebhook','from','1113110VmePxA','webhookUrl','checkExpiredPayments','toISOString','Payment\x20not\x20found','\x20\x20\x20-\x20Amount:\x20','‚úÖ\x20[CHECK]\x20Payment\x20','update','\x20checked,\x20','üõë\x20[SHUTDOWN]\x20Cleared\x20','\x20completed\x20for\x20payment\x20','GLOBAL_CHECK_INTERVAL_MS','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','Failed\x20to\x20send\x20shop\x20webhook:','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','forEach','payment','setDate','\x20initial\x20timers\x20for\x20payment\x20','üìä\x20[HOURLY]\x20Payment\x20','PENDING','timestamp','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20days,\x20marking\x20as\x20EXPIRED','‚è∞\x20[GLOBAL]\x20Found\x20','CoinToPay2Service','\x20for\x20payment\x20','\x20has\x20no\x20gatewayPaymentId','values','728370ARQzSe','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','\x20individual\x20payment\x20timers','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','cointopay_status_check_error','failed','\x20status\x20changed\x20to\x20','\x20status\x20from\x20','logShopWebhookError','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','coinToPay2Service','not\x20confirmed','\x20has\x20no\x20gatewayPaymentId,\x20skipping','./gateways/coinToPayService','length','\x20\x20\x20-\x20GatewayPaymentId:\x20','../config/database','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20status:\x20','delete','checkAllPendingPayments','121707zspUCm','status','paymentTimers','\x20not\x20found\x20in\x20database','logShopWebhookSent','Unknown\x20error','122650jpfRIe','transactionId','description','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'];a37_0x1d91=function(){return _0x1c95d0;};return a37_0x1d91();}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a37_0x421b96(0x230)]=new CoinToPayStatusService();