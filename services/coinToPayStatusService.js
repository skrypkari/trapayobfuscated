'use strict';function a38_0x1d03(){const _0x1e04f1=['entries','cointopay_status_check_','1041203uTixlm','paymentId','\x20updated:\x20currentPayments=','delete','settings','webhook_send','\x20days','adminNotes','getGatewayIdByName','amount','currency','\x20\x20\x20📍\x20Source:\x20','globalCheckInterval','\x20\x20\x20-\x20Amount:\x20','defineProperty','set','Payment\x20not\x20found','paymentLinkId','__esModule','auto_expire','has','payment.success','\x20\x20\x20-\x20gatewayPaymentId:\x20','map','✅\x20[EXPIRY]\x20Payment\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...',',\x20using\x20default\x2010%','gatewaySettings','remitterIban','paymentDetails','Payment\x20older\x20than\x20','7642492JkRbfB','./gateways/coinToPay2Service','coinToPay2Service','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','5889525pbVdJX','shop','size','PAID','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','checkPaymentById','14268330YXFGjp','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','\x20status\x20changed\x20to\x20','134TjgGQD','gateway','\x20to\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','\x20marked\x20as\x20paid\x20at:\x20','EXPIRY_DAYS','get','h),\x20skipping\x20global\x20check','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','description','payment.failed','2904728yaYqxF','\x20\x20\x20📝\x20Details:','🔄\x20[CHECK]\x20Updating\x20payment\x20',',\x20stopping\x20individual\x20checks','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','__importDefault','orderId','\x20\x20\x20-\x20Status:\x20','\x20payment\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','timers','Unknown\x20error','currentPayments','\x20USDT','shopId','\x20pending\x20CoinToPay\x20payments','1\x20minute','checkPaymentStatus','\x20\x20\x20📅\x20Time:\x20','\x20status:\x20','\x20to\x20clear','sendPaymentNotification','confirmedOn','🧹\x20[DEBUG]\x20Clearing\x20','⚠️\x20[CHECK]\x20Payment\x20','currencyService','convertToUSDT','logWhiteDomainError','coinToPayStatusService','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','stringify','TesSoft\x20Payment\x20System/1.0','cointopay2','error','stopPeriodicStatusCheck','update','🛑\x20[SHUTDOWN]\x20Cleared\x20','\x20\x20\x20Amount\x20after\x20commission:\x20','default','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20in\x20shop\x20','40398etlDDp','telegramBotService','🧹\x20[CHECK]\x20Payment\x20','paymentLink','checkAllPendingPayments','\x20not\x20found,\x20clearing\x20timers','not\x20confirmed','toISOString','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','getTime','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','checkSinglePaymentById','includes','sendPaymentStatusNotification','getGatewayCommission','timestamp','bankDetails',',\x20status=','values','failed','🪙\x20[GLOBAL]\x20Found\x20','delay','commission','log','transactionId','gatewayCommissionRate','\x20checked,\x20','SINGLE','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','loggerService','COINTOPAY_STATUS_CHANGE','createdAt','\x20status\x20is\x20','created','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','logCoinToPayError','amountUSDT','\x20triggered\x20for\x20payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','\x20is\x20too\x20new\x20(','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','setDate','create','✅\x20[CHECK]\x20Payment\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20is\x20older\x20than\x20','forEach','\x20has\x20no\x20gatewayPaymentId,\x20skipping','from','logShopWebhookError','status','findUnique','expired','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','cointopay_status_check_error','sendShopWebhook','✅\x20[COINTOPAY]\x20Payment\x20link\x20','\x20initial\x20timers\x20for\x20payment\x20','\x20expired\x20CoinToPay\x20payments','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20has\x20no\x20gatewayPaymentId','webhookLog',',\x20currentPayments=','\x20timers\x20for\x20payment\x20','checkExpiredPayments','webhookEvents','\x20\x20\x20Gateway\x20','schedulePaymentChecks','\x20for\x20payment\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','COINTOPAY_ERROR','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','findMany','paidAt','iban','amountAfterGatewayCommissionUSDT','58599ormDRN','gatewayOrderId','Success','\x20\x20\x20❌\x20Error:\x20','\x20\x20\x20-\x20Gateway:\x20','cointopay','../config/database','\x20commission\x20for\x20shop\x20','🔍\x20[CHECK]\x20Checking\x20','getServiceStats','\x20updated\x20successfully','getPaymentTimerInfo','checkSinglePayment','coinToPayService','\x20expired',':\x20type=','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20',',\x20clearing\x20individual\x20timers','📈\x20[COINTOPAY]\x20Payment\x20','schedule_created','now','.\x20Remaining\x20active\x20timers:\x20','\x20details:','\x20completed\x20for\x20payment\x20','GLOBAL_CHECK_INTERVAL_MS','status_check','paymentTimers','ms)','📊\x20[HOURLY]\x20Payment\x20','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','Shop\x20webhook\x20sent\x20to\x20','❌\x20[HOURLY]\x20Payment\x20','PENDING','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20(age:\x20','⏰\x20[EXPIRY]\x20Payment\x20','💰\x20[CHECK]\x20Payment\x20','⏰\x20[GLOBAL]\x20Found\x20','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','customerName','payment.pending','clearPaymentTimers','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20individual\x20payment\x20timers','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','push','\x20is\x20valid\x20for\x20checking,\x20proceeding...','/status/','application/json','Webhook\x20event\x20','message','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','✅\x20[HOURLY]\x20Payment\x20','\x20\x20\x20-\x20ShopId:\x20','2\x20minutes','❌\x20[CHECK]\x20Payment\x20',',\x20gateway\x20','EXPIRED','length','webhookUrl','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','Gateway\x20','36SwzcKe','type','floor','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20\x20\x20-\x20paymentId:\x20','⏰\x20[GLOBAL]\x20Payment\x20','createdOn','CoinToPayStatusService','toFixed','203JlontB','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','5\x20minutes','\x20->\x20','payment','logCoinToPayStatus','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','gatewayPaymentId','🪙\x20[DEBUG]\x20Creating\x20','FAILED','📊\x20[CHECK]\x20Payment\x20','\x20\x20\x20Amount:\x20','unknown','\x20days\x20(created\x20before\x20'];a38_0x1d03=function(){return _0x1e04f1;};return a38_0x1d03();}const a38_0x33a1c7=a38_0x2e9d;(function(_0x1cdbef,_0x1d57fd){const _0xd1213d=a38_0x2e9d,_0x4f29ad=_0x1cdbef();while(!![]){try{const _0x4bc154=-parseInt(_0xd1213d(0x18c))/0x1+parseInt(_0xd1213d(0x1b8))/0x2*(-parseInt(_0xd1213d(0x131))/0x3)+parseInt(_0xd1213d(0x1ab))/0x4+parseInt(_0xd1213d(0x1af))/0x5+parseInt(_0xd1213d(0xe3))/0x6*(parseInt(_0xd1213d(0x17c))/0x7)+-parseInt(_0xd1213d(0x1c3))/0x8*(-parseInt(_0xd1213d(0x173))/0x9)+-parseInt(_0xd1213d(0x1b5))/0xa;if(_0x4bc154===_0x1d57fd)break;else _0x4f29ad['push'](_0x4f29ad['shift']());}catch(_0x442e91){_0x4f29ad['push'](_0x4f29ad['shift']());}}}(a38_0x1d03,0xea3aa));var __importDefault=this&&this[a38_0x33a1c7(0x1c8)]||function(_0x150e25){return _0x150e25&&_0x150e25['__esModule']?_0x150e25:{'default':_0x150e25};};Object[a38_0x33a1c7(0x19a)](exports,a38_0x33a1c7(0x19e),{'value':!![]}),exports['coinToPayStatusService']=exports[a38_0x33a1c7(0x17a)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a38_0x33a1c7(0x1ac)),gateway_1=require('../types/gateway'),database_1=__importDefault(require(a38_0x33a1c7(0x137))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService'),currencyService_1=require('./currencyService');function a38_0x2e9d(_0x1b526e,_0x490593){const _0x1d0398=a38_0x1d03();return a38_0x2e9d=function(_0x2e9d32,_0x17b589){_0x2e9d32=_0x2e9d32-0xe3;let _0xe8536a=_0x1d0398[_0x2e9d32];return _0xe8536a;},a38_0x2e9d(_0x1b526e,_0x490593);}class CoinToPayStatusService{constructor(){const _0x328742=a38_0x33a1c7;this[_0x328742(0x198)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x328742(0x1bd)]=0x5,this[_0x328742(0x14b)]=new Map(),this[_0x328742(0x13e)]=new coinToPayService_1['CoinToPayService'](),this['coinToPay2Service']=new coinToPay2Service_1['CoinToPay2Service'](),console[_0x328742(0xfa)](_0x328742(0x157));}[a38_0x33a1c7(0x128)](_0x37c001,_0x38e6eb){const _0x25b5b7=a38_0x33a1c7;console[_0x25b5b7(0xfa)](_0x25b5b7(0x120)),console[_0x25b5b7(0xfa)](_0x25b5b7(0x177)+_0x37c001),console[_0x25b5b7(0xfa)](_0x25b5b7(0x1a2)+_0x38e6eb),this[_0x25b5b7(0x15a)](_0x37c001);const _0x16d40f=[],_0x33e68c=new Date(),_0x2f5c69=[{'delay':0x1*0x3c*0x3e8,'description':_0x25b5b7(0x1d4)},{'delay':0x2*0x3c*0x3e8,'description':_0x25b5b7(0x16b)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x25b5b7(0x17e)}];console['log'](_0x25b5b7(0x184)+_0x2f5c69[_0x25b5b7(0x16f)]+_0x25b5b7(0x11e)+_0x37c001);let _0x505b16=0x0;_0x2f5c69[_0x25b5b7(0x113)]((_0x241f96,_0x4ba177)=>{const _0x402535=_0x25b5b7;_0x505b16+=_0x241f96[_0x402535(0xf8)];const _0xf522ec=setTimeout(async()=>{const _0x214827=_0x402535;console[_0x214827(0xfa)](_0x214827(0x10d)+(_0x4ba177+0x1)+_0x214827(0x108)+_0x37c001+'\x20(after\x20'+_0x241f96[_0x214827(0x1c1)]+')');try{await this[_0x214827(0xee)](_0x37c001),console[_0x214827(0xfa)](_0x214827(0x168)+(_0x4ba177+0x1)+_0x214827(0x148)+_0x37c001);}catch(_0x456051){console['error'](_0x214827(0x15d)+(_0x4ba177+0x1)+'\x20for\x20payment\x20'+_0x37c001+':',_0x456051),this[_0x214827(0x106)](_0x37c001,_0x38e6eb,_0x456051,_0x214827(0x14a),{'checkNumber':_0x4ba177+0x1,'scheduledAfter':_0x241f96['description'],'isIndividualCheck':!![]});}},_0x505b16);_0x16d40f[_0x402535(0x15f)](_0xf522ec),console[_0x402535(0xfa)](_0x402535(0x166)+(_0x4ba177+0x1)+_0x402535(0x129)+_0x37c001+'\x20in\x20'+_0x505b16/0x3e8+'\x20seconds\x20('+_0x241f96['description']+')');});const _0x4f4ab4=setInterval(async()=>{const _0x14af6b=_0x25b5b7;console[_0x14af6b(0xfa)]('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x37c001);try{const _0x72210=await database_1[_0x14af6b(0x1ea)][_0x14af6b(0x180)][_0x14af6b(0x118)]({'where':{'id':_0x37c001},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x72210){console[_0x14af6b(0xfa)](_0x14af6b(0x150)+_0x37c001+_0x14af6b(0xe8)),this['clearPaymentTimers'](_0x37c001);return;}console['log'](_0x14af6b(0x14d)+_0x37c001+'\x20current\x20status:\x20'+_0x72210[_0x14af6b(0x117)]);if(_0x72210[_0x14af6b(0x117)]!==_0x14af6b(0x151)){console['log'](_0x14af6b(0x169)+_0x37c001+'\x20status\x20is\x20'+_0x72210['status']+_0x14af6b(0x1c6)),this[_0x14af6b(0x15a)](_0x37c001);return;}const _0x1349b8=Math[_0x14af6b(0x175)]((Date[_0x14af6b(0x145)]()-_0x72210[_0x14af6b(0x102)][_0x14af6b(0xec)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1349b8>=this['EXPIRY_DAYS']){console[_0x14af6b(0xfa)]('⏰\x20[HOURLY]\x20Payment\x20'+_0x37c001+_0x14af6b(0x112)+this[_0x14af6b(0x1bd)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x14af6b(0x15a)](_0x37c001);return;}await this[_0x14af6b(0xee)](_0x37c001),console[_0x14af6b(0xfa)](_0x14af6b(0x1cc)+_0x37c001);}catch(_0x350705){console[_0x14af6b(0x1e5)](_0x14af6b(0x12c)+_0x37c001+':',_0x350705),this[_0x14af6b(0x106)](_0x37c001,_0x38e6eb,_0x350705,_0x14af6b(0x14a),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x16d40f['push'](_0x4f4ab4),this['paymentTimers'][_0x25b5b7(0x19b)](_0x37c001,{'timers':_0x16d40f,'paymentId':_0x37c001,'gatewayPaymentId':_0x38e6eb,'createdAt':_0x33e68c}),console[_0x25b5b7(0xfa)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x2f5c69[_0x25b5b7(0x16f)]+_0x25b5b7(0xeb)+_0x37c001),console['log'](_0x25b5b7(0x182)+this['paymentTimers']['size']),this[_0x25b5b7(0x181)](_0x37c001,_0x38e6eb,_0x25b5b7(0x151),'PENDING',_0x25b5b7(0x14a),{'action':_0x25b5b7(0x144),'scheduledChecks':_0x2f5c69['length'],'firstCheckIn':_0x2f5c69[0x0]['delay']/0x3e8,'totalTimers':this[_0x25b5b7(0x14b)][_0x25b5b7(0x1b1)]});}[a38_0x33a1c7(0x15a)](_0x21febe){const _0x5775c8=a38_0x33a1c7,_0x5dc64f=this['paymentTimers'][_0x5775c8(0x1be)](_0x21febe);_0x5dc64f?(console[_0x5775c8(0xfa)](_0x5775c8(0x1db)+_0x5dc64f[_0x5775c8(0x1ce)]['length']+_0x5775c8(0x124)+_0x21febe),_0x5dc64f[_0x5775c8(0x1ce)][_0x5775c8(0x113)]((_0x44fda3,_0x3b529e)=>{_0x44fda3&&(clearTimeout(_0x44fda3),clearInterval(_0x44fda3),console['log']('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x3b529e+0x1)+'\x20for\x20payment\x20'+_0x21febe));}),this['paymentTimers'][_0x5775c8(0x18f)](_0x21febe),console[_0x5775c8(0xfa)](_0x5775c8(0x10c)+_0x21febe+_0x5775c8(0x146)+this[_0x5775c8(0x14b)][_0x5775c8(0x1b1)])):console[_0x5775c8(0xfa)]('⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x21febe+_0x5775c8(0x1d8));}async['checkSinglePaymentById'](_0x394a01){const _0x56369a=a38_0x33a1c7;console[_0x56369a(0xfa)](_0x56369a(0x171)+_0x394a01);const _0x13fbe4=await database_1['default'][_0x56369a(0x180)]['findUnique']({'where':{'id':_0x394a01},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x13fbe4){console[_0x56369a(0xfa)](_0x56369a(0x16c)+_0x394a01+'\x20not\x20found\x20in\x20database');return;}console[_0x56369a(0xfa)](_0x56369a(0x186)+_0x394a01+'\x20found:'),console[_0x56369a(0xfa)](_0x56369a(0x135)+_0x13fbe4[_0x56369a(0x1b9)]),console['log'](_0x56369a(0x1ca)+_0x13fbe4[_0x56369a(0x117)]),console[_0x56369a(0xfa)](_0x56369a(0x176)+_0x13fbe4[_0x56369a(0x183)]),console[_0x56369a(0xfa)](_0x56369a(0x199)+_0x13fbe4[_0x56369a(0x195)]+'\x20'+_0x13fbe4[_0x56369a(0x196)]),console[_0x56369a(0xfa)](_0x56369a(0x16a)+_0x13fbe4[_0x56369a(0x1d2)]);if(_0x13fbe4[_0x56369a(0x1b9)]!==_0x56369a(0x136)&&_0x13fbe4['gateway']!==_0x56369a(0x1e4)){console[_0x56369a(0xfa)](_0x56369a(0x1dc)+_0x394a01+_0x56369a(0x1c7)+_0x13fbe4[_0x56369a(0x1b9)]+')');return;}if(_0x13fbe4['status']!=='PENDING'){console[_0x56369a(0xfa)](_0x56369a(0x1dc)+_0x394a01+_0x56369a(0x103)+_0x13fbe4['status']+_0x56369a(0x1c6)),this[_0x56369a(0x15a)](_0x394a01);return;}if(!_0x13fbe4[_0x56369a(0x183)]){console[_0x56369a(0xfa)](_0x56369a(0x1dc)+_0x394a01+_0x56369a(0x121));return;}console[_0x56369a(0xfa)]('✅\x20[CHECK]\x20Payment\x20'+_0x394a01+_0x56369a(0x160)),await this[_0x56369a(0x13d)](_0x13fbe4);}['logCoinToPayStatus'](_0xa28a58,_0x30fa6b,_0x3c9056,_0xbf62a1,_0x4d4879,_0x122e88){const _0x20d902=a38_0x33a1c7,_0xd476fd={'type':_0x20d902(0x101),'paymentId':_0xa28a58,'gatewayPaymentId':_0x30fa6b,'oldStatus':_0x3c9056,'newStatus':_0xbf62a1,'source':_0x4d4879,'timestamp':new Date()['toISOString'](),'details':_0x122e88||{}};loggerService_1[_0x20d902(0x100)]['logCoinToPayStatus'](_0xd476fd),console[_0x20d902(0xfa)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0xa28a58+'\x20('+_0x30fa6b+')'),console[_0x20d902(0xfa)]('\x20\x20\x20📊\x20Status:\x20'+_0x3c9056+_0x20d902(0x17f)+_0xbf62a1),console[_0x20d902(0xfa)]('\x20\x20\x20📍\x20Source:\x20'+_0x4d4879),console[_0x20d902(0xfa)](_0x20d902(0x1d6)+_0xd476fd['timestamp']),_0x122e88&&console[_0x20d902(0xfa)](_0x20d902(0x1c4),_0x122e88);}['logCoinToPayError'](_0x36dc36,_0x5ca21b,_0x11b190,_0x2d8423,_0x17aad4){const _0x2e5c68=a38_0x33a1c7,_0x484270={'type':_0x2e5c68(0x12b),'paymentId':_0x36dc36,'gatewayPaymentId':_0x5ca21b,'error':_0x11b190 instanceof Error?{'message':_0x11b190[_0x2e5c68(0x164)],'stack':_0x11b190['stack']}:_0x11b190,'source':_0x2d8423,'timestamp':new Date()['toISOString'](),'context':_0x17aad4||{}};loggerService_1[_0x2e5c68(0x100)][_0x2e5c68(0x106)](_0x484270),console[_0x2e5c68(0x1e5)](_0x2e5c68(0x152)+_0x36dc36+'\x20('+_0x5ca21b+')'),console[_0x2e5c68(0x1e5)](_0x2e5c68(0x134)+(_0x11b190 instanceof Error?_0x11b190[_0x2e5c68(0x164)]:_0x11b190)),console[_0x2e5c68(0x1e5)](_0x2e5c68(0x197)+_0x2d8423),console[_0x2e5c68(0x1e5)]('\x20\x20\x20📅\x20Time:\x20'+_0x484270[_0x2e5c68(0xf2)]),_0x17aad4&&console['error']('\x20\x20\x20📝\x20Context:',_0x17aad4);}['startPeriodicStatusCheck'](){const _0x344bec=a38_0x33a1c7;console[_0x344bec(0xfa)]('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x344bec(0xe7)]()['catch'](_0x10ac27=>{const _0x5dd969=_0x344bec;console[_0x5dd969(0x1e5)]('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x10ac27);}),this[_0x344bec(0x198)]=setInterval(async()=>{const _0x2ea17e=_0x344bec;try{console['log'](_0x2ea17e(0x1a5)),await this[_0x2ea17e(0xe7)](),console[_0x2ea17e(0xfa)](_0x2ea17e(0x1c0));}catch(_0x220daa){console['error']('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x220daa);}},this[_0x344bec(0x149)]),console['log'](_0x344bec(0x1b3));}[a38_0x33a1c7(0x1e6)](){const _0x34f22f=a38_0x33a1c7;console['log']('🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x34f22f(0x198)]&&(clearInterval(this[_0x34f22f(0x198)]),this[_0x34f22f(0x198)]=null,console[_0x34f22f(0xfa)](_0x34f22f(0x1e1)));const _0x53e6a8=this['paymentTimers']['size'];for(const [_0x3a9b9c]of this[_0x34f22f(0x14b)]){this[_0x34f22f(0x15a)](_0x3a9b9c);}console[_0x34f22f(0xfa)](_0x34f22f(0x1e8)+_0x53e6a8+_0x34f22f(0x15c));}async[a38_0x33a1c7(0xe7)](){const _0x1afb40=a38_0x33a1c7;try{console[_0x1afb40(0xfa)](_0x1afb40(0x1ae));const _0x4ea2bf=await database_1[_0x1afb40(0x1ea)]['payment'][_0x1afb40(0x12d)]({'where':{'gateway':{'in':['cointopay',_0x1afb40(0x1e4)]},'status':_0x1afb40(0x151),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x1afb40(0xfa)](_0x1afb40(0xf7)+_0x4ea2bf[_0x1afb40(0x16f)]+_0x1afb40(0x1d3));if(_0x4ea2bf[_0x1afb40(0x16f)]===0x0){console[_0x1afb40(0xfa)](_0x1afb40(0xed));return;}const _0x1cb91b=await this[_0x1afb40(0x125)](_0x4ea2bf);console[_0x1afb40(0xfa)](_0x1afb40(0x156)+_0x1cb91b[_0x1afb40(0x16f)]+_0x1afb40(0x11f));let _0xe23ca7=0x0,_0x37757a=0x0;for(const _0x2ff924 of _0x4ea2bf){try{if(_0x1cb91b[_0x1afb40(0xef)](_0x2ff924['id'])){console[_0x1afb40(0xfa)](_0x1afb40(0x178)+_0x2ff924['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x37757a++;continue;}if(this['paymentTimers'][_0x1afb40(0x1a0)](_0x2ff924['id'])){console[_0x1afb40(0xfa)](_0x1afb40(0x178)+_0x2ff924['id']+_0x1afb40(0x1ec)),_0x37757a++;continue;}const _0x2dad44=(Date[_0x1afb40(0x145)]()-_0x2ff924['createdAt'][_0x1afb40(0xec)]())/(0x3e8*0x3c*0x3c);if(_0x2dad44<0x1){console[_0x1afb40(0xfa)](_0x1afb40(0x178)+_0x2ff924['id']+_0x1afb40(0x10b)+_0x2dad44[_0x1afb40(0x17b)](0x1)+_0x1afb40(0x1bf)),_0x37757a++;continue;}console[_0x1afb40(0xfa)]('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x2ff924['id']+_0x1afb40(0x153)+_0x2dad44['toFixed'](0x1)+'h)'),await this[_0x1afb40(0x13d)](_0x2ff924),_0xe23ca7++,await new Promise(_0x4d1313=>setTimeout(_0x4d1313,0x7d0));}catch(_0xbce810){console[_0x1afb40(0x1e5)](_0x1afb40(0x165)+_0x2ff924['id']+':',_0xbce810),this[_0x1afb40(0x106)](_0x2ff924['id'],_0x2ff924[_0x1afb40(0x183)]||_0x1afb40(0x188),_0xbce810,_0x1afb40(0x14a),{'isGlobalCheck':!![],'paymentAmount':_0x2ff924[_0x1afb40(0x195)],'paymentCurrency':_0x2ff924[_0x1afb40(0x196)],'shopId':_0x2ff924[_0x1afb40(0x1d2)],'createdAt':_0x2ff924[_0x1afb40(0x102)]}),loggerService_1[_0x1afb40(0x100)][_0x1afb40(0x1df)](_0x1afb40(0x136),_0x1afb40(0x161)+_0x2ff924['gatewayPaymentId'],_0xbce810);}}console['log'](_0x1afb40(0x12a)+_0xe23ca7+_0x1afb40(0xfd)+_0x37757a+'\x20skipped,\x20'+_0x1cb91b['length']+_0x1afb40(0x13f));}catch(_0x1522e0){console[_0x1afb40(0x1e5)](_0x1afb40(0xff),_0x1522e0);}}async[a38_0x33a1c7(0x125)](_0x59b1e0){const _0x5437e7=a38_0x33a1c7,_0x3c0232=[],_0x2ff5e5=new Date();_0x2ff5e5[_0x5437e7(0x10e)](_0x2ff5e5['getDate']()-this[_0x5437e7(0x1bd)]),console[_0x5437e7(0xfa)](_0x5437e7(0x1cd)+this[_0x5437e7(0x1bd)]+_0x5437e7(0x189)+_0x2ff5e5['toISOString']()+')');for(const _0x5b5a96 of _0x59b1e0){if(_0x5b5a96[_0x5437e7(0x102)]<_0x2ff5e5){console[_0x5437e7(0xfa)](_0x5437e7(0x154)+_0x5b5a96['id']+_0x5437e7(0x112)+this[_0x5437e7(0x1bd)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this['logCoinToPayStatus'](_0x5b5a96['id'],_0x5b5a96['gatewayPaymentId']||_0x5437e7(0x188),_0x5437e7(0x151),'EXPIRED',_0x5437e7(0x19f),{'reason':_0x5437e7(0x1aa)+this[_0x5437e7(0x1bd)]+_0x5437e7(0x192),'createdAt':_0x5b5a96[_0x5437e7(0x102)],'daysSinceCreation':Math[_0x5437e7(0x175)]((Date['now']()-_0x5b5a96['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x5b5a96[_0x5437e7(0x195)],'paymentCurrency':_0x5b5a96[_0x5437e7(0x196)],'shopId':_0x5b5a96[_0x5437e7(0x1d2)]}),await database_1[_0x5437e7(0x1ea)][_0x5437e7(0x180)][_0x5437e7(0x1e7)]({'where':{'id':_0x5b5a96['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x5437e7(0x1bd)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1['default'][_0x5437e7(0x122)][_0x5437e7(0x10f)]({'data':{'paymentId':_0x5b5a96['id'],'shopId':_0x5b5a96[_0x5437e7(0x1d2)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x5437e7(0x1e2)]({'reason':'Payment\x20older\x20than\x20'+this[_0x5437e7(0x1bd)]+_0x5437e7(0x192),'createdAt':_0x5b5a96[_0x5437e7(0x102)],'expiredAt':new Date()[_0x5437e7(0xea)](),'daysSinceCreation':Math[_0x5437e7(0x175)]((Date[_0x5437e7(0x145)]()-_0x5b5a96[_0x5437e7(0x102)][_0x5437e7(0xec)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x5437e7(0x11c)](_0x5b5a96,_0x5437e7(0x16e)),await this['sendPaymentStatusNotification'](_0x5b5a96,_0x5437e7(0x16e)),this[_0x5437e7(0x15a)](_0x5b5a96['id']),_0x3c0232[_0x5437e7(0x15f)](_0x5b5a96['id']),console[_0x5437e7(0xfa)](_0x5437e7(0x1a4)+_0x5b5a96['id']+_0x5437e7(0x167)+this[_0x5437e7(0x1bd)]+'-day\x20timeout');}catch(_0x57c91a){console[_0x5437e7(0x1e5)](_0x5437e7(0x141)+_0x5b5a96['id']+':',_0x57c91a),this[_0x5437e7(0x106)](_0x5b5a96['id'],_0x5b5a96[_0x5437e7(0x183)]||_0x5437e7(0x188),_0x57c91a,_0x5437e7(0x19f),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x5b5a96[_0x5437e7(0x102)],'daysSinceCreation':Math[_0x5437e7(0x175)]((Date['now']()-_0x5b5a96[_0x5437e7(0x102)][_0x5437e7(0xec)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x3c0232;}async[a38_0x33a1c7(0x13d)](_0x50f5b9){const _0x32ad3c=a38_0x33a1c7;if(!_0x50f5b9[_0x32ad3c(0x183)]){console[_0x32ad3c(0xfa)](_0x32ad3c(0x1dc)+_0x50f5b9['id']+_0x32ad3c(0x114));return;}console[_0x32ad3c(0xfa)](_0x32ad3c(0x139)+_0x50f5b9[_0x32ad3c(0x1b9)]+_0x32ad3c(0x1cb)+_0x50f5b9['id']+'\x20('+_0x50f5b9[_0x32ad3c(0x183)]+')');try{let _0x3af6ff;_0x50f5b9[_0x32ad3c(0x1b9)]===_0x32ad3c(0x1e4)?(_0x3af6ff=await this[_0x32ad3c(0x1ad)][_0x32ad3c(0x1d5)](_0x50f5b9[_0x32ad3c(0x183)]),console[_0x32ad3c(0xfa)]('📊\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x50f5b9['id']+'\x20status:\x20'+_0x3af6ff['status'])):(_0x3af6ff=await this[_0x32ad3c(0x13e)][_0x32ad3c(0x1d5)](_0x50f5b9[_0x32ad3c(0x183)]),console['log']('📊\x20[CHECK]\x20CoinToPay\x20payment\x20'+_0x50f5b9['id']+_0x32ad3c(0x1d7)+_0x3af6ff[_0x32ad3c(0x117)]));_0x3af6ff[_0x32ad3c(0x1a9)]&&console[_0x32ad3c(0xfa)](_0x32ad3c(0x186)+_0x50f5b9['id']+_0x32ad3c(0x147),{'iban':_0x3af6ff['paymentDetails'][_0x32ad3c(0x12f)]||'not\x20found','transactionId':_0x3af6ff['paymentDetails']['transactionId'],'createdOn':_0x3af6ff[_0x32ad3c(0x1a9)][_0x32ad3c(0x179)],'confirmedOn':_0x3af6ff[_0x32ad3c(0x1a9)][_0x32ad3c(0x1da)]||_0x32ad3c(0xe9)});if(_0x3af6ff[_0x32ad3c(0x117)]!==_0x50f5b9[_0x32ad3c(0x117)]){console[_0x32ad3c(0xfa)](_0x32ad3c(0x1c5)+_0x50f5b9['id']+'\x20status\x20from\x20'+_0x50f5b9[_0x32ad3c(0x117)]+_0x32ad3c(0x1ba)+_0x3af6ff[_0x32ad3c(0x117)]),this['logCoinToPayStatus'](_0x50f5b9['id'],_0x50f5b9[_0x32ad3c(0x183)],_0x50f5b9[_0x32ad3c(0x117)],_0x3af6ff[_0x32ad3c(0x117)],_0x32ad3c(0x14a),{'paymentDetails':_0x3af6ff[_0x32ad3c(0x1a9)],'amount':_0x3af6ff['amount'],'currency':_0x3af6ff[_0x32ad3c(0x196)],'shopId':_0x50f5b9[_0x32ad3c(0x1d2)],'checkTimestamp':new Date()['toISOString']()});const _0x5ac21a={'status':_0x3af6ff[_0x32ad3c(0x117)],'updatedAt':new Date()};if(_0x3af6ff['status']===_0x32ad3c(0x1b2)&&_0x50f5b9[_0x32ad3c(0x117)]!==_0x32ad3c(0x1b2)){_0x5ac21a[_0x32ad3c(0x12e)]=new Date();if(!_0x50f5b9['amountUSDT']){const _0x53fbf5=await currencyService_1[_0x32ad3c(0x1dd)][_0x32ad3c(0x1de)](_0x50f5b9[_0x32ad3c(0x195)],_0x50f5b9[_0x32ad3c(0x196)]);_0x5ac21a[_0x32ad3c(0x107)]=_0x53fbf5;const _0x2d634d=await this[_0x32ad3c(0xf1)](_0x50f5b9['shopId'],_0x50f5b9[_0x32ad3c(0x1b9)]),_0x42d9ec=_0x53fbf5*(0x1-_0x2d634d/0x64);_0x5ac21a[_0x32ad3c(0x130)]=_0x42d9ec,_0x5ac21a[_0x32ad3c(0xfc)]=_0x2d634d,console[_0x32ad3c(0xfa)](_0x32ad3c(0x155)+_0x50f5b9['id']+'\x20amounts\x20calculated:'),console['log'](_0x32ad3c(0x187)+_0x50f5b9[_0x32ad3c(0x195)]+'\x20'+_0x50f5b9[_0x32ad3c(0x196)]+_0x32ad3c(0x17f)+_0x53fbf5[_0x32ad3c(0x17b)](0x6)+_0x32ad3c(0x1d1)),console[_0x32ad3c(0xfa)](_0x32ad3c(0x127)+_0x50f5b9[_0x32ad3c(0x1b9)]+'\x20commission:\x20'+_0x2d634d+'%'),console[_0x32ad3c(0xfa)](_0x32ad3c(0x1e9)+_0x42d9ec[_0x32ad3c(0x17b)](0x6)+_0x32ad3c(0x1d1));}console[_0x32ad3c(0xfa)](_0x32ad3c(0x155)+_0x50f5b9['id']+_0x32ad3c(0x1bc)+_0x5ac21a[_0x32ad3c(0x12e)]['toISOString']());}if(_0x3af6ff[_0x32ad3c(0x1a9)]){const _0x5228d0=_0x3af6ff[_0x32ad3c(0x1a9)];_0x5228d0['iban']&&(_0x5ac21a[_0x32ad3c(0x1a8)]=_0x5228d0[_0x32ad3c(0x12f)],console['log'](_0x32ad3c(0x105)+_0x5228d0['iban']));if(_0x5228d0[_0x32ad3c(0xf3)]){const _0x166621=_0x50f5b9[_0x32ad3c(0x193)]||'',_0x5ec195='Bank\x20Details:\x20'+_0x5228d0[_0x32ad3c(0xf3)];_0x5ac21a[_0x32ad3c(0x193)]=_0x166621?_0x166621+'\x0a\x0a'+_0x5ec195:_0x5ec195,console[_0x32ad3c(0xfa)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x5228d0[_0x32ad3c(0xfb)]&&console[_0x32ad3c(0xfa)]('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x5228d0[_0x32ad3c(0xfb)]),_0x5228d0['confirmedOn']&&console[_0x32ad3c(0xfa)](_0x32ad3c(0x11a)+_0x5228d0['confirmedOn']);}await database_1['default'][_0x32ad3c(0x180)][_0x32ad3c(0x1e7)]({'where':{'id':_0x50f5b9['id']},'data':_0x5ac21a});if(_0x3af6ff[_0x32ad3c(0x117)]===_0x32ad3c(0x1b2)&&_0x50f5b9['status']!=='PAID'){console[_0x32ad3c(0xfa)](_0x32ad3c(0x143)+_0x50f5b9['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x3c6fe1=await database_1[_0x32ad3c(0x1ea)][_0x32ad3c(0x180)][_0x32ad3c(0x118)]({'where':{'id':_0x50f5b9['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x3c6fe1?.[_0x32ad3c(0x19d)]&&_0x3c6fe1['paymentLink'])try{const _0x1c5607=_0x3c6fe1[_0x32ad3c(0xe6)];console['log']('📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x1c5607['id']+_0x32ad3c(0x140)+_0x1c5607['type']+_0x32ad3c(0x123)+_0x1c5607[_0x32ad3c(0x1d0)]+_0x32ad3c(0xf4)+_0x1c5607[_0x32ad3c(0x117)]);const _0x4fe5ce=_0x1c5607[_0x32ad3c(0x1d0)]+0x1,_0x386deb=_0x1c5607[_0x32ad3c(0x174)]===_0x32ad3c(0xfe)?'COMPLETED':_0x1c5607['status'];await database_1[_0x32ad3c(0x1ea)]['paymentLink'][_0x32ad3c(0x1e7)]({'where':{'id':_0x1c5607['id']},'data':{'currentPayments':_0x4fe5ce,'status':_0x386deb,'updatedAt':new Date()}}),console[_0x32ad3c(0xfa)](_0x32ad3c(0x11d)+_0x1c5607['id']+_0x32ad3c(0x18e)+_0x1c5607[_0x32ad3c(0x1d0)]+_0x32ad3c(0x17f)+_0x4fe5ce+',\x20status='+_0x1c5607['status']+_0x32ad3c(0x17f)+_0x386deb);}catch(_0x14e232){console[_0x32ad3c(0x1e5)](_0x32ad3c(0x14e),_0x14e232);}else console[_0x32ad3c(0xfa)](_0x32ad3c(0x143)+_0x50f5b9['id']+_0x32ad3c(0x1bb));}await database_1[_0x32ad3c(0x1ea)][_0x32ad3c(0x122)][_0x32ad3c(0x10f)]({'data':{'paymentId':_0x50f5b9['id'],'shopId':_0x50f5b9[_0x32ad3c(0x1d2)],'event':_0x32ad3c(0x18b)+_0x3af6ff[_0x32ad3c(0x117)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x32ad3c(0x1e2)]({'oldStatus':_0x50f5b9[_0x32ad3c(0x117)],'newStatus':_0x3af6ff[_0x32ad3c(0x117)],'paymentDetails':_0x3af6ff['paymentDetails'],'checkedAt':new Date()['toISOString']()})}}),await this[_0x32ad3c(0x11c)](_0x50f5b9,_0x3af6ff[_0x32ad3c(0x117)]),await this[_0x32ad3c(0xf0)](_0x50f5b9,_0x3af6ff[_0x32ad3c(0x117)]),_0x3af6ff[_0x32ad3c(0x117)]!==_0x32ad3c(0x151)&&(console[_0x32ad3c(0xfa)](_0x32ad3c(0xe5)+_0x50f5b9['id']+_0x32ad3c(0x1b7)+_0x3af6ff[_0x32ad3c(0x117)]+_0x32ad3c(0x142)),this[_0x32ad3c(0x15a)](_0x50f5b9['id'])),console[_0x32ad3c(0xfa)](_0x32ad3c(0x110)+_0x50f5b9['id']+_0x32ad3c(0x13b));}else console[_0x32ad3c(0xfa)]('📊\x20[CHECK]\x20Payment\x20'+_0x50f5b9['id']+'\x20status\x20unchanged\x20('+_0x3af6ff[_0x32ad3c(0x117)]+')'),this[_0x32ad3c(0x181)](_0x50f5b9['id'],_0x50f5b9[_0x32ad3c(0x183)],_0x50f5b9[_0x32ad3c(0x117)],_0x3af6ff['status'],_0x32ad3c(0x14a),{'statusUnchanged':!![],'paymentDetails':_0x3af6ff[_0x32ad3c(0x1a9)],'amount':_0x3af6ff['amount'],'currency':_0x3af6ff[_0x32ad3c(0x196)],'shopId':_0x50f5b9[_0x32ad3c(0x1d2)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x44051b){console[_0x32ad3c(0x1e5)](_0x32ad3c(0x15b)+_0x50f5b9['id']+':',_0x44051b),this[_0x32ad3c(0x106)](_0x50f5b9['id'],_0x50f5b9[_0x32ad3c(0x183)],_0x44051b,'status_check',{'paymentAmount':_0x50f5b9[_0x32ad3c(0x195)],'paymentCurrency':_0x50f5b9[_0x32ad3c(0x196)],'shopId':_0x50f5b9[_0x32ad3c(0x1d2)],'createdAt':_0x50f5b9[_0x32ad3c(0x102)]}),await database_1[_0x32ad3c(0x1ea)]['webhookLog'][_0x32ad3c(0x10f)]({'data':{'paymentId':_0x50f5b9['id'],'shopId':_0x50f5b9[_0x32ad3c(0x1d2)],'event':_0x32ad3c(0x11b),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x44051b instanceof Error?_0x44051b[_0x32ad3c(0x164)]:_0x32ad3c(0x1cf),'gatewayPaymentId':_0x50f5b9[_0x32ad3c(0x183)],'checkedAt':new Date()[_0x32ad3c(0xea)]()})}});}}async['sendShopWebhook'](_0x4a6a58,_0x6dc033){const _0xdb1fe=a38_0x33a1c7,_0x56f957=Date[_0xdb1fe(0x145)]();try{const _0x37f89b=_0x4a6a58[_0xdb1fe(0x1b0)],_0x13473d=_0x37f89b[_0xdb1fe(0x190)];if(!_0x13473d?.['webhookUrl']){console[_0xdb1fe(0xfa)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x37f89b['id']);return;}const _0x372c6e=_0x6dc033==='PAID'?_0xdb1fe(0x1a1):_0x6dc033===_0xdb1fe(0x185)?_0xdb1fe(0x1c2):_0x6dc033===_0xdb1fe(0x16e)?'payment.failed':_0xdb1fe(0x159);if(!_0x13473d[_0xdb1fe(0x126)]?.[_0xdb1fe(0xef)](_0x372c6e)){console[_0xdb1fe(0xfa)](_0xdb1fe(0x163)+_0x372c6e+'\x20not\x20enabled\x20for\x20shop\x20'+_0x37f89b['id']);return;}const _0x58374a=(0x0,gateway_1[_0xdb1fe(0x194)])(_0x4a6a58[_0xdb1fe(0x1b9)])||_0x4a6a58[_0xdb1fe(0x1b9)],_0x104f52={'event':_0x372c6e,'payment':{'id':_0x4a6a58['id'],'order_id':_0x4a6a58[_0xdb1fe(0x1c9)],'gateway_order_id':_0x4a6a58[_0xdb1fe(0x132)],'gateway':_0x58374a,'amount':_0x4a6a58[_0xdb1fe(0x195)],'currency':_0x4a6a58['currency'],'status':_0x6dc033['toLowerCase'](),'customer_email':_0x4a6a58['customerEmail'],'customer_name':_0x4a6a58[_0xdb1fe(0x158)],'created_at':_0x4a6a58[_0xdb1fe(0x102)],'updated_at':new Date()}},_0x258150=await fetch(_0x13473d[_0xdb1fe(0x170)],{'method':'POST','headers':{'Content-Type':_0xdb1fe(0x162),'User-Agent':_0xdb1fe(0x1e3)},'body':JSON[_0xdb1fe(0x1e2)](_0x104f52)}),_0x33d315=Date[_0xdb1fe(0x145)]()-_0x56f957,_0x6b2a71=_0x258150['ok']?_0xdb1fe(0x133):await _0x258150['text']();loggerService_1[_0xdb1fe(0x100)]['logShopWebhookSent'](_0x4a6a58[_0xdb1fe(0x1d2)],_0x13473d['webhookUrl'],_0x372c6e,_0x258150[_0xdb1fe(0x117)],_0x33d315,_0x104f52),console[_0xdb1fe(0xfa)](_0xdb1fe(0x14f)+_0x13473d['webhookUrl']+'\x20with\x20status\x20'+_0x258150['status']+'\x20('+_0x33d315+_0xdb1fe(0x14c));}catch(_0x545f25){console[_0xdb1fe(0x1e5)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x545f25),loggerService_1[_0xdb1fe(0x100)][_0xdb1fe(0x116)](_0x4a6a58['shopId'],_0x4a6a58[_0xdb1fe(0x1b0)]?.[_0xdb1fe(0x190)]?.['webhookUrl']||_0xdb1fe(0x188),_0xdb1fe(0x191),_0x545f25,{});}}async[a38_0x33a1c7(0xf0)](_0x15f322,_0x46fe8a){const _0x5404ae=a38_0x33a1c7;try{const _0x4f40d={'PENDING':_0x5404ae(0x104),'PAID':'paid','FAILED':_0x5404ae(0xf6),'EXPIRED':_0x5404ae(0x119)},_0x598eab=_0x4f40d[_0x46fe8a];if(!_0x598eab||_0x598eab==='created')return;await telegramBotService_1[_0x5404ae(0xe4)][_0x5404ae(0x1d9)](_0x15f322['shopId'],_0x15f322,_0x598eab);}catch(_0x9a2f84){console['error'](_0x5404ae(0x109),_0x9a2f84);}}async[a38_0x33a1c7(0x1b4)](_0x4afec6){const _0xb6ec9f=a38_0x33a1c7;console[_0xb6ec9f(0xfa)]('🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x4afec6);const _0x449187=await database_1[_0xb6ec9f(0x1ea)]['payment']['findUnique']({'where':{'id':_0x4afec6},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x449187)throw new Error(_0xb6ec9f(0x19c));if(_0x449187[_0xb6ec9f(0x1b9)]!==_0xb6ec9f(0x136)&&_0x449187[_0xb6ec9f(0x1b9)]!==_0xb6ec9f(0x1e4))throw new Error(_0xb6ec9f(0x17d));console['log'](_0xb6ec9f(0x10a)+_0x449187['gateway']+_0xb6ec9f(0x1cb)+_0x4afec6),await this[_0xb6ec9f(0x13d)](_0x449187),console[_0xb6ec9f(0xfa)](_0xb6ec9f(0x111)+_0x4afec6);}[a38_0x33a1c7(0x13a)](){const _0x11b97e=a38_0x33a1c7,_0xc68e28=this[_0x11b97e(0x198)]?this[_0x11b97e(0x149)]:undefined,_0x28bfc0=Array[_0x11b97e(0x115)](this[_0x11b97e(0x14b)][_0x11b97e(0xf5)]())[_0x11b97e(0x1a3)](_0x3c15d5=>({'paymentId':_0x3c15d5[_0x11b97e(0x18d)],'gatewayPaymentId':_0x3c15d5[_0x11b97e(0x183)],'createdAt':_0x3c15d5[_0x11b97e(0x102)],'timersCount':_0x3c15d5[_0x11b97e(0x1ce)][_0x11b97e(0x16f)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x11b97e(0x1bd)],'activeIndividualTimers':this[_0x11b97e(0x14b)][_0x11b97e(0x1b1)],'nextGlobalCheckIn':_0xc68e28,'paymentTimersDetails':_0x28bfc0};}[a38_0x33a1c7(0x13c)](_0x1cb9c0){const _0x5ab403=a38_0x33a1c7,_0x17bc41=this[_0x5ab403(0x14b)][_0x5ab403(0x1be)](_0x1cb9c0);if(_0x17bc41)return{'hasTimers':!![],'timersCount':_0x17bc41[_0x5ab403(0x1ce)][_0x5ab403(0x16f)],'createdAt':_0x17bc41[_0x5ab403(0x102)],'gatewayPaymentId':_0x17bc41[_0x5ab403(0x183)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0x483123,_0x103c4e){const _0xffc43a=a38_0x33a1c7;try{const _0x25a8d0=await database_1[_0xffc43a(0x1ea)][_0xffc43a(0x1b0)]['findUnique']({'where':{'id':_0x483123},'select':{'gatewaySettings':!![]}});if(!_0x25a8d0?.[_0xffc43a(0x1a7)])return console[_0xffc43a(0xfa)](_0xffc43a(0x15e)+_0x483123+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x18caed=JSON['parse'](_0x25a8d0[_0xffc43a(0x1a7)]);for(const [_0x359779,_0x4c6ffa]of Object[_0xffc43a(0x18a)](_0x18caed)){if(_0x359779['toLowerCase']()===_0x103c4e['toLowerCase']()){const _0x1a1989=_0x4c6ffa[_0xffc43a(0xf9)]||0xa;return console['log'](_0xffc43a(0x172)+_0x103c4e+_0xffc43a(0x138)+_0x483123+':\x20'+_0x1a1989+'%'),_0x1a1989;}}return console[_0xffc43a(0xfa)](_0xffc43a(0x1eb)+_0x103c4e+_0xffc43a(0x1ed)+_0x483123+_0xffc43a(0x1a6)),0xa;}catch(_0x23e53b){return console[_0xffc43a(0x1e5)](_0xffc43a(0x1b6)+_0x483123+_0xffc43a(0x16d)+_0x103c4e+':',_0x23e53b),0xa;}}}exports[a38_0x33a1c7(0x17a)]=CoinToPayStatusService,exports[a38_0x33a1c7(0x1e0)]=new CoinToPayStatusService();