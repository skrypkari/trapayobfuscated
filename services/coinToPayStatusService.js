'use strict';const a37_0x344b4d=a37_0x279e;function a37_0x279e(_0x5c2812,_0x3830b9){const _0x4b5efe=a37_0x4b5e();return a37_0x279e=function(_0x279ed2,_0x2ab0bb){_0x279ed2=_0x279ed2-0x15f;let _0x24c1af=_0x4b5efe[_0x279ed2];return _0x24c1af;},a37_0x279e(_0x5c2812,_0x3830b9);}(function(_0x5297c5,_0x5f05e6){const _0x163c17=a37_0x279e,_0xd2df3a=_0x5297c5();while(!![]){try{const _0x47cf2f=-parseInt(_0x163c17(0x1cb))/0x1*(parseInt(_0x163c17(0x24d))/0x2)+parseInt(_0x163c17(0x170))/0x3*(parseInt(_0x163c17(0x248))/0x4)+-parseInt(_0x163c17(0x19f))/0x5*(-parseInt(_0x163c17(0x20c))/0x6)+-parseInt(_0x163c17(0x1ad))/0x7+parseInt(_0x163c17(0x1b1))/0x8*(-parseInt(_0x163c17(0x1f1))/0x9)+parseInt(_0x163c17(0x1fc))/0xa*(-parseInt(_0x163c17(0x165))/0xb)+-parseInt(_0x163c17(0x214))/0xc*(-parseInt(_0x163c17(0x218))/0xd);if(_0x47cf2f===_0x5f05e6)break;else _0xd2df3a['push'](_0xd2df3a['shift']());}catch(_0x458d41){_0xd2df3a['push'](_0xd2df3a['shift']());}}}(a37_0x4b5e,0x196ee));var __importDefault=this&&this[a37_0x344b4d(0x23f)]||function(_0x5ab8bd){const _0x26256a=a37_0x344b4d;return _0x5ab8bd&&_0x5ab8bd[_0x26256a(0x168)]?_0x5ab8bd:{'default':_0x5ab8bd};};Object['defineProperty'](exports,a37_0x344b4d(0x168),{'value':!![]}),exports[a37_0x344b4d(0x19a)]=exports[a37_0x344b4d(0x196)]=void 0x0;const coinToPayService_1=require(a37_0x344b4d(0x245)),database_1=__importDefault(require(a37_0x344b4d(0x1e1))),telegramBotService_1=require(a37_0x344b4d(0x17c)),loggerService_1=require(a37_0x344b4d(0x239));function a37_0x4b5e(){const _0x4679c3=['✅\x20[CHECK]\x20Payment\x20','\x20triggered\x20for\x20payment\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','Automatically\x20expired\x20after\x20','\x20marked\x20as\x20paid\x20at:\x20','paymentTimers','\x20days\x20(created\x20before\x20','logWhiteDomainError','getTime','webhook_send','Shop\x20webhook\x20sent\x20to\x20','72lHqVKJ','⚠️\x20[CHECK]\x20Payment\x20','settings','Payment\x20older\x20than\x20','\x20\x20\x20📅\x20Time:\x20','1\x20minute','\x20pending\x20CoinToPay\x20payments','⏰\x20[GLOBAL]\x20Payment\x20','floor','getServiceStats','\x20expired','67850oBNeWb','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','🧹\x20[CHECK]\x20Payment\x20','schedule_created','telegramBotService','toLowerCase','\x20with\x20status\x20','EXPIRY_DAYS','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','POST','gatewayOrderId','\x20checked,\x20','globalCheckInterval','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','description','155556oVDBTi','\x20not\x20enabled\x20for\x20shop\x20','stack','gateway','0100','💰\x20[CHECK]\x20Payment\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','4692180hykYRU','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20(age:\x20','cointopay_auto_expired','13BXDcVx','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','timers','\x20initial\x20timers\x20for\x20payment\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','Bank\x20Details:\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','not\x20confirmed','❌\x20[HOURLY]\x20Payment\x20','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','iban','status_check','🪙\x20[DEBUG]\x20Creating\x20','⏰\x20[GLOBAL]\x20Found\x20','log','\x20days\x20without\x20payment\x20confirmation','error','now','\x20\x20\x20📍\x20Source:\x20','\x20\x20\x20-\x20Amount:\x20','\x20completed\x20for\x20payment\x20','Unknown\x20error','findMany','\x20timers\x20for\x20payment\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20status\x20is\x20','\x20\x20\x20📝\x20Details:','application/json','checkExpiredPayments','push','\x20has\x20no\x20gatewayPaymentId','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','message','./loggerService','create','delete','COINTOPAY_STATUS_CHANGE','Success','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','__importDefault','payment','loggerService','❌\x20[CHECK]\x20Payment\x20','\x20individual\x20payment\x20timers','\x20\x20\x20-\x20paymentId:\x20','./gateways/coinToPayService','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','.\x20Remaining\x20active\x20timers:\x20','22280vInLkH','5\x20minutes','toISOString','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','logShopWebhookError','259346vysOlI','✅\x20[TIMER]\x20Individual\x20check\x20#','created','logCoinToPayError','checkPaymentById','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','COINTOPAY_ERROR','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','createdOn','99yNEYgs','checkSinglePayment','PENDING','__esModule','default','webhookLog','currency','\x20for\x20payment\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20->\x20','sendShopWebhook','9lEPbgp','getDate','Failed\x20to\x20send\x20shop\x20webhook:','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','customerEmail','delay','payment.pending','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','timestamp','/status/','webhookUrl','transactionId','./telegramBotService','catch','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','\x20status:\x20','text','logCoinToPayStatus','\x20days,\x20marking\x20as\x20EXPIRED','customerName','size','failed','\x20\x20\x20📝\x20Context:','\x20status\x20changed\x20to\x20','🔄\x20[CHECK]\x20Updating\x20payment\x20','paymentId','toFixed','\x20in\x20','sendPaymentStatusNotification','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','stopPeriodicStatusCheck','\x20is\x20too\x20new\x20(','Webhook\x20event\x20','startPeriodicStatusCheck','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','CoinToPayStatusService','checkAllPendingPayments','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','coinToPayStatusService','setDate','findUnique','webhookEvents','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','15NeoavQ','sendPaymentNotification','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','confirmedOn','gatewayPaymentId','📊\x20[HOURLY]\x20Payment\x20','h),\x20skipping\x20global\x20check','\x20\x20\x20-\x20Gateway:\x20','length','📊\x20[CHECK]\x20Payment\x20','bankDetails','from','values','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','1162721rnVYYv','TesSoft\x20Payment\x20System/1.0','unknown','EXPIRED','24488iHFtno','GLOBAL_CHECK_INTERVAL_MS','CoinToPayService','🪙\x20[GLOBAL]\x20Found\x20','status','\x20details:','\x20\x20\x20-\x20GatewayPaymentId:\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20to\x20','PAID','checkSinglePaymentById','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','shopId','paymentDetails','\x20to\x20clear','coinToPayService','✅\x20[HOURLY]\x20Payment\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','update',',\x20stopping\x20individual\x20checks','auto_expire','createdAt','2\x20minutes','forEach','\x20days','clearPaymentTimers','1xKMGAa','\x20skipped,\x20','paidAt','payment.failed','\x20expired\x20CoinToPay\x20payments','get','checkPaymentStatus','not\x20found','FAILED','shop','🛑\x20[SHUTDOWN]\x20Cleared\x20','amount','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','paid','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20is\x20older\x20than\x20','🪙\x20CoinToPayStatusService\x20initialized','\x20status\x20from\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','stringify','cointopay_status_check_error','../config/database','⏰\x20[EXPIRY]\x20Payment\x20','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','cointopay'];a37_0x4b5e=function(){return _0x4679c3;};return a37_0x4b5e();}class CoinToPayStatusService{constructor(){const _0x44ad65=a37_0x344b4d;this[_0x44ad65(0x209)]=null,this[_0x44ad65(0x1b2)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this['paymentTimers']=new Map(),this[_0x44ad65(0x1c0)]=new coinToPayService_1[(_0x44ad65(0x1b3))](),console['log'](_0x44ad65(0x1dc));}['schedulePaymentChecks'](_0x355cf4,_0x8f21a){const _0x35fcde=a37_0x344b4d;console[_0x35fcde(0x226)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x35fcde(0x226)](_0x35fcde(0x244)+_0x355cf4),console[_0x35fcde(0x226)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x8f21a),this[_0x35fcde(0x1ca)](_0x355cf4);const _0x1dfb13=[],_0xa62184=new Date(),_0xa10a32=[{'delay':0x1*0x3c*0x3e8,'description':_0x35fcde(0x1f6)},{'delay':0x2*0x3c*0x3e8,'description':_0x35fcde(0x1c7)},{'delay':0x5*0x3c*0x3e8,'description':_0x35fcde(0x249)},{'delay':0x5*0x3c*0x3e8,'description':_0x35fcde(0x249)}];console[_0x35fcde(0x226)](_0x35fcde(0x224)+_0xa10a32['length']+_0x35fcde(0x21b)+_0x355cf4);let _0x584c7b=0x0;_0xa10a32[_0x35fcde(0x1c8)]((_0x2f1598,_0x2c43f1)=>{const _0x39d621=_0x35fcde;_0x584c7b+=_0x2f1598[_0x39d621(0x175)];const _0xf8b43f=setTimeout(async()=>{const _0x3b72bb=_0x39d621;console[_0x3b72bb(0x226)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x2c43f1+0x1)+_0x3b72bb(0x1e7)+_0x355cf4+'\x20(after\x20'+_0x2f1598[_0x3b72bb(0x20b)]+')');try{await this[_0x3b72bb(0x1bb)](_0x355cf4),console[_0x3b72bb(0x226)](_0x3b72bb(0x24e)+(_0x2c43f1+0x1)+_0x3b72bb(0x22c)+_0x355cf4);}catch(_0x51aca5){console[_0x3b72bb(0x228)](_0x3b72bb(0x180)+(_0x2c43f1+0x1)+_0x3b72bb(0x16c)+_0x355cf4+':',_0x51aca5),this[_0x3b72bb(0x15f)](_0x355cf4,_0x8f21a,_0x51aca5,_0x3b72bb(0x223),{'checkNumber':_0x2c43f1+0x1,'scheduledAfter':_0x2f1598[_0x3b72bb(0x20b)],'isIndividualCheck':!![]});}},_0x584c7b);_0x1dfb13[_0x39d621(0x235)](_0xf8b43f),console[_0x39d621(0x226)](_0x39d621(0x19e)+(_0x2c43f1+0x1)+'\x20for\x20payment\x20'+_0x355cf4+_0x39d621(0x18d)+_0x584c7b/0x3e8+'\x20seconds\x20('+_0x2f1598['description']+')');});const _0x22603b=setInterval(async()=>{const _0x44235f=_0x35fcde;console['log'](_0x44235f(0x1b8)+_0x355cf4);try{const _0x54a3e1=await database_1['default']['payment'][_0x44235f(0x19c)]({'where':{'id':_0x355cf4},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x54a3e1){console[_0x44235f(0x226)](_0x44235f(0x220)+_0x355cf4+'\x20not\x20found,\x20clearing\x20timers'),this['clearPaymentTimers'](_0x355cf4);return;}console[_0x44235f(0x226)](_0x44235f(0x1a4)+_0x355cf4+'\x20current\x20status:\x20'+_0x54a3e1['status']);if(_0x54a3e1[_0x44235f(0x1b5)]!==_0x44235f(0x167)){console[_0x44235f(0x226)](_0x44235f(0x1c1)+_0x355cf4+_0x44235f(0x231)+_0x54a3e1['status']+_0x44235f(0x1c4)),this[_0x44235f(0x1ca)](_0x355cf4);return;}const _0x2db049=Math[_0x44235f(0x1f9)]((Date['now']()-_0x54a3e1['createdAt'][_0x44235f(0x1ee)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x2db049>=this[_0x44235f(0x203)]){console[_0x44235f(0x226)]('⏰\x20[HOURLY]\x20Payment\x20'+_0x355cf4+_0x44235f(0x1db)+this[_0x44235f(0x203)]+_0x44235f(0x205)),this[_0x44235f(0x1ca)](_0x355cf4);return;}await this[_0x44235f(0x1bb)](_0x355cf4),console[_0x44235f(0x226)](_0x44235f(0x230)+_0x355cf4);}catch(_0x1e7afd){console[_0x44235f(0x228)](_0x44235f(0x246)+_0x355cf4+':',_0x1e7afd),this['logCoinToPayError'](_0x355cf4,_0x8f21a,_0x1e7afd,_0x44235f(0x223),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x1dfb13[_0x35fcde(0x235)](_0x22603b),this[_0x35fcde(0x1eb)]['set'](_0x355cf4,{'timers':_0x1dfb13,'paymentId':_0x355cf4,'gatewayPaymentId':_0x8f21a,'createdAt':_0xa62184}),console[_0x35fcde(0x226)](_0x35fcde(0x195)+_0xa10a32[_0x35fcde(0x1a7)]+_0x35fcde(0x1a1)+_0x355cf4),console[_0x35fcde(0x226)]('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x35fcde(0x1eb)]['size']),this['logCoinToPayStatus'](_0x355cf4,_0x8f21a,'PENDING',_0x35fcde(0x167),_0x35fcde(0x223),{'action':_0x35fcde(0x1ff),'scheduledChecks':_0xa10a32[_0x35fcde(0x1a7)],'firstCheckIn':_0xa10a32[0x0]['delay']/0x3e8,'totalTimers':this[_0x35fcde(0x1eb)][_0x35fcde(0x186)]});}['clearPaymentTimers'](_0x3942d3){const _0x211cd8=a37_0x344b4d,_0x428398=this['paymentTimers'][_0x211cd8(0x1d0)](_0x3942d3);_0x428398?(console[_0x211cd8(0x226)]('🧹\x20[DEBUG]\x20Clearing\x20'+_0x428398[_0x211cd8(0x21a)][_0x211cd8(0x1a7)]+_0x211cd8(0x22f)+_0x3942d3),_0x428398[_0x211cd8(0x21a)][_0x211cd8(0x1c8)]((_0x231a4c,_0x5ded92)=>{const _0x5ad021=_0x211cd8;_0x231a4c&&(clearTimeout(_0x231a4c),clearInterval(_0x231a4c),console['log'](_0x5ad021(0x18f)+(_0x5ded92+0x1)+_0x5ad021(0x16c)+_0x3942d3));}),this['paymentTimers'][_0x211cd8(0x23b)](_0x3942d3),console[_0x211cd8(0x226)](_0x211cd8(0x204)+_0x3942d3+_0x211cd8(0x247)+this['paymentTimers']['size'])):console[_0x211cd8(0x226)](_0x211cd8(0x1d7)+_0x3942d3+_0x211cd8(0x1bf));}async[a37_0x344b4d(0x1bb)](_0x124029){const _0x21b71b=a37_0x344b4d;console[_0x21b71b(0x226)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x124029);const _0xeab3c7=await database_1[_0x21b71b(0x169)][_0x21b71b(0x240)][_0x21b71b(0x19c)]({'where':{'id':_0x124029},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xeab3c7){console['log'](_0x21b71b(0x242)+_0x124029+'\x20not\x20found\x20in\x20database');return;}console[_0x21b71b(0x226)](_0x21b71b(0x1a8)+_0x124029+'\x20found:'),console[_0x21b71b(0x226)](_0x21b71b(0x1a6)+_0xeab3c7[_0x21b71b(0x20f)]),console[_0x21b71b(0x226)]('\x20\x20\x20-\x20Status:\x20'+_0xeab3c7[_0x21b71b(0x1b5)]),console[_0x21b71b(0x226)](_0x21b71b(0x1b7)+_0xeab3c7[_0x21b71b(0x1a3)]),console[_0x21b71b(0x226)](_0x21b71b(0x22b)+_0xeab3c7['amount']+'\x20'+_0xeab3c7[_0x21b71b(0x16b)]),console[_0x21b71b(0x226)]('\x20\x20\x20-\x20ShopId:\x20'+_0xeab3c7['shopId']);if(_0xeab3c7[_0x21b71b(0x20f)]!==_0x21b71b(0x1e5)){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x124029+_0x21b71b(0x1fd)+_0xeab3c7[_0x21b71b(0x20f)]+')');return;}if(_0xeab3c7[_0x21b71b(0x1b5)]!==_0x21b71b(0x167)){console[_0x21b71b(0x226)](_0x21b71b(0x1f2)+_0x124029+_0x21b71b(0x231)+_0xeab3c7[_0x21b71b(0x1b5)]+_0x21b71b(0x1c4)),this[_0x21b71b(0x1ca)](_0x124029);return;}if(!_0xeab3c7[_0x21b71b(0x1a3)]){console['log'](_0x21b71b(0x1f2)+_0x124029+_0x21b71b(0x236));return;}console[_0x21b71b(0x226)](_0x21b71b(0x1e6)+_0x124029+_0x21b71b(0x212)),await this[_0x21b71b(0x166)](_0xeab3c7);}[a37_0x344b4d(0x183)](_0x296da7,_0x101331,_0x5a84a1,_0x1ee746,_0x201bae,_0x1beaf7){const _0x332eae=a37_0x344b4d,_0x1afc6f={'type':_0x332eae(0x23c),'paymentId':_0x296da7,'gatewayPaymentId':_0x101331,'oldStatus':_0x5a84a1,'newStatus':_0x1ee746,'source':_0x201bae,'timestamp':new Date()['toISOString'](),'details':_0x1beaf7||{}};loggerService_1[_0x332eae(0x241)]['logCoinToPayStatus'](_0x1afc6f),console[_0x332eae(0x226)](_0x332eae(0x237)+_0x296da7+'\x20('+_0x101331+')'),console['log']('\x20\x20\x20📊\x20Status:\x20'+_0x5a84a1+_0x332eae(0x16e)+_0x1ee746),console[_0x332eae(0x226)](_0x332eae(0x22a)+_0x201bae),console[_0x332eae(0x226)](_0x332eae(0x1f5)+_0x1afc6f[_0x332eae(0x178)]),_0x1beaf7&&console['log'](_0x332eae(0x232),_0x1beaf7);}[a37_0x344b4d(0x15f)](_0x20c12a,_0x402a0d,_0x1632bc,_0x2a6cbb,_0x256031){const _0x84348f=a37_0x344b4d,_0x6c809d={'type':_0x84348f(0x162),'paymentId':_0x20c12a,'gatewayPaymentId':_0x402a0d,'error':_0x1632bc instanceof Error?{'message':_0x1632bc[_0x84348f(0x238)],'stack':_0x1632bc[_0x84348f(0x20e)]}:_0x1632bc,'source':_0x2a6cbb,'timestamp':new Date()[_0x84348f(0x24a)](),'context':_0x256031||{}};loggerService_1[_0x84348f(0x241)][_0x84348f(0x15f)](_0x6c809d),console[_0x84348f(0x228)](_0x84348f(0x194)+_0x20c12a+'\x20('+_0x402a0d+')'),console[_0x84348f(0x228)]('\x20\x20\x20❌\x20Error:\x20'+(_0x1632bc instanceof Error?_0x1632bc[_0x84348f(0x238)]:_0x1632bc)),console[_0x84348f(0x228)](_0x84348f(0x22a)+_0x2a6cbb),console[_0x84348f(0x228)]('\x20\x20\x20📅\x20Time:\x20'+_0x6c809d[_0x84348f(0x178)]),_0x256031&&console[_0x84348f(0x228)](_0x84348f(0x188),_0x256031);}[a37_0x344b4d(0x193)](){const _0xe32b5e=a37_0x344b4d;console[_0xe32b5e(0x226)](_0xe32b5e(0x21c)),this[_0xe32b5e(0x197)]()[_0xe32b5e(0x17d)](_0x2d8a0f=>{const _0x5a09b8=_0xe32b5e;console['error'](_0x5a09b8(0x16d),_0x2d8a0f);}),this['globalCheckInterval']=setInterval(async()=>{const _0x5b8ebb=_0xe32b5e;try{console[_0x5b8ebb(0x226)](_0x5b8ebb(0x213)),await this[_0x5b8ebb(0x197)](),console[_0x5b8ebb(0x226)](_0x5b8ebb(0x161));}catch(_0x16d969){console[_0x5b8ebb(0x228)](_0x5b8ebb(0x20a),_0x16d969);}},this[_0xe32b5e(0x1b2)]),console[_0xe32b5e(0x226)](_0xe32b5e(0x1da));}[a37_0x344b4d(0x190)](){const _0x5a43bd=a37_0x344b4d;console['log'](_0x5a43bd(0x219));this[_0x5a43bd(0x209)]&&(clearInterval(this[_0x5a43bd(0x209)]),this['globalCheckInterval']=null,console[_0x5a43bd(0x226)](_0x5a43bd(0x1e3)));const _0x49d1b1=this[_0x5a43bd(0x1eb)][_0x5a43bd(0x186)];for(const [_0x1f9bbd]of this['paymentTimers']){this['clearPaymentTimers'](_0x1f9bbd);}console[_0x5a43bd(0x226)](_0x5a43bd(0x1d5)+_0x49d1b1+_0x5a43bd(0x243));}async[a37_0x344b4d(0x197)](){const _0x2c24f3=a37_0x344b4d;try{console[_0x2c24f3(0x226)](_0x2c24f3(0x17f));const _0x62070d=await database_1[_0x2c24f3(0x169)]['payment'][_0x2c24f3(0x22e)]({'where':{'gateway':_0x2c24f3(0x1e5),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x2c24f3(0x226)](_0x2c24f3(0x1b4)+_0x62070d[_0x2c24f3(0x1a7)]+_0x2c24f3(0x1f7));if(_0x62070d['length']===0x0){console[_0x2c24f3(0x226)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x11d8c0=await this['checkExpiredPayments'](_0x62070d);console[_0x2c24f3(0x226)](_0x2c24f3(0x225)+_0x11d8c0[_0x2c24f3(0x1a7)]+_0x2c24f3(0x1cf));let _0x4fa327=0x0,_0x5f1fb3=0x0;for(const _0x375c64 of _0x62070d){try{if(_0x11d8c0['includes'](_0x375c64['id'])){console[_0x2c24f3(0x226)](_0x2c24f3(0x1f8)+_0x375c64['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x5f1fb3++;continue;}if(this[_0x2c24f3(0x1eb)]['has'](_0x375c64['id'])){console[_0x2c24f3(0x226)](_0x2c24f3(0x1f8)+_0x375c64['id']+_0x2c24f3(0x177)),_0x5f1fb3++;continue;}const _0x4089d2=(Date['now']()-_0x375c64[_0x2c24f3(0x1c6)][_0x2c24f3(0x1ee)]())/(0x3e8*0x3c*0x3c);if(_0x4089d2<0x1){console['log'](_0x2c24f3(0x1f8)+_0x375c64['id']+_0x2c24f3(0x191)+_0x4089d2[_0x2c24f3(0x18c)](0x1)+_0x2c24f3(0x1a5)),_0x5f1fb3++;continue;}console['log']('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x375c64['id']+_0x2c24f3(0x216)+_0x4089d2[_0x2c24f3(0x18c)](0x1)+'h)'),await this[_0x2c24f3(0x166)](_0x375c64),_0x4fa327++,await new Promise(_0x2c376d=>setTimeout(_0x2c376d,0x7d0));}catch(_0x12dfef){console[_0x2c24f3(0x228)](_0x2c24f3(0x173)+_0x375c64['id']+':',_0x12dfef),this[_0x2c24f3(0x15f)](_0x375c64['id'],_0x375c64[_0x2c24f3(0x1a3)]||_0x2c24f3(0x1af),_0x12dfef,_0x2c24f3(0x223),{'isGlobalCheck':!![],'paymentAmount':_0x375c64[_0x2c24f3(0x1d6)],'paymentCurrency':_0x375c64[_0x2c24f3(0x16b)],'shopId':_0x375c64['shopId'],'createdAt':_0x375c64[_0x2c24f3(0x1c6)]}),loggerService_1[_0x2c24f3(0x241)][_0x2c24f3(0x1ed)](_0x2c24f3(0x1e5),_0x2c24f3(0x179)+_0x375c64[_0x2c24f3(0x1a3)],_0x12dfef);}}console[_0x2c24f3(0x226)](_0x2c24f3(0x1e8)+_0x4fa327+_0x2c24f3(0x208)+_0x5f1fb3+_0x2c24f3(0x1cc)+_0x11d8c0[_0x2c24f3(0x1a7)]+_0x2c24f3(0x1fb));}catch(_0x4a4f03){console[_0x2c24f3(0x228)](_0x2c24f3(0x1bc),_0x4a4f03);}}async[a37_0x344b4d(0x234)](_0x98862a){const _0x34a402=a37_0x344b4d,_0x3912ba=[],_0x4af07b=new Date();_0x4af07b[_0x34a402(0x19b)](_0x4af07b[_0x34a402(0x171)]()-this[_0x34a402(0x203)]),console[_0x34a402(0x226)](_0x34a402(0x199)+this[_0x34a402(0x203)]+_0x34a402(0x1ec)+_0x4af07b['toISOString']()+')');for(const _0x282f91 of _0x98862a){if(_0x282f91['createdAt']<_0x4af07b){console[_0x34a402(0x226)](_0x34a402(0x1e2)+_0x282f91['id']+_0x34a402(0x1db)+this[_0x34a402(0x203)]+_0x34a402(0x184));try{this['logCoinToPayStatus'](_0x282f91['id'],_0x282f91[_0x34a402(0x1a3)]||_0x34a402(0x1af),'PENDING','EXPIRED',_0x34a402(0x1c5),{'reason':_0x34a402(0x1f4)+this[_0x34a402(0x203)]+_0x34a402(0x1c9),'createdAt':_0x282f91[_0x34a402(0x1c6)],'daysSinceCreation':Math['floor']((Date[_0x34a402(0x229)]()-_0x282f91['createdAt'][_0x34a402(0x1ee)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x282f91[_0x34a402(0x1d6)],'paymentCurrency':_0x282f91[_0x34a402(0x16b)],'shopId':_0x282f91['shopId']}),await database_1[_0x34a402(0x169)][_0x34a402(0x240)][_0x34a402(0x1c3)]({'where':{'id':_0x282f91['id']},'data':{'status':_0x34a402(0x1b0),'updatedAt':new Date(),'adminNotes':_0x34a402(0x1e9)+this[_0x34a402(0x203)]+_0x34a402(0x227)}}),await database_1[_0x34a402(0x169)]['webhookLog'][_0x34a402(0x23a)]({'data':{'paymentId':_0x282f91['id'],'shopId':_0x282f91[_0x34a402(0x1bd)],'event':_0x34a402(0x217),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x34a402(0x1f4)+this[_0x34a402(0x203)]+_0x34a402(0x1c9),'createdAt':_0x282f91[_0x34a402(0x1c6)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x34a402(0x1f9)]((Date[_0x34a402(0x229)]()-_0x282f91[_0x34a402(0x1c6)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x34a402(0x16f)](_0x282f91,_0x34a402(0x1b0)),await this[_0x34a402(0x18e)](_0x282f91,'EXPIRED'),this['clearPaymentTimers'](_0x282f91['id']),_0x3912ba[_0x34a402(0x235)](_0x282f91['id']),console[_0x34a402(0x226)]('✅\x20[EXPIRY]\x20Payment\x20'+_0x282f91['id']+_0x34a402(0x163)+this[_0x34a402(0x203)]+'-day\x20timeout');}catch(_0x4839e1){console[_0x34a402(0x228)](_0x34a402(0x221)+_0x282f91['id']+':',_0x4839e1),this[_0x34a402(0x15f)](_0x282f91['id'],_0x282f91[_0x34a402(0x1a3)]||_0x34a402(0x1af),_0x4839e1,_0x34a402(0x1c5),{'reason':_0x34a402(0x21e),'createdAt':_0x282f91[_0x34a402(0x1c6)],'daysSinceCreation':Math[_0x34a402(0x1f9)]((Date[_0x34a402(0x229)]()-_0x282f91[_0x34a402(0x1c6)][_0x34a402(0x1ee)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x3912ba;}async[a37_0x344b4d(0x166)](_0x238d44){const _0x9ba349=a37_0x344b4d;if(!_0x238d44['gatewayPaymentId']){console['log'](_0x9ba349(0x1f2)+_0x238d44['id']+_0x9ba349(0x1c2));return;}console[_0x9ba349(0x226)](_0x9ba349(0x1e4)+_0x238d44['id']+'\x20('+_0x238d44[_0x9ba349(0x1a3)]+')');try{const _0x54f473=await this[_0x9ba349(0x1c0)][_0x9ba349(0x1d1)](_0x238d44[_0x9ba349(0x1a3)]);console['log'](_0x9ba349(0x1a8)+_0x238d44['id']+_0x9ba349(0x181)+_0x54f473[_0x9ba349(0x1b5)]);_0x54f473['paymentDetails']&&console[_0x9ba349(0x226)](_0x9ba349(0x1a8)+_0x238d44['id']+_0x9ba349(0x1b6),{'iban':_0x54f473[_0x9ba349(0x1be)][_0x9ba349(0x222)]||_0x9ba349(0x1d2),'transactionId':_0x54f473[_0x9ba349(0x1be)]['transactionId'],'createdOn':_0x54f473[_0x9ba349(0x1be)][_0x9ba349(0x164)],'confirmedOn':_0x54f473[_0x9ba349(0x1be)]['confirmedOn']||_0x9ba349(0x21f)});if(_0x54f473[_0x9ba349(0x1b5)]!==_0x238d44[_0x9ba349(0x1b5)]){console['log'](_0x9ba349(0x18a)+_0x238d44['id']+_0x9ba349(0x1dd)+_0x238d44['status']+_0x9ba349(0x1b9)+_0x54f473[_0x9ba349(0x1b5)]),this[_0x9ba349(0x183)](_0x238d44['id'],_0x238d44[_0x9ba349(0x1a3)],_0x238d44['status'],_0x54f473[_0x9ba349(0x1b5)],_0x9ba349(0x223),{'paymentDetails':_0x54f473['paymentDetails'],'amount':_0x54f473[_0x9ba349(0x1d6)],'currency':_0x54f473[_0x9ba349(0x16b)],'shopId':_0x238d44[_0x9ba349(0x1bd)],'checkTimestamp':new Date()[_0x9ba349(0x24a)]()});const _0x3f1a3e={'status':_0x54f473[_0x9ba349(0x1b5)],'updatedAt':new Date()};_0x54f473['status']===_0x9ba349(0x1ba)&&_0x238d44[_0x9ba349(0x1b5)]!==_0x9ba349(0x1ba)&&(_0x3f1a3e[_0x9ba349(0x1cd)]=new Date(),console[_0x9ba349(0x226)](_0x9ba349(0x211)+_0x238d44['id']+_0x9ba349(0x1ea)+_0x3f1a3e['paidAt']['toISOString']()));if(_0x54f473[_0x9ba349(0x1be)]){const _0x3ccb39=_0x54f473[_0x9ba349(0x1be)];_0x3ccb39[_0x9ba349(0x222)]&&(_0x3f1a3e['remitterIban']=_0x3ccb39['iban'],console[_0x9ba349(0x226)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x3ccb39['iban']));if(_0x3ccb39[_0x9ba349(0x1a9)]){const _0xf6c9a5=_0x238d44['adminNotes']||'',_0x50c04b=_0x9ba349(0x21d)+_0x3ccb39['bankDetails'];_0x3f1a3e['adminNotes']=_0xf6c9a5?_0xf6c9a5+'\x0a\x0a'+_0x50c04b:_0x50c04b,console[_0x9ba349(0x226)](_0x9ba349(0x1ac));}_0x3ccb39[_0x9ba349(0x17b)]&&console[_0x9ba349(0x226)](_0x9ba349(0x1de)+_0x3ccb39[_0x9ba349(0x17b)]),_0x3ccb39[_0x9ba349(0x1a2)]&&console[_0x9ba349(0x226)](_0x9ba349(0x17e)+_0x3ccb39[_0x9ba349(0x1a2)]);}await database_1[_0x9ba349(0x169)]['payment'][_0x9ba349(0x1c3)]({'where':{'id':_0x238d44['id']},'data':_0x3f1a3e}),await database_1['default']['webhookLog'][_0x9ba349(0x23a)]({'data':{'paymentId':_0x238d44['id'],'shopId':_0x238d44[_0x9ba349(0x1bd)],'event':'cointopay_status_check_'+_0x54f473['status'][_0x9ba349(0x201)](),'statusCode':0xc8,'responseBody':JSON[_0x9ba349(0x1df)]({'oldStatus':_0x238d44['status'],'newStatus':_0x54f473[_0x9ba349(0x1b5)],'paymentDetails':_0x54f473['paymentDetails'],'checkedAt':new Date()[_0x9ba349(0x24a)]()})}}),await this[_0x9ba349(0x16f)](_0x238d44,_0x54f473['status']),await this['sendPaymentStatusNotification'](_0x238d44,_0x54f473[_0x9ba349(0x1b5)]),_0x54f473[_0x9ba349(0x1b5)]!==_0x9ba349(0x167)&&(console[_0x9ba349(0x226)](_0x9ba349(0x1fe)+_0x238d44['id']+_0x9ba349(0x189)+_0x54f473['status']+',\x20clearing\x20individual\x20timers'),this['clearPaymentTimers'](_0x238d44['id'])),console[_0x9ba349(0x226)]('✅\x20[CHECK]\x20Payment\x20'+_0x238d44['id']+'\x20updated\x20successfully');}else console[_0x9ba349(0x226)]('📊\x20[CHECK]\x20Payment\x20'+_0x238d44['id']+'\x20status\x20unchanged\x20('+_0x54f473['status']+')'),this[_0x9ba349(0x183)](_0x238d44['id'],_0x238d44[_0x9ba349(0x1a3)],_0x238d44[_0x9ba349(0x1b5)],_0x54f473[_0x9ba349(0x1b5)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x54f473[_0x9ba349(0x1be)],'amount':_0x54f473[_0x9ba349(0x1d6)],'currency':_0x54f473[_0x9ba349(0x16b)],'shopId':_0x238d44[_0x9ba349(0x1bd)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x5ce3d3){console[_0x9ba349(0x228)](_0x9ba349(0x23e)+_0x238d44['id']+':',_0x5ce3d3),this[_0x9ba349(0x15f)](_0x238d44['id'],_0x238d44['gatewayPaymentId'],_0x5ce3d3,_0x9ba349(0x223),{'paymentAmount':_0x238d44[_0x9ba349(0x1d6)],'paymentCurrency':_0x238d44[_0x9ba349(0x16b)],'shopId':_0x238d44[_0x9ba349(0x1bd)],'createdAt':_0x238d44['createdAt']}),await database_1[_0x9ba349(0x169)][_0x9ba349(0x16a)]['create']({'data':{'paymentId':_0x238d44['id'],'shopId':_0x238d44[_0x9ba349(0x1bd)],'event':_0x9ba349(0x1e0),'statusCode':0x1f4,'responseBody':JSON[_0x9ba349(0x1df)]({'error':_0x5ce3d3 instanceof Error?_0x5ce3d3[_0x9ba349(0x238)]:_0x9ba349(0x22d),'gatewayPaymentId':_0x238d44[_0x9ba349(0x1a3)],'checkedAt':new Date()[_0x9ba349(0x24a)]()})}});}}async[a37_0x344b4d(0x16f)](_0x80432c,_0x49b7ea){const _0x557ba4=a37_0x344b4d,_0xfb251=Date[_0x557ba4(0x229)]();try{const _0x394d85=_0x80432c[_0x557ba4(0x1d4)],_0x67e8b4=_0x394d85[_0x557ba4(0x1f3)];if(!_0x67e8b4?.[_0x557ba4(0x17a)]){console[_0x557ba4(0x226)](_0x557ba4(0x24b)+_0x394d85['id']);return;}const _0x41deda=_0x49b7ea===_0x557ba4(0x1ba)?'payment.success':_0x49b7ea===_0x557ba4(0x1d3)?_0x557ba4(0x1ce):_0x49b7ea==='EXPIRED'?_0x557ba4(0x1ce):_0x557ba4(0x176);if(!_0x67e8b4[_0x557ba4(0x19d)]?.['includes'](_0x41deda)){console[_0x557ba4(0x226)](_0x557ba4(0x192)+_0x41deda+_0x557ba4(0x20d)+_0x394d85['id']);return;}const _0x5ba908={'event':_0x41deda,'payment':{'id':_0x80432c['id'],'order_id':_0x80432c['orderId'],'gateway_order_id':_0x80432c[_0x557ba4(0x207)],'gateway':_0x557ba4(0x210),'amount':_0x80432c[_0x557ba4(0x1d6)],'currency':_0x80432c['currency'],'status':_0x49b7ea[_0x557ba4(0x201)](),'customer_email':_0x80432c[_0x557ba4(0x174)],'customer_name':_0x80432c[_0x557ba4(0x185)],'created_at':_0x80432c[_0x557ba4(0x1c6)],'updated_at':new Date()}},_0x4c4c97=await fetch(_0x67e8b4[_0x557ba4(0x17a)],{'method':_0x557ba4(0x206),'headers':{'Content-Type':_0x557ba4(0x233),'User-Agent':_0x557ba4(0x1ae)},'body':JSON[_0x557ba4(0x1df)](_0x5ba908)}),_0x230798=Date[_0x557ba4(0x229)]()-_0xfb251,_0x5ecdae=_0x4c4c97['ok']?_0x557ba4(0x23d):await _0x4c4c97[_0x557ba4(0x182)]();loggerService_1[_0x557ba4(0x241)]['logShopWebhookSent'](_0x80432c[_0x557ba4(0x1bd)],_0x67e8b4[_0x557ba4(0x17a)],_0x41deda,_0x4c4c97[_0x557ba4(0x1b5)],_0x230798,_0x5ba908),console[_0x557ba4(0x226)](_0x557ba4(0x1f0)+_0x67e8b4['webhookUrl']+_0x557ba4(0x202)+_0x4c4c97[_0x557ba4(0x1b5)]+'\x20('+_0x230798+'ms)');}catch(_0x32683d){console[_0x557ba4(0x228)](_0x557ba4(0x172),_0x32683d),loggerService_1[_0x557ba4(0x241)][_0x557ba4(0x24c)](_0x80432c[_0x557ba4(0x1bd)],_0x80432c[_0x557ba4(0x1d4)]?.[_0x557ba4(0x1f3)]?.[_0x557ba4(0x17a)]||_0x557ba4(0x1af),_0x557ba4(0x1ef),_0x32683d,{});}}async['sendPaymentStatusNotification'](_0x24eca9,_0x4899bc){const _0x21b297=a37_0x344b4d;try{const _0x2ea290={'PENDING':_0x21b297(0x24f),'PAID':_0x21b297(0x1d9),'FAILED':_0x21b297(0x187),'EXPIRED':'expired'},_0x84f4fd=_0x2ea290[_0x4899bc];if(!_0x84f4fd||_0x84f4fd===_0x21b297(0x24f))return;await telegramBotService_1[_0x21b297(0x200)][_0x21b297(0x1a0)](_0x24eca9[_0x21b297(0x1bd)],_0x24eca9,_0x84f4fd);}catch(_0x9f44fd){console[_0x21b297(0x228)](_0x21b297(0x1d8),_0x9f44fd);}}async[a37_0x344b4d(0x160)](_0x468bef){const _0x5ddfc0=a37_0x344b4d;console[_0x5ddfc0(0x226)]('🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x468bef);const _0x483926=await database_1[_0x5ddfc0(0x169)][_0x5ddfc0(0x240)][_0x5ddfc0(0x19c)]({'where':{'id':_0x468bef},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x483926)throw new Error('Payment\x20not\x20found');if(_0x483926[_0x5ddfc0(0x20f)]!==_0x5ddfc0(0x1e5))throw new Error(_0x5ddfc0(0x215));console[_0x5ddfc0(0x226)](_0x5ddfc0(0x198)+_0x468bef),await this['checkSinglePayment'](_0x483926),console[_0x5ddfc0(0x226)]('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x468bef);}[a37_0x344b4d(0x1fa)](){const _0x2b146f=a37_0x344b4d,_0x385820=this[_0x2b146f(0x209)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x28adb8=Array[_0x2b146f(0x1aa)](this[_0x2b146f(0x1eb)][_0x2b146f(0x1ab)]())['map'](_0x4eaf9d=>({'paymentId':_0x4eaf9d[_0x2b146f(0x18b)],'gatewayPaymentId':_0x4eaf9d[_0x2b146f(0x1a3)],'createdAt':_0x4eaf9d[_0x2b146f(0x1c6)],'timersCount':_0x4eaf9d['timers']['length']}));return{'isActive':!!this[_0x2b146f(0x209)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x2b146f(0x203)],'activeIndividualTimers':this[_0x2b146f(0x1eb)]['size'],'nextGlobalCheckIn':_0x385820,'paymentTimersDetails':_0x28adb8};}['getPaymentTimerInfo'](_0x47ce03){const _0x3694c7=a37_0x344b4d,_0x2588e0=this[_0x3694c7(0x1eb)][_0x3694c7(0x1d0)](_0x47ce03);if(_0x2588e0)return{'hasTimers':!![],'timersCount':_0x2588e0[_0x3694c7(0x21a)][_0x3694c7(0x1a7)],'createdAt':_0x2588e0[_0x3694c7(0x1c6)],'gatewayPaymentId':_0x2588e0['gatewayPaymentId']};return{'hasTimers':![]};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();