'use strict';function a37_0x1ec8(_0xc40329,_0x395fd9){const _0x43ecb7=a37_0x43ec();return a37_0x1ec8=function(_0x1ec8de,_0x12a143){_0x1ec8de=_0x1ec8de-0x134;let _0x318e87=_0x43ecb7[_0x1ec8de];return _0x318e87;},a37_0x1ec8(_0xc40329,_0x395fd9);}const a37_0x3ca411=a37_0x1ec8;(function(_0x52df7c,_0x323663){const _0x3177b5=a37_0x1ec8,_0x4b5316=_0x52df7c();while(!![]){try{const _0x5bd0eb=-parseInt(_0x3177b5(0x159))/0x1*(-parseInt(_0x3177b5(0x171))/0x2)+parseInt(_0x3177b5(0x1dd))/0x3*(-parseInt(_0x3177b5(0x157))/0x4)+parseInt(_0x3177b5(0x193))/0x5*(parseInt(_0x3177b5(0x14c))/0x6)+-parseInt(_0x3177b5(0x204))/0x7*(-parseInt(_0x3177b5(0x15b))/0x8)+-parseInt(_0x3177b5(0x17f))/0x9*(parseInt(_0x3177b5(0x20d))/0xa)+parseInt(_0x3177b5(0x1e6))/0xb+-parseInt(_0x3177b5(0x1d5))/0xc*(parseInt(_0x3177b5(0x1f9))/0xd);if(_0x5bd0eb===_0x323663)break;else _0x4b5316['push'](_0x4b5316['shift']());}catch(_0x4ce3e3){_0x4b5316['push'](_0x4b5316['shift']());}}}(a37_0x43ec,0xca3de));var __importDefault=this&&this[a37_0x3ca411(0x16f)]||function(_0x237ce3){const _0x23c7ae=a37_0x3ca411;return _0x237ce3&&_0x237ce3[_0x23c7ae(0x21c)]?_0x237ce3:{'default':_0x237ce3};};Object[a37_0x3ca411(0x173)](exports,a37_0x3ca411(0x21c),{'value':!![]}),exports[a37_0x3ca411(0x220)]=exports['CoinToPayStatusService']=void 0x0;function a37_0x43ec(){const _0x5de01b=['\x20days','\x20updated\x20successfully','default','\x20for\x20payment\x20','64398SUetWn','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','.\x20Remaining\x20active\x20timers:\x20','currency','üìä\x20[HOURLY]\x20Payment\x20','\x20is\x20older\x20than\x20','bankDetails','catch','failed','PAID','8rHHMnP','settings','8JqbVss','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','488344PpKiAP','\x20current\x20status:\x20','COINTOPAY_ERROR','ü™ô\x20[DEBUG]\x20Creating\x20','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','gateway','log','\x20details:','üßπ\x20[CHECK]\x20Payment\x20','\x20to\x20','webhookEvents','\x20status\x20is\x20','../config/database','ü™ô\x20[GLOBAL]\x20Found\x20','unknown','from','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20skipped,\x20','cointopay','PENDING','__importDefault','\x20is\x20valid\x20for\x20checking,\x20proceeding...','347778kXwgWe','gatewayPaymentId','defineProperty','paymentId','timers','toFixed','EXPIRED','schedulePaymentChecks','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','\x20in\x20','webhookLog','\x20(age:\x20','\x20status\x20from\x20','error','2043imHZDr','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','size','\x20days\x20without\x20payment\x20confirmation','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','\x20days\x20(created\x20before\x20','getServiceStats','paymentTimers','checkExpiredPayments','\x20\x20\x20-\x20ShopId:\x20','\x20individual\x20payment\x20timers','\x20\x20\x20üìÖ\x20Time:\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','\x20\x20\x20-\x20paymentId:\x20','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','üßπ\x20[DEBUG]\x20Clearing\x20','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','sendPaymentStatusNotification','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20\x20\x20üìç\x20Source:\x20','430aLDJwi','findUnique','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','FAILED','\x20to\x20clear','sendPaymentNotification','getTime','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20pending\x20CoinToPay\x20payments','checkPaymentStatus','\x20initial\x20timers\x20for\x20payment\x20','now','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','webhookUrl','iban','cointopay_status_check_','checkPaymentById','./telegramBotService','transactionId','\x20\x20\x20-\x20Gateway:\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','Automatically\x20expired\x20after\x20','setDate','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','checkAllPendingPayments','update','findMany','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','logShopWebhookSent','\x20\x20\x20üìä\x20Status:\x20','ü™ô\x20CoinToPayStatusService\x20initialized','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','\x20has\x20no\x20gatewayPaymentId','application/json','checkSinglePayment','Webhook\x20event\x20','push','values','status','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','logCoinToPayError','coinToPayService','forEach','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','map','confirmedOn','Failed\x20to\x20mark\x20payment\x20as\x20expired','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','paid','\x20timers\x20for\x20payment\x20','customerName','checkSinglePaymentById','‚úÖ\x20[HOURLY]\x20Payment\x20','status_check','GLOBAL_CHECK_INTERVAL_MS','telegramBotService','get','\x20is\x20too\x20new\x20(','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','üí∞\x20[CHECK]\x20Payment\x20','shopId','created','\x20status:\x20','\x20with\x20status\x20','624fwEXLQ','includes','paymentDetails','\x20days,\x20marking\x20as\x20EXPIRED','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','toLowerCase','getDate','h),\x20skipping\x20global\x20check','891327dbmZZn','Unknown\x20error','CoinToPayService','üìä\x20[CHECK]\x20Payment\x20','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','shop','Bank\x20Details:\x20','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20\x20\x20üìù\x20Context:','473396NtYLSN','\x20expired','\x20completed\x20for\x20payment\x20','description','\x20checked,\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','EXPIRY_DAYS','message','\x20triggered\x20for\x20payment\x20','payment.failed','\x20marked\x20as\x20paid\x20at:\x20','logWhiteDomainError','\x20seconds\x20(',',\x20clearing\x20individual\x20timers','\x20has\x20no\x20gatewayPaymentId,\x20skipping','amount','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','gatewayOrderId','22373OYjMXi','expired','./loggerService','getPaymentTimerInfo','\x20not\x20found\x20in\x20database','schedule_created','timestamp','createdAt','length','0100','\x20\x20\x20-\x20GatewayPaymentId:\x20','70QERdGq','5\x20minutes','loggerService','stopPeriodicStatusCheck','auto_expire','not\x20confirmed','sendShopWebhook','adminNotes','\x20status\x20changed\x20to\x20','64120bgxKop','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','delay','stringify','\x20\x20\x20-\x20Status:\x20','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','clearPaymentTimers','-day\x20timeout','‚úÖ\x20[CHECK]\x20Payment\x20','customerEmail','floor','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','globalCheckInterval','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','__esModule','\x20(after\x20','1\x20minute','payment','coinToPayStatusService','‚úÖ\x20[EXPIRY]\x20Payment\x20','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','Payment\x20not\x20found',',\x20stopping\x20individual\x20checks','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','orderId','‚è∞\x20[HOURLY]\x20Payment\x20','Payment\x20older\x20than\x20','toISOString','‚è∞\x20[GLOBAL]\x20Payment\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','\x20\x20\x20üìù\x20Details:','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','logCoinToPayStatus','2\x20minutes','\x20\x20\x20‚ùå\x20Error:\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20not\x20found,\x20clearing\x20timers','create','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','paidAt'];a37_0x43ec=function(){return _0x5de01b;};return a37_0x43ec();}const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a37_0x3ca411(0x167))),telegramBotService_1=require(a37_0x3ca411(0x1a4)),loggerService_1=require(a37_0x3ca411(0x1fb));class CoinToPayStatusService{constructor(){const _0x9b8527=a37_0x3ca411;this['globalCheckInterval']=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x9b8527(0x186)]=new Map(),this[_0x9b8527(0x1be)]=new coinToPayService_1[(_0x9b8527(0x1df))](),console[_0x9b8527(0x161)](_0x9b8527(0x1b2));}[a37_0x3ca411(0x178)](_0x56a825,_0x260f1c){const _0x12e4e4=a37_0x3ca411;console[_0x12e4e4(0x161)](_0x12e4e4(0x1cf)),console[_0x12e4e4(0x161)](_0x12e4e4(0x18c)+_0x56a825),console[_0x12e4e4(0x161)](_0x12e4e4(0x18b)+_0x260f1c),this[_0x12e4e4(0x214)](_0x56a825);const _0x3de334=[],_0x3ce7a0=new Date(),_0x501da3=[{'delay':0x1*0x3c*0x3e8,'description':_0x12e4e4(0x21e)},{'delay':0x2*0x3c*0x3e8,'description':_0x12e4e4(0x141)},{'delay':0x5*0x3c*0x3e8,'description':_0x12e4e4(0x205)},{'delay':0x5*0x3c*0x3e8,'description':_0x12e4e4(0x205)}];console[_0x12e4e4(0x161)](_0x12e4e4(0x15e)+_0x501da3[_0x12e4e4(0x201)]+_0x12e4e4(0x19d)+_0x56a825);let _0x5dd7a1=0x0;_0x501da3[_0x12e4e4(0x1bf)]((_0x443ca7,_0x264d28)=>{const _0x323072=_0x12e4e4;_0x5dd7a1+=_0x443ca7[_0x323072(0x210)];const _0x6306ce=setTimeout(async()=>{const _0x56f5af=_0x323072;console[_0x56f5af(0x161)](_0x56f5af(0x15f)+(_0x264d28+0x1)+_0x56f5af(0x1ee)+_0x56a825+_0x56f5af(0x21d)+_0x443ca7['description']+')');try{await this[_0x56f5af(0x1c8)](_0x56a825),console[_0x56f5af(0x161)](_0x56f5af(0x21b)+(_0x264d28+0x1)+_0x56f5af(0x1e8)+_0x56a825);}catch(_0x423dce){console['error']('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x264d28+0x1)+'\x20for\x20payment\x20'+_0x56a825+':',_0x423dce),this[_0x56f5af(0x1bd)](_0x56a825,_0x260f1c,_0x423dce,_0x56f5af(0x1ca),{'checkNumber':_0x264d28+0x1,'scheduledAfter':_0x443ca7[_0x56f5af(0x1e9)],'isIndividualCheck':!![]});}},_0x5dd7a1);_0x3de334[_0x323072(0x1b9)](_0x6306ce),console[_0x323072(0x161)](_0x323072(0x1e4)+(_0x264d28+0x1)+_0x323072(0x14b)+_0x56a825+_0x323072(0x17a)+_0x5dd7a1/0x3e8+_0x323072(0x1f2)+_0x443ca7[_0x323072(0x1e9)]+')');});const _0x50a239=setInterval(async()=>{const _0x242cbd=_0x12e4e4;console[_0x242cbd(0x161)]('ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x56a825);try{const _0x4b655c=await database_1[_0x242cbd(0x14a)][_0x242cbd(0x21f)][_0x242cbd(0x194)]({'where':{'id':_0x56a825},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x4b655c){console[_0x242cbd(0x161)]('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x56a825+_0x242cbd(0x144)),this[_0x242cbd(0x214)](_0x56a825);return;}console[_0x242cbd(0x161)](_0x242cbd(0x151)+_0x56a825+_0x242cbd(0x15c)+_0x4b655c[_0x242cbd(0x1bb)]);if(_0x4b655c[_0x242cbd(0x1bb)]!==_0x242cbd(0x16e)){console[_0x242cbd(0x161)](_0x242cbd(0x1c9)+_0x56a825+'\x20status\x20is\x20'+_0x4b655c['status']+_0x242cbd(0x136)),this[_0x242cbd(0x214)](_0x56a825);return;}const _0x190b9d=Math['floor']((Date[_0x242cbd(0x19e)]()-_0x4b655c['createdAt'][_0x242cbd(0x199)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x190b9d>=this[_0x242cbd(0x1ec)]){console['log'](_0x242cbd(0x139)+_0x56a825+_0x242cbd(0x152)+this[_0x242cbd(0x1ec)]+_0x242cbd(0x180)),this[_0x242cbd(0x214)](_0x56a825);return;}await this[_0x242cbd(0x1c8)](_0x56a825),console[_0x242cbd(0x161)](_0x242cbd(0x14d)+_0x56a825);}catch(_0x8a94c){console[_0x242cbd(0x17e)]('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x56a825+':',_0x8a94c),this[_0x242cbd(0x1bd)](_0x56a825,_0x260f1c,_0x8a94c,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3de334['push'](_0x50a239),this[_0x12e4e4(0x186)]['set'](_0x56a825,{'timers':_0x3de334,'paymentId':_0x56a825,'gatewayPaymentId':_0x260f1c,'createdAt':_0x3ce7a0}),console[_0x12e4e4(0x161)](_0x12e4e4(0x18d)+_0x501da3[_0x12e4e4(0x201)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x56a825),console[_0x12e4e4(0x161)](_0x12e4e4(0x1b3)+this[_0x12e4e4(0x186)][_0x12e4e4(0x181)]),this[_0x12e4e4(0x140)](_0x56a825,_0x260f1c,_0x12e4e4(0x16e),_0x12e4e4(0x16e),_0x12e4e4(0x1ca),{'action':_0x12e4e4(0x1fe),'scheduledChecks':_0x501da3[_0x12e4e4(0x201)],'firstCheckIn':_0x501da3[0x0][_0x12e4e4(0x210)]/0x3e8,'totalTimers':this[_0x12e4e4(0x186)][_0x12e4e4(0x181)]});}['clearPaymentTimers'](_0x4d73fe){const _0x1fbf0c=a37_0x3ca411,_0x202e24=this['paymentTimers'][_0x1fbf0c(0x1cd)](_0x4d73fe);_0x202e24?(console[_0x1fbf0c(0x161)](_0x1fbf0c(0x18e)+_0x202e24[_0x1fbf0c(0x175)][_0x1fbf0c(0x201)]+_0x1fbf0c(0x1c6)+_0x4d73fe),_0x202e24['timers'][_0x1fbf0c(0x1bf)]((_0x4897c7,_0x5ca01b)=>{const _0x4f69ca=_0x1fbf0c;_0x4897c7&&(clearTimeout(_0x4897c7),clearInterval(_0x4897c7),console[_0x4f69ca(0x161)](_0x4f69ca(0x1bc)+(_0x5ca01b+0x1)+_0x4f69ca(0x14b)+_0x4d73fe));}),this['paymentTimers']['delete'](_0x4d73fe),console[_0x1fbf0c(0x161)]('‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x4d73fe+_0x1fbf0c(0x14f)+this[_0x1fbf0c(0x186)][_0x1fbf0c(0x181)])):console[_0x1fbf0c(0x161)](_0x1fbf0c(0x146)+_0x4d73fe+_0x1fbf0c(0x197));}async['checkSinglePaymentById'](_0xe8f9cf){const _0x10f863=a37_0x3ca411;console['log'](_0x10f863(0x191)+_0xe8f9cf);const _0xa1d3a8=await database_1['default'][_0x10f863(0x21f)][_0x10f863(0x194)]({'where':{'id':_0xe8f9cf},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xa1d3a8){console['log']('‚ùå\x20[CHECK]\x20Payment\x20'+_0xe8f9cf+_0x10f863(0x1fd));return;}console['log']('üìä\x20[CHECK]\x20Payment\x20'+_0xe8f9cf+'\x20found:'),console['log'](_0x10f863(0x1a6)+_0xa1d3a8[_0x10f863(0x160)]),console['log'](_0x10f863(0x212)+_0xa1d3a8[_0x10f863(0x1bb)]),console[_0x10f863(0x161)](_0x10f863(0x203)+_0xa1d3a8[_0x10f863(0x172)]),console[_0x10f863(0x161)]('\x20\x20\x20-\x20Amount:\x20'+_0xa1d3a8['amount']+'\x20'+_0xa1d3a8[_0x10f863(0x150)]),console['log'](_0x10f863(0x188)+_0xa1d3a8[_0x10f863(0x1d1)]);if(_0xa1d3a8[_0x10f863(0x160)]!=='cointopay'){console[_0x10f863(0x161)](_0x10f863(0x1f7)+_0xe8f9cf+_0x10f863(0x179)+_0xa1d3a8[_0x10f863(0x160)]+')');return;}if(_0xa1d3a8[_0x10f863(0x1bb)]!=='PENDING'){console[_0x10f863(0x161)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0xe8f9cf+_0x10f863(0x166)+_0xa1d3a8[_0x10f863(0x1bb)]+_0x10f863(0x136)),this['clearPaymentTimers'](_0xe8f9cf);return;}if(!_0xa1d3a8['gatewayPaymentId']){console['log'](_0x10f863(0x1f7)+_0xe8f9cf+_0x10f863(0x1b5));return;}console['log'](_0x10f863(0x216)+_0xe8f9cf+_0x10f863(0x170)),await this[_0x10f863(0x1b7)](_0xa1d3a8);}[a37_0x3ca411(0x140)](_0x3cbca1,_0x4494c5,_0x215927,_0x2af840,_0x58e695,_0x34e779){const _0x33be1b=a37_0x3ca411,_0x10c615={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x3cbca1,'gatewayPaymentId':_0x4494c5,'oldStatus':_0x215927,'newStatus':_0x2af840,'source':_0x58e695,'timestamp':new Date()['toISOString'](),'details':_0x34e779||{}};loggerService_1[_0x33be1b(0x206)]['logCoinToPayStatus'](_0x10c615),console[_0x33be1b(0x161)](_0x33be1b(0x1c0)+_0x3cbca1+'\x20('+_0x4494c5+')'),console['log'](_0x33be1b(0x1b1)+_0x215927+'\x20->\x20'+_0x2af840),console[_0x33be1b(0x161)]('\x20\x20\x20üìç\x20Source:\x20'+_0x58e695),console[_0x33be1b(0x161)](_0x33be1b(0x18a)+_0x10c615[_0x33be1b(0x1ff)]),_0x34e779&&console[_0x33be1b(0x161)](_0x33be1b(0x13e),_0x34e779);}['logCoinToPayError'](_0x265095,_0x920e10,_0x2c1d57,_0x45d8d3,_0x3259a6){const _0x593f79=a37_0x3ca411,_0x2af4fb={'type':_0x593f79(0x15d),'paymentId':_0x265095,'gatewayPaymentId':_0x920e10,'error':_0x2c1d57 instanceof Error?{'message':_0x2c1d57[_0x593f79(0x1ed)],'stack':_0x2c1d57['stack']}:_0x2c1d57,'source':_0x45d8d3,'timestamp':new Date()[_0x593f79(0x13b)](),'context':_0x3259a6||{}};loggerService_1[_0x593f79(0x206)][_0x593f79(0x1bd)](_0x2af4fb),console['error'](_0x593f79(0x1c4)+_0x265095+'\x20('+_0x920e10+')'),console[_0x593f79(0x17e)](_0x593f79(0x142)+(_0x2c1d57 instanceof Error?_0x2c1d57[_0x593f79(0x1ed)]:_0x2c1d57)),console[_0x593f79(0x17e)](_0x593f79(0x192)+_0x45d8d3),console[_0x593f79(0x17e)](_0x593f79(0x18a)+_0x2af4fb[_0x593f79(0x1ff)]),_0x3259a6&&console[_0x593f79(0x17e)](_0x593f79(0x1e5),_0x3259a6);}['startPeriodicStatusCheck'](){const _0x3984f1=a37_0x3ca411;console[_0x3984f1(0x161)](_0x3984f1(0x13f)),this[_0x3984f1(0x1ac)]()[_0x3984f1(0x154)](_0x46ad68=>{const _0x5e35a1=_0x3984f1;console[_0x5e35a1(0x17e)](_0x5e35a1(0x16b),_0x46ad68);}),this[_0x3984f1(0x21a)]=setInterval(async()=>{const _0x56748c=_0x3984f1;try{console['log']('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x56748c(0x1ac)](),console['log']('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x517aa8){console[_0x56748c(0x17e)](_0x56748c(0x15a),_0x517aa8);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x3984f1(0x161)](_0x3984f1(0x1f6));}[a37_0x3ca411(0x207)](){const _0x5c7bff=a37_0x3ca411;console['log'](_0x5c7bff(0x137));this[_0x5c7bff(0x21a)]&&(clearInterval(this['globalCheckInterval']),this['globalCheckInterval']=null,console[_0x5c7bff(0x161)](_0x5c7bff(0x143)));const _0x802492=this['paymentTimers'][_0x5c7bff(0x181)];for(const [_0x18563c]of this['paymentTimers']){this[_0x5c7bff(0x214)](_0x18563c);}console[_0x5c7bff(0x161)]('üõë\x20[SHUTDOWN]\x20Cleared\x20'+_0x802492+_0x5c7bff(0x189));}async[a37_0x3ca411(0x1ac)](){const _0x495b26=a37_0x3ca411;try{console[_0x495b26(0x161)]('ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x2b6dfc=await database_1[_0x495b26(0x14a)][_0x495b26(0x21f)][_0x495b26(0x1ae)]({'where':{'gateway':_0x495b26(0x16d),'status':_0x495b26(0x16e),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x495b26(0x161)](_0x495b26(0x168)+_0x2b6dfc[_0x495b26(0x201)]+_0x495b26(0x19b));if(_0x2b6dfc[_0x495b26(0x201)]===0x0){console[_0x495b26(0x161)](_0x495b26(0x134));return;}const _0x1b07cb=await this[_0x495b26(0x187)](_0x2b6dfc);console['log']('‚è∞\x20[GLOBAL]\x20Found\x20'+_0x1b07cb[_0x495b26(0x201)]+'\x20expired\x20CoinToPay\x20payments');let _0x343e7f=0x0,_0x4bf3b7=0x0;for(const _0x304e51 of _0x2b6dfc){try{if(_0x1b07cb[_0x495b26(0x1d6)](_0x304e51['id'])){console['log'](_0x495b26(0x13c)+_0x304e51['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x4bf3b7++;continue;}if(this[_0x495b26(0x186)]['has'](_0x304e51['id'])){console[_0x495b26(0x161)](_0x495b26(0x13c)+_0x304e51['id']+_0x495b26(0x1af)),_0x4bf3b7++;continue;}const _0x2e1d04=(Date[_0x495b26(0x19e)]()-_0x304e51['createdAt'][_0x495b26(0x199)]())/(0x3e8*0x3c*0x3c);if(_0x2e1d04<0x1){console[_0x495b26(0x161)](_0x495b26(0x13c)+_0x304e51['id']+_0x495b26(0x1ce)+_0x2e1d04[_0x495b26(0x176)](0x1)+_0x495b26(0x1dc)),_0x4bf3b7++;continue;}console[_0x495b26(0x161)](_0x495b26(0x1d9)+_0x304e51['id']+_0x495b26(0x17c)+_0x2e1d04['toFixed'](0x1)+'h)'),await this[_0x495b26(0x1b7)](_0x304e51),_0x343e7f++,await new Promise(_0x5b3c06=>setTimeout(_0x5b3c06,0x7d0));}catch(_0x42c97e){console[_0x495b26(0x17e)](_0x495b26(0x1a7)+_0x304e51['id']+':',_0x42c97e),this[_0x495b26(0x1bd)](_0x304e51['id'],_0x304e51['gatewayPaymentId']||'unknown',_0x42c97e,_0x495b26(0x1ca),{'isGlobalCheck':!![],'paymentAmount':_0x304e51[_0x495b26(0x1f5)],'paymentCurrency':_0x304e51[_0x495b26(0x150)],'shopId':_0x304e51[_0x495b26(0x1d1)],'createdAt':_0x304e51[_0x495b26(0x200)]}),loggerService_1[_0x495b26(0x206)][_0x495b26(0x1f1)](_0x495b26(0x16d),'/status/'+_0x304e51[_0x495b26(0x172)],_0x42c97e);}}console[_0x495b26(0x161)](_0x495b26(0x19f)+_0x343e7f+_0x495b26(0x1ea)+_0x4bf3b7+_0x495b26(0x16c)+_0x1b07cb[_0x495b26(0x201)]+_0x495b26(0x1e7));}catch(_0x5834ad){console[_0x495b26(0x17e)](_0x495b26(0x19a),_0x5834ad);}}async[a37_0x3ca411(0x187)](_0x8808db){const _0x1a8160=a37_0x3ca411,_0xb6126f=[],_0x6c54de=new Date();_0x6c54de[_0x1a8160(0x1aa)](_0x6c54de[_0x1a8160(0x1db)]()-this[_0x1a8160(0x1ec)]),console[_0x1a8160(0x161)](_0x1a8160(0x18f)+this[_0x1a8160(0x1ec)]+_0x1a8160(0x184)+_0x6c54de['toISOString']()+')');for(const _0x24bdfc of _0x8808db){if(_0x24bdfc[_0x1a8160(0x200)]<_0x6c54de){console[_0x1a8160(0x161)](_0x1a8160(0x13d)+_0x24bdfc['id']+_0x1a8160(0x152)+this['EXPIRY_DAYS']+_0x1a8160(0x1d8));try{this['logCoinToPayStatus'](_0x24bdfc['id'],_0x24bdfc[_0x1a8160(0x172)]||'unknown',_0x1a8160(0x16e),_0x1a8160(0x177),_0x1a8160(0x208),{'reason':_0x1a8160(0x13a)+this[_0x1a8160(0x1ec)]+_0x1a8160(0x148),'createdAt':_0x24bdfc[_0x1a8160(0x200)],'daysSinceCreation':Math[_0x1a8160(0x218)]((Date[_0x1a8160(0x19e)]()-_0x24bdfc[_0x1a8160(0x200)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x24bdfc[_0x1a8160(0x1f5)],'paymentCurrency':_0x24bdfc[_0x1a8160(0x150)],'shopId':_0x24bdfc[_0x1a8160(0x1d1)]}),await database_1[_0x1a8160(0x14a)][_0x1a8160(0x21f)]['update']({'where':{'id':_0x24bdfc['id']},'data':{'status':_0x1a8160(0x177),'updatedAt':new Date(),'adminNotes':_0x1a8160(0x1a9)+this[_0x1a8160(0x1ec)]+_0x1a8160(0x182)}}),await database_1['default'][_0x1a8160(0x17b)][_0x1a8160(0x145)]({'data':{'paymentId':_0x24bdfc['id'],'shopId':_0x24bdfc[_0x1a8160(0x1d1)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x1a8160(0x211)]({'reason':_0x1a8160(0x13a)+this['EXPIRY_DAYS']+_0x1a8160(0x148),'createdAt':_0x24bdfc[_0x1a8160(0x200)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x1a8160(0x218)]((Date[_0x1a8160(0x19e)]()-_0x24bdfc[_0x1a8160(0x200)][_0x1a8160(0x199)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x1a8160(0x20a)](_0x24bdfc,'EXPIRED'),await this[_0x1a8160(0x190)](_0x24bdfc,_0x1a8160(0x177)),this[_0x1a8160(0x214)](_0x24bdfc['id']),_0xb6126f[_0x1a8160(0x1b9)](_0x24bdfc['id']),console[_0x1a8160(0x161)](_0x1a8160(0x221)+_0x24bdfc['id']+_0x1a8160(0x219)+this[_0x1a8160(0x1ec)]+_0x1a8160(0x215));}catch(_0x43685f){console[_0x1a8160(0x17e)](_0x1a8160(0x20e)+_0x24bdfc['id']+':',_0x43685f),this['logCoinToPayError'](_0x24bdfc['id'],_0x24bdfc[_0x1a8160(0x172)]||_0x1a8160(0x169),_0x43685f,_0x1a8160(0x208),{'reason':_0x1a8160(0x1c3),'createdAt':_0x24bdfc[_0x1a8160(0x200)],'daysSinceCreation':Math['floor']((Date[_0x1a8160(0x19e)]()-_0x24bdfc[_0x1a8160(0x200)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0xb6126f;}async[a37_0x3ca411(0x1b7)](_0xb5c175){const _0x2387cc=a37_0x3ca411;if(!_0xb5c175[_0x2387cc(0x172)]){console[_0x2387cc(0x161)](_0x2387cc(0x1f7)+_0xb5c175['id']+_0x2387cc(0x1f4));return;}console[_0x2387cc(0x161)](_0x2387cc(0x1b4)+_0xb5c175['id']+'\x20('+_0xb5c175[_0x2387cc(0x172)]+')');try{const _0x55e8d8=await this[_0x2387cc(0x1be)][_0x2387cc(0x19c)](_0xb5c175['gatewayPaymentId']);console['log'](_0x2387cc(0x1e0)+_0xb5c175['id']+_0x2387cc(0x1d3)+_0x55e8d8['status']);_0x55e8d8[_0x2387cc(0x1d7)]&&console[_0x2387cc(0x161)](_0x2387cc(0x1e0)+_0xb5c175['id']+_0x2387cc(0x162),{'iban':_0x55e8d8[_0x2387cc(0x1d7)]['iban']||'not\x20found','transactionId':_0x55e8d8[_0x2387cc(0x1d7)][_0x2387cc(0x1a5)],'createdOn':_0x55e8d8[_0x2387cc(0x1d7)]['createdOn'],'confirmedOn':_0x55e8d8[_0x2387cc(0x1d7)][_0x2387cc(0x1c2)]||_0x2387cc(0x209)});if(_0x55e8d8['status']!==_0xb5c175[_0x2387cc(0x1bb)]){console['log'](_0x2387cc(0x1a8)+_0xb5c175['id']+_0x2387cc(0x17d)+_0xb5c175['status']+_0x2387cc(0x164)+_0x55e8d8[_0x2387cc(0x1bb)]),this['logCoinToPayStatus'](_0xb5c175['id'],_0xb5c175[_0x2387cc(0x172)],_0xb5c175[_0x2387cc(0x1bb)],_0x55e8d8[_0x2387cc(0x1bb)],_0x2387cc(0x1ca),{'paymentDetails':_0x55e8d8[_0x2387cc(0x1d7)],'amount':_0x55e8d8[_0x2387cc(0x1f5)],'currency':_0x55e8d8[_0x2387cc(0x150)],'shopId':_0xb5c175[_0x2387cc(0x1d1)],'checkTimestamp':new Date()[_0x2387cc(0x13b)]()});const _0x1c49ab={'status':_0x55e8d8[_0x2387cc(0x1bb)],'updatedAt':new Date()};_0x55e8d8[_0x2387cc(0x1bb)]===_0x2387cc(0x156)&&_0xb5c175['status']!==_0x2387cc(0x156)&&(_0x1c49ab[_0x2387cc(0x147)]=new Date(),console[_0x2387cc(0x161)](_0x2387cc(0x1d0)+_0xb5c175['id']+_0x2387cc(0x1f0)+_0x1c49ab[_0x2387cc(0x147)]['toISOString']()));if(_0x55e8d8[_0x2387cc(0x1d7)]){const _0x460807=_0x55e8d8[_0x2387cc(0x1d7)];_0x460807[_0x2387cc(0x1a1)]&&(_0x1c49ab['remitterIban']=_0x460807[_0x2387cc(0x1a1)],console[_0x2387cc(0x161)]('üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x460807[_0x2387cc(0x1a1)]));if(_0x460807[_0x2387cc(0x153)]){const _0x263dbb=_0xb5c175['adminNotes']||'',_0x1a335c=_0x2387cc(0x1e3)+_0x460807[_0x2387cc(0x153)];_0x1c49ab[_0x2387cc(0x20b)]=_0x263dbb?_0x263dbb+'\x0a\x0a'+_0x1a335c:_0x1a335c,console['log'](_0x2387cc(0x1e1));}_0x460807[_0x2387cc(0x1a5)]&&console['log'](_0x2387cc(0x183)+_0x460807[_0x2387cc(0x1a5)]),_0x460807['confirmedOn']&&console['log'](_0x2387cc(0x1ab)+_0x460807[_0x2387cc(0x1c2)]);}await database_1[_0x2387cc(0x14a)][_0x2387cc(0x21f)][_0x2387cc(0x1ad)]({'where':{'id':_0xb5c175['id']},'data':_0x1c49ab}),await database_1[_0x2387cc(0x14a)][_0x2387cc(0x17b)][_0x2387cc(0x145)]({'data':{'paymentId':_0xb5c175['id'],'shopId':_0xb5c175[_0x2387cc(0x1d1)],'event':_0x2387cc(0x1a2)+_0x55e8d8[_0x2387cc(0x1bb)][_0x2387cc(0x1da)](),'statusCode':0xc8,'responseBody':JSON[_0x2387cc(0x211)]({'oldStatus':_0xb5c175[_0x2387cc(0x1bb)],'newStatus':_0x55e8d8['status'],'paymentDetails':_0x55e8d8[_0x2387cc(0x1d7)],'checkedAt':new Date()[_0x2387cc(0x13b)]()})}}),await this[_0x2387cc(0x20a)](_0xb5c175,_0x55e8d8[_0x2387cc(0x1bb)]),await this[_0x2387cc(0x190)](_0xb5c175,_0x55e8d8['status']),_0x55e8d8['status']!==_0x2387cc(0x16e)&&(console['log'](_0x2387cc(0x163)+_0xb5c175['id']+_0x2387cc(0x20c)+_0x55e8d8[_0x2387cc(0x1bb)]+_0x2387cc(0x1f3)),this['clearPaymentTimers'](_0xb5c175['id'])),console[_0x2387cc(0x161)]('‚úÖ\x20[CHECK]\x20Payment\x20'+_0xb5c175['id']+_0x2387cc(0x149));}else console[_0x2387cc(0x161)]('üìä\x20[CHECK]\x20Payment\x20'+_0xb5c175['id']+'\x20status\x20unchanged\x20('+_0x55e8d8[_0x2387cc(0x1bb)]+')'),this[_0x2387cc(0x140)](_0xb5c175['id'],_0xb5c175[_0x2387cc(0x172)],_0xb5c175[_0x2387cc(0x1bb)],_0x55e8d8[_0x2387cc(0x1bb)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x55e8d8[_0x2387cc(0x1d7)],'amount':_0x55e8d8[_0x2387cc(0x1f5)],'currency':_0x55e8d8[_0x2387cc(0x150)],'shopId':_0xb5c175[_0x2387cc(0x1d1)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x33467c){console[_0x2387cc(0x17e)](_0x2387cc(0x213)+_0xb5c175['id']+':',_0x33467c),this[_0x2387cc(0x1bd)](_0xb5c175['id'],_0xb5c175[_0x2387cc(0x172)],_0x33467c,_0x2387cc(0x1ca),{'paymentAmount':_0xb5c175[_0x2387cc(0x1f5)],'paymentCurrency':_0xb5c175[_0x2387cc(0x150)],'shopId':_0xb5c175['shopId'],'createdAt':_0xb5c175['createdAt']}),await database_1[_0x2387cc(0x14a)][_0x2387cc(0x17b)][_0x2387cc(0x145)]({'data':{'paymentId':_0xb5c175['id'],'shopId':_0xb5c175[_0x2387cc(0x1d1)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x33467c instanceof Error?_0x33467c[_0x2387cc(0x1ed)]:_0x2387cc(0x1de),'gatewayPaymentId':_0xb5c175['gatewayPaymentId'],'checkedAt':new Date()[_0x2387cc(0x13b)]()})}});}}async[a37_0x3ca411(0x20a)](_0x1a7cf9,_0x1001a1){const _0x41f0ea=a37_0x3ca411,_0x279e57=Date[_0x41f0ea(0x19e)]();try{const _0x3996ba=_0x1a7cf9[_0x41f0ea(0x1e2)],_0x21bd51=_0x3996ba['settings'];if(!_0x21bd51?.[_0x41f0ea(0x1a0)]){console[_0x41f0ea(0x161)](_0x41f0ea(0x1eb)+_0x3996ba['id']);return;}const _0x230843=_0x1001a1===_0x41f0ea(0x156)?'payment.success':_0x1001a1===_0x41f0ea(0x196)?_0x41f0ea(0x1ef):_0x1001a1===_0x41f0ea(0x177)?_0x41f0ea(0x1ef):'payment.pending';if(!_0x21bd51[_0x41f0ea(0x165)]?.['includes'](_0x230843)){console[_0x41f0ea(0x161)](_0x41f0ea(0x1b8)+_0x230843+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3996ba['id']);return;}const _0x27d132={'event':_0x230843,'payment':{'id':_0x1a7cf9['id'],'order_id':_0x1a7cf9[_0x41f0ea(0x138)],'gateway_order_id':_0x1a7cf9[_0x41f0ea(0x1f8)],'gateway':_0x41f0ea(0x202),'amount':_0x1a7cf9['amount'],'currency':_0x1a7cf9[_0x41f0ea(0x150)],'status':_0x1001a1[_0x41f0ea(0x1da)](),'customer_email':_0x1a7cf9[_0x41f0ea(0x217)],'customer_name':_0x1a7cf9[_0x41f0ea(0x1c7)],'created_at':_0x1a7cf9['createdAt'],'updated_at':new Date()}},_0x3c68fb=await fetch(_0x21bd51[_0x41f0ea(0x1a0)],{'method':'POST','headers':{'Content-Type':_0x41f0ea(0x1b6),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x41f0ea(0x211)](_0x27d132)}),_0x3d4770=Date['now']()-_0x279e57,_0x4c2da1=_0x3c68fb['ok']?'Success':await _0x3c68fb['text']();loggerService_1[_0x41f0ea(0x206)][_0x41f0ea(0x1b0)](_0x1a7cf9[_0x41f0ea(0x1d1)],_0x21bd51[_0x41f0ea(0x1a0)],_0x230843,_0x3c68fb['status'],_0x3d4770,_0x27d132),console[_0x41f0ea(0x161)]('Shop\x20webhook\x20sent\x20to\x20'+_0x21bd51[_0x41f0ea(0x1a0)]+_0x41f0ea(0x1d4)+_0x3c68fb['status']+'\x20('+_0x3d4770+'ms)');}catch(_0x328b6d){console[_0x41f0ea(0x17e)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x328b6d),loggerService_1[_0x41f0ea(0x206)]['logShopWebhookError'](_0x1a7cf9[_0x41f0ea(0x1d1)],_0x1a7cf9[_0x41f0ea(0x1e2)]?.[_0x41f0ea(0x158)]?.[_0x41f0ea(0x1a0)]||_0x41f0ea(0x169),'webhook_send',_0x328b6d,{});}}async[a37_0x3ca411(0x190)](_0x22d38a,_0x39a156){const _0x2ec6f2=a37_0x3ca411;try{const _0x4e5f7b={'PENDING':_0x2ec6f2(0x1d2),'PAID':_0x2ec6f2(0x1c5),'FAILED':_0x2ec6f2(0x155),'EXPIRED':_0x2ec6f2(0x1fa)},_0x1ca641=_0x4e5f7b[_0x39a156];if(!_0x1ca641||_0x1ca641===_0x2ec6f2(0x1d2))return;await telegramBotService_1[_0x2ec6f2(0x1cc)][_0x2ec6f2(0x198)](_0x22d38a[_0x2ec6f2(0x1d1)],_0x22d38a,_0x1ca641);}catch(_0x488670){console[_0x2ec6f2(0x17e)](_0x2ec6f2(0x195),_0x488670);}}async[a37_0x3ca411(0x1a3)](_0x58fb1e){const _0x296631=a37_0x3ca411;console[_0x296631(0x161)]('üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x58fb1e);const _0x429a40=await database_1[_0x296631(0x14a)][_0x296631(0x21f)]['findUnique']({'where':{'id':_0x58fb1e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x429a40)throw new Error(_0x296631(0x135));if(_0x429a40[_0x296631(0x160)]!=='cointopay')throw new Error(_0x296631(0x14e));console[_0x296631(0x161)]('‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x58fb1e),await this['checkSinglePayment'](_0x429a40),console['log'](_0x296631(0x20f)+_0x58fb1e);}[a37_0x3ca411(0x185)](){const _0x2476d6=a37_0x3ca411,_0x115efd=this['globalCheckInterval']?this[_0x2476d6(0x1cb)]:undefined,_0x5641f7=Array[_0x2476d6(0x16a)](this['paymentTimers'][_0x2476d6(0x1ba)]())[_0x2476d6(0x1c1)](_0x512b41=>({'paymentId':_0x512b41[_0x2476d6(0x174)],'gatewayPaymentId':_0x512b41[_0x2476d6(0x172)],'createdAt':_0x512b41[_0x2476d6(0x200)],'timersCount':_0x512b41[_0x2476d6(0x175)]['length']}));return{'isActive':!!this[_0x2476d6(0x21a)],'globalCheckIntervalMinutes':this[_0x2476d6(0x1cb)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x2476d6(0x186)][_0x2476d6(0x181)],'nextGlobalCheckIn':_0x115efd,'paymentTimersDetails':_0x5641f7};}[a37_0x3ca411(0x1fc)](_0xa26e19){const _0x39a590=a37_0x3ca411,_0x1725b1=this['paymentTimers'][_0x39a590(0x1cd)](_0xa26e19);if(_0x1725b1)return{'hasTimers':!![],'timersCount':_0x1725b1[_0x39a590(0x175)][_0x39a590(0x201)],'createdAt':_0x1725b1[_0x39a590(0x200)],'gatewayPaymentId':_0x1725b1[_0x39a590(0x172)]};return{'hasTimers':![]};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a37_0x3ca411(0x220)]=new CoinToPayStatusService();