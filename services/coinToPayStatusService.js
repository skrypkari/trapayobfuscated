'use strict';const a37_0xf21580=a37_0x3a97;(function(_0x3fdda1,_0x4a2a93){const _0x37474f=a37_0x3a97,_0x5ccdc2=_0x3fdda1();while(!![]){try{const _0x32b95c=-parseInt(_0x37474f(0x272))/0x1*(-parseInt(_0x37474f(0x28c))/0x2)+parseInt(_0x37474f(0x1eb))/0x3+parseInt(_0x37474f(0x25a))/0x4+parseInt(_0x37474f(0x252))/0x5+parseInt(_0x37474f(0x1bf))/0x6*(-parseInt(_0x37474f(0x264))/0x7)+parseInt(_0x37474f(0x1e6))/0x8*(-parseInt(_0x37474f(0x202))/0x9)+-parseInt(_0x37474f(0x22a))/0xa;if(_0x32b95c===_0x4a2a93)break;else _0x5ccdc2['push'](_0x5ccdc2['shift']());}catch(_0x5f374b){_0x5ccdc2['push'](_0x5ccdc2['shift']());}}}(a37_0x5138,0x6dfbe));var __importDefault=this&&this['__importDefault']||function(_0x4e93f1){return _0x4e93f1&&_0x4e93f1['__esModule']?_0x4e93f1:{'default':_0x4e93f1};};Object[a37_0xf21580(0x1e2)](exports,a37_0xf21580(0x22b),{'value':!![]}),exports[a37_0xf21580(0x296)]=exports[a37_0xf21580(0x25f)]=void 0x0;function a37_0x3a97(_0x97e685,_0x1e08f4){const _0x513857=a37_0x5138();return a37_0x3a97=function(_0x3a973b,_0x541657){_0x3a973b=_0x3a973b-0x1bc;let _0x20f09b=_0x513857[_0x3a973b];return _0x20f09b;},a37_0x3a97(_0x97e685,_0x1e08f4);}const coinToPayService_1=require(a37_0xf21580(0x1f4)),database_1=__importDefault(require(a37_0xf21580(0x21c))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService');function a37_0x5138(){const _0xfbfc5a=['\x20days\x20(created\x20before\x20','delay','.\x20Remaining\x20active\x20timers:\x20','cointopay_auto_expired','adminNotes','GLOBAL_CHECK_INTERVAL_MS','./gateways/coinToPayService','EXPIRED','\x20for\x20payment\x20','\x20status\x20unchanged\x20(','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','Unknown\x20error','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','⚠️\x20[CHECK]\x20Payment\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','size','checkAllPendingPayments','⏰\x20[EXPIRY]\x20Payment\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','webhookEvents','135MNPodw','sendPaymentStatusNotification','\x20pending\x20CoinToPay\x20payments','\x20with\x20status\x20','get','\x20\x20\x20📊\x20Status:\x20','getServiceStats','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20\x20\x20📅\x20Time:\x20','sendShopWebhook','⏰\x20[GLOBAL]\x20Payment\x20','logCoinToPayError','createdOn','floor','globalCheckInterval','\x20\x20\x20-\x20Amount:\x20','log','logShopWebhookSent','logWhiteDomainError','stack','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20details:','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','\x20not\x20found\x20in\x20database','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','../config/database','stringify','\x20\x20\x20-\x20paymentId:\x20','POST','\x20not\x20found,\x20clearing\x20timers','telegramBotService','\x20\x20\x20-\x20Status:\x20','bankDetails','checkExpiredPayments','\x20has\x20no\x20gatewayPaymentId','cointopay_status_check_error','CoinToPayService','🪙\x20[DEBUG]\x20Creating\x20','Payment\x20older\x20than\x20','11589820bsRCwr','__esModule','Payment\x20not\x20found','paymentDetails','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','checkSinglePayment','paymentId','gatewayPaymentId','\x20current\x20status:\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','h),\x20skipping\x20global\x20check','amount','💰\x20[CHECK]\x20Payment\x20','Bank\x20Details:\x20','error','Failed\x20to\x20send\x20shop\x20webhook:','✅\x20[TIMER]\x20Individual\x20check\x20#','webhook_send','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20found:','payment','logShopWebhookError','\x20triggered\x20for\x20payment\x20','createdAt',',\x20clearing\x20individual\x20timers','timers','status_check','schedulePaymentChecks','🛑\x20[SHUTDOWN]\x20Cleared\x20','\x20expired\x20CoinToPay\x20payments','\x20to\x20clear','delete','PAID','catch','confirmedOn','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','values','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','push','2902925CbANeh','toISOString','shopId','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','timestamp','setDate','unknown','❌\x20[CHECK]\x20Payment\x20','3576156ilZEqG','⏰\x20[HOURLY]\x20Payment\x20','customerName','gateway','\x20updated\x20successfully','CoinToPayStatusService','-day\x20timeout','expired','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','remitterIban','72247mNsbwm','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','iban','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20status\x20is\x20','update','includes','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','✅\x20[CHECK]\x20Payment\x20','now','9bDOkkl','\x20skipped,\x20','FAILED','\x20->\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20checked,\x20','\x20(age:\x20','webhookLog','5\x20minutes','create','✅\x20[EXPIRY]\x20Payment\x20','\x20status:\x20','checkPaymentById','🧹\x20[DEBUG]\x20Clearing\x20','payment.pending','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','message','\x20\x20\x20📝\x20Context:','sendPaymentNotification','length','\x20marked\x20as\x20paid\x20at:\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','created','\x20\x20\x20📝\x20Details:','payment.failed','checkSinglePaymentById','136362pcFrJr','webhookUrl','\x20seconds\x20(','\x20\x20\x20-\x20Gateway:\x20','❌\x20[HOURLY]\x20Payment\x20','COINTOPAY_ERROR','startPeriodicStatusCheck','paidAt','getTime','✅\x20[HOURLY]\x20Payment\x20','coinToPayStatusService','TesSoft\x20Payment\x20System/1.0','Webhook\x20event\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','stopPeriodicStatusCheck','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','description','\x20\x20\x20-\x20gatewayPaymentId:\x20','📊\x20[CHECK]\x20Payment\x20','paymentTimers','toLowerCase','has','\x20\x20\x20❌\x20Error:\x20','\x20to\x20','status','application/json','cointopay_status_check_','transactionId','\x20(after\x20','🪙\x20CoinToPayStatusService\x20initialized','map','clearPaymentTimers','198JUEMhd','\x20expired','getPaymentTimerInfo','1\x20minute','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','2\x20minutes','COINTOPAY_STATUS_CHANGE','PENDING','\x20days,\x20marking\x20as\x20EXPIRED','gatewayOrderId','\x20not\x20enabled\x20for\x20shop\x20','\x20individual\x20payment\x20timers','currency','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','default','\x20initial\x20timers\x20for\x20payment\x20','customerEmail','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','findUnique','EXPIRY_DAYS','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','🔄\x20[CHECK]\x20Updating\x20payment\x20','cointopay','not\x20found','not\x20confirmed',',\x20stopping\x20individual\x20checks','loggerService','📊\x20[HOURLY]\x20Payment\x20','coinToPayService','\x20days\x20without\x20payment\x20confirmation','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20is\x20older\x20than\x20','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','defineProperty','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','🧹\x20[CHECK]\x20Payment\x20','\x20in\x20','476488rALlcd','auto_expire','schedule_created','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','2265693HLSAEY','forEach','logCoinToPayStatus'];a37_0x5138=function(){return _0xfbfc5a;};return a37_0x5138();}class CoinToPayStatusService{constructor(){const _0x47bfcc=a37_0xf21580;this[_0x47bfcc(0x210)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x47bfcc(0x1d2)]=0x5,this[_0x47bfcc(0x29f)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x47bfcc(0x227))](),console[_0x47bfcc(0x212)](_0x47bfcc(0x1bc));}[a37_0xf21580(0x246)](_0xc681ac,_0x16e3e3){const _0x5bec59=a37_0xf21580;console[_0x5bec59(0x212)](_0x5bec59(0x250)),console['log'](_0x5bec59(0x21e)+_0xc681ac),console[_0x5bec59(0x212)](_0x5bec59(0x29d)+_0x16e3e3),this[_0x5bec59(0x1be)](_0xc681ac);const _0x1458a3=[],_0x273afa=new Date(),_0x4c78e7=[{'delay':0x1*0x3c*0x3e8,'description':_0x5bec59(0x1c2)},{'delay':0x2*0x3c*0x3e8,'description':_0x5bec59(0x1c4)},{'delay':0x5*0x3c*0x3e8,'description':_0x5bec59(0x27a)},{'delay':0x5*0x3c*0x3e8,'description':_0x5bec59(0x27a)}];console[_0x5bec59(0x212)](_0x5bec59(0x228)+_0x4c78e7['length']+_0x5bec59(0x1ce)+_0xc681ac);let _0xa03b7d=0x0;_0x4c78e7[_0x5bec59(0x1ec)]((_0x50b95f,_0xae73d7)=>{const _0x1e10ec=_0x5bec59;_0xa03b7d+=_0x50b95f[_0x1e10ec(0x1ef)];const _0xf5fcf=setTimeout(async()=>{const _0x2ffa69=_0x1e10ec;console[_0x2ffa69(0x212)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0xae73d7+0x1)+_0x2ffa69(0x241)+_0xc681ac+_0x2ffa69(0x2a8)+_0x50b95f[_0x2ffa69(0x29c)]+')');try{await this[_0x2ffa69(0x28b)](_0xc681ac),console[_0x2ffa69(0x212)](_0x2ffa69(0x23b)+(_0xae73d7+0x1)+'\x20completed\x20for\x20payment\x20'+_0xc681ac);}catch(_0x4fae66){console[_0x2ffa69(0x239)](_0x2ffa69(0x24e)+(_0xae73d7+0x1)+'\x20for\x20payment\x20'+_0xc681ac+':',_0x4fae66),this['logCoinToPayError'](_0xc681ac,_0x16e3e3,_0x4fae66,_0x2ffa69(0x245),{'checkNumber':_0xae73d7+0x1,'scheduledAfter':_0x50b95f['description'],'isIndividualCheck':!![]});}},_0xa03b7d);_0x1458a3[_0x1e10ec(0x251)](_0xf5fcf),console['log']('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0xae73d7+0x1)+_0x1e10ec(0x1f6)+_0xc681ac+_0x1e10ec(0x1e5)+_0xa03b7d/0x3e8+_0x1e10ec(0x28e)+_0x50b95f['description']+')');});const _0x2199de=setInterval(async()=>{const _0x3a9b62=_0x5bec59;console[_0x3a9b62(0x212)](_0x3a9b62(0x1ea)+_0xc681ac);try{const _0x546500=await database_1[_0x3a9b62(0x1cd)]['payment'][_0x3a9b62(0x1d1)]({'where':{'id':_0xc681ac},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x546500){console['log'](_0x3a9b62(0x290)+_0xc681ac+_0x3a9b62(0x220)),this[_0x3a9b62(0x1be)](_0xc681ac);return;}console[_0x3a9b62(0x212)](_0x3a9b62(0x1db)+_0xc681ac+_0x3a9b62(0x232)+_0x546500['status']);if(_0x546500['status']!=='PENDING'){console[_0x3a9b62(0x212)](_0x3a9b62(0x295)+_0xc681ac+_0x3a9b62(0x26b)+_0x546500['status']+_0x3a9b62(0x1d9)),this['clearPaymentTimers'](_0xc681ac);return;}const _0x42ee59=Math[_0x3a9b62(0x20f)]((Date['now']()-_0x546500[_0x3a9b62(0x242)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x42ee59>=this[_0x3a9b62(0x1d2)]){console[_0x3a9b62(0x212)](_0x3a9b62(0x25b)+_0xc681ac+_0x3a9b62(0x1e0)+this[_0x3a9b62(0x1d2)]+_0x3a9b62(0x22e)),this['clearPaymentTimers'](_0xc681ac);return;}await this[_0x3a9b62(0x28b)](_0xc681ac),console[_0x3a9b62(0x212)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0xc681ac);}catch(_0x2c6a0e){console[_0x3a9b62(0x239)](_0x3a9b62(0x21b)+_0xc681ac+':',_0x2c6a0e),this[_0x3a9b62(0x20d)](_0xc681ac,_0x16e3e3,_0x2c6a0e,_0x3a9b62(0x245),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x1458a3[_0x5bec59(0x251)](_0x2199de),this[_0x5bec59(0x29f)]['set'](_0xc681ac,{'timers':_0x1458a3,'paymentId':_0xc681ac,'gatewayPaymentId':_0x16e3e3,'createdAt':_0x273afa}),console[_0x5bec59(0x212)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x4c78e7['length']+_0x5bec59(0x200)+_0xc681ac),console['log']('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x5bec59(0x29f)][_0x5bec59(0x1fd)]),this['logCoinToPayStatus'](_0xc681ac,_0x16e3e3,'PENDING',_0x5bec59(0x1c6),'status_check',{'action':_0x5bec59(0x1e8),'scheduledChecks':_0x4c78e7[_0x5bec59(0x285)],'firstCheckIn':_0x4c78e7[0x0][_0x5bec59(0x1ef)]/0x3e8,'totalTimers':this[_0x5bec59(0x29f)][_0x5bec59(0x1fd)]});}[a37_0xf21580(0x1be)](_0x127d72){const _0x350db5=a37_0xf21580,_0x453a27=this[_0x350db5(0x29f)]['get'](_0x127d72);_0x453a27?(console['log'](_0x350db5(0x27f)+_0x453a27[_0x350db5(0x244)][_0x350db5(0x285)]+'\x20timers\x20for\x20payment\x20'+_0x127d72),_0x453a27[_0x350db5(0x244)][_0x350db5(0x1ec)]((_0x28ba40,_0x4ac187)=>{const _0x3f3e18=_0x350db5;_0x28ba40&&(clearTimeout(_0x28ba40),clearInterval(_0x28ba40),console[_0x3f3e18(0x212)](_0x3f3e18(0x26f)+(_0x4ac187+0x1)+_0x3f3e18(0x1f6)+_0x127d72));}),this[_0x350db5(0x29f)][_0x350db5(0x24a)](_0x127d72),console[_0x350db5(0x212)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x127d72+_0x350db5(0x1f0)+this[_0x350db5(0x29f)][_0x350db5(0x1fd)])):console[_0x350db5(0x212)](_0x350db5(0x1d0)+_0x127d72+_0x350db5(0x249));}async[a37_0xf21580(0x28b)](_0x23a442){const _0x3af2e2=a37_0xf21580;console[_0x3af2e2(0x212)](_0x3af2e2(0x1cc)+_0x23a442);const _0x5ad198=await database_1[_0x3af2e2(0x1cd)][_0x3af2e2(0x23f)][_0x3af2e2(0x1d1)]({'where':{'id':_0x23a442},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5ad198){console['log'](_0x3af2e2(0x259)+_0x23a442+_0x3af2e2(0x21a));return;}console[_0x3af2e2(0x212)](_0x3af2e2(0x29e)+_0x23a442+_0x3af2e2(0x23e)),console[_0x3af2e2(0x212)](_0x3af2e2(0x28f)+_0x5ad198[_0x3af2e2(0x25d)]),console[_0x3af2e2(0x212)](_0x3af2e2(0x222)+_0x5ad198[_0x3af2e2(0x2a4)]),console['log'](_0x3af2e2(0x269)+_0x5ad198[_0x3af2e2(0x231)]),console[_0x3af2e2(0x212)](_0x3af2e2(0x211)+_0x5ad198[_0x3af2e2(0x236)]+'\x20'+_0x5ad198['currency']),console[_0x3af2e2(0x212)]('\x20\x20\x20-\x20ShopId:\x20'+_0x5ad198['shopId']);if(_0x5ad198['gateway']!==_0x3af2e2(0x1d6)){console['log'](_0x3af2e2(0x1fb)+_0x23a442+_0x3af2e2(0x299)+_0x5ad198[_0x3af2e2(0x25d)]+')');return;}if(_0x5ad198[_0x3af2e2(0x2a4)]!=='PENDING'){console['log'](_0x3af2e2(0x1fb)+_0x23a442+_0x3af2e2(0x26b)+_0x5ad198['status']+_0x3af2e2(0x1d9)),this['clearPaymentTimers'](_0x23a442);return;}if(!_0x5ad198[_0x3af2e2(0x231)]){console[_0x3af2e2(0x212)](_0x3af2e2(0x1fb)+_0x23a442+_0x3af2e2(0x225));return;}console['log'](_0x3af2e2(0x270)+_0x23a442+_0x3af2e2(0x1fc)),await this[_0x3af2e2(0x22f)](_0x5ad198);}[a37_0xf21580(0x1ed)](_0x1d7d4e,_0x3ba03b,_0x51073f,_0x4ee874,_0x4ee6c9,_0x1c16bd){const _0x457a56=a37_0xf21580,_0x2ebd5e={'type':_0x457a56(0x1c5),'paymentId':_0x1d7d4e,'gatewayPaymentId':_0x3ba03b,'oldStatus':_0x51073f,'newStatus':_0x4ee874,'source':_0x4ee6c9,'timestamp':new Date()[_0x457a56(0x253)](),'details':_0x1c16bd||{}};loggerService_1[_0x457a56(0x1da)][_0x457a56(0x1ed)](_0x2ebd5e),console[_0x457a56(0x212)](_0x457a56(0x219)+_0x1d7d4e+'\x20('+_0x3ba03b+')'),console['log'](_0x457a56(0x207)+_0x51073f+_0x457a56(0x275)+_0x4ee874),console[_0x457a56(0x212)]('\x20\x20\x20📍\x20Source:\x20'+_0x4ee6c9),console[_0x457a56(0x212)](_0x457a56(0x20a)+_0x2ebd5e[_0x457a56(0x256)]),_0x1c16bd&&console[_0x457a56(0x212)](_0x457a56(0x289),_0x1c16bd);}[a37_0xf21580(0x20d)](_0x59540a,_0x2a6095,_0x5b9c72,_0x3179f8,_0x2fc5d6){const _0x433af5=a37_0xf21580,_0x39cc12={'type':_0x433af5(0x291),'paymentId':_0x59540a,'gatewayPaymentId':_0x2a6095,'error':_0x5b9c72 instanceof Error?{'message':_0x5b9c72[_0x433af5(0x282)],'stack':_0x5b9c72[_0x433af5(0x215)]}:_0x5b9c72,'source':_0x3179f8,'timestamp':new Date()[_0x433af5(0x253)](),'context':_0x2fc5d6||{}};loggerService_1[_0x433af5(0x1da)][_0x433af5(0x20d)](_0x39cc12),console[_0x433af5(0x239)](_0x433af5(0x233)+_0x59540a+'\x20('+_0x2a6095+')'),console[_0x433af5(0x239)](_0x433af5(0x2a2)+(_0x5b9c72 instanceof Error?_0x5b9c72[_0x433af5(0x282)]:_0x5b9c72)),console[_0x433af5(0x239)]('\x20\x20\x20📍\x20Source:\x20'+_0x3179f8),console[_0x433af5(0x239)]('\x20\x20\x20📅\x20Time:\x20'+_0x39cc12[_0x433af5(0x256)]),_0x2fc5d6&&console[_0x433af5(0x239)](_0x433af5(0x283),_0x2fc5d6);}[a37_0xf21580(0x292)](){const _0x48a2b1=a37_0xf21580;console[_0x48a2b1(0x212)](_0x48a2b1(0x255)),this[_0x48a2b1(0x1fe)]()[_0x48a2b1(0x24c)](_0x541452=>{const _0x3bfc41=_0x48a2b1;console[_0x3bfc41(0x239)](_0x3bfc41(0x1f8),_0x541452);}),this[_0x48a2b1(0x210)]=setInterval(async()=>{const _0x2ffb90=_0x48a2b1;try{console[_0x2ffb90(0x212)](_0x2ffb90(0x265)),await this[_0x2ffb90(0x1fe)](),console['log'](_0x2ffb90(0x262));}catch(_0x52da9e){console[_0x2ffb90(0x239)]('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x52da9e);}},this[_0x48a2b1(0x1f3)]),console['log'](_0x48a2b1(0x1e1));}[a37_0xf21580(0x29a)](){const _0x151878=a37_0xf21580;console[_0x151878(0x212)](_0x151878(0x23d));this[_0x151878(0x210)]&&(clearInterval(this[_0x151878(0x210)]),this['globalCheckInterval']=null,console[_0x151878(0x212)](_0x151878(0x234)));const _0x16c0d4=this[_0x151878(0x29f)][_0x151878(0x1fd)];for(const [_0x291f35]of this[_0x151878(0x29f)]){this[_0x151878(0x1be)](_0x291f35);}console['log'](_0x151878(0x247)+_0x16c0d4+_0x151878(0x1ca));}async[a37_0xf21580(0x1fe)](){const _0x51210b=a37_0xf21580;try{console[_0x51210b(0x212)](_0x51210b(0x281));const _0x104f01=await database_1['default'][_0x51210b(0x23f)]['findMany']({'where':{'gateway':_0x51210b(0x1d6),'status':_0x51210b(0x1c6),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x51210b(0x212)]('🪙\x20[GLOBAL]\x20Found\x20'+_0x104f01[_0x51210b(0x285)]+_0x51210b(0x204));if(_0x104f01[_0x51210b(0x285)]===0x0){console[_0x51210b(0x212)](_0x51210b(0x29b));return;}const _0x177b69=await this[_0x51210b(0x224)](_0x104f01);console[_0x51210b(0x212)]('⏰\x20[GLOBAL]\x20Found\x20'+_0x177b69[_0x51210b(0x285)]+_0x51210b(0x248));let _0x8b136=0x0,_0x3d5706=0x0;for(const _0x1d6e77 of _0x104f01){try{if(_0x177b69[_0x51210b(0x26d)](_0x1d6e77['id'])){console[_0x51210b(0x212)](_0x51210b(0x20c)+_0x1d6e77['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x3d5706++;continue;}if(this[_0x51210b(0x29f)][_0x51210b(0x2a1)](_0x1d6e77['id'])){console[_0x51210b(0x212)](_0x51210b(0x20c)+_0x1d6e77['id']+_0x51210b(0x276)),_0x3d5706++;continue;}const _0x3fc446=(Date[_0x51210b(0x271)]()-_0x1d6e77[_0x51210b(0x242)][_0x51210b(0x294)]())/(0x3e8*0x3c*0x3c);if(_0x3fc446<0x1){console['log'](_0x51210b(0x20c)+_0x1d6e77['id']+'\x20is\x20too\x20new\x20('+_0x3fc446['toFixed'](0x1)+_0x51210b(0x235)),_0x3d5706++;continue;}console[_0x51210b(0x212)](_0x51210b(0x1c3)+_0x1d6e77['id']+_0x51210b(0x278)+_0x3fc446['toFixed'](0x1)+'h)'),await this[_0x51210b(0x22f)](_0x1d6e77),_0x8b136++,await new Promise(_0x3f4ecf=>setTimeout(_0x3f4ecf,0x7d0));}catch(_0x7a2739){console[_0x51210b(0x239)]('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x1d6e77['id']+':',_0x7a2739),this['logCoinToPayError'](_0x1d6e77['id'],_0x1d6e77[_0x51210b(0x231)]||_0x51210b(0x258),_0x7a2739,_0x51210b(0x245),{'isGlobalCheck':!![],'paymentAmount':_0x1d6e77[_0x51210b(0x236)],'paymentCurrency':_0x1d6e77[_0x51210b(0x1cb)],'shopId':_0x1d6e77['shopId'],'createdAt':_0x1d6e77['createdAt']}),loggerService_1[_0x51210b(0x1da)][_0x51210b(0x214)](_0x51210b(0x1d6),'/status/'+_0x1d6e77[_0x51210b(0x231)],_0x7a2739);}}console[_0x51210b(0x212)](_0x51210b(0x209)+_0x8b136+_0x51210b(0x277)+_0x3d5706+_0x51210b(0x273)+_0x177b69[_0x51210b(0x285)]+_0x51210b(0x1c0));}catch(_0x4a5ebd){console[_0x51210b(0x239)]('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x4a5ebd);}}async[a37_0xf21580(0x224)](_0x33284c){const _0x582f8a=a37_0xf21580,_0x151d75=[],_0xac9f2c=new Date();_0xac9f2c[_0x582f8a(0x257)](_0xac9f2c['getDate']()-this['EXPIRY_DAYS']),console[_0x582f8a(0x212)](_0x582f8a(0x268)+this[_0x582f8a(0x1d2)]+_0x582f8a(0x1ee)+_0xac9f2c[_0x582f8a(0x253)]()+')');for(const _0x76d640 of _0x33284c){if(_0x76d640['createdAt']<_0xac9f2c){console[_0x582f8a(0x212)](_0x582f8a(0x1ff)+_0x76d640['id']+_0x582f8a(0x1e0)+this['EXPIRY_DAYS']+_0x582f8a(0x1c7));try{this['logCoinToPayStatus'](_0x76d640['id'],_0x76d640[_0x582f8a(0x231)]||_0x582f8a(0x258),'PENDING',_0x582f8a(0x1f5),'auto_expire',{'reason':_0x582f8a(0x229)+this[_0x582f8a(0x1d2)]+'\x20days','createdAt':_0x76d640[_0x582f8a(0x242)],'daysSinceCreation':Math[_0x582f8a(0x20f)]((Date[_0x582f8a(0x271)]()-_0x76d640[_0x582f8a(0x242)][_0x582f8a(0x294)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x76d640[_0x582f8a(0x236)],'paymentCurrency':_0x76d640[_0x582f8a(0x1cb)],'shopId':_0x76d640[_0x582f8a(0x254)]}),await database_1[_0x582f8a(0x1cd)][_0x582f8a(0x23f)][_0x582f8a(0x26c)]({'where':{'id':_0x76d640['id']},'data':{'status':_0x582f8a(0x1f5),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this['EXPIRY_DAYS']+_0x582f8a(0x1dd)}}),await database_1[_0x582f8a(0x1cd)][_0x582f8a(0x279)][_0x582f8a(0x27b)]({'data':{'paymentId':_0x76d640['id'],'shopId':_0x76d640[_0x582f8a(0x254)],'event':_0x582f8a(0x1f1),'statusCode':0xc8,'responseBody':JSON[_0x582f8a(0x21d)]({'reason':_0x582f8a(0x229)+this[_0x582f8a(0x1d2)]+'\x20days','createdAt':_0x76d640[_0x582f8a(0x242)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math['floor']((Date[_0x582f8a(0x271)]()-_0x76d640[_0x582f8a(0x242)][_0x582f8a(0x294)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x582f8a(0x20b)](_0x76d640,'EXPIRED'),await this['sendPaymentStatusNotification'](_0x76d640,_0x582f8a(0x1f5)),this['clearPaymentTimers'](_0x76d640['id']),_0x151d75['push'](_0x76d640['id']),console['log'](_0x582f8a(0x27c)+_0x76d640['id']+_0x582f8a(0x1df)+this[_0x582f8a(0x1d2)]+_0x582f8a(0x260));}catch(_0x1870a5){console[_0x582f8a(0x239)](_0x582f8a(0x26e)+_0x76d640['id']+':',_0x1870a5),this[_0x582f8a(0x20d)](_0x76d640['id'],_0x76d640['gatewayPaymentId']||_0x582f8a(0x258),_0x1870a5,_0x582f8a(0x1e7),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x76d640[_0x582f8a(0x242)],'daysSinceCreation':Math[_0x582f8a(0x20f)]((Date[_0x582f8a(0x271)]()-_0x76d640[_0x582f8a(0x242)][_0x582f8a(0x294)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x151d75;}async[a37_0xf21580(0x22f)](_0x46f304){const _0x52edfd=a37_0xf21580;if(!_0x46f304[_0x52edfd(0x231)]){console[_0x52edfd(0x212)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x46f304['id']+_0x52edfd(0x287));return;}console[_0x52edfd(0x212)]('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x46f304['id']+'\x20('+_0x46f304[_0x52edfd(0x231)]+')');try{const _0x46b5a7=await this[_0x52edfd(0x1dc)]['checkPaymentStatus'](_0x46f304[_0x52edfd(0x231)]);console[_0x52edfd(0x212)]('📊\x20[CHECK]\x20Payment\x20'+_0x46f304['id']+_0x52edfd(0x27d)+_0x46b5a7[_0x52edfd(0x2a4)]);_0x46b5a7['paymentDetails']&&console[_0x52edfd(0x212)]('📊\x20[CHECK]\x20Payment\x20'+_0x46f304['id']+_0x52edfd(0x218),{'iban':_0x46b5a7[_0x52edfd(0x22d)]['iban']||_0x52edfd(0x1d7),'transactionId':_0x46b5a7['paymentDetails'][_0x52edfd(0x2a7)],'createdOn':_0x46b5a7[_0x52edfd(0x22d)][_0x52edfd(0x20e)],'confirmedOn':_0x46b5a7['paymentDetails'][_0x52edfd(0x24d)]||_0x52edfd(0x1d8)});if(_0x46b5a7[_0x52edfd(0x2a4)]!==_0x46f304[_0x52edfd(0x2a4)]){console[_0x52edfd(0x212)](_0x52edfd(0x1d5)+_0x46f304['id']+'\x20status\x20from\x20'+_0x46f304[_0x52edfd(0x2a4)]+_0x52edfd(0x2a3)+_0x46b5a7[_0x52edfd(0x2a4)]),this[_0x52edfd(0x1ed)](_0x46f304['id'],_0x46f304['gatewayPaymentId'],_0x46f304['status'],_0x46b5a7[_0x52edfd(0x2a4)],_0x52edfd(0x245),{'paymentDetails':_0x46b5a7[_0x52edfd(0x22d)],'amount':_0x46b5a7['amount'],'currency':_0x46b5a7[_0x52edfd(0x1cb)],'shopId':_0x46f304[_0x52edfd(0x254)],'checkTimestamp':new Date()[_0x52edfd(0x253)]()});const _0x59be1b={'status':_0x46b5a7[_0x52edfd(0x2a4)],'updatedAt':new Date()};_0x46b5a7[_0x52edfd(0x2a4)]==='PAID'&&_0x46f304[_0x52edfd(0x2a4)]!==_0x52edfd(0x24b)&&(_0x59be1b[_0x52edfd(0x293)]=new Date(),console[_0x52edfd(0x212)](_0x52edfd(0x237)+_0x46f304['id']+_0x52edfd(0x286)+_0x59be1b['paidAt'][_0x52edfd(0x253)]()));if(_0x46b5a7[_0x52edfd(0x22d)]){const _0x34cfb7=_0x46b5a7[_0x52edfd(0x22d)];_0x34cfb7['iban']&&(_0x59be1b[_0x52edfd(0x263)]=_0x34cfb7[_0x52edfd(0x266)],console['log'](_0x52edfd(0x216)+_0x34cfb7[_0x52edfd(0x266)]));if(_0x34cfb7[_0x52edfd(0x223)]){const _0x2f4708=_0x46f304[_0x52edfd(0x1f2)]||'',_0x3b2cf7=_0x52edfd(0x238)+_0x34cfb7[_0x52edfd(0x223)];_0x59be1b['adminNotes']=_0x2f4708?_0x2f4708+'\x0a\x0a'+_0x3b2cf7:_0x3b2cf7,console[_0x52edfd(0x212)](_0x52edfd(0x1de));}_0x34cfb7[_0x52edfd(0x2a7)]&&console[_0x52edfd(0x212)](_0x52edfd(0x267)+_0x34cfb7['transactionId']),_0x34cfb7[_0x52edfd(0x24d)]&&console[_0x52edfd(0x212)](_0x52edfd(0x1fa)+_0x34cfb7['confirmedOn']);}await database_1['default'][_0x52edfd(0x23f)][_0x52edfd(0x26c)]({'where':{'id':_0x46f304['id']},'data':_0x59be1b}),await database_1[_0x52edfd(0x1cd)][_0x52edfd(0x279)][_0x52edfd(0x27b)]({'data':{'paymentId':_0x46f304['id'],'shopId':_0x46f304[_0x52edfd(0x254)],'event':_0x52edfd(0x2a6)+_0x46b5a7['status'][_0x52edfd(0x2a0)](),'statusCode':0xc8,'responseBody':JSON[_0x52edfd(0x21d)]({'oldStatus':_0x46f304[_0x52edfd(0x2a4)],'newStatus':_0x46b5a7[_0x52edfd(0x2a4)],'paymentDetails':_0x46b5a7[_0x52edfd(0x22d)],'checkedAt':new Date()[_0x52edfd(0x253)]()})}}),await this[_0x52edfd(0x20b)](_0x46f304,_0x46b5a7[_0x52edfd(0x2a4)]),await this[_0x52edfd(0x203)](_0x46f304,_0x46b5a7[_0x52edfd(0x2a4)]),_0x46b5a7[_0x52edfd(0x2a4)]!==_0x52edfd(0x1c6)&&(console['log'](_0x52edfd(0x1e4)+_0x46f304['id']+'\x20status\x20changed\x20to\x20'+_0x46b5a7[_0x52edfd(0x2a4)]+_0x52edfd(0x243)),this[_0x52edfd(0x1be)](_0x46f304['id'])),console[_0x52edfd(0x212)](_0x52edfd(0x270)+_0x46f304['id']+_0x52edfd(0x25e));}else console['log'](_0x52edfd(0x29e)+_0x46f304['id']+_0x52edfd(0x1f7)+_0x46b5a7['status']+')'),this[_0x52edfd(0x1ed)](_0x46f304['id'],_0x46f304[_0x52edfd(0x231)],_0x46f304[_0x52edfd(0x2a4)],_0x46b5a7[_0x52edfd(0x2a4)],_0x52edfd(0x245),{'statusUnchanged':!![],'paymentDetails':_0x46b5a7[_0x52edfd(0x22d)],'amount':_0x46b5a7[_0x52edfd(0x236)],'currency':_0x46b5a7[_0x52edfd(0x1cb)],'shopId':_0x46f304[_0x52edfd(0x254)],'checkTimestamp':new Date()[_0x52edfd(0x253)]()});}catch(_0x19d79a){console[_0x52edfd(0x239)](_0x52edfd(0x1d3)+_0x46f304['id']+':',_0x19d79a),this[_0x52edfd(0x20d)](_0x46f304['id'],_0x46f304[_0x52edfd(0x231)],_0x19d79a,'status_check',{'paymentAmount':_0x46f304[_0x52edfd(0x236)],'paymentCurrency':_0x46f304['currency'],'shopId':_0x46f304[_0x52edfd(0x254)],'createdAt':_0x46f304['createdAt']}),await database_1[_0x52edfd(0x1cd)][_0x52edfd(0x279)]['create']({'data':{'paymentId':_0x46f304['id'],'shopId':_0x46f304[_0x52edfd(0x254)],'event':_0x52edfd(0x226),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x19d79a instanceof Error?_0x19d79a[_0x52edfd(0x282)]:_0x52edfd(0x1f9),'gatewayPaymentId':_0x46f304[_0x52edfd(0x231)],'checkedAt':new Date()[_0x52edfd(0x253)]()})}});}}async[a37_0xf21580(0x20b)](_0x3b58f1,_0x5a5fa7){const _0xbb2927=a37_0xf21580,_0x5da04f=Date[_0xbb2927(0x271)]();try{const _0x545ce8=_0x3b58f1['shop'],_0x355643=_0x545ce8['settings'];if(!_0x355643?.[_0xbb2927(0x28d)]){console[_0xbb2927(0x212)](_0xbb2927(0x1e3)+_0x545ce8['id']);return;}const _0x4e7519=_0x5a5fa7==='PAID'?'payment.success':_0x5a5fa7===_0xbb2927(0x274)?_0xbb2927(0x28a):_0x5a5fa7===_0xbb2927(0x1f5)?_0xbb2927(0x28a):_0xbb2927(0x280);if(!_0x355643[_0xbb2927(0x201)]?.[_0xbb2927(0x26d)](_0x4e7519)){console[_0xbb2927(0x212)](_0xbb2927(0x298)+_0x4e7519+_0xbb2927(0x1c9)+_0x545ce8['id']);return;}const _0x58f258={'event':_0x4e7519,'payment':{'id':_0x3b58f1['id'],'order_id':_0x3b58f1['orderId'],'gateway_order_id':_0x3b58f1[_0xbb2927(0x1c8)],'gateway':'0100','amount':_0x3b58f1['amount'],'currency':_0x3b58f1[_0xbb2927(0x1cb)],'status':_0x5a5fa7['toLowerCase'](),'customer_email':_0x3b58f1[_0xbb2927(0x1cf)],'customer_name':_0x3b58f1[_0xbb2927(0x25c)],'created_at':_0x3b58f1[_0xbb2927(0x242)],'updated_at':new Date()}},_0xdba322=await fetch(_0x355643['webhookUrl'],{'method':_0xbb2927(0x21f),'headers':{'Content-Type':_0xbb2927(0x2a5),'User-Agent':_0xbb2927(0x297)},'body':JSON['stringify'](_0x58f258)}),_0x563b7b=Date['now']()-_0x5da04f,_0x327d7c=_0xdba322['ok']?'Success':await _0xdba322['text']();loggerService_1[_0xbb2927(0x1da)][_0xbb2927(0x213)](_0x3b58f1['shopId'],_0x355643[_0xbb2927(0x28d)],_0x4e7519,_0xdba322[_0xbb2927(0x2a4)],_0x563b7b,_0x58f258),console[_0xbb2927(0x212)]('Shop\x20webhook\x20sent\x20to\x20'+_0x355643[_0xbb2927(0x28d)]+_0xbb2927(0x205)+_0xdba322[_0xbb2927(0x2a4)]+'\x20('+_0x563b7b+'ms)');}catch(_0x47447b){console[_0xbb2927(0x239)](_0xbb2927(0x23a),_0x47447b),loggerService_1['loggerService'][_0xbb2927(0x240)](_0x3b58f1[_0xbb2927(0x254)],_0x3b58f1['shop']?.['settings']?.[_0xbb2927(0x28d)]||_0xbb2927(0x258),_0xbb2927(0x23c),_0x47447b,{});}}async[a37_0xf21580(0x203)](_0x22222a,_0x36a379){const _0x5b2207=a37_0xf21580;try{const _0x5ed85b={'PENDING':_0x5b2207(0x288),'PAID':'paid','FAILED':'failed','EXPIRED':_0x5b2207(0x261)},_0x363e2c=_0x5ed85b[_0x36a379];if(!_0x363e2c||_0x363e2c==='created')return;await telegramBotService_1[_0x5b2207(0x221)][_0x5b2207(0x284)](_0x22222a[_0x5b2207(0x254)],_0x22222a,_0x363e2c);}catch(_0xcc2312){console[_0x5b2207(0x239)](_0x5b2207(0x1d4),_0xcc2312);}}async[a37_0xf21580(0x27e)](_0x1d97c7){const _0x44242d=a37_0xf21580;console[_0x44242d(0x212)](_0x44242d(0x1e9)+_0x1d97c7);const _0x3e7e60=await database_1['default'][_0x44242d(0x23f)][_0x44242d(0x1d1)]({'where':{'id':_0x1d97c7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3e7e60)throw new Error(_0x44242d(0x22c));if(_0x3e7e60[_0x44242d(0x25d)]!==_0x44242d(0x1d6))throw new Error(_0x44242d(0x217));console[_0x44242d(0x212)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x1d97c7),await this['checkSinglePayment'](_0x3e7e60),console[_0x44242d(0x212)](_0x44242d(0x26a)+_0x1d97c7);}[a37_0xf21580(0x208)](){const _0x1666cb=a37_0xf21580,_0x3bfb3a=this['globalCheckInterval']?this[_0x1666cb(0x1f3)]:undefined,_0x286782=Array['from'](this[_0x1666cb(0x29f)][_0x1666cb(0x24f)]())[_0x1666cb(0x1bd)](_0xc54656=>({'paymentId':_0xc54656[_0x1666cb(0x230)],'gatewayPaymentId':_0xc54656[_0x1666cb(0x231)],'createdAt':_0xc54656[_0x1666cb(0x242)],'timersCount':_0xc54656[_0x1666cb(0x244)][_0x1666cb(0x285)]}));return{'isActive':!!this[_0x1666cb(0x210)],'globalCheckIntervalMinutes':this[_0x1666cb(0x1f3)]/(0x3e8*0x3c),'expiryDays':this[_0x1666cb(0x1d2)],'activeIndividualTimers':this[_0x1666cb(0x29f)]['size'],'nextGlobalCheckIn':_0x3bfb3a,'paymentTimersDetails':_0x286782};}[a37_0xf21580(0x1c1)](_0x2d088f){const _0x4afd8b=a37_0xf21580,_0x58e213=this[_0x4afd8b(0x29f)][_0x4afd8b(0x206)](_0x2d088f);if(_0x58e213)return{'hasTimers':!![],'timersCount':_0x58e213[_0x4afd8b(0x244)][_0x4afd8b(0x285)],'createdAt':_0x58e213['createdAt'],'gatewayPaymentId':_0x58e213[_0x4afd8b(0x231)]};return{'hasTimers':![]};}}exports[a37_0xf21580(0x25f)]=CoinToPayStatusService,exports[a37_0xf21580(0x296)]=new CoinToPayStatusService();