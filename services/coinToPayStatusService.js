'use strict';const a35_0x17c1df=a35_0x44c9;(function(_0xfa82cb,_0x48ee84){const _0x52ff07=a35_0x44c9,_0x13603d=_0xfa82cb();while(!![]){try{const _0x10178b=-parseInt(_0x52ff07(0x1eb))/0x1+parseInt(_0x52ff07(0x1c7))/0x2+-parseInt(_0x52ff07(0x155))/0x3*(-parseInt(_0x52ff07(0x157))/0x4)+parseInt(_0x52ff07(0x1e6))/0x5*(-parseInt(_0x52ff07(0x1c5))/0x6)+parseInt(_0x52ff07(0x1dc))/0x7+-parseInt(_0x52ff07(0x204))/0x8+-parseInt(_0x52ff07(0x20b))/0x9*(-parseInt(_0x52ff07(0x147))/0xa);if(_0x10178b===_0x48ee84)break;else _0x13603d['push'](_0x13603d['shift']());}catch(_0x595ad2){_0x13603d['push'](_0x13603d['shift']());}}}(a35_0xcdde,0xd226c));var __importDefault=this&&this[a35_0x17c1df(0x1d0)]||function(_0x238bac){const _0x36344c=a35_0x17c1df;return _0x238bac&&_0x238bac[_0x36344c(0x158)]?_0x238bac:{'default':_0x238bac};};Object[a35_0x17c1df(0x1ec)](exports,'__esModule',{'value':!![]}),exports[a35_0x17c1df(0x1c3)]=exports[a35_0x17c1df(0x17f)]=void 0x0;const coinToPayService_1=require(a35_0x17c1df(0x14f)),database_1=__importDefault(require(a35_0x17c1df(0x200))),telegramBotService_1=require(a35_0x17c1df(0x1d6)),loggerService_1=require(a35_0x17c1df(0x21a));function a35_0x44c9(_0x38f2f1,_0x9bc2db){const _0xcdde8b=a35_0xcdde();return a35_0x44c9=function(_0x44c951,_0x5c3069){_0x44c951=_0x44c951-0x140;let _0xa1fd2=_0xcdde8b[_0x44c951];return _0xa1fd2;},a35_0x44c9(_0x38f2f1,_0x9bc2db);}class CoinToPayStatusService{constructor(){const _0x19c2ce=a35_0x17c1df;this['globalCheckInterval']=null,this[_0x19c2ce(0x15f)]=0x3c*0x3c*0x3e8,this[_0x19c2ce(0x1cb)]=0x5,this[_0x19c2ce(0x162)]=new Map(),this[_0x19c2ce(0x168)]=new coinToPayService_1[(_0x19c2ce(0x15a))](),console[_0x19c2ce(0x163)](_0x19c2ce(0x152));}[a35_0x17c1df(0x195)](_0x133de8,_0x3f7cba){const _0x4d6512=a35_0x17c1df;console[_0x4d6512(0x163)](_0x4d6512(0x146)),console['log']('\x20\x20\x20-\x20paymentId:\x20'+_0x133de8),console['log'](_0x4d6512(0x1ca)+_0x3f7cba),this[_0x4d6512(0x212)](_0x133de8);const _0x3abc00=[],_0x3c025c=new Date(),_0x430ad7=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x4d6512(0x143)},{'delay':0x5*0x3c*0x3e8,'description':_0x4d6512(0x19f)},{'delay':0x5*0x3c*0x3e8,'description':_0x4d6512(0x19f)}];console[_0x4d6512(0x163)](_0x4d6512(0x1c4)+_0x430ad7[_0x4d6512(0x1aa)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x133de8);let _0x4dbbae=0x0;_0x430ad7[_0x4d6512(0x164)]((_0x6e5be3,_0x16d3fa)=>{const _0x138742=_0x4d6512;_0x4dbbae+=_0x6e5be3[_0x138742(0x1b7)];const _0x1bba4d=setTimeout(async()=>{const _0x2ffbb1=_0x138742;console['log'](_0x2ffbb1(0x217)+(_0x16d3fa+0x1)+_0x2ffbb1(0x1af)+_0x133de8+_0x2ffbb1(0x192)+_0x6e5be3[_0x2ffbb1(0x169)]+')');try{await this[_0x2ffbb1(0x1cf)](_0x133de8),console[_0x2ffbb1(0x163)](_0x2ffbb1(0x1e3)+(_0x16d3fa+0x1)+_0x2ffbb1(0x17d)+_0x133de8);}catch(_0x45c701){console[_0x2ffbb1(0x214)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x16d3fa+0x1)+_0x2ffbb1(0x1ee)+_0x133de8+':',_0x45c701),this[_0x2ffbb1(0x18b)](_0x133de8,_0x3f7cba,_0x45c701,_0x2ffbb1(0x1c9),{'checkNumber':_0x16d3fa+0x1,'scheduledAfter':_0x6e5be3[_0x2ffbb1(0x169)],'isIndividualCheck':!![]});}},_0x4dbbae);_0x3abc00[_0x138742(0x21b)](_0x1bba4d),console[_0x138742(0x163)](_0x138742(0x202)+(_0x16d3fa+0x1)+'\x20for\x20payment\x20'+_0x133de8+_0x138742(0x19b)+_0x4dbbae/0x3e8+_0x138742(0x190)+_0x6e5be3[_0x138742(0x169)]+')');});const _0x38ce60=setInterval(async()=>{const _0x3a4c7e=_0x4d6512;console[_0x3a4c7e(0x163)]('ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x133de8);try{const _0x431676=await database_1[_0x3a4c7e(0x1e0)][_0x3a4c7e(0x18c)][_0x3a4c7e(0x220)]({'where':{'id':_0x133de8},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x431676){console[_0x3a4c7e(0x163)](_0x3a4c7e(0x1ce)+_0x133de8+_0x3a4c7e(0x189)),this[_0x3a4c7e(0x212)](_0x133de8);return;}console[_0x3a4c7e(0x163)](_0x3a4c7e(0x19d)+_0x133de8+_0x3a4c7e(0x1ed)+_0x431676[_0x3a4c7e(0x175)]);if(_0x431676['status']!=='PENDING'){console[_0x3a4c7e(0x163)](_0x3a4c7e(0x1a0)+_0x133de8+'\x20status\x20is\x20'+_0x431676['status']+_0x3a4c7e(0x1fc)),this['clearPaymentTimers'](_0x133de8);return;}const _0x366cf9=Math[_0x3a4c7e(0x1a1)]((Date[_0x3a4c7e(0x1b2)]()-_0x431676['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x366cf9>=this[_0x3a4c7e(0x1cb)]){console[_0x3a4c7e(0x163)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x133de8+'\x20is\x20older\x20than\x20'+this[_0x3a4c7e(0x1cb)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x3a4c7e(0x212)](_0x133de8);return;}await this['checkSinglePaymentById'](_0x133de8),console[_0x3a4c7e(0x163)]('‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x133de8);}catch(_0x578775){console['error']('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x133de8+':',_0x578775),this[_0x3a4c7e(0x18b)](_0x133de8,_0x3f7cba,_0x578775,_0x3a4c7e(0x1c9),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3abc00[_0x4d6512(0x21b)](_0x38ce60),this[_0x4d6512(0x162)][_0x4d6512(0x201)](_0x133de8,{'timers':_0x3abc00,'paymentId':_0x133de8,'gatewayPaymentId':_0x3f7cba,'createdAt':_0x3c025c}),console[_0x4d6512(0x163)](_0x4d6512(0x19e)+_0x430ad7['length']+_0x4d6512(0x15e)+_0x133de8),console['log']('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this['paymentTimers'][_0x4d6512(0x1a9)]),this['logCoinToPayStatus'](_0x133de8,_0x3f7cba,_0x4d6512(0x153),_0x4d6512(0x153),_0x4d6512(0x1c9),{'action':_0x4d6512(0x1ab),'scheduledChecks':_0x430ad7[_0x4d6512(0x1aa)],'firstCheckIn':_0x430ad7[0x0][_0x4d6512(0x1b7)]/0x3e8,'totalTimers':this[_0x4d6512(0x162)]['size']});}[a35_0x17c1df(0x212)](_0x32b200){const _0x3ca208=a35_0x17c1df,_0x335b00=this['paymentTimers'][_0x3ca208(0x1d5)](_0x32b200);_0x335b00?(console['log'](_0x3ca208(0x1d4)+_0x335b00[_0x3ca208(0x1a3)][_0x3ca208(0x1aa)]+'\x20timers\x20for\x20payment\x20'+_0x32b200),_0x335b00[_0x3ca208(0x1a3)]['forEach']((_0x54b6e4,_0xe48402)=>{const _0x283fd9=_0x3ca208;_0x54b6e4&&(clearTimeout(_0x54b6e4),clearInterval(_0x54b6e4),console[_0x283fd9(0x163)](_0x283fd9(0x177)+(_0xe48402+0x1)+_0x283fd9(0x1ee)+_0x32b200));}),this[_0x3ca208(0x162)][_0x3ca208(0x172)](_0x32b200),console[_0x3ca208(0x163)](_0x3ca208(0x1d2)+_0x32b200+_0x3ca208(0x1db)+this['paymentTimers'][_0x3ca208(0x1a9)])):console[_0x3ca208(0x163)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x32b200+_0x3ca208(0x1a4));}async[a35_0x17c1df(0x1cf)](_0x2ed33a){const _0x5a19b6=a35_0x17c1df;console[_0x5a19b6(0x163)](_0x5a19b6(0x165)+_0x2ed33a);const _0x49fc74=await database_1[_0x5a19b6(0x1e0)]['payment']['findUnique']({'where':{'id':_0x2ed33a},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x49fc74){console['log'](_0x5a19b6(0x1f0)+_0x2ed33a+_0x5a19b6(0x156));return;}console[_0x5a19b6(0x163)](_0x5a19b6(0x187)+_0x2ed33a+_0x5a19b6(0x222)),console[_0x5a19b6(0x163)](_0x5a19b6(0x14c)+_0x49fc74['gateway']),console[_0x5a19b6(0x163)]('\x20\x20\x20-\x20Status:\x20'+_0x49fc74[_0x5a19b6(0x175)]),console[_0x5a19b6(0x163)](_0x5a19b6(0x141)+_0x49fc74[_0x5a19b6(0x21f)]),console[_0x5a19b6(0x163)](_0x5a19b6(0x1fb)+_0x49fc74['amount']+'\x20'+_0x49fc74[_0x5a19b6(0x213)]),console[_0x5a19b6(0x163)]('\x20\x20\x20-\x20ShopId:\x20'+_0x49fc74['shopId']);if(_0x49fc74[_0x5a19b6(0x203)]!==_0x5a19b6(0x1e1)){console[_0x5a19b6(0x163)](_0x5a19b6(0x151)+_0x2ed33a+_0x5a19b6(0x18e)+_0x49fc74[_0x5a19b6(0x203)]+')');return;}if(_0x49fc74['status']!=='PENDING'){console['log'](_0x5a19b6(0x151)+_0x2ed33a+_0x5a19b6(0x1bf)+_0x49fc74[_0x5a19b6(0x175)]+_0x5a19b6(0x1fc)),this[_0x5a19b6(0x212)](_0x2ed33a);return;}if(!_0x49fc74[_0x5a19b6(0x21f)]){console['log'](_0x5a19b6(0x151)+_0x2ed33a+_0x5a19b6(0x211));return;}console[_0x5a19b6(0x163)](_0x5a19b6(0x1ae)+_0x2ed33a+_0x5a19b6(0x227)),await this[_0x5a19b6(0x1f4)](_0x49fc74);}['logCoinToPayStatus'](_0x327e08,_0x3e5efc,_0x1c63cf,_0x1587d1,_0xd62ced,_0x31b66a){const _0x32e7b3=a35_0x17c1df,_0x256072={'type':_0x32e7b3(0x161),'paymentId':_0x327e08,'gatewayPaymentId':_0x3e5efc,'oldStatus':_0x1c63cf,'newStatus':_0x1587d1,'source':_0xd62ced,'timestamp':new Date()[_0x32e7b3(0x17b)](),'details':_0x31b66a||{}};loggerService_1[_0x32e7b3(0x1bd)]['logCoinToPayStatus'](_0x256072),console[_0x32e7b3(0x163)](_0x32e7b3(0x19a)+_0x327e08+'\x20('+_0x3e5efc+')'),console[_0x32e7b3(0x163)](_0x32e7b3(0x1f8)+_0x1c63cf+_0x32e7b3(0x1c2)+_0x1587d1),console[_0x32e7b3(0x163)]('\x20\x20\x20üìç\x20Source:\x20'+_0xd62ced),console[_0x32e7b3(0x163)](_0x32e7b3(0x184)+_0x256072[_0x32e7b3(0x149)]),_0x31b66a&&console['log'](_0x32e7b3(0x1e4),_0x31b66a);}[a35_0x17c1df(0x18b)](_0x520c4c,_0x5836b4,_0x3992f2,_0x48eae4,_0x1f4b77){const _0x5bbc16=a35_0x17c1df,_0x520c32={'type':_0x5bbc16(0x182),'paymentId':_0x520c4c,'gatewayPaymentId':_0x5836b4,'error':_0x3992f2 instanceof Error?{'message':_0x3992f2[_0x5bbc16(0x15b)],'stack':_0x3992f2[_0x5bbc16(0x1b4)]}:_0x3992f2,'source':_0x48eae4,'timestamp':new Date()[_0x5bbc16(0x17b)](),'context':_0x1f4b77||{}};loggerService_1[_0x5bbc16(0x1bd)][_0x5bbc16(0x18b)](_0x520c32),console[_0x5bbc16(0x214)](_0x5bbc16(0x160)+_0x520c4c+'\x20('+_0x5836b4+')'),console[_0x5bbc16(0x214)](_0x5bbc16(0x1cd)+(_0x3992f2 instanceof Error?_0x3992f2[_0x5bbc16(0x15b)]:_0x3992f2)),console[_0x5bbc16(0x214)](_0x5bbc16(0x159)+_0x48eae4),console[_0x5bbc16(0x214)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x520c32[_0x5bbc16(0x149)]),_0x1f4b77&&console[_0x5bbc16(0x214)](_0x5bbc16(0x16b),_0x1f4b77);}[a35_0x17c1df(0x1ef)](){const _0x242bbb=a35_0x17c1df;console[_0x242bbb(0x163)](_0x242bbb(0x154)),this[_0x242bbb(0x206)]()[_0x242bbb(0x15c)](_0x542f58=>{const _0x3bf40b=_0x242bbb;console[_0x3bf40b(0x214)](_0x3bf40b(0x1ad),_0x542f58);}),this[_0x242bbb(0x17e)]=setInterval(async()=>{const _0x5edd45=_0x242bbb;try{console[_0x5edd45(0x163)](_0x5edd45(0x16f)),await this[_0x5edd45(0x206)](),console[_0x5edd45(0x163)](_0x5edd45(0x150));}catch(_0x48ac90){console[_0x5edd45(0x214)](_0x5edd45(0x1b6),_0x48ac90);}},this[_0x242bbb(0x15f)]),console[_0x242bbb(0x163)](_0x242bbb(0x1f7));}[a35_0x17c1df(0x1f1)](){const _0x170ba2=a35_0x17c1df;console[_0x170ba2(0x163)](_0x170ba2(0x1df));this[_0x170ba2(0x17e)]&&(clearInterval(this[_0x170ba2(0x17e)]),this[_0x170ba2(0x17e)]=null,console['log'](_0x170ba2(0x21c)));const _0x1bc7b3=this[_0x170ba2(0x162)][_0x170ba2(0x1a9)];for(const [_0x545dde]of this[_0x170ba2(0x162)]){this[_0x170ba2(0x212)](_0x545dde);}console['log']('üõë\x20[SHUTDOWN]\x20Cleared\x20'+_0x1bc7b3+_0x170ba2(0x1ba));}async[a35_0x17c1df(0x206)](){const _0x1d377e=a35_0x17c1df;try{console[_0x1d377e(0x163)]('ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x29fa71=await database_1[_0x1d377e(0x1e0)][_0x1d377e(0x18c)]['findMany']({'where':{'gateway':_0x1d377e(0x1e1),'status':_0x1d377e(0x153),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x1d377e(0x163)](_0x1d377e(0x216)+_0x29fa71[_0x1d377e(0x1aa)]+_0x1d377e(0x18d));if(_0x29fa71[_0x1d377e(0x1aa)]===0x0){console[_0x1d377e(0x163)](_0x1d377e(0x171));return;}const _0x3266fb=await this[_0x1d377e(0x1b8)](_0x29fa71);console[_0x1d377e(0x163)](_0x1d377e(0x1ac)+_0x3266fb[_0x1d377e(0x1aa)]+_0x1d377e(0x145));let _0x389da4=0x0,_0x2a90eb=0x0;for(const _0x5d858f of _0x29fa71){try{if(_0x3266fb[_0x1d377e(0x167)](_0x5d858f['id'])){console[_0x1d377e(0x163)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x5d858f['id']+_0x1d377e(0x180)),_0x2a90eb++;continue;}if(this[_0x1d377e(0x162)][_0x1d377e(0x1e7)](_0x5d858f['id'])){console['log'](_0x1d377e(0x176)+_0x5d858f['id']+_0x1d377e(0x196)),_0x2a90eb++;continue;}const _0x2af9a9=(Date[_0x1d377e(0x1b2)]()-_0x5d858f[_0x1d377e(0x199)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x2af9a9<0x1){console[_0x1d377e(0x163)](_0x1d377e(0x176)+_0x5d858f['id']+_0x1d377e(0x1e9)+_0x2af9a9[_0x1d377e(0x1ff)](0x1)+_0x1d377e(0x1d9)),_0x2a90eb++;continue;}console[_0x1d377e(0x163)](_0x1d377e(0x20f)+_0x5d858f['id']+'\x20(age:\x20'+_0x2af9a9[_0x1d377e(0x1ff)](0x1)+'h)'),await this[_0x1d377e(0x1f4)](_0x5d858f),_0x389da4++,await new Promise(_0x1fa0f0=>setTimeout(_0x1fa0f0,0x7d0));}catch(_0x2ed2f7){console[_0x1d377e(0x214)](_0x1d377e(0x166)+_0x5d858f['id']+':',_0x2ed2f7),this[_0x1d377e(0x18b)](_0x5d858f['id'],_0x5d858f[_0x1d377e(0x21f)]||_0x1d377e(0x18a),_0x2ed2f7,_0x1d377e(0x1c9),{'isGlobalCheck':!![],'paymentAmount':_0x5d858f['amount'],'paymentCurrency':_0x5d858f['currency'],'shopId':_0x5d858f[_0x1d377e(0x210)],'createdAt':_0x5d858f[_0x1d377e(0x199)]}),loggerService_1[_0x1d377e(0x1bd)][_0x1d377e(0x225)](_0x1d377e(0x1e1),_0x1d377e(0x1fd)+_0x5d858f[_0x1d377e(0x21f)],_0x2ed2f7);}}console[_0x1d377e(0x163)](_0x1d377e(0x16e)+_0x389da4+_0x1d377e(0x21e)+_0x2a90eb+_0x1d377e(0x1b9)+_0x3266fb[_0x1d377e(0x1aa)]+_0x1d377e(0x170));}catch(_0x10bad4){console[_0x1d377e(0x214)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x10bad4);}}async[a35_0x17c1df(0x1b8)](_0x348adf){const _0x2c3d1a=a35_0x17c1df,_0x508330=[],_0x3d7128=new Date();_0x3d7128[_0x2c3d1a(0x20d)](_0x3d7128[_0x2c3d1a(0x15d)]()-this['EXPIRY_DAYS']),console[_0x2c3d1a(0x163)](_0x2c3d1a(0x20a)+this['EXPIRY_DAYS']+_0x2c3d1a(0x144)+_0x3d7128[_0x2c3d1a(0x17b)]()+')');for(const _0x32aee5 of _0x348adf){if(_0x32aee5['createdAt']<_0x3d7128){console[_0x2c3d1a(0x163)](_0x2c3d1a(0x219)+_0x32aee5['id']+_0x2c3d1a(0x20e)+this[_0x2c3d1a(0x1cb)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this['logCoinToPayStatus'](_0x32aee5['id'],_0x32aee5['gatewayPaymentId']||_0x2c3d1a(0x18a),_0x2c3d1a(0x153),_0x2c3d1a(0x178),_0x2c3d1a(0x1da),{'reason':'Payment\x20older\x20than\x20'+this[_0x2c3d1a(0x1cb)]+_0x2c3d1a(0x1ea),'createdAt':_0x32aee5['createdAt'],'daysSinceCreation':Math['floor']((Date['now']()-_0x32aee5[_0x2c3d1a(0x199)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x32aee5[_0x2c3d1a(0x1fa)],'paymentCurrency':_0x32aee5['currency'],'shopId':_0x32aee5[_0x2c3d1a(0x210)]}),await database_1[_0x2c3d1a(0x1e0)][_0x2c3d1a(0x18c)][_0x2c3d1a(0x1dd)]({'where':{'id':_0x32aee5['id']},'data':{'status':_0x2c3d1a(0x178),'updatedAt':new Date(),'adminNotes':_0x2c3d1a(0x1f6)+this[_0x2c3d1a(0x1cb)]+_0x2c3d1a(0x224)}}),await database_1['default'][_0x2c3d1a(0x21d)]['create']({'data':{'paymentId':_0x32aee5['id'],'shopId':_0x32aee5[_0x2c3d1a(0x210)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x2c3d1a(0x14d)+this['EXPIRY_DAYS']+_0x2c3d1a(0x1ea),'createdAt':_0x32aee5['createdAt'],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x2c3d1a(0x1a1)]((Date[_0x2c3d1a(0x1b2)]()-_0x32aee5['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x2c3d1a(0x1f9)](_0x32aee5,_0x2c3d1a(0x178)),await this[_0x2c3d1a(0x198)](_0x32aee5,_0x2c3d1a(0x178)),this['clearPaymentTimers'](_0x32aee5['id']),_0x508330[_0x2c3d1a(0x21b)](_0x32aee5['id']),console['log'](_0x2c3d1a(0x193)+_0x32aee5['id']+_0x2c3d1a(0x1be)+this['EXPIRY_DAYS']+_0x2c3d1a(0x218));}catch(_0x5b4653){console[_0x2c3d1a(0x214)](_0x2c3d1a(0x208)+_0x32aee5['id']+':',_0x5b4653),this[_0x2c3d1a(0x18b)](_0x32aee5['id'],_0x32aee5[_0x2c3d1a(0x21f)]||_0x2c3d1a(0x18a),_0x5b4653,_0x2c3d1a(0x1da),{'reason':_0x2c3d1a(0x185),'createdAt':_0x32aee5[_0x2c3d1a(0x199)],'daysSinceCreation':Math[_0x2c3d1a(0x1a1)]((Date[_0x2c3d1a(0x1b2)]()-_0x32aee5[_0x2c3d1a(0x199)][_0x2c3d1a(0x1f3)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x508330;}async[a35_0x17c1df(0x1f4)](_0x5553f6){const _0x173060=a35_0x17c1df;if(!_0x5553f6[_0x173060(0x21f)]){console[_0x173060(0x163)](_0x173060(0x151)+_0x5553f6['id']+_0x173060(0x1f2));return;}console[_0x173060(0x163)](_0x173060(0x221)+_0x5553f6['id']+'\x20('+_0x5553f6[_0x173060(0x21f)]+')');try{const _0xf249fe=await this[_0x173060(0x168)]['checkPaymentStatus'](_0x5553f6[_0x173060(0x21f)]);console[_0x173060(0x163)](_0x173060(0x187)+_0x5553f6['id']+_0x173060(0x142)+_0xf249fe[_0x173060(0x175)]);_0xf249fe[_0x173060(0x1b0)]&&console[_0x173060(0x163)](_0x173060(0x187)+_0x5553f6['id']+'\x20details:',{'iban':_0xf249fe['paymentDetails']['iban']||_0x173060(0x1a7),'transactionId':_0xf249fe[_0x173060(0x1b0)][_0x173060(0x226)],'createdOn':_0xf249fe[_0x173060(0x1b0)][_0x173060(0x1de)],'confirmedOn':_0xf249fe[_0x173060(0x1b0)][_0x173060(0x1c8)]||'not\x20confirmed'});if(_0xf249fe['status']!==_0x5553f6[_0x173060(0x175)]){console[_0x173060(0x163)]('üîÑ\x20[CHECK]\x20Updating\x20payment\x20'+_0x5553f6['id']+_0x173060(0x1b1)+_0x5553f6['status']+_0x173060(0x16c)+_0xf249fe[_0x173060(0x175)]),this[_0x173060(0x16d)](_0x5553f6['id'],_0x5553f6[_0x173060(0x21f)],_0x5553f6['status'],_0xf249fe[_0x173060(0x175)],_0x173060(0x1c9),{'paymentDetails':_0xf249fe[_0x173060(0x1b0)],'amount':_0xf249fe[_0x173060(0x1fa)],'currency':_0xf249fe['currency'],'shopId':_0x5553f6['shopId'],'checkTimestamp':new Date()[_0x173060(0x17b)]()});const _0x45d90d={'status':_0xf249fe[_0x173060(0x175)],'updatedAt':new Date()};_0xf249fe[_0x173060(0x175)]===_0x173060(0x1f5)&&_0x5553f6[_0x173060(0x175)]!==_0x173060(0x1f5)&&(_0x45d90d['paidAt']=new Date(),console[_0x173060(0x163)](_0x173060(0x197)+_0x5553f6['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x45d90d[_0x173060(0x1d8)][_0x173060(0x17b)]()));if(_0xf249fe[_0x173060(0x1b0)]){const _0x30c539=_0xf249fe[_0x173060(0x1b0)];_0x30c539[_0x173060(0x1c1)]&&(_0x45d90d['remitterIban']=_0x30c539[_0x173060(0x1c1)],console[_0x173060(0x163)](_0x173060(0x183)+_0x30c539[_0x173060(0x1c1)]));if(_0x30c539['bankDetails']){const _0x89a74f=_0x5553f6[_0x173060(0x1b3)]||'',_0x25e958='Bank\x20Details:\x20'+_0x30c539[_0x173060(0x1bc)];_0x45d90d['adminNotes']=_0x89a74f?_0x89a74f+'\x0a\x0a'+_0x25e958:_0x25e958,console[_0x173060(0x163)]('üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x30c539[_0x173060(0x226)]&&console[_0x173060(0x163)](_0x173060(0x181)+_0x30c539[_0x173060(0x226)]),_0x30c539['confirmedOn']&&console[_0x173060(0x163)](_0x173060(0x1fe)+_0x30c539[_0x173060(0x1c8)]);}await database_1[_0x173060(0x1e0)]['payment'][_0x173060(0x1dd)]({'where':{'id':_0x5553f6['id']},'data':_0x45d90d}),await database_1['default'][_0x173060(0x21d)][_0x173060(0x191)]({'data':{'paymentId':_0x5553f6['id'],'shopId':_0x5553f6['shopId'],'event':'cointopay_status_check_'+_0xf249fe['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x173060(0x16a)]({'oldStatus':_0x5553f6[_0x173060(0x175)],'newStatus':_0xf249fe[_0x173060(0x175)],'paymentDetails':_0xf249fe[_0x173060(0x1b0)],'checkedAt':new Date()[_0x173060(0x17b)]()})}}),await this[_0x173060(0x1f9)](_0x5553f6,_0xf249fe[_0x173060(0x175)]),await this[_0x173060(0x198)](_0x5553f6,_0xf249fe['status']),_0xf249fe['status']!==_0x173060(0x153)&&(console[_0x173060(0x163)](_0x173060(0x1d3)+_0x5553f6['id']+_0x173060(0x186)+_0xf249fe['status']+_0x173060(0x1e5)),this[_0x173060(0x212)](_0x5553f6['id'])),console['log'](_0x173060(0x1ae)+_0x5553f6['id']+'\x20updated\x20successfully');}else console[_0x173060(0x163)](_0x173060(0x187)+_0x5553f6['id']+_0x173060(0x1c0)+_0xf249fe[_0x173060(0x175)]+')'),this[_0x173060(0x16d)](_0x5553f6['id'],_0x5553f6[_0x173060(0x21f)],_0x5553f6[_0x173060(0x175)],_0xf249fe[_0x173060(0x175)],_0x173060(0x1c9),{'statusUnchanged':!![],'paymentDetails':_0xf249fe[_0x173060(0x1b0)],'amount':_0xf249fe[_0x173060(0x1fa)],'currency':_0xf249fe[_0x173060(0x213)],'shopId':_0x5553f6[_0x173060(0x210)],'checkTimestamp':new Date()[_0x173060(0x17b)]()});}catch(_0x2c3a44){console[_0x173060(0x214)](_0x173060(0x173)+_0x5553f6['id']+':',_0x2c3a44),this[_0x173060(0x18b)](_0x5553f6['id'],_0x5553f6[_0x173060(0x21f)],_0x2c3a44,_0x173060(0x1c9),{'paymentAmount':_0x5553f6[_0x173060(0x1fa)],'paymentCurrency':_0x5553f6[_0x173060(0x213)],'shopId':_0x5553f6[_0x173060(0x210)],'createdAt':_0x5553f6[_0x173060(0x199)]}),await database_1[_0x173060(0x1e0)][_0x173060(0x21d)][_0x173060(0x191)]({'data':{'paymentId':_0x5553f6['id'],'shopId':_0x5553f6[_0x173060(0x210)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x2c3a44 instanceof Error?_0x2c3a44[_0x173060(0x15b)]:_0x173060(0x18f),'gatewayPaymentId':_0x5553f6[_0x173060(0x21f)],'checkedAt':new Date()[_0x173060(0x17b)]()})}});}}async[a35_0x17c1df(0x1f9)](_0x45e2ec,_0x579e19){const _0x15207d=a35_0x17c1df,_0x35ba41=Date[_0x15207d(0x1b2)]();try{const _0x3589f4=_0x45e2ec[_0x15207d(0x1e8)],_0x2fff7c=_0x3589f4[_0x15207d(0x1d1)];if(!_0x2fff7c?.['webhookUrl']){console['log'](_0x15207d(0x1e2)+_0x3589f4['id']);return;}const _0x1c445e=_0x579e19===_0x15207d(0x1f5)?'payment.success':_0x579e19===_0x15207d(0x1d7)?_0x15207d(0x194):_0x579e19===_0x15207d(0x178)?_0x15207d(0x194):_0x15207d(0x205);if(!_0x2fff7c[_0x15207d(0x174)]?.[_0x15207d(0x167)](_0x1c445e)){console[_0x15207d(0x163)](_0x15207d(0x17a)+_0x1c445e+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3589f4['id']);return;}const _0x40e2e0={'event':_0x1c445e,'payment':{'id':_0x45e2ec['id'],'order_id':_0x45e2ec['orderId'],'gateway_order_id':_0x45e2ec['gatewayOrderId'],'gateway':'0100','amount':_0x45e2ec['amount'],'currency':_0x45e2ec['currency'],'status':_0x579e19[_0x15207d(0x215)](),'customer_email':_0x45e2ec['customerEmail'],'customer_name':_0x45e2ec['customerName'],'created_at':_0x45e2ec[_0x15207d(0x199)],'updated_at':new Date()}},_0x1d7e38=await fetch(_0x2fff7c[_0x15207d(0x20c)],{'method':_0x15207d(0x207),'headers':{'Content-Type':'application/json','User-Agent':_0x15207d(0x19c)},'body':JSON[_0x15207d(0x16a)](_0x40e2e0)}),_0xe6d442=Date[_0x15207d(0x1b2)]()-_0x35ba41,_0x1086e7=_0x1d7e38['ok']?_0x15207d(0x1a8):await _0x1d7e38['text']();loggerService_1[_0x15207d(0x1bd)]['logShopWebhookSent'](_0x45e2ec['shopId'],_0x2fff7c[_0x15207d(0x20c)],_0x1c445e,_0x1d7e38[_0x15207d(0x175)],_0xe6d442,_0x40e2e0),console[_0x15207d(0x163)]('Shop\x20webhook\x20sent\x20to\x20'+_0x2fff7c[_0x15207d(0x20c)]+_0x15207d(0x188)+_0x1d7e38['status']+'\x20('+_0xe6d442+_0x15207d(0x1a5));}catch(_0x4a4c9a){console[_0x15207d(0x214)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x4a4c9a),loggerService_1[_0x15207d(0x1bd)][_0x15207d(0x14a)](_0x45e2ec[_0x15207d(0x210)],_0x45e2ec[_0x15207d(0x1e8)]?.[_0x15207d(0x1d1)]?.[_0x15207d(0x20c)]||_0x15207d(0x18a),'webhook_send',_0x4a4c9a,{});}}async[a35_0x17c1df(0x198)](_0x31fdfc,_0x1c1c73){const _0x431fba=a35_0x17c1df;try{const _0xc8a38f={'PENDING':'created','PAID':_0x431fba(0x1c6),'FAILED':_0x431fba(0x1b5),'EXPIRED':'expired'},_0x2d424f=_0xc8a38f[_0x1c1c73];if(!_0x2d424f||_0x2d424f===_0x431fba(0x179))return;await telegramBotService_1['telegramBotService']['sendPaymentNotification'](_0x31fdfc['shopId'],_0x31fdfc,_0x2d424f);}catch(_0x712376){console[_0x431fba(0x214)](_0x431fba(0x1bb),_0x712376);}}async[a35_0x17c1df(0x1a2)](_0x32bc25){const _0x5cafab=a35_0x17c1df;console[_0x5cafab(0x163)](_0x5cafab(0x140)+_0x32bc25);const _0x351e3d=await database_1[_0x5cafab(0x1e0)]['payment']['findUnique']({'where':{'id':_0x32bc25},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x351e3d)throw new Error(_0x5cafab(0x14b));if(_0x351e3d[_0x5cafab(0x203)]!=='cointopay')throw new Error(_0x5cafab(0x1a6));console[_0x5cafab(0x163)](_0x5cafab(0x1cc)+_0x32bc25),await this[_0x5cafab(0x1f4)](_0x351e3d),console['log']('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x32bc25);}[a35_0x17c1df(0x209)](){const _0x2e842f=a35_0x17c1df,_0x560667=this[_0x2e842f(0x17e)]?this[_0x2e842f(0x15f)]:undefined,_0x2b50f4=Array[_0x2e842f(0x223)](this[_0x2e842f(0x162)][_0x2e842f(0x14e)]())[_0x2e842f(0x148)](_0x4564e8=>({'paymentId':_0x4564e8['paymentId'],'gatewayPaymentId':_0x4564e8['gatewayPaymentId'],'createdAt':_0x4564e8['createdAt'],'timersCount':_0x4564e8['timers'][_0x2e842f(0x1aa)]}));return{'isActive':!!this[_0x2e842f(0x17e)],'globalCheckIntervalMinutes':this[_0x2e842f(0x15f)]/(0x3e8*0x3c),'expiryDays':this[_0x2e842f(0x1cb)],'activeIndividualTimers':this[_0x2e842f(0x162)][_0x2e842f(0x1a9)],'nextGlobalCheckIn':_0x560667,'paymentTimersDetails':_0x2b50f4};}[a35_0x17c1df(0x17c)](_0x137e65){const _0xd1b141=a35_0x17c1df,_0x4fa20e=this[_0xd1b141(0x162)][_0xd1b141(0x1d5)](_0x137e65);if(_0x4fa20e)return{'hasTimers':!![],'timersCount':_0x4fa20e[_0xd1b141(0x1a3)][_0xd1b141(0x1aa)],'createdAt':_0x4fa20e[_0xd1b141(0x199)],'gatewayPaymentId':_0x4fa20e[_0xd1b141(0x21f)]};return{'hasTimers':![]};}}function a35_0xcdde(){const _0x277d30=['Success','size','length','schedule_created','‚è∞\x20[GLOBAL]\x20Found\x20','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','‚úÖ\x20[CHECK]\x20Payment\x20','\x20triggered\x20for\x20payment\x20','paymentDetails','\x20status\x20from\x20','now','adminNotes','stack','failed','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','delay','checkExpiredPayments','\x20skipped,\x20','\x20individual\x20payment\x20timers','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','bankDetails','loggerService','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20status\x20is\x20','\x20status\x20unchanged\x20(','iban','\x20->\x20','coinToPayStatusService','ü™ô\x20[DEBUG]\x20Creating\x20','13290vMZmpI','paid','3079710qZsHeW','confirmedOn','status_check','\x20\x20\x20-\x20gatewayPaymentId:\x20','EXPIRY_DAYS','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20\x20\x20‚ùå\x20Error:\x20','‚ùå\x20[HOURLY]\x20Payment\x20','checkSinglePaymentById','__importDefault','settings','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','üßπ\x20[CHECK]\x20Payment\x20','üßπ\x20[DEBUG]\x20Clearing\x20','get','./telegramBotService','FAILED','paidAt','h),\x20skipping\x20global\x20check','auto_expire','.\x20Remaining\x20active\x20timers:\x20','6961815YbjgBG','update','createdOn','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','default','cointopay','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','\x20\x20\x20üìù\x20Details:',',\x20clearing\x20individual\x20timers','935gzKVRz','has','shop','\x20is\x20too\x20new\x20(','\x20days','1628885NDkYOW','defineProperty','\x20current\x20status:\x20','\x20for\x20payment\x20','startPeriodicStatusCheck','‚ùå\x20[CHECK]\x20Payment\x20','stopPeriodicStatusCheck','\x20has\x20no\x20gatewayPaymentId,\x20skipping','getTime','checkSinglePayment','PAID','Automatically\x20expired\x20after\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20\x20\x20üìä\x20Status:\x20','sendShopWebhook','amount','\x20\x20\x20-\x20Amount:\x20',',\x20stopping\x20individual\x20checks','/status/','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','toFixed','../config/database','set','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','gateway','5665344ouARjU','payment.pending','checkAllPendingPayments','POST','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','getServiceStats','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','9XuVNDd','webhookUrl','setDate','\x20is\x20older\x20than\x20','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','shopId','\x20has\x20no\x20gatewayPaymentId','clearPaymentTimers','currency','error','toLowerCase','ü™ô\x20[GLOBAL]\x20Found\x20','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','-day\x20timeout','‚è∞\x20[EXPIRY]\x20Payment\x20','./loggerService','push','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','webhookLog','\x20checked,\x20','gatewayPaymentId','findUnique','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','\x20found:','from','\x20days\x20without\x20payment\x20confirmation','logWhiteDomainError','transactionId','\x20is\x20valid\x20for\x20checking,\x20proceeding...','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20status:\x20','2\x20minutes','\x20days\x20(created\x20before\x20','\x20expired\x20CoinToPay\x20payments','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','10274340EGUATZ','map','timestamp','logShopWebhookError','Payment\x20not\x20found','\x20\x20\x20-\x20Gateway:\x20','Payment\x20older\x20than\x20','values','./gateways/coinToPayService','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','ü™ô\x20CoinToPayStatusService\x20initialized','PENDING','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','66MHxiCT','\x20not\x20found\x20in\x20database','9128LFiRem','__esModule','\x20\x20\x20üìç\x20Source:\x20','CoinToPayService','message','catch','getDate','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','GLOBAL_CHECK_INTERVAL_MS','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','COINTOPAY_STATUS_CHANGE','paymentTimers','log','forEach','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','includes','coinToPayService','description','stringify','\x20\x20\x20üìù\x20Context:','\x20to\x20','logCoinToPayStatus','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20expired','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','delete','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','webhookEvents','status','‚è∞\x20[GLOBAL]\x20Payment\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','EXPIRED','created','Webhook\x20event\x20','toISOString','getPaymentTimerInfo','\x20completed\x20for\x20payment\x20','globalCheckInterval','CoinToPayStatusService','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','COINTOPAY_ERROR','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20\x20\x20üìÖ\x20Time:\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20status\x20changed\x20to\x20','üìä\x20[CHECK]\x20Payment\x20','\x20with\x20status\x20','\x20not\x20found,\x20clearing\x20timers','unknown','logCoinToPayError','payment','\x20pending\x20CoinToPay\x20payments','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','Unknown\x20error','\x20seconds\x20(','create','\x20(after\x20','‚úÖ\x20[EXPIRY]\x20Payment\x20','payment.failed','schedulePaymentChecks','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','üí∞\x20[CHECK]\x20Payment\x20','sendPaymentStatusNotification','createdAt','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','\x20in\x20','TesSoft\x20Payment\x20System/1.0','üìä\x20[HOURLY]\x20Payment\x20','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','5\x20minutes','‚úÖ\x20[HOURLY]\x20Payment\x20','floor','checkPaymentById','timers','\x20to\x20clear','ms)','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','not\x20found'];a35_0xcdde=function(){return _0x277d30;};return a35_0xcdde();}exports[a35_0x17c1df(0x17f)]=CoinToPayStatusService,exports[a35_0x17c1df(0x1c3)]=new CoinToPayStatusService();