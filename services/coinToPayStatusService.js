'use strict';const a37_0x23ce37=a37_0x5d75;function a37_0x5d75(_0x58b957,_0x3d059f){const _0x5ed020=a37_0x5ed0();return a37_0x5d75=function(_0x5d7546,_0x258bb1){_0x5d7546=_0x5d7546-0x93;let _0x5eb302=_0x5ed020[_0x5d7546];return _0x5eb302;},a37_0x5d75(_0x58b957,_0x3d059f);}(function(_0x40fa5b,_0x13419c){const _0x2d379a=a37_0x5d75,_0x52da76=_0x40fa5b();while(!![]){try{const _0x20f63e=-parseInt(_0x2d379a(0xd6))/0x1*(-parseInt(_0x2d379a(0xd4))/0x2)+parseInt(_0x2d379a(0xd9))/0x3+-parseInt(_0x2d379a(0x170))/0x4+parseInt(_0x2d379a(0x167))/0x5+parseInt(_0x2d379a(0x15f))/0x6+-parseInt(_0x2d379a(0xbe))/0x7*(-parseInt(_0x2d379a(0x138))/0x8)+parseInt(_0x2d379a(0xa5))/0x9*(-parseInt(_0x2d379a(0x95))/0xa);if(_0x20f63e===_0x13419c)break;else _0x52da76['push'](_0x52da76['shift']());}catch(_0x1a4807){_0x52da76['push'](_0x52da76['shift']());}}}(a37_0x5ed0,0xdc3c1));var __importDefault=this&&this[a37_0x23ce37(0xee)]||function(_0xc13b94){return _0xc13b94&&_0xc13b94['__esModule']?_0xc13b94:{'default':_0xc13b94};};Object[a37_0x23ce37(0xbf)](exports,a37_0x23ce37(0xb9),{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0x23ce37(0xbc)]=void 0x0;function a37_0x5ed0(){const _0x329c47=['\x20\x20\x20-\x20paymentId:\x20','toFixed','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','paymentTimers','clearPaymentTimers','unknown','shop','\x20days','\x20with\x20status\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','checkSinglePaymentById','findMany','currency','\x20status\x20is\x20','‚è∞\x20[GLOBAL]\x20Payment\x20','delay','\x20for\x20payment\x20','\x20not\x20enabled\x20for\x20shop\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20status\x20unchanged\x20(','gateway','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','coinToPayService','length','üìä\x20[CHECK]\x20Payment\x20','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','confirmedOn','Failed\x20to\x20send\x20shop\x20webhook:','ü™ô\x20CoinToPayStatusService\x20initialized','message','values','description','\x20status\x20changed\x20to\x20','cointopay','üí∞\x20[CHECK]\x20Payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','\x20is\x20older\x20than\x20','size','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','coinToPayStatusService','8pXgKZB','\x20details:','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','webhookEvents','loggerService','getPaymentTimerInfo','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','‚è∞\x20[EXPIRY]\x20Payment\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','0100','\x20\x20\x20üìù\x20Context:','cointopay_auto_expired','logCoinToPayStatus','\x20\x20\x20‚ùå\x20Error:\x20','logWhiteDomainError','checkAllPendingPayments','globalCheckInterval','\x20individual\x20payment\x20timers',',\x20stopping\x20individual\x20checks','floor','PENDING','stopPeriodicStatusCheck','error','getServiceStats','logCoinToPayError','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','payment.failed','COINTOPAY_ERROR','2\x20minutes','map','status','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','stack','.\x20Remaining\x20active\x20timers:\x20','status_check','log','not\x20confirmed','bankDetails','891372JcMhtw','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','FAILED','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','Automatically\x20expired\x20after\x20','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20->\x20','‚è∞\x20[HOURLY]\x20Payment\x20','7711550MyUJLJ','\x20completed\x20for\x20payment\x20','adminNotes','\x20has\x20no\x20gatewayPaymentId,\x20skipping','5\x20minutes','telegramBotService','Unknown\x20error','setDate','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','6793760dmBFnY','text','checkSinglePayment','customerName','üõë\x20[SHUTDOWN]\x20Cleared\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','EXPIRY_DAYS','1000490HAfvOA','\x20is\x20valid\x20for\x20checking,\x20proceeding...','customerEmail','findUnique','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','checkExpiredPayments','iban','\x20seconds\x20(','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','1\x20minute','remitterIban','gatewayPaymentId','./telegramBotService','\x20\x20\x20-\x20Amount:\x20','expired','üßπ\x20[CHECK]\x20Payment\x20','189LVyHvn','settings','\x20not\x20found\x20in\x20database','Webhook\x20event\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','\x20triggered\x20for\x20payment\x20','\x20timers\x20for\x20payment\x20','createdAt','üìä\x20[HOURLY]\x20Payment\x20','paymentId','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20found:','create','\x20in\x20','update','toISOString','forEach',',\x20clearing\x20individual\x20timers','\x20initial\x20timers\x20for\x20payment\x20','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','__esModule','logShopWebhookError','sendShopWebhook','CoinToPayStatusService','catch','8377313mupbFe','defineProperty','createdOn','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','Payment\x20older\x20than\x20','\x20current\x20status:\x20','now','getTime','webhook_send','getDate','ms)','stringify','timestamp','\x20is\x20too\x20new\x20(','‚ùå\x20[CHECK]\x20Payment\x20','amount','‚è∞\x20[GLOBAL]\x20Found\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','transactionId','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','checkPaymentStatus','get','147558sVaUkZ','PAID','11afozrX','EXPIRED','shopId','3007050Xwibjt','ü™ô\x20[GLOBAL]\x20Found\x20','paidAt','-day\x20timeout','‚úÖ\x20[CHECK]\x20Payment\x20','paid','\x20days\x20without\x20payment\x20confirmation','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','includes','webhookUrl','‚úÖ\x20[EXPIRY]\x20Payment\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','GLOBAL_CHECK_INTERVAL_MS','payment','has','webhookLog','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20\x20\x20-\x20Gateway:\x20','paymentDetails','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','./loggerService','__importDefault','timers','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','schedulePaymentChecks','\x20skipped,\x20','sendPaymentNotification','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20\x20\x20üìç\x20Source:\x20','\x20\x20\x20-\x20ShopId:\x20','\x20has\x20no\x20gatewayPaymentId','ü™ô\x20[DEBUG]\x20Creating\x20','failed','set','sendPaymentStatusNotification','auto_expire','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20pending\x20CoinToPay\x20payments','logShopWebhookSent','Shop\x20webhook\x20sent\x20to\x20','toLowerCase','\x20\x20\x20üìÖ\x20Time:\x20','./gateways/coinToPayService','\x20\x20\x20üìù\x20Details:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','push','default','\x20(age:\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20marked\x20as\x20paid\x20at:\x20','\x20expired','\x20status\x20from\x20','delete'];a37_0x5ed0=function(){return _0x329c47;};return a37_0x5ed0();}const coinToPayService_1=require(a37_0x23ce37(0x104)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x23ce37(0xa1)),loggerService_1=require(a37_0x23ce37(0xed));class CoinToPayStatusService{constructor(){const _0x2e617f=a37_0x23ce37;this[_0x2e617f(0x149)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x2e617f(0x94)]=0x5,this[_0x2e617f(0x113)]=new Map(),this[_0x2e617f(0x126)]=new coinToPayService_1['CoinToPayService'](),console[_0x2e617f(0x15c)](_0x2e617f(0x12c));}[a37_0x23ce37(0xf2)](_0x4afc51,_0x4a8e71){const _0x31a9c8=a37_0x23ce37;console[_0x31a9c8(0x15c)]('ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console['log'](_0x31a9c8(0x110)+_0x4afc51),console[_0x31a9c8(0x15c)](_0x31a9c8(0xa9)+_0x4a8e71),this[_0x31a9c8(0x114)](_0x4afc51);const _0x1a9140=[],_0x5cc536=new Date(),_0x4a4f20=[{'delay':0x1*0x3c*0x3e8,'description':_0x31a9c8(0x9e)},{'delay':0x2*0x3c*0x3e8,'description':_0x31a9c8(0x155)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x31a9c8(0x16b)}];console['log'](_0x31a9c8(0xf9)+_0x4a4f20[_0x31a9c8(0x127)]+_0x31a9c8(0xb7)+_0x4afc51);let _0x39babd=0x0;_0x4a4f20[_0x31a9c8(0xb5)]((_0x207ffa,_0x505481)=>{const _0x26728a=_0x31a9c8;_0x39babd+=_0x207ffa['delay'];const _0x5585e4=setTimeout(async()=>{const _0x4b8d1b=a37_0x5d75;console[_0x4b8d1b(0x15c)](_0x4b8d1b(0x141)+(_0x505481+0x1)+_0x4b8d1b(0xaa)+_0x4afc51+'\x20(after\x20'+_0x207ffa[_0x4b8d1b(0x12f)]+')');try{await this[_0x4b8d1b(0x11a)](_0x4afc51),console['log'](_0x4b8d1b(0x13e)+(_0x505481+0x1)+_0x4b8d1b(0x168)+_0x4afc51);}catch(_0x3e9444){console[_0x4b8d1b(0x14f)](_0x4b8d1b(0xf0)+(_0x505481+0x1)+_0x4b8d1b(0x120)+_0x4afc51+':',_0x3e9444),this['logCoinToPayError'](_0x4afc51,_0x4a8e71,_0x3e9444,_0x4b8d1b(0x15b),{'checkNumber':_0x505481+0x1,'scheduledAfter':_0x207ffa['description'],'isIndividualCheck':!![]});}},_0x39babd);_0x1a9140[_0x26728a(0x108)](_0x5585e4),console[_0x26728a(0x15c)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x505481+0x1)+_0x26728a(0x120)+_0x4afc51+_0x26728a(0xb2)+_0x39babd/0x3e8+_0x26728a(0x9c)+_0x207ffa[_0x26728a(0x12f)]+')');});const _0x551f4f=setInterval(async()=>{const _0x2a67ff=_0x31a9c8;console['log'](_0x2a67ff(0xf5)+_0x4afc51);try{const _0x1ca885=await database_1[_0x2a67ff(0x109)]['payment'][_0x2a67ff(0x98)]({'where':{'id':_0x4afc51},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x1ca885){console[_0x2a67ff(0x15c)]('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x4afc51+'\x20not\x20found,\x20clearing\x20timers'),this[_0x2a67ff(0x114)](_0x4afc51);return;}console[_0x2a67ff(0x15c)](_0x2a67ff(0xad)+_0x4afc51+_0x2a67ff(0xc3)+_0x1ca885[_0x2a67ff(0x157)]);if(_0x1ca885['status']!=='PENDING'){console['log']('‚úÖ\x20[HOURLY]\x20Payment\x20'+_0x4afc51+'\x20status\x20is\x20'+_0x1ca885['status']+_0x2a67ff(0x14b)),this[_0x2a67ff(0x114)](_0x4afc51);return;}const _0x184d2d=Math['floor']((Date['now']()-_0x1ca885['createdAt'][_0x2a67ff(0xc5)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x184d2d>=this['EXPIRY_DAYS']){console[_0x2a67ff(0x15c)](_0x2a67ff(0x166)+_0x4afc51+_0x2a67ff(0x134)+this[_0x2a67ff(0x94)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x2a67ff(0x114)](_0x4afc51);return;}await this[_0x2a67ff(0x11a)](_0x4afc51),console[_0x2a67ff(0x15c)]('‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x4afc51);}catch(_0x236bc7){console[_0x2a67ff(0x14f)](_0x2a67ff(0xe0)+_0x4afc51+':',_0x236bc7),this[_0x2a67ff(0x151)](_0x4afc51,_0x4a8e71,_0x236bc7,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x1a9140[_0x31a9c8(0x108)](_0x551f4f),this[_0x31a9c8(0x113)][_0x31a9c8(0xfb)](_0x4afc51,{'timers':_0x1a9140,'paymentId':_0x4afc51,'gatewayPaymentId':_0x4a8e71,'createdAt':_0x5cc536}),console[_0x31a9c8(0x15c)](_0x31a9c8(0x136)+_0x4a4f20[_0x31a9c8(0x127)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x4afc51),console[_0x31a9c8(0x15c)](_0x31a9c8(0xe9)+this[_0x31a9c8(0x113)][_0x31a9c8(0x135)]),this[_0x31a9c8(0x145)](_0x4afc51,_0x4a8e71,_0x31a9c8(0x14d),'PENDING',_0x31a9c8(0x15b),{'action':'schedule_created','scheduledChecks':_0x4a4f20[_0x31a9c8(0x127)],'firstCheckIn':_0x4a4f20[0x0][_0x31a9c8(0x11f)]/0x3e8,'totalTimers':this[_0x31a9c8(0x113)][_0x31a9c8(0x135)]});}[a37_0x23ce37(0x114)](_0x313617){const _0x28e8cc=a37_0x23ce37,_0x997acb=this['paymentTimers'][_0x28e8cc(0xd3)](_0x313617);_0x997acb?(console[_0x28e8cc(0x15c)]('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x997acb[_0x28e8cc(0xef)][_0x28e8cc(0x127)]+_0x28e8cc(0xab)+_0x313617),_0x997acb['timers'][_0x28e8cc(0xb5)]((_0x5984d1,_0x14ae45)=>{const _0x816e9b=_0x28e8cc;_0x5984d1&&(clearTimeout(_0x5984d1),clearInterval(_0x5984d1),console[_0x816e9b(0x15c)](_0x816e9b(0x119)+(_0x14ae45+0x1)+_0x816e9b(0x120)+_0x313617));}),this[_0x28e8cc(0x113)][_0x28e8cc(0x10f)](_0x313617),console[_0x28e8cc(0x15c)](_0x28e8cc(0xec)+_0x313617+_0x28e8cc(0x15a)+this[_0x28e8cc(0x113)][_0x28e8cc(0x135)])):console[_0x28e8cc(0x15c)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x313617+'\x20to\x20clear');}async[a37_0x23ce37(0x11a)](_0x83a0f7){const _0x18fd50=a37_0x23ce37;console[_0x18fd50(0x15c)](_0x18fd50(0xc1)+_0x83a0f7);const _0xfee75d=await database_1[_0x18fd50(0x109)][_0x18fd50(0xe6)]['findUnique']({'where':{'id':_0x83a0f7},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xfee75d){console[_0x18fd50(0x15c)](_0x18fd50(0xcc)+_0x83a0f7+_0x18fd50(0xa7));return;}console[_0x18fd50(0x15c)]('üìä\x20[CHECK]\x20Payment\x20'+_0x83a0f7+_0x18fd50(0xb0)),console[_0x18fd50(0x15c)](_0x18fd50(0xea)+_0xfee75d[_0x18fd50(0x124)]),console['log']('\x20\x20\x20-\x20Status:\x20'+_0xfee75d['status']),console['log']('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0xfee75d[_0x18fd50(0xa0)]),console[_0x18fd50(0x15c)](_0x18fd50(0xa2)+_0xfee75d[_0x18fd50(0xcd)]+'\x20'+_0xfee75d['currency']),console[_0x18fd50(0x15c)](_0x18fd50(0xf7)+_0xfee75d[_0x18fd50(0xd8)]);if(_0xfee75d[_0x18fd50(0x124)]!==_0x18fd50(0x131)){console[_0x18fd50(0x15c)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x83a0f7+_0x18fd50(0xf1)+_0xfee75d[_0x18fd50(0x124)]+')');return;}if(_0xfee75d[_0x18fd50(0x157)]!==_0x18fd50(0x14d)){console[_0x18fd50(0x15c)](_0x18fd50(0x129)+_0x83a0f7+_0x18fd50(0x11d)+_0xfee75d[_0x18fd50(0x157)]+_0x18fd50(0x14b)),this[_0x18fd50(0x114)](_0x83a0f7);return;}if(!_0xfee75d[_0x18fd50(0xa0)]){console[_0x18fd50(0x15c)](_0x18fd50(0x129)+_0x83a0f7+_0x18fd50(0xf8));return;}console[_0x18fd50(0x15c)]('‚úÖ\x20[CHECK]\x20Payment\x20'+_0x83a0f7+_0x18fd50(0x96)),await this[_0x18fd50(0x172)](_0xfee75d);}[a37_0x23ce37(0x145)](_0x40c426,_0x11f3f9,_0x4c8abf,_0x2e886a,_0xf19ab5,_0x644714){const _0x5842a8=a37_0x23ce37,_0x28686f={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x40c426,'gatewayPaymentId':_0x11f3f9,'oldStatus':_0x4c8abf,'newStatus':_0x2e886a,'source':_0xf19ab5,'timestamp':new Date()[_0x5842a8(0xb4)](),'details':_0x644714||{}};loggerService_1['loggerService'][_0x5842a8(0x145)](_0x28686f),console['log']('ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x40c426+'\x20('+_0x11f3f9+')'),console['log']('\x20\x20\x20üìä\x20Status:\x20'+_0x4c8abf+_0x5842a8(0x165)+_0x2e886a),console['log']('\x20\x20\x20üìç\x20Source:\x20'+_0xf19ab5),console[_0x5842a8(0x15c)](_0x5842a8(0x103)+_0x28686f[_0x5842a8(0xca)]),_0x644714&&console['log'](_0x5842a8(0x105),_0x644714);}[a37_0x23ce37(0x151)](_0x39d20d,_0x14574d,_0x85febe,_0x60bcf0,_0x5b780b){const _0x3be6c1=a37_0x23ce37,_0x4fbf79={'type':_0x3be6c1(0x154),'paymentId':_0x39d20d,'gatewayPaymentId':_0x14574d,'error':_0x85febe instanceof Error?{'message':_0x85febe[_0x3be6c1(0x12d)],'stack':_0x85febe[_0x3be6c1(0x159)]}:_0x85febe,'source':_0x60bcf0,'timestamp':new Date()[_0x3be6c1(0xb4)](),'context':_0x5b780b||{}};loggerService_1[_0x3be6c1(0x13c)]['logCoinToPayError'](_0x4fbf79),console['error'](_0x3be6c1(0xaf)+_0x39d20d+'\x20('+_0x14574d+')'),console['error'](_0x3be6c1(0x146)+(_0x85febe instanceof Error?_0x85febe[_0x3be6c1(0x12d)]:_0x85febe)),console[_0x3be6c1(0x14f)](_0x3be6c1(0xf6)+_0x60bcf0),console['error'](_0x3be6c1(0x103)+_0x4fbf79[_0x3be6c1(0xca)]),_0x5b780b&&console[_0x3be6c1(0x14f)](_0x3be6c1(0x143),_0x5b780b);}['startPeriodicStatusCheck'](){const _0x535896=a37_0x23ce37;console['log'](_0x535896(0x152)),this[_0x535896(0x148)]()[_0x535896(0xbd)](_0x442c52=>{const _0x54ff3f=_0x535896;console[_0x54ff3f(0x14f)](_0x54ff3f(0x16f),_0x442c52);}),this[_0x535896(0x149)]=setInterval(async()=>{const _0x1dce7a=_0x535896;try{console['log'](_0x1dce7a(0x125)),await this[_0x1dce7a(0x148)](),console[_0x1dce7a(0x15c)](_0x1dce7a(0x122));}catch(_0x583a02){console[_0x1dce7a(0x14f)]('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x583a02);}},this[_0x535896(0xe5)]),console[_0x535896(0x15c)](_0x535896(0x93));}[a37_0x23ce37(0x14e)](){const _0x462730=a37_0x23ce37;console[_0x462730(0x15c)]('üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x462730(0x149)]&&(clearInterval(this[_0x462730(0x149)]),this[_0x462730(0x149)]=null,console[_0x462730(0x15c)]('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x5a7673=this[_0x462730(0x113)][_0x462730(0x135)];for(const [_0x1a8fa1]of this['paymentTimers']){this[_0x462730(0x114)](_0x1a8fa1);}console[_0x462730(0x15c)](_0x462730(0x174)+_0x5a7673+_0x462730(0x14a));}async[a37_0x23ce37(0x148)](){const _0x2bd7d0=a37_0x23ce37;try{console[_0x2bd7d0(0x15c)]('ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x5887e9=await database_1[_0x2bd7d0(0x109)][_0x2bd7d0(0xe6)][_0x2bd7d0(0x11b)]({'where':{'gateway':_0x2bd7d0(0x131),'status':_0x2bd7d0(0x14d),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x2bd7d0(0x15c)](_0x2bd7d0(0xda)+_0x5887e9[_0x2bd7d0(0x127)]+_0x2bd7d0(0xff));if(_0x5887e9[_0x2bd7d0(0x127)]===0x0){console[_0x2bd7d0(0x15c)](_0x2bd7d0(0x107));return;}const _0x27981d=await this[_0x2bd7d0(0x9a)](_0x5887e9);console[_0x2bd7d0(0x15c)](_0x2bd7d0(0xce)+_0x27981d[_0x2bd7d0(0x127)]+'\x20expired\x20CoinToPay\x20payments');let _0x156d7b=0x0,_0x1247c9=0x0;for(const _0x58a0f4 of _0x5887e9){try{if(_0x27981d[_0x2bd7d0(0xe1)](_0x58a0f4['id'])){console[_0x2bd7d0(0x15c)](_0x2bd7d0(0x11e)+_0x58a0f4['id']+_0x2bd7d0(0x10b)),_0x1247c9++;continue;}if(this[_0x2bd7d0(0x113)][_0x2bd7d0(0xe7)](_0x58a0f4['id'])){console[_0x2bd7d0(0x15c)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x58a0f4['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x1247c9++;continue;}const _0xce205=(Date[_0x2bd7d0(0xc4)]()-_0x58a0f4[_0x2bd7d0(0xac)][_0x2bd7d0(0xc5)]())/(0x3e8*0x3c*0x3c);if(_0xce205<0x1){console[_0x2bd7d0(0x15c)](_0x2bd7d0(0x11e)+_0x58a0f4['id']+_0x2bd7d0(0xcb)+_0xce205['toFixed'](0x1)+'h),\x20skipping\x20global\x20check'),_0x1247c9++;continue;}console['log']('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x58a0f4['id']+_0x2bd7d0(0x10a)+_0xce205[_0x2bd7d0(0x111)](0x1)+'h)'),await this[_0x2bd7d0(0x172)](_0x58a0f4),_0x156d7b++,await new Promise(_0x22ccc8=>setTimeout(_0x22ccc8,0x7d0));}catch(_0x127c17){console['error'](_0x2bd7d0(0xfe)+_0x58a0f4['id']+':',_0x127c17),this['logCoinToPayError'](_0x58a0f4['id'],_0x58a0f4['gatewayPaymentId']||_0x2bd7d0(0x115),_0x127c17,_0x2bd7d0(0x15b),{'isGlobalCheck':!![],'paymentAmount':_0x58a0f4[_0x2bd7d0(0xcd)],'paymentCurrency':_0x58a0f4[_0x2bd7d0(0x11c)],'shopId':_0x58a0f4[_0x2bd7d0(0xd8)],'createdAt':_0x58a0f4[_0x2bd7d0(0xac)]}),loggerService_1[_0x2bd7d0(0x13c)][_0x2bd7d0(0x147)](_0x2bd7d0(0x131),'/status/'+_0x58a0f4[_0x2bd7d0(0xa0)],_0x127c17);}}console[_0x2bd7d0(0x15c)](_0x2bd7d0(0x160)+_0x156d7b+'\x20checked,\x20'+_0x1247c9+_0x2bd7d0(0xf3)+_0x27981d[_0x2bd7d0(0x127)]+_0x2bd7d0(0x10d));}catch(_0x278e12){console[_0x2bd7d0(0x14f)](_0x2bd7d0(0xcf),_0x278e12);}}async[a37_0x23ce37(0x9a)](_0x29d007){const _0x164f31=a37_0x23ce37,_0x38dd1d=[],_0x596eaa=new Date();_0x596eaa[_0x164f31(0x16e)](_0x596eaa[_0x164f31(0xc7)]()-this[_0x164f31(0x94)]),console['log'](_0x164f31(0xb8)+this[_0x164f31(0x94)]+'\x20days\x20(created\x20before\x20'+_0x596eaa[_0x164f31(0xb4)]()+')');for(const _0x58cb76 of _0x29d007){if(_0x58cb76['createdAt']<_0x596eaa){console[_0x164f31(0x15c)](_0x164f31(0x13f)+_0x58cb76['id']+_0x164f31(0x134)+this[_0x164f31(0x94)]+_0x164f31(0x133));try{this[_0x164f31(0x145)](_0x58cb76['id'],_0x58cb76[_0x164f31(0xa0)]||_0x164f31(0x115),_0x164f31(0x14d),_0x164f31(0xd7),_0x164f31(0xfd),{'reason':_0x164f31(0xc2)+this['EXPIRY_DAYS']+_0x164f31(0x117),'createdAt':_0x58cb76['createdAt'],'daysSinceCreation':Math[_0x164f31(0x14c)]((Date['now']()-_0x58cb76[_0x164f31(0xac)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x58cb76['amount'],'paymentCurrency':_0x58cb76[_0x164f31(0x11c)],'shopId':_0x58cb76[_0x164f31(0xd8)]}),await database_1[_0x164f31(0x109)][_0x164f31(0xe6)][_0x164f31(0xb3)]({'where':{'id':_0x58cb76['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x164f31(0x163)+this[_0x164f31(0x94)]+_0x164f31(0xdf)}}),await database_1['default'][_0x164f31(0xe8)]['create']({'data':{'paymentId':_0x58cb76['id'],'shopId':_0x58cb76[_0x164f31(0xd8)],'event':_0x164f31(0x144),'statusCode':0xc8,'responseBody':JSON[_0x164f31(0xc9)]({'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x164f31(0x117),'createdAt':_0x58cb76[_0x164f31(0xac)],'expiredAt':new Date()[_0x164f31(0xb4)](),'daysSinceCreation':Math['floor']((Date[_0x164f31(0xc4)]()-_0x58cb76[_0x164f31(0xac)][_0x164f31(0xc5)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x164f31(0xbb)](_0x58cb76,_0x164f31(0xd7)),await this[_0x164f31(0xfc)](_0x58cb76,_0x164f31(0xd7)),this[_0x164f31(0x114)](_0x58cb76['id']),_0x38dd1d[_0x164f31(0x108)](_0x58cb76['id']),console[_0x164f31(0x15c)](_0x164f31(0xe3)+_0x58cb76['id']+_0x164f31(0x162)+this['EXPIRY_DAYS']+_0x164f31(0xdc));}catch(_0x4e07ff){console['error']('‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x58cb76['id']+':',_0x4e07ff),this[_0x164f31(0x151)](_0x58cb76['id'],_0x58cb76[_0x164f31(0xa0)]||_0x164f31(0x115),_0x4e07ff,_0x164f31(0xfd),{'reason':_0x164f31(0xe4),'createdAt':_0x58cb76[_0x164f31(0xac)],'daysSinceCreation':Math[_0x164f31(0x14c)]((Date[_0x164f31(0xc4)]()-_0x58cb76[_0x164f31(0xac)][_0x164f31(0xc5)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x38dd1d;}async[a37_0x23ce37(0x172)](_0x275082){const _0x1a8841=a37_0x23ce37;if(!_0x275082[_0x1a8841(0xa0)]){console['log'](_0x1a8841(0x129)+_0x275082['id']+_0x1a8841(0x16a));return;}console['log']('üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x275082['id']+'\x20('+_0x275082[_0x1a8841(0xa0)]+')');try{const _0x1c5c35=await this[_0x1a8841(0x126)][_0x1a8841(0xd2)](_0x275082[_0x1a8841(0xa0)]);console['log'](_0x1a8841(0x128)+_0x275082['id']+'\x20status:\x20'+_0x1c5c35['status']);_0x1c5c35['paymentDetails']&&console[_0x1a8841(0x15c)](_0x1a8841(0x128)+_0x275082['id']+_0x1a8841(0x139),{'iban':_0x1c5c35[_0x1a8841(0xeb)][_0x1a8841(0x9b)]||'not\x20found','transactionId':_0x1c5c35['paymentDetails'][_0x1a8841(0xd0)],'createdOn':_0x1c5c35[_0x1a8841(0xeb)][_0x1a8841(0xc0)],'confirmedOn':_0x1c5c35[_0x1a8841(0xeb)][_0x1a8841(0x12a)]||_0x1a8841(0x15d)});if(_0x1c5c35[_0x1a8841(0x157)]!==_0x275082[_0x1a8841(0x157)]){console[_0x1a8841(0x15c)](_0x1a8841(0x112)+_0x275082['id']+_0x1a8841(0x10e)+_0x275082[_0x1a8841(0x157)]+'\x20to\x20'+_0x1c5c35[_0x1a8841(0x157)]),this[_0x1a8841(0x145)](_0x275082['id'],_0x275082[_0x1a8841(0xa0)],_0x275082[_0x1a8841(0x157)],_0x1c5c35[_0x1a8841(0x157)],_0x1a8841(0x15b),{'paymentDetails':_0x1c5c35['paymentDetails'],'amount':_0x1c5c35[_0x1a8841(0xcd)],'currency':_0x1c5c35[_0x1a8841(0x11c)],'shopId':_0x275082[_0x1a8841(0xd8)],'checkTimestamp':new Date()[_0x1a8841(0xb4)]()});const _0x94e6de={'status':_0x1c5c35[_0x1a8841(0x157)],'updatedAt':new Date()};_0x1c5c35[_0x1a8841(0x157)]===_0x1a8841(0xd5)&&_0x275082[_0x1a8841(0x157)]!==_0x1a8841(0xd5)&&(_0x94e6de[_0x1a8841(0xdb)]=new Date(),console[_0x1a8841(0x15c)](_0x1a8841(0x132)+_0x275082['id']+_0x1a8841(0x10c)+_0x94e6de[_0x1a8841(0xdb)][_0x1a8841(0xb4)]()));if(_0x1c5c35[_0x1a8841(0xeb)]){const _0x4df98d=_0x1c5c35['paymentDetails'];_0x4df98d[_0x1a8841(0x9b)]&&(_0x94e6de[_0x1a8841(0x9f)]=_0x4df98d[_0x1a8841(0x9b)],console[_0x1a8841(0x15c)](_0x1a8841(0x140)+_0x4df98d[_0x1a8841(0x9b)]));if(_0x4df98d[_0x1a8841(0x15e)]){const _0x2030c4=_0x275082['adminNotes']||'',_0x365a9b='Bank\x20Details:\x20'+_0x4df98d['bankDetails'];_0x94e6de[_0x1a8841(0x169)]=_0x2030c4?_0x2030c4+'\x0a\x0a'+_0x365a9b:_0x365a9b,console[_0x1a8841(0x15c)]('üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x4df98d[_0x1a8841(0xd0)]&&console['log']('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x4df98d[_0x1a8841(0xd0)]),_0x4df98d[_0x1a8841(0x12a)]&&console['log'](_0x1a8841(0x9d)+_0x4df98d[_0x1a8841(0x12a)]);}await database_1[_0x1a8841(0x109)][_0x1a8841(0xe6)][_0x1a8841(0xb3)]({'where':{'id':_0x275082['id']},'data':_0x94e6de}),await database_1[_0x1a8841(0x109)][_0x1a8841(0xe8)][_0x1a8841(0xb1)]({'data':{'paymentId':_0x275082['id'],'shopId':_0x275082[_0x1a8841(0xd8)],'event':'cointopay_status_check_'+_0x1c5c35[_0x1a8841(0x157)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x1a8841(0xc9)]({'oldStatus':_0x275082[_0x1a8841(0x157)],'newStatus':_0x1c5c35['status'],'paymentDetails':_0x1c5c35[_0x1a8841(0xeb)],'checkedAt':new Date()[_0x1a8841(0xb4)]()})}}),await this[_0x1a8841(0xbb)](_0x275082,_0x1c5c35[_0x1a8841(0x157)]),await this[_0x1a8841(0xfc)](_0x275082,_0x1c5c35[_0x1a8841(0x157)]),_0x1c5c35[_0x1a8841(0x157)]!==_0x1a8841(0x14d)&&(console[_0x1a8841(0x15c)](_0x1a8841(0xa4)+_0x275082['id']+_0x1a8841(0x130)+_0x1c5c35['status']+_0x1a8841(0xb6)),this[_0x1a8841(0x114)](_0x275082['id'])),console[_0x1a8841(0x15c)](_0x1a8841(0xdd)+_0x275082['id']+'\x20updated\x20successfully');}else console[_0x1a8841(0x15c)]('üìä\x20[CHECK]\x20Payment\x20'+_0x275082['id']+_0x1a8841(0x123)+_0x1c5c35[_0x1a8841(0x157)]+')'),this['logCoinToPayStatus'](_0x275082['id'],_0x275082['gatewayPaymentId'],_0x275082[_0x1a8841(0x157)],_0x1c5c35[_0x1a8841(0x157)],_0x1a8841(0x15b),{'statusUnchanged':!![],'paymentDetails':_0x1c5c35[_0x1a8841(0xeb)],'amount':_0x1c5c35[_0x1a8841(0xcd)],'currency':_0x1c5c35[_0x1a8841(0x11c)],'shopId':_0x275082['shopId'],'checkTimestamp':new Date()[_0x1a8841(0xb4)]()});}catch(_0x516671){console[_0x1a8841(0x14f)](_0x1a8841(0x13a)+_0x275082['id']+':',_0x516671),this[_0x1a8841(0x151)](_0x275082['id'],_0x275082[_0x1a8841(0xa0)],_0x516671,_0x1a8841(0x15b),{'paymentAmount':_0x275082[_0x1a8841(0xcd)],'paymentCurrency':_0x275082['currency'],'shopId':_0x275082[_0x1a8841(0xd8)],'createdAt':_0x275082[_0x1a8841(0xac)]}),await database_1['default'][_0x1a8841(0xe8)]['create']({'data':{'paymentId':_0x275082['id'],'shopId':_0x275082['shopId'],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x516671 instanceof Error?_0x516671['message']:_0x1a8841(0x16d),'gatewayPaymentId':_0x275082[_0x1a8841(0xa0)],'checkedAt':new Date()[_0x1a8841(0xb4)]()})}});}}async[a37_0x23ce37(0xbb)](_0x58cb65,_0xd6a51b){const _0x3e53e0=a37_0x23ce37,_0xd8e983=Date[_0x3e53e0(0xc4)]();try{const _0x458ebe=_0x58cb65[_0x3e53e0(0x116)],_0x5addfa=_0x458ebe[_0x3e53e0(0xa6)];if(!_0x5addfa?.['webhookUrl']){console[_0x3e53e0(0x15c)](_0x3e53e0(0x99)+_0x458ebe['id']);return;}const _0x57f528=_0xd6a51b===_0x3e53e0(0xd5)?'payment.success':_0xd6a51b===_0x3e53e0(0x161)?_0x3e53e0(0x153):_0xd6a51b===_0x3e53e0(0xd7)?_0x3e53e0(0x153):'payment.pending';if(!_0x5addfa[_0x3e53e0(0x13b)]?.[_0x3e53e0(0xe1)](_0x57f528)){console['log'](_0x3e53e0(0xa8)+_0x57f528+_0x3e53e0(0x121)+_0x458ebe['id']);return;}const _0x572fbc={'event':_0x57f528,'payment':{'id':_0x58cb65['id'],'order_id':_0x58cb65['orderId'],'gateway_order_id':_0x58cb65['gatewayOrderId'],'gateway':_0x3e53e0(0x142),'amount':_0x58cb65['amount'],'currency':_0x58cb65[_0x3e53e0(0x11c)],'status':_0xd6a51b[_0x3e53e0(0x102)](),'customer_email':_0x58cb65[_0x3e53e0(0x97)],'customer_name':_0x58cb65[_0x3e53e0(0x173)],'created_at':_0x58cb65[_0x3e53e0(0xac)],'updated_at':new Date()}},_0xa7a376=await fetch(_0x5addfa[_0x3e53e0(0xe2)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x3e53e0(0xc9)](_0x572fbc)}),_0x62fdd2=Date['now']()-_0xd8e983,_0x5f1ef4=_0xa7a376['ok']?'Success':await _0xa7a376[_0x3e53e0(0x171)]();loggerService_1[_0x3e53e0(0x13c)][_0x3e53e0(0x100)](_0x58cb65[_0x3e53e0(0xd8)],_0x5addfa[_0x3e53e0(0xe2)],_0x57f528,_0xa7a376[_0x3e53e0(0x157)],_0x62fdd2,_0x572fbc),console[_0x3e53e0(0x15c)](_0x3e53e0(0x101)+_0x5addfa[_0x3e53e0(0xe2)]+_0x3e53e0(0x118)+_0xa7a376[_0x3e53e0(0x157)]+'\x20('+_0x62fdd2+_0x3e53e0(0xc8));}catch(_0x479341){console['error'](_0x3e53e0(0x12b),_0x479341),loggerService_1[_0x3e53e0(0x13c)][_0x3e53e0(0xba)](_0x58cb65[_0x3e53e0(0xd8)],_0x58cb65['shop']?.[_0x3e53e0(0xa6)]?.['webhookUrl']||'unknown',_0x3e53e0(0xc6),_0x479341,{});}}async['sendPaymentStatusNotification'](_0x4a5cc5,_0x4823ce){const _0x4019b0=a37_0x23ce37;try{const _0x43b2ff={'PENDING':'created','PAID':_0x4019b0(0xde),'FAILED':_0x4019b0(0xfa),'EXPIRED':_0x4019b0(0xa3)},_0x5e6826=_0x43b2ff[_0x4823ce];if(!_0x5e6826||_0x5e6826==='created')return;await telegramBotService_1[_0x4019b0(0x16c)][_0x4019b0(0xf4)](_0x4a5cc5['shopId'],_0x4a5cc5,_0x5e6826);}catch(_0x228b25){console[_0x4019b0(0x14f)](_0x4019b0(0x106),_0x228b25);}}async['checkPaymentById'](_0x3a2355){const _0x48a2ee=a37_0x23ce37;console[_0x48a2ee(0x15c)](_0x48a2ee(0xd1)+_0x3a2355);const _0x228c67=await database_1[_0x48a2ee(0x109)]['payment'][_0x48a2ee(0x98)]({'where':{'id':_0x3a2355},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x228c67)throw new Error('Payment\x20not\x20found');if(_0x228c67[_0x48a2ee(0x124)]!==_0x48a2ee(0x131))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x48a2ee(0x15c)](_0x48a2ee(0x164)+_0x3a2355),await this['checkSinglePayment'](_0x228c67),console[_0x48a2ee(0x15c)](_0x48a2ee(0x158)+_0x3a2355);}[a37_0x23ce37(0x150)](){const _0x5df6ec=a37_0x23ce37,_0x5a561b=this[_0x5df6ec(0x149)]?this[_0x5df6ec(0xe5)]:undefined,_0x5e5e19=Array['from'](this[_0x5df6ec(0x113)][_0x5df6ec(0x12e)]())[_0x5df6ec(0x156)](_0x5178f7=>({'paymentId':_0x5178f7[_0x5df6ec(0xae)],'gatewayPaymentId':_0x5178f7[_0x5df6ec(0xa0)],'createdAt':_0x5178f7['createdAt'],'timersCount':_0x5178f7[_0x5df6ec(0xef)][_0x5df6ec(0x127)]}));return{'isActive':!!this[_0x5df6ec(0x149)],'globalCheckIntervalMinutes':this[_0x5df6ec(0xe5)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x5df6ec(0x113)]['size'],'nextGlobalCheckIn':_0x5a561b,'paymentTimersDetails':_0x5e5e19};}[a37_0x23ce37(0x13d)](_0xd84aa4){const _0x472c6b=a37_0x23ce37,_0x3ccbcf=this[_0x472c6b(0x113)][_0x472c6b(0xd3)](_0xd84aa4);if(_0x3ccbcf)return{'hasTimers':!![],'timersCount':_0x3ccbcf['timers'][_0x472c6b(0x127)],'createdAt':_0x3ccbcf['createdAt'],'gatewayPaymentId':_0x3ccbcf[_0x472c6b(0xa0)]};return{'hasTimers':![]};}}exports[a37_0x23ce37(0xbc)]=CoinToPayStatusService,exports[a37_0x23ce37(0x137)]=new CoinToPayStatusService();