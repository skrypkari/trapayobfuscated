'use strict';const a38_0x285da2=a38_0x3ee8;(function(_0x47aeed,_0x1dd128){const _0x56ba80=a38_0x3ee8,_0x4ba3df=_0x47aeed();while(!![]){try{const _0x3e635a=parseInt(_0x56ba80(0x1b7))/0x1*(-parseInt(_0x56ba80(0x1c0))/0x2)+parseInt(_0x56ba80(0x1d5))/0x3+parseInt(_0x56ba80(0x20c))/0x4+-parseInt(_0x56ba80(0x29e))/0x5+-parseInt(_0x56ba80(0x22d))/0x6*(-parseInt(_0x56ba80(0x286))/0x7)+parseInt(_0x56ba80(0x272))/0x8+parseInt(_0x56ba80(0x1e1))/0x9*(-parseInt(_0x56ba80(0x1d1))/0xa);if(_0x3e635a===_0x1dd128)break;else _0x4ba3df['push'](_0x4ba3df['shift']());}catch(_0x345c0a){_0x4ba3df['push'](_0x4ba3df['shift']());}}}(a38_0x2c39,0x8b46c));function a38_0x3ee8(_0x20dcdb,_0x4f1238){const _0x2c3999=a38_0x2c39();return a38_0x3ee8=function(_0x3ee83f,_0x1298b1){_0x3ee83f=_0x3ee83f-0x1b0;let _0x8533c8=_0x2c3999[_0x3ee83f];return _0x8533c8;},a38_0x3ee8(_0x20dcdb,_0x4f1238);}function a38_0x2c39(){const _0x5056fd=['\x20\x20\x20-\x20gatewayPaymentId:\x20','🪙\x20[DEBUG]\x20Creating\x20','10tJZkgK','cointopay_status_check_','message','\x20updated\x20successfully','813732GBPzto','shop','transactionId','from','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','bankDetails','./gateways/coinToPayService','default','📊\x20[CHECK]\x20CoinToPay\x20payment\x20',':\x20type=','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','\x20seconds\x20(','11696103BAMsbA','\x20\x20\x20Gateway\x20','application/json','\x20timers\x20for\x20payment\x20','timers','\x20updated:\x20currentPayments=','🛑\x20[SHUTDOWN]\x20Cleared\x20','now','⏰\x20[GLOBAL]\x20Payment\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','PAID','\x20triggered\x20for\x20payment\x20','findUnique','./loggerService','get','length','⚠️\x20[CHECK]\x20Payment\x20','iban','checkExpiredPayments','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','globalCheckInterval','\x20\x20\x20-\x20Amount:\x20','\x20\x20\x20📅\x20Time:\x20','\x20for\x20payment\x20','✅\x20[EXPIRY]\x20Payment\x20','convertToUSDT','catch','logCoinToPayStatus','delete','./telegramBotService','logCoinToPayError','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','checkSinglePayment','🔍\x20[CHECK]\x20Checking\x20','not\x20found','paymentDetails','toISOString','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','cointopay_auto_expired','\x20\x20\x20📍\x20Source:\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','📊\x20[HOURLY]\x20Payment\x20','currency','3882136UiJgQw','failed','sendPaymentStatusNotification','paid','currentPayments','toFixed','getTime','\x20individual\x20payment\x20timers','auto_expire','delay','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','Payment\x20not\x20found','1\x20minute','📊\x20[CHECK]\x20Payment\x20','EXPIRED','\x20(age:\x20','\x20not\x20enabled\x20for\x20shop\x20','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','ms)','shopId',',\x20using\x20default\x20commission\x2010%','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','coinToPay2Service','currencyService','adminNotes','has','\x20\x20\x20❌\x20Error:\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','payment','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','SINGLE','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','732KEWSve','\x20\x20\x20📝\x20Context:','\x20initial\x20timers\x20for\x20payment\x20','📈\x20[COINTOPAY]\x20Payment\x20','gatewaySettings','PENDING','logShopWebhookError','\x20expired','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','paymentTimers','\x20->\x20','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','COMPLETED','checkPaymentStatus','remitterIban','coinToPayStatusService','\x20skipped,\x20','payment.pending','getServiceStats','\x20payment\x20','🧹\x20[DEBUG]\x20Clearing\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','schedule_created','gateway','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','expired','push','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','confirmedOn','\x20not\x20found\x20in\x20database','\x20(after\x20',',\x20stopping\x20individual\x20checks','\x20\x20\x20📊\x20Status:\x20','\x20marked\x20as\x20paid\x20at:\x20','\x20days\x20without\x20payment\x20confirmation','values','CoinToPayStatusService','\x20to\x20clear','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','logShopWebhookSent','error','entries','toLowerCase','\x20USDT','\x20status\x20is\x20','\x20amounts\x20calculated:','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','sendShopWebhook','amountUSDT','\x20is\x20older\x20than\x20','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','coinToPayService','webhookUrl','.\x20Remaining\x20active\x20timers:\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','Shop\x20webhook\x20sent\x20to\x20','⏰\x20[EXPIRY]\x20Payment\x20','5\x20minutes','Payment\x20older\x20than\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20status:\x20','status_check','timestamp','❌\x20[CHECK]\x20Payment\x20','Gateway\x20','Webhook\x20event\x20','not\x20confirmed','4118384PhjRVT','customerName','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','Automatically\x20expired\x20after\x20','createdOn','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','paymentLinkId','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','description','CoinToPay2Service','⏰\x20[HOURLY]\x20Payment\x20','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','\x20status\x20from\x20','\x20status\x20unchanged\x20(','\x20days','\x20\x20\x20-\x20GatewayPaymentId:\x20','getGatewayIdByName','stringify','schedulePaymentChecks','29407UeyvHO','type','✅\x20[CHECK]\x20Payment\x20','create','\x20\x20\x20-\x20ShopId:\x20','floor','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20commission\x20for\x20shop\x20','checkSinglePaymentById','GLOBAL_CHECK_INTERVAL_MS','createdAt','sendPaymentNotification',',\x20clearing\x20individual\x20timers','settings','FAILED','\x20pending\x20CoinToPay\x20payments','\x20is\x20valid\x20for\x20checking,\x20proceeding...','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20commission:\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','unknown','created','clearPaymentTimers','833610OmnvEt','\x20days\x20(created\x20before\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20\x20\x20-\x20Gateway:\x20','checkAllPendingPayments','stack','\x20to\x20','-day\x20timeout','webhook_send','loggerService','\x20\x20\x20📝\x20Details:','gatewayPaymentId','/status/','../config/database','startPeriodicStatusCheck','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','../types/gateway','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','❌\x20[HOURLY]\x20Payment\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','includes','cointopay2','size','log','\x20expired\x20CoinToPay\x20payments','set','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20found:','Unknown\x20error','🔄\x20[CHECK]\x20Updating\x20payment\x20','COINTOPAY_ERROR','\x20checked,\x20','\x20status\x20changed\x20to\x20','\x20in\x20','\x20in\x20shop\x20','getDate','📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','./currencyService','1QhdLFH','update','checkPaymentById','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','stopPeriodicStatusCheck','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20',',\x20status=','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','paidAt','464666pUpOTe','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','\x20\x20\x20-\x20paymentId:\x20','setDate','getPaymentTimerInfo','cointopay','paymentLink','EXPIRY_DAYS','💰\x20[CHECK]\x20Payment\x20','webhookEvents','🪙\x20[GLOBAL]\x20Found\x20','amount','status'];a38_0x2c39=function(){return _0x5056fd;};return a38_0x2c39();}var __importDefault=this&&this['__importDefault']||function(_0x34cfae){return _0x34cfae&&_0x34cfae['__esModule']?_0x34cfae:{'default':_0x34cfae};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['coinToPayStatusService']=exports[a38_0x285da2(0x253)]=void 0x0;const coinToPayService_1=require(a38_0x285da2(0x1db)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require(a38_0x285da2(0x2ae)),database_1=__importDefault(require(a38_0x285da2(0x2ab))),telegramBotService_1=require(a38_0x285da2(0x1fe)),loggerService_1=require(a38_0x285da2(0x1ee)),currencyService_1=require(a38_0x285da2(0x1b6));class CoinToPayStatusService{constructor(){const _0x4981c6=a38_0x285da2;this[_0x4981c6(0x1f5)]=null,this[_0x4981c6(0x28f)]=0x3c*0x3c*0x3e8,this[_0x4981c6(0x1c9)]=0x5,this['paymentTimers']=new Map(),this[_0x4981c6(0x262)]=new coinToPayService_1['CoinToPayService'](),this[_0x4981c6(0x222)]=new coinToPay2Service_1[(_0x4981c6(0x27c))](),console['log']('🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}[a38_0x285da2(0x285)](_0x372282,_0x57fe8c){const _0x51f0ee=a38_0x285da2;console[_0x51f0ee(0x2b5)](_0x51f0ee(0x24a)),console[_0x51f0ee(0x2b5)](_0x51f0ee(0x1c4)+_0x372282),console[_0x51f0ee(0x2b5)](_0x51f0ee(0x1cf)+_0x57fe8c),this[_0x51f0ee(0x29d)](_0x372282);const _0x14a53e=[],_0x473b79=new Date(),_0x220659=[{'delay':0x1*0x3c*0x3e8,'description':_0x51f0ee(0x218)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x51f0ee(0x268)},{'delay':0x5*0x3c*0x3e8,'description':_0x51f0ee(0x268)}];console[_0x51f0ee(0x2b5)](_0x51f0ee(0x1d0)+_0x220659['length']+_0x51f0ee(0x22f)+_0x372282);let _0x68f7ec=0x0;_0x220659['forEach']((_0x23559a,_0x1b8722)=>{const _0x554ef7=_0x51f0ee;_0x68f7ec+=_0x23559a['delay'];const _0x803add=setTimeout(async()=>{const _0x4e5488=a38_0x3ee8;console[_0x4e5488(0x2b5)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x1b8722+0x1)+_0x4e5488(0x1ec)+_0x372282+_0x4e5488(0x24d)+_0x23559a['description']+')');try{await this[_0x4e5488(0x28e)](_0x372282),console[_0x4e5488(0x2b5)](_0x4e5488(0x243)+(_0x1b8722+0x1)+'\x20completed\x20for\x20payment\x20'+_0x372282);}catch(_0x302883){console[_0x4e5488(0x257)]('❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x1b8722+0x1)+_0x4e5488(0x1f8)+_0x372282+':',_0x302883),this[_0x4e5488(0x1ff)](_0x372282,_0x57fe8c,_0x302883,_0x4e5488(0x26c),{'checkNumber':_0x1b8722+0x1,'scheduledAfter':_0x23559a['description'],'isIndividualCheck':!![]});}},_0x68f7ec);_0x14a53e[_0x554ef7(0x249)](_0x803add),console[_0x554ef7(0x2b5)](_0x554ef7(0x238)+(_0x1b8722+0x1)+_0x554ef7(0x1f8)+_0x372282+_0x554ef7(0x1b2)+_0x68f7ec/0x3e8+_0x554ef7(0x1e0)+_0x23559a[_0x554ef7(0x27b)]+')');});const _0x4e0635=setInterval(async()=>{const _0x476d21=_0x51f0ee;console['log'](_0x476d21(0x209)+_0x372282);try{const _0x33dea9=await database_1[_0x476d21(0x1dc)][_0x476d21(0x228)][_0x476d21(0x1ed)]({'where':{'id':_0x372282},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x33dea9){console[_0x476d21(0x2b5)](_0x476d21(0x2b0)+_0x372282+'\x20not\x20found,\x20clearing\x20timers'),this[_0x476d21(0x29d)](_0x372282);return;}console[_0x476d21(0x2b5)](_0x476d21(0x20a)+_0x372282+'\x20current\x20status:\x20'+_0x33dea9[_0x476d21(0x1ce)]);if(_0x33dea9['status']!==_0x476d21(0x232)){console[_0x476d21(0x2b5)]('✅\x20[HOURLY]\x20Payment\x20'+_0x372282+_0x476d21(0x25b)+_0x33dea9[_0x476d21(0x1ce)]+_0x476d21(0x24e)),this[_0x476d21(0x29d)](_0x372282);return;}const _0x4d07f7=Math['floor']((Date['now']()-_0x33dea9[_0x476d21(0x290)][_0x476d21(0x212)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x4d07f7>=this[_0x476d21(0x1c9)]){console['log'](_0x476d21(0x27d)+_0x372282+_0x476d21(0x260)+this[_0x476d21(0x1c9)]+_0x476d21(0x2a0)),this[_0x476d21(0x29d)](_0x372282);return;}await this[_0x476d21(0x28e)](_0x372282),console[_0x476d21(0x2b5)](_0x476d21(0x242)+_0x372282);}catch(_0xb4cba4){console[_0x476d21(0x257)](_0x476d21(0x22c)+_0x372282+':',_0xb4cba4),this['logCoinToPayError'](_0x372282,_0x57fe8c,_0xb4cba4,_0x476d21(0x26c),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x14a53e[_0x51f0ee(0x249)](_0x4e0635),this[_0x51f0ee(0x236)][_0x51f0ee(0x2b7)](_0x372282,{'timers':_0x14a53e,'paymentId':_0x372282,'gatewayPaymentId':_0x57fe8c,'createdAt':_0x473b79}),console[_0x51f0ee(0x2b5)](_0x51f0ee(0x1bc)+_0x220659[_0x51f0ee(0x1f0)]+_0x51f0ee(0x28c)+_0x372282),console[_0x51f0ee(0x2b5)]('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x51f0ee(0x236)][_0x51f0ee(0x2b4)]),this[_0x51f0ee(0x1fc)](_0x372282,_0x57fe8c,'PENDING','PENDING','status_check',{'action':_0x51f0ee(0x244),'scheduledChecks':_0x220659['length'],'firstCheckIn':_0x220659[0x0][_0x51f0ee(0x215)]/0x3e8,'totalTimers':this['paymentTimers'][_0x51f0ee(0x2b4)]});}[a38_0x285da2(0x29d)](_0xbf6304){const _0x189a65=a38_0x285da2,_0x2cd61f=this[_0x189a65(0x236)][_0x189a65(0x1ef)](_0xbf6304);_0x2cd61f?(console['log'](_0x189a65(0x241)+_0x2cd61f[_0x189a65(0x1e5)]['length']+_0x189a65(0x1e4)+_0xbf6304),_0x2cd61f['timers']['forEach']((_0x45735b,_0x592d74)=>{const _0x2f141d=_0x189a65;_0x45735b&&(clearTimeout(_0x45735b),clearInterval(_0x45735b),console[_0x2f141d(0x2b5)](_0x2f141d(0x274)+(_0x592d74+0x1)+_0x2f141d(0x1f8)+_0xbf6304));}),this[_0x189a65(0x236)][_0x189a65(0x1fd)](_0xbf6304),console[_0x189a65(0x2b5)](_0x189a65(0x2b8)+_0xbf6304+_0x189a65(0x264)+this[_0x189a65(0x236)][_0x189a65(0x2b4)])):console['log'](_0x189a65(0x2b1)+_0xbf6304+_0x189a65(0x254));}async[a38_0x285da2(0x28e)](_0x5edf3b){const _0x39190b=a38_0x285da2;console[_0x39190b(0x2b5)](_0x39190b(0x22a)+_0x5edf3b);const _0x21e762=await database_1['default'][_0x39190b(0x228)][_0x39190b(0x1ed)]({'where':{'id':_0x5edf3b},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x21e762){console[_0x39190b(0x2b5)](_0x39190b(0x26e)+_0x5edf3b+_0x39190b(0x24c));return;}console[_0x39190b(0x2b5)](_0x39190b(0x219)+_0x5edf3b+_0x39190b(0x2b9)),console[_0x39190b(0x2b5)](_0x39190b(0x2a1)+_0x21e762[_0x39190b(0x245)]),console[_0x39190b(0x2b5)]('\x20\x20\x20-\x20Status:\x20'+_0x21e762[_0x39190b(0x1ce)]),console[_0x39190b(0x2b5)](_0x39190b(0x282)+_0x21e762['gatewayPaymentId']),console['log'](_0x39190b(0x1f6)+_0x21e762[_0x39190b(0x1cd)]+'\x20'+_0x21e762['currency']),console[_0x39190b(0x2b5)](_0x39190b(0x28a)+_0x21e762[_0x39190b(0x21f)]);if(_0x21e762['gateway']!=='cointopay'&&_0x21e762[_0x39190b(0x245)]!==_0x39190b(0x2b3)){console[_0x39190b(0x2b5)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x5edf3b+_0x39190b(0x206)+_0x21e762[_0x39190b(0x245)]+')');return;}if(_0x21e762['status']!=='PENDING'){console[_0x39190b(0x2b5)](_0x39190b(0x1f1)+_0x5edf3b+_0x39190b(0x25b)+_0x21e762[_0x39190b(0x1ce)]+_0x39190b(0x24e)),this[_0x39190b(0x29d)](_0x5edf3b);return;}if(!_0x21e762[_0x39190b(0x2a9)]){console[_0x39190b(0x2b5)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x5edf3b+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x39190b(0x2b5)](_0x39190b(0x288)+_0x5edf3b+_0x39190b(0x296)),await this['checkSinglePayment'](_0x21e762);}[a38_0x285da2(0x1fc)](_0xcf5add,_0x392138,_0x4efa4f,_0x12e776,_0x225242,_0x22bad5){const _0x306f34=a38_0x285da2,_0x552d27={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0xcf5add,'gatewayPaymentId':_0x392138,'oldStatus':_0x4efa4f,'newStatus':_0x12e776,'source':_0x225242,'timestamp':new Date()['toISOString'](),'details':_0x22bad5||{}};loggerService_1[_0x306f34(0x2a7)]['logCoinToPayStatus'](_0x552d27),console['log'](_0x306f34(0x255)+_0xcf5add+'\x20('+_0x392138+')'),console[_0x306f34(0x2b5)](_0x306f34(0x24f)+_0x4efa4f+_0x306f34(0x237)+_0x12e776),console[_0x306f34(0x2b5)](_0x306f34(0x208)+_0x225242),console[_0x306f34(0x2b5)](_0x306f34(0x1f7)+_0x552d27['timestamp']),_0x22bad5&&console[_0x306f34(0x2b5)](_0x306f34(0x2a8),_0x22bad5);}[a38_0x285da2(0x1ff)](_0x3db037,_0x11b0d0,_0x318c3b,_0x1a8cf5,_0x549fa7){const _0x28e094=a38_0x285da2,_0x5635a4={'type':_0x28e094(0x2bc),'paymentId':_0x3db037,'gatewayPaymentId':_0x11b0d0,'error':_0x318c3b instanceof Error?{'message':_0x318c3b['message'],'stack':_0x318c3b[_0x28e094(0x2a3)]}:_0x318c3b,'source':_0x1a8cf5,'timestamp':new Date()['toISOString'](),'context':_0x549fa7||{}};loggerService_1[_0x28e094(0x2a7)][_0x28e094(0x1ff)](_0x5635a4),console[_0x28e094(0x257)]('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x3db037+'\x20('+_0x11b0d0+')'),console['error'](_0x28e094(0x226)+(_0x318c3b instanceof Error?_0x318c3b[_0x28e094(0x1d3)]:_0x318c3b)),console[_0x28e094(0x257)](_0x28e094(0x208)+_0x1a8cf5),console[_0x28e094(0x257)]('\x20\x20\x20📅\x20Time:\x20'+_0x5635a4[_0x28e094(0x26d)]),_0x549fa7&&console[_0x28e094(0x257)](_0x28e094(0x22e),_0x549fa7);}[a38_0x285da2(0x2ac)](){const _0x58bf9d=a38_0x285da2;console[_0x58bf9d(0x2b5)](_0x58bf9d(0x2ad)),this[_0x58bf9d(0x2a2)]()[_0x58bf9d(0x1fb)](_0x464a0c=>{const _0x4341b0=_0x58bf9d;console['error'](_0x4341b0(0x26a),_0x464a0c);}),this['globalCheckInterval']=setInterval(async()=>{const _0xbbbda8=_0x58bf9d;try{console['log'](_0xbbbda8(0x265)),await this[_0xbbbda8(0x2a2)](),console[_0xbbbda8(0x2b5)](_0xbbbda8(0x21d));}catch(_0x4be68a){console[_0xbbbda8(0x257)](_0xbbbda8(0x298),_0x4be68a);}},this[_0x58bf9d(0x28f)]),console[_0x58bf9d(0x2b5)](_0x58bf9d(0x200));}[a38_0x285da2(0x1bb)](){const _0x4e963b=a38_0x285da2;console[_0x4e963b(0x2b5)](_0x4e963b(0x1ba));this[_0x4e963b(0x1f5)]&&(clearInterval(this['globalCheckInterval']),this[_0x4e963b(0x1f5)]=null,console[_0x4e963b(0x2b5)](_0x4e963b(0x1d9)));const _0x553d51=this[_0x4e963b(0x236)][_0x4e963b(0x2b4)];for(const [_0x558366]of this[_0x4e963b(0x236)]){this[_0x4e963b(0x29d)](_0x558366);}console[_0x4e963b(0x2b5)](_0x4e963b(0x1e7)+_0x553d51+_0x4e963b(0x213));}async[a38_0x285da2(0x2a2)](){const _0x89a9f3=a38_0x285da2;try{console[_0x89a9f3(0x2b5)](_0x89a9f3(0x246));const _0x1704eb=await database_1[_0x89a9f3(0x1dc)][_0x89a9f3(0x228)]['findMany']({'where':{'gateway':{'in':[_0x89a9f3(0x1c7),'cointopay2']},'status':_0x89a9f3(0x232),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x89a9f3(0x1cc)+_0x1704eb[_0x89a9f3(0x1f0)]+_0x89a9f3(0x295));if(_0x1704eb[_0x89a9f3(0x1f0)]===0x0){console[_0x89a9f3(0x2b5)](_0x89a9f3(0x25d));return;}const _0x473157=await this[_0x89a9f3(0x1f3)](_0x1704eb);console[_0x89a9f3(0x2b5)]('⏰\x20[GLOBAL]\x20Found\x20'+_0x473157[_0x89a9f3(0x1f0)]+_0x89a9f3(0x2b6));let _0x19e0c0=0x0,_0x2cf3c4=0x0;for(const _0x4936ea of _0x1704eb){try{if(_0x473157['includes'](_0x4936ea['id'])){console[_0x89a9f3(0x2b5)](_0x89a9f3(0x1e9)+_0x4936ea['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x2cf3c4++;continue;}if(this['paymentTimers'][_0x89a9f3(0x225)](_0x4936ea['id'])){console['log'](_0x89a9f3(0x1e9)+_0x4936ea['id']+_0x89a9f3(0x216)),_0x2cf3c4++;continue;}const _0x365fc7=(Date[_0x89a9f3(0x1e8)]()-_0x4936ea[_0x89a9f3(0x290)][_0x89a9f3(0x212)]())/(0x3e8*0x3c*0x3c);if(_0x365fc7<0x1){console[_0x89a9f3(0x2b5)](_0x89a9f3(0x1e9)+_0x4936ea['id']+'\x20is\x20too\x20new\x20('+_0x365fc7[_0x89a9f3(0x211)](0x1)+'h),\x20skipping\x20global\x20check'),_0x2cf3c4++;continue;}console['log']('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x4936ea['id']+_0x89a9f3(0x21b)+_0x365fc7[_0x89a9f3(0x211)](0x1)+'h)'),await this[_0x89a9f3(0x201)](_0x4936ea),_0x19e0c0++,await new Promise(_0x553e84=>setTimeout(_0x553e84,0x7d0));}catch(_0x48886f){console['error'](_0x89a9f3(0x1be)+_0x4936ea['id']+':',_0x48886f),this[_0x89a9f3(0x1ff)](_0x4936ea['id'],_0x4936ea[_0x89a9f3(0x2a9)]||_0x89a9f3(0x29b),_0x48886f,_0x89a9f3(0x26c),{'isGlobalCheck':!![],'paymentAmount':_0x4936ea['amount'],'paymentCurrency':_0x4936ea[_0x89a9f3(0x20b)],'shopId':_0x4936ea[_0x89a9f3(0x21f)],'createdAt':_0x4936ea[_0x89a9f3(0x290)]}),loggerService_1[_0x89a9f3(0x2a7)]['logWhiteDomainError'](_0x89a9f3(0x1c7),_0x89a9f3(0x2aa)+_0x4936ea[_0x89a9f3(0x2a9)],_0x48886f);}}console[_0x89a9f3(0x2b5)](_0x89a9f3(0x235)+_0x19e0c0+_0x89a9f3(0x1b0)+_0x2cf3c4+_0x89a9f3(0x23d)+_0x473157[_0x89a9f3(0x1f0)]+_0x89a9f3(0x234));}catch(_0x5f2bc1){console[_0x89a9f3(0x257)]('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x5f2bc1);}}async[a38_0x285da2(0x1f3)](_0x1eb9da){const _0x59c478=a38_0x285da2,_0x2c3e7c=[],_0x4fecd0=new Date();_0x4fecd0[_0x59c478(0x1c5)](_0x4fecd0[_0x59c478(0x1b4)]()-this[_0x59c478(0x1c9)]),console[_0x59c478(0x2b5)](_0x59c478(0x27a)+this[_0x59c478(0x1c9)]+_0x59c478(0x29f)+_0x4fecd0[_0x59c478(0x205)]()+')');for(const _0xdccb69 of _0x1eb9da){if(_0xdccb69[_0x59c478(0x290)]<_0x4fecd0){console[_0x59c478(0x2b5)](_0x59c478(0x267)+_0xdccb69['id']+_0x59c478(0x260)+this[_0x59c478(0x1c9)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this['logCoinToPayStatus'](_0xdccb69['id'],_0xdccb69[_0x59c478(0x2a9)]||'unknown',_0x59c478(0x232),'EXPIRED','auto_expire',{'reason':_0x59c478(0x269)+this[_0x59c478(0x1c9)]+_0x59c478(0x281),'createdAt':_0xdccb69[_0x59c478(0x290)],'daysSinceCreation':Math['floor']((Date[_0x59c478(0x1e8)]()-_0xdccb69[_0x59c478(0x290)][_0x59c478(0x212)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0xdccb69[_0x59c478(0x1cd)],'paymentCurrency':_0xdccb69['currency'],'shopId':_0xdccb69[_0x59c478(0x21f)]}),await database_1['default'][_0x59c478(0x228)]['update']({'where':{'id':_0xdccb69['id']},'data':{'status':_0x59c478(0x21a),'updatedAt':new Date(),'adminNotes':_0x59c478(0x275)+this[_0x59c478(0x1c9)]+_0x59c478(0x251)}}),await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0xdccb69['id'],'shopId':_0xdccb69[_0x59c478(0x21f)],'event':_0x59c478(0x207),'statusCode':0xc8,'responseBody':JSON[_0x59c478(0x284)]({'reason':_0x59c478(0x269)+this[_0x59c478(0x1c9)]+_0x59c478(0x281),'createdAt':_0xdccb69['createdAt'],'expiredAt':new Date()[_0x59c478(0x205)](),'daysSinceCreation':Math['floor']((Date[_0x59c478(0x1e8)]()-_0xdccb69[_0x59c478(0x290)][_0x59c478(0x212)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x59c478(0x25e)](_0xdccb69,_0x59c478(0x21a)),await this[_0x59c478(0x20e)](_0xdccb69,_0x59c478(0x21a)),this[_0x59c478(0x29d)](_0xdccb69['id']),_0x2c3e7c[_0x59c478(0x249)](_0xdccb69['id']),console['log'](_0x59c478(0x1f9)+_0xdccb69['id']+_0x59c478(0x277)+this[_0x59c478(0x1c9)]+_0x59c478(0x2a5));}catch(_0x31f8e1){console[_0x59c478(0x257)](_0x59c478(0x229)+_0xdccb69['id']+':',_0x31f8e1),this[_0x59c478(0x1ff)](_0xdccb69['id'],_0xdccb69[_0x59c478(0x2a9)]||'unknown',_0x31f8e1,_0x59c478(0x214),{'reason':_0x59c478(0x1ea),'createdAt':_0xdccb69['createdAt'],'daysSinceCreation':Math[_0x59c478(0x28b)]((Date[_0x59c478(0x1e8)]()-_0xdccb69[_0x59c478(0x290)][_0x59c478(0x212)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x2c3e7c;}async[a38_0x285da2(0x201)](_0x10d367){const _0x4ec64c=a38_0x285da2;if(!_0x10d367[_0x4ec64c(0x2a9)]){console[_0x4ec64c(0x2b5)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x10d367['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x4ec64c(0x2b5)](_0x4ec64c(0x202)+_0x10d367[_0x4ec64c(0x245)]+_0x4ec64c(0x240)+_0x10d367['id']+'\x20('+_0x10d367[_0x4ec64c(0x2a9)]+')');try{let _0x4940f6;_0x10d367['gateway']===_0x4ec64c(0x2b3)?(_0x4940f6=await this[_0x4ec64c(0x222)][_0x4ec64c(0x23a)](_0x10d367[_0x4ec64c(0x2a9)]),console[_0x4ec64c(0x2b5)](_0x4ec64c(0x2af)+_0x10d367['id']+_0x4ec64c(0x26b)+_0x4940f6[_0x4ec64c(0x1ce)])):(_0x4940f6=await this[_0x4ec64c(0x262)][_0x4ec64c(0x23a)](_0x10d367[_0x4ec64c(0x2a9)]),console[_0x4ec64c(0x2b5)](_0x4ec64c(0x1dd)+_0x10d367['id']+'\x20status:\x20'+_0x4940f6['status']));_0x4940f6['paymentDetails']&&console['log'](_0x4ec64c(0x219)+_0x10d367['id']+'\x20details:',{'iban':_0x4940f6['paymentDetails'][_0x4ec64c(0x1f2)]||_0x4ec64c(0x203),'transactionId':_0x4940f6['paymentDetails']['transactionId'],'createdOn':_0x4940f6[_0x4ec64c(0x204)][_0x4ec64c(0x276)],'confirmedOn':_0x4940f6[_0x4ec64c(0x204)][_0x4ec64c(0x24b)]||_0x4ec64c(0x271)});if(_0x4940f6[_0x4ec64c(0x1ce)]!==_0x10d367[_0x4ec64c(0x1ce)]){console[_0x4ec64c(0x2b5)](_0x4ec64c(0x2bb)+_0x10d367['id']+_0x4ec64c(0x27f)+_0x10d367[_0x4ec64c(0x1ce)]+_0x4ec64c(0x2a4)+_0x4940f6['status']),this[_0x4ec64c(0x1fc)](_0x10d367['id'],_0x10d367[_0x4ec64c(0x2a9)],_0x10d367['status'],_0x4940f6[_0x4ec64c(0x1ce)],_0x4ec64c(0x26c),{'paymentDetails':_0x4940f6['paymentDetails'],'amount':_0x4940f6[_0x4ec64c(0x1cd)],'currency':_0x4940f6[_0x4ec64c(0x20b)],'shopId':_0x10d367[_0x4ec64c(0x21f)],'checkTimestamp':new Date()[_0x4ec64c(0x205)]()});const _0x465b0b={'status':_0x4940f6['status'],'updatedAt':new Date()};if(_0x4940f6[_0x4ec64c(0x1ce)]===_0x4ec64c(0x1eb)&&_0x10d367['status']!==_0x4ec64c(0x1eb)){_0x465b0b['paidAt']=new Date();if(!_0x10d367[_0x4ec64c(0x25f)]){const _0x12c504=await currencyService_1[_0x4ec64c(0x223)][_0x4ec64c(0x1fa)](_0x10d367['amount'],_0x10d367['currency']);_0x465b0b[_0x4ec64c(0x25f)]=_0x12c504;const _0x4065ef=await this['getGatewayCommission'](_0x10d367[_0x4ec64c(0x21f)],_0x10d367[_0x4ec64c(0x245)]),_0x11e920=_0x12c504*(0x1-_0x4065ef/0x64);_0x465b0b['amountAfterGatewayCommissionUSDT']=_0x11e920,console[_0x4ec64c(0x2b5)](_0x4ec64c(0x1ca)+_0x10d367['id']+_0x4ec64c(0x25c)),console[_0x4ec64c(0x2b5)]('\x20\x20\x20Amount:\x20'+_0x10d367[_0x4ec64c(0x1cd)]+'\x20'+_0x10d367['currency']+'\x20->\x20'+_0x12c504[_0x4ec64c(0x211)](0x6)+_0x4ec64c(0x25a)),console['log'](_0x4ec64c(0x1e2)+_0x10d367[_0x4ec64c(0x245)]+_0x4ec64c(0x299)+_0x4065ef+'%'),console[_0x4ec64c(0x2b5)]('\x20\x20\x20Amount\x20after\x20commission:\x20'+_0x11e920[_0x4ec64c(0x211)](0x6)+_0x4ec64c(0x25a));}console[_0x4ec64c(0x2b5)](_0x4ec64c(0x1ca)+_0x10d367['id']+_0x4ec64c(0x250)+_0x465b0b[_0x4ec64c(0x1bf)][_0x4ec64c(0x205)]());}if(_0x4940f6[_0x4ec64c(0x204)]){const _0x3ed7b1=_0x4940f6[_0x4ec64c(0x204)];_0x3ed7b1['iban']&&(_0x465b0b[_0x4ec64c(0x23b)]=_0x3ed7b1[_0x4ec64c(0x1f2)],console[_0x4ec64c(0x2b5)](_0x4ec64c(0x261)+_0x3ed7b1[_0x4ec64c(0x1f2)]));if(_0x3ed7b1['bankDetails']){const _0x402b9f=_0x10d367[_0x4ec64c(0x224)]||'',_0x251015='Bank\x20Details:\x20'+_0x3ed7b1[_0x4ec64c(0x1da)];_0x465b0b[_0x4ec64c(0x224)]=_0x402b9f?_0x402b9f+'\x0a\x0a'+_0x251015:_0x251015,console[_0x4ec64c(0x2b5)](_0x4ec64c(0x279));}_0x3ed7b1['transactionId']&&console['log'](_0x4ec64c(0x297)+_0x3ed7b1[_0x4ec64c(0x1d7)]),_0x3ed7b1[_0x4ec64c(0x24b)]&&console[_0x4ec64c(0x2b5)](_0x4ec64c(0x1f4)+_0x3ed7b1['confirmedOn']);}await database_1[_0x4ec64c(0x1dc)][_0x4ec64c(0x228)][_0x4ec64c(0x1b8)]({'where':{'id':_0x10d367['id']},'data':_0x465b0b});if(_0x4940f6['status']==='PAID'&&_0x10d367[_0x4ec64c(0x1ce)]!==_0x4ec64c(0x1eb)){console['log']('📈\x20[COINTOPAY]\x20Payment\x20'+_0x10d367['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x496691=await database_1[_0x4ec64c(0x1dc)]['payment']['findUnique']({'where':{'id':_0x10d367['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x496691?.[_0x4ec64c(0x278)]&&_0x496691[_0x4ec64c(0x1c8)])try{const _0x170d38=_0x496691[_0x4ec64c(0x1c8)];console[_0x4ec64c(0x2b5)](_0x4ec64c(0x1b5)+_0x170d38['id']+_0x4ec64c(0x1de)+_0x170d38[_0x4ec64c(0x287)]+',\x20currentPayments='+_0x170d38[_0x4ec64c(0x210)]+_0x4ec64c(0x1bd)+_0x170d38[_0x4ec64c(0x1ce)]);const _0x23de71=_0x170d38[_0x4ec64c(0x210)]+0x1,_0xc691e6=_0x170d38[_0x4ec64c(0x287)]===_0x4ec64c(0x22b)?_0x4ec64c(0x239):_0x170d38[_0x4ec64c(0x1ce)];await database_1['default']['paymentLink'][_0x4ec64c(0x1b8)]({'where':{'id':_0x170d38['id']},'data':{'currentPayments':_0x23de71,'status':_0xc691e6,'updatedAt':new Date()}}),console['log']('✅\x20[COINTOPAY]\x20Payment\x20link\x20'+_0x170d38['id']+_0x4ec64c(0x1e6)+_0x170d38[_0x4ec64c(0x210)]+'\x20->\x20'+_0x23de71+_0x4ec64c(0x1bd)+_0x170d38[_0x4ec64c(0x1ce)]+'\x20->\x20'+_0xc691e6);}catch(_0x5831f2){console['error'](_0x4ec64c(0x1df),_0x5831f2);}else console[_0x4ec64c(0x2b5)](_0x4ec64c(0x230)+_0x10d367['id']+_0x4ec64c(0x227));}await database_1[_0x4ec64c(0x1dc)]['webhookLog'][_0x4ec64c(0x289)]({'data':{'paymentId':_0x10d367['id'],'shopId':_0x10d367[_0x4ec64c(0x21f)],'event':_0x4ec64c(0x1d2)+_0x4940f6[_0x4ec64c(0x1ce)][_0x4ec64c(0x259)](),'statusCode':0xc8,'responseBody':JSON[_0x4ec64c(0x284)]({'oldStatus':_0x10d367[_0x4ec64c(0x1ce)],'newStatus':_0x4940f6['status'],'paymentDetails':_0x4940f6[_0x4ec64c(0x204)],'checkedAt':new Date()[_0x4ec64c(0x205)]()})}}),await this[_0x4ec64c(0x25e)](_0x10d367,_0x4940f6['status']),await this['sendPaymentStatusNotification'](_0x10d367,_0x4940f6[_0x4ec64c(0x1ce)]),_0x4940f6[_0x4ec64c(0x1ce)]!==_0x4ec64c(0x232)&&(console[_0x4ec64c(0x2b5)]('🧹\x20[CHECK]\x20Payment\x20'+_0x10d367['id']+_0x4ec64c(0x1b1)+_0x4940f6[_0x4ec64c(0x1ce)]+_0x4ec64c(0x292)),this[_0x4ec64c(0x29d)](_0x10d367['id'])),console[_0x4ec64c(0x2b5)](_0x4ec64c(0x288)+_0x10d367['id']+_0x4ec64c(0x1d4));}else console[_0x4ec64c(0x2b5)]('📊\x20[CHECK]\x20Payment\x20'+_0x10d367['id']+_0x4ec64c(0x280)+_0x4940f6['status']+')'),this[_0x4ec64c(0x1fc)](_0x10d367['id'],_0x10d367['gatewayPaymentId'],_0x10d367[_0x4ec64c(0x1ce)],_0x4940f6[_0x4ec64c(0x1ce)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x4940f6['paymentDetails'],'amount':_0x4940f6['amount'],'currency':_0x4940f6[_0x4ec64c(0x20b)],'shopId':_0x10d367[_0x4ec64c(0x21f)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x91964c){console[_0x4ec64c(0x257)](_0x4ec64c(0x1c2)+_0x10d367['id']+':',_0x91964c),this[_0x4ec64c(0x1ff)](_0x10d367['id'],_0x10d367['gatewayPaymentId'],_0x91964c,_0x4ec64c(0x26c),{'paymentAmount':_0x10d367[_0x4ec64c(0x1cd)],'paymentCurrency':_0x10d367[_0x4ec64c(0x20b)],'shopId':_0x10d367['shopId'],'createdAt':_0x10d367[_0x4ec64c(0x290)]}),await database_1[_0x4ec64c(0x1dc)]['webhookLog'][_0x4ec64c(0x289)]({'data':{'paymentId':_0x10d367['id'],'shopId':_0x10d367['shopId'],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x4ec64c(0x284)]({'error':_0x91964c instanceof Error?_0x91964c[_0x4ec64c(0x1d3)]:_0x4ec64c(0x2ba),'gatewayPaymentId':_0x10d367[_0x4ec64c(0x2a9)],'checkedAt':new Date()['toISOString']()})}});}}async['sendShopWebhook'](_0x8fa14d,_0x4bebcd){const _0x3135e5=a38_0x285da2,_0x3cff6e=Date[_0x3135e5(0x1e8)]();try{const _0x54fb2c=_0x8fa14d[_0x3135e5(0x1d6)],_0x56b0dd=_0x54fb2c['settings'];if(!_0x56b0dd?.[_0x3135e5(0x263)]){console[_0x3135e5(0x2b5)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x54fb2c['id']);return;}const _0x56103a=_0x4bebcd===_0x3135e5(0x1eb)?'payment.success':_0x4bebcd===_0x3135e5(0x294)?'payment.failed':_0x4bebcd===_0x3135e5(0x21a)?'payment.failed':_0x3135e5(0x23e);if(!_0x56b0dd[_0x3135e5(0x1cb)]?.[_0x3135e5(0x2b2)](_0x56103a)){console['log'](_0x3135e5(0x270)+_0x56103a+_0x3135e5(0x21c)+_0x54fb2c['id']);return;}const _0x4eea35=(0x0,gateway_1[_0x3135e5(0x283)])(_0x8fa14d['gateway'])||_0x8fa14d[_0x3135e5(0x245)],_0xf1b8c6={'event':_0x56103a,'payment':{'id':_0x8fa14d['id'],'order_id':_0x8fa14d['orderId'],'gateway_order_id':_0x8fa14d['gatewayOrderId'],'gateway':_0x4eea35,'amount':_0x8fa14d[_0x3135e5(0x1cd)],'currency':_0x8fa14d['currency'],'status':_0x4bebcd[_0x3135e5(0x259)](),'customer_email':_0x8fa14d['customerEmail'],'customer_name':_0x8fa14d[_0x3135e5(0x273)],'created_at':_0x8fa14d[_0x3135e5(0x290)],'updated_at':new Date()}},_0x15291a=await fetch(_0x56b0dd[_0x3135e5(0x263)],{'method':'POST','headers':{'Content-Type':_0x3135e5(0x1e3),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x3135e5(0x284)](_0xf1b8c6)}),_0x4bf281=Date[_0x3135e5(0x1e8)]()-_0x3cff6e,_0x1d4cd6=_0x15291a['ok']?'Success':await _0x15291a['text']();loggerService_1[_0x3135e5(0x2a7)][_0x3135e5(0x256)](_0x8fa14d[_0x3135e5(0x21f)],_0x56b0dd[_0x3135e5(0x263)],_0x56103a,_0x15291a['status'],_0x4bf281,_0xf1b8c6),console['log'](_0x3135e5(0x266)+_0x56b0dd[_0x3135e5(0x263)]+'\x20with\x20status\x20'+_0x15291a[_0x3135e5(0x1ce)]+'\x20('+_0x4bf281+_0x3135e5(0x21e));}catch(_0xa4e88c){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0xa4e88c),loggerService_1[_0x3135e5(0x2a7)][_0x3135e5(0x233)](_0x8fa14d['shopId'],_0x8fa14d[_0x3135e5(0x1d6)]?.[_0x3135e5(0x293)]?.[_0x3135e5(0x263)]||_0x3135e5(0x29b),_0x3135e5(0x2a6),_0xa4e88c,{});}}async[a38_0x285da2(0x20e)](_0x2e50da,_0x17802a){const _0x376175=a38_0x285da2;try{const _0x129706={'PENDING':_0x376175(0x29c),'PAID':_0x376175(0x20f),'FAILED':_0x376175(0x20d),'EXPIRED':_0x376175(0x248)},_0x4ddc2b=_0x129706[_0x17802a];if(!_0x4ddc2b||_0x4ddc2b==='created')return;await telegramBotService_1['telegramBotService'][_0x376175(0x291)](_0x2e50da[_0x376175(0x21f)],_0x2e50da,_0x4ddc2b);}catch(_0x2afeff){console[_0x376175(0x257)](_0x376175(0x247),_0x2afeff);}}async[a38_0x285da2(0x1b9)](_0x48a6c3){const _0x334779=a38_0x285da2;console['log'](_0x334779(0x29a)+_0x48a6c3);const _0x10303e=await database_1[_0x334779(0x1dc)][_0x334779(0x228)][_0x334779(0x1ed)]({'where':{'id':_0x48a6c3},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x10303e)throw new Error(_0x334779(0x217));if(_0x10303e[_0x334779(0x245)]!==_0x334779(0x1c7)&&_0x10303e['gateway']!==_0x334779(0x2b3))throw new Error(_0x334779(0x1c1));console[_0x334779(0x2b5)](_0x334779(0x1c3)+_0x10303e['gateway']+_0x334779(0x240)+_0x48a6c3),await this[_0x334779(0x201)](_0x10303e),console[_0x334779(0x2b5)]('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x48a6c3);}[a38_0x285da2(0x23f)](){const _0x610fc6=a38_0x285da2,_0x4fcb88=this['globalCheckInterval']?this[_0x610fc6(0x28f)]:undefined,_0x5d0c7f=Array[_0x610fc6(0x1d8)](this[_0x610fc6(0x236)][_0x610fc6(0x252)]())['map'](_0x14bdb0=>({'paymentId':_0x14bdb0['paymentId'],'gatewayPaymentId':_0x14bdb0[_0x610fc6(0x2a9)],'createdAt':_0x14bdb0[_0x610fc6(0x290)],'timersCount':_0x14bdb0[_0x610fc6(0x1e5)]['length']}));return{'isActive':!!this[_0x610fc6(0x1f5)],'globalCheckIntervalMinutes':this[_0x610fc6(0x28f)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this['paymentTimers'][_0x610fc6(0x2b4)],'nextGlobalCheckIn':_0x4fcb88,'paymentTimersDetails':_0x5d0c7f};}[a38_0x285da2(0x1c6)](_0x48e009){const _0x5ec48d=a38_0x285da2,_0x271196=this[_0x5ec48d(0x236)][_0x5ec48d(0x1ef)](_0x48e009);if(_0x271196)return{'hasTimers':!![],'timersCount':_0x271196[_0x5ec48d(0x1e5)]['length'],'createdAt':_0x271196[_0x5ec48d(0x290)],'gatewayPaymentId':_0x271196[_0x5ec48d(0x2a9)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0x1c74d5,_0x18539c){const _0x5a0423=a38_0x285da2;try{const _0x9c467f=await database_1[_0x5a0423(0x1dc)][_0x5a0423(0x1d6)][_0x5a0423(0x1ed)]({'where':{'id':_0x1c74d5},'select':{'gatewaySettings':!![]}});if(!_0x9c467f?.[_0x5a0423(0x231)])return console[_0x5a0423(0x2b5)](_0x5a0423(0x221)+_0x1c74d5+_0x5a0423(0x220)),0xa;const _0x3727be=JSON['parse'](_0x9c467f['gatewaySettings']);for(const [_0x44f30f,_0x3947ec]of Object[_0x5a0423(0x258)](_0x3727be)){if(_0x44f30f[_0x5a0423(0x259)]()===_0x18539c[_0x5a0423(0x259)]()){const _0x1bdcf6=_0x3947ec['commission']||0xa;return console[_0x5a0423(0x2b5)](_0x5a0423(0x26f)+_0x18539c+_0x5a0423(0x28d)+_0x1c74d5+':\x20'+_0x1bdcf6+'%'),_0x1bdcf6;}}return console[_0x5a0423(0x2b5)](_0x5a0423(0x27e)+_0x18539c+_0x5a0423(0x1b3)+_0x1c74d5+',\x20using\x20default\x2010%'),0xa;}catch(_0x487c74){return console[_0x5a0423(0x257)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x1c74d5+',\x20gateway\x20'+_0x18539c+':',_0x487c74),0xa;}}}exports[a38_0x285da2(0x253)]=CoinToPayStatusService,exports[a38_0x285da2(0x23c)]=new CoinToPayStatusService();