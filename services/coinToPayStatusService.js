'use strict';const a37_0x53067a=a37_0x40d3;(function(_0x3d5e4f,_0x7f2c86){const _0x1c9138=a37_0x40d3,_0xc2f352=_0x3d5e4f();while(!![]){try{const _0x596aac=parseInt(_0x1c9138(0x204))/0x1+parseInt(_0x1c9138(0x29e))/0x2+-parseInt(_0x1c9138(0x223))/0x3*(-parseInt(_0x1c9138(0x230))/0x4)+parseInt(_0x1c9138(0x266))/0x5+parseInt(_0x1c9138(0x1f9))/0x6+parseInt(_0x1c9138(0x28b))/0x7*(-parseInt(_0x1c9138(0x29b))/0x8)+-parseInt(_0x1c9138(0x2d1))/0x9;if(_0x596aac===_0x7f2c86)break;else _0xc2f352['push'](_0xc2f352['shift']());}catch(_0x3806ef){_0xc2f352['push'](_0xc2f352['shift']());}}}(a37_0x31f5,0xc8215));function a37_0x40d3(_0x511c9e,_0x516f62){const _0x31f52e=a37_0x31f5();return a37_0x40d3=function(_0x40d306,_0x3431c6){_0x40d306=_0x40d306-0x1ec;let _0x2e35b1=_0x31f52e[_0x40d306];return _0x2e35b1;},a37_0x40d3(_0x511c9e,_0x516f62);}function a37_0x31f5(){const _0x5ce1f3=['has','logCoinToPayStatus','toLowerCase','timers','\x20status:\x20','__esModule','\x20has\x20no\x20gatewayPaymentId,\x20skipping','Failed\x20to\x20send\x20shop\x20webhook:','remitterIban','checkSinglePayment','\x20days\x20without\x20payment\x20confirmation','getServiceStats','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','push','EXPIRY_DAYS','gatewayPaymentId','\x20pending\x20CoinToPay\x20payments','\x20\x20\x20üìç\x20Source:\x20','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','catch','description','1\x20minute','‚ùå\x20[HOURLY]\x20Payment\x20','gateway','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','3cONYmK','createdAt','now','schedulePaymentChecks','findUnique','failed','payment.failed','sendShopWebhook','clearPaymentTimers','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','paidAt','\x20expired\x20CoinToPay\x20payments','1380268MBnnRs','unknown','text','\x20is\x20too\x20new\x20(','\x20\x20\x20-\x20Gateway:\x20','‚è∞\x20[HOURLY]\x20Payment\x20','map','values','paymentId','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20\x20\x20üìä\x20Status:\x20','customerName','adminNotes','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','forEach','\x20not\x20found\x20in\x20database','-day\x20timeout','COINTOPAY_ERROR','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','status','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','shop','Payment\x20not\x20found','confirmedOn','toFixed','Shop\x20webhook\x20sent\x20to\x20','cointopay_status_check_error','payment','not\x20found','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20status\x20unchanged\x20(','payment.pending','coinToPayStatusService','\x20days','logShopWebhookError','\x20seconds\x20(','amount','startPeriodicStatusCheck','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20skipped,\x20','‚úÖ\x20[CHECK]\x20Payment\x20','‚úÖ\x20[EXPIRY]\x20Payment\x20','\x20found:','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','üßπ\x20[CHECK]\x20Payment\x20','./telegramBotService','create','sendPaymentNotification','\x20(after\x20','EXPIRED','COINTOPAY_STATUS_CHANGE','update','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','6134505PLiThc','length','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','0100','\x20\x20\x20-\x20paymentId:\x20','paymentDetails','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...',',\x20stopping\x20individual\x20checks','\x20initial\x20timers\x20for\x20payment\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','cointopay','2\x20minutes','ms)','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20current\x20status:\x20','\x20for\x20payment\x20','from','Success','PAID','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20status\x20changed\x20to\x20','coinToPayService','Bank\x20Details:\x20','get','\x20status\x20from\x20','logWhiteDomainError','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','5\x20minutes','globalCheckInterval','iban','\x20details:','\x20triggered\x20for\x20payment\x20','\x20timers\x20for\x20payment\x20','error','getPaymentTimerInfo','checkExpiredPayments','payment.success','1916152zEuRmp','loggerService','findMany','../config/database','\x20not\x20enabled\x20for\x20shop\x20','\x20\x20\x20üìÖ\x20Time:\x20','checkPaymentStatus','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','./loggerService','CoinToPayStatusService','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','FAILED','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','delete','includes','16GnYoBs','\x20in\x20','\x20to\x20','2780832DCGesD','/status/','default','ü™ô\x20CoinToPayStatusService\x20initialized','stringify','\x20->\x20','transactionId','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20\x20\x20-\x20gatewayPaymentId:\x20','Automatically\x20expired\x20after\x20','\x20\x20\x20-\x20ShopId:\x20','message','\x20completed\x20for\x20payment\x20','PENDING','currency','sendPaymentStatusNotification','size','stopPeriodicStatusCheck','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','\x20individual\x20payment\x20timers','set','logCoinToPayError','.\x20Remaining\x20active\x20timers:\x20','\x20\x20\x20‚ùå\x20Error:\x20','customerEmail','__importDefault','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','üßπ\x20[DEBUG]\x20Clearing\x20','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20marked\x20as\x20paid\x20at:\x20','ü™ô\x20[DEBUG]\x20Creating\x20','paymentTimers','GLOBAL_CHECK_INTERVAL_MS','./gateways/coinToPayService','toISOString','cointopay_status_check_','created','webhookUrl','orderId','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','checkAllPendingPayments','bankDetails','delay','log','webhookLog','Payment\x20older\x20than\x20','floor',',\x20clearing\x20individual\x20timers','CoinToPayService','36863676xpMTJt','timestamp','‚è∞\x20[GLOBAL]\x20Payment\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','üí∞\x20[CHECK]\x20Payment\x20','\x20status\x20is\x20','üõë\x20[SHUTDOWN]\x20Cleared\x20','\x20is\x20older\x20than\x20','paid','cointopay_auto_expired','TesSoft\x20Payment\x20System/1.0','\x20\x20\x20-\x20Amount:\x20','h),\x20skipping\x20global\x20check','üìä\x20[CHECK]\x20Payment\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','checkSinglePaymentById','9363432aTeaXQ','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','‚è∞\x20[GLOBAL]\x20Found\x20','status_check','webhook_send','schedule_created','shopId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20with\x20status\x20','getTime','940213UtFJUg','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20expired'];a37_0x31f5=function(){return _0x5ce1f3;};return a37_0x31f5();}var __importDefault=this&&this[a37_0x53067a(0x2b7)]||function(_0xc4376c){const _0x2404fd=a37_0x53067a;return _0xc4376c&&_0xc4376c[_0x2404fd(0x20d)]?_0xc4376c:{'default':_0xc4376c};};Object['defineProperty'](exports,a37_0x53067a(0x20d),{'value':!![]}),exports[a37_0x53067a(0x251)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a37_0x53067a(0x2c0)),database_1=__importDefault(require(a37_0x53067a(0x28e))),telegramBotService_1=require(a37_0x53067a(0x25e)),loggerService_1=require(a37_0x53067a(0x294));class CoinToPayStatusService{constructor(){const _0x5a12bf=a37_0x53067a;this[_0x5a12bf(0x282)]=null,this[_0x5a12bf(0x2bf)]=0x3c*0x3c*0x3e8,this[_0x5a12bf(0x216)]=0x5,this[_0x5a12bf(0x2be)]=new Map(),this[_0x5a12bf(0x27b)]=new coinToPayService_1[(_0x5a12bf(0x2d0))](),console[_0x5a12bf(0x2cb)](_0x5a12bf(0x2a1));}[a37_0x53067a(0x226)](_0x20cf5e,_0x120e5e){const _0x372884=a37_0x53067a;console[_0x372884(0x2cb)]('ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console['log'](_0x372884(0x26a)+_0x20cf5e),console[_0x372884(0x2cb)](_0x372884(0x2a6)+_0x120e5e),this[_0x372884(0x22b)](_0x20cf5e);const _0x34aa59=[],_0x17df7c=new Date(),_0x5350e9=[{'delay':0x1*0x3c*0x3e8,'description':_0x372884(0x21d)},{'delay':0x2*0x3c*0x3e8,'description':_0x372884(0x271)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x372884(0x281)}];console[_0x372884(0x2cb)](_0x372884(0x2bd)+_0x5350e9[_0x372884(0x267)]+_0x372884(0x26e)+_0x20cf5e);let _0x45b36b=0x0;_0x5350e9[_0x372884(0x23e)]((_0x4726f2,_0x11fcff)=>{const _0x1754fc=_0x372884;_0x45b36b+=_0x4726f2[_0x1754fc(0x2ca)];const _0x483c40=setTimeout(async()=>{const _0x131689=_0x1754fc;console[_0x131689(0x2cb)]('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x11fcff+0x1)+_0x131689(0x285)+_0x20cf5e+_0x131689(0x261)+_0x4726f2[_0x131689(0x21c)]+')');try{await this[_0x131689(0x1f8)](_0x20cf5e),console[_0x131689(0x2cb)](_0x131689(0x242)+(_0x11fcff+0x1)+_0x131689(0x2aa)+_0x20cf5e);}catch(_0x3464b8){console[_0x131689(0x287)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x11fcff+0x1)+'\x20for\x20payment\x20'+_0x20cf5e+':',_0x3464b8),this[_0x131689(0x2b3)](_0x20cf5e,_0x120e5e,_0x3464b8,'status_check',{'checkNumber':_0x11fcff+0x1,'scheduledAfter':_0x4726f2[_0x131689(0x21c)],'isIndividualCheck':!![]});}},_0x45b36b);_0x34aa59[_0x1754fc(0x215)](_0x483c40),console[_0x1754fc(0x2cb)](_0x1754fc(0x1fa)+(_0x11fcff+0x1)+_0x1754fc(0x275)+_0x20cf5e+_0x1754fc(0x29c)+_0x45b36b/0x3e8+_0x1754fc(0x254)+_0x4726f2[_0x1754fc(0x21c)]+')');});const _0xd2f477=setInterval(async()=>{const _0x244d89=_0x372884;console[_0x244d89(0x2cb)](_0x244d89(0x296)+_0x20cf5e);try{const _0x3633f7=await database_1['default'][_0x244d89(0x24c)][_0x244d89(0x227)]({'where':{'id':_0x20cf5e},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x3633f7){console[_0x244d89(0x2cb)](_0x244d89(0x21e)+_0x20cf5e+'\x20not\x20found,\x20clearing\x20timers'),this[_0x244d89(0x22b)](_0x20cf5e);return;}console[_0x244d89(0x2cb)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x20cf5e+_0x244d89(0x274)+_0x3633f7['status']);if(_0x3633f7[_0x244d89(0x244)]!==_0x244d89(0x2ab)){console['log']('‚úÖ\x20[HOURLY]\x20Payment\x20'+_0x20cf5e+_0x244d89(0x1ec)+_0x3633f7[_0x244d89(0x244)]+_0x244d89(0x26d)),this['clearPaymentTimers'](_0x20cf5e);return;}const _0x47a0bd=Math[_0x244d89(0x2ce)]((Date[_0x244d89(0x225)]()-_0x3633f7[_0x244d89(0x224)][_0x244d89(0x203)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x47a0bd>=this[_0x244d89(0x216)]){console['log'](_0x244d89(0x235)+_0x20cf5e+_0x244d89(0x1ee)+this['EXPIRY_DAYS']+_0x244d89(0x280)),this[_0x244d89(0x22b)](_0x20cf5e);return;}await this[_0x244d89(0x1f8)](_0x20cf5e),console['log']('‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x20cf5e);}catch(_0x457ab7){console[_0x244d89(0x287)]('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x20cf5e+':',_0x457ab7),this[_0x244d89(0x2b3)](_0x20cf5e,_0x120e5e,_0x457ab7,_0x244d89(0x1fd),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x34aa59[_0x372884(0x215)](_0xd2f477),this[_0x372884(0x2be)][_0x372884(0x2b2)](_0x20cf5e,{'timers':_0x34aa59,'paymentId':_0x20cf5e,'gatewayPaymentId':_0x120e5e,'createdAt':_0x17df7c}),console[_0x372884(0x2cb)](_0x372884(0x273)+_0x5350e9['length']+_0x372884(0x2d4)+_0x20cf5e),console['log']('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x372884(0x2be)][_0x372884(0x2ae)]),this['logCoinToPayStatus'](_0x20cf5e,_0x120e5e,_0x372884(0x2ab),_0x372884(0x2ab),_0x372884(0x1fd),{'action':_0x372884(0x1ff),'scheduledChecks':_0x5350e9['length'],'firstCheckIn':_0x5350e9[0x0][_0x372884(0x2ca)]/0x3e8,'totalTimers':this[_0x372884(0x2be)][_0x372884(0x2ae)]});}[a37_0x53067a(0x22b)](_0x3eb866){const _0x3a2a7b=a37_0x53067a,_0x26f890=this[_0x3a2a7b(0x2be)][_0x3a2a7b(0x27d)](_0x3eb866);_0x26f890?(console['log'](_0x3a2a7b(0x2ba)+_0x26f890[_0x3a2a7b(0x20b)][_0x3a2a7b(0x267)]+_0x3a2a7b(0x286)+_0x3eb866),_0x26f890['timers'][_0x3a2a7b(0x23e)]((_0x47725a,_0x2cb111)=>{const _0x1a9b36=_0x3a2a7b;_0x47725a&&(clearTimeout(_0x47725a),clearInterval(_0x47725a),console[_0x1a9b36(0x2cb)](_0x1a9b36(0x1f5)+(_0x2cb111+0x1)+_0x1a9b36(0x275)+_0x3eb866));}),this[_0x3a2a7b(0x2be)][_0x3a2a7b(0x299)](_0x3eb866),console[_0x3a2a7b(0x2cb)](_0x3a2a7b(0x2b8)+_0x3eb866+_0x3a2a7b(0x2b4)+this['paymentTimers']['size'])):console[_0x3a2a7b(0x2cb)](_0x3a2a7b(0x21a)+_0x3eb866+'\x20to\x20clear');}async['checkSinglePaymentById'](_0x38ed83){const _0x4caa7d=a37_0x53067a;console[_0x4caa7d(0x2cb)](_0x4caa7d(0x268)+_0x38ed83);const _0x29abc0=await database_1[_0x4caa7d(0x2a0)][_0x4caa7d(0x24c)]['findUnique']({'where':{'id':_0x38ed83},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x29abc0){console['log']('‚ùå\x20[CHECK]\x20Payment\x20'+_0x38ed83+_0x4caa7d(0x23f));return;}console[_0x4caa7d(0x2cb)](_0x4caa7d(0x1f4)+_0x38ed83+_0x4caa7d(0x25b)),console[_0x4caa7d(0x2cb)](_0x4caa7d(0x234)+_0x29abc0[_0x4caa7d(0x21f)]),console[_0x4caa7d(0x2cb)]('\x20\x20\x20-\x20Status:\x20'+_0x29abc0[_0x4caa7d(0x244)]),console[_0x4caa7d(0x2cb)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x29abc0[_0x4caa7d(0x217)]),console[_0x4caa7d(0x2cb)](_0x4caa7d(0x1f2)+_0x29abc0[_0x4caa7d(0x255)]+'\x20'+_0x29abc0['currency']),console['log'](_0x4caa7d(0x2a8)+_0x29abc0['shopId']);if(_0x29abc0[_0x4caa7d(0x21f)]!==_0x4caa7d(0x270)){console['log'](_0x4caa7d(0x298)+_0x38ed83+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x29abc0['gateway']+')');return;}if(_0x29abc0[_0x4caa7d(0x244)]!==_0x4caa7d(0x2ab)){console[_0x4caa7d(0x2cb)](_0x4caa7d(0x298)+_0x38ed83+_0x4caa7d(0x1ec)+_0x29abc0['status']+_0x4caa7d(0x26d)),this[_0x4caa7d(0x22b)](_0x38ed83);return;}if(!_0x29abc0['gatewayPaymentId']){console[_0x4caa7d(0x2cb)](_0x4caa7d(0x298)+_0x38ed83+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x4caa7d(0x2cb)](_0x4caa7d(0x259)+_0x38ed83+_0x4caa7d(0x26f)),await this[_0x4caa7d(0x211)](_0x29abc0);}[a37_0x53067a(0x209)](_0x636ba3,_0x24d251,_0x527738,_0x261fe5,_0x5b26ed,_0x443cbf){const _0x414b0a=a37_0x53067a,_0x406ecd={'type':_0x414b0a(0x263),'paymentId':_0x636ba3,'gatewayPaymentId':_0x24d251,'oldStatus':_0x527738,'newStatus':_0x261fe5,'source':_0x5b26ed,'timestamp':new Date()[_0x414b0a(0x2c1)](),'details':_0x443cbf||{}};loggerService_1[_0x414b0a(0x28c)]['logCoinToPayStatus'](_0x406ecd),console[_0x414b0a(0x2cb)](_0x414b0a(0x293)+_0x636ba3+'\x20('+_0x24d251+')'),console['log'](_0x414b0a(0x23a)+_0x527738+_0x414b0a(0x2a3)+_0x261fe5),console['log'](_0x414b0a(0x219)+_0x5b26ed),console['log'](_0x414b0a(0x290)+_0x406ecd[_0x414b0a(0x2d2)]),_0x443cbf&&console[_0x414b0a(0x2cb)]('\x20\x20\x20üìù\x20Details:',_0x443cbf);}[a37_0x53067a(0x2b3)](_0x2ebed2,_0xe96678,_0x4d7df2,_0x30ce05,_0x340c33){const _0x560025=a37_0x53067a,_0x523ba1={'type':_0x560025(0x241),'paymentId':_0x2ebed2,'gatewayPaymentId':_0xe96678,'error':_0x4d7df2 instanceof Error?{'message':_0x4d7df2[_0x560025(0x2a9)],'stack':_0x4d7df2['stack']}:_0x4d7df2,'source':_0x30ce05,'timestamp':new Date()[_0x560025(0x2c1)](),'context':_0x340c33||{}};loggerService_1[_0x560025(0x28c)][_0x560025(0x2b3)](_0x523ba1),console['error'](_0x560025(0x23d)+_0x2ebed2+'\x20('+_0xe96678+')'),console['error'](_0x560025(0x2b5)+(_0x4d7df2 instanceof Error?_0x4d7df2['message']:_0x4d7df2)),console[_0x560025(0x287)](_0x560025(0x219)+_0x30ce05),console[_0x560025(0x287)](_0x560025(0x290)+_0x523ba1[_0x560025(0x2d2)]),_0x340c33&&console[_0x560025(0x287)]('\x20\x20\x20üìù\x20Context:',_0x340c33);}[a37_0x53067a(0x256)](){const _0x102a38=a37_0x53067a;console[_0x102a38(0x2cb)]('ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x102a38(0x2c8)]()[_0x102a38(0x21b)](_0x24fea0=>{const _0x485927=_0x102a38;console['error'](_0x485927(0x265),_0x24fea0);}),this[_0x102a38(0x282)]=setInterval(async()=>{const _0x421d52=_0x102a38;try{console[_0x421d52(0x2cb)](_0x421d52(0x26c)),await this[_0x421d52(0x2c8)](),console[_0x421d52(0x2cb)](_0x421d52(0x214));}catch(_0x4ff353){console[_0x421d52(0x287)](_0x421d52(0x243),_0x4ff353);}},this[_0x102a38(0x2bf)]),console[_0x102a38(0x2cb)](_0x102a38(0x257));}[a37_0x53067a(0x2af)](){const _0x1469f6=a37_0x53067a;console['log'](_0x1469f6(0x292));this[_0x1469f6(0x282)]&&(clearInterval(this[_0x1469f6(0x282)]),this[_0x1469f6(0x282)]=null,console[_0x1469f6(0x2cb)](_0x1469f6(0x1f7)));const _0x21eb1d=this[_0x1469f6(0x2be)][_0x1469f6(0x2ae)];for(const [_0x127bf4]of this[_0x1469f6(0x2be)]){this[_0x1469f6(0x22b)](_0x127bf4);}console['log'](_0x1469f6(0x1ed)+_0x21eb1d+_0x1469f6(0x2b1));}async[a37_0x53067a(0x2c8)](){const _0x547eed=a37_0x53067a;try{console[_0x547eed(0x2cb)](_0x547eed(0x2a5));const _0x4e1d17=await database_1['default'][_0x547eed(0x24c)][_0x547eed(0x28d)]({'where':{'gateway':_0x547eed(0x270),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x547eed(0x2cb)]('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x4e1d17['length']+_0x547eed(0x218));if(_0x4e1d17[_0x547eed(0x267)]===0x0){console[_0x547eed(0x2cb)](_0x547eed(0x2bb));return;}const _0x2c68bf=await this[_0x547eed(0x289)](_0x4e1d17);console['log'](_0x547eed(0x1fc)+_0x2c68bf[_0x547eed(0x267)]+_0x547eed(0x22f));let _0x5fe4f3=0x0,_0x1151d2=0x0;for(const _0x2af521 of _0x4e1d17){try{if(_0x2c68bf[_0x547eed(0x29a)](_0x2af521['id'])){console[_0x547eed(0x2cb)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x2af521['id']+_0x547eed(0x245)),_0x1151d2++;continue;}if(this[_0x547eed(0x2be)][_0x547eed(0x208)](_0x2af521['id'])){console[_0x547eed(0x2cb)](_0x547eed(0x2d3)+_0x2af521['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x1151d2++;continue;}const _0x4f8817=(Date[_0x547eed(0x225)]()-_0x2af521[_0x547eed(0x224)][_0x547eed(0x203)]())/(0x3e8*0x3c*0x3c);if(_0x4f8817<0x1){console['log'](_0x547eed(0x2d3)+_0x2af521['id']+_0x547eed(0x233)+_0x4f8817['toFixed'](0x1)+_0x547eed(0x1f3)),_0x1151d2++;continue;}console[_0x547eed(0x2cb)](_0x547eed(0x2c6)+_0x2af521['id']+'\x20(age:\x20'+_0x4f8817[_0x547eed(0x249)](0x1)+'h)'),await this['checkSinglePayment'](_0x2af521),_0x5fe4f3++,await new Promise(_0x286977=>setTimeout(_0x286977,0x7d0));}catch(_0x3cd162){console[_0x547eed(0x287)](_0x547eed(0x24e)+_0x2af521['id']+':',_0x3cd162),this['logCoinToPayError'](_0x2af521['id'],_0x2af521['gatewayPaymentId']||_0x547eed(0x231),_0x3cd162,_0x547eed(0x1fd),{'isGlobalCheck':!![],'paymentAmount':_0x2af521[_0x547eed(0x255)],'paymentCurrency':_0x2af521[_0x547eed(0x2ac)],'shopId':_0x2af521[_0x547eed(0x200)],'createdAt':_0x2af521[_0x547eed(0x224)]}),loggerService_1[_0x547eed(0x28c)][_0x547eed(0x27f)](_0x547eed(0x270),_0x547eed(0x29f)+_0x2af521[_0x547eed(0x217)],_0x3cd162);}}console[_0x547eed(0x2cb)](_0x547eed(0x222)+_0x5fe4f3+'\x20checked,\x20'+_0x1151d2+_0x547eed(0x258)+_0x2c68bf[_0x547eed(0x267)]+_0x547eed(0x207));}catch(_0x122f25){console[_0x547eed(0x287)](_0x547eed(0x25c),_0x122f25);}}async[a37_0x53067a(0x289)](_0x3e5220){const _0x13fde4=a37_0x53067a,_0xdd5ea7=[],_0x34d277=new Date();_0x34d277['setDate'](_0x34d277['getDate']()-this[_0x13fde4(0x216)]),console['log'](_0x13fde4(0x279)+this['EXPIRY_DAYS']+'\x20days\x20(created\x20before\x20'+_0x34d277[_0x13fde4(0x2c1)]()+')');for(const _0x15e760 of _0x3e5220){if(_0x15e760['createdAt']<_0x34d277){console[_0x13fde4(0x2cb)](_0x13fde4(0x2b9)+_0x15e760['id']+_0x13fde4(0x1ee)+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x13fde4(0x209)](_0x15e760['id'],_0x15e760['gatewayPaymentId']||_0x13fde4(0x231),'PENDING',_0x13fde4(0x262),'auto_expire',{'reason':_0x13fde4(0x2cd)+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x15e760[_0x13fde4(0x224)],'daysSinceCreation':Math[_0x13fde4(0x2ce)]((Date[_0x13fde4(0x225)]()-_0x15e760[_0x13fde4(0x224)][_0x13fde4(0x203)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x15e760[_0x13fde4(0x255)],'paymentCurrency':_0x15e760['currency'],'shopId':_0x15e760[_0x13fde4(0x200)]}),await database_1[_0x13fde4(0x2a0)]['payment'][_0x13fde4(0x264)]({'where':{'id':_0x15e760['id']},'data':{'status':_0x13fde4(0x262),'updatedAt':new Date(),'adminNotes':_0x13fde4(0x2a7)+this[_0x13fde4(0x216)]+_0x13fde4(0x212)}}),await database_1['default'][_0x13fde4(0x2cc)][_0x13fde4(0x25f)]({'data':{'paymentId':_0x15e760['id'],'shopId':_0x15e760[_0x13fde4(0x200)],'event':_0x13fde4(0x1f0),'statusCode':0xc8,'responseBody':JSON[_0x13fde4(0x2a2)]({'reason':'Payment\x20older\x20than\x20'+this[_0x13fde4(0x216)]+_0x13fde4(0x252),'createdAt':_0x15e760['createdAt'],'expiredAt':new Date()[_0x13fde4(0x2c1)](),'daysSinceCreation':Math[_0x13fde4(0x2ce)]((Date[_0x13fde4(0x225)]()-_0x15e760[_0x13fde4(0x224)][_0x13fde4(0x203)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x15e760,'EXPIRED'),await this['sendPaymentStatusNotification'](_0x15e760,_0x13fde4(0x262)),this[_0x13fde4(0x22b)](_0x15e760['id']),_0xdd5ea7[_0x13fde4(0x215)](_0x15e760['id']),console[_0x13fde4(0x2cb)](_0x13fde4(0x25a)+_0x15e760['id']+_0x13fde4(0x22c)+this['EXPIRY_DAYS']+_0x13fde4(0x240));}catch(_0x775010){console[_0x13fde4(0x287)](_0x13fde4(0x221)+_0x15e760['id']+':',_0x775010),this['logCoinToPayError'](_0x15e760['id'],_0x15e760[_0x13fde4(0x217)]||_0x13fde4(0x231),_0x775010,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x15e760[_0x13fde4(0x224)],'daysSinceCreation':Math[_0x13fde4(0x2ce)]((Date[_0x13fde4(0x225)]()-_0x15e760[_0x13fde4(0x224)][_0x13fde4(0x203)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0xdd5ea7;}async[a37_0x53067a(0x211)](_0x26dc43){const _0x2b5c54=a37_0x53067a;if(!_0x26dc43[_0x2b5c54(0x217)]){console[_0x2b5c54(0x2cb)](_0x2b5c54(0x298)+_0x26dc43['id']+_0x2b5c54(0x20e));return;}console[_0x2b5c54(0x2cb)]('üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x26dc43['id']+'\x20('+_0x26dc43['gatewayPaymentId']+')');try{const _0x1864e5=await this['coinToPayService'][_0x2b5c54(0x291)](_0x26dc43[_0x2b5c54(0x217)]);console[_0x2b5c54(0x2cb)]('üìä\x20[CHECK]\x20Payment\x20'+_0x26dc43['id']+_0x2b5c54(0x20c)+_0x1864e5['status']);_0x1864e5[_0x2b5c54(0x26b)]&&console['log']('üìä\x20[CHECK]\x20Payment\x20'+_0x26dc43['id']+_0x2b5c54(0x284),{'iban':_0x1864e5[_0x2b5c54(0x26b)][_0x2b5c54(0x283)]||_0x2b5c54(0x24d),'transactionId':_0x1864e5[_0x2b5c54(0x26b)]['transactionId'],'createdOn':_0x1864e5['paymentDetails']['createdOn'],'confirmedOn':_0x1864e5['paymentDetails'][_0x2b5c54(0x248)]||'not\x20confirmed'});if(_0x1864e5[_0x2b5c54(0x244)]!==_0x26dc43[_0x2b5c54(0x244)]){console[_0x2b5c54(0x2cb)](_0x2b5c54(0x1fb)+_0x26dc43['id']+_0x2b5c54(0x27e)+_0x26dc43['status']+_0x2b5c54(0x29d)+_0x1864e5[_0x2b5c54(0x244)]),this[_0x2b5c54(0x209)](_0x26dc43['id'],_0x26dc43[_0x2b5c54(0x217)],_0x26dc43[_0x2b5c54(0x244)],_0x1864e5['status'],_0x2b5c54(0x1fd),{'paymentDetails':_0x1864e5[_0x2b5c54(0x26b)],'amount':_0x1864e5['amount'],'currency':_0x1864e5[_0x2b5c54(0x2ac)],'shopId':_0x26dc43[_0x2b5c54(0x200)],'checkTimestamp':new Date()[_0x2b5c54(0x2c1)]()});const _0x11718c={'status':_0x1864e5[_0x2b5c54(0x244)],'updatedAt':new Date()};_0x1864e5[_0x2b5c54(0x244)]==='PAID'&&_0x26dc43[_0x2b5c54(0x244)]!==_0x2b5c54(0x278)&&(_0x11718c[_0x2b5c54(0x22e)]=new Date(),console[_0x2b5c54(0x2cb)](_0x2b5c54(0x2d5)+_0x26dc43['id']+_0x2b5c54(0x2bc)+_0x11718c[_0x2b5c54(0x22e)][_0x2b5c54(0x2c1)]()));if(_0x1864e5[_0x2b5c54(0x26b)]){const _0x5c2293=_0x1864e5[_0x2b5c54(0x26b)];_0x5c2293[_0x2b5c54(0x283)]&&(_0x11718c[_0x2b5c54(0x210)]=_0x5c2293[_0x2b5c54(0x283)],console[_0x2b5c54(0x2cb)](_0x2b5c54(0x2c7)+_0x5c2293[_0x2b5c54(0x283)]));if(_0x5c2293[_0x2b5c54(0x2c9)]){const _0x202108=_0x26dc43[_0x2b5c54(0x23c)]||'',_0x2d81e5=_0x2b5c54(0x27c)+_0x5c2293['bankDetails'];_0x11718c[_0x2b5c54(0x23c)]=_0x202108?_0x202108+'\x0a\x0a'+_0x2d81e5:_0x2d81e5,console[_0x2b5c54(0x2cb)]('üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x5c2293[_0x2b5c54(0x2a4)]&&console[_0x2b5c54(0x2cb)](_0x2b5c54(0x2b0)+_0x5c2293[_0x2b5c54(0x2a4)]),_0x5c2293[_0x2b5c54(0x248)]&&console[_0x2b5c54(0x2cb)](_0x2b5c54(0x239)+_0x5c2293['confirmedOn']);}await database_1[_0x2b5c54(0x2a0)]['payment'][_0x2b5c54(0x264)]({'where':{'id':_0x26dc43['id']},'data':_0x11718c}),await database_1['default'][_0x2b5c54(0x2cc)][_0x2b5c54(0x25f)]({'data':{'paymentId':_0x26dc43['id'],'shopId':_0x26dc43[_0x2b5c54(0x200)],'event':_0x2b5c54(0x2c2)+_0x1864e5['status'][_0x2b5c54(0x20a)](),'statusCode':0xc8,'responseBody':JSON[_0x2b5c54(0x2a2)]({'oldStatus':_0x26dc43[_0x2b5c54(0x244)],'newStatus':_0x1864e5[_0x2b5c54(0x244)],'paymentDetails':_0x1864e5[_0x2b5c54(0x26b)],'checkedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x26dc43,_0x1864e5[_0x2b5c54(0x244)]),await this[_0x2b5c54(0x2ad)](_0x26dc43,_0x1864e5[_0x2b5c54(0x244)]),_0x1864e5[_0x2b5c54(0x244)]!==_0x2b5c54(0x2ab)&&(console[_0x2b5c54(0x2cb)](_0x2b5c54(0x25d)+_0x26dc43['id']+_0x2b5c54(0x27a)+_0x1864e5[_0x2b5c54(0x244)]+_0x2b5c54(0x2cf)),this['clearPaymentTimers'](_0x26dc43['id'])),console['log'](_0x2b5c54(0x259)+_0x26dc43['id']+'\x20updated\x20successfully');}else console[_0x2b5c54(0x2cb)](_0x2b5c54(0x1f4)+_0x26dc43['id']+_0x2b5c54(0x24f)+_0x1864e5[_0x2b5c54(0x244)]+')'),this[_0x2b5c54(0x209)](_0x26dc43['id'],_0x26dc43[_0x2b5c54(0x217)],_0x26dc43['status'],_0x1864e5[_0x2b5c54(0x244)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x1864e5[_0x2b5c54(0x26b)],'amount':_0x1864e5[_0x2b5c54(0x255)],'currency':_0x1864e5[_0x2b5c54(0x2ac)],'shopId':_0x26dc43[_0x2b5c54(0x200)],'checkTimestamp':new Date()[_0x2b5c54(0x2c1)]()});}catch(_0x1f5260){console['error'](_0x2b5c54(0x205)+_0x26dc43['id']+':',_0x1f5260),this['logCoinToPayError'](_0x26dc43['id'],_0x26dc43[_0x2b5c54(0x217)],_0x1f5260,_0x2b5c54(0x1fd),{'paymentAmount':_0x26dc43[_0x2b5c54(0x255)],'paymentCurrency':_0x26dc43['currency'],'shopId':_0x26dc43['shopId'],'createdAt':_0x26dc43[_0x2b5c54(0x224)]}),await database_1[_0x2b5c54(0x2a0)][_0x2b5c54(0x2cc)][_0x2b5c54(0x25f)]({'data':{'paymentId':_0x26dc43['id'],'shopId':_0x26dc43[_0x2b5c54(0x200)],'event':_0x2b5c54(0x24b),'statusCode':0x1f4,'responseBody':JSON[_0x2b5c54(0x2a2)]({'error':_0x1f5260 instanceof Error?_0x1f5260[_0x2b5c54(0x2a9)]:'Unknown\x20error','gatewayPaymentId':_0x26dc43['gatewayPaymentId'],'checkedAt':new Date()[_0x2b5c54(0x2c1)]()})}});}}async[a37_0x53067a(0x22a)](_0x3e79cf,_0x199f49){const _0x197c6b=a37_0x53067a,_0x1407ce=Date[_0x197c6b(0x225)]();try{const _0x484f0c=_0x3e79cf['shop'],_0xd26c49=_0x484f0c['settings'];if(!_0xd26c49?.['webhookUrl']){console['log'](_0x197c6b(0x201)+_0x484f0c['id']);return;}const _0x33a05f=_0x199f49===_0x197c6b(0x278)?_0x197c6b(0x28a):_0x199f49===_0x197c6b(0x297)?_0x197c6b(0x229):_0x199f49===_0x197c6b(0x262)?_0x197c6b(0x229):_0x197c6b(0x250);if(!_0xd26c49['webhookEvents']?.[_0x197c6b(0x29a)](_0x33a05f)){console[_0x197c6b(0x2cb)]('Webhook\x20event\x20'+_0x33a05f+_0x197c6b(0x28f)+_0x484f0c['id']);return;}const _0x1c93f5={'event':_0x33a05f,'payment':{'id':_0x3e79cf['id'],'order_id':_0x3e79cf[_0x197c6b(0x2c5)],'gateway_order_id':_0x3e79cf['gatewayOrderId'],'gateway':_0x197c6b(0x269),'amount':_0x3e79cf['amount'],'currency':_0x3e79cf[_0x197c6b(0x2ac)],'status':_0x199f49[_0x197c6b(0x20a)](),'customer_email':_0x3e79cf[_0x197c6b(0x2b6)],'customer_name':_0x3e79cf[_0x197c6b(0x23b)],'created_at':_0x3e79cf[_0x197c6b(0x224)],'updated_at':new Date()}},_0x240003=await fetch(_0xd26c49[_0x197c6b(0x2c4)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x197c6b(0x1f1)},'body':JSON[_0x197c6b(0x2a2)](_0x1c93f5)}),_0x10a23=Date['now']()-_0x1407ce,_0x558bb1=_0x240003['ok']?_0x197c6b(0x277):await _0x240003[_0x197c6b(0x232)]();loggerService_1[_0x197c6b(0x28c)]['logShopWebhookSent'](_0x3e79cf[_0x197c6b(0x200)],_0xd26c49[_0x197c6b(0x2c4)],_0x33a05f,_0x240003[_0x197c6b(0x244)],_0x10a23,_0x1c93f5),console[_0x197c6b(0x2cb)](_0x197c6b(0x24a)+_0xd26c49[_0x197c6b(0x2c4)]+_0x197c6b(0x202)+_0x240003['status']+'\x20('+_0x10a23+_0x197c6b(0x272));}catch(_0x24b973){console[_0x197c6b(0x287)](_0x197c6b(0x20f),_0x24b973),loggerService_1[_0x197c6b(0x28c)][_0x197c6b(0x253)](_0x3e79cf['shopId'],_0x3e79cf[_0x197c6b(0x246)]?.['settings']?.[_0x197c6b(0x2c4)]||'unknown',_0x197c6b(0x1fe),_0x24b973,{});}}async['sendPaymentStatusNotification'](_0x55c120,_0x470e48){const _0xe52626=a37_0x53067a;try{const _0x2f0a02={'PENDING':'created','PAID':_0xe52626(0x1ef),'FAILED':_0xe52626(0x228),'EXPIRED':'expired'},_0x2ce30c=_0x2f0a02[_0x470e48];if(!_0x2ce30c||_0x2ce30c===_0xe52626(0x2c3))return;await telegramBotService_1['telegramBotService'][_0xe52626(0x260)](_0x55c120[_0xe52626(0x200)],_0x55c120,_0x2ce30c);}catch(_0x694e8e){console[_0xe52626(0x287)](_0xe52626(0x1f6),_0x694e8e);}}async['checkPaymentById'](_0x45fc33){const _0x16923d=a37_0x53067a;console['log'](_0x16923d(0x206)+_0x45fc33);const _0x540eb6=await database_1['default'][_0x16923d(0x24c)][_0x16923d(0x227)]({'where':{'id':_0x45fc33},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x540eb6)throw new Error(_0x16923d(0x247));if(_0x540eb6['gateway']!==_0x16923d(0x270))throw new Error(_0x16923d(0x22d));console[_0x16923d(0x2cb)](_0x16923d(0x220)+_0x45fc33),await this[_0x16923d(0x211)](_0x540eb6),console[_0x16923d(0x2cb)]('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x45fc33);}[a37_0x53067a(0x213)](){const _0x1e2c86=a37_0x53067a,_0x5e08e9=this[_0x1e2c86(0x282)]?this[_0x1e2c86(0x2bf)]:undefined,_0x4cf2a7=Array[_0x1e2c86(0x276)](this['paymentTimers'][_0x1e2c86(0x237)]())[_0x1e2c86(0x236)](_0x367863=>({'paymentId':_0x367863[_0x1e2c86(0x238)],'gatewayPaymentId':_0x367863[_0x1e2c86(0x217)],'createdAt':_0x367863['createdAt'],'timersCount':_0x367863['timers'][_0x1e2c86(0x267)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x1e2c86(0x2bf)]/(0x3e8*0x3c),'expiryDays':this[_0x1e2c86(0x216)],'activeIndividualTimers':this['paymentTimers'][_0x1e2c86(0x2ae)],'nextGlobalCheckIn':_0x5e08e9,'paymentTimersDetails':_0x4cf2a7};}[a37_0x53067a(0x288)](_0x416fbe){const _0x55d97a=a37_0x53067a,_0x510699=this[_0x55d97a(0x2be)]['get'](_0x416fbe);if(_0x510699)return{'hasTimers':!![],'timersCount':_0x510699[_0x55d97a(0x20b)][_0x55d97a(0x267)],'createdAt':_0x510699['createdAt'],'gatewayPaymentId':_0x510699['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a37_0x53067a(0x295)]=CoinToPayStatusService,exports[a37_0x53067a(0x251)]=new CoinToPayStatusService();