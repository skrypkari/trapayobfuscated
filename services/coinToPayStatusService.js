'use strict';const a37_0x1c9109=a37_0x2832;function a37_0x2832(_0xa9da3a,_0x149a99){const _0x232494=a37_0x2324();return a37_0x2832=function(_0x2832ed,_0x16c3f2){_0x2832ed=_0x2832ed-0x8b;let _0x576d1a=_0x232494[_0x2832ed];return _0x576d1a;},a37_0x2832(_0xa9da3a,_0x149a99);}function a37_0x2324(){const _0x30b8da=['✅\x20[CHECK]\x20Payment\x20','\x20marked\x20as\x20paid\x20at:\x20','create','stringify','from','floor','COINTOPAY_ERROR','clearPaymentTimers','checkPaymentById','unknown','Automatically\x20expired\x20after\x20','forEach','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','120izzCur','\x20is\x20older\x20than\x20','values','startPeriodicStatusCheck','TesSoft\x20Payment\x20System/1.0','🪙\x20[DEBUG]\x20Creating\x20','message','\x20completed\x20for\x20payment\x20','\x20\x20\x20📝\x20Details:','transactionId','\x20\x20\x20-\x20Status:\x20','paymentDetails','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20to\x20clear','EXPIRED','cointopay_status_check_error','paid','status_check','1588612ZBrvsc','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','orderId','\x20to\x20','timestamp','💰\x20[CHECK]\x20Payment\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','34110EbhCxh','coinToPayService','\x20seconds\x20(','sendShopWebhook','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','\x20\x20\x20-\x20Amount:\x20','stack','paymentId','\x20not\x20found,\x20clearing\x20timers','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','push','\x20for\x20payment\x20','adminNotes','\x20\x20\x20-\x20Gateway:\x20','\x20status\x20is\x20','confirmedOn','cointopay','description','log','cointopay_status_check_','getServiceStats','settings','PENDING','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','19590fvxrkK','\x20expired','includes','\x20with\x20status\x20','Unknown\x20error','globalCheckInterval','shopId','\x20days,\x20marking\x20as\x20EXPIRED','5599TyczSp','webhookEvents','📊\x20[CHECK]\x20Payment\x20','\x20not\x20found\x20in\x20database','EXPIRY_DAYS','0100','gatewayPaymentId','\x20\x20\x20-\x20paymentId:\x20','failed','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Bank\x20Details:\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','toFixed','\x20(age:\x20','\x20individual\x20payment\x20timers','delay','webhookLog','GLOBAL_CHECK_INTERVAL_MS','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','Payment\x20older\x20than\x20','5\x20minutes','✅\x20[HOURLY]\x20Payment\x20','shop','\x20triggered\x20for\x20payment\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','bankDetails','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','__esModule','\x20days','gatewayOrderId','\x20timers\x20for\x20payment\x20','defineProperty','checkSinglePaymentById','✅\x20[EXPIRY]\x20Payment\x20','4856913LbVdqo','coinToPayStatusService','\x20(after\x20','default','payment','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20',',\x20clearing\x20individual\x20timers','88IYpXeY','not\x20confirmed','createdOn','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','\x20\x20\x20📝\x20Context:','created','auto_expire','createdAt','\x20days\x20(created\x20before\x20','paymentTimers','checkExpiredPayments','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','iban','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','./telegramBotService','getDate','get','Shop\x20webhook\x20sent\x20to\x20','logCoinToPayError','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','./loggerService','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20\x20\x20📅\x20Time:\x20','\x20status:\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','🛑\x20[SHUTDOWN]\x20Cleared\x20','h),\x20skipping\x20global\x20check','currency','findMany','webhookUrl','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','Payment\x20not\x20found','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','.\x20Remaining\x20active\x20timers:\x20','update','logShopWebhookError','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','map','sendPaymentStatusNotification','\x20expired\x20CoinToPay\x20payments','Webhook\x20event\x20','./gateways/coinToPayService','📊\x20[HOURLY]\x20Payment\x20','text','❌\x20[CHECK]\x20Payment\x20','catch','__importDefault','\x20current\x20status:\x20','payment.failed','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','⚠️\x20[CHECK]\x20Payment\x20','1264152XHzCjt','logWhiteDomainError','customerEmail','ms)','1\x20minute',',\x20stopping\x20individual\x20checks','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','paidAt','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','amount','timers','⏰\x20[HOURLY]\x20Payment\x20','\x20updated\x20successfully','customerName','status','logCoinToPayStatus','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','72696umcbFm','delete','toISOString','146486UEMKMx','checkAllPendingPayments','\x20\x20\x20-\x20ShopId:\x20','\x20status\x20from\x20','payment.success','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20\x20\x20📍\x20Source:\x20','logShopWebhookSent','\x20pending\x20CoinToPay\x20payments','\x20\x20\x20-\x20gatewayPaymentId:\x20','\x20initial\x20timers\x20for\x20payment\x20','Failed\x20to\x20send\x20shop\x20webhook:','\x20\x20\x20❌\x20Error:\x20','checkSinglePayment','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','size','set','⏰\x20[GLOBAL]\x20Payment\x20','PAID','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','error','\x20in\x20','gateway','length','findUnique','toLowerCase','-day\x20timeout','CoinToPayStatusService','2\x20minutes','telegramBotService','\x20checked,\x20','now','❌\x20[HOURLY]\x20Payment\x20','\x20is\x20too\x20new\x20(','expired','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','loggerService','🧹\x20[CHECK]\x20Payment\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','getTime','Success','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','14LZMLZW'];a37_0x2324=function(){return _0x30b8da;};return a37_0x2324();}(function(_0x5ad29f,_0x153a20){const _0x5c0024=a37_0x2832,_0x2aad21=_0x5ad29f();while(!![]){try{const _0x1b5c20=parseInt(_0x5c0024(0xd4))/0x1+-parseInt(_0x5c0024(0x120))/0x2+parseInt(_0x5c0024(0xd1))/0x3*(-parseInt(_0x5c0024(0x173))/0x4)+-parseInt(_0x5c0024(0x127))/0x5*(parseInt(_0x5c0024(0x10e))/0x6)+-parseInt(_0x5c0024(0x100))/0x7*(-parseInt(_0x5c0024(0xc0))/0x8)+parseInt(_0x5c0024(0x16b))/0x9+-parseInt(_0x5c0024(0x140))/0xa*(-parseInt(_0x5c0024(0x148))/0xb);if(_0x1b5c20===_0x153a20)break;else _0x2aad21['push'](_0x2aad21['shift']());}catch(_0xe3aea0){_0x2aad21['push'](_0x2aad21['shift']());}}}(a37_0x2324,0x82ba6));var __importDefault=this&&this[a37_0x1c9109(0xbb)]||function(_0x5644d4){return _0x5644d4&&_0x5644d4['__esModule']?_0x5644d4:{'default':_0x5644d4};};Object[a37_0x1c9109(0x168)](exports,a37_0x1c9109(0x164),{'value':!![]}),exports[a37_0x1c9109(0x16c)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a37_0x1c9109(0xb6)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x1c9109(0x99)),loggerService_1=require(a37_0x1c9109(0x9f));class CoinToPayStatusService{constructor(){const _0x5b1bc4=a37_0x1c9109;this[_0x5b1bc4(0x145)]=null,this[_0x5b1bc4(0x15a)]=0x3c*0x3c*0x3e8,this[_0x5b1bc4(0x14c)]=0x5,this['paymentTimers']=new Map(),this[_0x5b1bc4(0x128)]=new coinToPayService_1['CoinToPayService'](),console[_0x5b1bc4(0x13a)]('🪙\x20CoinToPayStatusService\x20initialized');}['schedulePaymentChecks'](_0x3cfa35,_0x5f34c8){const _0x3e9dc8=a37_0x1c9109;console[_0x3e9dc8(0x13a)](_0x3e9dc8(0x8c)),console[_0x3e9dc8(0x13a)](_0x3e9dc8(0x14f)+_0x3cfa35),console['log'](_0x3e9dc8(0xdd)+_0x5f34c8),this[_0x3e9dc8(0x108)](_0x3cfa35);const _0x3bf798=[],_0xce2c24=new Date(),_0xe83d1=[{'delay':0x1*0x3c*0x3e8,'description':_0x3e9dc8(0xc4)},{'delay':0x2*0x3c*0x3e8,'description':_0x3e9dc8(0xf1)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x3e9dc8(0x15d)}];console[_0x3e9dc8(0x13a)](_0x3e9dc8(0x113)+_0xe83d1['length']+_0x3e9dc8(0xde)+_0x3cfa35);let _0x4fb3f7=0x0;_0xe83d1[_0x3e9dc8(0x10c)]((_0xe9ad45,_0x2b5df9)=>{const _0x1de8d8=_0x3e9dc8;_0x4fb3f7+=_0xe9ad45[_0x1de8d8(0x158)];const _0x50ba31=setTimeout(async()=>{const _0xccbb2c=_0x1de8d8;console['log'](_0xccbb2c(0x161)+(_0x2b5df9+0x1)+_0xccbb2c(0x160)+_0x3cfa35+_0xccbb2c(0x16d)+_0xe9ad45['description']+')');try{await this[_0xccbb2c(0x169)](_0x3cfa35),console['log'](_0xccbb2c(0x154)+(_0x2b5df9+0x1)+_0xccbb2c(0x115)+_0x3cfa35);}catch(_0x13dbc1){console['error'](_0xccbb2c(0x8e)+(_0x2b5df9+0x1)+_0xccbb2c(0x133)+_0x3cfa35+':',_0x13dbc1),this[_0xccbb2c(0x9d)](_0x3cfa35,_0x5f34c8,_0x13dbc1,'status_check',{'checkNumber':_0x2b5df9+0x1,'scheduledAfter':_0xe9ad45['description'],'isIndividualCheck':!![]});}},_0x4fb3f7);_0x3bf798[_0x1de8d8(0x132)](_0x50ba31),console['log'](_0x1de8d8(0xbe)+(_0x2b5df9+0x1)+_0x1de8d8(0x133)+_0x3cfa35+_0x1de8d8(0xea)+_0x4fb3f7/0x3e8+_0x1de8d8(0x129)+_0xe9ad45[_0x1de8d8(0x139)]+')');});const _0x4ef0bf=setInterval(async()=>{const _0x3bbca6=_0x3e9dc8;console[_0x3bbca6(0x13a)](_0x3bbca6(0xe3)+_0x3cfa35);try{const _0x234487=await database_1[_0x3bbca6(0x16e)][_0x3bbca6(0x16f)]['findUnique']({'where':{'id':_0x3cfa35},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x234487){console['log'](_0x3bbca6(0xf5)+_0x3cfa35+_0x3bbca6(0x12f)),this[_0x3bbca6(0x108)](_0x3cfa35);return;}console[_0x3bbca6(0x13a)](_0x3bbca6(0xb7)+_0x3cfa35+_0x3bbca6(0xbc)+_0x234487[_0x3bbca6(0xce)]);if(_0x234487[_0x3bbca6(0xce)]!==_0x3bbca6(0x13e)){console[_0x3bbca6(0x13a)](_0x3bbca6(0x15e)+_0x3cfa35+_0x3bbca6(0x136)+_0x234487[_0x3bbca6(0xce)]+_0x3bbca6(0xc5)),this[_0x3bbca6(0x108)](_0x3cfa35);return;}const _0x30255b=Math[_0x3bbca6(0x106)]((Date['now']()-_0x234487['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x30255b>=this['EXPIRY_DAYS']){console['log'](_0x3bbca6(0xcb)+_0x3cfa35+_0x3bbca6(0x10f)+this[_0x3bbca6(0x14c)]+_0x3bbca6(0xe8)),this['clearPaymentTimers'](_0x3cfa35);return;}await this[_0x3bbca6(0x169)](_0x3cfa35),console['log'](_0x3bbca6(0xf8)+_0x3cfa35);}catch(_0x511968){console[_0x3bbca6(0xe9)](_0x3bbca6(0xa0)+_0x3cfa35+':',_0x511968),this[_0x3bbca6(0x9d)](_0x3cfa35,_0x5f34c8,_0x511968,_0x3bbca6(0x11f),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3bf798['push'](_0x4ef0bf),this['paymentTimers'][_0x3e9dc8(0xe5)](_0x3cfa35,{'timers':_0x3bf798,'paymentId':_0x3cfa35,'gatewayPaymentId':_0x5f34c8,'createdAt':_0xce2c24}),console[_0x3e9dc8(0x13a)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0xe83d1[_0x3e9dc8(0xec)]+_0x3e9dc8(0xc6)+_0x3cfa35),console[_0x3e9dc8(0x13a)]('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x3e9dc8(0x94)]['size']),this[_0x3e9dc8(0xcf)](_0x3cfa35,_0x5f34c8,'PENDING',_0x3e9dc8(0x13e),_0x3e9dc8(0x11f),{'action':'schedule_created','scheduledChecks':_0xe83d1[_0x3e9dc8(0xec)],'firstCheckIn':_0xe83d1[0x0]['delay']/0x3e8,'totalTimers':this[_0x3e9dc8(0x94)][_0x3e9dc8(0xe4)]});}[a37_0x1c9109(0x108)](_0x202c09){const _0x510e39=a37_0x1c9109,_0x19a82e=this[_0x510e39(0x94)][_0x510e39(0x9b)](_0x202c09);_0x19a82e?(console['log']('🧹\x20[DEBUG]\x20Clearing\x20'+_0x19a82e['timers'][_0x510e39(0xec)]+_0x510e39(0x167)+_0x202c09),_0x19a82e[_0x510e39(0xca)][_0x510e39(0x10c)]((_0x7be23f,_0xeeb51e)=>{const _0x43ea5d=_0x510e39;_0x7be23f&&(clearTimeout(_0x7be23f),clearInterval(_0x7be23f),console['log'](_0x43ea5d(0x98)+(_0xeeb51e+0x1)+_0x43ea5d(0x133)+_0x202c09));}),this[_0x510e39(0x94)][_0x510e39(0xd2)](_0x202c09),console[_0x510e39(0x13a)](_0x510e39(0x163)+_0x202c09+_0x510e39(0xae)+this[_0x510e39(0x94)][_0x510e39(0xe4)])):console[_0x510e39(0x13a)]('⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x202c09+_0x510e39(0x11b));}async[a37_0x1c9109(0x169)](_0x913fa7){const _0x48cfb9=a37_0x1c9109;console['log']('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x913fa7);const _0xb41cad=await database_1[_0x48cfb9(0x16e)][_0x48cfb9(0x16f)][_0x48cfb9(0xed)]({'where':{'id':_0x913fa7},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xb41cad){console[_0x48cfb9(0x13a)](_0x48cfb9(0xb9)+_0x913fa7+_0x48cfb9(0x14b));return;}console[_0x48cfb9(0x13a)](_0x48cfb9(0x14a)+_0x913fa7+'\x20found:'),console[_0x48cfb9(0x13a)](_0x48cfb9(0x135)+_0xb41cad['gateway']),console[_0x48cfb9(0x13a)](_0x48cfb9(0x118)+_0xb41cad['status']),console[_0x48cfb9(0x13a)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0xb41cad['gatewayPaymentId']),console[_0x48cfb9(0x13a)](_0x48cfb9(0x12c)+_0xb41cad['amount']+'\x20'+_0xb41cad['currency']),console[_0x48cfb9(0x13a)](_0x48cfb9(0xd6)+_0xb41cad[_0x48cfb9(0x146)]);if(_0xb41cad[_0x48cfb9(0xeb)]!==_0x48cfb9(0x138)){console[_0x48cfb9(0x13a)](_0x48cfb9(0xbf)+_0x913fa7+_0x48cfb9(0x12b)+_0xb41cad[_0x48cfb9(0xeb)]+')');return;}if(_0xb41cad[_0x48cfb9(0xce)]!==_0x48cfb9(0x13e)){console[_0x48cfb9(0x13a)](_0x48cfb9(0xbf)+_0x913fa7+_0x48cfb9(0x136)+_0xb41cad['status']+_0x48cfb9(0xc5)),this[_0x48cfb9(0x108)](_0x913fa7);return;}if(!_0xb41cad[_0x48cfb9(0x14e)]){console['log'](_0x48cfb9(0xbf)+_0x913fa7+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x48cfb9(0x13a)](_0x48cfb9(0x101)+_0x913fa7+_0x48cfb9(0xaa)),await this[_0x48cfb9(0xe1)](_0xb41cad);}['logCoinToPayStatus'](_0x49f6e2,_0x9c275,_0x54dc41,_0x409f14,_0x2f22f0,_0x39c03a){const _0x5296c3=a37_0x1c9109,_0x1686ed={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x49f6e2,'gatewayPaymentId':_0x9c275,'oldStatus':_0x54dc41,'newStatus':_0x409f14,'source':_0x2f22f0,'timestamp':new Date()[_0x5296c3(0xd3)](),'details':_0x39c03a||{}};loggerService_1[_0x5296c3(0xf9)]['logCoinToPayStatus'](_0x1686ed),console[_0x5296c3(0x13a)](_0x5296c3(0xd0)+_0x49f6e2+'\x20('+_0x9c275+')'),console[_0x5296c3(0x13a)]('\x20\x20\x20📊\x20Status:\x20'+_0x54dc41+'\x20->\x20'+_0x409f14),console[_0x5296c3(0x13a)](_0x5296c3(0xda)+_0x2f22f0),console[_0x5296c3(0x13a)](_0x5296c3(0xa1)+_0x1686ed[_0x5296c3(0x124)]),_0x39c03a&&console[_0x5296c3(0x13a)](_0x5296c3(0x116),_0x39c03a);}[a37_0x1c9109(0x9d)](_0x556b7e,_0x547a5a,_0x2295cd,_0x219a59,_0x5845df){const _0x4ef7ac=a37_0x1c9109,_0x1de423={'type':_0x4ef7ac(0x107),'paymentId':_0x556b7e,'gatewayPaymentId':_0x547a5a,'error':_0x2295cd instanceof Error?{'message':_0x2295cd[_0x4ef7ac(0x114)],'stack':_0x2295cd[_0x4ef7ac(0x12d)]}:_0x2295cd,'source':_0x219a59,'timestamp':new Date()['toISOString'](),'context':_0x5845df||{}};loggerService_1[_0x4ef7ac(0xf9)][_0x4ef7ac(0x9d)](_0x1de423),console['error'](_0x4ef7ac(0x171)+_0x556b7e+'\x20('+_0x547a5a+')'),console[_0x4ef7ac(0xe9)](_0x4ef7ac(0xe0)+(_0x2295cd instanceof Error?_0x2295cd[_0x4ef7ac(0x114)]:_0x2295cd)),console[_0x4ef7ac(0xe9)]('\x20\x20\x20📍\x20Source:\x20'+_0x219a59),console[_0x4ef7ac(0xe9)]('\x20\x20\x20📅\x20Time:\x20'+_0x1de423[_0x4ef7ac(0x124)]),_0x5845df&&console[_0x4ef7ac(0xe9)](_0x4ef7ac(0x8f),_0x5845df);}[a37_0x1c9109(0x111)](){const _0x4a8dc1=a37_0x1c9109;console['log'](_0x4a8dc1(0x9e)),this['checkAllPendingPayments']()[_0x4a8dc1(0xba)](_0x51ef84=>{const _0x170d56=_0x4a8dc1;console[_0x170d56(0xe9)](_0x170d56(0x170),_0x51ef84);}),this['globalCheckInterval']=setInterval(async()=>{const _0x2a11e0=_0x4a8dc1;try{console[_0x2a11e0(0x13a)](_0x2a11e0(0x96)),await this[_0x2a11e0(0xd5)](),console[_0x2a11e0(0x13a)](_0x2a11e0(0xd9));}catch(_0x43a479){console[_0x2a11e0(0xe9)](_0x2a11e0(0x13f),_0x43a479);}},this[_0x4a8dc1(0x15a)]),console['log'](_0x4a8dc1(0xe2));}['stopPeriodicStatusCheck'](){const _0x4bfe38=a37_0x1c9109;console[_0x4bfe38(0x13a)](_0x4bfe38(0x8d));this[_0x4bfe38(0x145)]&&(clearInterval(this[_0x4bfe38(0x145)]),this[_0x4bfe38(0x145)]=null,console[_0x4bfe38(0x13a)](_0x4bfe38(0x121)));const _0x2df618=this['paymentTimers'][_0x4bfe38(0xe4)];for(const [_0x197985]of this[_0x4bfe38(0x94)]){this['clearPaymentTimers'](_0x197985);}console[_0x4bfe38(0x13a)](_0x4bfe38(0xa4)+_0x2df618+_0x4bfe38(0x157));}async[a37_0x1c9109(0xd5)](){const _0x3c2bd0=a37_0x1c9109;try{console[_0x3c2bd0(0x13a)](_0x3c2bd0(0xc8));const _0x50d1ba=await database_1[_0x3c2bd0(0x16e)][_0x3c2bd0(0x16f)][_0x3c2bd0(0xa7)]({'where':{'gateway':'cointopay','status':_0x3c2bd0(0x13e),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x3c2bd0(0x13a)]('🪙\x20[GLOBAL]\x20Found\x20'+_0x50d1ba[_0x3c2bd0(0xec)]+_0x3c2bd0(0xdc));if(_0x50d1ba[_0x3c2bd0(0xec)]===0x0){console[_0x3c2bd0(0x13a)](_0x3c2bd0(0x10d));return;}const _0x5ac6ce=await this[_0x3c2bd0(0x95)](_0x50d1ba);console[_0x3c2bd0(0x13a)]('⏰\x20[GLOBAL]\x20Found\x20'+_0x5ac6ce[_0x3c2bd0(0xec)]+_0x3c2bd0(0xb4));let _0x33e431=0x0,_0x5b0fe3=0x0;for(const _0x3bb3f0 of _0x50d1ba){try{if(_0x5ac6ce[_0x3c2bd0(0x142)](_0x3bb3f0['id'])){console['log'](_0x3c2bd0(0xe6)+_0x3bb3f0['id']+_0x3c2bd0(0xff)),_0x5b0fe3++;continue;}if(this[_0x3c2bd0(0x94)]['has'](_0x3bb3f0['id'])){console['log']('⏰\x20[GLOBAL]\x20Payment\x20'+_0x3bb3f0['id']+_0x3c2bd0(0xfb)),_0x5b0fe3++;continue;}const _0x159b6b=(Date[_0x3c2bd0(0xf4)]()-_0x3bb3f0[_0x3c2bd0(0x92)][_0x3c2bd0(0xfd)]())/(0x3e8*0x3c*0x3c);if(_0x159b6b<0x1){console[_0x3c2bd0(0x13a)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x3bb3f0['id']+_0x3c2bd0(0xf6)+_0x159b6b[_0x3c2bd0(0x155)](0x1)+_0x3c2bd0(0xa5)),_0x5b0fe3++;continue;}console['log'](_0x3c2bd0(0x151)+_0x3bb3f0['id']+_0x3c2bd0(0x156)+_0x159b6b[_0x3c2bd0(0x155)](0x1)+'h)'),await this[_0x3c2bd0(0xe1)](_0x3bb3f0),_0x33e431++,await new Promise(_0x4b3120=>setTimeout(_0x4b3120,0x7d0));}catch(_0x306c09){console[_0x3c2bd0(0xe9)](_0x3c2bd0(0xb1)+_0x3bb3f0['id']+':',_0x306c09),this[_0x3c2bd0(0x9d)](_0x3bb3f0['id'],_0x3bb3f0[_0x3c2bd0(0x14e)]||_0x3c2bd0(0x10a),_0x306c09,_0x3c2bd0(0x11f),{'isGlobalCheck':!![],'paymentAmount':_0x3bb3f0[_0x3c2bd0(0xc9)],'paymentCurrency':_0x3bb3f0['currency'],'shopId':_0x3bb3f0[_0x3c2bd0(0x146)],'createdAt':_0x3bb3f0['createdAt']}),loggerService_1[_0x3c2bd0(0xf9)][_0x3c2bd0(0xc1)](_0x3c2bd0(0x138),'/status/'+_0x3bb3f0['gatewayPaymentId'],_0x306c09);}}console['log']('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x33e431+_0x3c2bd0(0xf3)+_0x5b0fe3+'\x20skipped,\x20'+_0x5ac6ce['length']+_0x3c2bd0(0x141));}catch(_0x205e0a){console['error'](_0x3c2bd0(0xab),_0x205e0a);}}async[a37_0x1c9109(0x95)](_0x27d12c){const _0x54ecb4=a37_0x1c9109,_0x56f05e=[],_0x31bb7e=new Date();_0x31bb7e['setDate'](_0x31bb7e[_0x54ecb4(0x9a)]()-this[_0x54ecb4(0x14c)]),console[_0x54ecb4(0x13a)](_0x54ecb4(0x126)+this['EXPIRY_DAYS']+_0x54ecb4(0x93)+_0x31bb7e['toISOString']()+')');for(const _0x1e7ab0 of _0x27d12c){if(_0x1e7ab0[_0x54ecb4(0x92)]<_0x31bb7e){console[_0x54ecb4(0x13a)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x1e7ab0['id']+_0x54ecb4(0x10f)+this[_0x54ecb4(0x14c)]+_0x54ecb4(0x147));try{this[_0x54ecb4(0xcf)](_0x1e7ab0['id'],_0x1e7ab0[_0x54ecb4(0x14e)]||_0x54ecb4(0x10a),'PENDING',_0x54ecb4(0x11c),_0x54ecb4(0x91),{'reason':_0x54ecb4(0x15c)+this[_0x54ecb4(0x14c)]+'\x20days','createdAt':_0x1e7ab0[_0x54ecb4(0x92)],'daysSinceCreation':Math[_0x54ecb4(0x106)]((Date[_0x54ecb4(0xf4)]()-_0x1e7ab0['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x1e7ab0[_0x54ecb4(0xc9)],'paymentCurrency':_0x1e7ab0[_0x54ecb4(0xa6)],'shopId':_0x1e7ab0[_0x54ecb4(0x146)]}),await database_1['default'][_0x54ecb4(0x16f)][_0x54ecb4(0xaf)]({'where':{'id':_0x1e7ab0['id']},'data':{'status':_0x54ecb4(0x11c),'updatedAt':new Date(),'adminNotes':_0x54ecb4(0x10b)+this['EXPIRY_DAYS']+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1['default'][_0x54ecb4(0x159)][_0x54ecb4(0x103)]({'data':{'paymentId':_0x1e7ab0['id'],'shopId':_0x1e7ab0[_0x54ecb4(0x146)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x54ecb4(0x104)]({'reason':_0x54ecb4(0x15c)+this['EXPIRY_DAYS']+_0x54ecb4(0x165),'createdAt':_0x1e7ab0[_0x54ecb4(0x92)],'expiredAt':new Date()[_0x54ecb4(0xd3)](),'daysSinceCreation':Math[_0x54ecb4(0x106)]((Date[_0x54ecb4(0xf4)]()-_0x1e7ab0[_0x54ecb4(0x92)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x54ecb4(0x12a)](_0x1e7ab0,_0x54ecb4(0x11c)),await this['sendPaymentStatusNotification'](_0x1e7ab0,'EXPIRED'),this['clearPaymentTimers'](_0x1e7ab0['id']),_0x56f05e['push'](_0x1e7ab0['id']),console[_0x54ecb4(0x13a)](_0x54ecb4(0x16a)+_0x1e7ab0['id']+_0x54ecb4(0x11a)+this[_0x54ecb4(0x14c)]+_0x54ecb4(0xef));}catch(_0x4ec4eb){console['error'](_0x54ecb4(0x131)+_0x1e7ab0['id']+':',_0x4ec4eb),this[_0x54ecb4(0x9d)](_0x1e7ab0['id'],_0x1e7ab0['gatewayPaymentId']||'unknown',_0x4ec4eb,_0x54ecb4(0x91),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x1e7ab0[_0x54ecb4(0x92)],'daysSinceCreation':Math['floor']((Date[_0x54ecb4(0xf4)]()-_0x1e7ab0[_0x54ecb4(0x92)][_0x54ecb4(0xfd)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x56f05e;}async['checkSinglePayment'](_0x56c882){const _0x3dbe0a=a37_0x1c9109;if(!_0x56c882['gatewayPaymentId']){console[_0x3dbe0a(0x13a)](_0x3dbe0a(0xbf)+_0x56c882['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x3dbe0a(0x13a)](_0x3dbe0a(0x15b)+_0x56c882['id']+'\x20('+_0x56c882[_0x3dbe0a(0x14e)]+')');try{const _0x4d9baf=await this[_0x3dbe0a(0x128)]['checkPaymentStatus'](_0x56c882[_0x3dbe0a(0x14e)]);console[_0x3dbe0a(0x13a)](_0x3dbe0a(0x14a)+_0x56c882['id']+_0x3dbe0a(0xa2)+_0x4d9baf[_0x3dbe0a(0xce)]);_0x4d9baf[_0x3dbe0a(0x119)]&&console[_0x3dbe0a(0x13a)](_0x3dbe0a(0x14a)+_0x56c882['id']+'\x20details:',{'iban':_0x4d9baf[_0x3dbe0a(0x119)]['iban']||'not\x20found','transactionId':_0x4d9baf[_0x3dbe0a(0x119)][_0x3dbe0a(0x117)],'createdOn':_0x4d9baf[_0x3dbe0a(0x119)][_0x3dbe0a(0x8b)],'confirmedOn':_0x4d9baf['paymentDetails'][_0x3dbe0a(0x137)]||_0x3dbe0a(0x174)});if(_0x4d9baf[_0x3dbe0a(0xce)]!==_0x56c882[_0x3dbe0a(0xce)]){console[_0x3dbe0a(0x13a)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x56c882['id']+_0x3dbe0a(0xd7)+_0x56c882[_0x3dbe0a(0xce)]+_0x3dbe0a(0x123)+_0x4d9baf[_0x3dbe0a(0xce)]),this[_0x3dbe0a(0xcf)](_0x56c882['id'],_0x56c882[_0x3dbe0a(0x14e)],_0x56c882[_0x3dbe0a(0xce)],_0x4d9baf[_0x3dbe0a(0xce)],_0x3dbe0a(0x11f),{'paymentDetails':_0x4d9baf[_0x3dbe0a(0x119)],'amount':_0x4d9baf[_0x3dbe0a(0xc9)],'currency':_0x4d9baf['currency'],'shopId':_0x56c882[_0x3dbe0a(0x146)],'checkTimestamp':new Date()[_0x3dbe0a(0xd3)]()});const _0x2ece6d={'status':_0x4d9baf['status'],'updatedAt':new Date()};_0x4d9baf['status']==='PAID'&&_0x56c882['status']!=='PAID'&&(_0x2ece6d[_0x3dbe0a(0xc7)]=new Date(),console[_0x3dbe0a(0x13a)](_0x3dbe0a(0x125)+_0x56c882['id']+_0x3dbe0a(0x102)+_0x2ece6d[_0x3dbe0a(0xc7)]['toISOString']()));if(_0x4d9baf['paymentDetails']){const _0x50bcba=_0x4d9baf[_0x3dbe0a(0x119)];_0x50bcba[_0x3dbe0a(0x97)]&&(_0x2ece6d['remitterIban']=_0x50bcba[_0x3dbe0a(0x97)],console[_0x3dbe0a(0x13a)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x50bcba[_0x3dbe0a(0x97)]));if(_0x50bcba[_0x3dbe0a(0x162)]){const _0x40c32b=_0x56c882[_0x3dbe0a(0x134)]||'',_0x235609=_0x3dbe0a(0x153)+_0x50bcba['bankDetails'];_0x2ece6d[_0x3dbe0a(0x134)]=_0x40c32b?_0x40c32b+'\x0a\x0a'+_0x235609:_0x235609,console[_0x3dbe0a(0x13a)](_0x3dbe0a(0xfc));}_0x50bcba[_0x3dbe0a(0x117)]&&console[_0x3dbe0a(0x13a)](_0x3dbe0a(0x130)+_0x50bcba[_0x3dbe0a(0x117)]),_0x50bcba[_0x3dbe0a(0x137)]&&console[_0x3dbe0a(0x13a)]('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x50bcba[_0x3dbe0a(0x137)]);}await database_1['default'][_0x3dbe0a(0x16f)][_0x3dbe0a(0xaf)]({'where':{'id':_0x56c882['id']},'data':_0x2ece6d}),await database_1[_0x3dbe0a(0x16e)]['webhookLog'][_0x3dbe0a(0x103)]({'data':{'paymentId':_0x56c882['id'],'shopId':_0x56c882[_0x3dbe0a(0x146)],'event':_0x3dbe0a(0x13b)+_0x4d9baf['status'][_0x3dbe0a(0xee)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x56c882[_0x3dbe0a(0xce)],'newStatus':_0x4d9baf['status'],'paymentDetails':_0x4d9baf['paymentDetails'],'checkedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x56c882,_0x4d9baf[_0x3dbe0a(0xce)]),await this[_0x3dbe0a(0xb3)](_0x56c882,_0x4d9baf[_0x3dbe0a(0xce)]),_0x4d9baf[_0x3dbe0a(0xce)]!==_0x3dbe0a(0x13e)&&(console[_0x3dbe0a(0x13a)](_0x3dbe0a(0xfa)+_0x56c882['id']+'\x20status\x20changed\x20to\x20'+_0x4d9baf['status']+_0x3dbe0a(0x172)),this[_0x3dbe0a(0x108)](_0x56c882['id'])),console[_0x3dbe0a(0x13a)](_0x3dbe0a(0x101)+_0x56c882['id']+_0x3dbe0a(0xcc));}else console[_0x3dbe0a(0x13a)](_0x3dbe0a(0x14a)+_0x56c882['id']+'\x20status\x20unchanged\x20('+_0x4d9baf[_0x3dbe0a(0xce)]+')'),this['logCoinToPayStatus'](_0x56c882['id'],_0x56c882[_0x3dbe0a(0x14e)],_0x56c882[_0x3dbe0a(0xce)],_0x4d9baf['status'],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x4d9baf['paymentDetails'],'amount':_0x4d9baf[_0x3dbe0a(0xc9)],'currency':_0x4d9baf['currency'],'shopId':_0x56c882[_0x3dbe0a(0x146)],'checkTimestamp':new Date()[_0x3dbe0a(0xd3)]()});}catch(_0x58ec68){console[_0x3dbe0a(0xe9)](_0x3dbe0a(0xa3)+_0x56c882['id']+':',_0x58ec68),this['logCoinToPayError'](_0x56c882['id'],_0x56c882[_0x3dbe0a(0x14e)],_0x58ec68,_0x3dbe0a(0x11f),{'paymentAmount':_0x56c882[_0x3dbe0a(0xc9)],'paymentCurrency':_0x56c882[_0x3dbe0a(0xa6)],'shopId':_0x56c882[_0x3dbe0a(0x146)],'createdAt':_0x56c882['createdAt']}),await database_1[_0x3dbe0a(0x16e)][_0x3dbe0a(0x159)]['create']({'data':{'paymentId':_0x56c882['id'],'shopId':_0x56c882[_0x3dbe0a(0x146)],'event':_0x3dbe0a(0x11d),'statusCode':0x1f4,'responseBody':JSON[_0x3dbe0a(0x104)]({'error':_0x58ec68 instanceof Error?_0x58ec68[_0x3dbe0a(0x114)]:_0x3dbe0a(0x144),'gatewayPaymentId':_0x56c882[_0x3dbe0a(0x14e)],'checkedAt':new Date()['toISOString']()})}});}}async[a37_0x1c9109(0x12a)](_0x20d869,_0xe46fea){const _0x556ef2=a37_0x1c9109,_0x1ba57b=Date[_0x556ef2(0xf4)]();try{const _0x25a808=_0x20d869[_0x556ef2(0x15f)],_0x308fb1=_0x25a808[_0x556ef2(0x13d)];if(!_0x308fb1?.[_0x556ef2(0xa8)]){console[_0x556ef2(0x13a)](_0x556ef2(0xad)+_0x25a808['id']);return;}const _0x5214c0=_0xe46fea===_0x556ef2(0xe7)?_0x556ef2(0xd8):_0xe46fea==='FAILED'?_0x556ef2(0xbd):_0xe46fea===_0x556ef2(0x11c)?_0x556ef2(0xbd):'payment.pending';if(!_0x308fb1[_0x556ef2(0x149)]?.[_0x556ef2(0x142)](_0x5214c0)){console[_0x556ef2(0x13a)](_0x556ef2(0xb5)+_0x5214c0+'\x20not\x20enabled\x20for\x20shop\x20'+_0x25a808['id']);return;}const _0x4549b5={'event':_0x5214c0,'payment':{'id':_0x20d869['id'],'order_id':_0x20d869[_0x556ef2(0x122)],'gateway_order_id':_0x20d869[_0x556ef2(0x166)],'gateway':_0x556ef2(0x14d),'amount':_0x20d869['amount'],'currency':_0x20d869[_0x556ef2(0xa6)],'status':_0xe46fea[_0x556ef2(0xee)](),'customer_email':_0x20d869[_0x556ef2(0xc2)],'customer_name':_0x20d869[_0x556ef2(0xcd)],'created_at':_0x20d869[_0x556ef2(0x92)],'updated_at':new Date()}},_0x2d0f9a=await fetch(_0x308fb1[_0x556ef2(0xa8)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x556ef2(0x112)},'body':JSON[_0x556ef2(0x104)](_0x4549b5)}),_0x3fda4e=Date[_0x556ef2(0xf4)]()-_0x1ba57b,_0x28be78=_0x2d0f9a['ok']?_0x556ef2(0xfe):await _0x2d0f9a[_0x556ef2(0xb8)]();loggerService_1['loggerService'][_0x556ef2(0xdb)](_0x20d869[_0x556ef2(0x146)],_0x308fb1['webhookUrl'],_0x5214c0,_0x2d0f9a[_0x556ef2(0xce)],_0x3fda4e,_0x4549b5),console[_0x556ef2(0x13a)](_0x556ef2(0x9c)+_0x308fb1[_0x556ef2(0xa8)]+_0x556ef2(0x143)+_0x2d0f9a[_0x556ef2(0xce)]+'\x20('+_0x3fda4e+_0x556ef2(0xc3));}catch(_0x12a111){console[_0x556ef2(0xe9)](_0x556ef2(0xdf),_0x12a111),loggerService_1['loggerService'][_0x556ef2(0xb0)](_0x20d869[_0x556ef2(0x146)],_0x20d869[_0x556ef2(0x15f)]?.['settings']?.[_0x556ef2(0xa8)]||'unknown','webhook_send',_0x12a111,{});}}async[a37_0x1c9109(0xb3)](_0x247379,_0x49ad06){const _0x510d8c=a37_0x1c9109;try{const _0x792477={'PENDING':_0x510d8c(0x90),'PAID':_0x510d8c(0x11e),'FAILED':_0x510d8c(0x150),'EXPIRED':_0x510d8c(0xf7)},_0xefe944=_0x792477[_0x49ad06];if(!_0xefe944||_0xefe944===_0x510d8c(0x90))return;await telegramBotService_1[_0x510d8c(0xf2)]['sendPaymentNotification'](_0x247379['shopId'],_0x247379,_0xefe944);}catch(_0x3f5714){console['error'](_0x510d8c(0x152),_0x3f5714);}}async[a37_0x1c9109(0x109)](_0x2d5f7a){const _0x39de7a=a37_0x1c9109;console[_0x39de7a(0x13a)](_0x39de7a(0xa9)+_0x2d5f7a);const _0x38d2e9=await database_1['default']['payment'][_0x39de7a(0xed)]({'where':{'id':_0x2d5f7a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x38d2e9)throw new Error(_0x39de7a(0xac));if(_0x38d2e9['gateway']!==_0x39de7a(0x138))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console['log']('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x2d5f7a),await this[_0x39de7a(0xe1)](_0x38d2e9),console[_0x39de7a(0x13a)]('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x2d5f7a);}[a37_0x1c9109(0x13c)](){const _0x4aee9e=a37_0x1c9109,_0x323d34=this[_0x4aee9e(0x145)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x4d1f45=Array[_0x4aee9e(0x105)](this['paymentTimers'][_0x4aee9e(0x110)]())[_0x4aee9e(0xb2)](_0x4f3b7e=>({'paymentId':_0x4f3b7e[_0x4aee9e(0x12e)],'gatewayPaymentId':_0x4f3b7e['gatewayPaymentId'],'createdAt':_0x4f3b7e[_0x4aee9e(0x92)],'timersCount':_0x4f3b7e[_0x4aee9e(0xca)][_0x4aee9e(0xec)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x4aee9e(0x15a)]/(0x3e8*0x3c),'expiryDays':this[_0x4aee9e(0x14c)],'activeIndividualTimers':this['paymentTimers']['size'],'nextGlobalCheckIn':_0x323d34,'paymentTimersDetails':_0x4d1f45};}['getPaymentTimerInfo'](_0x58c384){const _0xab93be=a37_0x1c9109,_0x4d26ef=this[_0xab93be(0x94)][_0xab93be(0x9b)](_0x58c384);if(_0x4d26ef)return{'hasTimers':!![],'timersCount':_0x4d26ef['timers'][_0xab93be(0xec)],'createdAt':_0x4d26ef[_0xab93be(0x92)],'gatewayPaymentId':_0x4d26ef['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a37_0x1c9109(0xf0)]=CoinToPayStatusService,exports[a37_0x1c9109(0x16c)]=new CoinToPayStatusService();