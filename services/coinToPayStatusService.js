'use strict';function a37_0x1beb(_0x459023,_0x3372b6){const _0x4c36e5=a37_0x4c36();return a37_0x1beb=function(_0x1bebbe,_0x331329){_0x1bebbe=_0x1bebbe-0x189;let _0x4bf93f=_0x4c36e5[_0x1bebbe];return _0x4bf93f;},a37_0x1beb(_0x459023,_0x3372b6);}const a37_0x102be3=a37_0x1beb;function a37_0x4c36(){const _0x1676b9=['\x20not\x20enabled\x20for\x20shop\x20','EXPIRED','getTime','Bank\x20Details:\x20','timers','\x20timers\x20for\x20payment\x20','checkSinglePaymentById','checkAllPendingPayments','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','getDate','getPaymentTimerInfo','CoinToPayService','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','Failed\x20to\x20send\x20shop\x20webhook:','Payment\x20older\x20than\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','currency','\x20\x20\x20📅\x20Time:\x20','\x20\x20\x20❌\x20Error:\x20','webhook_send','⏰\x20[GLOBAL]\x20Payment\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','987973vLMBst','map','\x20is\x20valid\x20for\x20checking,\x20proceeding...','ms)','findMany','\x20days','sendPaymentStatusNotification','COINTOPAY_STATUS_CHANGE','📊\x20[CHECK]\x20Payment\x20','FAILED','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20status:\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','GLOBAL_CHECK_INTERVAL_MS','\x20triggered\x20for\x20payment\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','❌\x20[HOURLY]\x20Payment\x20','length','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','gatewayPaymentId','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','PENDING','default','error','\x20with\x20status\x20','application/json','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','timestamp','log','cointopay_status_check_','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20skipped,\x20','webhookUrl','stringify','🧹\x20[DEBUG]\x20Clearing\x20','-day\x20timeout','\x20completed\x20for\x20payment\x20','logCoinToPayError','customerEmail','💰\x20[CHECK]\x20Payment\x20','customerName','1VCDuSf','\x20expired\x20CoinToPay\x20payments','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','startPeriodicStatusCheck','status','stopPeriodicStatusCheck','push','defineProperty','paid','checkExpiredPayments','logShopWebhookError','/status/','Unknown\x20error','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','1\x20minute','Failed\x20to\x20mark\x20payment\x20as\x20expired','description','transactionId','\x20days\x20without\x20payment\x20confirmation','./gateways/coinToPayService','createdOn','\x20\x20\x20📝\x20Details:','1714698pFSaqG','\x20is\x20too\x20new\x20(','\x20individual\x20payment\x20timers','confirmedOn','🧹\x20[CHECK]\x20Payment\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Payment\x20not\x20found','shopId',',\x20stopping\x20individual\x20checks','\x20details:','schedule_created','message','clearPaymentTimers','toISOString','POST','\x20not\x20found,\x20clearing\x20timers','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20marked\x20as\x20paid\x20at:\x20','settings','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','./telegramBotService','63264PPjrgV','checkSinglePayment','update','COINTOPAY_ERROR','delete','\x20to\x20','status_check','paymentId','webhookEvents','342494oiQzMQ','has','payment','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','🛑\x20[SHUTDOWN]\x20Cleared\x20','findUnique','gateway','logWhiteDomainError','Automatically\x20expired\x20after\x20','size','\x20days,\x20marking\x20as\x20EXPIRED','now','coinToPayService','⏰\x20[GLOBAL]\x20Found\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','🪙\x20[DEBUG]\x20Creating\x20','sendShopWebhook','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','toFixed','2686424CGXGPF','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','toLowerCase',',\x20clearing\x20individual\x20timers','\x20status\x20unchanged\x20(','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','EXPIRY_DAYS','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','forEach','failed','cointopay_status_check_error','⚠️\x20[CHECK]\x20Payment\x20','unknown','get','\x20(after\x20','\x20updated\x20successfully','payment.success','coinToPayStatusService','\x20\x20\x20📍\x20Source:\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','\x20\x20\x20-\x20Amount:\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','3643700LlPuNB','🔄\x20[CHECK]\x20Updating\x20payment\x20','./loggerService','payment.failed','343245YXfazh','from','\x20current\x20status:\x20','\x20expired','\x20for\x20payment\x20','__esModule','shop','\x20\x20\x20-\x20ShopId:\x20','h),\x20skipping\x20global\x20check','✅\x20[HOURLY]\x20Payment\x20','adminNotes','amount','\x20status\x20is\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','✅\x20[CHECK]\x20Payment\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','\x20\x20\x20📊\x20Status:\x20','globalCheckInterval','delay','telegramBotService','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','paymentTimers','\x20\x20\x20-\x20GatewayPaymentId:\x20','floor','paidAt','create','created','\x20initial\x20timers\x20for\x20payment\x20','⏰\x20[HOURLY]\x20Payment\x20','orderId','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20pending\x20CoinToPay\x20payments','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20\x20\x20📝\x20Context:','checkPaymentStatus','PAID','\x20\x20\x20-\x20Gateway:\x20','\x20days\x20(created\x20before\x20','loggerService','\x20has\x20no\x20gatewayPaymentId,\x20skipping','📊\x20[HOURLY]\x20Payment\x20','gatewayOrderId','2\x20minutes','🪙\x20[GLOBAL]\x20Found\x20','iban','TesSoft\x20Payment\x20System/1.0','paymentDetails','logCoinToPayStatus','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','createdAt','getServiceStats','\x20checked,\x20','__importDefault','5\x20minutes','cointopay','expired','includes','Success','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20\x20\x20-\x20Status:\x20','\x20\x20\x20-\x20paymentId:\x20','\x20status\x20from\x20','catch','webhookLog','bankDetails','not\x20confirmed','\x20->\x20','text'];a37_0x4c36=function(){return _0x1676b9;};return a37_0x4c36();}(function(_0x19bb7b,_0x5e134a){const _0x321fcb=a37_0x1beb,_0x33dd42=_0x19bb7b();while(!![]){try{const _0x117bed=parseInt(_0x321fcb(0x1cd))/0x1*(-parseInt(_0x321fcb(0x204))/0x2)+parseInt(_0x321fcb(0x232))/0x3+parseInt(_0x321fcb(0x1fb))/0x4+parseInt(_0x321fcb(0x22e))/0x5+-parseInt(_0x321fcb(0x1e3))/0x6+-parseInt(_0x321fcb(0x1a4))/0x7+parseInt(_0x321fcb(0x218))/0x8;if(_0x117bed===_0x5e134a)break;else _0x33dd42['push'](_0x33dd42['shift']());}catch(_0x4882ca){_0x33dd42['push'](_0x33dd42['shift']());}}}(a37_0x4c36,0x91a7d));var __importDefault=this&&this[a37_0x102be3(0x268)]||function(_0x548ba8){const _0x5318aa=a37_0x102be3;return _0x548ba8&&_0x548ba8[_0x5318aa(0x237)]?_0x548ba8:{'default':_0x548ba8};};Object[a37_0x102be3(0x1d4)](exports,'__esModule',{'value':!![]}),exports[a37_0x102be3(0x229)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a37_0x102be3(0x1e0)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x102be3(0x1fa)),loggerService_1=require(a37_0x102be3(0x230));class CoinToPayStatusService{constructor(){const _0x17dc4c=a37_0x102be3;this[_0x17dc4c(0x243)]=null,this[_0x17dc4c(0x1b1)]=0x3c*0x3c*0x3e8,this[_0x17dc4c(0x21e)]=0x5,this[_0x17dc4c(0x247)]=new Map(),this[_0x17dc4c(0x210)]=new coinToPayService_1[(_0x17dc4c(0x198))](),console[_0x17dc4c(0x1c0)]('🪙\x20CoinToPayStatusService\x20initialized');}['schedulePaymentChecks'](_0x5eba82,_0x23b0a0){const _0x1d66c2=a37_0x102be3;console[_0x1d66c2(0x1c0)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x1d66c2(0x1c0)](_0x1d66c2(0x270)+_0x5eba82),console[_0x1d66c2(0x1c0)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x23b0a0),this[_0x1d66c2(0x1f0)](_0x5eba82);const _0x2c389f=[],_0x5d7bfb=new Date(),_0x50c603=[{'delay':0x1*0x3c*0x3e8,'description':_0x1d66c2(0x1db)},{'delay':0x2*0x3c*0x3e8,'description':_0x1d66c2(0x25d)},{'delay':0x5*0x3c*0x3e8,'description':_0x1d66c2(0x269)},{'delay':0x5*0x3c*0x3e8,'description':_0x1d66c2(0x269)}];console[_0x1d66c2(0x1c0)](_0x1d66c2(0x214)+_0x50c603['length']+_0x1d66c2(0x24d)+_0x5eba82);let _0x4b8804=0x0;_0x50c603[_0x1d66c2(0x220)]((_0x47ed5c,_0x20da95)=>{const _0xe33248=_0x1d66c2;_0x4b8804+=_0x47ed5c[_0xe33248(0x244)];const _0x51927a=setTimeout(async()=>{const _0x3cb56d=_0xe33248;console[_0x3cb56d(0x1c0)](_0x3cb56d(0x241)+(_0x20da95+0x1)+_0x3cb56d(0x1b2)+_0x5eba82+_0x3cb56d(0x226)+_0x47ed5c['description']+')');try{await this[_0x3cb56d(0x193)](_0x5eba82),console[_0x3cb56d(0x1c0)](_0x3cb56d(0x23f)+(_0x20da95+0x1)+_0x3cb56d(0x1c8)+_0x5eba82);}catch(_0x9664d7){console['error'](_0x3cb56d(0x1cf)+(_0x20da95+0x1)+'\x20for\x20payment\x20'+_0x5eba82+':',_0x9664d7),this['logCoinToPayError'](_0x5eba82,_0x23b0a0,_0x9664d7,_0x3cb56d(0x201),{'checkNumber':_0x20da95+0x1,'scheduledAfter':_0x47ed5c[_0x3cb56d(0x1dd)],'isIndividualCheck':!![]});}},_0x4b8804);_0x2c389f[_0xe33248(0x1d3)](_0x51927a),console[_0xe33248(0x1c0)](_0xe33248(0x21f)+(_0x20da95+0x1)+'\x20for\x20payment\x20'+_0x5eba82+'\x20in\x20'+_0x4b8804/0x3e8+'\x20seconds\x20('+_0x47ed5c[_0xe33248(0x1dd)]+')');});const _0x439cd7=setInterval(async()=>{const _0x39de2d=_0x1d66c2;console[_0x39de2d(0x1c0)](_0x39de2d(0x216)+_0x5eba82);try{const _0x1d2db7=await database_1[_0x39de2d(0x1ba)][_0x39de2d(0x206)][_0x39de2d(0x209)]({'where':{'id':_0x5eba82},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x1d2db7){console[_0x39de2d(0x1c0)](_0x39de2d(0x1b4)+_0x5eba82+_0x39de2d(0x1f3)),this['clearPaymentTimers'](_0x5eba82);return;}console[_0x39de2d(0x1c0)](_0x39de2d(0x25b)+_0x5eba82+_0x39de2d(0x234)+_0x1d2db7['status']);if(_0x1d2db7['status']!=='PENDING'){console['log'](_0x39de2d(0x23b)+_0x5eba82+_0x39de2d(0x23e)+_0x1d2db7[_0x39de2d(0x1d1)]+_0x39de2d(0x1ec)),this[_0x39de2d(0x1f0)](_0x5eba82);return;}const _0x242ea8=Math[_0x39de2d(0x249)]((Date[_0x39de2d(0x20f)]()-_0x1d2db7['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x242ea8>=this['EXPIRY_DAYS']){console[_0x39de2d(0x1c0)](_0x39de2d(0x24e)+_0x5eba82+'\x20is\x20older\x20than\x20'+this[_0x39de2d(0x21e)]+_0x39de2d(0x250)),this[_0x39de2d(0x1f0)](_0x5eba82);return;}await this[_0x39de2d(0x193)](_0x5eba82),console[_0x39de2d(0x1c0)](_0x39de2d(0x1c2)+_0x5eba82);}catch(_0x3b280d){console['error'](_0x39de2d(0x264)+_0x5eba82+':',_0x3b280d),this['logCoinToPayError'](_0x5eba82,_0x23b0a0,_0x3b280d,_0x39de2d(0x201),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x2c389f['push'](_0x439cd7),this[_0x1d66c2(0x247)]['set'](_0x5eba82,{'timers':_0x2c389f,'paymentId':_0x5eba82,'gatewayPaymentId':_0x23b0a0,'createdAt':_0x5d7bfb}),console[_0x1d66c2(0x1c0)](_0x1d66c2(0x1f4)+_0x50c603['length']+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x5eba82),console[_0x1d66c2(0x1c0)]('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this['paymentTimers'][_0x1d66c2(0x20d)]),this[_0x1d66c2(0x262)](_0x5eba82,_0x23b0a0,_0x1d66c2(0x1b9),_0x1d66c2(0x1b9),_0x1d66c2(0x201),{'action':_0x1d66c2(0x1ee),'scheduledChecks':_0x50c603[_0x1d66c2(0x1b5)],'firstCheckIn':_0x50c603[0x0][_0x1d66c2(0x244)]/0x3e8,'totalTimers':this[_0x1d66c2(0x247)][_0x1d66c2(0x20d)]});}[a37_0x102be3(0x1f0)](_0x1355a4){const _0x472d93=a37_0x102be3,_0x310ac3=this[_0x472d93(0x247)][_0x472d93(0x225)](_0x1355a4);_0x310ac3?(console[_0x472d93(0x1c0)](_0x472d93(0x1c6)+_0x310ac3['timers'][_0x472d93(0x1b5)]+_0x472d93(0x192)+_0x1355a4),_0x310ac3[_0x472d93(0x191)][_0x472d93(0x220)]((_0x1cd31c,_0x2604b0)=>{const _0x4a28bd=_0x472d93;_0x1cd31c&&(clearTimeout(_0x1cd31c),clearInterval(_0x1cd31c),console[_0x4a28bd(0x1c0)](_0x4a28bd(0x213)+(_0x2604b0+0x1)+_0x4a28bd(0x236)+_0x1355a4));}),this[_0x472d93(0x247)][_0x472d93(0x1ff)](_0x1355a4),console[_0x472d93(0x1c0)](_0x472d93(0x19a)+_0x1355a4+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x472d93(0x247)][_0x472d93(0x20d)])):console[_0x472d93(0x1c0)](_0x472d93(0x21d)+_0x1355a4+'\x20to\x20clear');}async[a37_0x102be3(0x193)](_0x112c31){const _0x14dadd=a37_0x102be3;console[_0x14dadd(0x1c0)](_0x14dadd(0x22d)+_0x112c31);const _0x257531=await database_1[_0x14dadd(0x1ba)][_0x14dadd(0x206)][_0x14dadd(0x209)]({'where':{'id':_0x112c31},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x257531){console[_0x14dadd(0x1c0)]('❌\x20[CHECK]\x20Payment\x20'+_0x112c31+'\x20not\x20found\x20in\x20database');return;}console['log'](_0x14dadd(0x1ac)+_0x112c31+'\x20found:'),console['log'](_0x14dadd(0x257)+_0x257531[_0x14dadd(0x20a)]),console[_0x14dadd(0x1c0)](_0x14dadd(0x26f)+_0x257531['status']),console['log'](_0x14dadd(0x248)+_0x257531[_0x14dadd(0x1b7)]),console[_0x14dadd(0x1c0)](_0x14dadd(0x22c)+_0x257531[_0x14dadd(0x23d)]+'\x20'+_0x257531[_0x14dadd(0x19e)]),console['log'](_0x14dadd(0x239)+_0x257531[_0x14dadd(0x1eb)]);if(_0x257531[_0x14dadd(0x20a)]!=='cointopay'){console[_0x14dadd(0x1c0)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x112c31+_0x14dadd(0x263)+_0x257531[_0x14dadd(0x20a)]+')');return;}if(_0x257531['status']!==_0x14dadd(0x1b9)){console[_0x14dadd(0x1c0)](_0x14dadd(0x223)+_0x112c31+'\x20status\x20is\x20'+_0x257531['status']+',\x20stopping\x20individual\x20checks'),this[_0x14dadd(0x1f0)](_0x112c31);return;}if(!_0x257531[_0x14dadd(0x1b7)]){console[_0x14dadd(0x1c0)](_0x14dadd(0x223)+_0x112c31+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x14dadd(0x1c0)](_0x14dadd(0x240)+_0x112c31+_0x14dadd(0x1a6)),await this[_0x14dadd(0x1fc)](_0x257531);}['logCoinToPayStatus'](_0x2c495e,_0x39736a,_0x5c7b74,_0x5d0176,_0x4067d5,_0x36677c){const _0x212ec3=a37_0x102be3,_0x29671e={'type':_0x212ec3(0x1ab),'paymentId':_0x2c495e,'gatewayPaymentId':_0x39736a,'oldStatus':_0x5c7b74,'newStatus':_0x5d0176,'source':_0x4067d5,'timestamp':new Date()['toISOString'](),'details':_0x36677c||{}};loggerService_1[_0x212ec3(0x259)][_0x212ec3(0x262)](_0x29671e),console[_0x212ec3(0x1c0)](_0x212ec3(0x246)+_0x2c495e+'\x20('+_0x39736a+')'),console[_0x212ec3(0x1c0)](_0x212ec3(0x242)+_0x5c7b74+_0x212ec3(0x18b)+_0x5d0176),console[_0x212ec3(0x1c0)](_0x212ec3(0x22a)+_0x4067d5),console[_0x212ec3(0x1c0)](_0x212ec3(0x19f)+_0x29671e[_0x212ec3(0x1bf)]),_0x36677c&&console[_0x212ec3(0x1c0)](_0x212ec3(0x1e2),_0x36677c);}['logCoinToPayError'](_0x47b095,_0xc85e65,_0x300495,_0x59ff7e,_0x5e22ec){const _0x24eed9=a37_0x102be3,_0x3a65a6={'type':_0x24eed9(0x1fe),'paymentId':_0x47b095,'gatewayPaymentId':_0xc85e65,'error':_0x300495 instanceof Error?{'message':_0x300495[_0x24eed9(0x1ef)],'stack':_0x300495['stack']}:_0x300495,'source':_0x59ff7e,'timestamp':new Date()['toISOString'](),'context':_0x5e22ec||{}};loggerService_1[_0x24eed9(0x259)][_0x24eed9(0x1c9)](_0x3a65a6),console[_0x24eed9(0x1bb)](_0x24eed9(0x19d)+_0x47b095+'\x20('+_0xc85e65+')'),console[_0x24eed9(0x1bb)](_0x24eed9(0x1a0)+(_0x300495 instanceof Error?_0x300495['message']:_0x300495)),console[_0x24eed9(0x1bb)]('\x20\x20\x20📍\x20Source:\x20'+_0x59ff7e),console[_0x24eed9(0x1bb)](_0x24eed9(0x19f)+_0x3a65a6[_0x24eed9(0x1bf)]),_0x5e22ec&&console['error'](_0x24eed9(0x254),_0x5e22ec);}[a37_0x102be3(0x1d0)](){const _0x418057=a37_0x102be3;console['log'](_0x418057(0x1be)),this[_0x418057(0x194)]()[_0x418057(0x272)](_0x3b1762=>{const _0x38ad7b=_0x418057;console[_0x38ad7b(0x1bb)](_0x38ad7b(0x1b3),_0x3b1762);}),this[_0x418057(0x243)]=setInterval(async()=>{const _0x30694f=_0x418057;try{console['log'](_0x30694f(0x1b0)),await this[_0x30694f(0x194)](),console[_0x30694f(0x1c0)](_0x30694f(0x1f9));}catch(_0x5c0bc8){console[_0x30694f(0x1bb)](_0x30694f(0x1b8),_0x5c0bc8);}},this[_0x418057(0x1b1)]),console[_0x418057(0x1c0)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x102be3(0x1d2)](){const _0x5def03=a37_0x102be3;console[_0x5def03(0x1c0)](_0x5def03(0x199));this[_0x5def03(0x243)]&&(clearInterval(this[_0x5def03(0x243)]),this[_0x5def03(0x243)]=null,console[_0x5def03(0x1c0)](_0x5def03(0x1f5)));const _0xd42b5f=this[_0x5def03(0x247)][_0x5def03(0x20d)];for(const [_0x236bf5]of this[_0x5def03(0x247)]){this[_0x5def03(0x1f0)](_0x236bf5);}console[_0x5def03(0x1c0)](_0x5def03(0x208)+_0xd42b5f+_0x5def03(0x1e5));}async[a37_0x102be3(0x194)](){const _0x2172a2=a37_0x102be3;try{console[_0x2172a2(0x1c0)]('🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x1fe020=await database_1[_0x2172a2(0x1ba)][_0x2172a2(0x206)][_0x2172a2(0x1a8)]({'where':{'gateway':'cointopay','status':_0x2172a2(0x1b9),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x2172a2(0x1c0)](_0x2172a2(0x25e)+_0x1fe020['length']+_0x2172a2(0x252));if(_0x1fe020[_0x2172a2(0x1b5)]===0x0){console[_0x2172a2(0x1c0)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x2ed6d8=await this[_0x2172a2(0x1d6)](_0x1fe020);console[_0x2172a2(0x1c0)](_0x2172a2(0x211)+_0x2ed6d8[_0x2172a2(0x1b5)]+_0x2172a2(0x1ce));let _0x3003a9=0x0,_0x15814c=0x0;for(const _0x36e222 of _0x1fe020){try{if(_0x2ed6d8[_0x2172a2(0x26c)](_0x36e222['id'])){console[_0x2172a2(0x1c0)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x36e222['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x15814c++;continue;}if(this[_0x2172a2(0x247)][_0x2172a2(0x205)](_0x36e222['id'])){console['log'](_0x2172a2(0x1a2)+_0x36e222['id']+_0x2172a2(0x219)),_0x15814c++;continue;}const _0x4590d5=(Date[_0x2172a2(0x20f)]()-_0x36e222['createdAt'][_0x2172a2(0x18f)]())/(0x3e8*0x3c*0x3c);if(_0x4590d5<0x1){console[_0x2172a2(0x1c0)](_0x2172a2(0x1a2)+_0x36e222['id']+_0x2172a2(0x1e4)+_0x4590d5[_0x2172a2(0x217)](0x1)+_0x2172a2(0x23a)),_0x15814c++;continue;}console['log'](_0x2172a2(0x22b)+_0x36e222['id']+'\x20(age:\x20'+_0x4590d5[_0x2172a2(0x217)](0x1)+'h)'),await this['checkSinglePayment'](_0x36e222),_0x3003a9++,await new Promise(_0x2106ea=>setTimeout(_0x2106ea,0x7d0));}catch(_0xe03105){console[_0x2172a2(0x1bb)]('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x36e222['id']+':',_0xe03105),this[_0x2172a2(0x1c9)](_0x36e222['id'],_0x36e222['gatewayPaymentId']||_0x2172a2(0x224),_0xe03105,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x36e222[_0x2172a2(0x23d)],'paymentCurrency':_0x36e222['currency'],'shopId':_0x36e222[_0x2172a2(0x1eb)],'createdAt':_0x36e222[_0x2172a2(0x265)]}),loggerService_1[_0x2172a2(0x259)][_0x2172a2(0x20b)](_0x2172a2(0x26a),_0x2172a2(0x1d8)+_0x36e222[_0x2172a2(0x1b7)],_0xe03105);}}console[_0x2172a2(0x1c0)](_0x2172a2(0x1da)+_0x3003a9+_0x2172a2(0x267)+_0x15814c+_0x2172a2(0x1c3)+_0x2ed6d8[_0x2172a2(0x1b5)]+_0x2172a2(0x235));}catch(_0x5bceda){console[_0x2172a2(0x1bb)](_0x2172a2(0x1a3),_0x5bceda);}}async[a37_0x102be3(0x1d6)](_0x25b3ca){const _0x3523af=a37_0x102be3,_0x5ef3aa=[],_0xbd23d4=new Date();_0xbd23d4['setDate'](_0xbd23d4[_0x3523af(0x196)]()-this[_0x3523af(0x21e)]),console['log'](_0x3523af(0x1ae)+this[_0x3523af(0x21e)]+_0x3523af(0x258)+_0xbd23d4[_0x3523af(0x1f1)]()+')');for(const _0x3bfbd0 of _0x25b3ca){if(_0x3bfbd0['createdAt']<_0xbd23d4){console[_0x3523af(0x1c0)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x3bfbd0['id']+'\x20is\x20older\x20than\x20'+this[_0x3523af(0x21e)]+_0x3523af(0x20e));try{this[_0x3523af(0x262)](_0x3bfbd0['id'],_0x3bfbd0[_0x3523af(0x1b7)]||_0x3523af(0x224),_0x3523af(0x1b9),_0x3523af(0x18e),'auto_expire',{'reason':'Payment\x20older\x20than\x20'+this[_0x3523af(0x21e)]+_0x3523af(0x1a9),'createdAt':_0x3bfbd0[_0x3523af(0x265)],'daysSinceCreation':Math[_0x3523af(0x249)]((Date[_0x3523af(0x20f)]()-_0x3bfbd0[_0x3523af(0x265)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x3bfbd0[_0x3523af(0x23d)],'paymentCurrency':_0x3bfbd0[_0x3523af(0x19e)],'shopId':_0x3bfbd0['shopId']}),await database_1[_0x3523af(0x1ba)]['payment']['update']({'where':{'id':_0x3bfbd0['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x3523af(0x20c)+this[_0x3523af(0x21e)]+_0x3523af(0x1df)}}),await database_1[_0x3523af(0x1ba)][_0x3523af(0x273)]['create']({'data':{'paymentId':_0x3bfbd0['id'],'shopId':_0x3bfbd0[_0x3523af(0x1eb)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x3523af(0x1c5)]({'reason':_0x3523af(0x19c)+this[_0x3523af(0x21e)]+'\x20days','createdAt':_0x3bfbd0[_0x3523af(0x265)],'expiredAt':new Date()[_0x3523af(0x1f1)](),'daysSinceCreation':Math['floor']((Date[_0x3523af(0x20f)]()-_0x3bfbd0['createdAt'][_0x3523af(0x18f)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x3523af(0x215)](_0x3bfbd0,_0x3523af(0x18e)),await this[_0x3523af(0x1aa)](_0x3bfbd0,_0x3523af(0x18e)),this[_0x3523af(0x1f0)](_0x3bfbd0['id']),_0x5ef3aa[_0x3523af(0x1d3)](_0x3bfbd0['id']),console[_0x3523af(0x1c0)]('✅\x20[EXPIRY]\x20Payment\x20'+_0x3bfbd0['id']+_0x3523af(0x26e)+this[_0x3523af(0x21e)]+_0x3523af(0x1c7));}catch(_0x4bc56f){console[_0x3523af(0x1bb)](_0x3523af(0x195)+_0x3bfbd0['id']+':',_0x4bc56f),this[_0x3523af(0x1c9)](_0x3bfbd0['id'],_0x3bfbd0['gatewayPaymentId']||_0x3523af(0x224),_0x4bc56f,'auto_expire',{'reason':_0x3523af(0x1dc),'createdAt':_0x3bfbd0[_0x3523af(0x265)],'daysSinceCreation':Math[_0x3523af(0x249)]((Date['now']()-_0x3bfbd0[_0x3523af(0x265)][_0x3523af(0x18f)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5ef3aa;}async[a37_0x102be3(0x1fc)](_0x4e1167){const _0x2a7f65=a37_0x102be3;if(!_0x4e1167['gatewayPaymentId']){console['log'](_0x2a7f65(0x223)+_0x4e1167['id']+_0x2a7f65(0x25a));return;}console[_0x2a7f65(0x1c0)](_0x2a7f65(0x1b6)+_0x4e1167['id']+'\x20('+_0x4e1167['gatewayPaymentId']+')');try{const _0x32ba78=await this[_0x2a7f65(0x210)][_0x2a7f65(0x255)](_0x4e1167['gatewayPaymentId']);console[_0x2a7f65(0x1c0)]('📊\x20[CHECK]\x20Payment\x20'+_0x4e1167['id']+_0x2a7f65(0x1af)+_0x32ba78['status']);_0x32ba78[_0x2a7f65(0x261)]&&console[_0x2a7f65(0x1c0)]('📊\x20[CHECK]\x20Payment\x20'+_0x4e1167['id']+_0x2a7f65(0x1ed),{'iban':_0x32ba78['paymentDetails'][_0x2a7f65(0x25f)]||'not\x20found','transactionId':_0x32ba78[_0x2a7f65(0x261)][_0x2a7f65(0x1de)],'createdOn':_0x32ba78[_0x2a7f65(0x261)][_0x2a7f65(0x1e1)],'confirmedOn':_0x32ba78['paymentDetails'][_0x2a7f65(0x1e6)]||_0x2a7f65(0x18a)});if(_0x32ba78['status']!==_0x4e1167['status']){console[_0x2a7f65(0x1c0)](_0x2a7f65(0x22f)+_0x4e1167['id']+_0x2a7f65(0x271)+_0x4e1167[_0x2a7f65(0x1d1)]+_0x2a7f65(0x200)+_0x32ba78[_0x2a7f65(0x1d1)]),this['logCoinToPayStatus'](_0x4e1167['id'],_0x4e1167[_0x2a7f65(0x1b7)],_0x4e1167[_0x2a7f65(0x1d1)],_0x32ba78[_0x2a7f65(0x1d1)],_0x2a7f65(0x201),{'paymentDetails':_0x32ba78['paymentDetails'],'amount':_0x32ba78[_0x2a7f65(0x23d)],'currency':_0x32ba78[_0x2a7f65(0x19e)],'shopId':_0x4e1167[_0x2a7f65(0x1eb)],'checkTimestamp':new Date()[_0x2a7f65(0x1f1)]()});const _0x251eeb={'status':_0x32ba78[_0x2a7f65(0x1d1)],'updatedAt':new Date()};_0x32ba78[_0x2a7f65(0x1d1)]==='PAID'&&_0x4e1167['status']!=='PAID'&&(_0x251eeb[_0x2a7f65(0x24a)]=new Date(),console['log'](_0x2a7f65(0x1cb)+_0x4e1167['id']+_0x2a7f65(0x1f7)+_0x251eeb[_0x2a7f65(0x24a)][_0x2a7f65(0x1f1)]()));if(_0x32ba78[_0x2a7f65(0x261)]){const _0x4d46f1=_0x32ba78['paymentDetails'];_0x4d46f1['iban']&&(_0x251eeb['remitterIban']=_0x4d46f1[_0x2a7f65(0x25f)],console[_0x2a7f65(0x1c0)](_0x2a7f65(0x253)+_0x4d46f1[_0x2a7f65(0x25f)]));if(_0x4d46f1[_0x2a7f65(0x189)]){const _0x3a7f87=_0x4e1167[_0x2a7f65(0x23c)]||'',_0x5e48da=_0x2a7f65(0x190)+_0x4d46f1['bankDetails'];_0x251eeb['adminNotes']=_0x3a7f87?_0x3a7f87+'\x0a\x0a'+_0x5e48da:_0x5e48da,console[_0x2a7f65(0x1c0)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x4d46f1[_0x2a7f65(0x1de)]&&console[_0x2a7f65(0x1c0)]('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x4d46f1[_0x2a7f65(0x1de)]),_0x4d46f1[_0x2a7f65(0x1e6)]&&console[_0x2a7f65(0x1c0)]('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x4d46f1[_0x2a7f65(0x1e6)]);}await database_1['default']['payment'][_0x2a7f65(0x1fd)]({'where':{'id':_0x4e1167['id']},'data':_0x251eeb}),await database_1['default'][_0x2a7f65(0x273)][_0x2a7f65(0x24b)]({'data':{'paymentId':_0x4e1167['id'],'shopId':_0x4e1167[_0x2a7f65(0x1eb)],'event':_0x2a7f65(0x1c1)+_0x32ba78[_0x2a7f65(0x1d1)][_0x2a7f65(0x21a)](),'statusCode':0xc8,'responseBody':JSON[_0x2a7f65(0x1c5)]({'oldStatus':_0x4e1167['status'],'newStatus':_0x32ba78[_0x2a7f65(0x1d1)],'paymentDetails':_0x32ba78[_0x2a7f65(0x261)],'checkedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x4e1167,_0x32ba78[_0x2a7f65(0x1d1)]),await this[_0x2a7f65(0x1aa)](_0x4e1167,_0x32ba78[_0x2a7f65(0x1d1)]),_0x32ba78[_0x2a7f65(0x1d1)]!==_0x2a7f65(0x1b9)&&(console[_0x2a7f65(0x1c0)](_0x2a7f65(0x1e7)+_0x4e1167['id']+'\x20status\x20changed\x20to\x20'+_0x32ba78[_0x2a7f65(0x1d1)]+_0x2a7f65(0x21b)),this['clearPaymentTimers'](_0x4e1167['id'])),console[_0x2a7f65(0x1c0)](_0x2a7f65(0x240)+_0x4e1167['id']+_0x2a7f65(0x227));}else console[_0x2a7f65(0x1c0)]('📊\x20[CHECK]\x20Payment\x20'+_0x4e1167['id']+_0x2a7f65(0x21c)+_0x32ba78[_0x2a7f65(0x1d1)]+')'),this['logCoinToPayStatus'](_0x4e1167['id'],_0x4e1167[_0x2a7f65(0x1b7)],_0x4e1167['status'],_0x32ba78['status'],_0x2a7f65(0x201),{'statusUnchanged':!![],'paymentDetails':_0x32ba78[_0x2a7f65(0x261)],'amount':_0x32ba78['amount'],'currency':_0x32ba78[_0x2a7f65(0x19e)],'shopId':_0x4e1167[_0x2a7f65(0x1eb)],'checkTimestamp':new Date()[_0x2a7f65(0x1f1)]()});}catch(_0x4079b1){console[_0x2a7f65(0x1bb)](_0x2a7f65(0x207)+_0x4e1167['id']+':',_0x4079b1),this['logCoinToPayError'](_0x4e1167['id'],_0x4e1167[_0x2a7f65(0x1b7)],_0x4079b1,_0x2a7f65(0x201),{'paymentAmount':_0x4e1167[_0x2a7f65(0x23d)],'paymentCurrency':_0x4e1167[_0x2a7f65(0x19e)],'shopId':_0x4e1167['shopId'],'createdAt':_0x4e1167[_0x2a7f65(0x265)]}),await database_1[_0x2a7f65(0x1ba)]['webhookLog'][_0x2a7f65(0x24b)]({'data':{'paymentId':_0x4e1167['id'],'shopId':_0x4e1167[_0x2a7f65(0x1eb)],'event':_0x2a7f65(0x222),'statusCode':0x1f4,'responseBody':JSON[_0x2a7f65(0x1c5)]({'error':_0x4079b1 instanceof Error?_0x4079b1[_0x2a7f65(0x1ef)]:_0x2a7f65(0x1d9),'gatewayPaymentId':_0x4e1167['gatewayPaymentId'],'checkedAt':new Date()[_0x2a7f65(0x1f1)]()})}});}}async[a37_0x102be3(0x215)](_0x157ea7,_0x30d368){const _0x4674ac=a37_0x102be3,_0x10d58f=Date['now']();try{const _0x54df71=_0x157ea7[_0x4674ac(0x238)],_0x1e9c74=_0x54df71[_0x4674ac(0x1f8)];if(!_0x1e9c74?.[_0x4674ac(0x1c4)]){console[_0x4674ac(0x1c0)](_0x4674ac(0x1e9)+_0x54df71['id']);return;}const _0x59978c=_0x30d368===_0x4674ac(0x256)?_0x4674ac(0x228):_0x30d368===_0x4674ac(0x1ad)?'payment.failed':_0x30d368==='EXPIRED'?_0x4674ac(0x231):'payment.pending';if(!_0x1e9c74[_0x4674ac(0x203)]?.[_0x4674ac(0x26c)](_0x59978c)){console[_0x4674ac(0x1c0)]('Webhook\x20event\x20'+_0x59978c+_0x4674ac(0x18d)+_0x54df71['id']);return;}const _0x3cef7c={'event':_0x59978c,'payment':{'id':_0x157ea7['id'],'order_id':_0x157ea7[_0x4674ac(0x24f)],'gateway_order_id':_0x157ea7[_0x4674ac(0x25c)],'gateway':'0100','amount':_0x157ea7[_0x4674ac(0x23d)],'currency':_0x157ea7[_0x4674ac(0x19e)],'status':_0x30d368[_0x4674ac(0x21a)](),'customer_email':_0x157ea7[_0x4674ac(0x1ca)],'customer_name':_0x157ea7[_0x4674ac(0x1cc)],'created_at':_0x157ea7[_0x4674ac(0x265)],'updated_at':new Date()}},_0x5c9b9e=await fetch(_0x1e9c74['webhookUrl'],{'method':_0x4674ac(0x1f2),'headers':{'Content-Type':_0x4674ac(0x1bd),'User-Agent':_0x4674ac(0x260)},'body':JSON[_0x4674ac(0x1c5)](_0x3cef7c)}),_0x2be966=Date[_0x4674ac(0x20f)]()-_0x10d58f,_0x354786=_0x5c9b9e['ok']?_0x4674ac(0x26d):await _0x5c9b9e[_0x4674ac(0x18c)]();loggerService_1[_0x4674ac(0x259)]['logShopWebhookSent'](_0x157ea7[_0x4674ac(0x1eb)],_0x1e9c74[_0x4674ac(0x1c4)],_0x59978c,_0x5c9b9e[_0x4674ac(0x1d1)],_0x2be966,_0x3cef7c),console[_0x4674ac(0x1c0)]('Shop\x20webhook\x20sent\x20to\x20'+_0x1e9c74[_0x4674ac(0x1c4)]+_0x4674ac(0x1bc)+_0x5c9b9e['status']+'\x20('+_0x2be966+_0x4674ac(0x1a7));}catch(_0x399e04){console[_0x4674ac(0x1bb)](_0x4674ac(0x19b),_0x399e04),loggerService_1[_0x4674ac(0x259)][_0x4674ac(0x1d7)](_0x157ea7[_0x4674ac(0x1eb)],_0x157ea7[_0x4674ac(0x238)]?.[_0x4674ac(0x1f8)]?.[_0x4674ac(0x1c4)]||'unknown',_0x4674ac(0x1a1),_0x399e04,{});}}async[a37_0x102be3(0x1aa)](_0x696839,_0x577148){const _0x2c78fe=a37_0x102be3;try{const _0x2f1b35={'PENDING':_0x2c78fe(0x24c),'PAID':_0x2c78fe(0x1d5),'FAILED':_0x2c78fe(0x221),'EXPIRED':_0x2c78fe(0x26b)},_0x34b581=_0x2f1b35[_0x577148];if(!_0x34b581||_0x34b581==='created')return;await telegramBotService_1[_0x2c78fe(0x245)]['sendPaymentNotification'](_0x696839[_0x2c78fe(0x1eb)],_0x696839,_0x34b581);}catch(_0x4b2775){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4b2775);}}async['checkPaymentById'](_0x25ba10){const _0x26216a=a37_0x102be3;console['log'](_0x26216a(0x251)+_0x25ba10);const _0x220c39=await database_1[_0x26216a(0x1ba)][_0x26216a(0x206)][_0x26216a(0x209)]({'where':{'id':_0x25ba10},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x220c39)throw new Error(_0x26216a(0x1ea));if(_0x220c39[_0x26216a(0x20a)]!=='cointopay')throw new Error(_0x26216a(0x1e8));console[_0x26216a(0x1c0)](_0x26216a(0x1f6)+_0x25ba10),await this[_0x26216a(0x1fc)](_0x220c39),console[_0x26216a(0x1c0)](_0x26216a(0x212)+_0x25ba10);}[a37_0x102be3(0x266)](){const _0x3dc0a8=a37_0x102be3,_0x4f8b91=this[_0x3dc0a8(0x243)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x55fd3a=Array[_0x3dc0a8(0x233)](this['paymentTimers']['values']())[_0x3dc0a8(0x1a5)](_0x448be5=>({'paymentId':_0x448be5[_0x3dc0a8(0x202)],'gatewayPaymentId':_0x448be5['gatewayPaymentId'],'createdAt':_0x448be5[_0x3dc0a8(0x265)],'timersCount':_0x448be5[_0x3dc0a8(0x191)][_0x3dc0a8(0x1b5)]}));return{'isActive':!!this[_0x3dc0a8(0x243)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x3dc0a8(0x247)][_0x3dc0a8(0x20d)],'nextGlobalCheckIn':_0x4f8b91,'paymentTimersDetails':_0x55fd3a};}[a37_0x102be3(0x197)](_0x2973da){const _0x65dd07=a37_0x102be3,_0x43bde6=this[_0x65dd07(0x247)][_0x65dd07(0x225)](_0x2973da);if(_0x43bde6)return{'hasTimers':!![],'timersCount':_0x43bde6[_0x65dd07(0x191)][_0x65dd07(0x1b5)],'createdAt':_0x43bde6[_0x65dd07(0x265)],'gatewayPaymentId':_0x43bde6[_0x65dd07(0x1b7)]};return{'hasTimers':![]};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a37_0x102be3(0x229)]=new CoinToPayStatusService();