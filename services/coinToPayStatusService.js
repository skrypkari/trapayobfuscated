'use strict';const a35_0x3e17be=a35_0x1cb0;(function(_0x2410af,_0x3f0d97){const _0x2795c9=a35_0x1cb0,_0x18b6ab=_0x2410af();while(!![]){try{const _0xc8c2fe=parseInt(_0x2795c9(0x158))/0x1+-parseInt(_0x2795c9(0x164))/0x2+-parseInt(_0x2795c9(0x170))/0x3+-parseInt(_0x2795c9(0x115))/0x4+-parseInt(_0x2795c9(0x18a))/0x5+-parseInt(_0x2795c9(0x133))/0x6+-parseInt(_0x2795c9(0x187))/0x7*(-parseInt(_0x2795c9(0x14f))/0x8);if(_0xc8c2fe===_0x3f0d97)break;else _0x18b6ab['push'](_0x18b6ab['shift']());}catch(_0x322a08){_0x18b6ab['push'](_0x18b6ab['shift']());}}}(a35_0x1cdf,0xf3d4d));function a35_0x1cdf(){const _0x511343=['\x20CoinToPay\x20payments','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','📊\x20Payment\x20','cointopay_status_check_error','webhookLog','paid','⏰\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20not\x20enabled\x20for\x20shop\x20','PENDING','defineProperty','Periodic\x20CoinToPay\x20status\x20check\x20failed:','status','loggerService','gatewayOrderId','44757672EJvMXY','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20status:\x20','Webhook\x20event\x20','stringify','settings','create','sendShopWebhook','cointopay','172260DRlpHZ','TesSoft\x20Payment\x20System/1.0','log','unknown','getDate','toLowerCase','Payment\x20older\x20than\x20','✅\x20Payment\x20','payment.failed','failed','checkExpiredPayments','webhook_send','543464eYmlCs','transactionId','getTime','customerEmail','bankDetails','POST','✅\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','not\x20found','Unknown\x20error','remitterIban','text','Automatically\x20expired\x20after\x20','3627198AfcaAg','\x20status\x20unchanged\x20(','🛑\x20CoinToPay\x20status\x20checking\x20stopped','default','expired','checkPaymentStatus','Initial\x20CoinToPay\x20status\x20check\x20failed:','logShopWebhookSent','payment','./loggerService','Failed\x20to\x20send\x20shop\x20webhook:','now','getServiceStats','payment.pending','adminNotes','stopPeriodicStatusCheck','✅\x20Transaction\x20confirmed\x20on:\x20','\x20days\x20(created\x20before\x20','\x20pending\x20CoinToPay\x20payments','webhookEvents','findUnique','PAID','floor','7ukSXnV','\x20days\x20without\x20payment\x20confirmation','shopId','8349965kUaZcY','EXPIRED','customerName','cointopay_auto_expired','./gateways/coinToPayService','\x20to\x20','\x20days,\x20marking\x20as\x20EXPIRED','includes','iban','\x20days','__importDefault','checkPaymentById','createdAt','Success','paymentDetails','sendPaymentStatusNotification','paidAt','gatewayPaymentId','webhookUrl','length','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','3012448iITGiv','logWhiteDomainError','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','ms)','shop','-day\x20timeout','\x20is\x20older\x20than\x20','telegramBotService','EXPIRY_DAYS','toISOString','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','confirmedOn','message','checkAllPendingPayments','🏦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','currency','⏰\x20Found\x20','\x20expired\x20CoinToPay\x20payments','⏰\x20Payment\x20','CoinToPayService','checkInterval','logShopWebhookError','Shop\x20webhook\x20sent\x20to\x20','0100','payment.success','CoinToPayStatusService','checkSinglePayment','🔄\x20Updating\x20payment\x20','/status/','created','5185998ddemKO','coinToPayService','🪙\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20with\x20status\x20','CHECK_INTERVAL_MS','🪙\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','coinToPayStatusService','not\x20confirmed','error','🔍\x20Checking\x20CoinToPay\x20payment\x20','createdOn','push','Bank\x20Details:\x20','orderId'];a35_0x1cdf=function(){return _0x511343;};return a35_0x1cdf();}function a35_0x1cb0(_0x365ab2,_0x5b6d06){const _0x1cdf59=a35_0x1cdf();return a35_0x1cb0=function(_0x1cb0fb,_0x1bff12){_0x1cb0fb=_0x1cb0fb-0x114;let _0x3d867f=_0x1cdf59[_0x1cb0fb];return _0x3d867f;},a35_0x1cb0(_0x365ab2,_0x5b6d06);}var __importDefault=this&&this[a35_0x3e17be(0x194)]||function(_0x49070e){return _0x49070e&&_0x49070e['__esModule']?_0x49070e:{'default':_0x49070e};};Object[a35_0x3e17be(0x14a)](exports,'__esModule',{'value':!![]}),exports[a35_0x3e17be(0x139)]=exports[a35_0x3e17be(0x12e)]=void 0x0;const coinToPayService_1=require(a35_0x3e17be(0x18e)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a35_0x3e17be(0x179));class CoinToPayStatusService{constructor(){const _0x522856=a35_0x3e17be;this[_0x522856(0x129)]=null,this[_0x522856(0x137)]=0x3c*0x3c*0x3e8,this[_0x522856(0x11d)]=0x5,this['coinToPayService']=new coinToPayService_1[(_0x522856(0x128))]();}['startPeriodicStatusCheck'](){const _0x2da4ee=a35_0x3e17be;console[_0x2da4ee(0x15a)](_0x2da4ee(0x138)),this[_0x2da4ee(0x122)]()['catch'](_0x159679=>{const _0x151d18=_0x2da4ee;console['error'](_0x151d18(0x176),_0x159679);}),this[_0x2da4ee(0x129)]=setInterval(async()=>{const _0x665e00=_0x2da4ee;try{await this[_0x665e00(0x122)]();}catch(_0x1d1d57){console[_0x665e00(0x13b)](_0x665e00(0x14b),_0x1d1d57);}},this[_0x2da4ee(0x137)]),console[_0x2da4ee(0x15a)](_0x2da4ee(0x16a));}[a35_0x3e17be(0x17f)](){const _0x2adbc3=a35_0x3e17be;this[_0x2adbc3(0x129)]&&(clearInterval(this[_0x2adbc3(0x129)]),this[_0x2adbc3(0x129)]=null,console[_0x2adbc3(0x15a)](_0x2adbc3(0x172)));}async[a35_0x3e17be(0x122)](){const _0x5bfb08=a35_0x3e17be;try{const _0x463e8f=await database_1[_0x5bfb08(0x173)]['payment']['findMany']({'where':{'gateway':'cointopay','status':_0x5bfb08(0x149),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x463e8f[_0x5bfb08(0x19d)]===0x0){console[_0x5bfb08(0x15a)](_0x5bfb08(0x135));return;}console[_0x5bfb08(0x15a)]('🪙\x20Checking\x20'+_0x463e8f[_0x5bfb08(0x19d)]+_0x5bfb08(0x182));const _0x58473d=await this[_0x5bfb08(0x162)](_0x463e8f);console[_0x5bfb08(0x15a)](_0x5bfb08(0x125)+_0x58473d[_0x5bfb08(0x19d)]+_0x5bfb08(0x126));for(const _0x4d6d34 of _0x463e8f){try{if(_0x58473d[_0x5bfb08(0x191)](_0x4d6d34['id'])){console['log'](_0x5bfb08(0x127)+_0x4d6d34['id']+_0x5bfb08(0x114));continue;}await this[_0x5bfb08(0x12f)](_0x4d6d34),await new Promise(_0x14c1ef=>setTimeout(_0x14c1ef,0x7d0));}catch(_0x2ff7f3){console['error'](_0x5bfb08(0x142)+_0x4d6d34['id']+':',_0x2ff7f3),loggerService_1[_0x5bfb08(0x14d)][_0x5bfb08(0x116)](_0x5bfb08(0x157),_0x5bfb08(0x131)+_0x4d6d34[_0x5bfb08(0x19b)],_0x2ff7f3);}}console['log']('✅\x20Completed\x20checking\x20'+_0x463e8f[_0x5bfb08(0x19d)]+_0x5bfb08(0x141));}catch(_0x1f0ae0){console[_0x5bfb08(0x13b)](_0x5bfb08(0x117),_0x1f0ae0);}}async[a35_0x3e17be(0x162)](_0x1d4d38){const _0x3a7274=a35_0x3e17be,_0x1254df=[],_0x4b8f45=new Date();_0x4b8f45['setDate'](_0x4b8f45[_0x3a7274(0x15c)]()-this['EXPIRY_DAYS']),console[_0x3a7274(0x15a)](_0x3a7274(0x147)+this['EXPIRY_DAYS']+_0x3a7274(0x181)+_0x4b8f45['toISOString']()+')');for(const _0x568e19 of _0x1d4d38){if(_0x568e19[_0x3a7274(0x196)]<_0x4b8f45){console[_0x3a7274(0x15a)]('⏰\x20Payment\x20'+_0x568e19['id']+_0x3a7274(0x11b)+this[_0x3a7274(0x11d)]+_0x3a7274(0x190));try{await database_1['default'][_0x3a7274(0x178)]['update']({'where':{'id':_0x568e19['id']},'data':{'status':_0x3a7274(0x18b),'updatedAt':new Date(),'adminNotes':_0x3a7274(0x16f)+this[_0x3a7274(0x11d)]+_0x3a7274(0x188)}}),await database_1[_0x3a7274(0x173)][_0x3a7274(0x145)][_0x3a7274(0x155)]({'data':{'paymentId':_0x568e19['id'],'shopId':_0x568e19[_0x3a7274(0x189)],'event':_0x3a7274(0x18d),'statusCode':0xc8,'responseBody':JSON[_0x3a7274(0x153)]({'reason':_0x3a7274(0x15e)+this[_0x3a7274(0x11d)]+_0x3a7274(0x193),'createdAt':_0x568e19['createdAt'],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x3a7274(0x186)]((Date[_0x3a7274(0x17b)]()-_0x568e19[_0x3a7274(0x196)][_0x3a7274(0x166)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x3a7274(0x156)](_0x568e19,'EXPIRED'),await this['sendPaymentStatusNotification'](_0x568e19,_0x3a7274(0x18b)),_0x1254df[_0x3a7274(0x13e)](_0x568e19['id']),console[_0x3a7274(0x15a)]('✅\x20Payment\x20'+_0x568e19['id']+_0x3a7274(0x150)+this[_0x3a7274(0x11d)]+_0x3a7274(0x11a));}catch(_0x2958ca){console['error']('Failed\x20to\x20expire\x20payment\x20'+_0x568e19['id']+':',_0x2958ca);}}}return _0x1254df;}async['checkSinglePayment'](_0x42e3a4){const _0x38f766=a35_0x3e17be;if(!_0x42e3a4[_0x38f766(0x19b)]){console[_0x38f766(0x15a)]('⚠️\x20Payment\x20'+_0x42e3a4['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x38f766(0x15a)](_0x38f766(0x13c)+_0x42e3a4['id']+'\x20('+_0x42e3a4[_0x38f766(0x19b)]+')');try{const _0x37d832=await this[_0x38f766(0x134)][_0x38f766(0x175)](_0x42e3a4[_0x38f766(0x19b)]);console[_0x38f766(0x15a)](_0x38f766(0x143)+_0x42e3a4['id']+_0x38f766(0x151)+_0x37d832['status']);_0x37d832['paymentDetails']&&console[_0x38f766(0x15a)](_0x38f766(0x143)+_0x42e3a4['id']+'\x20details:',{'iban':_0x37d832[_0x38f766(0x198)]['iban']||_0x38f766(0x16b),'transactionId':_0x37d832[_0x38f766(0x198)][_0x38f766(0x165)],'createdOn':_0x37d832[_0x38f766(0x198)][_0x38f766(0x13d)],'confirmedOn':_0x37d832[_0x38f766(0x198)]['confirmedOn']||_0x38f766(0x13a)});if(_0x37d832[_0x38f766(0x14c)]!==_0x42e3a4['status']){console['log'](_0x38f766(0x130)+_0x42e3a4['id']+'\x20status\x20from\x20'+_0x42e3a4[_0x38f766(0x14c)]+_0x38f766(0x18f)+_0x37d832[_0x38f766(0x14c)]);const _0x3614c4={'status':_0x37d832[_0x38f766(0x14c)],'updatedAt':new Date()};_0x37d832[_0x38f766(0x14c)]===_0x38f766(0x185)&&_0x42e3a4['status']!=='PAID'&&(_0x3614c4[_0x38f766(0x19a)]=new Date(),console[_0x38f766(0x15a)]('💰\x20Payment\x20'+_0x42e3a4['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x3614c4[_0x38f766(0x19a)]['toISOString']()));if(_0x37d832[_0x38f766(0x198)]){const _0x5d0581=_0x37d832[_0x38f766(0x198)];_0x5d0581['iban']&&(_0x3614c4[_0x38f766(0x16d)]=_0x5d0581[_0x38f766(0x192)],console[_0x38f766(0x15a)]('🏦\x20Saved\x20IBAN:\x20'+_0x5d0581[_0x38f766(0x192)]));if(_0x5d0581[_0x38f766(0x168)]){const _0x9b0612=_0x42e3a4[_0x38f766(0x17e)]||'',_0x5d9c1a=_0x38f766(0x13f)+_0x5d0581[_0x38f766(0x168)];_0x3614c4[_0x38f766(0x17e)]=_0x9b0612?_0x9b0612+'\x0a\x0a'+_0x5d9c1a:_0x5d9c1a,console['log'](_0x38f766(0x123));}_0x5d0581[_0x38f766(0x165)]&&console['log']('🆔\x20Transaction\x20ID:\x20'+_0x5d0581[_0x38f766(0x165)]),_0x5d0581[_0x38f766(0x120)]&&console[_0x38f766(0x15a)](_0x38f766(0x180)+_0x5d0581[_0x38f766(0x120)]);}await database_1[_0x38f766(0x173)][_0x38f766(0x178)]['update']({'where':{'id':_0x42e3a4['id']},'data':_0x3614c4}),await database_1[_0x38f766(0x173)]['webhookLog'][_0x38f766(0x155)]({'data':{'paymentId':_0x42e3a4['id'],'shopId':_0x42e3a4[_0x38f766(0x189)],'event':'cointopay_status_check_'+_0x37d832[_0x38f766(0x14c)][_0x38f766(0x15d)](),'statusCode':0xc8,'responseBody':JSON[_0x38f766(0x153)]({'oldStatus':_0x42e3a4[_0x38f766(0x14c)],'newStatus':_0x37d832[_0x38f766(0x14c)],'paymentDetails':_0x37d832[_0x38f766(0x198)],'checkedAt':new Date()[_0x38f766(0x11e)]()})}}),await this[_0x38f766(0x156)](_0x42e3a4,_0x37d832['status']),await this[_0x38f766(0x199)](_0x42e3a4,_0x37d832[_0x38f766(0x14c)]),console[_0x38f766(0x15a)](_0x38f766(0x15f)+_0x42e3a4['id']+'\x20updated\x20successfully');}else console[_0x38f766(0x15a)](_0x38f766(0x143)+_0x42e3a4['id']+_0x38f766(0x171)+_0x37d832[_0x38f766(0x14c)]+')');}catch(_0x182b78){console['error']('Failed\x20to\x20check\x20payment\x20'+_0x42e3a4['id']+':',_0x182b78),await database_1[_0x38f766(0x173)][_0x38f766(0x145)][_0x38f766(0x155)]({'data':{'paymentId':_0x42e3a4['id'],'shopId':_0x42e3a4[_0x38f766(0x189)],'event':_0x38f766(0x144),'statusCode':0x1f4,'responseBody':JSON[_0x38f766(0x153)]({'error':_0x182b78 instanceof Error?_0x182b78[_0x38f766(0x121)]:_0x38f766(0x16c),'gatewayPaymentId':_0x42e3a4[_0x38f766(0x19b)],'checkedAt':new Date()[_0x38f766(0x11e)]()})}});}}async[a35_0x3e17be(0x156)](_0x405658,_0x51fea1){const _0x35e9ca=a35_0x3e17be,_0x42b14b=Date['now']();try{const _0x4cd441=_0x405658[_0x35e9ca(0x119)],_0x2c7222=_0x4cd441['settings'];if(!_0x2c7222?.[_0x35e9ca(0x19c)]){console[_0x35e9ca(0x15a)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x4cd441['id']);return;}const _0x51f3b9=_0x51fea1===_0x35e9ca(0x185)?_0x35e9ca(0x12d):_0x51fea1==='FAILED'?_0x35e9ca(0x160):_0x51fea1===_0x35e9ca(0x18b)?_0x35e9ca(0x160):_0x35e9ca(0x17d);if(!_0x2c7222[_0x35e9ca(0x183)]?.[_0x35e9ca(0x191)](_0x51f3b9)){console[_0x35e9ca(0x15a)](_0x35e9ca(0x152)+_0x51f3b9+_0x35e9ca(0x148)+_0x4cd441['id']);return;}const _0x13f576={'event':_0x51f3b9,'payment':{'id':_0x405658['id'],'order_id':_0x405658[_0x35e9ca(0x140)],'gateway_order_id':_0x405658[_0x35e9ca(0x14e)],'gateway':_0x35e9ca(0x12c),'amount':_0x405658['amount'],'currency':_0x405658[_0x35e9ca(0x124)],'status':_0x51fea1[_0x35e9ca(0x15d)](),'customer_email':_0x405658[_0x35e9ca(0x167)],'customer_name':_0x405658[_0x35e9ca(0x18c)],'created_at':_0x405658[_0x35e9ca(0x196)],'updated_at':new Date()}},_0x17e9ba=await fetch(_0x2c7222[_0x35e9ca(0x19c)],{'method':_0x35e9ca(0x169),'headers':{'Content-Type':'application/json','User-Agent':_0x35e9ca(0x159)},'body':JSON[_0x35e9ca(0x153)](_0x13f576)}),_0x3fc843=Date[_0x35e9ca(0x17b)]()-_0x42b14b,_0x36e196=_0x17e9ba['ok']?_0x35e9ca(0x197):await _0x17e9ba[_0x35e9ca(0x16e)]();loggerService_1['loggerService'][_0x35e9ca(0x177)](_0x405658['shopId'],_0x2c7222[_0x35e9ca(0x19c)],_0x51f3b9,_0x17e9ba[_0x35e9ca(0x14c)],_0x3fc843,_0x13f576),console[_0x35e9ca(0x15a)](_0x35e9ca(0x12b)+_0x2c7222[_0x35e9ca(0x19c)]+_0x35e9ca(0x136)+_0x17e9ba[_0x35e9ca(0x14c)]+'\x20('+_0x3fc843+_0x35e9ca(0x118));}catch(_0x1f5939){console[_0x35e9ca(0x13b)](_0x35e9ca(0x17a),_0x1f5939),loggerService_1[_0x35e9ca(0x14d)][_0x35e9ca(0x12a)](_0x405658[_0x35e9ca(0x189)],_0x405658[_0x35e9ca(0x119)]?.[_0x35e9ca(0x154)]?.[_0x35e9ca(0x19c)]||_0x35e9ca(0x15b),_0x35e9ca(0x163),_0x1f5939,{});}}async['sendPaymentStatusNotification'](_0xc86aa,_0x47b7a5){const _0x28667a=a35_0x3e17be;try{const _0x3a29c0={'PENDING':_0x28667a(0x132),'PAID':_0x28667a(0x146),'FAILED':_0x28667a(0x161),'EXPIRED':_0x28667a(0x174)},_0x5ac7ab=_0x3a29c0[_0x47b7a5];if(!_0x5ac7ab||_0x5ac7ab===_0x28667a(0x132))return;await telegramBotService_1[_0x28667a(0x11c)]['sendPaymentNotification'](_0xc86aa[_0x28667a(0x189)],_0xc86aa,_0x5ac7ab);}catch(_0x40da0a){console['error'](_0x28667a(0x11f),_0x40da0a);}}async[a35_0x3e17be(0x195)](_0x394195){const _0x19dd1f=a35_0x3e17be,_0x3e95b2=await database_1[_0x19dd1f(0x173)][_0x19dd1f(0x178)][_0x19dd1f(0x184)]({'where':{'id':_0x394195},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3e95b2)throw new Error('Payment\x20not\x20found');if(_0x3e95b2['gateway']!==_0x19dd1f(0x157))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');await this['checkSinglePayment'](_0x3e95b2);}[a35_0x3e17be(0x17c)](){const _0x406a2e=a35_0x3e17be,_0x1eb105=this['checkInterval']?this[_0x406a2e(0x137)]:undefined;return{'isActive':!!this[_0x406a2e(0x129)],'checkIntervalMinutes':this['CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x406a2e(0x11d)],'nextCheckIn':_0x1eb105};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a35_0x3e17be(0x139)]=new CoinToPayStatusService();