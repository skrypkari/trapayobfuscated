'use strict';const a35_0x712a8d=a35_0x51b1;(function(_0x35379e,_0x3864a5){const _0x4db44f=a35_0x51b1,_0x95f4e0=_0x35379e();while(!![]){try{const _0x5f3b68=parseInt(_0x4db44f(0x23e))/0x1*(parseInt(_0x4db44f(0x200))/0x2)+-parseInt(_0x4db44f(0x1f1))/0x3*(parseInt(_0x4db44f(0x236))/0x4)+parseInt(_0x4db44f(0x20d))/0x5*(parseInt(_0x4db44f(0x1b3))/0x6)+parseInt(_0x4db44f(0x233))/0x7+-parseInt(_0x4db44f(0x1e5))/0x8+-parseInt(_0x4db44f(0x24e))/0x9*(-parseInt(_0x4db44f(0x1e7))/0xa)+-parseInt(_0x4db44f(0x19e))/0xb;if(_0x5f3b68===_0x3864a5)break;else _0x95f4e0['push'](_0x95f4e0['shift']());}catch(_0x149a59){_0x95f4e0['push'](_0x95f4e0['shift']());}}}(a35_0x4753,0x4b902));var __importDefault=this&&this[a35_0x712a8d(0x1bf)]||function(_0x5d41c1){return _0x5d41c1&&_0x5d41c1['__esModule']?_0x5d41c1:{'default':_0x5d41c1};};Object['defineProperty'](exports,a35_0x712a8d(0x1b4),{'value':!![]}),exports[a35_0x712a8d(0x19f)]=exports[a35_0x712a8d(0x24b)]=void 0x0;const coinToPayService_1=require(a35_0x712a8d(0x1b2)),database_1=__importDefault(require(a35_0x712a8d(0x25d))),telegramBotService_1=require(a35_0x712a8d(0x245)),loggerService_1=require(a35_0x712a8d(0x255));class CoinToPayStatusService{constructor(){const _0x3a110d=a35_0x712a8d;this['globalCheckInterval']=null,this[_0x3a110d(0x20e)]=0x3c*0x3c*0x3e8,this[_0x3a110d(0x22b)]=0x5,this[_0x3a110d(0x1dc)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x3a110d(0x1f5))]();}[a35_0x712a8d(0x201)](_0x1a3609,_0x38f020){const _0x4e354b=a35_0x712a8d;console[_0x4e354b(0x1e1)](_0x4e354b(0x1f0)+_0x1a3609+'\x20('+_0x38f020+')'),this[_0x4e354b(0x239)](_0x1a3609);const _0x368db9=[],_0x476b4f=new Date(),_0x32c156=[{'delay':0x1*0x3c*0x3e8,'description':_0x4e354b(0x237)},{'delay':0x2*0x3c*0x3e8,'description':_0x4e354b(0x1c4)},{'delay':0x5*0x3c*0x3e8,'description':_0x4e354b(0x1e9)},{'delay':0x5*0x3c*0x3e8,'description':_0x4e354b(0x1e9)}];let _0x121f0e=0x0;_0x32c156[_0x4e354b(0x1bd)]((_0x14c045,_0x4c188e)=>{const _0x2bda1d=_0x4e354b;_0x121f0e+=_0x14c045[_0x2bda1d(0x209)];const _0x34261f=setTimeout(async()=>{const _0x36a4b5=_0x2bda1d;console[_0x36a4b5(0x1e1)](_0x36a4b5(0x21c)+(_0x4c188e+0x1)+_0x36a4b5(0x1d8)+_0x1a3609+'\x20(after\x20'+_0x14c045[_0x36a4b5(0x241)]+')');try{await this[_0x36a4b5(0x229)](_0x1a3609);}catch(_0x580449){console[_0x36a4b5(0x1fd)]('Failed\x20individual\x20check\x20#'+(_0x4c188e+0x1)+_0x36a4b5(0x1d8)+_0x1a3609+':',_0x580449),this['logCoinToPayError'](_0x1a3609,_0x38f020,_0x580449,_0x36a4b5(0x216),{'checkNumber':_0x4c188e+0x1,'scheduledAfter':_0x14c045[_0x36a4b5(0x241)],'isIndividualCheck':!![]});}},_0x121f0e);_0x368db9['push'](_0x34261f),console[_0x2bda1d(0x1e1)](_0x2bda1d(0x222)+(_0x4c188e+0x1)+_0x2bda1d(0x1d8)+_0x1a3609+_0x2bda1d(0x1b7)+_0x121f0e/0x3e8+_0x2bda1d(0x219)+_0x14c045[_0x2bda1d(0x241)]+')');});const _0x71339d=setInterval(async()=>{const _0x4ed161=_0x4e354b;console[_0x4ed161(0x1e1)]('ü™ô\x20Hourly\x20check\x20for\x20payment\x20'+_0x1a3609);try{const _0x1ec156=await database_1[_0x4ed161(0x1fb)][_0x4ed161(0x1a3)]['findUnique']({'where':{'id':_0x1a3609},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x1ec156){console[_0x4ed161(0x1e1)](_0x4ed161(0x235)+_0x1a3609+_0x4ed161(0x1ad)),this[_0x4ed161(0x239)](_0x1a3609);return;}if(_0x1ec156[_0x4ed161(0x223)]!==_0x4ed161(0x23c)){console[_0x4ed161(0x1e1)](_0x4ed161(0x235)+_0x1a3609+_0x4ed161(0x1c7)+_0x1ec156[_0x4ed161(0x223)]+_0x4ed161(0x232)),this['clearPaymentTimers'](_0x1a3609);return;}const _0x1adc15=Math[_0x4ed161(0x221)]((Date[_0x4ed161(0x203)]()-_0x1ec156['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x1adc15>=this['EXPIRY_DAYS']){console[_0x4ed161(0x1e1)]('Payment\x20'+_0x1a3609+_0x4ed161(0x25c)+this[_0x4ed161(0x22b)]+_0x4ed161(0x1b1)),this[_0x4ed161(0x239)](_0x1a3609);return;}await this[_0x4ed161(0x229)](_0x1a3609);}catch(_0x200b67){console[_0x4ed161(0x1fd)](_0x4ed161(0x1a0)+_0x1a3609+':',_0x200b67),this[_0x4ed161(0x1c1)](_0x1a3609,_0x38f020,_0x200b67,_0x4ed161(0x216),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x368db9[_0x4e354b(0x1fe)](_0x71339d),this[_0x4e354b(0x1dc)][_0x4e354b(0x1e2)](_0x1a3609,{'timers':_0x368db9,'paymentId':_0x1a3609,'gatewayPaymentId':_0x38f020,'createdAt':_0x476b4f}),console[_0x4e354b(0x1e1)](_0x4e354b(0x1ee)+_0x32c156[_0x4e354b(0x218)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x1a3609);}[a35_0x712a8d(0x239)](_0x4698ab){const _0x6c502b=a35_0x712a8d,_0x575c95=this[_0x6c502b(0x1dc)]['get'](_0x4698ab);_0x575c95&&(_0x575c95[_0x6c502b(0x1bb)]['forEach'](_0x5d02bc=>{_0x5d02bc&&(clearTimeout(_0x5d02bc),clearInterval(_0x5d02bc));}),this[_0x6c502b(0x1dc)][_0x6c502b(0x250)](_0x4698ab),console[_0x6c502b(0x1e1)](_0x6c502b(0x228)+_0x4698ab));}async[a35_0x712a8d(0x229)](_0x19d62c){const _0xc20a45=a35_0x712a8d,_0x4e2491=await database_1[_0xc20a45(0x1fb)][_0xc20a45(0x1a3)]['findUnique']({'where':{'id':_0x19d62c},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4e2491){console[_0xc20a45(0x1e1)](_0xc20a45(0x1a4)+_0x19d62c+'\x20not\x20found\x20for\x20individual\x20check');return;}if(_0x4e2491[_0xc20a45(0x1c5)]!==_0xc20a45(0x1ba)){console[_0xc20a45(0x1e1)](_0xc20a45(0x1a4)+_0x19d62c+_0xc20a45(0x1d9));return;}if(_0x4e2491[_0xc20a45(0x223)]!==_0xc20a45(0x23c)){console['log'](_0xc20a45(0x1a4)+_0x19d62c+'\x20status\x20is\x20'+_0x4e2491[_0xc20a45(0x223)]+_0xc20a45(0x232)),this[_0xc20a45(0x239)](_0x19d62c);return;}await this[_0xc20a45(0x226)](_0x4e2491);}[a35_0x712a8d(0x1f9)](_0x277a3b,_0x488714,_0x33d370,_0x25c75b,_0x3ab222,_0x2a2d89){const _0x989f15=a35_0x712a8d,_0x455e7b={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x277a3b,'gatewayPaymentId':_0x488714,'oldStatus':_0x33d370,'newStatus':_0x25c75b,'source':_0x3ab222,'timestamp':new Date()[_0x989f15(0x244)](),'details':_0x2a2d89||{}};loggerService_1['loggerService'][_0x989f15(0x1f9)](_0x455e7b),console[_0x989f15(0x1e1)]('ü™ô\x20CoinToPay\x20Status\x20Change:\x20'+_0x277a3b+'\x20('+_0x488714+')'),console['log'](_0x989f15(0x1cf)+_0x33d370+_0x989f15(0x1ab)+_0x25c75b),console['log']('\x20\x20\x20üìç\x20Source:\x20'+_0x3ab222),console[_0x989f15(0x1e1)](_0x989f15(0x1a8)+_0x455e7b['timestamp']),_0x2a2d89&&console[_0x989f15(0x1e1)](_0x989f15(0x256),_0x2a2d89);}[a35_0x712a8d(0x1c1)](_0x32c891,_0xdf16b9,_0x5912df,_0x5dc958,_0x9524ed){const _0x34ac92=a35_0x712a8d,_0x53d487={'type':_0x34ac92(0x213),'paymentId':_0x32c891,'gatewayPaymentId':_0xdf16b9,'error':_0x5912df instanceof Error?{'message':_0x5912df[_0x34ac92(0x1ed)],'stack':_0x5912df[_0x34ac92(0x217)]}:_0x5912df,'source':_0x5dc958,'timestamp':new Date()['toISOString'](),'context':_0x9524ed||{}};loggerService_1[_0x34ac92(0x1d6)][_0x34ac92(0x1c1)](_0x53d487),console['error'](_0x34ac92(0x204)+_0x32c891+'\x20('+_0xdf16b9+')'),console[_0x34ac92(0x1fd)](_0x34ac92(0x1fa)+(_0x5912df instanceof Error?_0x5912df[_0x34ac92(0x1ed)]:_0x5912df)),console[_0x34ac92(0x1fd)](_0x34ac92(0x215)+_0x5dc958),console['error'](_0x34ac92(0x1a8)+_0x53d487[_0x34ac92(0x202)]),_0x9524ed&&console['error'](_0x34ac92(0x1e0),_0x9524ed);}[a35_0x712a8d(0x20c)](){const _0x148159=a35_0x712a8d;console[_0x148159(0x1e1)](_0x148159(0x21b)),this['checkAllPendingPayments']()[_0x148159(0x224)](_0x35666e=>{const _0xd7b3ed=_0x148159;console[_0xd7b3ed(0x1fd)](_0xd7b3ed(0x1ac),_0x35666e);}),this[_0x148159(0x1f4)]=setInterval(async()=>{const _0x38db99=_0x148159;try{await this[_0x38db99(0x261)]();}catch(_0x31c63d){console[_0x38db99(0x1fd)](_0x38db99(0x1df),_0x31c63d);}},this[_0x148159(0x20e)]),console[_0x148159(0x1e1)]('‚úÖ\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a35_0x712a8d(0x21d)](){const _0x5f4ec9=a35_0x712a8d;this[_0x5f4ec9(0x1f4)]&&(clearInterval(this['globalCheckInterval']),this[_0x5f4ec9(0x1f4)]=null,console['log'](_0x5f4ec9(0x246)));for(const [_0x3d1f33]of this[_0x5f4ec9(0x1dc)]){this[_0x5f4ec9(0x239)](_0x3d1f33);}console['log']('üõë\x20All\x20CoinToPay\x20individual\x20payment\x20timers\x20cleared');}async[a35_0x712a8d(0x261)](){const _0x4ba4f2=a35_0x712a8d;try{const _0x39e088=await database_1[_0x4ba4f2(0x1fb)][_0x4ba4f2(0x1a3)]['findMany']({'where':{'gateway':'cointopay','status':_0x4ba4f2(0x23c),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x39e088[_0x4ba4f2(0x218)]===0x0){console['log'](_0x4ba4f2(0x207));return;}console['log']('ü™ô\x20Global\x20check:\x20found\x20'+_0x39e088[_0x4ba4f2(0x218)]+_0x4ba4f2(0x1d1));const _0x1a6621=await this[_0x4ba4f2(0x1d5)](_0x39e088);console[_0x4ba4f2(0x1e1)]('‚è∞\x20Found\x20'+_0x1a6621[_0x4ba4f2(0x218)]+_0x4ba4f2(0x24c));for(const _0x19f6de of _0x39e088){try{if(_0x1a6621['includes'](_0x19f6de['id'])){console['log']('‚è∞\x20Payment\x20'+_0x19f6de['id']+_0x4ba4f2(0x1c0));continue;}if(this[_0x4ba4f2(0x1dc)][_0x4ba4f2(0x1da)](_0x19f6de['id'])){console[_0x4ba4f2(0x1e1)]('‚è∞\x20Payment\x20'+_0x19f6de['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check');continue;}const _0x35cda8=(Date[_0x4ba4f2(0x203)]()-_0x19f6de[_0x4ba4f2(0x20a)][_0x4ba4f2(0x1d2)]())/(0x3e8*0x3c*0x3c);if(_0x35cda8<0x1){console['log'](_0x4ba4f2(0x249)+_0x19f6de['id']+'\x20is\x20too\x20new\x20('+_0x35cda8[_0x4ba4f2(0x259)](0x1)+'h),\x20skipping\x20global\x20check');continue;}console[_0x4ba4f2(0x1e1)](_0x4ba4f2(0x1de)+_0x19f6de['id']+_0x4ba4f2(0x214)+_0x35cda8[_0x4ba4f2(0x259)](0x1)+'h)'),await this[_0x4ba4f2(0x226)](_0x19f6de),await new Promise(_0x2a8806=>setTimeout(_0x2a8806,0x7d0));}catch(_0x43ce35){console[_0x4ba4f2(0x1fd)](_0x4ba4f2(0x243)+_0x19f6de['id']+_0x4ba4f2(0x1bc),_0x43ce35),this[_0x4ba4f2(0x1c1)](_0x19f6de['id'],_0x19f6de[_0x4ba4f2(0x1f2)]||_0x4ba4f2(0x1d0),_0x43ce35,_0x4ba4f2(0x216),{'isGlobalCheck':!![],'paymentAmount':_0x19f6de[_0x4ba4f2(0x1ff)],'paymentCurrency':_0x19f6de[_0x4ba4f2(0x1cd)],'shopId':_0x19f6de[_0x4ba4f2(0x20f)],'createdAt':_0x19f6de[_0x4ba4f2(0x20a)]}),loggerService_1[_0x4ba4f2(0x1d6)][_0x4ba4f2(0x22e)]('cointopay','/status/'+_0x19f6de[_0x4ba4f2(0x1f2)],_0x43ce35);}}console[_0x4ba4f2(0x1e1)](_0x4ba4f2(0x22f));}catch(_0x4a0ee2){console[_0x4ba4f2(0x1fd)]('Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x4a0ee2);}}async[a35_0x712a8d(0x1d5)](_0x5a2982){const _0x50cb41=a35_0x712a8d,_0x3ef16f=[],_0x2feff7=new Date();_0x2feff7[_0x50cb41(0x1af)](_0x2feff7[_0x50cb41(0x247)]()-this[_0x50cb41(0x22b)]),console[_0x50cb41(0x1e1)](_0x50cb41(0x22c)+this[_0x50cb41(0x22b)]+_0x50cb41(0x19b)+_0x2feff7['toISOString']()+')');for(const _0x42437d of _0x5a2982){if(_0x42437d[_0x50cb41(0x20a)]<_0x2feff7){console[_0x50cb41(0x1e1)](_0x50cb41(0x249)+_0x42437d['id']+_0x50cb41(0x25c)+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{this['logCoinToPayStatus'](_0x42437d['id'],_0x42437d['gatewayPaymentId']||_0x50cb41(0x1d0),_0x50cb41(0x23c),'EXPIRED',_0x50cb41(0x1f6),{'reason':'Payment\x20older\x20than\x20'+this[_0x50cb41(0x22b)]+_0x50cb41(0x1c6),'createdAt':_0x42437d[_0x50cb41(0x20a)],'daysSinceCreation':Math[_0x50cb41(0x221)]((Date[_0x50cb41(0x203)]()-_0x42437d[_0x50cb41(0x20a)][_0x50cb41(0x1d2)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x42437d['amount'],'paymentCurrency':_0x42437d[_0x50cb41(0x1cd)],'shopId':_0x42437d['shopId']}),await database_1[_0x50cb41(0x1fb)]['payment'][_0x50cb41(0x1db)]({'where':{'id':_0x42437d['id']},'data':{'status':_0x50cb41(0x1a1),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x50cb41(0x22b)]+_0x50cb41(0x260)}}),await database_1[_0x50cb41(0x1fb)]['webhookLog']['create']({'data':{'paymentId':_0x42437d['id'],'shopId':_0x42437d[_0x50cb41(0x20f)],'event':_0x50cb41(0x23a),'statusCode':0xc8,'responseBody':JSON[_0x50cb41(0x1b6)]({'reason':_0x50cb41(0x20b)+this['EXPIRY_DAYS']+_0x50cb41(0x1c6),'createdAt':_0x42437d['createdAt'],'expiredAt':new Date()[_0x50cb41(0x244)](),'daysSinceCreation':Math[_0x50cb41(0x221)]((Date[_0x50cb41(0x203)]()-_0x42437d[_0x50cb41(0x20a)][_0x50cb41(0x1d2)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x50cb41(0x1be)](_0x42437d,_0x50cb41(0x1a1)),await this[_0x50cb41(0x253)](_0x42437d,_0x50cb41(0x1a1)),this['clearPaymentTimers'](_0x42437d['id']),_0x3ef16f['push'](_0x42437d['id']),console[_0x50cb41(0x1e1)](_0x50cb41(0x25e)+_0x42437d['id']+_0x50cb41(0x210)+this[_0x50cb41(0x22b)]+_0x50cb41(0x212));}catch(_0x3dbaff){console[_0x50cb41(0x1fd)]('Failed\x20to\x20expire\x20payment\x20'+_0x42437d['id']+':',_0x3dbaff),this[_0x50cb41(0x1c1)](_0x42437d['id'],_0x42437d[_0x50cb41(0x1f2)]||_0x50cb41(0x1d0),_0x3dbaff,'auto_expire',{'reason':_0x50cb41(0x257),'createdAt':_0x42437d[_0x50cb41(0x20a)],'daysSinceCreation':Math[_0x50cb41(0x221)]((Date[_0x50cb41(0x203)]()-_0x42437d[_0x50cb41(0x20a)][_0x50cb41(0x1d2)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x3ef16f;}async[a35_0x712a8d(0x226)](_0x122f27){const _0x2d21c9=a35_0x712a8d;if(!_0x122f27[_0x2d21c9(0x1f2)]){console['log'](_0x2d21c9(0x1a4)+_0x122f27['id']+_0x2d21c9(0x23d));return;}console[_0x2d21c9(0x1e1)](_0x2d21c9(0x258)+_0x122f27['id']+'\x20('+_0x122f27[_0x2d21c9(0x1f2)]+')');try{const _0x421100=await this[_0x2d21c9(0x1a6)][_0x2d21c9(0x21e)](_0x122f27[_0x2d21c9(0x1f2)]);console[_0x2d21c9(0x1e1)]('üìä\x20Payment\x20'+_0x122f27['id']+'\x20status:\x20'+_0x421100['status']);_0x421100[_0x2d21c9(0x1a5)]&&console['log'](_0x2d21c9(0x21f)+_0x122f27['id']+_0x2d21c9(0x1f3),{'iban':_0x421100[_0x2d21c9(0x1a5)]['iban']||_0x2d21c9(0x1cb),'transactionId':_0x421100[_0x2d21c9(0x1a5)][_0x2d21c9(0x1ce)],'createdOn':_0x421100[_0x2d21c9(0x1a5)][_0x2d21c9(0x22a)],'confirmedOn':_0x421100[_0x2d21c9(0x1a5)][_0x2d21c9(0x230)]||_0x2d21c9(0x220)});if(_0x421100['status']!==_0x122f27['status']){console[_0x2d21c9(0x1e1)](_0x2d21c9(0x1eb)+_0x122f27['id']+_0x2d21c9(0x19d)+_0x122f27[_0x2d21c9(0x223)]+_0x2d21c9(0x1f7)+_0x421100[_0x2d21c9(0x223)]),this[_0x2d21c9(0x1f9)](_0x122f27['id'],_0x122f27[_0x2d21c9(0x1f2)],_0x122f27[_0x2d21c9(0x223)],_0x421100[_0x2d21c9(0x223)],_0x2d21c9(0x216),{'paymentDetails':_0x421100[_0x2d21c9(0x1a5)],'amount':_0x421100['amount'],'currency':_0x421100['currency'],'shopId':_0x122f27[_0x2d21c9(0x20f)],'checkTimestamp':new Date()['toISOString']()});const _0x26c115={'status':_0x421100['status'],'updatedAt':new Date()};_0x421100[_0x2d21c9(0x223)]===_0x2d21c9(0x242)&&_0x122f27[_0x2d21c9(0x223)]!==_0x2d21c9(0x242)&&(_0x26c115[_0x2d21c9(0x240)]=new Date(),console[_0x2d21c9(0x1e1)](_0x2d21c9(0x238)+_0x122f27['id']+_0x2d21c9(0x1cc)+_0x26c115['paidAt']['toISOString']()));if(_0x421100[_0x2d21c9(0x1a5)]){const _0x28c589=_0x421100[_0x2d21c9(0x1a5)];_0x28c589[_0x2d21c9(0x24a)]&&(_0x26c115['remitterIban']=_0x28c589['iban'],console[_0x2d21c9(0x1e1)]('üè¶\x20Saved\x20IBAN:\x20'+_0x28c589['iban']));if(_0x28c589[_0x2d21c9(0x1c8)]){const _0x3205ad=_0x122f27[_0x2d21c9(0x23b)]||'',_0x1225da=_0x2d21c9(0x1d3)+_0x28c589[_0x2d21c9(0x1c8)];_0x26c115[_0x2d21c9(0x23b)]=_0x3205ad?_0x3205ad+'\x0a\x0a'+_0x1225da:_0x1225da,console[_0x2d21c9(0x1e1)](_0x2d21c9(0x1b0));}_0x28c589['transactionId']&&console['log'](_0x2d21c9(0x1a7)+_0x28c589['transactionId']),_0x28c589['confirmedOn']&&console[_0x2d21c9(0x1e1)](_0x2d21c9(0x1aa)+_0x28c589[_0x2d21c9(0x230)]);}await database_1[_0x2d21c9(0x1fb)][_0x2d21c9(0x1a3)][_0x2d21c9(0x1db)]({'where':{'id':_0x122f27['id']},'data':_0x26c115}),await database_1[_0x2d21c9(0x1fb)][_0x2d21c9(0x1e4)]['create']({'data':{'paymentId':_0x122f27['id'],'shopId':_0x122f27[_0x2d21c9(0x20f)],'event':_0x2d21c9(0x225)+_0x421100[_0x2d21c9(0x223)][_0x2d21c9(0x252)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x122f27['status'],'newStatus':_0x421100['status'],'paymentDetails':_0x421100[_0x2d21c9(0x1a5)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x2d21c9(0x1be)](_0x122f27,_0x421100['status']),await this[_0x2d21c9(0x253)](_0x122f27,_0x421100[_0x2d21c9(0x223)]),_0x421100['status']!=='PENDING'&&(console[_0x2d21c9(0x1e1)](_0x2d21c9(0x1e8)+_0x122f27['id']+_0x2d21c9(0x1e6)+_0x421100['status']+_0x2d21c9(0x1dd)),this[_0x2d21c9(0x239)](_0x122f27['id'])),console[_0x2d21c9(0x1e1)](_0x2d21c9(0x25e)+_0x122f27['id']+_0x2d21c9(0x1ea));}else console[_0x2d21c9(0x1e1)](_0x2d21c9(0x21f)+_0x122f27['id']+_0x2d21c9(0x205)+_0x421100[_0x2d21c9(0x223)]+')'),this['logCoinToPayStatus'](_0x122f27['id'],_0x122f27[_0x2d21c9(0x1f2)],_0x122f27['status'],_0x421100[_0x2d21c9(0x223)],_0x2d21c9(0x216),{'statusUnchanged':!![],'paymentDetails':_0x421100[_0x2d21c9(0x1a5)],'amount':_0x421100[_0x2d21c9(0x1ff)],'currency':_0x421100['currency'],'shopId':_0x122f27[_0x2d21c9(0x20f)],'checkTimestamp':new Date()[_0x2d21c9(0x244)]()});}catch(_0x536917){console[_0x2d21c9(0x1fd)](_0x2d21c9(0x1ec)+_0x122f27['id']+':',_0x536917),this[_0x2d21c9(0x1c1)](_0x122f27['id'],_0x122f27[_0x2d21c9(0x1f2)],_0x536917,'status_check',{'paymentAmount':_0x122f27[_0x2d21c9(0x1ff)],'paymentCurrency':_0x122f27['currency'],'shopId':_0x122f27['shopId'],'createdAt':_0x122f27[_0x2d21c9(0x20a)]}),await database_1[_0x2d21c9(0x1fb)][_0x2d21c9(0x1e4)][_0x2d21c9(0x262)]({'data':{'paymentId':_0x122f27['id'],'shopId':_0x122f27[_0x2d21c9(0x20f)],'event':_0x2d21c9(0x1b8),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x536917 instanceof Error?_0x536917[_0x2d21c9(0x1ed)]:_0x2d21c9(0x248),'gatewayPaymentId':_0x122f27[_0x2d21c9(0x1f2)],'checkedAt':new Date()[_0x2d21c9(0x244)]()})}});}}async[a35_0x712a8d(0x1be)](_0x325e31,_0x2ba39f){const _0xfb0622=a35_0x712a8d,_0x47e2d0=Date[_0xfb0622(0x203)]();try{const _0x528c5c=_0x325e31[_0xfb0622(0x1e3)],_0xa3936a=_0x528c5c[_0xfb0622(0x24f)];if(!_0xa3936a?.['webhookUrl']){console[_0xfb0622(0x1e1)](_0xfb0622(0x23f)+_0x528c5c['id']);return;}const _0x4cd271=_0x2ba39f==='PAID'?_0xfb0622(0x25b):_0x2ba39f===_0xfb0622(0x1f8)?_0xfb0622(0x1ca):_0x2ba39f===_0xfb0622(0x1a1)?_0xfb0622(0x1ca):_0xfb0622(0x1c3);if(!_0xa3936a['webhookEvents']?.[_0xfb0622(0x1a2)](_0x4cd271)){console[_0xfb0622(0x1e1)](_0xfb0622(0x25f)+_0x4cd271+'\x20not\x20enabled\x20for\x20shop\x20'+_0x528c5c['id']);return;}const _0x108ec6={'event':_0x4cd271,'payment':{'id':_0x325e31['id'],'order_id':_0x325e31[_0xfb0622(0x1b5)],'gateway_order_id':_0x325e31[_0xfb0622(0x1d7)],'gateway':_0xfb0622(0x263),'amount':_0x325e31[_0xfb0622(0x1ff)],'currency':_0x325e31[_0xfb0622(0x1cd)],'status':_0x2ba39f['toLowerCase'](),'customer_email':_0x325e31[_0xfb0622(0x25a)],'customer_name':_0x325e31[_0xfb0622(0x1ae)],'created_at':_0x325e31[_0xfb0622(0x20a)],'updated_at':new Date()}},_0x1823f8=await fetch(_0xa3936a[_0xfb0622(0x1c2)],{'method':_0xfb0622(0x1c9),'headers':{'Content-Type':'application/json','User-Agent':_0xfb0622(0x24d)},'body':JSON['stringify'](_0x108ec6)}),_0x59682a=Date[_0xfb0622(0x203)]()-_0x47e2d0,_0x427d28=_0x1823f8['ok']?_0xfb0622(0x254):await _0x1823f8[_0xfb0622(0x21a)]();loggerService_1['loggerService']['logShopWebhookSent'](_0x325e31[_0xfb0622(0x20f)],_0xa3936a[_0xfb0622(0x1c2)],_0x4cd271,_0x1823f8[_0xfb0622(0x223)],_0x59682a,_0x108ec6),console['log']('Shop\x20webhook\x20sent\x20to\x20'+_0xa3936a[_0xfb0622(0x1c2)]+'\x20with\x20status\x20'+_0x1823f8[_0xfb0622(0x223)]+'\x20('+_0x59682a+_0xfb0622(0x1ef));}catch(_0x128a9e){console[_0xfb0622(0x1fd)](_0xfb0622(0x206),_0x128a9e),loggerService_1['loggerService'][_0xfb0622(0x211)](_0x325e31['shopId'],_0x325e31[_0xfb0622(0x1e3)]?.[_0xfb0622(0x24f)]?.['webhookUrl']||_0xfb0622(0x1d0),_0xfb0622(0x1fc),_0x128a9e,{});}}async[a35_0x712a8d(0x253)](_0x4d3997,_0x380465){const _0x3cfa11=a35_0x712a8d;try{const _0x3b1aea={'PENDING':_0x3cfa11(0x251),'PAID':_0x3cfa11(0x1b9),'FAILED':_0x3cfa11(0x19c),'EXPIRED':_0x3cfa11(0x1d4)},_0x45988d=_0x3b1aea[_0x380465];if(!_0x45988d||_0x45988d===_0x3cfa11(0x251))return;await telegramBotService_1[_0x3cfa11(0x231)][_0x3cfa11(0x234)](_0x4d3997[_0x3cfa11(0x20f)],_0x4d3997,_0x45988d);}catch(_0x67ffb9){console['error'](_0x3cfa11(0x22d),_0x67ffb9);}}async['checkPaymentById'](_0x105db4){const _0x267b51=a35_0x712a8d,_0x5e3dd5=await database_1[_0x267b51(0x1fb)][_0x267b51(0x1a3)][_0x267b51(0x227)]({'where':{'id':_0x105db4},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5e3dd5)throw new Error('Payment\x20not\x20found');if(_0x5e3dd5['gateway']!==_0x267b51(0x1ba))throw new Error(_0x267b51(0x1a9));await this[_0x267b51(0x226)](_0x5e3dd5);}['getServiceStats'](){const _0x2de5fd=a35_0x712a8d,_0x28104e=this[_0x2de5fd(0x1f4)]?this[_0x2de5fd(0x20e)]:undefined;return{'isActive':!!this[_0x2de5fd(0x1f4)],'globalCheckIntervalMinutes':this[_0x2de5fd(0x20e)]/(0x3e8*0x3c),'expiryDays':this[_0x2de5fd(0x22b)],'activeIndividualTimers':this[_0x2de5fd(0x1dc)][_0x2de5fd(0x208)],'nextGlobalCheckIn':_0x28104e};}}function a35_0x4753(){const _0x5cb574=['\x20days','\x20status\x20is\x20','bankDetails','POST','payment.failed','not\x20found','\x20marked\x20as\x20paid\x20at:\x20','currency','transactionId','\x20\x20\x20üìä\x20Status:\x20','unknown','\x20pending\x20CoinToPay\x20payments','getTime','Bank\x20Details:\x20','expired','checkExpiredPayments','loggerService','gatewayOrderId','\x20for\x20payment\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment','has','update','paymentTimers',',\x20clearing\x20individual\x20timers','üîç\x20Global\x20check\x20for\x20old\x20payment\x20','Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20\x20\x20üìù\x20Context:','log','set','shop','webhookLog','554592LEomom','\x20status\x20changed\x20to\x20','174340INXXRx','üßπ\x20Payment\x20','5\x20minutes','\x20updated\x20successfully','üîÑ\x20Updating\x20payment\x20','Failed\x20to\x20check\x20payment\x20','message','‚úÖ\x20Scheduled\x20','ms)','ü™ô\x20Scheduling\x20individual\x20checks\x20for\x20CoinToPay\x20payment:\x20','271443SrzweR','gatewayPaymentId','\x20details:','globalCheckInterval','CoinToPayService','auto_expire','\x20to\x20','FAILED','logCoinToPayStatus','\x20\x20\x20‚ùå\x20Error:\x20','default','webhook_send','error','push','amount','50066BDXbmT','schedulePaymentChecks','timestamp','now','ü™ô\x20CoinToPay\x20Error:\x20','\x20status\x20unchanged\x20(','Failed\x20to\x20send\x20shop\x20webhook:','ü™ô\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check\x20(global\x20check)','size','delay','createdAt','Payment\x20older\x20than\x20','startPeriodicStatusCheck','1225dvvsrI','GLOBAL_CHECK_INTERVAL_MS','shopId','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','logShopWebhookError','-day\x20timeout','COINTOPAY_ERROR','\x20(age:\x20','\x20\x20\x20üìç\x20Source:\x20','status_check','stack','length','\x20seconds\x20(','text','ü™ô\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','ü™ô\x20Individual\x20check\x20#','stopPeriodicStatusCheck','checkPaymentStatus','üìä\x20Payment\x20','not\x20confirmed','floor','‚è∞\x20Scheduled\x20check\x20#','status','catch','cointopay_status_check_','checkSinglePayment','findUnique','üßπ\x20Cleared\x20individual\x20timers\x20for\x20payment\x20','checkSinglePaymentById','createdOn','EXPIRY_DAYS','‚è∞\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','logWhiteDomainError','‚úÖ\x20Completed\x20global\x20checking\x20of\x20CoinToPay\x20payments','confirmedOn','telegramBotService',',\x20stopping\x20individual\x20checks','2812985MLtwdG','sendPaymentNotification','Payment\x20','4EchfUC','1\x20minute','üí∞\x20Payment\x20','clearPaymentTimers','cointopay_auto_expired','adminNotes','PENDING','\x20has\x20no\x20gatewayPaymentId,\x20skipping','9JJMEEq','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paidAt','description','PAID','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','toISOString','./telegramBotService','üõë\x20CoinToPay\x20global\x20status\x20checking\x20stopped','getDate','Unknown\x20error','‚è∞\x20Payment\x20','iban','CoinToPayStatusService','\x20expired\x20CoinToPay\x20payments','TesSoft\x20Payment\x20System/1.0','306RqZulw','settings','delete','created','toLowerCase','sendPaymentStatusNotification','Success','./loggerService','\x20\x20\x20üìù\x20Details:','Failed\x20to\x20mark\x20payment\x20as\x20expired','üîç\x20Checking\x20CoinToPay\x20payment\x20','toFixed','customerEmail','payment.success','\x20is\x20older\x20than\x20','../config/database','‚úÖ\x20Payment\x20','Webhook\x20event\x20','\x20days\x20without\x20payment\x20confirmation','checkAllPendingPayments','create','0100','\x20days\x20(created\x20before\x20','failed','\x20status\x20from\x20','14155922xmbqWn','coinToPayStatusService','Failed\x20hourly\x20check\x20for\x20payment\x20','EXPIRED','includes','payment','‚ö†Ô∏è\x20Payment\x20','paymentDetails','coinToPayService','üÜî\x20Transaction\x20ID:\x20','\x20\x20\x20üìÖ\x20Time:\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','‚úÖ\x20Transaction\x20confirmed\x20on:\x20','\x20->\x20','Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20not\x20found,\x20clearing\x20timers','customerName','setDate','üè¶\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','./gateways/coinToPayService','13134jIYZgL','__esModule','orderId','stringify','\x20in\x20','cointopay_status_check_error','paid','cointopay','timers','\x20in\x20global\x20check:','forEach','sendShopWebhook','__importDefault','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','logCoinToPayError','webhookUrl','payment.pending','2\x20minutes','gateway'];a35_0x4753=function(){return _0x5cb574;};return a35_0x4753();}function a35_0x51b1(_0x4a03ee,_0x458bb4){const _0x47539d=a35_0x4753();return a35_0x51b1=function(_0x51b1a3,_0x8a82be){_0x51b1a3=_0x51b1a3-0x19b;let _0x2c1743=_0x47539d[_0x51b1a3];return _0x2c1743;},a35_0x51b1(_0x4a03ee,_0x458bb4);}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a35_0x712a8d(0x19f)]=new CoinToPayStatusService();