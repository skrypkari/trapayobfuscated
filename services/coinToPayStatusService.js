'use strict';const a35_0x27608a=a35_0x2e01;(function(_0x5f4c5f,_0x222671){const _0x201814=a35_0x2e01,_0x34c190=_0x5f4c5f();while(!![]){try{const _0x243ff2=-parseInt(_0x201814(0x229))/0x1*(-parseInt(_0x201814(0x22d))/0x2)+-parseInt(_0x201814(0x238))/0x3*(-parseInt(_0x201814(0x1d8))/0x4)+-parseInt(_0x201814(0x1fd))/0x5+-parseInt(_0x201814(0x1c4))/0x6*(-parseInt(_0x201814(0x20d))/0x7)+-parseInt(_0x201814(0x253))/0x8*(parseInt(_0x201814(0x234))/0x9)+-parseInt(_0x201814(0x1fa))/0xa+parseInt(_0x201814(0x220))/0xb;if(_0x243ff2===_0x222671)break;else _0x34c190['push'](_0x34c190['shift']());}catch(_0x4a2f18){_0x34c190['push'](_0x34c190['shift']());}}}(a35_0x5bf0,0xb1d4a));function a35_0x5bf0(){const _0x4e84f7=['message','confirmedOn','status','🔍\x20Checking\x20CoinToPay\x20payment\x20','telegramBotService','adminNotes','sendPaymentStatusNotification','\x20to\x20','7OsBbua','webhook_send','payment','loggerService','toISOString','customerName','defineProperty','./telegramBotService','orderId','length','paymentDetails','payment.failed','webhookUrl','getTime','cointopay_auto_expired','\x20status:\x20','EXPIRED','catch','shop','21246269tqzQPA','⏰\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','/status/','Webhook\x20event\x20','payment.success','checkPaymentStatus','🔄\x20Updating\x20payment\x20','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20days\x20(created\x20before\x20','44662VWnJag','EXPIRY_DAYS','./loggerService','setDate','4Nwesov','now','push','\x20days,\x20marking\x20as\x20EXPIRED','../config/database','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','🪙\x20Checking\x20','27ttvgmA','currency','ms)','Success','2947425HLeUhx','createdAt','sendPaymentNotification','log','logWhiteDomainError','🆔\x20Transaction\x20ID:\x20','getDate','⏰\x20Payment\x20','paidAt','created','\x20status\x20unchanged\x20(','application/json','findUnique','cointopay_status_check_error','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','TesSoft\x20Payment\x20System/1.0','stopPeriodicStatusCheck','checkExpiredPayments','✅\x20Payment\x20','✅\x20Completed\x20checking\x20','💰\x20Payment\x20','Automatically\x20expired\x20after\x20','✅\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','🏦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20details:','CoinToPayService','🏦\x20Saved\x20IBAN:\x20','3273864VrKnqa','\x20CoinToPay\x20payments','✅\x20Transaction\x20confirmed\x20on:\x20','sendShopWebhook','customerEmail','Failed\x20to\x20send\x20shop\x20webhook:','1832154NLxUIO','error','bankDetails','settings','amount','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','cointopay','🛑\x20CoinToPay\x20status\x20checking\x20stopped','includes','failed','checkInterval','Failed\x20to\x20check\x20payment\x20','coinToPayService','findMany','toLowerCase','checkAllPendingPayments','unknown','logShopWebhookError','PAID','FAILED','4VqPCMB','\x20has\x20no\x20gatewayPaymentId,\x20skipping','webhookEvents','🪙\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','__esModule','\x20marked\x20as\x20paid\x20at:\x20','POST','iban','create','expired','shopId','\x20with\x20status\x20','./gateways/coinToPayService','\x20is\x20older\x20than\x20','Shop\x20webhook\x20sent\x20to\x20','floor','cointopay_status_check_','update','payment.pending','Initial\x20CoinToPay\x20status\x20check\x20failed:','Payment\x20older\x20than\x20','transactionId','remitterIban','\x20updated\x20successfully','webhookLog','default','\x20expired\x20CoinToPay\x20payments','\x20pending\x20CoinToPay\x20payments','coinToPayStatusService','📊\x20Payment\x20','checkSinglePayment','\x20not\x20enabled\x20for\x20shop\x20','checkPaymentById','Failed\x20to\x20expire\x20payment\x20','479520KlfdiD','logShopWebhookSent','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','6522960nBhoII','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','gatewayPaymentId','stringify','CHECK_INTERVAL_MS','gateway','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','text'];a35_0x5bf0=function(){return _0x4e84f7;};return a35_0x5bf0();}var __importDefault=this&&this['__importDefault']||function(_0x2dcea2){const _0x1fc6e4=a35_0x2e01;return _0x2dcea2&&_0x2dcea2[_0x1fc6e4(0x1dc)]?_0x2dcea2:{'default':_0x2dcea2};};Object[a35_0x27608a(0x213)](exports,a35_0x27608a(0x1dc),{'value':!![]}),exports['coinToPayStatusService']=exports['CoinToPayStatusService']=void 0x0;function a35_0x2e01(_0x267bac,_0x5be556){const _0x5bf013=a35_0x5bf0();return a35_0x2e01=function(_0x2e0120,_0x3bc83a){_0x2e0120=_0x2e0120-0x1c2;let _0x2d3320=_0x5bf013[_0x2e0120];return _0x2d3320;},a35_0x2e01(_0x267bac,_0x5be556);}const coinToPayService_1=require(a35_0x27608a(0x1e4)),database_1=__importDefault(require(a35_0x27608a(0x231))),telegramBotService_1=require(a35_0x27608a(0x214)),loggerService_1=require(a35_0x27608a(0x22b));class CoinToPayStatusService{constructor(){const _0x3c7d80=a35_0x27608a;this['checkInterval']=null,this[_0x3c7d80(0x201)]=0x3c*0x3c*0x3e8,this[_0x3c7d80(0x22a)]=0x5,this[_0x3c7d80(0x1d0)]=new coinToPayService_1[(_0x3c7d80(0x251))]();}['startPeriodicStatusCheck'](){const _0x1b8125=a35_0x27608a;console[_0x1b8125(0x23b)]('🪙\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)'),this[_0x1b8125(0x1d3)]()[_0x1b8125(0x21e)](_0x7dbedd=>{const _0x1b4df5=_0x1b8125;console['error'](_0x1b4df5(0x1eb),_0x7dbedd);}),this[_0x1b8125(0x1ce)]=setInterval(async()=>{const _0x38b3b6=_0x1b8125;try{await this[_0x38b3b6(0x1d3)]();}catch(_0x13eacb){console[_0x38b3b6(0x1c5)]('Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x13eacb);}},this['CHECK_INTERVAL_MS']),console['log'](_0x1b8125(0x24e));}[a35_0x27608a(0x248)](){const _0x54e51a=a35_0x27608a;this['checkInterval']&&(clearInterval(this[_0x54e51a(0x1ce)]),this[_0x54e51a(0x1ce)]=null,console['log'](_0x54e51a(0x1cb)));}async[a35_0x27608a(0x1d3)](){const _0x3adaf6=a35_0x27608a;try{const _0x23aabd=await database_1[_0x3adaf6(0x1f1)][_0x3adaf6(0x20f)][_0x3adaf6(0x1d1)]({'where':{'gateway':_0x3adaf6(0x1ca),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x23aabd[_0x3adaf6(0x216)]===0x0){console[_0x3adaf6(0x23b)](_0x3adaf6(0x1db));return;}console[_0x3adaf6(0x23b)](_0x3adaf6(0x233)+_0x23aabd[_0x3adaf6(0x216)]+_0x3adaf6(0x1f3));const _0x2ed33a=await this[_0x3adaf6(0x249)](_0x23aabd);console[_0x3adaf6(0x23b)]('⏰\x20Found\x20'+_0x2ed33a[_0x3adaf6(0x216)]+_0x3adaf6(0x1f2));for(const _0x182cac of _0x23aabd){try{if(_0x2ed33a[_0x3adaf6(0x1cc)](_0x182cac['id'])){console['log'](_0x3adaf6(0x23f)+_0x182cac['id']+_0x3adaf6(0x1fe));continue;}await this['checkSinglePayment'](_0x182cac),await new Promise(_0x3f8133=>setTimeout(_0x3f8133,0x7d0));}catch(_0x125c7c){console['error'](_0x3adaf6(0x227)+_0x182cac['id']+':',_0x125c7c),loggerService_1['loggerService'][_0x3adaf6(0x23c)]('cointopay',_0x3adaf6(0x222)+_0x182cac[_0x3adaf6(0x1ff)],_0x125c7c);}}console[_0x3adaf6(0x23b)](_0x3adaf6(0x24b)+_0x23aabd['length']+_0x3adaf6(0x254));}catch(_0x915e38){console[_0x3adaf6(0x1c5)](_0x3adaf6(0x1fc),_0x915e38);}}async['checkExpiredPayments'](_0x3d9133){const _0x4a99df=a35_0x27608a,_0x5050b9=[],_0x57db13=new Date();_0x57db13[_0x4a99df(0x22c)](_0x57db13[_0x4a99df(0x23e)]()-this[_0x4a99df(0x22a)]),console[_0x4a99df(0x23b)](_0x4a99df(0x221)+this[_0x4a99df(0x22a)]+_0x4a99df(0x228)+_0x57db13[_0x4a99df(0x211)]()+')');for(const _0x173cc8 of _0x3d9133){if(_0x173cc8[_0x4a99df(0x239)]<_0x57db13){console[_0x4a99df(0x23b)](_0x4a99df(0x23f)+_0x173cc8['id']+_0x4a99df(0x1e5)+this[_0x4a99df(0x22a)]+_0x4a99df(0x230));try{await database_1[_0x4a99df(0x1f1)][_0x4a99df(0x20f)][_0x4a99df(0x1e9)]({'where':{'id':_0x173cc8['id']},'data':{'status':_0x4a99df(0x21d),'updatedAt':new Date(),'adminNotes':_0x4a99df(0x24d)+this[_0x4a99df(0x22a)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1['default']['webhookLog'][_0x4a99df(0x1e0)]({'data':{'paymentId':_0x173cc8['id'],'shopId':_0x173cc8[_0x4a99df(0x1e2)],'event':_0x4a99df(0x21b),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x4a99df(0x1ec)+this[_0x4a99df(0x22a)]+'\x20days','createdAt':_0x173cc8[_0x4a99df(0x239)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x4a99df(0x1e7)]((Date[_0x4a99df(0x22e)]()-_0x173cc8['createdAt'][_0x4a99df(0x21a)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4a99df(0x256)](_0x173cc8,_0x4a99df(0x21d)),await this[_0x4a99df(0x20b)](_0x173cc8,_0x4a99df(0x21d)),_0x5050b9[_0x4a99df(0x22f)](_0x173cc8['id']),console[_0x4a99df(0x23b)](_0x4a99df(0x24a)+_0x173cc8['id']+_0x4a99df(0x1c9)+this['EXPIRY_DAYS']+'-day\x20timeout');}catch(_0x98d35){console[_0x4a99df(0x1c5)](_0x4a99df(0x1f9)+_0x173cc8['id']+':',_0x98d35);}}}return _0x5050b9;}async[a35_0x27608a(0x1f6)](_0x42fdb4){const _0x20987b=a35_0x27608a;if(!_0x42fdb4[_0x20987b(0x1ff)]){console['log']('⚠️\x20Payment\x20'+_0x42fdb4['id']+_0x20987b(0x1d9));return;}console[_0x20987b(0x23b)](_0x20987b(0x208)+_0x42fdb4['id']+'\x20('+_0x42fdb4['gatewayPaymentId']+')');try{const _0x3f5f65=await this[_0x20987b(0x1d0)][_0x20987b(0x225)](_0x42fdb4[_0x20987b(0x1ff)]);console[_0x20987b(0x23b)]('📊\x20Payment\x20'+_0x42fdb4['id']+_0x20987b(0x21c)+_0x3f5f65[_0x20987b(0x207)]);_0x3f5f65[_0x20987b(0x217)]&&console[_0x20987b(0x23b)](_0x20987b(0x1f5)+_0x42fdb4['id']+_0x20987b(0x250),{'iban':_0x3f5f65[_0x20987b(0x217)][_0x20987b(0x1df)]||'not\x20found','transactionId':_0x3f5f65['paymentDetails']['transactionId'],'createdOn':_0x3f5f65['paymentDetails']['createdOn'],'confirmedOn':_0x3f5f65[_0x20987b(0x217)][_0x20987b(0x206)]||'not\x20confirmed'});if(_0x3f5f65[_0x20987b(0x207)]!==_0x42fdb4['status']){console[_0x20987b(0x23b)](_0x20987b(0x226)+_0x42fdb4['id']+'\x20status\x20from\x20'+_0x42fdb4[_0x20987b(0x207)]+_0x20987b(0x20c)+_0x3f5f65['status']);const _0x1f3c82={'status':_0x3f5f65[_0x20987b(0x207)],'updatedAt':new Date()};_0x3f5f65[_0x20987b(0x207)]===_0x20987b(0x1d6)&&_0x42fdb4[_0x20987b(0x207)]!=='PAID'&&(_0x1f3c82[_0x20987b(0x240)]=new Date(),console[_0x20987b(0x23b)](_0x20987b(0x24c)+_0x42fdb4['id']+_0x20987b(0x1dd)+_0x1f3c82[_0x20987b(0x240)][_0x20987b(0x211)]()));if(_0x3f5f65[_0x20987b(0x217)]){const _0x470bfc=_0x3f5f65['paymentDetails'];_0x470bfc[_0x20987b(0x1df)]&&(_0x1f3c82[_0x20987b(0x1ee)]=_0x470bfc[_0x20987b(0x1df)],console[_0x20987b(0x23b)](_0x20987b(0x252)+_0x470bfc[_0x20987b(0x1df)]));if(_0x470bfc[_0x20987b(0x1c6)]){const _0x4c1177=_0x42fdb4[_0x20987b(0x20a)]||'',_0x551e07='Bank\x20Details:\x20'+_0x470bfc[_0x20987b(0x1c6)];_0x1f3c82[_0x20987b(0x20a)]=_0x4c1177?_0x4c1177+'\x0a\x0a'+_0x551e07:_0x551e07,console['log'](_0x20987b(0x24f));}_0x470bfc[_0x20987b(0x1ed)]&&console['log'](_0x20987b(0x23d)+_0x470bfc['transactionId']),_0x470bfc[_0x20987b(0x206)]&&console[_0x20987b(0x23b)](_0x20987b(0x255)+_0x470bfc[_0x20987b(0x206)]);}await database_1[_0x20987b(0x1f1)][_0x20987b(0x20f)][_0x20987b(0x1e9)]({'where':{'id':_0x42fdb4['id']},'data':_0x1f3c82}),await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0x42fdb4['id'],'shopId':_0x42fdb4[_0x20987b(0x1e2)],'event':_0x20987b(0x1e8)+_0x3f5f65[_0x20987b(0x207)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x20987b(0x200)]({'oldStatus':_0x42fdb4[_0x20987b(0x207)],'newStatus':_0x3f5f65[_0x20987b(0x207)],'paymentDetails':_0x3f5f65[_0x20987b(0x217)],'checkedAt':new Date()[_0x20987b(0x211)]()})}}),await this[_0x20987b(0x256)](_0x42fdb4,_0x3f5f65['status']),await this[_0x20987b(0x20b)](_0x42fdb4,_0x3f5f65[_0x20987b(0x207)]),console['log'](_0x20987b(0x24a)+_0x42fdb4['id']+_0x20987b(0x1ef));}else console[_0x20987b(0x23b)]('📊\x20Payment\x20'+_0x42fdb4['id']+_0x20987b(0x242)+_0x3f5f65['status']+')');}catch(_0x191428){console[_0x20987b(0x1c5)](_0x20987b(0x1cf)+_0x42fdb4['id']+':',_0x191428),await database_1[_0x20987b(0x1f1)][_0x20987b(0x1f0)][_0x20987b(0x1e0)]({'data':{'paymentId':_0x42fdb4['id'],'shopId':_0x42fdb4[_0x20987b(0x1e2)],'event':_0x20987b(0x245),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x191428 instanceof Error?_0x191428[_0x20987b(0x205)]:'Unknown\x20error','gatewayPaymentId':_0x42fdb4['gatewayPaymentId'],'checkedAt':new Date()[_0x20987b(0x211)]()})}});}}async[a35_0x27608a(0x256)](_0x20b665,_0x549fda){const _0x438c89=a35_0x27608a,_0x13d347=Date[_0x438c89(0x22e)]();try{const _0x26c87c=_0x20b665['shop'],_0x383753=_0x26c87c[_0x438c89(0x1c7)];if(!_0x383753?.[_0x438c89(0x219)]){console[_0x438c89(0x23b)](_0x438c89(0x203)+_0x26c87c['id']);return;}const _0x51e7e7=_0x549fda===_0x438c89(0x1d6)?_0x438c89(0x224):_0x549fda===_0x438c89(0x1d7)?_0x438c89(0x218):_0x549fda===_0x438c89(0x21d)?_0x438c89(0x218):_0x438c89(0x1ea);if(!_0x383753[_0x438c89(0x1da)]?.[_0x438c89(0x1cc)](_0x51e7e7)){console[_0x438c89(0x23b)](_0x438c89(0x223)+_0x51e7e7+_0x438c89(0x1f7)+_0x26c87c['id']);return;}const _0x5392fa={'event':_0x51e7e7,'payment':{'id':_0x20b665['id'],'order_id':_0x20b665[_0x438c89(0x215)],'gateway_order_id':_0x20b665['gatewayOrderId'],'gateway':'0100','amount':_0x20b665[_0x438c89(0x1c8)],'currency':_0x20b665[_0x438c89(0x235)],'status':_0x549fda[_0x438c89(0x1d2)](),'customer_email':_0x20b665[_0x438c89(0x1c2)],'customer_name':_0x20b665[_0x438c89(0x212)],'created_at':_0x20b665['createdAt'],'updated_at':new Date()}},_0x380361=await fetch(_0x383753['webhookUrl'],{'method':_0x438c89(0x1de),'headers':{'Content-Type':_0x438c89(0x243),'User-Agent':_0x438c89(0x247)},'body':JSON['stringify'](_0x5392fa)}),_0x202029=Date[_0x438c89(0x22e)]()-_0x13d347,_0xf6c261=_0x380361['ok']?_0x438c89(0x237):await _0x380361[_0x438c89(0x204)]();loggerService_1[_0x438c89(0x210)][_0x438c89(0x1fb)](_0x20b665['shopId'],_0x383753[_0x438c89(0x219)],_0x51e7e7,_0x380361[_0x438c89(0x207)],_0x202029,_0x5392fa),console[_0x438c89(0x23b)](_0x438c89(0x1e6)+_0x383753['webhookUrl']+_0x438c89(0x1e3)+_0x380361[_0x438c89(0x207)]+'\x20('+_0x202029+_0x438c89(0x236));}catch(_0x2a23d5){console[_0x438c89(0x1c5)](_0x438c89(0x1c3),_0x2a23d5),loggerService_1[_0x438c89(0x210)][_0x438c89(0x1d5)](_0x20b665['shopId'],_0x20b665[_0x438c89(0x21f)]?.[_0x438c89(0x1c7)]?.[_0x438c89(0x219)]||_0x438c89(0x1d4),_0x438c89(0x20e),_0x2a23d5,{});}}async[a35_0x27608a(0x20b)](_0x3f91d1,_0x3a9268){const _0x5764b2=a35_0x27608a;try{const _0x45c511={'PENDING':'created','PAID':'paid','FAILED':_0x5764b2(0x1cd),'EXPIRED':_0x5764b2(0x1e1)},_0x3feee8=_0x45c511[_0x3a9268];if(!_0x3feee8||_0x3feee8===_0x5764b2(0x241))return;await telegramBotService_1[_0x5764b2(0x209)][_0x5764b2(0x23a)](_0x3f91d1[_0x5764b2(0x1e2)],_0x3f91d1,_0x3feee8);}catch(_0x47652d){console[_0x5764b2(0x1c5)](_0x5764b2(0x232),_0x47652d);}}async[a35_0x27608a(0x1f8)](_0x5eff45){const _0x5e421f=a35_0x27608a,_0xe8dab5=await database_1[_0x5e421f(0x1f1)][_0x5e421f(0x20f)][_0x5e421f(0x244)]({'where':{'id':_0x5eff45},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xe8dab5)throw new Error('Payment\x20not\x20found');if(_0xe8dab5[_0x5e421f(0x202)]!==_0x5e421f(0x1ca))throw new Error(_0x5e421f(0x246));await this[_0x5e421f(0x1f6)](_0xe8dab5);}['getServiceStats'](){const _0x13d5c9=a35_0x27608a,_0x32008c=this['checkInterval']?this[_0x13d5c9(0x201)]:undefined;return{'isActive':!!this[_0x13d5c9(0x1ce)],'checkIntervalMinutes':this['CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x13d5c9(0x22a)],'nextCheckIn':_0x32008c};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a35_0x27608a(0x1f4)]=new CoinToPayStatusService();