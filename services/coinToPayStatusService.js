'use strict';const a35_0x233282=a35_0x3dce;(function(_0x114b14,_0x21d285){const _0x5cf10c=a35_0x3dce,_0x1417cb=_0x114b14();while(!![]){try{const _0x4e3821=parseInt(_0x5cf10c(0x1ab))/0x1+-parseInt(_0x5cf10c(0x1eb))/0x2*(parseInt(_0x5cf10c(0x1d6))/0x3)+-parseInt(_0x5cf10c(0x172))/0x4+-parseInt(_0x5cf10c(0x1a0))/0x5*(parseInt(_0x5cf10c(0x19b))/0x6)+parseInt(_0x5cf10c(0x1b8))/0x7*(parseInt(_0x5cf10c(0x199))/0x8)+parseInt(_0x5cf10c(0x16c))/0x9*(parseInt(_0x5cf10c(0x1e4))/0xa)+-parseInt(_0x5cf10c(0x1c1))/0xb*(-parseInt(_0x5cf10c(0x173))/0xc);if(_0x4e3821===_0x21d285)break;else _0x1417cb['push'](_0x1417cb['shift']());}catch(_0x46a663){_0x1417cb['push'](_0x1417cb['shift']());}}}(a35_0x2493,0x467af));var __importDefault=this&&this[a35_0x233282(0x17c)]||function(_0x1978a5){return _0x1978a5&&_0x1978a5['__esModule']?_0x1978a5:{'default':_0x1978a5};};function a35_0x3dce(_0x12a0b8,_0x37ec96){const _0x24936f=a35_0x2493();return a35_0x3dce=function(_0x3dce7e,_0x1dbd8f){_0x3dce7e=_0x3dce7e-0x169;let _0x222c42=_0x24936f[_0x3dce7e];return _0x222c42;},a35_0x3dce(_0x12a0b8,_0x37ec96);}Object[a35_0x233282(0x170)](exports,'__esModule',{'value':!![]}),exports[a35_0x233282(0x1a6)]=exports[a35_0x233282(0x176)]=void 0x0;const coinToPayService_1=require(a35_0x233282(0x1bf)),database_1=__importDefault(require(a35_0x233282(0x181))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0xed9d13=a35_0x233282;this[_0xed9d13(0x1b5)]=null,this['CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0xed9d13(0x1c7)]=0x5,this[_0xed9d13(0x197)]=new coinToPayService_1[(_0xed9d13(0x193))]();}[a35_0x233282(0x198)](){const _0x4a1af1=a35_0x233282;console[_0x4a1af1(0x1c5)](_0x4a1af1(0x1d1)),this[_0x4a1af1(0x16b)]()['catch'](_0x3533a6=>{const _0x10fa4a=_0x4a1af1;console[_0x10fa4a(0x1d7)](_0x10fa4a(0x17e),_0x3533a6);}),this[_0x4a1af1(0x1b5)]=setInterval(async()=>{const _0x1ef416=_0x4a1af1;try{await this[_0x1ef416(0x16b)]();}catch(_0x36b17a){console[_0x1ef416(0x1d7)](_0x1ef416(0x1b1),_0x36b17a);}},this['CHECK_INTERVAL_MS']),console[_0x4a1af1(0x1c5)](_0x4a1af1(0x1e0));}[a35_0x233282(0x19c)](){const _0x41076b=a35_0x233282;this[_0x41076b(0x1b5)]&&(clearInterval(this[_0x41076b(0x1b5)]),this[_0x41076b(0x1b5)]=null,console[_0x41076b(0x1c5)]('ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped'));}async[a35_0x233282(0x16b)](){const _0x2ca50c=a35_0x233282;try{const _0x3adaa6=await database_1[_0x2ca50c(0x19a)][_0x2ca50c(0x1d5)][_0x2ca50c(0x1c6)]({'where':{'gateway':'cointopay','status':_0x2ca50c(0x1e3),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x3adaa6['length']===0x0){console[_0x2ca50c(0x1c5)]('ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}console[_0x2ca50c(0x1c5)](_0x2ca50c(0x19f)+_0x3adaa6[_0x2ca50c(0x1e5)]+_0x2ca50c(0x1d8));const _0x35844f=await this[_0x2ca50c(0x16d)](_0x3adaa6);console[_0x2ca50c(0x1c5)](_0x2ca50c(0x175)+_0x35844f[_0x2ca50c(0x1e5)]+'\x20expired\x20CoinToPay\x20payments');for(const _0x45aee2 of _0x3adaa6){try{if(_0x35844f[_0x2ca50c(0x1d9)](_0x45aee2['id'])){console[_0x2ca50c(0x1c5)](_0x2ca50c(0x184)+_0x45aee2['id']+_0x2ca50c(0x1d4));continue;}await this[_0x2ca50c(0x1ac)](_0x45aee2),await new Promise(_0x5a1ed4=>setTimeout(_0x5a1ed4,0x7d0));}catch(_0x7944ef){console[_0x2ca50c(0x1d7)](_0x2ca50c(0x1df)+_0x45aee2['id']+':',_0x7944ef),loggerService_1[_0x2ca50c(0x1a5)][_0x2ca50c(0x19e)](_0x2ca50c(0x1a3),_0x2ca50c(0x18b)+_0x45aee2['gatewayPaymentId'],_0x7944ef);}}console[_0x2ca50c(0x1c5)](_0x2ca50c(0x16a)+_0x3adaa6[_0x2ca50c(0x1e5)]+'\x20CoinToPay\x20payments');}catch(_0x3826ec){console['error'](_0x2ca50c(0x1b9),_0x3826ec);}}async[a35_0x233282(0x16d)](_0x9ffad9){const _0x1c7a76=a35_0x233282,_0x4e4298=[],_0x157bc1=new Date();_0x157bc1[_0x1c7a76(0x1ad)](_0x157bc1['getDate']()-this[_0x1c7a76(0x1c7)]),console[_0x1c7a76(0x1c5)](_0x1c7a76(0x1cd)+this[_0x1c7a76(0x1c7)]+_0x1c7a76(0x1bb)+_0x157bc1['toISOString']()+')');for(const _0x34600f of _0x9ffad9){if(_0x34600f[_0x1c7a76(0x1c3)]<_0x157bc1){console['log'](_0x1c7a76(0x184)+_0x34600f['id']+'\x20is\x20older\x20than\x20'+this[_0x1c7a76(0x1c7)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{await database_1['default'][_0x1c7a76(0x1d5)][_0x1c7a76(0x192)]({'where':{'id':_0x34600f['id']},'data':{'status':_0x1c7a76(0x1b7),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x1c7a76(0x1c7)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x1c7a76(0x19a)]['webhookLog']['create']({'data':{'paymentId':_0x34600f['id'],'shopId':_0x34600f[_0x1c7a76(0x1be)],'event':_0x1c7a76(0x169),'statusCode':0xc8,'responseBody':JSON[_0x1c7a76(0x1b0)]({'reason':'Payment\x20older\x20than\x20'+this[_0x1c7a76(0x1c7)]+_0x1c7a76(0x1e8),'createdAt':_0x34600f[_0x1c7a76(0x1c3)],'expiredAt':new Date()[_0x1c7a76(0x1bd)](),'daysSinceCreation':Math['floor']((Date[_0x1c7a76(0x1d0)]()-_0x34600f[_0x1c7a76(0x1c3)][_0x1c7a76(0x17d)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x34600f,'EXPIRED'),await this['sendPaymentStatusNotification'](_0x34600f,_0x1c7a76(0x1b7)),_0x4e4298[_0x1c7a76(0x1a2)](_0x34600f['id']),console[_0x1c7a76(0x1c5)](_0x1c7a76(0x196)+_0x34600f['id']+_0x1c7a76(0x194)+this[_0x1c7a76(0x1c7)]+'-day\x20timeout');}catch(_0x20dcf2){console[_0x1c7a76(0x1d7)](_0x1c7a76(0x16f)+_0x34600f['id']+':',_0x20dcf2);}}}return _0x4e4298;}async[a35_0x233282(0x1ac)](_0x504bb6){const _0x5a30c8=a35_0x233282;if(!_0x504bb6[_0x5a30c8(0x1e2)]){console['log'](_0x5a30c8(0x18e)+_0x504bb6['id']+_0x5a30c8(0x183));return;}console[_0x5a30c8(0x1c5)](_0x5a30c8(0x189)+_0x504bb6['id']+'\x20('+_0x504bb6[_0x5a30c8(0x1e2)]+')');try{const _0x66fa7e=await this[_0x5a30c8(0x197)]['checkPaymentStatus'](_0x504bb6[_0x5a30c8(0x1e2)]);console[_0x5a30c8(0x1c5)](_0x5a30c8(0x182)+_0x504bb6['id']+'\x20status:\x20'+_0x66fa7e[_0x5a30c8(0x17f)]);_0x66fa7e[_0x5a30c8(0x16e)]&&console[_0x5a30c8(0x1c5)](_0x5a30c8(0x182)+_0x504bb6['id']+_0x5a30c8(0x191),{'iban':_0x66fa7e[_0x5a30c8(0x16e)][_0x5a30c8(0x1a8)]||_0x5a30c8(0x1b2),'transactionId':_0x66fa7e[_0x5a30c8(0x16e)][_0x5a30c8(0x1cc)],'createdOn':_0x66fa7e[_0x5a30c8(0x16e)][_0x5a30c8(0x1a9)],'confirmedOn':_0x66fa7e['paymentDetails'][_0x5a30c8(0x1c8)]||_0x5a30c8(0x1cf)});if(_0x66fa7e[_0x5a30c8(0x17f)]!==_0x504bb6[_0x5a30c8(0x17f)]){console[_0x5a30c8(0x1c5)](_0x5a30c8(0x1d3)+_0x504bb6['id']+'\x20status\x20from\x20'+_0x504bb6[_0x5a30c8(0x17f)]+_0x5a30c8(0x18a)+_0x66fa7e[_0x5a30c8(0x17f)]);const _0x4335b2={'status':_0x66fa7e[_0x5a30c8(0x17f)],'updatedAt':new Date()};_0x66fa7e[_0x5a30c8(0x17f)]==='PAID'&&_0x504bb6['status']!==_0x5a30c8(0x180)&&(_0x4335b2[_0x5a30c8(0x179)]=new Date(),console[_0x5a30c8(0x1c5)](_0x5a30c8(0x186)+_0x504bb6['id']+_0x5a30c8(0x18f)+_0x4335b2['paidAt'][_0x5a30c8(0x1bd)]()));if(_0x66fa7e[_0x5a30c8(0x16e)]){const _0x238851=_0x66fa7e[_0x5a30c8(0x16e)];_0x238851['iban']&&(_0x4335b2[_0x5a30c8(0x18d)]=_0x238851[_0x5a30c8(0x1a8)],console['log'](_0x5a30c8(0x1da)+_0x238851[_0x5a30c8(0x1a8)]));if(_0x238851[_0x5a30c8(0x1a1)]){const _0x50a410=_0x504bb6['adminNotes']||'',_0x4f85ad='Bank\x20Details:\x20'+_0x238851['bankDetails'];_0x4335b2[_0x5a30c8(0x171)]=_0x50a410?_0x50a410+'\x0a\x0a'+_0x4f85ad:_0x4f85ad,console[_0x5a30c8(0x1c5)](_0x5a30c8(0x1c0));}_0x238851[_0x5a30c8(0x1cc)]&&console[_0x5a30c8(0x1c5)]('ðŸ†”\x20Transaction\x20ID:\x20'+_0x238851[_0x5a30c8(0x1cc)]),_0x238851[_0x5a30c8(0x1c8)]&&console[_0x5a30c8(0x1c5)](_0x5a30c8(0x1ce)+_0x238851[_0x5a30c8(0x1c8)]);}await database_1['default'][_0x5a30c8(0x1d5)]['update']({'where':{'id':_0x504bb6['id']},'data':_0x4335b2}),await database_1['default'][_0x5a30c8(0x1d2)][_0x5a30c8(0x178)]({'data':{'paymentId':_0x504bb6['id'],'shopId':_0x504bb6[_0x5a30c8(0x1be)],'event':_0x5a30c8(0x1c4)+_0x66fa7e[_0x5a30c8(0x17f)][_0x5a30c8(0x18c)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x504bb6['status'],'newStatus':_0x66fa7e[_0x5a30c8(0x17f)],'paymentDetails':_0x66fa7e[_0x5a30c8(0x16e)],'checkedAt':new Date()[_0x5a30c8(0x1bd)]()})}}),await this['sendShopWebhook'](_0x504bb6,_0x66fa7e[_0x5a30c8(0x17f)]),await this['sendPaymentStatusNotification'](_0x504bb6,_0x66fa7e['status']),console['log']('âœ…\x20Payment\x20'+_0x504bb6['id']+'\x20updated\x20successfully');}else console['log']('ðŸ“Š\x20Payment\x20'+_0x504bb6['id']+_0x5a30c8(0x17b)+_0x66fa7e[_0x5a30c8(0x17f)]+')');}catch(_0x25690c){console[_0x5a30c8(0x1d7)](_0x5a30c8(0x1a4)+_0x504bb6['id']+':',_0x25690c),await database_1[_0x5a30c8(0x19a)]['webhookLog']['create']({'data':{'paymentId':_0x504bb6['id'],'shopId':_0x504bb6[_0x5a30c8(0x1be)],'event':_0x5a30c8(0x1ba),'statusCode':0x1f4,'responseBody':JSON[_0x5a30c8(0x1b0)]({'error':_0x25690c instanceof Error?_0x25690c[_0x5a30c8(0x1dd)]:'Unknown\x20error','gatewayPaymentId':_0x504bb6[_0x5a30c8(0x1e2)],'checkedAt':new Date()[_0x5a30c8(0x1bd)]()})}});}}async['sendShopWebhook'](_0x1cff05,_0x14f331){const _0x198554=a35_0x233282,_0x264e64=Date[_0x198554(0x1d0)]();try{const _0x16fae4=_0x1cff05['shop'],_0x26e450=_0x16fae4[_0x198554(0x1ca)];if(!_0x26e450?.[_0x198554(0x1e6)]){console[_0x198554(0x1c5)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x16fae4['id']);return;}const _0x5e2eb6=_0x14f331==='PAID'?'payment.success':_0x14f331===_0x198554(0x17a)?_0x198554(0x1e1):_0x14f331===_0x198554(0x1b7)?_0x198554(0x1e1):_0x198554(0x195);if(!_0x26e450['webhookEvents']?.[_0x198554(0x1d9)](_0x5e2eb6)){console[_0x198554(0x1c5)]('Webhook\x20event\x20'+_0x5e2eb6+_0x198554(0x177)+_0x16fae4['id']);return;}const _0x464c00={'event':_0x5e2eb6,'payment':{'id':_0x1cff05['id'],'order_id':_0x1cff05[_0x198554(0x1db)],'gateway_order_id':_0x1cff05[_0x198554(0x1c9)],'gateway':'0100','amount':_0x1cff05[_0x198554(0x1bc)],'currency':_0x1cff05[_0x198554(0x174)],'status':_0x14f331[_0x198554(0x18c)](),'customer_email':_0x1cff05[_0x198554(0x185)],'customer_name':_0x1cff05[_0x198554(0x1dc)],'created_at':_0x1cff05[_0x198554(0x1c3)],'updated_at':new Date()}},_0x591370=await fetch(_0x26e450['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x198554(0x1af),'User-Agent':_0x198554(0x1cb)},'body':JSON[_0x198554(0x1b0)](_0x464c00)}),_0x5a4122=Date[_0x198554(0x1d0)]()-_0x264e64,_0x206d1d=_0x591370['ok']?_0x198554(0x187):await _0x591370['text']();loggerService_1[_0x198554(0x1a5)][_0x198554(0x1de)](_0x1cff05[_0x198554(0x1be)],_0x26e450[_0x198554(0x1e6)],_0x5e2eb6,_0x591370[_0x198554(0x17f)],_0x5a4122,_0x464c00),console[_0x198554(0x1c5)]('Shop\x20webhook\x20sent\x20to\x20'+_0x26e450['webhookUrl']+'\x20with\x20status\x20'+_0x591370[_0x198554(0x17f)]+'\x20('+_0x5a4122+_0x198554(0x1e7));}catch(_0x1470c5){console[_0x198554(0x1d7)](_0x198554(0x190),_0x1470c5),loggerService_1[_0x198554(0x1a5)][_0x198554(0x1aa)](_0x1cff05[_0x198554(0x1be)],_0x1cff05['shop']?.[_0x198554(0x1ca)]?.[_0x198554(0x1e6)]||_0x198554(0x1b4),_0x198554(0x1e9),_0x1470c5,{});}}async['sendPaymentStatusNotification'](_0x43b4c8,_0x5de0ed){const _0x3d1aea=a35_0x233282;try{const _0x5ba033={'PENDING':_0x3d1aea(0x1b3),'PAID':'paid','FAILED':_0x3d1aea(0x19d),'EXPIRED':'expired'},_0x1cc36b=_0x5ba033[_0x5de0ed];if(!_0x1cc36b||_0x1cc36b===_0x3d1aea(0x1b3))return;await telegramBotService_1['telegramBotService'][_0x3d1aea(0x1b6)](_0x43b4c8[_0x3d1aea(0x1be)],_0x43b4c8,_0x1cc36b);}catch(_0x1204e6){console[_0x3d1aea(0x1d7)](_0x3d1aea(0x1ea),_0x1204e6);}}async['checkPaymentById'](_0x37d06e){const _0x2b22f7=a35_0x233282,_0x3e770a=await database_1[_0x2b22f7(0x19a)][_0x2b22f7(0x1d5)][_0x2b22f7(0x188)]({'where':{'id':_0x37d06e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3e770a)throw new Error('Payment\x20not\x20found');if(_0x3e770a[_0x2b22f7(0x1a7)]!==_0x2b22f7(0x1a3))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');await this[_0x2b22f7(0x1ac)](_0x3e770a);}[a35_0x233282(0x1c2)](){const _0x2964be=a35_0x233282,_0x384f75=this['checkInterval']?this[_0x2964be(0x1ae)]:undefined;return{'isActive':!!this['checkInterval'],'checkIntervalMinutes':this[_0x2964be(0x1ae)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'nextCheckIn':_0x384f75};}}function a35_0x2493(){const _0x2dd3e5=['FAILED','\x20status\x20unchanged\x20(','__importDefault','getTime','Initial\x20CoinToPay\x20status\x20check\x20failed:','status','PAID','../config/database','ðŸ“Š\x20Payment\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','â°\x20Payment\x20','customerEmail','ðŸ’°\x20Payment\x20','Success','findUnique','ðŸ”\x20Checking\x20CoinToPay\x20payment\x20','\x20to\x20','/status/','toLowerCase','remitterIban','âš ï¸\x20Payment\x20','\x20marked\x20as\x20paid\x20at:\x20','Failed\x20to\x20send\x20shop\x20webhook:','\x20details:','update','CoinToPayService','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','payment.pending','âœ…\x20Payment\x20','coinToPayService','startPeriodicStatusCheck','424rsZHev','default','1038udZiIB','stopPeriodicStatusCheck','failed','logWhiteDomainError','ðŸª™\x20Checking\x20','13820VkJiIY','bankDetails','push','cointopay','Failed\x20to\x20check\x20payment\x20','loggerService','coinToPayStatusService','gateway','iban','createdOn','logShopWebhookError','513572uyaGyJ','checkSinglePayment','setDate','CHECK_INTERVAL_MS','application/json','stringify','Periodic\x20CoinToPay\x20status\x20check\x20failed:','not\x20found','created','unknown','checkInterval','sendPaymentNotification','EXPIRED','53746scRuQV','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','cointopay_status_check_error','\x20days\x20(created\x20before\x20','amount','toISOString','shopId','./gateways/coinToPayService','ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','11DOoNXb','getServiceStats','createdAt','cointopay_status_check_','log','findMany','EXPIRY_DAYS','confirmedOn','gatewayOrderId','settings','TesSoft\x20Payment\x20System/1.0','transactionId','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','âœ…\x20Transaction\x20confirmed\x20on:\x20','not\x20confirmed','now','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','webhookLog','ðŸ”„\x20Updating\x20payment\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','payment','3KEmoiv','error','\x20pending\x20CoinToPay\x20payments','includes','ðŸ¦\x20Saved\x20IBAN:\x20','orderId','customerName','message','logShopWebhookSent','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','payment.failed','gatewayPaymentId','PENDING','2858370RVGXhi','length','webhookUrl','ms)','\x20days','webhook_send','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','1077826yoRcHe','cointopay_auto_expired','âœ…\x20Completed\x20checking\x20','checkAllPendingPayments','9wFhutt','checkExpiredPayments','paymentDetails','Failed\x20to\x20expire\x20payment\x20','defineProperty','adminNotes','2267216UrsKVB','7994796UHvRNl','currency','â°\x20Found\x20','CoinToPayStatusService','\x20not\x20enabled\x20for\x20shop\x20','create','paidAt'];a35_0x2493=function(){return _0x2dd3e5;};return a35_0x2493();}exports[a35_0x233282(0x176)]=CoinToPayStatusService,exports[a35_0x233282(0x1a6)]=new CoinToPayStatusService();