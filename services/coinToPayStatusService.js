'use strict';const a37_0x1acefc=a37_0x1948;(function(_0xe84ec6,_0x5e4083){const _0x19669e=a37_0x1948,_0x1f928a=_0xe84ec6();while(!![]){try{const _0x1fa3f7=-parseInt(_0x19669e(0x1d2))/0x1+-parseInt(_0x19669e(0x1fc))/0x2+parseInt(_0x19669e(0x245))/0x3*(-parseInt(_0x19669e(0x1ae))/0x4)+parseInt(_0x19669e(0x273))/0x5+-parseInt(_0x19669e(0x242))/0x6+parseInt(_0x19669e(0x267))/0x7+-parseInt(_0x19669e(0x268))/0x8*(-parseInt(_0x19669e(0x244))/0x9);if(_0x1fa3f7===_0x5e4083)break;else _0x1f928a['push'](_0x1f928a['shift']());}catch(_0x9b2b1e){_0x1f928a['push'](_0x1f928a['shift']());}}}(a37_0x1d81,0xddfe7));var __importDefault=this&&this[a37_0x1acefc(0x211)]||function(_0x2c0cf1){const _0x14e4ad=a37_0x1acefc;return _0x2c0cf1&&_0x2c0cf1[_0x14e4ad(0x208)]?_0x2c0cf1:{'default':_0x2c0cf1};};function a37_0x1948(_0x3a2970,_0x22f7c6){const _0x1d811d=a37_0x1d81();return a37_0x1948=function(_0x19486d,_0x4d9565){_0x19486d=_0x19486d-0x1ac;let _0x52251e=_0x1d811d[_0x19486d];return _0x52251e;},a37_0x1948(_0x3a2970,_0x22f7c6);}Object[a37_0x1acefc(0x207)](exports,a37_0x1acefc(0x208),{'value':!![]}),exports[a37_0x1acefc(0x1b4)]=exports[a37_0x1acefc(0x1bf)]=void 0x0;function a37_0x1d81(){const _0x26bcf6=['createdOn','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','‚ùå\x20[HOURLY]\x20Payment\x20','webhookEvents','gatewayPaymentId','checkAllPendingPayments','paymentDetails','\x20\x20\x20üìä\x20Status:\x20',',\x20clearing\x20individual\x20timers','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','iban','log','delay','\x20to\x20','TesSoft\x20Payment\x20System/1.0','Automatically\x20expired\x20after\x20','checkPaymentStatus','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','COINTOPAY_STATUS_CHANGE','üßπ\x20[CHECK]\x20Payment\x20','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20triggered\x20for\x20payment\x20','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','\x20\x20\x20-\x20gatewayPaymentId:\x20','sendPaymentStatusNotification','4HEsghp','status','\x20expired\x20CoinToPay\x20payments','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','gatewayOrderId','coinToPayStatusService','-day\x20timeout','\x20not\x20found\x20in\x20database','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','shop','\x20status\x20is\x20','push','\x20days','length','values','\x20status\x20changed\x20to\x20','CoinToPayStatusService','forEach','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','message','‚è∞\x20[HOURLY]\x20Payment\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','logCoinToPayStatus','error','created','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20found:','\x20expired','findMany','application/json','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','schedulePaymentChecks','GLOBAL_CHECK_INTERVAL_MS','adminNotes','\x20days\x20without\x20payment\x20confirmation','1613928UQJZeB','amount','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20\x20\x20üìÖ\x20Time:\x20','\x20(age:\x20','getPaymentTimerInfo','floor','\x20marked\x20as\x20paid\x20at:\x20','\x20updated\x20successfully','h),\x20skipping\x20global\x20check','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','get','üí∞\x20[CHECK]\x20Payment\x20','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','PENDING','\x20initial\x20timers\x20for\x20payment\x20','‚è∞\x20[GLOBAL]\x20Payment\x20','shopId','findUnique','auto_expire','webhookUrl','customerName','logCoinToPayError','\x20pending\x20CoinToPay\x20payments','../config/database','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','üìä\x20[CHECK]\x20Payment\x20','paymentTimers','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','bankDetails','webhookLog','\x20details:','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','startPeriodicStatusCheck','\x20individual\x20payment\x20timers','createdAt','üßπ\x20[DEBUG]\x20Clearing\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','settings','2421182ijRzhX','\x20timers\x20for\x20payment\x20','ms)','logWhiteDomainError','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','checkSinglePaymentById','size','stringify','payment.pending','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','defineProperty','__esModule','\x20\x20\x20üìù\x20Context:','description','cointopay','logShopWebhookError','paid','\x20current\x20status:\x20','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','customerEmail','__importDefault','Failed\x20to\x20send\x20shop\x20webhook:','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20status\x20unchanged\x20(','orderId','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20(after\x20','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','default','update',',\x20stopping\x20individual\x20checks','\x20\x20\x20üìç\x20Source:\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','getTime','\x20has\x20no\x20gatewayPaymentId','Bank\x20Details:\x20','\x20->\x20','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','Payment\x20older\x20than\x20','PAID','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','/status/','paidAt','catch','CoinToPayService','Payment\x20not\x20found','payment.failed','map','\x20is\x20too\x20new\x20(','EXPIRED','checkSinglePayment','checkExpiredPayments','timestamp','\x20days,\x20marking\x20as\x20EXPIRED','toLowerCase','\x20\x20\x20-\x20ShopId:\x20','\x20seconds\x20(','expired','‚úÖ\x20[EXPIRY]\x20Payment\x20','confirmedOn','üõë\x20[SHUTDOWN]\x20Cleared\x20','loggerService','\x20is\x20valid\x20for\x20checking,\x20proceeding...','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','cointopay_auto_expired','unknown','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','cointopay_status_check_error','942408OzrMVz','EXPIRY_DAYS','108ZSDdiG','322539ZyhCwm','sendShopWebhook','POST','remitterIban','coinToPayService','globalCheckInterval','‚úÖ\x20[HOURLY]\x20Payment\x20','delete','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','not\x20found','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','./loggerService','ü™ô\x20CoinToPayStatusService\x20initialized','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','transactionId','COINTOPAY_ERROR','clearPaymentTimers','has','FAILED','includes','toFixed','timers','\x20not\x20enabled\x20for\x20shop\x20','telegramBotService','now','\x20completed\x20for\x20payment\x20','Unknown\x20error','‚è∞\x20[GLOBAL]\x20Found\x20','gateway','5\x20minutes','status_check','\x20days\x20(created\x20before\x20','6395613dPQLlj','1426024UHmios','\x20\x20\x20üìù\x20Details:','2\x20minutes','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','\x20is\x20older\x20than\x20','sendPaymentNotification','\x20with\x20status\x20','payment.success','\x20for\x20payment\x20','toISOString','‚úÖ\x20[CHECK]\x20Payment\x20','4728460GFwtDg','schedule_created','1\x20minute','payment','create','paymentId','getServiceStats','currency','cointopay_status_check_','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'];a37_0x1d81=function(){return _0x26bcf6;};return a37_0x1d81();}const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a37_0x1acefc(0x1eb))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a37_0x1acefc(0x252));class CoinToPayStatusService{constructor(){const _0x5557ca=a37_0x1acefc;this[_0x5557ca(0x24a)]=null,this[_0x5557ca(0x1cf)]=0x3c*0x3c*0x3e8,this[_0x5557ca(0x243)]=0x5,this[_0x5557ca(0x1ee)]=new Map(),this[_0x5557ca(0x249)]=new coinToPayService_1[(_0x5557ca(0x22a))](),console[_0x5557ca(0x288)](_0x5557ca(0x253));}[a37_0x1acefc(0x1ce)](_0x442b0f,_0x5c0090){const _0x698d1a=a37_0x1acefc;console[_0x698d1a(0x288)](_0x698d1a(0x1b2)),console[_0x698d1a(0x288)]('\x20\x20\x20-\x20paymentId:\x20'+_0x442b0f),console[_0x698d1a(0x288)](_0x698d1a(0x1ac)+_0x5c0090),this[_0x698d1a(0x257)](_0x442b0f);const _0x4385d8=[],_0x215ac6=new Date(),_0x111b0c=[{'delay':0x1*0x3c*0x3e8,'description':_0x698d1a(0x275)},{'delay':0x2*0x3c*0x3e8,'description':_0x698d1a(0x26a)},{'delay':0x5*0x3c*0x3e8,'description':_0x698d1a(0x264)},{'delay':0x5*0x3c*0x3e8,'description':_0x698d1a(0x264)}];console['log']('ü™ô\x20[DEBUG]\x20Creating\x20'+_0x111b0c[_0x698d1a(0x1bc)]+_0x698d1a(0x1e2)+_0x442b0f);let _0x5e2837=0x0;_0x111b0c['forEach']((_0x2578a0,_0x43b3e0)=>{const _0x2bf6f1=_0x698d1a;_0x5e2837+=_0x2578a0[_0x2bf6f1(0x289)];const _0x2f773b=setTimeout(async()=>{const _0x7530cc=_0x2bf6f1;console[_0x7530cc(0x288)](_0x7530cc(0x28e)+(_0x43b3e0+0x1)+_0x7530cc(0x292)+_0x442b0f+_0x7530cc(0x217)+_0x2578a0[_0x7530cc(0x20a)]+')');try{await this['checkSinglePaymentById'](_0x442b0f),console[_0x7530cc(0x288)](_0x7530cc(0x20f)+(_0x43b3e0+0x1)+_0x7530cc(0x260)+_0x442b0f);}catch(_0x1222be){console[_0x7530cc(0x1c6)](_0x7530cc(0x293)+(_0x43b3e0+0x1)+'\x20for\x20payment\x20'+_0x442b0f+':',_0x1222be),this['logCoinToPayError'](_0x442b0f,_0x5c0090,_0x1222be,_0x7530cc(0x265),{'checkNumber':_0x43b3e0+0x1,'scheduledAfter':_0x2578a0[_0x7530cc(0x20a)],'isIndividualCheck':!![]});}},_0x5e2837);_0x4385d8[_0x2bf6f1(0x1ba)](_0x2f773b),console[_0x2bf6f1(0x288)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x43b3e0+0x1)+_0x2bf6f1(0x270)+_0x442b0f+'\x20in\x20'+_0x5e2837/0x3e8+_0x2bf6f1(0x236)+_0x2578a0[_0x2bf6f1(0x20a)]+')');});const _0x836a04=setInterval(async()=>{const _0x4db018=_0x698d1a;console[_0x4db018(0x288)]('ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x442b0f);try{const _0x581d66=await database_1[_0x4db018(0x21a)][_0x4db018(0x276)][_0x4db018(0x1e5)]({'where':{'id':_0x442b0f},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x581d66){console['log'](_0x4db018(0x27f)+_0x442b0f+'\x20not\x20found,\x20clearing\x20timers'),this[_0x4db018(0x257)](_0x442b0f);return;}console[_0x4db018(0x288)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x442b0f+_0x4db018(0x20e)+_0x581d66['status']);if(_0x581d66[_0x4db018(0x1af)]!==_0x4db018(0x1e1)){console[_0x4db018(0x288)](_0x4db018(0x24b)+_0x442b0f+_0x4db018(0x1b9)+_0x581d66[_0x4db018(0x1af)]+_0x4db018(0x21c)),this[_0x4db018(0x257)](_0x442b0f);return;}const _0x1188fc=Math['floor']((Date[_0x4db018(0x25f)]()-_0x581d66[_0x4db018(0x1f8)][_0x4db018(0x21f)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1188fc>=this[_0x4db018(0x243)]){console['log'](_0x4db018(0x1c3)+_0x442b0f+_0x4db018(0x26c)+this['EXPIRY_DAYS']+_0x4db018(0x216)),this['clearPaymentTimers'](_0x442b0f);return;}await this[_0x4db018(0x202)](_0x442b0f),console[_0x4db018(0x288)](_0x4db018(0x223)+_0x442b0f);}catch(_0x167913){console['error'](_0x4db018(0x1ec)+_0x442b0f+':',_0x167913),this['logCoinToPayError'](_0x442b0f,_0x5c0090,_0x167913,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x4385d8[_0x698d1a(0x1ba)](_0x836a04),this[_0x698d1a(0x1ee)]['set'](_0x442b0f,{'timers':_0x4385d8,'paymentId':_0x442b0f,'gatewayPaymentId':_0x5c0090,'createdAt':_0x215ac6}),console[_0x698d1a(0x288)](_0x698d1a(0x1f0)+_0x111b0c[_0x698d1a(0x1bc)]+_0x698d1a(0x1b7)+_0x442b0f),console[_0x698d1a(0x288)]('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x698d1a(0x1ee)]['size']),this['logCoinToPayStatus'](_0x442b0f,_0x5c0090,_0x698d1a(0x1e1),_0x698d1a(0x1e1),_0x698d1a(0x265),{'action':_0x698d1a(0x274),'scheduledChecks':_0x111b0c[_0x698d1a(0x1bc)],'firstCheckIn':_0x111b0c[0x0][_0x698d1a(0x289)]/0x3e8,'totalTimers':this['paymentTimers'][_0x698d1a(0x203)]});}[a37_0x1acefc(0x257)](_0x454545){const _0x95e46d=a37_0x1acefc,_0x35291c=this[_0x95e46d(0x1ee)][_0x95e46d(0x1de)](_0x454545);_0x35291c?(console[_0x95e46d(0x288)](_0x95e46d(0x1f9)+_0x35291c['timers']['length']+_0x95e46d(0x1fd)+_0x454545),_0x35291c['timers'][_0x95e46d(0x1c0)]((_0x45d477,_0x394e5f)=>{const _0x1a69ef=_0x95e46d;_0x45d477&&(clearTimeout(_0x45d477),clearInterval(_0x45d477),console[_0x1a69ef(0x288)](_0x1a69ef(0x206)+(_0x394e5f+0x1)+_0x1a69ef(0x270)+_0x454545));}),this[_0x95e46d(0x1ee)][_0x95e46d(0x24c)](_0x454545),console[_0x95e46d(0x288)](_0x95e46d(0x24d)+_0x454545+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x95e46d(0x1ee)][_0x95e46d(0x203)])):console[_0x95e46d(0x288)](_0x95e46d(0x1b1)+_0x454545+'\x20to\x20clear');}async['checkSinglePaymentById'](_0x5d3349){const _0x42cbd3=a37_0x1acefc;console[_0x42cbd3(0x288)](_0x42cbd3(0x1c8)+_0x5d3349);const _0x464767=await database_1[_0x42cbd3(0x21a)][_0x42cbd3(0x276)][_0x42cbd3(0x1e5)]({'where':{'id':_0x5d3349},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x464767){console[_0x42cbd3(0x288)]('‚ùå\x20[CHECK]\x20Payment\x20'+_0x5d3349+_0x42cbd3(0x1b6));return;}console[_0x42cbd3(0x288)](_0x42cbd3(0x1ed)+_0x5d3349+_0x42cbd3(0x1c9)),console['log']('\x20\x20\x20-\x20Gateway:\x20'+_0x464767[_0x42cbd3(0x263)]),console[_0x42cbd3(0x288)]('\x20\x20\x20-\x20Status:\x20'+_0x464767['status']),console[_0x42cbd3(0x288)](_0x42cbd3(0x251)+_0x464767['gatewayPaymentId']),console['log']('\x20\x20\x20-\x20Amount:\x20'+_0x464767['amount']+'\x20'+_0x464767['currency']),console[_0x42cbd3(0x288)](_0x42cbd3(0x235)+_0x464767['shopId']);if(_0x464767['gateway']!==_0x42cbd3(0x20b)){console[_0x42cbd3(0x288)](_0x42cbd3(0x27c)+_0x5d3349+_0x42cbd3(0x27e)+_0x464767[_0x42cbd3(0x263)]+')');return;}if(_0x464767[_0x42cbd3(0x1af)]!==_0x42cbd3(0x1e1)){console[_0x42cbd3(0x288)](_0x42cbd3(0x27c)+_0x5d3349+_0x42cbd3(0x1b9)+_0x464767[_0x42cbd3(0x1af)]+_0x42cbd3(0x21c)),this['clearPaymentTimers'](_0x5d3349);return;}if(!_0x464767['gatewayPaymentId']){console[_0x42cbd3(0x288)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x5d3349+_0x42cbd3(0x220));return;}console[_0x42cbd3(0x288)](_0x42cbd3(0x272)+_0x5d3349+_0x42cbd3(0x23c)),await this[_0x42cbd3(0x230)](_0x464767);}['logCoinToPayStatus'](_0xbaeb16,_0x5cc18a,_0x47a689,_0x36c377,_0x75d756,_0x3fecfd){const _0x31b172=a37_0x1acefc,_0x25870e={'type':_0x31b172(0x28f),'paymentId':_0xbaeb16,'gatewayPaymentId':_0x5cc18a,'oldStatus':_0x47a689,'newStatus':_0x36c377,'source':_0x75d756,'timestamp':new Date()[_0x31b172(0x271)](),'details':_0x3fecfd||{}};loggerService_1['loggerService'][_0x31b172(0x1c5)](_0x25870e),console[_0x31b172(0x288)](_0x31b172(0x21e)+_0xbaeb16+'\x20('+_0x5cc18a+')'),console[_0x31b172(0x288)](_0x31b172(0x284)+_0x47a689+_0x31b172(0x222)+_0x36c377),console[_0x31b172(0x288)]('\x20\x20\x20üìç\x20Source:\x20'+_0x75d756),console[_0x31b172(0x288)](_0x31b172(0x1d6)+_0x25870e[_0x31b172(0x232)]),_0x3fecfd&&console[_0x31b172(0x288)](_0x31b172(0x269),_0x3fecfd);}[a37_0x1acefc(0x1e9)](_0x14b954,_0x5a5f0e,_0x686efb,_0x51148b,_0x2d0d03){const _0x5e7402=a37_0x1acefc,_0x4d452a={'type':_0x5e7402(0x256),'paymentId':_0x14b954,'gatewayPaymentId':_0x5a5f0e,'error':_0x686efb instanceof Error?{'message':_0x686efb[_0x5e7402(0x1c2)],'stack':_0x686efb['stack']}:_0x686efb,'source':_0x51148b,'timestamp':new Date()['toISOString'](),'context':_0x2d0d03||{}};loggerService_1[_0x5e7402(0x23b)][_0x5e7402(0x1e9)](_0x4d452a),console[_0x5e7402(0x1c6)](_0x5e7402(0x240)+_0x14b954+'\x20('+_0x5a5f0e+')'),console[_0x5e7402(0x1c6)]('\x20\x20\x20‚ùå\x20Error:\x20'+(_0x686efb instanceof Error?_0x686efb[_0x5e7402(0x1c2)]:_0x686efb)),console[_0x5e7402(0x1c6)](_0x5e7402(0x21d)+_0x51148b),console[_0x5e7402(0x1c6)](_0x5e7402(0x1d6)+_0x4d452a[_0x5e7402(0x232)]),_0x2d0d03&&console[_0x5e7402(0x1c6)](_0x5e7402(0x209),_0x2d0d03);}[a37_0x1acefc(0x1f6)](){const _0x1eafb4=a37_0x1acefc;console['log'](_0x1eafb4(0x286)),this['checkAllPendingPayments']()[_0x1eafb4(0x229)](_0x3838cf=>{const _0x1fa557=_0x1eafb4;console[_0x1fa557(0x1c6)]('‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x3838cf);}),this[_0x1eafb4(0x24a)]=setInterval(async()=>{const _0x3a19a9=_0x1eafb4;try{console[_0x3a19a9(0x288)](_0x3a19a9(0x291)),await this[_0x3a19a9(0x282)](),console['log']('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x1b6fb3){console['error'](_0x3a19a9(0x219),_0x1b6fb3);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x1eafb4(0x288)](_0x1eafb4(0x1cd));}['stopPeriodicStatusCheck'](){const _0x5b4ae1=a37_0x1acefc;console[_0x5b4ae1(0x288)](_0x5b4ae1(0x1e0));this[_0x5b4ae1(0x24a)]&&(clearInterval(this[_0x5b4ae1(0x24a)]),this[_0x5b4ae1(0x24a)]=null,console[_0x5b4ae1(0x288)](_0x5b4ae1(0x1fa)));const _0x256596=this[_0x5b4ae1(0x1ee)][_0x5b4ae1(0x203)];for(const [_0x16d5f5]of this[_0x5b4ae1(0x1ee)]){this[_0x5b4ae1(0x257)](_0x16d5f5);}console[_0x5b4ae1(0x288)](_0x5b4ae1(0x23a)+_0x256596+_0x5b4ae1(0x1f7));}async['checkAllPendingPayments'](){const _0x178e1a=a37_0x1acefc;try{console[_0x178e1a(0x288)](_0x178e1a(0x201));const _0x535046=await database_1['default'][_0x178e1a(0x276)][_0x178e1a(0x1cb)]({'where':{'gateway':'cointopay','status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log']('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x535046[_0x178e1a(0x1bc)]+_0x178e1a(0x1ea));if(_0x535046[_0x178e1a(0x1bc)]===0x0){console[_0x178e1a(0x288)]('ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x55a3b4=await this['checkExpiredPayments'](_0x535046);console[_0x178e1a(0x288)](_0x178e1a(0x262)+_0x55a3b4[_0x178e1a(0x1bc)]+_0x178e1a(0x1b0));let _0x4e8ea0=0x0,_0x3c370e=0x0;for(const _0x1681c2 of _0x535046){try{if(_0x55a3b4[_0x178e1a(0x25a)](_0x1681c2['id'])){console[_0x178e1a(0x288)](_0x178e1a(0x1e3)+_0x1681c2['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x3c370e++;continue;}if(this[_0x178e1a(0x1ee)][_0x178e1a(0x258)](_0x1681c2['id'])){console[_0x178e1a(0x288)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x1681c2['id']+_0x178e1a(0x1d5)),_0x3c370e++;continue;}const _0x3902f9=(Date[_0x178e1a(0x25f)]()-_0x1681c2[_0x178e1a(0x1f8)][_0x178e1a(0x21f)]())/(0x3e8*0x3c*0x3c);if(_0x3902f9<0x1){console[_0x178e1a(0x288)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x1681c2['id']+_0x178e1a(0x22e)+_0x3902f9[_0x178e1a(0x25b)](0x1)+_0x178e1a(0x1dc)),_0x3c370e++;continue;}console[_0x178e1a(0x288)](_0x178e1a(0x1f5)+_0x1681c2['id']+_0x178e1a(0x1d7)+_0x3902f9['toFixed'](0x1)+'h)'),await this[_0x178e1a(0x230)](_0x1681c2),_0x4e8ea0++,await new Promise(_0x314c88=>setTimeout(_0x314c88,0x7d0));}catch(_0x13c0e3){console[_0x178e1a(0x1c6)](_0x178e1a(0x200)+_0x1681c2['id']+':',_0x13c0e3),this['logCoinToPayError'](_0x1681c2['id'],_0x1681c2[_0x178e1a(0x281)]||_0x178e1a(0x23f),_0x13c0e3,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x1681c2[_0x178e1a(0x1d3)],'paymentCurrency':_0x1681c2['currency'],'shopId':_0x1681c2[_0x178e1a(0x1e4)],'createdAt':_0x1681c2[_0x178e1a(0x1f8)]}),loggerService_1['loggerService'][_0x178e1a(0x1ff)]('cointopay',_0x178e1a(0x227)+_0x1681c2['gatewayPaymentId'],_0x13c0e3);}}console['log'](_0x178e1a(0x23d)+_0x4e8ea0+'\x20checked,\x20'+_0x3c370e+'\x20skipped,\x20'+_0x55a3b4[_0x178e1a(0x1bc)]+_0x178e1a(0x1ca));}catch(_0x15439b){console[_0x178e1a(0x1c6)](_0x178e1a(0x226),_0x15439b);}}async[a37_0x1acefc(0x231)](_0x3edc31){const _0x32b469=a37_0x1acefc,_0x2035ec=[],_0xdcff02=new Date();_0xdcff02['setDate'](_0xdcff02['getDate']()-this[_0x32b469(0x243)]),console[_0x32b469(0x288)]('‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x32b469(0x243)]+_0x32b469(0x266)+_0xdcff02[_0x32b469(0x271)]()+')');for(const _0x3ebfa8 of _0x3edc31){if(_0x3ebfa8[_0x32b469(0x1f8)]<_0xdcff02){console[_0x32b469(0x288)](_0x32b469(0x1c4)+_0x3ebfa8['id']+_0x32b469(0x26c)+this[_0x32b469(0x243)]+_0x32b469(0x233));try{this[_0x32b469(0x1c5)](_0x3ebfa8['id'],_0x3ebfa8[_0x32b469(0x281)]||_0x32b469(0x23f),_0x32b469(0x1e1),_0x32b469(0x22f),_0x32b469(0x1e6),{'reason':_0x32b469(0x224)+this[_0x32b469(0x243)]+_0x32b469(0x1bb),'createdAt':_0x3ebfa8['createdAt'],'daysSinceCreation':Math[_0x32b469(0x1d9)]((Date[_0x32b469(0x25f)]()-_0x3ebfa8[_0x32b469(0x1f8)][_0x32b469(0x21f)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x3ebfa8[_0x32b469(0x1d3)],'paymentCurrency':_0x3ebfa8['currency'],'shopId':_0x3ebfa8[_0x32b469(0x1e4)]}),await database_1[_0x32b469(0x21a)][_0x32b469(0x276)][_0x32b469(0x21b)]({'where':{'id':_0x3ebfa8['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x32b469(0x28c)+this[_0x32b469(0x243)]+_0x32b469(0x1d1)}}),await database_1['default'][_0x32b469(0x1f2)][_0x32b469(0x277)]({'data':{'paymentId':_0x3ebfa8['id'],'shopId':_0x3ebfa8['shopId'],'event':_0x32b469(0x23e),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x32b469(0x224)+this[_0x32b469(0x243)]+'\x20days','createdAt':_0x3ebfa8[_0x32b469(0x1f8)],'expiredAt':new Date()[_0x32b469(0x271)](),'daysSinceCreation':Math[_0x32b469(0x1d9)]((Date[_0x32b469(0x25f)]()-_0x3ebfa8['createdAt'][_0x32b469(0x21f)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x32b469(0x246)](_0x3ebfa8,_0x32b469(0x22f)),await this['sendPaymentStatusNotification'](_0x3ebfa8,_0x32b469(0x22f)),this[_0x32b469(0x257)](_0x3ebfa8['id']),_0x2035ec[_0x32b469(0x1ba)](_0x3ebfa8['id']),console[_0x32b469(0x288)](_0x32b469(0x238)+_0x3ebfa8['id']+_0x32b469(0x213)+this[_0x32b469(0x243)]+_0x32b469(0x1b5));}catch(_0x5cdfc8){console[_0x32b469(0x1c6)]('‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x3ebfa8['id']+':',_0x5cdfc8),this[_0x32b469(0x1e9)](_0x3ebfa8['id'],_0x3ebfa8['gatewayPaymentId']||_0x32b469(0x23f),_0x5cdfc8,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x3ebfa8[_0x32b469(0x1f8)],'daysSinceCreation':Math[_0x32b469(0x1d9)]((Date[_0x32b469(0x25f)]()-_0x3ebfa8[_0x32b469(0x1f8)][_0x32b469(0x21f)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x2035ec;}async[a37_0x1acefc(0x230)](_0x565c84){const _0x423449=a37_0x1acefc;if(!_0x565c84[_0x423449(0x281)]){console[_0x423449(0x288)](_0x423449(0x27c)+_0x565c84['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x423449(0x288)]('üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x565c84['id']+'\x20('+_0x565c84[_0x423449(0x281)]+')');try{const _0x27ed8c=await this[_0x423449(0x249)][_0x423449(0x28d)](_0x565c84[_0x423449(0x281)]);console['log']('üìä\x20[CHECK]\x20Payment\x20'+_0x565c84['id']+'\x20status:\x20'+_0x27ed8c[_0x423449(0x1af)]);_0x27ed8c[_0x423449(0x283)]&&console[_0x423449(0x288)]('üìä\x20[CHECK]\x20Payment\x20'+_0x565c84['id']+_0x423449(0x1f3),{'iban':_0x27ed8c['paymentDetails'][_0x423449(0x287)]||_0x423449(0x24f),'transactionId':_0x27ed8c[_0x423449(0x283)][_0x423449(0x255)],'createdOn':_0x27ed8c['paymentDetails'][_0x423449(0x27d)],'confirmedOn':_0x27ed8c[_0x423449(0x283)][_0x423449(0x239)]||'not\x20confirmed'});if(_0x27ed8c[_0x423449(0x1af)]!==_0x565c84[_0x423449(0x1af)]){console[_0x423449(0x288)](_0x423449(0x26b)+_0x565c84['id']+'\x20status\x20from\x20'+_0x565c84[_0x423449(0x1af)]+_0x423449(0x28a)+_0x27ed8c[_0x423449(0x1af)]),this[_0x423449(0x1c5)](_0x565c84['id'],_0x565c84[_0x423449(0x281)],_0x565c84[_0x423449(0x1af)],_0x27ed8c['status'],_0x423449(0x265),{'paymentDetails':_0x27ed8c[_0x423449(0x283)],'amount':_0x27ed8c[_0x423449(0x1d3)],'currency':_0x27ed8c[_0x423449(0x27a)],'shopId':_0x565c84[_0x423449(0x1e4)],'checkTimestamp':new Date()[_0x423449(0x271)]()});const _0x2d8abc={'status':_0x27ed8c[_0x423449(0x1af)],'updatedAt':new Date()};_0x27ed8c['status']===_0x423449(0x225)&&_0x565c84['status']!==_0x423449(0x225)&&(_0x2d8abc['paidAt']=new Date(),console[_0x423449(0x288)](_0x423449(0x1df)+_0x565c84['id']+_0x423449(0x1da)+_0x2d8abc[_0x423449(0x228)]['toISOString']()));if(_0x27ed8c[_0x423449(0x283)]){const _0x4fb1d0=_0x27ed8c[_0x423449(0x283)];_0x4fb1d0[_0x423449(0x287)]&&(_0x2d8abc[_0x423449(0x248)]=_0x4fb1d0[_0x423449(0x287)],console[_0x423449(0x288)]('üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x4fb1d0[_0x423449(0x287)]));if(_0x4fb1d0[_0x423449(0x1f1)]){const _0x4f1ffb=_0x565c84['adminNotes']||'',_0x33bd7=_0x423449(0x221)+_0x4fb1d0[_0x423449(0x1f1)];_0x2d8abc[_0x423449(0x1d0)]=_0x4f1ffb?_0x4f1ffb+'\x0a\x0a'+_0x33bd7:_0x33bd7,console['log'](_0x423449(0x218));}_0x4fb1d0[_0x423449(0x255)]&&console['log']('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x4fb1d0[_0x423449(0x255)]),_0x4fb1d0['confirmedOn']&&console[_0x423449(0x288)](_0x423449(0x1ef)+_0x4fb1d0[_0x423449(0x239)]);}await database_1[_0x423449(0x21a)][_0x423449(0x276)][_0x423449(0x21b)]({'where':{'id':_0x565c84['id']},'data':_0x2d8abc}),await database_1[_0x423449(0x21a)][_0x423449(0x1f2)][_0x423449(0x277)]({'data':{'paymentId':_0x565c84['id'],'shopId':_0x565c84[_0x423449(0x1e4)],'event':_0x423449(0x27b)+_0x27ed8c[_0x423449(0x1af)][_0x423449(0x234)](),'statusCode':0xc8,'responseBody':JSON[_0x423449(0x204)]({'oldStatus':_0x565c84['status'],'newStatus':_0x27ed8c['status'],'paymentDetails':_0x27ed8c[_0x423449(0x283)],'checkedAt':new Date()[_0x423449(0x271)]()})}}),await this[_0x423449(0x246)](_0x565c84,_0x27ed8c[_0x423449(0x1af)]),await this[_0x423449(0x1ad)](_0x565c84,_0x27ed8c[_0x423449(0x1af)]),_0x27ed8c[_0x423449(0x1af)]!==_0x423449(0x1e1)&&(console[_0x423449(0x288)](_0x423449(0x290)+_0x565c84['id']+_0x423449(0x1be)+_0x27ed8c[_0x423449(0x1af)]+_0x423449(0x285)),this[_0x423449(0x257)](_0x565c84['id'])),console['log'](_0x423449(0x272)+_0x565c84['id']+_0x423449(0x1db));}else console[_0x423449(0x288)](_0x423449(0x1ed)+_0x565c84['id']+_0x423449(0x214)+_0x27ed8c['status']+')'),this['logCoinToPayStatus'](_0x565c84['id'],_0x565c84['gatewayPaymentId'],_0x565c84[_0x423449(0x1af)],_0x27ed8c[_0x423449(0x1af)],_0x423449(0x265),{'statusUnchanged':!![],'paymentDetails':_0x27ed8c[_0x423449(0x283)],'amount':_0x27ed8c['amount'],'currency':_0x27ed8c['currency'],'shopId':_0x565c84['shopId'],'checkTimestamp':new Date()['toISOString']()});}catch(_0x4c6b78){console['error'](_0x423449(0x1dd)+_0x565c84['id']+':',_0x4c6b78),this[_0x423449(0x1e9)](_0x565c84['id'],_0x565c84[_0x423449(0x281)],_0x4c6b78,_0x423449(0x265),{'paymentAmount':_0x565c84[_0x423449(0x1d3)],'paymentCurrency':_0x565c84[_0x423449(0x27a)],'shopId':_0x565c84['shopId'],'createdAt':_0x565c84[_0x423449(0x1f8)]}),await database_1[_0x423449(0x21a)][_0x423449(0x1f2)][_0x423449(0x277)]({'data':{'paymentId':_0x565c84['id'],'shopId':_0x565c84[_0x423449(0x1e4)],'event':_0x423449(0x241),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x4c6b78 instanceof Error?_0x4c6b78[_0x423449(0x1c2)]:_0x423449(0x261),'gatewayPaymentId':_0x565c84[_0x423449(0x281)],'checkedAt':new Date()[_0x423449(0x271)]()})}});}}async['sendShopWebhook'](_0x4e6a48,_0x9c21b4){const _0x38f240=a37_0x1acefc,_0x1cdf49=Date[_0x38f240(0x25f)]();try{const _0x2ab5cf=_0x4e6a48['shop'],_0x591077=_0x2ab5cf[_0x38f240(0x1fb)];if(!_0x591077?.[_0x38f240(0x1e7)]){console[_0x38f240(0x288)](_0x38f240(0x1c1)+_0x2ab5cf['id']);return;}const _0x1fa1c4=_0x9c21b4===_0x38f240(0x225)?_0x38f240(0x26f):_0x9c21b4===_0x38f240(0x259)?_0x38f240(0x22c):_0x9c21b4===_0x38f240(0x22f)?_0x38f240(0x22c):_0x38f240(0x205);if(!_0x591077[_0x38f240(0x280)]?.[_0x38f240(0x25a)](_0x1fa1c4)){console[_0x38f240(0x288)]('Webhook\x20event\x20'+_0x1fa1c4+_0x38f240(0x25d)+_0x2ab5cf['id']);return;}const _0x5651fe={'event':_0x1fa1c4,'payment':{'id':_0x4e6a48['id'],'order_id':_0x4e6a48[_0x38f240(0x215)],'gateway_order_id':_0x4e6a48[_0x38f240(0x1b3)],'gateway':'0100','amount':_0x4e6a48[_0x38f240(0x1d3)],'currency':_0x4e6a48[_0x38f240(0x27a)],'status':_0x9c21b4[_0x38f240(0x234)](),'customer_email':_0x4e6a48[_0x38f240(0x210)],'customer_name':_0x4e6a48[_0x38f240(0x1e8)],'created_at':_0x4e6a48[_0x38f240(0x1f8)],'updated_at':new Date()}},_0x504ce1=await fetch(_0x591077['webhookUrl'],{'method':_0x38f240(0x247),'headers':{'Content-Type':_0x38f240(0x1cc),'User-Agent':_0x38f240(0x28b)},'body':JSON[_0x38f240(0x204)](_0x5651fe)}),_0x1432fd=Date['now']()-_0x1cdf49,_0x4f8fc0=_0x504ce1['ok']?'Success':await _0x504ce1['text']();loggerService_1[_0x38f240(0x23b)]['logShopWebhookSent'](_0x4e6a48[_0x38f240(0x1e4)],_0x591077['webhookUrl'],_0x1fa1c4,_0x504ce1[_0x38f240(0x1af)],_0x1432fd,_0x5651fe),console[_0x38f240(0x288)]('Shop\x20webhook\x20sent\x20to\x20'+_0x591077[_0x38f240(0x1e7)]+_0x38f240(0x26e)+_0x504ce1[_0x38f240(0x1af)]+'\x20('+_0x1432fd+_0x38f240(0x1fe));}catch(_0x32f5d7){console['error'](_0x38f240(0x212),_0x32f5d7),loggerService_1[_0x38f240(0x23b)][_0x38f240(0x20c)](_0x4e6a48['shopId'],_0x4e6a48[_0x38f240(0x1b8)]?.[_0x38f240(0x1fb)]?.[_0x38f240(0x1e7)]||_0x38f240(0x23f),'webhook_send',_0x32f5d7,{});}}async[a37_0x1acefc(0x1ad)](_0x118190,_0x7e923){const _0x5ede49=a37_0x1acefc;try{const _0x472f14={'PENDING':_0x5ede49(0x1c7),'PAID':_0x5ede49(0x20d),'FAILED':'failed','EXPIRED':_0x5ede49(0x237)},_0x21bc73=_0x472f14[_0x7e923];if(!_0x21bc73||_0x21bc73==='created')return;await telegramBotService_1[_0x5ede49(0x25e)][_0x5ede49(0x26d)](_0x118190[_0x5ede49(0x1e4)],_0x118190,_0x21bc73);}catch(_0x14b009){console[_0x5ede49(0x1c6)](_0x5ede49(0x24e),_0x14b009);}}async['checkPaymentById'](_0x450760){const _0x69b605=a37_0x1acefc;console[_0x69b605(0x288)](_0x69b605(0x1f4)+_0x450760);const _0x2fdb69=await database_1[_0x69b605(0x21a)][_0x69b605(0x276)]['findUnique']({'where':{'id':_0x450760},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2fdb69)throw new Error(_0x69b605(0x22b));if(_0x2fdb69[_0x69b605(0x263)]!==_0x69b605(0x20b))throw new Error(_0x69b605(0x1d4));console[_0x69b605(0x288)](_0x69b605(0x250)+_0x450760),await this[_0x69b605(0x230)](_0x2fdb69),console[_0x69b605(0x288)](_0x69b605(0x254)+_0x450760);}[a37_0x1acefc(0x279)](){const _0x529554=a37_0x1acefc,_0x419b1f=this['globalCheckInterval']?this[_0x529554(0x1cf)]:undefined,_0x4c564e=Array['from'](this[_0x529554(0x1ee)][_0x529554(0x1bd)]())[_0x529554(0x22d)](_0xd211a6=>({'paymentId':_0xd211a6[_0x529554(0x278)],'gatewayPaymentId':_0xd211a6[_0x529554(0x281)],'createdAt':_0xd211a6[_0x529554(0x1f8)],'timersCount':_0xd211a6['timers'][_0x529554(0x1bc)]}));return{'isActive':!!this[_0x529554(0x24a)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x529554(0x243)],'activeIndividualTimers':this[_0x529554(0x1ee)][_0x529554(0x203)],'nextGlobalCheckIn':_0x419b1f,'paymentTimersDetails':_0x4c564e};}[a37_0x1acefc(0x1d8)](_0x563e05){const _0x334e7b=a37_0x1acefc,_0x1b4c15=this['paymentTimers'][_0x334e7b(0x1de)](_0x563e05);if(_0x1b4c15)return{'hasTimers':!![],'timersCount':_0x1b4c15[_0x334e7b(0x25c)][_0x334e7b(0x1bc)],'createdAt':_0x1b4c15[_0x334e7b(0x1f8)],'gatewayPaymentId':_0x1b4c15[_0x334e7b(0x281)]};return{'hasTimers':![]};}}exports[a37_0x1acefc(0x1bf)]=CoinToPayStatusService,exports[a37_0x1acefc(0x1b4)]=new CoinToPayStatusService();