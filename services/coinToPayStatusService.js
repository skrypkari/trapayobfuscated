'use strict';const a37_0xe439a4=a37_0x5461;(function(_0x5ff024,_0xc3d0d){const _0x2a64e5=a37_0x5461,_0x2177be=_0x5ff024();while(!![]){try{const _0x410d00=parseInt(_0x2a64e5(0x14d))/0x1*(parseInt(_0x2a64e5(0x120))/0x2)+parseInt(_0x2a64e5(0x1be))/0x3+parseInt(_0x2a64e5(0x134))/0x4*(parseInt(_0x2a64e5(0x13e))/0x5)+-parseInt(_0x2a64e5(0x170))/0x6*(-parseInt(_0x2a64e5(0x16d))/0x7)+-parseInt(_0x2a64e5(0xfd))/0x8+parseInt(_0x2a64e5(0x177))/0x9*(parseInt(_0x2a64e5(0x13c))/0xa)+-parseInt(_0x2a64e5(0x1a9))/0xb;if(_0x410d00===_0xc3d0d)break;else _0x2177be['push'](_0x2177be['shift']());}catch(_0x60d8de){_0x2177be['push'](_0x2177be['shift']());}}}(a37_0x36cd,0x8e9c7));var __importDefault=this&&this[a37_0xe439a4(0x1b9)]||function(_0x292875){const _0xa17993=a37_0xe439a4;return _0x292875&&_0x292875[_0xa17993(0x132)]?_0x292875:{'default':_0x292875};};Object[a37_0xe439a4(0x1c3)](exports,a37_0xe439a4(0x132),{'value':!![]}),exports[a37_0xe439a4(0x121)]=exports[a37_0xe439a4(0x1bf)]=void 0x0;function a37_0x36cd(){const _0x1c428a=['✅\x20[CHECK]\x20Payment\x20','confirmedOn','COINTOPAY_ERROR','139237geLuUM','getTime','logCoinToPayStatus','🪙\x20[TIMER]\x20Individual\x20check\x20#','status_check','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','\x20has\x20no\x20gatewayPaymentId,\x20skipping','createdOn','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','expired','PAID','create','\x20is\x20too\x20new\x20(','loggerService','\x20days','checkPaymentStatus','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','✅\x20[HOURLY]\x20Payment\x20',',\x20stopping\x20individual\x20checks','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','bankDetails','stringify','\x20payment\x20','\x20status:\x20','\x20\x20\x20-\x20ShopId:\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20status\x20is\x20','checkSinglePayment','toFixed','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20with\x20status\x20','12999nbNpQz','startPeriodicStatusCheck','createdAt','2658wLzemu','🛑\x20[SHUTDOWN]\x20Cleared\x20','getDate','\x20checked,\x20','size','paymentDetails','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','9WrfLTa','not\x20confirmed','transactionId','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','FAILED','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20is\x20older\x20than\x20','shopId','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20for\x20payment\x20','\x20->\x20','2\x20minutes','remitterIban','🪙\x20[DEBUG]\x20Creating\x20','Success','5\x20minutes','auto_expire','get','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','application/json','\x20status\x20from\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','CoinToPay2Service','webhookEvents','update','\x20not\x20enabled\x20for\x20shop\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','../config/database','setDate','length','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20\x20\x20📝\x20Details:','unknown','\x20individual\x20payment\x20timers','✅\x20[EXPIRY]\x20Payment\x20','🔄\x20[CHECK]\x20Updating\x20payment\x20','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','webhookLog','⏰\x20[EXPIRY]\x20Payment\x20','push','webhook_send','globalCheckInterval','gateway','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','timestamp','customerName','catch','⚠️\x20[CHECK]\x20Payment\x20','failed','33050732zkrTLC','logCoinToPayError','not\x20found','\x20expired\x20CoinToPay\x20payments','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20days\x20without\x20payment\x20confirmation','CoinToPayService','\x20\x20\x20📅\x20Time:\x20','Payment\x20older\x20than\x20','\x20seconds\x20(','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','adminNotes','__importDefault','schedulePaymentChecks','gatewayPaymentId','payment.failed','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','2611221IHhFwV','CoinToPayStatusService','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','getPaymentTimerInfo','COINTOPAY_STATUS_CHANGE','defineProperty','sendPaymentNotification','\x20not\x20found,\x20clearing\x20timers','schedule_created','amount','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20\x20\x20❌\x20Error:\x20','\x20found:','✅\x20[TIMER]\x20Individual\x20check\x20#','getServiceStats','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','checkAllPendingPayments','\x20status\x20unchanged\x20(','EXPIRED','\x20details:','\x20current\x20status:\x20','./telegramBotService','coinToPayService','delay','payment','logShopWebhookSent','TesSoft\x20Payment\x20System/1.0','\x20\x20\x20-\x20Amount:\x20','message','\x20not\x20found\x20in\x20database','\x20to\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','shop','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','sendPaymentStatusNotification','\x20completed\x20for\x20payment\x20','ms)','💰\x20[CHECK]\x20Payment\x20','created','stack','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','1\x20minute','h),\x20skipping\x20global\x20check','toISOString','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','🔍\x20[CHECK]\x20Checking\x20','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','⏰\x20[GLOBAL]\x20Payment\x20','📊\x20[CHECK]\x20Payment\x20','\x20(age:\x20','🧹\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','989528cOpcrh','🧹\x20[DEBUG]\x20Clearing\x20','🪙\x20[GLOBAL]\x20Found\x20','❌\x20[CHECK]\x20Payment\x20','toLowerCase','iban','forEach','error','status','checkSinglePaymentById','cointopay2','telegramBotService','now','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','default','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','text','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','settings','\x20in\x20','getGatewayIdByName','.\x20Remaining\x20active\x20timers:\x20','checkExpiredPayments','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20timers\x20for\x20payment\x20','webhookUrl','clearPaymentTimers','-day\x20timeout','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','payment.pending','GLOBAL_CHECK_INTERVAL_MS','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','floor','orderId','cointopay','6oagMmL','coinToPayStatusService','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20days\x20(created\x20before\x20','\x20\x20\x20📊\x20Status:\x20','gatewayOrderId','\x20\x20\x20-\x20GatewayPaymentId:\x20','paymentTimers','values','\x20\x20\x20-\x20Status:\x20','Failed\x20to\x20send\x20shop\x20webhook:','map','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','Webhook\x20event\x20','\x20marked\x20as\x20paid\x20at:\x20','set','findMany','includes','__esModule','paidAt','327184LjWyeD','PENDING','log','paymentId','\x20\x20\x20📝\x20Context:','findUnique','./gateways/coinToPay2Service','sendShopWebhook','6201170QPbRCE','delete','60OeoETv','from','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20has\x20no\x20gatewayPaymentId','currency','EXPIRY_DAYS','Failed\x20to\x20mark\x20payment\x20as\x20expired',',\x20clearing\x20individual\x20timers','\x20(after\x20','../types/gateway','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','\x20pending\x20CoinToPay\x20payments'];a37_0x36cd=function(){return _0x1c428a;};return a37_0x36cd();}const coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a37_0xe439a4(0x13a)),gateway_1=require(a37_0xe439a4(0x147)),database_1=__importDefault(require(a37_0xe439a4(0x193))),telegramBotService_1=require(a37_0xe439a4(0x1d3)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x44de4b=a37_0xe439a4;this['globalCheckInterval']=null,this[_0x44de4b(0x11b)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x44de4b(0x127)]=new Map(),this[_0x44de4b(0x1d4)]=new coinToPayService_1[(_0x44de4b(0x1b3))](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x44de4b(0x18e))](),console['log'](_0x44de4b(0x10a));}[a37_0xe439a4(0x1ba)](_0x56318b,_0x2a3400){const _0x3180d4=a37_0xe439a4;console[_0x3180d4(0x136)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x3180d4(0x136)]('\x20\x20\x20-\x20paymentId:\x20'+_0x56318b),console[_0x3180d4(0x136)](_0x3180d4(0xfc)+_0x2a3400),this[_0x3180d4(0x117)](_0x56318b);const _0x386d36=[],_0xdafad9=new Date(),_0x1d3c97=[{'delay':0x1*0x3c*0x3e8,'description':_0x3180d4(0xf1)},{'delay':0x2*0x3c*0x3e8,'description':_0x3180d4(0x183)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x3180d4(0x187)}];console[_0x3180d4(0x136)](_0x3180d4(0x185)+_0x1d3c97[_0x3180d4(0x195)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x56318b);let _0x213b71=0x0;_0x1d3c97[_0x3180d4(0x103)]((_0x1ebac7,_0x291212)=>{const _0x11fef8=_0x3180d4;_0x213b71+=_0x1ebac7[_0x11fef8(0x1d5)];const _0x22e3e7=setTimeout(async()=>{const _0x30f7ca=_0x11fef8;console[_0x30f7ca(0x136)](_0x30f7ca(0x150)+(_0x291212+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x56318b+_0x30f7ca(0x146)+_0x1ebac7['description']+')');try{await this[_0x30f7ca(0x106)](_0x56318b),console['log'](_0x30f7ca(0x1cb)+(_0x291212+0x1)+_0x30f7ca(0xeb)+_0x56318b);}catch(_0x46f4e7){console[_0x30f7ca(0x104)](_0x30f7ca(0x161)+(_0x291212+0x1)+_0x30f7ca(0x181)+_0x56318b+':',_0x46f4e7),this['logCoinToPayError'](_0x56318b,_0x2a3400,_0x46f4e7,_0x30f7ca(0x151),{'checkNumber':_0x291212+0x1,'scheduledAfter':_0x1ebac7['description'],'isIndividualCheck':!![]});}},_0x213b71);_0x386d36[_0x11fef8(0x19f)](_0x22e3e7),console[_0x11fef8(0x136)](_0x11fef8(0xf7)+(_0x291212+0x1)+_0x11fef8(0x181)+_0x56318b+_0x11fef8(0x110)+_0x213b71/0x3e8+_0x11fef8(0x1b6)+_0x1ebac7['description']+')');});const _0x47c50d=setInterval(async()=>{const _0x13209a=_0x3180d4;console['log'](_0x13209a(0x15e)+_0x56318b);try{const _0x460702=await database_1[_0x13209a(0x10b)][_0x13209a(0xe0)][_0x13209a(0x139)]({'where':{'id':_0x56318b},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x460702){console[_0x13209a(0x136)]('❌\x20[HOURLY]\x20Payment\x20'+_0x56318b+_0x13209a(0x1c5)),this[_0x13209a(0x117)](_0x56318b);return;}console[_0x13209a(0x136)]('📊\x20[HOURLY]\x20Payment\x20'+_0x56318b+_0x13209a(0x1d2)+_0x460702[_0x13209a(0x105)]);if(_0x460702[_0x13209a(0x105)]!==_0x13209a(0x135)){console[_0x13209a(0x136)](_0x13209a(0x15f)+_0x56318b+'\x20status\x20is\x20'+_0x460702[_0x13209a(0x105)]+_0x13209a(0x160)),this['clearPaymentTimers'](_0x56318b);return;}const _0x29135c=Math[_0x13209a(0x11d)]((Date['now']()-_0x460702['createdAt'][_0x13209a(0x14e)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x29135c>=this[_0x13209a(0x143)]){console[_0x13209a(0x136)]('⏰\x20[HOURLY]\x20Payment\x20'+_0x56318b+_0x13209a(0x17e)+this['EXPIRY_DAYS']+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x13209a(0x117)](_0x56318b);return;}await this[_0x13209a(0x106)](_0x56318b),console[_0x13209a(0x136)](_0x13209a(0xf4)+_0x56318b);}catch(_0x3a96cf){console[_0x13209a(0x104)](_0x13209a(0x1c8)+_0x56318b+':',_0x3a96cf),this[_0x13209a(0x1aa)](_0x56318b,_0x2a3400,_0x3a96cf,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x386d36[_0x3180d4(0x19f)](_0x47c50d),this['paymentTimers'][_0x3180d4(0x12f)](_0x56318b,{'timers':_0x386d36,'paymentId':_0x56318b,'gatewayPaymentId':_0x2a3400,'createdAt':_0xdafad9}),console[_0x3180d4(0x136)](_0x3180d4(0x196)+_0x1d3c97[_0x3180d4(0x195)]+_0x3180d4(0x1b7)+_0x56318b),console[_0x3180d4(0x136)](_0x3180d4(0x10e)+this[_0x3180d4(0x127)][_0x3180d4(0x174)]),this[_0x3180d4(0x14f)](_0x56318b,_0x2a3400,'PENDING',_0x3180d4(0x135),_0x3180d4(0x151),{'action':_0x3180d4(0x1c6),'scheduledChecks':_0x1d3c97[_0x3180d4(0x195)],'firstCheckIn':_0x1d3c97[0x0]['delay']/0x3e8,'totalTimers':this[_0x3180d4(0x127)][_0x3180d4(0x174)]});}[a37_0xe439a4(0x117)](_0x2e55cd){const _0x12f335=a37_0xe439a4,_0x38505d=this[_0x12f335(0x127)][_0x12f335(0x189)](_0x2e55cd);_0x38505d?(console[_0x12f335(0x136)](_0x12f335(0xfe)+_0x38505d['timers']['length']+_0x12f335(0x115)+_0x2e55cd),_0x38505d['timers'][_0x12f335(0x103)]((_0x215ece,_0x492c0f)=>{const _0x3000ae=_0x12f335;_0x215ece&&(clearTimeout(_0x215ece),clearInterval(_0x215ece),console[_0x3000ae(0x136)](_0x3000ae(0x119)+(_0x492c0f+0x1)+_0x3000ae(0x181)+_0x2e55cd));}),this[_0x12f335(0x127)][_0x12f335(0x13d)](_0x2e55cd),console[_0x12f335(0x136)](_0x12f335(0x19c)+_0x2e55cd+_0x12f335(0x112)+this[_0x12f335(0x127)]['size'])):console['log'](_0x12f335(0x1a3)+_0x2e55cd+'\x20to\x20clear');}async[a37_0xe439a4(0x106)](_0x56eac5){const _0x5bee93=a37_0xe439a4;console[_0x5bee93(0x136)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x56eac5);const _0x199a8a=await database_1[_0x5bee93(0x10b)]['payment'][_0x5bee93(0x139)]({'where':{'id':_0x56eac5},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x199a8a){console[_0x5bee93(0x136)](_0x5bee93(0x100)+_0x56eac5+_0x5bee93(0xe5));return;}console[_0x5bee93(0x136)](_0x5bee93(0xf9)+_0x56eac5+_0x5bee93(0x1ca)),console[_0x5bee93(0x136)]('\x20\x20\x20-\x20Gateway:\x20'+_0x199a8a[_0x5bee93(0x1a2)]),console['log'](_0x5bee93(0x129)+_0x199a8a[_0x5bee93(0x105)]),console[_0x5bee93(0x136)](_0x5bee93(0x126)+_0x199a8a[_0x5bee93(0x1bb)]),console[_0x5bee93(0x136)](_0x5bee93(0xe3)+_0x199a8a[_0x5bee93(0x1c7)]+'\x20'+_0x199a8a[_0x5bee93(0x142)]),console[_0x5bee93(0x136)](_0x5bee93(0x166)+_0x199a8a['shopId']);if(_0x199a8a[_0x5bee93(0x1a2)]!==_0x5bee93(0x11f)&&_0x199a8a[_0x5bee93(0x1a2)]!=='cointopay2'){console[_0x5bee93(0x136)](_0x5bee93(0x1a7)+_0x56eac5+_0x5bee93(0x148)+_0x199a8a[_0x5bee93(0x1a2)]+')');return;}if(_0x199a8a['status']!==_0x5bee93(0x135)){console[_0x5bee93(0x136)](_0x5bee93(0x1a7)+_0x56eac5+_0x5bee93(0x168)+_0x199a8a[_0x5bee93(0x105)]+_0x5bee93(0x160)),this[_0x5bee93(0x117)](_0x56eac5);return;}if(!_0x199a8a[_0x5bee93(0x1bb)]){console[_0x5bee93(0x136)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x56eac5+_0x5bee93(0x141));return;}console['log'](_0x5bee93(0x14a)+_0x56eac5+_0x5bee93(0x114)),await this[_0x5bee93(0x169)](_0x199a8a);}[a37_0xe439a4(0x14f)](_0x5edc5b,_0x23b126,_0x4759b7,_0x13aee2,_0x3a181f,_0x553e2b){const _0xd3c728=a37_0xe439a4,_0x2766c4={'type':_0xd3c728(0x1c2),'paymentId':_0x5edc5b,'gatewayPaymentId':_0x23b126,'oldStatus':_0x4759b7,'newStatus':_0x13aee2,'source':_0x3a181f,'timestamp':new Date()[_0xd3c728(0xf3)](),'details':_0x553e2b||{}};loggerService_1[_0xd3c728(0x15b)][_0xd3c728(0x14f)](_0x2766c4),console[_0xd3c728(0x136)](_0xd3c728(0xe9)+_0x5edc5b+'\x20('+_0x23b126+')'),console[_0xd3c728(0x136)](_0xd3c728(0x124)+_0x4759b7+_0xd3c728(0x182)+_0x13aee2),console[_0xd3c728(0x136)]('\x20\x20\x20📍\x20Source:\x20'+_0x3a181f),console[_0xd3c728(0x136)](_0xd3c728(0x1b4)+_0x2766c4[_0xd3c728(0x1a4)]),_0x553e2b&&console[_0xd3c728(0x136)](_0xd3c728(0x197),_0x553e2b);}[a37_0xe439a4(0x1aa)](_0x1390a2,_0x39b579,_0x1f2eca,_0x274441,_0x5dd9ae){const _0x17f332=a37_0xe439a4,_0xfdb322={'type':_0x17f332(0x14c),'paymentId':_0x1390a2,'gatewayPaymentId':_0x39b579,'error':_0x1f2eca instanceof Error?{'message':_0x1f2eca[_0x17f332(0xe4)],'stack':_0x1f2eca[_0x17f332(0xef)]}:_0x1f2eca,'source':_0x274441,'timestamp':new Date()[_0x17f332(0xf3)](),'context':_0x5dd9ae||{}};loggerService_1[_0x17f332(0x15b)][_0x17f332(0x1aa)](_0xfdb322),console[_0x17f332(0x104)](_0x17f332(0x152)+_0x1390a2+'\x20('+_0x39b579+')'),console['error'](_0x17f332(0x1c9)+(_0x1f2eca instanceof Error?_0x1f2eca[_0x17f332(0xe4)]:_0x1f2eca)),console['error']('\x20\x20\x20📍\x20Source:\x20'+_0x274441),console['error'](_0x17f332(0x1b4)+_0xfdb322[_0x17f332(0x1a4)]),_0x5dd9ae&&console[_0x17f332(0x104)](_0x17f332(0x138),_0x5dd9ae);}[a37_0xe439a4(0x16e)](){const _0xe2661c=a37_0xe439a4;console[_0xe2661c(0x136)](_0xe2661c(0x156)),this[_0xe2661c(0x1ce)]()[_0xe2661c(0x1a6)](_0x48f7bb=>{const _0x1eacdb=_0xe2661c;console['error'](_0x1eacdb(0x167),_0x48f7bb);}),this['globalCheckInterval']=setInterval(async()=>{const _0x21c4ae=_0xe2661c;try{console[_0x21c4ae(0x136)](_0x21c4ae(0x1af)),await this[_0x21c4ae(0x1ce)](),console[_0x21c4ae(0x136)](_0x21c4ae(0x17d));}catch(_0x4fd7e7){console['error'](_0x21c4ae(0x122),_0x4fd7e7);}},this[_0xe2661c(0x11b)]),console[_0xe2661c(0x136)](_0xe2661c(0x18a));}['stopPeriodicStatusCheck'](){const _0x47afe8=a37_0xe439a4;console[_0x47afe8(0x136)](_0x47afe8(0x176));this[_0x47afe8(0x1a1)]&&(clearInterval(this[_0x47afe8(0x1a1)]),this[_0x47afe8(0x1a1)]=null,console[_0x47afe8(0x136)](_0x47afe8(0x1ae)));const _0x1bf7a2=this[_0x47afe8(0x127)]['size'];for(const [_0x3a1bbc]of this[_0x47afe8(0x127)]){this[_0x47afe8(0x117)](_0x3a1bbc);}console[_0x47afe8(0x136)](_0x47afe8(0x171)+_0x1bf7a2+_0x47afe8(0x199));}async[a37_0xe439a4(0x1ce)](){const _0x814292=a37_0xe439a4;try{console[_0x814292(0x136)](_0x814292(0x192));const _0x1173ab=await database_1['default'][_0x814292(0xe0)][_0x814292(0x130)]({'where':{'gateway':{'in':[_0x814292(0x11f),_0x814292(0x107)]},'status':_0x814292(0x135),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x814292(0x136)](_0x814292(0xff)+_0x1173ab['length']+_0x814292(0x149));if(_0x1173ab[_0x814292(0x195)]===0x0){console[_0x814292(0x136)](_0x814292(0x1ad));return;}const _0x3ec1f0=await this[_0x814292(0x113)](_0x1173ab);console['log']('⏰\x20[GLOBAL]\x20Found\x20'+_0x3ec1f0[_0x814292(0x195)]+_0x814292(0x1ac));let _0x35077e=0x0,_0x567f48=0x0;for(const _0x98e0d5 of _0x1173ab){try{if(_0x3ec1f0[_0x814292(0x131)](_0x98e0d5['id'])){console['log']('⏰\x20[GLOBAL]\x20Payment\x20'+_0x98e0d5['id']+_0x814292(0x16b)),_0x567f48++;continue;}if(this[_0x814292(0x127)]['has'](_0x98e0d5['id'])){console[_0x814292(0x136)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x98e0d5['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x567f48++;continue;}const _0x54232f=(Date[_0x814292(0x109)]()-_0x98e0d5['createdAt']['getTime']())/(0x3e8*0x3c*0x3c);if(_0x54232f<0x1){console['log'](_0x814292(0xf8)+_0x98e0d5['id']+_0x814292(0x15a)+_0x54232f[_0x814292(0x16a)](0x1)+_0x814292(0xf2)),_0x567f48++;continue;}console[_0x814292(0x136)](_0x814292(0x1b0)+_0x98e0d5['id']+_0x814292(0xfa)+_0x54232f[_0x814292(0x16a)](0x1)+'h)'),await this['checkSinglePayment'](_0x98e0d5),_0x35077e++,await new Promise(_0x36d9af=>setTimeout(_0x36d9af,0x7d0));}catch(_0x3400db){console[_0x814292(0x104)](_0x814292(0xf5)+_0x98e0d5['id']+':',_0x3400db),this[_0x814292(0x1aa)](_0x98e0d5['id'],_0x98e0d5[_0x814292(0x1bb)]||_0x814292(0x198),_0x3400db,_0x814292(0x151),{'isGlobalCheck':!![],'paymentAmount':_0x98e0d5[_0x814292(0x1c7)],'paymentCurrency':_0x98e0d5[_0x814292(0x142)],'shopId':_0x98e0d5['shopId'],'createdAt':_0x98e0d5[_0x814292(0x16f)]}),loggerService_1['loggerService']['logWhiteDomainError']('cointopay','/status/'+_0x98e0d5[_0x814292(0x1bb)],_0x3400db);}}console[_0x814292(0x136)](_0x814292(0xe7)+_0x35077e+_0x814292(0x173)+_0x567f48+'\x20skipped,\x20'+_0x3ec1f0[_0x814292(0x195)]+'\x20expired');}catch(_0x233daf){console[_0x814292(0x104)](_0x814292(0x10c),_0x233daf);}}async[a37_0xe439a4(0x113)](_0x13d922){const _0x3e576c=a37_0xe439a4,_0x5eceed=[],_0x5ee14c=new Date();_0x5ee14c[_0x3e576c(0x194)](_0x5ee14c[_0x3e576c(0x172)]()-this['EXPIRY_DAYS']),console[_0x3e576c(0x136)](_0x3e576c(0x140)+this[_0x3e576c(0x143)]+_0x3e576c(0x123)+_0x5ee14c[_0x3e576c(0xf3)]()+')');for(const _0x5cf7c6 of _0x13d922){if(_0x5cf7c6[_0x3e576c(0x16f)]<_0x5ee14c){console[_0x3e576c(0x136)](_0x3e576c(0x19e)+_0x5cf7c6['id']+_0x3e576c(0x17e)+this[_0x3e576c(0x143)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x3e576c(0x14f)](_0x5cf7c6['id'],_0x5cf7c6['gatewayPaymentId']||_0x3e576c(0x198),_0x3e576c(0x135),'EXPIRED','auto_expire',{'reason':_0x3e576c(0x1b5)+this[_0x3e576c(0x143)]+_0x3e576c(0x15c),'createdAt':_0x5cf7c6['createdAt'],'daysSinceCreation':Math[_0x3e576c(0x11d)]((Date[_0x3e576c(0x109)]()-_0x5cf7c6[_0x3e576c(0x16f)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x5cf7c6['amount'],'paymentCurrency':_0x5cf7c6[_0x3e576c(0x142)],'shopId':_0x5cf7c6[_0x3e576c(0x17f)]}),await database_1['default'][_0x3e576c(0xe0)][_0x3e576c(0x190)]({'where':{'id':_0x5cf7c6['id']},'data':{'status':_0x3e576c(0x1d0),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x3e576c(0x143)]+_0x3e576c(0x1b2)}}),await database_1[_0x3e576c(0x10b)]['webhookLog'][_0x3e576c(0x159)]({'data':{'paymentId':_0x5cf7c6['id'],'shopId':_0x5cf7c6[_0x3e576c(0x17f)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON['stringify']({'reason':'Payment\x20older\x20than\x20'+this[_0x3e576c(0x143)]+_0x3e576c(0x15c),'createdAt':_0x5cf7c6['createdAt'],'expiredAt':new Date()[_0x3e576c(0xf3)](),'daysSinceCreation':Math[_0x3e576c(0x11d)]((Date[_0x3e576c(0x109)]()-_0x5cf7c6['createdAt'][_0x3e576c(0x14e)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x3e576c(0x13b)](_0x5cf7c6,'EXPIRED'),await this[_0x3e576c(0xea)](_0x5cf7c6,'EXPIRED'),this[_0x3e576c(0x117)](_0x5cf7c6['id']),_0x5eceed['push'](_0x5cf7c6['id']),console[_0x3e576c(0x136)](_0x3e576c(0x19a)+_0x5cf7c6['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x3e576c(0x143)]+_0x3e576c(0x118));}catch(_0x241a71){console[_0x3e576c(0x104)](_0x3e576c(0x17a)+_0x5cf7c6['id']+':',_0x241a71),this[_0x3e576c(0x1aa)](_0x5cf7c6['id'],_0x5cf7c6[_0x3e576c(0x1bb)]||'unknown',_0x241a71,_0x3e576c(0x188),{'reason':_0x3e576c(0x144),'createdAt':_0x5cf7c6['createdAt'],'daysSinceCreation':Math[_0x3e576c(0x11d)]((Date[_0x3e576c(0x109)]()-_0x5cf7c6[_0x3e576c(0x16f)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5eceed;}async[a37_0xe439a4(0x169)](_0x4f071a){const _0x117ef4=a37_0xe439a4;if(!_0x4f071a[_0x117ef4(0x1bb)]){console[_0x117ef4(0x136)](_0x117ef4(0x1a7)+_0x4f071a['id']+_0x117ef4(0x154));return;}console[_0x117ef4(0x136)](_0x117ef4(0xf6)+_0x4f071a['gateway']+_0x117ef4(0x164)+_0x4f071a['id']+'\x20('+_0x4f071a[_0x117ef4(0x1bb)]+')');try{let _0x34a140;_0x4f071a[_0x117ef4(0x1a2)]===_0x117ef4(0x107)?(_0x34a140=await this['coinToPay2Service']['checkPaymentStatus'](_0x4f071a[_0x117ef4(0x1bb)]),console['log'](_0x117ef4(0x11c)+_0x4f071a['id']+_0x117ef4(0x165)+_0x34a140[_0x117ef4(0x105)])):(_0x34a140=await this[_0x117ef4(0x1d4)][_0x117ef4(0x15d)](_0x4f071a['gatewayPaymentId']),console[_0x117ef4(0x136)](_0x117ef4(0x180)+_0x4f071a['id']+_0x117ef4(0x165)+_0x34a140[_0x117ef4(0x105)]));_0x34a140['paymentDetails']&&console[_0x117ef4(0x136)](_0x117ef4(0xf9)+_0x4f071a['id']+_0x117ef4(0x1d1),{'iban':_0x34a140['paymentDetails'][_0x117ef4(0x102)]||_0x117ef4(0x1ab),'transactionId':_0x34a140[_0x117ef4(0x175)][_0x117ef4(0x179)],'createdOn':_0x34a140[_0x117ef4(0x175)][_0x117ef4(0x155)],'confirmedOn':_0x34a140[_0x117ef4(0x175)][_0x117ef4(0x14b)]||_0x117ef4(0x178)});if(_0x34a140[_0x117ef4(0x105)]!==_0x4f071a['status']){console[_0x117ef4(0x136)](_0x117ef4(0x19b)+_0x4f071a['id']+_0x117ef4(0x18c)+_0x4f071a['status']+_0x117ef4(0xe6)+_0x34a140['status']),this[_0x117ef4(0x14f)](_0x4f071a['id'],_0x4f071a[_0x117ef4(0x1bb)],_0x4f071a[_0x117ef4(0x105)],_0x34a140[_0x117ef4(0x105)],_0x117ef4(0x151),{'paymentDetails':_0x34a140[_0x117ef4(0x175)],'amount':_0x34a140['amount'],'currency':_0x34a140[_0x117ef4(0x142)],'shopId':_0x4f071a[_0x117ef4(0x17f)],'checkTimestamp':new Date()['toISOString']()});const _0x5249c1={'status':_0x34a140[_0x117ef4(0x105)],'updatedAt':new Date()};_0x34a140[_0x117ef4(0x105)]==='PAID'&&_0x4f071a['status']!==_0x117ef4(0x158)&&(_0x5249c1[_0x117ef4(0x133)]=new Date(),console[_0x117ef4(0x136)](_0x117ef4(0xed)+_0x4f071a['id']+_0x117ef4(0x12e)+_0x5249c1[_0x117ef4(0x133)][_0x117ef4(0xf3)]()));if(_0x34a140[_0x117ef4(0x175)]){const _0x27bde0=_0x34a140[_0x117ef4(0x175)];_0x27bde0[_0x117ef4(0x102)]&&(_0x5249c1[_0x117ef4(0x184)]=_0x27bde0[_0x117ef4(0x102)],console[_0x117ef4(0x136)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x27bde0[_0x117ef4(0x102)]));if(_0x27bde0[_0x117ef4(0x162)]){const _0x29574f=_0x4f071a['adminNotes']||'',_0x2dbdd2='Bank\x20Details:\x20'+_0x27bde0[_0x117ef4(0x162)];_0x5249c1[_0x117ef4(0x1b8)]=_0x29574f?_0x29574f+'\x0a\x0a'+_0x2dbdd2:_0x2dbdd2,console[_0x117ef4(0x136)](_0x117ef4(0x1b1));}_0x27bde0[_0x117ef4(0x179)]&&console['log'](_0x117ef4(0xf0)+_0x27bde0[_0x117ef4(0x179)]),_0x27bde0[_0x117ef4(0x14b)]&&console['log'](_0x117ef4(0x1cd)+_0x27bde0[_0x117ef4(0x14b)]);}await database_1['default']['payment']['update']({'where':{'id':_0x4f071a['id']},'data':_0x5249c1}),await database_1[_0x117ef4(0x10b)][_0x117ef4(0x19d)][_0x117ef4(0x159)]({'data':{'paymentId':_0x4f071a['id'],'shopId':_0x4f071a[_0x117ef4(0x17f)],'event':'cointopay_status_check_'+_0x34a140[_0x117ef4(0x105)][_0x117ef4(0x101)](),'statusCode':0xc8,'responseBody':JSON[_0x117ef4(0x163)]({'oldStatus':_0x4f071a['status'],'newStatus':_0x34a140[_0x117ef4(0x105)],'paymentDetails':_0x34a140['paymentDetails'],'checkedAt':new Date()[_0x117ef4(0xf3)]()})}}),await this[_0x117ef4(0x13b)](_0x4f071a,_0x34a140[_0x117ef4(0x105)]),await this[_0x117ef4(0xea)](_0x4f071a,_0x34a140[_0x117ef4(0x105)]),_0x34a140['status']!=='PENDING'&&(console[_0x117ef4(0x136)](_0x117ef4(0xfb)+_0x4f071a['id']+'\x20status\x20changed\x20to\x20'+_0x34a140['status']+_0x117ef4(0x145)),this[_0x117ef4(0x117)](_0x4f071a['id'])),console[_0x117ef4(0x136)](_0x117ef4(0x14a)+_0x4f071a['id']+'\x20updated\x20successfully');}else console[_0x117ef4(0x136)](_0x117ef4(0xf9)+_0x4f071a['id']+_0x117ef4(0x1cf)+_0x34a140['status']+')'),this[_0x117ef4(0x14f)](_0x4f071a['id'],_0x4f071a[_0x117ef4(0x1bb)],_0x4f071a[_0x117ef4(0x105)],_0x34a140[_0x117ef4(0x105)],_0x117ef4(0x151),{'statusUnchanged':!![],'paymentDetails':_0x34a140[_0x117ef4(0x175)],'amount':_0x34a140[_0x117ef4(0x1c7)],'currency':_0x34a140[_0x117ef4(0x142)],'shopId':_0x4f071a[_0x117ef4(0x17f)],'checkTimestamp':new Date()[_0x117ef4(0xf3)]()});}catch(_0x577d15){console[_0x117ef4(0x104)](_0x117ef4(0x18d)+_0x4f071a['id']+':',_0x577d15),this[_0x117ef4(0x1aa)](_0x4f071a['id'],_0x4f071a[_0x117ef4(0x1bb)],_0x577d15,_0x117ef4(0x151),{'paymentAmount':_0x4f071a[_0x117ef4(0x1c7)],'paymentCurrency':_0x4f071a[_0x117ef4(0x142)],'shopId':_0x4f071a[_0x117ef4(0x17f)],'createdAt':_0x4f071a[_0x117ef4(0x16f)]}),await database_1[_0x117ef4(0x10b)][_0x117ef4(0x19d)][_0x117ef4(0x159)]({'data':{'paymentId':_0x4f071a['id'],'shopId':_0x4f071a['shopId'],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x117ef4(0x163)]({'error':_0x577d15 instanceof Error?_0x577d15[_0x117ef4(0xe4)]:'Unknown\x20error','gatewayPaymentId':_0x4f071a[_0x117ef4(0x1bb)],'checkedAt':new Date()[_0x117ef4(0xf3)]()})}});}}async[a37_0xe439a4(0x13b)](_0x11f863,_0x1c5241){const _0x1d804d=a37_0xe439a4,_0x3dcec7=Date['now']();try{const _0x38e67b=_0x11f863[_0x1d804d(0xe8)],_0x1b8a53=_0x38e67b['settings'];if(!_0x1b8a53?.['webhookUrl']){console[_0x1d804d(0x136)](_0x1d804d(0x1bd)+_0x38e67b['id']);return;}const _0x1a9ed9=_0x1c5241==='PAID'?'payment.success':_0x1c5241===_0x1d804d(0x17b)?_0x1d804d(0x1bc):_0x1c5241===_0x1d804d(0x1d0)?_0x1d804d(0x1bc):_0x1d804d(0x11a);if(!_0x1b8a53[_0x1d804d(0x18f)]?.[_0x1d804d(0x131)](_0x1a9ed9)){console[_0x1d804d(0x136)](_0x1d804d(0x12d)+_0x1a9ed9+_0x1d804d(0x191)+_0x38e67b['id']);return;}const _0x5357ec=(0x0,gateway_1[_0x1d804d(0x111)])(_0x11f863['gateway'])||_0x11f863[_0x1d804d(0x1a2)],_0x3b4bdf={'event':_0x1a9ed9,'payment':{'id':_0x11f863['id'],'order_id':_0x11f863[_0x1d804d(0x11e)],'gateway_order_id':_0x11f863[_0x1d804d(0x125)],'gateway':_0x5357ec,'amount':_0x11f863[_0x1d804d(0x1c7)],'currency':_0x11f863['currency'],'status':_0x1c5241[_0x1d804d(0x101)](),'customer_email':_0x11f863['customerEmail'],'customer_name':_0x11f863[_0x1d804d(0x1a5)],'created_at':_0x11f863[_0x1d804d(0x16f)],'updated_at':new Date()}},_0x4aff48=await fetch(_0x1b8a53[_0x1d804d(0x116)],{'method':'POST','headers':{'Content-Type':_0x1d804d(0x18b),'User-Agent':_0x1d804d(0xe2)},'body':JSON['stringify'](_0x3b4bdf)}),_0x25a0e5=Date[_0x1d804d(0x109)]()-_0x3dcec7,_0x21971a=_0x4aff48['ok']?_0x1d804d(0x186):await _0x4aff48[_0x1d804d(0x10d)]();loggerService_1[_0x1d804d(0x15b)][_0x1d804d(0xe1)](_0x11f863[_0x1d804d(0x17f)],_0x1b8a53['webhookUrl'],_0x1a9ed9,_0x4aff48[_0x1d804d(0x105)],_0x25a0e5,_0x3b4bdf),console[_0x1d804d(0x136)]('Shop\x20webhook\x20sent\x20to\x20'+_0x1b8a53[_0x1d804d(0x116)]+_0x1d804d(0x16c)+_0x4aff48[_0x1d804d(0x105)]+'\x20('+_0x25a0e5+_0x1d804d(0xec));}catch(_0x44862b){console[_0x1d804d(0x104)](_0x1d804d(0x12a),_0x44862b),loggerService_1[_0x1d804d(0x15b)]['logShopWebhookError'](_0x11f863['shopId'],_0x11f863[_0x1d804d(0xe8)]?.[_0x1d804d(0x10f)]?.[_0x1d804d(0x116)]||_0x1d804d(0x198),_0x1d804d(0x1a0),_0x44862b,{});}}async[a37_0xe439a4(0xea)](_0x4445b1,_0x3103c2){const _0x445ae1=a37_0xe439a4;try{const _0x43fd41={'PENDING':_0x445ae1(0xee),'PAID':'paid','FAILED':_0x445ae1(0x1a8),'EXPIRED':_0x445ae1(0x157)},_0x30e1d9=_0x43fd41[_0x3103c2];if(!_0x30e1d9||_0x30e1d9==='created')return;await telegramBotService_1[_0x445ae1(0x108)][_0x445ae1(0x1c4)](_0x4445b1[_0x445ae1(0x17f)],_0x4445b1,_0x30e1d9);}catch(_0x5aa57f){console['error'](_0x445ae1(0x17c),_0x5aa57f);}}async['checkPaymentById'](_0x2b892e){const _0x313899=a37_0xe439a4;console[_0x313899(0x136)](_0x313899(0x1c0)+_0x2b892e);const _0x55ee06=await database_1[_0x313899(0x10b)][_0x313899(0xe0)]['findUnique']({'where':{'id':_0x2b892e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x55ee06)throw new Error('Payment\x20not\x20found');if(_0x55ee06[_0x313899(0x1a2)]!==_0x313899(0x11f)&&_0x55ee06[_0x313899(0x1a2)]!==_0x313899(0x107))throw new Error(_0x313899(0x153));console[_0x313899(0x136)](_0x313899(0x12c)+_0x55ee06[_0x313899(0x1a2)]+'\x20payment\x20'+_0x2b892e),await this[_0x313899(0x169)](_0x55ee06),console['log']('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x2b892e);}[a37_0xe439a4(0x1cc)](){const _0x3bbb71=a37_0xe439a4,_0xdf45e=this['globalCheckInterval']?this[_0x3bbb71(0x11b)]:undefined,_0xe2aeca=Array[_0x3bbb71(0x13f)](this[_0x3bbb71(0x127)][_0x3bbb71(0x128)]())[_0x3bbb71(0x12b)](_0x2bb29b=>({'paymentId':_0x2bb29b[_0x3bbb71(0x137)],'gatewayPaymentId':_0x2bb29b[_0x3bbb71(0x1bb)],'createdAt':_0x2bb29b[_0x3bbb71(0x16f)],'timersCount':_0x2bb29b['timers'][_0x3bbb71(0x195)]}));return{'isActive':!!this[_0x3bbb71(0x1a1)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x3bbb71(0x143)],'activeIndividualTimers':this[_0x3bbb71(0x127)]['size'],'nextGlobalCheckIn':_0xdf45e,'paymentTimersDetails':_0xe2aeca};}[a37_0xe439a4(0x1c1)](_0x261e01){const _0x26f581=a37_0xe439a4,_0x4207f1=this[_0x26f581(0x127)][_0x26f581(0x189)](_0x261e01);if(_0x4207f1)return{'hasTimers':!![],'timersCount':_0x4207f1['timers'][_0x26f581(0x195)],'createdAt':_0x4207f1[_0x26f581(0x16f)],'gatewayPaymentId':_0x4207f1[_0x26f581(0x1bb)]};return{'hasTimers':![]};}}function a37_0x5461(_0x4e6efb,_0x290709){const _0x36cd25=a37_0x36cd();return a37_0x5461=function(_0x546116,_0x4a1cc0){_0x546116=_0x546116-0xe0;let _0xd27e0e=_0x36cd25[_0x546116];return _0xd27e0e;},a37_0x5461(_0x4e6efb,_0x290709);}exports[a37_0xe439a4(0x1bf)]=CoinToPayStatusService,exports[a37_0xe439a4(0x121)]=new CoinToPayStatusService();