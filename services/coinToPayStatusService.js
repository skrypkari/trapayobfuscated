'use strict';function a37_0x125a(_0x322243,_0x59378f){const _0x3ebcb6=a37_0x3ebc();return a37_0x125a=function(_0x125ad4,_0x5022f8){_0x125ad4=_0x125ad4-0xee;let _0x24bf47=_0x3ebcb6[_0x125ad4];return _0x24bf47;},a37_0x125a(_0x322243,_0x59378f);}const a37_0xd7581f=a37_0x125a;(function(_0x4df909,_0x23d733){const _0x1ec98e=a37_0x125a,_0x46f0c3=_0x4df909();while(!![]){try{const _0xb6ee9=-parseInt(_0x1ec98e(0x181))/0x1*(parseInt(_0x1ec98e(0x1d4))/0x2)+-parseInt(_0x1ec98e(0x10b))/0x3*(-parseInt(_0x1ec98e(0x13a))/0x4)+-parseInt(_0x1ec98e(0x159))/0x5*(-parseInt(_0x1ec98e(0x151))/0x6)+parseInt(_0x1ec98e(0xf6))/0x7*(parseInt(_0x1ec98e(0x117))/0x8)+-parseInt(_0x1ec98e(0x1b6))/0x9+-parseInt(_0x1ec98e(0x10c))/0xa+parseInt(_0x1ec98e(0x1d9))/0xb*(parseInt(_0x1ec98e(0x101))/0xc);if(_0xb6ee9===_0x23d733)break;else _0x46f0c3['push'](_0x46f0c3['shift']());}catch(_0x522741){_0x46f0c3['push'](_0x46f0c3['shift']());}}}(a37_0x3ebc,0x486ba));function a37_0x3ebc(){const _0x18d07c=['\x20not\x20enabled\x20for\x20shop\x20','coinToPayStatusService','toLowerCase','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','webhook_send','update','\x20days,\x20marking\x20as\x20EXPIRED','📊\x20[CHECK]\x20Payment\x20','./gateways/coinToPayService','🪙\x20[DEBUG]\x20Creating\x20','\x20has\x20no\x20gatewayPaymentId','Bank\x20Details:\x20','Automatically\x20expired\x20after\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','5388pqbxFN','gateway','adminNotes','set','🛑\x20[SHUTDOWN]\x20Cleared\x20','\x20not\x20found\x20in\x20database','🪙\x20[GLOBAL]\x20Found\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','2975DdnCwR','customerEmail','create',',\x20stopping\x20individual\x20checks','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','confirmedOn','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','cointopay_status_check_','\x20status\x20unchanged\x20(','\x20\x20\x20-\x20Status:\x20','PAID','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','gatewayPaymentId','paymentTimers','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','transactionId','\x20\x20\x20-\x20GatewayPaymentId:\x20','findMany','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','Unknown\x20error','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20timers\x20for\x20payment\x20','from','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','logShopWebhookSent','description','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','⏰\x20[GLOBAL]\x20Found\x20','createdAt','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','📊\x20[HOURLY]\x20Payment\x20','getPaymentTimerInfo','✅\x20[EXPIRY]\x20Payment\x20','telegramBotService','currency','\x20to\x20','Payment\x20older\x20than\x20','payment.success','✅\x20[HOURLY]\x20Payment\x20','\x20for\x20payment\x20','1203krLlcR','now','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','shop','settings','map','not\x20confirmed','\x20\x20\x20-\x20gatewayPaymentId:\x20','getDate','delete','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20days','paymentId','coinToPayService','.\x20Remaining\x20active\x20timers:\x20','amount','\x20in\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','❌\x20[HOURLY]\x20Payment\x20','0100','/status/','\x20\x20\x20-\x20ShopId:\x20','checkSinglePayment','\x20to\x20clear','message','unknown','text','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20days\x20(created\x20before\x20','error','\x20updated\x20successfully','expired','\x20->\x20','\x20\x20\x20📅\x20Time:\x20','🧹\x20[DEBUG]\x20Clearing\x20','./loggerService','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','Failed\x20to\x20mark\x20payment\x20as\x20expired','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','forEach','CoinToPayStatusService','payment','EXPIRED','stringify','\x20expired\x20CoinToPay\x20payments','\x20individual\x20payment\x20timers','toISOString','🧹\x20[CHECK]\x20Payment\x20','\x20days\x20without\x20payment\x20confirmation','timestamp','4034601SQLOqn','GLOBAL_CHECK_INTERVAL_MS','\x20details:','cointopay_status_check_error','FAILED','⚠️\x20[CHECK]\x20Payment\x20','floor','checkSinglePaymentById','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','includes','stopPeriodicStatusCheck','\x20status:\x20','iban','logShopWebhookError','checkPaymentStatus','COINTOPAY_STATUS_CHANGE','checkAllPendingPayments','1\x20minute','logWhiteDomainError','getServiceStats','❌\x20[CHECK]\x20Payment\x20','schedule_created','failed','PENDING','__esModule','Webhook\x20event\x20','shopId','cointopay','paid','902hdqLFd','sendShopWebhook','gatewayOrderId','\x20(after\x20','ms)','2461723DSFVSw','toFixed','startPeriodicStatusCheck','webhookUrl','sendPaymentStatusNotification','EXPIRY_DAYS','status','💰\x20[CHECK]\x20Payment\x20','loggerService','COINTOPAY_ERROR','\x20checked,\x20','paymentDetails','findUnique','\x20(age:\x20','Success','status_check','\x20is\x20too\x20new\x20(','h),\x20skipping\x20global\x20check','1253ZTsMIp','\x20current\x20status:\x20','push','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','webhookLog','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','clearPaymentTimers','timers','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','webhookEvents','size','24obeZzX','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','created','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','application/json','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','TesSoft\x20Payment\x20System/1.0','checkExpiredPayments',',\x20clearing\x20individual\x20timers','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','6chZZwV','2999430iNLKRu','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','remitterIban','\x20\x20\x20📍\x20Source:\x20','Shop\x20webhook\x20sent\x20to\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','5\x20minutes','POST','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','21832iDxwtV','🔄\x20[CHECK]\x20Updating\x20payment\x20','\x20status\x20from\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','paidAt','\x20status\x20changed\x20to\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','length','\x20pending\x20CoinToPay\x20payments','auto_expire','✅\x20[CHECK]\x20Payment\x20','bankDetails','\x20initial\x20timers\x20for\x20payment\x20','default','log','delay','🪙\x20[TIMER]\x20Individual\x20check\x20#','globalCheckInterval','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','\x20found:','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','schedulePaymentChecks','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','payment.failed','get','\x20status\x20is\x20','\x20\x20\x20📝\x20Context:','./telegramBotService','⏰\x20[GLOBAL]\x20Payment\x20','\x20is\x20older\x20than\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','logCoinToPayError','cointopay_auto_expired','\x20expired','getTime','234064WfVKXj','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','CoinToPayService','logCoinToPayStatus','values','orderId','setDate','Failed\x20to\x20send\x20shop\x20webhook:','\x20\x20\x20-\x20Amount:\x20'];a37_0x3ebc=function(){return _0x18d07c;};return a37_0x3ebc();}var __importDefault=this&&this['__importDefault']||function(_0x30fb3c){return _0x30fb3c&&_0x30fb3c['__esModule']?_0x30fb3c:{'default':_0x30fb3c};};Object['defineProperty'](exports,a37_0xd7581f(0x1cf),{'value':!![]}),exports[a37_0xd7581f(0x144)]=exports[a37_0xd7581f(0x1ac)]=void 0x0;const coinToPayService_1=require(a37_0xd7581f(0x14b)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0xd7581f(0x132)),loggerService_1=require(a37_0xd7581f(0x1a7));class CoinToPayStatusService{constructor(){const _0x32d87f=a37_0xd7581f;this[_0x32d87f(0x128)]=null,this[_0x32d87f(0x1b7)]=0x3c*0x3c*0x3e8,this[_0x32d87f(0x1de)]=0x5,this[_0x32d87f(0x166)]=new Map(),this[_0x32d87f(0x18f)]=new coinToPayService_1[(_0x32d87f(0x13c))](),console[_0x32d87f(0x125)]('🪙\x20CoinToPayStatusService\x20initialized');}[a37_0xd7581f(0x12c)](_0x115664,_0x4f04f){const _0x28b6b5=a37_0xd7581f;console[_0x28b6b5(0x125)](_0x28b6b5(0x1a8)),console[_0x28b6b5(0x125)]('\x20\x20\x20-\x20paymentId:\x20'+_0x115664),console[_0x28b6b5(0x125)](_0x28b6b5(0x189)+_0x4f04f),this[_0x28b6b5(0xfc)](_0x115664);const _0x125db6=[],_0x2e0f06=new Date(),_0x2fdbe5=[{'delay':0x1*0x3c*0x3e8,'description':_0x28b6b5(0x1c8)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x28b6b5(0x114)}];console[_0x28b6b5(0x125)](_0x28b6b5(0x14c)+_0x2fdbe5[_0x28b6b5(0x11e)]+_0x28b6b5(0x123)+_0x115664);let _0x433cd9=0x0;_0x2fdbe5[_0x28b6b5(0x1ab)]((_0x4def36,_0x42c781)=>{const _0x3a349b=_0x28b6b5;_0x433cd9+=_0x4def36['delay'];const _0x2d63e3=setTimeout(async()=>{const _0x25e58b=a37_0x125a;console[_0x25e58b(0x125)](_0x25e58b(0x127)+(_0x42c781+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x115664+_0x25e58b(0x1d7)+_0x4def36['description']+')');try{await this[_0x25e58b(0x1bd)](_0x115664),console[_0x25e58b(0x125)](_0x25e58b(0x194)+(_0x42c781+0x1)+'\x20completed\x20for\x20payment\x20'+_0x115664);}catch(_0x25abf8){console[_0x25e58b(0x1a1)](_0x25e58b(0x15f)+(_0x42c781+0x1)+_0x25e58b(0x180)+_0x115664+':',_0x25abf8),this[_0x25e58b(0x136)](_0x115664,_0x4f04f,_0x25abf8,_0x25e58b(0xf3),{'checkNumber':_0x42c781+0x1,'scheduledAfter':_0x4def36[_0x25e58b(0x172)],'isIndividualCheck':!![]});}},_0x433cd9);_0x125db6[_0x3a349b(0xf8)](_0x2d63e3),console[_0x3a349b(0x125)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x42c781+0x1)+_0x3a349b(0x180)+_0x115664+_0x3a349b(0x192)+_0x433cd9/0x3e8+'\x20seconds\x20('+_0x4def36['description']+')');});const _0x5e80ef=setInterval(async()=>{const _0x51cd72=_0x28b6b5;console['log'](_0x51cd72(0x195)+_0x115664);try{const _0x3b2765=await database_1['default'][_0x51cd72(0x1ad)][_0x51cd72(0xf0)]({'where':{'id':_0x115664},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x3b2765){console[_0x51cd72(0x125)](_0x51cd72(0x196)+_0x115664+'\x20not\x20found,\x20clearing\x20timers'),this[_0x51cd72(0xfc)](_0x115664);return;}console[_0x51cd72(0x125)](_0x51cd72(0x177)+_0x115664+_0x51cd72(0xf7)+_0x3b2765[_0x51cd72(0x1df)]);if(_0x3b2765['status']!==_0x51cd72(0x1ce)){console['log'](_0x51cd72(0x17f)+_0x115664+_0x51cd72(0x130)+_0x3b2765[_0x51cd72(0x1df)]+_0x51cd72(0x15c)),this[_0x51cd72(0xfc)](_0x115664);return;}const _0x49840f=Math[_0x51cd72(0x1bc)]((Date[_0x51cd72(0x182)]()-_0x3b2765[_0x51cd72(0x175)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x49840f>=this[_0x51cd72(0x1de)]){console['log']('⏰\x20[HOURLY]\x20Payment\x20'+_0x115664+'\x20is\x20older\x20than\x20'+this[_0x51cd72(0x1de)]+_0x51cd72(0x16b)),this[_0x51cd72(0xfc)](_0x115664);return;}await this[_0x51cd72(0x1bd)](_0x115664),console['log'](_0x51cd72(0x193)+_0x115664);}catch(_0x1354fc){console[_0x51cd72(0x1a1)](_0x51cd72(0xfe)+_0x115664+':',_0x1354fc),this[_0x51cd72(0x136)](_0x115664,_0x4f04f,_0x1354fc,_0x51cd72(0xf3),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x125db6[_0x28b6b5(0xf8)](_0x5e80ef),this[_0x28b6b5(0x166)][_0x28b6b5(0x154)](_0x115664,{'timers':_0x125db6,'paymentId':_0x115664,'gatewayPaymentId':_0x4f04f,'createdAt':_0x2e0f06}),console[_0x28b6b5(0x125)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x2fdbe5[_0x28b6b5(0x11e)]+_0x28b6b5(0x18c)+_0x115664),console[_0x28b6b5(0x125)](_0x28b6b5(0x106)+this[_0x28b6b5(0x166)]['size']),this['logCoinToPayStatus'](_0x115664,_0x4f04f,_0x28b6b5(0x1ce),_0x28b6b5(0x1ce),_0x28b6b5(0xf3),{'action':_0x28b6b5(0x1cc),'scheduledChecks':_0x2fdbe5[_0x28b6b5(0x11e)],'firstCheckIn':_0x2fdbe5[0x0][_0x28b6b5(0x126)]/0x3e8,'totalTimers':this['paymentTimers']['size']});}['clearPaymentTimers'](_0x6a057a){const _0x447b9c=a37_0xd7581f,_0x2d10ed=this[_0x447b9c(0x166)][_0x447b9c(0x12f)](_0x6a057a);_0x2d10ed?(console[_0x447b9c(0x125)](_0x447b9c(0x1a6)+_0x2d10ed[_0x447b9c(0xfd)][_0x447b9c(0x11e)]+_0x447b9c(0x16e)+_0x6a057a),_0x2d10ed[_0x447b9c(0xfd)][_0x447b9c(0x1ab)]((_0x362c3c,_0x29f3ff)=>{const _0x39927f=_0x447b9c;_0x362c3c&&(clearTimeout(_0x362c3c),clearInterval(_0x362c3c),console['log'](_0x39927f(0x10d)+(_0x29f3ff+0x1)+_0x39927f(0x180)+_0x6a057a));}),this[_0x447b9c(0x166)][_0x447b9c(0x18b)](_0x6a057a),console['log']('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x6a057a+_0x447b9c(0x190)+this['paymentTimers'][_0x447b9c(0x100)])):console[_0x447b9c(0x125)](_0x447b9c(0xfb)+_0x6a057a+_0x447b9c(0x19b));}async['checkSinglePaymentById'](_0x1912c6){const _0x51375b=a37_0xd7581f;console[_0x51375b(0x125)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x1912c6);const _0x449b20=await database_1['default'][_0x51375b(0x1ad)][_0x51375b(0xf0)]({'where':{'id':_0x1912c6},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x449b20){console[_0x51375b(0x125)](_0x51375b(0x1cb)+_0x1912c6+_0x51375b(0x156));return;}console[_0x51375b(0x125)](_0x51375b(0x14a)+_0x1912c6+_0x51375b(0x12a)),console[_0x51375b(0x125)]('\x20\x20\x20-\x20Gateway:\x20'+_0x449b20['gateway']),console[_0x51375b(0x125)](_0x51375b(0x162)+_0x449b20[_0x51375b(0x1df)]),console[_0x51375b(0x125)](_0x51375b(0x169)+_0x449b20[_0x51375b(0x165)]),console[_0x51375b(0x125)](_0x51375b(0x142)+_0x449b20[_0x51375b(0x191)]+'\x20'+_0x449b20[_0x51375b(0x17b)]),console[_0x51375b(0x125)](_0x51375b(0x199)+_0x449b20[_0x51375b(0x1d1)]);if(_0x449b20['gateway']!=='cointopay'){console[_0x51375b(0x125)](_0x51375b(0x1bb)+_0x1912c6+_0x51375b(0x146)+_0x449b20[_0x51375b(0x152)]+')');return;}if(_0x449b20[_0x51375b(0x1df)]!==_0x51375b(0x1ce)){console[_0x51375b(0x125)](_0x51375b(0x1bb)+_0x1912c6+_0x51375b(0x130)+_0x449b20[_0x51375b(0x1df)]+',\x20stopping\x20individual\x20checks'),this['clearPaymentTimers'](_0x1912c6);return;}if(!_0x449b20['gatewayPaymentId']){console[_0x51375b(0x125)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x1912c6+_0x51375b(0x14d));return;}console[_0x51375b(0x125)]('✅\x20[CHECK]\x20Payment\x20'+_0x1912c6+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x51375b(0x19a)](_0x449b20);}[a37_0xd7581f(0x13d)](_0x319850,_0x1dea1f,_0x29143e,_0x35fb4a,_0xf522e1,_0x430b29){const _0xc52e8=a37_0xd7581f,_0x5a6c8d={'type':_0xc52e8(0x1c6),'paymentId':_0x319850,'gatewayPaymentId':_0x1dea1f,'oldStatus':_0x29143e,'newStatus':_0x35fb4a,'source':_0xf522e1,'timestamp':new Date()[_0xc52e8(0x1b2)](),'details':_0x430b29||{}};loggerService_1['loggerService'][_0xc52e8(0x13d)](_0x5a6c8d),console[_0xc52e8(0x125)](_0xc52e8(0x116)+_0x319850+'\x20('+_0x1dea1f+')'),console[_0xc52e8(0x125)]('\x20\x20\x20📊\x20Status:\x20'+_0x29143e+_0xc52e8(0x1a4)+_0x35fb4a),console[_0xc52e8(0x125)](_0xc52e8(0x110)+_0xf522e1),console['log']('\x20\x20\x20📅\x20Time:\x20'+_0x5a6c8d[_0xc52e8(0x1b5)]),_0x430b29&&console[_0xc52e8(0x125)]('\x20\x20\x20📝\x20Details:',_0x430b29);}[a37_0xd7581f(0x136)](_0x1db01c,_0x21dc9c,_0x5cc136,_0xb60db2,_0x1984bb){const _0xfb6153=a37_0xd7581f,_0x5c95f6={'type':_0xfb6153(0x1e2),'paymentId':_0x1db01c,'gatewayPaymentId':_0x21dc9c,'error':_0x5cc136 instanceof Error?{'message':_0x5cc136[_0xfb6153(0x19c)],'stack':_0x5cc136['stack']}:_0x5cc136,'source':_0xb60db2,'timestamp':new Date()[_0xfb6153(0x1b2)](),'context':_0x1984bb||{}};loggerService_1['loggerService']['logCoinToPayError'](_0x5c95f6),console['error'](_0xfb6153(0x12b)+_0x1db01c+'\x20('+_0x21dc9c+')'),console[_0xfb6153(0x1a1)]('\x20\x20\x20❌\x20Error:\x20'+(_0x5cc136 instanceof Error?_0x5cc136[_0xfb6153(0x19c)]:_0x5cc136)),console[_0xfb6153(0x1a1)]('\x20\x20\x20📍\x20Source:\x20'+_0xb60db2),console[_0xfb6153(0x1a1)](_0xfb6153(0x1a5)+_0x5c95f6[_0xfb6153(0x1b5)]),_0x1984bb&&console[_0xfb6153(0x1a1)](_0xfb6153(0x131),_0x1984bb);}[a37_0xd7581f(0x1db)](){const _0x31dd8a=a37_0xd7581f;console[_0x31dd8a(0x125)]('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x31dd8a(0x1c7)]()['catch'](_0xee7d8b=>{const _0x1fef78=_0x31dd8a;console[_0x1fef78(0x1a1)](_0x1fef78(0x15d),_0xee7d8b);}),this[_0x31dd8a(0x128)]=setInterval(async()=>{const _0x364876=_0x31dd8a;try{console['log'](_0x364876(0x170)),await this['checkAllPendingPayments'](),console[_0x364876(0x125)](_0x364876(0x13b));}catch(_0x47d120){console[_0x364876(0x1a1)](_0x364876(0x19f),_0x47d120);}},this[_0x31dd8a(0x1b7)]),console[_0x31dd8a(0x125)](_0x31dd8a(0x167));}[a37_0xd7581f(0x1c1)](){const _0x200330=a37_0xd7581f;console[_0x200330(0x125)](_0x200330(0x158));this[_0x200330(0x128)]&&(clearInterval(this[_0x200330(0x128)]),this[_0x200330(0x128)]=null,console['log'](_0x200330(0x184)));const _0x2dae1f=this[_0x200330(0x166)][_0x200330(0x100)];for(const [_0x197bd4]of this[_0x200330(0x166)]){this[_0x200330(0xfc)](_0x197bd4);}console[_0x200330(0x125)](_0x200330(0x155)+_0x2dae1f+_0x200330(0x1b1));}async['checkAllPendingPayments'](){const _0x3035e3=a37_0xd7581f;try{console[_0x3035e3(0x125)](_0x3035e3(0x11d));const _0x38ccf0=await database_1[_0x3035e3(0x124)][_0x3035e3(0x1ad)][_0x3035e3(0x16a)]({'where':{'gateway':_0x3035e3(0x1d2),'status':_0x3035e3(0x1ce),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x3035e3(0x125)](_0x3035e3(0x157)+_0x38ccf0[_0x3035e3(0x11e)]+_0x3035e3(0x11f));if(_0x38ccf0[_0x3035e3(0x11e)]===0x0){console[_0x3035e3(0x125)](_0x3035e3(0x1bf));return;}const _0x1fa7a1=await this[_0x3035e3(0x108)](_0x38ccf0);console[_0x3035e3(0x125)](_0x3035e3(0x174)+_0x1fa7a1[_0x3035e3(0x11e)]+_0x3035e3(0x1b0));let _0x4eff70=0x0,_0x37f5e1=0x0;for(const _0x3de66f of _0x38ccf0){try{if(_0x1fa7a1[_0x3035e3(0x1c0)](_0x3de66f['id'])){console[_0x3035e3(0x125)](_0x3035e3(0x133)+_0x3de66f['id']+_0x3035e3(0x11a)),_0x37f5e1++;continue;}if(this[_0x3035e3(0x166)]['has'](_0x3de66f['id'])){console[_0x3035e3(0x125)](_0x3035e3(0x133)+_0x3de66f['id']+_0x3035e3(0x113)),_0x37f5e1++;continue;}const _0x54af7d=(Date[_0x3035e3(0x182)]()-_0x3de66f['createdAt']['getTime']())/(0x3e8*0x3c*0x3c);if(_0x54af7d<0x1){console['log'](_0x3035e3(0x133)+_0x3de66f['id']+_0x3035e3(0xf4)+_0x54af7d[_0x3035e3(0x1da)](0x1)+_0x3035e3(0xf5)),_0x37f5e1++;continue;}console[_0x3035e3(0x125)](_0x3035e3(0x150)+_0x3de66f['id']+_0x3035e3(0xf1)+_0x54af7d[_0x3035e3(0x1da)](0x1)+'h)'),await this[_0x3035e3(0x19a)](_0x3de66f),_0x4eff70++,await new Promise(_0x30e13e=>setTimeout(_0x30e13e,0x7d0));}catch(_0x4170d9){console[_0x3035e3(0x1a1)](_0x3035e3(0x104)+_0x3de66f['id']+':',_0x4170d9),this['logCoinToPayError'](_0x3de66f['id'],_0x3de66f[_0x3035e3(0x165)]||_0x3035e3(0x19d),_0x4170d9,_0x3035e3(0xf3),{'isGlobalCheck':!![],'paymentAmount':_0x3de66f[_0x3035e3(0x191)],'paymentCurrency':_0x3de66f[_0x3035e3(0x17b)],'shopId':_0x3de66f[_0x3035e3(0x1d1)],'createdAt':_0x3de66f[_0x3035e3(0x175)]}),loggerService_1[_0x3035e3(0x1e1)][_0x3035e3(0x1c9)](_0x3035e3(0x1d2),_0x3035e3(0x198)+_0x3de66f['gatewayPaymentId'],_0x4170d9);}}console[_0x3035e3(0x125)](_0x3035e3(0xf9)+_0x4eff70+_0x3035e3(0xee)+_0x37f5e1+'\x20skipped,\x20'+_0x1fa7a1[_0x3035e3(0x11e)]+_0x3035e3(0x138));}catch(_0xd2a7b){console[_0x3035e3(0x1a1)](_0x3035e3(0x10a),_0xd2a7b);}}async['checkExpiredPayments'](_0x54fad8){const _0x4849d2=a37_0xd7581f,_0x5b8a1d=[],_0x5adefb=new Date();_0x5adefb[_0x4849d2(0x140)](_0x5adefb[_0x4849d2(0x18a)]()-this[_0x4849d2(0x1de)]),console[_0x4849d2(0x125)](_0x4849d2(0x16d)+this[_0x4849d2(0x1de)]+_0x4849d2(0x1a0)+_0x5adefb[_0x4849d2(0x1b2)]()+')');for(const _0x3a34c3 of _0x54fad8){if(_0x3a34c3[_0x4849d2(0x175)]<_0x5adefb){console[_0x4849d2(0x125)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x3a34c3['id']+_0x4849d2(0x134)+this[_0x4849d2(0x1de)]+_0x4849d2(0x149));try{this[_0x4849d2(0x13d)](_0x3a34c3['id'],_0x3a34c3[_0x4849d2(0x165)]||_0x4849d2(0x19d),_0x4849d2(0x1ce),_0x4849d2(0x1ae),_0x4849d2(0x120),{'reason':_0x4849d2(0x17d)+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x3a34c3[_0x4849d2(0x175)],'daysSinceCreation':Math[_0x4849d2(0x1bc)]((Date[_0x4849d2(0x182)]()-_0x3a34c3['createdAt'][_0x4849d2(0x139)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x3a34c3[_0x4849d2(0x191)],'paymentCurrency':_0x3a34c3[_0x4849d2(0x17b)],'shopId':_0x3a34c3[_0x4849d2(0x1d1)]}),await database_1[_0x4849d2(0x124)][_0x4849d2(0x1ad)][_0x4849d2(0x148)]({'where':{'id':_0x3a34c3['id']},'data':{'status':_0x4849d2(0x1ae),'updatedAt':new Date(),'adminNotes':_0x4849d2(0x14f)+this[_0x4849d2(0x1de)]+_0x4849d2(0x1b4)}}),await database_1[_0x4849d2(0x124)][_0x4849d2(0xfa)][_0x4849d2(0x15b)]({'data':{'paymentId':_0x3a34c3['id'],'shopId':_0x3a34c3[_0x4849d2(0x1d1)],'event':_0x4849d2(0x137),'statusCode':0xc8,'responseBody':JSON[_0x4849d2(0x1af)]({'reason':_0x4849d2(0x17d)+this['EXPIRY_DAYS']+_0x4849d2(0x18d),'createdAt':_0x3a34c3[_0x4849d2(0x175)],'expiredAt':new Date()[_0x4849d2(0x1b2)](),'daysSinceCreation':Math[_0x4849d2(0x1bc)]((Date['now']()-_0x3a34c3['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4849d2(0x1d5)](_0x3a34c3,'EXPIRED'),await this[_0x4849d2(0x1dd)](_0x3a34c3,_0x4849d2(0x1ae)),this[_0x4849d2(0xfc)](_0x3a34c3['id']),_0x5b8a1d[_0x4849d2(0xf8)](_0x3a34c3['id']),console[_0x4849d2(0x125)](_0x4849d2(0x179)+_0x3a34c3['id']+_0x4849d2(0x10e)+this[_0x4849d2(0x1de)]+'-day\x20timeout');}catch(_0x1867cd){console[_0x4849d2(0x1a1)]('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x3a34c3['id']+':',_0x1867cd),this[_0x4849d2(0x136)](_0x3a34c3['id'],_0x3a34c3[_0x4849d2(0x165)]||_0x4849d2(0x19d),_0x1867cd,_0x4849d2(0x120),{'reason':_0x4849d2(0x1a9),'createdAt':_0x3a34c3[_0x4849d2(0x175)],'daysSinceCreation':Math[_0x4849d2(0x1bc)]((Date[_0x4849d2(0x182)]()-_0x3a34c3[_0x4849d2(0x175)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5b8a1d;}async[a37_0xd7581f(0x19a)](_0x35be8d){const _0x1ccfbe=a37_0xd7581f;if(!_0x35be8d[_0x1ccfbe(0x165)]){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x35be8d['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x1ccfbe(0x125)](_0x1ccfbe(0x129)+_0x35be8d['id']+'\x20('+_0x35be8d[_0x1ccfbe(0x165)]+')');try{const _0x364622=await this[_0x1ccfbe(0x18f)][_0x1ccfbe(0x1c5)](_0x35be8d[_0x1ccfbe(0x165)]);console['log'](_0x1ccfbe(0x14a)+_0x35be8d['id']+_0x1ccfbe(0x1c2)+_0x364622[_0x1ccfbe(0x1df)]);_0x364622[_0x1ccfbe(0xef)]&&console[_0x1ccfbe(0x125)](_0x1ccfbe(0x14a)+_0x35be8d['id']+_0x1ccfbe(0x1b8),{'iban':_0x364622['paymentDetails']['iban']||'not\x20found','transactionId':_0x364622[_0x1ccfbe(0xef)][_0x1ccfbe(0x168)],'createdOn':_0x364622[_0x1ccfbe(0xef)]['createdOn'],'confirmedOn':_0x364622[_0x1ccfbe(0xef)]['confirmedOn']||_0x1ccfbe(0x188)});if(_0x364622[_0x1ccfbe(0x1df)]!==_0x35be8d[_0x1ccfbe(0x1df)]){console[_0x1ccfbe(0x125)](_0x1ccfbe(0x118)+_0x35be8d['id']+_0x1ccfbe(0x119)+_0x35be8d[_0x1ccfbe(0x1df)]+_0x1ccfbe(0x17c)+_0x364622[_0x1ccfbe(0x1df)]),this['logCoinToPayStatus'](_0x35be8d['id'],_0x35be8d[_0x1ccfbe(0x165)],_0x35be8d[_0x1ccfbe(0x1df)],_0x364622[_0x1ccfbe(0x1df)],_0x1ccfbe(0xf3),{'paymentDetails':_0x364622[_0x1ccfbe(0xef)],'amount':_0x364622[_0x1ccfbe(0x191)],'currency':_0x364622[_0x1ccfbe(0x17b)],'shopId':_0x35be8d[_0x1ccfbe(0x1d1)],'checkTimestamp':new Date()[_0x1ccfbe(0x1b2)]()});const _0x2326c9={'status':_0x364622['status'],'updatedAt':new Date()};_0x364622[_0x1ccfbe(0x1df)]===_0x1ccfbe(0x163)&&_0x35be8d[_0x1ccfbe(0x1df)]!=='PAID'&&(_0x2326c9[_0x1ccfbe(0x11b)]=new Date(),console[_0x1ccfbe(0x125)](_0x1ccfbe(0x1e0)+_0x35be8d['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x2326c9[_0x1ccfbe(0x11b)]['toISOString']()));if(_0x364622[_0x1ccfbe(0xef)]){const _0x5593d5=_0x364622[_0x1ccfbe(0xef)];_0x5593d5[_0x1ccfbe(0x1c3)]&&(_0x2326c9[_0x1ccfbe(0x10f)]=_0x5593d5[_0x1ccfbe(0x1c3)],console[_0x1ccfbe(0x125)](_0x1ccfbe(0x173)+_0x5593d5['iban']));if(_0x5593d5['bankDetails']){const _0x2afb8e=_0x35be8d[_0x1ccfbe(0x153)]||'',_0xb7bfe2=_0x1ccfbe(0x14e)+_0x5593d5[_0x1ccfbe(0x122)];_0x2326c9[_0x1ccfbe(0x153)]=_0x2afb8e?_0x2afb8e+'\x0a\x0a'+_0xb7bfe2:_0xb7bfe2,console[_0x1ccfbe(0x125)](_0x1ccfbe(0x1aa));}_0x5593d5[_0x1ccfbe(0x168)]&&console[_0x1ccfbe(0x125)]('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x5593d5[_0x1ccfbe(0x168)]),_0x5593d5[_0x1ccfbe(0x15e)]&&console['log'](_0x1ccfbe(0x12d)+_0x5593d5[_0x1ccfbe(0x15e)]);}await database_1[_0x1ccfbe(0x124)][_0x1ccfbe(0x1ad)][_0x1ccfbe(0x148)]({'where':{'id':_0x35be8d['id']},'data':_0x2326c9}),await database_1[_0x1ccfbe(0x124)][_0x1ccfbe(0xfa)][_0x1ccfbe(0x15b)]({'data':{'paymentId':_0x35be8d['id'],'shopId':_0x35be8d[_0x1ccfbe(0x1d1)],'event':_0x1ccfbe(0x160)+_0x364622[_0x1ccfbe(0x1df)][_0x1ccfbe(0x145)](),'statusCode':0xc8,'responseBody':JSON[_0x1ccfbe(0x1af)]({'oldStatus':_0x35be8d[_0x1ccfbe(0x1df)],'newStatus':_0x364622[_0x1ccfbe(0x1df)],'paymentDetails':_0x364622[_0x1ccfbe(0xef)],'checkedAt':new Date()[_0x1ccfbe(0x1b2)]()})}}),await this[_0x1ccfbe(0x1d5)](_0x35be8d,_0x364622[_0x1ccfbe(0x1df)]),await this['sendPaymentStatusNotification'](_0x35be8d,_0x364622['status']),_0x364622[_0x1ccfbe(0x1df)]!==_0x1ccfbe(0x1ce)&&(console[_0x1ccfbe(0x125)](_0x1ccfbe(0x1b3)+_0x35be8d['id']+_0x1ccfbe(0x11c)+_0x364622[_0x1ccfbe(0x1df)]+_0x1ccfbe(0x109)),this[_0x1ccfbe(0xfc)](_0x35be8d['id'])),console[_0x1ccfbe(0x125)](_0x1ccfbe(0x121)+_0x35be8d['id']+_0x1ccfbe(0x1a2));}else console[_0x1ccfbe(0x125)](_0x1ccfbe(0x14a)+_0x35be8d['id']+_0x1ccfbe(0x161)+_0x364622['status']+')'),this[_0x1ccfbe(0x13d)](_0x35be8d['id'],_0x35be8d[_0x1ccfbe(0x165)],_0x35be8d[_0x1ccfbe(0x1df)],_0x364622[_0x1ccfbe(0x1df)],_0x1ccfbe(0xf3),{'statusUnchanged':!![],'paymentDetails':_0x364622[_0x1ccfbe(0xef)],'amount':_0x364622[_0x1ccfbe(0x191)],'currency':_0x364622[_0x1ccfbe(0x17b)],'shopId':_0x35be8d[_0x1ccfbe(0x1d1)],'checkTimestamp':new Date()[_0x1ccfbe(0x1b2)]()});}catch(_0x554b6c){console[_0x1ccfbe(0x1a1)](_0x1ccfbe(0x112)+_0x35be8d['id']+':',_0x554b6c),this['logCoinToPayError'](_0x35be8d['id'],_0x35be8d['gatewayPaymentId'],_0x554b6c,_0x1ccfbe(0xf3),{'paymentAmount':_0x35be8d['amount'],'paymentCurrency':_0x35be8d[_0x1ccfbe(0x17b)],'shopId':_0x35be8d['shopId'],'createdAt':_0x35be8d[_0x1ccfbe(0x175)]}),await database_1[_0x1ccfbe(0x124)][_0x1ccfbe(0xfa)][_0x1ccfbe(0x15b)]({'data':{'paymentId':_0x35be8d['id'],'shopId':_0x35be8d[_0x1ccfbe(0x1d1)],'event':_0x1ccfbe(0x1b9),'statusCode':0x1f4,'responseBody':JSON[_0x1ccfbe(0x1af)]({'error':_0x554b6c instanceof Error?_0x554b6c[_0x1ccfbe(0x19c)]:_0x1ccfbe(0x16c),'gatewayPaymentId':_0x35be8d[_0x1ccfbe(0x165)],'checkedAt':new Date()['toISOString']()})}});}}async[a37_0xd7581f(0x1d5)](_0x130316,_0x3886e9){const _0x48e3ca=a37_0xd7581f,_0x193fbc=Date[_0x48e3ca(0x182)]();try{const _0x5ae55b=_0x130316[_0x48e3ca(0x185)],_0x12d683=_0x5ae55b[_0x48e3ca(0x186)];if(!_0x12d683?.[_0x48e3ca(0x1dc)]){console[_0x48e3ca(0x125)](_0x48e3ca(0x102)+_0x5ae55b['id']);return;}const _0x124ac8=_0x3886e9===_0x48e3ca(0x163)?_0x48e3ca(0x17e):_0x3886e9===_0x48e3ca(0x1ba)?_0x48e3ca(0x12e):_0x3886e9===_0x48e3ca(0x1ae)?_0x48e3ca(0x12e):'payment.pending';if(!_0x12d683[_0x48e3ca(0xff)]?.['includes'](_0x124ac8)){console[_0x48e3ca(0x125)](_0x48e3ca(0x1d0)+_0x124ac8+_0x48e3ca(0x143)+_0x5ae55b['id']);return;}const _0x5f3104={'event':_0x124ac8,'payment':{'id':_0x130316['id'],'order_id':_0x130316[_0x48e3ca(0x13f)],'gateway_order_id':_0x130316[_0x48e3ca(0x1d6)],'gateway':_0x48e3ca(0x197),'amount':_0x130316[_0x48e3ca(0x191)],'currency':_0x130316[_0x48e3ca(0x17b)],'status':_0x3886e9[_0x48e3ca(0x145)](),'customer_email':_0x130316[_0x48e3ca(0x15a)],'customer_name':_0x130316['customerName'],'created_at':_0x130316['createdAt'],'updated_at':new Date()}},_0x2d64f7=await fetch(_0x12d683[_0x48e3ca(0x1dc)],{'method':_0x48e3ca(0x115),'headers':{'Content-Type':_0x48e3ca(0x105),'User-Agent':_0x48e3ca(0x107)},'body':JSON['stringify'](_0x5f3104)}),_0xd7338b=Date[_0x48e3ca(0x182)]()-_0x193fbc,_0x471d2a=_0x2d64f7['ok']?_0x48e3ca(0xf2):await _0x2d64f7[_0x48e3ca(0x19e)]();loggerService_1[_0x48e3ca(0x1e1)][_0x48e3ca(0x171)](_0x130316[_0x48e3ca(0x1d1)],_0x12d683[_0x48e3ca(0x1dc)],_0x124ac8,_0x2d64f7[_0x48e3ca(0x1df)],_0xd7338b,_0x5f3104),console[_0x48e3ca(0x125)](_0x48e3ca(0x111)+_0x12d683[_0x48e3ca(0x1dc)]+'\x20with\x20status\x20'+_0x2d64f7['status']+'\x20('+_0xd7338b+_0x48e3ca(0x1d8));}catch(_0x3e72e2){console[_0x48e3ca(0x1a1)](_0x48e3ca(0x141),_0x3e72e2),loggerService_1['loggerService'][_0x48e3ca(0x1c4)](_0x130316[_0x48e3ca(0x1d1)],_0x130316[_0x48e3ca(0x185)]?.[_0x48e3ca(0x186)]?.['webhookUrl']||_0x48e3ca(0x19d),_0x48e3ca(0x147),_0x3e72e2,{});}}async['sendPaymentStatusNotification'](_0x25d10b,_0x547ee3){const _0x344d70=a37_0xd7581f;try{const _0x4eef10={'PENDING':_0x344d70(0x103),'PAID':_0x344d70(0x1d3),'FAILED':_0x344d70(0x1cd),'EXPIRED':_0x344d70(0x1a3)},_0x35e7a5=_0x4eef10[_0x547ee3];if(!_0x35e7a5||_0x35e7a5===_0x344d70(0x103))return;await telegramBotService_1[_0x344d70(0x17a)]['sendPaymentNotification'](_0x25d10b[_0x344d70(0x1d1)],_0x25d10b,_0x35e7a5);}catch(_0x29d2c3){console[_0x344d70(0x1a1)](_0x344d70(0x176),_0x29d2c3);}}async['checkPaymentById'](_0x241394){const _0x236d73=a37_0xd7581f;console[_0x236d73(0x125)](_0x236d73(0x1be)+_0x241394);const _0x103e8e=await database_1[_0x236d73(0x124)][_0x236d73(0x1ad)][_0x236d73(0xf0)]({'where':{'id':_0x241394},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x103e8e)throw new Error('Payment\x20not\x20found');if(_0x103e8e[_0x236d73(0x152)]!==_0x236d73(0x1d2))throw new Error(_0x236d73(0x164));console[_0x236d73(0x125)](_0x236d73(0x135)+_0x241394),await this[_0x236d73(0x19a)](_0x103e8e),console[_0x236d73(0x125)](_0x236d73(0x183)+_0x241394);}[a37_0xd7581f(0x1ca)](){const _0x515833=a37_0xd7581f,_0x20c112=this[_0x515833(0x128)]?this[_0x515833(0x1b7)]:undefined,_0x5151f4=Array[_0x515833(0x16f)](this[_0x515833(0x166)][_0x515833(0x13e)]())[_0x515833(0x187)](_0x288a05=>({'paymentId':_0x288a05[_0x515833(0x18e)],'gatewayPaymentId':_0x288a05[_0x515833(0x165)],'createdAt':_0x288a05[_0x515833(0x175)],'timersCount':_0x288a05[_0x515833(0xfd)][_0x515833(0x11e)]}));return{'isActive':!!this[_0x515833(0x128)],'globalCheckIntervalMinutes':this[_0x515833(0x1b7)]/(0x3e8*0x3c),'expiryDays':this[_0x515833(0x1de)],'activeIndividualTimers':this[_0x515833(0x166)][_0x515833(0x100)],'nextGlobalCheckIn':_0x20c112,'paymentTimersDetails':_0x5151f4};}[a37_0xd7581f(0x178)](_0x488d2e){const _0x5301b5=a37_0xd7581f,_0x5e5eaa=this['paymentTimers'][_0x5301b5(0x12f)](_0x488d2e);if(_0x5e5eaa)return{'hasTimers':!![],'timersCount':_0x5e5eaa[_0x5301b5(0xfd)][_0x5301b5(0x11e)],'createdAt':_0x5e5eaa[_0x5301b5(0x175)],'gatewayPaymentId':_0x5e5eaa['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a37_0xd7581f(0x1ac)]=CoinToPayStatusService,exports[a37_0xd7581f(0x144)]=new CoinToPayStatusService();