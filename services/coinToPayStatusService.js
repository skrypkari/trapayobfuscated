'use strict';const a38_0x15d6e6=a38_0x3ecb;(function(_0x248a58,_0x4f855a){const _0x446d2e=a38_0x3ecb,_0x4ef7a8=_0x248a58();while(!![]){try{const _0x58d569=-parseInt(_0x446d2e(0x18a))/0x1*(-parseInt(_0x446d2e(0x171))/0x2)+-parseInt(_0x446d2e(0x1f1))/0x3*(parseInt(_0x446d2e(0x239))/0x4)+parseInt(_0x446d2e(0x256))/0x5*(-parseInt(_0x446d2e(0x230))/0x6)+parseInt(_0x446d2e(0x1ec))/0x7+parseInt(_0x446d2e(0x17f))/0x8*(parseInt(_0x446d2e(0x1ac))/0x9)+-parseInt(_0x446d2e(0x212))/0xa*(-parseInt(_0x446d2e(0x1af))/0xb)+-parseInt(_0x446d2e(0x1ca))/0xc*(parseInt(_0x446d2e(0x183))/0xd);if(_0x58d569===_0x4f855a)break;else _0x4ef7a8['push'](_0x4ef7a8['shift']());}catch(_0xabf204){_0x4ef7a8['push'](_0x4ef7a8['shift']());}}}(a38_0x1014,0x870f9));var __importDefault=this&&this[a38_0x15d6e6(0x1b2)]||function(_0x333ab4){const _0x53264d=a38_0x15d6e6;return _0x333ab4&&_0x333ab4[_0x53264d(0x19e)]?_0x333ab4:{'default':_0x333ab4};};Object[a38_0x15d6e6(0x18f)](exports,a38_0x15d6e6(0x19e),{'value':!![]}),exports[a38_0x15d6e6(0x22a)]=exports['CoinToPayStatusService']=void 0x0;function a38_0x1014(){const _0xfef8cd=['1\x20minute','startPeriodicStatusCheck','webhook_send','39IkodZd','✅\x20[EXPIRY]\x20Payment\x20','delay','payment.success','status_check','getServiceStats','paid','83YHffpk','logShopWebhookSent','\x20\x20\x20-\x20GatewayPaymentId:\x20','stopPeriodicStatusCheck','getTime','defineProperty','length','not\x20found','📊\x20[HOURLY]\x20Payment\x20','iban','⏰\x20[GLOBAL]\x20Found\x20','\x20\x20\x20-\x20Status:\x20','findUnique','✅\x20[CHECK]\x20Payment\x20','logCoinToPayStatus','2\x20minutes','\x20\x20\x20📝\x20Context:','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20\x20\x20Gateway\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','__esModule','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','📊\x20[CHECK]\x20Payment\x20','entries','POST','\x20skipped,\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','paymentTimers','COMPLETED','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','-day\x20timeout','🪙\x20[DEBUG]\x20Creating\x20','\x20(age:\x20','set','9xVzKqK','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20individual\x20payment\x20timers','44bwhZbn','default','settings','__importDefault','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','includes','coinToPay2Service','ms)',',\x20using\x20default\x20commission\x2010%','coinToPayService','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','shopId','stringify','payment.failed','webhookLog','GLOBAL_CHECK_INTERVAL_MS','auto_expire','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','type','\x20updated:\x20currentPayments=','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','log','\x20to\x20clear','error','amountUSDT','\x20expired\x20CoinToPay\x20payments','schedulePaymentChecks','3531612tmfKlp','\x20not\x20found\x20in\x20database','logWhiteDomainError','\x20not\x20found,\x20clearing\x20timers','application/json','Failed\x20to\x20send\x20shop\x20webhook:','paymentLinkId','logCoinToPayError','clearPaymentTimers','.\x20Remaining\x20active\x20timers:\x20','Webhook\x20event\x20','delete','globalCheckInterval','\x20to\x20','\x20updated\x20successfully','🔄\x20[CHECK]\x20Updating\x20payment\x20','timers','\x20\x20\x20-\x20paymentId:\x20','push','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','payment.pending','💰\x20[CHECK]\x20Payment\x20','\x20in\x20shop\x20','text','checkSinglePayment','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','cointopay2','checkAllPendingPayments','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20pending\x20CoinToPay\x20payments','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','floor','5265477bOIjlg','\x20->\x20','⏰\x20[GLOBAL]\x20Payment\x20','🪙\x20[GLOBAL]\x20Found\x20','\x20commission:\x20','24KQwjEu','\x20amounts\x20calculated:','gateway','cointopay','getDate','bankDetails',',\x20clearing\x20individual\x20timers','setDate','COINTOPAY_STATUS_CHANGE','checkPaymentById','EXPIRED','createdAt','\x20status\x20changed\x20to\x20','Gateway\x20','🔍\x20[CHECK]\x20Checking\x20','status','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20\x20\x20Amount:\x20','toISOString','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','amount','\x20status\x20is\x20','📈\x20[COINTOPAY]\x20Payment\x20','❌\x20[HOURLY]\x20Payment\x20','⏰\x20[EXPIRY]\x20Payment\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20checked,\x20','✅\x20[COINTOPAY]\x20Payment\x20link\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20completed\x20for\x20payment\x20','\x20with\x20status\x20','\x20marked\x20as\x20paid\x20at:\x20','loggerService','1673870qGpVbt','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','h),\x20skipping\x20global\x20check','./gateways/coinToPayService','\x20\x20\x20-\x20gatewayPaymentId:\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','checkSinglePaymentById','checkPaymentStatus','timestamp','\x20triggered\x20for\x20payment\x20','\x20USDT','paidAt','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','toLowerCase','EXPIRY_DAYS','\x20\x20\x20-\x20Gateway:\x20','❌\x20[CHECK]\x20Payment\x20','createdOn','paymentDetails','gatewaySettings','FAILED','currentPayments','coinToPayStatusService','paymentLink','\x20commission\x20for\x20shop\x20','\x20for\x20payment\x20','\x20timers\x20for\x20payment\x20',',\x20stopping\x20individual\x20checks','6113214GnDghh','\x20payment\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','../types/gateway','cointopay_status_check_','\x20is\x20older\x20than\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','forEach','26072yWZEwa','description','create','expired','\x20details:','\x20\x20\x20📅\x20Time:\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','unknown','convertToUSDT','update','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20has\x20no\x20gatewayPaymentId,\x20skipping','now','Payment\x20not\x20found','\x20\x20\x20📊\x20Status:\x20','\x20(after\x20','message','\x20status:\x20','get','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','sendShopWebhook','5\x20minutes','⏰\x20[HOURLY]\x20Payment\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','currencyService','PAID','Bank\x20Details:\x20','webhookUrl',',\x20status=','5JVfgMe','confirmedOn','payment',':\x20type=','getGatewayCommission','gatewayPaymentId',',\x20using\x20default\x2010%','cointopay_status_check_error','CoinToPayService','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','./currencyService','shop','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20in\x20','transactionId','remitterIban','Payment\x20older\x20than\x20','\x20\x20\x20📍\x20Source:\x20','checkExpiredPayments','/status/','adminNotes','\x20\x20\x20📝\x20Details:','SINGLE','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)',',\x20gateway\x20','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','orderId','\x20found:','\x20current\x20status:\x20','TesSoft\x20Payment\x20System/1.0','paymentId','created','\x20days\x20without\x20payment\x20confirmation','PENDING','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','customerName','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','sendPaymentNotification','🧹\x20[CHECK]\x20Payment\x20','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','5622lgjSdf','amountAfterGatewayCommissionUSDT','toFixed','not\x20confirmed','size','⚠️\x20[CHECK]\x20Payment\x20','customerEmail','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20days','from','sendPaymentStatusNotification','currency','gatewayOrderId','6816424Cahfhb'];a38_0x1014=function(){return _0xfef8cd;};return a38_0x1014();}function a38_0x3ecb(_0x4c59a2,_0x446463){const _0x10143e=a38_0x1014();return a38_0x3ecb=function(_0x3ecb53,_0x11733a){_0x3ecb53=_0x3ecb53-0x171;let _0x1495e5=_0x10143e[_0x3ecb53];return _0x1495e5;},a38_0x3ecb(_0x4c59a2,_0x446463);}const coinToPayService_1=require(a38_0x15d6e6(0x216)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require(a38_0x15d6e6(0x234)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService'),currencyService_1=require(a38_0x15d6e6(0x260));class CoinToPayStatusService{constructor(){const _0x28dddf=a38_0x15d6e6;this[_0x28dddf(0x1d6)]=null,this[_0x28dddf(0x1be)]=0x3c*0x3c*0x3e8,this[_0x28dddf(0x222)]=0x5,this[_0x28dddf(0x1a5)]=new Map(),this[_0x28dddf(0x1b8)]=new coinToPayService_1[(_0x28dddf(0x25e))](),this[_0x28dddf(0x1b5)]=new coinToPay2Service_1['CoinToPay2Service'](),console[_0x28dddf(0x1c4)](_0x28dddf(0x1a7));}[a38_0x15d6e6(0x1c9)](_0x201c6f,_0x1e55a8){const _0x1b3b64=a38_0x15d6e6;console['log'](_0x1b3b64(0x27f)),console['log'](_0x1b3b64(0x1db)+_0x201c6f),console[_0x1b3b64(0x1c4)](_0x1b3b64(0x217)+_0x1e55a8),this[_0x1b3b64(0x1d2)](_0x201c6f);const _0x3d0344=[],_0x3b3776=new Date(),_0x1cb161=[{'delay':0x1*0x3c*0x3e8,'description':_0x1b3b64(0x180)},{'delay':0x2*0x3c*0x3e8,'description':_0x1b3b64(0x199)},{'delay':0x5*0x3c*0x3e8,'description':_0x1b3b64(0x24e)},{'delay':0x5*0x3c*0x3e8,'description':_0x1b3b64(0x24e)}];console[_0x1b3b64(0x1c4)](_0x1b3b64(0x1a9)+_0x1cb161[_0x1b3b64(0x190)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x201c6f);let _0x4e6521=0x0;_0x1cb161[_0x1b3b64(0x238)]((_0x128696,_0x597428)=>{const _0x37e6f1=_0x1b3b64;_0x4e6521+=_0x128696[_0x37e6f1(0x185)];const _0x445752=setTimeout(async()=>{const _0x344701=_0x37e6f1;console[_0x344701(0x1c4)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x597428+0x1)+_0x344701(0x21d)+_0x201c6f+_0x344701(0x248)+_0x128696[_0x344701(0x23a)]+')');try{await this[_0x344701(0x21a)](_0x201c6f),console[_0x344701(0x1c4)](_0x344701(0x1a4)+(_0x597428+0x1)+_0x344701(0x20e)+_0x201c6f);}catch(_0x215b52){console[_0x344701(0x1c6)]('❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x597428+0x1)+'\x20for\x20payment\x20'+_0x201c6f+':',_0x215b52),this[_0x344701(0x1d1)](_0x201c6f,_0x1e55a8,_0x215b52,_0x344701(0x187),{'checkNumber':_0x597428+0x1,'scheduledAfter':_0x128696['description'],'isIndividualCheck':!![]});}},_0x4e6521);_0x3d0344['push'](_0x445752),console[_0x37e6f1(0x1c4)](_0x37e6f1(0x27a)+(_0x597428+0x1)+_0x37e6f1(0x22d)+_0x201c6f+_0x37e6f1(0x264)+_0x4e6521/0x3e8+'\x20seconds\x20('+_0x128696[_0x37e6f1(0x23a)]+')');});const _0x27b222=setInterval(async()=>{const _0x50856a=_0x1b3b64;console['log'](_0x50856a(0x219)+_0x201c6f);try{const _0x257815=await database_1[_0x50856a(0x1b0)]['payment']['findUnique']({'where':{'id':_0x201c6f},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x257815){console[_0x50856a(0x1c4)](_0x50856a(0x208)+_0x201c6f+_0x50856a(0x1cd)),this[_0x50856a(0x1d2)](_0x201c6f);return;}console[_0x50856a(0x1c4)](_0x50856a(0x192)+_0x201c6f+_0x50856a(0x273)+_0x257815['status']);if(_0x257815[_0x50856a(0x200)]!==_0x50856a(0x278)){console[_0x50856a(0x1c4)]('✅\x20[HOURLY]\x20Payment\x20'+_0x201c6f+_0x50856a(0x206)+_0x257815[_0x50856a(0x200)]+_0x50856a(0x22f)),this[_0x50856a(0x1d2)](_0x201c6f);return;}const _0x18f840=Math['floor']((Date[_0x50856a(0x245)]()-_0x257815[_0x50856a(0x1fc)][_0x50856a(0x18e)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x18f840>=this[_0x50856a(0x222)]){console[_0x50856a(0x1c4)](_0x50856a(0x24f)+_0x201c6f+'\x20is\x20older\x20than\x20'+this[_0x50856a(0x222)]+_0x50856a(0x250)),this[_0x50856a(0x1d2)](_0x201c6f);return;}await this[_0x50856a(0x21a)](_0x201c6f),console['log'](_0x50856a(0x218)+_0x201c6f);}catch(_0x5f5838){console[_0x50856a(0x1c6)](_0x50856a(0x204)+_0x201c6f+':',_0x5f5838),this['logCoinToPayError'](_0x201c6f,_0x1e55a8,_0x5f5838,_0x50856a(0x187),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3d0344[_0x1b3b64(0x1dc)](_0x27b222),this[_0x1b3b64(0x1a5)][_0x1b3b64(0x1ab)](_0x201c6f,{'timers':_0x3d0344,'paymentId':_0x201c6f,'gatewayPaymentId':_0x1e55a8,'createdAt':_0x3b3776}),console['log'](_0x1b3b64(0x1e7)+_0x1cb161[_0x1b3b64(0x190)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x201c6f),console[_0x1b3b64(0x1c4)](_0x1b3b64(0x23f)+this[_0x1b3b64(0x1a5)][_0x1b3b64(0x175)]),this['logCoinToPayStatus'](_0x201c6f,_0x1e55a8,_0x1b3b64(0x278),_0x1b3b64(0x278),'status_check',{'action':'schedule_created','scheduledChecks':_0x1cb161[_0x1b3b64(0x190)],'firstCheckIn':_0x1cb161[0x0][_0x1b3b64(0x185)]/0x3e8,'totalTimers':this[_0x1b3b64(0x1a5)][_0x1b3b64(0x175)]});}[a38_0x15d6e6(0x1d2)](_0x267234){const _0x3d8874=a38_0x15d6e6,_0x123f1d=this['paymentTimers'][_0x3d8874(0x24b)](_0x267234);_0x123f1d?(console[_0x3d8874(0x1c4)]('🧹\x20[DEBUG]\x20Clearing\x20'+_0x123f1d['timers'][_0x3d8874(0x190)]+_0x3d8874(0x22e)+_0x267234),_0x123f1d[_0x3d8874(0x1da)]['forEach']((_0x4e5dc7,_0x3dc48f)=>{const _0x1140c4=_0x3d8874;_0x4e5dc7&&(clearTimeout(_0x4e5dc7),clearInterval(_0x4e5dc7),console[_0x1140c4(0x1c4)](_0x1140c4(0x1ad)+(_0x3dc48f+0x1)+_0x1140c4(0x22d)+_0x267234));}),this[_0x3d8874(0x1a5)][_0x3d8874(0x1d5)](_0x267234),console[_0x3d8874(0x1c4)](_0x3d8874(0x270)+_0x267234+_0x3d8874(0x1d3)+this[_0x3d8874(0x1a5)][_0x3d8874(0x175)])):console[_0x3d8874(0x1c4)](_0x3d8874(0x27c)+_0x267234+_0x3d8874(0x1c5));}async['checkSinglePaymentById'](_0x2c73d8){const _0x1f3bc6=a38_0x15d6e6;console[_0x1f3bc6(0x1c4)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x2c73d8);const _0x347995=await database_1[_0x1f3bc6(0x1b0)][_0x1f3bc6(0x258)][_0x1f3bc6(0x196)]({'where':{'id':_0x2c73d8},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x347995){console[_0x1f3bc6(0x1c4)](_0x1f3bc6(0x224)+_0x2c73d8+_0x1f3bc6(0x1cb));return;}console[_0x1f3bc6(0x1c4)](_0x1f3bc6(0x1a0)+_0x2c73d8+_0x1f3bc6(0x272)),console[_0x1f3bc6(0x1c4)](_0x1f3bc6(0x223)+_0x347995[_0x1f3bc6(0x1f3)]),console[_0x1f3bc6(0x1c4)](_0x1f3bc6(0x195)+_0x347995['status']),console[_0x1f3bc6(0x1c4)](_0x1f3bc6(0x18c)+_0x347995[_0x1f3bc6(0x25b)]),console[_0x1f3bc6(0x1c4)]('\x20\x20\x20-\x20Amount:\x20'+_0x347995['amount']+'\x20'+_0x347995['currency']),console[_0x1f3bc6(0x1c4)]('\x20\x20\x20-\x20ShopId:\x20'+_0x347995[_0x1f3bc6(0x1ba)]);if(_0x347995[_0x1f3bc6(0x1f3)]!==_0x1f3bc6(0x1f4)&&_0x347995[_0x1f3bc6(0x1f3)]!==_0x1f3bc6(0x1e5)){console['log'](_0x1f3bc6(0x176)+_0x2c73d8+'\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20'+_0x347995[_0x1f3bc6(0x1f3)]+')');return;}if(_0x347995[_0x1f3bc6(0x200)]!==_0x1f3bc6(0x278)){console[_0x1f3bc6(0x1c4)](_0x1f3bc6(0x176)+_0x2c73d8+_0x1f3bc6(0x206)+_0x347995['status']+',\x20stopping\x20individual\x20checks'),this[_0x1f3bc6(0x1d2)](_0x2c73d8);return;}if(!_0x347995[_0x1f3bc6(0x25b)]){console['log'](_0x1f3bc6(0x176)+_0x2c73d8+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x1f3bc6(0x1c4)](_0x1f3bc6(0x197)+_0x2c73d8+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x1f3bc6(0x1e2)](_0x347995);}[a38_0x15d6e6(0x198)](_0x2276f0,_0x1491fe,_0x115b82,_0x3ceab0,_0x2ac114,_0x1db2cb){const _0x1c19df=a38_0x15d6e6,_0x1b6ccc={'type':_0x1c19df(0x1f9),'paymentId':_0x2276f0,'gatewayPaymentId':_0x1491fe,'oldStatus':_0x115b82,'newStatus':_0x3ceab0,'source':_0x2ac114,'timestamp':new Date()[_0x1c19df(0x203)](),'details':_0x1db2cb||{}};loggerService_1[_0x1c19df(0x211)]['logCoinToPayStatus'](_0x1b6ccc),console[_0x1c19df(0x1c4)](_0x1c19df(0x220)+_0x2276f0+'\x20('+_0x1491fe+')'),console['log'](_0x1c19df(0x247)+_0x115b82+_0x1c19df(0x1ed)+_0x3ceab0),console['log'](_0x1c19df(0x268)+_0x2ac114),console[_0x1c19df(0x1c4)](_0x1c19df(0x23e)+_0x1b6ccc[_0x1c19df(0x21c)]),_0x1db2cb&&console[_0x1c19df(0x1c4)](_0x1c19df(0x26c),_0x1db2cb);}[a38_0x15d6e6(0x1d1)](_0x31bd39,_0x887683,_0x140419,_0xc02ca9,_0x3f1469){const _0x4ae997=a38_0x15d6e6,_0x2c565d={'type':'COINTOPAY_ERROR','paymentId':_0x31bd39,'gatewayPaymentId':_0x887683,'error':_0x140419 instanceof Error?{'message':_0x140419[_0x4ae997(0x249)],'stack':_0x140419['stack']}:_0x140419,'source':_0xc02ca9,'timestamp':new Date()[_0x4ae997(0x203)](),'context':_0x3f1469||{}};loggerService_1[_0x4ae997(0x211)][_0x4ae997(0x1d1)](_0x2c565d),console[_0x4ae997(0x1c6)](_0x4ae997(0x262)+_0x31bd39+'\x20('+_0x887683+')'),console[_0x4ae997(0x1c6)]('\x20\x20\x20❌\x20Error:\x20'+(_0x140419 instanceof Error?_0x140419[_0x4ae997(0x249)]:_0x140419)),console[_0x4ae997(0x1c6)]('\x20\x20\x20📍\x20Source:\x20'+_0xc02ca9),console[_0x4ae997(0x1c6)](_0x4ae997(0x23e)+_0x2c565d[_0x4ae997(0x21c)]),_0x3f1469&&console[_0x4ae997(0x1c6)](_0x4ae997(0x19a),_0x3f1469);}[a38_0x15d6e6(0x181)](){const _0x3ef72b=a38_0x15d6e6;console['log'](_0x3ef72b(0x26e)),this[_0x3ef72b(0x1e6)]()['catch'](_0x399edf=>{const _0x1555d7=_0x3ef72b;console[_0x1555d7(0x1c6)](_0x1555d7(0x24c),_0x399edf);}),this[_0x3ef72b(0x1d6)]=setInterval(async()=>{const _0x2d24bc=_0x3ef72b;try{console[_0x2d24bc(0x1c4)]('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x2d24bc(0x1e6)](),console['log'](_0x2d24bc(0x1ea));}catch(_0x2e02cd){console[_0x2d24bc(0x1c6)](_0x2d24bc(0x1b9),_0x2e02cd);}},this[_0x3ef72b(0x1be)]),console['log'](_0x3ef72b(0x19b));}[a38_0x15d6e6(0x18d)](){const _0x47586a=a38_0x15d6e6;console[_0x47586a(0x1c4)](_0x47586a(0x233));this['globalCheckInterval']&&(clearInterval(this[_0x47586a(0x1d6)]),this[_0x47586a(0x1d6)]=null,console['log']('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x2607bc=this[_0x47586a(0x1a5)][_0x47586a(0x175)];for(const [_0xc7cdd9]of this['paymentTimers']){this[_0x47586a(0x1d2)](_0xc7cdd9);}console[_0x47586a(0x1c4)]('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x2607bc+_0x47586a(0x1ae));}async[a38_0x15d6e6(0x1e6)](){const _0xb3bbea=a38_0x15d6e6;try{console[_0xb3bbea(0x1c4)](_0xb3bbea(0x20a));const _0x50f1cc=await database_1[_0xb3bbea(0x1b0)][_0xb3bbea(0x258)]['findMany']({'where':{'gateway':{'in':[_0xb3bbea(0x1f4),_0xb3bbea(0x1e5)]},'status':_0xb3bbea(0x278),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0xb3bbea(0x1c4)](_0xb3bbea(0x1ef)+_0x50f1cc['length']+_0xb3bbea(0x1e8));if(_0x50f1cc['length']===0x0){console['log'](_0xb3bbea(0x1b3));return;}const _0x134a01=await this['checkExpiredPayments'](_0x50f1cc);console[_0xb3bbea(0x1c4)](_0xb3bbea(0x194)+_0x134a01[_0xb3bbea(0x190)]+_0xb3bbea(0x1c8));let _0x2a5563=0x0,_0x5181b1=0x0;for(const _0x250b47 of _0x50f1cc){try{if(_0x134a01[_0xb3bbea(0x1b4)](_0x250b47['id'])){console[_0xb3bbea(0x1c4)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x250b47['id']+_0xb3bbea(0x263)),_0x5181b1++;continue;}if(this[_0xb3bbea(0x1a5)]['has'](_0x250b47['id'])){console['log'](_0xb3bbea(0x1ee)+_0x250b47['id']+_0xb3bbea(0x179)),_0x5181b1++;continue;}const _0x56e9a9=(Date[_0xb3bbea(0x245)]()-_0x250b47[_0xb3bbea(0x1fc)][_0xb3bbea(0x18e)]())/(0x3e8*0x3c*0x3c);if(_0x56e9a9<0x1){console[_0xb3bbea(0x1c4)](_0xb3bbea(0x1ee)+_0x250b47['id']+'\x20is\x20too\x20new\x20('+_0x56e9a9[_0xb3bbea(0x173)](0x1)+_0xb3bbea(0x215)),_0x5181b1++;continue;}console['log']('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x250b47['id']+_0xb3bbea(0x1aa)+_0x56e9a9[_0xb3bbea(0x173)](0x1)+'h)'),await this[_0xb3bbea(0x1e2)](_0x250b47),_0x2a5563++,await new Promise(_0x596da9=>setTimeout(_0x596da9,0x7d0));}catch(_0x2d708b){console[_0xb3bbea(0x1c6)](_0xb3bbea(0x178)+_0x250b47['id']+':',_0x2d708b),this[_0xb3bbea(0x1d1)](_0x250b47['id'],_0x250b47['gatewayPaymentId']||_0xb3bbea(0x240),_0x2d708b,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x250b47[_0xb3bbea(0x205)],'paymentCurrency':_0x250b47['currency'],'shopId':_0x250b47['shopId'],'createdAt':_0x250b47['createdAt']}),loggerService_1[_0xb3bbea(0x211)][_0xb3bbea(0x1cc)]('cointopay',_0xb3bbea(0x26a)+_0x250b47['gatewayPaymentId'],_0x2d708b);}}console[_0xb3bbea(0x1c4)]('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x2a5563+_0xb3bbea(0x20b)+_0x5181b1+_0xb3bbea(0x1a3)+_0x134a01[_0xb3bbea(0x190)]+'\x20expired');}catch(_0xeaee69){console[_0xb3bbea(0x1c6)](_0xb3bbea(0x213),_0xeaee69);}}async[a38_0x15d6e6(0x269)](_0x34751c){const _0x19811c=a38_0x15d6e6,_0x3f6953=[],_0x385cc7=new Date();_0x385cc7[_0x19811c(0x1f8)](_0x385cc7[_0x19811c(0x1f5)]()-this[_0x19811c(0x222)]),console[_0x19811c(0x1c4)](_0x19811c(0x19f)+this[_0x19811c(0x222)]+'\x20days\x20(created\x20before\x20'+_0x385cc7[_0x19811c(0x203)]()+')');for(const _0xc4486b of _0x34751c){if(_0xc4486b[_0x19811c(0x1fc)]<_0x385cc7){console[_0x19811c(0x1c4)](_0x19811c(0x209)+_0xc4486b['id']+_0x19811c(0x236)+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x19811c(0x198)](_0xc4486b['id'],_0xc4486b[_0x19811c(0x25b)]||'unknown',_0x19811c(0x278),_0x19811c(0x1fb),'auto_expire',{'reason':_0x19811c(0x267)+this['EXPIRY_DAYS']+_0x19811c(0x17a),'createdAt':_0xc4486b[_0x19811c(0x1fc)],'daysSinceCreation':Math[_0x19811c(0x1eb)]((Date[_0x19811c(0x245)]()-_0xc4486b[_0x19811c(0x1fc)][_0x19811c(0x18e)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0xc4486b['amount'],'paymentCurrency':_0xc4486b['currency'],'shopId':_0xc4486b[_0x19811c(0x1ba)]}),await database_1[_0x19811c(0x1b0)][_0x19811c(0x258)][_0x19811c(0x242)]({'where':{'id':_0xc4486b['id']},'data':{'status':_0x19811c(0x1fb),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x19811c(0x222)]+_0x19811c(0x277)}}),await database_1[_0x19811c(0x1b0)]['webhookLog']['create']({'data':{'paymentId':_0xc4486b['id'],'shopId':_0xc4486b['shopId'],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x19811c(0x1bb)]({'reason':_0x19811c(0x267)+this['EXPIRY_DAYS']+_0x19811c(0x17a),'createdAt':_0xc4486b[_0x19811c(0x1fc)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x19811c(0x1eb)]((Date[_0x19811c(0x245)]()-_0xc4486b[_0x19811c(0x1fc)][_0x19811c(0x18e)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x19811c(0x24d)](_0xc4486b,_0x19811c(0x1fb)),await this[_0x19811c(0x17c)](_0xc4486b,'EXPIRED'),this[_0x19811c(0x1d2)](_0xc4486b['id']),_0x3f6953['push'](_0xc4486b['id']),console['log'](_0x19811c(0x184)+_0xc4486b['id']+_0x19811c(0x237)+this['EXPIRY_DAYS']+_0x19811c(0x1a8));}catch(_0x2d91b6){console['error'](_0x19811c(0x1e4)+_0xc4486b['id']+':',_0x2d91b6),this[_0x19811c(0x1d1)](_0xc4486b['id'],_0xc4486b['gatewayPaymentId']||'unknown',_0x2d91b6,_0x19811c(0x1bf),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0xc4486b[_0x19811c(0x1fc)],'daysSinceCreation':Math['floor']((Date[_0x19811c(0x245)]()-_0xc4486b['createdAt'][_0x19811c(0x18e)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x3f6953;}async[a38_0x15d6e6(0x1e2)](_0x553a0d){const _0x4ec339=a38_0x15d6e6;if(!_0x553a0d['gatewayPaymentId']){console[_0x4ec339(0x1c4)](_0x4ec339(0x176)+_0x553a0d['id']+_0x4ec339(0x244));return;}console[_0x4ec339(0x1c4)](_0x4ec339(0x1ff)+_0x553a0d[_0x4ec339(0x1f3)]+_0x4ec339(0x231)+_0x553a0d['id']+'\x20('+_0x553a0d['gatewayPaymentId']+')');try{let _0x4375b1;_0x553a0d[_0x4ec339(0x1f3)]===_0x4ec339(0x1e5)?(_0x4375b1=await this['coinToPay2Service'][_0x4ec339(0x21b)](_0x553a0d['gatewayPaymentId']),console['log']('📊\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x553a0d['id']+'\x20status:\x20'+_0x4375b1[_0x4ec339(0x200)])):(_0x4375b1=await this[_0x4ec339(0x1b8)][_0x4ec339(0x21b)](_0x553a0d[_0x4ec339(0x25b)]),console[_0x4ec339(0x1c4)](_0x4ec339(0x25f)+_0x553a0d['id']+_0x4ec339(0x24a)+_0x4375b1[_0x4ec339(0x200)]));_0x4375b1['paymentDetails']&&console[_0x4ec339(0x1c4)]('📊\x20[CHECK]\x20Payment\x20'+_0x553a0d['id']+_0x4ec339(0x23d),{'iban':_0x4375b1[_0x4ec339(0x226)]['iban']||_0x4ec339(0x191),'transactionId':_0x4375b1[_0x4ec339(0x226)]['transactionId'],'createdOn':_0x4375b1['paymentDetails'][_0x4ec339(0x225)],'confirmedOn':_0x4375b1[_0x4ec339(0x226)][_0x4ec339(0x257)]||_0x4ec339(0x174)});if(_0x4375b1[_0x4ec339(0x200)]!==_0x553a0d[_0x4ec339(0x200)]){console['log'](_0x4ec339(0x1d9)+_0x553a0d['id']+'\x20status\x20from\x20'+_0x553a0d[_0x4ec339(0x200)]+_0x4ec339(0x1d7)+_0x4375b1[_0x4ec339(0x200)]),this['logCoinToPayStatus'](_0x553a0d['id'],_0x553a0d[_0x4ec339(0x25b)],_0x553a0d[_0x4ec339(0x200)],_0x4375b1[_0x4ec339(0x200)],_0x4ec339(0x187),{'paymentDetails':_0x4375b1[_0x4ec339(0x226)],'amount':_0x4375b1[_0x4ec339(0x205)],'currency':_0x4375b1[_0x4ec339(0x17d)],'shopId':_0x553a0d['shopId'],'checkTimestamp':new Date()[_0x4ec339(0x203)]()});const _0x4dd8d6={'status':_0x4375b1[_0x4ec339(0x200)],'updatedAt':new Date()};if(_0x4375b1['status']===_0x4ec339(0x252)&&_0x553a0d['status']!==_0x4ec339(0x252)){_0x4dd8d6[_0x4ec339(0x21f)]=new Date();if(!_0x553a0d[_0x4ec339(0x1c7)]){const _0x48bb30=await currencyService_1[_0x4ec339(0x251)][_0x4ec339(0x241)](_0x553a0d['amount'],_0x553a0d['currency']);_0x4dd8d6[_0x4ec339(0x1c7)]=_0x48bb30;const _0x47de0c=await this[_0x4ec339(0x25a)](_0x553a0d[_0x4ec339(0x1ba)],_0x553a0d[_0x4ec339(0x1f3)]),_0x147ee0=_0x48bb30*(0x1-_0x47de0c/0x64);_0x4dd8d6[_0x4ec339(0x172)]=_0x147ee0,console[_0x4ec339(0x1c4)](_0x4ec339(0x1df)+_0x553a0d['id']+_0x4ec339(0x1f2)),console[_0x4ec339(0x1c4)](_0x4ec339(0x202)+_0x553a0d[_0x4ec339(0x205)]+'\x20'+_0x553a0d[_0x4ec339(0x17d)]+_0x4ec339(0x1ed)+_0x48bb30['toFixed'](0x6)+_0x4ec339(0x21e)),console[_0x4ec339(0x1c4)](_0x4ec339(0x19c)+_0x553a0d[_0x4ec339(0x1f3)]+_0x4ec339(0x1f0)+_0x47de0c+'%'),console[_0x4ec339(0x1c4)]('\x20\x20\x20Amount\x20after\x20commission:\x20'+_0x147ee0[_0x4ec339(0x173)](0x6)+_0x4ec339(0x21e));}console['log'](_0x4ec339(0x1df)+_0x553a0d['id']+_0x4ec339(0x210)+_0x4dd8d6[_0x4ec339(0x21f)][_0x4ec339(0x203)]());}if(_0x4375b1[_0x4ec339(0x226)]){const _0x50d636=_0x4375b1[_0x4ec339(0x226)];_0x50d636[_0x4ec339(0x193)]&&(_0x4dd8d6[_0x4ec339(0x266)]=_0x50d636[_0x4ec339(0x193)],console[_0x4ec339(0x1c4)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x50d636[_0x4ec339(0x193)]));if(_0x50d636[_0x4ec339(0x1f6)]){const _0x4abf73=_0x553a0d[_0x4ec339(0x26b)]||'',_0x3eb0d8=_0x4ec339(0x253)+_0x50d636['bankDetails'];_0x4dd8d6[_0x4ec339(0x26b)]=_0x4abf73?_0x4abf73+'\x0a\x0a'+_0x3eb0d8:_0x3eb0d8,console['log'](_0x4ec339(0x243));}_0x50d636[_0x4ec339(0x265)]&&console[_0x4ec339(0x1c4)](_0x4ec339(0x1e9)+_0x50d636[_0x4ec339(0x265)]),_0x50d636[_0x4ec339(0x257)]&&console[_0x4ec339(0x1c4)](_0x4ec339(0x279)+_0x50d636[_0x4ec339(0x257)]);}await database_1[_0x4ec339(0x1b0)][_0x4ec339(0x258)][_0x4ec339(0x242)]({'where':{'id':_0x553a0d['id']},'data':_0x4dd8d6});if(_0x4375b1['status']===_0x4ec339(0x252)&&_0x553a0d[_0x4ec339(0x200)]!==_0x4ec339(0x252)){console[_0x4ec339(0x1c4)]('📈\x20[COINTOPAY]\x20Payment\x20'+_0x553a0d['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x2e1d67=await database_1[_0x4ec339(0x1b0)][_0x4ec339(0x258)]['findUnique']({'where':{'id':_0x553a0d['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x2e1d67?.[_0x4ec339(0x1d0)]&&_0x2e1d67[_0x4ec339(0x22b)])try{const _0x6918f=_0x2e1d67['paymentLink'];console[_0x4ec339(0x1c4)]('📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x6918f['id']+_0x4ec339(0x259)+_0x6918f[_0x4ec339(0x1c1)]+',\x20currentPayments='+_0x6918f[_0x4ec339(0x229)]+_0x4ec339(0x255)+_0x6918f[_0x4ec339(0x200)]);const _0x5369c9=_0x6918f[_0x4ec339(0x229)]+0x1,_0x406423=_0x6918f['type']===_0x4ec339(0x26d)?_0x4ec339(0x1a6):_0x6918f[_0x4ec339(0x200)];await database_1[_0x4ec339(0x1b0)]['paymentLink']['update']({'where':{'id':_0x6918f['id']},'data':{'currentPayments':_0x5369c9,'status':_0x406423,'updatedAt':new Date()}}),console[_0x4ec339(0x1c4)](_0x4ec339(0x20c)+_0x6918f['id']+_0x4ec339(0x1c2)+_0x6918f['currentPayments']+_0x4ec339(0x1ed)+_0x5369c9+_0x4ec339(0x255)+_0x6918f[_0x4ec339(0x200)]+'\x20->\x20'+_0x406423);}catch(_0x202aa6){console[_0x4ec339(0x1c6)](_0x4ec339(0x1c3),_0x202aa6);}else console['log'](_0x4ec339(0x207)+_0x553a0d['id']+_0x4ec339(0x1dd));}await database_1['default'][_0x4ec339(0x1bd)]['create']({'data':{'paymentId':_0x553a0d['id'],'shopId':_0x553a0d[_0x4ec339(0x1ba)],'event':_0x4ec339(0x235)+_0x4375b1['status'][_0x4ec339(0x221)](),'statusCode':0xc8,'responseBody':JSON[_0x4ec339(0x1bb)]({'oldStatus':_0x553a0d[_0x4ec339(0x200)],'newStatus':_0x4375b1['status'],'paymentDetails':_0x4375b1['paymentDetails'],'checkedAt':new Date()[_0x4ec339(0x203)]()})}}),await this[_0x4ec339(0x24d)](_0x553a0d,_0x4375b1[_0x4ec339(0x200)]),await this[_0x4ec339(0x17c)](_0x553a0d,_0x4375b1[_0x4ec339(0x200)]),_0x4375b1[_0x4ec339(0x200)]!==_0x4ec339(0x278)&&(console[_0x4ec339(0x1c4)](_0x4ec339(0x27e)+_0x553a0d['id']+_0x4ec339(0x1fd)+_0x4375b1[_0x4ec339(0x200)]+_0x4ec339(0x1f7)),this['clearPaymentTimers'](_0x553a0d['id'])),console[_0x4ec339(0x1c4)]('✅\x20[CHECK]\x20Payment\x20'+_0x553a0d['id']+_0x4ec339(0x1d8));}else console['log'](_0x4ec339(0x1a0)+_0x553a0d['id']+'\x20status\x20unchanged\x20('+_0x4375b1[_0x4ec339(0x200)]+')'),this['logCoinToPayStatus'](_0x553a0d['id'],_0x553a0d[_0x4ec339(0x25b)],_0x553a0d[_0x4ec339(0x200)],_0x4375b1[_0x4ec339(0x200)],_0x4ec339(0x187),{'statusUnchanged':!![],'paymentDetails':_0x4375b1['paymentDetails'],'amount':_0x4375b1[_0x4ec339(0x205)],'currency':_0x4375b1['currency'],'shopId':_0x553a0d['shopId'],'checkTimestamp':new Date()[_0x4ec339(0x203)]()});}catch(_0x5b6056){console[_0x4ec339(0x1c6)]('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x553a0d['id']+':',_0x5b6056),this['logCoinToPayError'](_0x553a0d['id'],_0x553a0d['gatewayPaymentId'],_0x5b6056,'status_check',{'paymentAmount':_0x553a0d[_0x4ec339(0x205)],'paymentCurrency':_0x553a0d[_0x4ec339(0x17d)],'shopId':_0x553a0d[_0x4ec339(0x1ba)],'createdAt':_0x553a0d[_0x4ec339(0x1fc)]}),await database_1[_0x4ec339(0x1b0)][_0x4ec339(0x1bd)][_0x4ec339(0x23b)]({'data':{'paymentId':_0x553a0d['id'],'shopId':_0x553a0d[_0x4ec339(0x1ba)],'event':_0x4ec339(0x25d),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x5b6056 instanceof Error?_0x5b6056['message']:'Unknown\x20error','gatewayPaymentId':_0x553a0d[_0x4ec339(0x25b)],'checkedAt':new Date()[_0x4ec339(0x203)]()})}});}}async[a38_0x15d6e6(0x24d)](_0x228ec6,_0x1ba1d6){const _0x5899dc=a38_0x15d6e6,_0x496df8=Date[_0x5899dc(0x245)]();try{const _0x1f880e=_0x228ec6[_0x5899dc(0x261)],_0x1db35c=_0x1f880e['settings'];if(!_0x1db35c?.['webhookUrl']){console[_0x5899dc(0x1c4)](_0x5899dc(0x20d)+_0x1f880e['id']);return;}const _0x2d33d5=_0x1ba1d6==='PAID'?_0x5899dc(0x186):_0x1ba1d6===_0x5899dc(0x228)?_0x5899dc(0x1bc):_0x1ba1d6===_0x5899dc(0x1fb)?_0x5899dc(0x1bc):_0x5899dc(0x1de);if(!_0x1db35c['webhookEvents']?.[_0x5899dc(0x1b4)](_0x2d33d5)){console[_0x5899dc(0x1c4)](_0x5899dc(0x1d4)+_0x2d33d5+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1f880e['id']);return;}const _0x46f671=(0x0,gateway_1['getGatewayIdByName'])(_0x228ec6[_0x5899dc(0x1f3)])||_0x228ec6[_0x5899dc(0x1f3)],_0x51ad18={'event':_0x2d33d5,'payment':{'id':_0x228ec6['id'],'order_id':_0x228ec6[_0x5899dc(0x271)],'gateway_order_id':_0x228ec6[_0x5899dc(0x17e)],'gateway':_0x46f671,'amount':_0x228ec6[_0x5899dc(0x205)],'currency':_0x228ec6[_0x5899dc(0x17d)],'status':_0x1ba1d6[_0x5899dc(0x221)](),'customer_email':_0x228ec6[_0x5899dc(0x177)],'customer_name':_0x228ec6[_0x5899dc(0x27b)],'created_at':_0x228ec6[_0x5899dc(0x1fc)],'updated_at':new Date()}},_0x15b91d=await fetch(_0x1db35c[_0x5899dc(0x254)],{'method':_0x5899dc(0x1a2),'headers':{'Content-Type':_0x5899dc(0x1ce),'User-Agent':_0x5899dc(0x274)},'body':JSON[_0x5899dc(0x1bb)](_0x51ad18)}),_0x5ee63f=Date[_0x5899dc(0x245)]()-_0x496df8,_0x3a1453=_0x15b91d['ok']?'Success':await _0x15b91d[_0x5899dc(0x1e1)]();loggerService_1[_0x5899dc(0x211)][_0x5899dc(0x18b)](_0x228ec6[_0x5899dc(0x1ba)],_0x1db35c[_0x5899dc(0x254)],_0x2d33d5,_0x15b91d[_0x5899dc(0x200)],_0x5ee63f,_0x51ad18),console[_0x5899dc(0x1c4)]('Shop\x20webhook\x20sent\x20to\x20'+_0x1db35c[_0x5899dc(0x254)]+_0x5899dc(0x20f)+_0x15b91d['status']+'\x20('+_0x5ee63f+_0x5899dc(0x1b6));}catch(_0x12a584){console[_0x5899dc(0x1c6)](_0x5899dc(0x1cf),_0x12a584),loggerService_1['loggerService']['logShopWebhookError'](_0x228ec6[_0x5899dc(0x1ba)],_0x228ec6[_0x5899dc(0x261)]?.[_0x5899dc(0x1b1)]?.[_0x5899dc(0x254)]||_0x5899dc(0x240),_0x5899dc(0x182),_0x12a584,{});}}async[a38_0x15d6e6(0x17c)](_0x5ccd64,_0x2e5e33){const _0x442af2=a38_0x15d6e6;try{const _0x58c55b={'PENDING':_0x442af2(0x276),'PAID':_0x442af2(0x189),'FAILED':'failed','EXPIRED':_0x442af2(0x23c)},_0x540cf5=_0x58c55b[_0x2e5e33];if(!_0x540cf5||_0x540cf5==='created')return;await telegramBotService_1['telegramBotService'][_0x442af2(0x27d)](_0x5ccd64[_0x442af2(0x1ba)],_0x5ccd64,_0x540cf5);}catch(_0x571a2c){console[_0x442af2(0x1c6)](_0x442af2(0x1c0),_0x571a2c);}}async[a38_0x15d6e6(0x1fa)](_0x414b39){const _0x73ad3b=a38_0x15d6e6;console[_0x73ad3b(0x1c4)](_0x73ad3b(0x201)+_0x414b39);const _0x3ac17a=await database_1[_0x73ad3b(0x1b0)][_0x73ad3b(0x258)][_0x73ad3b(0x196)]({'where':{'id':_0x414b39},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3ac17a)throw new Error(_0x73ad3b(0x246));if(_0x3ac17a[_0x73ad3b(0x1f3)]!==_0x73ad3b(0x1f4)&&_0x3ac17a[_0x73ad3b(0x1f3)]!==_0x73ad3b(0x1e5))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x73ad3b(0x1c4)](_0x73ad3b(0x19d)+_0x3ac17a['gateway']+'\x20payment\x20'+_0x414b39),await this[_0x73ad3b(0x1e2)](_0x3ac17a),console[_0x73ad3b(0x1c4)](_0x73ad3b(0x1e3)+_0x414b39);}[a38_0x15d6e6(0x188)](){const _0x371955=a38_0x15d6e6,_0x37884f=this[_0x371955(0x1d6)]?this[_0x371955(0x1be)]:undefined,_0x37b7d5=Array[_0x371955(0x17b)](this['paymentTimers']['values']())['map'](_0x179cbe=>({'paymentId':_0x179cbe[_0x371955(0x275)],'gatewayPaymentId':_0x179cbe[_0x371955(0x25b)],'createdAt':_0x179cbe[_0x371955(0x1fc)],'timersCount':_0x179cbe[_0x371955(0x1da)][_0x371955(0x190)]}));return{'isActive':!!this[_0x371955(0x1d6)],'globalCheckIntervalMinutes':this[_0x371955(0x1be)]/(0x3e8*0x3c),'expiryDays':this[_0x371955(0x222)],'activeIndividualTimers':this[_0x371955(0x1a5)]['size'],'nextGlobalCheckIn':_0x37884f,'paymentTimersDetails':_0x37b7d5};}['getPaymentTimerInfo'](_0x26643e){const _0x13e9f9=a38_0x15d6e6,_0x59e528=this['paymentTimers'][_0x13e9f9(0x24b)](_0x26643e);if(_0x59e528)return{'hasTimers':!![],'timersCount':_0x59e528[_0x13e9f9(0x1da)][_0x13e9f9(0x190)],'createdAt':_0x59e528[_0x13e9f9(0x1fc)],'gatewayPaymentId':_0x59e528[_0x13e9f9(0x25b)]};return{'hasTimers':![]};}async[a38_0x15d6e6(0x25a)](_0x1536dc,_0x3dfe07){const _0x1afe33=a38_0x15d6e6;try{const _0x309c49=await database_1[_0x1afe33(0x1b0)]['shop'][_0x1afe33(0x196)]({'where':{'id':_0x1536dc},'select':{'gatewaySettings':!![]}});if(!_0x309c49?.[_0x1afe33(0x227)])return console['log'](_0x1afe33(0x232)+_0x1536dc+_0x1afe33(0x1b7)),0xa;const _0x5c5219=JSON['parse'](_0x309c49['gatewaySettings']);for(const [_0x1190c2,_0x41b862]of Object[_0x1afe33(0x1a1)](_0x5c5219)){if(_0x1190c2[_0x1afe33(0x221)]()===_0x3dfe07[_0x1afe33(0x221)]()){const _0x3c2b15=_0x41b862['commission']||0xa;return console[_0x1afe33(0x1c4)](_0x1afe33(0x1fe)+_0x3dfe07+_0x1afe33(0x22c)+_0x1536dc+':\x20'+_0x3c2b15+'%'),_0x3c2b15;}}return console[_0x1afe33(0x1c4)]('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0x3dfe07+_0x1afe33(0x1e0)+_0x1536dc+_0x1afe33(0x25c)),0xa;}catch(_0x42ab73){return console[_0x1afe33(0x1c6)](_0x1afe33(0x214)+_0x1536dc+_0x1afe33(0x26f)+_0x3dfe07+':',_0x42ab73),0xa;}}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a38_0x15d6e6(0x22a)]=new CoinToPayStatusService();