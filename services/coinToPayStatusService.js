'use strict';function a52_0x3cc3(_0x392a1c,_0x2d9841){_0x392a1c=_0x392a1c-0x192;const _0x5b86da=a52_0x5b86();let _0x3cc3bf=_0x5b86da[_0x392a1c];return _0x3cc3bf;}const a52_0x37e68f=a52_0x3cc3;(function(_0x597b15,_0x228bba){const _0x4459cb=a52_0x3cc3,_0x57956e=_0x597b15();while(!![]){try{const _0x58d8bb=parseInt(_0x4459cb(0x26f))/0x1*(parseInt(_0x4459cb(0x299))/0x2)+-parseInt(_0x4459cb(0x240))/0x3+-parseInt(_0x4459cb(0x24f))/0x4+parseInt(_0x4459cb(0x244))/0x5*(-parseInt(_0x4459cb(0x19e))/0x6)+parseInt(_0x4459cb(0x258))/0x7+parseInt(_0x4459cb(0x1ca))/0x8*(-parseInt(_0x4459cb(0x29d))/0x9)+parseInt(_0x4459cb(0x263))/0xa*(parseInt(_0x4459cb(0x23e))/0xb);if(_0x58d8bb===_0x228bba)break;else _0x57956e['push'](_0x57956e['shift']());}catch(_0x573926){_0x57956e['push'](_0x57956e['shift']());}}}(a52_0x5b86,0xc2500));function a52_0x5b86(){const _0x38f5f0=['cointopay_status_check_','defineProperty','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','createdAt','h),\x20skipping\x20global\x20check','bankDetails','\x20not\x20found,\x20clearing\x20timers','‚è∞\x20[GLOBAL]\x20Payment\x20','\x20status:\x20','now','\x20\x20\x20üìù\x20Details:','COINTOPAY_STATUS_CHANGE','SINGLE','toFixed','paymentDetails','status_check','\x20not\x20enabled\x20for\x20shop\x20','\x20checked,\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','coinToPayService','shopId',',\x20status=','-day\x20timeout','POST','üõë\x20[SHUTDOWN]\x20Cleared\x20','toLowerCase','‚úÖ\x20[CHECK]\x20Payment\x20','8itWWCa','Webhook\x20event\x20','\x20days','payment.pending','1\x20minute','\x20\x20\x20üìç\x20Source:\x20','CoinToPayStatusService','timestamp','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','payment.failed','\x20payment\x20','\x20to\x20clear','ü™ô\x20[DEBUG]\x20Creating\x20','\x20status\x20from\x20','type','\x20individual\x20payment\x20timers','No\x20specific\x20commission\x20found\x20for\x20gateway\x20',':\x20type=','entries','COINTOPAY_ERROR','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','auto_expire','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20days\x20(created\x20before\x20','iban','sendPaymentStatusNotification','not\x20found','text','./currencyService','\x20in\x20','2\x20minutes','gateway','üìà\x20[COINTOPAY]\x20Payment\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20USDT','üîç\x20[CHECK]\x20Checking\x20','logShopWebhookError','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','webhookLog','getPaymentTimerInfo','customerEmail','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','remitterIban','GLOBAL_CHECK_INTERVAL_MS','includes','shop','.\x20Remaining\x20active\x20timers:\x20','coinToPay2Service','\x20seconds\x20(','\x20\x20\x20Amount:\x20','../config/database','error','üßπ\x20[DEBUG]\x20Clearing\x20','webhookEvents','transactionId','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','getTime','globalCheckInterval','has','\x20\x20\x20-\x20Amount:\x20','\x20->\x20','\x20timers\x20for\x20payment\x20','findMany','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','__esModule','logCoinToPayError','ms)','amount','\x20not\x20found\x20in\x20database','cointopay_status_check_error','\x20found:','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','webhookUrl','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','orderId','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','amountUSDT','createdOn','size','\x20commission\x20for\x20shop\x20','currentPayments','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20\x20\x20‚ùå\x20Error:\x20','getGatewayCommission','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','\x20\x20\x20üìÖ\x20Time:\x20','map','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','timers','./gateways/coinToPayService','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','üí∞\x20[CHECK]\x20Payment\x20','gatewayCommissionRate','\x20updated\x20successfully','payment','logCoinToPayStatus','\x20\x20\x20üìä\x20Status:\x20','stopPeriodicStatusCheck','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','../types/gateway','getDate','forEach','/status/','\x20is\x20older\x20than\x20','./gateways/coinToPay2Service','message',',\x20clearing\x20individual\x20timers','\x20details:','Payment\x20older\x20than\x20','update','2675706GcFwFQ','unknown','3537471lOoRGR','gatewayPaymentId','checkPaymentStatus','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','5DhhqLM','status','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','Failed\x20to\x20send\x20shop\x20webhook:','5\x20minutes','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','paymentLink','settings','checkAllPendingPayments','checkSinglePaymentById','2570000joWoix','\x20current\x20status:\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','paymentId','\x20\x20\x20-\x20Gateway:\x20','cointopay2','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','push','paidAt','3629059jEJaOY','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','sendPaymentNotification','üìä\x20[CHECK]\x20Payment\x20','FAILED','schedulePaymentChecks','confirmedOn','amountAfterGatewayCommissionUSDT','\x20days,\x20marking\x20as\x20EXPIRED','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','130KxZyPn','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','‚ùå\x20[HOURLY]\x20Payment\x20','\x20is\x20too\x20new\x20(','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20status\x20is\x20','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20',',\x20stopping\x20individual\x20checks','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','üßπ\x20[CHECK]\x20Payment\x20','expired','59rZzdcm','\x20updated:\x20currentPayments=','‚ùå\x20[CHECK]\x20Payment\x20','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','checkExpiredPayments','checkSinglePayment','\x20\x20\x20-\x20paymentId:\x20','create','\x20commission:\x20','\x20initial\x20timers\x20for\x20payment\x20','findUnique','\x20status\x20unchanged\x20(','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','commission','Failed\x20to\x20mark\x20payment\x20as\x20expired','coinToPayStatusService','delay','currency','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','toISOString','logWhiteDomainError','values','stringify','\x20\x20\x20-\x20Status:\x20','log','length','floor','./telegramBotService','\x20skipped,\x20','\x20expired\x20CoinToPay\x20payments','paymentTimers','PENDING','EXPIRED','get','PAID','description','clearPaymentTimers','Unknown\x20error','cointopay','paid','\x20(age:\x20','\x20to\x20','15238HSSLDM','EXPIRY_DAYS','webhook_send','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','5112189UFgUow','\x20completed\x20for\x20payment\x20','from','\x20(after\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paymentLinkId','‚úÖ\x20[HOURLY]\x20Payment\x20','gatewaySettings','telegramBotService','failed','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','5667444RDauFc','parse','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','default','üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','\x20for\x20payment\x20','getServiceStats','\x20in\x20shop\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','not\x20confirmed','schedule_created','loggerService','startPeriodicStatusCheck','\x20with\x20status\x20','COMPLETED','sendShopWebhook'];a52_0x5b86=function(){return _0x38f5f0;};return a52_0x5b86();}var __importDefault=this&&this['__importDefault']||function(_0x429bed){const _0xb5cc3f=a52_0x3cc3;return _0x429bed&&_0x429bed[_0xb5cc3f(0x20c)]?_0x429bed:{'default':_0x429bed};};Object[a52_0x37e68f(0x1b0)](exports,'__esModule',{'value':!![]}),exports[a52_0x37e68f(0x27e)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a52_0x37e68f(0x229)),coinToPay2Service_1=require(a52_0x37e68f(0x238)),gateway_1=require(a52_0x37e68f(0x233)),database_1=__importDefault(require(a52_0x37e68f(0x1fd))),telegramBotService_1=require(a52_0x37e68f(0x28a)),loggerService_1=require('./loggerService'),currencyService_1=require(a52_0x37e68f(0x1e7));class CoinToPayStatusService{constructor(){const _0x2d49e9=a52_0x37e68f;this['globalCheckInterval']=null,this[_0x2d49e9(0x1f6)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x2d49e9(0x28d)]=new Map(),this[_0x2d49e9(0x1c2)]=new coinToPayService_1['CoinToPayService'](),this[_0x2d49e9(0x1fa)]=new coinToPay2Service_1['CoinToPay2Service'](),console['log'](_0x2d49e9(0x1d2));}[a52_0x37e68f(0x25d)](_0x33935a,_0x4b61ea){const _0x2c6439=a52_0x37e68f;console[_0x2c6439(0x287)](_0x2c6439(0x1d3)),console[_0x2c6439(0x287)](_0x2c6439(0x275)+_0x33935a),console['log']('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x4b61ea),this['clearPaymentTimers'](_0x33935a);const _0x462f1d=[],_0x1b5939=new Date(),_0x2b3776=[{'delay':0x1*0x3c*0x3e8,'description':_0x2c6439(0x1ce)},{'delay':0x2*0x3c*0x3e8,'description':_0x2c6439(0x1e9)},{'delay':0x5*0x3c*0x3e8,'description':_0x2c6439(0x248)},{'delay':0x5*0x3c*0x3e8,'description':_0x2c6439(0x248)}];console['log'](_0x2c6439(0x1d7)+_0x2b3776[_0x2c6439(0x288)]+_0x2c6439(0x278)+_0x33935a);let _0x15d234=0x0;_0x2b3776[_0x2c6439(0x235)]((_0x14dd4f,_0x39bdbf)=>{const _0x2f4f11=_0x2c6439;_0x15d234+=_0x14dd4f[_0x2f4f11(0x27f)];const _0x2aefea=setTimeout(async()=>{const _0x2e48fb=_0x2f4f11;console['log'](_0x2e48fb(0x243)+(_0x39bdbf+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x33935a+_0x2e48fb(0x194)+_0x14dd4f[_0x2e48fb(0x292)]+')');try{await this[_0x2e48fb(0x24e)](_0x33935a),console['log'](_0x2e48fb(0x224)+(_0x39bdbf+0x1)+_0x2e48fb(0x192)+_0x33935a);}catch(_0x3b0cc5){console[_0x2e48fb(0x1fe)](_0x2e48fb(0x1df)+(_0x39bdbf+0x1)+_0x2e48fb(0x1a3)+_0x33935a+':',_0x3b0cc5),this[_0x2e48fb(0x20d)](_0x33935a,_0x4b61ea,_0x3b0cc5,'status_check',{'checkNumber':_0x39bdbf+0x1,'scheduledAfter':_0x14dd4f[_0x2e48fb(0x292)],'isIndividualCheck':!![]});}},_0x15d234);_0x462f1d[_0x2f4f11(0x256)](_0x2aefea),console[_0x2f4f11(0x287)](_0x2f4f11(0x202)+(_0x39bdbf+0x1)+_0x2f4f11(0x1a3)+_0x33935a+_0x2f4f11(0x1e8)+_0x15d234/0x3e8+_0x2f4f11(0x1fb)+_0x14dd4f[_0x2f4f11(0x292)]+')');});const _0x2ba8ec=setInterval(async()=>{const _0xc8fb9d=_0x2c6439;console[_0xc8fb9d(0x287)](_0xc8fb9d(0x264)+_0x33935a);try{const _0x2de7cd=await database_1[_0xc8fb9d(0x1a1)]['payment'][_0xc8fb9d(0x279)]({'where':{'id':_0x33935a},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x2de7cd){console[_0xc8fb9d(0x287)](_0xc8fb9d(0x265)+_0x33935a+_0xc8fb9d(0x1b5)),this[_0xc8fb9d(0x293)](_0x33935a);return;}console['log']('üìä\x20[HOURLY]\x20Payment\x20'+_0x33935a+_0xc8fb9d(0x250)+_0x2de7cd['status']);if(_0x2de7cd['status']!=='PENDING'){console['log'](_0xc8fb9d(0x198)+_0x33935a+_0xc8fb9d(0x269)+_0x2de7cd[_0xc8fb9d(0x245)]+_0xc8fb9d(0x26b)),this[_0xc8fb9d(0x293)](_0x33935a);return;}const _0x396e32=Math[_0xc8fb9d(0x289)]((Date[_0xc8fb9d(0x1b8)]()-_0x2de7cd[_0xc8fb9d(0x1b2)][_0xc8fb9d(0x204)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x396e32>=this['EXPIRY_DAYS']){console[_0xc8fb9d(0x287)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x33935a+_0xc8fb9d(0x237)+this[_0xc8fb9d(0x29a)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0xc8fb9d(0x293)](_0x33935a);return;}await this[_0xc8fb9d(0x24e)](_0x33935a),console[_0xc8fb9d(0x287)](_0xc8fb9d(0x262)+_0x33935a);}catch(_0x2851d9){console[_0xc8fb9d(0x1fe)]('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x33935a+':',_0x2851d9),this['logCoinToPayError'](_0x33935a,_0x4b61ea,_0x2851d9,_0xc8fb9d(0x1be),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x462f1d[_0x2c6439(0x256)](_0x2ba8ec),this[_0x2c6439(0x28d)]['set'](_0x33935a,{'timers':_0x462f1d,'paymentId':_0x33935a,'gatewayPaymentId':_0x4b61ea,'createdAt':_0x1b5939}),console[_0x2c6439(0x287)](_0x2c6439(0x227)+_0x2b3776['length']+_0x2c6439(0x1f4)+_0x33935a),console[_0x2c6439(0x287)](_0x2c6439(0x1a7)+this[_0x2c6439(0x28d)][_0x2c6439(0x21d)]),this[_0x2c6439(0x22f)](_0x33935a,_0x4b61ea,_0x2c6439(0x28e),_0x2c6439(0x28e),_0x2c6439(0x1be),{'action':_0x2c6439(0x1a9),'scheduledChecks':_0x2b3776[_0x2c6439(0x288)],'firstCheckIn':_0x2b3776[0x0][_0x2c6439(0x27f)]/0x3e8,'totalTimers':this[_0x2c6439(0x28d)][_0x2c6439(0x21d)]});}['clearPaymentTimers'](_0x41f582){const _0x48872a=a52_0x37e68f,_0x2c0e86=this[_0x48872a(0x28d)]['get'](_0x41f582);_0x2c0e86?(console['log'](_0x48872a(0x1ff)+_0x2c0e86[_0x48872a(0x228)][_0x48872a(0x288)]+_0x48872a(0x209)+_0x41f582),_0x2c0e86[_0x48872a(0x228)][_0x48872a(0x235)]((_0x3d5b7f,_0x1037de)=>{const _0x2b8104=_0x48872a;_0x3d5b7f&&(clearTimeout(_0x3d5b7f),clearInterval(_0x3d5b7f),console['log'](_0x2b8104(0x1a6)+(_0x1037de+0x1)+_0x2b8104(0x1a3)+_0x41f582));}),this[_0x48872a(0x28d)]['delete'](_0x41f582),console[_0x48872a(0x287)]('‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x41f582+_0x48872a(0x1f9)+this['paymentTimers'][_0x48872a(0x21d)])):console[_0x48872a(0x287)](_0x48872a(0x203)+_0x41f582+_0x48872a(0x1d6));}async[a52_0x37e68f(0x24e)](_0x106b59){const _0x56a990=a52_0x37e68f;console['log']('üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x106b59);const _0x268854=await database_1[_0x56a990(0x1a1)][_0x56a990(0x22e)][_0x56a990(0x279)]({'where':{'id':_0x106b59},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x268854){console[_0x56a990(0x287)](_0x56a990(0x271)+_0x106b59+_0x56a990(0x210));return;}console['log'](_0x56a990(0x25b)+_0x106b59+_0x56a990(0x212)),console[_0x56a990(0x287)](_0x56a990(0x253)+_0x268854[_0x56a990(0x1ea)]),console[_0x56a990(0x287)](_0x56a990(0x286)+_0x268854['status']),console[_0x56a990(0x287)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x268854[_0x56a990(0x241)]),console[_0x56a990(0x287)](_0x56a990(0x207)+_0x268854[_0x56a990(0x20f)]+'\x20'+_0x268854[_0x56a990(0x280)]),console[_0x56a990(0x287)]('\x20\x20\x20-\x20ShopId:\x20'+_0x268854[_0x56a990(0x1c3)]);if(_0x268854[_0x56a990(0x1ea)]!==_0x56a990(0x295)&&_0x268854[_0x56a990(0x1ea)]!==_0x56a990(0x254)){console[_0x56a990(0x287)](_0x56a990(0x21a)+_0x106b59+'\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20'+_0x268854[_0x56a990(0x1ea)]+')');return;}if(_0x268854[_0x56a990(0x245)]!==_0x56a990(0x28e)){console[_0x56a990(0x287)](_0x56a990(0x21a)+_0x106b59+_0x56a990(0x269)+_0x268854[_0x56a990(0x245)]+',\x20stopping\x20individual\x20checks'),this[_0x56a990(0x293)](_0x106b59);return;}if(!_0x268854[_0x56a990(0x241)]){console[_0x56a990(0x287)](_0x56a990(0x21a)+_0x106b59+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x56a990(0x287)](_0x56a990(0x1c9)+_0x106b59+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x56a990(0x274)](_0x268854);}[a52_0x37e68f(0x22f)](_0x254217,_0x124e38,_0x5ea517,_0x53e276,_0x4fc270,_0x22c49c){const _0x5aa302=a52_0x37e68f,_0x364c22={'type':_0x5aa302(0x1ba),'paymentId':_0x254217,'gatewayPaymentId':_0x124e38,'oldStatus':_0x5ea517,'newStatus':_0x53e276,'source':_0x4fc270,'timestamp':new Date()[_0x5aa302(0x282)](),'details':_0x22c49c||{}};loggerService_1[_0x5aa302(0x1aa)][_0x5aa302(0x22f)](_0x364c22),console[_0x5aa302(0x287)](_0x5aa302(0x216)+_0x254217+'\x20('+_0x124e38+')'),console[_0x5aa302(0x287)](_0x5aa302(0x230)+_0x5ea517+_0x5aa302(0x208)+_0x53e276),console['log'](_0x5aa302(0x1cf)+_0x4fc270),console['log'](_0x5aa302(0x225)+_0x364c22[_0x5aa302(0x1d1)]),_0x22c49c&&console['log'](_0x5aa302(0x1b9),_0x22c49c);}[a52_0x37e68f(0x20d)](_0x1825de,_0x3d6271,_0x2b4c6f,_0x512448,_0x185446){const _0x248733=a52_0x37e68f,_0x4c7f95={'type':_0x248733(0x1de),'paymentId':_0x1825de,'gatewayPaymentId':_0x3d6271,'error':_0x2b4c6f instanceof Error?{'message':_0x2b4c6f[_0x248733(0x239)],'stack':_0x2b4c6f['stack']}:_0x2b4c6f,'source':_0x512448,'timestamp':new Date()['toISOString'](),'context':_0x185446||{}};loggerService_1[_0x248733(0x1aa)][_0x248733(0x20d)](_0x4c7f95),console[_0x248733(0x1fe)](_0x248733(0x232)+_0x1825de+'\x20('+_0x3d6271+')'),console[_0x248733(0x1fe)](_0x248733(0x222)+(_0x2b4c6f instanceof Error?_0x2b4c6f[_0x248733(0x239)]:_0x2b4c6f)),console[_0x248733(0x1fe)](_0x248733(0x1cf)+_0x512448),console[_0x248733(0x1fe)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x4c7f95[_0x248733(0x1d1)]),_0x185446&&console[_0x248733(0x1fe)]('\x20\x20\x20üìù\x20Context:',_0x185446);}[a52_0x37e68f(0x1ab)](){const _0x371c33=a52_0x37e68f;console['log'](_0x371c33(0x215)),this[_0x371c33(0x24d)]()['catch'](_0x4bb524=>{const _0xc07cc2=_0x371c33;console[_0xc07cc2(0x1fe)](_0xc07cc2(0x220),_0x4bb524);}),this[_0x371c33(0x205)]=setInterval(async()=>{const _0x3b7f65=_0x371c33;try{console[_0x3b7f65(0x287)](_0x3b7f65(0x268)),await this[_0x3b7f65(0x24d)](),console[_0x3b7f65(0x287)](_0x3b7f65(0x1e1));}catch(_0xaf45f7){console[_0x3b7f65(0x1fe)](_0x3b7f65(0x19d),_0xaf45f7);}},this['GLOBAL_CHECK_INTERVAL_MS']),console['log'](_0x371c33(0x195));}[a52_0x37e68f(0x231)](){const _0xbded07=a52_0x37e68f;console[_0xbded07(0x287)](_0xbded07(0x213));this['globalCheckInterval']&&(clearInterval(this[_0xbded07(0x205)]),this[_0xbded07(0x205)]=null,console[_0xbded07(0x287)]('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x295d82=this['paymentTimers'][_0xbded07(0x21d)];for(const [_0x185e07]of this[_0xbded07(0x28d)]){this['clearPaymentTimers'](_0x185e07);}console[_0xbded07(0x287)](_0xbded07(0x1c7)+_0x295d82+_0xbded07(0x1da));}async[a52_0x37e68f(0x24d)](){const _0x2d3849=a52_0x37e68f;try{console[_0x2d3849(0x287)](_0x2d3849(0x26c));const _0x2d2362=await database_1[_0x2d3849(0x1a1)][_0x2d3849(0x22e)][_0x2d3849(0x20a)]({'where':{'gateway':{'in':[_0x2d3849(0x295),_0x2d3849(0x254)]},'status':_0x2d3849(0x28e),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x2d3849(0x287)]('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x2d2362[_0x2d3849(0x288)]+'\x20pending\x20CoinToPay\x20payments');if(_0x2d2362[_0x2d3849(0x288)]===0x0){console['log'](_0x2d3849(0x217));return;}const _0x68f50e=await this[_0x2d3849(0x273)](_0x2d2362);console['log']('‚è∞\x20[GLOBAL]\x20Found\x20'+_0x68f50e[_0x2d3849(0x288)]+_0x2d3849(0x28c));let _0x1a0bda=0x0,_0x203fd7=0x0;for(const _0x22b8c7 of _0x2d2362){try{if(_0x68f50e['includes'](_0x22b8c7['id'])){console[_0x2d3849(0x287)](_0x2d3849(0x1b6)+_0x22b8c7['id']+_0x2d3849(0x20b)),_0x203fd7++;continue;}if(this[_0x2d3849(0x28d)][_0x2d3849(0x206)](_0x22b8c7['id'])){console[_0x2d3849(0x287)](_0x2d3849(0x1b6)+_0x22b8c7['id']+_0x2d3849(0x1b1)),_0x203fd7++;continue;}const _0x27c429=(Date[_0x2d3849(0x1b8)]()-_0x22b8c7[_0x2d3849(0x1b2)][_0x2d3849(0x204)]())/(0x3e8*0x3c*0x3c);if(_0x27c429<0x1){console[_0x2d3849(0x287)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x22b8c7['id']+_0x2d3849(0x266)+_0x27c429[_0x2d3849(0x1bc)](0x1)+_0x2d3849(0x1b3)),_0x203fd7++;continue;}console[_0x2d3849(0x287)]('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x22b8c7['id']+_0x2d3849(0x297)+_0x27c429['toFixed'](0x1)+'h)'),await this[_0x2d3849(0x274)](_0x22b8c7),_0x1a0bda++,await new Promise(_0x286f4d=>setTimeout(_0x286f4d,0x7d0));}catch(_0x112700){console[_0x2d3849(0x1fe)](_0x2d3849(0x1c1)+_0x22b8c7['id']+':',_0x112700),this[_0x2d3849(0x20d)](_0x22b8c7['id'],_0x22b8c7[_0x2d3849(0x241)]||_0x2d3849(0x23f),_0x112700,_0x2d3849(0x1be),{'isGlobalCheck':!![],'paymentAmount':_0x22b8c7[_0x2d3849(0x20f)],'paymentCurrency':_0x22b8c7['currency'],'shopId':_0x22b8c7[_0x2d3849(0x1c3)],'createdAt':_0x22b8c7['createdAt']}),loggerService_1[_0x2d3849(0x1aa)][_0x2d3849(0x283)]('cointopay',_0x2d3849(0x236)+_0x22b8c7[_0x2d3849(0x241)],_0x112700);}}console['log'](_0x2d3849(0x27b)+_0x1a0bda+_0x2d3849(0x1c0)+_0x203fd7+_0x2d3849(0x28b)+_0x68f50e['length']+'\x20expired');}catch(_0x307c92){console[_0x2d3849(0x1fe)](_0x2d3849(0x19c),_0x307c92);}}async[a52_0x37e68f(0x273)](_0x4f29a6){const _0x1d0d22=a52_0x37e68f,_0x4c3842=[],_0x16b22a=new Date();_0x16b22a['setDate'](_0x16b22a[_0x1d0d22(0x234)]()-this[_0x1d0d22(0x29a)]),console[_0x1d0d22(0x287)](_0x1d0d22(0x22a)+this['EXPIRY_DAYS']+_0x1d0d22(0x1e2)+_0x16b22a[_0x1d0d22(0x282)]()+')');for(const _0x2ef6f4 of _0x4f29a6){if(_0x2ef6f4[_0x1d0d22(0x1b2)]<_0x16b22a){console['log']('‚è∞\x20[EXPIRY]\x20Payment\x20'+_0x2ef6f4['id']+_0x1d0d22(0x237)+this['EXPIRY_DAYS']+_0x1d0d22(0x260));try{this[_0x1d0d22(0x22f)](_0x2ef6f4['id'],_0x2ef6f4[_0x1d0d22(0x241)]||'unknown','PENDING',_0x1d0d22(0x28f),_0x1d0d22(0x1e0),{'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x2ef6f4['createdAt'],'daysSinceCreation':Math[_0x1d0d22(0x289)]((Date[_0x1d0d22(0x1b8)]()-_0x2ef6f4[_0x1d0d22(0x1b2)][_0x1d0d22(0x204)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x2ef6f4[_0x1d0d22(0x20f)],'paymentCurrency':_0x2ef6f4['currency'],'shopId':_0x2ef6f4['shopId']}),await database_1['default'][_0x1d0d22(0x22e)][_0x1d0d22(0x23d)]({'where':{'id':_0x2ef6f4['id']},'data':{'status':_0x1d0d22(0x28f),'updatedAt':new Date()}}),await database_1[_0x1d0d22(0x1a1)]['webhookLog'][_0x1d0d22(0x276)]({'data':{'paymentId':_0x2ef6f4['id'],'shopId':_0x2ef6f4[_0x1d0d22(0x1c3)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x1d0d22(0x285)]({'reason':_0x1d0d22(0x23c)+this[_0x1d0d22(0x29a)]+_0x1d0d22(0x1cc),'createdAt':_0x2ef6f4[_0x1d0d22(0x1b2)],'expiredAt':new Date()[_0x1d0d22(0x282)](),'daysSinceCreation':Math['floor']((Date[_0x1d0d22(0x1b8)]()-_0x2ef6f4[_0x1d0d22(0x1b2)][_0x1d0d22(0x204)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x2ef6f4,_0x1d0d22(0x28f)),await this[_0x1d0d22(0x1e4)](_0x2ef6f4,'EXPIRED'),this['clearPaymentTimers'](_0x2ef6f4['id']),_0x4c3842['push'](_0x2ef6f4['id']),console['log']('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x2ef6f4['id']+_0x1d0d22(0x251)+this[_0x1d0d22(0x29a)]+_0x1d0d22(0x1c5));}catch(_0x3ca255){console[_0x1d0d22(0x1fe)]('‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x2ef6f4['id']+':',_0x3ca255),this[_0x1d0d22(0x20d)](_0x2ef6f4['id'],_0x2ef6f4[_0x1d0d22(0x241)]||_0x1d0d22(0x23f),_0x3ca255,_0x1d0d22(0x1e0),{'reason':_0x1d0d22(0x27d),'createdAt':_0x2ef6f4[_0x1d0d22(0x1b2)],'daysSinceCreation':Math[_0x1d0d22(0x289)]((Date[_0x1d0d22(0x1b8)]()-_0x2ef6f4['createdAt'][_0x1d0d22(0x204)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x4c3842;}async[a52_0x37e68f(0x274)](_0x1c80c5){const _0x4cb3fd=a52_0x37e68f;if(!_0x1c80c5['gatewayPaymentId']){console[_0x4cb3fd(0x287)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x1c80c5['id']+_0x4cb3fd(0x1ec));return;}console[_0x4cb3fd(0x287)](_0x4cb3fd(0x1ee)+_0x1c80c5[_0x4cb3fd(0x1ea)]+_0x4cb3fd(0x1d5)+_0x1c80c5['id']+'\x20('+_0x1c80c5[_0x4cb3fd(0x241)]+')');try{let _0x173285;_0x1c80c5[_0x4cb3fd(0x1ea)]===_0x4cb3fd(0x254)?(_0x173285=await this[_0x4cb3fd(0x1fa)][_0x4cb3fd(0x242)](_0x1c80c5[_0x4cb3fd(0x241)]),console['log'](_0x4cb3fd(0x272)+_0x1c80c5['id']+_0x4cb3fd(0x1b7)+_0x173285[_0x4cb3fd(0x245)])):(_0x173285=await this['coinToPayService'][_0x4cb3fd(0x242)](_0x1c80c5[_0x4cb3fd(0x241)]),console[_0x4cb3fd(0x287)](_0x4cb3fd(0x261)+_0x1c80c5['id']+_0x4cb3fd(0x1b7)+_0x173285['status']));_0x173285[_0x4cb3fd(0x1bd)]&&console[_0x4cb3fd(0x287)](_0x4cb3fd(0x25b)+_0x1c80c5['id']+_0x4cb3fd(0x23b),{'iban':_0x173285[_0x4cb3fd(0x1bd)][_0x4cb3fd(0x1e3)]||_0x4cb3fd(0x1e5),'transactionId':_0x173285['paymentDetails'][_0x4cb3fd(0x201)],'createdOn':_0x173285[_0x4cb3fd(0x1bd)][_0x4cb3fd(0x21c)],'confirmedOn':_0x173285[_0x4cb3fd(0x1bd)][_0x4cb3fd(0x25e)]||_0x4cb3fd(0x1a8)});if(_0x173285[_0x4cb3fd(0x245)]!==_0x1c80c5[_0x4cb3fd(0x245)]){console[_0x4cb3fd(0x287)](_0x4cb3fd(0x24a)+_0x1c80c5['id']+_0x4cb3fd(0x1d8)+_0x1c80c5[_0x4cb3fd(0x245)]+_0x4cb3fd(0x298)+_0x173285[_0x4cb3fd(0x245)]),this[_0x4cb3fd(0x22f)](_0x1c80c5['id'],_0x1c80c5[_0x4cb3fd(0x241)],_0x1c80c5['status'],_0x173285[_0x4cb3fd(0x245)],_0x4cb3fd(0x1be),{'paymentDetails':_0x173285[_0x4cb3fd(0x1bd)],'amount':_0x173285['amount'],'currency':_0x173285[_0x4cb3fd(0x280)],'shopId':_0x1c80c5[_0x4cb3fd(0x1c3)],'checkTimestamp':new Date()[_0x4cb3fd(0x282)]()});const _0x1a0988={'status':_0x173285[_0x4cb3fd(0x245)],'updatedAt':new Date()};if(_0x173285[_0x4cb3fd(0x245)]===_0x4cb3fd(0x291)&&_0x1c80c5[_0x4cb3fd(0x245)]!==_0x4cb3fd(0x291)){_0x1a0988['paidAt']=new Date();if(!_0x1c80c5['amountUSDT']){const _0x2e858b=await currencyService_1['currencyService']['convertToUSDT'](_0x1c80c5[_0x4cb3fd(0x20f)],_0x1c80c5[_0x4cb3fd(0x280)]);_0x1a0988[_0x4cb3fd(0x21b)]=_0x2e858b;const _0x2c1398=await this['getGatewayCommission'](_0x1c80c5[_0x4cb3fd(0x1c3)],_0x1c80c5[_0x4cb3fd(0x1ea)]),_0x294892=_0x2e858b*(0x1-_0x2c1398/0x64);_0x1a0988[_0x4cb3fd(0x25f)]=_0x294892,_0x1a0988[_0x4cb3fd(0x22c)]=_0x2c1398,console[_0x4cb3fd(0x287)](_0x4cb3fd(0x22b)+_0x1c80c5['id']+'\x20amounts\x20calculated:'),console[_0x4cb3fd(0x287)](_0x4cb3fd(0x1fc)+_0x1c80c5[_0x4cb3fd(0x20f)]+'\x20'+_0x1c80c5[_0x4cb3fd(0x280)]+'\x20->\x20'+_0x2e858b[_0x4cb3fd(0x1bc)](0x6)+_0x4cb3fd(0x1ed)),console['log']('\x20\x20\x20Gateway\x20'+_0x1c80c5[_0x4cb3fd(0x1ea)]+_0x4cb3fd(0x277)+_0x2c1398+'%'),console[_0x4cb3fd(0x287)]('\x20\x20\x20Amount\x20after\x20commission:\x20'+_0x294892[_0x4cb3fd(0x1bc)](0x6)+_0x4cb3fd(0x1ed));}console[_0x4cb3fd(0x287)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x1c80c5['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x1a0988[_0x4cb3fd(0x257)][_0x4cb3fd(0x282)]());}if(_0x173285[_0x4cb3fd(0x1bd)]){const _0x33869f=_0x173285[_0x4cb3fd(0x1bd)];_0x33869f[_0x4cb3fd(0x1e3)]&&(_0x1a0988[_0x4cb3fd(0x1f5)]=_0x33869f[_0x4cb3fd(0x1e3)],console['log'](_0x4cb3fd(0x221)+_0x33869f[_0x4cb3fd(0x1e3)])),_0x33869f[_0x4cb3fd(0x1b4)]&&console['log']('üè¶\x20[CHECK]\x20Bank\x20details\x20provided:\x20'+_0x33869f[_0x4cb3fd(0x1b4)]),_0x33869f[_0x4cb3fd(0x201)]&&console[_0x4cb3fd(0x287)]('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x33869f['transactionId']),_0x33869f[_0x4cb3fd(0x25e)]&&console[_0x4cb3fd(0x287)](_0x4cb3fd(0x26a)+_0x33869f[_0x4cb3fd(0x25e)]);}await database_1['default'][_0x4cb3fd(0x22e)]['update']({'where':{'id':_0x1c80c5['id']},'data':_0x1a0988});if(_0x173285['status']==='PAID'&&_0x1c80c5['status']!==_0x4cb3fd(0x291)){console[_0x4cb3fd(0x287)](_0x4cb3fd(0x1eb)+_0x1c80c5['id']+_0x4cb3fd(0x29c));const _0x2476d3=await database_1[_0x4cb3fd(0x1a1)][_0x4cb3fd(0x22e)]['findUnique']({'where':{'id':_0x1c80c5['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x2476d3?.[_0x4cb3fd(0x197)]&&_0x2476d3[_0x4cb3fd(0x24b)])try{const _0x2f2206=_0x2476d3['paymentLink'];console['log'](_0x4cb3fd(0x1a2)+_0x2f2206['id']+_0x4cb3fd(0x1dc)+_0x2f2206['type']+',\x20currentPayments='+_0x2f2206[_0x4cb3fd(0x21f)]+_0x4cb3fd(0x1c4)+_0x2f2206[_0x4cb3fd(0x245)]);const _0x528bcd=_0x2f2206[_0x4cb3fd(0x21f)]+0x1,_0x1b8cda=_0x2f2206[_0x4cb3fd(0x1d9)]===_0x4cb3fd(0x1bb)?_0x4cb3fd(0x1ad):_0x2f2206[_0x4cb3fd(0x245)];await database_1['default'][_0x4cb3fd(0x24b)][_0x4cb3fd(0x23d)]({'where':{'id':_0x2f2206['id']},'data':{'currentPayments':_0x528bcd,'status':_0x1b8cda,'updatedAt':new Date()}}),console[_0x4cb3fd(0x287)](_0x4cb3fd(0x255)+_0x2f2206['id']+_0x4cb3fd(0x270)+_0x2f2206[_0x4cb3fd(0x21f)]+_0x4cb3fd(0x208)+_0x528bcd+_0x4cb3fd(0x1c4)+_0x2f2206[_0x4cb3fd(0x245)]+_0x4cb3fd(0x208)+_0x1b8cda);}catch(_0xb37b01){console['error'](_0x4cb3fd(0x1a0),_0xb37b01);}else console['log'](_0x4cb3fd(0x1eb)+_0x1c80c5['id']+_0x4cb3fd(0x267));}await database_1[_0x4cb3fd(0x1a1)][_0x4cb3fd(0x1f1)][_0x4cb3fd(0x276)]({'data':{'paymentId':_0x1c80c5['id'],'shopId':_0x1c80c5[_0x4cb3fd(0x1c3)],'event':_0x4cb3fd(0x1af)+_0x173285[_0x4cb3fd(0x245)][_0x4cb3fd(0x1c8)](),'statusCode':0xc8,'responseBody':JSON[_0x4cb3fd(0x285)]({'oldStatus':_0x1c80c5['status'],'newStatus':_0x173285[_0x4cb3fd(0x245)],'paymentDetails':_0x173285[_0x4cb3fd(0x1bd)],'checkedAt':new Date()[_0x4cb3fd(0x282)]()})}}),await this[_0x4cb3fd(0x1ae)](_0x1c80c5,_0x173285['status']),await this[_0x4cb3fd(0x1e4)](_0x1c80c5,_0x173285[_0x4cb3fd(0x245)]),_0x173285[_0x4cb3fd(0x245)]!=='PENDING'&&(console[_0x4cb3fd(0x287)](_0x4cb3fd(0x26d)+_0x1c80c5['id']+'\x20status\x20changed\x20to\x20'+_0x173285[_0x4cb3fd(0x245)]+_0x4cb3fd(0x23a)),this[_0x4cb3fd(0x293)](_0x1c80c5['id'])),console[_0x4cb3fd(0x287)](_0x4cb3fd(0x1c9)+_0x1c80c5['id']+_0x4cb3fd(0x22d));}else console['log']('üìä\x20[CHECK]\x20Payment\x20'+_0x1c80c5['id']+_0x4cb3fd(0x27a)+_0x173285[_0x4cb3fd(0x245)]+')'),this[_0x4cb3fd(0x22f)](_0x1c80c5['id'],_0x1c80c5[_0x4cb3fd(0x241)],_0x1c80c5[_0x4cb3fd(0x245)],_0x173285['status'],_0x4cb3fd(0x1be),{'statusUnchanged':!![],'paymentDetails':_0x173285[_0x4cb3fd(0x1bd)],'amount':_0x173285['amount'],'currency':_0x173285['currency'],'shopId':_0x1c80c5[_0x4cb3fd(0x1c3)],'checkTimestamp':new Date()[_0x4cb3fd(0x282)]()});}catch(_0x48d0a6){console[_0x4cb3fd(0x1fe)](_0x4cb3fd(0x281)+_0x1c80c5['id']+':',_0x48d0a6),this[_0x4cb3fd(0x20d)](_0x1c80c5['id'],_0x1c80c5[_0x4cb3fd(0x241)],_0x48d0a6,_0x4cb3fd(0x1be),{'paymentAmount':_0x1c80c5[_0x4cb3fd(0x20f)],'paymentCurrency':_0x1c80c5[_0x4cb3fd(0x280)],'shopId':_0x1c80c5[_0x4cb3fd(0x1c3)],'createdAt':_0x1c80c5[_0x4cb3fd(0x1b2)]}),await database_1[_0x4cb3fd(0x1a1)][_0x4cb3fd(0x1f1)][_0x4cb3fd(0x276)]({'data':{'paymentId':_0x1c80c5['id'],'shopId':_0x1c80c5[_0x4cb3fd(0x1c3)],'event':_0x4cb3fd(0x211),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x48d0a6 instanceof Error?_0x48d0a6[_0x4cb3fd(0x239)]:_0x4cb3fd(0x294),'gatewayPaymentId':_0x1c80c5[_0x4cb3fd(0x241)],'checkedAt':new Date()[_0x4cb3fd(0x282)]()})}});}}async['sendShopWebhook'](_0x309599,_0x267c47){const _0x8254dd=a52_0x37e68f,_0x3486fc=Date[_0x8254dd(0x1b8)]();try{const _0x5482dd=_0x309599['shop'],_0x1d1a81=_0x5482dd[_0x8254dd(0x24c)];if(!_0x1d1a81?.[_0x8254dd(0x214)]){console[_0x8254dd(0x287)](_0x8254dd(0x196)+_0x5482dd['id']);return;}const _0x3b86c4=_0x267c47==='PAID'?'payment.success':_0x267c47===_0x8254dd(0x25c)?_0x8254dd(0x1d4):_0x267c47===_0x8254dd(0x28f)?_0x8254dd(0x1d4):_0x8254dd(0x1cd);if(!_0x1d1a81[_0x8254dd(0x200)]?.[_0x8254dd(0x1f7)](_0x3b86c4)){console[_0x8254dd(0x287)](_0x8254dd(0x1cb)+_0x3b86c4+_0x8254dd(0x1bf)+_0x5482dd['id']);return;}const _0xdb30ef=(0x0,gateway_1['getGatewayIdByName'])(_0x309599['gateway'])||_0x309599[_0x8254dd(0x1ea)],_0x1b9423={'event':_0x3b86c4,'payment':{'id':_0x309599['id'],'order_id':_0x309599[_0x8254dd(0x219)],'gateway_order_id':_0x309599['gatewayOrderId'],'gateway':_0xdb30ef,'amount':_0x309599[_0x8254dd(0x20f)],'currency':_0x309599[_0x8254dd(0x280)],'status':_0x267c47[_0x8254dd(0x1c8)](),'customer_email':_0x309599[_0x8254dd(0x1f3)],'customer_name':_0x309599['customerName'],'created_at':_0x309599[_0x8254dd(0x1b2)],'updated_at':new Date()}},_0x3d2cee=await fetch(_0x1d1a81[_0x8254dd(0x214)],{'method':_0x8254dd(0x1c6),'headers':{'Content-Type':'application/json','User-Agent':'Payment\x20System/1.0'},'body':JSON['stringify'](_0x1b9423)}),_0x94e3cb=Date[_0x8254dd(0x1b8)]()-_0x3486fc,_0x131eb8=_0x3d2cee['ok']?'Success':await _0x3d2cee[_0x8254dd(0x1e6)]();loggerService_1[_0x8254dd(0x1aa)]['logShopWebhookSent'](_0x309599[_0x8254dd(0x1c3)],_0x1d1a81[_0x8254dd(0x214)],_0x3b86c4,_0x3d2cee['status'],_0x94e3cb,_0x1b9423),console[_0x8254dd(0x287)]('Shop\x20webhook\x20sent\x20to\x20'+_0x1d1a81[_0x8254dd(0x214)]+_0x8254dd(0x1ac)+_0x3d2cee[_0x8254dd(0x245)]+'\x20('+_0x94e3cb+_0x8254dd(0x20e));}catch(_0x4ecae2){console[_0x8254dd(0x1fe)](_0x8254dd(0x247),_0x4ecae2),loggerService_1[_0x8254dd(0x1aa)][_0x8254dd(0x1ef)](_0x309599[_0x8254dd(0x1c3)],_0x309599[_0x8254dd(0x1f8)]?.[_0x8254dd(0x24c)]?.[_0x8254dd(0x214)]||_0x8254dd(0x23f),_0x8254dd(0x29b),_0x4ecae2,{});}}async[a52_0x37e68f(0x1e4)](_0x17dbbe,_0x876dc2){const _0x411e61=a52_0x37e68f;try{const _0x387caf={'PENDING':'created','PAID':_0x411e61(0x296),'FAILED':_0x411e61(0x19b),'EXPIRED':_0x411e61(0x26e)},_0x598d17=_0x387caf[_0x876dc2];if(!_0x598d17||_0x598d17==='created')return;await telegramBotService_1[_0x411e61(0x19a)][_0x411e61(0x25a)](_0x17dbbe[_0x411e61(0x1c3)],_0x17dbbe,_0x598d17);}catch(_0x3d015c){console['error'](_0x411e61(0x259),_0x3d015c);}}async['checkPaymentById'](_0x1a8d1e){const _0x49f1ba=a52_0x37e68f;console[_0x49f1ba(0x287)](_0x49f1ba(0x218)+_0x1a8d1e);const _0x2e5d28=await database_1[_0x49f1ba(0x1a1)]['payment'][_0x49f1ba(0x279)]({'where':{'id':_0x1a8d1e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2e5d28)throw new Error('Payment\x20not\x20found');if(_0x2e5d28[_0x49f1ba(0x1ea)]!==_0x49f1ba(0x295)&&_0x2e5d28['gateway']!==_0x49f1ba(0x254))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x49f1ba(0x287)](_0x49f1ba(0x1f0)+_0x2e5d28['gateway']+_0x49f1ba(0x1d5)+_0x1a8d1e),await this[_0x49f1ba(0x274)](_0x2e5d28),console[_0x49f1ba(0x287)]('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x1a8d1e);}[a52_0x37e68f(0x1a4)](){const _0x1e5fb7=a52_0x37e68f,_0x2e16cc=this[_0x1e5fb7(0x205)]?this[_0x1e5fb7(0x1f6)]:undefined,_0x799ba7=Array[_0x1e5fb7(0x193)](this[_0x1e5fb7(0x28d)][_0x1e5fb7(0x284)]())[_0x1e5fb7(0x226)](_0x386d28=>({'paymentId':_0x386d28[_0x1e5fb7(0x252)],'gatewayPaymentId':_0x386d28['gatewayPaymentId'],'createdAt':_0x386d28[_0x1e5fb7(0x1b2)],'timersCount':_0x386d28[_0x1e5fb7(0x228)][_0x1e5fb7(0x288)]}));return{'isActive':!!this[_0x1e5fb7(0x205)],'globalCheckIntervalMinutes':this[_0x1e5fb7(0x1f6)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x1e5fb7(0x28d)][_0x1e5fb7(0x21d)],'nextGlobalCheckIn':_0x2e16cc,'paymentTimersDetails':_0x799ba7};}[a52_0x37e68f(0x1f2)](_0x24d62c){const _0x262632=a52_0x37e68f,_0x55678a=this['paymentTimers'][_0x262632(0x290)](_0x24d62c);if(_0x55678a)return{'hasTimers':!![],'timersCount':_0x55678a[_0x262632(0x228)][_0x262632(0x288)],'createdAt':_0x55678a[_0x262632(0x1b2)],'gatewayPaymentId':_0x55678a[_0x262632(0x241)]};return{'hasTimers':![]};}async[a52_0x37e68f(0x223)](_0x4d3d3b,_0xd95de3){const _0x22644b=a52_0x37e68f;try{const _0x42ee7d=await database_1[_0x22644b(0x1a1)][_0x22644b(0x1f8)]['findUnique']({'where':{'id':_0x4d3d3b},'select':{'gatewaySettings':!![]}});if(!_0x42ee7d?.[_0x22644b(0x199)])return console[_0x22644b(0x287)](_0x22644b(0x249)+_0x4d3d3b+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x5af8ae=JSON[_0x22644b(0x19f)](_0x42ee7d[_0x22644b(0x199)]);for(const [_0x5a9cb0,_0x2c89b4]of Object[_0x22644b(0x1dd)](_0x5af8ae)){if(_0x5a9cb0[_0x22644b(0x1c8)]()===_0xd95de3[_0x22644b(0x1c8)]()){const _0x12ab35=_0x2c89b4[_0x22644b(0x27c)]||0xa;return console[_0x22644b(0x287)]('Gateway\x20'+_0xd95de3+_0x22644b(0x21e)+_0x4d3d3b+':\x20'+_0x12ab35+'%'),_0x12ab35;}}return console['log'](_0x22644b(0x1db)+_0xd95de3+_0x22644b(0x1a5)+_0x4d3d3b+',\x20using\x20default\x2010%'),0xa;}catch(_0x4fb61c){return console[_0x22644b(0x1fe)](_0x22644b(0x246)+_0x4d3d3b+',\x20gateway\x20'+_0xd95de3+':',_0x4fb61c),0xa;}}}exports[a52_0x37e68f(0x1d0)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();