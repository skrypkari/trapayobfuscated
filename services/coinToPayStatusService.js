'use strict';const a57_0x1c1227=a57_0x16a0;(function(_0x47506c,_0x1daca6){const _0x1d4ffa=a57_0x16a0,_0x46179f=_0x47506c();while(!![]){try{const _0x3e9503=parseInt(_0x1d4ffa(0x264))/0x1*(-parseInt(_0x1d4ffa(0x276))/0x2)+parseInt(_0x1d4ffa(0x25a))/0x3*(parseInt(_0x1d4ffa(0x1d5))/0x4)+parseInt(_0x1d4ffa(0x22a))/0x5+parseInt(_0x1d4ffa(0x199))/0x6+parseInt(_0x1d4ffa(0x1e1))/0x7*(-parseInt(_0x1d4ffa(0x202))/0x8)+parseInt(_0x1d4ffa(0x25f))/0x9+-parseInt(_0x1d4ffa(0x255))/0xa*(parseInt(_0x1d4ffa(0x18e))/0xb);if(_0x3e9503===_0x1daca6)break;else _0x46179f['push'](_0x46179f['shift']());}catch(_0x21f137){_0x46179f['push'](_0x46179f['shift']());}}}(a57_0x3d29,0xd9daa));function a57_0x16a0(_0x161646,_0x2adca5){_0x161646=_0x161646-0x186;const _0x3d29e3=a57_0x3d29();let _0x16a036=_0x3d29e3[_0x161646];return _0x16a036;}var __importDefault=this&&this[a57_0x1c1227(0x257)]||function(_0x476ba4){const _0x53af1a=a57_0x1c1227;return _0x476ba4&&_0x476ba4[_0x53af1a(0x22d)]?_0x476ba4:{'default':_0x476ba4};};Object['defineProperty'](exports,a57_0x1c1227(0x22d),{'value':!![]}),exports['coinToPayStatusService']=exports[a57_0x1c1227(0x1ec)]=void 0x0;function a57_0x3d29(){const _0x1eeab2=['Shop\x20webhook\x20sent\x20to\x20','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','üìä\x20[CHECK]\x20Payment\x20','convertToUSDT','currentPayments','push','\x20(after\x20','parse','/status/','shopId','CoinToPayStatusService',',\x20gateway\x20','\x20commission:\x20','sendShopWebhook','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','COINTOPAY_ERROR','\x20status\x20from\x20','get','text','COMPLETED',',\x20status=','size','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','PENDING','toFixed','paidAt','shop','webhookLog','\x20has\x20no\x20gatewayPaymentId','-day\x20timeout','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20\x20\x20üìÖ\x20Time:\x20','3288QpIwQs','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','hex','../config/database','\x20details:','.\x20Remaining\x20active\x20timers:\x20','üõë\x20[SHUTDOWN]\x20Cleared\x20','\x20payment\x20','createdOn','1\x20minute','checkSinglePayment','findMany','Success','now','\x20USDT','cointopay_auto_expired','findUnique','cointopay_status_check_','toISOString','Unknown\x20error','../types/gateway','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','length','Payment\x20older\x20than\x20','cointopay2',',\x20using\x20default\x2010%','update','checkExpiredPayments','ms)','\x20timers\x20for\x20payment\x20','paymentDetails','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20with\x20status\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','not\x20found','amountAfterGatewayCommissionUSDT','\x20has\x20no\x20gatewayPaymentId,\x20skipping','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:',':\x20type=','2194250lnwIfj','globalCheckInterval','settings','__esModule','getTime','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','\x20->\x20','\x20\x20\x20‚ùå\x20Error:\x20','\x20\x20\x20-\x20Gateway:\x20','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','\x20is\x20too\x20new\x20(','digest','\x20updated:\x20currentPayments=','\x20\x20\x20üìù\x20Details:','values','\x20\x20\x20-\x20ShopId:\x20','set','schedule_created','has','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20pending\x20CoinToPay\x20payments','status_check','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','üîç\x20[CHECK]\x20Checking\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','EXPIRY_DAYS','paid','commission','\x20individual\x20payment\x20timers','\x20commission\x20for\x20shop\x20','\x20\x20\x20-\x20Amount:\x20','\x20not\x20found\x20in\x20database','\x20status\x20is\x20','timers','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','paymentTimers','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','\x20\x20\x20Amount\x20after\x20commission:\x20','\x20current\x20status:\x20','crypto','70QoaJIf','‚è∞\x20[GLOBAL]\x20Found\x20','__importDefault','create','\x20checked,\x20','807TdVDFN','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','CoinToPay2Service','coinToPay2Service','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','6930234oawffE','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','message','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','EXPIRED','3jwNiex','logCoinToPayStatus','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','timestamp','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','delete','amountUSDT','type','sendPaymentStatusNotification','gatewayOrderId','GLOBAL_CHECK_INTERVAL_MS','\x20status\x20unchanged\x20(','POST','gatewayCommissionRate','Failed\x20to\x20mark\x20payment\x20as\x20expired','üßπ\x20[CHECK]\x20Payment\x20','secretKey','iban','869902BFWgiT','setDate','logCoinToPayError','createHmac','confirmedOn','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20status:\x20','paymentLinkId','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','amount','customerEmail','cointopay',',\x20stopping\x20individual\x20checks','logWhiteDomainError','catch','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','description','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','gateway','üè¶\x20[CHECK]\x20Bank\x20details\x20provided:\x20','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20is\x20older\x20than\x20','expired','\x20\x20\x20-\x20gatewayPaymentId:\x20','webhookUrl','loggerService','paymentLink','sendPaymentNotification','created','\x20days,\x20marking\x20as\x20EXPIRED','\x20marked\x20as\x20paid\x20at:\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','delay','PAID','22044gbdZMt','unknown','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','createdAt','failed','includes','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','5\x20minutes','schedulePaymentChecks','status','\x20seconds\x20(','3880992KQcUeW','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','‚è∞\x20[GLOBAL]\x20Payment\x20','üí∞\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','webhook_send','clearPaymentTimers','\x20found:','gatewaySettings','toLowerCase','webhookEvents','\x20\x20\x20üìç\x20Source:\x20','\x20to\x20clear','./gateways/coinToPay2Service','payment.pending','startPeriodicStatusCheck','coinToPayStatusService','\x20\x20\x20Gateway\x20','\x20for\x20payment\x20','checkAllPendingPayments','payment.failed','orderId','default','checkSinglePaymentById','\x20in\x20shop\x20','logShopWebhookError','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','\x20days','stack','Payment\x20System/1.0','\x20completed\x20for\x20payment\x20','currency','\x20days\x20(created\x20before\x20','coinToPayService',',\x20clearing\x20individual\x20timers','customerName','error','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','transactionId','forEach','\x20(age:\x20','application/json','checkPaymentStatus','‚ùå\x20[CHECK]\x20Payment\x20','gatewayPaymentId','floor','log','‚úÖ\x20[CHECK]\x20Payment\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','stringify',',\x20using\x20default\x20commission\x2010%','‚úÖ\x20[HOURLY]\x20Payment\x20','entries','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','checkPaymentById','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','ü™ô\x20[GLOBAL]\x20Found\x20','‚úÖ\x20[EXPIRY]\x20Payment\x20','\x20skipped,\x20','20724dSmMtD','bankDetails','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','payment','sha256','\x20triggered\x20for\x20payment\x20','getPaymentTimerInfo','\x20expired\x20CoinToPay\x20payments','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','\x20\x20\x20üìù\x20Context:','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','17682GSKkvG'];a57_0x3d29=function(){return _0x1eeab2;};return a57_0x3d29();}const crypto_1=__importDefault(require(a57_0x1c1227(0x254))),coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a57_0x1c1227(0x1a6)),gateway_1=require(a57_0x1c1227(0x216)),database_1=__importDefault(require(a57_0x1c1227(0x205))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService'),currencyService_1=require('./currencyService');class CoinToPayStatusService{constructor(){const _0x2bb800=a57_0x1c1227;this[_0x2bb800(0x22b)]=null,this[_0x2bb800(0x26e)]=0x3c*0x3c*0x3e8,this[_0x2bb800(0x245)]=0x5,this[_0x2bb800(0x24f)]=new Map(),this[_0x2bb800(0x1ba)]=new coinToPayService_1['CoinToPayService'](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x2bb800(0x25c))](),console[_0x2bb800(0x1c8)]('ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}[a57_0x1c1227(0x196)](_0x1e9ec4,_0x2b8db2){const _0x2c8228=a57_0x1c1227;console[_0x2c8228(0x1c8)](_0x2c8228(0x228)),console['log']('\x20\x20\x20-\x20paymentId:\x20'+_0x1e9ec4),console[_0x2c8228(0x1c8)](_0x2c8228(0x28e)+_0x2b8db2),this[_0x2c8228(0x19f)](_0x1e9ec4);const _0x3ba8d8=[],_0x1018e5=new Date(),_0x45027c=[{'delay':0x1*0x3c*0x3e8,'description':_0x2c8228(0x20b)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x2c8228(0x195)},{'delay':0x5*0x3c*0x3e8,'description':_0x2c8228(0x195)}];console[_0x2c8228(0x1c8)]('ü™ô\x20[DEBUG]\x20Creating\x20'+_0x45027c[_0x2c8228(0x219)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x1e9ec4);let _0x4c4f20=0x0;_0x45027c['forEach']((_0x22f391,_0x54eebd)=>{const _0x789964=_0x2c8228;_0x4c4f20+=_0x22f391['delay'];const _0x4664e4=setTimeout(async()=>{const _0x2ca39b=a57_0x16a0;console[_0x2ca39b(0x1c8)](_0x2ca39b(0x1bf)+(_0x54eebd+0x1)+_0x2ca39b(0x1da)+_0x1e9ec4+_0x2ca39b(0x1e8)+_0x22f391[_0x2ca39b(0x287)]+')');try{await this[_0x2ca39b(0x1b0)](_0x1e9ec4),console[_0x2ca39b(0x1c8)](_0x2ca39b(0x234)+(_0x54eebd+0x1)+_0x2ca39b(0x1b7)+_0x1e9ec4);}catch(_0x461fba){console[_0x2ca39b(0x1bd)](_0x2ca39b(0x190)+(_0x54eebd+0x1)+_0x2ca39b(0x1ab)+_0x1e9ec4+':',_0x461fba),this[_0x2ca39b(0x278)](_0x1e9ec4,_0x2b8db2,_0x461fba,'status_check',{'checkNumber':_0x54eebd+0x1,'scheduledAfter':_0x22f391['description'],'isIndividualCheck':!![]});}},_0x4c4f20);_0x3ba8d8[_0x789964(0x1e7)](_0x4664e4),console['log'](_0x789964(0x260)+(_0x54eebd+0x1)+_0x789964(0x1ab)+_0x1e9ec4+'\x20in\x20'+_0x4c4f20/0x3e8+_0x789964(0x198)+_0x22f391['description']+')');});const _0x306c7b=setInterval(async()=>{const _0xb9ccc8=_0x2c8228;console[_0xb9ccc8(0x1c8)](_0xb9ccc8(0x19a)+_0x1e9ec4);try{const _0x2289f0=await database_1[_0xb9ccc8(0x1af)][_0xb9ccc8(0x1d8)][_0xb9ccc8(0x212)]({'where':{'id':_0x1e9ec4},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x2289f0){console[_0xb9ccc8(0x1c8)]('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x1e9ec4+'\x20not\x20found,\x20clearing\x20timers'),this[_0xb9ccc8(0x19f)](_0x1e9ec4);return;}console[_0xb9ccc8(0x1c8)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x1e9ec4+_0xb9ccc8(0x253)+_0x2289f0[_0xb9ccc8(0x197)]);if(_0x2289f0[_0xb9ccc8(0x197)]!==_0xb9ccc8(0x1f9)){console[_0xb9ccc8(0x1c8)](_0xb9ccc8(0x1cd)+_0x1e9ec4+'\x20status\x20is\x20'+_0x2289f0[_0xb9ccc8(0x197)]+',\x20stopping\x20individual\x20checks'),this[_0xb9ccc8(0x19f)](_0x1e9ec4);return;}const _0x3e9494=Math[_0xb9ccc8(0x1c7)]((Date['now']()-_0x2289f0['createdAt'][_0xb9ccc8(0x22e)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x3e9494>=this[_0xb9ccc8(0x245)]){console[_0xb9ccc8(0x1c8)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x1e9ec4+_0xb9ccc8(0x28c)+this['EXPIRY_DAYS']+_0xb9ccc8(0x222)),this[_0xb9ccc8(0x19f)](_0x1e9ec4);return;}await this[_0xb9ccc8(0x1b0)](_0x1e9ec4),console[_0xb9ccc8(0x1c8)]('‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x1e9ec4);}catch(_0x46fdd5){console[_0xb9ccc8(0x1bd)](_0xb9ccc8(0x217)+_0x1e9ec4+':',_0x46fdd5),this[_0xb9ccc8(0x278)](_0x1e9ec4,_0x2b8db2,_0x46fdd5,_0xb9ccc8(0x240),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3ba8d8[_0x2c8228(0x1e7)](_0x306c7b),this['paymentTimers'][_0x2c8228(0x23b)](_0x1e9ec4,{'timers':_0x3ba8d8,'paymentId':_0x1e9ec4,'gatewayPaymentId':_0x2b8db2,'createdAt':_0x1018e5}),console[_0x2c8228(0x1c8)]('‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x45027c[_0x2c8228(0x219)]+_0x2c8228(0x218)+_0x1e9ec4),console['log']('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x2c8228(0x24f)][_0x2c8228(0x1f7)]),this[_0x2c8228(0x265)](_0x1e9ec4,_0x2b8db2,_0x2c8228(0x1f9),_0x2c8228(0x1f9),_0x2c8228(0x240),{'action':_0x2c8228(0x23c),'scheduledChecks':_0x45027c[_0x2c8228(0x219)],'firstCheckIn':_0x45027c[0x0][_0x2c8228(0x18c)]/0x3e8,'totalTimers':this['paymentTimers'][_0x2c8228(0x1f7)]});}['clearPaymentTimers'](_0x35d045){const _0x1d823f=a57_0x1c1227,_0x4be125=this[_0x1d823f(0x24f)]['get'](_0x35d045);_0x4be125?(console[_0x1d823f(0x1c8)]('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x4be125[_0x1d823f(0x24d)][_0x1d823f(0x219)]+_0x1d823f(0x220)+_0x35d045),_0x4be125['timers'][_0x1d823f(0x1c1)]((_0x31a6b0,_0x2fb20c)=>{const _0x166c25=_0x1d823f;_0x31a6b0&&(clearTimeout(_0x31a6b0),clearInterval(_0x31a6b0),console[_0x166c25(0x1c8)](_0x166c25(0x268)+(_0x2fb20c+0x1)+_0x166c25(0x1ab)+_0x35d045));}),this[_0x1d823f(0x24f)][_0x1d823f(0x269)](_0x35d045),console[_0x1d823f(0x1c8)]('‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x35d045+_0x1d823f(0x207)+this['paymentTimers'][_0x1d823f(0x1f7)])):console['log'](_0x1d823f(0x1be)+_0x35d045+_0x1d823f(0x1a5));}async[a57_0x1c1227(0x1b0)](_0x32b9cb){const _0x4d165a=a57_0x1c1227;console['log']('üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x32b9cb);const _0x6d29e2=await database_1[_0x4d165a(0x1af)][_0x4d165a(0x1d8)][_0x4d165a(0x212)]({'where':{'id':_0x32b9cb},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x6d29e2){console[_0x4d165a(0x1c8)](_0x4d165a(0x1c5)+_0x32b9cb+_0x4d165a(0x24b));return;}console[_0x4d165a(0x1c8)](_0x4d165a(0x1e4)+_0x32b9cb+_0x4d165a(0x1a0)),console[_0x4d165a(0x1c8)](_0x4d165a(0x233)+_0x6d29e2[_0x4d165a(0x289)]),console[_0x4d165a(0x1c8)]('\x20\x20\x20-\x20Status:\x20'+_0x6d29e2[_0x4d165a(0x197)]),console[_0x4d165a(0x1c8)](_0x4d165a(0x19d)+_0x6d29e2[_0x4d165a(0x1c6)]),console[_0x4d165a(0x1c8)](_0x4d165a(0x24a)+_0x6d29e2[_0x4d165a(0x280)]+'\x20'+_0x6d29e2[_0x4d165a(0x1b8)]),console[_0x4d165a(0x1c8)](_0x4d165a(0x23a)+_0x6d29e2[_0x4d165a(0x1eb)]);if(_0x6d29e2[_0x4d165a(0x289)]!==_0x4d165a(0x282)&&_0x6d29e2[_0x4d165a(0x289)]!==_0x4d165a(0x21b)){console[_0x4d165a(0x1c8)](_0x4d165a(0x203)+_0x32b9cb+_0x4d165a(0x230)+_0x6d29e2[_0x4d165a(0x289)]+')');return;}if(_0x6d29e2[_0x4d165a(0x197)]!==_0x4d165a(0x1f9)){console[_0x4d165a(0x1c8)](_0x4d165a(0x203)+_0x32b9cb+_0x4d165a(0x24c)+_0x6d29e2[_0x4d165a(0x197)]+_0x4d165a(0x283)),this[_0x4d165a(0x19f)](_0x32b9cb);return;}if(!_0x6d29e2[_0x4d165a(0x1c6)]){console[_0x4d165a(0x1c8)](_0x4d165a(0x203)+_0x32b9cb+_0x4d165a(0x1fe));return;}console['log'](_0x4d165a(0x1c9)+_0x32b9cb+_0x4d165a(0x200)),await this[_0x4d165a(0x20c)](_0x6d29e2);}[a57_0x1c1227(0x265)](_0x2621f6,_0x55f0b6,_0x4e90f3,_0x2c2fb0,_0x271f78,_0x4e7ede){const _0x512a09=a57_0x1c1227,_0x25fbf6={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x2621f6,'gatewayPaymentId':_0x55f0b6,'oldStatus':_0x4e90f3,'newStatus':_0x2c2fb0,'source':_0x271f78,'timestamp':new Date()[_0x512a09(0x214)](),'details':_0x4e7ede||{}};loggerService_1[_0x512a09(0x290)][_0x512a09(0x265)](_0x25fbf6),console[_0x512a09(0x1c8)]('ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x2621f6+'\x20('+_0x55f0b6+')'),console[_0x512a09(0x1c8)]('\x20\x20\x20üìä\x20Status:\x20'+_0x4e90f3+_0x512a09(0x231)+_0x2c2fb0),console[_0x512a09(0x1c8)]('\x20\x20\x20üìç\x20Source:\x20'+_0x271f78),console['log'](_0x512a09(0x201)+_0x25fbf6[_0x512a09(0x267)]),_0x4e7ede&&console['log'](_0x512a09(0x238),_0x4e7ede);}[a57_0x1c1227(0x278)](_0x37594c,_0xd2e227,_0x86b202,_0x1c77e4,_0x25587c){const _0x2853c1=a57_0x1c1227,_0x2cadb1={'type':_0x2853c1(0x1f1),'paymentId':_0x37594c,'gatewayPaymentId':_0xd2e227,'error':_0x86b202 instanceof Error?{'message':_0x86b202['message'],'stack':_0x86b202[_0x2853c1(0x1b5)]}:_0x86b202,'source':_0x1c77e4,'timestamp':new Date()['toISOString'](),'context':_0x25587c||{}};loggerService_1[_0x2853c1(0x290)][_0x2853c1(0x278)](_0x2cadb1),console[_0x2853c1(0x1bd)]('ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x37594c+'\x20('+_0xd2e227+')'),console[_0x2853c1(0x1bd)](_0x2853c1(0x232)+(_0x86b202 instanceof Error?_0x86b202[_0x2853c1(0x261)]:_0x86b202)),console[_0x2853c1(0x1bd)](_0x2853c1(0x1a4)+_0x1c77e4),console[_0x2853c1(0x1bd)](_0x2853c1(0x201)+_0x2cadb1['timestamp']),_0x25587c&&console[_0x2853c1(0x1bd)](_0x2853c1(0x1de),_0x25587c);}[a57_0x1c1227(0x1a8)](){const _0x59bfcd=a57_0x1c1227;console['log'](_0x59bfcd(0x1d7)),this[_0x59bfcd(0x1ac)]()[_0x59bfcd(0x285)](_0x42b8d6=>{const _0x2857ff=_0x59bfcd;console[_0x2857ff(0x1bd)]('‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x42b8d6);}),this[_0x59bfcd(0x22b)]=setInterval(async()=>{const _0x5c3187=_0x59bfcd;try{console[_0x5c3187(0x1c8)](_0x5c3187(0x25b)),await this['checkAllPendingPayments'](),console[_0x5c3187(0x1c8)](_0x5c3187(0x224));}catch(_0x31b8ff){console['error']('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x31b8ff);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x59bfcd(0x1c8)](_0x59bfcd(0x27e));}['stopPeriodicStatusCheck'](){const _0x5e2c30=a57_0x1c1227;console[_0x5e2c30(0x1c8)](_0x5e2c30(0x28b));this[_0x5e2c30(0x22b)]&&(clearInterval(this[_0x5e2c30(0x22b)]),this[_0x5e2c30(0x22b)]=null,console[_0x5e2c30(0x1c8)]('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x2702fc=this[_0x5e2c30(0x24f)][_0x5e2c30(0x1f7)];for(const [_0x345dce]of this[_0x5e2c30(0x24f)]){this[_0x5e2c30(0x19f)](_0x345dce);}console['log'](_0x5e2c30(0x208)+_0x2702fc+_0x5e2c30(0x248));}async['checkAllPendingPayments'](){const _0x18b668=a57_0x1c1227;try{console[_0x18b668(0x1c8)](_0x18b668(0x22f));const _0x531f61=await database_1[_0x18b668(0x1af)][_0x18b668(0x1d8)][_0x18b668(0x20d)]({'where':{'gateway':{'in':['cointopay','cointopay2']},'status':_0x18b668(0x1f9),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x18b668(0x1c8)](_0x18b668(0x1d2)+_0x531f61[_0x18b668(0x219)]+_0x18b668(0x23f));if(_0x531f61['length']===0x0){console['log'](_0x18b668(0x1e3));return;}const _0x4343c2=await this[_0x18b668(0x21e)](_0x531f61);console[_0x18b668(0x1c8)](_0x18b668(0x256)+_0x4343c2['length']+_0x18b668(0x1dc));let _0x1c4308=0x0,_0x3eccd8=0x0;for(const _0x5e6e5a of _0x531f61){try{if(_0x4343c2[_0x18b668(0x193)](_0x5e6e5a['id'])){console['log'](_0x18b668(0x19b)+_0x5e6e5a['id']+_0x18b668(0x241)),_0x3eccd8++;continue;}if(this[_0x18b668(0x24f)][_0x18b668(0x23d)](_0x5e6e5a['id'])){console[_0x18b668(0x1c8)](_0x18b668(0x19b)+_0x5e6e5a['id']+_0x18b668(0x266)),_0x3eccd8++;continue;}const _0x4d125a=(Date[_0x18b668(0x20f)]()-_0x5e6e5a[_0x18b668(0x191)][_0x18b668(0x22e)]())/(0x3e8*0x3c*0x3c);if(_0x4d125a<0x1){console[_0x18b668(0x1c8)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x5e6e5a['id']+_0x18b668(0x235)+_0x4d125a[_0x18b668(0x1fa)](0x1)+'h),\x20skipping\x20global\x20check'),_0x3eccd8++;continue;}console[_0x18b668(0x1c8)](_0x18b668(0x1b3)+_0x5e6e5a['id']+_0x18b668(0x1c2)+_0x4d125a[_0x18b668(0x1fa)](0x1)+'h)'),await this[_0x18b668(0x20c)](_0x5e6e5a),_0x1c4308++,await new Promise(_0x363f5b=>setTimeout(_0x363f5b,0x7d0));}catch(_0x1ae918){console['error']('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x5e6e5a['id']+':',_0x1ae918),this['logCoinToPayError'](_0x5e6e5a['id'],_0x5e6e5a['gatewayPaymentId']||_0x18b668(0x18f),_0x1ae918,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x5e6e5a[_0x18b668(0x280)],'paymentCurrency':_0x5e6e5a[_0x18b668(0x1b8)],'shopId':_0x5e6e5a[_0x18b668(0x1eb)],'createdAt':_0x5e6e5a[_0x18b668(0x191)]}),loggerService_1[_0x18b668(0x290)][_0x18b668(0x284)]('cointopay',_0x18b668(0x1ea)+_0x5e6e5a['gatewayPaymentId'],_0x1ae918);}}console[_0x18b668(0x1c8)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x1c4308+_0x18b668(0x259)+_0x3eccd8+_0x18b668(0x1d4)+_0x4343c2[_0x18b668(0x219)]+'\x20expired');}catch(_0x4e2957){console[_0x18b668(0x1bd)](_0x18b668(0x1df),_0x4e2957);}}async['checkExpiredPayments'](_0x2da947){const _0x3326c6=a57_0x1c1227,_0xadd8fa=[],_0x1bdf35=new Date();_0x1bdf35[_0x3326c6(0x277)](_0x1bdf35['getDate']()-this[_0x3326c6(0x245)]),console[_0x3326c6(0x1c8)](_0x3326c6(0x286)+this[_0x3326c6(0x245)]+_0x3326c6(0x1b9)+_0x1bdf35[_0x3326c6(0x214)]()+')');for(const _0xfb7280 of _0x2da947){if(_0xfb7280[_0x3326c6(0x191)]<_0x1bdf35){console[_0x3326c6(0x1c8)](_0x3326c6(0x18b)+_0xfb7280['id']+_0x3326c6(0x28c)+this[_0x3326c6(0x245)]+_0x3326c6(0x189));try{this['logCoinToPayStatus'](_0xfb7280['id'],_0xfb7280[_0x3326c6(0x1c6)]||_0x3326c6(0x18f),_0x3326c6(0x1f9),'EXPIRED','auto_expire',{'reason':'Payment\x20older\x20than\x20'+this[_0x3326c6(0x245)]+'\x20days','createdAt':_0xfb7280['createdAt'],'daysSinceCreation':Math['floor']((Date[_0x3326c6(0x20f)]()-_0xfb7280[_0x3326c6(0x191)][_0x3326c6(0x22e)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0xfb7280[_0x3326c6(0x280)],'paymentCurrency':_0xfb7280[_0x3326c6(0x1b8)],'shopId':_0xfb7280[_0x3326c6(0x1eb)]}),await database_1[_0x3326c6(0x1af)][_0x3326c6(0x1d8)]['update']({'where':{'id':_0xfb7280['id']},'data':{'status':_0x3326c6(0x263),'updatedAt':new Date()}}),await database_1[_0x3326c6(0x1af)][_0x3326c6(0x1fd)][_0x3326c6(0x258)]({'data':{'paymentId':_0xfb7280['id'],'shopId':_0xfb7280[_0x3326c6(0x1eb)],'event':_0x3326c6(0x211),'statusCode':0xc8,'responseBody':JSON[_0x3326c6(0x1cb)]({'reason':_0x3326c6(0x21a)+this[_0x3326c6(0x245)]+_0x3326c6(0x1b4),'createdAt':_0xfb7280[_0x3326c6(0x191)],'expiredAt':new Date()[_0x3326c6(0x214)](),'daysSinceCreation':Math['floor']((Date[_0x3326c6(0x20f)]()-_0xfb7280[_0x3326c6(0x191)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x3326c6(0x1ef)](_0xfb7280,_0x3326c6(0x263)),await this[_0x3326c6(0x26c)](_0xfb7280,_0x3326c6(0x263)),this[_0x3326c6(0x19f)](_0xfb7280['id']),_0xadd8fa[_0x3326c6(0x1e7)](_0xfb7280['id']),console[_0x3326c6(0x1c8)](_0x3326c6(0x1d3)+_0xfb7280['id']+_0x3326c6(0x27b)+this[_0x3326c6(0x245)]+_0x3326c6(0x1ff));}catch(_0x1b29ec){console[_0x3326c6(0x1bd)](_0x3326c6(0x27f)+_0xfb7280['id']+':',_0x1b29ec),this[_0x3326c6(0x278)](_0xfb7280['id'],_0xfb7280[_0x3326c6(0x1c6)]||_0x3326c6(0x18f),_0x1b29ec,'auto_expire',{'reason':_0x3326c6(0x272),'createdAt':_0xfb7280[_0x3326c6(0x191)],'daysSinceCreation':Math[_0x3326c6(0x1c7)]((Date[_0x3326c6(0x20f)]()-_0xfb7280[_0x3326c6(0x191)][_0x3326c6(0x22e)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0xadd8fa;}async['checkSinglePayment'](_0x1ba2e5){const _0x19bc69=a57_0x1c1227;if(!_0x1ba2e5[_0x19bc69(0x1c6)]){console['log'](_0x19bc69(0x203)+_0x1ba2e5['id']+_0x19bc69(0x227));return;}console[_0x19bc69(0x1c8)](_0x19bc69(0x243)+_0x1ba2e5[_0x19bc69(0x289)]+_0x19bc69(0x209)+_0x1ba2e5['id']+'\x20('+_0x1ba2e5[_0x19bc69(0x1c6)]+')');try{let _0x79c376;_0x1ba2e5[_0x19bc69(0x289)]===_0x19bc69(0x21b)?(_0x79c376=await this[_0x19bc69(0x25d)]['checkPaymentStatus'](_0x1ba2e5[_0x19bc69(0x1c6)]),console['log'](_0x19bc69(0x288)+_0x1ba2e5['id']+_0x19bc69(0x27c)+_0x79c376[_0x19bc69(0x197)])):(_0x79c376=await this[_0x19bc69(0x1ba)][_0x19bc69(0x1c4)](_0x1ba2e5[_0x19bc69(0x1c6)]),console[_0x19bc69(0x1c8)](_0x19bc69(0x1f8)+_0x1ba2e5['id']+'\x20status:\x20'+_0x79c376['status']));_0x79c376[_0x19bc69(0x221)]&&console[_0x19bc69(0x1c8)](_0x19bc69(0x1e4)+_0x1ba2e5['id']+_0x19bc69(0x206),{'iban':_0x79c376[_0x19bc69(0x221)][_0x19bc69(0x275)]||_0x19bc69(0x225),'transactionId':_0x79c376[_0x19bc69(0x221)][_0x19bc69(0x1c0)],'createdOn':_0x79c376['paymentDetails'][_0x19bc69(0x20a)],'confirmedOn':_0x79c376[_0x19bc69(0x221)][_0x19bc69(0x27a)]||'not\x20confirmed'});if(_0x79c376[_0x19bc69(0x197)]!==_0x1ba2e5[_0x19bc69(0x197)]){console[_0x19bc69(0x1c8)](_0x19bc69(0x262)+_0x1ba2e5['id']+_0x19bc69(0x1f2)+_0x1ba2e5[_0x19bc69(0x197)]+'\x20to\x20'+_0x79c376[_0x19bc69(0x197)]),this[_0x19bc69(0x265)](_0x1ba2e5['id'],_0x1ba2e5[_0x19bc69(0x1c6)],_0x1ba2e5[_0x19bc69(0x197)],_0x79c376[_0x19bc69(0x197)],'status_check',{'paymentDetails':_0x79c376['paymentDetails'],'amount':_0x79c376[_0x19bc69(0x280)],'currency':_0x79c376[_0x19bc69(0x1b8)],'shopId':_0x1ba2e5[_0x19bc69(0x1eb)],'checkTimestamp':new Date()['toISOString']()});const _0x23c104={'status':_0x79c376['status'],'updatedAt':new Date()};if(_0x79c376['status']===_0x19bc69(0x18d)&&_0x1ba2e5[_0x19bc69(0x197)]!==_0x19bc69(0x18d)){_0x23c104[_0x19bc69(0x1fb)]=new Date();if(!_0x1ba2e5['amountUSDT']){const _0x4e27b9=await currencyService_1['currencyService'][_0x19bc69(0x1e5)](_0x1ba2e5['amount'],_0x1ba2e5['currency']);_0x23c104[_0x19bc69(0x26a)]=_0x4e27b9;const _0x22a7e9=await this['getGatewayCommission'](_0x1ba2e5[_0x19bc69(0x1eb)],_0x1ba2e5[_0x19bc69(0x289)]),_0x5acb5b=_0x4e27b9*(0x1-_0x22a7e9/0x64);_0x23c104[_0x19bc69(0x226)]=_0x5acb5b,_0x23c104[_0x19bc69(0x271)]=_0x22a7e9,console['log']('üí∞\x20[CHECK]\x20Payment\x20'+_0x1ba2e5['id']+'\x20amounts\x20calculated:'),console['log']('\x20\x20\x20Amount:\x20'+_0x1ba2e5[_0x19bc69(0x280)]+'\x20'+_0x1ba2e5[_0x19bc69(0x1b8)]+_0x19bc69(0x231)+_0x4e27b9[_0x19bc69(0x1fa)](0x6)+_0x19bc69(0x210)),console[_0x19bc69(0x1c8)](_0x19bc69(0x1aa)+_0x1ba2e5['gateway']+_0x19bc69(0x1ee)+_0x22a7e9+'%'),console[_0x19bc69(0x1c8)](_0x19bc69(0x252)+_0x5acb5b[_0x19bc69(0x1fa)](0x6)+'\x20USDT');}console[_0x19bc69(0x1c8)](_0x19bc69(0x19c)+_0x1ba2e5['id']+_0x19bc69(0x18a)+_0x23c104[_0x19bc69(0x1fb)][_0x19bc69(0x214)]());}if(_0x79c376[_0x19bc69(0x221)]){const _0x11e97e=_0x79c376[_0x19bc69(0x221)];_0x11e97e[_0x19bc69(0x275)]&&(_0x23c104['remitterIban']=_0x11e97e['iban'],console[_0x19bc69(0x1c8)](_0x19bc69(0x244)+_0x11e97e[_0x19bc69(0x275)])),_0x11e97e[_0x19bc69(0x1d6)]&&console[_0x19bc69(0x1c8)](_0x19bc69(0x28a)+_0x11e97e[_0x19bc69(0x1d6)]),_0x11e97e[_0x19bc69(0x1c0)]&&console[_0x19bc69(0x1c8)]('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x11e97e[_0x19bc69(0x1c0)]),_0x11e97e[_0x19bc69(0x27a)]&&console[_0x19bc69(0x1c8)](_0x19bc69(0x1e0)+_0x11e97e[_0x19bc69(0x27a)]);}await database_1[_0x19bc69(0x1af)][_0x19bc69(0x1d8)][_0x19bc69(0x21d)]({'where':{'id':_0x1ba2e5['id']},'data':_0x23c104});if(_0x79c376[_0x19bc69(0x197)]==='PAID'&&_0x1ba2e5[_0x19bc69(0x197)]!==_0x19bc69(0x18d)){console[_0x19bc69(0x1c8)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x1ba2e5['id']+_0x19bc69(0x1d1));const _0x4cbee6=await database_1[_0x19bc69(0x1af)][_0x19bc69(0x1d8)]['findUnique']({'where':{'id':_0x1ba2e5['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x4cbee6?.[_0x19bc69(0x27d)]&&_0x4cbee6[_0x19bc69(0x186)])try{const _0x343bba=_0x4cbee6[_0x19bc69(0x186)];console[_0x19bc69(0x1c8)]('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x343bba['id']+_0x19bc69(0x229)+_0x343bba[_0x19bc69(0x26b)]+',\x20currentPayments='+_0x343bba[_0x19bc69(0x1e6)]+_0x19bc69(0x1f6)+_0x343bba[_0x19bc69(0x197)]);const _0x3ea203=_0x343bba[_0x19bc69(0x1e6)]+0x1,_0x438a2a=_0x343bba[_0x19bc69(0x26b)]==='SINGLE'?_0x19bc69(0x1f5):_0x343bba[_0x19bc69(0x197)];await database_1[_0x19bc69(0x1af)][_0x19bc69(0x186)][_0x19bc69(0x21d)]({'where':{'id':_0x343bba['id']},'data':{'currentPayments':_0x3ea203,'status':_0x438a2a,'updatedAt':new Date()}}),console[_0x19bc69(0x1c8)](_0x19bc69(0x194)+_0x343bba['id']+_0x19bc69(0x237)+_0x343bba[_0x19bc69(0x1e6)]+_0x19bc69(0x231)+_0x3ea203+',\x20status='+_0x343bba[_0x19bc69(0x197)]+_0x19bc69(0x231)+_0x438a2a);}catch(_0x1163e5){console['error'](_0x19bc69(0x24e),_0x1163e5);}else console[_0x19bc69(0x1c8)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x1ba2e5['id']+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}await database_1['default']['webhookLog'][_0x19bc69(0x258)]({'data':{'paymentId':_0x1ba2e5['id'],'shopId':_0x1ba2e5[_0x19bc69(0x1eb)],'event':_0x19bc69(0x213)+_0x79c376['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1ba2e5[_0x19bc69(0x197)],'newStatus':_0x79c376[_0x19bc69(0x197)],'paymentDetails':_0x79c376['paymentDetails'],'checkedAt':new Date()[_0x19bc69(0x214)]()})}}),await this[_0x19bc69(0x1ef)](_0x1ba2e5,_0x79c376[_0x19bc69(0x197)]),await this[_0x19bc69(0x26c)](_0x1ba2e5,_0x79c376[_0x19bc69(0x197)]),_0x79c376['status']!==_0x19bc69(0x1f9)&&(console[_0x19bc69(0x1c8)](_0x19bc69(0x273)+_0x1ba2e5['id']+'\x20status\x20changed\x20to\x20'+_0x79c376[_0x19bc69(0x197)]+_0x19bc69(0x1bb)),this[_0x19bc69(0x19f)](_0x1ba2e5['id'])),console['log'](_0x19bc69(0x1c9)+_0x1ba2e5['id']+'\x20updated\x20successfully');}else console[_0x19bc69(0x1c8)](_0x19bc69(0x1e4)+_0x1ba2e5['id']+_0x19bc69(0x26f)+_0x79c376[_0x19bc69(0x197)]+')'),this[_0x19bc69(0x265)](_0x1ba2e5['id'],_0x1ba2e5[_0x19bc69(0x1c6)],_0x1ba2e5['status'],_0x79c376[_0x19bc69(0x197)],_0x19bc69(0x240),{'statusUnchanged':!![],'paymentDetails':_0x79c376[_0x19bc69(0x221)],'amount':_0x79c376[_0x19bc69(0x280)],'currency':_0x79c376[_0x19bc69(0x1b8)],'shopId':_0x1ba2e5[_0x19bc69(0x1eb)],'checkTimestamp':new Date()['toISOString']()});}catch(_0xfacc14){console[_0x19bc69(0x1bd)](_0x19bc69(0x1f0)+_0x1ba2e5['id']+':',_0xfacc14),this[_0x19bc69(0x278)](_0x1ba2e5['id'],_0x1ba2e5[_0x19bc69(0x1c6)],_0xfacc14,_0x19bc69(0x240),{'paymentAmount':_0x1ba2e5[_0x19bc69(0x280)],'paymentCurrency':_0x1ba2e5[_0x19bc69(0x1b8)],'shopId':_0x1ba2e5[_0x19bc69(0x1eb)],'createdAt':_0x1ba2e5[_0x19bc69(0x191)]}),await database_1[_0x19bc69(0x1af)][_0x19bc69(0x1fd)][_0x19bc69(0x258)]({'data':{'paymentId':_0x1ba2e5['id'],'shopId':_0x1ba2e5[_0x19bc69(0x1eb)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x19bc69(0x1cb)]({'error':_0xfacc14 instanceof Error?_0xfacc14[_0x19bc69(0x261)]:_0x19bc69(0x215),'gatewayPaymentId':_0x1ba2e5[_0x19bc69(0x1c6)],'checkedAt':new Date()[_0x19bc69(0x214)]()})}});}}async[a57_0x1c1227(0x1ef)](_0x5a09a7,_0x2a18be){const _0x40e370=a57_0x1c1227,_0x38be9d=Date[_0x40e370(0x20f)]();try{const _0x3e95af=_0x5a09a7[_0x40e370(0x1fc)],_0x41ff54=_0x3e95af[_0x40e370(0x22c)];if(!_0x41ff54?.[_0x40e370(0x28f)]){console['log'](_0x40e370(0x23e)+_0x3e95af['id']);return;}const _0xd8e988=_0x2a18be===_0x40e370(0x18d)?'payment.success':_0x2a18be==='FAILED'?'payment.failed':_0x2a18be===_0x40e370(0x263)?_0x40e370(0x1ad):_0x40e370(0x1a7);if(!_0x41ff54[_0x40e370(0x1a3)]?.[_0x40e370(0x193)](_0xd8e988)){console[_0x40e370(0x1c8)]('Webhook\x20event\x20'+_0xd8e988+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3e95af['id']);return;}const _0x1c4f08=(0x0,gateway_1['getGatewayIdByName'])(_0x5a09a7['gateway'])||_0x5a09a7[_0x40e370(0x289)],_0x6dfa2={'event':_0xd8e988,'payment':{'id':_0x5a09a7['id'],'order_id':_0x5a09a7[_0x40e370(0x1ae)],'gateway_order_id':_0x5a09a7[_0x40e370(0x26d)],'gateway':_0x1c4f08,'amount':_0x5a09a7['amount'],'currency':_0x5a09a7[_0x40e370(0x1b8)],'status':_0x2a18be[_0x40e370(0x1a2)](),'customer_email':_0x5a09a7[_0x40e370(0x281)],'customer_name':_0x5a09a7[_0x40e370(0x1bc)],'created_at':_0x5a09a7[_0x40e370(0x191)],'updated_at':new Date()}},_0xba7484=JSON[_0x40e370(0x1cb)](_0x6dfa2),_0x4f8707=crypto_1[_0x40e370(0x1af)][_0x40e370(0x279)](_0x40e370(0x1d9),_0x5a09a7['shop'][_0x40e370(0x274)])[_0x40e370(0x21d)](_0xba7484)[_0x40e370(0x236)](_0x40e370(0x204)),_0x3dab5c=await fetch(_0x41ff54[_0x40e370(0x28f)],{'method':_0x40e370(0x270),'headers':{'Content-Type':_0x40e370(0x1c3),'User-Agent':_0x40e370(0x1b6),'X-Webhook-Signature':_0x4f8707},'body':_0xba7484}),_0x2202c7=Date[_0x40e370(0x20f)]()-_0x38be9d,_0x545aee=_0x3dab5c['ok']?_0x40e370(0x20e):await _0x3dab5c[_0x40e370(0x1f4)]();loggerService_1[_0x40e370(0x290)]['logShopWebhookSent'](_0x5a09a7[_0x40e370(0x1eb)],_0x41ff54[_0x40e370(0x28f)],_0xd8e988,_0x3dab5c[_0x40e370(0x197)],_0x2202c7,_0x6dfa2),console['log'](_0x40e370(0x1e2)+_0x41ff54[_0x40e370(0x28f)]+_0x40e370(0x223)+_0x3dab5c[_0x40e370(0x197)]+'\x20('+_0x2202c7+_0x40e370(0x21f));}catch(_0x2354bb){console[_0x40e370(0x1bd)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x2354bb),loggerService_1[_0x40e370(0x290)][_0x40e370(0x1b2)](_0x5a09a7[_0x40e370(0x1eb)],_0x5a09a7[_0x40e370(0x1fc)]?.[_0x40e370(0x22c)]?.['webhookUrl']||_0x40e370(0x18f),_0x40e370(0x19e),_0x2354bb,{});}}async['sendPaymentStatusNotification'](_0xbfff46,_0xc711f6){const _0x1d496f=a57_0x1c1227;try{const _0x126a24={'PENDING':'created','PAID':_0x1d496f(0x246),'FAILED':_0x1d496f(0x192),'EXPIRED':_0x1d496f(0x28d)},_0x32be5f=_0x126a24[_0xc711f6];if(!_0x32be5f||_0x32be5f===_0x1d496f(0x188))return;await telegramBotService_1['telegramBotService'][_0x1d496f(0x187)](_0xbfff46['shopId'],_0xbfff46,_0x32be5f);}catch(_0x45ba79){console[_0x1d496f(0x1bd)](_0x1d496f(0x250),_0x45ba79);}}async[a57_0x1c1227(0x1d0)](_0x57bca4){const _0xdc0780=a57_0x1c1227;console['log']('üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x57bca4);const _0x1d1787=await database_1['default'][_0xdc0780(0x1d8)][_0xdc0780(0x212)]({'where':{'id':_0x57bca4},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1d1787)throw new Error('Payment\x20not\x20found');if(_0x1d1787[_0xdc0780(0x289)]!==_0xdc0780(0x282)&&_0x1d1787['gateway']!=='cointopay2')throw new Error(_0xdc0780(0x251));console[_0xdc0780(0x1c8)](_0xdc0780(0x242)+_0x1d1787[_0xdc0780(0x289)]+_0xdc0780(0x209)+_0x57bca4),await this[_0xdc0780(0x20c)](_0x1d1787),console['log'](_0xdc0780(0x1cf)+_0x57bca4);}['getServiceStats'](){const _0x405895=a57_0x1c1227,_0x64168c=this[_0x405895(0x22b)]?this[_0x405895(0x26e)]:undefined,_0x3f5555=Array['from'](this[_0x405895(0x24f)][_0x405895(0x239)]())['map'](_0x4c1a94=>({'paymentId':_0x4c1a94['paymentId'],'gatewayPaymentId':_0x4c1a94[_0x405895(0x1c6)],'createdAt':_0x4c1a94[_0x405895(0x191)],'timersCount':_0x4c1a94[_0x405895(0x24d)]['length']}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x405895(0x26e)]/(0x3e8*0x3c),'expiryDays':this[_0x405895(0x245)],'activeIndividualTimers':this[_0x405895(0x24f)][_0x405895(0x1f7)],'nextGlobalCheckIn':_0x64168c,'paymentTimersDetails':_0x3f5555};}[a57_0x1c1227(0x1db)](_0x2a1461){const _0x2d3714=a57_0x1c1227,_0x24b105=this[_0x2d3714(0x24f)][_0x2d3714(0x1f3)](_0x2a1461);if(_0x24b105)return{'hasTimers':!![],'timersCount':_0x24b105[_0x2d3714(0x24d)][_0x2d3714(0x219)],'createdAt':_0x24b105[_0x2d3714(0x191)],'gatewayPaymentId':_0x24b105[_0x2d3714(0x1c6)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0x5c2d15,_0x28b932){const _0x27bc6e=a57_0x1c1227;try{const _0x21b8bb=await database_1[_0x27bc6e(0x1af)]['shop']['findUnique']({'where':{'id':_0x5c2d15},'select':{'gatewaySettings':!![]}});if(!_0x21b8bb?.['gatewaySettings'])return console[_0x27bc6e(0x1c8)](_0x27bc6e(0x1dd)+_0x5c2d15+_0x27bc6e(0x1cc)),0xa;const _0x4d2c6f=JSON[_0x27bc6e(0x1e9)](_0x21b8bb[_0x27bc6e(0x1a1)]);for(const [_0x2c4281,_0x2f11fa]of Object[_0x27bc6e(0x1ce)](_0x4d2c6f)){if(_0x2c4281[_0x27bc6e(0x1a2)]()===_0x28b932[_0x27bc6e(0x1a2)]()){const _0x3833e1=_0x2f11fa[_0x27bc6e(0x247)]||0xa;return console[_0x27bc6e(0x1c8)]('Gateway\x20'+_0x28b932+_0x27bc6e(0x249)+_0x5c2d15+':\x20'+_0x3833e1+'%'),_0x3833e1;}}return console[_0x27bc6e(0x1c8)](_0x27bc6e(0x25e)+_0x28b932+_0x27bc6e(0x1b1)+_0x5c2d15+_0x27bc6e(0x21c)),0xa;}catch(_0x3a0e06){return console[_0x27bc6e(0x1bd)](_0x27bc6e(0x1ca)+_0x5c2d15+_0x27bc6e(0x1ed)+_0x28b932+':',_0x3a0e06),0xa;}}}exports[a57_0x1c1227(0x1ec)]=CoinToPayStatusService,exports[a57_0x1c1227(0x1a9)]=new CoinToPayStatusService();