'use strict';const a37_0x56c86c=a37_0x485c;function a37_0x485c(_0x3f2242,_0x53412c){const _0x56bbac=a37_0x56bb();return a37_0x485c=function(_0x485c7e,_0x570192){_0x485c7e=_0x485c7e-0xc6;let _0x19fbf0=_0x56bbac[_0x485c7e];return _0x19fbf0;},a37_0x485c(_0x3f2242,_0x53412c);}(function(_0x2d4ac9,_0x580499){const _0xa2a5f5=a37_0x485c,_0x52616e=_0x2d4ac9();while(!![]){try{const _0x4e8ed1=parseInt(_0xa2a5f5(0x10f))/0x1*(-parseInt(_0xa2a5f5(0x13f))/0x2)+parseInt(_0xa2a5f5(0x115))/0x3+parseInt(_0xa2a5f5(0xc7))/0x4+parseInt(_0xa2a5f5(0x136))/0x5+-parseInt(_0xa2a5f5(0x11d))/0x6+-parseInt(_0xa2a5f5(0x1a5))/0x7*(parseInt(_0xa2a5f5(0x196))/0x8)+-parseInt(_0xa2a5f5(0x11f))/0x9*(-parseInt(_0xa2a5f5(0x1a2))/0xa);if(_0x4e8ed1===_0x580499)break;else _0x52616e['push'](_0x52616e['shift']());}catch(_0x574284){_0x52616e['push'](_0x52616e['shift']());}}}(a37_0x56bb,0x89923));function a37_0x56bb(){const _0x4463f2=['\x20\x20\x20-\x20Amount:\x20','checkAllPendingPayments','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','0100','GLOBAL_CHECK_INTERVAL_MS','forEach','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','findMany','\x20\x20\x20📝\x20Context:','size','update','\x20with\x20status\x20','created','adminNotes','\x20is\x20older\x20than\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20has\x20no\x20gatewayPaymentId','create','🪙\x20[GLOBAL]\x20Found\x20','\x20status\x20unchanged\x20(','\x20pending\x20CoinToPay\x20payments','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','transactionId','checkSinglePayment','5\x20minutes','4264688TaCHxW','🔄\x20[CHECK]\x20Updating\x20payment\x20','PAID','\x20status:\x20','Shop\x20webhook\x20sent\x20to\x20','findUnique','\x20to\x20clear','✅\x20[HOURLY]\x20Payment\x20','\x20skipped,\x20','\x20found:','Failed\x20to\x20send\x20shop\x20webhook:','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','11350JrRgIe','Automatically\x20expired\x20after\x20','unknown','7NdwbGB','not\x20confirmed','stopPeriodicStatusCheck','map','createdOn','\x20is\x20valid\x20for\x20checking,\x20proceeding...','✅\x20[CHECK]\x20Payment\x20','toISOString','getDate','1619516MQOObb','webhookEvents','Bank\x20Details:\x20','paymentDetails','coinToPayStatusService','\x20->\x20','\x20expired','\x20expired\x20CoinToPay\x20payments','./telegramBotService','application/json','logCoinToPayStatus','failed','checkPaymentStatus','customerEmail','⏰\x20[GLOBAL]\x20Payment\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20\x20\x20-\x20Gateway:\x20','globalCheckInterval','\x20\x20\x20📅\x20Time:\x20','\x20updated\x20successfully','\x20days\x20(created\x20before\x20','🪙\x20[DEBUG]\x20Creating\x20','checkPaymentById','✅\x20[EXPIRY]\x20Payment\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','iban','bankDetails','1\x20minute','webhookLog','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','startPeriodicStatusCheck','COINTOPAY_ERROR','logShopWebhookSent','CoinToPayStatusService','get','\x20checked,\x20','⏰\x20[GLOBAL]\x20Found\x20','TesSoft\x20Payment\x20System/1.0','getServiceStats','now','❌\x20[CHECK]\x20Payment\x20','values','⏰\x20[HOURLY]\x20Payment\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','🧹\x20[DEBUG]\x20Clearing\x20','Success','\x20status\x20is\x20','floor','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20not\x20found\x20in\x20database','from','error','\x20marked\x20as\x20paid\x20at:\x20','Payment\x20older\x20than\x20','EXPIRY_DAYS','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','cointopay_status_check_','toLowerCase','\x20days,\x20marking\x20as\x20EXPIRED','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','defineProperty','checkSinglePaymentById','Unknown\x20error','📊\x20[HOURLY]\x20Payment\x20','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','status_check','auto_expire','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','270pzOUHd','gateway','./loggerService','⚠️\x20[CHECK]\x20Payment\x20','logShopWebhookError','set','1297635VMZbTw','customerName','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','currency','.\x20Remaining\x20active\x20timers:\x20','paidAt','\x20initial\x20timers\x20for\x20payment\x20','\x20for\x20payment\x20','5656482nUHNyF','settings','14895Czlusl','loggerService','cointopay','description','schedule_created','clearPaymentTimers','sendPaymentStatusNotification','\x20completed\x20for\x20payment\x20','checkExpiredPayments','\x20days','timers','Failed\x20to\x20mark\x20payment\x20as\x20expired','__esModule','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','orderId','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','gatewayPaymentId','Payment\x20not\x20found','includes','\x20(age:\x20','has','delay','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','1690675JfyFae','COINTOPAY_STATUS_CHANGE','\x20\x20\x20❌\x20Error:\x20','payment.success','log','EXPIRED','\x20\x20\x20-\x20paymentId:\x20','gatewayOrderId','telegramBotService','7516lKqJgV','\x20not\x20enabled\x20for\x20shop\x20','__importDefault','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','sendPaymentNotification','webhookUrl','createdAt','2\x20minutes','default','\x20details:','message','delete','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','push','📊\x20[CHECK]\x20Payment\x20','\x20\x20\x20📍\x20Source:\x20','\x20current\x20status:\x20','cointopay_auto_expired','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','toFixed','logCoinToPayError','\x20triggered\x20for\x20payment\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','length','timestamp','remitterIban','shop','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...',',\x20clearing\x20individual\x20timers','expired','stack','setDate','status','\x20to\x20','stringify','not\x20found','shopId','\x20(after\x20','./gateways/coinToPayService','\x20timers\x20for\x20payment\x20','\x20in\x20','paymentTimers','-day\x20timeout','confirmedOn','payment.failed','payment','\x20is\x20too\x20new\x20(','\x20\x20\x20-\x20Status:\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','💰\x20[CHECK]\x20Payment\x20','amount','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','PENDING','paid','Webhook\x20event\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20not\x20found,\x20clearing\x20timers','getTime','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'];a37_0x56bb=function(){return _0x4463f2;};return a37_0x56bb();}var __importDefault=this&&this[a37_0x56c86c(0x141)]||function(_0x51197d){const _0x4679da=a37_0x56c86c;return _0x51197d&&_0x51197d[_0x4679da(0x12b)]?_0x51197d:{'default':_0x51197d};};Object[a37_0x56c86c(0x107)](exports,a37_0x56c86c(0x12b),{'value':!![]}),exports[a37_0x56c86c(0xcb)]=exports[a37_0x56c86c(0xea)]=void 0x0;const coinToPayService_1=require(a37_0x56c86c(0x168)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x56c86c(0xcf)),loggerService_1=require(a37_0x56c86c(0x111));class CoinToPayStatusService{constructor(){const _0x3fbd8c=a37_0x56c86c;this['globalCheckInterval']=null,this[_0x3fbd8c(0x181)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x3fbd8c(0x16b)]=new Map(),this['coinToPayService']=new coinToPayService_1['CoinToPayService'](),console['log']('🪙\x20CoinToPayStatusService\x20initialized');}['schedulePaymentChecks'](_0x1ab3bb,_0x4871be){const _0x820c6a=a37_0x56c86c;console[_0x820c6a(0x13a)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x820c6a(0x13a)](_0x820c6a(0x13c)+_0x1ab3bb),console['log']('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x4871be),this[_0x820c6a(0x124)](_0x1ab3bb);const _0x3337b4=[],_0x16a801=new Date(),_0x157ba6=[{'delay':0x1*0x3c*0x3e8,'description':_0x820c6a(0xe3)},{'delay':0x2*0x3c*0x3e8,'description':_0x820c6a(0x146)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x820c6a(0x195)}];console[_0x820c6a(0x13a)](_0x820c6a(0xdd)+_0x157ba6['length']+_0x820c6a(0x11b)+_0x1ab3bb);let _0x34f18a=0x0;_0x157ba6[_0x820c6a(0x182)]((_0x246d1f,_0x423260)=>{const _0x1185a3=_0x820c6a;_0x34f18a+=_0x246d1f['delay'];const _0x46d360=setTimeout(async()=>{const _0x5ea97b=a37_0x485c;console[_0x5ea97b(0x13a)](_0x5ea97b(0xe0)+(_0x423260+0x1)+_0x5ea97b(0x154)+_0x1ab3bb+_0x5ea97b(0x167)+_0x246d1f[_0x5ea97b(0x122)]+')');try{await this['checkSinglePaymentById'](_0x1ab3bb),console['log']('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x423260+0x1)+_0x5ea97b(0x126)+_0x1ab3bb);}catch(_0x17d265){console[_0x5ea97b(0xfd)](_0x5ea97b(0x12e)+(_0x423260+0x1)+'\x20for\x20payment\x20'+_0x1ab3bb+':',_0x17d265),this[_0x5ea97b(0x153)](_0x1ab3bb,_0x4871be,_0x17d265,_0x5ea97b(0x10c),{'checkNumber':_0x423260+0x1,'scheduledAfter':_0x246d1f[_0x5ea97b(0x122)],'isIndividualCheck':!![]});}},_0x34f18a);_0x3337b4[_0x1185a3(0x14c)](_0x46d360),console[_0x1185a3(0x13a)](_0x1185a3(0xd7)+(_0x423260+0x1)+_0x1185a3(0x11c)+_0x1ab3bb+_0x1185a3(0x16a)+_0x34f18a/0x3e8+'\x20seconds\x20('+_0x246d1f[_0x1185a3(0x122)]+')');});const _0x8ef6a9=setInterval(async()=>{const _0x1549d3=_0x820c6a;console[_0x1549d3(0x13a)]('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x1ab3bb);try{const _0x511f76=await database_1[_0x1549d3(0x147)][_0x1549d3(0x16f)][_0x1549d3(0x19b)]({'where':{'id':_0x1ab3bb},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x511f76){console['log']('❌\x20[HOURLY]\x20Payment\x20'+_0x1ab3bb+_0x1549d3(0x17a)),this['clearPaymentTimers'](_0x1ab3bb);return;}console['log'](_0x1549d3(0x10a)+_0x1ab3bb+_0x1549d3(0x14f)+_0x511f76['status']);if(_0x511f76['status']!==_0x1549d3(0x176)){console[_0x1549d3(0x13a)](_0x1549d3(0x19d)+_0x1ab3bb+_0x1549d3(0xf8)+_0x511f76[_0x1549d3(0x162)]+',\x20stopping\x20individual\x20checks'),this[_0x1549d3(0x124)](_0x1ab3bb);return;}const _0x1d6e98=Math['floor']((Date[_0x1549d3(0xf0)]()-_0x511f76['createdAt'][_0x1549d3(0x17b)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1d6e98>=this[_0x1549d3(0x100)]){console[_0x1549d3(0x13a)](_0x1549d3(0xf3)+_0x1ab3bb+_0x1549d3(0x18b)+this[_0x1549d3(0x100)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x1549d3(0x124)](_0x1ab3bb);return;}await this[_0x1549d3(0x108)](_0x1ab3bb),console[_0x1549d3(0x13a)](_0x1549d3(0x18c)+_0x1ab3bb);}catch(_0x439e46){console[_0x1549d3(0xfd)](_0x1549d3(0x10b)+_0x1ab3bb+':',_0x439e46),this['logCoinToPayError'](_0x1ab3bb,_0x4871be,_0x439e46,_0x1549d3(0x10c),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3337b4[_0x820c6a(0x14c)](_0x8ef6a9),this[_0x820c6a(0x16b)][_0x820c6a(0x114)](_0x1ab3bb,{'timers':_0x3337b4,'paymentId':_0x1ab3bb,'gatewayPaymentId':_0x4871be,'createdAt':_0x16a801}),console[_0x820c6a(0x13a)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x157ba6[_0x820c6a(0x159)]+_0x820c6a(0x17f)+_0x1ab3bb),console[_0x820c6a(0x13a)](_0x820c6a(0x179)+this[_0x820c6a(0x16b)][_0x820c6a(0x186)]),this[_0x820c6a(0xd1)](_0x1ab3bb,_0x4871be,_0x820c6a(0x176),_0x820c6a(0x176),'status_check',{'action':_0x820c6a(0x123),'scheduledChecks':_0x157ba6[_0x820c6a(0x159)],'firstCheckIn':_0x157ba6[0x0][_0x820c6a(0x134)]/0x3e8,'totalTimers':this[_0x820c6a(0x16b)]['size']});}[a37_0x56c86c(0x124)](_0x4ede1e){const _0x4fe8d0=a37_0x56c86c,_0xc4331d=this[_0x4fe8d0(0x16b)][_0x4fe8d0(0xeb)](_0x4ede1e);_0xc4331d?(console[_0x4fe8d0(0x13a)](_0x4fe8d0(0xf6)+_0xc4331d[_0x4fe8d0(0x129)]['length']+_0x4fe8d0(0x169)+_0x4ede1e),_0xc4331d[_0x4fe8d0(0x129)][_0x4fe8d0(0x182)]((_0x7e7a15,_0x101ddc)=>{const _0x50d3df=_0x4fe8d0;_0x7e7a15&&(clearTimeout(_0x7e7a15),clearInterval(_0x7e7a15),console['log'](_0x50d3df(0x175)+(_0x101ddc+0x1)+_0x50d3df(0x11c)+_0x4ede1e));}),this[_0x4fe8d0(0x16b)][_0x4fe8d0(0x14a)](_0x4ede1e),console[_0x4fe8d0(0x13a)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x4ede1e+_0x4fe8d0(0x119)+this['paymentTimers'][_0x4fe8d0(0x186)])):console[_0x4fe8d0(0x13a)](_0x4fe8d0(0xd6)+_0x4ede1e+_0x4fe8d0(0x19c));}async[a37_0x56c86c(0x108)](_0x4f542f){const _0x50a741=a37_0x56c86c;console['log'](_0x50a741(0x157)+_0x4f542f);const _0x2562b2=await database_1[_0x50a741(0x147)][_0x50a741(0x16f)][_0x50a741(0x19b)]({'where':{'id':_0x4f542f},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2562b2){console[_0x50a741(0x13a)](_0x50a741(0xf1)+_0x4f542f+_0x50a741(0xfb));return;}console['log'](_0x50a741(0x14d)+_0x4f542f+_0x50a741(0x19f)),console[_0x50a741(0x13a)](_0x50a741(0xd8)+_0x2562b2['gateway']),console[_0x50a741(0x13a)](_0x50a741(0x171)+_0x2562b2[_0x50a741(0x162)]),console['log']('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x2562b2[_0x50a741(0x12f)]),console['log'](_0x50a741(0x17d)+_0x2562b2['amount']+'\x20'+_0x2562b2[_0x50a741(0x118)]),console['log']('\x20\x20\x20-\x20ShopId:\x20'+_0x2562b2[_0x50a741(0x166)]);if(_0x2562b2['gateway']!==_0x50a741(0x121)){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x4f542f+_0x50a741(0x142)+_0x2562b2[_0x50a741(0x110)]+')');return;}if(_0x2562b2[_0x50a741(0x162)]!==_0x50a741(0x176)){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x4f542f+_0x50a741(0xf8)+_0x2562b2[_0x50a741(0x162)]+',\x20stopping\x20individual\x20checks'),this[_0x50a741(0x124)](_0x4f542f);return;}if(!_0x2562b2[_0x50a741(0x12f)]){console[_0x50a741(0x13a)](_0x50a741(0x112)+_0x4f542f+_0x50a741(0x18d));return;}console[_0x50a741(0x13a)](_0x50a741(0x1ab)+_0x4f542f+_0x50a741(0x1aa)),await this[_0x50a741(0x194)](_0x2562b2);}['logCoinToPayStatus'](_0x58850d,_0x4b3599,_0x328dc4,_0x197caf,_0x3ffeb2,_0x4c3709){const _0x15b0c7=a37_0x56c86c,_0x5badff={'type':_0x15b0c7(0x137),'paymentId':_0x58850d,'gatewayPaymentId':_0x4b3599,'oldStatus':_0x328dc4,'newStatus':_0x197caf,'source':_0x3ffeb2,'timestamp':new Date()[_0x15b0c7(0x1ac)](),'details':_0x4c3709||{}};loggerService_1['loggerService'][_0x15b0c7(0xd1)](_0x5badff),console['log']('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x58850d+'\x20('+_0x4b3599+')'),console[_0x15b0c7(0x13a)]('\x20\x20\x20📊\x20Status:\x20'+_0x328dc4+_0x15b0c7(0xcc)+_0x197caf),console[_0x15b0c7(0x13a)](_0x15b0c7(0x14e)+_0x3ffeb2),console[_0x15b0c7(0x13a)](_0x15b0c7(0xda)+_0x5badff[_0x15b0c7(0x15a)]),_0x4c3709&&console[_0x15b0c7(0x13a)]('\x20\x20\x20📝\x20Details:',_0x4c3709);}['logCoinToPayError'](_0xc7d5f0,_0x59309b,_0x28499b,_0x5844df,_0xfa6520){const _0x4352c6=a37_0x56c86c,_0x289e7a={'type':_0x4352c6(0xe8),'paymentId':_0xc7d5f0,'gatewayPaymentId':_0x59309b,'error':_0x28499b instanceof Error?{'message':_0x28499b[_0x4352c6(0x149)],'stack':_0x28499b[_0x4352c6(0x160)]}:_0x28499b,'source':_0x5844df,'timestamp':new Date()[_0x4352c6(0x1ac)](),'context':_0xfa6520||{}};loggerService_1[_0x4352c6(0x120)][_0x4352c6(0x153)](_0x289e7a),console[_0x4352c6(0xfd)]('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0xc7d5f0+'\x20('+_0x59309b+')'),console[_0x4352c6(0xfd)](_0x4352c6(0x138)+(_0x28499b instanceof Error?_0x28499b['message']:_0x28499b)),console[_0x4352c6(0xfd)](_0x4352c6(0x14e)+_0x5844df),console[_0x4352c6(0xfd)](_0x4352c6(0xda)+_0x289e7a['timestamp']),_0xfa6520&&console[_0x4352c6(0xfd)](_0x4352c6(0x185),_0xfa6520);}[a37_0x56c86c(0xe7)](){const _0x5538fd=a37_0x56c86c;console[_0x5538fd(0x13a)](_0x5538fd(0x192)),this[_0x5538fd(0x17e)]()['catch'](_0x4430b9=>{const _0xf95d20=_0x5538fd;console[_0xf95d20(0xfd)]('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x4430b9);}),this[_0x5538fd(0xd9)]=setInterval(async()=>{const _0xd501c=_0x5538fd;try{console[_0xd501c(0x13a)](_0xd501c(0x12c)),await this['checkAllPendingPayments'](),console[_0xd501c(0x13a)](_0xd501c(0x151));}catch(_0x181d0f){console[_0xd501c(0xfd)](_0xd501c(0x156),_0x181d0f);}},this['GLOBAL_CHECK_INTERVAL_MS']),console['log'](_0x5538fd(0x117));}[a37_0x56c86c(0x1a7)](){const _0x729d81=a37_0x56c86c;console['log'](_0x729d81(0x15d));this['globalCheckInterval']&&(clearInterval(this[_0x729d81(0xd9)]),this[_0x729d81(0xd9)]=null,console[_0x729d81(0x13a)](_0x729d81(0xf5)));const _0x4bec0a=this[_0x729d81(0x16b)][_0x729d81(0x186)];for(const [_0x3df4d5]of this[_0x729d81(0x16b)]){this[_0x729d81(0x124)](_0x3df4d5);}console[_0x729d81(0x13a)]('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x4bec0a+'\x20individual\x20payment\x20timers');}async[a37_0x56c86c(0x17e)](){const _0x26cbff=a37_0x56c86c;try{console[_0x26cbff(0x13a)](_0x26cbff(0x101));const _0x5ed1c1=await database_1[_0x26cbff(0x147)][_0x26cbff(0x16f)][_0x26cbff(0x184)]({'where':{'gateway':'cointopay','status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x26cbff(0x13a)](_0x26cbff(0x18f)+_0x5ed1c1[_0x26cbff(0x159)]+_0x26cbff(0x191));if(_0x5ed1c1[_0x26cbff(0x159)]===0x0){console[_0x26cbff(0x13a)](_0x26cbff(0x183));return;}const _0x244657=await this[_0x26cbff(0x127)](_0x5ed1c1);console['log'](_0x26cbff(0xed)+_0x244657[_0x26cbff(0x159)]+_0x26cbff(0xce));let _0x437f5b=0x0,_0x24607f=0x0;for(const _0x3134b4 of _0x5ed1c1){try{if(_0x244657[_0x26cbff(0x131)](_0x3134b4['id'])){console[_0x26cbff(0x13a)](_0x26cbff(0xd5)+_0x3134b4['id']+_0x26cbff(0x158)),_0x24607f++;continue;}if(this[_0x26cbff(0x16b)][_0x26cbff(0x133)](_0x3134b4['id'])){console[_0x26cbff(0x13a)](_0x26cbff(0xd5)+_0x3134b4['id']+_0x26cbff(0x172)),_0x24607f++;continue;}const _0x57d405=(Date[_0x26cbff(0xf0)]()-_0x3134b4[_0x26cbff(0x145)][_0x26cbff(0x17b)]())/(0x3e8*0x3c*0x3c);if(_0x57d405<0x1){console['log'](_0x26cbff(0xd5)+_0x3134b4['id']+_0x26cbff(0x170)+_0x57d405[_0x26cbff(0x152)](0x1)+'h),\x20skipping\x20global\x20check'),_0x24607f++;continue;}console[_0x26cbff(0x13a)](_0x26cbff(0x135)+_0x3134b4['id']+_0x26cbff(0x132)+_0x57d405['toFixed'](0x1)+'h)'),await this[_0x26cbff(0x194)](_0x3134b4),_0x437f5b++,await new Promise(_0x30455c=>setTimeout(_0x30455c,0x7d0));}catch(_0x52aa7d){console[_0x26cbff(0xfd)]('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x3134b4['id']+':',_0x52aa7d),this['logCoinToPayError'](_0x3134b4['id'],_0x3134b4[_0x26cbff(0x12f)]||_0x26cbff(0x1a4),_0x52aa7d,_0x26cbff(0x10c),{'isGlobalCheck':!![],'paymentAmount':_0x3134b4['amount'],'paymentCurrency':_0x3134b4[_0x26cbff(0x118)],'shopId':_0x3134b4['shopId'],'createdAt':_0x3134b4[_0x26cbff(0x145)]}),loggerService_1['loggerService']['logWhiteDomainError'](_0x26cbff(0x121),'/status/'+_0x3134b4['gatewayPaymentId'],_0x52aa7d);}}console[_0x26cbff(0x13a)]('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x437f5b+_0x26cbff(0xec)+_0x24607f+_0x26cbff(0x19e)+_0x244657[_0x26cbff(0x159)]+_0x26cbff(0xcd));}catch(_0x50da46){console[_0x26cbff(0xfd)]('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x50da46);}}async[a37_0x56c86c(0x127)](_0x3af5c0){const _0x102865=a37_0x56c86c,_0x58efc1=[],_0x4ef36b=new Date();_0x4ef36b[_0x102865(0x161)](_0x4ef36b[_0x102865(0xc6)]()-this[_0x102865(0x100)]),console[_0x102865(0x13a)](_0x102865(0x106)+this[_0x102865(0x100)]+_0x102865(0xdc)+_0x4ef36b[_0x102865(0x1ac)]()+')');for(const _0x31deb6 of _0x3af5c0){if(_0x31deb6[_0x102865(0x145)]<_0x4ef36b){console[_0x102865(0x13a)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x31deb6['id']+_0x102865(0x18b)+this['EXPIRY_DAYS']+_0x102865(0x104));try{this['logCoinToPayStatus'](_0x31deb6['id'],_0x31deb6['gatewayPaymentId']||'unknown',_0x102865(0x176),'EXPIRED',_0x102865(0x10d),{'reason':'Payment\x20older\x20than\x20'+this[_0x102865(0x100)]+_0x102865(0x128),'createdAt':_0x31deb6[_0x102865(0x145)],'daysSinceCreation':Math[_0x102865(0xf9)]((Date['now']()-_0x31deb6[_0x102865(0x145)][_0x102865(0x17b)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x31deb6[_0x102865(0x174)],'paymentCurrency':_0x31deb6['currency'],'shopId':_0x31deb6[_0x102865(0x166)]}),await database_1[_0x102865(0x147)][_0x102865(0x16f)][_0x102865(0x187)]({'where':{'id':_0x31deb6['id']},'data':{'status':_0x102865(0x13b),'updatedAt':new Date(),'adminNotes':_0x102865(0x1a3)+this[_0x102865(0x100)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x102865(0x147)][_0x102865(0xe4)][_0x102865(0x18e)]({'data':{'paymentId':_0x31deb6['id'],'shopId':_0x31deb6[_0x102865(0x166)],'event':_0x102865(0x150),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x102865(0xff)+this[_0x102865(0x100)]+_0x102865(0x128),'createdAt':_0x31deb6[_0x102865(0x145)],'expiredAt':new Date()[_0x102865(0x1ac)](),'daysSinceCreation':Math[_0x102865(0xf9)]((Date[_0x102865(0xf0)]()-_0x31deb6[_0x102865(0x145)][_0x102865(0x17b)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x31deb6,_0x102865(0x13b)),await this[_0x102865(0x125)](_0x31deb6,_0x102865(0x13b)),this[_0x102865(0x124)](_0x31deb6['id']),_0x58efc1[_0x102865(0x14c)](_0x31deb6['id']),console[_0x102865(0x13a)](_0x102865(0xdf)+_0x31deb6['id']+_0x102865(0xe5)+this[_0x102865(0x100)]+_0x102865(0x16c));}catch(_0x304043){console[_0x102865(0xfd)](_0x102865(0x105)+_0x31deb6['id']+':',_0x304043),this[_0x102865(0x153)](_0x31deb6['id'],_0x31deb6[_0x102865(0x12f)]||_0x102865(0x1a4),_0x304043,'auto_expire',{'reason':_0x102865(0x12a),'createdAt':_0x31deb6[_0x102865(0x145)],'daysSinceCreation':Math[_0x102865(0xf9)]((Date[_0x102865(0xf0)]()-_0x31deb6[_0x102865(0x145)][_0x102865(0x17b)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x58efc1;}async['checkSinglePayment'](_0x5d20ad){const _0x164f00=a37_0x56c86c;if(!_0x5d20ad[_0x164f00(0x12f)]){console[_0x164f00(0x13a)](_0x164f00(0x112)+_0x5d20ad['id']+_0x164f00(0x155));return;}console[_0x164f00(0x13a)]('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x5d20ad['id']+'\x20('+_0x5d20ad[_0x164f00(0x12f)]+')');try{const _0x4bf5bb=await this['coinToPayService'][_0x164f00(0xd3)](_0x5d20ad[_0x164f00(0x12f)]);console[_0x164f00(0x13a)](_0x164f00(0x14d)+_0x5d20ad['id']+_0x164f00(0x199)+_0x4bf5bb[_0x164f00(0x162)]);_0x4bf5bb['paymentDetails']&&console[_0x164f00(0x13a)](_0x164f00(0x14d)+_0x5d20ad['id']+_0x164f00(0x148),{'iban':_0x4bf5bb[_0x164f00(0xca)]['iban']||_0x164f00(0x165),'transactionId':_0x4bf5bb[_0x164f00(0xca)][_0x164f00(0x193)],'createdOn':_0x4bf5bb[_0x164f00(0xca)][_0x164f00(0x1a9)],'confirmedOn':_0x4bf5bb[_0x164f00(0xca)][_0x164f00(0x16d)]||_0x164f00(0x1a6)});if(_0x4bf5bb[_0x164f00(0x162)]!==_0x5d20ad[_0x164f00(0x162)]){console[_0x164f00(0x13a)](_0x164f00(0x197)+_0x5d20ad['id']+'\x20status\x20from\x20'+_0x5d20ad['status']+_0x164f00(0x163)+_0x4bf5bb[_0x164f00(0x162)]),this[_0x164f00(0xd1)](_0x5d20ad['id'],_0x5d20ad[_0x164f00(0x12f)],_0x5d20ad[_0x164f00(0x162)],_0x4bf5bb[_0x164f00(0x162)],_0x164f00(0x10c),{'paymentDetails':_0x4bf5bb[_0x164f00(0xca)],'amount':_0x4bf5bb['amount'],'currency':_0x4bf5bb[_0x164f00(0x118)],'shopId':_0x5d20ad[_0x164f00(0x166)],'checkTimestamp':new Date()[_0x164f00(0x1ac)]()});const _0x140064={'status':_0x4bf5bb[_0x164f00(0x162)],'updatedAt':new Date()};_0x4bf5bb[_0x164f00(0x162)]==='PAID'&&_0x5d20ad[_0x164f00(0x162)]!==_0x164f00(0x198)&&(_0x140064[_0x164f00(0x11a)]=new Date(),console[_0x164f00(0x13a)](_0x164f00(0x173)+_0x5d20ad['id']+_0x164f00(0xfe)+_0x140064[_0x164f00(0x11a)]['toISOString']()));if(_0x4bf5bb[_0x164f00(0xca)]){const _0x3dd0a6=_0x4bf5bb[_0x164f00(0xca)];_0x3dd0a6[_0x164f00(0xe1)]&&(_0x140064[_0x164f00(0x15b)]=_0x3dd0a6[_0x164f00(0xe1)],console[_0x164f00(0x13a)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x3dd0a6['iban']));if(_0x3dd0a6[_0x164f00(0xe2)]){const _0x5088fd=_0x5d20ad['adminNotes']||'',_0x428a4d=_0x164f00(0xc9)+_0x3dd0a6[_0x164f00(0xe2)];_0x140064[_0x164f00(0x18a)]=_0x5088fd?_0x5088fd+'\x0a\x0a'+_0x428a4d:_0x428a4d,console['log']('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x3dd0a6[_0x164f00(0x193)]&&console[_0x164f00(0x13a)]('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x3dd0a6['transactionId']),_0x3dd0a6[_0x164f00(0x16d)]&&console[_0x164f00(0x13a)](_0x164f00(0x14b)+_0x3dd0a6[_0x164f00(0x16d)]);}await database_1[_0x164f00(0x147)]['payment'][_0x164f00(0x187)]({'where':{'id':_0x5d20ad['id']},'data':_0x140064}),await database_1[_0x164f00(0x147)][_0x164f00(0xe4)][_0x164f00(0x18e)]({'data':{'paymentId':_0x5d20ad['id'],'shopId':_0x5d20ad[_0x164f00(0x166)],'event':_0x164f00(0x102)+_0x4bf5bb[_0x164f00(0x162)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x5d20ad['status'],'newStatus':_0x4bf5bb[_0x164f00(0x162)],'paymentDetails':_0x4bf5bb[_0x164f00(0xca)],'checkedAt':new Date()[_0x164f00(0x1ac)]()})}}),await this['sendShopWebhook'](_0x5d20ad,_0x4bf5bb[_0x164f00(0x162)]),await this[_0x164f00(0x125)](_0x5d20ad,_0x4bf5bb['status']),_0x4bf5bb['status']!==_0x164f00(0x176)&&(console['log']('🧹\x20[CHECK]\x20Payment\x20'+_0x5d20ad['id']+'\x20status\x20changed\x20to\x20'+_0x4bf5bb[_0x164f00(0x162)]+_0x164f00(0x15e)),this[_0x164f00(0x124)](_0x5d20ad['id'])),console[_0x164f00(0x13a)](_0x164f00(0x1ab)+_0x5d20ad['id']+_0x164f00(0xdb));}else console['log'](_0x164f00(0x14d)+_0x5d20ad['id']+_0x164f00(0x190)+_0x4bf5bb[_0x164f00(0x162)]+')'),this[_0x164f00(0xd1)](_0x5d20ad['id'],_0x5d20ad['gatewayPaymentId'],_0x5d20ad[_0x164f00(0x162)],_0x4bf5bb['status'],_0x164f00(0x10c),{'statusUnchanged':!![],'paymentDetails':_0x4bf5bb[_0x164f00(0xca)],'amount':_0x4bf5bb['amount'],'currency':_0x4bf5bb[_0x164f00(0x118)],'shopId':_0x5d20ad['shopId'],'checkTimestamp':new Date()[_0x164f00(0x1ac)]()});}catch(_0x4a51fb){console[_0x164f00(0xfd)](_0x164f00(0xe6)+_0x5d20ad['id']+':',_0x4a51fb),this[_0x164f00(0x153)](_0x5d20ad['id'],_0x5d20ad[_0x164f00(0x12f)],_0x4a51fb,_0x164f00(0x10c),{'paymentAmount':_0x5d20ad[_0x164f00(0x174)],'paymentCurrency':_0x5d20ad[_0x164f00(0x118)],'shopId':_0x5d20ad[_0x164f00(0x166)],'createdAt':_0x5d20ad['createdAt']}),await database_1[_0x164f00(0x147)][_0x164f00(0xe4)][_0x164f00(0x18e)]({'data':{'paymentId':_0x5d20ad['id'],'shopId':_0x5d20ad[_0x164f00(0x166)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x164f00(0x164)]({'error':_0x4a51fb instanceof Error?_0x4a51fb[_0x164f00(0x149)]:_0x164f00(0x109),'gatewayPaymentId':_0x5d20ad[_0x164f00(0x12f)],'checkedAt':new Date()[_0x164f00(0x1ac)]()})}});}}async['sendShopWebhook'](_0x5929ee,_0x14563e){const _0x192d45=a37_0x56c86c,_0x4d309d=Date['now']();try{const _0x24e35a=_0x5929ee[_0x192d45(0x15c)],_0x213609=_0x24e35a[_0x192d45(0x11e)];if(!_0x213609?.[_0x192d45(0x144)]){console[_0x192d45(0x13a)](_0x192d45(0xfa)+_0x24e35a['id']);return;}const _0x1dde9d=_0x14563e===_0x192d45(0x198)?_0x192d45(0x139):_0x14563e==='FAILED'?'payment.failed':_0x14563e===_0x192d45(0x13b)?_0x192d45(0x16e):'payment.pending';if(!_0x213609[_0x192d45(0xc8)]?.[_0x192d45(0x131)](_0x1dde9d)){console[_0x192d45(0x13a)](_0x192d45(0x178)+_0x1dde9d+_0x192d45(0x140)+_0x24e35a['id']);return;}const _0x543853={'event':_0x1dde9d,'payment':{'id':_0x5929ee['id'],'order_id':_0x5929ee[_0x192d45(0x12d)],'gateway_order_id':_0x5929ee[_0x192d45(0x13d)],'gateway':_0x192d45(0x180),'amount':_0x5929ee[_0x192d45(0x174)],'currency':_0x5929ee[_0x192d45(0x118)],'status':_0x14563e[_0x192d45(0x103)](),'customer_email':_0x5929ee[_0x192d45(0xd4)],'customer_name':_0x5929ee[_0x192d45(0x116)],'created_at':_0x5929ee[_0x192d45(0x145)],'updated_at':new Date()}},_0x3bd168=await fetch(_0x213609[_0x192d45(0x144)],{'method':'POST','headers':{'Content-Type':_0x192d45(0xd0),'User-Agent':_0x192d45(0xee)},'body':JSON[_0x192d45(0x164)](_0x543853)}),_0x337f3d=Date[_0x192d45(0xf0)]()-_0x4d309d,_0x411d00=_0x3bd168['ok']?_0x192d45(0xf7):await _0x3bd168['text']();loggerService_1[_0x192d45(0x120)][_0x192d45(0xe9)](_0x5929ee[_0x192d45(0x166)],_0x213609[_0x192d45(0x144)],_0x1dde9d,_0x3bd168[_0x192d45(0x162)],_0x337f3d,_0x543853),console['log'](_0x192d45(0x19a)+_0x213609[_0x192d45(0x144)]+_0x192d45(0x188)+_0x3bd168[_0x192d45(0x162)]+'\x20('+_0x337f3d+'ms)');}catch(_0x4c128c){console[_0x192d45(0xfd)](_0x192d45(0x1a0),_0x4c128c),loggerService_1[_0x192d45(0x120)][_0x192d45(0x113)](_0x5929ee['shopId'],_0x5929ee[_0x192d45(0x15c)]?.[_0x192d45(0x11e)]?.[_0x192d45(0x144)]||_0x192d45(0x1a4),'webhook_send',_0x4c128c,{});}}async[a37_0x56c86c(0x125)](_0x39b9bd,_0x3f2f9f){const _0x59e0a8=a37_0x56c86c;try{const _0x33c98d={'PENDING':_0x59e0a8(0x189),'PAID':_0x59e0a8(0x177),'FAILED':_0x59e0a8(0xd2),'EXPIRED':_0x59e0a8(0x15f)},_0xeb02a8=_0x33c98d[_0x3f2f9f];if(!_0xeb02a8||_0xeb02a8==='created')return;await telegramBotService_1[_0x59e0a8(0x13e)][_0x59e0a8(0x143)](_0x39b9bd[_0x59e0a8(0x166)],_0x39b9bd,_0xeb02a8);}catch(_0x38213b){console[_0x59e0a8(0xfd)](_0x59e0a8(0x10e),_0x38213b);}}async[a37_0x56c86c(0xde)](_0xe2f53c){const _0x19c9fc=a37_0x56c86c;console[_0x19c9fc(0x13a)](_0x19c9fc(0x17c)+_0xe2f53c);const _0x5b7dea=await database_1[_0x19c9fc(0x147)][_0x19c9fc(0x16f)]['findUnique']({'where':{'id':_0xe2f53c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5b7dea)throw new Error(_0x19c9fc(0x130));if(_0x5b7dea[_0x19c9fc(0x110)]!==_0x19c9fc(0x121))throw new Error(_0x19c9fc(0xf4));console['log'](_0x19c9fc(0x1a1)+_0xe2f53c),await this[_0x19c9fc(0x194)](_0x5b7dea),console[_0x19c9fc(0x13a)]('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0xe2f53c);}[a37_0x56c86c(0xef)](){const _0x1366b9=a37_0x56c86c,_0x4587f3=this[_0x1366b9(0xd9)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x3fbe1f=Array[_0x1366b9(0xfc)](this[_0x1366b9(0x16b)][_0x1366b9(0xf2)]())[_0x1366b9(0x1a8)](_0x4c5712=>({'paymentId':_0x4c5712['paymentId'],'gatewayPaymentId':_0x4c5712[_0x1366b9(0x12f)],'createdAt':_0x4c5712[_0x1366b9(0x145)],'timersCount':_0x4c5712['timers']['length']}));return{'isActive':!!this[_0x1366b9(0xd9)],'globalCheckIntervalMinutes':this[_0x1366b9(0x181)]/(0x3e8*0x3c),'expiryDays':this[_0x1366b9(0x100)],'activeIndividualTimers':this[_0x1366b9(0x16b)][_0x1366b9(0x186)],'nextGlobalCheckIn':_0x4587f3,'paymentTimersDetails':_0x3fbe1f};}['getPaymentTimerInfo'](_0x3af47c){const _0x971955=a37_0x56c86c,_0x2fa73a=this[_0x971955(0x16b)]['get'](_0x3af47c);if(_0x2fa73a)return{'hasTimers':!![],'timersCount':_0x2fa73a[_0x971955(0x129)][_0x971955(0x159)],'createdAt':_0x2fa73a['createdAt'],'gatewayPaymentId':_0x2fa73a['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a37_0x56c86c(0xea)]=CoinToPayStatusService,exports[a37_0x56c86c(0xcb)]=new CoinToPayStatusService();