'use strict';const a37_0x57feb7=a37_0x84e5;(function(_0x402ef7,_0x1fc3ef){const _0x556eb9=a37_0x84e5,_0x23c4fd=_0x402ef7();while(!![]){try{const _0x24dec0=-parseInt(_0x556eb9(0x241))/0x1*(-parseInt(_0x556eb9(0x236))/0x2)+parseInt(_0x556eb9(0x27c))/0x3+-parseInt(_0x556eb9(0x1fc))/0x4*(-parseInt(_0x556eb9(0x2ae))/0x5)+-parseInt(_0x556eb9(0x202))/0x6+-parseInt(_0x556eb9(0x28f))/0x7+parseInt(_0x556eb9(0x288))/0x8+-parseInt(_0x556eb9(0x213))/0x9;if(_0x24dec0===_0x1fc3ef)break;else _0x23c4fd['push'](_0x23c4fd['shift']());}catch(_0x1010ff){_0x23c4fd['push'](_0x23c4fd['shift']());}}}(a37_0x5cab,0xab76c));function a37_0x84e5(_0x2df3bc,_0x290948){const _0x5cabc5=a37_0x5cab();return a37_0x84e5=function(_0x84e556,_0x32326b){_0x84e556=_0x84e556-0x1d3;let _0x23e64b=_0x5cabc5[_0x84e556];return _0x23e64b;},a37_0x84e5(_0x2df3bc,_0x290948);}var __importDefault=this&&this[a37_0x57feb7(0x292)]||function(_0x39dcad){return _0x39dcad&&_0x39dcad['__esModule']?_0x39dcad:{'default':_0x39dcad};};Object[a37_0x57feb7(0x277)](exports,a37_0x57feb7(0x1f5),{'value':!![]}),exports[a37_0x57feb7(0x1da)]=exports[a37_0x57feb7(0x221)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a37_0x57feb7(0x2aa))),telegramBotService_1=require(a37_0x57feb7(0x239)),loggerService_1=require(a37_0x57feb7(0x282));function a37_0x5cab(){const _0x177cc4=['ms)','Payment\x20older\x20than\x20','\x20not\x20found,\x20clearing\x20timers','setDate','auto_expire','defineProperty','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','webhookEvents','Unknown\x20error','\x20->\x20','1358457stDgMm','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','toFixed',',\x20clearing\x20individual\x20timers','🪙\x20[DEBUG]\x20Creating\x20','❌\x20[CHECK]\x20Payment\x20','./loggerService','forEach','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','loggerService','size','findMany','381144QrRnpT','\x20\x20\x20📊\x20Status:\x20','findUnique','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','GLOBAL_CHECK_INTERVAL_MS',',\x20stopping\x20individual\x20checks','🧹\x20[CHECK]\x20Payment\x20','1050476ehVwXi','\x20\x20\x20-\x20Gateway:\x20','amount','__importDefault','⏰\x20[GLOBAL]\x20Found\x20','shop','webhookUrl','\x20skipped,\x20','✅\x20[CHECK]\x20Payment\x20','error','status','✅\x20[HOURLY]\x20Payment\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','has','0100','sendShopWebhook','shopId','payment.failed','payment','delete','POST','⏰\x20[GLOBAL]\x20Payment\x20','PENDING','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20days\x20(created\x20before\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','../config/database','update','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20is\x20valid\x20for\x20checking,\x20proceeding...','5422790zvfFjD','timers','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','gatewayOrderId','customerEmail','\x20\x20\x20-\x20paymentId:\x20','\x20days,\x20marking\x20as\x20EXPIRED','\x20found:','\x20initial\x20timers\x20for\x20payment\x20','\x20triggered\x20for\x20payment\x20','📊\x20[CHECK]\x20Payment\x20','Bank\x20Details:\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20days','EXPIRED','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','from','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','remitterIban','settings','\x20individual\x20payment\x20timers','expired','coinToPayStatusService','paidAt','\x20in\x20','\x20completed\x20for\x20payment\x20','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','catch','not\x20found','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','schedule_created','createdAt','now','\x20has\x20no\x20gatewayPaymentId,\x20skipping','checkSinglePayment','\x20expired','\x20\x20\x20-\x20Amount:\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','iban','\x20\x20\x20-\x20GatewayPaymentId:\x20','status_check','\x20status:\x20','checkExpiredPayments','logCoinToPayError','toISOString','paid','cointopay_auto_expired','createdOn','__esModule','-day\x20timeout','logShopWebhookError','unknown','\x20with\x20status\x20','includes','orderId','4XaxwED','default','floor','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20to\x20clear','⚠️\x20[CHECK]\x20Payment\x20','5622378AtmYiZ','\x20status\x20changed\x20to\x20','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','🪙\x20CoinToPayStatusService\x20initialized','\x20seconds\x20(','\x20timers\x20for\x20payment\x20','paymentTimers','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','webhook_send','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20to\x20','cointopay','5\x20minutes','\x20is\x20older\x20than\x20','set','\x20\x20\x20📝\x20Details:','🔄\x20[CHECK]\x20Updating\x20payment\x20','5886387YkLLdL','checkAllPendingPayments','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','stack','CoinToPayService','⏰\x20[HOURLY]\x20Payment\x20','failed','cointopay_status_check_','💰\x20[CHECK]\x20Payment\x20','\x20status\x20is\x20','logShopWebhookSent','confirmedOn','🪙\x20[GLOBAL]\x20Found\x20','getTime','CoinToPayStatusService','COINTOPAY_STATUS_CHANGE','gatewayPaymentId','get','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','adminNotes','create','✅\x20[EXPIRY]\x20Payment\x20','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','🛑\x20[SHUTDOWN]\x20Cleared\x20','🧹\x20[DEBUG]\x20Clearing\x20','log','getServiceStats','COINTOPAY_ERROR','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','sendPaymentStatusNotification','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','globalCheckInterval','currency','4cnPArZ','checkSinglePaymentById','\x20\x20\x20-\x20Status:\x20','./telegramBotService','\x20days\x20without\x20payment\x20confirmation','checkPaymentById','push','Failed\x20to\x20send\x20shop\x20webhook:','\x20not\x20enabled\x20for\x20shop\x20','Shop\x20webhook\x20sent\x20to\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','429235LRqrHr','gateway','❌\x20[HOURLY]\x20Payment\x20','FAILED','\x20marked\x20as\x20paid\x20at:\x20','timestamp','webhookLog','\x20\x20\x20📅\x20Time:\x20','clearPaymentTimers','startPeriodicStatusCheck','\x20not\x20found\x20in\x20database','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','paymentDetails','Webhook\x20event\x20','not\x20confirmed','description','bankDetails','EXPIRY_DAYS','PAID','application/json','checkPaymentStatus','Automatically\x20expired\x20after\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','logWhiteDomainError','cointopay_status_check_error','customerName','length','logCoinToPayStatus','payment.pending','\x20pending\x20CoinToPay\x20payments','payment.success','\x20(age:\x20','telegramBotService','toLowerCase','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20expired\x20CoinToPay\x20payments','Payment\x20not\x20found','\x20for\x20payment\x20','\x20status\x20from\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20\x20\x20-\x20gatewayPaymentId:\x20','transactionId','stringify','\x20details:','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','created','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','coinToPayService'];a37_0x5cab=function(){return _0x177cc4;};return a37_0x5cab();}class CoinToPayStatusService{constructor(){const _0x1d3fa9=a37_0x57feb7;this[_0x1d3fa9(0x234)]=null,this[_0x1d3fa9(0x28c)]=0x3c*0x3c*0x3e8,this[_0x1d3fa9(0x252)]=0x5,this[_0x1d3fa9(0x208)]=new Map(),this[_0x1d3fa9(0x271)]=new coinToPayService_1[(_0x1d3fa9(0x217))](),console[_0x1d3fa9(0x22e)](_0x1d3fa9(0x205));}['schedulePaymentChecks'](_0x5b47aa,_0x4379ba){const _0x145476=a37_0x57feb7;console['log'](_0x145476(0x204)),console['log'](_0x145476(0x2b3)+_0x5b47aa),console[_0x145476(0x22e)](_0x145476(0x269)+_0x4379ba),this[_0x145476(0x249)](_0x5b47aa);const _0x244218=[],_0x54432c=new Date(),_0x5472bd=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x145476(0x20e)},{'delay':0x5*0x3c*0x3e8,'description':_0x145476(0x20e)}];console['log'](_0x145476(0x280)+_0x5472bd[_0x145476(0x25b)]+_0x145476(0x2b6)+_0x5b47aa);let _0x5c0457=0x0;_0x5472bd['forEach']((_0x18dd10,_0x387503)=>{const _0xf95998=_0x145476;_0x5c0457+=_0x18dd10['delay'];const _0x40b859=setTimeout(async()=>{const _0x9a6dd3=a37_0x84e5;console[_0x9a6dd3(0x22e)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x387503+0x1)+_0x9a6dd3(0x2b7)+_0x5b47aa+'\x20(after\x20'+_0x18dd10['description']+')');try{await this['checkSinglePaymentById'](_0x5b47aa),console[_0x9a6dd3(0x22e)]('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x387503+0x1)+_0x9a6dd3(0x1dd)+_0x5b47aa);}catch(_0x35b44f){console[_0x9a6dd3(0x298)](_0x9a6dd3(0x278)+(_0x387503+0x1)+_0x9a6dd3(0x266)+_0x5b47aa+':',_0x35b44f),this['logCoinToPayError'](_0x5b47aa,_0x4379ba,_0x35b44f,'status_check',{'checkNumber':_0x387503+0x1,'scheduledAfter':_0x18dd10[_0x9a6dd3(0x250)],'isIndividualCheck':!![]});}},_0x5c0457);_0x244218[_0xf95998(0x23c)](_0x40b859),console[_0xf95998(0x22e)](_0xf95998(0x2ac)+(_0x387503+0x1)+_0xf95998(0x266)+_0x5b47aa+_0xf95998(0x1dc)+_0x5c0457/0x3e8+_0xf95998(0x206)+_0x18dd10[_0xf95998(0x250)]+')');});const _0x4d928d=setInterval(async()=>{const _0xa78124=_0x145476;console['log'](_0xa78124(0x215)+_0x5b47aa);try{const _0x3eaaba=await database_1[_0xa78124(0x1fd)][_0xa78124(0x2a1)][_0xa78124(0x28a)]({'where':{'id':_0x5b47aa},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x3eaaba){console[_0xa78124(0x22e)](_0xa78124(0x243)+_0x5b47aa+_0xa78124(0x274)),this[_0xa78124(0x249)](_0x5b47aa);return;}console[_0xa78124(0x22e)]('📊\x20[HOURLY]\x20Payment\x20'+_0x5b47aa+'\x20current\x20status:\x20'+_0x3eaaba['status']);if(_0x3eaaba[_0xa78124(0x299)]!==_0xa78124(0x2a5)){console[_0xa78124(0x22e)](_0xa78124(0x29a)+_0x5b47aa+'\x20status\x20is\x20'+_0x3eaaba['status']+_0xa78124(0x28d)),this[_0xa78124(0x249)](_0x5b47aa);return;}const _0x4dd2ee=Math['floor']((Date['now']()-_0x3eaaba['createdAt'][_0xa78124(0x220)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x4dd2ee>=this[_0xa78124(0x252)]){console[_0xa78124(0x22e)](_0xa78124(0x218)+_0x5b47aa+_0xa78124(0x20f)+this[_0xa78124(0x252)]+_0xa78124(0x231)),this[_0xa78124(0x249)](_0x5b47aa);return;}await this[_0xa78124(0x237)](_0x5b47aa),console['log'](_0xa78124(0x270)+_0x5b47aa);}catch(_0x18f046){console[_0xa78124(0x298)](_0xa78124(0x225)+_0x5b47aa+':',_0x18f046),this[_0xa78124(0x1f0)](_0x5b47aa,_0x4379ba,_0x18f046,_0xa78124(0x1ed),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x244218[_0x145476(0x23c)](_0x4d928d),this[_0x145476(0x208)][_0x145476(0x210)](_0x5b47aa,{'timers':_0x244218,'paymentId':_0x5b47aa,'gatewayPaymentId':_0x4379ba,'createdAt':_0x54432c}),console[_0x145476(0x22e)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x5472bd[_0x145476(0x25b)]+_0x145476(0x284)+_0x5b47aa),console[_0x145476(0x22e)](_0x145476(0x28b)+this[_0x145476(0x208)][_0x145476(0x286)]),this[_0x145476(0x25c)](_0x5b47aa,_0x4379ba,_0x145476(0x2a5),_0x145476(0x2a5),_0x145476(0x1ed),{'action':_0x145476(0x1e3),'scheduledChecks':_0x5472bd[_0x145476(0x25b)],'firstCheckIn':_0x5472bd[0x0]['delay']/0x3e8,'totalTimers':this['paymentTimers'][_0x145476(0x286)]});}['clearPaymentTimers'](_0x1c00d4){const _0xca7835=a37_0x57feb7,_0x4628e4=this[_0xca7835(0x208)]['get'](_0x1c00d4);_0x4628e4?(console[_0xca7835(0x22e)](_0xca7835(0x22d)+_0x4628e4[_0xca7835(0x2af)]['length']+_0xca7835(0x207)+_0x1c00d4),_0x4628e4[_0xca7835(0x2af)][_0xca7835(0x283)]((_0x3e419a,_0x26ded1)=>{const _0x134c83=_0xca7835;_0x3e419a&&(clearTimeout(_0x3e419a),clearInterval(_0x3e419a),console[_0x134c83(0x22e)](_0x134c83(0x257)+(_0x26ded1+0x1)+_0x134c83(0x266)+_0x1c00d4));}),this[_0xca7835(0x208)][_0xca7835(0x2a2)](_0x1c00d4),console[_0xca7835(0x22e)](_0xca7835(0x27d)+_0x1c00d4+'.\x20Remaining\x20active\x20timers:\x20'+this['paymentTimers'][_0xca7835(0x286)])):console[_0xca7835(0x22e)](_0xca7835(0x233)+_0x1c00d4+_0xca7835(0x200));}async[a37_0x57feb7(0x237)](_0x274399){const _0x396af2=a37_0x57feb7;console[_0x396af2(0x22e)](_0x396af2(0x26e)+_0x274399);const _0x3e3c73=await database_1[_0x396af2(0x1fd)]['payment'][_0x396af2(0x28a)]({'where':{'id':_0x274399},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3e3c73){console['log'](_0x396af2(0x281)+_0x274399+_0x396af2(0x24b));return;}console[_0x396af2(0x22e)](_0x396af2(0x2b8)+_0x274399+_0x396af2(0x2b5)),console['log'](_0x396af2(0x290)+_0x3e3c73[_0x396af2(0x242)]),console['log'](_0x396af2(0x238)+_0x3e3c73[_0x396af2(0x299)]),console[_0x396af2(0x22e)](_0x396af2(0x1ec)+_0x3e3c73[_0x396af2(0x223)]),console[_0x396af2(0x22e)](_0x396af2(0x1e9)+_0x3e3c73[_0x396af2(0x291)]+'\x20'+_0x3e3c73[_0x396af2(0x235)]),console[_0x396af2(0x22e)]('\x20\x20\x20-\x20ShopId:\x20'+_0x3e3c73[_0x396af2(0x29f)]);if(_0x3e3c73['gateway']!==_0x396af2(0x20d)){console[_0x396af2(0x22e)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x274399+_0x396af2(0x1d5)+_0x3e3c73[_0x396af2(0x242)]+')');return;}if(_0x3e3c73[_0x396af2(0x299)]!==_0x396af2(0x2a5)){console['log'](_0x396af2(0x201)+_0x274399+_0x396af2(0x21c)+_0x3e3c73[_0x396af2(0x299)]+_0x396af2(0x28d)),this[_0x396af2(0x249)](_0x274399);return;}if(!_0x3e3c73[_0x396af2(0x223)]){console[_0x396af2(0x22e)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x274399+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x396af2(0x22e)]('✅\x20[CHECK]\x20Payment\x20'+_0x274399+_0x396af2(0x2ad)),await this[_0x396af2(0x1e7)](_0x3e3c73);}['logCoinToPayStatus'](_0x498ba4,_0x415d98,_0x45f4d3,_0x2cb7a2,_0xd644c,_0x324671){const _0x318579=a37_0x57feb7,_0x4497d8={'type':_0x318579(0x222),'paymentId':_0x498ba4,'gatewayPaymentId':_0x415d98,'oldStatus':_0x45f4d3,'newStatus':_0x2cb7a2,'source':_0xd644c,'timestamp':new Date()[_0x318579(0x1f1)](),'details':_0x324671||{}};loggerService_1[_0x318579(0x285)][_0x318579(0x25c)](_0x4497d8),console[_0x318579(0x22e)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x498ba4+'\x20('+_0x415d98+')'),console[_0x318579(0x22e)](_0x318579(0x289)+_0x45f4d3+_0x318579(0x27b)+_0x2cb7a2),console[_0x318579(0x22e)]('\x20\x20\x20📍\x20Source:\x20'+_0xd644c),console[_0x318579(0x22e)](_0x318579(0x248)+_0x4497d8[_0x318579(0x246)]),_0x324671&&console[_0x318579(0x22e)](_0x318579(0x211),_0x324671);}[a37_0x57feb7(0x1f0)](_0x271187,_0x3e00b9,_0x4c9b68,_0x49ae35,_0x4d4ca3){const _0x58ec05=a37_0x57feb7,_0x3e5080={'type':_0x58ec05(0x230),'paymentId':_0x271187,'gatewayPaymentId':_0x3e00b9,'error':_0x4c9b68 instanceof Error?{'message':_0x4c9b68['message'],'stack':_0x4c9b68[_0x58ec05(0x216)]}:_0x4c9b68,'source':_0x49ae35,'timestamp':new Date()[_0x58ec05(0x1f1)](),'context':_0x4d4ca3||{}};loggerService_1[_0x58ec05(0x285)][_0x58ec05(0x1f0)](_0x3e5080),console[_0x58ec05(0x298)]('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x271187+'\x20('+_0x3e00b9+')'),console[_0x58ec05(0x298)]('\x20\x20\x20❌\x20Error:\x20'+(_0x4c9b68 instanceof Error?_0x4c9b68['message']:_0x4c9b68)),console[_0x58ec05(0x298)]('\x20\x20\x20📍\x20Source:\x20'+_0x49ae35),console['error'](_0x58ec05(0x248)+_0x3e5080[_0x58ec05(0x246)]),_0x4d4ca3&&console['error']('\x20\x20\x20📝\x20Context:',_0x4d4ca3);}[a37_0x57feb7(0x24a)](){const _0x14fedf=a37_0x57feb7;console['log'](_0x14fedf(0x268)),this['checkAllPendingPayments']()[_0x14fedf(0x1e0)](_0x14b49=>{const _0x135eb0=_0x14fedf;console['error'](_0x135eb0(0x263),_0x14b49);}),this[_0x14fedf(0x234)]=setInterval(async()=>{const _0x4d94a1=_0x14fedf;try{console[_0x4d94a1(0x22e)](_0x4d94a1(0x2a6)),await this[_0x4d94a1(0x214)](),console['log']('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x226e01){console['error'](_0x4d94a1(0x1ea),_0x226e01);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x14fedf(0x22e)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}['stopPeriodicStatusCheck'](){const _0x218b7d=a37_0x57feb7;console[_0x218b7d(0x22e)](_0x218b7d(0x1ff));this['globalCheckInterval']&&(clearInterval(this[_0x218b7d(0x234)]),this[_0x218b7d(0x234)]=null,console[_0x218b7d(0x22e)]('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x587d55=this[_0x218b7d(0x208)][_0x218b7d(0x286)];for(const [_0x271682]of this['paymentTimers']){this[_0x218b7d(0x249)](_0x271682);}console[_0x218b7d(0x22e)](_0x218b7d(0x22c)+_0x587d55+_0x218b7d(0x1d8));}async[a37_0x57feb7(0x214)](){const _0x2f1e3c=a37_0x57feb7;try{console[_0x2f1e3c(0x22e)](_0x2f1e3c(0x2a7));const _0x26d848=await database_1['default'][_0x2f1e3c(0x2a1)][_0x2f1e3c(0x287)]({'where':{'gateway':_0x2f1e3c(0x20d),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x2f1e3c(0x21f)+_0x26d848[_0x2f1e3c(0x25b)]+_0x2f1e3c(0x25e));if(_0x26d848['length']===0x0){console[_0x2f1e3c(0x22e)](_0x2f1e3c(0x24c));return;}const _0xe5c42a=await this[_0x2f1e3c(0x1ef)](_0x26d848);console[_0x2f1e3c(0x22e)](_0x2f1e3c(0x293)+_0xe5c42a[_0x2f1e3c(0x25b)]+_0x2f1e3c(0x264));let _0x11deee=0x0,_0xb0f4d2=0x0;for(const _0x33b7d2 of _0x26d848){try{if(_0xe5c42a[_0x2f1e3c(0x1fa)](_0x33b7d2['id'])){console[_0x2f1e3c(0x22e)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x33b7d2['id']+_0x2f1e3c(0x1d3)),_0xb0f4d2++;continue;}if(this['paymentTimers'][_0x2f1e3c(0x29c)](_0x33b7d2['id'])){console['log'](_0x2f1e3c(0x2a4)+_0x33b7d2['id']+_0x2f1e3c(0x209)),_0xb0f4d2++;continue;}const _0x367c2d=(Date[_0x2f1e3c(0x1e5)]()-_0x33b7d2[_0x2f1e3c(0x1e4)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x367c2d<0x1){console['log'](_0x2f1e3c(0x2a4)+_0x33b7d2['id']+'\x20is\x20too\x20new\x20('+_0x367c2d[_0x2f1e3c(0x27e)](0x1)+'h),\x20skipping\x20global\x20check'),_0xb0f4d2++;continue;}console[_0x2f1e3c(0x22e)]('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x33b7d2['id']+_0x2f1e3c(0x260)+_0x367c2d[_0x2f1e3c(0x27e)](0x1)+'h)'),await this[_0x2f1e3c(0x1e7)](_0x33b7d2),_0x11deee++,await new Promise(_0x673121=>setTimeout(_0x673121,0x7d0));}catch(_0x43aaeb){console[_0x2f1e3c(0x298)](_0x2f1e3c(0x22b)+_0x33b7d2['id']+':',_0x43aaeb),this[_0x2f1e3c(0x1f0)](_0x33b7d2['id'],_0x33b7d2[_0x2f1e3c(0x223)]||_0x2f1e3c(0x1f8),_0x43aaeb,_0x2f1e3c(0x1ed),{'isGlobalCheck':!![],'paymentAmount':_0x33b7d2[_0x2f1e3c(0x291)],'paymentCurrency':_0x33b7d2[_0x2f1e3c(0x235)],'shopId':_0x33b7d2['shopId'],'createdAt':_0x33b7d2[_0x2f1e3c(0x1e4)]}),loggerService_1[_0x2f1e3c(0x285)][_0x2f1e3c(0x258)]('cointopay','/status/'+_0x33b7d2['gatewayPaymentId'],_0x43aaeb);}}console[_0x2f1e3c(0x22e)](_0x2f1e3c(0x1df)+_0x11deee+'\x20checked,\x20'+_0xb0f4d2+_0x2f1e3c(0x296)+_0xe5c42a['length']+_0x2f1e3c(0x1e8));}catch(_0x30456d){console[_0x2f1e3c(0x298)](_0x2f1e3c(0x1e2),_0x30456d);}}async[a37_0x57feb7(0x1ef)](_0x2d537f){const _0x344bbd=a37_0x57feb7,_0x4b418a=[],_0x1c6d5f=new Date();_0x1c6d5f[_0x344bbd(0x275)](_0x1c6d5f['getDate']()-this['EXPIRY_DAYS']),console[_0x344bbd(0x22e)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x344bbd(0x2a8)+_0x1c6d5f['toISOString']()+')');for(const _0x4a9dde of _0x2d537f){if(_0x4a9dde[_0x344bbd(0x1e4)]<_0x1c6d5f){console[_0x344bbd(0x22e)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x4a9dde['id']+_0x344bbd(0x20f)+this[_0x344bbd(0x252)]+_0x344bbd(0x2b4));try{this[_0x344bbd(0x25c)](_0x4a9dde['id'],_0x4a9dde[_0x344bbd(0x223)]||'unknown',_0x344bbd(0x2a5),_0x344bbd(0x2bc),_0x344bbd(0x276),{'reason':_0x344bbd(0x273)+this[_0x344bbd(0x252)]+_0x344bbd(0x2bb),'createdAt':_0x4a9dde['createdAt'],'daysSinceCreation':Math[_0x344bbd(0x1fe)]((Date[_0x344bbd(0x1e5)]()-_0x4a9dde[_0x344bbd(0x1e4)][_0x344bbd(0x220)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x4a9dde[_0x344bbd(0x291)],'paymentCurrency':_0x4a9dde[_0x344bbd(0x235)],'shopId':_0x4a9dde[_0x344bbd(0x29f)]}),await database_1[_0x344bbd(0x1fd)]['payment'][_0x344bbd(0x2ab)]({'where':{'id':_0x4a9dde['id']},'data':{'status':_0x344bbd(0x2bc),'updatedAt':new Date(),'adminNotes':_0x344bbd(0x256)+this[_0x344bbd(0x252)]+_0x344bbd(0x23a)}}),await database_1[_0x344bbd(0x1fd)][_0x344bbd(0x247)]['create']({'data':{'paymentId':_0x4a9dde['id'],'shopId':_0x4a9dde['shopId'],'event':_0x344bbd(0x1f3),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x344bbd(0x273)+this[_0x344bbd(0x252)]+_0x344bbd(0x2bb),'createdAt':_0x4a9dde[_0x344bbd(0x1e4)],'expiredAt':new Date()[_0x344bbd(0x1f1)](),'daysSinceCreation':Math['floor']((Date[_0x344bbd(0x1e5)]()-_0x4a9dde[_0x344bbd(0x1e4)][_0x344bbd(0x220)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x344bbd(0x29e)](_0x4a9dde,'EXPIRED'),await this[_0x344bbd(0x232)](_0x4a9dde,'EXPIRED'),this[_0x344bbd(0x249)](_0x4a9dde['id']),_0x4b418a[_0x344bbd(0x23c)](_0x4a9dde['id']),console[_0x344bbd(0x22e)](_0x344bbd(0x228)+_0x4a9dde['id']+_0x344bbd(0x29b)+this[_0x344bbd(0x252)]+_0x344bbd(0x1f6));}catch(_0x45e12f){console['error'](_0x344bbd(0x22a)+_0x4a9dde['id']+':',_0x45e12f),this[_0x344bbd(0x1f0)](_0x4a9dde['id'],_0x4a9dde['gatewayPaymentId']||_0x344bbd(0x1f8),_0x45e12f,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x4a9dde[_0x344bbd(0x1e4)],'daysSinceCreation':Math[_0x344bbd(0x1fe)]((Date[_0x344bbd(0x1e5)]()-_0x4a9dde[_0x344bbd(0x1e4)][_0x344bbd(0x220)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x4b418a;}async[a37_0x57feb7(0x1e7)](_0x517bd3){const _0x36f24c=a37_0x57feb7;if(!_0x517bd3[_0x36f24c(0x223)]){console['log'](_0x36f24c(0x201)+_0x517bd3['id']+_0x36f24c(0x1e6));return;}console[_0x36f24c(0x22e)]('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x517bd3['id']+'\x20('+_0x517bd3[_0x36f24c(0x223)]+')');try{const _0x4f04af=await this['coinToPayService'][_0x36f24c(0x255)](_0x517bd3['gatewayPaymentId']);console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x517bd3['id']+_0x36f24c(0x1ee)+_0x4f04af[_0x36f24c(0x299)]);_0x4f04af['paymentDetails']&&console[_0x36f24c(0x22e)](_0x36f24c(0x2b8)+_0x517bd3['id']+_0x36f24c(0x26c),{'iban':_0x4f04af[_0x36f24c(0x24d)]['iban']||_0x36f24c(0x1e1),'transactionId':_0x4f04af[_0x36f24c(0x24d)][_0x36f24c(0x26a)],'createdOn':_0x4f04af[_0x36f24c(0x24d)][_0x36f24c(0x1f4)],'confirmedOn':_0x4f04af[_0x36f24c(0x24d)]['confirmedOn']||_0x36f24c(0x24f)});if(_0x4f04af[_0x36f24c(0x299)]!==_0x517bd3[_0x36f24c(0x299)]){console[_0x36f24c(0x22e)](_0x36f24c(0x212)+_0x517bd3['id']+_0x36f24c(0x267)+_0x517bd3[_0x36f24c(0x299)]+_0x36f24c(0x20c)+_0x4f04af[_0x36f24c(0x299)]),this[_0x36f24c(0x25c)](_0x517bd3['id'],_0x517bd3[_0x36f24c(0x223)],_0x517bd3['status'],_0x4f04af[_0x36f24c(0x299)],_0x36f24c(0x1ed),{'paymentDetails':_0x4f04af[_0x36f24c(0x24d)],'amount':_0x4f04af[_0x36f24c(0x291)],'currency':_0x4f04af['currency'],'shopId':_0x517bd3[_0x36f24c(0x29f)],'checkTimestamp':new Date()[_0x36f24c(0x1f1)]()});const _0x2be694={'status':_0x4f04af[_0x36f24c(0x299)],'updatedAt':new Date()};_0x4f04af[_0x36f24c(0x299)]==='PAID'&&_0x517bd3[_0x36f24c(0x299)]!==_0x36f24c(0x253)&&(_0x2be694[_0x36f24c(0x1db)]=new Date(),console[_0x36f24c(0x22e)](_0x36f24c(0x21b)+_0x517bd3['id']+_0x36f24c(0x245)+_0x2be694[_0x36f24c(0x1db)]['toISOString']()));if(_0x4f04af[_0x36f24c(0x24d)]){const _0x1e4908=_0x4f04af['paymentDetails'];_0x1e4908[_0x36f24c(0x1eb)]&&(_0x2be694[_0x36f24c(0x1d6)]=_0x1e4908[_0x36f24c(0x1eb)],console['log'](_0x36f24c(0x2b0)+_0x1e4908[_0x36f24c(0x1eb)]));if(_0x1e4908[_0x36f24c(0x251)]){const _0x25b49b=_0x517bd3[_0x36f24c(0x226)]||'',_0x2e45ae=_0x36f24c(0x2b9)+_0x1e4908[_0x36f24c(0x251)];_0x2be694[_0x36f24c(0x226)]=_0x25b49b?_0x25b49b+'\x0a\x0a'+_0x2e45ae:_0x2e45ae,console['log'](_0x36f24c(0x229));}_0x1e4908['transactionId']&&console[_0x36f24c(0x22e)](_0x36f24c(0x2a9)+_0x1e4908['transactionId']),_0x1e4908[_0x36f24c(0x21e)]&&console[_0x36f24c(0x22e)](_0x36f24c(0x1de)+_0x1e4908['confirmedOn']);}await database_1[_0x36f24c(0x1fd)][_0x36f24c(0x2a1)][_0x36f24c(0x2ab)]({'where':{'id':_0x517bd3['id']},'data':_0x2be694}),await database_1[_0x36f24c(0x1fd)]['webhookLog']['create']({'data':{'paymentId':_0x517bd3['id'],'shopId':_0x517bd3[_0x36f24c(0x29f)],'event':_0x36f24c(0x21a)+_0x4f04af[_0x36f24c(0x299)][_0x36f24c(0x262)](),'statusCode':0xc8,'responseBody':JSON[_0x36f24c(0x26b)]({'oldStatus':_0x517bd3[_0x36f24c(0x299)],'newStatus':_0x4f04af[_0x36f24c(0x299)],'paymentDetails':_0x4f04af[_0x36f24c(0x24d)],'checkedAt':new Date()[_0x36f24c(0x1f1)]()})}}),await this['sendShopWebhook'](_0x517bd3,_0x4f04af[_0x36f24c(0x299)]),await this[_0x36f24c(0x232)](_0x517bd3,_0x4f04af[_0x36f24c(0x299)]),_0x4f04af[_0x36f24c(0x299)]!=='PENDING'&&(console[_0x36f24c(0x22e)](_0x36f24c(0x28e)+_0x517bd3['id']+_0x36f24c(0x203)+_0x4f04af[_0x36f24c(0x299)]+_0x36f24c(0x27f)),this[_0x36f24c(0x249)](_0x517bd3['id'])),console[_0x36f24c(0x22e)](_0x36f24c(0x297)+_0x517bd3['id']+'\x20updated\x20successfully');}else console[_0x36f24c(0x22e)]('📊\x20[CHECK]\x20Payment\x20'+_0x517bd3['id']+'\x20status\x20unchanged\x20('+_0x4f04af['status']+')'),this[_0x36f24c(0x25c)](_0x517bd3['id'],_0x517bd3[_0x36f24c(0x223)],_0x517bd3['status'],_0x4f04af['status'],_0x36f24c(0x1ed),{'statusUnchanged':!![],'paymentDetails':_0x4f04af[_0x36f24c(0x24d)],'amount':_0x4f04af[_0x36f24c(0x291)],'currency':_0x4f04af[_0x36f24c(0x235)],'shopId':_0x517bd3[_0x36f24c(0x29f)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x36b9b8){console[_0x36f24c(0x298)](_0x36f24c(0x26d)+_0x517bd3['id']+':',_0x36b9b8),this[_0x36f24c(0x1f0)](_0x517bd3['id'],_0x517bd3[_0x36f24c(0x223)],_0x36b9b8,_0x36f24c(0x1ed),{'paymentAmount':_0x517bd3['amount'],'paymentCurrency':_0x517bd3['currency'],'shopId':_0x517bd3[_0x36f24c(0x29f)],'createdAt':_0x517bd3[_0x36f24c(0x1e4)]}),await database_1['default'][_0x36f24c(0x247)][_0x36f24c(0x227)]({'data':{'paymentId':_0x517bd3['id'],'shopId':_0x517bd3[_0x36f24c(0x29f)],'event':_0x36f24c(0x259),'statusCode':0x1f4,'responseBody':JSON[_0x36f24c(0x26b)]({'error':_0x36b9b8 instanceof Error?_0x36b9b8['message']:_0x36f24c(0x27a),'gatewayPaymentId':_0x517bd3[_0x36f24c(0x223)],'checkedAt':new Date()['toISOString']()})}});}}async[a37_0x57feb7(0x29e)](_0x3571c1,_0x4d4032){const _0x5dd1c6=a37_0x57feb7,_0x3d4880=Date['now']();try{const _0x341f96=_0x3571c1[_0x5dd1c6(0x294)],_0x460fcb=_0x341f96[_0x5dd1c6(0x1d7)];if(!_0x460fcb?.[_0x5dd1c6(0x295)]){console[_0x5dd1c6(0x22e)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x341f96['id']);return;}const _0x3ee419=_0x4d4032==='PAID'?_0x5dd1c6(0x25f):_0x4d4032===_0x5dd1c6(0x244)?_0x5dd1c6(0x2a0):_0x4d4032==='EXPIRED'?_0x5dd1c6(0x2a0):_0x5dd1c6(0x25d);if(!_0x460fcb[_0x5dd1c6(0x279)]?.[_0x5dd1c6(0x1fa)](_0x3ee419)){console[_0x5dd1c6(0x22e)](_0x5dd1c6(0x24e)+_0x3ee419+_0x5dd1c6(0x23e)+_0x341f96['id']);return;}const _0x2bb40c={'event':_0x3ee419,'payment':{'id':_0x3571c1['id'],'order_id':_0x3571c1[_0x5dd1c6(0x1fb)],'gateway_order_id':_0x3571c1[_0x5dd1c6(0x2b1)],'gateway':_0x5dd1c6(0x29d),'amount':_0x3571c1[_0x5dd1c6(0x291)],'currency':_0x3571c1[_0x5dd1c6(0x235)],'status':_0x4d4032['toLowerCase'](),'customer_email':_0x3571c1[_0x5dd1c6(0x2b2)],'customer_name':_0x3571c1[_0x5dd1c6(0x25a)],'created_at':_0x3571c1[_0x5dd1c6(0x1e4)],'updated_at':new Date()}},_0x3681f8=await fetch(_0x460fcb['webhookUrl'],{'method':_0x5dd1c6(0x2a3),'headers':{'Content-Type':_0x5dd1c6(0x254),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x5dd1c6(0x26b)](_0x2bb40c)}),_0x4d87b3=Date['now']()-_0x3d4880,_0x765d4c=_0x3681f8['ok']?'Success':await _0x3681f8['text']();loggerService_1[_0x5dd1c6(0x285)][_0x5dd1c6(0x21d)](_0x3571c1[_0x5dd1c6(0x29f)],_0x460fcb[_0x5dd1c6(0x295)],_0x3ee419,_0x3681f8['status'],_0x4d87b3,_0x2bb40c),console[_0x5dd1c6(0x22e)](_0x5dd1c6(0x23f)+_0x460fcb[_0x5dd1c6(0x295)]+_0x5dd1c6(0x1f9)+_0x3681f8[_0x5dd1c6(0x299)]+'\x20('+_0x4d87b3+_0x5dd1c6(0x272));}catch(_0x1c7bab){console[_0x5dd1c6(0x298)](_0x5dd1c6(0x23d),_0x1c7bab),loggerService_1['loggerService'][_0x5dd1c6(0x1f7)](_0x3571c1[_0x5dd1c6(0x29f)],_0x3571c1[_0x5dd1c6(0x294)]?.[_0x5dd1c6(0x1d7)]?.[_0x5dd1c6(0x295)]||_0x5dd1c6(0x1f8),_0x5dd1c6(0x20a),_0x1c7bab,{});}}async['sendPaymentStatusNotification'](_0x2702dd,_0x5a20e3){const _0x185d2c=a37_0x57feb7;try{const _0x22e6ef={'PENDING':_0x185d2c(0x26f),'PAID':_0x185d2c(0x1f2),'FAILED':_0x185d2c(0x219),'EXPIRED':_0x185d2c(0x1d9)},_0x55fecc=_0x22e6ef[_0x5a20e3];if(!_0x55fecc||_0x55fecc==='created')return;await telegramBotService_1[_0x185d2c(0x261)]['sendPaymentNotification'](_0x2702dd['shopId'],_0x2702dd,_0x55fecc);}catch(_0x43d84f){console[_0x185d2c(0x298)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x43d84f);}}async[a37_0x57feb7(0x23b)](_0x3c8b96){const _0x165085=a37_0x57feb7;console['log'](_0x165085(0x20b)+_0x3c8b96);const _0x166274=await database_1[_0x165085(0x1fd)]['payment'][_0x165085(0x28a)]({'where':{'id':_0x3c8b96},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x166274)throw new Error(_0x165085(0x265));if(_0x166274[_0x165085(0x242)]!==_0x165085(0x20d))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x165085(0x22e)](_0x165085(0x240)+_0x3c8b96),await this[_0x165085(0x1e7)](_0x166274),console['log'](_0x165085(0x2ba)+_0x3c8b96);}[a37_0x57feb7(0x22f)](){const _0x4036be=a37_0x57feb7,_0x2f51ef=this[_0x4036be(0x234)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x522c0e=Array[_0x4036be(0x1d4)](this[_0x4036be(0x208)]['values']())['map'](_0x465d27=>({'paymentId':_0x465d27['paymentId'],'gatewayPaymentId':_0x465d27[_0x4036be(0x223)],'createdAt':_0x465d27[_0x4036be(0x1e4)],'timersCount':_0x465d27['timers']['length']}));return{'isActive':!!this[_0x4036be(0x234)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x4036be(0x252)],'activeIndividualTimers':this['paymentTimers'][_0x4036be(0x286)],'nextGlobalCheckIn':_0x2f51ef,'paymentTimersDetails':_0x522c0e};}['getPaymentTimerInfo'](_0x2039d1){const _0x5b718f=a37_0x57feb7,_0x5cb725=this['paymentTimers'][_0x5b718f(0x224)](_0x2039d1);if(_0x5cb725)return{'hasTimers':!![],'timersCount':_0x5cb725['timers'][_0x5b718f(0x25b)],'createdAt':_0x5cb725[_0x5b718f(0x1e4)],'gatewayPaymentId':_0x5cb725['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a37_0x57feb7(0x221)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();