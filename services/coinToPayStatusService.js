'use strict';function a35_0x5c4a(_0x2b24e1,_0x441b91){const _0x94f94f=a35_0x94f9();return a35_0x5c4a=function(_0x5c4af3,_0x2fb180){_0x5c4af3=_0x5c4af3-0x1c1;let _0x110c96=_0x94f94f[_0x5c4af3];return _0x110c96;},a35_0x5c4a(_0x2b24e1,_0x441b91);}const a35_0x128174=a35_0x5c4a;(function(_0x36208f,_0x13037f){const _0x2db5d9=a35_0x5c4a,_0x53511f=_0x36208f();while(!![]){try{const _0x4a463e=parseInt(_0x2db5d9(0x239))/0x1+-parseInt(_0x2db5d9(0x1c7))/0x2+parseInt(_0x2db5d9(0x1d0))/0x3+-parseInt(_0x2db5d9(0x201))/0x4+-parseInt(_0x2db5d9(0x20f))/0x5*(parseInt(_0x2db5d9(0x238))/0x6)+-parseInt(_0x2db5d9(0x1c5))/0x7+parseInt(_0x2db5d9(0x23f))/0x8;if(_0x4a463e===_0x13037f)break;else _0x53511f['push'](_0x53511f['shift']());}catch(_0x86f115){_0x53511f['push'](_0x53511f['shift']());}}}(a35_0x94f9,0xe3c64));var __importDefault=this&&this[a35_0x128174(0x1f9)]||function(_0x3de7c7){return _0x3de7c7&&_0x3de7c7['__esModule']?_0x3de7c7:{'default':_0x3de7c7};};Object[a35_0x128174(0x1f2)](exports,a35_0x128174(0x208),{'value':!![]}),exports[a35_0x128174(0x202)]=exports[a35_0x128174(0x1ea)]=void 0x0;const coinToPayService_1=require(a35_0x128174(0x212)),database_1=__importDefault(require(a35_0x128174(0x1d6))),telegramBotService_1=require(a35_0x128174(0x1f3)),loggerService_1=require(a35_0x128174(0x240));class CoinToPayStatusService{constructor(){const _0x33d601=a35_0x128174;this[_0x33d601(0x1cb)]=null,this[_0x33d601(0x225)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x33d601(0x217)]=new coinToPayService_1['CoinToPayService']();}[a35_0x128174(0x23a)](){const _0x298f68=a35_0x128174;console[_0x298f68(0x1d7)](_0x298f68(0x1e9)),this[_0x298f68(0x1fa)]()[_0x298f68(0x215)](_0x5bfb14=>{const _0x25ca50=_0x298f68;console[_0x25ca50(0x1ed)](_0x25ca50(0x23c),_0x5bfb14);}),this[_0x298f68(0x1cb)]=setInterval(async()=>{const _0x1b1a27=_0x298f68;try{await this[_0x1b1a27(0x1fa)]();}catch(_0x369213){console[_0x1b1a27(0x1ed)](_0x1b1a27(0x1f5),_0x369213);}},this[_0x298f68(0x225)]),console[_0x298f68(0x1d7)](_0x298f68(0x248));}[a35_0x128174(0x1c4)](){const _0x4e2b4f=a35_0x128174;this[_0x4e2b4f(0x1cb)]&&(clearInterval(this['checkInterval']),this['checkInterval']=null,console[_0x4e2b4f(0x1d7)](_0x4e2b4f(0x1d2)));}async[a35_0x128174(0x1fa)](){const _0x14f796=a35_0x128174;try{const _0x4808c4=await database_1['default']['payment']['findMany']({'where':{'gateway':_0x14f796(0x1dc),'status':_0x14f796(0x1e7),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x4808c4[_0x14f796(0x23b)]===0x0){console[_0x14f796(0x1d7)](_0x14f796(0x213));return;}console[_0x14f796(0x1d7)](_0x14f796(0x21e)+_0x4808c4[_0x14f796(0x23b)]+_0x14f796(0x21f));const _0x5cd341=await this[_0x14f796(0x221)](_0x4808c4);console['log'](_0x14f796(0x1fc)+_0x5cd341['length']+_0x14f796(0x1ce));for(const _0x51f188 of _0x4808c4){try{if(_0x5cd341['includes'](_0x51f188['id'])){console[_0x14f796(0x1d7)](_0x14f796(0x228)+_0x51f188['id']+_0x14f796(0x1c8));continue;}await this[_0x14f796(0x246)](_0x51f188),await new Promise(_0x2c9c0b=>setTimeout(_0x2c9c0b,0x7d0));}catch(_0x269655){console[_0x14f796(0x1ed)](_0x14f796(0x1f4)+_0x51f188['id']+':',_0x269655),loggerService_1[_0x14f796(0x211)]['logWhiteDomainError'](_0x14f796(0x1dc),'/status/'+_0x51f188['gatewayPaymentId'],_0x269655);}}console[_0x14f796(0x1d7)](_0x14f796(0x237)+_0x4808c4['length']+_0x14f796(0x20a));}catch(_0x703390){console['error'](_0x14f796(0x220),_0x703390);}}async['checkExpiredPayments'](_0xe5bac4){const _0x19f912=a35_0x128174,_0x263c7d=[],_0x478389=new Date();_0x478389[_0x19f912(0x22d)](_0x478389[_0x19f912(0x231)]()-this[_0x19f912(0x207)]),console[_0x19f912(0x1d7)](_0x19f912(0x22e)+this['EXPIRY_DAYS']+_0x19f912(0x24a)+_0x478389[_0x19f912(0x1de)]()+')');for(const _0x3db8f6 of _0xe5bac4){if(_0x3db8f6[_0x19f912(0x1e1)]<_0x478389){console['log'](_0x19f912(0x228)+_0x3db8f6['id']+_0x19f912(0x1c3)+this['EXPIRY_DAYS']+_0x19f912(0x23d));try{await database_1[_0x19f912(0x1d5)]['payment'][_0x19f912(0x1d1)]({'where':{'id':_0x3db8f6['id']},'data':{'status':_0x19f912(0x1da),'updatedAt':new Date(),'adminNotes':_0x19f912(0x20d)+this['EXPIRY_DAYS']+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1['default'][_0x19f912(0x1cc)][_0x19f912(0x200)]({'data':{'paymentId':_0x3db8f6['id'],'shopId':_0x3db8f6['shopId'],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x19f912(0x22f)]({'reason':_0x19f912(0x1d4)+this[_0x19f912(0x207)]+'\x20days','createdAt':_0x3db8f6['createdAt'],'expiredAt':new Date()[_0x19f912(0x1de)](),'daysSinceCreation':Math[_0x19f912(0x24c)]((Date[_0x19f912(0x1cf)]()-_0x3db8f6[_0x19f912(0x1e1)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x19f912(0x21a)](_0x3db8f6,_0x19f912(0x1da)),await this[_0x19f912(0x203)](_0x3db8f6,_0x19f912(0x1da)),_0x263c7d[_0x19f912(0x223)](_0x3db8f6['id']),console[_0x19f912(0x1d7)]('âœ…\x20Payment\x20'+_0x3db8f6['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x19f912(0x207)]+_0x19f912(0x232));}catch(_0x1c24a7){console[_0x19f912(0x1ed)](_0x19f912(0x21b)+_0x3db8f6['id']+':',_0x1c24a7);}}}return _0x263c7d;}async[a35_0x128174(0x246)](_0x2ab29b){const _0x1f0875=a35_0x128174;if(!_0x2ab29b[_0x1f0875(0x226)]){console[_0x1f0875(0x1d7)](_0x1f0875(0x1dd)+_0x2ab29b['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console['log'](_0x1f0875(0x1e0)+_0x2ab29b['id']+'\x20('+_0x2ab29b[_0x1f0875(0x226)]+')');try{const _0x3b5bb2=await this[_0x1f0875(0x217)][_0x1f0875(0x1ec)](_0x2ab29b[_0x1f0875(0x226)]);console['log']('ðŸ“Š\x20Payment\x20'+_0x2ab29b['id']+'\x20status:\x20'+_0x3b5bb2[_0x1f0875(0x22c)]);_0x3b5bb2['paymentDetails']&&console[_0x1f0875(0x1d7)](_0x1f0875(0x214)+_0x2ab29b['id']+'\x20details:',{'iban':_0x3b5bb2[_0x1f0875(0x205)][_0x1f0875(0x1e4)]||_0x1f0875(0x243),'transactionId':_0x3b5bb2[_0x1f0875(0x205)][_0x1f0875(0x216)],'createdOn':_0x3b5bb2[_0x1f0875(0x205)][_0x1f0875(0x227)],'confirmedOn':_0x3b5bb2[_0x1f0875(0x205)][_0x1f0875(0x229)]||_0x1f0875(0x1c1)});if(_0x3b5bb2[_0x1f0875(0x22c)]!==_0x2ab29b[_0x1f0875(0x22c)]){console[_0x1f0875(0x1d7)](_0x1f0875(0x249)+_0x2ab29b['id']+_0x1f0875(0x1fe)+_0x2ab29b[_0x1f0875(0x22c)]+_0x1f0875(0x209)+_0x3b5bb2[_0x1f0875(0x22c)]);const _0x339a06={'status':_0x3b5bb2[_0x1f0875(0x22c)],'updatedAt':new Date()};_0x3b5bb2['status']===_0x1f0875(0x1ff)&&_0x2ab29b[_0x1f0875(0x22c)]!==_0x1f0875(0x1ff)&&(_0x339a06['paidAt']=new Date(),console[_0x1f0875(0x1d7)](_0x1f0875(0x242)+_0x2ab29b['id']+_0x1f0875(0x247)+_0x339a06[_0x1f0875(0x20e)][_0x1f0875(0x1de)]()));if(_0x3b5bb2[_0x1f0875(0x205)]){const _0xe8af28=_0x3b5bb2['paymentDetails'];_0xe8af28[_0x1f0875(0x1e4)]&&(_0x339a06[_0x1f0875(0x1eb)]=_0xe8af28[_0x1f0875(0x1e4)],console[_0x1f0875(0x1d7)]('ðŸ¦\x20Saved\x20IBAN:\x20'+_0xe8af28[_0x1f0875(0x1e4)]));if(_0xe8af28[_0x1f0875(0x1ee)]){const _0x506f1d=_0x2ab29b[_0x1f0875(0x1d9)]||'',_0x173810=_0x1f0875(0x1fb)+_0xe8af28[_0x1f0875(0x1ee)];_0x339a06['adminNotes']=_0x506f1d?_0x506f1d+'\x0a\x0a'+_0x173810:_0x173810,console['log'](_0x1f0875(0x1f8));}_0xe8af28[_0x1f0875(0x216)]&&console[_0x1f0875(0x1d7)]('ðŸ†”\x20Transaction\x20ID:\x20'+_0xe8af28[_0x1f0875(0x216)]),_0xe8af28[_0x1f0875(0x229)]&&console[_0x1f0875(0x1d7)](_0x1f0875(0x1c2)+_0xe8af28[_0x1f0875(0x229)]);}await database_1[_0x1f0875(0x1d5)]['payment'][_0x1f0875(0x1d1)]({'where':{'id':_0x2ab29b['id']},'data':_0x339a06}),await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0x2ab29b['id'],'shopId':_0x2ab29b[_0x1f0875(0x20c)],'event':_0x1f0875(0x233)+_0x3b5bb2[_0x1f0875(0x22c)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x1f0875(0x22f)]({'oldStatus':_0x2ab29b['status'],'newStatus':_0x3b5bb2['status'],'paymentDetails':_0x3b5bb2[_0x1f0875(0x205)],'checkedAt':new Date()[_0x1f0875(0x1de)]()})}}),await this[_0x1f0875(0x21a)](_0x2ab29b,_0x3b5bb2[_0x1f0875(0x22c)]),await this['sendPaymentStatusNotification'](_0x2ab29b,_0x3b5bb2[_0x1f0875(0x22c)]),console[_0x1f0875(0x1d7)]('âœ…\x20Payment\x20'+_0x2ab29b['id']+_0x1f0875(0x23e));}else console['log'](_0x1f0875(0x214)+_0x2ab29b['id']+_0x1f0875(0x22b)+_0x3b5bb2['status']+')');}catch(_0x416dfd){console[_0x1f0875(0x1ed)](_0x1f0875(0x222)+_0x2ab29b['id']+':',_0x416dfd),await database_1['default']['webhookLog'][_0x1f0875(0x200)]({'data':{'paymentId':_0x2ab29b['id'],'shopId':_0x2ab29b[_0x1f0875(0x20c)],'event':_0x1f0875(0x241),'statusCode':0x1f4,'responseBody':JSON[_0x1f0875(0x22f)]({'error':_0x416dfd instanceof Error?_0x416dfd[_0x1f0875(0x218)]:'Unknown\x20error','gatewayPaymentId':_0x2ab29b[_0x1f0875(0x226)],'checkedAt':new Date()[_0x1f0875(0x1de)]()})}});}}async[a35_0x128174(0x21a)](_0x2eeb65,_0x1586f5){const _0x47fce1=a35_0x128174,_0x36c022=Date[_0x47fce1(0x1cf)]();try{const _0x280f66=_0x2eeb65[_0x47fce1(0x1e5)],_0x82afa2=_0x280f66[_0x47fce1(0x1c6)];if(!_0x82afa2?.['webhookUrl']){console['log'](_0x47fce1(0x1cd)+_0x280f66['id']);return;}const _0x2df0bc=_0x1586f5===_0x47fce1(0x1ff)?'payment.success':_0x1586f5===_0x47fce1(0x236)?_0x47fce1(0x245):_0x1586f5===_0x47fce1(0x1da)?'payment.failed':_0x47fce1(0x20b);if(!_0x82afa2[_0x47fce1(0x1f1)]?.[_0x47fce1(0x1ca)](_0x2df0bc)){console[_0x47fce1(0x1d7)]('Webhook\x20event\x20'+_0x2df0bc+'\x20not\x20enabled\x20for\x20shop\x20'+_0x280f66['id']);return;}const _0x215c5e={'event':_0x2df0bc,'payment':{'id':_0x2eeb65['id'],'order_id':_0x2eeb65['orderId'],'gateway_order_id':_0x2eeb65[_0x47fce1(0x204)],'gateway':'0100','amount':_0x2eeb65[_0x47fce1(0x1f0)],'currency':_0x2eeb65[_0x47fce1(0x1e2)],'status':_0x1586f5[_0x47fce1(0x230)](),'customer_email':_0x2eeb65[_0x47fce1(0x1f7)],'customer_name':_0x2eeb65[_0x47fce1(0x22a)],'created_at':_0x2eeb65['createdAt'],'updated_at':new Date()}},_0x12aaff=await fetch(_0x82afa2[_0x47fce1(0x1e6)],{'method':_0x47fce1(0x24b),'headers':{'Content-Type':_0x47fce1(0x21d),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x215c5e)}),_0x3f8da6=Date['now']()-_0x36c022,_0x32d8d2=_0x12aaff['ok']?_0x47fce1(0x224):await _0x12aaff[_0x47fce1(0x1e3)]();loggerService_1[_0x47fce1(0x211)]['logShopWebhookSent'](_0x2eeb65[_0x47fce1(0x20c)],_0x82afa2[_0x47fce1(0x1e6)],_0x2df0bc,_0x12aaff[_0x47fce1(0x22c)],_0x3f8da6,_0x215c5e),console[_0x47fce1(0x1d7)](_0x47fce1(0x1df)+_0x82afa2[_0x47fce1(0x1e6)]+'\x20with\x20status\x20'+_0x12aaff[_0x47fce1(0x22c)]+'\x20('+_0x3f8da6+_0x47fce1(0x1fd));}catch(_0x3edba6){console[_0x47fce1(0x1ed)](_0x47fce1(0x234),_0x3edba6),loggerService_1['loggerService'][_0x47fce1(0x1ef)](_0x2eeb65[_0x47fce1(0x20c)],_0x2eeb65[_0x47fce1(0x1e5)]?.[_0x47fce1(0x1c6)]?.[_0x47fce1(0x1e6)]||_0x47fce1(0x219),'webhook_send',_0x3edba6,{});}}async['sendPaymentStatusNotification'](_0x2ab4f2,_0x55ce91){const _0x5e791f=a35_0x128174;try{const _0x12deab={'PENDING':'created','PAID':_0x5e791f(0x1d8),'FAILED':_0x5e791f(0x1f6),'EXPIRED':_0x5e791f(0x1e8)},_0x4c4292=_0x12deab[_0x55ce91];if(!_0x4c4292||_0x4c4292==='created')return;await telegramBotService_1['telegramBotService'][_0x5e791f(0x21c)](_0x2ab4f2[_0x5e791f(0x20c)],_0x2ab4f2,_0x4c4292);}catch(_0xcc4134){console[_0x5e791f(0x1ed)](_0x5e791f(0x206),_0xcc4134);}}async[a35_0x128174(0x244)](_0x5e23d3){const _0x37ef72=a35_0x128174,_0x1be1e2=await database_1[_0x37ef72(0x1d5)][_0x37ef72(0x210)][_0x37ef72(0x235)]({'where':{'id':_0x5e23d3},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1be1e2)throw new Error(_0x37ef72(0x1db));if(_0x1be1e2[_0x37ef72(0x1d3)]!==_0x37ef72(0x1dc))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');await this['checkSinglePayment'](_0x1be1e2);}[a35_0x128174(0x1c9)](){const _0x38be42=a35_0x128174,_0xa4c8ac=this[_0x38be42(0x1cb)]?this[_0x38be42(0x225)]:undefined;return{'isActive':!!this[_0x38be42(0x1cb)],'checkIntervalMinutes':this[_0x38be42(0x225)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'nextCheckIn':_0xa4c8ac};}}function a35_0x94f9(){const _0x5474c4=['POST','floor','not\x20confirmed','âœ…\x20Transaction\x20confirmed\x20on:\x20','\x20is\x20older\x20than\x20','stopPeriodicStatusCheck','6999265ZuSzxZ','settings','1659688SlyJXx','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','getServiceStats','includes','checkInterval','webhookLog','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20expired\x20CoinToPay\x20payments','now','3640893rzMWUk','update','ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped','gateway','Payment\x20older\x20than\x20','default','../config/database','log','paid','adminNotes','EXPIRED','Payment\x20not\x20found','cointopay','âš ï¸\x20Payment\x20','toISOString','Shop\x20webhook\x20sent\x20to\x20','ðŸ”\x20Checking\x20CoinToPay\x20payment\x20','createdAt','currency','text','iban','shop','webhookUrl','PENDING','expired','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','CoinToPayStatusService','remitterIban','checkPaymentStatus','error','bankDetails','logShopWebhookError','amount','webhookEvents','defineProperty','./telegramBotService','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','Periodic\x20CoinToPay\x20status\x20check\x20failed:','failed','customerEmail','ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','__importDefault','checkAllPendingPayments','Bank\x20Details:\x20','â°\x20Found\x20','ms)','\x20status\x20from\x20','PAID','create','5620636sQXlcE','coinToPayStatusService','sendPaymentStatusNotification','gatewayOrderId','paymentDetails','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','EXPIRY_DAYS','__esModule','\x20to\x20','\x20CoinToPay\x20payments','payment.pending','shopId','Automatically\x20expired\x20after\x20','paidAt','560htpBEF','payment','loggerService','./gateways/coinToPayService','ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','ðŸ“Š\x20Payment\x20','catch','transactionId','coinToPayService','message','unknown','sendShopWebhook','Failed\x20to\x20expire\x20payment\x20','sendPaymentNotification','application/json','ðŸª™\x20Checking\x20','\x20pending\x20CoinToPay\x20payments','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','checkExpiredPayments','Failed\x20to\x20check\x20payment\x20','push','Success','CHECK_INTERVAL_MS','gatewayPaymentId','createdOn','â°\x20Payment\x20','confirmedOn','customerName','\x20status\x20unchanged\x20(','status','setDate','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','stringify','toLowerCase','getDate','-day\x20timeout','cointopay_status_check_','Failed\x20to\x20send\x20shop\x20webhook:','findUnique','FAILED','âœ…\x20Completed\x20checking\x20','92694oJWhQM','613396bqdKlj','startPeriodicStatusCheck','length','Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20days,\x20marking\x20as\x20EXPIRED','\x20updated\x20successfully','32568984Ajrazt','./loggerService','cointopay_status_check_error','ðŸ’°\x20Payment\x20','not\x20found','checkPaymentById','payment.failed','checkSinglePayment','\x20marked\x20as\x20paid\x20at:\x20','âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','ðŸ”„\x20Updating\x20payment\x20','\x20days\x20(created\x20before\x20'];a35_0x94f9=function(){return _0x5474c4;};return a35_0x94f9();}exports[a35_0x128174(0x1ea)]=CoinToPayStatusService,exports[a35_0x128174(0x202)]=new CoinToPayStatusService();