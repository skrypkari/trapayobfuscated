'use strict';function a38_0x34b3(_0x4417a4,_0x4fb083){const _0x32cfe8=a38_0x32cf();return a38_0x34b3=function(_0x34b321,_0x1b2fd4){_0x34b321=_0x34b321-0x15f;let _0x2233c1=_0x32cfe8[_0x34b321];return _0x2233c1;},a38_0x34b3(_0x4417a4,_0x4fb083);}function a38_0x32cf(){const _0x4c7474=['⏰\x20[EXPIRY]\x20Payment\x20','2168AWlkGT','./gateways/coinToPay2Service','toLowerCase','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','application/json','\x20is\x20valid\x20for\x20checking,\x20proceeding...','logShopWebhookError','🪙\x20[DEBUG]\x20Creating\x20','amountUSDT','__esModule','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20initial\x20timers\x20for\x20payment\x20','📊\x20[CHECK]\x20Payment\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','Shop\x20webhook\x20sent\x20to\x20','\x20to\x20clear','18iHlbXJ','\x20days\x20without\x20payment\x20confirmation','\x20\x20\x20-\x20GatewayPaymentId:\x20','timers','settings','./currencyService','toFixed','\x20not\x20enabled\x20for\x20shop\x20','schedulePaymentChecks','\x20has\x20no\x20gatewayPaymentId','\x20for\x20payment\x20','\x20\x20\x20📍\x20Source:\x20','11608KdMYZR','\x20is\x20too\x20new\x20(','🛑\x20[SHUTDOWN]\x20Cleared\x20','clearPaymentTimers','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','📈\x20[COINTOPAY]\x20Payment\x20','amount','message','parse','has','findUnique','checkAllPendingPayments','🪙\x20[GLOBAL]\x20Found\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','CoinToPayService','customerEmail','loggerService','cointopay','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','./gateways/coinToPayService','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','EXPIRY_DAYS','CoinToPayStatusService','Unknown\x20error','SINGLE','\x20payment\x20','webhookLog','paymentLink','./loggerService','__importDefault','cointopay2','includes','📊\x20[HOURLY]\x20Payment\x20',',\x20gateway\x20','logCoinToPayStatus','❌\x20[CHECK]\x20Payment\x20','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20',':\x20type=','Payment\x20older\x20than\x20','paid','amountAfterGatewayCommissionUSDT','paymentTimers','unknown','\x20commission\x20for\x20shop\x20','getDate','transactionId','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','-day\x20timeout','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','TesSoft\x20Payment\x20System/1.0','2\x20minutes','⏰\x20[GLOBAL]\x20Found\x20','get','\x20\x20\x20-\x20Gateway:\x20','\x20details:',',\x20status=','\x20\x20\x20Amount:\x20','globalCheckInterval','cointopay_status_check_error','text','payment.success','\x20\x20\x20❌\x20Error:\x20','setDate','\x20skipped,\x20','webhookUrl','\x20completed\x20for\x20payment\x20','paymentId','Payment\x20not\x20found','bankDetails','2ugMnEs','\x20status:\x20','checkSinglePayment','💰\x20[CHECK]\x20Payment\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20\x20\x20-\x20Amount:\x20','✅\x20[CHECK]\x20Payment\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','startPeriodicStatusCheck','webhook_send','\x20(age:\x20','delay','remitterIban','\x20not\x20found\x20in\x20database','currentPayments','error','iban','push','\x20days\x20(created\x20before\x20','\x20expired\x20CoinToPay\x20payments','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','orderId','\x20pending\x20CoinToPay\x20payments','shop','905900TUGxWT','forEach','\x20in\x20shop\x20','commission','\x20\x20\x20Amount\x20after\x20commission:\x20','\x20with\x20status\x20','sendShopWebhook','\x20commission:\x20','status','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','checkExpiredPayments','363880FzUWab','\x20\x20\x20📝\x20Context:','delete','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','../types/gateway','checkSinglePaymentById','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','\x20\x20\x20-\x20paymentId:\x20','FAILED','default',',\x20currentPayments=','\x20\x20\x20📊\x20Status:\x20','gatewaySettings','⏰\x20[GLOBAL]\x20Payment\x20','expired','✅\x20[EXPIRY]\x20Payment\x20','🔍\x20[CHECK]\x20Checking\x20','created','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20\x20\x20Gateway\x20','set','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20(after\x20','logShopWebhookSent','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20status\x20changed\x20to\x20','customerName','\x20USDT','Automatically\x20expired\x20after\x20','🧹\x20[DEBUG]\x20Clearing\x20','../config/database','\x20updated:\x20currentPayments=','\x20status\x20unchanged\x20(','\x20expired','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','COINTOPAY_STATUS_CHANGE','checkPaymentStatus','confirmedOn','logCoinToPayError','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20found:','status_check','log','.\x20Remaining\x20active\x20timers:\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','size','gatewayPaymentId','✅\x20[COINTOPAY]\x20Payment\x20link\x20','type','3hBVdUi','4865VdwHGJ','floor','EXPIRED','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20timers\x20for\x20payment\x20','⚠️\x20[CHECK]\x20Payment\x20',',\x20stopping\x20individual\x20checks','\x20\x20\x20-\x20Status:\x20','map','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','\x20triggered\x20for\x20payment\x20','currency','gateway','/status/','🪙\x20[TIMER]\x20Individual\x20check\x20#','\x20\x20\x20-\x20gatewayPaymentId:\x20','createdAt','\x20\x20\x20📅\x20Time:\x20','\x20status\x20is\x20','payment.failed','\x20to\x20','adminNotes','payment.pending','now','\x20days',',\x20using\x20default\x2010%','coinToPayService','auto_expire','251872yxeIqE','\x20\x20\x20📝\x20Details:','not\x20found','\x20marked\x20as\x20paid\x20at:\x20','\x20seconds\x20(','sendPaymentStatusNotification','payment','Webhook\x20event\x20','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','\x20amounts\x20calculated:','5\x20minutes','checkPaymentById','getTime','3374591wcpUHQ','description','gatewayOrderId','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20current\x20status:\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','from','🔄\x20[CHECK]\x20Updating\x20payment\x20','\x20is\x20older\x20than\x20','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','h),\x20skipping\x20global\x20check','length','3005706bpiSIL','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','telegramBotService','stringify','\x20->\x20','shopId','update','logWhiteDomainError','CoinToPay2Service','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','coinToPayStatusService','create','getGatewayCommission','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','PAID','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20not\x20found,\x20clearing\x20timers','coinToPay2Service','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','toISOString','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','paymentDetails','defineProperty','cointopay_auto_expired','Success','1\x20minute','GLOBAL_CHECK_INTERVAL_MS','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','PENDING','values','paidAt','COINTOPAY_ERROR',',\x20clearing\x20individual\x20timers','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','webhookEvents'];a38_0x32cf=function(){return _0x4c7474;};return a38_0x32cf();}const a38_0x284263=a38_0x34b3;(function(_0x37e4ae,_0x1a0eec){const _0x1cf453=a38_0x34b3,_0x2725ee=_0x37e4ae();while(!![]){try{const _0xc52bb=-parseInt(_0x1cf453(0x1c3))/0x1*(parseInt(_0x1cf453(0x17a))/0x2)+parseInt(_0x1cf453(0x21d))/0x3*(parseInt(_0x1cf453(0x23b))/0x4)+-parseInt(_0x1cf453(0x1db))/0x5+parseInt(_0x1cf453(0x254))/0x6+parseInt(_0x1cf453(0x21e))/0x7*(parseInt(_0x1cf453(0x27c))/0x8)+parseInt(_0x1cf453(0x16e))/0x9*(parseInt(_0x1cf453(0x1e6))/0xa)+-parseInt(_0x1cf453(0x248))/0xb;if(_0xc52bb===_0x1a0eec)break;else _0x2725ee['push'](_0x2725ee['shift']());}catch(_0x82c231){_0x2725ee['push'](_0x2725ee['shift']());}}}(a38_0x32cf,0x4f75f));var __importDefault=this&&this[a38_0x284263(0x197)]||function(_0x555aa6){return _0x555aa6&&_0x555aa6['__esModule']?_0x555aa6:{'default':_0x555aa6};};Object[a38_0x284263(0x26e)](exports,a38_0x284263(0x166),{'value':!![]}),exports[a38_0x284263(0x25f)]=exports[a38_0x284263(0x190)]=void 0x0;const coinToPayService_1=require(a38_0x284263(0x18d)),coinToPay2Service_1=require(a38_0x284263(0x27d)),gateway_1=require(a38_0x284263(0x1eb)),database_1=__importDefault(require(a38_0x284263(0x20a))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a38_0x284263(0x196)),currencyService_1=require(a38_0x284263(0x173));class CoinToPayStatusService{constructor(){const _0x2e9770=a38_0x284263;this[_0x2e9770(0x1b7)]=null,this[_0x2e9770(0x272)]=0x3c*0x3c*0x3e8,this[_0x2e9770(0x18f)]=0x5,this[_0x2e9770(0x1a5)]=new Map(),this[_0x2e9770(0x239)]=new coinToPayService_1[(_0x2e9770(0x188))](),this[_0x2e9770(0x269)]=new coinToPay2Service_1[(_0x2e9770(0x25d))](),console[_0x2e9770(0x216)](_0x2e9770(0x263));}[a38_0x284263(0x176)](_0x210266,_0x5483c3){const _0xb1b67e=a38_0x284263;console[_0xb1b67e(0x216)](_0xb1b67e(0x1aa)),console[_0xb1b67e(0x216)](_0xb1b67e(0x1f2)+_0x210266),console['log'](_0xb1b67e(0x22e)+_0x5483c3),this['clearPaymentTimers'](_0x210266);const _0x9b6490=[],_0x37ea0f=new Date(),_0x55a203=[{'delay':0x1*0x3c*0x3e8,'description':_0xb1b67e(0x271)},{'delay':0x2*0x3c*0x3e8,'description':_0xb1b67e(0x1b0)},{'delay':0x5*0x3c*0x3e8,'description':_0xb1b67e(0x245)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0xb1b67e(0x216)](_0xb1b67e(0x164)+_0x55a203[_0xb1b67e(0x253)]+_0xb1b67e(0x168)+_0x210266);let _0xc60e9b=0x0;_0x55a203[_0xb1b67e(0x1dc)]((_0x35c16f,_0x1c6ecb)=>{const _0x16d730=_0xb1b67e;_0xc60e9b+=_0x35c16f[_0x16d730(0x1ce)];const _0x2c6462=setTimeout(async()=>{const _0x161906=_0x16d730;console[_0x161906(0x216)](_0x161906(0x22d)+(_0x1c6ecb+0x1)+_0x161906(0x229)+_0x210266+_0x161906(0x202)+_0x35c16f[_0x161906(0x249)]+')');try{await this[_0x161906(0x1ec)](_0x210266),console[_0x161906(0x216)]('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x1c6ecb+0x1)+_0x161906(0x1bf)+_0x210266);}catch(_0x5a39a9){console['error']('❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x1c6ecb+0x1)+_0x161906(0x178)+_0x210266+':',_0x5a39a9),this[_0x161906(0x212)](_0x210266,_0x5483c3,_0x5a39a9,_0x161906(0x215),{'checkNumber':_0x1c6ecb+0x1,'scheduledAfter':_0x35c16f[_0x161906(0x249)],'isIndividualCheck':!![]});}},_0xc60e9b);_0x9b6490['push'](_0x2c6462),console['log'](_0x16d730(0x1ab)+(_0x1c6ecb+0x1)+'\x20for\x20payment\x20'+_0x210266+'\x20in\x20'+_0xc60e9b/0x3e8+_0x16d730(0x23f)+_0x35c16f[_0x16d730(0x249)]+')');});const _0x3c743b=setInterval(async()=>{const _0x51886b=_0xb1b67e;console[_0x51886b(0x216)](_0x51886b(0x266)+_0x210266);try{const _0x1a79a3=await database_1[_0x51886b(0x1f4)]['payment']['findUnique']({'where':{'id':_0x210266},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x1a79a3){console[_0x51886b(0x216)]('❌\x20[HOURLY]\x20Payment\x20'+_0x210266+_0x51886b(0x268)),this['clearPaymentTimers'](_0x210266);return;}console['log'](_0x51886b(0x19a)+_0x210266+_0x51886b(0x24c)+_0x1a79a3['status']);if(_0x1a79a3[_0x51886b(0x1e3)]!=='PENDING'){console['log']('✅\x20[HOURLY]\x20Payment\x20'+_0x210266+_0x51886b(0x231)+_0x1a79a3[_0x51886b(0x1e3)]+_0x51886b(0x225)),this[_0x51886b(0x17d)](_0x210266);return;}const _0x2a6a00=Math[_0x51886b(0x21f)]((Date[_0x51886b(0x236)]()-_0x1a79a3[_0x51886b(0x22f)][_0x51886b(0x247)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x2a6a00>=this[_0x51886b(0x18f)]){console['log']('⏰\x20[HOURLY]\x20Payment\x20'+_0x210266+_0x51886b(0x250)+this[_0x51886b(0x18f)]+_0x51886b(0x25e)),this[_0x51886b(0x17d)](_0x210266);return;}await this[_0x51886b(0x1ec)](_0x210266),console[_0x51886b(0x216)](_0x51886b(0x262)+_0x210266);}catch(_0x55e4cf){console[_0x51886b(0x1d2)](_0x51886b(0x18c)+_0x210266+':',_0x55e4cf),this[_0x51886b(0x212)](_0x210266,_0x5483c3,_0x55e4cf,_0x51886b(0x215),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x9b6490['push'](_0x3c743b),this[_0xb1b67e(0x1a5)][_0xb1b67e(0x200)](_0x210266,{'timers':_0x9b6490,'paymentId':_0x210266,'gatewayPaymentId':_0x5483c3,'createdAt':_0x37ea0f}),console['log'](_0xb1b67e(0x187)+_0x55a203['length']+_0xb1b67e(0x24b)+_0x210266),console['log'](_0xb1b67e(0x19f)+this[_0xb1b67e(0x1a5)]['size']),this[_0xb1b67e(0x19c)](_0x210266,_0x5483c3,_0xb1b67e(0x274),_0xb1b67e(0x274),_0xb1b67e(0x215),{'action':'schedule_created','scheduledChecks':_0x55a203[_0xb1b67e(0x253)],'firstCheckIn':_0x55a203[0x0]['delay']/0x3e8,'totalTimers':this[_0xb1b67e(0x1a5)][_0xb1b67e(0x219)]});}[a38_0x284263(0x17d)](_0x3788f9){const _0x5b7f36=a38_0x284263,_0x2b9df7=this['paymentTimers'][_0x5b7f36(0x1b2)](_0x3788f9);_0x2b9df7?(console['log'](_0x5b7f36(0x209)+_0x2b9df7[_0x5b7f36(0x171)][_0x5b7f36(0x253)]+_0x5b7f36(0x223)+_0x3788f9),_0x2b9df7[_0x5b7f36(0x171)][_0x5b7f36(0x1dc)]((_0x9b8157,_0x14fc74)=>{const _0x14602d=_0x5b7f36;_0x9b8157&&(clearTimeout(_0x9b8157),clearInterval(_0x9b8157),console[_0x14602d(0x216)](_0x14602d(0x201)+(_0x14fc74+0x1)+_0x14602d(0x178)+_0x3788f9));}),this[_0x5b7f36(0x1a5)][_0x5b7f36(0x1e8)](_0x3788f9),console[_0x5b7f36(0x216)](_0x5b7f36(0x1fd)+_0x3788f9+_0x5b7f36(0x217)+this[_0x5b7f36(0x1a5)][_0x5b7f36(0x219)])):console['log'](_0x5b7f36(0x1ee)+_0x3788f9+_0x5b7f36(0x16d));}async[a38_0x284263(0x1ec)](_0x5e3190){const _0x3875b2=a38_0x284263;console['log'](_0x3875b2(0x213)+_0x5e3190);const _0x29b182=await database_1['default'][_0x3875b2(0x241)]['findUnique']({'where':{'id':_0x5e3190},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x29b182){console[_0x3875b2(0x216)](_0x3875b2(0x19d)+_0x5e3190+_0x3875b2(0x1d0));return;}console['log'](_0x3875b2(0x169)+_0x5e3190+_0x3875b2(0x214)),console['log'](_0x3875b2(0x1b3)+_0x29b182['gateway']),console[_0x3875b2(0x216)](_0x3875b2(0x226)+_0x29b182[_0x3875b2(0x1e3)]),console[_0x3875b2(0x216)](_0x3875b2(0x170)+_0x29b182['gatewayPaymentId']),console[_0x3875b2(0x216)](_0x3875b2(0x1c8)+_0x29b182[_0x3875b2(0x180)]+'\x20'+_0x29b182[_0x3875b2(0x22a)]),console[_0x3875b2(0x216)]('\x20\x20\x20-\x20ShopId:\x20'+_0x29b182[_0x3875b2(0x25a)]);if(_0x29b182[_0x3875b2(0x22b)]!==_0x3875b2(0x18b)&&_0x29b182[_0x3875b2(0x22b)]!=='cointopay2'){console[_0x3875b2(0x216)](_0x3875b2(0x224)+_0x5e3190+_0x3875b2(0x228)+_0x29b182[_0x3875b2(0x22b)]+')');return;}if(_0x29b182[_0x3875b2(0x1e3)]!==_0x3875b2(0x274)){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x5e3190+'\x20status\x20is\x20'+_0x29b182['status']+_0x3875b2(0x225)),this[_0x3875b2(0x17d)](_0x5e3190);return;}if(!_0x29b182[_0x3875b2(0x21a)]){console[_0x3875b2(0x216)](_0x3875b2(0x224)+_0x5e3190+_0x3875b2(0x177));return;}console['log']('✅\x20[CHECK]\x20Payment\x20'+_0x5e3190+_0x3875b2(0x162)),await this[_0x3875b2(0x1c5)](_0x29b182);}[a38_0x284263(0x19c)](_0x1b2ac8,_0x4ec1ad,_0x3ad0e0,_0x294098,_0x409a52,_0x43bd8e){const _0x560193=a38_0x284263,_0x5a2981={'type':_0x560193(0x20f),'paymentId':_0x1b2ac8,'gatewayPaymentId':_0x4ec1ad,'oldStatus':_0x3ad0e0,'newStatus':_0x294098,'source':_0x409a52,'timestamp':new Date()[_0x560193(0x26b)](),'details':_0x43bd8e||{}};loggerService_1[_0x560193(0x18a)]['logCoinToPayStatus'](_0x5a2981),console[_0x560193(0x216)](_0x560193(0x1d7)+_0x1b2ac8+'\x20('+_0x4ec1ad+')'),console[_0x560193(0x216)](_0x560193(0x1f6)+_0x3ad0e0+_0x560193(0x259)+_0x294098),console[_0x560193(0x216)](_0x560193(0x179)+_0x409a52),console[_0x560193(0x216)](_0x560193(0x230)+_0x5a2981['timestamp']),_0x43bd8e&&console[_0x560193(0x216)](_0x560193(0x23c),_0x43bd8e);}[a38_0x284263(0x212)](_0x3298c0,_0x52892c,_0x4183f2,_0xea61fb,_0x1fdb18){const _0x5a791a=a38_0x284263,_0x1a99aa={'type':_0x5a791a(0x277),'paymentId':_0x3298c0,'gatewayPaymentId':_0x52892c,'error':_0x4183f2 instanceof Error?{'message':_0x4183f2[_0x5a791a(0x181)],'stack':_0x4183f2['stack']}:_0x4183f2,'source':_0xea61fb,'timestamp':new Date()[_0x5a791a(0x26b)](),'context':_0x1fdb18||{}};loggerService_1[_0x5a791a(0x18a)][_0x5a791a(0x212)](_0x1a99aa),console[_0x5a791a(0x1d2)]('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x3298c0+'\x20('+_0x52892c+')'),console[_0x5a791a(0x1d2)](_0x5a791a(0x1bb)+(_0x4183f2 instanceof Error?_0x4183f2[_0x5a791a(0x181)]:_0x4183f2)),console[_0x5a791a(0x1d2)](_0x5a791a(0x179)+_0xea61fb),console['error'](_0x5a791a(0x230)+_0x1a99aa['timestamp']),_0x1fdb18&&console[_0x5a791a(0x1d2)](_0x5a791a(0x1e7),_0x1fdb18);}[a38_0x284263(0x1cb)](){const _0x5d0cd7=a38_0x284263;console['log'](_0x5d0cd7(0x160)),this[_0x5d0cd7(0x185)]()['catch'](_0x344dfb=>{const _0x5b9d08=_0x5d0cd7;console[_0x5b9d08(0x1d2)]('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x344dfb);}),this[_0x5d0cd7(0x1b7)]=setInterval(async()=>{const _0x5355a2=_0x5d0cd7;try{console[_0x5355a2(0x216)](_0x5355a2(0x1ae)),await this[_0x5355a2(0x185)](),console[_0x5355a2(0x216)](_0x5355a2(0x19e));}catch(_0x31ead2){console[_0x5355a2(0x1d2)]('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x31ead2);}},this[_0x5d0cd7(0x272)]),console[_0x5d0cd7(0x216)](_0x5d0cd7(0x26c));}['stopPeriodicStatusCheck'](){const _0x2268d4=a38_0x284263;console[_0x2268d4(0x216)](_0x2268d4(0x1c7));this['globalCheckInterval']&&(clearInterval(this['globalCheckInterval']),this[_0x2268d4(0x1b7)]=null,console[_0x2268d4(0x216)]('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x5884f9=this[_0x2268d4(0x1a5)][_0x2268d4(0x219)];for(const [_0x2b7d45]of this['paymentTimers']){this[_0x2268d4(0x17d)](_0x2b7d45);}console['log'](_0x2268d4(0x17c)+_0x5884f9+'\x20individual\x20payment\x20timers');}async[a38_0x284263(0x185)](){const _0x6b580a=a38_0x284263;try{console[_0x6b580a(0x216)](_0x6b580a(0x16a));const _0x2c6f54=await database_1[_0x6b580a(0x1f4)]['payment']['findMany']({'where':{'gateway':{'in':[_0x6b580a(0x18b),'cointopay2']},'status':_0x6b580a(0x274),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x6b580a(0x216)](_0x6b580a(0x186)+_0x2c6f54[_0x6b580a(0x253)]+_0x6b580a(0x1d9));if(_0x2c6f54[_0x6b580a(0x253)]===0x0){console[_0x6b580a(0x216)](_0x6b580a(0x267));return;}const _0x3b5393=await this['checkExpiredPayments'](_0x2c6f54);console['log'](_0x6b580a(0x1b1)+_0x3b5393[_0x6b580a(0x253)]+_0x6b580a(0x1d6));let _0x2905f6=0x0,_0x2c85b0=0x0;for(const _0xddd619 of _0x2c6f54){try{if(_0x3b5393['includes'](_0xddd619['id'])){console['log']('⏰\x20[GLOBAL]\x20Payment\x20'+_0xddd619['id']+_0x6b580a(0x279)),_0x2c85b0++;continue;}if(this[_0x6b580a(0x1a5)][_0x6b580a(0x183)](_0xddd619['id'])){console[_0x6b580a(0x216)](_0x6b580a(0x1f8)+_0xddd619['id']+_0x6b580a(0x265)),_0x2c85b0++;continue;}const _0x41cc95=(Date['now']()-_0xddd619['createdAt'][_0x6b580a(0x247)]())/(0x3e8*0x3c*0x3c);if(_0x41cc95<0x1){console[_0x6b580a(0x216)](_0x6b580a(0x1f8)+_0xddd619['id']+_0x6b580a(0x17b)+_0x41cc95[_0x6b580a(0x174)](0x1)+_0x6b580a(0x252)),_0x2c85b0++;continue;}console['log'](_0x6b580a(0x1ad)+_0xddd619['id']+_0x6b580a(0x1cd)+_0x41cc95[_0x6b580a(0x174)](0x1)+'h)'),await this['checkSinglePayment'](_0xddd619),_0x2905f6++,await new Promise(_0x21075c=>setTimeout(_0x21075c,0x7d0));}catch(_0x33dbcf){console['error'](_0x6b580a(0x1ca)+_0xddd619['id']+':',_0x33dbcf),this[_0x6b580a(0x212)](_0xddd619['id'],_0xddd619[_0x6b580a(0x21a)]||_0x6b580a(0x1a6),_0x33dbcf,_0x6b580a(0x215),{'isGlobalCheck':!![],'paymentAmount':_0xddd619[_0x6b580a(0x180)],'paymentCurrency':_0xddd619[_0x6b580a(0x22a)],'shopId':_0xddd619[_0x6b580a(0x25a)],'createdAt':_0xddd619[_0x6b580a(0x22f)]}),loggerService_1[_0x6b580a(0x18a)][_0x6b580a(0x25c)]('cointopay',_0x6b580a(0x22c)+_0xddd619[_0x6b580a(0x21a)],_0x33dbcf);}}console['log']('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x2905f6+'\x20checked,\x20'+_0x2c85b0+_0x6b580a(0x1bd)+_0x3b5393[_0x6b580a(0x253)]+_0x6b580a(0x20d));}catch(_0x12aaa7){console[_0x6b580a(0x1d2)](_0x6b580a(0x18e),_0x12aaa7);}}async[a38_0x284263(0x1e5)](_0x2929af){const _0x515a8c=a38_0x284263,_0x34b5bd=[],_0x2e567d=new Date();_0x2e567d[_0x515a8c(0x1bc)](_0x2e567d[_0x515a8c(0x1a8)]()-this['EXPIRY_DAYS']),console['log']('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x515a8c(0x18f)]+_0x515a8c(0x1d5)+_0x2e567d[_0x515a8c(0x26b)]()+')');for(const _0x5bd232 of _0x2929af){if(_0x5bd232['createdAt']<_0x2e567d){console[_0x515a8c(0x216)](_0x515a8c(0x27b)+_0x5bd232['id']+'\x20is\x20older\x20than\x20'+this[_0x515a8c(0x18f)]+_0x515a8c(0x1f1));try{this[_0x515a8c(0x19c)](_0x5bd232['id'],_0x5bd232[_0x515a8c(0x21a)]||'unknown','PENDING',_0x515a8c(0x220),_0x515a8c(0x23a),{'reason':_0x515a8c(0x1a2)+this[_0x515a8c(0x18f)]+_0x515a8c(0x237),'createdAt':_0x5bd232[_0x515a8c(0x22f)],'daysSinceCreation':Math[_0x515a8c(0x21f)]((Date[_0x515a8c(0x236)]()-_0x5bd232['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x5bd232[_0x515a8c(0x180)],'paymentCurrency':_0x5bd232[_0x515a8c(0x22a)],'shopId':_0x5bd232[_0x515a8c(0x25a)]}),await database_1['default'][_0x515a8c(0x241)]['update']({'where':{'id':_0x5bd232['id']},'data':{'status':_0x515a8c(0x220),'updatedAt':new Date(),'adminNotes':_0x515a8c(0x208)+this[_0x515a8c(0x18f)]+_0x515a8c(0x16f)}}),await database_1[_0x515a8c(0x1f4)][_0x515a8c(0x194)][_0x515a8c(0x260)]({'data':{'paymentId':_0x5bd232['id'],'shopId':_0x5bd232['shopId'],'event':_0x515a8c(0x26f),'statusCode':0xc8,'responseBody':JSON[_0x515a8c(0x258)]({'reason':'Payment\x20older\x20than\x20'+this[_0x515a8c(0x18f)]+_0x515a8c(0x237),'createdAt':_0x5bd232[_0x515a8c(0x22f)],'expiredAt':new Date()[_0x515a8c(0x26b)](),'daysSinceCreation':Math['floor']((Date[_0x515a8c(0x236)]()-_0x5bd232[_0x515a8c(0x22f)][_0x515a8c(0x247)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x515a8c(0x1e1)](_0x5bd232,'EXPIRED'),await this[_0x515a8c(0x240)](_0x5bd232,_0x515a8c(0x220)),this[_0x515a8c(0x17d)](_0x5bd232['id']),_0x34b5bd[_0x515a8c(0x1d4)](_0x5bd232['id']),console[_0x515a8c(0x216)](_0x515a8c(0x1fa)+_0x5bd232['id']+_0x515a8c(0x16b)+this[_0x515a8c(0x18f)]+_0x515a8c(0x1ac));}catch(_0x227b0a){console[_0x515a8c(0x1d2)](_0x515a8c(0x1e9)+_0x5bd232['id']+':',_0x227b0a),this[_0x515a8c(0x212)](_0x5bd232['id'],_0x5bd232['gatewayPaymentId']||_0x515a8c(0x1a6),_0x227b0a,_0x515a8c(0x23a),{'reason':_0x515a8c(0x204),'createdAt':_0x5bd232[_0x515a8c(0x22f)],'daysSinceCreation':Math[_0x515a8c(0x21f)]((Date[_0x515a8c(0x236)]()-_0x5bd232['createdAt'][_0x515a8c(0x247)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x34b5bd;}async[a38_0x284263(0x1c5)](_0x34cb17){const _0x19baaa=a38_0x284263;if(!_0x34cb17[_0x19baaa(0x21a)]){console[_0x19baaa(0x216)](_0x19baaa(0x224)+_0x34cb17['id']+_0x19baaa(0x1ea));return;}console[_0x19baaa(0x216)](_0x19baaa(0x1fb)+_0x34cb17[_0x19baaa(0x22b)]+'\x20payment\x20'+_0x34cb17['id']+'\x20('+_0x34cb17[_0x19baaa(0x21a)]+')');try{let _0x487d0b;_0x34cb17[_0x19baaa(0x22b)]===_0x19baaa(0x198)?(_0x487d0b=await this[_0x19baaa(0x269)]['checkPaymentStatus'](_0x34cb17[_0x19baaa(0x21a)]),console['log'](_0x19baaa(0x1f0)+_0x34cb17['id']+_0x19baaa(0x1c4)+_0x487d0b[_0x19baaa(0x1e3)])):(_0x487d0b=await this[_0x19baaa(0x239)][_0x19baaa(0x210)](_0x34cb17[_0x19baaa(0x21a)]),console[_0x19baaa(0x216)](_0x19baaa(0x17e)+_0x34cb17['id']+_0x19baaa(0x1c4)+_0x487d0b[_0x19baaa(0x1e3)]));_0x487d0b[_0x19baaa(0x26d)]&&console[_0x19baaa(0x216)]('📊\x20[CHECK]\x20Payment\x20'+_0x34cb17['id']+_0x19baaa(0x1b4),{'iban':_0x487d0b[_0x19baaa(0x26d)][_0x19baaa(0x1d3)]||_0x19baaa(0x23d),'transactionId':_0x487d0b[_0x19baaa(0x26d)][_0x19baaa(0x1a9)],'createdOn':_0x487d0b[_0x19baaa(0x26d)]['createdOn'],'confirmedOn':_0x487d0b['paymentDetails']['confirmedOn']||'not\x20confirmed'});if(_0x487d0b[_0x19baaa(0x1e3)]!==_0x34cb17['status']){console[_0x19baaa(0x216)](_0x19baaa(0x24f)+_0x34cb17['id']+'\x20status\x20from\x20'+_0x34cb17[_0x19baaa(0x1e3)]+_0x19baaa(0x233)+_0x487d0b[_0x19baaa(0x1e3)]),this[_0x19baaa(0x19c)](_0x34cb17['id'],_0x34cb17['gatewayPaymentId'],_0x34cb17[_0x19baaa(0x1e3)],_0x487d0b[_0x19baaa(0x1e3)],_0x19baaa(0x215),{'paymentDetails':_0x487d0b[_0x19baaa(0x26d)],'amount':_0x487d0b[_0x19baaa(0x180)],'currency':_0x487d0b[_0x19baaa(0x22a)],'shopId':_0x34cb17[_0x19baaa(0x25a)],'checkTimestamp':new Date()[_0x19baaa(0x26b)]()});const _0x183838={'status':_0x487d0b['status'],'updatedAt':new Date()};if(_0x487d0b[_0x19baaa(0x1e3)]===_0x19baaa(0x264)&&_0x34cb17[_0x19baaa(0x1e3)]!==_0x19baaa(0x264)){_0x183838['paidAt']=new Date();if(!_0x34cb17[_0x19baaa(0x165)]){const _0x572893=await currencyService_1['currencyService']['convertToUSDT'](_0x34cb17[_0x19baaa(0x180)],_0x34cb17[_0x19baaa(0x22a)]);_0x183838[_0x19baaa(0x165)]=_0x572893;const _0x429e93=await this['getGatewayCommission'](_0x34cb17[_0x19baaa(0x25a)],_0x34cb17[_0x19baaa(0x22b)]),_0x1bafb4=_0x572893*(0x1-_0x429e93/0x64);_0x183838[_0x19baaa(0x1a4)]=_0x1bafb4,console[_0x19baaa(0x216)](_0x19baaa(0x1c6)+_0x34cb17['id']+_0x19baaa(0x244)),console['log'](_0x19baaa(0x1b6)+_0x34cb17['amount']+'\x20'+_0x34cb17[_0x19baaa(0x22a)]+_0x19baaa(0x259)+_0x572893[_0x19baaa(0x174)](0x6)+_0x19baaa(0x207)),console[_0x19baaa(0x216)](_0x19baaa(0x1ff)+_0x34cb17[_0x19baaa(0x22b)]+_0x19baaa(0x1e2)+_0x429e93+'%'),console[_0x19baaa(0x216)](_0x19baaa(0x1df)+_0x1bafb4[_0x19baaa(0x174)](0x6)+_0x19baaa(0x207));}console[_0x19baaa(0x216)](_0x19baaa(0x1c6)+_0x34cb17['id']+_0x19baaa(0x23e)+_0x183838[_0x19baaa(0x276)]['toISOString']());}if(_0x487d0b[_0x19baaa(0x26d)]){const _0x24b64a=_0x487d0b[_0x19baaa(0x26d)];_0x24b64a[_0x19baaa(0x1d3)]&&(_0x183838[_0x19baaa(0x1cf)]=_0x24b64a['iban'],console[_0x19baaa(0x216)](_0x19baaa(0x1e4)+_0x24b64a[_0x19baaa(0x1d3)]));if(_0x24b64a[_0x19baaa(0x1c2)]){const _0x18db4e=_0x34cb17['adminNotes']||'',_0xeb6ac6='Bank\x20Details:\x20'+_0x24b64a['bankDetails'];_0x183838[_0x19baaa(0x234)]=_0x18db4e?_0x18db4e+'\x0a\x0a'+_0xeb6ac6:_0xeb6ac6,console['log'](_0x19baaa(0x251));}_0x24b64a[_0x19baaa(0x1a9)]&&console['log'](_0x19baaa(0x218)+_0x24b64a[_0x19baaa(0x1a9)]),_0x24b64a[_0x19baaa(0x211)]&&console[_0x19baaa(0x216)](_0x19baaa(0x167)+_0x24b64a[_0x19baaa(0x211)]);}await database_1[_0x19baaa(0x1f4)]['payment'][_0x19baaa(0x25b)]({'where':{'id':_0x34cb17['id']},'data':_0x183838});if(_0x487d0b['status']===_0x19baaa(0x264)&&_0x34cb17[_0x19baaa(0x1e3)]!==_0x19baaa(0x264)){console[_0x19baaa(0x216)](_0x19baaa(0x17f)+_0x34cb17['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x429ad7=await database_1[_0x19baaa(0x1f4)][_0x19baaa(0x241)][_0x19baaa(0x184)]({'where':{'id':_0x34cb17['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x429ad7?.['paymentLinkId']&&_0x429ad7[_0x19baaa(0x195)])try{const _0xcf14df=_0x429ad7[_0x19baaa(0x195)];console[_0x19baaa(0x216)](_0x19baaa(0x256)+_0xcf14df['id']+_0x19baaa(0x1a1)+_0xcf14df[_0x19baaa(0x21c)]+_0x19baaa(0x1f5)+_0xcf14df[_0x19baaa(0x1d1)]+_0x19baaa(0x1b5)+_0xcf14df[_0x19baaa(0x1e3)]);const _0x4fda72=_0xcf14df[_0x19baaa(0x1d1)]+0x1,_0x84a85c=_0xcf14df[_0x19baaa(0x21c)]===_0x19baaa(0x192)?'COMPLETED':_0xcf14df[_0x19baaa(0x1e3)];await database_1[_0x19baaa(0x1f4)][_0x19baaa(0x195)][_0x19baaa(0x25b)]({'where':{'id':_0xcf14df['id']},'data':{'currentPayments':_0x4fda72,'status':_0x84a85c,'updatedAt':new Date()}}),console[_0x19baaa(0x216)](_0x19baaa(0x21b)+_0xcf14df['id']+_0x19baaa(0x20b)+_0xcf14df[_0x19baaa(0x1d1)]+'\x20->\x20'+_0x4fda72+_0x19baaa(0x1b5)+_0xcf14df[_0x19baaa(0x1e3)]+'\x20->\x20'+_0x84a85c);}catch(_0x5b610c){console[_0x19baaa(0x1d2)](_0x19baaa(0x243),_0x5b610c);}else console[_0x19baaa(0x216)](_0x19baaa(0x17f)+_0x34cb17['id']+_0x19baaa(0x273));}await database_1['default'][_0x19baaa(0x194)][_0x19baaa(0x260)]({'data':{'paymentId':_0x34cb17['id'],'shopId':_0x34cb17[_0x19baaa(0x25a)],'event':'cointopay_status_check_'+_0x487d0b[_0x19baaa(0x1e3)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x34cb17[_0x19baaa(0x1e3)],'newStatus':_0x487d0b[_0x19baaa(0x1e3)],'paymentDetails':_0x487d0b[_0x19baaa(0x26d)],'checkedAt':new Date()[_0x19baaa(0x26b)]()})}}),await this[_0x19baaa(0x1e1)](_0x34cb17,_0x487d0b['status']),await this['sendPaymentStatusNotification'](_0x34cb17,_0x487d0b[_0x19baaa(0x1e3)]),_0x487d0b[_0x19baaa(0x1e3)]!=='PENDING'&&(console['log']('🧹\x20[CHECK]\x20Payment\x20'+_0x34cb17['id']+_0x19baaa(0x205)+_0x487d0b['status']+_0x19baaa(0x278)),this['clearPaymentTimers'](_0x34cb17['id'])),console[_0x19baaa(0x216)](_0x19baaa(0x1c9)+_0x34cb17['id']+'\x20updated\x20successfully');}else console[_0x19baaa(0x216)](_0x19baaa(0x169)+_0x34cb17['id']+_0x19baaa(0x20c)+_0x487d0b[_0x19baaa(0x1e3)]+')'),this[_0x19baaa(0x19c)](_0x34cb17['id'],_0x34cb17[_0x19baaa(0x21a)],_0x34cb17['status'],_0x487d0b[_0x19baaa(0x1e3)],_0x19baaa(0x215),{'statusUnchanged':!![],'paymentDetails':_0x487d0b[_0x19baaa(0x26d)],'amount':_0x487d0b[_0x19baaa(0x180)],'currency':_0x487d0b[_0x19baaa(0x22a)],'shopId':_0x34cb17[_0x19baaa(0x25a)],'checkTimestamp':new Date()['toISOString']()});}catch(_0xd6c82){console[_0x19baaa(0x1d2)](_0x19baaa(0x222)+_0x34cb17['id']+':',_0xd6c82),this['logCoinToPayError'](_0x34cb17['id'],_0x34cb17[_0x19baaa(0x21a)],_0xd6c82,_0x19baaa(0x215),{'paymentAmount':_0x34cb17[_0x19baaa(0x180)],'paymentCurrency':_0x34cb17[_0x19baaa(0x22a)],'shopId':_0x34cb17[_0x19baaa(0x25a)],'createdAt':_0x34cb17[_0x19baaa(0x22f)]}),await database_1[_0x19baaa(0x1f4)][_0x19baaa(0x194)][_0x19baaa(0x260)]({'data':{'paymentId':_0x34cb17['id'],'shopId':_0x34cb17[_0x19baaa(0x25a)],'event':_0x19baaa(0x1b8),'statusCode':0x1f4,'responseBody':JSON[_0x19baaa(0x258)]({'error':_0xd6c82 instanceof Error?_0xd6c82['message']:_0x19baaa(0x191),'gatewayPaymentId':_0x34cb17[_0x19baaa(0x21a)],'checkedAt':new Date()['toISOString']()})}});}}async[a38_0x284263(0x1e1)](_0x4300b8,_0x30a906){const _0x5d75a0=a38_0x284263,_0x13704a=Date[_0x5d75a0(0x236)]();try{const _0x13e36b=_0x4300b8[_0x5d75a0(0x1da)],_0x3a3a93=_0x13e36b[_0x5d75a0(0x172)];if(!_0x3a3a93?.['webhookUrl']){console[_0x5d75a0(0x216)](_0x5d75a0(0x1fe)+_0x13e36b['id']);return;}const _0x1cf536=_0x30a906===_0x5d75a0(0x264)?_0x5d75a0(0x1ba):_0x30a906===_0x5d75a0(0x1f3)?_0x5d75a0(0x232):_0x30a906===_0x5d75a0(0x220)?_0x5d75a0(0x232):_0x5d75a0(0x235);if(!_0x3a3a93[_0x5d75a0(0x27a)]?.[_0x5d75a0(0x199)](_0x1cf536)){console[_0x5d75a0(0x216)](_0x5d75a0(0x242)+_0x1cf536+_0x5d75a0(0x175)+_0x13e36b['id']);return;}const _0x4424a2=(0x0,gateway_1['getGatewayIdByName'])(_0x4300b8[_0x5d75a0(0x22b)])||_0x4300b8[_0x5d75a0(0x22b)],_0x52401c={'event':_0x1cf536,'payment':{'id':_0x4300b8['id'],'order_id':_0x4300b8[_0x5d75a0(0x1d8)],'gateway_order_id':_0x4300b8[_0x5d75a0(0x24a)],'gateway':_0x4424a2,'amount':_0x4300b8[_0x5d75a0(0x180)],'currency':_0x4300b8[_0x5d75a0(0x22a)],'status':_0x30a906[_0x5d75a0(0x15f)](),'customer_email':_0x4300b8[_0x5d75a0(0x189)],'customer_name':_0x4300b8[_0x5d75a0(0x206)],'created_at':_0x4300b8['createdAt'],'updated_at':new Date()}},_0x425b8c=await fetch(_0x3a3a93[_0x5d75a0(0x1be)],{'method':'POST','headers':{'Content-Type':_0x5d75a0(0x161),'User-Agent':_0x5d75a0(0x1af)},'body':JSON[_0x5d75a0(0x258)](_0x52401c)}),_0x47bec0=Date[_0x5d75a0(0x236)]()-_0x13704a,_0x53e86d=_0x425b8c['ok']?_0x5d75a0(0x270):await _0x425b8c[_0x5d75a0(0x1b9)]();loggerService_1[_0x5d75a0(0x18a)][_0x5d75a0(0x203)](_0x4300b8[_0x5d75a0(0x25a)],_0x3a3a93[_0x5d75a0(0x1be)],_0x1cf536,_0x425b8c['status'],_0x47bec0,_0x52401c),console[_0x5d75a0(0x216)](_0x5d75a0(0x16c)+_0x3a3a93[_0x5d75a0(0x1be)]+_0x5d75a0(0x1e0)+_0x425b8c[_0x5d75a0(0x1e3)]+'\x20('+_0x47bec0+'ms)');}catch(_0x548958){console[_0x5d75a0(0x1d2)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x548958),loggerService_1[_0x5d75a0(0x18a)][_0x5d75a0(0x163)](_0x4300b8[_0x5d75a0(0x25a)],_0x4300b8['shop']?.[_0x5d75a0(0x172)]?.[_0x5d75a0(0x1be)]||_0x5d75a0(0x1a6),_0x5d75a0(0x1cc),_0x548958,{});}}async[a38_0x284263(0x240)](_0x35cda6,_0x17dc57){const _0x38036e=a38_0x284263;try{const _0x33bd81={'PENDING':_0x38036e(0x1fc),'PAID':_0x38036e(0x1a3),'FAILED':'failed','EXPIRED':_0x38036e(0x1f9)},_0x53bf0c=_0x33bd81[_0x17dc57];if(!_0x53bf0c||_0x53bf0c===_0x38036e(0x1fc))return;await telegramBotService_1[_0x38036e(0x257)]['sendPaymentNotification'](_0x35cda6[_0x38036e(0x25a)],_0x35cda6,_0x53bf0c);}catch(_0x578057){console['error'](_0x38036e(0x221),_0x578057);}}async[a38_0x284263(0x246)](_0x2f101e){const _0x546e0e=a38_0x284263;console[_0x546e0e(0x216)](_0x546e0e(0x1ef)+_0x2f101e);const _0x26c6a8=await database_1['default'][_0x546e0e(0x241)][_0x546e0e(0x184)]({'where':{'id':_0x2f101e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x26c6a8)throw new Error(_0x546e0e(0x1c1));if(_0x26c6a8['gateway']!==_0x546e0e(0x18b)&&_0x26c6a8[_0x546e0e(0x22b)]!==_0x546e0e(0x198))throw new Error(_0x546e0e(0x255));console['log'](_0x546e0e(0x24d)+_0x26c6a8['gateway']+_0x546e0e(0x193)+_0x2f101e),await this[_0x546e0e(0x1c5)](_0x26c6a8),console['log'](_0x546e0e(0x20e)+_0x2f101e);}['getServiceStats'](){const _0x212734=a38_0x284263,_0x51d5b3=this[_0x212734(0x1b7)]?this[_0x212734(0x272)]:undefined,_0x1f9800=Array[_0x212734(0x24e)](this[_0x212734(0x1a5)][_0x212734(0x275)]())[_0x212734(0x227)](_0x4a816a=>({'paymentId':_0x4a816a[_0x212734(0x1c0)],'gatewayPaymentId':_0x4a816a['gatewayPaymentId'],'createdAt':_0x4a816a[_0x212734(0x22f)],'timersCount':_0x4a816a['timers'][_0x212734(0x253)]}));return{'isActive':!!this[_0x212734(0x1b7)],'globalCheckIntervalMinutes':this[_0x212734(0x272)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x212734(0x1a5)][_0x212734(0x219)],'nextGlobalCheckIn':_0x51d5b3,'paymentTimersDetails':_0x1f9800};}['getPaymentTimerInfo'](_0xedcf6d){const _0x16c06c=a38_0x284263,_0x2cd003=this['paymentTimers'][_0x16c06c(0x1b2)](_0xedcf6d);if(_0x2cd003)return{'hasTimers':!![],'timersCount':_0x2cd003[_0x16c06c(0x171)][_0x16c06c(0x253)],'createdAt':_0x2cd003[_0x16c06c(0x22f)],'gatewayPaymentId':_0x2cd003[_0x16c06c(0x21a)]};return{'hasTimers':![]};}async[a38_0x284263(0x261)](_0x553003,_0x10e703){const _0x1e5cc0=a38_0x284263;try{const _0x4110a3=await database_1[_0x1e5cc0(0x1f4)][_0x1e5cc0(0x1da)][_0x1e5cc0(0x184)]({'where':{'id':_0x553003},'select':{'gatewaySettings':!![]}});if(!_0x4110a3?.[_0x1e5cc0(0x1f7)])return console['log'](_0x1e5cc0(0x26a)+_0x553003+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x3d8cd8=JSON[_0x1e5cc0(0x182)](_0x4110a3[_0x1e5cc0(0x1f7)]);for(const [_0x56137a,_0x5610d9]of Object['entries'](_0x3d8cd8)){if(_0x56137a[_0x1e5cc0(0x15f)]()===_0x10e703[_0x1e5cc0(0x15f)]()){const _0x5a3292=_0x5610d9[_0x1e5cc0(0x1de)]||0xa;return console[_0x1e5cc0(0x216)]('Gateway\x20'+_0x10e703+_0x1e5cc0(0x1a7)+_0x553003+':\x20'+_0x5a3292+'%'),_0x5a3292;}}return console[_0x1e5cc0(0x216)](_0x1e5cc0(0x1ed)+_0x10e703+_0x1e5cc0(0x1dd)+_0x553003+_0x1e5cc0(0x238)),0xa;}catch(_0x480fca){return console[_0x1e5cc0(0x1d2)](_0x1e5cc0(0x1a0)+_0x553003+_0x1e5cc0(0x19b)+_0x10e703+':',_0x480fca),0xa;}}}exports[a38_0x284263(0x190)]=CoinToPayStatusService,exports[a38_0x284263(0x25f)]=new CoinToPayStatusService();