'use strict';const a37_0xa016fe=a37_0x4584;(function(_0x5d02bb,_0x490bcf){const _0x13882b=a37_0x4584,_0x1d6806=_0x5d02bb();while(!![]){try{const _0x30ea04=-parseInt(_0x13882b(0x127))/0x1*(-parseInt(_0x13882b(0xe5))/0x2)+-parseInt(_0x13882b(0xf3))/0x3*(-parseInt(_0x13882b(0xb3))/0x4)+-parseInt(_0x13882b(0xf8))/0x5*(parseInt(_0x13882b(0xba))/0x6)+-parseInt(_0x13882b(0x12b))/0x7+-parseInt(_0x13882b(0x114))/0x8*(-parseInt(_0x13882b(0xad))/0x9)+-parseInt(_0x13882b(0xd8))/0xa+parseInt(_0x13882b(0x11f))/0xb;if(_0x30ea04===_0x490bcf)break;else _0x1d6806['push'](_0x1d6806['shift']());}catch(_0x105872){_0x1d6806['push'](_0x1d6806['shift']());}}}(a37_0x4eec,0x4a46d));var __importDefault=this&&this[a37_0xa016fe(0x100)]||function(_0xb39ece){const _0x17af14=a37_0xa016fe;return _0xb39ece&&_0xb39ece[_0x17af14(0xf5)]?_0xb39ece:{'default':_0xb39ece};};Object[a37_0xa016fe(0xb5)](exports,'__esModule',{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0xa016fe(0x123)]=void 0x0;function a37_0x4584(_0x2423a5,_0x321f1e){const _0x4eecf6=a37_0x4eec();return a37_0x4584=function(_0x4584d3,_0x5ea159){_0x4584d3=_0x4584d3-0x70;let _0x733422=_0x4eecf6[_0x4584d3];return _0x733422;},a37_0x4584(_0x2423a5,_0x321f1e);}const coinToPayService_1=require(a37_0xa016fe(0x104)),database_1=__importDefault(require(a37_0xa016fe(0xb4))),telegramBotService_1=require(a37_0xa016fe(0xff)),loggerService_1=require('./loggerService');function a37_0x4eec(){const _0x4a328f=['Failed\x20to\x20send\x20shop\x20webhook:','\x20current\x20status:\x20','./telegramBotService','__importDefault','startPeriodicStatusCheck','.\x20Remaining\x20active\x20timers:\x20','create','./gateways/coinToPayService','\x20(age:\x20','🪙\x20CoinToPayStatusService\x20initialized','getTime','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','logWhiteDomainError','checkExpiredPayments','✅\x20[HOURLY]\x20Payment\x20','Webhook\x20event\x20','\x20status\x20is\x20','Payment\x20older\x20than\x20','\x20checked,\x20','cointopay_status_check_error','\x20\x20\x20-\x20paymentId:\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','🧹\x20[DEBUG]\x20Clearing\x20','4744nMtYZU','\x20\x20\x20-\x20gatewayPaymentId:\x20','schedule_created','webhook_send','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','EXPIRY_DAYS','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20triggered\x20for\x20payment\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','✅\x20[EXPIRY]\x20Payment\x20','\x20\x20\x20❌\x20Error:\x20','10560583fqWyrm','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','logShopWebhookError','timestamp','CoinToPayStatusService','getServiceStats','💰\x20[CHECK]\x20Payment\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','26935PRcAhy','\x20\x20\x20📍\x20Source:\x20','confirmedOn','clearPaymentTimers','1375437KJYjid','createdAt','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','createdOn','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','⏰\x20[GLOBAL]\x20Payment\x20','\x20status\x20changed\x20to\x20','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','GLOBAL_CHECK_INTERVAL_MS','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','checkSinglePaymentById','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20\x20\x20-\x20ShopId:\x20','\x20\x20\x20-\x20Amount:\x20','webhookLog','findUnique','catch','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','getPaymentTimerInfo','⚠️\x20[CHECK]\x20Payment\x20','\x20days','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','1\x20minute','\x20has\x20no\x20gatewayPaymentId','Shop\x20webhook\x20sent\x20to\x20','\x20\x20\x20-\x20Gateway:\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20status\x20unchanged\x20(','forEach','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','logCoinToPayStatus','\x20details:','EXPIRED','includes','\x20\x20\x20📝\x20Context:','paidAt','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20->\x20','2\x20minutes','checkSinglePayment','bankDetails','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','paid','set',',\x20clearing\x20individual\x20timers','payment.pending','paymentTimers','\x20has\x20no\x20gatewayPaymentId,\x20skipping','CoinToPayService','map','toLowerCase','cointopay_status_check_','\x20\x20\x20📝\x20Details:','floor','\x20days\x20without\x20payment\x20confirmation','\x20expired','stopPeriodicStatusCheck','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','sendShopWebhook','status_check','timers','settings','failed','⏰\x20[HOURLY]\x20Payment\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','h),\x20skipping\x20global\x20check','⏰\x20[GLOBAL]\x20Found\x20','gatewayPaymentId','🪙\x20[TIMER]\x20Individual\x20check\x20#','✅\x20[CHECK]\x20Payment\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','toISOString','values','payment','\x20\x20\x20📅\x20Time:\x20','📊\x20[CHECK]\x20Payment\x20','setDate','transactionId','gateway','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20updated\x20successfully',',\x20stopping\x20individual\x20checks','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','webhookUrl','\x20is\x20too\x20new\x20(','push','amount','logCoinToPayError','COINTOPAY_STATUS_CHANGE','paymentDetails','text','logShopWebhookSent','stringify','\x20initial\x20timers\x20for\x20payment\x20','PENDING','POST','length','\x20(after\x20','Payment\x20not\x20found','Unknown\x20error','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','status','774rFvvTI','description','\x20completed\x20for\x20payment\x20','payment.success','🛑\x20[SHUTDOWN]\x20Cleared\x20','toFixed','4gsLiVr','../config/database','defineProperty','\x20expired\x20CoinToPay\x20payments','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20marked\x20as\x20paid\x20at:\x20','📊\x20[HOURLY]\x20Payment\x20','13242djZgxW','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','sendPaymentNotification','\x20not\x20enabled\x20for\x20shop\x20','schedulePaymentChecks','coinToPayService','adminNotes','checkAllPendingPayments','\x20not\x20found\x20in\x20database','iban','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','globalCheckInterval','loggerService','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','5\x20minutes','cointopay','\x20individual\x20payment\x20timers','log','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','🧹\x20[CHECK]\x20Payment\x20','size','\x20with\x20status\x20','payment.failed','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','unknown','⏰\x20[EXPIRY]\x20Payment\x20','\x20for\x20payment\x20','default','paymentId','5585870tlJfrR','sendPaymentStatusNotification','coinToPayStatusService','delay','delete','has','0100','🪙\x20[DEBUG]\x20Creating\x20','error','🪙\x20[GLOBAL]\x20Found\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','ms)','/status/','32dzsvKJ','message','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','shopId','created','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','not\x20confirmed','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','auto_expire','PAID','customerEmail','❌\x20[HOURLY]\x20Payment\x20','now','update','103281RtpstE','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','__esModule','-day\x20timeout','currency','945ZlfAyi','\x20status:\x20','TesSoft\x20Payment\x20System/1.0','\x20\x20\x20-\x20GatewayPaymentId:\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20'];a37_0x4eec=function(){return _0x4a328f;};return a37_0x4eec();}class CoinToPayStatusService{constructor(){const _0x234331=a37_0xa016fe;this[_0x234331(0xc5)]=null,this[_0x234331(0x133)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this['paymentTimers']=new Map(),this[_0x234331(0xbf)]=new coinToPayService_1[(_0x234331(0x75))](),console['log'](_0x234331(0x106));}[a37_0xa016fe(0xbe)](_0x1ca38c,_0x770d20){const _0x2b0105=a37_0xa016fe;console[_0x2b0105(0xcb)](_0x2b0105(0x134)),console[_0x2b0105(0xcb)](_0x2b0105(0x111)+_0x1ca38c),console[_0x2b0105(0xcb)](_0x2b0105(0x115)+_0x770d20),this[_0x2b0105(0x12a)](_0x1ca38c);const _0x188179=[],_0x214230=new Date(),_0x27dca7=[{'delay':0x1*0x3c*0x3e8,'description':_0x2b0105(0x141)},{'delay':0x2*0x3c*0x3e8,'description':_0x2b0105(0x151)},{'delay':0x5*0x3c*0x3e8,'description':_0x2b0105(0xc8)},{'delay':0x5*0x3c*0x3e8,'description':_0x2b0105(0xc8)}];console[_0x2b0105(0xcb)](_0x2b0105(0xdf)+_0x27dca7['length']+_0x2b0105(0xa3)+_0x1ca38c);let _0x2a1420=0x0;_0x27dca7[_0x2b0105(0x147)]((_0x105b83,_0x55568a)=>{const _0x39e816=_0x2b0105;_0x2a1420+=_0x105b83[_0x39e816(0xdb)];const _0x3af90c=setTimeout(async()=>{const _0x162453=_0x39e816;console[_0x162453(0xcb)](_0x162453(0x8a)+(_0x55568a+0x1)+_0x162453(0x11b)+_0x1ca38c+_0x162453(0xa7)+_0x105b83[_0x162453(0xae)]+')');try{await this[_0x162453(0x135)](_0x1ca38c),console[_0x162453(0xcb)](_0x162453(0x155)+(_0x55568a+0x1)+_0x162453(0xaf)+_0x1ca38c);}catch(_0x456cbd){console[_0x162453(0xe0)](_0x162453(0xea)+(_0x55568a+0x1)+_0x162453(0xd5)+_0x1ca38c+':',_0x456cbd),this[_0x162453(0x9d)](_0x1ca38c,_0x770d20,_0x456cbd,'status_check',{'checkNumber':_0x55568a+0x1,'scheduledAfter':_0x105b83[_0x162453(0xae)],'isIndividualCheck':!![]});}},_0x2a1420);_0x188179[_0x39e816(0x9b)](_0x3af90c),console[_0x39e816(0xcb)](_0x39e816(0xcc)+(_0x55568a+0x1)+_0x39e816(0xd5)+_0x1ca38c+'\x20in\x20'+_0x2a1420/0x3e8+'\x20seconds\x20('+_0x105b83['description']+')');});const _0x173d0d=setInterval(async()=>{const _0x575140=_0x2b0105;console['log'](_0x575140(0x118)+_0x1ca38c);try{const _0x19695b=await database_1[_0x575140(0xd6)][_0x575140(0x8f)][_0x575140(0x13a)]({'where':{'id':_0x1ca38c},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x19695b){console[_0x575140(0xcb)](_0x575140(0xf0)+_0x1ca38c+'\x20not\x20found,\x20clearing\x20timers'),this['clearPaymentTimers'](_0x1ca38c);return;}console[_0x575140(0xcb)](_0x575140(0xb9)+_0x1ca38c+_0x575140(0xfe)+_0x19695b[_0x575140(0xac)]);if(_0x19695b[_0x575140(0xac)]!==_0x575140(0xa4)){console[_0x575140(0xcb)](_0x575140(0x10b)+_0x1ca38c+_0x575140(0x10d)+_0x19695b[_0x575140(0xac)]+_0x575140(0x97)),this[_0x575140(0x12a)](_0x1ca38c);return;}const _0x313890=Math['floor']((Date[_0x575140(0xf1)]()-_0x19695b['createdAt'][_0x575140(0x107)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x313890>=this[_0x575140(0x119)]){console['log'](_0x575140(0x85)+_0x1ca38c+'\x20is\x20older\x20than\x20'+this[_0x575140(0x119)]+_0x575140(0x145)),this[_0x575140(0x12a)](_0x1ca38c);return;}await this[_0x575140(0x135)](_0x1ca38c),console[_0x575140(0xcb)](_0x575140(0xc7)+_0x1ca38c);}catch(_0x4b2dc7){console[_0x575140(0xe0)](_0x575140(0x7f)+_0x1ca38c+':',_0x4b2dc7),this['logCoinToPayError'](_0x1ca38c,_0x770d20,_0x4b2dc7,_0x575140(0x81),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x188179['push'](_0x173d0d),this['paymentTimers'][_0x2b0105(0x70)](_0x1ca38c,{'timers':_0x188179,'paymentId':_0x1ca38c,'gatewayPaymentId':_0x770d20,'createdAt':_0x214230}),console[_0x2b0105(0xcb)](_0x2b0105(0xec)+_0x27dca7['length']+_0x2b0105(0x108)+_0x1ca38c),console['log']('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this['paymentTimers'][_0x2b0105(0xce)]),this['logCoinToPayStatus'](_0x1ca38c,_0x770d20,_0x2b0105(0xa4),_0x2b0105(0xa4),_0x2b0105(0x81),{'action':_0x2b0105(0x116),'scheduledChecks':_0x27dca7[_0x2b0105(0xa6)],'firstCheckIn':_0x27dca7[0x0][_0x2b0105(0xdb)]/0x3e8,'totalTimers':this[_0x2b0105(0x73)][_0x2b0105(0xce)]});}[a37_0xa016fe(0x12a)](_0x35ea23){const _0x12074a=a37_0xa016fe,_0x2bed24=this[_0x12074a(0x73)]['get'](_0x35ea23);_0x2bed24?(console[_0x12074a(0xcb)](_0x12074a(0x113)+_0x2bed24[_0x12074a(0x82)][_0x12074a(0xa6)]+'\x20timers\x20for\x20payment\x20'+_0x35ea23),_0x2bed24['timers'][_0x12074a(0x147)]((_0x522bc8,_0x3bddd9)=>{const _0x1d4390=_0x12074a;_0x522bc8&&(clearTimeout(_0x522bc8),clearInterval(_0x522bc8),console['log']('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x3bddd9+0x1)+_0x1d4390(0xd5)+_0x35ea23));}),this[_0x12074a(0x73)][_0x12074a(0xdc)](_0x35ea23),console['log']('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x35ea23+_0x12074a(0x102)+this[_0x12074a(0x73)][_0x12074a(0xce)])):console[_0x12074a(0xcb)](_0x12074a(0x8c)+_0x35ea23+'\x20to\x20clear');}async[a37_0xa016fe(0x135)](_0x3c6fd1){const _0x5f93a3=a37_0xa016fe;console[_0x5f93a3(0xcb)](_0x5f93a3(0x120)+_0x3c6fd1);const _0x243d45=await database_1[_0x5f93a3(0xd6)][_0x5f93a3(0x8f)][_0x5f93a3(0x13a)]({'where':{'id':_0x3c6fd1},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x243d45){console[_0x5f93a3(0xcb)]('❌\x20[CHECK]\x20Payment\x20'+_0x3c6fd1+_0x5f93a3(0xc2));return;}console[_0x5f93a3(0xcb)](_0x5f93a3(0x91)+_0x3c6fd1+'\x20found:'),console[_0x5f93a3(0xcb)](_0x5f93a3(0x144)+_0x243d45[_0x5f93a3(0x94)]),console['log']('\x20\x20\x20-\x20Status:\x20'+_0x243d45[_0x5f93a3(0xac)]),console[_0x5f93a3(0xcb)](_0x5f93a3(0xfb)+_0x243d45[_0x5f93a3(0x89)]),console[_0x5f93a3(0xcb)](_0x5f93a3(0x138)+_0x243d45[_0x5f93a3(0x9c)]+'\x20'+_0x243d45[_0x5f93a3(0xf7)]),console[_0x5f93a3(0xcb)](_0x5f93a3(0x137)+_0x243d45[_0x5f93a3(0xe8)]);if(_0x243d45['gateway']!=='cointopay'){console[_0x5f93a3(0xcb)](_0x5f93a3(0x13e)+_0x3c6fd1+_0x5f93a3(0xab)+_0x243d45['gateway']+')');return;}if(_0x243d45['status']!=='PENDING'){console[_0x5f93a3(0xcb)](_0x5f93a3(0x13e)+_0x3c6fd1+'\x20status\x20is\x20'+_0x243d45['status']+_0x5f93a3(0x97)),this[_0x5f93a3(0x12a)](_0x3c6fd1);return;}if(!_0x243d45['gatewayPaymentId']){console[_0x5f93a3(0xcb)](_0x5f93a3(0x13e)+_0x3c6fd1+_0x5f93a3(0x142));return;}console[_0x5f93a3(0xcb)](_0x5f93a3(0x8b)+_0x3c6fd1+_0x5f93a3(0xe2)),await this['checkSinglePayment'](_0x243d45);}[a37_0xa016fe(0x149)](_0x1bde8e,_0xd14031,_0x155e68,_0x9aea7c,_0x5cbc4b,_0x1ac899){const _0x13422e=a37_0xa016fe,_0x481338={'type':_0x13422e(0x9e),'paymentId':_0x1bde8e,'gatewayPaymentId':_0xd14031,'oldStatus':_0x155e68,'newStatus':_0x9aea7c,'source':_0x5cbc4b,'timestamp':new Date()[_0x13422e(0x8d)](),'details':_0x1ac899||{}};loggerService_1[_0x13422e(0xc6)][_0x13422e(0x149)](_0x481338),console['log'](_0x13422e(0x7e)+_0x1bde8e+'\x20('+_0xd14031+')'),console[_0x13422e(0xcb)]('\x20\x20\x20📊\x20Status:\x20'+_0x155e68+_0x13422e(0x150)+_0x9aea7c),console[_0x13422e(0xcb)]('\x20\x20\x20📍\x20Source:\x20'+_0x5cbc4b),console[_0x13422e(0xcb)](_0x13422e(0x90)+_0x481338[_0x13422e(0x122)]),_0x1ac899&&console[_0x13422e(0xcb)](_0x13422e(0x79),_0x1ac899);}['logCoinToPayError'](_0x13e3bc,_0x23354d,_0x4d9c47,_0x215c2d,_0x5c1815){const _0x2ea89f=a37_0xa016fe,_0x2e77cd={'type':'COINTOPAY_ERROR','paymentId':_0x13e3bc,'gatewayPaymentId':_0x23354d,'error':_0x4d9c47 instanceof Error?{'message':_0x4d9c47[_0x2ea89f(0xe6)],'stack':_0x4d9c47['stack']}:_0x4d9c47,'source':_0x215c2d,'timestamp':new Date()['toISOString'](),'context':_0x5c1815||{}};loggerService_1[_0x2ea89f(0xc6)][_0x2ea89f(0x9d)](_0x2e77cd),console['error'](_0x2ea89f(0x136)+_0x13e3bc+'\x20('+_0x23354d+')'),console['error'](_0x2ea89f(0x11e)+(_0x4d9c47 instanceof Error?_0x4d9c47['message']:_0x4d9c47)),console[_0x2ea89f(0xe0)](_0x2ea89f(0x128)+_0x215c2d),console[_0x2ea89f(0xe0)](_0x2ea89f(0x90)+_0x2e77cd[_0x2ea89f(0x122)]),_0x5c1815&&console[_0x2ea89f(0xe0)](_0x2ea89f(0x14d),_0x5c1815);}[a37_0xa016fe(0x101)](){const _0xd34f=a37_0xa016fe;console[_0xd34f(0xcb)]('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0xd34f(0xc1)]()[_0xd34f(0x13b)](_0x4e0ab5=>{console['error']('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x4e0ab5);}),this['globalCheckInterval']=setInterval(async()=>{const _0x2e4eba=_0xd34f;try{console['log']('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x2e4eba(0xc1)](),console[_0x2e4eba(0xcb)](_0x2e4eba(0x12d));}catch(_0x298feb){console[_0x2e4eba(0xe0)](_0x2e4eba(0xaa),_0x298feb);}},this[_0xd34f(0x133)]),console[_0xd34f(0xcb)](_0xd34f(0xf4));}[a37_0xa016fe(0x7d)](){const _0x219a8a=a37_0xa016fe;console['log'](_0x219a8a(0x126));this[_0x219a8a(0xc5)]&&(clearInterval(this[_0x219a8a(0xc5)]),this[_0x219a8a(0xc5)]=null,console['log']('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x4aef14=this[_0x219a8a(0x73)]['size'];for(const [_0xc1a1f6]of this['paymentTimers']){this[_0x219a8a(0x12a)](_0xc1a1f6);}console[_0x219a8a(0xcb)](_0x219a8a(0xb1)+_0x4aef14+_0x219a8a(0xca));}async[a37_0xa016fe(0xc1)](){const _0x560afb=a37_0xa016fe;try{console[_0x560afb(0xcb)](_0x560afb(0x86));const _0x43b10f=await database_1[_0x560afb(0xd6)][_0x560afb(0x8f)]['findMany']({'where':{'gateway':_0x560afb(0xc9),'status':_0x560afb(0xa4),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x560afb(0xcb)](_0x560afb(0xe1)+_0x43b10f['length']+'\x20pending\x20CoinToPay\x20payments');if(_0x43b10f[_0x560afb(0xa6)]===0x0){console[_0x560afb(0xcb)](_0x560afb(0x11c));return;}const _0x426524=await this[_0x560afb(0x10a)](_0x43b10f);console[_0x560afb(0xcb)](_0x560afb(0x88)+_0x426524['length']+_0x560afb(0xb6));let _0x16e9b4=0x0,_0x55c091=0x0;for(const _0x48a826 of _0x43b10f){try{if(_0x426524[_0x560afb(0x14c)](_0x48a826['id'])){console['log'](_0x560afb(0x130)+_0x48a826['id']+_0x560afb(0x14f)),_0x55c091++;continue;}if(this[_0x560afb(0x73)][_0x560afb(0xdd)](_0x48a826['id'])){console[_0x560afb(0xcb)](_0x560afb(0x130)+_0x48a826['id']+_0x560afb(0x12f)),_0x55c091++;continue;}const _0xfb51ed=(Date[_0x560afb(0xf1)]()-_0x48a826[_0x560afb(0x12c)][_0x560afb(0x107)]())/(0x3e8*0x3c*0x3c);if(_0xfb51ed<0x1){console[_0x560afb(0xcb)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x48a826['id']+_0x560afb(0x9a)+_0xfb51ed[_0x560afb(0xb2)](0x1)+_0x560afb(0x87)),_0x55c091++;continue;}console[_0x560afb(0xcb)](_0x560afb(0xd1)+_0x48a826['id']+_0x560afb(0x105)+_0xfb51ed['toFixed'](0x1)+'h)'),await this[_0x560afb(0x152)](_0x48a826),_0x16e9b4++,await new Promise(_0x2f0311=>setTimeout(_0x2f0311,0x7d0));}catch(_0x4ba202){console[_0x560afb(0xe0)](_0x560afb(0xd2)+_0x48a826['id']+':',_0x4ba202),this[_0x560afb(0x9d)](_0x48a826['id'],_0x48a826[_0x560afb(0x89)]||_0x560afb(0xd3),_0x4ba202,_0x560afb(0x81),{'isGlobalCheck':!![],'paymentAmount':_0x48a826[_0x560afb(0x9c)],'paymentCurrency':_0x48a826[_0x560afb(0xf7)],'shopId':_0x48a826[_0x560afb(0xe8)],'createdAt':_0x48a826[_0x560afb(0x12c)]}),loggerService_1[_0x560afb(0xc6)][_0x560afb(0x109)](_0x560afb(0xc9),_0x560afb(0xe4)+_0x48a826[_0x560afb(0x89)],_0x4ba202);}}console[_0x560afb(0xcb)]('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x16e9b4+_0x560afb(0x10f)+_0x55c091+'\x20skipped,\x20'+_0x426524[_0x560afb(0xa6)]+_0x560afb(0x7c));}catch(_0x5d046b){console[_0x560afb(0xe0)](_0x560afb(0xbb),_0x5d046b);}}async['checkExpiredPayments'](_0x34c9ee){const _0x5db074=a37_0xa016fe,_0x2baea0=[],_0x21b6a0=new Date();_0x21b6a0[_0x5db074(0x92)](_0x21b6a0['getDate']()-this[_0x5db074(0x119)]),console[_0x5db074(0xcb)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x5db074(0x119)]+'\x20days\x20(created\x20before\x20'+_0x21b6a0['toISOString']()+')');for(const _0x19b835 of _0x34c9ee){if(_0x19b835[_0x5db074(0x12c)]<_0x21b6a0){console[_0x5db074(0xcb)](_0x5db074(0xd4)+_0x19b835['id']+'\x20is\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x5db074(0x149)](_0x19b835['id'],_0x19b835['gatewayPaymentId']||_0x5db074(0xd3),'PENDING',_0x5db074(0x14b),_0x5db074(0xed),{'reason':_0x5db074(0x10e)+this['EXPIRY_DAYS']+_0x5db074(0x13f),'createdAt':_0x19b835[_0x5db074(0x12c)],'daysSinceCreation':Math['floor']((Date['now']()-_0x19b835[_0x5db074(0x12c)][_0x5db074(0x107)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x19b835['amount'],'paymentCurrency':_0x19b835[_0x5db074(0xf7)],'shopId':_0x19b835['shopId']}),await database_1[_0x5db074(0xd6)][_0x5db074(0x8f)]['update']({'where':{'id':_0x19b835['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x5db074(0x119)]+_0x5db074(0x7b)}}),await database_1[_0x5db074(0xd6)][_0x5db074(0x139)][_0x5db074(0x103)]({'data':{'paymentId':_0x19b835['id'],'shopId':_0x19b835[_0x5db074(0xe8)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x5db074(0xa2)]({'reason':'Payment\x20older\x20than\x20'+this[_0x5db074(0x119)]+'\x20days','createdAt':_0x19b835[_0x5db074(0x12c)],'expiredAt':new Date()[_0x5db074(0x8d)](),'daysSinceCreation':Math['floor']((Date[_0x5db074(0xf1)]()-_0x19b835[_0x5db074(0x12c)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x5db074(0x80)](_0x19b835,'EXPIRED'),await this[_0x5db074(0xd9)](_0x19b835,'EXPIRED'),this[_0x5db074(0x12a)](_0x19b835['id']),_0x2baea0[_0x5db074(0x9b)](_0x19b835['id']),console[_0x5db074(0xcb)](_0x5db074(0x11d)+_0x19b835['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x5db074(0x119)]+_0x5db074(0xf6));}catch(_0x4a0932){console[_0x5db074(0xe0)](_0x5db074(0x132)+_0x19b835['id']+':',_0x4a0932),this[_0x5db074(0x9d)](_0x19b835['id'],_0x19b835['gatewayPaymentId']||_0x5db074(0xd3),_0x4a0932,_0x5db074(0xed),{'reason':_0x5db074(0x112),'createdAt':_0x19b835[_0x5db074(0x12c)],'daysSinceCreation':Math[_0x5db074(0x7a)]((Date['now']()-_0x19b835['createdAt'][_0x5db074(0x107)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x2baea0;}async[a37_0xa016fe(0x152)](_0x15b03c){const _0x1b1dfe=a37_0xa016fe;if(!_0x15b03c[_0x1b1dfe(0x89)]){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x15b03c['id']+_0x1b1dfe(0x74));return;}console['log'](_0x1b1dfe(0xc4)+_0x15b03c['id']+'\x20('+_0x15b03c[_0x1b1dfe(0x89)]+')');try{const _0x14f241=await this[_0x1b1dfe(0xbf)]['checkPaymentStatus'](_0x15b03c[_0x1b1dfe(0x89)]);console[_0x1b1dfe(0xcb)](_0x1b1dfe(0x91)+_0x15b03c['id']+_0x1b1dfe(0xf9)+_0x14f241[_0x1b1dfe(0xac)]);_0x14f241[_0x1b1dfe(0x9f)]&&console[_0x1b1dfe(0xcb)](_0x1b1dfe(0x91)+_0x15b03c['id']+_0x1b1dfe(0x14a),{'iban':_0x14f241[_0x1b1dfe(0x9f)][_0x1b1dfe(0xc3)]||'not\x20found','transactionId':_0x14f241[_0x1b1dfe(0x9f)]['transactionId'],'createdOn':_0x14f241[_0x1b1dfe(0x9f)][_0x1b1dfe(0x12e)],'confirmedOn':_0x14f241[_0x1b1dfe(0x9f)][_0x1b1dfe(0x129)]||_0x1b1dfe(0xeb)});if(_0x14f241[_0x1b1dfe(0xac)]!==_0x15b03c[_0x1b1dfe(0xac)]){console[_0x1b1dfe(0xcb)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x15b03c['id']+'\x20status\x20from\x20'+_0x15b03c[_0x1b1dfe(0xac)]+'\x20to\x20'+_0x14f241['status']),this[_0x1b1dfe(0x149)](_0x15b03c['id'],_0x15b03c[_0x1b1dfe(0x89)],_0x15b03c['status'],_0x14f241[_0x1b1dfe(0xac)],'status_check',{'paymentDetails':_0x14f241[_0x1b1dfe(0x9f)],'amount':_0x14f241[_0x1b1dfe(0x9c)],'currency':_0x14f241[_0x1b1dfe(0xf7)],'shopId':_0x15b03c[_0x1b1dfe(0xe8)],'checkTimestamp':new Date()[_0x1b1dfe(0x8d)]()});const _0x18e217={'status':_0x14f241['status'],'updatedAt':new Date()};_0x14f241[_0x1b1dfe(0xac)]===_0x1b1dfe(0xee)&&_0x15b03c['status']!=='PAID'&&(_0x18e217[_0x1b1dfe(0x14e)]=new Date(),console['log'](_0x1b1dfe(0x125)+_0x15b03c['id']+_0x1b1dfe(0xb8)+_0x18e217[_0x1b1dfe(0x14e)][_0x1b1dfe(0x8d)]()));if(_0x14f241[_0x1b1dfe(0x9f)]){const _0x27f7a2=_0x14f241[_0x1b1dfe(0x9f)];_0x27f7a2[_0x1b1dfe(0xc3)]&&(_0x18e217['remitterIban']=_0x27f7a2[_0x1b1dfe(0xc3)],console['log'](_0x1b1dfe(0x95)+_0x27f7a2[_0x1b1dfe(0xc3)]));if(_0x27f7a2[_0x1b1dfe(0x153)]){const _0x514802=_0x15b03c[_0x1b1dfe(0xc0)]||'',_0x2b0feb='Bank\x20Details:\x20'+_0x27f7a2['bankDetails'];_0x18e217['adminNotes']=_0x514802?_0x514802+'\x0a\x0a'+_0x2b0feb:_0x2b0feb,console[_0x1b1dfe(0xcb)](_0x1b1dfe(0x98));}_0x27f7a2['transactionId']&&console['log'](_0x1b1dfe(0xfc)+_0x27f7a2[_0x1b1dfe(0x93)]),_0x27f7a2[_0x1b1dfe(0x129)]&&console[_0x1b1dfe(0xcb)](_0x1b1dfe(0x11a)+_0x27f7a2[_0x1b1dfe(0x129)]);}await database_1[_0x1b1dfe(0xd6)][_0x1b1dfe(0x8f)][_0x1b1dfe(0xf2)]({'where':{'id':_0x15b03c['id']},'data':_0x18e217}),await database_1[_0x1b1dfe(0xd6)][_0x1b1dfe(0x139)][_0x1b1dfe(0x103)]({'data':{'paymentId':_0x15b03c['id'],'shopId':_0x15b03c[_0x1b1dfe(0xe8)],'event':_0x1b1dfe(0x78)+_0x14f241[_0x1b1dfe(0xac)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x1b1dfe(0xa2)]({'oldStatus':_0x15b03c[_0x1b1dfe(0xac)],'newStatus':_0x14f241['status'],'paymentDetails':_0x14f241[_0x1b1dfe(0x9f)],'checkedAt':new Date()[_0x1b1dfe(0x8d)]()})}}),await this[_0x1b1dfe(0x80)](_0x15b03c,_0x14f241[_0x1b1dfe(0xac)]),await this[_0x1b1dfe(0xd9)](_0x15b03c,_0x14f241[_0x1b1dfe(0xac)]),_0x14f241[_0x1b1dfe(0xac)]!==_0x1b1dfe(0xa4)&&(console[_0x1b1dfe(0xcb)](_0x1b1dfe(0xcd)+_0x15b03c['id']+_0x1b1dfe(0x131)+_0x14f241[_0x1b1dfe(0xac)]+_0x1b1dfe(0x71)),this[_0x1b1dfe(0x12a)](_0x15b03c['id'])),console[_0x1b1dfe(0xcb)](_0x1b1dfe(0x8b)+_0x15b03c['id']+_0x1b1dfe(0x96));}else console['log'](_0x1b1dfe(0x91)+_0x15b03c['id']+_0x1b1dfe(0x146)+_0x14f241['status']+')'),this[_0x1b1dfe(0x149)](_0x15b03c['id'],_0x15b03c[_0x1b1dfe(0x89)],_0x15b03c['status'],_0x14f241[_0x1b1dfe(0xac)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x14f241[_0x1b1dfe(0x9f)],'amount':_0x14f241[_0x1b1dfe(0x9c)],'currency':_0x14f241[_0x1b1dfe(0xf7)],'shopId':_0x15b03c['shopId'],'checkTimestamp':new Date()[_0x1b1dfe(0x8d)]()});}catch(_0x454fd4){console['error'](_0x1b1dfe(0x140)+_0x15b03c['id']+':',_0x454fd4),this[_0x1b1dfe(0x9d)](_0x15b03c['id'],_0x15b03c[_0x1b1dfe(0x89)],_0x454fd4,_0x1b1dfe(0x81),{'paymentAmount':_0x15b03c[_0x1b1dfe(0x9c)],'paymentCurrency':_0x15b03c[_0x1b1dfe(0xf7)],'shopId':_0x15b03c[_0x1b1dfe(0xe8)],'createdAt':_0x15b03c[_0x1b1dfe(0x12c)]}),await database_1[_0x1b1dfe(0xd6)][_0x1b1dfe(0x139)][_0x1b1dfe(0x103)]({'data':{'paymentId':_0x15b03c['id'],'shopId':_0x15b03c[_0x1b1dfe(0xe8)],'event':_0x1b1dfe(0x110),'statusCode':0x1f4,'responseBody':JSON[_0x1b1dfe(0xa2)]({'error':_0x454fd4 instanceof Error?_0x454fd4[_0x1b1dfe(0xe6)]:_0x1b1dfe(0xa9),'gatewayPaymentId':_0x15b03c[_0x1b1dfe(0x89)],'checkedAt':new Date()[_0x1b1dfe(0x8d)]()})}});}}async[a37_0xa016fe(0x80)](_0x316ab6,_0x2ec511){const _0x5df90f=a37_0xa016fe,_0x580894=Date[_0x5df90f(0xf1)]();try{const _0x45e2ed=_0x316ab6['shop'],_0x10de4d=_0x45e2ed['settings'];if(!_0x10de4d?.['webhookUrl']){console[_0x5df90f(0xcb)](_0x5df90f(0xb7)+_0x45e2ed['id']);return;}const _0x4ab4af=_0x2ec511==='PAID'?_0x5df90f(0xb0):_0x2ec511==='FAILED'?_0x5df90f(0xd0):_0x2ec511===_0x5df90f(0x14b)?_0x5df90f(0xd0):_0x5df90f(0x72);if(!_0x10de4d['webhookEvents']?.['includes'](_0x4ab4af)){console[_0x5df90f(0xcb)](_0x5df90f(0x10c)+_0x4ab4af+_0x5df90f(0xbd)+_0x45e2ed['id']);return;}const _0x50fe60={'event':_0x4ab4af,'payment':{'id':_0x316ab6['id'],'order_id':_0x316ab6['orderId'],'gateway_order_id':_0x316ab6['gatewayOrderId'],'gateway':_0x5df90f(0xde),'amount':_0x316ab6[_0x5df90f(0x9c)],'currency':_0x316ab6[_0x5df90f(0xf7)],'status':_0x2ec511[_0x5df90f(0x77)](),'customer_email':_0x316ab6[_0x5df90f(0xef)],'customer_name':_0x316ab6['customerName'],'created_at':_0x316ab6[_0x5df90f(0x12c)],'updated_at':new Date()}},_0x59a9bb=await fetch(_0x10de4d['webhookUrl'],{'method':_0x5df90f(0xa5),'headers':{'Content-Type':'application/json','User-Agent':_0x5df90f(0xfa)},'body':JSON['stringify'](_0x50fe60)}),_0x205958=Date['now']()-_0x580894,_0x5857e6=_0x59a9bb['ok']?'Success':await _0x59a9bb[_0x5df90f(0xa0)]();loggerService_1[_0x5df90f(0xc6)][_0x5df90f(0xa1)](_0x316ab6[_0x5df90f(0xe8)],_0x10de4d[_0x5df90f(0x99)],_0x4ab4af,_0x59a9bb[_0x5df90f(0xac)],_0x205958,_0x50fe60),console[_0x5df90f(0xcb)](_0x5df90f(0x143)+_0x10de4d[_0x5df90f(0x99)]+_0x5df90f(0xcf)+_0x59a9bb['status']+'\x20('+_0x205958+_0x5df90f(0xe3));}catch(_0xce53a6){console['error'](_0x5df90f(0xfd),_0xce53a6),loggerService_1[_0x5df90f(0xc6)][_0x5df90f(0x121)](_0x316ab6[_0x5df90f(0xe8)],_0x316ab6['shop']?.[_0x5df90f(0x83)]?.['webhookUrl']||'unknown',_0x5df90f(0x117),_0xce53a6,{});}}async[a37_0xa016fe(0xd9)](_0x3b7dd2,_0x1e907c){const _0x59207=a37_0xa016fe;try{const _0x159749={'PENDING':_0x59207(0xe9),'PAID':_0x59207(0x156),'FAILED':_0x59207(0x84),'EXPIRED':'expired'},_0x469905=_0x159749[_0x1e907c];if(!_0x469905||_0x469905===_0x59207(0xe9))return;await telegramBotService_1['telegramBotService'][_0x59207(0xbc)](_0x3b7dd2['shopId'],_0x3b7dd2,_0x469905);}catch(_0x3d3242){console['error'](_0x59207(0x13c),_0x3d3242);}}async['checkPaymentById'](_0x1ff74b){const _0xc8634b=a37_0xa016fe;console[_0xc8634b(0xcb)]('🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x1ff74b);const _0x111bed=await database_1[_0xc8634b(0xd6)][_0xc8634b(0x8f)][_0xc8634b(0x13a)]({'where':{'id':_0x1ff74b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x111bed)throw new Error(_0xc8634b(0xa8));if(_0x111bed['gateway']!=='cointopay')throw new Error(_0xc8634b(0xe7));console[_0xc8634b(0xcb)](_0xc8634b(0x148)+_0x1ff74b),await this[_0xc8634b(0x152)](_0x111bed),console[_0xc8634b(0xcb)](_0xc8634b(0x154)+_0x1ff74b);}[a37_0xa016fe(0x124)](){const _0x33f2a1=a37_0xa016fe,_0x19d01d=this[_0x33f2a1(0xc5)]?this[_0x33f2a1(0x133)]:undefined,_0x50ad25=Array['from'](this[_0x33f2a1(0x73)][_0x33f2a1(0x8e)]())[_0x33f2a1(0x76)](_0x61897f=>({'paymentId':_0x61897f[_0x33f2a1(0xd7)],'gatewayPaymentId':_0x61897f[_0x33f2a1(0x89)],'createdAt':_0x61897f[_0x33f2a1(0x12c)],'timersCount':_0x61897f[_0x33f2a1(0x82)][_0x33f2a1(0xa6)]}));return{'isActive':!!this[_0x33f2a1(0xc5)],'globalCheckIntervalMinutes':this[_0x33f2a1(0x133)]/(0x3e8*0x3c),'expiryDays':this[_0x33f2a1(0x119)],'activeIndividualTimers':this[_0x33f2a1(0x73)][_0x33f2a1(0xce)],'nextGlobalCheckIn':_0x19d01d,'paymentTimersDetails':_0x50ad25};}[a37_0xa016fe(0x13d)](_0x44a0dc){const _0x5a4ce2=a37_0xa016fe,_0xb823b2=this[_0x5a4ce2(0x73)]['get'](_0x44a0dc);if(_0xb823b2)return{'hasTimers':!![],'timersCount':_0xb823b2['timers'][_0x5a4ce2(0xa6)],'createdAt':_0xb823b2[_0x5a4ce2(0x12c)],'gatewayPaymentId':_0xb823b2[_0x5a4ce2(0x89)]};return{'hasTimers':![]};}}exports[a37_0xa016fe(0x123)]=CoinToPayStatusService,exports[a37_0xa016fe(0xda)]=new CoinToPayStatusService();