'use strict';const a37_0x285132=a37_0x5e66;(function(_0x14b4c1,_0x535a2d){const _0x551f3f=a37_0x5e66,_0x7bb7e4=_0x14b4c1();while(!![]){try{const _0x5e7131=parseInt(_0x551f3f(0x19d))/0x1+-parseInt(_0x551f3f(0x1dd))/0x2+parseInt(_0x551f3f(0x1a7))/0x3+-parseInt(_0x551f3f(0x1f1))/0x4+-parseInt(_0x551f3f(0x20a))/0x5*(parseInt(_0x551f3f(0x1c7))/0x6)+parseInt(_0x551f3f(0x18e))/0x7+-parseInt(_0x551f3f(0x1b4))/0x8*(-parseInt(_0x551f3f(0x178))/0x9);if(_0x5e7131===_0x535a2d)break;else _0x7bb7e4['push'](_0x7bb7e4['shift']());}catch(_0x425ebe){_0x7bb7e4['push'](_0x7bb7e4['shift']());}}}(a37_0xba58,0x79d30));function a37_0xba58(){const _0x169e58=['./telegramBotService','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','failed','remitterIban','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','sendPaymentNotification','1075334jaTlPj','toLowerCase','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','TesSoft\x20Payment\x20System/1.0','bankDetails','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','GLOBAL_CHECK_INTERVAL_MS','startPeriodicStatusCheck','message','🔄\x20[CHECK]\x20Updating\x20payment\x20','./loggerService',',\x20clearing\x20individual\x20timers','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','logCoinToPayStatus','adminNotes','coinToPayStatusService','payment','shop','\x20expired\x20CoinToPay\x20payments','1747584YDrMlh','not\x20found','Shop\x20webhook\x20sent\x20to\x20','stringify','checkExpiredPayments','\x20\x20\x20-\x20Gateway:\x20','\x20not\x20enabled\x20for\x20shop\x20','\x20days\x20without\x20payment\x20confirmation','.\x20Remaining\x20active\x20timers:\x20','settings','delay','✅\x20[CHECK]\x20Payment\x20','iban','forEach','status','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','not\x20confirmed','ms)','getTime','2\x20minutes','\x20not\x20found,\x20clearing\x20timers','\x20to\x20','gateway','values','webhook_send','6420hkFMhj','map','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','size','payment.failed','POST','length','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','catch','getDate','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','includes','unknown','CoinToPayStatusService','findUnique','stopPeriodicStatusCheck','gatewayPaymentId','❌\x20[HOURLY]\x20Payment\x20','sendShopWebhook','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','defineProperty','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','amount','cointopay','description','checkPaymentStatus','\x20has\x20no\x20gatewayPaymentId','✅\x20[HOURLY]\x20Payment\x20','cointopay_status_check_error','coinToPayService','checkSinglePaymentById','from','schedulePaymentChecks','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','confirmedOn','\x20status\x20is\x20','payment.success','5\x20minutes','COINTOPAY_ERROR','\x20is\x20too\x20new\x20(','\x20status:\x20','logShopWebhookError','paymentId','createdOn','status_check','error','🧹\x20[DEBUG]\x20Clearing\x20','transactionId','❌\x20[CHECK]\x20Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','🧹\x20[CHECK]\x20Payment\x20','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20marked\x20as\x20paid\x20at:\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','🪙\x20[GLOBAL]\x20Found\x20','EXPIRED','webhookLog','create','webhookEvents','__esModule','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','PAID','\x20is\x20older\x20than\x20','now','\x20triggered\x20for\x20payment\x20','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','customerName','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','shopId','loggerService','../config/database','\x20has\x20no\x20gatewayPaymentId,\x20skipping','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','floor','createdAt','customerEmail','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','Payment\x20older\x20than\x20','\x20current\x20status:\x20','\x20seconds\x20(','\x20pending\x20CoinToPay\x20payments','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20to\x20clear','globalCheckInterval','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','getPaymentTimerInfo','📊\x20[CHECK]\x20Payment\x20','1726740PKellW','\x20days\x20(created\x20before\x20','\x20found:','currency','cointopay_status_check_','has','\x20with\x20status\x20','orderId','Payment\x20not\x20found','findMany','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20timers\x20for\x20payment\x20','\x20individual\x20payment\x20timers','gatewayOrderId','auto_expire','application/json','sendPaymentStatusNotification','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','⏰\x20[GLOBAL]\x20Payment\x20','paid','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20\x20\x20-\x20Amount:\x20','301609xJoaYg','\x20days','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20(after\x20','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','get','cointopay_auto_expired','timers','📊\x20[HOURLY]\x20Payment\x20','logShopWebhookSent','PENDING','🪙\x20[TIMER]\x20Individual\x20check\x20#','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','🛑\x20[SHUTDOWN]\x20Cleared\x20','406608JmVGCk','⏰\x20[EXPIRY]\x20Payment\x20','✅\x20[EXPIRY]\x20Payment\x20','checkSinglePayment','\x20not\x20found\x20in\x20database','timestamp','\x20initial\x20timers\x20for\x20payment\x20','paymentDetails','push','delete','1081272wYIUTa','FAILED','\x20for\x20payment\x20','\x20status\x20unchanged\x20(','\x20\x20\x20📍\x20Source:\x20','\x20expired','update','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20skipped,\x20','logCoinToPayError','⚠️\x20[CHECK]\x20Payment\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','schedule_created','32TvlYom','Webhook\x20event\x20','stack','\x20(age:\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','getServiceStats','toISOString','paymentTimers','log','\x20\x20\x20-\x20Status:\x20','EXPIRY_DAYS','paidAt','logWhiteDomainError','\x20\x20\x20-\x20GatewayPaymentId:\x20','toFixed','\x20details:','checkAllPendingPayments','CoinToPayService',',\x20stopping\x20individual\x20checks','486JBuFdY','__importDefault','payment.pending','created','webhookUrl','✅\x20[TIMER]\x20Individual\x20check\x20#','\x20\x20\x20📅\x20Time:\x20','clearPaymentTimers','\x20\x20\x20📝\x20Context:','set','setDate','\x20completed\x20for\x20payment\x20','\x20\x20\x20❌\x20Error:\x20','⏰\x20[GLOBAL]\x20Found\x20','default','⏰\x20[HOURLY]\x20Payment\x20'];a37_0xba58=function(){return _0x169e58;};return a37_0xba58();}var __importDefault=this&&this[a37_0x285132(0x1c8)]||function(_0x5ab5a7){const _0x4a1bbf=a37_0x285132;return _0x5ab5a7&&_0x5ab5a7[_0x4a1bbf(0x246)]?_0x5ab5a7:{'default':_0x5ab5a7};};Object[a37_0x285132(0x21f)](exports,a37_0x285132(0x246),{'value':!![]}),exports[a37_0x285132(0x1ed)]=exports[a37_0x285132(0x218)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a37_0x285132(0x165))),telegramBotService_1=require(a37_0x285132(0x1d7)),loggerService_1=require(a37_0x285132(0x1e7));function a37_0x5e66(_0x1548f9,_0x2d31cd){const _0xba583b=a37_0xba58();return a37_0x5e66=function(_0x5e66ae,_0x5f5282){_0x5e66ae=_0x5e66ae-0x164;let _0x55b56c=_0xba583b[_0x5e66ae];return _0x55b56c;},a37_0x5e66(_0x1548f9,_0x2d31cd);}class CoinToPayStatusService{constructor(){const _0x2405b7=a37_0x285132;this['globalCheckInterval']=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x2405b7(0x1be)]=0x5,this[_0x2405b7(0x1bb)]=new Map(),this[_0x2405b7(0x228)]=new coinToPayService_1[(_0x2405b7(0x1c5))](),console[_0x2405b7(0x1bc)]('🪙\x20CoinToPayStatusService\x20initialized');}[a37_0x285132(0x22b)](_0x2f9bce,_0x3779b9){const _0x5371d8=a37_0x285132;console[_0x5371d8(0x1bc)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x5371d8(0x1bc)]('\x20\x20\x20-\x20paymentId:\x20'+_0x2f9bce),console[_0x5371d8(0x1bc)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x3779b9),this[_0x5371d8(0x1ce)](_0x2f9bce);const _0x4ddecb=[],_0x592ab6=new Date(),_0x28cd4b=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x5371d8(0x204)},{'delay':0x5*0x3c*0x3e8,'description':_0x5371d8(0x230)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x5371d8(0x1bc)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x28cd4b[_0x5371d8(0x210)]+_0x5371d8(0x1a3)+_0x2f9bce);let _0x3b5da9=0x0;_0x28cd4b[_0x5371d8(0x1fe)]((_0x351337,_0x140e3f)=>{const _0x29e5e9=_0x5371d8;_0x3b5da9+=_0x351337[_0x29e5e9(0x1fb)];const _0x1f57df=setTimeout(async()=>{const _0x430265=_0x29e5e9;console[_0x430265(0x1bc)](_0x430265(0x19a)+(_0x140e3f+0x1)+_0x430265(0x24b)+_0x2f9bce+_0x430265(0x191)+_0x351337[_0x430265(0x223)]+')');try{await this[_0x430265(0x229)](_0x2f9bce),console[_0x430265(0x1bc)](_0x430265(0x1cc)+(_0x140e3f+0x1)+_0x430265(0x1d2)+_0x2f9bce);}catch(_0x367fd5){console[_0x430265(0x238)](_0x430265(0x220)+(_0x140e3f+0x1)+'\x20for\x20payment\x20'+_0x2f9bce+':',_0x367fd5),this[_0x430265(0x1b0)](_0x2f9bce,_0x3779b9,_0x367fd5,_0x430265(0x237),{'checkNumber':_0x140e3f+0x1,'scheduledAfter':_0x351337[_0x430265(0x223)],'isIndividualCheck':!![]});}},_0x3b5da9);_0x4ddecb[_0x29e5e9(0x1a5)](_0x1f57df),console['log'](_0x29e5e9(0x20c)+(_0x140e3f+0x1)+_0x29e5e9(0x1a9)+_0x2f9bce+'\x20in\x20'+_0x3b5da9/0x3e8+_0x29e5e9(0x170)+_0x351337[_0x29e5e9(0x223)]+')');});const _0x4ec03b=setInterval(async()=>{const _0x1dc6fe=_0x5371d8;console[_0x1dc6fe(0x1bc)]('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x2f9bce);try{const _0x9554ad=await database_1[_0x1dc6fe(0x1d5)][_0x1dc6fe(0x1ee)][_0x1dc6fe(0x219)]({'where':{'id':_0x2f9bce},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x9554ad){console[_0x1dc6fe(0x1bc)](_0x1dc6fe(0x21c)+_0x2f9bce+_0x1dc6fe(0x205)),this[_0x1dc6fe(0x1ce)](_0x2f9bce);return;}console[_0x1dc6fe(0x1bc)](_0x1dc6fe(0x197)+_0x2f9bce+_0x1dc6fe(0x16f)+_0x9554ad[_0x1dc6fe(0x1ff)]);if(_0x9554ad['status']!=='PENDING'){console[_0x1dc6fe(0x1bc)](_0x1dc6fe(0x226)+_0x2f9bce+_0x1dc6fe(0x22e)+_0x9554ad['status']+',\x20stopping\x20individual\x20checks'),this[_0x1dc6fe(0x1ce)](_0x2f9bce);return;}const _0x11fc4f=Math[_0x1dc6fe(0x169)]((Date['now']()-_0x9554ad[_0x1dc6fe(0x16a)][_0x1dc6fe(0x203)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x11fc4f>=this[_0x1dc6fe(0x1be)]){console[_0x1dc6fe(0x1bc)](_0x1dc6fe(0x1d6)+_0x2f9bce+_0x1dc6fe(0x249)+this[_0x1dc6fe(0x1be)]+_0x1dc6fe(0x182)),this[_0x1dc6fe(0x1ce)](_0x2f9bce);return;}await this[_0x1dc6fe(0x229)](_0x2f9bce),console[_0x1dc6fe(0x1bc)](_0x1dc6fe(0x21e)+_0x2f9bce);}catch(_0x32ed91){console[_0x1dc6fe(0x238)](_0x1dc6fe(0x1ea)+_0x2f9bce+':',_0x32ed91),this['logCoinToPayError'](_0x2f9bce,_0x3779b9,_0x32ed91,_0x1dc6fe(0x237),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x4ddecb[_0x5371d8(0x1a5)](_0x4ec03b),this[_0x5371d8(0x1bb)][_0x5371d8(0x1d0)](_0x2f9bce,{'timers':_0x4ddecb,'paymentId':_0x2f9bce,'gatewayPaymentId':_0x3779b9,'createdAt':_0x592ab6}),console[_0x5371d8(0x1bc)](_0x5371d8(0x190)+_0x28cd4b[_0x5371d8(0x210)]+_0x5371d8(0x22c)+_0x2f9bce),console['log']('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x5371d8(0x1bb)][_0x5371d8(0x20d)]),this[_0x5371d8(0x1eb)](_0x2f9bce,_0x3779b9,_0x5371d8(0x199),_0x5371d8(0x199),_0x5371d8(0x237),{'action':_0x5371d8(0x1b3),'scheduledChecks':_0x28cd4b[_0x5371d8(0x210)],'firstCheckIn':_0x28cd4b[0x0][_0x5371d8(0x1fb)]/0x3e8,'totalTimers':this[_0x5371d8(0x1bb)]['size']});}[a37_0x285132(0x1ce)](_0x9dfd4){const _0x1f43cd=a37_0x285132,_0x25262a=this[_0x1f43cd(0x1bb)][_0x1f43cd(0x194)](_0x9dfd4);_0x25262a?(console['log'](_0x1f43cd(0x239)+_0x25262a[_0x1f43cd(0x196)][_0x1f43cd(0x210)]+_0x1f43cd(0x183)+_0x9dfd4),_0x25262a[_0x1f43cd(0x196)]['forEach']((_0x3ae97c,_0x4f55ea)=>{const _0x1d7255=_0x1f43cd;_0x3ae97c&&(clearTimeout(_0x3ae97c),clearInterval(_0x3ae97c),console['log'](_0x1d7255(0x1e9)+(_0x4f55ea+0x1)+'\x20for\x20payment\x20'+_0x9dfd4));}),this[_0x1f43cd(0x1bb)][_0x1f43cd(0x1a6)](_0x9dfd4),console[_0x1f43cd(0x1bc)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x9dfd4+_0x1f43cd(0x1f9)+this[_0x1f43cd(0x1bb)][_0x1f43cd(0x20d)])):console['log'](_0x1f43cd(0x1e2)+_0x9dfd4+_0x1f43cd(0x173));}async[a37_0x285132(0x229)](_0x5627fd){const _0x3440a3=a37_0x285132;console['log']('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x5627fd);const _0x4e9fcd=await database_1[_0x3440a3(0x1d5)]['payment'][_0x3440a3(0x219)]({'where':{'id':_0x5627fd},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4e9fcd){console[_0x3440a3(0x1bc)](_0x3440a3(0x23b)+_0x5627fd+_0x3440a3(0x1a1));return;}console[_0x3440a3(0x1bc)]('📊\x20[CHECK]\x20Payment\x20'+_0x5627fd+_0x3440a3(0x17a)),console['log'](_0x3440a3(0x1f6)+_0x4e9fcd[_0x3440a3(0x207)]),console[_0x3440a3(0x1bc)](_0x3440a3(0x1bd)+_0x4e9fcd['status']),console[_0x3440a3(0x1bc)](_0x3440a3(0x1c1)+_0x4e9fcd[_0x3440a3(0x21b)]),console['log'](_0x3440a3(0x18d)+_0x4e9fcd['amount']+'\x20'+_0x4e9fcd['currency']),console['log']('\x20\x20\x20-\x20ShopId:\x20'+_0x4e9fcd['shopId']);if(_0x4e9fcd[_0x3440a3(0x207)]!==_0x3440a3(0x222)){console[_0x3440a3(0x1bc)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x5627fd+_0x3440a3(0x1b8)+_0x4e9fcd['gateway']+')');return;}if(_0x4e9fcd[_0x3440a3(0x1ff)]!==_0x3440a3(0x199)){console['log'](_0x3440a3(0x1b1)+_0x5627fd+_0x3440a3(0x22e)+_0x4e9fcd[_0x3440a3(0x1ff)]+_0x3440a3(0x1c6)),this[_0x3440a3(0x1ce)](_0x5627fd);return;}if(!_0x4e9fcd['gatewayPaymentId']){console[_0x3440a3(0x1bc)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x5627fd+_0x3440a3(0x225));return;}console['log'](_0x3440a3(0x1fc)+_0x5627fd+_0x3440a3(0x172)),await this['checkSinglePayment'](_0x4e9fcd);}['logCoinToPayStatus'](_0x2d9b4c,_0x154630,_0xe75ebc,_0x5b50ff,_0x23ca6d,_0x3eba89){const _0x37403b=a37_0x285132,_0x475f4b={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x2d9b4c,'gatewayPaymentId':_0x154630,'oldStatus':_0xe75ebc,'newStatus':_0x5b50ff,'source':_0x23ca6d,'timestamp':new Date()['toISOString'](),'details':_0x3eba89||{}};loggerService_1[_0x37403b(0x164)][_0x37403b(0x1eb)](_0x475f4b),console[_0x37403b(0x1bc)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x2d9b4c+'\x20('+_0x154630+')'),console[_0x37403b(0x1bc)]('\x20\x20\x20📊\x20Status:\x20'+_0xe75ebc+'\x20->\x20'+_0x5b50ff),console[_0x37403b(0x1bc)]('\x20\x20\x20📍\x20Source:\x20'+_0x23ca6d),console['log'](_0x37403b(0x1cd)+_0x475f4b['timestamp']),_0x3eba89&&console[_0x37403b(0x1bc)]('\x20\x20\x20📝\x20Details:',_0x3eba89);}['logCoinToPayError'](_0x360fc5,_0x4b5b3a,_0x124bb3,_0x31bf7f,_0xe64a1a){const _0x357be4=a37_0x285132,_0x476583={'type':_0x357be4(0x231),'paymentId':_0x360fc5,'gatewayPaymentId':_0x4b5b3a,'error':_0x124bb3 instanceof Error?{'message':_0x124bb3['message'],'stack':_0x124bb3[_0x357be4(0x1b6)]}:_0x124bb3,'source':_0x31bf7f,'timestamp':new Date()[_0x357be4(0x1ba)](),'context':_0xe64a1a||{}};loggerService_1['loggerService']['logCoinToPayError'](_0x476583),console[_0x357be4(0x238)]('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x360fc5+'\x20('+_0x4b5b3a+')'),console[_0x357be4(0x238)](_0x357be4(0x1d3)+(_0x124bb3 instanceof Error?_0x124bb3[_0x357be4(0x1e5)]:_0x124bb3)),console[_0x357be4(0x238)](_0x357be4(0x1ab)+_0x31bf7f),console[_0x357be4(0x238)](_0x357be4(0x1cd)+_0x476583[_0x357be4(0x1a2)]),_0xe64a1a&&console['error'](_0x357be4(0x1cf),_0xe64a1a);}[a37_0x285132(0x1e4)](){const _0x43acde=a37_0x285132;console['log'](_0x43acde(0x24e)),this['checkAllPendingPayments']()[_0x43acde(0x212)](_0x2fff8a=>{const _0x2166ee=_0x43acde;console['error'](_0x2166ee(0x18c),_0x2fff8a);}),this['globalCheckInterval']=setInterval(async()=>{const _0x53eefc=_0x43acde;try{console[_0x53eefc(0x1bc)]('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x53eefc(0x1c4)](),console[_0x53eefc(0x1bc)](_0x53eefc(0x192));}catch(_0x50e556){console[_0x53eefc(0x238)](_0x53eefc(0x211),_0x50e556);}},this[_0x43acde(0x1e3)]),console[_0x43acde(0x1bc)](_0x43acde(0x19b));}[a37_0x285132(0x21a)](){const _0xa33d1e=a37_0x285132;console[_0xa33d1e(0x1bc)](_0xa33d1e(0x200));this[_0xa33d1e(0x174)]&&(clearInterval(this[_0xa33d1e(0x174)]),this[_0xa33d1e(0x174)]=null,console[_0xa33d1e(0x1bc)](_0xa33d1e(0x193)));const _0x5a9e3a=this['paymentTimers'][_0xa33d1e(0x20d)];for(const [_0x50a520]of this[_0xa33d1e(0x1bb)]){this[_0xa33d1e(0x1ce)](_0x50a520);}console[_0xa33d1e(0x1bc)](_0xa33d1e(0x19c)+_0x5a9e3a+_0xa33d1e(0x184));}async[a37_0x285132(0x1c4)](){const _0x56f253=a37_0x285132;try{console[_0x56f253(0x1bc)]('🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x11a67b=await database_1[_0x56f253(0x1d5)][_0x56f253(0x1ee)][_0x56f253(0x181)]({'where':{'gateway':_0x56f253(0x222),'status':_0x56f253(0x199),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x56f253(0x1bc)](_0x56f253(0x241)+_0x11a67b['length']+_0x56f253(0x171));if(_0x11a67b[_0x56f253(0x210)]===0x0){console[_0x56f253(0x1bc)](_0x56f253(0x1d8));return;}const _0x43e45c=await this[_0x56f253(0x1f5)](_0x11a67b);console['log'](_0x56f253(0x1d4)+_0x43e45c[_0x56f253(0x210)]+_0x56f253(0x1f0));let _0x50f99d=0x0,_0x7a1566=0x0;for(const _0x27a500 of _0x11a67b){try{if(_0x43e45c[_0x56f253(0x216)](_0x27a500['id'])){console[_0x56f253(0x1bc)](_0x56f253(0x18a)+_0x27a500['id']+_0x56f253(0x16d)),_0x7a1566++;continue;}if(this[_0x56f253(0x1bb)][_0x56f253(0x17d)](_0x27a500['id'])){console[_0x56f253(0x1bc)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x27a500['id']+_0x56f253(0x1ae)),_0x7a1566++;continue;}const _0x238d79=(Date['now']()-_0x27a500['createdAt'][_0x56f253(0x203)]())/(0x3e8*0x3c*0x3c);if(_0x238d79<0x1){console[_0x56f253(0x1bc)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x27a500['id']+_0x56f253(0x232)+_0x238d79[_0x56f253(0x1c2)](0x1)+'h),\x20skipping\x20global\x20check'),_0x7a1566++;continue;}console[_0x56f253(0x1bc)](_0x56f253(0x168)+_0x27a500['id']+_0x56f253(0x1b7)+_0x238d79[_0x56f253(0x1c2)](0x1)+'h)'),await this[_0x56f253(0x1a0)](_0x27a500),_0x50f99d++,await new Promise(_0x5b9a3a=>setTimeout(_0x5b9a3a,0x7d0));}catch(_0x522b76){console[_0x56f253(0x238)]('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x27a500['id']+':',_0x522b76),this[_0x56f253(0x1b0)](_0x27a500['id'],_0x27a500[_0x56f253(0x21b)]||_0x56f253(0x217),_0x522b76,_0x56f253(0x237),{'isGlobalCheck':!![],'paymentAmount':_0x27a500[_0x56f253(0x221)],'paymentCurrency':_0x27a500[_0x56f253(0x17b)],'shopId':_0x27a500['shopId'],'createdAt':_0x27a500['createdAt']}),loggerService_1[_0x56f253(0x164)][_0x56f253(0x1c0)](_0x56f253(0x222),'/status/'+_0x27a500[_0x56f253(0x21b)],_0x522b76);}}console[_0x56f253(0x1bc)](_0x56f253(0x175)+_0x50f99d+'\x20checked,\x20'+_0x7a1566+_0x56f253(0x1af)+_0x43e45c[_0x56f253(0x210)]+_0x56f253(0x1ac));}catch(_0x57f38c){console['error']('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x57f38c);}}async[a37_0x285132(0x1f5)](_0xb0d6d){const _0x4f4d03=a37_0x285132,_0x168456=[],_0x46865e=new Date();_0x46865e[_0x4f4d03(0x1d1)](_0x46865e[_0x4f4d03(0x213)]()-this[_0x4f4d03(0x1be)]),console['log'](_0x4f4d03(0x167)+this[_0x4f4d03(0x1be)]+_0x4f4d03(0x179)+_0x46865e['toISOString']()+')');for(const _0x3bb68f of _0xb0d6d){if(_0x3bb68f[_0x4f4d03(0x16a)]<_0x46865e){console['log'](_0x4f4d03(0x19e)+_0x3bb68f['id']+_0x4f4d03(0x249)+this[_0x4f4d03(0x1be)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x4f4d03(0x1eb)](_0x3bb68f['id'],_0x3bb68f[_0x4f4d03(0x21b)]||_0x4f4d03(0x217),'PENDING',_0x4f4d03(0x242),_0x4f4d03(0x186),{'reason':_0x4f4d03(0x16e)+this[_0x4f4d03(0x1be)]+_0x4f4d03(0x18f),'createdAt':_0x3bb68f[_0x4f4d03(0x16a)],'daysSinceCreation':Math['floor']((Date[_0x4f4d03(0x24a)]()-_0x3bb68f[_0x4f4d03(0x16a)][_0x4f4d03(0x203)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x3bb68f[_0x4f4d03(0x221)],'paymentCurrency':_0x3bb68f[_0x4f4d03(0x17b)],'shopId':_0x3bb68f[_0x4f4d03(0x24f)]}),await database_1['default'][_0x4f4d03(0x1ee)][_0x4f4d03(0x1ad)]({'where':{'id':_0x3bb68f['id']},'data':{'status':_0x4f4d03(0x242),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x4f4d03(0x1be)]+_0x4f4d03(0x1f8)}}),await database_1[_0x4f4d03(0x1d5)][_0x4f4d03(0x243)][_0x4f4d03(0x244)]({'data':{'paymentId':_0x3bb68f['id'],'shopId':_0x3bb68f[_0x4f4d03(0x24f)],'event':_0x4f4d03(0x195),'statusCode':0xc8,'responseBody':JSON[_0x4f4d03(0x1f4)]({'reason':_0x4f4d03(0x16e)+this[_0x4f4d03(0x1be)]+_0x4f4d03(0x18f),'createdAt':_0x3bb68f[_0x4f4d03(0x16a)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x4f4d03(0x169)]((Date['now']()-_0x3bb68f['createdAt'][_0x4f4d03(0x203)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4f4d03(0x21d)](_0x3bb68f,_0x4f4d03(0x242)),await this[_0x4f4d03(0x188)](_0x3bb68f,_0x4f4d03(0x242)),this[_0x4f4d03(0x1ce)](_0x3bb68f['id']),_0x168456[_0x4f4d03(0x1a5)](_0x3bb68f['id']),console[_0x4f4d03(0x1bc)](_0x4f4d03(0x19f)+_0x3bb68f['id']+_0x4f4d03(0x16c)+this[_0x4f4d03(0x1be)]+'-day\x20timeout');}catch(_0x3f8f92){console['error'](_0x4f4d03(0x214)+_0x3bb68f['id']+':',_0x3f8f92),this[_0x4f4d03(0x1b0)](_0x3bb68f['id'],_0x3bb68f[_0x4f4d03(0x21b)]||_0x4f4d03(0x217),_0x3f8f92,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x3bb68f[_0x4f4d03(0x16a)],'daysSinceCreation':Math['floor']((Date['now']()-_0x3bb68f['createdAt'][_0x4f4d03(0x203)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x168456;}async[a37_0x285132(0x1a0)](_0x29b225){const _0x281ffd=a37_0x285132;if(!_0x29b225[_0x281ffd(0x21b)]){console[_0x281ffd(0x1bc)](_0x281ffd(0x1b1)+_0x29b225['id']+_0x281ffd(0x166));return;}console['log'](_0x281ffd(0x24c)+_0x29b225['id']+'\x20('+_0x29b225['gatewayPaymentId']+')');try{const _0x774699=await this[_0x281ffd(0x228)][_0x281ffd(0x224)](_0x29b225[_0x281ffd(0x21b)]);console[_0x281ffd(0x1bc)](_0x281ffd(0x177)+_0x29b225['id']+_0x281ffd(0x233)+_0x774699[_0x281ffd(0x1ff)]);_0x774699[_0x281ffd(0x1a4)]&&console[_0x281ffd(0x1bc)]('📊\x20[CHECK]\x20Payment\x20'+_0x29b225['id']+_0x281ffd(0x1c3),{'iban':_0x774699[_0x281ffd(0x1a4)][_0x281ffd(0x1fd)]||_0x281ffd(0x1f2),'transactionId':_0x774699[_0x281ffd(0x1a4)][_0x281ffd(0x23a)],'createdOn':_0x774699['paymentDetails'][_0x281ffd(0x236)],'confirmedOn':_0x774699['paymentDetails']['confirmedOn']||_0x281ffd(0x201)});if(_0x774699[_0x281ffd(0x1ff)]!==_0x29b225['status']){console[_0x281ffd(0x1bc)](_0x281ffd(0x1e6)+_0x29b225['id']+'\x20status\x20from\x20'+_0x29b225[_0x281ffd(0x1ff)]+_0x281ffd(0x206)+_0x774699[_0x281ffd(0x1ff)]),this[_0x281ffd(0x1eb)](_0x29b225['id'],_0x29b225[_0x281ffd(0x21b)],_0x29b225[_0x281ffd(0x1ff)],_0x774699[_0x281ffd(0x1ff)],_0x281ffd(0x237),{'paymentDetails':_0x774699[_0x281ffd(0x1a4)],'amount':_0x774699[_0x281ffd(0x221)],'currency':_0x774699[_0x281ffd(0x17b)],'shopId':_0x29b225[_0x281ffd(0x24f)],'checkTimestamp':new Date()[_0x281ffd(0x1ba)]()});const _0x21113f={'status':_0x774699[_0x281ffd(0x1ff)],'updatedAt':new Date()};_0x774699[_0x281ffd(0x1ff)]===_0x281ffd(0x248)&&_0x29b225[_0x281ffd(0x1ff)]!=='PAID'&&(_0x21113f[_0x281ffd(0x1bf)]=new Date(),console['log']('💰\x20[CHECK]\x20Payment\x20'+_0x29b225['id']+_0x281ffd(0x23f)+_0x21113f[_0x281ffd(0x1bf)][_0x281ffd(0x1ba)]()));if(_0x774699['paymentDetails']){const _0x3bcfd0=_0x774699['paymentDetails'];_0x3bcfd0['iban']&&(_0x21113f[_0x281ffd(0x1da)]=_0x3bcfd0[_0x281ffd(0x1fd)],console[_0x281ffd(0x1bc)](_0x281ffd(0x247)+_0x3bcfd0[_0x281ffd(0x1fd)]));if(_0x3bcfd0[_0x281ffd(0x1e1)]){const _0x52f62b=_0x29b225[_0x281ffd(0x1ec)]||'',_0x19ea29='Bank\x20Details:\x20'+_0x3bcfd0['bankDetails'];_0x21113f[_0x281ffd(0x1ec)]=_0x52f62b?_0x52f62b+'\x0a\x0a'+_0x19ea29:_0x19ea29,console[_0x281ffd(0x1bc)](_0x281ffd(0x23e));}_0x3bcfd0[_0x281ffd(0x23a)]&&console['log'](_0x281ffd(0x1db)+_0x3bcfd0[_0x281ffd(0x23a)]),_0x3bcfd0[_0x281ffd(0x22d)]&&console[_0x281ffd(0x1bc)](_0x281ffd(0x189)+_0x3bcfd0[_0x281ffd(0x22d)]);}await database_1[_0x281ffd(0x1d5)][_0x281ffd(0x1ee)]['update']({'where':{'id':_0x29b225['id']},'data':_0x21113f}),await database_1[_0x281ffd(0x1d5)][_0x281ffd(0x243)][_0x281ffd(0x244)]({'data':{'paymentId':_0x29b225['id'],'shopId':_0x29b225['shopId'],'event':_0x281ffd(0x17c)+_0x774699[_0x281ffd(0x1ff)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x29b225[_0x281ffd(0x1ff)],'newStatus':_0x774699[_0x281ffd(0x1ff)],'paymentDetails':_0x774699[_0x281ffd(0x1a4)],'checkedAt':new Date()[_0x281ffd(0x1ba)]()})}}),await this[_0x281ffd(0x21d)](_0x29b225,_0x774699[_0x281ffd(0x1ff)]),await this[_0x281ffd(0x188)](_0x29b225,_0x774699[_0x281ffd(0x1ff)]),_0x774699[_0x281ffd(0x1ff)]!==_0x281ffd(0x199)&&(console[_0x281ffd(0x1bc)](_0x281ffd(0x23d)+_0x29b225['id']+'\x20status\x20changed\x20to\x20'+_0x774699['status']+_0x281ffd(0x1e8)),this[_0x281ffd(0x1ce)](_0x29b225['id'])),console['log'](_0x281ffd(0x1fc)+_0x29b225['id']+'\x20updated\x20successfully');}else console[_0x281ffd(0x1bc)](_0x281ffd(0x177)+_0x29b225['id']+_0x281ffd(0x1aa)+_0x774699[_0x281ffd(0x1ff)]+')'),this[_0x281ffd(0x1eb)](_0x29b225['id'],_0x29b225[_0x281ffd(0x21b)],_0x29b225['status'],_0x774699['status'],_0x281ffd(0x237),{'statusUnchanged':!![],'paymentDetails':_0x774699[_0x281ffd(0x1a4)],'amount':_0x774699[_0x281ffd(0x221)],'currency':_0x774699['currency'],'shopId':_0x29b225['shopId'],'checkTimestamp':new Date()[_0x281ffd(0x1ba)]()});}catch(_0x5b4e08){console['error'](_0x281ffd(0x1b2)+_0x29b225['id']+':',_0x5b4e08),this['logCoinToPayError'](_0x29b225['id'],_0x29b225['gatewayPaymentId'],_0x5b4e08,'status_check',{'paymentAmount':_0x29b225[_0x281ffd(0x221)],'paymentCurrency':_0x29b225[_0x281ffd(0x17b)],'shopId':_0x29b225['shopId'],'createdAt':_0x29b225[_0x281ffd(0x16a)]}),await database_1[_0x281ffd(0x1d5)][_0x281ffd(0x243)][_0x281ffd(0x244)]({'data':{'paymentId':_0x29b225['id'],'shopId':_0x29b225[_0x281ffd(0x24f)],'event':_0x281ffd(0x227),'statusCode':0x1f4,'responseBody':JSON[_0x281ffd(0x1f4)]({'error':_0x5b4e08 instanceof Error?_0x5b4e08[_0x281ffd(0x1e5)]:'Unknown\x20error','gatewayPaymentId':_0x29b225[_0x281ffd(0x21b)],'checkedAt':new Date()[_0x281ffd(0x1ba)]()})}});}}async['sendShopWebhook'](_0x32c2d8,_0x571c92){const _0x1f055f=a37_0x285132,_0x2e8de0=Date['now']();try{const _0xec14e3=_0x32c2d8[_0x1f055f(0x1ef)],_0x37346f=_0xec14e3[_0x1f055f(0x1fa)];if(!_0x37346f?.[_0x1f055f(0x1cb)]){console[_0x1f055f(0x1bc)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0xec14e3['id']);return;}const _0x441eb3=_0x571c92==='PAID'?_0x1f055f(0x22f):_0x571c92===_0x1f055f(0x1a8)?_0x1f055f(0x20e):_0x571c92===_0x1f055f(0x242)?_0x1f055f(0x20e):_0x1f055f(0x1c9);if(!_0x37346f[_0x1f055f(0x245)]?.['includes'](_0x441eb3)){console['log'](_0x1f055f(0x1b5)+_0x441eb3+_0x1f055f(0x1f7)+_0xec14e3['id']);return;}const _0x5262cc={'event':_0x441eb3,'payment':{'id':_0x32c2d8['id'],'order_id':_0x32c2d8[_0x1f055f(0x17f)],'gateway_order_id':_0x32c2d8[_0x1f055f(0x185)],'gateway':'0100','amount':_0x32c2d8[_0x1f055f(0x221)],'currency':_0x32c2d8[_0x1f055f(0x17b)],'status':_0x571c92[_0x1f055f(0x1de)](),'customer_email':_0x32c2d8[_0x1f055f(0x16b)],'customer_name':_0x32c2d8[_0x1f055f(0x24d)],'created_at':_0x32c2d8[_0x1f055f(0x16a)],'updated_at':new Date()}},_0x3ee6b0=await fetch(_0x37346f[_0x1f055f(0x1cb)],{'method':_0x1f055f(0x20f),'headers':{'Content-Type':_0x1f055f(0x187),'User-Agent':_0x1f055f(0x1e0)},'body':JSON[_0x1f055f(0x1f4)](_0x5262cc)}),_0x178d3a=Date[_0x1f055f(0x24a)]()-_0x2e8de0,_0x479f97=_0x3ee6b0['ok']?'Success':await _0x3ee6b0['text']();loggerService_1[_0x1f055f(0x164)][_0x1f055f(0x198)](_0x32c2d8[_0x1f055f(0x24f)],_0x37346f[_0x1f055f(0x1cb)],_0x441eb3,_0x3ee6b0[_0x1f055f(0x1ff)],_0x178d3a,_0x5262cc),console[_0x1f055f(0x1bc)](_0x1f055f(0x1f3)+_0x37346f['webhookUrl']+_0x1f055f(0x17e)+_0x3ee6b0[_0x1f055f(0x1ff)]+'\x20('+_0x178d3a+_0x1f055f(0x202));}catch(_0x107b60){console[_0x1f055f(0x238)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x107b60),loggerService_1['loggerService'][_0x1f055f(0x234)](_0x32c2d8[_0x1f055f(0x24f)],_0x32c2d8[_0x1f055f(0x1ef)]?.[_0x1f055f(0x1fa)]?.['webhookUrl']||_0x1f055f(0x217),_0x1f055f(0x209),_0x107b60,{});}}async['sendPaymentStatusNotification'](_0x5db88b,_0x48c77e){const _0x3bbed5=a37_0x285132;try{const _0x45c09f={'PENDING':_0x3bbed5(0x1ca),'PAID':_0x3bbed5(0x18b),'FAILED':_0x3bbed5(0x1d9),'EXPIRED':'expired'},_0x4e0783=_0x45c09f[_0x48c77e];if(!_0x4e0783||_0x4e0783===_0x3bbed5(0x1ca))return;await telegramBotService_1['telegramBotService'][_0x3bbed5(0x1dc)](_0x5db88b[_0x3bbed5(0x24f)],_0x5db88b,_0x4e0783);}catch(_0x9857a3){console['error'](_0x3bbed5(0x23c),_0x9857a3);}}async['checkPaymentById'](_0x5287b9){const _0x577f1b=a37_0x285132;console[_0x577f1b(0x1bc)](_0x577f1b(0x215)+_0x5287b9);const _0x513c0e=await database_1[_0x577f1b(0x1d5)][_0x577f1b(0x1ee)][_0x577f1b(0x219)]({'where':{'id':_0x5287b9},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x513c0e)throw new Error(_0x577f1b(0x180));if(_0x513c0e[_0x577f1b(0x207)]!==_0x577f1b(0x222))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console['log'](_0x577f1b(0x1df)+_0x5287b9),await this['checkSinglePayment'](_0x513c0e),console[_0x577f1b(0x1bc)](_0x577f1b(0x240)+_0x5287b9);}[a37_0x285132(0x1b9)](){const _0x4ccf53=a37_0x285132,_0x27b589=this[_0x4ccf53(0x174)]?this[_0x4ccf53(0x1e3)]:undefined,_0xe4977f=Array[_0x4ccf53(0x22a)](this['paymentTimers'][_0x4ccf53(0x208)]())[_0x4ccf53(0x20b)](_0x2052d4=>({'paymentId':_0x2052d4[_0x4ccf53(0x235)],'gatewayPaymentId':_0x2052d4[_0x4ccf53(0x21b)],'createdAt':_0x2052d4[_0x4ccf53(0x16a)],'timersCount':_0x2052d4[_0x4ccf53(0x196)][_0x4ccf53(0x210)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x4ccf53(0x1e3)]/(0x3e8*0x3c),'expiryDays':this[_0x4ccf53(0x1be)],'activeIndividualTimers':this['paymentTimers'][_0x4ccf53(0x20d)],'nextGlobalCheckIn':_0x27b589,'paymentTimersDetails':_0xe4977f};}[a37_0x285132(0x176)](_0x44ee8b){const _0x1d2da9=a37_0x285132,_0x1e0cce=this[_0x1d2da9(0x1bb)]['get'](_0x44ee8b);if(_0x1e0cce)return{'hasTimers':!![],'timersCount':_0x1e0cce[_0x1d2da9(0x196)][_0x1d2da9(0x210)],'createdAt':_0x1e0cce['createdAt'],'gatewayPaymentId':_0x1e0cce['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a37_0x285132(0x218)]=CoinToPayStatusService,exports[a37_0x285132(0x1ed)]=new CoinToPayStatusService();