'use strict';const a35_0x560051=a35_0x4126;(function(_0x3cbe0c,_0x3ed244){const _0x19163f=a35_0x4126,_0x379a8c=_0x3cbe0c();while(!![]){try{const _0x35c135=parseInt(_0x19163f(0x225))/0x1*(-parseInt(_0x19163f(0x1fb))/0x2)+parseInt(_0x19163f(0x1cf))/0x3+-parseInt(_0x19163f(0x23e))/0x4+parseInt(_0x19163f(0x1f9))/0x5+parseInt(_0x19163f(0x260))/0x6+parseInt(_0x19163f(0x1b8))/0x7+parseInt(_0x19163f(0x251))/0x8*(-parseInt(_0x19163f(0x211))/0x9);if(_0x35c135===_0x3ed244)break;else _0x379a8c['push'](_0x379a8c['shift']());}catch(_0x5553f9){_0x379a8c['push'](_0x379a8c['shift']());}}}(a35_0x4b96,0xe8acd));function a35_0x4126(_0x177473,_0x2ebc5e){const _0x4b9608=a35_0x4b96();return a35_0x4126=function(_0x41265e,_0x4cae4c){_0x41265e=_0x41265e-0x182;let _0x206d8b=_0x4b9608[_0x41265e];return _0x206d8b;},a35_0x4126(_0x177473,_0x2ebc5e);}function a35_0x4b96(){const _0x34778b=['\x20\x20\x20‚ùå\x20Error:\x20','TesSoft\x20Payment\x20System/1.0','map','\x20current\x20status:\x20','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','now','\x20status\x20from\x20','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','transactionId','toLowerCase','from','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','auto_expire','\x20pending\x20CoinToPay\x20payments','values','ü™ô\x20[GLOBAL]\x20Found\x20','\x20status:\x20','expired','checkSinglePaymentById','\x20status\x20unchanged\x20(','../config/database','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','currency','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','findMany','paid','\x20\x20\x20-\x20GatewayPaymentId:\x20','‚è∞\x20[HOURLY]\x20Payment\x20','paymentId','ms)','COINTOPAY_ERROR','5550425sgfBkp','includes','121382gEYEhC','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20\x20\x20-\x20Status:\x20','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20is\x20too\x20new\x20(','Unknown\x20error','telegramBotService','./loggerService','\x20days\x20without\x20payment\x20confirmation','‚úÖ\x20[CHECK]\x20Payment\x20','getTime','\x20checked,\x20','toFixed','floor','cointopay','GLOBAL_CHECK_INTERVAL_MS',',\x20stopping\x20individual\x20checks','5\x20minutes','üí∞\x20[CHECK]\x20Payment\x20','/status/','\x20in\x20','findUnique','45RSDcux','\x20\x20\x20-\x20paymentId:\x20','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','size','üßπ\x20[CHECK]\x20Payment\x20','adminNotes','\x20seconds\x20(','has','\x20days\x20(created\x20before\x20','__esModule','\x20not\x20found\x20in\x20database','clearPaymentTimers','\x20updated\x20successfully','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','logCoinToPayError','\x20completed\x20for\x20payment\x20','defineProperty','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','PENDING','orderId','31AwfknX','\x20with\x20status\x20','Success','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','default','status','\x20is\x20older\x20than\x20','Payment\x20older\x20than\x20','toISOString','payment.success','gatewayPaymentId','delete','‚úÖ\x20[HOURLY]\x20Payment\x20','get','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','not\x20confirmed','status_check','POST','settings','unknown','__importDefault','create','Failed\x20to\x20mark\x20payment\x20as\x20expired','sendPaymentNotification','2282512saRbpI','coinToPayService','paidAt','webhookUrl','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20found:','Payment\x20not\x20found','payment','setDate','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20not\x20enabled\x20for\x20shop\x20','message','getServiceStats','sendShopWebhook','schedulePaymentChecks','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','\x20\x20\x20üìä\x20Status:\x20','checkPaymentById','1\x20minute','1510136VCqVhD','customerName','Shop\x20webhook\x20sent\x20to\x20','\x20\x20\x20üìù\x20Details:','.\x20Remaining\x20active\x20timers:\x20','\x20to\x20clear','\x20triggered\x20for\x20payment\x20','‚ùå\x20[CHECK]\x20Payment\x20','‚è∞\x20[GLOBAL]\x20Payment\x20','remitterIban','checkSinglePayment','Webhook\x20event\x20','coinToPayStatusService','stack','createdOn','11067918gSMPdr','globalCheckInterval','Bank\x20Details:\x20','shopId','amount','createdAt','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20\x20\x20-\x20Gateway:\x20','\x20to\x20','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','gateway','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20has\x20no\x20gatewayPaymentId',',\x20clearing\x20individual\x20timers','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','üõë\x20[SHUTDOWN]\x20Cleared\x20','CoinToPayService','iban','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','loggerService','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','ü™ô\x20[DEBUG]\x20Creating\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20(after\x20','-day\x20timeout','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','COINTOPAY_STATUS_CHANGE','catch','üìä\x20[HOURLY]\x20Payment\x20','CoinToPayStatusService','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','Automatically\x20expired\x20after\x20','\x20\x20\x20-\x20ShopId:\x20','EXPIRY_DAYS','‚úÖ\x20[EXPIRY]\x20Payment\x20','\x20(age:\x20','stopPeriodicStatusCheck','failed','\x20for\x20payment\x20','checkPaymentStatus','push','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','./telegramBotService','\x20->\x20','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','error','webhookLog','\x20status\x20changed\x20to\x20','created','\x20status\x20is\x20','paymentTimers','logCoinToPayStatus','‚ùå\x20[HOURLY]\x20Payment\x20','timestamp','logShopWebhookSent','startPeriodicStatusCheck','delay','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','payment.failed','Failed\x20to\x20send\x20shop\x20webhook:','log','bankDetails','length','update','6356784lLthTT','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','PAID','checkExpiredPayments','checkAllPendingPayments','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20expired','gatewayOrderId','\x20\x20\x20üìç\x20Source:\x20','description','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','webhookEvents','application/json','stringify','./gateways/coinToPayService','sendPaymentStatusNotification','üìä\x20[CHECK]\x20Payment\x20','\x20days','paymentDetails','timers','shop','\x20\x20\x20üìÖ\x20Time:\x20','\x20initial\x20timers\x20for\x20payment\x20','1458213vCiHgb','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20timers\x20for\x20payment\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','schedule_created','cointopay_status_check_','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','forEach','EXPIRED'];a35_0x4b96=function(){return _0x34778b;};return a35_0x4b96();}var __importDefault=this&&this[a35_0x560051(0x23a)]||function(_0x307ecc){const _0x3394ed=a35_0x560051;return _0x307ecc&&_0x307ecc[_0x3394ed(0x21a)]?_0x307ecc:{'default':_0x307ecc};};Object[a35_0x560051(0x221)](exports,a35_0x560051(0x21a),{'value':!![]}),exports[a35_0x560051(0x25d)]=exports[a35_0x560051(0x194)]=void 0x0;const coinToPayService_1=require(a35_0x560051(0x1c6)),database_1=__importDefault(require(a35_0x560051(0x1ee))),telegramBotService_1=require(a35_0x560051(0x1a2)),loggerService_1=require(a35_0x560051(0x202));class CoinToPayStatusService{constructor(){const _0x5d5689=a35_0x560051;this[_0x5d5689(0x261)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x5d5689(0x199)]=0x5,this['paymentTimers']=new Map(),this[_0x5d5689(0x23f)]=new coinToPayService_1[(_0x5d5689(0x186))](),console['log']('ü™ô\x20CoinToPayStatusService\x20initialized');}[a35_0x560051(0x24c)](_0x19e129,_0x1cb4e9){const _0x271c02=a35_0x560051;console[_0x271c02(0x1b4)](_0x271c02(0x1a4)),console[_0x271c02(0x1b4)](_0x271c02(0x212)+_0x19e129),console['log'](_0x271c02(0x1d2)+_0x1cb4e9),this[_0x271c02(0x21c)](_0x19e129);const _0x41be83=[],_0x41e642=new Date(),_0x31cf5f=[{'delay':0x1*0x3c*0x3e8,'description':_0x271c02(0x250)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x271c02(0x20c)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x271c02(0x1b4)](_0x271c02(0x18b)+_0x31cf5f[_0x271c02(0x1b6)]+_0x271c02(0x1ce)+_0x19e129);let _0x50a049=0x0;_0x31cf5f['forEach']((_0xce34b5,_0x303248)=>{const _0x4327a2=_0x271c02;_0x50a049+=_0xce34b5[_0x4327a2(0x1b0)];const _0x46c30e=setTimeout(async()=>{const _0x7e636f=_0x4327a2;console[_0x7e636f(0x1b4)](_0x7e636f(0x26b)+(_0x303248+0x1)+_0x7e636f(0x257)+_0x19e129+_0x7e636f(0x18e)+_0xce34b5[_0x7e636f(0x1c1)]+')');try{await this['checkSinglePaymentById'](_0x19e129),console['log'](_0x7e636f(0x184)+(_0x303248+0x1)+_0x7e636f(0x220)+_0x19e129);}catch(_0x402d30){console['error']('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x303248+0x1)+_0x7e636f(0x19e)+_0x19e129+':',_0x402d30),this[_0x7e636f(0x21f)](_0x19e129,_0x1cb4e9,_0x402d30,_0x7e636f(0x236),{'checkNumber':_0x303248+0x1,'scheduledAfter':_0xce34b5[_0x7e636f(0x1c1)],'isIndividualCheck':!![]});}},_0x50a049);_0x41be83['push'](_0x46c30e),console['log']('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x303248+0x1)+'\x20for\x20payment\x20'+_0x19e129+_0x4327a2(0x20f)+_0x50a049/0x3e8+_0x4327a2(0x217)+_0xce34b5[_0x4327a2(0x1c1)]+')');});const _0x4b5b76=setInterval(async()=>{const _0x4e30b9=_0x271c02;console['log'](_0x4e30b9(0x18a)+_0x19e129);try{const _0x20d5aa=await database_1[_0x4e30b9(0x229)]['payment']['findUnique']({'where':{'id':_0x19e129},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x20d5aa){console[_0x4e30b9(0x1b4)](_0x4e30b9(0x1ac)+_0x19e129+'\x20not\x20found,\x20clearing\x20timers'),this[_0x4e30b9(0x21c)](_0x19e129);return;}console[_0x4e30b9(0x1b4)](_0x4e30b9(0x193)+_0x19e129+_0x4e30b9(0x1db)+_0x20d5aa['status']);if(_0x20d5aa['status']!==_0x4e30b9(0x223)){console[_0x4e30b9(0x1b4)](_0x4e30b9(0x231)+_0x19e129+_0x4e30b9(0x1a9)+_0x20d5aa[_0x4e30b9(0x22a)]+_0x4e30b9(0x20b)),this[_0x4e30b9(0x21c)](_0x19e129);return;}const _0x1339e1=Math['floor']((Date[_0x4e30b9(0x1dd)]()-_0x20d5aa[_0x4e30b9(0x265)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x1339e1>=this[_0x4e30b9(0x199)]){console[_0x4e30b9(0x1b4)](_0x4e30b9(0x1f5)+_0x19e129+_0x4e30b9(0x22b)+this[_0x4e30b9(0x199)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this['clearPaymentTimers'](_0x19e129);return;}await this[_0x4e30b9(0x1ec)](_0x19e129),console[_0x4e30b9(0x1b4)](_0x4e30b9(0x195)+_0x19e129);}catch(_0xb88655){console[_0x4e30b9(0x1a5)](_0x4e30b9(0x1fe)+_0x19e129+':',_0xb88655),this[_0x4e30b9(0x21f)](_0x19e129,_0x1cb4e9,_0xb88655,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x41be83[_0x271c02(0x1a0)](_0x4b5b76),this[_0x271c02(0x1aa)]['set'](_0x19e129,{'timers':_0x41be83,'paymentId':_0x19e129,'gatewayPaymentId':_0x1cb4e9,'createdAt':_0x41e642}),console[_0x271c02(0x1b4)](_0x271c02(0x269)+_0x31cf5f[_0x271c02(0x1b6)]+_0x271c02(0x1a1)+_0x19e129),console[_0x271c02(0x1b4)]('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x271c02(0x1aa)][_0x271c02(0x214)]),this[_0x271c02(0x1ab)](_0x19e129,_0x1cb4e9,_0x271c02(0x223),_0x271c02(0x223),_0x271c02(0x236),{'action':_0x271c02(0x1d3),'scheduledChecks':_0x31cf5f[_0x271c02(0x1b6)],'firstCheckIn':_0x31cf5f[0x0][_0x271c02(0x1b0)]/0x3e8,'totalTimers':this[_0x271c02(0x1aa)][_0x271c02(0x214)]});}[a35_0x560051(0x21c)](_0x435ba5){const _0x1fd7c7=a35_0x560051,_0x1ded42=this['paymentTimers'][_0x1fd7c7(0x232)](_0x435ba5);_0x1ded42?(console[_0x1fd7c7(0x1b4)]('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x1ded42['timers'][_0x1fd7c7(0x1b6)]+_0x1fd7c7(0x1d1)+_0x435ba5),_0x1ded42[_0x1fd7c7(0x1cb)][_0x1fd7c7(0x1d6)]((_0x2851f2,_0x1f945e)=>{const _0x4979b9=_0x1fd7c7;_0x2851f2&&(clearTimeout(_0x2851f2),clearInterval(_0x2851f2),console['log']('üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x1f945e+0x1)+_0x4979b9(0x19e)+_0x435ba5));}),this[_0x1fd7c7(0x1aa)][_0x1fd7c7(0x230)](_0x435ba5),console[_0x1fd7c7(0x1b4)](_0x1fd7c7(0x222)+_0x435ba5+_0x1fd7c7(0x255)+this[_0x1fd7c7(0x1aa)][_0x1fd7c7(0x214)])):console[_0x1fd7c7(0x1b4)](_0x1fd7c7(0x233)+_0x435ba5+_0x1fd7c7(0x256));}async[a35_0x560051(0x1ec)](_0x1729bb){const _0x4399c7=a35_0x560051;console[_0x4399c7(0x1b4)](_0x4399c7(0x213)+_0x1729bb);const _0x3ef520=await database_1[_0x4399c7(0x229)]['payment'][_0x4399c7(0x210)]({'where':{'id':_0x1729bb},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3ef520){console[_0x4399c7(0x1b4)](_0x4399c7(0x258)+_0x1729bb+_0x4399c7(0x21b));return;}console[_0x4399c7(0x1b4)]('üìä\x20[CHECK]\x20Payment\x20'+_0x1729bb+_0x4399c7(0x243)),console[_0x4399c7(0x1b4)](_0x4399c7(0x267)+_0x3ef520[_0x4399c7(0x26a)]),console['log'](_0x4399c7(0x1fd)+_0x3ef520['status']),console[_0x4399c7(0x1b4)](_0x4399c7(0x1f4)+_0x3ef520['gatewayPaymentId']),console[_0x4399c7(0x1b4)]('\x20\x20\x20-\x20Amount:\x20'+_0x3ef520[_0x4399c7(0x264)]+'\x20'+_0x3ef520[_0x4399c7(0x1f0)]),console[_0x4399c7(0x1b4)](_0x4399c7(0x198)+_0x3ef520['shopId']);if(_0x3ef520[_0x4399c7(0x26a)]!=='cointopay'){console[_0x4399c7(0x1b4)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x1729bb+_0x4399c7(0x18c)+_0x3ef520[_0x4399c7(0x26a)]+')');return;}if(_0x3ef520[_0x4399c7(0x22a)]!==_0x4399c7(0x223)){console[_0x4399c7(0x1b4)](_0x4399c7(0x1c2)+_0x1729bb+_0x4399c7(0x1a9)+_0x3ef520[_0x4399c7(0x22a)]+_0x4399c7(0x20b)),this[_0x4399c7(0x21c)](_0x1729bb);return;}if(!_0x3ef520[_0x4399c7(0x22f)]){console[_0x4399c7(0x1b4)](_0x4399c7(0x1c2)+_0x1729bb+_0x4399c7(0x182));return;}console['log'](_0x4399c7(0x204)+_0x1729bb+_0x4399c7(0x247)),await this['checkSinglePayment'](_0x3ef520);}[a35_0x560051(0x1ab)](_0x243c56,_0x31d9d6,_0x2452bc,_0x3cc975,_0x450b3e,_0xa5fc41){const _0x520966=a35_0x560051,_0x2868a9={'type':_0x520966(0x191),'paymentId':_0x243c56,'gatewayPaymentId':_0x31d9d6,'oldStatus':_0x2452bc,'newStatus':_0x3cc975,'source':_0x450b3e,'timestamp':new Date()['toISOString'](),'details':_0xa5fc41||{}};loggerService_1[_0x520966(0x189)]['logCoinToPayStatus'](_0x2868a9),console[_0x520966(0x1b4)](_0x520966(0x24d)+_0x243c56+'\x20('+_0x31d9d6+')'),console['log'](_0x520966(0x24e)+_0x2452bc+_0x520966(0x1a3)+_0x3cc975),console[_0x520966(0x1b4)]('\x20\x20\x20üìç\x20Source:\x20'+_0x450b3e),console[_0x520966(0x1b4)](_0x520966(0x1cd)+_0x2868a9[_0x520966(0x1ad)]),_0xa5fc41&&console[_0x520966(0x1b4)](_0x520966(0x254),_0xa5fc41);}[a35_0x560051(0x21f)](_0x3581a1,_0x204545,_0x10df53,_0x3d1b0f,_0x203a31){const _0x1bb03e=a35_0x560051,_0x15a07f={'type':_0x1bb03e(0x1f8),'paymentId':_0x3581a1,'gatewayPaymentId':_0x204545,'error':_0x10df53 instanceof Error?{'message':_0x10df53[_0x1bb03e(0x249)],'stack':_0x10df53[_0x1bb03e(0x25e)]}:_0x10df53,'source':_0x3d1b0f,'timestamp':new Date()[_0x1bb03e(0x22d)](),'context':_0x203a31||{}};loggerService_1[_0x1bb03e(0x189)][_0x1bb03e(0x21f)](_0x15a07f),console[_0x1bb03e(0x1a5)]('ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x3581a1+'\x20('+_0x204545+')'),console[_0x1bb03e(0x1a5)](_0x1bb03e(0x1d8)+(_0x10df53 instanceof Error?_0x10df53['message']:_0x10df53)),console[_0x1bb03e(0x1a5)](_0x1bb03e(0x1c0)+_0x3d1b0f),console[_0x1bb03e(0x1a5)](_0x1bb03e(0x1cd)+_0x15a07f[_0x1bb03e(0x1ad)]),_0x203a31&&console[_0x1bb03e(0x1a5)]('\x20\x20\x20üìù\x20Context:',_0x203a31);}[a35_0x560051(0x1af)](){const _0x3595a6=a35_0x560051;console[_0x3595a6(0x1b4)](_0x3595a6(0x1e5)),this[_0x3595a6(0x1bc)]()[_0x3595a6(0x192)](_0x4e1217=>{const _0x174428=_0x3595a6;console['error'](_0x174428(0x1dc),_0x4e1217);}),this[_0x3595a6(0x261)]=setInterval(async()=>{const _0x412db3=_0x3595a6;try{console[_0x412db3(0x1b4)]('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this['checkAllPendingPayments'](),console[_0x412db3(0x1b4)](_0x412db3(0x190));}catch(_0x4d43c7){console[_0x412db3(0x1a5)](_0x412db3(0x1b1),_0x4d43c7);}},this[_0x3595a6(0x20a)]),console[_0x3595a6(0x1b4)]('‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a35_0x560051(0x19c)](){const _0x5393fa=a35_0x560051;console['log']('üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x5393fa(0x261)]&&(clearInterval(this[_0x5393fa(0x261)]),this['globalCheckInterval']=null,console[_0x5393fa(0x1b4)](_0x5393fa(0x26c)));const _0x98b518=this[_0x5393fa(0x1aa)][_0x5393fa(0x214)];for(const [_0x6b9c82]of this[_0x5393fa(0x1aa)]){this['clearPaymentTimers'](_0x6b9c82);}console[_0x5393fa(0x1b4)](_0x5393fa(0x185)+_0x98b518+'\x20individual\x20payment\x20timers');}async[a35_0x560051(0x1bc)](){const _0x1aea9d=a35_0x560051;try{console['log'](_0x1aea9d(0x1e0));const _0x21eba4=await database_1[_0x1aea9d(0x229)][_0x1aea9d(0x245)][_0x1aea9d(0x1f2)]({'where':{'gateway':_0x1aea9d(0x209),'status':_0x1aea9d(0x223),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x1aea9d(0x1b4)](_0x1aea9d(0x1e9)+_0x21eba4[_0x1aea9d(0x1b6)]+_0x1aea9d(0x1e7));if(_0x21eba4[_0x1aea9d(0x1b6)]===0x0){console['log'](_0x1aea9d(0x1b9));return;}const _0x404007=await this['checkExpiredPayments'](_0x21eba4);console[_0x1aea9d(0x1b4)]('‚è∞\x20[GLOBAL]\x20Found\x20'+_0x404007[_0x1aea9d(0x1b6)]+'\x20expired\x20CoinToPay\x20payments');let _0x4b355e=0x0,_0xf7a2e7=0x0;for(const _0x46df47 of _0x21eba4){try{if(_0x404007['includes'](_0x46df47['id'])){console['log'](_0x1aea9d(0x259)+_0x46df47['id']+_0x1aea9d(0x242)),_0xf7a2e7++;continue;}if(this['paymentTimers'][_0x1aea9d(0x218)](_0x46df47['id'])){console[_0x1aea9d(0x1b4)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x46df47['id']+_0x1aea9d(0x188)),_0xf7a2e7++;continue;}const _0x14941f=(Date[_0x1aea9d(0x1dd)]()-_0x46df47[_0x1aea9d(0x265)][_0x1aea9d(0x205)]())/(0x3e8*0x3c*0x3c);if(_0x14941f<0x1){console[_0x1aea9d(0x1b4)](_0x1aea9d(0x259)+_0x46df47['id']+_0x1aea9d(0x1ff)+_0x14941f['toFixed'](0x1)+'h),\x20skipping\x20global\x20check'),_0xf7a2e7++;continue;}console[_0x1aea9d(0x1b4)]('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x46df47['id']+_0x1aea9d(0x19b)+_0x14941f[_0x1aea9d(0x207)](0x1)+'h)'),await this['checkSinglePayment'](_0x46df47),_0x4b355e++,await new Promise(_0x47d584=>setTimeout(_0x47d584,0x7d0));}catch(_0x5287a0){console[_0x1aea9d(0x1a5)](_0x1aea9d(0x228)+_0x46df47['id']+':',_0x5287a0),this[_0x1aea9d(0x21f)](_0x46df47['id'],_0x46df47[_0x1aea9d(0x22f)]||'unknown',_0x5287a0,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x46df47[_0x1aea9d(0x264)],'paymentCurrency':_0x46df47['currency'],'shopId':_0x46df47[_0x1aea9d(0x263)],'createdAt':_0x46df47[_0x1aea9d(0x265)]}),loggerService_1[_0x1aea9d(0x189)]['logWhiteDomainError'](_0x1aea9d(0x209),_0x1aea9d(0x20e)+_0x46df47[_0x1aea9d(0x22f)],_0x5287a0);}}console[_0x1aea9d(0x1b4)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x4b355e+_0x1aea9d(0x206)+_0xf7a2e7+'\x20skipped,\x20'+_0x404007[_0x1aea9d(0x1b6)]+_0x1aea9d(0x1be));}catch(_0x11a9ba){console[_0x1aea9d(0x1a5)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x11a9ba);}}async[a35_0x560051(0x1bb)](_0x339bab){const _0x1cb10d=a35_0x560051,_0x364802=[],_0x50aef7=new Date();_0x50aef7[_0x1cb10d(0x246)](_0x50aef7['getDate']()-this['EXPIRY_DAYS']),console[_0x1cb10d(0x1b4)]('‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x1cb10d(0x199)]+_0x1cb10d(0x219)+_0x50aef7['toISOString']()+')');for(const _0x5ebffc of _0x339bab){if(_0x5ebffc['createdAt']<_0x50aef7){console['log'](_0x1cb10d(0x196)+_0x5ebffc['id']+_0x1cb10d(0x22b)+this[_0x1cb10d(0x199)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x1cb10d(0x1ab)](_0x5ebffc['id'],_0x5ebffc[_0x1cb10d(0x22f)]||'unknown',_0x1cb10d(0x223),_0x1cb10d(0x1d7),_0x1cb10d(0x1e6),{'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x5ebffc[_0x1cb10d(0x265)],'daysSinceCreation':Math[_0x1cb10d(0x208)]((Date[_0x1cb10d(0x1dd)]()-_0x5ebffc[_0x1cb10d(0x265)][_0x1cb10d(0x205)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x5ebffc[_0x1cb10d(0x264)],'paymentCurrency':_0x5ebffc[_0x1cb10d(0x1f0)],'shopId':_0x5ebffc['shopId']}),await database_1[_0x1cb10d(0x229)]['payment'][_0x1cb10d(0x1b7)]({'where':{'id':_0x5ebffc['id']},'data':{'status':_0x1cb10d(0x1d7),'updatedAt':new Date(),'adminNotes':_0x1cb10d(0x197)+this['EXPIRY_DAYS']+_0x1cb10d(0x203)}}),await database_1[_0x1cb10d(0x229)]['webhookLog'][_0x1cb10d(0x23b)]({'data':{'paymentId':_0x5ebffc['id'],'shopId':_0x5ebffc[_0x1cb10d(0x263)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x1cb10d(0x1c5)]({'reason':_0x1cb10d(0x22c)+this['EXPIRY_DAYS']+_0x1cb10d(0x1c9),'createdAt':_0x5ebffc[_0x1cb10d(0x265)],'expiredAt':new Date()[_0x1cb10d(0x22d)](),'daysSinceCreation':Math['floor']((Date[_0x1cb10d(0x1dd)]()-_0x5ebffc[_0x1cb10d(0x265)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x5ebffc,_0x1cb10d(0x1d7)),await this[_0x1cb10d(0x1c7)](_0x5ebffc,_0x1cb10d(0x1d7)),this[_0x1cb10d(0x21c)](_0x5ebffc['id']),_0x364802[_0x1cb10d(0x1a0)](_0x5ebffc['id']),console[_0x1cb10d(0x1b4)](_0x1cb10d(0x19a)+_0x5ebffc['id']+_0x1cb10d(0x21e)+this[_0x1cb10d(0x199)]+_0x1cb10d(0x18f));}catch(_0xad4c07){console[_0x1cb10d(0x1a5)](_0x1cb10d(0x1f1)+_0x5ebffc['id']+':',_0xad4c07),this[_0x1cb10d(0x21f)](_0x5ebffc['id'],_0x5ebffc[_0x1cb10d(0x22f)]||_0x1cb10d(0x239),_0xad4c07,_0x1cb10d(0x1e6),{'reason':_0x1cb10d(0x23c),'createdAt':_0x5ebffc[_0x1cb10d(0x265)],'daysSinceCreation':Math[_0x1cb10d(0x208)]((Date[_0x1cb10d(0x1dd)]()-_0x5ebffc['createdAt'][_0x1cb10d(0x205)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x364802;}async[a35_0x560051(0x25b)](_0x21a3f2){const _0x53859b=a35_0x560051;if(!_0x21a3f2['gatewayPaymentId']){console[_0x53859b(0x1b4)](_0x53859b(0x1c2)+_0x21a3f2['id']+_0x53859b(0x18d));return;}console[_0x53859b(0x1b4)](_0x53859b(0x1e4)+_0x21a3f2['id']+'\x20('+_0x21a3f2[_0x53859b(0x22f)]+')');try{const _0x41d419=await this[_0x53859b(0x23f)][_0x53859b(0x19f)](_0x21a3f2[_0x53859b(0x22f)]);console[_0x53859b(0x1b4)]('üìä\x20[CHECK]\x20Payment\x20'+_0x21a3f2['id']+_0x53859b(0x1ea)+_0x41d419['status']);_0x41d419[_0x53859b(0x1ca)]&&console[_0x53859b(0x1b4)](_0x53859b(0x1c8)+_0x21a3f2['id']+'\x20details:',{'iban':_0x41d419[_0x53859b(0x1ca)][_0x53859b(0x187)]||'not\x20found','transactionId':_0x41d419[_0x53859b(0x1ca)]['transactionId'],'createdOn':_0x41d419['paymentDetails'][_0x53859b(0x25f)],'confirmedOn':_0x41d419[_0x53859b(0x1ca)]['confirmedOn']||_0x53859b(0x235)});if(_0x41d419[_0x53859b(0x22a)]!==_0x21a3f2[_0x53859b(0x22a)]){console[_0x53859b(0x1b4)]('üîÑ\x20[CHECK]\x20Updating\x20payment\x20'+_0x21a3f2['id']+_0x53859b(0x1de)+_0x21a3f2['status']+_0x53859b(0x268)+_0x41d419[_0x53859b(0x22a)]),this[_0x53859b(0x1ab)](_0x21a3f2['id'],_0x21a3f2[_0x53859b(0x22f)],_0x21a3f2[_0x53859b(0x22a)],_0x41d419[_0x53859b(0x22a)],_0x53859b(0x236),{'paymentDetails':_0x41d419[_0x53859b(0x1ca)],'amount':_0x41d419[_0x53859b(0x264)],'currency':_0x41d419['currency'],'shopId':_0x21a3f2['shopId'],'checkTimestamp':new Date()[_0x53859b(0x22d)]()});const _0x287df6={'status':_0x41d419[_0x53859b(0x22a)],'updatedAt':new Date()};_0x41d419['status']===_0x53859b(0x1ba)&&_0x21a3f2[_0x53859b(0x22a)]!==_0x53859b(0x1ba)&&(_0x287df6['paidAt']=new Date(),console[_0x53859b(0x1b4)](_0x53859b(0x20d)+_0x21a3f2['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x287df6[_0x53859b(0x240)][_0x53859b(0x22d)]()));if(_0x41d419[_0x53859b(0x1ca)]){const _0x433b86=_0x41d419[_0x53859b(0x1ca)];_0x433b86['iban']&&(_0x287df6[_0x53859b(0x25a)]=_0x433b86[_0x53859b(0x187)],console['log'](_0x53859b(0x234)+_0x433b86[_0x53859b(0x187)]));if(_0x433b86['bankDetails']){const _0x11a045=_0x21a3f2[_0x53859b(0x216)]||'',_0x59655b=_0x53859b(0x262)+_0x433b86[_0x53859b(0x1b5)];_0x287df6[_0x53859b(0x216)]=_0x11a045?_0x11a045+'\x0a\x0a'+_0x59655b:_0x59655b,console['log'](_0x53859b(0x1fc));}_0x433b86['transactionId']&&console[_0x53859b(0x1b4)](_0x53859b(0x1ef)+_0x433b86[_0x53859b(0x1e1)]),_0x433b86['confirmedOn']&&console[_0x53859b(0x1b4)](_0x53859b(0x1df)+_0x433b86['confirmedOn']);}await database_1[_0x53859b(0x229)][_0x53859b(0x245)]['update']({'where':{'id':_0x21a3f2['id']},'data':_0x287df6}),await database_1[_0x53859b(0x229)][_0x53859b(0x1a6)][_0x53859b(0x23b)]({'data':{'paymentId':_0x21a3f2['id'],'shopId':_0x21a3f2[_0x53859b(0x263)],'event':_0x53859b(0x1d4)+_0x41d419[_0x53859b(0x22a)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x21a3f2['status'],'newStatus':_0x41d419[_0x53859b(0x22a)],'paymentDetails':_0x41d419[_0x53859b(0x1ca)],'checkedAt':new Date()[_0x53859b(0x22d)]()})}}),await this['sendShopWebhook'](_0x21a3f2,_0x41d419[_0x53859b(0x22a)]),await this[_0x53859b(0x1c7)](_0x21a3f2,_0x41d419[_0x53859b(0x22a)]),_0x41d419[_0x53859b(0x22a)]!==_0x53859b(0x223)&&(console['log'](_0x53859b(0x215)+_0x21a3f2['id']+_0x53859b(0x1a7)+_0x41d419[_0x53859b(0x22a)]+_0x53859b(0x183)),this[_0x53859b(0x21c)](_0x21a3f2['id'])),console[_0x53859b(0x1b4)](_0x53859b(0x204)+_0x21a3f2['id']+_0x53859b(0x21d));}else console[_0x53859b(0x1b4)](_0x53859b(0x1c8)+_0x21a3f2['id']+_0x53859b(0x1ed)+_0x41d419[_0x53859b(0x22a)]+')'),this[_0x53859b(0x1ab)](_0x21a3f2['id'],_0x21a3f2[_0x53859b(0x22f)],_0x21a3f2[_0x53859b(0x22a)],_0x41d419[_0x53859b(0x22a)],_0x53859b(0x236),{'statusUnchanged':!![],'paymentDetails':_0x41d419['paymentDetails'],'amount':_0x41d419['amount'],'currency':_0x41d419['currency'],'shopId':_0x21a3f2[_0x53859b(0x263)],'checkTimestamp':new Date()[_0x53859b(0x22d)]()});}catch(_0x5cd4c2){console[_0x53859b(0x1a5)](_0x53859b(0x266)+_0x21a3f2['id']+':',_0x5cd4c2),this[_0x53859b(0x21f)](_0x21a3f2['id'],_0x21a3f2['gatewayPaymentId'],_0x5cd4c2,_0x53859b(0x236),{'paymentAmount':_0x21a3f2['amount'],'paymentCurrency':_0x21a3f2[_0x53859b(0x1f0)],'shopId':_0x21a3f2[_0x53859b(0x263)],'createdAt':_0x21a3f2['createdAt']}),await database_1[_0x53859b(0x229)][_0x53859b(0x1a6)][_0x53859b(0x23b)]({'data':{'paymentId':_0x21a3f2['id'],'shopId':_0x21a3f2['shopId'],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x53859b(0x1c5)]({'error':_0x5cd4c2 instanceof Error?_0x5cd4c2[_0x53859b(0x249)]:_0x53859b(0x200),'gatewayPaymentId':_0x21a3f2[_0x53859b(0x22f)],'checkedAt':new Date()[_0x53859b(0x22d)]()})}});}}async[a35_0x560051(0x24b)](_0x191a53,_0x34cc1f){const _0x45b1e1=a35_0x560051,_0x4d475f=Date[_0x45b1e1(0x1dd)]();try{const _0x54879d=_0x191a53[_0x45b1e1(0x1cc)],_0x22e32e=_0x54879d['settings'];if(!_0x22e32e?.[_0x45b1e1(0x241)]){console[_0x45b1e1(0x1b4)](_0x45b1e1(0x1d0)+_0x54879d['id']);return;}const _0xbaed12=_0x34cc1f===_0x45b1e1(0x1ba)?_0x45b1e1(0x22e):_0x34cc1f==='FAILED'?'payment.failed':_0x34cc1f===_0x45b1e1(0x1d7)?_0x45b1e1(0x1b2):'payment.pending';if(!_0x22e32e[_0x45b1e1(0x1c3)]?.[_0x45b1e1(0x1fa)](_0xbaed12)){console[_0x45b1e1(0x1b4)](_0x45b1e1(0x25c)+_0xbaed12+_0x45b1e1(0x248)+_0x54879d['id']);return;}const _0xbee857={'event':_0xbaed12,'payment':{'id':_0x191a53['id'],'order_id':_0x191a53[_0x45b1e1(0x224)],'gateway_order_id':_0x191a53[_0x45b1e1(0x1bf)],'gateway':'0100','amount':_0x191a53['amount'],'currency':_0x191a53[_0x45b1e1(0x1f0)],'status':_0x34cc1f[_0x45b1e1(0x1e2)](),'customer_email':_0x191a53['customerEmail'],'customer_name':_0x191a53[_0x45b1e1(0x252)],'created_at':_0x191a53[_0x45b1e1(0x265)],'updated_at':new Date()}},_0x497396=await fetch(_0x22e32e[_0x45b1e1(0x241)],{'method':_0x45b1e1(0x237),'headers':{'Content-Type':_0x45b1e1(0x1c4),'User-Agent':_0x45b1e1(0x1d9)},'body':JSON[_0x45b1e1(0x1c5)](_0xbee857)}),_0x46223d=Date[_0x45b1e1(0x1dd)]()-_0x4d475f,_0xbf887c=_0x497396['ok']?_0x45b1e1(0x227):await _0x497396['text']();loggerService_1[_0x45b1e1(0x189)][_0x45b1e1(0x1ae)](_0x191a53['shopId'],_0x22e32e[_0x45b1e1(0x241)],_0xbaed12,_0x497396['status'],_0x46223d,_0xbee857),console[_0x45b1e1(0x1b4)](_0x45b1e1(0x253)+_0x22e32e[_0x45b1e1(0x241)]+_0x45b1e1(0x226)+_0x497396[_0x45b1e1(0x22a)]+'\x20('+_0x46223d+_0x45b1e1(0x1f7));}catch(_0x23d4d9){console[_0x45b1e1(0x1a5)](_0x45b1e1(0x1b3),_0x23d4d9),loggerService_1[_0x45b1e1(0x189)]['logShopWebhookError'](_0x191a53[_0x45b1e1(0x263)],_0x191a53[_0x45b1e1(0x1cc)]?.[_0x45b1e1(0x238)]?.[_0x45b1e1(0x241)]||'unknown','webhook_send',_0x23d4d9,{});}}async[a35_0x560051(0x1c7)](_0x55bef6,_0x393a25){const _0x302152=a35_0x560051;try{const _0x2e1004={'PENDING':_0x302152(0x1a8),'PAID':_0x302152(0x1f3),'FAILED':_0x302152(0x19d),'EXPIRED':_0x302152(0x1eb)},_0x133271=_0x2e1004[_0x393a25];if(!_0x133271||_0x133271===_0x302152(0x1a8))return;await telegramBotService_1[_0x302152(0x201)][_0x302152(0x23d)](_0x55bef6[_0x302152(0x263)],_0x55bef6,_0x133271);}catch(_0x11c5ea){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x11c5ea);}}async[a35_0x560051(0x24f)](_0x397e4e){const _0x41ca35=a35_0x560051;console[_0x41ca35(0x1b4)]('üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x397e4e);const _0x45451b=await database_1[_0x41ca35(0x229)][_0x41ca35(0x245)][_0x41ca35(0x210)]({'where':{'id':_0x397e4e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x45451b)throw new Error(_0x41ca35(0x244));if(_0x45451b['gateway']!==_0x41ca35(0x209))throw new Error(_0x41ca35(0x1bd));console['log'](_0x41ca35(0x1d5)+_0x397e4e),await this[_0x41ca35(0x25b)](_0x45451b),console[_0x41ca35(0x1b4)]('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x397e4e);}[a35_0x560051(0x24a)](){const _0xcff598=a35_0x560051,_0x497a4f=this[_0xcff598(0x261)]?this[_0xcff598(0x20a)]:undefined,_0x491bdf=Array[_0xcff598(0x1e3)](this[_0xcff598(0x1aa)][_0xcff598(0x1e8)]())[_0xcff598(0x1da)](_0x4a704e=>({'paymentId':_0x4a704e[_0xcff598(0x1f6)],'gatewayPaymentId':_0x4a704e['gatewayPaymentId'],'createdAt':_0x4a704e[_0xcff598(0x265)],'timersCount':_0x4a704e['timers'][_0xcff598(0x1b6)]}));return{'isActive':!!this[_0xcff598(0x261)],'globalCheckIntervalMinutes':this[_0xcff598(0x20a)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0xcff598(0x1aa)][_0xcff598(0x214)],'nextGlobalCheckIn':_0x497a4f,'paymentTimersDetails':_0x491bdf};}['getPaymentTimerInfo'](_0x286d2b){const _0x3411f5=a35_0x560051,_0x48dd95=this[_0x3411f5(0x1aa)][_0x3411f5(0x232)](_0x286d2b);if(_0x48dd95)return{'hasTimers':!![],'timersCount':_0x48dd95[_0x3411f5(0x1cb)][_0x3411f5(0x1b6)],'createdAt':_0x48dd95['createdAt'],'gatewayPaymentId':_0x48dd95[_0x3411f5(0x22f)]};return{'hasTimers':![]};}}exports[a35_0x560051(0x194)]=CoinToPayStatusService,exports[a35_0x560051(0x25d)]=new CoinToPayStatusService();