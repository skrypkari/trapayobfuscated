'use strict';const a37_0x2cd6b8=a37_0x2264;(function(_0x235285,_0x4df1b5){const _0x424bf6=a37_0x2264,_0x105981=_0x235285();while(!![]){try{const _0x424419=parseInt(_0x424bf6(0x164))/0x1+-parseInt(_0x424bf6(0xc8))/0x2*(parseInt(_0x424bf6(0x112))/0x3)+-parseInt(_0x424bf6(0x159))/0x4*(parseInt(_0x424bf6(0xd7))/0x5)+parseInt(_0x424bf6(0x134))/0x6*(-parseInt(_0x424bf6(0xbe))/0x7)+-parseInt(_0x424bf6(0xc1))/0x8+-parseInt(_0x424bf6(0xee))/0x9*(parseInt(_0x424bf6(0x16b))/0xa)+parseInt(_0x424bf6(0xd2))/0xb;if(_0x424419===_0x4df1b5)break;else _0x105981['push'](_0x105981['shift']());}catch(_0x9b3135){_0x105981['push'](_0x105981['shift']());}}}(a37_0x3557,0x714e5));var __importDefault=this&&this[a37_0x2cd6b8(0xb5)]||function(_0x53a623){return _0x53a623&&_0x53a623['__esModule']?_0x53a623:{'default':_0x53a623};};Object[a37_0x2cd6b8(0x121)](exports,a37_0x2cd6b8(0xe0),{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0x2cd6b8(0xa4)]=void 0x0;const coinToPayService_1=require(a37_0x2cd6b8(0xfe)),database_1=__importDefault(require(a37_0x2cd6b8(0x166))),telegramBotService_1=require(a37_0x2cd6b8(0x161)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x3cc921=a37_0x2cd6b8;this[_0x3cc921(0xbf)]=null,this[_0x3cc921(0x104)]=0x3c*0x3c*0x3e8,this[_0x3cc921(0x16d)]=0x5,this[_0x3cc921(0x13d)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x3cc921(0xe1))](),console['log']('🪙\x20CoinToPayStatusService\x20initialized');}['schedulePaymentChecks'](_0x3c3495,_0x26e503){const _0x582a48=a37_0x2cd6b8;console['log'](_0x582a48(0x129)),console[_0x582a48(0xfd)]('\x20\x20\x20-\x20paymentId:\x20'+_0x3c3495),console[_0x582a48(0xfd)](_0x582a48(0x14a)+_0x26e503),this[_0x582a48(0x107)](_0x3c3495);const _0x333e55=[],_0x44578b=new Date(),_0x298dee=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x582a48(0x16f)},{'delay':0x5*0x3c*0x3e8,'description':_0x582a48(0xf0)},{'delay':0x5*0x3c*0x3e8,'description':_0x582a48(0xf0)}];console[_0x582a48(0xfd)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x298dee[_0x582a48(0xab)]+_0x582a48(0xb7)+_0x3c3495);let _0x348fc5=0x0;_0x298dee[_0x582a48(0x12f)]((_0x9ed4b0,_0xcc8ddd)=>{const _0x54c761=_0x582a48;_0x348fc5+=_0x9ed4b0[_0x54c761(0x148)];const _0x159407=setTimeout(async()=>{const _0x56a87d=_0x54c761;console[_0x56a87d(0xfd)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0xcc8ddd+0x1)+_0x56a87d(0xf8)+_0x3c3495+'\x20(after\x20'+_0x9ed4b0[_0x56a87d(0x93)]+')');try{await this[_0x56a87d(0x9e)](_0x3c3495),console['log']('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0xcc8ddd+0x1)+'\x20completed\x20for\x20payment\x20'+_0x3c3495);}catch(_0x1907ff){console[_0x56a87d(0xce)](_0x56a87d(0x101)+(_0xcc8ddd+0x1)+_0x56a87d(0x147)+_0x3c3495+':',_0x1907ff),this[_0x56a87d(0xb8)](_0x3c3495,_0x26e503,_0x1907ff,_0x56a87d(0x132),{'checkNumber':_0xcc8ddd+0x1,'scheduledAfter':_0x9ed4b0[_0x56a87d(0x93)],'isIndividualCheck':!![]});}},_0x348fc5);_0x333e55['push'](_0x159407),console[_0x54c761(0xfd)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0xcc8ddd+0x1)+_0x54c761(0x147)+_0x3c3495+_0x54c761(0x11a)+_0x348fc5/0x3e8+_0x54c761(0xe8)+_0x9ed4b0['description']+')');});const _0x112d7c=setInterval(async()=>{const _0x1cdfb3=_0x582a48;console[_0x1cdfb3(0xfd)](_0x1cdfb3(0x149)+_0x3c3495);try{const _0x4f24e9=await database_1[_0x1cdfb3(0xc6)]['payment'][_0x1cdfb3(0xd4)]({'where':{'id':_0x3c3495},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x4f24e9){console[_0x1cdfb3(0xfd)](_0x1cdfb3(0x15c)+_0x3c3495+_0x1cdfb3(0xa3)),this[_0x1cdfb3(0x107)](_0x3c3495);return;}console['log'](_0x1cdfb3(0x125)+_0x3c3495+_0x1cdfb3(0x167)+_0x4f24e9[_0x1cdfb3(0x122)]);if(_0x4f24e9[_0x1cdfb3(0x122)]!==_0x1cdfb3(0x142)){console[_0x1cdfb3(0xfd)](_0x1cdfb3(0xb0)+_0x3c3495+_0x1cdfb3(0xd8)+_0x4f24e9[_0x1cdfb3(0x122)]+_0x1cdfb3(0xf1)),this[_0x1cdfb3(0x107)](_0x3c3495);return;}const _0x5b5527=Math[_0x1cdfb3(0x10d)]((Date[_0x1cdfb3(0x13b)]()-_0x4f24e9['createdAt'][_0x1cdfb3(0x160)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x5b5527>=this[_0x1cdfb3(0x16d)]){console['log'](_0x1cdfb3(0x154)+_0x3c3495+'\x20is\x20older\x20than\x20'+this[_0x1cdfb3(0x16d)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x1cdfb3(0x107)](_0x3c3495);return;}await this[_0x1cdfb3(0x9e)](_0x3c3495),console['log'](_0x1cdfb3(0xed)+_0x3c3495);}catch(_0x1fe963){console['error'](_0x1cdfb3(0x9b)+_0x3c3495+':',_0x1fe963),this[_0x1cdfb3(0xb8)](_0x3c3495,_0x26e503,_0x1fe963,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x333e55[_0x582a48(0xbb)](_0x112d7c),this[_0x582a48(0x13d)]['set'](_0x3c3495,{'timers':_0x333e55,'paymentId':_0x3c3495,'gatewayPaymentId':_0x26e503,'createdAt':_0x44578b}),console[_0x582a48(0xfd)](_0x582a48(0xa5)+_0x298dee[_0x582a48(0xab)]+_0x582a48(0xd5)+_0x3c3495),console[_0x582a48(0xfd)](_0x582a48(0xda)+this[_0x582a48(0x13d)][_0x582a48(0x111)]),this['logCoinToPayStatus'](_0x3c3495,_0x26e503,_0x582a48(0x142),_0x582a48(0x142),_0x582a48(0x132),{'action':_0x582a48(0x118),'scheduledChecks':_0x298dee[_0x582a48(0xab)],'firstCheckIn':_0x298dee[0x0][_0x582a48(0x148)]/0x3e8,'totalTimers':this['paymentTimers'][_0x582a48(0x111)]});}[a37_0x2cd6b8(0x107)](_0x7072d9){const _0x1332bc=a37_0x2cd6b8,_0x1bfd74=this[_0x1332bc(0x13d)][_0x1332bc(0x136)](_0x7072d9);_0x1bfd74?(console[_0x1332bc(0xfd)]('🧹\x20[DEBUG]\x20Clearing\x20'+_0x1bfd74[_0x1332bc(0x14f)][_0x1332bc(0xab)]+'\x20timers\x20for\x20payment\x20'+_0x7072d9),_0x1bfd74[_0x1332bc(0x14f)]['forEach']((_0x5b0306,_0x5c4b7f)=>{const _0xf29a74=_0x1332bc;_0x5b0306&&(clearTimeout(_0x5b0306),clearInterval(_0x5b0306),console[_0xf29a74(0xfd)]('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x5c4b7f+0x1)+_0xf29a74(0x147)+_0x7072d9));}),this[_0x1332bc(0x13d)][_0x1332bc(0x14e)](_0x7072d9),console[_0x1332bc(0xfd)](_0x1332bc(0xb1)+_0x7072d9+_0x1332bc(0xf4)+this[_0x1332bc(0x13d)][_0x1332bc(0x111)])):console['log'](_0x1332bc(0x11b)+_0x7072d9+'\x20to\x20clear');}async[a37_0x2cd6b8(0x9e)](_0x21ce90){const _0x3269a4=a37_0x2cd6b8;console[_0x3269a4(0xfd)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x21ce90);const _0x2b4e9f=await database_1[_0x3269a4(0xc6)][_0x3269a4(0xf6)][_0x3269a4(0xd4)]({'where':{'id':_0x21ce90},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2b4e9f){console[_0x3269a4(0xfd)](_0x3269a4(0x141)+_0x21ce90+_0x3269a4(0x11c));return;}console[_0x3269a4(0xfd)](_0x3269a4(0x165)+_0x21ce90+_0x3269a4(0xc3)),console[_0x3269a4(0xfd)]('\x20\x20\x20-\x20Gateway:\x20'+_0x2b4e9f[_0x3269a4(0x16e)]),console[_0x3269a4(0xfd)](_0x3269a4(0xf9)+_0x2b4e9f[_0x3269a4(0x122)]),console['log'](_0x3269a4(0xe3)+_0x2b4e9f[_0x3269a4(0xdb)]),console[_0x3269a4(0xfd)](_0x3269a4(0x9f)+_0x2b4e9f[_0x3269a4(0x12e)]+'\x20'+_0x2b4e9f[_0x3269a4(0x9c)]),console[_0x3269a4(0xfd)](_0x3269a4(0x100)+_0x2b4e9f['shopId']);if(_0x2b4e9f[_0x3269a4(0x16e)]!==_0x3269a4(0x94)){console['log'](_0x3269a4(0x14d)+_0x21ce90+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x2b4e9f[_0x3269a4(0x16e)]+')');return;}if(_0x2b4e9f[_0x3269a4(0x122)]!==_0x3269a4(0x142)){console[_0x3269a4(0xfd)](_0x3269a4(0x14d)+_0x21ce90+_0x3269a4(0xd8)+_0x2b4e9f[_0x3269a4(0x122)]+',\x20stopping\x20individual\x20checks'),this[_0x3269a4(0x107)](_0x21ce90);return;}if(!_0x2b4e9f['gatewayPaymentId']){console[_0x3269a4(0xfd)](_0x3269a4(0x14d)+_0x21ce90+_0x3269a4(0x98));return;}console[_0x3269a4(0xfd)](_0x3269a4(0xe6)+_0x21ce90+_0x3269a4(0xe2)),await this[_0x3269a4(0xa6)](_0x2b4e9f);}['logCoinToPayStatus'](_0x176eb3,_0x391c69,_0x5df033,_0x356c3a,_0x4ca8cc,_0x253b55){const _0xa3aea4=a37_0x2cd6b8,_0x3e4992={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x176eb3,'gatewayPaymentId':_0x391c69,'oldStatus':_0x5df033,'newStatus':_0x356c3a,'source':_0x4ca8cc,'timestamp':new Date()[_0xa3aea4(0xaf)](),'details':_0x253b55||{}};loggerService_1[_0xa3aea4(0x15e)]['logCoinToPayStatus'](_0x3e4992),console[_0xa3aea4(0xfd)](_0xa3aea4(0x109)+_0x176eb3+'\x20('+_0x391c69+')'),console[_0xa3aea4(0xfd)]('\x20\x20\x20📊\x20Status:\x20'+_0x5df033+_0xa3aea4(0xb2)+_0x356c3a),console[_0xa3aea4(0xfd)](_0xa3aea4(0x131)+_0x4ca8cc),console['log']('\x20\x20\x20📅\x20Time:\x20'+_0x3e4992[_0xa3aea4(0x12b)]),_0x253b55&&console['log'](_0xa3aea4(0x144),_0x253b55);}[a37_0x2cd6b8(0xb8)](_0x14f46f,_0x5a5feb,_0x283f54,_0x2a7671,_0x121875){const _0x3de57a=a37_0x2cd6b8,_0x56a448={'type':_0x3de57a(0xf3),'paymentId':_0x14f46f,'gatewayPaymentId':_0x5a5feb,'error':_0x283f54 instanceof Error?{'message':_0x283f54[_0x3de57a(0xc0)],'stack':_0x283f54['stack']}:_0x283f54,'source':_0x2a7671,'timestamp':new Date()[_0x3de57a(0xaf)](),'context':_0x121875||{}};loggerService_1[_0x3de57a(0x15e)]['logCoinToPayError'](_0x56a448),console['error'](_0x3de57a(0x97)+_0x14f46f+'\x20('+_0x5a5feb+')'),console[_0x3de57a(0xce)](_0x3de57a(0xc9)+(_0x283f54 instanceof Error?_0x283f54[_0x3de57a(0xc0)]:_0x283f54)),console[_0x3de57a(0xce)](_0x3de57a(0x131)+_0x2a7671),console[_0x3de57a(0xce)]('\x20\x20\x20📅\x20Time:\x20'+_0x56a448[_0x3de57a(0x12b)]),_0x121875&&console['error'](_0x3de57a(0xf5),_0x121875);}[a37_0x2cd6b8(0xc4)](){const _0x3c9312=a37_0x2cd6b8;console[_0x3c9312(0xfd)](_0x3c9312(0x12c)),this[_0x3c9312(0xba)]()[_0x3c9312(0xff)](_0x3d3643=>{const _0x416a4f=_0x3c9312;console['error'](_0x416a4f(0x99),_0x3d3643);}),this[_0x3c9312(0xbf)]=setInterval(async()=>{const _0x2c27d5=_0x3c9312;try{console['log'](_0x2c27d5(0xdf)),await this[_0x2c27d5(0xba)](),console[_0x2c27d5(0xfd)](_0x2c27d5(0x162));}catch(_0x48634a){console[_0x2c27d5(0xce)](_0x2c27d5(0x155),_0x48634a);}},this[_0x3c9312(0x104)]),console[_0x3c9312(0xfd)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}['stopPeriodicStatusCheck'](){const _0x4b0f70=a37_0x2cd6b8;console['log'](_0x4b0f70(0xea));this[_0x4b0f70(0xbf)]&&(clearInterval(this[_0x4b0f70(0xbf)]),this[_0x4b0f70(0xbf)]=null,console[_0x4b0f70(0xfd)](_0x4b0f70(0x152)));const _0x5737b7=this[_0x4b0f70(0x13d)][_0x4b0f70(0x111)];for(const [_0x5dc6ea]of this['paymentTimers']){this['clearPaymentTimers'](_0x5dc6ea);}console[_0x4b0f70(0xfd)](_0x4b0f70(0x171)+_0x5737b7+_0x4b0f70(0xaa));}async[a37_0x2cd6b8(0xba)](){const _0x144025=a37_0x2cd6b8;try{console[_0x144025(0xfd)](_0x144025(0xa8));const _0x1d1348=await database_1[_0x144025(0xc6)][_0x144025(0xf6)][_0x144025(0xcf)]({'where':{'gateway':_0x144025(0x94),'status':_0x144025(0x142),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x144025(0xfd)](_0x144025(0x157)+_0x1d1348[_0x144025(0xab)]+_0x144025(0xd3));if(_0x1d1348[_0x144025(0xab)]===0x0){console['log'](_0x144025(0x10f));return;}const _0x10e445=await this[_0x144025(0x139)](_0x1d1348);console[_0x144025(0xfd)](_0x144025(0x119)+_0x10e445[_0x144025(0xab)]+'\x20expired\x20CoinToPay\x20payments');let _0x23c334=0x0,_0x13a4eb=0x0;for(const _0x31a021 of _0x1d1348){try{if(_0x10e445['includes'](_0x31a021['id'])){console[_0x144025(0xfd)](_0x144025(0xbc)+_0x31a021['id']+_0x144025(0xfb)),_0x13a4eb++;continue;}if(this[_0x144025(0x13d)][_0x144025(0xdc)](_0x31a021['id'])){console[_0x144025(0xfd)](_0x144025(0xbc)+_0x31a021['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x13a4eb++;continue;}const _0x3c5b81=(Date['now']()-_0x31a021[_0x144025(0x123)][_0x144025(0x160)]())/(0x3e8*0x3c*0x3c);if(_0x3c5b81<0x1){console[_0x144025(0xfd)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x31a021['id']+_0x144025(0x116)+_0x3c5b81[_0x144025(0x14b)](0x1)+'h),\x20skipping\x20global\x20check'),_0x13a4eb++;continue;}console['log'](_0x144025(0x13a)+_0x31a021['id']+'\x20(age:\x20'+_0x3c5b81[_0x144025(0x14b)](0x1)+'h)'),await this[_0x144025(0xa6)](_0x31a021),_0x23c334++,await new Promise(_0x3e0b7f=>setTimeout(_0x3e0b7f,0x7d0));}catch(_0x282231){console[_0x144025(0xce)](_0x144025(0xb3)+_0x31a021['id']+':',_0x282231),this[_0x144025(0xb8)](_0x31a021['id'],_0x31a021[_0x144025(0xdb)]||_0x144025(0x12a),_0x282231,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x31a021[_0x144025(0x12e)],'paymentCurrency':_0x31a021[_0x144025(0x9c)],'shopId':_0x31a021[_0x144025(0xc2)],'createdAt':_0x31a021[_0x144025(0x123)]}),loggerService_1[_0x144025(0x15e)][_0x144025(0x127)](_0x144025(0x94),'/status/'+_0x31a021[_0x144025(0xdb)],_0x282231);}}console[_0x144025(0xfd)]('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x23c334+_0x144025(0xcb)+_0x13a4eb+_0x144025(0xc5)+_0x10e445[_0x144025(0xab)]+_0x144025(0xe9));}catch(_0x3bb2bd){console[_0x144025(0xce)](_0x144025(0x117),_0x3bb2bd);}}async[a37_0x2cd6b8(0x139)](_0x32ddb8){const _0x16209d=a37_0x2cd6b8,_0x28bf38=[],_0x227577=new Date();_0x227577[_0x16209d(0x128)](_0x227577[_0x16209d(0xeb)]()-this['EXPIRY_DAYS']),console['log'](_0x16209d(0x150)+this[_0x16209d(0x16d)]+_0x16209d(0xae)+_0x227577[_0x16209d(0xaf)]()+')');for(const _0x19f8af of _0x32ddb8){if(_0x19f8af['createdAt']<_0x227577){console[_0x16209d(0xfd)](_0x16209d(0x16c)+_0x19f8af['id']+_0x16209d(0x169)+this['EXPIRY_DAYS']+_0x16209d(0x173));try{this[_0x16209d(0xf7)](_0x19f8af['id'],_0x19f8af[_0x16209d(0xdb)]||'unknown',_0x16209d(0x142),_0x16209d(0xd0),'auto_expire',{'reason':_0x16209d(0xd9)+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x19f8af[_0x16209d(0x123)],'daysSinceCreation':Math[_0x16209d(0x10d)]((Date[_0x16209d(0x13b)]()-_0x19f8af['createdAt'][_0x16209d(0x160)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x19f8af[_0x16209d(0x12e)],'paymentCurrency':_0x19f8af[_0x16209d(0x9c)],'shopId':_0x19f8af[_0x16209d(0xc2)]}),await database_1[_0x16209d(0xc6)]['payment']['update']({'where':{'id':_0x19f8af['id']},'data':{'status':_0x16209d(0xd0),'updatedAt':new Date(),'adminNotes':_0x16209d(0x13f)+this[_0x16209d(0x16d)]+_0x16209d(0x103)}}),await database_1[_0x16209d(0xc6)][_0x16209d(0xb4)][_0x16209d(0x120)]({'data':{'paymentId':_0x19f8af['id'],'shopId':_0x19f8af[_0x16209d(0xc2)],'event':_0x16209d(0x170),'statusCode':0xc8,'responseBody':JSON[_0x16209d(0xa0)]({'reason':_0x16209d(0xd9)+this[_0x16209d(0x16d)]+_0x16209d(0xe7),'createdAt':_0x19f8af['createdAt'],'expiredAt':new Date()[_0x16209d(0xaf)](),'daysSinceCreation':Math[_0x16209d(0x10d)]((Date[_0x16209d(0x13b)]()-_0x19f8af[_0x16209d(0x123)][_0x16209d(0x160)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x19f8af,_0x16209d(0xd0)),await this[_0x16209d(0xa2)](_0x19f8af,'EXPIRED'),this[_0x16209d(0x107)](_0x19f8af['id']),_0x28bf38[_0x16209d(0xbb)](_0x19f8af['id']),console[_0x16209d(0xfd)](_0x16209d(0x124)+_0x19f8af['id']+_0x16209d(0xf2)+this[_0x16209d(0x16d)]+_0x16209d(0x143));}catch(_0x385814){console['error']('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x19f8af['id']+':',_0x385814),this[_0x16209d(0xb8)](_0x19f8af['id'],_0x19f8af[_0x16209d(0xdb)]||_0x16209d(0x12a),_0x385814,_0x16209d(0x151),{'reason':_0x16209d(0x133),'createdAt':_0x19f8af[_0x16209d(0x123)],'daysSinceCreation':Math[_0x16209d(0x10d)]((Date['now']()-_0x19f8af['createdAt'][_0x16209d(0x160)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x28bf38;}async[a37_0x2cd6b8(0xa6)](_0x402b29){const _0x33c2b7=a37_0x2cd6b8;if(!_0x402b29[_0x33c2b7(0xdb)]){console['log'](_0x33c2b7(0x14d)+_0x402b29['id']+_0x33c2b7(0x92));return;}console[_0x33c2b7(0xfd)](_0x33c2b7(0x11e)+_0x402b29['id']+'\x20('+_0x402b29['gatewayPaymentId']+')');try{const _0x14a828=await this[_0x33c2b7(0xac)][_0x33c2b7(0x102)](_0x402b29[_0x33c2b7(0xdb)]);console[_0x33c2b7(0xfd)](_0x33c2b7(0x165)+_0x402b29['id']+_0x33c2b7(0x137)+_0x14a828['status']);_0x14a828[_0x33c2b7(0xad)]&&console[_0x33c2b7(0xfd)]('📊\x20[CHECK]\x20Payment\x20'+_0x402b29['id']+'\x20details:',{'iban':_0x14a828[_0x33c2b7(0xad)][_0x33c2b7(0xb9)]||'not\x20found','transactionId':_0x14a828[_0x33c2b7(0xad)][_0x33c2b7(0x110)],'createdOn':_0x14a828[_0x33c2b7(0xad)]['createdOn'],'confirmedOn':_0x14a828[_0x33c2b7(0xad)]['confirmedOn']||_0x33c2b7(0x9d)});if(_0x14a828[_0x33c2b7(0x122)]!==_0x402b29[_0x33c2b7(0x122)]){console[_0x33c2b7(0xfd)](_0x33c2b7(0x10a)+_0x402b29['id']+_0x33c2b7(0x156)+_0x402b29['status']+_0x33c2b7(0x158)+_0x14a828[_0x33c2b7(0x122)]),this[_0x33c2b7(0xf7)](_0x402b29['id'],_0x402b29['gatewayPaymentId'],_0x402b29[_0x33c2b7(0x122)],_0x14a828[_0x33c2b7(0x122)],_0x33c2b7(0x132),{'paymentDetails':_0x14a828['paymentDetails'],'amount':_0x14a828[_0x33c2b7(0x12e)],'currency':_0x14a828[_0x33c2b7(0x9c)],'shopId':_0x402b29[_0x33c2b7(0xc2)],'checkTimestamp':new Date()[_0x33c2b7(0xaf)]()});const _0x45aeed={'status':_0x14a828['status'],'updatedAt':new Date()};_0x14a828[_0x33c2b7(0x122)]===_0x33c2b7(0x11f)&&_0x402b29[_0x33c2b7(0x122)]!==_0x33c2b7(0x11f)&&(_0x45aeed['paidAt']=new Date(),console['log']('💰\x20[CHECK]\x20Payment\x20'+_0x402b29['id']+_0x33c2b7(0xa9)+_0x45aeed[_0x33c2b7(0xcd)][_0x33c2b7(0xaf)]()));if(_0x14a828[_0x33c2b7(0xad)]){const _0x4bd093=_0x14a828['paymentDetails'];_0x4bd093[_0x33c2b7(0xb9)]&&(_0x45aeed['remitterIban']=_0x4bd093[_0x33c2b7(0xb9)],console['log']('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x4bd093[_0x33c2b7(0xb9)]));if(_0x4bd093['bankDetails']){const _0x262e8b=_0x402b29[_0x33c2b7(0x106)]||'',_0x2b6343=_0x33c2b7(0x135)+_0x4bd093[_0x33c2b7(0x9a)];_0x45aeed[_0x33c2b7(0x106)]=_0x262e8b?_0x262e8b+'\x0a\x0a'+_0x2b6343:_0x2b6343,console[_0x33c2b7(0xfd)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x4bd093[_0x33c2b7(0x110)]&&console['log'](_0x33c2b7(0xd6)+_0x4bd093[_0x33c2b7(0x110)]),_0x4bd093['confirmedOn']&&console['log'](_0x33c2b7(0xde)+_0x4bd093[_0x33c2b7(0xc7)]);}await database_1[_0x33c2b7(0xc6)][_0x33c2b7(0xf6)][_0x33c2b7(0x113)]({'where':{'id':_0x402b29['id']},'data':_0x45aeed}),await database_1[_0x33c2b7(0xc6)][_0x33c2b7(0xb4)]['create']({'data':{'paymentId':_0x402b29['id'],'shopId':_0x402b29['shopId'],'event':'cointopay_status_check_'+_0x14a828[_0x33c2b7(0x122)][_0x33c2b7(0xe4)](),'statusCode':0xc8,'responseBody':JSON[_0x33c2b7(0xa0)]({'oldStatus':_0x402b29[_0x33c2b7(0x122)],'newStatus':_0x14a828[_0x33c2b7(0x122)],'paymentDetails':_0x14a828[_0x33c2b7(0xad)],'checkedAt':new Date()[_0x33c2b7(0xaf)]()})}}),await this['sendShopWebhook'](_0x402b29,_0x14a828[_0x33c2b7(0x122)]),await this['sendPaymentStatusNotification'](_0x402b29,_0x14a828['status']),_0x14a828[_0x33c2b7(0x122)]!==_0x33c2b7(0x142)&&(console['log'](_0x33c2b7(0x130)+_0x402b29['id']+_0x33c2b7(0xfa)+_0x14a828['status']+',\x20clearing\x20individual\x20timers'),this[_0x33c2b7(0x107)](_0x402b29['id'])),console['log'](_0x33c2b7(0xe6)+_0x402b29['id']+_0x33c2b7(0xe5));}else console[_0x33c2b7(0xfd)]('📊\x20[CHECK]\x20Payment\x20'+_0x402b29['id']+_0x33c2b7(0x15f)+_0x14a828[_0x33c2b7(0x122)]+')'),this[_0x33c2b7(0xf7)](_0x402b29['id'],_0x402b29[_0x33c2b7(0xdb)],_0x402b29[_0x33c2b7(0x122)],_0x14a828['status'],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x14a828[_0x33c2b7(0xad)],'amount':_0x14a828[_0x33c2b7(0x12e)],'currency':_0x14a828[_0x33c2b7(0x9c)],'shopId':_0x402b29[_0x33c2b7(0xc2)],'checkTimestamp':new Date()[_0x33c2b7(0xaf)]()});}catch(_0x33854a){console[_0x33c2b7(0xce)]('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x402b29['id']+':',_0x33854a),this[_0x33c2b7(0xb8)](_0x402b29['id'],_0x402b29['gatewayPaymentId'],_0x33854a,_0x33c2b7(0x132),{'paymentAmount':_0x402b29[_0x33c2b7(0x12e)],'paymentCurrency':_0x402b29[_0x33c2b7(0x9c)],'shopId':_0x402b29[_0x33c2b7(0xc2)],'createdAt':_0x402b29['createdAt']}),await database_1[_0x33c2b7(0xc6)][_0x33c2b7(0xb4)]['create']({'data':{'paymentId':_0x402b29['id'],'shopId':_0x402b29[_0x33c2b7(0xc2)],'event':_0x33c2b7(0x146),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x33854a instanceof Error?_0x33854a['message']:_0x33c2b7(0x105),'gatewayPaymentId':_0x402b29[_0x33c2b7(0xdb)],'checkedAt':new Date()[_0x33c2b7(0xaf)]()})}});}}async[a37_0x2cd6b8(0x15b)](_0x2885d9,_0x62ac10){const _0x4638bc=a37_0x2cd6b8,_0x5c9395=Date[_0x4638bc(0x13b)]();try{const _0x3a627e=_0x2885d9['shop'],_0x3b7bc0=_0x3a627e[_0x4638bc(0x12d)];if(!_0x3b7bc0?.[_0x4638bc(0x15a)]){console[_0x4638bc(0xfd)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3a627e['id']);return;}const _0x48de9e=_0x62ac10==='PAID'?_0x4638bc(0x13c):_0x62ac10==='FAILED'?_0x4638bc(0xca):_0x62ac10==='EXPIRED'?_0x4638bc(0xca):_0x4638bc(0x138);if(!_0x3b7bc0['webhookEvents']?.[_0x4638bc(0x95)](_0x48de9e)){console[_0x4638bc(0xfd)]('Webhook\x20event\x20'+_0x48de9e+_0x4638bc(0xec)+_0x3a627e['id']);return;}const _0x6b9b37={'event':_0x48de9e,'payment':{'id':_0x2885d9['id'],'order_id':_0x2885d9[_0x4638bc(0x172)],'gateway_order_id':_0x2885d9[_0x4638bc(0x96)],'gateway':_0x4638bc(0x10b),'amount':_0x2885d9[_0x4638bc(0x12e)],'currency':_0x2885d9[_0x4638bc(0x9c)],'status':_0x62ac10['toLowerCase'](),'customer_email':_0x2885d9['customerEmail'],'customer_name':_0x2885d9[_0x4638bc(0xfc)],'created_at':_0x2885d9[_0x4638bc(0x123)],'updated_at':new Date()}},_0x4d0c3c=await fetch(_0x3b7bc0['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x4638bc(0xbd),'User-Agent':_0x4638bc(0x140)},'body':JSON[_0x4638bc(0xa0)](_0x6b9b37)}),_0x202696=Date[_0x4638bc(0x13b)]()-_0x5c9395,_0x5a2672=_0x4d0c3c['ok']?_0x4638bc(0x163):await _0x4d0c3c[_0x4638bc(0xd1)]();loggerService_1[_0x4638bc(0x15e)][_0x4638bc(0x168)](_0x2885d9['shopId'],_0x3b7bc0['webhookUrl'],_0x48de9e,_0x4d0c3c[_0x4638bc(0x122)],_0x202696,_0x6b9b37),console['log'](_0x4638bc(0xef)+_0x3b7bc0[_0x4638bc(0x15a)]+_0x4638bc(0x10e)+_0x4d0c3c['status']+'\x20('+_0x202696+'ms)');}catch(_0x37fceb){console[_0x4638bc(0xce)](_0x4638bc(0x14c),_0x37fceb),loggerService_1[_0x4638bc(0x15e)][_0x4638bc(0x145)](_0x2885d9[_0x4638bc(0xc2)],_0x2885d9['shop']?.[_0x4638bc(0x12d)]?.['webhookUrl']||'unknown',_0x4638bc(0x126),_0x37fceb,{});}}async[a37_0x2cd6b8(0xa2)](_0x115293,_0x22d4ed){const _0x1ad03c=a37_0x2cd6b8;try{const _0x45ae77={'PENDING':_0x1ad03c(0x153),'PAID':'paid','FAILED':_0x1ad03c(0x114),'EXPIRED':'expired'},_0x190df=_0x45ae77[_0x22d4ed];if(!_0x190df||_0x190df==='created')return;await telegramBotService_1[_0x1ad03c(0xcc)][_0x1ad03c(0x11d)](_0x115293[_0x1ad03c(0xc2)],_0x115293,_0x190df);}catch(_0x3088e4){console[_0x1ad03c(0xce)](_0x1ad03c(0x115),_0x3088e4);}}async['checkPaymentById'](_0x1a3c4a){const _0x5eea90=a37_0x2cd6b8;console[_0x5eea90(0xfd)](_0x5eea90(0xa1)+_0x1a3c4a);const _0x470d8b=await database_1['default'][_0x5eea90(0xf6)][_0x5eea90(0xd4)]({'where':{'id':_0x1a3c4a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x470d8b)throw new Error(_0x5eea90(0xb6));if(_0x470d8b['gateway']!==_0x5eea90(0x94))throw new Error(_0x5eea90(0x13e));console[_0x5eea90(0xfd)](_0x5eea90(0x15d)+_0x1a3c4a),await this['checkSinglePayment'](_0x470d8b),console['log']('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x1a3c4a);}[a37_0x2cd6b8(0x108)](){const _0x5ddea8=a37_0x2cd6b8,_0x36c989=this[_0x5ddea8(0xbf)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x5e0076=Array[_0x5ddea8(0xdd)](this[_0x5ddea8(0x13d)][_0x5ddea8(0x16a)]())['map'](_0x21660e=>({'paymentId':_0x21660e['paymentId'],'gatewayPaymentId':_0x21660e[_0x5ddea8(0xdb)],'createdAt':_0x21660e[_0x5ddea8(0x123)],'timersCount':_0x21660e[_0x5ddea8(0x14f)][_0x5ddea8(0xab)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x5ddea8(0x104)]/(0x3e8*0x3c),'expiryDays':this[_0x5ddea8(0x16d)],'activeIndividualTimers':this[_0x5ddea8(0x13d)]['size'],'nextGlobalCheckIn':_0x36c989,'paymentTimersDetails':_0x5e0076};}[a37_0x2cd6b8(0x10c)](_0xc4f135){const _0x5139ec=a37_0x2cd6b8,_0x317b31=this[_0x5139ec(0x13d)][_0x5139ec(0x136)](_0xc4f135);if(_0x317b31)return{'hasTimers':!![],'timersCount':_0x317b31['timers']['length'],'createdAt':_0x317b31[_0x5139ec(0x123)],'gatewayPaymentId':_0x317b31[_0x5139ec(0xdb)]};return{'hasTimers':![]};}}function a37_0x2264(_0x5ccff2,_0x3b5a15){const _0x355760=a37_0x3557();return a37_0x2264=function(_0x2264d9,_0x3d2098){_0x2264d9=_0x2264d9-0x92;let _0x4b1359=_0x355760[_0x2264d9];return _0x4b1359;},a37_0x2264(_0x5ccff2,_0x3b5a15);}exports[a37_0x2cd6b8(0xa4)]=CoinToPayStatusService,exports[a37_0x2cd6b8(0xa7)]=new CoinToPayStatusService();function a37_0x3557(){const _0x3ac185=['__importDefault','Payment\x20not\x20found','\x20initial\x20timers\x20for\x20payment\x20','logCoinToPayError','iban','checkAllPendingPayments','push','⏰\x20[GLOBAL]\x20Payment\x20','application/json','21fPLRbO','globalCheckInterval','message','1748080jTcQee','shopId','\x20found:','startPeriodicStatusCheck','\x20skipped,\x20','default','confirmedOn','4NIRiSW','\x20\x20\x20❌\x20Error:\x20','payment.failed','\x20checked,\x20','telegramBotService','paidAt','error','findMany','EXPIRED','text','13879129rZPKkb','\x20pending\x20CoinToPay\x20payments','findUnique','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','15Wyzewy','\x20status\x20is\x20','Payment\x20older\x20than\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','gatewayPaymentId','has','from','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','__esModule','CoinToPayService','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20\x20\x20-\x20GatewayPaymentId:\x20','toLowerCase','\x20updated\x20successfully','✅\x20[CHECK]\x20Payment\x20','\x20days','\x20seconds\x20(','\x20expired','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','getDate','\x20not\x20enabled\x20for\x20shop\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','1216863iwrkTb','Shop\x20webhook\x20sent\x20to\x20','5\x20minutes',',\x20stopping\x20individual\x20checks','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','COINTOPAY_ERROR','.\x20Remaining\x20active\x20timers:\x20','\x20\x20\x20📝\x20Context:','payment','logCoinToPayStatus','\x20triggered\x20for\x20payment\x20','\x20\x20\x20-\x20Status:\x20','\x20status\x20changed\x20to\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','customerName','log','./gateways/coinToPayService','catch','\x20\x20\x20-\x20ShopId:\x20','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','checkPaymentStatus','\x20days\x20without\x20payment\x20confirmation','GLOBAL_CHECK_INTERVAL_MS','Unknown\x20error','adminNotes','clearPaymentTimers','getServiceStats','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','🔄\x20[CHECK]\x20Updating\x20payment\x20','0100','getPaymentTimerInfo','floor','\x20with\x20status\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','transactionId','size','240945tAbrII','update','failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20is\x20too\x20new\x20(','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','schedule_created','⏰\x20[GLOBAL]\x20Found\x20','\x20in\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20not\x20found\x20in\x20database','sendPaymentNotification','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','PAID','create','defineProperty','status','createdAt','✅\x20[EXPIRY]\x20Payment\x20','📊\x20[HOURLY]\x20Payment\x20','webhook_send','logWhiteDomainError','setDate','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','unknown','timestamp','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','settings','amount','forEach','🧹\x20[CHECK]\x20Payment\x20','\x20\x20\x20📍\x20Source:\x20','status_check','Failed\x20to\x20mark\x20payment\x20as\x20expired','1350498ZNpOIs','Bank\x20Details:\x20','get','\x20status:\x20','payment.pending','checkExpiredPayments','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','now','payment.success','paymentTimers','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','Automatically\x20expired\x20after\x20','TesSoft\x20Payment\x20System/1.0','❌\x20[CHECK]\x20Payment\x20','PENDING','-day\x20timeout','\x20\x20\x20📝\x20Details:','logShopWebhookError','cointopay_status_check_error','\x20for\x20payment\x20','delay','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','toFixed','Failed\x20to\x20send\x20shop\x20webhook:','⚠️\x20[CHECK]\x20Payment\x20','delete','timers','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','auto_expire','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','created','⏰\x20[HOURLY]\x20Payment\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20status\x20from\x20','🪙\x20[GLOBAL]\x20Found\x20','\x20to\x20','18556ScDwyO','webhookUrl','sendShopWebhook','❌\x20[HOURLY]\x20Payment\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','loggerService','\x20status\x20unchanged\x20(','getTime','./telegramBotService','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','Success','405875XPWaAE','📊\x20[CHECK]\x20Payment\x20','../config/database','\x20current\x20status:\x20','logShopWebhookSent','\x20is\x20older\x20than\x20','values','10nuHupC','⏰\x20[EXPIRY]\x20Payment\x20','EXPIRY_DAYS','gateway','2\x20minutes','cointopay_auto_expired','🛑\x20[SHUTDOWN]\x20Cleared\x20','orderId','\x20days,\x20marking\x20as\x20EXPIRED','\x20has\x20no\x20gatewayPaymentId,\x20skipping','description','cointopay','includes','gatewayOrderId','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20has\x20no\x20gatewayPaymentId','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','bankDetails','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','currency','not\x20confirmed','checkSinglePaymentById','\x20\x20\x20-\x20Amount:\x20','stringify','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','sendPaymentStatusNotification','\x20not\x20found,\x20clearing\x20timers','CoinToPayStatusService','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','checkSinglePayment','coinToPayStatusService','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20marked\x20as\x20paid\x20at:\x20','\x20individual\x20payment\x20timers','length','coinToPayService','paymentDetails','\x20days\x20(created\x20before\x20','toISOString','✅\x20[HOURLY]\x20Payment\x20','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20->\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','webhookLog'];a37_0x3557=function(){return _0x3ac185;};return a37_0x3557();}