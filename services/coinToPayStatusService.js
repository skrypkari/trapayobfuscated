'use strict';const a54_0x2d30a2=a54_0x542b;(function(_0x58e493,_0x43b26b){const _0x3d6a66=a54_0x542b,_0xffe672=_0x58e493();while(!![]){try{const _0x353f15=-parseInt(_0x3d6a66(0x156))/0x1*(-parseInt(_0x3d6a66(0x19b))/0x2)+-parseInt(_0x3d6a66(0x1b8))/0x3+-parseInt(_0x3d6a66(0x10c))/0x4*(-parseInt(_0x3d6a66(0xe8))/0x5)+-parseInt(_0x3d6a66(0x172))/0x6+-parseInt(_0x3d6a66(0x136))/0x7+parseInt(_0x3d6a66(0x1c5))/0x8+parseInt(_0x3d6a66(0x139))/0x9*(parseInt(_0x3d6a66(0x191))/0xa);if(_0x353f15===_0x43b26b)break;else _0xffe672['push'](_0xffe672['shift']());}catch(_0x21b811){_0xffe672['push'](_0xffe672['shift']());}}}(a54_0x55af,0xc084c));function a54_0x542b(_0x5933c8,_0x3dd675){_0x5933c8=_0x5933c8-0xb9;const _0x55afb7=a54_0x55af();let _0x542b06=_0x55afb7[_0x5933c8];return _0x542b06;}var __importDefault=this&&this[a54_0x2d30a2(0x14b)]||function(_0xd314be){return _0xd314be&&_0xd314be['__esModule']?_0xd314be:{'default':_0xd314be};};Object['defineProperty'](exports,a54_0x2d30a2(0x1b1),{'value':!![]}),exports[a54_0x2d30a2(0x135)]=exports[a54_0x2d30a2(0xc1)]=void 0x0;const crypto_1=__importDefault(require(a54_0x2d30a2(0x15f))),coinToPayService_1=require(a54_0x2d30a2(0x143)),coinToPay2Service_1=require(a54_0x2d30a2(0x138)),gateway_1=require(a54_0x2d30a2(0x125)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a54_0x2d30a2(0xf5)),loggerService_1=require('./loggerService'),currencyService_1=require(a54_0x2d30a2(0x144));function a54_0x55af(){const _0x49b5cb=['10qYAdTA','setDate','5\x20minutes','timers','2\x20minutes','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','push','\x20\x20\x20üìä\x20Status:\x20','toLowerCase','PAID','2643682xVaEUr','\x20status\x20changed\x20to\x20','\x20not\x20found,\x20clearing\x20timers','hex','CoinToPay2Service','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','gatewayOrderId','amountUSDT','paymentLinkId','\x20commission:\x20','forEach','checkPaymentStatus','logShopWebhookSent','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check',',\x20status=','CoinToPayService','gatewayPaymentId','map','paymentTimers','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','checkSinglePayment',',\x20gateway\x20','__esModule','\x20found:','\x20->\x20','shop','stopPeriodicStatusCheck','logShopWebhookError','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','2404644odCBdZ','üìä\x20[CHECK]\x20Payment\x20','\x20is\x20older\x20than\x20','cointopay_status_check_','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','üîç\x20[CHECK]\x20Checking\x20','sendShopWebhook','\x20expired','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','/status/','payment','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','1827152uTxyGL','‚è∞\x20[HOURLY]\x20Payment\x20','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20not\x20found\x20in\x20database','telegramBotService','\x20days\x20(created\x20before\x20','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','paymentDetails','\x20is\x20too\x20new\x20(','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','getGatewayCommission','get','CoinToPayStatusService','not\x20confirmed','unknown','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','coinToPayService','gateway','cointopay_status_check_error','COINTOPAY_ERROR','shopId','PENDING','\x20\x20\x20-\x20GatewayPaymentId:\x20','status_check','auto_expire','getTime','\x20status\x20unchanged\x20(','created','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','create','‚úÖ\x20[EXPIRY]\x20Payment\x20','\x20commission\x20for\x20shop\x20',',\x20using\x20default\x20commission\x2010%','üìà\x20[COINTOPAY]\x20Payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','from','\x20status\x20is\x20','catch','\x20(age:\x20','GLOBAL_CHECK_INTERVAL_MS','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','Payment\x20System/1.0','\x20\x20\x20üìÖ\x20Time:\x20','\x20in\x20shop\x20','cointopay','SINGLE','COINTOPAY_STATUS_CHANGE','confirmedOn','\x20in\x20','164860cNbgrh','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','h),\x20skipping\x20global\x20check','logCoinToPayError','gatewayCommissionRate','loggerService','‚ùå\x20[CHECK]\x20Payment\x20','cointopay2','gatewaySettings','currentPayments','\x20\x20\x20-\x20Gateway:\x20','getDate','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','./telegramBotService','\x20\x20\x20Amount\x20after\x20commission:\x20','\x20status:\x20','status','values','\x20has\x20no\x20gatewayPaymentId,\x20skipping','‚úÖ\x20[HOURLY]\x20Payment\x20','customerName','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','paid','iban','error','COMPLETED','transactionId','settings','message','timestamp','default','sendPaymentStatusNotification','findMany','\x20\x20\x20-\x20Amount:\x20','\x20marked\x20as\x20paid\x20at:\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','116CTVqsu','üõë\x20[SHUTDOWN]\x20Cleared\x20','orderId','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','createdAt','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','floor','‚úÖ\x20[CHECK]\x20Payment\x20','Success','.\x20Remaining\x20active\x20timers:\x20','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','payment.pending','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','currency','Failed\x20to\x20mark\x20payment\x20as\x20expired','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','\x20for\x20payment\x20','üè¶\x20[CHECK]\x20Bank\x20details\x20provided:\x20','Webhook\x20event\x20','digest','delay','\x20\x20\x20Gateway\x20','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20individual\x20payment\x20timers','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','../types/gateway','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','commission','Payment\x20older\x20than\x20','schedule_created','\x20with\x20status\x20','‚è∞\x20[EXPIRY]\x20Payment\x20',',\x20clearing\x20individual\x20timers','checkAllPendingPayments','includes','application/json','paidAt','update','schedulePaymentChecks','EXPIRED','\x20to\x20','coinToPayStatusService','8101779zomPQA','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','./gateways/coinToPay2Service','6507414DHvWrp','clearPaymentTimers','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','bankDetails','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','findUnique','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','logCoinToPayStatus','description','webhookLog','./gateways/coinToPayService','./currencyService','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','‚ùå\x20[HOURLY]\x20Payment\x20',',\x20using\x20default\x2010%','checkSinglePaymentById','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','Failed\x20to\x20send\x20shop\x20webhook:','__importDefault','not\x20found','Unknown\x20error','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','‚è∞\x20[GLOBAL]\x20Payment\x20','stack','length','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','\x20completed\x20for\x20payment\x20',',\x20currentPayments=','1JqWRfN','paymentId','startPeriodicStatusCheck','sha256','\x20checked,\x20','\x20updated\x20successfully','toISOString','convertToUSDT','\x20USDT','crypto','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20\x20\x20üìù\x20Context:','\x20current\x20status:\x20','payment.failed','Payment\x20not\x20found','createHmac','üí∞\x20[CHECK]\x20Payment\x20','cointopay_auto_expired','expired','log','\x20expired\x20CoinToPay\x20payments','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','getGatewayIdByName',',\x20stopping\x20individual\x20checks','‚è∞\x20[GLOBAL]\x20Found\x20','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','size','\x20initial\x20timers\x20for\x20payment\x20','2891808fKVloZ','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','stringify','ms)','amount','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','currencyService','customerEmail','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','paymentLink','\x20has\x20no\x20gatewayPaymentId','EXPIRY_DAYS','ü™ô\x20[DEBUG]\x20Creating\x20','\x20\x20\x20-\x20Status:\x20','webhookUrl','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20status\x20from\x20','checkExpiredPayments','coinToPay2Service','Gateway\x20','toFixed','\x20triggered\x20for\x20payment\x20','logWhiteDomainError','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','globalCheckInterval','-day\x20timeout','now','\x20(after\x20'];a54_0x55af=function(){return _0x49b5cb;};return a54_0x55af();}class CoinToPayStatusService{constructor(){const _0x140256=a54_0x2d30a2;this['globalCheckInterval']=null,this[_0x140256(0xdd)]=0x3c*0x3c*0x3e8,this[_0x140256(0x17e)]=0x5,this[_0x140256(0x1ad)]=new Map(),this[_0x140256(0xc5)]=new coinToPayService_1[(_0x140256(0x1aa))](),this[_0x140256(0x185)]=new coinToPay2Service_1[(_0x140256(0x19f))](),console['log'](_0x140256(0x18c));}[a54_0x2d30a2(0x132)](_0x2358b9,_0x1cd475){const _0x7e3f6=a54_0x2d30a2;console[_0x7e3f6(0x169)](_0x7e3f6(0xc4)),console[_0x7e3f6(0x169)]('\x20\x20\x20-\x20paymentId:\x20'+_0x2358b9),console[_0x7e3f6(0x169)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x1cd475),this[_0x7e3f6(0x13a)](_0x2358b9);const _0x2e8c89=[],_0x3e9e32=new Date(),_0xf13fc8=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x7e3f6(0x195)},{'delay':0x5*0x3c*0x3e8,'description':_0x7e3f6(0x193)},{'delay':0x5*0x3c*0x3e8,'description':_0x7e3f6(0x193)}];console['log'](_0x7e3f6(0x17f)+_0xf13fc8[_0x7e3f6(0x152)]+_0x7e3f6(0x171)+_0x2358b9);let _0x22fa91=0x0;_0xf13fc8[_0x7e3f6(0x1a5)]((_0x5535ed,_0x1afe24)=>{const _0x1701b8=_0x7e3f6;_0x22fa91+=_0x5535ed[_0x1701b8(0x120)];const _0x260f6e=setTimeout(async()=>{const _0x10c7da=_0x1701b8;console[_0x10c7da(0x169)](_0x10c7da(0x1bc)+(_0x1afe24+0x1)+_0x10c7da(0x188)+_0x2358b9+_0x10c7da(0x190)+_0x5535ed[_0x10c7da(0x141)]+')');try{await this['checkSinglePaymentById'](_0x2358b9),console['log'](_0x10c7da(0x116)+(_0x1afe24+0x1)+_0x10c7da(0x154)+_0x2358b9);}catch(_0x20e902){console[_0x10c7da(0x100)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x1afe24+0x1)+_0x10c7da(0x11c)+_0x2358b9+':',_0x20e902),this[_0x10c7da(0xeb)](_0x2358b9,_0x1cd475,_0x20e902,'status_check',{'checkNumber':_0x1afe24+0x1,'scheduledAfter':_0x5535ed[_0x10c7da(0x141)],'isIndividualCheck':!![]});}},_0x22fa91);_0x2e8c89[_0x1701b8(0x197)](_0x260f6e),console[_0x1701b8(0x169)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x1afe24+0x1)+_0x1701b8(0x11c)+_0x2358b9+_0x1701b8(0xe7)+_0x22fa91/0x3e8+'\x20seconds\x20('+_0x5535ed[_0x1701b8(0x141)]+')');});const _0x18100a=setInterval(async()=>{const _0xfbc33d=_0x7e3f6;console[_0xfbc33d(0x169)](_0xfbc33d(0x13d)+_0x2358b9);try{const _0x3b99e7=await database_1[_0xfbc33d(0x106)][_0xfbc33d(0x1c2)]['findUnique']({'where':{'id':_0x2358b9},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x3b99e7){console['log'](_0xfbc33d(0x146)+_0x2358b9+_0xfbc33d(0x19d)),this['clearPaymentTimers'](_0x2358b9);return;}console[_0xfbc33d(0x169)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x2358b9+_0xfbc33d(0x162)+_0x3b99e7[_0xfbc33d(0xf8)]);if(_0x3b99e7[_0xfbc33d(0xf8)]!==_0xfbc33d(0xca)){console['log'](_0xfbc33d(0xfb)+_0x2358b9+_0xfbc33d(0xda)+_0x3b99e7[_0xfbc33d(0xf8)]+',\x20stopping\x20individual\x20checks'),this['clearPaymentTimers'](_0x2358b9);return;}const _0x3b9a07=Math['floor']((Date[_0xfbc33d(0x18f)]()-_0x3b99e7['createdAt'][_0xfbc33d(0xce)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x3b9a07>=this['EXPIRY_DAYS']){console[_0xfbc33d(0x169)](_0xfbc33d(0x1c6)+_0x2358b9+_0xfbc33d(0x1ba)+this[_0xfbc33d(0x17e)]+_0xfbc33d(0xe9)),this[_0xfbc33d(0x13a)](_0x2358b9);return;}await this[_0xfbc33d(0x148)](_0x2358b9),console[_0xfbc33d(0x169)](_0xfbc33d(0x196)+_0x2358b9);}catch(_0x26956a){console[_0xfbc33d(0x100)](_0xfbc33d(0x17b)+_0x2358b9+':',_0x26956a),this[_0xfbc33d(0xeb)](_0x2358b9,_0x1cd475,_0x26956a,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x2e8c89['push'](_0x18100a),this['paymentTimers']['set'](_0x2358b9,{'timers':_0x2e8c89,'paymentId':_0x2358b9,'gatewayPaymentId':_0x1cd475,'createdAt':_0x3e9e32}),console[_0x7e3f6(0x169)](_0x7e3f6(0xd8)+_0xf13fc8[_0x7e3f6(0x152)]+_0x7e3f6(0x137)+_0x2358b9),console['log'](_0x7e3f6(0x1c0)+this[_0x7e3f6(0x1ad)][_0x7e3f6(0x170)]),this[_0x7e3f6(0x140)](_0x2358b9,_0x1cd475,_0x7e3f6(0xca),_0x7e3f6(0xca),_0x7e3f6(0xcc),{'action':_0x7e3f6(0x129),'scheduledChecks':_0xf13fc8[_0x7e3f6(0x152)],'firstCheckIn':_0xf13fc8[0x0]['delay']/0x3e8,'totalTimers':this[_0x7e3f6(0x1ad)]['size']});}[a54_0x2d30a2(0x13a)](_0x55745a){const _0x1c519a=a54_0x2d30a2,_0x39eb76=this[_0x1c519a(0x1ad)]['get'](_0x55745a);_0x39eb76?(console[_0x1c519a(0x169)]('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x39eb76[_0x1c519a(0x194)][_0x1c519a(0x152)]+'\x20timers\x20for\x20payment\x20'+_0x55745a),_0x39eb76['timers'][_0x1c519a(0x1a5)]((_0x665a1b,_0x6fba27)=>{const _0x430e35=_0x1c519a;_0x665a1b&&(clearTimeout(_0x665a1b),clearInterval(_0x665a1b),console[_0x430e35(0x169)](_0x430e35(0x13f)+(_0x6fba27+0x1)+_0x430e35(0x11c)+_0x55745a));}),this[_0x1c519a(0x1ad)]['delete'](_0x55745a),console[_0x1c519a(0x169)](_0x1c519a(0x182)+_0x55745a+_0x1c519a(0x115)+this[_0x1c519a(0x1ad)]['size'])):console[_0x1c519a(0x169)](_0x1c519a(0x16f)+_0x55745a+'\x20to\x20clear');}async[a54_0x2d30a2(0x148)](_0x7b80b6){const _0x44420e=a54_0x2d30a2;console[_0x44420e(0x169)](_0x44420e(0x160)+_0x7b80b6);const _0x56a9d2=await database_1[_0x44420e(0x106)][_0x44420e(0x1c2)][_0x44420e(0x13e)]({'where':{'id':_0x7b80b6},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x56a9d2){console[_0x44420e(0x169)](_0x44420e(0xee)+_0x7b80b6+_0x44420e(0x1c8));return;}console['log'](_0x44420e(0x1b9)+_0x7b80b6+_0x44420e(0x1b2)),console[_0x44420e(0x169)](_0x44420e(0xf2)+_0x56a9d2[_0x44420e(0xc6)]),console[_0x44420e(0x169)](_0x44420e(0x180)+_0x56a9d2[_0x44420e(0xf8)]),console[_0x44420e(0x169)](_0x44420e(0xcb)+_0x56a9d2[_0x44420e(0x1ab)]),console[_0x44420e(0x169)](_0x44420e(0x109)+_0x56a9d2[_0x44420e(0x176)]+'\x20'+_0x56a9d2['currency']),console[_0x44420e(0x169)]('\x20\x20\x20-\x20ShopId:\x20'+_0x56a9d2[_0x44420e(0xc9)]);if(_0x56a9d2[_0x44420e(0xc6)]!=='cointopay'&&_0x56a9d2['gateway']!==_0x44420e(0xef)){console['log'](_0x44420e(0xdf)+_0x7b80b6+_0x44420e(0x16b)+_0x56a9d2[_0x44420e(0xc6)]+')');return;}if(_0x56a9d2['status']!==_0x44420e(0xca)){console[_0x44420e(0x169)](_0x44420e(0xdf)+_0x7b80b6+_0x44420e(0xda)+_0x56a9d2['status']+_0x44420e(0x16d)),this[_0x44420e(0x13a)](_0x7b80b6);return;}if(!_0x56a9d2[_0x44420e(0x1ab)]){console[_0x44420e(0x169)](_0x44420e(0xdf)+_0x7b80b6+_0x44420e(0x17d));return;}console[_0x44420e(0x169)](_0x44420e(0x113)+_0x7b80b6+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this['checkSinglePayment'](_0x56a9d2);}[a54_0x2d30a2(0x140)](_0x488af4,_0x3955d5,_0x246b4e,_0x55e3ad,_0x3ad1aa,_0x459b47){const _0x495c7c=a54_0x2d30a2,_0x30c24a={'type':_0x495c7c(0xe5),'paymentId':_0x488af4,'gatewayPaymentId':_0x3955d5,'oldStatus':_0x246b4e,'newStatus':_0x55e3ad,'source':_0x3ad1aa,'timestamp':new Date()[_0x495c7c(0x15c)](),'details':_0x459b47||{}};loggerService_1[_0x495c7c(0xed)][_0x495c7c(0x140)](_0x30c24a),console['log'](_0x495c7c(0x1c4)+_0x488af4+'\x20('+_0x3955d5+')'),console['log'](_0x495c7c(0x198)+_0x246b4e+'\x20->\x20'+_0x55e3ad),console[_0x495c7c(0x169)]('\x20\x20\x20üìç\x20Source:\x20'+_0x3ad1aa),console[_0x495c7c(0x169)](_0x495c7c(0xe1)+_0x30c24a[_0x495c7c(0x105)]),_0x459b47&&console[_0x495c7c(0x169)]('\x20\x20\x20üìù\x20Details:',_0x459b47);}[a54_0x2d30a2(0xeb)](_0x18a956,_0x587bd1,_0x39e651,_0xf5dc0a,_0x191cfa){const _0x38b8e3=a54_0x2d30a2,_0x5004e9={'type':_0x38b8e3(0xc8),'paymentId':_0x18a956,'gatewayPaymentId':_0x587bd1,'error':_0x39e651 instanceof Error?{'message':_0x39e651[_0x38b8e3(0x104)],'stack':_0x39e651[_0x38b8e3(0x151)]}:_0x39e651,'source':_0xf5dc0a,'timestamp':new Date()[_0x38b8e3(0x15c)](),'context':_0x191cfa||{}};loggerService_1[_0x38b8e3(0xed)][_0x38b8e3(0xeb)](_0x5004e9),console[_0x38b8e3(0x100)](_0x38b8e3(0xbe)+_0x18a956+'\x20('+_0x587bd1+')'),console[_0x38b8e3(0x100)]('\x20\x20\x20‚ùå\x20Error:\x20'+(_0x39e651 instanceof Error?_0x39e651[_0x38b8e3(0x104)]:_0x39e651)),console[_0x38b8e3(0x100)]('\x20\x20\x20üìç\x20Source:\x20'+_0xf5dc0a),console[_0x38b8e3(0x100)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x5004e9[_0x38b8e3(0x105)]),_0x191cfa&&console[_0x38b8e3(0x100)](_0x38b8e3(0x161),_0x191cfa);}[a54_0x2d30a2(0x158)](){const _0x242794=a54_0x2d30a2;console[_0x242794(0x169)](_0x242794(0x1b7)),this[_0x242794(0x12d)]()[_0x242794(0xdb)](_0x32e722=>{console['error']('‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x32e722);}),this[_0x242794(0x18d)]=setInterval(async()=>{const _0x29a116=_0x242794;try{console[_0x29a116(0x169)](_0x29a116(0x18a)),await this[_0x29a116(0x12d)](),console[_0x29a116(0x169)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x4cd1a0){console['error']('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x4cd1a0);}},this[_0x242794(0xdd)]),console[_0x242794(0x169)](_0x242794(0x111));}[a54_0x2d30a2(0x1b5)](){const _0x59170f=a54_0x2d30a2;console[_0x59170f(0x169)](_0x59170f(0xba));this['globalCheckInterval']&&(clearInterval(this[_0x59170f(0x18d)]),this['globalCheckInterval']=null,console[_0x59170f(0x169)](_0x59170f(0x18b)));const _0x2dcd68=this[_0x59170f(0x1ad)]['size'];for(const [_0x4ef014]of this[_0x59170f(0x1ad)]){this[_0x59170f(0x13a)](_0x4ef014);}console[_0x59170f(0x169)](_0x59170f(0x10d)+_0x2dcd68+_0x59170f(0x123));}async[a54_0x2d30a2(0x12d)](){const _0x42a8e0=a54_0x2d30a2;try{console['log'](_0x42a8e0(0x1c7));const _0x20b17d=await database_1['default'][_0x42a8e0(0x1c2)][_0x42a8e0(0x108)]({'where':{'gateway':{'in':[_0x42a8e0(0xe3),'cointopay2']},'status':_0x42a8e0(0xca),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log']('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x20b17d['length']+'\x20pending\x20CoinToPay\x20payments');if(_0x20b17d['length']===0x0){console[_0x42a8e0(0x169)](_0x42a8e0(0x1a8));return;}const _0x49ccb7=await this[_0x42a8e0(0x184)](_0x20b17d);console[_0x42a8e0(0x169)](_0x42a8e0(0x16e)+_0x49ccb7[_0x42a8e0(0x152)]+_0x42a8e0(0x16a));let _0x33df1c=0x0,_0x508606=0x0;for(const _0x1dc11a of _0x20b17d){try{if(_0x49ccb7[_0x42a8e0(0x12e)](_0x1dc11a['id'])){console['log']('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x1dc11a['id']+_0x42a8e0(0x10f)),_0x508606++;continue;}if(this[_0x42a8e0(0x1ad)]['has'](_0x1dc11a['id'])){console[_0x42a8e0(0x169)](_0x42a8e0(0x150)+_0x1dc11a['id']+_0x42a8e0(0x13b)),_0x508606++;continue;}const _0x96e9b9=(Date[_0x42a8e0(0x18f)]()-_0x1dc11a[_0x42a8e0(0x110)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x96e9b9<0x1){console[_0x42a8e0(0x169)](_0x42a8e0(0x150)+_0x1dc11a['id']+_0x42a8e0(0xbd)+_0x96e9b9[_0x42a8e0(0x187)](0x1)+_0x42a8e0(0xea)),_0x508606++;continue;}console[_0x42a8e0(0x169)](_0x42a8e0(0x173)+_0x1dc11a['id']+_0x42a8e0(0xdc)+_0x96e9b9[_0x42a8e0(0x187)](0x1)+'h)'),await this[_0x42a8e0(0x1af)](_0x1dc11a),_0x33df1c++,await new Promise(_0x9d36=>setTimeout(_0x9d36,0x7d0));}catch(_0x5ce782){console[_0x42a8e0(0x100)](_0x42a8e0(0x149)+_0x1dc11a['id']+':',_0x5ce782),this[_0x42a8e0(0xeb)](_0x1dc11a['id'],_0x1dc11a['gatewayPaymentId']||_0x42a8e0(0xc3),_0x5ce782,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x1dc11a[_0x42a8e0(0x176)],'paymentCurrency':_0x1dc11a[_0x42a8e0(0x119)],'shopId':_0x1dc11a[_0x42a8e0(0xc9)],'createdAt':_0x1dc11a['createdAt']}),loggerService_1['loggerService'][_0x42a8e0(0x189)](_0x42a8e0(0xe3),_0x42a8e0(0x1c1)+_0x1dc11a['gatewayPaymentId'],_0x5ce782);}}console[_0x42a8e0(0x169)](_0x42a8e0(0x1a0)+_0x33df1c+_0x42a8e0(0x15a)+_0x508606+'\x20skipped,\x20'+_0x49ccb7['length']+_0x42a8e0(0x1bf));}catch(_0x259ead){console[_0x42a8e0(0x100)](_0x42a8e0(0x10b),_0x259ead);}}async['checkExpiredPayments'](_0x536ce5){const _0x9adae1=a54_0x2d30a2,_0x309be1=[],_0x4c2395=new Date();_0x4c2395[_0x9adae1(0x192)](_0x4c2395[_0x9adae1(0xf3)]()-this[_0x9adae1(0x17e)]),console[_0x9adae1(0x169)]('‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x9adae1(0x17e)]+_0x9adae1(0xb9)+_0x4c2395['toISOString']()+')');for(const _0x14b758 of _0x536ce5){if(_0x14b758['createdAt']<_0x4c2395){console[_0x9adae1(0x169)](_0x9adae1(0x12b)+_0x14b758['id']+_0x9adae1(0x1ba)+this[_0x9adae1(0x17e)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x9adae1(0x140)](_0x14b758['id'],_0x14b758[_0x9adae1(0x1ab)]||_0x9adae1(0xc3),'PENDING',_0x9adae1(0x133),_0x9adae1(0xcd),{'reason':'Payment\x20older\x20than\x20'+this[_0x9adae1(0x17e)]+'\x20days','createdAt':_0x14b758[_0x9adae1(0x110)],'daysSinceCreation':Math['floor']((Date['now']()-_0x14b758['createdAt'][_0x9adae1(0xce)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x14b758[_0x9adae1(0x176)],'paymentCurrency':_0x14b758[_0x9adae1(0x119)],'shopId':_0x14b758[_0x9adae1(0xc9)]}),await database_1[_0x9adae1(0x106)][_0x9adae1(0x1c2)][_0x9adae1(0x131)]({'where':{'id':_0x14b758['id']},'data':{'status':_0x9adae1(0x133),'updatedAt':new Date()}}),await database_1[_0x9adae1(0x106)][_0x9adae1(0x142)][_0x9adae1(0xd2)]({'data':{'paymentId':_0x14b758['id'],'shopId':_0x14b758[_0x9adae1(0xc9)],'event':_0x9adae1(0x167),'statusCode':0xc8,'responseBody':JSON[_0x9adae1(0x174)]({'reason':_0x9adae1(0x128)+this[_0x9adae1(0x17e)]+'\x20days','createdAt':_0x14b758[_0x9adae1(0x110)],'expiredAt':new Date()[_0x9adae1(0x15c)](),'daysSinceCreation':Math[_0x9adae1(0x112)]((Date[_0x9adae1(0x18f)]()-_0x14b758[_0x9adae1(0x110)][_0x9adae1(0xce)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x14b758,_0x9adae1(0x133)),await this[_0x9adae1(0x107)](_0x14b758,'EXPIRED'),this[_0x9adae1(0x13a)](_0x14b758['id']),_0x309be1[_0x9adae1(0x197)](_0x14b758['id']),console[_0x9adae1(0x169)](_0x9adae1(0xd3)+_0x14b758['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x9adae1(0x17e)]+_0x9adae1(0x18e));}catch(_0x4fd98a){console[_0x9adae1(0x100)](_0x9adae1(0xf4)+_0x14b758['id']+':',_0x4fd98a),this[_0x9adae1(0xeb)](_0x14b758['id'],_0x14b758['gatewayPaymentId']||'unknown',_0x4fd98a,_0x9adae1(0xcd),{'reason':_0x9adae1(0x11a),'createdAt':_0x14b758[_0x9adae1(0x110)],'daysSinceCreation':Math['floor']((Date['now']()-_0x14b758[_0x9adae1(0x110)][_0x9adae1(0xce)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x309be1;}async[a54_0x2d30a2(0x1af)](_0x16ca70){const _0xb5bcf5=a54_0x2d30a2;if(!_0x16ca70[_0xb5bcf5(0x1ab)]){console[_0xb5bcf5(0x169)](_0xb5bcf5(0xdf)+_0x16ca70['id']+_0xb5bcf5(0xfa));return;}console[_0xb5bcf5(0x169)](_0xb5bcf5(0x1bd)+_0x16ca70[_0xb5bcf5(0xc6)]+'\x20payment\x20'+_0x16ca70['id']+'\x20('+_0x16ca70[_0xb5bcf5(0x1ab)]+')');try{let _0x2bd2e9;_0x16ca70['gateway']===_0xb5bcf5(0xef)?(_0x2bd2e9=await this[_0xb5bcf5(0x185)][_0xb5bcf5(0x1a6)](_0x16ca70['gatewayPaymentId']),console[_0xb5bcf5(0x169)](_0xb5bcf5(0xd1)+_0x16ca70['id']+_0xb5bcf5(0xf7)+_0x2bd2e9['status'])):(_0x2bd2e9=await this[_0xb5bcf5(0xc5)][_0xb5bcf5(0x1a6)](_0x16ca70[_0xb5bcf5(0x1ab)]),console[_0xb5bcf5(0x169)](_0xb5bcf5(0x14e)+_0x16ca70['id']+_0xb5bcf5(0xf7)+_0x2bd2e9[_0xb5bcf5(0xf8)]));_0x2bd2e9['paymentDetails']&&console[_0xb5bcf5(0x169)](_0xb5bcf5(0x1b9)+_0x16ca70['id']+'\x20details:',{'iban':_0x2bd2e9[_0xb5bcf5(0xbc)]['iban']||_0xb5bcf5(0x14c),'transactionId':_0x2bd2e9[_0xb5bcf5(0xbc)][_0xb5bcf5(0x102)],'createdOn':_0x2bd2e9[_0xb5bcf5(0xbc)]['createdOn'],'confirmedOn':_0x2bd2e9[_0xb5bcf5(0xbc)][_0xb5bcf5(0xe6)]||_0xb5bcf5(0xc2)});if(_0x2bd2e9[_0xb5bcf5(0xf8)]!==_0x16ca70[_0xb5bcf5(0xf8)]){console[_0xb5bcf5(0x169)](_0xb5bcf5(0x178)+_0x16ca70['id']+_0xb5bcf5(0x183)+_0x16ca70['status']+_0xb5bcf5(0x134)+_0x2bd2e9[_0xb5bcf5(0xf8)]),this[_0xb5bcf5(0x140)](_0x16ca70['id'],_0x16ca70[_0xb5bcf5(0x1ab)],_0x16ca70[_0xb5bcf5(0xf8)],_0x2bd2e9['status'],_0xb5bcf5(0xcc),{'paymentDetails':_0x2bd2e9[_0xb5bcf5(0xbc)],'amount':_0x2bd2e9[_0xb5bcf5(0x176)],'currency':_0x2bd2e9[_0xb5bcf5(0x119)],'shopId':_0x16ca70[_0xb5bcf5(0xc9)],'checkTimestamp':new Date()['toISOString']()});const _0x41c21e={'status':_0x2bd2e9['status'],'updatedAt':new Date()};if(_0x2bd2e9['status']==='PAID'&&_0x16ca70[_0xb5bcf5(0xf8)]!==_0xb5bcf5(0x19a)){_0x41c21e[_0xb5bcf5(0x130)]=new Date();if(!_0x16ca70[_0xb5bcf5(0x1a2)]){const _0x4b9413=await currencyService_1[_0xb5bcf5(0x179)][_0xb5bcf5(0x15d)](_0x16ca70[_0xb5bcf5(0x176)],_0x16ca70[_0xb5bcf5(0x119)]);_0x41c21e[_0xb5bcf5(0x1a2)]=_0x4b9413;const _0x54f7c0=await this[_0xb5bcf5(0xbf)](_0x16ca70[_0xb5bcf5(0xc9)],_0x16ca70['gateway']),_0x29d050=_0x4b9413*(0x1-_0x54f7c0/0x64);_0x41c21e['amountAfterGatewayCommissionUSDT']=_0x29d050,_0x41c21e[_0xb5bcf5(0xec)]=_0x54f7c0,console['log']('üí∞\x20[CHECK]\x20Payment\x20'+_0x16ca70['id']+'\x20amounts\x20calculated:'),console[_0xb5bcf5(0x169)]('\x20\x20\x20Amount:\x20'+_0x16ca70[_0xb5bcf5(0x176)]+'\x20'+_0x16ca70['currency']+_0xb5bcf5(0x1b3)+_0x4b9413[_0xb5bcf5(0x187)](0x6)+_0xb5bcf5(0x15e)),console[_0xb5bcf5(0x169)](_0xb5bcf5(0x121)+_0x16ca70[_0xb5bcf5(0xc6)]+_0xb5bcf5(0x1a4)+_0x54f7c0+'%'),console['log'](_0xb5bcf5(0xf6)+_0x29d050[_0xb5bcf5(0x187)](0x6)+_0xb5bcf5(0x15e));}console[_0xb5bcf5(0x169)](_0xb5bcf5(0x166)+_0x16ca70['id']+_0xb5bcf5(0x10a)+_0x41c21e[_0xb5bcf5(0x130)][_0xb5bcf5(0x15c)]());}if(_0x2bd2e9['paymentDetails']){const _0x13745f=_0x2bd2e9[_0xb5bcf5(0xbc)];_0x13745f[_0xb5bcf5(0xff)]&&(_0x41c21e['remitterIban']=_0x13745f[_0xb5bcf5(0xff)],console['log']('üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x13745f[_0xb5bcf5(0xff)])),_0x13745f[_0xb5bcf5(0x13c)]&&console[_0xb5bcf5(0x169)](_0xb5bcf5(0x11d)+_0x13745f[_0xb5bcf5(0x13c)]),_0x13745f[_0xb5bcf5(0x102)]&&console[_0xb5bcf5(0x169)](_0xb5bcf5(0xfd)+_0x13745f[_0xb5bcf5(0x102)]),_0x13745f[_0xb5bcf5(0xe6)]&&console['log'](_0xb5bcf5(0x122)+_0x13745f[_0xb5bcf5(0xe6)]);}await database_1[_0xb5bcf5(0x106)][_0xb5bcf5(0x1c2)][_0xb5bcf5(0x131)]({'where':{'id':_0x16ca70['id']},'data':_0x41c21e});if(_0x2bd2e9['status']===_0xb5bcf5(0x19a)&&_0x16ca70[_0xb5bcf5(0xf8)]!==_0xb5bcf5(0x19a)){console[_0xb5bcf5(0x169)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x16ca70['id']+_0xb5bcf5(0xde));const _0x240d1b=await database_1[_0xb5bcf5(0x106)]['payment'][_0xb5bcf5(0x13e)]({'where':{'id':_0x16ca70['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x240d1b?.[_0xb5bcf5(0x1a3)]&&_0x240d1b['paymentLink'])try{const _0x271737=_0x240d1b[_0xb5bcf5(0x17c)];console[_0xb5bcf5(0x169)](_0xb5bcf5(0xbb)+_0x271737['id']+':\x20type='+_0x271737['type']+_0xb5bcf5(0x155)+_0x271737[_0xb5bcf5(0xf1)]+',\x20status='+_0x271737[_0xb5bcf5(0xf8)]);const _0x3c7cd7=_0x271737['currentPayments']+0x1,_0x3cdb61=_0x271737['type']===_0xb5bcf5(0xe4)?_0xb5bcf5(0x101):_0x271737[_0xb5bcf5(0xf8)];await database_1[_0xb5bcf5(0x106)][_0xb5bcf5(0x17c)][_0xb5bcf5(0x131)]({'where':{'id':_0x271737['id']},'data':{'currentPayments':_0x3c7cd7,'status':_0x3cdb61,'updatedAt':new Date()}}),console[_0xb5bcf5(0x169)](_0xb5bcf5(0x11b)+_0x271737['id']+'\x20updated:\x20currentPayments='+_0x271737['currentPayments']+_0xb5bcf5(0x1b3)+_0x3c7cd7+_0xb5bcf5(0x1a9)+_0x271737[_0xb5bcf5(0xf8)]+'\x20->\x20'+_0x3cdb61);}catch(_0x1b74b0){console[_0xb5bcf5(0x100)](_0xb5bcf5(0x126),_0x1b74b0);}else console[_0xb5bcf5(0x169)](_0xb5bcf5(0xd6)+_0x16ca70['id']+_0xb5bcf5(0x153));}await database_1[_0xb5bcf5(0x106)][_0xb5bcf5(0x142)][_0xb5bcf5(0xd2)]({'data':{'paymentId':_0x16ca70['id'],'shopId':_0x16ca70[_0xb5bcf5(0xc9)],'event':_0xb5bcf5(0x1bb)+_0x2bd2e9[_0xb5bcf5(0xf8)][_0xb5bcf5(0x199)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x16ca70[_0xb5bcf5(0xf8)],'newStatus':_0x2bd2e9[_0xb5bcf5(0xf8)],'paymentDetails':_0x2bd2e9[_0xb5bcf5(0xbc)],'checkedAt':new Date()['toISOString']()})}}),await this[_0xb5bcf5(0x1be)](_0x16ca70,_0x2bd2e9[_0xb5bcf5(0xf8)]),await this[_0xb5bcf5(0x107)](_0x16ca70,_0x2bd2e9['status']),_0x2bd2e9[_0xb5bcf5(0xf8)]!==_0xb5bcf5(0xca)&&(console[_0xb5bcf5(0x169)]('üßπ\x20[CHECK]\x20Payment\x20'+_0x16ca70['id']+_0xb5bcf5(0x19c)+_0x2bd2e9[_0xb5bcf5(0xf8)]+_0xb5bcf5(0x12c)),this[_0xb5bcf5(0x13a)](_0x16ca70['id'])),console[_0xb5bcf5(0x169)](_0xb5bcf5(0x113)+_0x16ca70['id']+_0xb5bcf5(0x15b));}else console['log'](_0xb5bcf5(0x1b9)+_0x16ca70['id']+_0xb5bcf5(0xcf)+_0x2bd2e9[_0xb5bcf5(0xf8)]+')'),this[_0xb5bcf5(0x140)](_0x16ca70['id'],_0x16ca70[_0xb5bcf5(0x1ab)],_0x16ca70[_0xb5bcf5(0xf8)],_0x2bd2e9[_0xb5bcf5(0xf8)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x2bd2e9['paymentDetails'],'amount':_0x2bd2e9[_0xb5bcf5(0x176)],'currency':_0x2bd2e9[_0xb5bcf5(0x119)],'shopId':_0x16ca70[_0xb5bcf5(0xc9)],'checkTimestamp':new Date()[_0xb5bcf5(0x15c)]()});}catch(_0x1505d8){console['error']('‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x16ca70['id']+':',_0x1505d8),this[_0xb5bcf5(0xeb)](_0x16ca70['id'],_0x16ca70[_0xb5bcf5(0x1ab)],_0x1505d8,_0xb5bcf5(0xcc),{'paymentAmount':_0x16ca70[_0xb5bcf5(0x176)],'paymentCurrency':_0x16ca70[_0xb5bcf5(0x119)],'shopId':_0x16ca70[_0xb5bcf5(0xc9)],'createdAt':_0x16ca70[_0xb5bcf5(0x110)]}),await database_1[_0xb5bcf5(0x106)][_0xb5bcf5(0x142)][_0xb5bcf5(0xd2)]({'data':{'paymentId':_0x16ca70['id'],'shopId':_0x16ca70[_0xb5bcf5(0xc9)],'event':_0xb5bcf5(0xc7),'statusCode':0x1f4,'responseBody':JSON[_0xb5bcf5(0x174)]({'error':_0x1505d8 instanceof Error?_0x1505d8['message']:_0xb5bcf5(0x14d),'gatewayPaymentId':_0x16ca70['gatewayPaymentId'],'checkedAt':new Date()[_0xb5bcf5(0x15c)]()})}});}}async[a54_0x2d30a2(0x1be)](_0x156106,_0x3962a9){const _0x33acb0=a54_0x2d30a2,_0x333a7f=Date[_0x33acb0(0x18f)]();try{const _0x225d2d=_0x156106[_0x33acb0(0x1b4)],_0x1cfdce=_0x225d2d[_0x33acb0(0x103)];if(!_0x1cfdce?.[_0x33acb0(0x181)]){console['log'](_0x33acb0(0xd7)+_0x225d2d['id']);return;}const _0x1f43d6=_0x3962a9===_0x33acb0(0x19a)?'payment.success':_0x3962a9==='FAILED'?_0x33acb0(0x163):_0x3962a9===_0x33acb0(0x133)?_0x33acb0(0x163):_0x33acb0(0x117);if(!_0x1cfdce['webhookEvents']?.[_0x33acb0(0x12e)](_0x1f43d6)){console[_0x33acb0(0x169)](_0x33acb0(0x11e)+_0x1f43d6+'\x20not\x20enabled\x20for\x20shop\x20'+_0x225d2d['id']);return;}const _0x34071a=(0x0,gateway_1[_0x33acb0(0x16c)])(_0x156106[_0x33acb0(0xc6)])||_0x156106[_0x33acb0(0xc6)],_0x22dc60={'event':_0x1f43d6,'payment':{'id':_0x156106['id'],'order_id':_0x156106[_0x33acb0(0x10e)],'gateway_order_id':_0x156106[_0x33acb0(0x1a1)],'gateway':_0x34071a,'amount':_0x156106[_0x33acb0(0x176)],'currency':_0x156106[_0x33acb0(0x119)],'status':_0x3962a9[_0x33acb0(0x199)](),'customer_email':_0x156106[_0x33acb0(0x17a)],'customer_name':_0x156106[_0x33acb0(0xfc)],'created_at':_0x156106[_0x33acb0(0x110)],'updated_at':new Date()}},_0x107735=JSON['stringify'](_0x22dc60),_0x3a9fbb=crypto_1[_0x33acb0(0x106)][_0x33acb0(0x165)](_0x33acb0(0x159),_0x156106[_0x33acb0(0x1b4)]['secretKey'])['update'](_0x107735)[_0x33acb0(0x11f)](_0x33acb0(0x19e)),_0xe3e203=await fetch(_0x1cfdce[_0x33acb0(0x181)],{'method':'POST','headers':{'Content-Type':_0x33acb0(0x12f),'User-Agent':_0x33acb0(0xe0),'X-Webhook-Signature':_0x3a9fbb},'body':_0x107735}),_0x45b7fb=Date[_0x33acb0(0x18f)]()-_0x333a7f,_0x1e13fd=_0xe3e203['ok']?_0x33acb0(0x114):await _0xe3e203['text']();loggerService_1['loggerService'][_0x33acb0(0x1a7)](_0x156106[_0x33acb0(0xc9)],_0x1cfdce[_0x33acb0(0x181)],_0x1f43d6,_0xe3e203[_0x33acb0(0xf8)],_0x45b7fb,_0x22dc60),console[_0x33acb0(0x169)]('Shop\x20webhook\x20sent\x20to\x20'+_0x1cfdce[_0x33acb0(0x181)]+_0x33acb0(0x12a)+_0xe3e203[_0x33acb0(0xf8)]+'\x20('+_0x45b7fb+_0x33acb0(0x175));}catch(_0x2a8d9e){console['error'](_0x33acb0(0x14a),_0x2a8d9e),loggerService_1[_0x33acb0(0xed)][_0x33acb0(0x1b6)](_0x156106[_0x33acb0(0xc9)],_0x156106[_0x33acb0(0x1b4)]?.[_0x33acb0(0x103)]?.[_0x33acb0(0x181)]||_0x33acb0(0xc3),'webhook_send',_0x2a8d9e,{});}}async['sendPaymentStatusNotification'](_0x58e163,_0x5b6b92){const _0x589a0a=a54_0x2d30a2;try{const _0x2056bd={'PENDING':_0x589a0a(0xd0),'PAID':_0x589a0a(0xfe),'FAILED':'failed','EXPIRED':_0x589a0a(0x168)},_0x36b946=_0x2056bd[_0x5b6b92];if(!_0x36b946||_0x36b946===_0x589a0a(0xd0))return;await telegramBotService_1[_0x589a0a(0x1c9)]['sendPaymentNotification'](_0x58e163[_0x589a0a(0xc9)],_0x58e163,_0x36b946);}catch(_0x4448c8){console[_0x589a0a(0x100)](_0x589a0a(0x1ae),_0x4448c8);}}async['checkPaymentById'](_0x30b5cf){const _0x4b41c3=a54_0x2d30a2;console[_0x4b41c3(0x169)](_0x4b41c3(0x177)+_0x30b5cf);const _0xb5a5c7=await database_1[_0x4b41c3(0x106)][_0x4b41c3(0x1c2)]['findUnique']({'where':{'id':_0x30b5cf},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xb5a5c7)throw new Error(_0x4b41c3(0x164));if(_0xb5a5c7[_0x4b41c3(0xc6)]!==_0x4b41c3(0xe3)&&_0xb5a5c7[_0x4b41c3(0xc6)]!==_0x4b41c3(0xef))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console['log'](_0x4b41c3(0x118)+_0xb5a5c7[_0x4b41c3(0xc6)]+'\x20payment\x20'+_0x30b5cf),await this[_0x4b41c3(0x1af)](_0xb5a5c7),console[_0x4b41c3(0x169)](_0x4b41c3(0x1c3)+_0x30b5cf);}['getServiceStats'](){const _0xd9b0d8=a54_0x2d30a2,_0x4ce62c=this[_0xd9b0d8(0x18d)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x177991=Array[_0xd9b0d8(0xd9)](this[_0xd9b0d8(0x1ad)][_0xd9b0d8(0xf9)]())[_0xd9b0d8(0x1ac)](_0x2a282c=>({'paymentId':_0x2a282c[_0xd9b0d8(0x157)],'gatewayPaymentId':_0x2a282c[_0xd9b0d8(0x1ab)],'createdAt':_0x2a282c['createdAt'],'timersCount':_0x2a282c['timers'][_0xd9b0d8(0x152)]}));return{'isActive':!!this[_0xd9b0d8(0x18d)],'globalCheckIntervalMinutes':this[_0xd9b0d8(0xdd)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0xd9b0d8(0x1ad)][_0xd9b0d8(0x170)],'nextGlobalCheckIn':_0x4ce62c,'paymentTimersDetails':_0x177991};}['getPaymentTimerInfo'](_0x1d326c){const _0xf8cd82=a54_0x2d30a2,_0x2b12fc=this['paymentTimers'][_0xf8cd82(0xc0)](_0x1d326c);if(_0x2b12fc)return{'hasTimers':!![],'timersCount':_0x2b12fc[_0xf8cd82(0x194)][_0xf8cd82(0x152)],'createdAt':_0x2b12fc['createdAt'],'gatewayPaymentId':_0x2b12fc[_0xf8cd82(0x1ab)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0x4eee96,_0x2eed21){const _0x52a639=a54_0x2d30a2;try{const _0x2871db=await database_1[_0x52a639(0x106)][_0x52a639(0x1b4)][_0x52a639(0x13e)]({'where':{'id':_0x4eee96},'select':{'gatewaySettings':!![]}});if(!_0x2871db?.[_0x52a639(0xf0)])return console[_0x52a639(0x169)](_0x52a639(0x14f)+_0x4eee96+_0x52a639(0xd5)),0xa;const _0x4dcee6=JSON['parse'](_0x2871db[_0x52a639(0xf0)]);for(const [_0x4c4699,_0x1fcb12]of Object['entries'](_0x4dcee6)){if(_0x4c4699[_0x52a639(0x199)]()===_0x2eed21['toLowerCase']()){const _0x3eb25c=_0x1fcb12[_0x52a639(0x127)]||0xa;return console[_0x52a639(0x169)](_0x52a639(0x186)+_0x2eed21+_0x52a639(0xd4)+_0x4eee96+':\x20'+_0x3eb25c+'%'),_0x3eb25c;}}return console[_0x52a639(0x169)](_0x52a639(0x124)+_0x2eed21+_0x52a639(0xe2)+_0x4eee96+_0x52a639(0x147)),0xa;}catch(_0x4aaae6){return console[_0x52a639(0x100)](_0x52a639(0x145)+_0x4eee96+_0x52a639(0x1b0)+_0x2eed21+':',_0x4aaae6),0xa;}}}exports[a54_0x2d30a2(0xc1)]=CoinToPayStatusService,exports[a54_0x2d30a2(0x135)]=new CoinToPayStatusService();