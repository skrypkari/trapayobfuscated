'use strict';const a37_0x4c2d23=a37_0x4b52;(function(_0x128a98,_0x82c730){const _0x4ac05f=a37_0x4b52,_0x149dc5=_0x128a98();while(!![]){try{const _0x16f61e=parseInt(_0x4ac05f(0x220))/0x1*(parseInt(_0x4ac05f(0x27e))/0x2)+parseInt(_0x4ac05f(0x1cb))/0x3*(-parseInt(_0x4ac05f(0x2b0))/0x4)+parseInt(_0x4ac05f(0x261))/0x5+parseInt(_0x4ac05f(0x22e))/0x6*(parseInt(_0x4ac05f(0x2a2))/0x7)+-parseInt(_0x4ac05f(0x214))/0x8+parseInt(_0x4ac05f(0x1cd))/0x9*(parseInt(_0x4ac05f(0x280))/0xa)+parseInt(_0x4ac05f(0x21e))/0xb;if(_0x16f61e===_0x82c730)break;else _0x149dc5['push'](_0x149dc5['shift']());}catch(_0x4d6e36){_0x149dc5['push'](_0x149dc5['shift']());}}}(a37_0x46a9,0x87b64));var __importDefault=this&&this[a37_0x4c2d23(0x1f2)]||function(_0x16570b){const _0xe1f947=a37_0x4c2d23;return _0x16570b&&_0x16570b[_0xe1f947(0x1e3)]?_0x16570b:{'default':_0x16570b};};function a37_0x4b52(_0x50c374,_0x78c987){const _0x46a988=a37_0x46a9();return a37_0x4b52=function(_0x4b5249,_0x872129){_0x4b5249=_0x4b5249-0x1c7;let _0x525bc4=_0x46a988[_0x4b5249];return _0x525bc4;},a37_0x4b52(_0x50c374,_0x78c987);}Object[a37_0x4c2d23(0x298)](exports,a37_0x4c2d23(0x1e3),{'value':!![]}),exports[a37_0x4c2d23(0x208)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a37_0x4c2d23(0x1e5)),database_1=__importDefault(require(a37_0x4c2d23(0x242))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a37_0x4c2d23(0x27f));function a37_0x46a9(){const _0x2a9c63=['\x20\x20\x20üìù\x20Details:','3yOWtqN','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','792QvbMzt','\x20is\x20older\x20than\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','forEach','from','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20triggered\x20for\x20payment\x20','delay','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paid','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','create','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','webhookUrl','/status/','now','schedulePaymentChecks','confirmedOn','findUnique','\x20days,\x20marking\x20as\x20EXPIRED','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','cointopay','__esModule','cointopay_status_check_error','./gateways/coinToPayService','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','üõë\x20[SHUTDOWN]\x20Cleared\x20','shop','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','adminNotes','currency','sendPaymentNotification','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','timestamp','paidAt','webhookLog','POST','__importDefault','status_check','toFixed','\x20\x20\x20-\x20Gateway:\x20','-day\x20timeout','\x20\x20\x20-\x20gatewayPaymentId:\x20','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','logCoinToPayError','1\x20minute','\x20completed\x20for\x20payment\x20','values','clearPaymentTimers','checkPaymentStatus','schedule_created','\x20days\x20without\x20payment\x20confirmation','log','orderId','\x20timers\x20for\x20payment\x20','\x20checked,\x20','set','map','coinToPayStatusService','‚è∞\x20[EXPIRY]\x20Payment\x20','paymentDetails','stringify','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','telegramBotService','get','payment.failed','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','logShopWebhookSent','findMany','7178848HYiijj','\x20\x20\x20-\x20ShopId:\x20','\x20\x20\x20‚ùå\x20Error:\x20','üìä\x20[CHECK]\x20Payment\x20','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','createdAt','error','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','\x20expired\x20CoinToPay\x20payments','2206358soJZUj','Failed\x20to\x20mark\x20payment\x20as\x20expired','407323fDVfkD','\x20not\x20enabled\x20for\x20shop\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','CoinToPayService','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','catch','‚è∞\x20[HOURLY]\x20Payment\x20','üí∞\x20[CHECK]\x20Payment\x20','2\x20minutes','COINTOPAY_STATUS_CHANGE','COINTOPAY_ERROR','bankDetails','loggerService','135474bDtOfH','getDate','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20has\x20no\x20gatewayPaymentId','\x20\x20\x20üìä\x20Status:\x20','\x20details:','\x20with\x20status\x20','setDate','\x20\x20\x20-\x20paymentId:\x20','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20not\x20found\x20in\x20database','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','expired','push','size','settings','stack','unknown','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20(age:\x20','../config/database','‚úÖ\x20[CHECK]\x20Payment\x20','amount','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','ü™ô\x20[DEBUG]\x20Creating\x20','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','checkExpiredPayments','ü™ô\x20[GLOBAL]\x20Found\x20','gateway','\x20status\x20unchanged\x20(','\x20status\x20from\x20','cointopay_auto_expired','PAID','includes','Payment\x20older\x20than\x20','\x20found:','Unknown\x20error','customerName','‚úÖ\x20[HOURLY]\x20Payment\x20','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','EXPIRY_DAYS','status','payment.pending','checkPaymentById','üßπ\x20[CHECK]\x20Payment\x20','PENDING','failed','toLowerCase','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','1284800DLvTEJ','Failed\x20to\x20send\x20shop\x20webhook:','\x20updated\x20successfully','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','getTime','‚è∞\x20[GLOBAL]\x20Found\x20','EXPIRED','sendPaymentStatusNotification','length','\x20in\x20','getServiceStats','gatewayOrderId','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','GLOBAL_CHECK_INTERVAL_MS','timers','Shop\x20webhook\x20sent\x20to\x20','\x20\x20\x20üìù\x20Context:','iban','cointopay_status_check_','sendShopWebhook','payment','shopId','delete','auto_expire','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','\x20seconds\x20(','h),\x20skipping\x20global\x20check','4UAVSKW','./loggerService','76490hwMqlt','\x20status\x20changed\x20to\x20','üßπ\x20[DEBUG]\x20Clearing\x20','TesSoft\x20Payment\x20System/1.0','created','\x20days','Automatically\x20expired\x20after\x20','\x20expired','0100','\x20status\x20is\x20',',\x20clearing\x20individual\x20timers','‚è∞\x20[GLOBAL]\x20Payment\x20','paymentTimers','description','\x20\x20\x20üìç\x20Source:\x20','\x20pending\x20CoinToPay\x20payments','Webhook\x20event\x20','\x20is\x20too\x20new\x20(','üìä\x20[HOURLY]\x20Payment\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20->\x20','getPaymentTimerInfo','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','defineProperty','checkSinglePayment','webhookEvents','customerEmail','checkAllPendingPayments','update','\x20\x20\x20üìÖ\x20Time:\x20','checkSinglePaymentById','CoinToPayStatusService','\x20status:\x20','7NTniFU','globalCheckInterval','\x20to\x20','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','floor','gatewayPaymentId','5\x20minutes','has','toISOString',',\x20stopping\x20individual\x20checks','logCoinToPayStatus','transactionId','coinToPayService','\x20marked\x20as\x20paid\x20at:\x20','2058572RveIXl','\x20for\x20payment\x20','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','‚ùå\x20[CHECK]\x20Payment\x20','Success','default'];a37_0x46a9=function(){return _0x2a9c63;};return a37_0x46a9();}class CoinToPayStatusService{constructor(){const _0x2683f6=a37_0x4c2d23;this[_0x2683f6(0x2a3)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x2683f6(0x258)]=0x5,this[_0x2683f6(0x28c)]=new Map(),this[_0x2683f6(0x2ae)]=new coinToPayService_1[(_0x2683f6(0x223))](),console['log']('ü™ô\x20CoinToPayStatusService\x20initialized');}[a37_0x4c2d23(0x1dd)](_0x545c56,_0x514b9e){const _0x250e04=a37_0x4c2d23;console[_0x250e04(0x202)](_0x250e04(0x237)),console['log'](_0x250e04(0x236)+_0x545c56),console[_0x250e04(0x202)](_0x250e04(0x1f7)+_0x514b9e),this['clearPaymentTimers'](_0x545c56);const _0x57172f=[],_0x2c2844=new Date(),_0x40b4fa=[{'delay':0x1*0x3c*0x3e8,'description':_0x250e04(0x1fb)},{'delay':0x2*0x3c*0x3e8,'description':_0x250e04(0x229)},{'delay':0x5*0x3c*0x3e8,'description':_0x250e04(0x2a8)},{'delay':0x5*0x3c*0x3e8,'description':_0x250e04(0x2a8)}];console[_0x250e04(0x202)](_0x250e04(0x246)+_0x40b4fa[_0x250e04(0x26b)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x545c56);let _0x3c2464=0x0;_0x40b4fa[_0x250e04(0x1d0)]((_0x2bbf69,_0x178700)=>{const _0x4470f0=_0x250e04;_0x3c2464+=_0x2bbf69[_0x4470f0(0x1d4)];const _0x254b20=setTimeout(async()=>{const _0x9dce91=_0x4470f0;console[_0x9dce91(0x202)](_0x9dce91(0x1d9)+(_0x178700+0x1)+_0x9dce91(0x1d3)+_0x545c56+'\x20(after\x20'+_0x2bbf69['description']+')');try{await this[_0x9dce91(0x29f)](_0x545c56),console[_0x9dce91(0x202)](_0x9dce91(0x27b)+(_0x178700+0x1)+_0x9dce91(0x1fc)+_0x545c56);}catch(_0x5b3208){console['error'](_0x9dce91(0x1f8)+(_0x178700+0x1)+_0x9dce91(0x2b1)+_0x545c56+':',_0x5b3208),this[_0x9dce91(0x1fa)](_0x545c56,_0x514b9e,_0x5b3208,_0x9dce91(0x1f3),{'checkNumber':_0x178700+0x1,'scheduledAfter':_0x2bbf69[_0x9dce91(0x28d)],'isIndividualCheck':!![]});}},_0x3c2464);_0x57172f[_0x4470f0(0x23b)](_0x254b20),console[_0x4470f0(0x202)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x178700+0x1)+_0x4470f0(0x2b1)+_0x545c56+_0x4470f0(0x26c)+_0x3c2464/0x3e8+_0x4470f0(0x27c)+_0x2bbf69[_0x4470f0(0x28d)]+')');});const _0x183f1b=setInterval(async()=>{const _0xb2c519=_0x250e04;console['log'](_0xb2c519(0x2a5)+_0x545c56);try{const _0x3b166c=await database_1['default'][_0xb2c519(0x277)]['findUnique']({'where':{'id':_0x545c56},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x3b166c){console['log']('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x545c56+'\x20not\x20found,\x20clearing\x20timers'),this[_0xb2c519(0x1fe)](_0x545c56);return;}console[_0xb2c519(0x202)](_0xb2c519(0x292)+_0x545c56+'\x20current\x20status:\x20'+_0x3b166c[_0xb2c519(0x259)]);if(_0x3b166c[_0xb2c519(0x259)]!==_0xb2c519(0x25d)){console[_0xb2c519(0x202)](_0xb2c519(0x255)+_0x545c56+_0xb2c519(0x289)+_0x3b166c['status']+_0xb2c519(0x2ab)),this[_0xb2c519(0x1fe)](_0x545c56);return;}const _0x18acec=Math[_0xb2c519(0x2a6)]((Date[_0xb2c519(0x1dc)]()-_0x3b166c[_0xb2c519(0x21a)][_0xb2c519(0x267)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x18acec>=this[_0xb2c519(0x258)]){console[_0xb2c519(0x202)](_0xb2c519(0x227)+_0x545c56+_0xb2c519(0x1ce)+this['EXPIRY_DAYS']+_0xb2c519(0x1cc)),this['clearPaymentTimers'](_0x545c56);return;}await this[_0xb2c519(0x29f)](_0x545c56),console[_0xb2c519(0x202)]('‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x545c56);}catch(_0x3778bc){console['error'](_0xb2c519(0x257)+_0x545c56+':',_0x3778bc),this[_0xb2c519(0x1fa)](_0x545c56,_0x514b9e,_0x3778bc,_0xb2c519(0x1f3),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x57172f[_0x250e04(0x23b)](_0x183f1b),this[_0x250e04(0x28c)][_0x250e04(0x206)](_0x545c56,{'timers':_0x57172f,'paymentId':_0x545c56,'gatewayPaymentId':_0x514b9e,'createdAt':_0x2c2844}),console[_0x250e04(0x202)](_0x250e04(0x20c)+_0x40b4fa[_0x250e04(0x26b)]+_0x250e04(0x1d2)+_0x545c56),console[_0x250e04(0x202)]('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x250e04(0x28c)][_0x250e04(0x23c)]),this['logCoinToPayStatus'](_0x545c56,_0x514b9e,_0x250e04(0x25d),_0x250e04(0x25d),_0x250e04(0x1f3),{'action':_0x250e04(0x200),'scheduledChecks':_0x40b4fa[_0x250e04(0x26b)],'firstCheckIn':_0x40b4fa[0x0][_0x250e04(0x1d4)]/0x3e8,'totalTimers':this['paymentTimers']['size']});}['clearPaymentTimers'](_0x455800){const _0x217f90=a37_0x4c2d23,_0x2490fe=this[_0x217f90(0x28c)][_0x217f90(0x20f)](_0x455800);_0x2490fe?(console['log'](_0x217f90(0x282)+_0x2490fe[_0x217f90(0x271)]['length']+_0x217f90(0x204)+_0x455800),_0x2490fe['timers'][_0x217f90(0x1d0)]((_0x5e9a2a,_0x429c90)=>{const _0x52bb29=_0x217f90;_0x5e9a2a&&(clearTimeout(_0x5e9a2a),clearInterval(_0x5e9a2a),console['log'](_0x52bb29(0x211)+(_0x429c90+0x1)+_0x52bb29(0x2b1)+_0x455800));}),this[_0x217f90(0x28c)][_0x217f90(0x279)](_0x455800),console[_0x217f90(0x202)](_0x217f90(0x248)+_0x455800+'.\x20Remaining\x20active\x20timers:\x20'+this['paymentTimers'][_0x217f90(0x23c)])):console[_0x217f90(0x202)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x455800+'\x20to\x20clear');}async['checkSinglePaymentById'](_0x24c316){const _0x375ce8=a37_0x4c2d23;console[_0x375ce8(0x202)](_0x375ce8(0x265)+_0x24c316);const _0x178b5a=await database_1['default'][_0x375ce8(0x277)]['findUnique']({'where':{'id':_0x24c316},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x178b5a){console[_0x375ce8(0x202)](_0x375ce8(0x1c7)+_0x24c316+_0x375ce8(0x238));return;}console[_0x375ce8(0x202)](_0x375ce8(0x217)+_0x24c316+_0x375ce8(0x252)),console[_0x375ce8(0x202)](_0x375ce8(0x1f5)+_0x178b5a[_0x375ce8(0x24b)]),console[_0x375ce8(0x202)]('\x20\x20\x20-\x20Status:\x20'+_0x178b5a[_0x375ce8(0x259)]),console[_0x375ce8(0x202)](_0x375ce8(0x20d)+_0x178b5a['gatewayPaymentId']),console[_0x375ce8(0x202)]('\x20\x20\x20-\x20Amount:\x20'+_0x178b5a[_0x375ce8(0x244)]+'\x20'+_0x178b5a[_0x375ce8(0x1eb)]),console[_0x375ce8(0x202)](_0x375ce8(0x215)+_0x178b5a['shopId']);if(_0x178b5a[_0x375ce8(0x24b)]!==_0x375ce8(0x1e2)){console[_0x375ce8(0x202)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x24c316+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x178b5a[_0x375ce8(0x24b)]+')');return;}if(_0x178b5a[_0x375ce8(0x259)]!==_0x375ce8(0x25d)){console[_0x375ce8(0x202)](_0x375ce8(0x1d7)+_0x24c316+_0x375ce8(0x289)+_0x178b5a[_0x375ce8(0x259)]+_0x375ce8(0x2ab)),this['clearPaymentTimers'](_0x24c316);return;}if(!_0x178b5a[_0x375ce8(0x2a7)]){console[_0x375ce8(0x202)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x24c316+_0x375ce8(0x231));return;}console['log'](_0x375ce8(0x243)+_0x24c316+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this['checkSinglePayment'](_0x178b5a);}[a37_0x4c2d23(0x2ac)](_0x122b21,_0x2cb460,_0x58c94e,_0x3d8599,_0xbac1a3,_0x522b65){const _0x1704d2=a37_0x4c2d23,_0x2d83ac={'type':_0x1704d2(0x22a),'paymentId':_0x122b21,'gatewayPaymentId':_0x2cb460,'oldStatus':_0x58c94e,'newStatus':_0x3d8599,'source':_0xbac1a3,'timestamp':new Date()[_0x1704d2(0x2aa)](),'details':_0x522b65||{}};loggerService_1[_0x1704d2(0x22d)][_0x1704d2(0x2ac)](_0x2d83ac),console[_0x1704d2(0x202)]('ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x122b21+'\x20('+_0x2cb460+')'),console['log'](_0x1704d2(0x232)+_0x58c94e+_0x1704d2(0x295)+_0x3d8599),console[_0x1704d2(0x202)]('\x20\x20\x20üìç\x20Source:\x20'+_0xbac1a3),console[_0x1704d2(0x202)](_0x1704d2(0x29e)+_0x2d83ac['timestamp']),_0x522b65&&console[_0x1704d2(0x202)](_0x1704d2(0x1ca),_0x522b65);}[a37_0x4c2d23(0x1fa)](_0x6bb13e,_0x346b73,_0x114c2b,_0x541f68,_0x35ebb7){const _0x4cf7c1=a37_0x4c2d23,_0x308027={'type':_0x4cf7c1(0x22b),'paymentId':_0x6bb13e,'gatewayPaymentId':_0x346b73,'error':_0x114c2b instanceof Error?{'message':_0x114c2b['message'],'stack':_0x114c2b[_0x4cf7c1(0x23e)]}:_0x114c2b,'source':_0x541f68,'timestamp':new Date()[_0x4cf7c1(0x2aa)](),'context':_0x35ebb7||{}};loggerService_1[_0x4cf7c1(0x22d)]['logCoinToPayError'](_0x308027),console['error'](_0x4cf7c1(0x224)+_0x6bb13e+'\x20('+_0x346b73+')'),console[_0x4cf7c1(0x21b)](_0x4cf7c1(0x216)+(_0x114c2b instanceof Error?_0x114c2b['message']:_0x114c2b)),console['error'](_0x4cf7c1(0x28e)+_0x541f68),console[_0x4cf7c1(0x21b)](_0x4cf7c1(0x29e)+_0x308027[_0x4cf7c1(0x1ee)]),_0x35ebb7&&console[_0x4cf7c1(0x21b)](_0x4cf7c1(0x273),_0x35ebb7);}['startPeriodicStatusCheck'](){const _0x24641b=a37_0x4c2d23;console[_0x24641b(0x202)](_0x24641b(0x1ed)),this[_0x24641b(0x29c)]()[_0x24641b(0x226)](_0x533a79=>{const _0x16c80e=_0x24641b;console[_0x16c80e(0x21b)](_0x16c80e(0x245),_0x533a79);}),this[_0x24641b(0x2a3)]=setInterval(async()=>{const _0x27abee=_0x24641b;try{console[_0x27abee(0x202)](_0x27abee(0x2b2)),await this['checkAllPendingPayments'](),console[_0x27abee(0x202)](_0x27abee(0x222));}catch(_0x3c6d9b){console[_0x27abee(0x21b)]('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x3c6d9b);}},this[_0x24641b(0x270)]),console['log'](_0x24641b(0x1cf));}['stopPeriodicStatusCheck'](){const _0x34a816=a37_0x4c2d23;console[_0x34a816(0x202)](_0x34a816(0x297));this[_0x34a816(0x2a3)]&&(clearInterval(this[_0x34a816(0x2a3)]),this[_0x34a816(0x2a3)]=null,console[_0x34a816(0x202)](_0x34a816(0x1e6)));const _0x50d5eb=this['paymentTimers'][_0x34a816(0x23c)];for(const [_0x1f95c9]of this['paymentTimers']){this[_0x34a816(0x1fe)](_0x1f95c9);}console[_0x34a816(0x202)](_0x34a816(0x1e7)+_0x50d5eb+'\x20individual\x20payment\x20timers');}async[a37_0x4c2d23(0x29c)](){const _0x686da2=a37_0x4c2d23;try{console[_0x686da2(0x202)](_0x686da2(0x239));const _0x32036c=await database_1[_0x686da2(0x1c9)][_0x686da2(0x277)][_0x686da2(0x213)]({'where':{'gateway':_0x686da2(0x1e2),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x686da2(0x202)](_0x686da2(0x24a)+_0x32036c[_0x686da2(0x26b)]+_0x686da2(0x28f));if(_0x32036c[_0x686da2(0x26b)]===0x0){console[_0x686da2(0x202)]('ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x40069c=await this[_0x686da2(0x249)](_0x32036c);console[_0x686da2(0x202)](_0x686da2(0x268)+_0x40069c[_0x686da2(0x26b)]+_0x686da2(0x21d));let _0x4d3d4d=0x0,_0x2d5c5a=0x0;for(const _0x519198 of _0x32036c){try{if(_0x40069c[_0x686da2(0x250)](_0x519198['id'])){console['log']('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x519198['id']+_0x686da2(0x293)),_0x2d5c5a++;continue;}if(this[_0x686da2(0x28c)][_0x686da2(0x2a9)](_0x519198['id'])){console[_0x686da2(0x202)](_0x686da2(0x28b)+_0x519198['id']+_0x686da2(0x240)),_0x2d5c5a++;continue;}const _0x5d73b0=(Date[_0x686da2(0x1dc)]()-_0x519198[_0x686da2(0x21a)][_0x686da2(0x267)]())/(0x3e8*0x3c*0x3c);if(_0x5d73b0<0x1){console['log'](_0x686da2(0x28b)+_0x519198['id']+_0x686da2(0x291)+_0x5d73b0[_0x686da2(0x1f4)](0x1)+_0x686da2(0x27d)),_0x2d5c5a++;continue;}console[_0x686da2(0x202)](_0x686da2(0x256)+_0x519198['id']+_0x686da2(0x241)+_0x5d73b0['toFixed'](0x1)+'h)'),await this[_0x686da2(0x299)](_0x519198),_0x4d3d4d++,await new Promise(_0x11d140=>setTimeout(_0x11d140,0x7d0));}catch(_0x5f4ec7){console['error'](_0x686da2(0x219)+_0x519198['id']+':',_0x5f4ec7),this[_0x686da2(0x1fa)](_0x519198['id'],_0x519198[_0x686da2(0x2a7)]||_0x686da2(0x23f),_0x5f4ec7,_0x686da2(0x1f3),{'isGlobalCheck':!![],'paymentAmount':_0x519198[_0x686da2(0x244)],'paymentCurrency':_0x519198['currency'],'shopId':_0x519198[_0x686da2(0x278)],'createdAt':_0x519198[_0x686da2(0x21a)]}),loggerService_1['loggerService']['logWhiteDomainError'](_0x686da2(0x1e2),_0x686da2(0x1db)+_0x519198['gatewayPaymentId'],_0x5f4ec7);}}console['log']('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x4d3d4d+_0x686da2(0x205)+_0x2d5c5a+'\x20skipped,\x20'+_0x40069c[_0x686da2(0x26b)]+_0x686da2(0x287));}catch(_0x1683de){console[_0x686da2(0x21b)](_0x686da2(0x1e1),_0x1683de);}}async[a37_0x4c2d23(0x249)](_0x5c806d){const _0x375954=a37_0x4c2d23,_0x551353=[],_0x4501bf=new Date();_0x4501bf[_0x375954(0x235)](_0x4501bf[_0x375954(0x22f)]()-this[_0x375954(0x258)]),console[_0x375954(0x202)](_0x375954(0x266)+this[_0x375954(0x258)]+'\x20days\x20(created\x20before\x20'+_0x4501bf[_0x375954(0x2aa)]()+')');for(const _0x4c761a of _0x5c806d){if(_0x4c761a['createdAt']<_0x4501bf){console[_0x375954(0x202)](_0x375954(0x209)+_0x4c761a['id']+_0x375954(0x1ce)+this['EXPIRY_DAYS']+_0x375954(0x1e0));try{this[_0x375954(0x2ac)](_0x4c761a['id'],_0x4c761a[_0x375954(0x2a7)]||_0x375954(0x23f),_0x375954(0x25d),_0x375954(0x269),_0x375954(0x27a),{'reason':_0x375954(0x251)+this[_0x375954(0x258)]+'\x20days','createdAt':_0x4c761a[_0x375954(0x21a)],'daysSinceCreation':Math[_0x375954(0x2a6)]((Date[_0x375954(0x1dc)]()-_0x4c761a[_0x375954(0x21a)][_0x375954(0x267)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x4c761a[_0x375954(0x244)],'paymentCurrency':_0x4c761a[_0x375954(0x1eb)],'shopId':_0x4c761a['shopId']}),await database_1['default'][_0x375954(0x277)][_0x375954(0x29d)]({'where':{'id':_0x4c761a['id']},'data':{'status':_0x375954(0x269),'updatedAt':new Date(),'adminNotes':_0x375954(0x286)+this[_0x375954(0x258)]+_0x375954(0x201)}}),await database_1[_0x375954(0x1c9)][_0x375954(0x1f0)][_0x375954(0x1d8)]({'data':{'paymentId':_0x4c761a['id'],'shopId':_0x4c761a[_0x375954(0x278)],'event':_0x375954(0x24e),'statusCode':0xc8,'responseBody':JSON[_0x375954(0x20b)]({'reason':_0x375954(0x251)+this[_0x375954(0x258)]+_0x375954(0x285),'createdAt':_0x4c761a[_0x375954(0x21a)],'expiredAt':new Date()[_0x375954(0x2aa)](),'daysSinceCreation':Math['floor']((Date[_0x375954(0x1dc)]()-_0x4c761a[_0x375954(0x21a)][_0x375954(0x267)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x4c761a,_0x375954(0x269)),await this[_0x375954(0x26a)](_0x4c761a,'EXPIRED'),this[_0x375954(0x1fe)](_0x4c761a['id']),_0x551353[_0x375954(0x23b)](_0x4c761a['id']),console['log']('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x4c761a['id']+_0x375954(0x1f9)+this[_0x375954(0x258)]+_0x375954(0x1f6));}catch(_0x126d93){console[_0x375954(0x21b)](_0x375954(0x21c)+_0x4c761a['id']+':',_0x126d93),this[_0x375954(0x1fa)](_0x4c761a['id'],_0x4c761a[_0x375954(0x2a7)]||_0x375954(0x23f),_0x126d93,'auto_expire',{'reason':_0x375954(0x21f),'createdAt':_0x4c761a['createdAt'],'daysSinceCreation':Math['floor']((Date[_0x375954(0x1dc)]()-_0x4c761a['createdAt'][_0x375954(0x267)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x551353;}async[a37_0x4c2d23(0x299)](_0x4b7fb1){const _0x206bb5=a37_0x4c2d23;if(!_0x4b7fb1['gatewayPaymentId']){console[_0x206bb5(0x202)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x4b7fb1['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x206bb5(0x202)]('üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x4b7fb1['id']+'\x20('+_0x4b7fb1[_0x206bb5(0x2a7)]+')');try{const _0x2ec723=await this[_0x206bb5(0x2ae)][_0x206bb5(0x1ff)](_0x4b7fb1[_0x206bb5(0x2a7)]);console['log'](_0x206bb5(0x217)+_0x4b7fb1['id']+_0x206bb5(0x2a1)+_0x2ec723[_0x206bb5(0x259)]);_0x2ec723[_0x206bb5(0x20a)]&&console['log'](_0x206bb5(0x217)+_0x4b7fb1['id']+_0x206bb5(0x233),{'iban':_0x2ec723['paymentDetails'][_0x206bb5(0x274)]||'not\x20found','transactionId':_0x2ec723[_0x206bb5(0x20a)]['transactionId'],'createdOn':_0x2ec723['paymentDetails']['createdOn'],'confirmedOn':_0x2ec723[_0x206bb5(0x20a)][_0x206bb5(0x1de)]||'not\x20confirmed'});if(_0x2ec723['status']!==_0x4b7fb1['status']){console['log'](_0x206bb5(0x260)+_0x4b7fb1['id']+_0x206bb5(0x24d)+_0x4b7fb1['status']+_0x206bb5(0x2a4)+_0x2ec723[_0x206bb5(0x259)]),this[_0x206bb5(0x2ac)](_0x4b7fb1['id'],_0x4b7fb1[_0x206bb5(0x2a7)],_0x4b7fb1[_0x206bb5(0x259)],_0x2ec723[_0x206bb5(0x259)],'status_check',{'paymentDetails':_0x2ec723[_0x206bb5(0x20a)],'amount':_0x2ec723[_0x206bb5(0x244)],'currency':_0x2ec723[_0x206bb5(0x1eb)],'shopId':_0x4b7fb1['shopId'],'checkTimestamp':new Date()[_0x206bb5(0x2aa)]()});const _0x1c4d80={'status':_0x2ec723['status'],'updatedAt':new Date()};_0x2ec723['status']===_0x206bb5(0x24f)&&_0x4b7fb1[_0x206bb5(0x259)]!=='PAID'&&(_0x1c4d80[_0x206bb5(0x1ef)]=new Date(),console['log'](_0x206bb5(0x228)+_0x4b7fb1['id']+_0x206bb5(0x2af)+_0x1c4d80[_0x206bb5(0x1ef)]['toISOString']()));if(_0x2ec723['paymentDetails']){const _0x14a6fe=_0x2ec723[_0x206bb5(0x20a)];_0x14a6fe['iban']&&(_0x1c4d80['remitterIban']=_0x14a6fe['iban'],console[_0x206bb5(0x202)](_0x206bb5(0x264)+_0x14a6fe[_0x206bb5(0x274)]));if(_0x14a6fe[_0x206bb5(0x22c)]){const _0x56f409=_0x4b7fb1[_0x206bb5(0x1ea)]||'',_0x4b2662='Bank\x20Details:\x20'+_0x14a6fe[_0x206bb5(0x22c)];_0x1c4d80[_0x206bb5(0x1ea)]=_0x56f409?_0x56f409+'\x0a\x0a'+_0x4b2662:_0x4b2662,console['log'](_0x206bb5(0x218));}_0x14a6fe['transactionId']&&console[_0x206bb5(0x202)]('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x14a6fe[_0x206bb5(0x2ad)]),_0x14a6fe[_0x206bb5(0x1de)]&&console[_0x206bb5(0x202)]('‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x14a6fe[_0x206bb5(0x1de)]);}await database_1[_0x206bb5(0x1c9)]['payment'][_0x206bb5(0x29d)]({'where':{'id':_0x4b7fb1['id']},'data':_0x1c4d80}),await database_1['default'][_0x206bb5(0x1f0)][_0x206bb5(0x1d8)]({'data':{'paymentId':_0x4b7fb1['id'],'shopId':_0x4b7fb1[_0x206bb5(0x278)],'event':_0x206bb5(0x275)+_0x2ec723['status'][_0x206bb5(0x25f)](),'statusCode':0xc8,'responseBody':JSON[_0x206bb5(0x20b)]({'oldStatus':_0x4b7fb1[_0x206bb5(0x259)],'newStatus':_0x2ec723[_0x206bb5(0x259)],'paymentDetails':_0x2ec723[_0x206bb5(0x20a)],'checkedAt':new Date()[_0x206bb5(0x2aa)]()})}}),await this[_0x206bb5(0x276)](_0x4b7fb1,_0x2ec723['status']),await this[_0x206bb5(0x26a)](_0x4b7fb1,_0x2ec723[_0x206bb5(0x259)]),_0x2ec723['status']!==_0x206bb5(0x25d)&&(console[_0x206bb5(0x202)](_0x206bb5(0x25c)+_0x4b7fb1['id']+_0x206bb5(0x281)+_0x2ec723[_0x206bb5(0x259)]+_0x206bb5(0x28a)),this[_0x206bb5(0x1fe)](_0x4b7fb1['id'])),console['log'](_0x206bb5(0x243)+_0x4b7fb1['id']+_0x206bb5(0x263));}else console[_0x206bb5(0x202)](_0x206bb5(0x217)+_0x4b7fb1['id']+_0x206bb5(0x24c)+_0x2ec723['status']+')'),this[_0x206bb5(0x2ac)](_0x4b7fb1['id'],_0x4b7fb1[_0x206bb5(0x2a7)],_0x4b7fb1[_0x206bb5(0x259)],_0x2ec723['status'],_0x206bb5(0x1f3),{'statusUnchanged':!![],'paymentDetails':_0x2ec723[_0x206bb5(0x20a)],'amount':_0x2ec723[_0x206bb5(0x244)],'currency':_0x2ec723['currency'],'shopId':_0x4b7fb1['shopId'],'checkTimestamp':new Date()['toISOString']()});}catch(_0x4e6cd8){console[_0x206bb5(0x21b)](_0x206bb5(0x247)+_0x4b7fb1['id']+':',_0x4e6cd8),this[_0x206bb5(0x1fa)](_0x4b7fb1['id'],_0x4b7fb1[_0x206bb5(0x2a7)],_0x4e6cd8,_0x206bb5(0x1f3),{'paymentAmount':_0x4b7fb1['amount'],'paymentCurrency':_0x4b7fb1[_0x206bb5(0x1eb)],'shopId':_0x4b7fb1[_0x206bb5(0x278)],'createdAt':_0x4b7fb1[_0x206bb5(0x21a)]}),await database_1['default'][_0x206bb5(0x1f0)][_0x206bb5(0x1d8)]({'data':{'paymentId':_0x4b7fb1['id'],'shopId':_0x4b7fb1[_0x206bb5(0x278)],'event':_0x206bb5(0x1e4),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x4e6cd8 instanceof Error?_0x4e6cd8['message']:_0x206bb5(0x253),'gatewayPaymentId':_0x4b7fb1['gatewayPaymentId'],'checkedAt':new Date()[_0x206bb5(0x2aa)]()})}});}}async[a37_0x4c2d23(0x276)](_0xdf7234,_0x2ce35e){const _0x55afb2=a37_0x4c2d23,_0x4bf634=Date[_0x55afb2(0x1dc)]();try{const _0x3f469e=_0xdf7234['shop'],_0x2143d3=_0x3f469e[_0x55afb2(0x23d)];if(!_0x2143d3?.[_0x55afb2(0x1da)]){console['log'](_0x55afb2(0x1d5)+_0x3f469e['id']);return;}const _0x154c5e=_0x2ce35e===_0x55afb2(0x24f)?'payment.success':_0x2ce35e==='FAILED'?_0x55afb2(0x210):_0x2ce35e===_0x55afb2(0x269)?'payment.failed':_0x55afb2(0x25a);if(!_0x2143d3[_0x55afb2(0x29a)]?.[_0x55afb2(0x250)](_0x154c5e)){console[_0x55afb2(0x202)](_0x55afb2(0x290)+_0x154c5e+_0x55afb2(0x221)+_0x3f469e['id']);return;}const _0x1e1b1d={'event':_0x154c5e,'payment':{'id':_0xdf7234['id'],'order_id':_0xdf7234[_0x55afb2(0x203)],'gateway_order_id':_0xdf7234[_0x55afb2(0x26e)],'gateway':_0x55afb2(0x288),'amount':_0xdf7234[_0x55afb2(0x244)],'currency':_0xdf7234[_0x55afb2(0x1eb)],'status':_0x2ce35e['toLowerCase'](),'customer_email':_0xdf7234[_0x55afb2(0x29b)],'customer_name':_0xdf7234[_0x55afb2(0x254)],'created_at':_0xdf7234['createdAt'],'updated_at':new Date()}},_0xe364ac=await fetch(_0x2143d3[_0x55afb2(0x1da)],{'method':_0x55afb2(0x1f1),'headers':{'Content-Type':'application/json','User-Agent':_0x55afb2(0x283)},'body':JSON[_0x55afb2(0x20b)](_0x1e1b1d)}),_0x6e43f6=Date['now']()-_0x4bf634,_0x6f27aa=_0xe364ac['ok']?_0x55afb2(0x1c8):await _0xe364ac['text']();loggerService_1['loggerService'][_0x55afb2(0x212)](_0xdf7234[_0x55afb2(0x278)],_0x2143d3[_0x55afb2(0x1da)],_0x154c5e,_0xe364ac[_0x55afb2(0x259)],_0x6e43f6,_0x1e1b1d),console[_0x55afb2(0x202)](_0x55afb2(0x272)+_0x2143d3[_0x55afb2(0x1da)]+_0x55afb2(0x234)+_0xe364ac[_0x55afb2(0x259)]+'\x20('+_0x6e43f6+'ms)');}catch(_0x201f69){console[_0x55afb2(0x21b)](_0x55afb2(0x262),_0x201f69),loggerService_1[_0x55afb2(0x22d)]['logShopWebhookError'](_0xdf7234['shopId'],_0xdf7234[_0x55afb2(0x1e8)]?.['settings']?.[_0x55afb2(0x1da)]||_0x55afb2(0x23f),'webhook_send',_0x201f69,{});}}async[a37_0x4c2d23(0x26a)](_0x21ef26,_0x598b43){const _0x599c5f=a37_0x4c2d23;try{const _0x40d2e8={'PENDING':_0x599c5f(0x284),'PAID':_0x599c5f(0x1d6),'FAILED':_0x599c5f(0x25e),'EXPIRED':_0x599c5f(0x23a)},_0x203a2e=_0x40d2e8[_0x598b43];if(!_0x203a2e||_0x203a2e===_0x599c5f(0x284))return;await telegramBotService_1[_0x599c5f(0x20e)][_0x599c5f(0x1ec)](_0x21ef26[_0x599c5f(0x278)],_0x21ef26,_0x203a2e);}catch(_0x17ed36){console['error'](_0x599c5f(0x294),_0x17ed36);}}async[a37_0x4c2d23(0x25b)](_0xd1ae88){const _0xc65a43=a37_0x4c2d23;console[_0xc65a43(0x202)](_0xc65a43(0x26f)+_0xd1ae88);const _0x1a83c1=await database_1['default']['payment'][_0xc65a43(0x1df)]({'where':{'id':_0xd1ae88},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1a83c1)throw new Error('Payment\x20not\x20found');if(_0x1a83c1['gateway']!==_0xc65a43(0x1e2))throw new Error(_0xc65a43(0x225));console[_0xc65a43(0x202)](_0xc65a43(0x1e9)+_0xd1ae88),await this[_0xc65a43(0x299)](_0x1a83c1),console['log'](_0xc65a43(0x230)+_0xd1ae88);}[a37_0x4c2d23(0x26d)](){const _0x23f788=a37_0x4c2d23,_0x497608=this[_0x23f788(0x2a3)]?this[_0x23f788(0x270)]:undefined,_0x25d047=Array[_0x23f788(0x1d1)](this[_0x23f788(0x28c)][_0x23f788(0x1fd)]())[_0x23f788(0x207)](_0x37869e=>({'paymentId':_0x37869e['paymentId'],'gatewayPaymentId':_0x37869e[_0x23f788(0x2a7)],'createdAt':_0x37869e[_0x23f788(0x21a)],'timersCount':_0x37869e[_0x23f788(0x271)][_0x23f788(0x26b)]}));return{'isActive':!!this[_0x23f788(0x2a3)],'globalCheckIntervalMinutes':this[_0x23f788(0x270)]/(0x3e8*0x3c),'expiryDays':this[_0x23f788(0x258)],'activeIndividualTimers':this[_0x23f788(0x28c)][_0x23f788(0x23c)],'nextGlobalCheckIn':_0x497608,'paymentTimersDetails':_0x25d047};}[a37_0x4c2d23(0x296)](_0x2bbb65){const _0x347466=a37_0x4c2d23,_0xf3506d=this[_0x347466(0x28c)]['get'](_0x2bbb65);if(_0xf3506d)return{'hasTimers':!![],'timersCount':_0xf3506d[_0x347466(0x271)][_0x347466(0x26b)],'createdAt':_0xf3506d[_0x347466(0x21a)],'gatewayPaymentId':_0xf3506d[_0x347466(0x2a7)]};return{'hasTimers':![]};}}exports[a37_0x4c2d23(0x2a0)]=CoinToPayStatusService,exports[a37_0x4c2d23(0x208)]=new CoinToPayStatusService();