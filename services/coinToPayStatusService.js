'use strict';const a37_0x4cb66c=a37_0x1cde;(function(_0x340f46,_0x2ff8ca){const _0x20bcf7=a37_0x1cde,_0x513a72=_0x340f46();while(!![]){try{const _0x153e6f=parseInt(_0x20bcf7(0x259))/0x1*(-parseInt(_0x20bcf7(0x239))/0x2)+parseInt(_0x20bcf7(0x1b5))/0x3+-parseInt(_0x20bcf7(0x1bd))/0x4+parseInt(_0x20bcf7(0x1b9))/0x5*(-parseInt(_0x20bcf7(0x1ca))/0x6)+-parseInt(_0x20bcf7(0x275))/0x7+parseInt(_0x20bcf7(0x201))/0x8+parseInt(_0x20bcf7(0x1f4))/0x9;if(_0x153e6f===_0x2ff8ca)break;else _0x513a72['push'](_0x513a72['shift']());}catch(_0x143286){_0x513a72['push'](_0x513a72['shift']());}}}(a37_0x5539,0x7b44b));function a37_0x1cde(_0x5f42d4,_0x5887fa){const _0x5539af=a37_0x5539();return a37_0x1cde=function(_0x1cde12,_0x2e377a){_0x1cde12=_0x1cde12-0x1ac;let _0x4f6322=_0x5539af[_0x1cde12];return _0x4f6322;},a37_0x1cde(_0x5f42d4,_0x5887fa);}var __importDefault=this&&this[a37_0x4cb66c(0x26c)]||function(_0x114756){const _0x9a2239=a37_0x4cb66c;return _0x114756&&_0x114756[_0x9a2239(0x258)]?_0x114756:{'default':_0x114756};};Object[a37_0x4cb66c(0x1ce)](exports,'__esModule',{'value':!![]}),exports[a37_0x4cb66c(0x255)]=exports['CoinToPayStatusService']=void 0x0;function a37_0x5539(){const _0x24df23=['.\x20Remaining\x20active\x20timers:\x20','includes','🪙\x20[DEBUG]\x20Creating\x20','1201137PkVcRe','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','Bank\x20Details:\x20','\x20updated\x20successfully','ms)','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','⏰\x20[EXPIRY]\x20Payment\x20','\x20status\x20is\x20','\x20is\x20too\x20new\x20(','sendPaymentStatusNotification','\x20to\x20','\x20has\x20no\x20gatewayPaymentId','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','Failed\x20to\x20mark\x20payment\x20as\x20expired','CoinToPayStatusService','logShopWebhookSent','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20status\x20changed\x20to\x20','createdOn','shopId','stack','failed','\x20to\x20clear','shop','customerName','webhookLog','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','\x20\x20\x20📅\x20Time:\x20','\x20not\x20enabled\x20for\x20shop\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','logWhiteDomainError','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20(after\x20','\x20\x20\x20📊\x20Status:\x20','GLOBAL_CHECK_INTERVAL_MS','./gateways/coinToPayService','1846749lonTWg','has','✅\x20[CHECK]\x20Payment\x20','⏰\x20[HOURLY]\x20Payment\x20','39670WeEbIL','size','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','3565520MUAmLa','application/json','createdAt','logShopWebhookError','\x20timers\x20for\x20payment\x20','payment.success','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','Unknown\x20error','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20for\x20payment\x20','auto_expire','adminNotes','138LscQbW','from','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','Failed\x20to\x20send\x20shop\x20webhook:','defineProperty','FAILED','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','catch','TesSoft\x20Payment\x20System/1.0','logCoinToPayError','\x20with\x20status\x20','push','\x20days','getTime','\x20->\x20','cointopay','0100','\x20days\x20(created\x20before\x20','2\x20minutes','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20not\x20found\x20in\x20database','\x20individual\x20payment\x20timers','POST','EXPIRED','now','./loggerService','remitterIban','checkAllPendingPayments','\x20\x20\x20-\x20Status:\x20','payment.failed','paidAt','transactionId','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','bankDetails','sendPaymentNotification','\x20completed\x20for\x20payment\x20','checkSinglePaymentById','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20\x20\x20-\x20Amount:\x20','\x20\x20\x20📍\x20Source:\x20','paymentDetails','12058326EeiUqK','error','\x20current\x20status:\x20','📊\x20[HOURLY]\x20Payment\x20','💰\x20[CHECK]\x20Payment\x20','toISOString','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','\x20marked\x20as\x20paid\x20at:\x20','\x20details:','\x20\x20\x20📝\x20Details:','gateway','2666880ylbzXb','\x20\x20\x20-\x20ShopId:\x20','h),\x20skipping\x20global\x20check','⏰\x20[GLOBAL]\x20Payment\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','webhook_send','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','sendShopWebhook','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','payment','settings','schedulePaymentChecks','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20\x20\x20-\x20Gateway:\x20','length','paymentId','cointopay_auto_expired','stringify','🪙\x20[TIMER]\x20Individual\x20check\x20#','forEach','paymentTimers','\x20checked,\x20','update','logCoinToPayStatus','message','CoinToPayService','default','amount','getServiceStats','PAID','📊\x20[CHECK]\x20Payment\x20','\x20triggered\x20for\x20payment\x20','timers','globalCheckInterval','toLowerCase','PENDING','5\x20minutes','\x20is\x20older\x20than\x20','create','orderId',',\x20stopping\x20individual\x20checks','checkPaymentStatus','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','gatewayOrderId','currency','unknown','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20in\x20','startPeriodicStatusCheck','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','map','EXPIRY_DAYS','delay','Webhook\x20event\x20','1076794ArQlVW','\x20found:','gatewayPaymentId','❌\x20[CHECK]\x20Payment\x20','Shop\x20webhook\x20sent\x20to\x20','\x20\x20\x20❌\x20Error:\x20','status','customerEmail','Payment\x20not\x20found','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','floor','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','created','🪙\x20[GLOBAL]\x20Found\x20','findMany','⚠️\x20[CHECK]\x20Payment\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','coinToPayService','confirmedOn','status_check','checkSinglePayment','loggerService','timestamp','🛑\x20[SHUTDOWN]\x20Cleared\x20','description','paid','✅\x20[EXPIRY]\x20Payment\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','coinToPayStatusService','log','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','__esModule','1eotVtu','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20(age:\x20','/status/','iban','\x20days,\x20marking\x20as\x20EXPIRED','-day\x20timeout','./telegramBotService','clearPaymentTimers','checkPaymentById','COINTOPAY_ERROR','\x20status\x20unchanged\x20(','webhookUrl','getDate','telegramBotService','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','toFixed','__importDefault','schedule_created','findUnique',',\x20clearing\x20individual\x20timers','checkExpiredPayments','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'];a37_0x5539=function(){return _0x24df23;};return a37_0x5539();}const coinToPayService_1=require(a37_0x4cb66c(0x1b4)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x4cb66c(0x262)),loggerService_1=require(a37_0x4cb66c(0x1e4));class CoinToPayStatusService{constructor(){const _0x1be26f=a37_0x4cb66c;this[_0x1be26f(0x224)]=null,this[_0x1be26f(0x1b3)]=0x3c*0x3c*0x3e8,this[_0x1be26f(0x236)]=0x5,this[_0x1be26f(0x217)]=new Map(),this[_0x1be26f(0x24a)]=new coinToPayService_1[(_0x1be26f(0x21c))](),console['log']('🪙\x20CoinToPayStatusService\x20initialized');}[a37_0x4cb66c(0x20e)](_0x4e1613,_0x3864d0){const _0x2b2167=a37_0x4cb66c;console[_0x2b2167(0x256)](_0x2b2167(0x271)),console[_0x2b2167(0x256)]('\x20\x20\x20-\x20paymentId:\x20'+_0x4e1613),console[_0x2b2167(0x256)](_0x2b2167(0x25b)+_0x3864d0),this['clearPaymentTimers'](_0x4e1613);const _0x2101d9=[],_0x2d36c0=new Date(),_0x239681=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x2b2167(0x1dd)},{'delay':0x5*0x3c*0x3e8,'description':_0x2b2167(0x227)},{'delay':0x5*0x3c*0x3e8,'description':_0x2b2167(0x227)}];console[_0x2b2167(0x256)](_0x2b2167(0x274)+_0x239681[_0x2b2167(0x211)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x4e1613);let _0x4bb86d=0x0;_0x239681['forEach']((_0x405eff,_0x3b8225)=>{const _0x3fff2f=_0x2b2167;_0x4bb86d+=_0x405eff[_0x3fff2f(0x237)];const _0x57ca8e=setTimeout(async()=>{const _0x1d8c30=_0x3fff2f;console[_0x1d8c30(0x256)](_0x1d8c30(0x215)+(_0x3b8225+0x1)+_0x1d8c30(0x222)+_0x4e1613+_0x1d8c30(0x1b1)+_0x405eff[_0x1d8c30(0x251)]+')');try{await this['checkSinglePaymentById'](_0x4e1613),console[_0x1d8c30(0x256)](_0x1d8c30(0x1c4)+(_0x3b8225+0x1)+_0x1d8c30(0x1ee)+_0x4e1613);}catch(_0x3d5b85){console[_0x1d8c30(0x1f5)](_0x1d8c30(0x28f)+(_0x3b8225+0x1)+_0x1d8c30(0x1c7)+_0x4e1613+':',_0x3d5b85),this[_0x1d8c30(0x1d4)](_0x4e1613,_0x3864d0,_0x3d5b85,_0x1d8c30(0x24c),{'checkNumber':_0x3b8225+0x1,'scheduledAfter':_0x405eff[_0x1d8c30(0x251)],'isIndividualCheck':!![]});}},_0x4bb86d);_0x2101d9[_0x3fff2f(0x1d6)](_0x57ca8e),console[_0x3fff2f(0x256)](_0x3fff2f(0x20b)+(_0x3b8225+0x1)+_0x3fff2f(0x1c7)+_0x4e1613+_0x3fff2f(0x232)+_0x4bb86d/0x3e8+'\x20seconds\x20('+_0x405eff['description']+')');});const _0x53f0a8=setInterval(async()=>{const _0x57bc2b=_0x2b2167;console[_0x57bc2b(0x256)](_0x57bc2b(0x20f)+_0x4e1613);try{const _0xf48f50=await database_1[_0x57bc2b(0x21d)][_0x57bc2b(0x20c)][_0x57bc2b(0x26e)]({'where':{'id':_0x4e1613},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0xf48f50){console[_0x57bc2b(0x256)]('❌\x20[HOURLY]\x20Payment\x20'+_0x4e1613+'\x20not\x20found,\x20clearing\x20timers'),this[_0x57bc2b(0x263)](_0x4e1613);return;}console[_0x57bc2b(0x256)](_0x57bc2b(0x1f7)+_0x4e1613+_0x57bc2b(0x1f6)+_0xf48f50['status']);if(_0xf48f50[_0x57bc2b(0x23f)]!=='PENDING'){console[_0x57bc2b(0x256)]('✅\x20[HOURLY]\x20Payment\x20'+_0x4e1613+'\x20status\x20is\x20'+_0xf48f50[_0x57bc2b(0x23f)]+',\x20stopping\x20individual\x20checks'),this['clearPaymentTimers'](_0x4e1613);return;}const _0x1a972f=Math['floor']((Date[_0x57bc2b(0x1e3)]()-_0xf48f50[_0x57bc2b(0x1bf)][_0x57bc2b(0x1d8)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1a972f>=this['EXPIRY_DAYS']){console[_0x57bc2b(0x256)](_0x57bc2b(0x1b8)+_0x4e1613+_0x57bc2b(0x228)+this[_0x57bc2b(0x236)]+_0x57bc2b(0x1bb)),this[_0x57bc2b(0x263)](_0x4e1613);return;}await this['checkSinglePaymentById'](_0x4e1613),console[_0x57bc2b(0x256)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x4e1613);}catch(_0x533936){console[_0x57bc2b(0x1f5)]('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x4e1613+':',_0x533936),this['logCoinToPayError'](_0x4e1613,_0x3864d0,_0x533936,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x2101d9['push'](_0x53f0a8),this[_0x2b2167(0x217)]['set'](_0x4e1613,{'timers':_0x2101d9,'paymentId':_0x4e1613,'gatewayPaymentId':_0x3864d0,'createdAt':_0x2d36c0}),console[_0x2b2167(0x256)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x239681[_0x2b2167(0x211)]+_0x2b2167(0x1fb)+_0x4e1613),console[_0x2b2167(0x256)]('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x2b2167(0x217)][_0x2b2167(0x1ba)]),this[_0x2b2167(0x21a)](_0x4e1613,_0x3864d0,_0x2b2167(0x226),_0x2b2167(0x226),_0x2b2167(0x24c),{'action':_0x2b2167(0x26d),'scheduledChecks':_0x239681[_0x2b2167(0x211)],'firstCheckIn':_0x239681[0x0][_0x2b2167(0x237)]/0x3e8,'totalTimers':this[_0x2b2167(0x217)][_0x2b2167(0x1ba)]});}[a37_0x4cb66c(0x263)](_0x1db448){const _0x30b97a=a37_0x4cb66c,_0x5f1b46=this[_0x30b97a(0x217)]['get'](_0x1db448);_0x5f1b46?(console[_0x30b97a(0x256)]('🧹\x20[DEBUG]\x20Clearing\x20'+_0x5f1b46[_0x30b97a(0x223)][_0x30b97a(0x211)]+_0x30b97a(0x1c1)+_0x1db448),_0x5f1b46[_0x30b97a(0x223)][_0x30b97a(0x216)]((_0x174074,_0x3a4e86)=>{const _0x1df386=_0x30b97a;_0x174074&&(clearTimeout(_0x174074),clearInterval(_0x174074),console['log'](_0x1df386(0x249)+(_0x3a4e86+0x1)+_0x1df386(0x1c7)+_0x1db448));}),this[_0x30b97a(0x217)]['delete'](_0x1db448),console['log']('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x1db448+_0x30b97a(0x272)+this['paymentTimers'][_0x30b97a(0x1ba)])):console[_0x30b97a(0x256)](_0x30b97a(0x242)+_0x1db448+_0x30b97a(0x28b));}async[a37_0x4cb66c(0x1ef)](_0xfea1c7){const _0x7e1cfa=a37_0x4cb66c;console[_0x7e1cfa(0x256)](_0x7e1cfa(0x22d)+_0xfea1c7);const _0x51bd81=await database_1[_0x7e1cfa(0x21d)][_0x7e1cfa(0x20c)]['findUnique']({'where':{'id':_0xfea1c7},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x51bd81){console[_0x7e1cfa(0x256)](_0x7e1cfa(0x23c)+_0xfea1c7+_0x7e1cfa(0x1df));return;}console[_0x7e1cfa(0x256)](_0x7e1cfa(0x221)+_0xfea1c7+_0x7e1cfa(0x23a)),console[_0x7e1cfa(0x256)](_0x7e1cfa(0x210)+_0x51bd81[_0x7e1cfa(0x200)]),console[_0x7e1cfa(0x256)](_0x7e1cfa(0x1e7)+_0x51bd81[_0x7e1cfa(0x23f)]),console['log']('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x51bd81['gatewayPaymentId']),console[_0x7e1cfa(0x256)](_0x7e1cfa(0x1f1)+_0x51bd81[_0x7e1cfa(0x21e)]+'\x20'+_0x51bd81[_0x7e1cfa(0x22f)]),console[_0x7e1cfa(0x256)](_0x7e1cfa(0x202)+_0x51bd81[_0x7e1cfa(0x288)]);if(_0x51bd81[_0x7e1cfa(0x200)]!==_0x7e1cfa(0x1da)){console['log'](_0x7e1cfa(0x248)+_0xfea1c7+_0x7e1cfa(0x1fc)+_0x51bd81[_0x7e1cfa(0x200)]+')');return;}if(_0x51bd81[_0x7e1cfa(0x23f)]!==_0x7e1cfa(0x226)){console[_0x7e1cfa(0x256)]('⚠️\x20[CHECK]\x20Payment\x20'+_0xfea1c7+_0x7e1cfa(0x27c)+_0x51bd81[_0x7e1cfa(0x23f)]+_0x7e1cfa(0x22b)),this['clearPaymentTimers'](_0xfea1c7);return;}if(!_0x51bd81[_0x7e1cfa(0x23b)]){console[_0x7e1cfa(0x256)](_0x7e1cfa(0x248)+_0xfea1c7+_0x7e1cfa(0x280));return;}console[_0x7e1cfa(0x256)]('✅\x20[CHECK]\x20Payment\x20'+_0xfea1c7+_0x7e1cfa(0x285)),await this[_0x7e1cfa(0x24d)](_0x51bd81);}['logCoinToPayStatus'](_0x52aea7,_0x2d5ab1,_0x27bf82,_0x5a75ae,_0x12d554,_0x4ed4a2){const _0x401e36=a37_0x4cb66c,_0x3c8a06={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x52aea7,'gatewayPaymentId':_0x2d5ab1,'oldStatus':_0x27bf82,'newStatus':_0x5a75ae,'source':_0x12d554,'timestamp':new Date()[_0x401e36(0x1f9)](),'details':_0x4ed4a2||{}};loggerService_1[_0x401e36(0x24e)]['logCoinToPayStatus'](_0x3c8a06),console[_0x401e36(0x256)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x52aea7+'\x20('+_0x2d5ab1+')'),console['log'](_0x401e36(0x1b2)+_0x27bf82+_0x401e36(0x1d9)+_0x5a75ae),console[_0x401e36(0x256)](_0x401e36(0x1f2)+_0x12d554),console[_0x401e36(0x256)](_0x401e36(0x1ac)+_0x3c8a06[_0x401e36(0x24f)]),_0x4ed4a2&&console[_0x401e36(0x256)](_0x401e36(0x1ff),_0x4ed4a2);}[a37_0x4cb66c(0x1d4)](_0x150927,_0x1d6d44,_0x24366d,_0x100959,_0xc4f852){const _0x3737c1=a37_0x4cb66c,_0x1e3558={'type':_0x3737c1(0x265),'paymentId':_0x150927,'gatewayPaymentId':_0x1d6d44,'error':_0x24366d instanceof Error?{'message':_0x24366d[_0x3737c1(0x21b)],'stack':_0x24366d[_0x3737c1(0x289)]}:_0x24366d,'source':_0x100959,'timestamp':new Date()[_0x3737c1(0x1f9)](),'context':_0xc4f852||{}};loggerService_1[_0x3737c1(0x24e)][_0x3737c1(0x1d4)](_0x1e3558),console['error'](_0x3737c1(0x1f0)+_0x150927+'\x20('+_0x1d6d44+')'),console[_0x3737c1(0x1f5)](_0x3737c1(0x23e)+(_0x24366d instanceof Error?_0x24366d[_0x3737c1(0x21b)]:_0x24366d)),console[_0x3737c1(0x1f5)](_0x3737c1(0x1f2)+_0x100959),console['error']('\x20\x20\x20📅\x20Time:\x20'+_0x1e3558[_0x3737c1(0x24f)]),_0xc4f852&&console['error']('\x20\x20\x20📝\x20Context:',_0xc4f852);}[a37_0x4cb66c(0x233)](){const _0x23e3cc=a37_0x4cb66c;console[_0x23e3cc(0x256)](_0x23e3cc(0x27a)),this[_0x23e3cc(0x1e6)]()[_0x23e3cc(0x1d2)](_0x2e1b8a=>{const _0x4d15cf=_0x23e3cc;console[_0x4d15cf(0x1f5)](_0x4d15cf(0x1cc),_0x2e1b8a);}),this[_0x23e3cc(0x224)]=setInterval(async()=>{const _0x3ab29d=_0x23e3cc;try{console[_0x3ab29d(0x256)](_0x3ab29d(0x1d1)),await this[_0x3ab29d(0x1e6)](),console[_0x3ab29d(0x256)](_0x3ab29d(0x207));}catch(_0x318195){console[_0x3ab29d(0x1f5)](_0x3ab29d(0x1bc),_0x318195);}},this[_0x23e3cc(0x1b3)]),console[_0x23e3cc(0x256)](_0x23e3cc(0x1b0));}['stopPeriodicStatusCheck'](){const _0x25a595=a37_0x4cb66c;console[_0x25a595(0x256)](_0x25a595(0x254));this[_0x25a595(0x224)]&&(clearInterval(this['globalCheckInterval']),this[_0x25a595(0x224)]=null,console['log']('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x5057fe=this[_0x25a595(0x217)][_0x25a595(0x1ba)];for(const [_0x38b192]of this[_0x25a595(0x217)]){this['clearPaymentTimers'](_0x38b192);}console[_0x25a595(0x256)](_0x25a595(0x250)+_0x5057fe+_0x25a595(0x1e0));}async[a37_0x4cb66c(0x1e6)](){const _0x1318d1=a37_0x4cb66c;try{console[_0x1318d1(0x256)](_0x1318d1(0x276));const _0x1f9fbd=await database_1[_0x1318d1(0x21d)][_0x1318d1(0x20c)][_0x1318d1(0x247)]({'where':{'gateway':_0x1318d1(0x1da),'status':_0x1318d1(0x226),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x1318d1(0x246)+_0x1f9fbd['length']+'\x20pending\x20CoinToPay\x20payments');if(_0x1f9fbd['length']===0x0){console[_0x1318d1(0x256)](_0x1318d1(0x205));return;}const _0xc9b0ce=await this[_0x1318d1(0x270)](_0x1f9fbd);console['log']('⏰\x20[GLOBAL]\x20Found\x20'+_0xc9b0ce[_0x1318d1(0x211)]+'\x20expired\x20CoinToPay\x20payments');let _0x10a563=0x0,_0xc584aa=0x0;for(const _0x2f4cd1 of _0x1f9fbd){try{if(_0xc9b0ce[_0x1318d1(0x273)](_0x2f4cd1['id'])){console['log'](_0x1318d1(0x204)+_0x2f4cd1['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0xc584aa++;continue;}if(this['paymentTimers'][_0x1318d1(0x1b6)](_0x2f4cd1['id'])){console['log'](_0x1318d1(0x204)+_0x2f4cd1['id']+_0x1318d1(0x26a)),_0xc584aa++;continue;}const _0x2b9c6a=(Date[_0x1318d1(0x1e3)]()-_0x2f4cd1[_0x1318d1(0x1bf)][_0x1318d1(0x1d8)]())/(0x3e8*0x3c*0x3c);if(_0x2b9c6a<0x1){console['log'](_0x1318d1(0x204)+_0x2f4cd1['id']+_0x1318d1(0x27d)+_0x2b9c6a[_0x1318d1(0x26b)](0x1)+_0x1318d1(0x203)),_0xc584aa++;continue;}console[_0x1318d1(0x256)](_0x1318d1(0x1eb)+_0x2f4cd1['id']+_0x1318d1(0x25d)+_0x2b9c6a[_0x1318d1(0x26b)](0x1)+'h)'),await this['checkSinglePayment'](_0x2f4cd1),_0x10a563++,await new Promise(_0x417d77=>setTimeout(_0x417d77,0x7d0));}catch(_0x2e6e21){console[_0x1318d1(0x1f5)](_0x1318d1(0x25c)+_0x2f4cd1['id']+':',_0x2e6e21),this[_0x1318d1(0x1d4)](_0x2f4cd1['id'],_0x2f4cd1[_0x1318d1(0x23b)]||'unknown',_0x2e6e21,_0x1318d1(0x24c),{'isGlobalCheck':!![],'paymentAmount':_0x2f4cd1['amount'],'paymentCurrency':_0x2f4cd1['currency'],'shopId':_0x2f4cd1['shopId'],'createdAt':_0x2f4cd1[_0x1318d1(0x1bf)]}),loggerService_1[_0x1318d1(0x24e)][_0x1318d1(0x1af)]('cointopay',_0x1318d1(0x25e)+_0x2f4cd1['gatewayPaymentId'],_0x2e6e21);}}console[_0x1318d1(0x256)](_0x1318d1(0x231)+_0x10a563+_0x1318d1(0x218)+_0xc584aa+'\x20skipped,\x20'+_0xc9b0ce[_0x1318d1(0x211)]+'\x20expired');}catch(_0x53c068){console[_0x1318d1(0x1f5)](_0x1318d1(0x281),_0x53c068);}}async[a37_0x4cb66c(0x270)](_0x2b0dea){const _0x366486=a37_0x4cb66c,_0x15bbd7=[],_0x36703e=new Date();_0x36703e['setDate'](_0x36703e[_0x366486(0x268)]()-this[_0x366486(0x236)]),console[_0x366486(0x256)](_0x366486(0x1fa)+this[_0x366486(0x236)]+_0x366486(0x1dc)+_0x36703e[_0x366486(0x1f9)]()+')');for(const _0x11fd82 of _0x2b0dea){if(_0x11fd82[_0x366486(0x1bf)]<_0x36703e){console[_0x366486(0x256)](_0x366486(0x27b)+_0x11fd82['id']+_0x366486(0x228)+this[_0x366486(0x236)]+_0x366486(0x260));try{this[_0x366486(0x21a)](_0x11fd82['id'],_0x11fd82[_0x366486(0x23b)]||_0x366486(0x230),'PENDING',_0x366486(0x1e2),_0x366486(0x1c8),{'reason':'Payment\x20older\x20than\x20'+this[_0x366486(0x236)]+_0x366486(0x1d7),'createdAt':_0x11fd82[_0x366486(0x1bf)],'daysSinceCreation':Math[_0x366486(0x243)]((Date[_0x366486(0x1e3)]()-_0x11fd82['createdAt'][_0x366486(0x1d8)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x11fd82[_0x366486(0x21e)],'paymentCurrency':_0x11fd82['currency'],'shopId':_0x11fd82[_0x366486(0x288)]}),await database_1[_0x366486(0x21d)][_0x366486(0x20c)][_0x366486(0x219)]({'where':{'id':_0x11fd82['id']},'data':{'status':_0x366486(0x1e2),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x366486(0x236)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x366486(0x21d)][_0x366486(0x28e)][_0x366486(0x229)]({'data':{'paymentId':_0x11fd82['id'],'shopId':_0x11fd82[_0x366486(0x288)],'event':_0x366486(0x213),'statusCode':0xc8,'responseBody':JSON[_0x366486(0x214)]({'reason':'Payment\x20older\x20than\x20'+this[_0x366486(0x236)]+_0x366486(0x1d7),'createdAt':_0x11fd82['createdAt'],'expiredAt':new Date()[_0x366486(0x1f9)](),'daysSinceCreation':Math[_0x366486(0x243)]((Date[_0x366486(0x1e3)]()-_0x11fd82[_0x366486(0x1bf)][_0x366486(0x1d8)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x11fd82,_0x366486(0x1e2)),await this[_0x366486(0x27e)](_0x11fd82,_0x366486(0x1e2)),this['clearPaymentTimers'](_0x11fd82['id']),_0x15bbd7['push'](_0x11fd82['id']),console[_0x366486(0x256)](_0x366486(0x253)+_0x11fd82['id']+_0x366486(0x1c3)+this[_0x366486(0x236)]+_0x366486(0x261));}catch(_0x5f5dee){console[_0x366486(0x1f5)](_0x366486(0x244)+_0x11fd82['id']+':',_0x5f5dee),this[_0x366486(0x1d4)](_0x11fd82['id'],_0x11fd82[_0x366486(0x23b)]||_0x366486(0x230),_0x5f5dee,_0x366486(0x1c8),{'reason':_0x366486(0x282),'createdAt':_0x11fd82['createdAt'],'daysSinceCreation':Math[_0x366486(0x243)]((Date[_0x366486(0x1e3)]()-_0x11fd82[_0x366486(0x1bf)][_0x366486(0x1d8)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x15bbd7;}async[a37_0x4cb66c(0x24d)](_0x260467){const _0x5cdb84=a37_0x4cb66c;if(!_0x260467[_0x5cdb84(0x23b)]){console[_0x5cdb84(0x256)](_0x5cdb84(0x248)+_0x260467['id']+_0x5cdb84(0x1c6));return;}console[_0x5cdb84(0x256)](_0x5cdb84(0x257)+_0x260467['id']+'\x20('+_0x260467[_0x5cdb84(0x23b)]+')');try{const _0x155fde=await this[_0x5cdb84(0x24a)][_0x5cdb84(0x22c)](_0x260467[_0x5cdb84(0x23b)]);console[_0x5cdb84(0x256)](_0x5cdb84(0x221)+_0x260467['id']+'\x20status:\x20'+_0x155fde[_0x5cdb84(0x23f)]);_0x155fde[_0x5cdb84(0x1f3)]&&console[_0x5cdb84(0x256)](_0x5cdb84(0x221)+_0x260467['id']+_0x5cdb84(0x1fe),{'iban':_0x155fde[_0x5cdb84(0x1f3)]['iban']||'not\x20found','transactionId':_0x155fde[_0x5cdb84(0x1f3)]['transactionId'],'createdOn':_0x155fde[_0x5cdb84(0x1f3)][_0x5cdb84(0x287)],'confirmedOn':_0x155fde[_0x5cdb84(0x1f3)][_0x5cdb84(0x24b)]||'not\x20confirmed'});if(_0x155fde['status']!==_0x260467['status']){console[_0x5cdb84(0x256)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x260467['id']+'\x20status\x20from\x20'+_0x260467[_0x5cdb84(0x23f)]+_0x5cdb84(0x27f)+_0x155fde[_0x5cdb84(0x23f)]),this[_0x5cdb84(0x21a)](_0x260467['id'],_0x260467[_0x5cdb84(0x23b)],_0x260467[_0x5cdb84(0x23f)],_0x155fde[_0x5cdb84(0x23f)],_0x5cdb84(0x24c),{'paymentDetails':_0x155fde[_0x5cdb84(0x1f3)],'amount':_0x155fde[_0x5cdb84(0x21e)],'currency':_0x155fde[_0x5cdb84(0x22f)],'shopId':_0x260467[_0x5cdb84(0x288)],'checkTimestamp':new Date()[_0x5cdb84(0x1f9)]()});const _0x37d5c8={'status':_0x155fde['status'],'updatedAt':new Date()};_0x155fde[_0x5cdb84(0x23f)]===_0x5cdb84(0x220)&&_0x260467[_0x5cdb84(0x23f)]!==_0x5cdb84(0x220)&&(_0x37d5c8[_0x5cdb84(0x1e9)]=new Date(),console[_0x5cdb84(0x256)](_0x5cdb84(0x1f8)+_0x260467['id']+_0x5cdb84(0x1fd)+_0x37d5c8[_0x5cdb84(0x1e9)][_0x5cdb84(0x1f9)]()));if(_0x155fde['paymentDetails']){const _0x27e3d3=_0x155fde[_0x5cdb84(0x1f3)];_0x27e3d3[_0x5cdb84(0x25f)]&&(_0x37d5c8[_0x5cdb84(0x1e5)]=_0x27e3d3[_0x5cdb84(0x25f)],console['log'](_0x5cdb84(0x25a)+_0x27e3d3['iban']));if(_0x27e3d3['bankDetails']){const _0x2d5ebc=_0x260467[_0x5cdb84(0x1c9)]||'',_0x183c91=_0x5cdb84(0x277)+_0x27e3d3[_0x5cdb84(0x1ec)];_0x37d5c8[_0x5cdb84(0x1c9)]=_0x2d5ebc?_0x2d5ebc+'\x0a\x0a'+_0x183c91:_0x183c91,console[_0x5cdb84(0x256)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x27e3d3[_0x5cdb84(0x1ea)]&&console[_0x5cdb84(0x256)](_0x5cdb84(0x1d0)+_0x27e3d3[_0x5cdb84(0x1ea)]),_0x27e3d3[_0x5cdb84(0x24b)]&&console[_0x5cdb84(0x256)](_0x5cdb84(0x234)+_0x27e3d3['confirmedOn']);}await database_1[_0x5cdb84(0x21d)]['payment'][_0x5cdb84(0x219)]({'where':{'id':_0x260467['id']},'data':_0x37d5c8}),await database_1[_0x5cdb84(0x21d)][_0x5cdb84(0x28e)]['create']({'data':{'paymentId':_0x260467['id'],'shopId':_0x260467[_0x5cdb84(0x288)],'event':'cointopay_status_check_'+_0x155fde['status'][_0x5cdb84(0x225)](),'statusCode':0xc8,'responseBody':JSON[_0x5cdb84(0x214)]({'oldStatus':_0x260467[_0x5cdb84(0x23f)],'newStatus':_0x155fde[_0x5cdb84(0x23f)],'paymentDetails':_0x155fde[_0x5cdb84(0x1f3)],'checkedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x260467,_0x155fde[_0x5cdb84(0x23f)]),await this[_0x5cdb84(0x27e)](_0x260467,_0x155fde[_0x5cdb84(0x23f)]),_0x155fde[_0x5cdb84(0x23f)]!==_0x5cdb84(0x226)&&(console[_0x5cdb84(0x256)]('🧹\x20[CHECK]\x20Payment\x20'+_0x260467['id']+_0x5cdb84(0x286)+_0x155fde[_0x5cdb84(0x23f)]+_0x5cdb84(0x26f)),this['clearPaymentTimers'](_0x260467['id'])),console[_0x5cdb84(0x256)](_0x5cdb84(0x1b7)+_0x260467['id']+_0x5cdb84(0x278));}else console[_0x5cdb84(0x256)](_0x5cdb84(0x221)+_0x260467['id']+_0x5cdb84(0x266)+_0x155fde[_0x5cdb84(0x23f)]+')'),this['logCoinToPayStatus'](_0x260467['id'],_0x260467[_0x5cdb84(0x23b)],_0x260467[_0x5cdb84(0x23f)],_0x155fde[_0x5cdb84(0x23f)],_0x5cdb84(0x24c),{'statusUnchanged':!![],'paymentDetails':_0x155fde[_0x5cdb84(0x1f3)],'amount':_0x155fde[_0x5cdb84(0x21e)],'currency':_0x155fde['currency'],'shopId':_0x260467[_0x5cdb84(0x288)],'checkTimestamp':new Date()[_0x5cdb84(0x1f9)]()});}catch(_0x3160b7){console['error'](_0x5cdb84(0x1de)+_0x260467['id']+':',_0x3160b7),this[_0x5cdb84(0x1d4)](_0x260467['id'],_0x260467[_0x5cdb84(0x23b)],_0x3160b7,_0x5cdb84(0x24c),{'paymentAmount':_0x260467[_0x5cdb84(0x21e)],'paymentCurrency':_0x260467[_0x5cdb84(0x22f)],'shopId':_0x260467[_0x5cdb84(0x288)],'createdAt':_0x260467[_0x5cdb84(0x1bf)]}),await database_1['default'][_0x5cdb84(0x28e)]['create']({'data':{'paymentId':_0x260467['id'],'shopId':_0x260467[_0x5cdb84(0x288)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x3160b7 instanceof Error?_0x3160b7[_0x5cdb84(0x21b)]:_0x5cdb84(0x1c5),'gatewayPaymentId':_0x260467[_0x5cdb84(0x23b)],'checkedAt':new Date()[_0x5cdb84(0x1f9)]()})}});}}async[a37_0x4cb66c(0x20a)](_0x2fcf71,_0x288f3f){const _0x36bf8e=a37_0x4cb66c,_0x19042c=Date['now']();try{const _0x1e3d43=_0x2fcf71[_0x36bf8e(0x28c)],_0x37534f=_0x1e3d43[_0x36bf8e(0x20d)];if(!_0x37534f?.[_0x36bf8e(0x267)]){console[_0x36bf8e(0x256)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1e3d43['id']);return;}const _0x4a7d35=_0x288f3f===_0x36bf8e(0x220)?_0x36bf8e(0x1c2):_0x288f3f===_0x36bf8e(0x1cf)?_0x36bf8e(0x1e8):_0x288f3f===_0x36bf8e(0x1e2)?_0x36bf8e(0x1e8):'payment.pending';if(!_0x37534f['webhookEvents']?.[_0x36bf8e(0x273)](_0x4a7d35)){console['log'](_0x36bf8e(0x238)+_0x4a7d35+_0x36bf8e(0x1ad)+_0x1e3d43['id']);return;}const _0x536cbc={'event':_0x4a7d35,'payment':{'id':_0x2fcf71['id'],'order_id':_0x2fcf71[_0x36bf8e(0x22a)],'gateway_order_id':_0x2fcf71[_0x36bf8e(0x22e)],'gateway':_0x36bf8e(0x1db),'amount':_0x2fcf71[_0x36bf8e(0x21e)],'currency':_0x2fcf71['currency'],'status':_0x288f3f[_0x36bf8e(0x225)](),'customer_email':_0x2fcf71[_0x36bf8e(0x240)],'customer_name':_0x2fcf71[_0x36bf8e(0x28d)],'created_at':_0x2fcf71[_0x36bf8e(0x1bf)],'updated_at':new Date()}},_0x393e2d=await fetch(_0x37534f[_0x36bf8e(0x267)],{'method':_0x36bf8e(0x1e1),'headers':{'Content-Type':_0x36bf8e(0x1be),'User-Agent':_0x36bf8e(0x1d3)},'body':JSON['stringify'](_0x536cbc)}),_0x34e324=Date['now']()-_0x19042c,_0x142a6e=_0x393e2d['ok']?'Success':await _0x393e2d['text']();loggerService_1['loggerService'][_0x36bf8e(0x284)](_0x2fcf71[_0x36bf8e(0x288)],_0x37534f[_0x36bf8e(0x267)],_0x4a7d35,_0x393e2d[_0x36bf8e(0x23f)],_0x34e324,_0x536cbc),console['log'](_0x36bf8e(0x23d)+_0x37534f[_0x36bf8e(0x267)]+_0x36bf8e(0x1d5)+_0x393e2d['status']+'\x20('+_0x34e324+_0x36bf8e(0x279));}catch(_0x371898){console[_0x36bf8e(0x1f5)](_0x36bf8e(0x1cd),_0x371898),loggerService_1[_0x36bf8e(0x24e)][_0x36bf8e(0x1c0)](_0x2fcf71['shopId'],_0x2fcf71[_0x36bf8e(0x28c)]?.['settings']?.[_0x36bf8e(0x267)]||_0x36bf8e(0x230),_0x36bf8e(0x206),_0x371898,{});}}async[a37_0x4cb66c(0x27e)](_0x3ef6b9,_0x480c8){const _0x40ba15=a37_0x4cb66c;try{const _0x535c8e={'PENDING':_0x40ba15(0x245),'PAID':_0x40ba15(0x252),'FAILED':_0x40ba15(0x28a),'EXPIRED':'expired'},_0x5df10c=_0x535c8e[_0x480c8];if(!_0x5df10c||_0x5df10c===_0x40ba15(0x245))return;await telegramBotService_1[_0x40ba15(0x269)][_0x40ba15(0x1ed)](_0x3ef6b9[_0x40ba15(0x288)],_0x3ef6b9,_0x5df10c);}catch(_0x3f89eb){console[_0x40ba15(0x1f5)](_0x40ba15(0x209),_0x3f89eb);}}async[a37_0x4cb66c(0x264)](_0x5f04a0){const _0x1386a8=a37_0x4cb66c;console[_0x1386a8(0x256)]('🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x5f04a0);const _0x306a99=await database_1[_0x1386a8(0x21d)][_0x1386a8(0x20c)][_0x1386a8(0x26e)]({'where':{'id':_0x5f04a0},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x306a99)throw new Error(_0x1386a8(0x241));if(_0x306a99['gateway']!=='cointopay')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x1386a8(0x256)](_0x1386a8(0x1ae)+_0x5f04a0),await this['checkSinglePayment'](_0x306a99),console[_0x1386a8(0x256)](_0x1386a8(0x208)+_0x5f04a0);}[a37_0x4cb66c(0x21f)](){const _0x2edcda=a37_0x4cb66c,_0x4a29a6=this[_0x2edcda(0x224)]?this[_0x2edcda(0x1b3)]:undefined,_0xc547c4=Array[_0x2edcda(0x1cb)](this[_0x2edcda(0x217)]['values']())[_0x2edcda(0x235)](_0x71927a=>({'paymentId':_0x71927a[_0x2edcda(0x212)],'gatewayPaymentId':_0x71927a[_0x2edcda(0x23b)],'createdAt':_0x71927a['createdAt'],'timersCount':_0x71927a[_0x2edcda(0x223)][_0x2edcda(0x211)]}));return{'isActive':!!this[_0x2edcda(0x224)],'globalCheckIntervalMinutes':this[_0x2edcda(0x1b3)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this['paymentTimers'][_0x2edcda(0x1ba)],'nextGlobalCheckIn':_0x4a29a6,'paymentTimersDetails':_0xc547c4};}['getPaymentTimerInfo'](_0x4d244b){const _0xf51d68=a37_0x4cb66c,_0x5e7c2a=this[_0xf51d68(0x217)]['get'](_0x4d244b);if(_0x5e7c2a)return{'hasTimers':!![],'timersCount':_0x5e7c2a['timers'][_0xf51d68(0x211)],'createdAt':_0x5e7c2a['createdAt'],'gatewayPaymentId':_0x5e7c2a[_0xf51d68(0x23b)]};return{'hasTimers':![]};}}exports[a37_0x4cb66c(0x283)]=CoinToPayStatusService,exports[a37_0x4cb66c(0x255)]=new CoinToPayStatusService();