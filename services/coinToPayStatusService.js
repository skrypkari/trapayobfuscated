'use strict';const a38_0x5cb69c=a38_0x5d94;(function(_0x488a1f,_0x14d8e3){const _0x425a9f=a38_0x5d94,_0x36609e=_0x488a1f();while(!![]){try{const _0x1e7c8f=-parseInt(_0x425a9f(0x17c))/0x1*(-parseInt(_0x425a9f(0x204))/0x2)+parseInt(_0x425a9f(0x1b3))/0x3+-parseInt(_0x425a9f(0x15a))/0x4+parseInt(_0x425a9f(0x201))/0x5+parseInt(_0x425a9f(0x207))/0x6+parseInt(_0x425a9f(0x1fb))/0x7+parseInt(_0x425a9f(0x1b8))/0x8*(-parseInt(_0x425a9f(0x1e4))/0x9);if(_0x1e7c8f===_0x14d8e3)break;else _0x36609e['push'](_0x36609e['shift']());}catch(_0x378942){_0x36609e['push'](_0x36609e['shift']());}}}(a38_0x25c4,0xaf328));function a38_0x25c4(){const _0x31c224=['parse','cointopay_auto_expired','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','amount','getTime','SINGLE','\x20marked\x20as\x20paid\x20at:\x20','length','\x20updated\x20successfully','üìä\x20[HOURLY]\x20Payment\x20','\x20\x20\x20-\x20Status:\x20','createdOn','\x20\x20\x20üìä\x20Status:\x20','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','\x20status\x20changed\x20to\x20','remitterIban','push','toISOString','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','transactionId','checkPaymentStatus','1\x20minute','paidAt','\x20has\x20no\x20gatewayPaymentId','telegramBotService','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','size','Payment\x20older\x20than\x20','has','COINTOPAY_ERROR','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','commission','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','not\x20confirmed','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','getServiceStats','3546114pIZBXF','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20\x20\x20‚ùå\x20Error:\x20','currentPayments','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','23129848HULnpj','EXPIRED','\x20days\x20(created\x20before\x20','\x20not\x20enabled\x20for\x20shop\x20','status_check','\x20status:\x20','currency','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','‚è∞\x20[GLOBAL]\x20Found\x20','üí∞\x20[CHECK]\x20Payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','customerEmail','\x20expired\x20CoinToPay\x20payments','üìä\x20[CHECK]\x20Payment\x20','payment','\x20\x20\x20-\x20gatewayPaymentId:\x20','forEach','\x20is\x20valid\x20for\x20checking,\x20proceeding...','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20\x20\x20Amount:\x20','\x20commission\x20for\x20shop\x20','PENDING','checkSinglePayment','default','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','GLOBAL_CHECK_INTERVAL_MS','\x20expired','ü™ô\x20[TIMER]\x20Individual\x20check\x20#',',\x20gateway\x20','schedulePaymentChecks','paymentDetails','clearPaymentTimers','checkPaymentById','gateway','stack','./currencyService','\x20with\x20status\x20','application/json','\x20\x20\x20Gateway\x20','stopPeriodicStatusCheck','delete','\x20checked,\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','ü™ô\x20[DEBUG]\x20Creating\x20','9QXTOKp','\x20status\x20from\x20','PAID','\x20\x20\x20üìÖ\x20Time:\x20','coinToPay2Service','sendPaymentNotification','Bank\x20Details:\x20','webhook_send','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','üîç\x20[CHECK]\x20Checking\x20','timers','üìà\x20[COINTOPAY]\x20Payment\x20','5\x20minutes','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','Unknown\x20error','from','set','map','Shop\x20webhook\x20sent\x20to\x20','now','paymentId','\x20amounts\x20calculated:','coinToPayService','1326374DHidRS','catch','unknown','\x20\x20\x20Amount\x20after\x20commission:\x20','webhookUrl','\x20in\x20shop\x20','7161875QhSYXH','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','ms)','1478qwXIBM','stringify','\x20not\x20found,\x20clearing\x20timers','7047432BYtmWq',':\x20type=','Webhook\x20event\x20','webhookEvents','checkSinglePaymentById','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','‚úÖ\x20[CHECK]\x20Payment\x20','get','timestamp','amountAfterGatewayCommissionUSDT','\x20is\x20older\x20than\x20','cointopay2','sendPaymentStatusNotification','\x20\x20\x20-\x20ShopId:\x20','gatewaySettings','findUnique','\x20for\x20payment\x20','iban','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','‚ùå\x20[HOURLY]\x20Payment\x20','‚ùå\x20[CHECK]\x20Payment\x20','shop','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20\x20\x20üìù\x20Context:','h),\x20skipping\x20global\x20check','floor','-day\x20timeout','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','create','globalCheckInterval','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20USDT','logCoinToPayStatus','logWhiteDomainError','Success','\x20found:','text','\x20\x20\x20-\x20Gateway:\x20','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','CoinToPayService','\x20completed\x20for\x20payment\x20','currencyService','shopId','update','TesSoft\x20Payment\x20System/1.0','createdAt','toLowerCase','‚è∞\x20[HOURLY]\x20Payment\x20','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','adminNotes','coinToPayStatusService','./gateways/coinToPay2Service','CoinToPayStatusService','\x20(after\x20','values','getGatewayCommission','log','delay','‚è∞\x20[GLOBAL]\x20Payment\x20','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','payment.pending','created','getPaymentTimerInfo','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','payment.success','\x20to\x20','type','getDate','status','2\x20minutes','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','__importDefault','\x20(age:\x20','message','\x20\x20\x20üìù\x20Details:','checkExpiredPayments','confirmedOn','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','paymentLink','\x20initial\x20timers\x20for\x20payment\x20','orderId','\x20days','\x20status\x20is\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','FAILED','\x20seconds\x20(','\x20to\x20clear','gatewayPaymentId','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','convertToUSDT','4691684NMmasl','paymentLinkId','logCoinToPayError','toFixed','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20',',\x20status=','cointopay','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','checkAllPendingPayments','cointopay_status_check_error','\x20skipped,\x20','webhookLog','auto_expire','bankDetails','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','loggerService','paymentTimers','\x20\x20\x20üìç\x20Source:\x20','EXPIRY_DAYS','COMPLETED','error','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','description','\x20payment\x20','/status/',',\x20stopping\x20individual\x20checks','includes','entries','\x20->\x20','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','not\x20found','\x20individual\x20payment\x20timers','1087LKjutd','customerName','startPeriodicStatusCheck','logShopWebhookSent','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','schedule_created','‚úÖ\x20[HOURLY]\x20Payment\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','.\x20Remaining\x20active\x20timers:\x20','üõë\x20[SHUTDOWN]\x20Cleared\x20','./gateways/coinToPayService','settings','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20\x20\x20-\x20paymentId:\x20','__esModule','failed','amountUSDT'];a38_0x25c4=function(){return _0x31c224;};return a38_0x25c4();}var __importDefault=this&&this[a38_0x5cb69c(0x147)]||function(_0x1282fc){return _0x1282fc&&_0x1282fc['__esModule']?_0x1282fc:{'default':_0x1282fc};};function a38_0x5d94(_0x2ba151,_0x458e36){const _0x25c4f9=a38_0x25c4();return a38_0x5d94=function(_0x5d94a4,_0x5892e1){_0x5d94a4=_0x5d94a4-0x129;let _0x1843cb=_0x25c4f9[_0x5d94a4];return _0x1843cb;},a38_0x5d94(_0x2ba151,_0x458e36);}Object['defineProperty'](exports,a38_0x5cb69c(0x18a),{'value':!![]}),exports[a38_0x5cb69c(0x130)]=exports[a38_0x5cb69c(0x132)]=void 0x0;const coinToPayService_1=require(a38_0x5cb69c(0x186)),coinToPay2Service_1=require(a38_0x5cb69c(0x131)),gateway_1=require('../types/gateway'),database_1=__importDefault(require('../config/database')),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService'),currencyService_1=require(a38_0x5cb69c(0x1db));class CoinToPayStatusService{constructor(){const _0x356b63=a38_0x5cb69c;this['globalCheckInterval']=null,this[_0x356b63(0x1d1)]=0x3c*0x3c*0x3e8,this[_0x356b63(0x16d)]=0x5,this['paymentTimers']=new Map(),this[_0x356b63(0x1fa)]=new coinToPayService_1[(_0x356b63(0x231))](),this[_0x356b63(0x1e8)]=new coinToPay2Service_1['CoinToPay2Service'](),console[_0x356b63(0x136)]('ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}[a38_0x5cb69c(0x1d5)](_0x2bc60e,_0x25fd26){const _0x5a16d3=a38_0x5cb69c;console[_0x5a16d3(0x136)](_0x5a16d3(0x139)),console['log'](_0x5a16d3(0x189)+_0x2bc60e),console[_0x5a16d3(0x136)](_0x5a16d3(0x1c7)+_0x25fd26),this['clearPaymentTimers'](_0x2bc60e);const _0x197a12=[],_0x1d6cd4=new Date(),_0x46a55e=[{'delay':0x1*0x3c*0x3e8,'description':_0x5a16d3(0x1a3)},{'delay':0x2*0x3c*0x3e8,'description':_0x5a16d3(0x144)},{'delay':0x5*0x3c*0x3e8,'description':_0x5a16d3(0x1f0)},{'delay':0x5*0x3c*0x3e8,'description':_0x5a16d3(0x1f0)}];console[_0x5a16d3(0x136)](_0x5a16d3(0x1e3)+_0x46a55e[_0x5a16d3(0x195)]+_0x5a16d3(0x14f)+_0x2bc60e);let _0x35709f=0x0;_0x46a55e[_0x5a16d3(0x1c8)]((_0x143ba7,_0x2f9d34)=>{const _0x545492=_0x5a16d3;_0x35709f+=_0x143ba7[_0x545492(0x137)];const _0x1f594e=setTimeout(async()=>{const _0x162093=_0x545492;console[_0x162093(0x136)](_0x162093(0x1d3)+(_0x2f9d34+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x2bc60e+_0x162093(0x133)+_0x143ba7[_0x162093(0x171)]+')');try{await this[_0x162093(0x20b)](_0x2bc60e),console['log']('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x2f9d34+0x1)+_0x162093(0x232)+_0x2bc60e);}catch(_0x36e999){console[_0x162093(0x16f)](_0x162093(0x18f)+(_0x2f9d34+0x1)+_0x162093(0x218)+_0x2bc60e+':',_0x36e999),this[_0x162093(0x15c)](_0x2bc60e,_0x25fd26,_0x36e999,'status_check',{'checkNumber':_0x2f9d34+0x1,'scheduledAfter':_0x143ba7[_0x162093(0x171)],'isIndividualCheck':!![]});}},_0x35709f);_0x197a12[_0x545492(0x19e)](_0x1f594e),console['log'](_0x545492(0x1f1)+(_0x2f9d34+0x1)+_0x545492(0x218)+_0x2bc60e+'\x20in\x20'+_0x35709f/0x3e8+_0x545492(0x155)+_0x143ba7['description']+')');});const _0x316911=setInterval(async()=>{const _0x3a67a6=_0x5a16d3;console[_0x3a67a6(0x136)](_0x3a67a6(0x202)+_0x2bc60e);try{const _0x452cd6=await database_1['default'][_0x3a67a6(0x1c6)][_0x3a67a6(0x217)]({'where':{'id':_0x2bc60e},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x452cd6){console[_0x3a67a6(0x136)](_0x3a67a6(0x21b)+_0x2bc60e+_0x3a67a6(0x206)),this[_0x3a67a6(0x1d7)](_0x2bc60e);return;}console[_0x3a67a6(0x136)](_0x3a67a6(0x197)+_0x2bc60e+'\x20current\x20status:\x20'+_0x452cd6[_0x3a67a6(0x143)]);if(_0x452cd6[_0x3a67a6(0x143)]!==_0x3a67a6(0x1cd)){console[_0x3a67a6(0x136)](_0x3a67a6(0x182)+_0x2bc60e+_0x3a67a6(0x152)+_0x452cd6[_0x3a67a6(0x143)]+_0x3a67a6(0x174)),this[_0x3a67a6(0x1d7)](_0x2bc60e);return;}const _0x47f560=Math['floor']((Date[_0x3a67a6(0x1f7)]()-_0x452cd6[_0x3a67a6(0x129)][_0x3a67a6(0x192)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x47f560>=this[_0x3a67a6(0x16d)]){console[_0x3a67a6(0x136)](_0x3a67a6(0x12b)+_0x2bc60e+_0x3a67a6(0x212)+this[_0x3a67a6(0x16d)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x3a67a6(0x1d7)](_0x2bc60e);return;}await this['checkSinglePaymentById'](_0x2bc60e),console['log'](_0x3a67a6(0x14d)+_0x2bc60e);}catch(_0x3d3d02){console['error']('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x2bc60e+':',_0x3d3d02),this['logCoinToPayError'](_0x2bc60e,_0x25fd26,_0x3d3d02,_0x3a67a6(0x1bc),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x197a12[_0x5a16d3(0x19e)](_0x316911),this[_0x5a16d3(0x16b)][_0x5a16d3(0x1f4)](_0x2bc60e,{'timers':_0x197a12,'paymentId':_0x2bc60e,'gatewayPaymentId':_0x25fd26,'createdAt':_0x1d6cd4}),console['log'](_0x5a16d3(0x1b4)+_0x46a55e[_0x5a16d3(0x195)]+_0x5a16d3(0x22f)+_0x2bc60e),console['log'](_0x5a16d3(0x22e)+this[_0x5a16d3(0x16b)]['size']),this['logCoinToPayStatus'](_0x2bc60e,_0x25fd26,'PENDING',_0x5a16d3(0x1cd),_0x5a16d3(0x1bc),{'action':_0x5a16d3(0x181),'scheduledChecks':_0x46a55e[_0x5a16d3(0x195)],'firstCheckIn':_0x46a55e[0x0][_0x5a16d3(0x137)]/0x3e8,'totalTimers':this[_0x5a16d3(0x16b)][_0x5a16d3(0x1a8)]});}[a38_0x5cb69c(0x1d7)](_0x2675c0){const _0x311379=a38_0x5cb69c,_0x53258e=this['paymentTimers']['get'](_0x2675c0);_0x53258e?(console[_0x311379(0x136)]('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x53258e['timers'][_0x311379(0x195)]+'\x20timers\x20for\x20payment\x20'+_0x2675c0),_0x53258e['timers'][_0x311379(0x1c8)]((_0x8a51d,_0x59144d)=>{const _0xc42843=_0x311379;_0x8a51d&&(clearTimeout(_0x8a51d),clearInterval(_0x8a51d),console['log'](_0xc42843(0x180)+(_0x59144d+0x1)+'\x20for\x20payment\x20'+_0x2675c0));}),this[_0x311379(0x16b)][_0x311379(0x1e0)](_0x2675c0),console[_0x311379(0x136)](_0x311379(0x178)+_0x2675c0+_0x311379(0x184)+this[_0x311379(0x16b)][_0x311379(0x1a8)])):console[_0x311379(0x136)](_0x311379(0x13e)+_0x2675c0+_0x311379(0x156));}async[a38_0x5cb69c(0x20b)](_0x454944){const _0x4950c8=a38_0x5cb69c;console[_0x4950c8(0x136)]('üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x454944);const _0x11602a=await database_1[_0x4950c8(0x1cf)][_0x4950c8(0x1c6)][_0x4950c8(0x217)]({'where':{'id':_0x454944},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x11602a){console['log'](_0x4950c8(0x21c)+_0x454944+'\x20not\x20found\x20in\x20database');return;}console[_0x4950c8(0x136)](_0x4950c8(0x1c5)+_0x454944+_0x4950c8(0x22b)),console['log'](_0x4950c8(0x22d)+_0x11602a[_0x4950c8(0x1d9)]),console['log'](_0x4950c8(0x198)+_0x11602a[_0x4950c8(0x143)]),console[_0x4950c8(0x136)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x11602a[_0x4950c8(0x157)]),console[_0x4950c8(0x136)]('\x20\x20\x20-\x20Amount:\x20'+_0x11602a[_0x4950c8(0x191)]+'\x20'+_0x11602a['currency']),console[_0x4950c8(0x136)](_0x4950c8(0x215)+_0x11602a['shopId']);if(_0x11602a['gateway']!==_0x4950c8(0x160)&&_0x11602a[_0x4950c8(0x1d9)]!=='cointopay2'){console[_0x4950c8(0x136)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x454944+_0x4950c8(0x1b7)+_0x11602a[_0x4950c8(0x1d9)]+')');return;}if(_0x11602a['status']!==_0x4950c8(0x1cd)){console[_0x4950c8(0x136)](_0x4950c8(0x13d)+_0x454944+_0x4950c8(0x152)+_0x11602a[_0x4950c8(0x143)]+',\x20stopping\x20individual\x20checks'),this['clearPaymentTimers'](_0x454944);return;}if(!_0x11602a[_0x4950c8(0x157)]){console[_0x4950c8(0x136)](_0x4950c8(0x13d)+_0x454944+_0x4950c8(0x1a5));return;}console[_0x4950c8(0x136)](_0x4950c8(0x20e)+_0x454944+_0x4950c8(0x1c9)),await this[_0x4950c8(0x1ce)](_0x11602a);}['logCoinToPayStatus'](_0x55900b,_0x29748c,_0x470e4f,_0x2ce5d3,_0x120c92,_0x27cfa1){const _0x2bbda8=a38_0x5cb69c,_0x4d372e={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x55900b,'gatewayPaymentId':_0x29748c,'oldStatus':_0x470e4f,'newStatus':_0x2ce5d3,'source':_0x120c92,'timestamp':new Date()[_0x2bbda8(0x19f)](),'details':_0x27cfa1||{}};loggerService_1[_0x2bbda8(0x16a)][_0x2bbda8(0x228)](_0x4d372e),console['log'](_0x2bbda8(0x223)+_0x55900b+'\x20('+_0x29748c+')'),console[_0x2bbda8(0x136)](_0x2bbda8(0x19a)+_0x470e4f+_0x2bbda8(0x177)+_0x2ce5d3),console['log'](_0x2bbda8(0x16c)+_0x120c92),console['log'](_0x2bbda8(0x1e7)+_0x4d372e['timestamp']),_0x27cfa1&&console['log'](_0x2bbda8(0x14a),_0x27cfa1);}[a38_0x5cb69c(0x15c)](_0x49ea8f,_0x307278,_0x531b1a,_0x1bed8f,_0x38a5a8){const _0x58717c=a38_0x5cb69c,_0x5f03c0={'type':_0x58717c(0x1ab),'paymentId':_0x49ea8f,'gatewayPaymentId':_0x307278,'error':_0x531b1a instanceof Error?{'message':_0x531b1a[_0x58717c(0x149)],'stack':_0x531b1a[_0x58717c(0x1da)]}:_0x531b1a,'source':_0x1bed8f,'timestamp':new Date()[_0x58717c(0x19f)](),'context':_0x38a5a8||{}};loggerService_1['loggerService']['logCoinToPayError'](_0x5f03c0),console[_0x58717c(0x16f)](_0x58717c(0x146)+_0x49ea8f+'\x20('+_0x307278+')'),console['error'](_0x58717c(0x1b5)+(_0x531b1a instanceof Error?_0x531b1a[_0x58717c(0x149)]:_0x531b1a)),console[_0x58717c(0x16f)]('\x20\x20\x20üìç\x20Source:\x20'+_0x1bed8f),console['error'](_0x58717c(0x1e7)+_0x5f03c0[_0x58717c(0x210)]),_0x38a5a8&&console[_0x58717c(0x16f)](_0x58717c(0x21f),_0x38a5a8);}[a38_0x5cb69c(0x17e)](){const _0x8c3c0=a38_0x5cb69c;console[_0x8c3c0(0x136)](_0x8c3c0(0x226)),this[_0x8c3c0(0x163)]()[_0x8c3c0(0x1fc)](_0x4ebf41=>{const _0xb00133=_0x8c3c0;console[_0xb00133(0x16f)](_0xb00133(0x190),_0x4ebf41);}),this['globalCheckInterval']=setInterval(async()=>{const _0x3d5ad3=_0x8c3c0;try{console[_0x3d5ad3(0x136)](_0x3d5ad3(0x1a7)),await this[_0x3d5ad3(0x163)](),console[_0x3d5ad3(0x136)](_0x3d5ad3(0x20d));}catch(_0x111425){console[_0x3d5ad3(0x16f)](_0x3d5ad3(0x145),_0x111425);}},this[_0x8c3c0(0x1d1)]),console['log'](_0x8c3c0(0x230));}[a38_0x5cb69c(0x1df)](){const _0x261c4d=a38_0x5cb69c;console[_0x261c4d(0x136)](_0x261c4d(0x1a0));this[_0x261c4d(0x225)]&&(clearInterval(this[_0x261c4d(0x225)]),this[_0x261c4d(0x225)]=null,console[_0x261c4d(0x136)](_0x261c4d(0x1b0)));const _0x3c3614=this['paymentTimers']['size'];for(const [_0x40e8d8]of this['paymentTimers']){this[_0x261c4d(0x1d7)](_0x40e8d8);}console[_0x261c4d(0x136)](_0x261c4d(0x185)+_0x3c3614+_0x261c4d(0x17b));}async['checkAllPendingPayments'](){const _0x1f756c=a38_0x5cb69c;try{console['log'](_0x1f756c(0x161));const _0x582a34=await database_1[_0x1f756c(0x1cf)]['payment']['findMany']({'where':{'gateway':{'in':[_0x1f756c(0x160),'cointopay2']},'status':_0x1f756c(0x1cd),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x1f756c(0x136)]('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x582a34[_0x1f756c(0x195)]+'\x20pending\x20CoinToPay\x20payments');if(_0x582a34['length']===0x0){console[_0x1f756c(0x136)](_0x1f756c(0x21e));return;}const _0x2d31bf=await this['checkExpiredPayments'](_0x582a34);console[_0x1f756c(0x136)](_0x1f756c(0x1c0)+_0x2d31bf[_0x1f756c(0x195)]+_0x1f756c(0x1c4));let _0x2b4d70=0x0,_0x52bdb4=0x0;for(const _0x22bbd4 of _0x582a34){try{if(_0x2d31bf['includes'](_0x22bbd4['id'])){console[_0x1f756c(0x136)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x22bbd4['id']+_0x1f756c(0x162)),_0x52bdb4++;continue;}if(this[_0x1f756c(0x16b)][_0x1f756c(0x1aa)](_0x22bbd4['id'])){console[_0x1f756c(0x136)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x22bbd4['id']+_0x1f756c(0x188)),_0x52bdb4++;continue;}const _0x1f8ac9=(Date[_0x1f756c(0x1f7)]()-_0x22bbd4['createdAt'][_0x1f756c(0x192)]())/(0x3e8*0x3c*0x3c);if(_0x1f8ac9<0x1){console[_0x1f756c(0x136)](_0x1f756c(0x138)+_0x22bbd4['id']+'\x20is\x20too\x20new\x20('+_0x1f8ac9['toFixed'](0x1)+_0x1f756c(0x220)),_0x52bdb4++;continue;}console[_0x1f756c(0x136)](_0x1f756c(0x1ec)+_0x22bbd4['id']+_0x1f756c(0x148)+_0x1f8ac9[_0x1f756c(0x15d)](0x1)+'h)'),await this['checkSinglePayment'](_0x22bbd4),_0x2b4d70++,await new Promise(_0x106f17=>setTimeout(_0x106f17,0x7d0));}catch(_0x4be648){console['error']('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x22bbd4['id']+':',_0x4be648),this['logCoinToPayError'](_0x22bbd4['id'],_0x22bbd4['gatewayPaymentId']||_0x1f756c(0x1fd),_0x4be648,_0x1f756c(0x1bc),{'isGlobalCheck':!![],'paymentAmount':_0x22bbd4[_0x1f756c(0x191)],'paymentCurrency':_0x22bbd4[_0x1f756c(0x1be)],'shopId':_0x22bbd4[_0x1f756c(0x234)],'createdAt':_0x22bbd4[_0x1f756c(0x129)]}),loggerService_1['loggerService'][_0x1f756c(0x229)](_0x1f756c(0x160),_0x1f756c(0x173)+_0x22bbd4[_0x1f756c(0x157)],_0x4be648);}}console[_0x1f756c(0x136)](_0x1f756c(0x170)+_0x2b4d70+_0x1f756c(0x1e1)+_0x52bdb4+_0x1f756c(0x165)+_0x2d31bf[_0x1f756c(0x195)]+_0x1f756c(0x1d2));}catch(_0x3f7d83){console[_0x1f756c(0x16f)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x3f7d83);}}async[a38_0x5cb69c(0x14b)](_0x480196){const _0xd5c7b1=a38_0x5cb69c,_0x199c43=[],_0x142acc=new Date();_0x142acc['setDate'](_0x142acc[_0xd5c7b1(0x142)]()-this[_0xd5c7b1(0x16d)]),console[_0xd5c7b1(0x136)]('‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0xd5c7b1(0x16d)]+_0xd5c7b1(0x1ba)+_0x142acc['toISOString']()+')');for(const _0x244ca2 of _0x480196){if(_0x244ca2[_0xd5c7b1(0x129)]<_0x142acc){console['log']('‚è∞\x20[EXPIRY]\x20Payment\x20'+_0x244ca2['id']+_0xd5c7b1(0x212)+this['EXPIRY_DAYS']+_0xd5c7b1(0x1c2));try{this['logCoinToPayStatus'](_0x244ca2['id'],_0x244ca2['gatewayPaymentId']||_0xd5c7b1(0x1fd),_0xd5c7b1(0x1cd),_0xd5c7b1(0x1b9),_0xd5c7b1(0x167),{'reason':_0xd5c7b1(0x1a9)+this[_0xd5c7b1(0x16d)]+_0xd5c7b1(0x151),'createdAt':_0x244ca2[_0xd5c7b1(0x129)],'daysSinceCreation':Math[_0xd5c7b1(0x221)]((Date['now']()-_0x244ca2['createdAt'][_0xd5c7b1(0x192)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x244ca2['amount'],'paymentCurrency':_0x244ca2[_0xd5c7b1(0x1be)],'shopId':_0x244ca2[_0xd5c7b1(0x234)]}),await database_1[_0xd5c7b1(0x1cf)]['payment'][_0xd5c7b1(0x235)]({'where':{'id':_0x244ca2['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0xd5c7b1(0x16d)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0xd5c7b1(0x1cf)][_0xd5c7b1(0x166)][_0xd5c7b1(0x224)]({'data':{'paymentId':_0x244ca2['id'],'shopId':_0x244ca2[_0xd5c7b1(0x234)],'event':_0xd5c7b1(0x18e),'statusCode':0xc8,'responseBody':JSON[_0xd5c7b1(0x205)]({'reason':'Payment\x20older\x20than\x20'+this[_0xd5c7b1(0x16d)]+_0xd5c7b1(0x151),'createdAt':_0x244ca2[_0xd5c7b1(0x129)],'expiredAt':new Date()[_0xd5c7b1(0x19f)](),'daysSinceCreation':Math[_0xd5c7b1(0x221)]((Date[_0xd5c7b1(0x1f7)]()-_0x244ca2[_0xd5c7b1(0x129)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x244ca2,'EXPIRED'),await this[_0xd5c7b1(0x214)](_0x244ca2,_0xd5c7b1(0x1b9)),this['clearPaymentTimers'](_0x244ca2['id']),_0x199c43[_0xd5c7b1(0x19e)](_0x244ca2['id']),console[_0xd5c7b1(0x136)]('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x244ca2['id']+_0xd5c7b1(0x1e2)+this[_0xd5c7b1(0x16d)]+_0xd5c7b1(0x222));}catch(_0xc03952){console[_0xd5c7b1(0x16f)](_0xd5c7b1(0x183)+_0x244ca2['id']+':',_0xc03952),this[_0xd5c7b1(0x15c)](_0x244ca2['id'],_0x244ca2[_0xd5c7b1(0x157)]||_0xd5c7b1(0x1fd),_0xc03952,_0xd5c7b1(0x167),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x244ca2[_0xd5c7b1(0x129)],'daysSinceCreation':Math['floor']((Date[_0xd5c7b1(0x1f7)]()-_0x244ca2[_0xd5c7b1(0x129)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x199c43;}async['checkSinglePayment'](_0x4a8266){const _0x52fed7=a38_0x5cb69c;if(!_0x4a8266[_0x52fed7(0x157)]){console['log'](_0x52fed7(0x13d)+_0x4a8266['id']+_0x52fed7(0x153));return;}console[_0x52fed7(0x136)](_0x52fed7(0x1ed)+_0x4a8266['gateway']+_0x52fed7(0x172)+_0x4a8266['id']+'\x20('+_0x4a8266[_0x52fed7(0x157)]+')');try{let _0x518dd2;_0x4a8266[_0x52fed7(0x1d9)]===_0x52fed7(0x213)?(_0x518dd2=await this[_0x52fed7(0x1e8)]['checkPaymentStatus'](_0x4a8266[_0x52fed7(0x157)]),console['log']('üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x4a8266['id']+_0x52fed7(0x1bd)+_0x518dd2[_0x52fed7(0x143)])):(_0x518dd2=await this[_0x52fed7(0x1fa)][_0x52fed7(0x1a2)](_0x4a8266[_0x52fed7(0x157)]),console[_0x52fed7(0x136)]('üìä\x20[CHECK]\x20CoinToPay\x20payment\x20'+_0x4a8266['id']+_0x52fed7(0x1bd)+_0x518dd2[_0x52fed7(0x143)]));_0x518dd2[_0x52fed7(0x1d6)]&&console[_0x52fed7(0x136)](_0x52fed7(0x1c5)+_0x4a8266['id']+'\x20details:',{'iban':_0x518dd2['paymentDetails']['iban']||_0x52fed7(0x17a),'transactionId':_0x518dd2['paymentDetails'][_0x52fed7(0x1a1)],'createdOn':_0x518dd2[_0x52fed7(0x1d6)][_0x52fed7(0x199)],'confirmedOn':_0x518dd2['paymentDetails'][_0x52fed7(0x14c)]||_0x52fed7(0x1af)});if(_0x518dd2[_0x52fed7(0x143)]!==_0x4a8266[_0x52fed7(0x143)]){console[_0x52fed7(0x136)]('üîÑ\x20[CHECK]\x20Updating\x20payment\x20'+_0x4a8266['id']+_0x52fed7(0x1e5)+_0x4a8266['status']+_0x52fed7(0x140)+_0x518dd2[_0x52fed7(0x143)]),this[_0x52fed7(0x228)](_0x4a8266['id'],_0x4a8266[_0x52fed7(0x157)],_0x4a8266['status'],_0x518dd2[_0x52fed7(0x143)],_0x52fed7(0x1bc),{'paymentDetails':_0x518dd2[_0x52fed7(0x1d6)],'amount':_0x518dd2['amount'],'currency':_0x518dd2[_0x52fed7(0x1be)],'shopId':_0x4a8266['shopId'],'checkTimestamp':new Date()[_0x52fed7(0x19f)]()});const _0x266e7b={'status':_0x518dd2['status'],'updatedAt':new Date()};if(_0x518dd2['status']===_0x52fed7(0x1e6)&&_0x4a8266[_0x52fed7(0x143)]!==_0x52fed7(0x1e6)){_0x266e7b[_0x52fed7(0x1a4)]=new Date();if(!_0x4a8266[_0x52fed7(0x18c)]){const _0x1a6066=await currencyService_1[_0x52fed7(0x233)][_0x52fed7(0x159)](_0x4a8266[_0x52fed7(0x191)],_0x4a8266[_0x52fed7(0x1be)]);_0x266e7b[_0x52fed7(0x18c)]=_0x1a6066;const _0x4cd985=await this[_0x52fed7(0x135)](_0x4a8266['shopId'],_0x4a8266[_0x52fed7(0x1d9)]),_0x57051a=_0x1a6066*(0x1-_0x4cd985/0x64);_0x266e7b[_0x52fed7(0x211)]=_0x57051a,console['log'](_0x52fed7(0x1c1)+_0x4a8266['id']+_0x52fed7(0x1f9)),console[_0x52fed7(0x136)](_0x52fed7(0x1cb)+_0x4a8266[_0x52fed7(0x191)]+'\x20'+_0x4a8266[_0x52fed7(0x1be)]+_0x52fed7(0x177)+_0x1a6066[_0x52fed7(0x15d)](0x6)+_0x52fed7(0x227)),console['log'](_0x52fed7(0x1de)+_0x4a8266[_0x52fed7(0x1d9)]+'\x20commission:\x20'+_0x4cd985+'%'),console[_0x52fed7(0x136)](_0x52fed7(0x1fe)+_0x57051a['toFixed'](0x6)+_0x52fed7(0x227));}console['log'](_0x52fed7(0x1c1)+_0x4a8266['id']+_0x52fed7(0x194)+_0x266e7b[_0x52fed7(0x1a4)][_0x52fed7(0x19f)]());}if(_0x518dd2[_0x52fed7(0x1d6)]){const _0x40ce1f=_0x518dd2['paymentDetails'];_0x40ce1f[_0x52fed7(0x219)]&&(_0x266e7b[_0x52fed7(0x19d)]=_0x40ce1f[_0x52fed7(0x219)],console['log'](_0x52fed7(0x15e)+_0x40ce1f[_0x52fed7(0x219)]));if(_0x40ce1f['bankDetails']){const _0x161d24=_0x4a8266[_0x52fed7(0x12f)]||'',_0x3e2f38=_0x52fed7(0x1ea)+_0x40ce1f[_0x52fed7(0x168)];_0x266e7b[_0x52fed7(0x12f)]=_0x161d24?_0x161d24+'\x0a\x0a'+_0x3e2f38:_0x3e2f38,console[_0x52fed7(0x136)](_0x52fed7(0x158));}_0x40ce1f[_0x52fed7(0x1a1)]&&console[_0x52fed7(0x136)](_0x52fed7(0x1bf)+_0x40ce1f[_0x52fed7(0x1a1)]),_0x40ce1f['confirmedOn']&&console['log'](_0x52fed7(0x1ca)+_0x40ce1f[_0x52fed7(0x14c)]);}await database_1[_0x52fed7(0x1cf)]['payment']['update']({'where':{'id':_0x4a8266['id']},'data':_0x266e7b});if(_0x518dd2[_0x52fed7(0x143)]===_0x52fed7(0x1e6)&&_0x4a8266['status']!=='PAID'){console['log'](_0x52fed7(0x1ef)+_0x4a8266['id']+_0x52fed7(0x19b));const _0x5ec2d4=await database_1[_0x52fed7(0x1cf)][_0x52fed7(0x1c6)]['findUnique']({'where':{'id':_0x4a8266['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x5ec2d4?.[_0x52fed7(0x15b)]&&_0x5ec2d4[_0x52fed7(0x14e)])try{const _0x5e517f=_0x5ec2d4[_0x52fed7(0x14e)];console[_0x52fed7(0x136)](_0x52fed7(0x12e)+_0x5e517f['id']+_0x52fed7(0x208)+_0x5e517f['type']+',\x20currentPayments='+_0x5e517f['currentPayments']+',\x20status='+_0x5e517f[_0x52fed7(0x143)]);const _0x5e64a2=_0x5e517f[_0x52fed7(0x1b6)]+0x1,_0x50f1d0=_0x5e517f[_0x52fed7(0x141)]===_0x52fed7(0x193)?_0x52fed7(0x16e):_0x5e517f['status'];await database_1[_0x52fed7(0x1cf)]['paymentLink'][_0x52fed7(0x235)]({'where':{'id':_0x5e517f['id']},'data':{'currentPayments':_0x5e64a2,'status':_0x50f1d0,'updatedAt':new Date()}}),console[_0x52fed7(0x136)]('‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20'+_0x5e517f['id']+'\x20updated:\x20currentPayments='+_0x5e517f['currentPayments']+'\x20->\x20'+_0x5e64a2+_0x52fed7(0x15f)+_0x5e517f[_0x52fed7(0x143)]+_0x52fed7(0x177)+_0x50f1d0);}catch(_0x23c453){console[_0x52fed7(0x16f)](_0x52fed7(0x12d),_0x23c453);}else console[_0x52fed7(0x136)](_0x52fed7(0x1ef)+_0x4a8266['id']+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}await database_1['default'][_0x52fed7(0x166)][_0x52fed7(0x224)]({'data':{'paymentId':_0x4a8266['id'],'shopId':_0x4a8266['shopId'],'event':'cointopay_status_check_'+_0x518dd2['status'][_0x52fed7(0x12a)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x4a8266[_0x52fed7(0x143)],'newStatus':_0x518dd2['status'],'paymentDetails':_0x518dd2[_0x52fed7(0x1d6)],'checkedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x4a8266,_0x518dd2[_0x52fed7(0x143)]),await this['sendPaymentStatusNotification'](_0x4a8266,_0x518dd2[_0x52fed7(0x143)]),_0x518dd2['status']!==_0x52fed7(0x1cd)&&(console[_0x52fed7(0x136)]('üßπ\x20[CHECK]\x20Payment\x20'+_0x4a8266['id']+_0x52fed7(0x19c)+_0x518dd2['status']+',\x20clearing\x20individual\x20timers'),this[_0x52fed7(0x1d7)](_0x4a8266['id'])),console['log'](_0x52fed7(0x20e)+_0x4a8266['id']+_0x52fed7(0x196));}else console[_0x52fed7(0x136)](_0x52fed7(0x1c5)+_0x4a8266['id']+'\x20status\x20unchanged\x20('+_0x518dd2[_0x52fed7(0x143)]+')'),this[_0x52fed7(0x228)](_0x4a8266['id'],_0x4a8266['gatewayPaymentId'],_0x4a8266['status'],_0x518dd2[_0x52fed7(0x143)],_0x52fed7(0x1bc),{'statusUnchanged':!![],'paymentDetails':_0x518dd2['paymentDetails'],'amount':_0x518dd2[_0x52fed7(0x191)],'currency':_0x518dd2[_0x52fed7(0x1be)],'shopId':_0x4a8266[_0x52fed7(0x234)],'checkTimestamp':new Date()[_0x52fed7(0x19f)]()});}catch(_0x37a648){console[_0x52fed7(0x16f)](_0x52fed7(0x1ae)+_0x4a8266['id']+':',_0x37a648),this['logCoinToPayError'](_0x4a8266['id'],_0x4a8266[_0x52fed7(0x157)],_0x37a648,_0x52fed7(0x1bc),{'paymentAmount':_0x4a8266['amount'],'paymentCurrency':_0x4a8266['currency'],'shopId':_0x4a8266[_0x52fed7(0x234)],'createdAt':_0x4a8266[_0x52fed7(0x129)]}),await database_1[_0x52fed7(0x1cf)][_0x52fed7(0x166)]['create']({'data':{'paymentId':_0x4a8266['id'],'shopId':_0x4a8266[_0x52fed7(0x234)],'event':_0x52fed7(0x164),'statusCode':0x1f4,'responseBody':JSON[_0x52fed7(0x205)]({'error':_0x37a648 instanceof Error?_0x37a648[_0x52fed7(0x149)]:_0x52fed7(0x1f2),'gatewayPaymentId':_0x4a8266[_0x52fed7(0x157)],'checkedAt':new Date()[_0x52fed7(0x19f)]()})}});}}async['sendShopWebhook'](_0x3343ac,_0x2b2814){const _0x199a76=a38_0x5cb69c,_0x67c3e1=Date['now']();try{const _0x7acd3c=_0x3343ac['shop'],_0x315676=_0x7acd3c[_0x199a76(0x187)];if(!_0x315676?.['webhookUrl']){console[_0x199a76(0x136)](_0x199a76(0x179)+_0x7acd3c['id']);return;}const _0x2d741e=_0x2b2814===_0x199a76(0x1e6)?_0x199a76(0x13f):_0x2b2814===_0x199a76(0x154)?'payment.failed':_0x2b2814===_0x199a76(0x1b9)?'payment.failed':_0x199a76(0x13a);if(!_0x315676[_0x199a76(0x20a)]?.[_0x199a76(0x175)](_0x2d741e)){console[_0x199a76(0x136)](_0x199a76(0x209)+_0x2d741e+_0x199a76(0x1bb)+_0x7acd3c['id']);return;}const _0x39dac4=(0x0,gateway_1['getGatewayIdByName'])(_0x3343ac['gateway'])||_0x3343ac[_0x199a76(0x1d9)],_0x246a47={'event':_0x2d741e,'payment':{'id':_0x3343ac['id'],'order_id':_0x3343ac[_0x199a76(0x150)],'gateway_order_id':_0x3343ac['gatewayOrderId'],'gateway':_0x39dac4,'amount':_0x3343ac[_0x199a76(0x191)],'currency':_0x3343ac[_0x199a76(0x1be)],'status':_0x2b2814[_0x199a76(0x12a)](),'customer_email':_0x3343ac[_0x199a76(0x1c3)],'customer_name':_0x3343ac[_0x199a76(0x17d)],'created_at':_0x3343ac['createdAt'],'updated_at':new Date()}},_0x4d2968=await fetch(_0x315676[_0x199a76(0x1ff)],{'method':'POST','headers':{'Content-Type':_0x199a76(0x1dd),'User-Agent':_0x199a76(0x236)},'body':JSON[_0x199a76(0x205)](_0x246a47)}),_0x1f6a57=Date[_0x199a76(0x1f7)]()-_0x67c3e1,_0x5f15c5=_0x4d2968['ok']?_0x199a76(0x22a):await _0x4d2968[_0x199a76(0x22c)]();loggerService_1[_0x199a76(0x16a)][_0x199a76(0x17f)](_0x3343ac['shopId'],_0x315676[_0x199a76(0x1ff)],_0x2d741e,_0x4d2968[_0x199a76(0x143)],_0x1f6a57,_0x246a47),console['log'](_0x199a76(0x1f6)+_0x315676[_0x199a76(0x1ff)]+_0x199a76(0x1dc)+_0x4d2968[_0x199a76(0x143)]+'\x20('+_0x1f6a57+_0x199a76(0x203));}catch(_0x294ec9){console[_0x199a76(0x16f)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x294ec9),loggerService_1[_0x199a76(0x16a)]['logShopWebhookError'](_0x3343ac[_0x199a76(0x234)],_0x3343ac['shop']?.[_0x199a76(0x187)]?.['webhookUrl']||_0x199a76(0x1fd),_0x199a76(0x1eb),_0x294ec9,{});}}async['sendPaymentStatusNotification'](_0xe1554c,_0x3119c1){const _0x1d6368=a38_0x5cb69c;try{const _0x41f631={'PENDING':_0x1d6368(0x13b),'PAID':'paid','FAILED':_0x1d6368(0x18b),'EXPIRED':'expired'},_0x2dee17=_0x41f631[_0x3119c1];if(!_0x2dee17||_0x2dee17===_0x1d6368(0x13b))return;await telegramBotService_1[_0x1d6368(0x1a6)][_0x1d6368(0x1e9)](_0xe1554c[_0x1d6368(0x234)],_0xe1554c,_0x2dee17);}catch(_0x15b230){console['error'](_0x1d6368(0x1ac),_0x15b230);}}async[a38_0x5cb69c(0x1d8)](_0x51bb8e){const _0x288f4b=a38_0x5cb69c;console[_0x288f4b(0x136)](_0x288f4b(0x1d0)+_0x51bb8e);const _0x113c3b=await database_1[_0x288f4b(0x1cf)][_0x288f4b(0x1c6)][_0x288f4b(0x217)]({'where':{'id':_0x51bb8e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x113c3b)throw new Error('Payment\x20not\x20found');if(_0x113c3b['gateway']!==_0x288f4b(0x160)&&_0x113c3b[_0x288f4b(0x1d9)]!==_0x288f4b(0x213))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x288f4b(0x136)](_0x288f4b(0x12c)+_0x113c3b['gateway']+_0x288f4b(0x172)+_0x51bb8e),await this[_0x288f4b(0x1ce)](_0x113c3b),console[_0x288f4b(0x136)](_0x288f4b(0x20c)+_0x51bb8e);}[a38_0x5cb69c(0x1b2)](){const _0x330066=a38_0x5cb69c,_0x31c01b=this[_0x330066(0x225)]?this[_0x330066(0x1d1)]:undefined,_0x40fdcc=Array[_0x330066(0x1f3)](this[_0x330066(0x16b)][_0x330066(0x134)]())[_0x330066(0x1f5)](_0x5f3bd5=>({'paymentId':_0x5f3bd5[_0x330066(0x1f8)],'gatewayPaymentId':_0x5f3bd5[_0x330066(0x157)],'createdAt':_0x5f3bd5[_0x330066(0x129)],'timersCount':_0x5f3bd5[_0x330066(0x1ee)]['length']}));return{'isActive':!!this[_0x330066(0x225)],'globalCheckIntervalMinutes':this[_0x330066(0x1d1)]/(0x3e8*0x3c),'expiryDays':this[_0x330066(0x16d)],'activeIndividualTimers':this[_0x330066(0x16b)]['size'],'nextGlobalCheckIn':_0x31c01b,'paymentTimersDetails':_0x40fdcc};}[a38_0x5cb69c(0x13c)](_0x26df15){const _0x50cb15=a38_0x5cb69c,_0x35000f=this['paymentTimers'][_0x50cb15(0x20f)](_0x26df15);if(_0x35000f)return{'hasTimers':!![],'timersCount':_0x35000f[_0x50cb15(0x1ee)][_0x50cb15(0x195)],'createdAt':_0x35000f[_0x50cb15(0x129)],'gatewayPaymentId':_0x35000f[_0x50cb15(0x157)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0x322963,_0xace23e){const _0x1ed805=a38_0x5cb69c;try{const _0x5dc35b=await database_1['default'][_0x1ed805(0x21d)][_0x1ed805(0x217)]({'where':{'id':_0x322963},'select':{'gatewaySettings':!![]}});if(!_0x5dc35b?.[_0x1ed805(0x216)])return console['log'](_0x1ed805(0x21a)+_0x322963+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x1c4d56=JSON[_0x1ed805(0x18d)](_0x5dc35b[_0x1ed805(0x216)]);for(const [_0xb5e805,_0x3c4f2e]of Object[_0x1ed805(0x176)](_0x1c4d56)){if(_0xb5e805[_0x1ed805(0x12a)]()===_0xace23e['toLowerCase']()){const _0x40fbf8=_0x3c4f2e[_0x1ed805(0x1ad)]||0xa;return console[_0x1ed805(0x136)]('Gateway\x20'+_0xace23e+_0x1ed805(0x1cc)+_0x322963+':\x20'+_0x40fbf8+'%'),_0x40fbf8;}}return console[_0x1ed805(0x136)](_0x1ed805(0x1b1)+_0xace23e+_0x1ed805(0x200)+_0x322963+',\x20using\x20default\x2010%'),0xa;}catch(_0x583561){return console[_0x1ed805(0x16f)](_0x1ed805(0x169)+_0x322963+_0x1ed805(0x1d4)+_0xace23e+':',_0x583561),0xa;}}}exports[a38_0x5cb69c(0x132)]=CoinToPayStatusService,exports[a38_0x5cb69c(0x130)]=new CoinToPayStatusService();