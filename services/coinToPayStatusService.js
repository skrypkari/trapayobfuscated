'use strict';const a40_0x342d64=a40_0x27c0;function a40_0x2ac0(){const _0x37a4cd=['paidAt','checkSinglePaymentById','\x20not\x20found\x20in\x20database','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','getGatewayCommission','stopPeriodicStatusCheck','description','forEach','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20not\x20enabled\x20for\x20shop\x20','\x20(after\x20',',\x20clearing\x20individual\x20timers','cointopay','SINGLE','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','paymentLink','EXPIRED','logCoinToPayError','adminNotes','\x20\x20\x20-\x20Status:\x20','\x20status\x20from\x20','checkPaymentById',',\x20stopping\x20individual\x20checks','üìà\x20[COINTOPAY]\x20Payment\x20','logShopWebhookSent','application/json','./currencyService','paymentTimers','\x20completed\x20for\x20payment\x20','\x20is\x20too\x20new\x20(','üßπ\x20[CHECK]\x20Payment\x20','üí∞\x20[CHECK]\x20Payment\x20','getTime','text','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','iban','../config/database','webhookLog','webhookUrl','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','cointopay_status_check_error','clearPaymentTimers','getServiceStats','\x20\x20\x20üìä\x20Status:\x20','24ffUiBY','\x20individual\x20payment\x20timers','schedulePaymentChecks','Failed\x20to\x20mark\x20payment\x20as\x20expired','paid','\x20skipped,\x20','error','confirmedOn','\x20days','‚è∞\x20[GLOBAL]\x20Payment\x20','\x20days\x20without\x20payment\x20confirmation','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','message','COINTOPAY_STATUS_CHANGE','stack','\x20payment\x20','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','size','‚ùå\x20[CHECK]\x20Payment\x20','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','3590YcRdFX','shopId','payment.failed','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','setDate','\x20commission\x20for\x20shop\x20','update','findUnique','amountUSDT','commission','\x20\x20\x20-\x20GatewayPaymentId:\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','floor','schedule_created','loggerService','includes','\x20\x20\x20-\x20Amount:\x20','currency','\x20\x20\x20Gateway\x20','logCoinToPayStatus','getGatewayIdByName','11178rjKxEX','\x20\x20\x20‚ùå\x20Error:\x20','timers','\x20to\x20clear','\x20\x20\x20üìç\x20Source:\x20','\x20not\x20found,\x20clearing\x20timers','\x20checked,\x20','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','46BmIhWq','checkSinglePayment','\x20pending\x20CoinToPay\x20payments','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','\x20initial\x20timers\x20for\x20payment\x20','909012DwBScE','5855lSfvIt','unknown','amountAfterGatewayCommissionUSDT','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','settings','cointopay2','\x20expired\x20CoinToPay\x20payments','createdOn','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','2\x20minutes','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','‚è∞\x20[GLOBAL]\x20Found\x20','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','catch','EXPIRY_DAYS','\x20\x20\x20üìÖ\x20Time:\x20','\x20->\x20','5\x20minutes','webhook_send','payment.success','push','Payment\x20older\x20than\x20','coinToPay2Service','gatewayPaymentId','Success','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','\x20is\x20older\x20than\x20','get','‚úÖ\x20[CHECK]\x20Payment\x20','3974048iMxcTJ',',\x20using\x20default\x2010%','.\x20Remaining\x20active\x20timers:\x20','FAILED','\x20status:\x20','Gateway\x20','\x20USDT','__esModule','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','type','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','cointopay_status_check_','\x20commission:\x20','üõë\x20[SHUTDOWN]\x20Cleared\x20','./gateways/coinToPayService','../types/gateway','\x20expired','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','defineProperty','./gateways/coinToPay2Service','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','h),\x20skipping\x20global\x20check',',\x20gateway\x20','transactionId','toISOString','create','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','37348siMLaY','parse','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','toFixed','\x20\x20\x20üìù\x20Context:','gatewaySettings','getDate','\x20triggered\x20for\x20payment\x20','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','checkExpiredPayments','created','map','\x20updated\x20successfully','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','set','payment.pending','status_check','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','ms)','paymentDetails','\x20to\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','/status/','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','bankDetails','delay','CoinToPayStatusService','Payment\x20not\x20found','globalCheckInterval','log','has',',\x20status=','\x20\x20\x20Amount\x20after\x20commission:\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','payment','status','606480ojUnrO','convertToUSDT','default','paymentLinkId','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','sendPaymentStatusNotification','GLOBAL_CHECK_INTERVAL_MS','Webhook\x20event\x20','length','ü™ô\x20[GLOBAL]\x20Found\x20','startPeriodicStatusCheck','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','now','not\x20found','coinToPayStatusService','\x20status\x20is\x20','./loggerService','PAID','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','shop','amount','findMany','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','sendShopWebhook','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','expired','PENDING','\x20days\x20(created\x20before\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','gateway','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','stringify','currentPayments','Automatically\x20expired\x20after\x20','\x20status\x20changed\x20to\x20','timestamp','CoinToPayService','Shop\x20webhook\x20sent\x20to\x20','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','toLowerCase','checkAllPendingPayments','TesSoft\x20Payment\x20System/1.0','üìä\x20[CHECK]\x20Payment\x20','\x20current\x20status:\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20in\x20','customerName','‚úÖ\x20[EXPIRY]\x20Payment\x20','ü™ô\x20[DEBUG]\x20Creating\x20','Failed\x20to\x20send\x20shop\x20webhook:','üìä\x20[HOURLY]\x20Payment\x20','\x20\x20\x20Amount:\x20','\x20\x20\x20üìù\x20Details:','\x20updated:\x20currentPayments=','coinToPayService','failed','\x20seconds\x20(',':\x20type=','checkPaymentStatus','-day\x20timeout',',\x20using\x20default\x20commission\x2010%','1\x20minute','telegramBotService','61518lQLXLH','logShopWebhookError','createdAt',',\x20currentPayments=','\x20(age:\x20'];a40_0x2ac0=function(){return _0x37a4cd;};return a40_0x2ac0();}(function(_0x4e125d,_0x14a74f){const _0x5a3aba=a40_0x27c0,_0x53d513=_0x4e125d();while(!![]){try{const _0x2e8d2d=parseInt(_0x5a3aba(0x185))/0x1+-parseInt(_0x5a3aba(0x145))/0x2*(parseInt(_0x5a3aba(0xdb))/0x3)+-parseInt(_0x5a3aba(0x10f))/0x4*(parseInt(_0x5a3aba(0x14b))/0x5)+-parseInt(_0x5a3aba(0x14a))/0x6+-parseInt(_0x5a3aba(0x1a9))/0x7+parseInt(_0x5a3aba(0x168))/0x8+parseInt(_0x5a3aba(0x13c))/0x9*(parseInt(_0x5a3aba(0x124))/0xa);if(_0x2e8d2d===_0x14a74f)break;else _0x53d513['push'](_0x53d513['shift']());}catch(_0x94817){_0x53d513['push'](_0x53d513['shift']());}}}(a40_0x2ac0,0x40408));var __importDefault=this&&this['__importDefault']||function(_0x1037bb){const _0x363d3b=a40_0x27c0;return _0x1037bb&&_0x1037bb[_0x363d3b(0x16f)]?_0x1037bb:{'default':_0x1037bb};};function a40_0x27c0(_0x3672fe,_0x396708){const _0x2ac0a5=a40_0x2ac0();return a40_0x27c0=function(_0x27c0c7,_0x4a9489){_0x27c0c7=_0x27c0c7-0xda;let _0x3cbb30=_0x2ac0a5[_0x27c0c7];return _0x3cbb30;},a40_0x27c0(_0x3672fe,_0x396708);}Object[a40_0x342d64(0x17b)](exports,a40_0x342d64(0x16f),{'value':!![]}),exports['coinToPayStatusService']=exports[a40_0x342d64(0x19f)]=void 0x0;const coinToPayService_1=require(a40_0x342d64(0x177)),coinToPay2Service_1=require(a40_0x342d64(0x17c)),gateway_1=require(a40_0x342d64(0x178)),database_1=__importDefault(require(a40_0x342d64(0x107))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a40_0x342d64(0x1b9)),currencyService_1=require(a40_0x342d64(0xfd));class CoinToPayStatusService{constructor(){const _0x299a58=a40_0x342d64;this[_0x299a58(0x1a1)]=null,this[_0x299a58(0x1af)]=0x3c*0x3c*0x3e8,this[_0x299a58(0x159)]=0x5,this[_0x299a58(0xfe)]=new Map(),this[_0x299a58(0x1e5)]=new coinToPayService_1[(_0x299a58(0x1d0))](),this['coinToPay2Service']=new coinToPay2Service_1['CoinToPay2Service'](),console[_0x299a58(0x1a2)]('ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}[a40_0x342d64(0x111)](_0x2a4b68,_0x39065b){const _0x4c924f=a40_0x342d64;console[_0x4c924f(0x1a2)]('ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x4c924f(0x1a2)]('\x20\x20\x20-\x20paymentId:\x20'+_0x2a4b68),console[_0x4c924f(0x1a2)](_0x4c924f(0x19a)+_0x39065b),this[_0x4c924f(0x10c)](_0x2a4b68);const _0x48e618=[],_0x303a18=new Date(),_0x24ba83=[{'delay':0x1*0x3c*0x3e8,'description':_0x4c924f(0x1ec)},{'delay':0x2*0x3c*0x3e8,'description':_0x4c924f(0x154)},{'delay':0x5*0x3c*0x3e8,'description':_0x4c924f(0x15c)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x4c924f(0x1a2)](_0x4c924f(0x1df)+_0x24ba83[_0x4c924f(0x1b1)]+_0x4c924f(0x149)+_0x2a4b68);let _0x2820ac=0x0;_0x24ba83[_0x4c924f(0xe7)]((_0x4637b9,_0x14c87c)=>{const _0x496ff3=_0x4c924f;_0x2820ac+=_0x4637b9['delay'];const _0x2c653c=setTimeout(async()=>{const _0x3c9ac3=a40_0x27c0;console['log']('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x14c87c+0x1)+_0x3c9ac3(0x18c)+_0x2a4b68+_0x3c9ac3(0xec)+_0x4637b9[_0x3c9ac3(0xe6)]+')');try{await this[_0x3c9ac3(0xe1)](_0x2a4b68),console[_0x3c9ac3(0x1a2)](_0x3c9ac3(0x17d)+(_0x14c87c+0x1)+_0x3c9ac3(0xff)+_0x2a4b68);}catch(_0x182ce0){console[_0x3c9ac3(0x115)](_0x3c9ac3(0x1c1)+(_0x14c87c+0x1)+'\x20for\x20payment\x20'+_0x2a4b68+':',_0x182ce0),this['logCoinToPayError'](_0x2a4b68,_0x39065b,_0x182ce0,_0x3c9ac3(0x195),{'checkNumber':_0x14c87c+0x1,'scheduledAfter':_0x4637b9[_0x3c9ac3(0xe6)],'isIndividualCheck':!![]});}},_0x2820ac);_0x48e618[_0x496ff3(0x15f)](_0x2c653c),console[_0x496ff3(0x1a2)](_0x496ff3(0x157)+(_0x14c87c+0x1)+'\x20for\x20payment\x20'+_0x2a4b68+_0x496ff3(0x1dc)+_0x2820ac/0x3e8+_0x496ff3(0x1e7)+_0x4637b9['description']+')');});const _0x230ca7=setInterval(async()=>{const _0x35b42a=_0x4c924f;console['log'](_0x35b42a(0xea)+_0x2a4b68);try{const _0x38edb1=await database_1[_0x35b42a(0x1ab)][_0x35b42a(0x1a7)]['findUnique']({'where':{'id':_0x2a4b68},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x38edb1){console[_0x35b42a(0x1a2)]('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x2a4b68+_0x35b42a(0x141)),this[_0x35b42a(0x10c)](_0x2a4b68);return;}console[_0x35b42a(0x1a2)](_0x35b42a(0x1e1)+_0x2a4b68+_0x35b42a(0x1d8)+_0x38edb1['status']);if(_0x38edb1['status']!=='PENDING'){console[_0x35b42a(0x1a2)]('‚úÖ\x20[HOURLY]\x20Payment\x20'+_0x2a4b68+_0x35b42a(0x1b8)+_0x38edb1['status']+_0x35b42a(0xf9)),this[_0x35b42a(0x10c)](_0x2a4b68);return;}const _0x349f0b=Math[_0x35b42a(0x133)]((Date['now']()-_0x38edb1[_0x35b42a(0xdd)][_0x35b42a(0x103)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x349f0b>=this[_0x35b42a(0x159)]){console['log']('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x2a4b68+_0x35b42a(0x165)+this[_0x35b42a(0x159)]+_0x35b42a(0x173)),this[_0x35b42a(0x10c)](_0x2a4b68);return;}await this['checkSinglePaymentById'](_0x2a4b68),console[_0x35b42a(0x1a2)](_0x35b42a(0x187)+_0x2a4b68);}catch(_0x5e278f){console[_0x35b42a(0x115)](_0x35b42a(0x105)+_0x2a4b68+':',_0x5e278f),this[_0x35b42a(0xf4)](_0x2a4b68,_0x39065b,_0x5e278f,_0x35b42a(0x195),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x48e618[_0x4c924f(0x15f)](_0x230ca7),this[_0x4c924f(0xfe)][_0x4c924f(0x193)](_0x2a4b68,{'timers':_0x48e618,'paymentId':_0x2a4b68,'gatewayPaymentId':_0x39065b,'createdAt':_0x303a18}),console['log'](_0x4c924f(0x17e)+_0x24ba83[_0x4c924f(0x1b1)]+_0x4c924f(0x155)+_0x2a4b68),console[_0x4c924f(0x1a2)](_0x4c924f(0x14e)+this['paymentTimers'][_0x4c924f(0x121)]),this[_0x4c924f(0x13a)](_0x2a4b68,_0x39065b,_0x4c924f(0x1c4),_0x4c924f(0x1c4),_0x4c924f(0x195),{'action':_0x4c924f(0x134),'scheduledChecks':_0x24ba83[_0x4c924f(0x1b1)],'firstCheckIn':_0x24ba83[0x0][_0x4c924f(0x19e)]/0x3e8,'totalTimers':this[_0x4c924f(0xfe)][_0x4c924f(0x121)]});}[a40_0x342d64(0x10c)](_0xfcc910){const _0x20402b=a40_0x342d64,_0x343d81=this[_0x20402b(0xfe)][_0x20402b(0x166)](_0xfcc910);_0x343d81?(console[_0x20402b(0x1a2)]('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x343d81[_0x20402b(0x13e)][_0x20402b(0x1b1)]+'\x20timers\x20for\x20payment\x20'+_0xfcc910),_0x343d81[_0x20402b(0x13e)][_0x20402b(0xe7)]((_0x515207,_0x2d48e9)=>{const _0x54beab=_0x20402b;_0x515207&&(clearTimeout(_0x515207),clearInterval(_0x515207),console[_0x54beab(0x1a2)](_0x54beab(0x1c9)+(_0x2d48e9+0x1)+'\x20for\x20payment\x20'+_0xfcc910));}),this[_0x20402b(0xfe)]['delete'](_0xfcc910),console[_0x20402b(0x1a2)](_0x20402b(0x196)+_0xfcc910+_0x20402b(0x16a)+this[_0x20402b(0xfe)]['size'])):console[_0x20402b(0x1a2)](_0x20402b(0x170)+_0xfcc910+_0x20402b(0x13f));}async[a40_0x342d64(0xe1)](_0x2402f9){const _0x2b0913=a40_0x342d64;console[_0x2b0913(0x1a2)](_0x2b0913(0x1d2)+_0x2402f9);const _0x1881d3=await database_1[_0x2b0913(0x1ab)][_0x2b0913(0x1a7)]['findUnique']({'where':{'id':_0x2402f9},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1881d3){console[_0x2b0913(0x1a2)](_0x2b0913(0x122)+_0x2402f9+_0x2b0913(0xe2));return;}console[_0x2b0913(0x1a2)](_0x2b0913(0x1d7)+_0x2402f9+'\x20found:'),console['log']('\x20\x20\x20-\x20Gateway:\x20'+_0x1881d3[_0x2b0913(0x1c8)]),console[_0x2b0913(0x1a2)](_0x2b0913(0xf6)+_0x1881d3['status']),console[_0x2b0913(0x1a2)](_0x2b0913(0x12f)+_0x1881d3[_0x2b0913(0x162)]),console[_0x2b0913(0x1a2)](_0x2b0913(0x137)+_0x1881d3[_0x2b0913(0x1bd)]+'\x20'+_0x1881d3[_0x2b0913(0x138)]),console[_0x2b0913(0x1a2)]('\x20\x20\x20-\x20ShopId:\x20'+_0x1881d3['shopId']);if(_0x1881d3['gateway']!==_0x2b0913(0xee)&&_0x1881d3['gateway']!=='cointopay2'){console[_0x2b0913(0x1a2)](_0x2b0913(0x18d)+_0x2402f9+_0x2b0913(0x1c7)+_0x1881d3[_0x2b0913(0x1c8)]+')');return;}if(_0x1881d3[_0x2b0913(0x1a8)]!==_0x2b0913(0x1c4)){console['log'](_0x2b0913(0x18d)+_0x2402f9+_0x2b0913(0x1b8)+_0x1881d3['status']+_0x2b0913(0xf9)),this['clearPaymentTimers'](_0x2402f9);return;}if(!_0x1881d3[_0x2b0913(0x162)]){console['log'](_0x2b0913(0x18d)+_0x2402f9+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x2b0913(0x1a2)](_0x2b0913(0x167)+_0x2402f9+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x2b0913(0x146)](_0x1881d3);}[a40_0x342d64(0x13a)](_0x6f0a92,_0x31f3d0,_0x1901c2,_0x4b343e,_0x5541e8,_0xd5b5c8){const _0x5a32a9=a40_0x342d64,_0x57527a={'type':_0x5a32a9(0x11c),'paymentId':_0x6f0a92,'gatewayPaymentId':_0x31f3d0,'oldStatus':_0x1901c2,'newStatus':_0x4b343e,'source':_0x5541e8,'timestamp':new Date()['toISOString'](),'details':_0xd5b5c8||{}};loggerService_1[_0x5a32a9(0x135)][_0x5a32a9(0x13a)](_0x57527a),console[_0x5a32a9(0x1a2)](_0x5a32a9(0x1d3)+_0x6f0a92+'\x20('+_0x31f3d0+')'),console[_0x5a32a9(0x1a2)](_0x5a32a9(0x10e)+_0x1901c2+_0x5a32a9(0x15b)+_0x4b343e),console['log'](_0x5a32a9(0x140)+_0x5541e8),console[_0x5a32a9(0x1a2)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x57527a[_0x5a32a9(0x1cf)]),_0xd5b5c8&&console['log'](_0x5a32a9(0x1e3),_0xd5b5c8);}[a40_0x342d64(0xf4)](_0x316eaa,_0x4663ab,_0x20aa47,_0x2aa4eb,_0xc4cce1){const _0x2c0e8e=a40_0x342d64,_0x2a3ba5={'type':'COINTOPAY_ERROR','paymentId':_0x316eaa,'gatewayPaymentId':_0x4663ab,'error':_0x20aa47 instanceof Error?{'message':_0x20aa47['message'],'stack':_0x20aa47[_0x2c0e8e(0x11d)]}:_0x20aa47,'source':_0x2aa4eb,'timestamp':new Date()[_0x2c0e8e(0x182)](),'context':_0xc4cce1||{}};loggerService_1[_0x2c0e8e(0x135)][_0x2c0e8e(0xf4)](_0x2a3ba5),console[_0x2c0e8e(0x115)](_0x2c0e8e(0x1b4)+_0x316eaa+'\x20('+_0x4663ab+')'),console['error'](_0x2c0e8e(0x13d)+(_0x20aa47 instanceof Error?_0x20aa47[_0x2c0e8e(0x11b)]:_0x20aa47)),console['error']('\x20\x20\x20üìç\x20Source:\x20'+_0x2aa4eb),console[_0x2c0e8e(0x115)](_0x2c0e8e(0x15a)+_0x2a3ba5[_0x2c0e8e(0x1cf)]),_0xc4cce1&&console[_0x2c0e8e(0x115)](_0x2c0e8e(0x189),_0xc4cce1);}[a40_0x342d64(0x1b3)](){const _0x17910e=a40_0x342d64;console['log'](_0x17910e(0x10a)),this[_0x17910e(0x1d5)]()[_0x17910e(0x158)](_0x43ca2d=>{const _0x35d2b8=_0x17910e;console['error'](_0x35d2b8(0xe3),_0x43ca2d);}),this['globalCheckInterval']=setInterval(async()=>{const _0x3d4999=_0x17910e;try{console[_0x3d4999(0x1a2)](_0x3d4999(0xf1)),await this[_0x3d4999(0x1d5)](),console['log'](_0x3d4999(0x19c));}catch(_0x349d17){console['error'](_0x3d4999(0x153),_0x349d17);}},this[_0x17910e(0x1af)]),console[_0x17910e(0x1a2)](_0x17910e(0x131));}[a40_0x342d64(0xe5)](){const _0x4c7bc1=a40_0x342d64;console[_0x4c7bc1(0x1a2)](_0x4c7bc1(0x11f));this[_0x4c7bc1(0x1a1)]&&(clearInterval(this[_0x4c7bc1(0x1a1)]),this[_0x4c7bc1(0x1a1)]=null,console[_0x4c7bc1(0x1a2)]('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x22a0a4=this['paymentTimers'][_0x4c7bc1(0x121)];for(const [_0x2f1f2f]of this['paymentTimers']){this[_0x4c7bc1(0x10c)](_0x2f1f2f);}console[_0x4c7bc1(0x1a2)](_0x4c7bc1(0x176)+_0x22a0a4+_0x4c7bc1(0x110));}async[a40_0x342d64(0x1d5)](){const _0x3c7fa3=a40_0x342d64;try{console[_0x3c7fa3(0x1a2)](_0x3c7fa3(0x123));const _0x4f5253=await database_1[_0x3c7fa3(0x1ab)][_0x3c7fa3(0x1a7)][_0x3c7fa3(0x1be)]({'where':{'gateway':{'in':[_0x3c7fa3(0xee),_0x3c7fa3(0x150)]},'status':_0x3c7fa3(0x1c4),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x3c7fa3(0x1b2)+_0x4f5253[_0x3c7fa3(0x1b1)]+_0x3c7fa3(0x147));if(_0x4f5253[_0x3c7fa3(0x1b1)]===0x0){console[_0x3c7fa3(0x1a2)](_0x3c7fa3(0x127));return;}const _0x48b4ed=await this[_0x3c7fa3(0x18e)](_0x4f5253);console[_0x3c7fa3(0x1a2)](_0x3c7fa3(0x156)+_0x48b4ed[_0x3c7fa3(0x1b1)]+_0x3c7fa3(0x151));let _0x5d2589=0x0,_0x4d89ee=0x0;for(const _0x310a31 of _0x4f5253){try{if(_0x48b4ed[_0x3c7fa3(0x136)](_0x310a31['id'])){console[_0x3c7fa3(0x1a2)](_0x3c7fa3(0x118)+_0x310a31['id']+_0x3c7fa3(0x1bb)),_0x4d89ee++;continue;}if(this[_0x3c7fa3(0xfe)][_0x3c7fa3(0x1a3)](_0x310a31['id'])){console[_0x3c7fa3(0x1a2)](_0x3c7fa3(0x118)+_0x310a31['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x4d89ee++;continue;}const _0x3e3e6e=(Date[_0x3c7fa3(0x1b5)]()-_0x310a31[_0x3c7fa3(0xdd)][_0x3c7fa3(0x103)]())/(0x3e8*0x3c*0x3c);if(_0x3e3e6e<0x1){console[_0x3c7fa3(0x1a2)](_0x3c7fa3(0x118)+_0x310a31['id']+_0x3c7fa3(0x100)+_0x3e3e6e[_0x3c7fa3(0x188)](0x1)+_0x3c7fa3(0x17f)),_0x4d89ee++;continue;}console['log'](_0x3c7fa3(0x172)+_0x310a31['id']+_0x3c7fa3(0xdf)+_0x3e3e6e[_0x3c7fa3(0x188)](0x1)+'h)'),await this[_0x3c7fa3(0x146)](_0x310a31),_0x5d2589++,await new Promise(_0x3a4d49=>setTimeout(_0x3a4d49,0x7d0));}catch(_0x3f87e3){console[_0x3c7fa3(0x115)](_0x3c7fa3(0xe8)+_0x310a31['id']+':',_0x3f87e3),this['logCoinToPayError'](_0x310a31['id'],_0x310a31[_0x3c7fa3(0x162)]||'unknown',_0x3f87e3,_0x3c7fa3(0x195),{'isGlobalCheck':!![],'paymentAmount':_0x310a31[_0x3c7fa3(0x1bd)],'paymentCurrency':_0x310a31['currency'],'shopId':_0x310a31[_0x3c7fa3(0x125)],'createdAt':_0x310a31['createdAt']}),loggerService_1['loggerService']['logWhiteDomainError'](_0x3c7fa3(0xee),_0x3c7fa3(0x19b)+_0x310a31[_0x3c7fa3(0x162)],_0x3f87e3);}}console[_0x3c7fa3(0x1a2)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x5d2589+_0x3c7fa3(0x142)+_0x4d89ee+_0x3c7fa3(0x114)+_0x48b4ed[_0x3c7fa3(0x1b1)]+_0x3c7fa3(0x179));}catch(_0x13a323){console[_0x3c7fa3(0x115)](_0x3c7fa3(0x132),_0x13a323);}}async['checkExpiredPayments'](_0x39a06c){const _0x4b7c71=a40_0x342d64,_0x499f71=[],_0x74a392=new Date();_0x74a392[_0x4b7c71(0x129)](_0x74a392[_0x4b7c71(0x18b)]()-this[_0x4b7c71(0x159)]),console[_0x4b7c71(0x1a2)](_0x4b7c71(0x17a)+this[_0x4b7c71(0x159)]+_0x4b7c71(0x1c5)+_0x74a392[_0x4b7c71(0x182)]()+')');for(const _0x83f62 of _0x39a06c){if(_0x83f62['createdAt']<_0x74a392){console[_0x4b7c71(0x1a2)](_0x4b7c71(0x130)+_0x83f62['id']+_0x4b7c71(0x165)+this[_0x4b7c71(0x159)]+_0x4b7c71(0xe9));try{this[_0x4b7c71(0x13a)](_0x83f62['id'],_0x83f62[_0x4b7c71(0x162)]||_0x4b7c71(0x14c),_0x4b7c71(0x1c4),_0x4b7c71(0xf3),'auto_expire',{'reason':_0x4b7c71(0x160)+this[_0x4b7c71(0x159)]+'\x20days','createdAt':_0x83f62[_0x4b7c71(0xdd)],'daysSinceCreation':Math['floor']((Date[_0x4b7c71(0x1b5)]()-_0x83f62['createdAt'][_0x4b7c71(0x103)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x83f62[_0x4b7c71(0x1bd)],'paymentCurrency':_0x83f62['currency'],'shopId':_0x83f62[_0x4b7c71(0x125)]}),await database_1[_0x4b7c71(0x1ab)][_0x4b7c71(0x1a7)]['update']({'where':{'id':_0x83f62['id']},'data':{'status':_0x4b7c71(0xf3),'updatedAt':new Date(),'adminNotes':_0x4b7c71(0x1cd)+this[_0x4b7c71(0x159)]+_0x4b7c71(0x119)}}),await database_1[_0x4b7c71(0x1ab)][_0x4b7c71(0x108)]['create']({'data':{'paymentId':_0x83f62['id'],'shopId':_0x83f62[_0x4b7c71(0x125)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x4b7c71(0x1cb)]({'reason':_0x4b7c71(0x160)+this[_0x4b7c71(0x159)]+_0x4b7c71(0x117),'createdAt':_0x83f62[_0x4b7c71(0xdd)],'expiredAt':new Date()[_0x4b7c71(0x182)](),'daysSinceCreation':Math[_0x4b7c71(0x133)]((Date[_0x4b7c71(0x1b5)]()-_0x83f62['createdAt'][_0x4b7c71(0x103)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4b7c71(0x1c0)](_0x83f62,'EXPIRED'),await this[_0x4b7c71(0x1ae)](_0x83f62,'EXPIRED'),this[_0x4b7c71(0x10c)](_0x83f62['id']),_0x499f71[_0x4b7c71(0x15f)](_0x83f62['id']),console['log'](_0x4b7c71(0x1de)+_0x83f62['id']+_0x4b7c71(0x11a)+this['EXPIRY_DAYS']+_0x4b7c71(0x1ea));}catch(_0xbfb80b){console[_0x4b7c71(0x115)](_0x4b7c71(0x1a6)+_0x83f62['id']+':',_0xbfb80b),this[_0x4b7c71(0xf4)](_0x83f62['id'],_0x83f62['gatewayPaymentId']||_0x4b7c71(0x14c),_0xbfb80b,'auto_expire',{'reason':_0x4b7c71(0x112),'createdAt':_0x83f62[_0x4b7c71(0xdd)],'daysSinceCreation':Math[_0x4b7c71(0x133)]((Date[_0x4b7c71(0x1b5)]()-_0x83f62[_0x4b7c71(0xdd)][_0x4b7c71(0x103)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x499f71;}async[a40_0x342d64(0x146)](_0x281335){const _0x13a6b3=a40_0x342d64;if(!_0x281335[_0x13a6b3(0x162)]){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x281335['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x13a6b3(0x1a2)]('üîç\x20[CHECK]\x20Checking\x20'+_0x281335['gateway']+_0x13a6b3(0x11e)+_0x281335['id']+'\x20('+_0x281335[_0x13a6b3(0x162)]+')');try{let _0x1a4ad6;_0x281335['gateway']===_0x13a6b3(0x150)?(_0x1a4ad6=await this[_0x13a6b3(0x161)][_0x13a6b3(0x1e9)](_0x281335[_0x13a6b3(0x162)]),console[_0x13a6b3(0x1a2)]('üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x281335['id']+_0x13a6b3(0x16c)+_0x1a4ad6[_0x13a6b3(0x1a8)])):(_0x1a4ad6=await this[_0x13a6b3(0x1e5)]['checkPaymentStatus'](_0x281335[_0x13a6b3(0x162)]),console[_0x13a6b3(0x1a2)](_0x13a6b3(0x1db)+_0x281335['id']+_0x13a6b3(0x16c)+_0x1a4ad6['status']));_0x1a4ad6[_0x13a6b3(0x198)]&&console['log'](_0x13a6b3(0x1d7)+_0x281335['id']+'\x20details:',{'iban':_0x1a4ad6[_0x13a6b3(0x198)][_0x13a6b3(0x106)]||_0x13a6b3(0x1b6),'transactionId':_0x1a4ad6[_0x13a6b3(0x198)][_0x13a6b3(0x181)],'createdOn':_0x1a4ad6['paymentDetails'][_0x13a6b3(0x152)],'confirmedOn':_0x1a4ad6['paymentDetails'][_0x13a6b3(0x116)]||'not\x20confirmed'});if(_0x1a4ad6[_0x13a6b3(0x1a8)]!==_0x281335[_0x13a6b3(0x1a8)]){console[_0x13a6b3(0x1a2)]('üîÑ\x20[CHECK]\x20Updating\x20payment\x20'+_0x281335['id']+_0x13a6b3(0xf7)+_0x281335[_0x13a6b3(0x1a8)]+_0x13a6b3(0x199)+_0x1a4ad6[_0x13a6b3(0x1a8)]),this[_0x13a6b3(0x13a)](_0x281335['id'],_0x281335[_0x13a6b3(0x162)],_0x281335[_0x13a6b3(0x1a8)],_0x1a4ad6[_0x13a6b3(0x1a8)],_0x13a6b3(0x195),{'paymentDetails':_0x1a4ad6[_0x13a6b3(0x198)],'amount':_0x1a4ad6[_0x13a6b3(0x1bd)],'currency':_0x1a4ad6[_0x13a6b3(0x138)],'shopId':_0x281335[_0x13a6b3(0x125)],'checkTimestamp':new Date()[_0x13a6b3(0x182)]()});const _0x343810={'status':_0x1a4ad6[_0x13a6b3(0x1a8)],'updatedAt':new Date()};if(_0x1a4ad6[_0x13a6b3(0x1a8)]===_0x13a6b3(0x1ba)&&_0x281335['status']!=='PAID'){_0x343810[_0x13a6b3(0xe0)]=new Date();if(!_0x281335['amountUSDT']){const _0xc90e0b=await currencyService_1['currencyService'][_0x13a6b3(0x1aa)](_0x281335[_0x13a6b3(0x1bd)],_0x281335[_0x13a6b3(0x138)]);_0x343810[_0x13a6b3(0x12d)]=_0xc90e0b;const _0x5a13c2=await this[_0x13a6b3(0xe4)](_0x281335[_0x13a6b3(0x125)],_0x281335[_0x13a6b3(0x1c8)]),_0x55c61b=_0xc90e0b*(0x1-_0x5a13c2/0x64);_0x343810[_0x13a6b3(0x14d)]=_0x55c61b,_0x343810['gatewayCommissionRate']=_0x5a13c2,console[_0x13a6b3(0x1a2)](_0x13a6b3(0x102)+_0x281335['id']+'\x20amounts\x20calculated:'),console['log'](_0x13a6b3(0x1e2)+_0x281335[_0x13a6b3(0x1bd)]+'\x20'+_0x281335[_0x13a6b3(0x138)]+_0x13a6b3(0x15b)+_0xc90e0b[_0x13a6b3(0x188)](0x6)+_0x13a6b3(0x16e)),console[_0x13a6b3(0x1a2)](_0x13a6b3(0x139)+_0x281335[_0x13a6b3(0x1c8)]+_0x13a6b3(0x175)+_0x5a13c2+'%'),console[_0x13a6b3(0x1a2)](_0x13a6b3(0x1a5)+_0x55c61b[_0x13a6b3(0x188)](0x6)+_0x13a6b3(0x16e));}console['log'](_0x13a6b3(0x102)+_0x281335['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x343810['paidAt']['toISOString']());}if(_0x1a4ad6[_0x13a6b3(0x198)]){const _0xda6d63=_0x1a4ad6['paymentDetails'];_0xda6d63[_0x13a6b3(0x106)]&&(_0x343810['remitterIban']=_0xda6d63['iban'],console[_0x13a6b3(0x1a2)](_0x13a6b3(0x1d9)+_0xda6d63['iban']));if(_0xda6d63[_0x13a6b3(0x19d)]){const _0x3f3b08=_0x281335[_0x13a6b3(0xf5)]||'',_0x230737='Bank\x20Details:\x20'+_0xda6d63[_0x13a6b3(0x19d)];_0x343810[_0x13a6b3(0xf5)]=_0x3f3b08?_0x3f3b08+'\x0a\x0a'+_0x230737:_0x230737,console['log']('üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0xda6d63[_0x13a6b3(0x181)]&&console['log']('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0xda6d63[_0x13a6b3(0x181)]),_0xda6d63['confirmedOn']&&console['log']('‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0xda6d63[_0x13a6b3(0x116)]);}await database_1[_0x13a6b3(0x1ab)][_0x13a6b3(0x1a7)][_0x13a6b3(0x12b)]({'where':{'id':_0x281335['id']},'data':_0x343810});if(_0x1a4ad6[_0x13a6b3(0x1a8)]==='PAID'&&_0x281335['status']!=='PAID'){console['log']('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x281335['id']+_0x13a6b3(0x143));const _0x5ba923=await database_1[_0x13a6b3(0x1ab)][_0x13a6b3(0x1a7)][_0x13a6b3(0x12c)]({'where':{'id':_0x281335['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x5ba923?.[_0x13a6b3(0x1ac)]&&_0x5ba923[_0x13a6b3(0xf2)])try{const _0x19b967=_0x5ba923['paymentLink'];console[_0x13a6b3(0x1a2)](_0x13a6b3(0x120)+_0x19b967['id']+_0x13a6b3(0x1e8)+_0x19b967[_0x13a6b3(0x171)]+_0x13a6b3(0xde)+_0x19b967[_0x13a6b3(0x1cc)]+_0x13a6b3(0x1a4)+_0x19b967[_0x13a6b3(0x1a8)]);const _0x34c3cf=_0x19b967[_0x13a6b3(0x1cc)]+0x1,_0x338445=_0x19b967[_0x13a6b3(0x171)]===_0x13a6b3(0xef)?'COMPLETED':_0x19b967[_0x13a6b3(0x1a8)];await database_1[_0x13a6b3(0x1ab)][_0x13a6b3(0xf2)]['update']({'where':{'id':_0x19b967['id']},'data':{'currentPayments':_0x34c3cf,'status':_0x338445,'updatedAt':new Date()}}),console[_0x13a6b3(0x1a2)](_0x13a6b3(0x164)+_0x19b967['id']+_0x13a6b3(0x1e4)+_0x19b967[_0x13a6b3(0x1cc)]+_0x13a6b3(0x15b)+_0x34c3cf+',\x20status='+_0x19b967[_0x13a6b3(0x1a8)]+_0x13a6b3(0x15b)+_0x338445);}catch(_0x250ca1){console['error'](_0x13a6b3(0x128),_0x250ca1);}else console[_0x13a6b3(0x1a2)](_0x13a6b3(0xfa)+_0x281335['id']+_0x13a6b3(0x184));}await database_1['default'][_0x13a6b3(0x108)][_0x13a6b3(0x183)]({'data':{'paymentId':_0x281335['id'],'shopId':_0x281335[_0x13a6b3(0x125)],'event':_0x13a6b3(0x174)+_0x1a4ad6[_0x13a6b3(0x1a8)][_0x13a6b3(0x1d4)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x281335[_0x13a6b3(0x1a8)],'newStatus':_0x1a4ad6['status'],'paymentDetails':_0x1a4ad6[_0x13a6b3(0x198)],'checkedAt':new Date()[_0x13a6b3(0x182)]()})}}),await this[_0x13a6b3(0x1c0)](_0x281335,_0x1a4ad6[_0x13a6b3(0x1a8)]),await this[_0x13a6b3(0x1ae)](_0x281335,_0x1a4ad6[_0x13a6b3(0x1a8)]),_0x1a4ad6['status']!==_0x13a6b3(0x1c4)&&(console[_0x13a6b3(0x1a2)](_0x13a6b3(0x101)+_0x281335['id']+_0x13a6b3(0x1ce)+_0x1a4ad6['status']+_0x13a6b3(0xed)),this['clearPaymentTimers'](_0x281335['id'])),console['log'](_0x13a6b3(0x167)+_0x281335['id']+_0x13a6b3(0x191));}else console['log'](_0x13a6b3(0x1d7)+_0x281335['id']+'\x20status\x20unchanged\x20('+_0x1a4ad6[_0x13a6b3(0x1a8)]+')'),this[_0x13a6b3(0x13a)](_0x281335['id'],_0x281335[_0x13a6b3(0x162)],_0x281335[_0x13a6b3(0x1a8)],_0x1a4ad6[_0x13a6b3(0x1a8)],_0x13a6b3(0x195),{'statusUnchanged':!![],'paymentDetails':_0x1a4ad6[_0x13a6b3(0x198)],'amount':_0x1a4ad6[_0x13a6b3(0x1bd)],'currency':_0x1a4ad6[_0x13a6b3(0x138)],'shopId':_0x281335['shopId'],'checkTimestamp':new Date()['toISOString']()});}catch(_0x41e53f){console[_0x13a6b3(0x115)](_0x13a6b3(0x144)+_0x281335['id']+':',_0x41e53f),this[_0x13a6b3(0xf4)](_0x281335['id'],_0x281335[_0x13a6b3(0x162)],_0x41e53f,'status_check',{'paymentAmount':_0x281335['amount'],'paymentCurrency':_0x281335[_0x13a6b3(0x138)],'shopId':_0x281335[_0x13a6b3(0x125)],'createdAt':_0x281335[_0x13a6b3(0xdd)]}),await database_1[_0x13a6b3(0x1ab)]['webhookLog'][_0x13a6b3(0x183)]({'data':{'paymentId':_0x281335['id'],'shopId':_0x281335[_0x13a6b3(0x125)],'event':_0x13a6b3(0x10b),'statusCode':0x1f4,'responseBody':JSON[_0x13a6b3(0x1cb)]({'error':_0x41e53f instanceof Error?_0x41e53f['message']:'Unknown\x20error','gatewayPaymentId':_0x281335[_0x13a6b3(0x162)],'checkedAt':new Date()[_0x13a6b3(0x182)]()})}});}}async[a40_0x342d64(0x1c0)](_0x4bb65a,_0x5b56df){const _0x407877=a40_0x342d64,_0x22797d=Date[_0x407877(0x1b5)]();try{const _0x2618ca=_0x4bb65a['shop'],_0x2fe0f6=_0x2618ca[_0x407877(0x14f)];if(!_0x2fe0f6?.[_0x407877(0x109)]){console[_0x407877(0x1a2)](_0x407877(0x1c6)+_0x2618ca['id']);return;}const _0x2fc78d=_0x5b56df===_0x407877(0x1ba)?_0x407877(0x15e):_0x5b56df===_0x407877(0x16b)?_0x407877(0x126):_0x5b56df==='EXPIRED'?_0x407877(0x126):_0x407877(0x194);if(!_0x2fe0f6['webhookEvents']?.['includes'](_0x2fc78d)){console[_0x407877(0x1a2)](_0x407877(0x1b0)+_0x2fc78d+_0x407877(0xeb)+_0x2618ca['id']);return;}const _0x4bbd55=(0x0,gateway_1[_0x407877(0x13b)])(_0x4bb65a[_0x407877(0x1c8)])||_0x4bb65a[_0x407877(0x1c8)],_0x8561c7={'event':_0x2fc78d,'payment':{'id':_0x4bb65a['id'],'order_id':_0x4bb65a['orderId'],'gateway_order_id':_0x4bb65a['gatewayOrderId'],'gateway':_0x4bbd55,'amount':_0x4bb65a[_0x407877(0x1bd)],'currency':_0x4bb65a[_0x407877(0x138)],'status':_0x5b56df[_0x407877(0x1d4)](),'customer_email':_0x4bb65a['customerEmail'],'customer_name':_0x4bb65a[_0x407877(0x1dd)],'created_at':_0x4bb65a['createdAt'],'updated_at':new Date()}},_0x10794e=await fetch(_0x2fe0f6[_0x407877(0x109)],{'method':'POST','headers':{'Content-Type':_0x407877(0xfc),'User-Agent':_0x407877(0x1d6)},'body':JSON[_0x407877(0x1cb)](_0x8561c7)}),_0x439c1c=Date[_0x407877(0x1b5)]()-_0x22797d,_0x39bc76=_0x10794e['ok']?_0x407877(0x163):await _0x10794e[_0x407877(0x104)]();loggerService_1[_0x407877(0x135)][_0x407877(0xfb)](_0x4bb65a[_0x407877(0x125)],_0x2fe0f6[_0x407877(0x109)],_0x2fc78d,_0x10794e[_0x407877(0x1a8)],_0x439c1c,_0x8561c7),console[_0x407877(0x1a2)](_0x407877(0x1d1)+_0x2fe0f6[_0x407877(0x109)]+'\x20with\x20status\x20'+_0x10794e[_0x407877(0x1a8)]+'\x20('+_0x439c1c+_0x407877(0x197));}catch(_0x5abef1){console['error'](_0x407877(0x1e0),_0x5abef1),loggerService_1[_0x407877(0x135)][_0x407877(0xdc)](_0x4bb65a[_0x407877(0x125)],_0x4bb65a[_0x407877(0x1bc)]?.[_0x407877(0x14f)]?.[_0x407877(0x109)]||_0x407877(0x14c),_0x407877(0x15d),_0x5abef1,{});}}async['sendPaymentStatusNotification'](_0x35d4e0,_0x395f90){const _0x28c6a1=a40_0x342d64;try{const _0x4471a2={'PENDING':'created','PAID':_0x28c6a1(0x113),'FAILED':_0x28c6a1(0x1e6),'EXPIRED':_0x28c6a1(0x1c3)},_0x20a661=_0x4471a2[_0x395f90];if(!_0x20a661||_0x20a661===_0x28c6a1(0x18f))return;await telegramBotService_1[_0x28c6a1(0xda)]['sendPaymentNotification'](_0x35d4e0['shopId'],_0x35d4e0,_0x20a661);}catch(_0x4327d2){console[_0x28c6a1(0x115)](_0x28c6a1(0xf0),_0x4327d2);}}async[a40_0x342d64(0xf8)](_0x3c8098){const _0x1557f7=a40_0x342d64;console[_0x1557f7(0x1a2)](_0x1557f7(0x192)+_0x3c8098);const _0x5c5224=await database_1['default'][_0x1557f7(0x1a7)][_0x1557f7(0x12c)]({'where':{'id':_0x3c8098},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5c5224)throw new Error(_0x1557f7(0x1a0));if(_0x5c5224[_0x1557f7(0x1c8)]!==_0x1557f7(0xee)&&_0x5c5224[_0x1557f7(0x1c8)]!=='cointopay2')throw new Error(_0x1557f7(0x1da));console[_0x1557f7(0x1a2)](_0x1557f7(0x148)+_0x5c5224['gateway']+_0x1557f7(0x11e)+_0x3c8098),await this['checkSinglePayment'](_0x5c5224),console['log'](_0x1557f7(0x1ad)+_0x3c8098);}[a40_0x342d64(0x10d)](){const _0x418e89=a40_0x342d64,_0x8cba47=this['globalCheckInterval']?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x286643=Array['from'](this['paymentTimers']['values']())[_0x418e89(0x190)](_0x58beba=>({'paymentId':_0x58beba['paymentId'],'gatewayPaymentId':_0x58beba[_0x418e89(0x162)],'createdAt':_0x58beba[_0x418e89(0xdd)],'timersCount':_0x58beba[_0x418e89(0x13e)]['length']}));return{'isActive':!!this[_0x418e89(0x1a1)],'globalCheckIntervalMinutes':this[_0x418e89(0x1af)]/(0x3e8*0x3c),'expiryDays':this[_0x418e89(0x159)],'activeIndividualTimers':this['paymentTimers']['size'],'nextGlobalCheckIn':_0x8cba47,'paymentTimersDetails':_0x286643};}['getPaymentTimerInfo'](_0x338476){const _0x2c1dc2=a40_0x342d64,_0x108af5=this[_0x2c1dc2(0xfe)][_0x2c1dc2(0x166)](_0x338476);if(_0x108af5)return{'hasTimers':!![],'timersCount':_0x108af5[_0x2c1dc2(0x13e)][_0x2c1dc2(0x1b1)],'createdAt':_0x108af5[_0x2c1dc2(0xdd)],'gatewayPaymentId':_0x108af5['gatewayPaymentId']};return{'hasTimers':![]};}async[a40_0x342d64(0xe4)](_0x89038c,_0x5496eb){const _0xa7d9c0=a40_0x342d64;try{const _0x5e6127=await database_1[_0xa7d9c0(0x1ab)][_0xa7d9c0(0x1bc)][_0xa7d9c0(0x12c)]({'where':{'id':_0x89038c},'select':{'gatewaySettings':!![]}});if(!_0x5e6127?.['gatewaySettings'])return console[_0xa7d9c0(0x1a2)](_0xa7d9c0(0x1bf)+_0x89038c+_0xa7d9c0(0x1eb)),0xa;const _0x2b0b4d=JSON[_0xa7d9c0(0x186)](_0x5e6127[_0xa7d9c0(0x18a)]);for(const [_0x5e09cd,_0x353f21]of Object['entries'](_0x2b0b4d)){if(_0x5e09cd[_0xa7d9c0(0x1d4)]()===_0x5496eb['toLowerCase']()){const _0x3f73d0=_0x353f21[_0xa7d9c0(0x12e)]||0xa;return console[_0xa7d9c0(0x1a2)](_0xa7d9c0(0x16d)+_0x5496eb+_0xa7d9c0(0x12a)+_0x89038c+':\x20'+_0x3f73d0+'%'),_0x3f73d0;}}return console[_0xa7d9c0(0x1a2)](_0xa7d9c0(0x1ca)+_0x5496eb+'\x20in\x20shop\x20'+_0x89038c+_0xa7d9c0(0x169)),0xa;}catch(_0x3ab1b6){return console[_0xa7d9c0(0x115)](_0xa7d9c0(0x1c2)+_0x89038c+_0xa7d9c0(0x180)+_0x5496eb+':',_0x3ab1b6),0xa;}}}exports[a40_0x342d64(0x19f)]=CoinToPayStatusService,exports[a40_0x342d64(0x1b7)]=new CoinToPayStatusService();