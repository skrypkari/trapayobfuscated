'use strict';const a35_0x41a453=a35_0x5315;function a35_0x5315(_0x375b78,_0x2cb775){const _0x20852c=a35_0x2085();return a35_0x5315=function(_0x5315bc,_0xbda487){_0x5315bc=_0x5315bc-0x13f;let _0x37a71d=_0x20852c[_0x5315bc];return _0x37a71d;},a35_0x5315(_0x375b78,_0x2cb775);}(function(_0x470d28,_0x4a86d9){const _0x2b2fb6=a35_0x5315,_0x4287dd=_0x470d28();while(!![]){try{const _0x4bb4e6=-parseInt(_0x2b2fb6(0x181))/0x1*(parseInt(_0x2b2fb6(0x189))/0x2)+-parseInt(_0x2b2fb6(0x15e))/0x3+-parseInt(_0x2b2fb6(0x161))/0x4*(parseInt(_0x2b2fb6(0x18c))/0x5)+parseInt(_0x2b2fb6(0x19a))/0x6*(-parseInt(_0x2b2fb6(0x16d))/0x7)+-parseInt(_0x2b2fb6(0x1cd))/0x8*(-parseInt(_0x2b2fb6(0x145))/0x9)+-parseInt(_0x2b2fb6(0x198))/0xa*(parseInt(_0x2b2fb6(0x18b))/0xb)+parseInt(_0x2b2fb6(0x1ae))/0xc;if(_0x4bb4e6===_0x4a86d9)break;else _0x4287dd['push'](_0x4287dd['shift']());}catch(_0x154d93){_0x4287dd['push'](_0x4287dd['shift']());}}}(a35_0x2085,0x46593));var __importDefault=this&&this[a35_0x41a453(0x151)]||function(_0x49879a){const _0x284d67=a35_0x41a453;return _0x49879a&&_0x49879a[_0x284d67(0x1bf)]?_0x49879a:{'default':_0x49879a};};function a35_0x2085(){const _0x119eae=['PAID','24ShbhCO','telegramBotService','Bank\x20Details:\x20','âœ…\x20Payment\x20','currency','sendPaymentNotification','\x20CoinToPay\x20payments','createdOn','create','1688778SKOUXE','startPeriodicStatusCheck','cointopay_status_check_error','ðŸ†”\x20Transaction\x20ID:\x20','failed','gatewayOrderId','coinToPayStatusService','stringify','includes','not\x20found','EXPIRY_DAYS','checkAllPendingPayments','__importDefault','ðŸª™\x20Checking\x20','adminNotes','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','findMany','\x20has\x20no\x20gatewayPaymentId,\x20skipping','iban','length','ms)','\x20status\x20from\x20','bankDetails','cointopay_status_check_','now','78996xmdkDN','push','checkInterval','5648CtQOyO','CoinToPayStatusService','logShopWebhookSent','logShopWebhookError','created','coinToPayService','shopId','floor','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','toISOString','confirmedOn','loggerService','14attKtj','Failed\x20to\x20send\x20shop\x20webhook:','setDate','FAILED','/status/','unknown','payment.pending','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','0100','customerName','Failed\x20to\x20check\x20payment\x20','Shop\x20webhook\x20sent\x20to\x20','âœ…\x20Transaction\x20confirmed\x20on:\x20','createdAt','getTime','ðŸ”\x20Checking\x20CoinToPay\x20payment\x20','paidAt','webhookUrl','Success','â°\x20Payment\x20','1EVXVnv','Periodic\x20CoinToPay\x20status\x20check\x20failed:','customerEmail','âœ…\x20Completed\x20checking\x20','\x20status\x20unchanged\x20(','ðŸ“Š\x20Payment\x20','not\x20confirmed','paymentDetails','21674MYNYZX','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','2325422vpWBdG','685BHwqwo','\x20is\x20older\x20than\x20','ðŸ¦\x20Saved\x20IBAN:\x20','payment','amount','status','ðŸ’°\x20Payment\x20','webhookEvents','\x20days\x20(created\x20before\x20','settings','error','\x20pending\x20CoinToPay\x20payments','10REzcPq','POST','69516bVVAWJ','getServiceStats','\x20marked\x20as\x20paid\x20at:\x20','\x20expired\x20CoinToPay\x20payments','EXPIRED','Webhook\x20event\x20','defineProperty','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','message','\x20with\x20status\x20','toLowerCase','../config/database','gatewayPaymentId','logWhiteDomainError','\x20days\x20without\x20payment\x20confirmation','ðŸ”„\x20Updating\x20payment\x20','Payment\x20older\x20than\x20','application/json','â°\x20Found\x20','2284896GrAyAK','shop','update','checkSinglePayment','sendPaymentStatusNotification','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','checkPaymentById','âš ï¸\x20Payment\x20','cointopay','Automatically\x20expired\x20after\x20','\x20days,\x20marking\x20as\x20EXPIRED','default','sendShopWebhook','getDate','Payment\x20not\x20found','webhook_send','webhookLog','__esModule','transactionId','\x20not\x20enabled\x20for\x20shop\x20','log','âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','CHECK_INTERVAL_MS','./gateways/coinToPayService','./loggerService','checkExpiredPayments','Initial\x20CoinToPay\x20status\x20check\x20failed:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20to\x20','paid'];a35_0x2085=function(){return _0x119eae;};return a35_0x2085();}Object[a35_0x41a453(0x1a0)](exports,a35_0x41a453(0x1bf),{'value':!![]}),exports[a35_0x41a453(0x14b)]=exports[a35_0x41a453(0x162)]=void 0x0;const coinToPayService_1=require(a35_0x41a453(0x1c5)),database_1=__importDefault(require(a35_0x41a453(0x1a6))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a35_0x41a453(0x1c6));class CoinToPayStatusService{constructor(){const _0x442042=a35_0x41a453;this[_0x442042(0x160)]=null,this[_0x442042(0x1c4)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x442042(0x166)]=new coinToPayService_1['CoinToPayService']();}[a35_0x41a453(0x146)](){const _0x31ef96=a35_0x41a453;console[_0x31ef96(0x1c2)](_0x31ef96(0x18a)),this[_0x31ef96(0x150)]()['catch'](_0x402e85=>{const _0x5c3fd6=_0x31ef96;console[_0x5c3fd6(0x196)](_0x5c3fd6(0x1c8),_0x402e85);}),this[_0x31ef96(0x160)]=setInterval(async()=>{const _0x214e75=_0x31ef96;try{await this[_0x214e75(0x150)]();}catch(_0x5792e0){console[_0x214e75(0x196)](_0x214e75(0x182),_0x5792e0);}},this[_0x31ef96(0x1c4)]),console[_0x31ef96(0x1c2)](_0x31ef96(0x1c3));}['stopPeriodicStatusCheck'](){const _0x2bf760=a35_0x41a453;this[_0x2bf760(0x160)]&&(clearInterval(this[_0x2bf760(0x160)]),this[_0x2bf760(0x160)]=null,console[_0x2bf760(0x1c2)]('ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped'));}async[a35_0x41a453(0x150)](){const _0x4b381e=a35_0x41a453;try{const _0xe0e12c=await database_1['default'][_0x4b381e(0x18f)][_0x4b381e(0x155)]({'where':{'gateway':_0x4b381e(0x1b6),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0xe0e12c[_0x4b381e(0x158)]===0x0){console['log']('ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}console['log'](_0x4b381e(0x152)+_0xe0e12c['length']+_0x4b381e(0x197));const _0x41f1a7=await this[_0x4b381e(0x1c7)](_0xe0e12c);console[_0x4b381e(0x1c2)](_0x4b381e(0x1ad)+_0x41f1a7['length']+_0x4b381e(0x19d));for(const _0x4220ed of _0xe0e12c){try{if(_0x41f1a7[_0x4b381e(0x14d)](_0x4220ed['id'])){console['log'](_0x4b381e(0x180)+_0x4220ed['id']+_0x4b381e(0x1b3));continue;}await this[_0x4b381e(0x1b1)](_0x4220ed),await new Promise(_0xcb48bd=>setTimeout(_0xcb48bd,0x7d0));}catch(_0x486b4e){console[_0x4b381e(0x196)](_0x4b381e(0x174)+_0x4220ed['id']+':',_0x486b4e),loggerService_1[_0x4b381e(0x16c)][_0x4b381e(0x1a8)](_0x4b381e(0x1b6),_0x4b381e(0x171)+_0x4220ed[_0x4b381e(0x1a7)],_0x486b4e);}}console[_0x4b381e(0x1c2)](_0x4b381e(0x184)+_0xe0e12c[_0x4b381e(0x158)]+_0x4b381e(0x142));}catch(_0x61d739){console[_0x4b381e(0x196)](_0x4b381e(0x154),_0x61d739);}}async[a35_0x41a453(0x1c7)](_0x30d9d9){const _0x1396ec=a35_0x41a453,_0x10ec5b=[],_0xae90a2=new Date();_0xae90a2[_0x1396ec(0x16f)](_0xae90a2[_0x1396ec(0x1bb)]()-this[_0x1396ec(0x14f)]),console[_0x1396ec(0x1c2)](_0x1396ec(0x169)+this[_0x1396ec(0x14f)]+_0x1396ec(0x194)+_0xae90a2['toISOString']()+')');for(const _0x1c01a7 of _0x30d9d9){if(_0x1c01a7['createdAt']<_0xae90a2){console[_0x1396ec(0x1c2)](_0x1396ec(0x180)+_0x1c01a7['id']+_0x1396ec(0x18d)+this[_0x1396ec(0x14f)]+_0x1396ec(0x1b8));try{await database_1[_0x1396ec(0x1b9)]['payment'][_0x1396ec(0x1b0)]({'where':{'id':_0x1c01a7['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x1396ec(0x1b7)+this['EXPIRY_DAYS']+_0x1396ec(0x1a9)}}),await database_1[_0x1396ec(0x1b9)][_0x1396ec(0x1be)]['create']({'data':{'paymentId':_0x1c01a7['id'],'shopId':_0x1c01a7[_0x1396ec(0x167)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x1396ec(0x14c)]({'reason':_0x1396ec(0x1ab)+this[_0x1396ec(0x14f)]+'\x20days','createdAt':_0x1c01a7[_0x1396ec(0x17a)],'expiredAt':new Date()[_0x1396ec(0x16a)](),'daysSinceCreation':Math[_0x1396ec(0x168)]((Date[_0x1396ec(0x15d)]()-_0x1c01a7[_0x1396ec(0x17a)][_0x1396ec(0x17b)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x1396ec(0x1ba)](_0x1c01a7,_0x1396ec(0x19e)),await this[_0x1396ec(0x1b2)](_0x1c01a7,_0x1396ec(0x19e)),_0x10ec5b[_0x1396ec(0x15f)](_0x1c01a7['id']),console[_0x1396ec(0x1c2)](_0x1396ec(0x13f)+_0x1c01a7['id']+_0x1396ec(0x1a1)+this[_0x1396ec(0x14f)]+'-day\x20timeout');}catch(_0x22df93){console[_0x1396ec(0x196)]('Failed\x20to\x20expire\x20payment\x20'+_0x1c01a7['id']+':',_0x22df93);}}}return _0x10ec5b;}async[a35_0x41a453(0x1b1)](_0x5883e2){const _0x41cfdd=a35_0x41a453;if(!_0x5883e2[_0x41cfdd(0x1a7)]){console['log'](_0x41cfdd(0x1b5)+_0x5883e2['id']+_0x41cfdd(0x156));return;}console[_0x41cfdd(0x1c2)](_0x41cfdd(0x17c)+_0x5883e2['id']+'\x20('+_0x5883e2[_0x41cfdd(0x1a7)]+')');try{const _0x227cfb=await this[_0x41cfdd(0x166)]['checkPaymentStatus'](_0x5883e2[_0x41cfdd(0x1a7)]);console[_0x41cfdd(0x1c2)](_0x41cfdd(0x186)+_0x5883e2['id']+'\x20status:\x20'+_0x227cfb[_0x41cfdd(0x191)]);_0x227cfb[_0x41cfdd(0x188)]&&console[_0x41cfdd(0x1c2)](_0x41cfdd(0x186)+_0x5883e2['id']+'\x20details:',{'iban':_0x227cfb[_0x41cfdd(0x188)][_0x41cfdd(0x157)]||_0x41cfdd(0x14e),'transactionId':_0x227cfb['paymentDetails'][_0x41cfdd(0x1c0)],'createdOn':_0x227cfb[_0x41cfdd(0x188)][_0x41cfdd(0x143)],'confirmedOn':_0x227cfb[_0x41cfdd(0x188)][_0x41cfdd(0x16b)]||_0x41cfdd(0x187)});if(_0x227cfb[_0x41cfdd(0x191)]!==_0x5883e2['status']){console[_0x41cfdd(0x1c2)](_0x41cfdd(0x1aa)+_0x5883e2['id']+_0x41cfdd(0x15a)+_0x5883e2['status']+_0x41cfdd(0x1ca)+_0x227cfb['status']);const _0x140712={'status':_0x227cfb[_0x41cfdd(0x191)],'updatedAt':new Date()};_0x227cfb['status']===_0x41cfdd(0x1cc)&&_0x5883e2['status']!=='PAID'&&(_0x140712[_0x41cfdd(0x17d)]=new Date(),console[_0x41cfdd(0x1c2)](_0x41cfdd(0x192)+_0x5883e2['id']+_0x41cfdd(0x19c)+_0x140712[_0x41cfdd(0x17d)][_0x41cfdd(0x16a)]()));if(_0x227cfb[_0x41cfdd(0x188)]){const _0x56eaad=_0x227cfb[_0x41cfdd(0x188)];_0x56eaad[_0x41cfdd(0x157)]&&(_0x140712['remitterIban']=_0x56eaad[_0x41cfdd(0x157)],console[_0x41cfdd(0x1c2)](_0x41cfdd(0x18e)+_0x56eaad['iban']));if(_0x56eaad[_0x41cfdd(0x15b)]){const _0x5df6a3=_0x5883e2[_0x41cfdd(0x153)]||'',_0x53e1d8=_0x41cfdd(0x1cf)+_0x56eaad[_0x41cfdd(0x15b)];_0x140712[_0x41cfdd(0x153)]=_0x5df6a3?_0x5df6a3+'\x0a\x0a'+_0x53e1d8:_0x53e1d8,console[_0x41cfdd(0x1c2)](_0x41cfdd(0x1a2));}_0x56eaad['transactionId']&&console[_0x41cfdd(0x1c2)](_0x41cfdd(0x148)+_0x56eaad[_0x41cfdd(0x1c0)]),_0x56eaad['confirmedOn']&&console['log'](_0x41cfdd(0x179)+_0x56eaad[_0x41cfdd(0x16b)]);}await database_1['default'][_0x41cfdd(0x18f)][_0x41cfdd(0x1b0)]({'where':{'id':_0x5883e2['id']},'data':_0x140712}),await database_1[_0x41cfdd(0x1b9)][_0x41cfdd(0x1be)][_0x41cfdd(0x144)]({'data':{'paymentId':_0x5883e2['id'],'shopId':_0x5883e2['shopId'],'event':_0x41cfdd(0x15c)+_0x227cfb[_0x41cfdd(0x191)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x41cfdd(0x14c)]({'oldStatus':_0x5883e2[_0x41cfdd(0x191)],'newStatus':_0x227cfb[_0x41cfdd(0x191)],'paymentDetails':_0x227cfb[_0x41cfdd(0x188)],'checkedAt':new Date()[_0x41cfdd(0x16a)]()})}}),await this['sendShopWebhook'](_0x5883e2,_0x227cfb[_0x41cfdd(0x191)]),await this['sendPaymentStatusNotification'](_0x5883e2,_0x227cfb[_0x41cfdd(0x191)]),console[_0x41cfdd(0x1c2)]('âœ…\x20Payment\x20'+_0x5883e2['id']+'\x20updated\x20successfully');}else console[_0x41cfdd(0x1c2)]('ðŸ“Š\x20Payment\x20'+_0x5883e2['id']+_0x41cfdd(0x185)+_0x227cfb[_0x41cfdd(0x191)]+')');}catch(_0x405b5c){console[_0x41cfdd(0x196)](_0x41cfdd(0x177)+_0x5883e2['id']+':',_0x405b5c),await database_1[_0x41cfdd(0x1b9)][_0x41cfdd(0x1be)]['create']({'data':{'paymentId':_0x5883e2['id'],'shopId':_0x5883e2['shopId'],'event':_0x41cfdd(0x147),'statusCode':0x1f4,'responseBody':JSON[_0x41cfdd(0x14c)]({'error':_0x405b5c instanceof Error?_0x405b5c[_0x41cfdd(0x1a3)]:'Unknown\x20error','gatewayPaymentId':_0x5883e2['gatewayPaymentId'],'checkedAt':new Date()[_0x41cfdd(0x16a)]()})}});}}async['sendShopWebhook'](_0x155945,_0x1f2a63){const _0x35e5fe=a35_0x41a453,_0x4de20c=Date[_0x35e5fe(0x15d)]();try{const _0xe370c5=_0x155945[_0x35e5fe(0x1af)],_0x1bcc26=_0xe370c5[_0x35e5fe(0x195)];if(!_0x1bcc26?.['webhookUrl']){console[_0x35e5fe(0x1c2)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0xe370c5['id']);return;}const _0x4aec47=_0x1f2a63===_0x35e5fe(0x1cc)?'payment.success':_0x1f2a63===_0x35e5fe(0x170)?'payment.failed':_0x1f2a63===_0x35e5fe(0x19e)?'payment.failed':_0x35e5fe(0x173);if(!_0x1bcc26[_0x35e5fe(0x193)]?.[_0x35e5fe(0x14d)](_0x4aec47)){console[_0x35e5fe(0x1c2)](_0x35e5fe(0x19f)+_0x4aec47+_0x35e5fe(0x1c1)+_0xe370c5['id']);return;}const _0x596d70={'event':_0x4aec47,'payment':{'id':_0x155945['id'],'order_id':_0x155945['orderId'],'gateway_order_id':_0x155945[_0x35e5fe(0x14a)],'gateway':_0x35e5fe(0x175),'amount':_0x155945[_0x35e5fe(0x190)],'currency':_0x155945[_0x35e5fe(0x140)],'status':_0x1f2a63[_0x35e5fe(0x1a5)](),'customer_email':_0x155945[_0x35e5fe(0x183)],'customer_name':_0x155945[_0x35e5fe(0x176)],'created_at':_0x155945[_0x35e5fe(0x17a)],'updated_at':new Date()}},_0x2efba2=await fetch(_0x1bcc26[_0x35e5fe(0x17e)],{'method':_0x35e5fe(0x199),'headers':{'Content-Type':_0x35e5fe(0x1ac),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x596d70)}),_0x210b45=Date[_0x35e5fe(0x15d)]()-_0x4de20c,_0x2a8e2d=_0x2efba2['ok']?_0x35e5fe(0x17f):await _0x2efba2['text']();loggerService_1[_0x35e5fe(0x16c)][_0x35e5fe(0x163)](_0x155945[_0x35e5fe(0x167)],_0x1bcc26['webhookUrl'],_0x4aec47,_0x2efba2[_0x35e5fe(0x191)],_0x210b45,_0x596d70),console['log'](_0x35e5fe(0x178)+_0x1bcc26[_0x35e5fe(0x17e)]+_0x35e5fe(0x1a4)+_0x2efba2[_0x35e5fe(0x191)]+'\x20('+_0x210b45+_0x35e5fe(0x159));}catch(_0x483ad7){console[_0x35e5fe(0x196)](_0x35e5fe(0x16e),_0x483ad7),loggerService_1[_0x35e5fe(0x16c)][_0x35e5fe(0x164)](_0x155945[_0x35e5fe(0x167)],_0x155945[_0x35e5fe(0x1af)]?.[_0x35e5fe(0x195)]?.[_0x35e5fe(0x17e)]||_0x35e5fe(0x172),_0x35e5fe(0x1bd),_0x483ad7,{});}}async[a35_0x41a453(0x1b2)](_0x51ee52,_0x121f37){const _0x5ef888=a35_0x41a453;try{const _0x3032e3={'PENDING':_0x5ef888(0x165),'PAID':_0x5ef888(0x1cb),'FAILED':_0x5ef888(0x149),'EXPIRED':'expired'},_0x494503=_0x3032e3[_0x121f37];if(!_0x494503||_0x494503===_0x5ef888(0x165))return;await telegramBotService_1[_0x5ef888(0x1ce)][_0x5ef888(0x141)](_0x51ee52[_0x5ef888(0x167)],_0x51ee52,_0x494503);}catch(_0x44353f){console[_0x5ef888(0x196)](_0x5ef888(0x1c9),_0x44353f);}}async[a35_0x41a453(0x1b4)](_0x2524d7){const _0x38876e=a35_0x41a453,_0x226838=await database_1[_0x38876e(0x1b9)]['payment']['findUnique']({'where':{'id':_0x2524d7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x226838)throw new Error(_0x38876e(0x1bc));if(_0x226838['gateway']!=='cointopay')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');await this[_0x38876e(0x1b1)](_0x226838);}[a35_0x41a453(0x19b)](){const _0x5abd50=a35_0x41a453,_0x2a6fe7=this[_0x5abd50(0x160)]?this[_0x5abd50(0x1c4)]:undefined;return{'isActive':!!this[_0x5abd50(0x160)],'checkIntervalMinutes':this[_0x5abd50(0x1c4)]/(0x3e8*0x3c),'expiryDays':this[_0x5abd50(0x14f)],'nextCheckIn':_0x2a6fe7};}}exports[a35_0x41a453(0x162)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();