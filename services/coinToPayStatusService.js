'use strict';const a35_0x121706=a35_0x7957;(function(_0x3c4813,_0x761d52){const _0x1e6b6f=a35_0x7957,_0x61a71=_0x3c4813();while(!![]){try{const _0x1789ac=parseInt(_0x1e6b6f(0x141))/0x1*(-parseInt(_0x1e6b6f(0x1a2))/0x2)+-parseInt(_0x1e6b6f(0x1a5))/0x3*(-parseInt(_0x1e6b6f(0x185))/0x4)+-parseInt(_0x1e6b6f(0x1ae))/0x5*(-parseInt(_0x1e6b6f(0x1a4))/0x6)+-parseInt(_0x1e6b6f(0x195))/0x7+-parseInt(_0x1e6b6f(0x148))/0x8+parseInt(_0x1e6b6f(0x163))/0x9*(-parseInt(_0x1e6b6f(0x164))/0xa)+parseInt(_0x1e6b6f(0x17c))/0xb;if(_0x1789ac===_0x761d52)break;else _0x61a71['push'](_0x61a71['shift']());}catch(_0x356ca9){_0x61a71['push'](_0x61a71['shift']());}}}(a35_0x31a2,0x56a64));function a35_0x31a2(){const _0x1f1996=['6qyinpN','PENDING','29184iXfBam','12kfJWDI','../config/database','shopId','failed','webhookUrl','\x20has\x20no\x20gatewayPaymentId,\x20skipping','loggerService','sendShopWebhook','remitterIban','265SsLtdI','amount','\x20days\x20without\x20payment\x20confirmation','\x20days\x20(created\x20before\x20','\x20details:','coinToPayService','Bank\x20Details:\x20','create','â°\x20Payment\x20','Payment\x20older\x20than\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20updated\x20successfully','payment.failed','startPeriodicStatusCheck','Automatically\x20expired\x20after\x20','not\x20confirmed','logWhiteDomainError','paid','CoinToPayService','\x20is\x20older\x20than\x20','Unknown\x20error','CoinToPayStatusService','created','payment','getTime','checkExpiredPayments','checkInterval','gatewayPaymentId','payment.pending','defineProperty','customerEmail','Shop\x20webhook\x20sent\x20to\x20','payment.success','CHECK_INTERVAL_MS','6153JDTzBx','Success','\x20marked\x20as\x20paid\x20at:\x20','cointopay_status_check_','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20status:\x20','1512648DRQapC','paidAt','iban','createdAt','adminNotes','setDate','sendPaymentStatusNotification','checkPaymentById','ðŸ“Š\x20Payment\x20','âœ…\x20Payment\x20','floor','stringify','unknown','EXPIRED','cointopay_auto_expired','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','cointopay_status_check_error','Payment\x20not\x20found','shop','logShopWebhookError','\x20not\x20enabled\x20for\x20shop\x20','log','status','gatewayOrderId','âš ï¸\x20Payment\x20','TesSoft\x20Payment\x20System/1.0','\x20days,\x20marking\x20as\x20EXPIRED','371907pqxnid','140bbcOJl','settings','ðŸ’°\x20Payment\x20','text','âœ…\x20Completed\x20checking\x20','includes','\x20days','push','sendPaymentNotification','\x20CoinToPay\x20payments','\x20to\x20','\x20status\x20from\x20','ðŸ”„\x20Updating\x20payment\x20','checkSinglePayment','\x20status\x20unchanged\x20(','transactionId','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','EXPIRY_DAYS','webhook_send','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','error','__esModule','\x20expired\x20CoinToPay\x20payments','__importDefault','13555069HxNzzE','Failed\x20to\x20check\x20payment\x20','Initial\x20CoinToPay\x20status\x20check\x20failed:','logShopWebhookSent','paymentDetails','now','webhookLog','gateway','ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped','276252rZnLuj','getServiceStats','ms)','./gateways/coinToPayService','âœ…\x20Transaction\x20confirmed\x20on:\x20','webhookEvents','currency','0100','toISOString','customerName','coinToPayStatusService','not\x20found','createdOn','stopPeriodicStatusCheck','ðŸ¦\x20Saved\x20IBAN:\x20','toLowerCase','4377415GEIrkH','cointopay','PAID','checkAllPendingPayments','default','update','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','confirmedOn','length','âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','ðŸª™\x20Checking\x20','FAILED','bankDetails'];a35_0x31a2=function(){return _0x1f1996;};return a35_0x31a2();}var __importDefault=this&&this[a35_0x121706(0x17b)]||function(_0x4f8fcb){const _0x44ac9b=a35_0x121706;return _0x4f8fcb&&_0x4f8fcb[_0x44ac9b(0x179)]?_0x4f8fcb:{'default':_0x4f8fcb};};Object[a35_0x121706(0x13c)](exports,a35_0x121706(0x179),{'value':!![]}),exports[a35_0x121706(0x18f)]=exports[a35_0x121706(0x1c3)]=void 0x0;const coinToPayService_1=require(a35_0x121706(0x188)),database_1=__importDefault(require(a35_0x121706(0x1a6))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService');function a35_0x7957(_0x57467a,_0x2b7367){const _0x31a24b=a35_0x31a2();return a35_0x7957=function(_0x79575,_0x165d90){_0x79575=_0x79575-0x139;let _0x40f803=_0x31a24b[_0x79575];return _0x40f803;},a35_0x7957(_0x57467a,_0x2b7367);}class CoinToPayStatusService{constructor(){const _0x468704=a35_0x121706;this[_0x468704(0x139)]=null,this[_0x468704(0x140)]=0x3c*0x3c*0x3e8,this[_0x468704(0x175)]=0x5,this[_0x468704(0x1b3)]=new coinToPayService_1[(_0x468704(0x1c0))]();}[a35_0x121706(0x1bb)](){const _0x3e87f5=a35_0x121706;console[_0x3e87f5(0x15d)](_0x3e87f5(0x174)),this[_0x3e87f5(0x198)]()['catch'](_0x3ea3c3=>{const _0x525417=_0x3e87f5;console['error'](_0x525417(0x17e),_0x3ea3c3);}),this[_0x3e87f5(0x139)]=setInterval(async()=>{const _0x336af5=_0x3e87f5;try{await this[_0x336af5(0x198)]();}catch(_0x3ee13f){console['error']('Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x3ee13f);}},this['CHECK_INTERVAL_MS']),console[_0x3e87f5(0x15d)](_0x3e87f5(0x19e));}[a35_0x121706(0x192)](){const _0x4f9a25=a35_0x121706;this['checkInterval']&&(clearInterval(this[_0x4f9a25(0x139)]),this['checkInterval']=null,console[_0x4f9a25(0x15d)](_0x4f9a25(0x184)));}async[a35_0x121706(0x198)](){const _0xd0d34=a35_0x121706;try{const _0x7f25ac=await database_1[_0xd0d34(0x199)][_0xd0d34(0x1c5)]['findMany']({'where':{'gateway':_0xd0d34(0x196),'status':_0xd0d34(0x1a3),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x7f25ac[_0xd0d34(0x19d)]===0x0){console['log']('ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}console[_0xd0d34(0x15d)](_0xd0d34(0x19f)+_0x7f25ac[_0xd0d34(0x19d)]+'\x20pending\x20CoinToPay\x20payments');const _0x46fb09=await this[_0xd0d34(0x1c7)](_0x7f25ac);console['log']('â°\x20Found\x20'+_0x46fb09['length']+_0xd0d34(0x17a));for(const _0x3e64a9 of _0x7f25ac){try{if(_0x46fb09[_0xd0d34(0x169)](_0x3e64a9['id'])){console[_0xd0d34(0x15d)](_0xd0d34(0x1b6)+_0x3e64a9['id']+_0xd0d34(0x145));continue;}await this[_0xd0d34(0x171)](_0x3e64a9),await new Promise(_0x17be3c=>setTimeout(_0x17be3c,0x7d0));}catch(_0x36144e){console['error'](_0xd0d34(0x177)+_0x3e64a9['id']+':',_0x36144e),loggerService_1[_0xd0d34(0x1ab)][_0xd0d34(0x1be)](_0xd0d34(0x196),'/status/'+_0x3e64a9[_0xd0d34(0x13a)],_0x36144e);}}console['log'](_0xd0d34(0x168)+_0x7f25ac[_0xd0d34(0x19d)]+_0xd0d34(0x16d));}catch(_0x202f71){console['error']('Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x202f71);}}async[a35_0x121706(0x1c7)](_0x39a239){const _0xb3825d=a35_0x121706,_0x51776f=[],_0x1cacd3=new Date();_0x1cacd3[_0xb3825d(0x14d)](_0x1cacd3['getDate']()-this[_0xb3825d(0x175)]),console[_0xb3825d(0x15d)](_0xb3825d(0x146)+this['EXPIRY_DAYS']+_0xb3825d(0x1b1)+_0x1cacd3[_0xb3825d(0x18d)]()+')');for(const _0x48e447 of _0x39a239){if(_0x48e447[_0xb3825d(0x14b)]<_0x1cacd3){console[_0xb3825d(0x15d)](_0xb3825d(0x1b6)+_0x48e447['id']+_0xb3825d(0x1c1)+this[_0xb3825d(0x175)]+_0xb3825d(0x162));try{await database_1['default'][_0xb3825d(0x1c5)][_0xb3825d(0x19a)]({'where':{'id':_0x48e447['id']},'data':{'status':_0xb3825d(0x155),'updatedAt':new Date(),'adminNotes':_0xb3825d(0x1bc)+this['EXPIRY_DAYS']+_0xb3825d(0x1b0)}}),await database_1['default'][_0xb3825d(0x182)][_0xb3825d(0x1b5)]({'data':{'paymentId':_0x48e447['id'],'shopId':_0x48e447[_0xb3825d(0x1a7)],'event':_0xb3825d(0x156),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0xb3825d(0x1b7)+this[_0xb3825d(0x175)]+_0xb3825d(0x16a),'createdAt':_0x48e447[_0xb3825d(0x14b)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0xb3825d(0x152)]((Date[_0xb3825d(0x181)]()-_0x48e447[_0xb3825d(0x14b)][_0xb3825d(0x1c6)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x48e447,_0xb3825d(0x155)),await this['sendPaymentStatusNotification'](_0x48e447,_0xb3825d(0x155)),_0x51776f[_0xb3825d(0x16b)](_0x48e447['id']),console[_0xb3825d(0x15d)]('âœ…\x20Payment\x20'+_0x48e447['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0xb3825d(0x175)]+'-day\x20timeout');}catch(_0x3014c1){console[_0xb3825d(0x178)]('Failed\x20to\x20expire\x20payment\x20'+_0x48e447['id']+':',_0x3014c1);}}}return _0x51776f;}async[a35_0x121706(0x171)](_0x43c445){const _0x5d7b32=a35_0x121706;if(!_0x43c445[_0x5d7b32(0x13a)]){console['log'](_0x5d7b32(0x160)+_0x43c445['id']+_0x5d7b32(0x1aa));return;}console['log']('ðŸ”\x20Checking\x20CoinToPay\x20payment\x20'+_0x43c445['id']+'\x20('+_0x43c445[_0x5d7b32(0x13a)]+')');try{const _0xc69374=await this[_0x5d7b32(0x1b3)]['checkPaymentStatus'](_0x43c445[_0x5d7b32(0x13a)]);console[_0x5d7b32(0x15d)](_0x5d7b32(0x150)+_0x43c445['id']+_0x5d7b32(0x147)+_0xc69374[_0x5d7b32(0x15e)]);_0xc69374['paymentDetails']&&console[_0x5d7b32(0x15d)](_0x5d7b32(0x150)+_0x43c445['id']+_0x5d7b32(0x1b2),{'iban':_0xc69374[_0x5d7b32(0x180)]['iban']||_0x5d7b32(0x190),'transactionId':_0xc69374['paymentDetails'][_0x5d7b32(0x173)],'createdOn':_0xc69374[_0x5d7b32(0x180)][_0x5d7b32(0x191)],'confirmedOn':_0xc69374[_0x5d7b32(0x180)][_0x5d7b32(0x19c)]||_0x5d7b32(0x1bd)});if(_0xc69374[_0x5d7b32(0x15e)]!==_0x43c445[_0x5d7b32(0x15e)]){console[_0x5d7b32(0x15d)](_0x5d7b32(0x170)+_0x43c445['id']+_0x5d7b32(0x16f)+_0x43c445['status']+_0x5d7b32(0x16e)+_0xc69374[_0x5d7b32(0x15e)]);const _0x44ce06={'status':_0xc69374[_0x5d7b32(0x15e)],'updatedAt':new Date()};_0xc69374[_0x5d7b32(0x15e)]===_0x5d7b32(0x197)&&_0x43c445[_0x5d7b32(0x15e)]!==_0x5d7b32(0x197)&&(_0x44ce06[_0x5d7b32(0x149)]=new Date(),console[_0x5d7b32(0x15d)](_0x5d7b32(0x166)+_0x43c445['id']+_0x5d7b32(0x143)+_0x44ce06[_0x5d7b32(0x149)][_0x5d7b32(0x18d)]()));if(_0xc69374[_0x5d7b32(0x180)]){const _0x7b5c27=_0xc69374[_0x5d7b32(0x180)];_0x7b5c27[_0x5d7b32(0x14a)]&&(_0x44ce06[_0x5d7b32(0x1ad)]=_0x7b5c27[_0x5d7b32(0x14a)],console['log'](_0x5d7b32(0x193)+_0x7b5c27['iban']));if(_0x7b5c27['bankDetails']){const _0x5ae28c=_0x43c445[_0x5d7b32(0x14c)]||'',_0x84555c=_0x5d7b32(0x1b4)+_0x7b5c27[_0x5d7b32(0x1a1)];_0x44ce06[_0x5d7b32(0x14c)]=_0x5ae28c?_0x5ae28c+'\x0a\x0a'+_0x84555c:_0x84555c,console[_0x5d7b32(0x15d)]('ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x7b5c27['transactionId']&&console['log']('ðŸ†”\x20Transaction\x20ID:\x20'+_0x7b5c27[_0x5d7b32(0x173)]),_0x7b5c27['confirmedOn']&&console[_0x5d7b32(0x15d)](_0x5d7b32(0x189)+_0x7b5c27[_0x5d7b32(0x19c)]);}await database_1['default'][_0x5d7b32(0x1c5)][_0x5d7b32(0x19a)]({'where':{'id':_0x43c445['id']},'data':_0x44ce06}),await database_1[_0x5d7b32(0x199)][_0x5d7b32(0x182)]['create']({'data':{'paymentId':_0x43c445['id'],'shopId':_0x43c445[_0x5d7b32(0x1a7)],'event':_0x5d7b32(0x144)+_0xc69374[_0x5d7b32(0x15e)][_0x5d7b32(0x194)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x43c445['status'],'newStatus':_0xc69374[_0x5d7b32(0x15e)],'paymentDetails':_0xc69374[_0x5d7b32(0x180)],'checkedAt':new Date()[_0x5d7b32(0x18d)]()})}}),await this['sendShopWebhook'](_0x43c445,_0xc69374['status']),await this['sendPaymentStatusNotification'](_0x43c445,_0xc69374['status']),console[_0x5d7b32(0x15d)](_0x5d7b32(0x151)+_0x43c445['id']+_0x5d7b32(0x1b9));}else console[_0x5d7b32(0x15d)](_0x5d7b32(0x150)+_0x43c445['id']+_0x5d7b32(0x172)+_0xc69374['status']+')');}catch(_0x2cad5e){console[_0x5d7b32(0x178)](_0x5d7b32(0x17d)+_0x43c445['id']+':',_0x2cad5e),await database_1[_0x5d7b32(0x199)][_0x5d7b32(0x182)][_0x5d7b32(0x1b5)]({'data':{'paymentId':_0x43c445['id'],'shopId':_0x43c445[_0x5d7b32(0x1a7)],'event':_0x5d7b32(0x158),'statusCode':0x1f4,'responseBody':JSON[_0x5d7b32(0x153)]({'error':_0x2cad5e instanceof Error?_0x2cad5e['message']:_0x5d7b32(0x1c2),'gatewayPaymentId':_0x43c445[_0x5d7b32(0x13a)],'checkedAt':new Date()[_0x5d7b32(0x18d)]()})}});}}async[a35_0x121706(0x1ac)](_0x2e76da,_0x574fae){const _0x2d3bce=a35_0x121706,_0x372a43=Date['now']();try{const _0x5a6b9b=_0x2e76da[_0x2d3bce(0x15a)],_0x187be3=_0x5a6b9b[_0x2d3bce(0x165)];if(!_0x187be3?.['webhookUrl']){console['log'](_0x2d3bce(0x157)+_0x5a6b9b['id']);return;}const _0x22f4ec=_0x574fae==='PAID'?_0x2d3bce(0x13f):_0x574fae===_0x2d3bce(0x1a0)?_0x2d3bce(0x1ba):_0x574fae==='EXPIRED'?_0x2d3bce(0x1ba):_0x2d3bce(0x13b);if(!_0x187be3[_0x2d3bce(0x18a)]?.[_0x2d3bce(0x169)](_0x22f4ec)){console[_0x2d3bce(0x15d)]('Webhook\x20event\x20'+_0x22f4ec+_0x2d3bce(0x15c)+_0x5a6b9b['id']);return;}const _0x5293d0={'event':_0x22f4ec,'payment':{'id':_0x2e76da['id'],'order_id':_0x2e76da['orderId'],'gateway_order_id':_0x2e76da[_0x2d3bce(0x15f)],'gateway':_0x2d3bce(0x18c),'amount':_0x2e76da[_0x2d3bce(0x1af)],'currency':_0x2e76da[_0x2d3bce(0x18b)],'status':_0x574fae[_0x2d3bce(0x194)](),'customer_email':_0x2e76da[_0x2d3bce(0x13d)],'customer_name':_0x2e76da[_0x2d3bce(0x18e)],'created_at':_0x2e76da[_0x2d3bce(0x14b)],'updated_at':new Date()}},_0x5b57a6=await fetch(_0x187be3[_0x2d3bce(0x1a9)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x2d3bce(0x161)},'body':JSON[_0x2d3bce(0x153)](_0x5293d0)}),_0x5211c9=Date['now']()-_0x372a43,_0x4fcb48=_0x5b57a6['ok']?_0x2d3bce(0x142):await _0x5b57a6[_0x2d3bce(0x167)]();loggerService_1['loggerService'][_0x2d3bce(0x17f)](_0x2e76da[_0x2d3bce(0x1a7)],_0x187be3[_0x2d3bce(0x1a9)],_0x22f4ec,_0x5b57a6[_0x2d3bce(0x15e)],_0x5211c9,_0x5293d0),console[_0x2d3bce(0x15d)](_0x2d3bce(0x13e)+_0x187be3[_0x2d3bce(0x1a9)]+'\x20with\x20status\x20'+_0x5b57a6['status']+'\x20('+_0x5211c9+_0x2d3bce(0x187));}catch(_0x9c5e59){console[_0x2d3bce(0x178)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x9c5e59),loggerService_1['loggerService'][_0x2d3bce(0x15b)](_0x2e76da[_0x2d3bce(0x1a7)],_0x2e76da[_0x2d3bce(0x15a)]?.[_0x2d3bce(0x165)]?.[_0x2d3bce(0x1a9)]||_0x2d3bce(0x154),_0x2d3bce(0x176),_0x9c5e59,{});}}async[a35_0x121706(0x14e)](_0x11f41e,_0x459fe3){const _0x54039a=a35_0x121706;try{const _0x176db6={'PENDING':_0x54039a(0x1c4),'PAID':_0x54039a(0x1bf),'FAILED':_0x54039a(0x1a8),'EXPIRED':'expired'},_0x1bf7a1=_0x176db6[_0x459fe3];if(!_0x1bf7a1||_0x1bf7a1===_0x54039a(0x1c4))return;await telegramBotService_1['telegramBotService'][_0x54039a(0x16c)](_0x11f41e[_0x54039a(0x1a7)],_0x11f41e,_0x1bf7a1);}catch(_0x1bc93d){console[_0x54039a(0x178)](_0x54039a(0x1b8),_0x1bc93d);}}async[a35_0x121706(0x14f)](_0x758c2f){const _0x41e78b=a35_0x121706,_0x17aa12=await database_1['default'][_0x41e78b(0x1c5)]['findUnique']({'where':{'id':_0x758c2f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x17aa12)throw new Error(_0x41e78b(0x159));if(_0x17aa12[_0x41e78b(0x183)]!==_0x41e78b(0x196))throw new Error(_0x41e78b(0x19b));await this[_0x41e78b(0x171)](_0x17aa12);}[a35_0x121706(0x186)](){const _0x20cc0f=a35_0x121706,_0x29e35d=this['checkInterval']?this['CHECK_INTERVAL_MS']:undefined;return{'isActive':!!this[_0x20cc0f(0x139)],'checkIntervalMinutes':this[_0x20cc0f(0x140)]/(0x3e8*0x3c),'expiryDays':this[_0x20cc0f(0x175)],'nextCheckIn':_0x29e35d};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a35_0x121706(0x18f)]=new CoinToPayStatusService();