'use strict';const a37_0x4a0c10=a37_0x5754;(function(_0x2e4396,_0x1383f0){const _0x54018b=a37_0x5754,_0x2b5599=_0x2e4396();while(!![]){try{const _0x125ed4=parseInt(_0x54018b(0x18a))/0x1+parseInt(_0x54018b(0x196))/0x2+-parseInt(_0x54018b(0x154))/0x3+-parseInt(_0x54018b(0xe0))/0x4*(parseInt(_0x54018b(0x17d))/0x5)+-parseInt(_0x54018b(0x139))/0x6+parseInt(_0x54018b(0x15a))/0x7*(-parseInt(_0x54018b(0x190))/0x8)+parseInt(_0x54018b(0x12d))/0x9*(parseInt(_0x54018b(0x155))/0xa);if(_0x125ed4===_0x1383f0)break;else _0x2b5599['push'](_0x2b5599['shift']());}catch(_0x491ec7){_0x2b5599['push'](_0x2b5599['shift']());}}}(a37_0x291a,0x91579));function a37_0x291a(){const _0x3aeb04=['\x20individual\x20payment\x20timers','-day\x20timeout','\x20\x20\x20📊\x20Status:\x20','update','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','✅\x20[CHECK]\x20Payment\x20','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','adminNotes','payment.pending','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','logShopWebhookSent','⏰\x20[GLOBAL]\x20Found\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20found:','paid','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','coinToPayService','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20\x20\x20📍\x20Source:\x20','findMany','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','1233470nePNyW','timestamp','forEach','\x20\x20\x20📅\x20Time:\x20','has','default','payment.success','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','\x20triggered\x20for\x20payment\x20','❌\x20[CHECK]\x20Payment\x20','webhook_send','stopPeriodicStatusCheck','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','705723piriBm','/status/','🧹\x20[CHECK]\x20Payment\x20','📊\x20[CHECK]\x20Payment\x20','.\x20Remaining\x20active\x20timers:\x20','../config/database','16504LMLvSA','checkExpiredPayments','❌\x20[HOURLY]\x20Payment\x20','🪙\x20CoinToPayStatusService\x20initialized','loggerService','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','2298456xafLEn','bankDetails','payment','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','shop','stack','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','status','delay','log','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20not\x20found\x20in\x20database','checkPaymentById','\x20seconds\x20(','\x20days,\x20marking\x20as\x20EXPIRED','application/json','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','toISOString','\x20\x20\x20📝\x20Details:','sendShopWebhook','not\x20found','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20days\x20without\x20payment\x20confirmation','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','schedulePaymentChecks','FAILED','confirmedOn','sendPaymentNotification','set','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','Unknown\x20error','Failed\x20to\x20mark\x20payment\x20as\x20expired','🪙\x20[DEBUG]\x20Creating\x20',',\x20clearing\x20individual\x20timers','\x20checked,\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','error','settings','COINTOPAY_STATUS_CHANGE','\x20(after\x20','paidAt','\x20status\x20from\x20','5\x20minutes','cointopay','text','CoinToPayStatusService','\x20\x20\x20-\x20Amount:\x20','\x20timers\x20for\x20payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','4EeSXIT','remitterIban','push','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20days','\x20\x20\x20❌\x20Error:\x20','checkAllPendingPayments','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','ms)','now','sendPaymentStatusNotification','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','__importDefault','Automatically\x20expired\x20after\x20','TesSoft\x20Payment\x20System/1.0','customerName','getDate','\x20status\x20is\x20','💰\x20[CHECK]\x20Payment\x20','includes','description','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','Payment\x20not\x20found','\x20in\x20','\x20status:\x20','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','findUnique','defineProperty','\x20for\x20payment\x20','webhookUrl','\x20is\x20valid\x20for\x20checking,\x20proceeding...','created','coinToPayStatusService','auto_expire','🔄\x20[CHECK]\x20Updating\x20payment\x20','status_check','__esModule','✅\x20[EXPIRY]\x20Payment\x20','map','\x20\x20\x20-\x20gatewayPaymentId:\x20','catch','getServiceStats','message','\x20expired\x20CoinToPay\x20payments','\x20\x20\x20-\x20Gateway:\x20','checkSinglePaymentById','not\x20confirmed','🪙\x20[GLOBAL]\x20Found\x20','\x20completed\x20for\x20payment\x20','EXPIRED','EXPIRY_DAYS','⚠️\x20[CHECK]\x20Payment\x20','PENDING','toLowerCase','createdAt','✅\x20[HOURLY]\x20Payment\x20','\x20\x20\x20📝\x20Context:','cointopay_status_check_','./gateways/coinToPayService','globalCheckInterval','expired','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','currency','clearPaymentTimers','timers','Success','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','checkSinglePayment','\x20pending\x20CoinToPay\x20payments','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','logShopWebhookError',',\x20stopping\x20individual\x20checks','stringify','amount','unknown','values','\x20->\x20','144IYREkj','gatewayPaymentId','telegramBotService','\x20has\x20no\x20gatewayPaymentId','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','size','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','COINTOPAY_ERROR','\x20not\x20found,\x20clearing\x20timers','toFixed','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','5192370XsZIQE','paymentTimers','\x20not\x20enabled\x20for\x20shop\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','2\x20minutes','\x20\x20\x20-\x20Status:\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','iban','customerEmail','gateway','PAID','./telegramBotService','logCoinToPayError','payment.failed','⏰\x20[HOURLY]\x20Payment\x20','\x20is\x20older\x20than\x20','startPeriodicStatusCheck','\x20has\x20no\x20gatewayPaymentId,\x20skipping','delete','Payment\x20older\x20than\x20','webhookEvents','failed','shopId','create','paymentDetails','setDate','gatewayOrderId','482835wMeNOo','415820lGFsdQ','GLOBAL_CHECK_INTERVAL_MS','transactionId','\x20to\x20','CoinToPayService','2212aBuyLH','Webhook\x20event\x20','webhookLog','logCoinToPayStatus','get','⏰\x20[GLOBAL]\x20Payment\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','logWhiteDomainError','getTime','floor','\x20\x20\x20-\x20paymentId:\x20','createdOn','length'];a37_0x291a=function(){return _0x3aeb04;};return a37_0x291a();}var __importDefault=this&&this[a37_0x4a0c10(0xec)]||function(_0x3bf008){const _0x4225ac=a37_0x4a0c10;return _0x3bf008&&_0x3bf008[_0x4225ac(0x104)]?_0x3bf008:{'default':_0x3bf008};};Object[a37_0x4a0c10(0xfb)](exports,a37_0x4a0c10(0x104),{'value':!![]}),exports[a37_0x4a0c10(0x100)]=exports[a37_0x4a0c10(0xdc)]=void 0x0;function a37_0x5754(_0x34e47b,_0x29e433){const _0x291af8=a37_0x291a();return a37_0x5754=function(_0x5754c4,_0x15a5c7){_0x5754c4=_0x5754c4-0xc8;let _0x20e6d8=_0x291af8[_0x5754c4];return _0x20e6d8;},a37_0x5754(_0x34e47b,_0x29e433);}const coinToPayService_1=require(a37_0x4a0c10(0x11a)),database_1=__importDefault(require(a37_0x4a0c10(0x18f))),telegramBotService_1=require(a37_0x4a0c10(0x144)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x49ed2e=a37_0x4a0c10;this[_0x49ed2e(0x11b)]=null,this[_0x49ed2e(0x156)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x49ed2e(0x13a)]=new Map(),this[_0x49ed2e(0x178)]=new coinToPayService_1[(_0x49ed2e(0x159))](),console[_0x49ed2e(0x19f)](_0x49ed2e(0x193));}[a37_0x4a0c10(0x1b1)](_0xa12713,_0x22a55e){const _0x338ee2=a37_0x4a0c10;console[_0x338ee2(0x19f)](_0x338ee2(0xf9)),console[_0x338ee2(0x19f)](_0x338ee2(0x164)+_0xa12713),console[_0x338ee2(0x19f)](_0x338ee2(0x107)+_0x22a55e),this[_0x338ee2(0x11f)](_0xa12713);const _0x359224=[],_0x1311b5=new Date(),_0x1054a0=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x338ee2(0x13d)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x338ee2(0xd9)}];console['log'](_0x338ee2(0xcf)+_0x1054a0[_0x338ee2(0x166)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0xa12713);let _0xf1e7b7=0x0;_0x1054a0[_0x338ee2(0x17f)]((_0x91165,_0x35df92)=>{const _0x5153c8=_0x338ee2;_0xf1e7b7+=_0x91165[_0x5153c8(0x19e)];const _0x4276ff=setTimeout(async()=>{const _0x5cc2ae=_0x5153c8;console[_0x5cc2ae(0x19f)](_0x5cc2ae(0x177)+(_0x35df92+0x1)+_0x5cc2ae(0x185)+_0xa12713+_0x5cc2ae(0xd6)+_0x91165[_0x5cc2ae(0xf4)]+')');try{await this['checkSinglePaymentById'](_0xa12713),console['log']('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x35df92+0x1)+_0x5cc2ae(0x110)+_0xa12713);}catch(_0x139b06){console['error'](_0x5cc2ae(0xeb)+(_0x35df92+0x1)+_0x5cc2ae(0xfc)+_0xa12713+':',_0x139b06),this[_0x5cc2ae(0x145)](_0xa12713,_0x22a55e,_0x139b06,_0x5cc2ae(0x103),{'checkNumber':_0x35df92+0x1,'scheduledAfter':_0x91165[_0x5cc2ae(0xf4)],'isIndividualCheck':!![]});}},_0xf1e7b7);_0x359224[_0x5153c8(0xe2)](_0x4276ff),console['log']('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x35df92+0x1)+_0x5153c8(0xfc)+_0xa12713+_0x5153c8(0xf7)+_0xf1e7b7/0x3e8+_0x5153c8(0x1a3)+_0x91165['description']+')');});const _0x4a102e=setInterval(async()=>{const _0x4d47f8=_0x338ee2;console[_0x4d47f8(0x19f)]('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0xa12713);try{const _0x1aada9=await database_1[_0x4d47f8(0x182)][_0x4d47f8(0x198)][_0x4d47f8(0xfa)]({'where':{'id':_0xa12713},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x1aada9){console[_0x4d47f8(0x19f)](_0x4d47f8(0x192)+_0xa12713+_0x4d47f8(0x135)),this[_0x4d47f8(0x11f)](_0xa12713);return;}console['log']('📊\x20[HOURLY]\x20Payment\x20'+_0xa12713+'\x20current\x20status:\x20'+_0x1aada9[_0x4d47f8(0x19d)]);if(_0x1aada9['status']!==_0x4d47f8(0x114)){console['log'](_0x4d47f8(0x117)+_0xa12713+_0x4d47f8(0xf1)+_0x1aada9[_0x4d47f8(0x19d)]+_0x4d47f8(0x127)),this[_0x4d47f8(0x11f)](_0xa12713);return;}const _0xf89b2d=Math[_0x4d47f8(0x163)]((Date[_0x4d47f8(0xe9)]()-_0x1aada9[_0x4d47f8(0x116)][_0x4d47f8(0x162)]())/(0x3e8*0x3c*0x3c*0x18));if(_0xf89b2d>=this['EXPIRY_DAYS']){console[_0x4d47f8(0x19f)](_0x4d47f8(0x147)+_0xa12713+_0x4d47f8(0x148)+this[_0x4d47f8(0x112)]+_0x4d47f8(0x1a7)),this['clearPaymentTimers'](_0xa12713);return;}await this[_0x4d47f8(0x10d)](_0xa12713),console['log'](_0x4d47f8(0xe7)+_0xa12713);}catch(_0x357737){console['error']('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0xa12713+':',_0x357737),this[_0x4d47f8(0x145)](_0xa12713,_0x22a55e,_0x357737,_0x4d47f8(0x103),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x359224[_0x338ee2(0xe2)](_0x4a102e),this[_0x338ee2(0x13a)][_0x338ee2(0xcb)](_0xa12713,{'timers':_0x359224,'paymentId':_0xa12713,'gatewayPaymentId':_0x22a55e,'createdAt':_0x1311b5}),console[_0x338ee2(0x19f)](_0x338ee2(0x176)+_0x1054a0[_0x338ee2(0x166)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0xa12713),console[_0x338ee2(0x19f)](_0x338ee2(0x131)+this[_0x338ee2(0x13a)][_0x338ee2(0x132)]),this['logCoinToPayStatus'](_0xa12713,_0x22a55e,_0x338ee2(0x114),'PENDING',_0x338ee2(0x103),{'action':'schedule_created','scheduledChecks':_0x1054a0['length'],'firstCheckIn':_0x1054a0[0x0][_0x338ee2(0x19e)]/0x3e8,'totalTimers':this[_0x338ee2(0x13a)][_0x338ee2(0x132)]});}[a37_0x4a0c10(0x11f)](_0x1fe9d6){const _0x56d297=a37_0x4a0c10,_0x356797=this[_0x56d297(0x13a)][_0x56d297(0x15e)](_0x1fe9d6);_0x356797?(console[_0x56d297(0x19f)]('🧹\x20[DEBUG]\x20Clearing\x20'+_0x356797[_0x56d297(0x120)][_0x56d297(0x166)]+_0x56d297(0xde)+_0x1fe9d6),_0x356797[_0x56d297(0x120)][_0x56d297(0x17f)]((_0x388e55,_0x18cb9a)=>{const _0x2526f5=_0x56d297;_0x388e55&&(clearTimeout(_0x388e55),clearInterval(_0x388e55),console[_0x2526f5(0x19f)](_0x2526f5(0x1a0)+(_0x18cb9a+0x1)+_0x2526f5(0xfc)+_0x1fe9d6));}),this['paymentTimers'][_0x56d297(0x14b)](_0x1fe9d6),console['log'](_0x56d297(0x16b)+_0x1fe9d6+_0x56d297(0x18e)+this[_0x56d297(0x13a)]['size'])):console['log'](_0x56d297(0x1ad)+_0x1fe9d6+'\x20to\x20clear');}async[a37_0x4a0c10(0x10d)](_0x29273d){const _0x4260c9=a37_0x4a0c10;console[_0x4260c9(0x19f)](_0x4260c9(0x1ac)+_0x29273d);const _0x23b0ed=await database_1[_0x4260c9(0x182)][_0x4260c9(0x198)][_0x4260c9(0xfa)]({'where':{'id':_0x29273d},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x23b0ed){console[_0x4260c9(0x19f)](_0x4260c9(0x186)+_0x29273d+_0x4260c9(0x1a1));return;}console[_0x4260c9(0x19f)](_0x4260c9(0x18d)+_0x29273d+_0x4260c9(0x174)),console[_0x4260c9(0x19f)](_0x4260c9(0x10c)+_0x23b0ed['gateway']),console['log'](_0x4260c9(0x13e)+_0x23b0ed[_0x4260c9(0x19d)]),console[_0x4260c9(0x19f)](_0x4260c9(0x1a6)+_0x23b0ed[_0x4260c9(0x12e)]),console[_0x4260c9(0x19f)](_0x4260c9(0xdd)+_0x23b0ed[_0x4260c9(0x129)]+'\x20'+_0x23b0ed['currency']),console[_0x4260c9(0x19f)]('\x20\x20\x20-\x20ShopId:\x20'+_0x23b0ed[_0x4260c9(0x14f)]);if(_0x23b0ed[_0x4260c9(0x142)]!==_0x4260c9(0xda)){console[_0x4260c9(0x19f)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x29273d+_0x4260c9(0x199)+_0x23b0ed[_0x4260c9(0x142)]+')');return;}if(_0x23b0ed['status']!==_0x4260c9(0x114)){console[_0x4260c9(0x19f)](_0x4260c9(0x113)+_0x29273d+_0x4260c9(0xf1)+_0x23b0ed[_0x4260c9(0x19d)]+_0x4260c9(0x127)),this['clearPaymentTimers'](_0x29273d);return;}if(!_0x23b0ed[_0x4260c9(0x12e)]){console[_0x4260c9(0x19f)](_0x4260c9(0x113)+_0x29273d+_0x4260c9(0x130));return;}console['log'](_0x4260c9(0x16c)+_0x29273d+_0x4260c9(0xfe)),await this[_0x4260c9(0x123)](_0x23b0ed);}['logCoinToPayStatus'](_0x419550,_0x3835d5,_0x4b6942,_0x12eb42,_0x22361d,_0x5d17de){const _0x4aaedb=a37_0x4a0c10,_0x5e7348={'type':_0x4aaedb(0xd5),'paymentId':_0x419550,'gatewayPaymentId':_0x3835d5,'oldStatus':_0x4b6942,'newStatus':_0x12eb42,'source':_0x22361d,'timestamp':new Date()[_0x4aaedb(0x1a8)](),'details':_0x5d17de||{}};loggerService_1[_0x4aaedb(0x194)][_0x4aaedb(0x15d)](_0x5e7348),console[_0x4aaedb(0x19f)](_0x4aaedb(0x170)+_0x419550+'\x20('+_0x3835d5+')'),console['log'](_0x4aaedb(0x169)+_0x4b6942+_0x4aaedb(0x12c)+_0x12eb42),console[_0x4aaedb(0x19f)](_0x4aaedb(0x17a)+_0x22361d),console[_0x4aaedb(0x19f)]('\x20\x20\x20📅\x20Time:\x20'+_0x5e7348[_0x4aaedb(0x17e)]),_0x5d17de&&console['log'](_0x4aaedb(0x1a9),_0x5d17de);}['logCoinToPayError'](_0xd0134e,_0x551734,_0x3701f7,_0x33e4bd,_0x237a62){const _0x157a6b=a37_0x4a0c10,_0x5e7895={'type':_0x157a6b(0x134),'paymentId':_0xd0134e,'gatewayPaymentId':_0x551734,'error':_0x3701f7 instanceof Error?{'message':_0x3701f7[_0x157a6b(0x10a)],'stack':_0x3701f7[_0x157a6b(0x19b)]}:_0x3701f7,'source':_0x33e4bd,'timestamp':new Date()['toISOString'](),'context':_0x237a62||{}};loggerService_1['loggerService'][_0x157a6b(0x145)](_0x5e7895),console[_0x157a6b(0xd3)](_0x157a6b(0x19c)+_0xd0134e+'\x20('+_0x551734+')'),console[_0x157a6b(0xd3)](_0x157a6b(0xe5)+(_0x3701f7 instanceof Error?_0x3701f7['message']:_0x3701f7)),console[_0x157a6b(0xd3)](_0x157a6b(0x17a)+_0x33e4bd),console[_0x157a6b(0xd3)](_0x157a6b(0x180)+_0x5e7895[_0x157a6b(0x17e)]),_0x237a62&&console[_0x157a6b(0xd3)](_0x157a6b(0x118),_0x237a62);}[a37_0x4a0c10(0x149)](){const _0x13e06d=a37_0x4a0c10;console[_0x13e06d(0x19f)](_0x13e06d(0x189)),this[_0x13e06d(0xe6)]()[_0x13e06d(0x108)](_0x12d7ff=>{const _0x3aa85c=_0x13e06d;console['error'](_0x3aa85c(0x13c),_0x12d7ff);}),this[_0x13e06d(0x11b)]=setInterval(async()=>{const _0x4ec138=_0x13e06d;try{console[_0x4ec138(0x19f)](_0x4ec138(0x137)),await this[_0x4ec138(0xe6)](),console[_0x4ec138(0x19f)](_0x4ec138(0x179));}catch(_0x23cc51){console[_0x4ec138(0xd3)]('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x23cc51);}},this[_0x13e06d(0x156)]),console['log'](_0x13e06d(0x17c));}[a37_0x4a0c10(0x188)](){const _0x5231bf=a37_0x4a0c10;console['log']('🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this['globalCheckInterval']&&(clearInterval(this[_0x5231bf(0x11b)]),this['globalCheckInterval']=null,console[_0x5231bf(0x19f)](_0x5231bf(0x133)));const _0x5ec33e=this[_0x5231bf(0x13a)]['size'];for(const [_0x10e544]of this[_0x5231bf(0x13a)]){this['clearPaymentTimers'](_0x10e544);}console['log']('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x5ec33e+_0x5231bf(0x167));}async['checkAllPendingPayments'](){const _0x264dc6=a37_0x4a0c10;try{console[_0x264dc6(0x19f)](_0x264dc6(0x125));const _0x3af9d1=await database_1[_0x264dc6(0x182)][_0x264dc6(0x198)][_0x264dc6(0x17b)]({'where':{'gateway':'cointopay','status':_0x264dc6(0x114),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x264dc6(0x19f)](_0x264dc6(0x10f)+_0x3af9d1[_0x264dc6(0x166)]+_0x264dc6(0x124));if(_0x3af9d1[_0x264dc6(0x166)]===0x0){console['log'](_0x264dc6(0x160));return;}const _0x52eedd=await this[_0x264dc6(0x191)](_0x3af9d1);console[_0x264dc6(0x19f)](_0x264dc6(0x172)+_0x52eedd[_0x264dc6(0x166)]+_0x264dc6(0x10b));let _0x145769=0x0,_0xc64d1c=0x0;for(const _0x3c66dc of _0x3af9d1){try{if(_0x52eedd[_0x264dc6(0xf3)](_0x3c66dc['id'])){console[_0x264dc6(0x19f)](_0x264dc6(0x15f)+_0x3c66dc['id']+_0x264dc6(0xe3)),_0xc64d1c++;continue;}if(this[_0x264dc6(0x13a)][_0x264dc6(0x181)](_0x3c66dc['id'])){console['log']('⏰\x20[GLOBAL]\x20Payment\x20'+_0x3c66dc['id']+_0x264dc6(0xcc)),_0xc64d1c++;continue;}const _0x472867=(Date[_0x264dc6(0xe9)]()-_0x3c66dc['createdAt'][_0x264dc6(0x162)]())/(0x3e8*0x3c*0x3c);if(_0x472867<0x1){console[_0x264dc6(0x19f)](_0x264dc6(0x15f)+_0x3c66dc['id']+'\x20is\x20too\x20new\x20('+_0x472867['toFixed'](0x1)+'h),\x20skipping\x20global\x20check'),_0xc64d1c++;continue;}console[_0x264dc6(0x19f)](_0x264dc6(0x1b0)+_0x3c66dc['id']+'\x20(age:\x20'+_0x472867[_0x264dc6(0x136)](0x1)+'h)'),await this['checkSinglePayment'](_0x3c66dc),_0x145769++,await new Promise(_0x469d7d=>setTimeout(_0x469d7d,0x7d0));}catch(_0x3e3c70){console[_0x264dc6(0xd3)]('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x3c66dc['id']+':',_0x3e3c70),this[_0x264dc6(0x145)](_0x3c66dc['id'],_0x3c66dc['gatewayPaymentId']||'unknown',_0x3e3c70,_0x264dc6(0x103),{'isGlobalCheck':!![],'paymentAmount':_0x3c66dc[_0x264dc6(0x129)],'paymentCurrency':_0x3c66dc[_0x264dc6(0x11e)],'shopId':_0x3c66dc[_0x264dc6(0x14f)],'createdAt':_0x3c66dc[_0x264dc6(0x116)]}),loggerService_1[_0x264dc6(0x194)][_0x264dc6(0x161)](_0x264dc6(0xda),_0x264dc6(0x18b)+_0x3c66dc[_0x264dc6(0x12e)],_0x3e3c70);}}console[_0x264dc6(0x19f)](_0x264dc6(0x13f)+_0x145769+_0x264dc6(0xd1)+_0xc64d1c+'\x20skipped,\x20'+_0x52eedd[_0x264dc6(0x166)]+'\x20expired');}catch(_0x5e30ab){console[_0x264dc6(0xd3)](_0x264dc6(0x173),_0x5e30ab);}}async[a37_0x4a0c10(0x191)](_0x149a07){const _0x26561a=a37_0x4a0c10,_0x4e2320=[],_0x1fa69e=new Date();_0x1fa69e[_0x26561a(0x152)](_0x1fa69e[_0x26561a(0xf0)]()-this[_0x26561a(0x112)]),console[_0x26561a(0x19f)](_0x26561a(0x11d)+this[_0x26561a(0x112)]+'\x20days\x20(created\x20before\x20'+_0x1fa69e[_0x26561a(0x1a8)]()+')');for(const _0x320944 of _0x149a07){if(_0x320944[_0x26561a(0x116)]<_0x1fa69e){console[_0x26561a(0x19f)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x320944['id']+_0x26561a(0x148)+this[_0x26561a(0x112)]+_0x26561a(0x1a4));try{this[_0x26561a(0x15d)](_0x320944['id'],_0x320944[_0x26561a(0x12e)]||_0x26561a(0x12a),'PENDING',_0x26561a(0x111),_0x26561a(0x101),{'reason':_0x26561a(0x14c)+this['EXPIRY_DAYS']+_0x26561a(0xe4),'createdAt':_0x320944[_0x26561a(0x116)],'daysSinceCreation':Math[_0x26561a(0x163)]((Date[_0x26561a(0xe9)]()-_0x320944[_0x26561a(0x116)][_0x26561a(0x162)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x320944[_0x26561a(0x129)],'paymentCurrency':_0x320944[_0x26561a(0x11e)],'shopId':_0x320944[_0x26561a(0x14f)]}),await database_1[_0x26561a(0x182)][_0x26561a(0x198)][_0x26561a(0x16a)]({'where':{'id':_0x320944['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x26561a(0xed)+this[_0x26561a(0x112)]+_0x26561a(0x1af)}}),await database_1[_0x26561a(0x182)][_0x26561a(0x15c)]['create']({'data':{'paymentId':_0x320944['id'],'shopId':_0x320944[_0x26561a(0x14f)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x26561a(0x128)]({'reason':_0x26561a(0x14c)+this['EXPIRY_DAYS']+_0x26561a(0xe4),'createdAt':_0x320944[_0x26561a(0x116)],'expiredAt':new Date()[_0x26561a(0x1a8)](),'daysSinceCreation':Math[_0x26561a(0x163)]((Date[_0x26561a(0xe9)]()-_0x320944['createdAt'][_0x26561a(0x162)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x320944,_0x26561a(0x111)),await this[_0x26561a(0xea)](_0x320944,_0x26561a(0x111)),this[_0x26561a(0x11f)](_0x320944['id']),_0x4e2320['push'](_0x320944['id']),console[_0x26561a(0x19f)](_0x26561a(0x105)+_0x320944['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x26561a(0x112)]+_0x26561a(0x168));}catch(_0x3fd72b){console[_0x26561a(0xd3)](_0x26561a(0x122)+_0x320944['id']+':',_0x3fd72b),this['logCoinToPayError'](_0x320944['id'],_0x320944['gatewayPaymentId']||_0x26561a(0x12a),_0x3fd72b,_0x26561a(0x101),{'reason':_0x26561a(0xce),'createdAt':_0x320944[_0x26561a(0x116)],'daysSinceCreation':Math[_0x26561a(0x163)]((Date[_0x26561a(0xe9)]()-_0x320944[_0x26561a(0x116)][_0x26561a(0x162)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x4e2320;}async[a37_0x4a0c10(0x123)](_0x451dfa){const _0xc98307=a37_0x4a0c10;if(!_0x451dfa[_0xc98307(0x12e)]){console[_0xc98307(0x19f)](_0xc98307(0x113)+_0x451dfa['id']+_0xc98307(0x14a));return;}console['log'](_0xc98307(0x16d)+_0x451dfa['id']+'\x20('+_0x451dfa[_0xc98307(0x12e)]+')');try{const _0x58a001=await this['coinToPayService']['checkPaymentStatus'](_0x451dfa[_0xc98307(0x12e)]);console['log'](_0xc98307(0x18d)+_0x451dfa['id']+_0xc98307(0xf8)+_0x58a001[_0xc98307(0x19d)]);_0x58a001[_0xc98307(0x151)]&&console[_0xc98307(0x19f)]('📊\x20[CHECK]\x20Payment\x20'+_0x451dfa['id']+'\x20details:',{'iban':_0x58a001[_0xc98307(0x151)][_0xc98307(0x140)]||_0xc98307(0x1ab),'transactionId':_0x58a001[_0xc98307(0x151)]['transactionId'],'createdOn':_0x58a001[_0xc98307(0x151)][_0xc98307(0x165)],'confirmedOn':_0x58a001[_0xc98307(0x151)][_0xc98307(0xc9)]||_0xc98307(0x10e)});if(_0x58a001['status']!==_0x451dfa[_0xc98307(0x19d)]){console[_0xc98307(0x19f)](_0xc98307(0x102)+_0x451dfa['id']+_0xc98307(0xd8)+_0x451dfa['status']+_0xc98307(0x158)+_0x58a001[_0xc98307(0x19d)]),this['logCoinToPayStatus'](_0x451dfa['id'],_0x451dfa[_0xc98307(0x12e)],_0x451dfa[_0xc98307(0x19d)],_0x58a001[_0xc98307(0x19d)],'status_check',{'paymentDetails':_0x58a001[_0xc98307(0x151)],'amount':_0x58a001[_0xc98307(0x129)],'currency':_0x58a001['currency'],'shopId':_0x451dfa[_0xc98307(0x14f)],'checkTimestamp':new Date()['toISOString']()});const _0x1f4379={'status':_0x58a001['status'],'updatedAt':new Date()};_0x58a001[_0xc98307(0x19d)]===_0xc98307(0x143)&&_0x451dfa[_0xc98307(0x19d)]!=='PAID'&&(_0x1f4379[_0xc98307(0xd7)]=new Date(),console[_0xc98307(0x19f)](_0xc98307(0xf2)+_0x451dfa['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x1f4379[_0xc98307(0xd7)]['toISOString']()));if(_0x58a001[_0xc98307(0x151)]){const _0x5ce5a2=_0x58a001[_0xc98307(0x151)];_0x5ce5a2['iban']&&(_0x1f4379[_0xc98307(0xe1)]=_0x5ce5a2[_0xc98307(0x140)],console[_0xc98307(0x19f)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x5ce5a2[_0xc98307(0x140)]));if(_0x5ce5a2[_0xc98307(0x197)]){const _0x3ca3df=_0x451dfa[_0xc98307(0x16e)]||'',_0x4a6184='Bank\x20Details:\x20'+_0x5ce5a2[_0xc98307(0x197)];_0x1f4379[_0xc98307(0x16e)]=_0x3ca3df?_0x3ca3df+'\x0a\x0a'+_0x4a6184:_0x4a6184,console['log']('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x5ce5a2['transactionId']&&console[_0xc98307(0x19f)](_0xc98307(0x184)+_0x5ce5a2[_0xc98307(0x157)]),_0x5ce5a2['confirmedOn']&&console[_0xc98307(0x19f)]('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x5ce5a2['confirmedOn']);}await database_1[_0xc98307(0x182)][_0xc98307(0x198)][_0xc98307(0x16a)]({'where':{'id':_0x451dfa['id']},'data':_0x1f4379}),await database_1[_0xc98307(0x182)][_0xc98307(0x15c)][_0xc98307(0x150)]({'data':{'paymentId':_0x451dfa['id'],'shopId':_0x451dfa[_0xc98307(0x14f)],'event':_0xc98307(0x119)+_0x58a001[_0xc98307(0x19d)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0xc98307(0x128)]({'oldStatus':_0x451dfa[_0xc98307(0x19d)],'newStatus':_0x58a001[_0xc98307(0x19d)],'paymentDetails':_0x58a001[_0xc98307(0x151)],'checkedAt':new Date()[_0xc98307(0x1a8)]()})}}),await this[_0xc98307(0x1aa)](_0x451dfa,_0x58a001[_0xc98307(0x19d)]),await this['sendPaymentStatusNotification'](_0x451dfa,_0x58a001[_0xc98307(0x19d)]),_0x58a001[_0xc98307(0x19d)]!==_0xc98307(0x114)&&(console['log'](_0xc98307(0x18c)+_0x451dfa['id']+'\x20status\x20changed\x20to\x20'+_0x58a001[_0xc98307(0x19d)]+_0xc98307(0xd0)),this[_0xc98307(0x11f)](_0x451dfa['id'])),console[_0xc98307(0x19f)](_0xc98307(0x16c)+_0x451dfa['id']+'\x20updated\x20successfully');}else console[_0xc98307(0x19f)](_0xc98307(0x18d)+_0x451dfa['id']+'\x20status\x20unchanged\x20('+_0x58a001[_0xc98307(0x19d)]+')'),this[_0xc98307(0x15d)](_0x451dfa['id'],_0x451dfa[_0xc98307(0x12e)],_0x451dfa[_0xc98307(0x19d)],_0x58a001[_0xc98307(0x19d)],_0xc98307(0x103),{'statusUnchanged':!![],'paymentDetails':_0x58a001[_0xc98307(0x151)],'amount':_0x58a001[_0xc98307(0x129)],'currency':_0x58a001[_0xc98307(0x11e)],'shopId':_0x451dfa[_0xc98307(0x14f)],'checkTimestamp':new Date()[_0xc98307(0x1a8)]()});}catch(_0xcadbed){console['error'](_0xc98307(0x195)+_0x451dfa['id']+':',_0xcadbed),this[_0xc98307(0x145)](_0x451dfa['id'],_0x451dfa[_0xc98307(0x12e)],_0xcadbed,_0xc98307(0x103),{'paymentAmount':_0x451dfa['amount'],'paymentCurrency':_0x451dfa[_0xc98307(0x11e)],'shopId':_0x451dfa['shopId'],'createdAt':_0x451dfa['createdAt']}),await database_1[_0xc98307(0x182)][_0xc98307(0x15c)][_0xc98307(0x150)]({'data':{'paymentId':_0x451dfa['id'],'shopId':_0x451dfa[_0xc98307(0x14f)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0xcadbed instanceof Error?_0xcadbed[_0xc98307(0x10a)]:_0xc98307(0xcd),'gatewayPaymentId':_0x451dfa[_0xc98307(0x12e)],'checkedAt':new Date()['toISOString']()})}});}}async['sendShopWebhook'](_0x338d49,_0x5651df){const _0x495332=a37_0x4a0c10,_0x232779=Date['now']();try{const _0x46a077=_0x338d49[_0x495332(0x19a)],_0x4350f5=_0x46a077[_0x495332(0xd4)];if(!_0x4350f5?.[_0x495332(0xfd)]){console['log'](_0x495332(0xdf)+_0x46a077['id']);return;}const _0x4a8c01=_0x5651df===_0x495332(0x143)?_0x495332(0x183):_0x5651df===_0x495332(0xc8)?_0x495332(0x146):_0x5651df===_0x495332(0x111)?_0x495332(0x146):_0x495332(0x16f);if(!_0x4350f5[_0x495332(0x14d)]?.[_0x495332(0xf3)](_0x4a8c01)){console[_0x495332(0x19f)](_0x495332(0x15b)+_0x4a8c01+_0x495332(0x13b)+_0x46a077['id']);return;}const _0x4d288e={'event':_0x4a8c01,'payment':{'id':_0x338d49['id'],'order_id':_0x338d49['orderId'],'gateway_order_id':_0x338d49[_0x495332(0x153)],'gateway':'0100','amount':_0x338d49['amount'],'currency':_0x338d49[_0x495332(0x11e)],'status':_0x5651df[_0x495332(0x115)](),'customer_email':_0x338d49[_0x495332(0x141)],'customer_name':_0x338d49[_0x495332(0xef)],'created_at':_0x338d49[_0x495332(0x116)],'updated_at':new Date()}},_0x194f5a=await fetch(_0x4350f5[_0x495332(0xfd)],{'method':'POST','headers':{'Content-Type':_0x495332(0x1a5),'User-Agent':_0x495332(0xee)},'body':JSON[_0x495332(0x128)](_0x4d288e)}),_0x10d1f8=Date[_0x495332(0xe9)]()-_0x232779,_0x310e92=_0x194f5a['ok']?_0x495332(0x121):await _0x194f5a[_0x495332(0xdb)]();loggerService_1[_0x495332(0x194)][_0x495332(0x171)](_0x338d49[_0x495332(0x14f)],_0x4350f5[_0x495332(0xfd)],_0x4a8c01,_0x194f5a[_0x495332(0x19d)],_0x10d1f8,_0x4d288e),console[_0x495332(0x19f)]('Shop\x20webhook\x20sent\x20to\x20'+_0x4350f5[_0x495332(0xfd)]+'\x20with\x20status\x20'+_0x194f5a[_0x495332(0x19d)]+'\x20('+_0x10d1f8+_0x495332(0xe8));}catch(_0x3245c3){console[_0x495332(0xd3)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x3245c3),loggerService_1[_0x495332(0x194)][_0x495332(0x126)](_0x338d49[_0x495332(0x14f)],_0x338d49[_0x495332(0x19a)]?.[_0x495332(0xd4)]?.[_0x495332(0xfd)]||_0x495332(0x12a),_0x495332(0x187),_0x3245c3,{});}}async['sendPaymentStatusNotification'](_0x2118c7,_0x5130d1){const _0x29b5d8=a37_0x4a0c10;try{const _0xba9bb7={'PENDING':_0x29b5d8(0xff),'PAID':_0x29b5d8(0x175),'FAILED':_0x29b5d8(0x14e),'EXPIRED':_0x29b5d8(0x11c)},_0x2c659c=_0xba9bb7[_0x5130d1];if(!_0x2c659c||_0x2c659c===_0x29b5d8(0xff))return;await telegramBotService_1[_0x29b5d8(0x12f)][_0x29b5d8(0xca)](_0x2118c7['shopId'],_0x2118c7,_0x2c659c);}catch(_0x38cd73){console['error'](_0x29b5d8(0xd2),_0x38cd73);}}async[a37_0x4a0c10(0x1a2)](_0x3aa08f){const _0x20e83c=a37_0x4a0c10;console[_0x20e83c(0x19f)](_0x20e83c(0x138)+_0x3aa08f);const _0x44026e=await database_1[_0x20e83c(0x182)][_0x20e83c(0x198)][_0x20e83c(0xfa)]({'where':{'id':_0x3aa08f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x44026e)throw new Error(_0x20e83c(0xf6));if(_0x44026e['gateway']!=='cointopay')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x20e83c(0x19f)](_0x20e83c(0xf5)+_0x3aa08f),await this[_0x20e83c(0x123)](_0x44026e),console[_0x20e83c(0x19f)](_0x20e83c(0x1ae)+_0x3aa08f);}[a37_0x4a0c10(0x109)](){const _0xb95d2c=a37_0x4a0c10,_0x3ca5ba=this[_0xb95d2c(0x11b)]?this[_0xb95d2c(0x156)]:undefined,_0x357873=Array['from'](this[_0xb95d2c(0x13a)][_0xb95d2c(0x12b)]())[_0xb95d2c(0x106)](_0xc9cd97=>({'paymentId':_0xc9cd97['paymentId'],'gatewayPaymentId':_0xc9cd97[_0xb95d2c(0x12e)],'createdAt':_0xc9cd97[_0xb95d2c(0x116)],'timersCount':_0xc9cd97[_0xb95d2c(0x120)][_0xb95d2c(0x166)]}));return{'isActive':!!this[_0xb95d2c(0x11b)],'globalCheckIntervalMinutes':this[_0xb95d2c(0x156)]/(0x3e8*0x3c),'expiryDays':this[_0xb95d2c(0x112)],'activeIndividualTimers':this[_0xb95d2c(0x13a)][_0xb95d2c(0x132)],'nextGlobalCheckIn':_0x3ca5ba,'paymentTimersDetails':_0x357873};}['getPaymentTimerInfo'](_0x3d7ad1){const _0x581925=a37_0x4a0c10,_0x1637eb=this[_0x581925(0x13a)][_0x581925(0x15e)](_0x3d7ad1);if(_0x1637eb)return{'hasTimers':!![],'timersCount':_0x1637eb['timers'][_0x581925(0x166)],'createdAt':_0x1637eb[_0x581925(0x116)],'gatewayPaymentId':_0x1637eb[_0x581925(0x12e)]};return{'hasTimers':![]};}}exports[a37_0x4a0c10(0xdc)]=CoinToPayStatusService,exports[a37_0x4a0c10(0x100)]=new CoinToPayStatusService();