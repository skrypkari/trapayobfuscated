'use strict';const a37_0x23ad94=a37_0x3df1;function a37_0x3df1(_0x4b3230,_0x129aae){const _0x349db4=a37_0x349d();return a37_0x3df1=function(_0x3df1b2,_0x15998f){_0x3df1b2=_0x3df1b2-0x1b4;let _0x3b9045=_0x349db4[_0x3df1b2];return _0x3b9045;},a37_0x3df1(_0x4b3230,_0x129aae);}(function(_0x3bc424,_0xe203b2){const _0x4dbba8=a37_0x3df1,_0x4e5717=_0x3bc424();while(!![]){try{const _0x4421f5=-parseInt(_0x4dbba8(0x213))/0x1*(parseInt(_0x4dbba8(0x254))/0x2)+-parseInt(_0x4dbba8(0x264))/0x3+-parseInt(_0x4dbba8(0x22a))/0x4+-parseInt(_0x4dbba8(0x1f7))/0x5+-parseInt(_0x4dbba8(0x1cd))/0x6+-parseInt(_0x4dbba8(0x266))/0x7*(parseInt(_0x4dbba8(0x282))/0x8)+parseInt(_0x4dbba8(0x269))/0x9*(parseInt(_0x4dbba8(0x250))/0xa);if(_0x4421f5===_0xe203b2)break;else _0x4e5717['push'](_0x4e5717['shift']());}catch(_0x1b79a8){_0x4e5717['push'](_0x4e5717['shift']());}}}(a37_0x349d,0x7bdca));var __importDefault=this&&this[a37_0x23ad94(0x26f)]||function(_0x5f1450){const _0xb9275f=a37_0x23ad94;return _0x5f1450&&_0x5f1450[_0xb9275f(0x212)]?_0x5f1450:{'default':_0x5f1450};};Object[a37_0x23ad94(0x228)](exports,'__esModule',{'value':!![]}),exports['coinToPayStatusService']=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a37_0x23ad94(0x284)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x23ad94(0x242)),loggerService_1=require(a37_0x23ad94(0x24a));function a37_0x349d(){const _0x3b292e=['\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','getServiceStats','webhookLog','logCoinToPayStatus','stack','./loggerService','\x20\x20\x20📝\x20Details:','🛑\x20[SHUTDOWN]\x20Cleared\x20','checkPaymentStatus','getPaymentTimerInfo','⚠️\x20[CHECK]\x20Payment\x20','20QbTYcu','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','includes','Bank\x20Details:\x20','3506HFFDnU','findMany','\x20status\x20is\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','message','Webhook\x20event\x20','1\x20minute','description','❌\x20[CHECK]\x20Payment\x20','clearPaymentTimers','\x20(after\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','Shop\x20webhook\x20sent\x20to\x20','globalCheckInterval','cointopay','getTime','1927212QYgxAU','logCoinToPayError','118629VyvNei','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','text','21829608qWFjOf','unknown','🧹\x20[CHECK]\x20Payment\x20','adminNotes','\x20seconds\x20(','sendShopWebhook','__importDefault','🪙\x20[TIMER]\x20Individual\x20check\x20#','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','not\x20found','EXPIRY_DAYS','5\x20minutes','\x20has\x20no\x20gatewayPaymentId,\x20skipping','checkSinglePaymentById','currency','catch','\x20days,\x20marking\x20as\x20EXPIRED','schedule_created','sendPaymentStatusNotification','transactionId','\x20triggered\x20for\x20payment\x20','timestamp','customerName','map','has','424sUjMfG','paidAt','./gateways/coinToPayService','PENDING','GLOBAL_CHECK_INTERVAL_MS','\x20\x20\x20-\x20ShopId:\x20','size','checkAllPendingPayments','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20individual\x20payment\x20timers','orderId','\x20not\x20found,\x20clearing\x20timers','Failed\x20to\x20send\x20shop\x20webhook:','paymentDetails','Automatically\x20expired\x20after\x20','toLowerCase','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20\x20\x20📊\x20Status:\x20','\x20days\x20(created\x20before\x20','📊\x20[CHECK]\x20Payment\x20','status_check','logWhiteDomainError','TesSoft\x20Payment\x20System/1.0','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','floor','\x20\x20\x20-\x20GatewayPaymentId:\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20not\x20found\x20in\x20database','\x20current\x20status:\x20','coinToPayStatusService','bankDetails','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','PAID','created','remitterIban','loggerService','checkExpiredPayments','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','toFixed','COINTOPAY_ERROR','CoinToPayStatusService','EXPIRED','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','startPeriodicStatusCheck','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','confirmedOn','🧹\x20[DEBUG]\x20Clearing\x20','\x20status\x20unchanged\x20(','Unknown\x20error','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','not\x20confirmed','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','\x20expired\x20CoinToPay\x20payments','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','now','timers','coinToPayService','auto_expire',',\x20stopping\x20individual\x20checks','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','2613672QtTAJr','toISOString','push','\x20status:\x20','webhookUrl','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','webhook_send','gateway','getDate','✅\x20[CHECK]\x20Payment\x20','\x20in\x20','2\x20minutes','⏰\x20[HOURLY]\x20Payment\x20','payment.failed','default','\x20not\x20enabled\x20for\x20shop\x20','Payment\x20older\x20than\x20','\x20(age:\x20','setDate','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20is\x20older\x20than\x20','\x20\x20\x20📍\x20Source:\x20','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','-day\x20timeout','stringify','cointopay_auto_expired','📊\x20[HOURLY]\x20Payment\x20','update','length','\x20\x20\x20-\x20Status:\x20','shopId','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','paid','\x20for\x20payment\x20','error','\x20completed\x20for\x20payment\x20','CoinToPayService','delete','\x20\x20\x20📅\x20Time:\x20','✅\x20[HOURLY]\x20Payment\x20','3718580DAsWCB','paymentTimers','paymentId','0100','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','expired','gatewayPaymentId','customerEmail','\x20timers\x20for\x20payment\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','amount','logShopWebhookSent','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','schedulePaymentChecks','💰\x20[CHECK]\x20Payment\x20','\x20\x20\x20❌\x20Error:\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','Success','payment.pending','\x20\x20\x20-\x20Gateway:\x20','\x20expired','\x20is\x20too\x20new\x20(','createdAt','shop',',\x20clearing\x20individual\x20timers','gatewayOrderId','failed','__esModule','453KGPzoG','checkSinglePayment','settings','\x20status\x20from\x20','payment','webhookEvents','\x20to\x20','ms)','\x20status\x20changed\x20to\x20','iban','\x20is\x20valid\x20for\x20checking,\x20proceeding...','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','⏰\x20[EXPIRY]\x20Payment\x20','\x20\x20\x20-\x20Amount:\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20skipped,\x20','createdOn','⏰\x20[GLOBAL]\x20Found\x20','✅\x20[EXPIRY]\x20Payment\x20','⏰\x20[GLOBAL]\x20Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','defineProperty','Payment\x20not\x20found','3318616CpExVl','✅\x20[TIMER]\x20Individual\x20check\x20#','create','\x20initial\x20timers\x20for\x20payment\x20','\x20details:','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','status','POST','h),\x20skipping\x20global\x20check','\x20found:','cointopay_status_check_','\x20updated\x20successfully','log','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','get','\x20pending\x20CoinToPay\x20payments','values','\x20->\x20','\x20\x20\x20📝\x20Context:','❌\x20[HOURLY]\x20Payment\x20','telegramBotService','./telegramBotService','COINTOPAY_STATUS_CHANGE'];a37_0x349d=function(){return _0x3b292e;};return a37_0x349d();}class CoinToPayStatusService{constructor(){const _0xd18a1c=a37_0x23ad94;this[_0xd18a1c(0x261)]=null,this[_0xd18a1c(0x286)]=0x3c*0x3c*0x3e8,this[_0xd18a1c(0x273)]=0x5,this['paymentTimers']=new Map(),this[_0xd18a1c(0x1c9)]=new coinToPayService_1[(_0xd18a1c(0x1f3))](),console[_0xd18a1c(0x238)]('🪙\x20CoinToPayStatusService\x20initialized');}[a37_0x23ad94(0x204)](_0x52aaac,_0x38d9d0){const _0xed618e=a37_0x23ad94;console[_0xed618e(0x238)](_0xed618e(0x1e4)),console[_0xed618e(0x238)]('\x20\x20\x20-\x20paymentId:\x20'+_0x52aaac),console['log']('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x38d9d0),this[_0xed618e(0x25d)](_0x52aaac);const _0xe02f5f=[],_0x4e0565=new Date(),_0x42ff2b=[{'delay':0x1*0x3c*0x3e8,'description':_0xed618e(0x25a)},{'delay':0x2*0x3c*0x3e8,'description':_0xed618e(0x1d8)},{'delay':0x5*0x3c*0x3e8,'description':_0xed618e(0x274)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0xed618e(0x238)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x42ff2b[_0xed618e(0x1eb)]+_0xed618e(0x22d)+_0x52aaac);let _0x3ca3db=0x0;_0x42ff2b['forEach']((_0x19c233,_0x491494)=>{const _0x2c0270=_0xed618e;_0x3ca3db+=_0x19c233['delay'];const _0x11c1d7=setTimeout(async()=>{const _0x128f12=a37_0x3df1;console[_0x128f12(0x238)](_0x128f12(0x270)+(_0x491494+0x1)+_0x128f12(0x27d)+_0x52aaac+_0x128f12(0x25e)+_0x19c233[_0x128f12(0x25b)]+')');try{await this[_0x128f12(0x276)](_0x52aaac),console['log'](_0x128f12(0x22b)+(_0x491494+0x1)+_0x128f12(0x1f2)+_0x52aaac);}catch(_0x3a13eb){console[_0x128f12(0x1f1)](_0x128f12(0x230)+(_0x491494+0x1)+'\x20for\x20payment\x20'+_0x52aaac+':',_0x3a13eb),this[_0x128f12(0x265)](_0x52aaac,_0x38d9d0,_0x3a13eb,'status_check',{'checkNumber':_0x491494+0x1,'scheduledAfter':_0x19c233[_0x128f12(0x25b)],'isIndividualCheck':!![]});}},_0x3ca3db);_0xe02f5f['push'](_0x11c1d7),console[_0x2c0270(0x238)](_0x2c0270(0x22f)+(_0x491494+0x1)+_0x2c0270(0x1f0)+_0x52aaac+_0x2c0270(0x1d7)+_0x3ca3db/0x3e8+_0x2c0270(0x26d)+_0x19c233[_0x2c0270(0x25b)]+')');});const _0x3b5a17=setInterval(async()=>{const _0x1a320a=_0xed618e;console[_0x1a320a(0x238)]('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x52aaac);try{const _0xd346c0=await database_1[_0x1a320a(0x1db)][_0x1a320a(0x217)]['findUnique']({'where':{'id':_0x52aaac},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0xd346c0){console['log'](_0x1a320a(0x240)+_0x52aaac+_0x1a320a(0x28d)),this[_0x1a320a(0x25d)](_0x52aaac);return;}console[_0x1a320a(0x238)](_0x1a320a(0x1e9)+_0x52aaac+_0x1a320a(0x29e)+_0xd346c0[_0x1a320a(0x232)]);if(_0xd346c0[_0x1a320a(0x232)]!==_0x1a320a(0x285)){console[_0x1a320a(0x238)](_0x1a320a(0x1f6)+_0x52aaac+_0x1a320a(0x256)+_0xd346c0[_0x1a320a(0x232)]+_0x1a320a(0x1cb)),this['clearPaymentTimers'](_0x52aaac);return;}const _0x46f222=Math['floor']((Date[_0x1a320a(0x1c7)]()-_0xd346c0['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x46f222>=this['EXPIRY_DAYS']){console['log'](_0x1a320a(0x1d9)+_0x52aaac+_0x1a320a(0x1e2)+this[_0x1a320a(0x273)]+_0x1a320a(0x200)),this['clearPaymentTimers'](_0x52aaac);return;}await this[_0x1a320a(0x276)](_0x52aaac),console[_0x1a320a(0x238)](_0x1a320a(0x1c2)+_0x52aaac);}catch(_0xd02471){console[_0x1a320a(0x1f1)](_0x1a320a(0x1e5)+_0x52aaac+':',_0xd02471),this[_0x1a320a(0x265)](_0x52aaac,_0x38d9d0,_0xd02471,_0x1a320a(0x296),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0xe02f5f[_0xed618e(0x1cf)](_0x3b5a17),this[_0xed618e(0x1f8)]['set'](_0x52aaac,{'timers':_0xe02f5f,'paymentId':_0x52aaac,'gatewayPaymentId':_0x38d9d0,'createdAt':_0x4e0565}),console[_0xed618e(0x238)](_0xed618e(0x257)+_0x42ff2b[_0xed618e(0x1eb)]+_0xed618e(0x1fb)+_0x52aaac),console[_0xed618e(0x238)]('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0xed618e(0x1f8)][_0xed618e(0x288)]),this[_0xed618e(0x248)](_0x52aaac,_0x38d9d0,_0xed618e(0x285),_0xed618e(0x285),'status_check',{'action':_0xed618e(0x27a),'scheduledChecks':_0x42ff2b[_0xed618e(0x1eb)],'firstCheckIn':_0x42ff2b[0x0]['delay']/0x3e8,'totalTimers':this[_0xed618e(0x1f8)][_0xed618e(0x288)]});}['clearPaymentTimers'](_0x3b2787){const _0x9028cd=a37_0x23ad94,_0x576836=this[_0x9028cd(0x1f8)][_0x9028cd(0x23b)](_0x3b2787);_0x576836?(console['log'](_0x9028cd(0x1bf)+_0x576836[_0x9028cd(0x1c8)][_0x9028cd(0x1eb)]+_0x9028cd(0x1ff)+_0x3b2787),_0x576836[_0x9028cd(0x1c8)]['forEach']((_0x4858ff,_0x665208)=>{const _0x362847=_0x9028cd;_0x4858ff&&(clearTimeout(_0x4858ff),clearInterval(_0x4858ff),console['log']('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x665208+0x1)+_0x362847(0x1f0)+_0x3b2787));}),this[_0x9028cd(0x1f8)][_0x9028cd(0x1f4)](_0x3b2787),console[_0x9028cd(0x238)](_0x9028cd(0x1ee)+_0x3b2787+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x9028cd(0x1f8)][_0x9028cd(0x288)])):console[_0x9028cd(0x238)](_0x9028cd(0x29c)+_0x3b2787+'\x20to\x20clear');}async[a37_0x23ad94(0x276)](_0x923e63){const _0x3a1baa=a37_0x23ad94;console[_0x3a1baa(0x238)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x923e63);const _0x304b79=await database_1['default'][_0x3a1baa(0x217)]['findUnique']({'where':{'id':_0x923e63},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x304b79){console[_0x3a1baa(0x238)](_0x3a1baa(0x25c)+_0x923e63+_0x3a1baa(0x29d));return;}console[_0x3a1baa(0x238)](_0x3a1baa(0x295)+_0x923e63+_0x3a1baa(0x235)),console[_0x3a1baa(0x238)](_0x3a1baa(0x20a)+_0x304b79[_0x3a1baa(0x1d4)]),console[_0x3a1baa(0x238)](_0x3a1baa(0x1ec)+_0x304b79[_0x3a1baa(0x232)]),console[_0x3a1baa(0x238)](_0x3a1baa(0x29b)+_0x304b79[_0x3a1baa(0x1fd)]),console['log'](_0x3a1baa(0x220)+_0x304b79[_0x3a1baa(0x201)]+'\x20'+_0x304b79[_0x3a1baa(0x277)]),console[_0x3a1baa(0x238)](_0x3a1baa(0x287)+_0x304b79[_0x3a1baa(0x1ed)]);if(_0x304b79[_0x3a1baa(0x1d4)]!==_0x3a1baa(0x262)){console[_0x3a1baa(0x238)](_0x3a1baa(0x24f)+_0x923e63+_0x3a1baa(0x1bb)+_0x304b79[_0x3a1baa(0x1d4)]+')');return;}if(_0x304b79[_0x3a1baa(0x232)]!==_0x3a1baa(0x285)){console[_0x3a1baa(0x238)](_0x3a1baa(0x24f)+_0x923e63+_0x3a1baa(0x256)+_0x304b79['status']+_0x3a1baa(0x1cb)),this[_0x3a1baa(0x25d)](_0x923e63);return;}if(!_0x304b79['gatewayPaymentId']){console[_0x3a1baa(0x238)](_0x3a1baa(0x24f)+_0x923e63+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x3a1baa(0x238)](_0x3a1baa(0x1d6)+_0x923e63+_0x3a1baa(0x21d)),await this[_0x3a1baa(0x214)](_0x304b79);}[a37_0x23ad94(0x248)](_0x4278e4,_0x4179f9,_0x25080a,_0x14f514,_0x4707bd,_0x328483){const _0xd70b08=a37_0x23ad94,_0x31f5cb={'type':_0xd70b08(0x243),'paymentId':_0x4278e4,'gatewayPaymentId':_0x4179f9,'oldStatus':_0x25080a,'newStatus':_0x14f514,'source':_0x4707bd,'timestamp':new Date()[_0xd70b08(0x1ce)](),'details':_0x328483||{}};loggerService_1[_0xd70b08(0x1b4)]['logCoinToPayStatus'](_0x31f5cb),console[_0xd70b08(0x238)](_0xd70b08(0x1b6)+_0x4278e4+'\x20('+_0x4179f9+')'),console[_0xd70b08(0x238)](_0xd70b08(0x293)+_0x25080a+_0xd70b08(0x23e)+_0x14f514),console[_0xd70b08(0x238)](_0xd70b08(0x1e3)+_0x4707bd),console[_0xd70b08(0x238)](_0xd70b08(0x1f5)+_0x31f5cb[_0xd70b08(0x27e)]),_0x328483&&console[_0xd70b08(0x238)](_0xd70b08(0x24b),_0x328483);}[a37_0x23ad94(0x265)](_0x34ae85,_0x178aaa,_0x5514ad,_0x35ba18,_0xb45ff2){const _0x4725be=a37_0x23ad94,_0x30c811={'type':_0x4725be(0x1b8),'paymentId':_0x34ae85,'gatewayPaymentId':_0x178aaa,'error':_0x5514ad instanceof Error?{'message':_0x5514ad['message'],'stack':_0x5514ad[_0x4725be(0x249)]}:_0x5514ad,'source':_0x35ba18,'timestamp':new Date()[_0x4725be(0x1ce)](),'context':_0xb45ff2||{}};loggerService_1['loggerService'][_0x4725be(0x265)](_0x30c811),console[_0x4725be(0x1f1)]('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x34ae85+'\x20('+_0x178aaa+')'),console[_0x4725be(0x1f1)](_0x4725be(0x206)+(_0x5514ad instanceof Error?_0x5514ad[_0x4725be(0x258)]:_0x5514ad)),console[_0x4725be(0x1f1)](_0x4725be(0x1e3)+_0x35ba18),console[_0x4725be(0x1f1)](_0x4725be(0x1f5)+_0x30c811[_0x4725be(0x27e)]),_0xb45ff2&&console['error'](_0x4725be(0x23f),_0xb45ff2);}[a37_0x23ad94(0x1bc)](){const _0x1dcd78=a37_0x23ad94;console[_0x1dcd78(0x238)]('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this['checkAllPendingPayments']()[_0x1dcd78(0x278)](_0x4660eb=>{const _0x49bae0=_0x1dcd78;console[_0x49bae0(0x1f1)](_0x49bae0(0x203),_0x4660eb);}),this[_0x1dcd78(0x261)]=setInterval(async()=>{const _0x32345f=_0x1dcd78;try{console[_0x32345f(0x238)](_0x32345f(0x267)),await this[_0x32345f(0x289)](),console[_0x32345f(0x238)]('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x4d7e78){console[_0x32345f(0x1f1)](_0x32345f(0x25f),_0x4d7e78);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x1dcd78(0x238)](_0x1dcd78(0x23a));}['stopPeriodicStatusCheck'](){const _0x4e4110=a37_0x23ad94;console[_0x4e4110(0x238)](_0x4e4110(0x1c6));this[_0x4e4110(0x261)]&&(clearInterval(this[_0x4e4110(0x261)]),this[_0x4e4110(0x261)]=null,console[_0x4e4110(0x238)](_0x4e4110(0x21e)));const _0x4452d1=this['paymentTimers'][_0x4e4110(0x288)];for(const [_0x4e1c26]of this[_0x4e4110(0x1f8)]){this[_0x4e4110(0x25d)](_0x4e1c26);}console[_0x4e4110(0x238)](_0x4e4110(0x24c)+_0x4452d1+_0x4e4110(0x28b));}async[a37_0x23ad94(0x289)](){const _0x24ac2e=a37_0x23ad94;try{console[_0x24ac2e(0x238)]('🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x52797d=await database_1[_0x24ac2e(0x1db)][_0x24ac2e(0x217)][_0x24ac2e(0x255)]({'where':{'gateway':_0x24ac2e(0x262),'status':_0x24ac2e(0x285),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x24ac2e(0x238)]('🪙\x20[GLOBAL]\x20Found\x20'+_0x52797d['length']+_0x24ac2e(0x23c));if(_0x52797d[_0x24ac2e(0x1eb)]===0x0){console['log'](_0x24ac2e(0x1e1));return;}const _0x2e42a5=await this[_0x24ac2e(0x1b5)](_0x52797d);console[_0x24ac2e(0x238)](_0x24ac2e(0x224)+_0x2e42a5['length']+_0x24ac2e(0x1c5));let _0x624463=0x0,_0xd89466=0x0;for(const _0x29d2b7 of _0x52797d){try{if(_0x2e42a5[_0x24ac2e(0x252)](_0x29d2b7['id'])){console[_0x24ac2e(0x238)](_0x24ac2e(0x226)+_0x29d2b7['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0xd89466++;continue;}if(this[_0x24ac2e(0x1f8)][_0x24ac2e(0x281)](_0x29d2b7['id'])){console[_0x24ac2e(0x238)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x29d2b7['id']+_0x24ac2e(0x251)),_0xd89466++;continue;}const _0x36600a=(Date['now']()-_0x29d2b7[_0x24ac2e(0x20d)][_0x24ac2e(0x263)]())/(0x3e8*0x3c*0x3c);if(_0x36600a<0x1){console[_0x24ac2e(0x238)](_0x24ac2e(0x226)+_0x29d2b7['id']+_0x24ac2e(0x20c)+_0x36600a[_0x24ac2e(0x1b7)](0x1)+_0x24ac2e(0x234)),_0xd89466++;continue;}console[_0x24ac2e(0x238)](_0x24ac2e(0x299)+_0x29d2b7['id']+_0x24ac2e(0x1de)+_0x36600a['toFixed'](0x1)+'h)'),await this[_0x24ac2e(0x214)](_0x29d2b7),_0x624463++,await new Promise(_0x39ad0b=>setTimeout(_0x39ad0b,0x7d0));}catch(_0x4b2b91){console[_0x24ac2e(0x1f1)](_0x24ac2e(0x271)+_0x29d2b7['id']+':',_0x4b2b91),this[_0x24ac2e(0x265)](_0x29d2b7['id'],_0x29d2b7[_0x24ac2e(0x1fd)]||'unknown',_0x4b2b91,_0x24ac2e(0x296),{'isGlobalCheck':!![],'paymentAmount':_0x29d2b7[_0x24ac2e(0x201)],'paymentCurrency':_0x29d2b7[_0x24ac2e(0x277)],'shopId':_0x29d2b7[_0x24ac2e(0x1ed)],'createdAt':_0x29d2b7['createdAt']}),loggerService_1['loggerService'][_0x24ac2e(0x297)](_0x24ac2e(0x262),'/status/'+_0x29d2b7[_0x24ac2e(0x1fd)],_0x4b2b91);}}console[_0x24ac2e(0x238)]('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x624463+'\x20checked,\x20'+_0xd89466+_0x24ac2e(0x222)+_0x2e42a5[_0x24ac2e(0x1eb)]+_0x24ac2e(0x20b));}catch(_0x517372){console['error'](_0x24ac2e(0x2a1),_0x517372);}}async['checkExpiredPayments'](_0x195f16){const _0x4fd8fd=a37_0x23ad94,_0x5ebd25=[],_0x2a4411=new Date();_0x2a4411[_0x4fd8fd(0x1df)](_0x2a4411[_0x4fd8fd(0x1d5)]()-this[_0x4fd8fd(0x273)]),console['log']('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x4fd8fd(0x273)]+_0x4fd8fd(0x294)+_0x2a4411[_0x4fd8fd(0x1ce)]()+')');for(const _0x4cacdd of _0x195f16){if(_0x4cacdd[_0x4fd8fd(0x20d)]<_0x2a4411){console[_0x4fd8fd(0x238)](_0x4fd8fd(0x21f)+_0x4cacdd['id']+_0x4fd8fd(0x1e2)+this[_0x4fd8fd(0x273)]+_0x4fd8fd(0x279));try{this[_0x4fd8fd(0x248)](_0x4cacdd['id'],_0x4cacdd[_0x4fd8fd(0x1fd)]||_0x4fd8fd(0x26a),_0x4fd8fd(0x285),_0x4fd8fd(0x1ba),_0x4fd8fd(0x1ca),{'reason':'Payment\x20older\x20than\x20'+this[_0x4fd8fd(0x273)]+'\x20days','createdAt':_0x4cacdd['createdAt'],'daysSinceCreation':Math[_0x4fd8fd(0x29a)]((Date['now']()-_0x4cacdd[_0x4fd8fd(0x20d)][_0x4fd8fd(0x263)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x4cacdd[_0x4fd8fd(0x201)],'paymentCurrency':_0x4cacdd[_0x4fd8fd(0x277)],'shopId':_0x4cacdd['shopId']}),await database_1[_0x4fd8fd(0x1db)][_0x4fd8fd(0x217)][_0x4fd8fd(0x1ea)]({'where':{'id':_0x4cacdd['id']},'data':{'status':_0x4fd8fd(0x1ba),'updatedAt':new Date(),'adminNotes':_0x4fd8fd(0x290)+this[_0x4fd8fd(0x273)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x4fd8fd(0x1db)][_0x4fd8fd(0x247)][_0x4fd8fd(0x22c)]({'data':{'paymentId':_0x4cacdd['id'],'shopId':_0x4cacdd[_0x4fd8fd(0x1ed)],'event':_0x4fd8fd(0x1e8),'statusCode':0xc8,'responseBody':JSON[_0x4fd8fd(0x1e7)]({'reason':_0x4fd8fd(0x1dd)+this[_0x4fd8fd(0x273)]+'\x20days','createdAt':_0x4cacdd[_0x4fd8fd(0x20d)],'expiredAt':new Date()[_0x4fd8fd(0x1ce)](),'daysSinceCreation':Math[_0x4fd8fd(0x29a)]((Date['now']()-_0x4cacdd[_0x4fd8fd(0x20d)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4fd8fd(0x26e)](_0x4cacdd,_0x4fd8fd(0x1ba)),await this['sendPaymentStatusNotification'](_0x4cacdd,_0x4fd8fd(0x1ba)),this[_0x4fd8fd(0x25d)](_0x4cacdd['id']),_0x5ebd25[_0x4fd8fd(0x1cf)](_0x4cacdd['id']),console[_0x4fd8fd(0x238)](_0x4fd8fd(0x225)+_0x4cacdd['id']+_0x4fd8fd(0x244)+this[_0x4fd8fd(0x273)]+_0x4fd8fd(0x1e6));}catch(_0x3d29a1){console['error'](_0x4fd8fd(0x1c4)+_0x4cacdd['id']+':',_0x3d29a1),this['logCoinToPayError'](_0x4cacdd['id'],_0x4cacdd[_0x4fd8fd(0x1fd)]||_0x4fd8fd(0x26a),_0x3d29a1,_0x4fd8fd(0x1ca),{'reason':_0x4fd8fd(0x207),'createdAt':_0x4cacdd[_0x4fd8fd(0x20d)],'daysSinceCreation':Math[_0x4fd8fd(0x29a)]((Date['now']()-_0x4cacdd[_0x4fd8fd(0x20d)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5ebd25;}async[a37_0x23ad94(0x214)](_0x3e18b1){const _0x1e948f=a37_0x23ad94;if(!_0x3e18b1[_0x1e948f(0x1fd)]){console[_0x1e948f(0x238)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x3e18b1['id']+_0x1e948f(0x275));return;}console['log'](_0x1e948f(0x1e0)+_0x3e18b1['id']+'\x20('+_0x3e18b1[_0x1e948f(0x1fd)]+')');try{const _0x44d5b1=await this['coinToPayService'][_0x1e948f(0x24d)](_0x3e18b1[_0x1e948f(0x1fd)]);console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x3e18b1['id']+_0x1e948f(0x1d0)+_0x44d5b1[_0x1e948f(0x232)]);_0x44d5b1[_0x1e948f(0x28f)]&&console['log'](_0x1e948f(0x295)+_0x3e18b1['id']+_0x1e948f(0x22e),{'iban':_0x44d5b1['paymentDetails'][_0x1e948f(0x21c)]||_0x1e948f(0x272),'transactionId':_0x44d5b1[_0x1e948f(0x28f)]['transactionId'],'createdOn':_0x44d5b1[_0x1e948f(0x28f)][_0x1e948f(0x223)],'confirmedOn':_0x44d5b1[_0x1e948f(0x28f)][_0x1e948f(0x1be)]||_0x1e948f(0x1c3)});if(_0x44d5b1[_0x1e948f(0x232)]!==_0x3e18b1[_0x1e948f(0x232)]){console[_0x1e948f(0x238)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x3e18b1['id']+_0x1e948f(0x216)+_0x3e18b1[_0x1e948f(0x232)]+_0x1e948f(0x219)+_0x44d5b1[_0x1e948f(0x232)]),this['logCoinToPayStatus'](_0x3e18b1['id'],_0x3e18b1['gatewayPaymentId'],_0x3e18b1['status'],_0x44d5b1[_0x1e948f(0x232)],_0x1e948f(0x296),{'paymentDetails':_0x44d5b1[_0x1e948f(0x28f)],'amount':_0x44d5b1['amount'],'currency':_0x44d5b1[_0x1e948f(0x277)],'shopId':_0x3e18b1['shopId'],'checkTimestamp':new Date()['toISOString']()});const _0x25f387={'status':_0x44d5b1['status'],'updatedAt':new Date()};_0x44d5b1[_0x1e948f(0x232)]===_0x1e948f(0x2a2)&&_0x3e18b1[_0x1e948f(0x232)]!==_0x1e948f(0x2a2)&&(_0x25f387['paidAt']=new Date(),console[_0x1e948f(0x238)](_0x1e948f(0x205)+_0x3e18b1['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x25f387[_0x1e948f(0x283)]['toISOString']()));if(_0x44d5b1[_0x1e948f(0x28f)]){const _0x176097=_0x44d5b1['paymentDetails'];_0x176097[_0x1e948f(0x21c)]&&(_0x25f387[_0x1e948f(0x2a4)]=_0x176097['iban'],console[_0x1e948f(0x238)](_0x1e948f(0x231)+_0x176097[_0x1e948f(0x21c)]));if(_0x176097[_0x1e948f(0x2a0)]){const _0x3ed5d6=_0x3e18b1[_0x1e948f(0x26c)]||'',_0x3fb2ac=_0x1e948f(0x253)+_0x176097[_0x1e948f(0x2a0)];_0x25f387[_0x1e948f(0x26c)]=_0x3ed5d6?_0x3ed5d6+'\x0a\x0a'+_0x3fb2ac:_0x3fb2ac,console[_0x1e948f(0x238)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x176097[_0x1e948f(0x27c)]&&console[_0x1e948f(0x238)](_0x1e948f(0x239)+_0x176097[_0x1e948f(0x27c)]),_0x176097[_0x1e948f(0x1be)]&&console[_0x1e948f(0x238)](_0x1e948f(0x28a)+_0x176097[_0x1e948f(0x1be)]);}await database_1[_0x1e948f(0x1db)]['payment'][_0x1e948f(0x1ea)]({'where':{'id':_0x3e18b1['id']},'data':_0x25f387}),await database_1[_0x1e948f(0x1db)][_0x1e948f(0x247)][_0x1e948f(0x22c)]({'data':{'paymentId':_0x3e18b1['id'],'shopId':_0x3e18b1['shopId'],'event':_0x1e948f(0x236)+_0x44d5b1['status'][_0x1e948f(0x291)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x3e18b1[_0x1e948f(0x232)],'newStatus':_0x44d5b1[_0x1e948f(0x232)],'paymentDetails':_0x44d5b1[_0x1e948f(0x28f)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x1e948f(0x26e)](_0x3e18b1,_0x44d5b1['status']),await this[_0x1e948f(0x27b)](_0x3e18b1,_0x44d5b1[_0x1e948f(0x232)]),_0x44d5b1['status']!==_0x1e948f(0x285)&&(console['log'](_0x1e948f(0x26b)+_0x3e18b1['id']+_0x1e948f(0x21b)+_0x44d5b1[_0x1e948f(0x232)]+_0x1e948f(0x20f)),this[_0x1e948f(0x25d)](_0x3e18b1['id'])),console[_0x1e948f(0x238)](_0x1e948f(0x1d6)+_0x3e18b1['id']+_0x1e948f(0x237));}else console[_0x1e948f(0x238)]('📊\x20[CHECK]\x20Payment\x20'+_0x3e18b1['id']+_0x1e948f(0x1c0)+_0x44d5b1[_0x1e948f(0x232)]+')'),this['logCoinToPayStatus'](_0x3e18b1['id'],_0x3e18b1[_0x1e948f(0x1fd)],_0x3e18b1['status'],_0x44d5b1[_0x1e948f(0x232)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x44d5b1[_0x1e948f(0x28f)],'amount':_0x44d5b1[_0x1e948f(0x201)],'currency':_0x44d5b1[_0x1e948f(0x277)],'shopId':_0x3e18b1[_0x1e948f(0x1ed)],'checkTimestamp':new Date()[_0x1e948f(0x1ce)]()});}catch(_0xf9a106){console[_0x1e948f(0x1f1)](_0x1e948f(0x1cc)+_0x3e18b1['id']+':',_0xf9a106),this[_0x1e948f(0x265)](_0x3e18b1['id'],_0x3e18b1['gatewayPaymentId'],_0xf9a106,_0x1e948f(0x296),{'paymentAmount':_0x3e18b1[_0x1e948f(0x201)],'paymentCurrency':_0x3e18b1['currency'],'shopId':_0x3e18b1['shopId'],'createdAt':_0x3e18b1[_0x1e948f(0x20d)]}),await database_1[_0x1e948f(0x1db)][_0x1e948f(0x247)]['create']({'data':{'paymentId':_0x3e18b1['id'],'shopId':_0x3e18b1['shopId'],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x1e948f(0x1e7)]({'error':_0xf9a106 instanceof Error?_0xf9a106[_0x1e948f(0x258)]:_0x1e948f(0x1c1),'gatewayPaymentId':_0x3e18b1[_0x1e948f(0x1fd)],'checkedAt':new Date()[_0x1e948f(0x1ce)]()})}});}}async[a37_0x23ad94(0x26e)](_0x417745,_0x346009){const _0x4dc7ff=a37_0x23ad94,_0x4c3d8e=Date[_0x4dc7ff(0x1c7)]();try{const _0x3a23a5=_0x417745[_0x4dc7ff(0x20e)],_0x5caa53=_0x3a23a5[_0x4dc7ff(0x215)];if(!_0x5caa53?.[_0x4dc7ff(0x1d1)]){console[_0x4dc7ff(0x238)](_0x4dc7ff(0x292)+_0x3a23a5['id']);return;}const _0x22b937=_0x346009===_0x4dc7ff(0x2a2)?'payment.success':_0x346009==='FAILED'?_0x4dc7ff(0x1da):_0x346009===_0x4dc7ff(0x1ba)?'payment.failed':_0x4dc7ff(0x209);if(!_0x5caa53[_0x4dc7ff(0x218)]?.[_0x4dc7ff(0x252)](_0x22b937)){console['log'](_0x4dc7ff(0x259)+_0x22b937+_0x4dc7ff(0x1dc)+_0x3a23a5['id']);return;}const _0x26b9b4={'event':_0x22b937,'payment':{'id':_0x417745['id'],'order_id':_0x417745[_0x4dc7ff(0x28c)],'gateway_order_id':_0x417745[_0x4dc7ff(0x210)],'gateway':_0x4dc7ff(0x1fa),'amount':_0x417745[_0x4dc7ff(0x201)],'currency':_0x417745['currency'],'status':_0x346009[_0x4dc7ff(0x291)](),'customer_email':_0x417745[_0x4dc7ff(0x1fe)],'customer_name':_0x417745[_0x4dc7ff(0x27f)],'created_at':_0x417745[_0x4dc7ff(0x20d)],'updated_at':new Date()}},_0xd7201b=await fetch(_0x5caa53[_0x4dc7ff(0x1d1)],{'method':_0x4dc7ff(0x233),'headers':{'Content-Type':'application/json','User-Agent':_0x4dc7ff(0x298)},'body':JSON[_0x4dc7ff(0x1e7)](_0x26b9b4)}),_0x31810f=Date[_0x4dc7ff(0x1c7)]()-_0x4c3d8e,_0x336928=_0xd7201b['ok']?_0x4dc7ff(0x208):await _0xd7201b[_0x4dc7ff(0x268)]();loggerService_1['loggerService'][_0x4dc7ff(0x202)](_0x417745[_0x4dc7ff(0x1ed)],_0x5caa53[_0x4dc7ff(0x1d1)],_0x22b937,_0xd7201b[_0x4dc7ff(0x232)],_0x31810f,_0x26b9b4),console[_0x4dc7ff(0x238)](_0x4dc7ff(0x260)+_0x5caa53[_0x4dc7ff(0x1d1)]+'\x20with\x20status\x20'+_0xd7201b[_0x4dc7ff(0x232)]+'\x20('+_0x31810f+_0x4dc7ff(0x21a));}catch(_0x598544){console[_0x4dc7ff(0x1f1)](_0x4dc7ff(0x28e),_0x598544),loggerService_1[_0x4dc7ff(0x1b4)]['logShopWebhookError'](_0x417745['shopId'],_0x417745['shop']?.['settings']?.['webhookUrl']||'unknown',_0x4dc7ff(0x1d3),_0x598544,{});}}async['sendPaymentStatusNotification'](_0x320da1,_0x5d12a5){const _0x2258d2=a37_0x23ad94;try{const _0x4aba87={'PENDING':_0x2258d2(0x2a3),'PAID':_0x2258d2(0x1ef),'FAILED':_0x2258d2(0x211),'EXPIRED':_0x2258d2(0x1fc)},_0x4c3777=_0x4aba87[_0x5d12a5];if(!_0x4c3777||_0x4c3777===_0x2258d2(0x2a3))return;await telegramBotService_1[_0x2258d2(0x241)]['sendPaymentNotification'](_0x320da1[_0x2258d2(0x1ed)],_0x320da1,_0x4c3777);}catch(_0x45e18a){console['error'](_0x2258d2(0x227),_0x45e18a);}}async['checkPaymentById'](_0x192fe7){const _0x19e16e=a37_0x23ad94;console['log'](_0x19e16e(0x1d2)+_0x192fe7);const _0x43bfef=await database_1['default']['payment']['findUnique']({'where':{'id':_0x192fe7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x43bfef)throw new Error(_0x19e16e(0x229));if(_0x43bfef[_0x19e16e(0x1d4)]!==_0x19e16e(0x262))throw new Error(_0x19e16e(0x1bd));console[_0x19e16e(0x238)](_0x19e16e(0x245)+_0x192fe7),await this[_0x19e16e(0x214)](_0x43bfef),console['log'](_0x19e16e(0x221)+_0x192fe7);}[a37_0x23ad94(0x246)](){const _0x1895ec=a37_0x23ad94,_0x171d04=this[_0x1895ec(0x261)]?this[_0x1895ec(0x286)]:undefined,_0x4bd213=Array['from'](this[_0x1895ec(0x1f8)][_0x1895ec(0x23d)]())[_0x1895ec(0x280)](_0x7e5b04=>({'paymentId':_0x7e5b04[_0x1895ec(0x1f9)],'gatewayPaymentId':_0x7e5b04[_0x1895ec(0x1fd)],'createdAt':_0x7e5b04[_0x1895ec(0x20d)],'timersCount':_0x7e5b04[_0x1895ec(0x1c8)][_0x1895ec(0x1eb)]}));return{'isActive':!!this[_0x1895ec(0x261)],'globalCheckIntervalMinutes':this[_0x1895ec(0x286)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x1895ec(0x1f8)]['size'],'nextGlobalCheckIn':_0x171d04,'paymentTimersDetails':_0x4bd213};}[a37_0x23ad94(0x24e)](_0x1f31c0){const _0x3367b7=a37_0x23ad94,_0x46ce6b=this[_0x3367b7(0x1f8)][_0x3367b7(0x23b)](_0x1f31c0);if(_0x46ce6b)return{'hasTimers':!![],'timersCount':_0x46ce6b[_0x3367b7(0x1c8)][_0x3367b7(0x1eb)],'createdAt':_0x46ce6b[_0x3367b7(0x20d)],'gatewayPaymentId':_0x46ce6b[_0x3367b7(0x1fd)]};return{'hasTimers':![]};}}exports[a37_0x23ad94(0x1b9)]=CoinToPayStatusService,exports[a37_0x23ad94(0x29f)]=new CoinToPayStatusService();