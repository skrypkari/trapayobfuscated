'use strict';function a38_0x1d30(){const _0x418778=['entries','✅\x20[CHECK]\x20Payment\x20','🔄\x20[CHECK]\x20Updating\x20payment\x20','CoinToPay2Service','convertToUSDT','getGatewayCommission','PAID','auto_expire','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','payment.success','⚠️\x20[CHECK]\x20Payment\x20','sendPaymentNotification','Shop\x20webhook\x20sent\x20to\x20','📈\x20[COINTOPAY]\x20Payment\x20','iban','orderId','\x20\x20\x20-\x20GatewayPaymentId:\x20','cointopay2','\x20days\x20(created\x20before\x20','stringify','customerEmail','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','./gateways/coinToPay2Service','telegramBotService','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','amountAfterGatewayCommissionUSDT','./gateways/coinToPayService','findUnique','✅\x20[HOURLY]\x20Payment\x20','✅\x20[COINTOPAY]\x20Payment\x20link\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','🛑\x20[SHUTDOWN]\x20Cleared\x20','\x20status\x20is\x20','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','9708224sOdYvT','logShopWebhookError','GLOBAL_CHECK_INTERVAL_MS','Webhook\x20event\x20','CoinToPayService','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',',\x20status=','gatewaySettings','\x20not\x20found,\x20clearing\x20timers',',\x20stopping\x20individual\x20checks','createdAt','\x20days','getServiceStats','logCoinToPayError','\x20commission:\x20','failed','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','stopPeriodicStatusCheck','values','size','🪙\x20[GLOBAL]\x20Found\x20','unknown','getTime','\x20to\x20clear','FAILED','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20->\x20','get','\x20checked,\x20','delete','checkAllPendingPayments','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','has','Automatically\x20expired\x20after\x20','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','🧹\x20[DEBUG]\x20Clearing\x20','cointopay_status_check_','customerName','\x20\x20\x20-\x20Status:\x20','\x20expired\x20CoinToPay\x20payments','\x20has\x20no\x20gatewayPaymentId','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','gatewayPaymentId','⏰\x20[EXPIRY]\x20Payment\x20','webhookUrl','currency','update','2442220UklUHb','sendPaymentStatusNotification','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','coinToPayService','toLowerCase','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20not\x20found\x20in\x20database','setDate','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','\x20to\x20','\x20\x20\x20-\x20Amount:\x20','log','toFixed','floor','loggerService','amount','🪙\x20[TIMER]\x20Individual\x20check\x20#','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20\x20\x20-\x20Gateway:\x20','create','currencyService','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','length','\x20(age:\x20','h),\x20skipping\x20global\x20check','\x20completed\x20for\x20payment\x20','\x20expired','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','webhookLog','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','createdOn','\x20status\x20changed\x20to\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','paymentTimers','\x20\x20\x20-\x20gatewayPaymentId:\x20','sendShopWebhook','settings','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','adminNotes','checkPaymentById','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','created','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','⏰\x20[GLOBAL]\x20Payment\x20','\x20skipped,\x20','COINTOPAY_STATUS_CHANGE','PENDING','CoinToPayStatusService','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20timers\x20for\x20payment\x20','checkSinglePayment','💰\x20[CHECK]\x20Payment\x20','1442619amprQi','\x20\x20\x20📝\x20Context:','clearPaymentTimers','error','/status/','2TovczN','shopId','payment','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20is\x20older\x20than\x20','Unknown\x20error','\x20with\x20status\x20','\x20updated:\x20currentPayments=','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20initial\x20timers\x20for\x20payment\x20','delay','toISOString','paymentId','🪙\x20[DEBUG]\x20Creating\x20','catch','\x20\x20\x20-\x20paymentId:\x20','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','payment.failed','\x20status\x20from\x20','paymentLink','\x20pending\x20CoinToPay\x20payments','cointopay','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20\x20\x20📅\x20Time:\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','parse','type','forEach','\x20\x20\x20Amount:\x20','\x20triggered\x20for\x20payment\x20','Payment\x20older\x20than\x20','\x20amounts\x20calculated:','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','description','set','.\x20Remaining\x20active\x20timers:\x20','coinToPayStatusService','❌\x20[HOURLY]\x20Payment\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20\x20\x20📊\x20Status:\x20','paidAt','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','-day\x20timeout','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','getDate','\x20found:','checkExpiredPayments','\x20current\x20status:\x20','Payment\x20not\x20found',',\x20using\x20default\x20commission\x2010%','findMany','not\x20found','shop','timers','Success','currentPayments','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','🧹\x20[CHECK]\x20Payment\x20','checkSinglePaymentById','4570107KFbuTP','6PDzhWi','\x20\x20\x20-\x20ShopId:\x20','includes',',\x20clearing\x20individual\x20timers','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','📊\x20[HOURLY]\x20Payment\x20','getGatewayIdByName','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','\x20(after\x20','\x20for\x20payment\x20','5933096VckJlK','\x20individual\x20payment\x20timers','stack','message','67113486hLpYGx','coinToPay2Service','SINGLE','push','schedule_created','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','EXPIRY_DAYS','transactionId','defineProperty','2\x20minutes','__importDefault','webhook_send','paid','\x20details:','\x20\x20\x20📍\x20Source:\x20','now','\x20payment\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','from','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20',',\x20currentPayments=','confirmedOn','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','status_check','expired','\x20status:\x20','status','../config/database','default','\x20in\x20shop\x20','./loggerService','gateway','5\x20minutes','globalCheckInterval','webhookEvents','\x20seconds\x20(','\x20not\x20enabled\x20for\x20shop\x20','ms)','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','📊\x20[CHECK]\x20Payment\x20','timestamp','EXPIRED','text','\x20commission\x20for\x20shop\x20','\x20updated\x20successfully','application/json',',\x20gateway\x20','10478356rwkLXG','logCoinToPayStatus','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','amountUSDT','paymentDetails'];a38_0x1d30=function(){return _0x418778;};return a38_0x1d30();}const a38_0xcd062d=a38_0x514f;(function(_0x1dc121,_0xa5fe50){const _0x5558da=a38_0x514f,_0x383d58=_0x1dc121();while(!![]){try{const _0x525a1e=-parseInt(_0x5558da(0x234))/0x1+parseInt(_0x5558da(0x239))/0x2*(-parseInt(_0x5558da(0x276))/0x3)+-parseInt(_0x5558da(0x282))/0x4+parseInt(_0x5558da(0x1fd))/0x5*(parseInt(_0x5558da(0x277))/0x6)+-parseInt(_0x5558da(0x2b7))/0x7+-parseInt(_0x5558da(0x2e1))/0x8+parseInt(_0x5558da(0x286))/0x9;if(_0x525a1e===_0xa5fe50)break;else _0x383d58['push'](_0x383d58['shift']());}catch(_0x46f28b){_0x383d58['push'](_0x383d58['shift']());}}}(a38_0x1d30,0xbfd88));function a38_0x514f(_0x3dacb5,_0x371c72){const _0x1d30b5=a38_0x1d30();return a38_0x514f=function(_0x514fce,_0xc71a4f){_0x514fce=_0x514fce-0x1e6;let _0x317985=_0x1d30b5[_0x514fce];return _0x317985;},a38_0x514f(_0x3dacb5,_0x371c72);}var __importDefault=this&&this[a38_0xcd062d(0x290)]||function(_0x1b6ab5){return _0x1b6ab5&&_0x1b6ab5['__esModule']?_0x1b6ab5:{'default':_0x1b6ab5};};Object[a38_0xcd062d(0x28e)](exports,'__esModule',{'value':!![]}),exports[a38_0xcd062d(0x25f)]=exports[a38_0xcd062d(0x22f)]=void 0x0;const coinToPayService_1=require(a38_0xcd062d(0x2d7)),coinToPay2Service_1=require(a38_0xcd062d(0x2d2)),gateway_1=require('../types/gateway'),database_1=__importDefault(require(a38_0xcd062d(0x2a1))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a38_0xcd062d(0x2a4)),currencyService_1=require('./currencyService');class CoinToPayStatusService{constructor(){const _0x63e485=a38_0xcd062d;this[_0x63e485(0x2a7)]=null,this[_0x63e485(0x2e3)]=0x3c*0x3c*0x3e8,this[_0x63e485(0x28c)]=0x5,this[_0x63e485(0x220)]=new Map(),this[_0x63e485(0x200)]=new coinToPayService_1[(_0x63e485(0x2e5))](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x63e485(0x2bf))](),console[_0x63e485(0x209)](_0x63e485(0x2ac));}['schedulePaymentChecks'](_0x476f48,_0x5952d9){const _0x1ffb08=a38_0xcd062d;console[_0x1ffb08(0x209)](_0x1ffb08(0x2c4)),console[_0x1ffb08(0x209)](_0x1ffb08(0x249)+_0x476f48),console[_0x1ffb08(0x209)](_0x1ffb08(0x221)+_0x5952d9),this[_0x1ffb08(0x236)](_0x476f48);const _0x29323b=[],_0x54339a=new Date(),_0x2b9f75=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x1ffb08(0x28f)},{'delay':0x5*0x3c*0x3e8,'description':_0x1ffb08(0x2a6)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x1ffb08(0x209)](_0x1ffb08(0x247)+_0x2b9f75[_0x1ffb08(0x214)]+_0x1ffb08(0x243)+_0x476f48);let _0xde4ff0=0x0;_0x2b9f75[_0x1ffb08(0x256)]((_0x48ebe7,_0x11d46b)=>{const _0x263f08=_0x1ffb08;_0xde4ff0+=_0x48ebe7['delay'];const _0x55da22=setTimeout(async()=>{const _0x4f1f5b=a38_0x514f;console[_0x4f1f5b(0x209)](_0x4f1f5b(0x20e)+(_0x11d46b+0x1)+_0x4f1f5b(0x258)+_0x476f48+_0x4f1f5b(0x280)+_0x48ebe7[_0x4f1f5b(0x25c)]+')');try{await this[_0x4f1f5b(0x275)](_0x476f48),console['log'](_0x4f1f5b(0x297)+(_0x11d46b+0x1)+_0x4f1f5b(0x217)+_0x476f48);}catch(_0x292fdf){console['error'](_0x4f1f5b(0x2f1)+(_0x11d46b+0x1)+_0x4f1f5b(0x281)+_0x476f48+':',_0x292fdf),this[_0x4f1f5b(0x2ee)](_0x476f48,_0x5952d9,_0x292fdf,'status_check',{'checkNumber':_0x11d46b+0x1,'scheduledAfter':_0x48ebe7[_0x4f1f5b(0x25c)],'isIndividualCheck':!![]});}},_0xde4ff0);_0x29323b[_0x263f08(0x289)](_0x55da22),console[_0x263f08(0x209)](_0x263f08(0x2b9)+(_0x11d46b+0x1)+_0x263f08(0x281)+_0x476f48+'\x20in\x20'+_0xde4ff0/0x3e8+_0x263f08(0x2a9)+_0x48ebe7[_0x263f08(0x25c)]+')');});const _0xe4ff0e=setInterval(async()=>{const _0x3bc75f=_0x1ffb08;console[_0x3bc75f(0x209)](_0x3bc75f(0x23c)+_0x476f48);try{const _0x571379=await database_1[_0x3bc75f(0x2a2)][_0x3bc75f(0x23b)]['findUnique']({'where':{'id':_0x476f48},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x571379){console[_0x3bc75f(0x209)](_0x3bc75f(0x260)+_0x476f48+_0x3bc75f(0x2e9)),this[_0x3bc75f(0x236)](_0x476f48);return;}console[_0x3bc75f(0x209)](_0x3bc75f(0x27c)+_0x476f48+_0x3bc75f(0x26a)+_0x571379[_0x3bc75f(0x2a0)]);if(_0x571379[_0x3bc75f(0x2a0)]!==_0x3bc75f(0x22e)){console[_0x3bc75f(0x209)](_0x3bc75f(0x2d9)+_0x476f48+_0x3bc75f(0x2df)+_0x571379[_0x3bc75f(0x2a0)]+',\x20stopping\x20individual\x20checks'),this['clearPaymentTimers'](_0x476f48);return;}const _0x2e68c6=Math[_0x3bc75f(0x20b)]((Date['now']()-_0x571379[_0x3bc75f(0x2eb)][_0x3bc75f(0x2f7)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x2e68c6>=this[_0x3bc75f(0x28c)]){console[_0x3bc75f(0x209)]('⏰\x20[HOURLY]\x20Payment\x20'+_0x476f48+'\x20is\x20older\x20than\x20'+this[_0x3bc75f(0x28c)]+_0x3bc75f(0x25b)),this[_0x3bc75f(0x236)](_0x476f48);return;}await this[_0x3bc75f(0x275)](_0x476f48),console[_0x3bc75f(0x209)](_0x3bc75f(0x273)+_0x476f48);}catch(_0x322a92){console['error'](_0x3bc75f(0x28b)+_0x476f48+':',_0x322a92),this[_0x3bc75f(0x2ee)](_0x476f48,_0x5952d9,_0x322a92,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x29323b[_0x1ffb08(0x289)](_0xe4ff0e),this[_0x1ffb08(0x220)][_0x1ffb08(0x25d)](_0x476f48,{'timers':_0x29323b,'paymentId':_0x476f48,'gatewayPaymentId':_0x5952d9,'createdAt':_0x54339a}),console['log']('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x2b9f75[_0x1ffb08(0x214)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x476f48),console['log'](_0x1ffb08(0x2d1)+this[_0x1ffb08(0x220)][_0x1ffb08(0x2f4)]),this[_0x1ffb08(0x2b8)](_0x476f48,_0x5952d9,'PENDING','PENDING','status_check',{'action':_0x1ffb08(0x28a),'scheduledChecks':_0x2b9f75[_0x1ffb08(0x214)],'firstCheckIn':_0x2b9f75[0x0][_0x1ffb08(0x244)]/0x3e8,'totalTimers':this[_0x1ffb08(0x220)][_0x1ffb08(0x2f4)]});}[a38_0xcd062d(0x236)](_0x51028a){const _0x19a25f=a38_0xcd062d,_0x534e08=this[_0x19a25f(0x220)]['get'](_0x51028a);_0x534e08?(console[_0x19a25f(0x209)](_0x19a25f(0x1f1)+_0x534e08[_0x19a25f(0x270)][_0x19a25f(0x214)]+_0x19a25f(0x231)+_0x51028a),_0x534e08[_0x19a25f(0x270)][_0x19a25f(0x256)]((_0x1ed00a,_0x5f1576)=>{const _0x1ff17d=_0x19a25f;_0x1ed00a&&(clearTimeout(_0x1ed00a),clearInterval(_0x1ed00a),console[_0x1ff17d(0x209)](_0x1ff17d(0x2d5)+(_0x5f1576+0x1)+_0x1ff17d(0x281)+_0x51028a));}),this[_0x19a25f(0x220)][_0x19a25f(0x1eb)](_0x51028a),console[_0x19a25f(0x209)](_0x19a25f(0x2dc)+_0x51028a+_0x19a25f(0x25e)+this[_0x19a25f(0x220)][_0x19a25f(0x2f4)])):console[_0x19a25f(0x209)](_0x19a25f(0x241)+_0x51028a+_0x19a25f(0x2f8));}async['checkSinglePaymentById'](_0x3789d4){const _0x8034f0=a38_0xcd062d;console['log'](_0x8034f0(0x1ed)+_0x3789d4);const _0x451b6d=await database_1['default']['payment'][_0x8034f0(0x2d8)]({'where':{'id':_0x3789d4},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x451b6d){console[_0x8034f0(0x209)]('❌\x20[CHECK]\x20Payment\x20'+_0x3789d4+_0x8034f0(0x204));return;}console['log'](_0x8034f0(0x2af)+_0x3789d4+_0x8034f0(0x268)),console[_0x8034f0(0x209)](_0x8034f0(0x210)+_0x451b6d[_0x8034f0(0x2a5)]),console[_0x8034f0(0x209)](_0x8034f0(0x1f4)+_0x451b6d[_0x8034f0(0x2a0)]),console[_0x8034f0(0x209)](_0x8034f0(0x2cc)+_0x451b6d[_0x8034f0(0x1f8)]),console[_0x8034f0(0x209)](_0x8034f0(0x208)+_0x451b6d['amount']+'\x20'+_0x451b6d[_0x8034f0(0x1fb)]),console[_0x8034f0(0x209)](_0x8034f0(0x278)+_0x451b6d[_0x8034f0(0x23a)]);if(_0x451b6d['gateway']!==_0x8034f0(0x250)&&_0x451b6d[_0x8034f0(0x2a5)]!=='cointopay2'){console[_0x8034f0(0x209)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x3789d4+'\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20'+_0x451b6d[_0x8034f0(0x2a5)]+')');return;}if(_0x451b6d[_0x8034f0(0x2a0)]!==_0x8034f0(0x22e)){console[_0x8034f0(0x209)](_0x8034f0(0x2c6)+_0x3789d4+_0x8034f0(0x2df)+_0x451b6d['status']+_0x8034f0(0x2ea)),this[_0x8034f0(0x236)](_0x3789d4);return;}if(!_0x451b6d[_0x8034f0(0x1f8)]){console['log'](_0x8034f0(0x2c6)+_0x3789d4+_0x8034f0(0x1f6));return;}console[_0x8034f0(0x209)](_0x8034f0(0x2bd)+_0x3789d4+_0x8034f0(0x21f)),await this[_0x8034f0(0x232)](_0x451b6d);}['logCoinToPayStatus'](_0x54938e,_0x853235,_0x2dfce4,_0x3244ad,_0xd1e714,_0xe1a337){const _0x227af7=a38_0xcd062d,_0x4c7487={'type':_0x227af7(0x22d),'paymentId':_0x54938e,'gatewayPaymentId':_0x853235,'oldStatus':_0x2dfce4,'newStatus':_0x3244ad,'source':_0xd1e714,'timestamp':new Date()[_0x227af7(0x245)](),'details':_0xe1a337||{}};loggerService_1['loggerService']['logCoinToPayStatus'](_0x4c7487),console[_0x227af7(0x209)](_0x227af7(0x21b)+_0x54938e+'\x20('+_0x853235+')'),console['log'](_0x227af7(0x262)+_0x2dfce4+'\x20->\x20'+_0x3244ad),console['log'](_0x227af7(0x294)+_0xd1e714),console[_0x227af7(0x209)](_0x227af7(0x252)+_0x4c7487[_0x227af7(0x2b0)]),_0xe1a337&&console[_0x227af7(0x209)]('\x20\x20\x20📝\x20Details:',_0xe1a337);}[a38_0xcd062d(0x2ee)](_0x507b93,_0x50e92e,_0x1469ac,_0x5aa1c0,_0x376d52){const _0xa0128a=a38_0xcd062d,_0x4dc40e={'type':'COINTOPAY_ERROR','paymentId':_0x507b93,'gatewayPaymentId':_0x50e92e,'error':_0x1469ac instanceof Error?{'message':_0x1469ac[_0xa0128a(0x285)],'stack':_0x1469ac[_0xa0128a(0x284)]}:_0x1469ac,'source':_0x5aa1c0,'timestamp':new Date()[_0xa0128a(0x245)](),'context':_0x376d52||{}};loggerService_1[_0xa0128a(0x20c)][_0xa0128a(0x2ee)](_0x4dc40e),console[_0xa0128a(0x237)](_0xa0128a(0x253)+_0x507b93+'\x20('+_0x50e92e+')'),console[_0xa0128a(0x237)]('\x20\x20\x20❌\x20Error:\x20'+(_0x1469ac instanceof Error?_0x1469ac[_0xa0128a(0x285)]:_0x1469ac)),console['error'](_0xa0128a(0x294)+_0x5aa1c0),console[_0xa0128a(0x237)]('\x20\x20\x20📅\x20Time:\x20'+_0x4dc40e[_0xa0128a(0x2b0)]),_0x376d52&&console[_0xa0128a(0x237)](_0xa0128a(0x235),_0x376d52);}['startPeriodicStatusCheck'](){const _0x46ed91=a38_0xcd062d;console[_0x46ed91(0x209)](_0x46ed91(0x2d4)),this[_0x46ed91(0x1ec)]()[_0x46ed91(0x248)](_0x44ddf3=>{const _0x3daa63=_0x46ed91;console['error'](_0x3daa63(0x2db),_0x44ddf3);}),this[_0x46ed91(0x2a7)]=setInterval(async()=>{const _0x6e38a6=_0x46ed91;try{console[_0x6e38a6(0x209)](_0x6e38a6(0x251)),await this[_0x6e38a6(0x1ec)](),console[_0x6e38a6(0x209)](_0x6e38a6(0x219));}catch(_0x1b65eb){console[_0x6e38a6(0x237)](_0x6e38a6(0x2dd),_0x1b65eb);}},this[_0x46ed91(0x2e3)]),console[_0x46ed91(0x209)](_0x46ed91(0x1ff));}[a38_0xcd062d(0x2f2)](){const _0x33f7cb=a38_0xcd062d;console['log'](_0x33f7cb(0x27b));this[_0x33f7cb(0x2a7)]&&(clearInterval(this['globalCheckInterval']),this[_0x33f7cb(0x2a7)]=null,console[_0x33f7cb(0x209)](_0x33f7cb(0x27e)));const _0xe911f6=this[_0x33f7cb(0x220)]['size'];for(const [_0x1a2be1]of this[_0x33f7cb(0x220)]){this[_0x33f7cb(0x236)](_0x1a2be1);}console['log'](_0x33f7cb(0x2de)+_0xe911f6+_0x33f7cb(0x283));}async[a38_0xcd062d(0x1ec)](){const _0x523217=a38_0xcd062d;try{console['log']('🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x90e4fd=await database_1['default']['payment'][_0x523217(0x26d)]({'where':{'gateway':{'in':[_0x523217(0x250),_0x523217(0x2cd)]},'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x523217(0x2f5)+_0x90e4fd[_0x523217(0x214)]+_0x523217(0x24f));if(_0x90e4fd[_0x523217(0x214)]===0x0){console[_0x523217(0x209)](_0x523217(0x264));return;}const _0x300d2=await this[_0x523217(0x269)](_0x90e4fd);console[_0x523217(0x209)]('⏰\x20[GLOBAL]\x20Found\x20'+_0x300d2[_0x523217(0x214)]+_0x523217(0x1f5));let _0x352bb3=0x0,_0x1ff550=0x0;for(const _0x5d98fb of _0x90e4fd){try{if(_0x300d2[_0x523217(0x279)](_0x5d98fb['id'])){console['log'](_0x523217(0x22b)+_0x5d98fb['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x1ff550++;continue;}if(this[_0x523217(0x220)][_0x523217(0x1ee)](_0x5d98fb['id'])){console[_0x523217(0x209)](_0x523217(0x22b)+_0x5d98fb['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x1ff550++;continue;}const _0x23030e=(Date[_0x523217(0x295)]()-_0x5d98fb[_0x523217(0x2eb)][_0x523217(0x2f7)]())/(0x3e8*0x3c*0x3c);if(_0x23030e<0x1){console[_0x523217(0x209)](_0x523217(0x22b)+_0x5d98fb['id']+'\x20is\x20too\x20new\x20('+_0x23030e[_0x523217(0x20a)](0x1)+_0x523217(0x216)),_0x1ff550++;continue;}console[_0x523217(0x209)](_0x523217(0x228)+_0x5d98fb['id']+_0x523217(0x215)+_0x23030e[_0x523217(0x20a)](0x1)+'h)'),await this[_0x523217(0x232)](_0x5d98fb),_0x352bb3++,await new Promise(_0x2a7d94=>setTimeout(_0x2a7d94,0x7d0));}catch(_0x1619a5){console[_0x523217(0x237)](_0x523217(0x224)+_0x5d98fb['id']+':',_0x1619a5),this[_0x523217(0x2ee)](_0x5d98fb['id'],_0x5d98fb[_0x523217(0x1f8)]||_0x523217(0x2f6),_0x1619a5,_0x523217(0x29d),{'isGlobalCheck':!![],'paymentAmount':_0x5d98fb[_0x523217(0x20d)],'paymentCurrency':_0x5d98fb[_0x523217(0x1fb)],'shopId':_0x5d98fb[_0x523217(0x23a)],'createdAt':_0x5d98fb['createdAt']}),loggerService_1[_0x523217(0x20c)]['logWhiteDomainError'](_0x523217(0x250),_0x523217(0x238)+_0x5d98fb['gatewayPaymentId'],_0x1619a5);}}console['log'](_0x523217(0x203)+_0x352bb3+_0x523217(0x1ea)+_0x1ff550+_0x523217(0x22c)+_0x300d2[_0x523217(0x214)]+_0x523217(0x218));}catch(_0x5de502){console['error'](_0x523217(0x2e6),_0x5de502);}}async['checkExpiredPayments'](_0x5d7208){const _0x2f8d58=a38_0xcd062d,_0x183a08=[],_0x453384=new Date();_0x453384[_0x2f8d58(0x205)](_0x453384[_0x2f8d58(0x267)]()-this[_0x2f8d58(0x28c)]),console['log'](_0x2f8d58(0x1f7)+this[_0x2f8d58(0x28c)]+_0x2f8d58(0x2ce)+_0x453384[_0x2f8d58(0x245)]()+')');for(const _0x124bd8 of _0x5d7208){if(_0x124bd8['createdAt']<_0x453384){console['log'](_0x2f8d58(0x1f9)+_0x124bd8['id']+_0x2f8d58(0x23d)+this[_0x2f8d58(0x28c)]+_0x2f8d58(0x225));try{this['logCoinToPayStatus'](_0x124bd8['id'],_0x124bd8[_0x2f8d58(0x1f8)]||'unknown',_0x2f8d58(0x22e),_0x2f8d58(0x2b1),_0x2f8d58(0x2c3),{'reason':_0x2f8d58(0x259)+this['EXPIRY_DAYS']+_0x2f8d58(0x2ec),'createdAt':_0x124bd8[_0x2f8d58(0x2eb)],'daysSinceCreation':Math[_0x2f8d58(0x20b)]((Date['now']()-_0x124bd8[_0x2f8d58(0x2eb)][_0x2f8d58(0x2f7)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x124bd8['amount'],'paymentCurrency':_0x124bd8[_0x2f8d58(0x1fb)],'shopId':_0x124bd8[_0x2f8d58(0x23a)]}),await database_1[_0x2f8d58(0x2a2)][_0x2f8d58(0x23b)]['update']({'where':{'id':_0x124bd8['id']},'data':{'status':_0x2f8d58(0x2b1),'updatedAt':new Date(),'adminNotes':_0x2f8d58(0x1ef)+this['EXPIRY_DAYS']+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x2f8d58(0x2a2)][_0x2f8d58(0x21a)][_0x2f8d58(0x211)]({'data':{'paymentId':_0x124bd8['id'],'shopId':_0x124bd8['shopId'],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x2f8d58(0x2cf)]({'reason':_0x2f8d58(0x259)+this[_0x2f8d58(0x28c)]+_0x2f8d58(0x2ec),'createdAt':_0x124bd8['createdAt'],'expiredAt':new Date()[_0x2f8d58(0x245)](),'daysSinceCreation':Math['floor']((Date[_0x2f8d58(0x295)]()-_0x124bd8['createdAt'][_0x2f8d58(0x2f7)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x2f8d58(0x222)](_0x124bd8,_0x2f8d58(0x2b1)),await this[_0x2f8d58(0x1fe)](_0x124bd8,_0x2f8d58(0x2b1)),this[_0x2f8d58(0x236)](_0x124bd8['id']),_0x183a08[_0x2f8d58(0x289)](_0x124bd8['id']),console[_0x2f8d58(0x209)]('✅\x20[EXPIRY]\x20Payment\x20'+_0x124bd8['id']+_0x2f8d58(0x299)+this[_0x2f8d58(0x28c)]+_0x2f8d58(0x265));}catch(_0x430f42){console['error'](_0x2f8d58(0x22a)+_0x124bd8['id']+':',_0x430f42),this['logCoinToPayError'](_0x124bd8['id'],_0x124bd8[_0x2f8d58(0x1f8)]||_0x2f8d58(0x2f6),_0x430f42,_0x2f8d58(0x2c3),{'reason':_0x2f8d58(0x242),'createdAt':_0x124bd8[_0x2f8d58(0x2eb)],'daysSinceCreation':Math[_0x2f8d58(0x20b)]((Date[_0x2f8d58(0x295)]()-_0x124bd8[_0x2f8d58(0x2eb)][_0x2f8d58(0x2f7)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x183a08;}async[a38_0xcd062d(0x232)](_0x3f9058){const _0x3a82ff=a38_0xcd062d;if(!_0x3f9058[_0x3a82ff(0x1f8)]){console[_0x3a82ff(0x209)](_0x3a82ff(0x2c6)+_0x3f9058['id']+_0x3a82ff(0x230));return;}console['log']('🔍\x20[CHECK]\x20Checking\x20'+_0x3f9058[_0x3a82ff(0x2a5)]+'\x20payment\x20'+_0x3f9058['id']+'\x20('+_0x3f9058['gatewayPaymentId']+')');try{let _0x274b7c;_0x3f9058[_0x3a82ff(0x2a5)]==='cointopay2'?(_0x274b7c=await this[_0x3a82ff(0x287)]['checkPaymentStatus'](_0x3f9058[_0x3a82ff(0x1f8)]),console[_0x3a82ff(0x209)](_0x3a82ff(0x21c)+_0x3f9058['id']+'\x20status:\x20'+_0x274b7c[_0x3a82ff(0x2a0)])):(_0x274b7c=await this[_0x3a82ff(0x200)]['checkPaymentStatus'](_0x3f9058[_0x3a82ff(0x1f8)]),console[_0x3a82ff(0x209)](_0x3a82ff(0x2ae)+_0x3f9058['id']+_0x3a82ff(0x29f)+_0x274b7c[_0x3a82ff(0x2a0)]));_0x274b7c[_0x3a82ff(0x2bb)]&&console[_0x3a82ff(0x209)](_0x3a82ff(0x2af)+_0x3f9058['id']+_0x3a82ff(0x293),{'iban':_0x274b7c[_0x3a82ff(0x2bb)][_0x3a82ff(0x2ca)]||_0x3a82ff(0x26e),'transactionId':_0x274b7c['paymentDetails'][_0x3a82ff(0x28d)],'createdOn':_0x274b7c[_0x3a82ff(0x2bb)][_0x3a82ff(0x21d)],'confirmedOn':_0x274b7c[_0x3a82ff(0x2bb)]['confirmedOn']||'not\x20confirmed'});if(_0x274b7c['status']!==_0x3f9058[_0x3a82ff(0x2a0)]){console['log'](_0x3a82ff(0x2be)+_0x3f9058['id']+_0x3a82ff(0x24d)+_0x3f9058[_0x3a82ff(0x2a0)]+_0x3a82ff(0x207)+_0x274b7c[_0x3a82ff(0x2a0)]),this[_0x3a82ff(0x2b8)](_0x3f9058['id'],_0x3f9058[_0x3a82ff(0x1f8)],_0x3f9058[_0x3a82ff(0x2a0)],_0x274b7c[_0x3a82ff(0x2a0)],'status_check',{'paymentDetails':_0x274b7c[_0x3a82ff(0x2bb)],'amount':_0x274b7c[_0x3a82ff(0x20d)],'currency':_0x274b7c[_0x3a82ff(0x1fb)],'shopId':_0x3f9058[_0x3a82ff(0x23a)],'checkTimestamp':new Date()[_0x3a82ff(0x245)]()});const _0x22dc80={'status':_0x274b7c[_0x3a82ff(0x2a0)],'updatedAt':new Date()};if(_0x274b7c[_0x3a82ff(0x2a0)]===_0x3a82ff(0x2c2)&&_0x3f9058['status']!==_0x3a82ff(0x2c2)){_0x22dc80['paidAt']=new Date();if(!_0x3f9058[_0x3a82ff(0x2ba)]){const _0x4975a7=await currencyService_1[_0x3a82ff(0x212)][_0x3a82ff(0x2c0)](_0x3f9058[_0x3a82ff(0x20d)],_0x3f9058['currency']);_0x22dc80['amountUSDT']=_0x4975a7;const _0x3b23bc=await this[_0x3a82ff(0x2c1)](_0x3f9058[_0x3a82ff(0x23a)],_0x3f9058[_0x3a82ff(0x2a5)]),_0x5a1927=_0x4975a7*(0x1-_0x3b23bc/0x64);_0x22dc80[_0x3a82ff(0x2d6)]=_0x5a1927,console[_0x3a82ff(0x209)](_0x3a82ff(0x233)+_0x3f9058['id']+_0x3a82ff(0x25a)),console[_0x3a82ff(0x209)](_0x3a82ff(0x257)+_0x3f9058['amount']+'\x20'+_0x3f9058[_0x3a82ff(0x1fb)]+_0x3a82ff(0x1e8)+_0x4975a7[_0x3a82ff(0x20a)](0x6)+'\x20USDT'),console[_0x3a82ff(0x209)]('\x20\x20\x20Gateway\x20'+_0x3f9058['gateway']+_0x3a82ff(0x2ef)+_0x3b23bc+'%'),console[_0x3a82ff(0x209)]('\x20\x20\x20Amount\x20after\x20commission:\x20'+_0x5a1927[_0x3a82ff(0x20a)](0x6)+'\x20USDT');}console[_0x3a82ff(0x209)](_0x3a82ff(0x233)+_0x3f9058['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x22dc80[_0x3a82ff(0x263)]['toISOString']());}if(_0x274b7c[_0x3a82ff(0x2bb)]){const _0x3ac85b=_0x274b7c[_0x3a82ff(0x2bb)];_0x3ac85b['iban']&&(_0x22dc80['remitterIban']=_0x3ac85b[_0x3a82ff(0x2ca)],console[_0x3a82ff(0x209)](_0x3a82ff(0x2e0)+_0x3ac85b[_0x3a82ff(0x2ca)]));if(_0x3ac85b['bankDetails']){const _0x54fe1f=_0x3f9058[_0x3a82ff(0x226)]||'',_0xb13d47='Bank\x20Details:\x20'+_0x3ac85b['bankDetails'];_0x22dc80[_0x3a82ff(0x226)]=_0x54fe1f?_0x54fe1f+'\x0a\x0a'+_0xb13d47:_0xb13d47,console['log']('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x3ac85b[_0x3a82ff(0x28d)]&&console[_0x3a82ff(0x209)](_0x3a82ff(0x2ad)+_0x3ac85b[_0x3a82ff(0x28d)]),_0x3ac85b['confirmedOn']&&console['log']('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x3ac85b[_0x3a82ff(0x29b)]);}await database_1[_0x3a82ff(0x2a2)][_0x3a82ff(0x23b)]['update']({'where':{'id':_0x3f9058['id']},'data':_0x22dc80});if(_0x274b7c[_0x3a82ff(0x2a0)]===_0x3a82ff(0x2c2)&&_0x3f9058[_0x3a82ff(0x2a0)]!==_0x3a82ff(0x2c2)){console[_0x3a82ff(0x209)](_0x3a82ff(0x2c9)+_0x3f9058['id']+_0x3a82ff(0x1e6));const _0x54b4d6=await database_1['default'][_0x3a82ff(0x23b)]['findUnique']({'where':{'id':_0x3f9058['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x54b4d6?.['paymentLinkId']&&_0x54b4d6[_0x3a82ff(0x24e)])try{const _0x4a919a=_0x54b4d6[_0x3a82ff(0x24e)];console[_0x3a82ff(0x209)](_0x3a82ff(0x27f)+_0x4a919a['id']+':\x20type='+_0x4a919a['type']+_0x3a82ff(0x29a)+_0x4a919a['currentPayments']+_0x3a82ff(0x2e7)+_0x4a919a[_0x3a82ff(0x2a0)]);const _0x248260=_0x4a919a['currentPayments']+0x1,_0x339ed0=_0x4a919a[_0x3a82ff(0x255)]===_0x3a82ff(0x288)?'COMPLETED':_0x4a919a[_0x3a82ff(0x2a0)];await database_1['default'][_0x3a82ff(0x24e)][_0x3a82ff(0x1fc)]({'where':{'id':_0x4a919a['id']},'data':{'currentPayments':_0x248260,'status':_0x339ed0,'updatedAt':new Date()}}),console[_0x3a82ff(0x209)](_0x3a82ff(0x2da)+_0x4a919a['id']+_0x3a82ff(0x240)+_0x4a919a[_0x3a82ff(0x272)]+_0x3a82ff(0x1e8)+_0x248260+_0x3a82ff(0x2e7)+_0x4a919a[_0x3a82ff(0x2a0)]+_0x3a82ff(0x1e8)+_0x339ed0);}catch(_0x494fe9){console[_0x3a82ff(0x237)](_0x3a82ff(0x24a),_0x494fe9);}else console[_0x3a82ff(0x209)](_0x3a82ff(0x2c9)+_0x3f9058['id']+_0x3a82ff(0x29c));}await database_1[_0x3a82ff(0x2a2)][_0x3a82ff(0x21a)]['create']({'data':{'paymentId':_0x3f9058['id'],'shopId':_0x3f9058[_0x3a82ff(0x23a)],'event':_0x3a82ff(0x1f2)+_0x274b7c[_0x3a82ff(0x2a0)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x3f9058[_0x3a82ff(0x2a0)],'newStatus':_0x274b7c[_0x3a82ff(0x2a0)],'paymentDetails':_0x274b7c[_0x3a82ff(0x2bb)],'checkedAt':new Date()[_0x3a82ff(0x245)]()})}}),await this[_0x3a82ff(0x222)](_0x3f9058,_0x274b7c[_0x3a82ff(0x2a0)]),await this[_0x3a82ff(0x1fe)](_0x3f9058,_0x274b7c[_0x3a82ff(0x2a0)]),_0x274b7c[_0x3a82ff(0x2a0)]!==_0x3a82ff(0x22e)&&(console[_0x3a82ff(0x209)](_0x3a82ff(0x274)+_0x3f9058['id']+_0x3a82ff(0x21e)+_0x274b7c[_0x3a82ff(0x2a0)]+_0x3a82ff(0x27a)),this[_0x3a82ff(0x236)](_0x3f9058['id'])),console['log'](_0x3a82ff(0x2bd)+_0x3f9058['id']+_0x3a82ff(0x2b4));}else console[_0x3a82ff(0x209)](_0x3a82ff(0x2af)+_0x3f9058['id']+'\x20status\x20unchanged\x20('+_0x274b7c[_0x3a82ff(0x2a0)]+')'),this[_0x3a82ff(0x2b8)](_0x3f9058['id'],_0x3f9058[_0x3a82ff(0x1f8)],_0x3f9058[_0x3a82ff(0x2a0)],_0x274b7c[_0x3a82ff(0x2a0)],_0x3a82ff(0x29d),{'statusUnchanged':!![],'paymentDetails':_0x274b7c[_0x3a82ff(0x2bb)],'amount':_0x274b7c[_0x3a82ff(0x20d)],'currency':_0x274b7c[_0x3a82ff(0x1fb)],'shopId':_0x3f9058[_0x3a82ff(0x23a)],'checkTimestamp':new Date()[_0x3a82ff(0x245)]()});}catch(_0x2ac661){console[_0x3a82ff(0x237)](_0x3a82ff(0x20f)+_0x3f9058['id']+':',_0x2ac661),this[_0x3a82ff(0x2ee)](_0x3f9058['id'],_0x3f9058[_0x3a82ff(0x1f8)],_0x2ac661,'status_check',{'paymentAmount':_0x3f9058[_0x3a82ff(0x20d)],'paymentCurrency':_0x3f9058[_0x3a82ff(0x1fb)],'shopId':_0x3f9058[_0x3a82ff(0x23a)],'createdAt':_0x3f9058[_0x3a82ff(0x2eb)]}),await database_1[_0x3a82ff(0x2a2)][_0x3a82ff(0x21a)][_0x3a82ff(0x211)]({'data':{'paymentId':_0x3f9058['id'],'shopId':_0x3f9058[_0x3a82ff(0x23a)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x3a82ff(0x2cf)]({'error':_0x2ac661 instanceof Error?_0x2ac661[_0x3a82ff(0x285)]:_0x3a82ff(0x23e),'gatewayPaymentId':_0x3f9058[_0x3a82ff(0x1f8)],'checkedAt':new Date()[_0x3a82ff(0x245)]()})}});}}async[a38_0xcd062d(0x222)](_0x3912ca,_0x30b47e){const _0x4cd9ee=a38_0xcd062d,_0x2b5abc=Date[_0x4cd9ee(0x295)]();try{const _0x40373c=_0x3912ca[_0x4cd9ee(0x26f)],_0x383a89=_0x40373c[_0x4cd9ee(0x223)];if(!_0x383a89?.[_0x4cd9ee(0x1fa)]){console['log'](_0x4cd9ee(0x1e7)+_0x40373c['id']);return;}const _0x323f9b=_0x30b47e===_0x4cd9ee(0x2c2)?_0x4cd9ee(0x2c5):_0x30b47e===_0x4cd9ee(0x2f9)?_0x4cd9ee(0x24c):_0x30b47e==='EXPIRED'?_0x4cd9ee(0x24c):'payment.pending';if(!_0x383a89[_0x4cd9ee(0x2a8)]?.['includes'](_0x323f9b)){console[_0x4cd9ee(0x209)](_0x4cd9ee(0x2e4)+_0x323f9b+_0x4cd9ee(0x2aa)+_0x40373c['id']);return;}const _0x2c06de=(0x0,gateway_1[_0x4cd9ee(0x27d)])(_0x3912ca[_0x4cd9ee(0x2a5)])||_0x3912ca['gateway'],_0x54dc9d={'event':_0x323f9b,'payment':{'id':_0x3912ca['id'],'order_id':_0x3912ca[_0x4cd9ee(0x2cb)],'gateway_order_id':_0x3912ca['gatewayOrderId'],'gateway':_0x2c06de,'amount':_0x3912ca[_0x4cd9ee(0x20d)],'currency':_0x3912ca[_0x4cd9ee(0x1fb)],'status':_0x30b47e['toLowerCase'](),'customer_email':_0x3912ca[_0x4cd9ee(0x2d0)],'customer_name':_0x3912ca[_0x4cd9ee(0x1f3)],'created_at':_0x3912ca['createdAt'],'updated_at':new Date()}},_0x4fd012=await fetch(_0x383a89['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x4cd9ee(0x2b5),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x54dc9d)}),_0x1c7547=Date[_0x4cd9ee(0x295)]()-_0x2b5abc,_0x3583b0=_0x4fd012['ok']?_0x4cd9ee(0x271):await _0x4fd012[_0x4cd9ee(0x2b2)]();loggerService_1[_0x4cd9ee(0x20c)]['logShopWebhookSent'](_0x3912ca['shopId'],_0x383a89[_0x4cd9ee(0x1fa)],_0x323f9b,_0x4fd012[_0x4cd9ee(0x2a0)],_0x1c7547,_0x54dc9d),console[_0x4cd9ee(0x209)](_0x4cd9ee(0x2c8)+_0x383a89[_0x4cd9ee(0x1fa)]+_0x4cd9ee(0x23f)+_0x4fd012[_0x4cd9ee(0x2a0)]+'\x20('+_0x1c7547+_0x4cd9ee(0x2ab));}catch(_0x122502){console[_0x4cd9ee(0x237)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x122502),loggerService_1[_0x4cd9ee(0x20c)][_0x4cd9ee(0x2e2)](_0x3912ca['shopId'],_0x3912ca['shop']?.['settings']?.[_0x4cd9ee(0x1fa)]||_0x4cd9ee(0x2f6),_0x4cd9ee(0x291),_0x122502,{});}}async[a38_0xcd062d(0x1fe)](_0x5bb3c2,_0x283922){const _0x217eae=a38_0xcd062d;try{const _0x314762={'PENDING':_0x217eae(0x229),'PAID':_0x217eae(0x292),'FAILED':_0x217eae(0x2f0),'EXPIRED':_0x217eae(0x29e)},_0x4a2af9=_0x314762[_0x283922];if(!_0x4a2af9||_0x4a2af9===_0x217eae(0x229))return;await telegramBotService_1[_0x217eae(0x2d3)][_0x217eae(0x2c7)](_0x5bb3c2[_0x217eae(0x23a)],_0x5bb3c2,_0x4a2af9);}catch(_0xf7715b){console[_0x217eae(0x237)](_0x217eae(0x202),_0xf7715b);}}async[a38_0xcd062d(0x227)](_0x1f2552){const _0xe10ddc=a38_0xcd062d;console[_0xe10ddc(0x209)](_0xe10ddc(0x261)+_0x1f2552);const _0x4a64b0=await database_1[_0xe10ddc(0x2a2)]['payment']['findUnique']({'where':{'id':_0x1f2552},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4a64b0)throw new Error(_0xe10ddc(0x26b));if(_0x4a64b0['gateway']!=='cointopay'&&_0x4a64b0[_0xe10ddc(0x2a5)]!==_0xe10ddc(0x2cd))throw new Error(_0xe10ddc(0x24b));console[_0xe10ddc(0x209)](_0xe10ddc(0x266)+_0x4a64b0[_0xe10ddc(0x2a5)]+_0xe10ddc(0x296)+_0x1f2552),await this[_0xe10ddc(0x232)](_0x4a64b0),console[_0xe10ddc(0x209)]('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x1f2552);}[a38_0xcd062d(0x2ed)](){const _0xa1f3f1=a38_0xcd062d,_0x56b56c=this[_0xa1f3f1(0x2a7)]?this[_0xa1f3f1(0x2e3)]:undefined,_0xda1357=Array[_0xa1f3f1(0x298)](this[_0xa1f3f1(0x220)][_0xa1f3f1(0x2f3)]())['map'](_0x3b4a89=>({'paymentId':_0x3b4a89[_0xa1f3f1(0x246)],'gatewayPaymentId':_0x3b4a89[_0xa1f3f1(0x1f8)],'createdAt':_0x3b4a89[_0xa1f3f1(0x2eb)],'timersCount':_0x3b4a89['timers'][_0xa1f3f1(0x214)]}));return{'isActive':!!this[_0xa1f3f1(0x2a7)],'globalCheckIntervalMinutes':this[_0xa1f3f1(0x2e3)]/(0x3e8*0x3c),'expiryDays':this[_0xa1f3f1(0x28c)],'activeIndividualTimers':this['paymentTimers'][_0xa1f3f1(0x2f4)],'nextGlobalCheckIn':_0x56b56c,'paymentTimersDetails':_0xda1357};}['getPaymentTimerInfo'](_0x234c3f){const _0x574c05=a38_0xcd062d,_0x100f79=this[_0x574c05(0x220)][_0x574c05(0x1e9)](_0x234c3f);if(_0x100f79)return{'hasTimers':!![],'timersCount':_0x100f79[_0x574c05(0x270)][_0x574c05(0x214)],'createdAt':_0x100f79[_0x574c05(0x2eb)],'gatewayPaymentId':_0x100f79[_0x574c05(0x1f8)]};return{'hasTimers':![]};}async[a38_0xcd062d(0x2c1)](_0x5800ba,_0x134be6){const _0x26e55c=a38_0xcd062d;try{const _0x6b00ec=await database_1[_0x26e55c(0x2a2)][_0x26e55c(0x26f)][_0x26e55c(0x2d8)]({'where':{'id':_0x5800ba},'select':{'gatewaySettings':!![]}});if(!_0x6b00ec?.['gatewaySettings'])return console['log'](_0x26e55c(0x206)+_0x5800ba+_0x26e55c(0x26c)),0xa;const _0x23f670=JSON[_0x26e55c(0x254)](_0x6b00ec[_0x26e55c(0x2e8)]);for(const [_0x191f1e,_0x59d53d]of Object[_0x26e55c(0x2bc)](_0x23f670)){if(_0x191f1e[_0x26e55c(0x201)]()===_0x134be6[_0x26e55c(0x201)]()){const _0x2d634c=_0x59d53d['commission']||0xa;return console['log']('Gateway\x20'+_0x134be6+_0x26e55c(0x2b3)+_0x5800ba+':\x20'+_0x2d634c+'%'),_0x2d634c;}}return console[_0x26e55c(0x209)](_0x26e55c(0x1f0)+_0x134be6+_0x26e55c(0x2a3)+_0x5800ba+',\x20using\x20default\x2010%'),0xa;}catch(_0x117df6){return console[_0x26e55c(0x237)](_0x26e55c(0x213)+_0x5800ba+_0x26e55c(0x2b6)+_0x134be6+':',_0x117df6),0xa;}}}exports[a38_0xcd062d(0x22f)]=CoinToPayStatusService,exports[a38_0xcd062d(0x25f)]=new CoinToPayStatusService();