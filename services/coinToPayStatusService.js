'use strict';const a35_0x49b914=a35_0x2eb4;(function(_0x2aa720,_0x27f39d){const _0x35f9e5=a35_0x2eb4,_0x19d532=_0x2aa720();while(!![]){try{const _0x32bf43=-parseInt(_0x35f9e5(0x1f5))/0x1+-parseInt(_0x35f9e5(0x1ac))/0x2*(parseInt(_0x35f9e5(0x1ce))/0x3)+-parseInt(_0x35f9e5(0x1b4))/0x4+-parseInt(_0x35f9e5(0x1a0))/0x5*(-parseInt(_0x35f9e5(0x196))/0x6)+parseInt(_0x35f9e5(0x192))/0x7*(-parseInt(_0x35f9e5(0x1cb))/0x8)+-parseInt(_0x35f9e5(0x1c2))/0x9+parseInt(_0x35f9e5(0x178))/0xa;if(_0x32bf43===_0x27f39d)break;else _0x19d532['push'](_0x19d532['shift']());}catch(_0x2d2c8d){_0x19d532['push'](_0x19d532['shift']());}}}(a35_0x238e,0x6517e));function a35_0x2eb4(_0x2cfff0,_0x185e0d){const _0x238e85=a35_0x238e();return a35_0x2eb4=function(_0x2eb4b9,_0x121311){_0x2eb4b9=_0x2eb4b9-0x175;let _0x111bf4=_0x238e85[_0x2eb4b9];return _0x111bf4;},a35_0x2eb4(_0x2cfff0,_0x185e0d);}var __importDefault=this&&this[a35_0x49b914(0x1db)]||function(_0x5702ed){const _0x5e158b=a35_0x49b914;return _0x5702ed&&_0x5702ed[_0x5e158b(0x1d3)]?_0x5702ed:{'default':_0x5702ed};};Object[a35_0x49b914(0x184)](exports,'__esModule',{'value':!![]}),exports[a35_0x49b914(0x17e)]=exports[a35_0x49b914(0x1b8)]=void 0x0;const coinToPayService_1=require(a35_0x49b914(0x1d2)),database_1=__importDefault(require(a35_0x49b914(0x1a4))),telegramBotService_1=require(a35_0x49b914(0x189)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x2da646=a35_0x49b914;this['checkInterval']=null,this[_0x2da646(0x1c9)]=0x3c*0x3c*0x3e8,this[_0x2da646(0x201)]=0x5,this['coinToPayService']=new coinToPayService_1[(_0x2da646(0x1b0))]();}[a35_0x49b914(0x1fd)](){const _0x2b3b90=a35_0x49b914;console[_0x2b3b90(0x1f3)]('🪙\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)'),this[_0x2b3b90(0x1b5)]()[_0x2b3b90(0x1fe)](_0x5a4cd3=>{const _0x4e124c=_0x2b3b90;console[_0x4e124c(0x1ad)](_0x4e124c(0x18c),_0x5a4cd3);}),this[_0x2b3b90(0x1fb)]=setInterval(async()=>{const _0x349897=_0x2b3b90;try{await this[_0x349897(0x1b5)]();}catch(_0x93f444){console[_0x349897(0x1ad)](_0x349897(0x1d4),_0x93f444);}},this[_0x2b3b90(0x1c9)]),console[_0x2b3b90(0x1f3)](_0x2b3b90(0x1e3));}['stopPeriodicStatusCheck'](){const _0x5f44d0=a35_0x49b914;this[_0x5f44d0(0x1fb)]&&(clearInterval(this[_0x5f44d0(0x1fb)]),this[_0x5f44d0(0x1fb)]=null,console[_0x5f44d0(0x1f3)](_0x5f44d0(0x1f0)));}async[a35_0x49b914(0x1b5)](){const _0x4d2f90=a35_0x49b914;try{const _0x52e53f=await database_1['default'][_0x4d2f90(0x1c0)][_0x4d2f90(0x1e0)]({'where':{'gateway':_0x4d2f90(0x1ae),'status':_0x4d2f90(0x194),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x52e53f[_0x4d2f90(0x187)]===0x0){console[_0x4d2f90(0x1f3)](_0x4d2f90(0x1a1));return;}console[_0x4d2f90(0x1f3)]('🪙\x20Checking\x20'+_0x52e53f['length']+_0x4d2f90(0x1d1));const _0x59d964=await this[_0x4d2f90(0x19a)](_0x52e53f);console[_0x4d2f90(0x1f3)](_0x4d2f90(0x1c6)+_0x59d964['length']+_0x4d2f90(0x1f1));for(const _0x886d7c of _0x52e53f){try{if(_0x59d964[_0x4d2f90(0x1cd)](_0x886d7c['id'])){console['log'](_0x4d2f90(0x18f)+_0x886d7c['id']+_0x4d2f90(0x177));continue;}await this[_0x4d2f90(0x195)](_0x886d7c),await new Promise(_0xb96363=>setTimeout(_0xb96363,0x7d0));}catch(_0x484279){console[_0x4d2f90(0x1ad)](_0x4d2f90(0x1fa)+_0x886d7c['id']+':',_0x484279),loggerService_1[_0x4d2f90(0x18b)][_0x4d2f90(0x183)](_0x4d2f90(0x1ae),_0x4d2f90(0x1c4)+_0x886d7c[_0x4d2f90(0x1ff)],_0x484279);}}console[_0x4d2f90(0x1f3)](_0x4d2f90(0x190)+_0x52e53f[_0x4d2f90(0x187)]+_0x4d2f90(0x197));}catch(_0x59fb5d){console['error'](_0x4d2f90(0x1f9),_0x59fb5d);}}async['checkExpiredPayments'](_0x3e70f6){const _0x27ee1a=a35_0x49b914,_0x2ac7f9=[],_0x3c3174=new Date();_0x3c3174[_0x27ee1a(0x1e4)](_0x3c3174['getDate']()-this['EXPIRY_DAYS']),console[_0x27ee1a(0x1f3)](_0x27ee1a(0x1a2)+this['EXPIRY_DAYS']+_0x27ee1a(0x17c)+_0x3c3174[_0x27ee1a(0x1e6)]()+')');for(const _0x9af652 of _0x3e70f6){if(_0x9af652[_0x27ee1a(0x1e5)]<_0x3c3174){console[_0x27ee1a(0x1f3)](_0x27ee1a(0x18f)+_0x9af652['id']+'\x20is\x20older\x20than\x20'+this[_0x27ee1a(0x201)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{await database_1[_0x27ee1a(0x17b)][_0x27ee1a(0x1c0)]['update']({'where':{'id':_0x9af652['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x27ee1a(0x191)+this[_0x27ee1a(0x201)]+_0x27ee1a(0x1c8)}}),await database_1[_0x27ee1a(0x17b)][_0x27ee1a(0x1b9)][_0x27ee1a(0x1eb)]({'data':{'paymentId':_0x9af652['id'],'shopId':_0x9af652['shopId'],'event':_0x27ee1a(0x1ef),'statusCode':0xc8,'responseBody':JSON[_0x27ee1a(0x1d0)]({'reason':'Payment\x20older\x20than\x20'+this[_0x27ee1a(0x201)]+_0x27ee1a(0x1d5),'createdAt':_0x9af652[_0x27ee1a(0x1e5)],'expiredAt':new Date()[_0x27ee1a(0x1e6)](),'daysSinceCreation':Math[_0x27ee1a(0x19d)]((Date[_0x27ee1a(0x1cc)]()-_0x9af652[_0x27ee1a(0x1e5)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x27ee1a(0x1d6)](_0x9af652,_0x27ee1a(0x202)),await this[_0x27ee1a(0x200)](_0x9af652,_0x27ee1a(0x202)),_0x2ac7f9[_0x27ee1a(0x1d7)](_0x9af652['id']),console[_0x27ee1a(0x1f3)](_0x27ee1a(0x186)+_0x9af652['id']+_0x27ee1a(0x1c7)+this[_0x27ee1a(0x201)]+'-day\x20timeout');}catch(_0x5aa24e){console[_0x27ee1a(0x1ad)]('Failed\x20to\x20expire\x20payment\x20'+_0x9af652['id']+':',_0x5aa24e);}}}return _0x2ac7f9;}async[a35_0x49b914(0x195)](_0x304dc1){const _0xb04e9b=a35_0x49b914;if(!_0x304dc1[_0xb04e9b(0x1ff)]){console[_0xb04e9b(0x1f3)](_0xb04e9b(0x1b3)+_0x304dc1['id']+_0xb04e9b(0x193));return;}console['log']('🔍\x20Checking\x20CoinToPay\x20payment\x20'+_0x304dc1['id']+'\x20('+_0x304dc1[_0xb04e9b(0x1ff)]+')');try{const _0x252701=await this[_0xb04e9b(0x1ec)][_0xb04e9b(0x1b7)](_0x304dc1[_0xb04e9b(0x1ff)]);console['log'](_0xb04e9b(0x1ed)+_0x304dc1['id']+_0xb04e9b(0x1e8)+_0x252701[_0xb04e9b(0x199)]);_0x252701['paymentDetails']&&console['log'](_0xb04e9b(0x1ed)+_0x304dc1['id']+_0xb04e9b(0x1c5),{'iban':_0x252701[_0xb04e9b(0x19e)]['iban']||_0xb04e9b(0x1b6),'transactionId':_0x252701['paymentDetails'][_0xb04e9b(0x1ee)],'createdOn':_0x252701[_0xb04e9b(0x19e)][_0xb04e9b(0x1b1)],'confirmedOn':_0x252701[_0xb04e9b(0x19e)][_0xb04e9b(0x1f4)]||_0xb04e9b(0x175)});if(_0x252701[_0xb04e9b(0x199)]!==_0x304dc1[_0xb04e9b(0x199)]){console['log'](_0xb04e9b(0x17d)+_0x304dc1['id']+_0xb04e9b(0x198)+_0x304dc1[_0xb04e9b(0x199)]+_0xb04e9b(0x1ba)+_0x252701[_0xb04e9b(0x199)]);const _0x4a1fc5={'status':_0x252701[_0xb04e9b(0x199)],'updatedAt':new Date()};_0x252701['status']==='PAID'&&_0x304dc1[_0xb04e9b(0x199)]!==_0xb04e9b(0x1e2)&&(_0x4a1fc5[_0xb04e9b(0x188)]=new Date(),console['log'](_0xb04e9b(0x18a)+_0x304dc1['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x4a1fc5[_0xb04e9b(0x188)]['toISOString']()));if(_0x252701['paymentDetails']){const _0x56fa24=_0x252701['paymentDetails'];_0x56fa24[_0xb04e9b(0x1b2)]&&(_0x4a1fc5['remitterIban']=_0x56fa24[_0xb04e9b(0x1b2)],console[_0xb04e9b(0x1f3)](_0xb04e9b(0x1ca)+_0x56fa24[_0xb04e9b(0x1b2)]));if(_0x56fa24[_0xb04e9b(0x1c3)]){const _0xbd5773=_0x304dc1[_0xb04e9b(0x1e1)]||'',_0xed9516=_0xb04e9b(0x1f8)+_0x56fa24[_0xb04e9b(0x1c3)];_0x4a1fc5[_0xb04e9b(0x1e1)]=_0xbd5773?_0xbd5773+'\x0a\x0a'+_0xed9516:_0xed9516,console[_0xb04e9b(0x1f3)]('🏦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x56fa24['transactionId']&&console[_0xb04e9b(0x1f3)]('🆔\x20Transaction\x20ID:\x20'+_0x56fa24[_0xb04e9b(0x1ee)]),_0x56fa24[_0xb04e9b(0x1f4)]&&console[_0xb04e9b(0x1f3)](_0xb04e9b(0x1a7)+_0x56fa24[_0xb04e9b(0x1f4)]);}await database_1[_0xb04e9b(0x17b)][_0xb04e9b(0x1c0)][_0xb04e9b(0x1a6)]({'where':{'id':_0x304dc1['id']},'data':_0x4a1fc5}),await database_1['default'][_0xb04e9b(0x1b9)][_0xb04e9b(0x1eb)]({'data':{'paymentId':_0x304dc1['id'],'shopId':_0x304dc1['shopId'],'event':'cointopay_status_check_'+_0x252701['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0xb04e9b(0x1d0)]({'oldStatus':_0x304dc1[_0xb04e9b(0x199)],'newStatus':_0x252701['status'],'paymentDetails':_0x252701[_0xb04e9b(0x19e)],'checkedAt':new Date()[_0xb04e9b(0x1e6)]()})}}),await this[_0xb04e9b(0x1d6)](_0x304dc1,_0x252701['status']),await this[_0xb04e9b(0x200)](_0x304dc1,_0x252701[_0xb04e9b(0x199)]),console['log'](_0xb04e9b(0x186)+_0x304dc1['id']+_0xb04e9b(0x1f7));}else console[_0xb04e9b(0x1f3)](_0xb04e9b(0x1ed)+_0x304dc1['id']+_0xb04e9b(0x1da)+_0x252701['status']+')');}catch(_0x34bd89){console[_0xb04e9b(0x1ad)](_0xb04e9b(0x17f)+_0x304dc1['id']+':',_0x34bd89),await database_1[_0xb04e9b(0x17b)][_0xb04e9b(0x1b9)][_0xb04e9b(0x1eb)]({'data':{'paymentId':_0x304dc1['id'],'shopId':_0x304dc1[_0xb04e9b(0x1fc)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0xb04e9b(0x1d0)]({'error':_0x34bd89 instanceof Error?_0x34bd89[_0xb04e9b(0x17a)]:'Unknown\x20error','gatewayPaymentId':_0x304dc1['gatewayPaymentId'],'checkedAt':new Date()[_0xb04e9b(0x1e6)]()})}});}}async['sendShopWebhook'](_0x16fa29,_0x2d6567){const _0x7c9855=a35_0x49b914,_0x27abe7=Date[_0x7c9855(0x1cc)]();try{const _0x43ad9b=_0x16fa29[_0x7c9855(0x179)],_0x57fe6b=_0x43ad9b[_0x7c9855(0x1cf)];if(!_0x57fe6b?.[_0x7c9855(0x1ab)]){console['log'](_0x7c9855(0x1a3)+_0x43ad9b['id']);return;}const _0x4360f0=_0x2d6567==='PAID'?_0x7c9855(0x1e9):_0x2d6567===_0x7c9855(0x1ea)?'payment.failed':_0x2d6567===_0x7c9855(0x202)?_0x7c9855(0x180):_0x7c9855(0x1bb);if(!_0x57fe6b[_0x7c9855(0x1a5)]?.[_0x7c9855(0x1cd)](_0x4360f0)){console[_0x7c9855(0x1f3)](_0x7c9855(0x1aa)+_0x4360f0+_0x7c9855(0x1af)+_0x43ad9b['id']);return;}const _0x4d9455={'event':_0x4360f0,'payment':{'id':_0x16fa29['id'],'order_id':_0x16fa29['orderId'],'gateway_order_id':_0x16fa29[_0x7c9855(0x18d)],'gateway':'0100','amount':_0x16fa29[_0x7c9855(0x1bc)],'currency':_0x16fa29[_0x7c9855(0x1be)],'status':_0x2d6567[_0x7c9855(0x1d8)](),'customer_email':_0x16fa29[_0x7c9855(0x1d9)],'customer_name':_0x16fa29[_0x7c9855(0x1c1)],'created_at':_0x16fa29[_0x7c9855(0x1e5)],'updated_at':new Date()}},_0x2e4f26=await fetch(_0x57fe6b[_0x7c9855(0x1ab)],{'method':_0x7c9855(0x19c),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x4d9455)}),_0xcaa516=Date[_0x7c9855(0x1cc)]()-_0x27abe7,_0x10d054=_0x2e4f26['ok']?_0x7c9855(0x1de):await _0x2e4f26[_0x7c9855(0x1bf)]();loggerService_1[_0x7c9855(0x18b)][_0x7c9855(0x1a8)](_0x16fa29[_0x7c9855(0x1fc)],_0x57fe6b[_0x7c9855(0x1ab)],_0x4360f0,_0x2e4f26[_0x7c9855(0x199)],_0xcaa516,_0x4d9455),console[_0x7c9855(0x1f3)]('Shop\x20webhook\x20sent\x20to\x20'+_0x57fe6b['webhookUrl']+_0x7c9855(0x18e)+_0x2e4f26[_0x7c9855(0x199)]+'\x20('+_0xcaa516+'ms)');}catch(_0x1b9924){console['error'](_0x7c9855(0x1f2),_0x1b9924),loggerService_1[_0x7c9855(0x18b)][_0x7c9855(0x1dc)](_0x16fa29[_0x7c9855(0x1fc)],_0x16fa29[_0x7c9855(0x179)]?.[_0x7c9855(0x1cf)]?.[_0x7c9855(0x1ab)]||_0x7c9855(0x1a9),'webhook_send',_0x1b9924,{});}}async[a35_0x49b914(0x200)](_0x19917c,_0x11826d){const _0x49679a=a35_0x49b914;try{const _0x17ce34={'PENDING':_0x49679a(0x181),'PAID':'paid','FAILED':_0x49679a(0x176),'EXPIRED':_0x49679a(0x19f)},_0x5222b3=_0x17ce34[_0x11826d];if(!_0x5222b3||_0x5222b3===_0x49679a(0x181))return;await telegramBotService_1['telegramBotService'][_0x49679a(0x1e7)](_0x19917c[_0x49679a(0x1fc)],_0x19917c,_0x5222b3);}catch(_0x49891c){console[_0x49679a(0x1ad)](_0x49679a(0x185),_0x49891c);}}async[a35_0x49b914(0x1f6)](_0x1a5005){const _0x1d57a8=a35_0x49b914,_0x373788=await database_1[_0x1d57a8(0x17b)][_0x1d57a8(0x1c0)][_0x1d57a8(0x19b)]({'where':{'id':_0x1a5005},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x373788)throw new Error(_0x1d57a8(0x182));if(_0x373788[_0x1d57a8(0x1bd)]!==_0x1d57a8(0x1ae))throw new Error(_0x1d57a8(0x1dd));await this['checkSinglePayment'](_0x373788);}[a35_0x49b914(0x1df)](){const _0x4b19b8=a35_0x49b914,_0x106eb3=this[_0x4b19b8(0x1fb)]?this[_0x4b19b8(0x1c9)]:undefined;return{'isActive':!!this['checkInterval'],'checkIntervalMinutes':this[_0x4b19b8(0x1c9)]/(0x3e8*0x3c),'expiryDays':this[_0x4b19b8(0x201)],'nextCheckIn':_0x106eb3};}}exports[a35_0x49b914(0x1b8)]=CoinToPayStatusService,exports[a35_0x49b914(0x17e)]=new CoinToPayStatusService();function a35_0x238e(){const _0x484063=['iban','⚠️\x20Payment\x20','2083424IlwMTo','checkAllPendingPayments','not\x20found','checkPaymentStatus','CoinToPayStatusService','webhookLog','\x20to\x20','payment.pending','amount','gateway','currency','text','payment','customerName','5048919zNmYPb','bankDetails','/status/','\x20details:','⏰\x20Found\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20days\x20without\x20payment\x20confirmation','CHECK_INTERVAL_MS','🏦\x20Saved\x20IBAN:\x20','632ozRBTC','now','includes','111njkoGm','settings','stringify','\x20pending\x20CoinToPay\x20payments','./gateways/coinToPayService','__esModule','Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20days','sendShopWebhook','push','toLowerCase','customerEmail','\x20status\x20unchanged\x20(','__importDefault','logShopWebhookError','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','Success','getServiceStats','findMany','adminNotes','PAID','✅\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','setDate','createdAt','toISOString','sendPaymentNotification','\x20status:\x20','payment.success','FAILED','create','coinToPayService','📊\x20Payment\x20','transactionId','cointopay_auto_expired','🛑\x20CoinToPay\x20status\x20checking\x20stopped','\x20expired\x20CoinToPay\x20payments','Failed\x20to\x20send\x20shop\x20webhook:','log','confirmedOn','245235ESPLcZ','checkPaymentById','\x20updated\x20successfully','Bank\x20Details:\x20','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','checkInterval','shopId','startPeriodicStatusCheck','catch','gatewayPaymentId','sendPaymentStatusNotification','EXPIRY_DAYS','EXPIRED','not\x20confirmed','failed','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','18979240YRxxlS','shop','message','default','\x20days\x20(created\x20before\x20','🔄\x20Updating\x20payment\x20','coinToPayStatusService','Failed\x20to\x20check\x20payment\x20','payment.failed','created','Payment\x20not\x20found','logWhiteDomainError','defineProperty','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','✅\x20Payment\x20','length','paidAt','./telegramBotService','💰\x20Payment\x20','loggerService','Initial\x20CoinToPay\x20status\x20check\x20failed:','gatewayOrderId','\x20with\x20status\x20','⏰\x20Payment\x20','✅\x20Completed\x20checking\x20','Automatically\x20expired\x20after\x20','2177ubAdSa','\x20has\x20no\x20gatewayPaymentId,\x20skipping','PENDING','checkSinglePayment','6vrFYjz','\x20CoinToPay\x20payments','\x20status\x20from\x20','status','checkExpiredPayments','findUnique','POST','floor','paymentDetails','expired','180035NhZzuy','🪙\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','⏰\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','../config/database','webhookEvents','update','✅\x20Transaction\x20confirmed\x20on:\x20','logShopWebhookSent','unknown','Webhook\x20event\x20','webhookUrl','9092eLjOeO','error','cointopay','\x20not\x20enabled\x20for\x20shop\x20','CoinToPayService','createdOn'];a35_0x238e=function(){return _0x484063;};return a35_0x238e();}