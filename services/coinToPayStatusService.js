'use strict';function a42_0x2ede(){const _0x1d4dec=['‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','webhookUrl','update','length','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20for\x20payment\x20','not\x20confirmed','startPeriodicStatusCheck','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20\x20\x20Amount\x20after\x20commission:\x20','cointopay_status_check_error','application/json','createdAt','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','paymentTimers','/status/','shopId','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','2\x20minutes','gatewayOrderId','getTime','\x20USDT','cointopay','üìà\x20[COINTOPAY]\x20Payment\x20','\x20checked,\x20','./currencyService','status','webhookLog','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','toFixed','\x20status\x20unchanged\x20(','log','gateway','\x20is\x20too\x20new\x20(','checkPaymentById','toISOString','4844775szkBBx','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20current\x20status:\x20','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','‚è∞\x20[EXPIRY]\x20Payment\x20','auto_expire','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20',',\x20currentPayments=','1211428xGbirf','checkAllPendingPayments','status_check','‚è∞\x20[GLOBAL]\x20Payment\x20','‚ùå\x20[HOURLY]\x20Payment\x20','sendPaymentStatusNotification','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','payment.failed','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','payment.success','\x20timers\x20for\x20payment\x20',',\x20status=','settings','\x20\x20\x20-\x20Status:\x20','PAID','\x20\x20\x20üìä\x20Status:\x20','\x20\x20\x20Amount:\x20','\x20to\x20clear','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','CoinToPayStatusService','98652vnAllr','shop','Bank\x20Details:\x20','getPaymentTimerInfo','expired','adminNotes','üìä\x20[CHECK]\x20Payment\x20','orderId','\x20\x20\x20Gateway\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','default','../config/database','21928QzIeVU','\x20has\x20no\x20gatewayPaymentId,\x20skipping','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','schedule_created','coinToPayService','üîç\x20[CHECK]\x20Checking\x20','floor','paid','globalCheckInterval','push','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','sendShopWebhook','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','EXPIRY_DAYS','\x20marked\x20as\x20paid\x20at:\x20','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20seconds\x20(','amount','EXPIRED','Automatically\x20expired\x20after\x20','\x20\x20\x20-\x20ShopId:\x20','payment.pending','14DKBavO','960RDRHXm','\x20\x20\x20-\x20paymentId:\x20','Unknown\x20error','\x20initial\x20timers\x20for\x20payment\x20','ü™ô\x20[GLOBAL]\x20Found\x20','getDate','error','\x20not\x20found,\x20clearing\x20timers','paymentLink','\x20status\x20changed\x20to\x20','findUnique','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','792VyTikY','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','values','checkPaymentStatus','\x20updated\x20successfully','catch','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','coinToPay2Service','Gateway\x20','logCoinToPayError','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','confirmedOn','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20\x20\x20üìç\x20Source:\x20','toLowerCase','Payment\x20older\x20than\x20','failed','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','timestamp','paidAt','\x20commission:\x20','create','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','checkSinglePaymentById','\x20skipped,\x20','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','PENDING','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','\x20days,\x20marking\x20as\x20EXPIRED','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','created','sendPaymentNotification','customerName','transactionId','\x20days\x20without\x20payment\x20confirmation','stopPeriodicStatusCheck','\x20days','198lDjHoS','unknown','getGatewayCommission','remitterIban','1\x20minute','\x20expired','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','checkSinglePayment','gatewayPaymentId','coinToPayStatusService','message','Failed\x20to\x20mark\x20payment\x20as\x20expired','timers','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','size','customerEmail','logWhiteDomainError','parse','\x20to\x20','3oSAvob','logShopWebhookSent','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','cointopay_auto_expired','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','currentPayments','iban','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20\x20\x20üìù\x20Details:','\x20pending\x20CoinToPay\x20payments','Payment\x20System/1.0','stringify','bankDetails','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','paymentId','has','GLOBAL_CHECK_INTERVAL_MS','now','paymentDetails','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20',',\x20stopping\x20individual\x20checks','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','\x20is\x20older\x20than\x20','\x20\x20\x20-\x20Gateway:\x20','COMPLETED','includes','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','currency','entries','4327iOJisW','../types/gateway','get','\x20status\x20from\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','checkExpiredPayments','23860UNFczW','telegramBotService','forEach','schedulePaymentChecks','paymentLinkId','delay','\x20commission\x20for\x20shop\x20','clearPaymentTimers','\x20is\x20valid\x20for\x20checking,\x20proceeding...','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','from','\x20days\x20(created\x20before\x20','üí∞\x20[CHECK]\x20Payment\x20','\x20amounts\x20calculated:','logShopWebhookError','__importDefault','delete','651lVfBKa','\x20details:','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20\x20\x20üìù\x20Context:','type','No\x20specific\x20commission\x20found\x20for\x20gateway\x20',',\x20gateway\x20','5484rLldLA','./loggerService','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','‚úÖ\x20[EXPIRY]\x20Payment\x20','üßπ\x20[DEBUG]\x20Clearing\x20','\x20not\x20found\x20in\x20database','amountUSDT','.\x20Remaining\x20active\x20timers:\x20','gatewaySettings','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20(age:\x20','convertToUSDT','\x20payment\x20','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20not\x20enabled\x20for\x20shop\x20','\x20status\x20is\x20','COINTOPAY_ERROR','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20->\x20','FAILED','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','5\x20minutes','\x20expired\x20CoinToPay\x20payments','cointopay2','currencyService','\x20in\x20shop\x20','\x20status:\x20','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20\x20\x20üìÖ\x20Time:\x20','\x20updated:\x20currentPayments=','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','amountAfterGatewayCommissionUSDT','./gateways/coinToPayService','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','loggerService','logCoinToPayStatus','h),\x20skipping\x20global\x20check','‚úÖ\x20[CHECK]\x20Payment\x20','payment','./telegramBotService','defineProperty','__esModule','26QmQRFy','Failed\x20to\x20send\x20shop\x20webhook:','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20individual\x20payment\x20timers','\x20(after\x20','üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'];a42_0x2ede=function(){return _0x1d4dec;};return a42_0x2ede();}const a42_0x3e4240=a42_0x21fc;(function(_0x429784,_0xdeeab8){const _0x1974f4=a42_0x21fc,_0x2a572d=_0x429784();while(!![]){try{const _0x3a159c=-parseInt(_0x1974f4(0x292))/0x1*(parseInt(_0x1974f4(0x1c4))/0x2)+parseInt(_0x1974f4(0x273))/0x3*(-parseInt(_0x1974f4(0x1f6))/0x4)+parseInt(_0x1974f4(0x22e))/0x5*(-parseInt(_0x1974f4(0x19a))/0x6)+parseInt(_0x1974f4(0x193))/0x7*(parseInt(_0x1974f4(0x217))/0x8)+parseInt(_0x1974f4(0x23b))/0x9*(parseInt(_0x1974f4(0x298))/0xa)+-parseInt(_0x1974f4(0x260))/0xb*(parseInt(_0x1974f4(0x20b))/0xc)+parseInt(_0x1974f4(0x1ee))/0xd*(parseInt(_0x1974f4(0x22d))/0xe);if(_0x3a159c===_0xdeeab8)break;else _0x2a572d['push'](_0x2a572d['shift']());}catch(_0x19903e){_0x2a572d['push'](_0x2a572d['shift']());}}}(a42_0x2ede,0x25d66));function a42_0x21fc(_0x185d11,_0x2cf317){const _0x2ede09=a42_0x2ede();return a42_0x21fc=function(_0x21fcf7,_0x51ebad){_0x21fcf7=_0x21fcf7-0x188;let _0x5bf2c9=_0x2ede09[_0x21fcf7];return _0x5bf2c9;},a42_0x21fc(_0x185d11,_0x2cf317);}var __importDefault=this&&this[a42_0x3e4240(0x191)]||function(_0x4be786){return _0x4be786&&_0x4be786['__esModule']?_0x4be786:{'default':_0x4be786};};Object[a42_0x3e4240(0x1c2)](exports,a42_0x3e4240(0x1c3),{'value':!![]}),exports[a42_0x3e4240(0x269)]=exports[a42_0x3e4240(0x20a)]=void 0x0;const coinToPayService_1=require(a42_0x3e4240(0x1ba)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require(a42_0x3e4240(0x293)),database_1=__importDefault(require(a42_0x3e4240(0x216))),telegramBotService_1=require(a42_0x3e4240(0x1c1)),loggerService_1=require(a42_0x3e4240(0x19b)),currencyService_1=require(a42_0x3e4240(0x1e3));class CoinToPayStatusService{constructor(){const _0x1428b4=a42_0x3e4240;this['globalCheckInterval']=null,this[_0x1428b4(0x283)]=0x3c*0x3c*0x3e8,this[_0x1428b4(0x224)]=0x5,this[_0x1428b4(0x1d8)]=new Map(),this[_0x1428b4(0x21b)]=new coinToPayService_1['CoinToPayService'](),this[_0x1428b4(0x242)]=new coinToPay2Service_1['CoinToPay2Service'](),console[_0x1428b4(0x1e9)]('ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}[a42_0x3e4240(0x29b)](_0x76a620,_0xc8ff0b){const _0x21f9c8=a42_0x3e4240;console[_0x21f9c8(0x1e9)](_0x21f9c8(0x1a7)),console[_0x21f9c8(0x1e9)](_0x21f9c8(0x22f)+_0x76a620),console[_0x21f9c8(0x1e9)](_0x21f9c8(0x214)+_0xc8ff0b),this[_0x21f9c8(0x189)](_0x76a620);const _0x968d4f=[],_0x2c37cb=new Date(),_0x42572a=[{'delay':0x1*0x3c*0x3e8,'description':_0x21f9c8(0x264)},{'delay':0x2*0x3c*0x3e8,'description':_0x21f9c8(0x1dc)},{'delay':0x5*0x3c*0x3e8,'description':_0x21f9c8(0x1af)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x21f9c8(0x1e9)]('ü™ô\x20[DEBUG]\x20Creating\x20'+_0x42572a[_0x21f9c8(0x1cd)]+_0x21f9c8(0x231)+_0x76a620);let _0x287c1a=0x0;_0x42572a[_0x21f9c8(0x29a)]((_0x2a42a5,_0x11280e)=>{const _0x5315f0=_0x21f9c8;_0x287c1a+=_0x2a42a5[_0x5315f0(0x29d)];const _0xabbd13=setTimeout(async()=>{const _0x250dc6=_0x5315f0;console[_0x250dc6(0x1e9)](_0x250dc6(0x1f1)+(_0x11280e+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x76a620+_0x250dc6(0x1c8)+_0x2a42a5['description']+')');try{await this[_0x250dc6(0x252)](_0x76a620),console['log'](_0x250dc6(0x256)+(_0x11280e+0x1)+'\x20completed\x20for\x20payment\x20'+_0x76a620);}catch(_0x41b0e7){console[_0x250dc6(0x234)](_0x250dc6(0x1ca)+(_0x11280e+0x1)+'\x20for\x20payment\x20'+_0x76a620+':',_0x41b0e7),this[_0x250dc6(0x244)](_0x76a620,_0xc8ff0b,_0x41b0e7,_0x250dc6(0x1f8),{'checkNumber':_0x11280e+0x1,'scheduledAfter':_0x2a42a5['description'],'isIndividualCheck':!![]});}},_0x287c1a);_0x968d4f[_0x5315f0(0x220)](_0xabbd13),console[_0x5315f0(0x1e9)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x11280e+0x1)+_0x5315f0(0x1cf)+_0x76a620+'\x20in\x20'+_0x287c1a/0x3e8+_0x5315f0(0x227)+_0x2a42a5['description']+')');});const _0x4f5913=setInterval(async()=>{const _0x374c91=_0x21f9c8;console[_0x374c91(0x1e9)](_0x374c91(0x1ab)+_0x76a620);try{const _0x52fe83=await database_1[_0x374c91(0x215)][_0x374c91(0x1c0)][_0x374c91(0x238)]({'where':{'id':_0x76a620},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x52fe83){console[_0x374c91(0x1e9)](_0x374c91(0x1fa)+_0x76a620+_0x374c91(0x235)),this[_0x374c91(0x189)](_0x76a620);return;}console[_0x374c91(0x1e9)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x76a620+_0x374c91(0x1f0)+_0x52fe83['status']);if(_0x52fe83[_0x374c91(0x1e4)]!==_0x374c91(0x255)){console[_0x374c91(0x1e9)]('‚úÖ\x20[HOURLY]\x20Payment\x20'+_0x76a620+_0x374c91(0x1a9)+_0x52fe83[_0x374c91(0x1e4)]+_0x374c91(0x287)),this[_0x374c91(0x189)](_0x76a620);return;}const _0x28d089=Math[_0x374c91(0x21d)]((Date[_0x374c91(0x284)]()-_0x52fe83['createdAt'][_0x374c91(0x1de)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x28d089>=this[_0x374c91(0x224)]){console[_0x374c91(0x1e9)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x76a620+_0x374c91(0x28b)+this['EXPIRY_DAYS']+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x374c91(0x189)](_0x76a620);return;}await this['checkSinglePaymentById'](_0x76a620),console[_0x374c91(0x1e9)](_0x374c91(0x254)+_0x76a620);}catch(_0x122d0a){console[_0x374c91(0x234)](_0x374c91(0x19c)+_0x76a620+':',_0x122d0a),this[_0x374c91(0x244)](_0x76a620,_0xc8ff0b,_0x122d0a,_0x374c91(0x1f8),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x968d4f[_0x21f9c8(0x220)](_0x4f5913),this[_0x21f9c8(0x1d8)]['set'](_0x76a620,{'timers':_0x968d4f,'paymentId':_0x76a620,'gatewayPaymentId':_0xc8ff0b,'createdAt':_0x2c37cb}),console['log'](_0x21f9c8(0x1f4)+_0x42572a['length']+_0x21f9c8(0x27a)+_0x76a620),console[_0x21f9c8(0x1e9)](_0x21f9c8(0x23c)+this[_0x21f9c8(0x1d8)][_0x21f9c8(0x26e)]),this[_0x21f9c8(0x1bd)](_0x76a620,_0xc8ff0b,'PENDING',_0x21f9c8(0x255),_0x21f9c8(0x1f8),{'action':_0x21f9c8(0x21a),'scheduledChecks':_0x42572a[_0x21f9c8(0x1cd)],'firstCheckIn':_0x42572a[0x0][_0x21f9c8(0x29d)]/0x3e8,'totalTimers':this[_0x21f9c8(0x1d8)][_0x21f9c8(0x26e)]});}[a42_0x3e4240(0x189)](_0x155dc8){const _0x5cd3e9=a42_0x3e4240,_0x17e17e=this[_0x5cd3e9(0x1d8)][_0x5cd3e9(0x294)](_0x155dc8);_0x17e17e?(console['log'](_0x5cd3e9(0x19e)+_0x17e17e['timers']['length']+_0x5cd3e9(0x201)+_0x155dc8),_0x17e17e[_0x5cd3e9(0x26c)]['forEach']((_0x5e90a7,_0x150132)=>{const _0x4f16ea=_0x5cd3e9;_0x5e90a7&&(clearTimeout(_0x5e90a7),clearInterval(_0x5e90a7),console[_0x4f16ea(0x1e9)]('üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x150132+0x1)+_0x4f16ea(0x1cf)+_0x155dc8));}),this[_0x5cd3e9(0x1d8)][_0x5cd3e9(0x192)](_0x155dc8),console['log'](_0x5cd3e9(0x1d2)+_0x155dc8+_0x5cd3e9(0x1a1)+this[_0x5cd3e9(0x1d8)][_0x5cd3e9(0x26e)])):console[_0x5cd3e9(0x1e9)](_0x5cd3e9(0x209)+_0x155dc8+_0x5cd3e9(0x208));}async['checkSinglePaymentById'](_0x316938){const _0x3696d4=a42_0x3e4240;console[_0x3696d4(0x1e9)](_0x3696d4(0x223)+_0x316938);const _0x2134c0=await database_1[_0x3696d4(0x215)][_0x3696d4(0x1c0)][_0x3696d4(0x238)]({'where':{'id':_0x316938},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2134c0){console[_0x3696d4(0x1e9)]('‚ùå\x20[CHECK]\x20Payment\x20'+_0x316938+_0x3696d4(0x19f));return;}console['log'](_0x3696d4(0x211)+_0x316938+'\x20found:'),console[_0x3696d4(0x1e9)](_0x3696d4(0x28c)+_0x2134c0['gateway']),console[_0x3696d4(0x1e9)](_0x3696d4(0x204)+_0x2134c0[_0x3696d4(0x1e4)]),console['log']('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x2134c0[_0x3696d4(0x268)]),console[_0x3696d4(0x1e9)]('\x20\x20\x20-\x20Amount:\x20'+_0x2134c0[_0x3696d4(0x228)]+'\x20'+_0x2134c0[_0x3696d4(0x290)]),console['log'](_0x3696d4(0x22b)+_0x2134c0[_0x3696d4(0x1da)]);if(_0x2134c0[_0x3696d4(0x1ea)]!==_0x3696d4(0x1e0)&&_0x2134c0[_0x3696d4(0x1ea)]!=='cointopay2'){console['log'](_0x3696d4(0x241)+_0x316938+_0x3696d4(0x280)+_0x2134c0[_0x3696d4(0x1ea)]+')');return;}if(_0x2134c0[_0x3696d4(0x1e4)]!==_0x3696d4(0x255)){console[_0x3696d4(0x1e9)](_0x3696d4(0x241)+_0x316938+_0x3696d4(0x1a9)+_0x2134c0['status']+',\x20stopping\x20individual\x20checks'),this[_0x3696d4(0x189)](_0x316938);return;}if(!_0x2134c0[_0x3696d4(0x268)]){console[_0x3696d4(0x1e9)](_0x3696d4(0x241)+_0x316938+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x3696d4(0x1e9)](_0x3696d4(0x1bf)+_0x316938+_0x3696d4(0x18a)),await this['checkSinglePayment'](_0x2134c0);}[a42_0x3e4240(0x1bd)](_0xdfd2e8,_0x8bd791,_0xe60898,_0x42aeb0,_0x1ed3f5,_0x507e5){const _0x1881ba=a42_0x3e4240,_0x115a8e={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0xdfd2e8,'gatewayPaymentId':_0x8bd791,'oldStatus':_0xe60898,'newStatus':_0x42aeb0,'source':_0x1ed3f5,'timestamp':new Date()[_0x1881ba(0x1ed)](),'details':_0x507e5||{}};loggerService_1[_0x1881ba(0x1bc)][_0x1881ba(0x1bd)](_0x115a8e),console[_0x1881ba(0x1e9)](_0x1881ba(0x251)+_0xdfd2e8+'\x20('+_0x8bd791+')'),console[_0x1881ba(0x1e9)](_0x1881ba(0x206)+_0xe60898+_0x1881ba(0x1ac)+_0x42aeb0),console[_0x1881ba(0x1e9)](_0x1881ba(0x248)+_0x1ed3f5),console['log'](_0x1881ba(0x1b6)+_0x115a8e[_0x1881ba(0x24d)]),_0x507e5&&console['log'](_0x1881ba(0x27b),_0x507e5);}[a42_0x3e4240(0x244)](_0x4cc8b3,_0x476c57,_0x5391b0,_0x1f3206,_0x32d693){const _0x2f2b63=a42_0x3e4240,_0x44535a={'type':_0x2f2b63(0x1aa),'paymentId':_0x4cc8b3,'gatewayPaymentId':_0x476c57,'error':_0x5391b0 instanceof Error?{'message':_0x5391b0['message'],'stack':_0x5391b0['stack']}:_0x5391b0,'source':_0x1f3206,'timestamp':new Date()[_0x2f2b63(0x1ed)](),'context':_0x32d693||{}};loggerService_1[_0x2f2b63(0x1bc)][_0x2f2b63(0x244)](_0x44535a),console[_0x2f2b63(0x234)](_0x2f2b63(0x26d)+_0x4cc8b3+'\x20('+_0x476c57+')'),console[_0x2f2b63(0x234)]('\x20\x20\x20‚ùå\x20Error:\x20'+(_0x5391b0 instanceof Error?_0x5391b0[_0x2f2b63(0x26a)]:_0x5391b0)),console[_0x2f2b63(0x234)](_0x2f2b63(0x248)+_0x1f3206),console[_0x2f2b63(0x234)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x44535a[_0x2f2b63(0x24d)]),_0x32d693&&console[_0x2f2b63(0x234)](_0x2f2b63(0x196),_0x32d693);}[a42_0x3e4240(0x1d1)](){const _0x160c89=a42_0x3e4240;console[_0x160c89(0x1e9)](_0x160c89(0x1ce)),this[_0x160c89(0x1f7)]()[_0x160c89(0x240)](_0x44cd09=>{const _0x838bd7=_0x160c89;console[_0x838bd7(0x234)](_0x838bd7(0x277),_0x44cd09);}),this[_0x160c89(0x21f)]=setInterval(async()=>{const _0x576590=_0x160c89;try{console[_0x576590(0x1e9)](_0x576590(0x289)),await this[_0x576590(0x1f7)](),console[_0x576590(0x1e9)](_0x576590(0x1b8));}catch(_0xd37529){console[_0x576590(0x234)](_0x576590(0x258),_0xd37529);}},this[_0x160c89(0x283)]),console[_0x160c89(0x1e9)]('‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a42_0x3e4240(0x25e)](){const _0x7c8654=a42_0x3e4240;console[_0x7c8654(0x1e9)](_0x7c8654(0x1a3));this['globalCheckInterval']&&(clearInterval(this[_0x7c8654(0x21f)]),this['globalCheckInterval']=null,console[_0x7c8654(0x1e9)](_0x7c8654(0x1c6)));const _0x123d54=this[_0x7c8654(0x1d8)][_0x7c8654(0x26e)];for(const [_0x182279]of this[_0x7c8654(0x1d8)]){this[_0x7c8654(0x189)](_0x182279);}console[_0x7c8654(0x1e9)]('üõë\x20[SHUTDOWN]\x20Cleared\x20'+_0x123d54+_0x7c8654(0x1c7));}async[a42_0x3e4240(0x1f7)](){const _0x2258ee=a42_0x3e4240;try{console[_0x2258ee(0x1e9)](_0x2258ee(0x1ff));const _0x29a40f=await database_1['default'][_0x2258ee(0x1c0)]['findMany']({'where':{'gateway':{'in':[_0x2258ee(0x1e0),_0x2258ee(0x1b1)]},'status':_0x2258ee(0x255),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x2258ee(0x1e9)](_0x2258ee(0x232)+_0x29a40f['length']+_0x2258ee(0x27c));if(_0x29a40f[_0x2258ee(0x1cd)]===0x0){console['log'](_0x2258ee(0x1fe));return;}const _0x55e87f=await this[_0x2258ee(0x297)](_0x29a40f);console[_0x2258ee(0x1e9)]('‚è∞\x20[GLOBAL]\x20Found\x20'+_0x55e87f['length']+_0x2258ee(0x1b0));let _0x567b4e=0x0,_0x399764=0x0;for(const _0x532849 of _0x29a40f){try{if(_0x55e87f['includes'](_0x532849['id'])){console[_0x2258ee(0x1e9)](_0x2258ee(0x1f9)+_0x532849['id']+_0x2258ee(0x247)),_0x399764++;continue;}if(this[_0x2258ee(0x1d8)][_0x2258ee(0x282)](_0x532849['id'])){console[_0x2258ee(0x1e9)](_0x2258ee(0x1f9)+_0x532849['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x399764++;continue;}const _0x146123=(Date[_0x2258ee(0x284)]()-_0x532849[_0x2258ee(0x1d6)][_0x2258ee(0x1de)]())/(0x3e8*0x3c*0x3c);if(_0x146123<0x1){console[_0x2258ee(0x1e9)](_0x2258ee(0x1f9)+_0x532849['id']+_0x2258ee(0x1eb)+_0x146123['toFixed'](0x1)+_0x2258ee(0x1be)),_0x399764++;continue;}console[_0x2258ee(0x1e9)](_0x2258ee(0x1fc)+_0x532849['id']+_0x2258ee(0x1a4)+_0x146123[_0x2258ee(0x1e7)](0x1)+'h)'),await this[_0x2258ee(0x267)](_0x532849),_0x567b4e++,await new Promise(_0x497636=>setTimeout(_0x497636,0x7d0));}catch(_0x225429){console[_0x2258ee(0x234)](_0x2258ee(0x195)+_0x532849['id']+':',_0x225429),this[_0x2258ee(0x244)](_0x532849['id'],_0x532849[_0x2258ee(0x268)]||_0x2258ee(0x261),_0x225429,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x532849[_0x2258ee(0x228)],'paymentCurrency':_0x532849[_0x2258ee(0x290)],'shopId':_0x532849[_0x2258ee(0x1da)],'createdAt':_0x532849[_0x2258ee(0x1d6)]}),loggerService_1['loggerService'][_0x2258ee(0x270)]('cointopay',_0x2258ee(0x1d9)+_0x532849['gatewayPaymentId'],_0x225429);}}console['log'](_0x2258ee(0x239)+_0x567b4e+_0x2258ee(0x1e2)+_0x399764+_0x2258ee(0x253)+_0x55e87f['length']+_0x2258ee(0x265));}catch(_0x47d3ab){console[_0x2258ee(0x234)](_0x2258ee(0x28f),_0x47d3ab);}}async[a42_0x3e4240(0x297)](_0x4a3bee){const _0x388fe0=a42_0x3e4240,_0x4fd33b=[],_0x287e5a=new Date();_0x287e5a['setDate'](_0x287e5a[_0x388fe0(0x233)]()-this['EXPIRY_DAYS']),console['log'](_0x388fe0(0x288)+this['EXPIRY_DAYS']+_0x388fe0(0x18d)+_0x287e5a[_0x388fe0(0x1ed)]()+')');for(const _0x426d57 of _0x4a3bee){if(_0x426d57[_0x388fe0(0x1d6)]<_0x287e5a){console[_0x388fe0(0x1e9)](_0x388fe0(0x1f2)+_0x426d57['id']+_0x388fe0(0x28b)+this['EXPIRY_DAYS']+_0x388fe0(0x257));try{this[_0x388fe0(0x1bd)](_0x426d57['id'],_0x426d57['gatewayPaymentId']||'unknown',_0x388fe0(0x255),_0x388fe0(0x229),_0x388fe0(0x1f3),{'reason':'Payment\x20older\x20than\x20'+this[_0x388fe0(0x224)]+'\x20days','createdAt':_0x426d57[_0x388fe0(0x1d6)],'daysSinceCreation':Math[_0x388fe0(0x21d)]((Date['now']()-_0x426d57[_0x388fe0(0x1d6)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x426d57['amount'],'paymentCurrency':_0x426d57[_0x388fe0(0x290)],'shopId':_0x426d57['shopId']}),await database_1[_0x388fe0(0x215)][_0x388fe0(0x1c0)][_0x388fe0(0x1cc)]({'where':{'id':_0x426d57['id']},'data':{'status':_0x388fe0(0x229),'updatedAt':new Date(),'adminNotes':_0x388fe0(0x22a)+this[_0x388fe0(0x224)]+_0x388fe0(0x25d)}}),await database_1['default'][_0x388fe0(0x1e5)][_0x388fe0(0x250)]({'data':{'paymentId':_0x426d57['id'],'shopId':_0x426d57[_0x388fe0(0x1da)],'event':_0x388fe0(0x276),'statusCode':0xc8,'responseBody':JSON[_0x388fe0(0x27e)]({'reason':_0x388fe0(0x24a)+this[_0x388fe0(0x224)]+_0x388fe0(0x25f),'createdAt':_0x426d57[_0x388fe0(0x1d6)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x388fe0(0x21d)]((Date[_0x388fe0(0x284)]()-_0x426d57['createdAt'][_0x388fe0(0x1de)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x388fe0(0x222)](_0x426d57,_0x388fe0(0x229)),await this[_0x388fe0(0x1fb)](_0x426d57,_0x388fe0(0x229)),this[_0x388fe0(0x189)](_0x426d57['id']),_0x4fd33b[_0x388fe0(0x220)](_0x426d57['id']),console[_0x388fe0(0x1e9)](_0x388fe0(0x19d)+_0x426d57['id']+_0x388fe0(0x1db)+this[_0x388fe0(0x224)]+'-day\x20timeout');}catch(_0x7aa85d){console[_0x388fe0(0x234)](_0x388fe0(0x219)+_0x426d57['id']+':',_0x7aa85d),this[_0x388fe0(0x244)](_0x426d57['id'],_0x426d57[_0x388fe0(0x268)]||'unknown',_0x7aa85d,_0x388fe0(0x1f3),{'reason':_0x388fe0(0x26b),'createdAt':_0x426d57[_0x388fe0(0x1d6)],'daysSinceCreation':Math[_0x388fe0(0x21d)]((Date[_0x388fe0(0x284)]()-_0x426d57['createdAt'][_0x388fe0(0x1de)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x4fd33b;}async['checkSinglePayment'](_0x1c49e9){const _0x49f352=a42_0x3e4240;if(!_0x1c49e9[_0x49f352(0x268)]){console['log'](_0x49f352(0x241)+_0x1c49e9['id']+_0x49f352(0x218));return;}console[_0x49f352(0x1e9)](_0x49f352(0x21c)+_0x1c49e9[_0x49f352(0x1ea)]+_0x49f352(0x1a6)+_0x1c49e9['id']+'\x20('+_0x1c49e9['gatewayPaymentId']+')');try{let _0xfb060d;_0x1c49e9['gateway']===_0x49f352(0x1b1)?(_0xfb060d=await this['coinToPay2Service']['checkPaymentStatus'](_0x1c49e9[_0x49f352(0x268)]),console[_0x49f352(0x1e9)]('üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x1c49e9['id']+_0x49f352(0x1b4)+_0xfb060d[_0x49f352(0x1e4)])):(_0xfb060d=await this[_0x49f352(0x21b)][_0x49f352(0x23e)](_0x1c49e9[_0x49f352(0x268)]),console['log'](_0x49f352(0x1d7)+_0x1c49e9['id']+_0x49f352(0x1b4)+_0xfb060d['status']));_0xfb060d['paymentDetails']&&console[_0x49f352(0x1e9)](_0x49f352(0x211)+_0x1c49e9['id']+_0x49f352(0x194),{'iban':_0xfb060d['paymentDetails'][_0x49f352(0x279)]||'not\x20found','transactionId':_0xfb060d[_0x49f352(0x285)]['transactionId'],'createdOn':_0xfb060d[_0x49f352(0x285)]['createdOn'],'confirmedOn':_0xfb060d['paymentDetails'][_0x49f352(0x246)]||_0x49f352(0x1d0)});if(_0xfb060d['status']!==_0x1c49e9[_0x49f352(0x1e4)]){console[_0x49f352(0x1e9)]('üîÑ\x20[CHECK]\x20Updating\x20payment\x20'+_0x1c49e9['id']+_0x49f352(0x295)+_0x1c49e9['status']+_0x49f352(0x272)+_0xfb060d[_0x49f352(0x1e4)]),this[_0x49f352(0x1bd)](_0x1c49e9['id'],_0x1c49e9[_0x49f352(0x268)],_0x1c49e9['status'],_0xfb060d[_0x49f352(0x1e4)],_0x49f352(0x1f8),{'paymentDetails':_0xfb060d[_0x49f352(0x285)],'amount':_0xfb060d[_0x49f352(0x228)],'currency':_0xfb060d[_0x49f352(0x290)],'shopId':_0x1c49e9[_0x49f352(0x1da)],'checkTimestamp':new Date()[_0x49f352(0x1ed)]()});const _0x48b00d={'status':_0xfb060d[_0x49f352(0x1e4)],'updatedAt':new Date()};if(_0xfb060d[_0x49f352(0x1e4)]===_0x49f352(0x205)&&_0x1c49e9[_0x49f352(0x1e4)]!==_0x49f352(0x205)){_0x48b00d[_0x49f352(0x24e)]=new Date();if(!_0x1c49e9[_0x49f352(0x1a0)]){const _0x1ed70a=await currencyService_1[_0x49f352(0x1b2)][_0x49f352(0x1a5)](_0x1c49e9[_0x49f352(0x228)],_0x1c49e9[_0x49f352(0x290)]);_0x48b00d['amountUSDT']=_0x1ed70a;const _0x543ac0=await this[_0x49f352(0x262)](_0x1c49e9[_0x49f352(0x1da)],_0x1c49e9[_0x49f352(0x1ea)]),_0x4e1ca3=_0x1ed70a*(0x1-_0x543ac0/0x64);_0x48b00d[_0x49f352(0x1b9)]=_0x4e1ca3,_0x48b00d['gatewayCommissionRate']=_0x543ac0,console['log'](_0x49f352(0x18e)+_0x1c49e9['id']+_0x49f352(0x18f)),console[_0x49f352(0x1e9)](_0x49f352(0x207)+_0x1c49e9[_0x49f352(0x228)]+'\x20'+_0x1c49e9[_0x49f352(0x290)]+_0x49f352(0x1ac)+_0x1ed70a[_0x49f352(0x1e7)](0x6)+_0x49f352(0x1df)),console['log'](_0x49f352(0x213)+_0x1c49e9[_0x49f352(0x1ea)]+_0x49f352(0x24f)+_0x543ac0+'%'),console[_0x49f352(0x1e9)](_0x49f352(0x1d3)+_0x4e1ca3['toFixed'](0x6)+_0x49f352(0x1df));}console[_0x49f352(0x1e9)](_0x49f352(0x18e)+_0x1c49e9['id']+_0x49f352(0x225)+_0x48b00d['paidAt'][_0x49f352(0x1ed)]());}if(_0xfb060d[_0x49f352(0x285)]){const _0x3ef797=_0xfb060d[_0x49f352(0x285)];_0x3ef797['iban']&&(_0x48b00d[_0x49f352(0x263)]=_0x3ef797['iban'],console[_0x49f352(0x1e9)](_0x49f352(0x286)+_0x3ef797[_0x49f352(0x279)]));if(_0x3ef797[_0x49f352(0x27f)]){const _0x275831=_0x1c49e9[_0x49f352(0x210)]||'',_0x14b9ec=_0x49f352(0x20d)+_0x3ef797[_0x49f352(0x27f)];_0x48b00d[_0x49f352(0x210)]=_0x275831?_0x275831+'\x0a\x0a'+_0x14b9ec:_0x14b9ec,console[_0x49f352(0x1e9)](_0x49f352(0x1b5));}_0x3ef797[_0x49f352(0x25c)]&&console[_0x49f352(0x1e9)](_0x49f352(0x275)+_0x3ef797[_0x49f352(0x25c)]),_0x3ef797[_0x49f352(0x246)]&&console[_0x49f352(0x1e9)](_0x49f352(0x226)+_0x3ef797['confirmedOn']);}await database_1['default']['payment']['update']({'where':{'id':_0x1c49e9['id']},'data':_0x48b00d});if(_0xfb060d['status']===_0x49f352(0x205)&&_0x1c49e9['status']!==_0x49f352(0x205)){console[_0x49f352(0x1e9)](_0x49f352(0x1e1)+_0x1c49e9['id']+_0x49f352(0x1bb));const _0x191993=await database_1[_0x49f352(0x215)]['payment'][_0x49f352(0x238)]({'where':{'id':_0x1c49e9['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x191993?.[_0x49f352(0x29c)]&&_0x191993['paymentLink'])try{const _0x25832d=_0x191993[_0x49f352(0x236)];console[_0x49f352(0x1e9)](_0x49f352(0x1c9)+_0x25832d['id']+':\x20type='+_0x25832d[_0x49f352(0x197)]+_0x49f352(0x1f5)+_0x25832d[_0x49f352(0x278)]+_0x49f352(0x202)+_0x25832d[_0x49f352(0x1e4)]);const _0x173efd=_0x25832d[_0x49f352(0x278)]+0x1,_0x12a93f=_0x25832d[_0x49f352(0x197)]==='SINGLE'?_0x49f352(0x28d):_0x25832d[_0x49f352(0x1e4)];await database_1[_0x49f352(0x215)][_0x49f352(0x236)][_0x49f352(0x1cc)]({'where':{'id':_0x25832d['id']},'data':{'currentPayments':_0x173efd,'status':_0x12a93f,'updatedAt':new Date()}}),console[_0x49f352(0x1e9)](_0x49f352(0x266)+_0x25832d['id']+_0x49f352(0x1b7)+_0x25832d['currentPayments']+_0x49f352(0x1ac)+_0x173efd+_0x49f352(0x202)+_0x25832d['status']+_0x49f352(0x1ac)+_0x12a93f);}catch(_0x20d4a1){console[_0x49f352(0x234)](_0x49f352(0x23a),_0x20d4a1);}else console['log'](_0x49f352(0x1e1)+_0x1c49e9['id']+_0x49f352(0x28a));}await database_1[_0x49f352(0x215)]['webhookLog']['create']({'data':{'paymentId':_0x1c49e9['id'],'shopId':_0x1c49e9[_0x49f352(0x1da)],'event':'cointopay_status_check_'+_0xfb060d[_0x49f352(0x1e4)][_0x49f352(0x249)](),'statusCode':0xc8,'responseBody':JSON[_0x49f352(0x27e)]({'oldStatus':_0x1c49e9['status'],'newStatus':_0xfb060d[_0x49f352(0x1e4)],'paymentDetails':_0xfb060d[_0x49f352(0x285)],'checkedAt':new Date()[_0x49f352(0x1ed)]()})}}),await this['sendShopWebhook'](_0x1c49e9,_0xfb060d['status']),await this['sendPaymentStatusNotification'](_0x1c49e9,_0xfb060d[_0x49f352(0x1e4)]),_0xfb060d[_0x49f352(0x1e4)]!==_0x49f352(0x255)&&(console[_0x49f352(0x1e9)]('üßπ\x20[CHECK]\x20Payment\x20'+_0x1c49e9['id']+_0x49f352(0x237)+_0xfb060d[_0x49f352(0x1e4)]+',\x20clearing\x20individual\x20timers'),this[_0x49f352(0x189)](_0x1c49e9['id'])),console[_0x49f352(0x1e9)](_0x49f352(0x1bf)+_0x1c49e9['id']+_0x49f352(0x23f));}else console[_0x49f352(0x1e9)](_0x49f352(0x211)+_0x1c49e9['id']+_0x49f352(0x1e8)+_0xfb060d['status']+')'),this[_0x49f352(0x1bd)](_0x1c49e9['id'],_0x1c49e9[_0x49f352(0x268)],_0x1c49e9[_0x49f352(0x1e4)],_0xfb060d[_0x49f352(0x1e4)],_0x49f352(0x1f8),{'statusUnchanged':!![],'paymentDetails':_0xfb060d['paymentDetails'],'amount':_0xfb060d[_0x49f352(0x228)],'currency':_0xfb060d[_0x49f352(0x290)],'shopId':_0x1c49e9[_0x49f352(0x1da)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x38828f){console[_0x49f352(0x234)](_0x49f352(0x1ef)+_0x1c49e9['id']+':',_0x38828f),this['logCoinToPayError'](_0x1c49e9['id'],_0x1c49e9[_0x49f352(0x268)],_0x38828f,_0x49f352(0x1f8),{'paymentAmount':_0x1c49e9['amount'],'paymentCurrency':_0x1c49e9[_0x49f352(0x290)],'shopId':_0x1c49e9[_0x49f352(0x1da)],'createdAt':_0x1c49e9[_0x49f352(0x1d6)]}),await database_1[_0x49f352(0x215)][_0x49f352(0x1e5)][_0x49f352(0x250)]({'data':{'paymentId':_0x1c49e9['id'],'shopId':_0x1c49e9[_0x49f352(0x1da)],'event':_0x49f352(0x1d4),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x38828f instanceof Error?_0x38828f['message']:_0x49f352(0x230),'gatewayPaymentId':_0x1c49e9[_0x49f352(0x268)],'checkedAt':new Date()['toISOString']()})}});}}async[a42_0x3e4240(0x222)](_0x243d7c,_0x30ac44){const _0x4677ec=a42_0x3e4240,_0x44abb2=Date[_0x4677ec(0x284)]();try{const _0x4dea47=_0x243d7c[_0x4677ec(0x20c)],_0x5ada79=_0x4dea47[_0x4677ec(0x203)];if(!_0x5ada79?.[_0x4677ec(0x1cb)]){console[_0x4677ec(0x1e9)](_0x4677ec(0x296)+_0x4dea47['id']);return;}const _0x3eb2aa=_0x30ac44===_0x4677ec(0x205)?_0x4677ec(0x200):_0x30ac44===_0x4677ec(0x1ad)?_0x4677ec(0x1fd):_0x30ac44===_0x4677ec(0x229)?_0x4677ec(0x1fd):_0x4677ec(0x22c);if(!_0x5ada79['webhookEvents']?.[_0x4677ec(0x28e)](_0x3eb2aa)){console['log']('Webhook\x20event\x20'+_0x3eb2aa+_0x4677ec(0x1a8)+_0x4dea47['id']);return;}const _0x215d5e=(0x0,gateway_1['getGatewayIdByName'])(_0x243d7c[_0x4677ec(0x1ea)])||_0x243d7c[_0x4677ec(0x1ea)],_0x16d04b={'event':_0x3eb2aa,'payment':{'id':_0x243d7c['id'],'order_id':_0x243d7c[_0x4677ec(0x212)],'gateway_order_id':_0x243d7c[_0x4677ec(0x1dd)],'gateway':_0x215d5e,'amount':_0x243d7c[_0x4677ec(0x228)],'currency':_0x243d7c[_0x4677ec(0x290)],'status':_0x30ac44[_0x4677ec(0x249)](),'customer_email':_0x243d7c[_0x4677ec(0x26f)],'customer_name':_0x243d7c[_0x4677ec(0x25b)],'created_at':_0x243d7c['createdAt'],'updated_at':new Date()}},_0x5a96b8=await fetch(_0x5ada79[_0x4677ec(0x1cb)],{'method':'POST','headers':{'Content-Type':_0x4677ec(0x1d5),'User-Agent':_0x4677ec(0x27d)},'body':JSON[_0x4677ec(0x27e)](_0x16d04b)}),_0x18a321=Date[_0x4677ec(0x284)]()-_0x44abb2,_0x391e4c=_0x5a96b8['ok']?'Success':await _0x5a96b8['text']();loggerService_1['loggerService'][_0x4677ec(0x274)](_0x243d7c[_0x4677ec(0x1da)],_0x5ada79['webhookUrl'],_0x3eb2aa,_0x5a96b8[_0x4677ec(0x1e4)],_0x18a321,_0x16d04b),console[_0x4677ec(0x1e9)]('Shop\x20webhook\x20sent\x20to\x20'+_0x5ada79[_0x4677ec(0x1cb)]+'\x20with\x20status\x20'+_0x5a96b8['status']+'\x20('+_0x18a321+'ms)');}catch(_0x2908d7){console[_0x4677ec(0x234)](_0x4677ec(0x1c5),_0x2908d7),loggerService_1[_0x4677ec(0x1bc)][_0x4677ec(0x190)](_0x243d7c[_0x4677ec(0x1da)],_0x243d7c[_0x4677ec(0x20c)]?.[_0x4677ec(0x203)]?.['webhookUrl']||_0x4677ec(0x261),'webhook_send',_0x2908d7,{});}}async['sendPaymentStatusNotification'](_0x47e7c4,_0x213f78){const _0x500644=a42_0x3e4240;try{const _0x1253cb={'PENDING':'created','PAID':_0x500644(0x21e),'FAILED':_0x500644(0x24b),'EXPIRED':_0x500644(0x20f)},_0x55d714=_0x1253cb[_0x213f78];if(!_0x55d714||_0x55d714===_0x500644(0x259))return;await telegramBotService_1[_0x500644(0x299)][_0x500644(0x25a)](_0x47e7c4[_0x500644(0x1da)],_0x47e7c4,_0x55d714);}catch(_0x2f7a62){console['error'](_0x500644(0x1ae),_0x2f7a62);}}async[a42_0x3e4240(0x1ec)](_0x4119db){const _0x3adfc7=a42_0x3e4240;console[_0x3adfc7(0x1e9)](_0x3adfc7(0x245)+_0x4119db);const _0x537165=await database_1[_0x3adfc7(0x215)][_0x3adfc7(0x1c0)][_0x3adfc7(0x238)]({'where':{'id':_0x4119db},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x537165)throw new Error('Payment\x20not\x20found');if(_0x537165['gateway']!=='cointopay'&&_0x537165[_0x3adfc7(0x1ea)]!==_0x3adfc7(0x1b1))throw new Error(_0x3adfc7(0x1e6));console['log'](_0x3adfc7(0x24c)+_0x537165[_0x3adfc7(0x1ea)]+'\x20payment\x20'+_0x4119db),await this[_0x3adfc7(0x267)](_0x537165),console['log'](_0x3adfc7(0x221)+_0x4119db);}['getServiceStats'](){const _0x4d34f5=a42_0x3e4240,_0x5e385a=this[_0x4d34f5(0x21f)]?this[_0x4d34f5(0x283)]:undefined,_0x598b63=Array[_0x4d34f5(0x18c)](this[_0x4d34f5(0x1d8)][_0x4d34f5(0x23d)]())['map'](_0x3b05cd=>({'paymentId':_0x3b05cd[_0x4d34f5(0x281)],'gatewayPaymentId':_0x3b05cd[_0x4d34f5(0x268)],'createdAt':_0x3b05cd[_0x4d34f5(0x1d6)],'timersCount':_0x3b05cd[_0x4d34f5(0x26c)]['length']}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x4d34f5(0x1d8)][_0x4d34f5(0x26e)],'nextGlobalCheckIn':_0x5e385a,'paymentTimersDetails':_0x598b63};}[a42_0x3e4240(0x20e)](_0x388d30){const _0x3d6823=a42_0x3e4240,_0x48addf=this[_0x3d6823(0x1d8)]['get'](_0x388d30);if(_0x48addf)return{'hasTimers':!![],'timersCount':_0x48addf[_0x3d6823(0x26c)][_0x3d6823(0x1cd)],'createdAt':_0x48addf['createdAt'],'gatewayPaymentId':_0x48addf[_0x3d6823(0x268)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0x154e1a,_0x374b4b){const _0x331476=a42_0x3e4240;try{const _0x5d4a22=await database_1[_0x331476(0x215)][_0x331476(0x20c)]['findUnique']({'where':{'id':_0x154e1a},'select':{'gatewaySettings':!![]}});if(!_0x5d4a22?.[_0x331476(0x1a2)])return console[_0x331476(0x1e9)]('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x154e1a+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x521a6e=JSON[_0x331476(0x271)](_0x5d4a22[_0x331476(0x1a2)]);for(const [_0x256cb3,_0x5c7b42]of Object[_0x331476(0x291)](_0x521a6e)){if(_0x256cb3[_0x331476(0x249)]()===_0x374b4b[_0x331476(0x249)]()){const _0x1a3d79=_0x5c7b42['commission']||0xa;return console[_0x331476(0x1e9)](_0x331476(0x243)+_0x374b4b+_0x331476(0x188)+_0x154e1a+':\x20'+_0x1a3d79+'%'),_0x1a3d79;}}return console[_0x331476(0x1e9)](_0x331476(0x198)+_0x374b4b+_0x331476(0x1b3)+_0x154e1a+',\x20using\x20default\x2010%'),0xa;}catch(_0xd0c8bf){return console[_0x331476(0x234)](_0x331476(0x18b)+_0x154e1a+_0x331476(0x199)+_0x374b4b+':',_0xd0c8bf),0xa;}}}exports[a42_0x3e4240(0x20a)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();