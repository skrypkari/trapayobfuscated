'use strict';const a35_0x2ffed5=a35_0x24e1;(function(_0x45e39a,_0x3c4180){const _0x1b215c=a35_0x24e1,_0x569803=_0x45e39a();while(!![]){try{const _0x4d97ca=-parseInt(_0x1b215c(0x1b1))/0x1*(-parseInt(_0x1b215c(0x1c6))/0x2)+parseInt(_0x1b215c(0x1ff))/0x3*(parseInt(_0x1b215c(0x23a))/0x4)+parseInt(_0x1b215c(0x1ce))/0x5*(-parseInt(_0x1b215c(0x1a7))/0x6)+-parseInt(_0x1b215c(0x21b))/0x7*(-parseInt(_0x1b215c(0x20b))/0x8)+parseInt(_0x1b215c(0x1be))/0x9*(-parseInt(_0x1b215c(0x1ac))/0xa)+-parseInt(_0x1b215c(0x218))/0xb*(parseInt(_0x1b215c(0x1b2))/0xc)+parseInt(_0x1b215c(0x1e9))/0xd;if(_0x4d97ca===_0x3c4180)break;else _0x569803['push'](_0x569803['shift']());}catch(_0xf9ccb){_0x569803['push'](_0x569803['shift']());}}}(a35_0x5a8b,0x5405b));function a35_0x24e1(_0x579a3d,_0x5d3ad1){const _0x5a8bb0=a35_0x5a8b();return a35_0x24e1=function(_0x24e113,_0x9820a2){_0x24e113=_0x24e113-0x1a1;let _0x232d99=_0x5a8bb0[_0x24e113];return _0x232d99;},a35_0x24e1(_0x579a3d,_0x5d3ad1);}function a35_0x5a8b(){const _0x8445fb=['update','ms)','🪙\x20Checking\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','2112BFWpiN','\x20pending\x20CoinToPay\x20payments','setDate','40782oJPMoH','status_check','\x20\x20\x20❌\x20Error:\x20','not\x20confirmed','unknown','error','/status/','telegramBotService','🪙\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','cointopay_status_check_error','paymentDetails','coinToPayService','transactionId','./telegramBotService','\x20\x20\x20📝\x20Details:','\x20with\x20status\x20','logCoinToPayStatus','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20not\x20enabled\x20for\x20shop\x20','checkSinglePayment','\x20days,\x20marking\x20as\x20EXPIRED','./gateways/coinToPayService','now','⏰\x20Found\x20','\x20days','Unknown\x20error','remitterIban','🪙\x20CoinToPay\x20Status\x20Change:\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','0100','status','4tTyLUV','CoinToPayStatusService','\x20to\x20','settings','\x20\x20\x20📝\x20Context:','Bank\x20Details:\x20','shopId','loggerService','customerEmail','checkExpiredPayments','1950etqGlL','\x20CoinToPay\x20payments','startPeriodicStatusCheck','gatewayOrderId','Failed\x20to\x20expire\x20payment\x20','4400ZZTUsi','stopPeriodicStatusCheck','\x20is\x20older\x20than\x20','includes','webhookLog','63uxMZNg','8496PaAsjY','EXPIRED','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','findUnique','./loggerService','EXPIRY_DAYS','failed','Failed\x20to\x20mark\x20payment\x20as\x20expired','Webhook\x20event\x20','⏰\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','bankDetails','paidAt','11718omUVMU','sendShopWebhook','coinToPayStatusService','length','logShopWebhookSent','🪙\x20CoinToPay\x20Error:\x20','🔄\x20Updating\x20payment\x20','Payment\x20older\x20than\x20','2334LzNWyw','PENDING','push','CHECK_INTERVAL_MS','-day\x20timeout','CoinToPayService','timestamp','Periodic\x20CoinToPay\x20status\x20check\x20failed:','1235mEOgRu','cointopay','FAILED','gateway','../config/database','cointopay_status_check_','\x20details:','toISOString','shop','catch','🆔\x20Transaction\x20ID:\x20','logCoinToPayError','⚠️\x20Payment\x20','webhookUrl','\x20days\x20(created\x20before\x20','logShopWebhookError','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','🛑\x20CoinToPay\x20status\x20checking\x20stopped','not\x20found','__esModule','adminNotes','\x20\x20\x20📅\x20Time:\x20','payment','iban','message','🏦\x20Saved\x20IBAN:\x20','expired','5609214pbmjAv','currency','cointopay_auto_expired','PAID','auto_expire','checkPaymentStatus','Initial\x20CoinToPay\x20status\x20check\x20failed:','payment.success','\x20\x20\x20📍\x20Source:\x20','sendPaymentStatusNotification','\x20days\x20without\x20payment\x20confirmation','stringify','amount','\x20\x20\x20📊\x20Status:\x20','application/json','⏰\x20Payment\x20','\x20->\x20','checkInterval','\x20expired\x20CoinToPay\x20payments','stack','createdOn','sendPaymentNotification','678759UkpeOB','log','📊\x20Payment\x20','gatewayPaymentId','defineProperty','POST','payment.failed','✅\x20Completed\x20checking\x20','create','floor','checkAllPendingPayments','toLowerCase','552OHtawb','Payment\x20not\x20found','confirmedOn','orderId','created','✅\x20Payment\x20','getTime','default','createdAt'];a35_0x5a8b=function(){return _0x8445fb;};return a35_0x5a8b();}var __importDefault=this&&this['__importDefault']||function(_0x1b804c){const _0x5225ee=a35_0x24e1;return _0x1b804c&&_0x1b804c[_0x5225ee(0x1e1)]?_0x1b804c:{'default':_0x1b804c};};Object[a35_0x2ffed5(0x203)](exports,a35_0x2ffed5(0x1e1),{'value':!![]}),exports[a35_0x2ffed5(0x1c0)]=exports[a35_0x2ffed5(0x23b)]=void 0x0;const coinToPayService_1=require(a35_0x2ffed5(0x230)),database_1=__importDefault(require(a35_0x2ffed5(0x1d2))),telegramBotService_1=require(a35_0x2ffed5(0x228)),loggerService_1=require(a35_0x2ffed5(0x1b6));class CoinToPayStatusService{constructor(){const _0x197d66=a35_0x2ffed5;this[_0x197d66(0x1fa)]=null,this[_0x197d66(0x1c9)]=0x3c*0x3c*0x3e8,this[_0x197d66(0x1b7)]=0x5,this[_0x197d66(0x226)]=new coinToPayService_1[(_0x197d66(0x1cb))]();}[a35_0x2ffed5(0x22b)](_0x1208e3,_0x3a2a7d,_0x2c8f4f,_0x45490a,_0x120ca4,_0x3b2749){const _0x519edb=a35_0x2ffed5,_0x736bc={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x1208e3,'gatewayPaymentId':_0x3a2a7d,'oldStatus':_0x2c8f4f,'newStatus':_0x45490a,'source':_0x120ca4,'timestamp':new Date()[_0x519edb(0x1d5)](),'details':_0x3b2749||{}};loggerService_1[_0x519edb(0x1a4)]['logCoinToPayStatus'](_0x736bc),console[_0x519edb(0x200)](_0x519edb(0x236)+_0x1208e3+'\x20('+_0x3a2a7d+')'),console[_0x519edb(0x200)](_0x519edb(0x1f6)+_0x2c8f4f+_0x519edb(0x1f9)+_0x45490a),console[_0x519edb(0x200)](_0x519edb(0x1f1)+_0x120ca4),console[_0x519edb(0x200)]('\x20\x20\x20📅\x20Time:\x20'+_0x736bc[_0x519edb(0x1cc)]),_0x3b2749&&console[_0x519edb(0x200)](_0x519edb(0x229),_0x3b2749);}[a35_0x2ffed5(0x1d9)](_0x447111,_0x100019,_0x1d993c,_0x340a71,_0x5376ae){const _0x48d551=a35_0x2ffed5,_0x21f692={'type':'COINTOPAY_ERROR','paymentId':_0x447111,'gatewayPaymentId':_0x100019,'error':_0x1d993c instanceof Error?{'message':_0x1d993c[_0x48d551(0x1e6)],'stack':_0x1d993c[_0x48d551(0x1fc)]}:_0x1d993c,'source':_0x340a71,'timestamp':new Date()[_0x48d551(0x1d5)](),'context':_0x5376ae||{}};loggerService_1[_0x48d551(0x1a4)]['logCoinToPayError'](_0x21f692),console[_0x48d551(0x220)](_0x48d551(0x1c3)+_0x447111+'\x20('+_0x100019+')'),console[_0x48d551(0x220)](_0x48d551(0x21d)+(_0x1d993c instanceof Error?_0x1d993c['message']:_0x1d993c)),console['error'](_0x48d551(0x1f1)+_0x340a71),console['error'](_0x48d551(0x1e3)+_0x21f692[_0x48d551(0x1cc)]),_0x5376ae&&console['error'](_0x48d551(0x1a1),_0x5376ae);}[a35_0x2ffed5(0x1a9)](){const _0x566e2d=a35_0x2ffed5;console[_0x566e2d(0x200)]('🪙\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)'),this['checkAllPendingPayments']()[_0x566e2d(0x1d7)](_0x32f0d0=>{const _0x37c4d7=_0x566e2d;console[_0x37c4d7(0x220)](_0x37c4d7(0x1ef),_0x32f0d0);}),this[_0x566e2d(0x1fa)]=setInterval(async()=>{const _0x112532=_0x566e2d;try{await this[_0x112532(0x209)]();}catch(_0x30799d){console[_0x112532(0x220)](_0x112532(0x1cd),_0x30799d);}},this[_0x566e2d(0x1c9)]),console[_0x566e2d(0x200)]('✅\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)');}[a35_0x2ffed5(0x1ad)](){const _0x1caa66=a35_0x2ffed5;this['checkInterval']&&(clearInterval(this[_0x1caa66(0x1fa)]),this[_0x1caa66(0x1fa)]=null,console[_0x1caa66(0x200)](_0x1caa66(0x1df)));}async[a35_0x2ffed5(0x209)](){const _0x392108=a35_0x2ffed5;try{const _0x4975a7=await database_1[_0x392108(0x212)]['payment']['findMany']({'where':{'gateway':_0x392108(0x1cf),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x4975a7[_0x392108(0x1c1)]===0x0){console[_0x392108(0x200)](_0x392108(0x223));return;}console[_0x392108(0x200)](_0x392108(0x216)+_0x4975a7[_0x392108(0x1c1)]+_0x392108(0x219));const _0x439ebf=await this[_0x392108(0x1a6)](_0x4975a7);console[_0x392108(0x200)](_0x392108(0x232)+_0x439ebf['length']+_0x392108(0x1fb));for(const _0x496edf of _0x4975a7){try{if(_0x439ebf[_0x392108(0x1af)](_0x496edf['id'])){console['log'](_0x392108(0x1f8)+_0x496edf['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check');continue;}await this[_0x392108(0x22e)](_0x496edf),await new Promise(_0x193daf=>setTimeout(_0x193daf,0x7d0));}catch(_0x367076){console['error'](_0x392108(0x22c)+_0x496edf['id']+':',_0x367076),this[_0x392108(0x1d9)](_0x496edf['id'],_0x496edf[_0x392108(0x202)]||_0x392108(0x21f),_0x367076,_0x392108(0x21c),{'paymentAmount':_0x496edf['amount'],'paymentCurrency':_0x496edf['currency'],'shopId':_0x496edf[_0x392108(0x1a3)],'createdAt':_0x496edf['createdAt']}),loggerService_1[_0x392108(0x1a4)]['logWhiteDomainError'](_0x392108(0x1cf),_0x392108(0x221)+_0x496edf[_0x392108(0x202)],_0x367076);}}console[_0x392108(0x200)](_0x392108(0x206)+_0x4975a7[_0x392108(0x1c1)]+_0x392108(0x1a8));}catch(_0x424cbc){console[_0x392108(0x220)]('Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x424cbc);}}async['checkExpiredPayments'](_0x2cccfc){const _0x378f7f=a35_0x2ffed5,_0x1e41a2=[],_0x4b9d09=new Date();_0x4b9d09[_0x378f7f(0x21a)](_0x4b9d09['getDate']()-this[_0x378f7f(0x1b7)]),console['log'](_0x378f7f(0x1bb)+this[_0x378f7f(0x1b7)]+_0x378f7f(0x1dc)+_0x4b9d09[_0x378f7f(0x1d5)]()+')');for(const _0x5cd44e of _0x2cccfc){if(_0x5cd44e[_0x378f7f(0x213)]<_0x4b9d09){console[_0x378f7f(0x200)](_0x378f7f(0x1f8)+_0x5cd44e['id']+_0x378f7f(0x1ae)+this[_0x378f7f(0x1b7)]+_0x378f7f(0x22f));try{this['logCoinToPayStatus'](_0x5cd44e['id'],_0x5cd44e[_0x378f7f(0x202)]||'unknown',_0x378f7f(0x1c7),'EXPIRED',_0x378f7f(0x1ed),{'reason':_0x378f7f(0x1c5)+this['EXPIRY_DAYS']+_0x378f7f(0x233),'createdAt':_0x5cd44e[_0x378f7f(0x213)],'daysSinceCreation':Math[_0x378f7f(0x208)]((Date[_0x378f7f(0x231)]()-_0x5cd44e[_0x378f7f(0x213)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x5cd44e[_0x378f7f(0x1f5)],'paymentCurrency':_0x5cd44e[_0x378f7f(0x1ea)],'shopId':_0x5cd44e[_0x378f7f(0x1a3)]}),await database_1[_0x378f7f(0x212)][_0x378f7f(0x1e4)]['update']({'where':{'id':_0x5cd44e['id']},'data':{'status':_0x378f7f(0x1b3),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this['EXPIRY_DAYS']+_0x378f7f(0x1f3)}}),await database_1['default']['webhookLog'][_0x378f7f(0x207)]({'data':{'paymentId':_0x5cd44e['id'],'shopId':_0x5cd44e['shopId'],'event':_0x378f7f(0x1eb),'statusCode':0xc8,'responseBody':JSON[_0x378f7f(0x1f4)]({'reason':_0x378f7f(0x1c5)+this[_0x378f7f(0x1b7)]+_0x378f7f(0x233),'createdAt':_0x5cd44e[_0x378f7f(0x213)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x378f7f(0x208)]((Date[_0x378f7f(0x231)]()-_0x5cd44e['createdAt'][_0x378f7f(0x211)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x378f7f(0x1bf)](_0x5cd44e,_0x378f7f(0x1b3)),await this['sendPaymentStatusNotification'](_0x5cd44e,'EXPIRED'),_0x1e41a2[_0x378f7f(0x1c8)](_0x5cd44e['id']),console[_0x378f7f(0x200)]('✅\x20Payment\x20'+_0x5cd44e['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this['EXPIRY_DAYS']+_0x378f7f(0x1ca));}catch(_0x3d6fdc){console[_0x378f7f(0x220)](_0x378f7f(0x1ab)+_0x5cd44e['id']+':',_0x3d6fdc),this[_0x378f7f(0x1d9)](_0x5cd44e['id'],_0x5cd44e[_0x378f7f(0x202)]||_0x378f7f(0x21f),_0x3d6fdc,_0x378f7f(0x1ed),{'reason':_0x378f7f(0x1b9),'createdAt':_0x5cd44e[_0x378f7f(0x213)],'daysSinceCreation':Math[_0x378f7f(0x208)]((Date[_0x378f7f(0x231)]()-_0x5cd44e[_0x378f7f(0x213)][_0x378f7f(0x211)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x1e41a2;}async[a35_0x2ffed5(0x22e)](_0x3e5c2f){const _0x5717fe=a35_0x2ffed5;if(!_0x3e5c2f[_0x5717fe(0x202)]){console['log'](_0x5717fe(0x1da)+_0x3e5c2f['id']+_0x5717fe(0x237));return;}console[_0x5717fe(0x200)]('🔍\x20Checking\x20CoinToPay\x20payment\x20'+_0x3e5c2f['id']+'\x20('+_0x3e5c2f['gatewayPaymentId']+')');try{const _0x4837ad=await this['coinToPayService'][_0x5717fe(0x1ee)](_0x3e5c2f[_0x5717fe(0x202)]);console[_0x5717fe(0x200)]('📊\x20Payment\x20'+_0x3e5c2f['id']+'\x20status:\x20'+_0x4837ad[_0x5717fe(0x239)]);_0x4837ad['paymentDetails']&&console['log'](_0x5717fe(0x201)+_0x3e5c2f['id']+_0x5717fe(0x1d4),{'iban':_0x4837ad[_0x5717fe(0x225)][_0x5717fe(0x1e5)]||_0x5717fe(0x1e0),'transactionId':_0x4837ad[_0x5717fe(0x225)][_0x5717fe(0x227)],'createdOn':_0x4837ad[_0x5717fe(0x225)][_0x5717fe(0x1fd)],'confirmedOn':_0x4837ad[_0x5717fe(0x225)][_0x5717fe(0x20d)]||_0x5717fe(0x21e)});if(_0x4837ad[_0x5717fe(0x239)]!==_0x3e5c2f[_0x5717fe(0x239)]){console[_0x5717fe(0x200)](_0x5717fe(0x1c4)+_0x3e5c2f['id']+'\x20status\x20from\x20'+_0x3e5c2f[_0x5717fe(0x239)]+_0x5717fe(0x23c)+_0x4837ad['status']),this['logCoinToPayStatus'](_0x3e5c2f['id'],_0x3e5c2f[_0x5717fe(0x202)],_0x3e5c2f[_0x5717fe(0x239)],_0x4837ad['status'],'status_check',{'paymentDetails':_0x4837ad[_0x5717fe(0x225)],'amount':_0x4837ad[_0x5717fe(0x1f5)],'currency':_0x4837ad[_0x5717fe(0x1ea)],'shopId':_0x3e5c2f[_0x5717fe(0x1a3)],'checkTimestamp':new Date()[_0x5717fe(0x1d5)]()});const _0x13aa9c={'status':_0x4837ad[_0x5717fe(0x239)],'updatedAt':new Date()};_0x4837ad[_0x5717fe(0x239)]===_0x5717fe(0x1ec)&&_0x3e5c2f[_0x5717fe(0x239)]!==_0x5717fe(0x1ec)&&(_0x13aa9c[_0x5717fe(0x1bd)]=new Date(),console[_0x5717fe(0x200)]('💰\x20Payment\x20'+_0x3e5c2f['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x13aa9c[_0x5717fe(0x1bd)]['toISOString']()));if(_0x4837ad[_0x5717fe(0x225)]){const _0x2d351d=_0x4837ad['paymentDetails'];_0x2d351d[_0x5717fe(0x1e5)]&&(_0x13aa9c[_0x5717fe(0x235)]=_0x2d351d['iban'],console[_0x5717fe(0x200)](_0x5717fe(0x1e7)+_0x2d351d[_0x5717fe(0x1e5)]));if(_0x2d351d[_0x5717fe(0x1bc)]){const _0x13b473=_0x3e5c2f[_0x5717fe(0x1e2)]||'',_0x24da1c=_0x5717fe(0x1a2)+_0x2d351d[_0x5717fe(0x1bc)];_0x13aa9c[_0x5717fe(0x1e2)]=_0x13b473?_0x13b473+'\x0a\x0a'+_0x24da1c:_0x24da1c,console[_0x5717fe(0x200)]('🏦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x2d351d[_0x5717fe(0x227)]&&console[_0x5717fe(0x200)](_0x5717fe(0x1d8)+_0x2d351d[_0x5717fe(0x227)]),_0x2d351d[_0x5717fe(0x20d)]&&console[_0x5717fe(0x200)]('✅\x20Transaction\x20confirmed\x20on:\x20'+_0x2d351d[_0x5717fe(0x20d)]);}await database_1[_0x5717fe(0x212)][_0x5717fe(0x1e4)][_0x5717fe(0x214)]({'where':{'id':_0x3e5c2f['id']},'data':_0x13aa9c}),await database_1[_0x5717fe(0x212)][_0x5717fe(0x1b0)][_0x5717fe(0x207)]({'data':{'paymentId':_0x3e5c2f['id'],'shopId':_0x3e5c2f[_0x5717fe(0x1a3)],'event':_0x5717fe(0x1d3)+_0x4837ad['status'][_0x5717fe(0x20a)](),'statusCode':0xc8,'responseBody':JSON[_0x5717fe(0x1f4)]({'oldStatus':_0x3e5c2f[_0x5717fe(0x239)],'newStatus':_0x4837ad[_0x5717fe(0x239)],'paymentDetails':_0x4837ad[_0x5717fe(0x225)],'checkedAt':new Date()[_0x5717fe(0x1d5)]()})}}),await this[_0x5717fe(0x1bf)](_0x3e5c2f,_0x4837ad[_0x5717fe(0x239)]),await this[_0x5717fe(0x1f2)](_0x3e5c2f,_0x4837ad[_0x5717fe(0x239)]),console[_0x5717fe(0x200)](_0x5717fe(0x210)+_0x3e5c2f['id']+'\x20updated\x20successfully');}else console[_0x5717fe(0x200)](_0x5717fe(0x201)+_0x3e5c2f['id']+'\x20status\x20unchanged\x20('+_0x4837ad['status']+')'),this['logCoinToPayStatus'](_0x3e5c2f['id'],_0x3e5c2f[_0x5717fe(0x202)],_0x3e5c2f[_0x5717fe(0x239)],_0x4837ad[_0x5717fe(0x239)],_0x5717fe(0x21c),{'statusUnchanged':!![],'paymentDetails':_0x4837ad[_0x5717fe(0x225)],'amount':_0x4837ad['amount'],'currency':_0x4837ad['currency'],'shopId':_0x3e5c2f[_0x5717fe(0x1a3)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x590f5a){console[_0x5717fe(0x220)]('Failed\x20to\x20check\x20payment\x20'+_0x3e5c2f['id']+':',_0x590f5a),this[_0x5717fe(0x1d9)](_0x3e5c2f['id'],_0x3e5c2f[_0x5717fe(0x202)],_0x590f5a,'status_check',{'paymentAmount':_0x3e5c2f[_0x5717fe(0x1f5)],'paymentCurrency':_0x3e5c2f[_0x5717fe(0x1ea)],'shopId':_0x3e5c2f['shopId'],'createdAt':_0x3e5c2f['createdAt']}),await database_1[_0x5717fe(0x212)][_0x5717fe(0x1b0)]['create']({'data':{'paymentId':_0x3e5c2f['id'],'shopId':_0x3e5c2f[_0x5717fe(0x1a3)],'event':_0x5717fe(0x224),'statusCode':0x1f4,'responseBody':JSON[_0x5717fe(0x1f4)]({'error':_0x590f5a instanceof Error?_0x590f5a[_0x5717fe(0x1e6)]:_0x5717fe(0x234),'gatewayPaymentId':_0x3e5c2f[_0x5717fe(0x202)],'checkedAt':new Date()[_0x5717fe(0x1d5)]()})}});}}async[a35_0x2ffed5(0x1bf)](_0x41afa4,_0x545253){const _0x598b0a=a35_0x2ffed5,_0xac1361=Date[_0x598b0a(0x231)]();try{const _0x1db793=_0x41afa4[_0x598b0a(0x1d6)],_0x79804c=_0x1db793[_0x598b0a(0x23d)];if(!_0x79804c?.[_0x598b0a(0x1db)]){console[_0x598b0a(0x200)](_0x598b0a(0x1b4)+_0x1db793['id']);return;}const _0x45a782=_0x545253===_0x598b0a(0x1ec)?_0x598b0a(0x1f0):_0x545253===_0x598b0a(0x1d0)?_0x598b0a(0x205):_0x545253===_0x598b0a(0x1b3)?'payment.failed':'payment.pending';if(!_0x79804c['webhookEvents']?.[_0x598b0a(0x1af)](_0x45a782)){console[_0x598b0a(0x200)](_0x598b0a(0x1ba)+_0x45a782+_0x598b0a(0x22d)+_0x1db793['id']);return;}const _0x43d779={'event':_0x45a782,'payment':{'id':_0x41afa4['id'],'order_id':_0x41afa4[_0x598b0a(0x20e)],'gateway_order_id':_0x41afa4[_0x598b0a(0x1aa)],'gateway':_0x598b0a(0x238),'amount':_0x41afa4['amount'],'currency':_0x41afa4[_0x598b0a(0x1ea)],'status':_0x545253[_0x598b0a(0x20a)](),'customer_email':_0x41afa4[_0x598b0a(0x1a5)],'customer_name':_0x41afa4['customerName'],'created_at':_0x41afa4[_0x598b0a(0x213)],'updated_at':new Date()}},_0x5109a2=await fetch(_0x79804c[_0x598b0a(0x1db)],{'method':_0x598b0a(0x204),'headers':{'Content-Type':_0x598b0a(0x1f7),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x43d779)}),_0x7345d8=Date[_0x598b0a(0x231)]()-_0xac1361,_0xeed381=_0x5109a2['ok']?'Success':await _0x5109a2['text']();loggerService_1[_0x598b0a(0x1a4)][_0x598b0a(0x1c2)](_0x41afa4[_0x598b0a(0x1a3)],_0x79804c['webhookUrl'],_0x45a782,_0x5109a2[_0x598b0a(0x239)],_0x7345d8,_0x43d779),console[_0x598b0a(0x200)]('Shop\x20webhook\x20sent\x20to\x20'+_0x79804c['webhookUrl']+_0x598b0a(0x22a)+_0x5109a2[_0x598b0a(0x239)]+'\x20('+_0x7345d8+_0x598b0a(0x215));}catch(_0x1c2ca3){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x1c2ca3),loggerService_1[_0x598b0a(0x1a4)][_0x598b0a(0x1dd)](_0x41afa4['shopId'],_0x41afa4[_0x598b0a(0x1d6)]?.[_0x598b0a(0x23d)]?.[_0x598b0a(0x1db)]||_0x598b0a(0x21f),'webhook_send',_0x1c2ca3,{});}}async[a35_0x2ffed5(0x1f2)](_0x4e8f05,_0x57741d){const _0x49326e=a35_0x2ffed5;try{const _0x5e033f={'PENDING':_0x49326e(0x20f),'PAID':'paid','FAILED':_0x49326e(0x1b8),'EXPIRED':_0x49326e(0x1e8)},_0x19b589=_0x5e033f[_0x57741d];if(!_0x19b589||_0x19b589===_0x49326e(0x20f))return;await telegramBotService_1[_0x49326e(0x222)][_0x49326e(0x1fe)](_0x4e8f05['shopId'],_0x4e8f05,_0x19b589);}catch(_0x44b9b9){console['error'](_0x49326e(0x217),_0x44b9b9);}}async['checkPaymentById'](_0x1f653e){const _0x855910=a35_0x2ffed5,_0xdd5b6e=await database_1['default'][_0x855910(0x1e4)][_0x855910(0x1b5)]({'where':{'id':_0x1f653e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xdd5b6e)throw new Error(_0x855910(0x20c));if(_0xdd5b6e[_0x855910(0x1d1)]!==_0x855910(0x1cf))throw new Error(_0x855910(0x1de));await this[_0x855910(0x22e)](_0xdd5b6e);}['getServiceStats'](){const _0x1db52e=a35_0x2ffed5,_0x5bba8d=this['checkInterval']?this['CHECK_INTERVAL_MS']:undefined;return{'isActive':!!this[_0x1db52e(0x1fa)],'checkIntervalMinutes':this['CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'nextCheckIn':_0x5bba8d};}}exports[a35_0x2ffed5(0x23b)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();