'use strict';const a35_0x3874ff=a35_0x2ede;(function(_0x33811b,_0x3c731e){const _0x218000=a35_0x2ede,_0x1fed0=_0x33811b();while(!![]){try{const _0x2f98c0=parseInt(_0x218000(0xdc))/0x1*(parseInt(_0x218000(0x10b))/0x2)+parseInt(_0x218000(0x155))/0x3+-parseInt(_0x218000(0x15a))/0x4+parseInt(_0x218000(0x147))/0x5*(parseInt(_0x218000(0xdb))/0x6)+parseInt(_0x218000(0xeb))/0x7+-parseInt(_0x218000(0x11f))/0x8*(-parseInt(_0x218000(0xd5))/0x9)+-parseInt(_0x218000(0xe5))/0xa;if(_0x2f98c0===_0x3c731e)break;else _0x1fed0['push'](_0x1fed0['shift']());}catch(_0x856161){_0x1fed0['push'](_0x1fed0['shift']());}}}(a35_0x5f12,0x51ca2));function a35_0x2ede(_0x85ed8d,_0x147a05){const _0x5f12db=a35_0x5f12();return a35_0x2ede=function(_0x2ede79,_0x509f7e){_0x2ede79=_0x2ede79-0xd1;let _0x4de40e=_0x5f12db[_0x2ede79];return _0x4de40e;},a35_0x2ede(_0x85ed8d,_0x147a05);}var __importDefault=this&&this['__importDefault']||function(_0x3acdb9){return _0x3acdb9&&_0x3acdb9['__esModule']?_0x3acdb9:{'default':_0x3acdb9};};Object[a35_0x3874ff(0xfe)](exports,a35_0x3874ff(0x14d),{'value':!![]}),exports['coinToPayStatusService']=exports[a35_0x3874ff(0x144)]=void 0x0;const coinToPayService_1=require(a35_0x3874ff(0x127)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a35_0x3874ff(0xe9)),loggerService_1=require(a35_0x3874ff(0x159));function a35_0x5f12(){const _0x40d7fc=['customerEmail','PAID','✅\x20Payment\x20','iban','\x20expired\x20CoinToPay\x20payments','settings','\x20with\x20status\x20','🪙\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','createdAt','not\x20found','paymentDetails','telegramBotService','expired','failed','shop','CoinToPayService','CoinToPayStatusService','\x20status\x20from\x20','Bank\x20Details:\x20','75gsScgF','\x20pending\x20CoinToPay\x20payments','Shop\x20webhook\x20sent\x20to\x20','📊\x20Payment\x20','bankDetails','EXPIRED','__esModule','🆔\x20Transaction\x20ID:\x20','created','create','💰\x20Payment\x20','shopId','Failed\x20to\x20check\x20payment\x20','🪙\x20Checking\x20','175008bpROHw','error','adminNotes','checkExpiredPayments','./loggerService','635268SVHDqf','startPeriodicStatusCheck','logShopWebhookError','\x20not\x20enabled\x20for\x20shop\x20','🔍\x20Checking\x20CoinToPay\x20payment\x20','status','461646cSeyuk','log','stringify','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','includes','paidAt','160326rkseIJ','1zvALua','checkSinglePayment','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','checkInterval','\x20CoinToPay\x20payments','confirmedOn','PENDING','-day\x20timeout','getTime','5624280MhgAyE','Initial\x20CoinToPay\x20status\x20check\x20failed:','webhook_send','logShopWebhookSent','./telegramBotService','payment.pending','991326FHdzvz','POST','remitterIban','cointopay_auto_expired','cointopay_status_check_','CHECK_INTERVAL_MS','update','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','text','default','sendShopWebhook','application/json','⚠️\x20Payment\x20','Periodic\x20CoinToPay\x20status\x20check\x20failed:','currency','✅\x20Transaction\x20confirmed\x20on:\x20','🪙\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','floor','defineProperty','Success','✅\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','EXPIRY_DAYS','payment.failed','webhookLog','🏦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','coinToPayService','stopPeriodicStatusCheck','unknown','loggerService','\x20has\x20no\x20gatewayPaymentId,\x20skipping','toLowerCase','603208sqsIAS','Failed\x20to\x20send\x20shop\x20webhook:','payment.success','getServiceStats','sendPaymentStatusNotification','gatewayPaymentId','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','cointopay','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20status:\x20','Payment\x20not\x20found','amount','now','transactionId','checkPaymentById','checkAllPendingPayments','orderId','logWhiteDomainError','payment','webhookUrl','24tlzpJV','🛑\x20CoinToPay\x20status\x20checking\x20stopped','setDate','checkPaymentStatus','⏰\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','🏦\x20Saved\x20IBAN:\x20','length','⏰\x20Found\x20','./gateways/coinToPayService','✅\x20Completed\x20checking\x20','message','toISOString','\x20days','findUnique','webhookEvents','push','Payment\x20older\x20than\x20','⏰\x20Payment\x20','sendPaymentNotification','Webhook\x20event\x20','FAILED'];a35_0x5f12=function(){return _0x40d7fc;};return a35_0x5f12();}class CoinToPayStatusService{constructor(){const _0x5d9300=a35_0x3874ff;this[_0x5d9300(0xdf)]=null,this['CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x5d9300(0x101)]=0x5,this[_0x5d9300(0x105)]=new coinToPayService_1[(_0x5d9300(0x143))]();}[a35_0x3874ff(0x15b)](){const _0x312539=a35_0x3874ff;console[_0x312539(0xd6)](_0x312539(0x13b)),this[_0x312539(0x11a)]()['catch'](_0x3012f6=>{const _0x2e1415=_0x312539;console[_0x2e1415(0x156)](_0x2e1415(0xe6),_0x3012f6);}),this[_0x312539(0xdf)]=setInterval(async()=>{const _0x2dad38=_0x312539;try{await this['checkAllPendingPayments']();}catch(_0x362e7e){console['error'](_0x2dad38(0xf9),_0x362e7e);}},this[_0x312539(0xf0)]),console['log'](_0x312539(0x100));}[a35_0x3874ff(0x106)](){const _0x49f23d=a35_0x3874ff;this[_0x49f23d(0xdf)]&&(clearInterval(this[_0x49f23d(0xdf)]),this[_0x49f23d(0xdf)]=null,console['log'](_0x49f23d(0x120)));}async[a35_0x3874ff(0x11a)](){const _0x5b0ca6=a35_0x3874ff;try{const _0x2ef55f=await database_1[_0x5b0ca6(0xf5)][_0x5b0ca6(0x11d)]['findMany']({'where':{'gateway':_0x5b0ca6(0x112),'status':_0x5b0ca6(0xe2),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x2ef55f[_0x5b0ca6(0x125)]===0x0){console[_0x5b0ca6(0xd6)](_0x5b0ca6(0xfc));return;}console['log'](_0x5b0ca6(0x154)+_0x2ef55f['length']+_0x5b0ca6(0x148));const _0x25d4fe=await this[_0x5b0ca6(0x158)](_0x2ef55f);console[_0x5b0ca6(0xd6)](_0x5b0ca6(0x126)+_0x25d4fe[_0x5b0ca6(0x125)]+_0x5b0ca6(0x138));for(const _0x8bf1f7 of _0x2ef55f){try{if(_0x25d4fe['includes'](_0x8bf1f7['id'])){console[_0x5b0ca6(0xd6)](_0x5b0ca6(0x130)+_0x8bf1f7['id']+_0x5b0ca6(0x111));continue;}await this['checkSinglePayment'](_0x8bf1f7),await new Promise(_0x5d66b1=>setTimeout(_0x5d66b1,0x7d0));}catch(_0x24e971){console[_0x5b0ca6(0x156)](_0x5b0ca6(0xde)+_0x8bf1f7['id']+':',_0x24e971),loggerService_1[_0x5b0ca6(0x108)][_0x5b0ca6(0x11c)](_0x5b0ca6(0x112),'/status/'+_0x8bf1f7[_0x5b0ca6(0x110)],_0x24e971);}}console[_0x5b0ca6(0xd6)](_0x5b0ca6(0x128)+_0x2ef55f[_0x5b0ca6(0x125)]+_0x5b0ca6(0xe0));}catch(_0x2fe526){console[_0x5b0ca6(0x156)](_0x5b0ca6(0x113),_0x2fe526);}}async[a35_0x3874ff(0x158)](_0x4b2d37){const _0x326b80=a35_0x3874ff,_0x1c3334=[],_0x4c4065=new Date();_0x4c4065[_0x326b80(0x121)](_0x4c4065['getDate']()-this[_0x326b80(0x101)]),console[_0x326b80(0xd6)](_0x326b80(0x123)+this[_0x326b80(0x101)]+'\x20days\x20(created\x20before\x20'+_0x4c4065[_0x326b80(0x12a)]()+')');for(const _0x347c06 of _0x4b2d37){if(_0x347c06[_0x326b80(0x13c)]<_0x4c4065){console[_0x326b80(0xd6)]('⏰\x20Payment\x20'+_0x347c06['id']+'\x20is\x20older\x20than\x20'+this[_0x326b80(0x101)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{await database_1[_0x326b80(0xf5)][_0x326b80(0x11d)][_0x326b80(0xf1)]({'where':{'id':_0x347c06['id']},'data':{'status':_0x326b80(0x14c),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this['EXPIRY_DAYS']+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x326b80(0xf5)][_0x326b80(0x103)][_0x326b80(0x150)]({'data':{'paymentId':_0x347c06['id'],'shopId':_0x347c06['shopId'],'event':_0x326b80(0xee),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x326b80(0x12f)+this['EXPIRY_DAYS']+_0x326b80(0x12b),'createdAt':_0x347c06[_0x326b80(0x13c)],'expiredAt':new Date()[_0x326b80(0x12a)](),'daysSinceCreation':Math[_0x326b80(0xfd)]((Date[_0x326b80(0x117)]()-_0x347c06[_0x326b80(0x13c)][_0x326b80(0xe4)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x326b80(0xf6)](_0x347c06,_0x326b80(0x14c)),await this[_0x326b80(0x10f)](_0x347c06,_0x326b80(0x14c)),_0x1c3334[_0x326b80(0x12e)](_0x347c06['id']),console['log'](_0x326b80(0x136)+_0x347c06['id']+_0x326b80(0xf3)+this[_0x326b80(0x101)]+_0x326b80(0xe3));}catch(_0x52bad8){console[_0x326b80(0x156)]('Failed\x20to\x20expire\x20payment\x20'+_0x347c06['id']+':',_0x52bad8);}}}return _0x1c3334;}async[a35_0x3874ff(0xdd)](_0x12a42e){const _0x57e258=a35_0x3874ff;if(!_0x12a42e['gatewayPaymentId']){console[_0x57e258(0xd6)](_0x57e258(0xf8)+_0x12a42e['id']+_0x57e258(0x109));return;}console['log'](_0x57e258(0xd3)+_0x12a42e['id']+'\x20('+_0x12a42e[_0x57e258(0x110)]+')');try{const _0x343abc=await this['coinToPayService'][_0x57e258(0x122)](_0x12a42e['gatewayPaymentId']);console[_0x57e258(0xd6)](_0x57e258(0x14a)+_0x12a42e['id']+_0x57e258(0x114)+_0x343abc[_0x57e258(0xd4)]);_0x343abc[_0x57e258(0x13e)]&&console[_0x57e258(0xd6)](_0x57e258(0x14a)+_0x12a42e['id']+'\x20details:',{'iban':_0x343abc['paymentDetails']['iban']||_0x57e258(0x13d),'transactionId':_0x343abc[_0x57e258(0x13e)]['transactionId'],'createdOn':_0x343abc[_0x57e258(0x13e)]['createdOn'],'confirmedOn':_0x343abc[_0x57e258(0x13e)][_0x57e258(0xe1)]||'not\x20confirmed'});if(_0x343abc[_0x57e258(0xd4)]!==_0x12a42e[_0x57e258(0xd4)]){console['log']('🔄\x20Updating\x20payment\x20'+_0x12a42e['id']+_0x57e258(0x145)+_0x12a42e['status']+'\x20to\x20'+_0x343abc[_0x57e258(0xd4)]);const _0x452d72={'status':_0x343abc['status'],'updatedAt':new Date()};_0x343abc[_0x57e258(0xd4)]===_0x57e258(0x135)&&_0x12a42e['status']!=='PAID'&&(_0x452d72[_0x57e258(0xda)]=new Date(),console[_0x57e258(0xd6)](_0x57e258(0x151)+_0x12a42e['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x452d72['paidAt'][_0x57e258(0x12a)]()));if(_0x343abc[_0x57e258(0x13e)]){const _0x1c38e0=_0x343abc[_0x57e258(0x13e)];_0x1c38e0[_0x57e258(0x137)]&&(_0x452d72[_0x57e258(0xed)]=_0x1c38e0[_0x57e258(0x137)],console[_0x57e258(0xd6)](_0x57e258(0x124)+_0x1c38e0[_0x57e258(0x137)]));if(_0x1c38e0[_0x57e258(0x14b)]){const _0x5b9553=_0x12a42e['adminNotes']||'',_0x34e74d=_0x57e258(0x146)+_0x1c38e0['bankDetails'];_0x452d72[_0x57e258(0x157)]=_0x5b9553?_0x5b9553+'\x0a\x0a'+_0x34e74d:_0x34e74d,console[_0x57e258(0xd6)](_0x57e258(0x104));}_0x1c38e0[_0x57e258(0x118)]&&console[_0x57e258(0xd6)](_0x57e258(0x14e)+_0x1c38e0[_0x57e258(0x118)]),_0x1c38e0[_0x57e258(0xe1)]&&console['log'](_0x57e258(0xfb)+_0x1c38e0['confirmedOn']);}await database_1[_0x57e258(0xf5)][_0x57e258(0x11d)][_0x57e258(0xf1)]({'where':{'id':_0x12a42e['id']},'data':_0x452d72}),await database_1[_0x57e258(0xf5)][_0x57e258(0x103)][_0x57e258(0x150)]({'data':{'paymentId':_0x12a42e['id'],'shopId':_0x12a42e[_0x57e258(0x152)],'event':_0x57e258(0xef)+_0x343abc[_0x57e258(0xd4)][_0x57e258(0x10a)](),'statusCode':0xc8,'responseBody':JSON[_0x57e258(0xd7)]({'oldStatus':_0x12a42e[_0x57e258(0xd4)],'newStatus':_0x343abc[_0x57e258(0xd4)],'paymentDetails':_0x343abc['paymentDetails'],'checkedAt':new Date()[_0x57e258(0x12a)]()})}}),await this[_0x57e258(0xf6)](_0x12a42e,_0x343abc[_0x57e258(0xd4)]),await this[_0x57e258(0x10f)](_0x12a42e,_0x343abc[_0x57e258(0xd4)]),console[_0x57e258(0xd6)](_0x57e258(0x136)+_0x12a42e['id']+'\x20updated\x20successfully');}else console[_0x57e258(0xd6)](_0x57e258(0x14a)+_0x12a42e['id']+'\x20status\x20unchanged\x20('+_0x343abc['status']+')');}catch(_0x2018bb){console[_0x57e258(0x156)](_0x57e258(0x153)+_0x12a42e['id']+':',_0x2018bb),await database_1[_0x57e258(0xf5)][_0x57e258(0x103)]['create']({'data':{'paymentId':_0x12a42e['id'],'shopId':_0x12a42e[_0x57e258(0x152)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x57e258(0xd7)]({'error':_0x2018bb instanceof Error?_0x2018bb[_0x57e258(0x129)]:'Unknown\x20error','gatewayPaymentId':_0x12a42e[_0x57e258(0x110)],'checkedAt':new Date()['toISOString']()})}});}}async[a35_0x3874ff(0xf6)](_0x325fc7,_0x5db871){const _0x30ed05=a35_0x3874ff,_0x4f27d7=Date[_0x30ed05(0x117)]();try{const _0x164a6c=_0x325fc7[_0x30ed05(0x142)],_0x4b7aaf=_0x164a6c[_0x30ed05(0x139)];if(!_0x4b7aaf?.[_0x30ed05(0x11e)]){console[_0x30ed05(0xd6)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x164a6c['id']);return;}const _0x139df9=_0x5db871===_0x30ed05(0x135)?_0x30ed05(0x10d):_0x5db871===_0x30ed05(0x133)?_0x30ed05(0x102):_0x5db871==='EXPIRED'?_0x30ed05(0x102):_0x30ed05(0xea);if(!_0x4b7aaf[_0x30ed05(0x12d)]?.[_0x30ed05(0xd9)](_0x139df9)){console['log'](_0x30ed05(0x132)+_0x139df9+_0x30ed05(0xd2)+_0x164a6c['id']);return;}const _0x47c123={'event':_0x139df9,'payment':{'id':_0x325fc7['id'],'order_id':_0x325fc7[_0x30ed05(0x11b)],'gateway_order_id':_0x325fc7['gatewayOrderId'],'gateway':'0100','amount':_0x325fc7[_0x30ed05(0x116)],'currency':_0x325fc7[_0x30ed05(0xfa)],'status':_0x5db871[_0x30ed05(0x10a)](),'customer_email':_0x325fc7[_0x30ed05(0x134)],'customer_name':_0x325fc7['customerName'],'created_at':_0x325fc7['createdAt'],'updated_at':new Date()}},_0x304fe6=await fetch(_0x4b7aaf['webhookUrl'],{'method':_0x30ed05(0xec),'headers':{'Content-Type':_0x30ed05(0xf7),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x47c123)}),_0x33f100=Date['now']()-_0x4f27d7,_0x3bbf6e=_0x304fe6['ok']?_0x30ed05(0xff):await _0x304fe6[_0x30ed05(0xf4)]();loggerService_1[_0x30ed05(0x108)][_0x30ed05(0xe8)](_0x325fc7[_0x30ed05(0x152)],_0x4b7aaf[_0x30ed05(0x11e)],_0x139df9,_0x304fe6[_0x30ed05(0xd4)],_0x33f100,_0x47c123),console[_0x30ed05(0xd6)](_0x30ed05(0x149)+_0x4b7aaf[_0x30ed05(0x11e)]+_0x30ed05(0x13a)+_0x304fe6['status']+'\x20('+_0x33f100+'ms)');}catch(_0x7ac7c2){console['error'](_0x30ed05(0x10c),_0x7ac7c2),loggerService_1['loggerService'][_0x30ed05(0xd1)](_0x325fc7[_0x30ed05(0x152)],_0x325fc7[_0x30ed05(0x142)]?.['settings']?.[_0x30ed05(0x11e)]||_0x30ed05(0x107),_0x30ed05(0xe7),_0x7ac7c2,{});}}async[a35_0x3874ff(0x10f)](_0x59d75a,_0x4eadce){const _0xfd96ba=a35_0x3874ff;try{const _0x5515ee={'PENDING':_0xfd96ba(0x14f),'PAID':'paid','FAILED':_0xfd96ba(0x141),'EXPIRED':_0xfd96ba(0x140)},_0x825e9f=_0x5515ee[_0x4eadce];if(!_0x825e9f||_0x825e9f===_0xfd96ba(0x14f))return;await telegramBotService_1[_0xfd96ba(0x13f)][_0xfd96ba(0x131)](_0x59d75a[_0xfd96ba(0x152)],_0x59d75a,_0x825e9f);}catch(_0x401dee){console['error'](_0xfd96ba(0xf2),_0x401dee);}}async[a35_0x3874ff(0x119)](_0x14661a){const _0x399761=a35_0x3874ff,_0x38a9d3=await database_1[_0x399761(0xf5)][_0x399761(0x11d)][_0x399761(0x12c)]({'where':{'id':_0x14661a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x38a9d3)throw new Error(_0x399761(0x115));if(_0x38a9d3['gateway']!=='cointopay')throw new Error(_0x399761(0xd8));await this[_0x399761(0xdd)](_0x38a9d3);}[a35_0x3874ff(0x10e)](){const _0x4bc7ea=a35_0x3874ff,_0x5f336f=this[_0x4bc7ea(0xdf)]?this['CHECK_INTERVAL_MS']:undefined;return{'isActive':!!this[_0x4bc7ea(0xdf)],'checkIntervalMinutes':this[_0x4bc7ea(0xf0)]/(0x3e8*0x3c),'expiryDays':this[_0x4bc7ea(0x101)],'nextCheckIn':_0x5f336f};}}exports[a35_0x3874ff(0x144)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();