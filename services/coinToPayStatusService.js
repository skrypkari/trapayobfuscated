'use strict';function a38_0x3641(_0xb70651,_0x511f10){const _0x1a04d7=a38_0x1a04();return a38_0x3641=function(_0x364139,_0x4bdfba){_0x364139=_0x364139-0x187;let _0x48a293=_0x1a04d7[_0x364139];return _0x48a293;},a38_0x3641(_0xb70651,_0x511f10);}function a38_0x1a04(){const _0xbcee1b=['../types/gateway','default','⏰\x20[GLOBAL]\x20Found\x20','⏰\x20[EXPIRY]\x20Payment\x20','length','✅\x20[EXPIRY]\x20Payment\x20','\x20(age:\x20','./currencyService','cointopay2','payment.pending','🧹\x20[CHECK]\x20Payment\x20','\x20not\x20enabled\x20for\x20shop\x20','\x20commission:\x20','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','Bank\x20Details:\x20','get','timers','checkSinglePaymentById','transactionId','\x20has\x20no\x20gatewayPaymentId','✅\x20[CHECK]\x20Payment\x20','stack','__importDefault','checkExpiredPayments','paymentTimers','❌\x20[HOURLY]\x20Payment\x20','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20timers\x20for\x20payment\x20','CoinToPay2Service','✅\x20[COINTOPAY]\x20Payment\x20link\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','delay','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','amount','PAID','72457cBGbQv','\x20skipped,\x20','3vTrzZw','schedulePaymentChecks','getGatewayIdByName','📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','📈\x20[COINTOPAY]\x20Payment\x20','checkPaymentById','getTime','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','application/json','floor','gatewayPaymentId','checkPaymentStatus','orderId','🛑\x20[SHUTDOWN]\x20Cleared\x20','error','497340zVisHI','webhook_send','coinToPayService','\x20has\x20no\x20gatewayPaymentId,\x20skipping','getPaymentTimerInfo','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','Shop\x20webhook\x20sent\x20to\x20','setDate','\x20details:','Automatically\x20expired\x20after\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','logCoinToPayStatus','convertToUSDT','iban','🔍\x20[CHECK]\x20Checking\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20checked,\x20','checkSinglePayment','ms)','currency','\x20\x20\x20Amount:\x20','clearPaymentTimers','description','now','EXPIRED','\x20pending\x20CoinToPay\x20payments','push','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20to\x20clear','sendShopWebhook','\x20status\x20is\x20','\x20is\x20too\x20new\x20(','stringify','\x20expired','\x20\x20\x20-\x20paymentId:\x20','includes','📊\x20[HOURLY]\x20Payment\x20','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','amountUSDT','\x20\x20\x20-\x20Status:\x20','forEach','🪙\x20[TIMER]\x20Individual\x20check\x20#','confirmedOn','webhookLog','telegramBotService','✅\x20[TIMER]\x20Individual\x20check\x20#','shopId','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20',',\x20stopping\x20individual\x20checks','Gateway\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','toFixed','\x20expired\x20CoinToPay\x20payments','timestamp','🧹\x20[DEBUG]\x20Clearing\x20','auto_expire','⏰\x20[HOURLY]\x20Payment\x20','findUnique','status','\x20\x20\x20📝\x20Context:','FAILED','1711953BfmdUW','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20triggered\x20for\x20payment\x20','\x20with\x20status\x20','not\x20found','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','2073010tPxXeS','CoinToPayStatusService','__esModule','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','Webhook\x20event\x20','paid','size','\x20in\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','coinToPay2Service','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','currencyService','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','GLOBAL_CHECK_INTERVAL_MS','bankDetails','./telegramBotService','shop','currentPayments','amountAfterGatewayCommissionUSDT','\x20\x20\x20-\x20Gateway:\x20','paymentId','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20updated\x20successfully','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20\x20\x20📝\x20Details:','payment.success','cointopay','../config/database','\x20status\x20from\x20','paidAt','update','./gateways/coinToPay2Service','getDate','\x20to\x20','\x20\x20\x20📊\x20Status:\x20','getGatewayCommission','set','toLowerCase','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','globalCheckInterval','📊\x20[CHECK]\x20Payment\x20','gateway','\x20USDT','88FlWifx','payment.failed','createdOn','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','logShopWebhookSent','\x20days,\x20marking\x20as\x20EXPIRED','message','text','webhookUrl','\x20\x20\x20-\x20gatewayPaymentId:\x20','remitterIban','\x20\x20\x20📅\x20Time:\x20','toISOString',',\x20status=',',\x20clearing\x20individual\x20timers','catch','Failed\x20to\x20mark\x20payment\x20as\x20expired',':\x20type=','\x20commission\x20for\x20shop\x20','paymentLink','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','commission','loggerService','\x20current\x20status:\x20','COMPLETED','\x20completed\x20for\x20payment\x20','checkAllPendingPayments','\x20\x20\x20-\x20ShopId:\x20','❌\x20[CHECK]\x20Payment\x20','EXPIRY_DAYS','SINGLE','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','settings','type','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','adminNotes','paymentDetails','sendPaymentNotification','.\x20Remaining\x20active\x20timers:\x20',',\x20gateway\x20','564560cNRZeD','\x20days','payment','from','\x20seconds\x20(','logCoinToPayError','💰\x20[CHECK]\x20Payment\x20',',\x20using\x20default\x20commission\x2010%','h),\x20skipping\x20global\x20check','83046unUQtM','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','./gateways/coinToPayService','created','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed',',\x20using\x20default\x2010%','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20is\x20older\x20than\x20','\x20for\x20payment\x20','findMany','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20marked\x20as\x20paid\x20at:\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','45VpLpoQ','⏰\x20[GLOBAL]\x20Payment\x20','5\x20minutes','expired','cointopay_status_check_','sendPaymentStatusNotification','delete','TesSoft\x20Payment\x20System/1.0','⚠️\x20[CHECK]\x20Payment\x20','cointopay_status_check_error','CoinToPayService','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','defineProperty','\x20\x20\x20-\x20Amount:\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','customerEmail','create','Payment\x20older\x20than\x20','2\x20minutes','gatewayOrderId','\x20\x20\x20📍\x20Source:\x20','COINTOPAY_ERROR','log','Unknown\x20error','not\x20confirmed','status_check','failed','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','stopPeriodicStatusCheck','\x20->\x20','PENDING',',\x20currentPayments=','21323NsbuNI','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','entries','coinToPayStatusService','createdAt','🪙\x20[DEBUG]\x20Creating\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','✅\x20[HOURLY]\x20Payment\x20','unknown','POST','\x20status:\x20'];a38_0x1a04=function(){return _0xbcee1b;};return a38_0x1a04();}const a38_0x40bb99=a38_0x3641;(function(_0x289a85,_0x1c5c77){const _0x2a3276=a38_0x3641,_0x115e0f=_0x289a85();while(!![]){try{const _0xf86eff=parseInt(_0x2a3276(0x18d))/0x1+parseInt(_0x2a3276(0x1d0))/0x2+-parseInt(_0x2a3276(0x1c1))/0x3*(parseInt(_0x2a3276(0x26b))/0x4)+-parseInt(_0x2a3276(0x282))/0x5*(-parseInt(_0x2a3276(0x274))/0x6)+-parseInt(_0x2a3276(0x1bf))/0x7*(parseInt(_0x2a3276(0x243))/0x8)+-parseInt(_0x2a3276(0x20f))/0x9+parseInt(_0x2a3276(0x215))/0xa;if(_0xf86eff===_0x1c5c77)break;else _0x115e0f['push'](_0x115e0f['shift']());}catch(_0x232b02){_0x115e0f['push'](_0x115e0f['shift']());}}}(a38_0x1a04,0x263e5));var __importDefault=this&&this[a38_0x40bb99(0x1b0)]||function(_0x2f6cf8){const _0x2de380=a38_0x40bb99;return _0x2f6cf8&&_0x2f6cf8[_0x2de380(0x217)]?_0x2f6cf8:{'default':_0x2f6cf8};};Object[a38_0x40bb99(0x28e)](exports,a38_0x40bb99(0x217),{'value':!![]}),exports[a38_0x40bb99(0x190)]=exports[a38_0x40bb99(0x216)]=void 0x0;const coinToPayService_1=require(a38_0x40bb99(0x277)),coinToPay2Service_1=require(a38_0x40bb99(0x236)),gateway_1=require(a38_0x40bb99(0x198)),database_1=__importDefault(require(a38_0x40bb99(0x232))),telegramBotService_1=require(a38_0x40bb99(0x226)),loggerService_1=require('./loggerService'),currencyService_1=require(a38_0x40bb99(0x19f));class CoinToPayStatusService{constructor(){const _0x150706=a38_0x40bb99;this[_0x150706(0x23f)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x150706(0x260)]=0x5,this[_0x150706(0x1b2)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x150706(0x28c))](),this[_0x150706(0x21e)]=new coinToPay2Service_1[(_0x150706(0x1b7))](),console[_0x150706(0x298)](_0x150706(0x246));}[a38_0x40bb99(0x1c2)](_0x236402,_0xdeacf4){const _0xe54d9e=a38_0x40bb99;console['log']('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0xe54d9e(0x298)](_0xe54d9e(0x1f4)+_0x236402),console[_0xe54d9e(0x298)](_0xe54d9e(0x24c)+_0xdeacf4),this[_0xe54d9e(0x1e7)](_0x236402);const _0x232153=[],_0x44c542=new Date(),_0x2c8b1f=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0xe54d9e(0x294)},{'delay':0x5*0x3c*0x3e8,'description':_0xe54d9e(0x284)},{'delay':0x5*0x3c*0x3e8,'description':_0xe54d9e(0x284)}];console[_0xe54d9e(0x298)](_0xe54d9e(0x192)+_0x2c8b1f['length']+'\x20initial\x20timers\x20for\x20payment\x20'+_0x236402);let _0x2d9a95=0x0;_0x2c8b1f['forEach']((_0x24e12f,_0x339708)=>{const _0x30a7b0=_0xe54d9e;_0x2d9a95+=_0x24e12f['delay'];const _0x35ee10=setTimeout(async()=>{const _0x58df60=a38_0x3641;console[_0x58df60(0x298)](_0x58df60(0x1fb)+(_0x339708+0x1)+_0x58df60(0x211)+_0x236402+'\x20(after\x20'+_0x24e12f[_0x58df60(0x1e8)]+')');try{await this['checkSinglePaymentById'](_0x236402),console[_0x58df60(0x298)](_0x58df60(0x1ff)+(_0x339708+0x1)+_0x58df60(0x25c)+_0x236402);}catch(_0x488748){console[_0x58df60(0x1cf)](_0x58df60(0x223)+(_0x339708+0x1)+_0x58df60(0x27d)+_0x236402+':',_0x488748),this['logCoinToPayError'](_0x236402,_0xdeacf4,_0x488748,'status_check',{'checkNumber':_0x339708+0x1,'scheduledAfter':_0x24e12f[_0x58df60(0x1e8)],'isIndividualCheck':!![]});}},_0x2d9a95);_0x232153[_0x30a7b0(0x1ec)](_0x35ee10),console[_0x30a7b0(0x298)](_0x30a7b0(0x1ed)+(_0x339708+0x1)+_0x30a7b0(0x27d)+_0x236402+_0x30a7b0(0x21c)+_0x2d9a95/0x3e8+_0x30a7b0(0x26f)+_0x24e12f[_0x30a7b0(0x1e8)]+')');});const _0x3324f3=setInterval(async()=>{const _0x265f8f=_0xe54d9e;console[_0x265f8f(0x298)](_0x265f8f(0x23e)+_0x236402);try{const _0x4b372b=await database_1[_0x265f8f(0x199)][_0x265f8f(0x26d)]['findUnique']({'where':{'id':_0x236402},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x4b372b){console[_0x265f8f(0x298)](_0x265f8f(0x1b3)+_0x236402+'\x20not\x20found,\x20clearing\x20timers'),this[_0x265f8f(0x1e7)](_0x236402);return;}console[_0x265f8f(0x298)](_0x265f8f(0x1f6)+_0x236402+_0x265f8f(0x25a)+_0x4b372b[_0x265f8f(0x20c)]);if(_0x4b372b[_0x265f8f(0x20c)]!==_0x265f8f(0x18b)){console[_0x265f8f(0x298)](_0x265f8f(0x194)+_0x236402+'\x20status\x20is\x20'+_0x4b372b[_0x265f8f(0x20c)]+',\x20stopping\x20individual\x20checks'),this[_0x265f8f(0x1e7)](_0x236402);return;}const _0x157023=Math[_0x265f8f(0x1ca)]((Date[_0x265f8f(0x1e9)]()-_0x4b372b['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x157023>=this['EXPIRY_DAYS']){console[_0x265f8f(0x298)](_0x265f8f(0x20a)+_0x236402+_0x265f8f(0x27c)+this[_0x265f8f(0x260)]+_0x265f8f(0x210)),this['clearPaymentTimers'](_0x236402);return;}await this[_0x265f8f(0x1ab)](_0x236402),console[_0x265f8f(0x298)](_0x265f8f(0x1a7)+_0x236402);}catch(_0x2c6106){console[_0x265f8f(0x1cf)]('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x236402+':',_0x2c6106),this[_0x265f8f(0x270)](_0x236402,_0xdeacf4,_0x2c6106,_0x265f8f(0x29b),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x232153[_0xe54d9e(0x1ec)](_0x3324f3),this[_0xe54d9e(0x1b2)][_0xe54d9e(0x23b)](_0x236402,{'timers':_0x232153,'paymentId':_0x236402,'gatewayPaymentId':_0xdeacf4,'createdAt':_0x44c542}),console[_0xe54d9e(0x298)](_0xe54d9e(0x222)+_0x2c8b1f['length']+_0xe54d9e(0x201)+_0x236402),console[_0xe54d9e(0x298)]('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this['paymentTimers'][_0xe54d9e(0x21b)]),this[_0xe54d9e(0x1dc)](_0x236402,_0xdeacf4,_0xe54d9e(0x18b),_0xe54d9e(0x18b),_0xe54d9e(0x29b),{'action':'schedule_created','scheduledChecks':_0x2c8b1f[_0xe54d9e(0x19c)],'firstCheckIn':_0x2c8b1f[0x0][_0xe54d9e(0x1ba)]/0x3e8,'totalTimers':this[_0xe54d9e(0x1b2)][_0xe54d9e(0x21b)]});}[a38_0x40bb99(0x1e7)](_0x3a43df){const _0x1a1554=a38_0x40bb99,_0x2df851=this[_0x1a1554(0x1b2)][_0x1a1554(0x1a9)](_0x3a43df);_0x2df851?(console[_0x1a1554(0x298)](_0x1a1554(0x208)+_0x2df851['timers']['length']+_0x1a1554(0x1b6)+_0x3a43df),_0x2df851[_0x1a1554(0x1aa)][_0x1a1554(0x1fa)]((_0xd5427a,_0x26b762)=>{const _0x11695a=_0x1a1554;_0xd5427a&&(clearTimeout(_0xd5427a),clearInterval(_0xd5427a),console['log'](_0x11695a(0x204)+(_0x26b762+0x1)+_0x11695a(0x27d)+_0x3a43df));}),this[_0x1a1554(0x1b2)][_0x1a1554(0x288)](_0x3a43df),console[_0x1a1554(0x298)](_0x1a1554(0x27f)+_0x3a43df+_0x1a1554(0x269)+this[_0x1a1554(0x1b2)][_0x1a1554(0x21b)])):console['log'](_0x1a1554(0x257)+_0x3a43df+_0x1a1554(0x1ee));}async[a38_0x40bb99(0x1ab)](_0xe01e8f){const _0xdbc904=a38_0x40bb99;console[_0xdbc904(0x298)](_0xdbc904(0x290)+_0xe01e8f);const _0xeccc32=await database_1[_0xdbc904(0x199)][_0xdbc904(0x26d)][_0xdbc904(0x20b)]({'where':{'id':_0xe01e8f},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xeccc32){console['log'](_0xdbc904(0x25f)+_0xe01e8f+'\x20not\x20found\x20in\x20database');return;}console['log'](_0xdbc904(0x240)+_0xe01e8f+'\x20found:'),console[_0xdbc904(0x298)](_0xdbc904(0x22a)+_0xeccc32[_0xdbc904(0x241)]),console[_0xdbc904(0x298)](_0xdbc904(0x1f9)+_0xeccc32[_0xdbc904(0x20c)]),console['log']('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0xeccc32[_0xdbc904(0x1cb)]),console[_0xdbc904(0x298)](_0xdbc904(0x28f)+_0xeccc32['amount']+'\x20'+_0xeccc32[_0xdbc904(0x1e5)]),console['log'](_0xdbc904(0x25e)+_0xeccc32[_0xdbc904(0x200)]);if(_0xeccc32['gateway']!==_0xdbc904(0x231)&&_0xeccc32[_0xdbc904(0x241)]!==_0xdbc904(0x1a0)){console[_0xdbc904(0x298)](_0xdbc904(0x28a)+_0xe01e8f+_0xdbc904(0x1a5)+_0xeccc32[_0xdbc904(0x241)]+')');return;}if(_0xeccc32[_0xdbc904(0x20c)]!==_0xdbc904(0x18b)){console[_0xdbc904(0x298)](_0xdbc904(0x28a)+_0xe01e8f+_0xdbc904(0x1f0)+_0xeccc32[_0xdbc904(0x20c)]+_0xdbc904(0x202)),this['clearPaymentTimers'](_0xe01e8f);return;}if(!_0xeccc32[_0xdbc904(0x1cb)]){console['log'](_0xdbc904(0x28a)+_0xe01e8f+_0xdbc904(0x1ad));return;}console[_0xdbc904(0x298)](_0xdbc904(0x1ae)+_0xe01e8f+_0xdbc904(0x193)),await this[_0xdbc904(0x1e3)](_0xeccc32);}[a38_0x40bb99(0x1dc)](_0x2d5ab4,_0x308cc6,_0x460d14,_0x559a22,_0x21f82e,_0x547718){const _0x34e0c0=a38_0x40bb99,_0x4c20f9={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x2d5ab4,'gatewayPaymentId':_0x308cc6,'oldStatus':_0x460d14,'newStatus':_0x559a22,'source':_0x21f82e,'timestamp':new Date()[_0x34e0c0(0x24f)](),'details':_0x547718||{}};loggerService_1[_0x34e0c0(0x259)][_0x34e0c0(0x1dc)](_0x4c20f9),console[_0x34e0c0(0x298)](_0x34e0c0(0x1f7)+_0x2d5ab4+'\x20('+_0x308cc6+')'),console[_0x34e0c0(0x298)](_0x34e0c0(0x239)+_0x460d14+_0x34e0c0(0x18a)+_0x559a22),console['log'](_0x34e0c0(0x296)+_0x21f82e),console[_0x34e0c0(0x298)](_0x34e0c0(0x24e)+_0x4c20f9['timestamp']),_0x547718&&console['log'](_0x34e0c0(0x22f),_0x547718);}['logCoinToPayError'](_0x3dadea,_0x24fa68,_0x23491e,_0x3cb045,_0x1e1622){const _0x1746e6=a38_0x40bb99,_0x2068ed={'type':_0x1746e6(0x297),'paymentId':_0x3dadea,'gatewayPaymentId':_0x24fa68,'error':_0x23491e instanceof Error?{'message':_0x23491e['message'],'stack':_0x23491e[_0x1746e6(0x1af)]}:_0x23491e,'source':_0x3cb045,'timestamp':new Date()[_0x1746e6(0x24f)](),'context':_0x1e1622||{}};loggerService_1[_0x1746e6(0x259)][_0x1746e6(0x270)](_0x2068ed),console[_0x1746e6(0x1cf)](_0x1746e6(0x262)+_0x3dadea+'\x20('+_0x24fa68+')'),console['error']('\x20\x20\x20❌\x20Error:\x20'+(_0x23491e instanceof Error?_0x23491e[_0x1746e6(0x249)]:_0x23491e)),console['error'](_0x1746e6(0x296)+_0x3cb045),console[_0x1746e6(0x1cf)](_0x1746e6(0x24e)+_0x2068ed[_0x1746e6(0x207)]),_0x1e1622&&console[_0x1746e6(0x1cf)](_0x1746e6(0x20d),_0x1e1622);}['startPeriodicStatusCheck'](){const _0xa01cdf=a38_0x40bb99;console[_0xa01cdf(0x298)](_0xa01cdf(0x220)),this[_0xa01cdf(0x25d)]()[_0xa01cdf(0x252)](_0x11543a=>{const _0x31f582=_0xa01cdf;console[_0x31f582(0x1cf)]('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x11543a);}),this[_0xa01cdf(0x23f)]=setInterval(async()=>{const _0x26fa78=_0xa01cdf;try{console[_0x26fa78(0x298)](_0x26fa78(0x1bc)),await this[_0x26fa78(0x25d)](),console[_0x26fa78(0x298)](_0x26fa78(0x279));}catch(_0x4ea0e5){console['error'](_0x26fa78(0x1b9),_0x4ea0e5);}},this['GLOBAL_CHECK_INTERVAL_MS']),console['log'](_0xa01cdf(0x1b4));}[a38_0x40bb99(0x189)](){const _0x54c68e=a38_0x40bb99;console['log']('🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this['globalCheckInterval']&&(clearInterval(this[_0x54c68e(0x23f)]),this['globalCheckInterval']=null,console[_0x54c68e(0x298)](_0x54c68e(0x28d)));const _0x2f1964=this[_0x54c68e(0x1b2)][_0x54c68e(0x21b)];for(const [_0x2b59c5]of this['paymentTimers']){this[_0x54c68e(0x1e7)](_0x2b59c5);}console[_0x54c68e(0x298)](_0x54c68e(0x1ce)+_0x2f1964+'\x20individual\x20payment\x20timers');}async[a38_0x40bb99(0x25d)](){const _0x4dfd38=a38_0x40bb99;try{console[_0x4dfd38(0x298)](_0x4dfd38(0x21d));const _0x3a030e=await database_1['default'][_0x4dfd38(0x26d)][_0x4dfd38(0x27e)]({'where':{'gateway':{'in':[_0x4dfd38(0x231),'cointopay2']},'status':_0x4dfd38(0x18b),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log']('🪙\x20[GLOBAL]\x20Found\x20'+_0x3a030e[_0x4dfd38(0x19c)]+_0x4dfd38(0x1eb));if(_0x3a030e[_0x4dfd38(0x19c)]===0x0){console[_0x4dfd38(0x298)](_0x4dfd38(0x1b5));return;}const _0xab40e=await this['checkExpiredPayments'](_0x3a030e);console[_0x4dfd38(0x298)](_0x4dfd38(0x19a)+_0xab40e['length']+_0x4dfd38(0x206));let _0xe65b4c=0x0,_0x442501=0x0;for(const _0x5c3d48 of _0x3a030e){try{if(_0xab40e[_0x4dfd38(0x1f5)](_0x5c3d48['id'])){console[_0x4dfd38(0x298)](_0x4dfd38(0x283)+_0x5c3d48['id']+_0x4dfd38(0x1e1)),_0x442501++;continue;}if(this[_0x4dfd38(0x1b2)]['has'](_0x5c3d48['id'])){console['log'](_0x4dfd38(0x283)+_0x5c3d48['id']+_0x4dfd38(0x22c)),_0x442501++;continue;}const _0x2706c4=(Date['now']()-_0x5c3d48[_0x4dfd38(0x191)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x2706c4<0x1){console['log'](_0x4dfd38(0x283)+_0x5c3d48['id']+_0x4dfd38(0x1f1)+_0x2706c4[_0x4dfd38(0x205)](0x1)+_0x4dfd38(0x273)),_0x442501++;continue;}console['log'](_0x4dfd38(0x1a6)+_0x5c3d48['id']+_0x4dfd38(0x19e)+_0x2706c4[_0x4dfd38(0x205)](0x1)+'h)'),await this['checkSinglePayment'](_0x5c3d48),_0xe65b4c++,await new Promise(_0x4bd449=>setTimeout(_0x4bd449,0x7d0));}catch(_0x5b6095){console[_0x4dfd38(0x1cf)](_0x4dfd38(0x1e0)+_0x5c3d48['id']+':',_0x5b6095),this['logCoinToPayError'](_0x5c3d48['id'],_0x5c3d48[_0x4dfd38(0x1cb)]||'unknown',_0x5b6095,_0x4dfd38(0x29b),{'isGlobalCheck':!![],'paymentAmount':_0x5c3d48['amount'],'paymentCurrency':_0x5c3d48[_0x4dfd38(0x1e5)],'shopId':_0x5c3d48[_0x4dfd38(0x200)],'createdAt':_0x5c3d48[_0x4dfd38(0x191)]}),loggerService_1['loggerService']['logWhiteDomainError'](_0x4dfd38(0x231),'/status/'+_0x5c3d48['gatewayPaymentId'],_0x5b6095);}}console[_0x4dfd38(0x298)]('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0xe65b4c+_0x4dfd38(0x1e2)+_0x442501+_0x4dfd38(0x1c0)+_0xab40e[_0x4dfd38(0x19c)]+_0x4dfd38(0x1f3));}catch(_0x49c170){console[_0x4dfd38(0x1cf)](_0x4dfd38(0x27b),_0x49c170);}}async[a38_0x40bb99(0x1b1)](_0x3a994f){const _0xd25b05=a38_0x40bb99,_0x12838b=[],_0x38f835=new Date();_0x38f835[_0xd25b05(0x1d7)](_0x38f835[_0xd25b05(0x237)]()-this['EXPIRY_DAYS']),console[_0xd25b05(0x298)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0xd25b05(0x260)]+'\x20days\x20(created\x20before\x20'+_0x38f835[_0xd25b05(0x24f)]()+')');for(const _0x374c6a of _0x3a994f){if(_0x374c6a[_0xd25b05(0x191)]<_0x38f835){console[_0xd25b05(0x298)](_0xd25b05(0x19b)+_0x374c6a['id']+_0xd25b05(0x27c)+this[_0xd25b05(0x260)]+_0xd25b05(0x248));try{this[_0xd25b05(0x1dc)](_0x374c6a['id'],_0x374c6a[_0xd25b05(0x1cb)]||_0xd25b05(0x195),_0xd25b05(0x18b),'EXPIRED',_0xd25b05(0x209),{'reason':_0xd25b05(0x293)+this['EXPIRY_DAYS']+_0xd25b05(0x26c),'createdAt':_0x374c6a[_0xd25b05(0x191)],'daysSinceCreation':Math[_0xd25b05(0x1ca)]((Date[_0xd25b05(0x1e9)]()-_0x374c6a['createdAt'][_0xd25b05(0x1c7)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x374c6a['amount'],'paymentCurrency':_0x374c6a[_0xd25b05(0x1e5)],'shopId':_0x374c6a['shopId']}),await database_1[_0xd25b05(0x199)][_0xd25b05(0x26d)][_0xd25b05(0x235)]({'where':{'id':_0x374c6a['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0xd25b05(0x1d9)+this[_0xd25b05(0x260)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0xd25b05(0x199)][_0xd25b05(0x1fd)][_0xd25b05(0x292)]({'data':{'paymentId':_0x374c6a['id'],'shopId':_0x374c6a['shopId'],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0xd25b05(0x1f2)]({'reason':_0xd25b05(0x293)+this[_0xd25b05(0x260)]+_0xd25b05(0x26c),'createdAt':_0x374c6a[_0xd25b05(0x191)],'expiredAt':new Date()[_0xd25b05(0x24f)](),'daysSinceCreation':Math[_0xd25b05(0x1ca)]((Date[_0xd25b05(0x1e9)]()-_0x374c6a[_0xd25b05(0x191)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0xd25b05(0x1ef)](_0x374c6a,'EXPIRED'),await this[_0xd25b05(0x287)](_0x374c6a,_0xd25b05(0x1ea)),this['clearPaymentTimers'](_0x374c6a['id']),_0x12838b[_0xd25b05(0x1ec)](_0x374c6a['id']),console['log'](_0xd25b05(0x19d)+_0x374c6a['id']+_0xd25b05(0x275)+this[_0xd25b05(0x260)]+'-day\x20timeout');}catch(_0x2c4232){console['error']('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x374c6a['id']+':',_0x2c4232),this[_0xd25b05(0x270)](_0x374c6a['id'],_0x374c6a[_0xd25b05(0x1cb)]||_0xd25b05(0x195),_0x2c4232,_0xd25b05(0x209),{'reason':_0xd25b05(0x253),'createdAt':_0x374c6a[_0xd25b05(0x191)],'daysSinceCreation':Math['floor']((Date[_0xd25b05(0x1e9)]()-_0x374c6a[_0xd25b05(0x191)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x12838b;}async[a38_0x40bb99(0x1e3)](_0x15d98d){const _0x3ba08c=a38_0x40bb99;if(!_0x15d98d['gatewayPaymentId']){console[_0x3ba08c(0x298)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x15d98d['id']+_0x3ba08c(0x1d3));return;}console[_0x3ba08c(0x298)](_0x3ba08c(0x1df)+_0x15d98d[_0x3ba08c(0x241)]+'\x20payment\x20'+_0x15d98d['id']+'\x20('+_0x15d98d['gatewayPaymentId']+')');try{let _0xd3053;_0x15d98d[_0x3ba08c(0x241)]===_0x3ba08c(0x1a0)?(_0xd3053=await this[_0x3ba08c(0x21e)][_0x3ba08c(0x1cc)](_0x15d98d['gatewayPaymentId']),console[_0x3ba08c(0x298)]('📊\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x15d98d['id']+'\x20status:\x20'+_0xd3053[_0x3ba08c(0x20c)])):(_0xd3053=await this[_0x3ba08c(0x1d2)][_0x3ba08c(0x1cc)](_0x15d98d[_0x3ba08c(0x1cb)]),console[_0x3ba08c(0x298)](_0x3ba08c(0x265)+_0x15d98d['id']+_0x3ba08c(0x197)+_0xd3053[_0x3ba08c(0x20c)]));_0xd3053[_0x3ba08c(0x267)]&&console['log'](_0x3ba08c(0x240)+_0x15d98d['id']+_0x3ba08c(0x1d8),{'iban':_0xd3053[_0x3ba08c(0x267)]['iban']||_0x3ba08c(0x213),'transactionId':_0xd3053[_0x3ba08c(0x267)][_0x3ba08c(0x1ac)],'createdOn':_0xd3053['paymentDetails'][_0x3ba08c(0x245)],'confirmedOn':_0xd3053['paymentDetails'][_0x3ba08c(0x1fc)]||_0x3ba08c(0x29a)});if(_0xd3053['status']!==_0x15d98d[_0x3ba08c(0x20c)]){console[_0x3ba08c(0x298)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x15d98d['id']+_0x3ba08c(0x233)+_0x15d98d[_0x3ba08c(0x20c)]+_0x3ba08c(0x238)+_0xd3053[_0x3ba08c(0x20c)]),this['logCoinToPayStatus'](_0x15d98d['id'],_0x15d98d[_0x3ba08c(0x1cb)],_0x15d98d[_0x3ba08c(0x20c)],_0xd3053[_0x3ba08c(0x20c)],_0x3ba08c(0x29b),{'paymentDetails':_0xd3053[_0x3ba08c(0x267)],'amount':_0xd3053[_0x3ba08c(0x1bd)],'currency':_0xd3053[_0x3ba08c(0x1e5)],'shopId':_0x15d98d['shopId'],'checkTimestamp':new Date()['toISOString']()});const _0x2327d4={'status':_0xd3053[_0x3ba08c(0x20c)],'updatedAt':new Date()};if(_0xd3053[_0x3ba08c(0x20c)]===_0x3ba08c(0x1be)&&_0x15d98d[_0x3ba08c(0x20c)]!=='PAID'){_0x2327d4[_0x3ba08c(0x234)]=new Date();if(!_0x15d98d[_0x3ba08c(0x1f8)]){const _0x321a87=await currencyService_1[_0x3ba08c(0x221)][_0x3ba08c(0x1dd)](_0x15d98d[_0x3ba08c(0x1bd)],_0x15d98d[_0x3ba08c(0x1e5)]);_0x2327d4['amountUSDT']=_0x321a87;const _0x4993da=await this[_0x3ba08c(0x23a)](_0x15d98d['shopId'],_0x15d98d[_0x3ba08c(0x241)]),_0x106eb2=_0x321a87*(0x1-_0x4993da/0x64);_0x2327d4[_0x3ba08c(0x229)]=_0x106eb2,console['log'](_0x3ba08c(0x271)+_0x15d98d['id']+'\x20amounts\x20calculated:'),console[_0x3ba08c(0x298)](_0x3ba08c(0x1e6)+_0x15d98d[_0x3ba08c(0x1bd)]+'\x20'+_0x15d98d[_0x3ba08c(0x1e5)]+_0x3ba08c(0x18a)+_0x321a87[_0x3ba08c(0x205)](0x6)+_0x3ba08c(0x242)),console[_0x3ba08c(0x298)]('\x20\x20\x20Gateway\x20'+_0x15d98d[_0x3ba08c(0x241)]+_0x3ba08c(0x1a4)+_0x4993da+'%'),console[_0x3ba08c(0x298)]('\x20\x20\x20Amount\x20after\x20commission:\x20'+_0x106eb2['toFixed'](0x6)+_0x3ba08c(0x242));}console[_0x3ba08c(0x298)](_0x3ba08c(0x271)+_0x15d98d['id']+_0x3ba08c(0x280)+_0x2327d4[_0x3ba08c(0x234)][_0x3ba08c(0x24f)]());}if(_0xd3053[_0x3ba08c(0x267)]){const _0x3ac141=_0xd3053[_0x3ba08c(0x267)];_0x3ac141[_0x3ba08c(0x1de)]&&(_0x2327d4[_0x3ba08c(0x24d)]=_0x3ac141[_0x3ba08c(0x1de)],console['log'](_0x3ba08c(0x188)+_0x3ac141[_0x3ba08c(0x1de)]));if(_0x3ac141[_0x3ba08c(0x225)]){const _0x3c3931=_0x15d98d['adminNotes']||'',_0x371489=_0x3ba08c(0x1a8)+_0x3ac141[_0x3ba08c(0x225)];_0x2327d4[_0x3ba08c(0x266)]=_0x3c3931?_0x3c3931+'\x0a\x0a'+_0x371489:_0x371489,console['log'](_0x3ba08c(0x22e));}_0x3ac141['transactionId']&&console[_0x3ba08c(0x298)]('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x3ac141[_0x3ba08c(0x1ac)]),_0x3ac141[_0x3ba08c(0x1fc)]&&console[_0x3ba08c(0x298)](_0x3ba08c(0x218)+_0x3ac141[_0x3ba08c(0x1fc)]);}await database_1[_0x3ba08c(0x199)]['payment'][_0x3ba08c(0x235)]({'where':{'id':_0x15d98d['id']},'data':_0x2327d4});if(_0xd3053['status']===_0x3ba08c(0x1be)&&_0x15d98d[_0x3ba08c(0x20c)]!==_0x3ba08c(0x1be)){console['log'](_0x3ba08c(0x1c5)+_0x15d98d['id']+_0x3ba08c(0x18e));const _0x121163=await database_1[_0x3ba08c(0x199)][_0x3ba08c(0x26d)][_0x3ba08c(0x20b)]({'where':{'id':_0x15d98d['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x121163?.['paymentLinkId']&&_0x121163[_0x3ba08c(0x256)])try{const _0x74e09e=_0x121163[_0x3ba08c(0x256)];console[_0x3ba08c(0x298)](_0x3ba08c(0x1c4)+_0x74e09e['id']+_0x3ba08c(0x254)+_0x74e09e[_0x3ba08c(0x264)]+_0x3ba08c(0x18c)+_0x74e09e['currentPayments']+_0x3ba08c(0x250)+_0x74e09e[_0x3ba08c(0x20c)]);const _0x3521f4=_0x74e09e[_0x3ba08c(0x228)]+0x1,_0x40b9d8=_0x74e09e[_0x3ba08c(0x264)]===_0x3ba08c(0x261)?_0x3ba08c(0x25b):_0x74e09e[_0x3ba08c(0x20c)];await database_1[_0x3ba08c(0x199)][_0x3ba08c(0x256)][_0x3ba08c(0x235)]({'where':{'id':_0x74e09e['id']},'data':{'currentPayments':_0x3521f4,'status':_0x40b9d8,'updatedAt':new Date()}}),console[_0x3ba08c(0x298)](_0x3ba08c(0x1b8)+_0x74e09e['id']+'\x20updated:\x20currentPayments='+_0x74e09e[_0x3ba08c(0x228)]+_0x3ba08c(0x18a)+_0x3521f4+_0x3ba08c(0x250)+_0x74e09e[_0x3ba08c(0x20c)]+_0x3ba08c(0x18a)+_0x40b9d8);}catch(_0x28ed11){console[_0x3ba08c(0x1cf)](_0x3ba08c(0x1db),_0x28ed11);}else console['log']('📈\x20[COINTOPAY]\x20Payment\x20'+_0x15d98d['id']+_0x3ba08c(0x1bb));}await database_1['default'][_0x3ba08c(0x1fd)][_0x3ba08c(0x292)]({'data':{'paymentId':_0x15d98d['id'],'shopId':_0x15d98d['shopId'],'event':_0x3ba08c(0x286)+_0xd3053[_0x3ba08c(0x20c)][_0x3ba08c(0x23c)](),'statusCode':0xc8,'responseBody':JSON[_0x3ba08c(0x1f2)]({'oldStatus':_0x15d98d[_0x3ba08c(0x20c)],'newStatus':_0xd3053[_0x3ba08c(0x20c)],'paymentDetails':_0xd3053[_0x3ba08c(0x267)],'checkedAt':new Date()[_0x3ba08c(0x24f)]()})}}),await this['sendShopWebhook'](_0x15d98d,_0xd3053[_0x3ba08c(0x20c)]),await this[_0x3ba08c(0x287)](_0x15d98d,_0xd3053[_0x3ba08c(0x20c)]),_0xd3053[_0x3ba08c(0x20c)]!==_0x3ba08c(0x18b)&&(console['log'](_0x3ba08c(0x1a2)+_0x15d98d['id']+'\x20status\x20changed\x20to\x20'+_0xd3053['status']+_0x3ba08c(0x251)),this[_0x3ba08c(0x1e7)](_0x15d98d['id'])),console[_0x3ba08c(0x298)]('✅\x20[CHECK]\x20Payment\x20'+_0x15d98d['id']+_0x3ba08c(0x22d));}else console[_0x3ba08c(0x298)]('📊\x20[CHECK]\x20Payment\x20'+_0x15d98d['id']+'\x20status\x20unchanged\x20('+_0xd3053[_0x3ba08c(0x20c)]+')'),this['logCoinToPayStatus'](_0x15d98d['id'],_0x15d98d[_0x3ba08c(0x1cb)],_0x15d98d[_0x3ba08c(0x20c)],_0xd3053[_0x3ba08c(0x20c)],_0x3ba08c(0x29b),{'statusUnchanged':!![],'paymentDetails':_0xd3053['paymentDetails'],'amount':_0xd3053[_0x3ba08c(0x1bd)],'currency':_0xd3053[_0x3ba08c(0x1e5)],'shopId':_0x15d98d['shopId'],'checkTimestamp':new Date()[_0x3ba08c(0x24f)]()});}catch(_0x682d20){console['error'](_0x3ba08c(0x214)+_0x15d98d['id']+':',_0x682d20),this[_0x3ba08c(0x270)](_0x15d98d['id'],_0x15d98d[_0x3ba08c(0x1cb)],_0x682d20,_0x3ba08c(0x29b),{'paymentAmount':_0x15d98d[_0x3ba08c(0x1bd)],'paymentCurrency':_0x15d98d['currency'],'shopId':_0x15d98d[_0x3ba08c(0x200)],'createdAt':_0x15d98d[_0x3ba08c(0x191)]}),await database_1[_0x3ba08c(0x199)][_0x3ba08c(0x1fd)][_0x3ba08c(0x292)]({'data':{'paymentId':_0x15d98d['id'],'shopId':_0x15d98d['shopId'],'event':_0x3ba08c(0x28b),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x682d20 instanceof Error?_0x682d20[_0x3ba08c(0x249)]:_0x3ba08c(0x299),'gatewayPaymentId':_0x15d98d[_0x3ba08c(0x1cb)],'checkedAt':new Date()[_0x3ba08c(0x24f)]()})}});}}async['sendShopWebhook'](_0x2f1f67,_0x2ecc3e){const _0x4291ef=a38_0x40bb99,_0x8030ab=Date['now']();try{const _0x305ab7=_0x2f1f67[_0x4291ef(0x227)],_0x1bd0fb=_0x305ab7[_0x4291ef(0x263)];if(!_0x1bd0fb?.[_0x4291ef(0x24b)]){console[_0x4291ef(0x298)](_0x4291ef(0x276)+_0x305ab7['id']);return;}const _0x4a4af7=_0x2ecc3e===_0x4291ef(0x1be)?_0x4291ef(0x230):_0x2ecc3e===_0x4291ef(0x20e)?_0x4291ef(0x244):_0x2ecc3e==='EXPIRED'?_0x4291ef(0x244):_0x4291ef(0x1a1);if(!_0x1bd0fb['webhookEvents']?.['includes'](_0x4a4af7)){console[_0x4291ef(0x298)](_0x4291ef(0x219)+_0x4a4af7+_0x4291ef(0x1a3)+_0x305ab7['id']);return;}const _0x299450=(0x0,gateway_1[_0x4291ef(0x1c3)])(_0x2f1f67[_0x4291ef(0x241)])||_0x2f1f67[_0x4291ef(0x241)],_0x368408={'event':_0x4a4af7,'payment':{'id':_0x2f1f67['id'],'order_id':_0x2f1f67[_0x4291ef(0x1cd)],'gateway_order_id':_0x2f1f67[_0x4291ef(0x295)],'gateway':_0x299450,'amount':_0x2f1f67[_0x4291ef(0x1bd)],'currency':_0x2f1f67[_0x4291ef(0x1e5)],'status':_0x2ecc3e[_0x4291ef(0x23c)](),'customer_email':_0x2f1f67[_0x4291ef(0x291)],'customer_name':_0x2f1f67['customerName'],'created_at':_0x2f1f67['createdAt'],'updated_at':new Date()}},_0x5eb771=await fetch(_0x1bd0fb[_0x4291ef(0x24b)],{'method':_0x4291ef(0x196),'headers':{'Content-Type':_0x4291ef(0x1c9),'User-Agent':_0x4291ef(0x289)},'body':JSON[_0x4291ef(0x1f2)](_0x368408)}),_0x5cb465=Date[_0x4291ef(0x1e9)]()-_0x8030ab,_0x4cd3d3=_0x5eb771['ok']?'Success':await _0x5eb771[_0x4291ef(0x24a)]();loggerService_1[_0x4291ef(0x259)][_0x4291ef(0x247)](_0x2f1f67['shopId'],_0x1bd0fb[_0x4291ef(0x24b)],_0x4a4af7,_0x5eb771[_0x4291ef(0x20c)],_0x5cb465,_0x368408),console[_0x4291ef(0x298)](_0x4291ef(0x1d6)+_0x1bd0fb[_0x4291ef(0x24b)]+_0x4291ef(0x212)+_0x5eb771['status']+'\x20('+_0x5cb465+_0x4291ef(0x1e4));}catch(_0x297b81){console[_0x4291ef(0x1cf)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x297b81),loggerService_1['loggerService']['logShopWebhookError'](_0x2f1f67[_0x4291ef(0x200)],_0x2f1f67['shop']?.['settings']?.[_0x4291ef(0x24b)]||_0x4291ef(0x195),_0x4291ef(0x1d1),_0x297b81,{});}}async[a38_0x40bb99(0x287)](_0x17817a,_0x1c985f){const _0x54021d=a38_0x40bb99;try{const _0x467dbb={'PENDING':'created','PAID':_0x54021d(0x21a),'FAILED':_0x54021d(0x187),'EXPIRED':_0x54021d(0x285)},_0x4334eb=_0x467dbb[_0x1c985f];if(!_0x4334eb||_0x4334eb===_0x54021d(0x278))return;await telegramBotService_1[_0x54021d(0x1fe)][_0x54021d(0x268)](_0x17817a[_0x54021d(0x200)],_0x17817a,_0x4334eb);}catch(_0x3289e9){console[_0x54021d(0x1cf)](_0x54021d(0x1da),_0x3289e9);}}async[a38_0x40bb99(0x1c6)](_0x23aec6){const _0x2717c5=a38_0x40bb99;console[_0x2717c5(0x298)](_0x2717c5(0x1c8)+_0x23aec6);const _0x90636e=await database_1[_0x2717c5(0x199)][_0x2717c5(0x26d)][_0x2717c5(0x20b)]({'where':{'id':_0x23aec6},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x90636e)throw new Error('Payment\x20not\x20found');if(_0x90636e['gateway']!==_0x2717c5(0x231)&&_0x90636e['gateway']!=='cointopay2')throw new Error(_0x2717c5(0x23d));console[_0x2717c5(0x298)](_0x2717c5(0x21f)+_0x90636e['gateway']+'\x20payment\x20'+_0x23aec6),await this['checkSinglePayment'](_0x90636e),console[_0x2717c5(0x298)]('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x23aec6);}['getServiceStats'](){const _0x276e08=a38_0x40bb99,_0x369536=this[_0x276e08(0x23f)]?this[_0x276e08(0x224)]:undefined,_0x250358=Array[_0x276e08(0x26e)](this[_0x276e08(0x1b2)]['values']())['map'](_0xb00845=>({'paymentId':_0xb00845[_0x276e08(0x22b)],'gatewayPaymentId':_0xb00845[_0x276e08(0x1cb)],'createdAt':_0xb00845[_0x276e08(0x191)],'timersCount':_0xb00845[_0x276e08(0x1aa)][_0x276e08(0x19c)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x276e08(0x224)]/(0x3e8*0x3c),'expiryDays':this[_0x276e08(0x260)],'activeIndividualTimers':this['paymentTimers'][_0x276e08(0x21b)],'nextGlobalCheckIn':_0x369536,'paymentTimersDetails':_0x250358};}[a38_0x40bb99(0x1d4)](_0x2d0f36){const _0x52ad92=a38_0x40bb99,_0x46592e=this[_0x52ad92(0x1b2)][_0x52ad92(0x1a9)](_0x2d0f36);if(_0x46592e)return{'hasTimers':!![],'timersCount':_0x46592e[_0x52ad92(0x1aa)][_0x52ad92(0x19c)],'createdAt':_0x46592e[_0x52ad92(0x191)],'gatewayPaymentId':_0x46592e[_0x52ad92(0x1cb)]};return{'hasTimers':![]};}async[a38_0x40bb99(0x23a)](_0x55c9cf,_0x19f289){const _0x2fd1eb=a38_0x40bb99;try{const _0x47c92a=await database_1['default'][_0x2fd1eb(0x227)]['findUnique']({'where':{'id':_0x55c9cf},'select':{'gatewaySettings':!![]}});if(!_0x47c92a?.['gatewaySettings'])return console[_0x2fd1eb(0x298)](_0x2fd1eb(0x281)+_0x55c9cf+_0x2fd1eb(0x272)),0xa;const _0x23fea2=JSON['parse'](_0x47c92a['gatewaySettings']);for(const [_0x2363d2,_0x25455b]of Object[_0x2fd1eb(0x18f)](_0x23fea2)){if(_0x2363d2['toLowerCase']()===_0x19f289[_0x2fd1eb(0x23c)]()){const _0xcdc53c=_0x25455b[_0x2fd1eb(0x258)]||0xa;return console[_0x2fd1eb(0x298)](_0x2fd1eb(0x203)+_0x19f289+_0x2fd1eb(0x255)+_0x55c9cf+':\x20'+_0xcdc53c+'%'),_0xcdc53c;}}return console[_0x2fd1eb(0x298)](_0x2fd1eb(0x1d5)+_0x19f289+'\x20in\x20shop\x20'+_0x55c9cf+_0x2fd1eb(0x27a)),0xa;}catch(_0x2a6798){return console[_0x2fd1eb(0x1cf)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x55c9cf+_0x2fd1eb(0x26a)+_0x19f289+':',_0x2a6798),0xa;}}}exports[a38_0x40bb99(0x216)]=CoinToPayStatusService,exports[a38_0x40bb99(0x190)]=new CoinToPayStatusService();