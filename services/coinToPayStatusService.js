'use strict';const a37_0x173c7d=a37_0x3241;(function(_0x556a29,_0x3dc7a5){const _0x526836=a37_0x3241,_0x2fd454=_0x556a29();while(!![]){try{const _0x5d90ce=-parseInt(_0x526836(0x1ed))/0x1+-parseInt(_0x526836(0x26f))/0x2+-parseInt(_0x526836(0x1de))/0x3*(parseInt(_0x526836(0x22e))/0x4)+-parseInt(_0x526836(0x20b))/0x5+parseInt(_0x526836(0x25a))/0x6+-parseInt(_0x526836(0x256))/0x7+parseInt(_0x526836(0x205))/0x8;if(_0x5d90ce===_0x3dc7a5)break;else _0x2fd454['push'](_0x2fd454['shift']());}catch(_0x4facbd){_0x2fd454['push'](_0x2fd454['shift']());}}}(a37_0x4816,0xd95ae));var __importDefault=this&&this[a37_0x173c7d(0x213)]||function(_0x5b7ad5){const _0x5345dc=a37_0x173c7d;return _0x5b7ad5&&_0x5b7ad5[_0x5345dc(0x285)]?_0x5b7ad5:{'default':_0x5b7ad5};};Object[a37_0x173c7d(0x279)](exports,a37_0x173c7d(0x285),{'value':!![]}),exports[a37_0x173c7d(0x1c5)]=exports['CoinToPayStatusService']=void 0x0;function a37_0x3241(_0x458252,_0x5713cd){const _0x4816ff=a37_0x4816();return a37_0x3241=function(_0x3241a4,_0xeb04f8){_0x3241a4=_0x3241a4-0x1b0;let _0x28c7f0=_0x4816ff[_0x3241a4];return _0x28c7f0;},a37_0x3241(_0x458252,_0x5713cd);}const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a37_0x173c7d(0x250))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x39a6d4=a37_0x173c7d;this[_0x39a6d4(0x214)]=null,this[_0x39a6d4(0x241)]=0x3c*0x3c*0x3e8,this[_0x39a6d4(0x26b)]=0x5,this[_0x39a6d4(0x245)]=new Map(),this[_0x39a6d4(0x22f)]=new coinToPayService_1[(_0x39a6d4(0x1eb))](),console[_0x39a6d4(0x262)](_0x39a6d4(0x22c));}['schedulePaymentChecks'](_0x3e9b88,_0x28c0a7){const _0x4806e8=a37_0x173c7d;console[_0x4806e8(0x262)](_0x4806e8(0x277)),console[_0x4806e8(0x262)](_0x4806e8(0x1dd)+_0x3e9b88),console[_0x4806e8(0x262)](_0x4806e8(0x1b1)+_0x28c0a7),this[_0x4806e8(0x1c6)](_0x3e9b88);const _0x491a66=[],_0x5d4dbf=new Date(),_0x4793b8=[{'delay':0x1*0x3c*0x3e8,'description':_0x4806e8(0x264)},{'delay':0x2*0x3c*0x3e8,'description':_0x4806e8(0x28c)},{'delay':0x5*0x3c*0x3e8,'description':_0x4806e8(0x1e2)},{'delay':0x5*0x3c*0x3e8,'description':_0x4806e8(0x1e2)}];console[_0x4806e8(0x262)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x4793b8[_0x4806e8(0x238)]+_0x4806e8(0x1bd)+_0x3e9b88);let _0x36ee7b=0x0;_0x4793b8[_0x4806e8(0x1ca)]((_0x3d7e28,_0x788c3c)=>{const _0x5be52f=_0x4806e8;_0x36ee7b+=_0x3d7e28[_0x5be52f(0x1e3)];const _0xdbf0be=setTimeout(async()=>{const _0x519cba=_0x5be52f;console['log']('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x788c3c+0x1)+_0x519cba(0x275)+_0x3e9b88+_0x519cba(0x293)+_0x3d7e28['description']+')');try{await this['checkSinglePaymentById'](_0x3e9b88),console[_0x519cba(0x262)](_0x519cba(0x1bc)+(_0x788c3c+0x1)+_0x519cba(0x28a)+_0x3e9b88);}catch(_0x2bd115){console[_0x519cba(0x290)]('❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x788c3c+0x1)+_0x519cba(0x251)+_0x3e9b88+':',_0x2bd115),this[_0x519cba(0x209)](_0x3e9b88,_0x28c0a7,_0x2bd115,'status_check',{'checkNumber':_0x788c3c+0x1,'scheduledAfter':_0x3d7e28[_0x519cba(0x220)],'isIndividualCheck':!![]});}},_0x36ee7b);_0x491a66[_0x5be52f(0x25e)](_0xdbf0be),console[_0x5be52f(0x262)](_0x5be52f(0x263)+(_0x788c3c+0x1)+_0x5be52f(0x251)+_0x3e9b88+_0x5be52f(0x252)+_0x36ee7b/0x3e8+_0x5be52f(0x21c)+_0x3d7e28['description']+')');});const _0x4bc1ac=setInterval(async()=>{const _0x501473=_0x4806e8;console[_0x501473(0x262)](_0x501473(0x1e8)+_0x3e9b88);try{const _0x402573=await database_1[_0x501473(0x248)][_0x501473(0x235)][_0x501473(0x259)]({'where':{'id':_0x3e9b88},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x402573){console['log'](_0x501473(0x216)+_0x3e9b88+_0x501473(0x230)),this[_0x501473(0x1c6)](_0x3e9b88);return;}console['log'](_0x501473(0x237)+_0x3e9b88+_0x501473(0x1cf)+_0x402573[_0x501473(0x236)]);if(_0x402573['status']!==_0x501473(0x26e)){console[_0x501473(0x262)](_0x501473(0x20e)+_0x3e9b88+'\x20status\x20is\x20'+_0x402573['status']+_0x501473(0x26d)),this[_0x501473(0x1c6)](_0x3e9b88);return;}const _0x7b04ce=Math[_0x501473(0x1f2)]((Date[_0x501473(0x1be)]()-_0x402573[_0x501473(0x1e9)][_0x501473(0x267)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x7b04ce>=this[_0x501473(0x26b)]){console[_0x501473(0x262)](_0x501473(0x240)+_0x3e9b88+_0x501473(0x219)+this[_0x501473(0x26b)]+_0x501473(0x1f0)),this['clearPaymentTimers'](_0x3e9b88);return;}await this['checkSinglePaymentById'](_0x3e9b88),console[_0x501473(0x262)](_0x501473(0x1b4)+_0x3e9b88);}catch(_0x419bd9){console['error'](_0x501473(0x292)+_0x3e9b88+':',_0x419bd9),this['logCoinToPayError'](_0x3e9b88,_0x28c0a7,_0x419bd9,_0x501473(0x206),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x491a66[_0x4806e8(0x25e)](_0x4bc1ac),this[_0x4806e8(0x245)][_0x4806e8(0x1c3)](_0x3e9b88,{'timers':_0x491a66,'paymentId':_0x3e9b88,'gatewayPaymentId':_0x28c0a7,'createdAt':_0x5d4dbf}),console[_0x4806e8(0x262)](_0x4806e8(0x278)+_0x4793b8[_0x4806e8(0x238)]+_0x4806e8(0x286)+_0x3e9b88),console['log'](_0x4806e8(0x1c4)+this[_0x4806e8(0x245)]['size']),this[_0x4806e8(0x268)](_0x3e9b88,_0x28c0a7,_0x4806e8(0x26e),'PENDING',_0x4806e8(0x206),{'action':'schedule_created','scheduledChecks':_0x4793b8[_0x4806e8(0x238)],'firstCheckIn':_0x4793b8[0x0][_0x4806e8(0x1e3)]/0x3e8,'totalTimers':this[_0x4806e8(0x245)][_0x4806e8(0x210)]});}[a37_0x173c7d(0x1c6)](_0x115ba0){const _0x4d326a=a37_0x173c7d,_0x4b7d08=this['paymentTimers'][_0x4d326a(0x1db)](_0x115ba0);_0x4b7d08?(console[_0x4d326a(0x262)](_0x4d326a(0x254)+_0x4b7d08[_0x4d326a(0x222)][_0x4d326a(0x238)]+_0x4d326a(0x1fb)+_0x115ba0),_0x4b7d08[_0x4d326a(0x222)]['forEach']((_0x10b5d4,_0xc018f3)=>{const _0x40d15e=_0x4d326a;_0x10b5d4&&(clearTimeout(_0x10b5d4),clearInterval(_0x10b5d4),console[_0x40d15e(0x262)](_0x40d15e(0x21a)+(_0xc018f3+0x1)+_0x40d15e(0x251)+_0x115ba0));}),this[_0x4d326a(0x245)][_0x4d326a(0x249)](_0x115ba0),console[_0x4d326a(0x262)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x115ba0+_0x4d326a(0x1e0)+this[_0x4d326a(0x245)][_0x4d326a(0x210)])):console[_0x4d326a(0x262)](_0x4d326a(0x1ee)+_0x115ba0+_0x4d326a(0x1da));}async[a37_0x173c7d(0x22d)](_0x1000c2){const _0x472ce8=a37_0x173c7d;console[_0x472ce8(0x262)](_0x472ce8(0x1df)+_0x1000c2);const _0x2c2465=await database_1[_0x472ce8(0x248)]['payment'][_0x472ce8(0x259)]({'where':{'id':_0x1000c2},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2c2465){console['log'](_0x472ce8(0x1d8)+_0x1000c2+_0x472ce8(0x260));return;}console['log'](_0x472ce8(0x1f5)+_0x1000c2+'\x20found:'),console[_0x472ce8(0x262)](_0x472ce8(0x1d9)+_0x2c2465[_0x472ce8(0x271)]),console['log'](_0x472ce8(0x1c2)+_0x2c2465[_0x472ce8(0x236)]),console['log'](_0x472ce8(0x276)+_0x2c2465[_0x472ce8(0x1cd)]),console[_0x472ce8(0x262)](_0x472ce8(0x270)+_0x2c2465[_0x472ce8(0x272)]+'\x20'+_0x2c2465[_0x472ce8(0x258)]),console[_0x472ce8(0x262)](_0x472ce8(0x23f)+_0x2c2465[_0x472ce8(0x212)]);if(_0x2c2465[_0x472ce8(0x271)]!==_0x472ce8(0x1fc)){console[_0x472ce8(0x262)](_0x472ce8(0x208)+_0x1000c2+_0x472ce8(0x24c)+_0x2c2465['gateway']+')');return;}if(_0x2c2465[_0x472ce8(0x236)]!=='PENDING'){console[_0x472ce8(0x262)](_0x472ce8(0x208)+_0x1000c2+_0x472ce8(0x24b)+_0x2c2465[_0x472ce8(0x236)]+',\x20stopping\x20individual\x20checks'),this[_0x472ce8(0x1c6)](_0x1000c2);return;}if(!_0x2c2465[_0x472ce8(0x1cd)]){console[_0x472ce8(0x262)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x1000c2+_0x472ce8(0x28b));return;}console['log'](_0x472ce8(0x229)+_0x1000c2+_0x472ce8(0x27b)),await this[_0x472ce8(0x1d3)](_0x2c2465);}[a37_0x173c7d(0x268)](_0x4ac347,_0x217d34,_0x6078be,_0x33d153,_0x1dd9e4,_0x9e3ac7){const _0x4538c7=a37_0x173c7d,_0xb754c4={'type':_0x4538c7(0x1b6),'paymentId':_0x4ac347,'gatewayPaymentId':_0x217d34,'oldStatus':_0x6078be,'newStatus':_0x33d153,'source':_0x1dd9e4,'timestamp':new Date()[_0x4538c7(0x253)](),'details':_0x9e3ac7||{}};loggerService_1[_0x4538c7(0x1c8)][_0x4538c7(0x268)](_0xb754c4),console[_0x4538c7(0x262)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x4ac347+'\x20('+_0x217d34+')'),console[_0x4538c7(0x262)](_0x4538c7(0x1d6)+_0x6078be+_0x4538c7(0x26a)+_0x33d153),console[_0x4538c7(0x262)](_0x4538c7(0x215)+_0x1dd9e4),console[_0x4538c7(0x262)]('\x20\x20\x20📅\x20Time:\x20'+_0xb754c4['timestamp']),_0x9e3ac7&&console['log'](_0x4538c7(0x1cc),_0x9e3ac7);}[a37_0x173c7d(0x209)](_0xa6fdcd,_0x101935,_0x508ac9,_0x391d09,_0x39a65f){const _0x373e16=a37_0x173c7d,_0x2f8cb2={'type':'COINTOPAY_ERROR','paymentId':_0xa6fdcd,'gatewayPaymentId':_0x101935,'error':_0x508ac9 instanceof Error?{'message':_0x508ac9['message'],'stack':_0x508ac9[_0x373e16(0x1c7)]}:_0x508ac9,'source':_0x391d09,'timestamp':new Date()['toISOString'](),'context':_0x39a65f||{}};loggerService_1[_0x373e16(0x1c8)]['logCoinToPayError'](_0x2f8cb2),console[_0x373e16(0x290)](_0x373e16(0x211)+_0xa6fdcd+'\x20('+_0x101935+')'),console[_0x373e16(0x290)]('\x20\x20\x20❌\x20Error:\x20'+(_0x508ac9 instanceof Error?_0x508ac9['message']:_0x508ac9)),console[_0x373e16(0x290)](_0x373e16(0x215)+_0x391d09),console[_0x373e16(0x290)]('\x20\x20\x20📅\x20Time:\x20'+_0x2f8cb2[_0x373e16(0x25d)]),_0x39a65f&&console[_0x373e16(0x290)](_0x373e16(0x225),_0x39a65f);}['startPeriodicStatusCheck'](){const _0x2cd5a4=a37_0x173c7d;console[_0x2cd5a4(0x262)]('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x2cd5a4(0x1dc)]()['catch'](_0x111904=>{const _0x19b78a=_0x2cd5a4;console[_0x19b78a(0x290)](_0x19b78a(0x261),_0x111904);}),this[_0x2cd5a4(0x214)]=setInterval(async()=>{const _0x592902=_0x2cd5a4;try{console[_0x592902(0x262)]('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this['checkAllPendingPayments'](),console[_0x592902(0x262)]('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x33c61f){console['error'](_0x592902(0x228),_0x33c61f);}},this[_0x2cd5a4(0x241)]),console[_0x2cd5a4(0x262)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x173c7d(0x24f)](){const _0x5547f2=a37_0x173c7d;console['log']('🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x5547f2(0x214)]&&(clearInterval(this['globalCheckInterval']),this[_0x5547f2(0x214)]=null,console[_0x5547f2(0x262)](_0x5547f2(0x27d)));const _0x2bc507=this[_0x5547f2(0x245)][_0x5547f2(0x210)];for(const [_0x30743c]of this[_0x5547f2(0x245)]){this[_0x5547f2(0x1c6)](_0x30743c);}console[_0x5547f2(0x262)](_0x5547f2(0x25f)+_0x2bc507+_0x5547f2(0x1d5));}async[a37_0x173c7d(0x1dc)](){const _0x512812=a37_0x173c7d;try{console[_0x512812(0x262)](_0x512812(0x204));const _0x2e9411=await database_1[_0x512812(0x248)][_0x512812(0x235)][_0x512812(0x28d)]({'where':{'gateway':_0x512812(0x1fc),'status':_0x512812(0x26e),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x512812(0x262)](_0x512812(0x203)+_0x2e9411[_0x512812(0x238)]+_0x512812(0x1d2));if(_0x2e9411[_0x512812(0x238)]===0x0){console[_0x512812(0x262)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x77114d=await this[_0x512812(0x1b3)](_0x2e9411);console['log'](_0x512812(0x1b7)+_0x77114d[_0x512812(0x238)]+_0x512812(0x1bf));let _0x5cb47d=0x0,_0x153006=0x0;for(const _0x474d18 of _0x2e9411){try{if(_0x77114d[_0x512812(0x200)](_0x474d18['id'])){console[_0x512812(0x262)](_0x512812(0x239)+_0x474d18['id']+_0x512812(0x27e)),_0x153006++;continue;}if(this['paymentTimers'][_0x512812(0x23c)](_0x474d18['id'])){console[_0x512812(0x262)](_0x512812(0x239)+_0x474d18['id']+_0x512812(0x21e)),_0x153006++;continue;}const _0x21217c=(Date[_0x512812(0x1be)]()-_0x474d18[_0x512812(0x1e9)][_0x512812(0x267)]())/(0x3e8*0x3c*0x3c);if(_0x21217c<0x1){console[_0x512812(0x262)](_0x512812(0x239)+_0x474d18['id']+_0x512812(0x1b8)+_0x21217c[_0x512812(0x21d)](0x1)+'h),\x20skipping\x20global\x20check'),_0x153006++;continue;}console[_0x512812(0x262)]('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x474d18['id']+_0x512812(0x20f)+_0x21217c[_0x512812(0x21d)](0x1)+'h)'),await this[_0x512812(0x1d3)](_0x474d18),_0x5cb47d++,await new Promise(_0x1d6ae7=>setTimeout(_0x1d6ae7,0x7d0));}catch(_0x27fa9f){console[_0x512812(0x290)](_0x512812(0x22a)+_0x474d18['id']+':',_0x27fa9f),this[_0x512812(0x209)](_0x474d18['id'],_0x474d18[_0x512812(0x1cd)]||_0x512812(0x27c),_0x27fa9f,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x474d18[_0x512812(0x272)],'paymentCurrency':_0x474d18['currency'],'shopId':_0x474d18['shopId'],'createdAt':_0x474d18[_0x512812(0x1e9)]}),loggerService_1['loggerService'][_0x512812(0x233)](_0x512812(0x1fc),_0x512812(0x201)+_0x474d18[_0x512812(0x1cd)],_0x27fa9f);}}console['log'](_0x512812(0x21b)+_0x5cb47d+_0x512812(0x202)+_0x153006+_0x512812(0x231)+_0x77114d['length']+_0x512812(0x291));}catch(_0x14a404){console[_0x512812(0x290)](_0x512812(0x1fe),_0x14a404);}}async[a37_0x173c7d(0x1b3)](_0x4f123e){const _0x57d63a=a37_0x173c7d,_0x4c22f0=[],_0x71449=new Date();_0x71449[_0x57d63a(0x1e7)](_0x71449[_0x57d63a(0x232)]()-this[_0x57d63a(0x26b)]),console['log'](_0x57d63a(0x1c0)+this[_0x57d63a(0x26b)]+_0x57d63a(0x287)+_0x71449[_0x57d63a(0x253)]()+')');for(const _0x319335 of _0x4f123e){if(_0x319335[_0x57d63a(0x1e9)]<_0x71449){console[_0x57d63a(0x262)](_0x57d63a(0x221)+_0x319335['id']+_0x57d63a(0x219)+this[_0x57d63a(0x26b)]+_0x57d63a(0x1b5));try{this[_0x57d63a(0x268)](_0x319335['id'],_0x319335['gatewayPaymentId']||'unknown',_0x57d63a(0x26e),_0x57d63a(0x274),_0x57d63a(0x28e),{'reason':_0x57d63a(0x224)+this[_0x57d63a(0x26b)]+_0x57d63a(0x1ff),'createdAt':_0x319335[_0x57d63a(0x1e9)],'daysSinceCreation':Math[_0x57d63a(0x1f2)]((Date['now']()-_0x319335['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x319335[_0x57d63a(0x272)],'paymentCurrency':_0x319335[_0x57d63a(0x258)],'shopId':_0x319335[_0x57d63a(0x212)]}),await database_1[_0x57d63a(0x248)][_0x57d63a(0x235)][_0x57d63a(0x22b)]({'where':{'id':_0x319335['id']},'data':{'status':_0x57d63a(0x274),'updatedAt':new Date(),'adminNotes':_0x57d63a(0x1e4)+this[_0x57d63a(0x26b)]+_0x57d63a(0x1b0)}}),await database_1[_0x57d63a(0x248)]['webhookLog']['create']({'data':{'paymentId':_0x319335['id'],'shopId':_0x319335[_0x57d63a(0x212)],'event':_0x57d63a(0x282),'statusCode':0xc8,'responseBody':JSON[_0x57d63a(0x24a)]({'reason':_0x57d63a(0x224)+this[_0x57d63a(0x26b)]+_0x57d63a(0x1ff),'createdAt':_0x319335[_0x57d63a(0x1e9)],'expiredAt':new Date()[_0x57d63a(0x253)](),'daysSinceCreation':Math[_0x57d63a(0x1f2)]((Date[_0x57d63a(0x1be)]()-_0x319335[_0x57d63a(0x1e9)][_0x57d63a(0x267)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x57d63a(0x1f1)](_0x319335,_0x57d63a(0x274)),await this[_0x57d63a(0x1b2)](_0x319335,'EXPIRED'),this[_0x57d63a(0x1c6)](_0x319335['id']),_0x4c22f0[_0x57d63a(0x25e)](_0x319335['id']),console['log']('✅\x20[EXPIRY]\x20Payment\x20'+_0x319335['id']+_0x57d63a(0x1fd)+this[_0x57d63a(0x26b)]+_0x57d63a(0x234));}catch(_0x2eeaa8){console[_0x57d63a(0x290)](_0x57d63a(0x1c9)+_0x319335['id']+':',_0x2eeaa8),this['logCoinToPayError'](_0x319335['id'],_0x319335[_0x57d63a(0x1cd)]||_0x57d63a(0x27c),_0x2eeaa8,_0x57d63a(0x28e),{'reason':_0x57d63a(0x1e5),'createdAt':_0x319335[_0x57d63a(0x1e9)],'daysSinceCreation':Math[_0x57d63a(0x1f2)]((Date['now']()-_0x319335[_0x57d63a(0x1e9)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x4c22f0;}async[a37_0x173c7d(0x1d3)](_0x3726da){const _0x25ceec=a37_0x173c7d;if(!_0x3726da['gatewayPaymentId']){console[_0x25ceec(0x262)](_0x25ceec(0x208)+_0x3726da['id']+_0x25ceec(0x269));return;}console[_0x25ceec(0x262)]('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x3726da['id']+'\x20('+_0x3726da[_0x25ceec(0x1cd)]+')');try{const _0x724ec3=await this['coinToPayService'][_0x25ceec(0x223)](_0x3726da[_0x25ceec(0x1cd)]);console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x3726da['id']+'\x20status:\x20'+_0x724ec3[_0x25ceec(0x236)]);_0x724ec3[_0x25ceec(0x273)]&&console[_0x25ceec(0x262)]('📊\x20[CHECK]\x20Payment\x20'+_0x3726da['id']+_0x25ceec(0x27f),{'iban':_0x724ec3[_0x25ceec(0x273)][_0x25ceec(0x23b)]||_0x25ceec(0x1d1),'transactionId':_0x724ec3[_0x25ceec(0x273)][_0x25ceec(0x1e1)],'createdOn':_0x724ec3[_0x25ceec(0x273)][_0x25ceec(0x23e)],'confirmedOn':_0x724ec3[_0x25ceec(0x273)][_0x25ceec(0x28f)]||_0x25ceec(0x20d)});if(_0x724ec3[_0x25ceec(0x236)]!==_0x3726da[_0x25ceec(0x236)]){console[_0x25ceec(0x262)](_0x25ceec(0x25b)+_0x3726da['id']+_0x25ceec(0x20a)+_0x3726da['status']+_0x25ceec(0x1f6)+_0x724ec3[_0x25ceec(0x236)]),this[_0x25ceec(0x268)](_0x3726da['id'],_0x3726da[_0x25ceec(0x1cd)],_0x3726da['status'],_0x724ec3[_0x25ceec(0x236)],'status_check',{'paymentDetails':_0x724ec3[_0x25ceec(0x273)],'amount':_0x724ec3['amount'],'currency':_0x724ec3['currency'],'shopId':_0x3726da[_0x25ceec(0x212)],'checkTimestamp':new Date()[_0x25ceec(0x253)]()});const _0x4e1e15={'status':_0x724ec3[_0x25ceec(0x236)],'updatedAt':new Date()};_0x724ec3['status']==='PAID'&&_0x3726da[_0x25ceec(0x236)]!==_0x25ceec(0x1d7)&&(_0x4e1e15[_0x25ceec(0x1ea)]=new Date(),console[_0x25ceec(0x262)](_0x25ceec(0x1f9)+_0x3726da['id']+_0x25ceec(0x207)+_0x4e1e15[_0x25ceec(0x1ea)][_0x25ceec(0x253)]()));if(_0x724ec3[_0x25ceec(0x273)]){const _0x256f1e=_0x724ec3[_0x25ceec(0x273)];_0x256f1e[_0x25ceec(0x23b)]&&(_0x4e1e15['remitterIban']=_0x256f1e['iban'],console[_0x25ceec(0x262)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x256f1e[_0x25ceec(0x23b)]));if(_0x256f1e[_0x25ceec(0x1ce)]){const _0x26839b=_0x3726da[_0x25ceec(0x1f3)]||'',_0x34990e=_0x25ceec(0x24d)+_0x256f1e[_0x25ceec(0x1ce)];_0x4e1e15[_0x25ceec(0x1f3)]=_0x26839b?_0x26839b+'\x0a\x0a'+_0x34990e:_0x34990e,console[_0x25ceec(0x262)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x256f1e[_0x25ceec(0x1e1)]&&console['log'](_0x25ceec(0x280)+_0x256f1e[_0x25ceec(0x1e1)]),_0x256f1e[_0x25ceec(0x28f)]&&console[_0x25ceec(0x262)]('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x256f1e[_0x25ceec(0x28f)]);}await database_1[_0x25ceec(0x248)][_0x25ceec(0x235)][_0x25ceec(0x22b)]({'where':{'id':_0x3726da['id']},'data':_0x4e1e15}),await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0x3726da['id'],'shopId':_0x3726da[_0x25ceec(0x212)],'event':_0x25ceec(0x226)+_0x724ec3[_0x25ceec(0x236)][_0x25ceec(0x20c)](),'statusCode':0xc8,'responseBody':JSON[_0x25ceec(0x24a)]({'oldStatus':_0x3726da[_0x25ceec(0x236)],'newStatus':_0x724ec3[_0x25ceec(0x236)],'paymentDetails':_0x724ec3['paymentDetails'],'checkedAt':new Date()[_0x25ceec(0x253)]()})}}),await this['sendShopWebhook'](_0x3726da,_0x724ec3['status']),await this[_0x25ceec(0x1b2)](_0x3726da,_0x724ec3[_0x25ceec(0x236)]),_0x724ec3[_0x25ceec(0x236)]!==_0x25ceec(0x26e)&&(console[_0x25ceec(0x262)](_0x25ceec(0x242)+_0x3726da['id']+'\x20status\x20changed\x20to\x20'+_0x724ec3[_0x25ceec(0x236)]+_0x25ceec(0x1ba)),this[_0x25ceec(0x1c6)](_0x3726da['id'])),console[_0x25ceec(0x262)](_0x25ceec(0x229)+_0x3726da['id']+'\x20updated\x20successfully');}else console[_0x25ceec(0x262)]('📊\x20[CHECK]\x20Payment\x20'+_0x3726da['id']+'\x20status\x20unchanged\x20('+_0x724ec3[_0x25ceec(0x236)]+')'),this[_0x25ceec(0x268)](_0x3726da['id'],_0x3726da[_0x25ceec(0x1cd)],_0x3726da['status'],_0x724ec3[_0x25ceec(0x236)],_0x25ceec(0x206),{'statusUnchanged':!![],'paymentDetails':_0x724ec3[_0x25ceec(0x273)],'amount':_0x724ec3[_0x25ceec(0x272)],'currency':_0x724ec3[_0x25ceec(0x258)],'shopId':_0x3726da[_0x25ceec(0x212)],'checkTimestamp':new Date()[_0x25ceec(0x253)]()});}catch(_0x2e724d){console[_0x25ceec(0x290)](_0x25ceec(0x244)+_0x3726da['id']+':',_0x2e724d),this[_0x25ceec(0x209)](_0x3726da['id'],_0x3726da[_0x25ceec(0x1cd)],_0x2e724d,_0x25ceec(0x206),{'paymentAmount':_0x3726da['amount'],'paymentCurrency':_0x3726da[_0x25ceec(0x258)],'shopId':_0x3726da[_0x25ceec(0x212)],'createdAt':_0x3726da[_0x25ceec(0x1e9)]}),await database_1[_0x25ceec(0x248)][_0x25ceec(0x23d)][_0x25ceec(0x1d0)]({'data':{'paymentId':_0x3726da['id'],'shopId':_0x3726da[_0x25ceec(0x212)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x25ceec(0x24a)]({'error':_0x2e724d instanceof Error?_0x2e724d[_0x25ceec(0x227)]:_0x25ceec(0x1cb),'gatewayPaymentId':_0x3726da[_0x25ceec(0x1cd)],'checkedAt':new Date()[_0x25ceec(0x253)]()})}});}}async[a37_0x173c7d(0x1f1)](_0xfcb684,_0x3a89ed){const _0x1cbadf=a37_0x173c7d,_0x8c6b4d=Date[_0x1cbadf(0x1be)]();try{const _0x1383e2=_0xfcb684[_0x1cbadf(0x218)],_0x5b3f44=_0x1383e2[_0x1cbadf(0x265)];if(!_0x5b3f44?.[_0x1cbadf(0x27a)]){console[_0x1cbadf(0x262)](_0x1cbadf(0x1f7)+_0x1383e2['id']);return;}const _0x110207=_0x3a89ed===_0x1cbadf(0x1d7)?'payment.success':_0x3a89ed==='FAILED'?_0x1cbadf(0x281):_0x3a89ed===_0x1cbadf(0x274)?'payment.failed':'payment.pending';if(!_0x5b3f44[_0x1cbadf(0x1b9)]?.[_0x1cbadf(0x200)](_0x110207)){console[_0x1cbadf(0x262)](_0x1cbadf(0x289)+_0x110207+_0x1cbadf(0x1bb)+_0x1383e2['id']);return;}const _0xee7207={'event':_0x110207,'payment':{'id':_0xfcb684['id'],'order_id':_0xfcb684[_0x1cbadf(0x288)],'gateway_order_id':_0xfcb684['gatewayOrderId'],'gateway':_0x1cbadf(0x24e),'amount':_0xfcb684[_0x1cbadf(0x272)],'currency':_0xfcb684[_0x1cbadf(0x258)],'status':_0x3a89ed[_0x1cbadf(0x20c)](),'customer_email':_0xfcb684[_0x1cbadf(0x1d4)],'customer_name':_0xfcb684['customerName'],'created_at':_0xfcb684[_0x1cbadf(0x1e9)],'updated_at':new Date()}},_0x1761ad=await fetch(_0x5b3f44[_0x1cbadf(0x27a)],{'method':_0x1cbadf(0x23a),'headers':{'Content-Type':_0x1cbadf(0x283),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x1cbadf(0x24a)](_0xee7207)}),_0x4a1892=Date['now']()-_0x8c6b4d,_0x389d01=_0x1761ad['ok']?_0x1cbadf(0x246):await _0x1761ad['text']();loggerService_1[_0x1cbadf(0x1c8)][_0x1cbadf(0x1f8)](_0xfcb684['shopId'],_0x5b3f44[_0x1cbadf(0x27a)],_0x110207,_0x1761ad[_0x1cbadf(0x236)],_0x4a1892,_0xee7207),console[_0x1cbadf(0x262)]('Shop\x20webhook\x20sent\x20to\x20'+_0x5b3f44[_0x1cbadf(0x27a)]+_0x1cbadf(0x1fa)+_0x1761ad[_0x1cbadf(0x236)]+'\x20('+_0x4a1892+'ms)');}catch(_0x5826fe){console['error'](_0x1cbadf(0x1c1),_0x5826fe),loggerService_1[_0x1cbadf(0x1c8)]['logShopWebhookError'](_0xfcb684[_0x1cbadf(0x212)],_0xfcb684[_0x1cbadf(0x218)]?.['settings']?.['webhookUrl']||_0x1cbadf(0x27c),_0x1cbadf(0x257),_0x5826fe,{});}}async['sendPaymentStatusNotification'](_0xb8c1d2,_0x551060){const _0x25105e=a37_0x173c7d;try{const _0x24bf6e={'PENDING':'created','PAID':_0x25105e(0x243),'FAILED':_0x25105e(0x284),'EXPIRED':'expired'},_0xd14dc7=_0x24bf6e[_0x551060];if(!_0xd14dc7||_0xd14dc7==='created')return;await telegramBotService_1[_0x25105e(0x26c)]['sendPaymentNotification'](_0xb8c1d2[_0x25105e(0x212)],_0xb8c1d2,_0xd14dc7);}catch(_0xedd726){console[_0x25105e(0x290)](_0x25105e(0x1e6),_0xedd726);}}async[a37_0x173c7d(0x25c)](_0x476015){const _0x4cbeaf=a37_0x173c7d;console[_0x4cbeaf(0x262)](_0x4cbeaf(0x217)+_0x476015);const _0x5c979d=await database_1[_0x4cbeaf(0x248)][_0x4cbeaf(0x235)][_0x4cbeaf(0x259)]({'where':{'id':_0x476015},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5c979d)throw new Error(_0x4cbeaf(0x1f4));if(_0x5c979d[_0x4cbeaf(0x271)]!=='cointopay')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x4cbeaf(0x262)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x476015),await this[_0x4cbeaf(0x1d3)](_0x5c979d),console[_0x4cbeaf(0x262)](_0x4cbeaf(0x266)+_0x476015);}[a37_0x173c7d(0x1ec)](){const _0x14150c=a37_0x173c7d,_0x29bd80=this[_0x14150c(0x214)]?this[_0x14150c(0x241)]:undefined,_0x137835=Array[_0x14150c(0x255)](this[_0x14150c(0x245)]['values']())['map'](_0x44431f=>({'paymentId':_0x44431f[_0x14150c(0x247)],'gatewayPaymentId':_0x44431f['gatewayPaymentId'],'createdAt':_0x44431f[_0x14150c(0x1e9)],'timersCount':_0x44431f[_0x14150c(0x222)][_0x14150c(0x238)]}));return{'isActive':!!this[_0x14150c(0x214)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x14150c(0x26b)],'activeIndividualTimers':this[_0x14150c(0x245)][_0x14150c(0x210)],'nextGlobalCheckIn':_0x29bd80,'paymentTimersDetails':_0x137835};}[a37_0x173c7d(0x1ef)](_0x2d1adc){const _0x2c23ee=a37_0x173c7d,_0x361b6b=this[_0x2c23ee(0x245)][_0x2c23ee(0x1db)](_0x2d1adc);if(_0x361b6b)return{'hasTimers':!![],'timersCount':_0x361b6b[_0x2c23ee(0x222)][_0x2c23ee(0x238)],'createdAt':_0x361b6b[_0x2c23ee(0x1e9)],'gatewayPaymentId':_0x361b6b['gatewayPaymentId']};return{'hasTimers':![]};}}function a37_0x4816(){const _0x23fbac=['❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','update','🪙\x20CoinToPayStatusService\x20initialized','checkSinglePaymentById','5532BpWtBP','coinToPayService','\x20not\x20found,\x20clearing\x20timers','\x20skipped,\x20','getDate','logWhiteDomainError','-day\x20timeout','payment','status','📊\x20[HOURLY]\x20Payment\x20','length','⏰\x20[GLOBAL]\x20Payment\x20','POST','iban','has','webhookLog','createdOn','\x20\x20\x20-\x20ShopId:\x20','⏰\x20[HOURLY]\x20Payment\x20','GLOBAL_CHECK_INTERVAL_MS','🧹\x20[CHECK]\x20Payment\x20','paid','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','paymentTimers','Success','paymentId','default','delete','stringify','\x20status\x20is\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','Bank\x20Details:\x20','0100','stopPeriodicStatusCheck','../config/database','\x20for\x20payment\x20','\x20in\x20','toISOString','🧹\x20[DEBUG]\x20Clearing\x20','from','12422375GAsvHs','webhook_send','currency','findUnique','6057210zJoZVy','🔄\x20[CHECK]\x20Updating\x20payment\x20','checkPaymentById','timestamp','push','🛑\x20[SHUTDOWN]\x20Cleared\x20','\x20not\x20found\x20in\x20database','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','log','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','1\x20minute','settings','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','getTime','logCoinToPayStatus','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20->\x20','EXPIRY_DAYS','telegramBotService',',\x20stopping\x20individual\x20checks','PENDING','3479296vWdlgs','\x20\x20\x20-\x20Amount:\x20','gateway','amount','paymentDetails','EXPIRED','\x20triggered\x20for\x20payment\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','defineProperty','webhookUrl','\x20is\x20valid\x20for\x20checking,\x20proceeding...','unknown','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20details:','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','payment.failed','cointopay_auto_expired','application/json','failed','__esModule','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20days\x20(created\x20before\x20','orderId','Webhook\x20event\x20','\x20completed\x20for\x20payment\x20','\x20has\x20no\x20gatewayPaymentId','2\x20minutes','findMany','auto_expire','confirmedOn','error','\x20expired','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20(after\x20','\x20days\x20without\x20payment\x20confirmation','\x20\x20\x20-\x20gatewayPaymentId:\x20','sendPaymentStatusNotification','checkExpiredPayments','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','COINTOPAY_STATUS_CHANGE','⏰\x20[GLOBAL]\x20Found\x20','\x20is\x20too\x20new\x20(','webhookEvents',',\x20clearing\x20individual\x20timers','\x20not\x20enabled\x20for\x20shop\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','\x20initial\x20timers\x20for\x20payment\x20','now','\x20expired\x20CoinToPay\x20payments','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','Failed\x20to\x20send\x20shop\x20webhook:','\x20\x20\x20-\x20Status:\x20','set','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','coinToPayStatusService','clearPaymentTimers','stack','loggerService','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','forEach','Unknown\x20error','\x20\x20\x20📝\x20Details:','gatewayPaymentId','bankDetails','\x20current\x20status:\x20','create','not\x20found','\x20pending\x20CoinToPay\x20payments','checkSinglePayment','customerEmail','\x20individual\x20payment\x20timers','\x20\x20\x20📊\x20Status:\x20','PAID','❌\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20Gateway:\x20','\x20to\x20clear','get','checkAllPendingPayments','\x20\x20\x20-\x20paymentId:\x20','2166bZagkv','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','.\x20Remaining\x20active\x20timers:\x20','transactionId','5\x20minutes','delay','Automatically\x20expired\x20after\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','setDate','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','createdAt','paidAt','CoinToPayService','getServiceStats','1202150jYzbLr','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','getPaymentTimerInfo','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','sendShopWebhook','floor','adminNotes','Payment\x20not\x20found','📊\x20[CHECK]\x20Payment\x20','\x20to\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','logShopWebhookSent','💰\x20[CHECK]\x20Payment\x20','\x20with\x20status\x20','\x20timers\x20for\x20payment\x20','cointopay','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20days','includes','/status/','\x20checked,\x20','🪙\x20[GLOBAL]\x20Found\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','56329376vaGtiY','status_check','\x20marked\x20as\x20paid\x20at:\x20','⚠️\x20[CHECK]\x20Payment\x20','logCoinToPayError','\x20status\x20from\x20','7227360gLDzJc','toLowerCase','not\x20confirmed','✅\x20[HOURLY]\x20Payment\x20','\x20(age:\x20','size','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','shopId','__importDefault','globalCheckInterval','\x20\x20\x20📍\x20Source:\x20','❌\x20[HOURLY]\x20Payment\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','shop','\x20is\x20older\x20than\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20seconds\x20(','toFixed','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','CoinToPayStatusService','description','⏰\x20[EXPIRY]\x20Payment\x20','timers','checkPaymentStatus','Payment\x20older\x20than\x20','\x20\x20\x20📝\x20Context:','cointopay_status_check_','message','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','✅\x20[CHECK]\x20Payment\x20'];a37_0x4816=function(){return _0x23fbac;};return a37_0x4816();}exports[a37_0x173c7d(0x21f)]=CoinToPayStatusService,exports[a37_0x173c7d(0x1c5)]=new CoinToPayStatusService();