'use strict';function a37_0x5150(){const _0x5eeb2e=['now','\x20\x20\x20❌\x20Error:\x20','Failed\x20to\x20send\x20shop\x20webhook:','timestamp','\x20completed\x20for\x20payment\x20','description','Payment\x20older\x20than\x20','logShopWebhookSent','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','CoinToPayStatusService','\x20current\x20status:\x20','42mEmIXs','findUnique','__importDefault','\x20not\x20found,\x20clearing\x20timers','✅\x20[TIMER]\x20Individual\x20check\x20#','bankDetails','\x20is\x20too\x20new\x20(','\x20\x20\x20-\x20Amount:\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','908052SSJZHK','orderId','260OzFVHt','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','checkPaymentById','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','push','2\x20minutes','\x20pending\x20CoinToPay\x20payments','gatewayPaymentId','loggerService','Shop\x20webhook\x20sent\x20to\x20','toISOString','COINTOPAY_STATUS_CHANGE','cointopay','\x20days\x20without\x20payment\x20confirmation','__esModule','3ErTXQL','paid','\x20status\x20changed\x20to\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','0100','h),\x20skipping\x20global\x20check','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','Payment\x20not\x20found','Webhook\x20event\x20','sendPaymentStatusNotification','logCoinToPayStatus','payment.failed','failed','⏰\x20[EXPIRY]\x20Payment\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20\x20\x20📍\x20Source:\x20','application/json','\x20initial\x20timers\x20for\x20payment\x20','floor','customerEmail','logCoinToPayError','\x20\x20\x20📅\x20Time:\x20','668342zIVJlG','\x20checked,\x20','78201kWaWXr','webhookLog','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','ms)','\x20found:','\x20\x20\x20-\x20ShopId:\x20','values','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','getTime','forEach','\x20to\x20clear','5\x20minutes','15rxRxkb','settings','\x20has\x20no\x20gatewayPaymentId,\x20skipping','PENDING','/status/','🪙\x20CoinToPayStatusService\x20initialized','\x20\x20\x20📝\x20Context:','\x20(after\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','error','🪙\x20[TIMER]\x20Individual\x20check\x20#','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','payment','🪙\x20[DEBUG]\x20Creating\x20','EXPIRY_DAYS','📊\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','GLOBAL_CHECK_INTERVAL_MS','size','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20has\x20no\x20gatewayPaymentId','stopPeriodicStatusCheck','has','telegramBotService','expired','set','-day\x20timeout','cointopay_status_check_error','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','paidAt','checkExpiredPayments','created','\x20status\x20from\x20','adminNotes','paymentTimers','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','stringify','\x20status\x20unchanged\x20(','checkAllPendingPayments','getServiceStats','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','clearPaymentTimers','create','checkSinglePaymentById','get','timers','sendShopWebhook','🛑\x20[SHUTDOWN]\x20Cleared\x20','\x20skipped,\x20','💰\x20[CHECK]\x20Payment\x20','PAID','default','60fMrgcC','iban','\x20status:\x20','not\x20confirmed','from','159272yRGcvG','⏰\x20[GLOBAL]\x20Found\x20','\x20triggered\x20for\x20payment\x20','payment.pending','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','🧹\x20[DEBUG]\x20Clearing\x20','⏰\x20[GLOBAL]\x20Payment\x20','globalCheckInterval','⚠️\x20[CHECK]\x20Payment\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','\x20\x20\x20-\x20Status:\x20','coinToPayStatusService','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','./gateways/coinToPayService','currency','paymentDetails','\x20->\x20','.\x20Remaining\x20active\x20timers:\x20','Success','\x20for\x20payment\x20','schedule_created','✅\x20[HOURLY]\x20Payment\x20','log','Failed\x20to\x20mark\x20payment\x20as\x20expired','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','message','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20details:','webhookUrl','🔄\x20[CHECK]\x20Updating\x20payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','status_check','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','stack',',\x20stopping\x20individual\x20checks','\x20is\x20older\x20than\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','7802564nOBhcI','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','payment.success','⏰\x20[HOURLY]\x20Payment\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','cointopay_status_check_','createdAt','not\x20found','amount','startPeriodicStatusCheck','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','coinToPayService','unknown','🧹\x20[CHECK]\x20Payment\x20','\x20in\x20','delay','defineProperty','\x20expired','\x20\x20\x20-\x20gatewayPaymentId:\x20','\x20\x20\x20📝\x20Details:','toFixed','confirmedOn','🪙\x20[GLOBAL]\x20Found\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','findMany','✅\x20[EXPIRY]\x20Payment\x20','update','checkSinglePayment','\x20to\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','shopId','auto_expire','schedulePaymentChecks','\x20days,\x20marking\x20as\x20EXPIRED','\x20seconds\x20(','129627dCXRqa','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','EXPIRED','COINTOPAY_ERROR','\x20status\x20is\x20','getPaymentTimerInfo','createdOn','✅\x20[CHECK]\x20Payment\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','gatewayOrderId','webhook_send','toLowerCase','transactionId','📊\x20[HOURLY]\x20Payment\x20','status','\x20timers\x20for\x20payment\x20','delete','❌\x20[HOURLY]\x20Payment\x20','setDate','includes','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','customerName','cointopay_auto_expired','Bank\x20Details:\x20','length','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','paymentId','shop','./telegramBotService','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','gateway'];a37_0x5150=function(){return _0x5eeb2e;};return a37_0x5150();}const a37_0x201314=a37_0x2f73;(function(_0x159d26,_0x4840f8){const _0x239fb5=a37_0x2f73,_0x3ec788=_0x159d26();while(!![]){try{const _0x54cf35=-parseInt(_0x239fb5(0x1bf))/0x1+-parseInt(_0x239fb5(0x1bd))/0x2*(parseInt(_0x239fb5(0x1a7))/0x3)+parseInt(_0x239fb5(0x198))/0x4*(parseInt(_0x239fb5(0x1cb))/0x5)+parseInt(_0x239fb5(0x196))/0x6+-parseInt(_0x239fb5(0x18d))/0x7*(parseInt(_0x239fb5(0x206))/0x8)+parseInt(_0x239fb5(0x250))/0x9*(-parseInt(_0x239fb5(0x201))/0xa)+parseInt(_0x239fb5(0x22c))/0xb;if(_0x54cf35===_0x4840f8)break;else _0x3ec788['push'](_0x3ec788['shift']());}catch(_0x464527){_0x3ec788['push'](_0x3ec788['shift']());}}}(a37_0x5150,0x3b3b9));var __importDefault=this&&this[a37_0x201314(0x18f)]||function(_0x4a1532){const _0x1f5362=a37_0x201314;return _0x4a1532&&_0x4a1532[_0x1f5362(0x1a6)]?_0x4a1532:{'default':_0x4a1532};};Object[a37_0x201314(0x23d)](exports,a37_0x201314(0x1a6),{'value':!![]}),exports[a37_0x201314(0x211)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a37_0x201314(0x213)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x201314(0x26e)),loggerService_1=require('./loggerService');function a37_0x2f73(_0xe012ab,_0x25a9ce){const _0x515078=a37_0x5150();return a37_0x2f73=function(_0x2f736d,_0x29d190){_0x2f736d=_0x2f736d-0x183;let _0x5e6265=_0x515078[_0x2f736d];return _0x5e6265;},a37_0x2f73(_0xe012ab,_0x25a9ce);}class CoinToPayStatusService{constructor(){const _0x43c4fc=a37_0x201314;this[_0x43c4fc(0x20d)]=null,this[_0x43c4fc(0x1dd)]=0x3c*0x3c*0x3e8,this[_0x43c4fc(0x1da)]=0x5,this['paymentTimers']=new Map(),this[_0x43c4fc(0x238)]=new coinToPayService_1['CoinToPayService'](),console[_0x43c4fc(0x21c)](_0x43c4fc(0x1d0));}[a37_0x201314(0x24d)](_0x5bde38,_0x2a0010){const _0x523946=a37_0x201314;console[_0x523946(0x21c)](_0x523946(0x199)),console[_0x523946(0x21c)]('\x20\x20\x20-\x20paymentId:\x20'+_0x5bde38),console['log'](_0x523946(0x23f)+_0x2a0010),this[_0x523946(0x1f6)](_0x5bde38);const _0x4f306b=[],_0x5a8ccc=new Date(),_0x2419bf=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x523946(0x19d)},{'delay':0x5*0x3c*0x3e8,'description':_0x523946(0x1ca)},{'delay':0x5*0x3c*0x3e8,'description':_0x523946(0x1ca)}];console['log'](_0x523946(0x1d9)+_0x2419bf[_0x523946(0x26a)]+_0x523946(0x1b8)+_0x5bde38);let _0x5585c6=0x0;_0x2419bf[_0x523946(0x1c8)]((_0x48cea5,_0x64e81f)=>{const _0x41d4a1=_0x523946;_0x5585c6+=_0x48cea5['delay'];const _0x4eb955=setTimeout(async()=>{const _0x5248c6=a37_0x2f73;console['log'](_0x5248c6(0x1d5)+(_0x64e81f+0x1)+_0x5248c6(0x208)+_0x5bde38+_0x5248c6(0x1d2)+_0x48cea5[_0x5248c6(0x187)]+')');try{await this[_0x5248c6(0x1f8)](_0x5bde38),console[_0x5248c6(0x21c)](_0x5248c6(0x191)+(_0x64e81f+0x1)+_0x5248c6(0x186)+_0x5bde38);}catch(_0x5f16c7){console[_0x5248c6(0x1d4)](_0x5248c6(0x1d7)+(_0x64e81f+0x1)+'\x20for\x20payment\x20'+_0x5bde38+':',_0x5f16c7),this['logCoinToPayError'](_0x5bde38,_0x2a0010,_0x5f16c7,_0x5248c6(0x226),{'checkNumber':_0x64e81f+0x1,'scheduledAfter':_0x48cea5['description'],'isIndividualCheck':!![]});}},_0x5585c6);_0x4f306b[_0x41d4a1(0x19c)](_0x4eb955),console['log'](_0x41d4a1(0x1ad)+(_0x64e81f+0x1)+_0x41d4a1(0x219)+_0x5bde38+_0x41d4a1(0x23b)+_0x5585c6/0x3e8+_0x41d4a1(0x24f)+_0x48cea5[_0x41d4a1(0x187)]+')');});const _0x44a263=setInterval(async()=>{const _0x2ff8ea=_0x523946;console[_0x2ff8ea(0x21c)](_0x2ff8ea(0x1d6)+_0x5bde38);try{const _0xd0579d=await database_1[_0x2ff8ea(0x200)][_0x2ff8ea(0x1d8)]['findUnique']({'where':{'id':_0x5bde38},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0xd0579d){console[_0x2ff8ea(0x21c)](_0x2ff8ea(0x261)+_0x5bde38+_0x2ff8ea(0x190)),this['clearPaymentTimers'](_0x5bde38);return;}console[_0x2ff8ea(0x21c)](_0x2ff8ea(0x25d)+_0x5bde38+_0x2ff8ea(0x18c)+_0xd0579d[_0x2ff8ea(0x25e)]);if(_0xd0579d['status']!=='PENDING'){console[_0x2ff8ea(0x21c)](_0x2ff8ea(0x21b)+_0x5bde38+_0x2ff8ea(0x254)+_0xd0579d[_0x2ff8ea(0x25e)]+_0x2ff8ea(0x229)),this[_0x2ff8ea(0x1f6)](_0x5bde38);return;}const _0x51ec9f=Math[_0x2ff8ea(0x1b9)]((Date[_0x2ff8ea(0x271)]()-_0xd0579d['createdAt'][_0x2ff8ea(0x1c7)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x51ec9f>=this[_0x2ff8ea(0x1da)]){console[_0x2ff8ea(0x21c)](_0x2ff8ea(0x22f)+_0x5bde38+_0x2ff8ea(0x22a)+this[_0x2ff8ea(0x1da)]+_0x2ff8ea(0x258)),this[_0x2ff8ea(0x1f6)](_0x5bde38);return;}await this['checkSinglePaymentById'](_0x5bde38),console[_0x2ff8ea(0x21c)](_0x2ff8ea(0x22b)+_0x5bde38);}catch(_0x2e8e9c){console[_0x2ff8ea(0x1d4)](_0x2ff8ea(0x1e9)+_0x5bde38+':',_0x2e8e9c),this['logCoinToPayError'](_0x5bde38,_0x2a0010,_0x2e8e9c,_0x2ff8ea(0x226),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x4f306b['push'](_0x44a263),this[_0x523946(0x1ef)][_0x523946(0x1e6)](_0x5bde38,{'timers':_0x4f306b,'paymentId':_0x5bde38,'gatewayPaymentId':_0x2a0010,'createdAt':_0x5a8ccc}),console['log'](_0x523946(0x26b)+_0x2419bf['length']+_0x523946(0x1aa)+_0x5bde38),console[_0x523946(0x21c)](_0x523946(0x1f5)+this[_0x523946(0x1ef)][_0x523946(0x1de)]),this['logCoinToPayStatus'](_0x5bde38,_0x2a0010,_0x523946(0x1ce),'PENDING',_0x523946(0x226),{'action':_0x523946(0x21a),'scheduledChecks':_0x2419bf['length'],'firstCheckIn':_0x2419bf[0x0][_0x523946(0x23c)]/0x3e8,'totalTimers':this['paymentTimers']['size']});}['clearPaymentTimers'](_0x531090){const _0x1620ad=a37_0x201314,_0x5efd43=this[_0x1620ad(0x1ef)][_0x1620ad(0x1f9)](_0x531090);_0x5efd43?(console[_0x1620ad(0x21c)](_0x1620ad(0x20b)+_0x5efd43['timers'][_0x1620ad(0x26a)]+_0x1620ad(0x25f)+_0x531090),_0x5efd43[_0x1620ad(0x1fa)]['forEach']((_0x1f8f08,_0xc01f80)=>{const _0x14be72=_0x1620ad;_0x1f8f08&&(clearTimeout(_0x1f8f08),clearInterval(_0x1f8f08),console[_0x14be72(0x21c)](_0x14be72(0x1df)+(_0xc01f80+0x1)+'\x20for\x20payment\x20'+_0x531090));}),this['paymentTimers'][_0x1620ad(0x260)](_0x531090),console['log'](_0x1620ad(0x251)+_0x531090+_0x1620ad(0x217)+this[_0x1620ad(0x1ef)][_0x1620ad(0x1de)])):console[_0x1620ad(0x21c)](_0x1620ad(0x1f0)+_0x531090+_0x1620ad(0x1c9));}async['checkSinglePaymentById'](_0x13d11f){const _0x3d3c9e=a37_0x201314;console[_0x3d3c9e(0x21c)](_0x3d3c9e(0x19b)+_0x13d11f);const _0x2148b9=await database_1[_0x3d3c9e(0x200)][_0x3d3c9e(0x1d8)][_0x3d3c9e(0x18e)]({'where':{'id':_0x13d11f},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2148b9){console['log']('❌\x20[CHECK]\x20Payment\x20'+_0x13d11f+'\x20not\x20found\x20in\x20database');return;}console[_0x3d3c9e(0x21c)](_0x3d3c9e(0x1db)+_0x13d11f+_0x3d3c9e(0x1c3)),console[_0x3d3c9e(0x21c)]('\x20\x20\x20-\x20Gateway:\x20'+_0x2148b9['gateway']),console[_0x3d3c9e(0x21c)](_0x3d3c9e(0x210)+_0x2148b9[_0x3d3c9e(0x25e)]),console[_0x3d3c9e(0x21c)](_0x3d3c9e(0x1dc)+_0x2148b9['gatewayPaymentId']),console[_0x3d3c9e(0x21c)](_0x3d3c9e(0x194)+_0x2148b9[_0x3d3c9e(0x235)]+'\x20'+_0x2148b9[_0x3d3c9e(0x214)]),console[_0x3d3c9e(0x21c)](_0x3d3c9e(0x1c4)+_0x2148b9[_0x3d3c9e(0x24b)]);if(_0x2148b9['gateway']!==_0x3d3c9e(0x1a4)){console[_0x3d3c9e(0x21c)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x13d11f+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x2148b9[_0x3d3c9e(0x270)]+')');return;}if(_0x2148b9['status']!==_0x3d3c9e(0x1ce)){console['log'](_0x3d3c9e(0x20e)+_0x13d11f+'\x20status\x20is\x20'+_0x2148b9[_0x3d3c9e(0x25e)]+_0x3d3c9e(0x229)),this['clearPaymentTimers'](_0x13d11f);return;}if(!_0x2148b9['gatewayPaymentId']){console['log'](_0x3d3c9e(0x20e)+_0x13d11f+_0x3d3c9e(0x1e1));return;}console['log']('✅\x20[CHECK]\x20Payment\x20'+_0x13d11f+_0x3d3c9e(0x244)),await this[_0x3d3c9e(0x248)](_0x2148b9);}[a37_0x201314(0x1b1)](_0x234f09,_0x26defa,_0x323937,_0x9838e6,_0x19c2a9,_0x4404a2){const _0x1abb06=a37_0x201314,_0x25b2ab={'type':_0x1abb06(0x1a3),'paymentId':_0x234f09,'gatewayPaymentId':_0x26defa,'oldStatus':_0x323937,'newStatus':_0x9838e6,'source':_0x19c2a9,'timestamp':new Date()[_0x1abb06(0x1a2)](),'details':_0x4404a2||{}};loggerService_1[_0x1abb06(0x1a0)][_0x1abb06(0x1b1)](_0x25b2ab),console[_0x1abb06(0x21c)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x234f09+'\x20('+_0x26defa+')'),console[_0x1abb06(0x21c)]('\x20\x20\x20📊\x20Status:\x20'+_0x323937+_0x1abb06(0x216)+_0x9838e6),console[_0x1abb06(0x21c)]('\x20\x20\x20📍\x20Source:\x20'+_0x19c2a9),console['log'](_0x1abb06(0x1bc)+_0x25b2ab[_0x1abb06(0x185)]),_0x4404a2&&console['log'](_0x1abb06(0x240),_0x4404a2);}['logCoinToPayError'](_0x520df7,_0x23c062,_0x59ec6c,_0x36b458,_0x43a3df){const _0x462fed=a37_0x201314,_0x3dfb7b={'type':_0x462fed(0x253),'paymentId':_0x520df7,'gatewayPaymentId':_0x23c062,'error':_0x59ec6c instanceof Error?{'message':_0x59ec6c[_0x462fed(0x220)],'stack':_0x59ec6c[_0x462fed(0x228)]}:_0x59ec6c,'source':_0x36b458,'timestamp':new Date()[_0x462fed(0x1a2)](),'context':_0x43a3df||{}};loggerService_1[_0x462fed(0x1a0)][_0x462fed(0x1bb)](_0x3dfb7b),console[_0x462fed(0x1d4)](_0x462fed(0x20a)+_0x520df7+'\x20('+_0x23c062+')'),console[_0x462fed(0x1d4)](_0x462fed(0x183)+(_0x59ec6c instanceof Error?_0x59ec6c[_0x462fed(0x220)]:_0x59ec6c)),console[_0x462fed(0x1d4)](_0x462fed(0x1b6)+_0x36b458),console[_0x462fed(0x1d4)](_0x462fed(0x1bc)+_0x3dfb7b[_0x462fed(0x185)]),_0x43a3df&&console[_0x462fed(0x1d4)](_0x462fed(0x1d1),_0x43a3df);}[a37_0x201314(0x236)](){const _0x2e0f4f=a37_0x201314;console['log'](_0x2e0f4f(0x1b5)),this[_0x2e0f4f(0x1f3)]()['catch'](_0x52e627=>{const _0x2ec15d=_0x2e0f4f;console[_0x2ec15d(0x1d4)]('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x52e627);}),this[_0x2e0f4f(0x20d)]=setInterval(async()=>{const _0x291f85=_0x2e0f4f;try{console['log'](_0x291f85(0x264)),await this[_0x291f85(0x1f3)](),console[_0x291f85(0x21c)]('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x177786){console['error'](_0x291f85(0x212),_0x177786);}},this[_0x2e0f4f(0x1dd)]),console[_0x2e0f4f(0x21c)](_0x2e0f4f(0x1e0));}[a37_0x201314(0x1e2)](){const _0xc25ea3=a37_0x201314;console[_0xc25ea3(0x21c)]('🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this['globalCheckInterval']&&(clearInterval(this[_0xc25ea3(0x20d)]),this[_0xc25ea3(0x20d)]=null,console[_0xc25ea3(0x21c)](_0xc25ea3(0x227)));const _0x17fbea=this[_0xc25ea3(0x1ef)][_0xc25ea3(0x1de)];for(const [_0x5245d1]of this[_0xc25ea3(0x1ef)]){this[_0xc25ea3(0x1f6)](_0x5245d1);}console[_0xc25ea3(0x21c)](_0xc25ea3(0x1fc)+_0x17fbea+'\x20individual\x20payment\x20timers');}async['checkAllPendingPayments'](){const _0x1a374c=a37_0x201314;try{console[_0x1a374c(0x21c)](_0x1a374c(0x230));const _0x41d63e=await database_1['default']['payment'][_0x1a374c(0x245)]({'where':{'gateway':'cointopay','status':_0x1a374c(0x1ce),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x1a374c(0x21c)](_0x1a374c(0x243)+_0x41d63e['length']+_0x1a374c(0x19e));if(_0x41d63e[_0x1a374c(0x26a)]===0x0){console[_0x1a374c(0x21c)](_0x1a374c(0x1c6));return;}const _0x2e94d3=await this[_0x1a374c(0x1eb)](_0x41d63e);console[_0x1a374c(0x21c)](_0x1a374c(0x207)+_0x2e94d3['length']+'\x20expired\x20CoinToPay\x20payments');let _0x16fca9=0x0,_0x1ad90e=0x0;for(const _0x2cd049 of _0x41d63e){try{if(_0x2e94d3['includes'](_0x2cd049['id'])){console[_0x1a374c(0x21c)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x2cd049['id']+_0x1a374c(0x1c1)),_0x1ad90e++;continue;}if(this[_0x1a374c(0x1ef)][_0x1a374c(0x1e3)](_0x2cd049['id'])){console[_0x1a374c(0x21c)](_0x1a374c(0x20c)+_0x2cd049['id']+_0x1a374c(0x21f)),_0x1ad90e++;continue;}const _0x253465=(Date[_0x1a374c(0x271)]()-_0x2cd049[_0x1a374c(0x233)][_0x1a374c(0x1c7)]())/(0x3e8*0x3c*0x3c);if(_0x253465<0x1){console[_0x1a374c(0x21c)](_0x1a374c(0x20c)+_0x2cd049['id']+_0x1a374c(0x193)+_0x253465[_0x1a374c(0x241)](0x1)+_0x1a374c(0x1ac)),_0x1ad90e++;continue;}console['log'](_0x1a374c(0x195)+_0x2cd049['id']+'\x20(age:\x20'+_0x253465[_0x1a374c(0x241)](0x1)+'h)'),await this[_0x1a374c(0x248)](_0x2cd049),_0x16fca9++,await new Promise(_0x339564=>setTimeout(_0x339564,0x7d0));}catch(_0x1110d3){console[_0x1a374c(0x1d4)]('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x2cd049['id']+':',_0x1110d3),this[_0x1a374c(0x1bb)](_0x2cd049['id'],_0x2cd049['gatewayPaymentId']||_0x1a374c(0x239),_0x1110d3,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x2cd049[_0x1a374c(0x235)],'paymentCurrency':_0x2cd049[_0x1a374c(0x214)],'shopId':_0x2cd049[_0x1a374c(0x24b)],'createdAt':_0x2cd049[_0x1a374c(0x233)]}),loggerService_1['loggerService']['logWhiteDomainError']('cointopay',_0x1a374c(0x1cf)+_0x2cd049['gatewayPaymentId'],_0x1110d3);}}console[_0x1a374c(0x21c)](_0x1a374c(0x24a)+_0x16fca9+_0x1a374c(0x1be)+_0x1ad90e+_0x1a374c(0x1fd)+_0x2e94d3[_0x1a374c(0x26a)]+_0x1a374c(0x23e));}catch(_0x2153db){console[_0x1a374c(0x1d4)](_0x1a374c(0x266),_0x2153db);}}async[a37_0x201314(0x1eb)](_0x4060ae){const _0x457007=a37_0x201314,_0x187fca=[],_0xc6d007=new Date();_0xc6d007[_0x457007(0x262)](_0xc6d007['getDate']()-this['EXPIRY_DAYS']),console[_0x457007(0x21c)](_0x457007(0x26f)+this[_0x457007(0x1da)]+'\x20days\x20(created\x20before\x20'+_0xc6d007[_0x457007(0x1a2)]()+')');for(const _0xf4048a of _0x4060ae){if(_0xf4048a[_0x457007(0x233)]<_0xc6d007){console[_0x457007(0x21c)](_0x457007(0x1b4)+_0xf4048a['id']+_0x457007(0x22a)+this[_0x457007(0x1da)]+_0x457007(0x24e));try{this[_0x457007(0x1b1)](_0xf4048a['id'],_0xf4048a[_0x457007(0x19f)]||_0x457007(0x239),'PENDING',_0x457007(0x252),_0x457007(0x24c),{'reason':'Payment\x20older\x20than\x20'+this[_0x457007(0x1da)]+'\x20days','createdAt':_0xf4048a['createdAt'],'daysSinceCreation':Math[_0x457007(0x1b9)]((Date['now']()-_0xf4048a[_0x457007(0x233)][_0x457007(0x1c7)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0xf4048a[_0x457007(0x235)],'paymentCurrency':_0xf4048a[_0x457007(0x214)],'shopId':_0xf4048a[_0x457007(0x24b)]}),await database_1[_0x457007(0x200)]['payment'][_0x457007(0x247)]({'where':{'id':_0xf4048a['id']},'data':{'status':_0x457007(0x252),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this['EXPIRY_DAYS']+_0x457007(0x1a5)}}),await database_1[_0x457007(0x200)][_0x457007(0x1c0)][_0x457007(0x1f7)]({'data':{'paymentId':_0xf4048a['id'],'shopId':_0xf4048a[_0x457007(0x24b)],'event':_0x457007(0x268),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x457007(0x188)+this[_0x457007(0x1da)]+'\x20days','createdAt':_0xf4048a[_0x457007(0x233)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x457007(0x1b9)]((Date['now']()-_0xf4048a[_0x457007(0x233)][_0x457007(0x1c7)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x457007(0x1fb)](_0xf4048a,_0x457007(0x252)),await this[_0x457007(0x1b0)](_0xf4048a,_0x457007(0x252)),this[_0x457007(0x1f6)](_0xf4048a['id']),_0x187fca[_0x457007(0x19c)](_0xf4048a['id']),console[_0x457007(0x21c)](_0x457007(0x246)+_0xf4048a['id']+_0x457007(0x22d)+this[_0x457007(0x1da)]+_0x457007(0x1e7));}catch(_0x3d2f50){console[_0x457007(0x1d4)](_0x457007(0x18a)+_0xf4048a['id']+':',_0x3d2f50),this[_0x457007(0x1bb)](_0xf4048a['id'],_0xf4048a[_0x457007(0x19f)]||_0x457007(0x239),_0x3d2f50,_0x457007(0x24c),{'reason':_0x457007(0x21d),'createdAt':_0xf4048a[_0x457007(0x233)],'daysSinceCreation':Math[_0x457007(0x1b9)]((Date['now']()-_0xf4048a[_0x457007(0x233)][_0x457007(0x1c7)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x187fca;}async[a37_0x201314(0x248)](_0x32ee92){const _0x2e7420=a37_0x201314;if(!_0x32ee92[_0x2e7420(0x19f)]){console['log'](_0x2e7420(0x20e)+_0x32ee92['id']+_0x2e7420(0x1cd));return;}console['log']('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x32ee92['id']+'\x20('+_0x32ee92[_0x2e7420(0x19f)]+')');try{const _0x24b22d=await this[_0x2e7420(0x238)]['checkPaymentStatus'](_0x32ee92[_0x2e7420(0x19f)]);console[_0x2e7420(0x21c)](_0x2e7420(0x1db)+_0x32ee92['id']+_0x2e7420(0x203)+_0x24b22d['status']);_0x24b22d[_0x2e7420(0x215)]&&console[_0x2e7420(0x21c)](_0x2e7420(0x1db)+_0x32ee92['id']+_0x2e7420(0x222),{'iban':_0x24b22d[_0x2e7420(0x215)][_0x2e7420(0x202)]||_0x2e7420(0x234),'transactionId':_0x24b22d[_0x2e7420(0x215)][_0x2e7420(0x25c)],'createdOn':_0x24b22d['paymentDetails'][_0x2e7420(0x256)],'confirmedOn':_0x24b22d[_0x2e7420(0x215)][_0x2e7420(0x242)]||_0x2e7420(0x204)});if(_0x24b22d[_0x2e7420(0x25e)]!==_0x32ee92[_0x2e7420(0x25e)]){console['log'](_0x2e7420(0x224)+_0x32ee92['id']+_0x2e7420(0x1ed)+_0x32ee92['status']+_0x2e7420(0x249)+_0x24b22d[_0x2e7420(0x25e)]),this['logCoinToPayStatus'](_0x32ee92['id'],_0x32ee92[_0x2e7420(0x19f)],_0x32ee92['status'],_0x24b22d[_0x2e7420(0x25e)],_0x2e7420(0x226),{'paymentDetails':_0x24b22d[_0x2e7420(0x215)],'amount':_0x24b22d[_0x2e7420(0x235)],'currency':_0x24b22d['currency'],'shopId':_0x32ee92[_0x2e7420(0x24b)],'checkTimestamp':new Date()[_0x2e7420(0x1a2)]()});const _0x16b4b5={'status':_0x24b22d[_0x2e7420(0x25e)],'updatedAt':new Date()};_0x24b22d[_0x2e7420(0x25e)]===_0x2e7420(0x1ff)&&_0x32ee92[_0x2e7420(0x25e)]!=='PAID'&&(_0x16b4b5['paidAt']=new Date(),console[_0x2e7420(0x21c)](_0x2e7420(0x1fe)+_0x32ee92['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x16b4b5[_0x2e7420(0x1ea)]['toISOString']()));if(_0x24b22d['paymentDetails']){const _0x14d4e8=_0x24b22d['paymentDetails'];_0x14d4e8[_0x2e7420(0x202)]&&(_0x16b4b5['remitterIban']=_0x14d4e8[_0x2e7420(0x202)],console['log']('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x14d4e8[_0x2e7420(0x202)]));if(_0x14d4e8[_0x2e7420(0x192)]){const _0x48f46d=_0x32ee92[_0x2e7420(0x1ee)]||'',_0x407b6b=_0x2e7420(0x269)+_0x14d4e8[_0x2e7420(0x192)];_0x16b4b5['adminNotes']=_0x48f46d?_0x48f46d+'\x0a\x0a'+_0x407b6b:_0x407b6b,console[_0x2e7420(0x21c)](_0x2e7420(0x231));}_0x14d4e8[_0x2e7420(0x25c)]&&console[_0x2e7420(0x21c)](_0x2e7420(0x20f)+_0x14d4e8[_0x2e7420(0x25c)]),_0x14d4e8[_0x2e7420(0x242)]&&console[_0x2e7420(0x21c)]('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x14d4e8[_0x2e7420(0x242)]);}await database_1[_0x2e7420(0x200)]['payment'][_0x2e7420(0x247)]({'where':{'id':_0x32ee92['id']},'data':_0x16b4b5}),await database_1['default'][_0x2e7420(0x1c0)][_0x2e7420(0x1f7)]({'data':{'paymentId':_0x32ee92['id'],'shopId':_0x32ee92[_0x2e7420(0x24b)],'event':_0x2e7420(0x232)+_0x24b22d[_0x2e7420(0x25e)][_0x2e7420(0x25b)](),'statusCode':0xc8,'responseBody':JSON[_0x2e7420(0x1f1)]({'oldStatus':_0x32ee92[_0x2e7420(0x25e)],'newStatus':_0x24b22d[_0x2e7420(0x25e)],'paymentDetails':_0x24b22d[_0x2e7420(0x215)],'checkedAt':new Date()[_0x2e7420(0x1a2)]()})}}),await this[_0x2e7420(0x1fb)](_0x32ee92,_0x24b22d['status']),await this[_0x2e7420(0x1b0)](_0x32ee92,_0x24b22d[_0x2e7420(0x25e)]),_0x24b22d['status']!==_0x2e7420(0x1ce)&&(console['log'](_0x2e7420(0x23a)+_0x32ee92['id']+_0x2e7420(0x1a9)+_0x24b22d[_0x2e7420(0x25e)]+',\x20clearing\x20individual\x20timers'),this[_0x2e7420(0x1f6)](_0x32ee92['id'])),console[_0x2e7420(0x21c)](_0x2e7420(0x257)+_0x32ee92['id']+'\x20updated\x20successfully');}else console[_0x2e7420(0x21c)](_0x2e7420(0x1db)+_0x32ee92['id']+_0x2e7420(0x1f2)+_0x24b22d[_0x2e7420(0x25e)]+')'),this[_0x2e7420(0x1b1)](_0x32ee92['id'],_0x32ee92[_0x2e7420(0x19f)],_0x32ee92[_0x2e7420(0x25e)],_0x24b22d['status'],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x24b22d[_0x2e7420(0x215)],'amount':_0x24b22d['amount'],'currency':_0x24b22d[_0x2e7420(0x214)],'shopId':_0x32ee92[_0x2e7420(0x24b)],'checkTimestamp':new Date()[_0x2e7420(0x1a2)]()});}catch(_0x1ebebc){console[_0x2e7420(0x1d4)]('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x32ee92['id']+':',_0x1ebebc),this['logCoinToPayError'](_0x32ee92['id'],_0x32ee92[_0x2e7420(0x19f)],_0x1ebebc,'status_check',{'paymentAmount':_0x32ee92['amount'],'paymentCurrency':_0x32ee92[_0x2e7420(0x214)],'shopId':_0x32ee92[_0x2e7420(0x24b)],'createdAt':_0x32ee92[_0x2e7420(0x233)]}),await database_1[_0x2e7420(0x200)][_0x2e7420(0x1c0)]['create']({'data':{'paymentId':_0x32ee92['id'],'shopId':_0x32ee92[_0x2e7420(0x24b)],'event':_0x2e7420(0x1e8),'statusCode':0x1f4,'responseBody':JSON[_0x2e7420(0x1f1)]({'error':_0x1ebebc instanceof Error?_0x1ebebc[_0x2e7420(0x220)]:'Unknown\x20error','gatewayPaymentId':_0x32ee92[_0x2e7420(0x19f)],'checkedAt':new Date()[_0x2e7420(0x1a2)]()})}});}}async['sendShopWebhook'](_0x2d63e7,_0x52fc2a){const _0x18bbaf=a37_0x201314,_0x4c0a0c=Date[_0x18bbaf(0x271)]();try{const _0xdf5429=_0x2d63e7['shop'],_0x28cd81=_0xdf5429[_0x18bbaf(0x1cc)];if(!_0x28cd81?.[_0x18bbaf(0x223)]){console['log'](_0x18bbaf(0x225)+_0xdf5429['id']);return;}const _0x15a726=_0x52fc2a===_0x18bbaf(0x1ff)?_0x18bbaf(0x22e):_0x52fc2a==='FAILED'?_0x18bbaf(0x1b2):_0x52fc2a===_0x18bbaf(0x252)?_0x18bbaf(0x1b2):_0x18bbaf(0x209);if(!_0x28cd81['webhookEvents']?.[_0x18bbaf(0x263)](_0x15a726)){console[_0x18bbaf(0x21c)](_0x18bbaf(0x1af)+_0x15a726+'\x20not\x20enabled\x20for\x20shop\x20'+_0xdf5429['id']);return;}const _0x2ca23f={'event':_0x15a726,'payment':{'id':_0x2d63e7['id'],'order_id':_0x2d63e7[_0x18bbaf(0x197)],'gateway_order_id':_0x2d63e7[_0x18bbaf(0x259)],'gateway':_0x18bbaf(0x1ab),'amount':_0x2d63e7[_0x18bbaf(0x235)],'currency':_0x2d63e7['currency'],'status':_0x52fc2a[_0x18bbaf(0x25b)](),'customer_email':_0x2d63e7[_0x18bbaf(0x1ba)],'customer_name':_0x2d63e7[_0x18bbaf(0x267)],'created_at':_0x2d63e7['createdAt'],'updated_at':new Date()}},_0x48e88f=await fetch(_0x28cd81[_0x18bbaf(0x223)],{'method':'POST','headers':{'Content-Type':_0x18bbaf(0x1b7),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x18bbaf(0x1f1)](_0x2ca23f)}),_0x520ac9=Date['now']()-_0x4c0a0c,_0x13de34=_0x48e88f['ok']?_0x18bbaf(0x218):await _0x48e88f['text']();loggerService_1[_0x18bbaf(0x1a0)][_0x18bbaf(0x189)](_0x2d63e7[_0x18bbaf(0x24b)],_0x28cd81[_0x18bbaf(0x223)],_0x15a726,_0x48e88f[_0x18bbaf(0x25e)],_0x520ac9,_0x2ca23f),console[_0x18bbaf(0x21c)](_0x18bbaf(0x1a1)+_0x28cd81[_0x18bbaf(0x223)]+'\x20with\x20status\x20'+_0x48e88f[_0x18bbaf(0x25e)]+'\x20('+_0x520ac9+_0x18bbaf(0x1c2));}catch(_0x3fc552){console['error'](_0x18bbaf(0x184),_0x3fc552),loggerService_1[_0x18bbaf(0x1a0)]['logShopWebhookError'](_0x2d63e7[_0x18bbaf(0x24b)],_0x2d63e7[_0x18bbaf(0x26d)]?.[_0x18bbaf(0x1cc)]?.['webhookUrl']||_0x18bbaf(0x239),_0x18bbaf(0x25a),_0x3fc552,{});}}async[a37_0x201314(0x1b0)](_0x4c40d8,_0x35d80a){const _0x184015=a37_0x201314;try{const _0x2e4a54={'PENDING':_0x184015(0x1ec),'PAID':_0x184015(0x1a8),'FAILED':_0x184015(0x1b3),'EXPIRED':_0x184015(0x1e5)},_0x58c01b=_0x2e4a54[_0x35d80a];if(!_0x58c01b||_0x58c01b===_0x184015(0x1ec))return;await telegramBotService_1[_0x184015(0x1e4)]['sendPaymentNotification'](_0x4c40d8[_0x184015(0x24b)],_0x4c40d8,_0x58c01b);}catch(_0x5b572b){console[_0x184015(0x1d4)](_0x184015(0x237),_0x5b572b);}}async[a37_0x201314(0x19a)](_0x15f330){const _0x563c61=a37_0x201314;console[_0x563c61(0x21c)](_0x563c61(0x221)+_0x15f330);const _0x47d15d=await database_1[_0x563c61(0x200)][_0x563c61(0x1d8)][_0x563c61(0x18e)]({'where':{'id':_0x15f330},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x47d15d)throw new Error(_0x563c61(0x1ae));if(_0x47d15d[_0x563c61(0x270)]!=='cointopay')throw new Error(_0x563c61(0x21e));console[_0x563c61(0x21c)](_0x563c61(0x265)+_0x15f330),await this[_0x563c61(0x248)](_0x47d15d),console[_0x563c61(0x21c)](_0x563c61(0x1d3)+_0x15f330);}[a37_0x201314(0x1f4)](){const _0x26bf07=a37_0x201314,_0x30cbc5=this['globalCheckInterval']?this[_0x26bf07(0x1dd)]:undefined,_0x4969b7=Array[_0x26bf07(0x205)](this[_0x26bf07(0x1ef)][_0x26bf07(0x1c5)]())['map'](_0x2c917a=>({'paymentId':_0x2c917a[_0x26bf07(0x26c)],'gatewayPaymentId':_0x2c917a[_0x26bf07(0x19f)],'createdAt':_0x2c917a[_0x26bf07(0x233)],'timersCount':_0x2c917a[_0x26bf07(0x1fa)]['length']}));return{'isActive':!!this[_0x26bf07(0x20d)],'globalCheckIntervalMinutes':this[_0x26bf07(0x1dd)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x26bf07(0x1ef)][_0x26bf07(0x1de)],'nextGlobalCheckIn':_0x30cbc5,'paymentTimersDetails':_0x4969b7};}[a37_0x201314(0x255)](_0x291fc7){const _0x5276e9=a37_0x201314,_0x106ded=this[_0x5276e9(0x1ef)][_0x5276e9(0x1f9)](_0x291fc7);if(_0x106ded)return{'hasTimers':!![],'timersCount':_0x106ded[_0x5276e9(0x1fa)]['length'],'createdAt':_0x106ded[_0x5276e9(0x233)],'gatewayPaymentId':_0x106ded[_0x5276e9(0x19f)]};return{'hasTimers':![]};}}exports[a37_0x201314(0x18b)]=CoinToPayStatusService,exports[a37_0x201314(0x211)]=new CoinToPayStatusService();