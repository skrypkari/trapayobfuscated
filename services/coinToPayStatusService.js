'use strict';const a42_0x1466b9=a42_0x3dcd;(function(_0x5edd3c,_0x2b5d33){const _0x5bd2df=a42_0x3dcd,_0x26ffce=_0x5edd3c();while(!![]){try{const _0x5d8a61=-parseInt(_0x5bd2df(0x25a))/0x1+parseInt(_0x5bd2df(0x2e7))/0x2*(parseInt(_0x5bd2df(0x2ee))/0x3)+-parseInt(_0x5bd2df(0x243))/0x4+parseInt(_0x5bd2df(0x2df))/0x5*(-parseInt(_0x5bd2df(0x234))/0x6)+parseInt(_0x5bd2df(0x2d9))/0x7*(-parseInt(_0x5bd2df(0x20c))/0x8)+-parseInt(_0x5bd2df(0x23c))/0x9*(-parseInt(_0x5bd2df(0x230))/0xa)+-parseInt(_0x5bd2df(0x1ff))/0xb*(-parseInt(_0x5bd2df(0x2f6))/0xc);if(_0x5d8a61===_0x2b5d33)break;else _0x26ffce['push'](_0x26ffce['shift']());}catch(_0xece844){_0x26ffce['push'](_0x26ffce['shift']());}}}(a42_0x56e7,0x95a62));function a42_0x56e7(){const _0x582af8=['createdOn','coinToPay2Service','\x20to\x20','\x20USDT','🔍\x20[CHECK]\x20Checking\x20','checkExpiredPayments','\x20\x20\x20-\x20GatewayPaymentId:\x20','parse','Gateway\x20','expired','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','auto_expire','update','cointopay_status_check_','\x20->\x20','getTime','convertToUSDT','not\x20found','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','forEach','checkAllPendingPayments','__esModule','\x20skipped,\x20','\x20updated\x20successfully','\x20details:','\x20status\x20changed\x20to\x20','getServiceStats','length','\x20(after\x20','\x20\x20\x20📊\x20Status:\x20','COINTOPAY_ERROR','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','EXPIRY_DAYS','defineProperty','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','📊\x20[CHECK]\x20Payment\x20','CoinToPayService','loggerService','\x20not\x20enabled\x20for\x20shop\x20','sendPaymentNotification','❌\x20[CHECK]\x20Payment\x20','\x20status:\x20','shop','timestamp','customerName','clearPaymentTimers','startPeriodicStatusCheck','message','1\x20minute','✅\x20[CHECK]\x20Payment\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20has\x20no\x20gatewayPaymentId','webhookLog',',\x20status=','\x20updated:\x20currentPayments=',',\x20gateway\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','log','payment','findMany','🧹\x20[DEBUG]\x20Clearing\x20','gatewayPaymentId','not\x20confirmed','\x20\x20\x20Amount:\x20','gatewayCommissionRate','EXPIRED','458059HEjwEo',',\x20clearing\x20individual\x20timers','createdAt','\x20has\x20no\x20gatewayPaymentId,\x20skipping','toLowerCase','currency','6145DNoWyv','sendPaymentStatusNotification','../config/database','webhookEvents','status','logShopWebhookError','✅\x20[HOURLY]\x20Payment\x20','CoinToPayStatusService','4662omtsVu','stopPeriodicStatusCheck','🛑\x20[SHUTDOWN]\x20Cleared\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','__importDefault','Unknown\x20error','globalCheckInterval','375zwnpov','\x20days','logWhiteDomainError','error','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','Payment\x20older\x20than\x20','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','21823464pvBuHM','create','PENDING','payment.success','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','unknown','🪙\x20[TIMER]\x20Individual\x20check\x20#','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','shopId','\x20status\x20from\x20','📊\x20[HOURLY]\x20Payment\x20','\x20days\x20(created\x20before\x20','confirmedOn','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','coinToPayStatusService','-day\x20timeout','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','cointopay_status_check_error','🪙\x20[GLOBAL]\x20Found\x20','gatewayOrderId','Shop\x20webhook\x20sent\x20to\x20','\x20\x20\x20📍\x20Source:\x20','toFixed','⏰\x20[GLOBAL]\x20Found\x20','paid','GLOBAL_CHECK_INTERVAL_MS','type','webhookUrl','catch','11IKXEfm','logCoinToPayStatus','./currencyService','\x20\x20\x20-\x20ShopId:\x20','\x20\x20\x20📝\x20Details:','📈\x20[COINTOPAY]\x20Payment\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','status_check','\x20is\x20older\x20than\x20','sendShopWebhook','\x20commission\x20for\x20shop\x20','gatewaySettings','setDate','8KaaPJd','failed','cointopay2','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20to\x20clear','\x20expired\x20CoinToPay\x20payments','🔄\x20[CHECK]\x20Updating\x20payment\x20','Payment\x20System/1.0','⚠️\x20[CHECK]\x20Payment\x20','getPaymentTimerInfo','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','FAILED','get','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20\x20\x20❌\x20Error:\x20','bankDetails','paymentTimers','currentPayments','\x20found:','values','delay','\x20payment\x20','CoinToPay2Service','paymentLinkId','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','customerEmail','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','description','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','ms)','amount','settings','⏰\x20[GLOBAL]\x20Payment\x20','\x20triggered\x20for\x20payment\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','643310yJPHEH','\x20checked,\x20','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','getGatewayCommission','4974mPxAfl','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','logCoinToPayError','\x20\x20\x20📝\x20Context:','📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','cointopay_auto_expired','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','81QzEdkB','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','payment.failed','transactionId','stringify','852172SeMayA','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','5\x20minutes','PAID','has','telegramBotService','\x20pending\x20CoinToPay\x20payments','\x20timers\x20for\x20payment\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20in\x20shop\x20','\x20\x20\x20Amount\x20after\x20commission:\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','from','\x20amounts\x20calculated:','push','🏦\x20[CHECK]\x20Bank\x20details\x20provided:\x20','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','Success','\x20status\x20unchanged\x20(',',\x20stopping\x20individual\x20checks','stack','application/json',':\x20type=','778693uXwyFO','default','\x20seconds\x20(','map','amountUSDT','\x20days,\x20marking\x20as\x20EXPIRED','\x20\x20\x20-\x20paymentId:\x20','Failed\x20to\x20send\x20shop\x20webhook:','floor','🪙\x20[DEBUG]\x20Creating\x20','\x20\x20\x20-\x20Amount:\x20',',\x20using\x20default\x2010%','schedule_created','created','\x20for\x20payment\x20','timers','paymentDetails',',\x20using\x20default\x20commission\x2010%','./gateways/coinToPayService','checkSinglePaymentById','text','h),\x20skipping\x20global\x20check','size','\x20current\x20status:\x20','orderId','paymentLink','\x20initial\x20timers\x20for\x20payment\x20','\x20marked\x20as\x20paid\x20at:\x20','../types/gateway','.\x20Remaining\x20active\x20timers:\x20','./telegramBotService','./gateways/coinToPay2Service','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','cointopay','schedulePaymentChecks','paidAt','💰\x20[CHECK]\x20Payment\x20','gateway','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','Webhook\x20event\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','Payment\x20not\x20found','\x20\x20\x20📅\x20Time:\x20','❌\x20[HOURLY]\x20Payment\x20','checkPaymentStatus','\x20\x20\x20-\x20Gateway:\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','⏰\x20[EXPIRY]\x20Payment\x20','toISOString','getGatewayIdByName','\x20individual\x20payment\x20timers','paymentId','now','findUnique','\x20is\x20valid\x20for\x20checking,\x20proceeding...','includes','checkSinglePayment','iban','\x20status\x20is\x20','commission'];a42_0x56e7=function(){return _0x582af8;};return a42_0x56e7();}var __importDefault=this&&this[a42_0x1466b9(0x2eb)]||function(_0x5e95b0){const _0x2cf829=a42_0x1466b9;return _0x5e95b0&&_0x5e95b0[_0x2cf829(0x2ac)]?_0x5e95b0:{'default':_0x5e95b0};};function a42_0x3dcd(_0x2a1ac6,_0x1cd290){const _0x56e765=a42_0x56e7();return a42_0x3dcd=function(_0x3dcd58,_0x7628d9){_0x3dcd58=_0x3dcd58-0x1e5;let _0x159bfc=_0x56e765[_0x3dcd58];return _0x159bfc;},a42_0x3dcd(_0x2a1ac6,_0x1cd290);}Object[a42_0x1466b9(0x2b8)](exports,a42_0x1466b9(0x2ac),{'value':!![]}),exports[a42_0x1466b9(0x1f0)]=exports[a42_0x1466b9(0x2e6)]=void 0x0;const coinToPayService_1=require(a42_0x1466b9(0x26c)),coinToPay2Service_1=require(a42_0x1466b9(0x279)),gateway_1=require(a42_0x1466b9(0x276)),database_1=__importDefault(require(a42_0x1466b9(0x2e1))),telegramBotService_1=require(a42_0x1466b9(0x278)),loggerService_1=require('./loggerService'),currencyService_1=require(a42_0x1466b9(0x201));class CoinToPayStatusService{constructor(){const _0x404d4a=a42_0x1466b9;this[_0x404d4a(0x2ed)]=null,this[_0x404d4a(0x1fb)]=0x3c*0x3c*0x3e8,this[_0x404d4a(0x2b7)]=0x5,this[_0x404d4a(0x21c)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x404d4a(0x2bb))](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x404d4a(0x222))](),console[_0x404d4a(0x2d0)]('🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}[a42_0x1466b9(0x27d)](_0x148ba8,_0x4056e6){const _0x1a29a3=a42_0x1466b9;console[_0x1a29a3(0x2d0)](_0x1a29a3(0x23f)),console['log'](_0x1a29a3(0x260)+_0x148ba8),console[_0x1a29a3(0x2d0)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x4056e6),this['clearPaymentTimers'](_0x148ba8);const _0x48255a=[],_0x57da6d=new Date(),_0x34434f=[{'delay':0x1*0x3c*0x3e8,'description':_0x1a29a3(0x2c7)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x1a29a3(0x245)},{'delay':0x5*0x3c*0x3e8,'description':_0x1a29a3(0x245)}];console[_0x1a29a3(0x2d0)](_0x1a29a3(0x263)+_0x34434f[_0x1a29a3(0x2b2)]+_0x1a29a3(0x274)+_0x148ba8);let _0x1a15e4=0x0;_0x34434f[_0x1a29a3(0x2aa)]((_0x1ed14e,_0x24b8bc)=>{const _0x2cf6d4=_0x1a29a3;_0x1a15e4+=_0x1ed14e[_0x2cf6d4(0x220)];const _0x3b5125=setTimeout(async()=>{const _0x4c286b=_0x2cf6d4;console[_0x4c286b(0x2d0)](_0x4c286b(0x1e8)+(_0x24b8bc+0x1)+_0x4c286b(0x22e)+_0x148ba8+_0x4c286b(0x2b3)+_0x1ed14e['description']+')');try{await this[_0x4c286b(0x26d)](_0x148ba8),console['log']('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x24b8bc+0x1)+'\x20completed\x20for\x20payment\x20'+_0x148ba8);}catch(_0x313039){console[_0x4c286b(0x2f1)](_0x4c286b(0x253)+(_0x24b8bc+0x1)+_0x4c286b(0x268)+_0x148ba8+':',_0x313039),this['logCoinToPayError'](_0x148ba8,_0x4056e6,_0x313039,_0x4c286b(0x206),{'checkNumber':_0x24b8bc+0x1,'scheduledAfter':_0x1ed14e[_0x4c286b(0x227)],'isIndividualCheck':!![]});}},_0x1a15e4);_0x48255a[_0x2cf6d4(0x251)](_0x3b5125),console[_0x2cf6d4(0x2d0)](_0x2cf6d4(0x1ef)+(_0x24b8bc+0x1)+_0x2cf6d4(0x268)+_0x148ba8+'\x20in\x20'+_0x1a15e4/0x3e8+_0x2cf6d4(0x25c)+_0x1ed14e[_0x2cf6d4(0x227)]+')');});const _0x236a02=setInterval(async()=>{const _0x2ea810=_0x1a29a3;console[_0x2ea810(0x2d0)]('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x148ba8);try{const _0x502947=await database_1['default'][_0x2ea810(0x2d1)][_0x2ea810(0x290)]({'where':{'id':_0x148ba8},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x502947){console[_0x2ea810(0x2d0)](_0x2ea810(0x286)+_0x148ba8+'\x20not\x20found,\x20clearing\x20timers'),this[_0x2ea810(0x2c4)](_0x148ba8);return;}console[_0x2ea810(0x2d0)](_0x2ea810(0x1ec)+_0x148ba8+_0x2ea810(0x271)+_0x502947[_0x2ea810(0x2e3)]);if(_0x502947[_0x2ea810(0x2e3)]!==_0x2ea810(0x2f8)){console['log'](_0x2ea810(0x2e5)+_0x148ba8+'\x20status\x20is\x20'+_0x502947['status']+_0x2ea810(0x256)),this['clearPaymentTimers'](_0x148ba8);return;}const _0x37a3dc=Math['floor']((Date[_0x2ea810(0x28f)]()-_0x502947[_0x2ea810(0x2db)][_0x2ea810(0x2a6)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x37a3dc>=this[_0x2ea810(0x2b7)]){console[_0x2ea810(0x2d0)]('⏰\x20[HOURLY]\x20Payment\x20'+_0x148ba8+_0x2ea810(0x207)+this[_0x2ea810(0x2b7)]+_0x2ea810(0x2c9)),this[_0x2ea810(0x2c4)](_0x148ba8);return;}await this[_0x2ea810(0x26d)](_0x148ba8),console['log'](_0x2ea810(0x1e6)+_0x148ba8);}catch(_0x53906c){console['error']('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x148ba8+':',_0x53906c),this[_0x2ea810(0x237)](_0x148ba8,_0x4056e6,_0x53906c,_0x2ea810(0x206),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x48255a[_0x1a29a3(0x251)](_0x236a02),this[_0x1a29a3(0x21c)]['set'](_0x148ba8,{'timers':_0x48255a,'paymentId':_0x148ba8,'gatewayPaymentId':_0x4056e6,'createdAt':_0x57da6d}),console[_0x1a29a3(0x2d0)](_0x1a29a3(0x22f)+_0x34434f[_0x1a29a3(0x2b2)]+_0x1a29a3(0x27b)+_0x148ba8),console['log']('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x1a29a3(0x21c)][_0x1a29a3(0x270)]),this['logCoinToPayStatus'](_0x148ba8,_0x4056e6,_0x1a29a3(0x2f8),_0x1a29a3(0x2f8),_0x1a29a3(0x206),{'action':_0x1a29a3(0x266),'scheduledChecks':_0x34434f[_0x1a29a3(0x2b2)],'firstCheckIn':_0x34434f[0x0]['delay']/0x3e8,'totalTimers':this['paymentTimers'][_0x1a29a3(0x270)]});}['clearPaymentTimers'](_0x5ebe27){const _0x4ad9e=a42_0x1466b9,_0x3794bc=this[_0x4ad9e(0x21c)][_0x4ad9e(0x218)](_0x5ebe27);_0x3794bc?(console[_0x4ad9e(0x2d0)](_0x4ad9e(0x2d3)+_0x3794bc[_0x4ad9e(0x269)][_0x4ad9e(0x2b2)]+_0x4ad9e(0x24a)+_0x5ebe27),_0x3794bc[_0x4ad9e(0x269)]['forEach']((_0xbcc76a,_0x439666)=>{const _0x1fd17b=_0x4ad9e;_0xbcc76a&&(clearTimeout(_0xbcc76a),clearInterval(_0xbcc76a),console[_0x1fd17b(0x2d0)](_0x1fd17b(0x1f2)+(_0x439666+0x1)+_0x1fd17b(0x268)+_0x5ebe27));}),this[_0x4ad9e(0x21c)]['delete'](_0x5ebe27),console[_0x4ad9e(0x2d0)](_0x4ad9e(0x219)+_0x5ebe27+_0x4ad9e(0x277)+this[_0x4ad9e(0x21c)][_0x4ad9e(0x270)])):console[_0x4ad9e(0x2d0)]('⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x5ebe27+_0x4ad9e(0x210));}async[a42_0x1466b9(0x26d)](_0x5c7e57){const _0x118f61=a42_0x1466b9;console[_0x118f61(0x2d0)](_0x118f61(0x2f5)+_0x5c7e57);const _0xc0ecb2=await database_1[_0x118f61(0x25b)][_0x118f61(0x2d1)]['findUnique']({'where':{'id':_0x5c7e57},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xc0ecb2){console[_0x118f61(0x2d0)](_0x118f61(0x2bf)+_0x5c7e57+'\x20not\x20found\x20in\x20database');return;}console[_0x118f61(0x2d0)]('📊\x20[CHECK]\x20Payment\x20'+_0x5c7e57+_0x118f61(0x21e)),console[_0x118f61(0x2d0)](_0x118f61(0x288)+_0xc0ecb2[_0x118f61(0x280)]),console[_0x118f61(0x2d0)]('\x20\x20\x20-\x20Status:\x20'+_0xc0ecb2[_0x118f61(0x2e3)]),console['log'](_0x118f61(0x29d)+_0xc0ecb2[_0x118f61(0x2d4)]),console[_0x118f61(0x2d0)](_0x118f61(0x264)+_0xc0ecb2[_0x118f61(0x22b)]+'\x20'+_0xc0ecb2[_0x118f61(0x2de)]),console['log'](_0x118f61(0x202)+_0xc0ecb2[_0x118f61(0x1ea)]);if(_0xc0ecb2[_0x118f61(0x280)]!==_0x118f61(0x27c)&&_0xc0ecb2[_0x118f61(0x280)]!==_0x118f61(0x20e)){console[_0x118f61(0x2d0)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x5c7e57+_0x118f61(0x23b)+_0xc0ecb2[_0x118f61(0x280)]+')');return;}if(_0xc0ecb2['status']!==_0x118f61(0x2f8)){console[_0x118f61(0x2d0)](_0x118f61(0x214)+_0x5c7e57+_0x118f61(0x295)+_0xc0ecb2[_0x118f61(0x2e3)]+',\x20stopping\x20individual\x20checks'),this[_0x118f61(0x2c4)](_0x5c7e57);return;}if(!_0xc0ecb2[_0x118f61(0x2d4)]){console[_0x118f61(0x2d0)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x5c7e57+_0x118f61(0x2ca));return;}console[_0x118f61(0x2d0)](_0x118f61(0x2c8)+_0x5c7e57+_0x118f61(0x291)),await this[_0x118f61(0x293)](_0xc0ecb2);}[a42_0x1466b9(0x200)](_0x47da95,_0x5f1ce3,_0x5397b1,_0x3bbeb0,_0x4cc205,_0x104a6f){const _0x58fd18=a42_0x1466b9,_0x58a666={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x47da95,'gatewayPaymentId':_0x5f1ce3,'oldStatus':_0x5397b1,'newStatus':_0x3bbeb0,'source':_0x4cc205,'timestamp':new Date()[_0x58fd18(0x28b)](),'details':_0x104a6f||{}};loggerService_1[_0x58fd18(0x2bc)]['logCoinToPayStatus'](_0x58a666),console[_0x58fd18(0x2d0)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x47da95+'\x20('+_0x5f1ce3+')'),console['log'](_0x58fd18(0x2b4)+_0x5397b1+_0x58fd18(0x2a5)+_0x3bbeb0),console[_0x58fd18(0x2d0)]('\x20\x20\x20📍\x20Source:\x20'+_0x4cc205),console[_0x58fd18(0x2d0)](_0x58fd18(0x285)+_0x58a666['timestamp']),_0x104a6f&&console[_0x58fd18(0x2d0)](_0x58fd18(0x203),_0x104a6f);}[a42_0x1466b9(0x237)](_0x27d214,_0x55d305,_0x5bd0ca,_0x5b23a1,_0x37d148){const _0x404bd1=a42_0x1466b9,_0x46d35d={'type':_0x404bd1(0x2b5),'paymentId':_0x27d214,'gatewayPaymentId':_0x55d305,'error':_0x5bd0ca instanceof Error?{'message':_0x5bd0ca[_0x404bd1(0x2c6)],'stack':_0x5bd0ca[_0x404bd1(0x257)]}:_0x5bd0ca,'source':_0x5b23a1,'timestamp':new Date()[_0x404bd1(0x28b)](),'context':_0x37d148||{}};loggerService_1['loggerService']['logCoinToPayError'](_0x46d35d),console[_0x404bd1(0x2f1)](_0x404bd1(0x20f)+_0x27d214+'\x20('+_0x55d305+')'),console[_0x404bd1(0x2f1)](_0x404bd1(0x21a)+(_0x5bd0ca instanceof Error?_0x5bd0ca[_0x404bd1(0x2c6)]:_0x5bd0ca)),console['error'](_0x404bd1(0x1f7)+_0x5b23a1),console[_0x404bd1(0x2f1)](_0x404bd1(0x285)+_0x46d35d[_0x404bd1(0x2c2)]),_0x37d148&&console[_0x404bd1(0x2f1)](_0x404bd1(0x238),_0x37d148);}[a42_0x1466b9(0x2c5)](){const _0x4a9d5a=a42_0x1466b9;console[_0x4a9d5a(0x2d0)](_0x4a9d5a(0x205)),this['checkAllPendingPayments']()[_0x4a9d5a(0x1fe)](_0x571de3=>{console['error']('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x571de3);}),this[_0x4a9d5a(0x2ed)]=setInterval(async()=>{const _0x3994a2=_0x4a9d5a;try{console[_0x3994a2(0x2d0)](_0x3994a2(0x229)),await this[_0x3994a2(0x2ab)](),console[_0x3994a2(0x2d0)]('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x29d820){console[_0x3994a2(0x2f1)](_0x3994a2(0x24b),_0x29d820);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x4a9d5a(0x2d0)](_0x4a9d5a(0x23d));}[a42_0x1466b9(0x2e8)](){const _0x113988=a42_0x1466b9;console[_0x113988(0x2d0)](_0x113988(0x2b6));this[_0x113988(0x2ed)]&&(clearInterval(this[_0x113988(0x2ed)]),this[_0x113988(0x2ed)]=null,console[_0x113988(0x2d0)](_0x113988(0x232)));const _0x133266=this[_0x113988(0x21c)][_0x113988(0x270)];for(const [_0x8947ed]of this[_0x113988(0x21c)]){this[_0x113988(0x2c4)](_0x8947ed);}console[_0x113988(0x2d0)](_0x113988(0x2e9)+_0x133266+_0x113988(0x28d));}async[a42_0x1466b9(0x2ab)](){const _0x7b6062=a42_0x1466b9;try{console[_0x7b6062(0x2d0)](_0x7b6062(0x2ea));const _0x9bcd5e=await database_1['default']['payment'][_0x7b6062(0x2d2)]({'where':{'gateway':{'in':['cointopay',_0x7b6062(0x20e)]},'status':_0x7b6062(0x2f8),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x7b6062(0x2d0)](_0x7b6062(0x1f4)+_0x9bcd5e[_0x7b6062(0x2b2)]+_0x7b6062(0x249));if(_0x9bcd5e[_0x7b6062(0x2b2)]===0x0){console['log']('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x3c8bbe=await this[_0x7b6062(0x29c)](_0x9bcd5e);console['log'](_0x7b6062(0x1f9)+_0x3c8bbe[_0x7b6062(0x2b2)]+_0x7b6062(0x211));let _0x2e9a93=0x0,_0x4c79b3=0x0;for(const _0x51eb58 of _0x9bcd5e){try{if(_0x3c8bbe[_0x7b6062(0x292)](_0x51eb58['id'])){console[_0x7b6062(0x2d0)](_0x7b6062(0x22d)+_0x51eb58['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x4c79b3++;continue;}if(this[_0x7b6062(0x21c)][_0x7b6062(0x247)](_0x51eb58['id'])){console['log'](_0x7b6062(0x22d)+_0x51eb58['id']+_0x7b6062(0x235)),_0x4c79b3++;continue;}const _0x205b2f=(Date[_0x7b6062(0x28f)]()-_0x51eb58[_0x7b6062(0x2db)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x205b2f<0x1){console[_0x7b6062(0x2d0)](_0x7b6062(0x22d)+_0x51eb58['id']+'\x20is\x20too\x20new\x20('+_0x205b2f[_0x7b6062(0x1f8)](0x1)+_0x7b6062(0x26f)),_0x4c79b3++;continue;}console[_0x7b6062(0x2d0)](_0x7b6062(0x228)+_0x51eb58['id']+'\x20(age:\x20'+_0x205b2f[_0x7b6062(0x1f8)](0x1)+'h)'),await this[_0x7b6062(0x293)](_0x51eb58),_0x2e9a93++,await new Promise(_0x5ba3eb=>setTimeout(_0x5ba3eb,0x7d0));}catch(_0xba32ea){console[_0x7b6062(0x2f1)](_0x7b6062(0x216)+_0x51eb58['id']+':',_0xba32ea),this[_0x7b6062(0x237)](_0x51eb58['id'],_0x51eb58[_0x7b6062(0x2d4)]||_0x7b6062(0x1e7),_0xba32ea,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x51eb58[_0x7b6062(0x22b)],'paymentCurrency':_0x51eb58['currency'],'shopId':_0x51eb58[_0x7b6062(0x1ea)],'createdAt':_0x51eb58['createdAt']}),loggerService_1[_0x7b6062(0x2bc)][_0x7b6062(0x2f0)](_0x7b6062(0x27c),'/status/'+_0x51eb58[_0x7b6062(0x2d4)],_0xba32ea);}}console[_0x7b6062(0x2d0)](_0x7b6062(0x224)+_0x2e9a93+_0x7b6062(0x231)+_0x4c79b3+_0x7b6062(0x2ad)+_0x3c8bbe[_0x7b6062(0x2b2)]+'\x20expired');}catch(_0x407001){console[_0x7b6062(0x2f1)](_0x7b6062(0x27a),_0x407001);}}async[a42_0x1466b9(0x29c)](_0x3b4f70){const _0x215e74=a42_0x1466b9,_0x35243e=[],_0x22242=new Date();_0x22242[_0x215e74(0x20b)](_0x22242['getDate']()-this[_0x215e74(0x2b7)]),console['log'](_0x215e74(0x236)+this[_0x215e74(0x2b7)]+_0x215e74(0x1ed)+_0x22242[_0x215e74(0x28b)]()+')');for(const _0x1dcb76 of _0x3b4f70){if(_0x1dcb76[_0x215e74(0x2db)]<_0x22242){console[_0x215e74(0x2d0)](_0x215e74(0x28a)+_0x1dcb76['id']+'\x20is\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x215e74(0x25f));try{this['logCoinToPayStatus'](_0x1dcb76['id'],_0x1dcb76[_0x215e74(0x2d4)]||_0x215e74(0x1e7),_0x215e74(0x2f8),_0x215e74(0x2d8),_0x215e74(0x2a2),{'reason':_0x215e74(0x2f3)+this['EXPIRY_DAYS']+_0x215e74(0x2ef),'createdAt':_0x1dcb76['createdAt'],'daysSinceCreation':Math[_0x215e74(0x262)]((Date['now']()-_0x1dcb76['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x1dcb76[_0x215e74(0x22b)],'paymentCurrency':_0x1dcb76[_0x215e74(0x2de)],'shopId':_0x1dcb76[_0x215e74(0x1ea)]}),await database_1['default'][_0x215e74(0x2d1)]['update']({'where':{'id':_0x1dcb76['id']},'data':{'status':_0x215e74(0x2d8),'updatedAt':new Date()}}),await database_1[_0x215e74(0x25b)][_0x215e74(0x2cb)][_0x215e74(0x2f7)]({'data':{'paymentId':_0x1dcb76['id'],'shopId':_0x1dcb76[_0x215e74(0x1ea)],'event':_0x215e74(0x23a),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x215e74(0x2f3)+this[_0x215e74(0x2b7)]+_0x215e74(0x2ef),'createdAt':_0x1dcb76[_0x215e74(0x2db)],'expiredAt':new Date()[_0x215e74(0x28b)](),'daysSinceCreation':Math[_0x215e74(0x262)]((Date['now']()-_0x1dcb76[_0x215e74(0x2db)][_0x215e74(0x2a6)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x215e74(0x208)](_0x1dcb76,_0x215e74(0x2d8)),await this['sendPaymentStatusNotification'](_0x1dcb76,_0x215e74(0x2d8)),this['clearPaymentTimers'](_0x1dcb76['id']),_0x35243e[_0x215e74(0x251)](_0x1dcb76['id']),console['log']('✅\x20[EXPIRY]\x20Payment\x20'+_0x1dcb76['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this['EXPIRY_DAYS']+_0x215e74(0x1f1));}catch(_0x194182){console[_0x215e74(0x2f1)](_0x215e74(0x2f2)+_0x1dcb76['id']+':',_0x194182),this[_0x215e74(0x237)](_0x1dcb76['id'],_0x1dcb76[_0x215e74(0x2d4)]||'unknown',_0x194182,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x1dcb76[_0x215e74(0x2db)],'daysSinceCreation':Math[_0x215e74(0x262)]((Date[_0x215e74(0x28f)]()-_0x1dcb76[_0x215e74(0x2db)][_0x215e74(0x2a6)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x35243e;}async['checkSinglePayment'](_0x435b4a){const _0x14d03e=a42_0x1466b9;if(!_0x435b4a[_0x14d03e(0x2d4)]){console[_0x14d03e(0x2d0)](_0x14d03e(0x214)+_0x435b4a['id']+_0x14d03e(0x2dc));return;}console['log'](_0x14d03e(0x29b)+_0x435b4a[_0x14d03e(0x280)]+'\x20payment\x20'+_0x435b4a['id']+'\x20('+_0x435b4a[_0x14d03e(0x2d4)]+')');try{let _0x571d4c;_0x435b4a[_0x14d03e(0x280)]==='cointopay2'?(_0x571d4c=await this[_0x14d03e(0x298)]['checkPaymentStatus'](_0x435b4a[_0x14d03e(0x2d4)]),console[_0x14d03e(0x2d0)](_0x14d03e(0x2a1)+_0x435b4a['id']+'\x20status:\x20'+_0x571d4c['status'])):(_0x571d4c=await this['coinToPayService'][_0x14d03e(0x287)](_0x435b4a[_0x14d03e(0x2d4)]),console[_0x14d03e(0x2d0)](_0x14d03e(0x2f4)+_0x435b4a['id']+_0x14d03e(0x2c0)+_0x571d4c[_0x14d03e(0x2e3)]));_0x571d4c[_0x14d03e(0x26a)]&&console[_0x14d03e(0x2d0)](_0x14d03e(0x2ba)+_0x435b4a['id']+_0x14d03e(0x2af),{'iban':_0x571d4c[_0x14d03e(0x26a)][_0x14d03e(0x294)]||_0x14d03e(0x2a8),'transactionId':_0x571d4c[_0x14d03e(0x26a)]['transactionId'],'createdOn':_0x571d4c[_0x14d03e(0x26a)][_0x14d03e(0x297)],'confirmedOn':_0x571d4c[_0x14d03e(0x26a)][_0x14d03e(0x1ee)]||_0x14d03e(0x2d5)});if(_0x571d4c[_0x14d03e(0x2e3)]!==_0x435b4a['status']){console['log'](_0x14d03e(0x212)+_0x435b4a['id']+_0x14d03e(0x1eb)+_0x435b4a[_0x14d03e(0x2e3)]+_0x14d03e(0x299)+_0x571d4c['status']),this[_0x14d03e(0x200)](_0x435b4a['id'],_0x435b4a['gatewayPaymentId'],_0x435b4a['status'],_0x571d4c[_0x14d03e(0x2e3)],_0x14d03e(0x206),{'paymentDetails':_0x571d4c[_0x14d03e(0x26a)],'amount':_0x571d4c[_0x14d03e(0x22b)],'currency':_0x571d4c[_0x14d03e(0x2de)],'shopId':_0x435b4a[_0x14d03e(0x1ea)],'checkTimestamp':new Date()[_0x14d03e(0x28b)]()});const _0xd68a99={'status':_0x571d4c[_0x14d03e(0x2e3)],'updatedAt':new Date()};if(_0x571d4c['status']===_0x14d03e(0x246)&&_0x435b4a['status']!==_0x14d03e(0x246)){_0xd68a99[_0x14d03e(0x27e)]=new Date();if(!_0x435b4a[_0x14d03e(0x25e)]){const _0x2a1a84=await currencyService_1['currencyService'][_0x14d03e(0x2a7)](_0x435b4a['amount'],_0x435b4a['currency']);_0xd68a99['amountUSDT']=_0x2a1a84;const _0x406936=await this[_0x14d03e(0x233)](_0x435b4a['shopId'],_0x435b4a[_0x14d03e(0x280)]),_0x3068bf=_0x2a1a84*(0x1-_0x406936/0x64);_0xd68a99['amountAfterGatewayCommissionUSDT']=_0x3068bf,_0xd68a99[_0x14d03e(0x2d7)]=_0x406936,console[_0x14d03e(0x2d0)](_0x14d03e(0x27f)+_0x435b4a['id']+_0x14d03e(0x250)),console[_0x14d03e(0x2d0)](_0x14d03e(0x2d6)+_0x435b4a[_0x14d03e(0x22b)]+'\x20'+_0x435b4a[_0x14d03e(0x2de)]+_0x14d03e(0x2a5)+_0x2a1a84[_0x14d03e(0x1f8)](0x6)+_0x14d03e(0x29a)),console[_0x14d03e(0x2d0)]('\x20\x20\x20Gateway\x20'+_0x435b4a[_0x14d03e(0x280)]+'\x20commission:\x20'+_0x406936+'%'),console['log'](_0x14d03e(0x24d)+_0x3068bf[_0x14d03e(0x1f8)](0x6)+_0x14d03e(0x29a));}console[_0x14d03e(0x2d0)](_0x14d03e(0x27f)+_0x435b4a['id']+_0x14d03e(0x275)+_0xd68a99[_0x14d03e(0x27e)][_0x14d03e(0x28b)]());}if(_0x571d4c[_0x14d03e(0x26a)]){const _0x447e50=_0x571d4c[_0x14d03e(0x26a)];_0x447e50[_0x14d03e(0x294)]&&(_0xd68a99['remitterIban']=_0x447e50[_0x14d03e(0x294)],console['log'](_0x14d03e(0x226)+_0x447e50['iban'])),_0x447e50[_0x14d03e(0x21b)]&&console[_0x14d03e(0x2d0)](_0x14d03e(0x252)+_0x447e50['bankDetails']),_0x447e50['transactionId']&&console[_0x14d03e(0x2d0)]('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x447e50[_0x14d03e(0x241)]),_0x447e50['confirmedOn']&&console[_0x14d03e(0x2d0)](_0x14d03e(0x23e)+_0x447e50[_0x14d03e(0x1ee)]);}await database_1[_0x14d03e(0x25b)][_0x14d03e(0x2d1)][_0x14d03e(0x2a3)]({'where':{'id':_0x435b4a['id']},'data':_0xd68a99});if(_0x571d4c['status']===_0x14d03e(0x246)&&_0x435b4a['status']!=='PAID'){console[_0x14d03e(0x2d0)](_0x14d03e(0x204)+_0x435b4a['id']+_0x14d03e(0x2a9));const _0x4eb751=await database_1[_0x14d03e(0x25b)][_0x14d03e(0x2d1)][_0x14d03e(0x290)]({'where':{'id':_0x435b4a['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x4eb751?.[_0x14d03e(0x223)]&&_0x4eb751[_0x14d03e(0x273)])try{const _0x48e248=_0x4eb751[_0x14d03e(0x273)];console[_0x14d03e(0x2d0)](_0x14d03e(0x239)+_0x48e248['id']+_0x14d03e(0x259)+_0x48e248[_0x14d03e(0x1fc)]+',\x20currentPayments='+_0x48e248['currentPayments']+_0x14d03e(0x2cc)+_0x48e248['status']);const _0x10300=_0x48e248['currentPayments']+0x1,_0x349648=_0x48e248[_0x14d03e(0x1fc)]==='SINGLE'?'COMPLETED':_0x48e248[_0x14d03e(0x2e3)];await database_1[_0x14d03e(0x25b)][_0x14d03e(0x273)][_0x14d03e(0x2a3)]({'where':{'id':_0x48e248['id']},'data':{'currentPayments':_0x10300,'status':_0x349648,'updatedAt':new Date()}}),console[_0x14d03e(0x2d0)]('✅\x20[COINTOPAY]\x20Payment\x20link\x20'+_0x48e248['id']+_0x14d03e(0x2cd)+_0x48e248[_0x14d03e(0x21d)]+_0x14d03e(0x2a5)+_0x10300+_0x14d03e(0x2cc)+_0x48e248[_0x14d03e(0x2e3)]+_0x14d03e(0x2a5)+_0x349648);}catch(_0x385613){console['error']('❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:',_0x385613);}else console[_0x14d03e(0x2d0)](_0x14d03e(0x204)+_0x435b4a['id']+_0x14d03e(0x281));}await database_1[_0x14d03e(0x25b)][_0x14d03e(0x2cb)][_0x14d03e(0x2f7)]({'data':{'paymentId':_0x435b4a['id'],'shopId':_0x435b4a[_0x14d03e(0x1ea)],'event':_0x14d03e(0x2a4)+_0x571d4c['status'][_0x14d03e(0x2dd)](),'statusCode':0xc8,'responseBody':JSON[_0x14d03e(0x242)]({'oldStatus':_0x435b4a['status'],'newStatus':_0x571d4c['status'],'paymentDetails':_0x571d4c[_0x14d03e(0x26a)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x14d03e(0x208)](_0x435b4a,_0x571d4c[_0x14d03e(0x2e3)]),await this[_0x14d03e(0x2e0)](_0x435b4a,_0x571d4c[_0x14d03e(0x2e3)]),_0x571d4c[_0x14d03e(0x2e3)]!=='PENDING'&&(console[_0x14d03e(0x2d0)]('🧹\x20[CHECK]\x20Payment\x20'+_0x435b4a['id']+_0x14d03e(0x2b0)+_0x571d4c[_0x14d03e(0x2e3)]+_0x14d03e(0x2da)),this[_0x14d03e(0x2c4)](_0x435b4a['id'])),console[_0x14d03e(0x2d0)](_0x14d03e(0x2c8)+_0x435b4a['id']+_0x14d03e(0x2ae));}else console[_0x14d03e(0x2d0)](_0x14d03e(0x2ba)+_0x435b4a['id']+_0x14d03e(0x255)+_0x571d4c[_0x14d03e(0x2e3)]+')'),this[_0x14d03e(0x200)](_0x435b4a['id'],_0x435b4a[_0x14d03e(0x2d4)],_0x435b4a['status'],_0x571d4c['status'],_0x14d03e(0x206),{'statusUnchanged':!![],'paymentDetails':_0x571d4c[_0x14d03e(0x26a)],'amount':_0x571d4c[_0x14d03e(0x22b)],'currency':_0x571d4c[_0x14d03e(0x2de)],'shopId':_0x435b4a[_0x14d03e(0x1ea)],'checkTimestamp':new Date()[_0x14d03e(0x28b)]()});}catch(_0x2ba1a2){console[_0x14d03e(0x2f1)](_0x14d03e(0x2cf)+_0x435b4a['id']+':',_0x2ba1a2),this[_0x14d03e(0x237)](_0x435b4a['id'],_0x435b4a['gatewayPaymentId'],_0x2ba1a2,_0x14d03e(0x206),{'paymentAmount':_0x435b4a[_0x14d03e(0x22b)],'paymentCurrency':_0x435b4a[_0x14d03e(0x2de)],'shopId':_0x435b4a['shopId'],'createdAt':_0x435b4a[_0x14d03e(0x2db)]}),await database_1[_0x14d03e(0x25b)][_0x14d03e(0x2cb)][_0x14d03e(0x2f7)]({'data':{'paymentId':_0x435b4a['id'],'shopId':_0x435b4a[_0x14d03e(0x1ea)],'event':_0x14d03e(0x1f3),'statusCode':0x1f4,'responseBody':JSON[_0x14d03e(0x242)]({'error':_0x2ba1a2 instanceof Error?_0x2ba1a2[_0x14d03e(0x2c6)]:_0x14d03e(0x2ec),'gatewayPaymentId':_0x435b4a[_0x14d03e(0x2d4)],'checkedAt':new Date()[_0x14d03e(0x28b)]()})}});}}async['sendShopWebhook'](_0x1a05af,_0x1bd3ff){const _0x5c511b=a42_0x1466b9,_0x51fa3a=Date[_0x5c511b(0x28f)]();try{const _0x23bdca=_0x1a05af[_0x5c511b(0x2c1)],_0x5adcbc=_0x23bdca[_0x5c511b(0x22c)];if(!_0x5adcbc?.[_0x5c511b(0x1fd)]){console[_0x5c511b(0x2d0)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x23bdca['id']);return;}const _0x219541=_0x1bd3ff==='PAID'?_0x5c511b(0x1e5):_0x1bd3ff===_0x5c511b(0x217)?_0x5c511b(0x240):_0x1bd3ff===_0x5c511b(0x2d8)?'payment.failed':'payment.pending';if(!_0x5adcbc[_0x5c511b(0x2e2)]?.[_0x5c511b(0x292)](_0x219541)){console[_0x5c511b(0x2d0)](_0x5c511b(0x282)+_0x219541+_0x5c511b(0x2bd)+_0x23bdca['id']);return;}const _0x2af007=(0x0,gateway_1[_0x5c511b(0x28c)])(_0x1a05af['gateway'])||_0x1a05af[_0x5c511b(0x280)],_0x3dee19={'event':_0x219541,'payment':{'id':_0x1a05af['id'],'order_id':_0x1a05af[_0x5c511b(0x272)],'gateway_order_id':_0x1a05af[_0x5c511b(0x1f5)],'gateway':_0x2af007,'amount':_0x1a05af[_0x5c511b(0x22b)],'currency':_0x1a05af['currency'],'status':_0x1bd3ff[_0x5c511b(0x2dd)](),'customer_email':_0x1a05af[_0x5c511b(0x225)],'customer_name':_0x1a05af[_0x5c511b(0x2c3)],'created_at':_0x1a05af['createdAt'],'updated_at':new Date()}},_0x1e4a86=await fetch(_0x5adcbc[_0x5c511b(0x1fd)],{'method':'POST','headers':{'Content-Type':_0x5c511b(0x258),'User-Agent':_0x5c511b(0x213)},'body':JSON[_0x5c511b(0x242)](_0x3dee19)}),_0x1f8b67=Date['now']()-_0x51fa3a,_0x52670c=_0x1e4a86['ok']?_0x5c511b(0x254):await _0x1e4a86[_0x5c511b(0x26e)]();loggerService_1[_0x5c511b(0x2bc)]['logShopWebhookSent'](_0x1a05af[_0x5c511b(0x1ea)],_0x5adcbc[_0x5c511b(0x1fd)],_0x219541,_0x1e4a86['status'],_0x1f8b67,_0x3dee19),console[_0x5c511b(0x2d0)](_0x5c511b(0x1f6)+_0x5adcbc[_0x5c511b(0x1fd)]+'\x20with\x20status\x20'+_0x1e4a86['status']+'\x20('+_0x1f8b67+_0x5c511b(0x22a));}catch(_0x58193d){console[_0x5c511b(0x2f1)](_0x5c511b(0x261),_0x58193d),loggerService_1[_0x5c511b(0x2bc)][_0x5c511b(0x2e4)](_0x1a05af['shopId'],_0x1a05af[_0x5c511b(0x2c1)]?.[_0x5c511b(0x22c)]?.[_0x5c511b(0x1fd)]||'unknown','webhook_send',_0x58193d,{});}}async[a42_0x1466b9(0x2e0)](_0x2f894a,_0x3d2265){const _0xcbb60b=a42_0x1466b9;try{const _0x21467d={'PENDING':_0xcbb60b(0x267),'PAID':_0xcbb60b(0x1fa),'FAILED':_0xcbb60b(0x20d),'EXPIRED':_0xcbb60b(0x2a0)},_0x37129d=_0x21467d[_0x3d2265];if(!_0x37129d||_0x37129d===_0xcbb60b(0x267))return;await telegramBotService_1[_0xcbb60b(0x248)][_0xcbb60b(0x2be)](_0x2f894a[_0xcbb60b(0x1ea)],_0x2f894a,_0x37129d);}catch(_0x2ed186){console[_0xcbb60b(0x2f1)](_0xcbb60b(0x244),_0x2ed186);}}async['checkPaymentById'](_0x43de49){const _0x45af99=a42_0x1466b9;console[_0x45af99(0x2d0)](_0x45af99(0x283)+_0x43de49);const _0x2d95d0=await database_1['default'][_0x45af99(0x2d1)][_0x45af99(0x290)]({'where':{'id':_0x43de49},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2d95d0)throw new Error(_0x45af99(0x284));if(_0x2d95d0[_0x45af99(0x280)]!==_0x45af99(0x27c)&&_0x2d95d0[_0x45af99(0x280)]!==_0x45af99(0x20e))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x45af99(0x2d0)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20'+_0x2d95d0[_0x45af99(0x280)]+_0x45af99(0x221)+_0x43de49),await this[_0x45af99(0x293)](_0x2d95d0),console[_0x45af99(0x2d0)](_0x45af99(0x289)+_0x43de49);}[a42_0x1466b9(0x2b1)](){const _0x4163ac=a42_0x1466b9,_0x105581=this['globalCheckInterval']?this[_0x4163ac(0x1fb)]:undefined,_0x3ed8ca=Array[_0x4163ac(0x24f)](this['paymentTimers'][_0x4163ac(0x21f)]())[_0x4163ac(0x25d)](_0x396a0f=>({'paymentId':_0x396a0f[_0x4163ac(0x28e)],'gatewayPaymentId':_0x396a0f[_0x4163ac(0x2d4)],'createdAt':_0x396a0f[_0x4163ac(0x2db)],'timersCount':_0x396a0f[_0x4163ac(0x269)][_0x4163ac(0x2b2)]}));return{'isActive':!!this[_0x4163ac(0x2ed)],'globalCheckIntervalMinutes':this[_0x4163ac(0x1fb)]/(0x3e8*0x3c),'expiryDays':this[_0x4163ac(0x2b7)],'activeIndividualTimers':this[_0x4163ac(0x21c)][_0x4163ac(0x270)],'nextGlobalCheckIn':_0x105581,'paymentTimersDetails':_0x3ed8ca};}[a42_0x1466b9(0x215)](_0x141201){const _0x1ab319=a42_0x1466b9,_0x3d0883=this[_0x1ab319(0x21c)][_0x1ab319(0x218)](_0x141201);if(_0x3d0883)return{'hasTimers':!![],'timersCount':_0x3d0883[_0x1ab319(0x269)][_0x1ab319(0x2b2)],'createdAt':_0x3d0883['createdAt'],'gatewayPaymentId':_0x3d0883['gatewayPaymentId']};return{'hasTimers':![]};}async['getGatewayCommission'](_0x1c98e4,_0x426607){const _0x17fa09=a42_0x1466b9;try{const _0x2cb024=await database_1[_0x17fa09(0x25b)][_0x17fa09(0x2c1)][_0x17fa09(0x290)]({'where':{'id':_0x1c98e4},'select':{'gatewaySettings':!![]}});if(!_0x2cb024?.[_0x17fa09(0x20a)])return console['log'](_0x17fa09(0x24e)+_0x1c98e4+_0x17fa09(0x26b)),0xa;const _0x198bc5=JSON[_0x17fa09(0x29e)](_0x2cb024[_0x17fa09(0x20a)]);for(const [_0x348c4a,_0x2efa65]of Object['entries'](_0x198bc5)){if(_0x348c4a['toLowerCase']()===_0x426607[_0x17fa09(0x2dd)]()){const _0x1c885c=_0x2efa65[_0x17fa09(0x296)]||0xa;return console[_0x17fa09(0x2d0)](_0x17fa09(0x29f)+_0x426607+_0x17fa09(0x209)+_0x1c98e4+':\x20'+_0x1c885c+'%'),_0x1c885c;}}return console[_0x17fa09(0x2d0)](_0x17fa09(0x1e9)+_0x426607+_0x17fa09(0x24c)+_0x1c98e4+_0x17fa09(0x265)),0xa;}catch(_0xefa03c){return console[_0x17fa09(0x2f1)](_0x17fa09(0x2b9)+_0x1c98e4+_0x17fa09(0x2ce)+_0x426607+':',_0xefa03c),0xa;}}}exports[a42_0x1466b9(0x2e6)]=CoinToPayStatusService,exports[a42_0x1466b9(0x1f0)]=new CoinToPayStatusService();