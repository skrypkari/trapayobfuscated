'use strict';const a40_0x25ddc1=a40_0x2c04;(function(_0x19bd86,_0x281048){const _0x26eccc=a40_0x2c04,_0x65de5b=_0x19bd86();while(!![]){try{const _0xd4ad52=parseInt(_0x26eccc(0x186))/0x1+parseInt(_0x26eccc(0xe7))/0x2*(parseInt(_0x26eccc(0xf1))/0x3)+parseInt(_0x26eccc(0xc3))/0x4*(-parseInt(_0x26eccc(0xeb))/0x5)+-parseInt(_0x26eccc(0x178))/0x6*(-parseInt(_0x26eccc(0x198))/0x7)+parseInt(_0x26eccc(0xf3))/0x8*(parseInt(_0x26eccc(0x139))/0x9)+parseInt(_0x26eccc(0xac))/0xa+-parseInt(_0x26eccc(0x181))/0xb;if(_0xd4ad52===_0x281048)break;else _0x65de5b['push'](_0x65de5b['shift']());}catch(_0x40b4a4){_0x65de5b['push'](_0x65de5b['shift']());}}}(a40_0x1cf1,0x3e8a1));var __importDefault=this&&this[a40_0x25ddc1(0xa7)]||function(_0x59ac99){return _0x59ac99&&_0x59ac99['__esModule']?_0x59ac99:{'default':_0x59ac99};};function a40_0x2c04(_0x104f38,_0x39ba85){const _0x1cf191=a40_0x1cf1();return a40_0x2c04=function(_0x2c0452,_0x55d29d){_0x2c0452=_0x2c0452-0x9b;let _0x2d10a8=_0x1cf191[_0x2c0452];return _0x2d10a8;},a40_0x2c04(_0x104f38,_0x39ba85);}Object[a40_0x25ddc1(0xef)](exports,a40_0x25ddc1(0x152),{'value':!![]}),exports[a40_0x25ddc1(0x103)]=exports['CoinToPayStatusService']=void 0x0;function a40_0x1cf1(){const _0x13e7be=['payment.pending','\x20commission\x20for\x20shop\x20','\x20skipped,\x20','amount','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','CoinToPay2Service','amountAfterGatewayCommissionUSDT','\x20has\x20no\x20gatewayPaymentId','\x20in\x20shop\x20','\x20days,\x20marking\x20as\x20EXPIRED','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','Failed\x20to\x20send\x20shop\x20webhook:','logCoinToPayError','getGatewayIdByName',':\x20type=','COMPLETED','❌\x20[HOURLY]\x20Payment\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20USDT','\x20seconds\x20(','4714fmbjch','sendPaymentStatusNotification','\x20triggered\x20for\x20payment\x20','from','20HXDHAw','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','settings','logWhiteDomainError','defineProperty','stack','267ttkgTF','🪙\x20[TIMER]\x20Individual\x20check\x20#','97472SceWHH','\x20is\x20too\x20new\x20(','checkExpiredPayments','\x20payment\x20','\x20\x20\x20Amount\x20after\x20commission:\x20','logShopWebhookSent','auto_expire','../config/database','\x20pending\x20CoinToPay\x20payments','type','Unknown\x20error','\x20days\x20(created\x20before\x20','\x20updated:\x20currentPayments=','default','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','Webhook\x20event\x20','coinToPayStatusService','FAILED','stopPeriodicStatusCheck','convertToUSDT','adminNotes','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','\x20initial\x20timers\x20for\x20payment\x20','setDate','\x20for\x20payment\x20','5\x20minutes','\x20not\x20found\x20in\x20database','cointopay2','\x20updated\x20successfully','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','gatewaySettings','SINGLE','webhookEvents','clearPaymentTimers','checkAllPendingPayments','\x20not\x20found,\x20clearing\x20timers','🔄\x20[CHECK]\x20Updating\x20payment\x20','getGatewayCommission','forEach','iban','Automatically\x20expired\x20after\x20','webhook_send','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','⏰\x20[HOURLY]\x20Payment\x20','created','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','create','⏰\x20[GLOBAL]\x20Payment\x20','\x20\x20\x20-\x20paymentId:\x20','./telegramBotService','\x20in\x20','customerEmail','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','cointopay','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','\x20current\x20status:\x20','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','payment','toISOString','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','getTime','catch','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','now','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','payment.failed','sendShopWebhook','27pJGUIT','\x20\x20\x20📍\x20Source:\x20','⚠️\x20[CHECK]\x20Payment\x20','length','Payment\x20not\x20found','\x20status\x20is\x20','\x20(age:\x20','paymentLink','parse','📈\x20[COINTOPAY]\x20Payment\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','Payment\x20older\x20than\x20','error','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','../types/gateway','unknown','✅\x20[CHECK]\x20Payment\x20','./gateways/coinToPay2Service','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20\x20\x20📅\x20Time:\x20','ms)','delay','description','\x20found:','__esModule','Success','EXPIRED','paymentDetails','\x20->\x20','gatewayPaymentId',',\x20using\x20default\x2010%','message','\x20days\x20without\x20payment\x20confirmation','-day\x20timeout','includes','transactionId','stringify','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','update','\x20not\x20enabled\x20for\x20shop\x20','paymentId','POST','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','get','\x20\x20\x20-\x20ShopId:\x20','timestamp','\x20(after\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','webhookLog','cointopay_status_check_','gateway','logCoinToPayStatus','schedulePaymentChecks','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','failed','./currencyService','cointopay_status_check_error','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','paidAt','findUnique','currentPayments','2104026reebIr','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','\x20status:\x20','✅\x20[HOURLY]\x20Payment\x20','map','shopId','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','checkSinglePaymentById','\x20\x20\x20-\x20Gateway:\x20','4629625QkoEKm',',\x20stopping\x20individual\x20checks','\x20status\x20unchanged\x20(','checkSinglePayment','entries','472501saWXaJ','cointopay_auto_expired','push','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','createdAt','getPaymentTimerInfo','remitterIban','✅\x20[TIMER]\x20Individual\x20check\x20#','\x20status\x20from\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20details:','\x20\x20\x20📝\x20Context:','checkPaymentStatus','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','createdOn','🪙\x20[GLOBAL]\x20Found\x20','\x20\x20\x20📝\x20Details:','delete','7cgkhdC','application/json','\x20\x20\x20📊\x20Status:\x20','logShopWebhookError','Shop\x20webhook\x20sent\x20to\x20','telegramBotService','paymentTimers','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','webhookUrl','log','\x20expired\x20CoinToPay\x20payments','PAID','\x20\x20\x20-\x20gatewayPaymentId:\x20','toLowerCase','/status/','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','\x20expired','🪙\x20[DEBUG]\x20Creating\x20','💰\x20[CHECK]\x20Payment\x20','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','✅\x20[EXPIRY]\x20Payment\x20','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','Gateway\x20','TesSoft\x20Payment\x20System/1.0','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','currency','h),\x20skipping\x20global\x20check','CoinToPayStatusService','globalCheckInterval','shop','confirmedOn','\x20completed\x20for\x20payment\x20','Bank\x20Details:\x20','status','size','🧹\x20[DEBUG]\x20Clearing\x20','⏰\x20[GLOBAL]\x20Found\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','__importDefault','\x20\x20\x20-\x20Status:\x20','loggerService','\x20is\x20valid\x20for\x20checking,\x20proceeding...','🔍\x20[CHECK]\x20Checking\x20','930870RyvaPE','⏰\x20[EXPIRY]\x20Payment\x20','\x20\x20\x20Amount:\x20','floor','\x20individual\x20payment\x20timers','CoinToPayService','COINTOPAY_STATUS_CHANGE','customerName','gatewayOrderId','\x20is\x20older\x20than\x20','coinToPay2Service','status_check','paid','2\x20minutes','timers','gatewayCommissionRate','amountUSDT','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20',',\x20status=','has','not\x20confirmed','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','485548nSvjYT','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','📊\x20[CHECK]\x20Payment\x20','not\x20found',',\x20using\x20default\x20commission\x2010%','orderId','\x20has\x20no\x20gatewayPaymentId,\x20skipping','PENDING','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','bankDetails','🛑\x20[SHUTDOWN]\x20Cleared\x20','./loggerService','EXPIRY_DAYS','commission','GLOBAL_CHECK_INTERVAL_MS','📊\x20[CHECK]\x20CoinToPay\x20payment\x20'];a40_0x1cf1=function(){return _0x13e7be;};return a40_0x1cf1();}const coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a40_0x25ddc1(0x14b)),gateway_1=require(a40_0x25ddc1(0x148)),database_1=__importDefault(require(a40_0x25ddc1(0xfa))),telegramBotService_1=require(a40_0x25ddc1(0x126)),loggerService_1=require(a40_0x25ddc1(0xce)),currencyService_1=require(a40_0x25ddc1(0x171));class CoinToPayStatusService{constructor(){const _0x5e6601=a40_0x25ddc1;this['globalCheckInterval']=null,this[_0x5e6601(0xd1)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x5e6601(0x19e)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x5e6601(0xb1))](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x5e6601(0xd8))](),console[_0x5e6601(0x1a1)](_0x5e6601(0x174));}[a40_0x25ddc1(0x16e)](_0x363c91,_0xd5d21d){const _0x4525af=a40_0x25ddc1;console[_0x4525af(0x1a1)](_0x4525af(0x1ad)),console['log'](_0x4525af(0x125)+_0x363c91),console[_0x4525af(0x1a1)](_0x4525af(0x1a4)+_0xd5d21d),this[_0x4525af(0x114)](_0x363c91);const _0x245d6a=[],_0x2019a1=new Date(),_0x74a783=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x4525af(0xb9)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x4525af(0x10c)}];console[_0x4525af(0x1a1)](_0x4525af(0x1a9)+_0x74a783[_0x4525af(0x13c)]+_0x4525af(0x109)+_0x363c91);let _0x8f774d=0x0;_0x74a783[_0x4525af(0x119)]((_0x5182da,_0x4de0f7)=>{const _0x3f713b=_0x4525af;_0x8f774d+=_0x5182da['delay'];const _0x3a42c1=setTimeout(async()=>{const _0x1dd8f4=a40_0x2c04;console[_0x1dd8f4(0x1a1)](_0x1dd8f4(0xf2)+(_0x4de0f7+0x1)+_0x1dd8f4(0xe9)+_0x363c91+_0x1dd8f4(0x168)+_0x5182da[_0x1dd8f4(0x150)]+')');try{await this['checkSinglePaymentById'](_0x363c91),console['log'](_0x1dd8f4(0x18d)+(_0x4de0f7+0x1)+_0x1dd8f4(0xa0)+_0x363c91);}catch(_0x5efc46){console[_0x1dd8f4(0x145)](_0x1dd8f4(0x12d)+(_0x4de0f7+0x1)+_0x1dd8f4(0x10b)+_0x363c91+':',_0x5efc46),this[_0x1dd8f4(0xdf)](_0x363c91,_0xd5d21d,_0x5efc46,_0x1dd8f4(0xb7),{'checkNumber':_0x4de0f7+0x1,'scheduledAfter':_0x5182da[_0x1dd8f4(0x150)],'isIndividualCheck':!![]});}},_0x8f774d);_0x245d6a['push'](_0x3a42c1),console['log'](_0x3f713b(0x16f)+(_0x4de0f7+0x1)+_0x3f713b(0x10b)+_0x363c91+_0x3f713b(0x127)+_0x8f774d/0x3e8+_0x3f713b(0xe6)+_0x5182da[_0x3f713b(0x150)]+')');});const _0x34d5ed=setInterval(async()=>{const _0x16bb1f=_0x4525af;console[_0x16bb1f(0x1a1)](_0x16bb1f(0x173)+_0x363c91);try{const _0x5d1e20=await database_1['default'][_0x16bb1f(0x12f)][_0x16bb1f(0x176)]({'where':{'id':_0x363c91},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x5d1e20){console[_0x16bb1f(0x1a1)](_0x16bb1f(0xe3)+_0x363c91+_0x16bb1f(0x116)),this[_0x16bb1f(0x114)](_0x363c91);return;}console[_0x16bb1f(0x1a1)]('📊\x20[HOURLY]\x20Payment\x20'+_0x363c91+_0x16bb1f(0x12c)+_0x5d1e20[_0x16bb1f(0xa2)]);if(_0x5d1e20[_0x16bb1f(0xa2)]!==_0x16bb1f(0xca)){console[_0x16bb1f(0x1a1)](_0x16bb1f(0x17b)+_0x363c91+_0x16bb1f(0x13e)+_0x5d1e20[_0x16bb1f(0xa2)]+_0x16bb1f(0x182)),this['clearPaymentTimers'](_0x363c91);return;}const _0x2adeec=Math[_0x16bb1f(0xaf)]((Date[_0x16bb1f(0x135)]()-_0x5d1e20[_0x16bb1f(0x18a)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x2adeec>=this['EXPIRY_DAYS']){console[_0x16bb1f(0x1a1)](_0x16bb1f(0x11f)+_0x363c91+_0x16bb1f(0xb5)+this[_0x16bb1f(0xcf)]+_0x16bb1f(0x11d)),this['clearPaymentTimers'](_0x363c91);return;}await this[_0x16bb1f(0x17f)](_0x363c91),console[_0x16bb1f(0x1a1)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x363c91);}catch(_0x471ed3){console[_0x16bb1f(0x145)](_0x16bb1f(0x193)+_0x363c91+':',_0x471ed3),this['logCoinToPayError'](_0x363c91,_0xd5d21d,_0x471ed3,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x245d6a[_0x4525af(0x188)](_0x34d5ed),this[_0x4525af(0x19e)]['set'](_0x363c91,{'timers':_0x245d6a,'paymentId':_0x363c91,'gatewayPaymentId':_0xd5d21d,'createdAt':_0x2019a1}),console[_0x4525af(0x1a1)](_0x4525af(0x129)+_0x74a783[_0x4525af(0x13c)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x363c91),console[_0x4525af(0x1a1)]('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x4525af(0x19e)][_0x4525af(0xa3)]),this[_0x4525af(0x16d)](_0x363c91,_0xd5d21d,'PENDING','PENDING',_0x4525af(0xb7),{'action':'schedule_created','scheduledChecks':_0x74a783[_0x4525af(0x13c)],'firstCheckIn':_0x74a783[0x0][_0x4525af(0x14f)]/0x3e8,'totalTimers':this[_0x4525af(0x19e)]['size']});}[a40_0x25ddc1(0x114)](_0x534f06){const _0x46d269=a40_0x25ddc1,_0x2d4088=this['paymentTimers']['get'](_0x534f06);_0x2d4088?(console['log'](_0x46d269(0xa4)+_0x2d4088[_0x46d269(0xba)][_0x46d269(0x13c)]+'\x20timers\x20for\x20payment\x20'+_0x534f06),_0x2d4088[_0x46d269(0xba)]['forEach']((_0x28c408,_0x26e754)=>{const _0x403e91=_0x46d269;_0x28c408&&(clearTimeout(_0x28c408),clearInterval(_0x28c408),console[_0x403e91(0x1a1)](_0x403e91(0x11e)+(_0x26e754+0x1)+'\x20for\x20payment\x20'+_0x534f06));}),this['paymentTimers'][_0x46d269(0x197)](_0x534f06),console[_0x46d269(0x1a1)](_0x46d269(0x134)+_0x534f06+'.\x20Remaining\x20active\x20timers:\x20'+this['paymentTimers'][_0x46d269(0xa3)])):console['log'](_0x46d269(0x131)+_0x534f06+'\x20to\x20clear');}async['checkSinglePaymentById'](_0x49f339){const _0x1fefdd=a40_0x25ddc1;console[_0x1fefdd(0x1a1)](_0x1fefdd(0x169)+_0x49f339);const _0x47b373=await database_1[_0x1fefdd(0x100)][_0x1fefdd(0x12f)][_0x1fefdd(0x176)]({'where':{'id':_0x49f339},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x47b373){console[_0x1fefdd(0x1a1)]('❌\x20[CHECK]\x20Payment\x20'+_0x49f339+_0x1fefdd(0x10d));return;}console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x49f339+_0x1fefdd(0x151)),console[_0x1fefdd(0x1a1)](_0x1fefdd(0x180)+_0x47b373[_0x1fefdd(0x16c)]),console['log'](_0x1fefdd(0xa8)+_0x47b373[_0x1fefdd(0xa2)]),console[_0x1fefdd(0x1a1)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x47b373['gatewayPaymentId']),console[_0x1fefdd(0x1a1)]('\x20\x20\x20-\x20Amount:\x20'+_0x47b373[_0x1fefdd(0xd6)]+'\x20'+_0x47b373[_0x1fefdd(0x1b2)]),console[_0x1fefdd(0x1a1)](_0x1fefdd(0x166)+_0x47b373[_0x1fefdd(0x17d)]);if(_0x47b373['gateway']!==_0x1fefdd(0x12a)&&_0x47b373[_0x1fefdd(0x16c)]!==_0x1fefdd(0x10e)){console[_0x1fefdd(0x1a1)](_0x1fefdd(0x13b)+_0x49f339+_0x1fefdd(0x146)+_0x47b373[_0x1fefdd(0x16c)]+')');return;}if(_0x47b373['status']!=='PENDING'){console['log'](_0x1fefdd(0x13b)+_0x49f339+_0x1fefdd(0x13e)+_0x47b373[_0x1fefdd(0xa2)]+_0x1fefdd(0x182)),this['clearPaymentTimers'](_0x49f339);return;}if(!_0x47b373[_0x1fefdd(0x157)]){console[_0x1fefdd(0x1a1)](_0x1fefdd(0x13b)+_0x49f339+_0x1fefdd(0xda));return;}console[_0x1fefdd(0x1a1)](_0x1fefdd(0x14a)+_0x49f339+_0x1fefdd(0xaa)),await this[_0x1fefdd(0x184)](_0x47b373);}['logCoinToPayStatus'](_0xc03c7,_0x35d818,_0x17b390,_0x3de66c,_0x3afebf,_0x1ce9d3){const _0x280f25=a40_0x25ddc1,_0x45e5ed={'type':_0x280f25(0xb2),'paymentId':_0xc03c7,'gatewayPaymentId':_0x35d818,'oldStatus':_0x17b390,'newStatus':_0x3de66c,'source':_0x3afebf,'timestamp':new Date()[_0x280f25(0x130)](),'details':_0x1ce9d3||{}};loggerService_1[_0x280f25(0xa9)]['logCoinToPayStatus'](_0x45e5ed),console['log'](_0x280f25(0x12b)+_0xc03c7+'\x20('+_0x35d818+')'),console[_0x280f25(0x1a1)](_0x280f25(0x19a)+_0x17b390+'\x20->\x20'+_0x3de66c),console[_0x280f25(0x1a1)](_0x280f25(0x13a)+_0x3afebf),console['log'](_0x280f25(0x14d)+_0x45e5ed[_0x280f25(0x167)]),_0x1ce9d3&&console[_0x280f25(0x1a1)](_0x280f25(0x196),_0x1ce9d3);}[a40_0x25ddc1(0xdf)](_0x2c1399,_0x383ac2,_0x4af5ee,_0x53b439,_0x4d4284){const _0x3bddb5=a40_0x25ddc1,_0x200e18={'type':'COINTOPAY_ERROR','paymentId':_0x2c1399,'gatewayPaymentId':_0x383ac2,'error':_0x4af5ee instanceof Error?{'message':_0x4af5ee[_0x3bddb5(0x159)],'stack':_0x4af5ee[_0x3bddb5(0xf0)]}:_0x4af5ee,'source':_0x53b439,'timestamp':new Date()[_0x3bddb5(0x130)](),'context':_0x4d4284||{}};loggerService_1[_0x3bddb5(0xa9)][_0x3bddb5(0xdf)](_0x200e18),console['error'](_0x3bddb5(0x122)+_0x2c1399+'\x20('+_0x383ac2+')'),console[_0x3bddb5(0x145)]('\x20\x20\x20❌\x20Error:\x20'+(_0x4af5ee instanceof Error?_0x4af5ee[_0x3bddb5(0x159)]:_0x4af5ee)),console['error']('\x20\x20\x20📍\x20Source:\x20'+_0x53b439),console[_0x3bddb5(0x145)](_0x3bddb5(0x14d)+_0x200e18[_0x3bddb5(0x167)]),_0x4d4284&&console['error'](_0x3bddb5(0x191),_0x4d4284);}['startPeriodicStatusCheck'](){const _0x320188=a40_0x25ddc1;console[_0x320188(0x1a1)](_0x320188(0xdd)),this[_0x320188(0x115)]()[_0x320188(0x133)](_0x160f30=>{const _0x1f3e75=_0x320188;console[_0x1f3e75(0x145)](_0x1f3e75(0x18f),_0x160f30);}),this[_0x320188(0x9d)]=setInterval(async()=>{const _0x366021=_0x320188;try{console['log'](_0x366021(0xc4)),await this[_0x366021(0x115)](),console[_0x366021(0x1a1)](_0x366021(0xec));}catch(_0x7580ee){console[_0x366021(0x145)](_0x366021(0x19f),_0x7580ee);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x320188(0x1a1)](_0x320188(0x1ab));}[a40_0x25ddc1(0x105)](){const _0x49bcb6=a40_0x25ddc1;console[_0x49bcb6(0x1a1)]('🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this['globalCheckInterval']&&(clearInterval(this[_0x49bcb6(0x9d)]),this[_0x49bcb6(0x9d)]=null,console[_0x49bcb6(0x1a1)](_0x49bcb6(0x14c)));const _0x983e89=this[_0x49bcb6(0x19e)][_0x49bcb6(0xa3)];for(const [_0x5e9b41]of this['paymentTimers']){this[_0x49bcb6(0x114)](_0x5e9b41);}console[_0x49bcb6(0x1a1)](_0x49bcb6(0xcd)+_0x983e89+_0x49bcb6(0xb0));}async[a40_0x25ddc1(0x115)](){const _0x4a7a9b=a40_0x25ddc1;try{console['log'](_0x4a7a9b(0x110));const _0x309e62=await database_1[_0x4a7a9b(0x100)][_0x4a7a9b(0x12f)]['findMany']({'where':{'gateway':{'in':[_0x4a7a9b(0x12a),_0x4a7a9b(0x10e)]},'status':_0x4a7a9b(0xca),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x4a7a9b(0x195)+_0x309e62[_0x4a7a9b(0x13c)]+_0x4a7a9b(0xfb));if(_0x309e62[_0x4a7a9b(0x13c)]===0x0){console[_0x4a7a9b(0x1a1)](_0x4a7a9b(0x143));return;}const _0x22f03d=await this[_0x4a7a9b(0xf5)](_0x309e62);console[_0x4a7a9b(0x1a1)](_0x4a7a9b(0xa5)+_0x22f03d[_0x4a7a9b(0x13c)]+_0x4a7a9b(0x1a2));let _0x3f2967=0x0,_0x164863=0x0;for(const _0x8f3157 of _0x309e62){try{if(_0x22f03d['includes'](_0x8f3157['id'])){console[_0x4a7a9b(0x1a1)](_0x4a7a9b(0x124)+_0x8f3157['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x164863++;continue;}if(this['paymentTimers'][_0x4a7a9b(0xc0)](_0x8f3157['id'])){console['log'](_0x4a7a9b(0x124)+_0x8f3157['id']+_0x4a7a9b(0x164)),_0x164863++;continue;}const _0x229a36=(Date[_0x4a7a9b(0x135)]()-_0x8f3157[_0x4a7a9b(0x18a)][_0x4a7a9b(0x132)]())/(0x3e8*0x3c*0x3c);if(_0x229a36<0x1){console[_0x4a7a9b(0x1a1)](_0x4a7a9b(0x124)+_0x8f3157['id']+_0x4a7a9b(0xf4)+_0x229a36['toFixed'](0x1)+_0x4a7a9b(0x9b)),_0x164863++;continue;}console[_0x4a7a9b(0x1a1)](_0x4a7a9b(0x108)+_0x8f3157['id']+_0x4a7a9b(0x13f)+_0x229a36['toFixed'](0x1)+'h)'),await this[_0x4a7a9b(0x184)](_0x8f3157),_0x3f2967++,await new Promise(_0x472b1c=>setTimeout(_0x472b1c,0x7d0));}catch(_0x213771){console[_0x4a7a9b(0x145)](_0x4a7a9b(0x136)+_0x8f3157['id']+':',_0x213771),this[_0x4a7a9b(0xdf)](_0x8f3157['id'],_0x8f3157[_0x4a7a9b(0x157)]||_0x4a7a9b(0x149),_0x213771,_0x4a7a9b(0xb7),{'isGlobalCheck':!![],'paymentAmount':_0x8f3157[_0x4a7a9b(0xd6)],'paymentCurrency':_0x8f3157[_0x4a7a9b(0x1b2)],'shopId':_0x8f3157[_0x4a7a9b(0x17d)],'createdAt':_0x8f3157[_0x4a7a9b(0x18a)]}),loggerService_1[_0x4a7a9b(0xa9)][_0x4a7a9b(0xee)]('cointopay',_0x4a7a9b(0x1a6)+_0x8f3157[_0x4a7a9b(0x157)],_0x213771);}}console[_0x4a7a9b(0x1a1)](_0x4a7a9b(0xbe)+_0x3f2967+'\x20checked,\x20'+_0x164863+_0x4a7a9b(0xd5)+_0x22f03d[_0x4a7a9b(0x13c)]+_0x4a7a9b(0x1a8));}catch(_0x1c13c5){console[_0x4a7a9b(0x145)](_0x4a7a9b(0x101),_0x1c13c5);}}async[a40_0x25ddc1(0xf5)](_0x234371){const _0x3fb55e=a40_0x25ddc1,_0x5e8714=[],_0xac0a96=new Date();_0xac0a96[_0x3fb55e(0x10a)](_0xac0a96['getDate']()-this[_0x3fb55e(0xcf)]),console[_0x3fb55e(0x1a1)](_0x3fb55e(0xa6)+this['EXPIRY_DAYS']+_0x3fb55e(0xfe)+_0xac0a96[_0x3fb55e(0x130)]()+')');for(const _0x366e85 of _0x234371){if(_0x366e85[_0x3fb55e(0x18a)]<_0xac0a96){console[_0x3fb55e(0x1a1)](_0x3fb55e(0xad)+_0x366e85['id']+_0x3fb55e(0xb5)+this[_0x3fb55e(0xcf)]+_0x3fb55e(0xdc));try{this[_0x3fb55e(0x16d)](_0x366e85['id'],_0x366e85[_0x3fb55e(0x157)]||_0x3fb55e(0x149),_0x3fb55e(0xca),_0x3fb55e(0x154),'auto_expire',{'reason':_0x3fb55e(0x144)+this[_0x3fb55e(0xcf)]+'\x20days','createdAt':_0x366e85[_0x3fb55e(0x18a)],'daysSinceCreation':Math[_0x3fb55e(0xaf)]((Date['now']()-_0x366e85[_0x3fb55e(0x18a)][_0x3fb55e(0x132)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x366e85[_0x3fb55e(0xd6)],'paymentCurrency':_0x366e85['currency'],'shopId':_0x366e85[_0x3fb55e(0x17d)]}),await database_1[_0x3fb55e(0x100)][_0x3fb55e(0x12f)][_0x3fb55e(0x160)]({'where':{'id':_0x366e85['id']},'data':{'status':_0x3fb55e(0x154),'updatedAt':new Date(),'adminNotes':_0x3fb55e(0x11b)+this[_0x3fb55e(0xcf)]+_0x3fb55e(0x15a)}}),await database_1[_0x3fb55e(0x100)][_0x3fb55e(0x16a)][_0x3fb55e(0x123)]({'data':{'paymentId':_0x366e85['id'],'shopId':_0x366e85[_0x3fb55e(0x17d)],'event':_0x3fb55e(0x187),'statusCode':0xc8,'responseBody':JSON[_0x3fb55e(0x15e)]({'reason':_0x3fb55e(0x144)+this[_0x3fb55e(0xcf)]+'\x20days','createdAt':_0x366e85[_0x3fb55e(0x18a)],'expiredAt':new Date()[_0x3fb55e(0x130)](),'daysSinceCreation':Math[_0x3fb55e(0xaf)]((Date[_0x3fb55e(0x135)]()-_0x366e85[_0x3fb55e(0x18a)][_0x3fb55e(0x132)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x3fb55e(0x138)](_0x366e85,'EXPIRED'),await this[_0x3fb55e(0xe8)](_0x366e85,_0x3fb55e(0x154)),this[_0x3fb55e(0x114)](_0x366e85['id']),_0x5e8714['push'](_0x366e85['id']),console['log'](_0x3fb55e(0x1ac)+_0x366e85['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this['EXPIRY_DAYS']+_0x3fb55e(0x15b));}catch(_0x1e0512){console['error'](_0x3fb55e(0x189)+_0x366e85['id']+':',_0x1e0512),this[_0x3fb55e(0xdf)](_0x366e85['id'],_0x366e85[_0x3fb55e(0x157)]||_0x3fb55e(0x149),_0x1e0512,_0x3fb55e(0xf9),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x366e85[_0x3fb55e(0x18a)],'daysSinceCreation':Math[_0x3fb55e(0xaf)]((Date[_0x3fb55e(0x135)]()-_0x366e85[_0x3fb55e(0x18a)][_0x3fb55e(0x132)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5e8714;}async['checkSinglePayment'](_0xb252ee){const _0x40de6d=a40_0x25ddc1;if(!_0xb252ee[_0x40de6d(0x157)]){console[_0x40de6d(0x1a1)](_0x40de6d(0x13b)+_0xb252ee['id']+_0x40de6d(0xc9));return;}console[_0x40de6d(0x1a1)](_0x40de6d(0xab)+_0xb252ee[_0x40de6d(0x16c)]+'\x20payment\x20'+_0xb252ee['id']+'\x20('+_0xb252ee[_0x40de6d(0x157)]+')');try{let _0x41e622;_0xb252ee[_0x40de6d(0x16c)]===_0x40de6d(0x10e)?(_0x41e622=await this[_0x40de6d(0xb6)][_0x40de6d(0x192)](_0xb252ee[_0x40de6d(0x157)]),console[_0x40de6d(0x1a1)](_0x40de6d(0x15f)+_0xb252ee['id']+'\x20status:\x20'+_0x41e622[_0x40de6d(0xa2)])):(_0x41e622=await this['coinToPayService'][_0x40de6d(0x192)](_0xb252ee[_0x40de6d(0x157)]),console[_0x40de6d(0x1a1)](_0x40de6d(0xd2)+_0xb252ee['id']+_0x40de6d(0x17a)+_0x41e622['status']));_0x41e622[_0x40de6d(0x155)]&&console[_0x40de6d(0x1a1)](_0x40de6d(0xc5)+_0xb252ee['id']+_0x40de6d(0x190),{'iban':_0x41e622[_0x40de6d(0x155)][_0x40de6d(0x11a)]||_0x40de6d(0xc6),'transactionId':_0x41e622['paymentDetails'][_0x40de6d(0x15d)],'createdOn':_0x41e622[_0x40de6d(0x155)][_0x40de6d(0x194)],'confirmedOn':_0x41e622[_0x40de6d(0x155)][_0x40de6d(0x9f)]||_0x40de6d(0xc1)});if(_0x41e622['status']!==_0xb252ee[_0x40de6d(0xa2)]){console['log'](_0x40de6d(0x117)+_0xb252ee['id']+_0x40de6d(0x18e)+_0xb252ee[_0x40de6d(0xa2)]+'\x20to\x20'+_0x41e622[_0x40de6d(0xa2)]),this['logCoinToPayStatus'](_0xb252ee['id'],_0xb252ee[_0x40de6d(0x157)],_0xb252ee[_0x40de6d(0xa2)],_0x41e622['status'],'status_check',{'paymentDetails':_0x41e622[_0x40de6d(0x155)],'amount':_0x41e622[_0x40de6d(0xd6)],'currency':_0x41e622[_0x40de6d(0x1b2)],'shopId':_0xb252ee[_0x40de6d(0x17d)],'checkTimestamp':new Date()[_0x40de6d(0x130)]()});const _0x46fccf={'status':_0x41e622[_0x40de6d(0xa2)],'updatedAt':new Date()};if(_0x41e622['status']===_0x40de6d(0x1a3)&&_0xb252ee['status']!=='PAID'){_0x46fccf[_0x40de6d(0x175)]=new Date();if(!_0xb252ee['amountUSDT']){const _0x3ad901=await currencyService_1['currencyService'][_0x40de6d(0x106)](_0xb252ee[_0x40de6d(0xd6)],_0xb252ee['currency']);_0x46fccf[_0x40de6d(0xbc)]=_0x3ad901;const _0x18a5e1=await this[_0x40de6d(0x118)](_0xb252ee['shopId'],_0xb252ee['gateway']),_0x2e693a=_0x3ad901*(0x1-_0x18a5e1/0x64);_0x46fccf[_0x40de6d(0xd9)]=_0x2e693a,_0x46fccf[_0x40de6d(0xbb)]=_0x18a5e1,console[_0x40de6d(0x1a1)](_0x40de6d(0x1aa)+_0xb252ee['id']+'\x20amounts\x20calculated:'),console[_0x40de6d(0x1a1)](_0x40de6d(0xae)+_0xb252ee[_0x40de6d(0xd6)]+'\x20'+_0xb252ee[_0x40de6d(0x1b2)]+_0x40de6d(0x156)+_0x3ad901['toFixed'](0x6)+_0x40de6d(0xe5)),console['log']('\x20\x20\x20Gateway\x20'+_0xb252ee[_0x40de6d(0x16c)]+'\x20commission:\x20'+_0x18a5e1+'%'),console['log'](_0x40de6d(0xf7)+_0x2e693a['toFixed'](0x6)+_0x40de6d(0xe5));}console[_0x40de6d(0x1a1)](_0x40de6d(0x1aa)+_0xb252ee['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x46fccf['paidAt']['toISOString']());}if(_0x41e622['paymentDetails']){const _0x4856d2=_0x41e622[_0x40de6d(0x155)];_0x4856d2['iban']&&(_0x46fccf[_0x40de6d(0x18c)]=_0x4856d2[_0x40de6d(0x11a)],console[_0x40de6d(0x1a1)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x4856d2[_0x40de6d(0x11a)]));if(_0x4856d2['bankDetails']){const _0x2de8fe=_0xb252ee[_0x40de6d(0x107)]||'',_0x119da6=_0x40de6d(0xa1)+_0x4856d2[_0x40de6d(0xcc)];_0x46fccf['adminNotes']=_0x2de8fe?_0x2de8fe+'\x0a\x0a'+_0x119da6:_0x119da6,console['log'](_0x40de6d(0xbd));}_0x4856d2['transactionId']&&console[_0x40de6d(0x1a1)]('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x4856d2[_0x40de6d(0x15d)]),_0x4856d2[_0x40de6d(0x9f)]&&console[_0x40de6d(0x1a1)](_0x40de6d(0x121)+_0x4856d2[_0x40de6d(0x9f)]);}await database_1['default'][_0x40de6d(0x12f)][_0x40de6d(0x160)]({'where':{'id':_0xb252ee['id']},'data':_0x46fccf});if(_0x41e622['status']==='PAID'&&_0xb252ee[_0x40de6d(0xa2)]!==_0x40de6d(0x1a3)){console[_0x40de6d(0x1a1)](_0x40de6d(0x142)+_0xb252ee['id']+_0x40de6d(0x179));const _0x3e732a=await database_1[_0x40de6d(0x100)][_0x40de6d(0x12f)][_0x40de6d(0x176)]({'where':{'id':_0xb252ee['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x3e732a?.['paymentLinkId']&&_0x3e732a[_0x40de6d(0x140)])try{const _0x658bed=_0x3e732a[_0x40de6d(0x140)];console['log']('📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x658bed['id']+_0x40de6d(0xe1)+_0x658bed[_0x40de6d(0xfc)]+',\x20currentPayments='+_0x658bed[_0x40de6d(0x177)]+',\x20status='+_0x658bed['status']);const _0x146424=_0x658bed['currentPayments']+0x1,_0x4149a6=_0x658bed[_0x40de6d(0xfc)]===_0x40de6d(0x112)?_0x40de6d(0xe2):_0x658bed[_0x40de6d(0xa2)];await database_1['default'][_0x40de6d(0x140)][_0x40de6d(0x160)]({'where':{'id':_0x658bed['id']},'data':{'currentPayments':_0x146424,'status':_0x4149a6,'updatedAt':new Date()}}),console['log']('✅\x20[COINTOPAY]\x20Payment\x20link\x20'+_0x658bed['id']+_0x40de6d(0xff)+_0x658bed[_0x40de6d(0x177)]+_0x40de6d(0x156)+_0x146424+_0x40de6d(0xbf)+_0x658bed[_0x40de6d(0xa2)]+_0x40de6d(0x156)+_0x4149a6);}catch(_0x1efe3b){console['error']('❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:',_0x1efe3b);}else console[_0x40de6d(0x1a1)](_0x40de6d(0x142)+_0xb252ee['id']+_0x40de6d(0x12e));}await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0xb252ee['id'],'shopId':_0xb252ee[_0x40de6d(0x17d)],'event':_0x40de6d(0x16b)+_0x41e622[_0x40de6d(0xa2)][_0x40de6d(0x1a5)](),'statusCode':0xc8,'responseBody':JSON[_0x40de6d(0x15e)]({'oldStatus':_0xb252ee[_0x40de6d(0xa2)],'newStatus':_0x41e622['status'],'paymentDetails':_0x41e622[_0x40de6d(0x155)],'checkedAt':new Date()[_0x40de6d(0x130)]()})}}),await this['sendShopWebhook'](_0xb252ee,_0x41e622['status']),await this[_0x40de6d(0xe8)](_0xb252ee,_0x41e622[_0x40de6d(0xa2)]),_0x41e622[_0x40de6d(0xa2)]!==_0x40de6d(0xca)&&(console[_0x40de6d(0x1a1)]('🧹\x20[CHECK]\x20Payment\x20'+_0xb252ee['id']+'\x20status\x20changed\x20to\x20'+_0x41e622['status']+',\x20clearing\x20individual\x20timers'),this[_0x40de6d(0x114)](_0xb252ee['id'])),console[_0x40de6d(0x1a1)](_0x40de6d(0x14a)+_0xb252ee['id']+_0x40de6d(0x10f));}else console[_0x40de6d(0x1a1)](_0x40de6d(0xc5)+_0xb252ee['id']+_0x40de6d(0x183)+_0x41e622[_0x40de6d(0xa2)]+')'),this[_0x40de6d(0x16d)](_0xb252ee['id'],_0xb252ee[_0x40de6d(0x157)],_0xb252ee['status'],_0x41e622[_0x40de6d(0xa2)],_0x40de6d(0xb7),{'statusUnchanged':!![],'paymentDetails':_0x41e622[_0x40de6d(0x155)],'amount':_0x41e622[_0x40de6d(0xd6)],'currency':_0x41e622[_0x40de6d(0x1b2)],'shopId':_0xb252ee['shopId'],'checkTimestamp':new Date()[_0x40de6d(0x130)]()});}catch(_0x555410){console[_0x40de6d(0x145)](_0x40de6d(0xe4)+_0xb252ee['id']+':',_0x555410),this['logCoinToPayError'](_0xb252ee['id'],_0xb252ee['gatewayPaymentId'],_0x555410,'status_check',{'paymentAmount':_0xb252ee[_0x40de6d(0xd6)],'paymentCurrency':_0xb252ee[_0x40de6d(0x1b2)],'shopId':_0xb252ee[_0x40de6d(0x17d)],'createdAt':_0xb252ee[_0x40de6d(0x18a)]}),await database_1[_0x40de6d(0x100)][_0x40de6d(0x16a)][_0x40de6d(0x123)]({'data':{'paymentId':_0xb252ee['id'],'shopId':_0xb252ee['shopId'],'event':_0x40de6d(0x172),'statusCode':0x1f4,'responseBody':JSON[_0x40de6d(0x15e)]({'error':_0x555410 instanceof Error?_0x555410[_0x40de6d(0x159)]:_0x40de6d(0xfd),'gatewayPaymentId':_0xb252ee[_0x40de6d(0x157)],'checkedAt':new Date()[_0x40de6d(0x130)]()})}});}}async[a40_0x25ddc1(0x138)](_0xc204dd,_0x1ddb5d){const _0x244cbf=a40_0x25ddc1,_0x790bcc=Date[_0x244cbf(0x135)]();try{const _0x1f2e69=_0xc204dd[_0x244cbf(0x9e)],_0xd62975=_0x1f2e69['settings'];if(!_0xd62975?.[_0x244cbf(0x1a0)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1f2e69['id']);return;}const _0x1d6214=_0x1ddb5d===_0x244cbf(0x1a3)?'payment.success':_0x1ddb5d===_0x244cbf(0x104)?_0x244cbf(0x137):_0x1ddb5d==='EXPIRED'?_0x244cbf(0x137):_0x244cbf(0xd3);if(!_0xd62975[_0x244cbf(0x113)]?.[_0x244cbf(0x15c)](_0x1d6214)){console[_0x244cbf(0x1a1)](_0x244cbf(0x102)+_0x1d6214+_0x244cbf(0x161)+_0x1f2e69['id']);return;}const _0x2bc8ab=(0x0,gateway_1[_0x244cbf(0xe0)])(_0xc204dd[_0x244cbf(0x16c)])||_0xc204dd[_0x244cbf(0x16c)],_0x586458={'event':_0x1d6214,'payment':{'id':_0xc204dd['id'],'order_id':_0xc204dd[_0x244cbf(0xc8)],'gateway_order_id':_0xc204dd[_0x244cbf(0xb4)],'gateway':_0x2bc8ab,'amount':_0xc204dd[_0x244cbf(0xd6)],'currency':_0xc204dd[_0x244cbf(0x1b2)],'status':_0x1ddb5d['toLowerCase'](),'customer_email':_0xc204dd[_0x244cbf(0x128)],'customer_name':_0xc204dd[_0x244cbf(0xb3)],'created_at':_0xc204dd[_0x244cbf(0x18a)],'updated_at':new Date()}},_0xcc8d43=await fetch(_0xd62975[_0x244cbf(0x1a0)],{'method':_0x244cbf(0x163),'headers':{'Content-Type':_0x244cbf(0x199),'User-Agent':_0x244cbf(0x1b0)},'body':JSON['stringify'](_0x586458)}),_0x11ed6a=Date[_0x244cbf(0x135)]()-_0x790bcc,_0x4d58fc=_0xcc8d43['ok']?_0x244cbf(0x153):await _0xcc8d43['text']();loggerService_1['loggerService'][_0x244cbf(0xf8)](_0xc204dd[_0x244cbf(0x17d)],_0xd62975[_0x244cbf(0x1a0)],_0x1d6214,_0xcc8d43[_0x244cbf(0xa2)],_0x11ed6a,_0x586458),console['log'](_0x244cbf(0x19c)+_0xd62975[_0x244cbf(0x1a0)]+'\x20with\x20status\x20'+_0xcc8d43[_0x244cbf(0xa2)]+'\x20('+_0x11ed6a+_0x244cbf(0x14e));}catch(_0x5cced8){console['error'](_0x244cbf(0xde),_0x5cced8),loggerService_1[_0x244cbf(0xa9)][_0x244cbf(0x19b)](_0xc204dd[_0x244cbf(0x17d)],_0xc204dd[_0x244cbf(0x9e)]?.[_0x244cbf(0xed)]?.[_0x244cbf(0x1a0)]||_0x244cbf(0x149),_0x244cbf(0x11c),_0x5cced8,{});}}async[a40_0x25ddc1(0xe8)](_0x2f9b26,_0x311135){const _0xba2ed9=a40_0x25ddc1;try{const _0x146a24={'PENDING':_0xba2ed9(0x120),'PAID':_0xba2ed9(0xb8),'FAILED':_0xba2ed9(0x170),'EXPIRED':'expired'},_0x9063df=_0x146a24[_0x311135];if(!_0x9063df||_0x9063df===_0xba2ed9(0x120))return;await telegramBotService_1[_0xba2ed9(0x19d)]['sendPaymentNotification'](_0x2f9b26[_0xba2ed9(0x17d)],_0x2f9b26,_0x9063df);}catch(_0x1aa3c6){console[_0xba2ed9(0x145)](_0xba2ed9(0x17e),_0x1aa3c6);}}async['checkPaymentById'](_0xdb8198){const _0x597e5b=a40_0x25ddc1;console['log'](_0x597e5b(0xd7)+_0xdb8198);const _0x11c3ca=await database_1[_0x597e5b(0x100)][_0x597e5b(0x12f)][_0x597e5b(0x176)]({'where':{'id':_0xdb8198},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x11c3ca)throw new Error(_0x597e5b(0x13d));if(_0x11c3ca[_0x597e5b(0x16c)]!==_0x597e5b(0x12a)&&_0x11c3ca[_0x597e5b(0x16c)]!==_0x597e5b(0x10e))throw new Error(_0x597e5b(0x1a7));console[_0x597e5b(0x1a1)](_0x597e5b(0xcb)+_0x11c3ca[_0x597e5b(0x16c)]+_0x597e5b(0xf6)+_0xdb8198),await this['checkSinglePayment'](_0x11c3ca),console[_0x597e5b(0x1a1)](_0x597e5b(0x147)+_0xdb8198);}['getServiceStats'](){const _0x405fb9=a40_0x25ddc1,_0x7c7de6=this[_0x405fb9(0x9d)]?this[_0x405fb9(0xd1)]:undefined,_0x25c1b5=Array[_0x405fb9(0xea)](this['paymentTimers']['values']())[_0x405fb9(0x17c)](_0x36aa74=>({'paymentId':_0x36aa74[_0x405fb9(0x162)],'gatewayPaymentId':_0x36aa74['gatewayPaymentId'],'createdAt':_0x36aa74['createdAt'],'timersCount':_0x36aa74[_0x405fb9(0xba)][_0x405fb9(0x13c)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x405fb9(0xd1)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this['paymentTimers']['size'],'nextGlobalCheckIn':_0x7c7de6,'paymentTimersDetails':_0x25c1b5};}[a40_0x25ddc1(0x18b)](_0xf65017){const _0x512a29=a40_0x25ddc1,_0x3917de=this[_0x512a29(0x19e)][_0x512a29(0x165)](_0xf65017);if(_0x3917de)return{'hasTimers':!![],'timersCount':_0x3917de[_0x512a29(0xba)][_0x512a29(0x13c)],'createdAt':_0x3917de[_0x512a29(0x18a)],'gatewayPaymentId':_0x3917de[_0x512a29(0x157)]};return{'hasTimers':![]};}async[a40_0x25ddc1(0x118)](_0x1515c3,_0x2657df){const _0x510518=a40_0x25ddc1;try{const _0x2591cd=await database_1[_0x510518(0x100)][_0x510518(0x9e)][_0x510518(0x176)]({'where':{'id':_0x1515c3},'select':{'gatewaySettings':!![]}});if(!_0x2591cd?.['gatewaySettings'])return console['log'](_0x510518(0x1ae)+_0x1515c3+_0x510518(0xc7)),0xa;const _0x514ba3=JSON[_0x510518(0x141)](_0x2591cd[_0x510518(0x111)]);for(const [_0x2d4125,_0x27d967]of Object[_0x510518(0x185)](_0x514ba3)){if(_0x2d4125['toLowerCase']()===_0x2657df[_0x510518(0x1a5)]()){const _0xb5db55=_0x27d967[_0x510518(0xd0)]||0xa;return console[_0x510518(0x1a1)](_0x510518(0x1af)+_0x2657df+_0x510518(0xd4)+_0x1515c3+':\x20'+_0xb5db55+'%'),_0xb5db55;}}return console[_0x510518(0x1a1)](_0x510518(0xc2)+_0x2657df+_0x510518(0xdb)+_0x1515c3+_0x510518(0x158)),0xa;}catch(_0x3dedc5){return console[_0x510518(0x145)](_0x510518(0x1b1)+_0x1515c3+',\x20gateway\x20'+_0x2657df+':',_0x3dedc5),0xa;}}}exports[a40_0x25ddc1(0x9c)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();