'use strict';const a35_0x54a389=a35_0x38e3;(function(_0x1e0726,_0x453429){const _0x54ebdb=a35_0x38e3,_0x5ba834=_0x1e0726();while(!![]){try{const _0x538015=-parseInt(_0x54ebdb(0x229))/0x1*(-parseInt(_0x54ebdb(0x26a))/0x2)+-parseInt(_0x54ebdb(0x2af))/0x3*(parseInt(_0x54ebdb(0x1e0))/0x4)+-parseInt(_0x54ebdb(0x234))/0x5*(parseInt(_0x54ebdb(0x205))/0x6)+-parseInt(_0x54ebdb(0x295))/0x7+-parseInt(_0x54ebdb(0x21c))/0x8+-parseInt(_0x54ebdb(0x268))/0x9*(parseInt(_0x54ebdb(0x269))/0xa)+parseInt(_0x54ebdb(0x1f8))/0xb;if(_0x538015===_0x453429)break;else _0x5ba834['push'](_0x5ba834['shift']());}catch(_0x1ad907){_0x5ba834['push'](_0x5ba834['shift']());}}}(a35_0x5bf9,0xe18df));var __importDefault=this&&this[a35_0x54a389(0x221)]||function(_0xb3609b){const _0x7f32df=a35_0x54a389;return _0xb3609b&&_0xb3609b[_0x7f32df(0x23a)]?_0xb3609b:{'default':_0xb3609b};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['coinToPayStatusService']=exports[a35_0x54a389(0x1f6)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require('../config/database')),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a35_0x54a389(0x26d));class CoinToPayStatusService{constructor(){const _0x304119=a35_0x54a389;this['globalCheckInterval']=null,this[_0x304119(0x1f1)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x304119(0x298)]=new Map(),this[_0x304119(0x1ec)]=new coinToPayService_1[(_0x304119(0x27e))](),console['log']('ü™ô\x20CoinToPayStatusService\x20initialized');}[a35_0x54a389(0x1f4)](_0x508487,_0x390b2f){const _0x754b56=a35_0x54a389;console[_0x754b56(0x1d8)](_0x754b56(0x24a)),console[_0x754b56(0x1d8)](_0x754b56(0x246)+_0x508487),console[_0x754b56(0x1d8)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x390b2f),this['clearPaymentTimers'](_0x508487);const _0x488771=[],_0x37d68a=new Date(),_0x143190=[{'delay':0x1*0x3c*0x3e8,'description':_0x754b56(0x280)},{'delay':0x2*0x3c*0x3e8,'description':_0x754b56(0x26c)},{'delay':0x5*0x3c*0x3e8,'description':_0x754b56(0x26b)},{'delay':0x5*0x3c*0x3e8,'description':_0x754b56(0x26b)}];console[_0x754b56(0x1d8)]('ü™ô\x20[DEBUG]\x20Creating\x20'+_0x143190[_0x754b56(0x1e4)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x508487);let _0x3747f4=0x0;_0x143190[_0x754b56(0x258)]((_0x578fd2,_0x12a9b5)=>{const _0x2e6185=_0x754b56;_0x3747f4+=_0x578fd2[_0x2e6185(0x210)];const _0x49227e=setTimeout(async()=>{const _0x122eb4=_0x2e6185;console[_0x122eb4(0x1d8)](_0x122eb4(0x2a5)+(_0x12a9b5+0x1)+_0x122eb4(0x2a3)+_0x508487+_0x122eb4(0x202)+_0x578fd2[_0x122eb4(0x223)]+')');try{await this['checkSinglePaymentById'](_0x508487),console[_0x122eb4(0x1d8)](_0x122eb4(0x22a)+(_0x12a9b5+0x1)+'\x20completed\x20for\x20payment\x20'+_0x508487);}catch(_0xa946d2){console[_0x122eb4(0x2a6)](_0x122eb4(0x25a)+(_0x12a9b5+0x1)+_0x122eb4(0x244)+_0x508487+':',_0xa946d2),this[_0x122eb4(0x236)](_0x508487,_0x390b2f,_0xa946d2,_0x122eb4(0x21d),{'checkNumber':_0x12a9b5+0x1,'scheduledAfter':_0x578fd2['description'],'isIndividualCheck':!![]});}},_0x3747f4);_0x488771[_0x2e6185(0x1fd)](_0x49227e),console[_0x2e6185(0x1d8)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x12a9b5+0x1)+'\x20for\x20payment\x20'+_0x508487+_0x2e6185(0x287)+_0x3747f4/0x3e8+'\x20seconds\x20('+_0x578fd2[_0x2e6185(0x223)]+')');});const _0x4e9339=setInterval(async()=>{const _0x15c804=_0x754b56;console['log']('ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x508487);try{const _0x2fe660=await database_1[_0x15c804(0x273)][_0x15c804(0x1e1)][_0x15c804(0x25e)]({'where':{'id':_0x508487},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x2fe660){console[_0x15c804(0x1d8)]('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x508487+_0x15c804(0x214)),this[_0x15c804(0x28e)](_0x508487);return;}console['log'](_0x15c804(0x28b)+_0x508487+'\x20current\x20status:\x20'+_0x2fe660[_0x15c804(0x27f)]);if(_0x2fe660[_0x15c804(0x27f)]!==_0x15c804(0x2b0)){console[_0x15c804(0x1d8)]('‚úÖ\x20[HOURLY]\x20Payment\x20'+_0x508487+_0x15c804(0x22e)+_0x2fe660[_0x15c804(0x27f)]+_0x15c804(0x29f)),this[_0x15c804(0x28e)](_0x508487);return;}const _0x296580=Math[_0x15c804(0x26e)]((Date[_0x15c804(0x276)]()-_0x2fe660['createdAt'][_0x15c804(0x21a)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x296580>=this['EXPIRY_DAYS']){console[_0x15c804(0x1d8)](_0x15c804(0x203)+_0x508487+_0x15c804(0x22f)+this[_0x15c804(0x215)]+_0x15c804(0x220)),this[_0x15c804(0x28e)](_0x508487);return;}await this[_0x15c804(0x283)](_0x508487),console['log'](_0x15c804(0x248)+_0x508487);}catch(_0x1008cf){console[_0x15c804(0x2a6)](_0x15c804(0x25d)+_0x508487+':',_0x1008cf),this[_0x15c804(0x236)](_0x508487,_0x390b2f,_0x1008cf,_0x15c804(0x21d),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x488771[_0x754b56(0x1fd)](_0x4e9339),this[_0x754b56(0x298)][_0x754b56(0x2a8)](_0x508487,{'timers':_0x488771,'paymentId':_0x508487,'gatewayPaymentId':_0x390b2f,'createdAt':_0x37d68a}),console[_0x754b56(0x1d8)](_0x754b56(0x1ed)+_0x143190[_0x754b56(0x1e4)]+_0x754b56(0x20c)+_0x508487),console[_0x754b56(0x1d8)]('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x754b56(0x298)][_0x754b56(0x22d)]),this[_0x754b56(0x1f7)](_0x508487,_0x390b2f,_0x754b56(0x2b0),_0x754b56(0x2b0),'status_check',{'action':_0x754b56(0x2a4),'scheduledChecks':_0x143190[_0x754b56(0x1e4)],'firstCheckIn':_0x143190[0x0][_0x754b56(0x210)]/0x3e8,'totalTimers':this[_0x754b56(0x298)]['size']});}[a35_0x54a389(0x28e)](_0x2af2d8){const _0x20c75d=a35_0x54a389,_0x39895e=this['paymentTimers']['get'](_0x2af2d8);_0x39895e?(console['log']('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x39895e['timers'][_0x20c75d(0x1e4)]+_0x20c75d(0x1e2)+_0x2af2d8),_0x39895e[_0x20c75d(0x275)]['forEach']((_0x27f1e4,_0x49ac1c)=>{const _0x459126=_0x20c75d;_0x27f1e4&&(clearTimeout(_0x27f1e4),clearInterval(_0x27f1e4),console['log'](_0x459126(0x259)+(_0x49ac1c+0x1)+_0x459126(0x244)+_0x2af2d8));}),this[_0x20c75d(0x298)][_0x20c75d(0x211)](_0x2af2d8),console['log'](_0x20c75d(0x212)+_0x2af2d8+_0x20c75d(0x241)+this[_0x20c75d(0x298)][_0x20c75d(0x22d)])):console[_0x20c75d(0x1d8)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x2af2d8+'\x20to\x20clear');}async['checkSinglePaymentById'](_0xdf1d22){const _0x53ec8b=a35_0x54a389;console['log'](_0x53ec8b(0x274)+_0xdf1d22);const _0x8aff1a=await database_1['default']['payment'][_0x53ec8b(0x25e)]({'where':{'id':_0xdf1d22},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x8aff1a){console[_0x53ec8b(0x1d8)]('‚ùå\x20[CHECK]\x20Payment\x20'+_0xdf1d22+'\x20not\x20found\x20in\x20database');return;}console[_0x53ec8b(0x1d8)](_0x53ec8b(0x232)+_0xdf1d22+_0x53ec8b(0x1d7)),console[_0x53ec8b(0x1d8)]('\x20\x20\x20-\x20Gateway:\x20'+_0x8aff1a['gateway']),console[_0x53ec8b(0x1d8)](_0x53ec8b(0x252)+_0x8aff1a[_0x53ec8b(0x27f)]),console[_0x53ec8b(0x1d8)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x8aff1a['gatewayPaymentId']),console[_0x53ec8b(0x1d8)](_0x53ec8b(0x24c)+_0x8aff1a[_0x53ec8b(0x284)]+'\x20'+_0x8aff1a[_0x53ec8b(0x2ad)]),console[_0x53ec8b(0x1d8)]('\x20\x20\x20-\x20ShopId:\x20'+_0x8aff1a[_0x53ec8b(0x2a0)]);if(_0x8aff1a[_0x53ec8b(0x1e6)]!=='cointopay'){console[_0x53ec8b(0x1d8)](_0x53ec8b(0x261)+_0xdf1d22+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x8aff1a[_0x53ec8b(0x1e6)]+')');return;}if(_0x8aff1a[_0x53ec8b(0x27f)]!==_0x53ec8b(0x2b0)){console['log'](_0x53ec8b(0x261)+_0xdf1d22+_0x53ec8b(0x22e)+_0x8aff1a[_0x53ec8b(0x27f)]+_0x53ec8b(0x29f)),this['clearPaymentTimers'](_0xdf1d22);return;}if(!_0x8aff1a[_0x53ec8b(0x20b)]){console[_0x53ec8b(0x1d8)](_0x53ec8b(0x261)+_0xdf1d22+_0x53ec8b(0x266));return;}console[_0x53ec8b(0x1d8)]('‚úÖ\x20[CHECK]\x20Payment\x20'+_0xdf1d22+_0x53ec8b(0x2ab)),await this[_0x53ec8b(0x200)](_0x8aff1a);}[a35_0x54a389(0x1f7)](_0x428f8c,_0x113c96,_0xed192c,_0xa4a109,_0x503805,_0x2ab291){const _0x2a254f=a35_0x54a389,_0x57da2f={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x428f8c,'gatewayPaymentId':_0x113c96,'oldStatus':_0xed192c,'newStatus':_0xa4a109,'source':_0x503805,'timestamp':new Date()[_0x2a254f(0x217)](),'details':_0x2ab291||{}};loggerService_1['loggerService'][_0x2a254f(0x1f7)](_0x57da2f),console[_0x2a254f(0x1d8)](_0x2a254f(0x247)+_0x428f8c+'\x20('+_0x113c96+')'),console[_0x2a254f(0x1d8)](_0x2a254f(0x1d5)+_0xed192c+_0x2a254f(0x279)+_0xa4a109),console[_0x2a254f(0x1d8)](_0x2a254f(0x27a)+_0x503805),console[_0x2a254f(0x1d8)](_0x2a254f(0x27b)+_0x57da2f[_0x2a254f(0x29e)]),_0x2ab291&&console['log'](_0x2a254f(0x254),_0x2ab291);}[a35_0x54a389(0x236)](_0x3f05c0,_0x55920d,_0x11946f,_0x158f48,_0x5517f7){const _0x25aff5=a35_0x54a389,_0x4545df={'type':_0x25aff5(0x1eb),'paymentId':_0x3f05c0,'gatewayPaymentId':_0x55920d,'error':_0x11946f instanceof Error?{'message':_0x11946f['message'],'stack':_0x11946f['stack']}:_0x11946f,'source':_0x158f48,'timestamp':new Date()[_0x25aff5(0x217)](),'context':_0x5517f7||{}};loggerService_1[_0x25aff5(0x286)][_0x25aff5(0x236)](_0x4545df),console[_0x25aff5(0x2a6)](_0x25aff5(0x23b)+_0x3f05c0+'\x20('+_0x55920d+')'),console[_0x25aff5(0x2a6)](_0x25aff5(0x1e8)+(_0x11946f instanceof Error?_0x11946f[_0x25aff5(0x24b)]:_0x11946f)),console[_0x25aff5(0x2a6)]('\x20\x20\x20üìç\x20Source:\x20'+_0x158f48),console[_0x25aff5(0x2a6)](_0x25aff5(0x27b)+_0x4545df['timestamp']),_0x5517f7&&console[_0x25aff5(0x2a6)](_0x25aff5(0x1e5),_0x5517f7);}[a35_0x54a389(0x208)](){const _0x4d6600=a35_0x54a389;console['log'](_0x4d6600(0x226)),this['checkAllPendingPayments']()[_0x4d6600(0x25c)](_0x34c68b=>{const _0xae4db=_0x4d6600;console['error'](_0xae4db(0x1f5),_0x34c68b);}),this[_0x4d6600(0x26f)]=setInterval(async()=>{const _0x236357=_0x4d6600;try{console['log'](_0x236357(0x29c)),await this[_0x236357(0x20e)](),console[_0x236357(0x1d8)](_0x236357(0x24e));}catch(_0x4d2dd8){console[_0x236357(0x2a6)](_0x236357(0x250),_0x4d2dd8);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x4d6600(0x1d8)]('‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a35_0x54a389(0x28f)](){const _0x4faf1b=a35_0x54a389;console[_0x4faf1b(0x1d8)](_0x4faf1b(0x2aa));this[_0x4faf1b(0x26f)]&&(clearInterval(this[_0x4faf1b(0x26f)]),this[_0x4faf1b(0x26f)]=null,console[_0x4faf1b(0x1d8)](_0x4faf1b(0x238)));const _0x4f103b=this['paymentTimers'][_0x4faf1b(0x22d)];for(const [_0x5576b6]of this[_0x4faf1b(0x298)]){this[_0x4faf1b(0x28e)](_0x5576b6);}console['log'](_0x4faf1b(0x267)+_0x4f103b+_0x4faf1b(0x2a2));}async[a35_0x54a389(0x20e)](){const _0xd441f4=a35_0x54a389;try{console['log']('ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x1702f0=await database_1[_0xd441f4(0x273)]['payment'][_0xd441f4(0x1ef)]({'where':{'gateway':_0xd441f4(0x20d),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0xd441f4(0x1d8)]('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x1702f0[_0xd441f4(0x1e4)]+'\x20pending\x20CoinToPay\x20payments');if(_0x1702f0[_0xd441f4(0x1e4)]===0x0){console[_0xd441f4(0x1d8)](_0xd441f4(0x2b1));return;}const _0x2c33df=await this['checkExpiredPayments'](_0x1702f0);console['log'](_0xd441f4(0x1fb)+_0x2c33df[_0xd441f4(0x1e4)]+_0xd441f4(0x24f));let _0x3935ba=0x0,_0x5a370c=0x0;for(const _0x4b8776 of _0x1702f0){try{if(_0x2c33df['includes'](_0x4b8776['id'])){console['log'](_0xd441f4(0x1f2)+_0x4b8776['id']+_0xd441f4(0x270)),_0x5a370c++;continue;}if(this[_0xd441f4(0x298)][_0xd441f4(0x28d)](_0x4b8776['id'])){console[_0xd441f4(0x1d8)](_0xd441f4(0x1f2)+_0x4b8776['id']+_0xd441f4(0x297)),_0x5a370c++;continue;}const _0x54211e=(Date['now']()-_0x4b8776[_0xd441f4(0x1d3)][_0xd441f4(0x21a)]())/(0x3e8*0x3c*0x3c);if(_0x54211e<0x1){console[_0xd441f4(0x1d8)](_0xd441f4(0x1f2)+_0x4b8776['id']+'\x20is\x20too\x20new\x20('+_0x54211e['toFixed'](0x1)+_0xd441f4(0x282)),_0x5a370c++;continue;}console['log'](_0xd441f4(0x213)+_0x4b8776['id']+_0xd441f4(0x281)+_0x54211e[_0xd441f4(0x1d2)](0x1)+'h)'),await this[_0xd441f4(0x200)](_0x4b8776),_0x3935ba++,await new Promise(_0xec7283=>setTimeout(_0xec7283,0x7d0));}catch(_0x1620f0){console[_0xd441f4(0x2a6)](_0xd441f4(0x29b)+_0x4b8776['id']+':',_0x1620f0),this[_0xd441f4(0x236)](_0x4b8776['id'],_0x4b8776[_0xd441f4(0x20b)]||_0xd441f4(0x225),_0x1620f0,_0xd441f4(0x21d),{'isGlobalCheck':!![],'paymentAmount':_0x4b8776[_0xd441f4(0x284)],'paymentCurrency':_0x4b8776[_0xd441f4(0x2ad)],'shopId':_0x4b8776[_0xd441f4(0x2a0)],'createdAt':_0x4b8776['createdAt']}),loggerService_1[_0xd441f4(0x286)]['logWhiteDomainError'](_0xd441f4(0x20d),'/status/'+_0x4b8776[_0xd441f4(0x20b)],_0x1620f0);}}console[_0xd441f4(0x1d8)](_0xd441f4(0x27d)+_0x3935ba+_0xd441f4(0x28c)+_0x5a370c+_0xd441f4(0x209)+_0x2c33df['length']+'\x20expired');}catch(_0x534035){console[_0xd441f4(0x2a6)](_0xd441f4(0x29d),_0x534035);}}async[a35_0x54a389(0x21e)](_0x40ab42){const _0x1d2d99=a35_0x54a389,_0x2554ba=[],_0x58e196=new Date();_0x58e196[_0x1d2d99(0x291)](_0x58e196[_0x1d2d99(0x251)]()-this[_0x1d2d99(0x215)]),console[_0x1d2d99(0x1d8)](_0x1d2d99(0x296)+this[_0x1d2d99(0x215)]+_0x1d2d99(0x228)+_0x58e196[_0x1d2d99(0x217)]()+')');for(const _0x2d902b of _0x40ab42){if(_0x2d902b[_0x1d2d99(0x1d3)]<_0x58e196){console[_0x1d2d99(0x1d8)](_0x1d2d99(0x230)+_0x2d902b['id']+'\x20is\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{this['logCoinToPayStatus'](_0x2d902b['id'],_0x2d902b[_0x1d2d99(0x20b)]||_0x1d2d99(0x225),_0x1d2d99(0x2b0),_0x1d2d99(0x227),_0x1d2d99(0x1de),{'reason':_0x1d2d99(0x235)+this[_0x1d2d99(0x215)]+_0x1d2d99(0x1d6),'createdAt':_0x2d902b[_0x1d2d99(0x1d3)],'daysSinceCreation':Math[_0x1d2d99(0x26e)]((Date['now']()-_0x2d902b[_0x1d2d99(0x1d3)][_0x1d2d99(0x21a)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x2d902b['amount'],'paymentCurrency':_0x2d902b[_0x1d2d99(0x2ad)],'shopId':_0x2d902b[_0x1d2d99(0x2a0)]}),await database_1['default']['payment']['update']({'where':{'id':_0x2d902b['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x1d2d99(0x239)+this[_0x1d2d99(0x215)]+_0x1d2d99(0x24d)}}),await database_1[_0x1d2d99(0x273)][_0x1d2d99(0x1f9)]['create']({'data':{'paymentId':_0x2d902b['id'],'shopId':_0x2d902b[_0x1d2d99(0x2a0)],'event':_0x1d2d99(0x1df),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x1d2d99(0x235)+this[_0x1d2d99(0x215)]+_0x1d2d99(0x1d6),'createdAt':_0x2d902b[_0x1d2d99(0x1d3)],'expiredAt':new Date()[_0x1d2d99(0x217)](),'daysSinceCreation':Math[_0x1d2d99(0x26e)]((Date[_0x1d2d99(0x276)]()-_0x2d902b[_0x1d2d99(0x1d3)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x1d2d99(0x2ae)](_0x2d902b,_0x1d2d99(0x227)),await this['sendPaymentStatusNotification'](_0x2d902b,_0x1d2d99(0x227)),this[_0x1d2d99(0x28e)](_0x2d902b['id']),_0x2554ba[_0x1d2d99(0x1fd)](_0x2d902b['id']),console[_0x1d2d99(0x1d8)](_0x1d2d99(0x262)+_0x2d902b['id']+_0x1d2d99(0x25f)+this[_0x1d2d99(0x215)]+_0x1d2d99(0x204));}catch(_0x1786e1){console[_0x1d2d99(0x2a6)](_0x1d2d99(0x1e9)+_0x2d902b['id']+':',_0x1786e1),this['logCoinToPayError'](_0x2d902b['id'],_0x2d902b[_0x1d2d99(0x20b)]||_0x1d2d99(0x225),_0x1786e1,_0x1d2d99(0x1de),{'reason':_0x1d2d99(0x21f),'createdAt':_0x2d902b[_0x1d2d99(0x1d3)],'daysSinceCreation':Math[_0x1d2d99(0x26e)]((Date['now']()-_0x2d902b[_0x1d2d99(0x1d3)][_0x1d2d99(0x21a)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x2554ba;}async[a35_0x54a389(0x200)](_0x1a9980){const _0x5980f5=a35_0x54a389;if(!_0x1a9980[_0x5980f5(0x20b)]){console[_0x5980f5(0x1d8)](_0x5980f5(0x261)+_0x1a9980['id']+_0x5980f5(0x290));return;}console[_0x5980f5(0x1d8)]('üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x1a9980['id']+'\x20('+_0x1a9980[_0x5980f5(0x20b)]+')');try{const _0x1fc1dd=await this[_0x5980f5(0x1ec)][_0x5980f5(0x243)](_0x1a9980['gatewayPaymentId']);console[_0x5980f5(0x1d8)]('üìä\x20[CHECK]\x20Payment\x20'+_0x1a9980['id']+_0x5980f5(0x1fe)+_0x1fc1dd['status']);_0x1fc1dd[_0x5980f5(0x21b)]&&console[_0x5980f5(0x1d8)](_0x5980f5(0x232)+_0x1a9980['id']+'\x20details:',{'iban':_0x1fc1dd[_0x5980f5(0x21b)]['iban']||'not\x20found','transactionId':_0x1fc1dd[_0x5980f5(0x21b)]['transactionId'],'createdOn':_0x1fc1dd[_0x5980f5(0x21b)][_0x5980f5(0x1ea)],'confirmedOn':_0x1fc1dd[_0x5980f5(0x21b)][_0x5980f5(0x23d)]||_0x5980f5(0x292)});if(_0x1fc1dd[_0x5980f5(0x27f)]!==_0x1a9980[_0x5980f5(0x27f)]){console[_0x5980f5(0x1d8)](_0x5980f5(0x1dc)+_0x1a9980['id']+'\x20status\x20from\x20'+_0x1a9980[_0x5980f5(0x27f)]+'\x20to\x20'+_0x1fc1dd[_0x5980f5(0x27f)]),this[_0x5980f5(0x1f7)](_0x1a9980['id'],_0x1a9980[_0x5980f5(0x20b)],_0x1a9980[_0x5980f5(0x27f)],_0x1fc1dd['status'],_0x5980f5(0x21d),{'paymentDetails':_0x1fc1dd[_0x5980f5(0x21b)],'amount':_0x1fc1dd[_0x5980f5(0x284)],'currency':_0x1fc1dd['currency'],'shopId':_0x1a9980[_0x5980f5(0x2a0)],'checkTimestamp':new Date()[_0x5980f5(0x217)]()});const _0x20fb1a={'status':_0x1fc1dd[_0x5980f5(0x27f)],'updatedAt':new Date()};_0x1fc1dd[_0x5980f5(0x27f)]===_0x5980f5(0x1da)&&_0x1a9980['status']!=='PAID'&&(_0x20fb1a[_0x5980f5(0x257)]=new Date(),console['log'](_0x5980f5(0x224)+_0x1a9980['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x20fb1a[_0x5980f5(0x257)][_0x5980f5(0x217)]()));if(_0x1fc1dd[_0x5980f5(0x21b)]){const _0x21235a=_0x1fc1dd[_0x5980f5(0x21b)];_0x21235a[_0x5980f5(0x242)]&&(_0x20fb1a[_0x5980f5(0x27c)]=_0x21235a[_0x5980f5(0x242)],console[_0x5980f5(0x1d8)](_0x5980f5(0x22b)+_0x21235a['iban']));if(_0x21235a[_0x5980f5(0x285)]){const _0x1b583a=_0x1a9980['adminNotes']||'',_0x2c3afd=_0x5980f5(0x222)+_0x21235a[_0x5980f5(0x285)];_0x20fb1a['adminNotes']=_0x1b583a?_0x1b583a+'\x0a\x0a'+_0x2c3afd:_0x2c3afd,console['log'](_0x5980f5(0x240));}_0x21235a['transactionId']&&console[_0x5980f5(0x1d8)](_0x5980f5(0x288)+_0x21235a[_0x5980f5(0x1f3)]),_0x21235a['confirmedOn']&&console[_0x5980f5(0x1d8)]('‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x21235a[_0x5980f5(0x23d)]);}await database_1[_0x5980f5(0x273)]['payment'][_0x5980f5(0x265)]({'where':{'id':_0x1a9980['id']},'data':_0x20fb1a}),await database_1[_0x5980f5(0x273)][_0x5980f5(0x1f9)][_0x5980f5(0x20a)]({'data':{'paymentId':_0x1a9980['id'],'shopId':_0x1a9980[_0x5980f5(0x2a0)],'event':'cointopay_status_check_'+_0x1fc1dd[_0x5980f5(0x27f)][_0x5980f5(0x294)](),'statusCode':0xc8,'responseBody':JSON[_0x5980f5(0x1ee)]({'oldStatus':_0x1a9980['status'],'newStatus':_0x1fc1dd[_0x5980f5(0x27f)],'paymentDetails':_0x1fc1dd[_0x5980f5(0x21b)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x5980f5(0x2ae)](_0x1a9980,_0x1fc1dd[_0x5980f5(0x27f)]),await this[_0x5980f5(0x245)](_0x1a9980,_0x1fc1dd[_0x5980f5(0x27f)]),_0x1fc1dd['status']!==_0x5980f5(0x2b0)&&(console[_0x5980f5(0x1d8)](_0x5980f5(0x206)+_0x1a9980['id']+_0x5980f5(0x237)+_0x1fc1dd[_0x5980f5(0x27f)]+',\x20clearing\x20individual\x20timers'),this[_0x5980f5(0x28e)](_0x1a9980['id'])),console[_0x5980f5(0x1d8)](_0x5980f5(0x249)+_0x1a9980['id']+_0x5980f5(0x218));}else console[_0x5980f5(0x1d8)](_0x5980f5(0x232)+_0x1a9980['id']+'\x20status\x20unchanged\x20('+_0x1fc1dd['status']+')'),this['logCoinToPayStatus'](_0x1a9980['id'],_0x1a9980[_0x5980f5(0x20b)],_0x1a9980[_0x5980f5(0x27f)],_0x1fc1dd[_0x5980f5(0x27f)],_0x5980f5(0x21d),{'statusUnchanged':!![],'paymentDetails':_0x1fc1dd[_0x5980f5(0x21b)],'amount':_0x1fc1dd[_0x5980f5(0x284)],'currency':_0x1fc1dd[_0x5980f5(0x2ad)],'shopId':_0x1a9980['shopId'],'checkTimestamp':new Date()[_0x5980f5(0x217)]()});}catch(_0x18d884){console[_0x5980f5(0x2a6)](_0x5980f5(0x23e)+_0x1a9980['id']+':',_0x18d884),this[_0x5980f5(0x236)](_0x1a9980['id'],_0x1a9980[_0x5980f5(0x20b)],_0x18d884,'status_check',{'paymentAmount':_0x1a9980[_0x5980f5(0x284)],'paymentCurrency':_0x1a9980[_0x5980f5(0x2ad)],'shopId':_0x1a9980['shopId'],'createdAt':_0x1a9980[_0x5980f5(0x1d3)]}),await database_1['default']['webhookLog'][_0x5980f5(0x20a)]({'data':{'paymentId':_0x1a9980['id'],'shopId':_0x1a9980['shopId'],'event':_0x5980f5(0x207),'statusCode':0x1f4,'responseBody':JSON[_0x5980f5(0x1ee)]({'error':_0x18d884 instanceof Error?_0x18d884['message']:'Unknown\x20error','gatewayPaymentId':_0x1a9980[_0x5980f5(0x20b)],'checkedAt':new Date()[_0x5980f5(0x217)]()})}});}}async[a35_0x54a389(0x2ae)](_0xf384f9,_0x590ef4){const _0x1e298b=a35_0x54a389,_0x160767=Date[_0x1e298b(0x276)]();try{const _0x113983=_0xf384f9['shop'],_0x201de7=_0x113983[_0x1e298b(0x289)];if(!_0x201de7?.[_0x1e298b(0x23c)]){console[_0x1e298b(0x1d8)](_0x1e298b(0x277)+_0x113983['id']);return;}const _0x2eae47=_0x590ef4===_0x1e298b(0x1da)?_0x1e298b(0x231):_0x590ef4===_0x1e298b(0x1d9)?_0x1e298b(0x20f):_0x590ef4===_0x1e298b(0x227)?'payment.failed':_0x1e298b(0x1e3);if(!_0x201de7[_0x1e298b(0x219)]?.[_0x1e298b(0x25b)](_0x2eae47)){console['log']('Webhook\x20event\x20'+_0x2eae47+_0x1e298b(0x293)+_0x113983['id']);return;}const _0x902e13={'event':_0x2eae47,'payment':{'id':_0xf384f9['id'],'order_id':_0xf384f9[_0x1e298b(0x233)],'gateway_order_id':_0xf384f9[_0x1e298b(0x299)],'gateway':'0100','amount':_0xf384f9['amount'],'currency':_0xf384f9[_0x1e298b(0x2ad)],'status':_0x590ef4[_0x1e298b(0x294)](),'customer_email':_0xf384f9['customerEmail'],'customer_name':_0xf384f9['customerName'],'created_at':_0xf384f9[_0x1e298b(0x1d3)],'updated_at':new Date()}},_0x57f2eb=await fetch(_0x201de7[_0x1e298b(0x23c)],{'method':_0x1e298b(0x260),'headers':{'Content-Type':_0x1e298b(0x272),'User-Agent':_0x1e298b(0x1e7)},'body':JSON[_0x1e298b(0x1ee)](_0x902e13)}),_0x1e771b=Date['now']()-_0x160767,_0x13408d=_0x57f2eb['ok']?_0x1e298b(0x1fa):await _0x57f2eb['text']();loggerService_1['loggerService'][_0x1e298b(0x255)](_0xf384f9[_0x1e298b(0x2a0)],_0x201de7[_0x1e298b(0x23c)],_0x2eae47,_0x57f2eb['status'],_0x1e771b,_0x902e13),console[_0x1e298b(0x1d8)](_0x1e298b(0x2ac)+_0x201de7['webhookUrl']+_0x1e298b(0x1fc)+_0x57f2eb['status']+'\x20('+_0x1e771b+_0x1e298b(0x1d4));}catch(_0xb5e4b8){console['error'](_0x1e298b(0x29a),_0xb5e4b8),loggerService_1[_0x1e298b(0x286)]['logShopWebhookError'](_0xf384f9[_0x1e298b(0x2a0)],_0xf384f9[_0x1e298b(0x271)]?.[_0x1e298b(0x289)]?.[_0x1e298b(0x23c)]||_0x1e298b(0x225),_0x1e298b(0x263),_0xb5e4b8,{});}}async['sendPaymentStatusNotification'](_0xeb9f95,_0x1faffc){const _0x31224e=a35_0x54a389;try{const _0x204050={'PENDING':'created','PAID':_0x31224e(0x1dd),'FAILED':_0x31224e(0x1f0),'EXPIRED':_0x31224e(0x22c)},_0x1cfe5b=_0x204050[_0x1faffc];if(!_0x1cfe5b||_0x1cfe5b===_0x31224e(0x2a7))return;await telegramBotService_1[_0x31224e(0x201)][_0x31224e(0x1db)](_0xeb9f95['shopId'],_0xeb9f95,_0x1cfe5b);}catch(_0x28c93a){console['error'](_0x31224e(0x2a9),_0x28c93a);}}async['checkPaymentById'](_0x2101f3){const _0x163f68=a35_0x54a389;console[_0x163f68(0x1d8)]('üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x2101f3);const _0x20c2a3=await database_1[_0x163f68(0x273)][_0x163f68(0x1e1)][_0x163f68(0x25e)]({'where':{'id':_0x2101f3},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x20c2a3)throw new Error('Payment\x20not\x20found');if(_0x20c2a3[_0x163f68(0x1e6)]!==_0x163f68(0x20d))throw new Error(_0x163f68(0x1ff));console[_0x163f68(0x1d8)](_0x163f68(0x256)+_0x2101f3),await this['checkSinglePayment'](_0x20c2a3),console['log']('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x2101f3);}[a35_0x54a389(0x28a)](){const _0x474fbe=a35_0x54a389,_0x394a47=this['globalCheckInterval']?this[_0x474fbe(0x1f1)]:undefined,_0xf36551=Array[_0x474fbe(0x264)](this[_0x474fbe(0x298)][_0x474fbe(0x253)]())['map'](_0x2aa92b=>({'paymentId':_0x2aa92b[_0x474fbe(0x216)],'gatewayPaymentId':_0x2aa92b['gatewayPaymentId'],'createdAt':_0x2aa92b[_0x474fbe(0x1d3)],'timersCount':_0x2aa92b[_0x474fbe(0x275)][_0x474fbe(0x1e4)]}));return{'isActive':!!this[_0x474fbe(0x26f)],'globalCheckIntervalMinutes':this[_0x474fbe(0x1f1)]/(0x3e8*0x3c),'expiryDays':this[_0x474fbe(0x215)],'activeIndividualTimers':this[_0x474fbe(0x298)]['size'],'nextGlobalCheckIn':_0x394a47,'paymentTimersDetails':_0xf36551};}[a35_0x54a389(0x23f)](_0x2aaafc){const _0x7f111d=a35_0x54a389,_0x4d9b65=this[_0x7f111d(0x298)][_0x7f111d(0x2a1)](_0x2aaafc);if(_0x4d9b65)return{'hasTimers':!![],'timersCount':_0x4d9b65[_0x7f111d(0x275)][_0x7f111d(0x1e4)],'createdAt':_0x4d9b65['createdAt'],'gatewayPaymentId':_0x4d9b65[_0x7f111d(0x20b)]};return{'hasTimers':![]};}}function a35_0x5bf9(){const _0x444e72=['\x20\x20\x20-\x20Amount:\x20','\x20days\x20without\x20payment\x20confirmation','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20expired\x20CoinToPay\x20payments','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','getDate','\x20\x20\x20-\x20Status:\x20','values','\x20\x20\x20üìù\x20Details:','logShopWebhookSent','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','paidAt','forEach','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','includes','catch','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','findUnique','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','POST','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','‚úÖ\x20[EXPIRY]\x20Payment\x20','webhook_send','from','update','\x20has\x20no\x20gatewayPaymentId','üõë\x20[SHUTDOWN]\x20Cleared\x20','27EHTeKX','900740oYPjPA','2456458WhVfKz','5\x20minutes','2\x20minutes','./loggerService','floor','globalCheckInterval','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','shop','application/json','default','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','timers','now','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','coinToPayStatusService','\x20->\x20','\x20\x20\x20üìç\x20Source:\x20','\x20\x20\x20üìÖ\x20Time:\x20','remitterIban','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','CoinToPayService','status','1\x20minute','\x20(age:\x20','h),\x20skipping\x20global\x20check','checkSinglePaymentById','amount','bankDetails','loggerService','\x20in\x20','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','settings','getServiceStats','üìä\x20[HOURLY]\x20Payment\x20','\x20checked,\x20','has','clearPaymentTimers','stopPeriodicStatusCheck','\x20has\x20no\x20gatewayPaymentId,\x20skipping','setDate','not\x20confirmed','\x20not\x20enabled\x20for\x20shop\x20','toLowerCase','8863708VvbsWP','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','paymentTimers','gatewayOrderId','Failed\x20to\x20send\x20shop\x20webhook:','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','timestamp',',\x20stopping\x20individual\x20checks','shopId','get','\x20individual\x20payment\x20timers','\x20triggered\x20for\x20payment\x20','schedule_created','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','error','created','set','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20is\x20valid\x20for\x20checking,\x20proceeding...','Shop\x20webhook\x20sent\x20to\x20','currency','sendShopWebhook','36eAwBPv','PENDING','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','toFixed','createdAt','ms)','\x20\x20\x20üìä\x20Status:\x20','\x20days','\x20found:','log','FAILED','PAID','sendPaymentNotification','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','paid','auto_expire','cointopay_auto_expired','524644JJfIes','payment','\x20timers\x20for\x20payment\x20','payment.pending','length','\x20\x20\x20üìù\x20Context:','gateway','TesSoft\x20Payment\x20System/1.0','\x20\x20\x20‚ùå\x20Error:\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','createdOn','COINTOPAY_ERROR','coinToPayService','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','stringify','findMany','failed','GLOBAL_CHECK_INTERVAL_MS','‚è∞\x20[GLOBAL]\x20Payment\x20','transactionId','schedulePaymentChecks','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','CoinToPayStatusService','logCoinToPayStatus','35644631YumIBw','webhookLog','Success','‚è∞\x20[GLOBAL]\x20Found\x20','\x20with\x20status\x20','push','\x20status:\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','checkSinglePayment','telegramBotService','\x20(after\x20','‚è∞\x20[HOURLY]\x20Payment\x20','-day\x20timeout','114jnVjGE','üßπ\x20[CHECK]\x20Payment\x20','cointopay_status_check_error','startPeriodicStatusCheck','\x20skipped,\x20','create','gatewayPaymentId','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','cointopay','checkAllPendingPayments','payment.failed','delay','delete','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','\x20not\x20found,\x20clearing\x20timers','EXPIRY_DAYS','paymentId','toISOString','\x20updated\x20successfully','webhookEvents','getTime','paymentDetails','634776DuSYSy','status_check','checkExpiredPayments','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','__importDefault','Bank\x20Details:\x20','description','üí∞\x20[CHECK]\x20Payment\x20','unknown','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','EXPIRED','\x20days\x20(created\x20before\x20','1JGUZsv','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','expired','size','\x20status\x20is\x20','\x20is\x20older\x20than\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','payment.success','üìä\x20[CHECK]\x20Payment\x20','orderId','93430LEyKpk','Payment\x20older\x20than\x20','logCoinToPayError','\x20status\x20changed\x20to\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','Automatically\x20expired\x20after\x20','__esModule','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','webhookUrl','confirmedOn','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','getPaymentTimerInfo','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','.\x20Remaining\x20active\x20timers:\x20','iban','checkPaymentStatus','\x20for\x20payment\x20','sendPaymentStatusNotification','\x20\x20\x20-\x20paymentId:\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','‚úÖ\x20[CHECK]\x20Payment\x20','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','message'];a35_0x5bf9=function(){return _0x444e72;};return a35_0x5bf9();}function a35_0x38e3(_0x2398e2,_0x211d28){const _0x5bf90e=a35_0x5bf9();return a35_0x38e3=function(_0x38e31e,_0x56181e){_0x38e31e=_0x38e31e-0x1d2;let _0x2a0a5b=_0x5bf90e[_0x38e31e];return _0x2a0a5b;},a35_0x38e3(_0x2398e2,_0x211d28);}exports[a35_0x54a389(0x1f6)]=CoinToPayStatusService,exports[a35_0x54a389(0x278)]=new CoinToPayStatusService();