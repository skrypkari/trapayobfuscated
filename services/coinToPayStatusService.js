'use strict';const a37_0x51616f=a37_0x4dc5;(function(_0x2ee011,_0x57449d){const _0x3a184d=a37_0x4dc5,_0x215fae=_0x2ee011();while(!![]){try{const _0x52987d=parseInt(_0x3a184d(0x1fd))/0x1+parseInt(_0x3a184d(0x1e1))/0x2+-parseInt(_0x3a184d(0x209))/0x3+-parseInt(_0x3a184d(0x125))/0x4*(-parseInt(_0x3a184d(0x1d2))/0x5)+parseInt(_0x3a184d(0x1a4))/0x6*(-parseInt(_0x3a184d(0x138))/0x7)+-parseInt(_0x3a184d(0x1d8))/0x8+-parseInt(_0x3a184d(0x145))/0x9*(-parseInt(_0x3a184d(0x159))/0xa);if(_0x52987d===_0x57449d)break;else _0x215fae['push'](_0x215fae['shift']());}catch(_0x337a74){_0x215fae['push'](_0x215fae['shift']());}}}(a37_0x1e5b,0x5d066));function a37_0x4dc5(_0x1ef1b4,_0x1cecd7){const _0x1e5b43=a37_0x1e5b();return a37_0x4dc5=function(_0x4dc5dc,_0x2da00d){_0x4dc5dc=_0x4dc5dc-0x125;let _0x23b81c=_0x1e5b43[_0x4dc5dc];return _0x23b81c;},a37_0x4dc5(_0x1ef1b4,_0x1cecd7);}function a37_0x1e5b(){const _0x4d1d58=['0100','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','EXPIRED','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','forEach','\x20completed\x20for\x20payment\x20','auto_expire','checkSinglePaymentById','Payment\x20older\x20than\x20','🪙\x20[GLOBAL]\x20Found\x20','floor','2185917jMjeAB','\x20current\x20status:\x20','timestamp','4znuiwT','schedulePaymentChecks','toLowerCase','create','createdOn','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','paidAt','delay','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20->\x20','🛑\x20[SHUTDOWN]\x20Cleared\x20','📊\x20[CHECK]\x20Payment\x20','payment.pending','\x20status\x20from\x20','paymentId','💰\x20[CHECK]\x20Payment\x20','checkPaymentStatus','schedule_created','Shop\x20webhook\x20sent\x20to\x20','2926168lGMJWC','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','/status/','findMany','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','shopId','\x20not\x20found\x20in\x20database','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','webhook_send','🔄\x20[CHECK]\x20Updating\x20payment\x20','logShopWebhookError','4491TkAeWT','.\x20Remaining\x20active\x20timers:\x20','loggerService','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','getTime','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','CoinToPayService','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20has\x20no\x20gatewayPaymentId','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20\x20\x20📍\x20Source:\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','logCoinToPayError','confirmedOn','🪙\x20[DEBUG]\x20Creating\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20checked,\x20','🪙\x20CoinToPayStatusService\x20initialized','-day\x20timeout','webhookUrl','23810bqOGqr','status_check',',\x20stopping\x20individual\x20checks','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','⏰\x20[GLOBAL]\x20Found\x20','sendShopWebhook','set','webhookLog','unknown','\x20status\x20changed\x20to\x20','logCoinToPayStatus','PENDING','logShopWebhookSent','\x20\x20\x20📝\x20Context:','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20pending\x20CoinToPay\x20payments','\x20details:','\x20status\x20unchanged\x20(','not\x20found','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','delete','PAID','log','amount','iban','size','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','Payment\x20not\x20found','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20days','coinToPayStatusService','from','⚠️\x20[CHECK]\x20Payment\x20','payment.success','2\x20minutes','POST','\x20triggered\x20for\x20payment\x20','⏰\x20[GLOBAL]\x20Payment\x20','settings','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','getPaymentTimerInfo','text','application/json','bankDetails','now','stopPeriodicStatusCheck','description','sendPaymentStatusNotification','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','defineProperty','payment.failed','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','✅\x20[CHECK]\x20Payment\x20','TesSoft\x20Payment\x20System/1.0','🧹\x20[CHECK]\x20Payment\x20','❌\x20[HOURLY]\x20Payment\x20','\x20(age:\x20','__esModule','length','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','get','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','clearPaymentTimers','message','\x20is\x20older\x20than\x20','logWhiteDomainError','toISOString','cointopay','\x20for\x20payment\x20','5\x20minutes','✅\x20[HOURLY]\x20Payment\x20','map','stringify','\x20to\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','6sdYvkQ','Success','\x20days,\x20marking\x20as\x20EXPIRED','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','\x20\x20\x20📅\x20Time:\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','coinToPayService','findUnique','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','gatewayPaymentId','Failed\x20to\x20mark\x20payment\x20as\x20expired','has','default','timers','cointopay_status_check_error','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','❌\x20[CHECK]\x20Payment\x20','\x20updated\x20successfully','checkAllPendingPayments','\x20\x20\x20📝\x20Details:','1\x20minute','values','Bank\x20Details:\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','error','\x20seconds\x20(','GLOBAL_CHECK_INTERVAL_MS','orderId','status','\x20status:\x20','checkSinglePayment','\x20\x20\x20-\x20Gateway:\x20','h),\x20skipping\x20global\x20check','created','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20found:','\x20(after\x20','\x20\x20\x20❌\x20Error:\x20','\x20\x20\x20📊\x20Status:\x20','FAILED','paymentTimers','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','CoinToPayStatusService','transactionId','1014655BTcKYR','\x20\x20\x20-\x20Status:\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','currency','catch','startPeriodicStatusCheck','4885288zOYUnN','payment','\x20skipped,\x20','\x20\x20\x20-\x20Amount:\x20','gateway','paymentDetails','EXPIRY_DAYS',',\x20clearing\x20individual\x20timers','push','143936CYcKMF','failed','\x20is\x20too\x20new\x20(','\x20status\x20is\x20','toFixed','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','⏰\x20[HOURLY]\x20Payment\x20','cointopay_auto_expired','\x20is\x20valid\x20for\x20checking,\x20proceeding...','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','shop','webhookEvents','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20expired','./gateways/coinToPayService','✅\x20[EXPIRY]\x20Payment\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','\x20\x20\x20-\x20ShopId:\x20','globalCheckInterval','\x20not\x20enabled\x20for\x20shop\x20','checkExpiredPayments','⏰\x20[EXPIRY]\x20Payment\x20','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20with\x20status\x20','createdAt','\x20days\x20without\x20payment\x20confirmation','Automatically\x20expired\x20after\x20','\x20individual\x20payment\x20timers','675336reNnPY'];a37_0x1e5b=function(){return _0x4d1d58;};return a37_0x1e5b();}var __importDefault=this&&this['__importDefault']||function(_0x3cb9f1){return _0x3cb9f1&&_0x3cb9f1['__esModule']?_0x3cb9f1:{'default':_0x3cb9f1};};Object[a37_0x51616f(0x18a)](exports,a37_0x51616f(0x192),{'value':!![]}),exports[a37_0x51616f(0x177)]=exports[a37_0x51616f(0x1d0)]=void 0x0;const coinToPayService_1=require(a37_0x51616f(0x1ef)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x25d2da=a37_0x51616f;this['globalCheckInterval']=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x25d2da(0x1de)]=0x5,this['paymentTimers']=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x25d2da(0x14b))](),console[_0x25d2da(0x16f)](_0x25d2da(0x156));}[a37_0x51616f(0x126)](_0x124c47,_0x2d6649){const _0x2ad8e8=a37_0x51616f;console[_0x2ad8e8(0x16f)](_0x2ad8e8(0x12a)),console[_0x2ad8e8(0x16f)]('\x20\x20\x20-\x20paymentId:\x20'+_0x124c47),console['log'](_0x2ad8e8(0x1bd)+_0x2d6649),this[_0x2ad8e8(0x197)](_0x124c47);const _0x22a707=[],_0x25d9a0=new Date(),_0x11b4e8=[{'delay':0x1*0x3c*0x3e8,'description':_0x2ad8e8(0x1ba)},{'delay':0x2*0x3c*0x3e8,'description':_0x2ad8e8(0x17b)},{'delay':0x5*0x3c*0x3e8,'description':_0x2ad8e8(0x19e)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console['log'](_0x2ad8e8(0x153)+_0x11b4e8['length']+'\x20initial\x20timers\x20for\x20payment\x20'+_0x124c47);let _0x1c7a5a=0x0;_0x11b4e8[_0x2ad8e8(0x202)]((_0x19779e,_0x111b94)=>{const _0x5bdb81=_0x2ad8e8;_0x1c7a5a+=_0x19779e[_0x5bdb81(0x12c)];const _0x58ce50=setTimeout(async()=>{const _0x2e1523=_0x5bdb81;console[_0x2e1523(0x16f)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x111b94+0x1)+_0x2e1523(0x17d)+_0x124c47+_0x2e1523(0x1ca)+_0x19779e[_0x2e1523(0x187)]+')');try{await this[_0x2e1523(0x205)](_0x124c47),console[_0x2e1523(0x16f)](_0x2e1523(0x1f1)+(_0x111b94+0x1)+_0x2e1523(0x203)+_0x124c47);}catch(_0xe26403){console[_0x2e1523(0x1be)](_0x2e1523(0x13f)+(_0x111b94+0x1)+'\x20for\x20payment\x20'+_0x124c47+':',_0xe26403),this[_0x2e1523(0x151)](_0x124c47,_0x2d6649,_0xe26403,'status_check',{'checkNumber':_0x111b94+0x1,'scheduledAfter':_0x19779e[_0x2e1523(0x187)],'isIndividualCheck':!![]});}},_0x1c7a5a);_0x22a707[_0x5bdb81(0x1e0)](_0x58ce50),console[_0x5bdb81(0x16f)](_0x5bdb81(0x1ad)+(_0x111b94+0x1)+_0x5bdb81(0x19d)+_0x124c47+'\x20in\x20'+_0x1c7a5a/0x3e8+_0x5bdb81(0x1bf)+_0x19779e[_0x5bdb81(0x187)]+')');});const _0x31843e=setInterval(async()=>{const _0xcc11eb=_0x2ad8e8;console[_0xcc11eb(0x16f)](_0xcc11eb(0x180)+_0x124c47);try{const _0x92448f=await database_1['default'][_0xcc11eb(0x1d9)][_0xcc11eb(0x1ac)]({'where':{'id':_0x124c47},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x92448f){console[_0xcc11eb(0x16f)](_0xcc11eb(0x190)+_0x124c47+'\x20not\x20found,\x20clearing\x20timers'),this[_0xcc11eb(0x197)](_0x124c47);return;}console[_0xcc11eb(0x16f)]('📊\x20[HOURLY]\x20Payment\x20'+_0x124c47+_0xcc11eb(0x20a)+_0x92448f[_0xcc11eb(0x1c2)]);if(_0x92448f[_0xcc11eb(0x1c2)]!==_0xcc11eb(0x164)){console['log'](_0xcc11eb(0x19f)+_0x124c47+_0xcc11eb(0x1e4)+_0x92448f[_0xcc11eb(0x1c2)]+_0xcc11eb(0x15b)),this['clearPaymentTimers'](_0x124c47);return;}const _0xefe1e1=Math[_0xcc11eb(0x208)]((Date['now']()-_0x92448f[_0xcc11eb(0x1f9)][_0xcc11eb(0x149)]())/(0x3e8*0x3c*0x3c*0x18));if(_0xefe1e1>=this[_0xcc11eb(0x1de)]){console[_0xcc11eb(0x16f)](_0xcc11eb(0x1e7)+_0x124c47+_0xcc11eb(0x199)+this['EXPIRY_DAYS']+_0xcc11eb(0x167)),this[_0xcc11eb(0x197)](_0x124c47);return;}await this[_0xcc11eb(0x205)](_0x124c47),console[_0xcc11eb(0x16f)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x124c47);}catch(_0x469d87){console[_0xcc11eb(0x1be)](_0xcc11eb(0x1f7)+_0x124c47+':',_0x469d87),this[_0xcc11eb(0x151)](_0x124c47,_0x2d6649,_0x469d87,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x22a707[_0x2ad8e8(0x1e0)](_0x31843e),this[_0x2ad8e8(0x1ce)][_0x2ad8e8(0x15f)](_0x124c47,{'timers':_0x22a707,'paymentId':_0x124c47,'gatewayPaymentId':_0x2d6649,'createdAt':_0x25d9a0}),console['log'](_0x2ad8e8(0x1aa)+_0x11b4e8[_0x2ad8e8(0x193)]+_0x2ad8e8(0x15c)+_0x124c47),console['log'](_0x2ad8e8(0x14e)+this[_0x2ad8e8(0x1ce)]['size']),this['logCoinToPayStatus'](_0x124c47,_0x2d6649,_0x2ad8e8(0x164),_0x2ad8e8(0x164),_0x2ad8e8(0x15a),{'action':_0x2ad8e8(0x136),'scheduledChecks':_0x11b4e8['length'],'firstCheckIn':_0x11b4e8[0x0]['delay']/0x3e8,'totalTimers':this[_0x2ad8e8(0x1ce)][_0x2ad8e8(0x172)]});}[a37_0x51616f(0x197)](_0xbe7c11){const _0x5ba763=a37_0x51616f,_0x4f2ade=this['paymentTimers']['get'](_0xbe7c11);_0x4f2ade?(console[_0x5ba763(0x16f)]('🧹\x20[DEBUG]\x20Clearing\x20'+_0x4f2ade['timers'][_0x5ba763(0x193)]+'\x20timers\x20for\x20payment\x20'+_0xbe7c11),_0x4f2ade[_0x5ba763(0x1b3)]['forEach']((_0x2b0131,_0xa7df1b)=>{const _0x4b2571=_0x5ba763;_0x2b0131&&(clearTimeout(_0x2b0131),clearInterval(_0x2b0131),console['log'](_0x4b2571(0x16c)+(_0xa7df1b+0x1)+'\x20for\x20payment\x20'+_0xbe7c11));}),this['paymentTimers'][_0x5ba763(0x16d)](_0xbe7c11),console[_0x5ba763(0x16f)](_0x5ba763(0x1ea)+_0xbe7c11+_0x5ba763(0x146)+this[_0x5ba763(0x1ce)][_0x5ba763(0x172)])):console[_0x5ba763(0x16f)]('⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0xbe7c11+'\x20to\x20clear');}async['checkSinglePaymentById'](_0x222ac2){const _0x3a4cc4=a37_0x51616f;console[_0x3a4cc4(0x16f)](_0x3a4cc4(0x1ae)+_0x222ac2);const _0x17db59=await database_1[_0x3a4cc4(0x1b2)][_0x3a4cc4(0x1d9)][_0x3a4cc4(0x1ac)]({'where':{'id':_0x222ac2},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x17db59){console[_0x3a4cc4(0x16f)](_0x3a4cc4(0x1b6)+_0x222ac2+_0x3a4cc4(0x13e));return;}console[_0x3a4cc4(0x16f)](_0x3a4cc4(0x130)+_0x222ac2+_0x3a4cc4(0x1c9)),console[_0x3a4cc4(0x16f)](_0x3a4cc4(0x1c5)+_0x17db59[_0x3a4cc4(0x1dc)]),console[_0x3a4cc4(0x16f)](_0x3a4cc4(0x1d3)+_0x17db59['status']),console[_0x3a4cc4(0x16f)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x17db59['gatewayPaymentId']),console[_0x3a4cc4(0x16f)](_0x3a4cc4(0x1db)+_0x17db59[_0x3a4cc4(0x170)]+'\x20'+_0x17db59['currency']),console[_0x3a4cc4(0x16f)](_0x3a4cc4(0x1f2)+_0x17db59[_0x3a4cc4(0x13d)]);if(_0x17db59[_0x3a4cc4(0x1dc)]!==_0x3a4cc4(0x19c)){console[_0x3a4cc4(0x16f)](_0x3a4cc4(0x179)+_0x222ac2+_0x3a4cc4(0x1a7)+_0x17db59['gateway']+')');return;}if(_0x17db59[_0x3a4cc4(0x1c2)]!=='PENDING'){console[_0x3a4cc4(0x16f)](_0x3a4cc4(0x179)+_0x222ac2+_0x3a4cc4(0x1e4)+_0x17db59[_0x3a4cc4(0x1c2)]+_0x3a4cc4(0x15b)),this[_0x3a4cc4(0x197)](_0x222ac2);return;}if(!_0x17db59[_0x3a4cc4(0x1af)]){console[_0x3a4cc4(0x16f)](_0x3a4cc4(0x179)+_0x222ac2+_0x3a4cc4(0x14d));return;}console[_0x3a4cc4(0x16f)](_0x3a4cc4(0x18d)+_0x222ac2+_0x3a4cc4(0x1e9)),await this[_0x3a4cc4(0x1c4)](_0x17db59);}[a37_0x51616f(0x163)](_0x161f54,_0x520f1d,_0x58f418,_0x20d22d,_0x175cfc,_0x314b23){const _0x181fde=a37_0x51616f,_0x1d41c6={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x161f54,'gatewayPaymentId':_0x520f1d,'oldStatus':_0x58f418,'newStatus':_0x20d22d,'source':_0x175cfc,'timestamp':new Date()['toISOString'](),'details':_0x314b23||{}};loggerService_1[_0x181fde(0x147)][_0x181fde(0x163)](_0x1d41c6),console[_0x181fde(0x16f)](_0x181fde(0x141)+_0x161f54+'\x20('+_0x520f1d+')'),console[_0x181fde(0x16f)](_0x181fde(0x1cc)+_0x58f418+_0x181fde(0x12e)+_0x20d22d),console[_0x181fde(0x16f)]('\x20\x20\x20📍\x20Source:\x20'+_0x175cfc),console['log'](_0x181fde(0x1a8)+_0x1d41c6[_0x181fde(0x20b)]),_0x314b23&&console[_0x181fde(0x16f)](_0x181fde(0x1b9),_0x314b23);}[a37_0x51616f(0x151)](_0x2e9d17,_0x1b5157,_0x50cc58,_0x51add7,_0x139e50){const _0x4ac96d=a37_0x51616f,_0x43744a={'type':'COINTOPAY_ERROR','paymentId':_0x2e9d17,'gatewayPaymentId':_0x1b5157,'error':_0x50cc58 instanceof Error?{'message':_0x50cc58[_0x4ac96d(0x198)],'stack':_0x50cc58['stack']}:_0x50cc58,'source':_0x51add7,'timestamp':new Date()[_0x4ac96d(0x19b)](),'context':_0x139e50||{}};loggerService_1[_0x4ac96d(0x147)][_0x4ac96d(0x151)](_0x43744a),console[_0x4ac96d(0x1be)](_0x4ac96d(0x1a9)+_0x2e9d17+'\x20('+_0x1b5157+')'),console[_0x4ac96d(0x1be)](_0x4ac96d(0x1cb)+(_0x50cc58 instanceof Error?_0x50cc58[_0x4ac96d(0x198)]:_0x50cc58)),console[_0x4ac96d(0x1be)](_0x4ac96d(0x14f)+_0x51add7),console[_0x4ac96d(0x1be)](_0x4ac96d(0x1a8)+_0x43744a['timestamp']),_0x139e50&&console['error'](_0x4ac96d(0x166),_0x139e50);}[a37_0x51616f(0x1d7)](){const _0x4c6790=a37_0x51616f;console[_0x4c6790(0x16f)](_0x4c6790(0x12d)),this['checkAllPendingPayments']()[_0x4c6790(0x1d6)](_0x300c52=>{const _0x54adad=_0x4c6790;console[_0x54adad(0x1be)](_0x54adad(0x1a3),_0x300c52);}),this[_0x4c6790(0x1f3)]=setInterval(async()=>{const _0x3064cb=_0x4c6790;try{console['log'](_0x3064cb(0x201)),await this[_0x3064cb(0x1b8)](),console[_0x3064cb(0x16f)](_0x3064cb(0x1c8));}catch(_0x197353){console[_0x3064cb(0x1be)](_0x3064cb(0x14a),_0x197353);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x4c6790(0x16f)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x51616f(0x186)](){const _0x1e07d6=a37_0x51616f;console[_0x1e07d6(0x16f)](_0x1e07d6(0x148));this[_0x1e07d6(0x1f3)]&&(clearInterval(this['globalCheckInterval']),this[_0x1e07d6(0x1f3)]=null,console['log'](_0x1e07d6(0x1e6)));const _0x593b20=this[_0x1e07d6(0x1ce)][_0x1e07d6(0x172)];for(const [_0x43b458]of this[_0x1e07d6(0x1ce)]){this[_0x1e07d6(0x197)](_0x43b458);}console['log'](_0x1e07d6(0x12f)+_0x593b20+_0x1e07d6(0x1fc));}async[a37_0x51616f(0x1b8)](){const _0x567dea=a37_0x51616f;try{console['log'](_0x567dea(0x1d4));const _0x1d0219=await database_1['default'][_0x567dea(0x1d9)][_0x567dea(0x13b)]({'where':{'gateway':_0x567dea(0x19c),'status':_0x567dea(0x164),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x567dea(0x16f)](_0x567dea(0x207)+_0x1d0219['length']+_0x567dea(0x168));if(_0x1d0219['length']===0x0){console[_0x567dea(0x16f)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x43b9cf=await this[_0x567dea(0x1f5)](_0x1d0219);console[_0x567dea(0x16f)](_0x567dea(0x15d)+_0x43b9cf[_0x567dea(0x193)]+'\x20expired\x20CoinToPay\x20payments');let _0xda7e67=0x0,_0x33ceea=0x0;for(const _0x281539 of _0x1d0219){try{if(_0x43b9cf['includes'](_0x281539['id'])){console[_0x567dea(0x16f)](_0x567dea(0x17e)+_0x281539['id']+_0x567dea(0x18c)),_0x33ceea++;continue;}if(this['paymentTimers'][_0x567dea(0x1b1)](_0x281539['id'])){console[_0x567dea(0x16f)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x281539['id']+_0x567dea(0x154)),_0x33ceea++;continue;}const _0x1f783c=(Date[_0x567dea(0x185)]()-_0x281539[_0x567dea(0x1f9)][_0x567dea(0x149)]())/(0x3e8*0x3c*0x3c);if(_0x1f783c<0x1){console[_0x567dea(0x16f)](_0x567dea(0x17e)+_0x281539['id']+_0x567dea(0x1e3)+_0x1f783c[_0x567dea(0x1e5)](0x1)+_0x567dea(0x1c6)),_0x33ceea++;continue;}console[_0x567dea(0x16f)](_0x567dea(0x196)+_0x281539['id']+_0x567dea(0x191)+_0x1f783c[_0x567dea(0x1e5)](0x1)+'h)'),await this['checkSinglePayment'](_0x281539),_0xda7e67++,await new Promise(_0x21318d=>setTimeout(_0x21318d,0x7d0));}catch(_0x4826e9){console[_0x567dea(0x1be)]('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x281539['id']+':',_0x4826e9),this[_0x567dea(0x151)](_0x281539['id'],_0x281539[_0x567dea(0x1af)]||_0x567dea(0x161),_0x4826e9,_0x567dea(0x15a),{'isGlobalCheck':!![],'paymentAmount':_0x281539[_0x567dea(0x170)],'paymentCurrency':_0x281539['currency'],'shopId':_0x281539['shopId'],'createdAt':_0x281539[_0x567dea(0x1f9)]}),loggerService_1['loggerService'][_0x567dea(0x19a)](_0x567dea(0x19c),_0x567dea(0x13a)+_0x281539[_0x567dea(0x1af)],_0x4826e9);}}console[_0x567dea(0x16f)](_0x567dea(0x1ff)+_0xda7e67+_0x567dea(0x155)+_0x33ceea+_0x567dea(0x1da)+_0x43b9cf[_0x567dea(0x193)]+_0x567dea(0x1ee));}catch(_0x290e80){console[_0x567dea(0x1be)](_0x567dea(0x14c),_0x290e80);}}async[a37_0x51616f(0x1f5)](_0x1811de){const _0x42f9c7=a37_0x51616f,_0x5b3952=[],_0xf1f8a9=new Date();_0xf1f8a9['setDate'](_0xf1f8a9['getDate']()-this[_0x42f9c7(0x1de)]),console[_0x42f9c7(0x16f)](_0x42f9c7(0x173)+this[_0x42f9c7(0x1de)]+'\x20days\x20(created\x20before\x20'+_0xf1f8a9[_0x42f9c7(0x19b)]()+')');for(const _0x2ce040 of _0x1811de){if(_0x2ce040[_0x42f9c7(0x1f9)]<_0xf1f8a9){console[_0x42f9c7(0x16f)](_0x42f9c7(0x1f6)+_0x2ce040['id']+_0x42f9c7(0x199)+this[_0x42f9c7(0x1de)]+_0x42f9c7(0x1a6));try{this[_0x42f9c7(0x163)](_0x2ce040['id'],_0x2ce040[_0x42f9c7(0x1af)]||_0x42f9c7(0x161),'PENDING','EXPIRED',_0x42f9c7(0x204),{'reason':'Payment\x20older\x20than\x20'+this[_0x42f9c7(0x1de)]+_0x42f9c7(0x176),'createdAt':_0x2ce040[_0x42f9c7(0x1f9)],'daysSinceCreation':Math[_0x42f9c7(0x208)]((Date['now']()-_0x2ce040[_0x42f9c7(0x1f9)][_0x42f9c7(0x149)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x2ce040[_0x42f9c7(0x170)],'paymentCurrency':_0x2ce040[_0x42f9c7(0x1d5)],'shopId':_0x2ce040[_0x42f9c7(0x13d)]}),await database_1[_0x42f9c7(0x1b2)][_0x42f9c7(0x1d9)]['update']({'where':{'id':_0x2ce040['id']},'data':{'status':_0x42f9c7(0x200),'updatedAt':new Date(),'adminNotes':_0x42f9c7(0x1fb)+this[_0x42f9c7(0x1de)]+_0x42f9c7(0x1fa)}}),await database_1[_0x42f9c7(0x1b2)][_0x42f9c7(0x160)][_0x42f9c7(0x128)]({'data':{'paymentId':_0x2ce040['id'],'shopId':_0x2ce040[_0x42f9c7(0x13d)],'event':_0x42f9c7(0x1e8),'statusCode':0xc8,'responseBody':JSON[_0x42f9c7(0x1a1)]({'reason':_0x42f9c7(0x206)+this[_0x42f9c7(0x1de)]+_0x42f9c7(0x176),'createdAt':_0x2ce040[_0x42f9c7(0x1f9)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x42f9c7(0x208)]((Date[_0x42f9c7(0x185)]()-_0x2ce040[_0x42f9c7(0x1f9)][_0x42f9c7(0x149)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x2ce040,'EXPIRED'),await this['sendPaymentStatusNotification'](_0x2ce040,_0x42f9c7(0x200)),this[_0x42f9c7(0x197)](_0x2ce040['id']),_0x5b3952[_0x42f9c7(0x1e0)](_0x2ce040['id']),console[_0x42f9c7(0x16f)](_0x42f9c7(0x1f0)+_0x2ce040['id']+_0x42f9c7(0x1b5)+this[_0x42f9c7(0x1de)]+_0x42f9c7(0x157));}catch(_0x20c0d7){console[_0x42f9c7(0x1be)](_0x42f9c7(0x194)+_0x2ce040['id']+':',_0x20c0d7),this['logCoinToPayError'](_0x2ce040['id'],_0x2ce040[_0x42f9c7(0x1af)]||_0x42f9c7(0x161),_0x20c0d7,'auto_expire',{'reason':_0x42f9c7(0x1b0),'createdAt':_0x2ce040[_0x42f9c7(0x1f9)],'daysSinceCreation':Math[_0x42f9c7(0x208)]((Date[_0x42f9c7(0x185)]()-_0x2ce040[_0x42f9c7(0x1f9)][_0x42f9c7(0x149)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5b3952;}async[a37_0x51616f(0x1c4)](_0x541e2b){const _0x38e2a4=a37_0x51616f;if(!_0x541e2b[_0x38e2a4(0x1af)]){console[_0x38e2a4(0x16f)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x541e2b['id']+_0x38e2a4(0x1ed));return;}console[_0x38e2a4(0x16f)]('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x541e2b['id']+'\x20('+_0x541e2b[_0x38e2a4(0x1af)]+')');try{const _0x19ad90=await this[_0x38e2a4(0x1ab)][_0x38e2a4(0x135)](_0x541e2b[_0x38e2a4(0x1af)]);console[_0x38e2a4(0x16f)](_0x38e2a4(0x130)+_0x541e2b['id']+_0x38e2a4(0x1c3)+_0x19ad90[_0x38e2a4(0x1c2)]);_0x19ad90[_0x38e2a4(0x1dd)]&&console[_0x38e2a4(0x16f)](_0x38e2a4(0x130)+_0x541e2b['id']+_0x38e2a4(0x169),{'iban':_0x19ad90['paymentDetails'][_0x38e2a4(0x171)]||_0x38e2a4(0x16b),'transactionId':_0x19ad90['paymentDetails'][_0x38e2a4(0x1d1)],'createdOn':_0x19ad90['paymentDetails'][_0x38e2a4(0x129)],'confirmedOn':_0x19ad90[_0x38e2a4(0x1dd)][_0x38e2a4(0x152)]||'not\x20confirmed'});if(_0x19ad90['status']!==_0x541e2b[_0x38e2a4(0x1c2)]){console[_0x38e2a4(0x16f)](_0x38e2a4(0x143)+_0x541e2b['id']+_0x38e2a4(0x132)+_0x541e2b['status']+_0x38e2a4(0x1a2)+_0x19ad90[_0x38e2a4(0x1c2)]),this[_0x38e2a4(0x163)](_0x541e2b['id'],_0x541e2b[_0x38e2a4(0x1af)],_0x541e2b['status'],_0x19ad90['status'],_0x38e2a4(0x15a),{'paymentDetails':_0x19ad90['paymentDetails'],'amount':_0x19ad90[_0x38e2a4(0x170)],'currency':_0x19ad90[_0x38e2a4(0x1d5)],'shopId':_0x541e2b[_0x38e2a4(0x13d)],'checkTimestamp':new Date()[_0x38e2a4(0x19b)]()});const _0x3192de={'status':_0x19ad90[_0x38e2a4(0x1c2)],'updatedAt':new Date()};_0x19ad90[_0x38e2a4(0x1c2)]===_0x38e2a4(0x16e)&&_0x541e2b[_0x38e2a4(0x1c2)]!==_0x38e2a4(0x16e)&&(_0x3192de[_0x38e2a4(0x12b)]=new Date(),console[_0x38e2a4(0x16f)](_0x38e2a4(0x134)+_0x541e2b['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x3192de['paidAt'][_0x38e2a4(0x19b)]()));if(_0x19ad90[_0x38e2a4(0x1dd)]){const _0x539fc4=_0x19ad90[_0x38e2a4(0x1dd)];_0x539fc4['iban']&&(_0x3192de['remitterIban']=_0x539fc4['iban'],console['log'](_0x38e2a4(0x189)+_0x539fc4['iban']));if(_0x539fc4[_0x38e2a4(0x184)]){const _0x2f7b94=_0x541e2b['adminNotes']||'',_0x4b8c1f=_0x38e2a4(0x1bc)+_0x539fc4[_0x38e2a4(0x184)];_0x3192de['adminNotes']=_0x2f7b94?_0x2f7b94+'\x0a\x0a'+_0x4b8c1f:_0x4b8c1f,console[_0x38e2a4(0x16f)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x539fc4['transactionId']&&console[_0x38e2a4(0x16f)]('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x539fc4[_0x38e2a4(0x1d1)]),_0x539fc4[_0x38e2a4(0x152)]&&console[_0x38e2a4(0x16f)]('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x539fc4['confirmedOn']);}await database_1[_0x38e2a4(0x1b2)][_0x38e2a4(0x1d9)]['update']({'where':{'id':_0x541e2b['id']},'data':_0x3192de}),await database_1['default'][_0x38e2a4(0x160)][_0x38e2a4(0x128)]({'data':{'paymentId':_0x541e2b['id'],'shopId':_0x541e2b['shopId'],'event':'cointopay_status_check_'+_0x19ad90[_0x38e2a4(0x1c2)][_0x38e2a4(0x127)](),'statusCode':0xc8,'responseBody':JSON[_0x38e2a4(0x1a1)]({'oldStatus':_0x541e2b['status'],'newStatus':_0x19ad90[_0x38e2a4(0x1c2)],'paymentDetails':_0x19ad90[_0x38e2a4(0x1dd)],'checkedAt':new Date()[_0x38e2a4(0x19b)]()})}}),await this[_0x38e2a4(0x15e)](_0x541e2b,_0x19ad90[_0x38e2a4(0x1c2)]),await this['sendPaymentStatusNotification'](_0x541e2b,_0x19ad90[_0x38e2a4(0x1c2)]),_0x19ad90[_0x38e2a4(0x1c2)]!==_0x38e2a4(0x164)&&(console['log'](_0x38e2a4(0x18f)+_0x541e2b['id']+_0x38e2a4(0x162)+_0x19ad90['status']+_0x38e2a4(0x1df)),this[_0x38e2a4(0x197)](_0x541e2b['id'])),console[_0x38e2a4(0x16f)](_0x38e2a4(0x18d)+_0x541e2b['id']+_0x38e2a4(0x1b7));}else console[_0x38e2a4(0x16f)](_0x38e2a4(0x130)+_0x541e2b['id']+_0x38e2a4(0x16a)+_0x19ad90[_0x38e2a4(0x1c2)]+')'),this[_0x38e2a4(0x163)](_0x541e2b['id'],_0x541e2b[_0x38e2a4(0x1af)],_0x541e2b['status'],_0x19ad90['status'],_0x38e2a4(0x15a),{'statusUnchanged':!![],'paymentDetails':_0x19ad90[_0x38e2a4(0x1dd)],'amount':_0x19ad90[_0x38e2a4(0x170)],'currency':_0x19ad90['currency'],'shopId':_0x541e2b[_0x38e2a4(0x13d)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x2186fb){console['error'](_0x38e2a4(0x150)+_0x541e2b['id']+':',_0x2186fb),this['logCoinToPayError'](_0x541e2b['id'],_0x541e2b['gatewayPaymentId'],_0x2186fb,_0x38e2a4(0x15a),{'paymentAmount':_0x541e2b['amount'],'paymentCurrency':_0x541e2b[_0x38e2a4(0x1d5)],'shopId':_0x541e2b[_0x38e2a4(0x13d)],'createdAt':_0x541e2b[_0x38e2a4(0x1f9)]}),await database_1['default'][_0x38e2a4(0x160)][_0x38e2a4(0x128)]({'data':{'paymentId':_0x541e2b['id'],'shopId':_0x541e2b[_0x38e2a4(0x13d)],'event':_0x38e2a4(0x1b4),'statusCode':0x1f4,'responseBody':JSON[_0x38e2a4(0x1a1)]({'error':_0x2186fb instanceof Error?_0x2186fb[_0x38e2a4(0x198)]:'Unknown\x20error','gatewayPaymentId':_0x541e2b[_0x38e2a4(0x1af)],'checkedAt':new Date()['toISOString']()})}});}}async[a37_0x51616f(0x15e)](_0x131bea,_0x22ca74){const _0x37b9b0=a37_0x51616f,_0x451371=Date[_0x37b9b0(0x185)]();try{const _0x3b753e=_0x131bea[_0x37b9b0(0x1eb)],_0x32c71c=_0x3b753e[_0x37b9b0(0x17f)];if(!_0x32c71c?.[_0x37b9b0(0x158)]){console['log'](_0x37b9b0(0x175)+_0x3b753e['id']);return;}const _0x26f046=_0x22ca74==='PAID'?_0x37b9b0(0x17a):_0x22ca74===_0x37b9b0(0x1cd)?'payment.failed':_0x22ca74===_0x37b9b0(0x200)?_0x37b9b0(0x18b):_0x37b9b0(0x131);if(!_0x32c71c[_0x37b9b0(0x1ec)]?.['includes'](_0x26f046)){console['log']('Webhook\x20event\x20'+_0x26f046+_0x37b9b0(0x1f4)+_0x3b753e['id']);return;}const _0x1917d0={'event':_0x26f046,'payment':{'id':_0x131bea['id'],'order_id':_0x131bea[_0x37b9b0(0x1c1)],'gateway_order_id':_0x131bea['gatewayOrderId'],'gateway':_0x37b9b0(0x1fe),'amount':_0x131bea[_0x37b9b0(0x170)],'currency':_0x131bea[_0x37b9b0(0x1d5)],'status':_0x22ca74[_0x37b9b0(0x127)](),'customer_email':_0x131bea['customerEmail'],'customer_name':_0x131bea['customerName'],'created_at':_0x131bea[_0x37b9b0(0x1f9)],'updated_at':new Date()}},_0x2ab5a5=await fetch(_0x32c71c[_0x37b9b0(0x158)],{'method':_0x37b9b0(0x17c),'headers':{'Content-Type':_0x37b9b0(0x183),'User-Agent':_0x37b9b0(0x18e)},'body':JSON['stringify'](_0x1917d0)}),_0x2ad3af=Date[_0x37b9b0(0x185)]()-_0x451371,_0x30095b=_0x2ab5a5['ok']?_0x37b9b0(0x1a5):await _0x2ab5a5[_0x37b9b0(0x182)]();loggerService_1['loggerService'][_0x37b9b0(0x165)](_0x131bea[_0x37b9b0(0x13d)],_0x32c71c[_0x37b9b0(0x158)],_0x26f046,_0x2ab5a5[_0x37b9b0(0x1c2)],_0x2ad3af,_0x1917d0),console[_0x37b9b0(0x16f)](_0x37b9b0(0x137)+_0x32c71c['webhookUrl']+_0x37b9b0(0x1f8)+_0x2ab5a5[_0x37b9b0(0x1c2)]+'\x20('+_0x2ad3af+'ms)');}catch(_0x206ec4){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x206ec4),loggerService_1[_0x37b9b0(0x147)][_0x37b9b0(0x144)](_0x131bea[_0x37b9b0(0x13d)],_0x131bea[_0x37b9b0(0x1eb)]?.[_0x37b9b0(0x17f)]?.['webhookUrl']||_0x37b9b0(0x161),_0x37b9b0(0x142),_0x206ec4,{});}}async[a37_0x51616f(0x188)](_0x4d1824,_0x3dc442){const _0xd4adcb=a37_0x51616f;try{const _0x4fd54b={'PENDING':_0xd4adcb(0x1c7),'PAID':'paid','FAILED':_0xd4adcb(0x1e2),'EXPIRED':'expired'},_0x4c17a8=_0x4fd54b[_0x3dc442];if(!_0x4c17a8||_0x4c17a8===_0xd4adcb(0x1c7))return;await telegramBotService_1['telegramBotService']['sendPaymentNotification'](_0x4d1824[_0xd4adcb(0x13d)],_0x4d1824,_0x4c17a8);}catch(_0x117ae2){console[_0xd4adcb(0x1be)](_0xd4adcb(0x140),_0x117ae2);}}async['checkPaymentById'](_0x593ede){const _0x13e99f=a37_0x51616f;console[_0x13e99f(0x16f)](_0x13e99f(0x1cf)+_0x593ede);const _0x552c9b=await database_1[_0x13e99f(0x1b2)][_0x13e99f(0x1d9)]['findUnique']({'where':{'id':_0x593ede},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x552c9b)throw new Error(_0x13e99f(0x174));if(_0x552c9b[_0x13e99f(0x1dc)]!==_0x13e99f(0x19c))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x13e99f(0x16f)](_0x13e99f(0x13c)+_0x593ede),await this[_0x13e99f(0x1c4)](_0x552c9b),console[_0x13e99f(0x16f)](_0x13e99f(0x139)+_0x593ede);}['getServiceStats'](){const _0x5bd9cb=a37_0x51616f,_0x5a9720=this['globalCheckInterval']?this[_0x5bd9cb(0x1c0)]:undefined,_0x2e1a06=Array[_0x5bd9cb(0x178)](this['paymentTimers'][_0x5bd9cb(0x1bb)]())[_0x5bd9cb(0x1a0)](_0x27c487=>({'paymentId':_0x27c487[_0x5bd9cb(0x133)],'gatewayPaymentId':_0x27c487[_0x5bd9cb(0x1af)],'createdAt':_0x27c487[_0x5bd9cb(0x1f9)],'timersCount':_0x27c487[_0x5bd9cb(0x1b3)][_0x5bd9cb(0x193)]}));return{'isActive':!!this[_0x5bd9cb(0x1f3)],'globalCheckIntervalMinutes':this[_0x5bd9cb(0x1c0)]/(0x3e8*0x3c),'expiryDays':this[_0x5bd9cb(0x1de)],'activeIndividualTimers':this[_0x5bd9cb(0x1ce)][_0x5bd9cb(0x172)],'nextGlobalCheckIn':_0x5a9720,'paymentTimersDetails':_0x2e1a06};}[a37_0x51616f(0x181)](_0x4bad95){const _0x19ae65=a37_0x51616f,_0x33740a=this['paymentTimers'][_0x19ae65(0x195)](_0x4bad95);if(_0x33740a)return{'hasTimers':!![],'timersCount':_0x33740a[_0x19ae65(0x1b3)][_0x19ae65(0x193)],'createdAt':_0x33740a['createdAt'],'gatewayPaymentId':_0x33740a[_0x19ae65(0x1af)]};return{'hasTimers':![]};}}exports[a37_0x51616f(0x1d0)]=CoinToPayStatusService,exports[a37_0x51616f(0x177)]=new CoinToPayStatusService();