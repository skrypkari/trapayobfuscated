'use strict';const a37_0x27c1e2=a37_0x3d6d;function a37_0x3d6d(_0x33b3e3,_0x3e68e5){const _0x66adf3=a37_0x66ad();return a37_0x3d6d=function(_0x3d6da3,_0xf68ff1){_0x3d6da3=_0x3d6da3-0xce;let _0x30c157=_0x66adf3[_0x3d6da3];return _0x30c157;},a37_0x3d6d(_0x33b3e3,_0x3e68e5);}(function(_0x446cb4,_0x3416af){const _0x2e3d39=a37_0x3d6d,_0x13aea7=_0x446cb4();while(!![]){try{const _0x4025f6=parseInt(_0x2e3d39(0x129))/0x1+parseInt(_0x2e3d39(0x122))/0x2+parseInt(_0x2e3d39(0x182))/0x3*(-parseInt(_0x2e3d39(0xe3))/0x4)+parseInt(_0x2e3d39(0xf9))/0x5+parseInt(_0x2e3d39(0x166))/0x6+-parseInt(_0x2e3d39(0x157))/0x7*(parseInt(_0x2e3d39(0xee))/0x8)+parseInt(_0x2e3d39(0x1a1))/0x9*(parseInt(_0x2e3d39(0x176))/0xa);if(_0x4025f6===_0x3416af)break;else _0x13aea7['push'](_0x13aea7['shift']());}catch(_0x1c5793){_0x13aea7['push'](_0x13aea7['shift']());}}}(a37_0x66ad,0xbd610));var __importDefault=this&&this['__importDefault']||function(_0x3e01ba){const _0x282247=a37_0x3d6d;return _0x3e01ba&&_0x3e01ba[_0x282247(0x18d)]?_0x3e01ba:{'default':_0x3e01ba};};Object[a37_0x27c1e2(0xe5)](exports,'__esModule',{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0x27c1e2(0x138)]=void 0x0;const coinToPayService_1=require(a37_0x27c1e2(0x1af)),coinToPay2Service_1=require(a37_0x27c1e2(0x148)),gateway_1=require('../types/gateway'),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x27c1e2(0x17a)),loggerService_1=require(a37_0x27c1e2(0x170));function a37_0x66ad(){const _0x4db2dd=['cointopay','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','iban','bankDetails','application/json','\x20is\x20too\x20new\x20(','\x20\x20\x20-\x20Status:\x20','adminNotes','\x20marked\x20as\x20paid\x20at:\x20','52XjgIzz','Webhook\x20event\x20','defineProperty','payment.failed','EXPIRED','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','created','\x20to\x20','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','toISOString','4544ldYhvn','\x20is\x20valid\x20for\x20checking,\x20proceeding...','COINTOPAY_STATUS_CHANGE','gateway','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','currency','coinToPay2Service','findUnique','\x20\x20\x20-\x20Amount:\x20','webhookLog','map','3488005jfOXRR','Failed\x20to\x20send\x20shop\x20webhook:','unknown','‚úÖ\x20[CHECK]\x20Payment\x20','checkPaymentById','GLOBAL_CHECK_INTERVAL_MS','\x20in\x20','webhook_send','description','not\x20confirmed','transactionId','get','Payment\x20older\x20than\x20','size','stopPeriodicStatusCheck','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','paymentTimers','findMany','‚úÖ\x20[EXPIRY]\x20Payment\x20','getTime','Automatically\x20expired\x20after\x20','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','now','cointopay_status_check_error','Success','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','Payment\x20not\x20found','\x20\x20\x20-\x20gatewayPaymentId:\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','cointopay2','setDate','.\x20Remaining\x20active\x20timers:\x20','ms)','CoinToPayService','paid','\x20not\x20found\x20in\x20database','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','-day\x20timeout','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20with\x20status\x20','1567278foZHEK','gatewayPaymentId','Unknown\x20error','CoinToPay2Service','üìä\x20[CHECK]\x20Payment\x20','createdAt','createdOn','278899POsgTw','PAID','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','delete','logWhiteDomainError','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20(age:\x20','\x20current\x20status:\x20','length','\x20triggered\x20for\x20payment\x20','\x20status:\x20','\x20days\x20without\x20payment\x20confirmation','checkAllPendingPayments','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','timers','CoinToPayStatusService','logCoinToPayStatus','checkExpiredPayments','payment','error','PENDING','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','includes','\x20has\x20no\x20gatewayPaymentId','auto_expire','create','update','getDate','\x20is\x20older\x20than\x20','üßπ\x20[CHECK]\x20Payment\x20','\x20expired','./gateways/coinToPay2Service','cointopay_status_check_','\x20\x20\x20üìç\x20Source:\x20','default','\x20skipped,\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','message','‚úÖ\x20[HOURLY]\x20Payment\x20','not\x20found','paymentDetails','\x20status\x20is\x20','payment.success','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','checkSinglePaymentById','shopId','5110vPXonz','TesSoft\x20Payment\x20System/1.0','expired','\x20details:','\x20checked,\x20','\x20individual\x20payment\x20timers','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','checkSinglePayment','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','settings','stringify','push','\x20found:','webhookUrl','113004HaIGaU','sendPaymentNotification','\x20days\x20(created\x20before\x20','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','sendPaymentStatusNotification','\x20status\x20changed\x20to\x20','\x20\x20\x20‚ùå\x20Error:\x20','startPeriodicStatusCheck',',\x20stopping\x20individual\x20checks','stack','./loggerService','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','\x20updated\x20successfully','coinToPayService','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20\x20\x20-\x20ShopId:\x20','1011540WbmFia','\x20for\x20payment\x20','1\x20minute','confirmedOn','./telegramBotService','\x20\x20\x20üìÖ\x20Time:\x20','status','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20\x20\x20üìä\x20Status:\x20','ü™ô\x20[GLOBAL]\x20Found\x20','telegramBotService','toFixed','205869IJIHVF','\x20has\x20no\x20gatewayPaymentId,\x20skipping','orderId','EXPIRY_DAYS','‚è∞\x20[GLOBAL]\x20Found\x20','shop','\x20to\x20clear','5\x20minutes','forEach','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','üõë\x20[SHUTDOWN]\x20Cleared\x20','__esModule','\x20expired\x20CoinToPay\x20payments','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','failed','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','‚è∞\x20[GLOBAL]\x20Payment\x20','üí∞\x20[CHECK]\x20Payment\x20','delay','FAILED','set','from','customerName','üìä\x20[HOURLY]\x20Payment\x20','globalCheckInterval','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','floor','logShopWebhookError','timestamp','27OnDJXP','h),\x20skipping\x20global\x20check','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','has','\x20(after\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','checkPaymentStatus','\x20days,\x20marking\x20as\x20EXPIRED','getServiceStats','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','üîç\x20[CHECK]\x20Checking\x20','\x20pending\x20CoinToPay\x20payments','./gateways/coinToPayService','cointopay_auto_expired','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','catch','sendShopWebhook','amount','paidAt','POST','clearPaymentTimers','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20not\x20found,\x20clearing\x20timers','toLowerCase','‚ùå\x20[HOURLY]\x20Payment\x20','\x20days','coinToPayStatusService','loggerService','log','status_check','logCoinToPayError','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'];a37_0x66ad=function(){return _0x4db2dd;};return a37_0x66ad();}class CoinToPayStatusService{constructor(){const _0x5bec0f=a37_0x27c1e2;this[_0x5bec0f(0x19c)]=null,this[_0x5bec0f(0xfe)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x5bec0f(0x109)]=new Map(),this[_0x5bec0f(0x173)]=new coinToPayService_1[(_0x5bec0f(0x11b))](),this[_0x5bec0f(0xf4)]=new coinToPay2Service_1[(_0x5bec0f(0x125))](),console[_0x5bec0f(0xd4)]('ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}['schedulePaymentChecks'](_0x564118,_0x44abb5){const _0x2f4864=a37_0x27c1e2;console[_0x2f4864(0xd4)](_0x2f4864(0x192)),console['log']('\x20\x20\x20-\x20paymentId:\x20'+_0x564118),console[_0x2f4864(0xd4)](_0x2f4864(0x114)+_0x44abb5),this[_0x2f4864(0x1b7)](_0x564118);const _0xd4d51a=[],_0xb7cae5=new Date(),_0x3809a6=[{'delay':0x1*0x3c*0x3e8,'description':_0x2f4864(0x178)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x2f4864(0x189)},{'delay':0x5*0x3c*0x3e8,'description':_0x2f4864(0x189)}];console[_0x2f4864(0xd4)]('ü™ô\x20[DEBUG]\x20Creating\x20'+_0x3809a6[_0x2f4864(0x131)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x564118);let _0x447f8c=0x0;_0x3809a6[_0x2f4864(0x18a)]((_0x4ccb1f,_0x3c04c3)=>{const _0x48b089=_0x2f4864;_0x447f8c+=_0x4ccb1f[_0x48b089(0x196)];const _0x2e8883=setTimeout(async()=>{const _0x2276f9=_0x48b089;console[_0x2276f9(0xd4)]('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x3c04c3+0x1)+_0x2276f9(0x132)+_0x564118+_0x2276f9(0x1a7)+_0x4ccb1f[_0x2276f9(0x101)]+')');try{await this['checkSinglePaymentById'](_0x564118),console[_0x2276f9(0xd4)]('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x3c04c3+0x1)+'\x20completed\x20for\x20payment\x20'+_0x564118);}catch(_0x1bbf9e){console['error']('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x3c04c3+0x1)+'\x20for\x20payment\x20'+_0x564118+':',_0x1bbf9e),this[_0x2276f9(0xd6)](_0x564118,_0x44abb5,_0x1bbf9e,_0x2276f9(0xd5),{'checkNumber':_0x3c04c3+0x1,'scheduledAfter':_0x4ccb1f[_0x2276f9(0x101)],'isIndividualCheck':!![]});}},_0x447f8c);_0xd4d51a[_0x48b089(0x163)](_0x2e8883),console[_0x48b089(0xd4)](_0x48b089(0xd9)+(_0x3c04c3+0x1)+_0x48b089(0x177)+_0x564118+_0x48b089(0xff)+_0x447f8c/0x3e8+'\x20seconds\x20('+_0x4ccb1f['description']+')');});const _0x4956dc=setInterval(async()=>{const _0x222d55=_0x2f4864;console[_0x222d55(0xd4)](_0x222d55(0x169)+_0x564118);try{const _0x4d4466=await database_1[_0x222d55(0x14b)][_0x222d55(0x13b)][_0x222d55(0xf5)]({'where':{'id':_0x564118},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x4d4466){console[_0x222d55(0xd4)](_0x222d55(0xd0)+_0x564118+_0x222d55(0xce)),this[_0x222d55(0x1b7)](_0x564118);return;}console[_0x222d55(0xd4)](_0x222d55(0x19b)+_0x564118+_0x222d55(0x130)+_0x4d4466[_0x222d55(0x17c)]);if(_0x4d4466['status']!==_0x222d55(0x13d)){console[_0x222d55(0xd4)](_0x222d55(0x14f)+_0x564118+'\x20status\x20is\x20'+_0x4d4466['status']+_0x222d55(0x16e)),this[_0x222d55(0x1b7)](_0x564118);return;}const _0x5181b9=Math[_0x222d55(0x19e)]((Date[_0x222d55(0x10f)]()-_0x4d4466['createdAt'][_0x222d55(0x10c)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x5181b9>=this[_0x222d55(0x185)]){console[_0x222d55(0xd4)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x564118+_0x222d55(0x145)+this[_0x222d55(0x185)]+_0x222d55(0xd8)),this[_0x222d55(0x1b7)](_0x564118);return;}await this['checkSinglePaymentById'](_0x564118),console['log'](_0x222d55(0x154)+_0x564118);}catch(_0x19b66e){console[_0x222d55(0x13c)](_0x222d55(0x12b)+_0x564118+':',_0x19b66e),this[_0x222d55(0xd6)](_0x564118,_0x44abb5,_0x19b66e,_0x222d55(0xd5),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0xd4d51a[_0x2f4864(0x163)](_0x4956dc),this[_0x2f4864(0x109)][_0x2f4864(0x198)](_0x564118,{'timers':_0xd4d51a,'paymentId':_0x564118,'gatewayPaymentId':_0x44abb5,'createdAt':_0xb7cae5}),console[_0x2f4864(0xd4)](_0x2f4864(0xec)+_0x3809a6[_0x2f4864(0x131)]+_0x2f4864(0x14d)+_0x564118),console[_0x2f4864(0xd4)](_0x2f4864(0x15f)+this[_0x2f4864(0x109)][_0x2f4864(0x106)]),this[_0x2f4864(0x139)](_0x564118,_0x44abb5,'PENDING','PENDING',_0x2f4864(0xd5),{'action':'schedule_created','scheduledChecks':_0x3809a6[_0x2f4864(0x131)],'firstCheckIn':_0x3809a6[0x0][_0x2f4864(0x196)]/0x3e8,'totalTimers':this['paymentTimers'][_0x2f4864(0x106)]});}['clearPaymentTimers'](_0x54c7e1){const _0x72ce35=a37_0x27c1e2,_0x22f82a=this[_0x72ce35(0x109)][_0x72ce35(0x104)](_0x54c7e1);_0x22f82a?(console[_0x72ce35(0xd4)]('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x22f82a['timers'][_0x72ce35(0x131)]+'\x20timers\x20for\x20payment\x20'+_0x54c7e1),_0x22f82a[_0x72ce35(0x137)][_0x72ce35(0x18a)]((_0x27e995,_0x3d1e27)=>{const _0x39e314=_0x72ce35;_0x27e995&&(clearTimeout(_0x27e995),clearInterval(_0x27e995),console['log'](_0x39e314(0x18b)+(_0x3d1e27+0x1)+_0x39e314(0x177)+_0x54c7e1));}),this[_0x72ce35(0x109)][_0x72ce35(0x12c)](_0x54c7e1),console['log']('‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x54c7e1+_0x72ce35(0x119)+this[_0x72ce35(0x109)][_0x72ce35(0x106)])):console['log'](_0x72ce35(0x191)+_0x54c7e1+_0x72ce35(0x188));}async[a37_0x27c1e2(0x155)](_0x1d488d){const _0x1a8ea6=a37_0x27c1e2;console['log'](_0x1a8ea6(0x17d)+_0x1d488d);const _0x3da954=await database_1[_0x1a8ea6(0x14b)][_0x1a8ea6(0x13b)][_0x1a8ea6(0xf5)]({'where':{'id':_0x1d488d},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3da954){console[_0x1a8ea6(0xd4)]('‚ùå\x20[CHECK]\x20Payment\x20'+_0x1d488d+_0x1a8ea6(0x11d));return;}console['log'](_0x1a8ea6(0x126)+_0x1d488d+_0x1a8ea6(0x164)),console[_0x1a8ea6(0xd4)]('\x20\x20\x20-\x20Gateway:\x20'+_0x3da954['gateway']),console[_0x1a8ea6(0xd4)](_0x1a8ea6(0xe0)+_0x3da954[_0x1a8ea6(0x17c)]),console[_0x1a8ea6(0xd4)](_0x1a8ea6(0x1b9)+_0x3da954[_0x1a8ea6(0x123)]),console[_0x1a8ea6(0xd4)](_0x1a8ea6(0xf6)+_0x3da954['amount']+'\x20'+_0x3da954[_0x1a8ea6(0xf3)]),console[_0x1a8ea6(0xd4)](_0x1a8ea6(0x175)+_0x3da954[_0x1a8ea6(0x156)]);if(_0x3da954['gateway']!=='cointopay'&&_0x3da954[_0x1a8ea6(0xf1)]!=='cointopay2'){console[_0x1a8ea6(0xd4)](_0x1a8ea6(0x171)+_0x1d488d+_0x1a8ea6(0x116)+_0x3da954[_0x1a8ea6(0xf1)]+')');return;}if(_0x3da954[_0x1a8ea6(0x17c)]!==_0x1a8ea6(0x13d)){console['log'](_0x1a8ea6(0x171)+_0x1d488d+_0x1a8ea6(0x152)+_0x3da954['status']+_0x1a8ea6(0x16e)),this[_0x1a8ea6(0x1b7)](_0x1d488d);return;}if(!_0x3da954['gatewayPaymentId']){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x1d488d+_0x1a8ea6(0x140));return;}console[_0x1a8ea6(0xd4)](_0x1a8ea6(0xfc)+_0x1d488d+_0x1a8ea6(0xef)),await this['checkSinglePayment'](_0x3da954);}[a37_0x27c1e2(0x139)](_0x1aaba8,_0x2a010b,_0x1738ab,_0x3606d7,_0x2f0a63,_0x5e24b4){const _0xebf1c4=a37_0x27c1e2,_0x429854={'type':_0xebf1c4(0xf0),'paymentId':_0x1aaba8,'gatewayPaymentId':_0x2a010b,'oldStatus':_0x1738ab,'newStatus':_0x3606d7,'source':_0x2f0a63,'timestamp':new Date()[_0xebf1c4(0xed)](),'details':_0x5e24b4||{}};loggerService_1[_0xebf1c4(0xd3)][_0xebf1c4(0x139)](_0x429854),console[_0xebf1c4(0xd4)](_0xebf1c4(0xd7)+_0x1aaba8+'\x20('+_0x2a010b+')'),console[_0xebf1c4(0xd4)](_0xebf1c4(0x17e)+_0x1738ab+'\x20->\x20'+_0x3606d7),console['log'](_0xebf1c4(0x14a)+_0x2f0a63),console[_0xebf1c4(0xd4)](_0xebf1c4(0x17b)+_0x429854['timestamp']),_0x5e24b4&&console['log']('\x20\x20\x20üìù\x20Details:',_0x5e24b4);}[a37_0x27c1e2(0xd6)](_0x2bbb87,_0x405efb,_0x5e2deb,_0x1d5fac,_0x4f3e0d){const _0x51ed21=a37_0x27c1e2,_0x584410={'type':'COINTOPAY_ERROR','paymentId':_0x2bbb87,'gatewayPaymentId':_0x405efb,'error':_0x5e2deb instanceof Error?{'message':_0x5e2deb[_0x51ed21(0x14e)],'stack':_0x5e2deb[_0x51ed21(0x16f)]}:_0x5e2deb,'source':_0x1d5fac,'timestamp':new Date()[_0x51ed21(0xed)](),'context':_0x4f3e0d||{}};loggerService_1['loggerService'][_0x51ed21(0xd6)](_0x584410),console[_0x51ed21(0x13c)](_0x51ed21(0x1b1)+_0x2bbb87+'\x20('+_0x405efb+')'),console[_0x51ed21(0x13c)](_0x51ed21(0x16c)+(_0x5e2deb instanceof Error?_0x5e2deb['message']:_0x5e2deb)),console['error'](_0x51ed21(0x14a)+_0x1d5fac),console[_0x51ed21(0x13c)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x584410[_0x51ed21(0x1a0)]),_0x4f3e0d&&console[_0x51ed21(0x13c)]('\x20\x20\x20üìù\x20Context:',_0x4f3e0d);}[a37_0x27c1e2(0x16d)](){const _0x349c1a=a37_0x27c1e2;console[_0x349c1a(0xd4)](_0x349c1a(0x1a5)),this[_0x349c1a(0x135)]()[_0x349c1a(0x1b2)](_0x2786ba=>{const _0x4c92b1=_0x349c1a;console[_0x4c92b1(0x13c)](_0x4c92b1(0x136),_0x2786ba);}),this['globalCheckInterval']=setInterval(async()=>{const _0x11e9ec=_0x349c1a;try{console['log']('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x11e9ec(0x135)](),console[_0x11e9ec(0xd4)](_0x11e9ec(0x115));}catch(_0x44cb38){console[_0x11e9ec(0x13c)](_0x11e9ec(0x174),_0x44cb38);}},this[_0x349c1a(0xfe)]),console['log']('‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x27c1e2(0x107)](){const _0x512f83=a37_0x27c1e2;console[_0x512f83(0xd4)](_0x512f83(0x15d));this[_0x512f83(0x19c)]&&(clearInterval(this['globalCheckInterval']),this['globalCheckInterval']=null,console['log']('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x19e77d=this[_0x512f83(0x109)][_0x512f83(0x106)];for(const [_0x15659a]of this[_0x512f83(0x109)]){this[_0x512f83(0x1b7)](_0x15659a);}console[_0x512f83(0xd4)](_0x512f83(0x18c)+_0x19e77d+_0x512f83(0x15c));}async[a37_0x27c1e2(0x135)](){const _0x32855b=a37_0x27c1e2;try{console[_0x32855b(0xd4)](_0x32855b(0x112));const _0x38d524=await database_1[_0x32855b(0x14b)][_0x32855b(0x13b)][_0x32855b(0x10a)]({'where':{'gateway':{'in':['cointopay',_0x32855b(0x117)]},'status':_0x32855b(0x13d),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x32855b(0xd4)](_0x32855b(0x17f)+_0x38d524[_0x32855b(0x131)]+_0x32855b(0x1ae));if(_0x38d524[_0x32855b(0x131)]===0x0){console[_0x32855b(0xd4)](_0x32855b(0x1b8));return;}const _0x5427e2=await this[_0x32855b(0x13a)](_0x38d524);console['log'](_0x32855b(0x186)+_0x5427e2[_0x32855b(0x131)]+_0x32855b(0x18e));let _0x1cd654=0x0,_0x58d598=0x0;for(const _0x31becb of _0x38d524){try{if(_0x5427e2[_0x32855b(0x13f)](_0x31becb['id'])){console[_0x32855b(0xd4)](_0x32855b(0x194)+_0x31becb['id']+_0x32855b(0x1ac)),_0x58d598++;continue;}if(this[_0x32855b(0x109)][_0x32855b(0x1a6)](_0x31becb['id'])){console[_0x32855b(0xd4)](_0x32855b(0x194)+_0x31becb['id']+_0x32855b(0xe9)),_0x58d598++;continue;}const _0x2c6be6=(Date[_0x32855b(0x10f)]()-_0x31becb[_0x32855b(0x127)][_0x32855b(0x10c)]())/(0x3e8*0x3c*0x3c);if(_0x2c6be6<0x1){console['log']('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x31becb['id']+_0x32855b(0xdf)+_0x2c6be6[_0x32855b(0x181)](0x1)+_0x32855b(0x1a2)),_0x58d598++;continue;}console[_0x32855b(0xd4)](_0x32855b(0x10e)+_0x31becb['id']+_0x32855b(0x12f)+_0x2c6be6[_0x32855b(0x181)](0x1)+'h)'),await this['checkSinglePayment'](_0x31becb),_0x1cd654++,await new Promise(_0x3ff9fd=>setTimeout(_0x3ff9fd,0x7d0));}catch(_0x31c4ff){console[_0x32855b(0x13c)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x31becb['id']+':',_0x31c4ff),this[_0x32855b(0xd6)](_0x31becb['id'],_0x31becb[_0x32855b(0x123)]||_0x32855b(0xfb),_0x31c4ff,_0x32855b(0xd5),{'isGlobalCheck':!![],'paymentAmount':_0x31becb[_0x32855b(0x1b4)],'paymentCurrency':_0x31becb['currency'],'shopId':_0x31becb[_0x32855b(0x156)],'createdAt':_0x31becb[_0x32855b(0x127)]}),loggerService_1[_0x32855b(0xd3)][_0x32855b(0x12d)]('cointopay','/status/'+_0x31becb[_0x32855b(0x123)],_0x31c4ff);}}console['log'](_0x32855b(0x120)+_0x1cd654+_0x32855b(0x15b)+_0x58d598+_0x32855b(0x14c)+_0x5427e2[_0x32855b(0x131)]+_0x32855b(0x147));}catch(_0x3e14b5){console[_0x32855b(0x13c)](_0x32855b(0x1a8),_0x3e14b5);}}async[a37_0x27c1e2(0x13a)](_0x1216c7){const _0x8128ba=a37_0x27c1e2,_0x7eec2f=[],_0x7d2162=new Date();_0x7d2162[_0x8128ba(0x118)](_0x7d2162[_0x8128ba(0x144)]()-this['EXPIRY_DAYS']),console[_0x8128ba(0xd4)](_0x8128ba(0x108)+this[_0x8128ba(0x185)]+_0x8128ba(0x168)+_0x7d2162[_0x8128ba(0xed)]()+')');for(const _0x358c6a of _0x1216c7){if(_0x358c6a[_0x8128ba(0x127)]<_0x7d2162){console[_0x8128ba(0xd4)](_0x8128ba(0x160)+_0x358c6a['id']+_0x8128ba(0x145)+this[_0x8128ba(0x185)]+_0x8128ba(0x1aa));try{this[_0x8128ba(0x139)](_0x358c6a['id'],_0x358c6a[_0x8128ba(0x123)]||'unknown','PENDING','EXPIRED','auto_expire',{'reason':_0x8128ba(0x105)+this[_0x8128ba(0x185)]+_0x8128ba(0xd1),'createdAt':_0x358c6a[_0x8128ba(0x127)],'daysSinceCreation':Math[_0x8128ba(0x19e)]((Date['now']()-_0x358c6a[_0x8128ba(0x127)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x358c6a[_0x8128ba(0x1b4)],'paymentCurrency':_0x358c6a[_0x8128ba(0xf3)],'shopId':_0x358c6a['shopId']}),await database_1[_0x8128ba(0x14b)][_0x8128ba(0x13b)][_0x8128ba(0x143)]({'where':{'id':_0x358c6a['id']},'data':{'status':_0x8128ba(0xe7),'updatedAt':new Date(),'adminNotes':_0x8128ba(0x10d)+this['EXPIRY_DAYS']+_0x8128ba(0x134)}}),await database_1[_0x8128ba(0x14b)][_0x8128ba(0xf7)]['create']({'data':{'paymentId':_0x358c6a['id'],'shopId':_0x358c6a[_0x8128ba(0x156)],'event':_0x8128ba(0x1b0),'statusCode':0xc8,'responseBody':JSON[_0x8128ba(0x162)]({'reason':_0x8128ba(0x105)+this[_0x8128ba(0x185)]+_0x8128ba(0xd1),'createdAt':_0x358c6a[_0x8128ba(0x127)],'expiredAt':new Date()[_0x8128ba(0xed)](),'daysSinceCreation':Math[_0x8128ba(0x19e)]((Date['now']()-_0x358c6a[_0x8128ba(0x127)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x8128ba(0x1b3)](_0x358c6a,'EXPIRED'),await this[_0x8128ba(0x16a)](_0x358c6a,_0x8128ba(0xe7)),this[_0x8128ba(0x1b7)](_0x358c6a['id']),_0x7eec2f[_0x8128ba(0x163)](_0x358c6a['id']),console[_0x8128ba(0xd4)](_0x8128ba(0x10b)+_0x358c6a['id']+_0x8128ba(0x1ba)+this[_0x8128ba(0x185)]+_0x8128ba(0x11f));}catch(_0x4fc7aa){console[_0x8128ba(0x13c)](_0x8128ba(0x1a3)+_0x358c6a['id']+':',_0x4fc7aa),this[_0x8128ba(0xd6)](_0x358c6a['id'],_0x358c6a[_0x8128ba(0x123)]||_0x8128ba(0xfb),_0x4fc7aa,_0x8128ba(0x141),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x358c6a[_0x8128ba(0x127)],'daysSinceCreation':Math['floor']((Date[_0x8128ba(0x10f)]()-_0x358c6a[_0x8128ba(0x127)][_0x8128ba(0x10c)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x7eec2f;}async['checkSinglePayment'](_0x20dfac){const _0x4e85c9=a37_0x27c1e2;if(!_0x20dfac['gatewayPaymentId']){console[_0x4e85c9(0xd4)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x20dfac['id']+_0x4e85c9(0x183));return;}console[_0x4e85c9(0xd4)](_0x4e85c9(0x1ad)+_0x20dfac[_0x4e85c9(0xf1)]+'\x20payment\x20'+_0x20dfac['id']+'\x20('+_0x20dfac[_0x4e85c9(0x123)]+')');try{let _0xfa146;_0x20dfac[_0x4e85c9(0xf1)]===_0x4e85c9(0x117)?(_0xfa146=await this[_0x4e85c9(0xf4)][_0x4e85c9(0x1a9)](_0x20dfac['gatewayPaymentId']),console['log']('üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x20dfac['id']+_0x4e85c9(0x133)+_0xfa146[_0x4e85c9(0x17c)])):(_0xfa146=await this[_0x4e85c9(0x173)][_0x4e85c9(0x1a9)](_0x20dfac[_0x4e85c9(0x123)]),console[_0x4e85c9(0xd4)](_0x4e85c9(0x19d)+_0x20dfac['id']+_0x4e85c9(0x133)+_0xfa146[_0x4e85c9(0x17c)]));_0xfa146[_0x4e85c9(0x151)]&&console['log'](_0x4e85c9(0x126)+_0x20dfac['id']+_0x4e85c9(0x15a),{'iban':_0xfa146[_0x4e85c9(0x151)][_0x4e85c9(0xdc)]||_0x4e85c9(0x150),'transactionId':_0xfa146['paymentDetails'][_0x4e85c9(0x103)],'createdOn':_0xfa146[_0x4e85c9(0x151)][_0x4e85c9(0x128)],'confirmedOn':_0xfa146[_0x4e85c9(0x151)]['confirmedOn']||_0x4e85c9(0x102)});if(_0xfa146['status']!==_0x20dfac[_0x4e85c9(0x17c)]){console[_0x4e85c9(0xd4)](_0x4e85c9(0xdb)+_0x20dfac['id']+'\x20status\x20from\x20'+_0x20dfac[_0x4e85c9(0x17c)]+_0x4e85c9(0xeb)+_0xfa146['status']),this[_0x4e85c9(0x139)](_0x20dfac['id'],_0x20dfac['gatewayPaymentId'],_0x20dfac[_0x4e85c9(0x17c)],_0xfa146[_0x4e85c9(0x17c)],_0x4e85c9(0xd5),{'paymentDetails':_0xfa146['paymentDetails'],'amount':_0xfa146[_0x4e85c9(0x1b4)],'currency':_0xfa146[_0x4e85c9(0xf3)],'shopId':_0x20dfac[_0x4e85c9(0x156)],'checkTimestamp':new Date()[_0x4e85c9(0xed)]()});const _0x18bd33={'status':_0xfa146[_0x4e85c9(0x17c)],'updatedAt':new Date()};_0xfa146[_0x4e85c9(0x17c)]===_0x4e85c9(0x12a)&&_0x20dfac[_0x4e85c9(0x17c)]!==_0x4e85c9(0x12a)&&(_0x18bd33['paidAt']=new Date(),console[_0x4e85c9(0xd4)](_0x4e85c9(0x195)+_0x20dfac['id']+_0x4e85c9(0xe2)+_0x18bd33[_0x4e85c9(0x1b5)]['toISOString']()));if(_0xfa146['paymentDetails']){const _0x349919=_0xfa146['paymentDetails'];_0x349919[_0x4e85c9(0xdc)]&&(_0x18bd33['remitterIban']=_0x349919[_0x4e85c9(0xdc)],console['log'](_0x4e85c9(0x12e)+_0x349919['iban']));if(_0x349919[_0x4e85c9(0xdd)]){const _0xb363dd=_0x20dfac[_0x4e85c9(0xe1)]||'',_0x1f47d5='Bank\x20Details:\x20'+_0x349919['bankDetails'];_0x18bd33['adminNotes']=_0xb363dd?_0xb363dd+'\x0a\x0a'+_0x1f47d5:_0x1f47d5,console[_0x4e85c9(0xd4)](_0x4e85c9(0xf2));}_0x349919[_0x4e85c9(0x103)]&&console['log'](_0x4e85c9(0x13e)+_0x349919[_0x4e85c9(0x103)]),_0x349919[_0x4e85c9(0x179)]&&console[_0x4e85c9(0xd4)](_0x4e85c9(0x18f)+_0x349919[_0x4e85c9(0x179)]);}await database_1['default']['payment'][_0x4e85c9(0x143)]({'where':{'id':_0x20dfac['id']},'data':_0x18bd33}),await database_1[_0x4e85c9(0x14b)][_0x4e85c9(0xf7)][_0x4e85c9(0x142)]({'data':{'paymentId':_0x20dfac['id'],'shopId':_0x20dfac[_0x4e85c9(0x156)],'event':_0x4e85c9(0x149)+_0xfa146[_0x4e85c9(0x17c)][_0x4e85c9(0xcf)](),'statusCode':0xc8,'responseBody':JSON[_0x4e85c9(0x162)]({'oldStatus':_0x20dfac[_0x4e85c9(0x17c)],'newStatus':_0xfa146[_0x4e85c9(0x17c)],'paymentDetails':_0xfa146[_0x4e85c9(0x151)],'checkedAt':new Date()[_0x4e85c9(0xed)]()})}}),await this[_0x4e85c9(0x1b3)](_0x20dfac,_0xfa146['status']),await this['sendPaymentStatusNotification'](_0x20dfac,_0xfa146[_0x4e85c9(0x17c)]),_0xfa146[_0x4e85c9(0x17c)]!==_0x4e85c9(0x13d)&&(console[_0x4e85c9(0xd4)](_0x4e85c9(0x146)+_0x20dfac['id']+_0x4e85c9(0x16b)+_0xfa146[_0x4e85c9(0x17c)]+',\x20clearing\x20individual\x20timers'),this[_0x4e85c9(0x1b7)](_0x20dfac['id'])),console[_0x4e85c9(0xd4)](_0x4e85c9(0xfc)+_0x20dfac['id']+_0x4e85c9(0x172));}else console[_0x4e85c9(0xd4)](_0x4e85c9(0x126)+_0x20dfac['id']+'\x20status\x20unchanged\x20('+_0xfa146['status']+')'),this[_0x4e85c9(0x139)](_0x20dfac['id'],_0x20dfac[_0x4e85c9(0x123)],_0x20dfac['status'],_0xfa146['status'],'status_check',{'statusUnchanged':!![],'paymentDetails':_0xfa146[_0x4e85c9(0x151)],'amount':_0xfa146['amount'],'currency':_0xfa146[_0x4e85c9(0xf3)],'shopId':_0x20dfac['shopId'],'checkTimestamp':new Date()['toISOString']()});}catch(_0x33767f){console[_0x4e85c9(0x13c)](_0x4e85c9(0x1a4)+_0x20dfac['id']+':',_0x33767f),this[_0x4e85c9(0xd6)](_0x20dfac['id'],_0x20dfac[_0x4e85c9(0x123)],_0x33767f,_0x4e85c9(0xd5),{'paymentAmount':_0x20dfac[_0x4e85c9(0x1b4)],'paymentCurrency':_0x20dfac['currency'],'shopId':_0x20dfac['shopId'],'createdAt':_0x20dfac[_0x4e85c9(0x127)]}),await database_1[_0x4e85c9(0x14b)][_0x4e85c9(0xf7)][_0x4e85c9(0x142)]({'data':{'paymentId':_0x20dfac['id'],'shopId':_0x20dfac['shopId'],'event':_0x4e85c9(0x110),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x33767f instanceof Error?_0x33767f[_0x4e85c9(0x14e)]:_0x4e85c9(0x124),'gatewayPaymentId':_0x20dfac[_0x4e85c9(0x123)],'checkedAt':new Date()[_0x4e85c9(0xed)]()})}});}}async['sendShopWebhook'](_0x14ed3f,_0x655062){const _0x34a192=a37_0x27c1e2,_0x4ed092=Date[_0x34a192(0x10f)]();try{const _0x43de0a=_0x14ed3f[_0x34a192(0x187)],_0x371545=_0x43de0a[_0x34a192(0x161)];if(!_0x371545?.[_0x34a192(0x165)]){console[_0x34a192(0xd4)](_0x34a192(0x193)+_0x43de0a['id']);return;}const _0xd8592d=_0x655062==='PAID'?_0x34a192(0x153):_0x655062===_0x34a192(0x197)?_0x34a192(0xe6):_0x655062===_0x34a192(0xe7)?_0x34a192(0xe6):'payment.pending';if(!_0x371545['webhookEvents']?.[_0x34a192(0x13f)](_0xd8592d)){console['log'](_0x34a192(0xe4)+_0xd8592d+'\x20not\x20enabled\x20for\x20shop\x20'+_0x43de0a['id']);return;}const _0x1a8b0d=(0x0,gateway_1['getGatewayIdByName'])(_0x14ed3f[_0x34a192(0xf1)])||_0x14ed3f[_0x34a192(0xf1)],_0x3a119f={'event':_0xd8592d,'payment':{'id':_0x14ed3f['id'],'order_id':_0x14ed3f[_0x34a192(0x184)],'gateway_order_id':_0x14ed3f['gatewayOrderId'],'gateway':_0x1a8b0d,'amount':_0x14ed3f[_0x34a192(0x1b4)],'currency':_0x14ed3f['currency'],'status':_0x655062['toLowerCase'](),'customer_email':_0x14ed3f['customerEmail'],'customer_name':_0x14ed3f[_0x34a192(0x19a)],'created_at':_0x14ed3f[_0x34a192(0x127)],'updated_at':new Date()}},_0x290122=await fetch(_0x371545[_0x34a192(0x165)],{'method':_0x34a192(0x1b6),'headers':{'Content-Type':_0x34a192(0xde),'User-Agent':_0x34a192(0x158)},'body':JSON[_0x34a192(0x162)](_0x3a119f)}),_0x466f62=Date[_0x34a192(0x10f)]()-_0x4ed092,_0x21c889=_0x290122['ok']?_0x34a192(0x111):await _0x290122['text']();loggerService_1['loggerService']['logShopWebhookSent'](_0x14ed3f[_0x34a192(0x156)],_0x371545['webhookUrl'],_0xd8592d,_0x290122['status'],_0x466f62,_0x3a119f),console[_0x34a192(0xd4)]('Shop\x20webhook\x20sent\x20to\x20'+_0x371545[_0x34a192(0x165)]+_0x34a192(0x121)+_0x290122[_0x34a192(0x17c)]+'\x20('+_0x466f62+_0x34a192(0x11a));}catch(_0x587c3e){console[_0x34a192(0x13c)](_0x34a192(0xfa),_0x587c3e),loggerService_1['loggerService'][_0x34a192(0x19f)](_0x14ed3f[_0x34a192(0x156)],_0x14ed3f[_0x34a192(0x187)]?.[_0x34a192(0x161)]?.[_0x34a192(0x165)]||_0x34a192(0xfb),_0x34a192(0x100),_0x587c3e,{});}}async[a37_0x27c1e2(0x16a)](_0x2fcd12,_0x4ac2fb){const _0x7f8a94=a37_0x27c1e2;try{const _0x219746={'PENDING':_0x7f8a94(0xea),'PAID':_0x7f8a94(0x11c),'FAILED':_0x7f8a94(0x190),'EXPIRED':_0x7f8a94(0x159)},_0x43de4c=_0x219746[_0x4ac2fb];if(!_0x43de4c||_0x43de4c===_0x7f8a94(0xea))return;await telegramBotService_1[_0x7f8a94(0x180)][_0x7f8a94(0x167)](_0x2fcd12[_0x7f8a94(0x156)],_0x2fcd12,_0x43de4c);}catch(_0x42b87a){console[_0x7f8a94(0x13c)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x42b87a);}}async[a37_0x27c1e2(0xfd)](_0x5905d1){const _0x261976=a37_0x27c1e2;console['log']('üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x5905d1);const _0x2f565c=await database_1[_0x261976(0x14b)][_0x261976(0x13b)][_0x261976(0xf5)]({'where':{'id':_0x5905d1},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2f565c)throw new Error(_0x261976(0x113));if(_0x2f565c['gateway']!==_0x261976(0xda)&&_0x2f565c[_0x261976(0xf1)]!==_0x261976(0x117))throw new Error(_0x261976(0xe8));console[_0x261976(0xd4)](_0x261976(0x11e)+_0x2f565c[_0x261976(0xf1)]+'\x20payment\x20'+_0x5905d1),await this[_0x261976(0x15e)](_0x2f565c),console[_0x261976(0xd4)]('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x5905d1);}[a37_0x27c1e2(0x1ab)](){const _0x255f9e=a37_0x27c1e2,_0x9c9cbd=this['globalCheckInterval']?this[_0x255f9e(0xfe)]:undefined,_0x1c6493=Array[_0x255f9e(0x199)](this[_0x255f9e(0x109)]['values']())[_0x255f9e(0xf8)](_0x2c31eb=>({'paymentId':_0x2c31eb['paymentId'],'gatewayPaymentId':_0x2c31eb[_0x255f9e(0x123)],'createdAt':_0x2c31eb[_0x255f9e(0x127)],'timersCount':_0x2c31eb[_0x255f9e(0x137)][_0x255f9e(0x131)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x255f9e(0xfe)]/(0x3e8*0x3c),'expiryDays':this[_0x255f9e(0x185)],'activeIndividualTimers':this[_0x255f9e(0x109)][_0x255f9e(0x106)],'nextGlobalCheckIn':_0x9c9cbd,'paymentTimersDetails':_0x1c6493};}['getPaymentTimerInfo'](_0x11b388){const _0x4945ba=a37_0x27c1e2,_0x4d837f=this[_0x4945ba(0x109)]['get'](_0x11b388);if(_0x4d837f)return{'hasTimers':!![],'timersCount':_0x4d837f[_0x4945ba(0x137)][_0x4945ba(0x131)],'createdAt':_0x4d837f[_0x4945ba(0x127)],'gatewayPaymentId':_0x4d837f['gatewayPaymentId']};return{'hasTimers':![]};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a37_0x27c1e2(0xd2)]=new CoinToPayStatusService();