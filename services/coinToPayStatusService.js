'use strict';const a38_0x5a67a2=a38_0xe7d1;(function(_0x1dc1a5,_0x3707cb){const _0x44b3d9=a38_0xe7d1,_0x57b211=_0x1dc1a5();while(!![]){try{const _0x4821fd=parseInt(_0x44b3d9(0x19f))/0x1*(-parseInt(_0x44b3d9(0xdb))/0x2)+parseInt(_0x44b3d9(0x14d))/0x3*(parseInt(_0x44b3d9(0x15a))/0x4)+-parseInt(_0x44b3d9(0x91))/0x5*(-parseInt(_0x44b3d9(0x12b))/0x6)+parseInt(_0x44b3d9(0x9f))/0x7+parseInt(_0x44b3d9(0x1a0))/0x8*(parseInt(_0x44b3d9(0x111))/0x9)+parseInt(_0x44b3d9(0x18b))/0xa*(-parseInt(_0x44b3d9(0x13f))/0xb)+parseInt(_0x44b3d9(0xa9))/0xc*(-parseInt(_0x44b3d9(0xc6))/0xd);if(_0x4821fd===_0x3707cb)break;else _0x57b211['push'](_0x57b211['shift']());}catch(_0x4f8977){_0x57b211['push'](_0x57b211['shift']());}}}(a38_0x3f07,0x1c05e));function a38_0xe7d1(_0x3f41cd,_0x2d1c97){const _0x3f0738=a38_0x3f07();return a38_0xe7d1=function(_0xe7d14,_0x3759cb){_0xe7d14=_0xe7d14-0x8f;let _0x924b44=_0x3f0738[_0xe7d14];return _0x924b44;},a38_0xe7d1(_0x3f41cd,_0x2d1c97);}var __importDefault=this&&this[a38_0x5a67a2(0xa8)]||function(_0x31bb92){const _0x520e9a=a38_0x5a67a2;return _0x31bb92&&_0x31bb92[_0x520e9a(0x1a1)]?_0x31bb92:{'default':_0x31bb92};};function a38_0x3f07(){const _0x4d85e9=['logShopWebhookSent','PENDING','📈\x20[COINTOPAY]\x20Payment\x20','✅\x20[CHECK]\x20Payment\x20','⏰\x20[GLOBAL]\x20Found\x20','entries','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','orderId','not\x20confirmed','paid','h),\x20skipping\x20global\x20check','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','set','Unknown\x20error','logCoinToPayError','\x20payment\x20','❌\x20[CHECK]\x20Payment\x20','logShopWebhookError','4419eTENez','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','bankDetails','⏰\x20[GLOBAL]\x20Payment\x20','\x20\x20\x20-\x20ShopId:\x20','🛑\x20[SHUTDOWN]\x20Cleared\x20','customerEmail','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','length','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','/status/','description','\x20\x20\x20Amount\x20after\x20commission:\x20','❌\x20[HOURLY]\x20Payment\x20','./gateways/coinToPayService','\x20has\x20no\x20gatewayPaymentId','\x20triggered\x20for\x20payment\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','paymentLink','🪙\x20[DEBUG]\x20Creating\x20','\x20not\x20found,\x20clearing\x20timers','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','adminNotes','createdOn','1099140dbiYir','\x20\x20\x20-\x20Status:\x20','\x20->\x20','\x20seconds\x20(','./gateways/coinToPay2Service','🔄\x20[CHECK]\x20Updating\x20payment\x20','size','getGatewayIdByName','includes','\x20completed\x20for\x20payment\x20','settings','\x20skipped,\x20',',\x20clearing\x20individual\x20timers',',\x20stopping\x20individual\x20checks','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','checkExpiredPayments','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','update','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','logWhiteDomainError','1342VxwGKy','\x20marked\x20as\x20paid\x20at:\x20','POST','created','2\x20minutes','paidAt','sendShopWebhook','payment','not\x20found','1\x20minute','Payment\x20not\x20found','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','timestamp','checkSinglePaymentById','25533BliaYq','\x20\x20\x20Gateway\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','floor','CoinToPayStatusService','createdAt','toLowerCase','timers','coinToPayStatusService','unknown','findUnique','currency','⏰\x20[HOURLY]\x20Payment\x20','44UKtNTe','payment.failed','paymentDetails','payment.success','EXPIRY_DAYS','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20expired\x20CoinToPay\x20payments','stack','Failed\x20to\x20send\x20shop\x20webhook:','checkAllPendingPayments','catch','COINTOPAY_ERROR','cointopay_status_check_','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','paymentLinkId','Failed\x20to\x20mark\x20payment\x20as\x20expired','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','log','TesSoft\x20Payment\x20System/1.0','\x20days\x20without\x20payment\x20confirmation','5\x20minutes','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','delete','\x20is\x20older\x20than\x20','sendPaymentStatusNotification','webhookLog','✅\x20[TIMER]\x20Individual\x20check\x20#','has','EXPIRED','\x20\x20\x20-\x20Amount:\x20','transactionId','iban','\x20\x20\x20📍\x20Source:\x20','\x20in\x20shop\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','shopId','Shop\x20webhook\x20sent\x20to\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20(age:\x20','forEach','cointopay_status_check_error','\x20status\x20changed\x20to\x20','sendPaymentNotification','defineProperty','push','toFixed','\x20updated\x20successfully','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','12370kfBjgQ','amountUSDT','webhook_send','status_check','⚠️\x20[CHECK]\x20Payment\x20','\x20status\x20from\x20','📊\x20[HOURLY]\x20Payment\x20','Automatically\x20expired\x20after\x20','-day\x20timeout','\x20\x20\x20❌\x20Error:\x20','type','\x20amounts\x20calculated:','gatewayOrderId','cointopay2','🧹\x20[DEBUG]\x20Clearing\x20','telegramBotService','getGatewayCommission','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','coinToPayService','12263PgKtfQ','664YrNsBb','__esModule','✅\x20[HOURLY]\x20Payment\x20','📊\x20[CHECK]\x20Payment\x20','\x20status\x20unchanged\x20(','5wiszer','\x20timers\x20for\x20payment\x20','COMPLETED','application/json','default','amountAfterGatewayCommissionUSDT','webhookUrl','convertToUSDT','toISOString','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','currentPayments','\x20\x20\x20-\x20paymentId:\x20','\x20days\x20(created\x20before\x20','\x20\x20\x20📝\x20Details:','1046801eEPVHA','confirmedOn','getDate',',\x20currentPayments=','remitterIban','\x20USDT','\x20days','shop','\x20current\x20status:\x20','__importDefault','62988rychRi','startPeriodicStatusCheck','Bank\x20Details:\x20',',\x20using\x20default\x20commission\x2010%','🧹\x20[CHECK]\x20Payment\x20','\x20individual\x20payment\x20timers','PAID',',\x20gateway\x20','\x20commission:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','logCoinToPayStatus','get','create','gatewayPaymentId','\x20days,\x20marking\x20as\x20EXPIRED','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','CoinToPayService','\x20not\x20enabled\x20for\x20shop\x20','\x20status:\x20','cointopay','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','customerName','delay','../types/gateway','stopPeriodicStatusCheck','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20for\x20payment\x20','104RCGLtH','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','paymentTimers','message','checkSinglePayment','now','\x20in\x20','💰\x20[CHECK]\x20Payment\x20','coinToPay2Service','gateway','clearPaymentTimers','\x20\x20\x20-\x20GatewayPaymentId:\x20','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','loggerService','from','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','payment.pending','./currencyService','stringify','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','26dmwkUw','status','\x20\x20\x20📊\x20Status:\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','auto_expire','\x20checked,\x20','gatewaySettings','getTime','Gateway\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','paymentId','findMany','Payment\x20older\x20than\x20','\x20\x20\x20📝\x20Context:','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...',':\x20type=','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','GLOBAL_CHECK_INTERVAL_MS','\x20not\x20found\x20in\x20database','globalCheckInterval','error','text','amount','./telegramBotService','\x20status\x20is\x20','COINTOPAY_STATUS_CHANGE','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','expired','CoinToPay2Service','🪙\x20[GLOBAL]\x20Found\x20','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','values',',\x20status='];a38_0x3f07=function(){return _0x4d85e9;};return a38_0x3f07();}Object[a38_0x5a67a2(0x185)](exports,a38_0x5a67a2(0x1a1),{'value':!![]}),exports[a38_0x5a67a2(0x155)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a38_0x5a67a2(0x121)),coinToPay2Service_1=require(a38_0x5a67a2(0x12f)),gateway_1=require(a38_0x5a67a2(0xc0)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a38_0x5a67a2(0xf3)),loggerService_1=require('./loggerService'),currencyService_1=require(a38_0x5a67a2(0xd8));class CoinToPayStatusService{constructor(){const _0x36c42f=a38_0x5a67a2;this[_0x36c42f(0xef)]=null,this[_0x36c42f(0xed)]=0x3c*0x3c*0x3e8,this[_0x36c42f(0x15e)]=0x5,this[_0x36c42f(0xc8)]=new Map(),this[_0x36c42f(0x19e)]=new coinToPayService_1[(_0x36c42f(0xb9))](),this[_0x36c42f(0xce)]=new coinToPay2Service_1[(_0x36c42f(0xf9))](),console[_0x36c42f(0x16b)]('🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}['schedulePaymentChecks'](_0x53b202,_0xad38ff){const _0x57aad8=a38_0x5a67a2;console[_0x57aad8(0x16b)](_0x57aad8(0xc7)),console[_0x57aad8(0x16b)](_0x57aad8(0x9c)+_0x53b202),console[_0x57aad8(0x16b)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0xad38ff),this['clearPaymentTimers'](_0x53b202);const _0x193172=[],_0x159f7f=new Date(),_0x5b6763=[{'delay':0x1*0x3c*0x3e8,'description':_0x57aad8(0x148)},{'delay':0x2*0x3c*0x3e8,'description':_0x57aad8(0x143)},{'delay':0x5*0x3c*0x3e8,'description':_0x57aad8(0x16e)},{'delay':0x5*0x3c*0x3e8,'description':_0x57aad8(0x16e)}];console['log'](_0x57aad8(0x126)+_0x5b6763[_0x57aad8(0x11a)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x53b202);let _0x59e504=0x0;_0x5b6763[_0x57aad8(0x181)]((_0xf56e9e,_0x4f32f5)=>{const _0x1f6bf1=_0x57aad8;_0x59e504+=_0xf56e9e[_0x1f6bf1(0xbf)];const _0xabd442=setTimeout(async()=>{const _0x55529b=_0x1f6bf1;console[_0x55529b(0x16b)](_0x55529b(0x119)+(_0x4f32f5+0x1)+_0x55529b(0x123)+_0x53b202+'\x20(after\x20'+_0xf56e9e[_0x55529b(0x11e)]+')');try{await this[_0x55529b(0x14c)](_0x53b202),console[_0x55529b(0x16b)](_0x55529b(0x174)+(_0x4f32f5+0x1)+_0x55529b(0x134)+_0x53b202);}catch(_0x37ad07){console[_0x55529b(0xf0)](_0x55529b(0xd6)+(_0x4f32f5+0x1)+_0x55529b(0xc5)+_0x53b202+':',_0x37ad07),this['logCoinToPayError'](_0x53b202,_0xad38ff,_0x37ad07,'status_check',{'checkNumber':_0x4f32f5+0x1,'scheduledAfter':_0xf56e9e[_0x55529b(0x11e)],'isIndividualCheck':!![]});}},_0x59e504);_0x193172['push'](_0xabd442),console[_0x1f6bf1(0x16b)](_0x1f6bf1(0x189)+(_0x4f32f5+0x1)+_0x1f6bf1(0xc5)+_0x53b202+_0x1f6bf1(0xcc)+_0x59e504/0x3e8+_0x1f6bf1(0x12e)+_0xf56e9e[_0x1f6bf1(0x11e)]+')');});const _0x49586a=setInterval(async()=>{const _0x3d9647=_0x57aad8;console[_0x3d9647(0x16b)](_0x3d9647(0x112)+_0x53b202);try{const _0x5f0b29=await database_1['default'][_0x3d9647(0x146)][_0x3d9647(0x157)]({'where':{'id':_0x53b202},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x5f0b29){console[_0x3d9647(0x16b)](_0x3d9647(0x120)+_0x53b202+_0x3d9647(0x127)),this[_0x3d9647(0xd0)](_0x53b202);return;}console['log'](_0x3d9647(0x191)+_0x53b202+_0x3d9647(0xa7)+_0x5f0b29[_0x3d9647(0xdc)]);if(_0x5f0b29[_0x3d9647(0xdc)]!==_0x3d9647(0x100)){console[_0x3d9647(0x16b)](_0x3d9647(0x1a2)+_0x53b202+_0x3d9647(0xf4)+_0x5f0b29[_0x3d9647(0xdc)]+_0x3d9647(0x138)),this[_0x3d9647(0xd0)](_0x53b202);return;}const _0x44807e=Math['floor']((Date['now']()-_0x5f0b29['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x44807e>=this[_0x3d9647(0x15e)]){console['log'](_0x3d9647(0x159)+_0x53b202+_0x3d9647(0x171)+this[_0x3d9647(0x15e)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this['clearPaymentTimers'](_0x53b202);return;}await this[_0x3d9647(0x14c)](_0x53b202),console[_0x3d9647(0x16b)](_0x3d9647(0x139)+_0x53b202);}catch(_0x29ef8e){console[_0x3d9647(0xf0)]('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x53b202+':',_0x29ef8e),this[_0x3d9647(0x10d)](_0x53b202,_0xad38ff,_0x29ef8e,_0x3d9647(0x18e),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x193172['push'](_0x49586a),this[_0x57aad8(0xc8)][_0x57aad8(0x10b)](_0x53b202,{'timers':_0x193172,'paymentId':_0x53b202,'gatewayPaymentId':_0xad38ff,'createdAt':_0x159f7f}),console[_0x57aad8(0x16b)](_0x57aad8(0x18a)+_0x5b6763[_0x57aad8(0x11a)]+_0x57aad8(0x17f)+_0x53b202),console['log'](_0x57aad8(0xc3)+this['paymentTimers']['size']),this[_0x57aad8(0xb3)](_0x53b202,_0xad38ff,_0x57aad8(0x100),_0x57aad8(0x100),'status_check',{'action':'schedule_created','scheduledChecks':_0x5b6763[_0x57aad8(0x11a)],'firstCheckIn':_0x5b6763[0x0][_0x57aad8(0xbf)]/0x3e8,'totalTimers':this['paymentTimers'][_0x57aad8(0x131)]});}[a38_0x5a67a2(0xd0)](_0x16ea6e){const _0xdea349=a38_0x5a67a2,_0x1e9ea0=this[_0xdea349(0xc8)]['get'](_0x16ea6e);_0x1e9ea0?(console[_0xdea349(0x16b)](_0xdea349(0x199)+_0x1e9ea0[_0xdea349(0x154)][_0xdea349(0x11a)]+_0xdea349(0x92)+_0x16ea6e),_0x1e9ea0[_0xdea349(0x154)]['forEach']((_0x50f1b1,_0x393452)=>{const _0x128e28=_0xdea349;_0x50f1b1&&(clearTimeout(_0x50f1b1),clearInterval(_0x50f1b1),console[_0x128e28(0x16b)]('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x393452+0x1)+'\x20for\x20payment\x20'+_0x16ea6e));}),this[_0xdea349(0xc8)][_0xdea349(0x170)](_0x16ea6e),console[_0xdea349(0x16b)](_0xdea349(0x11b)+_0x16ea6e+'.\x20Remaining\x20active\x20timers:\x20'+this[_0xdea349(0xc8)][_0xdea349(0x131)])):console[_0xdea349(0x16b)]('⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x16ea6e+'\x20to\x20clear');}async[a38_0x5a67a2(0x14c)](_0x150446){const _0x3e497c=a38_0x5a67a2;console[_0x3e497c(0x16b)](_0x3e497c(0x118)+_0x150446);const _0x2be0ef=await database_1['default'][_0x3e497c(0x146)]['findUnique']({'where':{'id':_0x150446},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2be0ef){console[_0x3e497c(0x16b)](_0x3e497c(0x10f)+_0x150446+_0x3e497c(0xee));return;}console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x150446+'\x20found:'),console[_0x3e497c(0x16b)]('\x20\x20\x20-\x20Gateway:\x20'+_0x2be0ef[_0x3e497c(0xcf)]),console['log'](_0x3e497c(0x12c)+_0x2be0ef['status']),console[_0x3e497c(0x16b)](_0x3e497c(0xd1)+_0x2be0ef[_0x3e497c(0xb6)]),console[_0x3e497c(0x16b)](_0x3e497c(0x177)+_0x2be0ef['amount']+'\x20'+_0x2be0ef[_0x3e497c(0x158)]),console[_0x3e497c(0x16b)](_0x3e497c(0x115)+_0x2be0ef[_0x3e497c(0x17d)]);if(_0x2be0ef[_0x3e497c(0xcf)]!==_0x3e497c(0xbc)&&_0x2be0ef[_0x3e497c(0xcf)]!==_0x3e497c(0x198)){console[_0x3e497c(0x16b)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x150446+_0x3e497c(0xbd)+_0x2be0ef[_0x3e497c(0xcf)]+')');return;}if(_0x2be0ef[_0x3e497c(0xdc)]!==_0x3e497c(0x100)){console['log'](_0x3e497c(0x18f)+_0x150446+_0x3e497c(0xf4)+_0x2be0ef['status']+_0x3e497c(0x138)),this[_0x3e497c(0xd0)](_0x150446);return;}if(!_0x2be0ef[_0x3e497c(0xb6)]){console[_0x3e497c(0x16b)](_0x3e497c(0x18f)+_0x150446+_0x3e497c(0x122));return;}console[_0x3e497c(0x16b)](_0x3e497c(0x102)+_0x150446+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x3e497c(0xca)](_0x2be0ef);}['logCoinToPayStatus'](_0x3c55ad,_0x5d55fe,_0x35fb90,_0xa28ff7,_0x13297,_0x267e9f){const _0x5ac8c4=a38_0x5a67a2,_0x4f22cf={'type':_0x5ac8c4(0xf5),'paymentId':_0x3c55ad,'gatewayPaymentId':_0x5d55fe,'oldStatus':_0x35fb90,'newStatus':_0xa28ff7,'source':_0x13297,'timestamp':new Date()[_0x5ac8c4(0x99)](),'details':_0x267e9f||{}};loggerService_1[_0x5ac8c4(0xd3)]['logCoinToPayStatus'](_0x4f22cf),console['log'](_0x5ac8c4(0xfc)+_0x3c55ad+'\x20('+_0x5d55fe+')'),console[_0x5ac8c4(0x16b)](_0x5ac8c4(0xdd)+_0x35fb90+'\x20->\x20'+_0xa28ff7),console[_0x5ac8c4(0x16b)]('\x20\x20\x20📍\x20Source:\x20'+_0x13297),console[_0x5ac8c4(0x16b)]('\x20\x20\x20📅\x20Time:\x20'+_0x4f22cf[_0x5ac8c4(0x14b)]),_0x267e9f&&console['log'](_0x5ac8c4(0x9e),_0x267e9f);}[a38_0x5a67a2(0x10d)](_0xc15724,_0x54caa4,_0x3f6a63,_0x11f444,_0x470316){const _0x5d27e6=a38_0x5a67a2,_0x1af3f7={'type':_0x5d27e6(0x165),'paymentId':_0xc15724,'gatewayPaymentId':_0x54caa4,'error':_0x3f6a63 instanceof Error?{'message':_0x3f6a63['message'],'stack':_0x3f6a63[_0x5d27e6(0x161)]}:_0x3f6a63,'source':_0x11f444,'timestamp':new Date()['toISOString'](),'context':_0x470316||{}};loggerService_1[_0x5d27e6(0xd3)][_0x5d27e6(0x10d)](_0x1af3f7),console[_0x5d27e6(0xf0)]('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0xc15724+'\x20('+_0x54caa4+')'),console[_0x5d27e6(0xf0)](_0x5d27e6(0x194)+(_0x3f6a63 instanceof Error?_0x3f6a63[_0x5d27e6(0xc9)]:_0x3f6a63)),console['error'](_0x5d27e6(0x17a)+_0x11f444),console[_0x5d27e6(0xf0)]('\x20\x20\x20📅\x20Time:\x20'+_0x1af3f7['timestamp']),_0x470316&&console[_0x5d27e6(0xf0)](_0x5d27e6(0xe9),_0x470316);}[a38_0x5a67a2(0xaa)](){const _0x58a152=a38_0x5a67a2;console[_0x58a152(0x16b)]('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this['checkAllPendingPayments']()[_0x58a152(0x164)](_0x33a2e1=>{const _0x48b4b1=_0x58a152;console[_0x48b4b1(0xf0)](_0x48b4b1(0xe5),_0x33a2e1);}),this[_0x58a152(0xef)]=setInterval(async()=>{const _0x3e3960=_0x58a152;try{console[_0x3e3960(0x16b)](_0x3e3960(0xc4)),await this[_0x3e3960(0x163)](),console[_0x3e3960(0x16b)](_0x3e3960(0x13d));}catch(_0x334e50){console['error'](_0x3e3960(0xde),_0x334e50);}},this['GLOBAL_CHECK_INTERVAL_MS']),console['log'](_0x58a152(0x128));}[a38_0x5a67a2(0xc1)](){const _0x2d3e6c=a38_0x5a67a2;console['log'](_0x2d3e6c(0x14f));this[_0x2d3e6c(0xef)]&&(clearInterval(this[_0x2d3e6c(0xef)]),this[_0x2d3e6c(0xef)]=null,console[_0x2d3e6c(0x16b)](_0x2d3e6c(0xb8)));const _0x469824=this[_0x2d3e6c(0xc8)][_0x2d3e6c(0x131)];for(const [_0x3924d1]of this['paymentTimers']){this['clearPaymentTimers'](_0x3924d1);}console[_0x2d3e6c(0x16b)](_0x2d3e6c(0x116)+_0x469824+_0x2d3e6c(0xae));}async['checkAllPendingPayments'](){const _0x1c43c7=a38_0x5a67a2;try{console['log'](_0x1c43c7(0xea));const _0x2d737e=await database_1[_0x1c43c7(0x95)][_0x1c43c7(0x146)][_0x1c43c7(0xe7)]({'where':{'gateway':{'in':['cointopay',_0x1c43c7(0x198)]},'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x1c43c7(0x16b)](_0x1c43c7(0xfa)+_0x2d737e[_0x1c43c7(0x11a)]+'\x20pending\x20CoinToPay\x20payments');if(_0x2d737e[_0x1c43c7(0x11a)]===0x0){console[_0x1c43c7(0x16b)](_0x1c43c7(0x105));return;}const _0x2a1d35=await this[_0x1c43c7(0x13a)](_0x2d737e);console[_0x1c43c7(0x16b)](_0x1c43c7(0x103)+_0x2a1d35[_0x1c43c7(0x11a)]+_0x1c43c7(0x160));let _0x5a73fa=0x0,_0x2d5deb=0x0;for(const _0x4b31b9 of _0x2d737e){try{if(_0x2a1d35['includes'](_0x4b31b9['id'])){console['log'](_0x1c43c7(0x114)+_0x4b31b9['id']+_0x1c43c7(0x124)),_0x2d5deb++;continue;}if(this[_0x1c43c7(0xc8)][_0x1c43c7(0x175)](_0x4b31b9['id'])){console[_0x1c43c7(0x16b)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x4b31b9['id']+_0x1c43c7(0xec)),_0x2d5deb++;continue;}const _0xa8f286=(Date[_0x1c43c7(0xcb)]()-_0x4b31b9[_0x1c43c7(0x152)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0xa8f286<0x1){console[_0x1c43c7(0x16b)](_0x1c43c7(0x114)+_0x4b31b9['id']+'\x20is\x20too\x20new\x20('+_0xa8f286[_0x1c43c7(0x187)](0x1)+_0x1c43c7(0x109)),_0x2d5deb++;continue;}console[_0x1c43c7(0x16b)]('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x4b31b9['id']+_0x1c43c7(0x180)+_0xa8f286['toFixed'](0x1)+'h)'),await this['checkSinglePayment'](_0x4b31b9),_0x5a73fa++,await new Promise(_0x29ba32=>setTimeout(_0x29ba32,0x7d0));}catch(_0x162fcb){console[_0x1c43c7(0xf0)](_0x1c43c7(0x13b)+_0x4b31b9['id']+':',_0x162fcb),this['logCoinToPayError'](_0x4b31b9['id'],_0x4b31b9[_0x1c43c7(0xb6)]||_0x1c43c7(0x156),_0x162fcb,_0x1c43c7(0x18e),{'isGlobalCheck':!![],'paymentAmount':_0x4b31b9[_0x1c43c7(0xf2)],'paymentCurrency':_0x4b31b9[_0x1c43c7(0x158)],'shopId':_0x4b31b9['shopId'],'createdAt':_0x4b31b9['createdAt']}),loggerService_1['loggerService'][_0x1c43c7(0x13e)](_0x1c43c7(0xbc),_0x1c43c7(0x11d)+_0x4b31b9['gatewayPaymentId'],_0x162fcb);}}console['log'](_0x1c43c7(0x10a)+_0x5a73fa+_0x1c43c7(0xe1)+_0x2d5deb+_0x1c43c7(0x136)+_0x2a1d35['length']+'\x20expired');}catch(_0x1f235d){console[_0x1c43c7(0xf0)]('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x1f235d);}}async[a38_0x5a67a2(0x13a)](_0x155dbe){const _0x5ca6c5=a38_0x5a67a2,_0x8a41d=[],_0x2ccda9=new Date();_0x2ccda9['setDate'](_0x2ccda9[_0x5ca6c5(0xa1)]()-this[_0x5ca6c5(0x15e)]),console[_0x5ca6c5(0x16b)](_0x5ca6c5(0xd5)+this[_0x5ca6c5(0x15e)]+_0x5ca6c5(0x9d)+_0x2ccda9[_0x5ca6c5(0x99)]()+')');for(const _0xf91c64 of _0x155dbe){if(_0xf91c64[_0x5ca6c5(0x152)]<_0x2ccda9){console[_0x5ca6c5(0x16b)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0xf91c64['id']+_0x5ca6c5(0x171)+this[_0x5ca6c5(0x15e)]+_0x5ca6c5(0xb7));try{this[_0x5ca6c5(0xb3)](_0xf91c64['id'],_0xf91c64[_0x5ca6c5(0xb6)]||'unknown',_0x5ca6c5(0x100),'EXPIRED',_0x5ca6c5(0xe0),{'reason':_0x5ca6c5(0xe8)+this[_0x5ca6c5(0x15e)]+_0x5ca6c5(0xa5),'createdAt':_0xf91c64[_0x5ca6c5(0x152)],'daysSinceCreation':Math[_0x5ca6c5(0x150)]((Date[_0x5ca6c5(0xcb)]()-_0xf91c64[_0x5ca6c5(0x152)][_0x5ca6c5(0xe3)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0xf91c64[_0x5ca6c5(0xf2)],'paymentCurrency':_0xf91c64[_0x5ca6c5(0x158)],'shopId':_0xf91c64[_0x5ca6c5(0x17d)]}),await database_1[_0x5ca6c5(0x95)][_0x5ca6c5(0x146)][_0x5ca6c5(0x13c)]({'where':{'id':_0xf91c64['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x5ca6c5(0x192)+this[_0x5ca6c5(0x15e)]+_0x5ca6c5(0x16d)}}),await database_1[_0x5ca6c5(0x95)][_0x5ca6c5(0x173)][_0x5ca6c5(0xb5)]({'data':{'paymentId':_0xf91c64['id'],'shopId':_0xf91c64[_0x5ca6c5(0x17d)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x5ca6c5(0xd9)]({'reason':_0x5ca6c5(0xe8)+this[_0x5ca6c5(0x15e)]+_0x5ca6c5(0xa5),'createdAt':_0xf91c64['createdAt'],'expiredAt':new Date()[_0x5ca6c5(0x99)](),'daysSinceCreation':Math[_0x5ca6c5(0x150)]((Date[_0x5ca6c5(0xcb)]()-_0xf91c64['createdAt'][_0x5ca6c5(0xe3)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0xf91c64,_0x5ca6c5(0x176)),await this['sendPaymentStatusNotification'](_0xf91c64,_0x5ca6c5(0x176)),this[_0x5ca6c5(0xd0)](_0xf91c64['id']),_0x8a41d[_0x5ca6c5(0x186)](_0xf91c64['id']),console[_0x5ca6c5(0x16b)]('✅\x20[EXPIRY]\x20Payment\x20'+_0xf91c64['id']+_0x5ca6c5(0xf7)+this[_0x5ca6c5(0x15e)]+_0x5ca6c5(0x193));}catch(_0x4ab498){console['error'](_0x5ca6c5(0xdf)+_0xf91c64['id']+':',_0x4ab498),this[_0x5ca6c5(0x10d)](_0xf91c64['id'],_0xf91c64[_0x5ca6c5(0xb6)]||'unknown',_0x4ab498,_0x5ca6c5(0xe0),{'reason':_0x5ca6c5(0x169),'createdAt':_0xf91c64[_0x5ca6c5(0x152)],'daysSinceCreation':Math[_0x5ca6c5(0x150)]((Date[_0x5ca6c5(0xcb)]()-_0xf91c64[_0x5ca6c5(0x152)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x8a41d;}async[a38_0x5a67a2(0xca)](_0x39b5a7){const _0x338ead=a38_0x5a67a2;if(!_0x39b5a7[_0x338ead(0xb6)]){console[_0x338ead(0x16b)](_0x338ead(0x18f)+_0x39b5a7['id']+_0x338ead(0x15f));return;}console[_0x338ead(0x16b)]('🔍\x20[CHECK]\x20Checking\x20'+_0x39b5a7['gateway']+_0x338ead(0x10e)+_0x39b5a7['id']+'\x20('+_0x39b5a7[_0x338ead(0xb6)]+')');try{let _0x13af4e;_0x39b5a7[_0x338ead(0xcf)]==='cointopay2'?(_0x13af4e=await this['coinToPay2Service']['checkPaymentStatus'](_0x39b5a7[_0x338ead(0xb6)]),console[_0x338ead(0x16b)](_0x338ead(0x16a)+_0x39b5a7['id']+_0x338ead(0xbb)+_0x13af4e[_0x338ead(0xdc)])):(_0x13af4e=await this[_0x338ead(0x19e)]['checkPaymentStatus'](_0x39b5a7['gatewayPaymentId']),console['log'](_0x338ead(0xfb)+_0x39b5a7['id']+_0x338ead(0xbb)+_0x13af4e[_0x338ead(0xdc)]));_0x13af4e[_0x338ead(0x15c)]&&console[_0x338ead(0x16b)]('📊\x20[CHECK]\x20Payment\x20'+_0x39b5a7['id']+'\x20details:',{'iban':_0x13af4e[_0x338ead(0x15c)]['iban']||_0x338ead(0x147),'transactionId':_0x13af4e[_0x338ead(0x15c)][_0x338ead(0x178)],'createdOn':_0x13af4e['paymentDetails'][_0x338ead(0x12a)],'confirmedOn':_0x13af4e['paymentDetails'][_0x338ead(0xa0)]||_0x338ead(0x107)});if(_0x13af4e['status']!==_0x39b5a7[_0x338ead(0xdc)]){console['log'](_0x338ead(0x130)+_0x39b5a7['id']+_0x338ead(0x190)+_0x39b5a7['status']+'\x20to\x20'+_0x13af4e['status']),this['logCoinToPayStatus'](_0x39b5a7['id'],_0x39b5a7[_0x338ead(0xb6)],_0x39b5a7[_0x338ead(0xdc)],_0x13af4e[_0x338ead(0xdc)],'status_check',{'paymentDetails':_0x13af4e['paymentDetails'],'amount':_0x13af4e[_0x338ead(0xf2)],'currency':_0x13af4e[_0x338ead(0x158)],'shopId':_0x39b5a7[_0x338ead(0x17d)],'checkTimestamp':new Date()['toISOString']()});const _0x5d00db={'status':_0x13af4e[_0x338ead(0xdc)],'updatedAt':new Date()};if(_0x13af4e[_0x338ead(0xdc)]===_0x338ead(0xaf)&&_0x39b5a7[_0x338ead(0xdc)]!==_0x338ead(0xaf)){_0x5d00db[_0x338ead(0x144)]=new Date();if(!_0x39b5a7['amountUSDT']){const _0x2b871d=await currencyService_1['currencyService'][_0x338ead(0x98)](_0x39b5a7[_0x338ead(0xf2)],_0x39b5a7[_0x338ead(0x158)]);_0x5d00db[_0x338ead(0x18c)]=_0x2b871d;const _0x1a612b=await this['getGatewayCommission'](_0x39b5a7[_0x338ead(0x17d)],_0x39b5a7[_0x338ead(0xcf)]),_0x2ce432=_0x2b871d*(0x1-_0x1a612b/0x64);_0x5d00db[_0x338ead(0x96)]=_0x2ce432,console[_0x338ead(0x16b)]('💰\x20[CHECK]\x20Payment\x20'+_0x39b5a7['id']+_0x338ead(0x196)),console[_0x338ead(0x16b)]('\x20\x20\x20Amount:\x20'+_0x39b5a7[_0x338ead(0xf2)]+'\x20'+_0x39b5a7[_0x338ead(0x158)]+_0x338ead(0x12d)+_0x2b871d[_0x338ead(0x187)](0x6)+_0x338ead(0xa4)),console[_0x338ead(0x16b)](_0x338ead(0x14e)+_0x39b5a7['gateway']+_0x338ead(0xb1)+_0x1a612b+'%'),console['log'](_0x338ead(0x11f)+_0x2ce432[_0x338ead(0x187)](0x6)+_0x338ead(0xa4));}console['log'](_0x338ead(0xcd)+_0x39b5a7['id']+_0x338ead(0x140)+_0x5d00db['paidAt'][_0x338ead(0x99)]());}if(_0x13af4e['paymentDetails']){const _0xdc424=_0x13af4e[_0x338ead(0x15c)];_0xdc424[_0x338ead(0x179)]&&(_0x5d00db[_0x338ead(0xa3)]=_0xdc424[_0x338ead(0x179)],console[_0x338ead(0x16b)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0xdc424[_0x338ead(0x179)]));if(_0xdc424[_0x338ead(0x113)]){const _0x5b3eb9=_0x39b5a7['adminNotes']||'',_0x5f5925=_0x338ead(0xab)+_0xdc424['bankDetails'];_0x5d00db[_0x338ead(0x129)]=_0x5b3eb9?_0x5b3eb9+'\x0a\x0a'+_0x5f5925:_0x5f5925,console['log'](_0x338ead(0xd2));}_0xdc424[_0x338ead(0x178)]&&console['log'](_0x338ead(0x19d)+_0xdc424[_0x338ead(0x178)]),_0xdc424[_0x338ead(0xa0)]&&console[_0x338ead(0x16b)](_0x338ead(0xc2)+_0xdc424[_0x338ead(0xa0)]);}await database_1[_0x338ead(0x95)][_0x338ead(0x146)][_0x338ead(0x13c)]({'where':{'id':_0x39b5a7['id']},'data':_0x5d00db});if(_0x13af4e['status']===_0x338ead(0xaf)&&_0x39b5a7['status']!=='PAID'){console[_0x338ead(0x16b)]('📈\x20[COINTOPAY]\x20Payment\x20'+_0x39b5a7['id']+_0x338ead(0x16f));const _0x2b8682=await database_1[_0x338ead(0x95)][_0x338ead(0x146)][_0x338ead(0x157)]({'where':{'id':_0x39b5a7['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x2b8682?.[_0x338ead(0x168)]&&_0x2b8682[_0x338ead(0x125)])try{const _0x320ea2=_0x2b8682[_0x338ead(0x125)];console[_0x338ead(0x16b)]('📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x320ea2['id']+_0x338ead(0xeb)+_0x320ea2[_0x338ead(0x195)]+_0x338ead(0xa2)+_0x320ea2[_0x338ead(0x9b)]+_0x338ead(0xfe)+_0x320ea2[_0x338ead(0xdc)]);const _0x4518ee=_0x320ea2[_0x338ead(0x9b)]+0x1,_0x6e5025=_0x320ea2['type']==='SINGLE'?_0x338ead(0x93):_0x320ea2[_0x338ead(0xdc)];await database_1[_0x338ead(0x95)]['paymentLink'][_0x338ead(0x13c)]({'where':{'id':_0x320ea2['id']},'data':{'currentPayments':_0x4518ee,'status':_0x6e5025,'updatedAt':new Date()}}),console[_0x338ead(0x16b)]('✅\x20[COINTOPAY]\x20Payment\x20link\x20'+_0x320ea2['id']+'\x20updated:\x20currentPayments='+_0x320ea2[_0x338ead(0x9b)]+_0x338ead(0x12d)+_0x4518ee+_0x338ead(0xfe)+_0x320ea2[_0x338ead(0xdc)]+_0x338ead(0x12d)+_0x6e5025);}catch(_0x264cf5){console[_0x338ead(0xf0)](_0x338ead(0xda),_0x264cf5);}else console['log'](_0x338ead(0x101)+_0x39b5a7['id']+_0x338ead(0x19c));}await database_1['default'][_0x338ead(0x173)][_0x338ead(0xb5)]({'data':{'paymentId':_0x39b5a7['id'],'shopId':_0x39b5a7[_0x338ead(0x17d)],'event':_0x338ead(0x166)+_0x13af4e['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x39b5a7[_0x338ead(0xdc)],'newStatus':_0x13af4e[_0x338ead(0xdc)],'paymentDetails':_0x13af4e[_0x338ead(0x15c)],'checkedAt':new Date()[_0x338ead(0x99)]()})}}),await this[_0x338ead(0x145)](_0x39b5a7,_0x13af4e[_0x338ead(0xdc)]),await this[_0x338ead(0x172)](_0x39b5a7,_0x13af4e[_0x338ead(0xdc)]),_0x13af4e[_0x338ead(0xdc)]!==_0x338ead(0x100)&&(console['log'](_0x338ead(0xad)+_0x39b5a7['id']+_0x338ead(0x183)+_0x13af4e[_0x338ead(0xdc)]+_0x338ead(0x137)),this['clearPaymentTimers'](_0x39b5a7['id'])),console['log'](_0x338ead(0x102)+_0x39b5a7['id']+_0x338ead(0x188));}else console['log'](_0x338ead(0x8f)+_0x39b5a7['id']+_0x338ead(0x90)+_0x13af4e['status']+')'),this['logCoinToPayStatus'](_0x39b5a7['id'],_0x39b5a7['gatewayPaymentId'],_0x39b5a7[_0x338ead(0xdc)],_0x13af4e[_0x338ead(0xdc)],_0x338ead(0x18e),{'statusUnchanged':!![],'paymentDetails':_0x13af4e[_0x338ead(0x15c)],'amount':_0x13af4e['amount'],'currency':_0x13af4e[_0x338ead(0x158)],'shopId':_0x39b5a7['shopId'],'checkTimestamp':new Date()[_0x338ead(0x99)]()});}catch(_0x51097b){console['error']('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x39b5a7['id']+':',_0x51097b),this[_0x338ead(0x10d)](_0x39b5a7['id'],_0x39b5a7[_0x338ead(0xb6)],_0x51097b,_0x338ead(0x18e),{'paymentAmount':_0x39b5a7[_0x338ead(0xf2)],'paymentCurrency':_0x39b5a7[_0x338ead(0x158)],'shopId':_0x39b5a7[_0x338ead(0x17d)],'createdAt':_0x39b5a7[_0x338ead(0x152)]}),await database_1[_0x338ead(0x95)][_0x338ead(0x173)][_0x338ead(0xb5)]({'data':{'paymentId':_0x39b5a7['id'],'shopId':_0x39b5a7[_0x338ead(0x17d)],'event':_0x338ead(0x182),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x51097b instanceof Error?_0x51097b[_0x338ead(0xc9)]:_0x338ead(0x10c),'gatewayPaymentId':_0x39b5a7['gatewayPaymentId'],'checkedAt':new Date()[_0x338ead(0x99)]()})}});}}async[a38_0x5a67a2(0x145)](_0x28a033,_0x2ba512){const _0x506dc7=a38_0x5a67a2,_0x3f4964=Date[_0x506dc7(0xcb)]();try{const _0x118310=_0x28a033[_0x506dc7(0xa6)],_0x4bb213=_0x118310[_0x506dc7(0x135)];if(!_0x4bb213?.[_0x506dc7(0x97)]){console['log'](_0x506dc7(0xb2)+_0x118310['id']);return;}const _0x5e159c=_0x2ba512==='PAID'?_0x506dc7(0x15d):_0x2ba512==='FAILED'?_0x506dc7(0x15b):_0x2ba512===_0x506dc7(0x176)?_0x506dc7(0x15b):_0x506dc7(0xd7);if(!_0x4bb213['webhookEvents']?.[_0x506dc7(0x133)](_0x5e159c)){console['log']('Webhook\x20event\x20'+_0x5e159c+_0x506dc7(0xba)+_0x118310['id']);return;}const _0x9b63f7=(0x0,gateway_1[_0x506dc7(0x132)])(_0x28a033['gateway'])||_0x28a033['gateway'],_0x10adf1={'event':_0x5e159c,'payment':{'id':_0x28a033['id'],'order_id':_0x28a033[_0x506dc7(0x106)],'gateway_order_id':_0x28a033[_0x506dc7(0x197)],'gateway':_0x9b63f7,'amount':_0x28a033['amount'],'currency':_0x28a033[_0x506dc7(0x158)],'status':_0x2ba512[_0x506dc7(0x153)](),'customer_email':_0x28a033[_0x506dc7(0x117)],'customer_name':_0x28a033[_0x506dc7(0xbe)],'created_at':_0x28a033[_0x506dc7(0x152)],'updated_at':new Date()}},_0x52a669=await fetch(_0x4bb213[_0x506dc7(0x97)],{'method':_0x506dc7(0x141),'headers':{'Content-Type':_0x506dc7(0x94),'User-Agent':_0x506dc7(0x16c)},'body':JSON[_0x506dc7(0xd9)](_0x10adf1)}),_0x34f727=Date['now']()-_0x3f4964,_0x4e07d8=_0x52a669['ok']?'Success':await _0x52a669[_0x506dc7(0xf1)]();loggerService_1[_0x506dc7(0xd3)][_0x506dc7(0xff)](_0x28a033[_0x506dc7(0x17d)],_0x4bb213[_0x506dc7(0x97)],_0x5e159c,_0x52a669[_0x506dc7(0xdc)],_0x34f727,_0x10adf1),console[_0x506dc7(0x16b)](_0x506dc7(0x17e)+_0x4bb213['webhookUrl']+'\x20with\x20status\x20'+_0x52a669['status']+'\x20('+_0x34f727+'ms)');}catch(_0x455741){console[_0x506dc7(0xf0)](_0x506dc7(0x162),_0x455741),loggerService_1['loggerService'][_0x506dc7(0x110)](_0x28a033[_0x506dc7(0x17d)],_0x28a033['shop']?.['settings']?.['webhookUrl']||_0x506dc7(0x156),_0x506dc7(0x18d),_0x455741,{});}}async[a38_0x5a67a2(0x172)](_0x34a873,_0xab1104){const _0x332dca=a38_0x5a67a2;try{const _0x4d932d={'PENDING':_0x332dca(0x142),'PAID':_0x332dca(0x108),'FAILED':'failed','EXPIRED':_0x332dca(0xf8)},_0x3f7401=_0x4d932d[_0xab1104];if(!_0x3f7401||_0x3f7401===_0x332dca(0x142))return;await telegramBotService_1[_0x332dca(0x19a)][_0x332dca(0x184)](_0x34a873[_0x332dca(0x17d)],_0x34a873,_0x3f7401);}catch(_0xf6f463){console['error'](_0x332dca(0x17c),_0xf6f463);}}async['checkPaymentById'](_0x9a8e42){const _0x3975a2=a38_0x5a67a2;console[_0x3975a2(0x16b)](_0x3975a2(0x14a)+_0x9a8e42);const _0x5421cf=await database_1[_0x3975a2(0x95)]['payment']['findUnique']({'where':{'id':_0x9a8e42},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5421cf)throw new Error(_0x3975a2(0x149));if(_0x5421cf[_0x3975a2(0xcf)]!==_0x3975a2(0xbc)&&_0x5421cf[_0x3975a2(0xcf)]!=='cointopay2')throw new Error(_0x3975a2(0x9a));console[_0x3975a2(0x16b)](_0x3975a2(0xf6)+_0x5421cf[_0x3975a2(0xcf)]+_0x3975a2(0x10e)+_0x9a8e42),await this[_0x3975a2(0xca)](_0x5421cf),console[_0x3975a2(0x16b)](_0x3975a2(0x11c)+_0x9a8e42);}['getServiceStats'](){const _0x565ec2=a38_0x5a67a2,_0x5c14a8=this[_0x565ec2(0xef)]?this[_0x565ec2(0xed)]:undefined,_0x411eb1=Array[_0x565ec2(0xd4)](this[_0x565ec2(0xc8)][_0x565ec2(0xfd)]())['map'](_0x51c826=>({'paymentId':_0x51c826[_0x565ec2(0xe6)],'gatewayPaymentId':_0x51c826[_0x565ec2(0xb6)],'createdAt':_0x51c826[_0x565ec2(0x152)],'timersCount':_0x51c826[_0x565ec2(0x154)][_0x565ec2(0x11a)]}));return{'isActive':!!this[_0x565ec2(0xef)],'globalCheckIntervalMinutes':this[_0x565ec2(0xed)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x565ec2(0xc8)]['size'],'nextGlobalCheckIn':_0x5c14a8,'paymentTimersDetails':_0x411eb1};}['getPaymentTimerInfo'](_0x43cca4){const _0x3dc0d9=a38_0x5a67a2,_0x3f5285=this[_0x3dc0d9(0xc8)][_0x3dc0d9(0xb4)](_0x43cca4);if(_0x3f5285)return{'hasTimers':!![],'timersCount':_0x3f5285[_0x3dc0d9(0x154)][_0x3dc0d9(0x11a)],'createdAt':_0x3f5285[_0x3dc0d9(0x152)],'gatewayPaymentId':_0x3f5285[_0x3dc0d9(0xb6)]};return{'hasTimers':![]};}async[a38_0x5a67a2(0x19b)](_0x1f45ef,_0x58addc){const _0x52e214=a38_0x5a67a2;try{const _0x4e3222=await database_1[_0x52e214(0x95)][_0x52e214(0xa6)][_0x52e214(0x157)]({'where':{'id':_0x1f45ef},'select':{'gatewaySettings':!![]}});if(!_0x4e3222?.[_0x52e214(0xe2)])return console['log']('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x1f45ef+_0x52e214(0xac)),0xa;const _0x4c39bc=JSON['parse'](_0x4e3222[_0x52e214(0xe2)]);for(const [_0x19c044,_0xbf003e]of Object[_0x52e214(0x104)](_0x4c39bc)){if(_0x19c044['toLowerCase']()===_0x58addc[_0x52e214(0x153)]()){const _0x1ac101=_0xbf003e['commission']||0xa;return console[_0x52e214(0x16b)](_0x52e214(0xe4)+_0x58addc+'\x20commission\x20for\x20shop\x20'+_0x1f45ef+':\x20'+_0x1ac101+'%'),_0x1ac101;}}return console[_0x52e214(0x16b)](_0x52e214(0x167)+_0x58addc+_0x52e214(0x17b)+_0x1f45ef+',\x20using\x20default\x2010%'),0xa;}catch(_0x16de1d){return console[_0x52e214(0xf0)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x1f45ef+_0x52e214(0xb0)+_0x58addc+':',_0x16de1d),0xa;}}}exports[a38_0x5a67a2(0x151)]=CoinToPayStatusService,exports[a38_0x5a67a2(0x155)]=new CoinToPayStatusService();