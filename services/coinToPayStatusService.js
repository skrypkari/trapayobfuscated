'use strict';const a35_0x37b627=a35_0x3d52;(function(_0x3696bb,_0x4b0709){const _0x4c3ffe=a35_0x3d52,_0x19e3ef=_0x3696bb();while(!![]){try{const _0x557a0b=-parseInt(_0x4c3ffe(0x161))/0x1+parseInt(_0x4c3ffe(0x18f))/0x2+parseInt(_0x4c3ffe(0x18b))/0x3+-parseInt(_0x4c3ffe(0x19e))/0x4*(-parseInt(_0x4c3ffe(0x163))/0x5)+parseInt(_0x4c3ffe(0x1aa))/0x6+-parseInt(_0x4c3ffe(0x1d2))/0x7+-parseInt(_0x4c3ffe(0x165))/0x8*(parseInt(_0x4c3ffe(0x1b7))/0x9);if(_0x557a0b===_0x4b0709)break;else _0x19e3ef['push'](_0x19e3ef['shift']());}catch(_0xdc91f4){_0x19e3ef['push'](_0x19e3ef['shift']());}}}(a35_0x5af0,0x8de34));var __importDefault=this&&this[a35_0x37b627(0x1a4)]||function(_0x1af581){const _0x52ee1d=a35_0x37b627;return _0x1af581&&_0x1af581[_0x52ee1d(0x15f)]?_0x1af581:{'default':_0x1af581};};Object[a35_0x37b627(0x1d3)](exports,a35_0x37b627(0x15f),{'value':!![]}),exports[a35_0x37b627(0x1d4)]=exports['CoinToPayStatusService']=void 0x0;function a35_0x3d52(_0x2f8ec1,_0x3ee1de){const _0x5af0d8=a35_0x5af0();return a35_0x3d52=function(_0x3d5204,_0x59ab9a){_0x3d5204=_0x3d5204-0x15a;let _0x323dbd=_0x5af0d8[_0x3d5204];return _0x323dbd;},a35_0x3d52(_0x2f8ec1,_0x3ee1de);}function a35_0x5af0(){const _0x479353=['\x20status:\x20','15gbduBF','\x20days,\x20marking\x20as\x20EXPIRED','12823144RykLek','-day\x20timeout','\x20expired\x20CoinToPay\x20payments','findUnique','\x20has\x20no\x20gatewayPaymentId,\x20skipping','Shop\x20webhook\x20sent\x20to\x20','\x20details:','error','checkPaymentStatus','stringify','POST','expired','logShopWebhookError','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','🔍\x20Checking\x20CoinToPay\x20payment\x20','⏰\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','bankDetails','findMany','Failed\x20to\x20check\x20payment\x20','getTime','floor','\x20status\x20unchanged\x20(','EXPIRED','⏰\x20Payment\x20','telegramBotService','🛑\x20CoinToPay\x20status\x20checking\x20stopped','/status/','\x20with\x20status\x20','EXPIRY_DAYS','\x20pending\x20CoinToPay\x20payments','cointopay','./loggerService','⏰\x20Found\x20','status','PENDING','logShopWebhookSent','Automatically\x20expired\x20after\x20','createdAt','1163493TAODjI','settings','✅\x20Transaction\x20confirmed\x20on:\x20','🏦\x20Saved\x20IBAN:\x20','1524422GpXZPG','not\x20confirmed','🪙\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','update','./telegramBotService','includes','length','push','toISOString','currency','transactionId','now','catch','Initial\x20CoinToPay\x20status\x20check\x20failed:','startPeriodicStatusCheck','1357916OHbZZX','shop','stopPeriodicStatusCheck','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','sendPaymentStatusNotification','0100','__importDefault','createdOn','payment.failed','failed','📊\x20Payment\x20','checkPaymentById','6520680AqLJpE','🔄\x20Updating\x20payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','gatewayPaymentId','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','webhook_send','orderId','\x20not\x20enabled\x20for\x20shop\x20','customerEmail','⚠️\x20Payment\x20','checkAllPendingPayments','message','loggerService','9dVyewJ','checkSinglePayment','Failed\x20to\x20send\x20shop\x20webhook:','Unknown\x20error','amount','Periodic\x20CoinToPay\x20status\x20check\x20failed:','coinToPayService','FAILED','checkExpiredPayments','shopId','CHECK_INTERVAL_MS','CoinToPayStatusService','created','create','confirmedOn','\x20days','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','payment.success','payment','gatewayOrderId','../config/database','gateway','PAID','paymentDetails','iban','✅\x20Completed\x20checking\x20','toLowerCase','6062434TWoeyy','defineProperty','coinToPayStatusService','CoinToPayService','webhookLog','TesSoft\x20Payment\x20System/1.0','Payment\x20not\x20found','Webhook\x20event\x20','./gateways/coinToPayService','webhookEvents','application/json','default','cointopay_auto_expired','webhookUrl','🪙\x20Checking\x20','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20updated\x20successfully','log','\x20to\x20','paidAt','text','✅\x20Payment\x20','✅\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','checkInterval','\x20marked\x20as\x20paid\x20at:\x20','__esModule','adminNotes','205132VrgDsh'];a35_0x5af0=function(){return _0x479353;};return a35_0x5af0();}const coinToPayService_1=require(a35_0x37b627(0x1da)),database_1=__importDefault(require(a35_0x37b627(0x1cb))),telegramBotService_1=require(a35_0x37b627(0x193)),loggerService_1=require(a35_0x37b627(0x184));class CoinToPayStatusService{constructor(){const _0x125d14=a35_0x37b627;this[_0x125d14(0x15d)]=null,this[_0x125d14(0x1c1)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x125d14(0x1bd)]=new coinToPayService_1[(_0x125d14(0x1d5))]();}[a35_0x37b627(0x19d)](){const _0x1b11fd=a35_0x37b627;console['log']('🪙\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)'),this[_0x1b11fd(0x1b4)]()[_0x1b11fd(0x19b)](_0x5e1fc1=>{const _0x26b416=_0x1b11fd;console[_0x26b416(0x16c)](_0x26b416(0x19c),_0x5e1fc1);}),this[_0x1b11fd(0x15d)]=setInterval(async()=>{const _0x36cdfd=_0x1b11fd;try{await this[_0x36cdfd(0x1b4)]();}catch(_0x22fe00){console[_0x36cdfd(0x16c)](_0x36cdfd(0x1bc),_0x22fe00);}},this[_0x1b11fd(0x1c1)]),console['log'](_0x1b11fd(0x15c));}[a35_0x37b627(0x1a0)](){const _0x992f6=a35_0x37b627;this['checkInterval']&&(clearInterval(this[_0x992f6(0x15d)]),this['checkInterval']=null,console[_0x992f6(0x1e3)](_0x992f6(0x17e)));}async[a35_0x37b627(0x1b4)](){const _0x51c693=a35_0x37b627;try{const _0x2c907c=await database_1['default']['payment'][_0x51c693(0x176)]({'where':{'gateway':_0x51c693(0x183),'status':_0x51c693(0x187),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x2c907c['length']===0x0){console[_0x51c693(0x1e3)](_0x51c693(0x191));return;}console[_0x51c693(0x1e3)](_0x51c693(0x1e0)+_0x2c907c[_0x51c693(0x195)]+_0x51c693(0x182));const _0x26278a=await this[_0x51c693(0x1bf)](_0x2c907c);console['log'](_0x51c693(0x185)+_0x26278a[_0x51c693(0x195)]+_0x51c693(0x167));for(const _0x1fd127 of _0x2c907c){try{if(_0x26278a[_0x51c693(0x194)](_0x1fd127['id'])){console[_0x51c693(0x1e3)](_0x51c693(0x17c)+_0x1fd127['id']+_0x51c693(0x1c7));continue;}await this[_0x51c693(0x1b8)](_0x1fd127),await new Promise(_0x2a4cfa=>setTimeout(_0x2a4cfa,0x7d0));}catch(_0x55db61){console[_0x51c693(0x16c)](_0x51c693(0x1e1)+_0x1fd127['id']+':',_0x55db61),loggerService_1['loggerService']['logWhiteDomainError'](_0x51c693(0x183),_0x51c693(0x17f)+_0x1fd127[_0x51c693(0x1ad)],_0x55db61);}}console[_0x51c693(0x1e3)](_0x51c693(0x1d0)+_0x2c907c['length']+'\x20CoinToPay\x20payments');}catch(_0x325ea5){console[_0x51c693(0x16c)](_0x51c693(0x1ae),_0x325ea5);}}async[a35_0x37b627(0x1bf)](_0x139f17){const _0x14cbf1=a35_0x37b627,_0x67952e=[],_0x5c008f=new Date();_0x5c008f['setDate'](_0x5c008f['getDate']()-this[_0x14cbf1(0x181)]),console['log'](_0x14cbf1(0x174)+this['EXPIRY_DAYS']+'\x20days\x20(created\x20before\x20'+_0x5c008f['toISOString']()+')');for(const _0x141e06 of _0x139f17){if(_0x141e06[_0x14cbf1(0x18a)]<_0x5c008f){console[_0x14cbf1(0x1e3)](_0x14cbf1(0x17c)+_0x141e06['id']+'\x20is\x20older\x20than\x20'+this[_0x14cbf1(0x181)]+_0x14cbf1(0x164));try{await database_1[_0x14cbf1(0x1dd)][_0x14cbf1(0x1c9)][_0x14cbf1(0x192)]({'where':{'id':_0x141e06['id']},'data':{'status':_0x14cbf1(0x17b),'updatedAt':new Date(),'adminNotes':_0x14cbf1(0x189)+this[_0x14cbf1(0x181)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x14cbf1(0x1dd)]['webhookLog'][_0x14cbf1(0x1c4)]({'data':{'paymentId':_0x141e06['id'],'shopId':_0x141e06[_0x14cbf1(0x1c0)],'event':_0x14cbf1(0x1de),'statusCode':0xc8,'responseBody':JSON[_0x14cbf1(0x16e)]({'reason':'Payment\x20older\x20than\x20'+this[_0x14cbf1(0x181)]+_0x14cbf1(0x1c6),'createdAt':_0x141e06[_0x14cbf1(0x18a)],'expiredAt':new Date()[_0x14cbf1(0x197)](),'daysSinceCreation':Math[_0x14cbf1(0x179)]((Date[_0x14cbf1(0x19a)]()-_0x141e06[_0x14cbf1(0x18a)][_0x14cbf1(0x178)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x141e06,_0x14cbf1(0x17b)),await this[_0x14cbf1(0x1a2)](_0x141e06,_0x14cbf1(0x17b)),_0x67952e[_0x14cbf1(0x196)](_0x141e06['id']),console[_0x14cbf1(0x1e3)](_0x14cbf1(0x15b)+_0x141e06['id']+_0x14cbf1(0x1a1)+this[_0x14cbf1(0x181)]+_0x14cbf1(0x166));}catch(_0x1797a6){console['error']('Failed\x20to\x20expire\x20payment\x20'+_0x141e06['id']+':',_0x1797a6);}}}return _0x67952e;}async[a35_0x37b627(0x1b8)](_0x2e878e){const _0x16bda4=a35_0x37b627;if(!_0x2e878e[_0x16bda4(0x1ad)]){console[_0x16bda4(0x1e3)](_0x16bda4(0x1b3)+_0x2e878e['id']+_0x16bda4(0x169));return;}console[_0x16bda4(0x1e3)](_0x16bda4(0x173)+_0x2e878e['id']+'\x20('+_0x2e878e['gatewayPaymentId']+')');try{const _0x11b9f0=await this['coinToPayService'][_0x16bda4(0x16d)](_0x2e878e[_0x16bda4(0x1ad)]);console['log'](_0x16bda4(0x1a8)+_0x2e878e['id']+_0x16bda4(0x162)+_0x11b9f0[_0x16bda4(0x186)]);_0x11b9f0[_0x16bda4(0x1ce)]&&console[_0x16bda4(0x1e3)](_0x16bda4(0x1a8)+_0x2e878e['id']+_0x16bda4(0x16b),{'iban':_0x11b9f0[_0x16bda4(0x1ce)][_0x16bda4(0x1cf)]||'not\x20found','transactionId':_0x11b9f0['paymentDetails']['transactionId'],'createdOn':_0x11b9f0[_0x16bda4(0x1ce)][_0x16bda4(0x1a5)],'confirmedOn':_0x11b9f0[_0x16bda4(0x1ce)][_0x16bda4(0x1c5)]||_0x16bda4(0x190)});if(_0x11b9f0[_0x16bda4(0x186)]!==_0x2e878e[_0x16bda4(0x186)]){console[_0x16bda4(0x1e3)](_0x16bda4(0x1ab)+_0x2e878e['id']+'\x20status\x20from\x20'+_0x2e878e['status']+_0x16bda4(0x1e4)+_0x11b9f0['status']);const _0x40e105={'status':_0x11b9f0[_0x16bda4(0x186)],'updatedAt':new Date()};_0x11b9f0[_0x16bda4(0x186)]===_0x16bda4(0x1cd)&&_0x2e878e[_0x16bda4(0x186)]!==_0x16bda4(0x1cd)&&(_0x40e105['paidAt']=new Date(),console[_0x16bda4(0x1e3)]('💰\x20Payment\x20'+_0x2e878e['id']+_0x16bda4(0x15e)+_0x40e105[_0x16bda4(0x1e5)][_0x16bda4(0x197)]()));if(_0x11b9f0['paymentDetails']){const _0x3c1f7f=_0x11b9f0['paymentDetails'];_0x3c1f7f[_0x16bda4(0x1cf)]&&(_0x40e105['remitterIban']=_0x3c1f7f[_0x16bda4(0x1cf)],console[_0x16bda4(0x1e3)](_0x16bda4(0x18e)+_0x3c1f7f[_0x16bda4(0x1cf)]));if(_0x3c1f7f[_0x16bda4(0x175)]){const _0x50a858=_0x2e878e['adminNotes']||'',_0x413932='Bank\x20Details:\x20'+_0x3c1f7f['bankDetails'];_0x40e105[_0x16bda4(0x160)]=_0x50a858?_0x50a858+'\x0a\x0a'+_0x413932:_0x413932,console['log']('🏦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x3c1f7f['transactionId']&&console[_0x16bda4(0x1e3)]('🆔\x20Transaction\x20ID:\x20'+_0x3c1f7f[_0x16bda4(0x199)]),_0x3c1f7f[_0x16bda4(0x1c5)]&&console[_0x16bda4(0x1e3)](_0x16bda4(0x18d)+_0x3c1f7f[_0x16bda4(0x1c5)]);}await database_1['default'][_0x16bda4(0x1c9)][_0x16bda4(0x192)]({'where':{'id':_0x2e878e['id']},'data':_0x40e105}),await database_1['default'][_0x16bda4(0x1d6)][_0x16bda4(0x1c4)]({'data':{'paymentId':_0x2e878e['id'],'shopId':_0x2e878e[_0x16bda4(0x1c0)],'event':'cointopay_status_check_'+_0x11b9f0['status'][_0x16bda4(0x1d1)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x2e878e[_0x16bda4(0x186)],'newStatus':_0x11b9f0[_0x16bda4(0x186)],'paymentDetails':_0x11b9f0[_0x16bda4(0x1ce)],'checkedAt':new Date()[_0x16bda4(0x197)]()})}}),await this['sendShopWebhook'](_0x2e878e,_0x11b9f0[_0x16bda4(0x186)]),await this['sendPaymentStatusNotification'](_0x2e878e,_0x11b9f0[_0x16bda4(0x186)]),console[_0x16bda4(0x1e3)]('✅\x20Payment\x20'+_0x2e878e['id']+_0x16bda4(0x1e2));}else console[_0x16bda4(0x1e3)]('📊\x20Payment\x20'+_0x2e878e['id']+_0x16bda4(0x17a)+_0x11b9f0[_0x16bda4(0x186)]+')');}catch(_0x513f28){console[_0x16bda4(0x16c)](_0x16bda4(0x177)+_0x2e878e['id']+':',_0x513f28),await database_1[_0x16bda4(0x1dd)][_0x16bda4(0x1d6)][_0x16bda4(0x1c4)]({'data':{'paymentId':_0x2e878e['id'],'shopId':_0x2e878e['shopId'],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x513f28 instanceof Error?_0x513f28[_0x16bda4(0x1b5)]:_0x16bda4(0x1ba),'gatewayPaymentId':_0x2e878e['gatewayPaymentId'],'checkedAt':new Date()['toISOString']()})}});}}async['sendShopWebhook'](_0x144436,_0x2ef845){const _0x397421=a35_0x37b627,_0x4ce214=Date[_0x397421(0x19a)]();try{const _0xa8be27=_0x144436[_0x397421(0x19f)],_0x24bd4d=_0xa8be27['settings'];if(!_0x24bd4d?.[_0x397421(0x1df)]){console[_0x397421(0x1e3)](_0x397421(0x172)+_0xa8be27['id']);return;}const _0x12bb24=_0x2ef845==='PAID'?_0x397421(0x1c8):_0x2ef845===_0x397421(0x1be)?_0x397421(0x1a6):_0x2ef845==='EXPIRED'?_0x397421(0x1a6):'payment.pending';if(!_0x24bd4d[_0x397421(0x1db)]?.['includes'](_0x12bb24)){console['log'](_0x397421(0x1d9)+_0x12bb24+_0x397421(0x1b1)+_0xa8be27['id']);return;}const _0x38db36={'event':_0x12bb24,'payment':{'id':_0x144436['id'],'order_id':_0x144436[_0x397421(0x1b0)],'gateway_order_id':_0x144436[_0x397421(0x1ca)],'gateway':_0x397421(0x1a3),'amount':_0x144436[_0x397421(0x1bb)],'currency':_0x144436[_0x397421(0x198)],'status':_0x2ef845['toLowerCase'](),'customer_email':_0x144436[_0x397421(0x1b2)],'customer_name':_0x144436['customerName'],'created_at':_0x144436[_0x397421(0x18a)],'updated_at':new Date()}},_0x57f05c=await fetch(_0x24bd4d[_0x397421(0x1df)],{'method':_0x397421(0x16f),'headers':{'Content-Type':_0x397421(0x1dc),'User-Agent':_0x397421(0x1d7)},'body':JSON[_0x397421(0x16e)](_0x38db36)}),_0x5135f7=Date[_0x397421(0x19a)]()-_0x4ce214,_0x26b481=_0x57f05c['ok']?'Success':await _0x57f05c[_0x397421(0x15a)]();loggerService_1[_0x397421(0x1b6)][_0x397421(0x188)](_0x144436[_0x397421(0x1c0)],_0x24bd4d['webhookUrl'],_0x12bb24,_0x57f05c[_0x397421(0x186)],_0x5135f7,_0x38db36),console['log'](_0x397421(0x16a)+_0x24bd4d[_0x397421(0x1df)]+_0x397421(0x180)+_0x57f05c[_0x397421(0x186)]+'\x20('+_0x5135f7+'ms)');}catch(_0x225bd0){console[_0x397421(0x16c)](_0x397421(0x1b9),_0x225bd0),loggerService_1[_0x397421(0x1b6)][_0x397421(0x171)](_0x144436[_0x397421(0x1c0)],_0x144436[_0x397421(0x19f)]?.[_0x397421(0x18c)]?.[_0x397421(0x1df)]||'unknown',_0x397421(0x1af),_0x225bd0,{});}}async[a35_0x37b627(0x1a2)](_0x10800a,_0x92a650){const _0xaaef06=a35_0x37b627;try{const _0x5d6e5c={'PENDING':'created','PAID':'paid','FAILED':_0xaaef06(0x1a7),'EXPIRED':_0xaaef06(0x170)},_0x30080e=_0x5d6e5c[_0x92a650];if(!_0x30080e||_0x30080e===_0xaaef06(0x1c3))return;await telegramBotService_1[_0xaaef06(0x17d)]['sendPaymentNotification'](_0x10800a[_0xaaef06(0x1c0)],_0x10800a,_0x30080e);}catch(_0x51fbea){console[_0xaaef06(0x16c)](_0xaaef06(0x1ac),_0x51fbea);}}async[a35_0x37b627(0x1a9)](_0x15d63d){const _0x32766a=a35_0x37b627,_0x26012e=await database_1[_0x32766a(0x1dd)][_0x32766a(0x1c9)][_0x32766a(0x168)]({'where':{'id':_0x15d63d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x26012e)throw new Error(_0x32766a(0x1d8));if(_0x26012e[_0x32766a(0x1cc)]!==_0x32766a(0x183))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');await this['checkSinglePayment'](_0x26012e);}['getServiceStats'](){const _0x5370b4=a35_0x37b627,_0x2184c0=this['checkInterval']?this[_0x5370b4(0x1c1)]:undefined;return{'isActive':!!this[_0x5370b4(0x15d)],'checkIntervalMinutes':this[_0x5370b4(0x1c1)]/(0x3e8*0x3c),'expiryDays':this[_0x5370b4(0x181)],'nextCheckIn':_0x2184c0};}}exports[a35_0x37b627(0x1c2)]=CoinToPayStatusService,exports[a35_0x37b627(0x1d4)]=new CoinToPayStatusService();