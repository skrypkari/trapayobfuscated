'use strict';const a37_0x9b9941=a37_0x12d1;(function(_0x31a398,_0x1acdba){const _0x4c0f9b=a37_0x12d1,_0x36f383=_0x31a398();while(!![]){try{const _0xd42166=-parseInt(_0x4c0f9b(0xa0))/0x1*(parseInt(_0x4c0f9b(0xe5))/0x2)+parseInt(_0x4c0f9b(0xa6))/0x3+parseInt(_0x4c0f9b(0xc7))/0x4+parseInt(_0x4c0f9b(0xd7))/0x5+-parseInt(_0x4c0f9b(0x164))/0x6+-parseInt(_0x4c0f9b(0xa1))/0x7+-parseInt(_0x4c0f9b(0xa2))/0x8*(-parseInt(_0x4c0f9b(0x16c))/0x9);if(_0xd42166===_0x1acdba)break;else _0x36f383['push'](_0x36f383['shift']());}catch(_0x1e7028){_0x36f383['push'](_0x36f383['shift']());}}}(a37_0x1982,0x5d88c));var __importDefault=this&&this[a37_0x9b9941(0xb0)]||function(_0x2e5fc5){const _0x5c2ca1=a37_0x9b9941;return _0x2e5fc5&&_0x2e5fc5[_0x5c2ca1(0x16e)]?_0x2e5fc5:{'default':_0x2e5fc5};};Object['defineProperty'](exports,a37_0x9b9941(0x16e),{'value':!![]}),exports[a37_0x9b9941(0xbe)]=exports[a37_0x9b9941(0x11a)]=void 0x0;const coinToPayService_1=require(a37_0x9b9941(0xc3)),database_1=__importDefault(require(a37_0x9b9941(0x132))),telegramBotService_1=require(a37_0x9b9941(0x12e)),loggerService_1=require(a37_0x9b9941(0x182));function a37_0x1982(){const _0x42e177=['floor','\x20\x20\x20-\x20Gateway:\x20','status_check','auto_expire','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','gateway','üõë\x20[SHUTDOWN]\x20Cleared\x20','iban','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','stack','shopId','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','transactionId','\x20not\x20found,\x20clearing\x20timers','customerEmail','\x20seconds\x20(','delete','\x20\x20\x20üìç\x20Source:\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20to\x20','update','text','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20status\x20changed\x20to\x20','\x20(after\x20','findUnique','schedulePaymentChecks','checkSinglePayment','sendPaymentStatusNotification','COINTOPAY_STATUS_CHANGE','1\x20minute','stopPeriodicStatusCheck','2\x20minutes','loggerService','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','paymentId','globalCheckInterval','50340lhXaYA','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','createdAt','\x20\x20\x20-\x20Amount:\x20','shop','logCoinToPayError','üìä\x20[HOURLY]\x20Payment\x20','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','9DieOFP','\x20found:','__esModule','size','\x20has\x20no\x20gatewayPaymentId,\x20skipping','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','error','\x20triggered\x20for\x20payment\x20','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','checkAllPendingPayments','\x20timers\x20for\x20payment\x20','0100','\x20status\x20unchanged\x20(','setDate','toLowerCase','EXPIRED','confirmedOn','üìä\x20[CHECK]\x20Payment\x20','getPaymentTimerInfo','failed','description','5\x20minutes','./loggerService','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','payment.pending','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','expired','payment.failed','4rIXRFf','2070642GsKsrh','508472GMaWqU','sendShopWebhook','\x20not\x20found\x20in\x20database','‚è∞\x20[HOURLY]\x20Payment\x20','772482lKieVQ','set','\x20is\x20too\x20new\x20(','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','CoinToPayService','\x20is\x20valid\x20for\x20checking,\x20proceeding...','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','paymentDetails','webhookUrl','payment.success','__importDefault','toISOString','Success','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20days\x20without\x20payment\x20confirmation','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','\x20marked\x20as\x20paid\x20at:\x20','‚ùå\x20[HOURLY]\x20Payment\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20\x20\x20üìÖ\x20Time:\x20','has','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20status\x20is\x20','coinToPayStatusService','\x20pending\x20CoinToPay\x20payments','\x20details:','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','create','./gateways/coinToPayService','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','‚úÖ\x20[CHECK]\x20Payment\x20','not\x20confirmed','1822032faNOSy','/status/','amount','\x20(age:\x20','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','‚ùå\x20[CHECK]\x20Payment\x20','\x20not\x20enabled\x20for\x20shop\x20','values','Webhook\x20event\x20','h),\x20skipping\x20global\x20check','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','stringify','from','push','Payment\x20older\x20than\x20','\x20with\x20status\x20','2178555XHPOhZ','getTime','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','.\x20Remaining\x20active\x20timers:\x20','checkSinglePaymentById','logShopWebhookSent','ms)','\x20\x20\x20-\x20paymentId:\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20to\x20clear','ü™ô\x20[DEBUG]\x20Creating\x20','PAID','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20expired','262480ePPOwT','Unknown\x20error','üí∞\x20[CHECK]\x20Payment\x20','\x20individual\x20payment\x20timers','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','getServiceStats','timers','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','cointopay_status_check_','default',',\x20clearing\x20individual\x20timers','TesSoft\x20Payment\x20System/1.0','gatewayOrderId','Payment\x20not\x20found','message','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','customerName','\x20\x20\x20üìù\x20Details:','unknown',',\x20stopping\x20individual\x20checks','cointopay_status_check_error','\x20days\x20(created\x20before\x20','paymentTimers','coinToPayService','‚úÖ\x20[HOURLY]\x20Payment\x20','\x20has\x20no\x20gatewayPaymentId','‚è∞\x20[GLOBAL]\x20Payment\x20','\x20status:\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20current\x20status:\x20','\x20completed\x20for\x20payment\x20','\x20for\x20payment\x20','\x20->\x20','forEach','\x20is\x20older\x20than\x20','webhook_send','currency','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','application/json','ü™ô\x20CoinToPayStatusService\x20initialized','payment','clearPaymentTimers','\x20days','‚è∞\x20[GLOBAL]\x20Found\x20','length','cointopay','gatewayPaymentId','bankDetails','webhookEvents','timestamp','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','logCoinToPayStatus','get','CoinToPayStatusService','EXPIRY_DAYS','PENDING','logShopWebhookError','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','createdOn','toFixed','created','now','telegramBotService','\x20skipped,\x20','status','includes','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','logWhiteDomainError','Automatically\x20expired\x20after\x20','webhookLog','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','FAILED','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','./telegramBotService','log','adminNotes','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','../config/database','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','schedule_created','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','catch','GLOBAL_CHECK_INTERVAL_MS','settings','\x20expired\x20CoinToPay\x20payments','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','Failed\x20to\x20send\x20shop\x20webhook:'];a37_0x1982=function(){return _0x42e177;};return a37_0x1982();}function a37_0x12d1(_0x3a175c,_0xe537e8){const _0x19826a=a37_0x1982();return a37_0x12d1=function(_0x12d110,_0x1eccb5){_0x12d110=_0x12d110-0x9e;let _0xd4a1c6=_0x19826a[_0x12d110];return _0xd4a1c6;},a37_0x12d1(_0x3a175c,_0xe537e8);}class CoinToPayStatusService{constructor(){const _0x1b0dae=a37_0x9b9941;this['globalCheckInterval']=null,this[_0x1b0dae(0x138)]=0x3c*0x3c*0x3e8,this[_0x1b0dae(0x11b)]=0x5,this[_0x1b0dae(0xfb)]=new Map(),this[_0x1b0dae(0xfc)]=new coinToPayService_1[(_0x1b0dae(0xaa))](),console[_0x1b0dae(0x12f)](_0x1b0dae(0x10c));}[a37_0x9b9941(0x159)](_0x2bd145,_0x4f8e57){const _0x34dc3a=a37_0x9b9941;console[_0x34dc3a(0x12f)](_0x34dc3a(0xf4)),console[_0x34dc3a(0x12f)](_0x34dc3a(0xde)+_0x2bd145),console[_0x34dc3a(0x12f)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x4f8e57),this[_0x34dc3a(0x10e)](_0x2bd145);const _0x51628d=[],_0x434cc2=new Date(),_0x31c776=[{'delay':0x1*0x3c*0x3e8,'description':_0x34dc3a(0x15d)},{'delay':0x2*0x3c*0x3e8,'description':_0x34dc3a(0x15f)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x34dc3a(0x181)}];console[_0x34dc3a(0x12f)](_0x34dc3a(0xe1)+_0x31c776[_0x34dc3a(0x111)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x2bd145);let _0x3e370f=0x0;_0x31c776[_0x34dc3a(0x106)]((_0x329a33,_0x157826)=>{const _0x57d068=_0x34dc3a;_0x3e370f+=_0x329a33['delay'];const _0x21a538=setTimeout(async()=>{const _0x5988b8=a37_0x12d1;console[_0x5988b8(0x12f)](_0x5988b8(0x146)+(_0x157826+0x1)+_0x5988b8(0x173)+_0x2bd145+_0x5988b8(0x157)+_0x329a33[_0x5988b8(0x180)]+')');try{await this[_0x5988b8(0xdb)](_0x2bd145),console[_0x5988b8(0x12f)]('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x157826+0x1)+_0x5988b8(0x103)+_0x2bd145);}catch(_0x4c27ca){console[_0x5988b8(0x172)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x157826+0x1)+_0x5988b8(0x104)+_0x2bd145+':',_0x4c27ca),this['logCoinToPayError'](_0x2bd145,_0x4f8e57,_0x4c27ca,_0x5988b8(0x13f),{'checkNumber':_0x157826+0x1,'scheduledAfter':_0x329a33[_0x5988b8(0x180)],'isIndividualCheck':!![]});}},_0x3e370f);_0x51628d[_0x57d068(0xd4)](_0x21a538),console[_0x57d068(0x12f)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x157826+0x1)+_0x57d068(0x104)+_0x2bd145+'\x20in\x20'+_0x3e370f/0x3e8+_0x57d068(0x14d)+_0x329a33[_0x57d068(0x180)]+')');});const _0x2f9a54=setInterval(async()=>{const _0x1e8c3e=_0x34dc3a;console[_0x1e8c3e(0x12f)](_0x1e8c3e(0x12b)+_0x2bd145);try{const _0x12281c=await database_1['default'][_0x1e8c3e(0x10d)][_0x1e8c3e(0x158)]({'where':{'id':_0x2bd145},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x12281c){console['log'](_0x1e8c3e(0xb8)+_0x2bd145+_0x1e8c3e(0x14b)),this[_0x1e8c3e(0x10e)](_0x2bd145);return;}console['log'](_0x1e8c3e(0x16a)+_0x2bd145+_0x1e8c3e(0x102)+_0x12281c[_0x1e8c3e(0x125)]);if(_0x12281c[_0x1e8c3e(0x125)]!==_0x1e8c3e(0x11c)){console[_0x1e8c3e(0x12f)](_0x1e8c3e(0xfd)+_0x2bd145+'\x20status\x20is\x20'+_0x12281c[_0x1e8c3e(0x125)]+_0x1e8c3e(0xf8)),this[_0x1e8c3e(0x10e)](_0x2bd145);return;}const _0x12eb95=Math[_0x1e8c3e(0x13d)]((Date['now']()-_0x12281c[_0x1e8c3e(0x166)][_0x1e8c3e(0xd8)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x12eb95>=this[_0x1e8c3e(0x11b)]){console[_0x1e8c3e(0x12f)](_0x1e8c3e(0xa5)+_0x2bd145+_0x1e8c3e(0x107)+this['EXPIRY_DAYS']+_0x1e8c3e(0x13b)),this[_0x1e8c3e(0x10e)](_0x2bd145);return;}await this[_0x1e8c3e(0xdb)](_0x2bd145),console['log'](_0x1e8c3e(0x11e)+_0x2bd145);}catch(_0x3193e){console['error'](_0x1e8c3e(0xc4)+_0x2bd145+':',_0x3193e),this['logCoinToPayError'](_0x2bd145,_0x4f8e57,_0x3193e,_0x1e8c3e(0x13f),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x51628d['push'](_0x2f9a54),this['paymentTimers'][_0x34dc3a(0xa7)](_0x2bd145,{'timers':_0x51628d,'paymentId':_0x2bd145,'gatewayPaymentId':_0x4f8e57,'createdAt':_0x434cc2}),console[_0x34dc3a(0x12f)](_0x34dc3a(0xbc)+_0x31c776[_0x34dc3a(0x111)]+_0x34dc3a(0x185)+_0x2bd145),console['log'](_0x34dc3a(0x151)+this[_0x34dc3a(0xfb)]['size']),this[_0x34dc3a(0x118)](_0x2bd145,_0x4f8e57,_0x34dc3a(0x11c),_0x34dc3a(0x11c),'status_check',{'action':_0x34dc3a(0x135),'scheduledChecks':_0x31c776[_0x34dc3a(0x111)],'firstCheckIn':_0x31c776[0x0]['delay']/0x3e8,'totalTimers':this[_0x34dc3a(0xfb)]['size']});}[a37_0x9b9941(0x10e)](_0x5fd2bb){const _0x61c1ac=a37_0x9b9941,_0x1a3fea=this[_0x61c1ac(0xfb)][_0x61c1ac(0x119)](_0x5fd2bb);_0x1a3fea?(console[_0x61c1ac(0x12f)]('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x1a3fea[_0x61c1ac(0xeb)][_0x61c1ac(0x111)]+_0x61c1ac(0x176)+_0x5fd2bb),_0x1a3fea[_0x61c1ac(0xeb)][_0x61c1ac(0x106)]((_0x54e040,_0x4d1456)=>{const _0x58e954=_0x61c1ac;_0x54e040&&(clearTimeout(_0x54e040),clearInterval(_0x54e040),console['log']('üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x4d1456+0x1)+_0x58e954(0x104)+_0x5fd2bb));}),this['paymentTimers'][_0x61c1ac(0x14e)](_0x5fd2bb),console[_0x61c1ac(0x12f)]('‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x5fd2bb+_0x61c1ac(0xda)+this['paymentTimers']['size'])):console[_0x61c1ac(0x12f)](_0x61c1ac(0xe9)+_0x5fd2bb+_0x61c1ac(0xe0));}async[a37_0x9b9941(0xdb)](_0x2d8fc1){const _0x19918d=a37_0x9b9941;console[_0x19918d(0x12f)](_0x19918d(0x171)+_0x2d8fc1);const _0x251f9a=await database_1['default'][_0x19918d(0x10d)][_0x19918d(0x158)]({'where':{'id':_0x2d8fc1},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x251f9a){console[_0x19918d(0x12f)](_0x19918d(0xcc)+_0x2d8fc1+_0x19918d(0xa4));return;}console[_0x19918d(0x12f)](_0x19918d(0x17d)+_0x2d8fc1+_0x19918d(0x16d)),console[_0x19918d(0x12f)](_0x19918d(0x13e)+_0x251f9a[_0x19918d(0x143)]),console['log']('\x20\x20\x20-\x20Status:\x20'+_0x251f9a[_0x19918d(0x125)]),console[_0x19918d(0x12f)](_0x19918d(0x134)+_0x251f9a['gatewayPaymentId']),console[_0x19918d(0x12f)](_0x19918d(0x167)+_0x251f9a[_0x19918d(0xc9)]+'\x20'+_0x251f9a['currency']),console[_0x19918d(0x12f)]('\x20\x20\x20-\x20ShopId:\x20'+_0x251f9a[_0x19918d(0x148)]);if(_0x251f9a['gateway']!==_0x19918d(0x112)){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x2d8fc1+_0x19918d(0xa9)+_0x251f9a[_0x19918d(0x143)]+')');return;}if(_0x251f9a[_0x19918d(0x125)]!==_0x19918d(0x11c)){console[_0x19918d(0x12f)](_0x19918d(0x16b)+_0x2d8fc1+_0x19918d(0xbd)+_0x251f9a[_0x19918d(0x125)]+_0x19918d(0xf8)),this['clearPaymentTimers'](_0x2d8fc1);return;}if(!_0x251f9a[_0x19918d(0x113)]){console[_0x19918d(0x12f)](_0x19918d(0x16b)+_0x2d8fc1+_0x19918d(0xfe));return;}console[_0x19918d(0x12f)](_0x19918d(0xc5)+_0x2d8fc1+_0x19918d(0xab)),await this[_0x19918d(0x15a)](_0x251f9a);}['logCoinToPayStatus'](_0x474dff,_0x39f00c,_0x3fc9ee,_0x3f506e,_0x4c0c64,_0x464411){const _0x18cc9a=a37_0x9b9941,_0x18a7d8={'type':_0x18cc9a(0x15c),'paymentId':_0x474dff,'gatewayPaymentId':_0x39f00c,'oldStatus':_0x3fc9ee,'newStatus':_0x3f506e,'source':_0x4c0c64,'timestamp':new Date()[_0x18cc9a(0xb1)](),'details':_0x464411||{}};loggerService_1['loggerService']['logCoinToPayStatus'](_0x18a7d8),console[_0x18cc9a(0x12f)](_0x18cc9a(0x150)+_0x474dff+'\x20('+_0x39f00c+')'),console[_0x18cc9a(0x12f)]('\x20\x20\x20üìä\x20Status:\x20'+_0x3fc9ee+_0x18cc9a(0x105)+_0x3f506e),console['log'](_0x18cc9a(0x14f)+_0x4c0c64),console[_0x18cc9a(0x12f)](_0x18cc9a(0xba)+_0x18a7d8[_0x18cc9a(0x116)]),_0x464411&&console[_0x18cc9a(0x12f)](_0x18cc9a(0xf6),_0x464411);}[a37_0x9b9941(0x169)](_0x2f9629,_0x268749,_0x349400,_0x1772d6,_0x3eda3e){const _0x4c5a47=a37_0x9b9941,_0x38f2fb={'type':'COINTOPAY_ERROR','paymentId':_0x2f9629,'gatewayPaymentId':_0x268749,'error':_0x349400 instanceof Error?{'message':_0x349400[_0x4c5a47(0xf3)],'stack':_0x349400[_0x4c5a47(0x147)]}:_0x349400,'source':_0x1772d6,'timestamp':new Date()[_0x4c5a47(0xb1)](),'context':_0x3eda3e||{}};loggerService_1['loggerService']['logCoinToPayError'](_0x38f2fb),console['error'](_0x4c5a47(0x127)+_0x2f9629+'\x20('+_0x268749+')'),console[_0x4c5a47(0x172)]('\x20\x20\x20‚ùå\x20Error:\x20'+(_0x349400 instanceof Error?_0x349400[_0x4c5a47(0xf3)]:_0x349400)),console[_0x4c5a47(0x172)](_0x4c5a47(0x14f)+_0x1772d6),console[_0x4c5a47(0x172)](_0x4c5a47(0xba)+_0x38f2fb[_0x4c5a47(0x116)]),_0x3eda3e&&console[_0x4c5a47(0x172)]('\x20\x20\x20üìù\x20Context:',_0x3eda3e);}['startPeriodicStatusCheck'](){const _0xdbb907=a37_0x9b9941;console['log'](_0xdbb907(0x142)),this[_0xdbb907(0x175)]()[_0xdbb907(0x137)](_0x1cb6cd=>{const _0x49967e=_0xdbb907;console['error'](_0x49967e(0x117),_0x1cb6cd);}),this[_0xdbb907(0x163)]=setInterval(async()=>{const _0x7f00d0=_0xdbb907;try{console[_0x7f00d0(0x12f)]('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x7f00d0(0x175)](),console[_0x7f00d0(0x12f)](_0x7f00d0(0xc1));}catch(_0x4edc57){console[_0x7f00d0(0x172)](_0x7f00d0(0xcb),_0x4edc57);}},this[_0xdbb907(0x138)]),console[_0xdbb907(0x12f)](_0xdbb907(0xdf));}[a37_0x9b9941(0x15e)](){const _0x57060c=a37_0x9b9941;console[_0x57060c(0x12f)](_0x57060c(0x136));this[_0x57060c(0x163)]&&(clearInterval(this[_0x57060c(0x163)]),this[_0x57060c(0x163)]=null,console[_0x57060c(0x12f)]('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x2ef23f=this[_0x57060c(0xfb)]['size'];for(const [_0x17c195]of this['paymentTimers']){this[_0x57060c(0x10e)](_0x17c195);}console[_0x57060c(0x12f)](_0x57060c(0x144)+_0x2ef23f+_0x57060c(0xe8));}async[a37_0x9b9941(0x175)](){const _0x111a4a=a37_0x9b9941;try{console[_0x111a4a(0x12f)](_0x111a4a(0x155));const _0x5c9623=await database_1[_0x111a4a(0xee)][_0x111a4a(0x10d)]['findMany']({'where':{'gateway':'cointopay','status':_0x111a4a(0x11c),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log']('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x5c9623[_0x111a4a(0x111)]+_0x111a4a(0xbf));if(_0x5c9623['length']===0x0){console[_0x111a4a(0x12f)]('ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x4f48b4=await this['checkExpiredPayments'](_0x5c9623);console[_0x111a4a(0x12f)](_0x111a4a(0x110)+_0x4f48b4['length']+_0x111a4a(0x13a));let _0x13a4b3=0x0,_0x67c9cf=0x0;for(const _0x19b47d of _0x5c9623){try{if(_0x4f48b4[_0x111a4a(0x126)](_0x19b47d['id'])){console[_0x111a4a(0x12f)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x19b47d['id']+_0x111a4a(0x10a)),_0x67c9cf++;continue;}if(this[_0x111a4a(0xfb)][_0x111a4a(0xbb)](_0x19b47d['id'])){console[_0x111a4a(0x12f)](_0x111a4a(0xff)+_0x19b47d['id']+_0x111a4a(0x12d)),_0x67c9cf++;continue;}const _0x5090da=(Date[_0x111a4a(0x122)]()-_0x19b47d[_0x111a4a(0x166)][_0x111a4a(0xd8)]())/(0x3e8*0x3c*0x3c);if(_0x5090da<0x1){console['log'](_0x111a4a(0xff)+_0x19b47d['id']+_0x111a4a(0xa8)+_0x5090da[_0x111a4a(0x120)](0x1)+_0x111a4a(0xd0)),_0x67c9cf++;continue;}console['log']('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x19b47d['id']+_0x111a4a(0xca)+_0x5090da[_0x111a4a(0x120)](0x1)+'h)'),await this[_0x111a4a(0x15a)](_0x19b47d),_0x13a4b3++,await new Promise(_0x20bbca=>setTimeout(_0x20bbca,0x7d0));}catch(_0x3c3c17){console[_0x111a4a(0x172)](_0x111a4a(0xb3)+_0x19b47d['id']+':',_0x3c3c17),this['logCoinToPayError'](_0x19b47d['id'],_0x19b47d[_0x111a4a(0x113)]||'unknown',_0x3c3c17,_0x111a4a(0x13f),{'isGlobalCheck':!![],'paymentAmount':_0x19b47d[_0x111a4a(0xc9)],'paymentCurrency':_0x19b47d[_0x111a4a(0x109)],'shopId':_0x19b47d[_0x111a4a(0x148)],'createdAt':_0x19b47d['createdAt']}),loggerService_1['loggerService'][_0x111a4a(0x128)]('cointopay',_0x111a4a(0xc8)+_0x19b47d[_0x111a4a(0x113)],_0x3c3c17);}}console[_0x111a4a(0x12f)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x13a4b3+'\x20checked,\x20'+_0x67c9cf+_0x111a4a(0x124)+_0x4f48b4[_0x111a4a(0x111)]+_0x111a4a(0xe4));}catch(_0x5cbe6e){console[_0x111a4a(0x172)](_0x111a4a(0x161),_0x5cbe6e);}}async['checkExpiredPayments'](_0x3d48a6){const _0x250413=a37_0x9b9941,_0x32beef=[],_0x57a67d=new Date();_0x57a67d[_0x250413(0x179)](_0x57a67d['getDate']()-this[_0x250413(0x11b)]),console[_0x250413(0x12f)](_0x250413(0x174)+this[_0x250413(0x11b)]+_0x250413(0xfa)+_0x57a67d[_0x250413(0xb1)]()+')');for(const _0xc833c3 of _0x3d48a6){if(_0xc833c3['createdAt']<_0x57a67d){console[_0x250413(0x12f)](_0x250413(0xb6)+_0xc833c3['id']+_0x250413(0x107)+this[_0x250413(0x11b)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x250413(0x118)](_0xc833c3['id'],_0xc833c3['gatewayPaymentId']||'unknown',_0x250413(0x11c),_0x250413(0x17b),_0x250413(0x140),{'reason':_0x250413(0xd5)+this[_0x250413(0x11b)]+_0x250413(0x10f),'createdAt':_0xc833c3[_0x250413(0x166)],'daysSinceCreation':Math[_0x250413(0x13d)]((Date[_0x250413(0x122)]()-_0xc833c3[_0x250413(0x166)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0xc833c3[_0x250413(0xc9)],'paymentCurrency':_0xc833c3[_0x250413(0x109)],'shopId':_0xc833c3[_0x250413(0x148)]}),await database_1['default'][_0x250413(0x10d)][_0x250413(0x153)]({'where':{'id':_0xc833c3['id']},'data':{'status':_0x250413(0x17b),'updatedAt':new Date(),'adminNotes':_0x250413(0x129)+this[_0x250413(0x11b)]+_0x250413(0xb4)}}),await database_1[_0x250413(0xee)]['webhookLog'][_0x250413(0xc2)]({'data':{'paymentId':_0xc833c3['id'],'shopId':_0xc833c3[_0x250413(0x148)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x250413(0xd5)+this[_0x250413(0x11b)]+_0x250413(0x10f),'createdAt':_0xc833c3[_0x250413(0x166)],'expiredAt':new Date()[_0x250413(0xb1)](),'daysSinceCreation':Math[_0x250413(0x13d)]((Date[_0x250413(0x122)]()-_0xc833c3['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x250413(0xa3)](_0xc833c3,_0x250413(0x17b)),await this['sendPaymentStatusNotification'](_0xc833c3,'EXPIRED'),this[_0x250413(0x10e)](_0xc833c3['id']),_0x32beef[_0x250413(0xd4)](_0xc833c3['id']),console['log']('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0xc833c3['id']+_0x250413(0x183)+this['EXPIRY_DAYS']+'-day\x20timeout');}catch(_0x33992f){console['error'](_0x250413(0x131)+_0xc833c3['id']+':',_0x33992f),this[_0x250413(0x169)](_0xc833c3['id'],_0xc833c3[_0x250413(0x113)]||_0x250413(0xf7),_0x33992f,'auto_expire',{'reason':_0x250413(0x101),'createdAt':_0xc833c3[_0x250413(0x166)],'daysSinceCreation':Math['floor']((Date[_0x250413(0x122)]()-_0xc833c3['createdAt'][_0x250413(0xd8)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x32beef;}async['checkSinglePayment'](_0x4c0903){const _0x52a2f7=a37_0x9b9941;if(!_0x4c0903[_0x52a2f7(0x113)]){console[_0x52a2f7(0x12f)](_0x52a2f7(0x16b)+_0x4c0903['id']+_0x52a2f7(0x170));return;}console[_0x52a2f7(0x12f)](_0x52a2f7(0x165)+_0x4c0903['id']+'\x20('+_0x4c0903[_0x52a2f7(0x113)]+')');try{const _0xf40ae7=await this[_0x52a2f7(0xfc)]['checkPaymentStatus'](_0x4c0903[_0x52a2f7(0x113)]);console[_0x52a2f7(0x12f)](_0x52a2f7(0x17d)+_0x4c0903['id']+_0x52a2f7(0x100)+_0xf40ae7['status']);_0xf40ae7[_0x52a2f7(0xad)]&&console[_0x52a2f7(0x12f)](_0x52a2f7(0x17d)+_0x4c0903['id']+_0x52a2f7(0xc0),{'iban':_0xf40ae7[_0x52a2f7(0xad)][_0x52a2f7(0x145)]||'not\x20found','transactionId':_0xf40ae7['paymentDetails'][_0x52a2f7(0x14a)],'createdOn':_0xf40ae7[_0x52a2f7(0xad)][_0x52a2f7(0x11f)],'confirmedOn':_0xf40ae7[_0x52a2f7(0xad)]['confirmedOn']||_0x52a2f7(0xc6)});if(_0xf40ae7[_0x52a2f7(0x125)]!==_0x4c0903[_0x52a2f7(0x125)]){console['log'](_0x52a2f7(0xec)+_0x4c0903['id']+'\x20status\x20from\x20'+_0x4c0903['status']+_0x52a2f7(0x152)+_0xf40ae7[_0x52a2f7(0x125)]),this[_0x52a2f7(0x118)](_0x4c0903['id'],_0x4c0903[_0x52a2f7(0x113)],_0x4c0903['status'],_0xf40ae7[_0x52a2f7(0x125)],_0x52a2f7(0x13f),{'paymentDetails':_0xf40ae7[_0x52a2f7(0xad)],'amount':_0xf40ae7[_0x52a2f7(0xc9)],'currency':_0xf40ae7[_0x52a2f7(0x109)],'shopId':_0x4c0903['shopId'],'checkTimestamp':new Date()['toISOString']()});const _0x39f451={'status':_0xf40ae7[_0x52a2f7(0x125)],'updatedAt':new Date()};_0xf40ae7[_0x52a2f7(0x125)]===_0x52a2f7(0xe2)&&_0x4c0903[_0x52a2f7(0x125)]!=='PAID'&&(_0x39f451['paidAt']=new Date(),console[_0x52a2f7(0x12f)](_0x52a2f7(0xe7)+_0x4c0903['id']+_0x52a2f7(0xb7)+_0x39f451['paidAt'][_0x52a2f7(0xb1)]()));if(_0xf40ae7['paymentDetails']){const _0x51df17=_0xf40ae7[_0x52a2f7(0xad)];_0x51df17[_0x52a2f7(0x145)]&&(_0x39f451['remitterIban']=_0x51df17['iban'],console[_0x52a2f7(0x12f)](_0x52a2f7(0x149)+_0x51df17[_0x52a2f7(0x145)]));if(_0x51df17[_0x52a2f7(0x114)]){const _0x5eec8d=_0x4c0903['adminNotes']||'',_0x782d15='Bank\x20Details:\x20'+_0x51df17[_0x52a2f7(0x114)];_0x39f451[_0x52a2f7(0x130)]=_0x5eec8d?_0x5eec8d+'\x0a\x0a'+_0x782d15:_0x782d15,console[_0x52a2f7(0x12f)]('üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x51df17[_0x52a2f7(0x14a)]&&console[_0x52a2f7(0x12f)](_0x52a2f7(0x141)+_0x51df17[_0x52a2f7(0x14a)]),_0x51df17[_0x52a2f7(0x17c)]&&console[_0x52a2f7(0x12f)](_0x52a2f7(0xd1)+_0x51df17['confirmedOn']);}await database_1['default'][_0x52a2f7(0x10d)][_0x52a2f7(0x153)]({'where':{'id':_0x4c0903['id']},'data':_0x39f451}),await database_1[_0x52a2f7(0xee)][_0x52a2f7(0x12a)][_0x52a2f7(0xc2)]({'data':{'paymentId':_0x4c0903['id'],'shopId':_0x4c0903[_0x52a2f7(0x148)],'event':_0x52a2f7(0xed)+_0xf40ae7[_0x52a2f7(0x125)][_0x52a2f7(0x17a)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x4c0903[_0x52a2f7(0x125)],'newStatus':_0xf40ae7[_0x52a2f7(0x125)],'paymentDetails':_0xf40ae7[_0x52a2f7(0xad)],'checkedAt':new Date()[_0x52a2f7(0xb1)]()})}}),await this[_0x52a2f7(0xa3)](_0x4c0903,_0xf40ae7['status']),await this['sendPaymentStatusNotification'](_0x4c0903,_0xf40ae7[_0x52a2f7(0x125)]),_0xf40ae7[_0x52a2f7(0x125)]!==_0x52a2f7(0x11c)&&(console[_0x52a2f7(0x12f)]('üßπ\x20[CHECK]\x20Payment\x20'+_0x4c0903['id']+_0x52a2f7(0x156)+_0xf40ae7['status']+_0x52a2f7(0xef)),this[_0x52a2f7(0x10e)](_0x4c0903['id'])),console[_0x52a2f7(0x12f)](_0x52a2f7(0xc5)+_0x4c0903['id']+'\x20updated\x20successfully');}else console[_0x52a2f7(0x12f)](_0x52a2f7(0x17d)+_0x4c0903['id']+_0x52a2f7(0x178)+_0xf40ae7[_0x52a2f7(0x125)]+')'),this[_0x52a2f7(0x118)](_0x4c0903['id'],_0x4c0903[_0x52a2f7(0x113)],_0x4c0903['status'],_0xf40ae7[_0x52a2f7(0x125)],_0x52a2f7(0x13f),{'statusUnchanged':!![],'paymentDetails':_0xf40ae7[_0x52a2f7(0xad)],'amount':_0xf40ae7[_0x52a2f7(0xc9)],'currency':_0xf40ae7[_0x52a2f7(0x109)],'shopId':_0x4c0903[_0x52a2f7(0x148)],'checkTimestamp':new Date()[_0x52a2f7(0xb1)]()});}catch(_0x3bdb40){console[_0x52a2f7(0x172)](_0x52a2f7(0xb5)+_0x4c0903['id']+':',_0x3bdb40),this[_0x52a2f7(0x169)](_0x4c0903['id'],_0x4c0903[_0x52a2f7(0x113)],_0x3bdb40,'status_check',{'paymentAmount':_0x4c0903[_0x52a2f7(0xc9)],'paymentCurrency':_0x4c0903[_0x52a2f7(0x109)],'shopId':_0x4c0903['shopId'],'createdAt':_0x4c0903[_0x52a2f7(0x166)]}),await database_1[_0x52a2f7(0xee)][_0x52a2f7(0x12a)][_0x52a2f7(0xc2)]({'data':{'paymentId':_0x4c0903['id'],'shopId':_0x4c0903['shopId'],'event':_0x52a2f7(0xf9),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x3bdb40 instanceof Error?_0x3bdb40[_0x52a2f7(0xf3)]:_0x52a2f7(0xe6),'gatewayPaymentId':_0x4c0903[_0x52a2f7(0x113)],'checkedAt':new Date()[_0x52a2f7(0xb1)]()})}});}}async['sendShopWebhook'](_0x1b32b2,_0x43c3be){const _0x4da376=a37_0x9b9941,_0x2ed295=Date[_0x4da376(0x122)]();try{const _0x388fd9=_0x1b32b2[_0x4da376(0x168)],_0x622da=_0x388fd9[_0x4da376(0x139)];if(!_0x622da?.['webhookUrl']){console['log'](_0x4da376(0x133)+_0x388fd9['id']);return;}const _0x28547e=_0x43c3be==='PAID'?_0x4da376(0xaf):_0x43c3be===_0x4da376(0x12c)?'payment.failed':_0x43c3be==='EXPIRED'?_0x4da376(0x9f):_0x4da376(0x184);if(!_0x622da[_0x4da376(0x115)]?.[_0x4da376(0x126)](_0x28547e)){console['log'](_0x4da376(0xcf)+_0x28547e+_0x4da376(0xcd)+_0x388fd9['id']);return;}const _0x14c4ad={'event':_0x28547e,'payment':{'id':_0x1b32b2['id'],'order_id':_0x1b32b2['orderId'],'gateway_order_id':_0x1b32b2[_0x4da376(0xf1)],'gateway':_0x4da376(0x177),'amount':_0x1b32b2['amount'],'currency':_0x1b32b2['currency'],'status':_0x43c3be[_0x4da376(0x17a)](),'customer_email':_0x1b32b2[_0x4da376(0x14c)],'customer_name':_0x1b32b2[_0x4da376(0xf5)],'created_at':_0x1b32b2[_0x4da376(0x166)],'updated_at':new Date()}},_0x317e83=await fetch(_0x622da[_0x4da376(0xae)],{'method':'POST','headers':{'Content-Type':_0x4da376(0x10b),'User-Agent':_0x4da376(0xf0)},'body':JSON[_0x4da376(0xd2)](_0x14c4ad)}),_0x865f54=Date['now']()-_0x2ed295,_0x56f38b=_0x317e83['ok']?_0x4da376(0xb2):await _0x317e83[_0x4da376(0x154)]();loggerService_1[_0x4da376(0x160)][_0x4da376(0xdc)](_0x1b32b2[_0x4da376(0x148)],_0x622da[_0x4da376(0xae)],_0x28547e,_0x317e83[_0x4da376(0x125)],_0x865f54,_0x14c4ad),console[_0x4da376(0x12f)]('Shop\x20webhook\x20sent\x20to\x20'+_0x622da[_0x4da376(0xae)]+_0x4da376(0xd6)+_0x317e83['status']+'\x20('+_0x865f54+_0x4da376(0xdd));}catch(_0x5041a6){console[_0x4da376(0x172)](_0x4da376(0x13c),_0x5041a6),loggerService_1[_0x4da376(0x160)][_0x4da376(0x11d)](_0x1b32b2['shopId'],_0x1b32b2['shop']?.[_0x4da376(0x139)]?.[_0x4da376(0xae)]||_0x4da376(0xf7),_0x4da376(0x108),_0x5041a6,{});}}async[a37_0x9b9941(0x15b)](_0x52b9a9,_0x2e6887){const _0x118f21=a37_0x9b9941;try{const _0x520214={'PENDING':_0x118f21(0x121),'PAID':'paid','FAILED':_0x118f21(0x17f),'EXPIRED':_0x118f21(0x9e)},_0x36a93e=_0x520214[_0x2e6887];if(!_0x36a93e||_0x36a93e===_0x118f21(0x121))return;await telegramBotService_1[_0x118f21(0x123)]['sendPaymentNotification'](_0x52b9a9['shopId'],_0x52b9a9,_0x36a93e);}catch(_0x41f5a7){console[_0x118f21(0x172)](_0x118f21(0xe3),_0x41f5a7);}}async['checkPaymentById'](_0x37c860){const _0x5eddb5=a37_0x9b9941;console[_0x5eddb5(0x12f)](_0x5eddb5(0xd9)+_0x37c860);const _0x632c5a=await database_1['default']['payment'][_0x5eddb5(0x158)]({'where':{'id':_0x37c860},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x632c5a)throw new Error(_0x5eddb5(0xf2));if(_0x632c5a[_0x5eddb5(0x143)]!==_0x5eddb5(0x112))throw new Error(_0x5eddb5(0xb9));console['log'](_0x5eddb5(0xac)+_0x37c860),await this[_0x5eddb5(0x15a)](_0x632c5a),console[_0x5eddb5(0x12f)]('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x37c860);}[a37_0x9b9941(0xea)](){const _0x5c8a5b=a37_0x9b9941,_0x275980=this['globalCheckInterval']?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x549682=Array[_0x5c8a5b(0xd3)](this['paymentTimers'][_0x5c8a5b(0xce)]())['map'](_0x3fa08e=>({'paymentId':_0x3fa08e[_0x5c8a5b(0x162)],'gatewayPaymentId':_0x3fa08e[_0x5c8a5b(0x113)],'createdAt':_0x3fa08e[_0x5c8a5b(0x166)],'timersCount':_0x3fa08e[_0x5c8a5b(0xeb)][_0x5c8a5b(0x111)]}));return{'isActive':!!this[_0x5c8a5b(0x163)],'globalCheckIntervalMinutes':this[_0x5c8a5b(0x138)]/(0x3e8*0x3c),'expiryDays':this[_0x5c8a5b(0x11b)],'activeIndividualTimers':this[_0x5c8a5b(0xfb)][_0x5c8a5b(0x16f)],'nextGlobalCheckIn':_0x275980,'paymentTimersDetails':_0x549682};}[a37_0x9b9941(0x17e)](_0x295c2c){const _0xb9bdc6=a37_0x9b9941,_0x10cd2c=this[_0xb9bdc6(0xfb)]['get'](_0x295c2c);if(_0x10cd2c)return{'hasTimers':!![],'timersCount':_0x10cd2c[_0xb9bdc6(0xeb)]['length'],'createdAt':_0x10cd2c[_0xb9bdc6(0x166)],'gatewayPaymentId':_0x10cd2c[_0xb9bdc6(0x113)]};return{'hasTimers':![]};}}exports[a37_0x9b9941(0x11a)]=CoinToPayStatusService,exports[a37_0x9b9941(0xbe)]=new CoinToPayStatusService();