'use strict';function a37_0x2b9d(){const _0x2f2625=['cointopay_auto_expired','\x20days,\x20marking\x20as\x20EXPIRED','COINTOPAY_STATUS_CHANGE','\x20\x20\x20-\x20ShopId:\x20','\x20\x20\x20-\x20Amount:\x20','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20(after\x20','message','delete','paidAt','\x20days\x20(created\x20before\x20','\x20days\x20without\x20payment\x20confirmation','⏰\x20[GLOBAL]\x20Found\x20','shopId','loggerService','EXPIRY_DAYS','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','iban','findMany','createdAt','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','__esModule','🪙\x20[TIMER]\x20Individual\x20check\x20#','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','sendPaymentNotification','📊\x20[HOURLY]\x20Payment\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','Failed\x20to\x20send\x20shop\x20webhook:','now','confirmedOn','\x20status\x20unchanged\x20(','logShopWebhookSent','\x20found:','Unknown\x20error','\x20status\x20from\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','PENDING','494470YvZeqT','transactionId','12MPxzmr','\x20initial\x20timers\x20for\x20payment\x20','default','checkExpiredPayments','toFixed','24MrqDdq','toISOString','includes','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','set','✅\x20[CHECK]\x20Payment\x20','checkAllPendingPayments','💰\x20[CHECK]\x20Payment\x20','globalCheckInterval','222887QVOGjn','\x20\x20\x20-\x20Gateway:\x20','payment.success','clearPaymentTimers','\x20individual\x20payment\x20timers','log','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','error','106714tffmis','status','defineProperty','\x20\x20\x20-\x20GatewayPaymentId:\x20','⏰\x20[HOURLY]\x20Payment\x20','⚠️\x20[CHECK]\x20Payment\x20','\x20\x20\x20📊\x20Status:\x20','bankDetails','0100','\x20\x20\x20-\x20paymentId:\x20','paymentId','timers','getDate','create','../config/database','\x20\x20\x20📝\x20Details:','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','stringify','get','📊\x20[CHECK]\x20Payment\x20','\x20not\x20found\x20in\x20database','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','21753TOodzl','33805QZBwTi','\x20\x20\x20📝\x20Context:','-day\x20timeout','\x20checked,\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20days','paid','PAID','\x20pending\x20CoinToPay\x20payments','\x20expired\x20CoinToPay\x20payments','FAILED','forEach','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','setDate','\x20to\x20clear','.\x20Remaining\x20active\x20timers:\x20','GLOBAL_CHECK_INTERVAL_MS','getTime','text',',\x20stopping\x20individual\x20checks','currency','\x20status\x20changed\x20to\x20','CoinToPayStatusService','expired','payment','\x20seconds\x20(','coinToPayService','webhook_send','stack','\x20is\x20older\x20than\x20','🪙\x20CoinToPayStatusService\x20initialized','\x20not\x20found,\x20clearing\x20timers','checkPaymentStatus','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','\x20completed\x20for\x20payment\x20','🪙\x20[GLOBAL]\x20Found\x20','logCoinToPayError','⏰\x20[GLOBAL]\x20Payment\x20','\x20status\x20is\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','payment.pending','catch','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20->\x20','length','\x20\x20\x20📅\x20Time:\x20','\x20expired','\x20for\x20payment\x20','getPaymentTimerInfo','🧹\x20[DEBUG]\x20Clearing\x20','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20not\x20enabled\x20for\x20shop\x20','EXPIRED','amount','\x20has\x20no\x20gatewayPaymentId','./gateways/coinToPayService','Payment\x20older\x20than\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','Bank\x20Details:\x20','stopPeriodicStatusCheck','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','logShopWebhookError','webhookEvents','🛑\x20[SHUTDOWN]\x20Cleared\x20','description','174gddcel','2vuWaNH','3317226RhuAtV','delay','\x20marked\x20as\x20paid\x20at:\x20','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','paymentDetails','gatewayOrderId','cointopay','\x20skipped,\x20','gateway','remitterIban','Webhook\x20event\x20','16pWFtxS','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20\x20\x20❌\x20Error:\x20','Shop\x20webhook\x20sent\x20to\x20','gatewayPaymentId','sendShopWebhook','✅\x20[HOURLY]\x20Payment\x20','status_check','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','shop','timestamp','webhookLog','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','coinToPayStatusService','paymentTimers','findUnique','\x20\x20\x20📍\x20Source:\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','🪙\x20[DEBUG]\x20Creating\x20','push','webhookUrl','auto_expire','\x20has\x20no\x20gatewayPaymentId,\x20skipping','customerName','checkPaymentById','schedule_created','unknown','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','has','❌\x20[HOURLY]\x20Payment\x20','logWhiteDomainError','cointopay_status_check_error','2\x20minutes','toLowerCase','1\x20minute','5\x20minutes','floor','27WAMjzG','checkSinglePaymentById','ms)','schedulePaymentChecks','size','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','created','sendPaymentStatusNotification','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','h),\x20skipping\x20global\x20check','logCoinToPayStatus','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','customerEmail','checkSinglePayment','12984465dmsopy','payment.failed'];a37_0x2b9d=function(){return _0x2f2625;};return a37_0x2b9d();}const a37_0x499ec4=a37_0x214e;(function(_0x4819a8,_0x46df4f){const _0x54ce93=a37_0x214e,_0x20e4a7=_0x4819a8();while(!![]){try{const _0x28ad53=parseInt(_0x54ce93(0x1ba))/0x1*(-parseInt(_0x54ce93(0x15e))/0x2)+-parseInt(_0x54ce93(0x174))/0x3*(parseInt(_0x54ce93(0x14c))/0x4)+parseInt(_0x54ce93(0x175))/0x5*(-parseInt(_0x54ce93(0x1b9))/0x6)+-parseInt(_0x54ce93(0x155))/0x7*(-parseInt(_0x54ce93(0x1c7))/0x8)+parseInt(_0x54ce93(0x10c))/0x9*(-parseInt(_0x54ce93(0x145))/0xa)+-parseInt(_0x54ce93(0x1bb))/0xb+parseInt(_0x54ce93(0x147))/0xc*(parseInt(_0x54ce93(0x11d))/0xd);if(_0x28ad53===_0x46df4f)break;else _0x20e4a7['push'](_0x20e4a7['shift']());}catch(_0x500525){_0x20e4a7['push'](_0x20e4a7['shift']());}}}(a37_0x2b9d,0x41033));var __importDefault=this&&this['__importDefault']||function(_0x330550){const _0x43d821=a37_0x214e;return _0x330550&&_0x330550[_0x43d821(0x135)]?_0x330550:{'default':_0x330550};};function a37_0x214e(_0x278a0c,_0x39f741){const _0x2b9de3=a37_0x2b9d();return a37_0x214e=function(_0x214e87,_0x21c9af){_0x214e87=_0x214e87-0xfc;let _0x36a4e9=_0x2b9de3[_0x214e87];return _0x36a4e9;},a37_0x214e(_0x278a0c,_0x39f741);}Object[a37_0x499ec4(0x160)](exports,a37_0x499ec4(0x135),{'value':!![]}),exports[a37_0x499ec4(0x1d4)]=exports[a37_0x499ec4(0x18c)]=void 0x0;const coinToPayService_1=require(a37_0x499ec4(0x1ad)),database_1=__importDefault(require(a37_0x499ec4(0x16c))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x46f67d=a37_0x499ec4;this[_0x46f67d(0x154)]=null,this[_0x46f67d(0x186)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x46f67d(0x1d5)]=new Map(),this[_0x46f67d(0x190)]=new coinToPayService_1['CoinToPayService'](),console[_0x46f67d(0x15a)](_0x46f67d(0x194));}[a37_0x499ec4(0x10f)](_0x5199e1,_0x5eead3){const _0x433a1e=a37_0x499ec4;console[_0x433a1e(0x15a)](_0x433a1e(0x1a8)),console[_0x433a1e(0x15a)](_0x433a1e(0x167)+_0x5199e1),console[_0x433a1e(0x15a)](_0x433a1e(0x143)+_0x5eead3),this['clearPaymentTimers'](_0x5199e1);const _0x5f328b=[],_0x2f77b6=new Date(),_0x1aa5c0=[{'delay':0x1*0x3c*0x3e8,'description':_0x433a1e(0x109)},{'delay':0x2*0x3c*0x3e8,'description':_0x433a1e(0x107)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x433a1e(0x10a)}];console['log'](_0x433a1e(0x1d9)+_0x1aa5c0[_0x433a1e(0x1a2)]+_0x433a1e(0x148)+_0x5199e1);let _0x64212d=0x0;_0x1aa5c0[_0x433a1e(0x180)]((_0x388676,_0x207912)=>{const _0x10bf1b=_0x433a1e;_0x64212d+=_0x388676[_0x10bf1b(0x1bc)];const _0x5878ea=setTimeout(async()=>{const _0x5405b4=_0x10bf1b;console[_0x5405b4(0x15a)](_0x5405b4(0x136)+(_0x207912+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x5199e1+_0x5405b4(0x126)+_0x388676[_0x5405b4(0x1b8)]+')');try{await this[_0x5405b4(0x10d)](_0x5199e1),console[_0x5405b4(0x15a)](_0x5405b4(0x182)+(_0x207912+0x1)+_0x5405b4(0x198)+_0x5199e1);}catch(_0x1bc46c){console[_0x5405b4(0x15d)](_0x5405b4(0x115)+(_0x207912+0x1)+'\x20for\x20payment\x20'+_0x5199e1+':',_0x1bc46c),this[_0x5405b4(0x19a)](_0x5199e1,_0x5eead3,_0x1bc46c,_0x5405b4(0x1ce),{'checkNumber':_0x207912+0x1,'scheduledAfter':_0x388676['description'],'isIndividualCheck':!![]});}},_0x64212d);_0x5f328b[_0x10bf1b(0x1da)](_0x5878ea),console['log'](_0x10bf1b(0x124)+(_0x207912+0x1)+_0x10bf1b(0x1a5)+_0x5199e1+'\x20in\x20'+_0x64212d/0x3e8+_0x10bf1b(0x18f)+_0x388676[_0x10bf1b(0x1b8)]+')');});const _0x3277cf=setInterval(async()=>{const _0x497270=_0x433a1e;console[_0x497270(0x15a)](_0x497270(0x1af)+_0x5199e1);try{const _0x41d598=await database_1[_0x497270(0x149)]['payment']['findUnique']({'where':{'id':_0x5199e1},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x41d598){console[_0x497270(0x15a)](_0x497270(0x104)+_0x5199e1+_0x497270(0x195)),this[_0x497270(0x158)](_0x5199e1);return;}console[_0x497270(0x15a)](_0x497270(0x139)+_0x5199e1+'\x20current\x20status:\x20'+_0x41d598[_0x497270(0x15f)]);if(_0x41d598[_0x497270(0x15f)]!==_0x497270(0x144)){console[_0x497270(0x15a)](_0x497270(0x1cd)+_0x5199e1+_0x497270(0x19c)+_0x41d598[_0x497270(0x15f)]+_0x497270(0x189)),this[_0x497270(0x158)](_0x5199e1);return;}const _0x2191b9=Math[_0x497270(0x10b)]((Date[_0x497270(0x13c)]()-_0x41d598[_0x497270(0x133)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x2191b9>=this[_0x497270(0x12f)]){console['log'](_0x497270(0x162)+_0x5199e1+_0x497270(0x193)+this[_0x497270(0x12f)]+_0x497270(0x15b)),this[_0x497270(0x158)](_0x5199e1);return;}await this[_0x497270(0x10d)](_0x5199e1),console[_0x497270(0x15a)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x5199e1);}catch(_0x57c2bf){console[_0x497270(0x15d)]('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x5199e1+':',_0x57c2bf),this['logCoinToPayError'](_0x5199e1,_0x5eead3,_0x57c2bf,_0x497270(0x1ce),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x5f328b[_0x433a1e(0x1da)](_0x3277cf),this[_0x433a1e(0x1d5)][_0x433a1e(0x150)](_0x5199e1,{'timers':_0x5f328b,'paymentId':_0x5199e1,'gatewayPaymentId':_0x5eead3,'createdAt':_0x2f77b6}),console[_0x433a1e(0x15a)](_0x433a1e(0x1c8)+_0x1aa5c0['length']+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x5199e1),console[_0x433a1e(0x15a)](_0x433a1e(0x11a)+this[_0x433a1e(0x1d5)][_0x433a1e(0x110)]),this[_0x433a1e(0x117)](_0x5199e1,_0x5eead3,_0x433a1e(0x144),_0x433a1e(0x144),_0x433a1e(0x1ce),{'action':_0x433a1e(0x100),'scheduledChecks':_0x1aa5c0[_0x433a1e(0x1a2)],'firstCheckIn':_0x1aa5c0[0x0][_0x433a1e(0x1bc)]/0x3e8,'totalTimers':this[_0x433a1e(0x1d5)][_0x433a1e(0x110)]});}[a37_0x499ec4(0x158)](_0x4ac088){const _0x5645a2=a37_0x499ec4,_0x5846f3=this[_0x5645a2(0x1d5)][_0x5645a2(0x170)](_0x4ac088);_0x5846f3?(console[_0x5645a2(0x15a)](_0x5645a2(0x1a7)+_0x5846f3[_0x5645a2(0x169)]['length']+'\x20timers\x20for\x20payment\x20'+_0x4ac088),_0x5846f3['timers']['forEach']((_0x777062,_0x20aee3)=>{const _0x4f73f8=_0x5645a2;_0x777062&&(clearTimeout(_0x777062),clearInterval(_0x777062),console[_0x4f73f8(0x15a)](_0x4f73f8(0x137)+(_0x20aee3+0x1)+_0x4f73f8(0x1a5)+_0x4ac088));}),this[_0x5645a2(0x1d5)][_0x5645a2(0x128)](_0x4ac088),console[_0x5645a2(0x15a)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x4ac088+_0x5645a2(0x185)+this['paymentTimers'][_0x5645a2(0x110)])):console[_0x5645a2(0x15a)]('⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x4ac088+_0x5645a2(0x184));}async[a37_0x499ec4(0x10d)](_0x159ecf){const _0x2ed4b5=a37_0x499ec4;console[_0x2ed4b5(0x15a)](_0x2ed4b5(0x125)+_0x159ecf);const _0x18f1ec=await database_1[_0x2ed4b5(0x149)][_0x2ed4b5(0x18e)][_0x2ed4b5(0x1d6)]({'where':{'id':_0x159ecf},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x18f1ec){console[_0x2ed4b5(0x15a)]('❌\x20[CHECK]\x20Payment\x20'+_0x159ecf+_0x2ed4b5(0x172));return;}console[_0x2ed4b5(0x15a)]('📊\x20[CHECK]\x20Payment\x20'+_0x159ecf+_0x2ed4b5(0x140)),console[_0x2ed4b5(0x15a)](_0x2ed4b5(0x156)+_0x18f1ec[_0x2ed4b5(0x1c4)]),console[_0x2ed4b5(0x15a)]('\x20\x20\x20-\x20Status:\x20'+_0x18f1ec[_0x2ed4b5(0x15f)]),console['log'](_0x2ed4b5(0x161)+_0x18f1ec[_0x2ed4b5(0x1cb)]),console[_0x2ed4b5(0x15a)](_0x2ed4b5(0x123)+_0x18f1ec[_0x2ed4b5(0x1ab)]+'\x20'+_0x18f1ec[_0x2ed4b5(0x18a)]),console[_0x2ed4b5(0x15a)](_0x2ed4b5(0x122)+_0x18f1ec[_0x2ed4b5(0x12d)]);if(_0x18f1ec[_0x2ed4b5(0x1c4)]!=='cointopay'){console[_0x2ed4b5(0x15a)](_0x2ed4b5(0x163)+_0x159ecf+_0x2ed4b5(0x112)+_0x18f1ec['gateway']+')');return;}if(_0x18f1ec[_0x2ed4b5(0x15f)]!=='PENDING'){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x159ecf+_0x2ed4b5(0x19c)+_0x18f1ec[_0x2ed4b5(0x15f)]+_0x2ed4b5(0x189)),this[_0x2ed4b5(0x158)](_0x159ecf);return;}if(!_0x18f1ec['gatewayPaymentId']){console[_0x2ed4b5(0x15a)](_0x2ed4b5(0x163)+_0x159ecf+_0x2ed4b5(0x1ac));return;}console['log']('✅\x20[CHECK]\x20Payment\x20'+_0x159ecf+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x2ed4b5(0x11c)](_0x18f1ec);}[a37_0x499ec4(0x117)](_0x3e2cd1,_0x1f0ffa,_0x3c5101,_0x3ce202,_0x29b1d8,_0x313518){const _0xf2a0fe=a37_0x499ec4,_0x15492f={'type':_0xf2a0fe(0x121),'paymentId':_0x3e2cd1,'gatewayPaymentId':_0x1f0ffa,'oldStatus':_0x3c5101,'newStatus':_0x3ce202,'source':_0x29b1d8,'timestamp':new Date()[_0xf2a0fe(0x14d)](),'details':_0x313518||{}};loggerService_1[_0xf2a0fe(0x12e)][_0xf2a0fe(0x117)](_0x15492f),console['log'](_0xf2a0fe(0x197)+_0x3e2cd1+'\x20('+_0x1f0ffa+')'),console[_0xf2a0fe(0x15a)](_0xf2a0fe(0x164)+_0x3c5101+_0xf2a0fe(0x1a1)+_0x3ce202),console[_0xf2a0fe(0x15a)](_0xf2a0fe(0x1d7)+_0x29b1d8),console[_0xf2a0fe(0x15a)](_0xf2a0fe(0x1a3)+_0x15492f[_0xf2a0fe(0x1d1)]),_0x313518&&console['log'](_0xf2a0fe(0x16d),_0x313518);}[a37_0x499ec4(0x19a)](_0x253603,_0x460408,_0x55773a,_0x3d0576,_0x1ed2f9){const _0x596d47=a37_0x499ec4,_0x4b56b0={'type':'COINTOPAY_ERROR','paymentId':_0x253603,'gatewayPaymentId':_0x460408,'error':_0x55773a instanceof Error?{'message':_0x55773a['message'],'stack':_0x55773a[_0x596d47(0x192)]}:_0x55773a,'source':_0x3d0576,'timestamp':new Date()[_0x596d47(0x14d)](),'context':_0x1ed2f9||{}};loggerService_1[_0x596d47(0x12e)][_0x596d47(0x19a)](_0x4b56b0),console[_0x596d47(0x15d)](_0x596d47(0x179)+_0x253603+'\x20('+_0x460408+')'),console[_0x596d47(0x15d)](_0x596d47(0x1c9)+(_0x55773a instanceof Error?_0x55773a[_0x596d47(0x127)]:_0x55773a)),console[_0x596d47(0x15d)](_0x596d47(0x1d7)+_0x3d0576),console[_0x596d47(0x15d)]('\x20\x20\x20📅\x20Time:\x20'+_0x4b56b0[_0x596d47(0x1d1)]),_0x1ed2f9&&console[_0x596d47(0x15d)](_0x596d47(0x176),_0x1ed2f9);}['startPeriodicStatusCheck'](){const _0x4a13a1=a37_0x499ec4;console[_0x4a13a1(0x15a)](_0x4a13a1(0x15c)),this[_0x4a13a1(0x152)]()[_0x4a13a1(0x19f)](_0x17204d=>{const _0x2416dd=_0x4a13a1;console[_0x2416dd(0x15d)](_0x2416dd(0x13a),_0x17204d);}),this[_0x4a13a1(0x154)]=setInterval(async()=>{const _0x656ad2=_0x4a13a1;try{console[_0x656ad2(0x15a)](_0x656ad2(0x1b3)),await this['checkAllPendingPayments'](),console[_0x656ad2(0x15a)](_0x656ad2(0x102));}catch(_0x2e2fe8){console[_0x656ad2(0x15d)](_0x656ad2(0x1b4),_0x2e2fe8);}},this[_0x4a13a1(0x186)]),console['log']('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x499ec4(0x1b1)](){const _0x4d8f5c=a37_0x499ec4;console[_0x4d8f5c(0x15a)]('🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x4d8f5c(0x154)]&&(clearInterval(this[_0x4d8f5c(0x154)]),this[_0x4d8f5c(0x154)]=null,console[_0x4d8f5c(0x15a)]('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x8f93e=this['paymentTimers'][_0x4d8f5c(0x110)];for(const [_0x3600e7]of this[_0x4d8f5c(0x1d5)]){this[_0x4d8f5c(0x158)](_0x3600e7);}console[_0x4d8f5c(0x15a)](_0x4d8f5c(0x1b7)+_0x8f93e+_0x4d8f5c(0x159));}async[a37_0x499ec4(0x152)](){const _0x437778=a37_0x499ec4;try{console[_0x437778(0x15a)](_0x437778(0x111));const _0x2f1ad6=await database_1[_0x437778(0x149)]['payment'][_0x437778(0x132)]({'where':{'gateway':_0x437778(0x1c2),'status':_0x437778(0x144),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x437778(0x15a)](_0x437778(0x199)+_0x2f1ad6[_0x437778(0x1a2)]+_0x437778(0x17d));if(_0x2f1ad6['length']===0x0){console['log'](_0x437778(0x1cf));return;}const _0x46397e=await this['checkExpiredPayments'](_0x2f1ad6);console[_0x437778(0x15a)](_0x437778(0x12c)+_0x46397e[_0x437778(0x1a2)]+_0x437778(0x17e));let _0x5b97f2=0x0,_0x2367ba=0x0;for(const _0x1d9c4c of _0x2f1ad6){try{if(_0x46397e[_0x437778(0x14e)](_0x1d9c4c['id'])){console[_0x437778(0x15a)](_0x437778(0x19b)+_0x1d9c4c['id']+_0x437778(0x118)),_0x2367ba++;continue;}if(this[_0x437778(0x1d5)][_0x437778(0x103)](_0x1d9c4c['id'])){console[_0x437778(0x15a)](_0x437778(0x19b)+_0x1d9c4c['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x2367ba++;continue;}const _0x1b3e9=(Date[_0x437778(0x13c)]()-_0x1d9c4c[_0x437778(0x133)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x1b3e9<0x1){console['log']('⏰\x20[GLOBAL]\x20Payment\x20'+_0x1d9c4c['id']+'\x20is\x20too\x20new\x20('+_0x1b3e9[_0x437778(0x14b)](0x1)+_0x437778(0x116)),_0x2367ba++;continue;}console[_0x437778(0x15a)](_0x437778(0x1bf)+_0x1d9c4c['id']+'\x20(age:\x20'+_0x1b3e9['toFixed'](0x1)+'h)'),await this[_0x437778(0x11c)](_0x1d9c4c),_0x5b97f2++,await new Promise(_0x439b34=>setTimeout(_0x439b34,0x7d0));}catch(_0x2453a0){console[_0x437778(0x15d)](_0x437778(0x1d8)+_0x1d9c4c['id']+':',_0x2453a0),this['logCoinToPayError'](_0x1d9c4c['id'],_0x1d9c4c[_0x437778(0x1cb)]||_0x437778(0x101),_0x2453a0,_0x437778(0x1ce),{'isGlobalCheck':!![],'paymentAmount':_0x1d9c4c[_0x437778(0x1ab)],'paymentCurrency':_0x1d9c4c['currency'],'shopId':_0x1d9c4c['shopId'],'createdAt':_0x1d9c4c[_0x437778(0x133)]}),loggerService_1['loggerService'][_0x437778(0x105)](_0x437778(0x1c2),'/status/'+_0x1d9c4c[_0x437778(0x1cb)],_0x2453a0);}}console['log'](_0x437778(0x181)+_0x5b97f2+_0x437778(0x178)+_0x2367ba+_0x437778(0x1c3)+_0x46397e[_0x437778(0x1a2)]+_0x437778(0x1a4));}catch(_0x27709d){console[_0x437778(0x15d)]('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x27709d);}}async[a37_0x499ec4(0x14a)](_0x4e9661){const _0x1490d4=a37_0x499ec4,_0x328f80=[],_0x49f732=new Date();_0x49f732[_0x1490d4(0x183)](_0x49f732[_0x1490d4(0x16a)]()-this[_0x1490d4(0x12f)]),console['log'](_0x1490d4(0x1a0)+this[_0x1490d4(0x12f)]+_0x1490d4(0x12a)+_0x49f732['toISOString']()+')');for(const _0x20c147 of _0x4e9661){if(_0x20c147['createdAt']<_0x49f732){console[_0x1490d4(0x15a)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x20c147['id']+_0x1490d4(0x193)+this['EXPIRY_DAYS']+_0x1490d4(0x120));try{this[_0x1490d4(0x117)](_0x20c147['id'],_0x20c147[_0x1490d4(0x1cb)]||_0x1490d4(0x101),'PENDING',_0x1490d4(0x1aa),'auto_expire',{'reason':_0x1490d4(0x1ae)+this[_0x1490d4(0x12f)]+_0x1490d4(0x17a),'createdAt':_0x20c147[_0x1490d4(0x133)],'daysSinceCreation':Math[_0x1490d4(0x10b)]((Date[_0x1490d4(0x13c)]()-_0x20c147[_0x1490d4(0x133)][_0x1490d4(0x187)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x20c147[_0x1490d4(0x1ab)],'paymentCurrency':_0x20c147[_0x1490d4(0x18a)],'shopId':_0x20c147[_0x1490d4(0x12d)]}),await database_1['default'][_0x1490d4(0x18e)]['update']({'where':{'id':_0x20c147['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x1490d4(0x12f)]+_0x1490d4(0x12b)}}),await database_1[_0x1490d4(0x149)][_0x1490d4(0x1d2)]['create']({'data':{'paymentId':_0x20c147['id'],'shopId':_0x20c147[_0x1490d4(0x12d)],'event':_0x1490d4(0x11f),'statusCode':0xc8,'responseBody':JSON[_0x1490d4(0x16f)]({'reason':_0x1490d4(0x1ae)+this[_0x1490d4(0x12f)]+'\x20days','createdAt':_0x20c147[_0x1490d4(0x133)],'expiredAt':new Date()[_0x1490d4(0x14d)](),'daysSinceCreation':Math['floor']((Date[_0x1490d4(0x13c)]()-_0x20c147['createdAt'][_0x1490d4(0x187)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x1490d4(0x1cc)](_0x20c147,_0x1490d4(0x1aa)),await this[_0x1490d4(0x114)](_0x20c147,_0x1490d4(0x1aa)),this['clearPaymentTimers'](_0x20c147['id']),_0x328f80[_0x1490d4(0x1da)](_0x20c147['id']),console[_0x1490d4(0x15a)]('✅\x20[EXPIRY]\x20Payment\x20'+_0x20c147['id']+_0x1490d4(0x19d)+this[_0x1490d4(0x12f)]+_0x1490d4(0x177));}catch(_0x5e33b7){console['error']('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x20c147['id']+':',_0x5e33b7),this[_0x1490d4(0x19a)](_0x20c147['id'],_0x20c147[_0x1490d4(0x1cb)]||_0x1490d4(0x101),_0x5e33b7,_0x1490d4(0xfc),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x20c147[_0x1490d4(0x133)],'daysSinceCreation':Math['floor']((Date['now']()-_0x20c147[_0x1490d4(0x133)][_0x1490d4(0x187)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x328f80;}async[a37_0x499ec4(0x11c)](_0x5e9851){const _0x2b00e5=a37_0x499ec4;if(!_0x5e9851['gatewayPaymentId']){console[_0x2b00e5(0x15a)](_0x2b00e5(0x163)+_0x5e9851['id']+_0x2b00e5(0xfd));return;}console[_0x2b00e5(0x15a)](_0x2b00e5(0x1d3)+_0x5e9851['id']+'\x20('+_0x5e9851[_0x2b00e5(0x1cb)]+')');try{const _0x5a363a=await this[_0x2b00e5(0x190)][_0x2b00e5(0x196)](_0x5e9851[_0x2b00e5(0x1cb)]);console['log'](_0x2b00e5(0x171)+_0x5e9851['id']+'\x20status:\x20'+_0x5a363a[_0x2b00e5(0x15f)]);_0x5a363a[_0x2b00e5(0x1c0)]&&console[_0x2b00e5(0x15a)](_0x2b00e5(0x171)+_0x5e9851['id']+'\x20details:',{'iban':_0x5a363a[_0x2b00e5(0x1c0)][_0x2b00e5(0x131)]||'not\x20found','transactionId':_0x5a363a[_0x2b00e5(0x1c0)][_0x2b00e5(0x146)],'createdOn':_0x5a363a[_0x2b00e5(0x1c0)]['createdOn'],'confirmedOn':_0x5a363a[_0x2b00e5(0x1c0)][_0x2b00e5(0x13d)]||'not\x20confirmed'});if(_0x5a363a[_0x2b00e5(0x15f)]!==_0x5e9851[_0x2b00e5(0x15f)]){console[_0x2b00e5(0x15a)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x5e9851['id']+_0x2b00e5(0x142)+_0x5e9851[_0x2b00e5(0x15f)]+'\x20to\x20'+_0x5a363a[_0x2b00e5(0x15f)]),this['logCoinToPayStatus'](_0x5e9851['id'],_0x5e9851[_0x2b00e5(0x1cb)],_0x5e9851[_0x2b00e5(0x15f)],_0x5a363a[_0x2b00e5(0x15f)],_0x2b00e5(0x1ce),{'paymentDetails':_0x5a363a[_0x2b00e5(0x1c0)],'amount':_0x5a363a[_0x2b00e5(0x1ab)],'currency':_0x5a363a[_0x2b00e5(0x18a)],'shopId':_0x5e9851['shopId'],'checkTimestamp':new Date()[_0x2b00e5(0x14d)]()});const _0x5391fd={'status':_0x5a363a['status'],'updatedAt':new Date()};_0x5a363a['status']===_0x2b00e5(0x17c)&&_0x5e9851['status']!=='PAID'&&(_0x5391fd[_0x2b00e5(0x129)]=new Date(),console[_0x2b00e5(0x15a)](_0x2b00e5(0x153)+_0x5e9851['id']+_0x2b00e5(0x1bd)+_0x5391fd[_0x2b00e5(0x129)][_0x2b00e5(0x14d)]()));if(_0x5a363a[_0x2b00e5(0x1c0)]){const _0x8747c2=_0x5a363a[_0x2b00e5(0x1c0)];_0x8747c2[_0x2b00e5(0x131)]&&(_0x5391fd[_0x2b00e5(0x1c5)]=_0x8747c2[_0x2b00e5(0x131)],console[_0x2b00e5(0x15a)](_0x2b00e5(0x119)+_0x8747c2[_0x2b00e5(0x131)]));if(_0x8747c2[_0x2b00e5(0x165)]){const _0x3d4e5c=_0x5e9851['adminNotes']||'',_0xc9fc81=_0x2b00e5(0x1b0)+_0x8747c2[_0x2b00e5(0x165)];_0x5391fd['adminNotes']=_0x3d4e5c?_0x3d4e5c+'\x0a\x0a'+_0xc9fc81:_0xc9fc81,console['log']('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x8747c2[_0x2b00e5(0x146)]&&console[_0x2b00e5(0x15a)](_0x2b00e5(0x173)+_0x8747c2[_0x2b00e5(0x146)]),_0x8747c2[_0x2b00e5(0x13d)]&&console['log'](_0x2b00e5(0x1be)+_0x8747c2['confirmedOn']);}await database_1[_0x2b00e5(0x149)][_0x2b00e5(0x18e)]['update']({'where':{'id':_0x5e9851['id']},'data':_0x5391fd}),await database_1[_0x2b00e5(0x149)][_0x2b00e5(0x1d2)][_0x2b00e5(0x16b)]({'data':{'paymentId':_0x5e9851['id'],'shopId':_0x5e9851[_0x2b00e5(0x12d)],'event':'cointopay_status_check_'+_0x5a363a['status'][_0x2b00e5(0x108)](),'statusCode':0xc8,'responseBody':JSON[_0x2b00e5(0x16f)]({'oldStatus':_0x5e9851[_0x2b00e5(0x15f)],'newStatus':_0x5a363a[_0x2b00e5(0x15f)],'paymentDetails':_0x5a363a[_0x2b00e5(0x1c0)],'checkedAt':new Date()[_0x2b00e5(0x14d)]()})}}),await this[_0x2b00e5(0x1cc)](_0x5e9851,_0x5a363a[_0x2b00e5(0x15f)]),await this['sendPaymentStatusNotification'](_0x5e9851,_0x5a363a['status']),_0x5a363a[_0x2b00e5(0x15f)]!==_0x2b00e5(0x144)&&(console[_0x2b00e5(0x15a)]('🧹\x20[CHECK]\x20Payment\x20'+_0x5e9851['id']+_0x2b00e5(0x18b)+_0x5a363a[_0x2b00e5(0x15f)]+',\x20clearing\x20individual\x20timers'),this['clearPaymentTimers'](_0x5e9851['id'])),console[_0x2b00e5(0x15a)](_0x2b00e5(0x151)+_0x5e9851['id']+'\x20updated\x20successfully');}else console['log'](_0x2b00e5(0x171)+_0x5e9851['id']+_0x2b00e5(0x13e)+_0x5a363a[_0x2b00e5(0x15f)]+')'),this['logCoinToPayStatus'](_0x5e9851['id'],_0x5e9851['gatewayPaymentId'],_0x5e9851['status'],_0x5a363a[_0x2b00e5(0x15f)],_0x2b00e5(0x1ce),{'statusUnchanged':!![],'paymentDetails':_0x5a363a[_0x2b00e5(0x1c0)],'amount':_0x5a363a[_0x2b00e5(0x1ab)],'currency':_0x5a363a[_0x2b00e5(0x18a)],'shopId':_0x5e9851[_0x2b00e5(0x12d)],'checkTimestamp':new Date()[_0x2b00e5(0x14d)]()});}catch(_0x22b49e){console[_0x2b00e5(0x15d)](_0x2b00e5(0x134)+_0x5e9851['id']+':',_0x22b49e),this[_0x2b00e5(0x19a)](_0x5e9851['id'],_0x5e9851[_0x2b00e5(0x1cb)],_0x22b49e,_0x2b00e5(0x1ce),{'paymentAmount':_0x5e9851['amount'],'paymentCurrency':_0x5e9851[_0x2b00e5(0x18a)],'shopId':_0x5e9851[_0x2b00e5(0x12d)],'createdAt':_0x5e9851[_0x2b00e5(0x133)]}),await database_1['default'][_0x2b00e5(0x1d2)][_0x2b00e5(0x16b)]({'data':{'paymentId':_0x5e9851['id'],'shopId':_0x5e9851[_0x2b00e5(0x12d)],'event':_0x2b00e5(0x106),'statusCode':0x1f4,'responseBody':JSON[_0x2b00e5(0x16f)]({'error':_0x22b49e instanceof Error?_0x22b49e[_0x2b00e5(0x127)]:_0x2b00e5(0x141),'gatewayPaymentId':_0x5e9851[_0x2b00e5(0x1cb)],'checkedAt':new Date()['toISOString']()})}});}}async[a37_0x499ec4(0x1cc)](_0x388d16,_0x117b7e){const _0x57ffc6=a37_0x499ec4,_0x5e8fb1=Date[_0x57ffc6(0x13c)]();try{const _0x177d01=_0x388d16[_0x57ffc6(0x1d0)],_0x8f36c9=_0x177d01['settings'];if(!_0x8f36c9?.['webhookUrl']){console[_0x57ffc6(0x15a)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x177d01['id']);return;}const _0x180a7f=_0x117b7e==='PAID'?_0x57ffc6(0x157):_0x117b7e===_0x57ffc6(0x17f)?_0x57ffc6(0x11e):_0x117b7e===_0x57ffc6(0x1aa)?_0x57ffc6(0x11e):_0x57ffc6(0x19e);if(!_0x8f36c9[_0x57ffc6(0x1b6)]?.[_0x57ffc6(0x14e)](_0x180a7f)){console[_0x57ffc6(0x15a)](_0x57ffc6(0x1c6)+_0x180a7f+_0x57ffc6(0x1a9)+_0x177d01['id']);return;}const _0x3e03fb={'event':_0x180a7f,'payment':{'id':_0x388d16['id'],'order_id':_0x388d16['orderId'],'gateway_order_id':_0x388d16[_0x57ffc6(0x1c1)],'gateway':_0x57ffc6(0x166),'amount':_0x388d16[_0x57ffc6(0x1ab)],'currency':_0x388d16[_0x57ffc6(0x18a)],'status':_0x117b7e[_0x57ffc6(0x108)](),'customer_email':_0x388d16[_0x57ffc6(0x11b)],'customer_name':_0x388d16[_0x57ffc6(0xfe)],'created_at':_0x388d16[_0x57ffc6(0x133)],'updated_at':new Date()}},_0x4e9ca4=await fetch(_0x8f36c9[_0x57ffc6(0x1db)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x57ffc6(0x16f)](_0x3e03fb)}),_0x481aa9=Date['now']()-_0x5e8fb1,_0x1a4eb2=_0x4e9ca4['ok']?'Success':await _0x4e9ca4[_0x57ffc6(0x188)]();loggerService_1[_0x57ffc6(0x12e)][_0x57ffc6(0x13f)](_0x388d16[_0x57ffc6(0x12d)],_0x8f36c9[_0x57ffc6(0x1db)],_0x180a7f,_0x4e9ca4[_0x57ffc6(0x15f)],_0x481aa9,_0x3e03fb),console['log'](_0x57ffc6(0x1ca)+_0x8f36c9[_0x57ffc6(0x1db)]+'\x20with\x20status\x20'+_0x4e9ca4[_0x57ffc6(0x15f)]+'\x20('+_0x481aa9+_0x57ffc6(0x10e));}catch(_0x292c45){console[_0x57ffc6(0x15d)](_0x57ffc6(0x13b),_0x292c45),loggerService_1[_0x57ffc6(0x12e)][_0x57ffc6(0x1b5)](_0x388d16[_0x57ffc6(0x12d)],_0x388d16[_0x57ffc6(0x1d0)]?.['settings']?.['webhookUrl']||_0x57ffc6(0x101),_0x57ffc6(0x191),_0x292c45,{});}}async[a37_0x499ec4(0x114)](_0x1c2906,_0x20ff88){const _0x3e5d12=a37_0x499ec4;try{const _0x4d6aa9={'PENDING':'created','PAID':_0x3e5d12(0x17b),'FAILED':'failed','EXPIRED':_0x3e5d12(0x18d)},_0x4564c3=_0x4d6aa9[_0x20ff88];if(!_0x4564c3||_0x4564c3===_0x3e5d12(0x113))return;await telegramBotService_1['telegramBotService'][_0x3e5d12(0x138)](_0x1c2906[_0x3e5d12(0x12d)],_0x1c2906,_0x4564c3);}catch(_0x5d2911){console[_0x3e5d12(0x15d)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x5d2911);}}async[a37_0x499ec4(0xff)](_0x1c20f9){const _0x47c46e=a37_0x499ec4;console[_0x47c46e(0x15a)](_0x47c46e(0x130)+_0x1c20f9);const _0x18d470=await database_1[_0x47c46e(0x149)]['payment'][_0x47c46e(0x1d6)]({'where':{'id':_0x1c20f9},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x18d470)throw new Error('Payment\x20not\x20found');if(_0x18d470[_0x47c46e(0x1c4)]!==_0x47c46e(0x1c2))throw new Error(_0x47c46e(0x14f));console[_0x47c46e(0x15a)](_0x47c46e(0x16e)+_0x1c20f9),await this[_0x47c46e(0x11c)](_0x18d470),console[_0x47c46e(0x15a)](_0x47c46e(0x1b2)+_0x1c20f9);}['getServiceStats'](){const _0x258289=a37_0x499ec4,_0x588fe8=this[_0x258289(0x154)]?this[_0x258289(0x186)]:undefined,_0x416057=Array['from'](this['paymentTimers']['values']())['map'](_0x15e395=>({'paymentId':_0x15e395[_0x258289(0x168)],'gatewayPaymentId':_0x15e395[_0x258289(0x1cb)],'createdAt':_0x15e395[_0x258289(0x133)],'timersCount':_0x15e395[_0x258289(0x169)][_0x258289(0x1a2)]}));return{'isActive':!!this[_0x258289(0x154)],'globalCheckIntervalMinutes':this[_0x258289(0x186)]/(0x3e8*0x3c),'expiryDays':this[_0x258289(0x12f)],'activeIndividualTimers':this[_0x258289(0x1d5)][_0x258289(0x110)],'nextGlobalCheckIn':_0x588fe8,'paymentTimersDetails':_0x416057};}[a37_0x499ec4(0x1a6)](_0x250da7){const _0x580c45=a37_0x499ec4,_0x2a7b15=this['paymentTimers']['get'](_0x250da7);if(_0x2a7b15)return{'hasTimers':!![],'timersCount':_0x2a7b15[_0x580c45(0x169)]['length'],'createdAt':_0x2a7b15[_0x580c45(0x133)],'gatewayPaymentId':_0x2a7b15[_0x580c45(0x1cb)]};return{'hasTimers':![]};}}exports[a37_0x499ec4(0x18c)]=CoinToPayStatusService,exports[a37_0x499ec4(0x1d4)]=new CoinToPayStatusService();