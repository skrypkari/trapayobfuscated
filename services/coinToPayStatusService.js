'use strict';function a38_0xcb8f(){const _0x5c5ec7=['‚úÖ\x20[EXPIRY]\x20Payment\x20','\x20seconds\x20(','checkSinglePaymentById','paid','\x20days\x20without\x20payment\x20confirmation','\x20days','\x20commission\x20for\x20shop\x20','convertToUSDT',',\x20stopping\x20individual\x20checks','EXPIRED','2981oVtFyu','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','logCoinToPayError','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','toLowerCase','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','\x20status\x20is\x20','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','delay','FAILED','set','\x20timers\x20for\x20payment\x20','üìä\x20[HOURLY]\x20Payment\x20','\x20is\x20older\x20than\x20','Webhook\x20event\x20','gatewayPaymentId','\x20skipped,\x20','webhookLog','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','-day\x20timeout','EXPIRY_DAYS',',\x20currentPayments=','amountAfterGatewayCommissionUSDT','\x20not\x20found\x20in\x20database','values','\x20not\x20found,\x20clearing\x20timers','getDate','coinToPay2Service','coinToPayStatusService','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','\x20current\x20status:\x20','gatewaySettings','timestamp','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','findMany','payment','2725415wTplVz','\x20\x20\x20-\x20Gateway:\x20','createdAt','.\x20Remaining\x20active\x20timers:\x20','catch','471212GJEYNE','‚úÖ\x20[HOURLY]\x20Payment\x20','clearPaymentTimers','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','paidAt','logShopWebhookSent','timers','getGatewayCommission','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','payment.success','\x20has\x20no\x20gatewayPaymentId,\x20skipping','customerName','\x20to\x20clear','currentPayments','message','includes','webhookUrl','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','üßπ\x20[DEBUG]\x20Clearing\x20','\x20for\x20payment\x20','checkAllPendingPayments','GLOBAL_CHECK_INTERVAL_MS','unknown','coinToPayService','CoinToPay2Service','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','5\x20minutes','setDate','CoinToPayStatusService','amount','stopPeriodicStatusCheck','\x20status:\x20','\x20status\x20changed\x20to\x20','defineProperty','\x20is\x20valid\x20for\x20checking,\x20proceeding...','toISOString','paymentDetails','not\x20found','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','sendPaymentStatusNotification','update','length','stringify','bankDetails','üîç\x20[CHECK]\x20Checking\x20','payment.pending','globalCheckInterval','\x20in\x20','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','\x20\x20\x20-\x20gatewayPaymentId:\x20','__importDefault','paymentLink','now','getGatewayIdByName','\x20->\x20','üßπ\x20[CHECK]\x20Payment\x20','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','expired','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','\x20status\x20from\x20','gateway','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','../config/database','\x20(after\x20','\x20expired','\x20\x20\x20-\x20ShopId:\x20','description','6IAQcQN','Bank\x20Details:\x20','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','COMPLETED','checkPaymentStatus','push','cointopay2','Payment\x20not\x20found','‚è∞\x20[GLOBAL]\x20Found\x20','get','remitterIban','ms)','toFixed','failed','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20',',\x20clearing\x20individual\x20timers','createdOn','\x20status\x20unchanged\x20(','‚ùå\x20[CHECK]\x20Payment\x20','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',',\x20status=','\x20\x20\x20‚ùå\x20Error:\x20','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','sendPaymentNotification','\x20individual\x20payment\x20timers','./gateways/coinToPay2Service','‚è∞\x20[GLOBAL]\x20Payment\x20','text','CoinToPayService','32XWREDD','üí∞\x20[CHECK]\x20Payment\x20','loggerService','Unknown\x20error','\x20completed\x20for\x20payment\x20','52MheDyz','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','cointopay_status_check_','\x20has\x20no\x20gatewayPaymentId','auto_expire','log','Payment\x20older\x20than\x20','paymentTimers','type','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','369IVGAYX','paymentLinkId','settings','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','telegramBotService','cointopay','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','size','\x20\x20\x20üìç\x20Source:\x20','\x20not\x20enabled\x20for\x20shop\x20','gatewayOrderId','getPaymentTimerInfo','commission','checkSinglePayment','checkPaymentById','PAID','checkExpiredPayments','\x20payment\x20','adminNotes','error','created','\x20in\x20shop\x20','\x20\x20\x20üìä\x20Status:\x20','\x20pending\x20CoinToPay\x20payments','Shop\x20webhook\x20sent\x20to\x20','\x20\x20\x20Gateway\x20','getTime','Automatically\x20expired\x20after\x20','üìä\x20[CHECK]\x20Payment\x20','\x20to\x20','/status/','\x20\x20\x20Amount:\x20','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','PENDING',',\x20gateway\x20','‚úÖ\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20\x20\x20-\x20paymentId:\x20','schedule_created','\x20\x20\x20üìù\x20Details:','not\x20confirmed','COINTOPAY_STATUS_CHANGE','status','\x20(age:\x20','orderId','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20USDT','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','./gateways/coinToPayService','913764wPCyox','\x20updated\x20successfully','\x20updated:\x20currentPayments=','status_check','\x20is\x20too\x20new\x20(','Success','\x20days,\x20marking\x20as\x20EXPIRED','logCoinToPayStatus','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','COINTOPAY_ERROR','1jYaYka','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','cointopay_auto_expired','üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','üõë\x20[SHUTDOWN]\x20Cleared\x20','floor','710noCCQN','\x20\x20\x20-\x20Amount:\x20','Gateway\x20','shop','default','logShopWebhookError','transactionId','191000ytFEwp','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','\x20expired\x20CoinToPay\x20payments','forEach','currency','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20with\x20status\x20','findUnique','confirmedOn','__esModule','cointopay_status_check_error','./loggerService','from','524061hKYFDk','\x20commission:\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','create','\x20details:','ü™ô\x20[DEBUG]\x20Creating\x20','./telegramBotService','13796EuqTEd','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','shopId','../types/gateway','amountUSDT',',\x20using\x20default\x2010%'];a38_0xcb8f=function(){return _0x5c5ec7;};return a38_0xcb8f();}function a38_0xb5d9(_0x35edcc,_0x4793e8){const _0xcb8ff=a38_0xcb8f();return a38_0xb5d9=function(_0xb5d959,_0x20e4d2){_0xb5d959=_0xb5d959-0xf4;let _0x362575=_0xcb8ff[_0xb5d959];return _0x362575;},a38_0xb5d9(_0x35edcc,_0x4793e8);}const a38_0x2e45b8=a38_0xb5d9;(function(_0x46cea6,_0x55b2ec){const _0x49df5e=a38_0xb5d9,_0x77066b=_0x46cea6();while(!![]){try{const _0x37c03e=parseInt(_0x49df5e(0x10c))/0x1*(parseInt(_0x49df5e(0x169))/0x2)+-parseInt(_0x49df5e(0x1db))/0x3*(parseInt(_0x49df5e(0x130))/0x4)+parseInt(_0x49df5e(0x11b))/0x5*(-parseInt(_0x49df5e(0x1ae))/0x6)+parseInt(_0x49df5e(0x164))/0x7+-parseInt(_0x49df5e(0x1cc))/0x8*(parseInt(_0x49df5e(0x129))/0x9)+-parseInt(_0x49df5e(0x114))/0xa*(parseInt(_0x49df5e(0x140))/0xb)+-parseInt(_0x49df5e(0x102))/0xc*(-parseInt(_0x49df5e(0x1d1))/0xd);if(_0x37c03e===_0x55b2ec)break;else _0x77066b['push'](_0x77066b['shift']());}catch(_0xdec2a){_0x77066b['push'](_0x77066b['shift']());}}}(a38_0xcb8f,0x347ab));var __importDefault=this&&this[a38_0x2e45b8(0x19c)]||function(_0x530cdf){return _0x530cdf&&_0x530cdf['__esModule']?_0x530cdf:{'default':_0x530cdf};};Object[a38_0x2e45b8(0x18b)](exports,a38_0x2e45b8(0x125),{'value':!![]}),exports[a38_0x2e45b8(0x15c)]=exports[a38_0x2e45b8(0x186)]=void 0x0;const coinToPayService_1=require(a38_0x2e45b8(0x101)),coinToPay2Service_1=require(a38_0x2e45b8(0x1c8)),gateway_1=require(a38_0x2e45b8(0x133)),database_1=__importDefault(require(a38_0x2e45b8(0x1a9))),telegramBotService_1=require(a38_0x2e45b8(0x12f)),loggerService_1=require(a38_0x2e45b8(0x127)),currencyService_1=require('./currencyService');class CoinToPayStatusService{constructor(){const _0xa8fcd6=a38_0x2e45b8;this[_0xa8fcd6(0x198)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0xa8fcd6(0x154)]=0x5,this['paymentTimers']=new Map(),this[_0xa8fcd6(0x181)]=new coinToPayService_1[(_0xa8fcd6(0x1cb))](),this[_0xa8fcd6(0x15b)]=new coinToPay2Service_1[(_0xa8fcd6(0x182))](),console['log'](_0xa8fcd6(0x19a));}['schedulePaymentChecks'](_0xee868c,_0x16b577){const _0x53dc49=a38_0x2e45b8;console[_0x53dc49(0x1d6)]('ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x53dc49(0x1d6)](_0x53dc49(0xf6)+_0xee868c),console['log'](_0x53dc49(0x19b)+_0x16b577),this[_0x53dc49(0x16b)](_0xee868c);const _0x49da01=[],_0x53cfe8=new Date(),_0x1ca1f0=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x53dc49(0x184)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console['log'](_0x53dc49(0x12e)+_0x1ca1f0[_0x53dc49(0x193)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0xee868c);let _0x214911=0x0;_0x1ca1f0['forEach']((_0x3ffea0,_0x5dd2c0)=>{const _0x3c1971=_0x53dc49;_0x214911+=_0x3ffea0[_0x3c1971(0x148)];const _0x4cee9e=setTimeout(async()=>{const _0x532789=_0x3c1971;console[_0x532789(0x1d6)](_0x532789(0x1c1)+(_0x5dd2c0+0x1)+'\x20triggered\x20for\x20payment\x20'+_0xee868c+_0x532789(0x1aa)+_0x3ffea0[_0x532789(0x1ad)]+')');try{await this[_0x532789(0x138)](_0xee868c),console[_0x532789(0x1d6)]('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x5dd2c0+0x1)+_0x532789(0x1d0)+_0xee868c);}catch(_0x2a4789){console[_0x532789(0x1ef)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x5dd2c0+0x1)+_0x532789(0x17d)+_0xee868c+':',_0x2a4789),this[_0x532789(0x142)](_0xee868c,_0x16b577,_0x2a4789,'status_check',{'checkNumber':_0x5dd2c0+0x1,'scheduledAfter':_0x3ffea0['description'],'isIndividualCheck':!![]});}},_0x214911);_0x49da01[_0x3c1971(0x1b3)](_0x4cee9e),console[_0x3c1971(0x1d6)](_0x3c1971(0x10a)+(_0x5dd2c0+0x1)+'\x20for\x20payment\x20'+_0xee868c+_0x3c1971(0x199)+_0x214911/0x3e8+_0x3c1971(0x137)+_0x3ffea0['description']+')');});const _0x28edd1=setInterval(async()=>{const _0x47ce0c=_0x53dc49;console[_0x47ce0c(0x1d6)](_0x47ce0c(0x1df)+_0xee868c);try{const _0xe4ab40=await database_1['default'][_0x47ce0c(0x163)]['findUnique']({'where':{'id':_0xee868c},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0xe4ab40){console[_0x47ce0c(0x1d6)]('‚ùå\x20[HOURLY]\x20Payment\x20'+_0xee868c+_0x47ce0c(0x159)),this[_0x47ce0c(0x16b)](_0xee868c);return;}console[_0x47ce0c(0x1d6)](_0x47ce0c(0x14c)+_0xee868c+_0x47ce0c(0x15e)+_0xe4ab40[_0x47ce0c(0xfb)]);if(_0xe4ab40[_0x47ce0c(0xfb)]!==_0x47ce0c(0x1fd)){console[_0x47ce0c(0x1d6)](_0x47ce0c(0x16a)+_0xee868c+_0x47ce0c(0x146)+_0xe4ab40[_0x47ce0c(0xfb)]+_0x47ce0c(0x13e)),this['clearPaymentTimers'](_0xee868c);return;}const _0x41cd93=Math[_0x47ce0c(0x113)]((Date[_0x47ce0c(0x19e)]()-_0xe4ab40[_0x47ce0c(0x166)][_0x47ce0c(0x1f6)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x41cd93>=this[_0x47ce0c(0x154)]){console[_0x47ce0c(0x1d6)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0xee868c+_0x47ce0c(0x14d)+this[_0x47ce0c(0x154)]+_0x47ce0c(0x161)),this[_0x47ce0c(0x16b)](_0xee868c);return;}await this[_0x47ce0c(0x138)](_0xee868c),console['log'](_0x47ce0c(0x121)+_0xee868c);}catch(_0x52830b){console[_0x47ce0c(0x1ef)](_0x47ce0c(0x147)+_0xee868c+':',_0x52830b),this[_0x47ce0c(0x142)](_0xee868c,_0x16b577,_0x52830b,_0x47ce0c(0x105),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x49da01['push'](_0x28edd1),this[_0x53dc49(0x1d8)][_0x53dc49(0x14a)](_0xee868c,{'timers':_0x49da01,'paymentId':_0xee868c,'gatewayPaymentId':_0x16b577,'createdAt':_0x53cfe8}),console[_0x53dc49(0x1d6)]('‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x1ca1f0[_0x53dc49(0x193)]+_0x53dc49(0x11c)+_0xee868c),console[_0x53dc49(0x1d6)]('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this['paymentTimers'][_0x53dc49(0x1e3)]),this[_0x53dc49(0x109)](_0xee868c,_0x16b577,_0x53dc49(0x1fd),_0x53dc49(0x1fd),_0x53dc49(0x105),{'action':_0x53dc49(0xf7),'scheduledChecks':_0x1ca1f0[_0x53dc49(0x193)],'firstCheckIn':_0x1ca1f0[0x0]['delay']/0x3e8,'totalTimers':this[_0x53dc49(0x1d8)]['size']});}[a38_0x2e45b8(0x16b)](_0x4a3b73){const _0x52137c=a38_0x2e45b8,_0x5a222d=this[_0x52137c(0x1d8)][_0x52137c(0x1b7)](_0x4a3b73);_0x5a222d?(console['log'](_0x52137c(0x17c)+_0x5a222d[_0x52137c(0x16f)][_0x52137c(0x193)]+_0x52137c(0x14b)+_0x4a3b73),_0x5a222d[_0x52137c(0x16f)][_0x52137c(0x11f)]((_0x22e6e7,_0x24f2b2)=>{const _0x32413a=_0x52137c;_0x22e6e7&&(clearTimeout(_0x22e6e7),clearInterval(_0x22e6e7),console['log'](_0x32413a(0x1de)+(_0x24f2b2+0x1)+'\x20for\x20payment\x20'+_0x4a3b73));}),this[_0x52137c(0x1d8)]['delete'](_0x4a3b73),console[_0x52137c(0x1d6)](_0x52137c(0xfe)+_0x4a3b73+_0x52137c(0x167)+this['paymentTimers'][_0x52137c(0x1e3)])):console[_0x52137c(0x1d6)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x4a3b73+_0x52137c(0x176));}async[a38_0x2e45b8(0x138)](_0x590c3b){const _0x133955=a38_0x2e45b8;console['log']('üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x590c3b);const _0x335c27=await database_1[_0x133955(0x118)][_0x133955(0x163)][_0x133955(0x123)]({'where':{'id':_0x590c3b},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x335c27){console[_0x133955(0x1d6)](_0x133955(0x1c0)+_0x590c3b+_0x133955(0x157));return;}console[_0x133955(0x1d6)](_0x133955(0x1f8)+_0x590c3b+'\x20found:'),console[_0x133955(0x1d6)](_0x133955(0x165)+_0x335c27['gateway']),console[_0x133955(0x1d6)]('\x20\x20\x20-\x20Status:\x20'+_0x335c27['status']),console[_0x133955(0x1d6)](_0x133955(0xf5)+_0x335c27[_0x133955(0x14f)]),console['log'](_0x133955(0x115)+_0x335c27[_0x133955(0x187)]+'\x20'+_0x335c27[_0x133955(0x120)]),console[_0x133955(0x1d6)](_0x133955(0x1ac)+_0x335c27[_0x133955(0x132)]);if(_0x335c27[_0x133955(0x1a7)]!==_0x133955(0x1e1)&&_0x335c27[_0x133955(0x1a7)]!==_0x133955(0x1b4)){console[_0x133955(0x1d6)](_0x133955(0x100)+_0x590c3b+_0x133955(0x145)+_0x335c27[_0x133955(0x1a7)]+')');return;}if(_0x335c27['status']!==_0x133955(0x1fd)){console[_0x133955(0x1d6)](_0x133955(0x100)+_0x590c3b+_0x133955(0x146)+_0x335c27[_0x133955(0xfb)]+_0x133955(0x13e)),this['clearPaymentTimers'](_0x590c3b);return;}if(!_0x335c27[_0x133955(0x14f)]){console['log'](_0x133955(0x100)+_0x590c3b+_0x133955(0x1d4));return;}console[_0x133955(0x1d6)](_0x133955(0xf4)+_0x590c3b+_0x133955(0x18c)),await this[_0x133955(0x1e9)](_0x335c27);}[a38_0x2e45b8(0x109)](_0x304a04,_0x2beff0,_0x560ebe,_0x1c83f6,_0x493631,_0x36d6b7){const _0x219f52=a38_0x2e45b8,_0x3c122d={'type':_0x219f52(0xfa),'paymentId':_0x304a04,'gatewayPaymentId':_0x2beff0,'oldStatus':_0x560ebe,'newStatus':_0x1c83f6,'source':_0x493631,'timestamp':new Date()[_0x219f52(0x18d)](),'details':_0x36d6b7||{}};loggerService_1['loggerService'][_0x219f52(0x109)](_0x3c122d),console[_0x219f52(0x1d6)](_0x219f52(0x11d)+_0x304a04+'\x20('+_0x2beff0+')'),console[_0x219f52(0x1d6)](_0x219f52(0x1f2)+_0x560ebe+_0x219f52(0x1a0)+_0x1c83f6),console[_0x219f52(0x1d6)](_0x219f52(0x1e4)+_0x493631),console['log']('\x20\x20\x20üìÖ\x20Time:\x20'+_0x3c122d[_0x219f52(0x160)]),_0x36d6b7&&console[_0x219f52(0x1d6)](_0x219f52(0xf8),_0x36d6b7);}[a38_0x2e45b8(0x142)](_0x3d20bb,_0x49839a,_0x2e4d14,_0x26fbab,_0x5c7235){const _0x25a42d=a38_0x2e45b8,_0x7b4593={'type':_0x25a42d(0x10b),'paymentId':_0x3d20bb,'gatewayPaymentId':_0x49839a,'error':_0x2e4d14 instanceof Error?{'message':_0x2e4d14[_0x25a42d(0x178)],'stack':_0x2e4d14['stack']}:_0x2e4d14,'source':_0x26fbab,'timestamp':new Date()[_0x25a42d(0x18d)](),'context':_0x5c7235||{}};loggerService_1[_0x25a42d(0x1ce)]['logCoinToPayError'](_0x7b4593),console[_0x25a42d(0x1ef)](_0x25a42d(0x131)+_0x3d20bb+'\x20('+_0x49839a+')'),console[_0x25a42d(0x1ef)](_0x25a42d(0x1c4)+(_0x2e4d14 instanceof Error?_0x2e4d14[_0x25a42d(0x178)]:_0x2e4d14)),console[_0x25a42d(0x1ef)](_0x25a42d(0x1e4)+_0x26fbab),console[_0x25a42d(0x1ef)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x7b4593[_0x25a42d(0x160)]),_0x5c7235&&console[_0x25a42d(0x1ef)]('\x20\x20\x20üìù\x20Context:',_0x5c7235);}['startPeriodicStatusCheck'](){const _0x5d2f83=a38_0x2e45b8;console['log'](_0x5d2f83(0x143)),this[_0x5d2f83(0x17e)]()[_0x5d2f83(0x168)](_0x5191e2=>{const _0x5882db=_0x5d2f83;console['error'](_0x5882db(0x171),_0x5191e2);}),this[_0x5d2f83(0x198)]=setInterval(async()=>{const _0x25a386=_0x5d2f83;try{console[_0x25a386(0x1d6)](_0x25a386(0x1b0)),await this['checkAllPendingPayments'](),console['log']('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x3324e7){console[_0x25a386(0x1ef)](_0x25a386(0x1a2),_0x3324e7);}},this[_0x5d2f83(0x17f)]),console[_0x5d2f83(0x1d6)](_0x5d2f83(0x10d));}[a38_0x2e45b8(0x188)](){const _0x2370cb=a38_0x2e45b8;console[_0x2370cb(0x1d6)]('üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x2370cb(0x198)]&&(clearInterval(this[_0x2370cb(0x198)]),this['globalCheckInterval']=null,console['log']('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x337897=this[_0x2370cb(0x1d8)][_0x2370cb(0x1e3)];for(const [_0x164210]of this['paymentTimers']){this[_0x2370cb(0x16b)](_0x164210);}console['log'](_0x2370cb(0x112)+_0x337897+_0x2370cb(0x1c7));}async[a38_0x2e45b8(0x17e)](){const _0x4e8290=a38_0x2e45b8;try{console[_0x4e8290(0x1d6)]('ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x2becef=await database_1[_0x4e8290(0x118)][_0x4e8290(0x163)][_0x4e8290(0x162)]({'where':{'gateway':{'in':[_0x4e8290(0x1e1),_0x4e8290(0x1b4)]},'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x4e8290(0x1d6)]('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x2becef[_0x4e8290(0x193)]+_0x4e8290(0x1f3));if(_0x2becef[_0x4e8290(0x193)]===0x0){console[_0x4e8290(0x1d6)]('ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x15f30a=await this[_0x4e8290(0x1ec)](_0x2becef);console[_0x4e8290(0x1d6)](_0x4e8290(0x1b6)+_0x15f30a[_0x4e8290(0x193)]+_0x4e8290(0x11e));let _0x45076f=0x0,_0x3b059f=0x0;for(const _0x4d64f9 of _0x2becef){try{if(_0x15f30a[_0x4e8290(0x179)](_0x4d64f9['id'])){console['log']('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x4d64f9['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x3b059f++;continue;}if(this[_0x4e8290(0x1d8)]['has'](_0x4d64f9['id'])){console[_0x4e8290(0x1d6)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x4d64f9['id']+_0x4e8290(0x1a3)),_0x3b059f++;continue;}const _0x28482d=(Date['now']()-_0x4d64f9[_0x4e8290(0x166)][_0x4e8290(0x1f6)]())/(0x3e8*0x3c*0x3c);if(_0x28482d<0x1){console['log'](_0x4e8290(0x1c9)+_0x4d64f9['id']+_0x4e8290(0x106)+_0x28482d[_0x4e8290(0x1ba)](0x1)+'h),\x20skipping\x20global\x20check'),_0x3b059f++;continue;}console['log']('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x4d64f9['id']+_0x4e8290(0xfc)+_0x28482d['toFixed'](0x1)+'h)'),await this[_0x4e8290(0x1e9)](_0x4d64f9),_0x45076f++,await new Promise(_0x3ab725=>setTimeout(_0x3ab725,0x7d0));}catch(_0x56b6bf){console['error'](_0x4e8290(0x152)+_0x4d64f9['id']+':',_0x56b6bf),this[_0x4e8290(0x142)](_0x4d64f9['id'],_0x4d64f9[_0x4e8290(0x14f)]||_0x4e8290(0x180),_0x56b6bf,_0x4e8290(0x105),{'isGlobalCheck':!![],'paymentAmount':_0x4d64f9[_0x4e8290(0x187)],'paymentCurrency':_0x4d64f9[_0x4e8290(0x120)],'shopId':_0x4d64f9[_0x4e8290(0x132)],'createdAt':_0x4d64f9[_0x4e8290(0x166)]}),loggerService_1[_0x4e8290(0x1ce)]['logWhiteDomainError']('cointopay',_0x4e8290(0x1fa)+_0x4d64f9['gatewayPaymentId'],_0x56b6bf);}}console['log']('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x45076f+'\x20checked,\x20'+_0x3b059f+_0x4e8290(0x150)+_0x15f30a['length']+_0x4e8290(0x1ab));}catch(_0x6c3f29){console[_0x4e8290(0x1ef)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x6c3f29);}}async[a38_0x2e45b8(0x1ec)](_0x50970b){const _0x3ff91b=a38_0x2e45b8,_0x1670d0=[],_0x5b99fc=new Date();_0x5b99fc[_0x3ff91b(0x185)](_0x5b99fc[_0x3ff91b(0x15a)]()-this[_0x3ff91b(0x154)]),console[_0x3ff91b(0x1d6)](_0x3ff91b(0x17b)+this['EXPIRY_DAYS']+'\x20days\x20(created\x20before\x20'+_0x5b99fc[_0x3ff91b(0x18d)]()+')');for(const _0x5c72e4 of _0x50970b){if(_0x5c72e4[_0x3ff91b(0x166)]<_0x5b99fc){console[_0x3ff91b(0x1d6)]('‚è∞\x20[EXPIRY]\x20Payment\x20'+_0x5c72e4['id']+_0x3ff91b(0x14d)+this[_0x3ff91b(0x154)]+_0x3ff91b(0x108));try{this[_0x3ff91b(0x109)](_0x5c72e4['id'],_0x5c72e4[_0x3ff91b(0x14f)]||_0x3ff91b(0x180),_0x3ff91b(0x1fd),_0x3ff91b(0x13f),_0x3ff91b(0x1d5),{'reason':_0x3ff91b(0x1d7)+this[_0x3ff91b(0x154)]+_0x3ff91b(0x13b),'createdAt':_0x5c72e4[_0x3ff91b(0x166)],'daysSinceCreation':Math[_0x3ff91b(0x113)]((Date['now']()-_0x5c72e4['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x5c72e4['amount'],'paymentCurrency':_0x5c72e4[_0x3ff91b(0x120)],'shopId':_0x5c72e4['shopId']}),await database_1[_0x3ff91b(0x118)][_0x3ff91b(0x163)][_0x3ff91b(0x192)]({'where':{'id':_0x5c72e4['id']},'data':{'status':_0x3ff91b(0x13f),'updatedAt':new Date(),'adminNotes':_0x3ff91b(0x1f7)+this[_0x3ff91b(0x154)]+_0x3ff91b(0x13a)}}),await database_1[_0x3ff91b(0x118)]['webhookLog'][_0x3ff91b(0x12c)]({'data':{'paymentId':_0x5c72e4['id'],'shopId':_0x5c72e4[_0x3ff91b(0x132)],'event':_0x3ff91b(0x110),'statusCode':0xc8,'responseBody':JSON[_0x3ff91b(0x194)]({'reason':_0x3ff91b(0x1d7)+this['EXPIRY_DAYS']+_0x3ff91b(0x13b),'createdAt':_0x5c72e4[_0x3ff91b(0x166)],'expiredAt':new Date()[_0x3ff91b(0x18d)](),'daysSinceCreation':Math[_0x3ff91b(0x113)]((Date[_0x3ff91b(0x19e)]()-_0x5c72e4['createdAt'][_0x3ff91b(0x1f6)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x5c72e4,_0x3ff91b(0x13f)),await this[_0x3ff91b(0x191)](_0x5c72e4,_0x3ff91b(0x13f)),this[_0x3ff91b(0x16b)](_0x5c72e4['id']),_0x1670d0[_0x3ff91b(0x1b3)](_0x5c72e4['id']),console['log'](_0x3ff91b(0x136)+_0x5c72e4['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x3ff91b(0x154)]+_0x3ff91b(0x153));}catch(_0x350bdc){console[_0x3ff91b(0x1ef)](_0x3ff91b(0x12b)+_0x5c72e4['id']+':',_0x350bdc),this['logCoinToPayError'](_0x5c72e4['id'],_0x5c72e4[_0x3ff91b(0x14f)]||_0x3ff91b(0x180),_0x350bdc,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x5c72e4['createdAt'],'daysSinceCreation':Math[_0x3ff91b(0x113)]((Date[_0x3ff91b(0x19e)]()-_0x5c72e4[_0x3ff91b(0x166)][_0x3ff91b(0x1f6)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x1670d0;}async[a38_0x2e45b8(0x1e9)](_0x371ef6){const _0x1a7256=a38_0x2e45b8;if(!_0x371ef6[_0x1a7256(0x14f)]){console[_0x1a7256(0x1d6)](_0x1a7256(0x100)+_0x371ef6['id']+_0x1a7256(0x174));return;}console[_0x1a7256(0x1d6)](_0x1a7256(0x196)+_0x371ef6[_0x1a7256(0x1a7)]+_0x1a7256(0x1ed)+_0x371ef6['id']+'\x20('+_0x371ef6[_0x1a7256(0x14f)]+')');try{let _0x113464;_0x371ef6['gateway']===_0x1a7256(0x1b4)?(_0x113464=await this[_0x1a7256(0x15b)][_0x1a7256(0x1b2)](_0x371ef6[_0x1a7256(0x14f)]),console[_0x1a7256(0x1d6)](_0x1a7256(0x1da)+_0x371ef6['id']+_0x1a7256(0x189)+_0x113464[_0x1a7256(0xfb)])):(_0x113464=await this[_0x1a7256(0x181)][_0x1a7256(0x1b2)](_0x371ef6[_0x1a7256(0x14f)]),console[_0x1a7256(0x1d6)]('üìä\x20[CHECK]\x20CoinToPay\x20payment\x20'+_0x371ef6['id']+_0x1a7256(0x189)+_0x113464[_0x1a7256(0xfb)]));_0x113464[_0x1a7256(0x18e)]&&console[_0x1a7256(0x1d6)](_0x1a7256(0x1f8)+_0x371ef6['id']+_0x1a7256(0x12d),{'iban':_0x113464[_0x1a7256(0x18e)]['iban']||_0x1a7256(0x18f),'transactionId':_0x113464[_0x1a7256(0x18e)]['transactionId'],'createdOn':_0x113464['paymentDetails'][_0x1a7256(0x1be)],'confirmedOn':_0x113464[_0x1a7256(0x18e)][_0x1a7256(0x124)]||_0x1a7256(0xf9)});if(_0x113464[_0x1a7256(0xfb)]!==_0x371ef6[_0x1a7256(0xfb)]){console[_0x1a7256(0x1d6)](_0x1a7256(0x1fc)+_0x371ef6['id']+_0x1a7256(0x1a6)+_0x371ef6['status']+_0x1a7256(0x1f9)+_0x113464[_0x1a7256(0xfb)]),this['logCoinToPayStatus'](_0x371ef6['id'],_0x371ef6[_0x1a7256(0x14f)],_0x371ef6[_0x1a7256(0xfb)],_0x113464[_0x1a7256(0xfb)],_0x1a7256(0x105),{'paymentDetails':_0x113464[_0x1a7256(0x18e)],'amount':_0x113464[_0x1a7256(0x187)],'currency':_0x113464['currency'],'shopId':_0x371ef6[_0x1a7256(0x132)],'checkTimestamp':new Date()[_0x1a7256(0x18d)]()});const _0x16ede5={'status':_0x113464['status'],'updatedAt':new Date()};if(_0x113464[_0x1a7256(0xfb)]===_0x1a7256(0x1eb)&&_0x371ef6[_0x1a7256(0xfb)]!==_0x1a7256(0x1eb)){_0x16ede5[_0x1a7256(0x16d)]=new Date();if(!_0x371ef6['amountUSDT']){const _0x3dda6e=await currencyService_1['currencyService'][_0x1a7256(0x13d)](_0x371ef6['amount'],_0x371ef6[_0x1a7256(0x120)]);_0x16ede5[_0x1a7256(0x134)]=_0x3dda6e;const _0x297d2b=await this[_0x1a7256(0x170)](_0x371ef6['shopId'],_0x371ef6[_0x1a7256(0x1a7)]),_0x4f3f1f=_0x3dda6e*(0x1-_0x297d2b/0x64);_0x16ede5[_0x1a7256(0x156)]=_0x4f3f1f,console[_0x1a7256(0x1d6)](_0x1a7256(0x1cd)+_0x371ef6['id']+'\x20amounts\x20calculated:'),console['log'](_0x1a7256(0x1fb)+_0x371ef6[_0x1a7256(0x187)]+'\x20'+_0x371ef6['currency']+_0x1a7256(0x1a0)+_0x3dda6e[_0x1a7256(0x1ba)](0x6)+_0x1a7256(0xff)),console[_0x1a7256(0x1d6)](_0x1a7256(0x1f5)+_0x371ef6[_0x1a7256(0x1a7)]+_0x1a7256(0x12a)+_0x297d2b+'%'),console[_0x1a7256(0x1d6)]('\x20\x20\x20Amount\x20after\x20commission:\x20'+_0x4f3f1f[_0x1a7256(0x1ba)](0x6)+_0x1a7256(0xff));}console['log'](_0x1a7256(0x1cd)+_0x371ef6['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x16ede5['paidAt'][_0x1a7256(0x18d)]());}if(_0x113464[_0x1a7256(0x18e)]){const _0x3a1200=_0x113464['paymentDetails'];_0x3a1200['iban']&&(_0x16ede5[_0x1a7256(0x1b8)]=_0x3a1200['iban'],console['log'](_0x1a7256(0x1bc)+_0x3a1200['iban']));if(_0x3a1200[_0x1a7256(0x195)]){const _0x2c2f5d=_0x371ef6[_0x1a7256(0x1ee)]||'',_0x4fbe76=_0x1a7256(0x1af)+_0x3a1200[_0x1a7256(0x195)];_0x16ede5[_0x1a7256(0x1ee)]=_0x2c2f5d?_0x2c2f5d+'\x0a\x0a'+_0x4fbe76:_0x4fbe76,console[_0x1a7256(0x1d6)](_0x1a7256(0x16c));}_0x3a1200[_0x1a7256(0x11a)]&&console['log'](_0x1a7256(0x10f)+_0x3a1200[_0x1a7256(0x11a)]),_0x3a1200['confirmedOn']&&console['log'](_0x1a7256(0x190)+_0x3a1200['confirmedOn']);}await database_1[_0x1a7256(0x118)][_0x1a7256(0x163)]['update']({'where':{'id':_0x371ef6['id']},'data':_0x16ede5});if(_0x113464['status']===_0x1a7256(0x1eb)&&_0x371ef6['status']!==_0x1a7256(0x1eb)){console['log']('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x371ef6['id']+_0x1a7256(0x172));const _0x5f1db9=await database_1[_0x1a7256(0x118)][_0x1a7256(0x163)][_0x1a7256(0x123)]({'where':{'id':_0x371ef6['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x5f1db9?.[_0x1a7256(0x1dc)]&&_0x5f1db9[_0x1a7256(0x19d)])try{const _0x3890a7=_0x5f1db9[_0x1a7256(0x19d)];console[_0x1a7256(0x1d6)](_0x1a7256(0x111)+_0x3890a7['id']+':\x20type='+_0x3890a7[_0x1a7256(0x1d9)]+_0x1a7256(0x155)+_0x3890a7[_0x1a7256(0x177)]+_0x1a7256(0x1c3)+_0x3890a7[_0x1a7256(0xfb)]);const _0x207ee5=_0x3890a7['currentPayments']+0x1,_0x2f0197=_0x3890a7[_0x1a7256(0x1d9)]==='SINGLE'?_0x1a7256(0x1b1):_0x3890a7[_0x1a7256(0xfb)];await database_1[_0x1a7256(0x118)][_0x1a7256(0x19d)][_0x1a7256(0x192)]({'where':{'id':_0x3890a7['id']},'data':{'currentPayments':_0x207ee5,'status':_0x2f0197,'updatedAt':new Date()}}),console['log']('‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20'+_0x3890a7['id']+_0x1a7256(0x104)+_0x3890a7[_0x1a7256(0x177)]+_0x1a7256(0x1a0)+_0x207ee5+_0x1a7256(0x1c3)+_0x3890a7[_0x1a7256(0xfb)]+_0x1a7256(0x1a0)+_0x2f0197);}catch(_0x136f7e){console[_0x1a7256(0x1ef)](_0x1a7256(0x1a8),_0x136f7e);}else console['log']('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x371ef6['id']+_0x1a7256(0x1e2));}await database_1[_0x1a7256(0x118)][_0x1a7256(0x151)]['create']({'data':{'paymentId':_0x371ef6['id'],'shopId':_0x371ef6['shopId'],'event':_0x1a7256(0x1d3)+_0x113464['status'][_0x1a7256(0x144)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x371ef6[_0x1a7256(0xfb)],'newStatus':_0x113464[_0x1a7256(0xfb)],'paymentDetails':_0x113464[_0x1a7256(0x18e)],'checkedAt':new Date()[_0x1a7256(0x18d)]()})}}),await this['sendShopWebhook'](_0x371ef6,_0x113464['status']),await this[_0x1a7256(0x191)](_0x371ef6,_0x113464[_0x1a7256(0xfb)]),_0x113464['status']!==_0x1a7256(0x1fd)&&(console[_0x1a7256(0x1d6)](_0x1a7256(0x1a1)+_0x371ef6['id']+_0x1a7256(0x18a)+_0x113464[_0x1a7256(0xfb)]+_0x1a7256(0x1bd)),this[_0x1a7256(0x16b)](_0x371ef6['id'])),console[_0x1a7256(0x1d6)]('‚úÖ\x20[CHECK]\x20Payment\x20'+_0x371ef6['id']+_0x1a7256(0x103));}else console[_0x1a7256(0x1d6)](_0x1a7256(0x1f8)+_0x371ef6['id']+_0x1a7256(0x1bf)+_0x113464[_0x1a7256(0xfb)]+')'),this[_0x1a7256(0x109)](_0x371ef6['id'],_0x371ef6[_0x1a7256(0x14f)],_0x371ef6[_0x1a7256(0xfb)],_0x113464[_0x1a7256(0xfb)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x113464[_0x1a7256(0x18e)],'amount':_0x113464[_0x1a7256(0x187)],'currency':_0x113464[_0x1a7256(0x120)],'shopId':_0x371ef6['shopId'],'checkTimestamp':new Date()[_0x1a7256(0x18d)]()});}catch(_0x10fb43){console['error'](_0x1a7256(0x1d2)+_0x371ef6['id']+':',_0x10fb43),this[_0x1a7256(0x142)](_0x371ef6['id'],_0x371ef6[_0x1a7256(0x14f)],_0x10fb43,'status_check',{'paymentAmount':_0x371ef6['amount'],'paymentCurrency':_0x371ef6[_0x1a7256(0x120)],'shopId':_0x371ef6['shopId'],'createdAt':_0x371ef6['createdAt']}),await database_1[_0x1a7256(0x118)]['webhookLog'][_0x1a7256(0x12c)]({'data':{'paymentId':_0x371ef6['id'],'shopId':_0x371ef6[_0x1a7256(0x132)],'event':_0x1a7256(0x126),'statusCode':0x1f4,'responseBody':JSON[_0x1a7256(0x194)]({'error':_0x10fb43 instanceof Error?_0x10fb43[_0x1a7256(0x178)]:_0x1a7256(0x1cf),'gatewayPaymentId':_0x371ef6[_0x1a7256(0x14f)],'checkedAt':new Date()[_0x1a7256(0x18d)]()})}});}}async['sendShopWebhook'](_0x181670,_0x7c7430){const _0x5ded8b=a38_0x2e45b8,_0x1c573f=Date['now']();try{const _0x193536=_0x181670[_0x5ded8b(0x117)],_0xd11ee1=_0x193536[_0x5ded8b(0x1dd)];if(!_0xd11ee1?.[_0x5ded8b(0x17a)]){console[_0x5ded8b(0x1d6)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x193536['id']);return;}const _0x12c036=_0x7c7430===_0x5ded8b(0x1eb)?_0x5ded8b(0x173):_0x7c7430===_0x5ded8b(0x149)?'payment.failed':_0x7c7430===_0x5ded8b(0x13f)?'payment.failed':_0x5ded8b(0x197);if(!_0xd11ee1['webhookEvents']?.[_0x5ded8b(0x179)](_0x12c036)){console[_0x5ded8b(0x1d6)](_0x5ded8b(0x14e)+_0x12c036+_0x5ded8b(0x1e5)+_0x193536['id']);return;}const _0x58a3f4=(0x0,gateway_1[_0x5ded8b(0x19f)])(_0x181670[_0x5ded8b(0x1a7)])||_0x181670[_0x5ded8b(0x1a7)],_0x11793d={'event':_0x12c036,'payment':{'id':_0x181670['id'],'order_id':_0x181670[_0x5ded8b(0xfd)],'gateway_order_id':_0x181670[_0x5ded8b(0x1e6)],'gateway':_0x58a3f4,'amount':_0x181670[_0x5ded8b(0x187)],'currency':_0x181670['currency'],'status':_0x7c7430[_0x5ded8b(0x144)](),'customer_email':_0x181670['customerEmail'],'customer_name':_0x181670[_0x5ded8b(0x175)],'created_at':_0x181670[_0x5ded8b(0x166)],'updated_at':new Date()}},_0x5a2873=await fetch(_0xd11ee1[_0x5ded8b(0x17a)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x11793d)}),_0x21be6b=Date['now']()-_0x1c573f,_0x1a25e6=_0x5a2873['ok']?_0x5ded8b(0x107):await _0x5a2873[_0x5ded8b(0x1ca)]();loggerService_1['loggerService'][_0x5ded8b(0x16e)](_0x181670[_0x5ded8b(0x132)],_0xd11ee1['webhookUrl'],_0x12c036,_0x5a2873['status'],_0x21be6b,_0x11793d),console[_0x5ded8b(0x1d6)](_0x5ded8b(0x1f4)+_0xd11ee1['webhookUrl']+_0x5ded8b(0x122)+_0x5a2873[_0x5ded8b(0xfb)]+'\x20('+_0x21be6b+_0x5ded8b(0x1b9));}catch(_0x2180a7){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x2180a7),loggerService_1['loggerService'][_0x5ded8b(0x119)](_0x181670[_0x5ded8b(0x132)],_0x181670[_0x5ded8b(0x117)]?.[_0x5ded8b(0x1dd)]?.[_0x5ded8b(0x17a)]||_0x5ded8b(0x180),'webhook_send',_0x2180a7,{});}}async['sendPaymentStatusNotification'](_0x535e7c,_0x1a5bc8){const _0x1e9d3b=a38_0x2e45b8;try{const _0x3ef6fb={'PENDING':_0x1e9d3b(0x1f0),'PAID':_0x1e9d3b(0x139),'FAILED':_0x1e9d3b(0x1bb),'EXPIRED':_0x1e9d3b(0x1a4)},_0x1bd1a9=_0x3ef6fb[_0x1a5bc8];if(!_0x1bd1a9||_0x1bd1a9===_0x1e9d3b(0x1f0))return;await telegramBotService_1[_0x1e9d3b(0x1e0)][_0x1e9d3b(0x1c6)](_0x535e7c[_0x1e9d3b(0x132)],_0x535e7c,_0x1bd1a9);}catch(_0x5e4eab){console['error'](_0x1e9d3b(0x1c2),_0x5e4eab);}}async[a38_0x2e45b8(0x1ea)](_0x339115){const _0x4460e8=a38_0x2e45b8;console[_0x4460e8(0x1d6)](_0x4460e8(0x1c5)+_0x339115);const _0x324066=await database_1[_0x4460e8(0x118)][_0x4460e8(0x163)][_0x4460e8(0x123)]({'where':{'id':_0x339115},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x324066)throw new Error(_0x4460e8(0x1b5));if(_0x324066[_0x4460e8(0x1a7)]!=='cointopay'&&_0x324066[_0x4460e8(0x1a7)]!==_0x4460e8(0x1b4))throw new Error(_0x4460e8(0x183));console[_0x4460e8(0x1d6)](_0x4460e8(0x15d)+_0x324066[_0x4460e8(0x1a7)]+_0x4460e8(0x1ed)+_0x339115),await this['checkSinglePayment'](_0x324066),console[_0x4460e8(0x1d6)](_0x4460e8(0x141)+_0x339115);}['getServiceStats'](){const _0x20d332=a38_0x2e45b8,_0x2466ab=this['globalCheckInterval']?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x2e37d4=Array[_0x20d332(0x128)](this[_0x20d332(0x1d8)][_0x20d332(0x158)]())['map'](_0xb7d590=>({'paymentId':_0xb7d590['paymentId'],'gatewayPaymentId':_0xb7d590[_0x20d332(0x14f)],'createdAt':_0xb7d590[_0x20d332(0x166)],'timersCount':_0xb7d590[_0x20d332(0x16f)][_0x20d332(0x193)]}));return{'isActive':!!this[_0x20d332(0x198)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x20d332(0x154)],'activeIndividualTimers':this[_0x20d332(0x1d8)][_0x20d332(0x1e3)],'nextGlobalCheckIn':_0x2466ab,'paymentTimersDetails':_0x2e37d4};}[a38_0x2e45b8(0x1e7)](_0x3d9ddb){const _0x1e4e8a=a38_0x2e45b8,_0x447101=this['paymentTimers'][_0x1e4e8a(0x1b7)](_0x3d9ddb);if(_0x447101)return{'hasTimers':!![],'timersCount':_0x447101[_0x1e4e8a(0x16f)][_0x1e4e8a(0x193)],'createdAt':_0x447101[_0x1e4e8a(0x166)],'gatewayPaymentId':_0x447101[_0x1e4e8a(0x14f)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0x48f6f7,_0x1fa3bf){const _0x57e746=a38_0x2e45b8;try{const _0x2ee771=await database_1[_0x57e746(0x118)][_0x57e746(0x117)]['findUnique']({'where':{'id':_0x48f6f7},'select':{'gatewaySettings':!![]}});if(!_0x2ee771?.[_0x57e746(0x15f)])return console[_0x57e746(0x1d6)](_0x57e746(0x10e)+_0x48f6f7+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x1cd0b6=JSON['parse'](_0x2ee771['gatewaySettings']);for(const [_0x4e6017,_0x4ccaa2]of Object['entries'](_0x1cd0b6)){if(_0x4e6017[_0x57e746(0x144)]()===_0x1fa3bf['toLowerCase']()){const _0x5da099=_0x4ccaa2[_0x57e746(0x1e8)]||0xa;return console[_0x57e746(0x1d6)](_0x57e746(0x116)+_0x1fa3bf+_0x57e746(0x13c)+_0x48f6f7+':\x20'+_0x5da099+'%'),_0x5da099;}}return console[_0x57e746(0x1d6)](_0x57e746(0x1a5)+_0x1fa3bf+_0x57e746(0x1f1)+_0x48f6f7+_0x57e746(0x135)),0xa;}catch(_0x419aa3){return console['error']('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x48f6f7+_0x57e746(0x1fe)+_0x1fa3bf+':',_0x419aa3),0xa;}}}exports[a38_0x2e45b8(0x186)]=CoinToPayStatusService,exports[a38_0x2e45b8(0x15c)]=new CoinToPayStatusService();