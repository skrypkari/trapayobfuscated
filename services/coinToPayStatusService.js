'use strict';function a57_0x32f3(){const _0x454ceb=['stopPeriodicStatusCheck','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20->\x20','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','\x20updated:\x20currentPayments=','\x20\x20\x20üìä\x20Status:\x20','paid','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','webhookLog','getDate','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','schedulePaymentChecks','paymentTimers','./loggerService','/status/','confirmedOn','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20\x20\x20-\x20Status:\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','checkPaymentStatus','\x20status\x20unchanged\x20(','paymentId','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','setDate','create','createdAt','801480msHIRh','SINGLE','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','\x20to\x20','CoinToPayStatusService','Payment\x20System/1.0','toLowerCase','loggerService','../types/gateway','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','bankDetails','floor','logCoinToPayStatus','\x20\x20\x20üìÖ\x20Time:\x20','sha256','payment.pending','EXPIRED','COINTOPAY_STATUS_CHANGE','createHmac','\x20(after\x20','coinToPayService','ü™ô\x20[GLOBAL]\x20Found\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','PENDING','\x20details:','startPeriodicStatusCheck','cointopay_auto_expired','\x20status:\x20',',\x20stopping\x20individual\x20checks','default','created','-day\x20timeout','coinToPayStatusService','now','message','\x20marked\x20as\x20paid\x20at:\x20','./gateways/coinToPay2Service','üìà\x20[COINTOPAY]\x20Payment\x20','h),\x20skipping\x20global\x20check','values','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','currency','getGatewayIdByName','\x20commission:\x20','üìä\x20[CHECK]\x20Payment\x20','POST','unknown','auto_expire','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20',',\x20using\x20default\x20commission\x2010%','checkExpiredPayments','üßπ\x20[CHECK]\x20Payment\x20','\x20not\x20enabled\x20for\x20shop\x20','type','payment.failed','2425377rZrISq','__esModule','\x20seconds\x20(','CoinToPayService','description','.\x20Remaining\x20active\x20timers:\x20','iban','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','checkSinglePaymentById','status','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','COINTOPAY_ERROR','‚úÖ\x20[CHECK]\x20Payment\x20','Success','orderId','\x20\x20\x20‚ùå\x20Error:\x20','\x20commission\x20for\x20shop\x20','8322776FxfVyj','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','logWhiteDomainError','./gateways/coinToPayService','‚è∞\x20[GLOBAL]\x20Payment\x20','\x20expired','delay','payment.success','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','globalCheckInterval','stack','catch','expired','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','commission','coinToPay2Service','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','hex','\x20completed\x20for\x20payment\x20','‚ùå\x20[HOURLY]\x20Payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','\x20not\x20found,\x20clearing\x20timers','remitterIban','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','2\x20minutes','EXPIRY_DAYS','\x20with\x20status\x20','shop','üßπ\x20[DEBUG]\x20Clearing\x20','‚úÖ\x20[EXPIRY]\x20Payment\x20','logShopWebhookSent','\x20\x20\x20üìç\x20Source:\x20','cointopay','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',',\x20status=','checkAllPendingPayments','stringify','Failed\x20to\x20send\x20shop\x20webhook:','üí∞\x20[CHECK]\x20Payment\x20','webhookUrl','\x20triggered\x20for\x20payment\x20','log','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','defineProperty','\x20days\x20(created\x20before\x20','\x20expired\x20CoinToPay\x20payments','Payment\x20older\x20than\x20','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','amount','convertToUSDT','timers','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','toFixed','__importDefault','paymentLinkId','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20not\x20found\x20in\x20database','165541mKuUuO','\x20is\x20too\x20new\x20(','error','digest','update','length','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','5\x20minutes','./currencyService','ms)','5244204pXAvhQ','set',':\x20type=','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','paymentLink','üîç\x20[CHECK]\x20Checking\x20','getServiceStats','‚è∞\x20[GLOBAL]\x20Found\x20','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','üõë\x20[SHUTDOWN]\x20Cleared\x20','\x20in\x20','webhookEvents','transactionId','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','size','PAID','currentPayments','application/json','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','toISOString','sendPaymentStatusNotification','forEach','\x20\x20\x20üìù\x20Context:','Unknown\x20error','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20status\x20changed\x20to\x20','map','has','\x20pending\x20CoinToPay\x20payments','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','‚ùå\x20[CHECK]\x20Payment\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','get','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20\x20\x20Amount\x20after\x20commission:\x20','10GiJRro',',\x20gateway\x20','getGatewayCommission','cointopay2','push','\x20\x20\x20-\x20gatewayPaymentId:\x20','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','./telegramBotService','gatewayOrderId','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','‚è∞\x20[HOURLY]\x20Payment\x20','amountUSDT','createdOn','gateway','parse','sendPaymentNotification','\x20\x20\x20Gateway\x20','clearPaymentTimers','status_check','\x20\x20\x20-\x20Gateway:\x20','\x20days','\x20has\x20no\x20gatewayPaymentId','timestamp','\x20for\x20payment\x20','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','amountAfterGatewayCommissionUSDT','cointopay_status_check_error','cointopay_status_check_','\x20is\x20valid\x20for\x20checking,\x20proceeding...','currencyService','‚úÖ\x20[HOURLY]\x20Payment\x20','getTime','checkSinglePayment','\x20checked,\x20','from','Shop\x20webhook\x20sent\x20to\x20','secretKey','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','gatewaySettings','failed','\x20to\x20clear','\x20\x20\x20-\x20paymentId:\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','gatewayPaymentId','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','paidAt','schedule_created','delete','GLOBAL_CHECK_INTERVAL_MS','Gateway\x20','sendShopWebhook','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','ü™ô\x20[DEBUG]\x20Creating\x20','\x20individual\x20payment\x20timers','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','\x20status\x20from\x20','Payment\x20not\x20found','gatewayCommissionRate','\x20status\x20is\x20','\x20\x20\x20-\x20Amount:\x20','\x20is\x20older\x20than\x20','shopId','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','payment','paymentDetails','logCoinToPayError','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','1386865sQMvdr','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','findUnique','1014321QpNfWp','logShopWebhookError'];a57_0x32f3=function(){return _0x454ceb;};return a57_0x32f3();}const a57_0x732312=a57_0x3369;function a57_0x3369(_0x5853c0,_0x3f63f0){_0x5853c0=_0x5853c0-0x89;const _0x32f3c0=a57_0x32f3();let _0x336915=_0x32f3c0[_0x5853c0];return _0x336915;}(function(_0x4639c3,_0x4ef500){const _0x369a9d=a57_0x3369,_0x27191e=_0x4639c3();while(!![]){try{const _0x487a94=parseInt(_0x369a9d(0x16e))/0x1*(-parseInt(_0x369a9d(0x19b))/0x2)+parseInt(_0x369a9d(0x122))/0x3+parseInt(_0x369a9d(0xea))/0x4+parseInt(_0x369a9d(0xcb))/0x5+-parseInt(_0x369a9d(0x178))/0x6+-parseInt(_0x369a9d(0xce))/0x7+parseInt(_0x369a9d(0x133))/0x8;if(_0x487a94===_0x4ef500)break;else _0x27191e['push'](_0x27191e['shift']());}catch(_0x49c7e3){_0x27191e['push'](_0x27191e['shift']());}}}(a57_0x32f3,0x752a3));var __importDefault=this&&this[a57_0x732312(0x16a)]||function(_0x3eea37){return _0x3eea37&&_0x3eea37['__esModule']?_0x3eea37:{'default':_0x3eea37};};Object[a57_0x732312(0x160)](exports,a57_0x732312(0x123),{'value':!![]}),exports[a57_0x732312(0x10a)]=exports[a57_0x732312(0xee)]=void 0x0;const crypto_1=__importDefault(require('crypto')),coinToPayService_1=require(a57_0x732312(0x137)),coinToPay2Service_1=require(a57_0x732312(0x10e)),gateway_1=require(a57_0x732312(0xf2)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a57_0x732312(0x8b)),loggerService_1=require(a57_0x732312(0xdd)),currencyService_1=require(a57_0x732312(0x176));class CoinToPayStatusService{constructor(){const _0x2015b4=a57_0x732312;this[_0x2015b4(0x13d)]=null,this[_0x2015b4(0xb8)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x2015b4(0xdc)]=new Map(),this[_0x2015b4(0xfe)]=new coinToPayService_1[(_0x2015b4(0x125))](),this[_0x2015b4(0x143)]=new coinToPay2Service_1['CoinToPay2Service'](),console[_0x2015b4(0x15e)]('ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}[a57_0x732312(0xdb)](_0x3e72fe,_0x32cb6e){const _0x4d9e1c=a57_0x732312;console['log'](_0x4d9e1c(0xd1)),console[_0x4d9e1c(0x15e)](_0x4d9e1c(0xae)+_0x3e72fe),console[_0x4d9e1c(0x15e)](_0x4d9e1c(0x89)+_0x32cb6e),this[_0x4d9e1c(0x96)](_0x3e72fe);const _0x70c799=[],_0x2abc96=new Date(),_0x4ff9c5=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x4d9e1c(0x14d)},{'delay':0x5*0x3c*0x3e8,'description':_0x4d9e1c(0x175)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console['log'](_0x4d9e1c(0xbc)+_0x4ff9c5[_0x4d9e1c(0x173)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x3e72fe);let _0x29fe47=0x0;_0x4ff9c5[_0x4d9e1c(0x18d)]((_0x4a44c2,_0x2b3829)=>{const _0x204a6c=_0x4d9e1c;_0x29fe47+=_0x4a44c2[_0x204a6c(0x13a)];const _0x57c897=setTimeout(async()=>{const _0x2dfd87=_0x204a6c;console[_0x2dfd87(0x15e)](_0x2dfd87(0xcc)+(_0x2b3829+0x1)+_0x2dfd87(0x15d)+_0x3e72fe+_0x2dfd87(0xfd)+_0x4a44c2[_0x2dfd87(0x126)]+')');try{await this[_0x2dfd87(0x12a)](_0x3e72fe),console[_0x2dfd87(0x15e)](_0x2dfd87(0x9d)+(_0x2b3829+0x1)+_0x2dfd87(0x147)+_0x3e72fe);}catch(_0x17d848){console['error']('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x2b3829+0x1)+_0x2dfd87(0x9c)+_0x3e72fe+':',_0x17d848),this[_0x2dfd87(0xc9)](_0x3e72fe,_0x32cb6e,_0x17d848,_0x2dfd87(0x97),{'checkNumber':_0x2b3829+0x1,'scheduledAfter':_0x4a44c2[_0x2dfd87(0x126)],'isIndividualCheck':!![]});}},_0x29fe47);_0x70c799[_0x204a6c(0x19f)](_0x57c897),console[_0x204a6c(0x15e)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x2b3829+0x1)+_0x204a6c(0x9c)+_0x3e72fe+_0x204a6c(0x182)+_0x29fe47/0x3e8+_0x204a6c(0x124)+_0x4a44c2[_0x204a6c(0x126)]+')');});const _0xb657dd=setInterval(async()=>{const _0x15844b=_0x4d9e1c;console[_0x15844b(0x15e)](_0x15844b(0x112)+_0x3e72fe);try{const _0x3cf25c=await database_1['default']['payment'][_0x15844b(0xcd)]({'where':{'id':_0x3e72fe},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x3cf25c){console[_0x15844b(0x15e)](_0x15844b(0x148)+_0x3e72fe+_0x15844b(0x14a)),this['clearPaymentTimers'](_0x3e72fe);return;}console['log']('üìä\x20[HOURLY]\x20Payment\x20'+_0x3e72fe+'\x20current\x20status:\x20'+_0x3cf25c['status']);if(_0x3cf25c[_0x15844b(0x12b)]!=='PENDING'){console[_0x15844b(0x15e)](_0x15844b(0xa3)+_0x3e72fe+_0x15844b(0xc2)+_0x3cf25c[_0x15844b(0x12b)]+',\x20stopping\x20individual\x20checks'),this[_0x15844b(0x96)](_0x3e72fe);return;}const _0x45bc11=Math[_0x15844b(0xf5)]((Date[_0x15844b(0x10b)]()-_0x3cf25c[_0x15844b(0xe9)][_0x15844b(0xa4)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x45bc11>=this['EXPIRY_DAYS']){console[_0x15844b(0x15e)](_0x15844b(0x8f)+_0x3e72fe+'\x20is\x20older\x20than\x20'+this[_0x15844b(0x14e)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x15844b(0x96)](_0x3e72fe);return;}await this[_0x15844b(0x12a)](_0x3e72fe),console[_0x15844b(0x15e)](_0x15844b(0x141)+_0x3e72fe);}catch(_0x17281f){console[_0x15844b(0x170)](_0x15844b(0x134)+_0x3e72fe+':',_0x17281f),this['logCoinToPayError'](_0x3e72fe,_0x32cb6e,_0x17281f,_0x15844b(0x97),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x70c799['push'](_0xb657dd),this[_0x4d9e1c(0xdc)][_0x4d9e1c(0x179)](_0x3e72fe,{'timers':_0x70c799,'paymentId':_0x3e72fe,'gatewayPaymentId':_0x32cb6e,'createdAt':_0x2abc96}),console[_0x4d9e1c(0x15e)](_0x4d9e1c(0xd7)+_0x4ff9c5['length']+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x3e72fe),console[_0x4d9e1c(0x15e)]('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x4d9e1c(0xdc)][_0x4d9e1c(0x186)]),this[_0x4d9e1c(0xf6)](_0x3e72fe,_0x32cb6e,'PENDING',_0x4d9e1c(0x101),_0x4d9e1c(0x97),{'action':_0x4d9e1c(0xb6),'scheduledChecks':_0x4ff9c5[_0x4d9e1c(0x173)],'firstCheckIn':_0x4ff9c5[0x0][_0x4d9e1c(0x13a)]/0x3e8,'totalTimers':this['paymentTimers']['size']});}[a57_0x732312(0x96)](_0x1ce043){const _0x24bafd=a57_0x732312,_0x1b0964=this[_0x24bafd(0xdc)][_0x24bafd(0x198)](_0x1ce043);_0x1b0964?(console[_0x24bafd(0x15e)](_0x24bafd(0x151)+_0x1b0964[_0x24bafd(0x167)][_0x24bafd(0x173)]+'\x20timers\x20for\x20payment\x20'+_0x1ce043),_0x1b0964[_0x24bafd(0x167)][_0x24bafd(0x18d)]((_0x3ab1d8,_0x1685f7)=>{const _0x5c3df2=_0x24bafd;_0x3ab1d8&&(clearTimeout(_0x3ab1d8),clearInterval(_0x3ab1d8),console[_0x5c3df2(0x15e)](_0x5c3df2(0x13c)+(_0x1685f7+0x1)+_0x5c3df2(0x9c)+_0x1ce043));}),this['paymentTimers'][_0x24bafd(0xb7)](_0x1ce043),console[_0x24bafd(0x15e)](_0x24bafd(0x16c)+_0x1ce043+_0x24bafd(0x127)+this[_0x24bafd(0xdc)][_0x24bafd(0x186)])):console[_0x24bafd(0x15e)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x1ce043+_0x24bafd(0xad));}async[a57_0x732312(0x12a)](_0x1849c5){const _0x5b7cbe=a57_0x732312;console[_0x5b7cbe(0x15e)](_0x5b7cbe(0x15f)+_0x1849c5);const _0x463449=await database_1[_0x5b7cbe(0x107)]['payment'][_0x5b7cbe(0xcd)]({'where':{'id':_0x1849c5},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x463449){console[_0x5b7cbe(0x15e)](_0x5b7cbe(0x196)+_0x1849c5+_0x5b7cbe(0x16d));return;}console['log'](_0x5b7cbe(0x117)+_0x1849c5+'\x20found:'),console[_0x5b7cbe(0x15e)](_0x5b7cbe(0x98)+_0x463449[_0x5b7cbe(0x92)]),console[_0x5b7cbe(0x15e)](_0x5b7cbe(0xe1)+_0x463449[_0x5b7cbe(0x12b)]),console['log'](_0x5b7cbe(0x190)+_0x463449['gatewayPaymentId']),console[_0x5b7cbe(0x15e)](_0x5b7cbe(0xc3)+_0x463449[_0x5b7cbe(0x165)]+'\x20'+_0x463449[_0x5b7cbe(0x114)]),console[_0x5b7cbe(0x15e)]('\x20\x20\x20-\x20ShopId:\x20'+_0x463449[_0x5b7cbe(0xc5)]);if(_0x463449[_0x5b7cbe(0x92)]!==_0x5b7cbe(0x155)&&_0x463449[_0x5b7cbe(0x92)]!==_0x5b7cbe(0x19e)){console['log'](_0x5b7cbe(0x174)+_0x1849c5+_0x5b7cbe(0xb3)+_0x463449['gateway']+')');return;}if(_0x463449[_0x5b7cbe(0x12b)]!==_0x5b7cbe(0x101)){console[_0x5b7cbe(0x15e)](_0x5b7cbe(0x174)+_0x1849c5+_0x5b7cbe(0xc2)+_0x463449[_0x5b7cbe(0x12b)]+_0x5b7cbe(0x106)),this['clearPaymentTimers'](_0x1849c5);return;}if(!_0x463449[_0x5b7cbe(0xb1)]){console[_0x5b7cbe(0x15e)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x1849c5+_0x5b7cbe(0x9a));return;}console['log']('‚úÖ\x20[CHECK]\x20Payment\x20'+_0x1849c5+_0x5b7cbe(0xa1)),await this['checkSinglePayment'](_0x463449);}[a57_0x732312(0xf6)](_0x4a0c62,_0x571325,_0x1351f3,_0x41cdf3,_0x5aa36f,_0x60f259){const _0x1c66a3=a57_0x732312,_0x890424={'type':_0x1c66a3(0xfb),'paymentId':_0x4a0c62,'gatewayPaymentId':_0x571325,'oldStatus':_0x1351f3,'newStatus':_0x41cdf3,'source':_0x5aa36f,'timestamp':new Date()[_0x1c66a3(0x18b)](),'details':_0x60f259||{}};loggerService_1[_0x1c66a3(0xf1)]['logCoinToPayStatus'](_0x890424),console[_0x1c66a3(0x15e)](_0x1c66a3(0x11b)+_0x4a0c62+'\x20('+_0x571325+')'),console[_0x1c66a3(0x15e)](_0x1c66a3(0xd5)+_0x1351f3+_0x1c66a3(0xd2)+_0x41cdf3),console[_0x1c66a3(0x15e)](_0x1c66a3(0x154)+_0x5aa36f),console[_0x1c66a3(0x15e)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x890424['timestamp']),_0x60f259&&console[_0x1c66a3(0x15e)]('\x20\x20\x20üìù\x20Details:',_0x60f259);}[a57_0x732312(0xc9)](_0x5d0d22,_0x239564,_0x500dce,_0x88851,_0x11577c){const _0x138020=a57_0x732312,_0x4c7f11={'type':_0x138020(0x12d),'paymentId':_0x5d0d22,'gatewayPaymentId':_0x239564,'error':_0x500dce instanceof Error?{'message':_0x500dce[_0x138020(0x10c)],'stack':_0x500dce[_0x138020(0x13e)]}:_0x500dce,'source':_0x88851,'timestamp':new Date()['toISOString'](),'context':_0x11577c||{}};loggerService_1[_0x138020(0xf1)]['logCoinToPayError'](_0x4c7f11),console[_0x138020(0x170)]('ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x5d0d22+'\x20('+_0x239564+')'),console[_0x138020(0x170)](_0x138020(0x131)+(_0x500dce instanceof Error?_0x500dce[_0x138020(0x10c)]:_0x500dce)),console['error'](_0x138020(0x154)+_0x88851),console[_0x138020(0x170)](_0x138020(0xf7)+_0x4c7f11[_0x138020(0x9b)]),_0x11577c&&console[_0x138020(0x170)](_0x138020(0x18e),_0x11577c);}[a57_0x732312(0x103)](){const _0x1845b3=a57_0x732312;console['log'](_0x1845b3(0x14c)),this[_0x1845b3(0x158)]()[_0x1845b3(0x13f)](_0x115f8f=>{const _0x39331a=_0x1845b3;console[_0x39331a(0x170)](_0x39331a(0x18a),_0x115f8f);}),this[_0x1845b3(0x13d)]=setInterval(async()=>{const _0x355aee=_0x1845b3;try{console[_0x355aee(0x15e)]('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x355aee(0x158)](),console[_0x355aee(0x15e)](_0x355aee(0x197));}catch(_0x35fde4){console[_0x355aee(0x170)](_0x355aee(0x156),_0x35fde4);}},this[_0x1845b3(0xb8)]),console['log'](_0x1845b3(0xaf));}[a57_0x732312(0xd0)](){const _0xc0dd84=a57_0x732312;console[_0xc0dd84(0x15e)](_0xc0dd84(0xc6));this['globalCheckInterval']&&(clearInterval(this[_0xc0dd84(0x13d)]),this[_0xc0dd84(0x13d)]=null,console[_0xc0dd84(0x15e)](_0xc0dd84(0xe0)));const _0x5a0f5d=this[_0xc0dd84(0xdc)][_0xc0dd84(0x186)];for(const [_0x2bbce2]of this['paymentTimers']){this['clearPaymentTimers'](_0x2bbce2);}console[_0xc0dd84(0x15e)](_0xc0dd84(0x181)+_0x5a0f5d+_0xc0dd84(0xbd));}async['checkAllPendingPayments'](){const _0x4bac69=a57_0x732312;try{console[_0x4bac69(0x15e)](_0x4bac69(0xaa));const _0x4d122f=await database_1[_0x4bac69(0x107)][_0x4bac69(0xc7)]['findMany']({'where':{'gateway':{'in':['cointopay',_0x4bac69(0x19e)]},'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x4bac69(0x15e)](_0x4bac69(0xff)+_0x4d122f[_0x4bac69(0x173)]+_0x4bac69(0x194));if(_0x4d122f[_0x4bac69(0x173)]===0x0){console['log']('ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x7497fc=await this[_0x4bac69(0x11d)](_0x4d122f);console['log'](_0x4bac69(0x17f)+_0x7497fc[_0x4bac69(0x173)]+_0x4bac69(0x162));let _0x1d53d0=0x0,_0x3dba56=0x0;for(const _0x4b89fd of _0x4d122f){try{if(_0x7497fc['includes'](_0x4b89fd['id'])){console['log'](_0x4bac69(0x138)+_0x4b89fd['id']+_0x4bac69(0x195)),_0x3dba56++;continue;}if(this['paymentTimers'][_0x4bac69(0x193)](_0x4b89fd['id'])){console[_0x4bac69(0x15e)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x4b89fd['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x3dba56++;continue;}const _0x3f3856=(Date['now']()-_0x4b89fd[_0x4bac69(0xe9)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x3f3856<0x1){console[_0x4bac69(0x15e)](_0x4bac69(0x138)+_0x4b89fd['id']+_0x4bac69(0x16f)+_0x3f3856[_0x4bac69(0x169)](0x1)+_0x4bac69(0x110)),_0x3dba56++;continue;}console[_0x4bac69(0x15e)]('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x4b89fd['id']+'\x20(age:\x20'+_0x3f3856[_0x4bac69(0x169)](0x1)+'h)'),await this[_0x4bac69(0xa5)](_0x4b89fd),_0x1d53d0++,await new Promise(_0x10e35a=>setTimeout(_0x10e35a,0x7d0));}catch(_0x960086){console[_0x4bac69(0x170)](_0x4bac69(0xe2)+_0x4b89fd['id']+':',_0x960086),this[_0x4bac69(0xc9)](_0x4b89fd['id'],_0x4b89fd[_0x4bac69(0xb1)]||_0x4bac69(0x119),_0x960086,_0x4bac69(0x97),{'isGlobalCheck':!![],'paymentAmount':_0x4b89fd[_0x4bac69(0x165)],'paymentCurrency':_0x4b89fd[_0x4bac69(0x114)],'shopId':_0x4b89fd[_0x4bac69(0xc5)],'createdAt':_0x4b89fd[_0x4bac69(0xe9)]}),loggerService_1['loggerService'][_0x4bac69(0x136)](_0x4bac69(0x155),_0x4bac69(0xde)+_0x4b89fd[_0x4bac69(0xb1)],_0x960086);}}console[_0x4bac69(0x15e)](_0x4bac69(0x185)+_0x1d53d0+_0x4bac69(0xa6)+_0x3dba56+'\x20skipped,\x20'+_0x7497fc[_0x4bac69(0x173)]+_0x4bac69(0x139));}catch(_0x2cc4d2){console[_0x4bac69(0x170)](_0x4bac69(0xb0),_0x2cc4d2);}}async['checkExpiredPayments'](_0x5a7c8f){const _0xd74270=a57_0x732312,_0x1dce36=[],_0x4d1d1f=new Date();_0x4d1d1f[_0xd74270(0xe7)](_0x4d1d1f[_0xd74270(0xd9)]()-this['EXPIRY_DAYS']),console[_0xd74270(0x15e)](_0xd74270(0x129)+this['EXPIRY_DAYS']+_0xd74270(0x161)+_0x4d1d1f[_0xd74270(0x18b)]()+')');for(const _0x23c5f4 of _0x5a7c8f){if(_0x23c5f4[_0xd74270(0xe9)]<_0x4d1d1f){console['log'](_0xd74270(0xb4)+_0x23c5f4['id']+_0xd74270(0xc4)+this[_0xd74270(0x14e)]+_0xd74270(0x149));try{this[_0xd74270(0xf6)](_0x23c5f4['id'],_0x23c5f4[_0xd74270(0xb1)]||'unknown',_0xd74270(0x101),_0xd74270(0xfa),'auto_expire',{'reason':_0xd74270(0x163)+this['EXPIRY_DAYS']+_0xd74270(0x99),'createdAt':_0x23c5f4[_0xd74270(0xe9)],'daysSinceCreation':Math[_0xd74270(0xf5)]((Date[_0xd74270(0x10b)]()-_0x23c5f4['createdAt'][_0xd74270(0xa4)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x23c5f4[_0xd74270(0x165)],'paymentCurrency':_0x23c5f4[_0xd74270(0x114)],'shopId':_0x23c5f4[_0xd74270(0xc5)]}),await database_1[_0xd74270(0x107)][_0xd74270(0xc7)][_0xd74270(0x172)]({'where':{'id':_0x23c5f4['id']},'data':{'status':_0xd74270(0xfa),'updatedAt':new Date()}}),await database_1[_0xd74270(0x107)][_0xd74270(0xd8)]['create']({'data':{'paymentId':_0x23c5f4['id'],'shopId':_0x23c5f4[_0xd74270(0xc5)],'event':_0xd74270(0x104),'statusCode':0xc8,'responseBody':JSON[_0xd74270(0x159)]({'reason':_0xd74270(0x163)+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x23c5f4['createdAt'],'expiredAt':new Date()[_0xd74270(0x18b)](),'daysSinceCreation':Math[_0xd74270(0xf5)]((Date[_0xd74270(0x10b)]()-_0x23c5f4[_0xd74270(0xe9)][_0xd74270(0xa4)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0xd74270(0xba)](_0x23c5f4,_0xd74270(0xfa)),await this[_0xd74270(0x18c)](_0x23c5f4,_0xd74270(0xfa)),this[_0xd74270(0x96)](_0x23c5f4['id']),_0x1dce36['push'](_0x23c5f4['id']),console[_0xd74270(0x15e)](_0xd74270(0x152)+_0x23c5f4['id']+_0xd74270(0x199)+this['EXPIRY_DAYS']+_0xd74270(0x109));}catch(_0x5c9c5d){console[_0xd74270(0x170)](_0xd74270(0xbe)+_0x23c5f4['id']+':',_0x5c9c5d),this[_0xd74270(0xc9)](_0x23c5f4['id'],_0x23c5f4['gatewayPaymentId']||_0xd74270(0x119),_0x5c9c5d,_0xd74270(0x11a),{'reason':_0xd74270(0x113),'createdAt':_0x23c5f4[_0xd74270(0xe9)],'daysSinceCreation':Math['floor']((Date[_0xd74270(0x10b)]()-_0x23c5f4[_0xd74270(0xe9)][_0xd74270(0xa4)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x1dce36;}async[a57_0x732312(0xa5)](_0x4c95bf){const _0x499c7a=a57_0x732312;if(!_0x4c95bf[_0x499c7a(0xb1)]){console[_0x499c7a(0x15e)](_0x499c7a(0x174)+_0x4c95bf['id']+_0x499c7a(0x8e));return;}console[_0x499c7a(0x15e)](_0x499c7a(0x17d)+_0x4c95bf[_0x499c7a(0x92)]+'\x20payment\x20'+_0x4c95bf['id']+'\x20('+_0x4c95bf[_0x499c7a(0xb1)]+')');try{let _0x3b77e2;_0x4c95bf['gateway']===_0x499c7a(0x19e)?(_0x3b77e2=await this['coinToPay2Service'][_0x499c7a(0xe3)](_0x4c95bf[_0x499c7a(0xb1)]),console[_0x499c7a(0x15e)](_0x499c7a(0xd3)+_0x4c95bf['id']+_0x499c7a(0x105)+_0x3b77e2[_0x499c7a(0x12b)])):(_0x3b77e2=await this[_0x499c7a(0xfe)]['checkPaymentStatus'](_0x4c95bf[_0x499c7a(0xb1)]),console[_0x499c7a(0x15e)]('üìä\x20[CHECK]\x20CoinToPay\x20payment\x20'+_0x4c95bf['id']+_0x499c7a(0x105)+_0x3b77e2['status']));_0x3b77e2[_0x499c7a(0xc8)]&&console['log'](_0x499c7a(0x117)+_0x4c95bf['id']+_0x499c7a(0x102),{'iban':_0x3b77e2[_0x499c7a(0xc8)][_0x499c7a(0x128)]||'not\x20found','transactionId':_0x3b77e2[_0x499c7a(0xc8)][_0x499c7a(0x184)],'createdOn':_0x3b77e2[_0x499c7a(0xc8)][_0x499c7a(0x91)],'confirmedOn':_0x3b77e2[_0x499c7a(0xc8)][_0x499c7a(0xdf)]||'not\x20confirmed'});if(_0x3b77e2[_0x499c7a(0x12b)]!==_0x4c95bf[_0x499c7a(0x12b)]){console[_0x499c7a(0x15e)](_0x499c7a(0xec)+_0x4c95bf['id']+_0x499c7a(0xbf)+_0x4c95bf['status']+_0x499c7a(0xed)+_0x3b77e2['status']),this[_0x499c7a(0xf6)](_0x4c95bf['id'],_0x4c95bf[_0x499c7a(0xb1)],_0x4c95bf['status'],_0x3b77e2[_0x499c7a(0x12b)],_0x499c7a(0x97),{'paymentDetails':_0x3b77e2[_0x499c7a(0xc8)],'amount':_0x3b77e2[_0x499c7a(0x165)],'currency':_0x3b77e2['currency'],'shopId':_0x4c95bf[_0x499c7a(0xc5)],'checkTimestamp':new Date()[_0x499c7a(0x18b)]()});const _0x1efd05={'status':_0x3b77e2[_0x499c7a(0x12b)],'updatedAt':new Date()};if(_0x3b77e2[_0x499c7a(0x12b)]===_0x499c7a(0x187)&&_0x4c95bf[_0x499c7a(0x12b)]!==_0x499c7a(0x187)){_0x1efd05[_0x499c7a(0xb5)]=new Date();if(!_0x4c95bf[_0x499c7a(0x90)]){const _0x12144a=await currencyService_1[_0x499c7a(0xa2)][_0x499c7a(0x166)](_0x4c95bf[_0x499c7a(0x165)],_0x4c95bf[_0x499c7a(0x114)]);_0x1efd05[_0x499c7a(0x90)]=_0x12144a;const _0x2444ff=await this[_0x499c7a(0x19d)](_0x4c95bf['shopId'],_0x4c95bf[_0x499c7a(0x92)]),_0x4971bc=_0x12144a*(0x1-_0x2444ff/0x64);_0x1efd05[_0x499c7a(0x9e)]=_0x4971bc,_0x1efd05[_0x499c7a(0xc1)]=_0x2444ff,console[_0x499c7a(0x15e)](_0x499c7a(0x15b)+_0x4c95bf['id']+'\x20amounts\x20calculated:'),console[_0x499c7a(0x15e)]('\x20\x20\x20Amount:\x20'+_0x4c95bf[_0x499c7a(0x165)]+'\x20'+_0x4c95bf[_0x499c7a(0x114)]+_0x499c7a(0xd2)+_0x12144a[_0x499c7a(0x169)](0x6)+'\x20USDT'),console[_0x499c7a(0x15e)](_0x499c7a(0x95)+_0x4c95bf[_0x499c7a(0x92)]+_0x499c7a(0x116)+_0x2444ff+'%'),console[_0x499c7a(0x15e)](_0x499c7a(0x19a)+_0x4971bc[_0x499c7a(0x169)](0x6)+'\x20USDT');}console[_0x499c7a(0x15e)](_0x499c7a(0x15b)+_0x4c95bf['id']+_0x499c7a(0x10d)+_0x1efd05['paidAt'][_0x499c7a(0x18b)]());}if(_0x3b77e2[_0x499c7a(0xc8)]){const _0x227c55=_0x3b77e2[_0x499c7a(0xc8)];_0x227c55[_0x499c7a(0x128)]&&(_0x1efd05[_0x499c7a(0x14b)]=_0x227c55[_0x499c7a(0x128)],console['log'](_0x499c7a(0xe6)+_0x227c55['iban'])),_0x227c55[_0x499c7a(0xf4)]&&console[_0x499c7a(0x15e)]('üè¶\x20[CHECK]\x20Bank\x20details\x20provided:\x20'+_0x227c55[_0x499c7a(0xf4)]),_0x227c55['transactionId']&&console[_0x499c7a(0x15e)](_0x499c7a(0x8a)+_0x227c55[_0x499c7a(0x184)]),_0x227c55[_0x499c7a(0xdf)]&&console[_0x499c7a(0x15e)](_0x499c7a(0x180)+_0x227c55['confirmedOn']);}await database_1[_0x499c7a(0x107)][_0x499c7a(0xc7)]['update']({'where':{'id':_0x4c95bf['id']},'data':_0x1efd05});if(_0x3b77e2[_0x499c7a(0x12b)]===_0x499c7a(0x187)&&_0x4c95bf[_0x499c7a(0x12b)]!=='PAID'){console[_0x499c7a(0x15e)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x4c95bf['id']+_0x499c7a(0x12c));const _0xc6267c=await database_1[_0x499c7a(0x107)][_0x499c7a(0xc7)][_0x499c7a(0xcd)]({'where':{'id':_0x4c95bf['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0xc6267c?.[_0x499c7a(0x16b)]&&_0xc6267c[_0x499c7a(0x17c)])try{const _0x4a0463=_0xc6267c['paymentLink'];console[_0x499c7a(0x15e)](_0x499c7a(0x135)+_0x4a0463['id']+_0x499c7a(0x17a)+_0x4a0463[_0x499c7a(0x120)]+',\x20currentPayments='+_0x4a0463['currentPayments']+_0x499c7a(0x157)+_0x4a0463[_0x499c7a(0x12b)]);const _0x4e4e9c=_0x4a0463['currentPayments']+0x1,_0x454205=_0x4a0463[_0x499c7a(0x120)]===_0x499c7a(0xeb)?'COMPLETED':_0x4a0463[_0x499c7a(0x12b)];await database_1[_0x499c7a(0x107)][_0x499c7a(0x17c)][_0x499c7a(0x172)]({'where':{'id':_0x4a0463['id']},'data':{'currentPayments':_0x4e4e9c,'status':_0x454205,'updatedAt':new Date()}}),console['log'](_0x499c7a(0x164)+_0x4a0463['id']+_0x499c7a(0xd4)+_0x4a0463[_0x499c7a(0x188)]+_0x499c7a(0xd2)+_0x4e4e9c+_0x499c7a(0x157)+_0x4a0463[_0x499c7a(0x12b)]+_0x499c7a(0xd2)+_0x454205);}catch(_0x3ebbf3){console[_0x499c7a(0x170)](_0x499c7a(0x17b),_0x3ebbf3);}else console[_0x499c7a(0x15e)](_0x499c7a(0x10f)+_0x4c95bf['id']+_0x499c7a(0x168));}await database_1[_0x499c7a(0x107)][_0x499c7a(0xd8)]['create']({'data':{'paymentId':_0x4c95bf['id'],'shopId':_0x4c95bf[_0x499c7a(0xc5)],'event':_0x499c7a(0xa0)+_0x3b77e2['status'][_0x499c7a(0xf0)](),'statusCode':0xc8,'responseBody':JSON[_0x499c7a(0x159)]({'oldStatus':_0x4c95bf['status'],'newStatus':_0x3b77e2[_0x499c7a(0x12b)],'paymentDetails':_0x3b77e2[_0x499c7a(0xc8)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x499c7a(0xba)](_0x4c95bf,_0x3b77e2['status']),await this[_0x499c7a(0x18c)](_0x4c95bf,_0x3b77e2[_0x499c7a(0x12b)]),_0x3b77e2['status']!==_0x499c7a(0x101)&&(console[_0x499c7a(0x15e)](_0x499c7a(0x11e)+_0x4c95bf['id']+_0x499c7a(0x191)+_0x3b77e2[_0x499c7a(0x12b)]+',\x20clearing\x20individual\x20timers'),this[_0x499c7a(0x96)](_0x4c95bf['id'])),console[_0x499c7a(0x15e)](_0x499c7a(0x12e)+_0x4c95bf['id']+'\x20updated\x20successfully');}else console[_0x499c7a(0x15e)](_0x499c7a(0x117)+_0x4c95bf['id']+_0x499c7a(0xe4)+_0x3b77e2['status']+')'),this[_0x499c7a(0xf6)](_0x4c95bf['id'],_0x4c95bf[_0x499c7a(0xb1)],_0x4c95bf[_0x499c7a(0x12b)],_0x3b77e2['status'],_0x499c7a(0x97),{'statusUnchanged':!![],'paymentDetails':_0x3b77e2[_0x499c7a(0xc8)],'amount':_0x3b77e2['amount'],'currency':_0x3b77e2[_0x499c7a(0x114)],'shopId':_0x4c95bf[_0x499c7a(0xc5)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x537d05){console['error'](_0x499c7a(0x8d)+_0x4c95bf['id']+':',_0x537d05),this[_0x499c7a(0xc9)](_0x4c95bf['id'],_0x4c95bf[_0x499c7a(0xb1)],_0x537d05,'status_check',{'paymentAmount':_0x4c95bf[_0x499c7a(0x165)],'paymentCurrency':_0x4c95bf[_0x499c7a(0x114)],'shopId':_0x4c95bf[_0x499c7a(0xc5)],'createdAt':_0x4c95bf[_0x499c7a(0xe9)]}),await database_1['default']['webhookLog'][_0x499c7a(0xe8)]({'data':{'paymentId':_0x4c95bf['id'],'shopId':_0x4c95bf[_0x499c7a(0xc5)],'event':_0x499c7a(0x9f),'statusCode':0x1f4,'responseBody':JSON[_0x499c7a(0x159)]({'error':_0x537d05 instanceof Error?_0x537d05[_0x499c7a(0x10c)]:_0x499c7a(0x18f),'gatewayPaymentId':_0x4c95bf[_0x499c7a(0xb1)],'checkedAt':new Date()[_0x499c7a(0x18b)]()})}});}}async[a57_0x732312(0xba)](_0x52e147,_0x5dc748){const _0x1df134=a57_0x732312,_0x1f7800=Date['now']();try{const _0x233ab8=_0x52e147[_0x1df134(0x150)],_0x4b5b33=_0x233ab8['settings'];if(!_0x4b5b33?.['webhookUrl']){console[_0x1df134(0x15e)](_0x1df134(0x145)+_0x233ab8['id']);return;}const _0xdb1b1=_0x5dc748===_0x1df134(0x187)?_0x1df134(0x13b):_0x5dc748==='FAILED'?'payment.failed':_0x5dc748==='EXPIRED'?_0x1df134(0x121):_0x1df134(0xf9);if(!_0x4b5b33[_0x1df134(0x183)]?.['includes'](_0xdb1b1)){console[_0x1df134(0x15e)]('Webhook\x20event\x20'+_0xdb1b1+_0x1df134(0x11f)+_0x233ab8['id']);return;}const _0x497f88=(0x0,gateway_1[_0x1df134(0x115)])(_0x52e147[_0x1df134(0x92)])||_0x52e147[_0x1df134(0x92)],_0x5c35e1={'event':_0xdb1b1,'payment':{'id':_0x52e147['id'],'order_id':_0x52e147[_0x1df134(0x130)],'gateway_order_id':_0x52e147[_0x1df134(0x8c)],'gateway':_0x497f88,'amount':_0x52e147[_0x1df134(0x165)],'currency':_0x52e147[_0x1df134(0x114)],'status':_0x5dc748[_0x1df134(0xf0)](),'customer_email':_0x52e147['customerEmail'],'customer_name':_0x52e147['customerName'],'created_at':_0x52e147['createdAt'],'updated_at':new Date()}},_0x2d9bf8=JSON[_0x1df134(0x159)](_0x5c35e1),_0x256647=crypto_1[_0x1df134(0x107)][_0x1df134(0xfc)](_0x1df134(0xf8),_0x52e147[_0x1df134(0x150)][_0x1df134(0xa9)])[_0x1df134(0x172)](_0x2d9bf8)[_0x1df134(0x171)](_0x1df134(0x146)),_0xec025b=await fetch(_0x4b5b33[_0x1df134(0x15c)],{'method':_0x1df134(0x118),'headers':{'Content-Type':_0x1df134(0x189),'User-Agent':_0x1df134(0xef),'X-Webhook-Signature':_0x256647},'body':_0x2d9bf8}),_0xc71b7e=Date[_0x1df134(0x10b)]()-_0x1f7800,_0x2a8a7e=_0xec025b['ok']?_0x1df134(0x12f):await _0xec025b['text']();loggerService_1[_0x1df134(0xf1)][_0x1df134(0x153)](_0x52e147[_0x1df134(0xc5)],_0x4b5b33[_0x1df134(0x15c)],_0xdb1b1,_0xec025b[_0x1df134(0x12b)],_0xc71b7e,_0x5c35e1),console['log'](_0x1df134(0xa8)+_0x4b5b33[_0x1df134(0x15c)]+_0x1df134(0x14f)+_0xec025b[_0x1df134(0x12b)]+'\x20('+_0xc71b7e+_0x1df134(0x177));}catch(_0x412360){console[_0x1df134(0x170)](_0x1df134(0x15a),_0x412360),loggerService_1[_0x1df134(0xf1)][_0x1df134(0xcf)](_0x52e147[_0x1df134(0xc5)],_0x52e147[_0x1df134(0x150)]?.['settings']?.[_0x1df134(0x15c)]||_0x1df134(0x119),'webhook_send',_0x412360,{});}}async['sendPaymentStatusNotification'](_0x5deceb,_0x1d99fb){const _0x2ad122=a57_0x732312;try{const _0x513794={'PENDING':_0x2ad122(0x108),'PAID':_0x2ad122(0xd6),'FAILED':_0x2ad122(0xac),'EXPIRED':_0x2ad122(0x140)},_0x320bd9=_0x513794[_0x1d99fb];if(!_0x320bd9||_0x320bd9===_0x2ad122(0x108))return;await telegramBotService_1['telegramBotService'][_0x2ad122(0x94)](_0x5deceb[_0x2ad122(0xc5)],_0x5deceb,_0x320bd9);}catch(_0x27b30b){console[_0x2ad122(0x170)](_0x2ad122(0x100),_0x27b30b);}}async['checkPaymentById'](_0x352414){const _0x36c89a=a57_0x732312;console[_0x36c89a(0x15e)](_0x36c89a(0xf3)+_0x352414);const _0x924f0f=await database_1[_0x36c89a(0x107)]['payment']['findUnique']({'where':{'id':_0x352414},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x924f0f)throw new Error(_0x36c89a(0xc0));if(_0x924f0f[_0x36c89a(0x92)]!=='cointopay'&&_0x924f0f[_0x36c89a(0x92)]!==_0x36c89a(0x19e))throw new Error(_0x36c89a(0xbb));console[_0x36c89a(0x15e)](_0x36c89a(0x144)+_0x924f0f['gateway']+'\x20payment\x20'+_0x352414),await this[_0x36c89a(0xa5)](_0x924f0f),console[_0x36c89a(0x15e)](_0x36c89a(0xda)+_0x352414);}[a57_0x732312(0x17e)](){const _0x1767a5=a57_0x732312,_0x3bb07a=this[_0x1767a5(0x13d)]?this[_0x1767a5(0xb8)]:undefined,_0x54be4b=Array[_0x1767a5(0xa7)](this[_0x1767a5(0xdc)][_0x1767a5(0x111)]())[_0x1767a5(0x192)](_0x1fccb4=>({'paymentId':_0x1fccb4[_0x1767a5(0xe5)],'gatewayPaymentId':_0x1fccb4['gatewayPaymentId'],'createdAt':_0x1fccb4[_0x1767a5(0xe9)],'timersCount':_0x1fccb4[_0x1767a5(0x167)]['length']}));return{'isActive':!!this[_0x1767a5(0x13d)],'globalCheckIntervalMinutes':this[_0x1767a5(0xb8)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this['paymentTimers']['size'],'nextGlobalCheckIn':_0x3bb07a,'paymentTimersDetails':_0x54be4b};}['getPaymentTimerInfo'](_0x4521f8){const _0x55fa2c=a57_0x732312,_0x3ed301=this[_0x55fa2c(0xdc)]['get'](_0x4521f8);if(_0x3ed301)return{'hasTimers':!![],'timersCount':_0x3ed301[_0x55fa2c(0x167)][_0x55fa2c(0x173)],'createdAt':_0x3ed301['createdAt'],'gatewayPaymentId':_0x3ed301[_0x55fa2c(0xb1)]};return{'hasTimers':![]};}async[a57_0x732312(0x19d)](_0x338b79,_0x2118aa){const _0x20a483=a57_0x732312;try{const _0x254ac5=await database_1[_0x20a483(0x107)][_0x20a483(0x150)][_0x20a483(0xcd)]({'where':{'id':_0x338b79},'select':{'gatewaySettings':!![]}});if(!_0x254ac5?.['gatewaySettings'])return console['log']('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x338b79+_0x20a483(0x11c)),0xa;const _0x3a6fd6=JSON[_0x20a483(0x93)](_0x254ac5[_0x20a483(0xab)]);for(const [_0x53e5d7,_0x562730]of Object['entries'](_0x3a6fd6)){if(_0x53e5d7[_0x20a483(0xf0)]()===_0x2118aa[_0x20a483(0xf0)]()){const _0x3e612e=_0x562730[_0x20a483(0x142)]||0xa;return console['log'](_0x20a483(0xb9)+_0x2118aa+_0x20a483(0x132)+_0x338b79+':\x20'+_0x3e612e+'%'),_0x3e612e;}}return console[_0x20a483(0x15e)](_0x20a483(0xca)+_0x2118aa+'\x20in\x20shop\x20'+_0x338b79+',\x20using\x20default\x2010%'),0xa;}catch(_0x2ec4fe){return console['error'](_0x20a483(0xb2)+_0x338b79+_0x20a483(0x19c)+_0x2118aa+':',_0x2ec4fe),0xa;}}}exports[a57_0x732312(0xee)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();