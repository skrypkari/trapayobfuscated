'use strict';const a50_0x29f155=a50_0x3f39;function a50_0x3f0a(){const _0x1b1b1=['\x20updated\x20successfully','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','delete','gatewayPaymentId','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20with\x20status\x20','values','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20',':\x20type=','EXPIRED','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','payment.success','findUnique','\x20found:','default','\x20status\x20unchanged\x20(','cointopay','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','gatewayCommissionRate','381pasget','Payment\x20older\x20than\x20','‚è∞\x20[GLOBAL]\x20Payment\x20','getTime','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','toLowerCase','117824dEGuZn','\x20individual\x20payment\x20timers','\x20expired','\x20->\x20','payment.failed','431060UOyUwB','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20is\x20older\x20than\x20','shopId','getServiceStats','forEach','23204YzmwZT','\x20\x20\x20Amount:\x20','unknown','auto_expire','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','POST','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','./currencyService','checkAllPendingPayments','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','not\x20confirmed','\x20\x20\x20-\x20Status:\x20','\x20details:','amountUSDT','\x20marked\x20as\x20paid\x20at:\x20','stringify','\x20seconds\x20(','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','map','\x20\x20\x20üìç\x20Source:\x20','checkPaymentStatus','floor','/status/','\x20status\x20is\x20',',\x20using\x20default\x20commission\x2010%','telegramBotService','EXPIRY_DAYS','logCoinToPayStatus','\x20current\x20status:\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','FAILED','üßπ\x20[DEBUG]\x20Clearing\x20','currency','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','\x20in\x20shop\x20','failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','length','checkSinglePaymentById','create','update','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','get','coinToPay2Service','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20not\x20found\x20in\x20database','\x20USDT','getDate','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','ü™ô\x20[DEBUG]\x20Creating\x20','./gateways/coinToPay2Service','clearPaymentTimers','gatewaySettings','logWhiteDomainError','__esModule','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','description','commission','15bsOewQ','5\x20minutes','\x20in\x20','üìà\x20[COINTOPAY]\x20Payment\x20',',\x20currentPayments=','1149592sQCicb','\x20\x20\x20-\x20gatewayPaymentId:\x20','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','1438iETdQi','\x20for\x20payment\x20','577506yzNjwC','.\x20Remaining\x20active\x20timers:\x20','paidAt','GLOBAL_CHECK_INTERVAL_MS','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','createdAt','\x20days','./loggerService','‚è∞\x20[GLOBAL]\x20Found\x20','\x20amounts\x20calculated:','logCoinToPayError','toFixed','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','schedule_created','./gateways/coinToPayService','bankDetails','status_check','h),\x20skipping\x20global\x20check','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','timers','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20\x20\x20üìÖ\x20Time:\x20','checkSinglePayment','now','coinToPayStatusService','application/json','schedulePaymentChecks','‚è∞\x20[EXPIRY]\x20Payment\x20','sendPaymentNotification','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','checkExpiredPayments','parse','amount','\x20expired\x20CoinToPay\x20payments','\x20to\x20','\x20not\x20found,\x20clearing\x20timers','üîç\x20[CHECK]\x20Checking\x20','startPeriodicStatusCheck','getGatewayCommission','set','settings','timestamp','CoinToPayService','gatewayOrderId','\x20\x20\x20üìù\x20Details:','created','\x20\x20\x20üìä\x20Status:\x20','customerEmail','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','cointopay2','paymentTimers','sendPaymentStatusNotification','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20initial\x20timers\x20for\x20payment\x20','-day\x20timeout','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20\x20\x20üìù\x20Context:','confirmedOn','‚ùå\x20[HOURLY]\x20Payment\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','Success','\x20has\x20no\x20gatewayPaymentId,\x20skipping','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20has\x20no\x20gatewayPaymentId','PAID','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','orderId','not\x20found','expired','webhookEvents',',\x20stopping\x20individual\x20checks','log','üìä\x20[CHECK]\x20Payment\x20','\x20(age:\x20','CoinToPayStatusService','webhookLog','\x20to\x20clear','coinToPayService','error','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','transactionId','‚úÖ\x20[CHECK]\x20Payment\x20','\x20commission\x20for\x20shop\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20updated:\x20currentPayments=','webhookUrl','\x20not\x20enabled\x20for\x20shop\x20','\x20timers\x20for\x20payment\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20status:\x20','iban','paymentDetails','createdOn','ü™ô\x20[GLOBAL]\x20Found\x20','cointopay_auto_expired','./telegramBotService','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','üí∞\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20paymentId:\x20','paid','loggerService','logShopWebhookError','gateway','\x20\x20\x20-\x20ShopId:\x20','__importDefault','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','currentPayments','payment','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','currencyService','setDate','\x20days,\x20marking\x20as\x20EXPIRED','\x20commission:\x20','toISOString','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','text','paymentLink','\x20payment\x20','entries','checkPaymentById','includes','message','COMPLETED','PENDING','‚úÖ\x20[HOURLY]\x20Payment\x20','globalCheckInterval','cointopay_status_check_','type','üõë\x20[SHUTDOWN]\x20Cleared\x20','COINTOPAY_STATUS_CHANGE','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','status','\x20status\x20changed\x20to\x20',',\x20clearing\x20individual\x20timers','\x20\x20\x20-\x20Amount:\x20','sendShopWebhook','1881882aSaLYf','catch','push','convertToUSDT','\x20\x20\x20Amount\x20after\x20commission:\x20','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20days\x20(created\x20before\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','logShopWebhookSent','\x20status\x20from\x20','size'];a50_0x3f0a=function(){return _0x1b1b1;};return a50_0x3f0a();}(function(_0x536b38,_0x557efb){const _0x11dcc4=a50_0x3f39,_0xe68e6d=_0x536b38();while(!![]){try{const _0x26209c=parseInt(_0x11dcc4(0x25f))/0x1+-parseInt(_0x11dcc4(0x2a5))/0x2*(-parseInt(_0x11dcc4(0x24e))/0x3)+-parseInt(_0x11dcc4(0x254))/0x4*(-parseInt(_0x11dcc4(0x29c))/0x5)+-parseInt(_0x11dcc4(0x2a7))/0x6+parseInt(_0x11dcc4(0x259))/0x7+parseInt(_0x11dcc4(0x2a1))/0x8+-parseInt(_0x11dcc4(0x230))/0x9;if(_0x26209c===_0x557efb)break;else _0xe68e6d['push'](_0xe68e6d['shift']());}catch(_0x5ace83){_0xe68e6d['push'](_0xe68e6d['shift']());}}}(a50_0x3f0a,0x1919f));function a50_0x3f39(_0x138811,_0xe43df0){_0x138811=_0x138811-0x1f2;const _0x3f0a42=a50_0x3f0a();let _0x3f3925=_0x3f0a42[_0x138811];return _0x3f3925;}var __importDefault=this&&this[a50_0x29f155(0x20f)]||function(_0x38099e){const _0x4b9444=a50_0x29f155;return _0x38099e&&_0x38099e[_0x4b9444(0x298)]?_0x38099e:{'default':_0x38099e};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a50_0x29f155(0x2c0)]=exports[a50_0x29f155(0x2f3)]=void 0x0;const coinToPayService_1=require(a50_0x29f155(0x2b6)),coinToPay2Service_1=require(a50_0x29f155(0x294)),gateway_1=require('../types/gateway'),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a50_0x29f155(0x205)),loggerService_1=require(a50_0x29f155(0x2af)),currencyService_1=require(a50_0x29f155(0x267));class CoinToPayStatusService{constructor(){const _0x364906=a50_0x29f155;this[_0x364906(0x224)]=null,this[_0x364906(0x2aa)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x364906(0x2da)]=new Map(),this[_0x364906(0x1f3)]=new coinToPayService_1[(_0x364906(0x2d2))](),this[_0x364906(0x28d)]=new coinToPay2Service_1['CoinToPay2Service'](),console[_0x364906(0x2f0)](_0x364906(0x2df));}[a50_0x29f155(0x2c2)](_0x36cb01,_0x3ac77b){const _0x164fe1=a50_0x29f155;console[_0x164fe1(0x2f0)]('ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console['log'](_0x164fe1(0x209)+_0x36cb01),console[_0x164fe1(0x2f0)](_0x164fe1(0x2a2)+_0x3ac77b),this[_0x164fe1(0x295)](_0x36cb01);const _0x2b1f59=[],_0x1da50a=new Date(),_0xee94f7=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x164fe1(0x29d)},{'delay':0x5*0x3c*0x3e8,'description':_0x164fe1(0x29d)}];console[_0x164fe1(0x2f0)](_0x164fe1(0x293)+_0xee94f7[_0x164fe1(0x287)]+_0x164fe1(0x2dd)+_0x36cb01);let _0x4df708=0x0;_0xee94f7['forEach']((_0x55666b,_0x389d55)=>{const _0x23ceba=_0x164fe1;_0x4df708+=_0x55666b['delay'];const _0x1d7373=setTimeout(async()=>{const _0x1b5a5f=a50_0x3f39;console[_0x1b5a5f(0x2f0)](_0x1b5a5f(0x213)+(_0x389d55+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x36cb01+'\x20(after\x20'+_0x55666b['description']+')');try{await this[_0x1b5a5f(0x288)](_0x36cb01),console[_0x1b5a5f(0x2f0)](_0x1b5a5f(0x219)+(_0x389d55+0x1)+'\x20completed\x20for\x20payment\x20'+_0x36cb01);}catch(_0x535445){console[_0x1b5a5f(0x1f4)](_0x1b5a5f(0x22a)+(_0x389d55+0x1)+_0x1b5a5f(0x2a6)+_0x36cb01+':',_0x535445),this[_0x1b5a5f(0x2b2)](_0x36cb01,_0x3ac77b,_0x535445,'status_check',{'checkNumber':_0x389d55+0x1,'scheduledAfter':_0x55666b['description'],'isIndividualCheck':!![]});}},_0x4df708);_0x2b1f59[_0x23ceba(0x232)](_0x1d7373),console[_0x23ceba(0x2f0)](_0x23ceba(0x235)+(_0x389d55+0x1)+_0x23ceba(0x2a6)+_0x36cb01+_0x23ceba(0x29e)+_0x4df708/0x3e8+_0x23ceba(0x272)+_0x55666b[_0x23ceba(0x29a)]+')');});const _0x569788=setInterval(async()=>{const _0x43f4c4=_0x164fe1;console[_0x43f4c4(0x2f0)](_0x43f4c4(0x210)+_0x36cb01);try{const _0x3df156=await database_1['default'][_0x43f4c4(0x212)]['findUnique']({'where':{'id':_0x36cb01},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x3df156){console[_0x43f4c4(0x2f0)](_0x43f4c4(0x2e3)+_0x36cb01+_0x43f4c4(0x2cb)),this[_0x43f4c4(0x295)](_0x36cb01);return;}console[_0x43f4c4(0x2f0)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x36cb01+_0x43f4c4(0x27e)+_0x3df156['status']);if(_0x3df156['status']!==_0x43f4c4(0x222)){console[_0x43f4c4(0x2f0)](_0x43f4c4(0x223)+_0x36cb01+_0x43f4c4(0x279)+_0x3df156[_0x43f4c4(0x22b)]+_0x43f4c4(0x2ef)),this[_0x43f4c4(0x295)](_0x36cb01);return;}const _0x512fb7=Math['floor']((Date['now']()-_0x3df156[_0x43f4c4(0x2ad)][_0x43f4c4(0x251)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x512fb7>=this[_0x43f4c4(0x27c)]){console[_0x43f4c4(0x2f0)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x36cb01+_0x43f4c4(0x25b)+this['EXPIRY_DAYS']+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x43f4c4(0x295)](_0x36cb01);return;}await this[_0x43f4c4(0x288)](_0x36cb01),console[_0x43f4c4(0x2f0)](_0x43f4c4(0x206)+_0x36cb01);}catch(_0x125dd4){console['error'](_0x43f4c4(0x2ac)+_0x36cb01+':',_0x125dd4),this[_0x43f4c4(0x2b2)](_0x36cb01,_0x3ac77b,_0x125dd4,_0x43f4c4(0x2b8),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x2b1f59[_0x164fe1(0x232)](_0x569788),this[_0x164fe1(0x2da)][_0x164fe1(0x2cf)](_0x36cb01,{'timers':_0x2b1f59,'paymentId':_0x36cb01,'gatewayPaymentId':_0x3ac77b,'createdAt':_0x1da50a}),console['log'](_0x164fe1(0x2c5)+_0xee94f7[_0x164fe1(0x287)]+_0x164fe1(0x245)+_0x36cb01),console[_0x164fe1(0x2f0)]('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x164fe1(0x2da)][_0x164fe1(0x23a)]),this[_0x164fe1(0x27d)](_0x36cb01,_0x3ac77b,_0x164fe1(0x222),_0x164fe1(0x222),_0x164fe1(0x2b8),{'action':_0x164fe1(0x2b5),'scheduledChecks':_0xee94f7[_0x164fe1(0x287)],'firstCheckIn':_0xee94f7[0x0]['delay']/0x3e8,'totalTimers':this[_0x164fe1(0x2da)][_0x164fe1(0x23a)]});}[a50_0x29f155(0x295)](_0x39b8c2){const _0x1c4850=a50_0x29f155,_0x73b515=this[_0x1c4850(0x2da)]['get'](_0x39b8c2);_0x73b515?(console[_0x1c4850(0x2f0)](_0x1c4850(0x281)+_0x73b515[_0x1c4850(0x2bb)][_0x1c4850(0x287)]+_0x1c4850(0x1fd)+_0x39b8c2),_0x73b515['timers'][_0x1c4850(0x25e)]((_0x236386,_0x1ffde7)=>{const _0x3d3465=_0x1c4850;_0x236386&&(clearTimeout(_0x236386),clearInterval(_0x236386),console['log'](_0x3d3465(0x26b)+(_0x1ffde7+0x1)+_0x3d3465(0x2a6)+_0x39b8c2));}),this[_0x1c4850(0x2da)][_0x1c4850(0x23d)](_0x39b8c2),console[_0x1c4850(0x2f0)]('‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x39b8c2+_0x1c4850(0x2a8)+this[_0x1c4850(0x2da)][_0x1c4850(0x23a)])):console[_0x1c4850(0x2f0)](_0x1c4850(0x2dc)+_0x39b8c2+_0x1c4850(0x1f2));}async[a50_0x29f155(0x288)](_0x12f0a3){const _0x12783b=a50_0x29f155;console[_0x12783b(0x2f0)](_0x12783b(0x242)+_0x12f0a3);const _0x1ca2b1=await database_1['default'][_0x12783b(0x212)][_0x12783b(0x247)]({'where':{'id':_0x12f0a3},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1ca2b1){console['log']('‚ùå\x20[CHECK]\x20Payment\x20'+_0x12f0a3+_0x12783b(0x28f));return;}console[_0x12783b(0x2f0)]('üìä\x20[CHECK]\x20Payment\x20'+_0x12f0a3+_0x12783b(0x248)),console[_0x12783b(0x2f0)]('\x20\x20\x20-\x20Gateway:\x20'+_0x1ca2b1[_0x12783b(0x20d)]),console[_0x12783b(0x2f0)](_0x12783b(0x26d)+_0x1ca2b1[_0x12783b(0x22b)]),console[_0x12783b(0x2f0)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x1ca2b1[_0x12783b(0x23e)]),console[_0x12783b(0x2f0)](_0x12783b(0x22e)+_0x1ca2b1[_0x12783b(0x2c8)]+'\x20'+_0x1ca2b1[_0x12783b(0x282)]),console[_0x12783b(0x2f0)](_0x12783b(0x20e)+_0x1ca2b1[_0x12783b(0x25c)]);if(_0x1ca2b1[_0x12783b(0x20d)]!==_0x12783b(0x24b)&&_0x1ca2b1['gateway']!==_0x12783b(0x2d9)){console['log'](_0x12783b(0x299)+_0x12f0a3+_0x12783b(0x2ea)+_0x1ca2b1[_0x12783b(0x20d)]+')');return;}if(_0x1ca2b1[_0x12783b(0x22b)]!==_0x12783b(0x222)){console[_0x12783b(0x2f0)](_0x12783b(0x299)+_0x12f0a3+'\x20status\x20is\x20'+_0x1ca2b1['status']+',\x20stopping\x20individual\x20checks'),this[_0x12783b(0x295)](_0x12f0a3);return;}if(!_0x1ca2b1[_0x12783b(0x23e)]){console[_0x12783b(0x2f0)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x12f0a3+_0x12783b(0x2e8));return;}console[_0x12783b(0x2f0)](_0x12783b(0x1f7)+_0x12f0a3+_0x12783b(0x1f9)),await this[_0x12783b(0x2be)](_0x1ca2b1);}['logCoinToPayStatus'](_0x59067e,_0x56d36e,_0x5bd6eb,_0x47498b,_0x34e15d,_0x2b083d){const _0x40e7bc=a50_0x29f155,_0x2aba16={'type':_0x40e7bc(0x228),'paymentId':_0x59067e,'gatewayPaymentId':_0x56d36e,'oldStatus':_0x5bd6eb,'newStatus':_0x47498b,'source':_0x34e15d,'timestamp':new Date()[_0x40e7bc(0x218)](),'details':_0x2b083d||{}};loggerService_1[_0x40e7bc(0x20b)][_0x40e7bc(0x27d)](_0x2aba16),console[_0x40e7bc(0x2f0)](_0x40e7bc(0x237)+_0x59067e+'\x20('+_0x56d36e+')'),console['log'](_0x40e7bc(0x2d6)+_0x5bd6eb+_0x40e7bc(0x257)+_0x47498b),console[_0x40e7bc(0x2f0)](_0x40e7bc(0x275)+_0x34e15d),console[_0x40e7bc(0x2f0)](_0x40e7bc(0x2bd)+_0x2aba16[_0x40e7bc(0x2d1)]),_0x2b083d&&console[_0x40e7bc(0x2f0)](_0x40e7bc(0x2d4),_0x2b083d);}['logCoinToPayError'](_0x3d0727,_0xba2894,_0x4b1289,_0x177f95,_0x34ceef){const _0x129969=a50_0x29f155,_0x4d57c5={'type':'COINTOPAY_ERROR','paymentId':_0x3d0727,'gatewayPaymentId':_0xba2894,'error':_0x4b1289 instanceof Error?{'message':_0x4b1289[_0x129969(0x220)],'stack':_0x4b1289['stack']}:_0x4b1289,'source':_0x177f95,'timestamp':new Date()[_0x129969(0x218)](),'context':_0x34ceef||{}};loggerService_1[_0x129969(0x20b)][_0x129969(0x2b2)](_0x4d57c5),console[_0x129969(0x1f4)](_0x129969(0x23f)+_0x3d0727+'\x20('+_0xba2894+')'),console[_0x129969(0x1f4)]('\x20\x20\x20‚ùå\x20Error:\x20'+(_0x4b1289 instanceof Error?_0x4b1289[_0x129969(0x220)]:_0x4b1289)),console[_0x129969(0x1f4)]('\x20\x20\x20üìç\x20Source:\x20'+_0x177f95),console['error']('\x20\x20\x20üìÖ\x20Time:\x20'+_0x4d57c5[_0x129969(0x2d1)]),_0x34ceef&&console[_0x129969(0x1f4)](_0x129969(0x2e1),_0x34ceef);}[a50_0x29f155(0x2cd)](){const _0x599eb8=a50_0x29f155;console[_0x599eb8(0x2f0)](_0x599eb8(0x23c)),this[_0x599eb8(0x268)]()[_0x599eb8(0x231)](_0x220918=>{const _0x1486d0=_0x599eb8;console[_0x1486d0(0x1f4)](_0x1486d0(0x2ba),_0x220918);}),this['globalCheckInterval']=setInterval(async()=>{const _0x340076=_0x599eb8;try{console[_0x340076(0x2f0)](_0x340076(0x28e)),await this[_0x340076(0x268)](),console['log'](_0x340076(0x1f5));}catch(_0x4ba846){console[_0x340076(0x1f4)](_0x340076(0x207),_0x4ba846);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x599eb8(0x2f0)](_0x599eb8(0x27f));}['stopPeriodicStatusCheck'](){const _0x4a3f62=a50_0x29f155;console[_0x4a3f62(0x2f0)](_0x4a3f62(0x265));this[_0x4a3f62(0x224)]&&(clearInterval(this['globalCheckInterval']),this[_0x4a3f62(0x224)]=null,console['log'](_0x4a3f62(0x2e7)));const _0x2f0958=this[_0x4a3f62(0x2da)]['size'];for(const [_0x38465b]of this[_0x4a3f62(0x2da)]){this[_0x4a3f62(0x295)](_0x38465b);}console['log'](_0x4a3f62(0x227)+_0x2f0958+_0x4a3f62(0x255));}async[a50_0x29f155(0x268)](){const _0x1cad9b=a50_0x29f155;try{console[_0x1cad9b(0x2f0)](_0x1cad9b(0x252));const _0x122e01=await database_1[_0x1cad9b(0x249)][_0x1cad9b(0x212)]['findMany']({'where':{'gateway':{'in':[_0x1cad9b(0x24b),_0x1cad9b(0x2d9)]},'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x1cad9b(0x2f0)](_0x1cad9b(0x203)+_0x122e01[_0x1cad9b(0x287)]+'\x20pending\x20CoinToPay\x20payments');if(_0x122e01[_0x1cad9b(0x287)]===0x0){console[_0x1cad9b(0x2f0)](_0x1cad9b(0x24c));return;}const _0x41fbf1=await this['checkExpiredPayments'](_0x122e01);console[_0x1cad9b(0x2f0)](_0x1cad9b(0x2b0)+_0x41fbf1[_0x1cad9b(0x287)]+_0x1cad9b(0x2c9));let _0xdf0bb1=0x0,_0x418499=0x0;for(const _0x54ffc7 of _0x122e01){try{if(_0x41fbf1[_0x1cad9b(0x21f)](_0x54ffc7['id'])){console[_0x1cad9b(0x2f0)](_0x1cad9b(0x250)+_0x54ffc7['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x418499++;continue;}if(this[_0x1cad9b(0x2da)]['has'](_0x54ffc7['id'])){console[_0x1cad9b(0x2f0)](_0x1cad9b(0x250)+_0x54ffc7['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x418499++;continue;}const _0x3a628a=(Date[_0x1cad9b(0x2bf)]()-_0x54ffc7['createdAt']['getTime']())/(0x3e8*0x3c*0x3c);if(_0x3a628a<0x1){console['log'](_0x1cad9b(0x250)+_0x54ffc7['id']+'\x20is\x20too\x20new\x20('+_0x3a628a[_0x1cad9b(0x2b3)](0x1)+_0x1cad9b(0x2b9)),_0x418499++;continue;}console[_0x1cad9b(0x2f0)](_0x1cad9b(0x266)+_0x54ffc7['id']+_0x1cad9b(0x2f2)+_0x3a628a[_0x1cad9b(0x2b3)](0x1)+'h)'),await this[_0x1cad9b(0x2be)](_0x54ffc7),_0xdf0bb1++,await new Promise(_0x59c7e6=>setTimeout(_0x59c7e6,0x7d0));}catch(_0x183ecf){console[_0x1cad9b(0x1f4)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x54ffc7['id']+':',_0x183ecf),this['logCoinToPayError'](_0x54ffc7['id'],_0x54ffc7[_0x1cad9b(0x23e)]||_0x1cad9b(0x261),_0x183ecf,_0x1cad9b(0x2b8),{'isGlobalCheck':!![],'paymentAmount':_0x54ffc7['amount'],'paymentCurrency':_0x54ffc7[_0x1cad9b(0x282)],'shopId':_0x54ffc7['shopId'],'createdAt':_0x54ffc7[_0x1cad9b(0x2ad)]}),loggerService_1[_0x1cad9b(0x20b)][_0x1cad9b(0x297)]('cointopay',_0x1cad9b(0x278)+_0x54ffc7['gatewayPaymentId'],_0x183ecf);}}console[_0x1cad9b(0x2f0)](_0x1cad9b(0x1fe)+_0xdf0bb1+'\x20checked,\x20'+_0x418499+'\x20skipped,\x20'+_0x41fbf1[_0x1cad9b(0x287)]+_0x1cad9b(0x256));}catch(_0x561df1){console[_0x1cad9b(0x1f4)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x561df1);}}async[a50_0x29f155(0x2c6)](_0x9f8460){const _0x128cbd=a50_0x29f155,_0x294304=[],_0x27cfa9=new Date();_0x27cfa9[_0x128cbd(0x215)](_0x27cfa9[_0x128cbd(0x291)]()-this[_0x128cbd(0x27c)]),console['log'](_0x128cbd(0x263)+this[_0x128cbd(0x27c)]+_0x128cbd(0x236)+_0x27cfa9[_0x128cbd(0x218)]()+')');for(const _0x56f0af of _0x9f8460){if(_0x56f0af[_0x128cbd(0x2ad)]<_0x27cfa9){console[_0x128cbd(0x2f0)](_0x128cbd(0x2c3)+_0x56f0af['id']+'\x20is\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x128cbd(0x216));try{this['logCoinToPayStatus'](_0x56f0af['id'],_0x56f0af[_0x128cbd(0x23e)]||_0x128cbd(0x261),_0x128cbd(0x222),_0x128cbd(0x244),_0x128cbd(0x262),{'reason':_0x128cbd(0x24f)+this[_0x128cbd(0x27c)]+_0x128cbd(0x2ae),'createdAt':_0x56f0af[_0x128cbd(0x2ad)],'daysSinceCreation':Math[_0x128cbd(0x277)]((Date['now']()-_0x56f0af[_0x128cbd(0x2ad)][_0x128cbd(0x251)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x56f0af[_0x128cbd(0x2c8)],'paymentCurrency':_0x56f0af[_0x128cbd(0x282)],'shopId':_0x56f0af[_0x128cbd(0x25c)]}),await database_1[_0x128cbd(0x249)][_0x128cbd(0x212)][_0x128cbd(0x28a)]({'where':{'id':_0x56f0af['id']},'data':{'status':_0x128cbd(0x244),'updatedAt':new Date()}}),await database_1[_0x128cbd(0x249)][_0x128cbd(0x2f4)][_0x128cbd(0x289)]({'data':{'paymentId':_0x56f0af['id'],'shopId':_0x56f0af[_0x128cbd(0x25c)],'event':_0x128cbd(0x204),'statusCode':0xc8,'responseBody':JSON[_0x128cbd(0x271)]({'reason':'Payment\x20older\x20than\x20'+this[_0x128cbd(0x27c)]+'\x20days','createdAt':_0x56f0af['createdAt'],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x128cbd(0x277)]((Date[_0x128cbd(0x2bf)]()-_0x56f0af['createdAt'][_0x128cbd(0x251)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x128cbd(0x22f)](_0x56f0af,_0x128cbd(0x244)),await this[_0x128cbd(0x2db)](_0x56f0af,_0x128cbd(0x244)),this[_0x128cbd(0x295)](_0x56f0af['id']),_0x294304[_0x128cbd(0x232)](_0x56f0af['id']),console[_0x128cbd(0x2f0)]('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x56f0af['id']+_0x128cbd(0x28b)+this[_0x128cbd(0x27c)]+_0x128cbd(0x2de));}catch(_0x180b11){console[_0x128cbd(0x1f4)](_0x128cbd(0x273)+_0x56f0af['id']+':',_0x180b11),this['logCoinToPayError'](_0x56f0af['id'],_0x56f0af['gatewayPaymentId']||_0x128cbd(0x261),_0x180b11,_0x128cbd(0x262),{'reason':_0x128cbd(0x2e0),'createdAt':_0x56f0af[_0x128cbd(0x2ad)],'daysSinceCreation':Math[_0x128cbd(0x277)]((Date['now']()-_0x56f0af[_0x128cbd(0x2ad)][_0x128cbd(0x251)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x294304;}async['checkSinglePayment'](_0x233c88){const _0x1ddefd=a50_0x29f155;if(!_0x233c88[_0x1ddefd(0x23e)]){console['log'](_0x1ddefd(0x299)+_0x233c88['id']+_0x1ddefd(0x2e6));return;}console[_0x1ddefd(0x2f0)](_0x1ddefd(0x2cc)+_0x233c88[_0x1ddefd(0x20d)]+_0x1ddefd(0x21c)+_0x233c88['id']+'\x20('+_0x233c88[_0x1ddefd(0x23e)]+')');try{let _0x2b2a34;_0x233c88[_0x1ddefd(0x20d)]===_0x1ddefd(0x2d9)?(_0x2b2a34=await this[_0x1ddefd(0x28d)]['checkPaymentStatus'](_0x233c88['gatewayPaymentId']),console[_0x1ddefd(0x2f0)](_0x1ddefd(0x2a4)+_0x233c88['id']+_0x1ddefd(0x1ff)+_0x2b2a34['status'])):(_0x2b2a34=await this[_0x1ddefd(0x1f3)][_0x1ddefd(0x276)](_0x233c88[_0x1ddefd(0x23e)]),console[_0x1ddefd(0x2f0)](_0x1ddefd(0x2bc)+_0x233c88['id']+'\x20status:\x20'+_0x2b2a34[_0x1ddefd(0x22b)]));_0x2b2a34[_0x1ddefd(0x201)]&&console['log'](_0x1ddefd(0x2f1)+_0x233c88['id']+_0x1ddefd(0x26e),{'iban':_0x2b2a34[_0x1ddefd(0x201)][_0x1ddefd(0x200)]||_0x1ddefd(0x2ec),'transactionId':_0x2b2a34['paymentDetails'][_0x1ddefd(0x1f6)],'createdOn':_0x2b2a34[_0x1ddefd(0x201)][_0x1ddefd(0x202)],'confirmedOn':_0x2b2a34[_0x1ddefd(0x201)][_0x1ddefd(0x2e2)]||_0x1ddefd(0x26c)});if(_0x2b2a34[_0x1ddefd(0x22b)]!==_0x233c88[_0x1ddefd(0x22b)]){console[_0x1ddefd(0x2f0)]('üîÑ\x20[CHECK]\x20Updating\x20payment\x20'+_0x233c88['id']+_0x1ddefd(0x239)+_0x233c88[_0x1ddefd(0x22b)]+_0x1ddefd(0x2ca)+_0x2b2a34[_0x1ddefd(0x22b)]),this[_0x1ddefd(0x27d)](_0x233c88['id'],_0x233c88['gatewayPaymentId'],_0x233c88[_0x1ddefd(0x22b)],_0x2b2a34[_0x1ddefd(0x22b)],_0x1ddefd(0x2b8),{'paymentDetails':_0x2b2a34[_0x1ddefd(0x201)],'amount':_0x2b2a34[_0x1ddefd(0x2c8)],'currency':_0x2b2a34[_0x1ddefd(0x282)],'shopId':_0x233c88['shopId'],'checkTimestamp':new Date()['toISOString']()});const _0x120c8d={'status':_0x2b2a34['status'],'updatedAt':new Date()};if(_0x2b2a34[_0x1ddefd(0x22b)]===_0x1ddefd(0x2e9)&&_0x233c88[_0x1ddefd(0x22b)]!==_0x1ddefd(0x2e9)){_0x120c8d[_0x1ddefd(0x2a9)]=new Date();if(!_0x233c88[_0x1ddefd(0x26f)]){const _0x363250=await currencyService_1[_0x1ddefd(0x214)][_0x1ddefd(0x233)](_0x233c88[_0x1ddefd(0x2c8)],_0x233c88[_0x1ddefd(0x282)]);_0x120c8d[_0x1ddefd(0x26f)]=_0x363250;const _0x51c5cf=await this[_0x1ddefd(0x2ce)](_0x233c88[_0x1ddefd(0x25c)],_0x233c88[_0x1ddefd(0x20d)]),_0x5a1be4=_0x363250*(0x1-_0x51c5cf/0x64);_0x120c8d['amountAfterGatewayCommissionUSDT']=_0x5a1be4,_0x120c8d[_0x1ddefd(0x24d)]=_0x51c5cf,console['log'](_0x1ddefd(0x208)+_0x233c88['id']+_0x1ddefd(0x2b1)),console[_0x1ddefd(0x2f0)](_0x1ddefd(0x260)+_0x233c88[_0x1ddefd(0x2c8)]+'\x20'+_0x233c88[_0x1ddefd(0x282)]+_0x1ddefd(0x257)+_0x363250[_0x1ddefd(0x2b3)](0x6)+_0x1ddefd(0x290)),console['log']('\x20\x20\x20Gateway\x20'+_0x233c88[_0x1ddefd(0x20d)]+_0x1ddefd(0x217)+_0x51c5cf+'%'),console['log'](_0x1ddefd(0x234)+_0x5a1be4[_0x1ddefd(0x2b3)](0x6)+_0x1ddefd(0x290));}console[_0x1ddefd(0x2f0)](_0x1ddefd(0x208)+_0x233c88['id']+_0x1ddefd(0x270)+_0x120c8d[_0x1ddefd(0x2a9)][_0x1ddefd(0x218)]());}if(_0x2b2a34[_0x1ddefd(0x201)]){const _0x4be0c9=_0x2b2a34['paymentDetails'];_0x4be0c9[_0x1ddefd(0x200)]&&(_0x120c8d['remitterIban']=_0x4be0c9['iban'],console[_0x1ddefd(0x2f0)](_0x1ddefd(0x26a)+_0x4be0c9[_0x1ddefd(0x200)])),_0x4be0c9['bankDetails']&&console['log']('üè¶\x20[CHECK]\x20Bank\x20details\x20provided:\x20'+_0x4be0c9[_0x1ddefd(0x2b7)]),_0x4be0c9[_0x1ddefd(0x1f6)]&&console['log'](_0x1ddefd(0x283)+_0x4be0c9[_0x1ddefd(0x1f6)]),_0x4be0c9[_0x1ddefd(0x2e2)]&&console['log'](_0x1ddefd(0x2ab)+_0x4be0c9[_0x1ddefd(0x2e2)]);}await database_1[_0x1ddefd(0x249)]['payment'][_0x1ddefd(0x28a)]({'where':{'id':_0x233c88['id']},'data':_0x120c8d});if(_0x2b2a34[_0x1ddefd(0x22b)]===_0x1ddefd(0x2e9)&&_0x233c88['status']!==_0x1ddefd(0x2e9)){console[_0x1ddefd(0x2f0)](_0x1ddefd(0x29f)+_0x233c88['id']+_0x1ddefd(0x229));const _0x5a3877=await database_1[_0x1ddefd(0x249)][_0x1ddefd(0x212)][_0x1ddefd(0x247)]({'where':{'id':_0x233c88['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x5a3877?.['paymentLinkId']&&_0x5a3877[_0x1ddefd(0x21b)])try{const _0x395168=_0x5a3877[_0x1ddefd(0x21b)];console[_0x1ddefd(0x2f0)]('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x395168['id']+_0x1ddefd(0x243)+_0x395168[_0x1ddefd(0x226)]+_0x1ddefd(0x2a0)+_0x395168[_0x1ddefd(0x211)]+',\x20status='+_0x395168['status']);const _0x106cdf=_0x395168[_0x1ddefd(0x211)]+0x1,_0x553347=_0x395168['type']==='SINGLE'?_0x1ddefd(0x221):_0x395168[_0x1ddefd(0x22b)];await database_1[_0x1ddefd(0x249)][_0x1ddefd(0x21b)][_0x1ddefd(0x28a)]({'where':{'id':_0x395168['id']},'data':{'currentPayments':_0x106cdf,'status':_0x553347,'updatedAt':new Date()}}),console['log'](_0x1ddefd(0x2d8)+_0x395168['id']+_0x1ddefd(0x1fa)+_0x395168[_0x1ddefd(0x211)]+_0x1ddefd(0x257)+_0x106cdf+',\x20status='+_0x395168[_0x1ddefd(0x22b)]+_0x1ddefd(0x257)+_0x553347);}catch(_0x1653dc){console['error']('‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:',_0x1653dc);}else console[_0x1ddefd(0x2f0)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x233c88['id']+_0x1ddefd(0x292));}await database_1[_0x1ddefd(0x249)]['webhookLog']['create']({'data':{'paymentId':_0x233c88['id'],'shopId':_0x233c88[_0x1ddefd(0x25c)],'event':_0x1ddefd(0x225)+_0x2b2a34['status'][_0x1ddefd(0x253)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x233c88[_0x1ddefd(0x22b)],'newStatus':_0x2b2a34[_0x1ddefd(0x22b)],'paymentDetails':_0x2b2a34[_0x1ddefd(0x201)],'checkedAt':new Date()[_0x1ddefd(0x218)]()})}}),await this[_0x1ddefd(0x22f)](_0x233c88,_0x2b2a34['status']),await this[_0x1ddefd(0x2db)](_0x233c88,_0x2b2a34['status']),_0x2b2a34[_0x1ddefd(0x22b)]!==_0x1ddefd(0x222)&&(console['log']('üßπ\x20[CHECK]\x20Payment\x20'+_0x233c88['id']+_0x1ddefd(0x22c)+_0x2b2a34[_0x1ddefd(0x22b)]+_0x1ddefd(0x22d)),this['clearPaymentTimers'](_0x233c88['id'])),console[_0x1ddefd(0x2f0)]('‚úÖ\x20[CHECK]\x20Payment\x20'+_0x233c88['id']+_0x1ddefd(0x23b));}else console[_0x1ddefd(0x2f0)](_0x1ddefd(0x2f1)+_0x233c88['id']+_0x1ddefd(0x24a)+_0x2b2a34[_0x1ddefd(0x22b)]+')'),this[_0x1ddefd(0x27d)](_0x233c88['id'],_0x233c88['gatewayPaymentId'],_0x233c88[_0x1ddefd(0x22b)],_0x2b2a34[_0x1ddefd(0x22b)],_0x1ddefd(0x2b8),{'statusUnchanged':!![],'paymentDetails':_0x2b2a34['paymentDetails'],'amount':_0x2b2a34[_0x1ddefd(0x2c8)],'currency':_0x2b2a34[_0x1ddefd(0x282)],'shopId':_0x233c88['shopId'],'checkTimestamp':new Date()[_0x1ddefd(0x218)]()});}catch(_0x2957af){console[_0x1ddefd(0x1f4)]('‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x233c88['id']+':',_0x2957af),this[_0x1ddefd(0x2b2)](_0x233c88['id'],_0x233c88[_0x1ddefd(0x23e)],_0x2957af,_0x1ddefd(0x2b8),{'paymentAmount':_0x233c88[_0x1ddefd(0x2c8)],'paymentCurrency':_0x233c88[_0x1ddefd(0x282)],'shopId':_0x233c88[_0x1ddefd(0x25c)],'createdAt':_0x233c88[_0x1ddefd(0x2ad)]}),await database_1[_0x1ddefd(0x249)][_0x1ddefd(0x2f4)][_0x1ddefd(0x289)]({'data':{'paymentId':_0x233c88['id'],'shopId':_0x233c88[_0x1ddefd(0x25c)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x1ddefd(0x271)]({'error':_0x2957af instanceof Error?_0x2957af['message']:'Unknown\x20error','gatewayPaymentId':_0x233c88[_0x1ddefd(0x23e)],'checkedAt':new Date()[_0x1ddefd(0x218)]()})}});}}async['sendShopWebhook'](_0x1e2415,_0x2c80b2){const _0x39732c=a50_0x29f155,_0xdfe184=Date[_0x39732c(0x2bf)]();try{const _0x35e7c3=_0x1e2415['shop'],_0x389f2d=_0x35e7c3[_0x39732c(0x2d0)];if(!_0x389f2d?.[_0x39732c(0x1fb)]){console[_0x39732c(0x2f0)](_0x39732c(0x269)+_0x35e7c3['id']);return;}const _0xb89950=_0x2c80b2===_0x39732c(0x2e9)?_0x39732c(0x246):_0x2c80b2===_0x39732c(0x280)?'payment.failed':_0x2c80b2==='EXPIRED'?_0x39732c(0x258):'payment.pending';if(!_0x389f2d[_0x39732c(0x2ee)]?.['includes'](_0xb89950)){console[_0x39732c(0x2f0)]('Webhook\x20event\x20'+_0xb89950+_0x39732c(0x1fc)+_0x35e7c3['id']);return;}const _0x597255=(0x0,gateway_1['getGatewayIdByName'])(_0x1e2415[_0x39732c(0x20d)])||_0x1e2415[_0x39732c(0x20d)],_0x2a3395={'event':_0xb89950,'payment':{'id':_0x1e2415['id'],'order_id':_0x1e2415[_0x39732c(0x2eb)],'gateway_order_id':_0x1e2415[_0x39732c(0x2d3)],'gateway':_0x597255,'amount':_0x1e2415['amount'],'currency':_0x1e2415[_0x39732c(0x282)],'status':_0x2c80b2[_0x39732c(0x253)](),'customer_email':_0x1e2415[_0x39732c(0x2d7)],'customer_name':_0x1e2415['customerName'],'created_at':_0x1e2415[_0x39732c(0x2ad)],'updated_at':new Date()}},_0xb0e3a4=await fetch(_0x389f2d[_0x39732c(0x1fb)],{'method':_0x39732c(0x264),'headers':{'Content-Type':_0x39732c(0x2c1),'User-Agent':'Payment\x20System/1.0'},'body':JSON['stringify'](_0x2a3395)}),_0x25747b=Date['now']()-_0xdfe184,_0x2129c4=_0xb0e3a4['ok']?_0x39732c(0x2e5):await _0xb0e3a4[_0x39732c(0x21a)]();loggerService_1[_0x39732c(0x20b)][_0x39732c(0x238)](_0x1e2415[_0x39732c(0x25c)],_0x389f2d[_0x39732c(0x1fb)],_0xb89950,_0xb0e3a4[_0x39732c(0x22b)],_0x25747b,_0x2a3395),console[_0x39732c(0x2f0)]('Shop\x20webhook\x20sent\x20to\x20'+_0x389f2d[_0x39732c(0x1fb)]+_0x39732c(0x240)+_0xb0e3a4[_0x39732c(0x22b)]+'\x20('+_0x25747b+'ms)');}catch(_0x4ec5df){console[_0x39732c(0x1f4)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x4ec5df),loggerService_1[_0x39732c(0x20b)][_0x39732c(0x20c)](_0x1e2415['shopId'],_0x1e2415['shop']?.['settings']?.['webhookUrl']||_0x39732c(0x261),'webhook_send',_0x4ec5df,{});}}async['sendPaymentStatusNotification'](_0x54a7e1,_0x44ea42){const _0x56dee6=a50_0x29f155;try{const _0x429be8={'PENDING':_0x56dee6(0x2d5),'PAID':_0x56dee6(0x20a),'FAILED':_0x56dee6(0x285),'EXPIRED':_0x56dee6(0x2ed)},_0x95dc3f=_0x429be8[_0x44ea42];if(!_0x95dc3f||_0x95dc3f===_0x56dee6(0x2d5))return;await telegramBotService_1[_0x56dee6(0x27b)][_0x56dee6(0x2c4)](_0x54a7e1[_0x56dee6(0x25c)],_0x54a7e1,_0x95dc3f);}catch(_0x33286c){console[_0x56dee6(0x1f4)](_0x56dee6(0x286),_0x33286c);}}async[a50_0x29f155(0x21e)](_0x1afea7){const _0x412de5=a50_0x29f155;console[_0x412de5(0x2f0)](_0x412de5(0x2a3)+_0x1afea7);const _0x133858=await database_1[_0x412de5(0x249)][_0x412de5(0x212)][_0x412de5(0x247)]({'where':{'id':_0x1afea7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x133858)throw new Error('Payment\x20not\x20found');if(_0x133858[_0x412de5(0x20d)]!==_0x412de5(0x24b)&&_0x133858[_0x412de5(0x20d)]!=='cointopay2')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console['log'](_0x412de5(0x2b4)+_0x133858[_0x412de5(0x20d)]+_0x412de5(0x21c)+_0x1afea7),await this[_0x412de5(0x2be)](_0x133858),console[_0x412de5(0x2f0)](_0x412de5(0x25a)+_0x1afea7);}[a50_0x29f155(0x25d)](){const _0x58c746=a50_0x29f155,_0x4597d6=this['globalCheckInterval']?this[_0x58c746(0x2aa)]:undefined,_0x4c9707=Array['from'](this[_0x58c746(0x2da)][_0x58c746(0x241)]())[_0x58c746(0x274)](_0x5f216f=>({'paymentId':_0x5f216f['paymentId'],'gatewayPaymentId':_0x5f216f[_0x58c746(0x23e)],'createdAt':_0x5f216f['createdAt'],'timersCount':_0x5f216f[_0x58c746(0x2bb)][_0x58c746(0x287)]}));return{'isActive':!!this[_0x58c746(0x224)],'globalCheckIntervalMinutes':this[_0x58c746(0x2aa)]/(0x3e8*0x3c),'expiryDays':this[_0x58c746(0x27c)],'activeIndividualTimers':this['paymentTimers']['size'],'nextGlobalCheckIn':_0x4597d6,'paymentTimersDetails':_0x4c9707};}['getPaymentTimerInfo'](_0x550d1e){const _0x5747d5=a50_0x29f155,_0x4a88b0=this[_0x5747d5(0x2da)][_0x5747d5(0x28c)](_0x550d1e);if(_0x4a88b0)return{'hasTimers':!![],'timersCount':_0x4a88b0[_0x5747d5(0x2bb)][_0x5747d5(0x287)],'createdAt':_0x4a88b0[_0x5747d5(0x2ad)],'gatewayPaymentId':_0x4a88b0['gatewayPaymentId']};return{'hasTimers':![]};}async[a50_0x29f155(0x2ce)](_0x1b0a52,_0x5a60a2){const _0x10fd8b=a50_0x29f155;try{const _0x2e0dee=await database_1[_0x10fd8b(0x249)]['shop'][_0x10fd8b(0x247)]({'where':{'id':_0x1b0a52},'select':{'gatewaySettings':!![]}});if(!_0x2e0dee?.[_0x10fd8b(0x296)])return console[_0x10fd8b(0x2f0)]('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x1b0a52+_0x10fd8b(0x27a)),0xa;const _0x3e8c70=JSON[_0x10fd8b(0x2c7)](_0x2e0dee[_0x10fd8b(0x296)]);for(const [_0x149fcc,_0x1637cd]of Object[_0x10fd8b(0x21d)](_0x3e8c70)){if(_0x149fcc[_0x10fd8b(0x253)]()===_0x5a60a2['toLowerCase']()){const _0x2a6c49=_0x1637cd[_0x10fd8b(0x29b)]||0xa;return console[_0x10fd8b(0x2f0)]('Gateway\x20'+_0x5a60a2+_0x10fd8b(0x1f8)+_0x1b0a52+':\x20'+_0x2a6c49+'%'),_0x2a6c49;}}return console[_0x10fd8b(0x2f0)]('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0x5a60a2+_0x10fd8b(0x284)+_0x1b0a52+',\x20using\x20default\x2010%'),0xa;}catch(_0x22ebe6){return console[_0x10fd8b(0x1f4)](_0x10fd8b(0x2e4)+_0x1b0a52+',\x20gateway\x20'+_0x5a60a2+':',_0x22ebe6),0xa;}}}exports[a50_0x29f155(0x2f3)]=CoinToPayStatusService,exports[a50_0x29f155(0x2c0)]=new CoinToPayStatusService();