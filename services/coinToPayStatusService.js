'use strict';const a38_0x2dc3cd=a38_0x47e8;(function(_0x702db,_0x5c1511){const _0x441050=a38_0x47e8,_0x306fe3=_0x702db();while(!![]){try{const _0x203ae0=parseInt(_0x441050(0x23a))/0x1*(-parseInt(_0x441050(0x208))/0x2)+parseInt(_0x441050(0x1ae))/0x3+-parseInt(_0x441050(0x19e))/0x4*(parseInt(_0x441050(0x25c))/0x5)+parseInt(_0x441050(0x17c))/0x6+-parseInt(_0x441050(0x1fb))/0x7+-parseInt(_0x441050(0x22e))/0x8+-parseInt(_0x441050(0x1c2))/0x9*(-parseInt(_0x441050(0x1bb))/0xa);if(_0x203ae0===_0x5c1511)break;else _0x306fe3['push'](_0x306fe3['shift']());}catch(_0x3902f9){_0x306fe3['push'](_0x306fe3['shift']());}}}(a38_0x15ed,0x45573));var __importDefault=this&&this[a38_0x2dc3cd(0x245)]||function(_0x55ec2e){const _0xa116cf=a38_0x2dc3cd;return _0x55ec2e&&_0x55ec2e[_0xa116cf(0x25f)]?_0x55ec2e:{'default':_0x55ec2e};};Object['defineProperty'](exports,a38_0x2dc3cd(0x25f),{'value':!![]}),exports[a38_0x2dc3cd(0x1fd)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require(a38_0x2dc3cd(0x226)),database_1=__importDefault(require(a38_0x2dc3cd(0x1cc))),telegramBotService_1=require(a38_0x2dc3cd(0x1c0)),loggerService_1=require('./loggerService'),currencyService_1=require(a38_0x2dc3cd(0x187));function a38_0x15ed(){const _0x1fc44c=['getServiceStats','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','size','✅\x20[HOURLY]\x20Payment\x20','⏰\x20[GLOBAL]\x20Payment\x20','\x20days\x20(created\x20before\x20','Payment\x20older\x20than\x20','\x20\x20\x20-\x20ShopId:\x20','getPaymentTimerInfo','telegramBotService','amountUSDT','floor','cointopay_auto_expired','checkAllPendingPayments','✅\x20[EXPIRY]\x20Payment\x20','payment.success','forEach','logShopWebhookSent','2157316EavnxW','shopId','coinToPayStatusService','paymentDetails','values','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','globalCheckInterval','customerEmail','\x20amounts\x20calculated:','bankDetails','🪙\x20[GLOBAL]\x20Found\x20','\x20status:\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','14318fXORgq','❌\x20[HOURLY]\x20Payment\x20','5\x20minutes','📈\x20[COINTOPAY]\x20Payment\x20','gatewayPaymentId','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','logShopWebhookError','Bank\x20Details:\x20','EXPIRY_DAYS','🔄\x20[CHECK]\x20Updating\x20payment\x20','findMany','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','sendPaymentStatusNotification',',\x20currentPayments=','-day\x20timeout','🧹\x20[CHECK]\x20Payment\x20','\x20->\x20','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','⚠️\x20[CHECK]\x20Payment\x20','Failed\x20to\x20send\x20shop\x20webhook:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20',',\x20using\x20default\x20commission\x2010%','includes','\x20not\x20found,\x20clearing\x20timers','gateway','\x20\x20\x20📍\x20Source:\x20','toLowerCase','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','../types/gateway','h),\x20skipping\x20global\x20check','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','cointopay_status_check_error','iban','adminNotes','payment','3996608LQVakh','\x20\x20\x20-\x20gatewayPaymentId:\x20','PAID','SINGLE','⏰\x20[GLOBAL]\x20Found\x20','\x20days','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','now','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','length','logCoinToPayStatus','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','79JVrmAe','currentPayments','Automatically\x20expired\x20after\x20','\x20\x20\x20❌\x20Error:\x20','🔍\x20[CHECK]\x20Checking\x20','Shop\x20webhook\x20sent\x20to\x20','CoinToPayStatusService','application/json','schedule_created','coinToPay2Service','\x20timers\x20for\x20payment\x20','__importDefault','amountAfterGatewayCommissionUSDT','\x20to\x20','EXPIRED','📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','amount','map','auto_expire','cointopay','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','✅\x20[CHECK]\x20Payment\x20','\x20details:','getDate','ms)','\x20commission\x20for\x20shop\x20','error','FAILED','sendPaymentNotification','get','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','timers','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','paid','5155XCVIGZ','cointopay_status_check_','status_check','__esModule','entries','message','\x20\x20\x20Amount\x20after\x20commission:\x20','\x20triggered\x20for\x20payment\x20',',\x20using\x20default\x2010%','checkPaymentStatus','\x20updated:\x20currentPayments=','toFixed','cointopay2','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','orderId','confirmedOn','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','has','\x20\x20\x20📊\x20Status:\x20','description','paymentLink','GLOBAL_CHECK_INTERVAL_MS','CoinToPay2Service','💰\x20[CHECK]\x20Payment\x20','toISOString','\x20\x20\x20📅\x20Time:\x20','\x20\x20\x20📝\x20Details:','startPeriodicStatusCheck','\x20pending\x20CoinToPay\x20payments','shop','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20payment\x20','status','set','delete','\x20current\x20status:\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','logCoinToPayError','POST','currencyService','log','gatewaySettings','Gateway\x20','webhookEvents','110922OCMepQ','webhook_send','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20\x20\x20Amount:\x20','checkSinglePaymentById','payment.failed','stringify','Payment\x20not\x20found','⏰\x20[HOURLY]\x20Payment\x20','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20',',\x20clearing\x20individual\x20timers','./currencyService','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','commission','\x20not\x20found\x20in\x20database','createdAt','checkSinglePayment','getGatewayCommission','findUnique','\x20\x20\x20-\x20Gateway:\x20','\x20expired','\x20(age:\x20','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','from','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','customerName','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','webhookUrl','coinToPayService','COMPLETED','create','\x20is\x20too\x20new\x20(','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','1352KJRoIW','currency','COINTOPAY_ERROR','default','Success','PENDING',':\x20type=','sendShopWebhook','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','\x20status\x20unchanged\x20(','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','📊\x20[CHECK]\x20Payment\x20','\x20updated\x20successfully','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','732447OVqVRX','not\x20confirmed','1\x20minute','✅\x20[COINTOPAY]\x20Payment\x20link\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20status\x20is\x20','\x20checked,\x20','expired','schedulePaymentChecks','\x20\x20\x20Gateway\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20is\x20older\x20than\x20','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','17431860LtjHtp','type','transactionId','failed','/status/','./telegramBotService','🪙\x20[DEBUG]\x20Creating\x20','9dNUqfW','getGatewayIdByName','\x20\x20\x20-\x20GatewayPaymentId:\x20','convertToUSDT','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','update',',\x20gateway\x20','paymentTimers','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','📊\x20[HOURLY]\x20Payment\x20','../config/database','timestamp','getTime','\x20completed\x20for\x20payment\x20','webhookLog','paidAt',',\x20stopping\x20individual\x20checks','\x20has\x20no\x20gatewayPaymentId','settings','clearPaymentTimers','Unknown\x20error','push','\x20\x20\x20-\x20Status:\x20','\x20USDT','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20individual\x20payment\x20timers','\x20in\x20','COINTOPAY_STATUS_CHANGE','loggerService','delay','CoinToPayService','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','unknown','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20for\x20payment\x20','\x20\x20\x20-\x20paymentId:\x20'];a38_0x15ed=function(){return _0x1fc44c;};return a38_0x15ed();}function a38_0x47e8(_0x55f2bf,_0xd393f3){const _0x15edeb=a38_0x15ed();return a38_0x47e8=function(_0x47e8ca,_0x4c838e){_0x47e8ca=_0x47e8ca-0x15b;let _0x181fb5=_0x15edeb[_0x47e8ca];return _0x181fb5;},a38_0x47e8(_0x55f2bf,_0xd393f3);}class CoinToPayStatusService{constructor(){const _0x22f6f1=a38_0x2dc3cd;this[_0x22f6f1(0x201)]=null,this[_0x22f6f1(0x165)]=0x3c*0x3c*0x3e8,this[_0x22f6f1(0x210)]=0x5,this[_0x22f6f1(0x1c9)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x22f6f1(0x1e0))](),this[_0x22f6f1(0x243)]=new coinToPay2Service_1[(_0x22f6f1(0x166))](),console[_0x22f6f1(0x178)](_0x22f6f1(0x21b));}[a38_0x2dc3cd(0x1b6)](_0x2ebd60,_0x348b15){const _0xb3dc52=a38_0x2dc3cd;console['log']('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0xb3dc52(0x178)](_0xb3dc52(0x1e6)+_0x2ebd60),console[_0xb3dc52(0x178)](_0xb3dc52(0x22f)+_0x348b15),this[_0xb3dc52(0x1d5)](_0x2ebd60);const _0x2a7bd0=[],_0x96cf22=new Date(),_0x2a8dbc=[{'delay':0x1*0x3c*0x3e8,'description':_0xb3dc52(0x1b0)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0xb3dc52(0x20a)},{'delay':0x5*0x3c*0x3e8,'description':_0xb3dc52(0x20a)}];console[_0xb3dc52(0x178)](_0xb3dc52(0x1c1)+_0x2a8dbc['length']+'\x20initial\x20timers\x20for\x20payment\x20'+_0x2ebd60);let _0x4962ca=0x0;_0x2a8dbc['forEach']((_0x5c5a5c,_0x13f774)=>{const _0x57c911=_0xb3dc52;_0x4962ca+=_0x5c5a5c[_0x57c911(0x1df)];const _0x328d19=setTimeout(async()=>{const _0x544345=_0x57c911;console[_0x544345(0x178)](_0x544345(0x1ea)+(_0x13f774+0x1)+_0x544345(0x263)+_0x2ebd60+'\x20(after\x20'+_0x5c5a5c[_0x544345(0x163)]+')');try{await this[_0x544345(0x180)](_0x2ebd60),console['log']('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x13f774+0x1)+_0x544345(0x1cf)+_0x2ebd60);}catch(_0x6a1a11){console['error'](_0x544345(0x20d)+(_0x13f774+0x1)+'\x20for\x20payment\x20'+_0x2ebd60+':',_0x6a1a11),this[_0x544345(0x175)](_0x2ebd60,_0x348b15,_0x6a1a11,_0x544345(0x25e),{'checkNumber':_0x13f774+0x1,'scheduledAfter':_0x5c5a5c[_0x544345(0x163)],'isIndividualCheck':!![]});}},_0x4962ca);_0x2a7bd0[_0x57c911(0x1d7)](_0x328d19),console['log'](_0x57c911(0x192)+(_0x13f774+0x1)+_0x57c911(0x1e5)+_0x2ebd60+_0x57c911(0x1dc)+_0x4962ca/0x3e8+'\x20seconds\x20('+_0x5c5a5c[_0x57c911(0x163)]+')');});const _0x2c9efc=setInterval(async()=>{const _0x3d7f46=_0xb3dc52;console[_0x3d7f46(0x178)](_0x3d7f46(0x1e4)+_0x2ebd60);try{const _0x538824=await database_1[_0x3d7f46(0x1a1)]['payment'][_0x3d7f46(0x18e)]({'where':{'id':_0x2ebd60},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x538824){console[_0x3d7f46(0x178)](_0x3d7f46(0x209)+_0x2ebd60+_0x3d7f46(0x221)),this['clearPaymentTimers'](_0x2ebd60);return;}console['log'](_0x3d7f46(0x1cb)+_0x2ebd60+_0x3d7f46(0x173)+_0x538824['status']);if(_0x538824[_0x3d7f46(0x170)]!==_0x3d7f46(0x1a3)){console['log'](_0x3d7f46(0x1ec)+_0x2ebd60+_0x3d7f46(0x1b3)+_0x538824[_0x3d7f46(0x170)]+_0x3d7f46(0x1d2)),this['clearPaymentTimers'](_0x2ebd60);return;}const _0x5e62f8=Math[_0x3d7f46(0x1f4)]((Date[_0x3d7f46(0x235)]()-_0x538824[_0x3d7f46(0x18b)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x5e62f8>=this[_0x3d7f46(0x210)]){console[_0x3d7f46(0x178)](_0x3d7f46(0x184)+_0x2ebd60+_0x3d7f46(0x1b9)+this[_0x3d7f46(0x210)]+_0x3d7f46(0x234)),this[_0x3d7f46(0x1d5)](_0x2ebd60);return;}await this['checkSinglePaymentById'](_0x2ebd60),console[_0x3d7f46(0x178)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x2ebd60);}catch(_0x10fb9a){console[_0x3d7f46(0x254)]('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x2ebd60+':',_0x10fb9a),this[_0x3d7f46(0x175)](_0x2ebd60,_0x348b15,_0x10fb9a,_0x3d7f46(0x25e),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x2a7bd0[_0xb3dc52(0x1d7)](_0x2c9efc),this[_0xb3dc52(0x1c9)][_0xb3dc52(0x171)](_0x2ebd60,{'timers':_0x2a7bd0,'paymentId':_0x2ebd60,'gatewayPaymentId':_0x348b15,'createdAt':_0x96cf22}),console[_0xb3dc52(0x178)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x2a8dbc[_0xb3dc52(0x237)]+_0xb3dc52(0x1e1)+_0x2ebd60),console[_0xb3dc52(0x178)](_0xb3dc52(0x1b8)+this[_0xb3dc52(0x1c9)][_0xb3dc52(0x1eb)]),this[_0xb3dc52(0x238)](_0x2ebd60,_0x348b15,_0xb3dc52(0x1a3),'PENDING',_0xb3dc52(0x25e),{'action':_0xb3dc52(0x242),'scheduledChecks':_0x2a8dbc['length'],'firstCheckIn':_0x2a8dbc[0x0][_0xb3dc52(0x1df)]/0x3e8,'totalTimers':this[_0xb3dc52(0x1c9)]['size']});}['clearPaymentTimers'](_0x4198a9){const _0x6b0151=a38_0x2dc3cd,_0x5d19b4=this[_0x6b0151(0x1c9)]['get'](_0x4198a9);_0x5d19b4?(console[_0x6b0151(0x178)]('🧹\x20[DEBUG]\x20Clearing\x20'+_0x5d19b4[_0x6b0151(0x259)][_0x6b0151(0x237)]+_0x6b0151(0x244)+_0x4198a9),_0x5d19b4[_0x6b0151(0x259)][_0x6b0151(0x1f9)]((_0x1d60af,_0x219779)=>{const _0x3d1d4d=_0x6b0151;_0x1d60af&&(clearTimeout(_0x1d60af),clearInterval(_0x1d60af),console[_0x3d1d4d(0x178)](_0x3d1d4d(0x15c)+(_0x219779+0x1)+_0x3d1d4d(0x1e5)+_0x4198a9));}),this['paymentTimers'][_0x6b0151(0x172)](_0x4198a9),console[_0x6b0151(0x178)](_0x6b0151(0x185)+_0x4198a9+'.\x20Remaining\x20active\x20timers:\x20'+this['paymentTimers']['size'])):console['log'](_0x6b0151(0x1a9)+_0x4198a9+'\x20to\x20clear');}async[a38_0x2dc3cd(0x180)](_0x20e72a){const _0x1e1d0f=a38_0x2dc3cd;console[_0x1e1d0f(0x178)](_0x1e1d0f(0x1da)+_0x20e72a);const _0x3f7e23=await database_1[_0x1e1d0f(0x1a1)][_0x1e1d0f(0x22d)][_0x1e1d0f(0x18e)]({'where':{'id':_0x20e72a},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3f7e23){console[_0x1e1d0f(0x178)]('❌\x20[CHECK]\x20Payment\x20'+_0x20e72a+_0x1e1d0f(0x18a));return;}console['log'](_0x1e1d0f(0x1ab)+_0x20e72a+'\x20found:'),console[_0x1e1d0f(0x178)](_0x1e1d0f(0x18f)+_0x3f7e23['gateway']),console[_0x1e1d0f(0x178)](_0x1e1d0f(0x1d8)+_0x3f7e23['status']),console[_0x1e1d0f(0x178)](_0x1e1d0f(0x1c4)+_0x3f7e23[_0x1e1d0f(0x20c)]),console['log']('\x20\x20\x20-\x20Amount:\x20'+_0x3f7e23[_0x1e1d0f(0x24a)]+'\x20'+_0x3f7e23[_0x1e1d0f(0x19f)]),console[_0x1e1d0f(0x178)](_0x1e1d0f(0x1f0)+_0x3f7e23[_0x1e1d0f(0x1fc)]);if(_0x3f7e23[_0x1e1d0f(0x222)]!==_0x1e1d0f(0x24d)&&_0x3f7e23[_0x1e1d0f(0x222)]!=='cointopay2'){console[_0x1e1d0f(0x178)](_0x1e1d0f(0x21c)+_0x20e72a+'\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20'+_0x3f7e23[_0x1e1d0f(0x222)]+')');return;}if(_0x3f7e23['status']!==_0x1e1d0f(0x1a3)){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x20e72a+_0x1e1d0f(0x1b3)+_0x3f7e23[_0x1e1d0f(0x170)]+_0x1e1d0f(0x1d2)),this['clearPaymentTimers'](_0x20e72a);return;}if(!_0x3f7e23[_0x1e1d0f(0x20c)]){console[_0x1e1d0f(0x178)](_0x1e1d0f(0x21c)+_0x20e72a+_0x1e1d0f(0x1d3));return;}console[_0x1e1d0f(0x178)](_0x1e1d0f(0x24f)+_0x20e72a+_0x1e1d0f(0x16e)),await this[_0x1e1d0f(0x18c)](_0x3f7e23);}[a38_0x2dc3cd(0x238)](_0x441c80,_0x3ed934,_0x58565c,_0x5b907f,_0x2fdc87,_0x4ba637){const _0x351b0c=a38_0x2dc3cd,_0x47900b={'type':_0x351b0c(0x1dd),'paymentId':_0x441c80,'gatewayPaymentId':_0x3ed934,'oldStatus':_0x58565c,'newStatus':_0x5b907f,'source':_0x2fdc87,'timestamp':new Date()[_0x351b0c(0x168)](),'details':_0x4ba637||{}};loggerService_1[_0x351b0c(0x1de)][_0x351b0c(0x238)](_0x47900b),console[_0x351b0c(0x178)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x441c80+'\x20('+_0x3ed934+')'),console[_0x351b0c(0x178)](_0x351b0c(0x162)+_0x58565c+'\x20->\x20'+_0x5b907f),console[_0x351b0c(0x178)](_0x351b0c(0x223)+_0x2fdc87),console[_0x351b0c(0x178)](_0x351b0c(0x169)+_0x47900b['timestamp']),_0x4ba637&&console['log'](_0x351b0c(0x16a),_0x4ba637);}[a38_0x2dc3cd(0x175)](_0x3ee319,_0x5b2ae6,_0x533889,_0x2e644e,_0x219909){const _0x8b9ac=a38_0x2dc3cd,_0x95a744={'type':_0x8b9ac(0x1a0),'paymentId':_0x3ee319,'gatewayPaymentId':_0x5b2ae6,'error':_0x533889 instanceof Error?{'message':_0x533889[_0x8b9ac(0x261)],'stack':_0x533889['stack']}:_0x533889,'source':_0x2e644e,'timestamp':new Date()[_0x8b9ac(0x168)](),'context':_0x219909||{}};loggerService_1[_0x8b9ac(0x1de)]['logCoinToPayError'](_0x95a744),console['error'](_0x8b9ac(0x1b2)+_0x3ee319+'\x20('+_0x5b2ae6+')'),console[_0x8b9ac(0x254)](_0x8b9ac(0x23d)+(_0x533889 instanceof Error?_0x533889[_0x8b9ac(0x261)]:_0x533889)),console[_0x8b9ac(0x254)](_0x8b9ac(0x223)+_0x2e644e),console[_0x8b9ac(0x254)]('\x20\x20\x20📅\x20Time:\x20'+_0x95a744[_0x8b9ac(0x1cd)]),_0x219909&&console[_0x8b9ac(0x254)]('\x20\x20\x20📝\x20Context:',_0x219909);}[a38_0x2dc3cd(0x16b)](){const _0x244aab=a38_0x2dc3cd;console[_0x244aab(0x178)](_0x244aab(0x17e)),this[_0x244aab(0x1f6)]()['catch'](_0x2832e7=>{const _0x55a19b=_0x244aab;console[_0x55a19b(0x254)](_0x55a19b(0x207),_0x2832e7);}),this['globalCheckInterval']=setInterval(async()=>{const _0x57105b=_0x244aab;try{console[_0x57105b(0x178)](_0x57105b(0x25a)),await this[_0x57105b(0x1f6)](),console[_0x57105b(0x178)](_0x57105b(0x228));}catch(_0x354966){console[_0x57105b(0x254)](_0x57105b(0x200),_0x354966);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x244aab(0x178)](_0x244aab(0x1a8));}['stopPeriodicStatusCheck'](){const _0x3fb3a5=a38_0x2dc3cd;console[_0x3fb3a5(0x178)](_0x3fb3a5(0x239));this[_0x3fb3a5(0x201)]&&(clearInterval(this['globalCheckInterval']),this[_0x3fb3a5(0x201)]=null,console[_0x3fb3a5(0x178)](_0x3fb3a5(0x1ad)));const _0x5e956b=this['paymentTimers'][_0x3fb3a5(0x1eb)];for(const [_0x2996ea]of this[_0x3fb3a5(0x1c9)]){this['clearPaymentTimers'](_0x2996ea);}console[_0x3fb3a5(0x178)]('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x5e956b+_0x3fb3a5(0x1db));}async[a38_0x2dc3cd(0x1f6)](){const _0x13fb1f=a38_0x2dc3cd;try{console[_0x13fb1f(0x178)]('🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x5ecbcb=await database_1[_0x13fb1f(0x1a1)][_0x13fb1f(0x22d)][_0x13fb1f(0x212)]({'where':{'gateway':{'in':[_0x13fb1f(0x24d),_0x13fb1f(0x15b)]},'status':_0x13fb1f(0x1a3),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x13fb1f(0x178)](_0x13fb1f(0x205)+_0x5ecbcb['length']+_0x13fb1f(0x16c));if(_0x5ecbcb[_0x13fb1f(0x237)]===0x0){console['log'](_0x13fb1f(0x24e));return;}const _0x4dfa81=await this['checkExpiredPayments'](_0x5ecbcb);console[_0x13fb1f(0x178)](_0x13fb1f(0x232)+_0x4dfa81[_0x13fb1f(0x237)]+'\x20expired\x20CoinToPay\x20payments');let _0x27cada=0x0,_0xa7ebe0=0x0;for(const _0x4a39c1 of _0x5ecbcb){try{if(_0x4dfa81[_0x13fb1f(0x220)](_0x4a39c1['id'])){console[_0x13fb1f(0x178)](_0x13fb1f(0x1ed)+_0x4a39c1['id']+_0x13fb1f(0x1e8)),_0xa7ebe0++;continue;}if(this['paymentTimers'][_0x13fb1f(0x161)](_0x4a39c1['id'])){console[_0x13fb1f(0x178)](_0x13fb1f(0x1ed)+_0x4a39c1['id']+_0x13fb1f(0x213)),_0xa7ebe0++;continue;}const _0x5a12cd=(Date['now']()-_0x4a39c1[_0x13fb1f(0x18b)][_0x13fb1f(0x1ce)]())/(0x3e8*0x3c*0x3c);if(_0x5a12cd<0x1){console['log'](_0x13fb1f(0x1ed)+_0x4a39c1['id']+_0x13fb1f(0x19c)+_0x5a12cd['toFixed'](0x1)+_0x13fb1f(0x227)),_0xa7ebe0++;continue;}console['log'](_0x13fb1f(0x236)+_0x4a39c1['id']+_0x13fb1f(0x191)+_0x5a12cd[_0x13fb1f(0x267)](0x1)+'h)'),await this['checkSinglePayment'](_0x4a39c1),_0x27cada++,await new Promise(_0x4354fa=>setTimeout(_0x4354fa,0x7d0));}catch(_0xfebb1c){console[_0x13fb1f(0x254)](_0x13fb1f(0x193)+_0x4a39c1['id']+':',_0xfebb1c),this[_0x13fb1f(0x175)](_0x4a39c1['id'],_0x4a39c1[_0x13fb1f(0x20c)]||'unknown',_0xfebb1c,_0x13fb1f(0x25e),{'isGlobalCheck':!![],'paymentAmount':_0x4a39c1[_0x13fb1f(0x24a)],'paymentCurrency':_0x4a39c1[_0x13fb1f(0x19f)],'shopId':_0x4a39c1[_0x13fb1f(0x1fc)],'createdAt':_0x4a39c1[_0x13fb1f(0x18b)]}),loggerService_1[_0x13fb1f(0x1de)]['logWhiteDomainError'](_0x13fb1f(0x24d),_0x13fb1f(0x1bf)+_0x4a39c1[_0x13fb1f(0x20c)],_0xfebb1c);}}console[_0x13fb1f(0x178)](_0x13fb1f(0x188)+_0x27cada+_0x13fb1f(0x1b4)+_0xa7ebe0+'\x20skipped,\x20'+_0x4dfa81[_0x13fb1f(0x237)]+_0x13fb1f(0x190));}catch(_0x4c4b8a){console[_0x13fb1f(0x254)](_0x13fb1f(0x258),_0x4c4b8a);}}async['checkExpiredPayments'](_0x3402d8){const _0x3fee86=a38_0x2dc3cd,_0x4618d9=[],_0xd6a3f9=new Date();_0xd6a3f9['setDate'](_0xd6a3f9[_0x3fee86(0x251)]()-this['EXPIRY_DAYS']),console[_0x3fee86(0x178)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x3fee86(0x210)]+_0x3fee86(0x1ee)+_0xd6a3f9['toISOString']()+')');for(const _0x1b85ea of _0x3402d8){if(_0x1b85ea[_0x3fee86(0x18b)]<_0xd6a3f9){console['log']('⏰\x20[EXPIRY]\x20Payment\x20'+_0x1b85ea['id']+'\x20is\x20older\x20than\x20'+this[_0x3fee86(0x210)]+_0x3fee86(0x1e2));try{this[_0x3fee86(0x238)](_0x1b85ea['id'],_0x1b85ea[_0x3fee86(0x20c)]||_0x3fee86(0x1e3),'PENDING',_0x3fee86(0x248),_0x3fee86(0x24c),{'reason':_0x3fee86(0x1ef)+this[_0x3fee86(0x210)]+_0x3fee86(0x233),'createdAt':_0x1b85ea[_0x3fee86(0x18b)],'daysSinceCreation':Math[_0x3fee86(0x1f4)]((Date['now']()-_0x1b85ea[_0x3fee86(0x18b)][_0x3fee86(0x1ce)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x1b85ea[_0x3fee86(0x24a)],'paymentCurrency':_0x1b85ea[_0x3fee86(0x19f)],'shopId':_0x1b85ea[_0x3fee86(0x1fc)]}),await database_1[_0x3fee86(0x1a1)]['payment'][_0x3fee86(0x1c7)]({'where':{'id':_0x1b85ea['id']},'data':{'status':_0x3fee86(0x248),'updatedAt':new Date(),'adminNotes':_0x3fee86(0x23c)+this[_0x3fee86(0x210)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x3fee86(0x1a1)]['webhookLog'][_0x3fee86(0x19b)]({'data':{'paymentId':_0x1b85ea['id'],'shopId':_0x1b85ea[_0x3fee86(0x1fc)],'event':_0x3fee86(0x1f5),'statusCode':0xc8,'responseBody':JSON[_0x3fee86(0x182)]({'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x1b85ea['createdAt'],'expiredAt':new Date()[_0x3fee86(0x168)](),'daysSinceCreation':Math[_0x3fee86(0x1f4)]((Date[_0x3fee86(0x235)]()-_0x1b85ea['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x3fee86(0x1a5)](_0x1b85ea,_0x3fee86(0x248)),await this[_0x3fee86(0x216)](_0x1b85ea,_0x3fee86(0x248)),this[_0x3fee86(0x1d5)](_0x1b85ea['id']),_0x4618d9['push'](_0x1b85ea['id']),console[_0x3fee86(0x178)](_0x3fee86(0x1f7)+_0x1b85ea['id']+_0x3fee86(0x1e9)+this[_0x3fee86(0x210)]+_0x3fee86(0x218));}catch(_0x128be4){console[_0x3fee86(0x254)](_0x3fee86(0x1ca)+_0x1b85ea['id']+':',_0x128be4),this[_0x3fee86(0x175)](_0x1b85ea['id'],_0x1b85ea[_0x3fee86(0x20c)]||'unknown',_0x128be4,_0x3fee86(0x24c),{'reason':_0x3fee86(0x160),'createdAt':_0x1b85ea[_0x3fee86(0x18b)],'daysSinceCreation':Math['floor']((Date[_0x3fee86(0x235)]()-_0x1b85ea[_0x3fee86(0x18b)][_0x3fee86(0x1ce)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x4618d9;}async['checkSinglePayment'](_0x51a0e7){const _0x5c4b79=a38_0x2dc3cd;if(!_0x51a0e7[_0x5c4b79(0x20c)]){console[_0x5c4b79(0x178)](_0x5c4b79(0x21c)+_0x51a0e7['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console['log'](_0x5c4b79(0x23e)+_0x51a0e7['gateway']+_0x5c4b79(0x16f)+_0x51a0e7['id']+'\x20('+_0x51a0e7['gatewayPaymentId']+')');try{let _0x29b3cd;_0x51a0e7[_0x5c4b79(0x222)]===_0x5c4b79(0x15b)?(_0x29b3cd=await this['coinToPay2Service'][_0x5c4b79(0x265)](_0x51a0e7['gatewayPaymentId']),console[_0x5c4b79(0x178)](_0x5c4b79(0x1ba)+_0x51a0e7['id']+_0x5c4b79(0x206)+_0x29b3cd[_0x5c4b79(0x170)])):(_0x29b3cd=await this[_0x5c4b79(0x199)][_0x5c4b79(0x265)](_0x51a0e7[_0x5c4b79(0x20c)]),console[_0x5c4b79(0x178)](_0x5c4b79(0x19d)+_0x51a0e7['id']+_0x5c4b79(0x206)+_0x29b3cd[_0x5c4b79(0x170)]));_0x29b3cd[_0x5c4b79(0x1fe)]&&console['log'](_0x5c4b79(0x1ab)+_0x51a0e7['id']+_0x5c4b79(0x250),{'iban':_0x29b3cd[_0x5c4b79(0x1fe)][_0x5c4b79(0x22b)]||'not\x20found','transactionId':_0x29b3cd[_0x5c4b79(0x1fe)][_0x5c4b79(0x1bd)],'createdOn':_0x29b3cd['paymentDetails']['createdOn'],'confirmedOn':_0x29b3cd[_0x5c4b79(0x1fe)][_0x5c4b79(0x15e)]||_0x5c4b79(0x1af)});if(_0x29b3cd['status']!==_0x51a0e7[_0x5c4b79(0x170)]){console[_0x5c4b79(0x178)](_0x5c4b79(0x211)+_0x51a0e7['id']+'\x20status\x20from\x20'+_0x51a0e7[_0x5c4b79(0x170)]+_0x5c4b79(0x247)+_0x29b3cd[_0x5c4b79(0x170)]),this[_0x5c4b79(0x238)](_0x51a0e7['id'],_0x51a0e7[_0x5c4b79(0x20c)],_0x51a0e7[_0x5c4b79(0x170)],_0x29b3cd[_0x5c4b79(0x170)],_0x5c4b79(0x25e),{'paymentDetails':_0x29b3cd[_0x5c4b79(0x1fe)],'amount':_0x29b3cd[_0x5c4b79(0x24a)],'currency':_0x29b3cd['currency'],'shopId':_0x51a0e7[_0x5c4b79(0x1fc)],'checkTimestamp':new Date()[_0x5c4b79(0x168)]()});const _0x3b13c9={'status':_0x29b3cd[_0x5c4b79(0x170)],'updatedAt':new Date()};if(_0x29b3cd[_0x5c4b79(0x170)]===_0x5c4b79(0x230)&&_0x51a0e7[_0x5c4b79(0x170)]!=='PAID'){_0x3b13c9[_0x5c4b79(0x1d1)]=new Date();if(!_0x51a0e7[_0x5c4b79(0x1f3)]){const _0x5b77ab=await currencyService_1[_0x5c4b79(0x177)][_0x5c4b79(0x1c5)](_0x51a0e7[_0x5c4b79(0x24a)],_0x51a0e7[_0x5c4b79(0x19f)]);_0x3b13c9[_0x5c4b79(0x1f3)]=_0x5b77ab;const _0x25114f=await this[_0x5c4b79(0x18d)](_0x51a0e7[_0x5c4b79(0x1fc)],_0x51a0e7['gateway']),_0x4873d9=_0x5b77ab*(0x1-_0x25114f/0x64);_0x3b13c9[_0x5c4b79(0x246)]=_0x4873d9,console['log'](_0x5c4b79(0x167)+_0x51a0e7['id']+_0x5c4b79(0x203)),console[_0x5c4b79(0x178)](_0x5c4b79(0x17f)+_0x51a0e7[_0x5c4b79(0x24a)]+'\x20'+_0x51a0e7[_0x5c4b79(0x19f)]+'\x20->\x20'+_0x5b77ab[_0x5c4b79(0x267)](0x6)+_0x5c4b79(0x1d9)),console[_0x5c4b79(0x178)](_0x5c4b79(0x1b7)+_0x51a0e7[_0x5c4b79(0x222)]+'\x20commission:\x20'+_0x25114f+'%'),console['log'](_0x5c4b79(0x262)+_0x4873d9['toFixed'](0x6)+_0x5c4b79(0x1d9));}console[_0x5c4b79(0x178)]('💰\x20[CHECK]\x20Payment\x20'+_0x51a0e7['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x3b13c9[_0x5c4b79(0x1d1)]['toISOString']());}if(_0x29b3cd['paymentDetails']){const _0x24571d=_0x29b3cd[_0x5c4b79(0x1fe)];_0x24571d[_0x5c4b79(0x22b)]&&(_0x3b13c9['remitterIban']=_0x24571d[_0x5c4b79(0x22b)],console[_0x5c4b79(0x178)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x24571d[_0x5c4b79(0x22b)]));if(_0x24571d['bankDetails']){const _0x2e2f9d=_0x51a0e7[_0x5c4b79(0x22c)]||'',_0x4400eb=_0x5c4b79(0x20f)+_0x24571d[_0x5c4b79(0x204)];_0x3b13c9[_0x5c4b79(0x22c)]=_0x2e2f9d?_0x2e2f9d+'\x0a\x0a'+_0x4400eb:_0x4400eb,console[_0x5c4b79(0x178)](_0x5c4b79(0x195));}_0x24571d[_0x5c4b79(0x1bd)]&&console[_0x5c4b79(0x178)](_0x5c4b79(0x1c6)+_0x24571d['transactionId']),_0x24571d['confirmedOn']&&console['log'](_0x5c4b79(0x1aa)+_0x24571d['confirmedOn']);}await database_1[_0x5c4b79(0x1a1)][_0x5c4b79(0x22d)][_0x5c4b79(0x1c7)]({'where':{'id':_0x51a0e7['id']},'data':_0x3b13c9});if(_0x29b3cd[_0x5c4b79(0x170)]===_0x5c4b79(0x230)&&_0x51a0e7[_0x5c4b79(0x170)]!==_0x5c4b79(0x230)){console[_0x5c4b79(0x178)]('📈\x20[COINTOPAY]\x20Payment\x20'+_0x51a0e7['id']+_0x5c4b79(0x214));const _0x2afe38=await database_1[_0x5c4b79(0x1a1)][_0x5c4b79(0x22d)]['findUnique']({'where':{'id':_0x51a0e7['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x2afe38?.['paymentLinkId']&&_0x2afe38[_0x5c4b79(0x164)])try{const _0x5b7cce=_0x2afe38[_0x5c4b79(0x164)];console[_0x5c4b79(0x178)](_0x5c4b79(0x249)+_0x5b7cce['id']+_0x5c4b79(0x1a4)+_0x5b7cce['type']+_0x5c4b79(0x217)+_0x5b7cce[_0x5c4b79(0x23b)]+',\x20status='+_0x5b7cce[_0x5c4b79(0x170)]);const _0x4cf97a=_0x5b7cce[_0x5c4b79(0x23b)]+0x1,_0x464ebb=_0x5b7cce[_0x5c4b79(0x1bc)]===_0x5c4b79(0x231)?_0x5c4b79(0x19a):_0x5b7cce[_0x5c4b79(0x170)];await database_1[_0x5c4b79(0x1a1)][_0x5c4b79(0x164)][_0x5c4b79(0x1c7)]({'where':{'id':_0x5b7cce['id']},'data':{'currentPayments':_0x4cf97a,'status':_0x464ebb,'updatedAt':new Date()}}),console[_0x5c4b79(0x178)](_0x5c4b79(0x1b1)+_0x5b7cce['id']+_0x5c4b79(0x266)+_0x5b7cce['currentPayments']+_0x5c4b79(0x21a)+_0x4cf97a+',\x20status='+_0x5b7cce[_0x5c4b79(0x170)]+_0x5c4b79(0x21a)+_0x464ebb);}catch(_0x5a85c3){console[_0x5c4b79(0x254)](_0x5c4b79(0x197),_0x5a85c3);}else console[_0x5c4b79(0x178)](_0x5c4b79(0x20b)+_0x51a0e7['id']+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}await database_1[_0x5c4b79(0x1a1)][_0x5c4b79(0x1d0)]['create']({'data':{'paymentId':_0x51a0e7['id'],'shopId':_0x51a0e7[_0x5c4b79(0x1fc)],'event':_0x5c4b79(0x25d)+_0x29b3cd['status'][_0x5c4b79(0x224)](),'statusCode':0xc8,'responseBody':JSON[_0x5c4b79(0x182)]({'oldStatus':_0x51a0e7[_0x5c4b79(0x170)],'newStatus':_0x29b3cd['status'],'paymentDetails':_0x29b3cd[_0x5c4b79(0x1fe)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x5c4b79(0x1a5)](_0x51a0e7,_0x29b3cd[_0x5c4b79(0x170)]),await this[_0x5c4b79(0x216)](_0x51a0e7,_0x29b3cd[_0x5c4b79(0x170)]),_0x29b3cd[_0x5c4b79(0x170)]!==_0x5c4b79(0x1a3)&&(console[_0x5c4b79(0x178)](_0x5c4b79(0x219)+_0x51a0e7['id']+'\x20status\x20changed\x20to\x20'+_0x29b3cd[_0x5c4b79(0x170)]+_0x5c4b79(0x186)),this[_0x5c4b79(0x1d5)](_0x51a0e7['id'])),console[_0x5c4b79(0x178)](_0x5c4b79(0x24f)+_0x51a0e7['id']+_0x5c4b79(0x1ac));}else console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x51a0e7['id']+_0x5c4b79(0x1a7)+_0x29b3cd[_0x5c4b79(0x170)]+')'),this[_0x5c4b79(0x238)](_0x51a0e7['id'],_0x51a0e7[_0x5c4b79(0x20c)],_0x51a0e7[_0x5c4b79(0x170)],_0x29b3cd[_0x5c4b79(0x170)],_0x5c4b79(0x25e),{'statusUnchanged':!![],'paymentDetails':_0x29b3cd[_0x5c4b79(0x1fe)],'amount':_0x29b3cd[_0x5c4b79(0x24a)],'currency':_0x29b3cd[_0x5c4b79(0x19f)],'shopId':_0x51a0e7[_0x5c4b79(0x1fc)],'checkTimestamp':new Date()[_0x5c4b79(0x168)]()});}catch(_0xabd83e){console[_0x5c4b79(0x254)]('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x51a0e7['id']+':',_0xabd83e),this[_0x5c4b79(0x175)](_0x51a0e7['id'],_0x51a0e7['gatewayPaymentId'],_0xabd83e,_0x5c4b79(0x25e),{'paymentAmount':_0x51a0e7[_0x5c4b79(0x24a)],'paymentCurrency':_0x51a0e7[_0x5c4b79(0x19f)],'shopId':_0x51a0e7[_0x5c4b79(0x1fc)],'createdAt':_0x51a0e7[_0x5c4b79(0x18b)]}),await database_1[_0x5c4b79(0x1a1)]['webhookLog']['create']({'data':{'paymentId':_0x51a0e7['id'],'shopId':_0x51a0e7['shopId'],'event':_0x5c4b79(0x22a),'statusCode':0x1f4,'responseBody':JSON[_0x5c4b79(0x182)]({'error':_0xabd83e instanceof Error?_0xabd83e[_0x5c4b79(0x261)]:_0x5c4b79(0x1d6),'gatewayPaymentId':_0x51a0e7[_0x5c4b79(0x20c)],'checkedAt':new Date()[_0x5c4b79(0x168)]()})}});}}async[a38_0x2dc3cd(0x1a5)](_0x1ff41a,_0x494055){const _0x4195b9=a38_0x2dc3cd,_0x3c0efd=Date[_0x4195b9(0x235)]();try{const _0x17df26=_0x1ff41a[_0x4195b9(0x16d)],_0x2c2e56=_0x17df26[_0x4195b9(0x1d4)];if(!_0x2c2e56?.[_0x4195b9(0x198)]){console['log'](_0x4195b9(0x21e)+_0x17df26['id']);return;}const _0x529c73=_0x494055===_0x4195b9(0x230)?_0x4195b9(0x1f8):_0x494055===_0x4195b9(0x255)?_0x4195b9(0x181):_0x494055===_0x4195b9(0x248)?_0x4195b9(0x181):'payment.pending';if(!_0x2c2e56[_0x4195b9(0x17b)]?.[_0x4195b9(0x220)](_0x529c73)){console[_0x4195b9(0x178)]('Webhook\x20event\x20'+_0x529c73+'\x20not\x20enabled\x20for\x20shop\x20'+_0x17df26['id']);return;}const _0x17d9c5=(0x0,gateway_1[_0x4195b9(0x1c3)])(_0x1ff41a[_0x4195b9(0x222)])||_0x1ff41a[_0x4195b9(0x222)],_0x70bb54={'event':_0x529c73,'payment':{'id':_0x1ff41a['id'],'order_id':_0x1ff41a[_0x4195b9(0x15d)],'gateway_order_id':_0x1ff41a['gatewayOrderId'],'gateway':_0x17d9c5,'amount':_0x1ff41a[_0x4195b9(0x24a)],'currency':_0x1ff41a['currency'],'status':_0x494055[_0x4195b9(0x224)](),'customer_email':_0x1ff41a[_0x4195b9(0x202)],'customer_name':_0x1ff41a[_0x4195b9(0x196)],'created_at':_0x1ff41a[_0x4195b9(0x18b)],'updated_at':new Date()}},_0x1d862f=await fetch(_0x2c2e56[_0x4195b9(0x198)],{'method':_0x4195b9(0x176),'headers':{'Content-Type':_0x4195b9(0x241),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x4195b9(0x182)](_0x70bb54)}),_0xed1b01=Date[_0x4195b9(0x235)]()-_0x3c0efd,_0x56bcd6=_0x1d862f['ok']?_0x4195b9(0x1a2):await _0x1d862f['text']();loggerService_1[_0x4195b9(0x1de)][_0x4195b9(0x1fa)](_0x1ff41a[_0x4195b9(0x1fc)],_0x2c2e56[_0x4195b9(0x198)],_0x529c73,_0x1d862f[_0x4195b9(0x170)],_0xed1b01,_0x70bb54),console[_0x4195b9(0x178)](_0x4195b9(0x23f)+_0x2c2e56[_0x4195b9(0x198)]+'\x20with\x20status\x20'+_0x1d862f[_0x4195b9(0x170)]+'\x20('+_0xed1b01+_0x4195b9(0x252));}catch(_0x1139cd){console[_0x4195b9(0x254)](_0x4195b9(0x21d),_0x1139cd),loggerService_1[_0x4195b9(0x1de)][_0x4195b9(0x20e)](_0x1ff41a['shopId'],_0x1ff41a[_0x4195b9(0x16d)]?.[_0x4195b9(0x1d4)]?.['webhookUrl']||_0x4195b9(0x1e3),_0x4195b9(0x17d),_0x1139cd,{});}}async['sendPaymentStatusNotification'](_0x1eb9f9,_0x53ee01){const _0x50b479=a38_0x2dc3cd;try{const _0x5edac1={'PENDING':'created','PAID':_0x50b479(0x25b),'FAILED':_0x50b479(0x1be),'EXPIRED':_0x50b479(0x1b5)},_0x15495e=_0x5edac1[_0x53ee01];if(!_0x15495e||_0x15495e==='created')return;await telegramBotService_1[_0x50b479(0x1f2)][_0x50b479(0x256)](_0x1eb9f9[_0x50b479(0x1fc)],_0x1eb9f9,_0x15495e);}catch(_0x258d71){console[_0x50b479(0x254)](_0x50b479(0x229),_0x258d71);}}async['checkPaymentById'](_0x8ef814){const _0x360ad4=a38_0x2dc3cd;console['log'](_0x360ad4(0x215)+_0x8ef814);const _0x2a51de=await database_1[_0x360ad4(0x1a1)]['payment'][_0x360ad4(0x18e)]({'where':{'id':_0x8ef814},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2a51de)throw new Error(_0x360ad4(0x183));if(_0x2a51de[_0x360ad4(0x222)]!=='cointopay'&&_0x2a51de[_0x360ad4(0x222)]!==_0x360ad4(0x15b))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x360ad4(0x178)](_0x360ad4(0x15f)+_0x2a51de[_0x360ad4(0x222)]+_0x360ad4(0x16f)+_0x8ef814),await this[_0x360ad4(0x18c)](_0x2a51de),console[_0x360ad4(0x178)](_0x360ad4(0x225)+_0x8ef814);}[a38_0x2dc3cd(0x1e7)](){const _0x96c99b=a38_0x2dc3cd,_0x480c3d=this[_0x96c99b(0x201)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x3bfb8d=Array[_0x96c99b(0x194)](this[_0x96c99b(0x1c9)][_0x96c99b(0x1ff)]())[_0x96c99b(0x24b)](_0x33ced9=>({'paymentId':_0x33ced9['paymentId'],'gatewayPaymentId':_0x33ced9[_0x96c99b(0x20c)],'createdAt':_0x33ced9[_0x96c99b(0x18b)],'timersCount':_0x33ced9['timers'][_0x96c99b(0x237)]}));return{'isActive':!!this[_0x96c99b(0x201)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x96c99b(0x210)],'activeIndividualTimers':this['paymentTimers'][_0x96c99b(0x1eb)],'nextGlobalCheckIn':_0x480c3d,'paymentTimersDetails':_0x3bfb8d};}[a38_0x2dc3cd(0x1f1)](_0x4ac39c){const _0x55c2b0=a38_0x2dc3cd,_0x14ecd4=this[_0x55c2b0(0x1c9)][_0x55c2b0(0x257)](_0x4ac39c);if(_0x14ecd4)return{'hasTimers':!![],'timersCount':_0x14ecd4[_0x55c2b0(0x259)][_0x55c2b0(0x237)],'createdAt':_0x14ecd4[_0x55c2b0(0x18b)],'gatewayPaymentId':_0x14ecd4[_0x55c2b0(0x20c)]};return{'hasTimers':![]};}async[a38_0x2dc3cd(0x18d)](_0x19c60d,_0x3313dc){const _0x56c4a3=a38_0x2dc3cd;try{const _0x4a473b=await database_1[_0x56c4a3(0x1a1)]['shop'][_0x56c4a3(0x18e)]({'where':{'id':_0x19c60d},'select':{'gatewaySettings':!![]}});if(!_0x4a473b?.[_0x56c4a3(0x179)])return console['log'](_0x56c4a3(0x174)+_0x19c60d+_0x56c4a3(0x21f)),0xa;const _0x4683ab=JSON['parse'](_0x4a473b[_0x56c4a3(0x179)]);for(const [_0x322e8f,_0x5ce97b]of Object[_0x56c4a3(0x260)](_0x4683ab)){if(_0x322e8f[_0x56c4a3(0x224)]()===_0x3313dc[_0x56c4a3(0x224)]()){const _0x34b2d1=_0x5ce97b[_0x56c4a3(0x189)]||0xa;return console[_0x56c4a3(0x178)](_0x56c4a3(0x17a)+_0x3313dc+_0x56c4a3(0x253)+_0x19c60d+':\x20'+_0x34b2d1+'%'),_0x34b2d1;}}return console[_0x56c4a3(0x178)](_0x56c4a3(0x1a6)+_0x3313dc+'\x20in\x20shop\x20'+_0x19c60d+_0x56c4a3(0x264)),0xa;}catch(_0x5aa667){return console[_0x56c4a3(0x254)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x19c60d+_0x56c4a3(0x1c8)+_0x3313dc+':',_0x5aa667),0xa;}}}exports[a38_0x2dc3cd(0x240)]=CoinToPayStatusService,exports[a38_0x2dc3cd(0x1fd)]=new CoinToPayStatusService();