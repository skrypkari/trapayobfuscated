'use strict';const a35_0xe78e85=a35_0x4708;(function(_0x556b94,_0x52a03a){const _0x3e1f19=a35_0x4708,_0x2a2896=_0x556b94();while(!![]){try{const _0x35fe05=-parseInt(_0x3e1f19(0x226))/0x1*(parseInt(_0x3e1f19(0x26a))/0x2)+-parseInt(_0x3e1f19(0x211))/0x3*(-parseInt(_0x3e1f19(0x261))/0x4)+-parseInt(_0x3e1f19(0x25b))/0x5+parseInt(_0x3e1f19(0x1f8))/0x6+-parseInt(_0x3e1f19(0x250))/0x7+-parseInt(_0x3e1f19(0x213))/0x8*(parseInt(_0x3e1f19(0x26c))/0x9)+parseInt(_0x3e1f19(0x278))/0xa;if(_0x35fe05===_0x52a03a)break;else _0x2a2896['push'](_0x2a2896['shift']());}catch(_0x176c46){_0x2a2896['push'](_0x2a2896['shift']());}}}(a35_0x342b,0x5b319));function a35_0x342b(){const _0x4e7575=['15176vpMOcG','POST','not\x20confirmed','default','message','setDate','coinToPayService','\x20not\x20enabled\x20for\x20shop\x20','\x20status\x20from\x20','PENDING','toLowerCase','â°\x20Payment\x20','\x20pending\x20CoinToPay\x20payments','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','ðŸ’°\x20Payment\x20','CHECK_INTERVAL_MS','CoinToPayStatusService','paidAt','status','166157TGkcUw','iban','error','getServiceStats','customerName','\x20status\x20unchanged\x20(','0100','failed','update','checkExpiredPayments','toISOString','checkPaymentStatus','Failed\x20to\x20expire\x20payment\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','create','Periodic\x20CoinToPay\x20status\x20check\x20failed:','ðŸ“Š\x20Payment\x20','Bank\x20Details:\x20','webhookLog','getTime','telegramBotService','sendShopWebhook','amount','findMany','FAILED','expired','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','Automatically\x20expired\x20after\x20','\x20to\x20','âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','customerEmail','gatewayPaymentId','__importDefault','gateway','Success','ðŸ†”\x20Transaction\x20ID:\x20','__esModule','created','Failed\x20to\x20send\x20shop\x20webhook:','\x20updated\x20successfully','/status/','payment.failed','3532522diDVot','\x20days,\x20marking\x20as\x20EXPIRED','PAID','cointopay_status_check_error','EXPIRY_DAYS','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20CoinToPay\x20payments','../config/database','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','log','./telegramBotService','3259455cdNsTB','\x20expired\x20CoinToPay\x20payments','ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','cointopay_status_check_','coinToPayStatusService','confirmedOn','4HDKsYc','Unknown\x20error','\x20status:\x20','Webhook\x20event\x20','checkInterval','bankDetails','âš ï¸\x20Payment\x20','transactionId','webhook_send','2RRtDzk','Failed\x20to\x20check\x20payment\x20','657VupTKm','paid','Payment\x20not\x20found','EXPIRED','âœ…\x20Completed\x20checking\x20','stopPeriodicStatusCheck','\x20marked\x20as\x20paid\x20at:\x20','Payment\x20older\x20than\x20','ðŸ¦\x20Saved\x20IBAN:\x20','now','text','\x20has\x20no\x20gatewayPaymentId,\x20skipping','9534940ZFrxqW','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20details:','ðŸª™\x20Checking\x20','findUnique','logShopWebhookSent','shopId','catch','unknown','payment','orderId','paymentDetails','sendPaymentStatusNotification','âœ…\x20Transaction\x20confirmed\x20on:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','not\x20found','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','checkPaymentById','payment.pending','823278LyuwFS','\x20days\x20without\x20payment\x20confirmation','\x20days\x20(created\x20before\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','adminNotes','âœ…\x20Payment\x20','includes','cointopay_auto_expired','ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped','stringify','createdAt','Initial\x20CoinToPay\x20status\x20check\x20failed:','./gateways/coinToPayService','checkAllPendingPayments','payment.success','loggerService','webhookEvents','createdOn','settings','./loggerService','checkSinglePayment','logWhiteDomainError','webhookUrl','\x20is\x20older\x20than\x20','-day\x20timeout','2231991YEmpaw','length'];a35_0x342b=function(){return _0x4e7575;};return a35_0x342b();}var __importDefault=this&&this[a35_0xe78e85(0x246)]||function(_0x90f008){return _0x90f008&&_0x90f008['__esModule']?_0x90f008:{'default':_0x90f008};};Object['defineProperty'](exports,a35_0xe78e85(0x24a),{'value':!![]}),exports[a35_0xe78e85(0x25f)]=exports[a35_0xe78e85(0x223)]=void 0x0;function a35_0x4708(_0xbf4e69,_0x257c93){const _0x342b3f=a35_0x342b();return a35_0x4708=function(_0x47087d,_0x21da6d){_0x47087d=_0x47087d-0x1ef;let _0x36d3f3=_0x342b3f[_0x47087d];return _0x36d3f3;},a35_0x4708(_0xbf4e69,_0x257c93);}const coinToPayService_1=require(a35_0xe78e85(0x204)),database_1=__importDefault(require(a35_0xe78e85(0x257))),telegramBotService_1=require(a35_0xe78e85(0x25a)),loggerService_1=require(a35_0xe78e85(0x20b));class CoinToPayStatusService{constructor(){const _0xa5bef2=a35_0xe78e85;this['checkInterval']=null,this[_0xa5bef2(0x222)]=0x3c*0x3c*0x3e8,this[_0xa5bef2(0x254)]=0x5,this[_0xa5bef2(0x219)]=new coinToPayService_1['CoinToPayService']();}['startPeriodicStatusCheck'](){const _0x2b8494=a35_0xe78e85;console['log'](_0x2b8494(0x220)),this[_0x2b8494(0x205)]()[_0x2b8494(0x27f)](_0x27f0f2=>{const _0x4976ec=_0x2b8494;console[_0x4976ec(0x228)](_0x4976ec(0x203),_0x27f0f2);}),this[_0x2b8494(0x265)]=setInterval(async()=>{const _0x3c6d20=_0x2b8494;try{await this['checkAllPendingPayments']();}catch(_0x5e4654){console[_0x3c6d20(0x228)](_0x3c6d20(0x235),_0x5e4654);}},this[_0x2b8494(0x222)]),console['log'](_0x2b8494(0x243));}[a35_0xe78e85(0x271)](){const _0x1b0a79=a35_0xe78e85;this[_0x1b0a79(0x265)]&&(clearInterval(this['checkInterval']),this[_0x1b0a79(0x265)]=null,console[_0x1b0a79(0x259)](_0x1b0a79(0x200)));}async[a35_0xe78e85(0x205)](){const _0x290dec=a35_0xe78e85;try{const _0x14dc5a=await database_1[_0x290dec(0x216)][_0x290dec(0x281)][_0x290dec(0x23d)]({'where':{'gateway':'cointopay','status':_0x290dec(0x21c),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x14dc5a[_0x290dec(0x212)]===0x0){console[_0x290dec(0x259)]('ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}console[_0x290dec(0x259)](_0x290dec(0x27b)+_0x14dc5a['length']+_0x290dec(0x21f));const _0x1ba7be=await this[_0x290dec(0x22f)](_0x14dc5a);console[_0x290dec(0x259)]('â°\x20Found\x20'+_0x1ba7be[_0x290dec(0x212)]+_0x290dec(0x25c));for(const _0x281460 of _0x14dc5a){try{if(_0x1ba7be[_0x290dec(0x1fe)](_0x281460['id'])){console[_0x290dec(0x259)](_0x290dec(0x21e)+_0x281460['id']+_0x290dec(0x1fb));continue;}await this[_0x290dec(0x20c)](_0x281460),await new Promise(_0x26231e=>setTimeout(_0x26231e,0x7d0));}catch(_0x3e7baf){console[_0x290dec(0x228)](_0x290dec(0x240)+_0x281460['id']+':',_0x3e7baf),loggerService_1[_0x290dec(0x207)][_0x290dec(0x20d)]('cointopay',_0x290dec(0x24e)+_0x281460[_0x290dec(0x245)],_0x3e7baf);}}console[_0x290dec(0x259)](_0x290dec(0x270)+_0x14dc5a[_0x290dec(0x212)]+_0x290dec(0x256));}catch(_0x1250f1){console['error'](_0x290dec(0x258),_0x1250f1);}}async[a35_0xe78e85(0x22f)](_0x32032b){const _0x57dda6=a35_0xe78e85,_0x16a61c=[],_0x2fd69d=new Date();_0x2fd69d[_0x57dda6(0x218)](_0x2fd69d['getDate']()-this[_0x57dda6(0x254)]),console['log'](_0x57dda6(0x279)+this[_0x57dda6(0x254)]+_0x57dda6(0x1fa)+_0x2fd69d[_0x57dda6(0x230)]()+')');for(const _0x5717c2 of _0x32032b){if(_0x5717c2[_0x57dda6(0x202)]<_0x2fd69d){console[_0x57dda6(0x259)](_0x57dda6(0x21e)+_0x5717c2['id']+_0x57dda6(0x20f)+this[_0x57dda6(0x254)]+_0x57dda6(0x251));try{await database_1[_0x57dda6(0x216)]['payment'][_0x57dda6(0x22e)]({'where':{'id':_0x5717c2['id']},'data':{'status':_0x57dda6(0x26f),'updatedAt':new Date(),'adminNotes':_0x57dda6(0x241)+this[_0x57dda6(0x254)]+_0x57dda6(0x1f9)}}),await database_1[_0x57dda6(0x216)]['webhookLog'][_0x57dda6(0x234)]({'data':{'paymentId':_0x5717c2['id'],'shopId':_0x5717c2[_0x57dda6(0x27e)],'event':_0x57dda6(0x1ff),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x57dda6(0x273)+this[_0x57dda6(0x254)]+'\x20days','createdAt':_0x5717c2[_0x57dda6(0x202)],'expiredAt':new Date()[_0x57dda6(0x230)](),'daysSinceCreation':Math['floor']((Date[_0x57dda6(0x275)]()-_0x5717c2['createdAt'][_0x57dda6(0x239)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x57dda6(0x23b)](_0x5717c2,'EXPIRED'),await this[_0x57dda6(0x1f1)](_0x5717c2,_0x57dda6(0x26f)),_0x16a61c['push'](_0x5717c2['id']),console['log'](_0x57dda6(0x1fd)+_0x5717c2['id']+_0x57dda6(0x1f5)+this[_0x57dda6(0x254)]+_0x57dda6(0x210));}catch(_0x593c3c){console[_0x57dda6(0x228)](_0x57dda6(0x232)+_0x5717c2['id']+':',_0x593c3c);}}}return _0x16a61c;}async['checkSinglePayment'](_0x5e3b5a){const _0x5cc9fd=a35_0xe78e85;if(!_0x5e3b5a[_0x5cc9fd(0x245)]){console[_0x5cc9fd(0x259)](_0x5cc9fd(0x267)+_0x5e3b5a['id']+_0x5cc9fd(0x277));return;}console[_0x5cc9fd(0x259)]('ðŸ”\x20Checking\x20CoinToPay\x20payment\x20'+_0x5e3b5a['id']+'\x20('+_0x5e3b5a[_0x5cc9fd(0x245)]+')');try{const _0x21f5a1=await this['coinToPayService'][_0x5cc9fd(0x231)](_0x5e3b5a[_0x5cc9fd(0x245)]);console[_0x5cc9fd(0x259)](_0x5cc9fd(0x236)+_0x5e3b5a['id']+_0x5cc9fd(0x263)+_0x21f5a1['status']);_0x21f5a1[_0x5cc9fd(0x1f0)]&&console[_0x5cc9fd(0x259)]('ðŸ“Š\x20Payment\x20'+_0x5e3b5a['id']+_0x5cc9fd(0x27a),{'iban':_0x21f5a1[_0x5cc9fd(0x1f0)]['iban']||_0x5cc9fd(0x1f4),'transactionId':_0x21f5a1[_0x5cc9fd(0x1f0)][_0x5cc9fd(0x268)],'createdOn':_0x21f5a1['paymentDetails'][_0x5cc9fd(0x209)],'confirmedOn':_0x21f5a1[_0x5cc9fd(0x1f0)][_0x5cc9fd(0x260)]||_0x5cc9fd(0x215)});if(_0x21f5a1[_0x5cc9fd(0x225)]!==_0x5e3b5a['status']){console[_0x5cc9fd(0x259)]('ðŸ”„\x20Updating\x20payment\x20'+_0x5e3b5a['id']+_0x5cc9fd(0x21b)+_0x5e3b5a[_0x5cc9fd(0x225)]+_0x5cc9fd(0x242)+_0x21f5a1[_0x5cc9fd(0x225)]);const _0x2fc8e0={'status':_0x21f5a1['status'],'updatedAt':new Date()};_0x21f5a1['status']===_0x5cc9fd(0x252)&&_0x5e3b5a[_0x5cc9fd(0x225)]!==_0x5cc9fd(0x252)&&(_0x2fc8e0['paidAt']=new Date(),console['log'](_0x5cc9fd(0x221)+_0x5e3b5a['id']+_0x5cc9fd(0x272)+_0x2fc8e0[_0x5cc9fd(0x224)]['toISOString']()));if(_0x21f5a1[_0x5cc9fd(0x1f0)]){const _0x536af6=_0x21f5a1[_0x5cc9fd(0x1f0)];_0x536af6[_0x5cc9fd(0x227)]&&(_0x2fc8e0['remitterIban']=_0x536af6[_0x5cc9fd(0x227)],console['log'](_0x5cc9fd(0x274)+_0x536af6[_0x5cc9fd(0x227)]));if(_0x536af6[_0x5cc9fd(0x266)]){const _0x19a270=_0x5e3b5a['adminNotes']||'',_0x551830=_0x5cc9fd(0x237)+_0x536af6[_0x5cc9fd(0x266)];_0x2fc8e0[_0x5cc9fd(0x1fc)]=_0x19a270?_0x19a270+'\x0a\x0a'+_0x551830:_0x551830,console['log'](_0x5cc9fd(0x25d));}_0x536af6[_0x5cc9fd(0x268)]&&console[_0x5cc9fd(0x259)](_0x5cc9fd(0x249)+_0x536af6['transactionId']),_0x536af6[_0x5cc9fd(0x260)]&&console[_0x5cc9fd(0x259)](_0x5cc9fd(0x1f2)+_0x536af6['confirmedOn']);}await database_1[_0x5cc9fd(0x216)][_0x5cc9fd(0x281)]['update']({'where':{'id':_0x5e3b5a['id']},'data':_0x2fc8e0}),await database_1[_0x5cc9fd(0x216)][_0x5cc9fd(0x238)][_0x5cc9fd(0x234)]({'data':{'paymentId':_0x5e3b5a['id'],'shopId':_0x5e3b5a[_0x5cc9fd(0x27e)],'event':_0x5cc9fd(0x25e)+_0x21f5a1[_0x5cc9fd(0x225)][_0x5cc9fd(0x21d)](),'statusCode':0xc8,'responseBody':JSON[_0x5cc9fd(0x201)]({'oldStatus':_0x5e3b5a[_0x5cc9fd(0x225)],'newStatus':_0x21f5a1[_0x5cc9fd(0x225)],'paymentDetails':_0x21f5a1[_0x5cc9fd(0x1f0)],'checkedAt':new Date()[_0x5cc9fd(0x230)]()})}}),await this[_0x5cc9fd(0x23b)](_0x5e3b5a,_0x21f5a1[_0x5cc9fd(0x225)]),await this[_0x5cc9fd(0x1f1)](_0x5e3b5a,_0x21f5a1[_0x5cc9fd(0x225)]),console['log'](_0x5cc9fd(0x1fd)+_0x5e3b5a['id']+_0x5cc9fd(0x24d));}else console[_0x5cc9fd(0x259)]('ðŸ“Š\x20Payment\x20'+_0x5e3b5a['id']+_0x5cc9fd(0x22b)+_0x21f5a1[_0x5cc9fd(0x225)]+')');}catch(_0x5b117d){console[_0x5cc9fd(0x228)](_0x5cc9fd(0x26b)+_0x5e3b5a['id']+':',_0x5b117d),await database_1[_0x5cc9fd(0x216)][_0x5cc9fd(0x238)][_0x5cc9fd(0x234)]({'data':{'paymentId':_0x5e3b5a['id'],'shopId':_0x5e3b5a[_0x5cc9fd(0x27e)],'event':_0x5cc9fd(0x253),'statusCode':0x1f4,'responseBody':JSON[_0x5cc9fd(0x201)]({'error':_0x5b117d instanceof Error?_0x5b117d[_0x5cc9fd(0x217)]:_0x5cc9fd(0x262),'gatewayPaymentId':_0x5e3b5a[_0x5cc9fd(0x245)],'checkedAt':new Date()[_0x5cc9fd(0x230)]()})}});}}async[a35_0xe78e85(0x23b)](_0x2cb0a8,_0xbe8974){const _0x3c7fbf=a35_0xe78e85,_0x5d8d19=Date[_0x3c7fbf(0x275)]();try{const _0x4e86bf=_0x2cb0a8['shop'],_0x375c7a=_0x4e86bf[_0x3c7fbf(0x20a)];if(!_0x375c7a?.[_0x3c7fbf(0x20e)]){console[_0x3c7fbf(0x259)](_0x3c7fbf(0x255)+_0x4e86bf['id']);return;}const _0x16c4be=_0xbe8974==='PAID'?_0x3c7fbf(0x206):_0xbe8974===_0x3c7fbf(0x23e)?_0x3c7fbf(0x24f):_0xbe8974==='EXPIRED'?_0x3c7fbf(0x24f):_0x3c7fbf(0x1f7);if(!_0x375c7a[_0x3c7fbf(0x208)]?.['includes'](_0x16c4be)){console[_0x3c7fbf(0x259)](_0x3c7fbf(0x264)+_0x16c4be+_0x3c7fbf(0x21a)+_0x4e86bf['id']);return;}const _0x349c88={'event':_0x16c4be,'payment':{'id':_0x2cb0a8['id'],'order_id':_0x2cb0a8[_0x3c7fbf(0x1ef)],'gateway_order_id':_0x2cb0a8['gatewayOrderId'],'gateway':_0x3c7fbf(0x22c),'amount':_0x2cb0a8[_0x3c7fbf(0x23c)],'currency':_0x2cb0a8['currency'],'status':_0xbe8974['toLowerCase'](),'customer_email':_0x2cb0a8[_0x3c7fbf(0x244)],'customer_name':_0x2cb0a8[_0x3c7fbf(0x22a)],'created_at':_0x2cb0a8['createdAt'],'updated_at':new Date()}},_0x341286=await fetch(_0x375c7a[_0x3c7fbf(0x20e)],{'method':_0x3c7fbf(0x214),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x3c7fbf(0x201)](_0x349c88)}),_0x2adfea=Date[_0x3c7fbf(0x275)]()-_0x5d8d19,_0x239493=_0x341286['ok']?_0x3c7fbf(0x248):await _0x341286[_0x3c7fbf(0x276)]();loggerService_1['loggerService'][_0x3c7fbf(0x27d)](_0x2cb0a8[_0x3c7fbf(0x27e)],_0x375c7a[_0x3c7fbf(0x20e)],_0x16c4be,_0x341286[_0x3c7fbf(0x225)],_0x2adfea,_0x349c88),console[_0x3c7fbf(0x259)]('Shop\x20webhook\x20sent\x20to\x20'+_0x375c7a[_0x3c7fbf(0x20e)]+'\x20with\x20status\x20'+_0x341286[_0x3c7fbf(0x225)]+'\x20('+_0x2adfea+'ms)');}catch(_0x526dcc){console[_0x3c7fbf(0x228)](_0x3c7fbf(0x24c),_0x526dcc),loggerService_1[_0x3c7fbf(0x207)]['logShopWebhookError'](_0x2cb0a8[_0x3c7fbf(0x27e)],_0x2cb0a8['shop']?.[_0x3c7fbf(0x20a)]?.[_0x3c7fbf(0x20e)]||_0x3c7fbf(0x280),_0x3c7fbf(0x269),_0x526dcc,{});}}async['sendPaymentStatusNotification'](_0x2fb25d,_0x5b3ed5){const _0x2acbc4=a35_0xe78e85;try{const _0x51630e={'PENDING':_0x2acbc4(0x24b),'PAID':_0x2acbc4(0x26d),'FAILED':_0x2acbc4(0x22d),'EXPIRED':_0x2acbc4(0x23f)},_0x5a3544=_0x51630e[_0x5b3ed5];if(!_0x5a3544||_0x5a3544==='created')return;await telegramBotService_1[_0x2acbc4(0x23a)]['sendPaymentNotification'](_0x2fb25d[_0x2acbc4(0x27e)],_0x2fb25d,_0x5a3544);}catch(_0x1fc9c2){console['error'](_0x2acbc4(0x1f3),_0x1fc9c2);}}async[a35_0xe78e85(0x1f6)](_0x28cc18){const _0x19a17a=a35_0xe78e85,_0x52b575=await database_1[_0x19a17a(0x216)][_0x19a17a(0x281)][_0x19a17a(0x27c)]({'where':{'id':_0x28cc18},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x52b575)throw new Error(_0x19a17a(0x26e));if(_0x52b575[_0x19a17a(0x247)]!=='cointopay')throw new Error(_0x19a17a(0x233));await this['checkSinglePayment'](_0x52b575);}[a35_0xe78e85(0x229)](){const _0x202bab=a35_0xe78e85,_0x1f0547=this[_0x202bab(0x265)]?this[_0x202bab(0x222)]:undefined;return{'isActive':!!this[_0x202bab(0x265)],'checkIntervalMinutes':this[_0x202bab(0x222)]/(0x3e8*0x3c),'expiryDays':this[_0x202bab(0x254)],'nextCheckIn':_0x1f0547};}}exports[a35_0xe78e85(0x223)]=CoinToPayStatusService,exports[a35_0xe78e85(0x25f)]=new CoinToPayStatusService();