'use strict';const a35_0x15cb3e=a35_0x3c7d;(function(_0x1fb5ae,_0x27cb21){const _0x58b231=a35_0x3c7d,_0x5b37c0=_0x1fb5ae();while(!![]){try{const _0x2ce099=parseInt(_0x58b231(0xce))/0x1*(-parseInt(_0x58b231(0xae))/0x2)+parseInt(_0x58b231(0xda))/0x3*(parseInt(_0x58b231(0x127))/0x4)+-parseInt(_0x58b231(0xd8))/0x5+parseInt(_0x58b231(0x12e))/0x6*(-parseInt(_0x58b231(0xc2))/0x7)+-parseInt(_0x58b231(0x125))/0x8+-parseInt(_0x58b231(0xfa))/0x9+parseInt(_0x58b231(0xdc))/0xa;if(_0x2ce099===_0x27cb21)break;else _0x5b37c0['push'](_0x5b37c0['shift']());}catch(_0x1ba711){_0x5b37c0['push'](_0x5b37c0['shift']());}}}(a35_0x2aac,0x96258));function a35_0x3c7d(_0x396b10,_0x460fc6){const _0x2aacdf=a35_0x2aac();return a35_0x3c7d=function(_0x3c7d17,_0x2e2f5f){_0x3c7d17=_0x3c7d17-0xa4;let _0x48a99d=_0x2aacdf[_0x3c7d17];return _0x48a99d;},a35_0x3c7d(_0x396b10,_0x460fc6);}function a35_0x2aac(){const _0x1984a3=['telegramBotService','6865776vMQbaW','toISOString','update','ü™ô\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','EXPIRED','checkInterval','cointopay_auto_expired','\x20days,\x20marking\x20as\x20EXPIRED','\x20\x20\x20‚ùå\x20Error:\x20','‚úÖ\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','Automatically\x20expired\x20after\x20','Success','CoinToPayStatusService','üí∞\x20Payment\x20','\x20expired\x20CoinToPay\x20payments','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','coinToPayService','stringify','adminNotes','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','Failed\x20to\x20send\x20shop\x20webhook:','Webhook\x20event\x20','currency','EXPIRY_DAYS','logCoinToPayError','webhookUrl','CoinToPayService','default','webhookEvents','payment','log','stack','cointopay','customerName','TesSoft\x20Payment\x20System/1.0','ü™ô\x20CoinToPay\x20Error:\x20','checkPaymentStatus','/status/','payment.failed','./telegramBotService','cointopay_status_check_','timestamp','startPeriodicStatusCheck','33032QRaDhW','error','200924nrgxvb','defineProperty','‚ö†Ô∏è\x20Payment\x20','\x20days','\x20with\x20status\x20','\x20\x20\x20üìÖ\x20Time:\x20','__importDefault','30zBhCBo','logShopWebhookSent','checkSinglePayment','createdAt','application/json','Failed\x20to\x20expire\x20payment\x20','created','paidAt','0100','‚úÖ\x20Transaction\x20confirmed\x20on:\x20','not\x20confirmed','setDate','payment.success','Periodic\x20CoinToPay\x20status\x20check\x20failed:','transactionId','\x20\x20\x20üìù\x20Context:','sendShopWebhook','getDate','1296194msvvud','loggerService','üîÑ\x20Updating\x20payment\x20','amount','\x20pending\x20CoinToPay\x20payments','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','length','confirmedOn','üìä\x20Payment\x20','ü™ô\x20CoinToPay\x20Status\x20Change:\x20','iban','settings','auto_expire','checkAllPendingPayments','\x20\x20\x20üìä\x20Status:\x20','Bank\x20Details:\x20','findUnique','\x20\x20\x20üìù\x20Details:','gatewayPaymentId','status_check','890799PFcWjr','\x20status:\x20','\x20status\x20unchanged\x20(','‚è∞\x20Payment\x20','ü™ô\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','toLowerCase','coinToPayStatusService','Shop\x20webhook\x20sent\x20to\x20','sendPaymentStatusNotification','Unknown\x20error','now','message','1SDxqvh','gatewayOrderId','customerEmail','Initial\x20CoinToPay\x20status\x20check\x20failed:','failed','COINTOPAY_STATUS_CHANGE','üè¶\x20Saved\x20IBAN:\x20','create','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','paid','1564735KyBGny','POST','39iMtdCR','__esModule','23263190QIrHsA','‚úÖ\x20Completed\x20checking\x20','webhook_send','\x20to\x20','‚úÖ\x20Payment\x20','logCoinToPayStatus','PAID','gateway','COINTOPAY_ERROR','\x20marked\x20as\x20paid\x20at:\x20','CHECK_INTERVAL_MS','./loggerService','\x20has\x20no\x20gatewayPaymentId,\x20skipping','floor','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','./gateways/coinToPayService','ü™ô\x20Checking\x20','\x20not\x20enabled\x20for\x20shop\x20','shopId','logShopWebhookError','üîç\x20Checking\x20CoinToPay\x20payment\x20','status','sendPaymentNotification','createdOn','includes','paymentDetails','unknown','getTime','\x20\x20\x20üìç\x20Source:\x20'];a35_0x2aac=function(){return _0x1984a3;};return a35_0x2aac();}var __importDefault=this&&this[a35_0x15cb3e(0x12d)]||function(_0x4121d7){const _0x310966=a35_0x15cb3e;return _0x4121d7&&_0x4121d7[_0x310966(0xdb)]?_0x4121d7:{'default':_0x4121d7};};Object[a35_0x15cb3e(0x128)](exports,'__esModule',{'value':!![]}),exports[a35_0x15cb3e(0xc8)]=exports[a35_0x15cb3e(0x106)]=void 0x0;const coinToPayService_1=require(a35_0x15cb3e(0xeb)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a35_0x15cb3e(0x121)),loggerService_1=require(a35_0x15cb3e(0xe7));class CoinToPayStatusService{constructor(){const _0x1e3569=a35_0x15cb3e;this['checkInterval']=null,this[_0x1e3569(0xe6)]=0x3c*0x3c*0x3e8,this[_0x1e3569(0x111)]=0x5,this[_0x1e3569(0x10a)]=new coinToPayService_1[(_0x1e3569(0x114))]();}[a35_0x15cb3e(0xe1)](_0x1356e4,_0x2c154b,_0x2a2f9f,_0x2e5c4b,_0x16e8ed,_0x4fa5de){const _0x1d276f=a35_0x15cb3e,_0x1757de={'type':_0x1d276f(0xd3),'paymentId':_0x1356e4,'gatewayPaymentId':_0x2c154b,'oldStatus':_0x2a2f9f,'newStatus':_0x2e5c4b,'source':_0x16e8ed,'timestamp':new Date()['toISOString'](),'details':_0x4fa5de||{}};loggerService_1['loggerService'][_0x1d276f(0xe1)](_0x1757de),console[_0x1d276f(0x118)](_0x1d276f(0xb7)+_0x1356e4+'\x20('+_0x2c154b+')'),console[_0x1d276f(0x118)](_0x1d276f(0xbc)+_0x2a2f9f+'\x20->\x20'+_0x2e5c4b),console[_0x1d276f(0x118)](_0x1d276f(0xf8)+_0x16e8ed),console[_0x1d276f(0x118)](_0x1d276f(0x12c)+_0x1757de[_0x1d276f(0x123)]),_0x4fa5de&&console['log'](_0x1d276f(0xbf),_0x4fa5de);}[a35_0x15cb3e(0x112)](_0x437198,_0x1cdbfc,_0x2315ed,_0x31f71e,_0x1032b7){const _0x170f14=a35_0x15cb3e,_0x5e5b9b={'type':_0x170f14(0xe4),'paymentId':_0x437198,'gatewayPaymentId':_0x1cdbfc,'error':_0x2315ed instanceof Error?{'message':_0x2315ed['message'],'stack':_0x2315ed[_0x170f14(0x119)]}:_0x2315ed,'source':_0x31f71e,'timestamp':new Date()[_0x170f14(0xfb)](),'context':_0x1032b7||{}};loggerService_1[_0x170f14(0xaf)][_0x170f14(0x112)](_0x5e5b9b),console['error'](_0x170f14(0x11d)+_0x437198+'\x20('+_0x1cdbfc+')'),console[_0x170f14(0x126)](_0x170f14(0x102)+(_0x2315ed instanceof Error?_0x2315ed[_0x170f14(0xcd)]:_0x2315ed)),console[_0x170f14(0x126)]('\x20\x20\x20üìç\x20Source:\x20'+_0x31f71e),console[_0x170f14(0x126)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x5e5b9b[_0x170f14(0x123)]),_0x1032b7&&console[_0x170f14(0x126)](_0x170f14(0xab),_0x1032b7);}[a35_0x15cb3e(0x124)](){const _0x39847f=a35_0x15cb3e;console['log'](_0x39847f(0xfd)),this[_0x39847f(0xbb)]()['catch'](_0x1037ed=>{const _0x7dc99d=_0x39847f;console[_0x7dc99d(0x126)](_0x7dc99d(0xd1),_0x1037ed);}),this['checkInterval']=setInterval(async()=>{const _0x4182be=_0x39847f;try{await this[_0x4182be(0xbb)]();}catch(_0x51553a){console[_0x4182be(0x126)](_0x4182be(0xa9),_0x51553a);}},this[_0x39847f(0xe6)]),console[_0x39847f(0x118)](_0x39847f(0x103));}['stopPeriodicStatusCheck'](){const _0x1926ea=a35_0x15cb3e;this[_0x1926ea(0xff)]&&(clearInterval(this[_0x1926ea(0xff)]),this['checkInterval']=null,console[_0x1926ea(0x118)]('üõë\x20CoinToPay\x20status\x20checking\x20stopped'));}async[a35_0x15cb3e(0xbb)](){const _0x30bbc6=a35_0x15cb3e;try{const _0xe62abd=await database_1['default'][_0x30bbc6(0x117)]['findMany']({'where':{'gateway':'cointopay','status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0xe62abd[_0x30bbc6(0xb4)]===0x0){console[_0x30bbc6(0x118)](_0x30bbc6(0xc6));return;}console[_0x30bbc6(0x118)](_0x30bbc6(0xec)+_0xe62abd[_0x30bbc6(0xb4)]+_0x30bbc6(0xb2));const _0x5f49fc=await this['checkExpiredPayments'](_0xe62abd);console[_0x30bbc6(0x118)]('‚è∞\x20Found\x20'+_0x5f49fc[_0x30bbc6(0xb4)]+_0x30bbc6(0x108));for(const _0x35db37 of _0xe62abd){try{if(_0x5f49fc[_0x30bbc6(0xf4)](_0x35db37['id'])){console[_0x30bbc6(0x118)](_0x30bbc6(0xc5)+_0x35db37['id']+_0x30bbc6(0xd6));continue;}await this[_0x30bbc6(0x130)](_0x35db37),await new Promise(_0x437801=>setTimeout(_0x437801,0x7d0));}catch(_0xeffc87){console['error'](_0x30bbc6(0xea)+_0x35db37['id']+':',_0xeffc87),this['logCoinToPayError'](_0x35db37['id'],_0x35db37[_0x30bbc6(0xc0)]||_0x30bbc6(0xf6),_0xeffc87,'status_check',{'paymentAmount':_0x35db37[_0x30bbc6(0xb1)],'paymentCurrency':_0x35db37[_0x30bbc6(0x110)],'shopId':_0x35db37[_0x30bbc6(0xee)],'createdAt':_0x35db37[_0x30bbc6(0x131)]}),loggerService_1['loggerService']['logWhiteDomainError']('cointopay',_0x30bbc6(0x11f)+_0x35db37[_0x30bbc6(0xc0)],_0xeffc87);}}console[_0x30bbc6(0x118)](_0x30bbc6(0xdd)+_0xe62abd[_0x30bbc6(0xb4)]+'\x20CoinToPay\x20payments');}catch(_0x30cfb1){console['error'](_0x30bbc6(0x10d),_0x30cfb1);}}async['checkExpiredPayments'](_0x5c83ec){const _0x3f031f=a35_0x15cb3e,_0x43d617=[],_0x2a7e5b=new Date();_0x2a7e5b[_0x3f031f(0xa7)](_0x2a7e5b[_0x3f031f(0xad)]()-this[_0x3f031f(0x111)]),console[_0x3f031f(0x118)]('‚è∞\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x3f031f(0x111)]+'\x20days\x20(created\x20before\x20'+_0x2a7e5b[_0x3f031f(0xfb)]()+')');for(const _0x4f1982 of _0x5c83ec){if(_0x4f1982[_0x3f031f(0x131)]<_0x2a7e5b){console['log'](_0x3f031f(0xc5)+_0x4f1982['id']+'\x20is\x20older\x20than\x20'+this[_0x3f031f(0x111)]+_0x3f031f(0x101));try{this[_0x3f031f(0xe1)](_0x4f1982['id'],_0x4f1982[_0x3f031f(0xc0)]||_0x3f031f(0xf6),'PENDING',_0x3f031f(0xfe),_0x3f031f(0xba),{'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x3f031f(0x12a),'createdAt':_0x4f1982['createdAt'],'daysSinceCreation':Math[_0x3f031f(0xe9)]((Date[_0x3f031f(0xcc)]()-_0x4f1982[_0x3f031f(0x131)][_0x3f031f(0xf7)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x4f1982['amount'],'paymentCurrency':_0x4f1982[_0x3f031f(0x110)],'shopId':_0x4f1982[_0x3f031f(0xee)]}),await database_1[_0x3f031f(0x115)][_0x3f031f(0x117)][_0x3f031f(0xfc)]({'where':{'id':_0x4f1982['id']},'data':{'status':_0x3f031f(0xfe),'updatedAt':new Date(),'adminNotes':_0x3f031f(0x104)+this[_0x3f031f(0x111)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x3f031f(0x115)]['webhookLog'][_0x3f031f(0xd5)]({'data':{'paymentId':_0x4f1982['id'],'shopId':_0x4f1982[_0x3f031f(0xee)],'event':_0x3f031f(0x100),'statusCode':0xc8,'responseBody':JSON[_0x3f031f(0x10b)]({'reason':'Payment\x20older\x20than\x20'+this[_0x3f031f(0x111)]+_0x3f031f(0x12a),'createdAt':_0x4f1982['createdAt'],'expiredAt':new Date()[_0x3f031f(0xfb)](),'daysSinceCreation':Math[_0x3f031f(0xe9)]((Date[_0x3f031f(0xcc)]()-_0x4f1982[_0x3f031f(0x131)][_0x3f031f(0xf7)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x3f031f(0xac)](_0x4f1982,_0x3f031f(0xfe)),await this['sendPaymentStatusNotification'](_0x4f1982,_0x3f031f(0xfe)),_0x43d617['push'](_0x4f1982['id']),console[_0x3f031f(0x118)](_0x3f031f(0xe0)+_0x4f1982['id']+_0x3f031f(0xb3)+this[_0x3f031f(0x111)]+'-day\x20timeout');}catch(_0x46bf32){console[_0x3f031f(0x126)](_0x3f031f(0x133)+_0x4f1982['id']+':',_0x46bf32),this[_0x3f031f(0x112)](_0x4f1982['id'],_0x4f1982[_0x3f031f(0xc0)]||'unknown',_0x46bf32,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x4f1982[_0x3f031f(0x131)],'daysSinceCreation':Math[_0x3f031f(0xe9)]((Date[_0x3f031f(0xcc)]()-_0x4f1982[_0x3f031f(0x131)][_0x3f031f(0xf7)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x43d617;}async[a35_0x15cb3e(0x130)](_0x22b034){const _0x59d8ea=a35_0x15cb3e;if(!_0x22b034[_0x59d8ea(0xc0)]){console['log'](_0x59d8ea(0x129)+_0x22b034['id']+_0x59d8ea(0xe8));return;}console[_0x59d8ea(0x118)](_0x59d8ea(0xf0)+_0x22b034['id']+'\x20('+_0x22b034[_0x59d8ea(0xc0)]+')');try{const _0x1c2674=await this['coinToPayService'][_0x59d8ea(0x11e)](_0x22b034[_0x59d8ea(0xc0)]);console[_0x59d8ea(0x118)](_0x59d8ea(0xb6)+_0x22b034['id']+_0x59d8ea(0xc3)+_0x1c2674[_0x59d8ea(0xf1)]);_0x1c2674[_0x59d8ea(0xf5)]&&console[_0x59d8ea(0x118)]('üìä\x20Payment\x20'+_0x22b034['id']+'\x20details:',{'iban':_0x1c2674[_0x59d8ea(0xf5)][_0x59d8ea(0xb8)]||'not\x20found','transactionId':_0x1c2674[_0x59d8ea(0xf5)][_0x59d8ea(0xaa)],'createdOn':_0x1c2674[_0x59d8ea(0xf5)][_0x59d8ea(0xf3)],'confirmedOn':_0x1c2674['paymentDetails']['confirmedOn']||_0x59d8ea(0xa6)});if(_0x1c2674['status']!==_0x22b034[_0x59d8ea(0xf1)]){console['log'](_0x59d8ea(0xb0)+_0x22b034['id']+'\x20status\x20from\x20'+_0x22b034[_0x59d8ea(0xf1)]+_0x59d8ea(0xdf)+_0x1c2674[_0x59d8ea(0xf1)]),this[_0x59d8ea(0xe1)](_0x22b034['id'],_0x22b034[_0x59d8ea(0xc0)],_0x22b034[_0x59d8ea(0xf1)],_0x1c2674[_0x59d8ea(0xf1)],'status_check',{'paymentDetails':_0x1c2674[_0x59d8ea(0xf5)],'amount':_0x1c2674['amount'],'currency':_0x1c2674[_0x59d8ea(0x110)],'shopId':_0x22b034[_0x59d8ea(0xee)],'checkTimestamp':new Date()[_0x59d8ea(0xfb)]()});const _0x4f4f73={'status':_0x1c2674[_0x59d8ea(0xf1)],'updatedAt':new Date()};_0x1c2674[_0x59d8ea(0xf1)]===_0x59d8ea(0xe2)&&_0x22b034[_0x59d8ea(0xf1)]!==_0x59d8ea(0xe2)&&(_0x4f4f73[_0x59d8ea(0x135)]=new Date(),console['log'](_0x59d8ea(0x107)+_0x22b034['id']+_0x59d8ea(0xe5)+_0x4f4f73['paidAt'][_0x59d8ea(0xfb)]()));if(_0x1c2674[_0x59d8ea(0xf5)]){const _0x1d895c=_0x1c2674[_0x59d8ea(0xf5)];_0x1d895c[_0x59d8ea(0xb8)]&&(_0x4f4f73['remitterIban']=_0x1d895c['iban'],console['log'](_0x59d8ea(0xd4)+_0x1d895c[_0x59d8ea(0xb8)]));if(_0x1d895c['bankDetails']){const _0x2da3dd=_0x22b034[_0x59d8ea(0x10c)]||'',_0x5abe64=_0x59d8ea(0xbd)+_0x1d895c['bankDetails'];_0x4f4f73[_0x59d8ea(0x10c)]=_0x2da3dd?_0x2da3dd+'\x0a\x0a'+_0x5abe64:_0x5abe64,console[_0x59d8ea(0x118)]('üè¶\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x1d895c[_0x59d8ea(0xaa)]&&console[_0x59d8ea(0x118)]('üÜî\x20Transaction\x20ID:\x20'+_0x1d895c[_0x59d8ea(0xaa)]),_0x1d895c[_0x59d8ea(0xb5)]&&console[_0x59d8ea(0x118)](_0x59d8ea(0xa5)+_0x1d895c[_0x59d8ea(0xb5)]);}await database_1[_0x59d8ea(0x115)][_0x59d8ea(0x117)][_0x59d8ea(0xfc)]({'where':{'id':_0x22b034['id']},'data':_0x4f4f73}),await database_1[_0x59d8ea(0x115)]['webhookLog']['create']({'data':{'paymentId':_0x22b034['id'],'shopId':_0x22b034[_0x59d8ea(0xee)],'event':_0x59d8ea(0x122)+_0x1c2674[_0x59d8ea(0xf1)][_0x59d8ea(0xc7)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x22b034['status'],'newStatus':_0x1c2674[_0x59d8ea(0xf1)],'paymentDetails':_0x1c2674[_0x59d8ea(0xf5)],'checkedAt':new Date()[_0x59d8ea(0xfb)]()})}}),await this['sendShopWebhook'](_0x22b034,_0x1c2674[_0x59d8ea(0xf1)]),await this['sendPaymentStatusNotification'](_0x22b034,_0x1c2674[_0x59d8ea(0xf1)]),console[_0x59d8ea(0x118)]('‚úÖ\x20Payment\x20'+_0x22b034['id']+'\x20updated\x20successfully');}else console[_0x59d8ea(0x118)](_0x59d8ea(0xb6)+_0x22b034['id']+_0x59d8ea(0xc4)+_0x1c2674[_0x59d8ea(0xf1)]+')'),this[_0x59d8ea(0xe1)](_0x22b034['id'],_0x22b034[_0x59d8ea(0xc0)],_0x22b034[_0x59d8ea(0xf1)],_0x1c2674['status'],_0x59d8ea(0xc1),{'statusUnchanged':!![],'paymentDetails':_0x1c2674[_0x59d8ea(0xf5)],'amount':_0x1c2674['amount'],'currency':_0x1c2674[_0x59d8ea(0x110)],'shopId':_0x22b034['shopId'],'checkTimestamp':new Date()[_0x59d8ea(0xfb)]()});}catch(_0x4a60be){console[_0x59d8ea(0x126)]('Failed\x20to\x20check\x20payment\x20'+_0x22b034['id']+':',_0x4a60be),this['logCoinToPayError'](_0x22b034['id'],_0x22b034[_0x59d8ea(0xc0)],_0x4a60be,'status_check',{'paymentAmount':_0x22b034[_0x59d8ea(0xb1)],'paymentCurrency':_0x22b034[_0x59d8ea(0x110)],'shopId':_0x22b034[_0x59d8ea(0xee)],'createdAt':_0x22b034[_0x59d8ea(0x131)]}),await database_1[_0x59d8ea(0x115)]['webhookLog']['create']({'data':{'paymentId':_0x22b034['id'],'shopId':_0x22b034[_0x59d8ea(0xee)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x59d8ea(0x10b)]({'error':_0x4a60be instanceof Error?_0x4a60be[_0x59d8ea(0xcd)]:_0x59d8ea(0xcb),'gatewayPaymentId':_0x22b034[_0x59d8ea(0xc0)],'checkedAt':new Date()[_0x59d8ea(0xfb)]()})}});}}async[a35_0x15cb3e(0xac)](_0x3b090d,_0x264036){const _0x4c5a73=a35_0x15cb3e,_0x34bb72=Date[_0x4c5a73(0xcc)]();try{const _0x184745=_0x3b090d['shop'],_0x3e0618=_0x184745[_0x4c5a73(0xb9)];if(!_0x3e0618?.[_0x4c5a73(0x113)]){console[_0x4c5a73(0x118)](_0x4c5a73(0x109)+_0x184745['id']);return;}const _0x41d415=_0x264036===_0x4c5a73(0xe2)?_0x4c5a73(0xa8):_0x264036==='FAILED'?_0x4c5a73(0x120):_0x264036===_0x4c5a73(0xfe)?_0x4c5a73(0x120):'payment.pending';if(!_0x3e0618[_0x4c5a73(0x116)]?.[_0x4c5a73(0xf4)](_0x41d415)){console[_0x4c5a73(0x118)](_0x4c5a73(0x10f)+_0x41d415+_0x4c5a73(0xed)+_0x184745['id']);return;}const _0x2f7f0a={'event':_0x41d415,'payment':{'id':_0x3b090d['id'],'order_id':_0x3b090d['orderId'],'gateway_order_id':_0x3b090d[_0x4c5a73(0xcf)],'gateway':_0x4c5a73(0xa4),'amount':_0x3b090d[_0x4c5a73(0xb1)],'currency':_0x3b090d[_0x4c5a73(0x110)],'status':_0x264036[_0x4c5a73(0xc7)](),'customer_email':_0x3b090d[_0x4c5a73(0xd0)],'customer_name':_0x3b090d[_0x4c5a73(0x11b)],'created_at':_0x3b090d[_0x4c5a73(0x131)],'updated_at':new Date()}},_0x1bd691=await fetch(_0x3e0618[_0x4c5a73(0x113)],{'method':_0x4c5a73(0xd9),'headers':{'Content-Type':_0x4c5a73(0x132),'User-Agent':_0x4c5a73(0x11c)},'body':JSON[_0x4c5a73(0x10b)](_0x2f7f0a)}),_0x5358ef=Date[_0x4c5a73(0xcc)]()-_0x34bb72,_0x29a813=_0x1bd691['ok']?_0x4c5a73(0x105):await _0x1bd691['text']();loggerService_1[_0x4c5a73(0xaf)][_0x4c5a73(0x12f)](_0x3b090d['shopId'],_0x3e0618[_0x4c5a73(0x113)],_0x41d415,_0x1bd691['status'],_0x5358ef,_0x2f7f0a),console[_0x4c5a73(0x118)](_0x4c5a73(0xc9)+_0x3e0618[_0x4c5a73(0x113)]+_0x4c5a73(0x12b)+_0x1bd691['status']+'\x20('+_0x5358ef+'ms)');}catch(_0x4287fc){console[_0x4c5a73(0x126)](_0x4c5a73(0x10e),_0x4287fc),loggerService_1[_0x4c5a73(0xaf)][_0x4c5a73(0xef)](_0x3b090d[_0x4c5a73(0xee)],_0x3b090d['shop']?.[_0x4c5a73(0xb9)]?.[_0x4c5a73(0x113)]||_0x4c5a73(0xf6),_0x4c5a73(0xde),_0x4287fc,{});}}async[a35_0x15cb3e(0xca)](_0x102fc0,_0x2f0241){const _0x1f9d70=a35_0x15cb3e;try{const _0x3fa2e3={'PENDING':_0x1f9d70(0x134),'PAID':_0x1f9d70(0xd7),'FAILED':_0x1f9d70(0xd2),'EXPIRED':'expired'},_0x2b1b02=_0x3fa2e3[_0x2f0241];if(!_0x2b1b02||_0x2b1b02===_0x1f9d70(0x134))return;await telegramBotService_1[_0x1f9d70(0xf9)][_0x1f9d70(0xf2)](_0x102fc0[_0x1f9d70(0xee)],_0x102fc0,_0x2b1b02);}catch(_0x2fa5da){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x2fa5da);}}async['checkPaymentById'](_0x33adee){const _0x46cc5b=a35_0x15cb3e,_0x55cdfd=await database_1[_0x46cc5b(0x115)][_0x46cc5b(0x117)][_0x46cc5b(0xbe)]({'where':{'id':_0x33adee},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x55cdfd)throw new Error('Payment\x20not\x20found');if(_0x55cdfd[_0x46cc5b(0xe3)]!==_0x46cc5b(0x11a))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');await this[_0x46cc5b(0x130)](_0x55cdfd);}['getServiceStats'](){const _0x310f53=a35_0x15cb3e,_0x3144ea=this[_0x310f53(0xff)]?this['CHECK_INTERVAL_MS']:undefined;return{'isActive':!!this[_0x310f53(0xff)],'checkIntervalMinutes':this[_0x310f53(0xe6)]/(0x3e8*0x3c),'expiryDays':this[_0x310f53(0x111)],'nextCheckIn':_0x3144ea};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a35_0x15cb3e(0xc8)]=new CoinToPayStatusService();