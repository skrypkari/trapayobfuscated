'use strict';const a35_0x32e5ae=a35_0x263a;(function(_0xe6e06d,_0x2cb9b8){const _0xcb2acd=a35_0x263a,_0x660b07=_0xe6e06d();while(!![]){try{const _0x264105=parseInt(_0xcb2acd(0x17f))/0x1+-parseInt(_0xcb2acd(0x186))/0x2+parseInt(_0xcb2acd(0x1ce))/0x3+parseInt(_0xcb2acd(0x15e))/0x4+-parseInt(_0xcb2acd(0x1a1))/0x5*(-parseInt(_0xcb2acd(0x199))/0x6)+-parseInt(_0xcb2acd(0x1c6))/0x7*(-parseInt(_0xcb2acd(0x19a))/0x8)+parseInt(_0xcb2acd(0x1c1))/0x9*(-parseInt(_0xcb2acd(0x1d4))/0xa);if(_0x264105===_0x2cb9b8)break;else _0x660b07['push'](_0x660b07['shift']());}catch(_0x35f64e){_0x660b07['push'](_0x660b07['shift']());}}}(a35_0xe492,0xcad22));var __importDefault=this&&this[a35_0x32e5ae(0x1a9)]||function(_0x2409b6){const _0x3db308=a35_0x32e5ae;return _0x2409b6&&_0x2409b6[_0x3db308(0x15b)]?_0x2409b6:{'default':_0x2409b6};};Object['defineProperty'](exports,a35_0x32e5ae(0x15b),{'value':!![]}),exports[a35_0x32e5ae(0x1af)]=exports['CoinToPayStatusService']=void 0x0;function a35_0xe492(){const _0x35503e=['createdOn','status','\x20has\x20no\x20gatewayPaymentId,\x20skipping','getServiceStats','ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped','Bank\x20Details:\x20','log','./telegramBotService','CHECK_INTERVAL_MS','stringify','__esModule','floor','paid','1256296uUIbPA','getDate','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','setDate','Success','sendPaymentStatusNotification','remitterIban','payment','\x20status\x20unchanged\x20(','FAILED','orderId','ðŸ¦\x20Saved\x20IBAN:\x20','toLowerCase','ðŸ“Š\x20Payment\x20','settings','unknown','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','ðŸ”\x20Checking\x20CoinToPay\x20payment\x20','sendPaymentNotification','\x20days,\x20marking\x20as\x20EXPIRED','default','ms)','\x20status\x20from\x20','update','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','\x20days\x20without\x20payment\x20confirmation','checkSinglePayment','EXPIRY_DAYS','Failed\x20to\x20expire\x20payment\x20','logShopWebhookError','cointopay_status_check_error','checkAllPendingPayments','â°\x20Payment\x20','760892PQSIBL','EXPIRED','create','now','customerEmail','toISOString','\x20with\x20status\x20','1317114dNkJOQ','length','Initial\x20CoinToPay\x20status\x20check\x20failed:','transactionId','shop','logWhiteDomainError','webhookUrl','CoinToPayService','currency','âœ…\x20Transaction\x20confirmed\x20on:\x20','coinToPayService','\x20is\x20older\x20than\x20','Failed\x20to\x20send\x20shop\x20webhook:','âš ï¸\x20Payment\x20','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','paymentDetails','Shop\x20webhook\x20sent\x20to\x20','âœ…\x20Payment\x20','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','95670FqQjgC','7976ajbKDm','Webhook\x20event\x20','âœ…\x20Completed\x20checking\x20','created','Unknown\x20error','PENDING','webhook_send','115ZykBTD','payment.failed','adminNotes','\x20marked\x20as\x20paid\x20at:\x20','-day\x20timeout','PAID','telegramBotService','\x20details:','__importDefault','webhookLog','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','includes','amount','checkInterval','coinToPayStatusService','./loggerService','0100','ðŸ”„\x20Updating\x20payment\x20','application/json','checkPaymentById','\x20days\x20(created\x20before\x20','not\x20confirmed','checkExpiredPayments','â°\x20Found\x20','startPeriodicStatusCheck','\x20to\x20','confirmedOn','ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','iban','paidAt','\x20days','sendShopWebhook','9VTtKTt','ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','webhookEvents','ðŸ’°\x20Payment\x20','gatewayPaymentId','11459aPSkWX','\x20status:\x20','\x20pending\x20CoinToPay\x20payments','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Failed\x20to\x20check\x20payment\x20','checkPaymentStatus','createdAt','ðŸª™\x20Checking\x20','1968084QtEtZD','stopPeriodicStatusCheck','getTime','cointopay_auto_expired','loggerService','/status/','22405070ALEdFO','shopId','cointopay','customerName','error','Failed\x20to\x20check\x20CoinToPay\x20payment\x20'];a35_0xe492=function(){return _0x35503e;};return a35_0xe492();}const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a35_0x32e5ae(0x158)),loggerService_1=require(a35_0x32e5ae(0x1b0));class CoinToPayStatusService{constructor(){const _0x11a394=a35_0x32e5ae;this['checkInterval']=null,this['CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x11a394(0x179)]=0x5,this['coinToPayService']=new coinToPayService_1[(_0x11a394(0x18d))]();}[a35_0x32e5ae(0x1b9)](){const _0x5cf781=a35_0x32e5ae;console[_0x5cf781(0x157)](_0x5cf781(0x194)),this[_0x5cf781(0x17d)]()['catch'](_0x924077=>{const _0x4240ff=_0x5cf781;console[_0x4240ff(0x1d8)](_0x4240ff(0x188),_0x924077);}),this['checkInterval']=setInterval(async()=>{const _0x3678e0=_0x5cf781;try{await this[_0x3678e0(0x17d)]();}catch(_0x1f3325){console[_0x3678e0(0x1d8)]('Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x1f3325);}},this[_0x5cf781(0x159)]),console['log']('âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)');}[a35_0x32e5ae(0x1cf)](){const _0x10f1a1=a35_0x32e5ae;this[_0x10f1a1(0x1ae)]&&(clearInterval(this[_0x10f1a1(0x1ae)]),this[_0x10f1a1(0x1ae)]=null,console[_0x10f1a1(0x157)](_0x10f1a1(0x155)));}async[a35_0x32e5ae(0x17d)](){const _0x4957c4=a35_0x32e5ae;try{const _0x570093=await database_1[_0x4957c4(0x172)][_0x4957c4(0x165)]['findMany']({'where':{'gateway':'cointopay','status':_0x4957c4(0x19f),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x570093[_0x4957c4(0x187)]===0x0){console[_0x4957c4(0x157)](_0x4957c4(0x1bc));return;}console[_0x4957c4(0x157)](_0x4957c4(0x1cd)+_0x570093[_0x4957c4(0x187)]+_0x4957c4(0x1c8));const _0x3c03e7=await this[_0x4957c4(0x1b7)](_0x570093);console['log'](_0x4957c4(0x1b8)+_0x3c03e7['length']+'\x20expired\x20CoinToPay\x20payments');for(const _0x4afcae of _0x570093){try{if(_0x3c03e7[_0x4957c4(0x1ac)](_0x4afcae['id'])){console[_0x4957c4(0x157)](_0x4957c4(0x17e)+_0x4afcae['id']+_0x4957c4(0x176));continue;}await this[_0x4957c4(0x178)](_0x4afcae),await new Promise(_0x15f927=>setTimeout(_0x15f927,0x7d0));}catch(_0x457537){console['error'](_0x4957c4(0x1d9)+_0x4afcae['id']+':',_0x457537),loggerService_1[_0x4957c4(0x1d2)][_0x4957c4(0x18b)](_0x4957c4(0x1d6),_0x4957c4(0x1d3)+_0x4afcae[_0x4957c4(0x1c5)],_0x457537);}}console['log'](_0x4957c4(0x19c)+_0x570093[_0x4957c4(0x187)]+'\x20CoinToPay\x20payments');}catch(_0x405821){console[_0x4957c4(0x1d8)]('Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x405821);}}async[a35_0x32e5ae(0x1b7)](_0x2b2a3d){const _0x10107b=a35_0x32e5ae,_0x381569=[],_0x340f12=new Date();_0x340f12[_0x10107b(0x161)](_0x340f12[_0x10107b(0x15f)]()-this[_0x10107b(0x179)]),console[_0x10107b(0x157)](_0x10107b(0x198)+this['EXPIRY_DAYS']+_0x10107b(0x1b5)+_0x340f12[_0x10107b(0x184)]()+')');for(const _0x350c5c of _0x2b2a3d){if(_0x350c5c[_0x10107b(0x1cc)]<_0x340f12){console[_0x10107b(0x157)](_0x10107b(0x17e)+_0x350c5c['id']+_0x10107b(0x191)+this[_0x10107b(0x179)]+_0x10107b(0x171));try{await database_1[_0x10107b(0x172)]['payment'][_0x10107b(0x175)]({'where':{'id':_0x350c5c['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x10107b(0x179)]+_0x10107b(0x177)}}),await database_1[_0x10107b(0x172)][_0x10107b(0x1aa)][_0x10107b(0x181)]({'data':{'paymentId':_0x350c5c['id'],'shopId':_0x350c5c['shopId'],'event':_0x10107b(0x1d1),'statusCode':0xc8,'responseBody':JSON[_0x10107b(0x15a)]({'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x10107b(0x1bf),'createdAt':_0x350c5c[_0x10107b(0x1cc)],'expiredAt':new Date()[_0x10107b(0x184)](),'daysSinceCreation':Math[_0x10107b(0x15c)]((Date[_0x10107b(0x182)]()-_0x350c5c[_0x10107b(0x1cc)][_0x10107b(0x1d0)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x10107b(0x1c0)](_0x350c5c,'EXPIRED'),await this['sendPaymentStatusNotification'](_0x350c5c,'EXPIRED'),_0x381569['push'](_0x350c5c['id']),console['log'](_0x10107b(0x197)+_0x350c5c['id']+_0x10107b(0x1ab)+this[_0x10107b(0x179)]+_0x10107b(0x1a5));}catch(_0x5790bf){console[_0x10107b(0x1d8)](_0x10107b(0x17a)+_0x350c5c['id']+':',_0x5790bf);}}}return _0x381569;}async['checkSinglePayment'](_0x11c473){const _0xc0e661=a35_0x32e5ae;if(!_0x11c473[_0xc0e661(0x1c5)]){console['log'](_0xc0e661(0x193)+_0x11c473['id']+_0xc0e661(0x1dc));return;}console[_0xc0e661(0x157)](_0xc0e661(0x16f)+_0x11c473['id']+'\x20('+_0x11c473[_0xc0e661(0x1c5)]+')');try{const _0x5cdb6c=await this[_0xc0e661(0x190)][_0xc0e661(0x1cb)](_0x11c473[_0xc0e661(0x1c5)]);console[_0xc0e661(0x157)]('ðŸ“Š\x20Payment\x20'+_0x11c473['id']+_0xc0e661(0x1c7)+_0x5cdb6c[_0xc0e661(0x1db)]);_0x5cdb6c[_0xc0e661(0x195)]&&console[_0xc0e661(0x157)]('ðŸ“Š\x20Payment\x20'+_0x11c473['id']+_0xc0e661(0x1a8),{'iban':_0x5cdb6c[_0xc0e661(0x195)][_0xc0e661(0x1bd)]||'not\x20found','transactionId':_0x5cdb6c[_0xc0e661(0x195)][_0xc0e661(0x189)],'createdOn':_0x5cdb6c[_0xc0e661(0x195)][_0xc0e661(0x1da)],'confirmedOn':_0x5cdb6c[_0xc0e661(0x195)][_0xc0e661(0x1bb)]||_0xc0e661(0x1b6)});if(_0x5cdb6c['status']!==_0x11c473[_0xc0e661(0x1db)]){console[_0xc0e661(0x157)](_0xc0e661(0x1b2)+_0x11c473['id']+_0xc0e661(0x174)+_0x11c473[_0xc0e661(0x1db)]+_0xc0e661(0x1ba)+_0x5cdb6c[_0xc0e661(0x1db)]);const _0x1fa895={'status':_0x5cdb6c[_0xc0e661(0x1db)],'updatedAt':new Date()};_0x5cdb6c[_0xc0e661(0x1db)]==='PAID'&&_0x11c473[_0xc0e661(0x1db)]!==_0xc0e661(0x1a6)&&(_0x1fa895['paidAt']=new Date(),console[_0xc0e661(0x157)](_0xc0e661(0x1c4)+_0x11c473['id']+_0xc0e661(0x1a4)+_0x1fa895[_0xc0e661(0x1be)][_0xc0e661(0x184)]()));if(_0x5cdb6c[_0xc0e661(0x195)]){const _0x1f74bd=_0x5cdb6c[_0xc0e661(0x195)];_0x1f74bd[_0xc0e661(0x1bd)]&&(_0x1fa895[_0xc0e661(0x164)]=_0x1f74bd[_0xc0e661(0x1bd)],console[_0xc0e661(0x157)](_0xc0e661(0x169)+_0x1f74bd[_0xc0e661(0x1bd)]));if(_0x1f74bd['bankDetails']){const _0x2a7ddf=_0x11c473[_0xc0e661(0x1a3)]||'',_0xfe9c15=_0xc0e661(0x156)+_0x1f74bd['bankDetails'];_0x1fa895['adminNotes']=_0x2a7ddf?_0x2a7ddf+'\x0a\x0a'+_0xfe9c15:_0xfe9c15,console['log'](_0xc0e661(0x1c2));}_0x1f74bd[_0xc0e661(0x189)]&&console['log']('ðŸ†”\x20Transaction\x20ID:\x20'+_0x1f74bd[_0xc0e661(0x189)]),_0x1f74bd[_0xc0e661(0x1bb)]&&console[_0xc0e661(0x157)](_0xc0e661(0x18f)+_0x1f74bd[_0xc0e661(0x1bb)]);}await database_1[_0xc0e661(0x172)][_0xc0e661(0x165)]['update']({'where':{'id':_0x11c473['id']},'data':_0x1fa895}),await database_1[_0xc0e661(0x172)][_0xc0e661(0x1aa)]['create']({'data':{'paymentId':_0x11c473['id'],'shopId':_0x11c473[_0xc0e661(0x1d5)],'event':'cointopay_status_check_'+_0x5cdb6c[_0xc0e661(0x1db)][_0xc0e661(0x16a)](),'statusCode':0xc8,'responseBody':JSON[_0xc0e661(0x15a)]({'oldStatus':_0x11c473['status'],'newStatus':_0x5cdb6c[_0xc0e661(0x1db)],'paymentDetails':_0x5cdb6c['paymentDetails'],'checkedAt':new Date()[_0xc0e661(0x184)]()})}}),await this[_0xc0e661(0x1c0)](_0x11c473,_0x5cdb6c['status']),await this[_0xc0e661(0x163)](_0x11c473,_0x5cdb6c[_0xc0e661(0x1db)]),console[_0xc0e661(0x157)](_0xc0e661(0x197)+_0x11c473['id']+'\x20updated\x20successfully');}else console['log'](_0xc0e661(0x16b)+_0x11c473['id']+_0xc0e661(0x166)+_0x5cdb6c['status']+')');}catch(_0x59369f){console[_0xc0e661(0x1d8)](_0xc0e661(0x1ca)+_0x11c473['id']+':',_0x59369f),await database_1[_0xc0e661(0x172)][_0xc0e661(0x1aa)][_0xc0e661(0x181)]({'data':{'paymentId':_0x11c473['id'],'shopId':_0x11c473[_0xc0e661(0x1d5)],'event':_0xc0e661(0x17c),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x59369f instanceof Error?_0x59369f['message']:_0xc0e661(0x19e),'gatewayPaymentId':_0x11c473[_0xc0e661(0x1c5)],'checkedAt':new Date()[_0xc0e661(0x184)]()})}});}}async[a35_0x32e5ae(0x1c0)](_0x4aa3ed,_0x3fd55c){const _0x20c445=a35_0x32e5ae,_0x3bd529=Date[_0x20c445(0x182)]();try{const _0xb3a71b=_0x4aa3ed['shop'],_0xba1e79=_0xb3a71b[_0x20c445(0x16c)];if(!_0xba1e79?.[_0x20c445(0x18c)]){console['log'](_0x20c445(0x1c9)+_0xb3a71b['id']);return;}const _0xe22be9=_0x3fd55c===_0x20c445(0x1a6)?'payment.success':_0x3fd55c===_0x20c445(0x167)?_0x20c445(0x1a2):_0x3fd55c===_0x20c445(0x180)?_0x20c445(0x1a2):'payment.pending';if(!_0xba1e79[_0x20c445(0x1c3)]?.[_0x20c445(0x1ac)](_0xe22be9)){console[_0x20c445(0x157)](_0x20c445(0x19b)+_0xe22be9+'\x20not\x20enabled\x20for\x20shop\x20'+_0xb3a71b['id']);return;}const _0x3cc442={'event':_0xe22be9,'payment':{'id':_0x4aa3ed['id'],'order_id':_0x4aa3ed[_0x20c445(0x168)],'gateway_order_id':_0x4aa3ed['gatewayOrderId'],'gateway':_0x20c445(0x1b1),'amount':_0x4aa3ed[_0x20c445(0x1ad)],'currency':_0x4aa3ed[_0x20c445(0x18e)],'status':_0x3fd55c['toLowerCase'](),'customer_email':_0x4aa3ed[_0x20c445(0x183)],'customer_name':_0x4aa3ed[_0x20c445(0x1d7)],'created_at':_0x4aa3ed[_0x20c445(0x1cc)],'updated_at':new Date()}},_0x25f8d8=await fetch(_0xba1e79['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x20c445(0x1b3),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x20c445(0x15a)](_0x3cc442)}),_0x4847db=Date[_0x20c445(0x182)]()-_0x3bd529,_0x35c20a=_0x25f8d8['ok']?_0x20c445(0x162):await _0x25f8d8['text']();loggerService_1[_0x20c445(0x1d2)]['logShopWebhookSent'](_0x4aa3ed['shopId'],_0xba1e79[_0x20c445(0x18c)],_0xe22be9,_0x25f8d8[_0x20c445(0x1db)],_0x4847db,_0x3cc442),console[_0x20c445(0x157)](_0x20c445(0x196)+_0xba1e79[_0x20c445(0x18c)]+_0x20c445(0x185)+_0x25f8d8['status']+'\x20('+_0x4847db+_0x20c445(0x173));}catch(_0x35dec3){console['error'](_0x20c445(0x192),_0x35dec3),loggerService_1['loggerService'][_0x20c445(0x17b)](_0x4aa3ed[_0x20c445(0x1d5)],_0x4aa3ed[_0x20c445(0x18a)]?.[_0x20c445(0x16c)]?.[_0x20c445(0x18c)]||_0x20c445(0x16d),_0x20c445(0x1a0),_0x35dec3,{});}}async['sendPaymentStatusNotification'](_0x483e67,_0x375e8a){const _0xc97517=a35_0x32e5ae;try{const _0xf974e7={'PENDING':'created','PAID':_0xc97517(0x15d),'FAILED':'failed','EXPIRED':'expired'},_0x169a61=_0xf974e7[_0x375e8a];if(!_0x169a61||_0x169a61===_0xc97517(0x19d))return;await telegramBotService_1[_0xc97517(0x1a7)][_0xc97517(0x170)](_0x483e67[_0xc97517(0x1d5)],_0x483e67,_0x169a61);}catch(_0x2a500a){console[_0xc97517(0x1d8)](_0xc97517(0x16e),_0x2a500a);}}async[a35_0x32e5ae(0x1b4)](_0x13c5dc){const _0x1354f6=a35_0x32e5ae,_0x56f523=await database_1[_0x1354f6(0x172)]['payment']['findUnique']({'where':{'id':_0x13c5dc},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x56f523)throw new Error('Payment\x20not\x20found');if(_0x56f523['gateway']!==_0x1354f6(0x1d6))throw new Error(_0x1354f6(0x160));await this[_0x1354f6(0x178)](_0x56f523);}[a35_0x32e5ae(0x154)](){const _0x2434b1=a35_0x32e5ae,_0x3af98e=this[_0x2434b1(0x1ae)]?this[_0x2434b1(0x159)]:undefined;return{'isActive':!!this[_0x2434b1(0x1ae)],'checkIntervalMinutes':this[_0x2434b1(0x159)]/(0x3e8*0x3c),'expiryDays':this[_0x2434b1(0x179)],'nextCheckIn':_0x3af98e};}}function a35_0x263a(_0x183f6e,_0x21eb17){const _0xe492b=a35_0xe492();return a35_0x263a=function(_0x263abb,_0x249682){_0x263abb=_0x263abb-0x154;let _0x4238a8=_0xe492b[_0x263abb];return _0x4238a8;},a35_0x263a(_0x183f6e,_0x21eb17);}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a35_0x32e5ae(0x1af)]=new CoinToPayStatusService();