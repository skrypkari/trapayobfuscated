'use strict';function a37_0x3700(){const _0x26cf74=['\x20\x20\x20❌\x20Error:\x20','sendPaymentStatusNotification','106cZiBYq','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20for\x20payment\x20','toLowerCase','clearPaymentTimers','default','\x20days,\x20marking\x20as\x20EXPIRED','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','payment.success','cointopay_auto_expired','paid','failed','1126JNLCvo','create','error','description','\x20\x20\x20-\x20Amount:\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','PENDING','timers','forEach','./loggerService','remitterIban','__importDefault','coinToPayService','gatewayOrderId','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','paymentTimers','\x20to\x20clear','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','sendPaymentNotification','timestamp','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','currency','\x20is\x20too\x20new\x20(','🔄\x20[CHECK]\x20Updating\x20payment\x20','\x20days','findMany','2\x20minutes','createdAt','\x20\x20\x20-\x20Status:\x20','\x20skipped,\x20','Shop\x20webhook\x20sent\x20to\x20','Failed\x20to\x20send\x20shop\x20webhook:','\x20status\x20is\x20','get','❌\x20[CHECK]\x20Payment\x20','\x20expired\x20CoinToPay\x20payments','gateway','Webhook\x20event\x20','⚠️\x20[CHECK]\x20Payment\x20','payment.failed','\x20\x20\x20📊\x20Status:\x20','checkExpiredPayments','\x20is\x20older\x20than\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20(after\x20','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','length','globalCheckInterval','Payment\x20older\x20than\x20','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','PAID','createdOn','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','checkPaymentById','orderId','logCoinToPayStatus','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','Success','\x20\x20\x20-\x20Gateway:\x20','/status/','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','now','created','customerName','Automatically\x20expired\x20after\x20','webhookEvents','\x20not\x20found,\x20clearing\x20timers','✅\x20[HOURLY]\x20Payment\x20','510eVnOsf','TesSoft\x20Payment\x20System/1.0','checkSinglePayment','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20checked,\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','message','unknown','schedule_created','Bank\x20Details:\x20','\x20individual\x20payment\x20timers','logWhiteDomainError','\x20has\x20no\x20gatewayPaymentId,\x20skipping','status','from','\x20\x20\x20📅\x20Time:\x20','setDate','push','\x20initial\x20timers\x20for\x20payment\x20','logShopWebhookError','paymentDetails','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20not\x20found\x20in\x20database','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','startPeriodicStatusCheck','amount','\x20\x20\x20📝\x20Details:','logShopWebhookSent','paymentId','EXPIRED','webhook_send','checkAllPendingPayments','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','transactionId','payment','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20\x20\x20-\x20gatewayPaymentId:\x20','1\x20minute','paidAt','47980RSstIq','CoinToPayStatusService','FAILED','coinToPayStatusService','shop','🪙\x20[GLOBAL]\x20Found\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','stringify','includes','\x20->\x20','status_check','floor','iban','webhookLog','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','gatewayPaymentId','__esModule','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','confirmedOn','../config/database','toISOString','update','findUnique','settings','🪙\x20[TIMER]\x20Individual\x20check\x20#','\x20triggered\x20for\x20payment\x20','logCoinToPayError','bankDetails','\x20expired','\x20updated\x20successfully','catch','638rpRuQl','\x20details:','1012886RsYfka','getServiceStats','log','EXPIRY_DAYS','delete','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','cointopay','✅\x20[CHECK]\x20Payment\x20','has','🪙\x20CoinToPayStatusService\x20initialized','sendShopWebhook','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','delay','webhookUrl','GLOBAL_CHECK_INTERVAL_MS','expired','704DKtYpZ','\x20status:\x20','defineProperty','adminNotes','./gateways/coinToPayService','.\x20Remaining\x20active\x20timers:\x20','30654FjIrlK','checkSinglePaymentById','💰\x20[CHECK]\x20Payment\x20','loggerService','444bPMlcQ','1309500gSsZDw','\x20to\x20','🛑\x20[SHUTDOWN]\x20Cleared\x20','5\x20minutes','telegramBotService','shopId','⏰\x20[GLOBAL]\x20Payment\x20','size','getPaymentTimerInfo','\x20has\x20no\x20gatewayPaymentId','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','COINTOPAY_STATUS_CHANGE','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','📊\x20[CHECK]\x20Payment\x20',',\x20stopping\x20individual\x20checks','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','stopPeriodicStatusCheck','✅\x20[TIMER]\x20Individual\x20check\x20#','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','values','h),\x20skipping\x20global\x20check','\x20\x20\x20📍\x20Source:\x20','POST','⏰\x20[EXPIRY]\x20Payment\x20','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','Payment\x20not\x20found','🪙\x20[DEBUG]\x20Creating\x20','getTime','\x20days\x20without\x20payment\x20confirmation','cointopay_status_check_','text','519627BZtyla','\x20timers\x20for\x20payment\x20','Unknown\x20error','⏰\x20[HOURLY]\x20Payment\x20'];a37_0x3700=function(){return _0x26cf74;};return a37_0x3700();}const a37_0x2809ee=a37_0x2b20;(function(_0x40eeaa,_0x428846){const _0x32d18a=a37_0x2b20,_0x4f34b1=_0x40eeaa();while(!![]){try{const _0x3540a1=-parseInt(_0x32d18a(0xbb))/0x1*(parseInt(_0x32d18a(0xc7))/0x2)+parseInt(_0x32d18a(0xb5))/0x3+parseInt(_0x32d18a(0x95))/0x4+-parseInt(_0x32d18a(0x10e))/0x5*(parseInt(_0x32d18a(0x94))/0x6)+-parseInt(_0x32d18a(0x79))/0x7+parseInt(_0x32d18a(0x8a))/0x8*(-parseInt(_0x32d18a(0x90))/0x9)+parseInt(_0x32d18a(0x138))/0xa*(parseInt(_0x32d18a(0x77))/0xb);if(_0x3540a1===_0x428846)break;else _0x4f34b1['push'](_0x4f34b1['shift']());}catch(_0x138e60){_0x4f34b1['push'](_0x4f34b1['shift']());}}}(a37_0x3700,0x413d0));var __importDefault=this&&this[a37_0x2809ee(0xd4)]||function(_0x2a4be7){const _0x405390=a37_0x2809ee;return _0x2a4be7&&_0x2a4be7[_0x405390(0x148)]?_0x2a4be7:{'default':_0x2a4be7};};Object[a37_0x2809ee(0x8c)](exports,a37_0x2809ee(0x148),{'value':!![]}),exports[a37_0x2809ee(0x13b)]=exports[a37_0x2809ee(0x139)]=void 0x0;const coinToPayService_1=require(a37_0x2809ee(0x8e)),database_1=__importDefault(require(a37_0x2809ee(0x14c))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a37_0x2809ee(0xd2));class CoinToPayStatusService{constructor(){const _0x1eb0b4=a37_0x2809ee;this[_0x1eb0b4(0xf8)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x1eb0b4(0xd8)]=new Map(),this[_0x1eb0b4(0xd5)]=new coinToPayService_1['CoinToPayService'](),console[_0x1eb0b4(0x7b)](_0x1eb0b4(0x83));}['schedulePaymentChecks'](_0x4a773d,_0x33a31e){const _0x29b69a=a37_0x2809ee;console[_0x29b69a(0x7b)](_0x29b69a(0xc2)),console['log']('\x20\x20\x20-\x20paymentId:\x20'+_0x4a773d),console[_0x29b69a(0x7b)](_0x29b69a(0x135)+_0x33a31e),this[_0x29b69a(0xbf)](_0x4a773d);const _0x36422f=[],_0x3b5824=new Date(),_0x2609de=[{'delay':0x1*0x3c*0x3e8,'description':_0x29b69a(0x136)},{'delay':0x2*0x3c*0x3e8,'description':_0x29b69a(0xe3)},{'delay':0x5*0x3c*0x3e8,'description':_0x29b69a(0x98)},{'delay':0x5*0x3c*0x3e8,'description':_0x29b69a(0x98)}];console[_0x29b69a(0x7b)](_0x29b69a(0xb0)+_0x2609de[_0x29b69a(0xf7)]+_0x29b69a(0x122)+_0x4a773d);let _0x5299ed=0x0;_0x2609de[_0x29b69a(0xd1)]((_0x496f49,_0x8fef03)=>{const _0x483f16=_0x29b69a;_0x5299ed+=_0x496f49['delay'];const _0x44b47f=setTimeout(async()=>{const _0x3745d4=a37_0x2b20;console[_0x3745d4(0x7b)](_0x3745d4(0x151)+(_0x8fef03+0x1)+_0x3745d4(0x152)+_0x4a773d+_0x3745d4(0xf5)+_0x496f49[_0x3745d4(0xca)]+')');try{await this[_0x3745d4(0x91)](_0x4a773d),console[_0x3745d4(0x7b)](_0x3745d4(0xa6)+(_0x8fef03+0x1)+'\x20completed\x20for\x20payment\x20'+_0x4a773d);}catch(_0xa4445c){console[_0x3745d4(0xc9)](_0x3745d4(0xf6)+(_0x8fef03+0x1)+_0x3745d4(0xbd)+_0x4a773d+':',_0xa4445c),this[_0x3745d4(0x153)](_0x4a773d,_0x33a31e,_0xa4445c,_0x3745d4(0x142),{'checkNumber':_0x8fef03+0x1,'scheduledAfter':_0x496f49['description'],'isIndividualCheck':!![]});}},_0x5299ed);_0x36422f[_0x483f16(0x121)](_0x44b47f),console['log'](_0x483f16(0xdd)+(_0x8fef03+0x1)+_0x483f16(0xbd)+_0x4a773d+'\x20in\x20'+_0x5299ed/0x3e8+'\x20seconds\x20('+_0x496f49[_0x483f16(0xca)]+')');});const _0x2890ff=setInterval(async()=>{const _0x30eaed=_0x29b69a;console[_0x30eaed(0x7b)]('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x4a773d);try{const _0x26d4dd=await database_1[_0x30eaed(0xc0)][_0x30eaed(0x133)][_0x30eaed(0x14f)]({'where':{'id':_0x4a773d},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x26d4dd){console[_0x30eaed(0x7b)]('❌\x20[HOURLY]\x20Payment\x20'+_0x4a773d+_0x30eaed(0x10c)),this[_0x30eaed(0xbf)](_0x4a773d);return;}console['log']('📊\x20[HOURLY]\x20Payment\x20'+_0x4a773d+'\x20current\x20status:\x20'+_0x26d4dd['status']);if(_0x26d4dd[_0x30eaed(0x11d)]!==_0x30eaed(0xcf)){console[_0x30eaed(0x7b)](_0x30eaed(0x10d)+_0x4a773d+_0x30eaed(0xe9)+_0x26d4dd[_0x30eaed(0x11d)]+_0x30eaed(0xa3)),this[_0x30eaed(0xbf)](_0x4a773d);return;}const _0x30acf7=Math[_0x30eaed(0x143)]((Date[_0x30eaed(0x107)]()-_0x26d4dd[_0x30eaed(0xe4)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x30acf7>=this[_0x30eaed(0x7c)]){console['log'](_0x30eaed(0xb8)+_0x4a773d+_0x30eaed(0xf3)+this['EXPIRY_DAYS']+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x30eaed(0xbf)](_0x4a773d);return;}await this[_0x30eaed(0x91)](_0x4a773d),console[_0x30eaed(0x7b)](_0x30eaed(0x14a)+_0x4a773d);}catch(_0x39192f){console[_0x30eaed(0xc9)](_0x30eaed(0x7f)+_0x4a773d+':',_0x39192f),this[_0x30eaed(0x153)](_0x4a773d,_0x33a31e,_0x39192f,_0x30eaed(0x142),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x36422f[_0x29b69a(0x121)](_0x2890ff),this[_0x29b69a(0xd8)]['set'](_0x4a773d,{'timers':_0x36422f,'paymentId':_0x4a773d,'gatewayPaymentId':_0x33a31e,'createdAt':_0x3b5824}),console[_0x29b69a(0x7b)](_0x29b69a(0x146)+_0x2609de['length']+_0x29b69a(0xd7)+_0x4a773d),console[_0x29b69a(0x7b)](_0x29b69a(0xda)+this[_0x29b69a(0xd8)][_0x29b69a(0x9c)]),this[_0x29b69a(0x101)](_0x4a773d,_0x33a31e,_0x29b69a(0xcf),_0x29b69a(0xcf),_0x29b69a(0x142),{'action':_0x29b69a(0x118),'scheduledChecks':_0x2609de[_0x29b69a(0xf7)],'firstCheckIn':_0x2609de[0x0][_0x29b69a(0x86)]/0x3e8,'totalTimers':this['paymentTimers'][_0x29b69a(0x9c)]});}[a37_0x2809ee(0xbf)](_0x541d0a){const _0x542a2f=a37_0x2809ee,_0x512ee6=this[_0x542a2f(0xd8)][_0x542a2f(0xea)](_0x541d0a);_0x512ee6?(console[_0x542a2f(0x7b)]('🧹\x20[DEBUG]\x20Clearing\x20'+_0x512ee6[_0x542a2f(0xd0)][_0x542a2f(0xf7)]+_0x542a2f(0xb6)+_0x541d0a),_0x512ee6[_0x542a2f(0xd0)][_0x542a2f(0xd1)]((_0x1b73f9,_0x2591b0)=>{const _0x187b83=_0x542a2f;_0x1b73f9&&(clearTimeout(_0x1b73f9),clearInterval(_0x1b73f9),console['log']('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x2591b0+0x1)+_0x187b83(0xbd)+_0x541d0a));}),this[_0x542a2f(0xd8)][_0x542a2f(0x7d)](_0x541d0a),console[_0x542a2f(0x7b)](_0x542a2f(0x85)+_0x541d0a+_0x542a2f(0x8f)+this[_0x542a2f(0xd8)][_0x542a2f(0x9c)])):console[_0x542a2f(0x7b)](_0x542a2f(0xce)+_0x541d0a+_0x542a2f(0xd9));}async[a37_0x2809ee(0x91)](_0x3ded6c){const _0x3d86c0=a37_0x2809ee;console[_0x3d86c0(0x7b)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x3ded6c);const _0x860fbb=await database_1[_0x3d86c0(0xc0)][_0x3d86c0(0x133)][_0x3d86c0(0x14f)]({'where':{'id':_0x3ded6c},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x860fbb){console[_0x3d86c0(0x7b)](_0x3d86c0(0xeb)+_0x3ded6c+_0x3d86c0(0x126));return;}console[_0x3d86c0(0x7b)](_0x3d86c0(0xa2)+_0x3ded6c+'\x20found:'),console['log'](_0x3d86c0(0x104)+_0x860fbb['gateway']),console[_0x3d86c0(0x7b)](_0x3d86c0(0xe5)+_0x860fbb['status']),console['log'](_0x3d86c0(0x13e)+_0x860fbb['gatewayPaymentId']),console[_0x3d86c0(0x7b)](_0x3d86c0(0xcb)+_0x860fbb[_0x3d86c0(0x12a)]+'\x20'+_0x860fbb[_0x3d86c0(0xde)]),console[_0x3d86c0(0x7b)]('\x20\x20\x20-\x20ShopId:\x20'+_0x860fbb['shopId']);if(_0x860fbb[_0x3d86c0(0xed)]!==_0x3d86c0(0x80)){console[_0x3d86c0(0x7b)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x3ded6c+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x860fbb['gateway']+')');return;}if(_0x860fbb[_0x3d86c0(0x11d)]!==_0x3d86c0(0xcf)){console[_0x3d86c0(0x7b)](_0x3d86c0(0xef)+_0x3ded6c+'\x20status\x20is\x20'+_0x860fbb[_0x3d86c0(0x11d)]+_0x3d86c0(0xa3)),this['clearPaymentTimers'](_0x3ded6c);return;}if(!_0x860fbb[_0x3d86c0(0x147)]){console[_0x3d86c0(0x7b)](_0x3d86c0(0xef)+_0x3ded6c+_0x3d86c0(0x9e));return;}console[_0x3d86c0(0x7b)](_0x3d86c0(0x81)+_0x3ded6c+_0x3d86c0(0x115)),await this[_0x3d86c0(0x110)](_0x860fbb);}[a37_0x2809ee(0x101)](_0x48e5ae,_0xb75a34,_0x41635c,_0x592c68,_0x5a4c2d,_0x4f3109){const _0x13ae34=a37_0x2809ee,_0x92fac1={'type':_0x13ae34(0xa0),'paymentId':_0x48e5ae,'gatewayPaymentId':_0xb75a34,'oldStatus':_0x41635c,'newStatus':_0x592c68,'source':_0x5a4c2d,'timestamp':new Date()[_0x13ae34(0x14d)](),'details':_0x4f3109||{}};loggerService_1[_0x13ae34(0x93)][_0x13ae34(0x101)](_0x92fac1),console[_0x13ae34(0x7b)](_0x13ae34(0xae)+_0x48e5ae+'\x20('+_0xb75a34+')'),console[_0x13ae34(0x7b)](_0x13ae34(0xf1)+_0x41635c+_0x13ae34(0x141)+_0x592c68),console['log'](_0x13ae34(0xab)+_0x5a4c2d),console['log'](_0x13ae34(0x11f)+_0x92fac1[_0x13ae34(0xdc)]),_0x4f3109&&console[_0x13ae34(0x7b)](_0x13ae34(0x12b),_0x4f3109);}[a37_0x2809ee(0x153)](_0x73a125,_0xc85f93,_0x42d0c3,_0x25567a,_0x207f9a){const _0x412abd=a37_0x2809ee,_0x2a3d58={'type':'COINTOPAY_ERROR','paymentId':_0x73a125,'gatewayPaymentId':_0xc85f93,'error':_0x42d0c3 instanceof Error?{'message':_0x42d0c3[_0x412abd(0x116)],'stack':_0x42d0c3['stack']}:_0x42d0c3,'source':_0x25567a,'timestamp':new Date()[_0x412abd(0x14d)](),'context':_0x207f9a||{}};loggerService_1[_0x412abd(0x93)][_0x412abd(0x153)](_0x2a3d58),console[_0x412abd(0xc9)](_0x412abd(0xfe)+_0x73a125+'\x20('+_0xc85f93+')'),console[_0x412abd(0xc9)](_0x412abd(0xb9)+(_0x42d0c3 instanceof Error?_0x42d0c3[_0x412abd(0x116)]:_0x42d0c3)),console['error']('\x20\x20\x20📍\x20Source:\x20'+_0x25567a),console[_0x412abd(0xc9)](_0x412abd(0x11f)+_0x2a3d58[_0x412abd(0xdc)]),_0x207f9a&&console['error']('\x20\x20\x20📝\x20Context:',_0x207f9a);}[a37_0x2809ee(0x129)](){const _0x14107a=a37_0x2809ee;console[_0x14107a(0x7b)](_0x14107a(0x9f)),this[_0x14107a(0x130)]()[_0x14107a(0x76)](_0x17ef57=>{const _0x383bc5=_0x14107a;console[_0x383bc5(0xc9)](_0x383bc5(0x113),_0x17ef57);}),this[_0x14107a(0xf8)]=setInterval(async()=>{const _0x2da0ab=_0x14107a;try{console['log'](_0x2da0ab(0xf4)),await this[_0x2da0ab(0x130)](),console['log'](_0x2da0ab(0x134));}catch(_0x543b99){console['error'](_0x2da0ab(0xcc),_0x543b99);}},this[_0x14107a(0x88)]),console[_0x14107a(0x7b)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x2809ee(0xa5)](){const _0xf653cb=a37_0x2809ee;console[_0xf653cb(0x7b)](_0xf653cb(0x125));this[_0xf653cb(0xf8)]&&(clearInterval(this[_0xf653cb(0xf8)]),this[_0xf653cb(0xf8)]=null,console[_0xf653cb(0x7b)](_0xf653cb(0x111)));const _0x10a839=this['paymentTimers'][_0xf653cb(0x9c)];for(const [_0x406eec]of this['paymentTimers']){this[_0xf653cb(0xbf)](_0x406eec);}console[_0xf653cb(0x7b)](_0xf653cb(0x97)+_0x10a839+_0xf653cb(0x11a));}async[a37_0x2809ee(0x130)](){const _0x3d18a2=a37_0x2809ee;try{console['log'](_0x3d18a2(0x127));const _0x4ad5a5=await database_1[_0x3d18a2(0xc0)][_0x3d18a2(0x133)][_0x3d18a2(0xe2)]({'where':{'gateway':_0x3d18a2(0x80),'status':_0x3d18a2(0xcf),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x3d18a2(0x7b)](_0x3d18a2(0x13d)+_0x4ad5a5['length']+'\x20pending\x20CoinToPay\x20payments');if(_0x4ad5a5[_0x3d18a2(0xf7)]===0x0){console[_0x3d18a2(0x7b)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x2eb9e2=await this['checkExpiredPayments'](_0x4ad5a5);console[_0x3d18a2(0x7b)]('⏰\x20[GLOBAL]\x20Found\x20'+_0x2eb9e2[_0x3d18a2(0xf7)]+_0x3d18a2(0xec));let _0x480a9e=0x0,_0x51e876=0x0;for(const _0x569ec3 of _0x4ad5a5){try{if(_0x2eb9e2[_0x3d18a2(0x140)](_0x569ec3['id'])){console['log'](_0x3d18a2(0x9b)+_0x569ec3['id']+_0x3d18a2(0x102)),_0x51e876++;continue;}if(this[_0x3d18a2(0xd8)][_0x3d18a2(0x82)](_0x569ec3['id'])){console[_0x3d18a2(0x7b)](_0x3d18a2(0x9b)+_0x569ec3['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x51e876++;continue;}const _0x1141b5=(Date[_0x3d18a2(0x107)]()-_0x569ec3[_0x3d18a2(0xe4)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x1141b5<0x1){console[_0x3d18a2(0x7b)](_0x3d18a2(0x9b)+_0x569ec3['id']+_0x3d18a2(0xdf)+_0x1141b5['toFixed'](0x1)+_0x3d18a2(0xaa)),_0x51e876++;continue;}console[_0x3d18a2(0x7b)](_0x3d18a2(0x106)+_0x569ec3['id']+'\x20(age:\x20'+_0x1141b5['toFixed'](0x1)+'h)'),await this[_0x3d18a2(0x110)](_0x569ec3),_0x480a9e++,await new Promise(_0x37d53d=>setTimeout(_0x37d53d,0x7d0));}catch(_0x57a220){console[_0x3d18a2(0xc9)]('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x569ec3['id']+':',_0x57a220),this[_0x3d18a2(0x153)](_0x569ec3['id'],_0x569ec3[_0x3d18a2(0x147)]||'unknown',_0x57a220,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x569ec3[_0x3d18a2(0x12a)],'paymentCurrency':_0x569ec3[_0x3d18a2(0xde)],'shopId':_0x569ec3[_0x3d18a2(0x9a)],'createdAt':_0x569ec3[_0x3d18a2(0xe4)]}),loggerService_1[_0x3d18a2(0x93)][_0x3d18a2(0x11b)](_0x3d18a2(0x80),_0x3d18a2(0x105)+_0x569ec3[_0x3d18a2(0x147)],_0x57a220);}}console[_0x3d18a2(0x7b)]('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x480a9e+_0x3d18a2(0x112)+_0x51e876+_0x3d18a2(0xe6)+_0x2eb9e2[_0x3d18a2(0xf7)]+_0x3d18a2(0x155));}catch(_0xbd85c9){console[_0x3d18a2(0xc9)](_0x3d18a2(0xa1),_0xbd85c9);}}async[a37_0x2809ee(0xf2)](_0x6adfc5){const _0x440bb4=a37_0x2809ee,_0x219a6c=[],_0x351369=new Date();_0x351369[_0x440bb4(0x120)](_0x351369['getDate']()-this[_0x440bb4(0x7c)]),console[_0x440bb4(0x7b)](_0x440bb4(0xcd)+this[_0x440bb4(0x7c)]+'\x20days\x20(created\x20before\x20'+_0x351369[_0x440bb4(0x14d)]()+')');for(const _0x239720 of _0x6adfc5){if(_0x239720[_0x440bb4(0xe4)]<_0x351369){console[_0x440bb4(0x7b)](_0x440bb4(0xad)+_0x239720['id']+_0x440bb4(0xf3)+this[_0x440bb4(0x7c)]+_0x440bb4(0xc1));try{this[_0x440bb4(0x101)](_0x239720['id'],_0x239720[_0x440bb4(0x147)]||_0x440bb4(0x117),'PENDING',_0x440bb4(0x12e),'auto_expire',{'reason':_0x440bb4(0xf9)+this['EXPIRY_DAYS']+_0x440bb4(0xe1),'createdAt':_0x239720['createdAt'],'daysSinceCreation':Math[_0x440bb4(0x143)]((Date[_0x440bb4(0x107)]()-_0x239720[_0x440bb4(0xe4)][_0x440bb4(0xb1)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x239720[_0x440bb4(0x12a)],'paymentCurrency':_0x239720[_0x440bb4(0xde)],'shopId':_0x239720[_0x440bb4(0x9a)]}),await database_1[_0x440bb4(0xc0)][_0x440bb4(0x133)][_0x440bb4(0x14e)]({'where':{'id':_0x239720['id']},'data':{'status':_0x440bb4(0x12e),'updatedAt':new Date(),'adminNotes':_0x440bb4(0x10a)+this['EXPIRY_DAYS']+_0x440bb4(0xb2)}}),await database_1[_0x440bb4(0xc0)]['webhookLog'][_0x440bb4(0xc8)]({'data':{'paymentId':_0x239720['id'],'shopId':_0x239720['shopId'],'event':_0x440bb4(0xc4),'statusCode':0xc8,'responseBody':JSON[_0x440bb4(0x13f)]({'reason':'Payment\x20older\x20than\x20'+this[_0x440bb4(0x7c)]+_0x440bb4(0xe1),'createdAt':_0x239720[_0x440bb4(0xe4)],'expiredAt':new Date()[_0x440bb4(0x14d)](),'daysSinceCreation':Math[_0x440bb4(0x143)]((Date['now']()-_0x239720[_0x440bb4(0xe4)][_0x440bb4(0xb1)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x239720,_0x440bb4(0x12e)),await this[_0x440bb4(0xba)](_0x239720,_0x440bb4(0x12e)),this[_0x440bb4(0xbf)](_0x239720['id']),_0x219a6c['push'](_0x239720['id']),console[_0x440bb4(0x7b)]('✅\x20[EXPIRY]\x20Payment\x20'+_0x239720['id']+_0x440bb4(0x128)+this['EXPIRY_DAYS']+'-day\x20timeout');}catch(_0x302cd7){console[_0x440bb4(0xc9)]('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x239720['id']+':',_0x302cd7),this[_0x440bb4(0x153)](_0x239720['id'],_0x239720[_0x440bb4(0x147)]||_0x440bb4(0x117),_0x302cd7,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x239720[_0x440bb4(0xe4)],'daysSinceCreation':Math[_0x440bb4(0x143)]((Date['now']()-_0x239720['createdAt'][_0x440bb4(0xb1)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x219a6c;}async[a37_0x2809ee(0x110)](_0x4cf209){const _0x18f76c=a37_0x2809ee;if(!_0x4cf209['gatewayPaymentId']){console['log'](_0x18f76c(0xef)+_0x4cf209['id']+_0x18f76c(0x11c));return;}console[_0x18f76c(0x7b)](_0x18f76c(0xfa)+_0x4cf209['id']+'\x20('+_0x4cf209['gatewayPaymentId']+')');try{const _0xab6b6c=await this[_0x18f76c(0xd5)]['checkPaymentStatus'](_0x4cf209[_0x18f76c(0x147)]);console['log'](_0x18f76c(0xa2)+_0x4cf209['id']+_0x18f76c(0x8b)+_0xab6b6c[_0x18f76c(0x11d)]);_0xab6b6c[_0x18f76c(0x124)]&&console[_0x18f76c(0x7b)](_0x18f76c(0xa2)+_0x4cf209['id']+_0x18f76c(0x78),{'iban':_0xab6b6c[_0x18f76c(0x124)]['iban']||'not\x20found','transactionId':_0xab6b6c[_0x18f76c(0x124)]['transactionId'],'createdOn':_0xab6b6c[_0x18f76c(0x124)][_0x18f76c(0xfc)],'confirmedOn':_0xab6b6c[_0x18f76c(0x124)][_0x18f76c(0x14b)]||'not\x20confirmed'});if(_0xab6b6c[_0x18f76c(0x11d)]!==_0x4cf209[_0x18f76c(0x11d)]){console[_0x18f76c(0x7b)](_0x18f76c(0xe0)+_0x4cf209['id']+'\x20status\x20from\x20'+_0x4cf209['status']+_0x18f76c(0x96)+_0xab6b6c[_0x18f76c(0x11d)]),this[_0x18f76c(0x101)](_0x4cf209['id'],_0x4cf209[_0x18f76c(0x147)],_0x4cf209[_0x18f76c(0x11d)],_0xab6b6c[_0x18f76c(0x11d)],_0x18f76c(0x142),{'paymentDetails':_0xab6b6c[_0x18f76c(0x124)],'amount':_0xab6b6c[_0x18f76c(0x12a)],'currency':_0xab6b6c[_0x18f76c(0xde)],'shopId':_0x4cf209[_0x18f76c(0x9a)],'checkTimestamp':new Date()[_0x18f76c(0x14d)]()});const _0x44a308={'status':_0xab6b6c[_0x18f76c(0x11d)],'updatedAt':new Date()};_0xab6b6c[_0x18f76c(0x11d)]===_0x18f76c(0xfb)&&_0x4cf209[_0x18f76c(0x11d)]!==_0x18f76c(0xfb)&&(_0x44a308[_0x18f76c(0x137)]=new Date(),console[_0x18f76c(0x7b)](_0x18f76c(0x92)+_0x4cf209['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x44a308[_0x18f76c(0x137)][_0x18f76c(0x14d)]()));if(_0xab6b6c[_0x18f76c(0x124)]){const _0x2ccb77=_0xab6b6c[_0x18f76c(0x124)];_0x2ccb77[_0x18f76c(0x144)]&&(_0x44a308[_0x18f76c(0xd3)]=_0x2ccb77['iban'],console[_0x18f76c(0x7b)](_0x18f76c(0xa8)+_0x2ccb77[_0x18f76c(0x144)]));if(_0x2ccb77[_0x18f76c(0x154)]){const _0x794886=_0x4cf209[_0x18f76c(0x8d)]||'',_0x3b3a5=_0x18f76c(0x119)+_0x2ccb77[_0x18f76c(0x154)];_0x44a308[_0x18f76c(0x8d)]=_0x794886?_0x794886+'\x0a\x0a'+_0x3b3a5:_0x3b3a5,console['log'](_0x18f76c(0xbc));}_0x2ccb77[_0x18f76c(0x132)]&&console[_0x18f76c(0x7b)](_0x18f76c(0x149)+_0x2ccb77[_0x18f76c(0x132)]),_0x2ccb77[_0x18f76c(0x14b)]&&console[_0x18f76c(0x7b)](_0x18f76c(0x7e)+_0x2ccb77['confirmedOn']);}await database_1[_0x18f76c(0xc0)][_0x18f76c(0x133)]['update']({'where':{'id':_0x4cf209['id']},'data':_0x44a308}),await database_1[_0x18f76c(0xc0)][_0x18f76c(0x145)][_0x18f76c(0xc8)]({'data':{'paymentId':_0x4cf209['id'],'shopId':_0x4cf209['shopId'],'event':_0x18f76c(0xb3)+_0xab6b6c[_0x18f76c(0x11d)][_0x18f76c(0xbe)](),'statusCode':0xc8,'responseBody':JSON[_0x18f76c(0x13f)]({'oldStatus':_0x4cf209[_0x18f76c(0x11d)],'newStatus':_0xab6b6c['status'],'paymentDetails':_0xab6b6c[_0x18f76c(0x124)],'checkedAt':new Date()[_0x18f76c(0x14d)]()})}}),await this['sendShopWebhook'](_0x4cf209,_0xab6b6c[_0x18f76c(0x11d)]),await this['sendPaymentStatusNotification'](_0x4cf209,_0xab6b6c['status']),_0xab6b6c['status']!==_0x18f76c(0xcf)&&(console[_0x18f76c(0x7b)]('🧹\x20[CHECK]\x20Payment\x20'+_0x4cf209['id']+'\x20status\x20changed\x20to\x20'+_0xab6b6c[_0x18f76c(0x11d)]+',\x20clearing\x20individual\x20timers'),this[_0x18f76c(0xbf)](_0x4cf209['id'])),console[_0x18f76c(0x7b)]('✅\x20[CHECK]\x20Payment\x20'+_0x4cf209['id']+_0x18f76c(0x75));}else console[_0x18f76c(0x7b)](_0x18f76c(0xa2)+_0x4cf209['id']+'\x20status\x20unchanged\x20('+_0xab6b6c['status']+')'),this[_0x18f76c(0x101)](_0x4cf209['id'],_0x4cf209['gatewayPaymentId'],_0x4cf209['status'],_0xab6b6c['status'],'status_check',{'statusUnchanged':!![],'paymentDetails':_0xab6b6c[_0x18f76c(0x124)],'amount':_0xab6b6c[_0x18f76c(0x12a)],'currency':_0xab6b6c[_0x18f76c(0xde)],'shopId':_0x4cf209[_0x18f76c(0x9a)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x2c75a5){console['error']('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x4cf209['id']+':',_0x2c75a5),this[_0x18f76c(0x153)](_0x4cf209['id'],_0x4cf209[_0x18f76c(0x147)],_0x2c75a5,'status_check',{'paymentAmount':_0x4cf209[_0x18f76c(0x12a)],'paymentCurrency':_0x4cf209[_0x18f76c(0xde)],'shopId':_0x4cf209[_0x18f76c(0x9a)],'createdAt':_0x4cf209[_0x18f76c(0xe4)]}),await database_1[_0x18f76c(0xc0)]['webhookLog'][_0x18f76c(0xc8)]({'data':{'paymentId':_0x4cf209['id'],'shopId':_0x4cf209[_0x18f76c(0x9a)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x2c75a5 instanceof Error?_0x2c75a5['message']:_0x18f76c(0xb7),'gatewayPaymentId':_0x4cf209[_0x18f76c(0x147)],'checkedAt':new Date()[_0x18f76c(0x14d)]()})}});}}async[a37_0x2809ee(0x84)](_0x2a2f94,_0x1324b3){const _0x1cc037=a37_0x2809ee,_0xc68487=Date['now']();try{const _0x2a0766=_0x2a2f94[_0x1cc037(0x13c)],_0x2a7fde=_0x2a0766[_0x1cc037(0x150)];if(!_0x2a7fde?.['webhookUrl']){console[_0x1cc037(0x7b)](_0x1cc037(0xa4)+_0x2a0766['id']);return;}const _0x2c243d=_0x1324b3===_0x1cc037(0xfb)?_0x1cc037(0xc3):_0x1324b3===_0x1cc037(0x13a)?_0x1cc037(0xf0):_0x1324b3===_0x1cc037(0x12e)?_0x1cc037(0xf0):'payment.pending';if(!_0x2a7fde[_0x1cc037(0x10b)]?.[_0x1cc037(0x140)](_0x2c243d)){console[_0x1cc037(0x7b)](_0x1cc037(0xee)+_0x2c243d+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2a0766['id']);return;}const _0x2ec89d={'event':_0x2c243d,'payment':{'id':_0x2a2f94['id'],'order_id':_0x2a2f94[_0x1cc037(0x100)],'gateway_order_id':_0x2a2f94[_0x1cc037(0xd6)],'gateway':'0100','amount':_0x2a2f94[_0x1cc037(0x12a)],'currency':_0x2a2f94[_0x1cc037(0xde)],'status':_0x1324b3[_0x1cc037(0xbe)](),'customer_email':_0x2a2f94['customerEmail'],'customer_name':_0x2a2f94[_0x1cc037(0x109)],'created_at':_0x2a2f94[_0x1cc037(0xe4)],'updated_at':new Date()}},_0x30d12a=await fetch(_0x2a7fde['webhookUrl'],{'method':_0x1cc037(0xac),'headers':{'Content-Type':'application/json','User-Agent':_0x1cc037(0x10f)},'body':JSON['stringify'](_0x2ec89d)}),_0x3fda09=Date[_0x1cc037(0x107)]()-_0xc68487,_0x4034cb=_0x30d12a['ok']?_0x1cc037(0x103):await _0x30d12a[_0x1cc037(0xb4)]();loggerService_1['loggerService'][_0x1cc037(0x12c)](_0x2a2f94[_0x1cc037(0x9a)],_0x2a7fde[_0x1cc037(0x87)],_0x2c243d,_0x30d12a[_0x1cc037(0x11d)],_0x3fda09,_0x2ec89d),console['log'](_0x1cc037(0xe7)+_0x2a7fde[_0x1cc037(0x87)]+'\x20with\x20status\x20'+_0x30d12a[_0x1cc037(0x11d)]+'\x20('+_0x3fda09+'ms)');}catch(_0x241b2c){console[_0x1cc037(0xc9)](_0x1cc037(0xe8),_0x241b2c),loggerService_1[_0x1cc037(0x93)][_0x1cc037(0x123)](_0x2a2f94[_0x1cc037(0x9a)],_0x2a2f94['shop']?.['settings']?.[_0x1cc037(0x87)]||_0x1cc037(0x117),_0x1cc037(0x12f),_0x241b2c,{});}}async[a37_0x2809ee(0xba)](_0x3b0e4b,_0x554fcc){const _0x317d15=a37_0x2809ee;try{const _0x42523d={'PENDING':_0x317d15(0x108),'PAID':_0x317d15(0xc5),'FAILED':_0x317d15(0xc6),'EXPIRED':_0x317d15(0x89)},_0x130e07=_0x42523d[_0x554fcc];if(!_0x130e07||_0x130e07===_0x317d15(0x108))return;await telegramBotService_1[_0x317d15(0x99)][_0x317d15(0xdb)](_0x3b0e4b[_0x317d15(0x9a)],_0x3b0e4b,_0x130e07);}catch(_0x3732ae){console[_0x317d15(0xc9)](_0x317d15(0x131),_0x3732ae);}}async[a37_0x2809ee(0xff)](_0x20891f){const _0x8e74ee=a37_0x2809ee;console['log'](_0x8e74ee(0x114)+_0x20891f);const _0x44654c=await database_1[_0x8e74ee(0xc0)][_0x8e74ee(0x133)]['findUnique']({'where':{'id':_0x20891f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x44654c)throw new Error(_0x8e74ee(0xaf));if(_0x44654c[_0x8e74ee(0xed)]!==_0x8e74ee(0x80))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console['log'](_0x8e74ee(0xa7)+_0x20891f),await this['checkSinglePayment'](_0x44654c),console[_0x8e74ee(0x7b)](_0x8e74ee(0xfd)+_0x20891f);}[a37_0x2809ee(0x7a)](){const _0x39997f=a37_0x2809ee,_0x4dff20=this[_0x39997f(0xf8)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x36bf36=Array[_0x39997f(0x11e)](this[_0x39997f(0xd8)][_0x39997f(0xa9)]())['map'](_0x2ed344=>({'paymentId':_0x2ed344[_0x39997f(0x12d)],'gatewayPaymentId':_0x2ed344[_0x39997f(0x147)],'createdAt':_0x2ed344[_0x39997f(0xe4)],'timersCount':_0x2ed344[_0x39997f(0xd0)][_0x39997f(0xf7)]}));return{'isActive':!!this[_0x39997f(0xf8)],'globalCheckIntervalMinutes':this[_0x39997f(0x88)]/(0x3e8*0x3c),'expiryDays':this[_0x39997f(0x7c)],'activeIndividualTimers':this[_0x39997f(0xd8)][_0x39997f(0x9c)],'nextGlobalCheckIn':_0x4dff20,'paymentTimersDetails':_0x36bf36};}[a37_0x2809ee(0x9d)](_0x3de02b){const _0x43c60e=a37_0x2809ee,_0x4ab82c=this[_0x43c60e(0xd8)][_0x43c60e(0xea)](_0x3de02b);if(_0x4ab82c)return{'hasTimers':!![],'timersCount':_0x4ab82c[_0x43c60e(0xd0)][_0x43c60e(0xf7)],'createdAt':_0x4ab82c['createdAt'],'gatewayPaymentId':_0x4ab82c[_0x43c60e(0x147)]};return{'hasTimers':![]};}}function a37_0x2b20(_0x19dcaa,_0x5802b2){const _0x370087=a37_0x3700();return a37_0x2b20=function(_0x2b20f7,_0x5084e7){_0x2b20f7=_0x2b20f7-0x75;let _0x166e43=_0x370087[_0x2b20f7];return _0x166e43;},a37_0x2b20(_0x19dcaa,_0x5802b2);}exports[a37_0x2809ee(0x139)]=CoinToPayStatusService,exports[a37_0x2809ee(0x13b)]=new CoinToPayStatusService();