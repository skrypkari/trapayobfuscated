'use strict';const a37_0x31b75b=a37_0x345c;(function(_0x272956,_0x18f52d){const _0x53580d=a37_0x345c,_0x1ea09c=_0x272956();while(!![]){try{const _0x352168=-parseInt(_0x53580d(0xe8))/0x1*(parseInt(_0x53580d(0x98))/0x2)+-parseInt(_0x53580d(0x86))/0x3*(-parseInt(_0x53580d(0x144))/0x4)+parseInt(_0x53580d(0x92))/0x5*(-parseInt(_0x53580d(0x154))/0x6)+-parseInt(_0x53580d(0x10c))/0x7+parseInt(_0x53580d(0x119))/0x8*(parseInt(_0x53580d(0xd2))/0x9)+parseInt(_0x53580d(0xf1))/0xa+-parseInt(_0x53580d(0xe3))/0xb*(-parseInt(_0x53580d(0xa4))/0xc);if(_0x352168===_0x18f52d)break;else _0x1ea09c['push'](_0x1ea09c['shift']());}catch(_0x4a28ce){_0x1ea09c['push'](_0x1ea09c['shift']());}}}(a37_0x225f,0x25cb9));function a37_0x345c(_0xbbbc0b,_0x4bac16){const _0x225fd5=a37_0x225f();return a37_0x345c=function(_0x345cd8,_0x31e90a){_0x345cd8=_0x345cd8-0x72;let _0x2263f7=_0x225fd5[_0x345cd8];return _0x2263f7;},a37_0x345c(_0xbbbc0b,_0x4bac16);}var __importDefault=this&&this[a37_0x31b75b(0xf8)]||function(_0x380341){const _0x3894d1=a37_0x31b75b;return _0x380341&&_0x380341[_0x3894d1(0x108)]?_0x380341:{'default':_0x380341};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a37_0x31b75b(0x90)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a37_0x31b75b(0xf0))),telegramBotService_1=require(a37_0x31b75b(0xf6)),loggerService_1=require('./loggerService');function a37_0x225f(){const _0x28cd78=['\x20initial\x20timers\x20for\x20payment\x20','includes','\x20\x20\x20-\x20GatewayPaymentId:\x20','🪙\x20CoinToPayStatusService\x20initialized','gatewayOrderId','webhookLog','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20is\x20older\x20than\x20','error','status_check','PAID','\x20checked,\x20','schedule_created','28278QCrHKx','customerName','✅\x20[HOURLY]\x20Payment\x20','has','floor','iban','\x20individual\x20payment\x20timers','\x20completed\x20for\x20payment\x20','schedulePaymentChecks','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','push','bankDetails','\x20\x20\x20-\x20Status:\x20','create','delete','now','telegramBotService','205711iDZcSg','🛑\x20[SHUTDOWN]\x20Cleared\x20','length','log','\x20\x20\x20📍\x20Source:\x20','272981TTwWrt','h),\x20skipping\x20global\x20check','logCoinToPayStatus','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','checkAllPendingPayments','.\x20Remaining\x20active\x20timers:\x20','timers','getTime','../config/database','2402190AbndCr','sendShopWebhook','startPeriodicStatusCheck','confirmedOn','forEach','./telegramBotService','1\x20minute','__importDefault','created','findUnique','description','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','Bank\x20Details:\x20','\x20has\x20no\x20gatewayPaymentId','\x20to\x20','⏰\x20[EXPIRY]\x20Payment\x20','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','gatewayPaymentId','GLOBAL_CHECK_INTERVAL_MS','getDate','message','unknown','\x20to\x20clear','__esModule','payment','\x20triggered\x20for\x20payment\x20','\x20skipped,\x20','267106FFgaMC','⚠️\x20[CHECK]\x20Payment\x20','\x20found:','status','EXPIRED','CoinToPayStatusService','transactionId','webhook_send','ms)','checkPaymentStatus','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20\x20\x20📊\x20Status:\x20','setDate','696wqJEIg','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','paidAt','\x20\x20\x20-\x20gatewayPaymentId:\x20','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','TesSoft\x20Payment\x20System/1.0','✅\x20[CHECK]\x20Payment\x20','checkExpiredPayments','coinToPayService','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','values','\x20\x20\x20📅\x20Time:\x20','not\x20confirmed','\x20updated\x20successfully','\x20days,\x20marking\x20as\x20EXPIRED','expired','🪙\x20[TIMER]\x20Individual\x20check\x20#','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','⏰\x20[GLOBAL]\x20Found\x20','\x20status\x20is\x20','webhookUrl','getPaymentTimerInfo','logShopWebhookError','stringify','2\x20minutes','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20status:\x20','\x20expired\x20CoinToPay\x20payments','logShopWebhookSent','\x20days','❌\x20[HOURLY]\x20Payment\x20','currency','⏰\x20[HOURLY]\x20Payment\x20',',\x20clearing\x20individual\x20timers','\x20\x20\x20📝\x20Context:','\x20has\x20no\x20gatewayPaymentId,\x20skipping',',\x20stopping\x20individual\x20checks','Webhook\x20event\x20','cointopay','globalCheckInterval','orderId','stopPeriodicStatusCheck','\x20\x20\x20-\x20Amount:\x20','714692CEfaIT','customerEmail','EXPIRY_DAYS','stack','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','default','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','sendPaymentStatusNotification','Failed\x20to\x20send\x20shop\x20webhook:','shopId','from','✅\x20[TIMER]\x20Individual\x20check\x20#','🪙\x20[GLOBAL]\x20Found\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','size','4362fxjVny','clearPaymentTimers','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20\x20\x20-\x20paymentId:\x20','\x20expired','📊\x20[HOURLY]\x20Payment\x20','paymentDetails','FAILED','\x20days\x20without\x20payment\x20confirmation','🧹\x20[DEBUG]\x20Clearing\x20','\x20\x20\x20-\x20Gateway:\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','🧹\x20[CHECK]\x20Payment\x20','getServiceStats','not\x20found','COINTOPAY_STATUS_CHANGE','amount','payment.failed','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','\x20status\x20from\x20','PENDING','Shop\x20webhook\x20sent\x20to\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20\x20\x20📝\x20Details:','3AYBfmQ','delay','Payment\x20not\x20found','update','checkSinglePaymentById','remitterIban','paymentTimers','\x20days\x20(created\x20before\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','toLowerCase','coinToPayStatusService','checkSinglePayment','1685kcUAkI','timestamp','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','/status/','\x20timers\x20for\x20payment\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','2gavFSC','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','createdAt','set','webhookEvents','Automatically\x20expired\x20after\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','toFixed','Payment\x20older\x20than\x20','\x20in\x20','CoinToPayService','toISOString','12udwdqO','Success','text','\x20\x20\x20❌\x20Error:\x20','Unknown\x20error','cointopay_auto_expired','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','gateway','logCoinToPayError','shop','5\x20minutes','logWhiteDomainError','adminNotes','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','get','createdOn','application/json','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','\x20for\x20payment\x20','⏰\x20[GLOBAL]\x20Payment\x20','POST','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20status\x20unchanged\x20(','📊\x20[CHECK]\x20Payment\x20','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','catch','\x20\x20\x20-\x20ShopId:\x20','\x20current\x20status:\x20','-day\x20timeout','auto_expire','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20(after\x20'];a37_0x225f=function(){return _0x28cd78;};return a37_0x225f();}class CoinToPayStatusService{constructor(){const _0x54257c=a37_0x31b75b;this[_0x54257c(0x140)]=null,this[_0x54257c(0x103)]=0x3c*0x3c*0x3e8,this[_0x54257c(0x146)]=0x5,this[_0x54257c(0x8c)]=new Map(),this[_0x54257c(0x121)]=new coinToPayService_1[(_0x54257c(0xa2))](),console[_0x54257c(0xe6)](_0x54257c(0xc8));}[a37_0x31b75b(0xda)](_0x3547a2,_0x1eb562){const _0x41388b=a37_0x31b75b;console[_0x41388b(0xe6)](_0x41388b(0xeb)),console['log'](_0x41388b(0x159)+_0x3547a2),console[_0x41388b(0xe6)](_0x41388b(0x11c)+_0x1eb562),this['clearPaymentTimers'](_0x3547a2);const _0x1a021e=[],_0x5bd4cc=new Date(),_0x42bde8=[{'delay':0x1*0x3c*0x3e8,'description':_0x41388b(0xf7)},{'delay':0x2*0x3c*0x3e8,'description':_0x41388b(0x131)},{'delay':0x5*0x3c*0x3e8,'description':_0x41388b(0xae)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x41388b(0xe6)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x42bde8['length']+_0x41388b(0xc5)+_0x3547a2);let _0x37230c=0x0;_0x42bde8[_0x41388b(0xf5)]((_0x2cb3f1,_0x4c3ad3)=>{const _0x7c6aaa=_0x41388b;_0x37230c+=_0x2cb3f1[_0x7c6aaa(0x87)];const _0x2367dd=setTimeout(async()=>{const _0x93e246=_0x7c6aaa;console[_0x93e246(0xe6)](_0x93e246(0x129)+(_0x4c3ad3+0x1)+_0x93e246(0x10a)+_0x3547a2+_0x93e246(0xc4)+_0x2cb3f1[_0x93e246(0xfb)]+')');try{await this[_0x93e246(0x8a)](_0x3547a2),console[_0x93e246(0xe6)](_0x93e246(0x150)+(_0x4c3ad3+0x1)+_0x93e246(0xd9)+_0x3547a2);}catch(_0x292cba){console[_0x93e246(0xcd)]('❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x4c3ad3+0x1)+_0x93e246(0xb7)+_0x3547a2+':',_0x292cba),this[_0x93e246(0xac)](_0x3547a2,_0x1eb562,_0x292cba,_0x93e246(0xce),{'checkNumber':_0x4c3ad3+0x1,'scheduledAfter':_0x2cb3f1[_0x93e246(0xfb)],'isIndividualCheck':!![]});}},_0x37230c);_0x1a021e[_0x7c6aaa(0xdc)](_0x2367dd),console[_0x7c6aaa(0xe6)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x4c3ad3+0x1)+_0x7c6aaa(0xb7)+_0x3547a2+_0x7c6aaa(0xa1)+_0x37230c/0x3e8+'\x20seconds\x20('+_0x2cb3f1['description']+')');});const _0x2a9653=setInterval(async()=>{const _0x472af2=_0x41388b;console[_0x472af2(0xe6)]('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x3547a2);try{const _0xede6d6=await database_1[_0x472af2(0x14a)][_0x472af2(0x109)]['findUnique']({'where':{'id':_0x3547a2},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0xede6d6){console['log'](_0x472af2(0x137)+_0x3547a2+'\x20not\x20found,\x20clearing\x20timers'),this[_0x472af2(0x155)](_0x3547a2);return;}console['log'](_0x472af2(0x15b)+_0x3547a2+_0x472af2(0xc0)+_0xede6d6['status']);if(_0xede6d6[_0x472af2(0x10f)]!=='PENDING'){console[_0x472af2(0xe6)](_0x472af2(0xd4)+_0x3547a2+_0x472af2(0x12c)+_0xede6d6[_0x472af2(0x10f)]+_0x472af2(0x13d)),this[_0x472af2(0x155)](_0x3547a2);return;}const _0x69c83e=Math['floor']((Date[_0x472af2(0xe1)]()-_0xede6d6['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x69c83e>=this[_0x472af2(0x146)]){console[_0x472af2(0xe6)](_0x472af2(0x139)+_0x3547a2+_0x472af2(0xcc)+this[_0x472af2(0x146)]+_0x472af2(0x99)),this[_0x472af2(0x155)](_0x3547a2);return;}await this[_0x472af2(0x8a)](_0x3547a2),console[_0x472af2(0xe6)](_0x472af2(0x8e)+_0x3547a2);}catch(_0x266d3f){console['error'](_0x472af2(0xbd)+_0x3547a2+':',_0x266d3f),this[_0x472af2(0xac)](_0x3547a2,_0x1eb562,_0x266d3f,_0x472af2(0xce),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x1a021e[_0x41388b(0xdc)](_0x2a9653),this[_0x41388b(0x8c)][_0x41388b(0x9b)](_0x3547a2,{'timers':_0x1a021e,'paymentId':_0x3547a2,'gatewayPaymentId':_0x1eb562,'createdAt':_0x5bd4cc}),console[_0x41388b(0xe6)](_0x41388b(0x82)+_0x42bde8[_0x41388b(0xe5)]+_0x41388b(0x152)+_0x3547a2),console[_0x41388b(0xe6)](_0x41388b(0x149)+this[_0x41388b(0x8c)][_0x41388b(0x153)]),this[_0x41388b(0xea)](_0x3547a2,_0x1eb562,'PENDING',_0x41388b(0x80),_0x41388b(0xce),{'action':_0x41388b(0xd1),'scheduledChecks':_0x42bde8[_0x41388b(0xe5)],'firstCheckIn':_0x42bde8[0x0][_0x41388b(0x87)]/0x3e8,'totalTimers':this[_0x41388b(0x8c)]['size']});}[a37_0x31b75b(0x155)](_0x258609){const _0x3ae91a=a37_0x31b75b,_0x40f0ca=this[_0x3ae91a(0x8c)][_0x3ae91a(0xb2)](_0x258609);_0x40f0ca?(console['log'](_0x3ae91a(0x75)+_0x40f0ca[_0x3ae91a(0xee)]['length']+_0x3ae91a(0x96)+_0x258609),_0x40f0ca[_0x3ae91a(0xee)][_0x3ae91a(0xf5)]((_0x415db3,_0x1c45fd)=>{const _0x46a186=_0x3ae91a;_0x415db3&&(clearTimeout(_0x415db3),clearInterval(_0x415db3),console['log'](_0x46a186(0x9e)+(_0x1c45fd+0x1)+_0x46a186(0xb7)+_0x258609));}),this['paymentTimers'][_0x3ae91a(0xe0)](_0x258609),console['log'](_0x3ae91a(0x148)+_0x258609+_0x3ae91a(0xed)+this[_0x3ae91a(0x8c)]['size'])):console[_0x3ae91a(0xe6)](_0x3ae91a(0xb1)+_0x258609+_0x3ae91a(0x107));}async['checkSinglePaymentById'](_0x3d6a28){const _0x46e7ae=a37_0x31b75b;console[_0x46e7ae(0xe6)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x3d6a28);const _0x14ff8d=await database_1[_0x46e7ae(0x14a)][_0x46e7ae(0x109)]['findUnique']({'where':{'id':_0x3d6a28},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x14ff8d){console['log']('❌\x20[CHECK]\x20Payment\x20'+_0x3d6a28+'\x20not\x20found\x20in\x20database');return;}console['log'](_0x46e7ae(0xbc)+_0x3d6a28+_0x46e7ae(0x10e)),console[_0x46e7ae(0xe6)](_0x46e7ae(0x76)+_0x14ff8d[_0x46e7ae(0xab)]),console[_0x46e7ae(0xe6)](_0x46e7ae(0xde)+_0x14ff8d['status']),console[_0x46e7ae(0xe6)](_0x46e7ae(0xc7)+_0x14ff8d['gatewayPaymentId']),console[_0x46e7ae(0xe6)](_0x46e7ae(0x143)+_0x14ff8d['amount']+'\x20'+_0x14ff8d[_0x46e7ae(0x138)]),console[_0x46e7ae(0xe6)](_0x46e7ae(0xbf)+_0x14ff8d[_0x46e7ae(0x14e)]);if(_0x14ff8d[_0x46e7ae(0xab)]!==_0x46e7ae(0x13f)){console['log'](_0x46e7ae(0x10d)+_0x3d6a28+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x14ff8d[_0x46e7ae(0xab)]+')');return;}if(_0x14ff8d[_0x46e7ae(0x10f)]!==_0x46e7ae(0x80)){console['log'](_0x46e7ae(0x10d)+_0x3d6a28+_0x46e7ae(0x12c)+_0x14ff8d[_0x46e7ae(0x10f)]+_0x46e7ae(0x13d)),this[_0x46e7ae(0x155)](_0x3d6a28);return;}if(!_0x14ff8d[_0x46e7ae(0x102)]){console['log'](_0x46e7ae(0x10d)+_0x3d6a28+_0x46e7ae(0xfe));return;}console['log']('✅\x20[CHECK]\x20Payment\x20'+_0x3d6a28+_0x46e7ae(0xcb)),await this[_0x46e7ae(0x91)](_0x14ff8d);}[a37_0x31b75b(0xea)](_0x2cd369,_0x609763,_0x5e9134,_0x3ed621,_0x3a3b9a,_0x28a3ef){const _0x52728a=a37_0x31b75b,_0x3bdffe={'type':_0x52728a(0x7b),'paymentId':_0x2cd369,'gatewayPaymentId':_0x609763,'oldStatus':_0x5e9134,'newStatus':_0x3ed621,'source':_0x3a3b9a,'timestamp':new Date()[_0x52728a(0xa3)](),'details':_0x28a3ef||{}};loggerService_1['loggerService']['logCoinToPayStatus'](_0x3bdffe),console[_0x52728a(0xe6)](_0x52728a(0x11d)+_0x2cd369+'\x20('+_0x609763+')'),console[_0x52728a(0xe6)](_0x52728a(0x117)+_0x5e9134+'\x20->\x20'+_0x3ed621),console['log'](_0x52728a(0xe7)+_0x3a3b9a),console[_0x52728a(0xe6)](_0x52728a(0x124)+_0x3bdffe[_0x52728a(0x93)]),_0x28a3ef&&console['log'](_0x52728a(0x85),_0x28a3ef);}[a37_0x31b75b(0xac)](_0x33f4aa,_0x2158fd,_0x5882e1,_0x56549d,_0x25182a){const _0x544273=a37_0x31b75b,_0x2af66d={'type':'COINTOPAY_ERROR','paymentId':_0x33f4aa,'gatewayPaymentId':_0x2158fd,'error':_0x5882e1 instanceof Error?{'message':_0x5882e1[_0x544273(0x105)],'stack':_0x5882e1[_0x544273(0x147)]}:_0x5882e1,'source':_0x56549d,'timestamp':new Date()[_0x544273(0xa3)](),'context':_0x25182a||{}};loggerService_1['loggerService'][_0x544273(0xac)](_0x2af66d),console[_0x544273(0xcd)](_0x544273(0x122)+_0x33f4aa+'\x20('+_0x2158fd+')'),console['error'](_0x544273(0xa7)+(_0x5882e1 instanceof Error?_0x5882e1[_0x544273(0x105)]:_0x5882e1)),console['error']('\x20\x20\x20📍\x20Source:\x20'+_0x56549d),console[_0x544273(0xcd)]('\x20\x20\x20📅\x20Time:\x20'+_0x2af66d[_0x544273(0x93)]),_0x25182a&&console[_0x544273(0xcd)](_0x544273(0x13b),_0x25182a);}[a37_0x31b75b(0xf3)](){const _0xe14ef7=a37_0x31b75b;console[_0xe14ef7(0xe6)]('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0xe14ef7(0xec)]()[_0xe14ef7(0xbe)](_0x283003=>{const _0x1c8cd0=_0xe14ef7;console[_0x1c8cd0(0xcd)](_0x1c8cd0(0x157),_0x283003);}),this[_0xe14ef7(0x140)]=setInterval(async()=>{const _0x21d2eb=_0xe14ef7;try{console[_0x21d2eb(0xe6)](_0x21d2eb(0xaa)),await this[_0x21d2eb(0xec)](),console['log'](_0x21d2eb(0xc3));}catch(_0x1a010e){console['error']('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x1a010e);}},this[_0xe14ef7(0x103)]),console[_0xe14ef7(0xe6)](_0xe14ef7(0x84));}[a37_0x31b75b(0x142)](){const _0x4cb5a7=a37_0x31b75b;console[_0x4cb5a7(0xe6)](_0x4cb5a7(0x158));this[_0x4cb5a7(0x140)]&&(clearInterval(this[_0x4cb5a7(0x140)]),this[_0x4cb5a7(0x140)]=null,console[_0x4cb5a7(0xe6)](_0x4cb5a7(0x116)));const _0x2ac1a9=this['paymentTimers'][_0x4cb5a7(0x153)];for(const [_0x5acb17]of this['paymentTimers']){this[_0x4cb5a7(0x155)](_0x5acb17);}console['log'](_0x4cb5a7(0xe4)+_0x2ac1a9+_0x4cb5a7(0xd8));}async[a37_0x31b75b(0xec)](){const _0xbcb794=a37_0x31b75b;try{console[_0xbcb794(0xe6)](_0xbcb794(0x97));const _0x4fbd7d=await database_1[_0xbcb794(0x14a)][_0xbcb794(0x109)]['findMany']({'where':{'gateway':_0xbcb794(0x13f),'status':_0xbcb794(0x80),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0xbcb794(0x151)+_0x4fbd7d[_0xbcb794(0xe5)]+'\x20pending\x20CoinToPay\x20payments');if(_0x4fbd7d[_0xbcb794(0xe5)]===0x0){console[_0xbcb794(0xe6)](_0xbcb794(0xb5));return;}const _0x2e6879=await this[_0xbcb794(0x120)](_0x4fbd7d);console['log'](_0xbcb794(0x12b)+_0x2e6879[_0xbcb794(0xe5)]+_0xbcb794(0x134));let _0x21237e=0x0,_0x568c81=0x0;for(const _0x1efe2e of _0x4fbd7d){try{if(_0x2e6879[_0xbcb794(0xc6)](_0x1efe2e['id'])){console[_0xbcb794(0xe6)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x1efe2e['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x568c81++;continue;}if(this['paymentTimers'][_0xbcb794(0xd5)](_0x1efe2e['id'])){console[_0xbcb794(0xe6)](_0xbcb794(0xb8)+_0x1efe2e['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x568c81++;continue;}const _0x4211fa=(Date[_0xbcb794(0xe1)]()-_0x1efe2e[_0xbcb794(0x9a)][_0xbcb794(0xef)]())/(0x3e8*0x3c*0x3c);if(_0x4211fa<0x1){console[_0xbcb794(0xe6)](_0xbcb794(0xb8)+_0x1efe2e['id']+'\x20is\x20too\x20new\x20('+_0x4211fa[_0xbcb794(0x9f)](0x1)+_0xbcb794(0xe9)),_0x568c81++;continue;}console[_0xbcb794(0xe6)](_0xbcb794(0x7e)+_0x1efe2e['id']+'\x20(age:\x20'+_0x4211fa[_0xbcb794(0x9f)](0x1)+'h)'),await this[_0xbcb794(0x91)](_0x1efe2e),_0x21237e++,await new Promise(_0x35c9d6=>setTimeout(_0x35c9d6,0x7d0));}catch(_0x2f751f){console[_0xbcb794(0xcd)](_0xbcb794(0x12a)+_0x1efe2e['id']+':',_0x2f751f),this['logCoinToPayError'](_0x1efe2e['id'],_0x1efe2e[_0xbcb794(0x102)]||_0xbcb794(0x106),_0x2f751f,_0xbcb794(0xce),{'isGlobalCheck':!![],'paymentAmount':_0x1efe2e[_0xbcb794(0x7c)],'paymentCurrency':_0x1efe2e[_0xbcb794(0x138)],'shopId':_0x1efe2e[_0xbcb794(0x14e)],'createdAt':_0x1efe2e['createdAt']}),loggerService_1['loggerService'][_0xbcb794(0xaf)](_0xbcb794(0x13f),_0xbcb794(0x95)+_0x1efe2e[_0xbcb794(0x102)],_0x2f751f);}}console['log'](_0xbcb794(0x11a)+_0x21237e+_0xbcb794(0xd0)+_0x568c81+_0xbcb794(0x10b)+_0x2e6879[_0xbcb794(0xe5)]+_0xbcb794(0x15a));}catch(_0x193247){console[_0xbcb794(0xcd)](_0xbcb794(0xba),_0x193247);}}async[a37_0x31b75b(0x120)](_0x54e84f){const _0x60ad69=a37_0x31b75b,_0x463894=[],_0x4e33d2=new Date();_0x4e33d2[_0x60ad69(0x118)](_0x4e33d2[_0x60ad69(0x104)]()-this[_0x60ad69(0x146)]),console[_0x60ad69(0xe6)](_0x60ad69(0x156)+this['EXPIRY_DAYS']+_0x60ad69(0x8d)+_0x4e33d2['toISOString']()+')');for(const _0x1606d2 of _0x54e84f){if(_0x1606d2['createdAt']<_0x4e33d2){console[_0x60ad69(0xe6)](_0x60ad69(0x100)+_0x1606d2['id']+_0x60ad69(0xcc)+this[_0x60ad69(0x146)]+_0x60ad69(0x127));try{this[_0x60ad69(0xea)](_0x1606d2['id'],_0x1606d2['gatewayPaymentId']||_0x60ad69(0x106),'PENDING','EXPIRED',_0x60ad69(0xc2),{'reason':_0x60ad69(0xa0)+this['EXPIRY_DAYS']+_0x60ad69(0x136),'createdAt':_0x1606d2[_0x60ad69(0x9a)],'daysSinceCreation':Math[_0x60ad69(0xd6)]((Date[_0x60ad69(0xe1)]()-_0x1606d2[_0x60ad69(0x9a)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x1606d2[_0x60ad69(0x7c)],'paymentCurrency':_0x1606d2[_0x60ad69(0x138)],'shopId':_0x1606d2['shopId']}),await database_1[_0x60ad69(0x14a)][_0x60ad69(0x109)][_0x60ad69(0x89)]({'where':{'id':_0x1606d2['id']},'data':{'status':_0x60ad69(0x110),'updatedAt':new Date(),'adminNotes':_0x60ad69(0x9d)+this[_0x60ad69(0x146)]+_0x60ad69(0x74)}}),await database_1[_0x60ad69(0x14a)][_0x60ad69(0xca)][_0x60ad69(0xdf)]({'data':{'paymentId':_0x1606d2['id'],'shopId':_0x1606d2[_0x60ad69(0x14e)],'event':_0x60ad69(0xa9),'statusCode':0xc8,'responseBody':JSON[_0x60ad69(0x130)]({'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x60ad69(0x136),'createdAt':_0x1606d2[_0x60ad69(0x9a)],'expiredAt':new Date()[_0x60ad69(0xa3)](),'daysSinceCreation':Math[_0x60ad69(0xd6)]((Date[_0x60ad69(0xe1)]()-_0x1606d2[_0x60ad69(0x9a)][_0x60ad69(0xef)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x60ad69(0xf2)](_0x1606d2,_0x60ad69(0x110)),await this[_0x60ad69(0x14c)](_0x1606d2,_0x60ad69(0x110)),this[_0x60ad69(0x155)](_0x1606d2['id']),_0x463894['push'](_0x1606d2['id']),console[_0x60ad69(0xe6)]('✅\x20[EXPIRY]\x20Payment\x20'+_0x1606d2['id']+_0x60ad69(0x77)+this[_0x60ad69(0x146)]+_0x60ad69(0xc1));}catch(_0x154a04){console[_0x60ad69(0xcd)](_0x60ad69(0x101)+_0x1606d2['id']+':',_0x154a04),this[_0x60ad69(0xac)](_0x1606d2['id'],_0x1606d2['gatewayPaymentId']||_0x60ad69(0x106),_0x154a04,_0x60ad69(0xc2),{'reason':_0x60ad69(0x83),'createdAt':_0x1606d2[_0x60ad69(0x9a)],'daysSinceCreation':Math['floor']((Date[_0x60ad69(0xe1)]()-_0x1606d2['createdAt'][_0x60ad69(0xef)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x463894;}async[a37_0x31b75b(0x91)](_0x898e0c){const _0xd8ad50=a37_0x31b75b;if(!_0x898e0c[_0xd8ad50(0x102)]){console[_0xd8ad50(0xe6)](_0xd8ad50(0x10d)+_0x898e0c['id']+_0xd8ad50(0x13c));return;}console[_0xd8ad50(0xe6)](_0xd8ad50(0xb6)+_0x898e0c['id']+'\x20('+_0x898e0c['gatewayPaymentId']+')');try{const _0x400837=await this[_0xd8ad50(0x121)][_0xd8ad50(0x115)](_0x898e0c[_0xd8ad50(0x102)]);console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x898e0c['id']+_0xd8ad50(0x133)+_0x400837['status']);_0x400837[_0xd8ad50(0x72)]&&console['log'](_0xd8ad50(0xbc)+_0x898e0c['id']+'\x20details:',{'iban':_0x400837['paymentDetails']['iban']||_0xd8ad50(0x7a),'transactionId':_0x400837[_0xd8ad50(0x72)][_0xd8ad50(0x112)],'createdOn':_0x400837[_0xd8ad50(0x72)][_0xd8ad50(0xb3)],'confirmedOn':_0x400837[_0xd8ad50(0x72)][_0xd8ad50(0xf4)]||_0xd8ad50(0x125)});if(_0x400837[_0xd8ad50(0x10f)]!==_0x898e0c[_0xd8ad50(0x10f)]){console[_0xd8ad50(0xe6)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x898e0c['id']+_0xd8ad50(0x7f)+_0x898e0c[_0xd8ad50(0x10f)]+_0xd8ad50(0xff)+_0x400837['status']),this[_0xd8ad50(0xea)](_0x898e0c['id'],_0x898e0c[_0xd8ad50(0x102)],_0x898e0c[_0xd8ad50(0x10f)],_0x400837['status'],_0xd8ad50(0xce),{'paymentDetails':_0x400837['paymentDetails'],'amount':_0x400837[_0xd8ad50(0x7c)],'currency':_0x400837[_0xd8ad50(0x138)],'shopId':_0x898e0c['shopId'],'checkTimestamp':new Date()[_0xd8ad50(0xa3)]()});const _0x3f3205={'status':_0x400837[_0xd8ad50(0x10f)],'updatedAt':new Date()};_0x400837[_0xd8ad50(0x10f)]===_0xd8ad50(0xcf)&&_0x898e0c['status']!=='PAID'&&(_0x3f3205[_0xd8ad50(0x11b)]=new Date(),console[_0xd8ad50(0xe6)]('💰\x20[CHECK]\x20Payment\x20'+_0x898e0c['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x3f3205[_0xd8ad50(0x11b)][_0xd8ad50(0xa3)]()));if(_0x400837[_0xd8ad50(0x72)]){const _0x3a126c=_0x400837['paymentDetails'];_0x3a126c[_0xd8ad50(0xd7)]&&(_0x3f3205[_0xd8ad50(0x8b)]=_0x3a126c[_0xd8ad50(0xd7)],console['log'](_0xd8ad50(0xdb)+_0x3a126c[_0xd8ad50(0xd7)]));if(_0x3a126c['bankDetails']){const _0x7c879c=_0x898e0c[_0xd8ad50(0xb0)]||'',_0x1a8a23=_0xd8ad50(0xfd)+_0x3a126c[_0xd8ad50(0xdd)];_0x3f3205['adminNotes']=_0x7c879c?_0x7c879c+'\x0a\x0a'+_0x1a8a23:_0x1a8a23,console[_0xd8ad50(0xe6)](_0xd8ad50(0x132));}_0x3a126c[_0xd8ad50(0x112)]&&console[_0xd8ad50(0xe6)](_0xd8ad50(0x14b)+_0x3a126c[_0xd8ad50(0x112)]),_0x3a126c['confirmedOn']&&console[_0xd8ad50(0xe6)]('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x3a126c[_0xd8ad50(0xf4)]);}await database_1[_0xd8ad50(0x14a)]['payment']['update']({'where':{'id':_0x898e0c['id']},'data':_0x3f3205}),await database_1[_0xd8ad50(0x14a)]['webhookLog'][_0xd8ad50(0xdf)]({'data':{'paymentId':_0x898e0c['id'],'shopId':_0x898e0c['shopId'],'event':'cointopay_status_check_'+_0x400837[_0xd8ad50(0x10f)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x898e0c[_0xd8ad50(0x10f)],'newStatus':_0x400837[_0xd8ad50(0x10f)],'paymentDetails':_0x400837[_0xd8ad50(0x72)],'checkedAt':new Date()[_0xd8ad50(0xa3)]()})}}),await this[_0xd8ad50(0xf2)](_0x898e0c,_0x400837['status']),await this[_0xd8ad50(0x14c)](_0x898e0c,_0x400837[_0xd8ad50(0x10f)]),_0x400837[_0xd8ad50(0x10f)]!==_0xd8ad50(0x80)&&(console['log'](_0xd8ad50(0x78)+_0x898e0c['id']+'\x20status\x20changed\x20to\x20'+_0x400837[_0xd8ad50(0x10f)]+_0xd8ad50(0x13a)),this[_0xd8ad50(0x155)](_0x898e0c['id'])),console[_0xd8ad50(0xe6)](_0xd8ad50(0x11f)+_0x898e0c['id']+_0xd8ad50(0x126));}else console[_0xd8ad50(0xe6)](_0xd8ad50(0xbc)+_0x898e0c['id']+_0xd8ad50(0xbb)+_0x400837[_0xd8ad50(0x10f)]+')'),this[_0xd8ad50(0xea)](_0x898e0c['id'],_0x898e0c[_0xd8ad50(0x102)],_0x898e0c[_0xd8ad50(0x10f)],_0x400837[_0xd8ad50(0x10f)],_0xd8ad50(0xce),{'statusUnchanged':!![],'paymentDetails':_0x400837[_0xd8ad50(0x72)],'amount':_0x400837[_0xd8ad50(0x7c)],'currency':_0x400837[_0xd8ad50(0x138)],'shopId':_0x898e0c[_0xd8ad50(0x14e)],'checkTimestamp':new Date()[_0xd8ad50(0xa3)]()});}catch(_0x3d956b){console[_0xd8ad50(0xcd)](_0xd8ad50(0x94)+_0x898e0c['id']+':',_0x3d956b),this[_0xd8ad50(0xac)](_0x898e0c['id'],_0x898e0c[_0xd8ad50(0x102)],_0x3d956b,'status_check',{'paymentAmount':_0x898e0c['amount'],'paymentCurrency':_0x898e0c['currency'],'shopId':_0x898e0c[_0xd8ad50(0x14e)],'createdAt':_0x898e0c[_0xd8ad50(0x9a)]}),await database_1[_0xd8ad50(0x14a)][_0xd8ad50(0xca)]['create']({'data':{'paymentId':_0x898e0c['id'],'shopId':_0x898e0c[_0xd8ad50(0x14e)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x3d956b instanceof Error?_0x3d956b[_0xd8ad50(0x105)]:_0xd8ad50(0xa8),'gatewayPaymentId':_0x898e0c[_0xd8ad50(0x102)],'checkedAt':new Date()[_0xd8ad50(0xa3)]()})}});}}async['sendShopWebhook'](_0x352928,_0x303b8b){const _0x4d90ae=a37_0x31b75b,_0x7dd06b=Date[_0x4d90ae(0xe1)]();try{const _0x1174d3=_0x352928[_0x4d90ae(0xad)],_0x240cf4=_0x1174d3['settings'];if(!_0x240cf4?.[_0x4d90ae(0x12d)]){console[_0x4d90ae(0xe6)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1174d3['id']);return;}const _0x10bd6b=_0x303b8b===_0x4d90ae(0xcf)?'payment.success':_0x303b8b===_0x4d90ae(0x73)?_0x4d90ae(0x7d):_0x303b8b==='EXPIRED'?'payment.failed':'payment.pending';if(!_0x240cf4[_0x4d90ae(0x9c)]?.[_0x4d90ae(0xc6)](_0x10bd6b)){console[_0x4d90ae(0xe6)](_0x4d90ae(0x13e)+_0x10bd6b+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1174d3['id']);return;}const _0x37c349={'event':_0x10bd6b,'payment':{'id':_0x352928['id'],'order_id':_0x352928[_0x4d90ae(0x141)],'gateway_order_id':_0x352928[_0x4d90ae(0xc9)],'gateway':'0100','amount':_0x352928[_0x4d90ae(0x7c)],'currency':_0x352928[_0x4d90ae(0x138)],'status':_0x303b8b[_0x4d90ae(0x8f)](),'customer_email':_0x352928[_0x4d90ae(0x145)],'customer_name':_0x352928[_0x4d90ae(0xd3)],'created_at':_0x352928[_0x4d90ae(0x9a)],'updated_at':new Date()}},_0x59e6a1=await fetch(_0x240cf4[_0x4d90ae(0x12d)],{'method':_0x4d90ae(0xb9),'headers':{'Content-Type':_0x4d90ae(0xb4),'User-Agent':_0x4d90ae(0x11e)},'body':JSON['stringify'](_0x37c349)}),_0x25089d=Date[_0x4d90ae(0xe1)]()-_0x7dd06b,_0x326d8f=_0x59e6a1['ok']?_0x4d90ae(0xa5):await _0x59e6a1[_0x4d90ae(0xa6)]();loggerService_1['loggerService'][_0x4d90ae(0x135)](_0x352928['shopId'],_0x240cf4[_0x4d90ae(0x12d)],_0x10bd6b,_0x59e6a1[_0x4d90ae(0x10f)],_0x25089d,_0x37c349),console[_0x4d90ae(0xe6)](_0x4d90ae(0x81)+_0x240cf4[_0x4d90ae(0x12d)]+'\x20with\x20status\x20'+_0x59e6a1['status']+'\x20('+_0x25089d+_0x4d90ae(0x114));}catch(_0x1cad61){console[_0x4d90ae(0xcd)](_0x4d90ae(0x14d),_0x1cad61),loggerService_1['loggerService'][_0x4d90ae(0x12f)](_0x352928[_0x4d90ae(0x14e)],_0x352928['shop']?.['settings']?.['webhookUrl']||'unknown',_0x4d90ae(0x113),_0x1cad61,{});}}async[a37_0x31b75b(0x14c)](_0xd8eb45,_0x4b85a4){const _0x2d3ad6=a37_0x31b75b;try{const _0x4e9130={'PENDING':_0x2d3ad6(0xf9),'PAID':'paid','FAILED':'failed','EXPIRED':_0x2d3ad6(0x128)},_0x3a4615=_0x4e9130[_0x4b85a4];if(!_0x3a4615||_0x3a4615===_0x2d3ad6(0xf9))return;await telegramBotService_1[_0x2d3ad6(0xe2)]['sendPaymentNotification'](_0xd8eb45[_0x2d3ad6(0x14e)],_0xd8eb45,_0x3a4615);}catch(_0x1a98e5){console[_0x2d3ad6(0xcd)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x1a98e5);}}async['checkPaymentById'](_0x3931ab){const _0x560279=a37_0x31b75b;console['log'](_0x560279(0xfc)+_0x3931ab);const _0x4359f1=await database_1[_0x560279(0x14a)][_0x560279(0x109)][_0x560279(0xfa)]({'where':{'id':_0x3931ab},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4359f1)throw new Error(_0x560279(0x88));if(_0x4359f1['gateway']!=='cointopay')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x560279(0xe6)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x3931ab),await this[_0x560279(0x91)](_0x4359f1),console[_0x560279(0xe6)]('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x3931ab);}[a37_0x31b75b(0x79)](){const _0x3a1fe8=a37_0x31b75b,_0x4f18d6=this[_0x3a1fe8(0x140)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0xc45744=Array[_0x3a1fe8(0x14f)](this[_0x3a1fe8(0x8c)][_0x3a1fe8(0x123)]())['map'](_0x5f4cd6=>({'paymentId':_0x5f4cd6['paymentId'],'gatewayPaymentId':_0x5f4cd6[_0x3a1fe8(0x102)],'createdAt':_0x5f4cd6[_0x3a1fe8(0x9a)],'timersCount':_0x5f4cd6[_0x3a1fe8(0xee)][_0x3a1fe8(0xe5)]}));return{'isActive':!!this[_0x3a1fe8(0x140)],'globalCheckIntervalMinutes':this[_0x3a1fe8(0x103)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x3a1fe8(0x8c)][_0x3a1fe8(0x153)],'nextGlobalCheckIn':_0x4f18d6,'paymentTimersDetails':_0xc45744};}[a37_0x31b75b(0x12e)](_0x449628){const _0x12176a=a37_0x31b75b,_0x27bb13=this[_0x12176a(0x8c)]['get'](_0x449628);if(_0x27bb13)return{'hasTimers':!![],'timersCount':_0x27bb13[_0x12176a(0xee)][_0x12176a(0xe5)],'createdAt':_0x27bb13[_0x12176a(0x9a)],'gatewayPaymentId':_0x27bb13[_0x12176a(0x102)]};return{'hasTimers':![]};}}exports[a37_0x31b75b(0x111)]=CoinToPayStatusService,exports[a37_0x31b75b(0x90)]=new CoinToPayStatusService();