'use strict';const a37_0x14df91=a37_0x507d;(function(_0x5a58fd,_0x4500e8){const _0x1d7677=a37_0x507d,_0x5c4533=_0x5a58fd();while(!![]){try{const _0x640ac1=parseInt(_0x1d7677(0x2ae))/0x1*(parseInt(_0x1d7677(0x24c))/0x2)+-parseInt(_0x1d7677(0x211))/0x3*(-parseInt(_0x1d7677(0x201))/0x4)+parseInt(_0x1d7677(0x227))/0x5*(-parseInt(_0x1d7677(0x2b7))/0x6)+-parseInt(_0x1d7677(0x2e5))/0x7+parseInt(_0x1d7677(0x20d))/0x8*(parseInt(_0x1d7677(0x295))/0x9)+parseInt(_0x1d7677(0x29c))/0xa*(parseInt(_0x1d7677(0x2c7))/0xb)+parseInt(_0x1d7677(0x249))/0xc*(parseInt(_0x1d7677(0x230))/0xd);if(_0x640ac1===_0x4500e8)break;else _0x5c4533['push'](_0x5c4533['shift']());}catch(_0x20b8ea){_0x5c4533['push'](_0x5c4533['shift']());}}}(a37_0x576d,0xe08c5));var __importDefault=this&&this[a37_0x14df91(0x218)]||function(_0x6ec373){const _0xe8fad6=a37_0x14df91;return _0x6ec373&&_0x6ec373[_0xe8fad6(0x234)]?_0x6ec373:{'default':_0x6ec373};};Object[a37_0x14df91(0x27e)](exports,a37_0x14df91(0x234),{'value':!![]}),exports[a37_0x14df91(0x268)]=exports[a37_0x14df91(0x293)]=void 0x0;const coinToPayService_1=require(a37_0x14df91(0x23e)),database_1=__importDefault(require(a37_0x14df91(0x271))),telegramBotService_1=require(a37_0x14df91(0x21e)),loggerService_1=require(a37_0x14df91(0x277));function a37_0x507d(_0x2c30ce,_0x1cae1c){const _0x576d2a=a37_0x576d();return a37_0x507d=function(_0x507db5,_0x4f1ebf){_0x507db5=_0x507db5-0x1f0;let _0x2892ac=_0x576d2a[_0x507db5];return _0x2892ac;},a37_0x507d(_0x2c30ce,_0x1cae1c);}class CoinToPayStatusService{constructor(){const _0x2a0c52=a37_0x14df91;this[_0x2a0c52(0x225)]=null,this[_0x2a0c52(0x250)]=0x3c*0x3c*0x3e8,this[_0x2a0c52(0x286)]=0x5,this['paymentTimers']=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x2a0c52(0x229))](),console[_0x2a0c52(0x274)]('🪙\x20CoinToPayStatusService\x20initialized');}['schedulePaymentChecks'](_0x206c4c,_0xd3620d){const _0x38579d=a37_0x14df91;console[_0x38579d(0x274)](_0x38579d(0x272)),console[_0x38579d(0x274)](_0x38579d(0x2c8)+_0x206c4c),console[_0x38579d(0x274)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0xd3620d),this[_0x38579d(0x29d)](_0x206c4c);const _0x4311bf=[],_0x5c73cf=new Date(),_0x3b7ad2=[{'delay':0x1*0x3c*0x3e8,'description':_0x38579d(0x2d5)},{'delay':0x2*0x3c*0x3e8,'description':_0x38579d(0x245)},{'delay':0x5*0x3c*0x3e8,'description':_0x38579d(0x1f2)},{'delay':0x5*0x3c*0x3e8,'description':_0x38579d(0x1f2)}];console[_0x38579d(0x274)](_0x38579d(0x2e1)+_0x3b7ad2['length']+_0x38579d(0x29e)+_0x206c4c);let _0x38e41b=0x0;_0x3b7ad2['forEach']((_0x102088,_0x3935f9)=>{const _0xe1cb26=_0x38579d;_0x38e41b+=_0x102088[_0xe1cb26(0x228)];const _0x340fc=setTimeout(async()=>{const _0x126f7e=_0xe1cb26;console[_0x126f7e(0x274)](_0x126f7e(0x1fa)+(_0x3935f9+0x1)+_0x126f7e(0x20c)+_0x206c4c+_0x126f7e(0x259)+_0x102088[_0x126f7e(0x20f)]+')');try{await this['checkSinglePaymentById'](_0x206c4c),console[_0x126f7e(0x274)](_0x126f7e(0x25c)+(_0x3935f9+0x1)+_0x126f7e(0x212)+_0x206c4c);}catch(_0x3d8dab){console[_0x126f7e(0x255)](_0x126f7e(0x215)+(_0x3935f9+0x1)+_0x126f7e(0x2a8)+_0x206c4c+':',_0x3d8dab),this[_0x126f7e(0x2bd)](_0x206c4c,_0xd3620d,_0x3d8dab,_0x126f7e(0x1f3),{'checkNumber':_0x3935f9+0x1,'scheduledAfter':_0x102088[_0x126f7e(0x20f)],'isIndividualCheck':!![]});}},_0x38e41b);_0x4311bf[_0xe1cb26(0x2a0)](_0x340fc),console[_0xe1cb26(0x274)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x3935f9+0x1)+'\x20for\x20payment\x20'+_0x206c4c+_0xe1cb26(0x2c5)+_0x38e41b/0x3e8+_0xe1cb26(0x2d1)+_0x102088[_0xe1cb26(0x20f)]+')');});const _0x430cfe=setInterval(async()=>{const _0x532adc=_0x38579d;console['log'](_0x532adc(0x2a7)+_0x206c4c);try{const _0x3b9fe0=await database_1['default']['payment'][_0x532adc(0x233)]({'where':{'id':_0x206c4c},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x3b9fe0){console[_0x532adc(0x274)](_0x532adc(0x200)+_0x206c4c+_0x532adc(0x2dc)),this['clearPaymentTimers'](_0x206c4c);return;}console[_0x532adc(0x274)](_0x532adc(0x2d3)+_0x206c4c+_0x532adc(0x1f6)+_0x3b9fe0[_0x532adc(0x275)]);if(_0x3b9fe0['status']!=='PENDING'){console[_0x532adc(0x274)](_0x532adc(0x2bb)+_0x206c4c+_0x532adc(0x21c)+_0x3b9fe0[_0x532adc(0x275)]+',\x20stopping\x20individual\x20checks'),this[_0x532adc(0x29d)](_0x206c4c);return;}const _0x3dde92=Math[_0x532adc(0x241)]((Date['now']()-_0x3b9fe0[_0x532adc(0x261)][_0x532adc(0x24e)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x3dde92>=this[_0x532adc(0x286)]){console['log'](_0x532adc(0x2aa)+_0x206c4c+_0x532adc(0x2e0)+this[_0x532adc(0x286)]+_0x532adc(0x299)),this['clearPaymentTimers'](_0x206c4c);return;}await this['checkSinglePaymentById'](_0x206c4c),console[_0x532adc(0x274)](_0x532adc(0x248)+_0x206c4c);}catch(_0x40f0be){console[_0x532adc(0x255)](_0x532adc(0x207)+_0x206c4c+':',_0x40f0be),this[_0x532adc(0x2bd)](_0x206c4c,_0xd3620d,_0x40f0be,_0x532adc(0x1f3),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x4311bf[_0x38579d(0x2a0)](_0x430cfe),this[_0x38579d(0x276)][_0x38579d(0x26e)](_0x206c4c,{'timers':_0x4311bf,'paymentId':_0x206c4c,'gatewayPaymentId':_0xd3620d,'createdAt':_0x5c73cf}),console['log'](_0x38579d(0x29b)+_0x3b7ad2['length']+_0x38579d(0x22c)+_0x206c4c),console[_0x38579d(0x274)](_0x38579d(0x288)+this[_0x38579d(0x276)]['size']),this[_0x38579d(0x256)](_0x206c4c,_0xd3620d,_0x38579d(0x2b8),_0x38579d(0x2b8),_0x38579d(0x1f3),{'action':_0x38579d(0x27c),'scheduledChecks':_0x3b7ad2[_0x38579d(0x242)],'firstCheckIn':_0x3b7ad2[0x0][_0x38579d(0x228)]/0x3e8,'totalTimers':this['paymentTimers']['size']});}[a37_0x14df91(0x29d)](_0x5e4197){const _0x5b254c=a37_0x14df91,_0x59d379=this[_0x5b254c(0x276)][_0x5b254c(0x214)](_0x5e4197);_0x59d379?(console[_0x5b254c(0x274)](_0x5b254c(0x282)+_0x59d379[_0x5b254c(0x217)]['length']+_0x5b254c(0x204)+_0x5e4197),_0x59d379[_0x5b254c(0x217)][_0x5b254c(0x2ab)]((_0x3dccd2,_0x5ddf16)=>{const _0x51c0c3=_0x5b254c;_0x3dccd2&&(clearTimeout(_0x3dccd2),clearInterval(_0x3dccd2),console['log'](_0x51c0c3(0x2bc)+(_0x5ddf16+0x1)+'\x20for\x20payment\x20'+_0x5e4197));}),this[_0x5b254c(0x276)][_0x5b254c(0x209)](_0x5e4197),console[_0x5b254c(0x274)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x5e4197+_0x5b254c(0x2cf)+this[_0x5b254c(0x276)]['size'])):console[_0x5b254c(0x274)](_0x5b254c(0x216)+_0x5e4197+_0x5b254c(0x2df));}async['checkSinglePaymentById'](_0x3db505){const _0x1250b3=a37_0x14df91;console[_0x1250b3(0x274)](_0x1250b3(0x213)+_0x3db505);const _0x3b3d61=await database_1[_0x1250b3(0x23d)]['payment'][_0x1250b3(0x233)]({'where':{'id':_0x3db505},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3b3d61){console[_0x1250b3(0x274)]('❌\x20[CHECK]\x20Payment\x20'+_0x3db505+_0x1250b3(0x2d0));return;}console[_0x1250b3(0x274)](_0x1250b3(0x278)+_0x3db505+_0x1250b3(0x287)),console[_0x1250b3(0x274)](_0x1250b3(0x270)+_0x3b3d61[_0x1250b3(0x296)]),console[_0x1250b3(0x274)](_0x1250b3(0x2e2)+_0x3b3d61[_0x1250b3(0x275)]),console[_0x1250b3(0x274)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x3b3d61[_0x1250b3(0x27d)]),console[_0x1250b3(0x274)]('\x20\x20\x20-\x20Amount:\x20'+_0x3b3d61[_0x1250b3(0x25d)]+'\x20'+_0x3b3d61['currency']),console[_0x1250b3(0x274)](_0x1250b3(0x2d7)+_0x3b3d61['shopId']);if(_0x3b3d61['gateway']!=='cointopay'){console[_0x1250b3(0x274)](_0x1250b3(0x2c2)+_0x3db505+_0x1250b3(0x2a6)+_0x3b3d61['gateway']+')');return;}if(_0x3b3d61[_0x1250b3(0x275)]!==_0x1250b3(0x2b8)){console[_0x1250b3(0x274)](_0x1250b3(0x2c2)+_0x3db505+_0x1250b3(0x21c)+_0x3b3d61['status']+_0x1250b3(0x222)),this[_0x1250b3(0x29d)](_0x3db505);return;}if(!_0x3b3d61[_0x1250b3(0x27d)]){console[_0x1250b3(0x274)](_0x1250b3(0x2c2)+_0x3db505+_0x1250b3(0x1f9));return;}console[_0x1250b3(0x274)]('✅\x20[CHECK]\x20Payment\x20'+_0x3db505+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x1250b3(0x2c0)](_0x3b3d61);}[a37_0x14df91(0x256)](_0x4f2ec4,_0x573b04,_0x31e4f4,_0x4c47f1,_0x3bda03,_0x4bb964){const _0x550d9f=a37_0x14df91,_0x4ab97e={'type':_0x550d9f(0x28a),'paymentId':_0x4f2ec4,'gatewayPaymentId':_0x573b04,'oldStatus':_0x31e4f4,'newStatus':_0x4c47f1,'source':_0x3bda03,'timestamp':new Date()[_0x550d9f(0x279)](),'details':_0x4bb964||{}};loggerService_1[_0x550d9f(0x27b)][_0x550d9f(0x256)](_0x4ab97e),console['log'](_0x550d9f(0x2ba)+_0x4f2ec4+'\x20('+_0x573b04+')'),console[_0x550d9f(0x274)](_0x550d9f(0x251)+_0x31e4f4+_0x550d9f(0x1fb)+_0x4c47f1),console[_0x550d9f(0x274)]('\x20\x20\x20📍\x20Source:\x20'+_0x3bda03),console[_0x550d9f(0x274)](_0x550d9f(0x28b)+_0x4ab97e[_0x550d9f(0x2cb)]),_0x4bb964&&console[_0x550d9f(0x274)](_0x550d9f(0x26d),_0x4bb964);}[a37_0x14df91(0x2bd)](_0x5ddc3a,_0x388c90,_0x20f966,_0x567885,_0x4ae3de){const _0x464840=a37_0x14df91,_0x364e79={'type':'COINTOPAY_ERROR','paymentId':_0x5ddc3a,'gatewayPaymentId':_0x388c90,'error':_0x20f966 instanceof Error?{'message':_0x20f966[_0x464840(0x2c1)],'stack':_0x20f966[_0x464840(0x26a)]}:_0x20f966,'source':_0x567885,'timestamp':new Date()[_0x464840(0x279)](),'context':_0x4ae3de||{}};loggerService_1[_0x464840(0x27b)][_0x464840(0x2bd)](_0x364e79),console[_0x464840(0x255)](_0x464840(0x20e)+_0x5ddc3a+'\x20('+_0x388c90+')'),console[_0x464840(0x255)](_0x464840(0x21f)+(_0x20f966 instanceof Error?_0x20f966[_0x464840(0x2c1)]:_0x20f966)),console[_0x464840(0x255)]('\x20\x20\x20📍\x20Source:\x20'+_0x567885),console[_0x464840(0x255)](_0x464840(0x28b)+_0x364e79[_0x464840(0x2cb)]),_0x4ae3de&&console[_0x464840(0x255)](_0x464840(0x1f7),_0x4ae3de);}[a37_0x14df91(0x2b4)](){const _0x1c43d3=a37_0x14df91;console[_0x1c43d3(0x274)](_0x1c43d3(0x220)),this[_0x1c43d3(0x224)]()[_0x1c43d3(0x223)](_0x2d94ed=>{const _0x832892=_0x1c43d3;console[_0x832892(0x255)](_0x832892(0x23c),_0x2d94ed);}),this['globalCheckInterval']=setInterval(async()=>{const _0x2199d8=_0x1c43d3;try{console[_0x2199d8(0x274)](_0x2199d8(0x1fe)),await this[_0x2199d8(0x224)](),console[_0x2199d8(0x274)]('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0xdea801){console[_0x2199d8(0x255)]('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0xdea801);}},this[_0x1c43d3(0x250)]),console[_0x1c43d3(0x274)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}['stopPeriodicStatusCheck'](){const _0x59fe6b=a37_0x14df91;console[_0x59fe6b(0x274)](_0x59fe6b(0x203));this[_0x59fe6b(0x225)]&&(clearInterval(this[_0x59fe6b(0x225)]),this[_0x59fe6b(0x225)]=null,console[_0x59fe6b(0x274)](_0x59fe6b(0x221)));const _0x4b97f3=this['paymentTimers'][_0x59fe6b(0x2ad)];for(const [_0x5646d9]of this[_0x59fe6b(0x276)]){this['clearPaymentTimers'](_0x5646d9);}console['log'](_0x59fe6b(0x236)+_0x4b97f3+'\x20individual\x20payment\x20timers');}async[a37_0x14df91(0x224)](){const _0x39a395=a37_0x14df91;try{console[_0x39a395(0x274)](_0x39a395(0x2cd));const _0x4c6da4=await database_1['default'][_0x39a395(0x22f)][_0x39a395(0x254)]({'where':{'gateway':'cointopay','status':_0x39a395(0x2b8),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x39a395(0x274)](_0x39a395(0x25e)+_0x4c6da4['length']+_0x39a395(0x25a));if(_0x4c6da4[_0x39a395(0x242)]===0x0){console[_0x39a395(0x274)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x4955a8=await this[_0x39a395(0x232)](_0x4c6da4);console[_0x39a395(0x274)](_0x39a395(0x20b)+_0x4955a8[_0x39a395(0x242)]+'\x20expired\x20CoinToPay\x20payments');let _0x5aeab0=0x0,_0x471bda=0x0;for(const _0x28d81a of _0x4c6da4){try{if(_0x4955a8['includes'](_0x28d81a['id'])){console['log'](_0x39a395(0x252)+_0x28d81a['id']+_0x39a395(0x1f0)),_0x471bda++;continue;}if(this['paymentTimers'][_0x39a395(0x24d)](_0x28d81a['id'])){console[_0x39a395(0x274)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x28d81a['id']+_0x39a395(0x2db)),_0x471bda++;continue;}const _0x5679b0=(Date[_0x39a395(0x24f)]()-_0x28d81a[_0x39a395(0x261)][_0x39a395(0x24e)]())/(0x3e8*0x3c*0x3c);if(_0x5679b0<0x1){console[_0x39a395(0x274)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x28d81a['id']+_0x39a395(0x260)+_0x5679b0[_0x39a395(0x22e)](0x1)+'h),\x20skipping\x20global\x20check'),_0x471bda++;continue;}console['log']('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x28d81a['id']+_0x39a395(0x26f)+_0x5679b0[_0x39a395(0x22e)](0x1)+'h)'),await this[_0x39a395(0x2c0)](_0x28d81a),_0x5aeab0++,await new Promise(_0x3b79d4=>setTimeout(_0x3b79d4,0x7d0));}catch(_0x444cb2){console['error'](_0x39a395(0x29a)+_0x28d81a['id']+':',_0x444cb2),this[_0x39a395(0x2bd)](_0x28d81a['id'],_0x28d81a[_0x39a395(0x27d)]||_0x39a395(0x294),_0x444cb2,_0x39a395(0x1f3),{'isGlobalCheck':!![],'paymentAmount':_0x28d81a[_0x39a395(0x25d)],'paymentCurrency':_0x28d81a['currency'],'shopId':_0x28d81a[_0x39a395(0x2c6)],'createdAt':_0x28d81a[_0x39a395(0x261)]}),loggerService_1[_0x39a395(0x27b)][_0x39a395(0x2b9)](_0x39a395(0x1f1),_0x39a395(0x29f)+_0x28d81a[_0x39a395(0x27d)],_0x444cb2);}}console[_0x39a395(0x274)](_0x39a395(0x26b)+_0x5aeab0+_0x39a395(0x2a1)+_0x471bda+_0x39a395(0x208)+_0x4955a8[_0x39a395(0x242)]+_0x39a395(0x2b2));}catch(_0x190dd4){console[_0x39a395(0x255)](_0x39a395(0x25b),_0x190dd4);}}async['checkExpiredPayments'](_0x2eab24){const _0x2aa15f=a37_0x14df91,_0x3d7c5c=[],_0x1d4a85=new Date();_0x1d4a85[_0x2aa15f(0x1f4)](_0x1d4a85[_0x2aa15f(0x2e4)]()-this[_0x2aa15f(0x286)]),console[_0x2aa15f(0x274)](_0x2aa15f(0x226)+this[_0x2aa15f(0x286)]+_0x2aa15f(0x24b)+_0x1d4a85[_0x2aa15f(0x279)]()+')');for(const _0x38ca1d of _0x2eab24){if(_0x38ca1d[_0x2aa15f(0x261)]<_0x1d4a85){console[_0x2aa15f(0x274)](_0x2aa15f(0x2b0)+_0x38ca1d['id']+'\x20is\x20older\x20than\x20'+this[_0x2aa15f(0x286)]+_0x2aa15f(0x231));try{this['logCoinToPayStatus'](_0x38ca1d['id'],_0x38ca1d[_0x2aa15f(0x27d)]||_0x2aa15f(0x294),'PENDING','EXPIRED',_0x2aa15f(0x1ff),{'reason':'Payment\x20older\x20than\x20'+this[_0x2aa15f(0x286)]+_0x2aa15f(0x2c4),'createdAt':_0x38ca1d[_0x2aa15f(0x261)],'daysSinceCreation':Math['floor']((Date[_0x2aa15f(0x24f)]()-_0x38ca1d['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x38ca1d[_0x2aa15f(0x25d)],'paymentCurrency':_0x38ca1d[_0x2aa15f(0x2b1)],'shopId':_0x38ca1d[_0x2aa15f(0x2c6)]}),await database_1[_0x2aa15f(0x23d)]['payment'][_0x2aa15f(0x22a)]({'where':{'id':_0x38ca1d['id']},'data':{'status':_0x2aa15f(0x291),'updatedAt':new Date(),'adminNotes':_0x2aa15f(0x2b6)+this[_0x2aa15f(0x286)]+_0x2aa15f(0x27a)}}),await database_1[_0x2aa15f(0x23d)][_0x2aa15f(0x2a4)][_0x2aa15f(0x2b3)]({'data':{'paymentId':_0x38ca1d['id'],'shopId':_0x38ca1d[_0x2aa15f(0x2c6)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x2aa15f(0x2bf)]({'reason':_0x2aa15f(0x290)+this['EXPIRY_DAYS']+_0x2aa15f(0x2c4),'createdAt':_0x38ca1d[_0x2aa15f(0x261)],'expiredAt':new Date()[_0x2aa15f(0x279)](),'daysSinceCreation':Math[_0x2aa15f(0x241)]((Date[_0x2aa15f(0x24f)]()-_0x38ca1d['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x2aa15f(0x21b)](_0x38ca1d,_0x2aa15f(0x291)),await this['sendPaymentStatusNotification'](_0x38ca1d,_0x2aa15f(0x291)),this[_0x2aa15f(0x29d)](_0x38ca1d['id']),_0x3d7c5c[_0x2aa15f(0x2a0)](_0x38ca1d['id']),console[_0x2aa15f(0x274)](_0x2aa15f(0x2a2)+_0x38ca1d['id']+_0x2aa15f(0x273)+this[_0x2aa15f(0x286)]+'-day\x20timeout');}catch(_0x2c7f7a){console['error'](_0x2aa15f(0x2c3)+_0x38ca1d['id']+':',_0x2c7f7a),this[_0x2aa15f(0x2bd)](_0x38ca1d['id'],_0x38ca1d['gatewayPaymentId']||_0x2aa15f(0x294),_0x2c7f7a,_0x2aa15f(0x1ff),{'reason':_0x2aa15f(0x23f),'createdAt':_0x38ca1d[_0x2aa15f(0x261)],'daysSinceCreation':Math[_0x2aa15f(0x241)]((Date[_0x2aa15f(0x24f)]()-_0x38ca1d[_0x2aa15f(0x261)][_0x2aa15f(0x24e)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x3d7c5c;}async[a37_0x14df91(0x2c0)](_0x2ac91d){const _0xae22b1=a37_0x14df91;if(!_0x2ac91d[_0xae22b1(0x27d)]){console[_0xae22b1(0x274)](_0xae22b1(0x2c2)+_0x2ac91d['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0xae22b1(0x274)](_0xae22b1(0x210)+_0x2ac91d['id']+'\x20('+_0x2ac91d[_0xae22b1(0x27d)]+')');try{const _0x4c705c=await this[_0xae22b1(0x22d)][_0xae22b1(0x2d2)](_0x2ac91d[_0xae22b1(0x27d)]);console['log'](_0xae22b1(0x278)+_0x2ac91d['id']+'\x20status:\x20'+_0x4c705c[_0xae22b1(0x275)]);_0x4c705c['paymentDetails']&&console['log'](_0xae22b1(0x278)+_0x2ac91d['id']+_0xae22b1(0x265),{'iban':_0x4c705c[_0xae22b1(0x2dd)][_0xae22b1(0x1f8)]||_0xae22b1(0x238),'transactionId':_0x4c705c[_0xae22b1(0x2dd)][_0xae22b1(0x244)],'createdOn':_0x4c705c[_0xae22b1(0x2dd)][_0xae22b1(0x1f5)],'confirmedOn':_0x4c705c[_0xae22b1(0x2dd)][_0xae22b1(0x26c)]||_0xae22b1(0x2c9)});if(_0x4c705c[_0xae22b1(0x275)]!==_0x2ac91d['status']){console[_0xae22b1(0x274)](_0xae22b1(0x2b5)+_0x2ac91d['id']+_0xae22b1(0x1fd)+_0x2ac91d[_0xae22b1(0x275)]+_0xae22b1(0x235)+_0x4c705c[_0xae22b1(0x275)]),this[_0xae22b1(0x256)](_0x2ac91d['id'],_0x2ac91d[_0xae22b1(0x27d)],_0x2ac91d[_0xae22b1(0x275)],_0x4c705c[_0xae22b1(0x275)],_0xae22b1(0x1f3),{'paymentDetails':_0x4c705c[_0xae22b1(0x2dd)],'amount':_0x4c705c[_0xae22b1(0x25d)],'currency':_0x4c705c[_0xae22b1(0x2b1)],'shopId':_0x2ac91d[_0xae22b1(0x2c6)],'checkTimestamp':new Date()['toISOString']()});const _0x28d319={'status':_0x4c705c[_0xae22b1(0x275)],'updatedAt':new Date()};_0x4c705c[_0xae22b1(0x275)]===_0xae22b1(0x21d)&&_0x2ac91d[_0xae22b1(0x275)]!==_0xae22b1(0x21d)&&(_0x28d319['paidAt']=new Date(),console[_0xae22b1(0x274)](_0xae22b1(0x28f)+_0x2ac91d['id']+_0xae22b1(0x280)+_0x28d319[_0xae22b1(0x28d)][_0xae22b1(0x279)]()));if(_0x4c705c[_0xae22b1(0x2dd)]){const _0x297ef5=_0x4c705c[_0xae22b1(0x2dd)];_0x297ef5[_0xae22b1(0x1f8)]&&(_0x28d319[_0xae22b1(0x2cc)]=_0x297ef5[_0xae22b1(0x1f8)],console[_0xae22b1(0x274)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x297ef5[_0xae22b1(0x1f8)]));if(_0x297ef5[_0xae22b1(0x258)]){const _0x7a7295=_0x2ac91d[_0xae22b1(0x20a)]||'',_0x8b68e4=_0xae22b1(0x27f)+_0x297ef5['bankDetails'];_0x28d319[_0xae22b1(0x20a)]=_0x7a7295?_0x7a7295+'\x0a\x0a'+_0x8b68e4:_0x8b68e4,console[_0xae22b1(0x274)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x297ef5[_0xae22b1(0x244)]&&console[_0xae22b1(0x274)](_0xae22b1(0x243)+_0x297ef5['transactionId']),_0x297ef5[_0xae22b1(0x26c)]&&console['log'](_0xae22b1(0x283)+_0x297ef5[_0xae22b1(0x26c)]);}await database_1['default'][_0xae22b1(0x22f)]['update']({'where':{'id':_0x2ac91d['id']},'data':_0x28d319}),await database_1[_0xae22b1(0x23d)][_0xae22b1(0x2a4)][_0xae22b1(0x2b3)]({'data':{'paymentId':_0x2ac91d['id'],'shopId':_0x2ac91d[_0xae22b1(0x2c6)],'event':'cointopay_status_check_'+_0x4c705c['status'][_0xae22b1(0x2ca)](),'statusCode':0xc8,'responseBody':JSON[_0xae22b1(0x2bf)]({'oldStatus':_0x2ac91d[_0xae22b1(0x275)],'newStatus':_0x4c705c[_0xae22b1(0x275)],'paymentDetails':_0x4c705c['paymentDetails'],'checkedAt':new Date()[_0xae22b1(0x279)]()})}}),await this[_0xae22b1(0x21b)](_0x2ac91d,_0x4c705c[_0xae22b1(0x275)]),await this[_0xae22b1(0x284)](_0x2ac91d,_0x4c705c[_0xae22b1(0x275)]),_0x4c705c[_0xae22b1(0x275)]!==_0xae22b1(0x2b8)&&(console[_0xae22b1(0x274)](_0xae22b1(0x1fc)+_0x2ac91d['id']+_0xae22b1(0x247)+_0x4c705c[_0xae22b1(0x275)]+',\x20clearing\x20individual\x20timers'),this['clearPaymentTimers'](_0x2ac91d['id'])),console['log']('✅\x20[CHECK]\x20Payment\x20'+_0x2ac91d['id']+_0xae22b1(0x2a5));}else console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x2ac91d['id']+_0xae22b1(0x21a)+_0x4c705c[_0xae22b1(0x275)]+')'),this[_0xae22b1(0x256)](_0x2ac91d['id'],_0x2ac91d[_0xae22b1(0x27d)],_0x2ac91d['status'],_0x4c705c[_0xae22b1(0x275)],_0xae22b1(0x1f3),{'statusUnchanged':!![],'paymentDetails':_0x4c705c[_0xae22b1(0x2dd)],'amount':_0x4c705c[_0xae22b1(0x25d)],'currency':_0x4c705c['currency'],'shopId':_0x2ac91d['shopId'],'checkTimestamp':new Date()[_0xae22b1(0x279)]()});}catch(_0x52d62d){console['error']('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x2ac91d['id']+':',_0x52d62d),this[_0xae22b1(0x2bd)](_0x2ac91d['id'],_0x2ac91d[_0xae22b1(0x27d)],_0x52d62d,_0xae22b1(0x1f3),{'paymentAmount':_0x2ac91d[_0xae22b1(0x25d)],'paymentCurrency':_0x2ac91d['currency'],'shopId':_0x2ac91d[_0xae22b1(0x2c6)],'createdAt':_0x2ac91d[_0xae22b1(0x261)]}),await database_1['default'][_0xae22b1(0x2a4)]['create']({'data':{'paymentId':_0x2ac91d['id'],'shopId':_0x2ac91d[_0xae22b1(0x2c6)],'event':_0xae22b1(0x269),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x52d62d instanceof Error?_0x52d62d['message']:'Unknown\x20error','gatewayPaymentId':_0x2ac91d[_0xae22b1(0x27d)],'checkedAt':new Date()['toISOString']()})}});}}async[a37_0x14df91(0x21b)](_0x39fa08,_0x5f372c){const _0x286c50=a37_0x14df91,_0x15c3ea=Date[_0x286c50(0x24f)]();try{const _0x4e0179=_0x39fa08[_0x286c50(0x2de)],_0x2fc163=_0x4e0179[_0x286c50(0x298)];if(!_0x2fc163?.[_0x286c50(0x237)]){console['log'](_0x286c50(0x2a9)+_0x4e0179['id']);return;}const _0x3c75e2=_0x5f372c==='PAID'?_0x286c50(0x257):_0x5f372c==='FAILED'?_0x286c50(0x2d6):_0x5f372c===_0x286c50(0x291)?_0x286c50(0x2d6):'payment.pending';if(!_0x2fc163[_0x286c50(0x240)]?.[_0x286c50(0x206)](_0x3c75e2)){console[_0x286c50(0x274)](_0x286c50(0x2ac)+_0x3c75e2+_0x286c50(0x2da)+_0x4e0179['id']);return;}const _0x456be9={'event':_0x3c75e2,'payment':{'id':_0x39fa08['id'],'order_id':_0x39fa08[_0x286c50(0x25f)],'gateway_order_id':_0x39fa08[_0x286c50(0x23a)],'gateway':_0x286c50(0x22b),'amount':_0x39fa08[_0x286c50(0x25d)],'currency':_0x39fa08[_0x286c50(0x2b1)],'status':_0x5f372c[_0x286c50(0x2ca)](),'customer_email':_0x39fa08[_0x286c50(0x2ce)],'customer_name':_0x39fa08[_0x286c50(0x2be)],'created_at':_0x39fa08[_0x286c50(0x261)],'updated_at':new Date()}},_0x2950a1=await fetch(_0x2fc163[_0x286c50(0x237)],{'method':_0x286c50(0x23b),'headers':{'Content-Type':_0x286c50(0x246),'User-Agent':_0x286c50(0x2a3)},'body':JSON[_0x286c50(0x2bf)](_0x456be9)}),_0x5eb4d6=Date[_0x286c50(0x24f)]()-_0x15c3ea,_0x269fb1=_0x2950a1['ok']?_0x286c50(0x2af):await _0x2950a1[_0x286c50(0x28e)]();loggerService_1['loggerService'][_0x286c50(0x239)](_0x39fa08[_0x286c50(0x2c6)],_0x2fc163[_0x286c50(0x237)],_0x3c75e2,_0x2950a1[_0x286c50(0x275)],_0x5eb4d6,_0x456be9),console[_0x286c50(0x274)](_0x286c50(0x266)+_0x2fc163[_0x286c50(0x237)]+_0x286c50(0x2e3)+_0x2950a1[_0x286c50(0x275)]+'\x20('+_0x5eb4d6+_0x286c50(0x267));}catch(_0x4fda4e){console[_0x286c50(0x255)](_0x286c50(0x289),_0x4fda4e),loggerService_1['loggerService']['logShopWebhookError'](_0x39fa08[_0x286c50(0x2c6)],_0x39fa08['shop']?.[_0x286c50(0x298)]?.[_0x286c50(0x237)]||_0x286c50(0x294),_0x286c50(0x285),_0x4fda4e,{});}}async[a37_0x14df91(0x284)](_0x207596,_0x5cdd4f){const _0x342cfd=a37_0x14df91;try{const _0x426a1b={'PENDING':'created','PAID':'paid','FAILED':_0x342cfd(0x2d9),'EXPIRED':_0x342cfd(0x253)},_0x182901=_0x426a1b[_0x5cdd4f];if(!_0x182901||_0x182901===_0x342cfd(0x28c))return;await telegramBotService_1[_0x342cfd(0x262)][_0x342cfd(0x292)](_0x207596[_0x342cfd(0x2c6)],_0x207596,_0x182901);}catch(_0x4b06f3){console[_0x342cfd(0x255)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4b06f3);}}async[a37_0x14df91(0x202)](_0x3d6af3){const _0x20423a=a37_0x14df91;console[_0x20423a(0x274)](_0x20423a(0x297)+_0x3d6af3);const _0x2fcf48=await database_1[_0x20423a(0x23d)][_0x20423a(0x22f)]['findUnique']({'where':{'id':_0x3d6af3},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2fcf48)throw new Error(_0x20423a(0x263));if(_0x2fcf48[_0x20423a(0x296)]!=='cointopay')throw new Error(_0x20423a(0x219));console[_0x20423a(0x274)](_0x20423a(0x2d4)+_0x3d6af3),await this[_0x20423a(0x2c0)](_0x2fcf48),console[_0x20423a(0x274)](_0x20423a(0x24a)+_0x3d6af3);}[a37_0x14df91(0x205)](){const _0x495d62=a37_0x14df91,_0x571078=this[_0x495d62(0x225)]?this[_0x495d62(0x250)]:undefined,_0x22eb09=Array[_0x495d62(0x281)](this[_0x495d62(0x276)]['values']())['map'](_0x39e03a=>({'paymentId':_0x39e03a[_0x495d62(0x264)],'gatewayPaymentId':_0x39e03a['gatewayPaymentId'],'createdAt':_0x39e03a[_0x495d62(0x261)],'timersCount':_0x39e03a['timers']['length']}));return{'isActive':!!this[_0x495d62(0x225)],'globalCheckIntervalMinutes':this[_0x495d62(0x250)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x495d62(0x276)][_0x495d62(0x2ad)],'nextGlobalCheckIn':_0x571078,'paymentTimersDetails':_0x22eb09};}[a37_0x14df91(0x2d8)](_0x1ecd1a){const _0x1d0d47=a37_0x14df91,_0x3de5ba=this[_0x1d0d47(0x276)]['get'](_0x1ecd1a);if(_0x3de5ba)return{'hasTimers':!![],'timersCount':_0x3de5ba[_0x1d0d47(0x217)][_0x1d0d47(0x242)],'createdAt':_0x3de5ba[_0x1d0d47(0x261)],'gatewayPaymentId':_0x3de5ba['gatewayPaymentId']};return{'hasTimers':![]};}}function a37_0x576d(){const _0x450986=['unknown','2421cdCbBi','gateway','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','settings','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','4090QZfifz','clearPaymentTimers','\x20initial\x20timers\x20for\x20payment\x20','/status/','push','\x20checked,\x20','✅\x20[EXPIRY]\x20Payment\x20','TesSoft\x20Payment\x20System/1.0','webhookLog','\x20updated\x20successfully','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20for\x20payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','⏰\x20[HOURLY]\x20Payment\x20','forEach','Webhook\x20event\x20','size','386794TOJuDK','Success','⏰\x20[EXPIRY]\x20Payment\x20','currency','\x20expired','create','startPeriodicStatusCheck','🔄\x20[CHECK]\x20Updating\x20payment\x20','Automatically\x20expired\x20after\x20','6bGHwMN','PENDING','logWhiteDomainError','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','✅\x20[HOURLY]\x20Payment\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','logCoinToPayError','customerName','stringify','checkSinglePayment','message','⚠️\x20[CHECK]\x20Payment\x20','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','\x20days','\x20in\x20','shopId','17314Vdkdjb','\x20\x20\x20-\x20paymentId:\x20','not\x20confirmed','toLowerCase','timestamp','remitterIban','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','customerEmail','.\x20Remaining\x20active\x20timers:\x20','\x20not\x20found\x20in\x20database','\x20seconds\x20(','checkPaymentStatus','📊\x20[HOURLY]\x20Payment\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','1\x20minute','payment.failed','\x20\x20\x20-\x20ShopId:\x20','getPaymentTimerInfo','failed','\x20not\x20enabled\x20for\x20shop\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20not\x20found,\x20clearing\x20timers','paymentDetails','shop','\x20to\x20clear','\x20is\x20older\x20than\x20','🪙\x20[DEBUG]\x20Creating\x20','\x20\x20\x20-\x20Status:\x20','\x20with\x20status\x20','getDate','11679101JxtALd','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','cointopay','5\x20minutes','status_check','setDate','createdOn','\x20current\x20status:\x20','\x20\x20\x20📝\x20Context:','iban','\x20has\x20no\x20gatewayPaymentId','🪙\x20[TIMER]\x20Individual\x20check\x20#','\x20->\x20','🧹\x20[CHECK]\x20Payment\x20','\x20status\x20from\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','auto_expire','❌\x20[HOURLY]\x20Payment\x20','1324exHqJn','checkPaymentById','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20timers\x20for\x20payment\x20','getServiceStats','includes','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20skipped,\x20','delete','adminNotes','⏰\x20[GLOBAL]\x20Found\x20','\x20triggered\x20for\x20payment\x20','2696CiwvKr','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','description','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','12102GQPKdW','\x20completed\x20for\x20payment\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','get','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','timers','__importDefault','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20status\x20unchanged\x20(','sendShopWebhook','\x20status\x20is\x20','PAID','./telegramBotService','\x20\x20\x20❌\x20Error:\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped',',\x20stopping\x20individual\x20checks','catch','checkAllPendingPayments','globalCheckInterval','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','2330Tlvlwv','delay','CoinToPayService','update','0100','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','coinToPayService','toFixed','payment','25649Xuktfu','\x20days,\x20marking\x20as\x20EXPIRED','checkExpiredPayments','findUnique','__esModule','\x20to\x20','🛑\x20[SHUTDOWN]\x20Cleared\x20','webhookUrl','not\x20found','logShopWebhookSent','gatewayOrderId','POST','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','default','./gateways/coinToPayService','Failed\x20to\x20mark\x20payment\x20as\x20expired','webhookEvents','floor','length','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','transactionId','2\x20minutes','application/json','\x20status\x20changed\x20to\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','804lAYsXz','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20days\x20(created\x20before\x20','2QjAAiq','has','getTime','now','GLOBAL_CHECK_INTERVAL_MS','\x20\x20\x20📊\x20Status:\x20','⏰\x20[GLOBAL]\x20Payment\x20','expired','findMany','error','logCoinToPayStatus','payment.success','bankDetails','\x20(after\x20','\x20pending\x20CoinToPay\x20payments','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','✅\x20[TIMER]\x20Individual\x20check\x20#','amount','🪙\x20[GLOBAL]\x20Found\x20','orderId','\x20is\x20too\x20new\x20(','createdAt','telegramBotService','Payment\x20not\x20found','paymentId','\x20details:','Shop\x20webhook\x20sent\x20to\x20','ms)','coinToPayStatusService','cointopay_status_check_error','stack','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','confirmedOn','\x20\x20\x20📝\x20Details:','set','\x20(age:\x20','\x20\x20\x20-\x20Gateway:\x20','../config/database','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','log','status','paymentTimers','./loggerService','📊\x20[CHECK]\x20Payment\x20','toISOString','\x20days\x20without\x20payment\x20confirmation','loggerService','schedule_created','gatewayPaymentId','defineProperty','Bank\x20Details:\x20','\x20marked\x20as\x20paid\x20at:\x20','from','🧹\x20[DEBUG]\x20Clearing\x20','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','sendPaymentStatusNotification','webhook_send','EXPIRY_DAYS','\x20found:','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','Failed\x20to\x20send\x20shop\x20webhook:','COINTOPAY_STATUS_CHANGE','\x20\x20\x20📅\x20Time:\x20','created','paidAt','text','💰\x20[CHECK]\x20Payment\x20','Payment\x20older\x20than\x20','EXPIRED','sendPaymentNotification','CoinToPayStatusService'];a37_0x576d=function(){return _0x450986;};return a37_0x576d();}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a37_0x14df91(0x268)]=new CoinToPayStatusService();