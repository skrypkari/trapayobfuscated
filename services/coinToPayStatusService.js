'use strict';const a35_0x1c68f7=a35_0x4a8d;function a35_0x2106(){const _0x36c971=['update','Failed\x20to\x20check\x20payment\x20','PAID','Webhook\x20event\x20','ms)','Shop\x20webhook\x20sent\x20to\x20','__importDefault','telegramBotService','1554804COjkkA','\x20status\x20unchanged\x20(','payment','adminNotes','gateway','checkPaymentStatus','failed','TesSoft\x20Payment\x20System/1.0','\x20not\x20enabled\x20for\x20shop\x20','Failed\x20to\x20expire\x20payment\x20','paymentDetails','coinToPayStatusService','toISOString','ðŸ†”\x20Transaction\x20ID:\x20','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','getServiceStats','application/json','checkExpiredPayments','85967AiIzNt','error','15LdAusb','sendShopWebhook','CoinToPayStatusService','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','status','cointopay_status_check_','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','gatewayOrderId','\x20marked\x20as\x20paid\x20at:\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','checkSinglePayment','startPeriodicStatusCheck','1112qJVJGS','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','toLowerCase','defineProperty','message','floor','currency','shop','paidAt','loggerService','logShopWebhookError','â°\x20Found\x20','bankDetails','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','EXPIRY_DAYS','Automatically\x20expired\x20after\x20','cointopay','checkInterval','gatewayPaymentId','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','__esModule','FAILED','â°\x20Payment\x20','remitterIban','\x20days\x20without\x20payment\x20confirmation','amount','../config/database','69TpcfqO','includes','coinToPayService','getTime','Payment\x20not\x20found','\x20details:','stringify','/status/','15411123qXtHON','shopId','getDate','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','setDate','created','\x20to\x20','ðŸ’°\x20Payment\x20','push','47048XPsmpz','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','webhookLog','âš ï¸\x20Payment\x20','confirmedOn','POST','ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped','cointopay_status_check_error','\x20days','./telegramBotService','Failed\x20to\x20send\x20shop\x20webhook:','ðŸ”„\x20Updating\x20payment\x20','stopPeriodicStatusCheck','\x20with\x20status\x20','ðŸ“Š\x20Payment\x20','\x20is\x20older\x20than\x20','1150536OAWWfZ','ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','46625160zOAVNN','customerName','âœ…\x20Completed\x20checking\x20','expired','unknown','Success','length','logWhiteDomainError','0100','iban','ðŸ”\x20Checking\x20CoinToPay\x20payment\x20','Bank\x20Details:\x20','ðŸª™\x20Checking\x20','now','CoinToPayService','sendPaymentStatusNotification','webhook_send','transactionId','3021726gPhtuD','âœ…\x20Payment\x20','log','\x20status\x20from\x20','EXPIRED','createdAt','checkAllPendingPayments','sendPaymentNotification','CHECK_INTERVAL_MS','default','webhookEvents','orderId','findUnique','settings','webhookUrl','\x20updated\x20successfully','Periodic\x20CoinToPay\x20status\x20check\x20failed:','paid','checkPaymentById','create'];a35_0x2106=function(){return _0x36c971;};return a35_0x2106();}(function(_0x2879a9,_0x1879e2){const _0x28825c=a35_0x4a8d,_0x35f2fb=_0x2879a9();while(!![]){try{const _0x591a8d=-parseInt(_0x28825c(0x95))/0x1*(parseInt(_0x28825c(0xa6))/0x2)+-parseInt(_0x28825c(0xcb))/0x3+-parseInt(_0x28825c(0xb7))/0x4+parseInt(_0x28825c(0xfb))/0x5*(-parseInt(_0x28825c(0xe7))/0x6)+parseInt(_0x28825c(0xf9))/0x7*(parseInt(_0x28825c(0x107))/0x8)+-parseInt(_0x28825c(0x9d))/0x9+parseInt(_0x28825c(0xb9))/0xa;if(_0x591a8d===_0x1879e2)break;else _0x35f2fb['push'](_0x35f2fb['shift']());}catch(_0x2f7b6b){_0x35f2fb['push'](_0x35f2fb['shift']());}}}(a35_0x2106,0xead02));var __importDefault=this&&this[a35_0x1c68f7(0xe5)]||function(_0x314151){return _0x314151&&_0x314151['__esModule']?_0x314151:{'default':_0x314151};};Object[a35_0x1c68f7(0x10a)](exports,a35_0x1c68f7(0x8e),{'value':!![]}),exports[a35_0x1c68f7(0xf2)]=exports['CoinToPayStatusService']=void 0x0;function a35_0x4a8d(_0x223234,_0x5cc70b){const _0x210688=a35_0x2106();return a35_0x4a8d=function(_0x4a8daf,_0x4dce63){_0x4a8daf=_0x4a8daf-0x86;let _0x178928=_0x210688[_0x4a8daf];return _0x178928;},a35_0x4a8d(_0x223234,_0x5cc70b);}const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a35_0x1c68f7(0x94))),telegramBotService_1=require(a35_0x1c68f7(0xb0)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x5769b8=a35_0x1c68f7;this[_0x5769b8(0x8b)]=null,this[_0x5769b8(0xd3)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this['coinToPayService']=new coinToPayService_1[(_0x5769b8(0xc7))]();}[a35_0x1c68f7(0x106)](){const _0x49b31e=a35_0x1c68f7;console[_0x49b31e(0xcd)](_0x49b31e(0x101)),this[_0x49b31e(0xd1)]()['catch'](_0x404122=>{const _0x43cf04=_0x49b31e;console[_0x43cf04(0xfa)]('Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x404122);}),this[_0x49b31e(0x8b)]=setInterval(async()=>{const _0x473389=_0x49b31e;try{await this['checkAllPendingPayments']();}catch(_0x3be06e){console[_0x473389(0xfa)](_0x473389(0xdb),_0x3be06e);}},this[_0x49b31e(0xd3)]),console[_0x49b31e(0xcd)]('âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)');}[a35_0x1c68f7(0xb3)](){const _0x4f20ee=a35_0x1c68f7;this[_0x4f20ee(0x8b)]&&(clearInterval(this[_0x4f20ee(0x8b)]),this[_0x4f20ee(0x8b)]=null,console['log'](_0x4f20ee(0xad)));}async[a35_0x1c68f7(0xd1)](){const _0x5809b8=a35_0x1c68f7;try{const _0x3577a4=await database_1[_0x5809b8(0xd4)][_0x5809b8(0xe9)]['findMany']({'where':{'gateway':_0x5809b8(0x8a),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x3577a4[_0x5809b8(0xbf)]===0x0){console[_0x5809b8(0xcd)]('ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}console[_0x5809b8(0xcd)](_0x5809b8(0xc5)+_0x3577a4[_0x5809b8(0xbf)]+'\x20pending\x20CoinToPay\x20payments');const _0x299647=await this[_0x5809b8(0xf8)](_0x3577a4);console[_0x5809b8(0xcd)](_0x5809b8(0x112)+_0x299647[_0x5809b8(0xbf)]+'\x20expired\x20CoinToPay\x20payments');for(const _0x59ad83 of _0x3577a4){try{if(_0x299647[_0x5809b8(0x96)](_0x59ad83['id'])){console[_0x5809b8(0xcd)](_0x5809b8(0x90)+_0x59ad83['id']+_0x5809b8(0xfe));continue;}await this[_0x5809b8(0x105)](_0x59ad83),await new Promise(_0x2b287a=>setTimeout(_0x2b287a,0x7d0));}catch(_0x278a80){console[_0x5809b8(0xfa)](_0x5809b8(0xf5)+_0x59ad83['id']+':',_0x278a80),loggerService_1[_0x5809b8(0x110)][_0x5809b8(0xc0)]('cointopay',_0x5809b8(0x9c)+_0x59ad83[_0x5809b8(0x8c)],_0x278a80);}}console[_0x5809b8(0xcd)](_0x5809b8(0xbb)+_0x3577a4[_0x5809b8(0xbf)]+'\x20CoinToPay\x20payments');}catch(_0x4fcae3){console[_0x5809b8(0xfa)](_0x5809b8(0x8d),_0x4fcae3);}}async['checkExpiredPayments'](_0x5e584b){const _0x541af7=a35_0x1c68f7,_0x2b913a=[],_0x3b8a52=new Date();_0x3b8a52[_0x541af7(0xa1)](_0x3b8a52[_0x541af7(0x9f)]()-this[_0x541af7(0x88)]),console[_0x541af7(0xcd)](_0x541af7(0x87)+this[_0x541af7(0x88)]+'\x20days\x20(created\x20before\x20'+_0x3b8a52[_0x541af7(0xf3)]()+')');for(const _0x194e64 of _0x5e584b){if(_0x194e64[_0x541af7(0xd0)]<_0x3b8a52){console[_0x541af7(0xcd)](_0x541af7(0x90)+_0x194e64['id']+_0x541af7(0xb6)+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{await database_1[_0x541af7(0xd4)][_0x541af7(0xe9)][_0x541af7(0xdf)]({'where':{'id':_0x194e64['id']},'data':{'status':_0x541af7(0xcf),'updatedAt':new Date(),'adminNotes':_0x541af7(0x89)+this[_0x541af7(0x88)]+_0x541af7(0x92)}}),await database_1['default'][_0x541af7(0xa9)]['create']({'data':{'paymentId':_0x194e64['id'],'shopId':_0x194e64[_0x541af7(0x9e)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x541af7(0x9b)]({'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x541af7(0xaf),'createdAt':_0x194e64[_0x541af7(0xd0)],'expiredAt':new Date()[_0x541af7(0xf3)](),'daysSinceCreation':Math[_0x541af7(0x10c)]((Date[_0x541af7(0xc6)]()-_0x194e64['createdAt'][_0x541af7(0x98)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x194e64,'EXPIRED'),await this[_0x541af7(0xc8)](_0x194e64,_0x541af7(0xcf)),_0x2b913a[_0x541af7(0xa5)](_0x194e64['id']),console[_0x541af7(0xcd)](_0x541af7(0xcc)+_0x194e64['id']+_0x541af7(0x108)+this['EXPIRY_DAYS']+'-day\x20timeout');}catch(_0x44f324){console[_0x541af7(0xfa)](_0x541af7(0xf0)+_0x194e64['id']+':',_0x44f324);}}}return _0x2b913a;}async[a35_0x1c68f7(0x105)](_0x2d9691){const _0x3d6180=a35_0x1c68f7;if(!_0x2d9691[_0x3d6180(0x8c)]){console[_0x3d6180(0xcd)](_0x3d6180(0xaa)+_0x2d9691['id']+_0x3d6180(0x104));return;}console[_0x3d6180(0xcd)](_0x3d6180(0xc3)+_0x2d9691['id']+'\x20('+_0x2d9691[_0x3d6180(0x8c)]+')');try{const _0x5c1822=await this[_0x3d6180(0x97)][_0x3d6180(0xec)](_0x2d9691[_0x3d6180(0x8c)]);console[_0x3d6180(0xcd)](_0x3d6180(0xb5)+_0x2d9691['id']+'\x20status:\x20'+_0x5c1822[_0x3d6180(0xff)]);_0x5c1822[_0x3d6180(0xf1)]&&console['log'](_0x3d6180(0xb5)+_0x2d9691['id']+_0x3d6180(0x9a),{'iban':_0x5c1822[_0x3d6180(0xf1)][_0x3d6180(0xc2)]||'not\x20found','transactionId':_0x5c1822['paymentDetails'][_0x3d6180(0xca)],'createdOn':_0x5c1822[_0x3d6180(0xf1)]['createdOn'],'confirmedOn':_0x5c1822[_0x3d6180(0xf1)]['confirmedOn']||'not\x20confirmed'});if(_0x5c1822[_0x3d6180(0xff)]!==_0x2d9691[_0x3d6180(0xff)]){console[_0x3d6180(0xcd)](_0x3d6180(0xb2)+_0x2d9691['id']+_0x3d6180(0xce)+_0x2d9691[_0x3d6180(0xff)]+_0x3d6180(0xa3)+_0x5c1822['status']);const _0x1e6f69={'status':_0x5c1822[_0x3d6180(0xff)],'updatedAt':new Date()};_0x5c1822[_0x3d6180(0xff)]===_0x3d6180(0xe1)&&_0x2d9691[_0x3d6180(0xff)]!=='PAID'&&(_0x1e6f69[_0x3d6180(0x10f)]=new Date(),console[_0x3d6180(0xcd)](_0x3d6180(0xa4)+_0x2d9691['id']+_0x3d6180(0x103)+_0x1e6f69['paidAt'][_0x3d6180(0xf3)]()));if(_0x5c1822[_0x3d6180(0xf1)]){const _0x337165=_0x5c1822[_0x3d6180(0xf1)];_0x337165[_0x3d6180(0xc2)]&&(_0x1e6f69[_0x3d6180(0x91)]=_0x337165[_0x3d6180(0xc2)],console[_0x3d6180(0xcd)]('ðŸ¦\x20Saved\x20IBAN:\x20'+_0x337165[_0x3d6180(0xc2)]));if(_0x337165[_0x3d6180(0x86)]){const _0x129344=_0x2d9691['adminNotes']||'',_0x160e1d=_0x3d6180(0xc4)+_0x337165[_0x3d6180(0x86)];_0x1e6f69[_0x3d6180(0xea)]=_0x129344?_0x129344+'\x0a\x0a'+_0x160e1d:_0x160e1d,console['log'](_0x3d6180(0xb8));}_0x337165[_0x3d6180(0xca)]&&console[_0x3d6180(0xcd)](_0x3d6180(0xf4)+_0x337165[_0x3d6180(0xca)]),_0x337165[_0x3d6180(0xab)]&&console[_0x3d6180(0xcd)]('âœ…\x20Transaction\x20confirmed\x20on:\x20'+_0x337165[_0x3d6180(0xab)]);}await database_1[_0x3d6180(0xd4)][_0x3d6180(0xe9)][_0x3d6180(0xdf)]({'where':{'id':_0x2d9691['id']},'data':_0x1e6f69}),await database_1['default']['webhookLog'][_0x3d6180(0xde)]({'data':{'paymentId':_0x2d9691['id'],'shopId':_0x2d9691['shopId'],'event':_0x3d6180(0x100)+_0x5c1822['status'][_0x3d6180(0x109)](),'statusCode':0xc8,'responseBody':JSON[_0x3d6180(0x9b)]({'oldStatus':_0x2d9691['status'],'newStatus':_0x5c1822[_0x3d6180(0xff)],'paymentDetails':_0x5c1822[_0x3d6180(0xf1)],'checkedAt':new Date()[_0x3d6180(0xf3)]()})}}),await this[_0x3d6180(0xfc)](_0x2d9691,_0x5c1822['status']),await this['sendPaymentStatusNotification'](_0x2d9691,_0x5c1822[_0x3d6180(0xff)]),console[_0x3d6180(0xcd)](_0x3d6180(0xcc)+_0x2d9691['id']+_0x3d6180(0xda));}else console['log'](_0x3d6180(0xb5)+_0x2d9691['id']+_0x3d6180(0xe8)+_0x5c1822[_0x3d6180(0xff)]+')');}catch(_0x17d7c8){console[_0x3d6180(0xfa)](_0x3d6180(0xe0)+_0x2d9691['id']+':',_0x17d7c8),await database_1[_0x3d6180(0xd4)]['webhookLog'][_0x3d6180(0xde)]({'data':{'paymentId':_0x2d9691['id'],'shopId':_0x2d9691[_0x3d6180(0x9e)],'event':_0x3d6180(0xae),'statusCode':0x1f4,'responseBody':JSON[_0x3d6180(0x9b)]({'error':_0x17d7c8 instanceof Error?_0x17d7c8[_0x3d6180(0x10b)]:'Unknown\x20error','gatewayPaymentId':_0x2d9691['gatewayPaymentId'],'checkedAt':new Date()['toISOString']()})}});}}async[a35_0x1c68f7(0xfc)](_0x506958,_0x4007a7){const _0x47cc1d=a35_0x1c68f7,_0x1c9715=Date['now']();try{const _0x5835ba=_0x506958['shop'],_0x291f04=_0x5835ba[_0x47cc1d(0xd8)];if(!_0x291f04?.[_0x47cc1d(0xd9)]){console[_0x47cc1d(0xcd)](_0x47cc1d(0xa0)+_0x5835ba['id']);return;}const _0x2ea810=_0x4007a7===_0x47cc1d(0xe1)?'payment.success':_0x4007a7===_0x47cc1d(0x8f)?'payment.failed':_0x4007a7===_0x47cc1d(0xcf)?'payment.failed':'payment.pending';if(!_0x291f04[_0x47cc1d(0xd5)]?.['includes'](_0x2ea810)){console[_0x47cc1d(0xcd)](_0x47cc1d(0xe2)+_0x2ea810+_0x47cc1d(0xef)+_0x5835ba['id']);return;}const _0x1b98db={'event':_0x2ea810,'payment':{'id':_0x506958['id'],'order_id':_0x506958[_0x47cc1d(0xd6)],'gateway_order_id':_0x506958[_0x47cc1d(0x102)],'gateway':_0x47cc1d(0xc1),'amount':_0x506958[_0x47cc1d(0x93)],'currency':_0x506958[_0x47cc1d(0x10d)],'status':_0x4007a7['toLowerCase'](),'customer_email':_0x506958['customerEmail'],'customer_name':_0x506958[_0x47cc1d(0xba)],'created_at':_0x506958[_0x47cc1d(0xd0)],'updated_at':new Date()}},_0x120b30=await fetch(_0x291f04[_0x47cc1d(0xd9)],{'method':_0x47cc1d(0xac),'headers':{'Content-Type':_0x47cc1d(0xf7),'User-Agent':_0x47cc1d(0xee)},'body':JSON['stringify'](_0x1b98db)}),_0x4839f2=Date['now']()-_0x1c9715,_0x301784=_0x120b30['ok']?_0x47cc1d(0xbe):await _0x120b30['text']();loggerService_1['loggerService']['logShopWebhookSent'](_0x506958['shopId'],_0x291f04['webhookUrl'],_0x2ea810,_0x120b30[_0x47cc1d(0xff)],_0x4839f2,_0x1b98db),console[_0x47cc1d(0xcd)](_0x47cc1d(0xe4)+_0x291f04[_0x47cc1d(0xd9)]+_0x47cc1d(0xb4)+_0x120b30[_0x47cc1d(0xff)]+'\x20('+_0x4839f2+_0x47cc1d(0xe3));}catch(_0x53d04b){console['error'](_0x47cc1d(0xb1),_0x53d04b),loggerService_1[_0x47cc1d(0x110)][_0x47cc1d(0x111)](_0x506958[_0x47cc1d(0x9e)],_0x506958[_0x47cc1d(0x10e)]?.['settings']?.[_0x47cc1d(0xd9)]||_0x47cc1d(0xbd),_0x47cc1d(0xc9),_0x53d04b,{});}}async[a35_0x1c68f7(0xc8)](_0x4fedf6,_0x4aef71){const _0x27d778=a35_0x1c68f7;try{const _0x38481f={'PENDING':_0x27d778(0xa2),'PAID':_0x27d778(0xdc),'FAILED':_0x27d778(0xed),'EXPIRED':_0x27d778(0xbc)},_0x1d8868=_0x38481f[_0x4aef71];if(!_0x1d8868||_0x1d8868==='created')return;await telegramBotService_1[_0x27d778(0xe6)][_0x27d778(0xd2)](_0x4fedf6[_0x27d778(0x9e)],_0x4fedf6,_0x1d8868);}catch(_0x5ee023){console[_0x27d778(0xfa)](_0x27d778(0xa8),_0x5ee023);}}async[a35_0x1c68f7(0xdd)](_0x3402f6){const _0x487d9f=a35_0x1c68f7,_0x2b1e6c=await database_1['default']['payment'][_0x487d9f(0xd7)]({'where':{'id':_0x3402f6},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2b1e6c)throw new Error(_0x487d9f(0x99));if(_0x2b1e6c[_0x487d9f(0xeb)]!==_0x487d9f(0x8a))throw new Error(_0x487d9f(0xa7));await this[_0x487d9f(0x105)](_0x2b1e6c);}[a35_0x1c68f7(0xf6)](){const _0x1c72c2=a35_0x1c68f7,_0x3e8f3f=this[_0x1c72c2(0x8b)]?this[_0x1c72c2(0xd3)]:undefined;return{'isActive':!!this[_0x1c72c2(0x8b)],'checkIntervalMinutes':this[_0x1c72c2(0xd3)]/(0x3e8*0x3c),'expiryDays':this[_0x1c72c2(0x88)],'nextCheckIn':_0x3e8f3f};}}exports[a35_0x1c68f7(0xfd)]=CoinToPayStatusService,exports[a35_0x1c68f7(0xf2)]=new CoinToPayStatusService();