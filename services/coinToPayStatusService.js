'use strict';const a37_0x329555=a37_0x2631;(function(_0x469c3d,_0x4411a3){const _0x2f342c=a37_0x2631,_0x30be13=_0x469c3d();while(!![]){try{const _0x27463e=parseInt(_0x2f342c(0x247))/0x1+-parseInt(_0x2f342c(0x22a))/0x2+-parseInt(_0x2f342c(0x19e))/0x3+-parseInt(_0x2f342c(0x20f))/0x4+parseInt(_0x2f342c(0x1b7))/0x5+-parseInt(_0x2f342c(0x1ec))/0x6*(-parseInt(_0x2f342c(0x218))/0x7)+-parseInt(_0x2f342c(0x1fb))/0x8*(-parseInt(_0x2f342c(0x23c))/0x9);if(_0x27463e===_0x4411a3)break;else _0x30be13['push'](_0x30be13['shift']());}catch(_0x3c158c){_0x30be13['push'](_0x30be13['shift']());}}}(a37_0x3cc5,0xd64e4));function a37_0x2631(_0x1a4725,_0x17a51b){const _0x3cc513=a37_0x3cc5();return a37_0x2631=function(_0x2631a2,_0x312549){_0x2631a2=_0x2631a2-0x16f;let _0x5f59fb=_0x3cc513[_0x2631a2];return _0x5f59fb;},a37_0x2631(_0x1a4725,_0x17a51b);}var __importDefault=this&&this[a37_0x329555(0x1d8)]||function(_0x5309be){const _0x5289c4=a37_0x329555;return _0x5309be&&_0x5309be[_0x5289c4(0x1f4)]?_0x5309be:{'default':_0x5309be};};Object[a37_0x329555(0x23d)](exports,a37_0x329555(0x1f4),{'value':!![]}),exports[a37_0x329555(0x174)]=exports[a37_0x329555(0x1f6)]=void 0x0;const coinToPayService_1=require(a37_0x329555(0x24e)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x329555(0x1ef)),loggerService_1=require(a37_0x329555(0x1cc));class CoinToPayStatusService{constructor(){const _0x52f2fa=a37_0x329555;this['globalCheckInterval']=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x52f2fa(0x245)]=new Map(),this[_0x52f2fa(0x198)]=new coinToPayService_1['CoinToPayService'](),console[_0x52f2fa(0x235)]('ü™ô\x20CoinToPayStatusService\x20initialized');}[a37_0x329555(0x1b6)](_0x19d97b,_0x5ec82d){const _0x2d09a8=a37_0x329555;console['log'](_0x2d09a8(0x25a)),console[_0x2d09a8(0x235)]('\x20\x20\x20-\x20paymentId:\x20'+_0x19d97b),console['log'](_0x2d09a8(0x21c)+_0x5ec82d),this[_0x2d09a8(0x240)](_0x19d97b);const _0x2aada4=[],_0x2b54ee=new Date(),_0xf0f559=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x2d09a8(0x256)},{'delay':0x5*0x3c*0x3e8,'description':_0x2d09a8(0x256)}];console[_0x2d09a8(0x235)]('ü™ô\x20[DEBUG]\x20Creating\x20'+_0xf0f559[_0x2d09a8(0x1ff)]+_0x2d09a8(0x1e6)+_0x19d97b);let _0x1dec67=0x0;_0xf0f559[_0x2d09a8(0x259)]((_0x3f2b8b,_0x2c61b6)=>{const _0x2cc381=_0x2d09a8;_0x1dec67+=_0x3f2b8b[_0x2cc381(0x1e4)];const _0xc04d84=setTimeout(async()=>{const _0x3c09f9=_0x2cc381;console[_0x3c09f9(0x235)](_0x3c09f9(0x22c)+(_0x2c61b6+0x1)+_0x3c09f9(0x1e5)+_0x19d97b+_0x3c09f9(0x1e2)+_0x3f2b8b[_0x3c09f9(0x191)]+')');try{await this[_0x3c09f9(0x208)](_0x19d97b),console['log'](_0x3c09f9(0x1fa)+(_0x2c61b6+0x1)+'\x20completed\x20for\x20payment\x20'+_0x19d97b);}catch(_0x1e6252){console[_0x3c09f9(0x209)](_0x3c09f9(0x229)+(_0x2c61b6+0x1)+'\x20for\x20payment\x20'+_0x19d97b+':',_0x1e6252),this[_0x3c09f9(0x178)](_0x19d97b,_0x5ec82d,_0x1e6252,_0x3c09f9(0x224),{'checkNumber':_0x2c61b6+0x1,'scheduledAfter':_0x3f2b8b[_0x3c09f9(0x191)],'isIndividualCheck':!![]});}},_0x1dec67);_0x2aada4[_0x2cc381(0x200)](_0xc04d84),console[_0x2cc381(0x235)](_0x2cc381(0x214)+(_0x2c61b6+0x1)+_0x2cc381(0x238)+_0x19d97b+'\x20in\x20'+_0x1dec67/0x3e8+_0x2cc381(0x1dc)+_0x3f2b8b['description']+')');});const _0x5719de=setInterval(async()=>{const _0x2637de=_0x2d09a8;console[_0x2637de(0x235)](_0x2637de(0x1ae)+_0x19d97b);try{const _0x31f498=await database_1[_0x2637de(0x1ad)]['payment'][_0x2637de(0x1f2)]({'where':{'id':_0x19d97b},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x31f498){console[_0x2637de(0x235)](_0x2637de(0x1f9)+_0x19d97b+_0x2637de(0x1be)),this[_0x2637de(0x240)](_0x19d97b);return;}console[_0x2637de(0x235)](_0x2637de(0x19a)+_0x19d97b+_0x2637de(0x23e)+_0x31f498['status']);if(_0x31f498['status']!==_0x2637de(0x24f)){console[_0x2637de(0x235)](_0x2637de(0x204)+_0x19d97b+_0x2637de(0x1eb)+_0x31f498['status']+_0x2637de(0x1a6)),this[_0x2637de(0x240)](_0x19d97b);return;}const _0x43a3b5=Math[_0x2637de(0x1f8)]((Date[_0x2637de(0x244)]()-_0x31f498[_0x2637de(0x237)][_0x2637de(0x1c4)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x43a3b5>=this['EXPIRY_DAYS']){console[_0x2637de(0x235)](_0x2637de(0x186)+_0x19d97b+_0x2637de(0x251)+this[_0x2637de(0x17f)]+_0x2637de(0x1ce)),this[_0x2637de(0x240)](_0x19d97b);return;}await this['checkSinglePaymentById'](_0x19d97b),console[_0x2637de(0x235)](_0x2637de(0x22d)+_0x19d97b);}catch(_0x1067f2){console[_0x2637de(0x209)]('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x19d97b+':',_0x1067f2),this[_0x2637de(0x178)](_0x19d97b,_0x5ec82d,_0x1067f2,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x2aada4[_0x2d09a8(0x200)](_0x5719de),this[_0x2d09a8(0x245)][_0x2d09a8(0x1db)](_0x19d97b,{'timers':_0x2aada4,'paymentId':_0x19d97b,'gatewayPaymentId':_0x5ec82d,'createdAt':_0x2b54ee}),console[_0x2d09a8(0x235)](_0x2d09a8(0x18c)+_0xf0f559[_0x2d09a8(0x1ff)]+_0x2d09a8(0x21b)+_0x19d97b),console[_0x2d09a8(0x235)](_0x2d09a8(0x258)+this[_0x2d09a8(0x245)][_0x2d09a8(0x20e)]),this[_0x2d09a8(0x1fc)](_0x19d97b,_0x5ec82d,_0x2d09a8(0x24f),_0x2d09a8(0x24f),'status_check',{'action':_0x2d09a8(0x1d2),'scheduledChecks':_0xf0f559[_0x2d09a8(0x1ff)],'firstCheckIn':_0xf0f559[0x0]['delay']/0x3e8,'totalTimers':this[_0x2d09a8(0x245)][_0x2d09a8(0x20e)]});}[a37_0x329555(0x240)](_0xee9644){const _0xa9c2cf=a37_0x329555,_0x121459=this[_0xa9c2cf(0x245)][_0xa9c2cf(0x1f1)](_0xee9644);_0x121459?(console[_0xa9c2cf(0x235)](_0xa9c2cf(0x1d0)+_0x121459[_0xa9c2cf(0x1c6)][_0xa9c2cf(0x1ff)]+_0xa9c2cf(0x1ed)+_0xee9644),_0x121459[_0xa9c2cf(0x1c6)][_0xa9c2cf(0x259)]((_0x15d30b,_0x40e363)=>{const _0x7d716a=_0xa9c2cf;_0x15d30b&&(clearTimeout(_0x15d30b),clearInterval(_0x15d30b),console[_0x7d716a(0x235)](_0x7d716a(0x230)+(_0x40e363+0x1)+_0x7d716a(0x238)+_0xee9644));}),this['paymentTimers']['delete'](_0xee9644),console[_0xa9c2cf(0x235)]('‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0xee9644+_0xa9c2cf(0x1aa)+this[_0xa9c2cf(0x245)]['size'])):console['log'](_0xa9c2cf(0x227)+_0xee9644+_0xa9c2cf(0x1b5));}async[a37_0x329555(0x208)](_0xbd1d37){const _0x78fba6=a37_0x329555;console[_0x78fba6(0x235)](_0x78fba6(0x1f0)+_0xbd1d37);const _0x3256cd=await database_1[_0x78fba6(0x1ad)][_0x78fba6(0x225)][_0x78fba6(0x1f2)]({'where':{'id':_0xbd1d37},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3256cd){console[_0x78fba6(0x235)](_0x78fba6(0x171)+_0xbd1d37+_0x78fba6(0x1de));return;}console[_0x78fba6(0x235)](_0x78fba6(0x254)+_0xbd1d37+'\x20found:'),console['log'](_0x78fba6(0x217)+_0x3256cd['gateway']),console[_0x78fba6(0x235)](_0x78fba6(0x1c2)+_0x3256cd[_0x78fba6(0x1c8)]),console[_0x78fba6(0x235)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x3256cd[_0x78fba6(0x196)]),console[_0x78fba6(0x235)](_0x78fba6(0x220)+_0x3256cd[_0x78fba6(0x223)]+'\x20'+_0x3256cd[_0x78fba6(0x1d5)]),console[_0x78fba6(0x235)](_0x78fba6(0x189)+_0x3256cd[_0x78fba6(0x20b)]);if(_0x3256cd[_0x78fba6(0x21e)]!==_0x78fba6(0x1c0)){console[_0x78fba6(0x235)](_0x78fba6(0x193)+_0xbd1d37+_0x78fba6(0x1f3)+_0x3256cd['gateway']+')');return;}if(_0x3256cd['status']!=='PENDING'){console[_0x78fba6(0x235)](_0x78fba6(0x193)+_0xbd1d37+_0x78fba6(0x1eb)+_0x3256cd[_0x78fba6(0x1c8)]+_0x78fba6(0x1a6)),this['clearPaymentTimers'](_0xbd1d37);return;}if(!_0x3256cd[_0x78fba6(0x196)]){console[_0x78fba6(0x235)](_0x78fba6(0x193)+_0xbd1d37+_0x78fba6(0x176));return;}console['log']('‚úÖ\x20[CHECK]\x20Payment\x20'+_0xbd1d37+_0x78fba6(0x17e)),await this['checkSinglePayment'](_0x3256cd);}[a37_0x329555(0x1fc)](_0x57fc34,_0xbff1a8,_0x38ebf9,_0x1cb906,_0x23ce51,_0xabc06d){const _0xcfcacf=a37_0x329555,_0x443a24={'type':_0xcfcacf(0x215),'paymentId':_0x57fc34,'gatewayPaymentId':_0xbff1a8,'oldStatus':_0x38ebf9,'newStatus':_0x1cb906,'source':_0x23ce51,'timestamp':new Date()[_0xcfcacf(0x1ee)](),'details':_0xabc06d||{}};loggerService_1[_0xcfcacf(0x185)][_0xcfcacf(0x1fc)](_0x443a24),console['log'](_0xcfcacf(0x213)+_0x57fc34+'\x20('+_0xbff1a8+')'),console[_0xcfcacf(0x235)](_0xcfcacf(0x1c3)+_0x38ebf9+_0xcfcacf(0x1b1)+_0x1cb906),console['log'](_0xcfcacf(0x1c1)+_0x23ce51),console[_0xcfcacf(0x235)](_0xcfcacf(0x22b)+_0x443a24[_0xcfcacf(0x195)]),_0xabc06d&&console[_0xcfcacf(0x235)](_0xcfcacf(0x20a),_0xabc06d);}[a37_0x329555(0x178)](_0x47a909,_0x470f1d,_0x52b5ff,_0x484f65,_0x13a5fd){const _0x3435bc=a37_0x329555,_0x2d54f4={'type':_0x3435bc(0x22f),'paymentId':_0x47a909,'gatewayPaymentId':_0x470f1d,'error':_0x52b5ff instanceof Error?{'message':_0x52b5ff[_0x3435bc(0x24b)],'stack':_0x52b5ff[_0x3435bc(0x20d)]}:_0x52b5ff,'source':_0x484f65,'timestamp':new Date()[_0x3435bc(0x1ee)](),'context':_0x13a5fd||{}};loggerService_1[_0x3435bc(0x185)][_0x3435bc(0x178)](_0x2d54f4),console[_0x3435bc(0x209)]('ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x47a909+'\x20('+_0x470f1d+')'),console[_0x3435bc(0x209)](_0x3435bc(0x239)+(_0x52b5ff instanceof Error?_0x52b5ff[_0x3435bc(0x24b)]:_0x52b5ff)),console[_0x3435bc(0x209)](_0x3435bc(0x1c1)+_0x484f65),console[_0x3435bc(0x209)](_0x3435bc(0x22b)+_0x2d54f4[_0x3435bc(0x195)]),_0x13a5fd&&console[_0x3435bc(0x209)]('\x20\x20\x20üìù\x20Context:',_0x13a5fd);}[a37_0x329555(0x226)](){const _0x3aa64e=a37_0x329555;console[_0x3aa64e(0x235)](_0x3aa64e(0x25c)),this[_0x3aa64e(0x187)]()[_0x3aa64e(0x1f7)](_0x1860a4=>{const _0x43e181=_0x3aa64e;console[_0x43e181(0x209)](_0x43e181(0x234),_0x1860a4);}),this['globalCheckInterval']=setInterval(async()=>{const _0xab9643=_0x3aa64e;try{console[_0xab9643(0x235)](_0xab9643(0x17d)),await this['checkAllPendingPayments'](),console[_0xab9643(0x235)](_0xab9643(0x1da));}catch(_0x4fdf7b){console[_0xab9643(0x209)]('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x4fdf7b);}},this[_0x3aa64e(0x1c7)]),console[_0x3aa64e(0x235)](_0x3aa64e(0x252));}[a37_0x329555(0x197)](){const _0x1bbe9a=a37_0x329555;console[_0x1bbe9a(0x235)](_0x1bbe9a(0x206));this[_0x1bbe9a(0x19b)]&&(clearInterval(this[_0x1bbe9a(0x19b)]),this['globalCheckInterval']=null,console[_0x1bbe9a(0x235)](_0x1bbe9a(0x16f)));const _0x5de3f4=this[_0x1bbe9a(0x245)][_0x1bbe9a(0x20e)];for(const [_0x15da13]of this[_0x1bbe9a(0x245)]){this[_0x1bbe9a(0x240)](_0x15da13);}console[_0x1bbe9a(0x235)]('üõë\x20[SHUTDOWN]\x20Cleared\x20'+_0x5de3f4+'\x20individual\x20payment\x20timers');}async['checkAllPendingPayments'](){const _0xf82e6c=a37_0x329555;try{console['log'](_0xf82e6c(0x1cd));const _0x43c009=await database_1['default'][_0xf82e6c(0x225)]['findMany']({'where':{'gateway':_0xf82e6c(0x1c0),'status':_0xf82e6c(0x24f),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0xf82e6c(0x233)+_0x43c009[_0xf82e6c(0x1ff)]+_0xf82e6c(0x1a0));if(_0x43c009['length']===0x0){console[_0xf82e6c(0x235)]('ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x34e7fb=await this[_0xf82e6c(0x241)](_0x43c009);console['log'](_0xf82e6c(0x1a3)+_0x34e7fb['length']+_0xf82e6c(0x1cf));let _0x174e6c=0x0,_0x32331=0x0;for(const _0x4b40b9 of _0x43c009){try{if(_0x34e7fb[_0xf82e6c(0x203)](_0x4b40b9['id'])){console['log'](_0xf82e6c(0x1fd)+_0x4b40b9['id']+_0xf82e6c(0x18b)),_0x32331++;continue;}if(this[_0xf82e6c(0x245)][_0xf82e6c(0x21d)](_0x4b40b9['id'])){console['log']('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x4b40b9['id']+_0xf82e6c(0x1b4)),_0x32331++;continue;}const _0x583b9d=(Date['now']()-_0x4b40b9[_0xf82e6c(0x237)][_0xf82e6c(0x1c4)]())/(0x3e8*0x3c*0x3c);if(_0x583b9d<0x1){console[_0xf82e6c(0x235)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x4b40b9['id']+_0xf82e6c(0x242)+_0x583b9d['toFixed'](0x1)+_0xf82e6c(0x188)),_0x32331++;continue;}console[_0xf82e6c(0x235)](_0xf82e6c(0x19c)+_0x4b40b9['id']+'\x20(age:\x20'+_0x583b9d[_0xf82e6c(0x1dd)](0x1)+'h)'),await this['checkSinglePayment'](_0x4b40b9),_0x174e6c++,await new Promise(_0x1b8300=>setTimeout(_0x1b8300,0x7d0));}catch(_0x3301c1){console[_0xf82e6c(0x209)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x4b40b9['id']+':',_0x3301c1),this[_0xf82e6c(0x178)](_0x4b40b9['id'],_0x4b40b9['gatewayPaymentId']||_0xf82e6c(0x1c5),_0x3301c1,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x4b40b9[_0xf82e6c(0x223)],'paymentCurrency':_0x4b40b9[_0xf82e6c(0x1d5)],'shopId':_0x4b40b9[_0xf82e6c(0x20b)],'createdAt':_0x4b40b9[_0xf82e6c(0x237)]}),loggerService_1[_0xf82e6c(0x185)]['logWhiteDomainError'](_0xf82e6c(0x1c0),_0xf82e6c(0x1e0)+_0x4b40b9['gatewayPaymentId'],_0x3301c1);}}console[_0xf82e6c(0x235)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x174e6c+'\x20checked,\x20'+_0x32331+_0xf82e6c(0x232)+_0x34e7fb[_0xf82e6c(0x1ff)]+_0xf82e6c(0x1ca));}catch(_0x260217){console[_0xf82e6c(0x209)](_0xf82e6c(0x210),_0x260217);}}async[a37_0x329555(0x241)](_0x39abc4){const _0x21eee7=a37_0x329555,_0x27fe98=[],_0x4365fa=new Date();_0x4365fa[_0x21eee7(0x23b)](_0x4365fa[_0x21eee7(0x216)]()-this[_0x21eee7(0x17f)]),console[_0x21eee7(0x235)](_0x21eee7(0x1bd)+this['EXPIRY_DAYS']+_0x21eee7(0x1bb)+_0x4365fa[_0x21eee7(0x1ee)]()+')');for(const _0x31689b of _0x39abc4){if(_0x31689b[_0x21eee7(0x237)]<_0x4365fa){console[_0x21eee7(0x235)](_0x21eee7(0x182)+_0x31689b['id']+_0x21eee7(0x251)+this[_0x21eee7(0x17f)]+_0x21eee7(0x1a5));try{this[_0x21eee7(0x1fc)](_0x31689b['id'],_0x31689b[_0x21eee7(0x196)]||_0x21eee7(0x1c5),_0x21eee7(0x24f),'EXPIRED',_0x21eee7(0x1e3),{'reason':_0x21eee7(0x20c)+this[_0x21eee7(0x17f)]+'\x20days','createdAt':_0x31689b[_0x21eee7(0x237)],'daysSinceCreation':Math['floor']((Date[_0x21eee7(0x244)]()-_0x31689b[_0x21eee7(0x237)][_0x21eee7(0x1c4)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x31689b[_0x21eee7(0x223)],'paymentCurrency':_0x31689b[_0x21eee7(0x1d5)],'shopId':_0x31689b[_0x21eee7(0x20b)]}),await database_1[_0x21eee7(0x1ad)]['payment'][_0x21eee7(0x18d)]({'where':{'id':_0x31689b['id']},'data':{'status':_0x21eee7(0x231),'updatedAt':new Date(),'adminNotes':_0x21eee7(0x202)+this[_0x21eee7(0x17f)]+_0x21eee7(0x1d7)}}),await database_1['default'][_0x21eee7(0x1c9)]['create']({'data':{'paymentId':_0x31689b['id'],'shopId':_0x31689b[_0x21eee7(0x20b)],'event':_0x21eee7(0x201),'statusCode':0xc8,'responseBody':JSON[_0x21eee7(0x1b3)]({'reason':_0x21eee7(0x20c)+this[_0x21eee7(0x17f)]+'\x20days','createdAt':_0x31689b[_0x21eee7(0x237)],'expiredAt':new Date()[_0x21eee7(0x1ee)](),'daysSinceCreation':Math['floor']((Date['now']()-_0x31689b[_0x21eee7(0x237)][_0x21eee7(0x1c4)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x21eee7(0x179)](_0x31689b,_0x21eee7(0x231)),await this[_0x21eee7(0x236)](_0x31689b,_0x21eee7(0x231)),this[_0x21eee7(0x240)](_0x31689b['id']),_0x27fe98[_0x21eee7(0x200)](_0x31689b['id']),console[_0x21eee7(0x235)](_0x21eee7(0x1b0)+_0x31689b['id']+_0x21eee7(0x22e)+this[_0x21eee7(0x17f)]+_0x21eee7(0x219));}catch(_0x1784ea){console[_0x21eee7(0x209)](_0x21eee7(0x1bc)+_0x31689b['id']+':',_0x1784ea),this[_0x21eee7(0x178)](_0x31689b['id'],_0x31689b['gatewayPaymentId']||_0x21eee7(0x1c5),_0x1784ea,_0x21eee7(0x1e3),{'reason':_0x21eee7(0x243),'createdAt':_0x31689b['createdAt'],'daysSinceCreation':Math[_0x21eee7(0x1f8)]((Date[_0x21eee7(0x244)]()-_0x31689b['createdAt'][_0x21eee7(0x1c4)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x27fe98;}async[a37_0x329555(0x246)](_0xba02b6){const _0x9ea488=a37_0x329555;if(!_0xba02b6[_0x9ea488(0x196)]){console[_0x9ea488(0x235)](_0x9ea488(0x193)+_0xba02b6['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console['log'](_0x9ea488(0x255)+_0xba02b6['id']+'\x20('+_0xba02b6[_0x9ea488(0x196)]+')');try{const _0x3d1ec0=await this['coinToPayService'][_0x9ea488(0x1fe)](_0xba02b6[_0x9ea488(0x196)]);console['log'](_0x9ea488(0x254)+_0xba02b6['id']+'\x20status:\x20'+_0x3d1ec0[_0x9ea488(0x1c8)]);_0x3d1ec0[_0x9ea488(0x1ac)]&&console[_0x9ea488(0x235)]('üìä\x20[CHECK]\x20Payment\x20'+_0xba02b6['id']+_0x9ea488(0x170),{'iban':_0x3d1ec0[_0x9ea488(0x1ac)][_0x9ea488(0x221)]||_0x9ea488(0x1a4),'transactionId':_0x3d1ec0[_0x9ea488(0x1ac)][_0x9ea488(0x1e8)],'createdOn':_0x3d1ec0[_0x9ea488(0x1ac)][_0x9ea488(0x1e1)],'confirmedOn':_0x3d1ec0[_0x9ea488(0x1ac)][_0x9ea488(0x17b)]||'not\x20confirmed'});if(_0x3d1ec0[_0x9ea488(0x1c8)]!==_0xba02b6['status']){console[_0x9ea488(0x235)](_0x9ea488(0x249)+_0xba02b6['id']+'\x20status\x20from\x20'+_0xba02b6[_0x9ea488(0x1c8)]+_0x9ea488(0x1df)+_0x3d1ec0[_0x9ea488(0x1c8)]),this['logCoinToPayStatus'](_0xba02b6['id'],_0xba02b6[_0x9ea488(0x196)],_0xba02b6[_0x9ea488(0x1c8)],_0x3d1ec0[_0x9ea488(0x1c8)],_0x9ea488(0x224),{'paymentDetails':_0x3d1ec0[_0x9ea488(0x1ac)],'amount':_0x3d1ec0['amount'],'currency':_0x3d1ec0[_0x9ea488(0x1d5)],'shopId':_0xba02b6[_0x9ea488(0x20b)],'checkTimestamp':new Date()[_0x9ea488(0x1ee)]()});const _0x4d5750={'status':_0x3d1ec0[_0x9ea488(0x1c8)],'updatedAt':new Date()};_0x3d1ec0[_0x9ea488(0x1c8)]===_0x9ea488(0x248)&&_0xba02b6[_0x9ea488(0x1c8)]!==_0x9ea488(0x248)&&(_0x4d5750[_0x9ea488(0x1ba)]=new Date(),console[_0x9ea488(0x235)](_0x9ea488(0x222)+_0xba02b6['id']+_0x9ea488(0x207)+_0x4d5750['paidAt'][_0x9ea488(0x1ee)]()));if(_0x3d1ec0[_0x9ea488(0x1ac)]){const _0x12755f=_0x3d1ec0[_0x9ea488(0x1ac)];_0x12755f[_0x9ea488(0x221)]&&(_0x4d5750['remitterIban']=_0x12755f[_0x9ea488(0x221)],console['log'](_0x9ea488(0x1a1)+_0x12755f[_0x9ea488(0x221)]));if(_0x12755f[_0x9ea488(0x257)]){const _0x32c8a0=_0xba02b6[_0x9ea488(0x1b9)]||'',_0x2c269f=_0x9ea488(0x1d6)+_0x12755f['bankDetails'];_0x4d5750['adminNotes']=_0x32c8a0?_0x32c8a0+'\x0a\x0a'+_0x2c269f:_0x2c269f,console[_0x9ea488(0x235)](_0x9ea488(0x1f5));}_0x12755f[_0x9ea488(0x1e8)]&&console[_0x9ea488(0x235)]('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x12755f['transactionId']),_0x12755f[_0x9ea488(0x17b)]&&console[_0x9ea488(0x235)](_0x9ea488(0x24c)+_0x12755f['confirmedOn']);}await database_1[_0x9ea488(0x1ad)][_0x9ea488(0x225)]['update']({'where':{'id':_0xba02b6['id']},'data':_0x4d5750}),await database_1[_0x9ea488(0x1ad)][_0x9ea488(0x1c9)][_0x9ea488(0x1d1)]({'data':{'paymentId':_0xba02b6['id'],'shopId':_0xba02b6[_0x9ea488(0x20b)],'event':_0x9ea488(0x175)+_0x3d1ec0[_0x9ea488(0x1c8)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0xba02b6[_0x9ea488(0x1c8)],'newStatus':_0x3d1ec0[_0x9ea488(0x1c8)],'paymentDetails':_0x3d1ec0[_0x9ea488(0x1ac)],'checkedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0xba02b6,_0x3d1ec0[_0x9ea488(0x1c8)]),await this[_0x9ea488(0x236)](_0xba02b6,_0x3d1ec0[_0x9ea488(0x1c8)]),_0x3d1ec0[_0x9ea488(0x1c8)]!==_0x9ea488(0x24f)&&(console[_0x9ea488(0x235)]('üßπ\x20[CHECK]\x20Payment\x20'+_0xba02b6['id']+_0x9ea488(0x24a)+_0x3d1ec0[_0x9ea488(0x1c8)]+',\x20clearing\x20individual\x20timers'),this[_0x9ea488(0x240)](_0xba02b6['id'])),console[_0x9ea488(0x235)](_0x9ea488(0x23f)+_0xba02b6['id']+_0x9ea488(0x1e9));}else console[_0x9ea488(0x235)](_0x9ea488(0x254)+_0xba02b6['id']+_0x9ea488(0x183)+_0x3d1ec0[_0x9ea488(0x1c8)]+')'),this[_0x9ea488(0x1fc)](_0xba02b6['id'],_0xba02b6[_0x9ea488(0x196)],_0xba02b6['status'],_0x3d1ec0['status'],_0x9ea488(0x224),{'statusUnchanged':!![],'paymentDetails':_0x3d1ec0[_0x9ea488(0x1ac)],'amount':_0x3d1ec0[_0x9ea488(0x223)],'currency':_0x3d1ec0[_0x9ea488(0x1d5)],'shopId':_0xba02b6[_0x9ea488(0x20b)],'checkTimestamp':new Date()[_0x9ea488(0x1ee)]()});}catch(_0x13041e){console[_0x9ea488(0x209)](_0x9ea488(0x172)+_0xba02b6['id']+':',_0x13041e),this[_0x9ea488(0x178)](_0xba02b6['id'],_0xba02b6[_0x9ea488(0x196)],_0x13041e,_0x9ea488(0x224),{'paymentAmount':_0xba02b6['amount'],'paymentCurrency':_0xba02b6[_0x9ea488(0x1d5)],'shopId':_0xba02b6[_0x9ea488(0x20b)],'createdAt':_0xba02b6[_0x9ea488(0x237)]}),await database_1[_0x9ea488(0x1ad)][_0x9ea488(0x1c9)][_0x9ea488(0x1d1)]({'data':{'paymentId':_0xba02b6['id'],'shopId':_0xba02b6['shopId'],'event':_0x9ea488(0x192),'statusCode':0x1f4,'responseBody':JSON[_0x9ea488(0x1b3)]({'error':_0x13041e instanceof Error?_0x13041e[_0x9ea488(0x24b)]:_0x9ea488(0x18f),'gatewayPaymentId':_0xba02b6['gatewayPaymentId'],'checkedAt':new Date()[_0x9ea488(0x1ee)]()})}});}}async['sendShopWebhook'](_0x174bc2,_0x4339f0){const _0x3e2f46=a37_0x329555,_0x4e2545=Date[_0x3e2f46(0x244)]();try{const _0x2c7513=_0x174bc2['shop'],_0x16e10f=_0x2c7513['settings'];if(!_0x16e10f?.[_0x3e2f46(0x1bf)]){console['log'](_0x3e2f46(0x199)+_0x2c7513['id']);return;}const _0x1e363e=_0x4339f0===_0x3e2f46(0x248)?_0x3e2f46(0x24d):_0x4339f0===_0x3e2f46(0x17c)?_0x3e2f46(0x21f):_0x4339f0===_0x3e2f46(0x231)?_0x3e2f46(0x21f):_0x3e2f46(0x1cb);if(!_0x16e10f[_0x3e2f46(0x184)]?.[_0x3e2f46(0x203)](_0x1e363e)){console[_0x3e2f46(0x235)](_0x3e2f46(0x17a)+_0x1e363e+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2c7513['id']);return;}const _0x3f9dcc={'event':_0x1e363e,'payment':{'id':_0x174bc2['id'],'order_id':_0x174bc2['orderId'],'gateway_order_id':_0x174bc2[_0x3e2f46(0x177)],'gateway':_0x3e2f46(0x25b),'amount':_0x174bc2[_0x3e2f46(0x223)],'currency':_0x174bc2[_0x3e2f46(0x1d5)],'status':_0x4339f0[_0x3e2f46(0x1ea)](),'customer_email':_0x174bc2[_0x3e2f46(0x211)],'customer_name':_0x174bc2[_0x3e2f46(0x1a9)],'created_at':_0x174bc2[_0x3e2f46(0x237)],'updated_at':new Date()}},_0x2e0072=await fetch(_0x16e10f['webhookUrl'],{'method':_0x3e2f46(0x181),'headers':{'Content-Type':_0x3e2f46(0x212),'User-Agent':_0x3e2f46(0x1a8)},'body':JSON['stringify'](_0x3f9dcc)}),_0x2af71b=Date[_0x3e2f46(0x244)]()-_0x4e2545,_0x50662b=_0x2e0072['ok']?_0x3e2f46(0x1ab):await _0x2e0072[_0x3e2f46(0x19f)]();loggerService_1[_0x3e2f46(0x185)][_0x3e2f46(0x1a7)](_0x174bc2[_0x3e2f46(0x20b)],_0x16e10f['webhookUrl'],_0x1e363e,_0x2e0072[_0x3e2f46(0x1c8)],_0x2af71b,_0x3f9dcc),console[_0x3e2f46(0x235)](_0x3e2f46(0x228)+_0x16e10f[_0x3e2f46(0x1bf)]+'\x20with\x20status\x20'+_0x2e0072[_0x3e2f46(0x1c8)]+'\x20('+_0x2af71b+'ms)');}catch(_0x553c46){console[_0x3e2f46(0x209)](_0x3e2f46(0x250),_0x553c46),loggerService_1[_0x3e2f46(0x185)][_0x3e2f46(0x1d9)](_0x174bc2[_0x3e2f46(0x20b)],_0x174bc2[_0x3e2f46(0x1b8)]?.[_0x3e2f46(0x18e)]?.[_0x3e2f46(0x1bf)]||'unknown',_0x3e2f46(0x1e7),_0x553c46,{});}}async[a37_0x329555(0x236)](_0x193833,_0x1c1ee9){const _0x30963d=a37_0x329555;try{const _0x231bb5={'PENDING':_0x30963d(0x253),'PAID':'paid','FAILED':_0x30963d(0x1d4),'EXPIRED':_0x30963d(0x194)},_0x169b6c=_0x231bb5[_0x1c1ee9];if(!_0x169b6c||_0x169b6c===_0x30963d(0x253))return;await telegramBotService_1[_0x30963d(0x25d)][_0x30963d(0x205)](_0x193833[_0x30963d(0x20b)],_0x193833,_0x169b6c);}catch(_0x280d21){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x280d21);}}async[a37_0x329555(0x190)](_0xaa97ec){const _0x1f7681=a37_0x329555;console['log'](_0x1f7681(0x1af)+_0xaa97ec);const _0x3e3929=await database_1[_0x1f7681(0x1ad)]['payment'][_0x1f7681(0x1f2)]({'where':{'id':_0xaa97ec},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3e3929)throw new Error(_0x1f7681(0x23a));if(_0x3e3929['gateway']!==_0x1f7681(0x1c0))throw new Error(_0x1f7681(0x1d3));console[_0x1f7681(0x235)](_0x1f7681(0x18a)+_0xaa97ec),await this[_0x1f7681(0x246)](_0x3e3929),console[_0x1f7681(0x235)](_0x1f7681(0x173)+_0xaa97ec);}[a37_0x329555(0x1a2)](){const _0x12d13f=a37_0x329555,_0xa345d1=this['globalCheckInterval']?this[_0x12d13f(0x1c7)]:undefined,_0x49234e=Array['from'](this[_0x12d13f(0x245)][_0x12d13f(0x180)]())[_0x12d13f(0x21a)](_0xcc251e=>({'paymentId':_0xcc251e[_0x12d13f(0x1b2)],'gatewayPaymentId':_0xcc251e[_0x12d13f(0x196)],'createdAt':_0xcc251e[_0x12d13f(0x237)],'timersCount':_0xcc251e[_0x12d13f(0x1c6)]['length']}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x12d13f(0x1c7)]/(0x3e8*0x3c),'expiryDays':this[_0x12d13f(0x17f)],'activeIndividualTimers':this['paymentTimers'][_0x12d13f(0x20e)],'nextGlobalCheckIn':_0xa345d1,'paymentTimersDetails':_0x49234e};}[a37_0x329555(0x19d)](_0x200d2b){const _0x5badcf=a37_0x329555,_0xb3f70e=this[_0x5badcf(0x245)][_0x5badcf(0x1f1)](_0x200d2b);if(_0xb3f70e)return{'hasTimers':!![],'timersCount':_0xb3f70e[_0x5badcf(0x1c6)][_0x5badcf(0x1ff)],'createdAt':_0xb3f70e[_0x5badcf(0x237)],'gatewayPaymentId':_0xb3f70e['gatewayPaymentId']};return{'hasTimers':![]};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a37_0x329555(0x174)]=new CoinToPayStatusService();function a37_0x3cc5(){const _0x87c893=['üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','5\x20minutes','bankDetails','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','forEach','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','0100','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','telegramBotService','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20details:','‚ùå\x20[CHECK]\x20Payment\x20','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','coinToPayStatusService','cointopay_status_check_','\x20has\x20no\x20gatewayPaymentId','gatewayOrderId','logCoinToPayError','sendShopWebhook','Webhook\x20event\x20','confirmedOn','FAILED','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20is\x20valid\x20for\x20checking,\x20proceeding...','EXPIRY_DAYS','values','POST','‚è∞\x20[EXPIRY]\x20Payment\x20','\x20status\x20unchanged\x20(','webhookEvents','loggerService','‚è∞\x20[HOURLY]\x20Payment\x20','checkAllPendingPayments','h),\x20skipping\x20global\x20check','\x20\x20\x20-\x20ShopId:\x20','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','update','settings','Unknown\x20error','checkPaymentById','description','cointopay_status_check_error','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','expired','timestamp','gatewayPaymentId','stopPeriodicStatusCheck','coinToPayService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','üìä\x20[HOURLY]\x20Payment\x20','globalCheckInterval','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','getPaymentTimerInfo','4707501TcfEAg','text','\x20pending\x20CoinToPay\x20payments','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','getServiceStats','‚è∞\x20[GLOBAL]\x20Found\x20','not\x20found','\x20days,\x20marking\x20as\x20EXPIRED',',\x20stopping\x20individual\x20checks','logShopWebhookSent','TesSoft\x20Payment\x20System/1.0','customerName','.\x20Remaining\x20active\x20timers:\x20','Success','paymentDetails','default','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','‚úÖ\x20[EXPIRY]\x20Payment\x20','\x20->\x20','paymentId','stringify','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20to\x20clear','schedulePaymentChecks','4827015KhZbfv','shop','adminNotes','paidAt','\x20days\x20(created\x20before\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20not\x20found,\x20clearing\x20timers','webhookUrl','cointopay','\x20\x20\x20üìç\x20Source:\x20','\x20\x20\x20-\x20Status:\x20','\x20\x20\x20üìä\x20Status:\x20','getTime','unknown','timers','GLOBAL_CHECK_INTERVAL_MS','status','webhookLog','\x20expired','payment.pending','./loggerService','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20expired\x20CoinToPay\x20payments','üßπ\x20[DEBUG]\x20Clearing\x20','create','schedule_created','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','failed','currency','Bank\x20Details:\x20','\x20days\x20without\x20payment\x20confirmation','__importDefault','logShopWebhookError','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','set','\x20seconds\x20(','toFixed','\x20not\x20found\x20in\x20database','\x20to\x20','/status/','createdOn','\x20(after\x20','auto_expire','delay','\x20triggered\x20for\x20payment\x20','\x20initial\x20timers\x20for\x20payment\x20','webhook_send','transactionId','\x20updated\x20successfully','toLowerCase','\x20status\x20is\x20','40458ZllLjU','\x20timers\x20for\x20payment\x20','toISOString','./telegramBotService','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','get','findUnique','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','__esModule','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','CoinToPayStatusService','catch','floor','‚ùå\x20[HOURLY]\x20Payment\x20','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','872iUORQc','logCoinToPayStatus','‚è∞\x20[GLOBAL]\x20Payment\x20','checkPaymentStatus','length','push','cointopay_auto_expired','Automatically\x20expired\x20after\x20','includes','‚úÖ\x20[HOURLY]\x20Payment\x20','sendPaymentNotification','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20marked\x20as\x20paid\x20at:\x20','checkSinglePaymentById','error','\x20\x20\x20üìù\x20Details:','shopId','Payment\x20older\x20than\x20','stack','size','2167528vsIhLM','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','customerEmail','application/json','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','COINTOPAY_STATUS_CHANGE','getDate','\x20\x20\x20-\x20Gateway:\x20','483SIZgsO','-day\x20timeout','map','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','has','gateway','payment.failed','\x20\x20\x20-\x20Amount:\x20','iban','üí∞\x20[CHECK]\x20Payment\x20','amount','status_check','payment','startPeriodicStatusCheck','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','Shop\x20webhook\x20sent\x20to\x20','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','230954oNAUfq','\x20\x20\x20üìÖ\x20Time:\x20','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','COINTOPAY_ERROR','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','EXPIRED','\x20skipped,\x20','ü™ô\x20[GLOBAL]\x20Found\x20','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','log','sendPaymentStatusNotification','createdAt','\x20for\x20payment\x20','\x20\x20\x20‚ùå\x20Error:\x20','Payment\x20not\x20found','setDate','25254GKrWIE','defineProperty','\x20current\x20status:\x20','‚úÖ\x20[CHECK]\x20Payment\x20','clearPaymentTimers','checkExpiredPayments','\x20is\x20too\x20new\x20(','Failed\x20to\x20mark\x20payment\x20as\x20expired','now','paymentTimers','checkSinglePayment','1367798kqNDKt','PAID','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','\x20status\x20changed\x20to\x20','message','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','payment.success','./gateways/coinToPayService','PENDING','Failed\x20to\x20send\x20shop\x20webhook:','\x20is\x20older\x20than\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','created','üìä\x20[CHECK]\x20Payment\x20'];a37_0x3cc5=function(){return _0x87c893;};return a37_0x3cc5();}