'use strict';const a42_0x574d0d=a42_0x5e11;(function(_0x463142,_0x46aec4){const _0x55d2ac=a42_0x5e11,_0x4a7eee=_0x463142();while(!![]){try{const _0x2bab33=parseInt(_0x55d2ac(0xcc))/0x1*(parseInt(_0x55d2ac(0x1b6))/0x2)+parseInt(_0x55d2ac(0x11a))/0x3*(-parseInt(_0x55d2ac(0xdd))/0x4)+-parseInt(_0x55d2ac(0xdf))/0x5+parseInt(_0x55d2ac(0x116))/0x6+-parseInt(_0x55d2ac(0x105))/0x7*(-parseInt(_0x55d2ac(0x12b))/0x8)+-parseInt(_0x55d2ac(0x192))/0x9*(parseInt(_0x55d2ac(0xbe))/0xa)+parseInt(_0x55d2ac(0xd5))/0xb;if(_0x2bab33===_0x46aec4)break;else _0x4a7eee['push'](_0x4a7eee['shift']());}catch(_0x5c802f){_0x4a7eee['push'](_0x4a7eee['shift']());}}}(a42_0x1633,0xabc0d));var __importDefault=this&&this[a42_0x574d0d(0x19d)]||function(_0x339149){const _0x47fea9=a42_0x574d0d;return _0x339149&&_0x339149[_0x47fea9(0xda)]?_0x339149:{'default':_0x339149};};function a42_0x1633(){const _0x3d47e2=['bankDetails','‚è∞\x20[GLOBAL]\x20Found\x20','CoinToPayStatusService','expired','payment','checkSinglePaymentById','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','ms)','‚úÖ\x20[HOURLY]\x20Payment\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','adminNotes','FAILED','confirmedOn','gateway','\x20\x20\x20-\x20Gateway:\x20','globalCheckInterval','\x20has\x20no\x20gatewayPaymentId','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','1\x20minute','\x20details:','gatewaySettings','\x20in\x20shop\x20','loggerService','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','5754175YieFWz','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20updated:\x20currentPayments=',',\x20clearing\x20individual\x20timers','logCoinToPayError','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','timestamp','\x20is\x20older\x20than\x20','‚è∞\x20[HOURLY]\x20Payment\x20','\x20\x20\x20Amount:\x20','paymentDetails','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','cointopay_status_check_','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','cointopay_status_check_error','\x20\x20\x20Amount\x20after\x20commission:\x20','6553596SEAKug','created','shopId','currency','3202149lINMTB','\x20found:','has','cointopay','clearPaymentTimers','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','h),\x20skipping\x20global\x20check','createdAt','schedule_created','payment.pending','stack','\x20\x20\x20‚ùå\x20Error:\x20','\x20for\x20payment\x20','checkExpiredPayments','Webhook\x20event\x20','logShopWebhookError','ü™ô\x20[DEBUG]\x20Creating\x20','8MTRMrl','logWhiteDomainError','5\x20minutes','from','üìä\x20[CHECK]\x20Payment\x20','\x20commission\x20for\x20shop\x20','Shop\x20webhook\x20sent\x20to\x20','defineProperty','payment.failed','get','‚ùå\x20[HOURLY]\x20Payment\x20','webhookLog','sendShopWebhook','paymentId','./currencyService','üìà\x20[COINTOPAY]\x20Payment\x20','toISOString','gatewayCommissionRate','checkAllPendingPayments','coinToPayService','\x20not\x20found,\x20clearing\x20timers','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20in\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20(age:\x20',':\x20type=','gatewayOrderId','\x20days\x20without\x20payment\x20confirmation','status_check','\x20(after\x20','set','/status/','./gateways/coinToPayService','paid','customerName','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','shop','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','update','now','Payment\x20not\x20found','\x20days\x20(created\x20before\x20','\x20commission:\x20','Gateway\x20','webhookUrl','customerEmail','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','coinToPay2Service','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','parse','EXPIRED','\x20not\x20found\x20in\x20database','\x20status:\x20','\x20marked\x20as\x20paid\x20at:\x20','values','\x20days','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20',',\x20currentPayments=','delay','‚è∞\x20[EXPIRY]\x20Payment\x20','stopPeriodicStatusCheck','COINTOPAY_STATUS_CHANGE','sendPaymentNotification','\x20status\x20changed\x20to\x20',',\x20stopping\x20individual\x20checks','toLowerCase','./gateways/coinToPay2Service','\x20USDT','failed','\x20skipped,\x20','schedulePaymentChecks','\x20is\x20too\x20new\x20(','telegramBotService','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','amount','size','getPaymentTimerInfo','ü™ô\x20[GLOBAL]\x20Found\x20','PAID','gatewayPaymentId','floor','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','‚è∞\x20[GLOBAL]\x20Payment\x20','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',',\x20using\x20default\x20commission\x2010%','\x20individual\x20payment\x20timers','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','Automatically\x20expired\x20after\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','‚úÖ\x20[EXPIRY]\x20Payment\x20','iban','üßπ\x20[CHECK]\x20Payment\x20','COMPLETED','-day\x20timeout','description','Unknown\x20error','stringify','message','timers','\x20status\x20unchanged\x20(','2131794aaPnFE','\x20completed\x20for\x20payment\x20','amountUSDT','length','paidAt',',\x20gateway\x20','\x20amounts\x20calculated:','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','checkPaymentById','currentPayments','\x20->\x20','__importDefault','‚úÖ\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20ShopId:\x20','webhook_send','default','findUnique','transactionId','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','delete','\x20has\x20no\x20gatewayPaymentId,\x20skipping','sendPaymentStatusNotification','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','logShopWebhookSent','2\x20minutes','\x20not\x20enabled\x20for\x20shop\x20','setDate','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','\x20expired\x20CoinToPay\x20payments','\x20timers\x20for\x20payment\x20','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','settings','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20expired','status','push','23784mHTlyi','cointopay_auto_expired','unknown','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','getServiceStats','auto_expire','convertToUSDT','amountAfterGatewayCommissionUSDT','entries','\x20with\x20status\x20','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20initial\x20timers\x20for\x20payment\x20','catch','./telegramBotService','\x20\x20\x20-\x20Amount:\x20','\x20to\x20clear','type','\x20\x20\x20üìÖ\x20Time:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20\x20\x20üìä\x20Status:\x20','createdOn','paymentLink','\x20triggered\x20for\x20payment\x20','POST','checkPaymentStatus','getTime','not\x20found',',\x20using\x20default\x2010%','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','payment.success','10DjWYNw','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','PENDING','create','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','Payment\x20older\x20than\x20','paymentLinkId','includes','logCoinToPayStatus','error','paymentTimers','EXPIRY_DAYS','48FprYJd','currencyService','../config/database','log','forEach','Success','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','üìä\x20[HOURLY]\x20Payment\x20','üí∞\x20[CHECK]\x20Payment\x20','9065507pwEKog','checkSinglePayment','\x20to\x20','üßπ\x20[DEBUG]\x20Clearing\x20','\x20payment\x20','__esModule','\x20\x20\x20üìù\x20Context:','\x20status\x20is\x20','4pAurtr','\x20updated\x20successfully','6507470OUsvcP','toFixed','\x20checked,\x20',',\x20status=','findMany','\x20seconds\x20(','cointopay2','GLOBAL_CHECK_INTERVAL_MS','üõë\x20[SHUTDOWN]\x20Cleared\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'];a42_0x1633=function(){return _0x3d47e2;};return a42_0x1633();}Object[a42_0x574d0d(0x132)](exports,a42_0x574d0d(0xda),{'value':!![]}),exports['coinToPayStatusService']=exports[a42_0x574d0d(0xec)]=void 0x0;const coinToPayService_1=require(a42_0x574d0d(0x14c)),coinToPay2Service_1=require(a42_0x574d0d(0x170)),gateway_1=require('../types/gateway'),database_1=__importDefault(require(a42_0x574d0d(0xce))),telegramBotService_1=require(a42_0x574d0d(0x1c3)),loggerService_1=require('./loggerService'),currencyService_1=require(a42_0x574d0d(0x139));function a42_0x5e11(_0x259f73,_0x118784){const _0x1633e7=a42_0x1633();return a42_0x5e11=function(_0x5e11df,_0x54264e){_0x5e11df=_0x5e11df-0xaf;let _0x18f6eb=_0x1633e7[_0x5e11df];return _0x18f6eb;},a42_0x5e11(_0x259f73,_0x118784);}class CoinToPayStatusService{constructor(){const _0x4ef7ce=a42_0x574d0d;this['globalCheckInterval']=null,this[_0x4ef7ce(0xe6)]=0x3c*0x3c*0x3e8,this[_0x4ef7ce(0xcb)]=0x5,this[_0x4ef7ce(0xca)]=new Map(),this[_0x4ef7ce(0x13e)]=new coinToPayService_1['CoinToPayService'](),this[_0x4ef7ce(0x15b)]=new coinToPay2Service_1['CoinToPay2Service'](),console[_0x4ef7ce(0xcf)]('ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}[a42_0x574d0d(0x174)](_0x29c592,_0x3c2398){const _0x597e57=a42_0x574d0d;console[_0x597e57(0xcf)](_0x597e57(0x17f)),console[_0x597e57(0xcf)]('\x20\x20\x20-\x20paymentId:\x20'+_0x29c592),console[_0x597e57(0xcf)](_0x597e57(0x142)+_0x3c2398),this[_0x597e57(0x11e)](_0x29c592);const _0x3b4372=[],_0xe4a635=new Date(),_0x1029c1=[{'delay':0x1*0x3c*0x3e8,'description':_0x597e57(0xfc)},{'delay':0x2*0x3c*0x3e8,'description':_0x597e57(0x1aa)},{'delay':0x5*0x3c*0x3e8,'description':_0x597e57(0x12d)},{'delay':0x5*0x3c*0x3e8,'description':_0x597e57(0x12d)}];console[_0x597e57(0xcf)](_0x597e57(0x12a)+_0x1029c1[_0x597e57(0x195)]+_0x597e57(0x1c1)+_0x29c592);let _0x1ef33=0x0;_0x1029c1[_0x597e57(0xd0)]((_0x4806c9,_0x587ac9)=>{const _0x4a3a70=_0x597e57;_0x1ef33+=_0x4806c9[_0x4a3a70(0x168)];const _0x52863d=setTimeout(async()=>{const _0x1503f3=_0x4a3a70;console[_0x1503f3(0xcf)](_0x1503f3(0x14f)+(_0x587ac9+0x1)+_0x1503f3(0xb6)+_0x29c592+_0x1503f3(0x149)+_0x4806c9['description']+')');try{await this[_0x1503f3(0xef)](_0x29c592),console[_0x1503f3(0xcf)]('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x587ac9+0x1)+_0x1503f3(0x193)+_0x29c592);}catch(_0x33924f){console[_0x1503f3(0xc9)](_0x1503f3(0x1ad)+(_0x587ac9+0x1)+_0x1503f3(0x126)+_0x29c592+':',_0x33924f),this['logCoinToPayError'](_0x29c592,_0x3c2398,_0x33924f,'status_check',{'checkNumber':_0x587ac9+0x1,'scheduledAfter':_0x4806c9['description'],'isIndividualCheck':!![]});}},_0x1ef33);_0x3b4372['push'](_0x52863d),console[_0x4a3a70(0xcf)](_0x4a3a70(0x164)+(_0x587ac9+0x1)+_0x4a3a70(0x126)+_0x29c592+_0x4a3a70(0x141)+_0x1ef33/0x3e8+_0x4a3a70(0xe4)+_0x4806c9[_0x4a3a70(0x18c)]+')');});const _0xe9eb9=setInterval(async()=>{const _0x37902e=_0x597e57;console[_0x37902e(0xcf)]('ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x29c592);try{const _0xf35a99=await database_1[_0x37902e(0x1a1)][_0x37902e(0xee)]['findUnique']({'where':{'id':_0x29c592},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0xf35a99){console['log'](_0x37902e(0x135)+_0x29c592+_0x37902e(0x13f)),this[_0x37902e(0x11e)](_0x29c592);return;}console[_0x37902e(0xcf)](_0x37902e(0xd3)+_0x29c592+'\x20current\x20status:\x20'+_0xf35a99[_0x37902e(0x1b4)]);if(_0xf35a99[_0x37902e(0x1b4)]!==_0x37902e(0xc2)){console[_0x37902e(0xcf)](_0x37902e(0xf2)+_0x29c592+_0x37902e(0xdc)+_0xf35a99[_0x37902e(0x1b4)]+_0x37902e(0x16e)),this[_0x37902e(0x11e)](_0x29c592);return;}const _0x34c187=Math[_0x37902e(0x17e)]((Date[_0x37902e(0x153)]()-_0xf35a99[_0x37902e(0x121)][_0x37902e(0xb9)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x34c187>=this[_0x37902e(0xcb)]){console[_0x37902e(0xcf)](_0x37902e(0x10e)+_0x29c592+_0x37902e(0x10d)+this['EXPIRY_DAYS']+_0x37902e(0xfb)),this['clearPaymentTimers'](_0x29c592);return;}await this[_0x37902e(0xef)](_0x29c592),console['log'](_0x37902e(0xc4)+_0x29c592);}catch(_0x2ea237){console[_0x37902e(0xc9)]('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x29c592+':',_0x2ea237),this['logCoinToPayError'](_0x29c592,_0x3c2398,_0x2ea237,_0x37902e(0x148),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3b4372[_0x597e57(0x1b5)](_0xe9eb9),this[_0x597e57(0xca)][_0x597e57(0x14a)](_0x29c592,{'timers':_0x3b4372,'paymentId':_0x29c592,'gatewayPaymentId':_0x3c2398,'createdAt':_0xe4a635}),console[_0x597e57(0xcf)]('‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x1029c1[_0x597e57(0x195)]+_0x597e57(0xc1)+_0x29c592),console[_0x597e57(0xcf)](_0x597e57(0x184)+this['paymentTimers']['size']),this[_0x597e57(0xc8)](_0x29c592,_0x3c2398,_0x597e57(0xc2),_0x597e57(0xc2),_0x597e57(0x148),{'action':_0x597e57(0x122),'scheduledChecks':_0x1029c1[_0x597e57(0x195)],'firstCheckIn':_0x1029c1[0x0]['delay']/0x3e8,'totalTimers':this[_0x597e57(0xca)][_0x597e57(0x179)]});}[a42_0x574d0d(0x11e)](_0x2ba8b1){const _0x4e9c7d=a42_0x574d0d,_0x331719=this['paymentTimers'][_0x4e9c7d(0x134)](_0x2ba8b1);_0x331719?(console[_0x4e9c7d(0xcf)](_0x4e9c7d(0xd8)+_0x331719[_0x4e9c7d(0x190)][_0x4e9c7d(0x195)]+_0x4e9c7d(0x1af)+_0x2ba8b1),_0x331719[_0x4e9c7d(0x190)]['forEach']((_0x545f05,_0x52b092)=>{const _0x20dcc3=_0x4e9c7d;_0x545f05&&(clearTimeout(_0x545f05),clearInterval(_0x545f05),console[_0x20dcc3(0xcf)]('üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x52b092+0x1)+_0x20dcc3(0x126)+_0x2ba8b1));}),this[_0x4e9c7d(0xca)][_0x4e9c7d(0x1a5)](_0x2ba8b1),console[_0x4e9c7d(0xcf)]('‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x2ba8b1+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x4e9c7d(0xca)][_0x4e9c7d(0x179)])):console[_0x4e9c7d(0xcf)](_0x4e9c7d(0x177)+_0x2ba8b1+_0x4e9c7d(0xaf));}async[a42_0x574d0d(0xef)](_0x2175a1){const _0x50ff8a=a42_0x574d0d;console[_0x50ff8a(0xcf)](_0x50ff8a(0xd2)+_0x2175a1);const _0x4ea541=await database_1[_0x50ff8a(0x1a1)]['payment'][_0x50ff8a(0x1a2)]({'where':{'id':_0x2175a1},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4ea541){console['log']('‚ùå\x20[CHECK]\x20Payment\x20'+_0x2175a1+_0x50ff8a(0x15f));return;}console[_0x50ff8a(0xcf)]('üìä\x20[CHECK]\x20Payment\x20'+_0x2175a1+_0x50ff8a(0x11b)),console[_0x50ff8a(0xcf)](_0x50ff8a(0xf8)+_0x4ea541[_0x50ff8a(0xf7)]),console['log']('\x20\x20\x20-\x20Status:\x20'+_0x4ea541[_0x50ff8a(0x1b4)]),console[_0x50ff8a(0xcf)](_0x50ff8a(0xf3)+_0x4ea541[_0x50ff8a(0x17d)]),console[_0x50ff8a(0xcf)](_0x50ff8a(0x1c4)+_0x4ea541[_0x50ff8a(0x178)]+'\x20'+_0x4ea541[_0x50ff8a(0x119)]),console[_0x50ff8a(0xcf)](_0x50ff8a(0x19f)+_0x4ea541['shopId']);if(_0x4ea541[_0x50ff8a(0xf7)]!==_0x50ff8a(0x11d)&&_0x4ea541[_0x50ff8a(0xf7)]!==_0x50ff8a(0xe5)){console[_0x50ff8a(0xcf)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x2175a1+'\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20'+_0x4ea541[_0x50ff8a(0xf7)]+')');return;}if(_0x4ea541[_0x50ff8a(0x1b4)]!==_0x50ff8a(0xc2)){console[_0x50ff8a(0xcf)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x2175a1+_0x50ff8a(0xdc)+_0x4ea541['status']+_0x50ff8a(0x16e)),this[_0x50ff8a(0x11e)](_0x2175a1);return;}if(!_0x4ea541[_0x50ff8a(0x17d)]){console[_0x50ff8a(0xcf)](_0x50ff8a(0x1a8)+_0x2175a1+_0x50ff8a(0xfa));return;}console[_0x50ff8a(0xcf)](_0x50ff8a(0x19e)+_0x2175a1+_0x50ff8a(0x143)),await this[_0x50ff8a(0xd6)](_0x4ea541);}[a42_0x574d0d(0xc8)](_0x3325b8,_0x7e6a02,_0x99090,_0xa934da,_0x341b17,_0x1704ca){const _0x423d5b=a42_0x574d0d,_0xc994ed={'type':_0x423d5b(0x16b),'paymentId':_0x3325b8,'gatewayPaymentId':_0x7e6a02,'oldStatus':_0x99090,'newStatus':_0xa934da,'source':_0x341b17,'timestamp':new Date()['toISOString'](),'details':_0x1704ca||{}};loggerService_1[_0x423d5b(0x100)][_0x423d5b(0xc8)](_0xc994ed),console[_0x423d5b(0xcf)](_0x423d5b(0xf0)+_0x3325b8+'\x20('+_0x7e6a02+')'),console['log'](_0x423d5b(0xb3)+_0x99090+_0x423d5b(0x19c)+_0xa934da),console['log']('\x20\x20\x20üìç\x20Source:\x20'+_0x341b17),console[_0x423d5b(0xcf)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0xc994ed[_0x423d5b(0x10c)]),_0x1704ca&&console[_0x423d5b(0xcf)]('\x20\x20\x20üìù\x20Details:',_0x1704ca);}[a42_0x574d0d(0x109)](_0x2b259a,_0x34db93,_0x20ee37,_0x11056f,_0x3844f4){const _0x59176b=a42_0x574d0d,_0x2f8f62={'type':'COINTOPAY_ERROR','paymentId':_0x2b259a,'gatewayPaymentId':_0x34db93,'error':_0x20ee37 instanceof Error?{'message':_0x20ee37[_0x59176b(0x18f)],'stack':_0x20ee37[_0x59176b(0x124)]}:_0x20ee37,'source':_0x11056f,'timestamp':new Date()['toISOString'](),'context':_0x3844f4||{}};loggerService_1[_0x59176b(0x100)][_0x59176b(0x109)](_0x2f8f62),console[_0x59176b(0xc9)](_0x59176b(0x102)+_0x2b259a+'\x20('+_0x34db93+')'),console[_0x59176b(0xc9)](_0x59176b(0x125)+(_0x20ee37 instanceof Error?_0x20ee37[_0x59176b(0x18f)]:_0x20ee37)),console[_0x59176b(0xc9)]('\x20\x20\x20üìç\x20Source:\x20'+_0x11056f),console[_0x59176b(0xc9)](_0x59176b(0xb1)+_0x2f8f62[_0x59176b(0x10c)]),_0x3844f4&&console['error'](_0x59176b(0xdb),_0x3844f4);}['startPeriodicStatusCheck'](){const _0x7dc047=a42_0x574d0d;console[_0x7dc047(0xcf)](_0x7dc047(0x1c0)),this[_0x7dc047(0x13d)]()[_0x7dc047(0x1c2)](_0x7e3a44=>{const _0x57f643=_0x7dc047;console[_0x57f643(0xc9)](_0x57f643(0x181),_0x7e3a44);}),this[_0x7dc047(0xf9)]=setInterval(async()=>{const _0x5b6538=_0x7dc047;try{console[_0x5b6538(0xcf)](_0x5b6538(0x140)),await this['checkAllPendingPayments'](),console['log'](_0x5b6538(0x165));}catch(_0x30acbb){console[_0x5b6538(0xc9)](_0x5b6538(0x106),_0x30acbb);}},this[_0x7dc047(0xe6)]),console['log'](_0x7dc047(0x103));}[a42_0x574d0d(0x16a)](){const _0x1745cd=a42_0x574d0d;console['log'](_0x1745cd(0x101));this['globalCheckInterval']&&(clearInterval(this[_0x1745cd(0xf9)]),this[_0x1745cd(0xf9)]=null,console[_0x1745cd(0xcf)](_0x1745cd(0xe8)));const _0x6f3d20=this[_0x1745cd(0xca)][_0x1745cd(0x179)];for(const [_0x33494c]of this[_0x1745cd(0xca)]){this[_0x1745cd(0x11e)](_0x33494c);}console['log'](_0x1745cd(0xe7)+_0x6f3d20+_0x1745cd(0x183));}async['checkAllPendingPayments'](){const _0x33b98b=a42_0x574d0d;try{console[_0x33b98b(0xcf)](_0x33b98b(0x113));const _0x15e6df=await database_1[_0x33b98b(0x1a1)][_0x33b98b(0xee)][_0x33b98b(0xe3)]({'where':{'gateway':{'in':['cointopay','cointopay2']},'status':_0x33b98b(0xc2),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x33b98b(0xcf)](_0x33b98b(0x17b)+_0x15e6df[_0x33b98b(0x195)]+'\x20pending\x20CoinToPay\x20payments');if(_0x15e6df['length']===0x0){console[_0x33b98b(0xcf)](_0x33b98b(0x151));return;}const _0x321418=await this['checkExpiredPayments'](_0x15e6df);console[_0x33b98b(0xcf)](_0x33b98b(0xeb)+_0x321418['length']+_0x33b98b(0x1ae));let _0x2d0a65=0x0,_0x5b7319=0x0;for(const _0x107967 of _0x15e6df){try{if(_0x321418['includes'](_0x107967['id'])){console[_0x33b98b(0xcf)](_0x33b98b(0x180)+_0x107967['id']+_0x33b98b(0xc0)),_0x5b7319++;continue;}if(this[_0x33b98b(0xca)][_0x33b98b(0x11c)](_0x107967['id'])){console['log'](_0x33b98b(0x180)+_0x107967['id']+_0x33b98b(0xe9)),_0x5b7319++;continue;}const _0x560eab=(Date['now']()-_0x107967[_0x33b98b(0x121)][_0x33b98b(0xb9)]())/(0x3e8*0x3c*0x3c);if(_0x560eab<0x1){console['log'](_0x33b98b(0x180)+_0x107967['id']+_0x33b98b(0x175)+_0x560eab[_0x33b98b(0xe0)](0x1)+_0x33b98b(0x120)),_0x5b7319++;continue;}console['log']('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x107967['id']+_0x33b98b(0x144)+_0x560eab[_0x33b98b(0xe0)](0x1)+'h)'),await this['checkSinglePayment'](_0x107967),_0x2d0a65++,await new Promise(_0x2314e5=>setTimeout(_0x2314e5,0x7d0));}catch(_0x5b2062){console[_0x33b98b(0xc9)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x107967['id']+':',_0x5b2062),this[_0x33b98b(0x109)](_0x107967['id'],_0x107967['gatewayPaymentId']||'unknown',_0x5b2062,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x107967[_0x33b98b(0x178)],'paymentCurrency':_0x107967[_0x33b98b(0x119)],'shopId':_0x107967['shopId'],'createdAt':_0x107967[_0x33b98b(0x121)]}),loggerService_1[_0x33b98b(0x100)][_0x33b98b(0x12c)]('cointopay',_0x33b98b(0x14b)+_0x107967[_0x33b98b(0x17d)],_0x5b2062);}}console['log'](_0x33b98b(0x1b2)+_0x2d0a65+_0x33b98b(0xe1)+_0x5b7319+_0x33b98b(0x173)+_0x321418[_0x33b98b(0x195)]+_0x33b98b(0x1b3));}catch(_0x20c401){console['error'](_0x33b98b(0x199),_0x20c401);}}async[a42_0x574d0d(0x127)](_0xd08c29){const _0x32938b=a42_0x574d0d,_0x350a57=[],_0x7bfb66=new Date();_0x7bfb66[_0x32938b(0x1ac)](_0x7bfb66['getDate']()-this['EXPIRY_DAYS']),console[_0x32938b(0xcf)]('‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x32938b(0x155)+_0x7bfb66[_0x32938b(0x13b)]()+')');for(const _0x199161 of _0xd08c29){if(_0x199161[_0x32938b(0x121)]<_0x7bfb66){console[_0x32938b(0xcf)](_0x32938b(0x169)+_0x199161['id']+_0x32938b(0x10d)+this[_0x32938b(0xcb)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x32938b(0xc8)](_0x199161['id'],_0x199161['gatewayPaymentId']||'unknown','PENDING','EXPIRED',_0x32938b(0x1bb),{'reason':_0x32938b(0xc5)+this[_0x32938b(0xcb)]+_0x32938b(0x163),'createdAt':_0x199161['createdAt'],'daysSinceCreation':Math[_0x32938b(0x17e)]((Date[_0x32938b(0x153)]()-_0x199161[_0x32938b(0x121)][_0x32938b(0xb9)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x199161[_0x32938b(0x178)],'paymentCurrency':_0x199161[_0x32938b(0x119)],'shopId':_0x199161[_0x32938b(0x118)]}),await database_1[_0x32938b(0x1a1)]['payment']['update']({'where':{'id':_0x199161['id']},'data':{'status':_0x32938b(0x15e),'updatedAt':new Date(),'adminNotes':_0x32938b(0x185)+this[_0x32938b(0xcb)]+_0x32938b(0x147)}}),await database_1[_0x32938b(0x1a1)][_0x32938b(0x136)][_0x32938b(0xc3)]({'data':{'paymentId':_0x199161['id'],'shopId':_0x199161['shopId'],'event':_0x32938b(0x1b7),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':'Payment\x20older\x20than\x20'+this[_0x32938b(0xcb)]+'\x20days','createdAt':_0x199161[_0x32938b(0x121)],'expiredAt':new Date()[_0x32938b(0x13b)](),'daysSinceCreation':Math[_0x32938b(0x17e)]((Date[_0x32938b(0x153)]()-_0x199161[_0x32938b(0x121)][_0x32938b(0xb9)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x32938b(0x137)](_0x199161,_0x32938b(0x15e)),await this['sendPaymentStatusNotification'](_0x199161,_0x32938b(0x15e)),this[_0x32938b(0x11e)](_0x199161['id']),_0x350a57['push'](_0x199161['id']),console[_0x32938b(0xcf)](_0x32938b(0x187)+_0x199161['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x32938b(0xcb)]+_0x32938b(0x18b));}catch(_0xbdbfd5){console['error']('‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x199161['id']+':',_0xbdbfd5),this[_0x32938b(0x109)](_0x199161['id'],_0x199161[_0x32938b(0x17d)]||'unknown',_0xbdbfd5,_0x32938b(0x1bb),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x199161[_0x32938b(0x121)],'daysSinceCreation':Math[_0x32938b(0x17e)]((Date[_0x32938b(0x153)]()-_0x199161[_0x32938b(0x121)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x350a57;}async[a42_0x574d0d(0xd6)](_0x3067e8){const _0x515b10=a42_0x574d0d;if(!_0x3067e8['gatewayPaymentId']){console[_0x515b10(0xcf)](_0x515b10(0x1a8)+_0x3067e8['id']+_0x515b10(0x1a6));return;}console[_0x515b10(0xcf)]('üîç\x20[CHECK]\x20Checking\x20'+_0x3067e8[_0x515b10(0xf7)]+_0x515b10(0xd9)+_0x3067e8['id']+'\x20('+_0x3067e8['gatewayPaymentId']+')');try{let _0x2d118d;_0x3067e8['gateway']===_0x515b10(0xe5)?(_0x2d118d=await this['coinToPay2Service'][_0x515b10(0xb8)](_0x3067e8[_0x515b10(0x17d)]),console[_0x515b10(0xcf)](_0x515b10(0x1b0)+_0x3067e8['id']+'\x20status:\x20'+_0x2d118d[_0x515b10(0x1b4)])):(_0x2d118d=await this[_0x515b10(0x13e)][_0x515b10(0xb8)](_0x3067e8['gatewayPaymentId']),console['log'](_0x515b10(0xbf)+_0x3067e8['id']+_0x515b10(0x160)+_0x2d118d[_0x515b10(0x1b4)]));_0x2d118d[_0x515b10(0x110)]&&console[_0x515b10(0xcf)](_0x515b10(0x12f)+_0x3067e8['id']+_0x515b10(0xfd),{'iban':_0x2d118d[_0x515b10(0x110)][_0x515b10(0x188)]||_0x515b10(0xba),'transactionId':_0x2d118d[_0x515b10(0x110)][_0x515b10(0x1a3)],'createdOn':_0x2d118d['paymentDetails'][_0x515b10(0xb4)],'confirmedOn':_0x2d118d['paymentDetails'][_0x515b10(0xf6)]||'not\x20confirmed'});if(_0x2d118d['status']!==_0x3067e8[_0x515b10(0x1b4)]){console[_0x515b10(0xcf)]('üîÑ\x20[CHECK]\x20Updating\x20payment\x20'+_0x3067e8['id']+'\x20status\x20from\x20'+_0x3067e8['status']+_0x515b10(0xd7)+_0x2d118d[_0x515b10(0x1b4)]),this['logCoinToPayStatus'](_0x3067e8['id'],_0x3067e8['gatewayPaymentId'],_0x3067e8[_0x515b10(0x1b4)],_0x2d118d['status'],_0x515b10(0x148),{'paymentDetails':_0x2d118d['paymentDetails'],'amount':_0x2d118d[_0x515b10(0x178)],'currency':_0x2d118d[_0x515b10(0x119)],'shopId':_0x3067e8[_0x515b10(0x118)],'checkTimestamp':new Date()['toISOString']()});const _0x339e23={'status':_0x2d118d[_0x515b10(0x1b4)],'updatedAt':new Date()};if(_0x2d118d[_0x515b10(0x1b4)]===_0x515b10(0x17c)&&_0x3067e8[_0x515b10(0x1b4)]!==_0x515b10(0x17c)){_0x339e23[_0x515b10(0x196)]=new Date();if(!_0x3067e8['amountUSDT']){const _0x4834b7=await currencyService_1[_0x515b10(0xcd)][_0x515b10(0x1bc)](_0x3067e8[_0x515b10(0x178)],_0x3067e8['currency']);_0x339e23[_0x515b10(0x194)]=_0x4834b7;const _0x3b8979=await this['getGatewayCommission'](_0x3067e8[_0x515b10(0x118)],_0x3067e8[_0x515b10(0xf7)]),_0x5e1b86=_0x4834b7*(0x1-_0x3b8979/0x64);_0x339e23[_0x515b10(0x1bd)]=_0x5e1b86,_0x339e23[_0x515b10(0x13c)]=_0x3b8979,console[_0x515b10(0xcf)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x3067e8['id']+_0x515b10(0x198)),console[_0x515b10(0xcf)](_0x515b10(0x10f)+_0x3067e8[_0x515b10(0x178)]+'\x20'+_0x3067e8['currency']+_0x515b10(0x19c)+_0x4834b7[_0x515b10(0xe0)](0x6)+_0x515b10(0x171)),console[_0x515b10(0xcf)]('\x20\x20\x20Gateway\x20'+_0x3067e8['gateway']+_0x515b10(0x156)+_0x3b8979+'%'),console[_0x515b10(0xcf)](_0x515b10(0x115)+_0x5e1b86[_0x515b10(0xe0)](0x6)+_0x515b10(0x171));}console[_0x515b10(0xcf)](_0x515b10(0xd4)+_0x3067e8['id']+_0x515b10(0x161)+_0x339e23['paidAt'][_0x515b10(0x13b)]());}if(_0x2d118d[_0x515b10(0x110)]){const _0x21d609=_0x2d118d[_0x515b10(0x110)];_0x21d609[_0x515b10(0x188)]&&(_0x339e23['remitterIban']=_0x21d609[_0x515b10(0x188)],console[_0x515b10(0xcf)](_0x515b10(0x104)+_0x21d609[_0x515b10(0x188)]));if(_0x21d609[_0x515b10(0xea)]){const _0x45d679=_0x3067e8[_0x515b10(0xf4)]||'',_0x5de8a7='Bank\x20Details:\x20'+_0x21d609['bankDetails'];_0x339e23['adminNotes']=_0x45d679?_0x45d679+'\x0a\x0a'+_0x5de8a7:_0x5de8a7,console[_0x515b10(0xcf)](_0x515b10(0x1b9));}_0x21d609[_0x515b10(0x1a3)]&&console[_0x515b10(0xcf)]('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x21d609[_0x515b10(0x1a3)]),_0x21d609['confirmedOn']&&console['log'](_0x515b10(0x1a4)+_0x21d609[_0x515b10(0xf6)]);}await database_1['default']['payment'][_0x515b10(0x152)]({'where':{'id':_0x3067e8['id']},'data':_0x339e23});if(_0x2d118d[_0x515b10(0x1b4)]===_0x515b10(0x17c)&&_0x3067e8['status']!==_0x515b10(0x17c)){console[_0x515b10(0xcf)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x3067e8['id']+_0x515b10(0xbc));const _0x2f815c=await database_1[_0x515b10(0x1a1)][_0x515b10(0xee)][_0x515b10(0x1a2)]({'where':{'id':_0x3067e8['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x2f815c?.[_0x515b10(0xc6)]&&_0x2f815c[_0x515b10(0xb5)])try{const _0x19dfcd=_0x2f815c['paymentLink'];console[_0x515b10(0xcf)]('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x19dfcd['id']+_0x515b10(0x145)+_0x19dfcd[_0x515b10(0xb0)]+_0x515b10(0x167)+_0x19dfcd[_0x515b10(0x19b)]+_0x515b10(0xe2)+_0x19dfcd[_0x515b10(0x1b4)]);const _0x3697b1=_0x19dfcd[_0x515b10(0x19b)]+0x1,_0x506f8d=_0x19dfcd[_0x515b10(0xb0)]==='SINGLE'?_0x515b10(0x18a):_0x19dfcd[_0x515b10(0x1b4)];await database_1[_0x515b10(0x1a1)][_0x515b10(0xb5)][_0x515b10(0x152)]({'where':{'id':_0x19dfcd['id']},'data':{'currentPayments':_0x3697b1,'status':_0x506f8d,'updatedAt':new Date()}}),console[_0x515b10(0xcf)](_0x515b10(0x10a)+_0x19dfcd['id']+_0x515b10(0x107)+_0x19dfcd['currentPayments']+'\x20->\x20'+_0x3697b1+_0x515b10(0xe2)+_0x19dfcd['status']+'\x20->\x20'+_0x506f8d);}catch(_0x359f82){console['error']('‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:',_0x359f82);}else console[_0x515b10(0xcf)](_0x515b10(0x13a)+_0x3067e8['id']+_0x515b10(0x15a));}await database_1['default']['webhookLog'][_0x515b10(0xc3)]({'data':{'paymentId':_0x3067e8['id'],'shopId':_0x3067e8[_0x515b10(0x118)],'event':_0x515b10(0x112)+_0x2d118d[_0x515b10(0x1b4)][_0x515b10(0x16f)](),'statusCode':0xc8,'responseBody':JSON[_0x515b10(0x18e)]({'oldStatus':_0x3067e8[_0x515b10(0x1b4)],'newStatus':_0x2d118d[_0x515b10(0x1b4)],'paymentDetails':_0x2d118d['paymentDetails'],'checkedAt':new Date()[_0x515b10(0x13b)]()})}}),await this['sendShopWebhook'](_0x3067e8,_0x2d118d[_0x515b10(0x1b4)]),await this['sendPaymentStatusNotification'](_0x3067e8,_0x2d118d[_0x515b10(0x1b4)]),_0x2d118d['status']!==_0x515b10(0xc2)&&(console[_0x515b10(0xcf)](_0x515b10(0x189)+_0x3067e8['id']+_0x515b10(0x16d)+_0x2d118d['status']+_0x515b10(0x108)),this[_0x515b10(0x11e)](_0x3067e8['id'])),console['log'](_0x515b10(0x19e)+_0x3067e8['id']+_0x515b10(0xde));}else console[_0x515b10(0xcf)](_0x515b10(0x12f)+_0x3067e8['id']+_0x515b10(0x191)+_0x2d118d[_0x515b10(0x1b4)]+')'),this[_0x515b10(0xc8)](_0x3067e8['id'],_0x3067e8[_0x515b10(0x17d)],_0x3067e8[_0x515b10(0x1b4)],_0x2d118d['status'],_0x515b10(0x148),{'statusUnchanged':!![],'paymentDetails':_0x2d118d[_0x515b10(0x110)],'amount':_0x2d118d[_0x515b10(0x178)],'currency':_0x2d118d['currency'],'shopId':_0x3067e8['shopId'],'checkTimestamp':new Date()['toISOString']()});}catch(_0x2003ad){console['error'](_0x515b10(0x11f)+_0x3067e8['id']+':',_0x2003ad),this[_0x515b10(0x109)](_0x3067e8['id'],_0x3067e8[_0x515b10(0x17d)],_0x2003ad,_0x515b10(0x148),{'paymentAmount':_0x3067e8[_0x515b10(0x178)],'paymentCurrency':_0x3067e8[_0x515b10(0x119)],'shopId':_0x3067e8[_0x515b10(0x118)],'createdAt':_0x3067e8[_0x515b10(0x121)]}),await database_1[_0x515b10(0x1a1)][_0x515b10(0x136)]['create']({'data':{'paymentId':_0x3067e8['id'],'shopId':_0x3067e8[_0x515b10(0x118)],'event':_0x515b10(0x114),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x2003ad instanceof Error?_0x2003ad[_0x515b10(0x18f)]:_0x515b10(0x18d),'gatewayPaymentId':_0x3067e8[_0x515b10(0x17d)],'checkedAt':new Date()[_0x515b10(0x13b)]()})}});}}async[a42_0x574d0d(0x137)](_0x788a44,_0x4579fc){const _0x5462c7=a42_0x574d0d,_0x433bf3=Date[_0x5462c7(0x153)]();try{const _0x4f5d73=_0x788a44[_0x5462c7(0x150)],_0x15b57e=_0x4f5d73[_0x5462c7(0x1b1)];if(!_0x15b57e?.[_0x5462c7(0x158)]){console[_0x5462c7(0xcf)](_0x5462c7(0xb2)+_0x4f5d73['id']);return;}const _0x11d1cf=_0x4579fc===_0x5462c7(0x17c)?_0x5462c7(0xbd):_0x4579fc===_0x5462c7(0xf5)?_0x5462c7(0x133):_0x4579fc===_0x5462c7(0x15e)?_0x5462c7(0x133):_0x5462c7(0x123);if(!_0x15b57e['webhookEvents']?.[_0x5462c7(0xc7)](_0x11d1cf)){console[_0x5462c7(0xcf)](_0x5462c7(0x128)+_0x11d1cf+_0x5462c7(0x1ab)+_0x4f5d73['id']);return;}const _0x4c4c1b=(0x0,gateway_1['getGatewayIdByName'])(_0x788a44[_0x5462c7(0xf7)])||_0x788a44['gateway'],_0xf20563={'event':_0x11d1cf,'payment':{'id':_0x788a44['id'],'order_id':_0x788a44['orderId'],'gateway_order_id':_0x788a44[_0x5462c7(0x146)],'gateway':_0x4c4c1b,'amount':_0x788a44[_0x5462c7(0x178)],'currency':_0x788a44['currency'],'status':_0x4579fc[_0x5462c7(0x16f)](),'customer_email':_0x788a44[_0x5462c7(0x159)],'customer_name':_0x788a44[_0x5462c7(0x14e)],'created_at':_0x788a44[_0x5462c7(0x121)],'updated_at':new Date()}},_0x88e49=await fetch(_0x15b57e[_0x5462c7(0x158)],{'method':_0x5462c7(0xb7),'headers':{'Content-Type':'application/json','User-Agent':'Payment\x20System/1.0'},'body':JSON['stringify'](_0xf20563)}),_0x19489d=Date['now']()-_0x433bf3,_0x566310=_0x88e49['ok']?_0x5462c7(0xd1):await _0x88e49['text']();loggerService_1['loggerService'][_0x5462c7(0x1a9)](_0x788a44[_0x5462c7(0x118)],_0x15b57e[_0x5462c7(0x158)],_0x11d1cf,_0x88e49[_0x5462c7(0x1b4)],_0x19489d,_0xf20563),console[_0x5462c7(0xcf)](_0x5462c7(0x131)+_0x15b57e['webhookUrl']+_0x5462c7(0x1bf)+_0x88e49[_0x5462c7(0x1b4)]+'\x20('+_0x19489d+_0x5462c7(0xf1));}catch(_0x28f39d){console[_0x5462c7(0xc9)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x28f39d),loggerService_1[_0x5462c7(0x100)][_0x5462c7(0x129)](_0x788a44['shopId'],_0x788a44['shop']?.[_0x5462c7(0x1b1)]?.[_0x5462c7(0x158)]||_0x5462c7(0x1b8),_0x5462c7(0x1a0),_0x28f39d,{});}}async[a42_0x574d0d(0x1a7)](_0x229836,_0x301274){const _0x220583=a42_0x574d0d;try{const _0x4621d0={'PENDING':'created','PAID':_0x220583(0x14d),'FAILED':_0x220583(0x172),'EXPIRED':_0x220583(0xed)},_0x15c729=_0x4621d0[_0x301274];if(!_0x15c729||_0x15c729===_0x220583(0x117))return;await telegramBotService_1[_0x220583(0x176)][_0x220583(0x16c)](_0x229836[_0x220583(0x118)],_0x229836,_0x15c729);}catch(_0x4a7167){console[_0x220583(0xc9)](_0x220583(0x186),_0x4a7167);}}async[a42_0x574d0d(0x19a)](_0x483a79){const _0x517acb=a42_0x574d0d;console[_0x517acb(0xcf)](_0x517acb(0x10b)+_0x483a79);const _0xb1e423=await database_1[_0x517acb(0x1a1)]['payment'][_0x517acb(0x1a2)]({'where':{'id':_0x483a79},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xb1e423)throw new Error(_0x517acb(0x154));if(_0xb1e423['gateway']!==_0x517acb(0x11d)&&_0xb1e423['gateway']!==_0x517acb(0xe5))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console['log']('‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20'+_0xb1e423['gateway']+_0x517acb(0xd9)+_0x483a79),await this[_0x517acb(0xd6)](_0xb1e423),console[_0x517acb(0xcf)](_0x517acb(0x166)+_0x483a79);}[a42_0x574d0d(0x1ba)](){const _0x456322=a42_0x574d0d,_0x21c457=this[_0x456322(0xf9)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x8452e2=Array[_0x456322(0x12e)](this['paymentTimers'][_0x456322(0x162)]())['map'](_0x3c4dc6=>({'paymentId':_0x3c4dc6[_0x456322(0x138)],'gatewayPaymentId':_0x3c4dc6[_0x456322(0x17d)],'createdAt':_0x3c4dc6[_0x456322(0x121)],'timersCount':_0x3c4dc6['timers'][_0x456322(0x195)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x456322(0xe6)]/(0x3e8*0x3c),'expiryDays':this[_0x456322(0xcb)],'activeIndividualTimers':this[_0x456322(0xca)][_0x456322(0x179)],'nextGlobalCheckIn':_0x21c457,'paymentTimersDetails':_0x8452e2};}[a42_0x574d0d(0x17a)](_0x39184a){const _0x274b29=a42_0x574d0d,_0x12bde6=this[_0x274b29(0xca)][_0x274b29(0x134)](_0x39184a);if(_0x12bde6)return{'hasTimers':!![],'timersCount':_0x12bde6[_0x274b29(0x190)]['length'],'createdAt':_0x12bde6[_0x274b29(0x121)],'gatewayPaymentId':_0x12bde6[_0x274b29(0x17d)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0x13dd14,_0x3f0b29){const _0x3e0f5d=a42_0x574d0d;try{const _0x32e5e9=await database_1[_0x3e0f5d(0x1a1)][_0x3e0f5d(0x150)][_0x3e0f5d(0x1a2)]({'where':{'id':_0x13dd14},'select':{'gatewaySettings':!![]}});if(!_0x32e5e9?.[_0x3e0f5d(0xfe)])return console[_0x3e0f5d(0xcf)](_0x3e0f5d(0x111)+_0x13dd14+_0x3e0f5d(0x182)),0xa;const _0x1bf616=JSON[_0x3e0f5d(0x15d)](_0x32e5e9['gatewaySettings']);for(const [_0x4f730c,_0x591112]of Object[_0x3e0f5d(0x1be)](_0x1bf616)){if(_0x4f730c['toLowerCase']()===_0x3f0b29[_0x3e0f5d(0x16f)]()){const _0x42e5a6=_0x591112['commission']||0xa;return console[_0x3e0f5d(0xcf)](_0x3e0f5d(0x157)+_0x3f0b29+_0x3e0f5d(0x130)+_0x13dd14+':\x20'+_0x42e5a6+'%'),_0x42e5a6;}}return console[_0x3e0f5d(0xcf)](_0x3e0f5d(0x15c)+_0x3f0b29+_0x3e0f5d(0xff)+_0x13dd14+_0x3e0f5d(0xbb)),0xa;}catch(_0x44ce5a){return console[_0x3e0f5d(0xc9)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x13dd14+_0x3e0f5d(0x197)+_0x3f0b29+':',_0x44ce5a),0xa;}}}exports[a42_0x574d0d(0xec)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();