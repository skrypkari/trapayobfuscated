'use strict';const a35_0x1a0dac=a35_0x11f3;(function(_0x49359d,_0x2b9005){const _0x2ef1b0=a35_0x11f3,_0x28cfdc=_0x49359d();while(!![]){try{const _0x2d8703=parseInt(_0x2ef1b0(0x1e4))/0x1+parseInt(_0x2ef1b0(0x1ae))/0x2+-parseInt(_0x2ef1b0(0x19d))/0x3+parseInt(_0x2ef1b0(0x1a2))/0x4+-parseInt(_0x2ef1b0(0x170))/0x5+parseInt(_0x2ef1b0(0x168))/0x6+parseInt(_0x2ef1b0(0x182))/0x7*(-parseInt(_0x2ef1b0(0x1cc))/0x8);if(_0x2d8703===_0x2b9005)break;else _0x28cfdc['push'](_0x28cfdc['shift']());}catch(_0x246eba){_0x28cfdc['push'](_0x28cfdc['shift']());}}}(a35_0x27e4,0x6a452));function a35_0x27e4(){const _0x54abf4=['sendPaymentStatusNotification','orderId','logWhiteDomainError','checkExpiredPayments','\x20with\x20status\x20','\x20updated\x20successfully','gatewayPaymentId','EXPIRY_DAYS','\x20status:\x20','⚠️\x20Payment\x20','EXPIRED','now','bankDetails','text','__importDefault','ms)','📊\x20Payment\x20','paidAt','Payment\x20not\x20found','Webhook\x20event\x20','💰\x20Payment\x20','\x20status\x20from\x20','622472KdoqVp','Automatically\x20expired\x20after\x20','🛑\x20CoinToPay\x20status\x20checking\x20stopped','\x20marked\x20as\x20paid\x20at:\x20','cointopay_status_check_error','settings','PAID','expired','telegramBotService','Failed\x20to\x20check\x20payment\x20','amount','createdOn','message','createdAt','sendShopWebhook','1784292vakxDM','customerEmail','iban','setDate','default','coinToPayService','coinToPayStatusService','FAILED','1886840RJICiX','🔄\x20Updating\x20payment\x20','loggerService','logShopWebhookSent','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','created','✅\x20Payment\x20','includes','failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','create','🏦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','adminNotes','Shop\x20webhook\x20sent\x20to\x20','defineProperty','-day\x20timeout','Failed\x20to\x20send\x20shop\x20webhook:','webhookLog','329rDLacG','update','Payment\x20older\x20than\x20','CoinToPayStatusService','🪙\x20Checking\x20','\x20days,\x20marking\x20as\x20EXPIRED','\x20days','\x20days\x20without\x20payment\x20confirmation','log','payment','🪙\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','toISOString','sendPaymentNotification','stringify','__esModule','floor','Bank\x20Details:\x20','application/json','stopPeriodicStatusCheck','status','payment.success','webhook_send','🏦\x20Saved\x20IBAN:\x20','not\x20confirmed','⏰\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','✅\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','length','1009956VAomBr','🔍\x20Checking\x20CoinToPay\x20payment\x20','checkInterval','\x20expired\x20CoinToPay\x20payments','findUnique','1081864CnQLAG','unknown','shop','cointopay','error','../config/database','checkSinglePayment','transactionId','webhookEvents','⏰\x20Payment\x20','CoinToPayService','\x20details:','694122DmzbGb','checkAllPendingPayments','logShopWebhookError','Periodic\x20CoinToPay\x20status\x20check\x20failed:','startPeriodicStatusCheck','not\x20found','🪙\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','webhookUrl','shopId','/status/','confirmedOn','\x20CoinToPay\x20payments','./loggerService','\x20to\x20','\x20pending\x20CoinToPay\x20payments','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','getTime','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Unknown\x20error','payment.failed','checkPaymentStatus','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','\x20days\x20(created\x20before\x20','paymentDetails','Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20is\x20older\x20than\x20','\x20status\x20unchanged\x20(','CHECK_INTERVAL_MS','push','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','66056PjdnmE','cointopay_status_check_'];a35_0x27e4=function(){return _0x54abf4;};return a35_0x27e4();}var __importDefault=this&&this[a35_0x1a0dac(0x1dc)]||function(_0x32329a){const _0x48fe63=a35_0x1a0dac;return _0x32329a&&_0x32329a[_0x48fe63(0x190)]?_0x32329a:{'default':_0x32329a};};function a35_0x11f3(_0x156bcf,_0x53b3ca){const _0x27e47a=a35_0x27e4();return a35_0x11f3=function(_0x11f3ed,_0x451b2d){_0x11f3ed=_0x11f3ed-0x15d;let _0x3399c2=_0x27e47a[_0x11f3ed];return _0x3399c2;},a35_0x11f3(_0x156bcf,_0x53b3ca);}Object[a35_0x1a0dac(0x17e)](exports,'__esModule',{'value':!![]}),exports[a35_0x1a0dac(0x16e)]=exports[a35_0x1a0dac(0x185)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a35_0x1a0dac(0x1a7))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a35_0x1a0dac(0x1ba));class CoinToPayStatusService{constructor(){const _0x533b9e=a35_0x1a0dac;this[_0x533b9e(0x19f)]=null,this['CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x533b9e(0x16d)]=new coinToPayService_1[(_0x533b9e(0x1ac))]();}[a35_0x1a0dac(0x1b2)](){const _0x517b47=a35_0x1a0dac;console[_0x517b47(0x18a)](_0x517b47(0x18c)),this[_0x517b47(0x1af)]()['catch'](_0x56ecae=>{const _0x10d6c4=_0x517b47;console[_0x10d6c4(0x1a6)](_0x10d6c4(0x1c6),_0x56ecae);}),this[_0x517b47(0x19f)]=setInterval(async()=>{const _0x433dc3=_0x517b47;try{await this[_0x433dc3(0x1af)]();}catch(_0x585e19){console[_0x433dc3(0x1a6)](_0x433dc3(0x1b1),_0x585e19);}},this[_0x517b47(0x1c9)]),console[_0x517b47(0x18a)](_0x517b47(0x19b));}[a35_0x1a0dac(0x194)](){const _0x153ebc=a35_0x1a0dac;this[_0x153ebc(0x19f)]&&(clearInterval(this[_0x153ebc(0x19f)]),this[_0x153ebc(0x19f)]=null,console['log'](_0x153ebc(0x1e6)));}async[a35_0x1a0dac(0x1af)](){const _0x348b78=a35_0x1a0dac;try{const _0x1671f1=await database_1[_0x348b78(0x16c)][_0x348b78(0x18b)]['findMany']({'where':{'gateway':_0x348b78(0x1a5),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x1671f1['length']===0x0){console[_0x348b78(0x18a)](_0x348b78(0x1b4));return;}console[_0x348b78(0x18a)](_0x348b78(0x186)+_0x1671f1['length']+_0x348b78(0x1bc));const _0x16afd4=await this[_0x348b78(0x1d1)](_0x1671f1);console['log']('⏰\x20Found\x20'+_0x16afd4[_0x348b78(0x19c)]+_0x348b78(0x1a0));for(const _0x3453ea of _0x1671f1){try{if(_0x16afd4[_0x348b78(0x177)](_0x3453ea['id'])){console[_0x348b78(0x18a)](_0x348b78(0x1ab)+_0x3453ea['id']+_0x348b78(0x1c3));continue;}await this[_0x348b78(0x1a8)](_0x3453ea),await new Promise(_0x1a8370=>setTimeout(_0x1a8370,0x7d0));}catch(_0x18d635){console[_0x348b78(0x1a6)]('Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x3453ea['id']+':',_0x18d635),loggerService_1[_0x348b78(0x172)][_0x348b78(0x1d0)](_0x348b78(0x1a5),_0x348b78(0x1b7)+_0x3453ea[_0x348b78(0x1d4)],_0x18d635);}}console[_0x348b78(0x18a)]('✅\x20Completed\x20checking\x20'+_0x1671f1[_0x348b78(0x19c)]+_0x348b78(0x1b9));}catch(_0x3543b8){console['error'](_0x348b78(0x174),_0x3543b8);}}async['checkExpiredPayments'](_0x542528){const _0x2d203b=a35_0x1a0dac,_0x564f20=[],_0x24fa91=new Date();_0x24fa91[_0x2d203b(0x16b)](_0x24fa91['getDate']()-this[_0x2d203b(0x1d5)]),console[_0x2d203b(0x18a)](_0x2d203b(0x19a)+this['EXPIRY_DAYS']+_0x2d203b(0x1c4)+_0x24fa91[_0x2d203b(0x18d)]()+')');for(const _0xe5abf2 of _0x542528){if(_0xe5abf2[_0x2d203b(0x166)]<_0x24fa91){console['log']('⏰\x20Payment\x20'+_0xe5abf2['id']+_0x2d203b(0x1c7)+this['EXPIRY_DAYS']+_0x2d203b(0x187));try{await database_1[_0x2d203b(0x16c)]['payment'][_0x2d203b(0x183)]({'where':{'id':_0xe5abf2['id']},'data':{'status':_0x2d203b(0x1d8),'updatedAt':new Date(),'adminNotes':_0x2d203b(0x1e5)+this['EXPIRY_DAYS']+_0x2d203b(0x189)}}),await database_1[_0x2d203b(0x16c)][_0x2d203b(0x181)]['create']({'data':{'paymentId':_0xe5abf2['id'],'shopId':_0xe5abf2[_0x2d203b(0x1b6)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x2d203b(0x18f)]({'reason':_0x2d203b(0x184)+this['EXPIRY_DAYS']+_0x2d203b(0x188),'createdAt':_0xe5abf2[_0x2d203b(0x166)],'expiredAt':new Date()[_0x2d203b(0x18d)](),'daysSinceCreation':Math[_0x2d203b(0x191)]((Date[_0x2d203b(0x1d9)]()-_0xe5abf2['createdAt'][_0x2d203b(0x1be)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x2d203b(0x167)](_0xe5abf2,_0x2d203b(0x1d8)),await this['sendPaymentStatusNotification'](_0xe5abf2,_0x2d203b(0x1d8)),_0x564f20[_0x2d203b(0x1ca)](_0xe5abf2['id']),console[_0x2d203b(0x18a)](_0x2d203b(0x176)+_0xe5abf2['id']+_0x2d203b(0x1bd)+this[_0x2d203b(0x1d5)]+_0x2d203b(0x17f));}catch(_0x2d65fa){console['error']('Failed\x20to\x20expire\x20payment\x20'+_0xe5abf2['id']+':',_0x2d65fa);}}}return _0x564f20;}async[a35_0x1a0dac(0x1a8)](_0xd2345e){const _0x4ca545=a35_0x1a0dac;if(!_0xd2345e['gatewayPaymentId']){console[_0x4ca545(0x18a)](_0x4ca545(0x1d7)+_0xd2345e['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x4ca545(0x18a)](_0x4ca545(0x19e)+_0xd2345e['id']+'\x20('+_0xd2345e[_0x4ca545(0x1d4)]+')');try{const _0x5f0649=await this[_0x4ca545(0x16d)][_0x4ca545(0x1c2)](_0xd2345e[_0x4ca545(0x1d4)]);console[_0x4ca545(0x18a)](_0x4ca545(0x1de)+_0xd2345e['id']+_0x4ca545(0x1d6)+_0x5f0649[_0x4ca545(0x195)]);_0x5f0649[_0x4ca545(0x1c5)]&&console[_0x4ca545(0x18a)](_0x4ca545(0x1de)+_0xd2345e['id']+_0x4ca545(0x1ad),{'iban':_0x5f0649['paymentDetails'][_0x4ca545(0x16a)]||_0x4ca545(0x1b3),'transactionId':_0x5f0649['paymentDetails'][_0x4ca545(0x1a9)],'createdOn':_0x5f0649[_0x4ca545(0x1c5)][_0x4ca545(0x164)],'confirmedOn':_0x5f0649[_0x4ca545(0x1c5)][_0x4ca545(0x1b8)]||_0x4ca545(0x199)});if(_0x5f0649['status']!==_0xd2345e[_0x4ca545(0x195)]){console[_0x4ca545(0x18a)](_0x4ca545(0x171)+_0xd2345e['id']+_0x4ca545(0x1e3)+_0xd2345e[_0x4ca545(0x195)]+_0x4ca545(0x1bb)+_0x5f0649[_0x4ca545(0x195)]);const _0x385c90={'status':_0x5f0649['status'],'updatedAt':new Date()};_0x5f0649['status']==='PAID'&&_0xd2345e[_0x4ca545(0x195)]!==_0x4ca545(0x15f)&&(_0x385c90[_0x4ca545(0x1df)]=new Date(),console[_0x4ca545(0x18a)](_0x4ca545(0x1e2)+_0xd2345e['id']+_0x4ca545(0x1e7)+_0x385c90[_0x4ca545(0x1df)][_0x4ca545(0x18d)]()));if(_0x5f0649['paymentDetails']){const _0x284fe1=_0x5f0649['paymentDetails'];_0x284fe1[_0x4ca545(0x16a)]&&(_0x385c90['remitterIban']=_0x284fe1[_0x4ca545(0x16a)],console[_0x4ca545(0x18a)](_0x4ca545(0x198)+_0x284fe1[_0x4ca545(0x16a)]));if(_0x284fe1[_0x4ca545(0x1da)]){const _0xc907ed=_0xd2345e[_0x4ca545(0x17c)]||'',_0x40aaa7=_0x4ca545(0x192)+_0x284fe1[_0x4ca545(0x1da)];_0x385c90[_0x4ca545(0x17c)]=_0xc907ed?_0xc907ed+'\x0a\x0a'+_0x40aaa7:_0x40aaa7,console[_0x4ca545(0x18a)](_0x4ca545(0x17b));}_0x284fe1[_0x4ca545(0x1a9)]&&console['log']('🆔\x20Transaction\x20ID:\x20'+_0x284fe1[_0x4ca545(0x1a9)]),_0x284fe1['confirmedOn']&&console[_0x4ca545(0x18a)]('✅\x20Transaction\x20confirmed\x20on:\x20'+_0x284fe1[_0x4ca545(0x1b8)]);}await database_1[_0x4ca545(0x16c)][_0x4ca545(0x18b)][_0x4ca545(0x183)]({'where':{'id':_0xd2345e['id']},'data':_0x385c90}),await database_1[_0x4ca545(0x16c)][_0x4ca545(0x181)]['create']({'data':{'paymentId':_0xd2345e['id'],'shopId':_0xd2345e[_0x4ca545(0x1b6)],'event':_0x4ca545(0x1cd)+_0x5f0649[_0x4ca545(0x195)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x4ca545(0x18f)]({'oldStatus':_0xd2345e[_0x4ca545(0x195)],'newStatus':_0x5f0649['status'],'paymentDetails':_0x5f0649[_0x4ca545(0x1c5)],'checkedAt':new Date()[_0x4ca545(0x18d)]()})}}),await this['sendShopWebhook'](_0xd2345e,_0x5f0649[_0x4ca545(0x195)]),await this['sendPaymentStatusNotification'](_0xd2345e,_0x5f0649['status']),console[_0x4ca545(0x18a)](_0x4ca545(0x176)+_0xd2345e['id']+_0x4ca545(0x1d3));}else console['log'](_0x4ca545(0x1de)+_0xd2345e['id']+_0x4ca545(0x1c8)+_0x5f0649[_0x4ca545(0x195)]+')');}catch(_0x22c8c6){console[_0x4ca545(0x1a6)](_0x4ca545(0x162)+_0xd2345e['id']+':',_0x22c8c6),await database_1[_0x4ca545(0x16c)][_0x4ca545(0x181)][_0x4ca545(0x17a)]({'data':{'paymentId':_0xd2345e['id'],'shopId':_0xd2345e[_0x4ca545(0x1b6)],'event':_0x4ca545(0x15d),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x22c8c6 instanceof Error?_0x22c8c6[_0x4ca545(0x165)]:_0x4ca545(0x1c0),'gatewayPaymentId':_0xd2345e[_0x4ca545(0x1d4)],'checkedAt':new Date()[_0x4ca545(0x18d)]()})}});}}async[a35_0x1a0dac(0x167)](_0x28cacc,_0x5b07dd){const _0x333b8f=a35_0x1a0dac,_0x5e94a0=Date['now']();try{const _0x26012a=_0x28cacc[_0x333b8f(0x1a4)],_0x40dee8=_0x26012a['settings'];if(!_0x40dee8?.[_0x333b8f(0x1b5)]){console[_0x333b8f(0x18a)](_0x333b8f(0x1bf)+_0x26012a['id']);return;}const _0x2a2d82=_0x5b07dd===_0x333b8f(0x15f)?_0x333b8f(0x196):_0x5b07dd===_0x333b8f(0x16f)?_0x333b8f(0x1c1):_0x5b07dd===_0x333b8f(0x1d8)?'payment.failed':'payment.pending';if(!_0x40dee8[_0x333b8f(0x1aa)]?.[_0x333b8f(0x177)](_0x2a2d82)){console[_0x333b8f(0x18a)](_0x333b8f(0x1e1)+_0x2a2d82+'\x20not\x20enabled\x20for\x20shop\x20'+_0x26012a['id']);return;}const _0x23dffd={'event':_0x2a2d82,'payment':{'id':_0x28cacc['id'],'order_id':_0x28cacc[_0x333b8f(0x1cf)],'gateway_order_id':_0x28cacc['gatewayOrderId'],'gateway':'0100','amount':_0x28cacc[_0x333b8f(0x163)],'currency':_0x28cacc['currency'],'status':_0x5b07dd['toLowerCase'](),'customer_email':_0x28cacc[_0x333b8f(0x169)],'customer_name':_0x28cacc['customerName'],'created_at':_0x28cacc[_0x333b8f(0x166)],'updated_at':new Date()}},_0x11151a=await fetch(_0x40dee8[_0x333b8f(0x1b5)],{'method':'POST','headers':{'Content-Type':_0x333b8f(0x193),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x23dffd)}),_0x453302=Date[_0x333b8f(0x1d9)]()-_0x5e94a0,_0x35955d=_0x11151a['ok']?'Success':await _0x11151a[_0x333b8f(0x1db)]();loggerService_1[_0x333b8f(0x172)][_0x333b8f(0x173)](_0x28cacc[_0x333b8f(0x1b6)],_0x40dee8[_0x333b8f(0x1b5)],_0x2a2d82,_0x11151a[_0x333b8f(0x195)],_0x453302,_0x23dffd),console[_0x333b8f(0x18a)](_0x333b8f(0x17d)+_0x40dee8[_0x333b8f(0x1b5)]+_0x333b8f(0x1d2)+_0x11151a['status']+'\x20('+_0x453302+_0x333b8f(0x1dd));}catch(_0x2ea19c){console[_0x333b8f(0x1a6)](_0x333b8f(0x180),_0x2ea19c),loggerService_1[_0x333b8f(0x172)][_0x333b8f(0x1b0)](_0x28cacc[_0x333b8f(0x1b6)],_0x28cacc['shop']?.[_0x333b8f(0x15e)]?.[_0x333b8f(0x1b5)]||_0x333b8f(0x1a3),_0x333b8f(0x197),_0x2ea19c,{});}}async[a35_0x1a0dac(0x1ce)](_0x18d146,_0x4fa2b9){const _0x17035b=a35_0x1a0dac;try{const _0x481697={'PENDING':_0x17035b(0x175),'PAID':'paid','FAILED':_0x17035b(0x178),'EXPIRED':_0x17035b(0x160)},_0x404ab4=_0x481697[_0x4fa2b9];if(!_0x404ab4||_0x404ab4===_0x17035b(0x175))return;await telegramBotService_1[_0x17035b(0x161)][_0x17035b(0x18e)](_0x18d146['shopId'],_0x18d146,_0x404ab4);}catch(_0x5c80ec){console['error'](_0x17035b(0x179),_0x5c80ec);}}async['checkPaymentById'](_0x48dffc){const _0xb31403=a35_0x1a0dac,_0x140420=await database_1['default'][_0xb31403(0x18b)][_0xb31403(0x1a1)]({'where':{'id':_0x48dffc},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x140420)throw new Error(_0xb31403(0x1e0));if(_0x140420['gateway']!==_0xb31403(0x1a5))throw new Error(_0xb31403(0x1cb));await this[_0xb31403(0x1a8)](_0x140420);}['getServiceStats'](){const _0x51e259=a35_0x1a0dac,_0x6f9793=this[_0x51e259(0x19f)]?this[_0x51e259(0x1c9)]:undefined;return{'isActive':!!this[_0x51e259(0x19f)],'checkIntervalMinutes':this[_0x51e259(0x1c9)]/(0x3e8*0x3c),'expiryDays':this[_0x51e259(0x1d5)],'nextCheckIn':_0x6f9793};}}exports[a35_0x1a0dac(0x185)]=CoinToPayStatusService,exports[a35_0x1a0dac(0x16e)]=new CoinToPayStatusService();