'use strict';const a35_0x491e51=a35_0x14f8;(function(_0x58990c,_0x238bc6){const _0x28e023=a35_0x14f8,_0x1037ec=_0x58990c();while(!![]){try{const _0x4feaed=-parseInt(_0x28e023(0x170))/0x1+-parseInt(_0x28e023(0x142))/0x2+-parseInt(_0x28e023(0x1fe))/0x3*(parseInt(_0x28e023(0x1a0))/0x4)+parseInt(_0x28e023(0x150))/0x5+-parseInt(_0x28e023(0x1ef))/0x6*(parseInt(_0x28e023(0x19c))/0x7)+parseInt(_0x28e023(0x151))/0x8+-parseInt(_0x28e023(0x160))/0x9*(-parseInt(_0x28e023(0x1f1))/0xa);if(_0x4feaed===_0x238bc6)break;else _0x1037ec['push'](_0x1037ec['shift']());}catch(_0x384c0f){_0x1037ec['push'](_0x1037ec['shift']());}}}(a35_0x3284,0x5133c));var __importDefault=this&&this[a35_0x491e51(0x1cb)]||function(_0x22a8f2){const _0x338322=a35_0x491e51;return _0x22a8f2&&_0x22a8f2[_0x338322(0x1b6)]?_0x22a8f2:{'default':_0x22a8f2};};Object['defineProperty'](exports,a35_0x491e51(0x1b6),{'value':!![]}),exports[a35_0x491e51(0x1f3)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a35_0x491e51(0x16e))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a35_0x491e51(0x1c5));class CoinToPayStatusService{constructor(){const _0x5a91dd=a35_0x491e51;this['globalCheckInterval']=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x5a91dd(0x1fb)]=0x5,this[_0x5a91dd(0x155)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x5a91dd(0x217))](),console[_0x5a91dd(0x19a)]('🪙\x20CoinToPayStatusService\x20initialized');}[a35_0x491e51(0x205)](_0x12ee55,_0x19bbf3){const _0x593807=a35_0x491e51;console[_0x593807(0x19a)](_0x593807(0x16c)),console['log'](_0x593807(0x16d)+_0x12ee55),console[_0x593807(0x19a)](_0x593807(0x1fc)+_0x19bbf3),this['clearPaymentTimers'](_0x12ee55);const _0x26059a=[],_0x58c395=new Date(),_0x5c7026=[{'delay':0x1*0x3c*0x3e8,'description':_0x593807(0x1cf)},{'delay':0x2*0x3c*0x3e8,'description':_0x593807(0x1bd)},{'delay':0x5*0x3c*0x3e8,'description':_0x593807(0x1a3)},{'delay':0x5*0x3c*0x3e8,'description':_0x593807(0x1a3)}];console[_0x593807(0x19a)](_0x593807(0x1af)+_0x5c7026[_0x593807(0x1c0)]+_0x593807(0x189)+_0x12ee55);let _0x1f99f2=0x0;_0x5c7026[_0x593807(0x175)]((_0x16c14d,_0x2ccccc)=>{const _0x484225=_0x593807;_0x1f99f2+=_0x16c14d[_0x484225(0x14a)];const _0x1a2bcd=setTimeout(async()=>{const _0x3e4e0c=_0x484225;console[_0x3e4e0c(0x19a)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x2ccccc+0x1)+_0x3e4e0c(0x1b3)+_0x12ee55+'\x20(after\x20'+_0x16c14d[_0x3e4e0c(0x1be)]+')');try{await this[_0x3e4e0c(0x1b0)](_0x12ee55),console[_0x3e4e0c(0x19a)](_0x3e4e0c(0x18c)+(_0x2ccccc+0x1)+_0x3e4e0c(0x15b)+_0x12ee55);}catch(_0x59d45a){console['error'](_0x3e4e0c(0x1f6)+(_0x2ccccc+0x1)+'\x20for\x20payment\x20'+_0x12ee55+':',_0x59d45a),this[_0x3e4e0c(0x198)](_0x12ee55,_0x19bbf3,_0x59d45a,_0x3e4e0c(0x141),{'checkNumber':_0x2ccccc+0x1,'scheduledAfter':_0x16c14d[_0x3e4e0c(0x1be)],'isIndividualCheck':!![]});}},_0x1f99f2);_0x26059a['push'](_0x1a2bcd),console[_0x484225(0x19a)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x2ccccc+0x1)+_0x484225(0x164)+_0x12ee55+_0x484225(0x1e1)+_0x1f99f2/0x3e8+_0x484225(0x14d)+_0x16c14d['description']+')');});const _0x84d07a=setInterval(async()=>{const _0x34e039=_0x593807;console['log']('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x12ee55);try{const _0x2427ec=await database_1[_0x34e039(0x1a2)][_0x34e039(0x17a)]['findUnique']({'where':{'id':_0x12ee55},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x2427ec){console['log'](_0x34e039(0x194)+_0x12ee55+_0x34e039(0x15c)),this['clearPaymentTimers'](_0x12ee55);return;}console[_0x34e039(0x19a)]('📊\x20[HOURLY]\x20Payment\x20'+_0x12ee55+'\x20current\x20status:\x20'+_0x2427ec[_0x34e039(0x1b9)]);if(_0x2427ec[_0x34e039(0x1b9)]!==_0x34e039(0x16a)){console[_0x34e039(0x19a)](_0x34e039(0x1e0)+_0x12ee55+_0x34e039(0x1b1)+_0x2427ec['status']+_0x34e039(0x18d)),this['clearPaymentTimers'](_0x12ee55);return;}const _0x4e9194=Math['floor']((Date[_0x34e039(0x200)]()-_0x2427ec[_0x34e039(0x1e2)][_0x34e039(0x179)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x4e9194>=this['EXPIRY_DAYS']){console[_0x34e039(0x19a)](_0x34e039(0x174)+_0x12ee55+_0x34e039(0x1c3)+this[_0x34e039(0x1fb)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x34e039(0x190)](_0x12ee55);return;}await this[_0x34e039(0x1b0)](_0x12ee55),console[_0x34e039(0x19a)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x12ee55);}catch(_0x129fde){console[_0x34e039(0x1a8)]('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x12ee55+':',_0x129fde),this[_0x34e039(0x198)](_0x12ee55,_0x19bbf3,_0x129fde,_0x34e039(0x141),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x26059a[_0x593807(0x157)](_0x84d07a),this['paymentTimers']['set'](_0x12ee55,{'timers':_0x26059a,'paymentId':_0x12ee55,'gatewayPaymentId':_0x19bbf3,'createdAt':_0x58c395}),console['log']('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x5c7026[_0x593807(0x1c0)]+_0x593807(0x1ab)+_0x12ee55),console[_0x593807(0x19a)](_0x593807(0x1ba)+this[_0x593807(0x155)][_0x593807(0x209)]),this['logCoinToPayStatus'](_0x12ee55,_0x19bbf3,_0x593807(0x16a),_0x593807(0x16a),_0x593807(0x141),{'action':_0x593807(0x1ff),'scheduledChecks':_0x5c7026[_0x593807(0x1c0)],'firstCheckIn':_0x5c7026[0x0][_0x593807(0x14a)]/0x3e8,'totalTimers':this[_0x593807(0x155)][_0x593807(0x209)]});}[a35_0x491e51(0x190)](_0x1d69e3){const _0x1d3ff4=a35_0x491e51,_0x546ae0=this[_0x1d3ff4(0x155)][_0x1d3ff4(0x1c1)](_0x1d69e3);_0x546ae0?(console['log'](_0x1d3ff4(0x17d)+_0x546ae0['timers'][_0x1d3ff4(0x1c0)]+_0x1d3ff4(0x158)+_0x1d69e3),_0x546ae0['timers'][_0x1d3ff4(0x175)]((_0xbf1ab7,_0x153d4e)=>{const _0x57abd7=_0x1d3ff4;_0xbf1ab7&&(clearTimeout(_0xbf1ab7),clearInterval(_0xbf1ab7),console[_0x57abd7(0x19a)](_0x57abd7(0x206)+(_0x153d4e+0x1)+_0x57abd7(0x164)+_0x1d69e3));}),this[_0x1d3ff4(0x155)]['delete'](_0x1d69e3),console[_0x1d3ff4(0x19a)](_0x1d3ff4(0x1eb)+_0x1d69e3+_0x1d3ff4(0x161)+this['paymentTimers'][_0x1d3ff4(0x209)])):console[_0x1d3ff4(0x19a)]('⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x1d69e3+_0x1d3ff4(0x1cd));}async[a35_0x491e51(0x1b0)](_0x4a281c){const _0x3a1c77=a35_0x491e51;console[_0x3a1c77(0x19a)](_0x3a1c77(0x140)+_0x4a281c);const _0x5d2ff6=await database_1[_0x3a1c77(0x1a2)][_0x3a1c77(0x17a)]['findUnique']({'where':{'id':_0x4a281c},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5d2ff6){console['log'](_0x3a1c77(0x1da)+_0x4a281c+'\x20not\x20found\x20in\x20database');return;}console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x4a281c+_0x3a1c77(0x1f9)),console[_0x3a1c77(0x19a)]('\x20\x20\x20-\x20Gateway:\x20'+_0x5d2ff6[_0x3a1c77(0x1d0)]),console[_0x3a1c77(0x19a)](_0x3a1c77(0x187)+_0x5d2ff6[_0x3a1c77(0x1b9)]),console['log'](_0x3a1c77(0x1e6)+_0x5d2ff6[_0x3a1c77(0x1f7)]),console[_0x3a1c77(0x19a)]('\x20\x20\x20-\x20Amount:\x20'+_0x5d2ff6[_0x3a1c77(0x1ed)]+'\x20'+_0x5d2ff6[_0x3a1c77(0x17f)]),console[_0x3a1c77(0x19a)](_0x3a1c77(0x207)+_0x5d2ff6[_0x3a1c77(0x1aa)]);if(_0x5d2ff6[_0x3a1c77(0x1d0)]!==_0x3a1c77(0x210)){console[_0x3a1c77(0x19a)](_0x3a1c77(0x147)+_0x4a281c+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x5d2ff6[_0x3a1c77(0x1d0)]+')');return;}if(_0x5d2ff6[_0x3a1c77(0x1b9)]!==_0x3a1c77(0x16a)){console[_0x3a1c77(0x19a)](_0x3a1c77(0x147)+_0x4a281c+_0x3a1c77(0x1b1)+_0x5d2ff6['status']+_0x3a1c77(0x18d)),this[_0x3a1c77(0x190)](_0x4a281c);return;}if(!_0x5d2ff6[_0x3a1c77(0x1f7)]){console[_0x3a1c77(0x19a)](_0x3a1c77(0x147)+_0x4a281c+_0x3a1c77(0x1b8));return;}console[_0x3a1c77(0x19a)](_0x3a1c77(0x17c)+_0x4a281c+_0x3a1c77(0x1db)),await this['checkSinglePayment'](_0x5d2ff6);}[a35_0x491e51(0x1e3)](_0x279a0f,_0x13ea4f,_0x2bdf5c,_0x32f68d,_0x3d43d9,_0x3254a7){const _0x5cb209=a35_0x491e51,_0x16c087={'type':_0x5cb209(0x152),'paymentId':_0x279a0f,'gatewayPaymentId':_0x13ea4f,'oldStatus':_0x2bdf5c,'newStatus':_0x32f68d,'source':_0x3d43d9,'timestamp':new Date()[_0x5cb209(0x1d3)](),'details':_0x3254a7||{}};loggerService_1[_0x5cb209(0x17b)]['logCoinToPayStatus'](_0x16c087),console[_0x5cb209(0x19a)](_0x5cb209(0x19e)+_0x279a0f+'\x20('+_0x13ea4f+')'),console[_0x5cb209(0x19a)](_0x5cb209(0x185)+_0x2bdf5c+_0x5cb209(0x1b2)+_0x32f68d),console[_0x5cb209(0x19a)](_0x5cb209(0x1d9)+_0x3d43d9),console[_0x5cb209(0x19a)](_0x5cb209(0x1bc)+_0x16c087['timestamp']),_0x3254a7&&console[_0x5cb209(0x19a)]('\x20\x20\x20📝\x20Details:',_0x3254a7);}['logCoinToPayError'](_0x7c7e46,_0x1aec7f,_0x618f83,_0x5b96c9,_0x4414b6){const _0x21d091=a35_0x491e51,_0x940d09={'type':_0x21d091(0x20f),'paymentId':_0x7c7e46,'gatewayPaymentId':_0x1aec7f,'error':_0x618f83 instanceof Error?{'message':_0x618f83['message'],'stack':_0x618f83[_0x21d091(0x1a1)]}:_0x618f83,'source':_0x5b96c9,'timestamp':new Date()[_0x21d091(0x1d3)](),'context':_0x4414b6||{}};loggerService_1[_0x21d091(0x17b)][_0x21d091(0x198)](_0x940d09),console[_0x21d091(0x1a8)]('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x7c7e46+'\x20('+_0x1aec7f+')'),console[_0x21d091(0x1a8)]('\x20\x20\x20❌\x20Error:\x20'+(_0x618f83 instanceof Error?_0x618f83['message']:_0x618f83)),console[_0x21d091(0x1a8)](_0x21d091(0x1d9)+_0x5b96c9),console[_0x21d091(0x1a8)](_0x21d091(0x1bc)+_0x940d09['timestamp']),_0x4414b6&&console[_0x21d091(0x1a8)](_0x21d091(0x216),_0x4414b6);}[a35_0x491e51(0x163)](){const _0x46a12c=a35_0x491e51;console['log']('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x46a12c(0x1e8)]()[_0x46a12c(0x1ae)](_0x47d0d9=>{const _0x54fe8b=_0x46a12c;console[_0x54fe8b(0x1a8)]('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x47d0d9);}),this[_0x46a12c(0x154)]=setInterval(async()=>{const _0x5c32e5=_0x46a12c;try{console['log'](_0x5c32e5(0x213)),await this['checkAllPendingPayments'](),console['log']('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x2f1333){console[_0x5c32e5(0x1a8)](_0x5c32e5(0x188),_0x2f1333);}},this[_0x46a12c(0x1f2)]),console[_0x46a12c(0x19a)](_0x46a12c(0x191));}['stopPeriodicStatusCheck'](){const _0xabc43b=a35_0x491e51;console[_0xabc43b(0x19a)]('🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this['globalCheckInterval']&&(clearInterval(this[_0xabc43b(0x154)]),this[_0xabc43b(0x154)]=null,console['log'](_0xabc43b(0x173)));const _0x5cd59a=this['paymentTimers'][_0xabc43b(0x209)];for(const [_0x272b94]of this[_0xabc43b(0x155)]){this['clearPaymentTimers'](_0x272b94);}console[_0xabc43b(0x19a)](_0xabc43b(0x1b7)+_0x5cd59a+'\x20individual\x20payment\x20timers');}async[a35_0x491e51(0x1e8)](){const _0x1ffb3a=a35_0x491e51;try{console['log'](_0x1ffb3a(0x214));const _0x513cbd=await database_1[_0x1ffb3a(0x1a2)][_0x1ffb3a(0x17a)][_0x1ffb3a(0x1b5)]({'where':{'gateway':_0x1ffb3a(0x210),'status':_0x1ffb3a(0x16a),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x1ffb3a(0x19a)](_0x1ffb3a(0x171)+_0x513cbd['length']+_0x1ffb3a(0x177));if(_0x513cbd[_0x1ffb3a(0x1c0)]===0x0){console[_0x1ffb3a(0x19a)](_0x1ffb3a(0x166));return;}const _0x725c02=await this[_0x1ffb3a(0x148)](_0x513cbd);console[_0x1ffb3a(0x19a)](_0x1ffb3a(0x1a4)+_0x725c02[_0x1ffb3a(0x1c0)]+_0x1ffb3a(0x18f));let _0xfcd56a=0x0,_0x215398=0x0;for(const _0x40d4cc of _0x513cbd){try{if(_0x725c02[_0x1ffb3a(0x19f)](_0x40d4cc['id'])){console['log']('⏰\x20[GLOBAL]\x20Payment\x20'+_0x40d4cc['id']+_0x1ffb3a(0x1d2)),_0x215398++;continue;}if(this[_0x1ffb3a(0x155)]['has'](_0x40d4cc['id'])){console[_0x1ffb3a(0x19a)](_0x1ffb3a(0x180)+_0x40d4cc['id']+_0x1ffb3a(0x212)),_0x215398++;continue;}const _0x498002=(Date[_0x1ffb3a(0x200)]()-_0x40d4cc[_0x1ffb3a(0x1e2)][_0x1ffb3a(0x179)]())/(0x3e8*0x3c*0x3c);if(_0x498002<0x1){console[_0x1ffb3a(0x19a)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x40d4cc['id']+'\x20is\x20too\x20new\x20('+_0x498002[_0x1ffb3a(0x162)](0x1)+_0x1ffb3a(0x172)),_0x215398++;continue;}console[_0x1ffb3a(0x19a)](_0x1ffb3a(0x1e7)+_0x40d4cc['id']+_0x1ffb3a(0x1bf)+_0x498002[_0x1ffb3a(0x162)](0x1)+'h)'),await this[_0x1ffb3a(0x20b)](_0x40d4cc),_0xfcd56a++,await new Promise(_0x2dcab1=>setTimeout(_0x2dcab1,0x7d0));}catch(_0xe07e0d){console[_0x1ffb3a(0x1a8)]('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x40d4cc['id']+':',_0xe07e0d),this[_0x1ffb3a(0x198)](_0x40d4cc['id'],_0x40d4cc[_0x1ffb3a(0x1f7)]||'unknown',_0xe07e0d,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x40d4cc[_0x1ffb3a(0x1ed)],'paymentCurrency':_0x40d4cc[_0x1ffb3a(0x17f)],'shopId':_0x40d4cc[_0x1ffb3a(0x1aa)],'createdAt':_0x40d4cc[_0x1ffb3a(0x1e2)]}),loggerService_1[_0x1ffb3a(0x17b)][_0x1ffb3a(0x176)](_0x1ffb3a(0x210),_0x1ffb3a(0x15d)+_0x40d4cc[_0x1ffb3a(0x1f7)],_0xe07e0d);}}console[_0x1ffb3a(0x19a)](_0x1ffb3a(0x1d5)+_0xfcd56a+_0x1ffb3a(0x1ca)+_0x215398+_0x1ffb3a(0x1d8)+_0x725c02[_0x1ffb3a(0x1c0)]+_0x1ffb3a(0x184));}catch(_0x28c498){console['error'](_0x1ffb3a(0x201),_0x28c498);}}async['checkExpiredPayments'](_0x2df984){const _0xd89259=a35_0x491e51,_0x547ce2=[],_0xff82e0=new Date();_0xff82e0[_0xd89259(0x16b)](_0xff82e0[_0xd89259(0x215)]()-this[_0xd89259(0x1fb)]),console['log']('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days\x20(created\x20before\x20'+_0xff82e0['toISOString']()+')');for(const _0x1f543c of _0x2df984){if(_0x1f543c['createdAt']<_0xff82e0){console[_0xd89259(0x19a)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x1f543c['id']+_0xd89259(0x1c3)+this[_0xd89259(0x1fb)]+_0xd89259(0x143));try{this[_0xd89259(0x1e3)](_0x1f543c['id'],_0x1f543c[_0xd89259(0x1f7)]||'unknown',_0xd89259(0x16a),_0xd89259(0x1c8),'auto_expire',{'reason':_0xd89259(0x1c7)+this[_0xd89259(0x1fb)]+_0xd89259(0x20e),'createdAt':_0x1f543c[_0xd89259(0x1e2)],'daysSinceCreation':Math['floor']((Date[_0xd89259(0x200)]()-_0x1f543c[_0xd89259(0x1e2)][_0xd89259(0x179)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x1f543c[_0xd89259(0x1ed)],'paymentCurrency':_0x1f543c[_0xd89259(0x17f)],'shopId':_0x1f543c[_0xd89259(0x1aa)]}),await database_1[_0xd89259(0x1a2)][_0xd89259(0x17a)][_0xd89259(0x192)]({'where':{'id':_0x1f543c['id']},'data':{'status':_0xd89259(0x1c8),'updatedAt':new Date(),'adminNotes':_0xd89259(0x1dc)+this[_0xd89259(0x1fb)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0xd89259(0x1a2)][_0xd89259(0x1ec)][_0xd89259(0x1fd)]({'data':{'paymentId':_0x1f543c['id'],'shopId':_0x1f543c[_0xd89259(0x1aa)],'event':_0xd89259(0x1d4),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0xd89259(0x1c7)+this[_0xd89259(0x1fb)]+'\x20days','createdAt':_0x1f543c[_0xd89259(0x1e2)],'expiredAt':new Date()[_0xd89259(0x1d3)](),'daysSinceCreation':Math['floor']((Date[_0xd89259(0x200)]()-_0x1f543c[_0xd89259(0x1e2)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0xd89259(0x1c6)](_0x1f543c,_0xd89259(0x1c8)),await this[_0xd89259(0x203)](_0x1f543c,_0xd89259(0x1c8)),this[_0xd89259(0x190)](_0x1f543c['id']),_0x547ce2[_0xd89259(0x157)](_0x1f543c['id']),console['log'](_0xd89259(0x1d7)+_0x1f543c['id']+_0xd89259(0x17e)+this[_0xd89259(0x1fb)]+'-day\x20timeout');}catch(_0x30d9fa){console[_0xd89259(0x1a8)](_0xd89259(0x183)+_0x1f543c['id']+':',_0x30d9fa),this['logCoinToPayError'](_0x1f543c['id'],_0x1f543c['gatewayPaymentId']||_0xd89259(0x1c9),_0x30d9fa,_0xd89259(0x181),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x1f543c['createdAt'],'daysSinceCreation':Math[_0xd89259(0x19d)]((Date[_0xd89259(0x200)]()-_0x1f543c[_0xd89259(0x1e2)][_0xd89259(0x179)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x547ce2;}async['checkSinglePayment'](_0x32fd12){const _0x25f563=a35_0x491e51;if(!_0x32fd12['gatewayPaymentId']){console[_0x25f563(0x19a)](_0x25f563(0x147)+_0x32fd12['id']+_0x25f563(0x211));return;}console[_0x25f563(0x19a)](_0x25f563(0x13c)+_0x32fd12['id']+'\x20('+_0x32fd12[_0x25f563(0x1f7)]+')');try{const _0x4be445=await this[_0x25f563(0x195)][_0x25f563(0x1ad)](_0x32fd12['gatewayPaymentId']);console[_0x25f563(0x19a)](_0x25f563(0x165)+_0x32fd12['id']+'\x20status:\x20'+_0x4be445[_0x25f563(0x1b9)]);_0x4be445[_0x25f563(0x14e)]&&console[_0x25f563(0x19a)]('📊\x20[CHECK]\x20Payment\x20'+_0x32fd12['id']+_0x25f563(0x145),{'iban':_0x4be445[_0x25f563(0x14e)][_0x25f563(0x18b)]||_0x25f563(0x167),'transactionId':_0x4be445[_0x25f563(0x14e)]['transactionId'],'createdOn':_0x4be445['paymentDetails']['createdOn'],'confirmedOn':_0x4be445['paymentDetails'][_0x25f563(0x1e9)]||'not\x20confirmed'});if(_0x4be445[_0x25f563(0x1b9)]!==_0x32fd12[_0x25f563(0x1b9)]){console[_0x25f563(0x19a)](_0x25f563(0x20c)+_0x32fd12['id']+'\x20status\x20from\x20'+_0x32fd12[_0x25f563(0x1b9)]+_0x25f563(0x13d)+_0x4be445[_0x25f563(0x1b9)]),this[_0x25f563(0x1e3)](_0x32fd12['id'],_0x32fd12[_0x25f563(0x1f7)],_0x32fd12['status'],_0x4be445['status'],_0x25f563(0x141),{'paymentDetails':_0x4be445[_0x25f563(0x14e)],'amount':_0x4be445[_0x25f563(0x1ed)],'currency':_0x4be445[_0x25f563(0x17f)],'shopId':_0x32fd12[_0x25f563(0x1aa)],'checkTimestamp':new Date()[_0x25f563(0x1d3)]()});const _0x493f27={'status':_0x4be445[_0x25f563(0x1b9)],'updatedAt':new Date()};_0x4be445[_0x25f563(0x1b9)]===_0x25f563(0x1a9)&&_0x32fd12['status']!==_0x25f563(0x1a9)&&(_0x493f27['paidAt']=new Date(),console[_0x25f563(0x19a)](_0x25f563(0x1ea)+_0x32fd12['id']+_0x25f563(0x144)+_0x493f27['paidAt']['toISOString']()));if(_0x4be445[_0x25f563(0x14e)]){const _0x3899bf=_0x4be445[_0x25f563(0x14e)];_0x3899bf['iban']&&(_0x493f27['remitterIban']=_0x3899bf[_0x25f563(0x18b)],console[_0x25f563(0x19a)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x3899bf[_0x25f563(0x18b)]));if(_0x3899bf[_0x25f563(0x19b)]){const _0x1ef459=_0x32fd12[_0x25f563(0x1e4)]||'',_0x58ab84=_0x25f563(0x208)+_0x3899bf[_0x25f563(0x19b)];_0x493f27[_0x25f563(0x1e4)]=_0x1ef459?_0x1ef459+'\x0a\x0a'+_0x58ab84:_0x58ab84,console[_0x25f563(0x19a)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x3899bf['transactionId']&&console[_0x25f563(0x19a)](_0x25f563(0x149)+_0x3899bf[_0x25f563(0x14b)]),_0x3899bf[_0x25f563(0x1e9)]&&console[_0x25f563(0x19a)](_0x25f563(0x202)+_0x3899bf[_0x25f563(0x1e9)]);}await database_1[_0x25f563(0x1a2)]['payment'][_0x25f563(0x192)]({'where':{'id':_0x32fd12['id']},'data':_0x493f27}),await database_1['default'][_0x25f563(0x1ec)][_0x25f563(0x1fd)]({'data':{'paymentId':_0x32fd12['id'],'shopId':_0x32fd12[_0x25f563(0x1aa)],'event':_0x25f563(0x1b4)+_0x4be445['status'][_0x25f563(0x1fa)](),'statusCode':0xc8,'responseBody':JSON[_0x25f563(0x1cc)]({'oldStatus':_0x32fd12[_0x25f563(0x1b9)],'newStatus':_0x4be445['status'],'paymentDetails':_0x4be445[_0x25f563(0x14e)],'checkedAt':new Date()[_0x25f563(0x1d3)]()})}}),await this[_0x25f563(0x1c6)](_0x32fd12,_0x4be445[_0x25f563(0x1b9)]),await this[_0x25f563(0x203)](_0x32fd12,_0x4be445[_0x25f563(0x1b9)]),_0x4be445[_0x25f563(0x1b9)]!=='PENDING'&&(console[_0x25f563(0x19a)]('🧹\x20[CHECK]\x20Payment\x20'+_0x32fd12['id']+_0x25f563(0x1df)+_0x4be445[_0x25f563(0x1b9)]+_0x25f563(0x199)),this[_0x25f563(0x190)](_0x32fd12['id'])),console[_0x25f563(0x19a)](_0x25f563(0x17c)+_0x32fd12['id']+_0x25f563(0x156));}else console['log'](_0x25f563(0x165)+_0x32fd12['id']+_0x25f563(0x20d)+_0x4be445[_0x25f563(0x1b9)]+')'),this[_0x25f563(0x1e3)](_0x32fd12['id'],_0x32fd12[_0x25f563(0x1f7)],_0x32fd12[_0x25f563(0x1b9)],_0x4be445[_0x25f563(0x1b9)],_0x25f563(0x141),{'statusUnchanged':!![],'paymentDetails':_0x4be445[_0x25f563(0x14e)],'amount':_0x4be445[_0x25f563(0x1ed)],'currency':_0x4be445['currency'],'shopId':_0x32fd12[_0x25f563(0x1aa)],'checkTimestamp':new Date()[_0x25f563(0x1d3)]()});}catch(_0x4ab65a){console[_0x25f563(0x1a8)](_0x25f563(0x18e)+_0x32fd12['id']+':',_0x4ab65a),this[_0x25f563(0x198)](_0x32fd12['id'],_0x32fd12[_0x25f563(0x1f7)],_0x4ab65a,_0x25f563(0x141),{'paymentAmount':_0x32fd12[_0x25f563(0x1ed)],'paymentCurrency':_0x32fd12['currency'],'shopId':_0x32fd12[_0x25f563(0x1aa)],'createdAt':_0x32fd12[_0x25f563(0x1e2)]}),await database_1[_0x25f563(0x1a2)][_0x25f563(0x1ec)][_0x25f563(0x1fd)]({'data':{'paymentId':_0x32fd12['id'],'shopId':_0x32fd12[_0x25f563(0x1aa)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x25f563(0x1cc)]({'error':_0x4ab65a instanceof Error?_0x4ab65a[_0x25f563(0x1ac)]:_0x25f563(0x178),'gatewayPaymentId':_0x32fd12[_0x25f563(0x1f7)],'checkedAt':new Date()['toISOString']()})}});}}async[a35_0x491e51(0x1c6)](_0x3f1430,_0x21a451){const _0x3539c9=a35_0x491e51,_0x4c99a1=Date[_0x3539c9(0x200)]();try{const _0x1969e4=_0x3f1430[_0x3539c9(0x15a)],_0x1fa980=_0x1969e4[_0x3539c9(0x1a6)];if(!_0x1fa980?.[_0x3539c9(0x1c2)]){console['log'](_0x3539c9(0x1d6)+_0x1969e4['id']);return;}const _0x1457f5=_0x21a451===_0x3539c9(0x1a9)?_0x3539c9(0x18a):_0x21a451==='FAILED'?_0x3539c9(0x20a):_0x21a451===_0x3539c9(0x1c8)?_0x3539c9(0x20a):_0x3539c9(0x1c4);if(!_0x1fa980[_0x3539c9(0x186)]?.['includes'](_0x1457f5)){console['log'](_0x3539c9(0x1ee)+_0x1457f5+_0x3539c9(0x1f4)+_0x1969e4['id']);return;}const _0x385788={'event':_0x1457f5,'payment':{'id':_0x3f1430['id'],'order_id':_0x3f1430[_0x3539c9(0x168)],'gateway_order_id':_0x3f1430['gatewayOrderId'],'gateway':_0x3539c9(0x159),'amount':_0x3f1430[_0x3539c9(0x1ed)],'currency':_0x3f1430[_0x3539c9(0x17f)],'status':_0x21a451[_0x3539c9(0x1fa)](),'customer_email':_0x3f1430[_0x3539c9(0x1ce)],'customer_name':_0x3f1430[_0x3539c9(0x1dd)],'created_at':_0x3f1430['createdAt'],'updated_at':new Date()}},_0x257ebf=await fetch(_0x1fa980[_0x3539c9(0x1c2)],{'method':_0x3539c9(0x1e5),'headers':{'Content-Type':_0x3539c9(0x1bb),'User-Agent':_0x3539c9(0x13f)},'body':JSON['stringify'](_0x385788)}),_0x381993=Date[_0x3539c9(0x200)]()-_0x4c99a1,_0x4cb13d=_0x257ebf['ok']?_0x3539c9(0x197):await _0x257ebf['text']();loggerService_1['loggerService'][_0x3539c9(0x1d1)](_0x3f1430[_0x3539c9(0x1aa)],_0x1fa980[_0x3539c9(0x1c2)],_0x1457f5,_0x257ebf[_0x3539c9(0x1b9)],_0x381993,_0x385788),console[_0x3539c9(0x19a)]('Shop\x20webhook\x20sent\x20to\x20'+_0x1fa980[_0x3539c9(0x1c2)]+_0x3539c9(0x1a7)+_0x257ebf[_0x3539c9(0x1b9)]+'\x20('+_0x381993+'ms)');}catch(_0x3a2b0a){console[_0x3539c9(0x1a8)](_0x3539c9(0x196),_0x3a2b0a),loggerService_1[_0x3539c9(0x17b)][_0x3539c9(0x1f8)](_0x3f1430[_0x3539c9(0x1aa)],_0x3f1430[_0x3539c9(0x15a)]?.[_0x3539c9(0x1a6)]?.[_0x3539c9(0x1c2)]||'unknown',_0x3539c9(0x1de),_0x3a2b0a,{});}}async[a35_0x491e51(0x203)](_0x178390,_0x5e2bba){const _0x466b0b=a35_0x491e51;try{const _0x527217={'PENDING':'created','PAID':_0x466b0b(0x1a5),'FAILED':_0x466b0b(0x193),'EXPIRED':_0x466b0b(0x14f)},_0x38b85f=_0x527217[_0x5e2bba];if(!_0x38b85f||_0x38b85f==='created')return;await telegramBotService_1['telegramBotService'][_0x466b0b(0x1f0)](_0x178390[_0x466b0b(0x1aa)],_0x178390,_0x38b85f);}catch(_0x5c66a9){console[_0x466b0b(0x1a8)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x5c66a9);}}async['checkPaymentById'](_0x2818ac){const _0x517c9d=a35_0x491e51;console[_0x517c9d(0x19a)](_0x517c9d(0x14c)+_0x2818ac);const _0xbf566=await database_1[_0x517c9d(0x1a2)][_0x517c9d(0x17a)][_0x517c9d(0x1f5)]({'where':{'id':_0x2818ac},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xbf566)throw new Error(_0x517c9d(0x153));if(_0xbf566[_0x517c9d(0x1d0)]!==_0x517c9d(0x210))throw new Error(_0x517c9d(0x13e));console[_0x517c9d(0x19a)](_0x517c9d(0x204)+_0x2818ac),await this[_0x517c9d(0x20b)](_0xbf566),console[_0x517c9d(0x19a)](_0x517c9d(0x169)+_0x2818ac);}['getServiceStats'](){const _0x5b49f0=a35_0x491e51,_0x592b68=this[_0x5b49f0(0x154)]?this[_0x5b49f0(0x1f2)]:undefined,_0x5a5b5a=Array['from'](this[_0x5b49f0(0x155)][_0x5b49f0(0x15e)]())[_0x5b49f0(0x182)](_0x5c3fe2=>({'paymentId':_0x5c3fe2[_0x5b49f0(0x15f)],'gatewayPaymentId':_0x5c3fe2[_0x5b49f0(0x1f7)],'createdAt':_0x5c3fe2['createdAt'],'timersCount':_0x5c3fe2[_0x5b49f0(0x146)][_0x5b49f0(0x1c0)]}));return{'isActive':!!this[_0x5b49f0(0x154)],'globalCheckIntervalMinutes':this[_0x5b49f0(0x1f2)]/(0x3e8*0x3c),'expiryDays':this[_0x5b49f0(0x1fb)],'activeIndividualTimers':this['paymentTimers']['size'],'nextGlobalCheckIn':_0x592b68,'paymentTimersDetails':_0x5a5b5a};}[a35_0x491e51(0x16f)](_0x231943){const _0x2be380=a35_0x491e51,_0x2f956a=this['paymentTimers']['get'](_0x231943);if(_0x2f956a)return{'hasTimers':!![],'timersCount':_0x2f956a['timers']['length'],'createdAt':_0x2f956a['createdAt'],'gatewayPaymentId':_0x2f956a[_0x2be380(0x1f7)]};return{'hasTimers':![]};}}function a35_0x3284(){const _0xd8d728=['40OyiOrZ','stack','default','5\x20minutes','⏰\x20[GLOBAL]\x20Found\x20','paid','settings','\x20with\x20status\x20','error','PAID','shopId','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','message','checkPaymentStatus','catch','🪙\x20[DEBUG]\x20Creating\x20','checkSinglePaymentById','\x20status\x20is\x20','\x20->\x20','\x20triggered\x20for\x20payment\x20','cointopay_status_check_','findMany','__esModule','🛑\x20[SHUTDOWN]\x20Cleared\x20','\x20has\x20no\x20gatewayPaymentId','status','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','application/json','\x20\x20\x20📅\x20Time:\x20','2\x20minutes','description','\x20(age:\x20','length','get','webhookUrl','\x20is\x20older\x20than\x20','payment.pending','./loggerService','sendShopWebhook','Payment\x20older\x20than\x20','EXPIRED','unknown','\x20checked,\x20','__importDefault','stringify','\x20to\x20clear','customerEmail','1\x20minute','gateway','logShopWebhookSent','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','toISOString','cointopay_auto_expired','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','✅\x20[EXPIRY]\x20Payment\x20','\x20skipped,\x20','\x20\x20\x20📍\x20Source:\x20','❌\x20[CHECK]\x20Payment\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','Automatically\x20expired\x20after\x20','customerName','webhook_send','\x20status\x20changed\x20to\x20','✅\x20[HOURLY]\x20Payment\x20','\x20in\x20','createdAt','logCoinToPayStatus','adminNotes','POST','\x20\x20\x20-\x20GatewayPaymentId:\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','checkAllPendingPayments','confirmedOn','💰\x20[CHECK]\x20Payment\x20','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','webhookLog','amount','Webhook\x20event\x20','6JIHDhE','sendPaymentNotification','115680VpCNPg','GLOBAL_CHECK_INTERVAL_MS','coinToPayStatusService','\x20not\x20enabled\x20for\x20shop\x20','findUnique','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','gatewayPaymentId','logShopWebhookError','\x20found:','toLowerCase','EXPIRY_DAYS','\x20\x20\x20-\x20gatewayPaymentId:\x20','create','126435dTqOot','schedule_created','now','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','sendPaymentStatusNotification','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','schedulePaymentChecks','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20\x20\x20-\x20ShopId:\x20','Bank\x20Details:\x20','size','payment.failed','checkSinglePayment','🔄\x20[CHECK]\x20Updating\x20payment\x20','\x20status\x20unchanged\x20(','\x20days','COINTOPAY_ERROR','cointopay','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','getDate','\x20\x20\x20📝\x20Context:','CoinToPayService','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','\x20to\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','TesSoft\x20Payment\x20System/1.0','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','status_check','869814lDNAZC','\x20days,\x20marking\x20as\x20EXPIRED','\x20marked\x20as\x20paid\x20at:\x20','\x20details:','timers','⚠️\x20[CHECK]\x20Payment\x20','checkExpiredPayments','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','delay','transactionId','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20seconds\x20(','paymentDetails','expired','1559550mXnGDF','2004568sRnFFC','COINTOPAY_STATUS_CHANGE','Payment\x20not\x20found','globalCheckInterval','paymentTimers','\x20updated\x20successfully','push','\x20timers\x20for\x20payment\x20','0100','shop','\x20completed\x20for\x20payment\x20','\x20not\x20found,\x20clearing\x20timers','/status/','values','paymentId','1062WVJNfH','.\x20Remaining\x20active\x20timers:\x20','toFixed','startPeriodicStatusCheck','\x20for\x20payment\x20','📊\x20[CHECK]\x20Payment\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','not\x20found','orderId','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','PENDING','setDate','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20\x20\x20-\x20paymentId:\x20','../config/database','getPaymentTimerInfo','552062KWCVyw','🪙\x20[GLOBAL]\x20Found\x20','h),\x20skipping\x20global\x20check','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','⏰\x20[HOURLY]\x20Payment\x20','forEach','logWhiteDomainError','\x20pending\x20CoinToPay\x20payments','Unknown\x20error','getTime','payment','loggerService','✅\x20[CHECK]\x20Payment\x20','🧹\x20[DEBUG]\x20Clearing\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','currency','⏰\x20[GLOBAL]\x20Payment\x20','auto_expire','map','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','\x20expired','\x20\x20\x20📊\x20Status:\x20','webhookEvents','\x20\x20\x20-\x20Status:\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20initial\x20timers\x20for\x20payment\x20','payment.success','iban','✅\x20[TIMER]\x20Individual\x20check\x20#',',\x20stopping\x20individual\x20checks','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20expired\x20CoinToPay\x20payments','clearPaymentTimers','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','update','failed','❌\x20[HOURLY]\x20Payment\x20','coinToPayService','Failed\x20to\x20send\x20shop\x20webhook:','Success','logCoinToPayError',',\x20clearing\x20individual\x20timers','log','bankDetails','1305374gtFBPA','floor','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','includes'];a35_0x3284=function(){return _0xd8d728;};return a35_0x3284();}function a35_0x14f8(_0x30dd56,_0x5a7949){const _0x32846b=a35_0x3284();return a35_0x14f8=function(_0x14f8b7,_0x167485){_0x14f8b7=_0x14f8b7-0x13c;let _0x21dcc3=_0x32846b[_0x14f8b7];return _0x21dcc3;},a35_0x14f8(_0x30dd56,_0x5a7949);}exports['CoinToPayStatusService']=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();