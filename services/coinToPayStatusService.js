'use strict';function a37_0x1af4(_0x52cd47,_0x1c1b4d){const _0x5256d7=a37_0x5256();return a37_0x1af4=function(_0x1af466,_0x228b80){_0x1af466=_0x1af466-0x17c;let _0x49af76=_0x5256d7[_0x1af466];return _0x49af76;},a37_0x1af4(_0x52cd47,_0x1c1b4d);}const a37_0xab28d8=a37_0x1af4;(function(_0x3e58fc,_0x587cbd){const _0x24ca20=a37_0x1af4,_0x48be69=_0x3e58fc();while(!![]){try{const _0x4d1c08=-parseInt(_0x24ca20(0x1e7))/0x1*(parseInt(_0x24ca20(0x1ed))/0x2)+-parseInt(_0x24ca20(0x221))/0x3*(parseInt(_0x24ca20(0x17f))/0x4)+parseInt(_0x24ca20(0x25c))/0x5*(parseInt(_0x24ca20(0x1d2))/0x6)+parseInt(_0x24ca20(0x1bb))/0x7+parseInt(_0x24ca20(0x18f))/0x8+-parseInt(_0x24ca20(0x1c5))/0x9+-parseInt(_0x24ca20(0x22f))/0xa*(-parseInt(_0x24ca20(0x17c))/0xb);if(_0x4d1c08===_0x587cbd)break;else _0x48be69['push'](_0x48be69['shift']());}catch(_0x4386ec){_0x48be69['push'](_0x48be69['shift']());}}}(a37_0x5256,0xde768));var __importDefault=this&&this[a37_0xab28d8(0x1c3)]||function(_0x53c3d3){const _0x50a979=a37_0xab28d8;return _0x53c3d3&&_0x53c3d3[_0x50a979(0x1e8)]?_0x53c3d3:{'default':_0x53c3d3};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0xab28d8(0x1df)]=void 0x0;const coinToPayService_1=require(a37_0xab28d8(0x244)),database_1=__importDefault(require(a37_0xab28d8(0x23d))),telegramBotService_1=require(a37_0xab28d8(0x24e)),loggerService_1=require(a37_0xab28d8(0x1bd));class CoinToPayStatusService{constructor(){const _0x53f92b=a37_0xab28d8;this['globalCheckInterval']=null,this[_0x53f92b(0x1f8)]=0x3c*0x3c*0x3e8,this[_0x53f92b(0x1c2)]=0x5,this['paymentTimers']=new Map(),this[_0x53f92b(0x1c7)]=new coinToPayService_1[(_0x53f92b(0x1ec))](),console['log'](_0x53f92b(0x1f2));}[a37_0xab28d8(0x193)](_0x23ca42,_0x29ce4a){const _0x54d908=a37_0xab28d8;console[_0x54d908(0x255)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console['log']('\x20\x20\x20-\x20paymentId:\x20'+_0x23ca42),console[_0x54d908(0x255)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x29ce4a),this[_0x54d908(0x1b0)](_0x23ca42);const _0x1b3b45=[],_0x12c99f=new Date(),_0x5524bb=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x54d908(0x1c6)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x54d908(0x1a5)}];console[_0x54d908(0x255)](_0x54d908(0x1de)+_0x5524bb[_0x54d908(0x1b3)]+_0x54d908(0x19b)+_0x23ca42);let _0x2f4185=0x0;_0x5524bb[_0x54d908(0x224)]((_0x492e23,_0x17173)=>{const _0x2159e4=_0x54d908;_0x2f4185+=_0x492e23[_0x2159e4(0x260)];const _0x48551b=setTimeout(async()=>{const _0x2583f8=_0x2159e4;console['log']('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x17173+0x1)+_0x2583f8(0x1ae)+_0x23ca42+_0x2583f8(0x19c)+_0x492e23['description']+')');try{await this['checkSinglePaymentById'](_0x23ca42),console['log'](_0x2583f8(0x1af)+(_0x17173+0x1)+_0x2583f8(0x220)+_0x23ca42);}catch(_0x1ff9ad){console[_0x2583f8(0x228)](_0x2583f8(0x190)+(_0x17173+0x1)+_0x2583f8(0x19f)+_0x23ca42+':',_0x1ff9ad),this['logCoinToPayError'](_0x23ca42,_0x29ce4a,_0x1ff9ad,_0x2583f8(0x205),{'checkNumber':_0x17173+0x1,'scheduledAfter':_0x492e23[_0x2583f8(0x1f9)],'isIndividualCheck':!![]});}},_0x2f4185);_0x1b3b45[_0x2159e4(0x21c)](_0x48551b),console[_0x2159e4(0x255)](_0x2159e4(0x1fb)+(_0x17173+0x1)+_0x2159e4(0x19f)+_0x23ca42+_0x2159e4(0x23e)+_0x2f4185/0x3e8+_0x2159e4(0x210)+_0x492e23['description']+')');});const _0x676f6c=setInterval(async()=>{const _0x17a0d8=_0x54d908;console[_0x17a0d8(0x255)](_0x17a0d8(0x265)+_0x23ca42);try{const _0x296596=await database_1[_0x17a0d8(0x230)]['payment']['findUnique']({'where':{'id':_0x23ca42},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x296596){console[_0x17a0d8(0x255)](_0x17a0d8(0x25f)+_0x23ca42+_0x17a0d8(0x1a7)),this['clearPaymentTimers'](_0x23ca42);return;}console['log']('📊\x20[HOURLY]\x20Payment\x20'+_0x23ca42+'\x20current\x20status:\x20'+_0x296596[_0x17a0d8(0x1b8)]);if(_0x296596[_0x17a0d8(0x1b8)]!=='PENDING'){console[_0x17a0d8(0x255)](_0x17a0d8(0x1da)+_0x23ca42+'\x20status\x20is\x20'+_0x296596['status']+_0x17a0d8(0x189)),this[_0x17a0d8(0x1b0)](_0x23ca42);return;}const _0x53a3fa=Math[_0x17a0d8(0x1eb)]((Date[_0x17a0d8(0x246)]()-_0x296596[_0x17a0d8(0x21b)][_0x17a0d8(0x268)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x53a3fa>=this[_0x17a0d8(0x1c2)]){console[_0x17a0d8(0x255)](_0x17a0d8(0x192)+_0x23ca42+'\x20is\x20older\x20than\x20'+this[_0x17a0d8(0x1c2)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this['clearPaymentTimers'](_0x23ca42);return;}await this['checkSinglePaymentById'](_0x23ca42),console[_0x17a0d8(0x255)](_0x17a0d8(0x1a0)+_0x23ca42);}catch(_0x486058){console[_0x17a0d8(0x228)](_0x17a0d8(0x1e6)+_0x23ca42+':',_0x486058),this[_0x17a0d8(0x1ca)](_0x23ca42,_0x29ce4a,_0x486058,_0x17a0d8(0x205),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x1b3b45['push'](_0x676f6c),this[_0x54d908(0x1d3)][_0x54d908(0x1d8)](_0x23ca42,{'timers':_0x1b3b45,'paymentId':_0x23ca42,'gatewayPaymentId':_0x29ce4a,'createdAt':_0x12c99f}),console[_0x54d908(0x255)](_0x54d908(0x215)+_0x5524bb[_0x54d908(0x1b3)]+_0x54d908(0x21f)+_0x23ca42),console[_0x54d908(0x255)](_0x54d908(0x1ea)+this[_0x54d908(0x1d3)][_0x54d908(0x1dc)]),this['logCoinToPayStatus'](_0x23ca42,_0x29ce4a,_0x54d908(0x1f7),_0x54d908(0x1f7),_0x54d908(0x205),{'action':_0x54d908(0x1db),'scheduledChecks':_0x5524bb[_0x54d908(0x1b3)],'firstCheckIn':_0x5524bb[0x0][_0x54d908(0x260)]/0x3e8,'totalTimers':this[_0x54d908(0x1d3)][_0x54d908(0x1dc)]});}['clearPaymentTimers'](_0x2d1282){const _0x5d516b=a37_0xab28d8,_0x41cb82=this[_0x5d516b(0x1d3)][_0x5d516b(0x18b)](_0x2d1282);_0x41cb82?(console[_0x5d516b(0x255)](_0x5d516b(0x253)+_0x41cb82[_0x5d516b(0x19d)][_0x5d516b(0x1b3)]+'\x20timers\x20for\x20payment\x20'+_0x2d1282),_0x41cb82[_0x5d516b(0x19d)]['forEach']((_0x40a7cc,_0x3591fe)=>{const _0x4bd137=_0x5d516b;_0x40a7cc&&(clearTimeout(_0x40a7cc),clearInterval(_0x40a7cc),console[_0x4bd137(0x255)](_0x4bd137(0x1fa)+(_0x3591fe+0x1)+'\x20for\x20payment\x20'+_0x2d1282));}),this['paymentTimers'][_0x5d516b(0x1aa)](_0x2d1282),console[_0x5d516b(0x255)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x2d1282+_0x5d516b(0x185)+this[_0x5d516b(0x1d3)][_0x5d516b(0x1dc)])):console[_0x5d516b(0x255)](_0x5d516b(0x187)+_0x2d1282+_0x5d516b(0x24d));}async[a37_0xab28d8(0x20a)](_0x29e7f9){const _0x3ecf9e=a37_0xab28d8;console['log'](_0x3ecf9e(0x243)+_0x29e7f9);const _0x9c44a9=await database_1[_0x3ecf9e(0x230)]['payment'][_0x3ecf9e(0x180)]({'where':{'id':_0x29e7f9},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x9c44a9){console[_0x3ecf9e(0x255)]('❌\x20[CHECK]\x20Payment\x20'+_0x29e7f9+_0x3ecf9e(0x216));return;}console[_0x3ecf9e(0x255)](_0x3ecf9e(0x206)+_0x29e7f9+_0x3ecf9e(0x233)),console[_0x3ecf9e(0x255)](_0x3ecf9e(0x20e)+_0x9c44a9[_0x3ecf9e(0x217)]),console['log'](_0x3ecf9e(0x208)+_0x9c44a9[_0x3ecf9e(0x1b8)]),console[_0x3ecf9e(0x255)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x9c44a9[_0x3ecf9e(0x1a8)]),console[_0x3ecf9e(0x255)](_0x3ecf9e(0x196)+_0x9c44a9[_0x3ecf9e(0x25d)]+'\x20'+_0x9c44a9[_0x3ecf9e(0x222)]),console[_0x3ecf9e(0x255)](_0x3ecf9e(0x24f)+_0x9c44a9[_0x3ecf9e(0x225)]);if(_0x9c44a9[_0x3ecf9e(0x217)]!==_0x3ecf9e(0x25e)){console[_0x3ecf9e(0x255)](_0x3ecf9e(0x20f)+_0x29e7f9+_0x3ecf9e(0x1fe)+_0x9c44a9[_0x3ecf9e(0x217)]+')');return;}if(_0x9c44a9['status']!==_0x3ecf9e(0x1f7)){console[_0x3ecf9e(0x255)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x29e7f9+'\x20status\x20is\x20'+_0x9c44a9[_0x3ecf9e(0x1b8)]+_0x3ecf9e(0x189)),this[_0x3ecf9e(0x1b0)](_0x29e7f9);return;}if(!_0x9c44a9['gatewayPaymentId']){console['log'](_0x3ecf9e(0x20f)+_0x29e7f9+_0x3ecf9e(0x1f4));return;}console[_0x3ecf9e(0x255)](_0x3ecf9e(0x252)+_0x29e7f9+_0x3ecf9e(0x1d5)),await this[_0x3ecf9e(0x183)](_0x9c44a9);}[a37_0xab28d8(0x21e)](_0x6ccf18,_0x46cfd5,_0x2537ae,_0x272120,_0x29ce08,_0x563026){const _0xd2f4d6=a37_0xab28d8,_0x4369b6={'type':_0xd2f4d6(0x1b6),'paymentId':_0x6ccf18,'gatewayPaymentId':_0x46cfd5,'oldStatus':_0x2537ae,'newStatus':_0x272120,'source':_0x29ce08,'timestamp':new Date()[_0xd2f4d6(0x1cb)](),'details':_0x563026||{}};loggerService_1['loggerService'][_0xd2f4d6(0x21e)](_0x4369b6),console[_0xd2f4d6(0x255)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x6ccf18+'\x20('+_0x46cfd5+')'),console[_0xd2f4d6(0x255)](_0xd2f4d6(0x23a)+_0x2537ae+'\x20->\x20'+_0x272120),console[_0xd2f4d6(0x255)](_0xd2f4d6(0x22e)+_0x29ce08),console['log'](_0xd2f4d6(0x1f0)+_0x4369b6['timestamp']),_0x563026&&console[_0xd2f4d6(0x255)](_0xd2f4d6(0x1f3),_0x563026);}['logCoinToPayError'](_0x2e3691,_0x44da7c,_0x599441,_0xde3f5f,_0x4774fe){const _0x1d86cc=a37_0xab28d8,_0x26b54f={'type':_0x1d86cc(0x258),'paymentId':_0x2e3691,'gatewayPaymentId':_0x44da7c,'error':_0x599441 instanceof Error?{'message':_0x599441[_0x1d86cc(0x1ce)],'stack':_0x599441[_0x1d86cc(0x1a1)]}:_0x599441,'source':_0xde3f5f,'timestamp':new Date()[_0x1d86cc(0x1cb)](),'context':_0x4774fe||{}};loggerService_1['loggerService']['logCoinToPayError'](_0x26b54f),console['error'](_0x1d86cc(0x191)+_0x2e3691+'\x20('+_0x44da7c+')'),console[_0x1d86cc(0x228)](_0x1d86cc(0x1f6)+(_0x599441 instanceof Error?_0x599441['message']:_0x599441)),console['error'](_0x1d86cc(0x22e)+_0xde3f5f),console[_0x1d86cc(0x228)](_0x1d86cc(0x1f0)+_0x26b54f[_0x1d86cc(0x17d)]),_0x4774fe&&console[_0x1d86cc(0x228)]('\x20\x20\x20📝\x20Context:',_0x4774fe);}[a37_0xab28d8(0x211)](){const _0x595cc1=a37_0xab28d8;console['log']('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x595cc1(0x18e)]()[_0x595cc1(0x1b2)](_0x10a1f5=>{const _0x4e5ca5=_0x595cc1;console[_0x4e5ca5(0x228)](_0x4e5ca5(0x269),_0x10a1f5);}),this[_0x595cc1(0x266)]=setInterval(async()=>{const _0x5ec0d7=_0x595cc1;try{console[_0x5ec0d7(0x255)](_0x5ec0d7(0x1e4)),await this[_0x5ec0d7(0x18e)](),console[_0x5ec0d7(0x255)]('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x11e887){console[_0x5ec0d7(0x228)](_0x5ec0d7(0x1e1),_0x11e887);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x595cc1(0x255)](_0x595cc1(0x248));}[a37_0xab28d8(0x1c4)](){const _0x37ad27=a37_0xab28d8;console['log'](_0x37ad27(0x1b5));this[_0x37ad27(0x266)]&&(clearInterval(this['globalCheckInterval']),this[_0x37ad27(0x266)]=null,console[_0x37ad27(0x255)](_0x37ad27(0x204)));const _0x2cc213=this[_0x37ad27(0x1d3)]['size'];for(const [_0x3382c7]of this['paymentTimers']){this[_0x37ad27(0x1b0)](_0x3382c7);}console[_0x37ad27(0x255)](_0x37ad27(0x1ba)+_0x2cc213+_0x37ad27(0x1b7));}async[a37_0xab28d8(0x18e)](){const _0x4cf73f=a37_0xab28d8;try{console['log'](_0x4cf73f(0x1b4));const _0x2f05d8=await database_1[_0x4cf73f(0x230)][_0x4cf73f(0x1e2)][_0x4cf73f(0x1cf)]({'where':{'gateway':_0x4cf73f(0x25e),'status':_0x4cf73f(0x1f7),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x4cf73f(0x255)](_0x4cf73f(0x20c)+_0x2f05d8[_0x4cf73f(0x1b3)]+'\x20pending\x20CoinToPay\x20payments');if(_0x2f05d8['length']===0x0){console[_0x4cf73f(0x255)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x95eb5a=await this[_0x4cf73f(0x1f1)](_0x2f05d8);console[_0x4cf73f(0x255)]('⏰\x20[GLOBAL]\x20Found\x20'+_0x95eb5a['length']+_0x4cf73f(0x25a));let _0x15aac6=0x0,_0x19a680=0x0;for(const _0x146ab6 of _0x2f05d8){try{if(_0x95eb5a[_0x4cf73f(0x1c9)](_0x146ab6['id'])){console[_0x4cf73f(0x255)](_0x4cf73f(0x17e)+_0x146ab6['id']+_0x4cf73f(0x184)),_0x19a680++;continue;}if(this[_0x4cf73f(0x1d3)][_0x4cf73f(0x240)](_0x146ab6['id'])){console[_0x4cf73f(0x255)](_0x4cf73f(0x17e)+_0x146ab6['id']+_0x4cf73f(0x23b)),_0x19a680++;continue;}const _0x5732fd=(Date[_0x4cf73f(0x246)]()-_0x146ab6['createdAt'][_0x4cf73f(0x268)]())/(0x3e8*0x3c*0x3c);if(_0x5732fd<0x1){console[_0x4cf73f(0x255)](_0x4cf73f(0x17e)+_0x146ab6['id']+'\x20is\x20too\x20new\x20('+_0x5732fd[_0x4cf73f(0x256)](0x1)+_0x4cf73f(0x1ac)),_0x19a680++;continue;}console[_0x4cf73f(0x255)](_0x4cf73f(0x1bc)+_0x146ab6['id']+_0x4cf73f(0x21d)+_0x5732fd[_0x4cf73f(0x256)](0x1)+'h)'),await this['checkSinglePayment'](_0x146ab6),_0x15aac6++,await new Promise(_0xe28caa=>setTimeout(_0xe28caa,0x7d0));}catch(_0x274423){console[_0x4cf73f(0x228)](_0x4cf73f(0x212)+_0x146ab6['id']+':',_0x274423),this[_0x4cf73f(0x1ca)](_0x146ab6['id'],_0x146ab6[_0x4cf73f(0x1a8)]||_0x4cf73f(0x213),_0x274423,_0x4cf73f(0x205),{'isGlobalCheck':!![],'paymentAmount':_0x146ab6[_0x4cf73f(0x25d)],'paymentCurrency':_0x146ab6['currency'],'shopId':_0x146ab6[_0x4cf73f(0x225)],'createdAt':_0x146ab6['createdAt']}),loggerService_1[_0x4cf73f(0x1ef)][_0x4cf73f(0x25b)](_0x4cf73f(0x25e),_0x4cf73f(0x201)+_0x146ab6[_0x4cf73f(0x1a8)],_0x274423);}}console[_0x4cf73f(0x255)](_0x4cf73f(0x237)+_0x15aac6+'\x20checked,\x20'+_0x19a680+_0x4cf73f(0x242)+_0x95eb5a[_0x4cf73f(0x1b3)]+_0x4cf73f(0x257));}catch(_0x18ecc0){console['error'](_0x4cf73f(0x1dd),_0x18ecc0);}}async['checkExpiredPayments'](_0x5204ae){const _0x149721=a37_0xab28d8,_0x108086=[],_0x1add12=new Date();_0x1add12[_0x149721(0x188)](_0x1add12[_0x149721(0x1e9)]()-this[_0x149721(0x1c2)]),console[_0x149721(0x255)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x149721(0x197)+_0x1add12['toISOString']()+')');for(const _0x11f8db of _0x5204ae){if(_0x11f8db['createdAt']<_0x1add12){console[_0x149721(0x255)](_0x149721(0x199)+_0x11f8db['id']+_0x149721(0x264)+this[_0x149721(0x1c2)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x149721(0x21e)](_0x11f8db['id'],_0x11f8db[_0x149721(0x1a8)]||_0x149721(0x213),'PENDING',_0x149721(0x1cd),_0x149721(0x245),{'reason':_0x149721(0x18d)+this['EXPIRY_DAYS']+_0x149721(0x24c),'createdAt':_0x11f8db[_0x149721(0x21b)],'daysSinceCreation':Math['floor']((Date['now']()-_0x11f8db[_0x149721(0x21b)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x11f8db['amount'],'paymentCurrency':_0x11f8db['currency'],'shopId':_0x11f8db[_0x149721(0x225)]}),await database_1[_0x149721(0x230)][_0x149721(0x1e2)][_0x149721(0x1d0)]({'where':{'id':_0x11f8db['id']},'data':{'status':_0x149721(0x1cd),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x149721(0x1c2)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1['default'][_0x149721(0x235)][_0x149721(0x249)]({'data':{'paymentId':_0x11f8db['id'],'shopId':_0x11f8db[_0x149721(0x225)],'event':_0x149721(0x195),'statusCode':0xc8,'responseBody':JSON[_0x149721(0x1cc)]({'reason':_0x149721(0x18d)+this[_0x149721(0x1c2)]+_0x149721(0x24c),'createdAt':_0x11f8db[_0x149721(0x21b)],'expiredAt':new Date()[_0x149721(0x1cb)](),'daysSinceCreation':Math[_0x149721(0x1eb)]((Date['now']()-_0x11f8db[_0x149721(0x21b)][_0x149721(0x268)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x149721(0x207)](_0x11f8db,_0x149721(0x1cd)),await this['sendPaymentStatusNotification'](_0x11f8db,'EXPIRED'),this['clearPaymentTimers'](_0x11f8db['id']),_0x108086[_0x149721(0x21c)](_0x11f8db['id']),console['log'](_0x149721(0x247)+_0x11f8db['id']+_0x149721(0x1a2)+this[_0x149721(0x1c2)]+'-day\x20timeout');}catch(_0x3b725c){console[_0x149721(0x228)](_0x149721(0x202)+_0x11f8db['id']+':',_0x3b725c),this['logCoinToPayError'](_0x11f8db['id'],_0x11f8db[_0x149721(0x1a8)]||_0x149721(0x213),_0x3b725c,_0x149721(0x245),{'reason':_0x149721(0x19a),'createdAt':_0x11f8db[_0x149721(0x21b)],'daysSinceCreation':Math[_0x149721(0x1eb)]((Date[_0x149721(0x246)]()-_0x11f8db['createdAt'][_0x149721(0x268)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x108086;}async['checkSinglePayment'](_0x55914f){const _0xb0f77e=a37_0xab28d8;if(!_0x55914f[_0xb0f77e(0x1a8)]){console[_0xb0f77e(0x255)](_0xb0f77e(0x20f)+_0x55914f['id']+_0xb0f77e(0x1a3));return;}console['log'](_0xb0f77e(0x251)+_0x55914f['id']+'\x20('+_0x55914f['gatewayPaymentId']+')');try{const _0x364988=await this['coinToPayService'][_0xb0f77e(0x1a4)](_0x55914f['gatewayPaymentId']);console[_0xb0f77e(0x255)](_0xb0f77e(0x206)+_0x55914f['id']+_0xb0f77e(0x254)+_0x364988[_0xb0f77e(0x1b8)]);_0x364988[_0xb0f77e(0x22d)]&&console[_0xb0f77e(0x255)](_0xb0f77e(0x206)+_0x55914f['id']+_0xb0f77e(0x20d),{'iban':_0x364988['paymentDetails'][_0xb0f77e(0x236)]||_0xb0f77e(0x1a6),'transactionId':_0x364988[_0xb0f77e(0x22d)][_0xb0f77e(0x227)],'createdOn':_0x364988[_0xb0f77e(0x22d)][_0xb0f77e(0x186)],'confirmedOn':_0x364988[_0xb0f77e(0x22d)]['confirmedOn']||_0xb0f77e(0x21a)});if(_0x364988[_0xb0f77e(0x1b8)]!==_0x55914f[_0xb0f77e(0x1b8)]){console['log']('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x55914f['id']+_0xb0f77e(0x1d9)+_0x55914f['status']+_0xb0f77e(0x23c)+_0x364988[_0xb0f77e(0x1b8)]),this['logCoinToPayStatus'](_0x55914f['id'],_0x55914f[_0xb0f77e(0x1a8)],_0x55914f['status'],_0x364988['status'],_0xb0f77e(0x205),{'paymentDetails':_0x364988['paymentDetails'],'amount':_0x364988[_0xb0f77e(0x25d)],'currency':_0x364988[_0xb0f77e(0x222)],'shopId':_0x55914f[_0xb0f77e(0x225)],'checkTimestamp':new Date()[_0xb0f77e(0x1cb)]()});const _0x9b4196={'status':_0x364988[_0xb0f77e(0x1b8)],'updatedAt':new Date()};_0x364988[_0xb0f77e(0x1b8)]==='PAID'&&_0x55914f[_0xb0f77e(0x1b8)]!==_0xb0f77e(0x238)&&(_0x9b4196['paidAt']=new Date(),console['log']('💰\x20[CHECK]\x20Payment\x20'+_0x55914f['id']+_0xb0f77e(0x1fc)+_0x9b4196[_0xb0f77e(0x267)][_0xb0f77e(0x1cb)]()));if(_0x364988[_0xb0f77e(0x22d)]){const _0x424bdd=_0x364988[_0xb0f77e(0x22d)];_0x424bdd[_0xb0f77e(0x236)]&&(_0x9b4196[_0xb0f77e(0x231)]=_0x424bdd['iban'],console[_0xb0f77e(0x255)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x424bdd[_0xb0f77e(0x236)]));if(_0x424bdd['bankDetails']){const _0x45476e=_0x55914f['adminNotes']||'',_0x56d684=_0xb0f77e(0x18a)+_0x424bdd[_0xb0f77e(0x22c)];_0x9b4196[_0xb0f77e(0x1f5)]=_0x45476e?_0x45476e+'\x0a\x0a'+_0x56d684:_0x56d684,console[_0xb0f77e(0x255)](_0xb0f77e(0x182));}_0x424bdd[_0xb0f77e(0x227)]&&console[_0xb0f77e(0x255)](_0xb0f77e(0x259)+_0x424bdd[_0xb0f77e(0x227)]),_0x424bdd[_0xb0f77e(0x1e0)]&&console['log'](_0xb0f77e(0x229)+_0x424bdd[_0xb0f77e(0x1e0)]);}await database_1[_0xb0f77e(0x230)]['payment']['update']({'where':{'id':_0x55914f['id']},'data':_0x9b4196}),await database_1[_0xb0f77e(0x230)][_0xb0f77e(0x235)][_0xb0f77e(0x249)]({'data':{'paymentId':_0x55914f['id'],'shopId':_0x55914f[_0xb0f77e(0x225)],'event':_0xb0f77e(0x22a)+_0x364988['status'][_0xb0f77e(0x181)](),'statusCode':0xc8,'responseBody':JSON[_0xb0f77e(0x1cc)]({'oldStatus':_0x55914f[_0xb0f77e(0x1b8)],'newStatus':_0x364988[_0xb0f77e(0x1b8)],'paymentDetails':_0x364988[_0xb0f77e(0x22d)],'checkedAt':new Date()[_0xb0f77e(0x1cb)]()})}}),await this[_0xb0f77e(0x207)](_0x55914f,_0x364988[_0xb0f77e(0x1b8)]),await this['sendPaymentStatusNotification'](_0x55914f,_0x364988[_0xb0f77e(0x1b8)]),_0x364988[_0xb0f77e(0x1b8)]!==_0xb0f77e(0x1f7)&&(console[_0xb0f77e(0x255)](_0xb0f77e(0x261)+_0x55914f['id']+_0xb0f77e(0x1d1)+_0x364988[_0xb0f77e(0x1b8)]+_0xb0f77e(0x22b)),this['clearPaymentTimers'](_0x55914f['id'])),console['log'](_0xb0f77e(0x252)+_0x55914f['id']+_0xb0f77e(0x1e5));}else console[_0xb0f77e(0x255)]('📊\x20[CHECK]\x20Payment\x20'+_0x55914f['id']+_0xb0f77e(0x1d7)+_0x364988[_0xb0f77e(0x1b8)]+')'),this['logCoinToPayStatus'](_0x55914f['id'],_0x55914f['gatewayPaymentId'],_0x55914f[_0xb0f77e(0x1b8)],_0x364988['status'],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x364988[_0xb0f77e(0x22d)],'amount':_0x364988[_0xb0f77e(0x25d)],'currency':_0x364988[_0xb0f77e(0x222)],'shopId':_0x55914f[_0xb0f77e(0x225)],'checkTimestamp':new Date()[_0xb0f77e(0x1cb)]()});}catch(_0x157a25){console[_0xb0f77e(0x228)](_0xb0f77e(0x219)+_0x55914f['id']+':',_0x157a25),this[_0xb0f77e(0x1ca)](_0x55914f['id'],_0x55914f[_0xb0f77e(0x1a8)],_0x157a25,'status_check',{'paymentAmount':_0x55914f[_0xb0f77e(0x25d)],'paymentCurrency':_0x55914f[_0xb0f77e(0x222)],'shopId':_0x55914f[_0xb0f77e(0x225)],'createdAt':_0x55914f[_0xb0f77e(0x21b)]}),await database_1[_0xb0f77e(0x230)]['webhookLog'][_0xb0f77e(0x249)]({'data':{'paymentId':_0x55914f['id'],'shopId':_0x55914f[_0xb0f77e(0x225)],'event':_0xb0f77e(0x241),'statusCode':0x1f4,'responseBody':JSON[_0xb0f77e(0x1cc)]({'error':_0x157a25 instanceof Error?_0x157a25['message']:_0xb0f77e(0x18c),'gatewayPaymentId':_0x55914f[_0xb0f77e(0x1a8)],'checkedAt':new Date()[_0xb0f77e(0x1cb)]()})}});}}async['sendShopWebhook'](_0x104bb9,_0x79a9d9){const _0x487a71=a37_0xab28d8,_0x5ace6b=Date[_0x487a71(0x246)]();try{const _0x4e777e=_0x104bb9[_0x487a71(0x234)],_0x1c0b5a=_0x4e777e[_0x487a71(0x1c1)];if(!_0x1c0b5a?.[_0x487a71(0x23f)]){console[_0x487a71(0x255)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x4e777e['id']);return;}const _0x57bca2=_0x79a9d9===_0x487a71(0x238)?_0x487a71(0x1d6):_0x79a9d9===_0x487a71(0x19e)?'payment.failed':_0x79a9d9===_0x487a71(0x1cd)?'payment.failed':'payment.pending';if(!_0x1c0b5a[_0x487a71(0x203)]?.['includes'](_0x57bca2)){console[_0x487a71(0x255)](_0x487a71(0x1ff)+_0x57bca2+'\x20not\x20enabled\x20for\x20shop\x20'+_0x4e777e['id']);return;}const _0x4f21d9={'event':_0x57bca2,'payment':{'id':_0x104bb9['id'],'order_id':_0x104bb9['orderId'],'gateway_order_id':_0x104bb9[_0x487a71(0x24a)],'gateway':_0x487a71(0x209),'amount':_0x104bb9[_0x487a71(0x25d)],'currency':_0x104bb9[_0x487a71(0x222)],'status':_0x79a9d9[_0x487a71(0x181)](),'customer_email':_0x104bb9[_0x487a71(0x1bf)],'customer_name':_0x104bb9[_0x487a71(0x200)],'created_at':_0x104bb9[_0x487a71(0x21b)],'updated_at':new Date()}},_0x473b09=await fetch(_0x1c0b5a[_0x487a71(0x23f)],{'method':_0x487a71(0x262),'headers':{'Content-Type':_0x487a71(0x1be),'User-Agent':_0x487a71(0x1ad)},'body':JSON['stringify'](_0x4f21d9)}),_0x154ba3=Date[_0x487a71(0x246)]()-_0x5ace6b,_0x54d579=_0x473b09['ok']?_0x487a71(0x250):await _0x473b09[_0x487a71(0x1c8)]();loggerService_1[_0x487a71(0x1ef)][_0x487a71(0x239)](_0x104bb9['shopId'],_0x1c0b5a[_0x487a71(0x23f)],_0x57bca2,_0x473b09[_0x487a71(0x1b8)],_0x154ba3,_0x4f21d9),console[_0x487a71(0x255)]('Shop\x20webhook\x20sent\x20to\x20'+_0x1c0b5a[_0x487a71(0x23f)]+_0x487a71(0x1c0)+_0x473b09[_0x487a71(0x1b8)]+'\x20('+_0x154ba3+_0x487a71(0x24b));}catch(_0x2e5f75){console[_0x487a71(0x228)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x2e5f75),loggerService_1[_0x487a71(0x1ef)][_0x487a71(0x218)](_0x104bb9[_0x487a71(0x225)],_0x104bb9[_0x487a71(0x234)]?.[_0x487a71(0x1c1)]?.['webhookUrl']||_0x487a71(0x213),'webhook_send',_0x2e5f75,{});}}async['sendPaymentStatusNotification'](_0x43a851,_0x322de6){const _0xa315f9=a37_0xab28d8;try{const _0x242ed6={'PENDING':'created','PAID':_0xa315f9(0x223),'FAILED':_0xa315f9(0x1e3),'EXPIRED':_0xa315f9(0x214)},_0x40a5e1=_0x242ed6[_0x322de6];if(!_0x40a5e1||_0x40a5e1===_0xa315f9(0x263))return;await telegramBotService_1[_0xa315f9(0x1d4)]['sendPaymentNotification'](_0x43a851[_0xa315f9(0x225)],_0x43a851,_0x40a5e1);}catch(_0x1a38ff){console[_0xa315f9(0x228)](_0xa315f9(0x1fd),_0x1a38ff);}}async[a37_0xab28d8(0x226)](_0x56e8d4){const _0x3c440f=a37_0xab28d8;console[_0x3c440f(0x255)]('🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x56e8d4);const _0x31d739=await database_1[_0x3c440f(0x230)][_0x3c440f(0x1e2)][_0x3c440f(0x180)]({'where':{'id':_0x56e8d4},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x31d739)throw new Error('Payment\x20not\x20found');if(_0x31d739[_0x3c440f(0x217)]!==_0x3c440f(0x25e))throw new Error(_0x3c440f(0x1b1));console[_0x3c440f(0x255)](_0x3c440f(0x194)+_0x56e8d4),await this[_0x3c440f(0x183)](_0x31d739),console[_0x3c440f(0x255)](_0x3c440f(0x198)+_0x56e8d4);}[a37_0xab28d8(0x1ee)](){const _0x1f3990=a37_0xab28d8,_0x4c8e7d=this[_0x1f3990(0x266)]?this[_0x1f3990(0x1f8)]:undefined,_0x1b9d6f=Array[_0x1f3990(0x232)](this['paymentTimers']['values']())[_0x1f3990(0x1b9)](_0x286653=>({'paymentId':_0x286653[_0x1f3990(0x20b)],'gatewayPaymentId':_0x286653[_0x1f3990(0x1a8)],'createdAt':_0x286653[_0x1f3990(0x21b)],'timersCount':_0x286653[_0x1f3990(0x19d)][_0x1f3990(0x1b3)]}));return{'isActive':!!this[_0x1f3990(0x266)],'globalCheckIntervalMinutes':this[_0x1f3990(0x1f8)]/(0x3e8*0x3c),'expiryDays':this[_0x1f3990(0x1c2)],'activeIndividualTimers':this[_0x1f3990(0x1d3)]['size'],'nextGlobalCheckIn':_0x4c8e7d,'paymentTimersDetails':_0x1b9d6f};}[a37_0xab28d8(0x1ab)](_0x15113b){const _0x29b2c9=a37_0xab28d8,_0x21d565=this[_0x29b2c9(0x1d3)][_0x29b2c9(0x18b)](_0x15113b);if(_0x21d565)return{'hasTimers':!![],'timersCount':_0x21d565['timers'][_0x29b2c9(0x1b3)],'createdAt':_0x21d565[_0x29b2c9(0x21b)],'gatewayPaymentId':_0x21d565[_0x29b2c9(0x1a8)]};return{'hasTimers':![]};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a37_0xab28d8(0x1a9)]=new CoinToPayStatusService();function a37_0x5256(){const _0x3977f9=['🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','./loggerService','application/json','customerEmail','\x20with\x20status\x20','settings','EXPIRY_DAYS','__importDefault','stopPeriodicStatusCheck','6070113ziSDOP','2\x20minutes','coinToPayService','text','includes','logCoinToPayError','toISOString','stringify','EXPIRED','message','findMany','update','\x20status\x20changed\x20to\x20','8538mqrduA','paymentTimers','telegramBotService','\x20is\x20valid\x20for\x20checking,\x20proceeding...','payment.success','\x20status\x20unchanged\x20(','set','\x20status\x20from\x20','✅\x20[HOURLY]\x20Payment\x20','schedule_created','size','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','🪙\x20[DEBUG]\x20Creating\x20','CoinToPayStatusService','confirmedOn','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','payment','failed','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20updated\x20successfully','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','13358QETesU','__esModule','getDate','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','floor','CoinToPayService','174NCxSaj','getServiceStats','loggerService','\x20\x20\x20📅\x20Time:\x20','checkExpiredPayments','🪙\x20CoinToPayStatusService\x20initialized','\x20\x20\x20📝\x20Details:','\x20has\x20no\x20gatewayPaymentId','adminNotes','\x20\x20\x20❌\x20Error:\x20','PENDING','GLOBAL_CHECK_INTERVAL_MS','description','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20marked\x20as\x20paid\x20at:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','Webhook\x20event\x20','customerName','/status/','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','webhookEvents','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','status_check','📊\x20[CHECK]\x20Payment\x20','sendShopWebhook','\x20\x20\x20-\x20Status:\x20','0100','checkSinglePaymentById','paymentId','🪙\x20[GLOBAL]\x20Found\x20','\x20details:','\x20\x20\x20-\x20Gateway:\x20','⚠️\x20[CHECK]\x20Payment\x20','\x20seconds\x20(','startPeriodicStatusCheck','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','unknown','expired','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20not\x20found\x20in\x20database','gateway','logShopWebhookError','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','not\x20confirmed','createdAt','push','\x20(age:\x20','logCoinToPayStatus','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20completed\x20for\x20payment\x20','542313CAmGtK','currency','paid','forEach','shopId','checkPaymentById','transactionId','error','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','cointopay_status_check_',',\x20clearing\x20individual\x20timers','bankDetails','paymentDetails','\x20\x20\x20📍\x20Source:\x20','5710wfyhzX','default','remitterIban','from','\x20found:','shop','webhookLog','iban','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','PAID','logShopWebhookSent','\x20\x20\x20📊\x20Status:\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20to\x20','../config/database','\x20in\x20','webhookUrl','has','cointopay_status_check_error','\x20skipped,\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','./gateways/coinToPayService','auto_expire','now','✅\x20[EXPIRY]\x20Payment\x20','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','create','gatewayOrderId','ms)','\x20days','\x20to\x20clear','./telegramBotService','\x20\x20\x20-\x20ShopId:\x20','Success','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','✅\x20[CHECK]\x20Payment\x20','🧹\x20[DEBUG]\x20Clearing\x20','\x20status:\x20','log','toFixed','\x20expired','COINTOPAY_ERROR','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','\x20expired\x20CoinToPay\x20payments','logWhiteDomainError','3510tdYsTy','amount','cointopay','❌\x20[HOURLY]\x20Payment\x20','delay','🧹\x20[CHECK]\x20Payment\x20','POST','created','\x20is\x20older\x20than\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','globalCheckInterval','paidAt','getTime','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','49071EphbOB','timestamp','⏰\x20[GLOBAL]\x20Payment\x20','36OhGHeV','findUnique','toLowerCase','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','checkSinglePayment','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','.\x20Remaining\x20active\x20timers:\x20','createdOn','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','setDate',',\x20stopping\x20individual\x20checks','Bank\x20Details:\x20','get','Unknown\x20error','Payment\x20older\x20than\x20','checkAllPendingPayments','150024TKHYvQ','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','⏰\x20[HOURLY]\x20Payment\x20','schedulePaymentChecks','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','cointopay_auto_expired','\x20\x20\x20-\x20Amount:\x20','\x20days\x20(created\x20before\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','⏰\x20[EXPIRY]\x20Payment\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20initial\x20timers\x20for\x20payment\x20','\x20(after\x20','timers','FAILED','\x20for\x20payment\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','stack','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','checkPaymentStatus','5\x20minutes','not\x20found','\x20not\x20found,\x20clearing\x20timers','gatewayPaymentId','coinToPayStatusService','delete','getPaymentTimerInfo','h),\x20skipping\x20global\x20check','TesSoft\x20Payment\x20System/1.0','\x20triggered\x20for\x20payment\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','clearPaymentTimers','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','catch','length','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','COINTOPAY_STATUS_CHANGE','\x20individual\x20payment\x20timers','status','map','🛑\x20[SHUTDOWN]\x20Cleared\x20','5668740quINQi'];a37_0x5256=function(){return _0x3977f9;};return a37_0x5256();}