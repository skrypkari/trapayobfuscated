'use strict';function a35_0x27f8(){const _0xc66010=['\x20initial\x20timers\x20for\x20payment\x20','transactionId','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','application/json','\x20not\x20found,\x20clearing\x20timers','\x20for\x20payment\x20','Shop\x20webhook\x20sent\x20to\x20','\x20expired','788053xBgVRr','stack','EXPIRY_DAYS','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20has\x20no\x20gatewayPaymentId','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','Success','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','../config/database','\x20\x20\x20üìù\x20Context:','payment','\x20is\x20older\x20than\x20','description','TesSoft\x20Payment\x20System/1.0','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','findMany','2\x20minutes','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20status\x20changed\x20to\x20','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','./loggerService','auto_expire','üßπ\x20[CHECK]\x20Payment\x20','gatewayOrderId','loggerService','toISOString','PAID','1\x20minute','Unknown\x20error','sendShopWebhook','webhookLog','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','paymentId','paymentTimers','shopId','adminNotes','logCoinToPayError','gatewayPaymentId','üìä\x20[CHECK]\x20Payment\x20','error','\x20is\x20too\x20new\x20(','catch','message','checkExpiredPayments','remitterIban','stringify','not\x20found','timestamp','\x20\x20\x20-\x20Status:\x20','customerEmail','createdAt','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','text','floor','‚è∞\x20[HOURLY]\x20Payment\x20','amount','telegramBotService','Automatically\x20expired\x20after\x20','733509dLADJJ','currency','\x20days,\x20marking\x20as\x20EXPIRED','\x20seconds\x20(','length','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','confirmedOn','gateway',',\x20stopping\x20individual\x20checks','\x20\x20\x20‚ùå\x20Error:\x20','FAILED','5475qSdtRm','toLowerCase','\x20\x20\x20-\x20paymentId:\x20','\x20\x20\x20üìç\x20Source:\x20','\x20pending\x20CoinToPay\x20payments','\x20status\x20from\x20','\x20to\x20clear','‚úÖ\x20[EXPIRY]\x20Payment\x20','ü™ô\x20[DEBUG]\x20Creating\x20','payment.pending','\x20completed\x20for\x20payment\x20','delay','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','6tnTLip','ü™ô\x20CoinToPayStatusService\x20initialized','üí∞\x20[CHECK]\x20Payment\x20','logShopWebhookError','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','logShopWebhookSent','ü™ô\x20[GLOBAL]\x20Found\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','delete','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20current\x20status:\x20','paidAt','now','POST','CoinToPayStatusService','\x20updated\x20successfully','paid','‚úÖ\x20[HOURLY]\x20Payment\x20','getTime','webhook_send','\x20details:','Payment\x20not\x20found','getPaymentTimerInfo','\x20checked,\x20','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','\x20expired\x20CoinToPay\x20payments','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20marked\x20as\x20paid\x20at:\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','__importDefault','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','checkSinglePaymentById','paymentDetails','sendPaymentStatusNotification','status_check','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','bankDetails','444ynqHYp','./gateways/coinToPayService','1308810bfMqlL','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','created','toFixed','settings','EXPIRED','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','defineProperty','PENDING','clearPaymentTimers','\x20timers\x20for\x20payment\x20','\x20individual\x20payment\x20timers','\x20\x20\x20-\x20gatewayPaymentId:\x20','webhookUrl','\x20\x20\x20üìä\x20Status:\x20','\x20->\x20','./telegramBotService','default','9393791RwDrQI','push','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','size','Failed\x20to\x20mark\x20payment\x20as\x20expired','get','coinToPayStatusService','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','‚ùå\x20[HOURLY]\x20Payment\x20','checkPaymentStatus','\x20days\x20(created\x20before\x20','payment.failed','schedulePaymentChecks','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','status','coinToPayService','0100','log','timers','2263374qcwNty','Bank\x20Details:\x20','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','\x20\x20\x20üìÖ\x20Time:\x20','set','setDate','expired','__esModule','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','not\x20confirmed','createdOn','\x20found:','findUnique','8bIDDUb','orderId','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20\x20\x20-\x20Gateway:\x20','cointopay_status_check_','update','Payment\x20older\x20than\x20','create','\x20has\x20no\x20gatewayPaymentId,\x20skipping','‚è∞\x20[GLOBAL]\x20Found\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','globalCheckInterval','\x20skipped,\x20','\x20\x20\x20-\x20ShopId:\x20','logCoinToPayStatus','\x20days','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','sendPaymentNotification','payment.success','5\x20minutes','COINTOPAY_STATUS_CHANGE','\x20triggered\x20for\x20payment\x20','2Gjbfdk','includes','-day\x20timeout','\x20(age:\x20','ms)',',\x20clearing\x20individual\x20timers','iban','‚è∞\x20[GLOBAL]\x20Payment\x20','schedule_created','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','12hbwirG','\x20status\x20is\x20','10VxZQwO','17369664sioRPJ','\x20to\x20','\x20days\x20without\x20payment\x20confirmation','unknown','\x20with\x20status\x20','shop','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','‚úÖ\x20[CHECK]\x20Payment\x20','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20status:\x20','map','checkSinglePayment','checkAllPendingPayments','cointopay','GLOBAL_CHECK_INTERVAL_MS'];a35_0x27f8=function(){return _0xc66010;};return a35_0x27f8();}function a35_0x33c5(_0x3b1040,_0x4f51){const _0x27f82d=a35_0x27f8();return a35_0x33c5=function(_0x33c5b5,_0x16bf46){_0x33c5b5=_0x33c5b5-0x1d9;let _0x5e68ea=_0x27f82d[_0x33c5b5];return _0x5e68ea;},a35_0x33c5(_0x3b1040,_0x4f51);}const a35_0x47bf1c=a35_0x33c5;(function(_0x2f2edf,_0x32ba9a){const _0xfa700d=a35_0x33c5,_0x224e34=_0x2f2edf();while(!![]){try{const _0x2df920=parseInt(_0xfa700d(0x2b1))/0x1*(parseInt(_0xfa700d(0x251))/0x2)+parseInt(_0xfa700d(0x207))/0x3+parseInt(_0xfa700d(0x205))/0x4*(-parseInt(_0xfa700d(0x2bc))/0x5)+parseInt(_0xfa700d(0x1dd))/0x6*(parseInt(_0xfa700d(0x275))/0x7)+-parseInt(_0xfa700d(0x23b))/0x8*(parseInt(_0xfa700d(0x22e))/0x9)+parseInt(_0xfa700d(0x25d))/0xa*(parseInt(_0xfa700d(0x21a))/0xb)+-parseInt(_0xfa700d(0x25b))/0xc*(parseInt(_0xfa700d(0x25e))/0xd);if(_0x2df920===_0x32ba9a)break;else _0x224e34['push'](_0x224e34['shift']());}catch(_0x145934){_0x224e34['push'](_0x224e34['shift']());}}}(a35_0x27f8,0x684ac));var __importDefault=this&&this[a35_0x47bf1c(0x1fc)]||function(_0x50bc2a){const _0x49f47f=a35_0x47bf1c;return _0x50bc2a&&_0x50bc2a[_0x49f47f(0x235)]?_0x50bc2a:{'default':_0x50bc2a};};Object[a35_0x47bf1c(0x20f)](exports,a35_0x47bf1c(0x235),{'value':!![]}),exports[a35_0x47bf1c(0x221)]=exports[a35_0x47bf1c(0x1eb)]=void 0x0;const coinToPayService_1=require(a35_0x47bf1c(0x206)),database_1=__importDefault(require(a35_0x47bf1c(0x27d))),telegramBotService_1=require(a35_0x47bf1c(0x218)),loggerService_1=require(a35_0x47bf1c(0x28b));class CoinToPayStatusService{constructor(){const _0x2aef9a=a35_0x47bf1c;this['globalCheckInterval']=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x2aef9a(0x298)]=new Map(),this[_0x2aef9a(0x22a)]=new coinToPayService_1['CoinToPayService'](),console[_0x2aef9a(0x22c)](_0x2aef9a(0x1de));}[a35_0x47bf1c(0x227)](_0x2490f9,_0xe0d3a7){const _0x4d8450=a35_0x47bf1c;console['log'](_0x4d8450(0x203)),console[_0x4d8450(0x22c)](_0x4d8450(0x2be)+_0x2490f9),console[_0x4d8450(0x22c)](_0x4d8450(0x214)+_0xe0d3a7),this[_0x4d8450(0x211)](_0x2490f9);const _0xe856f=[],_0x5b678e=new Date(),_0x1b16b8=[{'delay':0x1*0x3c*0x3e8,'description':_0x4d8450(0x292)},{'delay':0x2*0x3c*0x3e8,'description':_0x4d8450(0x286)},{'delay':0x5*0x3c*0x3e8,'description':_0x4d8450(0x24e)},{'delay':0x5*0x3c*0x3e8,'description':_0x4d8450(0x24e)}];console[_0x4d8450(0x22c)](_0x4d8450(0x2c4)+_0x1b16b8[_0x4d8450(0x2b5)]+_0x4d8450(0x26d)+_0x2490f9);let _0x59ef02=0x0;_0x1b16b8['forEach']((_0x15c38b,_0x5961b5)=>{const _0x1b7299=_0x4d8450;_0x59ef02+=_0x15c38b['delay'];const _0x17b401=setTimeout(async()=>{const _0xee4da8=a35_0x33c5;console[_0xee4da8(0x22c)](_0xee4da8(0x1e1)+(_0x5961b5+0x1)+_0xee4da8(0x250)+_0x2490f9+'\x20(after\x20'+_0x15c38b[_0xee4da8(0x281)]+')');try{await this[_0xee4da8(0x1fe)](_0x2490f9),console[_0xee4da8(0x22c)](_0xee4da8(0x1f5)+(_0x5961b5+0x1)+_0xee4da8(0x1da)+_0x2490f9);}catch(_0x303a59){console['error']('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x5961b5+0x1)+_0xee4da8(0x272)+_0x2490f9+':',_0x303a59),this[_0xee4da8(0x29b)](_0x2490f9,_0xe0d3a7,_0x303a59,_0xee4da8(0x201),{'checkNumber':_0x5961b5+0x1,'scheduledAfter':_0x15c38b['description'],'isIndividualCheck':!![]});}},_0x59ef02);_0xe856f[_0x1b7299(0x21b)](_0x17b401),console[_0x1b7299(0x22c)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x5961b5+0x1)+_0x1b7299(0x272)+_0x2490f9+'\x20in\x20'+_0x59ef02/0x3e8+_0x1b7299(0x2b4)+_0x15c38b[_0x1b7299(0x281)]+')');});const _0x17ab15=setInterval(async()=>{const _0x17e41a=_0x4d8450;console[_0x17e41a(0x22c)](_0x17e41a(0x284)+_0x2490f9);try{const _0x5be561=await database_1[_0x17e41a(0x219)][_0x17e41a(0x27f)][_0x17e41a(0x23a)]({'where':{'id':_0x2490f9},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x5be561){console[_0x17e41a(0x22c)](_0x17e41a(0x223)+_0x2490f9+_0x17e41a(0x271)),this[_0x17e41a(0x211)](_0x2490f9);return;}console[_0x17e41a(0x22c)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x2490f9+_0x17e41a(0x1e7)+_0x5be561[_0x17e41a(0x229)]);if(_0x5be561[_0x17e41a(0x229)]!==_0x17e41a(0x210)){console['log'](_0x17e41a(0x1ee)+_0x2490f9+_0x17e41a(0x25c)+_0x5be561[_0x17e41a(0x229)]+',\x20stopping\x20individual\x20checks'),this['clearPaymentTimers'](_0x2490f9);return;}const _0x40b992=Math[_0x17e41a(0x2ac)]((Date[_0x17e41a(0x1e9)]()-_0x5be561['createdAt'][_0x17e41a(0x1ef)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x40b992>=this['EXPIRY_DAYS']){console[_0x17e41a(0x22c)](_0x17e41a(0x2ad)+_0x2490f9+_0x17e41a(0x280)+this[_0x17e41a(0x277)]+_0x17e41a(0x1f7)),this[_0x17e41a(0x211)](_0x2490f9);return;}await this['checkSinglePaymentById'](_0x2490f9),console[_0x17e41a(0x22c)](_0x17e41a(0x24b)+_0x2490f9);}catch(_0xfa147e){console[_0x17e41a(0x29e)](_0x17e41a(0x2b6)+_0x2490f9+':',_0xfa147e),this[_0x17e41a(0x29b)](_0x2490f9,_0xe0d3a7,_0xfa147e,_0x17e41a(0x201),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0xe856f[_0x4d8450(0x21b)](_0x17ab15),this['paymentTimers'][_0x4d8450(0x232)](_0x2490f9,{'timers':_0xe856f,'paymentId':_0x2490f9,'gatewayPaymentId':_0xe0d3a7,'createdAt':_0x5b678e}),console[_0x4d8450(0x22c)](_0x4d8450(0x1f9)+_0x1b16b8['length']+_0x4d8450(0x228)+_0x2490f9),console[_0x4d8450(0x22c)]('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x4d8450(0x298)][_0x4d8450(0x21e)]),this[_0x4d8450(0x249)](_0x2490f9,_0xe0d3a7,_0x4d8450(0x210),'PENDING',_0x4d8450(0x201),{'action':_0x4d8450(0x259),'scheduledChecks':_0x1b16b8[_0x4d8450(0x2b5)],'firstCheckIn':_0x1b16b8[0x0][_0x4d8450(0x1db)]/0x3e8,'totalTimers':this[_0x4d8450(0x298)][_0x4d8450(0x21e)]});}[a35_0x47bf1c(0x211)](_0x19045f){const _0x85a9f7=a35_0x47bf1c,_0x188c41=this[_0x85a9f7(0x298)]['get'](_0x19045f);_0x188c41?(console[_0x85a9f7(0x22c)]('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x188c41[_0x85a9f7(0x22d)][_0x85a9f7(0x2b5)]+_0x85a9f7(0x212)+_0x19045f),_0x188c41[_0x85a9f7(0x22d)]['forEach']((_0x49cf9e,_0x35fec7)=>{const _0x2d6c1b=_0x85a9f7;_0x49cf9e&&(clearTimeout(_0x49cf9e),clearInterval(_0x49cf9e),console['log'](_0x2d6c1b(0x1dc)+(_0x35fec7+0x1)+_0x2d6c1b(0x272)+_0x19045f));}),this[_0x85a9f7(0x298)][_0x85a9f7(0x1e5)](_0x19045f),console['log'](_0x85a9f7(0x289)+_0x19045f+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x85a9f7(0x298)]['size'])):console['log'](_0x85a9f7(0x23d)+_0x19045f+_0x85a9f7(0x2c2));}async['checkSinglePaymentById'](_0x44b69f){const _0x3457d0=a35_0x47bf1c;console['log'](_0x3457d0(0x296)+_0x44b69f);const _0x420c55=await database_1[_0x3457d0(0x219)]['payment']['findUnique']({'where':{'id':_0x44b69f},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x420c55){console[_0x3457d0(0x22c)]('‚ùå\x20[CHECK]\x20Payment\x20'+_0x44b69f+'\x20not\x20found\x20in\x20database');return;}console[_0x3457d0(0x22c)](_0x3457d0(0x29d)+_0x44b69f+_0x3457d0(0x239)),console[_0x3457d0(0x22c)](_0x3457d0(0x23e)+_0x420c55[_0x3457d0(0x2b8)]),console['log'](_0x3457d0(0x2a7)+_0x420c55['status']),console[_0x3457d0(0x22c)](_0x3457d0(0x1fb)+_0x420c55[_0x3457d0(0x29c)]),console[_0x3457d0(0x22c)]('\x20\x20\x20-\x20Amount:\x20'+_0x420c55[_0x3457d0(0x2ae)]+'\x20'+_0x420c55[_0x3457d0(0x2b2)]),console['log'](_0x3457d0(0x248)+_0x420c55[_0x3457d0(0x299)]);if(_0x420c55[_0x3457d0(0x2b8)]!==_0x3457d0(0x26b)){console[_0x3457d0(0x22c)](_0x3457d0(0x208)+_0x44b69f+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x420c55[_0x3457d0(0x2b8)]+')');return;}if(_0x420c55[_0x3457d0(0x229)]!=='PENDING'){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x44b69f+_0x3457d0(0x25c)+_0x420c55[_0x3457d0(0x229)]+_0x3457d0(0x2b9)),this[_0x3457d0(0x211)](_0x44b69f);return;}if(!_0x420c55['gatewayPaymentId']){console['log'](_0x3457d0(0x208)+_0x44b69f+_0x3457d0(0x279));return;}console[_0x3457d0(0x22c)](_0x3457d0(0x265)+_0x44b69f+_0x3457d0(0x278)),await this[_0x3457d0(0x269)](_0x420c55);}[a35_0x47bf1c(0x249)](_0x4bd502,_0xc92562,_0x2fa8e5,_0x2d0282,_0x2a619a,_0x2b7002){const _0x5dcca4=a35_0x47bf1c,_0xa2d6f0={'type':_0x5dcca4(0x24f),'paymentId':_0x4bd502,'gatewayPaymentId':_0xc92562,'oldStatus':_0x2fa8e5,'newStatus':_0x2d0282,'source':_0x2a619a,'timestamp':new Date()[_0x5dcca4(0x290)](),'details':_0x2b7002||{}};loggerService_1[_0x5dcca4(0x28f)]['logCoinToPayStatus'](_0xa2d6f0),console[_0x5dcca4(0x22c)]('ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x4bd502+'\x20('+_0xc92562+')'),console['log'](_0x5dcca4(0x216)+_0x2fa8e5+_0x5dcca4(0x217)+_0x2d0282),console['log'](_0x5dcca4(0x2bf)+_0x2a619a),console['log'](_0x5dcca4(0x231)+_0xa2d6f0[_0x5dcca4(0x2a6)]),_0x2b7002&&console[_0x5dcca4(0x22c)]('\x20\x20\x20üìù\x20Details:',_0x2b7002);}[a35_0x47bf1c(0x29b)](_0x2934bb,_0x5673ec,_0x3c6a63,_0x3b82ce,_0x2e02d2){const _0x5ec691=a35_0x47bf1c,_0x38f48f={'type':'COINTOPAY_ERROR','paymentId':_0x2934bb,'gatewayPaymentId':_0x5673ec,'error':_0x3c6a63 instanceof Error?{'message':_0x3c6a63[_0x5ec691(0x2a1)],'stack':_0x3c6a63[_0x5ec691(0x276)]}:_0x3c6a63,'source':_0x3b82ce,'timestamp':new Date()[_0x5ec691(0x290)](),'context':_0x2e02d2||{}};loggerService_1[_0x5ec691(0x28f)][_0x5ec691(0x29b)](_0x38f48f),console[_0x5ec691(0x29e)]('ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x2934bb+'\x20('+_0x5673ec+')'),console['error'](_0x5ec691(0x2ba)+(_0x3c6a63 instanceof Error?_0x3c6a63[_0x5ec691(0x2a1)]:_0x3c6a63)),console[_0x5ec691(0x29e)](_0x5ec691(0x2bf)+_0x3b82ce),console['error'](_0x5ec691(0x231)+_0x38f48f[_0x5ec691(0x2a6)]),_0x2e02d2&&console[_0x5ec691(0x29e)](_0x5ec691(0x27e),_0x2e02d2);}['startPeriodicStatusCheck'](){const _0x30e356=a35_0x47bf1c;console['log']('ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x30e356(0x26a)]()[_0x30e356(0x2a0)](_0xd46fd7=>{const _0x37d5da=_0x30e356;console[_0x37d5da(0x29e)](_0x37d5da(0x21d),_0xd46fd7);}),this[_0x30e356(0x246)]=setInterval(async()=>{const _0x30b16b=_0x30e356;try{console[_0x30b16b(0x22c)](_0x30b16b(0x27a)),await this['checkAllPendingPayments'](),console[_0x30b16b(0x22c)](_0x30b16b(0x283));}catch(_0x259c9a){console[_0x30b16b(0x29e)](_0x30b16b(0x21c),_0x259c9a);}},this[_0x30e356(0x26c)]),console['log'](_0x30e356(0x264));}['stopPeriodicStatusCheck'](){const _0x4e074c=a35_0x47bf1c;console['log'](_0x4e074c(0x1fd));this[_0x4e074c(0x246)]&&(clearInterval(this[_0x4e074c(0x246)]),this['globalCheckInterval']=null,console[_0x4e074c(0x22c)](_0x4e074c(0x1e6)));const _0x5e1b47=this[_0x4e074c(0x298)][_0x4e074c(0x21e)];for(const [_0x232968]of this[_0x4e074c(0x298)]){this[_0x4e074c(0x211)](_0x232968);}console['log']('üõë\x20[SHUTDOWN]\x20Cleared\x20'+_0x5e1b47+_0x4e074c(0x213));}async[a35_0x47bf1c(0x26a)](){const _0x5d0eb4=a35_0x47bf1c;try{console['log'](_0x5d0eb4(0x236));const _0x580d85=await database_1[_0x5d0eb4(0x219)]['payment'][_0x5d0eb4(0x285)]({'where':{'gateway':_0x5d0eb4(0x26b),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x5d0eb4(0x22c)](_0x5d0eb4(0x1e3)+_0x580d85[_0x5d0eb4(0x2b5)]+_0x5d0eb4(0x2c0));if(_0x580d85[_0x5d0eb4(0x2b5)]===0x0){console[_0x5d0eb4(0x22c)](_0x5d0eb4(0x266));return;}const _0x3280b5=await this[_0x5d0eb4(0x2a2)](_0x580d85);console['log'](_0x5d0eb4(0x244)+_0x3280b5[_0x5d0eb4(0x2b5)]+_0x5d0eb4(0x1f6));let _0x2fa8f1=0x0,_0x48e120=0x0;for(const _0x5c3e57 of _0x580d85){try{if(_0x3280b5['includes'](_0x5c3e57['id'])){console[_0x5d0eb4(0x22c)](_0x5d0eb4(0x258)+_0x5c3e57['id']+_0x5d0eb4(0x2aa)),_0x48e120++;continue;}if(this[_0x5d0eb4(0x298)]['has'](_0x5c3e57['id'])){console['log'](_0x5d0eb4(0x258)+_0x5c3e57['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x48e120++;continue;}const _0xc06fbd=(Date[_0x5d0eb4(0x1e9)]()-_0x5c3e57['createdAt']['getTime']())/(0x3e8*0x3c*0x3c);if(_0xc06fbd<0x1){console[_0x5d0eb4(0x22c)](_0x5d0eb4(0x258)+_0x5c3e57['id']+_0x5d0eb4(0x29f)+_0xc06fbd[_0x5d0eb4(0x20b)](0x1)+'h),\x20skipping\x20global\x20check'),_0x48e120++;continue;}console['log'](_0x5d0eb4(0x26f)+_0x5c3e57['id']+_0x5d0eb4(0x254)+_0xc06fbd[_0x5d0eb4(0x20b)](0x1)+'h)'),await this[_0x5d0eb4(0x269)](_0x5c3e57),_0x2fa8f1++,await new Promise(_0x238886=>setTimeout(_0x238886,0x7d0));}catch(_0x53bdcb){console[_0x5d0eb4(0x29e)](_0x5d0eb4(0x28a)+_0x5c3e57['id']+':',_0x53bdcb),this['logCoinToPayError'](_0x5c3e57['id'],_0x5c3e57['gatewayPaymentId']||_0x5d0eb4(0x261),_0x53bdcb,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x5c3e57[_0x5d0eb4(0x2ae)],'paymentCurrency':_0x5c3e57[_0x5d0eb4(0x2b2)],'shopId':_0x5c3e57[_0x5d0eb4(0x299)],'createdAt':_0x5c3e57[_0x5d0eb4(0x2a9)]}),loggerService_1['loggerService']['logWhiteDomainError'](_0x5d0eb4(0x26b),'/status/'+_0x5c3e57[_0x5d0eb4(0x29c)],_0x53bdcb);}}console[_0x5d0eb4(0x22c)](_0x5d0eb4(0x27c)+_0x2fa8f1+_0x5d0eb4(0x1f4)+_0x48e120+_0x5d0eb4(0x247)+_0x3280b5[_0x5d0eb4(0x2b5)]+_0x5d0eb4(0x274));}catch(_0x2b55d4){console[_0x5d0eb4(0x29e)](_0x5d0eb4(0x245),_0x2b55d4);}}async[a35_0x47bf1c(0x2a2)](_0x8bbbfe){const _0x39350f=a35_0x47bf1c,_0x502ab9=[],_0x3b4cfc=new Date();_0x3b4cfc[_0x39350f(0x233)](_0x3b4cfc['getDate']()-this[_0x39350f(0x277)]),console[_0x39350f(0x22c)]('‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x39350f(0x277)]+_0x39350f(0x225)+_0x3b4cfc[_0x39350f(0x290)]()+')');for(const _0xfaafe1 of _0x8bbbfe){if(_0xfaafe1['createdAt']<_0x3b4cfc){console[_0x39350f(0x22c)](_0x39350f(0x209)+_0xfaafe1['id']+_0x39350f(0x280)+this[_0x39350f(0x277)]+_0x39350f(0x2b3));try{this['logCoinToPayStatus'](_0xfaafe1['id'],_0xfaafe1[_0x39350f(0x29c)]||_0x39350f(0x261),'PENDING',_0x39350f(0x20d),_0x39350f(0x28c),{'reason':_0x39350f(0x241)+this['EXPIRY_DAYS']+_0x39350f(0x24a),'createdAt':_0xfaafe1['createdAt'],'daysSinceCreation':Math[_0x39350f(0x2ac)]((Date[_0x39350f(0x1e9)]()-_0xfaafe1['createdAt'][_0x39350f(0x1ef)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0xfaafe1['amount'],'paymentCurrency':_0xfaafe1[_0x39350f(0x2b2)],'shopId':_0xfaafe1['shopId']}),await database_1[_0x39350f(0x219)][_0x39350f(0x27f)][_0x39350f(0x240)]({'where':{'id':_0xfaafe1['id']},'data':{'status':_0x39350f(0x20d),'updatedAt':new Date(),'adminNotes':_0x39350f(0x2b0)+this[_0x39350f(0x277)]+_0x39350f(0x260)}}),await database_1[_0x39350f(0x219)][_0x39350f(0x295)]['create']({'data':{'paymentId':_0xfaafe1['id'],'shopId':_0xfaafe1[_0x39350f(0x299)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x39350f(0x2a4)]({'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x39350f(0x24a),'createdAt':_0xfaafe1[_0x39350f(0x2a9)],'expiredAt':new Date()[_0x39350f(0x290)](),'daysSinceCreation':Math[_0x39350f(0x2ac)]((Date[_0x39350f(0x1e9)]()-_0xfaafe1['createdAt'][_0x39350f(0x1ef)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x39350f(0x294)](_0xfaafe1,_0x39350f(0x20d)),await this[_0x39350f(0x200)](_0xfaafe1,_0x39350f(0x20d)),this['clearPaymentTimers'](_0xfaafe1['id']),_0x502ab9[_0x39350f(0x21b)](_0xfaafe1['id']),console[_0x39350f(0x22c)](_0x39350f(0x2c3)+_0xfaafe1['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x39350f(0x277)]+_0x39350f(0x253));}catch(_0x31f028){console[_0x39350f(0x29e)]('‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0xfaafe1['id']+':',_0x31f028),this[_0x39350f(0x29b)](_0xfaafe1['id'],_0xfaafe1[_0x39350f(0x29c)]||_0x39350f(0x261),_0x31f028,_0x39350f(0x28c),{'reason':_0x39350f(0x21f),'createdAt':_0xfaafe1[_0x39350f(0x2a9)],'daysSinceCreation':Math[_0x39350f(0x2ac)]((Date['now']()-_0xfaafe1[_0x39350f(0x2a9)][_0x39350f(0x1ef)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x502ab9;}async[a35_0x47bf1c(0x269)](_0x39aa7c){const _0x4304a6=a35_0x47bf1c;if(!_0x39aa7c['gatewayPaymentId']){console['log'](_0x4304a6(0x208)+_0x39aa7c['id']+_0x4304a6(0x243));return;}console['log'](_0x4304a6(0x202)+_0x39aa7c['id']+'\x20('+_0x39aa7c['gatewayPaymentId']+')');try{const _0x4f6230=await this[_0x4304a6(0x22a)][_0x4304a6(0x224)](_0x39aa7c['gatewayPaymentId']);console[_0x4304a6(0x22c)]('üìä\x20[CHECK]\x20Payment\x20'+_0x39aa7c['id']+_0x4304a6(0x267)+_0x4f6230[_0x4304a6(0x229)]);_0x4f6230[_0x4304a6(0x1ff)]&&console['log'](_0x4304a6(0x29d)+_0x39aa7c['id']+_0x4304a6(0x1f1),{'iban':_0x4f6230[_0x4304a6(0x1ff)][_0x4304a6(0x257)]||_0x4304a6(0x2a5),'transactionId':_0x4f6230['paymentDetails'][_0x4304a6(0x26e)],'createdOn':_0x4f6230[_0x4304a6(0x1ff)][_0x4304a6(0x238)],'confirmedOn':_0x4f6230[_0x4304a6(0x1ff)][_0x4304a6(0x2b7)]||_0x4304a6(0x237)});if(_0x4f6230[_0x4304a6(0x229)]!==_0x39aa7c[_0x4304a6(0x229)]){console[_0x4304a6(0x22c)](_0x4304a6(0x230)+_0x39aa7c['id']+_0x4304a6(0x2c1)+_0x39aa7c[_0x4304a6(0x229)]+_0x4304a6(0x25f)+_0x4f6230[_0x4304a6(0x229)]),this[_0x4304a6(0x249)](_0x39aa7c['id'],_0x39aa7c['gatewayPaymentId'],_0x39aa7c[_0x4304a6(0x229)],_0x4f6230[_0x4304a6(0x229)],_0x4304a6(0x201),{'paymentDetails':_0x4f6230[_0x4304a6(0x1ff)],'amount':_0x4f6230['amount'],'currency':_0x4f6230['currency'],'shopId':_0x39aa7c[_0x4304a6(0x299)],'checkTimestamp':new Date()[_0x4304a6(0x290)]()});const _0xdb657e={'status':_0x4f6230['status'],'updatedAt':new Date()};_0x4f6230['status']===_0x4304a6(0x291)&&_0x39aa7c[_0x4304a6(0x229)]!==_0x4304a6(0x291)&&(_0xdb657e[_0x4304a6(0x1e8)]=new Date(),console[_0x4304a6(0x22c)](_0x4304a6(0x1df)+_0x39aa7c['id']+_0x4304a6(0x1fa)+_0xdb657e[_0x4304a6(0x1e8)][_0x4304a6(0x290)]()));if(_0x4f6230[_0x4304a6(0x1ff)]){const _0x2a0cdd=_0x4f6230['paymentDetails'];_0x2a0cdd[_0x4304a6(0x257)]&&(_0xdb657e[_0x4304a6(0x2a3)]=_0x2a0cdd[_0x4304a6(0x257)],console[_0x4304a6(0x22c)]('üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x2a0cdd['iban']));if(_0x2a0cdd[_0x4304a6(0x204)]){const _0x8ebe20=_0x39aa7c[_0x4304a6(0x29a)]||'',_0x2e1c00=_0x4304a6(0x22f)+_0x2a0cdd[_0x4304a6(0x204)];_0xdb657e[_0x4304a6(0x29a)]=_0x8ebe20?_0x8ebe20+'\x0a\x0a'+_0x2e1c00:_0x2e1c00,console[_0x4304a6(0x22c)](_0x4304a6(0x222));}_0x2a0cdd[_0x4304a6(0x26e)]&&console[_0x4304a6(0x22c)]('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x2a0cdd[_0x4304a6(0x26e)]),_0x2a0cdd[_0x4304a6(0x2b7)]&&console[_0x4304a6(0x22c)]('‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x2a0cdd['confirmedOn']);}await database_1[_0x4304a6(0x219)][_0x4304a6(0x27f)]['update']({'where':{'id':_0x39aa7c['id']},'data':_0xdb657e}),await database_1[_0x4304a6(0x219)][_0x4304a6(0x295)][_0x4304a6(0x242)]({'data':{'paymentId':_0x39aa7c['id'],'shopId':_0x39aa7c[_0x4304a6(0x299)],'event':_0x4304a6(0x23f)+_0x4f6230[_0x4304a6(0x229)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x4304a6(0x2a4)]({'oldStatus':_0x39aa7c['status'],'newStatus':_0x4f6230[_0x4304a6(0x229)],'paymentDetails':_0x4f6230[_0x4304a6(0x1ff)],'checkedAt':new Date()[_0x4304a6(0x290)]()})}}),await this['sendShopWebhook'](_0x39aa7c,_0x4f6230[_0x4304a6(0x229)]),await this[_0x4304a6(0x200)](_0x39aa7c,_0x4f6230[_0x4304a6(0x229)]),_0x4f6230['status']!==_0x4304a6(0x210)&&(console['log'](_0x4304a6(0x28d)+_0x39aa7c['id']+_0x4304a6(0x288)+_0x4f6230[_0x4304a6(0x229)]+_0x4304a6(0x256)),this[_0x4304a6(0x211)](_0x39aa7c['id'])),console[_0x4304a6(0x22c)](_0x4304a6(0x265)+_0x39aa7c['id']+_0x4304a6(0x1ec));}else console['log'](_0x4304a6(0x29d)+_0x39aa7c['id']+'\x20status\x20unchanged\x20('+_0x4f6230[_0x4304a6(0x229)]+')'),this[_0x4304a6(0x249)](_0x39aa7c['id'],_0x39aa7c[_0x4304a6(0x29c)],_0x39aa7c['status'],_0x4f6230[_0x4304a6(0x229)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x4f6230[_0x4304a6(0x1ff)],'amount':_0x4f6230[_0x4304a6(0x2ae)],'currency':_0x4f6230[_0x4304a6(0x2b2)],'shopId':_0x39aa7c[_0x4304a6(0x299)],'checkTimestamp':new Date()[_0x4304a6(0x290)]()});}catch(_0x486920){console[_0x4304a6(0x29e)]('‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x39aa7c['id']+':',_0x486920),this['logCoinToPayError'](_0x39aa7c['id'],_0x39aa7c[_0x4304a6(0x29c)],_0x486920,_0x4304a6(0x201),{'paymentAmount':_0x39aa7c['amount'],'paymentCurrency':_0x39aa7c['currency'],'shopId':_0x39aa7c[_0x4304a6(0x299)],'createdAt':_0x39aa7c[_0x4304a6(0x2a9)]}),await database_1[_0x4304a6(0x219)]['webhookLog'][_0x4304a6(0x242)]({'data':{'paymentId':_0x39aa7c['id'],'shopId':_0x39aa7c[_0x4304a6(0x299)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x4304a6(0x2a4)]({'error':_0x486920 instanceof Error?_0x486920[_0x4304a6(0x2a1)]:_0x4304a6(0x293),'gatewayPaymentId':_0x39aa7c['gatewayPaymentId'],'checkedAt':new Date()[_0x4304a6(0x290)]()})}});}}async['sendShopWebhook'](_0x28bc95,_0x49169f){const _0x211864=a35_0x47bf1c,_0x11cb2c=Date[_0x211864(0x1e9)]();try{const _0x36fa56=_0x28bc95[_0x211864(0x263)],_0x3223ea=_0x36fa56['settings'];if(!_0x3223ea?.[_0x211864(0x215)]){console[_0x211864(0x22c)](_0x211864(0x25a)+_0x36fa56['id']);return;}const _0x219399=_0x49169f===_0x211864(0x291)?_0x211864(0x24d):_0x49169f===_0x211864(0x2bb)?_0x211864(0x226):_0x49169f===_0x211864(0x20d)?_0x211864(0x226):_0x211864(0x1d9);if(!_0x3223ea['webhookEvents']?.[_0x211864(0x252)](_0x219399)){console[_0x211864(0x22c)]('Webhook\x20event\x20'+_0x219399+'\x20not\x20enabled\x20for\x20shop\x20'+_0x36fa56['id']);return;}const _0x355efa={'event':_0x219399,'payment':{'id':_0x28bc95['id'],'order_id':_0x28bc95[_0x211864(0x23c)],'gateway_order_id':_0x28bc95[_0x211864(0x28e)],'gateway':_0x211864(0x22b),'amount':_0x28bc95['amount'],'currency':_0x28bc95[_0x211864(0x2b2)],'status':_0x49169f[_0x211864(0x2bd)](),'customer_email':_0x28bc95[_0x211864(0x2a8)],'customer_name':_0x28bc95['customerName'],'created_at':_0x28bc95[_0x211864(0x2a9)],'updated_at':new Date()}},_0xaa3d0b=await fetch(_0x3223ea[_0x211864(0x215)],{'method':_0x211864(0x1ea),'headers':{'Content-Type':_0x211864(0x270),'User-Agent':_0x211864(0x282)},'body':JSON[_0x211864(0x2a4)](_0x355efa)}),_0x117f23=Date[_0x211864(0x1e9)]()-_0x11cb2c,_0x315378=_0xaa3d0b['ok']?_0x211864(0x27b):await _0xaa3d0b[_0x211864(0x2ab)]();loggerService_1[_0x211864(0x28f)][_0x211864(0x1e2)](_0x28bc95[_0x211864(0x299)],_0x3223ea[_0x211864(0x215)],_0x219399,_0xaa3d0b[_0x211864(0x229)],_0x117f23,_0x355efa),console['log'](_0x211864(0x273)+_0x3223ea[_0x211864(0x215)]+_0x211864(0x262)+_0xaa3d0b[_0x211864(0x229)]+'\x20('+_0x117f23+_0x211864(0x255));}catch(_0x10ed4b){console[_0x211864(0x29e)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x10ed4b),loggerService_1['loggerService'][_0x211864(0x1e0)](_0x28bc95[_0x211864(0x299)],_0x28bc95[_0x211864(0x263)]?.[_0x211864(0x20c)]?.[_0x211864(0x215)]||_0x211864(0x261),_0x211864(0x1f0),_0x10ed4b,{});}}async['sendPaymentStatusNotification'](_0x4335a5,_0x4e5537){const _0x16da57=a35_0x47bf1c;try{const _0x5c689f={'PENDING':_0x16da57(0x20a),'PAID':_0x16da57(0x1ed),'FAILED':'failed','EXPIRED':_0x16da57(0x234)},_0x9a2bcf=_0x5c689f[_0x4e5537];if(!_0x9a2bcf||_0x9a2bcf===_0x16da57(0x20a))return;await telegramBotService_1[_0x16da57(0x2af)][_0x16da57(0x24c)](_0x4335a5[_0x16da57(0x299)],_0x4335a5,_0x9a2bcf);}catch(_0x6ead6b){console[_0x16da57(0x29e)](_0x16da57(0x1e4),_0x6ead6b);}}async['checkPaymentById'](_0x2645ea){const _0x785ce3=a35_0x47bf1c;console[_0x785ce3(0x22c)](_0x785ce3(0x287)+_0x2645ea);const _0x276a21=await database_1[_0x785ce3(0x219)][_0x785ce3(0x27f)][_0x785ce3(0x23a)]({'where':{'id':_0x2645ea},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x276a21)throw new Error(_0x785ce3(0x1f2));if(_0x276a21[_0x785ce3(0x2b8)]!==_0x785ce3(0x26b))throw new Error(_0x785ce3(0x1f8));console['log'](_0x785ce3(0x20e)+_0x2645ea),await this[_0x785ce3(0x269)](_0x276a21),console['log']('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x2645ea);}['getServiceStats'](){const _0x1e25ea=a35_0x47bf1c,_0x23eee5=this[_0x1e25ea(0x246)]?this[_0x1e25ea(0x26c)]:undefined,_0x23a960=Array['from'](this[_0x1e25ea(0x298)]['values']())[_0x1e25ea(0x268)](_0x1fc9f9=>({'paymentId':_0x1fc9f9[_0x1e25ea(0x297)],'gatewayPaymentId':_0x1fc9f9[_0x1e25ea(0x29c)],'createdAt':_0x1fc9f9[_0x1e25ea(0x2a9)],'timersCount':_0x1fc9f9['timers'][_0x1e25ea(0x2b5)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x1e25ea(0x298)]['size'],'nextGlobalCheckIn':_0x23eee5,'paymentTimersDetails':_0x23a960};}[a35_0x47bf1c(0x1f3)](_0xa9af98){const _0x419bd1=a35_0x47bf1c,_0x3ea077=this[_0x419bd1(0x298)][_0x419bd1(0x220)](_0xa9af98);if(_0x3ea077)return{'hasTimers':!![],'timersCount':_0x3ea077[_0x419bd1(0x22d)][_0x419bd1(0x2b5)],'createdAt':_0x3ea077[_0x419bd1(0x2a9)],'gatewayPaymentId':_0x3ea077['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a35_0x47bf1c(0x1eb)]=CoinToPayStatusService,exports[a35_0x47bf1c(0x221)]=new CoinToPayStatusService();