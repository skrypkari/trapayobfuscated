'use strict';const a37_0x362519=a37_0x2f37;(function(_0x5e979c,_0x155ebf){const _0x461ca9=a37_0x2f37,_0x3530dc=_0x5e979c();while(!![]){try{const _0x246539=-parseInt(_0x461ca9(0x17f))/0x1*(parseInt(_0x461ca9(0x113))/0x2)+-parseInt(_0x461ca9(0x164))/0x3+parseInt(_0x461ca9(0x15a))/0x4*(parseInt(_0x461ca9(0xcc))/0x5)+-parseInt(_0x461ca9(0x10a))/0x6*(-parseInt(_0x461ca9(0x165))/0x7)+-parseInt(_0x461ca9(0xf6))/0x8*(parseInt(_0x461ca9(0xb6))/0x9)+parseInt(_0x461ca9(0xbc))/0xa+parseInt(_0x461ca9(0x188))/0xb*(parseInt(_0x461ca9(0x10c))/0xc);if(_0x246539===_0x155ebf)break;else _0x3530dc['push'](_0x3530dc['shift']());}catch(_0x539be9){_0x3530dc['push'](_0x3530dc['shift']());}}}(a37_0x3043,0xab814));function a37_0x2f37(_0x1d719b,_0x3f4801){const _0x30430e=a37_0x3043();return a37_0x2f37=function(_0x2f371a,_0x2d8d27){_0x2f371a=_0x2f371a-0x9b;let _0x59e638=_0x30430e[_0x2f371a];return _0x59e638;},a37_0x2f37(_0x1d719b,_0x3f4801);}var __importDefault=this&&this['__importDefault']||function(_0x37b693){const _0x4f7342=a37_0x2f37;return _0x37b693&&_0x37b693[_0x4f7342(0x15f)]?_0x37b693:{'default':_0x37b693};};Object[a37_0x362519(0x120)](exports,'__esModule',{'value':!![]}),exports[a37_0x362519(0x18f)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a37_0x362519(0x186)),database_1=__importDefault(require(a37_0x362519(0xe1))),telegramBotService_1=require(a37_0x362519(0x105)),loggerService_1=require(a37_0x362519(0x124));class CoinToPayStatusService{constructor(){const _0x3b409c=a37_0x362519;this['globalCheckInterval']=null,this[_0x3b409c(0x9b)]=0x3c*0x3c*0x3e8,this[_0x3b409c(0xf5)]=0x5,this[_0x3b409c(0x17a)]=new Map(),this[_0x3b409c(0x109)]=new coinToPayService_1['CoinToPayService'](),console[_0x3b409c(0x163)](_0x3b409c(0xc0));}[a37_0x362519(0xed)](_0x3b4450,_0x14a594){const _0x47081c=a37_0x362519;console[_0x47081c(0x163)](_0x47081c(0xd9)),console['log'](_0x47081c(0xf3)+_0x3b4450),console[_0x47081c(0x163)](_0x47081c(0x151)+_0x14a594),this[_0x47081c(0x156)](_0x3b4450);const _0x54c719=[],_0x4273f1=new Date(),_0x139a32=[{'delay':0x1*0x3c*0x3e8,'description':_0x47081c(0x122)},{'delay':0x2*0x3c*0x3e8,'description':_0x47081c(0xff)},{'delay':0x5*0x3c*0x3e8,'description':_0x47081c(0xc2)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x47081c(0x163)](_0x47081c(0x179)+_0x139a32[_0x47081c(0x185)]+_0x47081c(0xc4)+_0x3b4450);let _0x10caad=0x0;_0x139a32[_0x47081c(0xc1)]((_0x70a9a6,_0x1108d7)=>{const _0x3bcd6f=_0x47081c;_0x10caad+=_0x70a9a6[_0x3bcd6f(0x100)];const _0x286fbb=setTimeout(async()=>{const _0x4ef38d=_0x3bcd6f;console['log'](_0x4ef38d(0x146)+(_0x1108d7+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x3b4450+_0x4ef38d(0x9f)+_0x70a9a6[_0x4ef38d(0xce)]+')');try{await this[_0x4ef38d(0xbd)](_0x3b4450),console['log']('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x1108d7+0x1)+_0x4ef38d(0x102)+_0x3b4450);}catch(_0xceb208){console[_0x4ef38d(0x180)](_0x4ef38d(0x157)+(_0x1108d7+0x1)+_0x4ef38d(0xaa)+_0x3b4450+':',_0xceb208),this[_0x4ef38d(0xea)](_0x3b4450,_0x14a594,_0xceb208,_0x4ef38d(0xe7),{'checkNumber':_0x1108d7+0x1,'scheduledAfter':_0x70a9a6[_0x4ef38d(0xce)],'isIndividualCheck':!![]});}},_0x10caad);_0x54c719['push'](_0x286fbb),console[_0x3bcd6f(0x163)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x1108d7+0x1)+_0x3bcd6f(0xaa)+_0x3b4450+_0x3bcd6f(0x10f)+_0x10caad/0x3e8+'\x20seconds\x20('+_0x70a9a6['description']+')');});const _0x3a0dfc=setInterval(async()=>{const _0x5451b0=_0x47081c;console[_0x5451b0(0x163)]('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x3b4450);try{const _0x20aaec=await database_1[_0x5451b0(0xc5)][_0x5451b0(0x112)][_0x5451b0(0x12c)]({'where':{'id':_0x3b4450},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x20aaec){console[_0x5451b0(0x163)]('❌\x20[HOURLY]\x20Payment\x20'+_0x3b4450+_0x5451b0(0x119)),this[_0x5451b0(0x156)](_0x3b4450);return;}console[_0x5451b0(0x163)]('📊\x20[HOURLY]\x20Payment\x20'+_0x3b4450+'\x20current\x20status:\x20'+_0x20aaec[_0x5451b0(0xae)]);if(_0x20aaec[_0x5451b0(0xae)]!==_0x5451b0(0x15d)){console['log'](_0x5451b0(0xc7)+_0x3b4450+_0x5451b0(0x178)+_0x20aaec['status']+',\x20stopping\x20individual\x20checks'),this[_0x5451b0(0x156)](_0x3b4450);return;}const _0x28cdc1=Math['floor']((Date[_0x5451b0(0x17c)]()-_0x20aaec[_0x5451b0(0x175)][_0x5451b0(0xdb)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x28cdc1>=this[_0x5451b0(0xf5)]){console['log'](_0x5451b0(0xa4)+_0x3b4450+_0x5451b0(0xec)+this[_0x5451b0(0xf5)]+_0x5451b0(0xda)),this[_0x5451b0(0x156)](_0x3b4450);return;}await this[_0x5451b0(0xbd)](_0x3b4450),console[_0x5451b0(0x163)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x3b4450);}catch(_0x283eb4){console[_0x5451b0(0x180)]('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x3b4450+':',_0x283eb4),this[_0x5451b0(0xea)](_0x3b4450,_0x14a594,_0x283eb4,_0x5451b0(0xe7),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x54c719[_0x47081c(0xb3)](_0x3a0dfc),this[_0x47081c(0x17a)][_0x47081c(0x15c)](_0x3b4450,{'timers':_0x54c719,'paymentId':_0x3b4450,'gatewayPaymentId':_0x14a594,'createdAt':_0x4273f1}),console[_0x47081c(0x163)](_0x47081c(0x103)+_0x139a32[_0x47081c(0x185)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x3b4450),console[_0x47081c(0x163)](_0x47081c(0x107)+this[_0x47081c(0x17a)][_0x47081c(0x142)]),this[_0x47081c(0x116)](_0x3b4450,_0x14a594,_0x47081c(0x15d),_0x47081c(0x15d),_0x47081c(0xe7),{'action':_0x47081c(0x10d),'scheduledChecks':_0x139a32[_0x47081c(0x185)],'firstCheckIn':_0x139a32[0x0][_0x47081c(0x100)]/0x3e8,'totalTimers':this[_0x47081c(0x17a)][_0x47081c(0x142)]});}[a37_0x362519(0x156)](_0x37d6ea){const _0x4bfb45=a37_0x362519,_0x1229d5=this[_0x4bfb45(0x17a)][_0x4bfb45(0x152)](_0x37d6ea);_0x1229d5?(console[_0x4bfb45(0x163)]('🧹\x20[DEBUG]\x20Clearing\x20'+_0x1229d5['timers']['length']+_0x4bfb45(0x140)+_0x37d6ea),_0x1229d5['timers'][_0x4bfb45(0xc1)]((_0x5d4ca7,_0x5e26f8)=>{const _0x385142=_0x4bfb45;_0x5d4ca7&&(clearTimeout(_0x5d4ca7),clearInterval(_0x5d4ca7),console['log'](_0x385142(0x111)+(_0x5e26f8+0x1)+_0x385142(0xaa)+_0x37d6ea));}),this[_0x4bfb45(0x17a)][_0x4bfb45(0x167)](_0x37d6ea),console[_0x4bfb45(0x163)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x37d6ea+_0x4bfb45(0x138)+this['paymentTimers']['size'])):console[_0x4bfb45(0x163)](_0x4bfb45(0x17d)+_0x37d6ea+_0x4bfb45(0xe4));}async[a37_0x362519(0xbd)](_0xd15c47){const _0x22a3f3=a37_0x362519;console[_0x22a3f3(0x163)](_0x22a3f3(0x150)+_0xd15c47);const _0x20da84=await database_1[_0x22a3f3(0xc5)][_0x22a3f3(0x112)][_0x22a3f3(0x12c)]({'where':{'id':_0xd15c47},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x20da84){console[_0x22a3f3(0x163)](_0x22a3f3(0x13f)+_0xd15c47+_0x22a3f3(0xef));return;}console[_0x22a3f3(0x163)](_0x22a3f3(0x148)+_0xd15c47+_0x22a3f3(0x177)),console[_0x22a3f3(0x163)]('\x20\x20\x20-\x20Gateway:\x20'+_0x20da84[_0x22a3f3(0xe2)]),console[_0x22a3f3(0x163)](_0x22a3f3(0x11f)+_0x20da84['status']),console[_0x22a3f3(0x163)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x20da84[_0x22a3f3(0xf1)]),console[_0x22a3f3(0x163)](_0x22a3f3(0x127)+_0x20da84[_0x22a3f3(0xc3)]+'\x20'+_0x20da84[_0x22a3f3(0xa8)]),console['log'](_0x22a3f3(0x187)+_0x20da84['shopId']);if(_0x20da84[_0x22a3f3(0xe2)]!==_0x22a3f3(0x189)){console['log'](_0x22a3f3(0xe6)+_0xd15c47+_0x22a3f3(0xb4)+_0x20da84[_0x22a3f3(0xe2)]+')');return;}if(_0x20da84['status']!=='PENDING'){console[_0x22a3f3(0x163)](_0x22a3f3(0xe6)+_0xd15c47+_0x22a3f3(0x178)+_0x20da84['status']+_0x22a3f3(0x161)),this['clearPaymentTimers'](_0xd15c47);return;}if(!_0x20da84[_0x22a3f3(0xf1)]){console[_0x22a3f3(0x163)](_0x22a3f3(0xe6)+_0xd15c47+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x22a3f3(0x163)]('✅\x20[CHECK]\x20Payment\x20'+_0xd15c47+_0x22a3f3(0x12b)),await this[_0x22a3f3(0x168)](_0x20da84);}[a37_0x362519(0x116)](_0x9b3ccd,_0x50a857,_0x6153ba,_0x2560e2,_0x465881,_0x4c3566){const _0x10f27c=a37_0x362519,_0x1d5e6e={'type':_0x10f27c(0xc6),'paymentId':_0x9b3ccd,'gatewayPaymentId':_0x50a857,'oldStatus':_0x6153ba,'newStatus':_0x2560e2,'source':_0x465881,'timestamp':new Date()['toISOString'](),'details':_0x4c3566||{}};loggerService_1[_0x10f27c(0x12f)][_0x10f27c(0x116)](_0x1d5e6e),console[_0x10f27c(0x163)](_0x10f27c(0x12e)+_0x9b3ccd+'\x20('+_0x50a857+')'),console[_0x10f27c(0x163)]('\x20\x20\x20📊\x20Status:\x20'+_0x6153ba+_0x10f27c(0x123)+_0x2560e2),console[_0x10f27c(0x163)](_0x10f27c(0x14c)+_0x465881),console[_0x10f27c(0x163)](_0x10f27c(0x184)+_0x1d5e6e[_0x10f27c(0xa0)]),_0x4c3566&&console['log']('\x20\x20\x20📝\x20Details:',_0x4c3566);}[a37_0x362519(0xea)](_0x22663d,_0x53d25b,_0x4d5772,_0x4284a8,_0x57142e){const _0x3afbe4=a37_0x362519,_0x4dfef6={'type':_0x3afbe4(0x139),'paymentId':_0x22663d,'gatewayPaymentId':_0x53d25b,'error':_0x4d5772 instanceof Error?{'message':_0x4d5772[_0x3afbe4(0x159)],'stack':_0x4d5772[_0x3afbe4(0x158)]}:_0x4d5772,'source':_0x4284a8,'timestamp':new Date()[_0x3afbe4(0x104)](),'context':_0x57142e||{}};loggerService_1['loggerService'][_0x3afbe4(0xea)](_0x4dfef6),console['error']('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x22663d+'\x20('+_0x53d25b+')'),console[_0x3afbe4(0x180)](_0x3afbe4(0xb8)+(_0x4d5772 instanceof Error?_0x4d5772[_0x3afbe4(0x159)]:_0x4d5772)),console[_0x3afbe4(0x180)](_0x3afbe4(0x14c)+_0x4284a8),console[_0x3afbe4(0x180)](_0x3afbe4(0x184)+_0x4dfef6[_0x3afbe4(0xa0)]),_0x57142e&&console[_0x3afbe4(0x180)](_0x3afbe4(0xfc),_0x57142e);}[a37_0x362519(0x9d)](){const _0xe42b66=a37_0x362519;console[_0xe42b66(0x163)](_0xe42b66(0x108)),this[_0xe42b66(0xab)]()[_0xe42b66(0xd2)](_0x5dbe23=>{const _0x5dbf13=_0xe42b66;console[_0x5dbf13(0x180)]('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x5dbe23);}),this[_0xe42b66(0xb7)]=setInterval(async()=>{const _0xc2a140=_0xe42b66;try{console[_0xc2a140(0x163)](_0xc2a140(0x10b)),await this['checkAllPendingPayments'](),console[_0xc2a140(0x163)](_0xc2a140(0xb0));}catch(_0x1160ae){console[_0xc2a140(0x180)](_0xc2a140(0xd8),_0x1160ae);}},this[_0xe42b66(0x9b)]),console['log'](_0xe42b66(0x13e));}[a37_0x362519(0xb2)](){const _0x4e02bf=a37_0x362519;console[_0x4e02bf(0x163)](_0x4e02bf(0x153));this[_0x4e02bf(0xb7)]&&(clearInterval(this[_0x4e02bf(0xb7)]),this[_0x4e02bf(0xb7)]=null,console[_0x4e02bf(0x163)](_0x4e02bf(0xd4)));const _0x52a10f=this[_0x4e02bf(0x17a)][_0x4e02bf(0x142)];for(const [_0x5ca520]of this[_0x4e02bf(0x17a)]){this[_0x4e02bf(0x156)](_0x5ca520);}console['log']('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x52a10f+_0x4e02bf(0x14b));}async[a37_0x362519(0xab)](){const _0x178f98=a37_0x362519;try{console[_0x178f98(0x163)](_0x178f98(0xb9));const _0x24bbd0=await database_1[_0x178f98(0xc5)][_0x178f98(0x112)]['findMany']({'where':{'gateway':_0x178f98(0x189),'status':_0x178f98(0x15d),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x178f98(0xbb)+_0x24bbd0[_0x178f98(0x185)]+_0x178f98(0xa7));if(_0x24bbd0[_0x178f98(0x185)]===0x0){console[_0x178f98(0x163)](_0x178f98(0xf0));return;}const _0x5a744a=await this['checkExpiredPayments'](_0x24bbd0);console[_0x178f98(0x163)](_0x178f98(0xa9)+_0x5a744a[_0x178f98(0x185)]+'\x20expired\x20CoinToPay\x20payments');let _0x4762b0=0x0,_0x1ac6d1=0x0;for(const _0x25549f of _0x24bbd0){try{if(_0x5a744a[_0x178f98(0xbe)](_0x25549f['id'])){console['log'](_0x178f98(0x110)+_0x25549f['id']+_0x178f98(0xde)),_0x1ac6d1++;continue;}if(this[_0x178f98(0x17a)][_0x178f98(0xdd)](_0x25549f['id'])){console['log'](_0x178f98(0x110)+_0x25549f['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x1ac6d1++;continue;}const _0x5a4f58=(Date['now']()-_0x25549f[_0x178f98(0x175)][_0x178f98(0xdb)]())/(0x3e8*0x3c*0x3c);if(_0x5a4f58<0x1){console[_0x178f98(0x163)](_0x178f98(0x110)+_0x25549f['id']+_0x178f98(0x16c)+_0x5a4f58[_0x178f98(0x128)](0x1)+'h),\x20skipping\x20global\x20check'),_0x1ac6d1++;continue;}console[_0x178f98(0x163)](_0x178f98(0x16d)+_0x25549f['id']+_0x178f98(0x13b)+_0x5a4f58[_0x178f98(0x128)](0x1)+'h)'),await this[_0x178f98(0x168)](_0x25549f),_0x4762b0++,await new Promise(_0x13f9cd=>setTimeout(_0x13f9cd,0x7d0));}catch(_0x509a2c){console[_0x178f98(0x180)](_0x178f98(0xd1)+_0x25549f['id']+':',_0x509a2c),this['logCoinToPayError'](_0x25549f['id'],_0x25549f[_0x178f98(0xf1)]||'unknown',_0x509a2c,_0x178f98(0xe7),{'isGlobalCheck':!![],'paymentAmount':_0x25549f['amount'],'paymentCurrency':_0x25549f[_0x178f98(0xa8)],'shopId':_0x25549f[_0x178f98(0xfa)],'createdAt':_0x25549f[_0x178f98(0x175)]}),loggerService_1[_0x178f98(0x12f)][_0x178f98(0x14f)](_0x178f98(0x189),_0x178f98(0x133)+_0x25549f[_0x178f98(0xf1)],_0x509a2c);}}console[_0x178f98(0x163)](_0x178f98(0x12a)+_0x4762b0+'\x20checked,\x20'+_0x1ac6d1+_0x178f98(0x11d)+_0x5a744a[_0x178f98(0x185)]+_0x178f98(0x14d));}catch(_0x55d47b){console[_0x178f98(0x180)](_0x178f98(0xf8),_0x55d47b);}}async[a37_0x362519(0x16b)](_0x275e5c){const _0x2c3915=a37_0x362519,_0x131086=[],_0x4aba87=new Date();_0x4aba87[_0x2c3915(0x126)](_0x4aba87['getDate']()-this[_0x2c3915(0xf5)]),console[_0x2c3915(0x163)](_0x2c3915(0x14e)+this[_0x2c3915(0xf5)]+_0x2c3915(0xf9)+_0x4aba87[_0x2c3915(0x104)]()+')');for(const _0x36a0c2 of _0x275e5c){if(_0x36a0c2['createdAt']<_0x4aba87){console['log'](_0x2c3915(0xeb)+_0x36a0c2['id']+_0x2c3915(0xec)+this['EXPIRY_DAYS']+_0x2c3915(0x11e));try{this[_0x2c3915(0x116)](_0x36a0c2['id'],_0x36a0c2['gatewayPaymentId']||'unknown',_0x2c3915(0x15d),_0x2c3915(0x182),_0x2c3915(0xba),{'reason':'Payment\x20older\x20than\x20'+this[_0x2c3915(0xf5)]+_0x2c3915(0xdf),'createdAt':_0x36a0c2[_0x2c3915(0x175)],'daysSinceCreation':Math['floor']((Date[_0x2c3915(0x17c)]()-_0x36a0c2[_0x2c3915(0x175)][_0x2c3915(0xdb)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x36a0c2[_0x2c3915(0xc3)],'paymentCurrency':_0x36a0c2[_0x2c3915(0xa8)],'shopId':_0x36a0c2['shopId']}),await database_1['default'][_0x2c3915(0x112)][_0x2c3915(0x14a)]({'where':{'id':_0x36a0c2['id']},'data':{'status':_0x2c3915(0x182),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x2c3915(0xf5)]+_0x2c3915(0x16f)}}),await database_1[_0x2c3915(0xc5)][_0x2c3915(0x160)][_0x2c3915(0xf7)]({'data':{'paymentId':_0x36a0c2['id'],'shopId':_0x36a0c2[_0x2c3915(0xfa)],'event':_0x2c3915(0x134),'statusCode':0xc8,'responseBody':JSON[_0x2c3915(0x10e)]({'reason':_0x2c3915(0x174)+this[_0x2c3915(0xf5)]+'\x20days','createdAt':_0x36a0c2[_0x2c3915(0x175)],'expiredAt':new Date()[_0x2c3915(0x104)](),'daysSinceCreation':Math[_0x2c3915(0x9c)]((Date['now']()-_0x36a0c2[_0x2c3915(0x175)][_0x2c3915(0xdb)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x2c3915(0x171)](_0x36a0c2,_0x2c3915(0x182)),await this['sendPaymentStatusNotification'](_0x36a0c2,'EXPIRED'),this['clearPaymentTimers'](_0x36a0c2['id']),_0x131086[_0x2c3915(0xb3)](_0x36a0c2['id']),console[_0x2c3915(0x163)](_0x2c3915(0x154)+_0x36a0c2['id']+_0x2c3915(0xb5)+this['EXPIRY_DAYS']+_0x2c3915(0x18e));}catch(_0x424b5a){console[_0x2c3915(0x180)]('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x36a0c2['id']+':',_0x424b5a),this[_0x2c3915(0xea)](_0x36a0c2['id'],_0x36a0c2['gatewayPaymentId']||_0x2c3915(0xd0),_0x424b5a,'auto_expire',{'reason':_0x2c3915(0xdc),'createdAt':_0x36a0c2[_0x2c3915(0x175)],'daysSinceCreation':Math[_0x2c3915(0x9c)]((Date[_0x2c3915(0x17c)]()-_0x36a0c2['createdAt'][_0x2c3915(0xdb)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x131086;}async[a37_0x362519(0x168)](_0xad88d0){const _0x277b5b=a37_0x362519;if(!_0xad88d0[_0x277b5b(0xf1)]){console[_0x277b5b(0x163)](_0x277b5b(0xe6)+_0xad88d0['id']+_0x277b5b(0xf2));return;}console[_0x277b5b(0x163)](_0x277b5b(0x114)+_0xad88d0['id']+'\x20('+_0xad88d0[_0x277b5b(0xf1)]+')');try{const _0x25bfe1=await this['coinToPayService'][_0x277b5b(0xf4)](_0xad88d0[_0x277b5b(0xf1)]);console[_0x277b5b(0x163)]('📊\x20[CHECK]\x20Payment\x20'+_0xad88d0['id']+_0x277b5b(0x136)+_0x25bfe1[_0x277b5b(0xae)]);_0x25bfe1[_0x277b5b(0x162)]&&console[_0x277b5b(0x163)](_0x277b5b(0x148)+_0xad88d0['id']+_0x277b5b(0x172),{'iban':_0x25bfe1['paymentDetails']['iban']||_0x277b5b(0xe5),'transactionId':_0x25bfe1[_0x277b5b(0x162)][_0x277b5b(0x13c)],'createdOn':_0x25bfe1[_0x277b5b(0x162)][_0x277b5b(0x18a)],'confirmedOn':_0x25bfe1[_0x277b5b(0x162)][_0x277b5b(0x18b)]||_0x277b5b(0x115)});if(_0x25bfe1[_0x277b5b(0xae)]!==_0xad88d0[_0x277b5b(0xae)]){console[_0x277b5b(0x163)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0xad88d0['id']+_0x277b5b(0x131)+_0xad88d0[_0x277b5b(0xae)]+_0x277b5b(0x129)+_0x25bfe1[_0x277b5b(0xae)]),this[_0x277b5b(0x116)](_0xad88d0['id'],_0xad88d0['gatewayPaymentId'],_0xad88d0[_0x277b5b(0xae)],_0x25bfe1[_0x277b5b(0xae)],_0x277b5b(0xe7),{'paymentDetails':_0x25bfe1[_0x277b5b(0x162)],'amount':_0x25bfe1['amount'],'currency':_0x25bfe1['currency'],'shopId':_0xad88d0['shopId'],'checkTimestamp':new Date()[_0x277b5b(0x104)]()});const _0x279b88={'status':_0x25bfe1[_0x277b5b(0xae)],'updatedAt':new Date()};_0x25bfe1[_0x277b5b(0xae)]===_0x277b5b(0xd6)&&_0xad88d0[_0x277b5b(0xae)]!==_0x277b5b(0xd6)&&(_0x279b88[_0x277b5b(0x141)]=new Date(),console[_0x277b5b(0x163)](_0x277b5b(0xc8)+_0xad88d0['id']+_0x277b5b(0xfd)+_0x279b88[_0x277b5b(0x141)][_0x277b5b(0x104)]()));if(_0x25bfe1[_0x277b5b(0x162)]){const _0x21c7ae=_0x25bfe1[_0x277b5b(0x162)];_0x21c7ae[_0x277b5b(0xd7)]&&(_0x279b88[_0x277b5b(0x125)]=_0x21c7ae['iban'],console['log'](_0x277b5b(0x106)+_0x21c7ae[_0x277b5b(0xd7)]));if(_0x21c7ae[_0x277b5b(0x18c)]){const _0x1822ca=_0xad88d0[_0x277b5b(0x118)]||'',_0xf877b1=_0x277b5b(0xca)+_0x21c7ae['bankDetails'];_0x279b88[_0x277b5b(0x118)]=_0x1822ca?_0x1822ca+'\x0a\x0a'+_0xf877b1:_0xf877b1,console['log'](_0x277b5b(0x130));}_0x21c7ae[_0x277b5b(0x13c)]&&console[_0x277b5b(0x163)](_0x277b5b(0xcf)+_0x21c7ae[_0x277b5b(0x13c)]),_0x21c7ae[_0x277b5b(0x18b)]&&console[_0x277b5b(0x163)]('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x21c7ae[_0x277b5b(0x18b)]);}await database_1[_0x277b5b(0xc5)][_0x277b5b(0x112)][_0x277b5b(0x14a)]({'where':{'id':_0xad88d0['id']},'data':_0x279b88}),await database_1[_0x277b5b(0xc5)][_0x277b5b(0x160)][_0x277b5b(0xf7)]({'data':{'paymentId':_0xad88d0['id'],'shopId':_0xad88d0['shopId'],'event':_0x277b5b(0x18d)+_0x25bfe1[_0x277b5b(0xae)][_0x277b5b(0x135)](),'statusCode':0xc8,'responseBody':JSON[_0x277b5b(0x10e)]({'oldStatus':_0xad88d0[_0x277b5b(0xae)],'newStatus':_0x25bfe1[_0x277b5b(0xae)],'paymentDetails':_0x25bfe1[_0x277b5b(0x162)],'checkedAt':new Date()[_0x277b5b(0x104)]()})}}),await this['sendShopWebhook'](_0xad88d0,_0x25bfe1[_0x277b5b(0xae)]),await this[_0x277b5b(0x169)](_0xad88d0,_0x25bfe1['status']),_0x25bfe1['status']!=='PENDING'&&(console['log'](_0x277b5b(0x9e)+_0xad88d0['id']+_0x277b5b(0xa3)+_0x25bfe1[_0x277b5b(0xae)]+_0x277b5b(0x16e)),this[_0x277b5b(0x156)](_0xad88d0['id'])),console['log']('✅\x20[CHECK]\x20Payment\x20'+_0xad88d0['id']+_0x277b5b(0xa6));}else console['log'](_0x277b5b(0x148)+_0xad88d0['id']+_0x277b5b(0x170)+_0x25bfe1['status']+')'),this[_0x277b5b(0x116)](_0xad88d0['id'],_0xad88d0[_0x277b5b(0xf1)],_0xad88d0[_0x277b5b(0xae)],_0x25bfe1[_0x277b5b(0xae)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x25bfe1['paymentDetails'],'amount':_0x25bfe1[_0x277b5b(0xc3)],'currency':_0x25bfe1[_0x277b5b(0xa8)],'shopId':_0xad88d0[_0x277b5b(0xfa)],'checkTimestamp':new Date()[_0x277b5b(0x104)]()});}catch(_0x47a485){console[_0x277b5b(0x180)](_0x277b5b(0x11a)+_0xad88d0['id']+':',_0x47a485),this[_0x277b5b(0xea)](_0xad88d0['id'],_0xad88d0[_0x277b5b(0xf1)],_0x47a485,_0x277b5b(0xe7),{'paymentAmount':_0xad88d0[_0x277b5b(0xc3)],'paymentCurrency':_0xad88d0[_0x277b5b(0xa8)],'shopId':_0xad88d0[_0x277b5b(0xfa)],'createdAt':_0xad88d0[_0x277b5b(0x175)]}),await database_1[_0x277b5b(0xc5)][_0x277b5b(0x160)][_0x277b5b(0xf7)]({'data':{'paymentId':_0xad88d0['id'],'shopId':_0xad88d0[_0x277b5b(0xfa)],'event':_0x277b5b(0xc9),'statusCode':0x1f4,'responseBody':JSON[_0x277b5b(0x10e)]({'error':_0x47a485 instanceof Error?_0x47a485[_0x277b5b(0x159)]:_0x277b5b(0xac),'gatewayPaymentId':_0xad88d0[_0x277b5b(0xf1)],'checkedAt':new Date()[_0x277b5b(0x104)]()})}});}}async[a37_0x362519(0x171)](_0x11b131,_0xf55c64){const _0xe38976=a37_0x362519,_0x1052f3=Date[_0xe38976(0x17c)]();try{const _0x1ca8a8=_0x11b131['shop'],_0x4ef3ff=_0x1ca8a8[_0xe38976(0x11c)];if(!_0x4ef3ff?.[_0xe38976(0x173)]){console[_0xe38976(0x163)](_0xe38976(0x11b)+_0x1ca8a8['id']);return;}const _0x19c17b=_0xf55c64===_0xe38976(0xd6)?_0xe38976(0xe3):_0xf55c64===_0xe38976(0x166)?'payment.failed':_0xf55c64===_0xe38976(0x182)?_0xe38976(0x13a):_0xe38976(0x183);if(!_0x4ef3ff[_0xe38976(0xe9)]?.['includes'](_0x19c17b)){console[_0xe38976(0x163)](_0xe38976(0x15e)+_0x19c17b+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1ca8a8['id']);return;}const _0x471c58={'event':_0x19c17b,'payment':{'id':_0x11b131['id'],'order_id':_0x11b131[_0xe38976(0x121)],'gateway_order_id':_0x11b131[_0xe38976(0xd3)],'gateway':_0xe38976(0x17e),'amount':_0x11b131[_0xe38976(0xc3)],'currency':_0x11b131['currency'],'status':_0xf55c64[_0xe38976(0x135)](),'customer_email':_0x11b131[_0xe38976(0xa5)],'customer_name':_0x11b131[_0xe38976(0xad)],'created_at':_0x11b131['createdAt'],'updated_at':new Date()}},_0x34fddc=await fetch(_0x4ef3ff[_0xe38976(0x173)],{'method':_0xe38976(0x12d),'headers':{'Content-Type':_0xe38976(0x149),'User-Agent':_0xe38976(0xa1)},'body':JSON[_0xe38976(0x10e)](_0x471c58)}),_0x52d215=Date['now']()-_0x1052f3,_0x11858a=_0x34fddc['ok']?_0xe38976(0xa2):await _0x34fddc[_0xe38976(0x143)]();loggerService_1[_0xe38976(0x12f)][_0xe38976(0x17b)](_0x11b131['shopId'],_0x4ef3ff['webhookUrl'],_0x19c17b,_0x34fddc[_0xe38976(0xae)],_0x52d215,_0x471c58),console['log'](_0xe38976(0x155)+_0x4ef3ff[_0xe38976(0x173)]+_0xe38976(0xb1)+_0x34fddc[_0xe38976(0xae)]+'\x20('+_0x52d215+_0xe38976(0xe8));}catch(_0x1f2490){console[_0xe38976(0x180)](_0xe38976(0x117),_0x1f2490),loggerService_1[_0xe38976(0x12f)][_0xe38976(0x137)](_0x11b131[_0xe38976(0xfa)],_0x11b131[_0xe38976(0x101)]?.[_0xe38976(0x11c)]?.[_0xe38976(0x173)]||'unknown',_0xe38976(0x144),_0x1f2490,{});}}async[a37_0x362519(0x169)](_0x41a344,_0xfd99da){const _0x1342e7=a37_0x362519;try{const _0x847b17={'PENDING':'created','PAID':_0x1342e7(0xcd),'FAILED':_0x1342e7(0x181),'EXPIRED':_0x1342e7(0xd5)},_0x30084e=_0x847b17[_0xfd99da];if(!_0x30084e||_0x30084e===_0x1342e7(0x16a))return;await telegramBotService_1[_0x1342e7(0xfe)][_0x1342e7(0xbf)](_0x41a344[_0x1342e7(0xfa)],_0x41a344,_0x30084e);}catch(_0x230c5a){console['error'](_0x1342e7(0xe0),_0x230c5a);}}async['checkPaymentById'](_0x286fc1){const _0x5f4f76=a37_0x362519;console[_0x5f4f76(0x163)](_0x5f4f76(0x190)+_0x286fc1);const _0x5536c2=await database_1[_0x5f4f76(0xc5)][_0x5f4f76(0x112)][_0x5f4f76(0x12c)]({'where':{'id':_0x286fc1},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5536c2)throw new Error(_0x5f4f76(0x13d));if(_0x5536c2['gateway']!=='cointopay')throw new Error(_0x5f4f76(0x132));console[_0x5f4f76(0x163)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x286fc1),await this[_0x5f4f76(0x168)](_0x5536c2),console[_0x5f4f76(0x163)](_0x5f4f76(0xfb)+_0x286fc1);}[a37_0x362519(0x15b)](){const _0x54ef33=a37_0x362519,_0x3aafe6=this[_0x54ef33(0xb7)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x5842b2=Array[_0x54ef33(0xaf)](this[_0x54ef33(0x17a)][_0x54ef33(0x147)]())['map'](_0x192727=>({'paymentId':_0x192727[_0x54ef33(0x145)],'gatewayPaymentId':_0x192727[_0x54ef33(0xf1)],'createdAt':_0x192727[_0x54ef33(0x175)],'timersCount':_0x192727[_0x54ef33(0xcb)]['length']}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x54ef33(0x17a)][_0x54ef33(0x142)],'nextGlobalCheckIn':_0x3aafe6,'paymentTimersDetails':_0x5842b2};}[a37_0x362519(0xee)](_0x2c4334){const _0x5bd22a=a37_0x362519,_0x4c350c=this['paymentTimers'][_0x5bd22a(0x152)](_0x2c4334);if(_0x4c350c)return{'hasTimers':!![],'timersCount':_0x4c350c[_0x5bd22a(0xcb)][_0x5bd22a(0x185)],'createdAt':_0x4c350c[_0x5bd22a(0x175)],'gatewayPaymentId':_0x4c350c[_0x5bd22a(0xf1)]};return{'hasTimers':![]};}}exports[a37_0x362519(0x176)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();function a37_0x3043(){const _0x37e42a=['\x20\x20\x20📝\x20Context:','\x20marked\x20as\x20paid\x20at:\x20','telegramBotService','2\x20minutes','delay','shop','\x20completed\x20for\x20payment\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','toISOString','./telegramBotService','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','coinToPayService','366030UBZysT','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','7932jekXdB','schedule_created','stringify','\x20in\x20','⏰\x20[GLOBAL]\x20Payment\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','payment','70GkmluB','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','not\x20confirmed','logCoinToPayStatus','Failed\x20to\x20send\x20shop\x20webhook:','adminNotes','\x20not\x20found,\x20clearing\x20timers','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','settings','\x20skipped,\x20','\x20days,\x20marking\x20as\x20EXPIRED','\x20\x20\x20-\x20Status:\x20','defineProperty','orderId','1\x20minute','\x20->\x20','./loggerService','remitterIban','setDate','\x20\x20\x20-\x20Amount:\x20','toFixed','\x20to\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','findUnique','POST','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','loggerService','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20status\x20from\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','/status/','cointopay_auto_expired','toLowerCase','\x20status:\x20','logShopWebhookError','.\x20Remaining\x20active\x20timers:\x20','COINTOPAY_ERROR','payment.failed','\x20(age:\x20','transactionId','Payment\x20not\x20found','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','❌\x20[CHECK]\x20Payment\x20','\x20timers\x20for\x20payment\x20','paidAt','size','text','webhook_send','paymentId','🪙\x20[TIMER]\x20Individual\x20check\x20#','values','📊\x20[CHECK]\x20Payment\x20','application/json','update','\x20individual\x20payment\x20timers','\x20\x20\x20📍\x20Source:\x20','\x20expired','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','logWhiteDomainError','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','get','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','✅\x20[EXPIRY]\x20Payment\x20','Shop\x20webhook\x20sent\x20to\x20','clearPaymentTimers','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','stack','message','2604496HyLljD','getServiceStats','set','PENDING','Webhook\x20event\x20','__esModule','webhookLog',',\x20stopping\x20individual\x20checks','paymentDetails','log','154872VCXOjk','21lKgpIc','FAILED','delete','checkSinglePayment','sendPaymentStatusNotification','created','checkExpiredPayments','\x20is\x20too\x20new\x20(','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20',',\x20clearing\x20individual\x20timers','\x20days\x20without\x20payment\x20confirmation','\x20status\x20unchanged\x20(','sendShopWebhook','\x20details:','webhookUrl','Payment\x20older\x20than\x20','createdAt','CoinToPayStatusService','\x20found:','\x20status\x20is\x20','🪙\x20[DEBUG]\x20Creating\x20','paymentTimers','logShopWebhookSent','now','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','0100','15521SvlukM','error','failed','EXPIRED','payment.pending','\x20\x20\x20📅\x20Time:\x20','length','./gateways/coinToPayService','\x20\x20\x20-\x20ShopId:\x20','8987zrYIom','cointopay','createdOn','confirmedOn','bankDetails','cointopay_status_check_','-day\x20timeout','coinToPayStatusService','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','GLOBAL_CHECK_INTERVAL_MS','floor','startPeriodicStatusCheck','🧹\x20[CHECK]\x20Payment\x20','\x20(after\x20','timestamp','TesSoft\x20Payment\x20System/1.0','Success','\x20status\x20changed\x20to\x20','⏰\x20[HOURLY]\x20Payment\x20','customerEmail','\x20updated\x20successfully','\x20pending\x20CoinToPay\x20payments','currency','⏰\x20[GLOBAL]\x20Found\x20','\x20for\x20payment\x20','checkAllPendingPayments','Unknown\x20error','customerName','status','from','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20with\x20status\x20','stopPeriodicStatusCheck','push','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','1206ygkmqH','globalCheckInterval','\x20\x20\x20❌\x20Error:\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','auto_expire','🪙\x20[GLOBAL]\x20Found\x20','10807930IokPqn','checkSinglePaymentById','includes','sendPaymentNotification','🪙\x20CoinToPayStatusService\x20initialized','forEach','5\x20minutes','amount','\x20initial\x20timers\x20for\x20payment\x20','default','COINTOPAY_STATUS_CHANGE','✅\x20[HOURLY]\x20Payment\x20','💰\x20[CHECK]\x20Payment\x20','cointopay_status_check_error','Bank\x20Details:\x20','timers','5AcKuhc','paid','description','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','unknown','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','catch','gatewayOrderId','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','expired','PAID','iban','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','getTime','Failed\x20to\x20mark\x20payment\x20as\x20expired','has','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20days','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','../config/database','gateway','payment.success','\x20to\x20clear','not\x20found','⚠️\x20[CHECK]\x20Payment\x20','status_check','ms)','webhookEvents','logCoinToPayError','⏰\x20[EXPIRY]\x20Payment\x20','\x20is\x20older\x20than\x20','schedulePaymentChecks','getPaymentTimerInfo','\x20not\x20found\x20in\x20database','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','gatewayPaymentId','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20\x20\x20-\x20paymentId:\x20','checkPaymentStatus','EXPIRY_DAYS','69112DCHlDn','create','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20days\x20(created\x20before\x20','shopId','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'];a37_0x3043=function(){return _0x37e42a;};return a37_0x3043();}