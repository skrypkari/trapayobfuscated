'use strict';const a38_0x49d502=a38_0x286a;(function(_0x17f579,_0x20c7ef){const _0x106732=a38_0x286a,_0x21c149=_0x17f579();while(!![]){try{const _0x32d5e6=parseInt(_0x106732(0x131))/0x1*(parseInt(_0x106732(0x20c))/0x2)+parseInt(_0x106732(0x110))/0x3+parseInt(_0x106732(0x11a))/0x4*(-parseInt(_0x106732(0x1c1))/0x5)+parseInt(_0x106732(0x168))/0x6+parseInt(_0x106732(0x1f4))/0x7+-parseInt(_0x106732(0x166))/0x8*(-parseInt(_0x106732(0x182))/0x9)+-parseInt(_0x106732(0x1f9))/0xa*(parseInt(_0x106732(0x1bd))/0xb);if(_0x32d5e6===_0x20c7ef)break;else _0x21c149['push'](_0x21c149['shift']());}catch(_0x3117f5){_0x21c149['push'](_0x21c149['shift']());}}}(a38_0x21c3,0x93b78));function a38_0x21c3(){const _0x579c0b=[':\x20type=','\x20triggered\x20for\x20payment\x20','../config/database','‚úÖ\x20[CHECK]\x20Payment\x20','loggerService','unknown','\x20is\x20older\x20than\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20has\x20no\x20gatewayPaymentId,\x20skipping','coinToPayService','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','error','length','payment.pending','checkExpiredPayments','payment','üîç\x20[CHECK]\x20Checking\x20','\x20\x20\x20Amount:\x20','\x20updated:\x20currentPayments=','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','./currencyService','telegramBotService','ü™ô\x20[GLOBAL]\x20Found\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','timestamp','\x20completed\x20for\x20payment\x20','description','log','\x20\x20\x20‚ùå\x20Error:\x20','currentPayments','1\x20minute','default','8528088bejXGG','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','6634482LHgtUX','currency','checkPaymentById','üßπ\x20[CHECK]\x20Payment\x20','\x20commission:\x20','cointopay_auto_expired','now','get','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','\x20marked\x20as\x20paid\x20at:\x20','\x20updated\x20successfully','Webhook\x20event\x20','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20',',\x20using\x20default\x20commission\x2010%','\x20days','cointopay2','shopId','logCoinToPayStatus','üìà\x20[COINTOPAY]\x20Payment\x20','getDate','logWhiteDomainError','bankDetails','auto_expire','\x20not\x20enabled\x20for\x20shop\x20','confirmedOn','9dAKJxR','status','status_check','not\x20found','from','paid','Failed\x20to\x20mark\x20payment\x20as\x20expired','size','currencyService','logShopWebhookSent','\x20payment\x20','sendPaymentNotification','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','./gateways/coinToPayService','not\x20confirmed','includes','__esModule','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','orderId','\x20\x20\x20-\x20gatewayPaymentId:\x20','application/json','transactionId','map','clearPaymentTimers','created',',\x20status=','../types/gateway','shop','\x20is\x20valid\x20for\x20checking,\x20proceeding...','ü™ô\x20[DEBUG]\x20Creating\x20','paymentId','.\x20Remaining\x20active\x20timers:\x20','\x20days\x20without\x20payment\x20confirmation','createdOn',',\x20clearing\x20individual\x20timers','paymentTimers','‚úÖ\x20[EXPIRY]\x20Payment\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','POST','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','amountAfterGatewayCommissionUSDT','\x20details:','coinToPay2Service','iban','5\x20minutes','Payment\x20older\x20than\x20','\x20initial\x20timers\x20for\x20payment\x20','message','PENDING','getPaymentTimerInfo','CoinToPayService','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','checkSinglePaymentById','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','\x20has\x20no\x20gatewayPaymentId','text','COINTOPAY_STATUS_CHANGE','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paymentLink','33EniZIy','\x20expired\x20CoinToPay\x20payments','schedule_created','gateway','125rSmBKj','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','update','üìä\x20[CHECK]\x20Payment\x20','\x20\x20\x20üìù\x20Context:','\x20to\x20','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','payment.success','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','gatewaySettings','getGatewayCommission','coinToPayStatusService','./telegramBotService','\x20\x20\x20üìä\x20Status:\x20',',\x20using\x20default\x2010%','CoinToPayStatusService','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20pending\x20CoinToPay\x20payments','commission','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','h),\x20skipping\x20global\x20check','adminNotes','expired','globalCheckInterval','Failed\x20to\x20send\x20shop\x20webhook:','\x20days,\x20marking\x20as\x20EXPIRED','forEach','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','delete','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','logCoinToPayError','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','webhookUrl','findUnique','\x20(after\x20','SINGLE','__importDefault',',\x20gateway\x20','toLowerCase','startPeriodicStatusCheck','\x20\x20\x20üìç\x20Source:\x20','\x20expired','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','timers','paymentDetails','\x20\x20\x20Gateway\x20','createdAt','\x20\x20\x20üìù\x20Details:','\x20individual\x20payment\x20timers','244468sijtJT','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20not\x20found,\x20clearing\x20timers','CoinToPay2Service','Shop\x20webhook\x20sent\x20to\x20','9737710iQyqEE','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','toFixed','\x20amounts\x20calculated:','parse','üìä\x20[HOURLY]\x20Payment\x20','set','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','Bank\x20Details:\x20','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','EXPIRY_DAYS',',\x20currentPayments=','checkPaymentStatus','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','Unknown\x20error','paidAt','\x20status:\x20','\x20not\x20found\x20in\x20database','58kIlPqb','\x20skipped,\x20','catch','PAID','\x20for\x20payment\x20','sendPaymentStatusNotification','ms)','\x20(age:\x20','\x20current\x20status:\x20','push','create','checkSinglePayment','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20status\x20is\x20','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','cointopay','Payment\x20not\x20found','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','paymentLinkId','‚è∞\x20[GLOBAL]\x20Payment\x20','getTime','\x20seconds\x20(','Automatically\x20expired\x20after\x20','\x20\x20\x20-\x20ShopId:\x20','settings','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','1686906iPuvNp','webhook_send','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','type','\x20timers\x20for\x20payment\x20','FAILED','cointopay_status_check_','failed','\x20\x20\x20-\x20Amount:\x20','checkAllPendingPayments','47312lHyGiU','\x20status\x20from\x20','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','gatewayPaymentId','sendShopWebhook','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','EXPIRED','\x20is\x20too\x20new\x20(','amountUSDT','Gateway\x20','logShopWebhookError','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','2\x20minutes','üõë\x20[SHUTDOWN]\x20Cleared\x20','\x20status\x20changed\x20to\x20','\x20->\x20','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20days\x20(created\x20before\x20','\x20\x20\x20-\x20Gateway:\x20','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','amount','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','\x20USDT','36313ANrDQe','üí∞\x20[CHECK]\x20Payment\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','Success','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','getGatewayIdByName','stringify','schedulePaymentChecks','webhookLog','toISOString','webhookEvents','delay','values','floor','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','GLOBAL_CHECK_INTERVAL_MS','‚è∞\x20[HOURLY]\x20Payment\x20','gatewayOrderId','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:'];a38_0x21c3=function(){return _0x579c0b;};return a38_0x21c3();}function a38_0x286a(_0x1e0e52,_0x14a532){const _0x21c349=a38_0x21c3();return a38_0x286a=function(_0x286a82,_0x1b1e17){_0x286a82=_0x286a82-0xf8;let _0x1f159d=_0x21c349[_0x286a82];return _0x1f159d;},a38_0x286a(_0x1e0e52,_0x14a532);}var __importDefault=this&&this[a38_0x49d502(0x1e7)]||function(_0x102c95){return _0x102c95&&_0x102c95['__esModule']?_0x102c95:{'default':_0x102c95};};Object['defineProperty'](exports,a38_0x49d502(0x192),{'value':!![]}),exports[a38_0x49d502(0x1cd)]=exports[a38_0x49d502(0x1d1)]=void 0x0;const coinToPayService_1=require(a38_0x49d502(0x18f)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require(a38_0x49d502(0x19c)),database_1=__importDefault(require(a38_0x49d502(0x147))),telegramBotService_1=require(a38_0x49d502(0x1ce)),loggerService_1=require('./loggerService'),currencyService_1=require(a38_0x49d502(0x15a));class CoinToPayStatusService{constructor(){const _0x13eb02=a38_0x49d502;this[_0x13eb02(0x1d9)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x13eb02(0x1a5)]=new Map(),this[_0x13eb02(0x14e)]=new coinToPayService_1[(_0x13eb02(0x1b4))](),this[_0x13eb02(0x1ac)]=new coinToPay2Service_1[(_0x13eb02(0x1f7))](),console['log'](_0x13eb02(0x1b7));}[a38_0x49d502(0x139)](_0x4376ab,_0x1b1734){const _0x4dd976=a38_0x49d502;console['log'](_0x4dd976(0x12a)),console[_0x4dd976(0x161)]('\x20\x20\x20-\x20paymentId:\x20'+_0x4376ab),console['log'](_0x4dd976(0x195)+_0x1b1734),this['clearPaymentTimers'](_0x4376ab);const _0x3e3ae8=[],_0x489014=new Date(),_0x21a29b=[{'delay':0x1*0x3c*0x3e8,'description':_0x4dd976(0x164)},{'delay':0x2*0x3c*0x3e8,'description':_0x4dd976(0x126)},{'delay':0x5*0x3c*0x3e8,'description':_0x4dd976(0x1ae)},{'delay':0x5*0x3c*0x3e8,'description':_0x4dd976(0x1ae)}];console[_0x4dd976(0x161)](_0x4dd976(0x19f)+_0x21a29b['length']+_0x4dd976(0x1b0)+_0x4376ab);let _0x4619eb=0x0;_0x21a29b['forEach']((_0x4724e9,_0x46f44c)=>{const _0x544062=_0x4dd976;_0x4619eb+=_0x4724e9[_0x544062(0x13d)];const _0x2639c4=setTimeout(async()=>{const _0x216294=_0x544062;console['log'](_0x216294(0x12f)+(_0x46f44c+0x1)+_0x216294(0x146)+_0x4376ab+_0x216294(0x1e5)+_0x4724e9[_0x216294(0x160)]+')');try{await this['checkSinglePaymentById'](_0x4376ab),console[_0x216294(0x161)]('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x46f44c+0x1)+_0x216294(0x15f)+_0x4376ab);}catch(_0x5a6ef4){console[_0x216294(0x151)](_0x216294(0x1de)+(_0x46f44c+0x1)+'\x20for\x20payment\x20'+_0x4376ab+':',_0x5a6ef4),this[_0x216294(0x1e1)](_0x4376ab,_0x1b1734,_0x5a6ef4,_0x216294(0x184),{'checkNumber':_0x46f44c+0x1,'scheduledAfter':_0x4724e9['description'],'isIndividualCheck':!![]});}},_0x4619eb);_0x3e3ae8['push'](_0x2639c4),console[_0x544062(0x161)](_0x544062(0x1ed)+(_0x46f44c+0x1)+_0x544062(0xf9)+_0x4376ab+'\x20in\x20'+_0x4619eb/0x3e8+_0x544062(0x10b)+_0x4724e9[_0x544062(0x160)]+')');});const _0x1f3af3=setInterval(async()=>{const _0x4b43c6=_0x4dd976;console['log']('ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x4376ab);try{const _0x20f9f0=await database_1['default']['payment'][_0x4b43c6(0x1e4)]({'where':{'id':_0x4376ab},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x20f9f0){console['log']('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x4376ab+_0x4b43c6(0x1f6)),this[_0x4b43c6(0x199)](_0x4376ab);return;}console[_0x4b43c6(0x161)](_0x4b43c6(0x1fe)+_0x4376ab+_0x4b43c6(0xfd)+_0x20f9f0[_0x4b43c6(0x183)]);if(_0x20f9f0[_0x4b43c6(0x183)]!==_0x4b43c6(0x1b2)){console[_0x4b43c6(0x161)]('‚úÖ\x20[HOURLY]\x20Payment\x20'+_0x4376ab+_0x4b43c6(0x103)+_0x20f9f0[_0x4b43c6(0x183)]+',\x20stopping\x20individual\x20checks'),this[_0x4b43c6(0x199)](_0x4376ab);return;}const _0x1f5098=Math[_0x4b43c6(0x13f)]((Date[_0x4b43c6(0x16e)]()-_0x20f9f0[_0x4b43c6(0x1f1)][_0x4b43c6(0x10a)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1f5098>=this[_0x4b43c6(0x204)]){console[_0x4b43c6(0x161)](_0x4b43c6(0x142)+_0x4376ab+'\x20is\x20older\x20than\x20'+this[_0x4b43c6(0x204)]+_0x4b43c6(0x1e2)),this[_0x4b43c6(0x199)](_0x4376ab);return;}await this[_0x4b43c6(0x1b6)](_0x4376ab),console[_0x4b43c6(0x161)](_0x4b43c6(0x112)+_0x4376ab);}catch(_0x4918e3){console[_0x4b43c6(0x151)](_0x4b43c6(0x203)+_0x4376ab+':',_0x4918e3),this[_0x4b43c6(0x1e1)](_0x4376ab,_0x1b1734,_0x4918e3,_0x4b43c6(0x184),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3e3ae8[_0x4dd976(0xfe)](_0x1f3af3),this['paymentTimers'][_0x4dd976(0x1ff)](_0x4376ab,{'timers':_0x3e3ae8,'paymentId':_0x4376ab,'gatewayPaymentId':_0x1b1734,'createdAt':_0x489014}),console[_0x4dd976(0x161)](_0x4dd976(0x1d2)+_0x21a29b[_0x4dd976(0x152)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x4376ab),console[_0x4dd976(0x161)](_0x4dd976(0x104)+this[_0x4dd976(0x1a5)]['size']),this['logCoinToPayStatus'](_0x4376ab,_0x1b1734,_0x4dd976(0x1b2),_0x4dd976(0x1b2),_0x4dd976(0x184),{'action':_0x4dd976(0x1bf),'scheduledChecks':_0x21a29b[_0x4dd976(0x152)],'firstCheckIn':_0x21a29b[0x0]['delay']/0x3e8,'totalTimers':this['paymentTimers']['size']});}[a38_0x49d502(0x199)](_0x12c5bd){const _0x468ae1=a38_0x49d502,_0x52146a=this['paymentTimers'][_0x468ae1(0x16f)](_0x12c5bd);_0x52146a?(console['log']('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x52146a[_0x468ae1(0x1ee)]['length']+_0x468ae1(0x114)+_0x12c5bd),_0x52146a[_0x468ae1(0x1ee)][_0x468ae1(0x1dc)]((_0x3038e3,_0x470469)=>{const _0x28d01b=_0x468ae1;_0x3038e3&&(clearTimeout(_0x3038e3),clearInterval(_0x3038e3),console[_0x28d01b(0x161)](_0x28d01b(0x15d)+(_0x470469+0x1)+'\x20for\x20payment\x20'+_0x12c5bd));}),this['paymentTimers'][_0x468ae1(0x1df)](_0x12c5bd),console[_0x468ae1(0x161)](_0x468ae1(0x140)+_0x12c5bd+_0x468ae1(0x1a1)+this[_0x468ae1(0x1a5)][_0x468ae1(0x189)])):console[_0x468ae1(0x161)](_0x468ae1(0x170)+_0x12c5bd+'\x20to\x20clear');}async[a38_0x49d502(0x1b6)](_0x2c9bd8){const _0x5d8f56=a38_0x49d502;console['log']('üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x2c9bd8);const _0x36f8a6=await database_1['default'][_0x5d8f56(0x155)]['findUnique']({'where':{'id':_0x2c9bd8},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x36f8a6){console['log']('‚ùå\x20[CHECK]\x20Payment\x20'+_0x2c9bd8+_0x5d8f56(0x20b));return;}console[_0x5d8f56(0x161)](_0x5d8f56(0x1c5)+_0x2c9bd8+'\x20found:'),console[_0x5d8f56(0x161)](_0x5d8f56(0x12c)+_0x36f8a6[_0x5d8f56(0x1c0)]),console['log']('\x20\x20\x20-\x20Status:\x20'+_0x36f8a6['status']),console['log'](_0x5d8f56(0x1a7)+_0x36f8a6['gatewayPaymentId']),console[_0x5d8f56(0x161)](_0x5d8f56(0x118)+_0x36f8a6[_0x5d8f56(0x12e)]+'\x20'+_0x36f8a6[_0x5d8f56(0x169)]),console[_0x5d8f56(0x161)](_0x5d8f56(0x10d)+_0x36f8a6[_0x5d8f56(0x179)]);if(_0x36f8a6[_0x5d8f56(0x1c0)]!==_0x5d8f56(0x105)&&_0x36f8a6['gateway']!=='cointopay2'){console['log'](_0x5d8f56(0x10f)+_0x2c9bd8+_0x5d8f56(0x1c3)+_0x36f8a6['gateway']+')');return;}if(_0x36f8a6[_0x5d8f56(0x183)]!=='PENDING'){console[_0x5d8f56(0x161)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x2c9bd8+_0x5d8f56(0x103)+_0x36f8a6[_0x5d8f56(0x183)]+',\x20stopping\x20individual\x20checks'),this[_0x5d8f56(0x199)](_0x2c9bd8);return;}if(!_0x36f8a6[_0x5d8f56(0x11d)]){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x2c9bd8+_0x5d8f56(0x1b8));return;}console[_0x5d8f56(0x161)](_0x5d8f56(0x148)+_0x2c9bd8+_0x5d8f56(0x19e)),await this[_0x5d8f56(0x100)](_0x36f8a6);}['logCoinToPayStatus'](_0x5ea108,_0x25a7c4,_0x8b793c,_0x2f1953,_0x3b04ad,_0x1317b0){const _0x3cc606=a38_0x49d502,_0x45d33f={'type':_0x3cc606(0x1ba),'paymentId':_0x5ea108,'gatewayPaymentId':_0x25a7c4,'oldStatus':_0x8b793c,'newStatus':_0x2f1953,'source':_0x3b04ad,'timestamp':new Date()['toISOString'](),'details':_0x1317b0||{}};loggerService_1[_0x3cc606(0x149)]['logCoinToPayStatus'](_0x45d33f),console[_0x3cc606(0x161)](_0x3cc606(0x193)+_0x5ea108+'\x20('+_0x25a7c4+')'),console[_0x3cc606(0x161)](_0x3cc606(0x1cf)+_0x8b793c+_0x3cc606(0x129)+_0x2f1953),console[_0x3cc606(0x161)](_0x3cc606(0x1eb)+_0x3b04ad),console[_0x3cc606(0x161)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x45d33f['timestamp']),_0x1317b0&&console[_0x3cc606(0x161)](_0x3cc606(0x1f2),_0x1317b0);}[a38_0x49d502(0x1e1)](_0x319e73,_0x28acb7,_0x1690ba,_0x242981,_0x376cea){const _0x502eb9=a38_0x49d502,_0x3c1be2={'type':'COINTOPAY_ERROR','paymentId':_0x319e73,'gatewayPaymentId':_0x28acb7,'error':_0x1690ba instanceof Error?{'message':_0x1690ba[_0x502eb9(0x1b1)],'stack':_0x1690ba['stack']}:_0x1690ba,'source':_0x242981,'timestamp':new Date()[_0x502eb9(0x13b)](),'context':_0x376cea||{}};loggerService_1[_0x502eb9(0x149)]['logCoinToPayError'](_0x3c1be2),console['error'](_0x502eb9(0x175)+_0x319e73+'\x20('+_0x28acb7+')'),console[_0x502eb9(0x151)](_0x502eb9(0x162)+(_0x1690ba instanceof Error?_0x1690ba['message']:_0x1690ba)),console[_0x502eb9(0x151)](_0x502eb9(0x1eb)+_0x242981),console[_0x502eb9(0x151)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x3c1be2[_0x502eb9(0x15e)]),_0x376cea&&console[_0x502eb9(0x151)](_0x502eb9(0x1c6),_0x376cea);}[a38_0x49d502(0x1ea)](){const _0x5a72a0=a38_0x49d502;console[_0x5a72a0(0x161)](_0x5a72a0(0x11c)),this[_0x5a72a0(0x119)]()[_0x5a72a0(0x20e)](_0x368fd5=>{const _0x425957=_0x5a72a0;console['error'](_0x425957(0x144),_0x368fd5);}),this[_0x5a72a0(0x1d9)]=setInterval(async()=>{const _0x205a31=_0x5a72a0;try{console[_0x205a31(0x161)](_0x205a31(0x1ca)),await this[_0x205a31(0x119)](),console[_0x205a31(0x161)](_0x205a31(0x133));}catch(_0x2bc701){console[_0x205a31(0x151)](_0x205a31(0x11f),_0x2bc701);}},this[_0x5a72a0(0x141)]),console[_0x5a72a0(0x161)](_0x5a72a0(0x14c));}['stopPeriodicStatusCheck'](){const _0x322627=a38_0x49d502;console['log'](_0x322627(0x1fa));this['globalCheckInterval']&&(clearInterval(this[_0x322627(0x1d9)]),this['globalCheckInterval']=null,console[_0x322627(0x161)](_0x322627(0x201)));const _0x1acde2=this[_0x322627(0x1a5)][_0x322627(0x189)];for(const [_0x2a443b]of this[_0x322627(0x1a5)]){this[_0x322627(0x199)](_0x2a443b);}console['log'](_0x322627(0x127)+_0x1acde2+_0x322627(0x1f3));}async[a38_0x49d502(0x119)](){const _0x21a2c1=a38_0x49d502;try{console[_0x21a2c1(0x161)](_0x21a2c1(0x1e0));const _0x23e2cf=await database_1[_0x21a2c1(0x165)]['payment']['findMany']({'where':{'gateway':{'in':[_0x21a2c1(0x105),'cointopay2']},'status':_0x21a2c1(0x1b2),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x21a2c1(0x161)](_0x21a2c1(0x15c)+_0x23e2cf[_0x21a2c1(0x152)]+_0x21a2c1(0x1d3));if(_0x23e2cf['length']===0x0){console['log'](_0x21a2c1(0x1b5));return;}const _0x1a4c6d=await this[_0x21a2c1(0x154)](_0x23e2cf);console[_0x21a2c1(0x161)]('‚è∞\x20[GLOBAL]\x20Found\x20'+_0x1a4c6d[_0x21a2c1(0x152)]+_0x21a2c1(0x1be));let _0x4abd39=0x0,_0x4c5e22=0x0;for(const _0x5d3eb0 of _0x23e2cf){try{if(_0x1a4c6d[_0x21a2c1(0x191)](_0x5d3eb0['id'])){console[_0x21a2c1(0x161)](_0x21a2c1(0x109)+_0x5d3eb0['id']+_0x21a2c1(0x1a9)),_0x4c5e22++;continue;}if(this[_0x21a2c1(0x1a5)]['has'](_0x5d3eb0['id'])){console[_0x21a2c1(0x161)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x5d3eb0['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x4c5e22++;continue;}const _0x18fb73=(Date[_0x21a2c1(0x16e)]()-_0x5d3eb0[_0x21a2c1(0x1f1)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x18fb73<0x1){console[_0x21a2c1(0x161)](_0x21a2c1(0x109)+_0x5d3eb0['id']+_0x21a2c1(0x121)+_0x18fb73[_0x21a2c1(0x1fb)](0x1)+_0x21a2c1(0x1d6)),_0x4c5e22++;continue;}console[_0x21a2c1(0x161)]('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x5d3eb0['id']+_0x21a2c1(0xfc)+_0x18fb73[_0x21a2c1(0x1fb)](0x1)+'h)'),await this[_0x21a2c1(0x100)](_0x5d3eb0),_0x4abd39++,await new Promise(_0x312c39=>setTimeout(_0x312c39,0x7d0));}catch(_0x336822){console['error'](_0x21a2c1(0x1d5)+_0x5d3eb0['id']+':',_0x336822),this[_0x21a2c1(0x1e1)](_0x5d3eb0['id'],_0x5d3eb0[_0x21a2c1(0x11d)]||_0x21a2c1(0x14a),_0x336822,_0x21a2c1(0x184),{'isGlobalCheck':!![],'paymentAmount':_0x5d3eb0[_0x21a2c1(0x12e)],'paymentCurrency':_0x5d3eb0[_0x21a2c1(0x169)],'shopId':_0x5d3eb0['shopId'],'createdAt':_0x5d3eb0[_0x21a2c1(0x1f1)]}),loggerService_1[_0x21a2c1(0x149)][_0x21a2c1(0x17d)]('cointopay','/status/'+_0x5d3eb0[_0x21a2c1(0x11d)],_0x336822);}}console[_0x21a2c1(0x161)](_0x21a2c1(0x1f5)+_0x4abd39+'\x20checked,\x20'+_0x4c5e22+_0x21a2c1(0x20d)+_0x1a4c6d['length']+_0x21a2c1(0x1ec));}catch(_0x16794d){console[_0x21a2c1(0x151)](_0x21a2c1(0x125),_0x16794d);}}async[a38_0x49d502(0x154)](_0x19676f){const _0x5ae813=a38_0x49d502,_0x4873d8=[],_0x132420=new Date();_0x132420['setDate'](_0x132420[_0x5ae813(0x17c)]()-this['EXPIRY_DAYS']),console[_0x5ae813(0x161)](_0x5ae813(0x1c8)+this[_0x5ae813(0x204)]+_0x5ae813(0x12b)+_0x132420['toISOString']()+')');for(const _0x356f59 of _0x19676f){if(_0x356f59[_0x5ae813(0x1f1)]<_0x132420){console[_0x5ae813(0x161)]('‚è∞\x20[EXPIRY]\x20Payment\x20'+_0x356f59['id']+_0x5ae813(0x14b)+this[_0x5ae813(0x204)]+_0x5ae813(0x1db));try{this[_0x5ae813(0x17a)](_0x356f59['id'],_0x356f59[_0x5ae813(0x11d)]||_0x5ae813(0x14a),_0x5ae813(0x1b2),_0x5ae813(0x120),_0x5ae813(0x17f),{'reason':_0x5ae813(0x1af)+this[_0x5ae813(0x204)]+_0x5ae813(0x177),'createdAt':_0x356f59[_0x5ae813(0x1f1)],'daysSinceCreation':Math[_0x5ae813(0x13f)]((Date['now']()-_0x356f59[_0x5ae813(0x1f1)][_0x5ae813(0x10a)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x356f59[_0x5ae813(0x12e)],'paymentCurrency':_0x356f59[_0x5ae813(0x169)],'shopId':_0x356f59[_0x5ae813(0x179)]}),await database_1['default'][_0x5ae813(0x155)]['update']({'where':{'id':_0x356f59['id']},'data':{'status':_0x5ae813(0x120),'updatedAt':new Date(),'adminNotes':_0x5ae813(0x10c)+this[_0x5ae813(0x204)]+_0x5ae813(0x1a2)}}),await database_1[_0x5ae813(0x165)]['webhookLog'][_0x5ae813(0xff)]({'data':{'paymentId':_0x356f59['id'],'shopId':_0x356f59[_0x5ae813(0x179)],'event':_0x5ae813(0x16d),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x5ae813(0x1af)+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x356f59[_0x5ae813(0x1f1)],'expiredAt':new Date()[_0x5ae813(0x13b)](),'daysSinceCreation':Math['floor']((Date[_0x5ae813(0x16e)]()-_0x356f59[_0x5ae813(0x1f1)][_0x5ae813(0x10a)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x5ae813(0x11e)](_0x356f59,_0x5ae813(0x120)),await this[_0x5ae813(0xfa)](_0x356f59,_0x5ae813(0x120)),this[_0x5ae813(0x199)](_0x356f59['id']),_0x4873d8[_0x5ae813(0xfe)](_0x356f59['id']),console[_0x5ae813(0x161)](_0x5ae813(0x1a6)+_0x356f59['id']+_0x5ae813(0x1dd)+this[_0x5ae813(0x204)]+'-day\x20timeout');}catch(_0x2897f2){console[_0x5ae813(0x151)]('‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x356f59['id']+':',_0x2897f2),this[_0x5ae813(0x1e1)](_0x356f59['id'],_0x356f59[_0x5ae813(0x11d)]||_0x5ae813(0x14a),_0x2897f2,'auto_expire',{'reason':_0x5ae813(0x188),'createdAt':_0x356f59[_0x5ae813(0x1f1)],'daysSinceCreation':Math[_0x5ae813(0x13f)]((Date[_0x5ae813(0x16e)]()-_0x356f59[_0x5ae813(0x1f1)][_0x5ae813(0x10a)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x4873d8;}async['checkSinglePayment'](_0xc54df6){const _0xc602f4=a38_0x49d502;if(!_0xc54df6[_0xc602f4(0x11d)]){console[_0xc602f4(0x161)](_0xc602f4(0x10f)+_0xc54df6['id']+_0xc602f4(0x14d));return;}console['log'](_0xc602f4(0x156)+_0xc54df6[_0xc602f4(0x1c0)]+_0xc602f4(0x18c)+_0xc54df6['id']+'\x20('+_0xc54df6[_0xc602f4(0x11d)]+')');try{let _0x4d3633;_0xc54df6[_0xc602f4(0x1c0)]===_0xc602f4(0x178)?(_0x4d3633=await this['coinToPay2Service'][_0xc602f4(0x206)](_0xc54df6[_0xc602f4(0x11d)]),console[_0xc602f4(0x161)](_0xc602f4(0x1c2)+_0xc54df6['id']+_0xc602f4(0x20a)+_0x4d3633['status'])):(_0x4d3633=await this['coinToPayService'][_0xc602f4(0x206)](_0xc54df6[_0xc602f4(0x11d)]),console[_0xc602f4(0x161)](_0xc602f4(0x102)+_0xc54df6['id']+_0xc602f4(0x20a)+_0x4d3633[_0xc602f4(0x183)]));_0x4d3633[_0xc602f4(0x1ef)]&&console[_0xc602f4(0x161)](_0xc602f4(0x1c5)+_0xc54df6['id']+_0xc602f4(0x1ab),{'iban':_0x4d3633[_0xc602f4(0x1ef)][_0xc602f4(0x1ad)]||_0xc602f4(0x185),'transactionId':_0x4d3633[_0xc602f4(0x1ef)]['transactionId'],'createdOn':_0x4d3633[_0xc602f4(0x1ef)][_0xc602f4(0x1a3)],'confirmedOn':_0x4d3633[_0xc602f4(0x1ef)][_0xc602f4(0x181)]||_0xc602f4(0x190)});if(_0x4d3633[_0xc602f4(0x183)]!==_0xc54df6['status']){console['log'](_0xc602f4(0x171)+_0xc54df6['id']+_0xc602f4(0x11b)+_0xc54df6[_0xc602f4(0x183)]+_0xc602f4(0x1c7)+_0x4d3633['status']),this[_0xc602f4(0x17a)](_0xc54df6['id'],_0xc54df6['gatewayPaymentId'],_0xc54df6[_0xc602f4(0x183)],_0x4d3633[_0xc602f4(0x183)],_0xc602f4(0x184),{'paymentDetails':_0x4d3633[_0xc602f4(0x1ef)],'amount':_0x4d3633['amount'],'currency':_0x4d3633['currency'],'shopId':_0xc54df6[_0xc602f4(0x179)],'checkTimestamp':new Date()[_0xc602f4(0x13b)]()});const _0x4755c8={'status':_0x4d3633[_0xc602f4(0x183)],'updatedAt':new Date()};if(_0x4d3633['status']===_0xc602f4(0xf8)&&_0xc54df6[_0xc602f4(0x183)]!==_0xc602f4(0xf8)){_0x4755c8[_0xc602f4(0x209)]=new Date();if(!_0xc54df6[_0xc602f4(0x122)]){const _0x36fb68=await currencyService_1[_0xc602f4(0x18a)]['convertToUSDT'](_0xc54df6[_0xc602f4(0x12e)],_0xc54df6['currency']);_0x4755c8[_0xc602f4(0x122)]=_0x36fb68;const _0x53fd0d=await this[_0xc602f4(0x1cc)](_0xc54df6[_0xc602f4(0x179)],_0xc54df6['gateway']),_0x29af16=_0x36fb68*(0x1-_0x53fd0d/0x64);_0x4755c8[_0xc602f4(0x1aa)]=_0x29af16,console['log']('üí∞\x20[CHECK]\x20Payment\x20'+_0xc54df6['id']+_0xc602f4(0x1fc)),console[_0xc602f4(0x161)](_0xc602f4(0x157)+_0xc54df6[_0xc602f4(0x12e)]+'\x20'+_0xc54df6[_0xc602f4(0x169)]+_0xc602f4(0x129)+_0x36fb68[_0xc602f4(0x1fb)](0x6)+_0xc602f4(0x130)),console[_0xc602f4(0x161)](_0xc602f4(0x1f0)+_0xc54df6[_0xc602f4(0x1c0)]+_0xc602f4(0x16c)+_0x53fd0d+'%'),console[_0xc602f4(0x161)]('\x20\x20\x20Amount\x20after\x20commission:\x20'+_0x29af16['toFixed'](0x6)+_0xc602f4(0x130));}console['log'](_0xc602f4(0x132)+_0xc54df6['id']+_0xc602f4(0x172)+_0x4755c8[_0xc602f4(0x209)][_0xc602f4(0x13b)]());}if(_0x4d3633[_0xc602f4(0x1ef)]){const _0x34b813=_0x4d3633[_0xc602f4(0x1ef)];_0x34b813[_0xc602f4(0x1ad)]&&(_0x4755c8['remitterIban']=_0x34b813[_0xc602f4(0x1ad)],console[_0xc602f4(0x161)](_0xc602f4(0x18e)+_0x34b813[_0xc602f4(0x1ad)]));if(_0x34b813[_0xc602f4(0x17e)]){const _0x53813d=_0xc54df6[_0xc602f4(0x1d7)]||'',_0x4954a0=_0xc602f4(0x202)+_0x34b813['bankDetails'];_0x4755c8[_0xc602f4(0x1d7)]=_0x53813d?_0x53813d+'\x0a\x0a'+_0x4954a0:_0x4954a0,console[_0xc602f4(0x161)](_0xc602f4(0x107));}_0x34b813[_0xc602f4(0x197)]&&console[_0xc602f4(0x161)](_0xc602f4(0x12d)+_0x34b813[_0xc602f4(0x197)]),_0x34b813['confirmedOn']&&console['log'](_0xc602f4(0x136)+_0x34b813[_0xc602f4(0x181)]);}await database_1[_0xc602f4(0x165)][_0xc602f4(0x155)][_0xc602f4(0x1c4)]({'where':{'id':_0xc54df6['id']},'data':_0x4755c8});if(_0x4d3633[_0xc602f4(0x183)]==='PAID'&&_0xc54df6['status']!=='PAID'){console['log'](_0xc602f4(0x17b)+_0xc54df6['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x30a27c=await database_1[_0xc602f4(0x165)]['payment'][_0xc602f4(0x1e4)]({'where':{'id':_0xc54df6['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x30a27c?.[_0xc602f4(0x108)]&&_0x30a27c[_0xc602f4(0x1bc)])try{const _0x3bf5c5=_0x30a27c['paymentLink'];console[_0xc602f4(0x161)]('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x3bf5c5['id']+_0xc602f4(0x145)+_0x3bf5c5['type']+_0xc602f4(0x205)+_0x3bf5c5[_0xc602f4(0x163)]+_0xc602f4(0x19b)+_0x3bf5c5[_0xc602f4(0x183)]);const _0xd92a1a=_0x3bf5c5['currentPayments']+0x1,_0x21ec42=_0x3bf5c5[_0xc602f4(0x113)]===_0xc602f4(0x1e6)?'COMPLETED':_0x3bf5c5[_0xc602f4(0x183)];await database_1[_0xc602f4(0x165)][_0xc602f4(0x1bc)]['update']({'where':{'id':_0x3bf5c5['id']},'data':{'currentPayments':_0xd92a1a,'status':_0x21ec42,'updatedAt':new Date()}}),console[_0xc602f4(0x161)](_0xc602f4(0x101)+_0x3bf5c5['id']+_0xc602f4(0x158)+_0x3bf5c5[_0xc602f4(0x163)]+_0xc602f4(0x129)+_0xd92a1a+_0xc602f4(0x19b)+_0x3bf5c5[_0xc602f4(0x183)]+'\x20->\x20'+_0x21ec42);}catch(_0x42e9e0){console[_0xc602f4(0x151)](_0xc602f4(0x134),_0x42e9e0);}else console[_0xc602f4(0x161)](_0xc602f4(0x17b)+_0xc54df6['id']+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}await database_1[_0xc602f4(0x165)]['webhookLog'][_0xc602f4(0xff)]({'data':{'paymentId':_0xc54df6['id'],'shopId':_0xc54df6[_0xc602f4(0x179)],'event':_0xc602f4(0x116)+_0x4d3633[_0xc602f4(0x183)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0xc602f4(0x138)]({'oldStatus':_0xc54df6[_0xc602f4(0x183)],'newStatus':_0x4d3633[_0xc602f4(0x183)],'paymentDetails':_0x4d3633[_0xc602f4(0x1ef)],'checkedAt':new Date()['toISOString']()})}}),await this[_0xc602f4(0x11e)](_0xc54df6,_0x4d3633[_0xc602f4(0x183)]),await this['sendPaymentStatusNotification'](_0xc54df6,_0x4d3633['status']),_0x4d3633[_0xc602f4(0x183)]!==_0xc602f4(0x1b2)&&(console[_0xc602f4(0x161)](_0xc602f4(0x16b)+_0xc54df6['id']+_0xc602f4(0x128)+_0x4d3633[_0xc602f4(0x183)]+_0xc602f4(0x1a4)),this['clearPaymentTimers'](_0xc54df6['id'])),console[_0xc602f4(0x161)](_0xc602f4(0x148)+_0xc54df6['id']+_0xc602f4(0x173));}else console[_0xc602f4(0x161)]('üìä\x20[CHECK]\x20Payment\x20'+_0xc54df6['id']+'\x20status\x20unchanged\x20('+_0x4d3633['status']+')'),this[_0xc602f4(0x17a)](_0xc54df6['id'],_0xc54df6[_0xc602f4(0x11d)],_0xc54df6[_0xc602f4(0x183)],_0x4d3633[_0xc602f4(0x183)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x4d3633[_0xc602f4(0x1ef)],'amount':_0x4d3633[_0xc602f4(0x12e)],'currency':_0x4d3633[_0xc602f4(0x169)],'shopId':_0xc54df6[_0xc602f4(0x179)],'checkTimestamp':new Date()[_0xc602f4(0x13b)]()});}catch(_0x11fa9e){console[_0xc602f4(0x151)]('‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0xc54df6['id']+':',_0x11fa9e),this['logCoinToPayError'](_0xc54df6['id'],_0xc54df6['gatewayPaymentId'],_0x11fa9e,_0xc602f4(0x184),{'paymentAmount':_0xc54df6[_0xc602f4(0x12e)],'paymentCurrency':_0xc54df6[_0xc602f4(0x169)],'shopId':_0xc54df6['shopId'],'createdAt':_0xc54df6[_0xc602f4(0x1f1)]}),await database_1['default'][_0xc602f4(0x13a)][_0xc602f4(0xff)]({'data':{'paymentId':_0xc54df6['id'],'shopId':_0xc54df6[_0xc602f4(0x179)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x11fa9e instanceof Error?_0x11fa9e[_0xc602f4(0x1b1)]:_0xc602f4(0x208),'gatewayPaymentId':_0xc54df6[_0xc602f4(0x11d)],'checkedAt':new Date()[_0xc602f4(0x13b)]()})}});}}async[a38_0x49d502(0x11e)](_0x3f9815,_0x47478b){const _0x288808=a38_0x49d502,_0x1be5dd=Date[_0x288808(0x16e)]();try{const _0x2b292f=_0x3f9815[_0x288808(0x19d)],_0x5055f9=_0x2b292f[_0x288808(0x10e)];if(!_0x5055f9?.[_0x288808(0x1e3)]){console[_0x288808(0x161)](_0x288808(0x1bb)+_0x2b292f['id']);return;}const _0x89db67=_0x47478b==='PAID'?_0x288808(0x1c9):_0x47478b===_0x288808(0x115)?'payment.failed':_0x47478b==='EXPIRED'?'payment.failed':_0x288808(0x153);if(!_0x5055f9[_0x288808(0x13c)]?.['includes'](_0x89db67)){console[_0x288808(0x161)](_0x288808(0x174)+_0x89db67+_0x288808(0x180)+_0x2b292f['id']);return;}const _0x3ca555=(0x0,gateway_1[_0x288808(0x137)])(_0x3f9815[_0x288808(0x1c0)])||_0x3f9815[_0x288808(0x1c0)],_0x3af31d={'event':_0x89db67,'payment':{'id':_0x3f9815['id'],'order_id':_0x3f9815[_0x288808(0x194)],'gateway_order_id':_0x3f9815[_0x288808(0x143)],'gateway':_0x3ca555,'amount':_0x3f9815[_0x288808(0x12e)],'currency':_0x3f9815['currency'],'status':_0x47478b['toLowerCase'](),'customer_email':_0x3f9815['customerEmail'],'customer_name':_0x3f9815['customerName'],'created_at':_0x3f9815[_0x288808(0x1f1)],'updated_at':new Date()}},_0x431b19=await fetch(_0x5055f9[_0x288808(0x1e3)],{'method':_0x288808(0x1a8),'headers':{'Content-Type':_0x288808(0x196),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x288808(0x138)](_0x3af31d)}),_0x2c5c47=Date['now']()-_0x1be5dd,_0x4ccfb1=_0x431b19['ok']?_0x288808(0x135):await _0x431b19[_0x288808(0x1b9)]();loggerService_1[_0x288808(0x149)][_0x288808(0x18b)](_0x3f9815['shopId'],_0x5055f9[_0x288808(0x1e3)],_0x89db67,_0x431b19[_0x288808(0x183)],_0x2c5c47,_0x3af31d),console[_0x288808(0x161)](_0x288808(0x1f8)+_0x5055f9[_0x288808(0x1e3)]+'\x20with\x20status\x20'+_0x431b19[_0x288808(0x183)]+'\x20('+_0x2c5c47+_0x288808(0xfb));}catch(_0x2cf967){console[_0x288808(0x151)](_0x288808(0x1da),_0x2cf967),loggerService_1[_0x288808(0x149)][_0x288808(0x124)](_0x3f9815[_0x288808(0x179)],_0x3f9815[_0x288808(0x19d)]?.[_0x288808(0x10e)]?.[_0x288808(0x1e3)]||'unknown',_0x288808(0x111),_0x2cf967,{});}}async[a38_0x49d502(0xfa)](_0x16aa62,_0xe06f56){const _0x43f1b1=a38_0x49d502;try{const _0x3f606a={'PENDING':_0x43f1b1(0x19a),'PAID':_0x43f1b1(0x187),'FAILED':_0x43f1b1(0x117),'EXPIRED':_0x43f1b1(0x1d8)},_0x1db0fc=_0x3f606a[_0xe06f56];if(!_0x1db0fc||_0x1db0fc===_0x43f1b1(0x19a))return;await telegramBotService_1[_0x43f1b1(0x15b)][_0x43f1b1(0x18d)](_0x16aa62[_0x43f1b1(0x179)],_0x16aa62,_0x1db0fc);}catch(_0x3a64ff){console[_0x43f1b1(0x151)](_0x43f1b1(0x150),_0x3a64ff);}}async[a38_0x49d502(0x16a)](_0x471f32){const _0x5a0c76=a38_0x49d502;console[_0x5a0c76(0x161)](_0x5a0c76(0x14f)+_0x471f32);const _0x22bca3=await database_1[_0x5a0c76(0x165)]['payment'][_0x5a0c76(0x1e4)]({'where':{'id':_0x471f32},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x22bca3)throw new Error(_0x5a0c76(0x106));if(_0x22bca3['gateway']!=='cointopay'&&_0x22bca3[_0x5a0c76(0x1c0)]!==_0x5a0c76(0x178))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x5a0c76(0x161)](_0x5a0c76(0x159)+_0x22bca3['gateway']+_0x5a0c76(0x18c)+_0x471f32),await this[_0x5a0c76(0x100)](_0x22bca3),console[_0x5a0c76(0x161)](_0x5a0c76(0x207)+_0x471f32);}['getServiceStats'](){const _0x433232=a38_0x49d502,_0x274613=this[_0x433232(0x1d9)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0xb4fc93=Array[_0x433232(0x186)](this[_0x433232(0x1a5)][_0x433232(0x13e)]())[_0x433232(0x198)](_0x4aafe3=>({'paymentId':_0x4aafe3[_0x433232(0x1a0)],'gatewayPaymentId':_0x4aafe3[_0x433232(0x11d)],'createdAt':_0x4aafe3[_0x433232(0x1f1)],'timersCount':_0x4aafe3[_0x433232(0x1ee)][_0x433232(0x152)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x433232(0x204)],'activeIndividualTimers':this[_0x433232(0x1a5)][_0x433232(0x189)],'nextGlobalCheckIn':_0x274613,'paymentTimersDetails':_0xb4fc93};}[a38_0x49d502(0x1b3)](_0x33e87e){const _0x1f6e3d=a38_0x49d502,_0x178546=this[_0x1f6e3d(0x1a5)][_0x1f6e3d(0x16f)](_0x33e87e);if(_0x178546)return{'hasTimers':!![],'timersCount':_0x178546[_0x1f6e3d(0x1ee)][_0x1f6e3d(0x152)],'createdAt':_0x178546[_0x1f6e3d(0x1f1)],'gatewayPaymentId':_0x178546[_0x1f6e3d(0x11d)]};return{'hasTimers':![]};}async[a38_0x49d502(0x1cc)](_0x181e29,_0x5e0c37){const _0x2f3a2e=a38_0x49d502;try{const _0x182a8e=await database_1[_0x2f3a2e(0x165)]['shop']['findUnique']({'where':{'id':_0x181e29},'select':{'gatewaySettings':!![]}});if(!_0x182a8e?.[_0x2f3a2e(0x1cb)])return console[_0x2f3a2e(0x161)]('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x181e29+_0x2f3a2e(0x176)),0xa;const _0x4ad4c6=JSON[_0x2f3a2e(0x1fd)](_0x182a8e[_0x2f3a2e(0x1cb)]);for(const [_0x370f79,_0x3b9543]of Object['entries'](_0x4ad4c6)){if(_0x370f79[_0x2f3a2e(0x1e9)]()===_0x5e0c37[_0x2f3a2e(0x1e9)]()){const _0x59013b=_0x3b9543[_0x2f3a2e(0x1d4)]||0xa;return console[_0x2f3a2e(0x161)](_0x2f3a2e(0x123)+_0x5e0c37+'\x20commission\x20for\x20shop\x20'+_0x181e29+':\x20'+_0x59013b+'%'),_0x59013b;}}return console['log'](_0x2f3a2e(0x200)+_0x5e0c37+'\x20in\x20shop\x20'+_0x181e29+_0x2f3a2e(0x1d0)),0xa;}catch(_0x94b5ec){return console[_0x2f3a2e(0x151)](_0x2f3a2e(0x167)+_0x181e29+_0x2f3a2e(0x1e8)+_0x5e0c37+':',_0x94b5ec),0xa;}}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a38_0x49d502(0x1cd)]=new CoinToPayStatusService();