'use strict';const a37_0x1abfed=a37_0xab9a;function a37_0xab9a(_0x55304a,_0x4f48ac){const _0x32a8c8=a37_0x32a8();return a37_0xab9a=function(_0xab9aee,_0x238c5c){_0xab9aee=_0xab9aee-0x7d;let _0x4ca821=_0x32a8c8[_0xab9aee];return _0x4ca821;},a37_0xab9a(_0x55304a,_0x4f48ac);}(function(_0x24f40c,_0x4f773c){const _0x11c9c4=a37_0xab9a,_0xbac68b=_0x24f40c();while(!![]){try{const _0x80188=parseInt(_0x11c9c4(0xb8))/0x1*(-parseInt(_0x11c9c4(0x92))/0x2)+-parseInt(_0x11c9c4(0xef))/0x3+-parseInt(_0x11c9c4(0xf9))/0x4+parseInt(_0x11c9c4(0xf5))/0x5*(-parseInt(_0x11c9c4(0xdd))/0x6)+parseInt(_0x11c9c4(0xa5))/0x7*(parseInt(_0x11c9c4(0x15d))/0x8)+-parseInt(_0x11c9c4(0xab))/0x9*(-parseInt(_0x11c9c4(0x12b))/0xa)+parseInt(_0x11c9c4(0xde))/0xb*(parseInt(_0x11c9c4(0x95))/0xc);if(_0x80188===_0x4f773c)break;else _0xbac68b['push'](_0xbac68b['shift']());}catch(_0x24f68d){_0xbac68b['push'](_0xbac68b['shift']());}}}(a37_0x32a8,0x38800));var __importDefault=this&&this[a37_0x1abfed(0x170)]||function(_0x383754){const _0x1cd5f2=a37_0x1abfed;return _0x383754&&_0x383754[_0x1cd5f2(0xe5)]?_0x383754:{'default':_0x383754};};Object[a37_0x1abfed(0xa8)](exports,a37_0x1abfed(0xe5),{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0x1abfed(0xb7)]=void 0x0;const coinToPayService_1=require(a37_0x1abfed(0x108)),database_1=__importDefault(require(a37_0x1abfed(0x13c))),telegramBotService_1=require(a37_0x1abfed(0x106)),loggerService_1=require(a37_0x1abfed(0xb2));class CoinToPayStatusService{constructor(){const _0x11d146=a37_0x1abfed;this[_0x11d146(0x12f)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this['paymentTimers']=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x11d146(0x101))](),console[_0x11d146(0xa3)](_0x11d146(0xff));}[a37_0x1abfed(0x9c)](_0x57ab92,_0x542d77){const _0x46bb4a=a37_0x1abfed;console[_0x46bb4a(0xa3)](_0x46bb4a(0xf1)),console[_0x46bb4a(0xa3)](_0x46bb4a(0x131)+_0x57ab92),console[_0x46bb4a(0xa3)](_0x46bb4a(0x11d)+_0x542d77),this[_0x46bb4a(0x169)](_0x57ab92);const _0x1177b7=[],_0x461eed=new Date(),_0x3cc7c8=[{'delay':0x1*0x3c*0x3e8,'description':_0x46bb4a(0xbb)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x46bb4a(0x11c)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console['log'](_0x46bb4a(0xd1)+_0x3cc7c8[_0x46bb4a(0x10f)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x57ab92);let _0x307018=0x0;_0x3cc7c8[_0x46bb4a(0xec)]((_0x3c4e2e,_0xd971b3)=>{const _0x3165fc=_0x46bb4a;_0x307018+=_0x3c4e2e[_0x3165fc(0xc6)];const _0x3f352e=setTimeout(async()=>{const _0xec1515=_0x3165fc;console[_0xec1515(0xa3)](_0xec1515(0x8a)+(_0xd971b3+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x57ab92+'\x20(after\x20'+_0x3c4e2e[_0xec1515(0xa1)]+')');try{await this[_0xec1515(0x129)](_0x57ab92),console[_0xec1515(0xa3)](_0xec1515(0x110)+(_0xd971b3+0x1)+'\x20completed\x20for\x20payment\x20'+_0x57ab92);}catch(_0x5a5f0d){console[_0xec1515(0x11a)]('❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0xd971b3+0x1)+'\x20for\x20payment\x20'+_0x57ab92+':',_0x5a5f0d),this[_0xec1515(0x86)](_0x57ab92,_0x542d77,_0x5a5f0d,_0xec1515(0xaa),{'checkNumber':_0xd971b3+0x1,'scheduledAfter':_0x3c4e2e[_0xec1515(0xa1)],'isIndividualCheck':!![]});}},_0x307018);_0x1177b7[_0x3165fc(0xdf)](_0x3f352e),console['log'](_0x3165fc(0x120)+(_0xd971b3+0x1)+_0x3165fc(0x139)+_0x57ab92+'\x20in\x20'+_0x307018/0x3e8+_0x3165fc(0x16f)+_0x3c4e2e[_0x3165fc(0xa1)]+')');});const _0x991e1d=setInterval(async()=>{const _0x2bc576=_0x46bb4a;console['log'](_0x2bc576(0x148)+_0x57ab92);try{const _0x27844f=await database_1[_0x2bc576(0x16d)][_0x2bc576(0x136)]['findUnique']({'where':{'id':_0x57ab92},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x27844f){console[_0x2bc576(0xa3)](_0x2bc576(0x83)+_0x57ab92+_0x2bc576(0xc8)),this[_0x2bc576(0x169)](_0x57ab92);return;}console[_0x2bc576(0xa3)](_0x2bc576(0x147)+_0x57ab92+_0x2bc576(0xd7)+_0x27844f[_0x2bc576(0xf6)]);if(_0x27844f[_0x2bc576(0xf6)]!=='PENDING'){console[_0x2bc576(0xa3)](_0x2bc576(0x13d)+_0x57ab92+_0x2bc576(0xc7)+_0x27844f['status']+',\x20stopping\x20individual\x20checks'),this['clearPaymentTimers'](_0x57ab92);return;}const _0x58cca4=Math[_0x2bc576(0x149)]((Date[_0x2bc576(0x151)]()-_0x27844f[_0x2bc576(0x12c)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x58cca4>=this[_0x2bc576(0x153)]){console[_0x2bc576(0xa3)](_0x2bc576(0xd2)+_0x57ab92+'\x20is\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x2bc576(0x14e)),this['clearPaymentTimers'](_0x57ab92);return;}await this['checkSinglePaymentById'](_0x57ab92),console[_0x2bc576(0xa3)](_0x2bc576(0xc0)+_0x57ab92);}catch(_0x2f0f27){console[_0x2bc576(0x11a)]('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x57ab92+':',_0x2f0f27),this[_0x2bc576(0x86)](_0x57ab92,_0x542d77,_0x2f0f27,_0x2bc576(0xaa),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x1177b7[_0x46bb4a(0xdf)](_0x991e1d),this[_0x46bb4a(0x122)][_0x46bb4a(0xb1)](_0x57ab92,{'timers':_0x1177b7,'paymentId':_0x57ab92,'gatewayPaymentId':_0x542d77,'createdAt':_0x461eed}),console['log'](_0x46bb4a(0xe8)+_0x3cc7c8[_0x46bb4a(0x10f)]+_0x46bb4a(0x14a)+_0x57ab92),console[_0x46bb4a(0xa3)](_0x46bb4a(0xe3)+this[_0x46bb4a(0x122)][_0x46bb4a(0xf2)]),this[_0x46bb4a(0xb4)](_0x57ab92,_0x542d77,_0x46bb4a(0x12e),_0x46bb4a(0x12e),_0x46bb4a(0xaa),{'action':_0x46bb4a(0xe9),'scheduledChecks':_0x3cc7c8[_0x46bb4a(0x10f)],'firstCheckIn':_0x3cc7c8[0x0][_0x46bb4a(0xc6)]/0x3e8,'totalTimers':this['paymentTimers']['size']});}[a37_0x1abfed(0x169)](_0x10c02f){const _0x1ce5f1=a37_0x1abfed,_0x48dd63=this[_0x1ce5f1(0x122)][_0x1ce5f1(0x167)](_0x10c02f);_0x48dd63?(console[_0x1ce5f1(0xa3)](_0x1ce5f1(0x161)+_0x48dd63[_0x1ce5f1(0x8e)][_0x1ce5f1(0x10f)]+'\x20timers\x20for\x20payment\x20'+_0x10c02f),_0x48dd63[_0x1ce5f1(0x8e)][_0x1ce5f1(0xec)]((_0x5c06fd,_0x5c9fde)=>{const _0x47db4a=_0x1ce5f1;_0x5c06fd&&(clearTimeout(_0x5c06fd),clearInterval(_0x5c06fd),console[_0x47db4a(0xa3)](_0x47db4a(0xe1)+(_0x5c9fde+0x1)+'\x20for\x20payment\x20'+_0x10c02f));}),this['paymentTimers'][_0x1ce5f1(0x87)](_0x10c02f),console['log'](_0x1ce5f1(0xe7)+_0x10c02f+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x1ce5f1(0x122)][_0x1ce5f1(0xf2)])):console['log'](_0x1ce5f1(0xa4)+_0x10c02f+'\x20to\x20clear');}async[a37_0x1abfed(0x129)](_0x47beda){const _0xf0984f=a37_0x1abfed;console[_0xf0984f(0xa3)](_0xf0984f(0x99)+_0x47beda);const _0x45ce99=await database_1[_0xf0984f(0x16d)][_0xf0984f(0x136)][_0xf0984f(0x15a)]({'where':{'id':_0x47beda},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x45ce99){console[_0xf0984f(0xa3)](_0xf0984f(0x121)+_0x47beda+_0xf0984f(0xf3));return;}console[_0xf0984f(0xa3)]('📊\x20[CHECK]\x20Payment\x20'+_0x47beda+_0xf0984f(0x15f)),console[_0xf0984f(0xa3)](_0xf0984f(0x7f)+_0x45ce99[_0xf0984f(0xca)]),console[_0xf0984f(0xa3)]('\x20\x20\x20-\x20Status:\x20'+_0x45ce99[_0xf0984f(0xf6)]),console[_0xf0984f(0xa3)](_0xf0984f(0xf4)+_0x45ce99[_0xf0984f(0x85)]),console[_0xf0984f(0xa3)](_0xf0984f(0xed)+_0x45ce99[_0xf0984f(0x7d)]+'\x20'+_0x45ce99[_0xf0984f(0x8b)]),console[_0xf0984f(0xa3)](_0xf0984f(0xad)+_0x45ce99[_0xf0984f(0x130)]);if(_0x45ce99[_0xf0984f(0xca)]!=='cointopay'){console[_0xf0984f(0xa3)](_0xf0984f(0x157)+_0x47beda+_0xf0984f(0x8d)+_0x45ce99[_0xf0984f(0xca)]+')');return;}if(_0x45ce99['status']!==_0xf0984f(0x12e)){console[_0xf0984f(0xa3)](_0xf0984f(0x157)+_0x47beda+_0xf0984f(0xc7)+_0x45ce99['status']+_0xf0984f(0x10e)),this['clearPaymentTimers'](_0x47beda);return;}if(!_0x45ce99[_0xf0984f(0x85)]){console[_0xf0984f(0xa3)](_0xf0984f(0x157)+_0x47beda+_0xf0984f(0xdb));return;}console[_0xf0984f(0xa3)]('✅\x20[CHECK]\x20Payment\x20'+_0x47beda+_0xf0984f(0xa2)),await this['checkSinglePayment'](_0x45ce99);}[a37_0x1abfed(0xb4)](_0x1e53df,_0x3157b0,_0x4a6864,_0xc4034f,_0x2010b1,_0x501d92){const _0x32f3a8=a37_0x1abfed,_0x5bfba0={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x1e53df,'gatewayPaymentId':_0x3157b0,'oldStatus':_0x4a6864,'newStatus':_0xc4034f,'source':_0x2010b1,'timestamp':new Date()[_0x32f3a8(0x154)](),'details':_0x501d92||{}};loggerService_1[_0x32f3a8(0x8c)][_0x32f3a8(0xb4)](_0x5bfba0),console['log'](_0x32f3a8(0xd5)+_0x1e53df+'\x20('+_0x3157b0+')'),console[_0x32f3a8(0xa3)](_0x32f3a8(0x9b)+_0x4a6864+_0x32f3a8(0x14b)+_0xc4034f),console[_0x32f3a8(0xa3)](_0x32f3a8(0x152)+_0x2010b1),console[_0x32f3a8(0xa3)]('\x20\x20\x20📅\x20Time:\x20'+_0x5bfba0[_0x32f3a8(0x127)]),_0x501d92&&console[_0x32f3a8(0xa3)](_0x32f3a8(0xcb),_0x501d92);}['logCoinToPayError'](_0x5cfe4c,_0x105a8b,_0x2ea2d5,_0x2d5650,_0x5d9daf){const _0x3a52d7=a37_0x1abfed,_0x558c81={'type':'COINTOPAY_ERROR','paymentId':_0x5cfe4c,'gatewayPaymentId':_0x105a8b,'error':_0x2ea2d5 instanceof Error?{'message':_0x2ea2d5[_0x3a52d7(0x14c)],'stack':_0x2ea2d5[_0x3a52d7(0xfc)]}:_0x2ea2d5,'source':_0x2d5650,'timestamp':new Date()[_0x3a52d7(0x154)](),'context':_0x5d9daf||{}};loggerService_1[_0x3a52d7(0x8c)][_0x3a52d7(0x86)](_0x558c81),console[_0x3a52d7(0x11a)]('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x5cfe4c+'\x20('+_0x105a8b+')'),console[_0x3a52d7(0x11a)](_0x3a52d7(0x13e)+(_0x2ea2d5 instanceof Error?_0x2ea2d5[_0x3a52d7(0x14c)]:_0x2ea2d5)),console[_0x3a52d7(0x11a)](_0x3a52d7(0x152)+_0x2d5650),console[_0x3a52d7(0x11a)](_0x3a52d7(0x162)+_0x558c81[_0x3a52d7(0x127)]),_0x5d9daf&&console[_0x3a52d7(0x11a)](_0x3a52d7(0xa7),_0x5d9daf);}['startPeriodicStatusCheck'](){const _0x5e40b7=a37_0x1abfed;console[_0x5e40b7(0xa3)](_0x5e40b7(0xdc)),this[_0x5e40b7(0x168)]()['catch'](_0x37aa98=>{const _0xcc276b=_0x5e40b7;console[_0xcc276b(0x11a)](_0xcc276b(0xa6),_0x37aa98);}),this[_0x5e40b7(0x12f)]=setInterval(async()=>{const _0x40126b=_0x5e40b7;try{console[_0x40126b(0xa3)](_0x40126b(0xc3)),await this[_0x40126b(0x168)](),console[_0x40126b(0xa3)](_0x40126b(0x94));}catch(_0x2d40f9){console['error']('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x2d40f9);}},this[_0x5e40b7(0x137)]),console[_0x5e40b7(0xa3)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x1abfed(0x146)](){const _0x4acdec=a37_0x1abfed;console[_0x4acdec(0xa3)](_0x4acdec(0x100));this[_0x4acdec(0x12f)]&&(clearInterval(this['globalCheckInterval']),this[_0x4acdec(0x12f)]=null,console[_0x4acdec(0xa3)]('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x563a42=this['paymentTimers'][_0x4acdec(0xf2)];for(const [_0x722477]of this[_0x4acdec(0x122)]){this[_0x4acdec(0x169)](_0x722477);}console['log'](_0x4acdec(0xba)+_0x563a42+_0x4acdec(0xb6));}async[a37_0x1abfed(0x168)](){const _0x5a5bea=a37_0x1abfed;try{console[_0x5a5bea(0xa3)](_0x5a5bea(0xa9));const _0x42f6e7=await database_1[_0x5a5bea(0x16d)]['payment'][_0x5a5bea(0xe6)]({'where':{'gateway':_0x5a5bea(0xd6),'status':_0x5a5bea(0x12e),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x5a5bea(0xa3)](_0x5a5bea(0x12a)+_0x42f6e7[_0x5a5bea(0x10f)]+'\x20pending\x20CoinToPay\x20payments');if(_0x42f6e7[_0x5a5bea(0x10f)]===0x0){console['log'](_0x5a5bea(0x134));return;}const _0x4d3dd8=await this[_0x5a5bea(0xfe)](_0x42f6e7);console[_0x5a5bea(0xa3)](_0x5a5bea(0x16e)+_0x4d3dd8[_0x5a5bea(0x10f)]+_0x5a5bea(0x113));let _0x164b42=0x0,_0x59d630=0x0;for(const _0x3187b5 of _0x42f6e7){try{if(_0x4d3dd8[_0x5a5bea(0x82)](_0x3187b5['id'])){console[_0x5a5bea(0xa3)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x3187b5['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x59d630++;continue;}if(this[_0x5a5bea(0x122)][_0x5a5bea(0x124)](_0x3187b5['id'])){console[_0x5a5bea(0xa3)](_0x5a5bea(0xc9)+_0x3187b5['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x59d630++;continue;}const _0xdc88f=(Date[_0x5a5bea(0x151)]()-_0x3187b5[_0x5a5bea(0x12c)][_0x5a5bea(0xf7)]())/(0x3e8*0x3c*0x3c);if(_0xdc88f<0x1){console['log'](_0x5a5bea(0xc9)+_0x3187b5['id']+_0x5a5bea(0x111)+_0xdc88f[_0x5a5bea(0x90)](0x1)+_0x5a5bea(0xb9)),_0x59d630++;continue;}console['log'](_0x5a5bea(0x140)+_0x3187b5['id']+'\x20(age:\x20'+_0xdc88f[_0x5a5bea(0x90)](0x1)+'h)'),await this[_0x5a5bea(0x97)](_0x3187b5),_0x164b42++,await new Promise(_0x331e18=>setTimeout(_0x331e18,0x7d0));}catch(_0x46547e){console[_0x5a5bea(0x11a)](_0x5a5bea(0x15e)+_0x3187b5['id']+':',_0x46547e),this[_0x5a5bea(0x86)](_0x3187b5['id'],_0x3187b5['gatewayPaymentId']||_0x5a5bea(0x12d),_0x46547e,_0x5a5bea(0xaa),{'isGlobalCheck':!![],'paymentAmount':_0x3187b5[_0x5a5bea(0x7d)],'paymentCurrency':_0x3187b5['currency'],'shopId':_0x3187b5[_0x5a5bea(0x130)],'createdAt':_0x3187b5[_0x5a5bea(0x12c)]}),loggerService_1[_0x5a5bea(0x8c)][_0x5a5bea(0x114)](_0x5a5bea(0xd6),_0x5a5bea(0xce)+_0x3187b5[_0x5a5bea(0x85)],_0x46547e);}}console['log'](_0x5a5bea(0x88)+_0x164b42+_0x5a5bea(0xc4)+_0x59d630+_0x5a5bea(0xcd)+_0x4d3dd8['length']+_0x5a5bea(0xf0));}catch(_0x3fa78d){console['error'](_0x5a5bea(0xda),_0x3fa78d);}}async[a37_0x1abfed(0xfe)](_0x428e26){const _0x19a356=a37_0x1abfed,_0x4659b2=[],_0x1819f8=new Date();_0x1819f8[_0x19a356(0x11b)](_0x1819f8[_0x19a356(0x165)]()-this[_0x19a356(0x153)]),console[_0x19a356(0xa3)](_0x19a356(0x16a)+this[_0x19a356(0x153)]+_0x19a356(0x142)+_0x1819f8['toISOString']()+')');for(const _0x292df5 of _0x428e26){if(_0x292df5[_0x19a356(0x12c)]<_0x1819f8){console[_0x19a356(0xa3)](_0x19a356(0x104)+_0x292df5['id']+_0x19a356(0x9f)+this[_0x19a356(0x153)]+_0x19a356(0xb0));try{this['logCoinToPayStatus'](_0x292df5['id'],_0x292df5['gatewayPaymentId']||_0x19a356(0x12d),_0x19a356(0x12e),_0x19a356(0x144),_0x19a356(0x115),{'reason':_0x19a356(0xe4)+this['EXPIRY_DAYS']+_0x19a356(0x160),'createdAt':_0x292df5['createdAt'],'daysSinceCreation':Math[_0x19a356(0x149)]((Date[_0x19a356(0x151)]()-_0x292df5[_0x19a356(0x12c)][_0x19a356(0xf7)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x292df5['amount'],'paymentCurrency':_0x292df5[_0x19a356(0x8b)],'shopId':_0x292df5[_0x19a356(0x130)]}),await database_1[_0x19a356(0x16d)]['payment']['update']({'where':{'id':_0x292df5['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x19a356(0x164)+this[_0x19a356(0x153)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x19a356(0x16d)][_0x19a356(0x11f)][_0x19a356(0xbf)]({'data':{'paymentId':_0x292df5['id'],'shopId':_0x292df5['shopId'],'event':_0x19a356(0xac),'statusCode':0xc8,'responseBody':JSON[_0x19a356(0x156)]({'reason':_0x19a356(0xe4)+this[_0x19a356(0x153)]+'\x20days','createdAt':_0x292df5[_0x19a356(0x12c)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math['floor']((Date['now']()-_0x292df5[_0x19a356(0x12c)][_0x19a356(0xf7)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x19a356(0xeb)](_0x292df5,_0x19a356(0x144)),await this[_0x19a356(0xbc)](_0x292df5,'EXPIRED'),this[_0x19a356(0x169)](_0x292df5['id']),_0x4659b2['push'](_0x292df5['id']),console['log']('✅\x20[EXPIRY]\x20Payment\x20'+_0x292df5['id']+_0x19a356(0xe0)+this['EXPIRY_DAYS']+_0x19a356(0x91));}catch(_0x4bf0c4){console[_0x19a356(0x11a)]('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x292df5['id']+':',_0x4bf0c4),this[_0x19a356(0x86)](_0x292df5['id'],_0x292df5[_0x19a356(0x85)]||_0x19a356(0x12d),_0x4bf0c4,_0x19a356(0x115),{'reason':_0x19a356(0x15b),'createdAt':_0x292df5['createdAt'],'daysSinceCreation':Math[_0x19a356(0x149)]((Date[_0x19a356(0x151)]()-_0x292df5[_0x19a356(0x12c)][_0x19a356(0xf7)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x4659b2;}async[a37_0x1abfed(0x97)](_0x156cb7){const _0x59b8c9=a37_0x1abfed;if(!_0x156cb7['gatewayPaymentId']){console[_0x59b8c9(0xa3)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x156cb7['id']+_0x59b8c9(0xc2));return;}console['log'](_0x59b8c9(0xfd)+_0x156cb7['id']+'\x20('+_0x156cb7['gatewayPaymentId']+')');try{const _0x40f48f=await this[_0x59b8c9(0x10c)][_0x59b8c9(0x143)](_0x156cb7[_0x59b8c9(0x85)]);console[_0x59b8c9(0xa3)](_0x59b8c9(0xf8)+_0x156cb7['id']+'\x20status:\x20'+_0x40f48f[_0x59b8c9(0xf6)]);_0x40f48f[_0x59b8c9(0x132)]&&console[_0x59b8c9(0xa3)](_0x59b8c9(0xf8)+_0x156cb7['id']+_0x59b8c9(0x16b),{'iban':_0x40f48f[_0x59b8c9(0x132)]['iban']||_0x59b8c9(0x145),'transactionId':_0x40f48f[_0x59b8c9(0x132)][_0x59b8c9(0xaf)],'createdOn':_0x40f48f[_0x59b8c9(0x132)]['createdOn'],'confirmedOn':_0x40f48f[_0x59b8c9(0x132)][_0x59b8c9(0x112)]||_0x59b8c9(0xae)});if(_0x40f48f[_0x59b8c9(0xf6)]!==_0x156cb7[_0x59b8c9(0xf6)]){console['log'](_0x59b8c9(0x105)+_0x156cb7['id']+_0x59b8c9(0x166)+_0x156cb7[_0x59b8c9(0xf6)]+_0x59b8c9(0x119)+_0x40f48f[_0x59b8c9(0xf6)]),this[_0x59b8c9(0xb4)](_0x156cb7['id'],_0x156cb7[_0x59b8c9(0x85)],_0x156cb7[_0x59b8c9(0xf6)],_0x40f48f[_0x59b8c9(0xf6)],_0x59b8c9(0xaa),{'paymentDetails':_0x40f48f[_0x59b8c9(0x132)],'amount':_0x40f48f[_0x59b8c9(0x7d)],'currency':_0x40f48f[_0x59b8c9(0x8b)],'shopId':_0x156cb7['shopId'],'checkTimestamp':new Date()[_0x59b8c9(0x154)]()});const _0x1fa1a3={'status':_0x40f48f['status'],'updatedAt':new Date()};_0x40f48f[_0x59b8c9(0xf6)]==='PAID'&&_0x156cb7[_0x59b8c9(0xf6)]!==_0x59b8c9(0xd9)&&(_0x1fa1a3[_0x59b8c9(0x118)]=new Date(),console[_0x59b8c9(0xa3)](_0x59b8c9(0x80)+_0x156cb7['id']+_0x59b8c9(0x93)+_0x1fa1a3[_0x59b8c9(0x118)][_0x59b8c9(0x154)]()));if(_0x40f48f['paymentDetails']){const _0x3ff27d=_0x40f48f[_0x59b8c9(0x132)];_0x3ff27d[_0x59b8c9(0x11e)]&&(_0x1fa1a3[_0x59b8c9(0x16c)]=_0x3ff27d[_0x59b8c9(0x11e)],console['log'](_0x59b8c9(0x107)+_0x3ff27d[_0x59b8c9(0x11e)]));if(_0x3ff27d['bankDetails']){const _0x19b31b=_0x156cb7['adminNotes']||'',_0x3f3d4a=_0x59b8c9(0x81)+_0x3ff27d['bankDetails'];_0x1fa1a3[_0x59b8c9(0x138)]=_0x19b31b?_0x19b31b+'\x0a\x0a'+_0x3f3d4a:_0x3f3d4a,console['log'](_0x59b8c9(0xd3));}_0x3ff27d[_0x59b8c9(0xaf)]&&console['log']('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x3ff27d[_0x59b8c9(0xaf)]),_0x3ff27d[_0x59b8c9(0x112)]&&console['log']('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x3ff27d[_0x59b8c9(0x112)]);}await database_1[_0x59b8c9(0x16d)][_0x59b8c9(0x136)][_0x59b8c9(0x155)]({'where':{'id':_0x156cb7['id']},'data':_0x1fa1a3}),await database_1[_0x59b8c9(0x16d)][_0x59b8c9(0x11f)][_0x59b8c9(0xbf)]({'data':{'paymentId':_0x156cb7['id'],'shopId':_0x156cb7[_0x59b8c9(0x130)],'event':_0x59b8c9(0x8f)+_0x40f48f[_0x59b8c9(0xf6)][_0x59b8c9(0x117)](),'statusCode':0xc8,'responseBody':JSON[_0x59b8c9(0x156)]({'oldStatus':_0x156cb7[_0x59b8c9(0xf6)],'newStatus':_0x40f48f[_0x59b8c9(0xf6)],'paymentDetails':_0x40f48f[_0x59b8c9(0x132)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x59b8c9(0xeb)](_0x156cb7,_0x40f48f[_0x59b8c9(0xf6)]),await this[_0x59b8c9(0xbc)](_0x156cb7,_0x40f48f[_0x59b8c9(0xf6)]),_0x40f48f[_0x59b8c9(0xf6)]!==_0x59b8c9(0x12e)&&(console['log'](_0x59b8c9(0x7e)+_0x156cb7['id']+_0x59b8c9(0x14d)+_0x40f48f['status']+_0x59b8c9(0x125)),this[_0x59b8c9(0x169)](_0x156cb7['id'])),console[_0x59b8c9(0xa3)](_0x59b8c9(0xfb)+_0x156cb7['id']+_0x59b8c9(0xcf));}else console[_0x59b8c9(0xa3)](_0x59b8c9(0xf8)+_0x156cb7['id']+_0x59b8c9(0x116)+_0x40f48f[_0x59b8c9(0xf6)]+')'),this['logCoinToPayStatus'](_0x156cb7['id'],_0x156cb7['gatewayPaymentId'],_0x156cb7[_0x59b8c9(0xf6)],_0x40f48f['status'],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x40f48f['paymentDetails'],'amount':_0x40f48f[_0x59b8c9(0x7d)],'currency':_0x40f48f[_0x59b8c9(0x8b)],'shopId':_0x156cb7[_0x59b8c9(0x130)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x150c15){console[_0x59b8c9(0x11a)](_0x59b8c9(0x10a)+_0x156cb7['id']+':',_0x150c15),this[_0x59b8c9(0x86)](_0x156cb7['id'],_0x156cb7[_0x59b8c9(0x85)],_0x150c15,_0x59b8c9(0xaa),{'paymentAmount':_0x156cb7[_0x59b8c9(0x7d)],'paymentCurrency':_0x156cb7[_0x59b8c9(0x8b)],'shopId':_0x156cb7[_0x59b8c9(0x130)],'createdAt':_0x156cb7['createdAt']}),await database_1[_0x59b8c9(0x16d)][_0x59b8c9(0x11f)][_0x59b8c9(0xbf)]({'data':{'paymentId':_0x156cb7['id'],'shopId':_0x156cb7[_0x59b8c9(0x130)],'event':_0x59b8c9(0xc5),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x150c15 instanceof Error?_0x150c15['message']:_0x59b8c9(0x9d),'gatewayPaymentId':_0x156cb7[_0x59b8c9(0x85)],'checkedAt':new Date()[_0x59b8c9(0x154)]()})}});}}async[a37_0x1abfed(0xeb)](_0x3b10d9,_0x4cc995){const _0x4f967f=a37_0x1abfed,_0x11c3b2=Date['now']();try{const _0x360547=_0x3b10d9[_0x4f967f(0x89)],_0x49ed5f=_0x360547[_0x4f967f(0xbe)];if(!_0x49ed5f?.['webhookUrl']){console[_0x4f967f(0xa3)](_0x4f967f(0xfa)+_0x360547['id']);return;}const _0x518107=_0x4cc995===_0x4f967f(0xd9)?_0x4f967f(0x9a):_0x4cc995==='FAILED'?_0x4f967f(0x135):_0x4cc995===_0x4f967f(0x144)?_0x4f967f(0x135):'payment.pending';if(!_0x49ed5f[_0x4f967f(0x123)]?.['includes'](_0x518107)){console[_0x4f967f(0xa3)](_0x4f967f(0xb5)+_0x518107+_0x4f967f(0x14f)+_0x360547['id']);return;}const _0x553b12={'event':_0x518107,'payment':{'id':_0x3b10d9['id'],'order_id':_0x3b10d9[_0x4f967f(0x13b)],'gateway_order_id':_0x3b10d9[_0x4f967f(0x10d)],'gateway':_0x4f967f(0xa0),'amount':_0x3b10d9[_0x4f967f(0x7d)],'currency':_0x3b10d9[_0x4f967f(0x8b)],'status':_0x4cc995['toLowerCase'](),'customer_email':_0x3b10d9[_0x4f967f(0xe2)],'customer_name':_0x3b10d9['customerName'],'created_at':_0x3b10d9[_0x4f967f(0x12c)],'updated_at':new Date()}},_0x304ff3=await fetch(_0x49ed5f[_0x4f967f(0xee)],{'method':_0x4f967f(0x128),'headers':{'Content-Type':_0x4f967f(0x15c),'User-Agent':_0x4f967f(0x103)},'body':JSON['stringify'](_0x553b12)}),_0x47c1dc=Date[_0x4f967f(0x151)]()-_0x11c3b2,_0x426e22=_0x304ff3['ok']?_0x4f967f(0x102):await _0x304ff3[_0x4f967f(0x109)]();loggerService_1[_0x4f967f(0x8c)][_0x4f967f(0x9e)](_0x3b10d9[_0x4f967f(0x130)],_0x49ed5f[_0x4f967f(0xee)],_0x518107,_0x304ff3['status'],_0x47c1dc,_0x553b12),console['log'](_0x4f967f(0x141)+_0x49ed5f['webhookUrl']+_0x4f967f(0x159)+_0x304ff3[_0x4f967f(0xf6)]+'\x20('+_0x47c1dc+'ms)');}catch(_0x8c3654){console[_0x4f967f(0x11a)](_0x4f967f(0xb3),_0x8c3654),loggerService_1[_0x4f967f(0x8c)][_0x4f967f(0xbd)](_0x3b10d9[_0x4f967f(0x130)],_0x3b10d9[_0x4f967f(0x89)]?.[_0x4f967f(0xbe)]?.[_0x4f967f(0xee)]||'unknown',_0x4f967f(0x13f),_0x8c3654,{});}}async['sendPaymentStatusNotification'](_0x2ad7a3,_0x2e0196){const _0xf47566=a37_0x1abfed;try{const _0x361abb={'PENDING':'created','PAID':_0xf47566(0x13a),'FAILED':_0xf47566(0xd4),'EXPIRED':'expired'},_0x122c94=_0x361abb[_0x2e0196];if(!_0x122c94||_0x122c94===_0xf47566(0xd0))return;await telegramBotService_1[_0xf47566(0x126)][_0xf47566(0x98)](_0x2ad7a3['shopId'],_0x2ad7a3,_0x122c94);}catch(_0x5789d0){console[_0xf47566(0x11a)](_0xf47566(0x163),_0x5789d0);}}async[a37_0x1abfed(0xd8)](_0x45d83b){const _0x47dc2f=a37_0x1abfed;console[_0x47dc2f(0xa3)](_0x47dc2f(0x10b)+_0x45d83b);const _0x1d5bfb=await database_1['default'][_0x47dc2f(0x136)][_0x47dc2f(0x15a)]({'where':{'id':_0x45d83b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1d5bfb)throw new Error(_0x47dc2f(0xc1));if(_0x1d5bfb['gateway']!==_0x47dc2f(0xd6))throw new Error(_0x47dc2f(0xcc));console[_0x47dc2f(0xa3)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x45d83b),await this['checkSinglePayment'](_0x1d5bfb),console['log'](_0x47dc2f(0x158)+_0x45d83b);}['getServiceStats'](){const _0x49e339=a37_0x1abfed,_0x5c681f=this[_0x49e339(0x12f)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x42c759=Array['from'](this[_0x49e339(0x122)][_0x49e339(0x150)]())[_0x49e339(0x133)](_0xc9067c=>({'paymentId':_0xc9067c[_0x49e339(0xea)],'gatewayPaymentId':_0xc9067c[_0x49e339(0x85)],'createdAt':_0xc9067c[_0x49e339(0x12c)],'timersCount':_0xc9067c[_0x49e339(0x8e)]['length']}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x49e339(0x137)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this['paymentTimers'][_0x49e339(0xf2)],'nextGlobalCheckIn':_0x5c681f,'paymentTimersDetails':_0x42c759};}[a37_0x1abfed(0x84)](_0x565c70){const _0x245c44=a37_0x1abfed,_0x2b33b6=this['paymentTimers'][_0x245c44(0x167)](_0x565c70);if(_0x2b33b6)return{'hasTimers':!![],'timersCount':_0x2b33b6[_0x245c44(0x8e)]['length'],'createdAt':_0x2b33b6['createdAt'],'gatewayPaymentId':_0x2b33b6[_0x245c44(0x85)]};return{'hasTimers':![]};}}exports[a37_0x1abfed(0xb7)]=CoinToPayStatusService,exports[a37_0x1abfed(0x96)]=new CoinToPayStatusService();function a37_0x32a8(){const _0x3fd08e=['🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','floor','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20->\x20','message','\x20status\x20changed\x20to\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20not\x20enabled\x20for\x20shop\x20','values','now','\x20\x20\x20📍\x20Source:\x20','EXPIRY_DAYS','toISOString','update','stringify','⚠️\x20[CHECK]\x20Payment\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20with\x20status\x20','findUnique','Failed\x20to\x20mark\x20payment\x20as\x20expired','application/json','2552FlvYPx','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20found:','\x20days','🧹\x20[DEBUG]\x20Clearing\x20','\x20\x20\x20📅\x20Time:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Automatically\x20expired\x20after\x20','getDate','\x20status\x20from\x20','get','checkAllPendingPayments','clearPaymentTimers','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20details:','remitterIban','default','⏰\x20[GLOBAL]\x20Found\x20','\x20seconds\x20(','__importDefault','amount','🧹\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20Gateway:\x20','💰\x20[CHECK]\x20Payment\x20','Bank\x20Details:\x20','includes','❌\x20[HOURLY]\x20Payment\x20','getPaymentTimerInfo','gatewayPaymentId','logCoinToPayError','delete','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','shop','🪙\x20[TIMER]\x20Individual\x20check\x20#','currency','loggerService','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','timers','cointopay_status_check_','toFixed','-day\x20timeout','1478FnsmPE','\x20marked\x20as\x20paid\x20at:\x20','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','10403136XvtZIE','coinToPayStatusService','checkSinglePayment','sendPaymentNotification','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','payment.success','\x20\x20\x20📊\x20Status:\x20','schedulePaymentChecks','Unknown\x20error','logShopWebhookSent','\x20is\x20older\x20than\x20','0100','description','\x20is\x20valid\x20for\x20checking,\x20proceeding...','log','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','7077lnZanm','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20\x20\x20📝\x20Context:','defineProperty','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','status_check','42894WwWvML','cointopay_auto_expired','\x20\x20\x20-\x20ShopId:\x20','not\x20confirmed','transactionId','\x20days,\x20marking\x20as\x20EXPIRED','set','./loggerService','Failed\x20to\x20send\x20shop\x20webhook:','logCoinToPayStatus','Webhook\x20event\x20','\x20individual\x20payment\x20timers','CoinToPayStatusService','241YSsmmP','h),\x20skipping\x20global\x20check','🛑\x20[SHUTDOWN]\x20Cleared\x20','1\x20minute','sendPaymentStatusNotification','logShopWebhookError','settings','create','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','Payment\x20not\x20found','\x20has\x20no\x20gatewayPaymentId,\x20skipping','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20checked,\x20','cointopay_status_check_error','delay','\x20status\x20is\x20','\x20not\x20found,\x20clearing\x20timers','⏰\x20[GLOBAL]\x20Payment\x20','gateway','\x20\x20\x20📝\x20Details:','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20skipped,\x20','/status/','\x20updated\x20successfully','created','🪙\x20[DEBUG]\x20Creating\x20','⏰\x20[HOURLY]\x20Payment\x20','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','failed','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','cointopay','\x20current\x20status:\x20','checkPaymentById','PAID','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20has\x20no\x20gatewayPaymentId','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','6HlXMfi','11qehMkH','push','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','customerEmail','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','Payment\x20older\x20than\x20','__esModule','findMany','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','schedule_created','paymentId','sendShopWebhook','forEach','\x20\x20\x20-\x20Amount:\x20','webhookUrl','746895MBvPqr','\x20expired','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','size','\x20not\x20found\x20in\x20database','\x20\x20\x20-\x20GatewayPaymentId:\x20','1974855yNHQpM','status','getTime','📊\x20[CHECK]\x20Payment\x20','1173024GXGnCb','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','✅\x20[CHECK]\x20Payment\x20','stack','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','checkExpiredPayments','🪙\x20CoinToPayStatusService\x20initialized','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','CoinToPayService','Success','TesSoft\x20Payment\x20System/1.0','⏰\x20[EXPIRY]\x20Payment\x20','🔄\x20[CHECK]\x20Updating\x20payment\x20','./telegramBotService','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','./gateways/coinToPayService','text','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','coinToPayService','gatewayOrderId',',\x20stopping\x20individual\x20checks','length','✅\x20[TIMER]\x20Individual\x20check\x20#','\x20is\x20too\x20new\x20(','confirmedOn','\x20expired\x20CoinToPay\x20payments','logWhiteDomainError','auto_expire','\x20status\x20unchanged\x20(','toLowerCase','paidAt','\x20to\x20','error','setDate','5\x20minutes','\x20\x20\x20-\x20gatewayPaymentId:\x20','iban','webhookLog','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','❌\x20[CHECK]\x20Payment\x20','paymentTimers','webhookEvents','has',',\x20clearing\x20individual\x20timers','telegramBotService','timestamp','POST','checkSinglePaymentById','🪙\x20[GLOBAL]\x20Found\x20','330rlUgve','createdAt','unknown','PENDING','globalCheckInterval','shopId','\x20\x20\x20-\x20paymentId:\x20','paymentDetails','map','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','payment.failed','payment','GLOBAL_CHECK_INTERVAL_MS','adminNotes','\x20for\x20payment\x20','paid','orderId','../config/database','✅\x20[HOURLY]\x20Payment\x20','\x20\x20\x20❌\x20Error:\x20','webhook_send','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','Shop\x20webhook\x20sent\x20to\x20','\x20days\x20(created\x20before\x20','checkPaymentStatus','EXPIRED','not\x20found','stopPeriodicStatusCheck','📊\x20[HOURLY]\x20Payment\x20'];a37_0x32a8=function(){return _0x3fd08e;};return a37_0x32a8();}