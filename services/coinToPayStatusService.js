'use strict';const a35_0x33f45a=a35_0x237a;(function(_0x48b92c,_0x110158){const _0x5875f3=a35_0x237a,_0x3b524c=_0x48b92c();while(!![]){try{const _0x552b03=parseInt(_0x5875f3(0x1b0))/0x1*(-parseInt(_0x5875f3(0x127))/0x2)+parseInt(_0x5875f3(0x1ad))/0x3+-parseInt(_0x5875f3(0x106))/0x4+-parseInt(_0x5875f3(0x1bc))/0x5+-parseInt(_0x5875f3(0x1b9))/0x6*(parseInt(_0x5875f3(0xff))/0x7)+-parseInt(_0x5875f3(0xfb))/0x8+parseInt(_0x5875f3(0x152))/0x9*(parseInt(_0x5875f3(0x13c))/0xa);if(_0x552b03===_0x110158)break;else _0x3b524c['push'](_0x3b524c['shift']());}catch(_0x247e91){_0x3b524c['push'](_0x3b524c['shift']());}}}(a35_0x13f3,0x1a4dc));var __importDefault=this&&this['__importDefault']||function(_0x370512){const _0x147a8e=a35_0x237a;return _0x370512&&_0x370512[_0x147a8e(0xed)]?_0x370512:{'default':_0x370512};};Object['defineProperty'](exports,a35_0x33f45a(0xed),{'value':!![]}),exports[a35_0x33f45a(0x148)]=exports[a35_0x33f45a(0x168)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a35_0x33f45a(0x185))),telegramBotService_1=require(a35_0x33f45a(0xf9)),loggerService_1=require(a35_0x33f45a(0x131));function a35_0x237a(_0x3c4d77,_0x34a415){const _0x13f36c=a35_0x13f3();return a35_0x237a=function(_0x237a88,_0x515ac4){_0x237a88=_0x237a88-0xea;let _0x1f44f2=_0x13f36c[_0x237a88];return _0x1f44f2;},a35_0x237a(_0x3c4d77,_0x34a415);}class CoinToPayStatusService{constructor(){const _0x52badc=a35_0x33f45a;this[_0x52badc(0x105)]=null,this[_0x52badc(0x132)]=0x3c*0x3c*0x3e8,this[_0x52badc(0x15a)]=0x5,this['paymentTimers']=new Map(),this[_0x52badc(0x1a1)]=new coinToPayService_1[(_0x52badc(0x169))](),console[_0x52badc(0x16c)](_0x52badc(0x114));}[a35_0x33f45a(0x110)](_0x4bfa63,_0x154683){const _0x28c29a=a35_0x33f45a;console[_0x28c29a(0x16c)](_0x28c29a(0x144)),console[_0x28c29a(0x16c)]('\x20\x20\x20-\x20paymentId:\x20'+_0x4bfa63),console[_0x28c29a(0x16c)](_0x28c29a(0x17e)+_0x154683),this['clearPaymentTimers'](_0x4bfa63);const _0x3861db=[],_0x5d69c1=new Date(),_0x40137a=[{'delay':0x1*0x3c*0x3e8,'description':_0x28c29a(0xfd)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x28c29a(0x1c2)},{'delay':0x5*0x3c*0x3e8,'description':_0x28c29a(0x1c2)}];console[_0x28c29a(0x16c)]('ü™ô\x20[DEBUG]\x20Creating\x20'+_0x40137a[_0x28c29a(0x153)]+_0x28c29a(0x135)+_0x4bfa63);let _0x574790=0x0;_0x40137a['forEach']((_0x2158c0,_0x428a59)=>{const _0x3e92f7=_0x28c29a;_0x574790+=_0x2158c0[_0x3e92f7(0x11c)];const _0x58def1=setTimeout(async()=>{const _0x26389c=_0x3e92f7;console[_0x26389c(0x16c)](_0x26389c(0x1b7)+(_0x428a59+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x4bfa63+_0x26389c(0x180)+_0x2158c0[_0x26389c(0x18c)]+')');try{await this[_0x26389c(0x1bf)](_0x4bfa63),console[_0x26389c(0x16c)](_0x26389c(0x162)+(_0x428a59+0x1)+_0x26389c(0x156)+_0x4bfa63);}catch(_0x5f0074){console['error']('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x428a59+0x1)+_0x26389c(0x1a5)+_0x4bfa63+':',_0x5f0074),this[_0x26389c(0x18f)](_0x4bfa63,_0x154683,_0x5f0074,_0x26389c(0x1b3),{'checkNumber':_0x428a59+0x1,'scheduledAfter':_0x2158c0['description'],'isIndividualCheck':!![]});}},_0x574790);_0x3861db[_0x3e92f7(0xf7)](_0x58def1),console[_0x3e92f7(0x16c)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x428a59+0x1)+_0x3e92f7(0x1a5)+_0x4bfa63+_0x3e92f7(0x11f)+_0x574790/0x3e8+_0x3e92f7(0x1aa)+_0x2158c0[_0x3e92f7(0x18c)]+')');});const _0x34b072=setInterval(async()=>{const _0x10caa5=_0x28c29a;console[_0x10caa5(0x16c)](_0x10caa5(0x1c9)+_0x4bfa63);try{const _0x2473b6=await database_1[_0x10caa5(0x1bd)][_0x10caa5(0x118)][_0x10caa5(0x1a0)]({'where':{'id':_0x4bfa63},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x2473b6){console[_0x10caa5(0x16c)](_0x10caa5(0x1c7)+_0x4bfa63+'\x20not\x20found,\x20clearing\x20timers'),this[_0x10caa5(0x125)](_0x4bfa63);return;}console[_0x10caa5(0x16c)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x4bfa63+'\x20current\x20status:\x20'+_0x2473b6['status']);if(_0x2473b6[_0x10caa5(0x158)]!==_0x10caa5(0x1be)){console[_0x10caa5(0x16c)](_0x10caa5(0x1c4)+_0x4bfa63+'\x20status\x20is\x20'+_0x2473b6[_0x10caa5(0x158)]+',\x20stopping\x20individual\x20checks'),this[_0x10caa5(0x125)](_0x4bfa63);return;}const _0x55836e=Math[_0x10caa5(0x179)]((Date['now']()-_0x2473b6[_0x10caa5(0x16b)][_0x10caa5(0xeb)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x55836e>=this[_0x10caa5(0x15a)]){console[_0x10caa5(0x16c)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x4bfa63+_0x10caa5(0x17b)+this[_0x10caa5(0x15a)]+_0x10caa5(0x196)),this[_0x10caa5(0x125)](_0x4bfa63);return;}await this[_0x10caa5(0x1bf)](_0x4bfa63),console['log'](_0x10caa5(0x11b)+_0x4bfa63);}catch(_0x140fd6){console[_0x10caa5(0x18a)](_0x10caa5(0x194)+_0x4bfa63+':',_0x140fd6),this[_0x10caa5(0x18f)](_0x4bfa63,_0x154683,_0x140fd6,_0x10caa5(0x1b3),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3861db['push'](_0x34b072),this['paymentTimers'][_0x28c29a(0x166)](_0x4bfa63,{'timers':_0x3861db,'paymentId':_0x4bfa63,'gatewayPaymentId':_0x154683,'createdAt':_0x5d69c1}),console[_0x28c29a(0x16c)]('‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x40137a[_0x28c29a(0x153)]+_0x28c29a(0x175)+_0x4bfa63),console['log'](_0x28c29a(0x17a)+this['paymentTimers'][_0x28c29a(0xf2)]),this['logCoinToPayStatus'](_0x4bfa63,_0x154683,_0x28c29a(0x1be),_0x28c29a(0x1be),_0x28c29a(0x1b3),{'action':_0x28c29a(0x124),'scheduledChecks':_0x40137a[_0x28c29a(0x153)],'firstCheckIn':_0x40137a[0x0][_0x28c29a(0x11c)]/0x3e8,'totalTimers':this[_0x28c29a(0x19f)][_0x28c29a(0xf2)]});}[a35_0x33f45a(0x125)](_0x2f6cb5){const _0x340217=a35_0x33f45a,_0xdbb33d=this['paymentTimers'][_0x340217(0x171)](_0x2f6cb5);_0xdbb33d?(console[_0x340217(0x16c)]('üßπ\x20[DEBUG]\x20Clearing\x20'+_0xdbb33d['timers']['length']+_0x340217(0x198)+_0x2f6cb5),_0xdbb33d[_0x340217(0x14f)][_0x340217(0x104)]((_0x1c307f,_0xfaf788)=>{const _0x392754=_0x340217;_0x1c307f&&(clearTimeout(_0x1c307f),clearInterval(_0x1c307f),console[_0x392754(0x16c)](_0x392754(0x136)+(_0xfaf788+0x1)+_0x392754(0x1a5)+_0x2f6cb5));}),this[_0x340217(0x19f)][_0x340217(0x1cc)](_0x2f6cb5),console[_0x340217(0x16c)](_0x340217(0x154)+_0x2f6cb5+_0x340217(0x19a)+this[_0x340217(0x19f)][_0x340217(0xf2)])):console['log'](_0x340217(0x14a)+_0x2f6cb5+_0x340217(0x137));}async[a35_0x33f45a(0x1bf)](_0xca0e82){const _0x26875=a35_0x33f45a;console[_0x26875(0x16c)](_0x26875(0x13b)+_0xca0e82);const _0x19d326=await database_1[_0x26875(0x1bd)][_0x26875(0x118)][_0x26875(0x1a0)]({'where':{'id':_0xca0e82},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x19d326){console[_0x26875(0x16c)]('‚ùå\x20[CHECK]\x20Payment\x20'+_0xca0e82+_0x26875(0x13e));return;}console[_0x26875(0x16c)](_0x26875(0x12b)+_0xca0e82+_0x26875(0x160)),console[_0x26875(0x16c)](_0x26875(0x199)+_0x19d326[_0x26875(0x143)]),console[_0x26875(0x16c)](_0x26875(0x190)+_0x19d326[_0x26875(0x158)]),console[_0x26875(0x16c)](_0x26875(0xef)+_0x19d326[_0x26875(0x103)]),console[_0x26875(0x16c)](_0x26875(0x159)+_0x19d326['amount']+'\x20'+_0x19d326['currency']),console[_0x26875(0x16c)](_0x26875(0x151)+_0x19d326[_0x26875(0xfc)]);if(_0x19d326[_0x26875(0x143)]!=='cointopay'){console['log'](_0x26875(0xfe)+_0xca0e82+_0x26875(0x16d)+_0x19d326[_0x26875(0x143)]+')');return;}if(_0x19d326['status']!=='PENDING'){console[_0x26875(0x16c)](_0x26875(0xfe)+_0xca0e82+_0x26875(0x17d)+_0x19d326[_0x26875(0x158)]+_0x26875(0x109)),this[_0x26875(0x125)](_0xca0e82);return;}if(!_0x19d326['gatewayPaymentId']){console['log'](_0x26875(0xfe)+_0xca0e82+_0x26875(0x10e));return;}console['log'](_0x26875(0x18b)+_0xca0e82+_0x26875(0x146)),await this[_0x26875(0x19c)](_0x19d326);}[a35_0x33f45a(0x126)](_0x4ae012,_0x3bf229,_0x392e38,_0x3f7319,_0x449b99,_0x31bae5){const _0x37569a=a35_0x33f45a,_0x40c3a8={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x4ae012,'gatewayPaymentId':_0x3bf229,'oldStatus':_0x392e38,'newStatus':_0x3f7319,'source':_0x449b99,'timestamp':new Date()[_0x37569a(0x111)](),'details':_0x31bae5||{}};loggerService_1[_0x37569a(0x12a)]['logCoinToPayStatus'](_0x40c3a8),console[_0x37569a(0x16c)](_0x37569a(0x1bb)+_0x4ae012+'\x20('+_0x3bf229+')'),console[_0x37569a(0x16c)](_0x37569a(0x1c1)+_0x392e38+'\x20->\x20'+_0x3f7319),console[_0x37569a(0x16c)]('\x20\x20\x20üìç\x20Source:\x20'+_0x449b99),console[_0x37569a(0x16c)](_0x37569a(0xf0)+_0x40c3a8[_0x37569a(0xf3)]),_0x31bae5&&console[_0x37569a(0x16c)](_0x37569a(0x140),_0x31bae5);}[a35_0x33f45a(0x18f)](_0x284b22,_0x36a9af,_0x4745cb,_0x4a98e5,_0xf8855e){const _0x27dc85=a35_0x33f45a,_0x23a6c4={'type':_0x27dc85(0x177),'paymentId':_0x284b22,'gatewayPaymentId':_0x36a9af,'error':_0x4745cb instanceof Error?{'message':_0x4745cb['message'],'stack':_0x4745cb[_0x27dc85(0x187)]}:_0x4745cb,'source':_0x4a98e5,'timestamp':new Date()[_0x27dc85(0x111)](),'context':_0xf8855e||{}};loggerService_1[_0x27dc85(0x12a)]['logCoinToPayError'](_0x23a6c4),console['error'](_0x27dc85(0x129)+_0x284b22+'\x20('+_0x36a9af+')'),console[_0x27dc85(0x18a)](_0x27dc85(0x15c)+(_0x4745cb instanceof Error?_0x4745cb[_0x27dc85(0x10b)]:_0x4745cb)),console[_0x27dc85(0x18a)](_0x27dc85(0x12c)+_0x4a98e5),console[_0x27dc85(0x18a)](_0x27dc85(0xf0)+_0x23a6c4[_0x27dc85(0xf3)]),_0xf8855e&&console['error'](_0x27dc85(0x17c),_0xf8855e);}[a35_0x33f45a(0x116)](){const _0x12be59=a35_0x33f45a;console[_0x12be59(0x16c)](_0x12be59(0x1b6)),this[_0x12be59(0x11e)]()[_0x12be59(0x15e)](_0x3ae2ef=>{const _0x1aad09=_0x12be59;console[_0x1aad09(0x18a)]('‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x3ae2ef);}),this['globalCheckInterval']=setInterval(async()=>{const _0x170b83=_0x12be59;try{console[_0x170b83(0x16c)](_0x170b83(0x1ce)),await this[_0x170b83(0x11e)](),console[_0x170b83(0x16c)](_0x170b83(0x142));}catch(_0x4d054e){console['error']('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x4d054e);}},this[_0x12be59(0x132)]),console['log'](_0x12be59(0x101));}[a35_0x33f45a(0x139)](){const _0x1a53ef=a35_0x33f45a;console[_0x1a53ef(0x16c)](_0x1a53ef(0xf8));this[_0x1a53ef(0x105)]&&(clearInterval(this[_0x1a53ef(0x105)]),this[_0x1a53ef(0x105)]=null,console[_0x1a53ef(0x16c)]('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x113cad=this['paymentTimers'][_0x1a53ef(0xf2)];for(const [_0x371089]of this[_0x1a53ef(0x19f)]){this['clearPaymentTimers'](_0x371089);}console[_0x1a53ef(0x16c)](_0x1a53ef(0x119)+_0x113cad+'\x20individual\x20payment\x20timers');}async[a35_0x33f45a(0x11e)](){const _0x50aea9=a35_0x33f45a;try{console['log'](_0x50aea9(0x14d));const _0x5be8ee=await database_1['default'][_0x50aea9(0x118)][_0x50aea9(0x189)]({'where':{'gateway':_0x50aea9(0x15b),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x50aea9(0x16c)](_0x50aea9(0x1ba)+_0x5be8ee[_0x50aea9(0x153)]+_0x50aea9(0x117));if(_0x5be8ee[_0x50aea9(0x153)]===0x0){console[_0x50aea9(0x16c)](_0x50aea9(0xf6));return;}const _0x4c48c2=await this[_0x50aea9(0x134)](_0x5be8ee);console['log'](_0x50aea9(0x10d)+_0x4c48c2[_0x50aea9(0x153)]+_0x50aea9(0x18d));let _0x1ab5ff=0x0,_0x1ff9b8=0x0;for(const _0x1c34e2 of _0x5be8ee){try{if(_0x4c48c2[_0x50aea9(0x167)](_0x1c34e2['id'])){console[_0x50aea9(0x16c)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x1c34e2['id']+_0x50aea9(0x113)),_0x1ff9b8++;continue;}if(this['paymentTimers']['has'](_0x1c34e2['id'])){console['log']('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x1c34e2['id']+_0x50aea9(0x128)),_0x1ff9b8++;continue;}const _0x5f657a=(Date[_0x50aea9(0x13a)]()-_0x1c34e2[_0x50aea9(0x16b)][_0x50aea9(0xeb)]())/(0x3e8*0x3c*0x3c);if(_0x5f657a<0x1){console[_0x50aea9(0x16c)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x1c34e2['id']+_0x50aea9(0x184)+_0x5f657a['toFixed'](0x1)+_0x50aea9(0x1b4)),_0x1ff9b8++;continue;}console[_0x50aea9(0x16c)]('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x1c34e2['id']+_0x50aea9(0x133)+_0x5f657a[_0x50aea9(0x12d)](0x1)+'h)'),await this['checkSinglePayment'](_0x1c34e2),_0x1ab5ff++,await new Promise(_0x4303c8=>setTimeout(_0x4303c8,0x7d0));}catch(_0x31f3b4){console['error'](_0x50aea9(0x195)+_0x1c34e2['id']+':',_0x31f3b4),this['logCoinToPayError'](_0x1c34e2['id'],_0x1c34e2[_0x50aea9(0x103)]||_0x50aea9(0x138),_0x31f3b4,_0x50aea9(0x1b3),{'isGlobalCheck':!![],'paymentAmount':_0x1c34e2['amount'],'paymentCurrency':_0x1c34e2[_0x50aea9(0xea)],'shopId':_0x1c34e2[_0x50aea9(0xfc)],'createdAt':_0x1c34e2['createdAt']}),loggerService_1[_0x50aea9(0x12a)][_0x50aea9(0x141)](_0x50aea9(0x15b),_0x50aea9(0x176)+_0x1c34e2[_0x50aea9(0x103)],_0x31f3b4);}}console[_0x50aea9(0x16c)](_0x50aea9(0x191)+_0x1ab5ff+_0x50aea9(0x123)+_0x1ff9b8+_0x50aea9(0x121)+_0x4c48c2['length']+_0x50aea9(0x172));}catch(_0x4ead34){console[_0x50aea9(0x18a)](_0x50aea9(0x15f),_0x4ead34);}}async[a35_0x33f45a(0x134)](_0xe5ad05){const _0x4b9730=a35_0x33f45a,_0x5a3589=[],_0x2de83d=new Date();_0x2de83d['setDate'](_0x2de83d['getDate']()-this[_0x4b9730(0x15a)]),console['log'](_0x4b9730(0x19d)+this[_0x4b9730(0x15a)]+'\x20days\x20(created\x20before\x20'+_0x2de83d['toISOString']()+')');for(const _0x1e511a of _0xe5ad05){if(_0x1e511a['createdAt']<_0x2de83d){console['log'](_0x4b9730(0x16f)+_0x1e511a['id']+_0x4b9730(0x17b)+this[_0x4b9730(0x15a)]+_0x4b9730(0x1c3));try{this[_0x4b9730(0x126)](_0x1e511a['id'],_0x1e511a[_0x4b9730(0x103)]||'unknown','PENDING','EXPIRED','auto_expire',{'reason':_0x4b9730(0x178)+this[_0x4b9730(0x15a)]+_0x4b9730(0x122),'createdAt':_0x1e511a[_0x4b9730(0x16b)],'daysSinceCreation':Math['floor']((Date[_0x4b9730(0x13a)]()-_0x1e511a[_0x4b9730(0x16b)][_0x4b9730(0xeb)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x1e511a[_0x4b9730(0x1c6)],'paymentCurrency':_0x1e511a[_0x4b9730(0xea)],'shopId':_0x1e511a[_0x4b9730(0xfc)]}),await database_1[_0x4b9730(0x1bd)][_0x4b9730(0x118)][_0x4b9730(0x1ca)]({'where':{'id':_0x1e511a['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x4b9730(0x192)+this['EXPIRY_DAYS']+_0x4b9730(0x161)}}),await database_1[_0x4b9730(0x1bd)][_0x4b9730(0x14b)]['create']({'data':{'paymentId':_0x1e511a['id'],'shopId':_0x1e511a[_0x4b9730(0xfc)],'event':_0x4b9730(0x10c),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x4b9730(0x178)+this[_0x4b9730(0x15a)]+_0x4b9730(0x122),'createdAt':_0x1e511a[_0x4b9730(0x16b)],'expiredAt':new Date()[_0x4b9730(0x111)](),'daysSinceCreation':Math[_0x4b9730(0x179)]((Date[_0x4b9730(0x13a)]()-_0x1e511a['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4b9730(0x108)](_0x1e511a,_0x4b9730(0x188)),await this['sendPaymentStatusNotification'](_0x1e511a,_0x4b9730(0x188)),this[_0x4b9730(0x125)](_0x1e511a['id']),_0x5a3589[_0x4b9730(0xf7)](_0x1e511a['id']),console[_0x4b9730(0x16c)](_0x4b9730(0x183)+_0x1e511a['id']+_0x4b9730(0x10f)+this[_0x4b9730(0x15a)]+_0x4b9730(0x14c));}catch(_0x3e9396){console['error'](_0x4b9730(0x170)+_0x1e511a['id']+':',_0x3e9396),this[_0x4b9730(0x18f)](_0x1e511a['id'],_0x1e511a[_0x4b9730(0x103)]||_0x4b9730(0x138),_0x3e9396,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x1e511a[_0x4b9730(0x16b)],'daysSinceCreation':Math['floor']((Date['now']()-_0x1e511a[_0x4b9730(0x16b)][_0x4b9730(0xeb)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5a3589;}async['checkSinglePayment'](_0x168f4a){const _0x5ac7bf=a35_0x33f45a;if(!_0x168f4a['gatewayPaymentId']){console[_0x5ac7bf(0x16c)](_0x5ac7bf(0xfe)+_0x168f4a['id']+_0x5ac7bf(0x1c5));return;}console[_0x5ac7bf(0x16c)](_0x5ac7bf(0x1ae)+_0x168f4a['id']+'\x20('+_0x168f4a[_0x5ac7bf(0x103)]+')');try{const _0x9ed77e=await this[_0x5ac7bf(0x1a1)][_0x5ac7bf(0x1a9)](_0x168f4a[_0x5ac7bf(0x103)]);console[_0x5ac7bf(0x16c)](_0x5ac7bf(0x12b)+_0x168f4a['id']+_0x5ac7bf(0x1a3)+_0x9ed77e[_0x5ac7bf(0x158)]);_0x9ed77e[_0x5ac7bf(0x193)]&&console[_0x5ac7bf(0x16c)](_0x5ac7bf(0x12b)+_0x168f4a['id']+'\x20details:',{'iban':_0x9ed77e[_0x5ac7bf(0x193)][_0x5ac7bf(0x17f)]||_0x5ac7bf(0x174),'transactionId':_0x9ed77e['paymentDetails'][_0x5ac7bf(0x181)],'createdOn':_0x9ed77e[_0x5ac7bf(0x193)][_0x5ac7bf(0x157)],'confirmedOn':_0x9ed77e[_0x5ac7bf(0x193)][_0x5ac7bf(0x173)]||_0x5ac7bf(0x1a4)});if(_0x9ed77e[_0x5ac7bf(0x158)]!==_0x168f4a[_0x5ac7bf(0x158)]){console[_0x5ac7bf(0x16c)](_0x5ac7bf(0x1b1)+_0x168f4a['id']+'\x20status\x20from\x20'+_0x168f4a[_0x5ac7bf(0x158)]+_0x5ac7bf(0x10a)+_0x9ed77e[_0x5ac7bf(0x158)]),this[_0x5ac7bf(0x126)](_0x168f4a['id'],_0x168f4a[_0x5ac7bf(0x103)],_0x168f4a['status'],_0x9ed77e['status'],_0x5ac7bf(0x1b3),{'paymentDetails':_0x9ed77e['paymentDetails'],'amount':_0x9ed77e[_0x5ac7bf(0x1c6)],'currency':_0x9ed77e[_0x5ac7bf(0xea)],'shopId':_0x168f4a[_0x5ac7bf(0xfc)],'checkTimestamp':new Date()[_0x5ac7bf(0x111)]()});const _0x289239={'status':_0x9ed77e[_0x5ac7bf(0x158)],'updatedAt':new Date()};_0x9ed77e[_0x5ac7bf(0x158)]===_0x5ac7bf(0x11a)&&_0x168f4a[_0x5ac7bf(0x158)]!==_0x5ac7bf(0x11a)&&(_0x289239[_0x5ac7bf(0x13f)]=new Date(),console[_0x5ac7bf(0x16c)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x168f4a['id']+_0x5ac7bf(0x19e)+_0x289239[_0x5ac7bf(0x13f)]['toISOString']()));if(_0x9ed77e[_0x5ac7bf(0x193)]){const _0xf79914=_0x9ed77e[_0x5ac7bf(0x193)];_0xf79914['iban']&&(_0x289239[_0x5ac7bf(0x14e)]=_0xf79914[_0x5ac7bf(0x17f)],console[_0x5ac7bf(0x16c)](_0x5ac7bf(0x18e)+_0xf79914[_0x5ac7bf(0x17f)]));if(_0xf79914[_0x5ac7bf(0x16e)]){const _0x425671=_0x168f4a[_0x5ac7bf(0x15d)]||'',_0x206ad5=_0x5ac7bf(0x1a8)+_0xf79914[_0x5ac7bf(0x16e)];_0x289239[_0x5ac7bf(0x15d)]=_0x425671?_0x425671+'\x0a\x0a'+_0x206ad5:_0x206ad5,console['log'](_0x5ac7bf(0x1c0));}_0xf79914[_0x5ac7bf(0x181)]&&console[_0x5ac7bf(0x16c)](_0x5ac7bf(0x145)+_0xf79914['transactionId']),_0xf79914[_0x5ac7bf(0x173)]&&console['log'](_0x5ac7bf(0x19b)+_0xf79914[_0x5ac7bf(0x173)]);}await database_1[_0x5ac7bf(0x1bd)]['payment'][_0x5ac7bf(0x1ca)]({'where':{'id':_0x168f4a['id']},'data':_0x289239}),await database_1[_0x5ac7bf(0x1bd)][_0x5ac7bf(0x14b)][_0x5ac7bf(0x155)]({'data':{'paymentId':_0x168f4a['id'],'shopId':_0x168f4a[_0x5ac7bf(0xfc)],'event':'cointopay_status_check_'+_0x9ed77e[_0x5ac7bf(0x158)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x5ac7bf(0x1ab)]({'oldStatus':_0x168f4a[_0x5ac7bf(0x158)],'newStatus':_0x9ed77e[_0x5ac7bf(0x158)],'paymentDetails':_0x9ed77e[_0x5ac7bf(0x193)],'checkedAt':new Date()[_0x5ac7bf(0x111)]()})}}),await this[_0x5ac7bf(0x108)](_0x168f4a,_0x9ed77e[_0x5ac7bf(0x158)]),await this['sendPaymentStatusNotification'](_0x168f4a,_0x9ed77e[_0x5ac7bf(0x158)]),_0x9ed77e['status']!==_0x5ac7bf(0x1be)&&(console['log'](_0x5ac7bf(0xee)+_0x168f4a['id']+'\x20status\x20changed\x20to\x20'+_0x9ed77e[_0x5ac7bf(0x158)]+_0x5ac7bf(0xf4)),this['clearPaymentTimers'](_0x168f4a['id'])),console[_0x5ac7bf(0x16c)](_0x5ac7bf(0x18b)+_0x168f4a['id']+'\x20updated\x20successfully');}else console[_0x5ac7bf(0x16c)](_0x5ac7bf(0x12b)+_0x168f4a['id']+'\x20status\x20unchanged\x20('+_0x9ed77e['status']+')'),this[_0x5ac7bf(0x126)](_0x168f4a['id'],_0x168f4a['gatewayPaymentId'],_0x168f4a[_0x5ac7bf(0x158)],_0x9ed77e[_0x5ac7bf(0x158)],_0x5ac7bf(0x1b3),{'statusUnchanged':!![],'paymentDetails':_0x9ed77e[_0x5ac7bf(0x193)],'amount':_0x9ed77e[_0x5ac7bf(0x1c6)],'currency':_0x9ed77e[_0x5ac7bf(0xea)],'shopId':_0x168f4a['shopId'],'checkTimestamp':new Date()['toISOString']()});}catch(_0x297d61){console[_0x5ac7bf(0x18a)]('‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x168f4a['id']+':',_0x297d61),this[_0x5ac7bf(0x18f)](_0x168f4a['id'],_0x168f4a['gatewayPaymentId'],_0x297d61,'status_check',{'paymentAmount':_0x168f4a[_0x5ac7bf(0x1c6)],'paymentCurrency':_0x168f4a[_0x5ac7bf(0xea)],'shopId':_0x168f4a[_0x5ac7bf(0xfc)],'createdAt':_0x168f4a[_0x5ac7bf(0x16b)]}),await database_1['default'][_0x5ac7bf(0x14b)][_0x5ac7bf(0x155)]({'data':{'paymentId':_0x168f4a['id'],'shopId':_0x168f4a[_0x5ac7bf(0xfc)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x5ac7bf(0x1ab)]({'error':_0x297d61 instanceof Error?_0x297d61[_0x5ac7bf(0x10b)]:_0x5ac7bf(0x130),'gatewayPaymentId':_0x168f4a['gatewayPaymentId'],'checkedAt':new Date()[_0x5ac7bf(0x111)]()})}});}}async[a35_0x33f45a(0x108)](_0xd84dd,_0x3b336b){const _0x52006e=a35_0x33f45a,_0x47c939=Date[_0x52006e(0x13a)]();try{const _0x318a7=_0xd84dd[_0x52006e(0x12e)],_0xc2946f=_0x318a7[_0x52006e(0x1a2)];if(!_0xc2946f?.[_0x52006e(0x12f)]){console['log'](_0x52006e(0x1cb)+_0x318a7['id']);return;}const _0x8cdc6=_0x3b336b===_0x52006e(0x11a)?_0x52006e(0x102):_0x3b336b===_0x52006e(0x1a6)?_0x52006e(0x164):_0x3b336b===_0x52006e(0x188)?_0x52006e(0x164):'payment.pending';if(!_0xc2946f[_0x52006e(0x1cd)]?.[_0x52006e(0x167)](_0x8cdc6)){console[_0x52006e(0x16c)]('Webhook\x20event\x20'+_0x8cdc6+_0x52006e(0x1b2)+_0x318a7['id']);return;}const _0x130602={'event':_0x8cdc6,'payment':{'id':_0xd84dd['id'],'order_id':_0xd84dd[_0x52006e(0x1ac)],'gateway_order_id':_0xd84dd[_0x52006e(0x1b5)],'gateway':_0x52006e(0x16a),'amount':_0xd84dd[_0x52006e(0x1c6)],'currency':_0xd84dd[_0x52006e(0xea)],'status':_0x3b336b[_0x52006e(0x150)](),'customer_email':_0xd84dd[_0x52006e(0x147)],'customer_name':_0xd84dd[_0x52006e(0x13d)],'created_at':_0xd84dd[_0x52006e(0x16b)],'updated_at':new Date()}},_0x319389=await fetch(_0xc2946f['webhookUrl'],{'method':_0x52006e(0x100),'headers':{'Content-Type':_0x52006e(0x107),'User-Agent':_0x52006e(0xec)},'body':JSON[_0x52006e(0x1ab)](_0x130602)}),_0x36b74d=Date[_0x52006e(0x13a)]()-_0x47c939,_0x3192f8=_0x319389['ok']?_0x52006e(0x149):await _0x319389['text']();loggerService_1[_0x52006e(0x12a)][_0x52006e(0x186)](_0xd84dd[_0x52006e(0xfc)],_0xc2946f['webhookUrl'],_0x8cdc6,_0x319389[_0x52006e(0x158)],_0x36b74d,_0x130602),console[_0x52006e(0x16c)](_0x52006e(0x163)+_0xc2946f[_0x52006e(0x12f)]+_0x52006e(0x165)+_0x319389[_0x52006e(0x158)]+'\x20('+_0x36b74d+_0x52006e(0x11d));}catch(_0x2e5577){console[_0x52006e(0x18a)](_0x52006e(0x112),_0x2e5577),loggerService_1[_0x52006e(0x12a)]['logShopWebhookError'](_0xd84dd['shopId'],_0xd84dd[_0x52006e(0x12e)]?.[_0x52006e(0x1a2)]?.[_0x52006e(0x12f)]||_0x52006e(0x138),'webhook_send',_0x2e5577,{});}}async[a35_0x33f45a(0x115)](_0x41d417,_0x29b0b0){const _0x302a43=a35_0x33f45a;try{const _0x52d395={'PENDING':_0x302a43(0x197),'PAID':_0x302a43(0x1c8),'FAILED':_0x302a43(0x182),'EXPIRED':'expired'},_0x19a725=_0x52d395[_0x29b0b0];if(!_0x19a725||_0x19a725===_0x302a43(0x197))return;await telegramBotService_1['telegramBotService']['sendPaymentNotification'](_0x41d417[_0x302a43(0xfc)],_0x41d417,_0x19a725);}catch(_0x140938){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x140938);}}async[a35_0x33f45a(0xf1)](_0x1ef069){const _0x34d152=a35_0x33f45a;console['log']('üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x1ef069);const _0x31c166=await database_1[_0x34d152(0x1bd)][_0x34d152(0x118)]['findUnique']({'where':{'id':_0x1ef069},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x31c166)throw new Error('Payment\x20not\x20found');if(_0x31c166[_0x34d152(0x143)]!==_0x34d152(0x15b))throw new Error(_0x34d152(0xfa));console[_0x34d152(0x16c)](_0x34d152(0x1af)+_0x1ef069),await this[_0x34d152(0x19c)](_0x31c166),console[_0x34d152(0x16c)](_0x34d152(0x1a7)+_0x1ef069);}[a35_0x33f45a(0x1b8)](){const _0x57d5c8=a35_0x33f45a,_0x595486=this[_0x57d5c8(0x105)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x322ede=Array['from'](this[_0x57d5c8(0x19f)][_0x57d5c8(0xf5)]())['map'](_0x11dd04=>({'paymentId':_0x11dd04[_0x57d5c8(0x120)],'gatewayPaymentId':_0x11dd04[_0x57d5c8(0x103)],'createdAt':_0x11dd04['createdAt'],'timersCount':_0x11dd04[_0x57d5c8(0x14f)][_0x57d5c8(0x153)]}));return{'isActive':!!this[_0x57d5c8(0x105)],'globalCheckIntervalMinutes':this[_0x57d5c8(0x132)]/(0x3e8*0x3c),'expiryDays':this[_0x57d5c8(0x15a)],'activeIndividualTimers':this[_0x57d5c8(0x19f)][_0x57d5c8(0xf2)],'nextGlobalCheckIn':_0x595486,'paymentTimersDetails':_0x322ede};}['getPaymentTimerInfo'](_0x540e10){const _0x27d71b=a35_0x33f45a,_0x982aa2=this[_0x27d71b(0x19f)][_0x27d71b(0x171)](_0x540e10);if(_0x982aa2)return{'hasTimers':!![],'timersCount':_0x982aa2[_0x27d71b(0x14f)][_0x27d71b(0x153)],'createdAt':_0x982aa2[_0x27d71b(0x16b)],'gatewayPaymentId':_0x982aa2[_0x27d71b(0x103)]};return{'hasTimers':![]};}}exports[a35_0x33f45a(0x168)]=CoinToPayStatusService,exports[a35_0x33f45a(0x148)]=new CoinToPayStatusService();function a35_0x13f3(){const _0x10574c=['payment','üõë\x20[SHUTDOWN]\x20Cleared\x20','PAID','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','delay','ms)','checkAllPendingPayments','\x20in\x20','paymentId','\x20skipped,\x20','\x20days','\x20checked,\x20','schedule_created','clearPaymentTimers','logCoinToPayStatus','244Ifipxx','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','loggerService','üìä\x20[CHECK]\x20Payment\x20','\x20\x20\x20üìç\x20Source:\x20','toFixed','shop','webhookUrl','Unknown\x20error','./loggerService','GLOBAL_CHECK_INTERVAL_MS','\x20(age:\x20','checkExpiredPayments','\x20initial\x20timers\x20for\x20payment\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20to\x20clear','unknown','stopPeriodicStatusCheck','now','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','7311020nSMCtx','customerName','\x20not\x20found\x20in\x20database','paidAt','\x20\x20\x20üìù\x20Details:','logWhiteDomainError','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','gateway','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','customerEmail','coinToPayStatusService','Success','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','webhookLog','-day\x20timeout','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','remitterIban','timers','toLowerCase','\x20\x20\x20-\x20ShopId:\x20','9qCNqqH','length','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','create','\x20completed\x20for\x20payment\x20','createdOn','status','\x20\x20\x20-\x20Amount:\x20','EXPIRY_DAYS','cointopay','\x20\x20\x20‚ùå\x20Error:\x20','adminNotes','catch','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20found:','\x20days\x20without\x20payment\x20confirmation','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','Shop\x20webhook\x20sent\x20to\x20','payment.failed','\x20with\x20status\x20','set','includes','CoinToPayStatusService','CoinToPayService','0100','createdAt','log','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','bankDetails','‚è∞\x20[EXPIRY]\x20Payment\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','get','\x20expired','confirmedOn','not\x20found','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','/status/','COINTOPAY_ERROR','Payment\x20older\x20than\x20','floor','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20is\x20older\x20than\x20','\x20\x20\x20üìù\x20Context:','\x20status\x20is\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','iban','\x20(after\x20','transactionId','failed','‚úÖ\x20[EXPIRY]\x20Payment\x20','\x20is\x20too\x20new\x20(','../config/database','logShopWebhookSent','stack','EXPIRED','findMany','error','‚úÖ\x20[CHECK]\x20Payment\x20','description','\x20expired\x20CoinToPay\x20payments','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','logCoinToPayError','\x20\x20\x20-\x20Status:\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','Automatically\x20expired\x20after\x20','paymentDetails','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','created','\x20timers\x20for\x20payment\x20','\x20\x20\x20-\x20Gateway:\x20','.\x20Remaining\x20active\x20timers:\x20','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','checkSinglePayment','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20marked\x20as\x20paid\x20at:\x20','paymentTimers','findUnique','coinToPayService','settings','\x20status:\x20','not\x20confirmed','\x20for\x20payment\x20','FAILED','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','Bank\x20Details:\x20','checkPaymentStatus','\x20seconds\x20(','stringify','orderId','97185zsYoQv','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','967IfLcqz','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','\x20not\x20enabled\x20for\x20shop\x20','status_check','h),\x20skipping\x20global\x20check','gatewayOrderId','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','getServiceStats','863718bEyInB','ü™ô\x20[GLOBAL]\x20Found\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','945000fcDafz','default','PENDING','checkSinglePaymentById','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20\x20\x20üìä\x20Status:\x20','5\x20minutes','\x20days,\x20marking\x20as\x20EXPIRED','‚úÖ\x20[HOURLY]\x20Payment\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','amount','‚ùå\x20[HOURLY]\x20Payment\x20','paid','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','update','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','delete','webhookEvents','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','currency','getTime','TesSoft\x20Payment\x20System/1.0','__esModule','üßπ\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20\x20\x20üìÖ\x20Time:\x20','checkPaymentById','size','timestamp',',\x20clearing\x20individual\x20timers','values','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','push','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','./telegramBotService','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','1097848ACjCpq','shopId','1\x20minute','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','7wcmuel','POST','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','payment.success','gatewayPaymentId','forEach','globalCheckInterval','270396KUQEBn','application/json','sendShopWebhook',',\x20stopping\x20individual\x20checks','\x20to\x20','message','cointopay_auto_expired','‚è∞\x20[GLOBAL]\x20Found\x20','\x20has\x20no\x20gatewayPaymentId','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','schedulePaymentChecks','toISOString','Failed\x20to\x20send\x20shop\x20webhook:','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','ü™ô\x20CoinToPayStatusService\x20initialized','sendPaymentStatusNotification','startPeriodicStatusCheck','\x20pending\x20CoinToPay\x20payments'];a35_0x13f3=function(){return _0x10574c;};return a35_0x13f3();}