'use strict';const a50_0x2ca863=a50_0x44ea;(function(_0x3b2473,_0x136cd9){const _0x37b4f3=a50_0x44ea,_0x2b1124=_0x3b2473();while(!![]){try{const _0x3b4b63=parseInt(_0x37b4f3(0x23b))/0x1+parseInt(_0x37b4f3(0x1f5))/0x2+parseInt(_0x37b4f3(0x26d))/0x3*(-parseInt(_0x37b4f3(0x21c))/0x4)+-parseInt(_0x37b4f3(0x1c9))/0x5+-parseInt(_0x37b4f3(0x22f))/0x6*(-parseInt(_0x37b4f3(0x204))/0x7)+parseInt(_0x37b4f3(0x2af))/0x8+-parseInt(_0x37b4f3(0x2cd))/0x9;if(_0x3b4b63===_0x136cd9)break;else _0x2b1124['push'](_0x2b1124['shift']());}catch(_0x499780){_0x2b1124['push'](_0x2b1124['shift']());}}}(a50_0x4aa8,0x2abff));var __importDefault=this&&this['__importDefault']||function(_0x1f304e){const _0x45af49=a50_0x44ea;return _0x1f304e&&_0x1f304e[_0x45af49(0x2b9)]?_0x1f304e:{'default':_0x1f304e};};function a50_0x44ea(_0x566f34,_0x5ae32c){_0x566f34=_0x566f34-0x1c9;const _0x4aa85c=a50_0x4aa8();let _0x44ea00=_0x4aa85c[_0x566f34];return _0x44ea00;}Object[a50_0x2ca863(0x244)](exports,a50_0x2ca863(0x2b9),{'value':!![]}),exports[a50_0x2ca863(0x1ff)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a50_0x2ca863(0x262)),coinToPay2Service_1=require(a50_0x2ca863(0x1f0)),gateway_1=require('../types/gateway'),database_1=__importDefault(require(a50_0x2ca863(0x2d5))),telegramBotService_1=require(a50_0x2ca863(0x2d0)),loggerService_1=require(a50_0x2ca863(0x29e)),currencyService_1=require('./currencyService');function a50_0x4aa8(){const _0xe54146=['Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20\x20\x20-\x20ShopId:\x20','push','map','\x20is\x20too\x20new\x20(','webhookEvents','\x20USDT','settings','6uXKZfW','\x20status\x20is\x20','coinToPayService','Shop\x20webhook\x20sent\x20to\x20','message','GLOBAL_CHECK_INTERVAL_MS','\x20timers\x20for\x20payment\x20','cointopay_status_check_','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20\x20\x20-\x20GatewayPaymentId:\x20','customerName','\x20completed\x20for\x20payment\x20','294068GWxvnF','‚ùå\x20[HOURLY]\x20Payment\x20','\x20\x20\x20üìù\x20Details:','checkSinglePaymentById','confirmedOn','\x20status\x20unchanged\x20(','checkExpiredPayments','amount','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','defineProperty','gatewaySettings','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','cointopay_status_check_error','\x20skipped,\x20','üìà\x20[COINTOPAY]\x20Payment\x20','timestamp','created','üîç\x20[CHECK]\x20Checking\x20','convertToUSDT','paid','PAID','5\x20minutes','\x20expired\x20CoinToPay\x20payments','startPeriodicStatusCheck','paymentLink',',\x20using\x20default\x20commission\x2010%','has','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','getGatewayCommission','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','\x20\x20\x20Amount:\x20','‚è∞\x20[GLOBAL]\x20Found\x20','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20seconds\x20(','stopPeriodicStatusCheck','shopId','./gateways/coinToPayService','CoinToPay2Service','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','COINTOPAY_ERROR','gatewayPaymentId','‚ùå\x20[CHECK]\x20Payment\x20','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','logShopWebhookError','timers','h),\x20skipping\x20global\x20check','payment','5193EbtdRL','\x20->\x20','\x20details:','‚úÖ\x20[HOURLY]\x20Payment\x20','getDate','\x20checked,\x20','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','toISOString','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','cointopay_auto_expired','auto_expire','expired','bankDetails','orderId','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','COINTOPAY_STATUS_CHANGE','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','-day\x20timeout','floor','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20for\x20payment\x20','1\x20minute','amountUSDT','payment.success','cointopay2','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','stringify','‚è∞\x20[GLOBAL]\x20Payment\x20','amountAfterGatewayCommissionUSDT','\x20initial\x20timers\x20for\x20payment\x20',',\x20clearing\x20individual\x20timers','Payment\x20older\x20than\x20','update','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20\x20\x20üìù\x20Context:','\x20\x20\x20‚ùå\x20Error:\x20','\x20\x20\x20-\x20Gateway:\x20','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20',',\x20stopping\x20individual\x20checks','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','commission','\x20pending\x20CoinToPay\x20payments','2\x20minutes','Failed\x20to\x20send\x20shop\x20webhook:','checkSinglePayment','./loggerService','status','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','entries','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','delete','findUnique','üìä\x20[HOURLY]\x20Payment\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','delay',':\x20type=','default','stack','iban','\x20\x20\x20üìä\x20Status:\x20','values','960392CQWlUO','schedulePaymentChecks','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20\x20\x20-\x20paymentId:\x20','paidAt','getServiceStats','\x20(after\x20','logCoinToPayError','cointopay','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','__esModule','type','logShopWebhookSent','\x20not\x20found,\x20clearing\x20timers','/status/','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','checkPaymentStatus','üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20',',\x20status=','loggerService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Success','\x20status\x20from\x20','üè¶\x20[CHECK]\x20Bank\x20details\x20provided:\x20','description','schedule_created','sendPaymentNotification','status_check','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','gateway','2525634VKYpNm','Gateway\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','./telegramBotService','toFixed','shop','logCoinToPayStatus','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','../config/database','webhookLog','1087480vUvibl','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','Webhook\x20event\x20','paymentDetails','payment.failed','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','from','\x20not\x20enabled\x20for\x20shop\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','remitterIban','unknown','\x20commission:\x20','currentPayments','get','clearPaymentTimers','\x20\x20\x20-\x20gatewayPaymentId:\x20','\x20in\x20shop\x20','Unknown\x20error','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','length','currencyService','getTime','setDate','gatewayOrderId','‚úÖ\x20[CHECK]\x20Payment\x20','transactionId','checkPaymentById','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','POST','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','PENDING','paymentId','\x20\x20\x20Amount\x20after\x20commission:\x20','EXPIRY_DAYS','Payment\x20System/1.0','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','\x20days,\x20marking\x20as\x20EXPIRED','includes','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','./gateways/coinToPay2Service','EXPIRED','üßπ\x20[CHECK]\x20Payment\x20','\x20to\x20clear','\x20days','521814cVkxIH','paymentTimers','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','\x20current\x20status:\x20','webhook_send','error','globalCheckInterval','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','coinToPayStatusService','now','sendShopWebhook','createdAt','üí∞\x20[CHECK]\x20Payment\x20','726544FFiNtX','\x20to\x20','create','failed','payment.pending','\x20\x20\x20üìÖ\x20Time:\x20','CoinToPayStatusService',',\x20using\x20default\x2010%','\x20\x20\x20üìç\x20Source:\x20','\x20expired','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','parse',',\x20currentPayments=','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20payment\x20','üìä\x20[CHECK]\x20Payment\x20','log','ms)','\x20individual\x20payment\x20timers','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20has\x20no\x20gatewayPaymentId',',\x20gateway\x20','currency','ü™ô\x20[DEBUG]\x20Creating\x20','244XvHpCq','toLowerCase','size','\x20status:\x20','coinToPay2Service','webhookUrl','customerEmail','\x20\x20\x20-\x20Amount:\x20','\x20with\x20status\x20','SINGLE','telegramBotService'];a50_0x4aa8=function(){return _0xe54146;};return a50_0x4aa8();}class CoinToPayStatusService{constructor(){const _0x25e221=a50_0x2ca863;this['globalCheckInterval']=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this['paymentTimers']=new Map(),this[_0x25e221(0x231)]=new coinToPayService_1['CoinToPayService'](),this[_0x25e221(0x220)]=new coinToPay2Service_1[(_0x25e221(0x263))](),console[_0x25e221(0x214)](_0x25e221(0x2be));}[a50_0x2ca863(0x2b0)](_0xfdb017,_0x47f29d){const _0x54a280=a50_0x2ca863;console[_0x54a280(0x214)]('ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x54a280(0x214)](_0x54a280(0x2b2)+_0xfdb017),console['log'](_0x54a280(0x1d8)+_0x47f29d),this[_0x54a280(0x1d7)](_0xfdb017);const _0x3f5a0c=[],_0x2b88f9=new Date(),_0xbb2dcb=[{'delay':0x1*0x3c*0x3e8,'description':_0x54a280(0x286)},{'delay':0x2*0x3c*0x3e8,'description':_0x54a280(0x29b)},{'delay':0x5*0x3c*0x3e8,'description':_0x54a280(0x250)},{'delay':0x5*0x3c*0x3e8,'description':_0x54a280(0x250)}];console[_0x54a280(0x214)](_0x54a280(0x21b)+_0xbb2dcb['length']+_0x54a280(0x28e)+_0xfdb017);let _0x35ee0c=0x0;_0xbb2dcb['forEach']((_0xf95c42,_0x25c22b)=>{const _0x53b72c=_0x54a280;_0x35ee0c+=_0xf95c42[_0x53b72c(0x2a8)];const _0x4c2a33=setTimeout(async()=>{const _0x601461=_0x53b72c;console[_0x601461(0x214)](_0x601461(0x298)+(_0x25c22b+0x1)+'\x20triggered\x20for\x20payment\x20'+_0xfdb017+_0x601461(0x2b5)+_0xf95c42[_0x601461(0x2c7)]+')');try{await this['checkSinglePaymentById'](_0xfdb017),console[_0x601461(0x214)](_0x601461(0x246)+(_0x25c22b+0x1)+_0x601461(0x23a)+_0xfdb017);}catch(_0x46765c){console[_0x601461(0x1fa)](_0x601461(0x2cb)+(_0x25c22b+0x1)+_0x601461(0x285)+_0xfdb017+':',_0x46765c),this[_0x601461(0x2b6)](_0xfdb017,_0x47f29d,_0x46765c,'status_check',{'checkNumber':_0x25c22b+0x1,'scheduledAfter':_0xf95c42[_0x601461(0x2c7)],'isIndividualCheck':!![]});}},_0x35ee0c);_0x3f5a0c['push'](_0x4c2a33),console[_0x53b72c(0x214)](_0x53b72c(0x258)+(_0x25c22b+0x1)+_0x53b72c(0x285)+_0xfdb017+'\x20in\x20'+_0x35ee0c/0x3e8+_0x53b72c(0x25f)+_0xf95c42['description']+')');});const _0x3b9726=setInterval(async()=>{const _0x97e407=_0x54a280;console[_0x97e407(0x214)](_0x97e407(0x1db)+_0xfdb017);try{const _0x3698a2=await database_1[_0x97e407(0x2aa)][_0x97e407(0x26c)]['findUnique']({'where':{'id':_0xfdb017},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x3698a2){console[_0x97e407(0x214)](_0x97e407(0x23c)+_0xfdb017+_0x97e407(0x2bc)),this['clearPaymentTimers'](_0xfdb017);return;}console[_0x97e407(0x214)](_0x97e407(0x2a6)+_0xfdb017+_0x97e407(0x1f8)+_0x3698a2[_0x97e407(0x29f)]);if(_0x3698a2[_0x97e407(0x29f)]!==_0x97e407(0x1e7)){console['log'](_0x97e407(0x270)+_0xfdb017+_0x97e407(0x230)+_0x3698a2[_0x97e407(0x29f)]+_0x97e407(0x297)),this[_0x97e407(0x1d7)](_0xfdb017);return;}const _0x2db21d=Math[_0x97e407(0x283)]((Date['now']()-_0x3698a2['createdAt'][_0x97e407(0x1de)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x2db21d>=this[_0x97e407(0x1ea)]){console[_0x97e407(0x214)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0xfdb017+'\x20is\x20older\x20than\x20'+this[_0x97e407(0x1ea)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x97e407(0x1d7)](_0xfdb017);return;}await this[_0x97e407(0x23e)](_0xfdb017),console[_0x97e407(0x214)](_0x97e407(0x296)+_0xfdb017);}catch(_0x4717ed){console[_0x97e407(0x1fa)](_0x97e407(0x25e)+_0xfdb017+':',_0x4717ed),this[_0x97e407(0x2b6)](_0xfdb017,_0x47f29d,_0x4717ed,_0x97e407(0x2ca),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3f5a0c['push'](_0x3b9726),this[_0x54a280(0x1f6)]['set'](_0xfdb017,{'timers':_0x3f5a0c,'paymentId':_0xfdb017,'gatewayPaymentId':_0x47f29d,'createdAt':_0x2b88f9}),console[_0x54a280(0x214)]('‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0xbb2dcb[_0x54a280(0x1dc)]+_0x54a280(0x27e)+_0xfdb017),console[_0x54a280(0x214)](_0x54a280(0x2b8)+this[_0x54a280(0x1f6)]['size']),this[_0x54a280(0x2d3)](_0xfdb017,_0x47f29d,_0x54a280(0x1e7),_0x54a280(0x1e7),_0x54a280(0x2ca),{'action':_0x54a280(0x2c8),'scheduledChecks':_0xbb2dcb[_0x54a280(0x1dc)],'firstCheckIn':_0xbb2dcb[0x0]['delay']/0x3e8,'totalTimers':this[_0x54a280(0x1f6)][_0x54a280(0x21e)]});}[a50_0x2ca863(0x1d7)](_0x18d810){const _0x6c9758=a50_0x2ca863,_0x29cddc=this[_0x6c9758(0x1f6)][_0x6c9758(0x1d6)](_0x18d810);_0x29cddc?(console['log']('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x29cddc[_0x6c9758(0x26a)]['length']+_0x6c9758(0x235)+_0x18d810),_0x29cddc['timers']['forEach']((_0x51c264,_0x3f3db3)=>{const _0x1f1588=_0x6c9758;_0x51c264&&(clearTimeout(_0x51c264),clearInterval(_0x51c264),console[_0x1f1588(0x214)]('üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x3f3db3+0x1)+_0x1f1588(0x285)+_0x18d810));}),this[_0x6c9758(0x1f6)][_0x6c9758(0x2a4)](_0x18d810),console[_0x6c9758(0x214)]('‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x18d810+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x6c9758(0x1f6)][_0x6c9758(0x21e)])):console['log'](_0x6c9758(0x284)+_0x18d810+_0x6c9758(0x1f3));}async['checkSinglePaymentById'](_0x4b16db){const _0x47cdde=a50_0x2ca863;console[_0x47cdde(0x214)](_0x47cdde(0x1ce)+_0x4b16db);const _0x33644a=await database_1[_0x47cdde(0x2aa)]['payment'][_0x47cdde(0x2a5)]({'where':{'id':_0x4b16db},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x33644a){console[_0x47cdde(0x214)](_0x47cdde(0x267)+_0x4b16db+'\x20not\x20found\x20in\x20database');return;}console[_0x47cdde(0x214)]('üìä\x20[CHECK]\x20Payment\x20'+_0x4b16db+'\x20found:'),console[_0x47cdde(0x214)](_0x47cdde(0x295)+_0x33644a['gateway']),console[_0x47cdde(0x214)]('\x20\x20\x20-\x20Status:\x20'+_0x33644a[_0x47cdde(0x29f)]),console[_0x47cdde(0x214)](_0x47cdde(0x238)+_0x33644a[_0x47cdde(0x266)]),console['log'](_0x47cdde(0x223)+_0x33644a[_0x47cdde(0x242)]+'\x20'+_0x33644a[_0x47cdde(0x21a)]),console[_0x47cdde(0x214)](_0x47cdde(0x228)+_0x33644a[_0x47cdde(0x261)]);if(_0x33644a[_0x47cdde(0x2cc)]!==_0x47cdde(0x2b7)&&_0x33644a[_0x47cdde(0x2cc)]!==_0x47cdde(0x289)){console[_0x47cdde(0x214)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x4b16db+_0x47cdde(0x273)+_0x33644a[_0x47cdde(0x2cc)]+')');return;}if(_0x33644a['status']!==_0x47cdde(0x1e7)){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x4b16db+_0x47cdde(0x230)+_0x33644a['status']+',\x20stopping\x20individual\x20checks'),this[_0x47cdde(0x1d7)](_0x4b16db);return;}if(!_0x33644a[_0x47cdde(0x266)]){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x4b16db+_0x47cdde(0x218));return;}console[_0x47cdde(0x214)](_0x47cdde(0x1e1)+_0x4b16db+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x47cdde(0x29d)](_0x33644a);}[a50_0x2ca863(0x2d3)](_0x1f224d,_0x52278c,_0x3ca301,_0x24ece1,_0x544884,_0x4195a1){const _0x555e63=a50_0x2ca863,_0x5ceee2={'type':_0x555e63(0x27c),'paymentId':_0x1f224d,'gatewayPaymentId':_0x52278c,'oldStatus':_0x3ca301,'newStatus':_0x24ece1,'source':_0x544884,'timestamp':new Date()[_0x555e63(0x274)](),'details':_0x4195a1||{}};loggerService_1[_0x555e63(0x2c2)][_0x555e63(0x2d3)](_0x5ceee2),console[_0x555e63(0x214)](_0x555e63(0x2d4)+_0x1f224d+'\x20('+_0x52278c+')'),console[_0x555e63(0x214)](_0x555e63(0x2ad)+_0x3ca301+_0x555e63(0x26e)+_0x24ece1),console[_0x555e63(0x214)]('\x20\x20\x20üìç\x20Source:\x20'+_0x544884),console[_0x555e63(0x214)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x5ceee2[_0x555e63(0x24a)]),_0x4195a1&&console[_0x555e63(0x214)](_0x555e63(0x23d),_0x4195a1);}[a50_0x2ca863(0x2b6)](_0x56bbc4,_0x52e60b,_0x53fb7e,_0x2d5c05,_0x1ffd60){const _0x314588=a50_0x2ca863,_0x15132e={'type':_0x314588(0x265),'paymentId':_0x56bbc4,'gatewayPaymentId':_0x52e60b,'error':_0x53fb7e instanceof Error?{'message':_0x53fb7e['message'],'stack':_0x53fb7e[_0x314588(0x2ab)]}:_0x53fb7e,'source':_0x2d5c05,'timestamp':new Date()[_0x314588(0x274)](),'context':_0x1ffd60||{}};loggerService_1[_0x314588(0x2c2)][_0x314588(0x2b6)](_0x15132e),console['error'](_0x314588(0x2a3)+_0x56bbc4+'\x20('+_0x52e60b+')'),console[_0x314588(0x1fa)](_0x314588(0x294)+(_0x53fb7e instanceof Error?_0x53fb7e[_0x314588(0x233)]:_0x53fb7e)),console[_0x314588(0x1fa)](_0x314588(0x20c)+_0x2d5c05),console[_0x314588(0x1fa)](_0x314588(0x209)+_0x15132e[_0x314588(0x24a)]),_0x1ffd60&&console[_0x314588(0x1fa)](_0x314588(0x293),_0x1ffd60);}[a50_0x2ca863(0x252)](){const _0x55f970=a50_0x2ca863;console[_0x55f970(0x214)](_0x55f970(0x275)),this['checkAllPendingPayments']()['catch'](_0x206852=>{const _0x2769be=_0x55f970;console[_0x2769be(0x1fa)](_0x2769be(0x1e6),_0x206852);}),this[_0x55f970(0x1fb)]=setInterval(async()=>{const _0x4cbca6=_0x55f970;try{console[_0x4cbca6(0x214)](_0x4cbca6(0x217)),await this['checkAllPendingPayments'](),console[_0x4cbca6(0x214)](_0x4cbca6(0x1e4));}catch(_0x472685){console[_0x4cbca6(0x1fa)]('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x472685);}},this[_0x55f970(0x234)]),console['log'](_0x55f970(0x292));}[a50_0x2ca863(0x260)](){const _0x570361=a50_0x2ca863;console[_0x570361(0x214)](_0x570361(0x1ef));this[_0x570361(0x1fb)]&&(clearInterval(this[_0x570361(0x1fb)]),this[_0x570361(0x1fb)]=null,console[_0x570361(0x214)](_0x570361(0x2cf)));const _0x1f419b=this[_0x570361(0x1f6)][_0x570361(0x21e)];for(const [_0x1144d9]of this[_0x570361(0x1f6)]){this[_0x570361(0x1d7)](_0x1144d9);}console[_0x570361(0x214)]('üõë\x20[SHUTDOWN]\x20Cleared\x20'+_0x1f419b+_0x570361(0x216));}async['checkAllPendingPayments'](){const _0xb0ed28=a50_0x2ca863;try{console[_0xb0ed28(0x214)](_0xb0ed28(0x2b1));const _0x5c512c=await database_1['default'][_0xb0ed28(0x26c)]['findMany']({'where':{'gateway':{'in':['cointopay','cointopay2']},'status':_0xb0ed28(0x1e7),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0xb0ed28(0x214)]('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x5c512c[_0xb0ed28(0x1dc)]+_0xb0ed28(0x29a));if(_0x5c512c[_0xb0ed28(0x1dc)]===0x0){console[_0xb0ed28(0x214)]('ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x1a01b5=await this[_0xb0ed28(0x241)](_0x5c512c);console[_0xb0ed28(0x214)](_0xb0ed28(0x25d)+_0x1a01b5[_0xb0ed28(0x1dc)]+_0xb0ed28(0x251));let _0x5dcc01=0x0,_0xfe0486=0x0;for(const _0x11ad3d of _0x5c512c){try{if(_0x1a01b5[_0xb0ed28(0x1ee)](_0x11ad3d['id'])){console[_0xb0ed28(0x214)](_0xb0ed28(0x28c)+_0x11ad3d['id']+_0xb0ed28(0x1d1)),_0xfe0486++;continue;}if(this['paymentTimers'][_0xb0ed28(0x255)](_0x11ad3d['id'])){console[_0xb0ed28(0x214)](_0xb0ed28(0x28c)+_0x11ad3d['id']+_0xb0ed28(0x2a7)),_0xfe0486++;continue;}const _0x4b79ec=(Date[_0xb0ed28(0x200)]()-_0x11ad3d[_0xb0ed28(0x202)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x4b79ec<0x1){console[_0xb0ed28(0x214)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x11ad3d['id']+_0xb0ed28(0x22b)+_0x4b79ec['toFixed'](0x1)+_0xb0ed28(0x26b)),_0xfe0486++;continue;}console[_0xb0ed28(0x214)]('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x11ad3d['id']+'\x20(age:\x20'+_0x4b79ec[_0xb0ed28(0x2d1)](0x1)+'h)'),await this[_0xb0ed28(0x29d)](_0x11ad3d),_0x5dcc01++,await new Promise(_0x3502bf=>setTimeout(_0x3502bf,0x7d0));}catch(_0x5a2118){console[_0xb0ed28(0x1fa)](_0xb0ed28(0x27d)+_0x11ad3d['id']+':',_0x5a2118),this['logCoinToPayError'](_0x11ad3d['id'],_0x11ad3d[_0xb0ed28(0x266)]||_0xb0ed28(0x1d3),_0x5a2118,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x11ad3d[_0xb0ed28(0x242)],'paymentCurrency':_0x11ad3d[_0xb0ed28(0x21a)],'shopId':_0x11ad3d[_0xb0ed28(0x261)],'createdAt':_0x11ad3d['createdAt']}),loggerService_1['loggerService']['logWhiteDomainError'](_0xb0ed28(0x2b7),_0xb0ed28(0x2bd)+_0x11ad3d[_0xb0ed28(0x266)],_0x5a2118);}}console[_0xb0ed28(0x214)](_0xb0ed28(0x243)+_0x5dcc01+_0xb0ed28(0x272)+_0xfe0486+_0xb0ed28(0x248)+_0x1a01b5[_0xb0ed28(0x1dc)]+_0xb0ed28(0x20d));}catch(_0x3e812b){console[_0xb0ed28(0x1fa)](_0xb0ed28(0x256),_0x3e812b);}}async['checkExpiredPayments'](_0x3edfc9){const _0x1c8267=a50_0x2ca863,_0x4ef8e4=[],_0x3da0ed=new Date();_0x3da0ed[_0x1c8267(0x1df)](_0x3da0ed[_0x1c8267(0x271)]()-this[_0x1c8267(0x1ea)]),console[_0x1c8267(0x214)](_0x1c8267(0x1fe)+this[_0x1c8267(0x1ea)]+'\x20days\x20(created\x20before\x20'+_0x3da0ed['toISOString']()+')');for(const _0x2875b9 of _0x3edfc9){if(_0x2875b9['createdAt']<_0x3da0ed){console[_0x1c8267(0x214)]('‚è∞\x20[EXPIRY]\x20Payment\x20'+_0x2875b9['id']+'\x20is\x20older\x20than\x20'+this[_0x1c8267(0x1ea)]+_0x1c8267(0x1ed));try{this[_0x1c8267(0x2d3)](_0x2875b9['id'],_0x2875b9[_0x1c8267(0x266)]||_0x1c8267(0x1d3),_0x1c8267(0x1e7),_0x1c8267(0x1f1),_0x1c8267(0x277),{'reason':_0x1c8267(0x290)+this[_0x1c8267(0x1ea)]+_0x1c8267(0x1f4),'createdAt':_0x2875b9['createdAt'],'daysSinceCreation':Math[_0x1c8267(0x283)]((Date['now']()-_0x2875b9[_0x1c8267(0x202)][_0x1c8267(0x1de)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x2875b9['amount'],'paymentCurrency':_0x2875b9[_0x1c8267(0x21a)],'shopId':_0x2875b9[_0x1c8267(0x261)]}),await database_1[_0x1c8267(0x2aa)][_0x1c8267(0x26c)][_0x1c8267(0x291)]({'where':{'id':_0x2875b9['id']},'data':{'status':_0x1c8267(0x1f1),'updatedAt':new Date()}}),await database_1[_0x1c8267(0x2aa)][_0x1c8267(0x2d6)][_0x1c8267(0x206)]({'data':{'paymentId':_0x2875b9['id'],'shopId':_0x2875b9[_0x1c8267(0x261)],'event':_0x1c8267(0x276),'statusCode':0xc8,'responseBody':JSON[_0x1c8267(0x28b)]({'reason':_0x1c8267(0x290)+this[_0x1c8267(0x1ea)]+_0x1c8267(0x1f4),'createdAt':_0x2875b9[_0x1c8267(0x202)],'expiredAt':new Date()[_0x1c8267(0x274)](),'daysSinceCreation':Math[_0x1c8267(0x283)]((Date['now']()-_0x2875b9['createdAt'][_0x1c8267(0x1de)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x1c8267(0x201)](_0x2875b9,_0x1c8267(0x1f1)),await this['sendPaymentStatusNotification'](_0x2875b9,_0x1c8267(0x1f1)),this[_0x1c8267(0x1d7)](_0x2875b9['id']),_0x4ef8e4[_0x1c8267(0x229)](_0x2875b9['id']),console[_0x1c8267(0x214)]('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x2875b9['id']+_0x1c8267(0x2a2)+this[_0x1c8267(0x1ea)]+_0x1c8267(0x282));}catch(_0x4f9ab3){console[_0x1c8267(0x1fa)](_0x1c8267(0x259)+_0x2875b9['id']+':',_0x4f9ab3),this[_0x1c8267(0x2b6)](_0x2875b9['id'],_0x2875b9['gatewayPaymentId']||_0x1c8267(0x1d3),_0x4f9ab3,_0x1c8267(0x277),{'reason':_0x1c8267(0x227),'createdAt':_0x2875b9[_0x1c8267(0x202)],'daysSinceCreation':Math[_0x1c8267(0x283)]((Date['now']()-_0x2875b9[_0x1c8267(0x202)][_0x1c8267(0x1de)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x4ef8e4;}async['checkSinglePayment'](_0xf9ddb9){const _0x43ac9d=a50_0x2ca863;if(!_0xf9ddb9[_0x43ac9d(0x266)]){console[_0x43ac9d(0x214)](_0x43ac9d(0x25b)+_0xf9ddb9['id']+_0x43ac9d(0x237));return;}console[_0x43ac9d(0x214)](_0x43ac9d(0x24c)+_0xf9ddb9[_0x43ac9d(0x2cc)]+_0x43ac9d(0x212)+_0xf9ddb9['id']+'\x20('+_0xf9ddb9[_0x43ac9d(0x266)]+')');try{let _0x404c3d;_0xf9ddb9[_0x43ac9d(0x2cc)]===_0x43ac9d(0x289)?(_0x404c3d=await this[_0x43ac9d(0x220)][_0x43ac9d(0x2bf)](_0xf9ddb9[_0x43ac9d(0x266)]),console[_0x43ac9d(0x214)](_0x43ac9d(0x1fd)+_0xf9ddb9['id']+_0x43ac9d(0x21f)+_0x404c3d[_0x43ac9d(0x29f)])):(_0x404c3d=await this[_0x43ac9d(0x231)][_0x43ac9d(0x2bf)](_0xf9ddb9[_0x43ac9d(0x266)]),console[_0x43ac9d(0x214)](_0x43ac9d(0x211)+_0xf9ddb9['id']+_0x43ac9d(0x21f)+_0x404c3d[_0x43ac9d(0x29f)]));_0x404c3d[_0x43ac9d(0x1cc)]&&console['log'](_0x43ac9d(0x213)+_0xf9ddb9['id']+_0x43ac9d(0x26f),{'iban':_0x404c3d[_0x43ac9d(0x1cc)]['iban']||'not\x20found','transactionId':_0x404c3d[_0x43ac9d(0x1cc)]['transactionId'],'createdOn':_0x404c3d['paymentDetails']['createdOn'],'confirmedOn':_0x404c3d[_0x43ac9d(0x1cc)][_0x43ac9d(0x23f)]||'not\x20confirmed'});if(_0x404c3d[_0x43ac9d(0x29f)]!==_0xf9ddb9[_0x43ac9d(0x29f)]){console['log'](_0x43ac9d(0x1ca)+_0xf9ddb9['id']+_0x43ac9d(0x2c5)+_0xf9ddb9[_0x43ac9d(0x29f)]+_0x43ac9d(0x205)+_0x404c3d[_0x43ac9d(0x29f)]),this[_0x43ac9d(0x2d3)](_0xf9ddb9['id'],_0xf9ddb9[_0x43ac9d(0x266)],_0xf9ddb9['status'],_0x404c3d[_0x43ac9d(0x29f)],'status_check',{'paymentDetails':_0x404c3d[_0x43ac9d(0x1cc)],'amount':_0x404c3d[_0x43ac9d(0x242)],'currency':_0x404c3d[_0x43ac9d(0x21a)],'shopId':_0xf9ddb9[_0x43ac9d(0x261)],'checkTimestamp':new Date()[_0x43ac9d(0x274)]()});const _0x214e2f={'status':_0x404c3d[_0x43ac9d(0x29f)],'updatedAt':new Date()};if(_0x404c3d[_0x43ac9d(0x29f)]===_0x43ac9d(0x24f)&&_0xf9ddb9['status']!==_0x43ac9d(0x24f)){_0x214e2f[_0x43ac9d(0x2b3)]=new Date();if(!_0xf9ddb9[_0x43ac9d(0x287)]){const _0x41217a=await currencyService_1[_0x43ac9d(0x1dd)][_0x43ac9d(0x24d)](_0xf9ddb9[_0x43ac9d(0x242)],_0xf9ddb9[_0x43ac9d(0x21a)]);_0x214e2f[_0x43ac9d(0x287)]=_0x41217a;const _0x47ceeb=await this[_0x43ac9d(0x25a)](_0xf9ddb9[_0x43ac9d(0x261)],_0xf9ddb9[_0x43ac9d(0x2cc)]),_0x3731e4=_0x41217a*(0x1-_0x47ceeb/0x64);_0x214e2f[_0x43ac9d(0x28d)]=_0x3731e4,_0x214e2f['gatewayCommissionRate']=_0x47ceeb,console[_0x43ac9d(0x214)]('üí∞\x20[CHECK]\x20Payment\x20'+_0xf9ddb9['id']+'\x20amounts\x20calculated:'),console[_0x43ac9d(0x214)](_0x43ac9d(0x25c)+_0xf9ddb9['amount']+'\x20'+_0xf9ddb9['currency']+_0x43ac9d(0x26e)+_0x41217a[_0x43ac9d(0x2d1)](0x6)+_0x43ac9d(0x22d)),console[_0x43ac9d(0x214)]('\x20\x20\x20Gateway\x20'+_0xf9ddb9[_0x43ac9d(0x2cc)]+_0x43ac9d(0x1d4)+_0x47ceeb+'%'),console[_0x43ac9d(0x214)](_0x43ac9d(0x1e9)+_0x3731e4['toFixed'](0x6)+_0x43ac9d(0x22d));}console[_0x43ac9d(0x214)](_0x43ac9d(0x203)+_0xf9ddb9['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x214e2f['paidAt'][_0x43ac9d(0x274)]());}if(_0x404c3d[_0x43ac9d(0x1cc)]){const _0x3e448e=_0x404c3d['paymentDetails'];_0x3e448e[_0x43ac9d(0x2ac)]&&(_0x214e2f[_0x43ac9d(0x1d2)]=_0x3e448e['iban'],console[_0x43ac9d(0x214)](_0x43ac9d(0x2a0)+_0x3e448e['iban'])),_0x3e448e[_0x43ac9d(0x279)]&&console[_0x43ac9d(0x214)](_0x43ac9d(0x2c6)+_0x3e448e['bankDetails']),_0x3e448e[_0x43ac9d(0x1e2)]&&console[_0x43ac9d(0x214)](_0x43ac9d(0x1f7)+_0x3e448e[_0x43ac9d(0x1e2)]),_0x3e448e[_0x43ac9d(0x23f)]&&console[_0x43ac9d(0x214)](_0x43ac9d(0x1fc)+_0x3e448e[_0x43ac9d(0x23f)]);}await database_1[_0x43ac9d(0x2aa)][_0x43ac9d(0x26c)][_0x43ac9d(0x291)]({'where':{'id':_0xf9ddb9['id']},'data':_0x214e2f});if(_0x404c3d[_0x43ac9d(0x29f)]===_0x43ac9d(0x24f)&&_0xf9ddb9[_0x43ac9d(0x29f)]!=='PAID'){console['log'](_0x43ac9d(0x249)+_0xf9ddb9['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x148481=await database_1[_0x43ac9d(0x2aa)][_0x43ac9d(0x26c)]['findUnique']({'where':{'id':_0xf9ddb9['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x148481?.['paymentLinkId']&&_0x148481['paymentLink'])try{const _0x33badb=_0x148481['paymentLink'];console[_0x43ac9d(0x214)](_0x43ac9d(0x2c0)+_0x33badb['id']+_0x43ac9d(0x2a9)+_0x33badb[_0x43ac9d(0x2ba)]+_0x43ac9d(0x210)+_0x33badb[_0x43ac9d(0x1d5)]+',\x20status='+_0x33badb[_0x43ac9d(0x29f)]);const _0xc1193f=_0x33badb['currentPayments']+0x1,_0x5a82fb=_0x33badb['type']===_0x43ac9d(0x225)?'COMPLETED':_0x33badb[_0x43ac9d(0x29f)];await database_1[_0x43ac9d(0x2aa)][_0x43ac9d(0x253)][_0x43ac9d(0x291)]({'where':{'id':_0x33badb['id']},'data':{'currentPayments':_0xc1193f,'status':_0x5a82fb,'updatedAt':new Date()}}),console[_0x43ac9d(0x214)](_0x43ac9d(0x27b)+_0x33badb['id']+'\x20updated:\x20currentPayments='+_0x33badb['currentPayments']+_0x43ac9d(0x26e)+_0xc1193f+_0x43ac9d(0x2c1)+_0x33badb[_0x43ac9d(0x29f)]+_0x43ac9d(0x26e)+_0x5a82fb);}catch(_0x5e8729){console[_0x43ac9d(0x1fa)](_0x43ac9d(0x28a),_0x5e8729);}else console[_0x43ac9d(0x214)](_0x43ac9d(0x249)+_0xf9ddb9['id']+_0x43ac9d(0x281));}await database_1[_0x43ac9d(0x2aa)][_0x43ac9d(0x2d6)]['create']({'data':{'paymentId':_0xf9ddb9['id'],'shopId':_0xf9ddb9[_0x43ac9d(0x261)],'event':_0x43ac9d(0x236)+_0x404c3d[_0x43ac9d(0x29f)][_0x43ac9d(0x21d)](),'statusCode':0xc8,'responseBody':JSON[_0x43ac9d(0x28b)]({'oldStatus':_0xf9ddb9[_0x43ac9d(0x29f)],'newStatus':_0x404c3d[_0x43ac9d(0x29f)],'paymentDetails':_0x404c3d['paymentDetails'],'checkedAt':new Date()[_0x43ac9d(0x274)]()})}}),await this['sendShopWebhook'](_0xf9ddb9,_0x404c3d[_0x43ac9d(0x29f)]),await this['sendPaymentStatusNotification'](_0xf9ddb9,_0x404c3d['status']),_0x404c3d[_0x43ac9d(0x29f)]!==_0x43ac9d(0x1e7)&&(console[_0x43ac9d(0x214)](_0x43ac9d(0x1f2)+_0xf9ddb9['id']+'\x20status\x20changed\x20to\x20'+_0x404c3d[_0x43ac9d(0x29f)]+_0x43ac9d(0x28f)),this[_0x43ac9d(0x1d7)](_0xf9ddb9['id'])),console['log']('‚úÖ\x20[CHECK]\x20Payment\x20'+_0xf9ddb9['id']+'\x20updated\x20successfully');}else console[_0x43ac9d(0x214)](_0x43ac9d(0x213)+_0xf9ddb9['id']+_0x43ac9d(0x240)+_0x404c3d[_0x43ac9d(0x29f)]+')'),this[_0x43ac9d(0x2d3)](_0xf9ddb9['id'],_0xf9ddb9[_0x43ac9d(0x266)],_0xf9ddb9[_0x43ac9d(0x29f)],_0x404c3d['status'],_0x43ac9d(0x2ca),{'statusUnchanged':!![],'paymentDetails':_0x404c3d[_0x43ac9d(0x1cc)],'amount':_0x404c3d[_0x43ac9d(0x242)],'currency':_0x404c3d[_0x43ac9d(0x21a)],'shopId':_0xf9ddb9[_0x43ac9d(0x261)],'checkTimestamp':new Date()[_0x43ac9d(0x274)]()});}catch(_0x9b833e){console[_0x43ac9d(0x1fa)](_0x43ac9d(0x27f)+_0xf9ddb9['id']+':',_0x9b833e),this[_0x43ac9d(0x2b6)](_0xf9ddb9['id'],_0xf9ddb9[_0x43ac9d(0x266)],_0x9b833e,_0x43ac9d(0x2ca),{'paymentAmount':_0xf9ddb9[_0x43ac9d(0x242)],'paymentCurrency':_0xf9ddb9[_0x43ac9d(0x21a)],'shopId':_0xf9ddb9[_0x43ac9d(0x261)],'createdAt':_0xf9ddb9[_0x43ac9d(0x202)]}),await database_1['default'][_0x43ac9d(0x2d6)]['create']({'data':{'paymentId':_0xf9ddb9['id'],'shopId':_0xf9ddb9[_0x43ac9d(0x261)],'event':_0x43ac9d(0x247),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x9b833e instanceof Error?_0x9b833e[_0x43ac9d(0x233)]:_0x43ac9d(0x1da),'gatewayPaymentId':_0xf9ddb9['gatewayPaymentId'],'checkedAt':new Date()['toISOString']()})}});}}async[a50_0x2ca863(0x201)](_0x10b661,_0x5297cb){const _0x345134=a50_0x2ca863,_0x103240=Date[_0x345134(0x200)]();try{const _0x3d2c6b=_0x10b661[_0x345134(0x2d2)],_0x3b286a=_0x3d2c6b[_0x345134(0x22e)];if(!_0x3b286a?.['webhookUrl']){console[_0x345134(0x214)](_0x345134(0x2c3)+_0x3d2c6b['id']);return;}const _0x1cdf1e=_0x5297cb==='PAID'?_0x345134(0x288):_0x5297cb==='FAILED'?'payment.failed':_0x5297cb===_0x345134(0x1f1)?_0x345134(0x1cd):_0x345134(0x208);if(!_0x3b286a[_0x345134(0x22c)]?.[_0x345134(0x1ee)](_0x1cdf1e)){console[_0x345134(0x214)](_0x345134(0x1cb)+_0x1cdf1e+_0x345134(0x1d0)+_0x3d2c6b['id']);return;}const _0x2c8718=(0x0,gateway_1['getGatewayIdByName'])(_0x10b661[_0x345134(0x2cc)])||_0x10b661[_0x345134(0x2cc)],_0x31c548={'event':_0x1cdf1e,'payment':{'id':_0x10b661['id'],'order_id':_0x10b661[_0x345134(0x27a)],'gateway_order_id':_0x10b661[_0x345134(0x1e0)],'gateway':_0x2c8718,'amount':_0x10b661[_0x345134(0x242)],'currency':_0x10b661[_0x345134(0x21a)],'status':_0x5297cb[_0x345134(0x21d)](),'customer_email':_0x10b661[_0x345134(0x222)],'customer_name':_0x10b661[_0x345134(0x239)],'created_at':_0x10b661[_0x345134(0x202)],'updated_at':new Date()}},_0xc787d3=await fetch(_0x3b286a[_0x345134(0x221)],{'method':_0x345134(0x1e5),'headers':{'Content-Type':'application/json','User-Agent':_0x345134(0x1eb)},'body':JSON[_0x345134(0x28b)](_0x31c548)}),_0x407c7d=Date[_0x345134(0x200)]()-_0x103240,_0x4a3c0c=_0xc787d3['ok']?_0x345134(0x2c4):await _0xc787d3['text']();loggerService_1[_0x345134(0x2c2)][_0x345134(0x2bb)](_0x10b661[_0x345134(0x261)],_0x3b286a['webhookUrl'],_0x1cdf1e,_0xc787d3[_0x345134(0x29f)],_0x407c7d,_0x31c548),console[_0x345134(0x214)](_0x345134(0x232)+_0x3b286a[_0x345134(0x221)]+_0x345134(0x224)+_0xc787d3[_0x345134(0x29f)]+'\x20('+_0x407c7d+_0x345134(0x215));}catch(_0x59912c){console[_0x345134(0x1fa)](_0x345134(0x29c),_0x59912c),loggerService_1[_0x345134(0x2c2)][_0x345134(0x269)](_0x10b661[_0x345134(0x261)],_0x10b661[_0x345134(0x2d2)]?.['settings']?.[_0x345134(0x221)]||'unknown',_0x345134(0x1f9),_0x59912c,{});}}async['sendPaymentStatusNotification'](_0x2367fc,_0xc00a16){const _0x550230=a50_0x2ca863;try{const _0x42d1b4={'PENDING':_0x550230(0x24b),'PAID':_0x550230(0x24e),'FAILED':_0x550230(0x207),'EXPIRED':_0x550230(0x278)},_0x474eed=_0x42d1b4[_0xc00a16];if(!_0x474eed||_0x474eed==='created')return;await telegramBotService_1[_0x550230(0x226)][_0x550230(0x2c9)](_0x2367fc[_0x550230(0x261)],_0x2367fc,_0x474eed);}catch(_0x12a31f){console[_0x550230(0x1fa)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x12a31f);}}async[a50_0x2ca863(0x1e3)](_0x1348e2){const _0x3e9de8=a50_0x2ca863;console['log'](_0x3e9de8(0x264)+_0x1348e2);const _0x123aa6=await database_1[_0x3e9de8(0x2aa)][_0x3e9de8(0x26c)]['findUnique']({'where':{'id':_0x1348e2},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x123aa6)throw new Error('Payment\x20not\x20found');if(_0x123aa6[_0x3e9de8(0x2cc)]!==_0x3e9de8(0x2b7)&&_0x123aa6[_0x3e9de8(0x2cc)]!=='cointopay2')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x3e9de8(0x214)](_0x3e9de8(0x257)+_0x123aa6[_0x3e9de8(0x2cc)]+_0x3e9de8(0x212)+_0x1348e2),await this['checkSinglePayment'](_0x123aa6),console['log'](_0x3e9de8(0x268)+_0x1348e2);}[a50_0x2ca863(0x2b4)](){const _0x394911=a50_0x2ca863,_0x419300=this[_0x394911(0x1fb)]?this[_0x394911(0x234)]:undefined,_0x7ddf2b=Array[_0x394911(0x1cf)](this[_0x394911(0x1f6)][_0x394911(0x2ae)]())[_0x394911(0x22a)](_0x2545fc=>({'paymentId':_0x2545fc[_0x394911(0x1e8)],'gatewayPaymentId':_0x2545fc[_0x394911(0x266)],'createdAt':_0x2545fc[_0x394911(0x202)],'timersCount':_0x2545fc[_0x394911(0x26a)][_0x394911(0x1dc)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x394911(0x234)]/(0x3e8*0x3c),'expiryDays':this[_0x394911(0x1ea)],'activeIndividualTimers':this['paymentTimers'][_0x394911(0x21e)],'nextGlobalCheckIn':_0x419300,'paymentTimersDetails':_0x7ddf2b};}['getPaymentTimerInfo'](_0xc384f5){const _0x321929=a50_0x2ca863,_0x2163f2=this[_0x321929(0x1f6)][_0x321929(0x1d6)](_0xc384f5);if(_0x2163f2)return{'hasTimers':!![],'timersCount':_0x2163f2[_0x321929(0x26a)][_0x321929(0x1dc)],'createdAt':_0x2163f2[_0x321929(0x202)],'gatewayPaymentId':_0x2163f2['gatewayPaymentId']};return{'hasTimers':![]};}async['getGatewayCommission'](_0x892f09,_0x224efa){const _0x311c04=a50_0x2ca863;try{const _0x490ca5=await database_1[_0x311c04(0x2aa)][_0x311c04(0x2d2)][_0x311c04(0x2a5)]({'where':{'id':_0x892f09},'select':{'gatewaySettings':!![]}});if(!_0x490ca5?.[_0x311c04(0x245)])return console[_0x311c04(0x214)](_0x311c04(0x280)+_0x892f09+_0x311c04(0x254)),0xa;const _0xec6d3b=JSON[_0x311c04(0x20f)](_0x490ca5[_0x311c04(0x245)]);for(const [_0x263b2b,_0x25da72]of Object[_0x311c04(0x2a1)](_0xec6d3b)){if(_0x263b2b[_0x311c04(0x21d)]()===_0x224efa[_0x311c04(0x21d)]()){const _0x434709=_0x25da72[_0x311c04(0x299)]||0xa;return console[_0x311c04(0x214)](_0x311c04(0x2ce)+_0x224efa+'\x20commission\x20for\x20shop\x20'+_0x892f09+':\x20'+_0x434709+'%'),_0x434709;}}return console['log'](_0x311c04(0x20e)+_0x224efa+_0x311c04(0x1d9)+_0x892f09+_0x311c04(0x20b)),0xa;}catch(_0x1ad660){return console[_0x311c04(0x1fa)](_0x311c04(0x1ec)+_0x892f09+_0x311c04(0x219)+_0x224efa+':',_0x1ad660),0xa;}}}exports[a50_0x2ca863(0x20a)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();