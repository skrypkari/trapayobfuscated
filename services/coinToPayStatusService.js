'use strict';function a37_0x2855(){const _0x223a50=['payment.success','coinToPayStatusService','Unknown\x20error','\x20with\x20status\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20->\x20','includes','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20completed\x20for\x20payment\x20','\x20to\x20','findMany','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','gatewayPaymentId','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','üßπ\x20[DEBUG]\x20Clearing\x20','set','__esModule','setDate','-day\x20timeout','3544932xULdTI','payment','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20not\x20enabled\x20for\x20shop\x20','stringify','log','application/json','map','gateway','22ZApKgy','webhookLog','\x20skipped,\x20','telegramBotService','1708910wjbgUQ','\x20days','webhookUrl','EXPIRY_DAYS','error','failed','webhookEvents','settings','ms)','not\x20confirmed','checkSinglePaymentById','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20(after\x20','POST','timestamp','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20days\x20without\x20payment\x20confirmation','\x20\x20\x20-\x20Amount:\x20','description','stopPeriodicStatusCheck','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20status\x20is\x20','\x20expired\x20CoinToPay\x20payments','\x20details:','COINTOPAY_STATUS_CHANGE','paymentId','confirmedOn','Payment\x20not\x20found','\x20\x20\x20-\x20paymentId:\x20','\x20\x20\x20-\x20ShopId:\x20','32DhsrdZ','240100Yzeanv','getDate','size','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','h),\x20skipping\x20global\x20check','/status/','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Success','customerEmail','forEach','length','loggerService','orderId','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20not\x20found\x20in\x20database','Payment\x20older\x20than\x20','adminNotes','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20\x20\x20-\x20Gateway:\x20','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','checkAllPendingPayments','amount','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20marked\x20as\x20paid\x20at:\x20','‚úÖ\x20[CHECK]\x20Payment\x20','‚úÖ\x20[HOURLY]\x20Payment\x20','catch','üìä\x20[CHECK]\x20Payment\x20','expired','\x20\x20\x20üìù\x20Details:','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','customerName','GLOBAL_CHECK_INTERVAL_MS','../config/database','sendPaymentNotification','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20(age:\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','\x20is\x20older\x20than\x20','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','unknown','565585NXzunF','‚è∞\x20[GLOBAL]\x20Payment\x20','push','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20status:\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','Automatically\x20expired\x20after\x20','Bank\x20Details:\x20','\x20timers\x20for\x20payment\x20','created','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','0100','PAID','CoinToPayService','cointopay','\x20status\x20from\x20','clearPaymentTimers','schedulePaymentChecks','ü™ô\x20[GLOBAL]\x20Found\x20','\x20current\x20status:\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','remitterIban','cointopay_status_check_','‚è∞\x20[GLOBAL]\x20Found\x20','paid','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','iban','get','findUnique','\x20is\x20too\x20new\x20(','stack','shopId','ü™ô\x20[DEBUG]\x20Creating\x20','schedule_created','getPaymentTimerInfo','toISOString','createdAt','transactionId','\x20\x20\x20üìç\x20Source:\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','logCoinToPayStatus','\x20in\x20','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20has\x20no\x20gatewayPaymentId','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','‚úÖ\x20[EXPIRY]\x20Payment\x20','getTime','toLowerCase','default','5\x20minutes','9BhaWJX','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','currency','bankDetails','.\x20Remaining\x20active\x20timers:\x20','FAILED','paymentDetails','ü™ô\x20CoinToPayStatusService\x20initialized','defineProperty','timers','CoinToPayStatusService','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20status\x20changed\x20to\x20','shop','has','payment.pending','now','createdOn','2321793RrwAZD','\x20checked,\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','paymentTimers','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','Failed\x20to\x20send\x20shop\x20webhook:','logCoinToPayError','\x20\x20\x20‚ùå\x20Error:\x20','\x20for\x20payment\x20','28DcXEGW','\x20seconds\x20(','logShopWebhookSent','cointopay_auto_expired',',\x20stopping\x20individual\x20checks','coinToPayService','./telegramBotService','\x20updated\x20successfully','\x20triggered\x20for\x20payment\x20','EXPIRED','checkPaymentById','\x20to\x20clear','üõë\x20[SHUTDOWN]\x20Cleared\x20','PENDING','toFixed','1198022fMzmsb','logWhiteDomainError','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','checkExpiredPayments','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','./loggerService','paidAt',',\x20clearing\x20individual\x20timers','update','text','üí∞\x20[CHECK]\x20Payment\x20','./gateways/coinToPayService','delay','üßπ\x20[CHECK]\x20Payment\x20','sendShopWebhook','globalCheckInterval','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20\x20\x20-\x20Status:\x20','sendPaymentStatusNotification','getServiceStats','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','COINTOPAY_ERROR','create','payment.failed','\x20expired','TesSoft\x20Payment\x20System/1.0','1315322dokSLu','checkSinglePayment','status','\x20\x20\x20üìù\x20Context:','auto_expire','2\x20minutes','delete','values','message','status_check','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'];a37_0x2855=function(){return _0x223a50;};return a37_0x2855();}const a37_0x130efa=a37_0xb98c;(function(_0x55c110,_0x4ff722){const _0x39dc47=a37_0xb98c,_0x1db082=_0x55c110();while(!![]){try{const _0x26377e=parseInt(_0x39dc47(0xdc))/0x1+-parseInt(_0x39dc47(0x128))/0x2*(-parseInt(_0x39dc47(0x96))/0x3)+parseInt(_0x39dc47(0xb3))/0x4*(-parseInt(_0x39dc47(0x152))/0x5)+-parseInt(_0x39dc47(0xfb))/0x6+-parseInt(_0x39dc47(0xc2))/0x7+-parseInt(_0x39dc47(0x127))/0x8*(-parseInt(_0x39dc47(0xa8))/0x9)+-parseInt(_0x39dc47(0x108))/0xa*(parseInt(_0x39dc47(0x104))/0xb);if(_0x26377e===_0x4ff722)break;else _0x1db082['push'](_0x1db082['shift']());}catch(_0x3d4388){_0x1db082['push'](_0x1db082['shift']());}}}(a37_0x2855,0xc6323));var __importDefault=this&&this['__importDefault']||function(_0x4e2324){const _0xb8957e=a37_0xb98c;return _0x4e2324&&_0x4e2324[_0xb8957e(0xf8)]?_0x4e2324:{'default':_0x4e2324};};Object[a37_0x130efa(0x9e)](exports,a37_0x130efa(0xf8),{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0x130efa(0xa0)]=void 0x0;const coinToPayService_1=require(a37_0x130efa(0xcd)),database_1=__importDefault(require(a37_0x130efa(0x14a))),telegramBotService_1=require(a37_0x130efa(0xb9)),loggerService_1=require(a37_0x130efa(0xc7));class CoinToPayStatusService{constructor(){const _0x44b011=a37_0x130efa;this['globalCheckInterval']=null,this[_0x44b011(0x149)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x44b011(0xac)]=new Map(),this[_0x44b011(0xb8)]=new coinToPayService_1[(_0x44b011(0x160))](),console[_0x44b011(0x100)](_0x44b011(0x9d));}[a37_0x130efa(0x75)](_0x309a97,_0x5d44b2){const _0x5a790a=a37_0x130efa;console[_0x5a790a(0x100)](_0x5a790a(0x155)),console[_0x5a790a(0x100)](_0x5a790a(0x125)+_0x309a97),console[_0x5a790a(0x100)](_0x5a790a(0xf5)+_0x5d44b2),this[_0x5a790a(0x74)](_0x309a97);const _0x4d9ef9=[],_0x4fb67b=new Date(),_0x27a915=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x5a790a(0xe1)},{'delay':0x5*0x3c*0x3e8,'description':_0x5a790a(0x95)},{'delay':0x5*0x3c*0x3e8,'description':_0x5a790a(0x95)}];console['log'](_0x5a790a(0x84)+_0x27a915[_0x5a790a(0x132)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x309a97);let _0x1f64ca=0x0;_0x27a915[_0x5a790a(0x131)]((_0x2dcf63,_0x14dfee)=>{const _0x14c908=_0x5a790a;_0x1f64ca+=_0x2dcf63[_0x14c908(0xce)];const _0x53946c=setTimeout(async()=>{const _0x4c35be=_0x14c908;console[_0x4c35be(0x100)]('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x14dfee+0x1)+_0x4c35be(0xbb)+_0x309a97+_0x4c35be(0x114)+_0x2dcf63[_0x4c35be(0x11a)]+')');try{await this[_0x4c35be(0x112)](_0x309a97),console['log'](_0x4c35be(0xe6)+(_0x14dfee+0x1)+_0x4c35be(0xef)+_0x309a97);}catch(_0x3989a2){console[_0x4c35be(0x10c)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x14dfee+0x1)+_0x4c35be(0xb2)+_0x309a97+':',_0x3989a2),this[_0x4c35be(0xb0)](_0x309a97,_0x5d44b2,_0x3989a2,_0x4c35be(0xe5),{'checkNumber':_0x14dfee+0x1,'scheduledAfter':_0x2dcf63[_0x4c35be(0x11a)],'isIndividualCheck':!![]});}},_0x1f64ca);_0x4d9ef9[_0x14c908(0x154)](_0x53946c),console[_0x14c908(0x100)](_0x14c908(0x113)+(_0x14dfee+0x1)+_0x14c908(0xb2)+_0x309a97+_0x14c908(0x8d)+_0x1f64ca/0x3e8+_0x14c908(0xb4)+_0x2dcf63[_0x14c908(0x11a)]+')');});const _0x4156d9=setInterval(async()=>{const _0x1f2e5b=_0x5a790a;console[_0x1f2e5b(0x100)](_0x1f2e5b(0x15d)+_0x309a97);try{const _0x2a2fd8=await database_1[_0x1f2e5b(0x94)][_0x1f2e5b(0xfc)][_0x1f2e5b(0x80)]({'where':{'id':_0x309a97},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x2a2fd8){console['log']('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x309a97+'\x20not\x20found,\x20clearing\x20timers'),this['clearPaymentTimers'](_0x309a97);return;}console[_0x1f2e5b(0x100)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x309a97+_0x1f2e5b(0x77)+_0x2a2fd8['status']);if(_0x2a2fd8[_0x1f2e5b(0xde)]!=='PENDING'){console[_0x1f2e5b(0x100)](_0x1f2e5b(0x142)+_0x309a97+'\x20status\x20is\x20'+_0x2a2fd8[_0x1f2e5b(0xde)]+_0x1f2e5b(0xb7)),this['clearPaymentTimers'](_0x309a97);return;}const _0x5df92f=Math['floor']((Date[_0x1f2e5b(0xa6)]()-_0x2a2fd8[_0x1f2e5b(0x88)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x5df92f>=this[_0x1f2e5b(0x10b)]){console[_0x1f2e5b(0x100)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x309a97+_0x1f2e5b(0x14f)+this[_0x1f2e5b(0x10b)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x1f2e5b(0x74)](_0x309a97);return;}await this[_0x1f2e5b(0x112)](_0x309a97),console[_0x1f2e5b(0x100)]('‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x309a97);}catch(_0x1ab87e){console[_0x1f2e5b(0x10c)]('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x309a97+':',_0x1ab87e),this[_0x1f2e5b(0xb0)](_0x309a97,_0x5d44b2,_0x1ab87e,_0x1f2e5b(0xe5),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x4d9ef9[_0x5a790a(0x154)](_0x4156d9),this['paymentTimers'][_0x5a790a(0xf7)](_0x309a97,{'timers':_0x4d9ef9,'paymentId':_0x309a97,'gatewayPaymentId':_0x5d44b2,'createdAt':_0x4fb67b}),console['log'](_0x5a790a(0x7d)+_0x27a915[_0x5a790a(0x132)]+_0x5a790a(0x147)+_0x309a97),console['log']('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x5a790a(0xac)][_0x5a790a(0x12a)]),this[_0x5a790a(0x8c)](_0x309a97,_0x5d44b2,_0x5a790a(0xc0),_0x5a790a(0xc0),'status_check',{'action':_0x5a790a(0x85),'scheduledChecks':_0x27a915[_0x5a790a(0x132)],'firstCheckIn':_0x27a915[0x0][_0x5a790a(0xce)]/0x3e8,'totalTimers':this[_0x5a790a(0xac)]['size']});}['clearPaymentTimers'](_0x2b56e0){const _0x226108=a37_0x130efa,_0x5ebe4a=this[_0x226108(0xac)][_0x226108(0x7f)](_0x2b56e0);_0x5ebe4a?(console['log'](_0x226108(0xf6)+_0x5ebe4a[_0x226108(0x9f)][_0x226108(0x132)]+_0x226108(0x15b)+_0x2b56e0),_0x5ebe4a[_0x226108(0x9f)][_0x226108(0x131)]((_0x1c9fc3,_0x3bf125)=>{const _0xf60c2a=_0x226108;_0x1c9fc3&&(clearTimeout(_0x1c9fc3),clearInterval(_0x1c9fc3),console[_0xf60c2a(0x100)](_0xf60c2a(0x14c)+(_0x3bf125+0x1)+'\x20for\x20payment\x20'+_0x2b56e0));}),this['paymentTimers'][_0x226108(0xe2)](_0x2b56e0),console['log'](_0x226108(0xc6)+_0x2b56e0+_0x226108(0x9a)+this['paymentTimers'][_0x226108(0x12a)])):console[_0x226108(0x100)](_0x226108(0xfd)+_0x2b56e0+_0x226108(0xbe));}async[a37_0x130efa(0x112)](_0x144c93){const _0x4034a2=a37_0x130efa;console[_0x4034a2(0x100)](_0x4034a2(0xd2)+_0x144c93);const _0x42d3d8=await database_1['default'][_0x4034a2(0xfc)][_0x4034a2(0x80)]({'where':{'id':_0x144c93},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x42d3d8){console['log']('‚ùå\x20[CHECK]\x20Payment\x20'+_0x144c93+_0x4034a2(0x136));return;}console[_0x4034a2(0x100)]('üìä\x20[CHECK]\x20Payment\x20'+_0x144c93+'\x20found:'),console[_0x4034a2(0x100)](_0x4034a2(0x13a)+_0x42d3d8['gateway']),console[_0x4034a2(0x100)](_0x4034a2(0xd3)+_0x42d3d8[_0x4034a2(0xde)]),console[_0x4034a2(0x100)](_0x4034a2(0xf4)+_0x42d3d8[_0x4034a2(0xf3)]),console[_0x4034a2(0x100)](_0x4034a2(0x119)+_0x42d3d8[_0x4034a2(0x13e)]+'\x20'+_0x42d3d8[_0x4034a2(0x98)]),console[_0x4034a2(0x100)](_0x4034a2(0x126)+_0x42d3d8[_0x4034a2(0x83)]);if(_0x42d3d8[_0x4034a2(0x103)]!=='cointopay'){console[_0x4034a2(0x100)](_0x4034a2(0x150)+_0x144c93+_0x4034a2(0x90)+_0x42d3d8['gateway']+')');return;}if(_0x42d3d8[_0x4034a2(0xde)]!==_0x4034a2(0xc0)){console[_0x4034a2(0x100)](_0x4034a2(0x150)+_0x144c93+_0x4034a2(0x11e)+_0x42d3d8[_0x4034a2(0xde)]+',\x20stopping\x20individual\x20checks'),this[_0x4034a2(0x74)](_0x144c93);return;}if(!_0x42d3d8[_0x4034a2(0xf3)]){console[_0x4034a2(0x100)](_0x4034a2(0x150)+_0x144c93+_0x4034a2(0x8f));return;}console[_0x4034a2(0x100)](_0x4034a2(0x141)+_0x144c93+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x4034a2(0xdd)](_0x42d3d8);}[a37_0x130efa(0x8c)](_0x4f81b2,_0x3444d9,_0x53bbe3,_0x1ad863,_0x231fe2,_0x4f1864){const _0x10b13e=a37_0x130efa,_0x1506b3={'type':_0x10b13e(0x121),'paymentId':_0x4f81b2,'gatewayPaymentId':_0x3444d9,'oldStatus':_0x53bbe3,'newStatus':_0x1ad863,'source':_0x231fe2,'timestamp':new Date()[_0x10b13e(0x87)](),'details':_0x4f1864||{}};loggerService_1[_0x10b13e(0x133)][_0x10b13e(0x8c)](_0x1506b3),console[_0x10b13e(0x100)](_0x10b13e(0x14e)+_0x4f81b2+'\x20('+_0x3444d9+')'),console[_0x10b13e(0x100)]('\x20\x20\x20üìä\x20Status:\x20'+_0x53bbe3+_0x10b13e(0xec)+_0x1ad863),console[_0x10b13e(0x100)](_0x10b13e(0x8a)+_0x231fe2),console[_0x10b13e(0x100)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x1506b3[_0x10b13e(0x116)]),_0x4f1864&&console[_0x10b13e(0x100)](_0x10b13e(0x146),_0x4f1864);}[a37_0x130efa(0xb0)](_0x347ef4,_0x34bd43,_0x5f1cd9,_0x40f2e4,_0x24d69b){const _0x56eee8=a37_0x130efa,_0x1ec2f7={'type':_0x56eee8(0xd7),'paymentId':_0x347ef4,'gatewayPaymentId':_0x34bd43,'error':_0x5f1cd9 instanceof Error?{'message':_0x5f1cd9[_0x56eee8(0xe4)],'stack':_0x5f1cd9[_0x56eee8(0x82)]}:_0x5f1cd9,'source':_0x40f2e4,'timestamp':new Date()['toISOString'](),'context':_0x24d69b||{}};loggerService_1[_0x56eee8(0x133)][_0x56eee8(0xb0)](_0x1ec2f7),console[_0x56eee8(0x10c)](_0x56eee8(0xae)+_0x347ef4+'\x20('+_0x34bd43+')'),console[_0x56eee8(0x10c)](_0x56eee8(0xb1)+(_0x5f1cd9 instanceof Error?_0x5f1cd9[_0x56eee8(0xe4)]:_0x5f1cd9)),console[_0x56eee8(0x10c)](_0x56eee8(0x8a)+_0x40f2e4),console[_0x56eee8(0x10c)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x1ec2f7[_0x56eee8(0x116)]),_0x24d69b&&console['error'](_0x56eee8(0xdf),_0x24d69b);}['startPeriodicStatusCheck'](){const _0x7528b4=a37_0x130efa;console[_0x7528b4(0x100)]('ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x7528b4(0x13d)]()[_0x7528b4(0x143)](_0x5ed1ac=>{const _0x5d37f1=_0x7528b4;console['error'](_0x5d37f1(0x13b),_0x5ed1ac);}),this[_0x7528b4(0xd1)]=setInterval(async()=>{const _0x224dcb=_0x7528b4;try{console['log']('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x224dcb(0x13d)](),console[_0x224dcb(0x100)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x938f2e){console[_0x224dcb(0x10c)]('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x938f2e);}},this[_0x7528b4(0x149)]),console[_0x7528b4(0x100)]('‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x130efa(0x11b)](){const _0x599fb9=a37_0x130efa;console[_0x599fb9(0x100)](_0x599fb9(0xf2));this[_0x599fb9(0xd1)]&&(clearInterval(this[_0x599fb9(0xd1)]),this['globalCheckInterval']=null,console[_0x599fb9(0x100)](_0x599fb9(0x8b)));const _0x1386dd=this[_0x599fb9(0xac)][_0x599fb9(0x12a)];for(const [_0x5b8d4c]of this[_0x599fb9(0xac)]){this['clearPaymentTimers'](_0x5b8d4c);}console[_0x599fb9(0x100)](_0x599fb9(0xbf)+_0x1386dd+'\x20individual\x20payment\x20timers');}async['checkAllPendingPayments'](){const _0x46bc7a=a37_0x130efa;try{console['log'](_0x46bc7a(0xad));const _0x162b77=await database_1['default'][_0x46bc7a(0xfc)][_0x46bc7a(0xf1)]({'where':{'gateway':'cointopay','status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x46bc7a(0x100)](_0x46bc7a(0x76)+_0x162b77['length']+'\x20pending\x20CoinToPay\x20payments');if(_0x162b77[_0x46bc7a(0x132)]===0x0){console['log'](_0x46bc7a(0x12b));return;}const _0x1ec5a7=await this[_0x46bc7a(0xc5)](_0x162b77);console[_0x46bc7a(0x100)](_0x46bc7a(0x7b)+_0x1ec5a7[_0x46bc7a(0x132)]+_0x46bc7a(0x11f));let _0x531214=0x0,_0x269217=0x0;for(const _0x198b8c of _0x162b77){try{if(_0x1ec5a7[_0x46bc7a(0xed)](_0x198b8c['id'])){console[_0x46bc7a(0x100)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x198b8c['id']+_0x46bc7a(0x139)),_0x269217++;continue;}if(this[_0x46bc7a(0xac)][_0x46bc7a(0xa4)](_0x198b8c['id'])){console['log'](_0x46bc7a(0x153)+_0x198b8c['id']+_0x46bc7a(0x78)),_0x269217++;continue;}const _0x967cf=(Date['now']()-_0x198b8c[_0x46bc7a(0x88)][_0x46bc7a(0x92)]())/(0x3e8*0x3c*0x3c);if(_0x967cf<0x1){console['log']('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x198b8c['id']+_0x46bc7a(0x81)+_0x967cf[_0x46bc7a(0xc1)](0x1)+_0x46bc7a(0x12c)),_0x269217++;continue;}console[_0x46bc7a(0x100)]('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x198b8c['id']+_0x46bc7a(0x14d)+_0x967cf[_0x46bc7a(0xc1)](0x1)+'h)'),await this[_0x46bc7a(0xdd)](_0x198b8c),_0x531214++,await new Promise(_0x5e08a7=>setTimeout(_0x5e08a7,0x7d0));}catch(_0x2ff464){console[_0x46bc7a(0x10c)](_0x46bc7a(0x156)+_0x198b8c['id']+':',_0x2ff464),this['logCoinToPayError'](_0x198b8c['id'],_0x198b8c[_0x46bc7a(0xf3)]||_0x46bc7a(0x151),_0x2ff464,_0x46bc7a(0xe5),{'isGlobalCheck':!![],'paymentAmount':_0x198b8c[_0x46bc7a(0x13e)],'paymentCurrency':_0x198b8c[_0x46bc7a(0x98)],'shopId':_0x198b8c[_0x46bc7a(0x83)],'createdAt':_0x198b8c[_0x46bc7a(0x88)]}),loggerService_1['loggerService'][_0x46bc7a(0xc3)]('cointopay',_0x46bc7a(0x12d)+_0x198b8c['gatewayPaymentId'],_0x2ff464);}}console['log'](_0x46bc7a(0xaa)+_0x531214+_0x46bc7a(0xa9)+_0x269217+_0x46bc7a(0x106)+_0x1ec5a7['length']+_0x46bc7a(0xda));}catch(_0x263dc1){console[_0x46bc7a(0x10c)](_0x46bc7a(0x13f),_0x263dc1);}}async[a37_0x130efa(0xc5)](_0x57a940){const _0x5afe8a=a37_0x130efa,_0x54e08c=[],_0x5a78fc=new Date();_0x5a78fc[_0x5afe8a(0xf9)](_0x5a78fc[_0x5afe8a(0x129)]()-this[_0x5afe8a(0x10b)]),console[_0x5afe8a(0x100)](_0x5afe8a(0x13c)+this[_0x5afe8a(0x10b)]+'\x20days\x20(created\x20before\x20'+_0x5a78fc[_0x5afe8a(0x87)]()+')');for(const _0x541b07 of _0x57a940){if(_0x541b07[_0x5afe8a(0x88)]<_0x5a78fc){console[_0x5afe8a(0x100)]('‚è∞\x20[EXPIRY]\x20Payment\x20'+_0x541b07['id']+_0x5afe8a(0x14f)+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x5afe8a(0x8c)](_0x541b07['id'],_0x541b07[_0x5afe8a(0xf3)]||_0x5afe8a(0x151),'PENDING',_0x5afe8a(0xbc),_0x5afe8a(0xe0),{'reason':_0x5afe8a(0x137)+this[_0x5afe8a(0x10b)]+_0x5afe8a(0x109),'createdAt':_0x541b07[_0x5afe8a(0x88)],'daysSinceCreation':Math['floor']((Date['now']()-_0x541b07[_0x5afe8a(0x88)][_0x5afe8a(0x92)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x541b07['amount'],'paymentCurrency':_0x541b07[_0x5afe8a(0x98)],'shopId':_0x541b07[_0x5afe8a(0x83)]}),await database_1[_0x5afe8a(0x94)][_0x5afe8a(0xfc)][_0x5afe8a(0xca)]({'where':{'id':_0x541b07['id']},'data':{'status':_0x5afe8a(0xbc),'updatedAt':new Date(),'adminNotes':_0x5afe8a(0x159)+this['EXPIRY_DAYS']+_0x5afe8a(0x118)}}),await database_1[_0x5afe8a(0x94)][_0x5afe8a(0x105)][_0x5afe8a(0xd8)]({'data':{'paymentId':_0x541b07['id'],'shopId':_0x541b07[_0x5afe8a(0x83)],'event':_0x5afe8a(0xb6),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x5afe8a(0x137)+this[_0x5afe8a(0x10b)]+_0x5afe8a(0x109),'createdAt':_0x541b07[_0x5afe8a(0x88)],'expiredAt':new Date()[_0x5afe8a(0x87)](),'daysSinceCreation':Math['floor']((Date['now']()-_0x541b07['createdAt'][_0x5afe8a(0x92)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x5afe8a(0xd0)](_0x541b07,_0x5afe8a(0xbc)),await this[_0x5afe8a(0xd4)](_0x541b07,_0x5afe8a(0xbc)),this[_0x5afe8a(0x74)](_0x541b07['id']),_0x54e08c[_0x5afe8a(0x154)](_0x541b07['id']),console[_0x5afe8a(0x100)](_0x5afe8a(0x91)+_0x541b07['id']+_0x5afe8a(0xeb)+this['EXPIRY_DAYS']+_0x5afe8a(0xfa));}catch(_0x4c730a){console[_0x5afe8a(0x10c)]('‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x541b07['id']+':',_0x4c730a),this['logCoinToPayError'](_0x541b07['id'],_0x541b07['gatewayPaymentId']||'unknown',_0x4c730a,'auto_expire',{'reason':_0x5afe8a(0x158),'createdAt':_0x541b07[_0x5afe8a(0x88)],'daysSinceCreation':Math['floor']((Date[_0x5afe8a(0xa6)]()-_0x541b07[_0x5afe8a(0x88)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x54e08c;}async[a37_0x130efa(0xdd)](_0xfaea52){const _0x214b90=a37_0x130efa;if(!_0xfaea52['gatewayPaymentId']){console[_0x214b90(0x100)](_0x214b90(0x150)+_0xfaea52['id']+_0x214b90(0xa1));return;}console[_0x214b90(0x100)](_0x214b90(0x11c)+_0xfaea52['id']+'\x20('+_0xfaea52['gatewayPaymentId']+')');try{const _0x999fd2=await this[_0x214b90(0xb8)]['checkPaymentStatus'](_0xfaea52[_0x214b90(0xf3)]);console[_0x214b90(0x100)](_0x214b90(0x144)+_0xfaea52['id']+_0x214b90(0x157)+_0x999fd2[_0x214b90(0xde)]);_0x999fd2[_0x214b90(0x9c)]&&console[_0x214b90(0x100)](_0x214b90(0x144)+_0xfaea52['id']+_0x214b90(0x120),{'iban':_0x999fd2[_0x214b90(0x9c)][_0x214b90(0x7e)]||'not\x20found','transactionId':_0x999fd2['paymentDetails'][_0x214b90(0x89)],'createdOn':_0x999fd2[_0x214b90(0x9c)][_0x214b90(0xa7)],'confirmedOn':_0x999fd2['paymentDetails'][_0x214b90(0x123)]||_0x214b90(0x111)});if(_0x999fd2[_0x214b90(0xde)]!==_0xfaea52[_0x214b90(0xde)]){console['log'](_0x214b90(0xc4)+_0xfaea52['id']+_0x214b90(0x162)+_0xfaea52['status']+_0x214b90(0xf0)+_0x999fd2[_0x214b90(0xde)]),this[_0x214b90(0x8c)](_0xfaea52['id'],_0xfaea52[_0x214b90(0xf3)],_0xfaea52[_0x214b90(0xde)],_0x999fd2[_0x214b90(0xde)],_0x214b90(0xe5),{'paymentDetails':_0x999fd2[_0x214b90(0x9c)],'amount':_0x999fd2[_0x214b90(0x13e)],'currency':_0x999fd2[_0x214b90(0x98)],'shopId':_0xfaea52['shopId'],'checkTimestamp':new Date()['toISOString']()});const _0x46aaff={'status':_0x999fd2[_0x214b90(0xde)],'updatedAt':new Date()};_0x999fd2[_0x214b90(0xde)]===_0x214b90(0x15f)&&_0xfaea52[_0x214b90(0xde)]!==_0x214b90(0x15f)&&(_0x46aaff[_0x214b90(0xc8)]=new Date(),console[_0x214b90(0x100)](_0x214b90(0xcc)+_0xfaea52['id']+_0x214b90(0x140)+_0x46aaff[_0x214b90(0xc8)][_0x214b90(0x87)]()));if(_0x999fd2[_0x214b90(0x9c)]){const _0x12fb22=_0x999fd2[_0x214b90(0x9c)];_0x12fb22[_0x214b90(0x7e)]&&(_0x46aaff[_0x214b90(0x79)]=_0x12fb22[_0x214b90(0x7e)],console[_0x214b90(0x100)](_0x214b90(0x11d)+_0x12fb22['iban']));if(_0x12fb22['bankDetails']){const _0x169208=_0xfaea52[_0x214b90(0x138)]||'',_0x248b51=_0x214b90(0x15a)+_0x12fb22[_0x214b90(0x99)];_0x46aaff[_0x214b90(0x138)]=_0x169208?_0x169208+'\x0a\x0a'+_0x248b51:_0x248b51,console['log'](_0x214b90(0x8e));}_0x12fb22[_0x214b90(0x89)]&&console[_0x214b90(0x100)](_0x214b90(0xab)+_0x12fb22[_0x214b90(0x89)]),_0x12fb22[_0x214b90(0x123)]&&console[_0x214b90(0x100)](_0x214b90(0x97)+_0x12fb22[_0x214b90(0x123)]);}await database_1[_0x214b90(0x94)][_0x214b90(0xfc)][_0x214b90(0xca)]({'where':{'id':_0xfaea52['id']},'data':_0x46aaff}),await database_1[_0x214b90(0x94)][_0x214b90(0x105)][_0x214b90(0xd8)]({'data':{'paymentId':_0xfaea52['id'],'shopId':_0xfaea52[_0x214b90(0x83)],'event':_0x214b90(0x7a)+_0x999fd2[_0x214b90(0xde)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x214b90(0xff)]({'oldStatus':_0xfaea52[_0x214b90(0xde)],'newStatus':_0x999fd2['status'],'paymentDetails':_0x999fd2[_0x214b90(0x9c)],'checkedAt':new Date()[_0x214b90(0x87)]()})}}),await this[_0x214b90(0xd0)](_0xfaea52,_0x999fd2[_0x214b90(0xde)]),await this[_0x214b90(0xd4)](_0xfaea52,_0x999fd2[_0x214b90(0xde)]),_0x999fd2[_0x214b90(0xde)]!=='PENDING'&&(console[_0x214b90(0x100)](_0x214b90(0xcf)+_0xfaea52['id']+_0x214b90(0xa2)+_0x999fd2[_0x214b90(0xde)]+_0x214b90(0xc9)),this[_0x214b90(0x74)](_0xfaea52['id'])),console['log'](_0x214b90(0x141)+_0xfaea52['id']+_0x214b90(0xba));}else console[_0x214b90(0x100)](_0x214b90(0x144)+_0xfaea52['id']+'\x20status\x20unchanged\x20('+_0x999fd2[_0x214b90(0xde)]+')'),this[_0x214b90(0x8c)](_0xfaea52['id'],_0xfaea52[_0x214b90(0xf3)],_0xfaea52[_0x214b90(0xde)],_0x999fd2[_0x214b90(0xde)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x999fd2['paymentDetails'],'amount':_0x999fd2['amount'],'currency':_0x999fd2[_0x214b90(0x98)],'shopId':_0xfaea52[_0x214b90(0x83)],'checkTimestamp':new Date()[_0x214b90(0x87)]()});}catch(_0x315d31){console['error'](_0x214b90(0xd6)+_0xfaea52['id']+':',_0x315d31),this[_0x214b90(0xb0)](_0xfaea52['id'],_0xfaea52['gatewayPaymentId'],_0x315d31,_0x214b90(0xe5),{'paymentAmount':_0xfaea52[_0x214b90(0x13e)],'paymentCurrency':_0xfaea52[_0x214b90(0x98)],'shopId':_0xfaea52[_0x214b90(0x83)],'createdAt':_0xfaea52[_0x214b90(0x88)]}),await database_1['default'][_0x214b90(0x105)]['create']({'data':{'paymentId':_0xfaea52['id'],'shopId':_0xfaea52[_0x214b90(0x83)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x214b90(0xff)]({'error':_0x315d31 instanceof Error?_0x315d31[_0x214b90(0xe4)]:_0x214b90(0xe9),'gatewayPaymentId':_0xfaea52['gatewayPaymentId'],'checkedAt':new Date()[_0x214b90(0x87)]()})}});}}async['sendShopWebhook'](_0x3066e3,_0x5ef4e9){const _0x344700=a37_0x130efa,_0x4af594=Date[_0x344700(0xa6)]();try{const _0x3fc686=_0x3066e3[_0x344700(0xa3)],_0x2aeb69=_0x3fc686[_0x344700(0x10f)];if(!_0x2aeb69?.[_0x344700(0x10a)]){console[_0x344700(0x100)](_0x344700(0xee)+_0x3fc686['id']);return;}const _0x475327=_0x5ef4e9===_0x344700(0x15f)?_0x344700(0xe7):_0x5ef4e9===_0x344700(0x9b)?_0x344700(0xd9):_0x5ef4e9===_0x344700(0xbc)?_0x344700(0xd9):_0x344700(0xa5);if(!_0x2aeb69[_0x344700(0x10e)]?.[_0x344700(0xed)](_0x475327)){console['log']('Webhook\x20event\x20'+_0x475327+_0x344700(0xfe)+_0x3fc686['id']);return;}const _0x4d0b3d={'event':_0x475327,'payment':{'id':_0x3066e3['id'],'order_id':_0x3066e3[_0x344700(0x134)],'gateway_order_id':_0x3066e3['gatewayOrderId'],'gateway':_0x344700(0x15e),'amount':_0x3066e3[_0x344700(0x13e)],'currency':_0x3066e3[_0x344700(0x98)],'status':_0x5ef4e9[_0x344700(0x93)](),'customer_email':_0x3066e3[_0x344700(0x130)],'customer_name':_0x3066e3[_0x344700(0x148)],'created_at':_0x3066e3[_0x344700(0x88)],'updated_at':new Date()}},_0x10a2fe=await fetch(_0x2aeb69['webhookUrl'],{'method':_0x344700(0x115),'headers':{'Content-Type':_0x344700(0x101),'User-Agent':_0x344700(0xdb)},'body':JSON[_0x344700(0xff)](_0x4d0b3d)}),_0x18a0a4=Date[_0x344700(0xa6)]()-_0x4af594,_0x404113=_0x10a2fe['ok']?_0x344700(0x12f):await _0x10a2fe[_0x344700(0xcb)]();loggerService_1[_0x344700(0x133)][_0x344700(0xb5)](_0x3066e3[_0x344700(0x83)],_0x2aeb69[_0x344700(0x10a)],_0x475327,_0x10a2fe[_0x344700(0xde)],_0x18a0a4,_0x4d0b3d),console[_0x344700(0x100)]('Shop\x20webhook\x20sent\x20to\x20'+_0x2aeb69[_0x344700(0x10a)]+_0x344700(0xea)+_0x10a2fe[_0x344700(0xde)]+'\x20('+_0x18a0a4+_0x344700(0x110));}catch(_0x4ab106){console[_0x344700(0x10c)](_0x344700(0xaf),_0x4ab106),loggerService_1[_0x344700(0x133)]['logShopWebhookError'](_0x3066e3['shopId'],_0x3066e3['shop']?.[_0x344700(0x10f)]?.[_0x344700(0x10a)]||_0x344700(0x151),'webhook_send',_0x4ab106,{});}}async[a37_0x130efa(0xd4)](_0x4c2c18,_0x4b3f10){const _0x2b03da=a37_0x130efa;try{const _0x18f223={'PENDING':_0x2b03da(0x15c),'PAID':_0x2b03da(0x7c),'FAILED':_0x2b03da(0x10d),'EXPIRED':_0x2b03da(0x145)},_0x4b89fd=_0x18f223[_0x4b3f10];if(!_0x4b89fd||_0x4b89fd===_0x2b03da(0x15c))return;await telegramBotService_1[_0x2b03da(0x107)][_0x2b03da(0x14b)](_0x4c2c18['shopId'],_0x4c2c18,_0x4b89fd);}catch(_0x1aa5eb){console[_0x2b03da(0x10c)](_0x2b03da(0x12e),_0x1aa5eb);}}async[a37_0x130efa(0xbd)](_0x325c3a){const _0x44096f=a37_0x130efa;console['log']('üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x325c3a);const _0x282319=await database_1[_0x44096f(0x94)][_0x44096f(0xfc)][_0x44096f(0x80)]({'where':{'id':_0x325c3a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x282319)throw new Error(_0x44096f(0x124));if(_0x282319['gateway']!==_0x44096f(0x161))throw new Error(_0x44096f(0x117));console['log'](_0x44096f(0x135)+_0x325c3a),await this[_0x44096f(0xdd)](_0x282319),console[_0x44096f(0x100)]('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x325c3a);}[a37_0x130efa(0xd5)](){const _0x1521de=a37_0x130efa,_0x2e1f9c=this['globalCheckInterval']?this[_0x1521de(0x149)]:undefined,_0x4e4bf7=Array['from'](this[_0x1521de(0xac)][_0x1521de(0xe3)]())[_0x1521de(0x102)](_0x52ade9=>({'paymentId':_0x52ade9[_0x1521de(0x122)],'gatewayPaymentId':_0x52ade9[_0x1521de(0xf3)],'createdAt':_0x52ade9[_0x1521de(0x88)],'timersCount':_0x52ade9[_0x1521de(0x9f)][_0x1521de(0x132)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this['paymentTimers'][_0x1521de(0x12a)],'nextGlobalCheckIn':_0x2e1f9c,'paymentTimersDetails':_0x4e4bf7};}[a37_0x130efa(0x86)](_0x5bfe2b){const _0x21bb38=a37_0x130efa,_0x4e590b=this[_0x21bb38(0xac)][_0x21bb38(0x7f)](_0x5bfe2b);if(_0x4e590b)return{'hasTimers':!![],'timersCount':_0x4e590b[_0x21bb38(0x9f)][_0x21bb38(0x132)],'createdAt':_0x4e590b[_0x21bb38(0x88)],'gatewayPaymentId':_0x4e590b[_0x21bb38(0xf3)]};return{'hasTimers':![]};}}function a37_0xb98c(_0x1c65b5,_0x35531d){const _0x28558c=a37_0x2855();return a37_0xb98c=function(_0xb98c53,_0x4f82bf){_0xb98c53=_0xb98c53-0x74;let _0x432971=_0x28558c[_0xb98c53];return _0x432971;},a37_0xb98c(_0x1c65b5,_0x35531d);}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a37_0x130efa(0xe8)]=new CoinToPayStatusService();