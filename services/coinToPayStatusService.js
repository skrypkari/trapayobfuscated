'use strict';const a35_0xdac582=a35_0x5128;(function(_0x44045c,_0x3197ca){const _0x34cc2b=a35_0x5128,_0x52793a=_0x44045c();while(!![]){try{const _0x2014cb=parseInt(_0x34cc2b(0x2cb))/0x1*(parseInt(_0x34cc2b(0x2ae))/0x2)+parseInt(_0x34cc2b(0x29b))/0x3+parseInt(_0x34cc2b(0x1f6))/0x4+parseInt(_0x34cc2b(0x1fc))/0x5*(parseInt(_0x34cc2b(0x1f0))/0x6)+-parseInt(_0x34cc2b(0x286))/0x7+parseInt(_0x34cc2b(0x22a))/0x8*(-parseInt(_0x34cc2b(0x241))/0x9)+parseInt(_0x34cc2b(0x23d))/0xa;if(_0x2014cb===_0x3197ca)break;else _0x52793a['push'](_0x52793a['shift']());}catch(_0x3ea3f8){_0x52793a['push'](_0x52793a['shift']());}}}(a35_0x3894,0xd4588));function a35_0x3894(){const _0x107dd8=['map','CoinToPayService','unknown','catch','create','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','set','PENDING','coinToPayService','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','1\x20minute','⚠️\x20[CHECK]\x20Payment\x20','push','\x20status\x20is\x20','\x20timers\x20for\x20payment\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','Failed\x20to\x20send\x20shop\x20webhook:','\x20\x20\x20-\x20ShopId:\x20','message','🧹\x20[DEBUG]\x20Clearing\x20','stack','webhookEvents','status_check','currency','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','schedulePaymentChecks','\x20not\x20enabled\x20for\x20shop\x20','settings','checkSinglePayment','cointopay_auto_expired','checkAllPendingPayments','paymentDetails','stringify','values','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','ms)','getDate','Payment\x20older\x20than\x20','delay','\x20\x20\x20📅\x20Time:\x20','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','createdAt','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','getServiceStats','paymentId','6587861QeBhuq','\x20status\x20changed\x20to\x20','\x20\x20\x20📝\x20Context:','\x20\x20\x20📝\x20Details:','Unknown\x20error','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','bankDetails',',\x20stopping\x20individual\x20checks','\x20current\x20status:\x20','createdOn','gatewayOrderId','getTime','✅\x20[EXPIRY]\x20Payment\x20','\x20skipped,\x20','toLowerCase','PAID','\x20individual\x20payment\x20timers','logShopWebhookError','0100','🛑\x20[SHUTDOWN]\x20Cleared\x20','157386BwQZxg','❌\x20[HOURLY]\x20Payment\x20','gatewayPaymentId','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','⏰\x20[GLOBAL]\x20Found\x20','\x20to\x20clear','Failed\x20to\x20mark\x20payment\x20as\x20expired','amount','cointopay','gateway','size','webhookLog','payment','5\x20minutes','includes','\x20with\x20status\x20','__esModule','created','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','22TlGGec','auto_expire','has','adminNotes','transactionId','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','Bank\x20Details:\x20','log','\x20to\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','toISOString','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','delete','\x20\x20\x20-\x20gatewayPaymentId:\x20','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','telegramBotService','confirmedOn','sendShopWebhook','clearPaymentTimers','checkPaymentById','⏰\x20[GLOBAL]\x20Payment\x20','./gateways/coinToPayService','🧹\x20[CHECK]\x20Payment\x20','paidAt','EXPIRY_DAYS','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','floor','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','orderId','123742WrWBSK','not\x20found','update','get','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','sendPaymentStatusNotification','\x20days','checkExpiredPayments','payment.failed','logCoinToPayStatus','1038930hOjOUl','-day\x20timeout','🪙\x20[GLOBAL]\x20Found\x20','\x20for\x20payment\x20','description','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','1435880psiBZe','\x20\x20\x20-\x20Amount:\x20','customerEmail','default','FAILED','timers','20sHdImZ','📊\x20[HOURLY]\x20Payment\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20days,\x20marking\x20as\x20EXPIRED','\x20(after\x20','forEach','Success','shop','\x20seconds\x20(','cointopay_status_check_','\x20updated\x20successfully','\x20not\x20found,\x20clearing\x20timers','\x20completed\x20for\x20payment\x20','\x20status\x20from\x20','now','remitterIban','\x20->\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','📊\x20[CHECK]\x20Payment\x20','\x20initial\x20timers\x20for\x20payment\x20','../config/database','\x20\x20\x20-\x20Gateway:\x20','webhookUrl','failed','stopPeriodicStatusCheck','status','Payment\x20not\x20found','h),\x20skipping\x20global\x20check','Webhook\x20event\x20','🪙\x20[DEBUG]\x20Creating\x20','checkPaymentStatus','timestamp','checkSinglePaymentById','text','COINTOPAY_STATUS_CHANGE','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','paymentTimers','loggerService','logShopWebhookSent','cointopay_status_check_error','COINTOPAY_ERROR','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','CoinToPayStatusService','paid','\x20is\x20older\x20than\x20','\x20\x20\x20📊\x20Status:\x20','6504qenrrU','iban','🔄\x20[CHECK]\x20Updating\x20payment\x20','\x20\x20\x20-\x20Status:\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','findUnique','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','✅\x20[HOURLY]\x20Payment\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','error','.\x20Remaining\x20active\x20timers:\x20','setDate','application/json','\x20(age:\x20','./telegramBotService','2\x20minutes','✅\x20[TIMER]\x20Individual\x20check\x20#','Shop\x20webhook\x20sent\x20to\x20','1806280muUujs','✅\x20[CHECK]\x20Payment\x20','not\x20confirmed','length','9243plZEqH','⏰\x20[EXPIRY]\x20Payment\x20','\x20details:','customerName','webhook_send','\x20not\x20found\x20in\x20database','toFixed','shopId','logCoinToPayError','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20marked\x20as\x20paid\x20at:\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','EXPIRED','coinToPayStatusService','logWhiteDomainError','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20\x20\x20-\x20paymentId:\x20','globalCheckInterval','GLOBAL_CHECK_INTERVAL_MS','\x20status\x20unchanged\x20('];a35_0x3894=function(){return _0x107dd8;};return a35_0x3894();}var __importDefault=this&&this['__importDefault']||function(_0x57ecba){const _0x250cbd=a35_0x5128;return _0x57ecba&&_0x57ecba[_0x250cbd(0x2ab)]?_0x57ecba:{'default':_0x57ecba};};function a35_0x5128(_0x4a196f,_0x143675){const _0x3894eb=a35_0x3894();return a35_0x5128=function(_0x512894,_0x1a9dd3){_0x512894=_0x512894-0x1e9;let _0x32c1d7=_0x3894eb[_0x512894];return _0x32c1d7;},a35_0x5128(_0x4a196f,_0x143675);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['coinToPayStatusService']=exports[a35_0xdac582(0x226)]=void 0x0;const coinToPayService_1=require(a35_0xdac582(0x2c3)),database_1=__importDefault(require(a35_0xdac582(0x210))),telegramBotService_1=require(a35_0xdac582(0x239)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x1f2809=a35_0xdac582;this['globalCheckInterval']=null,this[_0x1f2809(0x255)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this['paymentTimers']=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x1f2809(0x258))](),console[_0x1f2809(0x2b5)]('🪙\x20CoinToPayStatusService\x20initialized');}[a35_0xdac582(0x272)](_0xb42869,_0x256c94){const _0x582f0c=a35_0xdac582;console[_0x582f0c(0x2b5)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x582f0c(0x2b5)](_0x582f0c(0x253)+_0xb42869),console[_0x582f0c(0x2b5)](_0x582f0c(0x2bb)+_0x256c94),this['clearPaymentTimers'](_0xb42869);const _0xfffb84=[],_0x4ae2a4=new Date(),_0x3f378b=[{'delay':0x1*0x3c*0x3e8,'description':_0x582f0c(0x262)},{'delay':0x2*0x3c*0x3e8,'description':_0x582f0c(0x23a)},{'delay':0x5*0x3c*0x3e8,'description':_0x582f0c(0x2a8)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console['log'](_0x582f0c(0x219)+_0x3f378b[_0x582f0c(0x240)]+_0x582f0c(0x20f)+_0xb42869);let _0x267adb=0x0;_0x3f378b[_0x582f0c(0x201)]((_0xa8458d,_0x4d218f)=>{const _0x3cf149=_0x582f0c;_0x267adb+=_0xa8458d[_0x3cf149(0x27f)];const _0x7e7421=setTimeout(async()=>{const _0x52f4ab=_0x3cf149;console[_0x52f4ab(0x2b5)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x4d218f+0x1)+'\x20triggered\x20for\x20payment\x20'+_0xb42869+_0x52f4ab(0x200)+_0xa8458d[_0x52f4ab(0x1f4)]+')');try{await this[_0x52f4ab(0x21c)](_0xb42869),console[_0x52f4ab(0x2b5)](_0x52f4ab(0x23b)+(_0x4d218f+0x1)+_0x52f4ab(0x208)+_0xb42869);}catch(_0x51daa2){console[_0x52f4ab(0x234)]('❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x4d218f+0x1)+_0x52f4ab(0x1f3)+_0xb42869+':',_0x51daa2),this['logCoinToPayError'](_0xb42869,_0x256c94,_0x51daa2,'status_check',{'checkNumber':_0x4d218f+0x1,'scheduledAfter':_0xa8458d[_0x52f4ab(0x1f4)],'isIndividualCheck':!![]});}},_0x267adb);_0xfffb84[_0x3cf149(0x264)](_0x7e7421),console[_0x3cf149(0x2b5)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x4d218f+0x1)+_0x3cf149(0x1f3)+_0xb42869+'\x20in\x20'+_0x267adb/0x3e8+_0x3cf149(0x204)+_0xa8458d[_0x3cf149(0x1f4)]+')');});const _0x21d450=setInterval(async()=>{const _0x780770=_0x582f0c;console[_0x780770(0x2b5)](_0x780770(0x22e)+_0xb42869);try{const _0x2b84b6=await database_1['default']['payment'][_0x780770(0x22f)]({'where':{'id':_0xb42869},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x2b84b6){console['log'](_0x780770(0x29c)+_0xb42869+_0x780770(0x207)),this['clearPaymentTimers'](_0xb42869);return;}console[_0x780770(0x2b5)](_0x780770(0x1fd)+_0xb42869+_0x780770(0x28f)+_0x2b84b6[_0x780770(0x215)]);if(_0x2b84b6['status']!=='PENDING'){console[_0x780770(0x2b5)](_0x780770(0x231)+_0xb42869+'\x20status\x20is\x20'+_0x2b84b6[_0x780770(0x215)]+_0x780770(0x28e)),this[_0x780770(0x2c0)](_0xb42869);return;}const _0x1df1ac=Math[_0x780770(0x2c8)]((Date['now']()-_0x2b84b6[_0x780770(0x282)][_0x780770(0x292)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1df1ac>=this[_0x780770(0x2c6)]){console[_0x780770(0x2b5)]('⏰\x20[HOURLY]\x20Payment\x20'+_0xb42869+_0x780770(0x228)+this['EXPIRY_DAYS']+_0x780770(0x27b)),this[_0x780770(0x2c0)](_0xb42869);return;}await this[_0x780770(0x21c)](_0xb42869),console[_0x780770(0x2b5)](_0x780770(0x24a)+_0xb42869);}catch(_0x8bafe){console[_0x780770(0x234)](_0x780770(0x1ea)+_0xb42869+':',_0x8bafe),this[_0x780770(0x249)](_0xb42869,_0x256c94,_0x8bafe,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0xfffb84[_0x582f0c(0x264)](_0x21d450),this[_0x582f0c(0x220)][_0x582f0c(0x25e)](_0xb42869,{'timers':_0xfffb84,'paymentId':_0xb42869,'gatewayPaymentId':_0x256c94,'createdAt':_0x4ae2a4}),console[_0x582f0c(0x2b5)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x3f378b[_0x582f0c(0x240)]+_0x582f0c(0x28c)+_0xb42869),console[_0x582f0c(0x2b5)]('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x582f0c(0x220)][_0x582f0c(0x2a5)]),this[_0x582f0c(0x1ef)](_0xb42869,_0x256c94,_0x582f0c(0x25f),_0x582f0c(0x25f),_0x582f0c(0x26e),{'action':'schedule_created','scheduledChecks':_0x3f378b[_0x582f0c(0x240)],'firstCheckIn':_0x3f378b[0x0][_0x582f0c(0x27f)]/0x3e8,'totalTimers':this[_0x582f0c(0x220)][_0x582f0c(0x2a5)]});}[a35_0xdac582(0x2c0)](_0x6144a3){const _0x37a2a0=a35_0xdac582,_0x6d15ff=this[_0x37a2a0(0x220)][_0x37a2a0(0x1e9)](_0x6144a3);_0x6d15ff?(console[_0x37a2a0(0x2b5)](_0x37a2a0(0x26b)+_0x6d15ff['timers'][_0x37a2a0(0x240)]+_0x37a2a0(0x266)+_0x6144a3),_0x6d15ff[_0x37a2a0(0x1fb)]['forEach']((_0x3e0f1e,_0x4564dd)=>{const _0x4b7271=_0x37a2a0;_0x3e0f1e&&(clearTimeout(_0x3e0f1e),clearInterval(_0x3e0f1e),console[_0x4b7271(0x2b5)](_0x4b7271(0x24c)+(_0x4564dd+0x1)+_0x4b7271(0x1f3)+_0x6144a3));}),this[_0x37a2a0(0x220)][_0x37a2a0(0x2ba)](_0x6144a3),console[_0x37a2a0(0x2b5)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x6144a3+_0x37a2a0(0x235)+this['paymentTimers'][_0x37a2a0(0x2a5)])):console[_0x37a2a0(0x2b5)]('⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x6144a3+_0x37a2a0(0x2a0));}async[a35_0xdac582(0x21c)](_0xdbeec5){const _0xed6741=a35_0xdac582;console[_0xed6741(0x2b5)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0xdbeec5);const _0x4bd2dc=await database_1[_0xed6741(0x1f9)][_0xed6741(0x2a7)][_0xed6741(0x22f)]({'where':{'id':_0xdbeec5},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4bd2dc){console[_0xed6741(0x2b5)]('❌\x20[CHECK]\x20Payment\x20'+_0xdbeec5+_0xed6741(0x246));return;}console['log']('📊\x20[CHECK]\x20Payment\x20'+_0xdbeec5+'\x20found:'),console[_0xed6741(0x2b5)](_0xed6741(0x211)+_0x4bd2dc[_0xed6741(0x2a4)]),console[_0xed6741(0x2b5)](_0xed6741(0x22d)+_0x4bd2dc['status']),console[_0xed6741(0x2b5)](_0xed6741(0x267)+_0x4bd2dc[_0xed6741(0x29d)]),console['log'](_0xed6741(0x1f7)+_0x4bd2dc['amount']+'\x20'+_0x4bd2dc[_0xed6741(0x26f)]),console[_0xed6741(0x2b5)](_0xed6741(0x269)+_0x4bd2dc[_0xed6741(0x248)]);if(_0x4bd2dc[_0xed6741(0x2a4)]!==_0xed6741(0x2a3)){console[_0xed6741(0x2b5)](_0xed6741(0x263)+_0xdbeec5+_0xed6741(0x2c9)+_0x4bd2dc[_0xed6741(0x2a4)]+')');return;}if(_0x4bd2dc[_0xed6741(0x215)]!==_0xed6741(0x25f)){console[_0xed6741(0x2b5)]('⚠️\x20[CHECK]\x20Payment\x20'+_0xdbeec5+_0xed6741(0x265)+_0x4bd2dc[_0xed6741(0x215)]+_0xed6741(0x28e)),this[_0xed6741(0x2c0)](_0xdbeec5);return;}if(!_0x4bd2dc['gatewayPaymentId']){console[_0xed6741(0x2b5)](_0xed6741(0x263)+_0xdbeec5+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0xed6741(0x2b5)](_0xed6741(0x23e)+_0xdbeec5+_0xed6741(0x1fe)),await this[_0xed6741(0x275)](_0x4bd2dc);}[a35_0xdac582(0x1ef)](_0x1e5054,_0x3f7376,_0x576509,_0x2ab86d,_0x4116bc,_0x37de00){const _0x506c8b=a35_0xdac582,_0x38a4a4={'type':_0x506c8b(0x21e),'paymentId':_0x1e5054,'gatewayPaymentId':_0x3f7376,'oldStatus':_0x576509,'newStatus':_0x2ab86d,'source':_0x4116bc,'timestamp':new Date()[_0x506c8b(0x2b8)](),'details':_0x37de00||{}};loggerService_1[_0x506c8b(0x221)][_0x506c8b(0x1ef)](_0x38a4a4),console[_0x506c8b(0x2b5)](_0x506c8b(0x281)+_0x1e5054+'\x20('+_0x3f7376+')'),console[_0x506c8b(0x2b5)](_0x506c8b(0x229)+_0x576509+_0x506c8b(0x20c)+_0x2ab86d),console[_0x506c8b(0x2b5)]('\x20\x20\x20📍\x20Source:\x20'+_0x4116bc),console[_0x506c8b(0x2b5)]('\x20\x20\x20📅\x20Time:\x20'+_0x38a4a4[_0x506c8b(0x21b)]),_0x37de00&&console[_0x506c8b(0x2b5)](_0x506c8b(0x289),_0x37de00);}[a35_0xdac582(0x249)](_0x3cef5e,_0x2483c7,_0xb54ad4,_0x398784,_0x14b607){const _0x46bded=a35_0xdac582,_0x2e4db2={'type':_0x46bded(0x224),'paymentId':_0x3cef5e,'gatewayPaymentId':_0x2483c7,'error':_0xb54ad4 instanceof Error?{'message':_0xb54ad4[_0x46bded(0x26a)],'stack':_0xb54ad4[_0x46bded(0x26c)]}:_0xb54ad4,'source':_0x398784,'timestamp':new Date()[_0x46bded(0x2b8)](),'context':_0x14b607||{}};loggerService_1[_0x46bded(0x221)][_0x46bded(0x249)](_0x2e4db2),console[_0x46bded(0x234)](_0x46bded(0x2c7)+_0x3cef5e+'\x20('+_0x2483c7+')'),console[_0x46bded(0x234)]('\x20\x20\x20❌\x20Error:\x20'+(_0xb54ad4 instanceof Error?_0xb54ad4[_0x46bded(0x26a)]:_0xb54ad4)),console['error']('\x20\x20\x20📍\x20Source:\x20'+_0x398784),console['error'](_0x46bded(0x280)+_0x2e4db2[_0x46bded(0x21b)]),_0x14b607&&console[_0x46bded(0x234)](_0x46bded(0x288),_0x14b607);}['startPeriodicStatusCheck'](){const _0x2d087d=a35_0xdac582;console['log'](_0x2d087d(0x2b9)),this[_0x2d087d(0x277)]()[_0x2d087d(0x25a)](_0x9c97f8=>{const _0x5eac1c=_0x2d087d;console[_0x5eac1c(0x234)](_0x5eac1c(0x29e),_0x9c97f8);}),this[_0x2d087d(0x254)]=setInterval(async()=>{const _0x2b5495=_0x2d087d;try{console['log'](_0x2b5495(0x24d)),await this[_0x2b5495(0x277)](),console[_0x2b5495(0x2b5)](_0x2b5495(0x2bc));}catch(_0x3276fa){console['error'](_0x2b5495(0x25d),_0x3276fa);}},this[_0x2d087d(0x255)]),console[_0x2d087d(0x2b5)](_0x2d087d(0x233));}[a35_0xdac582(0x214)](){const _0x15923c=a35_0xdac582;console[_0x15923c(0x2b5)](_0x15923c(0x252));this['globalCheckInterval']&&(clearInterval(this[_0x15923c(0x254)]),this[_0x15923c(0x254)]=null,console[_0x15923c(0x2b5)]('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x1d182d=this[_0x15923c(0x220)][_0x15923c(0x2a5)];for(const [_0x6c738]of this['paymentTimers']){this[_0x15923c(0x2c0)](_0x6c738);}console[_0x15923c(0x2b5)](_0x15923c(0x29a)+_0x1d182d+_0x15923c(0x297));}async['checkAllPendingPayments'](){const _0x137d47=a35_0xdac582;try{console[_0x137d47(0x2b5)](_0x137d47(0x283));const _0x128079=await database_1[_0x137d47(0x1f9)][_0x137d47(0x2a7)]['findMany']({'where':{'gateway':_0x137d47(0x2a3),'status':_0x137d47(0x25f),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x137d47(0x2b5)](_0x137d47(0x1f2)+_0x128079[_0x137d47(0x240)]+'\x20pending\x20CoinToPay\x20payments');if(_0x128079[_0x137d47(0x240)]===0x0){console[_0x137d47(0x2b5)](_0x137d47(0x1f5));return;}const _0x5996a8=await this[_0x137d47(0x1ed)](_0x128079);console[_0x137d47(0x2b5)](_0x137d47(0x29f)+_0x5996a8[_0x137d47(0x240)]+'\x20expired\x20CoinToPay\x20payments');let _0x44e6e9=0x0,_0x227bfb=0x0;for(const _0x314ab8 of _0x128079){try{if(_0x5996a8[_0x137d47(0x2a9)](_0x314ab8['id'])){console['log'](_0x137d47(0x2c2)+_0x314ab8['id']+_0x137d47(0x261)),_0x227bfb++;continue;}if(this[_0x137d47(0x220)][_0x137d47(0x2b0)](_0x314ab8['id'])){console[_0x137d47(0x2b5)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x314ab8['id']+_0x137d47(0x2b7)),_0x227bfb++;continue;}const _0x58e4e0=(Date[_0x137d47(0x20a)]()-_0x314ab8[_0x137d47(0x282)][_0x137d47(0x292)]())/(0x3e8*0x3c*0x3c);if(_0x58e4e0<0x1){console[_0x137d47(0x2b5)](_0x137d47(0x2c2)+_0x314ab8['id']+'\x20is\x20too\x20new\x20('+_0x58e4e0[_0x137d47(0x247)](0x1)+_0x137d47(0x217)),_0x227bfb++;continue;}console[_0x137d47(0x2b5)](_0x137d47(0x230)+_0x314ab8['id']+_0x137d47(0x238)+_0x58e4e0[_0x137d47(0x247)](0x1)+'h)'),await this[_0x137d47(0x275)](_0x314ab8),_0x44e6e9++,await new Promise(_0x2f815e=>setTimeout(_0x2f815e,0x7d0));}catch(_0x1548e8){console['error'](_0x137d47(0x271)+_0x314ab8['id']+':',_0x1548e8),this[_0x137d47(0x249)](_0x314ab8['id'],_0x314ab8[_0x137d47(0x29d)]||'unknown',_0x1548e8,_0x137d47(0x26e),{'isGlobalCheck':!![],'paymentAmount':_0x314ab8[_0x137d47(0x2a2)],'paymentCurrency':_0x314ab8['currency'],'shopId':_0x314ab8['shopId'],'createdAt':_0x314ab8[_0x137d47(0x282)]}),loggerService_1[_0x137d47(0x221)][_0x137d47(0x251)](_0x137d47(0x2a3),'/status/'+_0x314ab8[_0x137d47(0x29d)],_0x1548e8);}}console[_0x137d47(0x2b5)]('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x44e6e9+'\x20checked,\x20'+_0x227bfb+_0x137d47(0x294)+_0x5996a8[_0x137d47(0x240)]+'\x20expired');}catch(_0x4c5b41){console['error']('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x4c5b41);}}async[a35_0xdac582(0x1ed)](_0x6d1a77){const _0x48175b=a35_0xdac582,_0x241bae=[],_0x44433e=new Date();_0x44433e[_0x48175b(0x236)](_0x44433e[_0x48175b(0x27d)]()-this[_0x48175b(0x2c6)]),console[_0x48175b(0x2b5)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x48175b(0x2c6)]+'\x20days\x20(created\x20before\x20'+_0x44433e[_0x48175b(0x2b8)]()+')');for(const _0xc25a7c of _0x6d1a77){if(_0xc25a7c['createdAt']<_0x44433e){console[_0x48175b(0x2b5)](_0x48175b(0x242)+_0xc25a7c['id']+_0x48175b(0x228)+this[_0x48175b(0x2c6)]+_0x48175b(0x1ff));try{this[_0x48175b(0x1ef)](_0xc25a7c['id'],_0xc25a7c[_0x48175b(0x29d)]||_0x48175b(0x259),_0x48175b(0x25f),_0x48175b(0x24f),_0x48175b(0x2af),{'reason':_0x48175b(0x27e)+this[_0x48175b(0x2c6)]+_0x48175b(0x1ec),'createdAt':_0xc25a7c[_0x48175b(0x282)],'daysSinceCreation':Math[_0x48175b(0x2c8)]((Date[_0x48175b(0x20a)]()-_0xc25a7c['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0xc25a7c[_0x48175b(0x2a2)],'paymentCurrency':_0xc25a7c[_0x48175b(0x26f)],'shopId':_0xc25a7c['shopId']}),await database_1['default']['payment']['update']({'where':{'id':_0xc25a7c['id']},'data':{'status':_0x48175b(0x24f),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x48175b(0x2c6)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x48175b(0x1f9)][_0x48175b(0x2a6)][_0x48175b(0x25b)]({'data':{'paymentId':_0xc25a7c['id'],'shopId':_0xc25a7c[_0x48175b(0x248)],'event':_0x48175b(0x276),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x48175b(0x27e)+this['EXPIRY_DAYS']+_0x48175b(0x1ec),'createdAt':_0xc25a7c[_0x48175b(0x282)],'expiredAt':new Date()[_0x48175b(0x2b8)](),'daysSinceCreation':Math[_0x48175b(0x2c8)]((Date[_0x48175b(0x20a)]()-_0xc25a7c[_0x48175b(0x282)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x48175b(0x2bf)](_0xc25a7c,_0x48175b(0x24f)),await this[_0x48175b(0x1eb)](_0xc25a7c,_0x48175b(0x24f)),this[_0x48175b(0x2c0)](_0xc25a7c['id']),_0x241bae[_0x48175b(0x264)](_0xc25a7c['id']),console[_0x48175b(0x2b5)](_0x48175b(0x293)+_0xc25a7c['id']+_0x48175b(0x270)+this[_0x48175b(0x2c6)]+_0x48175b(0x1f1));}catch(_0x4e454a){console[_0x48175b(0x234)](_0x48175b(0x225)+_0xc25a7c['id']+':',_0x4e454a),this[_0x48175b(0x249)](_0xc25a7c['id'],_0xc25a7c[_0x48175b(0x29d)]||_0x48175b(0x259),_0x4e454a,_0x48175b(0x2af),{'reason':_0x48175b(0x2a1),'createdAt':_0xc25a7c['createdAt'],'daysSinceCreation':Math['floor']((Date['now']()-_0xc25a7c['createdAt'][_0x48175b(0x292)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x241bae;}async['checkSinglePayment'](_0x569779){const _0x30f4a4=a35_0xdac582;if(!_0x569779[_0x30f4a4(0x29d)]){console[_0x30f4a4(0x2b5)](_0x30f4a4(0x263)+_0x569779['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x30f4a4(0x2b5)](_0x30f4a4(0x24e)+_0x569779['id']+'\x20('+_0x569779[_0x30f4a4(0x29d)]+')');try{const _0x7cc37f=await this[_0x30f4a4(0x260)][_0x30f4a4(0x21a)](_0x569779[_0x30f4a4(0x29d)]);console[_0x30f4a4(0x2b5)](_0x30f4a4(0x20e)+_0x569779['id']+'\x20status:\x20'+_0x7cc37f[_0x30f4a4(0x215)]);_0x7cc37f['paymentDetails']&&console[_0x30f4a4(0x2b5)](_0x30f4a4(0x20e)+_0x569779['id']+_0x30f4a4(0x243),{'iban':_0x7cc37f['paymentDetails'][_0x30f4a4(0x22b)]||_0x30f4a4(0x2cc),'transactionId':_0x7cc37f[_0x30f4a4(0x278)][_0x30f4a4(0x2b2)],'createdOn':_0x7cc37f[_0x30f4a4(0x278)][_0x30f4a4(0x290)],'confirmedOn':_0x7cc37f[_0x30f4a4(0x278)][_0x30f4a4(0x2be)]||_0x30f4a4(0x23f)});if(_0x7cc37f[_0x30f4a4(0x215)]!==_0x569779[_0x30f4a4(0x215)]){console['log'](_0x30f4a4(0x22c)+_0x569779['id']+_0x30f4a4(0x209)+_0x569779[_0x30f4a4(0x215)]+_0x30f4a4(0x2b6)+_0x7cc37f[_0x30f4a4(0x215)]),this[_0x30f4a4(0x1ef)](_0x569779['id'],_0x569779[_0x30f4a4(0x29d)],_0x569779[_0x30f4a4(0x215)],_0x7cc37f[_0x30f4a4(0x215)],_0x30f4a4(0x26e),{'paymentDetails':_0x7cc37f[_0x30f4a4(0x278)],'amount':_0x7cc37f['amount'],'currency':_0x7cc37f['currency'],'shopId':_0x569779[_0x30f4a4(0x248)],'checkTimestamp':new Date()[_0x30f4a4(0x2b8)]()});const _0x3b3c56={'status':_0x7cc37f[_0x30f4a4(0x215)],'updatedAt':new Date()};_0x7cc37f[_0x30f4a4(0x215)]===_0x30f4a4(0x296)&&_0x569779[_0x30f4a4(0x215)]!==_0x30f4a4(0x296)&&(_0x3b3c56['paidAt']=new Date(),console['log']('💰\x20[CHECK]\x20Payment\x20'+_0x569779['id']+_0x30f4a4(0x24b)+_0x3b3c56[_0x30f4a4(0x2c5)][_0x30f4a4(0x2b8)]()));if(_0x7cc37f[_0x30f4a4(0x278)]){const _0x444374=_0x7cc37f[_0x30f4a4(0x278)];_0x444374['iban']&&(_0x3b3c56[_0x30f4a4(0x20b)]=_0x444374[_0x30f4a4(0x22b)],console[_0x30f4a4(0x2b5)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x444374['iban']));if(_0x444374[_0x30f4a4(0x28d)]){const _0x555537=_0x569779[_0x30f4a4(0x2b1)]||'',_0x5dad9f=_0x30f4a4(0x2b4)+_0x444374['bankDetails'];_0x3b3c56[_0x30f4a4(0x2b1)]=_0x555537?_0x555537+'\x0a\x0a'+_0x5dad9f:_0x5dad9f,console[_0x30f4a4(0x2b5)](_0x30f4a4(0x28b));}_0x444374[_0x30f4a4(0x2b2)]&&console['log'](_0x30f4a4(0x20d)+_0x444374['transactionId']),_0x444374[_0x30f4a4(0x2be)]&&console['log']('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x444374[_0x30f4a4(0x2be)]);}await database_1[_0x30f4a4(0x1f9)][_0x30f4a4(0x2a7)][_0x30f4a4(0x2cd)]({'where':{'id':_0x569779['id']},'data':_0x3b3c56}),await database_1[_0x30f4a4(0x1f9)][_0x30f4a4(0x2a6)]['create']({'data':{'paymentId':_0x569779['id'],'shopId':_0x569779[_0x30f4a4(0x248)],'event':_0x30f4a4(0x205)+_0x7cc37f[_0x30f4a4(0x215)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x569779[_0x30f4a4(0x215)],'newStatus':_0x7cc37f[_0x30f4a4(0x215)],'paymentDetails':_0x7cc37f[_0x30f4a4(0x278)],'checkedAt':new Date()[_0x30f4a4(0x2b8)]()})}}),await this[_0x30f4a4(0x2bf)](_0x569779,_0x7cc37f[_0x30f4a4(0x215)]),await this[_0x30f4a4(0x1eb)](_0x569779,_0x7cc37f[_0x30f4a4(0x215)]),_0x7cc37f[_0x30f4a4(0x215)]!==_0x30f4a4(0x25f)&&(console[_0x30f4a4(0x2b5)](_0x30f4a4(0x2c4)+_0x569779['id']+_0x30f4a4(0x287)+_0x7cc37f[_0x30f4a4(0x215)]+',\x20clearing\x20individual\x20timers'),this['clearPaymentTimers'](_0x569779['id'])),console[_0x30f4a4(0x2b5)](_0x30f4a4(0x23e)+_0x569779['id']+_0x30f4a4(0x206));}else console['log'](_0x30f4a4(0x20e)+_0x569779['id']+_0x30f4a4(0x256)+_0x7cc37f['status']+')'),this['logCoinToPayStatus'](_0x569779['id'],_0x569779['gatewayPaymentId'],_0x569779['status'],_0x7cc37f[_0x30f4a4(0x215)],_0x30f4a4(0x26e),{'statusUnchanged':!![],'paymentDetails':_0x7cc37f['paymentDetails'],'amount':_0x7cc37f['amount'],'currency':_0x7cc37f[_0x30f4a4(0x26f)],'shopId':_0x569779['shopId'],'checkTimestamp':new Date()[_0x30f4a4(0x2b8)]()});}catch(_0x2e42c0){console[_0x30f4a4(0x234)](_0x30f4a4(0x25c)+_0x569779['id']+':',_0x2e42c0),this['logCoinToPayError'](_0x569779['id'],_0x569779[_0x30f4a4(0x29d)],_0x2e42c0,_0x30f4a4(0x26e),{'paymentAmount':_0x569779[_0x30f4a4(0x2a2)],'paymentCurrency':_0x569779[_0x30f4a4(0x26f)],'shopId':_0x569779['shopId'],'createdAt':_0x569779[_0x30f4a4(0x282)]}),await database_1[_0x30f4a4(0x1f9)]['webhookLog']['create']({'data':{'paymentId':_0x569779['id'],'shopId':_0x569779[_0x30f4a4(0x248)],'event':_0x30f4a4(0x223),'statusCode':0x1f4,'responseBody':JSON[_0x30f4a4(0x279)]({'error':_0x2e42c0 instanceof Error?_0x2e42c0['message']:_0x30f4a4(0x28a),'gatewayPaymentId':_0x569779['gatewayPaymentId'],'checkedAt':new Date()['toISOString']()})}});}}async[a35_0xdac582(0x2bf)](_0x38fa0f,_0x4ed453){const _0x3ee056=a35_0xdac582,_0x46596e=Date[_0x3ee056(0x20a)]();try{const _0x34185b=_0x38fa0f[_0x3ee056(0x203)],_0x5353cc=_0x34185b[_0x3ee056(0x274)];if(!_0x5353cc?.[_0x3ee056(0x212)]){console[_0x3ee056(0x2b5)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x34185b['id']);return;}const _0x5a0b5e=_0x4ed453===_0x3ee056(0x296)?'payment.success':_0x4ed453===_0x3ee056(0x1fa)?_0x3ee056(0x1ee):_0x4ed453==='EXPIRED'?'payment.failed':'payment.pending';if(!_0x5353cc[_0x3ee056(0x26d)]?.[_0x3ee056(0x2a9)](_0x5a0b5e)){console[_0x3ee056(0x2b5)](_0x3ee056(0x218)+_0x5a0b5e+_0x3ee056(0x273)+_0x34185b['id']);return;}const _0x3c2fe0={'event':_0x5a0b5e,'payment':{'id':_0x38fa0f['id'],'order_id':_0x38fa0f[_0x3ee056(0x2ca)],'gateway_order_id':_0x38fa0f[_0x3ee056(0x291)],'gateway':_0x3ee056(0x299),'amount':_0x38fa0f[_0x3ee056(0x2a2)],'currency':_0x38fa0f['currency'],'status':_0x4ed453[_0x3ee056(0x295)](),'customer_email':_0x38fa0f[_0x3ee056(0x1f8)],'customer_name':_0x38fa0f[_0x3ee056(0x244)],'created_at':_0x38fa0f[_0x3ee056(0x282)],'updated_at':new Date()}},_0x2971a9=await fetch(_0x5353cc[_0x3ee056(0x212)],{'method':'POST','headers':{'Content-Type':_0x3ee056(0x237),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x3ee056(0x279)](_0x3c2fe0)}),_0x1bcd54=Date['now']()-_0x46596e,_0x3c5905=_0x2971a9['ok']?_0x3ee056(0x202):await _0x2971a9[_0x3ee056(0x21d)]();loggerService_1[_0x3ee056(0x221)][_0x3ee056(0x222)](_0x38fa0f[_0x3ee056(0x248)],_0x5353cc['webhookUrl'],_0x5a0b5e,_0x2971a9['status'],_0x1bcd54,_0x3c2fe0),console['log'](_0x3ee056(0x23c)+_0x5353cc[_0x3ee056(0x212)]+_0x3ee056(0x2aa)+_0x2971a9[_0x3ee056(0x215)]+'\x20('+_0x1bcd54+_0x3ee056(0x27c));}catch(_0x2df014){console[_0x3ee056(0x234)](_0x3ee056(0x268),_0x2df014),loggerService_1['loggerService'][_0x3ee056(0x298)](_0x38fa0f[_0x3ee056(0x248)],_0x38fa0f['shop']?.[_0x3ee056(0x274)]?.[_0x3ee056(0x212)]||_0x3ee056(0x259),_0x3ee056(0x245),_0x2df014,{});}}async[a35_0xdac582(0x1eb)](_0x9b5a1d,_0x554c4b){const _0x3f05a0=a35_0xdac582;try{const _0x58942e={'PENDING':_0x3f05a0(0x2ac),'PAID':_0x3f05a0(0x227),'FAILED':_0x3f05a0(0x213),'EXPIRED':'expired'},_0x38f420=_0x58942e[_0x554c4b];if(!_0x38f420||_0x38f420===_0x3f05a0(0x2ac))return;await telegramBotService_1[_0x3f05a0(0x2bd)]['sendPaymentNotification'](_0x9b5a1d[_0x3f05a0(0x248)],_0x9b5a1d,_0x38f420);}catch(_0x686306){console[_0x3f05a0(0x234)](_0x3f05a0(0x21f),_0x686306);}}async[a35_0xdac582(0x2c1)](_0x230b46){const _0x3985a8=a35_0xdac582;console['log'](_0x3985a8(0x232)+_0x230b46);const _0x51ac65=await database_1[_0x3985a8(0x1f9)][_0x3985a8(0x2a7)]['findUnique']({'where':{'id':_0x230b46},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x51ac65)throw new Error(_0x3985a8(0x216));if(_0x51ac65[_0x3985a8(0x2a4)]!=='cointopay')throw new Error(_0x3985a8(0x2b3));console[_0x3985a8(0x2b5)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x230b46),await this['checkSinglePayment'](_0x51ac65),console[_0x3985a8(0x2b5)](_0x3985a8(0x2ad)+_0x230b46);}[a35_0xdac582(0x284)](){const _0x2a645f=a35_0xdac582,_0x56f58f=this['globalCheckInterval']?this[_0x2a645f(0x255)]:undefined,_0x297cb9=Array['from'](this[_0x2a645f(0x220)][_0x2a645f(0x27a)]())[_0x2a645f(0x257)](_0x3c9a80=>({'paymentId':_0x3c9a80[_0x2a645f(0x285)],'gatewayPaymentId':_0x3c9a80[_0x2a645f(0x29d)],'createdAt':_0x3c9a80[_0x2a645f(0x282)],'timersCount':_0x3c9a80['timers'][_0x2a645f(0x240)]}));return{'isActive':!!this[_0x2a645f(0x254)],'globalCheckIntervalMinutes':this[_0x2a645f(0x255)]/(0x3e8*0x3c),'expiryDays':this[_0x2a645f(0x2c6)],'activeIndividualTimers':this[_0x2a645f(0x220)]['size'],'nextGlobalCheckIn':_0x56f58f,'paymentTimersDetails':_0x297cb9};}['getPaymentTimerInfo'](_0x153e62){const _0x2b4ef8=a35_0xdac582,_0x3ae615=this[_0x2b4ef8(0x220)][_0x2b4ef8(0x1e9)](_0x153e62);if(_0x3ae615)return{'hasTimers':!![],'timersCount':_0x3ae615[_0x2b4ef8(0x1fb)][_0x2b4ef8(0x240)],'createdAt':_0x3ae615[_0x2b4ef8(0x282)],'gatewayPaymentId':_0x3ae615[_0x2b4ef8(0x29d)]};return{'hasTimers':![]};}}exports[a35_0xdac582(0x226)]=CoinToPayStatusService,exports[a35_0xdac582(0x250)]=new CoinToPayStatusService();