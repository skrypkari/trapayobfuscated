'use strict';function a35_0x45cd(){const _0x48f707=['shopId','Failed\x20to\x20expire\x20payment\x20','transactionId','loggerService','/status/','1566888SeGrYv','findMany','POST','\x20expired\x20CoinToPay\x20payments','checkInterval','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','default','length','ü™ô\x20Checking\x20','üí∞\x20Payment\x20','gatewayPaymentId','CoinToPayStatusService','2461746ISPLGd','remitterIban','confirmedOn','sendPaymentNotification','cointopay_status_check_','expired','adminNotes','catch','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','settings','./telegramBotService','error','coinToPayService','__esModule','\x20status\x20unchanged\x20(','üîç\x20Checking\x20CoinToPay\x20payment\x20','EXPIRED','\x20CoinToPay\x20payments','24jZuqhv','logShopWebhookError','application/json','shop','\x20days','status','coinToPayStatusService','Payment\x20older\x20than\x20','üè¶\x20Saved\x20IBAN:\x20','payment.pending','üìä\x20Payment\x20','webhookLog','Periodic\x20CoinToPay\x20status\x20check\x20failed:','61330UuSAvH','checkExpiredPayments','getDate','‚úÖ\x20Payment\x20','‚úÖ\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','checkPaymentStatus','186291nczEmr','\x20pending\x20CoinToPay\x20payments','CHECK_INTERVAL_MS','update','payment','PENDING','bankDetails','log','./loggerService','ü™ô\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','‚úÖ\x20Completed\x20checking\x20','webhook_send','\x20details:','‚è∞\x20Found\x20','toLowerCase','not\x20found','iban','getTime','716YZjgyX','\x20updated\x20successfully','279mYbJWa','üè¶\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','gateway','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','CoinToPayService','webhookUrl','Initial\x20CoinToPay\x20status\x20check\x20failed:','createdAt','webhookEvents','paymentDetails','create','includes','__importDefault','toISOString','297671DhqnDV','\x20days\x20without\x20payment\x20confirmation','gatewayOrderId','Failed\x20to\x20send\x20shop\x20webhook:','created','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','cointopay_auto_expired','\x20marked\x20as\x20paid\x20at:\x20','now','‚è∞\x20Payment\x20','getServiceStats','Payment\x20not\x20found','floor','2436unONgR','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','‚ö†Ô∏è\x20Payment\x20','Success','createdOn','setDate','Failed\x20to\x20check\x20payment\x20','stopPeriodicStatusCheck','\x20status\x20from\x20','push','ü™ô\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','paidAt','FAILED','../config/database','currency','checkPaymentById','cointopay_status_check_error','cointopay','Bank\x20Details:\x20','EXPIRY_DAYS','ms)','\x20with\x20status\x20','5aOhYho','./gateways/coinToPayService','unknown','sendShopWebhook','\x20to\x20','176536VZqOGZ','telegramBotService','paid','defineProperty','payment.failed','checkSinglePayment','not\x20confirmed','findUnique','PAID','checkAllPendingPayments','sendPaymentStatusNotification','logShopWebhookSent','payment.success','stringify'];a35_0x45cd=function(){return _0x48f707;};return a35_0x45cd();}function a35_0x2b49(_0x1a2231,_0x5772e5){const _0x45cd3c=a35_0x45cd();return a35_0x2b49=function(_0x2b49b4,_0x591afc){_0x2b49b4=_0x2b49b4-0x153;let _0x3e2024=_0x45cd3c[_0x2b49b4];return _0x3e2024;},a35_0x2b49(_0x1a2231,_0x5772e5);}const a35_0x356111=a35_0x2b49;(function(_0x445868,_0x55b9a2){const _0x2f997a=a35_0x2b49,_0x21ab1c=_0x445868();while(!![]){try{const _0x5d8830=parseInt(_0x2f997a(0x198))/0x1+parseInt(_0x2f997a(0x160))/0x2*(parseInt(_0x2f997a(0x17d))/0x3)+parseInt(_0x2f997a(0x1ab))/0x4+parseInt(_0x2f997a(0x193))/0x5*(-parseInt(_0x2f997a(0x1b7))/0x6)+-parseInt(_0x2f997a(0x1dc))/0x7*(-parseInt(_0x2f997a(0x1c9))/0x8)+parseInt(_0x2f997a(0x162))/0x9*(-parseInt(_0x2f997a(0x1d6))/0xa)+-parseInt(_0x2f997a(0x170))/0xb;if(_0x5d8830===_0x55b9a2)break;else _0x21ab1c['push'](_0x21ab1c['shift']());}catch(_0x571803){_0x21ab1c['push'](_0x21ab1c['shift']());}}}(a35_0x45cd,0x4c016));var __importDefault=this&&this[a35_0x356111(0x16e)]||function(_0x41aced){const _0x108e96=a35_0x356111;return _0x41aced&&_0x41aced[_0x108e96(0x1c4)]?_0x41aced:{'default':_0x41aced};};Object[a35_0x356111(0x19b)](exports,a35_0x356111(0x1c4),{'value':!![]}),exports[a35_0x356111(0x1cf)]=exports[a35_0x356111(0x1b6)]=void 0x0;const coinToPayService_1=require(a35_0x356111(0x194)),database_1=__importDefault(require(a35_0x356111(0x18a))),telegramBotService_1=require(a35_0x356111(0x1c1)),loggerService_1=require(a35_0x356111(0x156));class CoinToPayStatusService{constructor(){const _0x437cbd=a35_0x356111;this[_0x437cbd(0x1af)]=null,this[_0x437cbd(0x1de)]=0x3c*0x3c*0x3e8,this[_0x437cbd(0x190)]=0x5,this[_0x437cbd(0x1c3)]=new coinToPayService_1[(_0x437cbd(0x166))]();}['startPeriodicStatusCheck'](){const _0x39a5f6=a35_0x356111;console['log'](_0x39a5f6(0x157)),this['checkAllPendingPayments']()[_0x39a5f6(0x1be)](_0x10df2f=>{const _0x1c665e=_0x39a5f6;console[_0x1c665e(0x1c2)](_0x1c665e(0x168),_0x10df2f);}),this[_0x39a5f6(0x1af)]=setInterval(async()=>{const _0x3cffc2=_0x39a5f6;try{await this[_0x3cffc2(0x1a1)]();}catch(_0x440f49){console['error'](_0x3cffc2(0x1d5),_0x440f49);}},this[_0x39a5f6(0x1de)]),console['log'](_0x39a5f6(0x1da));}[a35_0x356111(0x184)](){const _0x2a5b59=a35_0x356111;this[_0x2a5b59(0x1af)]&&(clearInterval(this[_0x2a5b59(0x1af)]),this['checkInterval']=null,console['log']('üõë\x20CoinToPay\x20status\x20checking\x20stopped'));}async[a35_0x356111(0x1a1)](){const _0x13fa59=a35_0x356111;try{const _0x363741=await database_1[_0x13fa59(0x1b1)][_0x13fa59(0x1e0)][_0x13fa59(0x1ac)]({'where':{'gateway':_0x13fa59(0x18e),'status':_0x13fa59(0x153),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x363741[_0x13fa59(0x1b2)]===0x0){console[_0x13fa59(0x155)](_0x13fa59(0x187));return;}console['log'](_0x13fa59(0x1b3)+_0x363741[_0x13fa59(0x1b2)]+_0x13fa59(0x1dd));const _0x2b603a=await this[_0x13fa59(0x1d7)](_0x363741);console[_0x13fa59(0x155)](_0x13fa59(0x15b)+_0x2b603a[_0x13fa59(0x1b2)]+_0x13fa59(0x1ae));for(const _0x1793d4 of _0x363741){try{if(_0x2b603a[_0x13fa59(0x16d)](_0x1793d4['id'])){console['log'](_0x13fa59(0x179)+_0x1793d4['id']+_0x13fa59(0x1bf));continue;}await this[_0x13fa59(0x19d)](_0x1793d4),await new Promise(_0x17fd1f=>setTimeout(_0x17fd1f,0x7d0));}catch(_0x700a19){console[_0x13fa59(0x1c2)](_0x13fa59(0x1b0)+_0x1793d4['id']+':',_0x700a19),loggerService_1[_0x13fa59(0x1a9)]['logWhiteDomainError'](_0x13fa59(0x18e),_0x13fa59(0x1aa)+_0x1793d4[_0x13fa59(0x1b5)],_0x700a19);}}console[_0x13fa59(0x155)](_0x13fa59(0x158)+_0x363741[_0x13fa59(0x1b2)]+_0x13fa59(0x1c8));}catch(_0x54f0f6){console['error'](_0x13fa59(0x175),_0x54f0f6);}}async[a35_0x356111(0x1d7)](_0x4a5cb8){const _0x5e2b6b=a35_0x356111,_0x1edee6=[],_0x5a7acc=new Date();_0x5a7acc[_0x5e2b6b(0x182)](_0x5a7acc[_0x5e2b6b(0x1d8)]()-this[_0x5e2b6b(0x190)]),console[_0x5e2b6b(0x155)]('‚è∞\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x5e2b6b(0x190)]+'\x20days\x20(created\x20before\x20'+_0x5a7acc['toISOString']()+')');for(const _0x2650f1 of _0x4a5cb8){if(_0x2650f1[_0x5e2b6b(0x169)]<_0x5a7acc){console[_0x5e2b6b(0x155)](_0x5e2b6b(0x179)+_0x2650f1['id']+'\x20is\x20older\x20than\x20'+this[_0x5e2b6b(0x190)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{await database_1[_0x5e2b6b(0x1b1)][_0x5e2b6b(0x1e0)][_0x5e2b6b(0x1df)]({'where':{'id':_0x2650f1['id']},'data':{'status':_0x5e2b6b(0x1c7),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x5e2b6b(0x190)]+_0x5e2b6b(0x171)}}),await database_1[_0x5e2b6b(0x1b1)][_0x5e2b6b(0x1d4)]['create']({'data':{'paymentId':_0x2650f1['id'],'shopId':_0x2650f1[_0x5e2b6b(0x1a6)],'event':_0x5e2b6b(0x176),'statusCode':0xc8,'responseBody':JSON[_0x5e2b6b(0x1a5)]({'reason':_0x5e2b6b(0x1d0)+this[_0x5e2b6b(0x190)]+_0x5e2b6b(0x1cd),'createdAt':_0x2650f1['createdAt'],'expiredAt':new Date()[_0x5e2b6b(0x16f)](),'daysSinceCreation':Math[_0x5e2b6b(0x17c)]((Date[_0x5e2b6b(0x178)]()-_0x2650f1[_0x5e2b6b(0x169)][_0x5e2b6b(0x15f)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x5e2b6b(0x196)](_0x2650f1,_0x5e2b6b(0x1c7)),await this[_0x5e2b6b(0x1a2)](_0x2650f1,'EXPIRED'),_0x1edee6[_0x5e2b6b(0x186)](_0x2650f1['id']),console['log'](_0x5e2b6b(0x1d9)+_0x2650f1['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x5e2b6b(0x190)]+'-day\x20timeout');}catch(_0x311c73){console[_0x5e2b6b(0x1c2)](_0x5e2b6b(0x1a7)+_0x2650f1['id']+':',_0x311c73);}}}return _0x1edee6;}async[a35_0x356111(0x19d)](_0x43cbb4){const _0x120682=a35_0x356111;if(!_0x43cbb4['gatewayPaymentId']){console[_0x120682(0x155)](_0x120682(0x17f)+_0x43cbb4['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x120682(0x155)](_0x120682(0x1c6)+_0x43cbb4['id']+'\x20('+_0x43cbb4[_0x120682(0x1b5)]+')');try{const _0x4ce8c1=await this['coinToPayService'][_0x120682(0x1db)](_0x43cbb4[_0x120682(0x1b5)]);console['log'](_0x120682(0x1d3)+_0x43cbb4['id']+'\x20status:\x20'+_0x4ce8c1[_0x120682(0x1ce)]);_0x4ce8c1[_0x120682(0x16b)]&&console[_0x120682(0x155)](_0x120682(0x1d3)+_0x43cbb4['id']+_0x120682(0x15a),{'iban':_0x4ce8c1[_0x120682(0x16b)]['iban']||_0x120682(0x15d),'transactionId':_0x4ce8c1['paymentDetails'][_0x120682(0x1a8)],'createdOn':_0x4ce8c1[_0x120682(0x16b)][_0x120682(0x181)],'confirmedOn':_0x4ce8c1[_0x120682(0x16b)][_0x120682(0x1b9)]||_0x120682(0x19e)});if(_0x4ce8c1['status']!==_0x43cbb4[_0x120682(0x1ce)]){console['log']('üîÑ\x20Updating\x20payment\x20'+_0x43cbb4['id']+_0x120682(0x185)+_0x43cbb4['status']+_0x120682(0x197)+_0x4ce8c1[_0x120682(0x1ce)]);const _0x3753a1={'status':_0x4ce8c1[_0x120682(0x1ce)],'updatedAt':new Date()};_0x4ce8c1[_0x120682(0x1ce)]===_0x120682(0x1a0)&&_0x43cbb4[_0x120682(0x1ce)]!=='PAID'&&(_0x3753a1[_0x120682(0x188)]=new Date(),console['log'](_0x120682(0x1b4)+_0x43cbb4['id']+_0x120682(0x177)+_0x3753a1['paidAt']['toISOString']()));if(_0x4ce8c1[_0x120682(0x16b)]){const _0x3f687=_0x4ce8c1[_0x120682(0x16b)];_0x3f687[_0x120682(0x15e)]&&(_0x3753a1[_0x120682(0x1b8)]=_0x3f687[_0x120682(0x15e)],console['log'](_0x120682(0x1d1)+_0x3f687['iban']));if(_0x3f687['bankDetails']){const _0x20d423=_0x43cbb4[_0x120682(0x1bd)]||'',_0x39940a=_0x120682(0x18f)+_0x3f687[_0x120682(0x154)];_0x3753a1['adminNotes']=_0x20d423?_0x20d423+'\x0a\x0a'+_0x39940a:_0x39940a,console[_0x120682(0x155)](_0x120682(0x163));}_0x3f687[_0x120682(0x1a8)]&&console['log']('üÜî\x20Transaction\x20ID:\x20'+_0x3f687['transactionId']),_0x3f687['confirmedOn']&&console[_0x120682(0x155)]('‚úÖ\x20Transaction\x20confirmed\x20on:\x20'+_0x3f687[_0x120682(0x1b9)]);}await database_1['default'][_0x120682(0x1e0)]['update']({'where':{'id':_0x43cbb4['id']},'data':_0x3753a1}),await database_1[_0x120682(0x1b1)][_0x120682(0x1d4)][_0x120682(0x16c)]({'data':{'paymentId':_0x43cbb4['id'],'shopId':_0x43cbb4[_0x120682(0x1a6)],'event':_0x120682(0x1bb)+_0x4ce8c1[_0x120682(0x1ce)][_0x120682(0x15c)](),'statusCode':0xc8,'responseBody':JSON[_0x120682(0x1a5)]({'oldStatus':_0x43cbb4[_0x120682(0x1ce)],'newStatus':_0x4ce8c1[_0x120682(0x1ce)],'paymentDetails':_0x4ce8c1[_0x120682(0x16b)],'checkedAt':new Date()[_0x120682(0x16f)]()})}}),await this[_0x120682(0x196)](_0x43cbb4,_0x4ce8c1[_0x120682(0x1ce)]),await this[_0x120682(0x1a2)](_0x43cbb4,_0x4ce8c1[_0x120682(0x1ce)]),console[_0x120682(0x155)](_0x120682(0x1d9)+_0x43cbb4['id']+_0x120682(0x161));}else console[_0x120682(0x155)](_0x120682(0x1d3)+_0x43cbb4['id']+_0x120682(0x1c5)+_0x4ce8c1[_0x120682(0x1ce)]+')');}catch(_0x19192e){console[_0x120682(0x1c2)](_0x120682(0x183)+_0x43cbb4['id']+':',_0x19192e),await database_1[_0x120682(0x1b1)][_0x120682(0x1d4)][_0x120682(0x16c)]({'data':{'paymentId':_0x43cbb4['id'],'shopId':_0x43cbb4[_0x120682(0x1a6)],'event':_0x120682(0x18d),'statusCode':0x1f4,'responseBody':JSON[_0x120682(0x1a5)]({'error':_0x19192e instanceof Error?_0x19192e['message']:'Unknown\x20error','gatewayPaymentId':_0x43cbb4[_0x120682(0x1b5)],'checkedAt':new Date()['toISOString']()})}});}}async['sendShopWebhook'](_0x3aff8f,_0x29da14){const _0x480cd3=a35_0x356111,_0x315bac=Date[_0x480cd3(0x178)]();try{const _0x211516=_0x3aff8f['shop'],_0x398d2b=_0x211516[_0x480cd3(0x1c0)];if(!_0x398d2b?.[_0x480cd3(0x167)]){console[_0x480cd3(0x155)](_0x480cd3(0x17e)+_0x211516['id']);return;}const _0x583c82=_0x29da14===_0x480cd3(0x1a0)?_0x480cd3(0x1a4):_0x29da14===_0x480cd3(0x189)?'payment.failed':_0x29da14==='EXPIRED'?_0x480cd3(0x19c):_0x480cd3(0x1d2);if(!_0x398d2b[_0x480cd3(0x16a)]?.[_0x480cd3(0x16d)](_0x583c82)){console[_0x480cd3(0x155)]('Webhook\x20event\x20'+_0x583c82+'\x20not\x20enabled\x20for\x20shop\x20'+_0x211516['id']);return;}const _0x2b4411={'event':_0x583c82,'payment':{'id':_0x3aff8f['id'],'order_id':_0x3aff8f['orderId'],'gateway_order_id':_0x3aff8f[_0x480cd3(0x172)],'gateway':'0100','amount':_0x3aff8f['amount'],'currency':_0x3aff8f[_0x480cd3(0x18b)],'status':_0x29da14[_0x480cd3(0x15c)](),'customer_email':_0x3aff8f['customerEmail'],'customer_name':_0x3aff8f['customerName'],'created_at':_0x3aff8f['createdAt'],'updated_at':new Date()}},_0x13ee27=await fetch(_0x398d2b[_0x480cd3(0x167)],{'method':_0x480cd3(0x1ad),'headers':{'Content-Type':_0x480cd3(0x1cb),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x2b4411)}),_0x53c893=Date[_0x480cd3(0x178)]()-_0x315bac,_0x4fc14d=_0x13ee27['ok']?_0x480cd3(0x180):await _0x13ee27['text']();loggerService_1[_0x480cd3(0x1a9)][_0x480cd3(0x1a3)](_0x3aff8f[_0x480cd3(0x1a6)],_0x398d2b['webhookUrl'],_0x583c82,_0x13ee27['status'],_0x53c893,_0x2b4411),console['log']('Shop\x20webhook\x20sent\x20to\x20'+_0x398d2b[_0x480cd3(0x167)]+_0x480cd3(0x192)+_0x13ee27[_0x480cd3(0x1ce)]+'\x20('+_0x53c893+_0x480cd3(0x191));}catch(_0x3a4a3c){console[_0x480cd3(0x1c2)](_0x480cd3(0x173),_0x3a4a3c),loggerService_1[_0x480cd3(0x1a9)][_0x480cd3(0x1ca)](_0x3aff8f[_0x480cd3(0x1a6)],_0x3aff8f[_0x480cd3(0x1cc)]?.['settings']?.[_0x480cd3(0x167)]||_0x480cd3(0x195),_0x480cd3(0x159),_0x3a4a3c,{});}}async['sendPaymentStatusNotification'](_0x56f1b0,_0x1413c8){const _0x344a33=a35_0x356111;try{const _0x513ae4={'PENDING':_0x344a33(0x174),'PAID':_0x344a33(0x19a),'FAILED':'failed','EXPIRED':_0x344a33(0x1bc)},_0x3d7593=_0x513ae4[_0x1413c8];if(!_0x3d7593||_0x3d7593===_0x344a33(0x174))return;await telegramBotService_1[_0x344a33(0x199)][_0x344a33(0x1ba)](_0x56f1b0[_0x344a33(0x1a6)],_0x56f1b0,_0x3d7593);}catch(_0xe975fd){console[_0x344a33(0x1c2)](_0x344a33(0x165),_0xe975fd);}}async[a35_0x356111(0x18c)](_0x3f5e6a){const _0x5bc42b=a35_0x356111,_0x81f215=await database_1[_0x5bc42b(0x1b1)][_0x5bc42b(0x1e0)][_0x5bc42b(0x19f)]({'where':{'id':_0x3f5e6a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x81f215)throw new Error(_0x5bc42b(0x17b));if(_0x81f215[_0x5bc42b(0x164)]!==_0x5bc42b(0x18e))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');await this[_0x5bc42b(0x19d)](_0x81f215);}[a35_0x356111(0x17a)](){const _0x5eb776=a35_0x356111,_0x1a5680=this[_0x5eb776(0x1af)]?this[_0x5eb776(0x1de)]:undefined;return{'isActive':!!this[_0x5eb776(0x1af)],'checkIntervalMinutes':this[_0x5eb776(0x1de)]/(0x3e8*0x3c),'expiryDays':this[_0x5eb776(0x190)],'nextCheckIn':_0x1a5680};}}exports[a35_0x356111(0x1b6)]=CoinToPayStatusService,exports[a35_0x356111(0x1cf)]=new CoinToPayStatusService();