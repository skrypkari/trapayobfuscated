'use strict';const a37_0xaeedfe=a37_0xba4f;(function(_0x32c420,_0x5826df){const _0xbdb2aa=a37_0xba4f,_0x5d0139=_0x32c420();while(!![]){try{const _0xa27e32=parseInt(_0xbdb2aa(0x14c))/0x1*(parseInt(_0xbdb2aa(0xa0))/0x2)+-parseInt(_0xbdb2aa(0x6d))/0x3*(-parseInt(_0xbdb2aa(0x121))/0x4)+-parseInt(_0xbdb2aa(0xb9))/0x5+-parseInt(_0xbdb2aa(0xcd))/0x6*(parseInt(_0xbdb2aa(0xbf))/0x7)+-parseInt(_0xbdb2aa(0x12a))/0x8*(parseInt(_0xbdb2aa(0x114))/0x9)+-parseInt(_0xbdb2aa(0x110))/0xa+-parseInt(_0xbdb2aa(0xc2))/0xb*(-parseInt(_0xbdb2aa(0x9d))/0xc);if(_0xa27e32===_0x5826df)break;else _0x5d0139['push'](_0x5d0139['shift']());}catch(_0x10622d){_0x5d0139['push'](_0x5d0139['shift']());}}}(a37_0x37d9,0x99126));var __importDefault=this&&this['__importDefault']||function(_0x300d43){const _0xfb026c=a37_0xba4f;return _0x300d43&&_0x300d43[_0xfb026c(0xb4)]?_0x300d43:{'default':_0x300d43};};Object['defineProperty'](exports,a37_0xaeedfe(0xb4),{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0xaeedfe(0xee)]=void 0x0;const coinToPayService_1=require(a37_0xaeedfe(0x146)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0xaeedfe(0x80)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x1987cc=a37_0xaeedfe;this['globalCheckInterval']=null,this[_0x1987cc(0x89)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x1987cc(0xb2)]=new Map(),this[_0x1987cc(0xdf)]=new coinToPayService_1['CoinToPayService'](),console[_0x1987cc(0xad)]('🪙\x20CoinToPayStatusService\x20initialized');}[a37_0xaeedfe(0x103)](_0x3d2b29,_0x4dd42d){const _0x1e1dd2=a37_0xaeedfe;console[_0x1e1dd2(0xad)](_0x1e1dd2(0xd3)),console[_0x1e1dd2(0xad)]('\x20\x20\x20-\x20paymentId:\x20'+_0x3d2b29),console[_0x1e1dd2(0xad)](_0x1e1dd2(0x132)+_0x4dd42d),this['clearPaymentTimers'](_0x3d2b29);const _0x263947=[],_0x57851=new Date(),_0x323ba4=[{'delay':0x1*0x3c*0x3e8,'description':_0x1e1dd2(0x9a)},{'delay':0x2*0x3c*0x3e8,'description':_0x1e1dd2(0x7b)},{'delay':0x5*0x3c*0x3e8,'description':_0x1e1dd2(0x10c)},{'delay':0x5*0x3c*0x3e8,'description':_0x1e1dd2(0x10c)}];console[_0x1e1dd2(0xad)](_0x1e1dd2(0xf4)+_0x323ba4[_0x1e1dd2(0xc7)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x3d2b29);let _0x5c2a5e=0x0;_0x323ba4['forEach']((_0x1895c4,_0x2d1a38)=>{const _0x54de12=_0x1e1dd2;_0x5c2a5e+=_0x1895c4[_0x54de12(0x6b)];const _0x54f5e0=setTimeout(async()=>{const _0x212de3=_0x54de12;console[_0x212de3(0xad)](_0x212de3(0x116)+(_0x2d1a38+0x1)+_0x212de3(0x12d)+_0x3d2b29+_0x212de3(0x8a)+_0x1895c4[_0x212de3(0x9b)]+')');try{await this[_0x212de3(0xd9)](_0x3d2b29),console[_0x212de3(0xad)](_0x212de3(0xe7)+(_0x2d1a38+0x1)+_0x212de3(0x134)+_0x3d2b29);}catch(_0x4687a0){console['error'](_0x212de3(0xb7)+(_0x2d1a38+0x1)+_0x212de3(0xbb)+_0x3d2b29+':',_0x4687a0),this[_0x212de3(0x9c)](_0x3d2b29,_0x4dd42d,_0x4687a0,_0x212de3(0xa1),{'checkNumber':_0x2d1a38+0x1,'scheduledAfter':_0x1895c4[_0x212de3(0x9b)],'isIndividualCheck':!![]});}},_0x5c2a5e);_0x263947[_0x54de12(0x71)](_0x54f5e0),console[_0x54de12(0xad)](_0x54de12(0x147)+(_0x2d1a38+0x1)+_0x54de12(0xbb)+_0x3d2b29+_0x54de12(0xf1)+_0x5c2a5e/0x3e8+'\x20seconds\x20('+_0x1895c4[_0x54de12(0x9b)]+')');});const _0x2911aa=setInterval(async()=>{const _0x57dfb3=_0x1e1dd2;console[_0x57dfb3(0xad)](_0x57dfb3(0x81)+_0x3d2b29);try{const _0x1b7f63=await database_1['default'][_0x57dfb3(0x137)][_0x57dfb3(0xf8)]({'where':{'id':_0x3d2b29},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x1b7f63){console[_0x57dfb3(0xad)](_0x57dfb3(0x122)+_0x3d2b29+_0x57dfb3(0xa4)),this[_0x57dfb3(0x106)](_0x3d2b29);return;}console[_0x57dfb3(0xad)](_0x57dfb3(0x150)+_0x3d2b29+_0x57dfb3(0xc3)+_0x1b7f63[_0x57dfb3(0x104)]);if(_0x1b7f63[_0x57dfb3(0x104)]!==_0x57dfb3(0x138)){console[_0x57dfb3(0xad)]('✅\x20[HOURLY]\x20Payment\x20'+_0x3d2b29+_0x57dfb3(0xaa)+_0x1b7f63[_0x57dfb3(0x104)]+_0x57dfb3(0x90)),this[_0x57dfb3(0x106)](_0x3d2b29);return;}const _0x2601b3=Math[_0x57dfb3(0x9f)]((Date['now']()-_0x1b7f63['createdAt'][_0x57dfb3(0xf2)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x2601b3>=this[_0x57dfb3(0xd7)]){console[_0x57dfb3(0xad)](_0x57dfb3(0xfb)+_0x3d2b29+_0x57dfb3(0x10e)+this[_0x57dfb3(0xd7)]+_0x57dfb3(0xf5)),this[_0x57dfb3(0x106)](_0x3d2b29);return;}await this[_0x57dfb3(0xd9)](_0x3d2b29),console['log'](_0x57dfb3(0x6a)+_0x3d2b29);}catch(_0x3827a3){console[_0x57dfb3(0x86)](_0x57dfb3(0xf0)+_0x3d2b29+':',_0x3827a3),this[_0x57dfb3(0x9c)](_0x3d2b29,_0x4dd42d,_0x3827a3,_0x57dfb3(0xa1),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x263947[_0x1e1dd2(0x71)](_0x2911aa),this[_0x1e1dd2(0xb2)][_0x1e1dd2(0xac)](_0x3d2b29,{'timers':_0x263947,'paymentId':_0x3d2b29,'gatewayPaymentId':_0x4dd42d,'createdAt':_0x57851}),console['log'](_0x1e1dd2(0x12c)+_0x323ba4['length']+_0x1e1dd2(0x129)+_0x3d2b29),console[_0x1e1dd2(0xad)](_0x1e1dd2(0xc1)+this[_0x1e1dd2(0xb2)]['size']),this[_0x1e1dd2(0xa9)](_0x3d2b29,_0x4dd42d,_0x1e1dd2(0x138),_0x1e1dd2(0x138),_0x1e1dd2(0xa1),{'action':_0x1e1dd2(0x10a),'scheduledChecks':_0x323ba4[_0x1e1dd2(0xc7)],'firstCheckIn':_0x323ba4[0x0][_0x1e1dd2(0x6b)]/0x3e8,'totalTimers':this['paymentTimers'][_0x1e1dd2(0x119)]});}[a37_0xaeedfe(0x106)](_0x4d997f){const _0x1f4d46=a37_0xaeedfe,_0x5681c4=this[_0x1f4d46(0xb2)][_0x1f4d46(0xe6)](_0x4d997f);_0x5681c4?(console['log']('🧹\x20[DEBUG]\x20Clearing\x20'+_0x5681c4[_0x1f4d46(0x139)]['length']+_0x1f4d46(0xfd)+_0x4d997f),_0x5681c4[_0x1f4d46(0x139)][_0x1f4d46(0x93)]((_0xb6fb49,_0x4ad43b)=>{const _0x28f144=_0x1f4d46;_0xb6fb49&&(clearTimeout(_0xb6fb49),clearInterval(_0xb6fb49),console[_0x28f144(0xad)]('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x4ad43b+0x1)+_0x28f144(0xbb)+_0x4d997f));}),this[_0x1f4d46(0xb2)]['delete'](_0x4d997f),console[_0x1f4d46(0xad)](_0x1f4d46(0x8e)+_0x4d997f+_0x1f4d46(0x12b)+this[_0x1f4d46(0xb2)][_0x1f4d46(0x119)])):console[_0x1f4d46(0xad)](_0x1f4d46(0xd5)+_0x4d997f+'\x20to\x20clear');}async[a37_0xaeedfe(0xd9)](_0x49a830){const _0x4cf6c4=a37_0xaeedfe;console[_0x4cf6c4(0xad)](_0x4cf6c4(0xeb)+_0x49a830);const _0x35ce1d=await database_1[_0x4cf6c4(0x148)]['payment'][_0x4cf6c4(0xf8)]({'where':{'id':_0x49a830},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x35ce1d){console[_0x4cf6c4(0xad)](_0x4cf6c4(0xca)+_0x49a830+_0x4cf6c4(0xae));return;}console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x49a830+_0x4cf6c4(0xfa)),console[_0x4cf6c4(0xad)](_0x4cf6c4(0xab)+_0x35ce1d[_0x4cf6c4(0x6c)]),console['log'](_0x4cf6c4(0x84)+_0x35ce1d[_0x4cf6c4(0x104)]),console[_0x4cf6c4(0xad)](_0x4cf6c4(0x94)+_0x35ce1d[_0x4cf6c4(0xb5)]),console[_0x4cf6c4(0xad)](_0x4cf6c4(0x77)+_0x35ce1d[_0x4cf6c4(0x135)]+'\x20'+_0x35ce1d[_0x4cf6c4(0x83)]),console['log'](_0x4cf6c4(0xc0)+_0x35ce1d[_0x4cf6c4(0xb3)]);if(_0x35ce1d['gateway']!==_0x4cf6c4(0xec)){console[_0x4cf6c4(0xad)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x49a830+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x35ce1d[_0x4cf6c4(0x6c)]+')');return;}if(_0x35ce1d['status']!==_0x4cf6c4(0x138)){console[_0x4cf6c4(0xad)](_0x4cf6c4(0x7a)+_0x49a830+_0x4cf6c4(0xaa)+_0x35ce1d['status']+_0x4cf6c4(0x90)),this[_0x4cf6c4(0x106)](_0x49a830);return;}if(!_0x35ce1d[_0x4cf6c4(0xb5)]){console[_0x4cf6c4(0xad)](_0x4cf6c4(0x7a)+_0x49a830+_0x4cf6c4(0x13c));return;}console[_0x4cf6c4(0xad)](_0x4cf6c4(0x88)+_0x49a830+_0x4cf6c4(0xd1)),await this[_0x4cf6c4(0x7f)](_0x35ce1d);}['logCoinToPayStatus'](_0x4a9ea0,_0x3215cd,_0x4193b7,_0x40175e,_0x50b744,_0x108363){const _0x510be5=a37_0xaeedfe,_0x17bcbf={'type':_0x510be5(0xc9),'paymentId':_0x4a9ea0,'gatewayPaymentId':_0x3215cd,'oldStatus':_0x4193b7,'newStatus':_0x40175e,'source':_0x50b744,'timestamp':new Date()[_0x510be5(0x73)](),'details':_0x108363||{}};loggerService_1[_0x510be5(0x7e)][_0x510be5(0xa9)](_0x17bcbf),console[_0x510be5(0xad)](_0x510be5(0xff)+_0x4a9ea0+'\x20('+_0x3215cd+')'),console[_0x510be5(0xad)](_0x510be5(0x142)+_0x4193b7+_0x510be5(0xfe)+_0x40175e),console[_0x510be5(0xad)](_0x510be5(0x149)+_0x50b744),console[_0x510be5(0xad)](_0x510be5(0xda)+_0x17bcbf[_0x510be5(0x13f)]),_0x108363&&console[_0x510be5(0xad)](_0x510be5(0xe5),_0x108363);}['logCoinToPayError'](_0x4e725e,_0x3dc4ae,_0x1d0c7f,_0x3a1678,_0x22ddcf){const _0x164f7b=a37_0xaeedfe,_0x3f967f={'type':_0x164f7b(0x74),'paymentId':_0x4e725e,'gatewayPaymentId':_0x3dc4ae,'error':_0x1d0c7f instanceof Error?{'message':_0x1d0c7f[_0x164f7b(0xb6)],'stack':_0x1d0c7f['stack']}:_0x1d0c7f,'source':_0x3a1678,'timestamp':new Date()[_0x164f7b(0x73)](),'context':_0x22ddcf||{}};loggerService_1[_0x164f7b(0x7e)]['logCoinToPayError'](_0x3f967f),console[_0x164f7b(0x86)](_0x164f7b(0x9e)+_0x4e725e+'\x20('+_0x3dc4ae+')'),console[_0x164f7b(0x86)](_0x164f7b(0xcc)+(_0x1d0c7f instanceof Error?_0x1d0c7f[_0x164f7b(0xb6)]:_0x1d0c7f)),console[_0x164f7b(0x86)](_0x164f7b(0x149)+_0x3a1678),console[_0x164f7b(0x86)](_0x164f7b(0xda)+_0x3f967f[_0x164f7b(0x13f)]),_0x22ddcf&&console[_0x164f7b(0x86)](_0x164f7b(0xa7),_0x22ddcf);}[a37_0xaeedfe(0xcf)](){const _0x25ad2e=a37_0xaeedfe;console[_0x25ad2e(0xad)](_0x25ad2e(0x128)),this[_0x25ad2e(0x79)]()['catch'](_0x4f7a7d=>{const _0x24b2e9=_0x25ad2e;console['error'](_0x24b2e9(0xa3),_0x4f7a7d);}),this[_0x25ad2e(0x13d)]=setInterval(async()=>{const _0x3ae541=_0x25ad2e;try{console['log']('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this['checkAllPendingPayments'](),console[_0x3ae541(0xad)](_0x3ae541(0x131));}catch(_0x673cda){console['error'](_0x3ae541(0x14f),_0x673cda);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x25ad2e(0xad)](_0x25ad2e(0x75));}['stopPeriodicStatusCheck'](){const _0x5d02f7=a37_0xaeedfe;console[_0x5d02f7(0xad)](_0x5d02f7(0x11c));this[_0x5d02f7(0x13d)]&&(clearInterval(this[_0x5d02f7(0x13d)]),this[_0x5d02f7(0x13d)]=null,console['log'](_0x5d02f7(0x152)));const _0x1cc206=this['paymentTimers'][_0x5d02f7(0x119)];for(const [_0x1d515f]of this[_0x5d02f7(0xb2)]){this[_0x5d02f7(0x106)](_0x1d515f);}console[_0x5d02f7(0xad)](_0x5d02f7(0x99)+_0x1cc206+_0x5d02f7(0x14b));}async[a37_0xaeedfe(0x79)](){const _0x467e16=a37_0xaeedfe;try{console[_0x467e16(0xad)](_0x467e16(0xb0));const _0x313338=await database_1[_0x467e16(0x148)][_0x467e16(0x137)][_0x467e16(0x11d)]({'where':{'gateway':'cointopay','status':_0x467e16(0x138),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x467e16(0xad)](_0x467e16(0x10b)+_0x313338['length']+_0x467e16(0x14d));if(_0x313338[_0x467e16(0xc7)]===0x0){console[_0x467e16(0xad)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x2eb769=await this[_0x467e16(0xb8)](_0x313338);console[_0x467e16(0xad)](_0x467e16(0x151)+_0x2eb769[_0x467e16(0xc7)]+_0x467e16(0xd4));let _0x39cd22=0x0,_0x14810e=0x0;for(const _0x21280e of _0x313338){try{if(_0x2eb769[_0x467e16(0x8f)](_0x21280e['id'])){console[_0x467e16(0xad)](_0x467e16(0x105)+_0x21280e['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x14810e++;continue;}if(this['paymentTimers'][_0x467e16(0xba)](_0x21280e['id'])){console[_0x467e16(0xad)](_0x467e16(0x105)+_0x21280e['id']+_0x467e16(0x140)),_0x14810e++;continue;}const _0x25c8b9=(Date[_0x467e16(0x136)]()-_0x21280e[_0x467e16(0x145)][_0x467e16(0xf2)]())/(0x3e8*0x3c*0x3c);if(_0x25c8b9<0x1){console[_0x467e16(0xad)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x21280e['id']+_0x467e16(0x70)+_0x25c8b9[_0x467e16(0xde)](0x1)+_0x467e16(0x87)),_0x14810e++;continue;}console['log'](_0x467e16(0x111)+_0x21280e['id']+_0x467e16(0x12f)+_0x25c8b9['toFixed'](0x1)+'h)'),await this[_0x467e16(0x7f)](_0x21280e),_0x39cd22++,await new Promise(_0x21829d=>setTimeout(_0x21829d,0x7d0));}catch(_0x3aad49){console[_0x467e16(0x86)]('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x21280e['id']+':',_0x3aad49),this[_0x467e16(0x9c)](_0x21280e['id'],_0x21280e[_0x467e16(0xb5)]||_0x467e16(0x14e),_0x3aad49,_0x467e16(0xa1),{'isGlobalCheck':!![],'paymentAmount':_0x21280e[_0x467e16(0x135)],'paymentCurrency':_0x21280e[_0x467e16(0x83)],'shopId':_0x21280e[_0x467e16(0xb3)],'createdAt':_0x21280e[_0x467e16(0x145)]}),loggerService_1['loggerService'][_0x467e16(0xcb)](_0x467e16(0xec),_0x467e16(0xfc)+_0x21280e[_0x467e16(0xb5)],_0x3aad49);}}console['log'](_0x467e16(0x91)+_0x39cd22+'\x20checked,\x20'+_0x14810e+_0x467e16(0x118)+_0x2eb769['length']+_0x467e16(0x112));}catch(_0x1e96b1){console[_0x467e16(0x86)](_0x467e16(0x72),_0x1e96b1);}}async['checkExpiredPayments'](_0x333110){const _0x5782f9=a37_0xaeedfe,_0x552eef=[],_0x46fbe6=new Date();_0x46fbe6[_0x5782f9(0x127)](_0x46fbe6[_0x5782f9(0xe2)]()-this[_0x5782f9(0xd7)]),console[_0x5782f9(0xad)](_0x5782f9(0x115)+this[_0x5782f9(0xd7)]+_0x5782f9(0xd0)+_0x46fbe6[_0x5782f9(0x73)]()+')');for(const _0x31372c of _0x333110){if(_0x31372c[_0x5782f9(0x145)]<_0x46fbe6){console['log']('⏰\x20[EXPIRY]\x20Payment\x20'+_0x31372c['id']+_0x5782f9(0x10e)+this[_0x5782f9(0xd7)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x5782f9(0xa9)](_0x31372c['id'],_0x31372c[_0x5782f9(0xb5)]||'unknown','PENDING',_0x5782f9(0x8d),'auto_expire',{'reason':_0x5782f9(0xbe)+this[_0x5782f9(0xd7)]+_0x5782f9(0x92),'createdAt':_0x31372c['createdAt'],'daysSinceCreation':Math['floor']((Date[_0x5782f9(0x136)]()-_0x31372c[_0x5782f9(0x145)][_0x5782f9(0xf2)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x31372c[_0x5782f9(0x135)],'paymentCurrency':_0x31372c[_0x5782f9(0x83)],'shopId':_0x31372c['shopId']}),await database_1[_0x5782f9(0x148)][_0x5782f9(0x137)]['update']({'where':{'id':_0x31372c['id']},'data':{'status':_0x5782f9(0x8d),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x5782f9(0xd7)]+_0x5782f9(0xe1)}}),await database_1[_0x5782f9(0x148)][_0x5782f9(0xe9)][_0x5782f9(0xbc)]({'data':{'paymentId':_0x31372c['id'],'shopId':_0x31372c[_0x5782f9(0xb3)],'event':_0x5782f9(0x13b),'statusCode':0xc8,'responseBody':JSON[_0x5782f9(0x69)]({'reason':_0x5782f9(0xbe)+this[_0x5782f9(0xd7)]+_0x5782f9(0x92),'createdAt':_0x31372c['createdAt'],'expiredAt':new Date()[_0x5782f9(0x73)](),'daysSinceCreation':Math[_0x5782f9(0x9f)]((Date['now']()-_0x31372c['createdAt'][_0x5782f9(0xf2)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x5782f9(0x141)](_0x31372c,'EXPIRED'),await this[_0x5782f9(0xea)](_0x31372c,_0x5782f9(0x8d)),this[_0x5782f9(0x106)](_0x31372c['id']),_0x552eef[_0x5782f9(0x71)](_0x31372c['id']),console[_0x5782f9(0xad)](_0x5782f9(0x13a)+_0x31372c['id']+_0x5782f9(0x133)+this[_0x5782f9(0xd7)]+_0x5782f9(0xe3));}catch(_0x384a0d){console['error']('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x31372c['id']+':',_0x384a0d),this[_0x5782f9(0x9c)](_0x31372c['id'],_0x31372c['gatewayPaymentId']||_0x5782f9(0x14e),_0x384a0d,_0x5782f9(0x11e),{'reason':_0x5782f9(0x98),'createdAt':_0x31372c['createdAt'],'daysSinceCreation':Math['floor']((Date[_0x5782f9(0x136)]()-_0x31372c[_0x5782f9(0x145)][_0x5782f9(0xf2)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x552eef;}async[a37_0xaeedfe(0x7f)](_0x4ace97){const _0x3b37bd=a37_0xaeedfe;if(!_0x4ace97[_0x3b37bd(0xb5)]){console[_0x3b37bd(0xad)](_0x3b37bd(0x7a)+_0x4ace97['id']+_0x3b37bd(0x101));return;}console[_0x3b37bd(0xad)](_0x3b37bd(0x13e)+_0x4ace97['id']+'\x20('+_0x4ace97[_0x3b37bd(0xb5)]+')');try{const _0x2eefdb=await this[_0x3b37bd(0xdf)]['checkPaymentStatus'](_0x4ace97[_0x3b37bd(0xb5)]);console['log'](_0x3b37bd(0x78)+_0x4ace97['id']+'\x20status:\x20'+_0x2eefdb['status']);_0x2eefdb[_0x3b37bd(0x7c)]&&console[_0x3b37bd(0xad)](_0x3b37bd(0x78)+_0x4ace97['id']+'\x20details:',{'iban':_0x2eefdb[_0x3b37bd(0x7c)]['iban']||_0x3b37bd(0xaf),'transactionId':_0x2eefdb[_0x3b37bd(0x7c)]['transactionId'],'createdOn':_0x2eefdb[_0x3b37bd(0x7c)][_0x3b37bd(0x7d)],'confirmedOn':_0x2eefdb[_0x3b37bd(0x7c)][_0x3b37bd(0xce)]||_0x3b37bd(0xdb)});if(_0x2eefdb[_0x3b37bd(0x104)]!==_0x4ace97[_0x3b37bd(0x104)]){console['log']('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x4ace97['id']+_0x3b37bd(0xe0)+_0x4ace97['status']+_0x3b37bd(0x97)+_0x2eefdb['status']),this[_0x3b37bd(0xa9)](_0x4ace97['id'],_0x4ace97[_0x3b37bd(0xb5)],_0x4ace97[_0x3b37bd(0x104)],_0x2eefdb[_0x3b37bd(0x104)],_0x3b37bd(0xa1),{'paymentDetails':_0x2eefdb['paymentDetails'],'amount':_0x2eefdb[_0x3b37bd(0x135)],'currency':_0x2eefdb[_0x3b37bd(0x83)],'shopId':_0x4ace97[_0x3b37bd(0xb3)],'checkTimestamp':new Date()[_0x3b37bd(0x73)]()});const _0x8e92f9={'status':_0x2eefdb[_0x3b37bd(0x104)],'updatedAt':new Date()};_0x2eefdb[_0x3b37bd(0x104)]===_0x3b37bd(0xa5)&&_0x4ace97[_0x3b37bd(0x104)]!==_0x3b37bd(0xa5)&&(_0x8e92f9[_0x3b37bd(0x107)]=new Date(),console[_0x3b37bd(0xad)](_0x3b37bd(0x10f)+_0x4ace97['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x8e92f9[_0x3b37bd(0x107)][_0x3b37bd(0x73)]()));if(_0x2eefdb['paymentDetails']){const _0x10182e=_0x2eefdb[_0x3b37bd(0x7c)];_0x10182e[_0x3b37bd(0xd6)]&&(_0x8e92f9[_0x3b37bd(0xbd)]=_0x10182e[_0x3b37bd(0xd6)],console[_0x3b37bd(0xad)](_0x3b37bd(0xd8)+_0x10182e[_0x3b37bd(0xd6)]));if(_0x10182e[_0x3b37bd(0x76)]){const _0x1fc30c=_0x4ace97['adminNotes']||'',_0x425162=_0x3b37bd(0x95)+_0x10182e[_0x3b37bd(0x76)];_0x8e92f9['adminNotes']=_0x1fc30c?_0x1fc30c+'\x0a\x0a'+_0x425162:_0x425162,console[_0x3b37bd(0xad)](_0x3b37bd(0x144));}_0x10182e[_0x3b37bd(0xa2)]&&console[_0x3b37bd(0xad)](_0x3b37bd(0x100)+_0x10182e[_0x3b37bd(0xa2)]),_0x10182e['confirmedOn']&&console[_0x3b37bd(0xad)]('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x10182e[_0x3b37bd(0xce)]);}await database_1[_0x3b37bd(0x148)][_0x3b37bd(0x137)][_0x3b37bd(0xed)]({'where':{'id':_0x4ace97['id']},'data':_0x8e92f9}),await database_1[_0x3b37bd(0x148)]['webhookLog'][_0x3b37bd(0xbc)]({'data':{'paymentId':_0x4ace97['id'],'shopId':_0x4ace97[_0x3b37bd(0xb3)],'event':_0x3b37bd(0x8b)+_0x2eefdb['status'][_0x3b37bd(0xdc)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x4ace97['status'],'newStatus':_0x2eefdb[_0x3b37bd(0x104)],'paymentDetails':_0x2eefdb[_0x3b37bd(0x7c)],'checkedAt':new Date()[_0x3b37bd(0x73)]()})}}),await this['sendShopWebhook'](_0x4ace97,_0x2eefdb[_0x3b37bd(0x104)]),await this[_0x3b37bd(0xea)](_0x4ace97,_0x2eefdb[_0x3b37bd(0x104)]),_0x2eefdb['status']!=='PENDING'&&(console['log'](_0x3b37bd(0xb1)+_0x4ace97['id']+_0x3b37bd(0x11f)+_0x2eefdb[_0x3b37bd(0x104)]+_0x3b37bd(0xdd)),this[_0x3b37bd(0x106)](_0x4ace97['id'])),console[_0x3b37bd(0xad)](_0x3b37bd(0x88)+_0x4ace97['id']+'\x20updated\x20successfully');}else console[_0x3b37bd(0xad)]('📊\x20[CHECK]\x20Payment\x20'+_0x4ace97['id']+_0x3b37bd(0xc6)+_0x2eefdb[_0x3b37bd(0x104)]+')'),this[_0x3b37bd(0xa9)](_0x4ace97['id'],_0x4ace97[_0x3b37bd(0xb5)],_0x4ace97[_0x3b37bd(0x104)],_0x2eefdb[_0x3b37bd(0x104)],_0x3b37bd(0xa1),{'statusUnchanged':!![],'paymentDetails':_0x2eefdb[_0x3b37bd(0x7c)],'amount':_0x2eefdb[_0x3b37bd(0x135)],'currency':_0x2eefdb['currency'],'shopId':_0x4ace97[_0x3b37bd(0xb3)],'checkTimestamp':new Date()[_0x3b37bd(0x73)]()});}catch(_0x269e55){console['error'](_0x3b37bd(0x126)+_0x4ace97['id']+':',_0x269e55),this[_0x3b37bd(0x9c)](_0x4ace97['id'],_0x4ace97[_0x3b37bd(0xb5)],_0x269e55,_0x3b37bd(0xa1),{'paymentAmount':_0x4ace97[_0x3b37bd(0x135)],'paymentCurrency':_0x4ace97[_0x3b37bd(0x83)],'shopId':_0x4ace97[_0x3b37bd(0xb3)],'createdAt':_0x4ace97[_0x3b37bd(0x145)]}),await database_1[_0x3b37bd(0x148)][_0x3b37bd(0xe9)][_0x3b37bd(0xbc)]({'data':{'paymentId':_0x4ace97['id'],'shopId':_0x4ace97[_0x3b37bd(0xb3)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x3b37bd(0x69)]({'error':_0x269e55 instanceof Error?_0x269e55[_0x3b37bd(0xb6)]:'Unknown\x20error','gatewayPaymentId':_0x4ace97['gatewayPaymentId'],'checkedAt':new Date()['toISOString']()})}});}}async[a37_0xaeedfe(0x141)](_0x52cec2,_0x3eab91){const _0x4f6712=a37_0xaeedfe,_0x2a072=Date[_0x4f6712(0x136)]();try{const _0x5e7ae1=_0x52cec2['shop'],_0x151250=_0x5e7ae1[_0x4f6712(0xf6)];if(!_0x151250?.[_0x4f6712(0x109)]){console[_0x4f6712(0xad)](_0x4f6712(0x85)+_0x5e7ae1['id']);return;}const _0x2373d5=_0x3eab91===_0x4f6712(0xa5)?_0x4f6712(0x130):_0x3eab91===_0x4f6712(0x11a)?_0x4f6712(0x143):_0x3eab91===_0x4f6712(0x8d)?_0x4f6712(0x143):_0x4f6712(0x11b);if(!_0x151250[_0x4f6712(0xe4)]?.['includes'](_0x2373d5)){console['log'](_0x4f6712(0xef)+_0x2373d5+_0x4f6712(0x68)+_0x5e7ae1['id']);return;}const _0x219190={'event':_0x2373d5,'payment':{'id':_0x52cec2['id'],'order_id':_0x52cec2[_0x4f6712(0xa6)],'gateway_order_id':_0x52cec2[_0x4f6712(0x113)],'gateway':_0x4f6712(0xf7),'amount':_0x52cec2[_0x4f6712(0x135)],'currency':_0x52cec2['currency'],'status':_0x3eab91['toLowerCase'](),'customer_email':_0x52cec2[_0x4f6712(0xc4)],'customer_name':_0x52cec2['customerName'],'created_at':_0x52cec2[_0x4f6712(0x145)],'updated_at':new Date()}},_0x57c395=await fetch(_0x151250[_0x4f6712(0x109)],{'method':_0x4f6712(0xf3),'headers':{'Content-Type':_0x4f6712(0x8c),'User-Agent':_0x4f6712(0x124)},'body':JSON[_0x4f6712(0x69)](_0x219190)}),_0x503e6a=Date['now']()-_0x2a072,_0x557194=_0x57c395['ok']?_0x4f6712(0x117):await _0x57c395['text']();loggerService_1['loggerService']['logShopWebhookSent'](_0x52cec2['shopId'],_0x151250[_0x4f6712(0x109)],_0x2373d5,_0x57c395['status'],_0x503e6a,_0x219190),console[_0x4f6712(0xad)](_0x4f6712(0xe8)+_0x151250[_0x4f6712(0x109)]+_0x4f6712(0x123)+_0x57c395[_0x4f6712(0x104)]+'\x20('+_0x503e6a+'ms)');}catch(_0x5c8dff){console[_0x4f6712(0x86)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x5c8dff),loggerService_1['loggerService']['logShopWebhookError'](_0x52cec2['shopId'],_0x52cec2[_0x4f6712(0x14a)]?.[_0x4f6712(0xf6)]?.[_0x4f6712(0x109)]||_0x4f6712(0x14e),'webhook_send',_0x5c8dff,{});}}async[a37_0xaeedfe(0xea)](_0x487bc4,_0x3809d1){const _0x37c846=a37_0xaeedfe;try{const _0x558ea9={'PENDING':_0x37c846(0xc8),'PAID':_0x37c846(0x6f),'FAILED':'failed','EXPIRED':_0x37c846(0x10d)},_0x25182f=_0x558ea9[_0x3809d1];if(!_0x25182f||_0x25182f===_0x37c846(0xc8))return;await telegramBotService_1[_0x37c846(0x125)][_0x37c846(0x96)](_0x487bc4['shopId'],_0x487bc4,_0x25182f);}catch(_0x532c25){console[_0x37c846(0x86)](_0x37c846(0x108),_0x532c25);}}async['checkPaymentById'](_0x5e1b04){const _0x15e48f=a37_0xaeedfe;console[_0x15e48f(0xad)](_0x15e48f(0x120)+_0x5e1b04);const _0x3f4603=await database_1[_0x15e48f(0x148)]['payment'][_0x15e48f(0xf8)]({'where':{'id':_0x5e1b04},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3f4603)throw new Error('Payment\x20not\x20found');if(_0x3f4603['gateway']!=='cointopay')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x15e48f(0xad)](_0x15e48f(0x82)+_0x5e1b04),await this[_0x15e48f(0x7f)](_0x3f4603),console[_0x15e48f(0xad)](_0x15e48f(0xa8)+_0x5e1b04);}[a37_0xaeedfe(0x6e)](){const _0x509cd1=a37_0xaeedfe,_0x3819e3=this[_0x509cd1(0x13d)]?this[_0x509cd1(0x89)]:undefined,_0x456820=Array[_0x509cd1(0x102)](this[_0x509cd1(0xb2)]['values']())[_0x509cd1(0xc5)](_0x329517=>({'paymentId':_0x329517[_0x509cd1(0x12e)],'gatewayPaymentId':_0x329517['gatewayPaymentId'],'createdAt':_0x329517['createdAt'],'timersCount':_0x329517[_0x509cd1(0x139)][_0x509cd1(0xc7)]}));return{'isActive':!!this[_0x509cd1(0x13d)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x509cd1(0xb2)]['size'],'nextGlobalCheckIn':_0x3819e3,'paymentTimersDetails':_0x456820};}[a37_0xaeedfe(0xd2)](_0x34dbef){const _0xbebfac=a37_0xaeedfe,_0x47d39f=this['paymentTimers'][_0xbebfac(0xe6)](_0x34dbef);if(_0x47d39f)return{'hasTimers':!![],'timersCount':_0x47d39f[_0xbebfac(0x139)][_0xbebfac(0xc7)],'createdAt':_0x47d39f[_0xbebfac(0x145)],'gatewayPaymentId':_0x47d39f[_0xbebfac(0xb5)]};return{'hasTimers':![]};}}exports[a37_0xaeedfe(0xee)]=CoinToPayStatusService,exports[a37_0xaeedfe(0xf9)]=new CoinToPayStatusService();function a37_0xba4f(_0x505570,_0x37582c){const _0x37d9c6=a37_0x37d9();return a37_0xba4f=function(_0xba4f41,_0x4bd359){_0xba4f41=_0xba4f41-0x68;let _0x351b11=_0x37d9c6[_0xba4f41];return _0x351b11;},a37_0xba4f(_0x505570,_0x37582c);}function a37_0x37d9(){const _0x4b083c=['get','✅\x20[TIMER]\x20Individual\x20check\x20#','Shop\x20webhook\x20sent\x20to\x20','webhookLog','sendPaymentStatusNotification','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','cointopay','update','CoinToPayStatusService','Webhook\x20event\x20','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20in\x20','getTime','POST','🪙\x20[DEBUG]\x20Creating\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','settings','0100','findUnique','coinToPayStatusService','\x20found:','⏰\x20[HOURLY]\x20Payment\x20','/status/','\x20timers\x20for\x20payment\x20','\x20->\x20','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','from','schedulePaymentChecks','status','⏰\x20[GLOBAL]\x20Payment\x20','clearPaymentTimers','paidAt','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','webhookUrl','schedule_created','🪙\x20[GLOBAL]\x20Found\x20','5\x20minutes','expired','\x20is\x20older\x20than\x20','💰\x20[CHECK]\x20Payment\x20','6600380BUQAOL','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','\x20expired','gatewayOrderId','2377863PsEhFs','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','Success','\x20skipped,\x20','size','FAILED','payment.pending','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','findMany','auto_expire','\x20status\x20changed\x20to\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','2196wpknwS','❌\x20[HOURLY]\x20Payment\x20','\x20with\x20status\x20','TesSoft\x20Payment\x20System/1.0','telegramBotService','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','setDate','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','8fpPufm','.\x20Remaining\x20active\x20timers:\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20triggered\x20for\x20payment\x20','paymentId','\x20(age:\x20','payment.success','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20\x20\x20-\x20gatewayPaymentId:\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20completed\x20for\x20payment\x20','amount','now','payment','PENDING','timers','✅\x20[EXPIRY]\x20Payment\x20','cointopay_auto_expired','\x20has\x20no\x20gatewayPaymentId','globalCheckInterval','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','timestamp','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','sendShopWebhook','\x20\x20\x20📊\x20Status:\x20','payment.failed','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','createdAt','./gateways/coinToPayService','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','default','\x20\x20\x20📍\x20Source:\x20','shop','\x20individual\x20payment\x20timers','2483xCMGZa','\x20pending\x20CoinToPay\x20payments','unknown','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','📊\x20[HOURLY]\x20Payment\x20','⏰\x20[GLOBAL]\x20Found\x20','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20not\x20enabled\x20for\x20shop\x20','stringify','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','delay','gateway','1848wIOPdS','getServiceStats','paid','\x20is\x20too\x20new\x20(','push','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','toISOString','COINTOPAY_ERROR','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','bankDetails','\x20\x20\x20-\x20Amount:\x20','📊\x20[CHECK]\x20Payment\x20','checkAllPendingPayments','⚠️\x20[CHECK]\x20Payment\x20','2\x20minutes','paymentDetails','createdOn','loggerService','checkSinglePayment','./telegramBotService','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','currency','\x20\x20\x20-\x20Status:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','error','h),\x20skipping\x20global\x20check','✅\x20[CHECK]\x20Payment\x20','GLOBAL_CHECK_INTERVAL_MS','\x20(after\x20','cointopay_status_check_','application/json','EXPIRED','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','includes',',\x20stopping\x20individual\x20checks','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20days','forEach','\x20\x20\x20-\x20GatewayPaymentId:\x20','Bank\x20Details:\x20','sendPaymentNotification','\x20to\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','🛑\x20[SHUTDOWN]\x20Cleared\x20','1\x20minute','description','logCoinToPayError','115716CQGlAT','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','floor','778DptVwr','status_check','transactionId','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20not\x20found,\x20clearing\x20timers','PAID','orderId','\x20\x20\x20📝\x20Context:','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','logCoinToPayStatus','\x20status\x20is\x20','\x20\x20\x20-\x20Gateway:\x20','set','log','\x20not\x20found\x20in\x20database','not\x20found','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','🧹\x20[CHECK]\x20Payment\x20','paymentTimers','shopId','__esModule','gatewayPaymentId','message','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','checkExpiredPayments','1381775mAipdo','has','\x20for\x20payment\x20','create','remitterIban','Payment\x20older\x20than\x20','21bnJHAJ','\x20\x20\x20-\x20ShopId:\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','1837vqmQTx','\x20current\x20status:\x20','customerEmail','map','\x20status\x20unchanged\x20(','length','created','COINTOPAY_STATUS_CHANGE','❌\x20[CHECK]\x20Payment\x20','logWhiteDomainError','\x20\x20\x20❌\x20Error:\x20','2173740OUCCix','confirmedOn','startPeriodicStatusCheck','\x20days\x20(created\x20before\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','getPaymentTimerInfo','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20expired\x20CoinToPay\x20payments','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','iban','EXPIRY_DAYS','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','checkSinglePaymentById','\x20\x20\x20📅\x20Time:\x20','not\x20confirmed','toLowerCase',',\x20clearing\x20individual\x20timers','toFixed','coinToPayService','\x20status\x20from\x20','\x20days\x20without\x20payment\x20confirmation','getDate','-day\x20timeout','webhookEvents','\x20\x20\x20📝\x20Details:'];a37_0x37d9=function(){return _0x4b083c;};return a37_0x37d9();}