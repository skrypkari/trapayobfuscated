'use strict';const a35_0x4f1536=a35_0xdbe7;function a35_0xdbe7(_0x357306,_0x21b744){const _0x233763=a35_0x2337();return a35_0xdbe7=function(_0xdbe7d9,_0x323659){_0xdbe7d9=_0xdbe7d9-0x18f;let _0xb03a8=_0x233763[_0xdbe7d9];return _0xb03a8;},a35_0xdbe7(_0x357306,_0x21b744);}(function(_0x59acfb,_0x3f443f){const _0x2e9143=a35_0xdbe7,_0x2d1e31=_0x59acfb();while(!![]){try{const _0x30afc9=parseInt(_0x2e9143(0x1a9))/0x1*(parseInt(_0x2e9143(0x1e9))/0x2)+parseInt(_0x2e9143(0x1d4))/0x3+-parseInt(_0x2e9143(0x214))/0x4*(-parseInt(_0x2e9143(0x1ac))/0x5)+-parseInt(_0x2e9143(0x1a0))/0x6*(parseInt(_0x2e9143(0x207))/0x7)+parseInt(_0x2e9143(0x1c8))/0x8*(parseInt(_0x2e9143(0x1eb))/0x9)+-parseInt(_0x2e9143(0x1ae))/0xa+-parseInt(_0x2e9143(0x1db))/0xb;if(_0x30afc9===_0x3f443f)break;else _0x2d1e31['push'](_0x2d1e31['shift']());}catch(_0x9f7e5b){_0x2d1e31['push'](_0x2d1e31['shift']());}}}(a35_0x2337,0xa270c));var __importDefault=this&&this[a35_0x4f1536(0x1f0)]||function(_0x336da5){return _0x336da5&&_0x336da5['__esModule']?_0x336da5:{'default':_0x336da5};};function a35_0x2337(){const _0x2d3244=['117CDwcSC','sendPaymentStatusNotification','Payment\x20not\x20found','24040YFWgSH','application/json','7133750bFrqjy','gatewayPaymentId','findMany','ðŸ“Š\x20Payment\x20','-day\x20timeout','\x20days','EXPIRY_DAYS','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','createdAt','telegramBotService','ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','Periodic\x20CoinToPay\x20status\x20check\x20failed:','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','Initial\x20CoinToPay\x20status\x20check\x20failed:','currency','\x20days\x20(created\x20before\x20','catch','not\x20confirmed','0100','CHECK_INTERVAL_MS','default','Payment\x20older\x20than\x20','cointopay_auto_expired','message','\x20details:','72StoJnh','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','./gateways/coinToPayService','TesSoft\x20Payment\x20System/1.0','cointopay_status_check_','defineProperty','ðŸ¦\x20Saved\x20IBAN:\x20','log','create','coinToPayService','payment.pending','Failed\x20to\x20check\x20payment\x20','3550332Tsriam','transactionId','status','webhookEvents','settings','âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','webhookLog','12268245vDOhfE','â°\x20Payment\x20','paidAt','includes','paid','ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','loggerService','createdOn','payment.failed','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','payment.success','floor','checkSinglePayment','./telegramBotService','22038eKoOMA','\x20with\x20status\x20','186858BRTbFJ','__esModule','ðŸ’°\x20Payment\x20','expired','customerName','__importDefault','\x20not\x20enabled\x20for\x20shop\x20','\x20status\x20from\x20','customerEmail','now','\x20marked\x20as\x20paid\x20at:\x20','CoinToPayStatusService','iban','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','ms)','\x20has\x20no\x20gatewayPaymentId,\x20skipping','logShopWebhookSent','findUnique','remitterIban','\x20updated\x20successfully','PENDING','cointopay_status_check_error','ðŸª™\x20Checking\x20','\x20status\x20unchanged\x20(','\x20status:\x20','getTime','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','\x20expired\x20CoinToPay\x20payments','175hvEGnK','/status/','startPeriodicStatusCheck','FAILED','Failed\x20to\x20send\x20shop\x20webhook:','POST','\x20days,\x20marking\x20as\x20EXPIRED','getDate','stringify','paymentDetails','Success','PAID','checkAllPendingPayments','288MalbHi','bankDetails','sendShopWebhook','checkExpiredPayments','ðŸ†”\x20Transaction\x20ID:\x20','webhookUrl','\x20pending\x20CoinToPay\x20payments','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','Shop\x20webhook\x20sent\x20to\x20','CoinToPayService','orderId','shopId','cointopay','created','\x20is\x20older\x20than\x20','not\x20found','ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped','update','sendPaymentNotification','shop','Bank\x20Details:\x20','\x20to\x20','Failed\x20to\x20expire\x20payment\x20','adminNotes','length','âœ…\x20Payment\x20','coinToPayStatusService','\x20days\x20without\x20payment\x20confirmation','122802kjcJiK','toISOString','confirmedOn','checkInterval','error','payment','push','EXPIRED','Webhook\x20event\x20'];a35_0x2337=function(){return _0x2d3244;};return a35_0x2337();}Object[a35_0x4f1536(0x1cd)](exports,a35_0x4f1536(0x1ec),{'value':!![]}),exports['coinToPayStatusService']=exports[a35_0x4f1536(0x1f6)]=void 0x0;const coinToPayService_1=require(a35_0x4f1536(0x1ca)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a35_0x4f1536(0x1e8)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x446d8e=a35_0x4f1536;this[_0x446d8e(0x1a3)]=null,this['CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x446d8e(0x1b4)]=0x5,this[_0x446d8e(0x1d1)]=new coinToPayService_1[(_0x446d8e(0x21d))]();}[a35_0x4f1536(0x209)](){const _0x368b92=a35_0x4f1536;console[_0x368b92(0x1cf)](_0x368b92(0x205)),this[_0x368b92(0x213)]()[_0x368b92(0x1bf)](_0x3f4560=>{const _0x16143a=_0x368b92;console[_0x16143a(0x1a4)](_0x16143a(0x1bc),_0x3f4560);}),this['checkInterval']=setInterval(async()=>{const _0x50189d=_0x368b92;try{await this[_0x50189d(0x213)]();}catch(_0x128953){console[_0x50189d(0x1a4)](_0x50189d(0x1ba),_0x128953);}},this[_0x368b92(0x1c2)]),console['log'](_0x368b92(0x1d9));}['stopPeriodicStatusCheck'](){const _0x4c0e20=a35_0x4f1536;this[_0x4c0e20(0x1a3)]&&(clearInterval(this[_0x4c0e20(0x1a3)]),this[_0x4c0e20(0x1a3)]=null,console['log'](_0x4c0e20(0x194)));}async[a35_0x4f1536(0x213)](){const _0x25af7d=a35_0x4f1536;try{const _0x169157=await database_1[_0x25af7d(0x1c3)][_0x25af7d(0x1a5)][_0x25af7d(0x1b0)]({'where':{'gateway':'cointopay','status':_0x25af7d(0x1ff),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x169157['length']===0x0){console['log'](_0x25af7d(0x1b8));return;}console[_0x25af7d(0x1cf)](_0x25af7d(0x201)+_0x169157[_0x25af7d(0x19c)]+_0x25af7d(0x21a));const _0xcc374d=await this[_0x25af7d(0x217)](_0x169157);console['log']('â°\x20Found\x20'+_0xcc374d[_0x25af7d(0x19c)]+_0x25af7d(0x206));for(const _0x59f262 of _0x169157){try{if(_0xcc374d['includes'](_0x59f262['id'])){console[_0x25af7d(0x1cf)](_0x25af7d(0x1dc)+_0x59f262['id']+_0x25af7d(0x1f8));continue;}await this[_0x25af7d(0x1e7)](_0x59f262),await new Promise(_0x5a5cf1=>setTimeout(_0x5a5cf1,0x7d0));}catch(_0x211de1){console[_0x25af7d(0x1a4)](_0x25af7d(0x1b9)+_0x59f262['id']+':',_0x211de1),loggerService_1[_0x25af7d(0x1e1)]['logWhiteDomainError'](_0x25af7d(0x190),_0x25af7d(0x208)+_0x59f262[_0x25af7d(0x1af)],_0x211de1);}}console['log']('âœ…\x20Completed\x20checking\x20'+_0x169157['length']+'\x20CoinToPay\x20payments');}catch(_0x59d3a7){console[_0x25af7d(0x1a4)](_0x25af7d(0x21b),_0x59d3a7);}}async[a35_0x4f1536(0x217)](_0x47d165){const _0x493755=a35_0x4f1536,_0x5627d8=[],_0x5d7066=new Date();_0x5d7066['setDate'](_0x5d7066[_0x493755(0x20e)]()-this[_0x493755(0x1b4)]),console[_0x493755(0x1cf)](_0x493755(0x1bb)+this['EXPIRY_DAYS']+_0x493755(0x1be)+_0x5d7066[_0x493755(0x1a1)]()+')');for(const _0x5b2f40 of _0x47d165){if(_0x5b2f40[_0x493755(0x1b6)]<_0x5d7066){console[_0x493755(0x1cf)](_0x493755(0x1dc)+_0x5b2f40['id']+_0x493755(0x192)+this[_0x493755(0x1b4)]+_0x493755(0x20d));try{await database_1['default'][_0x493755(0x1a5)][_0x493755(0x195)]({'where':{'id':_0x5b2f40['id']},'data':{'status':_0x493755(0x1a7),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this['EXPIRY_DAYS']+_0x493755(0x19f)}}),await database_1[_0x493755(0x1c3)][_0x493755(0x1da)][_0x493755(0x1d0)]({'data':{'paymentId':_0x5b2f40['id'],'shopId':_0x5b2f40[_0x493755(0x18f)],'event':_0x493755(0x1c5),'statusCode':0xc8,'responseBody':JSON[_0x493755(0x20f)]({'reason':_0x493755(0x1c4)+this[_0x493755(0x1b4)]+_0x493755(0x1b3),'createdAt':_0x5b2f40['createdAt'],'expiredAt':new Date()[_0x493755(0x1a1)](),'daysSinceCreation':Math[_0x493755(0x1e6)]((Date[_0x493755(0x1f4)]()-_0x5b2f40[_0x493755(0x1b6)][_0x493755(0x204)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x493755(0x216)](_0x5b2f40,'EXPIRED'),await this[_0x493755(0x1aa)](_0x5b2f40,_0x493755(0x1a7)),_0x5627d8[_0x493755(0x1a6)](_0x5b2f40['id']),console[_0x493755(0x1cf)](_0x493755(0x19d)+_0x5b2f40['id']+_0x493755(0x1b5)+this['EXPIRY_DAYS']+_0x493755(0x1b2));}catch(_0x552ab7){console['error'](_0x493755(0x19a)+_0x5b2f40['id']+':',_0x552ab7);}}}return _0x5627d8;}async[a35_0x4f1536(0x1e7)](_0x38959d){const _0x4ddb59=a35_0x4f1536;if(!_0x38959d[_0x4ddb59(0x1af)]){console[_0x4ddb59(0x1cf)]('âš ï¸\x20Payment\x20'+_0x38959d['id']+_0x4ddb59(0x1fa));return;}console[_0x4ddb59(0x1cf)]('ðŸ”\x20Checking\x20CoinToPay\x20payment\x20'+_0x38959d['id']+'\x20('+_0x38959d[_0x4ddb59(0x1af)]+')');try{const _0x56c705=await this['coinToPayService']['checkPaymentStatus'](_0x38959d[_0x4ddb59(0x1af)]);console['log'](_0x4ddb59(0x1b1)+_0x38959d['id']+_0x4ddb59(0x203)+_0x56c705['status']);_0x56c705[_0x4ddb59(0x210)]&&console[_0x4ddb59(0x1cf)](_0x4ddb59(0x1b1)+_0x38959d['id']+_0x4ddb59(0x1c7),{'iban':_0x56c705[_0x4ddb59(0x210)][_0x4ddb59(0x1f7)]||_0x4ddb59(0x193),'transactionId':_0x56c705[_0x4ddb59(0x210)][_0x4ddb59(0x1d5)],'createdOn':_0x56c705[_0x4ddb59(0x210)][_0x4ddb59(0x1e2)],'confirmedOn':_0x56c705[_0x4ddb59(0x210)][_0x4ddb59(0x1a2)]||_0x4ddb59(0x1c0)});if(_0x56c705[_0x4ddb59(0x1d6)]!==_0x38959d[_0x4ddb59(0x1d6)]){console[_0x4ddb59(0x1cf)]('ðŸ”„\x20Updating\x20payment\x20'+_0x38959d['id']+_0x4ddb59(0x1f2)+_0x38959d[_0x4ddb59(0x1d6)]+_0x4ddb59(0x199)+_0x56c705[_0x4ddb59(0x1d6)]);const _0x1c6e3f={'status':_0x56c705[_0x4ddb59(0x1d6)],'updatedAt':new Date()};_0x56c705[_0x4ddb59(0x1d6)]===_0x4ddb59(0x212)&&_0x38959d['status']!==_0x4ddb59(0x212)&&(_0x1c6e3f[_0x4ddb59(0x1dd)]=new Date(),console[_0x4ddb59(0x1cf)](_0x4ddb59(0x1ed)+_0x38959d['id']+_0x4ddb59(0x1f5)+_0x1c6e3f[_0x4ddb59(0x1dd)][_0x4ddb59(0x1a1)]()));if(_0x56c705[_0x4ddb59(0x210)]){const _0x41158d=_0x56c705['paymentDetails'];_0x41158d[_0x4ddb59(0x1f7)]&&(_0x1c6e3f[_0x4ddb59(0x1fd)]=_0x41158d[_0x4ddb59(0x1f7)],console[_0x4ddb59(0x1cf)](_0x4ddb59(0x1ce)+_0x41158d[_0x4ddb59(0x1f7)]));if(_0x41158d[_0x4ddb59(0x215)]){const _0x2fd28f=_0x38959d[_0x4ddb59(0x19b)]||'',_0x1d277f=_0x4ddb59(0x198)+_0x41158d[_0x4ddb59(0x215)];_0x1c6e3f[_0x4ddb59(0x19b)]=_0x2fd28f?_0x2fd28f+'\x0a\x0a'+_0x1d277f:_0x1d277f,console[_0x4ddb59(0x1cf)](_0x4ddb59(0x1e0));}_0x41158d['transactionId']&&console[_0x4ddb59(0x1cf)](_0x4ddb59(0x218)+_0x41158d[_0x4ddb59(0x1d5)]),_0x41158d['confirmedOn']&&console[_0x4ddb59(0x1cf)]('âœ…\x20Transaction\x20confirmed\x20on:\x20'+_0x41158d[_0x4ddb59(0x1a2)]);}await database_1[_0x4ddb59(0x1c3)][_0x4ddb59(0x1a5)][_0x4ddb59(0x195)]({'where':{'id':_0x38959d['id']},'data':_0x1c6e3f}),await database_1['default']['webhookLog'][_0x4ddb59(0x1d0)]({'data':{'paymentId':_0x38959d['id'],'shopId':_0x38959d[_0x4ddb59(0x18f)],'event':_0x4ddb59(0x1cc)+_0x56c705[_0x4ddb59(0x1d6)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x4ddb59(0x20f)]({'oldStatus':_0x38959d['status'],'newStatus':_0x56c705['status'],'paymentDetails':_0x56c705[_0x4ddb59(0x210)],'checkedAt':new Date()[_0x4ddb59(0x1a1)]()})}}),await this['sendShopWebhook'](_0x38959d,_0x56c705[_0x4ddb59(0x1d6)]),await this[_0x4ddb59(0x1aa)](_0x38959d,_0x56c705[_0x4ddb59(0x1d6)]),console[_0x4ddb59(0x1cf)](_0x4ddb59(0x19d)+_0x38959d['id']+_0x4ddb59(0x1fe));}else console[_0x4ddb59(0x1cf)](_0x4ddb59(0x1b1)+_0x38959d['id']+_0x4ddb59(0x202)+_0x56c705['status']+')');}catch(_0x3451af){console['error'](_0x4ddb59(0x1d3)+_0x38959d['id']+':',_0x3451af),await database_1['default'][_0x4ddb59(0x1da)][_0x4ddb59(0x1d0)]({'data':{'paymentId':_0x38959d['id'],'shopId':_0x38959d[_0x4ddb59(0x18f)],'event':_0x4ddb59(0x200),'statusCode':0x1f4,'responseBody':JSON[_0x4ddb59(0x20f)]({'error':_0x3451af instanceof Error?_0x3451af[_0x4ddb59(0x1c6)]:'Unknown\x20error','gatewayPaymentId':_0x38959d[_0x4ddb59(0x1af)],'checkedAt':new Date()[_0x4ddb59(0x1a1)]()})}});}}async[a35_0x4f1536(0x216)](_0x47707a,_0x5bc322){const _0x10d9f5=a35_0x4f1536,_0x2ad8c2=Date[_0x10d9f5(0x1f4)]();try{const _0x2237f3=_0x47707a[_0x10d9f5(0x197)],_0x51c8c6=_0x2237f3['settings'];if(!_0x51c8c6?.[_0x10d9f5(0x219)]){console['log'](_0x10d9f5(0x1e4)+_0x2237f3['id']);return;}const _0x533aa7=_0x5bc322===_0x10d9f5(0x212)?_0x10d9f5(0x1e5):_0x5bc322===_0x10d9f5(0x20a)?_0x10d9f5(0x1e3):_0x5bc322==='EXPIRED'?'payment.failed':_0x10d9f5(0x1d2);if(!_0x51c8c6[_0x10d9f5(0x1d7)]?.[_0x10d9f5(0x1de)](_0x533aa7)){console[_0x10d9f5(0x1cf)](_0x10d9f5(0x1a8)+_0x533aa7+_0x10d9f5(0x1f1)+_0x2237f3['id']);return;}const _0x4ed1c0={'event':_0x533aa7,'payment':{'id':_0x47707a['id'],'order_id':_0x47707a[_0x10d9f5(0x21e)],'gateway_order_id':_0x47707a['gatewayOrderId'],'gateway':_0x10d9f5(0x1c1),'amount':_0x47707a['amount'],'currency':_0x47707a[_0x10d9f5(0x1bd)],'status':_0x5bc322['toLowerCase'](),'customer_email':_0x47707a[_0x10d9f5(0x1f3)],'customer_name':_0x47707a[_0x10d9f5(0x1ef)],'created_at':_0x47707a['createdAt'],'updated_at':new Date()}},_0x2dcb7b=await fetch(_0x51c8c6[_0x10d9f5(0x219)],{'method':_0x10d9f5(0x20c),'headers':{'Content-Type':_0x10d9f5(0x1ad),'User-Agent':_0x10d9f5(0x1cb)},'body':JSON[_0x10d9f5(0x20f)](_0x4ed1c0)}),_0x5ab402=Date[_0x10d9f5(0x1f4)]()-_0x2ad8c2,_0x223499=_0x2dcb7b['ok']?_0x10d9f5(0x211):await _0x2dcb7b['text']();loggerService_1['loggerService'][_0x10d9f5(0x1fb)](_0x47707a['shopId'],_0x51c8c6[_0x10d9f5(0x219)],_0x533aa7,_0x2dcb7b[_0x10d9f5(0x1d6)],_0x5ab402,_0x4ed1c0),console[_0x10d9f5(0x1cf)](_0x10d9f5(0x21c)+_0x51c8c6[_0x10d9f5(0x219)]+_0x10d9f5(0x1ea)+_0x2dcb7b[_0x10d9f5(0x1d6)]+'\x20('+_0x5ab402+_0x10d9f5(0x1f9));}catch(_0x275f67){console[_0x10d9f5(0x1a4)](_0x10d9f5(0x20b),_0x275f67),loggerService_1[_0x10d9f5(0x1e1)]['logShopWebhookError'](_0x47707a[_0x10d9f5(0x18f)],_0x47707a[_0x10d9f5(0x197)]?.[_0x10d9f5(0x1d8)]?.[_0x10d9f5(0x219)]||'unknown','webhook_send',_0x275f67,{});}}async[a35_0x4f1536(0x1aa)](_0x5af557,_0x1c9bf2){const _0x2d16b8=a35_0x4f1536;try{const _0x334c1a={'PENDING':_0x2d16b8(0x191),'PAID':_0x2d16b8(0x1df),'FAILED':'failed','EXPIRED':_0x2d16b8(0x1ee)},_0x4c76ba=_0x334c1a[_0x1c9bf2];if(!_0x4c76ba||_0x4c76ba===_0x2d16b8(0x191))return;await telegramBotService_1[_0x2d16b8(0x1b7)][_0x2d16b8(0x196)](_0x5af557[_0x2d16b8(0x18f)],_0x5af557,_0x4c76ba);}catch(_0x4f3ce2){console['error'](_0x2d16b8(0x1c9),_0x4f3ce2);}}async['checkPaymentById'](_0x4ad4fb){const _0x4972b4=a35_0x4f1536,_0xed2c87=await database_1['default'][_0x4972b4(0x1a5)][_0x4972b4(0x1fc)]({'where':{'id':_0x4ad4fb},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xed2c87)throw new Error(_0x4972b4(0x1ab));if(_0xed2c87['gateway']!==_0x4972b4(0x190))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');await this[_0x4972b4(0x1e7)](_0xed2c87);}['getServiceStats'](){const _0x548b56=a35_0x4f1536,_0x3c9c42=this[_0x548b56(0x1a3)]?this[_0x548b56(0x1c2)]:undefined;return{'isActive':!!this[_0x548b56(0x1a3)],'checkIntervalMinutes':this[_0x548b56(0x1c2)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'nextCheckIn':_0x3c9c42};}}exports[a35_0x4f1536(0x1f6)]=CoinToPayStatusService,exports[a35_0x4f1536(0x19e)]=new CoinToPayStatusService();