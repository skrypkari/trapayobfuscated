'use strict';const a37_0x1aa879=a37_0x45ac;(function(_0x39ec78,_0x348edd){const _0x2a72f5=a37_0x45ac,_0xc40444=_0x39ec78();while(!![]){try{const _0x19d105=-parseInt(_0x2a72f5(0x12d))/0x1*(parseInt(_0x2a72f5(0xb4))/0x2)+parseInt(_0x2a72f5(0xb8))/0x3*(parseInt(_0x2a72f5(0x14d))/0x4)+-parseInt(_0x2a72f5(0x140))/0x5*(parseInt(_0x2a72f5(0xf9))/0x6)+-parseInt(_0x2a72f5(0x104))/0x7*(-parseInt(_0x2a72f5(0xed))/0x8)+parseInt(_0x2a72f5(0xbc))/0x9*(parseInt(_0x2a72f5(0xdf))/0xa)+parseInt(_0x2a72f5(0x92))/0xb*(parseInt(_0x2a72f5(0xbb))/0xc)+parseInt(_0x2a72f5(0x9a))/0xd*(-parseInt(_0x2a72f5(0xad))/0xe);if(_0x19d105===_0x348edd)break;else _0xc40444['push'](_0xc40444['shift']());}catch(_0x5eab10){_0xc40444['push'](_0xc40444['shift']());}}}(a37_0x4d69,0x7a490));function a37_0x45ac(_0x49428a,_0x169d20){const _0x4d69bd=a37_0x4d69();return a37_0x45ac=function(_0x45ac63,_0x4ce2ce){_0x45ac63=_0x45ac63-0x84;let _0x5ed06f=_0x4d69bd[_0x45ac63];return _0x5ed06f;},a37_0x45ac(_0x49428a,_0x169d20);}var __importDefault=this&&this[a37_0x1aa879(0xe3)]||function(_0x412554){const _0x5a0a9b=a37_0x1aa879;return _0x412554&&_0x412554[_0x5a0a9b(0x12e)]?_0x412554:{'default':_0x412554};};Object[a37_0x1aa879(0x14c)](exports,a37_0x1aa879(0x12e),{'value':!![]}),exports[a37_0x1aa879(0xa8)]=exports[a37_0x1aa879(0x159)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a37_0x1aa879(0x162))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a37_0x1aa879(0xd4));function a37_0x4d69(){const _0x38f171=['✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','__importDefault','FAILED','create','EXPIRY_DAYS','created','✅\x20[CHECK]\x20Payment\x20','amount','\x20not\x20found\x20in\x20database','\x20triggered\x20for\x20payment\x20','telegramBotService','263888ZENdyE','getTime','🧹\x20[CHECK]\x20Payment\x20','error','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20\x20\x20❌\x20Error:\x20','✅\x20[EXPIRY]\x20Payment\x20','Bank\x20Details:\x20','forEach','\x20(after\x20','description','paymentDetails','16650wECSBF','❌\x20[HOURLY]\x20Payment\x20','webhookLog','checkAllPendingPayments','gateway','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','gatewayOrderId','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','not\x20found','gatewayPaymentId','⏰\x20[HOURLY]\x20Payment\x20','77tUrXqw','\x20\x20\x20📍\x20Source:\x20','logCoinToPayStatus','now','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','⏰\x20[GLOBAL]\x20Payment\x20','Unknown\x20error','\x20is\x20too\x20new\x20(','Payment\x20not\x20found','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','default','\x20\x20\x20-\x20paymentId:\x20','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','customerEmail','PAID','5\x20minutes','getDate','\x20(age:\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','💰\x20[CHECK]\x20Payment\x20','schedule_created','coinToPayService','\x20\x20\x20-\x20GatewayPaymentId:\x20','loggerService','findMany','\x20skipped,\x20','confirmedOn','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','Webhook\x20event\x20','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','update','\x20\x20\x20-\x20gatewayPaymentId:\x20','status','webhook_send','getServiceStats','unknown','\x20to\x20','/status/','Shop\x20webhook\x20sent\x20to\x20','Success','2838owtjcE','__esModule','includes','checkSinglePaymentById','PENDING','Failed\x20to\x20mark\x20payment\x20as\x20expired','Automatically\x20expired\x20after\x20','values','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','status_check','logCoinToPayError','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','paidAt','payment.failed','\x20status\x20changed\x20to\x20','toLowerCase','logShopWebhookError','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','440NiOiqy','cointopay_status_check_error','📊\x20[CHECK]\x20Payment\x20','\x20days','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','createdAt','COINTOPAY_ERROR','size','Payment\x20older\x20than\x20','map','defineProperty','232fTtxLi','\x20days\x20without\x20payment\x20confirmation','settings','sendPaymentNotification','findUnique','stringify','🪙\x20CoinToPayStatusService\x20initialized','has','log','📊\x20[HOURLY]\x20Payment\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20->\x20','CoinToPayStatusService','webhookEvents','🪙\x20[GLOBAL]\x20Found\x20','text','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','❌\x20[CHECK]\x20Payment\x20','shop','checkExpiredPayments','\x20seconds\x20(','../config/database','adminNotes','logWhiteDomainError','\x20for\x20payment\x20','application/json','payment','customerName','message','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','sendShopWebhook','globalCheckInterval','webhookUrl','\x20in\x20','COINTOPAY_STATUS_CHANGE','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','cointopay_status_check_','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','startPeriodicStatusCheck','floor','bankDetails','\x20individual\x20payment\x20timers','60049uSisdg','paymentId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','delay','getPaymentTimerInfo','GLOBAL_CHECK_INTERVAL_MS','\x20\x20\x20📅\x20Time:\x20','cointopay','338WIWutq','shopId','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','paymentTimers','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','\x20updated\x20successfully','\x20\x20\x20📝\x20Details:','EXPIRED','get','auto_expire','.\x20Remaining\x20active\x20timers:\x20','push','⚠️\x20[CHECK]\x20Payment\x20','from','coinToPayStatusService','\x20initial\x20timers\x20for\x20payment\x20','payment.pending','\x20checked,\x20','\x20days,\x20marking\x20as\x20EXPIRED','996058yTppmk','checkSinglePayment','\x20has\x20no\x20gatewayPaymentId','delete','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','currency','schedulePaymentChecks','286iTBaoH','\x20expired','🔄\x20[CHECK]\x20Updating\x20payment\x20','TesSoft\x20Payment\x20System/1.0','38985lMQSmK','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20',',\x20stopping\x20individual\x20checks','2076mPVGSn','8457957qXGSMg','\x20status\x20is\x20','set','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','not\x20confirmed','createdOn','\x20has\x20no\x20gatewayPaymentId,\x20skipping','stack','cointopay_auto_expired','checkPaymentById','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','iban','Failed\x20to\x20send\x20shop\x20webhook:','length','remitterIban','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','toFixed','\x20pending\x20CoinToPay\x20payments','transactionId','\x20found:','\x20\x20\x20-\x20ShopId:\x20','\x20is\x20older\x20than\x20','timestamp','./loggerService','🧹\x20[DEBUG]\x20Clearing\x20','\x20\x20\x20-\x20Gateway:\x20','\x20with\x20status\x20','\x20marked\x20as\x20paid\x20at:\x20','timers','clearPaymentTimers','✅\x20[HOURLY]\x20Payment\x20','toISOString','\x20timers\x20for\x20payment\x20','\x20details:','10WvFwsU','sendPaymentStatusNotification','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...'];a37_0x4d69=function(){return _0x38f171;};return a37_0x4d69();}class CoinToPayStatusService{constructor(){const _0x58b53f=a37_0x1aa879;this['globalCheckInterval']=null,this[_0x58b53f(0x97)]=0x3c*0x3c*0x3e8,this[_0x58b53f(0xe6)]=0x5,this[_0x58b53f(0x9d)]=new Map(),this['coinToPayService']=new coinToPayService_1['CoinToPayService'](),console[_0x58b53f(0x155)](_0x58b53f(0x153));}[a37_0x1aa879(0xb3)](_0x466be8,_0x57cf74){const _0x269f54=a37_0x1aa879;console[_0x269f54(0x155)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x269f54(0x155)](_0x269f54(0x10f)+_0x466be8),console[_0x269f54(0x155)](_0x269f54(0x124)+_0x57cf74),this[_0x269f54(0xda)](_0x466be8);const _0x455aa6=[],_0x116cb1=new Date(),_0x3c832e=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x269f54(0x113)},{'delay':0x5*0x3c*0x3e8,'description':_0x269f54(0x113)}];console[_0x269f54(0x155)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x3c832e[_0x269f54(0xca)]+_0x269f54(0xa9)+_0x466be8);let _0x3d3e3e=0x0;_0x3c832e[_0x269f54(0xf5)]((_0x346054,_0x5ab135)=>{const _0x761af=_0x269f54;_0x3d3e3e+=_0x346054[_0x761af(0x95)];const _0xebc0ad=setTimeout(async()=>{const _0x55190a=_0x761af;console[_0x55190a(0x155)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x5ab135+0x1)+_0x55190a(0xeb)+_0x466be8+_0x55190a(0xf6)+_0x346054['description']+')');try{await this['checkSinglePaymentById'](_0x466be8),console[_0x55190a(0x155)](_0x55190a(0x116)+(_0x5ab135+0x1)+'\x20completed\x20for\x20payment\x20'+_0x466be8);}catch(_0x26b730){console[_0x55190a(0xf0)](_0x55190a(0x9e)+(_0x5ab135+0x1)+_0x55190a(0x165)+_0x466be8+':',_0x26b730),this[_0x55190a(0x138)](_0x466be8,_0x57cf74,_0x26b730,_0x55190a(0x137),{'checkNumber':_0x5ab135+0x1,'scheduledAfter':_0x346054[_0x55190a(0xf7)],'isIndividualCheck':!![]});}},_0x3d3e3e);_0x455aa6[_0x761af(0xa5)](_0xebc0ad),console[_0x761af(0x155)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x5ab135+0x1)+_0x761af(0x165)+_0x466be8+_0x761af(0x89)+_0x3d3e3e/0x3e8+_0x761af(0x161)+_0x346054[_0x761af(0xf7)]+')');});const _0x2488fb=setInterval(async()=>{const _0x5a8770=_0x269f54;console[_0x5a8770(0x155)](_0x5a8770(0x120)+_0x466be8);try{const _0x141580=await database_1[_0x5a8770(0x10e)][_0x5a8770(0x167)][_0x5a8770(0x151)]({'where':{'id':_0x466be8},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x141580){console[_0x5a8770(0x155)](_0x5a8770(0xfa)+_0x466be8+'\x20not\x20found,\x20clearing\x20timers'),this[_0x5a8770(0xda)](_0x466be8);return;}console[_0x5a8770(0x155)](_0x5a8770(0x156)+_0x466be8+'\x20current\x20status:\x20'+_0x141580[_0x5a8770(0x125)]);if(_0x141580['status']!=='PENDING'){console['log'](_0x5a8770(0xdb)+_0x466be8+_0x5a8770(0xbd)+_0x141580[_0x5a8770(0x125)]+',\x20stopping\x20individual\x20checks'),this[_0x5a8770(0xda)](_0x466be8);return;}const _0x7ce90c=Math['floor']((Date[_0x5a8770(0x107)]()-_0x141580[_0x5a8770(0x147)][_0x5a8770(0xee)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x7ce90c>=this[_0x5a8770(0xe6)]){console[_0x5a8770(0x155)](_0x5a8770(0x103)+_0x466be8+_0x5a8770(0xd2)+this[_0x5a8770(0xe6)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this['clearPaymentTimers'](_0x466be8);return;}await this[_0x5a8770(0x130)](_0x466be8),console[_0x5a8770(0x155)](_0x5a8770(0xe2)+_0x466be8);}catch(_0x15a0e1){console[_0x5a8770(0xf0)](_0x5a8770(0x108)+_0x466be8+':',_0x15a0e1),this['logCoinToPayError'](_0x466be8,_0x57cf74,_0x15a0e1,_0x5a8770(0x137),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x455aa6[_0x269f54(0xa5)](_0x2488fb),this[_0x269f54(0x9d)][_0x269f54(0xbe)](_0x466be8,{'timers':_0x455aa6,'paymentId':_0x466be8,'gatewayPaymentId':_0x57cf74,'createdAt':_0x116cb1}),console[_0x269f54(0x155)](_0x269f54(0x144)+_0x3c832e[_0x269f54(0xca)]+_0x269f54(0x136)+_0x466be8),console[_0x269f54(0x155)](_0x269f54(0x157)+this['paymentTimers']['size']),this[_0x269f54(0x106)](_0x466be8,_0x57cf74,_0x269f54(0x131),_0x269f54(0x131),_0x269f54(0x137),{'action':_0x269f54(0x118),'scheduledChecks':_0x3c832e[_0x269f54(0xca)],'firstCheckIn':_0x3c832e[0x0][_0x269f54(0x95)]/0x3e8,'totalTimers':this[_0x269f54(0x9d)][_0x269f54(0x149)]});}[a37_0x1aa879(0xda)](_0x35f6f1){const _0x33cc59=a37_0x1aa879,_0x1618f8=this[_0x33cc59(0x9d)][_0x33cc59(0xa2)](_0x35f6f1);_0x1618f8?(console['log'](_0x33cc59(0xd5)+_0x1618f8['timers']['length']+_0x33cc59(0xdd)+_0x35f6f1),_0x1618f8[_0x33cc59(0xd9)]['forEach']((_0x3399cd,_0x2ce205)=>{const _0x4d43ac=_0x33cc59;_0x3399cd&&(clearTimeout(_0x3399cd),clearInterval(_0x3399cd),console[_0x4d43ac(0x155)]('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x2ce205+0x1)+'\x20for\x20payment\x20'+_0x35f6f1));}),this['paymentTimers'][_0x33cc59(0xb0)](_0x35f6f1),console[_0x33cc59(0x155)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x35f6f1+_0x33cc59(0xa4)+this[_0x33cc59(0x9d)][_0x33cc59(0x149)])):console['log'](_0x33cc59(0xb9)+_0x35f6f1+'\x20to\x20clear');}async[a37_0x1aa879(0x130)](_0x150495){const _0x59f507=a37_0x1aa879;console[_0x59f507(0x155)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x150495);const _0x50d68c=await database_1[_0x59f507(0x10e)][_0x59f507(0x167)][_0x59f507(0x151)]({'where':{'id':_0x150495},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x50d68c){console[_0x59f507(0x155)](_0x59f507(0x15e)+_0x150495+_0x59f507(0xea));return;}console[_0x59f507(0x155)](_0x59f507(0x142)+_0x150495+_0x59f507(0xd0)),console['log'](_0x59f507(0xd6)+_0x50d68c[_0x59f507(0xfd)]),console[_0x59f507(0x155)]('\x20\x20\x20-\x20Status:\x20'+_0x50d68c[_0x59f507(0x125)]),console[_0x59f507(0x155)](_0x59f507(0x11a)+_0x50d68c[_0x59f507(0x102)]),console[_0x59f507(0x155)]('\x20\x20\x20-\x20Amount:\x20'+_0x50d68c[_0x59f507(0xe9)]+'\x20'+_0x50d68c[_0x59f507(0xb2)]),console['log'](_0x59f507(0xd1)+_0x50d68c[_0x59f507(0x9b)]);if(_0x50d68c['gateway']!==_0x59f507(0x99)){console[_0x59f507(0x155)](_0x59f507(0xa6)+_0x150495+_0x59f507(0xc7)+_0x50d68c['gateway']+')');return;}if(_0x50d68c[_0x59f507(0x125)]!==_0x59f507(0x131)){console[_0x59f507(0x155)](_0x59f507(0xa6)+_0x150495+'\x20status\x20is\x20'+_0x50d68c['status']+_0x59f507(0xba)),this[_0x59f507(0xda)](_0x150495);return;}if(!_0x50d68c[_0x59f507(0x102)]){console[_0x59f507(0x155)](_0x59f507(0xa6)+_0x150495+_0x59f507(0xaf));return;}console[_0x59f507(0x155)](_0x59f507(0xe8)+_0x150495+_0x59f507(0x135)),await this[_0x59f507(0xae)](_0x50d68c);}['logCoinToPayStatus'](_0x388ad1,_0x139a74,_0x1b586c,_0x4adc51,_0x420a99,_0x369740){const _0x1d3603=a37_0x1aa879,_0x2828da={'type':_0x1d3603(0x8a),'paymentId':_0x388ad1,'gatewayPaymentId':_0x139a74,'oldStatus':_0x1b586c,'newStatus':_0x4adc51,'source':_0x420a99,'timestamp':new Date()[_0x1d3603(0xdc)](),'details':_0x369740||{}};loggerService_1[_0x1d3603(0x11b)]['logCoinToPayStatus'](_0x2828da),console['log']('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x388ad1+'\x20('+_0x139a74+')'),console[_0x1d3603(0x155)]('\x20\x20\x20📊\x20Status:\x20'+_0x1b586c+_0x1d3603(0x158)+_0x4adc51),console[_0x1d3603(0x155)](_0x1d3603(0x105)+_0x420a99),console[_0x1d3603(0x155)](_0x1d3603(0x98)+_0x2828da[_0x1d3603(0xd3)]),_0x369740&&console[_0x1d3603(0x155)](_0x1d3603(0xa0),_0x369740);}[a37_0x1aa879(0x138)](_0x1cbb35,_0x48d55c,_0xd5e21e,_0xa6909,_0x16ac9f){const _0x1c3e8b=a37_0x1aa879,_0x2b9a8e={'type':_0x1c3e8b(0x148),'paymentId':_0x1cbb35,'gatewayPaymentId':_0x48d55c,'error':_0xd5e21e instanceof Error?{'message':_0xd5e21e[_0x1c3e8b(0x84)],'stack':_0xd5e21e[_0x1c3e8b(0xc3)]}:_0xd5e21e,'source':_0xa6909,'timestamp':new Date()['toISOString'](),'context':_0x16ac9f||{}};loggerService_1[_0x1c3e8b(0x11b)]['logCoinToPayError'](_0x2b9a8e),console[_0x1c3e8b(0xf0)](_0x1c3e8b(0x146)+_0x1cbb35+'\x20('+_0x48d55c+')'),console['error'](_0x1c3e8b(0xf2)+(_0xd5e21e instanceof Error?_0xd5e21e[_0x1c3e8b(0x84)]:_0xd5e21e)),console[_0x1c3e8b(0xf0)](_0x1c3e8b(0x105)+_0xa6909),console[_0x1c3e8b(0xf0)](_0x1c3e8b(0x98)+_0x2b9a8e[_0x1c3e8b(0xd3)]),_0x16ac9f&&console['error']('\x20\x20\x20📝\x20Context:',_0x16ac9f);}[a37_0x1aa879(0x8e)](){const _0x387958=a37_0x1aa879;console[_0x387958(0x155)]('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x387958(0xfc)]()['catch'](_0x105542=>{const _0x3abe51=_0x387958;console[_0x3abe51(0xf0)]('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x105542);}),this['globalCheckInterval']=setInterval(async()=>{const _0x26a0cd=_0x387958;try{console[_0x26a0cd(0x155)]('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x26a0cd(0xfc)](),console[_0x26a0cd(0x155)](_0x26a0cd(0x110));}catch(_0x1e6620){console['error'](_0x26a0cd(0xb1),_0x1e6620);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x387958(0x155)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}['stopPeriodicStatusCheck'](){const _0xd6b8c6=a37_0x1aa879;console[_0xd6b8c6(0x155)](_0xd6b8c6(0xc6));this[_0xd6b8c6(0x87)]&&(clearInterval(this[_0xd6b8c6(0x87)]),this['globalCheckInterval']=null,console[_0xd6b8c6(0x155)](_0xd6b8c6(0x122)));const _0x4dcd5a=this['paymentTimers'][_0xd6b8c6(0x149)];for(const [_0x4cbec3]of this['paymentTimers']){this['clearPaymentTimers'](_0x4cbec3);}console['log']('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x4dcd5a+_0xd6b8c6(0x91));}async[a37_0x1aa879(0xfc)](){const _0x2fbdea=a37_0x1aa879;try{console[_0x2fbdea(0x155)](_0x2fbdea(0xe1));const _0x335b70=await database_1['default']['payment'][_0x2fbdea(0x11c)]({'where':{'gateway':_0x2fbdea(0x99),'status':_0x2fbdea(0x131),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x2fbdea(0x155)](_0x2fbdea(0x15b)+_0x335b70[_0x2fbdea(0xca)]+_0x2fbdea(0xce));if(_0x335b70[_0x2fbdea(0xca)]===0x0){console[_0x2fbdea(0x155)](_0x2fbdea(0x85));return;}const _0x5c6f46=await this[_0x2fbdea(0x160)](_0x335b70);console['log']('⏰\x20[GLOBAL]\x20Found\x20'+_0x5c6f46[_0x2fbdea(0xca)]+'\x20expired\x20CoinToPay\x20payments');let _0x4f86a1=0x0,_0x2206a3=0x0;for(const _0x2b2ee4 of _0x335b70){try{if(_0x5c6f46['includes'](_0x2b2ee4['id'])){console[_0x2fbdea(0x155)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x2b2ee4['id']+_0x2fbdea(0x100)),_0x2206a3++;continue;}if(this[_0x2fbdea(0x9d)][_0x2fbdea(0x154)](_0x2b2ee4['id'])){console[_0x2fbdea(0x155)](_0x2fbdea(0x109)+_0x2b2ee4['id']+_0x2fbdea(0xcc)),_0x2206a3++;continue;}const _0x545563=(Date[_0x2fbdea(0x107)]()-_0x2b2ee4[_0x2fbdea(0x147)][_0x2fbdea(0xee)]())/(0x3e8*0x3c*0x3c);if(_0x545563<0x1){console['log'](_0x2fbdea(0x109)+_0x2b2ee4['id']+_0x2fbdea(0x10b)+_0x545563[_0x2fbdea(0xcd)](0x1)+'h),\x20skipping\x20global\x20check'),_0x2206a3++;continue;}console[_0x2fbdea(0x155)](_0x2fbdea(0x8d)+_0x2b2ee4['id']+_0x2fbdea(0x115)+_0x545563[_0x2fbdea(0xcd)](0x1)+'h)'),await this[_0x2fbdea(0xae)](_0x2b2ee4),_0x4f86a1++,await new Promise(_0x578356=>setTimeout(_0x578356,0x7d0));}catch(_0x4b0ef5){console[_0x2fbdea(0xf0)](_0x2fbdea(0x139)+_0x2b2ee4['id']+':',_0x4b0ef5),this[_0x2fbdea(0x138)](_0x2b2ee4['id'],_0x2b2ee4[_0x2fbdea(0x102)]||_0x2fbdea(0x128),_0x4b0ef5,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x2b2ee4['amount'],'paymentCurrency':_0x2b2ee4[_0x2fbdea(0xb2)],'shopId':_0x2b2ee4['shopId'],'createdAt':_0x2b2ee4[_0x2fbdea(0x147)]}),loggerService_1['loggerService'][_0x2fbdea(0x164)](_0x2fbdea(0x99),_0x2fbdea(0x12a)+_0x2b2ee4['gatewayPaymentId'],_0x4b0ef5);}}console[_0x2fbdea(0x155)]('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x4f86a1+_0x2fbdea(0xab)+_0x2206a3+_0x2fbdea(0x11d)+_0x5c6f46[_0x2fbdea(0xca)]+_0x2fbdea(0xb5));}catch(_0xb54a5e){console[_0x2fbdea(0xf0)]('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0xb54a5e);}}async[a37_0x1aa879(0x160)](_0x305fee){const _0xc65f51=a37_0x1aa879,_0x24f225=[],_0x26c8c0=new Date();_0x26c8c0['setDate'](_0x26c8c0[_0xc65f51(0x114)]()-this[_0xc65f51(0xe6)]),console[_0xc65f51(0x155)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0xc65f51(0xe6)]+'\x20days\x20(created\x20before\x20'+_0x26c8c0[_0xc65f51(0xdc)]()+')');for(const _0x508571 of _0x305fee){if(_0x508571[_0xc65f51(0x147)]<_0x26c8c0){console[_0xc65f51(0x155)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x508571['id']+_0xc65f51(0xd2)+this['EXPIRY_DAYS']+_0xc65f51(0xac));try{this[_0xc65f51(0x106)](_0x508571['id'],_0x508571['gatewayPaymentId']||'unknown',_0xc65f51(0x131),'EXPIRED',_0xc65f51(0xa3),{'reason':_0xc65f51(0x14a)+this[_0xc65f51(0xe6)]+'\x20days','createdAt':_0x508571[_0xc65f51(0x147)],'daysSinceCreation':Math[_0xc65f51(0x8f)]((Date[_0xc65f51(0x107)]()-_0x508571[_0xc65f51(0x147)][_0xc65f51(0xee)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x508571[_0xc65f51(0xe9)],'paymentCurrency':_0x508571[_0xc65f51(0xb2)],'shopId':_0x508571[_0xc65f51(0x9b)]}),await database_1['default']['payment'][_0xc65f51(0x123)]({'where':{'id':_0x508571['id']},'data':{'status':_0xc65f51(0xa1),'updatedAt':new Date(),'adminNotes':_0xc65f51(0x133)+this[_0xc65f51(0xe6)]+_0xc65f51(0x14e)}}),await database_1[_0xc65f51(0x10e)][_0xc65f51(0xfb)][_0xc65f51(0xe5)]({'data':{'paymentId':_0x508571['id'],'shopId':_0x508571['shopId'],'event':_0xc65f51(0xc4),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0xc65f51(0x143),'createdAt':_0x508571[_0xc65f51(0x147)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math['floor']((Date[_0xc65f51(0x107)]()-_0x508571[_0xc65f51(0x147)][_0xc65f51(0xee)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0xc65f51(0x86)](_0x508571,'EXPIRED'),await this[_0xc65f51(0xe0)](_0x508571,_0xc65f51(0xa1)),this[_0xc65f51(0xda)](_0x508571['id']),_0x24f225[_0xc65f51(0xa5)](_0x508571['id']),console[_0xc65f51(0x155)](_0xc65f51(0xf3)+_0x508571['id']+_0xc65f51(0xfe)+this[_0xc65f51(0xe6)]+'-day\x20timeout');}catch(_0x350fb6){console[_0xc65f51(0xf0)](_0xc65f51(0x15d)+_0x508571['id']+':',_0x350fb6),this['logCoinToPayError'](_0x508571['id'],_0x508571[_0xc65f51(0x102)]||_0xc65f51(0x128),_0x350fb6,'auto_expire',{'reason':_0xc65f51(0x132),'createdAt':_0x508571[_0xc65f51(0x147)],'daysSinceCreation':Math[_0xc65f51(0x8f)]((Date[_0xc65f51(0x107)]()-_0x508571['createdAt'][_0xc65f51(0xee)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x24f225;}async[a37_0x1aa879(0xae)](_0x567353){const _0x2ca472=a37_0x1aa879;if(!_0x567353[_0x2ca472(0x102)]){console[_0x2ca472(0x155)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x567353['id']+_0x2ca472(0xc2));return;}console['log']('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x567353['id']+'\x20('+_0x567353[_0x2ca472(0x102)]+')');try{const _0x111d30=await this[_0x2ca472(0x119)]['checkPaymentStatus'](_0x567353['gatewayPaymentId']);console[_0x2ca472(0x155)](_0x2ca472(0x142)+_0x567353['id']+'\x20status:\x20'+_0x111d30[_0x2ca472(0x125)]);_0x111d30[_0x2ca472(0xf8)]&&console[_0x2ca472(0x155)](_0x2ca472(0x142)+_0x567353['id']+_0x2ca472(0xde),{'iban':_0x111d30[_0x2ca472(0xf8)][_0x2ca472(0xc8)]||_0x2ca472(0x101),'transactionId':_0x111d30[_0x2ca472(0xf8)][_0x2ca472(0xcf)],'createdOn':_0x111d30[_0x2ca472(0xf8)][_0x2ca472(0xc1)],'confirmedOn':_0x111d30[_0x2ca472(0xf8)][_0x2ca472(0x11e)]||_0x2ca472(0xc0)});if(_0x111d30[_0x2ca472(0x125)]!==_0x567353[_0x2ca472(0x125)]){console[_0x2ca472(0x155)](_0x2ca472(0xb6)+_0x567353['id']+'\x20status\x20from\x20'+_0x567353['status']+_0x2ca472(0x129)+_0x111d30[_0x2ca472(0x125)]),this['logCoinToPayStatus'](_0x567353['id'],_0x567353[_0x2ca472(0x102)],_0x567353['status'],_0x111d30[_0x2ca472(0x125)],_0x2ca472(0x137),{'paymentDetails':_0x111d30['paymentDetails'],'amount':_0x111d30[_0x2ca472(0xe9)],'currency':_0x111d30[_0x2ca472(0xb2)],'shopId':_0x567353['shopId'],'checkTimestamp':new Date()['toISOString']()});const _0x4dea11={'status':_0x111d30[_0x2ca472(0x125)],'updatedAt':new Date()};_0x111d30[_0x2ca472(0x125)]===_0x2ca472(0x112)&&_0x567353[_0x2ca472(0x125)]!==_0x2ca472(0x112)&&(_0x4dea11[_0x2ca472(0x13a)]=new Date(),console[_0x2ca472(0x155)](_0x2ca472(0x117)+_0x567353['id']+_0x2ca472(0xd8)+_0x4dea11[_0x2ca472(0x13a)][_0x2ca472(0xdc)]()));if(_0x111d30['paymentDetails']){const _0x4b7d3d=_0x111d30[_0x2ca472(0xf8)];_0x4b7d3d[_0x2ca472(0xc8)]&&(_0x4dea11[_0x2ca472(0xcb)]=_0x4b7d3d[_0x2ca472(0xc8)],console[_0x2ca472(0x155)](_0x2ca472(0xbf)+_0x4b7d3d[_0x2ca472(0xc8)]));if(_0x4b7d3d[_0x2ca472(0x90)]){const _0x35c22a=_0x567353[_0x2ca472(0x163)]||'',_0x28f68c=_0x2ca472(0xf4)+_0x4b7d3d['bankDetails'];_0x4dea11['adminNotes']=_0x35c22a?_0x35c22a+'\x0a\x0a'+_0x28f68c:_0x28f68c,console[_0x2ca472(0x155)](_0x2ca472(0x145));}_0x4b7d3d['transactionId']&&console[_0x2ca472(0x155)](_0x2ca472(0x10d)+_0x4b7d3d[_0x2ca472(0xcf)]),_0x4b7d3d['confirmedOn']&&console[_0x2ca472(0x155)](_0x2ca472(0x9c)+_0x4b7d3d[_0x2ca472(0x11e)]);}await database_1['default'][_0x2ca472(0x167)][_0x2ca472(0x123)]({'where':{'id':_0x567353['id']},'data':_0x4dea11}),await database_1[_0x2ca472(0x10e)][_0x2ca472(0xfb)][_0x2ca472(0xe5)]({'data':{'paymentId':_0x567353['id'],'shopId':_0x567353[_0x2ca472(0x9b)],'event':_0x2ca472(0x8c)+_0x111d30[_0x2ca472(0x125)][_0x2ca472(0x13d)](),'statusCode':0xc8,'responseBody':JSON[_0x2ca472(0x152)]({'oldStatus':_0x567353[_0x2ca472(0x125)],'newStatus':_0x111d30[_0x2ca472(0x125)],'paymentDetails':_0x111d30[_0x2ca472(0xf8)],'checkedAt':new Date()[_0x2ca472(0xdc)]()})}}),await this[_0x2ca472(0x86)](_0x567353,_0x111d30['status']),await this['sendPaymentStatusNotification'](_0x567353,_0x111d30['status']),_0x111d30[_0x2ca472(0x125)]!==_0x2ca472(0x131)&&(console[_0x2ca472(0x155)](_0x2ca472(0xef)+_0x567353['id']+_0x2ca472(0x13c)+_0x111d30[_0x2ca472(0x125)]+',\x20clearing\x20individual\x20timers'),this[_0x2ca472(0xda)](_0x567353['id'])),console['log'](_0x2ca472(0xe8)+_0x567353['id']+_0x2ca472(0x9f));}else console[_0x2ca472(0x155)](_0x2ca472(0x142)+_0x567353['id']+'\x20status\x20unchanged\x20('+_0x111d30['status']+')'),this[_0x2ca472(0x106)](_0x567353['id'],_0x567353[_0x2ca472(0x102)],_0x567353[_0x2ca472(0x125)],_0x111d30[_0x2ca472(0x125)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x111d30[_0x2ca472(0xf8)],'amount':_0x111d30[_0x2ca472(0xe9)],'currency':_0x111d30[_0x2ca472(0xb2)],'shopId':_0x567353[_0x2ca472(0x9b)],'checkTimestamp':new Date()[_0x2ca472(0xdc)]()});}catch(_0xc12d7c){console[_0x2ca472(0xf0)]('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x567353['id']+':',_0xc12d7c),this['logCoinToPayError'](_0x567353['id'],_0x567353[_0x2ca472(0x102)],_0xc12d7c,_0x2ca472(0x137),{'paymentAmount':_0x567353[_0x2ca472(0xe9)],'paymentCurrency':_0x567353[_0x2ca472(0xb2)],'shopId':_0x567353[_0x2ca472(0x9b)],'createdAt':_0x567353[_0x2ca472(0x147)]}),await database_1[_0x2ca472(0x10e)][_0x2ca472(0xfb)][_0x2ca472(0xe5)]({'data':{'paymentId':_0x567353['id'],'shopId':_0x567353[_0x2ca472(0x9b)],'event':_0x2ca472(0x141),'statusCode':0x1f4,'responseBody':JSON[_0x2ca472(0x152)]({'error':_0xc12d7c instanceof Error?_0xc12d7c[_0x2ca472(0x84)]:_0x2ca472(0x10a),'gatewayPaymentId':_0x567353['gatewayPaymentId'],'checkedAt':new Date()[_0x2ca472(0xdc)]()})}});}}async[a37_0x1aa879(0x86)](_0x4f2c8d,_0x55bf71){const _0xc2da3c=a37_0x1aa879,_0x4e935c=Date[_0xc2da3c(0x107)]();try{const _0x21f41e=_0x4f2c8d['shop'],_0x50d35d=_0x21f41e[_0xc2da3c(0x14f)];if(!_0x50d35d?.[_0xc2da3c(0x88)]){console[_0xc2da3c(0x155)](_0xc2da3c(0x94)+_0x21f41e['id']);return;}const _0x466c2f=_0x55bf71==='PAID'?'payment.success':_0x55bf71===_0xc2da3c(0xe4)?_0xc2da3c(0x13b):_0x55bf71==='EXPIRED'?_0xc2da3c(0x13b):_0xc2da3c(0xaa);if(!_0x50d35d[_0xc2da3c(0x15a)]?.[_0xc2da3c(0x12f)](_0x466c2f)){console[_0xc2da3c(0x155)](_0xc2da3c(0x121)+_0x466c2f+'\x20not\x20enabled\x20for\x20shop\x20'+_0x21f41e['id']);return;}const _0x486397={'event':_0x466c2f,'payment':{'id':_0x4f2c8d['id'],'order_id':_0x4f2c8d['orderId'],'gateway_order_id':_0x4f2c8d[_0xc2da3c(0xff)],'gateway':'0100','amount':_0x4f2c8d[_0xc2da3c(0xe9)],'currency':_0x4f2c8d[_0xc2da3c(0xb2)],'status':_0x55bf71[_0xc2da3c(0x13d)](),'customer_email':_0x4f2c8d[_0xc2da3c(0x111)],'customer_name':_0x4f2c8d[_0xc2da3c(0x168)],'created_at':_0x4f2c8d[_0xc2da3c(0x147)],'updated_at':new Date()}},_0x18bc5c=await fetch(_0x50d35d[_0xc2da3c(0x88)],{'method':'POST','headers':{'Content-Type':_0xc2da3c(0x166),'User-Agent':_0xc2da3c(0xb7)},'body':JSON[_0xc2da3c(0x152)](_0x486397)}),_0x1995d8=Date['now']()-_0x4e935c,_0x52e87b=_0x18bc5c['ok']?_0xc2da3c(0x12c):await _0x18bc5c[_0xc2da3c(0x15c)]();loggerService_1[_0xc2da3c(0x11b)]['logShopWebhookSent'](_0x4f2c8d[_0xc2da3c(0x9b)],_0x50d35d[_0xc2da3c(0x88)],_0x466c2f,_0x18bc5c[_0xc2da3c(0x125)],_0x1995d8,_0x486397),console[_0xc2da3c(0x155)](_0xc2da3c(0x12b)+_0x50d35d[_0xc2da3c(0x88)]+_0xc2da3c(0xd7)+_0x18bc5c[_0xc2da3c(0x125)]+'\x20('+_0x1995d8+'ms)');}catch(_0x12c84a){console[_0xc2da3c(0xf0)](_0xc2da3c(0xc9),_0x12c84a),loggerService_1[_0xc2da3c(0x11b)][_0xc2da3c(0x13e)](_0x4f2c8d[_0xc2da3c(0x9b)],_0x4f2c8d[_0xc2da3c(0x15f)]?.[_0xc2da3c(0x14f)]?.[_0xc2da3c(0x88)]||_0xc2da3c(0x128),_0xc2da3c(0x126),_0x12c84a,{});}}async[a37_0x1aa879(0xe0)](_0x24b063,_0x24f939){const _0x185fe1=a37_0x1aa879;try{const _0x5ec2e6={'PENDING':_0x185fe1(0xe7),'PAID':'paid','FAILED':'failed','EXPIRED':'expired'},_0x193feb=_0x5ec2e6[_0x24f939];if(!_0x193feb||_0x193feb===_0x185fe1(0xe7))return;await telegramBotService_1[_0x185fe1(0xec)][_0x185fe1(0x150)](_0x24b063[_0x185fe1(0x9b)],_0x24b063,_0x193feb);}catch(_0x5a3b4a){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x5a3b4a);}}async[a37_0x1aa879(0xc5)](_0x375f99){const _0x51f851=a37_0x1aa879;console['log'](_0x51f851(0x13f)+_0x375f99);const _0x332f03=await database_1[_0x51f851(0x10e)][_0x51f851(0x167)][_0x51f851(0x151)]({'where':{'id':_0x375f99},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x332f03)throw new Error(_0x51f851(0x10c));if(_0x332f03[_0x51f851(0xfd)]!==_0x51f851(0x99))throw new Error(_0x51f851(0x8b));console[_0x51f851(0x155)](_0x51f851(0xf1)+_0x375f99),await this['checkSinglePayment'](_0x332f03),console[_0x51f851(0x155)](_0x51f851(0x11f)+_0x375f99);}[a37_0x1aa879(0x127)](){const _0x484a27=a37_0x1aa879,_0x2887b2=this[_0x484a27(0x87)]?this[_0x484a27(0x97)]:undefined,_0x814caa=Array[_0x484a27(0xa7)](this[_0x484a27(0x9d)][_0x484a27(0x134)]())[_0x484a27(0x14b)](_0x2a09d2=>({'paymentId':_0x2a09d2[_0x484a27(0x93)],'gatewayPaymentId':_0x2a09d2[_0x484a27(0x102)],'createdAt':_0x2a09d2[_0x484a27(0x147)],'timersCount':_0x2a09d2[_0x484a27(0xd9)][_0x484a27(0xca)]}));return{'isActive':!!this[_0x484a27(0x87)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x484a27(0xe6)],'activeIndividualTimers':this[_0x484a27(0x9d)]['size'],'nextGlobalCheckIn':_0x2887b2,'paymentTimersDetails':_0x814caa};}[a37_0x1aa879(0x96)](_0x5b77d2){const _0x39d6fe=a37_0x1aa879,_0x4028f3=this[_0x39d6fe(0x9d)][_0x39d6fe(0xa2)](_0x5b77d2);if(_0x4028f3)return{'hasTimers':!![],'timersCount':_0x4028f3[_0x39d6fe(0xd9)][_0x39d6fe(0xca)],'createdAt':_0x4028f3[_0x39d6fe(0x147)],'gatewayPaymentId':_0x4028f3['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a37_0x1aa879(0x159)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();