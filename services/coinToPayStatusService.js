'use strict';const a37_0x3c18a6=a37_0xd277;(function(_0x5c7b62,_0x4be2e4){const _0x414c61=a37_0xd277,_0x9e6555=_0x5c7b62();while(!![]){try{const _0x21127a=parseInt(_0x414c61(0x1b7))/0x1+-parseInt(_0x414c61(0x134))/0x2+-parseInt(_0x414c61(0x183))/0x3+-parseInt(_0x414c61(0x178))/0x4*(-parseInt(_0x414c61(0x1d5))/0x5)+-parseInt(_0x414c61(0x1ac))/0x6*(parseInt(_0x414c61(0x1d4))/0x7)+parseInt(_0x414c61(0x186))/0x8+parseInt(_0x414c61(0x149))/0x9;if(_0x21127a===_0x4be2e4)break;else _0x9e6555['push'](_0x9e6555['shift']());}catch(_0xf8ba6b){_0x9e6555['push'](_0x9e6555['shift']());}}}(a37_0x1771,0xb055b));function a37_0x1771(){const _0x2cded8=['4927153GKvXxW','25hnbuKm','✅\x20[EXPIRY]\x20Payment\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20\x20\x20📝\x20Context:','📊\x20[CHECK]\x20Payment\x20','push','application/json','\x20is\x20older\x20than\x20','unknown','gateway','globalCheckInterval','\x20\x20\x20📊\x20Status:\x20','✅\x20[CHECK]\x20Payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','\x20seconds\x20(','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','TesSoft\x20Payment\x20System/1.0','\x20initial\x20timers\x20for\x20payment\x20','0100',',\x20stopping\x20individual\x20checks','size','sendPaymentStatusNotification','webhookEvents','logWhiteDomainError','\x20status\x20changed\x20to\x20','payment.pending','COINTOPAY_ERROR','cointopay','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','startPeriodicStatusCheck','status','logShopWebhookSent','\x20\x20\x20-\x20Amount:\x20','floor','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','EXPIRY_DAYS','\x20to\x20','\x20skipped,\x20','createdAt','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20(age:\x20','GLOBAL_CHECK_INTERVAL_MS','⚠️\x20[CHECK]\x20Payment\x20','set','timestamp','description','🧹\x20[DEBUG]\x20Clearing\x20','stringify','toFixed','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','checkSinglePayment','includes','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','📊\x20[HOURLY]\x20Payment\x20','./loggerService','bankDetails','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','.\x20Remaining\x20active\x20timers:\x20','\x20expired\x20CoinToPay\x20payments','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','./gateways/coinToPayService','forEach','checkExpiredPayments','loggerService','length','1100254xRUYeg','\x20is\x20valid\x20for\x20checking,\x20proceeding...','from','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','5\x20minutes','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Success','-day\x20timeout','findUnique','🪙\x20[DEBUG]\x20Creating\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','update','./telegramBotService','values','/status/','gatewayOrderId','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','clearPaymentTimers','\x20\x20\x20-\x20ShopId:\x20','\x20expired','13956930JCtrBg','\x20->\x20','\x20completed\x20for\x20payment\x20','\x20\x20\x20📍\x20Source:\x20','1\x20minute','iban','customerEmail','✅\x20[TIMER]\x20Individual\x20check\x20#','getServiceStats','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20with\x20status\x20','h),\x20skipping\x20global\x20check','Automatically\x20expired\x20after\x20','\x20\x20\x20-\x20Status:\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','Payment\x20not\x20found','\x20for\x20payment\x20','logShopWebhookError','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','COINTOPAY_STATUS_CHANGE','webhook_send','now','createdOn','failed','❌\x20[CHECK]\x20Payment\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','text','🪙\x20CoinToPayStatusService\x20initialized','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','create','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','getDate','FAILED','status_check','created','\x20\x20\x20-\x20Gateway:\x20','\x20\x20\x20-\x20paymentId:\x20','\x20status:\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','PENDING','Payment\x20older\x20than\x20','CoinToPayService','\x20in\x20','delete','gatewayPaymentId','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','logCoinToPayError','558764dOVfvy','paymentDetails','checkAllPendingPayments','log','cointopay_status_check_','webhookLog','shop','adminNotes','defineProperty','\x20status\x20from\x20','PAID','2074719DaBNEM','coinToPayService','message','2047744uJBiGL','EXPIRED','catch','CoinToPayStatusService','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','transactionId','\x20found:','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','__esModule','coinToPayStatusService','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','currency','\x20pending\x20CoinToPay\x20payments','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','toISOString','\x20status\x20is\x20','Shop\x20webhook\x20sent\x20to\x20','checkPaymentById','get','🛑\x20[SHUTDOWN]\x20Cleared\x20','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20(after\x20','\x20has\x20no\x20gatewayPaymentId','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','../config/database','remitterIban','auto_expire','❌\x20[HOURLY]\x20Payment\x20','⏰\x20[GLOBAL]\x20Found\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','🪙\x20[GLOBAL]\x20Found\x20','⏰\x20[GLOBAL]\x20Payment\x20','confirmedOn','payment','\x20\x20\x20❌\x20Error:\x20','sendShopWebhook','\x20\x20\x20📅\x20Time:\x20','\x20checked,\x20','12kVwFtW','\x20details:','orderId','logCoinToPayStatus','cointopay_auto_expired','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','webhookUrl','Bank\x20Details:\x20','getPaymentTimerInfo','not\x20found','checkSinglePaymentById','866532sIXNkA','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','payment.failed','stack','paidAt','getTime','🪙\x20[TIMER]\x20Individual\x20check\x20#','\x20not\x20found,\x20clearing\x20timers','shopId','error','telegramBotService','stopPeriodicStatusCheck','\x20not\x20enabled\x20for\x20shop\x20','amount','\x20updated\x20successfully','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','paymentTimers','__importDefault','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','✅\x20[HOURLY]\x20Payment\x20','Webhook\x20event\x20','default','\x20not\x20found\x20in\x20database','schedule_created','timers','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20days\x20without\x20payment\x20confirmation'];a37_0x1771=function(){return _0x2cded8;};return a37_0x1771();}var __importDefault=this&&this[a37_0x3c18a6(0x1c8)]||function(_0x4aaaec){const _0x3b756c=a37_0x3c18a6;return _0x4aaaec&&_0x4aaaec[_0x3b756c(0x18e)]?_0x4aaaec:{'default':_0x4aaaec};};Object[a37_0x3c18a6(0x180)](exports,a37_0x3c18a6(0x18e),{'value':!![]}),exports[a37_0x3c18a6(0x18f)]=exports[a37_0x3c18a6(0x189)]=void 0x0;function a37_0xd277(_0x2611d3,_0x4c94e1){const _0x177125=a37_0x1771();return a37_0xd277=function(_0xd277cc,_0x405de3){_0xd277cc=_0xd277cc-0xf6;let _0x2b2c54=_0x177125[_0xd277cc];return _0x2b2c54;},a37_0xd277(_0x2611d3,_0x4c94e1);}const coinToPayService_1=require(a37_0x3c18a6(0x12f)),database_1=__importDefault(require(a37_0x3c18a6(0x19e))),telegramBotService_1=require(a37_0x3c18a6(0x141)),loggerService_1=require(a37_0x3c18a6(0x127));class CoinToPayStatusService{constructor(){const _0x27f88a=a37_0x3c18a6;this[_0x27f88a(0xfa)]=null,this[_0x27f88a(0x11a)]=0x3c*0x3c*0x3e8,this[_0x27f88a(0x114)]=0x5,this[_0x27f88a(0x1c7)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x27f88a(0x172))](),console[_0x27f88a(0x17b)](_0x27f88a(0x164));}['schedulePaymentChecks'](_0x5f420f,_0x4ca6e2){const _0x3bea45=a37_0x3c18a6;console['log'](_0x3bea45(0x1b1)),console['log'](_0x3bea45(0x16d)+_0x5f420f),console[_0x3bea45(0x17b)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x4ca6e2),this['clearPaymentTimers'](_0x5f420f);const _0x53c1e8=[],_0x363591=new Date(),_0x2ce580=[{'delay':0x1*0x3c*0x3e8,'description':_0x3bea45(0x14d)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x3bea45(0x138)},{'delay':0x5*0x3c*0x3e8,'description':_0x3bea45(0x138)}];console[_0x3bea45(0x17b)](_0x3bea45(0x13d)+_0x2ce580['length']+_0x3bea45(0x101)+_0x5f420f);let _0x26b007=0x0;_0x2ce580['forEach']((_0x5c24d8,_0x771c7c)=>{const _0x3f8b46=_0x3bea45;_0x26b007+=_0x5c24d8['delay'];const _0x27a5fc=setTimeout(async()=>{const _0x4fe5f2=a37_0xd277;console[_0x4fe5f2(0x17b)](_0x4fe5f2(0x1bd)+(_0x771c7c+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x5f420f+_0x4fe5f2(0x19b)+_0x5c24d8['description']+')');try{await this[_0x4fe5f2(0x1b6)](_0x5f420f),console[_0x4fe5f2(0x17b)](_0x4fe5f2(0x150)+(_0x771c7c+0x1)+_0x4fe5f2(0x14b)+_0x5f420f);}catch(_0x500211){console[_0x4fe5f2(0x1c0)]('❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x771c7c+0x1)+_0x4fe5f2(0x159)+_0x5f420f+':',_0x500211),this[_0x4fe5f2(0x177)](_0x5f420f,_0x4ca6e2,_0x500211,_0x4fe5f2(0x16a),{'checkNumber':_0x771c7c+0x1,'scheduledAfter':_0x5c24d8[_0x4fe5f2(0x11e)],'isIndividualCheck':!![]});}},_0x26b007);_0x53c1e8[_0x3f8b46(0x1da)](_0x27a5fc),console[_0x3f8b46(0x17b)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x771c7c+0x1)+_0x3f8b46(0x159)+_0x5f420f+_0x3f8b46(0x173)+_0x26b007/0x3e8+_0x3f8b46(0xfe)+_0x5c24d8['description']+')');});const _0x4bb152=setInterval(async()=>{const _0x29420f=_0x3bea45;console['log'](_0x29420f(0x16f)+_0x5f420f);try{const _0x5cae44=await database_1[_0x29420f(0x1cc)][_0x29420f(0x1a7)][_0x29420f(0x13c)]({'where':{'id':_0x5f420f},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x5cae44){console[_0x29420f(0x17b)](_0x29420f(0x1a1)+_0x5f420f+_0x29420f(0x1be)),this[_0x29420f(0x146)](_0x5f420f);return;}console[_0x29420f(0x17b)](_0x29420f(0x126)+_0x5f420f+'\x20current\x20status:\x20'+_0x5cae44[_0x29420f(0x10f)]);if(_0x5cae44[_0x29420f(0x10f)]!=='PENDING'){console['log'](_0x29420f(0x1ca)+_0x5f420f+_0x29420f(0x195)+_0x5cae44['status']+_0x29420f(0x103)),this[_0x29420f(0x146)](_0x5f420f);return;}const _0x4c39ef=Math['floor']((Date[_0x29420f(0x15e)]()-_0x5cae44[_0x29420f(0x117)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x4c39ef>=this['EXPIRY_DAYS']){console[_0x29420f(0x17b)]('⏰\x20[HOURLY]\x20Payment\x20'+_0x5f420f+_0x29420f(0xf7)+this[_0x29420f(0x114)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x29420f(0x146)](_0x5f420f);return;}await this[_0x29420f(0x1b6)](_0x5f420f),console['log'](_0x29420f(0x118)+_0x5f420f);}catch(_0x265fbd){console['error'](_0x29420f(0x152)+_0x5f420f+':',_0x265fbd),this[_0x29420f(0x177)](_0x5f420f,_0x4ca6e2,_0x265fbd,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x53c1e8[_0x3bea45(0x1da)](_0x4bb152),this[_0x3bea45(0x1c7)][_0x3bea45(0x11c)](_0x5f420f,{'timers':_0x53c1e8,'paymentId':_0x5f420f,'gatewayPaymentId':_0x4ca6e2,'createdAt':_0x363591}),console[_0x3bea45(0x17b)](_0x3bea45(0x125)+_0x2ce580[_0x3bea45(0x133)]+_0x3bea45(0xff)+_0x5f420f),console[_0x3bea45(0x17b)](_0x3bea45(0x1d2)+this[_0x3bea45(0x1c7)][_0x3bea45(0x104)]),this[_0x3bea45(0x1af)](_0x5f420f,_0x4ca6e2,_0x3bea45(0x170),_0x3bea45(0x170),_0x3bea45(0x16a),{'action':_0x3bea45(0x1ce),'scheduledChecks':_0x2ce580[_0x3bea45(0x133)],'firstCheckIn':_0x2ce580[0x0]['delay']/0x3e8,'totalTimers':this[_0x3bea45(0x1c7)][_0x3bea45(0x104)]});}[a37_0x3c18a6(0x146)](_0x324f86){const _0x49139d=a37_0x3c18a6,_0xbda4c6=this[_0x49139d(0x1c7)]['get'](_0x324f86);_0xbda4c6?(console[_0x49139d(0x17b)](_0x49139d(0x11f)+_0xbda4c6[_0x49139d(0x1cf)]['length']+'\x20timers\x20for\x20payment\x20'+_0x324f86),_0xbda4c6[_0x49139d(0x1cf)][_0x49139d(0x130)]((_0x4dbfac,_0x8dcd06)=>{const _0x51b5da=_0x49139d;_0x4dbfac&&(clearTimeout(_0x4dbfac),clearInterval(_0x4dbfac),console[_0x51b5da(0x17b)](_0x51b5da(0x18a)+(_0x8dcd06+0x1)+_0x51b5da(0x159)+_0x324f86));}),this['paymentTimers'][_0x49139d(0x174)](_0x324f86),console[_0x49139d(0x17b)](_0x49139d(0x122)+_0x324f86+_0x49139d(0x12a)+this[_0x49139d(0x1c7)][_0x49139d(0x104)])):console['log'](_0x49139d(0x10d)+_0x324f86+'\x20to\x20clear');}async[a37_0x3c18a6(0x1b6)](_0x5d545c){const _0xb34a32=a37_0x3c18a6;console[_0xb34a32(0x17b)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x5d545c);const _0xddc59=await database_1['default'][_0xb34a32(0x1a7)][_0xb34a32(0x13c)]({'where':{'id':_0x5d545c},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xddc59){console[_0xb34a32(0x17b)](_0xb34a32(0x161)+_0x5d545c+_0xb34a32(0x1cd));return;}console[_0xb34a32(0x17b)](_0xb34a32(0x1d9)+_0x5d545c+_0xb34a32(0x18c)),console[_0xb34a32(0x17b)](_0xb34a32(0x16c)+_0xddc59[_0xb34a32(0xf9)]),console[_0xb34a32(0x17b)](_0xb34a32(0x156)+_0xddc59[_0xb34a32(0x10f)]),console[_0xb34a32(0x17b)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0xddc59[_0xb34a32(0x175)]),console[_0xb34a32(0x17b)](_0xb34a32(0x111)+_0xddc59[_0xb34a32(0x1c4)]+'\x20'+_0xddc59['currency']),console[_0xb34a32(0x17b)](_0xb34a32(0x147)+_0xddc59[_0xb34a32(0x1bf)]);if(_0xddc59[_0xb34a32(0xf9)]!==_0xb34a32(0x10b)){console['log'](_0xb34a32(0x11b)+_0x5d545c+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0xddc59[_0xb34a32(0xf9)]+')');return;}if(_0xddc59[_0xb34a32(0x10f)]!==_0xb34a32(0x170)){console[_0xb34a32(0x17b)](_0xb34a32(0x11b)+_0x5d545c+_0xb34a32(0x195)+_0xddc59[_0xb34a32(0x10f)]+_0xb34a32(0x103)),this[_0xb34a32(0x146)](_0x5d545c);return;}if(!_0xddc59[_0xb34a32(0x175)]){console[_0xb34a32(0x17b)](_0xb34a32(0x11b)+_0x5d545c+_0xb34a32(0x19c));return;}console['log'](_0xb34a32(0xfc)+_0x5d545c+_0xb34a32(0x135)),await this['checkSinglePayment'](_0xddc59);}[a37_0x3c18a6(0x1af)](_0x24596a,_0x2e8d7d,_0x45fe94,_0x4908b8,_0x262df3,_0x39b873){const _0xb4d68d=a37_0x3c18a6,_0x5bd6eb={'type':_0xb4d68d(0x15c),'paymentId':_0x24596a,'gatewayPaymentId':_0x2e8d7d,'oldStatus':_0x45fe94,'newStatus':_0x4908b8,'source':_0x262df3,'timestamp':new Date()[_0xb4d68d(0x194)](),'details':_0x39b873||{}};loggerService_1[_0xb4d68d(0x132)][_0xb4d68d(0x1af)](_0x5bd6eb),console[_0xb4d68d(0x17b)](_0xb4d68d(0x12d)+_0x24596a+'\x20('+_0x2e8d7d+')'),console['log'](_0xb4d68d(0xfb)+_0x45fe94+_0xb4d68d(0x14a)+_0x4908b8),console[_0xb4d68d(0x17b)](_0xb4d68d(0x14c)+_0x262df3),console[_0xb4d68d(0x17b)](_0xb4d68d(0x1aa)+_0x5bd6eb[_0xb4d68d(0x11d)]),_0x39b873&&console[_0xb4d68d(0x17b)]('\x20\x20\x20📝\x20Details:',_0x39b873);}[a37_0x3c18a6(0x177)](_0x1fa41c,_0x4e3b87,_0x3195d4,_0x28773b,_0x47dc73){const _0x64a323=a37_0x3c18a6,_0xd95f75={'type':_0x64a323(0x10a),'paymentId':_0x1fa41c,'gatewayPaymentId':_0x4e3b87,'error':_0x3195d4 instanceof Error?{'message':_0x3195d4['message'],'stack':_0x3195d4[_0x64a323(0x1ba)]}:_0x3195d4,'source':_0x28773b,'timestamp':new Date()[_0x64a323(0x194)](),'context':_0x47dc73||{}};loggerService_1[_0x64a323(0x132)][_0x64a323(0x177)](_0xd95f75),console['error'](_0x64a323(0x145)+_0x1fa41c+'\x20('+_0x4e3b87+')'),console[_0x64a323(0x1c0)](_0x64a323(0x1a8)+(_0x3195d4 instanceof Error?_0x3195d4[_0x64a323(0x185)]:_0x3195d4)),console['error'](_0x64a323(0x14c)+_0x28773b),console[_0x64a323(0x1c0)]('\x20\x20\x20📅\x20Time:\x20'+_0xd95f75[_0x64a323(0x11d)]),_0x47dc73&&console[_0x64a323(0x1c0)](_0x64a323(0x1d8),_0x47dc73);}[a37_0x3c18a6(0x10e)](){const _0x1dd579=a37_0x3c18a6;console[_0x1dd579(0x17b)](_0x1dd579(0x137)),this[_0x1dd579(0x17a)]()[_0x1dd579(0x188)](_0x4cf7f8=>{const _0x57f54c=_0x1dd579;console['error'](_0x57f54c(0x12e),_0x4cf7f8);}),this[_0x1dd579(0xfa)]=setInterval(async()=>{const _0x4c6f03=_0x1dd579;try{console[_0x4c6f03(0x17b)](_0x4c6f03(0x19d)),await this[_0x4c6f03(0x17a)](),console[_0x4c6f03(0x17b)](_0x4c6f03(0x19a));}catch(_0x43fff1){console['error'](_0x4c6f03(0x113),_0x43fff1);}},this[_0x1dd579(0x11a)]),console['log'](_0x1dd579(0x1d1));}[a37_0x3c18a6(0x1c2)](){const _0x43f5a3=a37_0x3c18a6;console[_0x43f5a3(0x17b)](_0x43f5a3(0x13f));this['globalCheckInterval']&&(clearInterval(this[_0x43f5a3(0xfa)]),this[_0x43f5a3(0xfa)]=null,console[_0x43f5a3(0x17b)]('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x57afd5=this[_0x43f5a3(0x1c7)][_0x43f5a3(0x104)];for(const [_0x5cde3f]of this[_0x43f5a3(0x1c7)]){this[_0x43f5a3(0x146)](_0x5cde3f);}console[_0x43f5a3(0x17b)](_0x43f5a3(0x199)+_0x57afd5+'\x20individual\x20payment\x20timers');}async[a37_0x3c18a6(0x17a)](){const _0x172f3b=a37_0x3c18a6;try{console[_0x172f3b(0x17b)](_0x172f3b(0x1d7));const _0x48fcfe=await database_1[_0x172f3b(0x1cc)][_0x172f3b(0x1a7)]['findMany']({'where':{'gateway':_0x172f3b(0x10b),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x172f3b(0x17b)](_0x172f3b(0x1a4)+_0x48fcfe[_0x172f3b(0x133)]+_0x172f3b(0x192));if(_0x48fcfe[_0x172f3b(0x133)]===0x0){console['log'](_0x172f3b(0x165));return;}const _0x526af1=await this[_0x172f3b(0x131)](_0x48fcfe);console[_0x172f3b(0x17b)](_0x172f3b(0x1a2)+_0x526af1[_0x172f3b(0x133)]+_0x172f3b(0x12b));let _0x3beaad=0x0,_0x331397=0x0;for(const _0x1fbac1 of _0x48fcfe){try{if(_0x526af1[_0x172f3b(0x124)](_0x1fbac1['id'])){console['log'](_0x172f3b(0x1a5)+_0x1fbac1['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x331397++;continue;}if(this[_0x172f3b(0x1c7)]['has'](_0x1fbac1['id'])){console[_0x172f3b(0x17b)](_0x172f3b(0x1a5)+_0x1fbac1['id']+_0x172f3b(0x176)),_0x331397++;continue;}const _0xb7e8b2=(Date[_0x172f3b(0x15e)]()-_0x1fbac1[_0x172f3b(0x117)][_0x172f3b(0x1bc)]())/(0x3e8*0x3c*0x3c);if(_0xb7e8b2<0x1){console[_0x172f3b(0x17b)](_0x172f3b(0x1a5)+_0x1fbac1['id']+'\x20is\x20too\x20new\x20('+_0xb7e8b2[_0x172f3b(0x121)](0x1)+_0x172f3b(0x154)),_0x331397++;continue;}console[_0x172f3b(0x17b)](_0x172f3b(0x1a3)+_0x1fbac1['id']+_0x172f3b(0x119)+_0xb7e8b2[_0x172f3b(0x121)](0x1)+'h)'),await this[_0x172f3b(0x123)](_0x1fbac1),_0x3beaad++,await new Promise(_0xc5d7b3=>setTimeout(_0xc5d7b3,0x7d0));}catch(_0x533150){console[_0x172f3b(0x1c0)](_0x172f3b(0x1d0)+_0x1fbac1['id']+':',_0x533150),this['logCoinToPayError'](_0x1fbac1['id'],_0x1fbac1[_0x172f3b(0x175)]||'unknown',_0x533150,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x1fbac1[_0x172f3b(0x1c4)],'paymentCurrency':_0x1fbac1[_0x172f3b(0x191)],'shopId':_0x1fbac1[_0x172f3b(0x1bf)],'createdAt':_0x1fbac1[_0x172f3b(0x117)]}),loggerService_1['loggerService'][_0x172f3b(0x107)]('cointopay',_0x172f3b(0x143)+_0x1fbac1['gatewayPaymentId'],_0x533150);}}console['log'](_0x172f3b(0x190)+_0x3beaad+_0x172f3b(0x1ab)+_0x331397+_0x172f3b(0x116)+_0x526af1[_0x172f3b(0x133)]+_0x172f3b(0x148));}catch(_0x162a0c){console[_0x172f3b(0x1c0)](_0x172f3b(0x18d),_0x162a0c);}}async['checkExpiredPayments'](_0x58d0ed){const _0x45bc1b=a37_0x3c18a6,_0x9f3353=[],_0x1bb5e6=new Date();_0x1bb5e6['setDate'](_0x1bb5e6[_0x45bc1b(0x168)]()-this['EXPIRY_DAYS']),console[_0x45bc1b(0x17b)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days\x20(created\x20before\x20'+_0x1bb5e6[_0x45bc1b(0x194)]()+')');for(const _0x140340 of _0x58d0ed){if(_0x140340['createdAt']<_0x1bb5e6){console[_0x45bc1b(0x17b)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x140340['id']+'\x20is\x20older\x20than\x20'+this[_0x45bc1b(0x114)]+_0x45bc1b(0xfd));try{this[_0x45bc1b(0x1af)](_0x140340['id'],_0x140340[_0x45bc1b(0x175)]||_0x45bc1b(0xf8),_0x45bc1b(0x170),'EXPIRED',_0x45bc1b(0x1a0),{'reason':_0x45bc1b(0x171)+this[_0x45bc1b(0x114)]+'\x20days','createdAt':_0x140340[_0x45bc1b(0x117)],'daysSinceCreation':Math[_0x45bc1b(0x112)]((Date['now']()-_0x140340['createdAt'][_0x45bc1b(0x1bc)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x140340[_0x45bc1b(0x1c4)],'paymentCurrency':_0x140340['currency'],'shopId':_0x140340['shopId']}),await database_1[_0x45bc1b(0x1cc)][_0x45bc1b(0x1a7)][_0x45bc1b(0x140)]({'where':{'id':_0x140340['id']},'data':{'status':_0x45bc1b(0x187),'updatedAt':new Date(),'adminNotes':_0x45bc1b(0x155)+this[_0x45bc1b(0x114)]+_0x45bc1b(0x1d3)}}),await database_1['default'][_0x45bc1b(0x17d)][_0x45bc1b(0x166)]({'data':{'paymentId':_0x140340['id'],'shopId':_0x140340['shopId'],'event':_0x45bc1b(0x1b0),'statusCode':0xc8,'responseBody':JSON[_0x45bc1b(0x120)]({'reason':'Payment\x20older\x20than\x20'+this[_0x45bc1b(0x114)]+'\x20days','createdAt':_0x140340[_0x45bc1b(0x117)],'expiredAt':new Date()[_0x45bc1b(0x194)](),'daysSinceCreation':Math[_0x45bc1b(0x112)]((Date['now']()-_0x140340[_0x45bc1b(0x117)][_0x45bc1b(0x1bc)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x45bc1b(0x1a9)](_0x140340,_0x45bc1b(0x187)),await this[_0x45bc1b(0x105)](_0x140340,_0x45bc1b(0x187)),this['clearPaymentTimers'](_0x140340['id']),_0x9f3353[_0x45bc1b(0x1da)](_0x140340['id']),console[_0x45bc1b(0x17b)](_0x45bc1b(0x1d6)+_0x140340['id']+_0x45bc1b(0x167)+this[_0x45bc1b(0x114)]+_0x45bc1b(0x13b));}catch(_0x1a124d){console['error'](_0x45bc1b(0x1c6)+_0x140340['id']+':',_0x1a124d),this[_0x45bc1b(0x177)](_0x140340['id'],_0x140340['gatewayPaymentId']||_0x45bc1b(0xf8),_0x1a124d,_0x45bc1b(0x1a0),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x140340[_0x45bc1b(0x117)],'daysSinceCreation':Math[_0x45bc1b(0x112)]((Date[_0x45bc1b(0x15e)]()-_0x140340[_0x45bc1b(0x117)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x9f3353;}async['checkSinglePayment'](_0xf87388){const _0x44c92d=a37_0x3c18a6;if(!_0xf87388[_0x44c92d(0x175)]){console[_0x44c92d(0x17b)](_0x44c92d(0x11b)+_0xf87388['id']+_0x44c92d(0x162));return;}console['log']('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0xf87388['id']+'\x20('+_0xf87388[_0x44c92d(0x175)]+')');try{const _0x3db22e=await this[_0x44c92d(0x184)]['checkPaymentStatus'](_0xf87388['gatewayPaymentId']);console[_0x44c92d(0x17b)](_0x44c92d(0x1d9)+_0xf87388['id']+_0x44c92d(0x16e)+_0x3db22e['status']);_0x3db22e['paymentDetails']&&console['log'](_0x44c92d(0x1d9)+_0xf87388['id']+_0x44c92d(0x1ad),{'iban':_0x3db22e[_0x44c92d(0x179)][_0x44c92d(0x14e)]||_0x44c92d(0x1b5),'transactionId':_0x3db22e[_0x44c92d(0x179)][_0x44c92d(0x18b)],'createdOn':_0x3db22e[_0x44c92d(0x179)][_0x44c92d(0x15f)],'confirmedOn':_0x3db22e[_0x44c92d(0x179)][_0x44c92d(0x1a6)]||'not\x20confirmed'});if(_0x3db22e[_0x44c92d(0x10f)]!==_0xf87388['status']){console[_0x44c92d(0x17b)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0xf87388['id']+_0x44c92d(0x181)+_0xf87388[_0x44c92d(0x10f)]+_0x44c92d(0x115)+_0x3db22e[_0x44c92d(0x10f)]),this['logCoinToPayStatus'](_0xf87388['id'],_0xf87388['gatewayPaymentId'],_0xf87388[_0x44c92d(0x10f)],_0x3db22e['status'],_0x44c92d(0x16a),{'paymentDetails':_0x3db22e[_0x44c92d(0x179)],'amount':_0x3db22e[_0x44c92d(0x1c4)],'currency':_0x3db22e[_0x44c92d(0x191)],'shopId':_0xf87388[_0x44c92d(0x1bf)],'checkTimestamp':new Date()[_0x44c92d(0x194)]()});const _0x2fba6a={'status':_0x3db22e[_0x44c92d(0x10f)],'updatedAt':new Date()};_0x3db22e[_0x44c92d(0x10f)]===_0x44c92d(0x182)&&_0xf87388[_0x44c92d(0x10f)]!==_0x44c92d(0x182)&&(_0x2fba6a[_0x44c92d(0x1bb)]=new Date(),console['log']('💰\x20[CHECK]\x20Payment\x20'+_0xf87388['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x2fba6a[_0x44c92d(0x1bb)]['toISOString']()));if(_0x3db22e[_0x44c92d(0x179)]){const _0x26ef58=_0x3db22e['paymentDetails'];_0x26ef58['iban']&&(_0x2fba6a[_0x44c92d(0x19f)]=_0x26ef58[_0x44c92d(0x14e)],console[_0x44c92d(0x17b)](_0x44c92d(0x1b8)+_0x26ef58[_0x44c92d(0x14e)]));if(_0x26ef58[_0x44c92d(0x128)]){const _0x3788e9=_0xf87388[_0x44c92d(0x17f)]||'',_0x349fc5=_0x44c92d(0x1b3)+_0x26ef58['bankDetails'];_0x2fba6a[_0x44c92d(0x17f)]=_0x3788e9?_0x3788e9+'\x0a\x0a'+_0x349fc5:_0x349fc5,console[_0x44c92d(0x17b)](_0x44c92d(0x10c));}_0x26ef58[_0x44c92d(0x18b)]&&console[_0x44c92d(0x17b)](_0x44c92d(0x13e)+_0x26ef58[_0x44c92d(0x18b)]),_0x26ef58[_0x44c92d(0x1a6)]&&console[_0x44c92d(0x17b)](_0x44c92d(0x12c)+_0x26ef58[_0x44c92d(0x1a6)]);}await database_1['default'][_0x44c92d(0x1a7)][_0x44c92d(0x140)]({'where':{'id':_0xf87388['id']},'data':_0x2fba6a}),await database_1[_0x44c92d(0x1cc)][_0x44c92d(0x17d)][_0x44c92d(0x166)]({'data':{'paymentId':_0xf87388['id'],'shopId':_0xf87388[_0x44c92d(0x1bf)],'event':_0x44c92d(0x17c)+_0x3db22e['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0xf87388[_0x44c92d(0x10f)],'newStatus':_0x3db22e[_0x44c92d(0x10f)],'paymentDetails':_0x3db22e[_0x44c92d(0x179)],'checkedAt':new Date()[_0x44c92d(0x194)]()})}}),await this[_0x44c92d(0x1a9)](_0xf87388,_0x3db22e[_0x44c92d(0x10f)]),await this[_0x44c92d(0x105)](_0xf87388,_0x3db22e[_0x44c92d(0x10f)]),_0x3db22e[_0x44c92d(0x10f)]!==_0x44c92d(0x170)&&(console[_0x44c92d(0x17b)]('🧹\x20[CHECK]\x20Payment\x20'+_0xf87388['id']+_0x44c92d(0x108)+_0x3db22e[_0x44c92d(0x10f)]+',\x20clearing\x20individual\x20timers'),this['clearPaymentTimers'](_0xf87388['id'])),console[_0x44c92d(0x17b)](_0x44c92d(0xfc)+_0xf87388['id']+_0x44c92d(0x1c5));}else console[_0x44c92d(0x17b)](_0x44c92d(0x1d9)+_0xf87388['id']+'\x20status\x20unchanged\x20('+_0x3db22e['status']+')'),this[_0x44c92d(0x1af)](_0xf87388['id'],_0xf87388[_0x44c92d(0x175)],_0xf87388[_0x44c92d(0x10f)],_0x3db22e[_0x44c92d(0x10f)],_0x44c92d(0x16a),{'statusUnchanged':!![],'paymentDetails':_0x3db22e[_0x44c92d(0x179)],'amount':_0x3db22e[_0x44c92d(0x1c4)],'currency':_0x3db22e[_0x44c92d(0x191)],'shopId':_0xf87388['shopId'],'checkTimestamp':new Date()[_0x44c92d(0x194)]()});}catch(_0x464409){console[_0x44c92d(0x1c0)](_0x44c92d(0x15b)+_0xf87388['id']+':',_0x464409),this['logCoinToPayError'](_0xf87388['id'],_0xf87388['gatewayPaymentId'],_0x464409,_0x44c92d(0x16a),{'paymentAmount':_0xf87388[_0x44c92d(0x1c4)],'paymentCurrency':_0xf87388[_0x44c92d(0x191)],'shopId':_0xf87388['shopId'],'createdAt':_0xf87388[_0x44c92d(0x117)]}),await database_1[_0x44c92d(0x1cc)]['webhookLog']['create']({'data':{'paymentId':_0xf87388['id'],'shopId':_0xf87388['shopId'],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x44c92d(0x120)]({'error':_0x464409 instanceof Error?_0x464409[_0x44c92d(0x185)]:'Unknown\x20error','gatewayPaymentId':_0xf87388[_0x44c92d(0x175)],'checkedAt':new Date()[_0x44c92d(0x194)]()})}});}}async['sendShopWebhook'](_0x4cd87b,_0x5b2f70){const _0x2438e9=a37_0x3c18a6,_0x2d0f47=Date[_0x2438e9(0x15e)]();try{const _0x1e2c4b=_0x4cd87b[_0x2438e9(0x17e)],_0x24272e=_0x1e2c4b['settings'];if(!_0x24272e?.[_0x2438e9(0x1b2)]){console[_0x2438e9(0x17b)](_0x2438e9(0x139)+_0x1e2c4b['id']);return;}const _0x56fe1e=_0x5b2f70===_0x2438e9(0x182)?'payment.success':_0x5b2f70===_0x2438e9(0x169)?_0x2438e9(0x1b9):_0x5b2f70===_0x2438e9(0x187)?'payment.failed':_0x2438e9(0x109);if(!_0x24272e[_0x2438e9(0x106)]?.[_0x2438e9(0x124)](_0x56fe1e)){console[_0x2438e9(0x17b)](_0x2438e9(0x1cb)+_0x56fe1e+_0x2438e9(0x1c3)+_0x1e2c4b['id']);return;}const _0x1b54f4={'event':_0x56fe1e,'payment':{'id':_0x4cd87b['id'],'order_id':_0x4cd87b[_0x2438e9(0x1ae)],'gateway_order_id':_0x4cd87b[_0x2438e9(0x144)],'gateway':_0x2438e9(0x102),'amount':_0x4cd87b[_0x2438e9(0x1c4)],'currency':_0x4cd87b[_0x2438e9(0x191)],'status':_0x5b2f70['toLowerCase'](),'customer_email':_0x4cd87b[_0x2438e9(0x14f)],'customer_name':_0x4cd87b['customerName'],'created_at':_0x4cd87b[_0x2438e9(0x117)],'updated_at':new Date()}},_0x3c943f=await fetch(_0x24272e[_0x2438e9(0x1b2)],{'method':'POST','headers':{'Content-Type':_0x2438e9(0xf6),'User-Agent':_0x2438e9(0x100)},'body':JSON['stringify'](_0x1b54f4)}),_0x1ebea1=Date[_0x2438e9(0x15e)]()-_0x2d0f47,_0x54f07b=_0x3c943f['ok']?_0x2438e9(0x13a):await _0x3c943f[_0x2438e9(0x163)]();loggerService_1['loggerService'][_0x2438e9(0x110)](_0x4cd87b[_0x2438e9(0x1bf)],_0x24272e[_0x2438e9(0x1b2)],_0x56fe1e,_0x3c943f['status'],_0x1ebea1,_0x1b54f4),console[_0x2438e9(0x17b)](_0x2438e9(0x196)+_0x24272e[_0x2438e9(0x1b2)]+_0x2438e9(0x153)+_0x3c943f[_0x2438e9(0x10f)]+'\x20('+_0x1ebea1+'ms)');}catch(_0x426f8f){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x426f8f),loggerService_1['loggerService'][_0x2438e9(0x15a)](_0x4cd87b[_0x2438e9(0x1bf)],_0x4cd87b[_0x2438e9(0x17e)]?.['settings']?.[_0x2438e9(0x1b2)]||_0x2438e9(0xf8),_0x2438e9(0x15d),_0x426f8f,{});}}async[a37_0x3c18a6(0x105)](_0x2c74f2,_0x34a195){const _0x4a2f9e=a37_0x3c18a6;try{const _0x33c666={'PENDING':_0x4a2f9e(0x16b),'PAID':'paid','FAILED':_0x4a2f9e(0x160),'EXPIRED':'expired'},_0x23dc0b=_0x33c666[_0x34a195];if(!_0x23dc0b||_0x23dc0b==='created')return;await telegramBotService_1[_0x4a2f9e(0x1c1)]['sendPaymentNotification'](_0x2c74f2[_0x4a2f9e(0x1bf)],_0x2c74f2,_0x23dc0b);}catch(_0x1c2193){console['error'](_0x4a2f9e(0x1c9),_0x1c2193);}}async[a37_0x3c18a6(0x197)](_0x2392a2){const _0x46040d=a37_0x3c18a6;console[_0x46040d(0x17b)](_0x46040d(0x157)+_0x2392a2);const _0x50e375=await database_1[_0x46040d(0x1cc)]['payment'][_0x46040d(0x13c)]({'where':{'id':_0x2392a2},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x50e375)throw new Error(_0x46040d(0x158));if(_0x50e375[_0x46040d(0xf9)]!=='cointopay')throw new Error(_0x46040d(0x129));console[_0x46040d(0x17b)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x2392a2),await this['checkSinglePayment'](_0x50e375),console['log'](_0x46040d(0x193)+_0x2392a2);}[a37_0x3c18a6(0x151)](){const _0x5e18b0=a37_0x3c18a6,_0x5aec46=this[_0x5e18b0(0xfa)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x42bcfd=Array[_0x5e18b0(0x136)](this[_0x5e18b0(0x1c7)][_0x5e18b0(0x142)]())['map'](_0xba8259=>({'paymentId':_0xba8259['paymentId'],'gatewayPaymentId':_0xba8259[_0x5e18b0(0x175)],'createdAt':_0xba8259['createdAt'],'timersCount':_0xba8259['timers']['length']}));return{'isActive':!!this[_0x5e18b0(0xfa)],'globalCheckIntervalMinutes':this[_0x5e18b0(0x11a)]/(0x3e8*0x3c),'expiryDays':this[_0x5e18b0(0x114)],'activeIndividualTimers':this[_0x5e18b0(0x1c7)][_0x5e18b0(0x104)],'nextGlobalCheckIn':_0x5aec46,'paymentTimersDetails':_0x42bcfd};}[a37_0x3c18a6(0x1b4)](_0x5ba852){const _0x314406=a37_0x3c18a6,_0x5bf39b=this['paymentTimers'][_0x314406(0x198)](_0x5ba852);if(_0x5bf39b)return{'hasTimers':!![],'timersCount':_0x5bf39b['timers'][_0x314406(0x133)],'createdAt':_0x5bf39b[_0x314406(0x117)],'gatewayPaymentId':_0x5bf39b['gatewayPaymentId']};return{'hasTimers':![]};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();