'use strict';const a35_0x2b8934=a35_0x168b;(function(_0xf3e7b2,_0x14ac63){const _0x3265fc=a35_0x168b,_0x22ca69=_0xf3e7b2();while(!![]){try{const _0x1ffc1a=parseInt(_0x3265fc(0x170))/0x1*(parseInt(_0x3265fc(0x1a5))/0x2)+-parseInt(_0x3265fc(0x160))/0x3*(parseInt(_0x3265fc(0x18a))/0x4)+parseInt(_0x3265fc(0x131))/0x5+parseInt(_0x3265fc(0x15b))/0x6+-parseInt(_0x3265fc(0x1ac))/0x7*(-parseInt(_0x3265fc(0x135))/0x8)+-parseInt(_0x3265fc(0x181))/0x9+-parseInt(_0x3265fc(0x16d))/0xa*(-parseInt(_0x3265fc(0x1ae))/0xb);if(_0x1ffc1a===_0x14ac63)break;else _0x22ca69['push'](_0x22ca69['shift']());}catch(_0x4f17a9){_0x22ca69['push'](_0x22ca69['shift']());}}}(a35_0x2a8a,0x41a38));function a35_0x168b(_0x59ab1b,_0x343e9f){const _0x2a8a9f=a35_0x2a8a();return a35_0x168b=function(_0x168b16,_0x39b797){_0x168b16=_0x168b16-0x120;let _0x434aab=_0x2a8a9f[_0x168b16];return _0x434aab;},a35_0x168b(_0x59ab1b,_0x343e9f);}var __importDefault=this&&this[a35_0x2b8934(0x14f)]||function(_0x5b83fb){return _0x5b83fb&&_0x5b83fb['__esModule']?_0x5b83fb:{'default':_0x5b83fb};};function a35_0x2a8a(){const _0x344a86=['Bank\x20Details:\x20','push','message','unknown','./telegramBotService','\x20status\x20unchanged\x20(','checkPaymentById','gatewayOrderId','‚úÖ\x20Completed\x20checking\x20','catch','\x20details:','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','default','getTime','\x20pending\x20CoinToPay\x20payments','application/json','1786590IDoefM','sendShopWebhook','transactionId','checkInterval','223616FVAyWN','0100','stopPeriodicStatusCheck','‚úÖ\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','Webhook\x20event\x20','TesSoft\x20Payment\x20System/1.0','error','payment.pending','‚è∞\x20Payment\x20','üí∞\x20Payment\x20','Failed\x20to\x20expire\x20payment\x20','./loggerService','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','shop','\x20has\x20no\x20gatewayPaymentId,\x20skipping','currency','defineProperty','adminNotes','customerEmail','coinToPayService','\x20expired\x20CoinToPay\x20payments','checkExpiredPayments','CoinToPayStatusService','üÜî\x20Transaction\x20ID:\x20','bankDetails','setDate','__importDefault','Initial\x20CoinToPay\x20status\x20check\x20failed:','toISOString','not\x20found','‚ö†Ô∏è\x20Payment\x20','update','getDate','telegramBotService','PAID','\x20days','üìä\x20Payment\x20','includes','811932bccaqP','toLowerCase','webhookUrl','logShopWebhookError','ms)','501pJDJeE','\x20status:\x20','‚è∞\x20Found\x20','paymentDetails','loggerService','../config/database','getServiceStats','paidAt','createdOn','logShopWebhookSent','/status/','checkAllPendingPayments','__esModule','1250290FpYuhu','-day\x20timeout','Automatically\x20expired\x20after\x20','61156dHHKYQ','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','startPeriodicStatusCheck','POST','\x20with\x20status\x20','log','failed','Failed\x20to\x20check\x20payment\x20','\x20status\x20from\x20','üîç\x20Checking\x20CoinToPay\x20payment\x20','createdAt','üõë\x20CoinToPay\x20status\x20checking\x20stopped','findUnique','PENDING','cointopay_status_check_','cointopay','shopId','4420683sAzbqT','sendPaymentStatusNotification','\x20to\x20','paid','payment.failed','create','checkPaymentStatus','payment.success','\x20CoinToPay\x20payments','1528jdnApb','length','üè¶\x20Saved\x20IBAN:\x20','CHECK_INTERVAL_MS','gatewayPaymentId','findMany','\x20days\x20(created\x20before\x20','created','webhookLog','coinToPayStatusService','./gateways/coinToPayService','status','confirmedOn','orderId','webhookEvents','iban','text','remitterIban','\x20days,\x20marking\x20as\x20EXPIRED','checkSinglePayment','Failed\x20to\x20send\x20shop\x20webhook:','‚úÖ\x20Payment\x20','not\x20confirmed','EXPIRY_DAYS','\x20not\x20enabled\x20for\x20shop\x20','amount','payment','4SGNqjO','stringify','logWhiteDomainError','now','gateway','EXPIRED','ü™ô\x20Checking\x20','21xayqJI','webhook_send','11PlqEXC','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','FAILED','cointopay_auto_expired'];a35_0x2a8a=function(){return _0x344a86;};return a35_0x2a8a();}Object[a35_0x2b8934(0x145)](exports,a35_0x2b8934(0x16c),{'value':!![]}),exports[a35_0x2b8934(0x193)]=exports[a35_0x2b8934(0x14b)]=void 0x0;const coinToPayService_1=require(a35_0x2b8934(0x194)),database_1=__importDefault(require(a35_0x2b8934(0x165))),telegramBotService_1=require(a35_0x2b8934(0x125)),loggerService_1=require(a35_0x2b8934(0x140));class CoinToPayStatusService{constructor(){const _0x378fe7=a35_0x2b8934;this[_0x378fe7(0x134)]=null,this[_0x378fe7(0x18d)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x378fe7(0x148)]=new coinToPayService_1['CoinToPayService']();}[a35_0x2b8934(0x172)](){const _0x3284e3=a35_0x2b8934;console['log']('ü™ô\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)'),this[_0x3284e3(0x16b)]()[_0x3284e3(0x12a)](_0x223775=>{const _0x38d97f=_0x3284e3;console['error'](_0x38d97f(0x150),_0x223775);}),this[_0x3284e3(0x134)]=setInterval(async()=>{const _0x4aeee0=_0x3284e3;try{await this[_0x4aeee0(0x16b)]();}catch(_0x1338ed){console['error']('Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x1338ed);}},this[_0x3284e3(0x18d)]),console[_0x3284e3(0x175)](_0x3284e3(0x138));}[a35_0x2b8934(0x137)](){const _0x3d499b=a35_0x2b8934;this[_0x3d499b(0x134)]&&(clearInterval(this['checkInterval']),this[_0x3d499b(0x134)]=null,console[_0x3d499b(0x175)](_0x3d499b(0x17b)));}async[a35_0x2b8934(0x16b)](){const _0x4645a6=a35_0x2b8934;try{const _0x2c2740=await database_1[_0x4645a6(0x12d)]['payment'][_0x4645a6(0x18f)]({'where':{'gateway':_0x4645a6(0x17f),'status':_0x4645a6(0x17d),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x2c2740['length']===0x0){console[_0x4645a6(0x175)]('ü™ô\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}console[_0x4645a6(0x175)](_0x4645a6(0x1ab)+_0x2c2740[_0x4645a6(0x18b)]+_0x4645a6(0x12f));const _0x4a4138=await this[_0x4645a6(0x14a)](_0x2c2740);console[_0x4645a6(0x175)](_0x4645a6(0x162)+_0x4a4138[_0x4645a6(0x18b)]+_0x4645a6(0x149));for(const _0x575d11 of _0x2c2740){try{if(_0x4a4138[_0x4645a6(0x15a)](_0x575d11['id'])){console[_0x4645a6(0x175)](_0x4645a6(0x13d)+_0x575d11['id']+_0x4645a6(0x141));continue;}await this[_0x4645a6(0x19d)](_0x575d11),await new Promise(_0x1b2b23=>setTimeout(_0x1b2b23,0x7d0));}catch(_0x5d609a){console[_0x4645a6(0x13b)]('Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x575d11['id']+':',_0x5d609a),loggerService_1[_0x4645a6(0x164)][_0x4645a6(0x1a7)]('cointopay',_0x4645a6(0x16a)+_0x575d11['gatewayPaymentId'],_0x5d609a);}}console[_0x4645a6(0x175)](_0x4645a6(0x129)+_0x2c2740[_0x4645a6(0x18b)]+_0x4645a6(0x189));}catch(_0x12f203){console[_0x4645a6(0x13b)]('Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x12f203);}}async[a35_0x2b8934(0x14a)](_0x366d56){const _0x3e0633=a35_0x2b8934,_0x2c4203=[],_0x39a900=new Date();_0x39a900[_0x3e0633(0x14e)](_0x39a900[_0x3e0633(0x155)]()-this[_0x3e0633(0x1a1)]),console[_0x3e0633(0x175)]('‚è∞\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x3e0633(0x1a1)]+_0x3e0633(0x190)+_0x39a900['toISOString']()+')');for(const _0x5db58b of _0x366d56){if(_0x5db58b[_0x3e0633(0x17a)]<_0x39a900){console[_0x3e0633(0x175)](_0x3e0633(0x13d)+_0x5db58b['id']+'\x20is\x20older\x20than\x20'+this[_0x3e0633(0x1a1)]+_0x3e0633(0x19c));try{await database_1['default'][_0x3e0633(0x1a4)][_0x3e0633(0x154)]({'where':{'id':_0x5db58b['id']},'data':{'status':_0x3e0633(0x1aa),'updatedAt':new Date(),'adminNotes':_0x3e0633(0x16f)+this[_0x3e0633(0x1a1)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x3e0633(0x12d)][_0x3e0633(0x192)][_0x3e0633(0x186)]({'data':{'paymentId':_0x5db58b['id'],'shopId':_0x5db58b[_0x3e0633(0x180)],'event':_0x3e0633(0x120),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':'Payment\x20older\x20than\x20'+this[_0x3e0633(0x1a1)]+_0x3e0633(0x158),'createdAt':_0x5db58b['createdAt'],'expiredAt':new Date()[_0x3e0633(0x151)](),'daysSinceCreation':Math['floor']((Date['now']()-_0x5db58b[_0x3e0633(0x17a)][_0x3e0633(0x12e)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x3e0633(0x132)](_0x5db58b,'EXPIRED'),await this[_0x3e0633(0x182)](_0x5db58b,'EXPIRED'),_0x2c4203[_0x3e0633(0x122)](_0x5db58b['id']),console['log']('‚úÖ\x20Payment\x20'+_0x5db58b['id']+_0x3e0633(0x12c)+this[_0x3e0633(0x1a1)]+_0x3e0633(0x16e));}catch(_0x5b4bfa){console[_0x3e0633(0x13b)](_0x3e0633(0x13f)+_0x5db58b['id']+':',_0x5b4bfa);}}}return _0x2c4203;}async['checkSinglePayment'](_0x3f4ede){const _0x1edeea=a35_0x2b8934;if(!_0x3f4ede[_0x1edeea(0x18e)]){console['log'](_0x1edeea(0x153)+_0x3f4ede['id']+_0x1edeea(0x143));return;}console[_0x1edeea(0x175)](_0x1edeea(0x179)+_0x3f4ede['id']+'\x20('+_0x3f4ede[_0x1edeea(0x18e)]+')');try{const _0x5ad740=await this[_0x1edeea(0x148)][_0x1edeea(0x187)](_0x3f4ede[_0x1edeea(0x18e)]);console[_0x1edeea(0x175)](_0x1edeea(0x159)+_0x3f4ede['id']+_0x1edeea(0x161)+_0x5ad740[_0x1edeea(0x195)]);_0x5ad740[_0x1edeea(0x163)]&&console['log']('üìä\x20Payment\x20'+_0x3f4ede['id']+_0x1edeea(0x12b),{'iban':_0x5ad740[_0x1edeea(0x163)][_0x1edeea(0x199)]||_0x1edeea(0x152),'transactionId':_0x5ad740['paymentDetails']['transactionId'],'createdOn':_0x5ad740[_0x1edeea(0x163)][_0x1edeea(0x168)],'confirmedOn':_0x5ad740['paymentDetails']['confirmedOn']||_0x1edeea(0x1a0)});if(_0x5ad740[_0x1edeea(0x195)]!==_0x3f4ede[_0x1edeea(0x195)]){console[_0x1edeea(0x175)]('üîÑ\x20Updating\x20payment\x20'+_0x3f4ede['id']+_0x1edeea(0x178)+_0x3f4ede[_0x1edeea(0x195)]+_0x1edeea(0x183)+_0x5ad740[_0x1edeea(0x195)]);const _0x14782b={'status':_0x5ad740['status'],'updatedAt':new Date()};_0x5ad740['status']===_0x1edeea(0x157)&&_0x3f4ede[_0x1edeea(0x195)]!=='PAID'&&(_0x14782b[_0x1edeea(0x167)]=new Date(),console[_0x1edeea(0x175)](_0x1edeea(0x13e)+_0x3f4ede['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x14782b['paidAt'][_0x1edeea(0x151)]()));if(_0x5ad740['paymentDetails']){const _0x20e4cf=_0x5ad740['paymentDetails'];_0x20e4cf[_0x1edeea(0x199)]&&(_0x14782b[_0x1edeea(0x19b)]=_0x20e4cf[_0x1edeea(0x199)],console['log'](_0x1edeea(0x18c)+_0x20e4cf['iban']));if(_0x20e4cf[_0x1edeea(0x14d)]){const _0x3ec06c=_0x3f4ede[_0x1edeea(0x146)]||'',_0x1be669=_0x1edeea(0x121)+_0x20e4cf['bankDetails'];_0x14782b[_0x1edeea(0x146)]=_0x3ec06c?_0x3ec06c+'\x0a\x0a'+_0x1be669:_0x1be669,console['log']('üè¶\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x20e4cf['transactionId']&&console[_0x1edeea(0x175)](_0x1edeea(0x14c)+_0x20e4cf[_0x1edeea(0x133)]),_0x20e4cf[_0x1edeea(0x196)]&&console[_0x1edeea(0x175)]('‚úÖ\x20Transaction\x20confirmed\x20on:\x20'+_0x20e4cf[_0x1edeea(0x196)]);}await database_1[_0x1edeea(0x12d)][_0x1edeea(0x1a4)][_0x1edeea(0x154)]({'where':{'id':_0x3f4ede['id']},'data':_0x14782b}),await database_1[_0x1edeea(0x12d)]['webhookLog'][_0x1edeea(0x186)]({'data':{'paymentId':_0x3f4ede['id'],'shopId':_0x3f4ede[_0x1edeea(0x180)],'event':_0x1edeea(0x17e)+_0x5ad740[_0x1edeea(0x195)][_0x1edeea(0x15c)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x3f4ede[_0x1edeea(0x195)],'newStatus':_0x5ad740[_0x1edeea(0x195)],'paymentDetails':_0x5ad740[_0x1edeea(0x163)],'checkedAt':new Date()[_0x1edeea(0x151)]()})}}),await this[_0x1edeea(0x132)](_0x3f4ede,_0x5ad740[_0x1edeea(0x195)]),await this['sendPaymentStatusNotification'](_0x3f4ede,_0x5ad740['status']),console['log'](_0x1edeea(0x19f)+_0x3f4ede['id']+'\x20updated\x20successfully');}else console[_0x1edeea(0x175)](_0x1edeea(0x159)+_0x3f4ede['id']+_0x1edeea(0x126)+_0x5ad740['status']+')');}catch(_0x55865c){console['error'](_0x1edeea(0x177)+_0x3f4ede['id']+':',_0x55865c),await database_1[_0x1edeea(0x12d)][_0x1edeea(0x192)]['create']({'data':{'paymentId':_0x3f4ede['id'],'shopId':_0x3f4ede[_0x1edeea(0x180)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x55865c instanceof Error?_0x55865c[_0x1edeea(0x123)]:'Unknown\x20error','gatewayPaymentId':_0x3f4ede['gatewayPaymentId'],'checkedAt':new Date()[_0x1edeea(0x151)]()})}});}}async[a35_0x2b8934(0x132)](_0x11471f,_0x3da0fe){const _0x107bc7=a35_0x2b8934,_0x3daa69=Date[_0x107bc7(0x1a8)]();try{const _0x29d44d=_0x11471f[_0x107bc7(0x142)],_0x2cb523=_0x29d44d['settings'];if(!_0x2cb523?.[_0x107bc7(0x15d)]){console[_0x107bc7(0x175)](_0x107bc7(0x171)+_0x29d44d['id']);return;}const _0x112038=_0x3da0fe==='PAID'?_0x107bc7(0x188):_0x3da0fe===_0x107bc7(0x1b0)?_0x107bc7(0x185):_0x3da0fe===_0x107bc7(0x1aa)?_0x107bc7(0x185):_0x107bc7(0x13c);if(!_0x2cb523[_0x107bc7(0x198)]?.[_0x107bc7(0x15a)](_0x112038)){console[_0x107bc7(0x175)](_0x107bc7(0x139)+_0x112038+_0x107bc7(0x1a2)+_0x29d44d['id']);return;}const _0x155890={'event':_0x112038,'payment':{'id':_0x11471f['id'],'order_id':_0x11471f[_0x107bc7(0x197)],'gateway_order_id':_0x11471f[_0x107bc7(0x128)],'gateway':_0x107bc7(0x136),'amount':_0x11471f[_0x107bc7(0x1a3)],'currency':_0x11471f[_0x107bc7(0x144)],'status':_0x3da0fe[_0x107bc7(0x15c)](),'customer_email':_0x11471f[_0x107bc7(0x147)],'customer_name':_0x11471f['customerName'],'created_at':_0x11471f[_0x107bc7(0x17a)],'updated_at':new Date()}},_0x277eb1=await fetch(_0x2cb523[_0x107bc7(0x15d)],{'method':_0x107bc7(0x173),'headers':{'Content-Type':_0x107bc7(0x130),'User-Agent':_0x107bc7(0x13a)},'body':JSON[_0x107bc7(0x1a6)](_0x155890)}),_0x5c068b=Date[_0x107bc7(0x1a8)]()-_0x3daa69,_0x5b5ed9=_0x277eb1['ok']?'Success':await _0x277eb1[_0x107bc7(0x19a)]();loggerService_1[_0x107bc7(0x164)][_0x107bc7(0x169)](_0x11471f[_0x107bc7(0x180)],_0x2cb523[_0x107bc7(0x15d)],_0x112038,_0x277eb1[_0x107bc7(0x195)],_0x5c068b,_0x155890),console[_0x107bc7(0x175)]('Shop\x20webhook\x20sent\x20to\x20'+_0x2cb523['webhookUrl']+_0x107bc7(0x174)+_0x277eb1['status']+'\x20('+_0x5c068b+_0x107bc7(0x15f));}catch(_0x33e2c1){console['error'](_0x107bc7(0x19e),_0x33e2c1),loggerService_1['loggerService'][_0x107bc7(0x15e)](_0x11471f[_0x107bc7(0x180)],_0x11471f[_0x107bc7(0x142)]?.['settings']?.['webhookUrl']||_0x107bc7(0x124),_0x107bc7(0x1ad),_0x33e2c1,{});}}async[a35_0x2b8934(0x182)](_0xf1924c,_0x51717a){const _0x138bcd=a35_0x2b8934;try{const _0x33864e={'PENDING':'created','PAID':_0x138bcd(0x184),'FAILED':_0x138bcd(0x176),'EXPIRED':'expired'},_0x3c3cb2=_0x33864e[_0x51717a];if(!_0x3c3cb2||_0x3c3cb2===_0x138bcd(0x191))return;await telegramBotService_1[_0x138bcd(0x156)]['sendPaymentNotification'](_0xf1924c['shopId'],_0xf1924c,_0x3c3cb2);}catch(_0x4c6a45){console[_0x138bcd(0x13b)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4c6a45);}}async[a35_0x2b8934(0x127)](_0x3c5e5f){const _0x53aefb=a35_0x2b8934,_0x440cfa=await database_1['default']['payment'][_0x53aefb(0x17c)]({'where':{'id':_0x3c5e5f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x440cfa)throw new Error('Payment\x20not\x20found');if(_0x440cfa[_0x53aefb(0x1a9)]!=='cointopay')throw new Error(_0x53aefb(0x1af));await this['checkSinglePayment'](_0x440cfa);}[a35_0x2b8934(0x166)](){const _0x427f7b=a35_0x2b8934,_0x4850ad=this['checkInterval']?this[_0x427f7b(0x18d)]:undefined;return{'isActive':!!this[_0x427f7b(0x134)],'checkIntervalMinutes':this[_0x427f7b(0x18d)]/(0x3e8*0x3c),'expiryDays':this[_0x427f7b(0x1a1)],'nextCheckIn':_0x4850ad};}}exports[a35_0x2b8934(0x14b)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();