'use strict';const a37_0x2abe7d=a37_0xcd44;(function(_0x487d66,_0x36659e){const _0x66353c=a37_0xcd44,_0x2bcaae=_0x487d66();while(!![]){try{const _0x4b2726=parseInt(_0x66353c(0x101))/0x1*(parseInt(_0x66353c(0xf6))/0x2)+-parseInt(_0x66353c(0x120))/0x3*(-parseInt(_0x66353c(0x182))/0x4)+-parseInt(_0x66353c(0x13c))/0x5*(-parseInt(_0x66353c(0x165))/0x6)+-parseInt(_0x66353c(0x15c))/0x7*(-parseInt(_0x66353c(0x108))/0x8)+-parseInt(_0x66353c(0x11d))/0x9+parseInt(_0x66353c(0x14b))/0xa+-parseInt(_0x66353c(0x181))/0xb;if(_0x4b2726===_0x36659e)break;else _0x2bcaae['push'](_0x2bcaae['shift']());}catch(_0x5a6f93){_0x2bcaae['push'](_0x2bcaae['shift']());}}}(a37_0xd64a,0x4fb85));var __importDefault=this&&this[a37_0x2abe7d(0x12c)]||function(_0x172fd0){const _0x47f625=a37_0x2abe7d;return _0x172fd0&&_0x172fd0[_0x47f625(0xfb)]?_0x172fd0:{'default':_0x172fd0};};Object[a37_0x2abe7d(0x190)](exports,'__esModule',{'value':!![]}),exports[a37_0x2abe7d(0x14e)]=exports[a37_0x2abe7d(0x154)]=void 0x0;const coinToPayService_1=require(a37_0x2abe7d(0x125)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a37_0x2abe7d(0x16b));class CoinToPayStatusService{constructor(){const _0x5154ef=a37_0x2abe7d;this['globalCheckInterval']=null,this[_0x5154ef(0x105)]=0x3c*0x3c*0x3e8,this[_0x5154ef(0xe3)]=0x5,this[_0x5154ef(0x16d)]=new Map(),this[_0x5154ef(0x162)]=new coinToPayService_1[(_0x5154ef(0x156))](),console[_0x5154ef(0x11c)](_0x5154ef(0x17c));}[a37_0x2abe7d(0xc9)](_0x2ce522,_0x5e1830){const _0x506864=a37_0x2abe7d;console[_0x506864(0x11c)](_0x506864(0x13e)),console[_0x506864(0x11c)]('\x20\x20\x20-\x20paymentId:\x20'+_0x2ce522),console[_0x506864(0x11c)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x5e1830),this['clearPaymentTimers'](_0x2ce522);const _0x573cf0=[],_0x3d5bff=new Date(),_0x4f2539=[{'delay':0x1*0x3c*0x3e8,'description':_0x506864(0x177)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x506864(0x13d)},{'delay':0x5*0x3c*0x3e8,'description':_0x506864(0x13d)}];console[_0x506864(0x11c)](_0x506864(0x115)+_0x4f2539['length']+'\x20initial\x20timers\x20for\x20payment\x20'+_0x2ce522);let _0x2c3fe0=0x0;_0x4f2539[_0x506864(0x14f)]((_0x24d5d1,_0x15b245)=>{const _0x203b76=_0x506864;_0x2c3fe0+=_0x24d5d1['delay'];const _0x9be821=setTimeout(async()=>{const _0x26608f=a37_0xcd44;console[_0x26608f(0x11c)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x15b245+0x1)+_0x26608f(0x197)+_0x2ce522+'\x20(after\x20'+_0x24d5d1[_0x26608f(0x12e)]+')');try{await this[_0x26608f(0x153)](_0x2ce522),console[_0x26608f(0x11c)]('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x15b245+0x1)+'\x20completed\x20for\x20payment\x20'+_0x2ce522);}catch(_0x758ee8){console['error'](_0x26608f(0xd6)+(_0x15b245+0x1)+_0x26608f(0x15b)+_0x2ce522+':',_0x758ee8),this[_0x26608f(0x180)](_0x2ce522,_0x5e1830,_0x758ee8,_0x26608f(0x10f),{'checkNumber':_0x15b245+0x1,'scheduledAfter':_0x24d5d1['description'],'isIndividualCheck':!![]});}},_0x2c3fe0);_0x573cf0[_0x203b76(0x186)](_0x9be821),console['log'](_0x203b76(0x184)+(_0x15b245+0x1)+_0x203b76(0x15b)+_0x2ce522+_0x203b76(0x17b)+_0x2c3fe0/0x3e8+'\x20seconds\x20('+_0x24d5d1[_0x203b76(0x12e)]+')');});const _0x37726a=setInterval(async()=>{const _0x578209=_0x506864;console[_0x578209(0x11c)](_0x578209(0x187)+_0x2ce522);try{const _0x2f04ce=await database_1[_0x578209(0x140)][_0x578209(0x18d)][_0x578209(0x137)]({'where':{'id':_0x2ce522},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x2f04ce){console[_0x578209(0x11c)](_0x578209(0x139)+_0x2ce522+'\x20not\x20found,\x20clearing\x20timers'),this[_0x578209(0x1a2)](_0x2ce522);return;}console[_0x578209(0x11c)](_0x578209(0x11f)+_0x2ce522+_0x578209(0x16f)+_0x2f04ce[_0x578209(0x161)]);if(_0x2f04ce['status']!=='PENDING'){console[_0x578209(0x11c)]('✅\x20[HOURLY]\x20Payment\x20'+_0x2ce522+_0x578209(0x15a)+_0x2f04ce['status']+_0x578209(0xca)),this[_0x578209(0x1a2)](_0x2ce522);return;}const _0x115a8b=Math[_0x578209(0xd7)]((Date[_0x578209(0x138)]()-_0x2f04ce['createdAt'][_0x578209(0xfc)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x115a8b>=this[_0x578209(0xe3)]){console['log'](_0x578209(0x172)+_0x2ce522+_0x578209(0x17a)+this[_0x578209(0xe3)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this['clearPaymentTimers'](_0x2ce522);return;}await this[_0x578209(0x153)](_0x2ce522),console[_0x578209(0x11c)](_0x578209(0x178)+_0x2ce522);}catch(_0x550201){console['error'](_0x578209(0x10e)+_0x2ce522+':',_0x550201),this[_0x578209(0x180)](_0x2ce522,_0x5e1830,_0x550201,_0x578209(0x10f),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x573cf0[_0x506864(0x186)](_0x37726a),this[_0x506864(0x16d)]['set'](_0x2ce522,{'timers':_0x573cf0,'paymentId':_0x2ce522,'gatewayPaymentId':_0x5e1830,'createdAt':_0x3d5bff}),console['log']('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x4f2539[_0x506864(0x185)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x2ce522),console['log']('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this['paymentTimers'][_0x506864(0x157)]),this[_0x506864(0x18f)](_0x2ce522,_0x5e1830,_0x506864(0x100),_0x506864(0x100),_0x506864(0x10f),{'action':_0x506864(0x191),'scheduledChecks':_0x4f2539[_0x506864(0x185)],'firstCheckIn':_0x4f2539[0x0][_0x506864(0x19d)]/0x3e8,'totalTimers':this[_0x506864(0x16d)][_0x506864(0x157)]});}[a37_0x2abe7d(0x1a2)](_0x561746){const _0x1bcc7d=a37_0x2abe7d,_0x242487=this[_0x1bcc7d(0x16d)][_0x1bcc7d(0x15f)](_0x561746);_0x242487?(console[_0x1bcc7d(0x11c)](_0x1bcc7d(0xe2)+_0x242487[_0x1bcc7d(0xd1)][_0x1bcc7d(0x185)]+'\x20timers\x20for\x20payment\x20'+_0x561746),_0x242487[_0x1bcc7d(0xd1)][_0x1bcc7d(0x14f)]((_0x2ef22c,_0x47a294)=>{const _0x41c031=_0x1bcc7d;_0x2ef22c&&(clearTimeout(_0x2ef22c),clearInterval(_0x2ef22c),console[_0x41c031(0x11c)](_0x41c031(0xef)+(_0x47a294+0x1)+'\x20for\x20payment\x20'+_0x561746));}),this[_0x1bcc7d(0x16d)][_0x1bcc7d(0x17f)](_0x561746),console['log'](_0x1bcc7d(0x133)+_0x561746+_0x1bcc7d(0x15e)+this[_0x1bcc7d(0x16d)][_0x1bcc7d(0x157)])):console['log'](_0x1bcc7d(0xf5)+_0x561746+_0x1bcc7d(0x143));}async['checkSinglePaymentById'](_0x261f27){const _0x3e7ea4=a37_0x2abe7d;console[_0x3e7ea4(0x11c)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x261f27);const _0xe3b28e=await database_1[_0x3e7ea4(0x140)]['payment']['findUnique']({'where':{'id':_0x261f27},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xe3b28e){console[_0x3e7ea4(0x11c)](_0x3e7ea4(0xe8)+_0x261f27+_0x3e7ea4(0xd4));return;}console[_0x3e7ea4(0x11c)](_0x3e7ea4(0x114)+_0x261f27+_0x3e7ea4(0x10a)),console[_0x3e7ea4(0x11c)](_0x3e7ea4(0x19f)+_0xe3b28e['gateway']),console[_0x3e7ea4(0x11c)](_0x3e7ea4(0x166)+_0xe3b28e[_0x3e7ea4(0x161)]),console[_0x3e7ea4(0x11c)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0xe3b28e[_0x3e7ea4(0x16a)]),console[_0x3e7ea4(0x11c)](_0x3e7ea4(0xcb)+_0xe3b28e['amount']+'\x20'+_0xe3b28e['currency']),console[_0x3e7ea4(0x11c)](_0x3e7ea4(0xe7)+_0xe3b28e[_0x3e7ea4(0xe4)]);if(_0xe3b28e[_0x3e7ea4(0xfd)]!==_0x3e7ea4(0x196)){console['log'](_0x3e7ea4(0xda)+_0x261f27+_0x3e7ea4(0x14d)+_0xe3b28e[_0x3e7ea4(0xfd)]+')');return;}if(_0xe3b28e[_0x3e7ea4(0x161)]!==_0x3e7ea4(0x100)){console[_0x3e7ea4(0x11c)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x261f27+_0x3e7ea4(0x15a)+_0xe3b28e[_0x3e7ea4(0x161)]+_0x3e7ea4(0xca)),this[_0x3e7ea4(0x1a2)](_0x261f27);return;}if(!_0xe3b28e[_0x3e7ea4(0x16a)]){console[_0x3e7ea4(0x11c)](_0x3e7ea4(0xda)+_0x261f27+_0x3e7ea4(0xcf));return;}console[_0x3e7ea4(0x11c)]('✅\x20[CHECK]\x20Payment\x20'+_0x261f27+_0x3e7ea4(0x17d)),await this[_0x3e7ea4(0x147)](_0xe3b28e);}[a37_0x2abe7d(0x18f)](_0x444059,_0x40b0f6,_0x509333,_0x4d1dc2,_0x2d4df2,_0x35fd9f){const _0x2d99fa=a37_0x2abe7d,_0x140926={'type':_0x2d99fa(0x112),'paymentId':_0x444059,'gatewayPaymentId':_0x40b0f6,'oldStatus':_0x509333,'newStatus':_0x4d1dc2,'source':_0x2d4df2,'timestamp':new Date()[_0x2d99fa(0x106)](),'details':_0x35fd9f||{}};loggerService_1[_0x2d99fa(0xff)][_0x2d99fa(0x18f)](_0x140926),console['log'](_0x2d99fa(0xe1)+_0x444059+'\x20('+_0x40b0f6+')'),console[_0x2d99fa(0x11c)]('\x20\x20\x20📊\x20Status:\x20'+_0x509333+_0x2d99fa(0x199)+_0x4d1dc2),console[_0x2d99fa(0x11c)](_0x2d99fa(0x11b)+_0x2d4df2),console['log'](_0x2d99fa(0x183)+_0x140926['timestamp']),_0x35fd9f&&console[_0x2d99fa(0x11c)](_0x2d99fa(0x107),_0x35fd9f);}['logCoinToPayError'](_0x106134,_0x3fd354,_0x5c8cbb,_0x496900,_0xa282ad){const _0x26992a=a37_0x2abe7d,_0x1e4a42={'type':_0x26992a(0x175),'paymentId':_0x106134,'gatewayPaymentId':_0x3fd354,'error':_0x5c8cbb instanceof Error?{'message':_0x5c8cbb['message'],'stack':_0x5c8cbb['stack']}:_0x5c8cbb,'source':_0x496900,'timestamp':new Date()['toISOString'](),'context':_0xa282ad||{}};loggerService_1[_0x26992a(0xff)][_0x26992a(0x180)](_0x1e4a42),console[_0x26992a(0x19c)](_0x26992a(0x19e)+_0x106134+'\x20('+_0x3fd354+')'),console[_0x26992a(0x19c)](_0x26992a(0xe9)+(_0x5c8cbb instanceof Error?_0x5c8cbb[_0x26992a(0x14a)]:_0x5c8cbb)),console[_0x26992a(0x19c)](_0x26992a(0x11b)+_0x496900),console[_0x26992a(0x19c)](_0x26992a(0x183)+_0x1e4a42[_0x26992a(0x16e)]),_0xa282ad&&console[_0x26992a(0x19c)](_0x26992a(0x198),_0xa282ad);}[a37_0x2abe7d(0x16c)](){const _0x4337dd=a37_0x2abe7d;console[_0x4337dd(0x11c)]('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x4337dd(0x12f)]()[_0x4337dd(0xce)](_0x4e8e28=>{const _0x440063=_0x4337dd;console[_0x440063(0x19c)]('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x4e8e28);}),this['globalCheckInterval']=setInterval(async()=>{const _0x56fc97=_0x4337dd;try{console[_0x56fc97(0x11c)](_0x56fc97(0x152)),await this[_0x56fc97(0x12f)](),console[_0x56fc97(0x11c)](_0x56fc97(0x13f));}catch(_0x59ffca){console[_0x56fc97(0x19c)]('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x59ffca);}},this[_0x4337dd(0x105)]),console[_0x4337dd(0x11c)](_0x4337dd(0xd5));}[a37_0x2abe7d(0x159)](){const _0x54f9b8=a37_0x2abe7d;console['log'](_0x54f9b8(0xcd));this[_0x54f9b8(0x18c)]&&(clearInterval(this[_0x54f9b8(0x18c)]),this[_0x54f9b8(0x18c)]=null,console[_0x54f9b8(0x11c)](_0x54f9b8(0x124)));const _0x5ac72c=this[_0x54f9b8(0x16d)][_0x54f9b8(0x157)];for(const [_0x55c346]of this['paymentTimers']){this[_0x54f9b8(0x1a2)](_0x55c346);}console[_0x54f9b8(0x11c)](_0x54f9b8(0xdb)+_0x5ac72c+_0x54f9b8(0x173));}async[a37_0x2abe7d(0x12f)](){const _0x375da2=a37_0x2abe7d;try{console[_0x375da2(0x11c)](_0x375da2(0x116));const _0xbd2494=await database_1[_0x375da2(0x140)][_0x375da2(0x18d)][_0x375da2(0xee)]({'where':{'gateway':'cointopay','status':_0x375da2(0x100),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x375da2(0x150)+_0xbd2494[_0x375da2(0x185)]+_0x375da2(0x163));if(_0xbd2494[_0x375da2(0x185)]===0x0){console['log'](_0x375da2(0xe0));return;}const _0x2e79f9=await this[_0x375da2(0xf3)](_0xbd2494);console[_0x375da2(0x11c)](_0x375da2(0x1a0)+_0x2e79f9[_0x375da2(0x185)]+_0x375da2(0x1a1));let _0x960c45=0x0,_0x40730d=0x0;for(const _0x2c13ab of _0xbd2494){try{if(_0x2e79f9[_0x375da2(0x12a)](_0x2c13ab['id'])){console[_0x375da2(0x11c)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x2c13ab['id']+_0x375da2(0xdc)),_0x40730d++;continue;}if(this[_0x375da2(0x16d)][_0x375da2(0xde)](_0x2c13ab['id'])){console['log'](_0x375da2(0x195)+_0x2c13ab['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x40730d++;continue;}const _0x184d31=(Date[_0x375da2(0x138)]()-_0x2c13ab['createdAt'][_0x375da2(0xfc)]())/(0x3e8*0x3c*0x3c);if(_0x184d31<0x1){console[_0x375da2(0x11c)](_0x375da2(0x195)+_0x2c13ab['id']+_0x375da2(0x111)+_0x184d31[_0x375da2(0xd9)](0x1)+_0x375da2(0xf7)),_0x40730d++;continue;}console[_0x375da2(0x11c)]('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x2c13ab['id']+'\x20(age:\x20'+_0x184d31[_0x375da2(0xd9)](0x1)+'h)'),await this['checkSinglePayment'](_0x2c13ab),_0x960c45++,await new Promise(_0x4874ce=>setTimeout(_0x4874ce,0x7d0));}catch(_0x5dbcf8){console[_0x375da2(0x19c)](_0x375da2(0xfa)+_0x2c13ab['id']+':',_0x5dbcf8),this['logCoinToPayError'](_0x2c13ab['id'],_0x2c13ab[_0x375da2(0x16a)]||'unknown',_0x5dbcf8,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x2c13ab['amount'],'paymentCurrency':_0x2c13ab['currency'],'shopId':_0x2c13ab['shopId'],'createdAt':_0x2c13ab[_0x375da2(0x10b)]}),loggerService_1[_0x375da2(0xff)][_0x375da2(0x188)](_0x375da2(0x196),'/status/'+_0x2c13ab[_0x375da2(0x16a)],_0x5dbcf8);}}console['log']('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x960c45+'\x20checked,\x20'+_0x40730d+_0x375da2(0x118)+_0x2e79f9['length']+_0x375da2(0x119));}catch(_0x49aebc){console['error']('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x49aebc);}}async[a37_0x2abe7d(0xf3)](_0x3b11fe){const _0x469a91=a37_0x2abe7d,_0x50b649=[],_0x5f0edb=new Date();_0x5f0edb[_0x469a91(0xdd)](_0x5f0edb[_0x469a91(0x10c)]()-this[_0x469a91(0xe3)]),console[_0x469a91(0x11c)](_0x469a91(0x11a)+this[_0x469a91(0xe3)]+_0x469a91(0x194)+_0x5f0edb['toISOString']()+')');for(const _0x1a89ba of _0x3b11fe){if(_0x1a89ba[_0x469a91(0x10b)]<_0x5f0edb){console[_0x469a91(0x11c)](_0x469a91(0x171)+_0x1a89ba['id']+_0x469a91(0x17a)+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x469a91(0x18f)](_0x1a89ba['id'],_0x1a89ba[_0x469a91(0x16a)]||_0x469a91(0xd8),_0x469a91(0x100),'EXPIRED','auto_expire',{'reason':_0x469a91(0x14c)+this['EXPIRY_DAYS']+_0x469a91(0x121),'createdAt':_0x1a89ba[_0x469a91(0x10b)],'daysSinceCreation':Math[_0x469a91(0xd7)]((Date[_0x469a91(0x138)]()-_0x1a89ba[_0x469a91(0x10b)][_0x469a91(0xfc)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x1a89ba[_0x469a91(0x144)],'paymentCurrency':_0x1a89ba[_0x469a91(0x155)],'shopId':_0x1a89ba[_0x469a91(0xe4)]}),await database_1['default']['payment']['update']({'where':{'id':_0x1a89ba['id']},'data':{'status':_0x469a91(0x151),'updatedAt':new Date(),'adminNotes':_0x469a91(0x113)+this[_0x469a91(0xe3)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1['default'][_0x469a91(0xea)][_0x469a91(0xdf)]({'data':{'paymentId':_0x1a89ba['id'],'shopId':_0x1a89ba[_0x469a91(0xe4)],'event':_0x469a91(0xf1),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x469a91(0x14c)+this[_0x469a91(0xe3)]+_0x469a91(0x121),'createdAt':_0x1a89ba[_0x469a91(0x10b)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x469a91(0xd7)]((Date[_0x469a91(0x138)]()-_0x1a89ba[_0x469a91(0x10b)][_0x469a91(0xfc)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x469a91(0xec)](_0x1a89ba,_0x469a91(0x151)),await this['sendPaymentStatusNotification'](_0x1a89ba,_0x469a91(0x151)),this[_0x469a91(0x1a2)](_0x1a89ba['id']),_0x50b649[_0x469a91(0x186)](_0x1a89ba['id']),console[_0x469a91(0x11c)](_0x469a91(0xcc)+_0x1a89ba['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x469a91(0xe3)]+'-day\x20timeout');}catch(_0x4ce36c){console[_0x469a91(0x19c)]('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x1a89ba['id']+':',_0x4ce36c),this['logCoinToPayError'](_0x1a89ba['id'],_0x1a89ba[_0x469a91(0x16a)]||_0x469a91(0xd8),_0x4ce36c,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x1a89ba['createdAt'],'daysSinceCreation':Math[_0x469a91(0xd7)]((Date[_0x469a91(0x138)]()-_0x1a89ba[_0x469a91(0x10b)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x50b649;}async[a37_0x2abe7d(0x147)](_0x4eaae9){const _0x1b4454=a37_0x2abe7d;if(!_0x4eaae9[_0x1b4454(0x16a)]){console['log'](_0x1b4454(0xda)+_0x4eaae9['id']+_0x1b4454(0x126));return;}console[_0x1b4454(0x11c)](_0x1b4454(0xf8)+_0x4eaae9['id']+'\x20('+_0x4eaae9[_0x1b4454(0x16a)]+')');try{const _0x14154c=await this[_0x1b4454(0x162)][_0x1b4454(0x193)](_0x4eaae9[_0x1b4454(0x16a)]);console[_0x1b4454(0x11c)](_0x1b4454(0x114)+_0x4eaae9['id']+_0x1b4454(0x127)+_0x14154c[_0x1b4454(0x161)]);_0x14154c[_0x1b4454(0x122)]&&console[_0x1b4454(0x11c)](_0x1b4454(0x114)+_0x4eaae9['id']+'\x20details:',{'iban':_0x14154c[_0x1b4454(0x122)][_0x1b4454(0x160)]||_0x1b4454(0x102),'transactionId':_0x14154c[_0x1b4454(0x122)]['transactionId'],'createdOn':_0x14154c['paymentDetails']['createdOn'],'confirmedOn':_0x14154c[_0x1b4454(0x122)]['confirmedOn']||_0x1b4454(0x167)});if(_0x14154c[_0x1b4454(0x161)]!==_0x4eaae9[_0x1b4454(0x161)]){console['log'](_0x1b4454(0x128)+_0x4eaae9['id']+_0x1b4454(0x129)+_0x4eaae9['status']+'\x20to\x20'+_0x14154c[_0x1b4454(0x161)]),this['logCoinToPayStatus'](_0x4eaae9['id'],_0x4eaae9['gatewayPaymentId'],_0x4eaae9['status'],_0x14154c[_0x1b4454(0x161)],_0x1b4454(0x10f),{'paymentDetails':_0x14154c[_0x1b4454(0x122)],'amount':_0x14154c[_0x1b4454(0x144)],'currency':_0x14154c[_0x1b4454(0x155)],'shopId':_0x4eaae9[_0x1b4454(0xe4)],'checkTimestamp':new Date()['toISOString']()});const _0x1d27d9={'status':_0x14154c[_0x1b4454(0x161)],'updatedAt':new Date()};_0x14154c[_0x1b4454(0x161)]===_0x1b4454(0x18b)&&_0x4eaae9[_0x1b4454(0x161)]!==_0x1b4454(0x18b)&&(_0x1d27d9[_0x1b4454(0xf0)]=new Date(),console[_0x1b4454(0x11c)](_0x1b4454(0xd0)+_0x4eaae9['id']+_0x1b4454(0xf2)+_0x1d27d9[_0x1b4454(0xf0)][_0x1b4454(0x106)]()));if(_0x14154c[_0x1b4454(0x122)]){const _0xec0921=_0x14154c['paymentDetails'];_0xec0921[_0x1b4454(0x160)]&&(_0x1d27d9[_0x1b4454(0x109)]=_0xec0921[_0x1b4454(0x160)],console[_0x1b4454(0x11c)](_0x1b4454(0x13b)+_0xec0921[_0x1b4454(0x160)]));if(_0xec0921[_0x1b4454(0x103)]){const _0x597dfe=_0x4eaae9[_0x1b4454(0x130)]||'',_0x5d75c6='Bank\x20Details:\x20'+_0xec0921['bankDetails'];_0x1d27d9[_0x1b4454(0x130)]=_0x597dfe?_0x597dfe+'\x0a\x0a'+_0x5d75c6:_0x5d75c6,console[_0x1b4454(0x11c)](_0x1b4454(0x134));}_0xec0921[_0x1b4454(0x148)]&&console[_0x1b4454(0x11c)]('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0xec0921[_0x1b4454(0x148)]),_0xec0921['confirmedOn']&&console['log']('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0xec0921['confirmedOn']);}await database_1[_0x1b4454(0x140)][_0x1b4454(0x18d)][_0x1b4454(0x104)]({'where':{'id':_0x4eaae9['id']},'data':_0x1d27d9}),await database_1[_0x1b4454(0x140)][_0x1b4454(0xea)][_0x1b4454(0xdf)]({'data':{'paymentId':_0x4eaae9['id'],'shopId':_0x4eaae9[_0x1b4454(0xe4)],'event':_0x1b4454(0x135)+_0x14154c[_0x1b4454(0x161)][_0x1b4454(0x117)](),'statusCode':0xc8,'responseBody':JSON[_0x1b4454(0x10d)]({'oldStatus':_0x4eaae9[_0x1b4454(0x161)],'newStatus':_0x14154c[_0x1b4454(0x161)],'paymentDetails':_0x14154c[_0x1b4454(0x122)],'checkedAt':new Date()[_0x1b4454(0x106)]()})}}),await this['sendShopWebhook'](_0x4eaae9,_0x14154c[_0x1b4454(0x161)]),await this[_0x1b4454(0x169)](_0x4eaae9,_0x14154c[_0x1b4454(0x161)]),_0x14154c[_0x1b4454(0x161)]!==_0x1b4454(0x100)&&(console[_0x1b4454(0x11c)]('🧹\x20[CHECK]\x20Payment\x20'+_0x4eaae9['id']+'\x20status\x20changed\x20to\x20'+_0x14154c[_0x1b4454(0x161)]+_0x1b4454(0x164)),this['clearPaymentTimers'](_0x4eaae9['id'])),console[_0x1b4454(0x11c)](_0x1b4454(0x13a)+_0x4eaae9['id']+_0x1b4454(0x158));}else console['log'](_0x1b4454(0x114)+_0x4eaae9['id']+_0x1b4454(0xe5)+_0x14154c['status']+')'),this[_0x1b4454(0x18f)](_0x4eaae9['id'],_0x4eaae9[_0x1b4454(0x16a)],_0x4eaae9[_0x1b4454(0x161)],_0x14154c['status'],_0x1b4454(0x10f),{'statusUnchanged':!![],'paymentDetails':_0x14154c[_0x1b4454(0x122)],'amount':_0x14154c[_0x1b4454(0x144)],'currency':_0x14154c[_0x1b4454(0x155)],'shopId':_0x4eaae9[_0x1b4454(0xe4)],'checkTimestamp':new Date()[_0x1b4454(0x106)]()});}catch(_0x58772e){console['error'](_0x1b4454(0x132)+_0x4eaae9['id']+':',_0x58772e),this[_0x1b4454(0x180)](_0x4eaae9['id'],_0x4eaae9['gatewayPaymentId'],_0x58772e,_0x1b4454(0x10f),{'paymentAmount':_0x4eaae9['amount'],'paymentCurrency':_0x4eaae9[_0x1b4454(0x155)],'shopId':_0x4eaae9[_0x1b4454(0xe4)],'createdAt':_0x4eaae9[_0x1b4454(0x10b)]}),await database_1[_0x1b4454(0x140)]['webhookLog']['create']({'data':{'paymentId':_0x4eaae9['id'],'shopId':_0x4eaae9[_0x1b4454(0xe4)],'event':_0x1b4454(0x141),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x58772e instanceof Error?_0x58772e[_0x1b4454(0x14a)]:'Unknown\x20error','gatewayPaymentId':_0x4eaae9[_0x1b4454(0x16a)],'checkedAt':new Date()['toISOString']()})}});}}async[a37_0x2abe7d(0xec)](_0x511c47,_0x43174){const _0x3af2e7=a37_0x2abe7d,_0x43d5a4=Date[_0x3af2e7(0x138)]();try{const _0xa35d5a=_0x511c47[_0x3af2e7(0x19a)],_0x206442=_0xa35d5a[_0x3af2e7(0x142)];if(!_0x206442?.[_0x3af2e7(0xeb)]){console[_0x3af2e7(0x11c)](_0x3af2e7(0xe6)+_0xa35d5a['id']);return;}const _0x2e8155=_0x43174===_0x3af2e7(0x18b)?'payment.success':_0x43174===_0x3af2e7(0x123)?_0x3af2e7(0xf9):_0x43174===_0x3af2e7(0x151)?_0x3af2e7(0xf9):_0x3af2e7(0x168);if(!_0x206442[_0x3af2e7(0x189)]?.[_0x3af2e7(0x12a)](_0x2e8155)){console[_0x3af2e7(0x11c)](_0x3af2e7(0xed)+_0x2e8155+_0x3af2e7(0x18a)+_0xa35d5a['id']);return;}const _0xa9878a={'event':_0x2e8155,'payment':{'id':_0x511c47['id'],'order_id':_0x511c47[_0x3af2e7(0xd3)],'gateway_order_id':_0x511c47['gatewayOrderId'],'gateway':'0100','amount':_0x511c47[_0x3af2e7(0x144)],'currency':_0x511c47[_0x3af2e7(0x155)],'status':_0x43174['toLowerCase'](),'customer_email':_0x511c47[_0x3af2e7(0x176)],'customer_name':_0x511c47['customerName'],'created_at':_0x511c47[_0x3af2e7(0x10b)],'updated_at':new Date()}},_0x454eea=await fetch(_0x206442[_0x3af2e7(0xeb)],{'method':_0x3af2e7(0x146),'headers':{'Content-Type':'application/json','User-Agent':_0x3af2e7(0x131)},'body':JSON[_0x3af2e7(0x10d)](_0xa9878a)}),_0x4acc91=Date['now']()-_0x43d5a4,_0x1d3c60=_0x454eea['ok']?_0x3af2e7(0x136):await _0x454eea['text']();loggerService_1[_0x3af2e7(0xff)][_0x3af2e7(0x145)](_0x511c47[_0x3af2e7(0xe4)],_0x206442[_0x3af2e7(0xeb)],_0x2e8155,_0x454eea[_0x3af2e7(0x161)],_0x4acc91,_0xa9878a),console[_0x3af2e7(0x11c)]('Shop\x20webhook\x20sent\x20to\x20'+_0x206442[_0x3af2e7(0xeb)]+_0x3af2e7(0x12b)+_0x454eea[_0x3af2e7(0x161)]+'\x20('+_0x4acc91+'ms)');}catch(_0x14e762){console[_0x3af2e7(0x19c)](_0x3af2e7(0x170),_0x14e762),loggerService_1[_0x3af2e7(0xff)]['logShopWebhookError'](_0x511c47[_0x3af2e7(0xe4)],_0x511c47[_0x3af2e7(0x19a)]?.['settings']?.[_0x3af2e7(0xeb)]||_0x3af2e7(0xd8),_0x3af2e7(0x12d),_0x14e762,{});}}async['sendPaymentStatusNotification'](_0xbfed73,_0x37c6f8){const _0x596794=a37_0x2abe7d;try{const _0x3e5738={'PENDING':_0x596794(0x18e),'PAID':_0x596794(0x15d),'FAILED':'failed','EXPIRED':_0x596794(0x192)},_0x1b71ba=_0x3e5738[_0x37c6f8];if(!_0x1b71ba||_0x1b71ba==='created')return;await telegramBotService_1[_0x596794(0x110)][_0x596794(0xfe)](_0xbfed73[_0x596794(0xe4)],_0xbfed73,_0x1b71ba);}catch(_0x17a935){console['error'](_0x596794(0x149),_0x17a935);}}async['checkPaymentById'](_0x5ab3d8){const _0x4b6fe2=a37_0x2abe7d;console[_0x4b6fe2(0x11c)]('🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x5ab3d8);const _0x4ae7fc=await database_1[_0x4b6fe2(0x140)][_0x4b6fe2(0x18d)][_0x4b6fe2(0x137)]({'where':{'id':_0x5ab3d8},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4ae7fc)throw new Error(_0x4b6fe2(0x17e));if(_0x4ae7fc[_0x4b6fe2(0xfd)]!=='cointopay')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x4b6fe2(0x11c)](_0x4b6fe2(0x179)+_0x5ab3d8),await this['checkSinglePayment'](_0x4ae7fc),console[_0x4b6fe2(0x11c)](_0x4b6fe2(0xf4)+_0x5ab3d8);}[a37_0x2abe7d(0x174)](){const _0x440d8e=a37_0x2abe7d,_0x4f357f=this[_0x440d8e(0x18c)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x2d087a=Array[_0x440d8e(0x11e)](this['paymentTimers'][_0x440d8e(0xd2)]())['map'](_0x46d87f=>({'paymentId':_0x46d87f[_0x440d8e(0x19b)],'gatewayPaymentId':_0x46d87f[_0x440d8e(0x16a)],'createdAt':_0x46d87f['createdAt'],'timersCount':_0x46d87f[_0x440d8e(0xd1)][_0x440d8e(0x185)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x440d8e(0xe3)],'activeIndividualTimers':this['paymentTimers'][_0x440d8e(0x157)],'nextGlobalCheckIn':_0x4f357f,'paymentTimersDetails':_0x2d087a};}['getPaymentTimerInfo'](_0x3a73e0){const _0x24e05a=a37_0x2abe7d,_0x5a3992=this[_0x24e05a(0x16d)][_0x24e05a(0x15f)](_0x3a73e0);if(_0x5a3992)return{'hasTimers':!![],'timersCount':_0x5a3992['timers'][_0x24e05a(0x185)],'createdAt':_0x5a3992[_0x24e05a(0x10b)],'gatewayPaymentId':_0x5a3992[_0x24e05a(0x16a)]};return{'hasTimers':![]};}}exports[a37_0x2abe7d(0x154)]=CoinToPayStatusService,exports[a37_0x2abe7d(0x14e)]=new CoinToPayStatusService();function a37_0xcd44(_0x5dc3e2,_0x18d453){const _0xd64ab1=a37_0xd64a();return a37_0xcd44=function(_0xcd44e7,_0x372b06){_0xcd44e7=_0xcd44e7-0xc9;let _0x3bc604=_0xd64ab1[_0xcd44e7];return _0x3bc604;},a37_0xcd44(_0x5dc3e2,_0x18d453);}function a37_0xd64a(){const _0x6d458b=['211311EhNchs','from','📊\x20[HOURLY]\x20Payment\x20','3UwEUOr','\x20days','paymentDetails','FAILED','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','./gateways/coinToPayService','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20status:\x20','🔄\x20[CHECK]\x20Updating\x20payment\x20','\x20status\x20from\x20','includes','\x20with\x20status\x20','__importDefault','webhook_send','description','checkAllPendingPayments','adminNotes','TesSoft\x20Payment\x20System/1.0','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','cointopay_status_check_','Success','findUnique','now','❌\x20[HOURLY]\x20Payment\x20','✅\x20[CHECK]\x20Payment\x20','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','10VLUhny','5\x20minutes','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','default','cointopay_status_check_error','settings','\x20to\x20clear','amount','logShopWebhookSent','POST','checkSinglePayment','transactionId','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','message','4793390dChmOb','Payment\x20older\x20than\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','coinToPayStatusService','forEach','🪙\x20[GLOBAL]\x20Found\x20','EXPIRED','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','checkSinglePaymentById','CoinToPayStatusService','currency','CoinToPayService','size','\x20updated\x20successfully','stopPeriodicStatusCheck','\x20status\x20is\x20','\x20for\x20payment\x20','219163PwrnIl','paid','.\x20Remaining\x20active\x20timers:\x20','get','iban','status','coinToPayService','\x20pending\x20CoinToPay\x20payments',',\x20clearing\x20individual\x20timers','574710XBovlj','\x20\x20\x20-\x20Status:\x20','not\x20confirmed','payment.pending','sendPaymentStatusNotification','gatewayPaymentId','./loggerService','startPeriodicStatusCheck','paymentTimers','timestamp','\x20current\x20status:\x20','Failed\x20to\x20send\x20shop\x20webhook:','⏰\x20[EXPIRY]\x20Payment\x20','⏰\x20[HOURLY]\x20Payment\x20','\x20individual\x20payment\x20timers','getServiceStats','COINTOPAY_ERROR','customerEmail','1\x20minute','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20is\x20older\x20than\x20','\x20in\x20','🪙\x20CoinToPayStatusService\x20initialized','\x20is\x20valid\x20for\x20checking,\x20proceeding...','Payment\x20not\x20found','delete','logCoinToPayError','13269102ObWqgB','2013076rAHMXQ','\x20\x20\x20📅\x20Time:\x20','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','length','push','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','logWhiteDomainError','webhookEvents','\x20not\x20enabled\x20for\x20shop\x20','PAID','globalCheckInterval','payment','created','logCoinToPayStatus','defineProperty','schedule_created','expired','checkPaymentStatus','\x20days\x20(created\x20before\x20','⏰\x20[GLOBAL]\x20Payment\x20','cointopay','\x20triggered\x20for\x20payment\x20','\x20\x20\x20📝\x20Context:','\x20->\x20','shop','paymentId','error','delay','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20\x20\x20-\x20Gateway:\x20','⏰\x20[GLOBAL]\x20Found\x20','\x20expired\x20CoinToPay\x20payments','clearPaymentTimers','schedulePaymentChecks',',\x20stopping\x20individual\x20checks','\x20\x20\x20-\x20Amount:\x20','✅\x20[EXPIRY]\x20Payment\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','catch','\x20has\x20no\x20gatewayPaymentId','💰\x20[CHECK]\x20Payment\x20','timers','values','orderId','\x20not\x20found\x20in\x20database','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','floor','unknown','toFixed','⚠️\x20[CHECK]\x20Payment\x20','🛑\x20[SHUTDOWN]\x20Cleared\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','setDate','has','create','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','🧹\x20[DEBUG]\x20Clearing\x20','EXPIRY_DAYS','shopId','\x20status\x20unchanged\x20(','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20\x20\x20-\x20ShopId:\x20','❌\x20[CHECK]\x20Payment\x20','\x20\x20\x20❌\x20Error:\x20','webhookLog','webhookUrl','sendShopWebhook','Webhook\x20event\x20','findMany','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','paidAt','cointopay_auto_expired','\x20marked\x20as\x20paid\x20at:\x20','checkExpiredPayments','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','13238dSHjpi','h),\x20skipping\x20global\x20check','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','payment.failed','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','__esModule','getTime','gateway','sendPaymentNotification','loggerService','PENDING','53CjRDhH','not\x20found','bankDetails','update','GLOBAL_CHECK_INTERVAL_MS','toISOString','\x20\x20\x20📝\x20Details:','8Cxladh','remitterIban','\x20found:','createdAt','getDate','stringify','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','status_check','telegramBotService','\x20is\x20too\x20new\x20(','COINTOPAY_STATUS_CHANGE','Automatically\x20expired\x20after\x20','📊\x20[CHECK]\x20Payment\x20','🪙\x20[DEBUG]\x20Creating\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','toLowerCase','\x20skipped,\x20','\x20expired','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20\x20\x20📍\x20Source:\x20','log'];a37_0xd64a=function(){return _0x6d458b;};return a37_0xd64a();}