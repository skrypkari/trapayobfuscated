'use strict';const a35_0x1e9e41=a35_0x5244;(function(_0x3f9d02,_0x44b835){const _0x36be89=a35_0x5244,_0x352fdc=_0x3f9d02();while(!![]){try{const _0x146088=-parseInt(_0x36be89(0x15f))/0x1*(parseInt(_0x36be89(0x119))/0x2)+-parseInt(_0x36be89(0x135))/0x3*(parseInt(_0x36be89(0xf8))/0x4)+-parseInt(_0x36be89(0x103))/0x5*(parseInt(_0x36be89(0x185))/0x6)+parseInt(_0x36be89(0x183))/0x7+-parseInt(_0x36be89(0x112))/0x8*(parseInt(_0x36be89(0x117))/0x9)+parseInt(_0x36be89(0x12c))/0xa*(-parseInt(_0x36be89(0x16a))/0xb)+parseInt(_0x36be89(0x16d))/0xc;if(_0x146088===_0x44b835)break;else _0x352fdc['push'](_0x352fdc['shift']());}catch(_0x5f2710){_0x352fdc['push'](_0x352fdc['shift']());}}}(a35_0x9df3,0xa5c12));var __importDefault=this&&this['__importDefault']||function(_0x530bf4){return _0x530bf4&&_0x530bf4['__esModule']?_0x530bf4:{'default':_0x530bf4};};Object[a35_0x1e9e41(0x162)](exports,a35_0x1e9e41(0x15e),{'value':!![]}),exports[a35_0x1e9e41(0x175)]=exports['CoinToPayStatusService']=void 0x0;function a35_0x5244(_0x238f9b,_0x485b70){const _0x9df30d=a35_0x9df3();return a35_0x5244=function(_0x524499,_0x2aace6){_0x524499=_0x524499-0xf7;let _0x42aad2=_0x9df30d[_0x524499];return _0x42aad2;},a35_0x5244(_0x238f9b,_0x485b70);}const coinToPayService_1=require(a35_0x1e9e41(0x14e)),database_1=__importDefault(require(a35_0x1e9e41(0x109))),telegramBotService_1=require(a35_0x1e9e41(0x115)),loggerService_1=require(a35_0x1e9e41(0x167));function a35_0x9df3(){const _0x1973e8=['findUnique','coinToPayStatusService','create','payment','EXPIRED','‚úÖ\x20Completed\x20checking\x20','PENDING','settings','Initial\x20CoinToPay\x20status\x20check\x20failed:','confirmedOn','CoinToPayStatusService','\x20days','createdOn','checkExpiredPayments','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','7333711JXGUbn','paid','38964jFDGMr','logWhiteDomainError','\x20with\x20status\x20','‚úÖ\x20Payment\x20','orderId','188116NFfBKA','created','gatewayPaymentId','checkPaymentById','‚ö†Ô∏è\x20Payment\x20','update','cointopay_status_check_error','shopId','sendPaymentStatusNotification','cointopay','Failed\x20to\x20check\x20payment\x20','730VYWcZf','checkSinglePayment','üîÑ\x20Updating\x20payment\x20','loggerService','checkAllPendingPayments','iban','../config/database','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','customerName','EXPIRY_DAYS','webhookEvents','\x20days\x20without\x20payment\x20confirmation','paymentDetails','floor','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','227152qcJxBt','Bank\x20Details:\x20','üè¶\x20Saved\x20IBAN:\x20','./telegramBotService','payment.success','396GUDigN','toISOString','2XiHPhk','includes','webhookUrl','\x20days,\x20marking\x20as\x20EXPIRED','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','adminNotes','\x20has\x20no\x20gatewayPaymentId,\x20skipping','logShopWebhookError','getTime','üîç\x20Checking\x20CoinToPay\x20payment\x20','checkInterval','bankDetails','CHECK_INTERVAL_MS','Webhook\x20event\x20','getServiceStats','remitterIban','POST','\x20CoinToPay\x20payments','Payment\x20older\x20than\x20','10NvQbxJ','findMany','paidAt','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20not\x20enabled\x20for\x20shop\x20','catch','-day\x20timeout','toLowerCase','‚è∞\x20Payment\x20','33FVsXzU','not\x20found','PAID','\x20details:','default','customerEmail','ü™ô\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','createdAt','status','failed','üìä\x20Payment\x20','not\x20confirmed','error','0100','‚úÖ\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','length','üõë\x20CoinToPay\x20status\x20checking\x20stopped','\x20days\x20(created\x20before\x20','\x20is\x20older\x20than\x20','message','stopPeriodicStatusCheck','\x20marked\x20as\x20paid\x20at:\x20','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','Shop\x20webhook\x20sent\x20to\x20','CoinToPayService','./gateways/coinToPayService','expired','\x20status:\x20','Payment\x20not\x20found','webhookLog','log','stringify','sendShopWebhook','payment.pending','shop','getDate','startPeriodicStatusCheck','\x20expired\x20CoinToPay\x20payments','Periodic\x20CoinToPay\x20status\x20check\x20failed:','Success','Failed\x20to\x20expire\x20payment\x20','__esModule','469513bTbPnL','\x20updated\x20successfully','transactionId','defineProperty','now','Unknown\x20error','Failed\x20to\x20send\x20shop\x20webhook:','‚úÖ\x20Transaction\x20confirmed\x20on:\x20','./loggerService','coinToPayService','logShopWebhookSent','4240874pkqerT','gateway','telegramBotService','38412996KnJmBY','payment.failed','‚è∞\x20Found\x20','text','/status/','ü™ô\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','push'];a35_0x9df3=function(){return _0x1973e8;};return a35_0x9df3();}class CoinToPayStatusService{constructor(){const _0x45f22c=a35_0x1e9e41;this[_0x45f22c(0x123)]=null,this[_0x45f22c(0x125)]=0x3c*0x3c*0x3e8,this[_0x45f22c(0x10c)]=0x5,this[_0x45f22c(0x168)]=new coinToPayService_1[(_0x45f22c(0x14d))]();}[a35_0x1e9e41(0x159)](){const _0x32d0d8=a35_0x1e9e41;console[_0x32d0d8(0x153)](_0x32d0d8(0x13b)),this['checkAllPendingPayments']()[_0x32d0d8(0x131)](_0x1a0551=>{const _0x2a8a33=_0x32d0d8;console[_0x2a8a33(0x141)](_0x2a8a33(0x17c),_0x1a0551);}),this['checkInterval']=setInterval(async()=>{const _0x561478=_0x32d0d8;try{await this['checkAllPendingPayments']();}catch(_0x2e131e){console[_0x561478(0x141)](_0x561478(0x15b),_0x2e131e);}},this[_0x32d0d8(0x125)]),console[_0x32d0d8(0x153)](_0x32d0d8(0x143));}[a35_0x1e9e41(0x149)](){const _0x1373d5=a35_0x1e9e41;this[_0x1373d5(0x123)]&&(clearInterval(this[_0x1373d5(0x123)]),this['checkInterval']=null,console[_0x1373d5(0x153)](_0x1373d5(0x145)));}async[a35_0x1e9e41(0x107)](){const _0x16596d=a35_0x1e9e41;try{const _0x47d1b2=await database_1[_0x16596d(0x139)][_0x16596d(0x177)][_0x16596d(0x12d)]({'where':{'gateway':_0x16596d(0x101),'status':_0x16596d(0x17a),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x47d1b2[_0x16596d(0x144)]===0x0){console['log'](_0x16596d(0x172));return;}console[_0x16596d(0x153)]('ü™ô\x20Checking\x20'+_0x47d1b2['length']+'\x20pending\x20CoinToPay\x20payments');const _0x1cbf5f=await this['checkExpiredPayments'](_0x47d1b2);console[_0x16596d(0x153)](_0x16596d(0x16f)+_0x1cbf5f['length']+_0x16596d(0x15a));for(const _0x541cba of _0x47d1b2){try{if(_0x1cbf5f['includes'](_0x541cba['id'])){console[_0x16596d(0x153)](_0x16596d(0x134)+_0x541cba['id']+_0x16596d(0x111));continue;}await this['checkSinglePayment'](_0x541cba),await new Promise(_0x10eeb9=>setTimeout(_0x10eeb9,0x7d0));}catch(_0x1ffcf5){console[_0x16596d(0x141)](_0x16596d(0x14b)+_0x541cba['id']+':',_0x1ffcf5),loggerService_1[_0x16596d(0x106)][_0x16596d(0x186)](_0x16596d(0x101),_0x16596d(0x171)+_0x541cba[_0x16596d(0xfa)],_0x1ffcf5);}}console[_0x16596d(0x153)](_0x16596d(0x179)+_0x47d1b2[_0x16596d(0x144)]+_0x16596d(0x12a));}catch(_0x2d2831){console[_0x16596d(0x141)](_0x16596d(0x182),_0x2d2831);}}async[a35_0x1e9e41(0x181)](_0x3fb8c2){const _0x74725a=a35_0x1e9e41,_0x57677a=[],_0x531af4=new Date();_0x531af4['setDate'](_0x531af4[_0x74725a(0x158)]()-this[_0x74725a(0x10c)]),console['log']('‚è∞\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x74725a(0x10c)]+_0x74725a(0x146)+_0x531af4['toISOString']()+')');for(const _0x3e9880 of _0x3fb8c2){if(_0x3e9880['createdAt']<_0x531af4){console[_0x74725a(0x153)](_0x74725a(0x134)+_0x3e9880['id']+_0x74725a(0x147)+this[_0x74725a(0x10c)]+_0x74725a(0x11c));try{await database_1['default'][_0x74725a(0x177)][_0x74725a(0xfd)]({'where':{'id':_0x3e9880['id']},'data':{'status':_0x74725a(0x178),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x74725a(0x10c)]+_0x74725a(0x10e)}}),await database_1['default'][_0x74725a(0x152)][_0x74725a(0x176)]({'data':{'paymentId':_0x3e9880['id'],'shopId':_0x3e9880['shopId'],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x74725a(0x154)]({'reason':_0x74725a(0x12b)+this['EXPIRY_DAYS']+_0x74725a(0x17f),'createdAt':_0x3e9880['createdAt'],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x74725a(0x110)]((Date[_0x74725a(0x163)]()-_0x3e9880['createdAt'][_0x74725a(0x121)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x74725a(0x155)](_0x3e9880,_0x74725a(0x178)),await this[_0x74725a(0x100)](_0x3e9880,_0x74725a(0x178)),_0x57677a[_0x74725a(0x173)](_0x3e9880['id']),console[_0x74725a(0x153)](_0x74725a(0x188)+_0x3e9880['id']+_0x74725a(0x12f)+this[_0x74725a(0x10c)]+_0x74725a(0x132));}catch(_0x5b23f4){console['error'](_0x74725a(0x15d)+_0x3e9880['id']+':',_0x5b23f4);}}}return _0x57677a;}async[a35_0x1e9e41(0x104)](_0x4c5e55){const _0x2ab36a=a35_0x1e9e41;if(!_0x4c5e55[_0x2ab36a(0xfa)]){console['log'](_0x2ab36a(0xfc)+_0x4c5e55['id']+_0x2ab36a(0x11f));return;}console[_0x2ab36a(0x153)](_0x2ab36a(0x122)+_0x4c5e55['id']+'\x20('+_0x4c5e55['gatewayPaymentId']+')');try{const _0x4eef65=await this[_0x2ab36a(0x168)]['checkPaymentStatus'](_0x4c5e55[_0x2ab36a(0xfa)]);console['log']('üìä\x20Payment\x20'+_0x4c5e55['id']+_0x2ab36a(0x150)+_0x4eef65[_0x2ab36a(0x13d)]);_0x4eef65[_0x2ab36a(0x10f)]&&console[_0x2ab36a(0x153)](_0x2ab36a(0x13f)+_0x4c5e55['id']+_0x2ab36a(0x138),{'iban':_0x4eef65[_0x2ab36a(0x10f)][_0x2ab36a(0x108)]||_0x2ab36a(0x136),'transactionId':_0x4eef65[_0x2ab36a(0x10f)]['transactionId'],'createdOn':_0x4eef65[_0x2ab36a(0x10f)][_0x2ab36a(0x180)],'confirmedOn':_0x4eef65['paymentDetails'][_0x2ab36a(0x17d)]||_0x2ab36a(0x140)});if(_0x4eef65[_0x2ab36a(0x13d)]!==_0x4c5e55[_0x2ab36a(0x13d)]){console[_0x2ab36a(0x153)](_0x2ab36a(0x105)+_0x4c5e55['id']+'\x20status\x20from\x20'+_0x4c5e55[_0x2ab36a(0x13d)]+'\x20to\x20'+_0x4eef65['status']);const _0x39d1d0={'status':_0x4eef65['status'],'updatedAt':new Date()};_0x4eef65[_0x2ab36a(0x13d)]===_0x2ab36a(0x137)&&_0x4c5e55[_0x2ab36a(0x13d)]!==_0x2ab36a(0x137)&&(_0x39d1d0[_0x2ab36a(0x12e)]=new Date(),console[_0x2ab36a(0x153)]('üí∞\x20Payment\x20'+_0x4c5e55['id']+_0x2ab36a(0x14a)+_0x39d1d0[_0x2ab36a(0x12e)][_0x2ab36a(0x118)]()));if(_0x4eef65['paymentDetails']){const _0x49fcee=_0x4eef65[_0x2ab36a(0x10f)];_0x49fcee['iban']&&(_0x39d1d0[_0x2ab36a(0x128)]=_0x49fcee[_0x2ab36a(0x108)],console[_0x2ab36a(0x153)](_0x2ab36a(0x114)+_0x49fcee[_0x2ab36a(0x108)]));if(_0x49fcee[_0x2ab36a(0x124)]){const _0x5071ab=_0x4c5e55['adminNotes']||'',_0x4241ea=_0x2ab36a(0x113)+_0x49fcee[_0x2ab36a(0x124)];_0x39d1d0[_0x2ab36a(0x11e)]=_0x5071ab?_0x5071ab+'\x0a\x0a'+_0x4241ea:_0x4241ea,console[_0x2ab36a(0x153)]('üè¶\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x49fcee['transactionId']&&console['log']('üÜî\x20Transaction\x20ID:\x20'+_0x49fcee[_0x2ab36a(0x161)]),_0x49fcee[_0x2ab36a(0x17d)]&&console['log'](_0x2ab36a(0x166)+_0x49fcee[_0x2ab36a(0x17d)]);}await database_1['default']['payment'][_0x2ab36a(0xfd)]({'where':{'id':_0x4c5e55['id']},'data':_0x39d1d0}),await database_1[_0x2ab36a(0x139)][_0x2ab36a(0x152)][_0x2ab36a(0x176)]({'data':{'paymentId':_0x4c5e55['id'],'shopId':_0x4c5e55['shopId'],'event':'cointopay_status_check_'+_0x4eef65['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x4c5e55[_0x2ab36a(0x13d)],'newStatus':_0x4eef65[_0x2ab36a(0x13d)],'paymentDetails':_0x4eef65[_0x2ab36a(0x10f)],'checkedAt':new Date()[_0x2ab36a(0x118)]()})}}),await this[_0x2ab36a(0x155)](_0x4c5e55,_0x4eef65['status']),await this[_0x2ab36a(0x100)](_0x4c5e55,_0x4eef65[_0x2ab36a(0x13d)]),console[_0x2ab36a(0x153)](_0x2ab36a(0x188)+_0x4c5e55['id']+_0x2ab36a(0x160));}else console[_0x2ab36a(0x153)]('üìä\x20Payment\x20'+_0x4c5e55['id']+'\x20status\x20unchanged\x20('+_0x4eef65[_0x2ab36a(0x13d)]+')');}catch(_0x4f6eaa){console[_0x2ab36a(0x141)](_0x2ab36a(0x102)+_0x4c5e55['id']+':',_0x4f6eaa),await database_1['default'][_0x2ab36a(0x152)][_0x2ab36a(0x176)]({'data':{'paymentId':_0x4c5e55['id'],'shopId':_0x4c5e55[_0x2ab36a(0xff)],'event':_0x2ab36a(0xfe),'statusCode':0x1f4,'responseBody':JSON[_0x2ab36a(0x154)]({'error':_0x4f6eaa instanceof Error?_0x4f6eaa[_0x2ab36a(0x148)]:_0x2ab36a(0x164),'gatewayPaymentId':_0x4c5e55[_0x2ab36a(0xfa)],'checkedAt':new Date()['toISOString']()})}});}}async[a35_0x1e9e41(0x155)](_0x409303,_0x5c7ac8){const _0x9eeb70=a35_0x1e9e41,_0x194880=Date[_0x9eeb70(0x163)]();try{const _0x19f73f=_0x409303[_0x9eeb70(0x157)],_0x47774b=_0x19f73f[_0x9eeb70(0x17b)];if(!_0x47774b?.[_0x9eeb70(0x11b)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x19f73f['id']);return;}const _0x52476a=_0x5c7ac8===_0x9eeb70(0x137)?_0x9eeb70(0x116):_0x5c7ac8==='FAILED'?_0x9eeb70(0x16e):_0x5c7ac8===_0x9eeb70(0x178)?_0x9eeb70(0x16e):_0x9eeb70(0x156);if(!_0x47774b[_0x9eeb70(0x10d)]?.[_0x9eeb70(0x11a)](_0x52476a)){console[_0x9eeb70(0x153)](_0x9eeb70(0x126)+_0x52476a+_0x9eeb70(0x130)+_0x19f73f['id']);return;}const _0x9903e0={'event':_0x52476a,'payment':{'id':_0x409303['id'],'order_id':_0x409303[_0x9eeb70(0xf7)],'gateway_order_id':_0x409303['gatewayOrderId'],'gateway':_0x9eeb70(0x142),'amount':_0x409303['amount'],'currency':_0x409303['currency'],'status':_0x5c7ac8[_0x9eeb70(0x133)](),'customer_email':_0x409303[_0x9eeb70(0x13a)],'customer_name':_0x409303[_0x9eeb70(0x10b)],'created_at':_0x409303[_0x9eeb70(0x13c)],'updated_at':new Date()}},_0x288929=await fetch(_0x47774b[_0x9eeb70(0x11b)],{'method':_0x9eeb70(0x129),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x9903e0)}),_0x4ae07c=Date['now']()-_0x194880,_0xef0eea=_0x288929['ok']?_0x9eeb70(0x15c):await _0x288929[_0x9eeb70(0x170)]();loggerService_1[_0x9eeb70(0x106)][_0x9eeb70(0x169)](_0x409303[_0x9eeb70(0xff)],_0x47774b['webhookUrl'],_0x52476a,_0x288929['status'],_0x4ae07c,_0x9903e0),console['log'](_0x9eeb70(0x14c)+_0x47774b[_0x9eeb70(0x11b)]+_0x9eeb70(0x187)+_0x288929[_0x9eeb70(0x13d)]+'\x20('+_0x4ae07c+'ms)');}catch(_0x1adf9a){console[_0x9eeb70(0x141)](_0x9eeb70(0x165),_0x1adf9a),loggerService_1[_0x9eeb70(0x106)][_0x9eeb70(0x120)](_0x409303[_0x9eeb70(0xff)],_0x409303[_0x9eeb70(0x157)]?.[_0x9eeb70(0x17b)]?.['webhookUrl']||'unknown','webhook_send',_0x1adf9a,{});}}async[a35_0x1e9e41(0x100)](_0x14151e,_0x721002){const _0x14757a=a35_0x1e9e41;try{const _0x56e29f={'PENDING':_0x14757a(0xf9),'PAID':_0x14757a(0x184),'FAILED':_0x14757a(0x13e),'EXPIRED':_0x14757a(0x14f)},_0x41260f=_0x56e29f[_0x721002];if(!_0x41260f||_0x41260f===_0x14757a(0xf9))return;await telegramBotService_1[_0x14757a(0x16c)]['sendPaymentNotification'](_0x14151e[_0x14757a(0xff)],_0x14151e,_0x41260f);}catch(_0x8da79a){console['error'](_0x14757a(0x10a),_0x8da79a);}}async[a35_0x1e9e41(0xfb)](_0x520a42){const _0x85c311=a35_0x1e9e41,_0x308c52=await database_1[_0x85c311(0x139)]['payment'][_0x85c311(0x174)]({'where':{'id':_0x520a42},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x308c52)throw new Error(_0x85c311(0x151));if(_0x308c52[_0x85c311(0x16b)]!==_0x85c311(0x101))throw new Error(_0x85c311(0x11d));await this[_0x85c311(0x104)](_0x308c52);}[a35_0x1e9e41(0x127)](){const _0x59dbf7=a35_0x1e9e41,_0x4e6c3a=this[_0x59dbf7(0x123)]?this['CHECK_INTERVAL_MS']:undefined;return{'isActive':!!this[_0x59dbf7(0x123)],'checkIntervalMinutes':this['CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x59dbf7(0x10c)],'nextCheckIn':_0x4e6c3a};}}exports[a35_0x1e9e41(0x17e)]=CoinToPayStatusService,exports[a35_0x1e9e41(0x175)]=new CoinToPayStatusService();