'use strict';function a37_0x5294(_0x746342,_0x33d5d9){const _0x24224e=a37_0x2422();return a37_0x5294=function(_0x5294bb,_0x45f254){_0x5294bb=_0x5294bb-0x166;let _0x2ce182=_0x24224e[_0x5294bb];return _0x2ce182;},a37_0x5294(_0x746342,_0x33d5d9);}const a37_0x358d5f=a37_0x5294;(function(_0x3e9488,_0x1cba99){const _0x18425c=a37_0x5294,_0x5dbc64=_0x3e9488();while(!![]){try{const _0xbc9f75=-parseInt(_0x18425c(0x216))/0x1*(parseInt(_0x18425c(0x189))/0x2)+parseInt(_0x18425c(0x21f))/0x3*(-parseInt(_0x18425c(0x1ff))/0x4)+-parseInt(_0x18425c(0x1bf))/0x5+-parseInt(_0x18425c(0x1ac))/0x6*(-parseInt(_0x18425c(0x213))/0x7)+parseInt(_0x18425c(0x170))/0x8+parseInt(_0x18425c(0x1ef))/0x9*(-parseInt(_0x18425c(0x197))/0xa)+parseInt(_0x18425c(0x1a2))/0xb*(parseInt(_0x18425c(0x1db))/0xc);if(_0xbc9f75===_0x1cba99)break;else _0x5dbc64['push'](_0x5dbc64['shift']());}catch(_0x4de418){_0x5dbc64['push'](_0x5dbc64['shift']());}}}(a37_0x2422,0x8fd9b));function a37_0x2422(){const _0x504d3f=['sendPaymentStatusNotification','1\x20minute','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20to\x20','create','\x20is\x20older\x20than\x20','loggerService','setDate','description','error','toLowerCase','2619290kNiSbH','cointopay_status_check_','/status/','\x20completed\x20for\x20payment\x20','default','\x20\x20\x20-\x20ShopId:\x20','toFixed','customerEmail','findUnique','telegramBotService','⏰\x20[EXPIRY]\x20Payment\x20','4295115AxUeux','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','FAILED','\x20\x20\x20-\x20GatewayPaymentId:\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','⏰\x20[GLOBAL]\x20Found\x20','application/json','sendShopWebhook','auto_expire','getDate','6oEkojp','clearPaymentTimers','\x20has\x20no\x20gatewayPaymentId,\x20skipping','createdAt','checkSinglePayment','forEach','checkPaymentById','sendPaymentNotification','COINTOPAY_STATUS_CHANGE','\x20days\x20(created\x20before\x20','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','from','🧹\x20[CHECK]\x20Payment\x20','./gateways/coinToPayService','Shop\x20webhook\x20sent\x20to\x20','\x20\x20\x20📊\x20Status:\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','../config/database','1601650CuAeEz','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','floor','getPaymentTimerInfo','\x20not\x20enabled\x20for\x20shop\x20','schedulePaymentChecks','webhookLog','currency','ms)','\x20seconds\x20(','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','not\x20found','Success','update','🔄\x20[CHECK]\x20Updating\x20payment\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','size','\x20pending\x20CoinToPay\x20payments','logCoinToPayStatus','stack','timers','\x20status\x20unchanged\x20(','\x20current\x20status:\x20','\x20for\x20payment\x20','GLOBAL_CHECK_INTERVAL_MS','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','💰\x20[CHECK]\x20Payment\x20','\x20in\x20','72ZICOUP','5\x20minutes','\x20not\x20found,\x20clearing\x20timers','gateway','shopId','\x20is\x20valid\x20for\x20checking,\x20proceeding...','set','paymentDetails','COINTOPAY_ERROR','stringify','unknown','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','✅\x20[CHECK]\x20Payment\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','gatewayPaymentId','\x20\x20\x20📝\x20Details:','createdOn','paidAt','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20skipped,\x20','36dfPujP','paymentTimers','adminNotes','0100','expired','not\x20confirmed','coinToPayService','📊\x20[CHECK]\x20Payment\x20','Bank\x20Details:\x20','checkExpiredPayments','\x20status\x20from\x20','EXPIRED','includes','logCoinToPayError','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','transactionId','16gmaIqv','status','now','\x20\x20\x20📍\x20Source:\x20','EXPIRY_DAYS','checkAllPendingPayments','settings','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','customerName','\x20status\x20is\x20','PENDING','Payment\x20older\x20than\x20','\x20->\x20','checkSinglePaymentById','✅\x20[TIMER]\x20Individual\x20check\x20#','cointopay_auto_expired','\x20\x20\x20📅\x20Time:\x20','\x20individual\x20payment\x20timers','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20found:','5052992UyNaDJ','values','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','929236dWFnVh','2\x20minutes','POST','schedule_created','getTime','🛑\x20[SHUTDOWN]\x20Cleared\x20','payment.success','TesSoft\x20Payment\x20System/1.0','\x20\x20\x20-\x20Gateway:\x20','350706zpmJRs','push','CoinToPayService','⏰\x20[HOURLY]\x20Payment\x20','⚠️\x20[CHECK]\x20Payment\x20','globalCheckInterval','delete','🪙\x20CoinToPayStatusService\x20initialized','-day\x20timeout','paid','\x20(after\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20not\x20found\x20in\x20database','PAID','\x20expired','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','coinToPayStatusService','payment.pending','\x20(age:\x20','\x20triggered\x20for\x20payment\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','Payment\x20not\x20found','__esModule','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','text','\x20\x20\x20-\x20Status:\x20','❌\x20[HOURLY]\x20Payment\x20','bankDetails','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','CoinToPayStatusService','\x20\x20\x20❌\x20Error:\x20','\x20timers\x20for\x20payment\x20','⏰\x20[GLOBAL]\x20Payment\x20','map','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20days\x20without\x20payment\x20confirmation','status_check','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',',\x20clearing\x20individual\x20timers','iban','\x20\x20\x20-\x20Amount:\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','remitterIban','checkPaymentStatus','Automatically\x20expired\x20after\x20','shop','amount','2315640HQAdcH','./loggerService','webhookUrl','orderId','logWhiteDomainError','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','logShopWebhookError','log','gatewayOrderId','\x20has\x20no\x20gatewayPaymentId','toISOString','get','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','length','timestamp','cointopay_status_check_error','logShopWebhookSent','\x20days','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','payment','confirmedOn','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','cointopay','delay','2GMfzQk','🪙\x20[DEBUG]\x20Creating\x20','webhook_send'];a37_0x2422=function(){return _0x504d3f;};return a37_0x2422();}var __importDefault=this&&this['__importDefault']||function(_0x10fe2b){const _0x399d58=a37_0x5294;return _0x10fe2b&&_0x10fe2b[_0x399d58(0x236)]?_0x10fe2b:{'default':_0x10fe2b};};Object['defineProperty'](exports,a37_0x358d5f(0x236),{'value':!![]}),exports[a37_0x358d5f(0x230)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a37_0x358d5f(0x1b9)),database_1=__importDefault(require(a37_0x358d5f(0x1be))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a37_0x358d5f(0x171));class CoinToPayStatusService{constructor(){const _0x4d6523=a37_0x358d5f;this[_0x4d6523(0x224)]=null,this[_0x4d6523(0x1d7)]=0x3c*0x3c*0x3e8,this[_0x4d6523(0x203)]=0x5,this['paymentTimers']=new Map(),this[_0x4d6523(0x1f5)]=new coinToPayService_1[(_0x4d6523(0x221))](),console[_0x4d6523(0x177)](_0x4d6523(0x226));}[a37_0x358d5f(0x1c4)](_0x197a69,_0x1caeaa){const _0xc141a9=a37_0x358d5f;console[_0xc141a9(0x177)](_0xc141a9(0x1e6)),console[_0xc141a9(0x177)]('\x20\x20\x20-\x20paymentId:\x20'+_0x197a69),console[_0xc141a9(0x177)](_0xc141a9(0x1ce)+_0x1caeaa),this[_0xc141a9(0x1ad)](_0x197a69);const _0x1cc2e5=[],_0x21683e=new Date(),_0x3480a7=[{'delay':0x1*0x3c*0x3e8,'description':_0xc141a9(0x18d)},{'delay':0x2*0x3c*0x3e8,'description':_0xc141a9(0x217)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0xc141a9(0x1dc)}];console[_0xc141a9(0x177)](_0xc141a9(0x18a)+_0x3480a7[_0xc141a9(0x17d)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x197a69);let _0xbc340f=0x0;_0x3480a7[_0xc141a9(0x1b1)]((_0x4d9605,_0x2e4e8d)=>{const _0x351cad=_0xc141a9;_0xbc340f+=_0x4d9605[_0x351cad(0x188)];const _0x543995=setTimeout(async()=>{const _0x2d43d0=_0x351cad;console[_0x2d43d0(0x177)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x2e4e8d+0x1)+_0x2d43d0(0x233)+_0x197a69+_0x2d43d0(0x229)+_0x4d9605['description']+')');try{await this[_0x2d43d0(0x20c)](_0x197a69),console[_0x2d43d0(0x177)](_0x2d43d0(0x20d)+(_0x2e4e8d+0x1)+_0x2d43d0(0x19a)+_0x197a69);}catch(_0x129e37){console[_0x2d43d0(0x195)](_0x2d43d0(0x215)+(_0x2e4e8d+0x1)+_0x2d43d0(0x1d6)+_0x197a69+':',_0x129e37),this[_0x2d43d0(0x1fc)](_0x197a69,_0x1caeaa,_0x129e37,_0x2d43d0(0x244),{'checkNumber':_0x2e4e8d+0x1,'scheduledAfter':_0x4d9605[_0x2d43d0(0x194)],'isIndividualCheck':!![]});}},_0xbc340f);_0x1cc2e5[_0x351cad(0x220)](_0x543995),console[_0x351cad(0x177)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x2e4e8d+0x1)+'\x20for\x20payment\x20'+_0x197a69+_0x351cad(0x1da)+_0xbc340f/0x3e8+_0x351cad(0x1c8)+_0x4d9605['description']+')');});const _0x4ae860=setInterval(async()=>{const _0x443c60=_0xc141a9;console['log'](_0x443c60(0x1bd)+_0x197a69);try{const _0x385cfb=await database_1[_0x443c60(0x19b)][_0x443c60(0x183)][_0x443c60(0x19f)]({'where':{'id':_0x197a69},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x385cfb){console[_0x443c60(0x177)](_0x443c60(0x23a)+_0x197a69+_0x443c60(0x1dd)),this[_0x443c60(0x1ad)](_0x197a69);return;}console[_0x443c60(0x177)]('📊\x20[HOURLY]\x20Payment\x20'+_0x197a69+_0x443c60(0x1d5)+_0x385cfb[_0x443c60(0x200)]);if(_0x385cfb[_0x443c60(0x200)]!==_0x443c60(0x209)){console['log']('✅\x20[HOURLY]\x20Payment\x20'+_0x197a69+'\x20status\x20is\x20'+_0x385cfb[_0x443c60(0x200)]+',\x20stopping\x20individual\x20checks'),this[_0x443c60(0x1ad)](_0x197a69);return;}const _0x5cfb7a=Math['floor']((Date[_0x443c60(0x201)]()-_0x385cfb[_0x443c60(0x1af)][_0x443c60(0x21a)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x5cfb7a>=this[_0x443c60(0x203)]){console[_0x443c60(0x177)](_0x443c60(0x222)+_0x197a69+_0x443c60(0x191)+this[_0x443c60(0x203)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x443c60(0x1ad)](_0x197a69);return;}await this[_0x443c60(0x20c)](_0x197a69),console[_0x443c60(0x177)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x197a69);}catch(_0x2d0c97){console[_0x443c60(0x195)](_0x443c60(0x1ed)+_0x197a69+':',_0x2d0c97),this[_0x443c60(0x1fc)](_0x197a69,_0x1caeaa,_0x2d0c97,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x1cc2e5[_0xc141a9(0x220)](_0x4ae860),this['paymentTimers'][_0xc141a9(0x1e1)](_0x197a69,{'timers':_0x1cc2e5,'paymentId':_0x197a69,'gatewayPaymentId':_0x1caeaa,'createdAt':_0x21683e}),console[_0xc141a9(0x177)](_0xc141a9(0x22f)+_0x3480a7['length']+_0xc141a9(0x23c)+_0x197a69),console['log']('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0xc141a9(0x1f0)][_0xc141a9(0x1cf)]),this[_0xc141a9(0x1d1)](_0x197a69,_0x1caeaa,_0xc141a9(0x209),_0xc141a9(0x209),_0xc141a9(0x244),{'action':_0xc141a9(0x219),'scheduledChecks':_0x3480a7[_0xc141a9(0x17d)],'firstCheckIn':_0x3480a7[0x0][_0xc141a9(0x188)]/0x3e8,'totalTimers':this[_0xc141a9(0x1f0)][_0xc141a9(0x1cf)]});}[a37_0x358d5f(0x1ad)](_0x31a598){const _0x3809e7=a37_0x358d5f,_0x1898ec=this[_0x3809e7(0x1f0)][_0x3809e7(0x17b)](_0x31a598);_0x1898ec?(console[_0x3809e7(0x177)]('🧹\x20[DEBUG]\x20Clearing\x20'+_0x1898ec[_0x3809e7(0x1d3)][_0x3809e7(0x17d)]+_0x3809e7(0x23f)+_0x31a598),_0x1898ec['timers']['forEach']((_0x574879,_0x23921e)=>{const _0x5e25b0=_0x3809e7;_0x574879&&(clearTimeout(_0x574879),clearInterval(_0x574879),console[_0x5e25b0(0x177)](_0x5e25b0(0x186)+(_0x23921e+0x1)+_0x5e25b0(0x1d6)+_0x31a598));}),this[_0x3809e7(0x1f0)][_0x3809e7(0x225)](_0x31a598),console['log'](_0x3809e7(0x22e)+_0x31a598+'.\x20Remaining\x20active\x20timers:\x20'+this['paymentTimers'][_0x3809e7(0x1cf)])):console['log']('⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x31a598+'\x20to\x20clear');}async[a37_0x358d5f(0x20c)](_0x17cabd){const _0x4fb53d=a37_0x358d5f;console[_0x4fb53d(0x177)](_0x4fb53d(0x211)+_0x17cabd);const _0x1ce00c=await database_1[_0x4fb53d(0x19b)][_0x4fb53d(0x183)][_0x4fb53d(0x19f)]({'where':{'id':_0x17cabd},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1ce00c){console['log']('❌\x20[CHECK]\x20Payment\x20'+_0x17cabd+_0x4fb53d(0x22b));return;}console['log'](_0x4fb53d(0x1f6)+_0x17cabd+_0x4fb53d(0x212)),console[_0x4fb53d(0x177)](_0x4fb53d(0x21e)+_0x1ce00c[_0x4fb53d(0x1de)]),console[_0x4fb53d(0x177)](_0x4fb53d(0x239)+_0x1ce00c[_0x4fb53d(0x200)]),console['log'](_0x4fb53d(0x1a5)+_0x1ce00c['gatewayPaymentId']),console[_0x4fb53d(0x177)](_0x4fb53d(0x167)+_0x1ce00c[_0x4fb53d(0x16f)]+'\x20'+_0x1ce00c[_0x4fb53d(0x1c6)]),console[_0x4fb53d(0x177)](_0x4fb53d(0x19c)+_0x1ce00c[_0x4fb53d(0x1df)]);if(_0x1ce00c[_0x4fb53d(0x1de)]!=='cointopay'){console[_0x4fb53d(0x177)](_0x4fb53d(0x223)+_0x17cabd+_0x4fb53d(0x168)+_0x1ce00c[_0x4fb53d(0x1de)]+')');return;}if(_0x1ce00c[_0x4fb53d(0x200)]!==_0x4fb53d(0x209)){console[_0x4fb53d(0x177)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x17cabd+_0x4fb53d(0x208)+_0x1ce00c[_0x4fb53d(0x200)]+',\x20stopping\x20individual\x20checks'),this[_0x4fb53d(0x1ad)](_0x17cabd);return;}if(!_0x1ce00c[_0x4fb53d(0x1e9)]){console[_0x4fb53d(0x177)](_0x4fb53d(0x223)+_0x17cabd+_0x4fb53d(0x179));return;}console['log'](_0x4fb53d(0x1e7)+_0x17cabd+_0x4fb53d(0x1e0)),await this[_0x4fb53d(0x1b0)](_0x1ce00c);}[a37_0x358d5f(0x1d1)](_0x198ed6,_0x27f6a3,_0x5c6274,_0x544a70,_0x2392a8,_0x389bc9){const _0x5d0062=a37_0x358d5f,_0x18dc23={'type':_0x5d0062(0x1b4),'paymentId':_0x198ed6,'gatewayPaymentId':_0x27f6a3,'oldStatus':_0x5c6274,'newStatus':_0x544a70,'source':_0x2392a8,'timestamp':new Date()['toISOString'](),'details':_0x389bc9||{}};loggerService_1[_0x5d0062(0x192)][_0x5d0062(0x1d1)](_0x18dc23),console[_0x5d0062(0x177)](_0x5d0062(0x17c)+_0x198ed6+'\x20('+_0x27f6a3+')'),console[_0x5d0062(0x177)](_0x5d0062(0x1bb)+_0x5c6274+_0x5d0062(0x20b)+_0x544a70),console[_0x5d0062(0x177)](_0x5d0062(0x202)+_0x2392a8),console[_0x5d0062(0x177)](_0x5d0062(0x20f)+_0x18dc23[_0x5d0062(0x17e)]),_0x389bc9&&console['log'](_0x5d0062(0x1ea),_0x389bc9);}[a37_0x358d5f(0x1fc)](_0x5a2219,_0x105f44,_0x5dd5ca,_0x19caa7,_0x4ff5a6){const _0x2973e8=a37_0x358d5f,_0x7b42d3={'type':_0x2973e8(0x1e3),'paymentId':_0x5a2219,'gatewayPaymentId':_0x105f44,'error':_0x5dd5ca instanceof Error?{'message':_0x5dd5ca['message'],'stack':_0x5dd5ca[_0x2973e8(0x1d2)]}:_0x5dd5ca,'source':_0x19caa7,'timestamp':new Date()['toISOString'](),'context':_0x4ff5a6||{}};loggerService_1[_0x2973e8(0x192)]['logCoinToPayError'](_0x7b42d3),console[_0x2973e8(0x195)](_0x2973e8(0x234)+_0x5a2219+'\x20('+_0x105f44+')'),console[_0x2973e8(0x195)](_0x2973e8(0x23e)+(_0x5dd5ca instanceof Error?_0x5dd5ca['message']:_0x5dd5ca)),console[_0x2973e8(0x195)](_0x2973e8(0x202)+_0x19caa7),console['error'](_0x2973e8(0x20f)+_0x7b42d3[_0x2973e8(0x17e)]),_0x4ff5a6&&console['error']('\x20\x20\x20📝\x20Context:',_0x4ff5a6);}['startPeriodicStatusCheck'](){const _0x5023f4=a37_0x358d5f;console[_0x5023f4(0x177)]('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x5023f4(0x204)]()['catch'](_0x50b6b3=>{const _0x2b1a7a=_0x5023f4;console[_0x2b1a7a(0x195)](_0x2b1a7a(0x1c0),_0x50b6b3);}),this[_0x5023f4(0x224)]=setInterval(async()=>{const _0x1a3048=_0x5023f4;try{console['log'](_0x1a3048(0x1e8)),await this[_0x1a3048(0x204)](),console[_0x1a3048(0x177)](_0x1a3048(0x1c9));}catch(_0x124755){console['error'](_0x1a3048(0x182),_0x124755);}},this[_0x5023f4(0x1d7)]),console[_0x5023f4(0x177)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}['stopPeriodicStatusCheck'](){const _0x2a0744=a37_0x358d5f;console[_0x2a0744(0x177)](_0x2a0744(0x242));this[_0x2a0744(0x224)]&&(clearInterval(this[_0x2a0744(0x224)]),this[_0x2a0744(0x224)]=null,console[_0x2a0744(0x177)](_0x2a0744(0x1b6)));const _0x5a8fe5=this[_0x2a0744(0x1f0)]['size'];for(const [_0x484302]of this['paymentTimers']){this[_0x2a0744(0x1ad)](_0x484302);}console[_0x2a0744(0x177)](_0x2a0744(0x21b)+_0x5a8fe5+_0x2a0744(0x210));}async[a37_0x358d5f(0x204)](){const _0x43d0bc=a37_0x358d5f;try{console[_0x43d0bc(0x177)](_0x43d0bc(0x1fd));const _0x5b9ee8=await database_1[_0x43d0bc(0x19b)][_0x43d0bc(0x183)]['findMany']({'where':{'gateway':_0x43d0bc(0x187),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x43d0bc(0x177)]('🪙\x20[GLOBAL]\x20Found\x20'+_0x5b9ee8[_0x43d0bc(0x17d)]+_0x43d0bc(0x1d0));if(_0x5b9ee8[_0x43d0bc(0x17d)]===0x0){console['log']('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x2615f9=await this[_0x43d0bc(0x1f8)](_0x5b9ee8);console[_0x43d0bc(0x177)](_0x43d0bc(0x1a7)+_0x2615f9['length']+'\x20expired\x20CoinToPay\x20payments');let _0x1bf207=0x0,_0x302d12=0x0;for(const _0x483696 of _0x5b9ee8){try{if(_0x2615f9[_0x43d0bc(0x1fb)](_0x483696['id'])){console['log']('⏰\x20[GLOBAL]\x20Payment\x20'+_0x483696['id']+_0x43d0bc(0x237)),_0x302d12++;continue;}if(this[_0x43d0bc(0x1f0)]['has'](_0x483696['id'])){console['log'](_0x43d0bc(0x240)+_0x483696['id']+_0x43d0bc(0x169)),_0x302d12++;continue;}const _0x50663c=(Date[_0x43d0bc(0x201)]()-_0x483696[_0x43d0bc(0x1af)][_0x43d0bc(0x21a)]())/(0x3e8*0x3c*0x3c);if(_0x50663c<0x1){console[_0x43d0bc(0x177)](_0x43d0bc(0x240)+_0x483696['id']+'\x20is\x20too\x20new\x20('+_0x50663c[_0x43d0bc(0x19d)](0x1)+'h),\x20skipping\x20global\x20check'),_0x302d12++;continue;}console[_0x43d0bc(0x177)](_0x43d0bc(0x1bc)+_0x483696['id']+_0x43d0bc(0x232)+_0x50663c[_0x43d0bc(0x19d)](0x1)+'h)'),await this[_0x43d0bc(0x1b0)](_0x483696),_0x1bf207++,await new Promise(_0x47d8d0=>setTimeout(_0x47d8d0,0x7d0));}catch(_0x3b7b45){console['error']('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x483696['id']+':',_0x3b7b45),this['logCoinToPayError'](_0x483696['id'],_0x483696[_0x43d0bc(0x1e9)]||_0x43d0bc(0x1e5),_0x3b7b45,_0x43d0bc(0x244),{'isGlobalCheck':!![],'paymentAmount':_0x483696['amount'],'paymentCurrency':_0x483696[_0x43d0bc(0x1c6)],'shopId':_0x483696[_0x43d0bc(0x1df)],'createdAt':_0x483696[_0x43d0bc(0x1af)]}),loggerService_1[_0x43d0bc(0x192)][_0x43d0bc(0x174)](_0x43d0bc(0x187),_0x43d0bc(0x199)+_0x483696['gatewayPaymentId'],_0x3b7b45);}}console[_0x43d0bc(0x177)]('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x1bf207+'\x20checked,\x20'+_0x302d12+_0x43d0bc(0x1ee)+_0x2615f9['length']+_0x43d0bc(0x22d));}catch(_0x575a26){console[_0x43d0bc(0x195)](_0x43d0bc(0x245),_0x575a26);}}async[a37_0x358d5f(0x1f8)](_0x4151f7){const _0x3783e5=a37_0x358d5f,_0x283bd6=[],_0x838030=new Date();_0x838030[_0x3783e5(0x193)](_0x838030[_0x3783e5(0x1ab)]()-this[_0x3783e5(0x203)]),console[_0x3783e5(0x177)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x3783e5(0x1b5)+_0x838030['toISOString']()+')');for(const _0x4a8ad9 of _0x4151f7){if(_0x4a8ad9[_0x3783e5(0x1af)]<_0x838030){console[_0x3783e5(0x177)](_0x3783e5(0x1a1)+_0x4a8ad9['id']+_0x3783e5(0x191)+this[_0x3783e5(0x203)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x3783e5(0x1d1)](_0x4a8ad9['id'],_0x4a8ad9['gatewayPaymentId']||_0x3783e5(0x1e5),_0x3783e5(0x209),'EXPIRED',_0x3783e5(0x1aa),{'reason':_0x3783e5(0x20a)+this[_0x3783e5(0x203)]+_0x3783e5(0x181),'createdAt':_0x4a8ad9[_0x3783e5(0x1af)],'daysSinceCreation':Math['floor']((Date['now']()-_0x4a8ad9[_0x3783e5(0x1af)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x4a8ad9[_0x3783e5(0x16f)],'paymentCurrency':_0x4a8ad9[_0x3783e5(0x1c6)],'shopId':_0x4a8ad9['shopId']}),await database_1[_0x3783e5(0x19b)][_0x3783e5(0x183)]['update']({'where':{'id':_0x4a8ad9['id']},'data':{'status':_0x3783e5(0x1fa),'updatedAt':new Date(),'adminNotes':_0x3783e5(0x16d)+this[_0x3783e5(0x203)]+_0x3783e5(0x243)}}),await database_1[_0x3783e5(0x19b)][_0x3783e5(0x1c5)][_0x3783e5(0x190)]({'data':{'paymentId':_0x4a8ad9['id'],'shopId':_0x4a8ad9[_0x3783e5(0x1df)],'event':_0x3783e5(0x20e),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x3783e5(0x20a)+this[_0x3783e5(0x203)]+_0x3783e5(0x181),'createdAt':_0x4a8ad9[_0x3783e5(0x1af)],'expiredAt':new Date()[_0x3783e5(0x17a)](),'daysSinceCreation':Math[_0x3783e5(0x1c1)]((Date[_0x3783e5(0x201)]()-_0x4a8ad9[_0x3783e5(0x1af)][_0x3783e5(0x21a)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x3783e5(0x1a9)](_0x4a8ad9,_0x3783e5(0x1fa)),await this[_0x3783e5(0x18c)](_0x4a8ad9,'EXPIRED'),this['clearPaymentTimers'](_0x4a8ad9['id']),_0x283bd6[_0x3783e5(0x220)](_0x4a8ad9['id']),console['log']('✅\x20[EXPIRY]\x20Payment\x20'+_0x4a8ad9['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x3783e5(0x203)]+_0x3783e5(0x227));}catch(_0x5a964d){console[_0x3783e5(0x195)](_0x3783e5(0x185)+_0x4a8ad9['id']+':',_0x5a964d),this[_0x3783e5(0x1fc)](_0x4a8ad9['id'],_0x4a8ad9[_0x3783e5(0x1e9)]||'unknown',_0x5a964d,_0x3783e5(0x1aa),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x4a8ad9[_0x3783e5(0x1af)],'daysSinceCreation':Math['floor']((Date[_0x3783e5(0x201)]()-_0x4a8ad9[_0x3783e5(0x1af)][_0x3783e5(0x21a)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x283bd6;}async[a37_0x358d5f(0x1b0)](_0x55c724){const _0x4347a8=a37_0x358d5f;if(!_0x55c724[_0x4347a8(0x1e9)]){console[_0x4347a8(0x177)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x55c724['id']+_0x4347a8(0x1ae));return;}console['log']('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x55c724['id']+'\x20('+_0x55c724[_0x4347a8(0x1e9)]+')');try{const _0x418ca9=await this[_0x4347a8(0x1f5)][_0x4347a8(0x16c)](_0x55c724['gatewayPaymentId']);console['log'](_0x4347a8(0x1f6)+_0x55c724['id']+'\x20status:\x20'+_0x418ca9[_0x4347a8(0x200)]);_0x418ca9[_0x4347a8(0x1e2)]&&console[_0x4347a8(0x177)](_0x4347a8(0x1f6)+_0x55c724['id']+'\x20details:',{'iban':_0x418ca9[_0x4347a8(0x1e2)][_0x4347a8(0x166)]||_0x4347a8(0x1ca),'transactionId':_0x418ca9[_0x4347a8(0x1e2)][_0x4347a8(0x1fe)],'createdOn':_0x418ca9[_0x4347a8(0x1e2)][_0x4347a8(0x1eb)],'confirmedOn':_0x418ca9[_0x4347a8(0x1e2)][_0x4347a8(0x184)]||_0x4347a8(0x1f4)});if(_0x418ca9[_0x4347a8(0x200)]!==_0x55c724[_0x4347a8(0x200)]){console['log'](_0x4347a8(0x1cd)+_0x55c724['id']+_0x4347a8(0x1f9)+_0x55c724[_0x4347a8(0x200)]+_0x4347a8(0x18f)+_0x418ca9[_0x4347a8(0x200)]),this['logCoinToPayStatus'](_0x55c724['id'],_0x55c724[_0x4347a8(0x1e9)],_0x55c724['status'],_0x418ca9[_0x4347a8(0x200)],_0x4347a8(0x244),{'paymentDetails':_0x418ca9['paymentDetails'],'amount':_0x418ca9[_0x4347a8(0x16f)],'currency':_0x418ca9[_0x4347a8(0x1c6)],'shopId':_0x55c724[_0x4347a8(0x1df)],'checkTimestamp':new Date()[_0x4347a8(0x17a)]()});const _0x50913c={'status':_0x418ca9[_0x4347a8(0x200)],'updatedAt':new Date()};_0x418ca9[_0x4347a8(0x200)]===_0x4347a8(0x22c)&&_0x55c724[_0x4347a8(0x200)]!==_0x4347a8(0x22c)&&(_0x50913c[_0x4347a8(0x1ec)]=new Date(),console[_0x4347a8(0x177)](_0x4347a8(0x1d9)+_0x55c724['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x50913c[_0x4347a8(0x1ec)][_0x4347a8(0x17a)]()));if(_0x418ca9[_0x4347a8(0x1e2)]){const _0x3a6624=_0x418ca9[_0x4347a8(0x1e2)];_0x3a6624[_0x4347a8(0x166)]&&(_0x50913c[_0x4347a8(0x16b)]=_0x3a6624[_0x4347a8(0x166)],console['log']('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x3a6624['iban']));if(_0x3a6624['bankDetails']){const _0x185ac3=_0x55c724[_0x4347a8(0x1f1)]||'',_0x3583ec=_0x4347a8(0x1f7)+_0x3a6624[_0x4347a8(0x23b)];_0x50913c[_0x4347a8(0x1f1)]=_0x185ac3?_0x185ac3+'\x0a\x0a'+_0x3583ec:_0x3583ec,console[_0x4347a8(0x177)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x3a6624[_0x4347a8(0x1fe)]&&console[_0x4347a8(0x177)](_0x4347a8(0x1a3)+_0x3a6624[_0x4347a8(0x1fe)]),_0x3a6624[_0x4347a8(0x184)]&&console['log'](_0x4347a8(0x1d8)+_0x3a6624[_0x4347a8(0x184)]);}await database_1[_0x4347a8(0x19b)][_0x4347a8(0x183)][_0x4347a8(0x1cc)]({'where':{'id':_0x55c724['id']},'data':_0x50913c}),await database_1[_0x4347a8(0x19b)][_0x4347a8(0x1c5)][_0x4347a8(0x190)]({'data':{'paymentId':_0x55c724['id'],'shopId':_0x55c724[_0x4347a8(0x1df)],'event':_0x4347a8(0x198)+_0x418ca9[_0x4347a8(0x200)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x4347a8(0x1e4)]({'oldStatus':_0x55c724[_0x4347a8(0x200)],'newStatus':_0x418ca9['status'],'paymentDetails':_0x418ca9[_0x4347a8(0x1e2)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x4347a8(0x1a9)](_0x55c724,_0x418ca9[_0x4347a8(0x200)]),await this[_0x4347a8(0x18c)](_0x55c724,_0x418ca9[_0x4347a8(0x200)]),_0x418ca9[_0x4347a8(0x200)]!==_0x4347a8(0x209)&&(console[_0x4347a8(0x177)](_0x4347a8(0x1b8)+_0x55c724['id']+'\x20status\x20changed\x20to\x20'+_0x418ca9[_0x4347a8(0x200)]+_0x4347a8(0x246)),this[_0x4347a8(0x1ad)](_0x55c724['id'])),console['log']('✅\x20[CHECK]\x20Payment\x20'+_0x55c724['id']+'\x20updated\x20successfully');}else console[_0x4347a8(0x177)]('📊\x20[CHECK]\x20Payment\x20'+_0x55c724['id']+_0x4347a8(0x1d4)+_0x418ca9[_0x4347a8(0x200)]+')'),this[_0x4347a8(0x1d1)](_0x55c724['id'],_0x55c724[_0x4347a8(0x1e9)],_0x55c724[_0x4347a8(0x200)],_0x418ca9['status'],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x418ca9[_0x4347a8(0x1e2)],'amount':_0x418ca9[_0x4347a8(0x16f)],'currency':_0x418ca9[_0x4347a8(0x1c6)],'shopId':_0x55c724[_0x4347a8(0x1df)],'checkTimestamp':new Date()[_0x4347a8(0x17a)]()});}catch(_0x600046){console[_0x4347a8(0x195)](_0x4347a8(0x206)+_0x55c724['id']+':',_0x600046),this['logCoinToPayError'](_0x55c724['id'],_0x55c724[_0x4347a8(0x1e9)],_0x600046,_0x4347a8(0x244),{'paymentAmount':_0x55c724['amount'],'paymentCurrency':_0x55c724[_0x4347a8(0x1c6)],'shopId':_0x55c724['shopId'],'createdAt':_0x55c724[_0x4347a8(0x1af)]}),await database_1[_0x4347a8(0x19b)][_0x4347a8(0x1c5)][_0x4347a8(0x190)]({'data':{'paymentId':_0x55c724['id'],'shopId':_0x55c724[_0x4347a8(0x1df)],'event':_0x4347a8(0x17f),'statusCode':0x1f4,'responseBody':JSON[_0x4347a8(0x1e4)]({'error':_0x600046 instanceof Error?_0x600046['message']:'Unknown\x20error','gatewayPaymentId':_0x55c724['gatewayPaymentId'],'checkedAt':new Date()[_0x4347a8(0x17a)]()})}});}}async[a37_0x358d5f(0x1a9)](_0x56b622,_0x2d7703){const _0x505c74=a37_0x358d5f,_0x7edf53=Date[_0x505c74(0x201)]();try{const _0x537171=_0x56b622[_0x505c74(0x16e)],_0x4bb4c8=_0x537171[_0x505c74(0x205)];if(!_0x4bb4c8?.[_0x505c74(0x172)]){console[_0x505c74(0x177)](_0x505c74(0x16a)+_0x537171['id']);return;}const _0xce3335=_0x2d7703===_0x505c74(0x22c)?_0x505c74(0x21c):_0x2d7703===_0x505c74(0x1a4)?'payment.failed':_0x2d7703==='EXPIRED'?'payment.failed':_0x505c74(0x231);if(!_0x4bb4c8['webhookEvents']?.[_0x505c74(0x1fb)](_0xce3335)){console[_0x505c74(0x177)]('Webhook\x20event\x20'+_0xce3335+_0x505c74(0x1c3)+_0x537171['id']);return;}const _0x53b546={'event':_0xce3335,'payment':{'id':_0x56b622['id'],'order_id':_0x56b622[_0x505c74(0x173)],'gateway_order_id':_0x56b622[_0x505c74(0x178)],'gateway':_0x505c74(0x1f2),'amount':_0x56b622[_0x505c74(0x16f)],'currency':_0x56b622[_0x505c74(0x1c6)],'status':_0x2d7703[_0x505c74(0x196)](),'customer_email':_0x56b622[_0x505c74(0x19e)],'customer_name':_0x56b622[_0x505c74(0x207)],'created_at':_0x56b622[_0x505c74(0x1af)],'updated_at':new Date()}},_0x4e8670=await fetch(_0x4bb4c8[_0x505c74(0x172)],{'method':_0x505c74(0x218),'headers':{'Content-Type':_0x505c74(0x1a8),'User-Agent':_0x505c74(0x21d)},'body':JSON[_0x505c74(0x1e4)](_0x53b546)}),_0x3d569a=Date['now']()-_0x7edf53,_0xaded23=_0x4e8670['ok']?_0x505c74(0x1cb):await _0x4e8670[_0x505c74(0x238)]();loggerService_1[_0x505c74(0x192)][_0x505c74(0x180)](_0x56b622[_0x505c74(0x1df)],_0x4bb4c8[_0x505c74(0x172)],_0xce3335,_0x4e8670['status'],_0x3d569a,_0x53b546),console[_0x505c74(0x177)](_0x505c74(0x1ba)+_0x4bb4c8[_0x505c74(0x172)]+'\x20with\x20status\x20'+_0x4e8670['status']+'\x20('+_0x3d569a+_0x505c74(0x1c7));}catch(_0x4e175b){console[_0x505c74(0x195)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x4e175b),loggerService_1[_0x505c74(0x192)][_0x505c74(0x176)](_0x56b622[_0x505c74(0x1df)],_0x56b622[_0x505c74(0x16e)]?.[_0x505c74(0x205)]?.[_0x505c74(0x172)]||'unknown',_0x505c74(0x18b),_0x4e175b,{});}}async[a37_0x358d5f(0x18c)](_0x40921a,_0x5acfcf){const _0x1db92c=a37_0x358d5f;try{const _0x55fe0b={'PENDING':'created','PAID':_0x1db92c(0x228),'FAILED':'failed','EXPIRED':_0x1db92c(0x1f3)},_0x1a549a=_0x55fe0b[_0x5acfcf];if(!_0x1a549a||_0x1a549a==='created')return;await telegramBotService_1[_0x1db92c(0x1a0)][_0x1db92c(0x1b3)](_0x40921a[_0x1db92c(0x1df)],_0x40921a,_0x1a549a);}catch(_0x1ca401){console[_0x1db92c(0x195)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x1ca401);}}async[a37_0x358d5f(0x1b2)](_0x5c8b12){const _0x59b7e9=a37_0x358d5f;console[_0x59b7e9(0x177)](_0x59b7e9(0x18e)+_0x5c8b12);const _0x54a762=await database_1[_0x59b7e9(0x19b)][_0x59b7e9(0x183)]['findUnique']({'where':{'id':_0x5c8b12},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x54a762)throw new Error(_0x59b7e9(0x235));if(_0x54a762[_0x59b7e9(0x1de)]!==_0x59b7e9(0x187))throw new Error(_0x59b7e9(0x1a6));console[_0x59b7e9(0x177)](_0x59b7e9(0x22a)+_0x5c8b12),await this[_0x59b7e9(0x1b0)](_0x54a762),console['log'](_0x59b7e9(0x175)+_0x5c8b12);}['getServiceStats'](){const _0x2bf7a9=a37_0x358d5f,_0x182ab0=this[_0x2bf7a9(0x224)]?this[_0x2bf7a9(0x1d7)]:undefined,_0x151b4d=Array[_0x2bf7a9(0x1b7)](this[_0x2bf7a9(0x1f0)][_0x2bf7a9(0x214)]())[_0x2bf7a9(0x241)](_0x563de9=>({'paymentId':_0x563de9['paymentId'],'gatewayPaymentId':_0x563de9[_0x2bf7a9(0x1e9)],'createdAt':_0x563de9[_0x2bf7a9(0x1af)],'timersCount':_0x563de9[_0x2bf7a9(0x1d3)][_0x2bf7a9(0x17d)]}));return{'isActive':!!this[_0x2bf7a9(0x224)],'globalCheckIntervalMinutes':this[_0x2bf7a9(0x1d7)]/(0x3e8*0x3c),'expiryDays':this[_0x2bf7a9(0x203)],'activeIndividualTimers':this['paymentTimers'][_0x2bf7a9(0x1cf)],'nextGlobalCheckIn':_0x182ab0,'paymentTimersDetails':_0x151b4d};}[a37_0x358d5f(0x1c2)](_0x2f29e8){const _0x3e57cd=a37_0x358d5f,_0x3c9423=this[_0x3e57cd(0x1f0)][_0x3e57cd(0x17b)](_0x2f29e8);if(_0x3c9423)return{'hasTimers':!![],'timersCount':_0x3c9423[_0x3e57cd(0x1d3)][_0x3e57cd(0x17d)],'createdAt':_0x3c9423['createdAt'],'gatewayPaymentId':_0x3c9423['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a37_0x358d5f(0x23d)]=CoinToPayStatusService,exports[a37_0x358d5f(0x230)]=new CoinToPayStatusService();