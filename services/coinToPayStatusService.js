'use strict';const a37_0x437c18=a37_0x9d69;(function(_0x46de7b,_0x48cd01){const _0x115868=a37_0x9d69,_0x483277=_0x46de7b();while(!![]){try{const _0x4033ab=-parseInt(_0x115868(0x21b))/0x1+parseInt(_0x115868(0x225))/0x2*(-parseInt(_0x115868(0x24a))/0x3)+-parseInt(_0x115868(0x1dd))/0x4+-parseInt(_0x115868(0x271))/0x5+parseInt(_0x115868(0x274))/0x6*(-parseInt(_0x115868(0x1ad))/0x7)+parseInt(_0x115868(0x209))/0x8+parseInt(_0x115868(0x285))/0x9;if(_0x4033ab===_0x48cd01)break;else _0x483277['push'](_0x483277['shift']());}catch(_0x4c2b3e){_0x483277['push'](_0x483277['shift']());}}}(a37_0x3595,0x3a88d));var __importDefault=this&&this[a37_0x437c18(0x238)]||function(_0xfd5c2b){return _0xfd5c2b&&_0xfd5c2b['__esModule']?_0xfd5c2b:{'default':_0xfd5c2b};};Object[a37_0x437c18(0x203)](exports,a37_0x437c18(0x1b1),{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0x437c18(0x21a)]=void 0x0;function a37_0x3595(){const _0x5dafb2=['Shop\x20webhook\x20sent\x20to\x20','CoinToPayService','bankDetails','checkSinglePaymentById','get','\x20status\x20from\x20','transactionId','\x20expired','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','630NuoINo','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','\x20status\x20unchanged\x20(','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20days\x20without\x20payment\x20confirmation','message','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20updated:\x20currentPayments=','\x20status\x20changed\x20to\x20','\x20not\x20found,\x20clearing\x20timers','delete','startPeriodicStatusCheck','getServiceStats','customerName','confirmedOn','paidAt','checkPaymentById','\x20triggered\x20for\x20payment\x20','__importDefault','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20\x20\x20-\x20gatewayPaymentId:\x20','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','paid','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','coinToPayService','webhookEvents','‚è∞\x20[HOURLY]\x20Payment\x20','entries','default','\x20details:','sendPaymentNotification','TesSoft\x20Payment\x20System/1.0','‚úÖ\x20[CHECK]\x20Payment\x20','\x20\x20\x20Gateway\x20','size','payment.failed','2097JwEIox','üìä\x20[HOURLY]\x20Payment\x20','getGatewayIdByName','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','getTime','cointopay_auto_expired','set','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','created','error','../types/gateway','\x20\x20\x20-\x20GatewayPaymentId:\x20','gatewaySettings','Gateway\x20','\x20\x20\x20üìä\x20Status:\x20','./currencyService','.\x20Remaining\x20active\x20timers:\x20','checkPaymentStatus','create',',\x20stopping\x20individual\x20checks','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','COINTOPAY_ERROR','\x20days,\x20marking\x20as\x20EXPIRED','logCoinToPayStatus','Automatically\x20expired\x20after\x20','application/json','\x20days\x20(created\x20before\x20','remitterIban','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','gatewayPaymentId','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20\x20\x20üìÖ\x20Time:\x20','toISOString','\x20not\x20found\x20in\x20database','h),\x20skipping\x20global\x20check','\x20initial\x20timers\x20for\x20payment\x20','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','checkAllPendingPayments','1914150draEcX','PAID','üßπ\x20[CHECK]\x20Payment\x20','7404sEzmRF','findUnique','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','payment.pending','payment','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','createdAt','sendShopWebhook','schedulePaymentChecks','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','logCoinToPayError','ms)','map','createdOn','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20marked\x20as\x20paid\x20at:\x20','coinToPay2Service','14000256odIczB','\x20\x20\x20üìç\x20Source:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20days','\x20found:','settings','5\x20minutes','toFixed','includes','Payment\x20older\x20than\x20','webhookUrl','gatewayOrderId','\x20checked,\x20','webhookLog','\x20with\x20status\x20','description','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','not\x20found','üí∞\x20[CHECK]\x20Payment\x20','1\x20minute','\x20expired\x20CoinToPay\x20payments','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','‚è∞\x20[GLOBAL]\x20Found\x20','push','stringify','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','COMPLETED','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','floor','unknown','CoinToPay2Service','./gateways/coinToPay2Service','setDate','length','getPaymentTimerInfo','gateway','convertToUSDT','status_check','‚è∞\x20[GLOBAL]\x20Payment\x20','\x20in\x20','./gateways/coinToPayService','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','customerEmail','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','orderId',',\x20using\x20default\x2010%','payment.success','üìà\x20[COINTOPAY]\x20Payment\x20','Success','stack','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','getGatewayCommission','\x20is\x20older\x20than\x20','\x20USDT','1876jIIBaZ','stopPeriodicStatusCheck','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20',',\x20clearing\x20individual\x20timers','__esModule','coinToPayStatusService','forEach','sendPaymentStatusNotification','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','cointopay','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20',',\x20using\x20default\x20commission\x2010%','currency','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','logShopWebhookSent','\x20\x20\x20-\x20Gateway:\x20','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','timestamp','./loggerService','GLOBAL_CHECK_INTERVAL_MS','cointopay2','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','timers','\x20updated\x20successfully','webhook_send','checkSinglePayment','\x20->\x20','\x20payment\x20','currentPayments','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','paymentTimers','type','getDate','EXPIRY_DAYS','\x20(after\x20','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','toLowerCase','./telegramBotService','\x20status\x20is\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','üßπ\x20[DEBUG]\x20Clearing\x20','parse','Webhook\x20event\x20','\x20not\x20enabled\x20for\x20shop\x20','1198900HxnHJE','currencyService','amountUSDT','paymentLinkId','findMany','üîç\x20[CHECK]\x20Checking\x20','globalCheckInterval','2\x20minutes','schedule_created','shop','auto_expire','\x20current\x20status:\x20','\x20commission:\x20','EXPIRED','\x20in\x20shop\x20','paymentDetails','‚úÖ\x20[HOURLY]\x20Payment\x20','failed','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','catch','amount','POST','\x20pending\x20CoinToPay\x20payments',',\x20gateway\x20','checkExpiredPayments','\x20\x20\x20üìù\x20Details:','clearPaymentTimers','loggerService','paymentId','telegramBotService','Failed\x20to\x20send\x20shop\x20webhook:','iban','FAILED','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20for\x20payment\x20','-day\x20timeout','delay','update','defineProperty','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','PENDING','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','values','\x20skipped,\x20','1967192XCwoIx','cointopay_status_check_error','shopId','\x20has\x20no\x20gatewayPaymentId,\x20skipping','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','now','log','\x20to\x20clear','../config/database','paymentLink','status','\x20is\x20too\x20new\x20(','\x20individual\x20payment\x20timers',',\x20status=','from','commission','üìä\x20[CHECK]\x20Payment\x20','CoinToPayStatusService','328274ZxzrCt'];a37_0x3595=function(){return _0x5dafb2;};return a37_0x3595();}function a37_0x9d69(_0x269dfa,_0x2c860d){const _0x3595c6=a37_0x3595();return a37_0x9d69=function(_0x9d6915,_0x3a78b7){_0x9d6915=_0x9d6915-0x17c;let _0x5080d6=_0x3595c6[_0x9d6915];return _0x5080d6;},a37_0x9d69(_0x269dfa,_0x2c860d);}const coinToPayService_1=require(a37_0x437c18(0x19e)),coinToPay2Service_1=require(a37_0x437c18(0x195)),gateway_1=require(a37_0x437c18(0x254)),database_1=__importDefault(require(a37_0x437c18(0x211))),telegramBotService_1=require(a37_0x437c18(0x1d6)),loggerService_1=require(a37_0x437c18(0x1c0)),currencyService_1=require(a37_0x437c18(0x259));class CoinToPayStatusService{constructor(){const _0x2b47eb=a37_0x437c18;this['globalCheckInterval']=null,this[_0x2b47eb(0x1c1)]=0x3c*0x3c*0x3e8,this[_0x2b47eb(0x1d1)]=0x5,this[_0x2b47eb(0x1ce)]=new Map(),this[_0x2b47eb(0x23e)]=new coinToPayService_1[(_0x2b47eb(0x21d))](),this[_0x2b47eb(0x284)]=new coinToPay2Service_1[(_0x2b47eb(0x194))](),console[_0x2b47eb(0x20f)](_0x2b47eb(0x226));}[a37_0x437c18(0x27c)](_0x3e5a57,_0x5593bc){const _0x4b2664=a37_0x437c18;console['log']('ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console['log']('\x20\x20\x20-\x20paymentId:\x20'+_0x3e5a57),console[_0x4b2664(0x20f)](_0x4b2664(0x23a)+_0x5593bc),this[_0x4b2664(0x1f7)](_0x3e5a57);const _0x8f26df=[],_0x2787fb=new Date(),_0x3158b8=[{'delay':0x1*0x3c*0x3e8,'description':_0x4b2664(0x189)},{'delay':0x2*0x3c*0x3e8,'description':_0x4b2664(0x1e4)},{'delay':0x5*0x3c*0x3e8,'description':_0x4b2664(0x17c)},{'delay':0x5*0x3c*0x3e8,'description':_0x4b2664(0x17c)}];console[_0x4b2664(0x20f)]('ü™ô\x20[DEBUG]\x20Creating\x20'+_0x3158b8['length']+_0x4b2664(0x26e)+_0x3e5a57);let _0x156be7=0x0;_0x3158b8[_0x4b2664(0x1b3)]((_0x3c7b1d,_0x113939)=>{const _0x33ab80=_0x4b2664;_0x156be7+=_0x3c7b1d[_0x33ab80(0x201)];const _0x2c1405=setTimeout(async()=>{const _0xb47658=_0x33ab80;console[_0xb47658(0x20f)](_0xb47658(0x1a1)+(_0x113939+0x1)+_0xb47658(0x237)+_0x3e5a57+_0xb47658(0x1d2)+_0x3c7b1d[_0xb47658(0x185)]+')');try{await this[_0xb47658(0x21f)](_0x3e5a57),console[_0xb47658(0x20f)]('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x113939+0x1)+'\x20completed\x20for\x20payment\x20'+_0x3e5a57);}catch(_0x566a1f){console[_0xb47658(0x253)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x113939+0x1)+'\x20for\x20payment\x20'+_0x3e5a57+':',_0x566a1f),this[_0xb47658(0x27e)](_0x3e5a57,_0x5593bc,_0x566a1f,'status_check',{'checkNumber':_0x113939+0x1,'scheduledAfter':_0x3c7b1d[_0xb47658(0x185)],'isIndividualCheck':!![]});}},_0x156be7);_0x8f26df[_0x33ab80(0x18d)](_0x2c1405),console['log']('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x113939+0x1)+'\x20for\x20payment\x20'+_0x3e5a57+_0x33ab80(0x19d)+_0x156be7/0x3e8+'\x20seconds\x20('+_0x3c7b1d[_0x33ab80(0x185)]+')');});const _0x1dc2e5=setInterval(async()=>{const _0x256c47=_0x4b2664;console[_0x256c47(0x20f)]('ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x3e5a57);try{const _0x343120=await database_1[_0x256c47(0x242)]['payment']['findUnique']({'where':{'id':_0x3e5a57},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x343120){console[_0x256c47(0x20f)]('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x3e5a57+_0x256c47(0x22f)),this['clearPaymentTimers'](_0x3e5a57);return;}console[_0x256c47(0x20f)](_0x256c47(0x24b)+_0x3e5a57+_0x256c47(0x1e8)+_0x343120[_0x256c47(0x213)]);if(_0x343120[_0x256c47(0x213)]!==_0x256c47(0x205)){console[_0x256c47(0x20f)](_0x256c47(0x1ed)+_0x3e5a57+_0x256c47(0x1d7)+_0x343120[_0x256c47(0x213)]+_0x256c47(0x25d)),this['clearPaymentTimers'](_0x3e5a57);return;}const _0x1834fb=Math['floor']((Date[_0x256c47(0x20e)]()-_0x343120[_0x256c47(0x27a)][_0x256c47(0x24e)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1834fb>=this[_0x256c47(0x1d1)]){console['log'](_0x256c47(0x240)+_0x3e5a57+_0x256c47(0x1ab)+this[_0x256c47(0x1d1)]+_0x256c47(0x251)),this[_0x256c47(0x1f7)](_0x3e5a57);return;}await this[_0x256c47(0x21f)](_0x3e5a57),console['log'](_0x256c47(0x26f)+_0x3e5a57);}catch(_0x2ea9fd){console['error'](_0x256c47(0x25e)+_0x3e5a57+':',_0x2ea9fd),this['logCoinToPayError'](_0x3e5a57,_0x5593bc,_0x2ea9fd,_0x256c47(0x19b),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x8f26df[_0x4b2664(0x18d)](_0x1dc2e5),this[_0x4b2664(0x1ce)][_0x4b2664(0x250)](_0x3e5a57,{'timers':_0x8f26df,'paymentId':_0x3e5a57,'gatewayPaymentId':_0x5593bc,'createdAt':_0x2787fb}),console['log']('‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x3158b8[_0x4b2664(0x197)]+_0x4b2664(0x18f)+_0x3e5a57),console[_0x4b2664(0x20f)](_0x4b2664(0x18b)+this[_0x4b2664(0x1ce)][_0x4b2664(0x248)]),this['logCoinToPayStatus'](_0x3e5a57,_0x5593bc,_0x4b2664(0x205),_0x4b2664(0x205),_0x4b2664(0x19b),{'action':_0x4b2664(0x1e5),'scheduledChecks':_0x3158b8[_0x4b2664(0x197)],'firstCheckIn':_0x3158b8[0x0][_0x4b2664(0x201)]/0x3e8,'totalTimers':this[_0x4b2664(0x1ce)][_0x4b2664(0x248)]});}['clearPaymentTimers'](_0x45845a){const _0x14da77=a37_0x437c18,_0x111aa0=this[_0x14da77(0x1ce)][_0x14da77(0x220)](_0x45845a);_0x111aa0?(console[_0x14da77(0x20f)](_0x14da77(0x1d9)+_0x111aa0['timers'][_0x14da77(0x197)]+'\x20timers\x20for\x20payment\x20'+_0x45845a),_0x111aa0[_0x14da77(0x1c4)][_0x14da77(0x1b3)]((_0x474d22,_0x411c1f)=>{const _0xa7ab67=_0x14da77;_0x474d22&&(clearTimeout(_0x474d22),clearInterval(_0x474d22),console[_0xa7ab67(0x20f)](_0xa7ab67(0x1d4)+(_0x411c1f+0x1)+_0xa7ab67(0x1ff)+_0x45845a));}),this[_0x14da77(0x1ce)][_0x14da77(0x230)](_0x45845a),console['log'](_0x14da77(0x1cb)+_0x45845a+_0x14da77(0x25a)+this[_0x14da77(0x1ce)]['size'])):console[_0x14da77(0x20f)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x45845a+_0x14da77(0x210));}async[a37_0x437c18(0x21f)](_0x413b41){const _0x1414ba=a37_0x437c18;console[_0x1414ba(0x20f)](_0x1414ba(0x1ef)+_0x413b41);const _0x53ba41=await database_1[_0x1414ba(0x242)][_0x1414ba(0x278)][_0x1414ba(0x275)]({'where':{'id':_0x413b41},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x53ba41){console[_0x1414ba(0x20f)]('‚ùå\x20[CHECK]\x20Payment\x20'+_0x413b41+_0x1414ba(0x26c));return;}console[_0x1414ba(0x20f)](_0x1414ba(0x219)+_0x413b41+_0x1414ba(0x289)),console['log'](_0x1414ba(0x1bd)+_0x53ba41[_0x1414ba(0x199)]),console[_0x1414ba(0x20f)]('\x20\x20\x20-\x20Status:\x20'+_0x53ba41[_0x1414ba(0x213)]),console['log'](_0x1414ba(0x255)+_0x53ba41[_0x1414ba(0x267)]),console[_0x1414ba(0x20f)]('\x20\x20\x20-\x20Amount:\x20'+_0x53ba41['amount']+'\x20'+_0x53ba41[_0x1414ba(0x1ba)]),console['log']('\x20\x20\x20-\x20ShopId:\x20'+_0x53ba41[_0x1414ba(0x20b)]);if(_0x53ba41[_0x1414ba(0x199)]!==_0x1414ba(0x1b7)&&_0x53ba41[_0x1414ba(0x199)]!==_0x1414ba(0x1c2)){console['log'](_0x1414ba(0x266)+_0x413b41+_0x1414ba(0x23d)+_0x53ba41[_0x1414ba(0x199)]+')');return;}if(_0x53ba41[_0x1414ba(0x213)]!=='PENDING'){console[_0x1414ba(0x20f)](_0x1414ba(0x266)+_0x413b41+_0x1414ba(0x1d7)+_0x53ba41[_0x1414ba(0x213)]+_0x1414ba(0x25d)),this['clearPaymentTimers'](_0x413b41);return;}if(!_0x53ba41[_0x1414ba(0x267)]){console[_0x1414ba(0x20f)](_0x1414ba(0x266)+_0x413b41+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x1414ba(0x20f)]('‚úÖ\x20[CHECK]\x20Payment\x20'+_0x413b41+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x1414ba(0x1c7)](_0x53ba41);}[a37_0x437c18(0x261)](_0x206b24,_0x15efb9,_0x2462c0,_0x501d8e,_0x4ce310,_0x1b0e79){const _0x454fb1=a37_0x437c18,_0x4bf7d2={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x206b24,'gatewayPaymentId':_0x15efb9,'oldStatus':_0x2462c0,'newStatus':_0x501d8e,'source':_0x4ce310,'timestamp':new Date()['toISOString'](),'details':_0x1b0e79||{}};loggerService_1[_0x454fb1(0x1f8)]['logCoinToPayStatus'](_0x4bf7d2),console[_0x454fb1(0x20f)]('ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x206b24+'\x20('+_0x15efb9+')'),console[_0x454fb1(0x20f)](_0x454fb1(0x258)+_0x2462c0+_0x454fb1(0x1c8)+_0x501d8e),console[_0x454fb1(0x20f)](_0x454fb1(0x286)+_0x4ce310),console[_0x454fb1(0x20f)](_0x454fb1(0x26a)+_0x4bf7d2['timestamp']),_0x1b0e79&&console[_0x454fb1(0x20f)](_0x454fb1(0x1f6),_0x1b0e79);}[a37_0x437c18(0x27e)](_0x2ae4f8,_0x46c659,_0x25b31e,_0x465d18,_0x5ac4ef){const _0x4118e5=a37_0x437c18,_0x25d45d={'type':_0x4118e5(0x25f),'paymentId':_0x2ae4f8,'gatewayPaymentId':_0x46c659,'error':_0x25b31e instanceof Error?{'message':_0x25b31e[_0x4118e5(0x22b)],'stack':_0x25b31e[_0x4118e5(0x1a7)]}:_0x25b31e,'source':_0x465d18,'timestamp':new Date()['toISOString'](),'context':_0x5ac4ef||{}};loggerService_1[_0x4118e5(0x1f8)][_0x4118e5(0x27e)](_0x25d45d),console[_0x4118e5(0x253)](_0x4118e5(0x22c)+_0x2ae4f8+'\x20('+_0x46c659+')'),console[_0x4118e5(0x253)]('\x20\x20\x20‚ùå\x20Error:\x20'+(_0x25b31e instanceof Error?_0x25b31e[_0x4118e5(0x22b)]:_0x25b31e)),console['error'](_0x4118e5(0x286)+_0x465d18),console[_0x4118e5(0x253)](_0x4118e5(0x26a)+_0x25d45d[_0x4118e5(0x1bf)]),_0x5ac4ef&&console[_0x4118e5(0x253)]('\x20\x20\x20üìù\x20Context:',_0x5ac4ef);}[a37_0x437c18(0x231)](){const _0x23fcab=a37_0x437c18;console[_0x23fcab(0x20f)](_0x23fcab(0x20d)),this[_0x23fcab(0x270)]()[_0x23fcab(0x1f0)](_0x5913e8=>{console['error']('‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x5913e8);}),this[_0x23fcab(0x1e3)]=setInterval(async()=>{const _0x2f0e09=_0x23fcab;try{console[_0x2f0e09(0x20f)]('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x2f0e09(0x270)](),console['log'](_0x2f0e09(0x1cd));}catch(_0x417e30){console[_0x2f0e09(0x253)](_0x2f0e09(0x23b),_0x417e30);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x23fcab(0x20f)](_0x23fcab(0x282));}[a37_0x437c18(0x1ae)](){const _0x2f0fa1=a37_0x437c18;console[_0x2f0fa1(0x20f)](_0x2f0fa1(0x239));this[_0x2f0fa1(0x1e3)]&&(clearInterval(this[_0x2f0fa1(0x1e3)]),this[_0x2f0fa1(0x1e3)]=null,console['log']('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x881d74=this[_0x2f0fa1(0x1ce)][_0x2f0fa1(0x248)];for(const [_0x4ca0ab]of this[_0x2f0fa1(0x1ce)]){this['clearPaymentTimers'](_0x4ca0ab);}console[_0x2f0fa1(0x20f)]('üõë\x20[SHUTDOWN]\x20Cleared\x20'+_0x881d74+_0x2f0fa1(0x215));}async['checkAllPendingPayments'](){const _0x6a66c6=a37_0x437c18;try{console[_0x6a66c6(0x20f)](_0x6a66c6(0x27d));const _0x508198=await database_1[_0x6a66c6(0x242)][_0x6a66c6(0x278)][_0x6a66c6(0x1e1)]({'where':{'gateway':{'in':[_0x6a66c6(0x1b7),'cointopay2']},'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log']('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x508198[_0x6a66c6(0x197)]+_0x6a66c6(0x1f3));if(_0x508198[_0x6a66c6(0x197)]===0x0){console[_0x6a66c6(0x20f)]('ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x58fb2d=await this[_0x6a66c6(0x1f5)](_0x508198);console['log'](_0x6a66c6(0x18c)+_0x58fb2d[_0x6a66c6(0x197)]+_0x6a66c6(0x18a));let _0x29205b=0x0,_0x1d35ed=0x0;for(const _0x535b05 of _0x508198){try{if(_0x58fb2d[_0x6a66c6(0x17e)](_0x535b05['id'])){console[_0x6a66c6(0x20f)](_0x6a66c6(0x19c)+_0x535b05['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x1d35ed++;continue;}if(this[_0x6a66c6(0x1ce)]['has'](_0x535b05['id'])){console['log']('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x535b05['id']+_0x6a66c6(0x276)),_0x1d35ed++;continue;}const _0x308321=(Date[_0x6a66c6(0x20e)]()-_0x535b05['createdAt'][_0x6a66c6(0x24e)]())/(0x3e8*0x3c*0x3c);if(_0x308321<0x1){console[_0x6a66c6(0x20f)](_0x6a66c6(0x19c)+_0x535b05['id']+_0x6a66c6(0x214)+_0x308321['toFixed'](0x1)+_0x6a66c6(0x26d)),_0x1d35ed++;continue;}console[_0x6a66c6(0x20f)](_0x6a66c6(0x206)+_0x535b05['id']+'\x20(age:\x20'+_0x308321['toFixed'](0x1)+'h)'),await this[_0x6a66c6(0x1c7)](_0x535b05),_0x29205b++,await new Promise(_0xb7806d=>setTimeout(_0xb7806d,0x7d0));}catch(_0x4490e3){console[_0x6a66c6(0x253)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x535b05['id']+':',_0x4490e3),this[_0x6a66c6(0x27e)](_0x535b05['id'],_0x535b05[_0x6a66c6(0x267)]||'unknown',_0x4490e3,_0x6a66c6(0x19b),{'isGlobalCheck':!![],'paymentAmount':_0x535b05['amount'],'paymentCurrency':_0x535b05[_0x6a66c6(0x1ba)],'shopId':_0x535b05[_0x6a66c6(0x20b)],'createdAt':_0x535b05[_0x6a66c6(0x27a)]}),loggerService_1['loggerService']['logWhiteDomainError'](_0x6a66c6(0x1b7),'/status/'+_0x535b05[_0x6a66c6(0x267)],_0x4490e3);}}console[_0x6a66c6(0x20f)](_0x6a66c6(0x1fe)+_0x29205b+_0x6a66c6(0x182)+_0x1d35ed+_0x6a66c6(0x208)+_0x58fb2d[_0x6a66c6(0x197)]+_0x6a66c6(0x223));}catch(_0x1081d1){console[_0x6a66c6(0x253)](_0x6a66c6(0x191),_0x1081d1);}}async[a37_0x437c18(0x1f5)](_0x233b7c){const _0x2e4bcf=a37_0x437c18,_0x2de985=[],_0x528206=new Date();_0x528206[_0x2e4bcf(0x196)](_0x528206[_0x2e4bcf(0x1d0)]()-this['EXPIRY_DAYS']),console[_0x2e4bcf(0x20f)](_0x2e4bcf(0x1d3)+this[_0x2e4bcf(0x1d1)]+_0x2e4bcf(0x264)+_0x528206[_0x2e4bcf(0x26b)]()+')');for(const _0x2db4c5 of _0x233b7c){if(_0x2db4c5[_0x2e4bcf(0x27a)]<_0x528206){console[_0x2e4bcf(0x20f)](_0x2e4bcf(0x1d8)+_0x2db4c5['id']+'\x20is\x20older\x20than\x20'+this[_0x2e4bcf(0x1d1)]+_0x2e4bcf(0x260));try{this['logCoinToPayStatus'](_0x2db4c5['id'],_0x2db4c5[_0x2e4bcf(0x267)]||_0x2e4bcf(0x193),'PENDING',_0x2e4bcf(0x1ea),_0x2e4bcf(0x1e7),{'reason':_0x2e4bcf(0x17f)+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x2db4c5[_0x2e4bcf(0x27a)],'daysSinceCreation':Math[_0x2e4bcf(0x192)]((Date['now']()-_0x2db4c5[_0x2e4bcf(0x27a)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x2db4c5['amount'],'paymentCurrency':_0x2db4c5[_0x2e4bcf(0x1ba)],'shopId':_0x2db4c5[_0x2e4bcf(0x20b)]}),await database_1[_0x2e4bcf(0x242)]['payment'][_0x2e4bcf(0x202)]({'where':{'id':_0x2db4c5['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x2e4bcf(0x262)+this['EXPIRY_DAYS']+_0x2e4bcf(0x22a)}}),await database_1['default'][_0x2e4bcf(0x183)][_0x2e4bcf(0x25c)]({'data':{'paymentId':_0x2db4c5['id'],'shopId':_0x2db4c5[_0x2e4bcf(0x20b)],'event':_0x2e4bcf(0x24f),'statusCode':0xc8,'responseBody':JSON[_0x2e4bcf(0x18e)]({'reason':_0x2e4bcf(0x17f)+this['EXPIRY_DAYS']+_0x2e4bcf(0x288),'createdAt':_0x2db4c5[_0x2e4bcf(0x27a)],'expiredAt':new Date()[_0x2e4bcf(0x26b)](),'daysSinceCreation':Math[_0x2e4bcf(0x192)]((Date['now']()-_0x2db4c5[_0x2e4bcf(0x27a)][_0x2e4bcf(0x24e)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x2e4bcf(0x27b)](_0x2db4c5,'EXPIRED'),await this['sendPaymentStatusNotification'](_0x2db4c5,_0x2e4bcf(0x1ea)),this[_0x2e4bcf(0x1f7)](_0x2db4c5['id']),_0x2de985[_0x2e4bcf(0x18d)](_0x2db4c5['id']),console['log']('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x2db4c5['id']+_0x2e4bcf(0x229)+this[_0x2e4bcf(0x1d1)]+_0x2e4bcf(0x200));}catch(_0x52f292){console[_0x2e4bcf(0x253)](_0x2e4bcf(0x24d)+_0x2db4c5['id']+':',_0x52f292),this[_0x2e4bcf(0x27e)](_0x2db4c5['id'],_0x2db4c5['gatewayPaymentId']||_0x2e4bcf(0x193),_0x52f292,_0x2e4bcf(0x1e7),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x2db4c5[_0x2e4bcf(0x27a)],'daysSinceCreation':Math['floor']((Date['now']()-_0x2db4c5[_0x2e4bcf(0x27a)][_0x2e4bcf(0x24e)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x2de985;}async[a37_0x437c18(0x1c7)](_0x3fafea){const _0x4b4ca4=a37_0x437c18;if(!_0x3fafea['gatewayPaymentId']){console[_0x4b4ca4(0x20f)](_0x4b4ca4(0x266)+_0x3fafea['id']+_0x4b4ca4(0x20c));return;}console[_0x4b4ca4(0x20f)](_0x4b4ca4(0x1e2)+_0x3fafea[_0x4b4ca4(0x199)]+'\x20payment\x20'+_0x3fafea['id']+'\x20('+_0x3fafea[_0x4b4ca4(0x267)]+')');try{let _0x1f9990;_0x3fafea[_0x4b4ca4(0x199)]===_0x4b4ca4(0x1c2)?(_0x1f9990=await this[_0x4b4ca4(0x284)]['checkPaymentStatus'](_0x3fafea[_0x4b4ca4(0x267)]),console[_0x4b4ca4(0x20f)](_0x4b4ca4(0x1bb)+_0x3fafea['id']+'\x20status:\x20'+_0x1f9990[_0x4b4ca4(0x213)])):(_0x1f9990=await this['coinToPayService'][_0x4b4ca4(0x25b)](_0x3fafea[_0x4b4ca4(0x267)]),console['log'](_0x4b4ca4(0x1a8)+_0x3fafea['id']+'\x20status:\x20'+_0x1f9990['status']));_0x1f9990[_0x4b4ca4(0x1ec)]&&console['log'](_0x4b4ca4(0x219)+_0x3fafea['id']+_0x4b4ca4(0x243),{'iban':_0x1f9990[_0x4b4ca4(0x1ec)]['iban']||_0x4b4ca4(0x187),'transactionId':_0x1f9990[_0x4b4ca4(0x1ec)][_0x4b4ca4(0x222)],'createdOn':_0x1f9990[_0x4b4ca4(0x1ec)][_0x4b4ca4(0x281)],'confirmedOn':_0x1f9990[_0x4b4ca4(0x1ec)][_0x4b4ca4(0x234)]||'not\x20confirmed'});if(_0x1f9990[_0x4b4ca4(0x213)]!==_0x3fafea[_0x4b4ca4(0x213)]){console[_0x4b4ca4(0x20f)](_0x4b4ca4(0x1c3)+_0x3fafea['id']+_0x4b4ca4(0x221)+_0x3fafea[_0x4b4ca4(0x213)]+'\x20to\x20'+_0x1f9990[_0x4b4ca4(0x213)]),this[_0x4b4ca4(0x261)](_0x3fafea['id'],_0x3fafea[_0x4b4ca4(0x267)],_0x3fafea['status'],_0x1f9990[_0x4b4ca4(0x213)],_0x4b4ca4(0x19b),{'paymentDetails':_0x1f9990[_0x4b4ca4(0x1ec)],'amount':_0x1f9990['amount'],'currency':_0x1f9990[_0x4b4ca4(0x1ba)],'shopId':_0x3fafea[_0x4b4ca4(0x20b)],'checkTimestamp':new Date()[_0x4b4ca4(0x26b)]()});const _0x3b4efb={'status':_0x1f9990[_0x4b4ca4(0x213)],'updatedAt':new Date()};if(_0x1f9990[_0x4b4ca4(0x213)]===_0x4b4ca4(0x272)&&_0x3fafea[_0x4b4ca4(0x213)]!=='PAID'){_0x3b4efb[_0x4b4ca4(0x235)]=new Date();if(!_0x3fafea[_0x4b4ca4(0x1df)]){const _0x3f1848=await currencyService_1[_0x4b4ca4(0x1de)][_0x4b4ca4(0x19a)](_0x3fafea['amount'],_0x3fafea[_0x4b4ca4(0x1ba)]);_0x3b4efb[_0x4b4ca4(0x1df)]=_0x3f1848;const _0x5bf82d=await this['getGatewayCommission'](_0x3fafea[_0x4b4ca4(0x20b)],_0x3fafea[_0x4b4ca4(0x199)]),_0x4b04ff=_0x3f1848*(0x1-_0x5bf82d/0x64);_0x3b4efb['amountAfterGatewayCommissionUSDT']=_0x4b04ff,console[_0x4b4ca4(0x20f)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x3fafea['id']+'\x20amounts\x20calculated:'),console[_0x4b4ca4(0x20f)]('\x20\x20\x20Amount:\x20'+_0x3fafea[_0x4b4ca4(0x1f1)]+'\x20'+_0x3fafea[_0x4b4ca4(0x1ba)]+_0x4b4ca4(0x1c8)+_0x3f1848[_0x4b4ca4(0x17d)](0x6)+_0x4b4ca4(0x1ac)),console[_0x4b4ca4(0x20f)](_0x4b4ca4(0x247)+_0x3fafea[_0x4b4ca4(0x199)]+_0x4b4ca4(0x1e9)+_0x5bf82d+'%'),console[_0x4b4ca4(0x20f)]('\x20\x20\x20Amount\x20after\x20commission:\x20'+_0x4b04ff['toFixed'](0x6)+_0x4b4ca4(0x1ac));}console[_0x4b4ca4(0x20f)](_0x4b4ca4(0x188)+_0x3fafea['id']+_0x4b4ca4(0x283)+_0x3b4efb['paidAt'][_0x4b4ca4(0x26b)]());}if(_0x1f9990[_0x4b4ca4(0x1ec)]){const _0x2dba71=_0x1f9990[_0x4b4ca4(0x1ec)];_0x2dba71['iban']&&(_0x3b4efb[_0x4b4ca4(0x265)]=_0x2dba71['iban'],console['log'](_0x4b4ca4(0x1b8)+_0x2dba71[_0x4b4ca4(0x1fc)]));if(_0x2dba71[_0x4b4ca4(0x21e)]){const _0x8125b8=_0x3fafea['adminNotes']||'',_0x5f5246='Bank\x20Details:\x20'+_0x2dba71[_0x4b4ca4(0x21e)];_0x3b4efb['adminNotes']=_0x8125b8?_0x8125b8+'\x0a\x0a'+_0x5f5246:_0x5f5246,console['log'](_0x4b4ca4(0x1be));}_0x2dba71['transactionId']&&console[_0x4b4ca4(0x20f)](_0x4b4ca4(0x1cc)+_0x2dba71['transactionId']),_0x2dba71['confirmedOn']&&console['log'](_0x4b4ca4(0x269)+_0x2dba71[_0x4b4ca4(0x234)]);}await database_1[_0x4b4ca4(0x242)][_0x4b4ca4(0x278)][_0x4b4ca4(0x202)]({'where':{'id':_0x3fafea['id']},'data':_0x3b4efb});if(_0x1f9990[_0x4b4ca4(0x213)]===_0x4b4ca4(0x272)&&_0x3fafea[_0x4b4ca4(0x213)]!=='PAID'){console[_0x4b4ca4(0x20f)](_0x4b4ca4(0x1a5)+_0x3fafea['id']+_0x4b4ca4(0x204));const _0xa36f70=await database_1[_0x4b4ca4(0x242)][_0x4b4ca4(0x278)][_0x4b4ca4(0x275)]({'where':{'id':_0x3fafea['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0xa36f70?.[_0x4b4ca4(0x1e0)]&&_0xa36f70[_0x4b4ca4(0x212)])try{const _0x1822d7=_0xa36f70['paymentLink'];console[_0x4b4ca4(0x20f)]('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x1822d7['id']+':\x20type='+_0x1822d7['type']+',\x20currentPayments='+_0x1822d7['currentPayments']+_0x4b4ca4(0x216)+_0x1822d7[_0x4b4ca4(0x213)]);const _0x3f5f53=_0x1822d7[_0x4b4ca4(0x1ca)]+0x1,_0x39f297=_0x1822d7[_0x4b4ca4(0x1cf)]==='SINGLE'?_0x4b4ca4(0x190):_0x1822d7['status'];await database_1[_0x4b4ca4(0x242)][_0x4b4ca4(0x212)][_0x4b4ca4(0x202)]({'where':{'id':_0x1822d7['id']},'data':{'currentPayments':_0x3f5f53,'status':_0x39f297,'updatedAt':new Date()}}),console['log'](_0x4b4ca4(0x1af)+_0x1822d7['id']+_0x4b4ca4(0x22d)+_0x1822d7[_0x4b4ca4(0x1ca)]+_0x4b4ca4(0x1c8)+_0x3f5f53+_0x4b4ca4(0x216)+_0x1822d7[_0x4b4ca4(0x213)]+_0x4b4ca4(0x1c8)+_0x39f297);}catch(_0x419da4){console[_0x4b4ca4(0x253)]('‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:',_0x419da4);}else console[_0x4b4ca4(0x20f)](_0x4b4ca4(0x1a5)+_0x3fafea['id']+_0x4b4ca4(0x19f));}await database_1[_0x4b4ca4(0x242)][_0x4b4ca4(0x183)][_0x4b4ca4(0x25c)]({'data':{'paymentId':_0x3fafea['id'],'shopId':_0x3fafea[_0x4b4ca4(0x20b)],'event':'cointopay_status_check_'+_0x1f9990[_0x4b4ca4(0x213)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x4b4ca4(0x18e)]({'oldStatus':_0x3fafea[_0x4b4ca4(0x213)],'newStatus':_0x1f9990[_0x4b4ca4(0x213)],'paymentDetails':_0x1f9990['paymentDetails'],'checkedAt':new Date()[_0x4b4ca4(0x26b)]()})}}),await this['sendShopWebhook'](_0x3fafea,_0x1f9990['status']),await this[_0x4b4ca4(0x1b4)](_0x3fafea,_0x1f9990['status']),_0x1f9990[_0x4b4ca4(0x213)]!==_0x4b4ca4(0x205)&&(console['log'](_0x4b4ca4(0x273)+_0x3fafea['id']+_0x4b4ca4(0x22e)+_0x1f9990[_0x4b4ca4(0x213)]+_0x4b4ca4(0x1b0)),this[_0x4b4ca4(0x1f7)](_0x3fafea['id'])),console[_0x4b4ca4(0x20f)](_0x4b4ca4(0x246)+_0x3fafea['id']+_0x4b4ca4(0x1c5));}else console[_0x4b4ca4(0x20f)]('üìä\x20[CHECK]\x20Payment\x20'+_0x3fafea['id']+_0x4b4ca4(0x227)+_0x1f9990[_0x4b4ca4(0x213)]+')'),this[_0x4b4ca4(0x261)](_0x3fafea['id'],_0x3fafea[_0x4b4ca4(0x267)],_0x3fafea[_0x4b4ca4(0x213)],_0x1f9990[_0x4b4ca4(0x213)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x1f9990[_0x4b4ca4(0x1ec)],'amount':_0x1f9990[_0x4b4ca4(0x1f1)],'currency':_0x1f9990['currency'],'shopId':_0x3fafea[_0x4b4ca4(0x20b)],'checkTimestamp':new Date()[_0x4b4ca4(0x26b)]()});}catch(_0x1f88b8){console[_0x4b4ca4(0x253)]('‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x3fafea['id']+':',_0x1f88b8),this[_0x4b4ca4(0x27e)](_0x3fafea['id'],_0x3fafea[_0x4b4ca4(0x267)],_0x1f88b8,_0x4b4ca4(0x19b),{'paymentAmount':_0x3fafea[_0x4b4ca4(0x1f1)],'paymentCurrency':_0x3fafea[_0x4b4ca4(0x1ba)],'shopId':_0x3fafea['shopId'],'createdAt':_0x3fafea[_0x4b4ca4(0x27a)]}),await database_1['default']['webhookLog'][_0x4b4ca4(0x25c)]({'data':{'paymentId':_0x3fafea['id'],'shopId':_0x3fafea[_0x4b4ca4(0x20b)],'event':_0x4b4ca4(0x20a),'statusCode':0x1f4,'responseBody':JSON[_0x4b4ca4(0x18e)]({'error':_0x1f88b8 instanceof Error?_0x1f88b8[_0x4b4ca4(0x22b)]:'Unknown\x20error','gatewayPaymentId':_0x3fafea['gatewayPaymentId'],'checkedAt':new Date()['toISOString']()})}});}}async[a37_0x437c18(0x27b)](_0x1b0aaf,_0x2d4fee){const _0x3fbe45=a37_0x437c18,_0x405144=Date[_0x3fbe45(0x20e)]();try{const _0x5efe39=_0x1b0aaf[_0x3fbe45(0x1e6)],_0x9eec2d=_0x5efe39[_0x3fbe45(0x28a)];if(!_0x9eec2d?.[_0x3fbe45(0x180)]){console[_0x3fbe45(0x20f)](_0x3fbe45(0x228)+_0x5efe39['id']);return;}const _0xe39042=_0x2d4fee===_0x3fbe45(0x272)?_0x3fbe45(0x1a4):_0x2d4fee===_0x3fbe45(0x1fd)?'payment.failed':_0x2d4fee===_0x3fbe45(0x1ea)?_0x3fbe45(0x249):_0x3fbe45(0x277);if(!_0x9eec2d[_0x3fbe45(0x23f)]?.['includes'](_0xe39042)){console[_0x3fbe45(0x20f)](_0x3fbe45(0x1db)+_0xe39042+_0x3fbe45(0x1dc)+_0x5efe39['id']);return;}const _0x2d2d0b=(0x0,gateway_1[_0x3fbe45(0x24c)])(_0x1b0aaf[_0x3fbe45(0x199)])||_0x1b0aaf['gateway'],_0x4ab12b={'event':_0xe39042,'payment':{'id':_0x1b0aaf['id'],'order_id':_0x1b0aaf[_0x3fbe45(0x1a2)],'gateway_order_id':_0x1b0aaf[_0x3fbe45(0x181)],'gateway':_0x2d2d0b,'amount':_0x1b0aaf['amount'],'currency':_0x1b0aaf[_0x3fbe45(0x1ba)],'status':_0x2d4fee['toLowerCase'](),'customer_email':_0x1b0aaf[_0x3fbe45(0x1a0)],'customer_name':_0x1b0aaf[_0x3fbe45(0x233)],'created_at':_0x1b0aaf[_0x3fbe45(0x27a)],'updated_at':new Date()}},_0x31a770=await fetch(_0x9eec2d[_0x3fbe45(0x180)],{'method':_0x3fbe45(0x1f2),'headers':{'Content-Type':_0x3fbe45(0x263),'User-Agent':_0x3fbe45(0x245)},'body':JSON[_0x3fbe45(0x18e)](_0x4ab12b)}),_0x24ad71=Date[_0x3fbe45(0x20e)]()-_0x405144,_0x464d6a=_0x31a770['ok']?_0x3fbe45(0x1a6):await _0x31a770['text']();loggerService_1['loggerService'][_0x3fbe45(0x1bc)](_0x1b0aaf[_0x3fbe45(0x20b)],_0x9eec2d['webhookUrl'],_0xe39042,_0x31a770[_0x3fbe45(0x213)],_0x24ad71,_0x4ab12b),console[_0x3fbe45(0x20f)](_0x3fbe45(0x21c)+_0x9eec2d[_0x3fbe45(0x180)]+_0x3fbe45(0x184)+_0x31a770[_0x3fbe45(0x213)]+'\x20('+_0x24ad71+_0x3fbe45(0x27f));}catch(_0x28a5dc){console[_0x3fbe45(0x253)](_0x3fbe45(0x1fb),_0x28a5dc),loggerService_1['loggerService']['logShopWebhookError'](_0x1b0aaf[_0x3fbe45(0x20b)],_0x1b0aaf[_0x3fbe45(0x1e6)]?.[_0x3fbe45(0x28a)]?.[_0x3fbe45(0x180)]||_0x3fbe45(0x193),_0x3fbe45(0x1c6),_0x28a5dc,{});}}async[a37_0x437c18(0x1b4)](_0x221c64,_0x329c75){const _0xa73b1=a37_0x437c18;try{const _0x480237={'PENDING':_0xa73b1(0x252),'PAID':_0xa73b1(0x23c),'FAILED':_0xa73b1(0x1ee),'EXPIRED':'expired'},_0x4ec1bd=_0x480237[_0x329c75];if(!_0x4ec1bd||_0x4ec1bd===_0xa73b1(0x252))return;await telegramBotService_1[_0xa73b1(0x1fa)][_0xa73b1(0x244)](_0x221c64[_0xa73b1(0x20b)],_0x221c64,_0x4ec1bd);}catch(_0x2b8ea0){console[_0xa73b1(0x253)](_0xa73b1(0x287),_0x2b8ea0);}}async[a37_0x437c18(0x236)](_0x26f7f5){const _0x1f6e69=a37_0x437c18;console[_0x1f6e69(0x20f)](_0x1f6e69(0x1b6)+_0x26f7f5);const _0x34f00c=await database_1[_0x1f6e69(0x242)][_0x1f6e69(0x278)][_0x1f6e69(0x275)]({'where':{'id':_0x26f7f5},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x34f00c)throw new Error('Payment\x20not\x20found');if(_0x34f00c[_0x1f6e69(0x199)]!==_0x1f6e69(0x1b7)&&_0x34f00c[_0x1f6e69(0x199)]!=='cointopay2')throw new Error(_0x1f6e69(0x186));console['log'](_0x1f6e69(0x1b5)+_0x34f00c['gateway']+_0x1f6e69(0x1c9)+_0x26f7f5),await this[_0x1f6e69(0x1c7)](_0x34f00c),console['log'](_0x1f6e69(0x1a9)+_0x26f7f5);}[a37_0x437c18(0x232)](){const _0x17797f=a37_0x437c18,_0x5db413=this[_0x17797f(0x1e3)]?this[_0x17797f(0x1c1)]:undefined,_0x254bfe=Array[_0x17797f(0x217)](this['paymentTimers'][_0x17797f(0x207)]())[_0x17797f(0x280)](_0x7dc61d=>({'paymentId':_0x7dc61d[_0x17797f(0x1f9)],'gatewayPaymentId':_0x7dc61d[_0x17797f(0x267)],'createdAt':_0x7dc61d[_0x17797f(0x27a)],'timersCount':_0x7dc61d[_0x17797f(0x1c4)]['length']}));return{'isActive':!!this[_0x17797f(0x1e3)],'globalCheckIntervalMinutes':this[_0x17797f(0x1c1)]/(0x3e8*0x3c),'expiryDays':this[_0x17797f(0x1d1)],'activeIndividualTimers':this['paymentTimers'][_0x17797f(0x248)],'nextGlobalCheckIn':_0x5db413,'paymentTimersDetails':_0x254bfe};}[a37_0x437c18(0x198)](_0x18809b){const _0x56d7d3=a37_0x437c18,_0x223646=this[_0x56d7d3(0x1ce)][_0x56d7d3(0x220)](_0x18809b);if(_0x223646)return{'hasTimers':!![],'timersCount':_0x223646[_0x56d7d3(0x1c4)][_0x56d7d3(0x197)],'createdAt':_0x223646[_0x56d7d3(0x27a)],'gatewayPaymentId':_0x223646[_0x56d7d3(0x267)]};return{'hasTimers':![]};}async[a37_0x437c18(0x1aa)](_0x125a29,_0x1bb5f0){const _0x49db2a=a37_0x437c18;try{const _0x26051c=await database_1[_0x49db2a(0x242)][_0x49db2a(0x1e6)][_0x49db2a(0x275)]({'where':{'id':_0x125a29},'select':{'gatewaySettings':!![]}});if(!_0x26051c?.[_0x49db2a(0x256)])return console['log'](_0x49db2a(0x224)+_0x125a29+_0x49db2a(0x1b9)),0xa;const _0x53453d=JSON[_0x49db2a(0x1da)](_0x26051c[_0x49db2a(0x256)]);for(const [_0x35ae31,_0x306b34]of Object[_0x49db2a(0x241)](_0x53453d)){if(_0x35ae31[_0x49db2a(0x1d5)]()===_0x1bb5f0[_0x49db2a(0x1d5)]()){const _0x1adebe=_0x306b34[_0x49db2a(0x218)]||0xa;return console[_0x49db2a(0x20f)](_0x49db2a(0x257)+_0x1bb5f0+'\x20commission\x20for\x20shop\x20'+_0x125a29+':\x20'+_0x1adebe+'%'),_0x1adebe;}}return console[_0x49db2a(0x20f)](_0x49db2a(0x268)+_0x1bb5f0+_0x49db2a(0x1eb)+_0x125a29+_0x49db2a(0x1a3)),0xa;}catch(_0x4d3d74){return console['error'](_0x49db2a(0x279)+_0x125a29+_0x49db2a(0x1f4)+_0x1bb5f0+':',_0x4d3d74),0xa;}}}exports[a37_0x437c18(0x21a)]=CoinToPayStatusService,exports[a37_0x437c18(0x1b2)]=new CoinToPayStatusService();