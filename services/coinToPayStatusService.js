'use strict';const a42_0x22f567=a42_0x1753;(function(_0x14a26a,_0x522ac3){const _0x1759e1=a42_0x1753,_0xae377e=_0x14a26a();while(!![]){try{const _0x89cd52=parseInt(_0x1759e1(0xbf))/0x1+parseInt(_0x1759e1(0x193))/0x2+parseInt(_0x1759e1(0x9f))/0x3*(parseInt(_0x1759e1(0xf4))/0x4)+-parseInt(_0x1759e1(0x138))/0x5+parseInt(_0x1759e1(0xe2))/0x6+parseInt(_0x1759e1(0x13f))/0x7*(-parseInt(_0x1759e1(0x100))/0x8)+-parseInt(_0x1759e1(0x82))/0x9;if(_0x89cd52===_0x522ac3)break;else _0xae377e['push'](_0xae377e['shift']());}catch(_0x37933b){_0xae377e['push'](_0xae377e['shift']());}}}(a42_0x4c09,0xa4c88));function a42_0x1753(_0x30bd8e,_0x56e8d7){const _0x4c090b=a42_0x4c09();return a42_0x1753=function(_0x175307,_0x38a4b8){_0x175307=_0x175307-0x81;let _0x2010dc=_0x4c090b[_0x175307];return _0x2010dc;},a42_0x1753(_0x30bd8e,_0x56e8d7);}var __importDefault=this&&this[a42_0x22f567(0x12d)]||function(_0x4688df){return _0x4688df&&_0x4688df['__esModule']?_0x4688df:{'default':_0x4688df};};function a42_0x4c09(){const _0x59d11d=['üìä\x20[HOURLY]\x20Payment\x20','\x20individual\x20payment\x20timers','\x20\x20\x20-\x20gatewayPaymentId:\x20','shop','payment','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','\x20(after\x20','timers','GLOBAL_CHECK_INTERVAL_MS','update','checkSinglePayment','\x20\x20\x20üìù\x20Details:','Failed\x20to\x20send\x20shop\x20webhook:','\x20\x20\x20üìä\x20Status:\x20','\x20expired\x20CoinToPay\x20payments','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','\x20not\x20found\x20in\x20database','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','947260wqLzqW','\x20to\x20','log','unknown','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20commission\x20for\x20shop\x20','\x20commission:\x20','not\x20found','‚è∞\x20[HOURLY]\x20Payment\x20','status_check','shopId','EXPIRY_DAYS','gatewayPaymentId','\x20status\x20from\x20','amountUSDT','includes','findUnique','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20\x20\x20üìç\x20Source:\x20','currentPayments',',\x20using\x20default\x2010%',',\x20currentPayments=','\x20updated:\x20currentPayments=','bankDetails','\x20status\x20is\x20','üßπ\x20[CHECK]\x20Payment\x20','./gateways/coinToPayService','payment.pending','globalCheckInterval','__esModule','currencyService','webhookUrl','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20\x20\x20-\x20Status:\x20','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','1370850qoOyCU','ms)','forEach','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','‚úÖ\x20[CHECK]\x20Payment\x20','CoinToPayStatusService','CoinToPayService','logWhiteDomainError','set','\x20expired','length','not\x20confirmed','description','error','\x20payment\x20','commission','\x20\x20\x20üìù\x20Context:','2\x20minutes','20ZgxhRj','startPeriodicStatusCheck','amount','üìä\x20[CHECK]\x20Payment\x20','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','COMPLETED','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','stringify','paymentLink','checkAllPendingPayments','\x20for\x20payment\x20','72flwyhq',':\x20type=',',\x20status=','expired','paid','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','cointopay_status_check_','üìà\x20[COINTOPAY]\x20Payment\x20','checkExpiredPayments','\x20found:','\x20is\x20too\x20new\x20(','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','üîç\x20[CHECK]\x20Checking\x20','FAILED','\x20with\x20status\x20','payment.success','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20not\x20enabled\x20for\x20shop\x20','defineProperty','createdOn','getGatewayCommission','created','‚úÖ\x20[EXPIRY]\x20Payment\x20','\x20->\x20','paidAt','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','Success','values','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','Gateway\x20','remitterIban','Webhook\x20event\x20','\x20\x20\x20üìÖ\x20Time:\x20','sendPaymentStatusNotification','setDate','application/json','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','../config/database','type','entries','üßπ\x20[DEBUG]\x20Clearing\x20','ü™ô\x20[DEBUG]\x20Creating\x20','settings','\x20\x20\x20-\x20paymentId:\x20','EXPIRED','__importDefault','toLowerCase','getServiceStats','‚è∞\x20[GLOBAL]\x20Payment\x20','toFixed','coinToPay2Service','text','PENDING','stack','./telegramBotService','h),\x20skipping\x20global\x20check','6123320RFDfTb','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','gatewayOrderId','\x20has\x20no\x20gatewayPaymentId,\x20skipping','auto_expire','cointopay_auto_expired','CoinToPay2Service','895699GnfiKr','getDate','convertToUSDT','orderId','cointopay2','size','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','timestamp','5\x20minutes','Unknown\x20error','delay','üõë\x20[SHUTDOWN]\x20Cleared\x20','\x20not\x20found,\x20clearing\x20timers','stopPeriodicStatusCheck','‚è∞\x20[EXPIRY]\x20Payment\x20','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20\x20\x20-\x20Amount:\x20','telegramBotService','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','getTime','üí∞\x20[CHECK]\x20Payment\x20','\x20pending\x20CoinToPay\x20payments','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20USDT','‚ùå\x20[HOURLY]\x20Payment\x20','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','checkSinglePaymentById','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','/status/',',\x20clearing\x20individual\x20timers','createdAt','create','webhookLog','findMany','loggerService','‚úÖ\x20[HOURLY]\x20Payment\x20','customerEmail','logCoinToPayError','getGatewayIdByName','customerName','‚ùå\x20[CHECK]\x20Payment\x20','gateway','default','-day\x20timeout','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','coinToPayStatusService','\x20in\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','\x20status\x20unchanged\x20(','COINTOPAY_ERROR','adminNotes','\x20in\x20shop\x20','getPaymentTimerInfo','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','logCoinToPayStatus','paymentId','logShopWebhookSent','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','has','paymentDetails','iban','PAID','\x20days\x20without\x20payment\x20confirmation','cointopay','gatewaySettings','message','clearPaymentTimers','sendPaymentNotification','\x20status:\x20','get','\x20updated\x20successfully','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20status\x20changed\x20to\x20','\x20to\x20clear','parse','Payment\x20System/1.0','payment.failed','.\x20Remaining\x20active\x20timers:\x20','confirmedOn','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','2593310fYrqih','now','\x20\x20\x20-\x20Gateway:\x20','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','4099149epHGpW','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','paymentTimers','1\x20minute','push','floor','webhookEvents','COINTOPAY_STATUS_CHANGE','amountAfterGatewayCommissionUSDT','./currencyService','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','webhook_send','\x20\x20\x20Amount:\x20','currency','checkPaymentStatus','transactionId','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','from','status','checkPaymentById','\x20days\x20(created\x20before\x20','Payment\x20older\x20than\x20','\x20\x20\x20Gateway\x20','coinToPayService','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20',',\x20using\x20default\x20commission\x2010%',',\x20stopping\x20individual\x20checks','‚è∞\x20[GLOBAL]\x20Found\x20','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','620580Wvmtav','toISOString','SINGLE','sendShopWebhook','schedulePaymentChecks','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20days','\x20is\x20older\x20than\x20',',\x20gateway\x20','\x20seconds\x20(','\x20\x20\x20Amount\x20after\x20commission:\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)'];a42_0x4c09=function(){return _0x59d11d;};return a42_0x4c09();}Object[a42_0x22f567(0x112)](exports,a42_0x22f567(0xdc),{'value':!![]}),exports[a42_0x22f567(0x16f)]=exports[a42_0x22f567(0xe7)]=void 0x0;const coinToPayService_1=require(a42_0x22f567(0xd9)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require('../types/gateway'),database_1=__importDefault(require(a42_0x22f567(0x125))),telegramBotService_1=require(a42_0x22f567(0x136)),loggerService_1=require('./loggerService'),currencyService_1=require(a42_0x22f567(0x8b));class CoinToPayStatusService{constructor(){const _0x5977aa=a42_0x22f567;this['globalCheckInterval']=null,this[_0x5977aa(0xb4)]=0x3c*0x3c*0x3e8,this[_0x5977aa(0xca)]=0x5,this[_0x5977aa(0x84)]=new Map(),this[_0x5977aa(0x99)]=new coinToPayService_1[(_0x5977aa(0xe8))](),this[_0x5977aa(0x132)]=new coinToPay2Service_1[(_0x5977aa(0x13e))](),console[_0x5977aa(0xc1)](_0x5977aa(0xf8));}[a42_0x22f567(0xa3)](_0x1f9d81,_0x5d0f4e){const _0x3fc02b=a42_0x22f567;console[_0x3fc02b(0xc1)](_0x3fc02b(0xbe)),console[_0x3fc02b(0xc1)](_0x3fc02b(0x12b)+_0x1f9d81),console[_0x3fc02b(0xc1)](_0x3fc02b(0xad)+_0x5d0f4e),this[_0x3fc02b(0x184)](_0x1f9d81);const _0xc34269=[],_0x2f68d7=new Date(),_0x4327d7=[{'delay':0x1*0x3c*0x3e8,'description':_0x3fc02b(0x85)},{'delay':0x2*0x3c*0x3e8,'description':_0x3fc02b(0xf3)},{'delay':0x5*0x3c*0x3e8,'description':_0x3fc02b(0x147)},{'delay':0x5*0x3c*0x3e8,'description':_0x3fc02b(0x147)}];console[_0x3fc02b(0xc1)](_0x3fc02b(0x129)+_0x4327d7[_0x3fc02b(0xec)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x1f9d81);let _0x2edc69=0x0;_0x4327d7[_0x3fc02b(0xe4)]((_0x5d750b,_0x1899b0)=>{const _0x5a2ba8=_0x3fc02b;_0x2edc69+=_0x5d750b[_0x5a2ba8(0x149)];const _0x4bb673=setTimeout(async()=>{const _0x2c0a27=_0x5a2ba8;console[_0x2c0a27(0xc1)](_0x2c0a27(0x159)+(_0x1899b0+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x1f9d81+_0x2c0a27(0xb2)+_0x5d750b[_0x2c0a27(0xee)]+')');try{await this[_0x2c0a27(0x15b)](_0x1f9d81),console[_0x2c0a27(0xc1)](_0x2c0a27(0x92)+(_0x1899b0+0x1)+'\x20completed\x20for\x20payment\x20'+_0x1f9d81);}catch(_0x4eab67){console['error'](_0x2c0a27(0x8c)+(_0x1899b0+0x1)+_0x2c0a27(0xff)+_0x1f9d81+':',_0x4eab67),this[_0x2c0a27(0x166)](_0x1f9d81,_0x5d0f4e,_0x4eab67,'status_check',{'checkNumber':_0x1899b0+0x1,'scheduledAfter':_0x5d750b[_0x2c0a27(0xee)],'isIndividualCheck':!![]});}},_0x2edc69);_0xc34269[_0x5a2ba8(0x86)](_0x4bb673),console[_0x5a2ba8(0xc1)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x1899b0+0x1)+'\x20for\x20payment\x20'+_0x1f9d81+_0x5a2ba8(0x170)+_0x2edc69/0x3e8+_0x5a2ba8(0xa8)+_0x5d750b[_0x5a2ba8(0xee)]+')');});const _0x472be2=setInterval(async()=>{const _0x2f820d=_0x3fc02b;console['log'](_0x2f820d(0x192)+_0x1f9d81);try{const _0x18883b=await database_1[_0x2f820d(0x16b)][_0x2f820d(0xaf)]['findUnique']({'where':{'id':_0x1f9d81},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x18883b){console[_0x2f820d(0xc1)](_0x2f820d(0x157)+_0x1f9d81+_0x2f820d(0x14b)),this['clearPaymentTimers'](_0x1f9d81);return;}console[_0x2f820d(0xc1)](_0x2f820d(0xab)+_0x1f9d81+'\x20current\x20status:\x20'+_0x18883b[_0x2f820d(0x94)]);if(_0x18883b[_0x2f820d(0x94)]!==_0x2f820d(0x134)){console[_0x2f820d(0xc1)](_0x2f820d(0x164)+_0x1f9d81+_0x2f820d(0xd7)+_0x18883b['status']+_0x2f820d(0x9c)),this[_0x2f820d(0x184)](_0x1f9d81);return;}const _0x2f5d71=Math['floor']((Date[_0x2f820d(0x194)]()-_0x18883b[_0x2f820d(0x15f)][_0x2f820d(0x152)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x2f5d71>=this[_0x2f820d(0xca)]){console[_0x2f820d(0xc1)](_0x2f820d(0xc7)+_0x1f9d81+_0x2f820d(0xa6)+this[_0x2f820d(0xca)]+_0x2f820d(0x139)),this[_0x2f820d(0x184)](_0x1f9d81);return;}await this[_0x2f820d(0x15b)](_0x1f9d81),console[_0x2f820d(0xc1)](_0x2f820d(0x9a)+_0x1f9d81);}catch(_0x143be5){console['error']('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x1f9d81+':',_0x143be5),this['logCoinToPayError'](_0x1f9d81,_0x5d0f4e,_0x143be5,_0x2f820d(0xc8),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0xc34269['push'](_0x472be2),this[_0x3fc02b(0x84)][_0x3fc02b(0xea)](_0x1f9d81,{'timers':_0xc34269,'paymentId':_0x1f9d81,'gatewayPaymentId':_0x5d0f4e,'createdAt':_0x2f68d7}),console[_0x3fc02b(0xc1)](_0x3fc02b(0xb0)+_0x4327d7[_0x3fc02b(0xec)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x1f9d81),console['log']('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x3fc02b(0x84)][_0x3fc02b(0x144)]),this[_0x3fc02b(0x178)](_0x1f9d81,_0x5d0f4e,_0x3fc02b(0x134),_0x3fc02b(0x134),_0x3fc02b(0xc8),{'action':'schedule_created','scheduledChecks':_0x4327d7['length'],'firstCheckIn':_0x4327d7[0x0]['delay']/0x3e8,'totalTimers':this['paymentTimers'][_0x3fc02b(0x144)]});}['clearPaymentTimers'](_0x31b1ef){const _0x4a43f4=a42_0x22f567,_0x5035ab=this[_0x4a43f4(0x84)][_0x4a43f4(0x187)](_0x31b1ef);_0x5035ab?(console[_0x4a43f4(0xc1)](_0x4a43f4(0x128)+_0x5035ab[_0x4a43f4(0xb3)][_0x4a43f4(0xec)]+'\x20timers\x20for\x20payment\x20'+_0x31b1ef),_0x5035ab[_0x4a43f4(0xb3)][_0x4a43f4(0xe4)]((_0x2850a5,_0x2482d6)=>{const _0x43b3c4=_0x4a43f4;_0x2850a5&&(clearTimeout(_0x2850a5),clearInterval(_0x2850a5),console[_0x43b3c4(0xc1)]('üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x2482d6+0x1)+_0x43b3c4(0xff)+_0x31b1ef));}),this[_0x4a43f4(0x84)]['delete'](_0x31b1ef),console[_0x4a43f4(0xc1)](_0x4a43f4(0x15a)+_0x31b1ef+_0x4a43f4(0x190)+this[_0x4a43f4(0x84)][_0x4a43f4(0x144)])):console[_0x4a43f4(0xc1)](_0x4a43f4(0x15c)+_0x31b1ef+_0x4a43f4(0x18c));}async[a42_0x22f567(0x15b)](_0xa8e2f5){const _0x3c9a40=a42_0x22f567;console[_0x3c9a40(0xc1)](_0x3c9a40(0xe1)+_0xa8e2f5);const _0x5599ad=await database_1['default']['payment'][_0x3c9a40(0xcf)]({'where':{'id':_0xa8e2f5},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5599ad){console[_0x3c9a40(0xc1)](_0x3c9a40(0x169)+_0xa8e2f5+_0x3c9a40(0xbc));return;}console['log'](_0x3c9a40(0xf7)+_0xa8e2f5+_0x3c9a40(0x109)),console['log'](_0x3c9a40(0x195)+_0x5599ad['gateway']),console[_0x3c9a40(0xc1)](_0x3c9a40(0xe0)+_0x5599ad[_0x3c9a40(0x94)]),console[_0x3c9a40(0xc1)](_0x3c9a40(0xdf)+_0x5599ad[_0x3c9a40(0xcb)]),console[_0x3c9a40(0xc1)](_0x3c9a40(0x14f)+_0x5599ad[_0x3c9a40(0xf6)]+'\x20'+_0x5599ad[_0x3c9a40(0x8f)]),console[_0x3c9a40(0xc1)]('\x20\x20\x20-\x20ShopId:\x20'+_0x5599ad[_0x3c9a40(0xc9)]);if(_0x5599ad[_0x3c9a40(0x16a)]!==_0x3c9a40(0x181)&&_0x5599ad[_0x3c9a40(0x16a)]!=='cointopay2'){console['log'](_0x3c9a40(0x11c)+_0xa8e2f5+'\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20'+_0x5599ad['gateway']+')');return;}if(_0x5599ad[_0x3c9a40(0x94)]!==_0x3c9a40(0x134)){console[_0x3c9a40(0xc1)](_0x3c9a40(0x11c)+_0xa8e2f5+'\x20status\x20is\x20'+_0x5599ad[_0x3c9a40(0x94)]+_0x3c9a40(0x9c)),this[_0x3c9a40(0x184)](_0xa8e2f5);return;}if(!_0x5599ad[_0x3c9a40(0xcb)]){console[_0x3c9a40(0xc1)](_0x3c9a40(0x11c)+_0xa8e2f5+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x3c9a40(0xc1)](_0x3c9a40(0xe6)+_0xa8e2f5+_0x3c9a40(0xd0)),await this[_0x3c9a40(0xb6)](_0x5599ad);}[a42_0x22f567(0x178)](_0x31155b,_0x26071b,_0x146a55,_0x1b3cdf,_0x45186b,_0x5606b4){const _0x4f6643=a42_0x22f567,_0x19e5aa={'type':_0x4f6643(0x89),'paymentId':_0x31155b,'gatewayPaymentId':_0x26071b,'oldStatus':_0x146a55,'newStatus':_0x1b3cdf,'source':_0x45186b,'timestamp':new Date()['toISOString'](),'details':_0x5606b4||{}};loggerService_1[_0x4f6643(0x163)]['logCoinToPayStatus'](_0x19e5aa),console[_0x4f6643(0xc1)](_0x4f6643(0x189)+_0x31155b+'\x20('+_0x26071b+')'),console[_0x4f6643(0xc1)](_0x4f6643(0xb9)+_0x146a55+_0x4f6643(0x117)+_0x1b3cdf),console[_0x4f6643(0xc1)](_0x4f6643(0xd1)+_0x45186b),console[_0x4f6643(0xc1)](_0x4f6643(0x120)+_0x19e5aa[_0x4f6643(0x146)]),_0x5606b4&&console['log'](_0x4f6643(0xb7),_0x5606b4);}[a42_0x22f567(0x166)](_0x3194c2,_0x1d8c49,_0x2f9832,_0x29a81f,_0x551fe6){const _0x349a29=a42_0x22f567,_0x55f494={'type':_0x349a29(0x173),'paymentId':_0x3194c2,'gatewayPaymentId':_0x1d8c49,'error':_0x2f9832 instanceof Error?{'message':_0x2f9832[_0x349a29(0x183)],'stack':_0x2f9832[_0x349a29(0x135)]}:_0x2f9832,'source':_0x29a81f,'timestamp':new Date()[_0x349a29(0xa0)](),'context':_0x551fe6||{}};loggerService_1[_0x349a29(0x163)][_0x349a29(0x166)](_0x55f494),console[_0x349a29(0xef)](_0x349a29(0x105)+_0x3194c2+'\x20('+_0x1d8c49+')'),console[_0x349a29(0xef)]('\x20\x20\x20‚ùå\x20Error:\x20'+(_0x2f9832 instanceof Error?_0x2f9832['message']:_0x2f9832)),console['error'](_0x349a29(0xd1)+_0x29a81f),console[_0x349a29(0xef)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x55f494[_0x349a29(0x146)]),_0x551fe6&&console['error'](_0x349a29(0xf2),_0x551fe6);}[a42_0x22f567(0xf5)](){const _0x146313=a42_0x22f567;console[_0x146313(0xc1)](_0x146313(0x83)),this[_0x146313(0xfe)]()['catch'](_0x2a5b58=>{const _0x4b2247=_0x146313;console[_0x4b2247(0xef)](_0x4b2247(0x18a),_0x2a5b58);}),this['globalCheckInterval']=setInterval(async()=>{const _0x17eb26=_0x146313;try{console[_0x17eb26(0xc1)](_0x17eb26(0x124)),await this[_0x17eb26(0xfe)](),console[_0x17eb26(0xc1)](_0x17eb26(0xe5));}catch(_0x23329a){console['error'](_0x17eb26(0x155),_0x23329a);}},this[_0x146313(0xb4)]),console['log'](_0x146313(0xaa));}[a42_0x22f567(0x14c)](){const _0x53bbe8=a42_0x22f567;console[_0x53bbe8(0xc1)]('üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x53bbe8(0xdb)]&&(clearInterval(this['globalCheckInterval']),this[_0x53bbe8(0xdb)]=null,console[_0x53bbe8(0xc1)](_0x53bbe8(0x110)));const _0x1969b6=this[_0x53bbe8(0x84)][_0x53bbe8(0x144)];for(const [_0x52f440]of this[_0x53bbe8(0x84)]){this['clearPaymentTimers'](_0x52f440);}console['log'](_0x53bbe8(0x14a)+_0x1969b6+_0x53bbe8(0xac));}async[a42_0x22f567(0xfe)](){const _0x2d934d=a42_0x22f567;try{console[_0x2d934d(0xc1)](_0x2d934d(0x145));const _0x29b09b=await database_1[_0x2d934d(0x16b)]['payment'][_0x2d934d(0x162)]({'where':{'gateway':{'in':[_0x2d934d(0x181),_0x2d934d(0x143)]},'status':_0x2d934d(0x134),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x2d934d(0xc1)]('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x29b09b[_0x2d934d(0xec)]+_0x2d934d(0x154));if(_0x29b09b[_0x2d934d(0xec)]===0x0){console[_0x2d934d(0xc1)]('ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x3dbf12=await this[_0x2d934d(0x108)](_0x29b09b);console['log'](_0x2d934d(0x9d)+_0x3dbf12[_0x2d934d(0xec)]+_0x2d934d(0xba));let _0x3fcfcd=0x0,_0x4c2c53=0x0;for(const _0xa64bf8 of _0x29b09b){try{if(_0x3dbf12[_0x2d934d(0xce)](_0xa64bf8['id'])){console[_0x2d934d(0xc1)](_0x2d934d(0x130)+_0xa64bf8['id']+_0x2d934d(0xa4)),_0x4c2c53++;continue;}if(this['paymentTimers'][_0x2d934d(0x17c)](_0xa64bf8['id'])){console[_0x2d934d(0xc1)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0xa64bf8['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x4c2c53++;continue;}const _0x11006f=(Date[_0x2d934d(0x194)]()-_0xa64bf8[_0x2d934d(0x15f)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x11006f<0x1){console[_0x2d934d(0xc1)](_0x2d934d(0x130)+_0xa64bf8['id']+_0x2d934d(0x10a)+_0x11006f[_0x2d934d(0x131)](0x1)+_0x2d934d(0x137)),_0x4c2c53++;continue;}console['log'](_0x2d934d(0x16d)+_0xa64bf8['id']+'\x20(age:\x20'+_0x11006f[_0x2d934d(0x131)](0x1)+'h)'),await this[_0x2d934d(0xb6)](_0xa64bf8),_0x3fcfcd++,await new Promise(_0x58b66c=>setTimeout(_0x58b66c,0x7d0));}catch(_0x2ede31){console[_0x2d934d(0xef)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0xa64bf8['id']+':',_0x2ede31),this[_0x2d934d(0x166)](_0xa64bf8['id'],_0xa64bf8[_0x2d934d(0xcb)]||_0x2d934d(0xc2),_0x2ede31,_0x2d934d(0xc8),{'isGlobalCheck':!![],'paymentAmount':_0xa64bf8['amount'],'paymentCurrency':_0xa64bf8[_0x2d934d(0x8f)],'shopId':_0xa64bf8['shopId'],'createdAt':_0xa64bf8[_0x2d934d(0x15f)]}),loggerService_1['loggerService'][_0x2d934d(0xe9)](_0x2d934d(0x181),_0x2d934d(0x15d)+_0xa64bf8['gatewayPaymentId'],_0x2ede31);}}console['log'](_0x2d934d(0xc3)+_0x3fcfcd+'\x20checked,\x20'+_0x4c2c53+'\x20skipped,\x20'+_0x3dbf12['length']+_0x2d934d(0xeb));}catch(_0x37c679){console[_0x2d934d(0xef)](_0x2d934d(0x17b),_0x37c679);}}async['checkExpiredPayments'](_0x36f884){const _0x2e4ed0=a42_0x22f567,_0x5970e4=[],_0x331865=new Date();_0x331865[_0x2e4ed0(0x122)](_0x331865[_0x2e4ed0(0x140)]()-this[_0x2e4ed0(0xca)]),console['log']('‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x2e4ed0(0xca)]+_0x2e4ed0(0x96)+_0x331865['toISOString']()+')');for(const _0x1faab3 of _0x36f884){if(_0x1faab3['createdAt']<_0x331865){console[_0x2e4ed0(0xc1)](_0x2e4ed0(0x14d)+_0x1faab3['id']+'\x20is\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x2e4ed0(0x178)](_0x1faab3['id'],_0x1faab3[_0x2e4ed0(0xcb)]||_0x2e4ed0(0xc2),'PENDING',_0x2e4ed0(0x12c),_0x2e4ed0(0x13c),{'reason':_0x2e4ed0(0x97)+this['EXPIRY_DAYS']+_0x2e4ed0(0xa5),'createdAt':_0x1faab3[_0x2e4ed0(0x15f)],'daysSinceCreation':Math[_0x2e4ed0(0x87)]((Date['now']()-_0x1faab3[_0x2e4ed0(0x15f)][_0x2e4ed0(0x152)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x1faab3[_0x2e4ed0(0xf6)],'paymentCurrency':_0x1faab3['currency'],'shopId':_0x1faab3[_0x2e4ed0(0xc9)]}),await database_1[_0x2e4ed0(0x16b)][_0x2e4ed0(0xaf)][_0x2e4ed0(0xb5)]({'where':{'id':_0x1faab3['id']},'data':{'status':_0x2e4ed0(0x12c),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x2e4ed0(0xca)]+_0x2e4ed0(0x180)}}),await database_1[_0x2e4ed0(0x16b)]['webhookLog'][_0x2e4ed0(0x160)]({'data':{'paymentId':_0x1faab3['id'],'shopId':_0x1faab3[_0x2e4ed0(0xc9)],'event':_0x2e4ed0(0x13d),'statusCode':0xc8,'responseBody':JSON[_0x2e4ed0(0xfc)]({'reason':_0x2e4ed0(0x97)+this['EXPIRY_DAYS']+_0x2e4ed0(0xa5),'createdAt':_0x1faab3['createdAt'],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x2e4ed0(0x87)]((Date[_0x2e4ed0(0x194)]()-_0x1faab3['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x2e4ed0(0xa2)](_0x1faab3,_0x2e4ed0(0x12c)),await this['sendPaymentStatusNotification'](_0x1faab3,'EXPIRED'),this[_0x2e4ed0(0x184)](_0x1faab3['id']),_0x5970e4[_0x2e4ed0(0x86)](_0x1faab3['id']),console['log'](_0x2e4ed0(0x116)+_0x1faab3['id']+_0x2e4ed0(0x10b)+this[_0x2e4ed0(0xca)]+_0x2e4ed0(0x16c));}catch(_0x3a0c89){console[_0x2e4ed0(0xef)](_0x2e4ed0(0x171)+_0x1faab3['id']+':',_0x3a0c89),this[_0x2e4ed0(0x166)](_0x1faab3['id'],_0x1faab3[_0x2e4ed0(0xcb)]||'unknown',_0x3a0c89,_0x2e4ed0(0x13c),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x1faab3[_0x2e4ed0(0x15f)],'daysSinceCreation':Math[_0x2e4ed0(0x87)]((Date[_0x2e4ed0(0x194)]()-_0x1faab3[_0x2e4ed0(0x15f)][_0x2e4ed0(0x152)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5970e4;}async[a42_0x22f567(0xb6)](_0x1cd8fc){const _0x5f4843=a42_0x22f567;if(!_0x1cd8fc['gatewayPaymentId']){console['log'](_0x5f4843(0x11c)+_0x1cd8fc['id']+_0x5f4843(0x13b));return;}console[_0x5f4843(0xc1)](_0x5f4843(0x10c)+_0x1cd8fc[_0x5f4843(0x16a)]+'\x20payment\x20'+_0x1cd8fc['id']+'\x20('+_0x1cd8fc['gatewayPaymentId']+')');try{let _0x18244d;_0x1cd8fc[_0x5f4843(0x16a)]===_0x5f4843(0x143)?(_0x18244d=await this[_0x5f4843(0x132)][_0x5f4843(0x90)](_0x1cd8fc[_0x5f4843(0xcb)]),console[_0x5f4843(0xc1)]('üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x1cd8fc['id']+_0x5f4843(0x186)+_0x18244d['status'])):(_0x18244d=await this[_0x5f4843(0x99)][_0x5f4843(0x90)](_0x1cd8fc['gatewayPaymentId']),console[_0x5f4843(0xc1)](_0x5f4843(0x14e)+_0x1cd8fc['id']+_0x5f4843(0x186)+_0x18244d[_0x5f4843(0x94)]));_0x18244d[_0x5f4843(0x17d)]&&console[_0x5f4843(0xc1)](_0x5f4843(0xf7)+_0x1cd8fc['id']+'\x20details:',{'iban':_0x18244d[_0x5f4843(0x17d)]['iban']||_0x5f4843(0xc6),'transactionId':_0x18244d[_0x5f4843(0x17d)][_0x5f4843(0x91)],'createdOn':_0x18244d[_0x5f4843(0x17d)][_0x5f4843(0x113)],'confirmedOn':_0x18244d[_0x5f4843(0x17d)][_0x5f4843(0x191)]||_0x5f4843(0xed)});if(_0x18244d[_0x5f4843(0x94)]!==_0x1cd8fc[_0x5f4843(0x94)]){console['log'](_0x5f4843(0x9e)+_0x1cd8fc['id']+_0x5f4843(0xcc)+_0x1cd8fc['status']+_0x5f4843(0xc0)+_0x18244d['status']),this['logCoinToPayStatus'](_0x1cd8fc['id'],_0x1cd8fc[_0x5f4843(0xcb)],_0x1cd8fc[_0x5f4843(0x94)],_0x18244d[_0x5f4843(0x94)],_0x5f4843(0xc8),{'paymentDetails':_0x18244d['paymentDetails'],'amount':_0x18244d['amount'],'currency':_0x18244d['currency'],'shopId':_0x1cd8fc[_0x5f4843(0xc9)],'checkTimestamp':new Date()['toISOString']()});const _0x14d8ec={'status':_0x18244d['status'],'updatedAt':new Date()};if(_0x18244d['status']===_0x5f4843(0x17f)&&_0x1cd8fc[_0x5f4843(0x94)]!==_0x5f4843(0x17f)){_0x14d8ec[_0x5f4843(0x118)]=new Date();if(!_0x1cd8fc[_0x5f4843(0xcd)]){const _0x10eb35=await currencyService_1[_0x5f4843(0xdd)][_0x5f4843(0x141)](_0x1cd8fc['amount'],_0x1cd8fc[_0x5f4843(0x8f)]);_0x14d8ec[_0x5f4843(0xcd)]=_0x10eb35;const _0x3efba7=await this[_0x5f4843(0x114)](_0x1cd8fc[_0x5f4843(0xc9)],_0x1cd8fc[_0x5f4843(0x16a)]),_0x36f116=_0x10eb35*(0x1-_0x3efba7/0x64);_0x14d8ec[_0x5f4843(0x8a)]=_0x36f116,_0x14d8ec['gatewayCommissionRate']=_0x3efba7,console[_0x5f4843(0xc1)](_0x5f4843(0x153)+_0x1cd8fc['id']+'\x20amounts\x20calculated:'),console['log'](_0x5f4843(0x8e)+_0x1cd8fc['amount']+'\x20'+_0x1cd8fc[_0x5f4843(0x8f)]+_0x5f4843(0x117)+_0x10eb35[_0x5f4843(0x131)](0x6)+'\x20USDT'),console['log'](_0x5f4843(0x98)+_0x1cd8fc['gateway']+_0x5f4843(0xc5)+_0x3efba7+'%'),console[_0x5f4843(0xc1)](_0x5f4843(0xa9)+_0x36f116['toFixed'](0x6)+_0x5f4843(0x156));}console['log']('üí∞\x20[CHECK]\x20Payment\x20'+_0x1cd8fc['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x14d8ec[_0x5f4843(0x118)]['toISOString']());}if(_0x18244d['paymentDetails']){const _0x52a921=_0x18244d[_0x5f4843(0x17d)];_0x52a921[_0x5f4843(0x17e)]&&(_0x14d8ec[_0x5f4843(0x11e)]=_0x52a921['iban'],console['log'](_0x5f4843(0x16e)+_0x52a921[_0x5f4843(0x17e)]));if(_0x52a921[_0x5f4843(0xd6)]){const _0xd5bb26=_0x1cd8fc[_0x5f4843(0x174)]||'',_0x2b022e='Bank\x20Details:\x20'+_0x52a921[_0x5f4843(0xd6)];_0x14d8ec[_0x5f4843(0x174)]=_0xd5bb26?_0xd5bb26+'\x0a\x0a'+_0x2b022e:_0x2b022e,console['log']('üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x52a921[_0x5f4843(0x91)]&&console[_0x5f4843(0xc1)](_0x5f4843(0xbb)+_0x52a921[_0x5f4843(0x91)]),_0x52a921[_0x5f4843(0x191)]&&console[_0x5f4843(0xc1)]('‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x52a921[_0x5f4843(0x191)]);}await database_1[_0x5f4843(0x16b)][_0x5f4843(0xaf)][_0x5f4843(0xb5)]({'where':{'id':_0x1cd8fc['id']},'data':_0x14d8ec});if(_0x18244d['status']===_0x5f4843(0x17f)&&_0x1cd8fc[_0x5f4843(0x94)]!==_0x5f4843(0x17f)){console[_0x5f4843(0xc1)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x1cd8fc['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x4cb3c3=await database_1[_0x5f4843(0x16b)][_0x5f4843(0xaf)][_0x5f4843(0xcf)]({'where':{'id':_0x1cd8fc['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x4cb3c3?.['paymentLinkId']&&_0x4cb3c3[_0x5f4843(0xfd)])try{const _0x1a550f=_0x4cb3c3[_0x5f4843(0xfd)];console[_0x5f4843(0xc1)]('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x1a550f['id']+_0x5f4843(0x101)+_0x1a550f[_0x5f4843(0x126)]+_0x5f4843(0xd4)+_0x1a550f['currentPayments']+_0x5f4843(0x102)+_0x1a550f[_0x5f4843(0x94)]);const _0x311646=_0x1a550f[_0x5f4843(0xd2)]+0x1,_0x1cc936=_0x1a550f[_0x5f4843(0x126)]===_0x5f4843(0xa1)?_0x5f4843(0xf9):_0x1a550f[_0x5f4843(0x94)];await database_1[_0x5f4843(0x16b)][_0x5f4843(0xfd)][_0x5f4843(0xb5)]({'where':{'id':_0x1a550f['id']},'data':{'currentPayments':_0x311646,'status':_0x1cc936,'updatedAt':new Date()}}),console[_0x5f4843(0xc1)](_0x5f4843(0x177)+_0x1a550f['id']+_0x5f4843(0xd5)+_0x1a550f[_0x5f4843(0xd2)]+_0x5f4843(0x117)+_0x311646+',\x20status='+_0x1a550f[_0x5f4843(0x94)]+_0x5f4843(0x117)+_0x1cc936);}catch(_0x25f3d0){console[_0x5f4843(0xef)](_0x5f4843(0xbd),_0x25f3d0);}else console[_0x5f4843(0xc1)](_0x5f4843(0x107)+_0x1cd8fc['id']+_0x5f4843(0xfa));}await database_1[_0x5f4843(0x16b)][_0x5f4843(0x161)][_0x5f4843(0x160)]({'data':{'paymentId':_0x1cd8fc['id'],'shopId':_0x1cd8fc[_0x5f4843(0xc9)],'event':_0x5f4843(0x106)+_0x18244d[_0x5f4843(0x94)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x5f4843(0xfc)]({'oldStatus':_0x1cd8fc[_0x5f4843(0x94)],'newStatus':_0x18244d[_0x5f4843(0x94)],'paymentDetails':_0x18244d[_0x5f4843(0x17d)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x5f4843(0xa2)](_0x1cd8fc,_0x18244d[_0x5f4843(0x94)]),await this[_0x5f4843(0x121)](_0x1cd8fc,_0x18244d[_0x5f4843(0x94)]),_0x18244d['status']!==_0x5f4843(0x134)&&(console['log'](_0x5f4843(0xd8)+_0x1cd8fc['id']+_0x5f4843(0x18b)+_0x18244d[_0x5f4843(0x94)]+_0x5f4843(0x15e)),this[_0x5f4843(0x184)](_0x1cd8fc['id'])),console['log'](_0x5f4843(0xe6)+_0x1cd8fc['id']+_0x5f4843(0x188));}else console['log'](_0x5f4843(0xf7)+_0x1cd8fc['id']+_0x5f4843(0x172)+_0x18244d['status']+')'),this[_0x5f4843(0x178)](_0x1cd8fc['id'],_0x1cd8fc[_0x5f4843(0xcb)],_0x1cd8fc[_0x5f4843(0x94)],_0x18244d[_0x5f4843(0x94)],_0x5f4843(0xc8),{'statusUnchanged':!![],'paymentDetails':_0x18244d[_0x5f4843(0x17d)],'amount':_0x18244d['amount'],'currency':_0x18244d[_0x5f4843(0x8f)],'shopId':_0x1cd8fc[_0x5f4843(0xc9)],'checkTimestamp':new Date()[_0x5f4843(0xa0)]()});}catch(_0x3d763b){console['error'](_0x5f4843(0x81)+_0x1cd8fc['id']+':',_0x3d763b),this['logCoinToPayError'](_0x1cd8fc['id'],_0x1cd8fc[_0x5f4843(0xcb)],_0x3d763b,'status_check',{'paymentAmount':_0x1cd8fc[_0x5f4843(0xf6)],'paymentCurrency':_0x1cd8fc[_0x5f4843(0x8f)],'shopId':_0x1cd8fc[_0x5f4843(0xc9)],'createdAt':_0x1cd8fc['createdAt']}),await database_1[_0x5f4843(0x16b)][_0x5f4843(0x161)][_0x5f4843(0x160)]({'data':{'paymentId':_0x1cd8fc['id'],'shopId':_0x1cd8fc[_0x5f4843(0xc9)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x5f4843(0xfc)]({'error':_0x3d763b instanceof Error?_0x3d763b['message']:_0x5f4843(0x148),'gatewayPaymentId':_0x1cd8fc['gatewayPaymentId'],'checkedAt':new Date()[_0x5f4843(0xa0)]()})}});}}async['sendShopWebhook'](_0x193d74,_0x554076){const _0x1a63bd=a42_0x22f567,_0x5bc87e=Date[_0x1a63bd(0x194)]();try{const _0x5537fb=_0x193d74['shop'],_0x592092=_0x5537fb[_0x1a63bd(0x12a)];if(!_0x592092?.['webhookUrl']){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x5537fb['id']);return;}const _0x2ab577=_0x554076===_0x1a63bd(0x17f)?_0x1a63bd(0x10f):_0x554076===_0x1a63bd(0x10d)?_0x1a63bd(0x18f):_0x554076===_0x1a63bd(0x12c)?'payment.failed':_0x1a63bd(0xda);if(!_0x592092[_0x1a63bd(0x88)]?.[_0x1a63bd(0xce)](_0x2ab577)){console['log'](_0x1a63bd(0x11f)+_0x2ab577+_0x1a63bd(0x111)+_0x5537fb['id']);return;}const _0x272f3a=(0x0,gateway_1[_0x1a63bd(0x167)])(_0x193d74[_0x1a63bd(0x16a)])||_0x193d74['gateway'],_0x495c45={'event':_0x2ab577,'payment':{'id':_0x193d74['id'],'order_id':_0x193d74[_0x1a63bd(0x142)],'gateway_order_id':_0x193d74[_0x1a63bd(0x13a)],'gateway':_0x272f3a,'amount':_0x193d74['amount'],'currency':_0x193d74[_0x1a63bd(0x8f)],'status':_0x554076[_0x1a63bd(0x12e)](),'customer_email':_0x193d74[_0x1a63bd(0x165)],'customer_name':_0x193d74[_0x1a63bd(0x168)],'created_at':_0x193d74['createdAt'],'updated_at':new Date()}},_0x359dce=await fetch(_0x592092[_0x1a63bd(0xde)],{'method':'POST','headers':{'Content-Type':_0x1a63bd(0x123),'User-Agent':_0x1a63bd(0x18e)},'body':JSON['stringify'](_0x495c45)}),_0x265310=Date['now']()-_0x5bc87e,_0xad8b79=_0x359dce['ok']?_0x1a63bd(0x11a):await _0x359dce[_0x1a63bd(0x133)]();loggerService_1[_0x1a63bd(0x163)][_0x1a63bd(0x17a)](_0x193d74['shopId'],_0x592092[_0x1a63bd(0xde)],_0x2ab577,_0x359dce['status'],_0x265310,_0x495c45),console['log']('Shop\x20webhook\x20sent\x20to\x20'+_0x592092[_0x1a63bd(0xde)]+_0x1a63bd(0x10e)+_0x359dce[_0x1a63bd(0x94)]+'\x20('+_0x265310+_0x1a63bd(0xe3));}catch(_0x488d50){console[_0x1a63bd(0xef)](_0x1a63bd(0xb8),_0x488d50),loggerService_1[_0x1a63bd(0x163)]['logShopWebhookError'](_0x193d74[_0x1a63bd(0xc9)],_0x193d74['shop']?.[_0x1a63bd(0x12a)]?.['webhookUrl']||_0x1a63bd(0xc2),_0x1a63bd(0x8d),_0x488d50,{});}}async['sendPaymentStatusNotification'](_0xbe14ab,_0x5c95af){const _0x1bd231=a42_0x22f567;try{const _0x2ea9bd={'PENDING':_0x1bd231(0x115),'PAID':_0x1bd231(0x104),'FAILED':'failed','EXPIRED':_0x1bd231(0x103)},_0x18fd16=_0x2ea9bd[_0x5c95af];if(!_0x18fd16||_0x18fd16==='created')return;await telegramBotService_1[_0x1bd231(0x150)][_0x1bd231(0x185)](_0xbe14ab[_0x1bd231(0xc9)],_0xbe14ab,_0x18fd16);}catch(_0xc07e89){console[_0x1bd231(0xef)](_0x1bd231(0xfb),_0xc07e89);}}async[a42_0x22f567(0x95)](_0x2855a2){const _0x27fb98=a42_0x22f567;console[_0x27fb98(0xc1)](_0x27fb98(0x119)+_0x2855a2);const _0x46a45a=await database_1[_0x27fb98(0x16b)]['payment'][_0x27fb98(0xcf)]({'where':{'id':_0x2855a2},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x46a45a)throw new Error('Payment\x20not\x20found');if(_0x46a45a['gateway']!=='cointopay'&&_0x46a45a['gateway']!=='cointopay2')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x27fb98(0xc1)](_0x27fb98(0xb1)+_0x46a45a[_0x27fb98(0x16a)]+_0x27fb98(0xf0)+_0x2855a2),await this['checkSinglePayment'](_0x46a45a),console[_0x27fb98(0xc1)](_0x27fb98(0x151)+_0x2855a2);}[a42_0x22f567(0x12f)](){const _0xb03663=a42_0x22f567,_0xf360c4=this[_0xb03663(0xdb)]?this[_0xb03663(0xb4)]:undefined,_0x450ca2=Array[_0xb03663(0x93)](this[_0xb03663(0x84)][_0xb03663(0x11b)]())['map'](_0x530335=>({'paymentId':_0x530335[_0xb03663(0x179)],'gatewayPaymentId':_0x530335[_0xb03663(0xcb)],'createdAt':_0x530335[_0xb03663(0x15f)],'timersCount':_0x530335[_0xb03663(0xb3)]['length']}));return{'isActive':!!this[_0xb03663(0xdb)],'globalCheckIntervalMinutes':this[_0xb03663(0xb4)]/(0x3e8*0x3c),'expiryDays':this[_0xb03663(0xca)],'activeIndividualTimers':this[_0xb03663(0x84)][_0xb03663(0x144)],'nextGlobalCheckIn':_0xf360c4,'paymentTimersDetails':_0x450ca2};}[a42_0x22f567(0x176)](_0x247de5){const _0x36d4b2=a42_0x22f567,_0x23fc55=this[_0x36d4b2(0x84)][_0x36d4b2(0x187)](_0x247de5);if(_0x23fc55)return{'hasTimers':!![],'timersCount':_0x23fc55[_0x36d4b2(0xb3)][_0x36d4b2(0xec)],'createdAt':_0x23fc55[_0x36d4b2(0x15f)],'gatewayPaymentId':_0x23fc55[_0x36d4b2(0xcb)]};return{'hasTimers':![]};}async[a42_0x22f567(0x114)](_0x118413,_0x13276e){const _0x5f231b=a42_0x22f567;try{const _0x3ea278=await database_1['default'][_0x5f231b(0xae)][_0x5f231b(0xcf)]({'where':{'id':_0x118413},'select':{'gatewaySettings':!![]}});if(!_0x3ea278?.[_0x5f231b(0x182)])return console[_0x5f231b(0xc1)]('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x118413+_0x5f231b(0x9b)),0xa;const _0x3a19cf=JSON[_0x5f231b(0x18d)](_0x3ea278['gatewaySettings']);for(const [_0x8b46db,_0x35df09]of Object[_0x5f231b(0x127)](_0x3a19cf)){if(_0x8b46db[_0x5f231b(0x12e)]()===_0x13276e[_0x5f231b(0x12e)]()){const _0x4fabd6=_0x35df09[_0x5f231b(0xf1)]||0xa;return console[_0x5f231b(0xc1)](_0x5f231b(0x11d)+_0x13276e+_0x5f231b(0xc4)+_0x118413+':\x20'+_0x4fabd6+'%'),_0x4fabd6;}}return console['log'](_0x5f231b(0x158)+_0x13276e+_0x5f231b(0x175)+_0x118413+_0x5f231b(0xd3)),0xa;}catch(_0x188531){return console['error']('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x118413+_0x5f231b(0xa7)+_0x13276e+':',_0x188531),0xa;}}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a42_0x22f567(0x16f)]=new CoinToPayStatusService();