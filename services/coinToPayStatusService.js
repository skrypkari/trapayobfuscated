'use strict';const a37_0x8f5978=a37_0x5845;(function(_0x375186,_0x24b840){const _0x48e428=a37_0x5845,_0x1657a5=_0x375186();while(!![]){try{const _0x58e167=-parseInt(_0x48e428(0x14e))/0x1*(-parseInt(_0x48e428(0x19e))/0x2)+-parseInt(_0x48e428(0x20c))/0x3*(parseInt(_0x48e428(0x17a))/0x4)+parseInt(_0x48e428(0x18e))/0x5+-parseInt(_0x48e428(0x172))/0x6+parseInt(_0x48e428(0x183))/0x7*(-parseInt(_0x48e428(0x196))/0x8)+-parseInt(_0x48e428(0x1a1))/0x9*(-parseInt(_0x48e428(0x1e1))/0xa)+-parseInt(_0x48e428(0x1ac))/0xb;if(_0x58e167===_0x24b840)break;else _0x1657a5['push'](_0x1657a5['shift']());}catch(_0x5000ed){_0x1657a5['push'](_0x1657a5['shift']());}}}(a37_0x2dcc,0xac7bd));var __importDefault=this&&this[a37_0x8f5978(0x164)]||function(_0x5d9780){const _0x5c4798=a37_0x8f5978;return _0x5d9780&&_0x5d9780[_0x5c4798(0x204)]?_0x5d9780:{'default':_0x5d9780};};Object[a37_0x8f5978(0x212)](exports,'__esModule',{'value':!![]}),exports[a37_0x8f5978(0x179)]=exports[a37_0x8f5978(0x144)]=void 0x0;const coinToPayService_1=require(a37_0x8f5978(0x1d3)),database_1=__importDefault(require(a37_0x8f5978(0x180))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a37_0x8f5978(0x19d));function a37_0x2dcc(){const _0x5904c8=['‚è∞\x20[EXPIRY]\x20Payment\x20',',\x20stopping\x20individual\x20checks','default','size','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','FAILED','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','findUnique','get','paidAt','TesSoft\x20Payment\x20System/1.0','shopId','values','\x20in\x20','bankDetails','__esModule','EXPIRY_DAYS','\x20status\x20is\x20','settings','floor','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','globalCheckInterval','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','51XCnNXl','\x20checked,\x20','customerEmail','confirmedOn','checkPaymentStatus','iban','defineProperty','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20not\x20enabled\x20for\x20shop\x20','not\x20confirmed','payment.failed','checkPaymentById','Bank\x20Details:\x20','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20initial\x20timers\x20for\x20payment\x20','createdAt','\x20(after\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','clearPaymentTimers','üßπ\x20[CHECK]\x20Payment\x20','schedule_created','\x20seconds\x20(','coinToPayService','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','from','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','gateway','toISOString','üìä\x20[CHECK]\x20Payment\x20','CoinToPayStatusService','push','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','Automatically\x20expired\x20after\x20','\x20completed\x20for\x20payment\x20','Payment\x20not\x20found','Webhook\x20event\x20','status_check','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','99838KYJSLf','\x20\x20\x20üìù\x20Details:','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','set','adminNotes','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20\x20\x20üìÖ\x20Time:\x20','PAID','startPeriodicStatusCheck','paymentTimers','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20triggered\x20for\x20payment\x20','create','includes','getTime','shop','cointopay_status_check_','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','__importDefault','gatewayPaymentId','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','CoinToPayService','‚ùå\x20[CHECK]\x20Payment\x20','paymentDetails','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','checkAllPendingPayments','toLowerCase','createdOn','forEach','logCoinToPayStatus','Payment\x20older\x20than\x20','Success','689394CmQkzA','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','unknown','\x20skipped,\x20','expired','PENDING','status','coinToPayStatusService','20112LTzIsZ','\x20is\x20too\x20new\x20(','\x20\x20\x20üìä\x20Status:\x20','COINTOPAY_STATUS_CHANGE','\x20to\x20clear','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','../config/database','\x20details:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','28JAdBmy','\x20days,\x20marking\x20as\x20EXPIRED','\x20->\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','checkSinglePayment','payment.pending','‚ùå\x20[HOURLY]\x20Payment\x20','logShopWebhookSent','\x20not\x20found,\x20clearing\x20timers','\x20pending\x20CoinToPay\x20payments','ms)','6212215WWiNwx','\x20days\x20without\x20payment\x20confirmation','h),\x20skipping\x20global\x20check','length','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','‚è∞\x20[GLOBAL]\x20Payment\x20','orderId','837024vFMjjb','\x20days','amount','delay','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','created','./loggerService','22PdjRxU','loggerService','update','9qBKkcA','\x20status\x20from\x20','webhookUrl','telegramBotService','payment.success','catch','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','currency','/status/','logShopWebhookError','description','22047553UgKriu','‚è∞\x20[GLOBAL]\x20Found\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','Failed\x20to\x20send\x20shop\x20webhook:','sendPaymentNotification','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20updated\x20successfully','transactionId','\x20status\x20unchanged\x20(','timers','‚úÖ\x20[HOURLY]\x20Payment\x20','gatewayOrderId','\x20with\x20status\x20','\x20is\x20older\x20than\x20','has','EXPIRED','5\x20minutes','-day\x20timeout','stack','‚úÖ\x20[CHECK]\x20Payment\x20','\x20\x20\x20üìç\x20Source:\x20','\x20status:\x20','sendPaymentStatusNotification','‚è∞\x20[HOURLY]\x20Payment\x20','\x20to\x20','\x20\x20\x20-\x20Status:\x20','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','Shop\x20webhook\x20sent\x20to\x20','GLOBAL_CHECK_INTERVAL_MS','timestamp','0100','ü™ô\x20[GLOBAL]\x20Found\x20','message','sendShopWebhook','log','üí∞\x20[CHECK]\x20Payment\x20','getPaymentTimerInfo','\x20\x20\x20‚ùå\x20Error:\x20','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','./gateways/coinToPayService','cointopay','stringify','customerName','\x20expired\x20CoinToPay\x20payments','\x20\x20\x20-\x20paymentId:\x20','now','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20',',\x20clearing\x20individual\x20timers','COINTOPAY_ERROR','\x20for\x20payment\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20\x20\x20-\x20Gateway:\x20','schedulePaymentChecks','9890420iTZvpY','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','error','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','auto_expire','checkSinglePaymentById','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','logCoinToPayError','application/json','webhookLog','Unknown\x20error','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','payment','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','cointopay_status_check_error','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','checkExpiredPayments','\x20individual\x20payment\x20timers'];a37_0x2dcc=function(){return _0x5904c8;};return a37_0x2dcc();}function a37_0x5845(_0x52c827,_0x2a340a){const _0x2dccb3=a37_0x2dcc();return a37_0x5845=function(_0x5845a7,_0x4d5ec7){_0x5845a7=_0x5845a7-0x131;let _0x2d4399=_0x2dccb3[_0x5845a7];return _0x2d4399;},a37_0x5845(_0x52c827,_0x2a340a);}class CoinToPayStatusService{constructor(){const _0xa60ef9=a37_0x8f5978;this[_0xa60ef9(0x20a)]=null,this[_0xa60ef9(0x1c8)]=0x3c*0x3c*0x3e8,this[_0xa60ef9(0x205)]=0x5,this[_0xa60ef9(0x15b)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0xa60ef9(0x167))](),console[_0xa60ef9(0x1ce)]('ü™ô\x20CoinToPayStatusService\x20initialized');}[a37_0x8f5978(0x1e0)](_0xceb861,_0x31239d){const _0x4e571f=a37_0x8f5978;console[_0x4e571f(0x1ce)](_0x4e571f(0x16a)),console[_0x4e571f(0x1ce)](_0x4e571f(0x1d8)+_0xceb861),console['log']('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x31239d),this['clearPaymentTimers'](_0xceb861);const _0x335f85=[],_0x5a8974=new Date(),_0x53275d=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x4e571f(0x1bc)},{'delay':0x5*0x3c*0x3e8,'description':_0x4e571f(0x1bc)}];console[_0x4e571f(0x1ce)]('ü™ô\x20[DEBUG]\x20Creating\x20'+_0x53275d['length']+_0x4e571f(0x135)+_0xceb861);let _0x68ec7e=0x0;_0x53275d['forEach']((_0x18fbab,_0x113c6d)=>{const _0x5604c3=_0x4e571f;_0x68ec7e+=_0x18fbab[_0x5604c3(0x199)];const _0x33b5aa=setTimeout(async()=>{const _0x261994=_0x5604c3;console[_0x261994(0x1ce)]('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x113c6d+0x1)+_0x261994(0x15d)+_0xceb861+_0x261994(0x137)+_0x18fbab[_0x261994(0x1ab)]+')');try{await this['checkSinglePaymentById'](_0xceb861),console[_0x261994(0x1ce)](_0x261994(0x1e4)+(_0x113c6d+0x1)+_0x261994(0x149)+_0xceb861);}catch(_0x4df12f){console[_0x261994(0x1e3)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x113c6d+0x1)+_0x261994(0x1dd)+_0xceb861+':',_0x4df12f),this[_0x261994(0x1e8)](_0xceb861,_0x31239d,_0x4df12f,_0x261994(0x14c),{'checkNumber':_0x113c6d+0x1,'scheduledAfter':_0x18fbab[_0x261994(0x1ab)],'isIndividualCheck':!![]});}},_0x68ec7e);_0x335f85[_0x5604c3(0x145)](_0x33b5aa),console[_0x5604c3(0x1ce)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x113c6d+0x1)+_0x5604c3(0x1dd)+_0xceb861+_0x5604c3(0x202)+_0x68ec7e/0x3e8+_0x5604c3(0x13c)+_0x18fbab[_0x5604c3(0x1ab)]+')');});const _0x43cf37=setInterval(async()=>{const _0x2a3981=_0x4e571f;console[_0x2a3981(0x1ce)](_0x2a3981(0x147)+_0xceb861);try{const _0x3d99c3=await database_1[_0x2a3981(0x1f6)]['payment'][_0x2a3981(0x1fc)]({'where':{'id':_0xceb861},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x3d99c3){console[_0x2a3981(0x1ce)](_0x2a3981(0x189)+_0xceb861+_0x2a3981(0x18b)),this[_0x2a3981(0x139)](_0xceb861);return;}console['log']('üìä\x20[HOURLY]\x20Payment\x20'+_0xceb861+'\x20current\x20status:\x20'+_0x3d99c3[_0x2a3981(0x178)]);if(_0x3d99c3[_0x2a3981(0x178)]!==_0x2a3981(0x177)){console['log'](_0x2a3981(0x1b6)+_0xceb861+_0x2a3981(0x206)+_0x3d99c3[_0x2a3981(0x178)]+_0x2a3981(0x1f5)),this[_0x2a3981(0x139)](_0xceb861);return;}const _0x2d6e34=Math['floor']((Date[_0x2a3981(0x1d9)]()-_0x3d99c3['createdAt'][_0x2a3981(0x160)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x2d6e34>=this['EXPIRY_DAYS']){console[_0x2a3981(0x1ce)](_0x2a3981(0x1c3)+_0xceb861+_0x2a3981(0x1b9)+this[_0x2a3981(0x205)]+_0x2a3981(0x1ec)),this[_0x2a3981(0x139)](_0xceb861);return;}await this[_0x2a3981(0x1e6)](_0xceb861),console['log'](_0x2a3981(0x14d)+_0xceb861);}catch(_0x1f2222){console['error'](_0x2a3981(0x163)+_0xceb861+':',_0x1f2222),this['logCoinToPayError'](_0xceb861,_0x31239d,_0x1f2222,_0x2a3981(0x14c),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x335f85['push'](_0x43cf37),this[_0x4e571f(0x15b)][_0x4e571f(0x153)](_0xceb861,{'timers':_0x335f85,'paymentId':_0xceb861,'gatewayPaymentId':_0x31239d,'createdAt':_0x5a8974}),console[_0x4e571f(0x1ce)](_0x4e571f(0x140)+_0x53275d[_0x4e571f(0x191)]+_0x4e571f(0x155)+_0xceb861),console[_0x4e571f(0x1ce)](_0x4e571f(0x134)+this[_0x4e571f(0x15b)][_0x4e571f(0x1f7)]),this[_0x4e571f(0x16f)](_0xceb861,_0x31239d,_0x4e571f(0x177),_0x4e571f(0x177),_0x4e571f(0x14c),{'action':_0x4e571f(0x13b),'scheduledChecks':_0x53275d[_0x4e571f(0x191)],'firstCheckIn':_0x53275d[0x0][_0x4e571f(0x199)]/0x3e8,'totalTimers':this[_0x4e571f(0x15b)]['size']});}['clearPaymentTimers'](_0x28ccda){const _0x17d5e1=a37_0x8f5978,_0x488462=this[_0x17d5e1(0x15b)]['get'](_0x28ccda);_0x488462?(console['log']('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x488462[_0x17d5e1(0x1b5)][_0x17d5e1(0x191)]+'\x20timers\x20for\x20payment\x20'+_0x28ccda),_0x488462[_0x17d5e1(0x1b5)][_0x17d5e1(0x16e)]((_0x885043,_0x540189)=>{const _0xff64fa=_0x17d5e1;_0x885043&&(clearTimeout(_0x885043),clearInterval(_0x885043),console['log'](_0xff64fa(0x1f1)+(_0x540189+0x1)+'\x20for\x20payment\x20'+_0x28ccda));}),this[_0x17d5e1(0x15b)]['delete'](_0x28ccda),console['log'](_0x17d5e1(0x1ee)+_0x28ccda+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x17d5e1(0x15b)][_0x17d5e1(0x1f7)])):console[_0x17d5e1(0x1ce)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x28ccda+_0x17d5e1(0x17e));}async[a37_0x8f5978(0x1e6)](_0x526739){const _0x2f20f7=a37_0x8f5978;console[_0x2f20f7(0x1ce)]('üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x526739);const _0x4ff9e5=await database_1[_0x2f20f7(0x1f6)][_0x2f20f7(0x1ed)][_0x2f20f7(0x1fc)]({'where':{'id':_0x526739},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4ff9e5){console[_0x2f20f7(0x1ce)](_0x2f20f7(0x168)+_0x526739+'\x20not\x20found\x20in\x20database');return;}console[_0x2f20f7(0x1ce)](_0x2f20f7(0x143)+_0x526739+'\x20found:'),console['log'](_0x2f20f7(0x1df)+_0x4ff9e5[_0x2f20f7(0x141)]),console[_0x2f20f7(0x1ce)](_0x2f20f7(0x1c5)+_0x4ff9e5[_0x2f20f7(0x178)]),console['log'](_0x2f20f7(0x157)+_0x4ff9e5[_0x2f20f7(0x165)]),console['log']('\x20\x20\x20-\x20Amount:\x20'+_0x4ff9e5['amount']+'\x20'+_0x4ff9e5[_0x2f20f7(0x1a8)]),console[_0x2f20f7(0x1ce)]('\x20\x20\x20-\x20ShopId:\x20'+_0x4ff9e5[_0x2f20f7(0x200)]);if(_0x4ff9e5[_0x2f20f7(0x141)]!==_0x2f20f7(0x1d4)){console[_0x2f20f7(0x1ce)](_0x2f20f7(0x13e)+_0x526739+_0x2f20f7(0x1da)+_0x4ff9e5['gateway']+')');return;}if(_0x4ff9e5[_0x2f20f7(0x178)]!==_0x2f20f7(0x177)){console[_0x2f20f7(0x1ce)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x526739+_0x2f20f7(0x206)+_0x4ff9e5[_0x2f20f7(0x178)]+_0x2f20f7(0x1f5)),this['clearPaymentTimers'](_0x526739);return;}if(!_0x4ff9e5['gatewayPaymentId']){console['log'](_0x2f20f7(0x13e)+_0x526739+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x2f20f7(0x1ce)](_0x2f20f7(0x1bf)+_0x526739+_0x2f20f7(0x152)),await this[_0x2f20f7(0x187)](_0x4ff9e5);}['logCoinToPayStatus'](_0x590aa9,_0xf4b3eb,_0x28ee5d,_0x56e4fc,_0x3dc37c,_0x4d253a){const _0x37afe6=a37_0x8f5978,_0x17f2c={'type':_0x37afe6(0x17d),'paymentId':_0x590aa9,'gatewayPaymentId':_0xf4b3eb,'oldStatus':_0x28ee5d,'newStatus':_0x56e4fc,'source':_0x3dc37c,'timestamp':new Date()[_0x37afe6(0x142)](),'details':_0x4d253a||{}};loggerService_1[_0x37afe6(0x19f)]['logCoinToPayStatus'](_0x17f2c),console[_0x37afe6(0x1ce)](_0x37afe6(0x1ae)+_0x590aa9+'\x20('+_0xf4b3eb+')'),console['log'](_0x37afe6(0x17c)+_0x28ee5d+_0x37afe6(0x185)+_0x56e4fc),console['log'](_0x37afe6(0x1c0)+_0x3dc37c),console[_0x37afe6(0x1ce)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x17f2c[_0x37afe6(0x1c9)]),_0x4d253a&&console[_0x37afe6(0x1ce)](_0x37afe6(0x14f),_0x4d253a);}['logCoinToPayError'](_0x38f139,_0x2729e9,_0x2d655a,_0x3ac3f0,_0x507665){const _0x31954e=a37_0x8f5978,_0x1ea5ba={'type':_0x31954e(0x1dc),'paymentId':_0x38f139,'gatewayPaymentId':_0x2729e9,'error':_0x2d655a instanceof Error?{'message':_0x2d655a[_0x31954e(0x1cc)],'stack':_0x2d655a[_0x31954e(0x1be)]}:_0x2d655a,'source':_0x3ac3f0,'timestamp':new Date()[_0x31954e(0x142)](),'context':_0x507665||{}};loggerService_1[_0x31954e(0x19f)][_0x31954e(0x1e8)](_0x1ea5ba),console[_0x31954e(0x1e3)](_0x31954e(0x209)+_0x38f139+'\x20('+_0x2729e9+')'),console['error'](_0x31954e(0x1d1)+(_0x2d655a instanceof Error?_0x2d655a[_0x31954e(0x1cc)]:_0x2d655a)),console[_0x31954e(0x1e3)](_0x31954e(0x1c0)+_0x3ac3f0),console['error'](_0x31954e(0x158)+_0x1ea5ba[_0x31954e(0x1c9)]),_0x507665&&console[_0x31954e(0x1e3)]('\x20\x20\x20üìù\x20Context:',_0x507665);}[a37_0x8f5978(0x15a)](){const _0x3be6dd=a37_0x8f5978;console[_0x3be6dd(0x1ce)]('ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x3be6dd(0x16b)]()[_0x3be6dd(0x1a6)](_0x50268e=>{const _0x2c80f1=_0x3be6dd;console[_0x2c80f1(0x1e3)](_0x2c80f1(0x17f),_0x50268e);}),this[_0x3be6dd(0x20a)]=setInterval(async()=>{const _0x528e33=_0x3be6dd;try{console[_0x528e33(0x1ce)](_0x528e33(0x1d2)),await this[_0x528e33(0x16b)](),console['log'](_0x528e33(0x1e7));}catch(_0x14a915){console['error']('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x14a915);}},this[_0x3be6dd(0x1c8)]),console[_0x3be6dd(0x1ce)](_0x3be6dd(0x19b));}['stopPeriodicStatusCheck'](){const _0x1e0422=a37_0x8f5978;console[_0x1e0422(0x1ce)](_0x1e0422(0x150));this[_0x1e0422(0x20a)]&&(clearInterval(this[_0x1e0422(0x20a)]),this[_0x1e0422(0x20a)]=null,console[_0x1e0422(0x1ce)](_0x1e0422(0x156)));const _0x5d361a=this[_0x1e0422(0x15b)][_0x1e0422(0x1f7)];for(const [_0x5cb63b]of this[_0x1e0422(0x15b)]){this['clearPaymentTimers'](_0x5cb63b);}console[_0x1e0422(0x1ce)]('üõë\x20[SHUTDOWN]\x20Cleared\x20'+_0x5d361a+_0x1e0422(0x1f3));}async[a37_0x8f5978(0x16b)](){const _0x20e464=a37_0x8f5978;try{console[_0x20e464(0x1ce)]('ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x2de176=await database_1[_0x20e464(0x1f6)]['payment']['findMany']({'where':{'gateway':'cointopay','status':_0x20e464(0x177),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x20e464(0x1cb)+_0x2de176['length']+_0x20e464(0x18c));if(_0x2de176[_0x20e464(0x191)]===0x0){console['log'](_0x20e464(0x193));return;}const _0x3d8db8=await this[_0x20e464(0x1f2)](_0x2de176);console[_0x20e464(0x1ce)](_0x20e464(0x1ad)+_0x3d8db8['length']+_0x20e464(0x1d7));let _0xd4aba3=0x0,_0x4b60de=0x0;for(const _0x29d3a3 of _0x2de176){try{if(_0x3d8db8['includes'](_0x29d3a3['id'])){console['log'](_0x20e464(0x194)+_0x29d3a3['id']+_0x20e464(0x186)),_0x4b60de++;continue;}if(this[_0x20e464(0x15b)][_0x20e464(0x1ba)](_0x29d3a3['id'])){console[_0x20e464(0x1ce)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x29d3a3['id']+_0x20e464(0x15c)),_0x4b60de++;continue;}const _0x56f8db=(Date['now']()-_0x29d3a3[_0x20e464(0x136)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x56f8db<0x1){console['log']('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x29d3a3['id']+_0x20e464(0x17b)+_0x56f8db['toFixed'](0x1)+_0x20e464(0x190)),_0x4b60de++;continue;}console[_0x20e464(0x1ce)](_0x20e464(0x146)+_0x29d3a3['id']+'\x20(age:\x20'+_0x56f8db['toFixed'](0x1)+'h)'),await this[_0x20e464(0x187)](_0x29d3a3),_0xd4aba3++,await new Promise(_0x1aa5dc=>setTimeout(_0x1aa5dc,0x7d0));}catch(_0x549c37){console[_0x20e464(0x1e3)](_0x20e464(0x1de)+_0x29d3a3['id']+':',_0x549c37),this[_0x20e464(0x1e8)](_0x29d3a3['id'],_0x29d3a3[_0x20e464(0x165)]||_0x20e464(0x174),_0x549c37,_0x20e464(0x14c),{'isGlobalCheck':!![],'paymentAmount':_0x29d3a3[_0x20e464(0x198)],'paymentCurrency':_0x29d3a3[_0x20e464(0x1a8)],'shopId':_0x29d3a3[_0x20e464(0x200)],'createdAt':_0x29d3a3['createdAt']}),loggerService_1[_0x20e464(0x19f)]['logWhiteDomainError'](_0x20e464(0x1d4),_0x20e464(0x1a9)+_0x29d3a3[_0x20e464(0x165)],_0x549c37);}}console[_0x20e464(0x1ce)](_0x20e464(0x1a7)+_0xd4aba3+_0x20e464(0x20d)+_0x4b60de+_0x20e464(0x175)+_0x3d8db8[_0x20e464(0x191)]+'\x20expired');}catch(_0xbfb383){console[_0x20e464(0x1e3)](_0x20e464(0x1ef),_0xbfb383);}}async[a37_0x8f5978(0x1f2)](_0x3c0ec1){const _0x1d7646=a37_0x8f5978,_0x3ac3cf=[],_0x180b33=new Date();_0x180b33['setDate'](_0x180b33['getDate']()-this[_0x1d7646(0x205)]),console[_0x1d7646(0x1ce)]('‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x1d7646(0x205)]+'\x20days\x20(created\x20before\x20'+_0x180b33[_0x1d7646(0x142)]()+')');for(const _0x10378c of _0x3c0ec1){if(_0x10378c[_0x1d7646(0x136)]<_0x180b33){console[_0x1d7646(0x1ce)](_0x1d7646(0x1f4)+_0x10378c['id']+_0x1d7646(0x1b9)+this[_0x1d7646(0x205)]+_0x1d7646(0x184));try{this[_0x1d7646(0x16f)](_0x10378c['id'],_0x10378c[_0x1d7646(0x165)]||_0x1d7646(0x174),_0x1d7646(0x177),'EXPIRED','auto_expire',{'reason':_0x1d7646(0x170)+this[_0x1d7646(0x205)]+_0x1d7646(0x197),'createdAt':_0x10378c[_0x1d7646(0x136)],'daysSinceCreation':Math[_0x1d7646(0x208)]((Date['now']()-_0x10378c[_0x1d7646(0x136)][_0x1d7646(0x160)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x10378c['amount'],'paymentCurrency':_0x10378c[_0x1d7646(0x1a8)],'shopId':_0x10378c[_0x1d7646(0x200)]}),await database_1[_0x1d7646(0x1f6)][_0x1d7646(0x1ed)]['update']({'where':{'id':_0x10378c['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x1d7646(0x148)+this[_0x1d7646(0x205)]+_0x1d7646(0x18f)}}),await database_1[_0x1d7646(0x1f6)][_0x1d7646(0x1ea)][_0x1d7646(0x15e)]({'data':{'paymentId':_0x10378c['id'],'shopId':_0x10378c[_0x1d7646(0x200)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x1d7646(0x170)+this[_0x1d7646(0x205)]+'\x20days','createdAt':_0x10378c[_0x1d7646(0x136)],'expiredAt':new Date()[_0x1d7646(0x142)](),'daysSinceCreation':Math[_0x1d7646(0x208)]((Date[_0x1d7646(0x1d9)]()-_0x10378c[_0x1d7646(0x136)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x1d7646(0x1cd)](_0x10378c,_0x1d7646(0x1bb)),await this[_0x1d7646(0x1c2)](_0x10378c,_0x1d7646(0x1bb)),this[_0x1d7646(0x139)](_0x10378c['id']),_0x3ac3cf[_0x1d7646(0x145)](_0x10378c['id']),console['log']('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x10378c['id']+_0x1d7646(0x192)+this[_0x1d7646(0x205)]+_0x1d7646(0x1bd));}catch(_0x1f1382){console[_0x1d7646(0x1e3)]('‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x10378c['id']+':',_0x1f1382),this[_0x1d7646(0x1e8)](_0x10378c['id'],_0x10378c[_0x1d7646(0x165)]||_0x1d7646(0x174),_0x1f1382,_0x1d7646(0x1e5),{'reason':_0x1d7646(0x138),'createdAt':_0x10378c[_0x1d7646(0x136)],'daysSinceCreation':Math['floor']((Date[_0x1d7646(0x1d9)]()-_0x10378c[_0x1d7646(0x136)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x3ac3cf;}async[a37_0x8f5978(0x187)](_0x18f77d){const _0x2cfe74=a37_0x8f5978;if(!_0x18f77d['gatewayPaymentId']){console[_0x2cfe74(0x1ce)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x18f77d['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console['log'](_0x2cfe74(0x1e2)+_0x18f77d['id']+'\x20('+_0x18f77d[_0x2cfe74(0x165)]+')');try{const _0x22db0d=await this[_0x2cfe74(0x13d)][_0x2cfe74(0x210)](_0x18f77d[_0x2cfe74(0x165)]);console[_0x2cfe74(0x1ce)](_0x2cfe74(0x143)+_0x18f77d['id']+_0x2cfe74(0x1c1)+_0x22db0d['status']);_0x22db0d[_0x2cfe74(0x169)]&&console[_0x2cfe74(0x1ce)](_0x2cfe74(0x143)+_0x18f77d['id']+_0x2cfe74(0x181),{'iban':_0x22db0d['paymentDetails']['iban']||'not\x20found','transactionId':_0x22db0d[_0x2cfe74(0x169)][_0x2cfe74(0x1b3)],'createdOn':_0x22db0d[_0x2cfe74(0x169)][_0x2cfe74(0x16d)],'confirmedOn':_0x22db0d[_0x2cfe74(0x169)][_0x2cfe74(0x20f)]||_0x2cfe74(0x215)});if(_0x22db0d[_0x2cfe74(0x178)]!==_0x18f77d['status']){console[_0x2cfe74(0x1ce)](_0x2cfe74(0x1f9)+_0x18f77d['id']+_0x2cfe74(0x1a2)+_0x18f77d[_0x2cfe74(0x178)]+_0x2cfe74(0x1c4)+_0x22db0d[_0x2cfe74(0x178)]),this[_0x2cfe74(0x16f)](_0x18f77d['id'],_0x18f77d[_0x2cfe74(0x165)],_0x18f77d[_0x2cfe74(0x178)],_0x22db0d['status'],_0x2cfe74(0x14c),{'paymentDetails':_0x22db0d['paymentDetails'],'amount':_0x22db0d[_0x2cfe74(0x198)],'currency':_0x22db0d['currency'],'shopId':_0x18f77d[_0x2cfe74(0x200)],'checkTimestamp':new Date()[_0x2cfe74(0x142)]()});const _0x3eaa14={'status':_0x22db0d['status'],'updatedAt':new Date()};_0x22db0d[_0x2cfe74(0x178)]===_0x2cfe74(0x159)&&_0x18f77d[_0x2cfe74(0x178)]!==_0x2cfe74(0x159)&&(_0x3eaa14[_0x2cfe74(0x1fe)]=new Date(),console[_0x2cfe74(0x1ce)](_0x2cfe74(0x1cf)+_0x18f77d['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x3eaa14[_0x2cfe74(0x1fe)][_0x2cfe74(0x142)]()));if(_0x22db0d['paymentDetails']){const _0x48e90c=_0x22db0d[_0x2cfe74(0x169)];_0x48e90c[_0x2cfe74(0x211)]&&(_0x3eaa14['remitterIban']=_0x48e90c[_0x2cfe74(0x211)],console[_0x2cfe74(0x1ce)](_0x2cfe74(0x1b1)+_0x48e90c[_0x2cfe74(0x211)]));if(_0x48e90c[_0x2cfe74(0x203)]){const _0x3eb65e=_0x18f77d[_0x2cfe74(0x154)]||'',_0x1e15d8=_0x2cfe74(0x133)+_0x48e90c[_0x2cfe74(0x203)];_0x3eaa14[_0x2cfe74(0x154)]=_0x3eb65e?_0x3eb65e+'\x0a\x0a'+_0x1e15d8:_0x1e15d8,console[_0x2cfe74(0x1ce)](_0x2cfe74(0x1c6));}_0x48e90c[_0x2cfe74(0x1b3)]&&console[_0x2cfe74(0x1ce)](_0x2cfe74(0x173)+_0x48e90c[_0x2cfe74(0x1b3)]),_0x48e90c[_0x2cfe74(0x20f)]&&console['log'](_0x2cfe74(0x20b)+_0x48e90c['confirmedOn']);}await database_1['default'][_0x2cfe74(0x1ed)][_0x2cfe74(0x1a0)]({'where':{'id':_0x18f77d['id']},'data':_0x3eaa14}),await database_1[_0x2cfe74(0x1f6)]['webhookLog'][_0x2cfe74(0x15e)]({'data':{'paymentId':_0x18f77d['id'],'shopId':_0x18f77d[_0x2cfe74(0x200)],'event':_0x2cfe74(0x162)+_0x22db0d['status'][_0x2cfe74(0x16c)](),'statusCode':0xc8,'responseBody':JSON[_0x2cfe74(0x1d5)]({'oldStatus':_0x18f77d[_0x2cfe74(0x178)],'newStatus':_0x22db0d['status'],'paymentDetails':_0x22db0d['paymentDetails'],'checkedAt':new Date()[_0x2cfe74(0x142)]()})}}),await this[_0x2cfe74(0x1cd)](_0x18f77d,_0x22db0d['status']),await this[_0x2cfe74(0x1c2)](_0x18f77d,_0x22db0d[_0x2cfe74(0x178)]),_0x22db0d[_0x2cfe74(0x178)]!==_0x2cfe74(0x177)&&(console[_0x2cfe74(0x1ce)](_0x2cfe74(0x13a)+_0x18f77d['id']+'\x20status\x20changed\x20to\x20'+_0x22db0d['status']+_0x2cfe74(0x1db)),this['clearPaymentTimers'](_0x18f77d['id'])),console[_0x2cfe74(0x1ce)](_0x2cfe74(0x1bf)+_0x18f77d['id']+_0x2cfe74(0x1b2));}else console['log'](_0x2cfe74(0x143)+_0x18f77d['id']+_0x2cfe74(0x1b4)+_0x22db0d[_0x2cfe74(0x178)]+')'),this[_0x2cfe74(0x16f)](_0x18f77d['id'],_0x18f77d[_0x2cfe74(0x165)],_0x18f77d[_0x2cfe74(0x178)],_0x22db0d[_0x2cfe74(0x178)],_0x2cfe74(0x14c),{'statusUnchanged':!![],'paymentDetails':_0x22db0d[_0x2cfe74(0x169)],'amount':_0x22db0d['amount'],'currency':_0x22db0d[_0x2cfe74(0x1a8)],'shopId':_0x18f77d['shopId'],'checkTimestamp':new Date()['toISOString']()});}catch(_0x3626e6){console[_0x2cfe74(0x1e3)](_0x2cfe74(0x19a)+_0x18f77d['id']+':',_0x3626e6),this[_0x2cfe74(0x1e8)](_0x18f77d['id'],_0x18f77d[_0x2cfe74(0x165)],_0x3626e6,_0x2cfe74(0x14c),{'paymentAmount':_0x18f77d[_0x2cfe74(0x198)],'paymentCurrency':_0x18f77d[_0x2cfe74(0x1a8)],'shopId':_0x18f77d['shopId'],'createdAt':_0x18f77d[_0x2cfe74(0x136)]}),await database_1[_0x2cfe74(0x1f6)][_0x2cfe74(0x1ea)]['create']({'data':{'paymentId':_0x18f77d['id'],'shopId':_0x18f77d[_0x2cfe74(0x200)],'event':_0x2cfe74(0x1f0),'statusCode':0x1f4,'responseBody':JSON[_0x2cfe74(0x1d5)]({'error':_0x3626e6 instanceof Error?_0x3626e6['message']:_0x2cfe74(0x1eb),'gatewayPaymentId':_0x18f77d['gatewayPaymentId'],'checkedAt':new Date()['toISOString']()})}});}}async[a37_0x8f5978(0x1cd)](_0x4075c9,_0x475f01){const _0x3ab6af=a37_0x8f5978,_0x4d3584=Date[_0x3ab6af(0x1d9)]();try{const _0x1f7cd0=_0x4075c9[_0x3ab6af(0x161)],_0xf15830=_0x1f7cd0[_0x3ab6af(0x207)];if(!_0xf15830?.['webhookUrl']){console['log'](_0x3ab6af(0x182)+_0x1f7cd0['id']);return;}const _0x12a912=_0x475f01===_0x3ab6af(0x159)?_0x3ab6af(0x1a5):_0x475f01===_0x3ab6af(0x1fa)?_0x3ab6af(0x131):_0x475f01===_0x3ab6af(0x1bb)?'payment.failed':_0x3ab6af(0x188);if(!_0xf15830['webhookEvents']?.[_0x3ab6af(0x15f)](_0x12a912)){console['log'](_0x3ab6af(0x14b)+_0x12a912+_0x3ab6af(0x214)+_0x1f7cd0['id']);return;}const _0x47e9b6={'event':_0x12a912,'payment':{'id':_0x4075c9['id'],'order_id':_0x4075c9[_0x3ab6af(0x195)],'gateway_order_id':_0x4075c9[_0x3ab6af(0x1b7)],'gateway':_0x3ab6af(0x1ca),'amount':_0x4075c9['amount'],'currency':_0x4075c9[_0x3ab6af(0x1a8)],'status':_0x475f01[_0x3ab6af(0x16c)](),'customer_email':_0x4075c9[_0x3ab6af(0x20e)],'customer_name':_0x4075c9[_0x3ab6af(0x1d6)],'created_at':_0x4075c9[_0x3ab6af(0x136)],'updated_at':new Date()}},_0x57be28=await fetch(_0xf15830[_0x3ab6af(0x1a3)],{'method':'POST','headers':{'Content-Type':_0x3ab6af(0x1e9),'User-Agent':_0x3ab6af(0x1ff)},'body':JSON[_0x3ab6af(0x1d5)](_0x47e9b6)}),_0x565655=Date[_0x3ab6af(0x1d9)]()-_0x4d3584,_0xe709a6=_0x57be28['ok']?_0x3ab6af(0x171):await _0x57be28['text']();loggerService_1[_0x3ab6af(0x19f)][_0x3ab6af(0x18a)](_0x4075c9['shopId'],_0xf15830[_0x3ab6af(0x1a3)],_0x12a912,_0x57be28[_0x3ab6af(0x178)],_0x565655,_0x47e9b6),console['log'](_0x3ab6af(0x1c7)+_0xf15830['webhookUrl']+_0x3ab6af(0x1b8)+_0x57be28['status']+'\x20('+_0x565655+_0x3ab6af(0x18d));}catch(_0xbbc367){console['error'](_0x3ab6af(0x1af),_0xbbc367),loggerService_1[_0x3ab6af(0x19f)][_0x3ab6af(0x1aa)](_0x4075c9[_0x3ab6af(0x200)],_0x4075c9['shop']?.[_0x3ab6af(0x207)]?.['webhookUrl']||_0x3ab6af(0x174),'webhook_send',_0xbbc367,{});}}async['sendPaymentStatusNotification'](_0xfc63bf,_0x94c6){const _0x3b0a3c=a37_0x8f5978;try{const _0x24433a={'PENDING':_0x3b0a3c(0x19c),'PAID':'paid','FAILED':'failed','EXPIRED':_0x3b0a3c(0x176)},_0x58a31e=_0x24433a[_0x94c6];if(!_0x58a31e||_0x58a31e===_0x3b0a3c(0x19c))return;await telegramBotService_1[_0x3b0a3c(0x1a4)][_0x3b0a3c(0x1b0)](_0xfc63bf['shopId'],_0xfc63bf,_0x58a31e);}catch(_0x2e7a7b){console[_0x3b0a3c(0x1e3)](_0x3b0a3c(0x1f8),_0x2e7a7b);}}async[a37_0x8f5978(0x132)](_0x5aed0c){const _0x563e75=a37_0x8f5978;console[_0x563e75(0x1ce)](_0x563e75(0x166)+_0x5aed0c);const _0x5ae3d4=await database_1['default'][_0x563e75(0x1ed)]['findUnique']({'where':{'id':_0x5aed0c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5ae3d4)throw new Error(_0x563e75(0x14a));if(_0x5ae3d4['gateway']!==_0x563e75(0x1d4))throw new Error(_0x563e75(0x1fb));console['log'](_0x563e75(0x213)+_0x5aed0c),await this[_0x563e75(0x187)](_0x5ae3d4),console[_0x563e75(0x1ce)](_0x563e75(0x151)+_0x5aed0c);}['getServiceStats'](){const _0x162028=a37_0x8f5978,_0x190f3b=this[_0x162028(0x20a)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x3bb284=Array[_0x162028(0x13f)](this[_0x162028(0x15b)][_0x162028(0x201)]())['map'](_0x25bc85=>({'paymentId':_0x25bc85['paymentId'],'gatewayPaymentId':_0x25bc85['gatewayPaymentId'],'createdAt':_0x25bc85[_0x162028(0x136)],'timersCount':_0x25bc85[_0x162028(0x1b5)][_0x162028(0x191)]}));return{'isActive':!!this[_0x162028(0x20a)],'globalCheckIntervalMinutes':this[_0x162028(0x1c8)]/(0x3e8*0x3c),'expiryDays':this[_0x162028(0x205)],'activeIndividualTimers':this[_0x162028(0x15b)]['size'],'nextGlobalCheckIn':_0x190f3b,'paymentTimersDetails':_0x3bb284};}[a37_0x8f5978(0x1d0)](_0x4dff6c){const _0x2b2616=a37_0x8f5978,_0xde7d07=this['paymentTimers'][_0x2b2616(0x1fd)](_0x4dff6c);if(_0xde7d07)return{'hasTimers':!![],'timersCount':_0xde7d07[_0x2b2616(0x1b5)][_0x2b2616(0x191)],'createdAt':_0xde7d07['createdAt'],'gatewayPaymentId':_0xde7d07[_0x2b2616(0x165)]};return{'hasTimers':![]};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a37_0x8f5978(0x179)]=new CoinToPayStatusService();