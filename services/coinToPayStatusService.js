'use strict';const a57_0x2c684f=a57_0x1548;(function(_0x500ef5,_0x5da697){const _0x322658=a57_0x1548,_0x5710a0=_0x500ef5();while(!![]){try{const _0x496b6a=-parseInt(_0x322658(0x16e))/0x1*(parseInt(_0x322658(0x17a))/0x2)+-parseInt(_0x322658(0x1fc))/0x3*(parseInt(_0x322658(0x165))/0x4)+-parseInt(_0x322658(0x11e))/0x5+-parseInt(_0x322658(0x18c))/0x6+-parseInt(_0x322658(0x1b3))/0x7+-parseInt(_0x322658(0x106))/0x8*(parseInt(_0x322658(0x206))/0x9)+-parseInt(_0x322658(0x1fd))/0xa*(-parseInt(_0x322658(0x136))/0xb);if(_0x496b6a===_0x5da697)break;else _0x5710a0['push'](_0x5710a0['shift']());}catch(_0xa7bedb){_0x5710a0['push'](_0x5710a0['shift']());}}}(a57_0x36f7,0x2e8ec));function a57_0x36f7(){const _0x27c279=['12jTgcah','\x20commission\x20for\x20shop\x20','error','âŒ\x20[TIMER]\x20Failed\x20individual\x20check\x20#','now','expired',',\x20currentPayments=','unknown','CoinToPay2Service','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','createHmac','checkExpiredPayments','ðŸ“ˆ\x20[COINTOPAY]\x20Payment\x20','logCoinToPayStatus','âœ…\x20[COINTOPAY]\x20Payment\x20link\x20','payment.pending',',\x20status=','gatewayPaymentId','42090coNhEW','coinToPayService','create','getPaymentTimerInfo','checkSinglePayment','Success','remitterIban','getDate','message','cointopay_status_check_','Failed\x20to\x20mark\x20payment\x20as\x20expired',',\x20stopping\x20individual\x20checks','â°\x20[EXPIRY]\x20Payment\x20','log','\x20not\x20found,\x20clearing\x20timers','parse','checkSinglePaymentById','paymentLink','/status/','status_check','\x20\x20\x20-\x20gatewayPaymentId:\x20','shop','checkAllPendingPayments','length','âŒ\x20[CHECK]\x20Payment\x20','ðŸª™\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','./gateways/coinToPayService','âœ…\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','sendPaymentNotification','\x20\x20\x20Gateway\x20','\x20to\x20clear','transactionId','logCoinToPayError','auto_expire','schedulePaymentChecks','â°\x20[GLOBAL]\x20Payment\x20','gatewaySettings','\x20\x20\x20-\x20Gateway:\x20','1807708KEGIoH','delay','\x20found:','schedule_created','\x20expired','amount','cointopay','./gateways/coinToPay2Service','push','getTime','loggerService','h),\x20skipping\x20global\x20check','ðŸª™\x20[DEBUG]\x20Creating\x20','confirmedOn','PAID','\x20individual\x20payment\x20timers','from','\x20\x20\x20Amount\x20after\x20commission:\x20','secretKey','get','\x20\x20\x20ðŸ“Š\x20Status:\x20','â°\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20is\x20too\x20new\x20(','\x20(after\x20','./currencyService','shopId','ðŸ’°\x20[CHECK]\x20Payment\x20','gatewayOrderId','ðŸª™\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','./loggerService','\x20in\x20shop\x20','iban','âœ…\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','SINGLE','../config/database','\x20days','cointopay2','created','update','ðŸ“Š\x20[CHECK]\x20Payment\x20','ðŸ§¹\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20skipped,\x20','\x20is\x20older\x20than\x20','âŒ\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','ðŸ”\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','webhookUrl','Shop\x20webhook\x20sent\x20to\x20','âœ…\x20[HOURLY]\x20Payment\x20','\x20not\x20enabled\x20for\x20shop\x20','orderId','ðŸ›‘\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','payment.success','timers','createdAt','FAILED','startPeriodicStatusCheck','set','\x20for\x20payment\x20','ms)','âŒ\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','defineProperty','toLowerCase','\x20timers\x20for\x20payment\x20','payment.failed','delete','\x20details:','stopPeriodicStatusCheck','âœ…\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','floor','\x20updated\x20successfully','ðŸª™\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','bankDetails','coinToPayStatusService','6RegZUO','550RmOkGf','COINTOPAY_STATUS_CHANGE','__esModule','forEach','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20has\x20no\x20gatewayPaymentId','setDate','COINTOPAY_ERROR','\x20checked,\x20','157068pXcwmA','includes','\x20\x20\x20ðŸ“\x20Context:','\x20->\x20','payment','âœ…\x20[CHECK]\x20Payment\x20','\x20status\x20is\x20','logWhiteDomainError','ðŸª™\x20[TIMER]\x20Individual\x20check\x20#','has','âŒ\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','toISOString','ðŸ“Š\x20[CHECK]\x20CoinToPay\x20payment\x20','default','../types/gateway','\x20status\x20unchanged\x20(','\x20updated:\x20currentPayments=','80ueOaAs','webhookEvents','Webhook\x20event\x20','toFixed','\x20completed\x20for\x20payment\x20','clearPaymentTimers','./telegramBotService','\x20pending\x20CoinToPay\x20payments','Failed\x20to\x20send\x20shop\x20webhook:','description','ðŸ”\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','âŒ\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','Payment\x20older\x20than\x20','âŒ\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','ðŸ†”\x20[CHECK]\x20Transaction\x20ID:\x20','âœ…\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','gatewayCommissionRate','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check',',\x20gateway\x20','createdOn','\x20\x20\x20-\x20Status:\x20','getGatewayIdByName','PENDING','ðŸ¦\x20[CHECK]\x20Bank\x20details\x20provided:\x20','1836615ktmcIW','paymentLinkId','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','\x20\x20\x20ðŸ“\x20Source:\x20','\x20amounts\x20calculated:','\x20commission:\x20','size','GLOBAL_CHECK_INTERVAL_MS','paymentTimers','paid','\x20status\x20from\x20','timestamp','ðŸ”„\x20[CHECK]\x20Updating\x20payment\x20','Unknown\x20error','coinToPay2Service','âŒ\x20[HOURLY]\x20Payment\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...',',\x20using\x20default\x20commission\x2010%','âš ï¸\x20[CHECK]\x20Payment\x20','Gateway\x20','__importDefault','sendShopWebhook','\x20status\x20changed\x20to\x20','checkPaymentStatus','336776oqUUdg','\x20seconds\x20(','paidAt','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20not\x20found\x20in\x20database','findUnique','âœ…\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','CoinToPayStatusService','currency','amountAfterGatewayCommissionUSDT','\x20\x20\x20-\x20ShopId:\x20','status','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','COMPLETED','amountUSDT','\x20with\x20status\x20','paymentDetails','EXPIRED','\x20to\x20','\x20in\x20','\x20\x20\x20ðŸ“\x20Details:','Payment\x20System/1.0','5\x20minutes','\x20expired\x20CoinToPay\x20payments','\x20USDT','sha256','âŒ\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20current\x20status:\x20','âœ…\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','convertToUSDT','crypto','currentPayments','stringify','currencyService','âœ…\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','hex','\x20\x20\x20ðŸ“…\x20Time:\x20','findMany','ðŸª™\x20[GLOBAL]\x20Found\x20','customerEmail','â°\x20[GLOBAL]\x20Found\x20',',\x20using\x20default\x2010%','map','gateway','âš ï¸\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','646444QiKVoM','\x20\x20\x20Amount:\x20','âŒ\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','not\x20confirmed','globalCheckInterval','\x20days,\x20marking\x20as\x20EXPIRED','checkPaymentById','ðŸ”\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','ðŸ“ˆ\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','60476PpbFUY','webhookLog','ðŸª™\x20[ERROR]\x20CoinToPay\x20Error:\x20','sendPaymentStatusNotification','customerName','commission','catch','\x20payment\x20','ðŸª™\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','ðŸ§¹\x20[CHECK]\x20Payment\x20','ðŸª™\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','EXPIRY_DAYS'];a57_0x36f7=function(){return _0x27c279;};return a57_0x36f7();}function a57_0x1548(_0x37ea2d,_0x14b066){_0x37ea2d=_0x37ea2d-0x100;const _0x36f794=a57_0x36f7();let _0x1548f5=_0x36f794[_0x37ea2d];return _0x1548f5;}var __importDefault=this&&this[a57_0x2c684f(0x132)]||function(_0x12baaf){const _0x401c96=a57_0x2c684f;return _0x12baaf&&_0x12baaf[_0x401c96(0x1ff)]?_0x12baaf:{'default':_0x12baaf};};Object[a57_0x2c684f(0x1ef)](exports,a57_0x2c684f(0x1ff),{'value':!![]}),exports[a57_0x2c684f(0x1fb)]=exports[a57_0x2c684f(0x13d)]=void 0x0;const crypto_1=__importDefault(require(a57_0x2c684f(0x154))),coinToPayService_1=require(a57_0x2c684f(0x1a6)),coinToPay2Service_1=require(a57_0x2c684f(0x1ba)),gateway_1=require(a57_0x2c684f(0x103)),database_1=__importDefault(require(a57_0x2c684f(0x1d5))),telegramBotService_1=require(a57_0x2c684f(0x10c)),loggerService_1=require(a57_0x2c684f(0x1d0)),currencyService_1=require(a57_0x2c684f(0x1cb));class CoinToPayStatusService{constructor(){const _0xa6a776=a57_0x2c684f;this[_0xa6a776(0x169)]=null,this[_0xa6a776(0x125)]=0x3c*0x3c*0x3e8,this[_0xa6a776(0x179)]=0x5,this['paymentTimers']=new Map(),this[_0xa6a776(0x18d)]=new coinToPayService_1['CoinToPayService'](),this[_0xa6a776(0x12c)]=new coinToPay2Service_1[(_0xa6a776(0x182))](),console[_0xa6a776(0x199)](_0xa6a776(0x1cf));}[a57_0x2c684f(0x1af)](_0x364898,_0x49d0fc){const _0x3bcf83=a57_0x2c684f;console['log']('ðŸª™\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x3bcf83(0x199)]('\x20\x20\x20-\x20paymentId:\x20'+_0x364898),console[_0x3bcf83(0x199)](_0x3bcf83(0x1a0)+_0x49d0fc),this[_0x3bcf83(0x10b)](_0x364898);const _0x44f3a7=[],_0x34f5ee=new Date(),_0x49ce0c=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x3bcf83(0x14c)}];console[_0x3bcf83(0x199)](_0x3bcf83(0x1bf)+_0x49ce0c[_0x3bcf83(0x1a3)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x364898);let _0x5a5e21=0x0;_0x49ce0c[_0x3bcf83(0x200)]((_0x51df2d,_0x230dc7)=>{const _0x5f057c=_0x3bcf83;_0x5a5e21+=_0x51df2d[_0x5f057c(0x1b4)];const _0x314b96=setTimeout(async()=>{const _0x688b11=_0x5f057c;console[_0x688b11(0x199)](_0x688b11(0x20e)+(_0x230dc7+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x364898+_0x688b11(0x1ca)+_0x51df2d[_0x688b11(0x10f)]+')');try{await this[_0x688b11(0x19c)](_0x364898),console[_0x688b11(0x199)]('âœ…\x20[TIMER]\x20Individual\x20check\x20#'+(_0x230dc7+0x1)+_0x688b11(0x10a)+_0x364898);}catch(_0x484b03){console[_0x688b11(0x17c)](_0x688b11(0x17d)+(_0x230dc7+0x1)+'\x20for\x20payment\x20'+_0x364898+':',_0x484b03),this[_0x688b11(0x1ad)](_0x364898,_0x49d0fc,_0x484b03,_0x688b11(0x19f),{'checkNumber':_0x230dc7+0x1,'scheduledAfter':_0x51df2d[_0x688b11(0x10f)],'isIndividualCheck':!![]});}},_0x5a5e21);_0x44f3a7[_0x5f057c(0x1bb)](_0x314b96),console['log']('â°\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x230dc7+0x1)+_0x5f057c(0x1ec)+_0x364898+_0x5f057c(0x149)+_0x5a5e21/0x3e8+_0x5f057c(0x137)+_0x51df2d[_0x5f057c(0x10f)]+')');});const _0x206fb4=setInterval(async()=>{const _0x1d5f05=_0x3bcf83;console['log']('ðŸª™\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x364898);try{const _0x266caa=await database_1[_0x1d5f05(0x102)][_0x1d5f05(0x20a)][_0x1d5f05(0x13b)]({'where':{'id':_0x364898},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x266caa){console['log'](_0x1d5f05(0x12d)+_0x364898+_0x1d5f05(0x19a)),this['clearPaymentTimers'](_0x364898);return;}console[_0x1d5f05(0x199)]('ðŸ“Š\x20[HOURLY]\x20Payment\x20'+_0x364898+_0x1d5f05(0x151)+_0x266caa[_0x1d5f05(0x141)]);if(_0x266caa[_0x1d5f05(0x141)]!=='PENDING'){console[_0x1d5f05(0x199)](_0x1d5f05(0x1e2)+_0x364898+_0x1d5f05(0x20c)+_0x266caa[_0x1d5f05(0x141)]+_0x1d5f05(0x197)),this['clearPaymentTimers'](_0x364898);return;}const _0x21b79f=Math[_0x1d5f05(0x1f7)]((Date[_0x1d5f05(0x17e)]()-_0x266caa[_0x1d5f05(0x1e8)][_0x1d5f05(0x1bc)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x21b79f>=this[_0x1d5f05(0x179)]){console[_0x1d5f05(0x199)]('â°\x20[HOURLY]\x20Payment\x20'+_0x364898+_0x1d5f05(0x1dd)+this[_0x1d5f05(0x179)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x1d5f05(0x10b)](_0x364898);return;}await this[_0x1d5f05(0x19c)](_0x364898),console[_0x1d5f05(0x199)](_0x1d5f05(0x1f6)+_0x364898);}catch(_0x5052e9){console[_0x1d5f05(0x17c)]('âŒ\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x364898+':',_0x5052e9),this[_0x1d5f05(0x1ad)](_0x364898,_0x49d0fc,_0x5052e9,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x44f3a7['push'](_0x206fb4),this[_0x3bcf83(0x126)][_0x3bcf83(0x1eb)](_0x364898,{'timers':_0x44f3a7,'paymentId':_0x364898,'gatewayPaymentId':_0x49d0fc,'createdAt':_0x34f5ee}),console[_0x3bcf83(0x199)]('âœ…\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x49ce0c[_0x3bcf83(0x1a3)]+_0x3bcf83(0x201)+_0x364898),console['log']('ðŸ“Š\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this['paymentTimers'][_0x3bcf83(0x124)]),this[_0x3bcf83(0x187)](_0x364898,_0x49d0fc,_0x3bcf83(0x11c),_0x3bcf83(0x11c),_0x3bcf83(0x19f),{'action':_0x3bcf83(0x1b6),'scheduledChecks':_0x49ce0c[_0x3bcf83(0x1a3)],'firstCheckIn':_0x49ce0c[0x0]['delay']/0x3e8,'totalTimers':this[_0x3bcf83(0x126)][_0x3bcf83(0x124)]});}[a57_0x2c684f(0x10b)](_0x270540){const _0x31739d=a57_0x2c684f,_0x55f32c=this[_0x31739d(0x126)]['get'](_0x270540);_0x55f32c?(console[_0x31739d(0x199)]('ðŸ§¹\x20[DEBUG]\x20Clearing\x20'+_0x55f32c['timers'][_0x31739d(0x1a3)]+_0x31739d(0x1f1)+_0x270540),_0x55f32c[_0x31739d(0x1e7)][_0x31739d(0x200)]((_0x27ad2a,_0x55f5b6)=>{const _0xa977d0=_0x31739d;_0x27ad2a&&(clearTimeout(_0x27ad2a),clearInterval(_0x27ad2a),console[_0xa977d0(0x199)](_0xa977d0(0x1db)+(_0x55f5b6+0x1)+_0xa977d0(0x1ec)+_0x270540));}),this[_0x31739d(0x126)][_0x31739d(0x1f3)](_0x270540),console['log'](_0x31739d(0x158)+_0x270540+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x31739d(0x126)][_0x31739d(0x124)])):console[_0x31739d(0x199)](_0x31739d(0x163)+_0x270540+_0x31739d(0x1ab));}async[a57_0x2c684f(0x19c)](_0x35c40a){const _0x17e6ef=a57_0x2c684f;console[_0x17e6ef(0x199)](_0x17e6ef(0x1df)+_0x35c40a);const _0x2eceb1=await database_1[_0x17e6ef(0x102)][_0x17e6ef(0x20a)]['findUnique']({'where':{'id':_0x35c40a},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2eceb1){console[_0x17e6ef(0x199)](_0x17e6ef(0x1a4)+_0x35c40a+_0x17e6ef(0x13a));return;}console[_0x17e6ef(0x199)](_0x17e6ef(0x1da)+_0x35c40a+_0x17e6ef(0x1b5)),console['log'](_0x17e6ef(0x1b2)+_0x2eceb1[_0x17e6ef(0x162)]),console[_0x17e6ef(0x199)](_0x17e6ef(0x11a)+_0x2eceb1['status']),console[_0x17e6ef(0x199)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x2eceb1['gatewayPaymentId']),console['log']('\x20\x20\x20-\x20Amount:\x20'+_0x2eceb1['amount']+'\x20'+_0x2eceb1['currency']),console[_0x17e6ef(0x199)](_0x17e6ef(0x140)+_0x2eceb1[_0x17e6ef(0x1cc)]);if(_0x2eceb1[_0x17e6ef(0x162)]!==_0x17e6ef(0x1b9)&&_0x2eceb1['gateway']!=='cointopay2'){console[_0x17e6ef(0x199)](_0x17e6ef(0x130)+_0x35c40a+'\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20'+_0x2eceb1[_0x17e6ef(0x162)]+')');return;}if(_0x2eceb1[_0x17e6ef(0x141)]!=='PENDING'){console['log'](_0x17e6ef(0x130)+_0x35c40a+'\x20status\x20is\x20'+_0x2eceb1[_0x17e6ef(0x141)]+_0x17e6ef(0x197)),this[_0x17e6ef(0x10b)](_0x35c40a);return;}if(!_0x2eceb1[_0x17e6ef(0x18b)]){console[_0x17e6ef(0x199)](_0x17e6ef(0x130)+_0x35c40a+_0x17e6ef(0x202));return;}console[_0x17e6ef(0x199)](_0x17e6ef(0x20b)+_0x35c40a+_0x17e6ef(0x12e)),await this[_0x17e6ef(0x190)](_0x2eceb1);}[a57_0x2c684f(0x187)](_0x16e845,_0x201d42,_0x4da5e6,_0xd22a5d,_0x2dd14c,_0x4e3d70){const _0xf148eb=a57_0x2c684f,_0x5c78fb={'type':_0xf148eb(0x1fe),'paymentId':_0x16e845,'gatewayPaymentId':_0x201d42,'oldStatus':_0x4da5e6,'newStatus':_0xd22a5d,'source':_0x2dd14c,'timestamp':new Date()[_0xf148eb(0x100)](),'details':_0x4e3d70||{}};loggerService_1[_0xf148eb(0x1bd)][_0xf148eb(0x187)](_0x5c78fb),console['log'](_0xf148eb(0x1f9)+_0x16e845+'\x20('+_0x201d42+')'),console[_0xf148eb(0x199)](_0xf148eb(0x1c7)+_0x4da5e6+_0xf148eb(0x209)+_0xd22a5d),console[_0xf148eb(0x199)]('\x20\x20\x20ðŸ“\x20Source:\x20'+_0x2dd14c),console[_0xf148eb(0x199)](_0xf148eb(0x15b)+_0x5c78fb[_0xf148eb(0x129)]),_0x4e3d70&&console[_0xf148eb(0x199)](_0xf148eb(0x14a),_0x4e3d70);}[a57_0x2c684f(0x1ad)](_0x442810,_0x255637,_0x354353,_0x285e12,_0x1e772d){const _0x5b8ac6=a57_0x2c684f,_0x1f55de={'type':_0x5b8ac6(0x204),'paymentId':_0x442810,'gatewayPaymentId':_0x255637,'error':_0x354353 instanceof Error?{'message':_0x354353['message'],'stack':_0x354353['stack']}:_0x354353,'source':_0x285e12,'timestamp':new Date()[_0x5b8ac6(0x100)](),'context':_0x1e772d||{}};loggerService_1[_0x5b8ac6(0x1bd)]['logCoinToPayError'](_0x1f55de),console[_0x5b8ac6(0x17c)](_0x5b8ac6(0x170)+_0x442810+'\x20('+_0x255637+')'),console['error']('\x20\x20\x20âŒ\x20Error:\x20'+(_0x354353 instanceof Error?_0x354353[_0x5b8ac6(0x194)]:_0x354353)),console[_0x5b8ac6(0x17c)](_0x5b8ac6(0x121)+_0x285e12),console['error'](_0x5b8ac6(0x15b)+_0x1f55de['timestamp']),_0x1e772d&&console['error'](_0x5b8ac6(0x208),_0x1e772d);}[a57_0x2c684f(0x1ea)](){const _0x5443cc=a57_0x2c684f;console['log']('ðŸª™\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x5443cc(0x1a2)]()[_0x5443cc(0x174)](_0x23b58f=>{const _0x391266=_0x5443cc;console[_0x391266(0x17c)](_0x391266(0x150),_0x23b58f);}),this[_0x5443cc(0x169)]=setInterval(async()=>{const _0x21cd40=_0x5443cc;try{console[_0x21cd40(0x199)](_0x21cd40(0x178)),await this[_0x21cd40(0x1a2)](),console[_0x21cd40(0x199)](_0x21cd40(0x13c));}catch(_0x260668){console[_0x21cd40(0x17c)](_0x21cd40(0x1de),_0x260668);}},this[_0x5443cc(0x125)]),console[_0x5443cc(0x199)](_0x5443cc(0x115));}[a57_0x2c684f(0x1f5)](){const _0x176342=a57_0x2c684f;console[_0x176342(0x199)](_0x176342(0x1e5));this['globalCheckInterval']&&(clearInterval(this[_0x176342(0x169)]),this['globalCheckInterval']=null,console[_0x176342(0x199)]('ðŸ›‘\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x281dad=this['paymentTimers'][_0x176342(0x124)];for(const [_0x34a468]of this['paymentTimers']){this['clearPaymentTimers'](_0x34a468);}console[_0x176342(0x199)]('ðŸ›‘\x20[SHUTDOWN]\x20Cleared\x20'+_0x281dad+_0x176342(0x1c2));}async[a57_0x2c684f(0x1a2)](){const _0x13aa97=a57_0x2c684f;try{console[_0x13aa97(0x199)](_0x13aa97(0x176));const _0xdd00ad=await database_1['default'][_0x13aa97(0x20a)][_0x13aa97(0x15c)]({'where':{'gateway':{'in':[_0x13aa97(0x1b9),'cointopay2']},'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x13aa97(0x199)](_0x13aa97(0x15d)+_0xdd00ad[_0x13aa97(0x1a3)]+_0x13aa97(0x10d));if(_0xdd00ad[_0x13aa97(0x1a3)]===0x0){console[_0x13aa97(0x199)](_0x13aa97(0x1a5));return;}const _0x17a207=await this[_0x13aa97(0x185)](_0xdd00ad);console[_0x13aa97(0x199)](_0x13aa97(0x15f)+_0x17a207['length']+_0x13aa97(0x14d));let _0x4e88bd=0x0,_0x3cc8ea=0x0;for(const _0x712de7 of _0xdd00ad){try{if(_0x17a207[_0x13aa97(0x207)](_0x712de7['id'])){console['log'](_0x13aa97(0x1b0)+_0x712de7['id']+_0x13aa97(0x117)),_0x3cc8ea++;continue;}if(this['paymentTimers'][_0x13aa97(0x20f)](_0x712de7['id'])){console[_0x13aa97(0x199)](_0x13aa97(0x1b0)+_0x712de7['id']+_0x13aa97(0x139)),_0x3cc8ea++;continue;}const _0x2fa341=(Date[_0x13aa97(0x17e)]()-_0x712de7[_0x13aa97(0x1e8)][_0x13aa97(0x1bc)]())/(0x3e8*0x3c*0x3c);if(_0x2fa341<0x1){console[_0x13aa97(0x199)](_0x13aa97(0x1b0)+_0x712de7['id']+_0x13aa97(0x1c9)+_0x2fa341[_0x13aa97(0x109)](0x1)+_0x13aa97(0x1be)),_0x3cc8ea++;continue;}console[_0x13aa97(0x199)](_0x13aa97(0x110)+_0x712de7['id']+'\x20(age:\x20'+_0x2fa341[_0x13aa97(0x109)](0x1)+'h)'),await this[_0x13aa97(0x190)](_0x712de7),_0x4e88bd++,await new Promise(_0x179a46=>setTimeout(_0x179a46,0x7d0));}catch(_0x1220f3){console[_0x13aa97(0x17c)](_0x13aa97(0x167)+_0x712de7['id']+':',_0x1220f3),this['logCoinToPayError'](_0x712de7['id'],_0x712de7[_0x13aa97(0x18b)]||'unknown',_0x1220f3,_0x13aa97(0x19f),{'isGlobalCheck':!![],'paymentAmount':_0x712de7[_0x13aa97(0x1b8)],'paymentCurrency':_0x712de7[_0x13aa97(0x13e)],'shopId':_0x712de7[_0x13aa97(0x1cc)],'createdAt':_0x712de7[_0x13aa97(0x1e8)]}),loggerService_1[_0x13aa97(0x1bd)][_0x13aa97(0x20d)](_0x13aa97(0x1b9),_0x13aa97(0x19e)+_0x712de7['gatewayPaymentId'],_0x1220f3);}}console[_0x13aa97(0x199)](_0x13aa97(0x152)+_0x4e88bd+_0x13aa97(0x205)+_0x3cc8ea+_0x13aa97(0x1dc)+_0x17a207[_0x13aa97(0x1a3)]+_0x13aa97(0x1b7));}catch(_0x5f326a){console['error'](_0x13aa97(0x210),_0x5f326a);}}async[a57_0x2c684f(0x185)](_0x1f3c93){const _0x2a6e4d=a57_0x2c684f,_0x47dfe6=[],_0x2c7d19=new Date();_0x2c7d19[_0x2a6e4d(0x203)](_0x2c7d19[_0x2a6e4d(0x193)]()-this[_0x2a6e4d(0x179)]),console['log'](_0x2a6e4d(0x1c8)+this[_0x2a6e4d(0x179)]+'\x20days\x20(created\x20before\x20'+_0x2c7d19[_0x2a6e4d(0x100)]()+')');for(const _0x1df7d9 of _0x1f3c93){if(_0x1df7d9[_0x2a6e4d(0x1e8)]<_0x2c7d19){console[_0x2a6e4d(0x199)](_0x2a6e4d(0x198)+_0x1df7d9['id']+_0x2a6e4d(0x1dd)+this[_0x2a6e4d(0x179)]+_0x2a6e4d(0x16a));try{this[_0x2a6e4d(0x187)](_0x1df7d9['id'],_0x1df7d9['gatewayPaymentId']||'unknown','PENDING',_0x2a6e4d(0x147),_0x2a6e4d(0x1ae),{'reason':_0x2a6e4d(0x112)+this['EXPIRY_DAYS']+_0x2a6e4d(0x1d6),'createdAt':_0x1df7d9[_0x2a6e4d(0x1e8)],'daysSinceCreation':Math[_0x2a6e4d(0x1f7)]((Date[_0x2a6e4d(0x17e)]()-_0x1df7d9[_0x2a6e4d(0x1e8)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x1df7d9[_0x2a6e4d(0x1b8)],'paymentCurrency':_0x1df7d9['currency'],'shopId':_0x1df7d9[_0x2a6e4d(0x1cc)]}),await database_1[_0x2a6e4d(0x102)][_0x2a6e4d(0x20a)][_0x2a6e4d(0x1d9)]({'where':{'id':_0x1df7d9['id']},'data':{'status':_0x2a6e4d(0x147),'updatedAt':new Date()}}),await database_1[_0x2a6e4d(0x102)][_0x2a6e4d(0x16f)]['create']({'data':{'paymentId':_0x1df7d9['id'],'shopId':_0x1df7d9[_0x2a6e4d(0x1cc)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x2a6e4d(0x156)]({'reason':_0x2a6e4d(0x112)+this[_0x2a6e4d(0x179)]+'\x20days','createdAt':_0x1df7d9[_0x2a6e4d(0x1e8)],'expiredAt':new Date()[_0x2a6e4d(0x100)](),'daysSinceCreation':Math[_0x2a6e4d(0x1f7)]((Date[_0x2a6e4d(0x17e)]()-_0x1df7d9[_0x2a6e4d(0x1e8)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x1df7d9,_0x2a6e4d(0x147)),await this[_0x2a6e4d(0x171)](_0x1df7d9,'EXPIRED'),this['clearPaymentTimers'](_0x1df7d9['id']),_0x47dfe6[_0x2a6e4d(0x1bb)](_0x1df7d9['id']),console['log']('âœ…\x20[EXPIRY]\x20Payment\x20'+_0x1df7d9['id']+_0x2a6e4d(0x1a8)+this[_0x2a6e4d(0x179)]+'-day\x20timeout');}catch(_0x331412){console[_0x2a6e4d(0x17c)](_0x2a6e4d(0x111)+_0x1df7d9['id']+':',_0x331412),this['logCoinToPayError'](_0x1df7d9['id'],_0x1df7d9[_0x2a6e4d(0x18b)]||_0x2a6e4d(0x181),_0x331412,'auto_expire',{'reason':_0x2a6e4d(0x196),'createdAt':_0x1df7d9[_0x2a6e4d(0x1e8)],'daysSinceCreation':Math[_0x2a6e4d(0x1f7)]((Date[_0x2a6e4d(0x17e)]()-_0x1df7d9[_0x2a6e4d(0x1e8)][_0x2a6e4d(0x1bc)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x47dfe6;}async['checkSinglePayment'](_0xec016c){const _0xfbb402=a57_0x2c684f;if(!_0xec016c[_0xfbb402(0x18b)]){console[_0xfbb402(0x199)]('âš ï¸\x20[CHECK]\x20Payment\x20'+_0xec016c['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0xfbb402(0x199)]('ðŸ”\x20[CHECK]\x20Checking\x20'+_0xec016c[_0xfbb402(0x162)]+_0xfbb402(0x175)+_0xec016c['id']+'\x20('+_0xec016c[_0xfbb402(0x18b)]+')');try{let _0x185b1d;_0xec016c[_0xfbb402(0x162)]===_0xfbb402(0x1d7)?(_0x185b1d=await this[_0xfbb402(0x12c)]['checkPaymentStatus'](_0xec016c[_0xfbb402(0x18b)]),console[_0xfbb402(0x199)]('ðŸ“Š\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0xec016c['id']+'\x20status:\x20'+_0x185b1d[_0xfbb402(0x141)])):(_0x185b1d=await this[_0xfbb402(0x18d)][_0xfbb402(0x135)](_0xec016c[_0xfbb402(0x18b)]),console[_0xfbb402(0x199)](_0xfbb402(0x101)+_0xec016c['id']+'\x20status:\x20'+_0x185b1d[_0xfbb402(0x141)]));_0x185b1d[_0xfbb402(0x146)]&&console[_0xfbb402(0x199)](_0xfbb402(0x1da)+_0xec016c['id']+_0xfbb402(0x1f4),{'iban':_0x185b1d[_0xfbb402(0x146)][_0xfbb402(0x1d2)]||'not\x20found','transactionId':_0x185b1d[_0xfbb402(0x146)][_0xfbb402(0x1ac)],'createdOn':_0x185b1d['paymentDetails'][_0xfbb402(0x119)],'confirmedOn':_0x185b1d[_0xfbb402(0x146)][_0xfbb402(0x1c0)]||_0xfbb402(0x168)});if(_0x185b1d['status']!==_0xec016c[_0xfbb402(0x141)]){console[_0xfbb402(0x199)](_0xfbb402(0x12a)+_0xec016c['id']+_0xfbb402(0x128)+_0xec016c['status']+_0xfbb402(0x148)+_0x185b1d[_0xfbb402(0x141)]),this[_0xfbb402(0x187)](_0xec016c['id'],_0xec016c[_0xfbb402(0x18b)],_0xec016c[_0xfbb402(0x141)],_0x185b1d[_0xfbb402(0x141)],_0xfbb402(0x19f),{'paymentDetails':_0x185b1d[_0xfbb402(0x146)],'amount':_0x185b1d['amount'],'currency':_0x185b1d[_0xfbb402(0x13e)],'shopId':_0xec016c[_0xfbb402(0x1cc)],'checkTimestamp':new Date()[_0xfbb402(0x100)]()});const _0x56ce30={'status':_0x185b1d[_0xfbb402(0x141)],'updatedAt':new Date()};if(_0x185b1d[_0xfbb402(0x141)]==='PAID'&&_0xec016c['status']!==_0xfbb402(0x1c1)){_0x56ce30['paidAt']=new Date();if(!_0xec016c['amountUSDT']){const _0x1e94df=await currencyService_1[_0xfbb402(0x157)][_0xfbb402(0x153)](_0xec016c[_0xfbb402(0x1b8)],_0xec016c['currency']);_0x56ce30[_0xfbb402(0x144)]=_0x1e94df;const _0x23a323=await this['getGatewayCommission'](_0xec016c[_0xfbb402(0x1cc)],_0xec016c[_0xfbb402(0x162)]),_0x155a72=_0x1e94df*(0x1-_0x23a323/0x64);_0x56ce30[_0xfbb402(0x13f)]=_0x155a72,_0x56ce30[_0xfbb402(0x116)]=_0x23a323,console[_0xfbb402(0x199)](_0xfbb402(0x1cd)+_0xec016c['id']+_0xfbb402(0x122)),console['log'](_0xfbb402(0x166)+_0xec016c[_0xfbb402(0x1b8)]+'\x20'+_0xec016c[_0xfbb402(0x13e)]+_0xfbb402(0x209)+_0x1e94df['toFixed'](0x6)+_0xfbb402(0x14e)),console[_0xfbb402(0x199)](_0xfbb402(0x1aa)+_0xec016c['gateway']+_0xfbb402(0x123)+_0x23a323+'%'),console['log'](_0xfbb402(0x1c4)+_0x155a72[_0xfbb402(0x109)](0x6)+_0xfbb402(0x14e));}console[_0xfbb402(0x199)]('ðŸ’°\x20[CHECK]\x20Payment\x20'+_0xec016c['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x56ce30[_0xfbb402(0x138)][_0xfbb402(0x100)]());}if(_0x185b1d[_0xfbb402(0x146)]){const _0x52a9f0=_0x185b1d['paymentDetails'];_0x52a9f0[_0xfbb402(0x1d2)]&&(_0x56ce30[_0xfbb402(0x192)]=_0x52a9f0[_0xfbb402(0x1d2)],console[_0xfbb402(0x199)]('ðŸ¦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x52a9f0['iban'])),_0x52a9f0[_0xfbb402(0x1fa)]&&console[_0xfbb402(0x199)](_0xfbb402(0x11d)+_0x52a9f0[_0xfbb402(0x1fa)]),_0x52a9f0['transactionId']&&console[_0xfbb402(0x199)](_0xfbb402(0x114)+_0x52a9f0['transactionId']),_0x52a9f0['confirmedOn']&&console['log'](_0xfbb402(0x1d3)+_0x52a9f0[_0xfbb402(0x1c0)]);}await database_1[_0xfbb402(0x102)][_0xfbb402(0x20a)][_0xfbb402(0x1d9)]({'where':{'id':_0xec016c['id']},'data':_0x56ce30});if(_0x185b1d['status']===_0xfbb402(0x1c1)&&_0xec016c['status']!==_0xfbb402(0x1c1)){console[_0xfbb402(0x199)](_0xfbb402(0x186)+_0xec016c['id']+_0xfbb402(0x164));const _0x24a1e4=await database_1[_0xfbb402(0x102)]['payment'][_0xfbb402(0x13b)]({'where':{'id':_0xec016c['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x24a1e4?.[_0xfbb402(0x11f)]&&_0x24a1e4[_0xfbb402(0x19d)])try{const _0xc0578c=_0x24a1e4[_0xfbb402(0x19d)];console['log'](_0xfbb402(0x16d)+_0xc0578c['id']+':\x20type='+_0xc0578c['type']+_0xfbb402(0x180)+_0xc0578c[_0xfbb402(0x155)]+_0xfbb402(0x18a)+_0xc0578c[_0xfbb402(0x141)]);const _0x37772a=_0xc0578c['currentPayments']+0x1,_0x16eaec=_0xc0578c['type']===_0xfbb402(0x1d4)?_0xfbb402(0x143):_0xc0578c[_0xfbb402(0x141)];await database_1[_0xfbb402(0x102)][_0xfbb402(0x19d)][_0xfbb402(0x1d9)]({'where':{'id':_0xc0578c['id']},'data':{'currentPayments':_0x37772a,'status':_0x16eaec,'updatedAt':new Date()}}),console[_0xfbb402(0x199)](_0xfbb402(0x188)+_0xc0578c['id']+_0xfbb402(0x105)+_0xc0578c[_0xfbb402(0x155)]+_0xfbb402(0x209)+_0x37772a+',\x20status='+_0xc0578c[_0xfbb402(0x141)]+_0xfbb402(0x209)+_0x16eaec);}catch(_0x2d5ab3){console[_0xfbb402(0x17c)](_0xfbb402(0x1ee),_0x2d5ab3);}else console['log'](_0xfbb402(0x186)+_0xec016c['id']+_0xfbb402(0x183));}await database_1[_0xfbb402(0x102)][_0xfbb402(0x16f)][_0xfbb402(0x18e)]({'data':{'paymentId':_0xec016c['id'],'shopId':_0xec016c[_0xfbb402(0x1cc)],'event':_0xfbb402(0x195)+_0x185b1d[_0xfbb402(0x141)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0xfbb402(0x156)]({'oldStatus':_0xec016c[_0xfbb402(0x141)],'newStatus':_0x185b1d[_0xfbb402(0x141)],'paymentDetails':_0x185b1d['paymentDetails'],'checkedAt':new Date()['toISOString']()})}}),await this[_0xfbb402(0x133)](_0xec016c,_0x185b1d[_0xfbb402(0x141)]),await this[_0xfbb402(0x171)](_0xec016c,_0x185b1d[_0xfbb402(0x141)]),_0x185b1d[_0xfbb402(0x141)]!==_0xfbb402(0x11c)&&(console[_0xfbb402(0x199)](_0xfbb402(0x177)+_0xec016c['id']+_0xfbb402(0x134)+_0x185b1d['status']+',\x20clearing\x20individual\x20timers'),this[_0xfbb402(0x10b)](_0xec016c['id'])),console[_0xfbb402(0x199)](_0xfbb402(0x20b)+_0xec016c['id']+_0xfbb402(0x1f8));}else console['log'](_0xfbb402(0x1da)+_0xec016c['id']+_0xfbb402(0x104)+_0x185b1d[_0xfbb402(0x141)]+')'),this[_0xfbb402(0x187)](_0xec016c['id'],_0xec016c[_0xfbb402(0x18b)],_0xec016c[_0xfbb402(0x141)],_0x185b1d[_0xfbb402(0x141)],_0xfbb402(0x19f),{'statusUnchanged':!![],'paymentDetails':_0x185b1d['paymentDetails'],'amount':_0x185b1d['amount'],'currency':_0x185b1d[_0xfbb402(0x13e)],'shopId':_0xec016c[_0xfbb402(0x1cc)],'checkTimestamp':new Date()[_0xfbb402(0x100)]()});}catch(_0x2309aa){console[_0xfbb402(0x17c)](_0xfbb402(0x113)+_0xec016c['id']+':',_0x2309aa),this[_0xfbb402(0x1ad)](_0xec016c['id'],_0xec016c['gatewayPaymentId'],_0x2309aa,_0xfbb402(0x19f),{'paymentAmount':_0xec016c[_0xfbb402(0x1b8)],'paymentCurrency':_0xec016c[_0xfbb402(0x13e)],'shopId':_0xec016c[_0xfbb402(0x1cc)],'createdAt':_0xec016c['createdAt']}),await database_1[_0xfbb402(0x102)][_0xfbb402(0x16f)][_0xfbb402(0x18e)]({'data':{'paymentId':_0xec016c['id'],'shopId':_0xec016c['shopId'],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x2309aa instanceof Error?_0x2309aa[_0xfbb402(0x194)]:_0xfbb402(0x12b),'gatewayPaymentId':_0xec016c[_0xfbb402(0x18b)],'checkedAt':new Date()['toISOString']()})}});}}async[a57_0x2c684f(0x133)](_0x4824cf,_0x11645b){const _0x5cdb19=a57_0x2c684f,_0x392a50=Date['now']();try{const _0x93a729=_0x4824cf[_0x5cdb19(0x1a1)],_0x2194ac=_0x93a729['settings'];if(!_0x2194ac?.[_0x5cdb19(0x1e0)]){console[_0x5cdb19(0x199)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x93a729['id']);return;}const _0x58d2e0=_0x11645b===_0x5cdb19(0x1c1)?_0x5cdb19(0x1e6):_0x11645b===_0x5cdb19(0x1e9)?_0x5cdb19(0x1f2):_0x11645b===_0x5cdb19(0x147)?_0x5cdb19(0x1f2):_0x5cdb19(0x189);if(!_0x2194ac[_0x5cdb19(0x107)]?.['includes'](_0x58d2e0)){console[_0x5cdb19(0x199)](_0x5cdb19(0x108)+_0x58d2e0+_0x5cdb19(0x1e3)+_0x93a729['id']);return;}const _0x15c456=(0x0,gateway_1[_0x5cdb19(0x11b)])(_0x4824cf['gateway'])||_0x4824cf[_0x5cdb19(0x162)],_0x1b2071={'event':_0x58d2e0,'payment':{'id':_0x4824cf['id'],'order_id':_0x4824cf[_0x5cdb19(0x1e4)],'gateway_order_id':_0x4824cf[_0x5cdb19(0x1ce)],'gateway':_0x15c456,'amount':_0x4824cf[_0x5cdb19(0x1b8)],'currency':_0x4824cf[_0x5cdb19(0x13e)],'status':_0x11645b['toLowerCase'](),'customer_email':_0x4824cf[_0x5cdb19(0x15e)],'customer_name':_0x4824cf[_0x5cdb19(0x172)],'created_at':_0x4824cf[_0x5cdb19(0x1e8)],'updated_at':new Date()}},_0x364995=JSON[_0x5cdb19(0x156)](_0x1b2071),_0x45e267=crypto_1[_0x5cdb19(0x102)][_0x5cdb19(0x184)](_0x5cdb19(0x14f),_0x4824cf[_0x5cdb19(0x1a1)][_0x5cdb19(0x1c5)])[_0x5cdb19(0x1d9)](_0x364995)['digest'](_0x5cdb19(0x15a)),_0x3ced2d=await fetch(_0x2194ac[_0x5cdb19(0x1e0)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x5cdb19(0x14b),'X-Webhook-Signature':_0x45e267},'body':_0x364995}),_0x510b4b=Date['now']()-_0x392a50,_0x124e36=_0x3ced2d['ok']?_0x5cdb19(0x191):await _0x3ced2d['text']();loggerService_1[_0x5cdb19(0x1bd)]['logShopWebhookSent'](_0x4824cf['shopId'],_0x2194ac['webhookUrl'],_0x58d2e0,_0x3ced2d[_0x5cdb19(0x141)],_0x510b4b,_0x1b2071),console['log'](_0x5cdb19(0x1e1)+_0x2194ac[_0x5cdb19(0x1e0)]+_0x5cdb19(0x145)+_0x3ced2d[_0x5cdb19(0x141)]+'\x20('+_0x510b4b+_0x5cdb19(0x1ed));}catch(_0x59fa68){console[_0x5cdb19(0x17c)](_0x5cdb19(0x10e),_0x59fa68),loggerService_1[_0x5cdb19(0x1bd)]['logShopWebhookError'](_0x4824cf['shopId'],_0x4824cf[_0x5cdb19(0x1a1)]?.['settings']?.[_0x5cdb19(0x1e0)]||_0x5cdb19(0x181),'webhook_send',_0x59fa68,{});}}async['sendPaymentStatusNotification'](_0x9438cf,_0x1833be){const _0x32c5c2=a57_0x2c684f;try{const _0x43c810={'PENDING':_0x32c5c2(0x1d8),'PAID':_0x32c5c2(0x127),'FAILED':'failed','EXPIRED':_0x32c5c2(0x17f)},_0x132de2=_0x43c810[_0x1833be];if(!_0x132de2||_0x132de2===_0x32c5c2(0x1d8))return;await telegramBotService_1['telegramBotService'][_0x32c5c2(0x1a9)](_0x9438cf[_0x32c5c2(0x1cc)],_0x9438cf,_0x132de2);}catch(_0x12daff){console[_0x32c5c2(0x17c)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x12daff);}}async[a57_0x2c684f(0x16b)](_0x478616){const _0xb46d0b=a57_0x2c684f;console[_0xb46d0b(0x199)](_0xb46d0b(0x16c)+_0x478616);const _0x47da9a=await database_1['default'][_0xb46d0b(0x20a)]['findUnique']({'where':{'id':_0x478616},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x47da9a)throw new Error('Payment\x20not\x20found');if(_0x47da9a[_0xb46d0b(0x162)]!==_0xb46d0b(0x1b9)&&_0x47da9a[_0xb46d0b(0x162)]!==_0xb46d0b(0x1d7))throw new Error(_0xb46d0b(0x159));console['log']('âœ…\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20'+_0x47da9a['gateway']+'\x20payment\x20'+_0x478616),await this[_0xb46d0b(0x190)](_0x47da9a),console[_0xb46d0b(0x199)](_0xb46d0b(0x1a7)+_0x478616);}['getServiceStats'](){const _0x1d65ec=a57_0x2c684f,_0x455e71=this[_0x1d65ec(0x169)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x3bf8a5=Array[_0x1d65ec(0x1c3)](this[_0x1d65ec(0x126)]['values']())[_0x1d65ec(0x161)](_0x5336b4=>({'paymentId':_0x5336b4['paymentId'],'gatewayPaymentId':_0x5336b4[_0x1d65ec(0x18b)],'createdAt':_0x5336b4[_0x1d65ec(0x1e8)],'timersCount':_0x5336b4[_0x1d65ec(0x1e7)]['length']}));return{'isActive':!!this[_0x1d65ec(0x169)],'globalCheckIntervalMinutes':this[_0x1d65ec(0x125)]/(0x3e8*0x3c),'expiryDays':this[_0x1d65ec(0x179)],'activeIndividualTimers':this[_0x1d65ec(0x126)]['size'],'nextGlobalCheckIn':_0x455e71,'paymentTimersDetails':_0x3bf8a5};}[a57_0x2c684f(0x18f)](_0x489ee3){const _0x523161=a57_0x2c684f,_0x1c87e2=this[_0x523161(0x126)][_0x523161(0x1c6)](_0x489ee3);if(_0x1c87e2)return{'hasTimers':!![],'timersCount':_0x1c87e2[_0x523161(0x1e7)]['length'],'createdAt':_0x1c87e2[_0x523161(0x1e8)],'gatewayPaymentId':_0x1c87e2[_0x523161(0x18b)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0x48c226,_0x5482be){const _0x36e29a=a57_0x2c684f;try{const _0x27aac6=await database_1['default']['shop'][_0x36e29a(0x13b)]({'where':{'id':_0x48c226},'select':{'gatewaySettings':!![]}});if(!_0x27aac6?.[_0x36e29a(0x1b1)])return console[_0x36e29a(0x199)](_0x36e29a(0x142)+_0x48c226+_0x36e29a(0x12f)),0xa;const _0x40cb45=JSON[_0x36e29a(0x19b)](_0x27aac6[_0x36e29a(0x1b1)]);for(const [_0x1ccb9b,_0x1cde83]of Object['entries'](_0x40cb45)){if(_0x1ccb9b['toLowerCase']()===_0x5482be[_0x36e29a(0x1f0)]()){const _0x566d05=_0x1cde83[_0x36e29a(0x173)]||0xa;return console[_0x36e29a(0x199)](_0x36e29a(0x131)+_0x5482be+_0x36e29a(0x17b)+_0x48c226+':\x20'+_0x566d05+'%'),_0x566d05;}}return console[_0x36e29a(0x199)](_0x36e29a(0x120)+_0x5482be+_0x36e29a(0x1d1)+_0x48c226+_0x36e29a(0x160)),0xa;}catch(_0x4ea07e){return console[_0x36e29a(0x17c)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x48c226+_0x36e29a(0x118)+_0x5482be+':',_0x4ea07e),0xa;}}}exports[a57_0x2c684f(0x13d)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();