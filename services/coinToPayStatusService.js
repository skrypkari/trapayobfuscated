'use strict';const a35_0x338f79=a35_0x1b0a;(function(_0x30dbec,_0xcc4782){const _0x497ff2=a35_0x1b0a,_0x53e618=_0x30dbec();while(!![]){try{const _0x171c9c=parseInt(_0x497ff2(0x158))/0x1*(-parseInt(_0x497ff2(0x164))/0x2)+-parseInt(_0x497ff2(0x1a7))/0x3*(parseInt(_0x497ff2(0x191))/0x4)+-parseInt(_0x497ff2(0x1d5))/0x5+parseInt(_0x497ff2(0x16c))/0x6+-parseInt(_0x497ff2(0x18d))/0x7*(parseInt(_0x497ff2(0x11c))/0x8)+-parseInt(_0x497ff2(0x1c4))/0x9*(parseInt(_0x497ff2(0x148))/0xa)+parseInt(_0x497ff2(0x1ae))/0xb;if(_0x171c9c===_0xcc4782)break;else _0x53e618['push'](_0x53e618['shift']());}catch(_0x264919){_0x53e618['push'](_0x53e618['shift']());}}}(a35_0x1eae,0xceb5d));function a35_0x1b0a(_0x35f129,_0x4a8c06){const _0x1eaefa=a35_0x1eae();return a35_0x1b0a=function(_0x1b0a9d,_0x1bba13){_0x1b0a9d=_0x1b0a9d-0x119;let _0x5c797e=_0x1eaefa[_0x1b0a9d];return _0x5c797e;},a35_0x1b0a(_0x35f129,_0x4a8c06);}function a35_0x1eae(){const _0x1f9531=['update','COINTOPAY_STATUS_CHANGE','Bank\x20Details:\x20','logCoinToPayError','ðŸ“Š\x20[HOURLY]\x20Payment\x20','set','\x20for\x20payment\x20','âŒ\x20[TIMER]\x20Failed\x20individual\x20check\x20#','checkAllPendingPayments','customerName','ðŸ¦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','FAILED','Webhook\x20event\x20','6465530csTLUe','__esModule','floor','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20\x20\x20-\x20Amount:\x20','Automatically\x20expired\x20after\x20','\x20(age:\x20','catch','coinToPayService','getTime','sendShopWebhook','GLOBAL_CHECK_INTERVAL_MS','ðŸ”\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','ðŸ”\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','customerEmail','length','251153CXZaxS','\x20status\x20from\x20','loggerService','not\x20confirmed','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','ðŸ“Š\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','TesSoft\x20Payment\x20System/1.0',',\x20stopping\x20individual\x20checks','delay','getServiceStats','\x20has\x20no\x20gatewayPaymentId,\x20skipping','stringify','2oIYGkA','âš ï¸\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20Gateway:\x20','-day\x20timeout','âŒ\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','gateway','sendPaymentNotification','ðŸ¦\x20[CHECK]\x20Saved\x20IBAN:\x20','3059466lmaUZP','coinToPayStatusService','checkSinglePayment','2\x20minutes','setDate','\x20seconds\x20(','map','values','status','âŒ\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','âŒ\x20[HOURLY]\x20Payment\x20','adminNotes','PAID','ðŸ”\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','â°\x20[GLOBAL]\x20Found\x20','currency','findUnique','\x20status\x20is\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','checkPaymentStatus','\x20\x20\x20ðŸ“…\x20Time:\x20','EXPIRY_DAYS','âœ…\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20\x20\x20ðŸ“\x20Details:','payment.failed','./gateways/coinToPayService','timestamp','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20initial\x20timers\x20for\x20payment\x20','message','â°\x20[GLOBAL]\x20Payment\x20','\x20has\x20no\x20gatewayPaymentId','\x20not\x20found\x20in\x20database','6157319DKPRpX','\x20details:','ðŸ§¹\x20[CHECK]\x20Payment\x20','unknown','70100fsxXSQ','status_check','shopId','\x20completed\x20for\x20payment\x20','5\x20minutes','âœ…\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','forEach','âœ…\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','timers','webhookUrl','createdOn','findMany','\x20expired\x20CoinToPay\x20payments','iban','â°\x20[HOURLY]\x20Payment\x20','toISOString','ðŸ†”\x20[CHECK]\x20Transaction\x20ID:\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','\x20->\x20','\x20\x20\x20-\x20ShopId:\x20','âœ…\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','globalCheckInterval','3mVhUTv','ðŸª™\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','default','PENDING','checkSinglePaymentById','toLowerCase','defineProperty','34045616GMWnSy','toFixed','\x20status:\x20','\x20found:','\x20\x20\x20ðŸ“\x20Source:\x20','COINTOPAY_ERROR','\x20days','h),\x20skipping\x20global\x20check','description','Payment\x20older\x20than\x20','get','includes','expired','âŒ\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','âœ…\x20[TIMER]\x20Individual\x20check\x20#','âœ…\x20[EXPIRY]\x20Payment\x20','EXPIRED','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20marked\x20as\x20paid\x20at:\x20','now','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20triggered\x20for\x20payment\x20','9CoZLvC','error','âœ…\x20[CHECK]\x20Payment\x20','âŒ\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20expired','shop','payment','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','payment.pending','CoinToPayService','POST','ðŸª™\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20days\x20(created\x20before\x20','../config/database','application/json','âœ…\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','4817170lGFdNh','paymentDetails','gatewayPaymentId','Shop\x20webhook\x20sent\x20to\x20','\x20to\x20clear','\x20is\x20too\x20new\x20(','ðŸª™\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','./loggerService','settings','ðŸ›‘\x20[SHUTDOWN]\x20Cleared\x20','\x20\x20\x20âŒ\x20Error:\x20','create','cointopay','paid','â°\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','createdAt','\x20individual\x20payment\x20timers','\x20\x20\x20ðŸ“Š\x20Status:\x20','webhookLog','\x20in\x20','confirmedOn','log','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','CoinToPayStatusService','sendPaymentStatusNotification','âœ…\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','transactionId','\x20current\x20status:\x20','checkPaymentById','ðŸª™\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','logWhiteDomainError','logShopWebhookSent','\x20\x20\x20-\x20paymentId:\x20','./telegramBotService','remitterIban','logCoinToPayStatus','8EpfcNd','\x20not\x20found,\x20clearing\x20timers','ðŸª™\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20is\x20older\x20than\x20','ðŸ“Š\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20Status:\x20','âœ…\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','âŒ\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','amount','delete','/status/','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','paymentTimers','clearPaymentTimers','\x20skipped,\x20','ðŸª™\x20CoinToPayStatusService\x20initialized','created','0100','\x20timers\x20for\x20payment\x20','ðŸ§¹\x20[DEBUG]\x20Clearing\x20',',\x20clearing\x20individual\x20timers','not\x20found','\x20updated\x20successfully','paidAt','1\x20minute','âœ…\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','size','\x20pending\x20CoinToPay\x20payments','\x20with\x20status\x20','telegramBotService','push'];a35_0x1eae=function(){return _0x1f9531;};return a35_0x1eae();}var __importDefault=this&&this['__importDefault']||function(_0x1c8b05){const _0x3a2b1f=a35_0x1b0a;return _0x1c8b05&&_0x1c8b05[_0x3a2b1f(0x149)]?_0x1c8b05:{'default':_0x1c8b05};};Object[a35_0x338f79(0x1ad)](exports,a35_0x338f79(0x149),{'value':!![]}),exports[a35_0x338f79(0x16d)]=exports[a35_0x338f79(0x1ec)]=void 0x0;const coinToPayService_1=require(a35_0x338f79(0x185)),database_1=__importDefault(require(a35_0x338f79(0x1d2))),telegramBotService_1=require(a35_0x338f79(0x119)),loggerService_1=require(a35_0x338f79(0x1dc));class CoinToPayStatusService{constructor(){const _0x118670=a35_0x338f79;this[_0x118670(0x1a6)]=null,this[_0x118670(0x153)]=0x3c*0x3c*0x3e8,this[_0x118670(0x181)]=0x5,this['paymentTimers']=new Map(),this[_0x118670(0x150)]=new coinToPayService_1[(_0x118670(0x1ce))](),console['log'](_0x118670(0x12b));}['schedulePaymentChecks'](_0x209934,_0x5a866e){const _0x2126a1=a35_0x338f79;console[_0x2126a1(0x1ea)](_0x2126a1(0x11e)),console[_0x2126a1(0x1ea)](_0x2126a1(0x1f5)+_0x209934),console['log'](_0x2126a1(0x1a2)+_0x5a866e),this['clearPaymentTimers'](_0x209934);const _0x34a5ad=[],_0x26799b=new Date(),_0x46f2ec=[{'delay':0x1*0x3c*0x3e8,'description':_0x2126a1(0x134)},{'delay':0x2*0x3c*0x3e8,'description':_0x2126a1(0x16f)},{'delay':0x5*0x3c*0x3e8,'description':_0x2126a1(0x195)},{'delay':0x5*0x3c*0x3e8,'description':_0x2126a1(0x195)}];console['log']('ðŸª™\x20[DEBUG]\x20Creating\x20'+_0x46f2ec[_0x2126a1(0x157)]+_0x2126a1(0x188)+_0x209934);let _0x139b55=0x0;_0x46f2ec[_0x2126a1(0x197)]((_0x5b85a8,_0x2cd38b)=>{const _0xb66b43=_0x2126a1;_0x139b55+=_0x5b85a8[_0xb66b43(0x160)];const _0xa3ff3f=setTimeout(async()=>{const _0x5ef784=_0xb66b43;console[_0x5ef784(0x1ea)]('ðŸª™\x20[TIMER]\x20Individual\x20check\x20#'+(_0x2cd38b+0x1)+_0x5ef784(0x1c3)+_0x209934+'\x20(after\x20'+_0x5b85a8[_0x5ef784(0x1b6)]+')');try{await this[_0x5ef784(0x1ab)](_0x209934),console['log'](_0x5ef784(0x1bc)+(_0x2cd38b+0x1)+_0x5ef784(0x194)+_0x209934);}catch(_0x45f0c9){console[_0x5ef784(0x1c5)](_0x5ef784(0x142)+(_0x2cd38b+0x1)+'\x20for\x20payment\x20'+_0x209934+':',_0x45f0c9),this['logCoinToPayError'](_0x209934,_0x5a866e,_0x45f0c9,_0x5ef784(0x192),{'checkNumber':_0x2cd38b+0x1,'scheduledAfter':_0x5b85a8[_0x5ef784(0x1b6)],'isIndividualCheck':!![]});}},_0x139b55);_0x34a5ad[_0xb66b43(0x13a)](_0xa3ff3f),console['log']('â°\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x2cd38b+0x1)+_0xb66b43(0x141)+_0x209934+_0xb66b43(0x1e8)+_0x139b55/0x3e8+_0xb66b43(0x171)+_0x5b85a8['description']+')');});const _0x1bd823=setInterval(async()=>{const _0x4c5b8e=_0x2126a1;console[_0x4c5b8e(0x1ea)](_0x4c5b8e(0x1d0)+_0x209934);try{const _0x1c1000=await database_1[_0x4c5b8e(0x1a9)][_0x4c5b8e(0x1ca)][_0x4c5b8e(0x17c)]({'where':{'id':_0x209934},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x1c1000){console[_0x4c5b8e(0x1ea)](_0x4c5b8e(0x176)+_0x209934+_0x4c5b8e(0x11d)),this[_0x4c5b8e(0x129)](_0x209934);return;}console[_0x4c5b8e(0x1ea)](_0x4c5b8e(0x13f)+_0x209934+_0x4c5b8e(0x1f0)+_0x1c1000['status']);if(_0x1c1000[_0x4c5b8e(0x174)]!==_0x4c5b8e(0x1aa)){console[_0x4c5b8e(0x1ea)]('âœ…\x20[HOURLY]\x20Payment\x20'+_0x209934+_0x4c5b8e(0x17d)+_0x1c1000[_0x4c5b8e(0x174)]+_0x4c5b8e(0x15f)),this['clearPaymentTimers'](_0x209934);return;}const _0x1637bf=Math[_0x4c5b8e(0x14a)]((Date[_0x4c5b8e(0x1c1)]()-_0x1c1000['createdAt'][_0x4c5b8e(0x151)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1637bf>=this[_0x4c5b8e(0x181)]){console[_0x4c5b8e(0x1ea)](_0x4c5b8e(0x19f)+_0x209934+_0x4c5b8e(0x11f)+this[_0x4c5b8e(0x181)]+_0x4c5b8e(0x14b)),this[_0x4c5b8e(0x129)](_0x209934);return;}await this['checkSinglePaymentById'](_0x209934),console['log'](_0x4c5b8e(0x122)+_0x209934);}catch(_0x39c9ce){console[_0x4c5b8e(0x1c5)](_0x4c5b8e(0x168)+_0x209934+':',_0x39c9ce),this[_0x4c5b8e(0x13e)](_0x209934,_0x5a866e,_0x39c9ce,_0x4c5b8e(0x192),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x34a5ad[_0x2126a1(0x13a)](_0x1bd823),this[_0x2126a1(0x128)][_0x2126a1(0x140)](_0x209934,{'timers':_0x34a5ad,'paymentId':_0x209934,'gatewayPaymentId':_0x5a866e,'createdAt':_0x26799b}),console[_0x2126a1(0x1ea)]('âœ…\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x46f2ec[_0x2126a1(0x157)]+_0x2126a1(0x1eb)+_0x209934),console[_0x2126a1(0x1ea)](_0x2126a1(0x15d)+this[_0x2126a1(0x128)][_0x2126a1(0x136)]),this[_0x2126a1(0x11b)](_0x209934,_0x5a866e,'PENDING','PENDING','status_check',{'action':'schedule_created','scheduledChecks':_0x46f2ec['length'],'firstCheckIn':_0x46f2ec[0x0][_0x2126a1(0x160)]/0x3e8,'totalTimers':this[_0x2126a1(0x128)][_0x2126a1(0x136)]});}[a35_0x338f79(0x129)](_0x130cc4){const _0x241509=a35_0x338f79,_0x20fb99=this['paymentTimers'][_0x241509(0x1b8)](_0x130cc4);_0x20fb99?(console[_0x241509(0x1ea)](_0x241509(0x12f)+_0x20fb99[_0x241509(0x199)][_0x241509(0x157)]+_0x241509(0x12e)+_0x130cc4),_0x20fb99[_0x241509(0x199)][_0x241509(0x197)]((_0x363494,_0x48d57b)=>{const _0x5708f5=_0x241509;_0x363494&&(clearTimeout(_0x363494),clearInterval(_0x363494),console[_0x5708f5(0x1ea)]('ðŸ§¹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x48d57b+0x1)+_0x5708f5(0x141)+_0x130cc4));}),this[_0x241509(0x128)][_0x241509(0x125)](_0x130cc4),console[_0x241509(0x1ea)](_0x241509(0x1a5)+_0x130cc4+'.\x20Remaining\x20active\x20timers:\x20'+this['paymentTimers'][_0x241509(0x136)])):console[_0x241509(0x1ea)]('âš ï¸\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x130cc4+_0x241509(0x1d9));}async[a35_0x338f79(0x1ab)](_0x47fae2){const _0x5030d3=a35_0x338f79;console[_0x5030d3(0x1ea)](_0x5030d3(0x179)+_0x47fae2);const _0x30a2a7=await database_1[_0x5030d3(0x1a9)]['payment'][_0x5030d3(0x17c)]({'where':{'id':_0x47fae2},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x30a2a7){console[_0x5030d3(0x1ea)]('âŒ\x20[CHECK]\x20Payment\x20'+_0x47fae2+_0x5030d3(0x18c));return;}console[_0x5030d3(0x1ea)](_0x5030d3(0x120)+_0x47fae2+_0x5030d3(0x1b1)),console[_0x5030d3(0x1ea)](_0x5030d3(0x166)+_0x30a2a7[_0x5030d3(0x169)]),console[_0x5030d3(0x1ea)](_0x5030d3(0x121)+_0x30a2a7['status']),console[_0x5030d3(0x1ea)](_0x5030d3(0x1c2)+_0x30a2a7[_0x5030d3(0x1d7)]),console[_0x5030d3(0x1ea)](_0x5030d3(0x14c)+_0x30a2a7[_0x5030d3(0x124)]+'\x20'+_0x30a2a7[_0x5030d3(0x17b)]),console[_0x5030d3(0x1ea)](_0x5030d3(0x1a4)+_0x30a2a7[_0x5030d3(0x193)]);if(_0x30a2a7[_0x5030d3(0x169)]!==_0x5030d3(0x1e1)){console[_0x5030d3(0x1ea)](_0x5030d3(0x165)+_0x47fae2+_0x5030d3(0x15c)+_0x30a2a7[_0x5030d3(0x169)]+')');return;}if(_0x30a2a7[_0x5030d3(0x174)]!==_0x5030d3(0x1aa)){console['log']('âš ï¸\x20[CHECK]\x20Payment\x20'+_0x47fae2+'\x20status\x20is\x20'+_0x30a2a7[_0x5030d3(0x174)]+_0x5030d3(0x15f)),this[_0x5030d3(0x129)](_0x47fae2);return;}if(!_0x30a2a7['gatewayPaymentId']){console[_0x5030d3(0x1ea)](_0x5030d3(0x165)+_0x47fae2+_0x5030d3(0x18b));return;}console[_0x5030d3(0x1ea)]('âœ…\x20[CHECK]\x20Payment\x20'+_0x47fae2+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x5030d3(0x16e)](_0x30a2a7);}[a35_0x338f79(0x11b)](_0x3b526e,_0x5ddfc7,_0x4754bf,_0x77f1ad,_0x230785,_0x251615){const _0x372a19=a35_0x338f79,_0xa2282a={'type':_0x372a19(0x13c),'paymentId':_0x3b526e,'gatewayPaymentId':_0x5ddfc7,'oldStatus':_0x4754bf,'newStatus':_0x77f1ad,'source':_0x230785,'timestamp':new Date()[_0x372a19(0x1a0)](),'details':_0x251615||{}};loggerService_1[_0x372a19(0x15a)][_0x372a19(0x11b)](_0xa2282a),console[_0x372a19(0x1ea)]('ðŸª™\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x3b526e+'\x20('+_0x5ddfc7+')'),console[_0x372a19(0x1ea)](_0x372a19(0x1e6)+_0x4754bf+_0x372a19(0x1a3)+_0x77f1ad),console['log'](_0x372a19(0x1b2)+_0x230785),console[_0x372a19(0x1ea)](_0x372a19(0x180)+_0xa2282a['timestamp']),_0x251615&&console[_0x372a19(0x1ea)](_0x372a19(0x183),_0x251615);}[a35_0x338f79(0x13e)](_0x4fd7d1,_0x5e33df,_0x42d7b2,_0x54aa5a,_0x2b6c2b){const _0x352ad2=a35_0x338f79,_0x1a0c97={'type':_0x352ad2(0x1b3),'paymentId':_0x4fd7d1,'gatewayPaymentId':_0x5e33df,'error':_0x42d7b2 instanceof Error?{'message':_0x42d7b2[_0x352ad2(0x189)],'stack':_0x42d7b2['stack']}:_0x42d7b2,'source':_0x54aa5a,'timestamp':new Date()[_0x352ad2(0x1a0)](),'context':_0x2b6c2b||{}};loggerService_1[_0x352ad2(0x15a)][_0x352ad2(0x13e)](_0x1a0c97),console[_0x352ad2(0x1c5)]('ðŸª™\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x4fd7d1+'\x20('+_0x5e33df+')'),console['error'](_0x352ad2(0x1df)+(_0x42d7b2 instanceof Error?_0x42d7b2['message']:_0x42d7b2)),console['error'](_0x352ad2(0x1b2)+_0x54aa5a),console[_0x352ad2(0x1c5)](_0x352ad2(0x180)+_0x1a0c97[_0x352ad2(0x186)]),_0x2b6c2b&&console['error']('\x20\x20\x20ðŸ“\x20Context:',_0x2b6c2b);}['startPeriodicStatusCheck'](){const _0x504570=a35_0x338f79;console['log'](_0x504570(0x1a8)),this['checkAllPendingPayments']()[_0x504570(0x14f)](_0x3fd845=>{console['error']('âŒ\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x3fd845);}),this[_0x504570(0x1a6)]=setInterval(async()=>{const _0x3f0b28=_0x504570;try{console[_0x3f0b28(0x1ea)](_0x3f0b28(0x1f2)),await this[_0x3f0b28(0x143)](),console[_0x3f0b28(0x1ea)](_0x3f0b28(0x198));}catch(_0x5cbd31){console[_0x3f0b28(0x1c5)](_0x3f0b28(0x1bb),_0x5cbd31);}},this[_0x504570(0x153)]),console['log'](_0x504570(0x135));}['stopPeriodicStatusCheck'](){const _0x916d99=a35_0x338f79;console[_0x916d99(0x1ea)]('ðŸ›‘\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this['globalCheckInterval']&&(clearInterval(this['globalCheckInterval']),this['globalCheckInterval']=null,console[_0x916d99(0x1ea)]('ðŸ›‘\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x2e0f2d=this[_0x916d99(0x128)]['size'];for(const [_0x4c9f97]of this[_0x916d99(0x128)]){this['clearPaymentTimers'](_0x4c9f97);}console[_0x916d99(0x1ea)](_0x916d99(0x1de)+_0x2e0f2d+_0x916d99(0x1e5));}async[a35_0x338f79(0x143)](){const _0x64d27d=a35_0x338f79;try{console['log'](_0x64d27d(0x1db));const _0x26527c=await database_1['default']['payment'][_0x64d27d(0x19c)]({'where':{'gateway':'cointopay','status':_0x64d27d(0x1aa),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x64d27d(0x1ea)]('ðŸª™\x20[GLOBAL]\x20Found\x20'+_0x26527c[_0x64d27d(0x157)]+_0x64d27d(0x137));if(_0x26527c[_0x64d27d(0x157)]===0x0){console[_0x64d27d(0x1ea)]('ðŸª™\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x460e36=await this['checkExpiredPayments'](_0x26527c);console[_0x64d27d(0x1ea)](_0x64d27d(0x17a)+_0x460e36['length']+_0x64d27d(0x19d));let _0x38435f=0x0,_0x12ade6=0x0;for(const _0x2b87e3 of _0x26527c){try{if(_0x460e36[_0x64d27d(0x1b9)](_0x2b87e3['id'])){console[_0x64d27d(0x1ea)](_0x64d27d(0x18a)+_0x2b87e3['id']+_0x64d27d(0x1cc)),_0x12ade6++;continue;}if(this['paymentTimers']['has'](_0x2b87e3['id'])){console['log'](_0x64d27d(0x18a)+_0x2b87e3['id']+_0x64d27d(0x17e)),_0x12ade6++;continue;}const _0x44715c=(Date['now']()-_0x2b87e3[_0x64d27d(0x1e4)][_0x64d27d(0x151)]())/(0x3e8*0x3c*0x3c);if(_0x44715c<0x1){console[_0x64d27d(0x1ea)](_0x64d27d(0x18a)+_0x2b87e3['id']+_0x64d27d(0x1da)+_0x44715c[_0x64d27d(0x1af)](0x1)+_0x64d27d(0x1b5)),_0x12ade6++;continue;}console['log'](_0x64d27d(0x155)+_0x2b87e3['id']+_0x64d27d(0x14e)+_0x44715c[_0x64d27d(0x1af)](0x1)+'h)'),await this[_0x64d27d(0x16e)](_0x2b87e3),_0x38435f++,await new Promise(_0x2297d6=>setTimeout(_0x2297d6,0x7d0));}catch(_0x4c1703){console[_0x64d27d(0x1c5)](_0x64d27d(0x1c7)+_0x2b87e3['id']+':',_0x4c1703),this['logCoinToPayError'](_0x2b87e3['id'],_0x2b87e3[_0x64d27d(0x1d7)]||_0x64d27d(0x190),_0x4c1703,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x2b87e3[_0x64d27d(0x124)],'paymentCurrency':_0x2b87e3[_0x64d27d(0x17b)],'shopId':_0x2b87e3[_0x64d27d(0x193)],'createdAt':_0x2b87e3['createdAt']}),loggerService_1[_0x64d27d(0x15a)][_0x64d27d(0x1f3)](_0x64d27d(0x1e1),_0x64d27d(0x126)+_0x2b87e3[_0x64d27d(0x1d7)],_0x4c1703);}}console['log'](_0x64d27d(0x182)+_0x38435f+'\x20checked,\x20'+_0x12ade6+_0x64d27d(0x12a)+_0x460e36[_0x64d27d(0x157)]+_0x64d27d(0x1c8));}catch(_0xdaa1c7){console[_0x64d27d(0x1c5)](_0x64d27d(0x175),_0xdaa1c7);}}async['checkExpiredPayments'](_0x18ed3c){const _0x2a4001=a35_0x338f79,_0xeba421=[],_0x328e13=new Date();_0x328e13[_0x2a4001(0x170)](_0x328e13['getDate']()-this['EXPIRY_DAYS']),console[_0x2a4001(0x1ea)](_0x2a4001(0x1e3)+this[_0x2a4001(0x181)]+_0x2a4001(0x1d1)+_0x328e13[_0x2a4001(0x1a0)]()+')');for(const _0x285bf5 of _0x18ed3c){if(_0x285bf5[_0x2a4001(0x1e4)]<_0x328e13){console[_0x2a4001(0x1ea)]('â°\x20[EXPIRY]\x20Payment\x20'+_0x285bf5['id']+_0x2a4001(0x11f)+this[_0x2a4001(0x181)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x2a4001(0x11b)](_0x285bf5['id'],_0x285bf5['gatewayPaymentId']||'unknown',_0x2a4001(0x1aa),_0x2a4001(0x1be),'auto_expire',{'reason':_0x2a4001(0x1b7)+this[_0x2a4001(0x181)]+'\x20days','createdAt':_0x285bf5['createdAt'],'daysSinceCreation':Math[_0x2a4001(0x14a)]((Date['now']()-_0x285bf5[_0x2a4001(0x1e4)][_0x2a4001(0x151)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x285bf5[_0x2a4001(0x124)],'paymentCurrency':_0x285bf5['currency'],'shopId':_0x285bf5['shopId']}),await database_1[_0x2a4001(0x1a9)][_0x2a4001(0x1ca)]['update']({'where':{'id':_0x285bf5['id']},'data':{'status':_0x2a4001(0x1be),'updatedAt':new Date(),'adminNotes':_0x2a4001(0x14d)+this[_0x2a4001(0x181)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x2a4001(0x1a9)][_0x2a4001(0x1e7)]['create']({'data':{'paymentId':_0x285bf5['id'],'shopId':_0x285bf5['shopId'],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON['stringify']({'reason':'Payment\x20older\x20than\x20'+this[_0x2a4001(0x181)]+_0x2a4001(0x1b4),'createdAt':_0x285bf5[_0x2a4001(0x1e4)],'expiredAt':new Date()[_0x2a4001(0x1a0)](),'daysSinceCreation':Math[_0x2a4001(0x14a)]((Date[_0x2a4001(0x1c1)]()-_0x285bf5[_0x2a4001(0x1e4)][_0x2a4001(0x151)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x2a4001(0x152)](_0x285bf5,_0x2a4001(0x1be)),await this['sendPaymentStatusNotification'](_0x285bf5,_0x2a4001(0x1be)),this['clearPaymentTimers'](_0x285bf5['id']),_0xeba421[_0x2a4001(0x13a)](_0x285bf5['id']),console[_0x2a4001(0x1ea)](_0x2a4001(0x1bd)+_0x285bf5['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this['EXPIRY_DAYS']+_0x2a4001(0x167));}catch(_0x4c8341){console['error']('âŒ\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x285bf5['id']+':',_0x4c8341),this[_0x2a4001(0x13e)](_0x285bf5['id'],_0x285bf5[_0x2a4001(0x1d7)]||_0x2a4001(0x190),_0x4c8341,'auto_expire',{'reason':_0x2a4001(0x187),'createdAt':_0x285bf5[_0x2a4001(0x1e4)],'daysSinceCreation':Math['floor']((Date[_0x2a4001(0x1c1)]()-_0x285bf5[_0x2a4001(0x1e4)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0xeba421;}async[a35_0x338f79(0x16e)](_0x431cb2){const _0x5a4234=a35_0x338f79;if(!_0x431cb2['gatewayPaymentId']){console[_0x5a4234(0x1ea)]('âš ï¸\x20[CHECK]\x20Payment\x20'+_0x431cb2['id']+_0x5a4234(0x162));return;}console[_0x5a4234(0x1ea)]('ðŸ”\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x431cb2['id']+'\x20('+_0x431cb2[_0x5a4234(0x1d7)]+')');try{const _0x47004f=await this[_0x5a4234(0x150)][_0x5a4234(0x17f)](_0x431cb2['gatewayPaymentId']);console['log'](_0x5a4234(0x120)+_0x431cb2['id']+_0x5a4234(0x1b0)+_0x47004f[_0x5a4234(0x174)]);_0x47004f[_0x5a4234(0x1d6)]&&console[_0x5a4234(0x1ea)](_0x5a4234(0x120)+_0x431cb2['id']+_0x5a4234(0x18e),{'iban':_0x47004f['paymentDetails']['iban']||_0x5a4234(0x131),'transactionId':_0x47004f['paymentDetails'][_0x5a4234(0x1ef)],'createdOn':_0x47004f['paymentDetails'][_0x5a4234(0x19b)],'confirmedOn':_0x47004f[_0x5a4234(0x1d6)][_0x5a4234(0x1e9)]||_0x5a4234(0x15b)});if(_0x47004f[_0x5a4234(0x174)]!==_0x431cb2[_0x5a4234(0x174)]){console['log']('ðŸ”„\x20[CHECK]\x20Updating\x20payment\x20'+_0x431cb2['id']+_0x5a4234(0x159)+_0x431cb2['status']+'\x20to\x20'+_0x47004f['status']),this['logCoinToPayStatus'](_0x431cb2['id'],_0x431cb2[_0x5a4234(0x1d7)],_0x431cb2['status'],_0x47004f[_0x5a4234(0x174)],_0x5a4234(0x192),{'paymentDetails':_0x47004f[_0x5a4234(0x1d6)],'amount':_0x47004f[_0x5a4234(0x124)],'currency':_0x47004f['currency'],'shopId':_0x431cb2[_0x5a4234(0x193)],'checkTimestamp':new Date()[_0x5a4234(0x1a0)]()});const _0x5dddd1={'status':_0x47004f[_0x5a4234(0x174)],'updatedAt':new Date()};_0x47004f[_0x5a4234(0x174)]===_0x5a4234(0x178)&&_0x431cb2[_0x5a4234(0x174)]!==_0x5a4234(0x178)&&(_0x5dddd1['paidAt']=new Date(),console['log']('ðŸ’°\x20[CHECK]\x20Payment\x20'+_0x431cb2['id']+_0x5a4234(0x1c0)+_0x5dddd1[_0x5a4234(0x133)]['toISOString']()));if(_0x47004f[_0x5a4234(0x1d6)]){const _0x284a5b=_0x47004f[_0x5a4234(0x1d6)];_0x284a5b[_0x5a4234(0x19e)]&&(_0x5dddd1[_0x5a4234(0x11a)]=_0x284a5b[_0x5a4234(0x19e)],console[_0x5a4234(0x1ea)](_0x5a4234(0x16b)+_0x284a5b[_0x5a4234(0x19e)]));if(_0x284a5b['bankDetails']){const _0x596d73=_0x431cb2[_0x5a4234(0x177)]||'',_0x32e690=_0x5a4234(0x13d)+_0x284a5b['bankDetails'];_0x5dddd1[_0x5a4234(0x177)]=_0x596d73?_0x596d73+'\x0a\x0a'+_0x32e690:_0x32e690,console['log'](_0x5a4234(0x145));}_0x284a5b[_0x5a4234(0x1ef)]&&console[_0x5a4234(0x1ea)](_0x5a4234(0x1a1)+_0x284a5b[_0x5a4234(0x1ef)]),_0x284a5b[_0x5a4234(0x1e9)]&&console[_0x5a4234(0x1ea)](_0x5a4234(0x1d4)+_0x284a5b[_0x5a4234(0x1e9)]);}await database_1[_0x5a4234(0x1a9)]['payment'][_0x5a4234(0x13b)]({'where':{'id':_0x431cb2['id']},'data':_0x5dddd1}),await database_1[_0x5a4234(0x1a9)]['webhookLog'][_0x5a4234(0x1e0)]({'data':{'paymentId':_0x431cb2['id'],'shopId':_0x431cb2[_0x5a4234(0x193)],'event':'cointopay_status_check_'+_0x47004f[_0x5a4234(0x174)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x5a4234(0x163)]({'oldStatus':_0x431cb2[_0x5a4234(0x174)],'newStatus':_0x47004f[_0x5a4234(0x174)],'paymentDetails':_0x47004f[_0x5a4234(0x1d6)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x5a4234(0x152)](_0x431cb2,_0x47004f['status']),await this[_0x5a4234(0x1ed)](_0x431cb2,_0x47004f[_0x5a4234(0x174)]),_0x47004f[_0x5a4234(0x174)]!==_0x5a4234(0x1aa)&&(console['log'](_0x5a4234(0x18f)+_0x431cb2['id']+'\x20status\x20changed\x20to\x20'+_0x47004f[_0x5a4234(0x174)]+_0x5a4234(0x130)),this['clearPaymentTimers'](_0x431cb2['id'])),console[_0x5a4234(0x1ea)](_0x5a4234(0x1c6)+_0x431cb2['id']+_0x5a4234(0x132));}else console['log'](_0x5a4234(0x120)+_0x431cb2['id']+'\x20status\x20unchanged\x20('+_0x47004f[_0x5a4234(0x174)]+')'),this[_0x5a4234(0x11b)](_0x431cb2['id'],_0x431cb2[_0x5a4234(0x1d7)],_0x431cb2[_0x5a4234(0x174)],_0x47004f[_0x5a4234(0x174)],_0x5a4234(0x192),{'statusUnchanged':!![],'paymentDetails':_0x47004f[_0x5a4234(0x1d6)],'amount':_0x47004f[_0x5a4234(0x124)],'currency':_0x47004f['currency'],'shopId':_0x431cb2[_0x5a4234(0x193)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x1d61b5){console['error'](_0x5a4234(0x123)+_0x431cb2['id']+':',_0x1d61b5),this[_0x5a4234(0x13e)](_0x431cb2['id'],_0x431cb2[_0x5a4234(0x1d7)],_0x1d61b5,_0x5a4234(0x192),{'paymentAmount':_0x431cb2[_0x5a4234(0x124)],'paymentCurrency':_0x431cb2[_0x5a4234(0x17b)],'shopId':_0x431cb2[_0x5a4234(0x193)],'createdAt':_0x431cb2[_0x5a4234(0x1e4)]}),await database_1['default'][_0x5a4234(0x1e7)][_0x5a4234(0x1e0)]({'data':{'paymentId':_0x431cb2['id'],'shopId':_0x431cb2[_0x5a4234(0x193)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x1d61b5 instanceof Error?_0x1d61b5['message']:'Unknown\x20error','gatewayPaymentId':_0x431cb2[_0x5a4234(0x1d7)],'checkedAt':new Date()[_0x5a4234(0x1a0)]()})}});}}async['sendShopWebhook'](_0x2e3dcd,_0x1675f1){const _0x6e82e0=a35_0x338f79,_0x506e2c=Date['now']();try{const _0x35b872=_0x2e3dcd[_0x6e82e0(0x1c9)],_0x415325=_0x35b872[_0x6e82e0(0x1dd)];if(!_0x415325?.[_0x6e82e0(0x19a)]){console[_0x6e82e0(0x1ea)](_0x6e82e0(0x1bf)+_0x35b872['id']);return;}const _0x5ddea0=_0x1675f1===_0x6e82e0(0x178)?'payment.success':_0x1675f1===_0x6e82e0(0x146)?_0x6e82e0(0x184):_0x1675f1===_0x6e82e0(0x1be)?_0x6e82e0(0x184):_0x6e82e0(0x1cd);if(!_0x415325['webhookEvents']?.[_0x6e82e0(0x1b9)](_0x5ddea0)){console[_0x6e82e0(0x1ea)](_0x6e82e0(0x147)+_0x5ddea0+'\x20not\x20enabled\x20for\x20shop\x20'+_0x35b872['id']);return;}const _0x10782e={'event':_0x5ddea0,'payment':{'id':_0x2e3dcd['id'],'order_id':_0x2e3dcd['orderId'],'gateway_order_id':_0x2e3dcd['gatewayOrderId'],'gateway':_0x6e82e0(0x12d),'amount':_0x2e3dcd['amount'],'currency':_0x2e3dcd[_0x6e82e0(0x17b)],'status':_0x1675f1[_0x6e82e0(0x1ac)](),'customer_email':_0x2e3dcd[_0x6e82e0(0x156)],'customer_name':_0x2e3dcd[_0x6e82e0(0x144)],'created_at':_0x2e3dcd[_0x6e82e0(0x1e4)],'updated_at':new Date()}},_0x226009=await fetch(_0x415325[_0x6e82e0(0x19a)],{'method':_0x6e82e0(0x1cf),'headers':{'Content-Type':_0x6e82e0(0x1d3),'User-Agent':_0x6e82e0(0x15e)},'body':JSON[_0x6e82e0(0x163)](_0x10782e)}),_0x1e3321=Date['now']()-_0x506e2c,_0x358842=_0x226009['ok']?'Success':await _0x226009['text']();loggerService_1[_0x6e82e0(0x15a)][_0x6e82e0(0x1f4)](_0x2e3dcd['shopId'],_0x415325[_0x6e82e0(0x19a)],_0x5ddea0,_0x226009['status'],_0x1e3321,_0x10782e),console[_0x6e82e0(0x1ea)](_0x6e82e0(0x1d8)+_0x415325['webhookUrl']+_0x6e82e0(0x138)+_0x226009[_0x6e82e0(0x174)]+'\x20('+_0x1e3321+'ms)');}catch(_0x17ffeb){console[_0x6e82e0(0x1c5)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x17ffeb),loggerService_1['loggerService']['logShopWebhookError'](_0x2e3dcd['shopId'],_0x2e3dcd['shop']?.[_0x6e82e0(0x1dd)]?.[_0x6e82e0(0x19a)]||_0x6e82e0(0x190),'webhook_send',_0x17ffeb,{});}}async[a35_0x338f79(0x1ed)](_0x3f9f59,_0x3c82b3){const _0x6a5556=a35_0x338f79;try{const _0x58c10e={'PENDING':_0x6a5556(0x12c),'PAID':_0x6a5556(0x1e2),'FAILED':'failed','EXPIRED':_0x6a5556(0x1ba)},_0x4027bf=_0x58c10e[_0x3c82b3];if(!_0x4027bf||_0x4027bf==='created')return;await telegramBotService_1[_0x6a5556(0x139)][_0x6a5556(0x16a)](_0x3f9f59['shopId'],_0x3f9f59,_0x4027bf);}catch(_0x202d30){console['error'](_0x6a5556(0x1cb),_0x202d30);}}async[a35_0x338f79(0x1f1)](_0x3f1412){const _0x3bb6fb=a35_0x338f79;console['log'](_0x3bb6fb(0x154)+_0x3f1412);const _0x32a5da=await database_1['default'][_0x3bb6fb(0x1ca)][_0x3bb6fb(0x17c)]({'where':{'id':_0x3f1412},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x32a5da)throw new Error('Payment\x20not\x20found');if(_0x32a5da[_0x3bb6fb(0x169)]!==_0x3bb6fb(0x1e1))throw new Error(_0x3bb6fb(0x127));console['log'](_0x3bb6fb(0x196)+_0x3f1412),await this[_0x3bb6fb(0x16e)](_0x32a5da),console[_0x3bb6fb(0x1ea)](_0x3bb6fb(0x1ee)+_0x3f1412);}[a35_0x338f79(0x161)](){const _0x4eae1c=a35_0x338f79,_0x420cea=this[_0x4eae1c(0x1a6)]?this[_0x4eae1c(0x153)]:undefined,_0x1bb052=Array['from'](this[_0x4eae1c(0x128)][_0x4eae1c(0x173)]())[_0x4eae1c(0x172)](_0xf0c623=>({'paymentId':_0xf0c623['paymentId'],'gatewayPaymentId':_0xf0c623[_0x4eae1c(0x1d7)],'createdAt':_0xf0c623['createdAt'],'timersCount':_0xf0c623[_0x4eae1c(0x199)]['length']}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x4eae1c(0x128)][_0x4eae1c(0x136)],'nextGlobalCheckIn':_0x420cea,'paymentTimersDetails':_0x1bb052};}['getPaymentTimerInfo'](_0x490275){const _0x192fe1=a35_0x338f79,_0x493fb6=this[_0x192fe1(0x128)][_0x192fe1(0x1b8)](_0x490275);if(_0x493fb6)return{'hasTimers':!![],'timersCount':_0x493fb6[_0x192fe1(0x199)][_0x192fe1(0x157)],'createdAt':_0x493fb6['createdAt'],'gatewayPaymentId':_0x493fb6[_0x192fe1(0x1d7)]};return{'hasTimers':![]};}}exports[a35_0x338f79(0x1ec)]=CoinToPayStatusService,exports[a35_0x338f79(0x16d)]=new CoinToPayStatusService();