'use strict';const a37_0x4f79fd=a37_0x1cf0;(function(_0x1fbf40,_0x4ce88a){const _0x10d8f7=a37_0x1cf0,_0x2b94be=_0x1fbf40();while(!![]){try{const _0x1891b1=-parseInt(_0x10d8f7(0x152))/0x1*(-parseInt(_0x10d8f7(0x13a))/0x2)+parseInt(_0x10d8f7(0x1c7))/0x3+parseInt(_0x10d8f7(0x1a2))/0x4*(-parseInt(_0x10d8f7(0x185))/0x5)+parseInt(_0x10d8f7(0x15a))/0x6+-parseInt(_0x10d8f7(0x210))/0x7+-parseInt(_0x10d8f7(0x19d))/0x8*(parseInt(_0x10d8f7(0x16d))/0x9)+-parseInt(_0x10d8f7(0x1be))/0xa*(-parseInt(_0x10d8f7(0x19c))/0xb);if(_0x1891b1===_0x4ce88a)break;else _0x2b94be['push'](_0x2b94be['shift']());}catch(_0x18f10a){_0x2b94be['push'](_0x2b94be['shift']());}}}(a37_0x2cd7,0x2e504));function a37_0x2cd7(){const _0x1a1911=['❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','amountUSDT','message','from','\x20found:','\x20timers\x20for\x20payment\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','timers','COINTOPAY_STATUS_CHANGE','payment.failed','✅\x20[HOURLY]\x20Payment\x20','\x20with\x20status\x20','\x20\x20\x20Amount\x20after\x20commission:\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','CoinToPayService','startPeriodicStatusCheck','974421DaMClp','paymentLink','paymentLinkId','currentPayments','stringify','orderId','default','checkSinglePayment','\x20\x20\x20Amount:\x20','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','webhook_send','\x20current\x20status:\x20','Gateway\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','CoinToPayStatusService','map','values','\x20->\x20','\x20expired','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20is\x20older\x20than\x20','\x20marked\x20as\x20paid\x20at:\x20','checkPaymentStatus','.\x20Remaining\x20active\x20timers:\x20','push','settings','\x20payment\x20','auto_expire','\x20\x20\x20-\x20Status:\x20','./telegramBotService','size','\x20status\x20from\x20','telegramBotService','⏰\x20[HOURLY]\x20Payment\x20',',\x20clearing\x20individual\x20timers','shopId','schedule_created','COINTOPAY_ERROR','failed','\x20days\x20without\x20payment\x20confirmation','__importDefault','\x20status\x20unchanged\x20(','toISOString','amount','📊\x20[CHECK]\x20Payment\x20','not\x20found','log','\x20USDT','confirmedOn','cointopay','forEach','floor','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','checkExpiredPayments','\x20(age:\x20','sendShopWebhook','getDate','cointopay_status_check_error','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','PENDING','clearPaymentTimers','\x20\x20\x20📍\x20Source:\x20','loggerService','checkAllPendingPayments','\x20skipped,\x20','GLOBAL_CHECK_INTERVAL_MS','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','delay','10WRcHSi','⏰\x20[GLOBAL]\x20Found\x20','application/json','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','\x20checked,\x20','paymentId','coinToPayService','\x20days','getGatewayIdByName','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20\x20\x20📝\x20Details:','transactionId','📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','customerEmail','globalCheckInterval','⏰\x20[EXPIRY]\x20Payment\x20','ms)','\x20triggered\x20for\x20payment\x20',',\x20using\x20default\x20commission\x2010%','\x20\x20\x20-\x20ShopId:\x20','customerName','5\x20minutes','remitterIban','./loggerService','59457HcBxbB','\x20pending\x20CoinToPay\x20payments','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','getGatewayCommission','\x20updated\x20successfully','🛑\x20[SHUTDOWN]\x20Cleared\x20','checkSinglePaymentById','amountAfterGatewayCommissionUSDT','825342GFsJWH','\x20\x20\x20-\x20paymentId:\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','toLowerCase','Bank\x20Details:\x20','entries',',\x20stopping\x20individual\x20checks','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','webhookLog','coinToPay2Service','defineProperty','error','\x20expired\x20CoinToPay\x20payments','get','\x20commission:\x20','status_check','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','currency','stack','9738aObTmH','text','timestamp','../types/gateway','set','gatewaySettings','\x20\x20\x20📅\x20Time:\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','coinToPayStatusService','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','logCoinToPayError','schedulePaymentChecks','🪙\x20[DEBUG]\x20Creating\x20','paid','PAID','✅\x20[COINTOPAY]\x20Payment\x20link\x20','adminNotes','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','sendPaymentStatusNotification','📊\x20[HOURLY]\x20Payment\x20','\x20seconds\x20(','/status/','1874365oPifgH','✅\x20[CHECK]\x20Payment\x20','EXPIRY_DAYS','\x20status\x20changed\x20to\x20','\x20for\x20payment\x20','Success','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20to\x20clear','❌\x20[HOURLY]\x20Payment\x20','🪙\x20[GLOBAL]\x20Found\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','🔍\x20[CHECK]\x20Checking\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','⚠️\x20[CHECK]\x20Payment\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','\x20has\x20no\x20gatewayPaymentId','🧹\x20[CHECK]\x20Payment\x20','stopPeriodicStatusCheck','paymentDetails','COMPLETED','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20is\x20too\x20new\x20(','748diDJFY','1384ZMyOzm','iban','length','\x20has\x20no\x20gatewayPaymentId,\x20skipping','-day\x20timeout','4NItdll','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','1\x20minute','findMany','catch','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','commission','webhookEvents','💰\x20[CHECK]\x20Payment\x20','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','description','EXPIRED','sendPaymentNotification','\x20(after\x20','paidAt','\x20\x20\x20-\x20gatewayPaymentId:\x20','findUnique','logWhiteDomainError','./gateways/coinToPayService','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','h),\x20skipping\x20global\x20check','getPaymentTimerInfo','create','27710KbLdrF','\x20completed\x20for\x20payment\x20','payment','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','Shop\x20webhook\x20sent\x20to\x20',':\x20type=','setDate','803076BadpHs','toFixed','created','getTime',',\x20gateway\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','🧹\x20[DEBUG]\x20Clearing\x20','logCoinToPayStatus','gatewayPaymentId',',\x20status=','unknown','expired','has','Unknown\x20error','✅\x20[EXPIRY]\x20Payment\x20','cointopay2','❌\x20[CHECK]\x20Payment\x20','cointopay_auto_expired',',\x20currentPayments=','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','cointopay_status_check_','webhookUrl','\x20in\x20shop\x20','gateway','status','now','shop','includes',',\x20using\x20default\x2010%','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','Payment\x20older\x20than\x20','TesSoft\x20Payment\x20System/1.0','checkPaymentById','Automatically\x20expired\x20after\x20','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','📈\x20[COINTOPAY]\x20Payment\x20','\x20not\x20enabled\x20for\x20shop\x20','\x20not\x20found,\x20clearing\x20timers','delete','logShopWebhookError','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','convertToUSDT','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','payment.success','\x20\x20\x20-\x20Gateway:\x20','\x20not\x20found\x20in\x20database','not\x20confirmed','update','bankDetails','⏰\x20[GLOBAL]\x20Payment\x20','SINGLE','\x20\x20\x20-\x20Amount:\x20','createdAt','__esModule','paymentTimers'];a37_0x2cd7=function(){return _0x1a1911;};return a37_0x2cd7();}var __importDefault=this&&this[a37_0x4f79fd(0x11e)]||function(_0x86944c){const _0x518eee=a37_0x4f79fd;return _0x86944c&&_0x86944c[_0x518eee(0x1fe)]?_0x86944c:{'default':_0x86944c};};Object[a37_0x4f79fd(0x164)](exports,a37_0x4f79fd(0x1fe),{'value':!![]}),exports[a37_0x4f79fd(0x176)]=exports[a37_0x4f79fd(0x21e)]=void 0x0;const coinToPayService_1=require(a37_0x4f79fd(0x1b7)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require(a37_0x4f79fd(0x170)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x4f79fd(0x22d)),loggerService_1=require(a37_0x4f79fd(0x151)),currencyService_1=require('./currencyService');class CoinToPayStatusService{constructor(){const _0x58318a=a37_0x4f79fd;this['globalCheckInterval']=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x58318a(0x1ff)]=new Map(),this[_0x58318a(0x140)]=new coinToPayService_1[(_0x58318a(0x20e))](),this[_0x58318a(0x163)]=new coinToPay2Service_1['CoinToPay2Service'](),console['log']('🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}[a37_0x4f79fd(0x179)](_0x16311c,_0xed58f){const _0x48b84a=a37_0x4f79fd;console[_0x48b84a(0x124)](_0x48b84a(0x19a)),console[_0x48b84a(0x124)](_0x48b84a(0x15b)+_0x16311c),console[_0x48b84a(0x124)](_0x48b84a(0x1b4)+_0xed58f),this[_0x48b84a(0x132)](_0x16311c);const _0x4b7e54=[],_0x43663f=new Date(),_0x4c4d49=[{'delay':0x1*0x3c*0x3e8,'description':_0x48b84a(0x1a4)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x48b84a(0x14f)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x48b84a(0x124)](_0x48b84a(0x17a)+_0x4c4d49[_0x48b84a(0x19f)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x16311c);let _0x291d5f=0x0;_0x4c4d49['forEach']((_0x15763f,_0x104766)=>{const _0x1000e0=_0x48b84a;_0x291d5f+=_0x15763f[_0x1000e0(0x139)];const _0x5b8b1f=setTimeout(async()=>{const _0x2c038b=_0x1000e0;console[_0x2c038b(0x124)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0x104766+0x1)+_0x2c038b(0x14b)+_0x16311c+_0x2c038b(0x1b2)+_0x15763f[_0x2c038b(0x1af)]+')');try{await this['checkSinglePaymentById'](_0x16311c),console[_0x2c038b(0x124)](_0x2c038b(0x190)+(_0x104766+0x1)+_0x2c038b(0x1bf)+_0x16311c);}catch(_0x5ca666){console['error'](_0x2c038b(0x161)+(_0x104766+0x1)+_0x2c038b(0x189)+_0x16311c+':',_0x5ca666),this[_0x2c038b(0x178)](_0x16311c,_0xed58f,_0x5ca666,_0x2c038b(0x169),{'checkNumber':_0x104766+0x1,'scheduledAfter':_0x15763f[_0x2c038b(0x1af)],'isIndividualCheck':!![]});}},_0x291d5f);_0x4b7e54['push'](_0x5b8b1f),console['log']('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x104766+0x1)+_0x1000e0(0x189)+_0x16311c+'\x20in\x20'+_0x291d5f/0x3e8+_0x1000e0(0x183)+_0x15763f[_0x1000e0(0x1af)]+')');});const _0x11cc75=setInterval(async()=>{const _0x47eb35=_0x48b84a;console[_0x47eb35(0x124)](_0x47eb35(0x17f)+_0x16311c);try{const _0x53cb88=await database_1[_0x47eb35(0x216)][_0x47eb35(0x1c0)][_0x47eb35(0x1b5)]({'where':{'id':_0x16311c},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x53cb88){console['log'](_0x47eb35(0x18e)+_0x16311c+_0x47eb35(0x1ee)),this[_0x47eb35(0x132)](_0x16311c);return;}console[_0x47eb35(0x124)](_0x47eb35(0x182)+_0x16311c+_0x47eb35(0x21b)+_0x53cb88[_0x47eb35(0x1e1)]);if(_0x53cb88[_0x47eb35(0x1e1)]!==_0x47eb35(0x131)){console[_0x47eb35(0x124)](_0x47eb35(0x20a)+_0x16311c+'\x20status\x20is\x20'+_0x53cb88[_0x47eb35(0x1e1)]+_0x47eb35(0x160)),this[_0x47eb35(0x132)](_0x16311c);return;}const _0x59a991=Math[_0x47eb35(0x129)]((Date[_0x47eb35(0x1e2)]()-_0x53cb88[_0x47eb35(0x1fd)][_0x47eb35(0x1ca)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x59a991>=this[_0x47eb35(0x187)]){console['log'](_0x47eb35(0x231)+_0x16311c+'\x20is\x20older\x20than\x20'+this[_0x47eb35(0x187)]+_0x47eb35(0x1e6)),this[_0x47eb35(0x132)](_0x16311c);return;}await this[_0x47eb35(0x158)](_0x16311c),console[_0x47eb35(0x124)](_0x47eb35(0x18c)+_0x16311c);}catch(_0x133924){console[_0x47eb35(0x165)]('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x16311c+':',_0x133924),this['logCoinToPayError'](_0x16311c,_0xed58f,_0x133924,_0x47eb35(0x169),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x4b7e54['push'](_0x11cc75),this['paymentTimers'][_0x48b84a(0x171)](_0x16311c,{'timers':_0x4b7e54,'paymentId':_0x16311c,'gatewayPaymentId':_0xed58f,'createdAt':_0x43663f}),console['log']('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x4c4d49['length']+_0x48b84a(0x175)+_0x16311c),console[_0x48b84a(0x124)]('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x48b84a(0x1ff)]['size']),this[_0x48b84a(0x1ce)](_0x16311c,_0xed58f,_0x48b84a(0x131),_0x48b84a(0x131),_0x48b84a(0x169),{'action':_0x48b84a(0x234),'scheduledChecks':_0x4c4d49[_0x48b84a(0x19f)],'firstCheckIn':_0x4c4d49[0x0]['delay']/0x3e8,'totalTimers':this[_0x48b84a(0x1ff)][_0x48b84a(0x22e)]});}[a37_0x4f79fd(0x132)](_0x2cf7d3){const _0xe3732=a37_0x4f79fd,_0xcef26b=this[_0xe3732(0x1ff)][_0xe3732(0x167)](_0x2cf7d3);_0xcef26b?(console[_0xe3732(0x124)](_0xe3732(0x1cd)+_0xcef26b[_0xe3732(0x207)]['length']+_0xe3732(0x205)+_0x2cf7d3),_0xcef26b['timers'][_0xe3732(0x128)]((_0x18e138,_0xacaa2)=>{const _0x17a3ae=_0xe3732;_0x18e138&&(clearTimeout(_0x18e138),clearInterval(_0x18e138),console[_0x17a3ae(0x124)]('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0xacaa2+0x1)+_0x17a3ae(0x189)+_0x2cf7d3));}),this[_0xe3732(0x1ff)][_0xe3732(0x1ef)](_0x2cf7d3),console[_0xe3732(0x124)](_0xe3732(0x18b)+_0x2cf7d3+_0xe3732(0x227)+this['paymentTimers'][_0xe3732(0x22e)])):console[_0xe3732(0x124)](_0xe3732(0x15c)+_0x2cf7d3+_0xe3732(0x18d));}async[a37_0x4f79fd(0x158)](_0x197a12){const _0x707259=a37_0x4f79fd;console['log'](_0x707259(0x1cc)+_0x197a12);const _0x15e19d=await database_1[_0x707259(0x216)][_0x707259(0x1c0)]['findUnique']({'where':{'id':_0x197a12},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x15e19d){console[_0x707259(0x124)](_0x707259(0x1d7)+_0x197a12+_0x707259(0x1f6));return;}console[_0x707259(0x124)](_0x707259(0x122)+_0x197a12+_0x707259(0x204)),console[_0x707259(0x124)](_0x707259(0x1f5)+_0x15e19d[_0x707259(0x1e0)]),console['log'](_0x707259(0x22c)+_0x15e19d[_0x707259(0x1e1)]),console[_0x707259(0x124)](_0x707259(0x20d)+_0x15e19d[_0x707259(0x1cf)]),console['log'](_0x707259(0x1fc)+_0x15e19d[_0x707259(0x121)]+'\x20'+_0x15e19d['currency']),console[_0x707259(0x124)](_0x707259(0x14d)+_0x15e19d[_0x707259(0x233)]);if(_0x15e19d['gateway']!==_0x707259(0x127)&&_0x15e19d[_0x707259(0x1e0)]!==_0x707259(0x1d6)){console[_0x707259(0x124)](_0x707259(0x193)+_0x197a12+_0x707259(0x1eb)+_0x15e19d[_0x707259(0x1e0)]+')');return;}if(_0x15e19d['status']!==_0x707259(0x131)){console['log'](_0x707259(0x193)+_0x197a12+'\x20status\x20is\x20'+_0x15e19d[_0x707259(0x1e1)]+_0x707259(0x160)),this['clearPaymentTimers'](_0x197a12);return;}if(!_0x15e19d[_0x707259(0x1cf)]){console[_0x707259(0x124)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x197a12+_0x707259(0x195));return;}console[_0x707259(0x124)](_0x707259(0x186)+_0x197a12+_0x707259(0x192)),await this[_0x707259(0x217)](_0x15e19d);}[a37_0x4f79fd(0x1ce)](_0x1a106c,_0x2a40ef,_0x2310b1,_0x5ba9d7,_0x138b5f,_0x2c8fea){const _0x253f54=a37_0x4f79fd,_0x5b2753={'type':_0x253f54(0x208),'paymentId':_0x1a106c,'gatewayPaymentId':_0x2a40ef,'oldStatus':_0x2310b1,'newStatus':_0x5ba9d7,'source':_0x138b5f,'timestamp':new Date()[_0x253f54(0x120)](),'details':_0x2c8fea||{}};loggerService_1[_0x253f54(0x134)][_0x253f54(0x1ce)](_0x5b2753),console['log'](_0x253f54(0x1ba)+_0x1a106c+'\x20('+_0x2a40ef+')'),console[_0x253f54(0x124)]('\x20\x20\x20📊\x20Status:\x20'+_0x2310b1+_0x253f54(0x221)+_0x5ba9d7),console[_0x253f54(0x124)](_0x253f54(0x133)+_0x138b5f),console[_0x253f54(0x124)](_0x253f54(0x173)+_0x5b2753[_0x253f54(0x16f)]),_0x2c8fea&&console[_0x253f54(0x124)](_0x253f54(0x144),_0x2c8fea);}[a37_0x4f79fd(0x178)](_0x3f923c,_0x3c915c,_0xd3bef2,_0x25ccd3,_0x318ca3){const _0x518140=a37_0x4f79fd,_0x122aa4={'type':_0x518140(0x235),'paymentId':_0x3f923c,'gatewayPaymentId':_0x3c915c,'error':_0xd3bef2 instanceof Error?{'message':_0xd3bef2[_0x518140(0x202)],'stack':_0xd3bef2[_0x518140(0x16c)]}:_0xd3bef2,'source':_0x25ccd3,'timestamp':new Date()[_0x518140(0x120)](),'context':_0x318ca3||{}};loggerService_1['loggerService'][_0x518140(0x178)](_0x122aa4),console['error'](_0x518140(0x1f1)+_0x3f923c+'\x20('+_0x3c915c+')'),console[_0x518140(0x165)]('\x20\x20\x20❌\x20Error:\x20'+(_0xd3bef2 instanceof Error?_0xd3bef2[_0x518140(0x202)]:_0xd3bef2)),console[_0x518140(0x165)]('\x20\x20\x20📍\x20Source:\x20'+_0x25ccd3),console[_0x518140(0x165)](_0x518140(0x173)+_0x122aa4[_0x518140(0x16f)]),_0x318ca3&&console[_0x518140(0x165)]('\x20\x20\x20📝\x20Context:',_0x318ca3);}[a37_0x4f79fd(0x20f)](){const _0x1e7fd2=a37_0x4f79fd;console[_0x1e7fd2(0x124)](_0x1e7fd2(0x16a)),this['checkAllPendingPayments']()[_0x1e7fd2(0x1a6)](_0x463b42=>{const _0x5674cf=_0x1e7fd2;console['error'](_0x5674cf(0x223),_0x463b42);}),this[_0x1e7fd2(0x148)]=setInterval(async()=>{const _0x3d68f3=_0x1e7fd2;try{console[_0x3d68f3(0x124)](_0x3d68f3(0x1a3)),await this[_0x3d68f3(0x135)](),console[_0x3d68f3(0x124)](_0x3d68f3(0x143));}catch(_0x572bb8){console[_0x3d68f3(0x165)]('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x572bb8);}},this[_0x1e7fd2(0x137)]),console[_0x1e7fd2(0x124)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x4f79fd(0x197)](){const _0x17aae2=a37_0x4f79fd;console[_0x17aae2(0x124)](_0x17aae2(0x206));this[_0x17aae2(0x148)]&&(clearInterval(this[_0x17aae2(0x148)]),this[_0x17aae2(0x148)]=null,console['log'](_0x17aae2(0x1a7)));const _0x321ff9=this[_0x17aae2(0x1ff)][_0x17aae2(0x22e)];for(const [_0x555c8a]of this[_0x17aae2(0x1ff)]){this[_0x17aae2(0x132)](_0x555c8a);}console[_0x17aae2(0x124)](_0x17aae2(0x157)+_0x321ff9+'\x20individual\x20payment\x20timers');}async[a37_0x4f79fd(0x135)](){const _0x2f4b25=a37_0x4f79fd;try{console[_0x2f4b25(0x124)](_0x2f4b25(0x138));const _0x4491fb=await database_1['default'][_0x2f4b25(0x1c0)][_0x2f4b25(0x1a5)]({'where':{'gateway':{'in':['cointopay',_0x2f4b25(0x1d6)]},'status':_0x2f4b25(0x131),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x2f4b25(0x124)](_0x2f4b25(0x18f)+_0x4491fb[_0x2f4b25(0x19f)]+_0x2f4b25(0x153));if(_0x4491fb[_0x2f4b25(0x19f)]===0x0){console[_0x2f4b25(0x124)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x1c9e26=await this[_0x2f4b25(0x12b)](_0x4491fb);console['log'](_0x2f4b25(0x13b)+_0x1c9e26[_0x2f4b25(0x19f)]+_0x2f4b25(0x166));let _0x1238a7=0x0,_0x129347=0x0;for(const _0x108b49 of _0x4491fb){try{if(_0x1c9e26[_0x2f4b25(0x1e4)](_0x108b49['id'])){console['log'](_0x2f4b25(0x1fa)+_0x108b49['id']+_0x2f4b25(0x1b8)),_0x129347++;continue;}if(this[_0x2f4b25(0x1ff)][_0x2f4b25(0x1d3)](_0x108b49['id'])){console[_0x2f4b25(0x124)](_0x2f4b25(0x1fa)+_0x108b49['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x129347++;continue;}const _0x530945=(Date[_0x2f4b25(0x1e2)]()-_0x108b49[_0x2f4b25(0x1fd)][_0x2f4b25(0x1ca)]())/(0x3e8*0x3c*0x3c);if(_0x530945<0x1){console[_0x2f4b25(0x124)](_0x2f4b25(0x1fa)+_0x108b49['id']+_0x2f4b25(0x19b)+_0x530945[_0x2f4b25(0x1c8)](0x1)+_0x2f4b25(0x1bb)),_0x129347++;continue;}console[_0x2f4b25(0x124)](_0x2f4b25(0x1da)+_0x108b49['id']+_0x2f4b25(0x12c)+_0x530945['toFixed'](0x1)+'h)'),await this[_0x2f4b25(0x217)](_0x108b49),_0x1238a7++,await new Promise(_0x59ea68=>setTimeout(_0x59ea68,0x7d0));}catch(_0x27cd41){console['error'](_0x2f4b25(0x200)+_0x108b49['id']+':',_0x27cd41),this['logCoinToPayError'](_0x108b49['id'],_0x108b49[_0x2f4b25(0x1cf)]||'unknown',_0x27cd41,_0x2f4b25(0x169),{'isGlobalCheck':!![],'paymentAmount':_0x108b49[_0x2f4b25(0x121)],'paymentCurrency':_0x108b49[_0x2f4b25(0x16b)],'shopId':_0x108b49[_0x2f4b25(0x233)],'createdAt':_0x108b49[_0x2f4b25(0x1fd)]}),loggerService_1[_0x2f4b25(0x134)][_0x2f4b25(0x1b6)](_0x2f4b25(0x127),_0x2f4b25(0x184)+_0x108b49[_0x2f4b25(0x1cf)],_0x27cd41);}}console[_0x2f4b25(0x124)](_0x2f4b25(0x1f3)+_0x1238a7+_0x2f4b25(0x13e)+_0x129347+_0x2f4b25(0x136)+_0x1c9e26['length']+_0x2f4b25(0x222));}catch(_0x514406){console[_0x2f4b25(0x165)](_0x2f4b25(0x21d),_0x514406);}}async[a37_0x4f79fd(0x12b)](_0xd68cb8){const _0x5e6aa3=a37_0x4f79fd,_0x1afc83=[],_0x57478b=new Date();_0x57478b[_0x5e6aa3(0x1c6)](_0x57478b[_0x5e6aa3(0x12e)]()-this['EXPIRY_DAYS']),console['log'](_0x5e6aa3(0x174)+this[_0x5e6aa3(0x187)]+'\x20days\x20(created\x20before\x20'+_0x57478b[_0x5e6aa3(0x120)]()+')');for(const _0x1e28ec of _0xd68cb8){if(_0x1e28ec['createdAt']<_0x57478b){console[_0x5e6aa3(0x124)](_0x5e6aa3(0x149)+_0x1e28ec['id']+_0x5e6aa3(0x224)+this[_0x5e6aa3(0x187)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x5e6aa3(0x1ce)](_0x1e28ec['id'],_0x1e28ec[_0x5e6aa3(0x1cf)]||_0x5e6aa3(0x1d1),_0x5e6aa3(0x131),'EXPIRED',_0x5e6aa3(0x22b),{'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x1e28ec[_0x5e6aa3(0x1fd)],'daysSinceCreation':Math[_0x5e6aa3(0x129)]((Date['now']()-_0x1e28ec[_0x5e6aa3(0x1fd)][_0x5e6aa3(0x1ca)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x1e28ec[_0x5e6aa3(0x121)],'paymentCurrency':_0x1e28ec['currency'],'shopId':_0x1e28ec['shopId']}),await database_1[_0x5e6aa3(0x216)][_0x5e6aa3(0x1c0)][_0x5e6aa3(0x1f8)]({'where':{'id':_0x1e28ec['id']},'data':{'status':_0x5e6aa3(0x1b0),'updatedAt':new Date(),'adminNotes':_0x5e6aa3(0x1ea)+this[_0x5e6aa3(0x187)]+_0x5e6aa3(0x237)}}),await database_1[_0x5e6aa3(0x216)][_0x5e6aa3(0x162)][_0x5e6aa3(0x1bd)]({'data':{'paymentId':_0x1e28ec['id'],'shopId':_0x1e28ec['shopId'],'event':_0x5e6aa3(0x1d8),'statusCode':0xc8,'responseBody':JSON[_0x5e6aa3(0x214)]({'reason':_0x5e6aa3(0x1e7)+this[_0x5e6aa3(0x187)]+_0x5e6aa3(0x141),'createdAt':_0x1e28ec[_0x5e6aa3(0x1fd)],'expiredAt':new Date()[_0x5e6aa3(0x120)](),'daysSinceCreation':Math[_0x5e6aa3(0x129)]((Date[_0x5e6aa3(0x1e2)]()-_0x1e28ec[_0x5e6aa3(0x1fd)][_0x5e6aa3(0x1ca)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x5e6aa3(0x12d)](_0x1e28ec,'EXPIRED'),await this[_0x5e6aa3(0x181)](_0x1e28ec,_0x5e6aa3(0x1b0)),this['clearPaymentTimers'](_0x1e28ec['id']),_0x1afc83[_0x5e6aa3(0x228)](_0x1e28ec['id']),console['log'](_0x5e6aa3(0x1d5)+_0x1e28ec['id']+_0x5e6aa3(0x180)+this[_0x5e6aa3(0x187)]+_0x5e6aa3(0x1a1));}catch(_0x41ef94){console[_0x5e6aa3(0x165)](_0x5e6aa3(0x130)+_0x1e28ec['id']+':',_0x41ef94),this['logCoinToPayError'](_0x1e28ec['id'],_0x1e28ec[_0x5e6aa3(0x1cf)]||_0x5e6aa3(0x1d1),_0x41ef94,_0x5e6aa3(0x22b),{'reason':_0x5e6aa3(0x1ad),'createdAt':_0x1e28ec[_0x5e6aa3(0x1fd)],'daysSinceCreation':Math[_0x5e6aa3(0x129)]((Date[_0x5e6aa3(0x1e2)]()-_0x1e28ec[_0x5e6aa3(0x1fd)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x1afc83;}async[a37_0x4f79fd(0x217)](_0x336f23){const _0x4f6c37=a37_0x4f79fd;if(!_0x336f23[_0x4f6c37(0x1cf)]){console['log'](_0x4f6c37(0x193)+_0x336f23['id']+_0x4f6c37(0x1a0));return;}console['log'](_0x4f6c37(0x191)+_0x336f23['gateway']+_0x4f6c37(0x22a)+_0x336f23['id']+'\x20('+_0x336f23[_0x4f6c37(0x1cf)]+')');try{let _0x544107;_0x336f23[_0x4f6c37(0x1e0)]===_0x4f6c37(0x1d6)?(_0x544107=await this[_0x4f6c37(0x163)]['checkPaymentStatus'](_0x336f23['gatewayPaymentId']),console[_0x4f6c37(0x124)](_0x4f6c37(0x1ab)+_0x336f23['id']+'\x20status:\x20'+_0x544107['status'])):(_0x544107=await this[_0x4f6c37(0x140)][_0x4f6c37(0x226)](_0x336f23[_0x4f6c37(0x1cf)]),console[_0x4f6c37(0x124)](_0x4f6c37(0x1c2)+_0x336f23['id']+'\x20status:\x20'+_0x544107[_0x4f6c37(0x1e1)]));_0x544107[_0x4f6c37(0x198)]&&console[_0x4f6c37(0x124)](_0x4f6c37(0x122)+_0x336f23['id']+'\x20details:',{'iban':_0x544107[_0x4f6c37(0x198)][_0x4f6c37(0x19e)]||_0x4f6c37(0x123),'transactionId':_0x544107[_0x4f6c37(0x198)][_0x4f6c37(0x145)],'createdOn':_0x544107[_0x4f6c37(0x198)]['createdOn'],'confirmedOn':_0x544107[_0x4f6c37(0x198)][_0x4f6c37(0x126)]||_0x4f6c37(0x1f7)});if(_0x544107['status']!==_0x336f23[_0x4f6c37(0x1e1)]){console[_0x4f6c37(0x124)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x336f23['id']+_0x4f6c37(0x22f)+_0x336f23['status']+'\x20to\x20'+_0x544107[_0x4f6c37(0x1e1)]),this[_0x4f6c37(0x1ce)](_0x336f23['id'],_0x336f23[_0x4f6c37(0x1cf)],_0x336f23[_0x4f6c37(0x1e1)],_0x544107[_0x4f6c37(0x1e1)],'status_check',{'paymentDetails':_0x544107[_0x4f6c37(0x198)],'amount':_0x544107['amount'],'currency':_0x544107['currency'],'shopId':_0x336f23[_0x4f6c37(0x233)],'checkTimestamp':new Date()[_0x4f6c37(0x120)]()});const _0x5dabdc={'status':_0x544107[_0x4f6c37(0x1e1)],'updatedAt':new Date()};if(_0x544107['status']==='PAID'&&_0x336f23[_0x4f6c37(0x1e1)]!==_0x4f6c37(0x17c)){_0x5dabdc[_0x4f6c37(0x1b3)]=new Date();if(!_0x336f23[_0x4f6c37(0x201)]){const _0x4afb88=await currencyService_1['currencyService'][_0x4f6c37(0x1f2)](_0x336f23[_0x4f6c37(0x121)],_0x336f23[_0x4f6c37(0x16b)]);_0x5dabdc['amountUSDT']=_0x4afb88;const _0xbff847=await this[_0x4f6c37(0x155)](_0x336f23[_0x4f6c37(0x233)],_0x336f23[_0x4f6c37(0x1e0)]),_0x22dec1=_0x4afb88*(0x1-_0xbff847/0x64);_0x5dabdc[_0x4f6c37(0x159)]=_0x22dec1,console['log'](_0x4f6c37(0x1aa)+_0x336f23['id']+'\x20amounts\x20calculated:'),console[_0x4f6c37(0x124)](_0x4f6c37(0x218)+_0x336f23[_0x4f6c37(0x121)]+'\x20'+_0x336f23[_0x4f6c37(0x16b)]+_0x4f6c37(0x221)+_0x4afb88[_0x4f6c37(0x1c8)](0x6)+_0x4f6c37(0x125)),console[_0x4f6c37(0x124)]('\x20\x20\x20Gateway\x20'+_0x336f23['gateway']+_0x4f6c37(0x168)+_0xbff847+'%'),console[_0x4f6c37(0x124)](_0x4f6c37(0x20c)+_0x22dec1[_0x4f6c37(0x1c8)](0x6)+_0x4f6c37(0x125));}console['log']('💰\x20[CHECK]\x20Payment\x20'+_0x336f23['id']+_0x4f6c37(0x225)+_0x5dabdc[_0x4f6c37(0x1b3)][_0x4f6c37(0x120)]());}if(_0x544107[_0x4f6c37(0x198)]){const _0x1b42f5=_0x544107['paymentDetails'];_0x1b42f5['iban']&&(_0x5dabdc[_0x4f6c37(0x150)]=_0x1b42f5[_0x4f6c37(0x19e)],console[_0x4f6c37(0x124)](_0x4f6c37(0x1b9)+_0x1b42f5[_0x4f6c37(0x19e)]));if(_0x1b42f5[_0x4f6c37(0x1f9)]){const _0x18a785=_0x336f23[_0x4f6c37(0x17e)]||'',_0x5135db=_0x4f6c37(0x15e)+_0x1b42f5['bankDetails'];_0x5dabdc[_0x4f6c37(0x17e)]=_0x18a785?_0x18a785+'\x0a\x0a'+_0x5135db:_0x5135db,console[_0x4f6c37(0x124)](_0x4f6c37(0x154));}_0x1b42f5[_0x4f6c37(0x145)]&&console[_0x4f6c37(0x124)]('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x1b42f5[_0x4f6c37(0x145)]),_0x1b42f5[_0x4f6c37(0x126)]&&console['log'](_0x4f6c37(0x1db)+_0x1b42f5[_0x4f6c37(0x126)]);}await database_1[_0x4f6c37(0x216)][_0x4f6c37(0x1c0)]['update']({'where':{'id':_0x336f23['id']},'data':_0x5dabdc});if(_0x544107['status']===_0x4f6c37(0x17c)&&_0x336f23[_0x4f6c37(0x1e1)]!==_0x4f6c37(0x17c)){console[_0x4f6c37(0x124)](_0x4f6c37(0x1ec)+_0x336f23['id']+_0x4f6c37(0x1dc));const _0xef37a4=await database_1[_0x4f6c37(0x216)][_0x4f6c37(0x1c0)][_0x4f6c37(0x1b5)]({'where':{'id':_0x336f23['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0xef37a4?.[_0x4f6c37(0x212)]&&_0xef37a4[_0x4f6c37(0x211)])try{const _0x2e5232=_0xef37a4['paymentLink'];console[_0x4f6c37(0x124)](_0x4f6c37(0x146)+_0x2e5232['id']+_0x4f6c37(0x1c5)+_0x2e5232['type']+_0x4f6c37(0x1d9)+_0x2e5232[_0x4f6c37(0x213)]+_0x4f6c37(0x1d0)+_0x2e5232[_0x4f6c37(0x1e1)]);const _0x16ec31=_0x2e5232[_0x4f6c37(0x213)]+0x1,_0xce751=_0x2e5232['type']===_0x4f6c37(0x1fb)?_0x4f6c37(0x199):_0x2e5232[_0x4f6c37(0x1e1)];await database_1[_0x4f6c37(0x216)]['paymentLink'][_0x4f6c37(0x1f8)]({'where':{'id':_0x2e5232['id']},'data':{'currentPayments':_0x16ec31,'status':_0xce751,'updatedAt':new Date()}}),console[_0x4f6c37(0x124)](_0x4f6c37(0x17d)+_0x2e5232['id']+'\x20updated:\x20currentPayments='+_0x2e5232['currentPayments']+_0x4f6c37(0x221)+_0x16ec31+',\x20status='+_0x2e5232[_0x4f6c37(0x1e1)]+_0x4f6c37(0x221)+_0xce751);}catch(_0x494bd2){console[_0x4f6c37(0x165)](_0x4f6c37(0x13d),_0x494bd2);}else console[_0x4f6c37(0x124)](_0x4f6c37(0x1ec)+_0x336f23['id']+_0x4f6c37(0x177));}await database_1[_0x4f6c37(0x216)]['webhookLog'][_0x4f6c37(0x1bd)]({'data':{'paymentId':_0x336f23['id'],'shopId':_0x336f23[_0x4f6c37(0x233)],'event':_0x4f6c37(0x1dd)+_0x544107['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x4f6c37(0x214)]({'oldStatus':_0x336f23[_0x4f6c37(0x1e1)],'newStatus':_0x544107[_0x4f6c37(0x1e1)],'paymentDetails':_0x544107[_0x4f6c37(0x198)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x4f6c37(0x12d)](_0x336f23,_0x544107[_0x4f6c37(0x1e1)]),await this[_0x4f6c37(0x181)](_0x336f23,_0x544107['status']),_0x544107[_0x4f6c37(0x1e1)]!==_0x4f6c37(0x131)&&(console[_0x4f6c37(0x124)](_0x4f6c37(0x196)+_0x336f23['id']+_0x4f6c37(0x188)+_0x544107[_0x4f6c37(0x1e1)]+_0x4f6c37(0x232)),this[_0x4f6c37(0x132)](_0x336f23['id'])),console['log'](_0x4f6c37(0x186)+_0x336f23['id']+_0x4f6c37(0x156));}else console[_0x4f6c37(0x124)](_0x4f6c37(0x122)+_0x336f23['id']+_0x4f6c37(0x11f)+_0x544107['status']+')'),this[_0x4f6c37(0x1ce)](_0x336f23['id'],_0x336f23[_0x4f6c37(0x1cf)],_0x336f23[_0x4f6c37(0x1e1)],_0x544107['status'],_0x4f6c37(0x169),{'statusUnchanged':!![],'paymentDetails':_0x544107[_0x4f6c37(0x198)],'amount':_0x544107[_0x4f6c37(0x121)],'currency':_0x544107['currency'],'shopId':_0x336f23['shopId'],'checkTimestamp':new Date()[_0x4f6c37(0x120)]()});}catch(_0x488097){console[_0x4f6c37(0x165)](_0x4f6c37(0x1ac)+_0x336f23['id']+':',_0x488097),this[_0x4f6c37(0x178)](_0x336f23['id'],_0x336f23[_0x4f6c37(0x1cf)],_0x488097,_0x4f6c37(0x169),{'paymentAmount':_0x336f23[_0x4f6c37(0x121)],'paymentCurrency':_0x336f23[_0x4f6c37(0x16b)],'shopId':_0x336f23[_0x4f6c37(0x233)],'createdAt':_0x336f23[_0x4f6c37(0x1fd)]}),await database_1[_0x4f6c37(0x216)][_0x4f6c37(0x162)][_0x4f6c37(0x1bd)]({'data':{'paymentId':_0x336f23['id'],'shopId':_0x336f23['shopId'],'event':_0x4f6c37(0x12f),'statusCode':0x1f4,'responseBody':JSON[_0x4f6c37(0x214)]({'error':_0x488097 instanceof Error?_0x488097[_0x4f6c37(0x202)]:_0x4f6c37(0x1d4),'gatewayPaymentId':_0x336f23[_0x4f6c37(0x1cf)],'checkedAt':new Date()[_0x4f6c37(0x120)]()})}});}}async[a37_0x4f79fd(0x12d)](_0x5c4c55,_0x494582){const _0x5ae549=a37_0x4f79fd,_0x36df61=Date['now']();try{const _0x523c36=_0x5c4c55[_0x5ae549(0x1e3)],_0x169ff0=_0x523c36[_0x5ae549(0x229)];if(!_0x169ff0?.[_0x5ae549(0x1de)]){console[_0x5ae549(0x124)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x523c36['id']);return;}const _0x578f7f=_0x494582==='PAID'?_0x5ae549(0x1f4):_0x494582==='FAILED'?_0x5ae549(0x209):_0x494582===_0x5ae549(0x1b0)?_0x5ae549(0x209):'payment.pending';if(!_0x169ff0[_0x5ae549(0x1a9)]?.['includes'](_0x578f7f)){console[_0x5ae549(0x124)]('Webhook\x20event\x20'+_0x578f7f+_0x5ae549(0x1ed)+_0x523c36['id']);return;}const _0x512951=(0x0,gateway_1[_0x5ae549(0x142)])(_0x5c4c55['gateway'])||_0x5c4c55['gateway'],_0x2335ee={'event':_0x578f7f,'payment':{'id':_0x5c4c55['id'],'order_id':_0x5c4c55[_0x5ae549(0x215)],'gateway_order_id':_0x5c4c55['gatewayOrderId'],'gateway':_0x512951,'amount':_0x5c4c55[_0x5ae549(0x121)],'currency':_0x5c4c55['currency'],'status':_0x494582[_0x5ae549(0x15d)](),'customer_email':_0x5c4c55[_0x5ae549(0x147)],'customer_name':_0x5c4c55[_0x5ae549(0x14e)],'created_at':_0x5c4c55[_0x5ae549(0x1fd)],'updated_at':new Date()}},_0x490e70=await fetch(_0x169ff0[_0x5ae549(0x1de)],{'method':'POST','headers':{'Content-Type':_0x5ae549(0x13c),'User-Agent':_0x5ae549(0x1e8)},'body':JSON['stringify'](_0x2335ee)}),_0x504217=Date[_0x5ae549(0x1e2)]()-_0x36df61,_0x319f32=_0x490e70['ok']?_0x5ae549(0x18a):await _0x490e70[_0x5ae549(0x16e)]();loggerService_1['loggerService']['logShopWebhookSent'](_0x5c4c55[_0x5ae549(0x233)],_0x169ff0[_0x5ae549(0x1de)],_0x578f7f,_0x490e70[_0x5ae549(0x1e1)],_0x504217,_0x2335ee),console[_0x5ae549(0x124)](_0x5ae549(0x1c4)+_0x169ff0[_0x5ae549(0x1de)]+_0x5ae549(0x20b)+_0x490e70['status']+'\x20('+_0x504217+_0x5ae549(0x14a));}catch(_0x3543bc){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x3543bc),loggerService_1[_0x5ae549(0x134)][_0x5ae549(0x1f0)](_0x5c4c55['shopId'],_0x5c4c55[_0x5ae549(0x1e3)]?.[_0x5ae549(0x229)]?.[_0x5ae549(0x1de)]||_0x5ae549(0x1d1),_0x5ae549(0x21a),_0x3543bc,{});}}async['sendPaymentStatusNotification'](_0x429966,_0x36acc5){const _0x4732b5=a37_0x4f79fd;try{const _0x227a62={'PENDING':_0x4732b5(0x1c9),'PAID':_0x4732b5(0x17b),'FAILED':_0x4732b5(0x236),'EXPIRED':_0x4732b5(0x1d2)},_0xd83bb5=_0x227a62[_0x36acc5];if(!_0xd83bb5||_0xd83bb5===_0x4732b5(0x1c9))return;await telegramBotService_1[_0x4732b5(0x230)][_0x4732b5(0x1b1)](_0x429966['shopId'],_0x429966,_0xd83bb5);}catch(_0x501648){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x501648);}}async[a37_0x4f79fd(0x1e9)](_0x2f3d31){const _0x18b75e=a37_0x4f79fd;console[_0x18b75e(0x124)](_0x18b75e(0x1c1)+_0x2f3d31);const _0x49c646=await database_1[_0x18b75e(0x216)]['payment'][_0x18b75e(0x1b5)]({'where':{'id':_0x2f3d31},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x49c646)throw new Error('Payment\x20not\x20found');if(_0x49c646['gateway']!=='cointopay'&&_0x49c646['gateway']!==_0x18b75e(0x1d6))throw new Error(_0x18b75e(0x1c3));console[_0x18b75e(0x124)](_0x18b75e(0x1ae)+_0x49c646[_0x18b75e(0x1e0)]+_0x18b75e(0x22a)+_0x2f3d31),await this[_0x18b75e(0x217)](_0x49c646),console[_0x18b75e(0x124)]('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x2f3d31);}['getServiceStats'](){const _0x468a44=a37_0x4f79fd,_0x5bfdec=this[_0x468a44(0x148)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x4d7d1b=Array[_0x468a44(0x203)](this[_0x468a44(0x1ff)][_0x468a44(0x220)]())[_0x468a44(0x21f)](_0x422fd0=>({'paymentId':_0x422fd0[_0x468a44(0x13f)],'gatewayPaymentId':_0x422fd0['gatewayPaymentId'],'createdAt':_0x422fd0['createdAt'],'timersCount':_0x422fd0[_0x468a44(0x207)][_0x468a44(0x19f)]}));return{'isActive':!!this[_0x468a44(0x148)],'globalCheckIntervalMinutes':this[_0x468a44(0x137)]/(0x3e8*0x3c),'expiryDays':this[_0x468a44(0x187)],'activeIndividualTimers':this[_0x468a44(0x1ff)][_0x468a44(0x22e)],'nextGlobalCheckIn':_0x5bfdec,'paymentTimersDetails':_0x4d7d1b};}[a37_0x4f79fd(0x1bc)](_0x2e9f23){const _0x1e497d=a37_0x4f79fd,_0x47d5af=this['paymentTimers']['get'](_0x2e9f23);if(_0x47d5af)return{'hasTimers':!![],'timersCount':_0x47d5af[_0x1e497d(0x207)][_0x1e497d(0x19f)],'createdAt':_0x47d5af[_0x1e497d(0x1fd)],'gatewayPaymentId':_0x47d5af[_0x1e497d(0x1cf)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0xe7021d,_0x13761a){const _0x1385ba=a37_0x4f79fd;try{const _0x59b02d=await database_1['default'][_0x1385ba(0x1e3)][_0x1385ba(0x1b5)]({'where':{'id':_0xe7021d},'select':{'gatewaySettings':!![]}});if(!_0x59b02d?.[_0x1385ba(0x172)])return console[_0x1385ba(0x124)](_0x1385ba(0x12a)+_0xe7021d+_0x1385ba(0x14c)),0xa;const _0xd887e4=JSON['parse'](_0x59b02d['gatewaySettings']);for(const [_0x1e3c1f,_0x4a9e95]of Object[_0x1385ba(0x15f)](_0xd887e4)){if(_0x1e3c1f[_0x1385ba(0x15d)]()===_0x13761a['toLowerCase']()){const _0x409923=_0x4a9e95[_0x1385ba(0x1a8)]||0xa;return console[_0x1385ba(0x124)](_0x1385ba(0x21c)+_0x13761a+'\x20commission\x20for\x20shop\x20'+_0xe7021d+':\x20'+_0x409923+'%'),_0x409923;}}return console[_0x1385ba(0x124)](_0x1385ba(0x219)+_0x13761a+_0x1385ba(0x1df)+_0xe7021d+_0x1385ba(0x1e5)),0xa;}catch(_0x2c68a5){return console[_0x1385ba(0x165)](_0x1385ba(0x194)+_0xe7021d+_0x1385ba(0x1cb)+_0x13761a+':',_0x2c68a5),0xa;}}}function a37_0x1cf0(_0x4b1218,_0x1c73c7){const _0x2cd760=a37_0x2cd7();return a37_0x1cf0=function(_0x1cf0f9,_0x45614a){_0x1cf0f9=_0x1cf0f9-0x11e;let _0x3e1b55=_0x2cd760[_0x1cf0f9];return _0x3e1b55;},a37_0x1cf0(_0x4b1218,_0x1c73c7);}exports['CoinToPayStatusService']=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();