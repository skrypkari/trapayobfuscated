'use strict';const a37_0x31a7de=a37_0x34fe;function a37_0x5ee2(){const _0x1f58b9=['PAID','paymentTimers','length','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','\x20checked,\x20','\x20status\x20unchanged\x20(','schedulePaymentChecks','CoinToPayStatusService','\x20in\x20','payment.pending','\x20commission\x20for\x20shop\x20','CoinToPay2Service','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','./gateways/coinToPayService','\x20status:\x20','default','\x20completed\x20for\x20payment\x20','cointopay_status_check_','getTime','\x20is\x20too\x20new\x20(','findUnique','\x20expired\x20CoinToPay\x20payments','2962056TYLCUW','\x20updated:\x20currentPayments=','../config/database','../types/gateway','\x20\x20\x20-\x20Gateway:\x20','h),\x20skipping\x20global\x20check','üìä\x20[CHECK]\x20Payment\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','‚ùå\x20[CHECK]\x20Payment\x20','has','./loggerService','description','values','\x20not\x20found\x20in\x20database','cointopay_status_check_error','\x20seconds\x20(','\x20is\x20older\x20than\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','gatewayPaymentId','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','65HGrgrk','log','forEach','gateway','COMPLETED','\x20\x20\x20üìÖ\x20Time:\x20','webhookLog','checkExpiredPayments','\x20payment\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','\x20in\x20shop\x20','\x20\x20\x20-\x20Status:\x20','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','paymentDetails','entries','status','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2',':\x20type=','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','transactionId','type','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','status_check',',\x20gateway\x20','PENDING','customerEmail','sendShopWebhook','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20(age:\x20','unknown','\x20(after\x20','checkSinglePayment','üí∞\x20[CHECK]\x20Payment\x20','93606icZWAV','iban','Webhook\x20event\x20','startPeriodicStatusCheck','coinToPayStatusService','shopId','logShopWebhookError','logWhiteDomainError','__importDefault','\x20commission:\x20','Automatically\x20expired\x20after\x20','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','119TrSjOt','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20triggered\x20for\x20payment\x20','catch','\x20\x20\x20-\x20gatewayPaymentId:\x20','update','\x20\x20\x20Amount:\x20','\x20days\x20without\x20payment\x20confirmation','includes','‚è∞\x20[GLOBAL]\x20Payment\x20','paymentLink','\x20marked\x20as\x20paid\x20at:\x20','parse','paymentId','\x20to\x20','\x20to\x20clear','globalCheckInterval','setDate','size','‚ùå\x20[HOURLY]\x20Payment\x20','schedule_created','currency','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20not\x20enabled\x20for\x20shop\x20',',\x20currentPayments=','currencyService','sendPaymentStatusNotification','set','\x20initial\x20timers\x20for\x20payment\x20','TesSoft\x20Payment\x20System/1.0','\x20USDT','__esModule','settings','\x20status\x20is\x20','now','.\x20Remaining\x20active\x20timers:\x20','clearPaymentTimers','telegramBotService','gatewayOrderId','‚è∞\x20[HOURLY]\x20Payment\x20','toFixed','‚úÖ\x20[CHECK]\x20Payment\x20','text','EXPIRY_DAYS','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','not\x20confirmed','\x20\x20\x20Gateway\x20','stack','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','checkAllPendingPayments','72QBjnSd','timers','FAILED','\x20->\x20','cointopay_auto_expired','toLowerCase',',\x20status=','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','push','paid','stringify','\x20found:','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','üßπ\x20[DEBUG]\x20Clearing\x20','5\x20minutes','error','delay','1673259nxlLOq','getPaymentTimerInfo','Gateway\x20','payment','\x20status\x20from\x20','coinToPay2Service',',\x20stopping\x20individual\x20checks','loggerService','cointopay','shop','message','application/json','Shop\x20webhook\x20sent\x20to\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','confirmedOn','webhookEvents','checkSinglePaymentById','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20\x20\x20-\x20ShopId:\x20','\x20\x20\x20Amount\x20after\x20commission:\x20','getServiceStats','56145ApBgLc','\x20\x20\x20üìù\x20Context:','toISOString','EXPIRED','get','amountUSDT','floor','logCoinToPayError','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','268497ouJKCJ','createdAt','\x20for\x20payment\x20','\x20updated\x20successfully','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20\x20\x20-\x20paymentId:\x20','cointopay2','gatewaySettings','logCoinToPayStatus','COINTOPAY_STATUS_CHANGE','\x20\x20\x20-\x20GatewayPaymentId:\x20','webhookUrl','failed','./currencyService','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','121IBUJyM','Failed\x20to\x20send\x20shop\x20webhook:','amount','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20amounts\x20calculated:','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','Payment\x20older\x20than\x20','bankDetails','coinToPayService','remitterIban','create','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','paidAt','getDate','SINGLE','Payment\x20not\x20found','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','orderId','./telegramBotService','\x20status\x20changed\x20to\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','COINTOPAY_ERROR','POST','/status/','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','not\x20found','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20with\x20status\x20','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','üõë\x20[SHUTDOWN]\x20Cleared\x20','getGatewayIdByName','\x20\x20\x20-\x20Amount:\x20','1077010wLbjFQ','CoinToPayService','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20\x20\x20üìç\x20Source:\x20','578609NKlxVM','sendPaymentNotification','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','commission','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20details:','4OVBmlc','adminNotes','Bank\x20Details:\x20','GLOBAL_CHECK_INTERVAL_MS','üßπ\x20[CHECK]\x20Payment\x20','currentPayments','created','\x20not\x20found,\x20clearing\x20timers','‚úÖ\x20[EXPIRY]\x20Payment\x20','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','payment.failed','logShopWebhookSent','findMany','8xUmSOD','Failed\x20to\x20mark\x20payment\x20as\x20expired','defineProperty','\x20is\x20valid\x20for\x20checking,\x20proceeding...','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20\x20\x20‚ùå\x20Error:\x20','\x20days','getGatewayCommission','stopPeriodicStatusCheck','payment.success','\x20\x20\x20üìù\x20Details:','convertToUSDT','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','from'];a37_0x5ee2=function(){return _0x1f58b9;};return a37_0x5ee2();}(function(_0x23ac62,_0x2bc6db){const _0x4ef5ca=a37_0x34fe,_0x347997=_0x23ac62();while(!![]){try{const _0x4fc471=-parseInt(_0x4ef5ca(0x2b4))/0x1*(-parseInt(_0x4ef5ca(0x2bb))/0x2)+-parseInt(_0x4ef5ca(0x261))/0x3+parseInt(_0x4ef5ca(0x250))/0x4*(-parseInt(_0x4ef5ca(0x277))/0x5)+parseInt(_0x4ef5ca(0x20f))/0x6*(parseInt(_0x4ef5ca(0x21d))/0x7)+parseInt(_0x4ef5ca(0x2c8))/0x8*(parseInt(_0x4ef5ca(0x280))/0x9)+-parseInt(_0x4ef5ca(0x2af))/0xa*(-parseInt(_0x4ef5ca(0x28f))/0xb)+parseInt(_0x4ef5ca(0x1d9))/0xc*(-parseInt(_0x4ef5ca(0x1ed))/0xd);if(_0x4fc471===_0x2bc6db)break;else _0x347997['push'](_0x347997['shift']());}catch(_0x512f72){_0x347997['push'](_0x347997['shift']());}}}(a37_0x5ee2,0x9cf62));var __importDefault=this&&this[a37_0x31a7de(0x217)]||function(_0x676059){const _0x374214=a37_0x31a7de;return _0x676059&&_0x676059[_0x374214(0x23c)]?_0x676059:{'default':_0x676059};};Object[a37_0x31a7de(0x2ca)](exports,'__esModule',{'value':!![]}),exports[a37_0x31a7de(0x213)]=exports[a37_0x31a7de(0x1ca)]=void 0x0;const coinToPayService_1=require(a37_0x31a7de(0x1d0)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require(a37_0x31a7de(0x1dc)),database_1=__importDefault(require(a37_0x31a7de(0x1db))),telegramBotService_1=require(a37_0x31a7de(0x2a1)),loggerService_1=require(a37_0x31a7de(0x1e3)),currencyService_1=require(a37_0x31a7de(0x28d));class CoinToPayStatusService{constructor(){const _0x9a6915=a37_0x31a7de;this[_0x9a6915(0x22d)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x9a6915(0x248)]=0x5,this['paymentTimers']=new Map(),this[_0x9a6915(0x297)]=new coinToPayService_1[(_0x9a6915(0x2b0))](),this['coinToPay2Service']=new coinToPay2Service_1[(_0x9a6915(0x1ce))](),console[_0x9a6915(0x1ee)](_0x9a6915(0x1fe));}[a37_0x31a7de(0x1c9)](_0x103b31,_0x5eb5a3){const _0x25bace=a37_0x31a7de;console[_0x25bace(0x1ee)](_0x25bace(0x21c)),console[_0x25bace(0x1ee)](_0x25bace(0x285)+_0x103b31),console[_0x25bace(0x1ee)](_0x25bace(0x221)+_0x5eb5a3),this['clearPaymentTimers'](_0x103b31);const _0x447fe1=[],_0x11929f=new Date(),_0x2c444c=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x25bace(0x25e)},{'delay':0x5*0x3c*0x3e8,'description':_0x25bace(0x25e)}];console['log']('ü™ô\x20[DEBUG]\x20Creating\x20'+_0x2c444c[_0x25bace(0x2d8)]+_0x25bace(0x239)+_0x103b31);let _0x33dbb7=0x0;_0x2c444c[_0x25bace(0x1ef)]((_0x11cac7,_0x19b038)=>{const _0x8ba9f9=_0x25bace;_0x33dbb7+=_0x11cac7[_0x8ba9f9(0x260)];const _0x4a312d=setTimeout(async()=>{const _0x16ffe8=_0x8ba9f9;console[_0x16ffe8(0x1ee)]('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x19b038+0x1)+_0x16ffe8(0x21f)+_0x103b31+_0x16ffe8(0x20c)+_0x11cac7[_0x16ffe8(0x1e4)]+')');try{await this[_0x16ffe8(0x272)](_0x103b31),console[_0x16ffe8(0x1ee)](_0x16ffe8(0x294)+(_0x19b038+0x1)+_0x16ffe8(0x1d3)+_0x103b31);}catch(_0x548568){console[_0x16ffe8(0x25f)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x19b038+0x1)+_0x16ffe8(0x282)+_0x103b31+':',_0x548568),this[_0x16ffe8(0x27e)](_0x103b31,_0x5eb5a3,_0x548568,'status_check',{'checkNumber':_0x19b038+0x1,'scheduledAfter':_0x11cac7[_0x16ffe8(0x1e4)],'isIndividualCheck':!![]});}},_0x33dbb7);_0x447fe1[_0x8ba9f9(0x258)](_0x4a312d),console[_0x8ba9f9(0x1ee)](_0x8ba9f9(0x29a)+(_0x19b038+0x1)+_0x8ba9f9(0x282)+_0x103b31+_0x8ba9f9(0x1cb)+_0x33dbb7/0x3e8+_0x8ba9f9(0x1e8)+_0x11cac7[_0x8ba9f9(0x1e4)]+')');});const _0x2b54ae=setInterval(async()=>{const _0x2c0f9d=_0x25bace;console[_0x2c0f9d(0x1ee)](_0x2c0f9d(0x2d4)+_0x103b31);try{const _0xdcb96e=await database_1[_0x2c0f9d(0x1d2)]['payment'][_0x2c0f9d(0x1d7)]({'where':{'id':_0x103b31},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0xdcb96e){console[_0x2c0f9d(0x1ee)](_0x2c0f9d(0x230)+_0x103b31+_0x2c0f9d(0x2c2)),this[_0x2c0f9d(0x241)](_0x103b31);return;}console[_0x2c0f9d(0x1ee)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x103b31+'\x20current\x20status:\x20'+_0xdcb96e['status']);if(_0xdcb96e['status']!==_0x2c0f9d(0x206)){console[_0x2c0f9d(0x1ee)]('‚úÖ\x20[HOURLY]\x20Payment\x20'+_0x103b31+_0x2c0f9d(0x23e)+_0xdcb96e[_0x2c0f9d(0x1fd)]+_0x2c0f9d(0x267)),this[_0x2c0f9d(0x241)](_0x103b31);return;}const _0x2c188c=Math['floor']((Date[_0x2c0f9d(0x23f)]()-_0xdcb96e[_0x2c0f9d(0x281)][_0x2c0f9d(0x1d5)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x2c188c>=this[_0x2c0f9d(0x248)]){console[_0x2c0f9d(0x1ee)](_0x2c0f9d(0x244)+_0x103b31+_0x2c0f9d(0x1e9)+this[_0x2c0f9d(0x248)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x2c0f9d(0x241)](_0x103b31);return;}await this[_0x2c0f9d(0x272)](_0x103b31),console[_0x2c0f9d(0x1ee)]('‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x103b31);}catch(_0x212e64){console['error'](_0x2c0f9d(0x2cc)+_0x103b31+':',_0x212e64),this[_0x2c0f9d(0x27e)](_0x103b31,_0x5eb5a3,_0x212e64,_0x2c0f9d(0x204),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x447fe1[_0x25bace(0x258)](_0x2b54ae),this[_0x25bace(0x2d7)][_0x25bace(0x238)](_0x103b31,{'timers':_0x447fe1,'paymentId':_0x103b31,'gatewayPaymentId':_0x5eb5a3,'createdAt':_0x11929f}),console[_0x25bace(0x1ee)](_0x25bace(0x2b2)+_0x2c444c[_0x25bace(0x2d8)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x103b31),console[_0x25bace(0x1ee)](_0x25bace(0x2b9)+this[_0x25bace(0x2d7)][_0x25bace(0x22f)]),this[_0x25bace(0x288)](_0x103b31,_0x5eb5a3,_0x25bace(0x206),'PENDING','status_check',{'action':_0x25bace(0x231),'scheduledChecks':_0x2c444c[_0x25bace(0x2d8)],'firstCheckIn':_0x2c444c[0x0][_0x25bace(0x260)]/0x3e8,'totalTimers':this[_0x25bace(0x2d7)][_0x25bace(0x22f)]});}[a37_0x31a7de(0x241)](_0x3b90a4){const _0x419424=a37_0x31a7de,_0x3d82b4=this['paymentTimers']['get'](_0x3b90a4);_0x3d82b4?(console[_0x419424(0x1ee)](_0x419424(0x25d)+_0x3d82b4[_0x419424(0x251)][_0x419424(0x2d8)]+'\x20timers\x20for\x20payment\x20'+_0x3b90a4),_0x3d82b4[_0x419424(0x251)]['forEach']((_0x647471,_0xdf643a)=>{const _0x2af497=_0x419424;_0x647471&&(clearTimeout(_0x647471),clearInterval(_0x647471),console[_0x2af497(0x1ee)](_0x2af497(0x24a)+(_0xdf643a+0x1)+_0x2af497(0x282)+_0x3b90a4));}),this['paymentTimers']['delete'](_0x3b90a4),console['log'](_0x419424(0x284)+_0x3b90a4+_0x419424(0x240)+this[_0x419424(0x2d7)][_0x419424(0x22f)])):console[_0x419424(0x1ee)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x3b90a4+_0x419424(0x22c));}async['checkSinglePaymentById'](_0x133dda){const _0xa05dcd=a37_0x31a7de;console['log'](_0xa05dcd(0x1fa)+_0x133dda);const _0x2a02e9=await database_1['default'][_0xa05dcd(0x264)]['findUnique']({'where':{'id':_0x133dda},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2a02e9){console['log'](_0xa05dcd(0x1e1)+_0x133dda+_0xa05dcd(0x1e6));return;}console[_0xa05dcd(0x1ee)](_0xa05dcd(0x1df)+_0x133dda+_0xa05dcd(0x25b)),console[_0xa05dcd(0x1ee)](_0xa05dcd(0x1dd)+_0x2a02e9[_0xa05dcd(0x1f0)]),console['log'](_0xa05dcd(0x1f9)+_0x2a02e9[_0xa05dcd(0x1fd)]),console[_0xa05dcd(0x1ee)](_0xa05dcd(0x28a)+_0x2a02e9[_0xa05dcd(0x1eb)]),console[_0xa05dcd(0x1ee)](_0xa05dcd(0x2ae)+_0x2a02e9['amount']+'\x20'+_0x2a02e9['currency']),console[_0xa05dcd(0x1ee)](_0xa05dcd(0x274)+_0x2a02e9[_0xa05dcd(0x214)]);if(_0x2a02e9[_0xa05dcd(0x1f0)]!==_0xa05dcd(0x269)&&_0x2a02e9[_0xa05dcd(0x1f0)]!==_0xa05dcd(0x286)){console[_0xa05dcd(0x1ee)](_0xa05dcd(0x2a7)+_0x133dda+_0xa05dcd(0x2d9)+_0x2a02e9[_0xa05dcd(0x1f0)]+')');return;}if(_0x2a02e9[_0xa05dcd(0x1fd)]!==_0xa05dcd(0x206)){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x133dda+_0xa05dcd(0x23e)+_0x2a02e9[_0xa05dcd(0x1fd)]+_0xa05dcd(0x267)),this[_0xa05dcd(0x241)](_0x133dda);return;}if(!_0x2a02e9[_0xa05dcd(0x1eb)]){console[_0xa05dcd(0x1ee)](_0xa05dcd(0x2a7)+_0x133dda+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0xa05dcd(0x1ee)](_0xa05dcd(0x246)+_0x133dda+_0xa05dcd(0x2cb)),await this[_0xa05dcd(0x20d)](_0x2a02e9);}[a37_0x31a7de(0x288)](_0xd0535c,_0x1b107e,_0x1febe5,_0xee8a91,_0x3431ef,_0x50928c){const _0x109566=a37_0x31a7de,_0x55be4b={'type':_0x109566(0x289),'paymentId':_0xd0535c,'gatewayPaymentId':_0x1b107e,'oldStatus':_0x1febe5,'newStatus':_0xee8a91,'source':_0x3431ef,'timestamp':new Date()[_0x109566(0x279)](),'details':_0x50928c||{}};loggerService_1[_0x109566(0x268)][_0x109566(0x288)](_0x55be4b),console[_0x109566(0x1ee)](_0x109566(0x25c)+_0xd0535c+'\x20('+_0x1b107e+')'),console[_0x109566(0x1ee)]('\x20\x20\x20üìä\x20Status:\x20'+_0x1febe5+_0x109566(0x253)+_0xee8a91),console[_0x109566(0x1ee)]('\x20\x20\x20üìç\x20Source:\x20'+_0x3431ef),console[_0x109566(0x1ee)](_0x109566(0x1f2)+_0x55be4b['timestamp']),_0x50928c&&console[_0x109566(0x1ee)](_0x109566(0x2d2),_0x50928c);}[a37_0x31a7de(0x27e)](_0x396433,_0x5b3445,_0x3fd4b0,_0x8a3f57,_0x375f58){const _0x45ba44=a37_0x31a7de,_0x28d089={'type':_0x45ba44(0x2a4),'paymentId':_0x396433,'gatewayPaymentId':_0x5b3445,'error':_0x3fd4b0 instanceof Error?{'message':_0x3fd4b0[_0x45ba44(0x26b)],'stack':_0x3fd4b0[_0x45ba44(0x24d)]}:_0x3fd4b0,'source':_0x8a3f57,'timestamp':new Date()[_0x45ba44(0x279)](),'context':_0x375f58||{}};loggerService_1[_0x45ba44(0x268)]['logCoinToPayError'](_0x28d089),console[_0x45ba44(0x25f)]('ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x396433+'\x20('+_0x5b3445+')'),console[_0x45ba44(0x25f)](_0x45ba44(0x2cd)+(_0x3fd4b0 instanceof Error?_0x3fd4b0[_0x45ba44(0x26b)]:_0x3fd4b0)),console[_0x45ba44(0x25f)](_0x45ba44(0x2b3)+_0x8a3f57),console[_0x45ba44(0x25f)](_0x45ba44(0x1f2)+_0x28d089['timestamp']),_0x375f58&&console['error'](_0x45ba44(0x278),_0x375f58);}[a37_0x31a7de(0x212)](){const _0x14693f=a37_0x31a7de;console[_0x14693f(0x1ee)](_0x14693f(0x257)),this[_0x14693f(0x24f)]()[_0x14693f(0x220)](_0x25de5f=>{const _0x543fe5=_0x14693f;console[_0x543fe5(0x25f)](_0x543fe5(0x21a),_0x25de5f);}),this[_0x14693f(0x22d)]=setInterval(async()=>{const _0xd5ea5=_0x14693f;try{console['log']('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0xd5ea5(0x24f)](),console['log']('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x40c790){console['error']('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x40c790);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x14693f(0x1ee)](_0x14693f(0x21b));}[a37_0x31a7de(0x2d0)](){const _0x1d37c0=a37_0x31a7de;console['log']('üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x1d37c0(0x22d)]&&(clearInterval(this[_0x1d37c0(0x22d)]),this[_0x1d37c0(0x22d)]=null,console[_0x1d37c0(0x1ee)](_0x1d37c0(0x26e)));const _0x98a301=this[_0x1d37c0(0x2d7)]['size'];for(const [_0x4c68b2]of this[_0x1d37c0(0x2d7)]){this[_0x1d37c0(0x241)](_0x4c68b2);}console[_0x1d37c0(0x1ee)](_0x1d37c0(0x2ac)+_0x98a301+'\x20individual\x20payment\x20timers');}async[a37_0x31a7de(0x24f)](){const _0x37f180=a37_0x31a7de;try{console[_0x37f180(0x1ee)](_0x37f180(0x2a9));const _0x5bfacf=await database_1[_0x37f180(0x1d2)][_0x37f180(0x264)][_0x37f180(0x2c7)]({'where':{'gateway':{'in':[_0x37f180(0x269),_0x37f180(0x286)]},'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log']('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x5bfacf[_0x37f180(0x2d8)]+'\x20pending\x20CoinToPay\x20payments');if(_0x5bfacf[_0x37f180(0x2d8)]===0x0){console[_0x37f180(0x1ee)]('ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x3f3e35=await this[_0x37f180(0x1f4)](_0x5bfacf);console['log']('‚è∞\x20[GLOBAL]\x20Found\x20'+_0x3f3e35[_0x37f180(0x2d8)]+_0x37f180(0x1d8));let _0x4f65c7=0x0,_0x23bd56=0x0;for(const _0x46dde0 of _0x5bfacf){try{if(_0x3f3e35[_0x37f180(0x225)](_0x46dde0['id'])){console[_0x37f180(0x1ee)](_0x37f180(0x226)+_0x46dde0['id']+_0x37f180(0x273)),_0x23bd56++;continue;}if(this['paymentTimers'][_0x37f180(0x1e2)](_0x46dde0['id'])){console[_0x37f180(0x1ee)](_0x37f180(0x226)+_0x46dde0['id']+_0x37f180(0x1f6)),_0x23bd56++;continue;}const _0x3aac16=(Date['now']()-_0x46dde0['createdAt'][_0x37f180(0x1d5)]())/(0x3e8*0x3c*0x3c);if(_0x3aac16<0x1){console[_0x37f180(0x1ee)](_0x37f180(0x226)+_0x46dde0['id']+_0x37f180(0x1d6)+_0x3aac16[_0x37f180(0x245)](0x1)+_0x37f180(0x1de)),_0x23bd56++;continue;}console[_0x37f180(0x1ee)]('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x46dde0['id']+_0x37f180(0x20a)+_0x3aac16[_0x37f180(0x245)](0x1)+'h)'),await this[_0x37f180(0x20d)](_0x46dde0),_0x4f65c7++,await new Promise(_0x2cb30c=>setTimeout(_0x2cb30c,0x7d0));}catch(_0x540719){console[_0x37f180(0x25f)](_0x37f180(0x249)+_0x46dde0['id']+':',_0x540719),this[_0x37f180(0x27e)](_0x46dde0['id'],_0x46dde0[_0x37f180(0x1eb)]||_0x37f180(0x20b),_0x540719,_0x37f180(0x204),{'isGlobalCheck':!![],'paymentAmount':_0x46dde0[_0x37f180(0x291)],'paymentCurrency':_0x46dde0[_0x37f180(0x232)],'shopId':_0x46dde0['shopId'],'createdAt':_0x46dde0[_0x37f180(0x281)]}),loggerService_1[_0x37f180(0x268)][_0x37f180(0x216)](_0x37f180(0x269),_0x37f180(0x2a6)+_0x46dde0[_0x37f180(0x1eb)],_0x540719);}}console[_0x37f180(0x1ee)](_0x37f180(0x233)+_0x4f65c7+_0x37f180(0x1c7)+_0x23bd56+'\x20skipped,\x20'+_0x3f3e35[_0x37f180(0x2d8)]+'\x20expired');}catch(_0x17b34d){console['error']('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x17b34d);}}async[a37_0x31a7de(0x1f4)](_0x1bff7e){const _0x3a3efd=a37_0x31a7de,_0x33a426=[],_0x196994=new Date();_0x196994[_0x3a3efd(0x22e)](_0x196994[_0x3a3efd(0x29c)]()-this[_0x3a3efd(0x248)]),console[_0x3a3efd(0x1ee)](_0x3a3efd(0x2b6)+this[_0x3a3efd(0x248)]+'\x20days\x20(created\x20before\x20'+_0x196994[_0x3a3efd(0x279)]()+')');for(const _0x2b87a8 of _0x1bff7e){if(_0x2b87a8[_0x3a3efd(0x281)]<_0x196994){console['log'](_0x3a3efd(0x1e0)+_0x2b87a8['id']+_0x3a3efd(0x1e9)+this[_0x3a3efd(0x248)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x3a3efd(0x288)](_0x2b87a8['id'],_0x2b87a8[_0x3a3efd(0x1eb)]||_0x3a3efd(0x20b),_0x3a3efd(0x206),_0x3a3efd(0x27a),'auto_expire',{'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x2b87a8['createdAt'],'daysSinceCreation':Math[_0x3a3efd(0x27d)]((Date['now']()-_0x2b87a8[_0x3a3efd(0x281)][_0x3a3efd(0x1d5)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x2b87a8[_0x3a3efd(0x291)],'paymentCurrency':_0x2b87a8[_0x3a3efd(0x232)],'shopId':_0x2b87a8['shopId']}),await database_1[_0x3a3efd(0x1d2)][_0x3a3efd(0x264)]['update']({'where':{'id':_0x2b87a8['id']},'data':{'status':_0x3a3efd(0x27a),'updatedAt':new Date(),'adminNotes':_0x3a3efd(0x219)+this['EXPIRY_DAYS']+_0x3a3efd(0x224)}}),await database_1['default']['webhookLog'][_0x3a3efd(0x299)]({'data':{'paymentId':_0x2b87a8['id'],'shopId':_0x2b87a8['shopId'],'event':_0x3a3efd(0x254),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x3a3efd(0x295)+this[_0x3a3efd(0x248)]+_0x3a3efd(0x2ce),'createdAt':_0x2b87a8[_0x3a3efd(0x281)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math['floor']((Date[_0x3a3efd(0x23f)]()-_0x2b87a8[_0x3a3efd(0x281)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x3a3efd(0x208)](_0x2b87a8,_0x3a3efd(0x27a)),await this[_0x3a3efd(0x237)](_0x2b87a8,_0x3a3efd(0x27a)),this[_0x3a3efd(0x241)](_0x2b87a8['id']),_0x33a426[_0x3a3efd(0x258)](_0x2b87a8['id']),console[_0x3a3efd(0x1ee)](_0x3a3efd(0x2c3)+_0x2b87a8['id']+_0x3a3efd(0x21e)+this[_0x3a3efd(0x248)]+'-day\x20timeout');}catch(_0x1d1cb5){console[_0x3a3efd(0x25f)](_0x3a3efd(0x1cf)+_0x2b87a8['id']+':',_0x1d1cb5),this[_0x3a3efd(0x27e)](_0x2b87a8['id'],_0x2b87a8[_0x3a3efd(0x1eb)]||_0x3a3efd(0x20b),_0x1d1cb5,'auto_expire',{'reason':_0x3a3efd(0x2c9),'createdAt':_0x2b87a8['createdAt'],'daysSinceCreation':Math[_0x3a3efd(0x27d)]((Date['now']()-_0x2b87a8['createdAt'][_0x3a3efd(0x1d5)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x33a426;}async[a37_0x31a7de(0x20d)](_0x26ba32){const _0x4c3977=a37_0x31a7de;if(!_0x26ba32['gatewayPaymentId']){console[_0x4c3977(0x1ee)](_0x4c3977(0x2a7)+_0x26ba32['id']+_0x4c3977(0x2b7));return;}console[_0x4c3977(0x1ee)]('üîç\x20[CHECK]\x20Checking\x20'+_0x26ba32[_0x4c3977(0x1f0)]+'\x20payment\x20'+_0x26ba32['id']+'\x20('+_0x26ba32[_0x4c3977(0x1eb)]+')');try{let _0x4cd47b;_0x26ba32[_0x4c3977(0x1f0)]===_0x4c3977(0x286)?(_0x4cd47b=await this[_0x4c3977(0x266)]['checkPaymentStatus'](_0x26ba32[_0x4c3977(0x1eb)]),console[_0x4c3977(0x1ee)](_0x4c3977(0x2c4)+_0x26ba32['id']+_0x4c3977(0x1d1)+_0x4cd47b[_0x4c3977(0x1fd)])):(_0x4cd47b=await this[_0x4c3977(0x297)]['checkPaymentStatus'](_0x26ba32['gatewayPaymentId']),console[_0x4c3977(0x1ee)]('üìä\x20[CHECK]\x20CoinToPay\x20payment\x20'+_0x26ba32['id']+_0x4c3977(0x1d1)+_0x4cd47b[_0x4c3977(0x1fd)]));_0x4cd47b[_0x4c3977(0x1fb)]&&console['log'](_0x4c3977(0x1df)+_0x26ba32['id']+_0x4c3977(0x2ba),{'iban':_0x4cd47b[_0x4c3977(0x1fb)][_0x4c3977(0x210)]||_0x4c3977(0x2a8),'transactionId':_0x4cd47b['paymentDetails'][_0x4c3977(0x201)],'createdOn':_0x4cd47b[_0x4c3977(0x1fb)]['createdOn'],'confirmedOn':_0x4cd47b['paymentDetails'][_0x4c3977(0x270)]||_0x4c3977(0x24b)});if(_0x4cd47b['status']!==_0x26ba32[_0x4c3977(0x1fd)]){console['log'](_0x4c3977(0x1f7)+_0x26ba32['id']+_0x4c3977(0x265)+_0x26ba32[_0x4c3977(0x1fd)]+_0x4c3977(0x22b)+_0x4cd47b[_0x4c3977(0x1fd)]),this[_0x4c3977(0x288)](_0x26ba32['id'],_0x26ba32[_0x4c3977(0x1eb)],_0x26ba32[_0x4c3977(0x1fd)],_0x4cd47b[_0x4c3977(0x1fd)],_0x4c3977(0x204),{'paymentDetails':_0x4cd47b[_0x4c3977(0x1fb)],'amount':_0x4cd47b[_0x4c3977(0x291)],'currency':_0x4cd47b[_0x4c3977(0x232)],'shopId':_0x26ba32[_0x4c3977(0x214)],'checkTimestamp':new Date()[_0x4c3977(0x279)]()});const _0x4b760e={'status':_0x4cd47b['status'],'updatedAt':new Date()};if(_0x4cd47b[_0x4c3977(0x1fd)]===_0x4c3977(0x2d6)&&_0x26ba32[_0x4c3977(0x1fd)]!==_0x4c3977(0x2d6)){_0x4b760e['paidAt']=new Date();if(!_0x26ba32[_0x4c3977(0x27c)]){const _0x241420=await currencyService_1[_0x4c3977(0x236)][_0x4c3977(0x2d3)](_0x26ba32[_0x4c3977(0x291)],_0x26ba32[_0x4c3977(0x232)]);_0x4b760e[_0x4c3977(0x27c)]=_0x241420;const _0x21f688=await this[_0x4c3977(0x2cf)](_0x26ba32[_0x4c3977(0x214)],_0x26ba32[_0x4c3977(0x1f0)]),_0x54cbaa=_0x241420*(0x1-_0x21f688/0x64);_0x4b760e['amountAfterGatewayCommissionUSDT']=_0x54cbaa,console[_0x4c3977(0x1ee)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x26ba32['id']+_0x4c3977(0x293)),console['log'](_0x4c3977(0x223)+_0x26ba32[_0x4c3977(0x291)]+'\x20'+_0x26ba32['currency']+'\x20->\x20'+_0x241420['toFixed'](0x6)+'\x20USDT'),console['log'](_0x4c3977(0x24c)+_0x26ba32[_0x4c3977(0x1f0)]+_0x4c3977(0x218)+_0x21f688+'%'),console[_0x4c3977(0x1ee)](_0x4c3977(0x275)+_0x54cbaa[_0x4c3977(0x245)](0x6)+_0x4c3977(0x23b));}console[_0x4c3977(0x1ee)](_0x4c3977(0x20e)+_0x26ba32['id']+_0x4c3977(0x228)+_0x4b760e[_0x4c3977(0x29b)][_0x4c3977(0x279)]());}if(_0x4cd47b[_0x4c3977(0x1fb)]){const _0x1e5f63=_0x4cd47b['paymentDetails'];_0x1e5f63['iban']&&(_0x4b760e[_0x4c3977(0x298)]=_0x1e5f63['iban'],console[_0x4c3977(0x1ee)](_0x4c3977(0x1ea)+_0x1e5f63[_0x4c3977(0x210)]));if(_0x1e5f63[_0x4c3977(0x296)]){const _0x337586=_0x26ba32[_0x4c3977(0x2bc)]||'',_0x5287cd=_0x4c3977(0x2bd)+_0x1e5f63[_0x4c3977(0x296)];_0x4b760e['adminNotes']=_0x337586?_0x337586+'\x0a\x0a'+_0x5287cd:_0x5287cd,console[_0x4c3977(0x1ee)](_0x4c3977(0x292));}_0x1e5f63[_0x4c3977(0x201)]&&console['log'](_0x4c3977(0x203)+_0x1e5f63[_0x4c3977(0x201)]),_0x1e5f63['confirmedOn']&&console['log'](_0x4c3977(0x27f)+_0x1e5f63[_0x4c3977(0x270)]);}await database_1[_0x4c3977(0x1d2)][_0x4c3977(0x264)][_0x4c3977(0x222)]({'where':{'id':_0x26ba32['id']},'data':_0x4b760e});if(_0x4cd47b[_0x4c3977(0x1fd)]===_0x4c3977(0x2d6)&&_0x26ba32['status']!=='PAID'){console[_0x4c3977(0x1ee)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x26ba32['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x5e47b8=await database_1[_0x4c3977(0x1d2)][_0x4c3977(0x264)][_0x4c3977(0x1d7)]({'where':{'id':_0x26ba32['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x5e47b8?.['paymentLinkId']&&_0x5e47b8[_0x4c3977(0x227)])try{const _0x55f8eb=_0x5e47b8['paymentLink'];console[_0x4c3977(0x1ee)]('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x55f8eb['id']+_0x4c3977(0x1ff)+_0x55f8eb[_0x4c3977(0x202)]+_0x4c3977(0x235)+_0x55f8eb[_0x4c3977(0x2c0)]+_0x4c3977(0x256)+_0x55f8eb[_0x4c3977(0x1fd)]);const _0x52a3b5=_0x55f8eb[_0x4c3977(0x2c0)]+0x1,_0x999396=_0x55f8eb[_0x4c3977(0x202)]===_0x4c3977(0x29d)?_0x4c3977(0x1f1):_0x55f8eb[_0x4c3977(0x1fd)];await database_1['default']['paymentLink'][_0x4c3977(0x222)]({'where':{'id':_0x55f8eb['id']},'data':{'currentPayments':_0x52a3b5,'status':_0x999396,'updatedAt':new Date()}}),console[_0x4c3977(0x1ee)](_0x4c3977(0x24e)+_0x55f8eb['id']+_0x4c3977(0x1da)+_0x55f8eb['currentPayments']+_0x4c3977(0x253)+_0x52a3b5+_0x4c3977(0x256)+_0x55f8eb['status']+_0x4c3977(0x253)+_0x999396);}catch(_0x250821){console[_0x4c3977(0x25f)](_0x4c3977(0x1ec),_0x250821);}else console[_0x4c3977(0x1ee)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x26ba32['id']+_0x4c3977(0x2b1));}await database_1[_0x4c3977(0x1d2)][_0x4c3977(0x1f3)]['create']({'data':{'paymentId':_0x26ba32['id'],'shopId':_0x26ba32[_0x4c3977(0x214)],'event':_0x4c3977(0x1d4)+_0x4cd47b[_0x4c3977(0x1fd)][_0x4c3977(0x255)](),'statusCode':0xc8,'responseBody':JSON[_0x4c3977(0x25a)]({'oldStatus':_0x26ba32['status'],'newStatus':_0x4cd47b[_0x4c3977(0x1fd)],'paymentDetails':_0x4cd47b[_0x4c3977(0x1fb)],'checkedAt':new Date()[_0x4c3977(0x279)]()})}}),await this[_0x4c3977(0x208)](_0x26ba32,_0x4cd47b['status']),await this[_0x4c3977(0x237)](_0x26ba32,_0x4cd47b[_0x4c3977(0x1fd)]),_0x4cd47b[_0x4c3977(0x1fd)]!==_0x4c3977(0x206)&&(console['log'](_0x4c3977(0x2bf)+_0x26ba32['id']+_0x4c3977(0x2a2)+_0x4cd47b[_0x4c3977(0x1fd)]+',\x20clearing\x20individual\x20timers'),this['clearPaymentTimers'](_0x26ba32['id'])),console[_0x4c3977(0x1ee)](_0x4c3977(0x246)+_0x26ba32['id']+_0x4c3977(0x283));}else console[_0x4c3977(0x1ee)](_0x4c3977(0x1df)+_0x26ba32['id']+_0x4c3977(0x1c8)+_0x4cd47b[_0x4c3977(0x1fd)]+')'),this[_0x4c3977(0x288)](_0x26ba32['id'],_0x26ba32[_0x4c3977(0x1eb)],_0x26ba32[_0x4c3977(0x1fd)],_0x4cd47b[_0x4c3977(0x1fd)],_0x4c3977(0x204),{'statusUnchanged':!![],'paymentDetails':_0x4cd47b[_0x4c3977(0x1fb)],'amount':_0x4cd47b[_0x4c3977(0x291)],'currency':_0x4cd47b[_0x4c3977(0x232)],'shopId':_0x26ba32['shopId'],'checkTimestamp':new Date()[_0x4c3977(0x279)]()});}catch(_0x8d48c7){console[_0x4c3977(0x25f)](_0x4c3977(0x26f)+_0x26ba32['id']+':',_0x8d48c7),this[_0x4c3977(0x27e)](_0x26ba32['id'],_0x26ba32[_0x4c3977(0x1eb)],_0x8d48c7,_0x4c3977(0x204),{'paymentAmount':_0x26ba32['amount'],'paymentCurrency':_0x26ba32[_0x4c3977(0x232)],'shopId':_0x26ba32[_0x4c3977(0x214)],'createdAt':_0x26ba32[_0x4c3977(0x281)]}),await database_1[_0x4c3977(0x1d2)][_0x4c3977(0x1f3)][_0x4c3977(0x299)]({'data':{'paymentId':_0x26ba32['id'],'shopId':_0x26ba32[_0x4c3977(0x214)],'event':_0x4c3977(0x1e7),'statusCode':0x1f4,'responseBody':JSON[_0x4c3977(0x25a)]({'error':_0x8d48c7 instanceof Error?_0x8d48c7[_0x4c3977(0x26b)]:'Unknown\x20error','gatewayPaymentId':_0x26ba32[_0x4c3977(0x1eb)],'checkedAt':new Date()['toISOString']()})}});}}async['sendShopWebhook'](_0x357487,_0x24ff18){const _0x4f74a8=a37_0x31a7de,_0x33d736=Date['now']();try{const _0x233e9b=_0x357487[_0x4f74a8(0x26a)],_0x6b97af=_0x233e9b['settings'];if(!_0x6b97af?.[_0x4f74a8(0x28b)]){console[_0x4f74a8(0x1ee)](_0x4f74a8(0x209)+_0x233e9b['id']);return;}const _0x310150=_0x24ff18===_0x4f74a8(0x2d6)?_0x4f74a8(0x2d1):_0x24ff18===_0x4f74a8(0x252)?_0x4f74a8(0x2c5):_0x24ff18===_0x4f74a8(0x27a)?'payment.failed':_0x4f74a8(0x1cc);if(!_0x6b97af[_0x4f74a8(0x271)]?.[_0x4f74a8(0x225)](_0x310150)){console[_0x4f74a8(0x1ee)](_0x4f74a8(0x211)+_0x310150+_0x4f74a8(0x234)+_0x233e9b['id']);return;}const _0x155210=(0x0,gateway_1[_0x4f74a8(0x2ad)])(_0x357487['gateway'])||_0x357487[_0x4f74a8(0x1f0)],_0xc87ab3={'event':_0x310150,'payment':{'id':_0x357487['id'],'order_id':_0x357487[_0x4f74a8(0x2a0)],'gateway_order_id':_0x357487[_0x4f74a8(0x243)],'gateway':_0x155210,'amount':_0x357487[_0x4f74a8(0x291)],'currency':_0x357487[_0x4f74a8(0x232)],'status':_0x24ff18[_0x4f74a8(0x255)](),'customer_email':_0x357487[_0x4f74a8(0x207)],'customer_name':_0x357487['customerName'],'created_at':_0x357487[_0x4f74a8(0x281)],'updated_at':new Date()}},_0x4ecf90=await fetch(_0x6b97af[_0x4f74a8(0x28b)],{'method':_0x4f74a8(0x2a5),'headers':{'Content-Type':_0x4f74a8(0x26c),'User-Agent':_0x4f74a8(0x23a)},'body':JSON[_0x4f74a8(0x25a)](_0xc87ab3)}),_0x49e0d2=Date['now']()-_0x33d736,_0x2da04c=_0x4ecf90['ok']?'Success':await _0x4ecf90[_0x4f74a8(0x247)]();loggerService_1['loggerService'][_0x4f74a8(0x2c6)](_0x357487['shopId'],_0x6b97af[_0x4f74a8(0x28b)],_0x310150,_0x4ecf90[_0x4f74a8(0x1fd)],_0x49e0d2,_0xc87ab3),console[_0x4f74a8(0x1ee)](_0x4f74a8(0x26d)+_0x6b97af[_0x4f74a8(0x28b)]+_0x4f74a8(0x2aa)+_0x4ecf90[_0x4f74a8(0x1fd)]+'\x20('+_0x49e0d2+'ms)');}catch(_0x22593c){console[_0x4f74a8(0x25f)](_0x4f74a8(0x290),_0x22593c),loggerService_1[_0x4f74a8(0x268)][_0x4f74a8(0x215)](_0x357487[_0x4f74a8(0x214)],_0x357487[_0x4f74a8(0x26a)]?.[_0x4f74a8(0x23d)]?.['webhookUrl']||_0x4f74a8(0x20b),'webhook_send',_0x22593c,{});}}async[a37_0x31a7de(0x237)](_0x5b2860,_0x1b318b){const _0x46d471=a37_0x31a7de;try{const _0x2ac97d={'PENDING':_0x46d471(0x2c1),'PAID':_0x46d471(0x259),'FAILED':_0x46d471(0x28c),'EXPIRED':'expired'},_0x428c6e=_0x2ac97d[_0x1b318b];if(!_0x428c6e||_0x428c6e===_0x46d471(0x2c1))return;await telegramBotService_1[_0x46d471(0x242)][_0x46d471(0x2b5)](_0x5b2860[_0x46d471(0x214)],_0x5b2860,_0x428c6e);}catch(_0x322f03){console[_0x46d471(0x25f)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x322f03);}}async['checkPaymentById'](_0x12e61a){const _0x4db30b=a37_0x31a7de;console['log'](_0x4db30b(0x28e)+_0x12e61a);const _0x4b746c=await database_1[_0x4db30b(0x1d2)][_0x4db30b(0x264)][_0x4db30b(0x1d7)]({'where':{'id':_0x12e61a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4b746c)throw new Error(_0x4db30b(0x29e));if(_0x4b746c[_0x4db30b(0x1f0)]!==_0x4db30b(0x269)&&_0x4b746c[_0x4db30b(0x1f0)]!=='cointopay2')throw new Error(_0x4db30b(0x2ab));console[_0x4db30b(0x1ee)](_0x4db30b(0x200)+_0x4b746c[_0x4db30b(0x1f0)]+_0x4db30b(0x1f5)+_0x12e61a),await this[_0x4db30b(0x20d)](_0x4b746c),console[_0x4db30b(0x1ee)](_0x4db30b(0x29f)+_0x12e61a);}[a37_0x31a7de(0x276)](){const _0x52fc90=a37_0x31a7de,_0x313cad=this['globalCheckInterval']?this[_0x52fc90(0x2be)]:undefined,_0x5dd7de=Array[_0x52fc90(0x2d5)](this[_0x52fc90(0x2d7)][_0x52fc90(0x1e5)]())['map'](_0x3c4a95=>({'paymentId':_0x3c4a95[_0x52fc90(0x22a)],'gatewayPaymentId':_0x3c4a95[_0x52fc90(0x1eb)],'createdAt':_0x3c4a95['createdAt'],'timersCount':_0x3c4a95[_0x52fc90(0x251)][_0x52fc90(0x2d8)]}));return{'isActive':!!this[_0x52fc90(0x22d)],'globalCheckIntervalMinutes':this[_0x52fc90(0x2be)]/(0x3e8*0x3c),'expiryDays':this[_0x52fc90(0x248)],'activeIndividualTimers':this['paymentTimers'][_0x52fc90(0x22f)],'nextGlobalCheckIn':_0x313cad,'paymentTimersDetails':_0x5dd7de};}[a37_0x31a7de(0x262)](_0x2b4129){const _0x10cf43=a37_0x31a7de,_0xf795da=this[_0x10cf43(0x2d7)][_0x10cf43(0x27b)](_0x2b4129);if(_0xf795da)return{'hasTimers':!![],'timersCount':_0xf795da['timers'][_0x10cf43(0x2d8)],'createdAt':_0xf795da[_0x10cf43(0x281)],'gatewayPaymentId':_0xf795da[_0x10cf43(0x1eb)]};return{'hasTimers':![]};}async[a37_0x31a7de(0x2cf)](_0x52adf9,_0x418724){const _0xa0defc=a37_0x31a7de;try{const _0x423886=await database_1['default'][_0xa0defc(0x26a)][_0xa0defc(0x1d7)]({'where':{'id':_0x52adf9},'select':{'gatewaySettings':!![]}});if(!_0x423886?.['gatewaySettings'])return console['log']('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x52adf9+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x2561ce=JSON[_0xa0defc(0x229)](_0x423886[_0xa0defc(0x287)]);for(const [_0x462119,_0x1000ab]of Object[_0xa0defc(0x1fc)](_0x2561ce)){if(_0x462119[_0xa0defc(0x255)]()===_0x418724[_0xa0defc(0x255)]()){const _0x4bb133=_0x1000ab[_0xa0defc(0x2b8)]||0xa;return console[_0xa0defc(0x1ee)](_0xa0defc(0x263)+_0x418724+_0xa0defc(0x1cd)+_0x52adf9+':\x20'+_0x4bb133+'%'),_0x4bb133;}}return console[_0xa0defc(0x1ee)]('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0x418724+_0xa0defc(0x1f8)+_0x52adf9+',\x20using\x20default\x2010%'),0xa;}catch(_0x2de36f){return console[_0xa0defc(0x25f)](_0xa0defc(0x2a3)+_0x52adf9+_0xa0defc(0x205)+_0x418724+':',_0x2de36f),0xa;}}}function a37_0x34fe(_0x417356,_0x4ea926){const _0x5ee2a8=a37_0x5ee2();return a37_0x34fe=function(_0x34fe3e,_0x388fb5){_0x34fe3e=_0x34fe3e-0x1c7;let _0x23b4fd=_0x5ee2a8[_0x34fe3e];return _0x23b4fd;},a37_0x34fe(_0x417356,_0x4ea926);}exports[a37_0x31a7de(0x1ca)]=CoinToPayStatusService,exports[a37_0x31a7de(0x213)]=new CoinToPayStatusService();