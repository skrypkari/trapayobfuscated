'use strict';const a37_0x51cd1f=a37_0x560e;(function(_0xf8cdde,_0x2bbd94){const _0x27074b=a37_0x560e,_0xfb1489=_0xf8cdde();while(!![]){try{const _0x31755f=-parseInt(_0x27074b(0xa7))/0x1+-parseInt(_0x27074b(0xd7))/0x2+parseInt(_0x27074b(0x133))/0x3*(parseInt(_0x27074b(0x143))/0x4)+-parseInt(_0x27074b(0xb8))/0x5+-parseInt(_0x27074b(0xf3))/0x6+-parseInt(_0x27074b(0xdd))/0x7+-parseInt(_0x27074b(0xa2))/0x8*(-parseInt(_0x27074b(0xc0))/0x9);if(_0x31755f===_0x2bbd94)break;else _0xfb1489['push'](_0xfb1489['shift']());}catch(_0xc5fee6){_0xfb1489['push'](_0xfb1489['shift']());}}}(a37_0x5239,0x25899));var __importDefault=this&&this['__importDefault']||function(_0x265130){return _0x265130&&_0x265130['__esModule']?_0x265130:{'default':_0x265130};};function a37_0x560e(_0x56e4a0,_0x19557c){const _0x523962=a37_0x5239();return a37_0x560e=function(_0x560e5e,_0x4e14a7){_0x560e5e=_0x560e5e-0x8e;let _0x3ace34=_0x523962[_0x560e5e];return _0x3ace34;},a37_0x560e(_0x56e4a0,_0x19557c);}Object[a37_0x51cd1f(0xee)](exports,a37_0x51cd1f(0xf0),{'value':!![]}),exports[a37_0x51cd1f(0x140)]=exports[a37_0x51cd1f(0x167)]=void 0x0;function a37_0x5239(){const _0x3a0219=['‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','ms)','445144lNZeOS','schedule_created','status_check','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','delay','\x20days,\x20marking\x20as\x20EXPIRED','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','üí∞\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20Status:\x20','Payment\x20older\x20than\x20','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','FAILED',',\x20clearing\x20individual\x20timers','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20days\x20(created\x20before\x20','status','create','defineProperty','toISOString','__esModule','failed','\x20with\x20status\x20','1093620gVmJfM','paid','‚ùå\x20[HOURLY]\x20Payment\x20','created','Bank\x20Details:\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','\x20details:','error','log','schedulePaymentChecks','cointopay_status_check_','delete','cointopay','coinToPayService','\x20seconds\x20(','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','length','Webhook\x20event\x20','üßπ\x20[DEBUG]\x20Clearing\x20','push','checkExpiredPayments','getServiceStats','\x20timers\x20for\x20payment\x20','EXPIRY_DAYS','stack','logCoinToPayError','../config/database','Unknown\x20error','findUnique','values','map','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','sendShopWebhook','adminNotes','paymentDetails','\x20status\x20from\x20','floor','\x20(after\x20','toLowerCase','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20status\x20changed\x20to\x20','payment','has','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','‚è∞\x20[GLOBAL]\x20Payment\x20','shop','PAID','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','5\x20minutes','telegramBotService','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','createdAt','ü™ô\x20CoinToPayStatusService\x20initialized','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','text','loggerService','\x20found:','\x20initial\x20timers\x20for\x20payment\x20','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','gatewayPaymentId','shopId','stopPeriodicStatusCheck','getDate','\x20expired','381PGlmGa','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20->\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','‚è∞\x20[HOURLY]\x20Payment\x20','\x20is\x20older\x20than\x20','ü™ô\x20[GLOBAL]\x20Found\x20','customerEmail','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','catch','checkSinglePayment','‚è∞\x20[EXPIRY]\x20Payment\x20','coinToPayStatusService','iban','\x20\x20\x20-\x20gatewayPaymentId:\x20','236HvAWxR','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','orderId','COINTOPAY_ERROR','EXPIRED','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','unknown','logShopWebhookSent','1\x20minute','Payment\x20not\x20found','\x20\x20\x20üìù\x20Context:','\x20status:\x20','bankDetails','toFixed','webhookEvents','sendPaymentStatusNotification','cointopay_auto_expired','2\x20minutes',',\x20stopping\x20individual\x20checks','TesSoft\x20Payment\x20System/1.0','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','‚úÖ\x20[HOURLY]\x20Payment\x20','\x20checked,\x20','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','gateway','description','clearPaymentTimers','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','./loggerService','default','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','payment.success','\x20\x20\x20üìä\x20Status:\x20','\x20\x20\x20-\x20Gateway:\x20','webhookUrl','CoinToPayStatusService','/status/','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','checkAllPendingPayments','\x20not\x20enabled\x20for\x20shop\x20','\x20(age:\x20','amount','paymentId','\x20pending\x20CoinToPay\x20payments','GLOBAL_CHECK_INTERVAL_MS','üõë\x20[SHUTDOWN]\x20Cleared\x20','\x20completed\x20for\x20payment\x20','\x20current\x20status:\x20','‚ùå\x20[CHECK]\x20Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','checkSinglePaymentById','paymentTimers','stringify','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','startPeriodicStatusCheck','webhook_send','forEach','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','Failed\x20to\x20send\x20shop\x20webhook:','CoinToPayService','payment.pending','settings','size','Automatically\x20expired\x20after\x20','not\x20confirmed','‚úÖ\x20[EXPIRY]\x20Payment\x20','now','get','\x20for\x20payment\x20','Shop\x20webhook\x20sent\x20to\x20','COINTOPAY_STATUS_CHANGE','\x20days\x20without\x20payment\x20confirmation','16fwBCaj','checkPaymentStatus','transactionId','-day\x20timeout','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','60421MHtPsA','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','PENDING','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20individual\x20payment\x20timers','globalCheckInterval','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20status\x20is\x20','paidAt','.\x20Remaining\x20active\x20timers:\x20','auto_expire','set','logCoinToPayStatus','\x20status\x20unchanged\x20(','\x20\x20\x20-\x20ShopId:\x20','message','1293060JhHNuv','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','timestamp','./telegramBotService','\x20\x20\x20-\x20paymentId:\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','currency','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','3706308nkUfXG','timers','‚úÖ\x20[CHECK]\x20Payment\x20','./gateways/coinToPayService','\x20\x20\x20‚ùå\x20Error:\x20','\x20\x20\x20üìç\x20Source:\x20','update','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','includes','getTime','from','ü™ô\x20[DEBUG]\x20Creating\x20','not\x20found','Success','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20not\x20found,\x20clearing\x20timers','remitterIban','webhookLog','\x20to\x20clear','\x20in\x20','üìä\x20[CHECK]\x20Payment\x20','\x20to\x20','224938aPMZwO','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','\x20\x20\x20-\x20Amount:\x20','payment.failed'];a37_0x5239=function(){return _0x3a0219;};return a37_0x5239();}const coinToPayService_1=require(a37_0x51cd1f(0xc3)),database_1=__importDefault(require(a37_0x51cd1f(0x10d))),telegramBotService_1=require(a37_0x51cd1f(0xbb)),loggerService_1=require(a37_0x51cd1f(0x160));class CoinToPayStatusService{constructor(){const _0x31a434=a37_0x51cd1f;this['globalCheckInterval']=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x31a434(0x10a)]=0x5,this['paymentTimers']=new Map(),this[_0x31a434(0x100)]=new coinToPayService_1[(_0x31a434(0x95))](),console[_0x31a434(0xfb)](_0x31a434(0x127));}[a37_0x51cd1f(0xfc)](_0x2fe1f6,_0x3fb041){const _0x2c98b0=a37_0x51cd1f;console[_0x2c98b0(0xfb)](_0x2c98b0(0xaa)),console[_0x2c98b0(0xfb)](_0x2c98b0(0xbc)+_0x2fe1f6),console[_0x2c98b0(0xfb)](_0x2c98b0(0x142)+_0x3fb041),this[_0x2c98b0(0x15e)](_0x2fe1f6);const _0x2839c8=[],_0xc230fe=new Date(),_0x597801=[{'delay':0x1*0x3c*0x3e8,'description':_0x2c98b0(0x14c)},{'delay':0x2*0x3c*0x3e8,'description':_0x2c98b0(0x155)},{'delay':0x5*0x3c*0x3e8,'description':_0x2c98b0(0x123)},{'delay':0x5*0x3c*0x3e8,'description':_0x2c98b0(0x123)}];console[_0x2c98b0(0xfb)](_0x2c98b0(0xcc)+_0x597801[_0x2c98b0(0x103)]+_0x2c98b0(0x12c)+_0x2fe1f6);let _0x252501=0x0;_0x597801[_0x2c98b0(0x92)]((_0x304296,_0x30c941)=>{const _0x98182=_0x2c98b0;_0x252501+=_0x304296[_0x98182(0xe1)];const _0x2b4bfd=setTimeout(async()=>{const _0x55d552=_0x98182;console[_0x55d552(0xfb)](_0x55d552(0xc7)+(_0x30c941+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x2fe1f6+_0x55d552(0x118)+_0x304296[_0x55d552(0x15d)]+')');try{await this[_0x55d552(0x176)](_0x2fe1f6),console[_0x55d552(0xfb)]('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x30c941+0x1)+_0x55d552(0x172)+_0x2fe1f6);}catch(_0x5651f3){console[_0x55d552(0xfa)](_0x55d552(0x102)+(_0x30c941+0x1)+'\x20for\x20payment\x20'+_0x2fe1f6+':',_0x5651f3),this[_0x55d552(0x10c)](_0x2fe1f6,_0x3fb041,_0x5651f3,_0x55d552(0xdf),{'checkNumber':_0x30c941+0x1,'scheduledAfter':_0x304296[_0x55d552(0x15d)],'isIndividualCheck':!![]});}},_0x252501);_0x2839c8[_0x98182(0x106)](_0x2b4bfd),console[_0x98182(0xfb)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x30c941+0x1)+_0x98182(0x9e)+_0x2fe1f6+_0x98182(0xd4)+_0x252501/0x3e8+_0x98182(0x101)+_0x304296[_0x98182(0x15d)]+')');});const _0x4c9b92=setInterval(async()=>{const _0x22f49f=_0x2c98b0;console[_0x22f49f(0xfb)](_0x22f49f(0x179)+_0x2fe1f6);try{const _0xcba1ba=await database_1['default'][_0x22f49f(0x11c)][_0x22f49f(0x10f)]({'where':{'id':_0x2fe1f6},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0xcba1ba){console[_0x22f49f(0xfb)](_0x22f49f(0xf5)+_0x2fe1f6+_0x22f49f(0xd0)),this[_0x22f49f(0x15e)](_0x2fe1f6);return;}console['log']('üìä\x20[HOURLY]\x20Payment\x20'+_0x2fe1f6+_0x22f49f(0x173)+_0xcba1ba['status']);if(_0xcba1ba[_0x22f49f(0xec)]!==_0x22f49f(0xa9)){console[_0x22f49f(0xfb)](_0x22f49f(0x159)+_0x2fe1f6+'\x20status\x20is\x20'+_0xcba1ba[_0x22f49f(0xec)]+_0x22f49f(0x156)),this['clearPaymentTimers'](_0x2fe1f6);return;}const _0x1a5feb=Math[_0x22f49f(0x117)]((Date[_0x22f49f(0x9c)]()-_0xcba1ba[_0x22f49f(0x126)][_0x22f49f(0xca)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1a5feb>=this['EXPIRY_DAYS']){console[_0x22f49f(0xfb)](_0x22f49f(0x137)+_0x2fe1f6+_0x22f49f(0x138)+this[_0x22f49f(0x10a)]+_0x22f49f(0x162)),this[_0x22f49f(0x15e)](_0x2fe1f6);return;}await this[_0x22f49f(0x176)](_0x2fe1f6),console[_0x22f49f(0xfb)](_0x22f49f(0xab)+_0x2fe1f6);}catch(_0x30b533){console[_0x22f49f(0xfa)](_0x22f49f(0x122)+_0x2fe1f6+':',_0x30b533),this['logCoinToPayError'](_0x2fe1f6,_0x3fb041,_0x30b533,_0x22f49f(0xdf),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x2839c8['push'](_0x4c9b92),this[_0x2c98b0(0x177)][_0x2c98b0(0xb3)](_0x2fe1f6,{'timers':_0x2839c8,'paymentId':_0x2fe1f6,'gatewayPaymentId':_0x3fb041,'createdAt':_0xc230fe}),console['log'](_0x2c98b0(0x125)+_0x597801['length']+_0x2c98b0(0x149)+_0x2fe1f6),console['log']('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x2c98b0(0x177)][_0x2c98b0(0x98)]),this['logCoinToPayStatus'](_0x2fe1f6,_0x3fb041,_0x2c98b0(0xa9),_0x2c98b0(0xa9),_0x2c98b0(0xdf),{'action':_0x2c98b0(0xde),'scheduledChecks':_0x597801[_0x2c98b0(0x103)],'firstCheckIn':_0x597801[0x0][_0x2c98b0(0xe1)]/0x3e8,'totalTimers':this[_0x2c98b0(0x177)]['size']});}[a37_0x51cd1f(0x15e)](_0x336971){const _0x249fb5=a37_0x51cd1f,_0x8489b3=this[_0x249fb5(0x177)][_0x249fb5(0x9d)](_0x336971);_0x8489b3?(console[_0x249fb5(0xfb)](_0x249fb5(0x105)+_0x8489b3['timers'][_0x249fb5(0x103)]+_0x249fb5(0x109)+_0x336971),_0x8489b3[_0x249fb5(0xc1)][_0x249fb5(0x92)]((_0x58be41,_0x524e48)=>{const _0x3ec25c=_0x249fb5;_0x58be41&&(clearTimeout(_0x58be41),clearInterval(_0x58be41),console['log']('üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x524e48+0x1)+_0x3ec25c(0x9e)+_0x336971));}),this['paymentTimers'][_0x249fb5(0xfe)](_0x336971),console['log']('‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x336971+_0x249fb5(0xb1)+this[_0x249fb5(0x177)]['size'])):console[_0x249fb5(0xfb)](_0x249fb5(0x8e)+_0x336971+_0x249fb5(0xd3));}async[a37_0x51cd1f(0x176)](_0x14a0b9){const _0x5d9137=a37_0x51cd1f;console['log'](_0x5d9137(0x128)+_0x14a0b9);const _0x435e26=await database_1['default'][_0x5d9137(0x11c)][_0x5d9137(0x10f)]({'where':{'id':_0x14a0b9},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x435e26){console[_0x5d9137(0xfb)](_0x5d9137(0x174)+_0x14a0b9+'\x20not\x20found\x20in\x20database');return;}console[_0x5d9137(0xfb)](_0x5d9137(0xd5)+_0x14a0b9+_0x5d9137(0x12b)),console[_0x5d9137(0xfb)](_0x5d9137(0x165)+_0x435e26[_0x5d9137(0x15c)]),console['log'](_0x5d9137(0xe5)+_0x435e26[_0x5d9137(0xec)]),console['log']('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x435e26[_0x5d9137(0x12e)]),console[_0x5d9137(0xfb)](_0x5d9137(0xd9)+_0x435e26[_0x5d9137(0x16d)]+'\x20'+_0x435e26['currency']),console[_0x5d9137(0xfb)](_0x5d9137(0xb6)+_0x435e26[_0x5d9137(0x12f)]);if(_0x435e26[_0x5d9137(0x15c)]!==_0x5d9137(0xff)){console[_0x5d9137(0xfb)](_0x5d9137(0x148)+_0x14a0b9+_0x5d9137(0xbd)+_0x435e26['gateway']+')');return;}if(_0x435e26[_0x5d9137(0xec)]!==_0x5d9137(0xa9)){console[_0x5d9137(0xfb)](_0x5d9137(0x148)+_0x14a0b9+_0x5d9137(0xaf)+_0x435e26[_0x5d9137(0xec)]+_0x5d9137(0x156)),this[_0x5d9137(0x15e)](_0x14a0b9);return;}if(!_0x435e26[_0x5d9137(0x12e)]){console[_0x5d9137(0xfb)](_0x5d9137(0x148)+_0x14a0b9+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x5d9137(0xfb)]('‚úÖ\x20[CHECK]\x20Payment\x20'+_0x14a0b9+_0x5d9137(0x13c)),await this['checkSinglePayment'](_0x435e26);}[a37_0x51cd1f(0xb4)](_0x319e38,_0x5e32c1,_0x2c593c,_0x323b99,_0x2d719b,_0x4bb7f5){const _0x2a9f81=a37_0x51cd1f,_0x433cef={'type':_0x2a9f81(0xa0),'paymentId':_0x319e38,'gatewayPaymentId':_0x5e32c1,'oldStatus':_0x2c593c,'newStatus':_0x323b99,'source':_0x2d719b,'timestamp':new Date()[_0x2a9f81(0xef)](),'details':_0x4bb7f5||{}};loggerService_1[_0x2a9f81(0x12a)][_0x2a9f81(0xb4)](_0x433cef),console[_0x2a9f81(0xfb)](_0x2a9f81(0xf8)+_0x319e38+'\x20('+_0x5e32c1+')'),console[_0x2a9f81(0xfb)](_0x2a9f81(0x164)+_0x2c593c+_0x2a9f81(0x135)+_0x323b99),console[_0x2a9f81(0xfb)](_0x2a9f81(0xc5)+_0x2d719b),console[_0x2a9f81(0xfb)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x433cef[_0x2a9f81(0xba)]),_0x4bb7f5&&console['log']('\x20\x20\x20üìù\x20Details:',_0x4bb7f5);}[a37_0x51cd1f(0x10c)](_0x21646f,_0x47569f,_0x412c81,_0x5ad23d,_0x166004){const _0x3c0ed8=a37_0x51cd1f,_0x34e2af={'type':_0x3c0ed8(0x146),'paymentId':_0x21646f,'gatewayPaymentId':_0x47569f,'error':_0x412c81 instanceof Error?{'message':_0x412c81[_0x3c0ed8(0xb7)],'stack':_0x412c81[_0x3c0ed8(0x10b)]}:_0x412c81,'source':_0x5ad23d,'timestamp':new Date()[_0x3c0ed8(0xef)](),'context':_0x166004||{}};loggerService_1[_0x3c0ed8(0x12a)][_0x3c0ed8(0x10c)](_0x34e2af),console['error'](_0x3c0ed8(0x12d)+_0x21646f+'\x20('+_0x47569f+')'),console['error'](_0x3c0ed8(0xc4)+(_0x412c81 instanceof Error?_0x412c81[_0x3c0ed8(0xb7)]:_0x412c81)),console['error'](_0x3c0ed8(0xc5)+_0x5ad23d),console[_0x3c0ed8(0xfa)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x34e2af[_0x3c0ed8(0xba)]),_0x166004&&console['error'](_0x3c0ed8(0x14e),_0x166004);}[a37_0x51cd1f(0x90)](){const _0x2f11cd=a37_0x51cd1f;console['log'](_0x2f11cd(0xe7)),this[_0x2f11cd(0x16a)]()[_0x2f11cd(0x13d)](_0x100cca=>{console['error']('‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x100cca);}),this[_0x2f11cd(0xad)]=setInterval(async()=>{const _0x2b1ede=_0x2f11cd;try{console[_0x2b1ede(0xfb)](_0x2b1ede(0x15b)),await this['checkAllPendingPayments'](),console[_0x2b1ede(0xfb)](_0x2b1ede(0x158));}catch(_0x5b393d){console[_0x2b1ede(0xfa)](_0x2b1ede(0xae),_0x5b393d);}},this[_0x2f11cd(0x170)]),console[_0x2f11cd(0xfb)](_0x2f11cd(0xa8));}[a37_0x51cd1f(0x130)](){const _0x1f1c90=a37_0x51cd1f;console[_0x1f1c90(0xfb)](_0x1f1c90(0x93));this['globalCheckInterval']&&(clearInterval(this[_0x1f1c90(0xad)]),this[_0x1f1c90(0xad)]=null,console[_0x1f1c90(0xfb)](_0x1f1c90(0x144)));const _0x3ba344=this[_0x1f1c90(0x177)]['size'];for(const [_0x13393e]of this[_0x1f1c90(0x177)]){this[_0x1f1c90(0x15e)](_0x13393e);}console[_0x1f1c90(0xfb)](_0x1f1c90(0x171)+_0x3ba344+_0x1f1c90(0xac));}async['checkAllPendingPayments'](){const _0x247309=a37_0x51cd1f;try{console[_0x247309(0xfb)](_0x247309(0x169));const _0x4017b3=await database_1['default'][_0x247309(0x11c)]['findMany']({'where':{'gateway':_0x247309(0xff),'status':_0x247309(0xa9),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x247309(0xfb)](_0x247309(0x139)+_0x4017b3[_0x247309(0x103)]+_0x247309(0x16f));if(_0x4017b3[_0x247309(0x103)]===0x0){console[_0x247309(0xfb)](_0x247309(0x112));return;}const _0x37a8f9=await this['checkExpiredPayments'](_0x4017b3);console['log']('‚è∞\x20[GLOBAL]\x20Found\x20'+_0x37a8f9[_0x247309(0x103)]+'\x20expired\x20CoinToPay\x20payments');let _0x5b1196=0x0,_0x1be2d7=0x0;for(const _0x2aeb80 of _0x4017b3){try{if(_0x37a8f9['includes'](_0x2aeb80['id'])){console[_0x247309(0xfb)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x2aeb80['id']+_0x247309(0x136)),_0x1be2d7++;continue;}if(this[_0x247309(0x177)][_0x247309(0x11d)](_0x2aeb80['id'])){console[_0x247309(0xfb)](_0x247309(0x11f)+_0x2aeb80['id']+_0x247309(0x8f)),_0x1be2d7++;continue;}const _0x39e940=(Date[_0x247309(0x9c)]()-_0x2aeb80[_0x247309(0x126)][_0x247309(0xca)]())/(0x3e8*0x3c*0x3c);if(_0x39e940<0x1){console['log'](_0x247309(0x11f)+_0x2aeb80['id']+'\x20is\x20too\x20new\x20('+_0x39e940[_0x247309(0x151)](0x1)+'h),\x20skipping\x20global\x20check'),_0x1be2d7++;continue;}console[_0x247309(0xfb)](_0x247309(0xc8)+_0x2aeb80['id']+_0x247309(0x16c)+_0x39e940[_0x247309(0x151)](0x1)+'h)'),await this[_0x247309(0x13e)](_0x2aeb80),_0x5b1196++,await new Promise(_0xb7b532=>setTimeout(_0xb7b532,0x7d0));}catch(_0x245fa8){console[_0x247309(0xfa)](_0x247309(0xe0)+_0x2aeb80['id']+':',_0x245fa8),this[_0x247309(0x10c)](_0x2aeb80['id'],_0x2aeb80['gatewayPaymentId']||_0x247309(0x14a),_0x245fa8,_0x247309(0xdf),{'isGlobalCheck':!![],'paymentAmount':_0x2aeb80['amount'],'paymentCurrency':_0x2aeb80[_0x247309(0xbe)],'shopId':_0x2aeb80[_0x247309(0x12f)],'createdAt':_0x2aeb80['createdAt']}),loggerService_1[_0x247309(0x12a)]['logWhiteDomainError'](_0x247309(0xff),_0x247309(0x168)+_0x2aeb80[_0x247309(0x12e)],_0x245fa8);}}console[_0x247309(0xfb)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x5b1196+_0x247309(0x15a)+_0x1be2d7+'\x20skipped,\x20'+_0x37a8f9[_0x247309(0x103)]+_0x247309(0x132));}catch(_0x4d207f){console['error'](_0x247309(0x11e),_0x4d207f);}}async[a37_0x51cd1f(0x107)](_0x301ac2){const _0x4b4ecc=a37_0x51cd1f,_0x1c7ec9=[],_0x2889e9=new Date();_0x2889e9['setDate'](_0x2889e9[_0x4b4ecc(0x131)]()-this[_0x4b4ecc(0x10a)]),console['log'](_0x4b4ecc(0x11a)+this[_0x4b4ecc(0x10a)]+_0x4b4ecc(0xeb)+_0x2889e9[_0x4b4ecc(0xef)]()+')');for(const _0x264475 of _0x301ac2){if(_0x264475[_0x4b4ecc(0x126)]<_0x2889e9){console[_0x4b4ecc(0xfb)](_0x4b4ecc(0x13f)+_0x264475['id']+_0x4b4ecc(0x138)+this[_0x4b4ecc(0x10a)]+_0x4b4ecc(0xe2));try{this[_0x4b4ecc(0xb4)](_0x264475['id'],_0x264475[_0x4b4ecc(0x12e)]||_0x4b4ecc(0x14a),'PENDING',_0x4b4ecc(0x147),_0x4b4ecc(0xb2),{'reason':_0x4b4ecc(0xe6)+this[_0x4b4ecc(0x10a)]+'\x20days','createdAt':_0x264475[_0x4b4ecc(0x126)],'daysSinceCreation':Math[_0x4b4ecc(0x117)]((Date[_0x4b4ecc(0x9c)]()-_0x264475[_0x4b4ecc(0x126)][_0x4b4ecc(0xca)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x264475[_0x4b4ecc(0x16d)],'paymentCurrency':_0x264475[_0x4b4ecc(0xbe)],'shopId':_0x264475[_0x4b4ecc(0x12f)]}),await database_1[_0x4b4ecc(0x161)][_0x4b4ecc(0x11c)][_0x4b4ecc(0xc6)]({'where':{'id':_0x264475['id']},'data':{'status':_0x4b4ecc(0x147),'updatedAt':new Date(),'adminNotes':_0x4b4ecc(0x99)+this[_0x4b4ecc(0x10a)]+_0x4b4ecc(0xa1)}}),await database_1[_0x4b4ecc(0x161)][_0x4b4ecc(0xd2)][_0x4b4ecc(0xed)]({'data':{'paymentId':_0x264475['id'],'shopId':_0x264475[_0x4b4ecc(0x12f)],'event':_0x4b4ecc(0x154),'statusCode':0xc8,'responseBody':JSON[_0x4b4ecc(0x178)]({'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x264475['createdAt'],'expiredAt':new Date()[_0x4b4ecc(0xef)](),'daysSinceCreation':Math['floor']((Date[_0x4b4ecc(0x9c)]()-_0x264475['createdAt'][_0x4b4ecc(0xca)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4b4ecc(0x113)](_0x264475,_0x4b4ecc(0x147)),await this['sendPaymentStatusNotification'](_0x264475,_0x4b4ecc(0x147)),this[_0x4b4ecc(0x15e)](_0x264475['id']),_0x1c7ec9['push'](_0x264475['id']),console[_0x4b4ecc(0xfb)](_0x4b4ecc(0x9b)+_0x264475['id']+_0x4b4ecc(0x15f)+this['EXPIRY_DAYS']+_0x4b4ecc(0xa5));}catch(_0x2b184e){console['error'](_0x4b4ecc(0xa6)+_0x264475['id']+':',_0x2b184e),this[_0x4b4ecc(0x10c)](_0x264475['id'],_0x264475['gatewayPaymentId']||_0x4b4ecc(0x14a),_0x2b184e,_0x4b4ecc(0xb2),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x264475['createdAt'],'daysSinceCreation':Math['floor']((Date['now']()-_0x264475['createdAt'][_0x4b4ecc(0xca)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x1c7ec9;}async['checkSinglePayment'](_0x221b47){const _0x1dac16=a37_0x51cd1f;if(!_0x221b47[_0x1dac16(0x12e)]){console[_0x1dac16(0xfb)](_0x1dac16(0x148)+_0x221b47['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x1dac16(0xfb)](_0x1dac16(0xe3)+_0x221b47['id']+'\x20('+_0x221b47[_0x1dac16(0x12e)]+')');try{const _0x36296b=await this[_0x1dac16(0x100)][_0x1dac16(0xa3)](_0x221b47[_0x1dac16(0x12e)]);console['log']('üìä\x20[CHECK]\x20Payment\x20'+_0x221b47['id']+_0x1dac16(0x14f)+_0x36296b[_0x1dac16(0xec)]);_0x36296b[_0x1dac16(0x115)]&&console[_0x1dac16(0xfb)]('üìä\x20[CHECK]\x20Payment\x20'+_0x221b47['id']+_0x1dac16(0xf9),{'iban':_0x36296b['paymentDetails'][_0x1dac16(0x141)]||_0x1dac16(0xcd),'transactionId':_0x36296b['paymentDetails'][_0x1dac16(0xa4)],'createdOn':_0x36296b[_0x1dac16(0x115)]['createdOn'],'confirmedOn':_0x36296b[_0x1dac16(0x115)]['confirmedOn']||_0x1dac16(0x9a)});if(_0x36296b['status']!==_0x221b47[_0x1dac16(0xec)]){console[_0x1dac16(0xfb)](_0x1dac16(0x13b)+_0x221b47['id']+_0x1dac16(0x116)+_0x221b47['status']+_0x1dac16(0xd6)+_0x36296b[_0x1dac16(0xec)]),this[_0x1dac16(0xb4)](_0x221b47['id'],_0x221b47[_0x1dac16(0x12e)],_0x221b47[_0x1dac16(0xec)],_0x36296b[_0x1dac16(0xec)],'status_check',{'paymentDetails':_0x36296b['paymentDetails'],'amount':_0x36296b[_0x1dac16(0x16d)],'currency':_0x36296b[_0x1dac16(0xbe)],'shopId':_0x221b47[_0x1dac16(0x12f)],'checkTimestamp':new Date()[_0x1dac16(0xef)]()});const _0x57535e={'status':_0x36296b[_0x1dac16(0xec)],'updatedAt':new Date()};_0x36296b['status']==='PAID'&&_0x221b47[_0x1dac16(0xec)]!=='PAID'&&(_0x57535e[_0x1dac16(0xb0)]=new Date(),console[_0x1dac16(0xfb)](_0x1dac16(0xe4)+_0x221b47['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x57535e[_0x1dac16(0xb0)][_0x1dac16(0xef)]()));if(_0x36296b[_0x1dac16(0x115)]){const _0x1740ec=_0x36296b[_0x1dac16(0x115)];_0x1740ec[_0x1dac16(0x141)]&&(_0x57535e[_0x1dac16(0xd1)]=_0x1740ec[_0x1dac16(0x141)],console[_0x1dac16(0xfb)]('üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x1740ec[_0x1dac16(0x141)]));if(_0x1740ec[_0x1dac16(0x150)]){const _0x3d9dd5=_0x221b47['adminNotes']||'',_0x44d1c4=_0x1dac16(0xf7)+_0x1740ec[_0x1dac16(0x150)];_0x57535e[_0x1dac16(0x114)]=_0x3d9dd5?_0x3d9dd5+'\x0a\x0a'+_0x44d1c4:_0x44d1c4,console['log'](_0x1dac16(0xb9));}_0x1740ec[_0x1dac16(0xa4)]&&console['log'](_0x1dac16(0xd8)+_0x1740ec['transactionId']),_0x1740ec['confirmedOn']&&console['log'](_0x1dac16(0x134)+_0x1740ec['confirmedOn']);}await database_1[_0x1dac16(0x161)][_0x1dac16(0x11c)][_0x1dac16(0xc6)]({'where':{'id':_0x221b47['id']},'data':_0x57535e}),await database_1['default'][_0x1dac16(0xd2)][_0x1dac16(0xed)]({'data':{'paymentId':_0x221b47['id'],'shopId':_0x221b47['shopId'],'event':_0x1dac16(0xfd)+_0x36296b[_0x1dac16(0xec)][_0x1dac16(0x119)](),'statusCode':0xc8,'responseBody':JSON[_0x1dac16(0x178)]({'oldStatus':_0x221b47[_0x1dac16(0xec)],'newStatus':_0x36296b['status'],'paymentDetails':_0x36296b[_0x1dac16(0x115)],'checkedAt':new Date()[_0x1dac16(0xef)]()})}}),await this['sendShopWebhook'](_0x221b47,_0x36296b[_0x1dac16(0xec)]),await this['sendPaymentStatusNotification'](_0x221b47,_0x36296b['status']),_0x36296b[_0x1dac16(0xec)]!=='PENDING'&&(console[_0x1dac16(0xfb)]('üßπ\x20[CHECK]\x20Payment\x20'+_0x221b47['id']+_0x1dac16(0x11b)+_0x36296b['status']+_0x1dac16(0xe9)),this[_0x1dac16(0x15e)](_0x221b47['id'])),console[_0x1dac16(0xfb)](_0x1dac16(0xc2)+_0x221b47['id']+'\x20updated\x20successfully');}else console['log'](_0x1dac16(0xd5)+_0x221b47['id']+_0x1dac16(0xb5)+_0x36296b[_0x1dac16(0xec)]+')'),this['logCoinToPayStatus'](_0x221b47['id'],_0x221b47[_0x1dac16(0x12e)],_0x221b47[_0x1dac16(0xec)],_0x36296b['status'],_0x1dac16(0xdf),{'statusUnchanged':!![],'paymentDetails':_0x36296b[_0x1dac16(0x115)],'amount':_0x36296b[_0x1dac16(0x16d)],'currency':_0x36296b[_0x1dac16(0xbe)],'shopId':_0x221b47[_0x1dac16(0x12f)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x4bc6f8){console['error'](_0x1dac16(0xdb)+_0x221b47['id']+':',_0x4bc6f8),this[_0x1dac16(0x10c)](_0x221b47['id'],_0x221b47['gatewayPaymentId'],_0x4bc6f8,_0x1dac16(0xdf),{'paymentAmount':_0x221b47['amount'],'paymentCurrency':_0x221b47[_0x1dac16(0xbe)],'shopId':_0x221b47[_0x1dac16(0x12f)],'createdAt':_0x221b47[_0x1dac16(0x126)]}),await database_1[_0x1dac16(0x161)][_0x1dac16(0xd2)][_0x1dac16(0xed)]({'data':{'paymentId':_0x221b47['id'],'shopId':_0x221b47[_0x1dac16(0x12f)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x1dac16(0x178)]({'error':_0x4bc6f8 instanceof Error?_0x4bc6f8[_0x1dac16(0xb7)]:_0x1dac16(0x10e),'gatewayPaymentId':_0x221b47[_0x1dac16(0x12e)],'checkedAt':new Date()[_0x1dac16(0xef)]()})}});}}async[a37_0x51cd1f(0x113)](_0x4953a0,_0x53bdc5){const _0x55f7b2=a37_0x51cd1f,_0xfd8525=Date[_0x55f7b2(0x9c)]();try{const _0x2ea983=_0x4953a0['shop'],_0x3b9e3a=_0x2ea983[_0x55f7b2(0x97)];if(!_0x3b9e3a?.[_0x55f7b2(0x166)]){console[_0x55f7b2(0xfb)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x2ea983['id']);return;}const _0x3f8e94=_0x53bdc5===_0x55f7b2(0x121)?_0x55f7b2(0x163):_0x53bdc5===_0x55f7b2(0xe8)?_0x55f7b2(0xda):_0x53bdc5===_0x55f7b2(0x147)?_0x55f7b2(0xda):_0x55f7b2(0x96);if(!_0x3b9e3a[_0x55f7b2(0x152)]?.[_0x55f7b2(0xc9)](_0x3f8e94)){console[_0x55f7b2(0xfb)](_0x55f7b2(0x104)+_0x3f8e94+_0x55f7b2(0x16b)+_0x2ea983['id']);return;}const _0x51aeeb={'event':_0x3f8e94,'payment':{'id':_0x4953a0['id'],'order_id':_0x4953a0[_0x55f7b2(0x145)],'gateway_order_id':_0x4953a0['gatewayOrderId'],'gateway':'0100','amount':_0x4953a0[_0x55f7b2(0x16d)],'currency':_0x4953a0[_0x55f7b2(0xbe)],'status':_0x53bdc5[_0x55f7b2(0x119)](),'customer_email':_0x4953a0[_0x55f7b2(0x13a)],'customer_name':_0x4953a0['customerName'],'created_at':_0x4953a0['createdAt'],'updated_at':new Date()}},_0x825f8b=await fetch(_0x3b9e3a[_0x55f7b2(0x166)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x55f7b2(0x157)},'body':JSON[_0x55f7b2(0x178)](_0x51aeeb)}),_0x784234=Date[_0x55f7b2(0x9c)]()-_0xfd8525,_0x2593ad=_0x825f8b['ok']?_0x55f7b2(0xce):await _0x825f8b[_0x55f7b2(0x129)]();loggerService_1['loggerService'][_0x55f7b2(0x14b)](_0x4953a0[_0x55f7b2(0x12f)],_0x3b9e3a[_0x55f7b2(0x166)],_0x3f8e94,_0x825f8b[_0x55f7b2(0xec)],_0x784234,_0x51aeeb),console['log'](_0x55f7b2(0x9f)+_0x3b9e3a['webhookUrl']+_0x55f7b2(0xf2)+_0x825f8b[_0x55f7b2(0xec)]+'\x20('+_0x784234+_0x55f7b2(0xdc));}catch(_0x1d2046){console[_0x55f7b2(0xfa)](_0x55f7b2(0x94),_0x1d2046),loggerService_1['loggerService']['logShopWebhookError'](_0x4953a0[_0x55f7b2(0x12f)],_0x4953a0[_0x55f7b2(0x120)]?.[_0x55f7b2(0x97)]?.[_0x55f7b2(0x166)]||_0x55f7b2(0x14a),_0x55f7b2(0x91),_0x1d2046,{});}}async[a37_0x51cd1f(0x153)](_0x3ce742,_0x1580b2){const _0x36a665=a37_0x51cd1f;try{const _0x4de606={'PENDING':_0x36a665(0xf6),'PAID':_0x36a665(0xf4),'FAILED':_0x36a665(0xf1),'EXPIRED':'expired'},_0x42eec2=_0x4de606[_0x1580b2];if(!_0x42eec2||_0x42eec2===_0x36a665(0xf6))return;await telegramBotService_1[_0x36a665(0x124)]['sendPaymentNotification'](_0x3ce742[_0x36a665(0x12f)],_0x3ce742,_0x42eec2);}catch(_0xfcc8a5){console[_0x36a665(0xfa)](_0x36a665(0x175),_0xfcc8a5);}}async['checkPaymentById'](_0xe3c384){const _0x2c61e1=a37_0x51cd1f;console[_0x2c61e1(0xfb)]('üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0xe3c384);const _0x4a7968=await database_1['default'][_0x2c61e1(0x11c)][_0x2c61e1(0x10f)]({'where':{'id':_0xe3c384},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4a7968)throw new Error(_0x2c61e1(0x14d));if(_0x4a7968[_0x2c61e1(0x15c)]!==_0x2c61e1(0xff))throw new Error(_0x2c61e1(0xea));console[_0x2c61e1(0xfb)](_0x2c61e1(0xbf)+_0xe3c384),await this[_0x2c61e1(0x13e)](_0x4a7968),console[_0x2c61e1(0xfb)](_0x2c61e1(0xcf)+_0xe3c384);}[a37_0x51cd1f(0x108)](){const _0x3b5095=a37_0x51cd1f,_0x509865=this['globalCheckInterval']?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x1404b3=Array[_0x3b5095(0xcb)](this[_0x3b5095(0x177)][_0x3b5095(0x110)]())[_0x3b5095(0x111)](_0x1ee213=>({'paymentId':_0x1ee213[_0x3b5095(0x16e)],'gatewayPaymentId':_0x1ee213[_0x3b5095(0x12e)],'createdAt':_0x1ee213[_0x3b5095(0x126)],'timersCount':_0x1ee213['timers'][_0x3b5095(0x103)]}));return{'isActive':!!this[_0x3b5095(0xad)],'globalCheckIntervalMinutes':this[_0x3b5095(0x170)]/(0x3e8*0x3c),'expiryDays':this[_0x3b5095(0x10a)],'activeIndividualTimers':this[_0x3b5095(0x177)][_0x3b5095(0x98)],'nextGlobalCheckIn':_0x509865,'paymentTimersDetails':_0x1404b3};}['getPaymentTimerInfo'](_0x5a8387){const _0xf29077=a37_0x51cd1f,_0x242098=this[_0xf29077(0x177)]['get'](_0x5a8387);if(_0x242098)return{'hasTimers':!![],'timersCount':_0x242098[_0xf29077(0xc1)][_0xf29077(0x103)],'createdAt':_0x242098[_0xf29077(0x126)],'gatewayPaymentId':_0x242098['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a37_0x51cd1f(0x167)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();