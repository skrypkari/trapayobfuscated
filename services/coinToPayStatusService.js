'use strict';const a35_0xb94bae=a35_0x4891;function a35_0x4891(_0x5389fa,_0x27c022){const _0x189465=a35_0x1894();return a35_0x4891=function(_0x489172,_0x32495f){_0x489172=_0x489172-0x6e;let _0x5aea07=_0x189465[_0x489172];return _0x5aea07;},a35_0x4891(_0x5389fa,_0x27c022);}(function(_0x5c0552,_0x589db2){const _0x8287a6=a35_0x4891,_0x16ddf5=_0x5c0552();while(!![]){try{const _0x425d44=-parseInt(_0x8287a6(0x133))/0x1*(parseInt(_0x8287a6(0xe2))/0x2)+parseInt(_0x8287a6(0x83))/0x3+-parseInt(_0x8287a6(0xb9))/0x4*(parseInt(_0x8287a6(0x9e))/0x5)+parseInt(_0x8287a6(0x141))/0x6*(parseInt(_0x8287a6(0x8f))/0x7)+-parseInt(_0x8287a6(0x117))/0x8*(parseInt(_0x8287a6(0xfd))/0x9)+-parseInt(_0x8287a6(0xca))/0xa+parseInt(_0x8287a6(0x12d))/0xb;if(_0x425d44===_0x589db2)break;else _0x16ddf5['push'](_0x16ddf5['shift']());}catch(_0x1f4dfc){_0x16ddf5['push'](_0x16ddf5['shift']());}}}(a35_0x1894,0xb45de));var __importDefault=this&&this[a35_0xb94bae(0x75)]||function(_0x1d09cf){return _0x1d09cf&&_0x1d09cf['__esModule']?_0x1d09cf:{'default':_0x1d09cf};};Object[a35_0xb94bae(0x92)](exports,a35_0xb94bae(0x137),{'value':!![]}),exports[a35_0xb94bae(0x131)]=exports['CoinToPayStatusService']=void 0x0;function a35_0x1894(){const _0x370c8f=['log','57909hdZVhi','checkPaymentStatus','\x20status\x20is\x20','payment.success','created','\x20individual\x20payment\x20timers','ü™ô\x20CoinToPayStatusService\x20initialized','logShopWebhookError','settings','cointopay_status_check_','paid','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','1747333hUxAGa','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','defineProperty','Success','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','webhook_send','shopId','size','FAILED','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','description','globalCheckInterval','3641465LoBUBn','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','getServiceStats','\x20status\x20changed\x20to\x20','clearPaymentTimers','\x20\x20\x20-\x20Gateway:\x20','\x20found:','ms)','customerName','GLOBAL_CHECK_INTERVAL_MS','Payment\x20not\x20found','\x20marked\x20as\x20paid\x20at:\x20','\x20not\x20found\x20in\x20database','\x20\x20\x20‚ùå\x20Error:\x20','startPeriodicStatusCheck','\x20\x20\x20-\x20Status:\x20','\x20current\x20status:\x20','application/json','\x20in\x20','\x20expired','logCoinToPayError','message','failed','checkExpiredPayments','\x20\x20\x20üìÖ\x20Time:\x20','currency','\x20has\x20no\x20gatewayPaymentId,\x20skipping','8dUwmKd','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','ü™ô\x20[GLOBAL]\x20Found\x20','\x20has\x20no\x20gatewayPaymentId','Shop\x20webhook\x20sent\x20to\x20','gateway','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','../config/database','customerEmail','\x20initial\x20timers\x20for\x20payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','5\x20minutes','status_check',',\x20clearing\x20individual\x20timers','includes','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','\x20skipped,\x20','6758340dVuBMp','from','createdOn','\x20for\x20payment\x20','CoinToPayStatusService','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','timestamp','PENDING','PAID','Automatically\x20expired\x20after\x20','sendPaymentStatusNotification','orderId','forEach','iban','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','shop','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','‚ùå\x20[HOURLY]\x20Payment\x20','checkSinglePaymentById','webhookLog','not\x20confirmed','\x20\x20\x20-\x20gatewayPaymentId:\x20','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','30wWnZba','stringify','\x20\x20\x20üìç\x20Source:\x20','\x20expired\x20CoinToPay\x20payments','./gateways/coinToPayService','length','amount','coinToPayService','\x20\x20\x20üìä\x20Status:\x20','\x20status\x20from\x20','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','\x20completed\x20for\x20payment\x20','webhookUrl','üßπ\x20[DEBUG]\x20Clearing\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20->\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','ü™ô\x20[DEBUG]\x20Creating\x20','bankDetails','\x20\x20\x20üìù\x20Details:','payment.failed','Payment\x20older\x20than\x20','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','text','\x20timers\x20for\x20payment\x20','‚úÖ\x20[EXPIRY]\x20Payment\x20','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','2569779OgQiJk','now','getPaymentTimerInfo','schedulePaymentChecks','push','getTime','payment','EXPIRED','‚úÖ\x20[HOURLY]\x20Payment\x20',',\x20stopping\x20individual\x20checks','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20is\x20too\x20new\x20(','webhookEvents','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','paymentTimers','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20seconds\x20(','create','üßπ\x20[CHECK]\x20Payment\x20','adminNotes','/status/','‚ùå\x20[CHECK]\x20Payment\x20','1\x20minute','‚úÖ\x20[CHECK]\x20Payment\x20','üìä\x20[HOURLY]\x20Payment\x20','24LWycBW','2\x20minutes','gatewayPaymentId','h),\x20skipping\x20global\x20check','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20\x20\x20-\x20ShopId:\x20','‚è∞\x20[GLOBAL]\x20Payment\x20','üìä\x20[CHECK]\x20Payment\x20','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','POST','.\x20Remaining\x20active\x20timers:\x20','stopPeriodicStatusCheck','getDate','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','cointopay','logCoinToPayStatus','\x20days,\x20marking\x20as\x20EXPIRED','values','gatewayOrderId','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20days\x20without\x20payment\x20confirmation','\x20is\x20older\x20than\x20','46402499zyEnEx','loggerService','\x20with\x20status\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','coinToPayStatusService','telegramBotService','67277nNYqCS','checkSinglePayment','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','__esModule','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','schedule_created','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','confirmedOn','cointopay_auto_expired','unknown','findUnique','‚è∞\x20[EXPIRY]\x20Payment\x20','timers','12gmNqgU','toISOString','paidAt','\x20\x20\x20üìù\x20Context:','\x20checked,\x20','status','EXPIRY_DAYS','transactionId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','delay','auto_expire','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','Bank\x20Details:\x20','remitterIban','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','createdAt','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','stack','set','TesSoft\x20Payment\x20System/1.0','floor','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20days','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','Webhook\x20event\x20','update','error','checkAllPendingPayments','\x20days\x20(created\x20before\x20','\x20triggered\x20for\x20payment\x20','__importDefault','\x20not\x20enabled\x20for\x20shop\x20','\x20not\x20found,\x20clearing\x20timers','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','paymentDetails','default','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','sendShopWebhook','sendPaymentNotification','payment.pending','\x20status\x20unchanged\x20(','\x20pending\x20CoinToPay\x20payments','\x20updated\x20successfully'];a35_0x1894=function(){return _0x370c8f;};return a35_0x1894();}const coinToPayService_1=require(a35_0xb94bae(0xe6)),database_1=__importDefault(require(a35_0xb94bae(0xc0))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x10a5c0=a35_0xb94bae;this[_0x10a5c0(0x9d)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x10a5c0(0x147)]=0x5,this['paymentTimers']=new Map(),this['coinToPayService']=new coinToPayService_1['CoinToPayService'](),console['log'](_0x10a5c0(0x89));}[a35_0xb94bae(0x100)](_0x1753dc,_0x406c5e){const _0x7bd332=a35_0xb94bae;console[_0x7bd332(0x82)](_0x7bd332(0x135)),console[_0x7bd332(0x82)]('\x20\x20\x20-\x20paymentId:\x20'+_0x1753dc),console[_0x7bd332(0x82)](_0x7bd332(0xe0)+_0x406c5e),this[_0x7bd332(0xa2)](_0x1753dc);const _0x57b7b2=[],_0x1cb627=new Date(),_0x118cda=[{'delay':0x1*0x3c*0x3e8,'description':_0x7bd332(0x114)},{'delay':0x2*0x3c*0x3e8,'description':_0x7bd332(0x118)},{'delay':0x5*0x3c*0x3e8,'description':_0x7bd332(0xc4)},{'delay':0x5*0x3c*0x3e8,'description':_0x7bd332(0xc4)}];console[_0x7bd332(0x82)](_0x7bd332(0xf3)+_0x118cda[_0x7bd332(0xe7)]+_0x7bd332(0xc2)+_0x1753dc);let _0x173e4f=0x0;_0x118cda[_0x7bd332(0xd6)]((_0x3eb614,_0xaa67e4)=>{const _0x53e329=_0x7bd332;_0x173e4f+=_0x3eb614[_0x53e329(0x14d)];const _0x24d2f8=setTimeout(async()=>{const _0x1f5b07=_0x53e329;console[_0x1f5b07(0x82)](_0x1f5b07(0xbf)+(_0xaa67e4+0x1)+_0x1f5b07(0x74)+_0x1753dc+'\x20(after\x20'+_0x3eb614['description']+')');try{await this['checkSinglePaymentById'](_0x1753dc),console[_0x1f5b07(0x82)](_0x1f5b07(0xd9)+(_0xaa67e4+0x1)+_0x1f5b07(0xed)+_0x1753dc);}catch(_0x3732e2){console[_0x1f5b07(0x71)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0xaa67e4+0x1)+_0x1f5b07(0xcd)+_0x1753dc+':',_0x3732e2),this['logCoinToPayError'](_0x1753dc,_0x406c5e,_0x3732e2,'status_check',{'checkNumber':_0xaa67e4+0x1,'scheduledAfter':_0x3eb614[_0x1f5b07(0x9c)],'isIndividualCheck':!![]});}},_0x173e4f);_0x57b7b2[_0x53e329(0x101)](_0x24d2f8),console[_0x53e329(0x82)](_0x53e329(0x9b)+(_0xaa67e4+0x1)+_0x53e329(0xcd)+_0x1753dc+_0x53e329(0xb0)+_0x173e4f/0x3e8+_0x53e329(0x10e)+_0x3eb614[_0x53e329(0x9c)]+')');});const _0xc6d87e=setInterval(async()=>{const _0x19bd16=_0x7bd332;console[_0x19bd16(0x82)](_0x19bd16(0xfc)+_0x1753dc);try{const _0x42db50=await database_1[_0x19bd16(0x7a)][_0x19bd16(0x103)][_0x19bd16(0x13e)]({'where':{'id':_0x1753dc},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x42db50){console[_0x19bd16(0x82)](_0x19bd16(0xdc)+_0x1753dc+_0x19bd16(0x77)),this[_0x19bd16(0xa2)](_0x1753dc);return;}console[_0x19bd16(0x82)](_0x19bd16(0x116)+_0x1753dc+_0x19bd16(0xae)+_0x42db50['status']);if(_0x42db50[_0x19bd16(0x146)]!==_0x19bd16(0xd1)){console[_0x19bd16(0x82)](_0x19bd16(0x105)+_0x1753dc+_0x19bd16(0x85)+_0x42db50[_0x19bd16(0x146)]+_0x19bd16(0x106)),this[_0x19bd16(0xa2)](_0x1753dc);return;}const _0x19cd51=Math[_0x19bd16(0x158)]((Date['now']()-_0x42db50['createdAt'][_0x19bd16(0x102)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x19cd51>=this[_0x19bd16(0x147)]){console[_0x19bd16(0x82)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x1753dc+_0x19bd16(0x12c)+this[_0x19bd16(0x147)]+_0x19bd16(0x152)),this[_0x19bd16(0xa2)](_0x1753dc);return;}await this[_0x19bd16(0xdd)](_0x1753dc),console[_0x19bd16(0x82)]('‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x1753dc);}catch(_0xb630ad){console[_0x19bd16(0x71)](_0x19bd16(0x107)+_0x1753dc+':',_0xb630ad),this['logCoinToPayError'](_0x1753dc,_0x406c5e,_0xb630ad,_0x19bd16(0xc5),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x57b7b2['push'](_0xc6d87e),this['paymentTimers'][_0x7bd332(0x156)](_0x1753dc,{'timers':_0x57b7b2,'paymentId':_0x1753dc,'gatewayPaymentId':_0x406c5e,'createdAt':_0x1cb627}),console[_0x7bd332(0x82)](_0x7bd332(0x10b)+_0x118cda[_0x7bd332(0xe7)]+_0x7bd332(0xf2)+_0x1753dc),console[_0x7bd332(0x82)](_0x7bd332(0x10d)+this['paymentTimers'][_0x7bd332(0x97)]),this[_0x7bd332(0x126)](_0x1753dc,_0x406c5e,_0x7bd332(0xd1),_0x7bd332(0xd1),_0x7bd332(0xc5),{'action':_0x7bd332(0x139),'scheduledChecks':_0x118cda['length'],'firstCheckIn':_0x118cda[0x0][_0x7bd332(0x14d)]/0x3e8,'totalTimers':this['paymentTimers']['size']});}['clearPaymentTimers'](_0x408b7a){const _0x4dd3d9=a35_0xb94bae,_0x45709f=this[_0x4dd3d9(0x10c)]['get'](_0x408b7a);_0x45709f?(console[_0x4dd3d9(0x82)](_0x4dd3d9(0xef)+_0x45709f[_0x4dd3d9(0x140)][_0x4dd3d9(0xe7)]+_0x4dd3d9(0xfa)+_0x408b7a),_0x45709f[_0x4dd3d9(0x140)][_0x4dd3d9(0xd6)]((_0x8835,_0x71da39)=>{const _0x438096=_0x4dd3d9;_0x8835&&(clearTimeout(_0x8835),clearInterval(_0x8835),console[_0x438096(0x82)](_0x438096(0xd8)+(_0x71da39+0x1)+'\x20for\x20payment\x20'+_0x408b7a));}),this[_0x4dd3d9(0x10c)]['delete'](_0x408b7a),console[_0x4dd3d9(0x82)]('‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x408b7a+_0x4dd3d9(0x121)+this[_0x4dd3d9(0x10c)][_0x4dd3d9(0x97)])):console['log'](_0x4dd3d9(0x14b)+_0x408b7a+'\x20to\x20clear');}async['checkSinglePaymentById'](_0x40a3f0){const _0x4edcda=a35_0xb94bae;console['log'](_0x4edcda(0x8e)+_0x40a3f0);const _0x5d1b67=await database_1[_0x4edcda(0x7a)][_0x4edcda(0x103)]['findUnique']({'where':{'id':_0x40a3f0},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5d1b67){console[_0x4edcda(0x82)](_0x4edcda(0x113)+_0x40a3f0+_0x4edcda(0xaa));return;}console[_0x4edcda(0x82)]('üìä\x20[CHECK]\x20Payment\x20'+_0x40a3f0+_0x4edcda(0xa4)),console[_0x4edcda(0x82)](_0x4edcda(0xa3)+_0x5d1b67[_0x4edcda(0xbe)]),console[_0x4edcda(0x82)](_0x4edcda(0xad)+_0x5d1b67[_0x4edcda(0x146)]),console[_0x4edcda(0x82)](_0x4edcda(0x12a)+_0x5d1b67[_0x4edcda(0x119)]),console['log']('\x20\x20\x20-\x20Amount:\x20'+_0x5d1b67['amount']+'\x20'+_0x5d1b67[_0x4edcda(0xb7)]),console[_0x4edcda(0x82)](_0x4edcda(0x11c)+_0x5d1b67[_0x4edcda(0x96)]);if(_0x5d1b67[_0x4edcda(0xbe)]!==_0x4edcda(0x125)){console[_0x4edcda(0x82)](_0x4edcda(0x14c)+_0x40a3f0+_0x4edcda(0x6e)+_0x5d1b67[_0x4edcda(0xbe)]+')');return;}if(_0x5d1b67[_0x4edcda(0x146)]!==_0x4edcda(0xd1)){console[_0x4edcda(0x82)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x40a3f0+_0x4edcda(0x85)+_0x5d1b67[_0x4edcda(0x146)]+',\x20stopping\x20individual\x20checks'),this[_0x4edcda(0xa2)](_0x40a3f0);return;}if(!_0x5d1b67[_0x4edcda(0x119)]){console[_0x4edcda(0x82)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x40a3f0+_0x4edcda(0xbc));return;}console[_0x4edcda(0x82)](_0x4edcda(0x115)+_0x40a3f0+_0x4edcda(0x108)),await this[_0x4edcda(0x134)](_0x5d1b67);}[a35_0xb94bae(0x126)](_0x5027e1,_0x4319c8,_0xe93efa,_0x33e78b,_0x58d229,_0x1c42f8){const _0x390129=a35_0xb94bae,_0x285d39={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x5027e1,'gatewayPaymentId':_0x4319c8,'oldStatus':_0xe93efa,'newStatus':_0x33e78b,'source':_0x58d229,'timestamp':new Date()[_0x390129(0x142)](),'details':_0x1c42f8||{}};loggerService_1[_0x390129(0x12e)][_0x390129(0x126)](_0x285d39),console[_0x390129(0x82)](_0x390129(0x99)+_0x5027e1+'\x20('+_0x4319c8+')'),console[_0x390129(0x82)](_0x390129(0xea)+_0xe93efa+_0x390129(0xf1)+_0x33e78b),console[_0x390129(0x82)](_0x390129(0xe4)+_0x58d229),console['log'](_0x390129(0xb6)+_0x285d39[_0x390129(0xd0)]),_0x1c42f8&&console['log'](_0x390129(0xf5),_0x1c42f8);}['logCoinToPayError'](_0x14c131,_0x2b3dbf,_0x3e8dc0,_0x258b3f,_0x3f82bd){const _0x1c3268=a35_0xb94bae,_0x4a3146={'type':'COINTOPAY_ERROR','paymentId':_0x14c131,'gatewayPaymentId':_0x2b3dbf,'error':_0x3e8dc0 instanceof Error?{'message':_0x3e8dc0[_0x1c3268(0xb3)],'stack':_0x3e8dc0[_0x1c3268(0x155)]}:_0x3e8dc0,'source':_0x258b3f,'timestamp':new Date()[_0x1c3268(0x142)](),'context':_0x3f82bd||{}};loggerService_1['loggerService'][_0x1c3268(0xb2)](_0x4a3146),console[_0x1c3268(0x71)]('ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x14c131+'\x20('+_0x2b3dbf+')'),console['error'](_0x1c3268(0xab)+(_0x3e8dc0 instanceof Error?_0x3e8dc0['message']:_0x3e8dc0)),console['error'](_0x1c3268(0xe4)+_0x258b3f),console['error'](_0x1c3268(0xb6)+_0x4a3146[_0x1c3268(0xd0)]),_0x3f82bd&&console[_0x1c3268(0x71)](_0x1c3268(0x144),_0x3f82bd);}[a35_0xb94bae(0xac)](){const _0xcc1446=a35_0xb94bae;console['log'](_0xcc1446(0x136)),this[_0xcc1446(0x72)]()['catch'](_0x389f36=>{const _0x2cc819=_0xcc1446;console[_0x2cc819(0x71)](_0x2cc819(0x9a),_0x389f36);}),this[_0xcc1446(0x9d)]=setInterval(async()=>{const _0x32544f=_0xcc1446;try{console['log']('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this['checkAllPendingPayments'](),console[_0x32544f(0x82)](_0x32544f(0x94));}catch(_0x535659){console[_0x32544f(0x71)](_0x32544f(0x159),_0x535659);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0xcc1446(0x82)](_0xcc1446(0x124));}[a35_0xb94bae(0x122)](){const _0x265a77=a35_0xb94bae;console[_0x265a77(0x82)](_0x265a77(0x11f));this[_0x265a77(0x9d)]&&(clearInterval(this['globalCheckInterval']),this[_0x265a77(0x9d)]=null,console[_0x265a77(0x82)]('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x181b43=this[_0x265a77(0x10c)][_0x265a77(0x97)];for(const [_0xe16700]of this['paymentTimers']){this['clearPaymentTimers'](_0xe16700);}console[_0x265a77(0x82)]('üõë\x20[SHUTDOWN]\x20Cleared\x20'+_0x181b43+_0x265a77(0x88));}async[a35_0xb94bae(0x72)](){const _0x34c3a0=a35_0xb94bae;try{console[_0x34c3a0(0x82)](_0x34c3a0(0xf8));const _0x4b5394=await database_1[_0x34c3a0(0x7a)]['payment']['findMany']({'where':{'gateway':_0x34c3a0(0x125),'status':_0x34c3a0(0xd1),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x34c3a0(0x82)](_0x34c3a0(0xbb)+_0x4b5394[_0x34c3a0(0xe7)]+_0x34c3a0(0x80));if(_0x4b5394[_0x34c3a0(0xe7)]===0x0){console[_0x34c3a0(0x82)](_0x34c3a0(0xe1));return;}const _0x1583c7=await this['checkExpiredPayments'](_0x4b5394);console[_0x34c3a0(0x82)]('‚è∞\x20[GLOBAL]\x20Found\x20'+_0x1583c7['length']+_0x34c3a0(0xe5));let _0x3f0ef4=0x0,_0x47392b=0x0;for(const _0x1b2607 of _0x4b5394){try{if(_0x1583c7[_0x34c3a0(0xc7)](_0x1b2607['id'])){console[_0x34c3a0(0x82)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x1b2607['id']+_0x34c3a0(0x90)),_0x47392b++;continue;}if(this[_0x34c3a0(0x10c)]['has'](_0x1b2607['id'])){console[_0x34c3a0(0x82)](_0x34c3a0(0x11d)+_0x1b2607['id']+_0x34c3a0(0xba)),_0x47392b++;continue;}const _0x544cb5=(Date['now']()-_0x1b2607[_0x34c3a0(0x153)][_0x34c3a0(0x102)]())/(0x3e8*0x3c*0x3c);if(_0x544cb5<0x1){console[_0x34c3a0(0x82)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x1b2607['id']+_0x34c3a0(0x109)+_0x544cb5['toFixed'](0x1)+_0x34c3a0(0x11a)),_0x47392b++;continue;}console[_0x34c3a0(0x82)](_0x34c3a0(0xec)+_0x1b2607['id']+'\x20(age:\x20'+_0x544cb5['toFixed'](0x1)+'h)'),await this[_0x34c3a0(0x134)](_0x1b2607),_0x3f0ef4++,await new Promise(_0x2f29f1=>setTimeout(_0x2f29f1,0x7d0));}catch(_0x210e14){console[_0x34c3a0(0x71)](_0x34c3a0(0x130)+_0x1b2607['id']+':',_0x210e14),this[_0x34c3a0(0xb2)](_0x1b2607['id'],_0x1b2607[_0x34c3a0(0x119)]||'unknown',_0x210e14,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x1b2607[_0x34c3a0(0xe8)],'paymentCurrency':_0x1b2607['currency'],'shopId':_0x1b2607['shopId'],'createdAt':_0x1b2607[_0x34c3a0(0x153)]}),loggerService_1[_0x34c3a0(0x12e)]['logWhiteDomainError'](_0x34c3a0(0x125),_0x34c3a0(0x112)+_0x1b2607['gatewayPaymentId'],_0x210e14);}}console[_0x34c3a0(0x82)](_0x34c3a0(0x14f)+_0x3f0ef4+_0x34c3a0(0x145)+_0x47392b+_0x34c3a0(0xc9)+_0x1583c7[_0x34c3a0(0xe7)]+_0x34c3a0(0xb1));}catch(_0x2d1e20){console[_0x34c3a0(0x71)](_0x34c3a0(0x78),_0x2d1e20);}}async[a35_0xb94bae(0xb5)](_0x4a3ab0){const _0x56f003=a35_0xb94bae,_0x13a0d6=[],_0x44091a=new Date();_0x44091a['setDate'](_0x44091a[_0x56f003(0x123)]()-this['EXPIRY_DAYS']),console[_0x56f003(0x82)](_0x56f003(0xdb)+this['EXPIRY_DAYS']+_0x56f003(0x73)+_0x44091a[_0x56f003(0x142)]()+')');for(const _0x41d093 of _0x4a3ab0){if(_0x41d093['createdAt']<_0x44091a){console[_0x56f003(0x82)](_0x56f003(0x13f)+_0x41d093['id']+_0x56f003(0x12c)+this[_0x56f003(0x147)]+_0x56f003(0x127));try{this['logCoinToPayStatus'](_0x41d093['id'],_0x41d093[_0x56f003(0x119)]||_0x56f003(0x13d),'PENDING','EXPIRED',_0x56f003(0x14e),{'reason':_0x56f003(0xf7)+this[_0x56f003(0x147)]+_0x56f003(0x15a),'createdAt':_0x41d093['createdAt'],'daysSinceCreation':Math[_0x56f003(0x158)]((Date[_0x56f003(0xfe)]()-_0x41d093['createdAt'][_0x56f003(0x102)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x41d093[_0x56f003(0xe8)],'paymentCurrency':_0x41d093[_0x56f003(0xb7)],'shopId':_0x41d093[_0x56f003(0x96)]}),await database_1[_0x56f003(0x7a)][_0x56f003(0x103)][_0x56f003(0x70)]({'where':{'id':_0x41d093['id']},'data':{'status':_0x56f003(0x104),'updatedAt':new Date(),'adminNotes':_0x56f003(0xd3)+this[_0x56f003(0x147)]+_0x56f003(0x12b)}}),await database_1[_0x56f003(0x7a)][_0x56f003(0xde)][_0x56f003(0x10f)]({'data':{'paymentId':_0x41d093['id'],'shopId':_0x41d093[_0x56f003(0x96)],'event':_0x56f003(0x13c),'statusCode':0xc8,'responseBody':JSON[_0x56f003(0xe3)]({'reason':_0x56f003(0xf7)+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x41d093[_0x56f003(0x153)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math['floor']((Date[_0x56f003(0xfe)]()-_0x41d093[_0x56f003(0x153)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x56f003(0x7c)](_0x41d093,'EXPIRED'),await this[_0x56f003(0xd4)](_0x41d093,_0x56f003(0x104)),this[_0x56f003(0xa2)](_0x41d093['id']),_0x13a0d6[_0x56f003(0x101)](_0x41d093['id']),console['log'](_0x56f003(0xfb)+_0x41d093['id']+_0x56f003(0x11b)+this[_0x56f003(0x147)]+'-day\x20timeout');}catch(_0x18fb3e){console[_0x56f003(0x71)](_0x56f003(0x154)+_0x41d093['id']+':',_0x18fb3e),this['logCoinToPayError'](_0x41d093['id'],_0x41d093[_0x56f003(0x119)]||_0x56f003(0x13d),_0x18fb3e,_0x56f003(0x14e),{'reason':_0x56f003(0xf0),'createdAt':_0x41d093[_0x56f003(0x153)],'daysSinceCreation':Math[_0x56f003(0x158)]((Date[_0x56f003(0xfe)]()-_0x41d093[_0x56f003(0x153)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x13a0d6;}async[a35_0xb94bae(0x134)](_0x23d910){const _0x30ed83=a35_0xb94bae;if(!_0x23d910[_0x30ed83(0x119)]){console[_0x30ed83(0x82)](_0x30ed83(0x14c)+_0x23d910['id']+_0x30ed83(0xb8));return;}console[_0x30ed83(0x82)](_0x30ed83(0xc8)+_0x23d910['id']+'\x20('+_0x23d910[_0x30ed83(0x119)]+')');try{const _0x378530=await this[_0x30ed83(0xe9)][_0x30ed83(0x84)](_0x23d910[_0x30ed83(0x119)]);console[_0x30ed83(0x82)](_0x30ed83(0x11e)+_0x23d910['id']+'\x20status:\x20'+_0x378530[_0x30ed83(0x146)]);_0x378530[_0x30ed83(0x79)]&&console[_0x30ed83(0x82)](_0x30ed83(0x11e)+_0x23d910['id']+'\x20details:',{'iban':_0x378530[_0x30ed83(0x79)][_0x30ed83(0xd7)]||'not\x20found','transactionId':_0x378530[_0x30ed83(0x79)][_0x30ed83(0x148)],'createdOn':_0x378530[_0x30ed83(0x79)][_0x30ed83(0xcc)],'confirmedOn':_0x378530[_0x30ed83(0x79)][_0x30ed83(0x13b)]||_0x30ed83(0xdf)});if(_0x378530['status']!==_0x23d910[_0x30ed83(0x146)]){console[_0x30ed83(0x82)](_0x30ed83(0x138)+_0x23d910['id']+_0x30ed83(0xeb)+_0x23d910['status']+'\x20to\x20'+_0x378530[_0x30ed83(0x146)]),this[_0x30ed83(0x126)](_0x23d910['id'],_0x23d910[_0x30ed83(0x119)],_0x23d910[_0x30ed83(0x146)],_0x378530[_0x30ed83(0x146)],_0x30ed83(0xc5),{'paymentDetails':_0x378530[_0x30ed83(0x79)],'amount':_0x378530[_0x30ed83(0xe8)],'currency':_0x378530[_0x30ed83(0xb7)],'shopId':_0x23d910[_0x30ed83(0x96)],'checkTimestamp':new Date()[_0x30ed83(0x142)]()});const _0x54b44f={'status':_0x378530['status'],'updatedAt':new Date()};_0x378530['status']==='PAID'&&_0x23d910['status']!==_0x30ed83(0xd2)&&(_0x54b44f[_0x30ed83(0x143)]=new Date(),console[_0x30ed83(0x82)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x23d910['id']+_0x30ed83(0xa9)+_0x54b44f['paidAt'][_0x30ed83(0x142)]()));if(_0x378530[_0x30ed83(0x79)]){const _0x366027=_0x378530['paymentDetails'];_0x366027[_0x30ed83(0xd7)]&&(_0x54b44f[_0x30ed83(0x151)]=_0x366027['iban'],console[_0x30ed83(0x82)](_0x30ed83(0x7b)+_0x366027[_0x30ed83(0xd7)]));if(_0x366027[_0x30ed83(0xf4)]){const _0x1515e8=_0x23d910[_0x30ed83(0x111)]||'',_0x4e3798=_0x30ed83(0x150)+_0x366027['bankDetails'];_0x54b44f[_0x30ed83(0x111)]=_0x1515e8?_0x1515e8+'\x0a\x0a'+_0x4e3798:_0x4e3798,console[_0x30ed83(0x82)]('üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x366027[_0x30ed83(0x148)]&&console[_0x30ed83(0x82)](_0x30ed83(0x14a)+_0x366027[_0x30ed83(0x148)]),_0x366027[_0x30ed83(0x13b)]&&console[_0x30ed83(0x82)](_0x30ed83(0x91)+_0x366027['confirmedOn']);}await database_1[_0x30ed83(0x7a)][_0x30ed83(0x103)][_0x30ed83(0x70)]({'where':{'id':_0x23d910['id']},'data':_0x54b44f}),await database_1[_0x30ed83(0x7a)]['webhookLog']['create']({'data':{'paymentId':_0x23d910['id'],'shopId':_0x23d910['shopId'],'event':_0x30ed83(0x8c)+_0x378530[_0x30ed83(0x146)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x23d910[_0x30ed83(0x146)],'newStatus':_0x378530[_0x30ed83(0x146)],'paymentDetails':_0x378530[_0x30ed83(0x79)],'checkedAt':new Date()[_0x30ed83(0x142)]()})}}),await this[_0x30ed83(0x7c)](_0x23d910,_0x378530['status']),await this['sendPaymentStatusNotification'](_0x23d910,_0x378530['status']),_0x378530[_0x30ed83(0x146)]!=='PENDING'&&(console[_0x30ed83(0x82)](_0x30ed83(0x110)+_0x23d910['id']+_0x30ed83(0xa1)+_0x378530[_0x30ed83(0x146)]+_0x30ed83(0xc6)),this[_0x30ed83(0xa2)](_0x23d910['id'])),console[_0x30ed83(0x82)](_0x30ed83(0x115)+_0x23d910['id']+_0x30ed83(0x81));}else console[_0x30ed83(0x82)](_0x30ed83(0x11e)+_0x23d910['id']+_0x30ed83(0x7f)+_0x378530['status']+')'),this[_0x30ed83(0x126)](_0x23d910['id'],_0x23d910[_0x30ed83(0x119)],_0x23d910[_0x30ed83(0x146)],_0x378530['status'],_0x30ed83(0xc5),{'statusUnchanged':!![],'paymentDetails':_0x378530[_0x30ed83(0x79)],'amount':_0x378530['amount'],'currency':_0x378530['currency'],'shopId':_0x23d910[_0x30ed83(0x96)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x10ac68){console['error'](_0x30ed83(0xcf)+_0x23d910['id']+':',_0x10ac68),this[_0x30ed83(0xb2)](_0x23d910['id'],_0x23d910[_0x30ed83(0x119)],_0x10ac68,'status_check',{'paymentAmount':_0x23d910[_0x30ed83(0xe8)],'paymentCurrency':_0x23d910[_0x30ed83(0xb7)],'shopId':_0x23d910[_0x30ed83(0x96)],'createdAt':_0x23d910[_0x30ed83(0x153)]}),await database_1[_0x30ed83(0x7a)][_0x30ed83(0xde)]['create']({'data':{'paymentId':_0x23d910['id'],'shopId':_0x23d910['shopId'],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x30ed83(0xe3)]({'error':_0x10ac68 instanceof Error?_0x10ac68[_0x30ed83(0xb3)]:'Unknown\x20error','gatewayPaymentId':_0x23d910['gatewayPaymentId'],'checkedAt':new Date()[_0x30ed83(0x142)]()})}});}}async['sendShopWebhook'](_0x43ca01,_0x2d8aba){const _0x510f0c=a35_0xb94bae,_0x2e5450=Date['now']();try{const _0x45dfe6=_0x43ca01[_0x510f0c(0xda)],_0x1e17d2=_0x45dfe6[_0x510f0c(0x8b)];if(!_0x1e17d2?.['webhookUrl']){console['log'](_0x510f0c(0x149)+_0x45dfe6['id']);return;}const _0x49c8b1=_0x2d8aba===_0x510f0c(0xd2)?_0x510f0c(0x86):_0x2d8aba===_0x510f0c(0x98)?_0x510f0c(0xf6):_0x2d8aba===_0x510f0c(0x104)?_0x510f0c(0xf6):_0x510f0c(0x7e);if(!_0x1e17d2[_0x510f0c(0x10a)]?.[_0x510f0c(0xc7)](_0x49c8b1)){console['log'](_0x510f0c(0x6f)+_0x49c8b1+_0x510f0c(0x76)+_0x45dfe6['id']);return;}const _0x30555a={'event':_0x49c8b1,'payment':{'id':_0x43ca01['id'],'order_id':_0x43ca01[_0x510f0c(0xd5)],'gateway_order_id':_0x43ca01[_0x510f0c(0x129)],'gateway':'0100','amount':_0x43ca01[_0x510f0c(0xe8)],'currency':_0x43ca01[_0x510f0c(0xb7)],'status':_0x2d8aba['toLowerCase'](),'customer_email':_0x43ca01[_0x510f0c(0xc1)],'customer_name':_0x43ca01[_0x510f0c(0xa6)],'created_at':_0x43ca01[_0x510f0c(0x153)],'updated_at':new Date()}},_0x2475c9=await fetch(_0x1e17d2[_0x510f0c(0xee)],{'method':_0x510f0c(0x120),'headers':{'Content-Type':_0x510f0c(0xaf),'User-Agent':_0x510f0c(0x157)},'body':JSON[_0x510f0c(0xe3)](_0x30555a)}),_0x5c2b45=Date['now']()-_0x2e5450,_0x33ec79=_0x2475c9['ok']?_0x510f0c(0x93):await _0x2475c9[_0x510f0c(0xf9)]();loggerService_1[_0x510f0c(0x12e)]['logShopWebhookSent'](_0x43ca01[_0x510f0c(0x96)],_0x1e17d2['webhookUrl'],_0x49c8b1,_0x2475c9[_0x510f0c(0x146)],_0x5c2b45,_0x30555a),console['log'](_0x510f0c(0xbd)+_0x1e17d2[_0x510f0c(0xee)]+_0x510f0c(0x12f)+_0x2475c9[_0x510f0c(0x146)]+'\x20('+_0x5c2b45+_0x510f0c(0xa5));}catch(_0x2908f3){console[_0x510f0c(0x71)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x2908f3),loggerService_1['loggerService'][_0x510f0c(0x8a)](_0x43ca01['shopId'],_0x43ca01[_0x510f0c(0xda)]?.[_0x510f0c(0x8b)]?.[_0x510f0c(0xee)]||_0x510f0c(0x13d),_0x510f0c(0x95),_0x2908f3,{});}}async[a35_0xb94bae(0xd4)](_0xda3840,_0x92a695){const _0x20004f=a35_0xb94bae;try{const _0x4d36df={'PENDING':_0x20004f(0x87),'PAID':_0x20004f(0x8d),'FAILED':_0x20004f(0xb4),'EXPIRED':'expired'},_0x42ccd6=_0x4d36df[_0x92a695];if(!_0x42ccd6||_0x42ccd6===_0x20004f(0x87))return;await telegramBotService_1[_0x20004f(0x132)][_0x20004f(0x7d)](_0xda3840['shopId'],_0xda3840,_0x42ccd6);}catch(_0x20d719){console[_0x20004f(0x71)](_0x20004f(0xc3),_0x20d719);}}async['checkPaymentById'](_0x306052){const _0x11ed38=a35_0xb94bae;console[_0x11ed38(0x82)](_0x11ed38(0x13a)+_0x306052);const _0xfa307c=await database_1['default'][_0x11ed38(0x103)][_0x11ed38(0x13e)]({'where':{'id':_0x306052},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xfa307c)throw new Error(_0x11ed38(0xa8));if(_0xfa307c[_0x11ed38(0xbe)]!==_0x11ed38(0x125))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x11ed38(0x82)]('‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x306052),await this['checkSinglePayment'](_0xfa307c),console[_0x11ed38(0x82)](_0x11ed38(0x9f)+_0x306052);}[a35_0xb94bae(0xa0)](){const _0x43d16c=a35_0xb94bae,_0x43a888=this[_0x43d16c(0x9d)]?this[_0x43d16c(0xa7)]:undefined,_0x453944=Array[_0x43d16c(0xcb)](this[_0x43d16c(0x10c)][_0x43d16c(0x128)]())['map'](_0x11fd5=>({'paymentId':_0x11fd5['paymentId'],'gatewayPaymentId':_0x11fd5['gatewayPaymentId'],'createdAt':_0x11fd5['createdAt'],'timersCount':_0x11fd5['timers'][_0x43d16c(0xe7)]}));return{'isActive':!!this[_0x43d16c(0x9d)],'globalCheckIntervalMinutes':this[_0x43d16c(0xa7)]/(0x3e8*0x3c),'expiryDays':this[_0x43d16c(0x147)],'activeIndividualTimers':this[_0x43d16c(0x10c)][_0x43d16c(0x97)],'nextGlobalCheckIn':_0x43a888,'paymentTimersDetails':_0x453944};}[a35_0xb94bae(0xff)](_0x194052){const _0x51ac7e=a35_0xb94bae,_0x356a49=this[_0x51ac7e(0x10c)]['get'](_0x194052);if(_0x356a49)return{'hasTimers':!![],'timersCount':_0x356a49[_0x51ac7e(0x140)][_0x51ac7e(0xe7)],'createdAt':_0x356a49['createdAt'],'gatewayPaymentId':_0x356a49[_0x51ac7e(0x119)]};return{'hasTimers':![]};}}exports[a35_0xb94bae(0xce)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();