'use strict';const a40_0xdd192b=a40_0x3ddd;function a40_0x50f8(){const _0x3e91ff=['paymentLink','\x20\x20\x20Amount:\x20','gatewayPaymentId','./loggerService','unknown','globalCheckInterval','gatewayCommissionRate','gatewayOrderId',',\x20status=','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','paymentTimers','sendShopWebhook','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','logCoinToPayStatus','payment.failed','coinToPayStatusService','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','\x20marked\x20as\x20paid\x20at:\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','checkAllPendingPayments','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','set','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','\x20days','‚è∞\x20[HOURLY]\x20Payment\x20','üîÑ\x20[CHECK]\x20Updating\x20payment\x20',',\x20stopping\x20individual\x20checks','coinToPay2Service','payment.success','685697EDXpei','\x20\x20\x20-\x20Gateway:\x20','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','clearPaymentTimers','/status/','cointopay','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20seconds\x20(','push','sendPaymentStatusNotification','\x20for\x20payment\x20','cointopay_status_check_error','Webhook\x20event\x20','./currencyService','üßπ\x20[DEBUG]\x20Clearing\x20','stack','checkSinglePaymentById','entries','\x20->\x20','\x20\x20\x20üìù\x20Details:','stringify','9720168iWRkpX','ms)','\x20not\x20found,\x20clearing\x20timers','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20has\x20no\x20gatewayPaymentId,\x20skipping','now','delay','commission','payment','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','1928163QQlnWd','currencyService','payment.pending','defineProperty','created','\x20\x20\x20Amount\x20after\x20commission:\x20','error','\x20not\x20enabled\x20for\x20shop\x20','stopPeriodicStatusCheck','confirmedOn','logWhiteDomainError','forEach','coinToPayService','status','EXPIRED','2\x20minutes','SINGLE','bankDetails','transactionId','expired','‚úÖ\x20[EXPIRY]\x20Payment\x20','auto_expire','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20updated\x20successfully','Success','\x20USDT','5402965qalMIG','‚è∞\x20[EXPIRY]\x20Payment\x20',',\x20using\x20default\x2010%','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','Bank\x20Details:\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','toISOString','üîç\x20[CHECK]\x20Checking\x20','\x20is\x20older\x20than\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20is\x20valid\x20for\x20checking,\x20proceeding...','schedule_created','üìä\x20[HOURLY]\x20Payment\x20','Payment\x20older\x20than\x20','floor','getTime','\x20\x20\x20-\x20Status:\x20','PENDING','\x20\x20\x20-\x20ShopId:\x20','COINTOPAY_STATUS_CHANGE','update','\x20triggered\x20for\x20payment\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','webhook_send','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','shop','create','length','__esModule','CoinToPayStatusService','from','\x20amounts\x20calculated:','Payment\x20not\x20found','values','toLowerCase','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','paidAt','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','__importDefault','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','parse','loggerService','1\x20minute','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20to\x20','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','cointopay_auto_expired','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','ü™ô\x20[GLOBAL]\x20Found\x20','toFixed','6SyOXru','2340471qfvOwB','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','webhookEvents','checkSinglePayment','\x20individual\x20payment\x20timers','üìà\x20[COINTOPAY]\x20Payment\x20','‚ùå\x20[HOURLY]\x20Payment\x20','convertToUSDT','createdOn','\x20skipped,\x20','TesSoft\x20Payment\x20System/1.0','schedulePaymentChecks','getGatewayIdByName','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','has','gatewaySettings','‚úÖ\x20[CHECK]\x20Payment\x20','paymentDetails','cointopay_status_check_','‚è∞\x20[GLOBAL]\x20Found\x20','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','message','\x20details:','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','üìä\x20[CHECK]\x20Payment\x20','\x20expired','setDate','\x20\x20\x20üìç\x20Source:\x20','\x20status:\x20','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','5455624PgdVEX','‚è∞\x20[GLOBAL]\x20Payment\x20','logCoinToPayError','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','\x20payment\x20','CoinToPayService','./telegramBotService','cointopay2','default','findUnique','timestamp','\x20in\x20shop\x20','-day\x20timeout','amountUSDT','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','5\x20minutes','adminNotes','currentPayments','paymentLinkId','size','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20not\x20found\x20in\x20database','log','\x20in\x20','amountAfterGatewayCommissionUSDT','webhookUrl','.\x20Remaining\x20active\x20timers:\x20','settings','\x20commission:\x20','webhookLog','description','currency','createdAt','Shop\x20webhook\x20sent\x20to\x20','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20(age:\x20',',\x20using\x20default\x20commission\x2010%','status_check','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','get','gateway','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','iban','\x20initial\x20timers\x20for\x20payment\x20','\x20status\x20from\x20','EXPIRY_DAYS','\x20status\x20unchanged\x20(','catch','\x20\x20\x20-\x20paymentId:\x20','\x20\x20\x20üìÖ\x20Time:\x20','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','paymentId','PAID','telegramBotService','\x20\x20\x20üìù\x20Context:','not\x20confirmed',',\x20currentPayments=','checkPaymentById','application/json','findMany','delete','./gateways/coinToPayService','CoinToPay2Service',',\x20gateway\x20','sendPaymentNotification','1315454qVHUzm','GLOBAL_CHECK_INTERVAL_MS','COINTOPAY_ERROR','\x20\x20\x20Gateway\x20','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','timers','\x20expired\x20CoinToPay\x20payments','h),\x20skipping\x20global\x20check','failed','type','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20status\x20is\x20','COMPLETED','getDate','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','shopId','\x20to\x20clear','\x20is\x20too\x20new\x20(','üí∞\x20[CHECK]\x20Payment\x20','amount','\x20updated:\x20currentPayments=','ü™ô\x20[DEBUG]\x20Creating\x20','orderId','text','\x20commission\x20for\x20shop\x20','\x20checked,\x20','checkPaymentStatus','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20current\x20status:\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'];a40_0x50f8=function(){return _0x3e91ff;};return a40_0x50f8();}(function(_0x2f2274,_0x55d545){const _0x497912=a40_0x3ddd,_0x22df1b=_0x2f2274();while(!![]){try{const _0x3640ac=parseInt(_0x497912(0x25d))/0x1+parseInt(_0x497912(0x220))/0x2+parseInt(_0x497912(0x27c))/0x3+parseInt(_0x497912(0x2e9))/0x4+-parseInt(_0x497912(0x296))/0x5*(parseInt(_0x497912(0x2c9))/0x6)+-parseInt(_0x497912(0x2ca))/0x7+-parseInt(_0x497912(0x272))/0x8;if(_0x3640ac===_0x55d545)break;else _0x22df1b['push'](_0x22df1b['shift']());}catch(_0x4e0d02){_0x22df1b['push'](_0x22df1b['shift']());}}}(a40_0x50f8,0xafcd4));function a40_0x3ddd(_0x14b33c,_0x241be1){const _0x50f883=a40_0x50f8();return a40_0x3ddd=function(_0x3dddfc,_0x4c6ba4){_0x3dddfc=_0x3dddfc-0x1e8;let _0xa1e9d9=_0x50f883[_0x3dddfc];return _0xa1e9d9;},a40_0x3ddd(_0x14b33c,_0x241be1);}var __importDefault=this&&this[a40_0xdd192b(0x2bc)]||function(_0x59ec97){const _0x28a2be=a40_0xdd192b;return _0x59ec97&&_0x59ec97[_0x28a2be(0x2b2)]?_0x59ec97:{'default':_0x59ec97};};Object[a40_0xdd192b(0x27f)](exports,a40_0xdd192b(0x2b2),{'value':!![]}),exports['coinToPayStatusService']=exports[a40_0xdd192b(0x2b3)]=void 0x0;const coinToPayService_1=require(a40_0xdd192b(0x21c)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require('../types/gateway'),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a40_0xdd192b(0x2ef)),loggerService_1=require(a40_0xdd192b(0x243)),currencyService_1=require(a40_0xdd192b(0x26a));class CoinToPayStatusService{constructor(){const _0x471dde=a40_0xdd192b;this[_0x471dde(0x245)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x471dde(0x20b)]=0x5,this[_0x471dde(0x24a)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x471dde(0x2ee))](),this[_0x471dde(0x25b)]=new coinToPay2Service_1[(_0x471dde(0x21d))](),console[_0x471dde(0x1f4)](_0x471dde(0x2cb));}[a40_0xdd192b(0x2d5)](_0x58c8ef,_0xdad771){const _0x3d7bb7=a40_0xdd192b;console[_0x3d7bb7(0x1f4)](_0x3d7bb7(0x200)),console[_0x3d7bb7(0x1f4)](_0x3d7bb7(0x20e)+_0x58c8ef),console[_0x3d7bb7(0x1f4)](_0x3d7bb7(0x252)+_0xdad771),this['clearPaymentTimers'](_0x58c8ef);const _0x2f5df5=[],_0x16abcc=new Date(),_0x4131fe=[{'delay':0x1*0x3c*0x3e8,'description':_0x3d7bb7(0x2c0)},{'delay':0x2*0x3c*0x3e8,'description':_0x3d7bb7(0x28b)},{'delay':0x5*0x3c*0x3e8,'description':_0x3d7bb7(0x1ec)},{'delay':0x5*0x3c*0x3e8,'description':_0x3d7bb7(0x1ec)}];console['log'](_0x3d7bb7(0x236)+_0x4131fe['length']+_0x3d7bb7(0x209)+_0x58c8ef);let _0x522329=0x0;_0x4131fe[_0x3d7bb7(0x287)]((_0x217d9b,_0x207584)=>{const _0x30f0df=_0x3d7bb7;_0x522329+=_0x217d9b[_0x30f0df(0x278)];const _0x3431e1=setTimeout(async()=>{const _0x1dfc92=_0x30f0df;console[_0x1dfc92(0x1f4)](_0x1dfc92(0x2de)+(_0x207584+0x1)+_0x1dfc92(0x2ab)+_0x58c8ef+'\x20(after\x20'+_0x217d9b['description']+')');try{await this[_0x1dfc92(0x26d)](_0x58c8ef),console[_0x1dfc92(0x1f4)]('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x207584+0x1)+'\x20completed\x20for\x20payment\x20'+_0x58c8ef);}catch(_0x187f81){console[_0x1dfc92(0x282)](_0x1dfc92(0x250)+(_0x207584+0x1)+_0x1dfc92(0x267)+_0x58c8ef+':',_0x187f81),this[_0x1dfc92(0x2eb)](_0x58c8ef,_0xdad771,_0x187f81,_0x1dfc92(0x203),{'checkNumber':_0x207584+0x1,'scheduledAfter':_0x217d9b[_0x1dfc92(0x1fc)],'isIndividualCheck':!![]});}},_0x522329);_0x2f5df5['push'](_0x3431e1),console[_0x30f0df(0x1f4)](_0x30f0df(0x27b)+(_0x207584+0x1)+'\x20for\x20payment\x20'+_0x58c8ef+_0x30f0df(0x1f5)+_0x522329/0x3e8+_0x30f0df(0x264)+_0x217d9b[_0x30f0df(0x1fc)]+')');});const _0x584054=setInterval(async()=>{const _0x1af5db=_0x3d7bb7;console['log'](_0x1af5db(0x25f)+_0x58c8ef);try{const _0x302ba9=await database_1['default'][_0x1af5db(0x27a)]['findUnique']({'where':{'id':_0x58c8ef},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x302ba9){console[_0x1af5db(0x1f4)](_0x1af5db(0x2d0)+_0x58c8ef+_0x1af5db(0x274)),this[_0x1af5db(0x260)](_0x58c8ef);return;}console[_0x1af5db(0x1f4)](_0x1af5db(0x2a2)+_0x58c8ef+_0x1af5db(0x23e)+_0x302ba9[_0x1af5db(0x289)]);if(_0x302ba9[_0x1af5db(0x289)]!=='PENDING'){console[_0x1af5db(0x1f4)]('‚úÖ\x20[HOURLY]\x20Payment\x20'+_0x58c8ef+_0x1af5db(0x22b)+_0x302ba9[_0x1af5db(0x289)]+_0x1af5db(0x25a)),this[_0x1af5db(0x260)](_0x58c8ef);return;}const _0x14a946=Math[_0x1af5db(0x2a4)]((Date[_0x1af5db(0x277)]()-_0x302ba9['createdAt'][_0x1af5db(0x2a5)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x14a946>=this[_0x1af5db(0x20b)]){console[_0x1af5db(0x1f4)](_0x1af5db(0x258)+_0x58c8ef+_0x1af5db(0x29e)+this['EXPIRY_DAYS']+_0x1af5db(0x22a)),this[_0x1af5db(0x260)](_0x58c8ef);return;}await this['checkSinglePaymentById'](_0x58c8ef),console['log'](_0x1af5db(0x224)+_0x58c8ef);}catch(_0x170430){console['error'](_0x1af5db(0x1eb)+_0x58c8ef+':',_0x170430),this['logCoinToPayError'](_0x58c8ef,_0xdad771,_0x170430,_0x1af5db(0x203),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x2f5df5['push'](_0x584054),this['paymentTimers'][_0x3d7bb7(0x255)](_0x58c8ef,{'timers':_0x2f5df5,'paymentId':_0x58c8ef,'gatewayPaymentId':_0xdad771,'createdAt':_0x16abcc}),console['log'](_0x3d7bb7(0x2c4)+_0x4131fe[_0x3d7bb7(0x2b1)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x58c8ef),console['log'](_0x3d7bb7(0x207)+this[_0x3d7bb7(0x24a)][_0x3d7bb7(0x1f0)]),this[_0x3d7bb7(0x24d)](_0x58c8ef,_0xdad771,_0x3d7bb7(0x2a7),_0x3d7bb7(0x2a7),_0x3d7bb7(0x203),{'action':_0x3d7bb7(0x2a1),'scheduledChecks':_0x4131fe[_0x3d7bb7(0x2b1)],'firstCheckIn':_0x4131fe[0x0]['delay']/0x3e8,'totalTimers':this[_0x3d7bb7(0x24a)][_0x3d7bb7(0x1f0)]});}['clearPaymentTimers'](_0x13b7ab){const _0xb9f194=a40_0xdd192b,_0x1dc1c0=this[_0xb9f194(0x24a)][_0xb9f194(0x205)](_0x13b7ab);_0x1dc1c0?(console[_0xb9f194(0x1f4)](_0xb9f194(0x26b)+_0x1dc1c0[_0xb9f194(0x225)]['length']+'\x20timers\x20for\x20payment\x20'+_0x13b7ab),_0x1dc1c0[_0xb9f194(0x225)][_0xb9f194(0x287)]((_0x5a6adb,_0x9cf424)=>{const _0x401687=_0xb9f194;_0x5a6adb&&(clearTimeout(_0x5a6adb),clearInterval(_0x5a6adb),console[_0x401687(0x1f4)](_0x401687(0x29f)+(_0x9cf424+0x1)+_0x401687(0x267)+_0x13b7ab));}),this[_0xb9f194(0x24a)][_0xb9f194(0x21b)](_0x13b7ab),console[_0xb9f194(0x1f4)](_0xb9f194(0x2e7)+_0x13b7ab+_0xb9f194(0x1f8)+this[_0xb9f194(0x24a)][_0xb9f194(0x1f0)])):console[_0xb9f194(0x1f4)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x13b7ab+_0xb9f194(0x231));}async['checkSinglePaymentById'](_0x356184){const _0x5bc715=a40_0xdd192b;console[_0x5bc715(0x1f4)](_0x5bc715(0x2c3)+_0x356184);const _0xe1fbaf=await database_1['default'][_0x5bc715(0x27a)][_0x5bc715(0x2f2)]({'where':{'id':_0x356184},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xe1fbaf){console[_0x5bc715(0x1f4)]('‚ùå\x20[CHECK]\x20Payment\x20'+_0x356184+_0x5bc715(0x1f3));return;}console[_0x5bc715(0x1f4)](_0x5bc715(0x2e2)+_0x356184+'\x20found:'),console[_0x5bc715(0x1f4)](_0x5bc715(0x25e)+_0xe1fbaf[_0x5bc715(0x206)]),console[_0x5bc715(0x1f4)](_0x5bc715(0x2a6)+_0xe1fbaf[_0x5bc715(0x289)]),console['log']('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0xe1fbaf[_0x5bc715(0x242)]),console[_0x5bc715(0x1f4)]('\x20\x20\x20-\x20Amount:\x20'+_0xe1fbaf[_0x5bc715(0x234)]+'\x20'+_0xe1fbaf[_0x5bc715(0x1fd)]),console[_0x5bc715(0x1f4)](_0x5bc715(0x2a8)+_0xe1fbaf['shopId']);if(_0xe1fbaf[_0x5bc715(0x206)]!=='cointopay'&&_0xe1fbaf[_0x5bc715(0x206)]!==_0x5bc715(0x2f0)){console[_0x5bc715(0x1f4)](_0x5bc715(0x204)+_0x356184+_0x5bc715(0x2b9)+_0xe1fbaf[_0x5bc715(0x206)]+')');return;}if(_0xe1fbaf[_0x5bc715(0x289)]!==_0x5bc715(0x2a7)){console[_0x5bc715(0x1f4)](_0x5bc715(0x204)+_0x356184+_0x5bc715(0x22b)+_0xe1fbaf[_0x5bc715(0x289)]+_0x5bc715(0x25a)),this[_0x5bc715(0x260)](_0x356184);return;}if(!_0xe1fbaf[_0x5bc715(0x242)]){console[_0x5bc715(0x1f4)](_0x5bc715(0x204)+_0x356184+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x5bc715(0x1f4)](_0x5bc715(0x2da)+_0x356184+_0x5bc715(0x2a0)),await this['checkSinglePayment'](_0xe1fbaf);}[a40_0xdd192b(0x24d)](_0x213c2e,_0x152fe4,_0x1aa504,_0x26a399,_0x3ca804,_0x1c0e6c){const _0xe9f2cd=a40_0xdd192b,_0x52eb30={'type':_0xe9f2cd(0x2a9),'paymentId':_0x213c2e,'gatewayPaymentId':_0x152fe4,'oldStatus':_0x1aa504,'newStatus':_0x26a399,'source':_0x3ca804,'timestamp':new Date()[_0xe9f2cd(0x29c)](),'details':_0x1c0e6c||{}};loggerService_1[_0xe9f2cd(0x2bf)][_0xe9f2cd(0x24d)](_0x52eb30),console[_0xe9f2cd(0x1f4)](_0xe9f2cd(0x23f)+_0x213c2e+'\x20('+_0x152fe4+')'),console[_0xe9f2cd(0x1f4)]('\x20\x20\x20üìä\x20Status:\x20'+_0x1aa504+_0xe9f2cd(0x26f)+_0x26a399),console[_0xe9f2cd(0x1f4)](_0xe9f2cd(0x2e5)+_0x3ca804),console[_0xe9f2cd(0x1f4)](_0xe9f2cd(0x20f)+_0x52eb30[_0xe9f2cd(0x2f3)]),_0x1c0e6c&&console[_0xe9f2cd(0x1f4)](_0xe9f2cd(0x270),_0x1c0e6c);}[a40_0xdd192b(0x2eb)](_0x2c2341,_0x5e6f3a,_0x5cee11,_0x3749ff,_0x560ffa){const _0x55308b=a40_0xdd192b,_0x1dd9d8={'type':_0x55308b(0x222),'paymentId':_0x2c2341,'gatewayPaymentId':_0x5e6f3a,'error':_0x5cee11 instanceof Error?{'message':_0x5cee11[_0x55308b(0x2df)],'stack':_0x5cee11[_0x55308b(0x26c)]}:_0x5cee11,'source':_0x3749ff,'timestamp':new Date()[_0x55308b(0x29c)](),'context':_0x560ffa||{}};loggerService_1[_0x55308b(0x2bf)][_0x55308b(0x2eb)](_0x1dd9d8),console['error'](_0x55308b(0x1f1)+_0x2c2341+'\x20('+_0x5e6f3a+')'),console[_0x55308b(0x282)]('\x20\x20\x20‚ùå\x20Error:\x20'+(_0x5cee11 instanceof Error?_0x5cee11['message']:_0x5cee11)),console[_0x55308b(0x282)](_0x55308b(0x2e5)+_0x3749ff),console[_0x55308b(0x282)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x1dd9d8[_0x55308b(0x2f3)]),_0x560ffa&&console[_0x55308b(0x282)](_0x55308b(0x215),_0x560ffa);}['startPeriodicStatusCheck'](){const _0x1349cb=a40_0xdd192b;console[_0x1349cb(0x1f4)](_0x1349cb(0x2e8)),this[_0x1349cb(0x253)]()[_0x1349cb(0x20d)](_0x4fa80e=>{const _0x106458=_0x1349cb;console['error'](_0x106458(0x275),_0x4fa80e);}),this[_0x1349cb(0x245)]=setInterval(async()=>{const _0x50c201=_0x1349cb;try{console[_0x50c201(0x1f4)]('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this['checkAllPendingPayments'](),console[_0x50c201(0x1f4)](_0x50c201(0x211));}catch(_0x2f6928){console[_0x50c201(0x282)](_0x50c201(0x23c),_0x2f6928);}},this[_0x1349cb(0x221)]),console[_0x1349cb(0x1f4)](_0x1349cb(0x29b));}[a40_0xdd192b(0x284)](){const _0x8e17e1=a40_0xdd192b;console[_0x8e17e1(0x1f4)]('üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x8e17e1(0x245)]&&(clearInterval(this['globalCheckInterval']),this[_0x8e17e1(0x245)]=null,console[_0x8e17e1(0x1f4)](_0x8e17e1(0x263)));const _0x461713=this[_0x8e17e1(0x24a)][_0x8e17e1(0x1f0)];for(const [_0x155b77]of this[_0x8e17e1(0x24a)]){this[_0x8e17e1(0x260)](_0x155b77);}console[_0x8e17e1(0x1f4)]('üõë\x20[SHUTDOWN]\x20Cleared\x20'+_0x461713+_0x8e17e1(0x2ce));}async['checkAllPendingPayments'](){const _0x49a484=a40_0xdd192b;try{console[_0x49a484(0x1f4)]('ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x570536=await database_1[_0x49a484(0x2f1)][_0x49a484(0x27a)][_0x49a484(0x21a)]({'where':{'gateway':{'in':[_0x49a484(0x262),'cointopay2']},'status':_0x49a484(0x2a7),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x49a484(0x1f4)](_0x49a484(0x2c7)+_0x570536[_0x49a484(0x2b1)]+'\x20pending\x20CoinToPay\x20payments');if(_0x570536[_0x49a484(0x2b1)]===0x0){console[_0x49a484(0x1f4)](_0x49a484(0x2d7));return;}const _0x4dc5c5=await this['checkExpiredPayments'](_0x570536);console[_0x49a484(0x1f4)](_0x49a484(0x2dd)+_0x4dc5c5[_0x49a484(0x2b1)]+_0x49a484(0x226));let _0x5d7b64=0x0,_0x3c3040=0x0;for(const _0x188681 of _0x570536){try{if(_0x4dc5c5['includes'](_0x188681['id'])){console[_0x49a484(0x1f4)](_0x49a484(0x2ea)+_0x188681['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x3c3040++;continue;}if(this[_0x49a484(0x24a)][_0x49a484(0x2d8)](_0x188681['id'])){console['log'](_0x49a484(0x2ea)+_0x188681['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x3c3040++;continue;}const _0x5963f6=(Date['now']()-_0x188681[_0x49a484(0x1fe)][_0x49a484(0x2a5)]())/(0x3e8*0x3c*0x3c);if(_0x5963f6<0x1){console[_0x49a484(0x1f4)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x188681['id']+_0x49a484(0x232)+_0x5963f6[_0x49a484(0x2c8)](0x1)+_0x49a484(0x227)),_0x3c3040++;continue;}console[_0x49a484(0x1f4)](_0x49a484(0x24c)+_0x188681['id']+_0x49a484(0x201)+_0x5963f6[_0x49a484(0x2c8)](0x1)+'h)'),await this[_0x49a484(0x2cd)](_0x188681),_0x5d7b64++,await new Promise(_0x489e2e=>setTimeout(_0x489e2e,0x7d0));}catch(_0x1df8d1){console[_0x49a484(0x282)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x188681['id']+':',_0x1df8d1),this[_0x49a484(0x2eb)](_0x188681['id'],_0x188681[_0x49a484(0x242)]||'unknown',_0x1df8d1,_0x49a484(0x203),{'isGlobalCheck':!![],'paymentAmount':_0x188681['amount'],'paymentCurrency':_0x188681[_0x49a484(0x1fd)],'shopId':_0x188681[_0x49a484(0x230)],'createdAt':_0x188681[_0x49a484(0x1fe)]}),loggerService_1[_0x49a484(0x2bf)][_0x49a484(0x286)](_0x49a484(0x262),_0x49a484(0x261)+_0x188681['gatewayPaymentId'],_0x1df8d1);}}console['log'](_0x49a484(0x22e)+_0x5d7b64+_0x49a484(0x23a)+_0x3c3040+_0x49a484(0x2d3)+_0x4dc5c5[_0x49a484(0x2b1)]+_0x49a484(0x2e3));}catch(_0x52a1f3){console[_0x49a484(0x282)](_0x49a484(0x292),_0x52a1f3);}}async['checkExpiredPayments'](_0x2638fb){const _0xef8248=a40_0xdd192b,_0x2f019d=[],_0x588681=new Date();_0x588681[_0xef8248(0x2e4)](_0x588681[_0xef8248(0x22d)]()-this[_0xef8248(0x20b)]),console[_0xef8248(0x1f4)](_0xef8248(0x2ae)+this[_0xef8248(0x20b)]+'\x20days\x20(created\x20before\x20'+_0x588681['toISOString']()+')');for(const _0x4ec191 of _0x2638fb){if(_0x4ec191[_0xef8248(0x1fe)]<_0x588681){console['log'](_0xef8248(0x297)+_0x4ec191['id']+'\x20is\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0xef8248(0x24d)](_0x4ec191['id'],_0x4ec191[_0xef8248(0x242)]||_0xef8248(0x244),_0xef8248(0x2a7),'EXPIRED',_0xef8248(0x291),{'reason':_0xef8248(0x2a3)+this['EXPIRY_DAYS']+_0xef8248(0x257),'createdAt':_0x4ec191['createdAt'],'daysSinceCreation':Math[_0xef8248(0x2a4)]((Date[_0xef8248(0x277)]()-_0x4ec191[_0xef8248(0x1fe)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x4ec191['amount'],'paymentCurrency':_0x4ec191['currency'],'shopId':_0x4ec191['shopId']}),await database_1[_0xef8248(0x2f1)]['payment'][_0xef8248(0x2aa)]({'where':{'id':_0x4ec191['id']},'data':{'status':_0xef8248(0x28a),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0xef8248(0x20b)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0xef8248(0x2f1)][_0xef8248(0x1fb)][_0xef8248(0x2b0)]({'data':{'paymentId':_0x4ec191['id'],'shopId':_0x4ec191[_0xef8248(0x230)],'event':_0xef8248(0x2c5),'statusCode':0xc8,'responseBody':JSON[_0xef8248(0x271)]({'reason':_0xef8248(0x2a3)+this['EXPIRY_DAYS']+_0xef8248(0x257),'createdAt':_0x4ec191[_0xef8248(0x1fe)],'expiredAt':new Date()[_0xef8248(0x29c)](),'daysSinceCreation':Math[_0xef8248(0x2a4)]((Date[_0xef8248(0x277)]()-_0x4ec191[_0xef8248(0x1fe)][_0xef8248(0x2a5)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0xef8248(0x24b)](_0x4ec191,_0xef8248(0x28a)),await this[_0xef8248(0x266)](_0x4ec191,_0xef8248(0x28a)),this['clearPaymentTimers'](_0x4ec191['id']),_0x2f019d[_0xef8248(0x265)](_0x4ec191['id']),console['log'](_0xef8248(0x290)+_0x4ec191['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0xef8248(0x20b)]+_0xef8248(0x1e9));}catch(_0x53a400){console[_0xef8248(0x282)](_0xef8248(0x2e1)+_0x4ec191['id']+':',_0x53a400),this[_0xef8248(0x2eb)](_0x4ec191['id'],_0x4ec191['gatewayPaymentId']||_0xef8248(0x244),_0x53a400,_0xef8248(0x291),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x4ec191[_0xef8248(0x1fe)],'daysSinceCreation':Math['floor']((Date[_0xef8248(0x277)]()-_0x4ec191[_0xef8248(0x1fe)][_0xef8248(0x2a5)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x2f019d;}async['checkSinglePayment'](_0x49657c){const _0x575ff5=a40_0xdd192b;if(!_0x49657c['gatewayPaymentId']){console[_0x575ff5(0x1f4)](_0x575ff5(0x204)+_0x49657c['id']+_0x575ff5(0x276));return;}console[_0x575ff5(0x1f4)](_0x575ff5(0x29d)+_0x49657c['gateway']+'\x20payment\x20'+_0x49657c['id']+'\x20('+_0x49657c[_0x575ff5(0x242)]+')');try{let _0x4f73a4;_0x49657c['gateway']==='cointopay2'?(_0x4f73a4=await this[_0x575ff5(0x25b)][_0x575ff5(0x23b)](_0x49657c['gatewayPaymentId']),console[_0x575ff5(0x1f4)]('üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x49657c['id']+_0x575ff5(0x2e6)+_0x4f73a4['status'])):(_0x4f73a4=await this[_0x575ff5(0x288)][_0x575ff5(0x23b)](_0x49657c[_0x575ff5(0x242)]),console['log'](_0x575ff5(0x2c1)+_0x49657c['id']+_0x575ff5(0x2e6)+_0x4f73a4[_0x575ff5(0x289)]));_0x4f73a4['paymentDetails']&&console[_0x575ff5(0x1f4)](_0x575ff5(0x2e2)+_0x49657c['id']+_0x575ff5(0x2e0),{'iban':_0x4f73a4['paymentDetails'][_0x575ff5(0x208)]||'not\x20found','transactionId':_0x4f73a4[_0x575ff5(0x2db)][_0x575ff5(0x28e)],'createdOn':_0x4f73a4['paymentDetails'][_0x575ff5(0x2d2)],'confirmedOn':_0x4f73a4['paymentDetails'][_0x575ff5(0x285)]||_0x575ff5(0x216)});if(_0x4f73a4['status']!==_0x49657c[_0x575ff5(0x289)]){console[_0x575ff5(0x1f4)](_0x575ff5(0x259)+_0x49657c['id']+_0x575ff5(0x20a)+_0x49657c[_0x575ff5(0x289)]+_0x575ff5(0x2c2)+_0x4f73a4['status']),this[_0x575ff5(0x24d)](_0x49657c['id'],_0x49657c[_0x575ff5(0x242)],_0x49657c[_0x575ff5(0x289)],_0x4f73a4['status'],'status_check',{'paymentDetails':_0x4f73a4[_0x575ff5(0x2db)],'amount':_0x4f73a4['amount'],'currency':_0x4f73a4[_0x575ff5(0x1fd)],'shopId':_0x49657c[_0x575ff5(0x230)],'checkTimestamp':new Date()[_0x575ff5(0x29c)]()});const _0x35da37={'status':_0x4f73a4[_0x575ff5(0x289)],'updatedAt':new Date()};if(_0x4f73a4[_0x575ff5(0x289)]==='PAID'&&_0x49657c[_0x575ff5(0x289)]!==_0x575ff5(0x213)){_0x35da37[_0x575ff5(0x2ba)]=new Date();if(!_0x49657c['amountUSDT']){const _0xb3d89d=await currencyService_1[_0x575ff5(0x27d)][_0x575ff5(0x2d1)](_0x49657c[_0x575ff5(0x234)],_0x49657c[_0x575ff5(0x1fd)]);_0x35da37[_0x575ff5(0x1ea)]=_0xb3d89d;const _0x57592f=await this['getGatewayCommission'](_0x49657c[_0x575ff5(0x230)],_0x49657c[_0x575ff5(0x206)]),_0x550407=_0xb3d89d*(0x1-_0x57592f/0x64);_0x35da37[_0x575ff5(0x1f6)]=_0x550407,_0x35da37[_0x575ff5(0x246)]=_0x57592f,console['log'](_0x575ff5(0x233)+_0x49657c['id']+_0x575ff5(0x2b5)),console[_0x575ff5(0x1f4)](_0x575ff5(0x241)+_0x49657c[_0x575ff5(0x234)]+'\x20'+_0x49657c[_0x575ff5(0x1fd)]+_0x575ff5(0x26f)+_0xb3d89d['toFixed'](0x6)+_0x575ff5(0x295)),console[_0x575ff5(0x1f4)](_0x575ff5(0x223)+_0x49657c['gateway']+_0x575ff5(0x1fa)+_0x57592f+'%'),console[_0x575ff5(0x1f4)](_0x575ff5(0x281)+_0x550407['toFixed'](0x6)+_0x575ff5(0x295));}console[_0x575ff5(0x1f4)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x49657c['id']+_0x575ff5(0x251)+_0x35da37['paidAt'][_0x575ff5(0x29c)]());}if(_0x4f73a4[_0x575ff5(0x2db)]){const _0x20f8a8=_0x4f73a4[_0x575ff5(0x2db)];_0x20f8a8['iban']&&(_0x35da37['remitterIban']=_0x20f8a8[_0x575ff5(0x208)],console[_0x575ff5(0x1f4)](_0x575ff5(0x249)+_0x20f8a8['iban']));if(_0x20f8a8[_0x575ff5(0x28d)]){const _0x358979=_0x49657c[_0x575ff5(0x1ed)]||'',_0x4807c4=_0x575ff5(0x29a)+_0x20f8a8['bankDetails'];_0x35da37[_0x575ff5(0x1ed)]=_0x358979?_0x358979+'\x0a\x0a'+_0x4807c4:_0x4807c4,console[_0x575ff5(0x1f4)](_0x575ff5(0x299));}_0x20f8a8['transactionId']&&console[_0x575ff5(0x1f4)](_0x575ff5(0x256)+_0x20f8a8[_0x575ff5(0x28e)]),_0x20f8a8[_0x575ff5(0x285)]&&console[_0x575ff5(0x1f4)](_0x575ff5(0x22f)+_0x20f8a8[_0x575ff5(0x285)]);}await database_1[_0x575ff5(0x2f1)][_0x575ff5(0x27a)][_0x575ff5(0x2aa)]({'where':{'id':_0x49657c['id']},'data':_0x35da37});if(_0x4f73a4['status']==='PAID'&&_0x49657c[_0x575ff5(0x289)]!==_0x575ff5(0x213)){console['log'](_0x575ff5(0x2cf)+_0x49657c['id']+_0x575ff5(0x254));const _0xd7b0e8=await database_1[_0x575ff5(0x2f1)]['payment'][_0x575ff5(0x2f2)]({'where':{'id':_0x49657c['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0xd7b0e8?.[_0x575ff5(0x1ef)]&&_0xd7b0e8[_0x575ff5(0x240)])try{const _0x5f057e=_0xd7b0e8[_0x575ff5(0x240)];console[_0x575ff5(0x1f4)]('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x5f057e['id']+':\x20type='+_0x5f057e[_0x575ff5(0x229)]+_0x575ff5(0x217)+_0x5f057e['currentPayments']+_0x575ff5(0x248)+_0x5f057e[_0x575ff5(0x289)]);const _0x346cb9=_0x5f057e[_0x575ff5(0x1ee)]+0x1,_0x17b428=_0x5f057e['type']===_0x575ff5(0x28c)?_0x575ff5(0x22c):_0x5f057e['status'];await database_1[_0x575ff5(0x2f1)][_0x575ff5(0x240)][_0x575ff5(0x2aa)]({'where':{'id':_0x5f057e['id']},'data':{'currentPayments':_0x346cb9,'status':_0x17b428,'updatedAt':new Date()}}),console[_0x575ff5(0x1f4)]('‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20'+_0x5f057e['id']+_0x575ff5(0x235)+_0x5f057e[_0x575ff5(0x1ee)]+_0x575ff5(0x26f)+_0x346cb9+_0x575ff5(0x248)+_0x5f057e[_0x575ff5(0x289)]+_0x575ff5(0x26f)+_0x17b428);}catch(_0x4526f5){console[_0x575ff5(0x282)](_0x575ff5(0x2c6),_0x4526f5);}else console[_0x575ff5(0x1f4)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x49657c['id']+_0x575ff5(0x2ac));}await database_1[_0x575ff5(0x2f1)][_0x575ff5(0x1fb)][_0x575ff5(0x2b0)]({'data':{'paymentId':_0x49657c['id'],'shopId':_0x49657c[_0x575ff5(0x230)],'event':_0x575ff5(0x2dc)+_0x4f73a4[_0x575ff5(0x289)][_0x575ff5(0x2b8)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x49657c['status'],'newStatus':_0x4f73a4['status'],'paymentDetails':_0x4f73a4['paymentDetails'],'checkedAt':new Date()[_0x575ff5(0x29c)]()})}}),await this['sendShopWebhook'](_0x49657c,_0x4f73a4[_0x575ff5(0x289)]),await this[_0x575ff5(0x266)](_0x49657c,_0x4f73a4[_0x575ff5(0x289)]),_0x4f73a4[_0x575ff5(0x289)]!==_0x575ff5(0x2a7)&&(console[_0x575ff5(0x1f4)]('üßπ\x20[CHECK]\x20Payment\x20'+_0x49657c['id']+'\x20status\x20changed\x20to\x20'+_0x4f73a4[_0x575ff5(0x289)]+',\x20clearing\x20individual\x20timers'),this[_0x575ff5(0x260)](_0x49657c['id'])),console[_0x575ff5(0x1f4)](_0x575ff5(0x2da)+_0x49657c['id']+_0x575ff5(0x293));}else console[_0x575ff5(0x1f4)](_0x575ff5(0x2e2)+_0x49657c['id']+_0x575ff5(0x20c)+_0x4f73a4[_0x575ff5(0x289)]+')'),this['logCoinToPayStatus'](_0x49657c['id'],_0x49657c[_0x575ff5(0x242)],_0x49657c['status'],_0x4f73a4['status'],_0x575ff5(0x203),{'statusUnchanged':!![],'paymentDetails':_0x4f73a4['paymentDetails'],'amount':_0x4f73a4['amount'],'currency':_0x4f73a4[_0x575ff5(0x1fd)],'shopId':_0x49657c['shopId'],'checkTimestamp':new Date()[_0x575ff5(0x29c)]()});}catch(_0x26df06){console[_0x575ff5(0x282)]('‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x49657c['id']+':',_0x26df06),this[_0x575ff5(0x2eb)](_0x49657c['id'],_0x49657c[_0x575ff5(0x242)],_0x26df06,_0x575ff5(0x203),{'paymentAmount':_0x49657c[_0x575ff5(0x234)],'paymentCurrency':_0x49657c[_0x575ff5(0x1fd)],'shopId':_0x49657c[_0x575ff5(0x230)],'createdAt':_0x49657c[_0x575ff5(0x1fe)]}),await database_1[_0x575ff5(0x2f1)][_0x575ff5(0x1fb)][_0x575ff5(0x2b0)]({'data':{'paymentId':_0x49657c['id'],'shopId':_0x49657c[_0x575ff5(0x230)],'event':_0x575ff5(0x268),'statusCode':0x1f4,'responseBody':JSON[_0x575ff5(0x271)]({'error':_0x26df06 instanceof Error?_0x26df06[_0x575ff5(0x2df)]:'Unknown\x20error','gatewayPaymentId':_0x49657c[_0x575ff5(0x242)],'checkedAt':new Date()[_0x575ff5(0x29c)]()})}});}}async[a40_0xdd192b(0x24b)](_0x10a776,_0x333ef5){const _0x4ddb67=a40_0xdd192b,_0x29b2cd=Date[_0x4ddb67(0x277)]();try{const _0x3404d0=_0x10a776[_0x4ddb67(0x2af)],_0x3fd622=_0x3404d0['settings'];if(!_0x3fd622?.[_0x4ddb67(0x1f7)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3404d0['id']);return;}const _0x4687d7=_0x333ef5===_0x4ddb67(0x213)?_0x4ddb67(0x25c):_0x333ef5==='FAILED'?_0x4ddb67(0x24e):_0x333ef5==='EXPIRED'?'payment.failed':_0x4ddb67(0x27e);if(!_0x3fd622[_0x4ddb67(0x2cc)]?.['includes'](_0x4687d7)){console[_0x4ddb67(0x1f4)](_0x4ddb67(0x269)+_0x4687d7+_0x4ddb67(0x283)+_0x3404d0['id']);return;}const _0x50aa29=(0x0,gateway_1[_0x4ddb67(0x2d6)])(_0x10a776[_0x4ddb67(0x206)])||_0x10a776['gateway'],_0x24b364={'event':_0x4687d7,'payment':{'id':_0x10a776['id'],'order_id':_0x10a776[_0x4ddb67(0x237)],'gateway_order_id':_0x10a776[_0x4ddb67(0x247)],'gateway':_0x50aa29,'amount':_0x10a776[_0x4ddb67(0x234)],'currency':_0x10a776['currency'],'status':_0x333ef5[_0x4ddb67(0x2b8)](),'customer_email':_0x10a776['customerEmail'],'customer_name':_0x10a776['customerName'],'created_at':_0x10a776['createdAt'],'updated_at':new Date()}},_0x2dcd31=await fetch(_0x3fd622['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x4ddb67(0x219),'User-Agent':_0x4ddb67(0x2d4)},'body':JSON[_0x4ddb67(0x271)](_0x24b364)}),_0x2bb3b8=Date[_0x4ddb67(0x277)]()-_0x29b2cd,_0x522201=_0x2dcd31['ok']?_0x4ddb67(0x294):await _0x2dcd31[_0x4ddb67(0x238)]();loggerService_1[_0x4ddb67(0x2bf)]['logShopWebhookSent'](_0x10a776[_0x4ddb67(0x230)],_0x3fd622[_0x4ddb67(0x1f7)],_0x4687d7,_0x2dcd31[_0x4ddb67(0x289)],_0x2bb3b8,_0x24b364),console[_0x4ddb67(0x1f4)](_0x4ddb67(0x1ff)+_0x3fd622[_0x4ddb67(0x1f7)]+'\x20with\x20status\x20'+_0x2dcd31['status']+'\x20('+_0x2bb3b8+_0x4ddb67(0x273));}catch(_0x4d50a6){console[_0x4ddb67(0x282)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x4d50a6),loggerService_1[_0x4ddb67(0x2bf)]['logShopWebhookError'](_0x10a776[_0x4ddb67(0x230)],_0x10a776[_0x4ddb67(0x2af)]?.[_0x4ddb67(0x1f9)]?.[_0x4ddb67(0x1f7)]||'unknown',_0x4ddb67(0x2ad),_0x4d50a6,{});}}async[a40_0xdd192b(0x266)](_0x378bbb,_0x593f5c){const _0x234bd6=a40_0xdd192b;try{const _0x21b341={'PENDING':'created','PAID':'paid','FAILED':_0x234bd6(0x228),'EXPIRED':_0x234bd6(0x28f)},_0x6b9d51=_0x21b341[_0x593f5c];if(!_0x6b9d51||_0x6b9d51===_0x234bd6(0x280))return;await telegramBotService_1[_0x234bd6(0x214)][_0x234bd6(0x21f)](_0x378bbb[_0x234bd6(0x230)],_0x378bbb,_0x6b9d51);}catch(_0x3a4910){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x3a4910);}}async[a40_0xdd192b(0x218)](_0x37d604){const _0x24fba0=a40_0xdd192b;console[_0x24fba0(0x1f4)](_0x24fba0(0x23d)+_0x37d604);const _0x56d9fa=await database_1[_0x24fba0(0x2f1)][_0x24fba0(0x27a)][_0x24fba0(0x2f2)]({'where':{'id':_0x37d604},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x56d9fa)throw new Error(_0x24fba0(0x2b6));if(_0x56d9fa[_0x24fba0(0x206)]!=='cointopay'&&_0x56d9fa['gateway']!==_0x24fba0(0x2f0))throw new Error(_0x24fba0(0x210));console[_0x24fba0(0x1f4)](_0x24fba0(0x2ec)+_0x56d9fa[_0x24fba0(0x206)]+_0x24fba0(0x2ed)+_0x37d604),await this['checkSinglePayment'](_0x56d9fa),console[_0x24fba0(0x1f4)](_0x24fba0(0x1f2)+_0x37d604);}['getServiceStats'](){const _0x289f06=a40_0xdd192b,_0x46a421=this[_0x289f06(0x245)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x1dc096=Array[_0x289f06(0x2b4)](this[_0x289f06(0x24a)][_0x289f06(0x2b7)]())['map'](_0x2f50a8=>({'paymentId':_0x2f50a8[_0x289f06(0x212)],'gatewayPaymentId':_0x2f50a8[_0x289f06(0x242)],'createdAt':_0x2f50a8[_0x289f06(0x1fe)],'timersCount':_0x2f50a8[_0x289f06(0x225)][_0x289f06(0x2b1)]}));return{'isActive':!!this[_0x289f06(0x245)],'globalCheckIntervalMinutes':this[_0x289f06(0x221)]/(0x3e8*0x3c),'expiryDays':this[_0x289f06(0x20b)],'activeIndividualTimers':this[_0x289f06(0x24a)][_0x289f06(0x1f0)],'nextGlobalCheckIn':_0x46a421,'paymentTimersDetails':_0x1dc096};}['getPaymentTimerInfo'](_0x4a5623){const _0x345c13=a40_0xdd192b,_0x2202e4=this[_0x345c13(0x24a)][_0x345c13(0x205)](_0x4a5623);if(_0x2202e4)return{'hasTimers':!![],'timersCount':_0x2202e4[_0x345c13(0x225)][_0x345c13(0x2b1)],'createdAt':_0x2202e4[_0x345c13(0x1fe)],'gatewayPaymentId':_0x2202e4[_0x345c13(0x242)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0x443ea5,_0xadf8eb){const _0x1c5843=a40_0xdd192b;try{const _0x4f5e0c=await database_1['default']['shop']['findUnique']({'where':{'id':_0x443ea5},'select':{'gatewaySettings':!![]}});if(!_0x4f5e0c?.[_0x1c5843(0x2d9)])return console[_0x1c5843(0x1f4)](_0x1c5843(0x2bb)+_0x443ea5+_0x1c5843(0x202)),0xa;const _0xb7de70=JSON[_0x1c5843(0x2be)](_0x4f5e0c[_0x1c5843(0x2d9)]);for(const [_0x3c4052,_0x2460bc]of Object[_0x1c5843(0x26e)](_0xb7de70)){if(_0x3c4052['toLowerCase']()===_0xadf8eb['toLowerCase']()){const _0x5a88d8=_0x2460bc[_0x1c5843(0x279)]||0xa;return console[_0x1c5843(0x1f4)]('Gateway\x20'+_0xadf8eb+_0x1c5843(0x239)+_0x443ea5+':\x20'+_0x5a88d8+'%'),_0x5a88d8;}}return console[_0x1c5843(0x1f4)]('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0xadf8eb+_0x1c5843(0x1e8)+_0x443ea5+_0x1c5843(0x298)),0xa;}catch(_0x16c7fa){return console[_0x1c5843(0x282)](_0x1c5843(0x2bd)+_0x443ea5+_0x1c5843(0x21e)+_0xadf8eb+':',_0x16c7fa),0xa;}}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a40_0xdd192b(0x24f)]=new CoinToPayStatusService();