'use strict';function a35_0x20da(){const _0x2ced73=['startPeriodicStatusCheck','auto_expire','paymentId','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','set','\x20is\x20too\x20new\x20(','findUnique','POST','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','error','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','✅\x20[HOURLY]\x20Payment\x20','⏰\x20[GLOBAL]\x20Payment\x20','payment.pending','🪙\x20[DEBUG]\x20Creating\x20','6DhEdAG','getTime','globalCheckInterval','has','⏰\x20[HOURLY]\x20Payment\x20','created','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','CoinToPayService','72FEpWrx','__esModule','1202PMTJeC','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','Success','checkPaymentStatus','494548XucZlt','\x20is\x20older\x20than\x20','Payment\x20older\x20than\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','Bank\x20Details:\x20','__importDefault','clearPaymentTimers','logWhiteDomainError','paymentTimers','🪙\x20[TIMER]\x20Individual\x20check\x20#','179366PABddU','paid','update','-day\x20timeout','checkAllPendingPayments','4030719mIDIkZ','❌\x20[HOURLY]\x20Payment\x20','\x20for\x20payment\x20','\x20\x20\x20-\x20paymentId:\x20','\x20\x20\x20📝\x20Details:','\x20marked\x20as\x20paid\x20at:\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20\x20\x20-\x20ShopId:\x20','Unknown\x20error','\x20\x20\x20📊\x20Status:\x20','payment','\x20->\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','gateway','Automatically\x20expired\x20after\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20\x20\x20-\x20Amount:\x20','\x20status\x20changed\x20to\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','checkExpiredPayments','\x20expired\x20CoinToPay\x20payments','cointopay_auto_expired','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','bankDetails','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','schedulePaymentChecks','confirmedOn','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20\x20\x20❌\x20Error:\x20','loggerService','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','toLowerCase','getDate','shopId','⏰\x20[EXPIRY]\x20Payment\x20','logCoinToPayError','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','checkSinglePayment','paidAt','EXPIRED','webhookUrl','webhook_send','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20triggered\x20for\x20payment\x20','cointopay_status_check_','description','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','coinToPayService','findMany','adminNotes','default','status','expired','\x20with\x20status\x20','checkSinglePaymentById','customerName','logCoinToPayStatus','⏰\x20[GLOBAL]\x20Found\x20','toISOString','CoinToPayStatusService','\x20individual\x20payment\x20timers','floor','\x20updated\x20successfully','transactionId','\x20\x20\x20📝\x20Context:','catch','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','createdAt','5641056wBmYSm','push','../config/database','📊\x20[CHECK]\x20Payment\x20','🪙\x20[GLOBAL]\x20Found\x20','✅\x20[EXPIRY]\x20Payment\x20','failed','📊\x20[HOURLY]\x20Payment\x20','\x20to\x20','\x20current\x20status:\x20','COINTOPAY_ERROR','TesSoft\x20Payment\x20System/1.0','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','get','getPaymentTimerInfo','46808hiOMgN','log','⚠️\x20[CHECK]\x20Payment\x20','text','includes','909HkyNeN','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20days,\x20marking\x20as\x20EXPIRED','\x20in\x20','0100','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','stringify','webhookLog','✅\x20[CHECK]\x20Payment\x20','createdOn','\x20not\x20enabled\x20for\x20shop\x20','./telegramBotService','paymentDetails',',\x20stopping\x20individual\x20checks','iban','🔄\x20[CHECK]\x20Updating\x20payment\x20','\x20status\x20is\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','\x20status\x20unchanged\x20(','15994620IACDev','h),\x20skipping\x20global\x20check','\x20\x20\x20📍\x20Source:\x20','1\x20minute','\x20details:','\x20\x20\x20📅\x20Time:\x20','GLOBAL_CHECK_INTERVAL_MS','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','settings','\x20has\x20no\x20gatewayPaymentId,\x20skipping','🧹\x20[CHECK]\x20Payment\x20','.\x20Remaining\x20active\x20timers:\x20','cointopay','PENDING','\x20days','Payment\x20not\x20found','timers','\x20timers\x20for\x20payment\x20','\x20\x20\x20-\x20Status:\x20','getServiceStats','\x20found:','length','create','payment.success','size','\x20initial\x20timers\x20for\x20payment\x20','currency','\x20pending\x20CoinToPay\x20payments','✅\x20[TIMER]\x20Individual\x20check\x20#',',\x20clearing\x20individual\x20timers','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','2\x20minutes','\x20(age:\x20','stack','\x20not\x20found,\x20clearing\x20timers','🧹\x20[DEBUG]\x20Clearing\x20','497ssCcrd','\x20\x20\x20-\x20Gateway:\x20','shop','\x20to\x20clear','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','schedule_created','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20status:\x20','35QPUdDl','5\x20minutes','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','gatewayPaymentId','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','amount','sendPaymentNotification','EXPIRY_DAYS','values','sendPaymentStatusNotification','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','not\x20confirmed','from','forEach','now','payment.failed','./loggerService','❌\x20[CHECK]\x20Payment\x20','unknown','defineProperty','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','logShopWebhookSent','PAID','status_check','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','application/json','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','message'];a35_0x20da=function(){return _0x2ced73;};return a35_0x20da();}const a35_0x5b1535=a35_0x48cd;(function(_0x90b4b,_0x157f6c){const _0x261628=a35_0x48cd,_0x333ae3=_0x90b4b();while(!![]){try{const _0x46fe5f=-parseInt(_0x261628(0x166))/0x1*(-parseInt(_0x261628(0x1a6))/0x2)+-parseInt(_0x261628(0x200))/0x3+parseInt(_0x261628(0x1aa))/0x4*(parseInt(_0x261628(0x16e))/0x5)+parseInt(_0x261628(0x19b))/0x6*(parseInt(_0x261628(0x1b9))/0x7)+-parseInt(_0x261628(0x20f))/0x8*(parseInt(_0x261628(0x214))/0x9)+parseInt(_0x261628(0x227))/0xa+parseInt(_0x261628(0x1b4))/0xb*(parseInt(_0x261628(0x1a4))/0xc);if(_0x46fe5f===_0x157f6c)break;else _0x333ae3['push'](_0x333ae3['shift']());}catch(_0x316dfb){_0x333ae3['push'](_0x333ae3['shift']());}}}(a35_0x20da,0xebd50));var __importDefault=this&&this[a35_0x5b1535(0x1af)]||function(_0x20db08){return _0x20db08&&_0x20db08['__esModule']?_0x20db08:{'default':_0x20db08};};Object[a35_0x5b1535(0x182)](exports,a35_0x5b1535(0x1a5),{'value':!![]}),exports['coinToPayStatusService']=exports[a35_0x5b1535(0x1f7)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a35_0x5b1535(0x202))),telegramBotService_1=require(a35_0x5b1535(0x21f)),loggerService_1=require(a35_0x5b1535(0x17f));class CoinToPayStatusService{constructor(){const _0x59e831=a35_0x5b1535;this[_0x59e831(0x19d)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x59e831(0x176)]=0x5,this[_0x59e831(0x1b2)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x59e831(0x1a3))](),console[_0x59e831(0x210)]('🪙\x20CoinToPayStatusService\x20initialized');}[a35_0x5b1535(0x1d4)](_0x10d8a5,_0x586eab){const _0x18e5c4=a35_0x5b1535;console['log'](_0x18e5c4(0x1e6)),console[_0x18e5c4(0x210)](_0x18e5c4(0x1bc)+_0x10d8a5),console[_0x18e5c4(0x210)](_0x18e5c4(0x1bf)+_0x586eab),this[_0x18e5c4(0x1b0)](_0x10d8a5);const _0x194c30=[],_0x598182=new Date(),_0x599368=[{'delay':0x1*0x3c*0x3e8,'description':_0x18e5c4(0x22a)},{'delay':0x2*0x3c*0x3e8,'description':_0x18e5c4(0x161)},{'delay':0x5*0x3c*0x3e8,'description':_0x18e5c4(0x16f)},{'delay':0x5*0x3c*0x3e8,'description':_0x18e5c4(0x16f)}];console['log'](_0x18e5c4(0x19a)+_0x599368[_0x18e5c4(0x23c)]+_0x18e5c4(0x240)+_0x10d8a5);let _0xeb0c9d=0x0;_0x599368[_0x18e5c4(0x17c)]((_0x33d388,_0x40eedc)=>{const _0x2ec046=_0x18e5c4;_0xeb0c9d+=_0x33d388['delay'];const _0x6d5e15=setTimeout(async()=>{const _0x1fa8e5=a35_0x48cd;console[_0x1fa8e5(0x210)](_0x1fa8e5(0x1b3)+(_0x40eedc+0x1)+_0x1fa8e5(0x1e7)+_0x10d8a5+'\x20(after\x20'+_0x33d388[_0x1fa8e5(0x1e9)]+')');try{await this[_0x1fa8e5(0x1f2)](_0x10d8a5),console[_0x1fa8e5(0x210)](_0x1fa8e5(0x15e)+(_0x40eedc+0x1)+'\x20completed\x20for\x20payment\x20'+_0x10d8a5);}catch(_0x2becfb){console[_0x1fa8e5(0x194)]('❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x40eedc+0x1)+_0x1fa8e5(0x1bb)+_0x10d8a5+':',_0x2becfb),this[_0x1fa8e5(0x1de)](_0x10d8a5,_0x586eab,_0x2becfb,_0x1fa8e5(0x186),{'checkNumber':_0x40eedc+0x1,'scheduledAfter':_0x33d388[_0x1fa8e5(0x1e9)],'isIndividualCheck':!![]});}},_0xeb0c9d);_0x194c30[_0x2ec046(0x201)](_0x6d5e15),console[_0x2ec046(0x210)](_0x2ec046(0x1d3)+(_0x40eedc+0x1)+_0x2ec046(0x1bb)+_0x10d8a5+_0x2ec046(0x217)+_0xeb0c9d/0x3e8+'\x20seconds\x20('+_0x33d388['description']+')');});const _0x37c30e=setInterval(async()=>{const _0x3d7032=_0x18e5c4;console[_0x3d7032(0x210)](_0x3d7032(0x219)+_0x10d8a5);try{const _0x4a51d2=await database_1[_0x3d7032(0x1ee)]['payment'][_0x3d7032(0x191)]({'where':{'id':_0x10d8a5},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x4a51d2){console[_0x3d7032(0x210)](_0x3d7032(0x1ba)+_0x10d8a5+_0x3d7032(0x164)),this[_0x3d7032(0x1b0)](_0x10d8a5);return;}console['log'](_0x3d7032(0x207)+_0x10d8a5+_0x3d7032(0x209)+_0x4a51d2['status']);if(_0x4a51d2[_0x3d7032(0x1ef)]!==_0x3d7032(0x234)){console[_0x3d7032(0x210)](_0x3d7032(0x197)+_0x10d8a5+_0x3d7032(0x224)+_0x4a51d2['status']+',\x20stopping\x20individual\x20checks'),this[_0x3d7032(0x1b0)](_0x10d8a5);return;}const _0x3f19f5=Math[_0x3d7032(0x1f9)]((Date[_0x3d7032(0x17d)]()-_0x4a51d2[_0x3d7032(0x1ff)][_0x3d7032(0x19c)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x3f19f5>=this['EXPIRY_DAYS']){console['log'](_0x3d7032(0x19f)+_0x10d8a5+_0x3d7032(0x1ab)+this['EXPIRY_DAYS']+_0x3d7032(0x173)),this['clearPaymentTimers'](_0x10d8a5);return;}await this[_0x3d7032(0x1f2)](_0x10d8a5),console[_0x3d7032(0x210)](_0x3d7032(0x1ad)+_0x10d8a5);}catch(_0x372cf2){console[_0x3d7032(0x194)](_0x3d7032(0x1df)+_0x10d8a5+':',_0x372cf2),this['logCoinToPayError'](_0x10d8a5,_0x586eab,_0x372cf2,_0x3d7032(0x186),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x194c30[_0x18e5c4(0x201)](_0x37c30e),this['paymentTimers'][_0x18e5c4(0x18f)](_0x10d8a5,{'timers':_0x194c30,'paymentId':_0x10d8a5,'gatewayPaymentId':_0x586eab,'createdAt':_0x598182}),console[_0x18e5c4(0x210)](_0x18e5c4(0x1c6)+_0x599368[_0x18e5c4(0x23c)]+_0x18e5c4(0x195)+_0x10d8a5),console[_0x18e5c4(0x210)](_0x18e5c4(0x215)+this[_0x18e5c4(0x1b2)][_0x18e5c4(0x23f)]),this[_0x18e5c4(0x1f4)](_0x10d8a5,_0x586eab,'PENDING',_0x18e5c4(0x234),_0x18e5c4(0x186),{'action':_0x18e5c4(0x16b),'scheduledChecks':_0x599368['length'],'firstCheckIn':_0x599368[0x0]['delay']/0x3e8,'totalTimers':this[_0x18e5c4(0x1b2)][_0x18e5c4(0x23f)]});}[a35_0x5b1535(0x1b0)](_0x14c75e){const _0x1887df=a35_0x5b1535,_0x35ae3b=this[_0x1887df(0x1b2)][_0x1887df(0x20d)](_0x14c75e);_0x35ae3b?(console['log'](_0x1887df(0x165)+_0x35ae3b[_0x1887df(0x237)][_0x1887df(0x23c)]+_0x1887df(0x238)+_0x14c75e),_0x35ae3b[_0x1887df(0x237)][_0x1887df(0x17c)]((_0x2c4326,_0x50cf8d)=>{const _0x40c677=_0x1887df;_0x2c4326&&(clearTimeout(_0x2c4326),clearInterval(_0x2c4326),console[_0x40c677(0x210)]('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x50cf8d+0x1)+_0x40c677(0x1bb)+_0x14c75e));}),this['paymentTimers']['delete'](_0x14c75e),console[_0x1887df(0x210)](_0x1887df(0x1d9)+_0x14c75e+_0x1887df(0x232)+this['paymentTimers'][_0x1887df(0x23f)])):console[_0x1887df(0x210)](_0x1887df(0x1c0)+_0x14c75e+_0x1887df(0x169));}async[a35_0x5b1535(0x1f2)](_0x421701){const _0x5e116a=a35_0x5b1535;console['log'](_0x5e116a(0x1cc)+_0x421701);const _0x200f85=await database_1[_0x5e116a(0x1ee)][_0x5e116a(0x1c4)][_0x5e116a(0x191)]({'where':{'id':_0x421701},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x200f85){console['log'](_0x5e116a(0x180)+_0x421701+'\x20not\x20found\x20in\x20database');return;}console[_0x5e116a(0x210)](_0x5e116a(0x203)+_0x421701+_0x5e116a(0x23b)),console[_0x5e116a(0x210)](_0x5e116a(0x167)+_0x200f85[_0x5e116a(0x1c7)]),console[_0x5e116a(0x210)](_0x5e116a(0x239)+_0x200f85[_0x5e116a(0x1ef)]),console['log']('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x200f85['gatewayPaymentId']),console[_0x5e116a(0x210)](_0x5e116a(0x1ca)+_0x200f85[_0x5e116a(0x174)]+'\x20'+_0x200f85[_0x5e116a(0x241)]),console['log'](_0x5e116a(0x1c1)+_0x200f85[_0x5e116a(0x1dc)]);if(_0x200f85[_0x5e116a(0x1c7)]!==_0x5e116a(0x233)){console[_0x5e116a(0x210)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x421701+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x200f85['gateway']+')');return;}if(_0x200f85[_0x5e116a(0x1ef)]!=='PENDING'){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x421701+'\x20status\x20is\x20'+_0x200f85[_0x5e116a(0x1ef)]+_0x5e116a(0x221)),this['clearPaymentTimers'](_0x421701);return;}if(!_0x200f85['gatewayPaymentId']){console[_0x5e116a(0x210)](_0x5e116a(0x211)+_0x421701+'\x20has\x20no\x20gatewayPaymentId');return;}console['log'](_0x5e116a(0x21c)+_0x421701+_0x5e116a(0x1a2)),await this['checkSinglePayment'](_0x200f85);}[a35_0x5b1535(0x1f4)](_0x34dee6,_0x2adf65,_0x5382e8,_0x5a50e4,_0x562117,_0x56c519){const _0x373d3f=a35_0x5b1535,_0x16cab0={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x34dee6,'gatewayPaymentId':_0x2adf65,'oldStatus':_0x5382e8,'newStatus':_0x5a50e4,'source':_0x562117,'timestamp':new Date()[_0x373d3f(0x1f6)](),'details':_0x56c519||{}};loggerService_1[_0x373d3f(0x1d8)]['logCoinToPayStatus'](_0x16cab0),console['log'](_0x373d3f(0x160)+_0x34dee6+'\x20('+_0x2adf65+')'),console[_0x373d3f(0x210)](_0x373d3f(0x1c3)+_0x5382e8+_0x373d3f(0x1c5)+_0x5a50e4),console[_0x373d3f(0x210)](_0x373d3f(0x229)+_0x562117),console[_0x373d3f(0x210)](_0x373d3f(0x22c)+_0x16cab0['timestamp']),_0x56c519&&console[_0x373d3f(0x210)](_0x373d3f(0x1bd),_0x56c519);}['logCoinToPayError'](_0x451a6b,_0xdc8fa0,_0x6c0fb0,_0x8a5827,_0x171678){const _0x54fe55=a35_0x5b1535,_0x1d6e59={'type':_0x54fe55(0x20a),'paymentId':_0x451a6b,'gatewayPaymentId':_0xdc8fa0,'error':_0x6c0fb0 instanceof Error?{'message':_0x6c0fb0[_0x54fe55(0x18a)],'stack':_0x6c0fb0[_0x54fe55(0x163)]}:_0x6c0fb0,'source':_0x8a5827,'timestamp':new Date()[_0x54fe55(0x1f6)](),'context':_0x171678||{}};loggerService_1[_0x54fe55(0x1d8)][_0x54fe55(0x1de)](_0x1d6e59),console['error'](_0x54fe55(0x22e)+_0x451a6b+'\x20('+_0xdc8fa0+')'),console[_0x54fe55(0x194)](_0x54fe55(0x1d7)+(_0x6c0fb0 instanceof Error?_0x6c0fb0[_0x54fe55(0x18a)]:_0x6c0fb0)),console[_0x54fe55(0x194)]('\x20\x20\x20📍\x20Source:\x20'+_0x8a5827),console[_0x54fe55(0x194)](_0x54fe55(0x22c)+_0x1d6e59['timestamp']),_0x171678&&console[_0x54fe55(0x194)](_0x54fe55(0x1fc),_0x171678);}[a35_0x5b1535(0x18b)](){const _0x348731=a35_0x5b1535;console['log']('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x348731(0x1b8)]()[_0x348731(0x1fd)](_0xa2e835=>{const _0x1f8a70=_0x348731;console[_0x1f8a70(0x194)](_0x1f8a70(0x172),_0xa2e835);}),this[_0x348731(0x19d)]=setInterval(async()=>{const _0x29bc59=_0x348731;try{console[_0x29bc59(0x210)](_0x29bc59(0x1c9)),await this[_0x29bc59(0x1b8)](),console[_0x29bc59(0x210)](_0x29bc59(0x193));}catch(_0x2938e1){console[_0x29bc59(0x194)](_0x29bc59(0x1e0),_0x2938e1);}},this[_0x348731(0x22d)]),console[_0x348731(0x210)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}['stopPeriodicStatusCheck'](){const _0x1dd90c=a35_0x5b1535;console[_0x1dd90c(0x210)](_0x1dd90c(0x170));this['globalCheckInterval']&&(clearInterval(this[_0x1dd90c(0x19d)]),this[_0x1dd90c(0x19d)]=null,console[_0x1dd90c(0x210)](_0x1dd90c(0x1d1)));const _0x89a9f3=this['paymentTimers'][_0x1dd90c(0x23f)];for(const [_0x571753]of this[_0x1dd90c(0x1b2)]){this[_0x1dd90c(0x1b0)](_0x571753);}console[_0x1dd90c(0x210)]('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x89a9f3+_0x1dd90c(0x1f8));}async['checkAllPendingPayments'](){const _0x11dd27=a35_0x5b1535;try{console[_0x11dd27(0x210)](_0x11dd27(0x196));const _0x4becc9=await database_1[_0x11dd27(0x1ee)][_0x11dd27(0x1c4)][_0x11dd27(0x1ec)]({'where':{'gateway':'cointopay','status':_0x11dd27(0x234),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x11dd27(0x210)](_0x11dd27(0x204)+_0x4becc9[_0x11dd27(0x23c)]+_0x11dd27(0x242));if(_0x4becc9[_0x11dd27(0x23c)]===0x0){console[_0x11dd27(0x210)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x2a1773=await this[_0x11dd27(0x1cd)](_0x4becc9);console[_0x11dd27(0x210)](_0x11dd27(0x1f5)+_0x2a1773['length']+_0x11dd27(0x1ce));let _0x48fcc5=0x0,_0x1d146f=0x0;for(const _0x6f4e9e of _0x4becc9){try{if(_0x2a1773[_0x11dd27(0x213)](_0x6f4e9e['id'])){console[_0x11dd27(0x210)](_0x11dd27(0x198)+_0x6f4e9e['id']+_0x11dd27(0x18e)),_0x1d146f++;continue;}if(this[_0x11dd27(0x1b2)][_0x11dd27(0x19e)](_0x6f4e9e['id'])){console[_0x11dd27(0x210)](_0x11dd27(0x198)+_0x6f4e9e['id']+_0x11dd27(0x1d6)),_0x1d146f++;continue;}const _0x26b4e2=(Date[_0x11dd27(0x17d)]()-_0x6f4e9e[_0x11dd27(0x1ff)][_0x11dd27(0x19c)]())/(0x3e8*0x3c*0x3c);if(_0x26b4e2<0x1){console[_0x11dd27(0x210)](_0x11dd27(0x198)+_0x6f4e9e['id']+_0x11dd27(0x190)+_0x26b4e2['toFixed'](0x1)+_0x11dd27(0x228)),_0x1d146f++;continue;}console[_0x11dd27(0x210)](_0x11dd27(0x183)+_0x6f4e9e['id']+_0x11dd27(0x162)+_0x26b4e2['toFixed'](0x1)+'h)'),await this[_0x11dd27(0x1e1)](_0x6f4e9e),_0x48fcc5++,await new Promise(_0xe17043=>setTimeout(_0xe17043,0x7d0));}catch(_0x2cc50f){console[_0x11dd27(0x194)](_0x11dd27(0x1a1)+_0x6f4e9e['id']+':',_0x2cc50f),this['logCoinToPayError'](_0x6f4e9e['id'],_0x6f4e9e['gatewayPaymentId']||_0x11dd27(0x181),_0x2cc50f,_0x11dd27(0x186),{'isGlobalCheck':!![],'paymentAmount':_0x6f4e9e[_0x11dd27(0x174)],'paymentCurrency':_0x6f4e9e[_0x11dd27(0x241)],'shopId':_0x6f4e9e['shopId'],'createdAt':_0x6f4e9e[_0x11dd27(0x1ff)]}),loggerService_1[_0x11dd27(0x1d8)][_0x11dd27(0x1b1)]('cointopay','/status/'+_0x6f4e9e[_0x11dd27(0x171)],_0x2cc50f);}}console[_0x11dd27(0x210)](_0x11dd27(0x1fe)+_0x48fcc5+'\x20checked,\x20'+_0x1d146f+'\x20skipped,\x20'+_0x2a1773[_0x11dd27(0x23c)]+'\x20expired');}catch(_0x3ca13e){console[_0x11dd27(0x194)](_0x11dd27(0x189),_0x3ca13e);}}async[a35_0x5b1535(0x1cd)](_0xba97b9){const _0x54072e=a35_0x5b1535,_0xcd4f36=[],_0x3206cb=new Date();_0x3206cb['setDate'](_0x3206cb[_0x54072e(0x1db)]()-this[_0x54072e(0x176)]),console[_0x54072e(0x210)](_0x54072e(0x179)+this[_0x54072e(0x176)]+'\x20days\x20(created\x20before\x20'+_0x3206cb[_0x54072e(0x1f6)]()+')');for(const _0x1c397e of _0xba97b9){if(_0x1c397e[_0x54072e(0x1ff)]<_0x3206cb){console[_0x54072e(0x210)](_0x54072e(0x1dd)+_0x1c397e['id']+_0x54072e(0x1ab)+this[_0x54072e(0x176)]+_0x54072e(0x216));try{this['logCoinToPayStatus'](_0x1c397e['id'],_0x1c397e[_0x54072e(0x171)]||_0x54072e(0x181),_0x54072e(0x234),_0x54072e(0x1e3),'auto_expire',{'reason':_0x54072e(0x1ac)+this[_0x54072e(0x176)]+_0x54072e(0x235),'createdAt':_0x1c397e[_0x54072e(0x1ff)],'daysSinceCreation':Math[_0x54072e(0x1f9)]((Date[_0x54072e(0x17d)]()-_0x1c397e['createdAt'][_0x54072e(0x19c)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x1c397e['amount'],'paymentCurrency':_0x1c397e[_0x54072e(0x241)],'shopId':_0x1c397e['shopId']}),await database_1[_0x54072e(0x1ee)][_0x54072e(0x1c4)][_0x54072e(0x1b6)]({'where':{'id':_0x1c397e['id']},'data':{'status':_0x54072e(0x1e3),'updatedAt':new Date(),'adminNotes':_0x54072e(0x1c8)+this[_0x54072e(0x176)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x54072e(0x1ee)][_0x54072e(0x21b)][_0x54072e(0x23d)]({'data':{'paymentId':_0x1c397e['id'],'shopId':_0x1c397e[_0x54072e(0x1dc)],'event':_0x54072e(0x1cf),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x54072e(0x1ac)+this['EXPIRY_DAYS']+_0x54072e(0x235),'createdAt':_0x1c397e[_0x54072e(0x1ff)],'expiredAt':new Date()[_0x54072e(0x1f6)](),'daysSinceCreation':Math[_0x54072e(0x1f9)]((Date[_0x54072e(0x17d)]()-_0x1c397e[_0x54072e(0x1ff)][_0x54072e(0x19c)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x1c397e,'EXPIRED'),await this[_0x54072e(0x178)](_0x1c397e,_0x54072e(0x1e3)),this[_0x54072e(0x1b0)](_0x1c397e['id']),_0xcd4f36[_0x54072e(0x201)](_0x1c397e['id']),console['log'](_0x54072e(0x205)+_0x1c397e['id']+_0x54072e(0x187)+this['EXPIRY_DAYS']+_0x54072e(0x1b7));}catch(_0x62d69b){console['error']('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x1c397e['id']+':',_0x62d69b),this['logCoinToPayError'](_0x1c397e['id'],_0x1c397e[_0x54072e(0x171)]||_0x54072e(0x181),_0x62d69b,_0x54072e(0x18c),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x1c397e[_0x54072e(0x1ff)],'daysSinceCreation':Math[_0x54072e(0x1f9)]((Date[_0x54072e(0x17d)]()-_0x1c397e[_0x54072e(0x1ff)][_0x54072e(0x19c)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0xcd4f36;}async[a35_0x5b1535(0x1e1)](_0x3faff2){const _0x512272=a35_0x5b1535;if(!_0x3faff2['gatewayPaymentId']){console[_0x512272(0x210)](_0x512272(0x211)+_0x3faff2['id']+_0x512272(0x230));return;}console[_0x512272(0x210)]('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x3faff2['id']+'\x20('+_0x3faff2[_0x512272(0x171)]+')');try{const _0x54b357=await this[_0x512272(0x1eb)][_0x512272(0x1a9)](_0x3faff2['gatewayPaymentId']);console['log'](_0x512272(0x203)+_0x3faff2['id']+_0x512272(0x16d)+_0x54b357['status']);_0x54b357[_0x512272(0x220)]&&console['log'](_0x512272(0x203)+_0x3faff2['id']+_0x512272(0x22b),{'iban':_0x54b357['paymentDetails'][_0x512272(0x222)]||'not\x20found','transactionId':_0x54b357[_0x512272(0x220)][_0x512272(0x1fb)],'createdOn':_0x54b357[_0x512272(0x220)][_0x512272(0x21d)],'confirmedOn':_0x54b357[_0x512272(0x220)][_0x512272(0x1d5)]||_0x512272(0x17a)});if(_0x54b357[_0x512272(0x1ef)]!==_0x3faff2[_0x512272(0x1ef)]){console[_0x512272(0x210)](_0x512272(0x223)+_0x3faff2['id']+'\x20status\x20from\x20'+_0x3faff2[_0x512272(0x1ef)]+_0x512272(0x208)+_0x54b357[_0x512272(0x1ef)]),this[_0x512272(0x1f4)](_0x3faff2['id'],_0x3faff2[_0x512272(0x171)],_0x3faff2['status'],_0x54b357[_0x512272(0x1ef)],'status_check',{'paymentDetails':_0x54b357[_0x512272(0x220)],'amount':_0x54b357[_0x512272(0x174)],'currency':_0x54b357[_0x512272(0x241)],'shopId':_0x3faff2[_0x512272(0x1dc)],'checkTimestamp':new Date()[_0x512272(0x1f6)]()});const _0x3808cb={'status':_0x54b357[_0x512272(0x1ef)],'updatedAt':new Date()};_0x54b357['status']==='PAID'&&_0x3faff2[_0x512272(0x1ef)]!=='PAID'&&(_0x3808cb['paidAt']=new Date(),console[_0x512272(0x210)]('💰\x20[CHECK]\x20Payment\x20'+_0x3faff2['id']+_0x512272(0x1be)+_0x3808cb[_0x512272(0x1e2)]['toISOString']()));if(_0x54b357[_0x512272(0x220)]){const _0x40ed7a=_0x54b357[_0x512272(0x220)];_0x40ed7a['iban']&&(_0x3808cb['remitterIban']=_0x40ed7a[_0x512272(0x222)],console[_0x512272(0x210)](_0x512272(0x16a)+_0x40ed7a[_0x512272(0x222)]));if(_0x40ed7a[_0x512272(0x1d2)]){const _0x3772cb=_0x3faff2['adminNotes']||'',_0x3c5029=_0x512272(0x1ae)+_0x40ed7a['bankDetails'];_0x3808cb[_0x512272(0x1ed)]=_0x3772cb?_0x3772cb+'\x0a\x0a'+_0x3c5029:_0x3c5029,console[_0x512272(0x210)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x40ed7a['transactionId']&&console['log'](_0x512272(0x225)+_0x40ed7a[_0x512272(0x1fb)]),_0x40ed7a[_0x512272(0x1d5)]&&console[_0x512272(0x210)](_0x512272(0x1d0)+_0x40ed7a['confirmedOn']);}await database_1[_0x512272(0x1ee)][_0x512272(0x1c4)][_0x512272(0x1b6)]({'where':{'id':_0x3faff2['id']},'data':_0x3808cb}),await database_1[_0x512272(0x1ee)][_0x512272(0x21b)][_0x512272(0x23d)]({'data':{'paymentId':_0x3faff2['id'],'shopId':_0x3faff2[_0x512272(0x1dc)],'event':_0x512272(0x1e8)+_0x54b357['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x512272(0x21a)]({'oldStatus':_0x3faff2[_0x512272(0x1ef)],'newStatus':_0x54b357['status'],'paymentDetails':_0x54b357[_0x512272(0x220)],'checkedAt':new Date()[_0x512272(0x1f6)]()})}}),await this['sendShopWebhook'](_0x3faff2,_0x54b357[_0x512272(0x1ef)]),await this[_0x512272(0x178)](_0x3faff2,_0x54b357[_0x512272(0x1ef)]),_0x54b357['status']!=='PENDING'&&(console['log'](_0x512272(0x231)+_0x3faff2['id']+_0x512272(0x1cb)+_0x54b357[_0x512272(0x1ef)]+_0x512272(0x15f)),this[_0x512272(0x1b0)](_0x3faff2['id'])),console['log'](_0x512272(0x21c)+_0x3faff2['id']+_0x512272(0x1fa));}else console[_0x512272(0x210)](_0x512272(0x203)+_0x3faff2['id']+_0x512272(0x226)+_0x54b357['status']+')'),this[_0x512272(0x1f4)](_0x3faff2['id'],_0x3faff2['gatewayPaymentId'],_0x3faff2[_0x512272(0x1ef)],_0x54b357[_0x512272(0x1ef)],_0x512272(0x186),{'statusUnchanged':!![],'paymentDetails':_0x54b357[_0x512272(0x220)],'amount':_0x54b357[_0x512272(0x174)],'currency':_0x54b357['currency'],'shopId':_0x3faff2['shopId'],'checkTimestamp':new Date()['toISOString']()});}catch(_0xbea89d){console['error']('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x3faff2['id']+':',_0xbea89d),this[_0x512272(0x1de)](_0x3faff2['id'],_0x3faff2[_0x512272(0x171)],_0xbea89d,_0x512272(0x186),{'paymentAmount':_0x3faff2[_0x512272(0x174)],'paymentCurrency':_0x3faff2[_0x512272(0x241)],'shopId':_0x3faff2[_0x512272(0x1dc)],'createdAt':_0x3faff2['createdAt']}),await database_1[_0x512272(0x1ee)][_0x512272(0x21b)][_0x512272(0x23d)]({'data':{'paymentId':_0x3faff2['id'],'shopId':_0x3faff2[_0x512272(0x1dc)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x512272(0x21a)]({'error':_0xbea89d instanceof Error?_0xbea89d['message']:_0x512272(0x1c2),'gatewayPaymentId':_0x3faff2[_0x512272(0x171)],'checkedAt':new Date()[_0x512272(0x1f6)]()})}});}}async['sendShopWebhook'](_0x4af11b,_0x299016){const _0x54b853=a35_0x5b1535,_0x3e6b38=Date[_0x54b853(0x17d)]();try{const _0x1aa67e=_0x4af11b[_0x54b853(0x168)],_0x36fbe4=_0x1aa67e[_0x54b853(0x22f)];if(!_0x36fbe4?.['webhookUrl']){console[_0x54b853(0x210)](_0x54b853(0x16c)+_0x1aa67e['id']);return;}const _0x986cb1=_0x299016===_0x54b853(0x185)?_0x54b853(0x23e):_0x299016==='FAILED'?_0x54b853(0x17e):_0x299016==='EXPIRED'?_0x54b853(0x17e):_0x54b853(0x199);if(!_0x36fbe4['webhookEvents']?.['includes'](_0x986cb1)){console[_0x54b853(0x210)]('Webhook\x20event\x20'+_0x986cb1+_0x54b853(0x21e)+_0x1aa67e['id']);return;}const _0x441bd8={'event':_0x986cb1,'payment':{'id':_0x4af11b['id'],'order_id':_0x4af11b['orderId'],'gateway_order_id':_0x4af11b['gatewayOrderId'],'gateway':_0x54b853(0x218),'amount':_0x4af11b[_0x54b853(0x174)],'currency':_0x4af11b[_0x54b853(0x241)],'status':_0x299016[_0x54b853(0x1da)](),'customer_email':_0x4af11b['customerEmail'],'customer_name':_0x4af11b[_0x54b853(0x1f3)],'created_at':_0x4af11b[_0x54b853(0x1ff)],'updated_at':new Date()}},_0x2f860e=await fetch(_0x36fbe4[_0x54b853(0x1e4)],{'method':_0x54b853(0x192),'headers':{'Content-Type':_0x54b853(0x188),'User-Agent':_0x54b853(0x20b)},'body':JSON[_0x54b853(0x21a)](_0x441bd8)}),_0xe446df=Date[_0x54b853(0x17d)]()-_0x3e6b38,_0x5a55f4=_0x2f860e['ok']?_0x54b853(0x1a8):await _0x2f860e[_0x54b853(0x212)]();loggerService_1[_0x54b853(0x1d8)][_0x54b853(0x184)](_0x4af11b[_0x54b853(0x1dc)],_0x36fbe4[_0x54b853(0x1e4)],_0x986cb1,_0x2f860e[_0x54b853(0x1ef)],_0xe446df,_0x441bd8),console[_0x54b853(0x210)]('Shop\x20webhook\x20sent\x20to\x20'+_0x36fbe4[_0x54b853(0x1e4)]+_0x54b853(0x1f1)+_0x2f860e[_0x54b853(0x1ef)]+'\x20('+_0xe446df+'ms)');}catch(_0x1f7c24){console[_0x54b853(0x194)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x1f7c24),loggerService_1['loggerService']['logShopWebhookError'](_0x4af11b[_0x54b853(0x1dc)],_0x4af11b['shop']?.[_0x54b853(0x22f)]?.[_0x54b853(0x1e4)]||'unknown',_0x54b853(0x1e5),_0x1f7c24,{});}}async[a35_0x5b1535(0x178)](_0x528824,_0x7f2959){const _0x117648=a35_0x5b1535;try{const _0x7da4d1={'PENDING':_0x117648(0x1a0),'PAID':_0x117648(0x1b5),'FAILED':_0x117648(0x206),'EXPIRED':_0x117648(0x1f0)},_0x8b04e5=_0x7da4d1[_0x7f2959];if(!_0x8b04e5||_0x8b04e5===_0x117648(0x1a0))return;await telegramBotService_1['telegramBotService'][_0x117648(0x175)](_0x528824[_0x117648(0x1dc)],_0x528824,_0x8b04e5);}catch(_0x20cdd2){console['error'](_0x117648(0x20c),_0x20cdd2);}}async['checkPaymentById'](_0x235c9c){const _0x18c827=a35_0x5b1535;console[_0x18c827(0x210)]('🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x235c9c);const _0x31638f=await database_1['default'][_0x18c827(0x1c4)][_0x18c827(0x191)]({'where':{'id':_0x235c9c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x31638f)throw new Error(_0x18c827(0x236));if(_0x31638f[_0x18c827(0x1c7)]!==_0x18c827(0x233))throw new Error(_0x18c827(0x1ea));console[_0x18c827(0x210)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x235c9c),await this['checkSinglePayment'](_0x31638f),console[_0x18c827(0x210)](_0x18c827(0x1a7)+_0x235c9c);}[a35_0x5b1535(0x23a)](){const _0x3edc33=a35_0x5b1535,_0x40ed1b=this[_0x3edc33(0x19d)]?this[_0x3edc33(0x22d)]:undefined,_0x36f572=Array[_0x3edc33(0x17b)](this[_0x3edc33(0x1b2)][_0x3edc33(0x177)]())['map'](_0x1996f0=>({'paymentId':_0x1996f0[_0x3edc33(0x18d)],'gatewayPaymentId':_0x1996f0[_0x3edc33(0x171)],'createdAt':_0x1996f0['createdAt'],'timersCount':_0x1996f0[_0x3edc33(0x237)][_0x3edc33(0x23c)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x3edc33(0x22d)]/(0x3e8*0x3c),'expiryDays':this[_0x3edc33(0x176)],'activeIndividualTimers':this[_0x3edc33(0x1b2)][_0x3edc33(0x23f)],'nextGlobalCheckIn':_0x40ed1b,'paymentTimersDetails':_0x36f572};}[a35_0x5b1535(0x20e)](_0x5a0354){const _0x18f894=a35_0x5b1535,_0x20aa97=this[_0x18f894(0x1b2)]['get'](_0x5a0354);if(_0x20aa97)return{'hasTimers':!![],'timersCount':_0x20aa97['timers'][_0x18f894(0x23c)],'createdAt':_0x20aa97['createdAt'],'gatewayPaymentId':_0x20aa97[_0x18f894(0x171)]};return{'hasTimers':![]};}}function a35_0x48cd(_0x31f422,_0x2954a){const _0x20dac5=a35_0x20da();return a35_0x48cd=function(_0x48cd81,_0x357fec){_0x48cd81=_0x48cd81-0x15e;let _0x5a3f38=_0x20dac5[_0x48cd81];return _0x5a3f38;},a35_0x48cd(_0x31f422,_0x2954a);}exports[a35_0x5b1535(0x1f7)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();