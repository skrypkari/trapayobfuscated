'use strict';function a38_0x303d(){const _0x193759=['ü™ô\x20[GLOBAL]\x20Found\x20','10fJGipg','FAILED','logShopWebhookError','status','Automatically\x20expired\x20after\x20','‚è∞\x20[GLOBAL]\x20Found\x20','\x20expired\x20CoinToPay\x20payments','\x20skipped,\x20','.\x20Remaining\x20active\x20timers:\x20','gatewayPaymentId','stack','\x20in\x20shop\x20','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','‚ùå\x20[CHECK]\x20Payment\x20','payment.pending','\x20\x20\x20-\x20paymentId:\x20','Success','paidAt','1\x20minute','floor','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','getGatewayCommission','getDate','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','\x20expired','cointopay','paymentLink','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','./telegramBotService','\x20found:','303450IoOJBK','\x20status\x20unchanged\x20(','-day\x20timeout','sendPaymentStatusNotification','settings','logCoinToPayError','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','push','parse','h),\x20skipping\x20global\x20check','set','\x20status\x20from\x20','‚è∞\x20[GLOBAL]\x20Payment\x20','currency','commission','./currencyService','remitterIban','coinToPayService','webhookLog','created','./gateways/coinToPayService','customerEmail','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','map','\x20\x20\x20-\x20gatewayPaymentId:\x20','amountUSDT','CoinToPayService','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','PAID','coinToPayStatusService','amountAfterGatewayCommissionUSDT','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','now','\x20\x20\x20-\x20Amount:\x20','default','iban','70RZbKzh','./gateways/coinToPay2Service','size','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20\x20\x20üìù\x20Details:','\x20not\x20enabled\x20for\x20shop\x20','gatewaySettings','\x20details:','214641VjymlB','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','auto_expire','entries','paymentTimers','\x20with\x20status\x20','\x20(after\x20','\x20triggered\x20for\x20payment\x20','toFixed','currentPayments','\x20\x20\x20üìÖ\x20Time:\x20',',\x20stopping\x20individual\x20checks','Bank\x20Details:\x20','gateway','checkSinglePayment','‚úÖ\x20[HOURLY]\x20Payment\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20days','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','/status/','type','stringify','PENDING','status_check','Payment\x20not\x20found','SINGLE','bankDetails','clearPaymentTimers','checkSinglePaymentById','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes',',\x20gateway\x20','timestamp','EXPIRY_DAYS','cointopay_auto_expired','2\x20minutes','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','Unknown\x20error','webhookUrl','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','3428526JCNfci','createdAt','COINTOPAY_STATUS_CHANGE','\x20checked,\x20','cointopay2','ü™ô\x20[DEBUG]\x20Creating\x20','shopId','\x20current\x20status:\x20','__esModule','Gateway\x20','confirmedOn','globalCheckInterval',',\x20using\x20default\x2010%','‚úÖ\x20[CHECK]\x20Payment\x20','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20status:\x20','log','üõë\x20[SHUTDOWN]\x20Cleared\x20','üìà\x20[COINTOPAY]\x20Payment\x20','logShopWebhookSent','üßπ\x20[DEBUG]\x20Clearing\x20','6ffblsQ','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','\x20commission\x20for\x20shop\x20','\x20\x20\x20Amount:\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20\x20\x20üìù\x20Context:','schedulePaymentChecks','includes','\x20USDT','unknown','\x20not\x20found,\x20clearing\x20timers','\x20to\x20clear','\x20\x20\x20-\x20ShopId:\x20','webhook_send','\x20timers\x20for\x20payment\x20','gatewayOrderId','\x20is\x20older\x20than\x20','EXPIRED','\x20status\x20changed\x20to\x20','\x20\x20\x20-\x20Status:\x20','cointopay_status_check_','createdOn','cointopay_status_check_error','payment.failed','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','../config/database','transactionId','orderId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','checkPaymentStatus','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed',',\x20clearing\x20individual\x20timers','\x20\x20\x20üìç\x20Source:\x20','paid',':\x20type=','COMPLETED','üìä\x20[CHECK]\x20Payment\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','üßπ\x20[CHECK]\x20Payment\x20','checkAllPendingPayments','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','\x20\x20\x20-\x20Gateway:\x20','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','message','has','findUnique','CoinToPayStatusService','coinToPay2Service','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','toISOString','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','logCoinToPayStatus','length','\x20is\x20too\x20new\x20(','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','telegramBotService','\x20completed\x20for\x20payment\x20','toLowerCase','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','logWhiteDomainError',',\x20status=','getGatewayIdByName','5\x20minutes','\x20updated\x20successfully','./loggerService','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','\x20individual\x20payment\x20timers','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','get','update','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','currencyService','Failed\x20to\x20send\x20shop\x20webhook:','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','timers','application/json','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','loggerService','\x20status\x20is\x20','üí∞\x20[CHECK]\x20Payment\x20','\x20amounts\x20calculated:','payment','\x20payment\x20','create','\x20\x20\x20üìä\x20Status:\x20','schedule_created','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','paymentLinkId','\x20->\x20','description','‚úÖ\x20[EXPIRY]\x20Payment\x20','paymentDetails','values','setDate','paymentId','\x20pending\x20CoinToPay\x20payments','getPaymentTimerInfo','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20not\x20found\x20in\x20database','__importDefault','‚ùå\x20[HOURLY]\x20Payment\x20','Payment\x20older\x20than\x20','getTime','checkExpiredPayments','1458552wPbHsd','GLOBAL_CHECK_INTERVAL_MS','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','expired','\x20(age:\x20','üîç\x20[CHECK]\x20Checking\x20','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','error','delay','convertToUSDT','shop','\x20initial\x20timers\x20for\x20payment\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20in\x20','üìä\x20[HOURLY]\x20Payment\x20','Shop\x20webhook\x20sent\x20to\x20','\x20\x20\x20Amount\x20after\x20commission:\x20','checkPaymentById','sendShopWebhook','1147692CxocAO','3844141fkzjgo','amount','not\x20confirmed','6523584VnkBGw'];a38_0x303d=function(){return _0x193759;};return a38_0x303d();}const a38_0x5087da=a38_0x2335;(function(_0x58b749,_0x4fab49){const _0x39c384=a38_0x2335,_0x1de4b0=_0x58b749();while(!![]){try{const _0x2ef235=-parseInt(_0x39c384(0x1cb))/0x1+parseInt(_0x39c384(0x1a7))/0x2+parseInt(_0x39c384(0x21e))/0x3+-parseInt(_0x39c384(0x191))/0x4*(-parseInt(_0x39c384(0x1ad))/0x5)+-parseInt(_0x39c384(0x124))/0x6*(parseInt(_0x39c384(0x1a8))/0x7)+-parseInt(_0x39c384(0x1ab))/0x8+parseInt(_0x39c384(0x1f7))/0x9*(-parseInt(_0x39c384(0x1ef))/0xa);if(_0x2ef235===_0x4fab49)break;else _0x1de4b0['push'](_0x1de4b0['shift']());}catch(_0x17ac61){_0x1de4b0['push'](_0x1de4b0['shift']());}}}(a38_0x303d,0x95290));function a38_0x2335(_0x4eaaab,_0x42582f){const _0x303d73=a38_0x303d();return a38_0x2335=function(_0x233573,_0x54c0af){_0x233573=_0x233573-0x11b;let _0x232ea8=_0x303d73[_0x233573];return _0x232ea8;},a38_0x2335(_0x4eaaab,_0x42582f);}var __importDefault=this&&this[a38_0x5087da(0x18c)]||function(_0x366624){return _0x366624&&_0x366624['__esModule']?_0x366624:{'default':_0x366624};};Object['defineProperty'](exports,a38_0x5087da(0x226),{'value':!![]}),exports[a38_0x5087da(0x1e8)]=exports[a38_0x5087da(0x153)]=void 0x0;const coinToPayService_1=require(a38_0x5087da(0x1df)),coinToPay2Service_1=require(a38_0x5087da(0x1f0)),gateway_1=require('../types/gateway'),database_1=__importDefault(require(a38_0x5087da(0x13e))),telegramBotService_1=require(a38_0x5087da(0x1c9)),loggerService_1=require(a38_0x5087da(0x167)),currencyService_1=require(a38_0x5087da(0x1da));class CoinToPayStatusService{constructor(){const _0x1efb2f=a38_0x5087da;this[_0x1efb2f(0x229)]=null,this[_0x1efb2f(0x192)]=0x3c*0x3c*0x3e8,this[_0x1efb2f(0x217)]=0x5,this['paymentTimers']=new Map(),this[_0x1efb2f(0x1dc)]=new coinToPayService_1[(_0x1efb2f(0x1e5))](),this[_0x1efb2f(0x154)]=new coinToPay2Service_1['CoinToPay2Service'](),console[_0x1efb2f(0x11f)](_0x1efb2f(0x17f));}[a38_0x5087da(0x12b)](_0xe024e3,_0x3d61f6){const _0x4d8a36=a38_0x5087da;console[_0x4d8a36(0x11f)](_0x4d8a36(0x198)),console[_0x4d8a36(0x11f)](_0x4d8a36(0x1bc)+_0xe024e3),console[_0x4d8a36(0x11f)](_0x4d8a36(0x1e3)+_0x3d61f6),this[_0x4d8a36(0x212)](_0xe024e3);const _0x45f904=[],_0x18553e=new Date(),_0x54399b=[{'delay':0x1*0x3c*0x3e8,'description':_0x4d8a36(0x1bf)},{'delay':0x2*0x3c*0x3e8,'description':_0x4d8a36(0x219)},{'delay':0x5*0x3c*0x3e8,'description':_0x4d8a36(0x165)},{'delay':0x5*0x3c*0x3e8,'description':_0x4d8a36(0x165)}];console[_0x4d8a36(0x11f)](_0x4d8a36(0x223)+_0x54399b[_0x4d8a36(0x15b)]+_0x4d8a36(0x19e)+_0xe024e3);let _0x3b64da=0x0;_0x54399b['forEach']((_0x169dfb,_0x3b58c9)=>{const _0x2a0903=_0x4d8a36;_0x3b64da+=_0x169dfb[_0x2a0903(0x19b)];const _0x4b8b5c=setTimeout(async()=>{const _0x1e22e3=_0x2a0903;console[_0x1e22e3(0x11f)](_0x1e22e3(0x125)+(_0x3b58c9+0x1)+_0x1e22e3(0x1fe)+_0xe024e3+_0x1e22e3(0x1fd)+_0x169dfb['description']+')');try{await this[_0x1e22e3(0x213)](_0xe024e3),console['log'](_0x1e22e3(0x161)+(_0x3b58c9+0x1)+_0x1e22e3(0x15f)+_0xe024e3);}catch(_0x5e3a91){console[_0x1e22e3(0x19a)](_0x1e22e3(0x14d)+(_0x3b58c9+0x1)+'\x20for\x20payment\x20'+_0xe024e3+':',_0x5e3a91),this['logCoinToPayError'](_0xe024e3,_0x3d61f6,_0x5e3a91,_0x1e22e3(0x20e),{'checkNumber':_0x3b58c9+0x1,'scheduledAfter':_0x169dfb[_0x1e22e3(0x182)],'isIndividualCheck':!![]});}},_0x3b64da);_0x45f904[_0x2a0903(0x1d2)](_0x4b8b5c),console[_0x2a0903(0x11f)](_0x2a0903(0x14f)+(_0x3b58c9+0x1)+'\x20for\x20payment\x20'+_0xe024e3+_0x2a0903(0x1a1)+_0x3b64da/0x3e8+'\x20seconds\x20('+_0x169dfb[_0x2a0903(0x182)]+')');});const _0x509ee6=setInterval(async()=>{const _0x5a69e3=_0x4d8a36;console[_0x5a69e3(0x11f)]('ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0xe024e3);try{const _0x44b29f=await database_1['default']['payment']['findUnique']({'where':{'id':_0xe024e3},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x44b29f){console[_0x5a69e3(0x11f)](_0x5a69e3(0x18d)+_0xe024e3+_0x5a69e3(0x12f)),this[_0x5a69e3(0x212)](_0xe024e3);return;}console[_0x5a69e3(0x11f)](_0x5a69e3(0x1a2)+_0xe024e3+_0x5a69e3(0x225)+_0x44b29f[_0x5a69e3(0x1b0)]);if(_0x44b29f[_0x5a69e3(0x1b0)]!==_0x5a69e3(0x20d)){console[_0x5a69e3(0x11f)](_0x5a69e3(0x206)+_0xe024e3+_0x5a69e3(0x177)+_0x44b29f[_0x5a69e3(0x1b0)]+_0x5a69e3(0x202)),this[_0x5a69e3(0x212)](_0xe024e3);return;}const _0x4cc5b3=Math['floor']((Date[_0x5a69e3(0x1eb)]()-_0x44b29f[_0x5a69e3(0x21f)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x4cc5b3>=this[_0x5a69e3(0x217)]){console['log']('‚è∞\x20[HOURLY]\x20Payment\x20'+_0xe024e3+_0x5a69e3(0x135)+this[_0x5a69e3(0x217)]+_0x5a69e3(0x159)),this[_0x5a69e3(0x212)](_0xe024e3);return;}await this[_0x5a69e3(0x213)](_0xe024e3),console[_0x5a69e3(0x11f)]('‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0xe024e3);}catch(_0x55b2a0){console[_0x5a69e3(0x19a)]('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0xe024e3+':',_0x55b2a0),this['logCoinToPayError'](_0xe024e3,_0x3d61f6,_0x55b2a0,_0x5a69e3(0x20e),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x45f904[_0x4d8a36(0x1d2)](_0x509ee6),this[_0x4d8a36(0x1fb)][_0x4d8a36(0x1d5)](_0xe024e3,{'timers':_0x45f904,'paymentId':_0xe024e3,'gatewayPaymentId':_0x3d61f6,'createdAt':_0x18553e}),console['log'](_0x4d8a36(0x1c1)+_0x54399b[_0x4d8a36(0x15b)]+_0x4d8a36(0x171)+_0xe024e3),console['log'](_0x4d8a36(0x1e1)+this[_0x4d8a36(0x1fb)][_0x4d8a36(0x1f1)]),this[_0x4d8a36(0x15a)](_0xe024e3,_0x3d61f6,_0x4d8a36(0x20d),_0x4d8a36(0x20d),_0x4d8a36(0x20e),{'action':_0x4d8a36(0x17e),'scheduledChecks':_0x54399b['length'],'firstCheckIn':_0x54399b[0x0][_0x4d8a36(0x19b)]/0x3e8,'totalTimers':this['paymentTimers'][_0x4d8a36(0x1f1)]});}[a38_0x5087da(0x212)](_0x4d2818){const _0x3f28e4=a38_0x5087da,_0x52ec93=this['paymentTimers'][_0x3f28e4(0x16b)](_0x4d2818);_0x52ec93?(console['log'](_0x3f28e4(0x123)+_0x52ec93['timers'][_0x3f28e4(0x15b)]+_0x3f28e4(0x133)+_0x4d2818),_0x52ec93[_0x3f28e4(0x173)]['forEach']((_0x52f82f,_0x411601)=>{const _0x584d7c=_0x3f28e4;_0x52f82f&&(clearTimeout(_0x52f82f),clearInterval(_0x52f82f),console[_0x584d7c(0x11f)](_0x584d7c(0x21a)+(_0x411601+0x1)+'\x20for\x20payment\x20'+_0x4d2818));}),this[_0x3f28e4(0x1fb)]['delete'](_0x4d2818),console[_0x3f28e4(0x11f)](_0x3f28e4(0x1a0)+_0x4d2818+_0x3f28e4(0x1b5)+this[_0x3f28e4(0x1fb)][_0x3f28e4(0x1f1)])):console[_0x3f28e4(0x11f)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x4d2818+_0x3f28e4(0x130));}async['checkSinglePaymentById'](_0x2d9c8d){const _0x22f7fc=a38_0x5087da;console[_0x22f7fc(0x11f)]('üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x2d9c8d);const _0x5c5731=await database_1[_0x22f7fc(0x1ed)][_0x22f7fc(0x17a)][_0x22f7fc(0x152)]({'where':{'id':_0x2d9c8d},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5c5731){console[_0x22f7fc(0x11f)](_0x22f7fc(0x1ba)+_0x2d9c8d+_0x22f7fc(0x18b));return;}console[_0x22f7fc(0x11f)]('üìä\x20[CHECK]\x20Payment\x20'+_0x2d9c8d+_0x22f7fc(0x1ca)),console[_0x22f7fc(0x11f)](_0x22f7fc(0x14e)+_0x5c5731[_0x22f7fc(0x204)]),console[_0x22f7fc(0x11f)](_0x22f7fc(0x138)+_0x5c5731[_0x22f7fc(0x1b0)]),console['log'](_0x22f7fc(0x129)+_0x5c5731[_0x22f7fc(0x1b6)]),console[_0x22f7fc(0x11f)](_0x22f7fc(0x1ec)+_0x5c5731['amount']+'\x20'+_0x5c5731[_0x22f7fc(0x1d8)]),console[_0x22f7fc(0x11f)](_0x22f7fc(0x131)+_0x5c5731['shopId']);if(_0x5c5731['gateway']!=='cointopay'&&_0x5c5731['gateway']!==_0x22f7fc(0x222)){console[_0x22f7fc(0x11f)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x2d9c8d+_0x22f7fc(0x15d)+_0x5c5731['gateway']+')');return;}if(_0x5c5731[_0x22f7fc(0x1b0)]!==_0x22f7fc(0x20d)){console['log'](_0x22f7fc(0x1c4)+_0x2d9c8d+_0x22f7fc(0x177)+_0x5c5731['status']+_0x22f7fc(0x202)),this['clearPaymentTimers'](_0x2d9c8d);return;}if(!_0x5c5731[_0x22f7fc(0x1b6)]){console[_0x22f7fc(0x11f)](_0x22f7fc(0x1c4)+_0x2d9c8d+'\x20has\x20no\x20gatewayPaymentId');return;}console['log'](_0x22f7fc(0x22b)+_0x2d9c8d+_0x22f7fc(0x1f2)),await this[_0x22f7fc(0x205)](_0x5c5731);}[a38_0x5087da(0x15a)](_0x4bdcfb,_0x30be05,_0x5e4605,_0x219cfc,_0x70a13f,_0xb8e7ed){const _0xa8bbcc=a38_0x5087da,_0x599362={'type':_0xa8bbcc(0x220),'paymentId':_0x4bdcfb,'gatewayPaymentId':_0x30be05,'oldStatus':_0x5e4605,'newStatus':_0x219cfc,'source':_0x70a13f,'timestamp':new Date()['toISOString'](),'details':_0xb8e7ed||{}};loggerService_1[_0xa8bbcc(0x176)]['logCoinToPayStatus'](_0x599362),console[_0xa8bbcc(0x11f)](_0xa8bbcc(0x155)+_0x4bdcfb+'\x20('+_0x30be05+')'),console['log'](_0xa8bbcc(0x17d)+_0x5e4605+'\x20->\x20'+_0x219cfc),console['log'](_0xa8bbcc(0x145)+_0x70a13f),console[_0xa8bbcc(0x11f)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x599362[_0xa8bbcc(0x216)]),_0xb8e7ed&&console[_0xa8bbcc(0x11f)](_0xa8bbcc(0x1f3),_0xb8e7ed);}[a38_0x5087da(0x1d0)](_0x3c27a4,_0x570670,_0x5ce6af,_0x1f1064,_0x9076aa){const _0x2cfeb0=a38_0x5087da,_0xea9632={'type':'COINTOPAY_ERROR','paymentId':_0x3c27a4,'gatewayPaymentId':_0x570670,'error':_0x5ce6af instanceof Error?{'message':_0x5ce6af[_0x2cfeb0(0x150)],'stack':_0x5ce6af[_0x2cfeb0(0x1b7)]}:_0x5ce6af,'source':_0x1f1064,'timestamp':new Date()['toISOString'](),'context':_0x9076aa||{}};loggerService_1['loggerService'][_0x2cfeb0(0x1d0)](_0xea9632),console[_0x2cfeb0(0x19a)](_0x2cfeb0(0x21d)+_0x3c27a4+'\x20('+_0x570670+')'),console[_0x2cfeb0(0x19a)]('\x20\x20\x20‚ùå\x20Error:\x20'+(_0x5ce6af instanceof Error?_0x5ce6af[_0x2cfeb0(0x150)]:_0x5ce6af)),console[_0x2cfeb0(0x19a)](_0x2cfeb0(0x145)+_0x1f1064),console[_0x2cfeb0(0x19a)](_0x2cfeb0(0x201)+_0xea9632[_0x2cfeb0(0x216)]),_0x9076aa&&console[_0x2cfeb0(0x19a)](_0x2cfeb0(0x12a),_0x9076aa);}['startPeriodicStatusCheck'](){const _0x1221bd=a38_0x5087da;console[_0x1221bd(0x11f)]('ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x1221bd(0x14c)]()['catch'](_0x3ba72d=>{const _0x52fc2d=_0x1221bd;console['error'](_0x52fc2d(0x1d1),_0x3ba72d);}),this['globalCheckInterval']=setInterval(async()=>{const _0x2a33c8=_0x1221bd;try{console[_0x2a33c8(0x11f)](_0x2a33c8(0x13d)),await this['checkAllPendingPayments'](),console['log'](_0x2a33c8(0x143));}catch(_0x335dd3){console['error'](_0x2a33c8(0x209),_0x335dd3);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x1221bd(0x11f)]('‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}['stopPeriodicStatusCheck'](){const _0x565145=a38_0x5087da;console['log'](_0x565145(0x156));this['globalCheckInterval']&&(clearInterval(this['globalCheckInterval']),this['globalCheckInterval']=null,console[_0x565145(0x11f)](_0x565145(0x14a)));const _0x1dd1c4=this[_0x565145(0x1fb)][_0x565145(0x1f1)];for(const [_0x2df541]of this['paymentTimers']){this[_0x565145(0x212)](_0x2df541);}console[_0x565145(0x11f)](_0x565145(0x120)+_0x1dd1c4+_0x565145(0x169));}async[a38_0x5087da(0x14c)](){const _0x231f2f=a38_0x5087da;try{console[_0x231f2f(0x11f)](_0x231f2f(0x18a));const _0x48095f=await database_1[_0x231f2f(0x1ed)]['payment']['findMany']({'where':{'gateway':{'in':[_0x231f2f(0x1c6),'cointopay2']},'status':_0x231f2f(0x20d),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x231f2f(0x11f)](_0x231f2f(0x1ac)+_0x48095f['length']+_0x231f2f(0x188));if(_0x48095f[_0x231f2f(0x15b)]===0x0){console['log'](_0x231f2f(0x193));return;}const _0x385e03=await this[_0x231f2f(0x190)](_0x48095f);console[_0x231f2f(0x11f)](_0x231f2f(0x1b2)+_0x385e03['length']+_0x231f2f(0x1b3));let _0x27a2d6=0x0,_0xe7b3d7=0x0;for(const _0x3d9e91 of _0x48095f){try{if(_0x385e03['includes'](_0x3d9e91['id'])){console[_0x231f2f(0x11f)](_0x231f2f(0x1d7)+_0x3d9e91['id']+_0x231f2f(0x1ea)),_0xe7b3d7++;continue;}if(this[_0x231f2f(0x1fb)][_0x231f2f(0x151)](_0x3d9e91['id'])){console[_0x231f2f(0x11f)](_0x231f2f(0x1d7)+_0x3d9e91['id']+_0x231f2f(0x207)),_0xe7b3d7++;continue;}const _0x565dcd=(Date[_0x231f2f(0x1eb)]()-_0x3d9e91[_0x231f2f(0x21f)][_0x231f2f(0x18f)]())/(0x3e8*0x3c*0x3c);if(_0x565dcd<0x1){console['log'](_0x231f2f(0x1d7)+_0x3d9e91['id']+_0x231f2f(0x15c)+_0x565dcd[_0x231f2f(0x1ff)](0x1)+_0x231f2f(0x1d4)),_0xe7b3d7++;continue;}console['log'](_0x231f2f(0x199)+_0x3d9e91['id']+_0x231f2f(0x195)+_0x565dcd[_0x231f2f(0x1ff)](0x1)+'h)'),await this['checkSinglePayment'](_0x3d9e91),_0x27a2d6++,await new Promise(_0x141435=>setTimeout(_0x141435,0x7d0));}catch(_0x2bf8e0){console[_0x231f2f(0x19a)](_0x231f2f(0x157)+_0x3d9e91['id']+':',_0x2bf8e0),this[_0x231f2f(0x1d0)](_0x3d9e91['id'],_0x3d9e91[_0x231f2f(0x1b6)]||_0x231f2f(0x12e),_0x2bf8e0,_0x231f2f(0x20e),{'isGlobalCheck':!![],'paymentAmount':_0x3d9e91['amount'],'paymentCurrency':_0x3d9e91[_0x231f2f(0x1d8)],'shopId':_0x3d9e91[_0x231f2f(0x224)],'createdAt':_0x3d9e91[_0x231f2f(0x21f)]}),loggerService_1[_0x231f2f(0x176)][_0x231f2f(0x162)](_0x231f2f(0x1c6),_0x231f2f(0x20a)+_0x3d9e91[_0x231f2f(0x1b6)],_0x2bf8e0);}}console[_0x231f2f(0x11f)](_0x231f2f(0x16a)+_0x27a2d6+_0x231f2f(0x221)+_0xe7b3d7+_0x231f2f(0x1b4)+_0x385e03['length']+_0x231f2f(0x1c5));}catch(_0x41d1f1){console[_0x231f2f(0x19a)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x41d1f1);}}async[a38_0x5087da(0x190)](_0x25b510){const _0x4af5f2=a38_0x5087da,_0x5e4f73=[],_0x3d1003=new Date();_0x3d1003[_0x4af5f2(0x186)](_0x3d1003[_0x4af5f2(0x1c3)]()-this['EXPIRY_DAYS']),console['log']('‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x4af5f2(0x217)]+'\x20days\x20(created\x20before\x20'+_0x3d1003[_0x4af5f2(0x158)]()+')');for(const _0x1807d7 of _0x25b510){if(_0x1807d7[_0x4af5f2(0x21f)]<_0x3d1003){console[_0x4af5f2(0x11f)]('‚è∞\x20[EXPIRY]\x20Payment\x20'+_0x1807d7['id']+_0x4af5f2(0x135)+this[_0x4af5f2(0x217)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x4af5f2(0x15a)](_0x1807d7['id'],_0x1807d7['gatewayPaymentId']||_0x4af5f2(0x12e),_0x4af5f2(0x20d),'EXPIRED',_0x4af5f2(0x1f9),{'reason':_0x4af5f2(0x18e)+this[_0x4af5f2(0x217)]+_0x4af5f2(0x208),'createdAt':_0x1807d7[_0x4af5f2(0x21f)],'daysSinceCreation':Math[_0x4af5f2(0x1c0)]((Date[_0x4af5f2(0x1eb)]()-_0x1807d7['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x1807d7[_0x4af5f2(0x1a9)],'paymentCurrency':_0x1807d7[_0x4af5f2(0x1d8)],'shopId':_0x1807d7[_0x4af5f2(0x224)]}),await database_1[_0x4af5f2(0x1ed)][_0x4af5f2(0x17a)]['update']({'where':{'id':_0x1807d7['id']},'data':{'status':_0x4af5f2(0x136),'updatedAt':new Date(),'adminNotes':_0x4af5f2(0x1b1)+this[_0x4af5f2(0x217)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x4af5f2(0x1ed)][_0x4af5f2(0x1dd)][_0x4af5f2(0x17c)]({'data':{'paymentId':_0x1807d7['id'],'shopId':_0x1807d7[_0x4af5f2(0x224)],'event':_0x4af5f2(0x218),'statusCode':0xc8,'responseBody':JSON[_0x4af5f2(0x20c)]({'reason':_0x4af5f2(0x18e)+this[_0x4af5f2(0x217)]+_0x4af5f2(0x208),'createdAt':_0x1807d7[_0x4af5f2(0x21f)],'expiredAt':new Date()[_0x4af5f2(0x158)](),'daysSinceCreation':Math[_0x4af5f2(0x1c0)]((Date[_0x4af5f2(0x1eb)]()-_0x1807d7['createdAt'][_0x4af5f2(0x18f)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4af5f2(0x1a6)](_0x1807d7,_0x4af5f2(0x136)),await this[_0x4af5f2(0x1ce)](_0x1807d7,_0x4af5f2(0x136)),this[_0x4af5f2(0x212)](_0x1807d7['id']),_0x5e4f73[_0x4af5f2(0x1d2)](_0x1807d7['id']),console[_0x4af5f2(0x11f)](_0x4af5f2(0x183)+_0x1807d7['id']+_0x4af5f2(0x1e6)+this['EXPIRY_DAYS']+_0x4af5f2(0x1cd));}catch(_0x4202b3){console[_0x4af5f2(0x19a)](_0x4af5f2(0x16e)+_0x1807d7['id']+':',_0x4202b3),this[_0x4af5f2(0x1d0)](_0x1807d7['id'],_0x1807d7['gatewayPaymentId']||'unknown',_0x4202b3,_0x4af5f2(0x1f9),{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x1807d7[_0x4af5f2(0x21f)],'daysSinceCreation':Math[_0x4af5f2(0x1c0)]((Date[_0x4af5f2(0x1eb)]()-_0x1807d7[_0x4af5f2(0x21f)][_0x4af5f2(0x18f)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5e4f73;}async['checkSinglePayment'](_0x58e10c){const _0x2d2dc5=a38_0x5087da;if(!_0x58e10c[_0x2d2dc5(0x1b6)]){console['log'](_0x2d2dc5(0x1c4)+_0x58e10c['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console['log'](_0x2d2dc5(0x196)+_0x58e10c[_0x2d2dc5(0x204)]+_0x2d2dc5(0x17b)+_0x58e10c['id']+'\x20('+_0x58e10c['gatewayPaymentId']+')');try{let _0xc1d760;_0x58e10c[_0x2d2dc5(0x204)]===_0x2d2dc5(0x222)?(_0xc1d760=await this[_0x2d2dc5(0x154)][_0x2d2dc5(0x142)](_0x58e10c[_0x2d2dc5(0x1b6)]),console['log'](_0x2d2dc5(0x1c8)+_0x58e10c['id']+'\x20status:\x20'+_0xc1d760['status'])):(_0xc1d760=await this[_0x2d2dc5(0x1dc)]['checkPaymentStatus'](_0x58e10c[_0x2d2dc5(0x1b6)]),console['log'](_0x2d2dc5(0x172)+_0x58e10c['id']+_0x2d2dc5(0x11e)+_0xc1d760['status']));_0xc1d760[_0x2d2dc5(0x184)]&&console['log'](_0x2d2dc5(0x149)+_0x58e10c['id']+_0x2d2dc5(0x1f6),{'iban':_0xc1d760[_0x2d2dc5(0x184)][_0x2d2dc5(0x1ee)]||'not\x20found','transactionId':_0xc1d760[_0x2d2dc5(0x184)][_0x2d2dc5(0x13f)],'createdOn':_0xc1d760['paymentDetails'][_0x2d2dc5(0x13a)],'confirmedOn':_0xc1d760['paymentDetails']['confirmedOn']||_0x2d2dc5(0x1aa)});if(_0xc1d760[_0x2d2dc5(0x1b0)]!==_0x58e10c[_0x2d2dc5(0x1b0)]){console['log'](_0x2d2dc5(0x16d)+_0x58e10c['id']+_0x2d2dc5(0x1d6)+_0x58e10c[_0x2d2dc5(0x1b0)]+'\x20to\x20'+_0xc1d760['status']),this['logCoinToPayStatus'](_0x58e10c['id'],_0x58e10c[_0x2d2dc5(0x1b6)],_0x58e10c['status'],_0xc1d760[_0x2d2dc5(0x1b0)],_0x2d2dc5(0x20e),{'paymentDetails':_0xc1d760[_0x2d2dc5(0x184)],'amount':_0xc1d760['amount'],'currency':_0xc1d760[_0x2d2dc5(0x1d8)],'shopId':_0x58e10c[_0x2d2dc5(0x224)],'checkTimestamp':new Date()[_0x2d2dc5(0x158)]()});const _0x33cbe3={'status':_0xc1d760[_0x2d2dc5(0x1b0)],'updatedAt':new Date()};if(_0xc1d760[_0x2d2dc5(0x1b0)]===_0x2d2dc5(0x1e7)&&_0x58e10c['status']!=='PAID'){_0x33cbe3[_0x2d2dc5(0x1be)]=new Date();if(!_0x58e10c['amountUSDT']){const _0x49a8a=await currencyService_1[_0x2d2dc5(0x16f)][_0x2d2dc5(0x19c)](_0x58e10c[_0x2d2dc5(0x1a9)],_0x58e10c[_0x2d2dc5(0x1d8)]);_0x33cbe3[_0x2d2dc5(0x1e4)]=_0x49a8a;const _0x1cb7e1=await this[_0x2d2dc5(0x1c2)](_0x58e10c[_0x2d2dc5(0x224)],_0x58e10c[_0x2d2dc5(0x204)]),_0x4ab0e6=_0x49a8a*(0x1-_0x1cb7e1/0x64);_0x33cbe3[_0x2d2dc5(0x1e9)]=_0x4ab0e6,console[_0x2d2dc5(0x11f)](_0x2d2dc5(0x178)+_0x58e10c['id']+_0x2d2dc5(0x179)),console[_0x2d2dc5(0x11f)](_0x2d2dc5(0x127)+_0x58e10c[_0x2d2dc5(0x1a9)]+'\x20'+_0x58e10c[_0x2d2dc5(0x1d8)]+_0x2d2dc5(0x181)+_0x49a8a['toFixed'](0x6)+'\x20USDT'),console['log']('\x20\x20\x20Gateway\x20'+_0x58e10c[_0x2d2dc5(0x204)]+'\x20commission:\x20'+_0x1cb7e1+'%'),console[_0x2d2dc5(0x11f)](_0x2d2dc5(0x1a4)+_0x4ab0e6[_0x2d2dc5(0x1ff)](0x6)+_0x2d2dc5(0x12d));}console['log'](_0x2d2dc5(0x178)+_0x58e10c['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x33cbe3[_0x2d2dc5(0x1be)]['toISOString']());}if(_0xc1d760[_0x2d2dc5(0x184)]){const _0x1cfdfa=_0xc1d760['paymentDetails'];_0x1cfdfa['iban']&&(_0x33cbe3[_0x2d2dc5(0x1db)]=_0x1cfdfa[_0x2d2dc5(0x1ee)],console[_0x2d2dc5(0x11f)](_0x2d2dc5(0x19f)+_0x1cfdfa[_0x2d2dc5(0x1ee)]));if(_0x1cfdfa[_0x2d2dc5(0x211)]){const _0x1cb68b=_0x58e10c['adminNotes']||'',_0x550b4f=_0x2d2dc5(0x203)+_0x1cfdfa['bankDetails'];_0x33cbe3['adminNotes']=_0x1cb68b?_0x1cb68b+'\x0a\x0a'+_0x550b4f:_0x550b4f,console[_0x2d2dc5(0x11f)](_0x2d2dc5(0x214));}_0x1cfdfa[_0x2d2dc5(0x13f)]&&console[_0x2d2dc5(0x11f)](_0x2d2dc5(0x1f8)+_0x1cfdfa[_0x2d2dc5(0x13f)]),_0x1cfdfa['confirmedOn']&&console[_0x2d2dc5(0x11f)]('‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x1cfdfa[_0x2d2dc5(0x228)]);}await database_1[_0x2d2dc5(0x1ed)][_0x2d2dc5(0x17a)][_0x2d2dc5(0x16c)]({'where':{'id':_0x58e10c['id']},'data':_0x33cbe3});if(_0xc1d760[_0x2d2dc5(0x1b0)]===_0x2d2dc5(0x1e7)&&_0x58e10c[_0x2d2dc5(0x1b0)]!==_0x2d2dc5(0x1e7)){console[_0x2d2dc5(0x11f)](_0x2d2dc5(0x121)+_0x58e10c['id']+_0x2d2dc5(0x1b9));const _0x3c1d08=await database_1[_0x2d2dc5(0x1ed)]['payment'][_0x2d2dc5(0x152)]({'where':{'id':_0x58e10c['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x3c1d08?.[_0x2d2dc5(0x180)]&&_0x3c1d08['paymentLink'])try{const _0x26c9e7=_0x3c1d08[_0x2d2dc5(0x1c7)];console[_0x2d2dc5(0x11f)]('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x26c9e7['id']+_0x2d2dc5(0x147)+_0x26c9e7[_0x2d2dc5(0x20b)]+',\x20currentPayments='+_0x26c9e7[_0x2d2dc5(0x200)]+_0x2d2dc5(0x163)+_0x26c9e7[_0x2d2dc5(0x1b0)]);const _0xc54d06=_0x26c9e7[_0x2d2dc5(0x200)]+0x1,_0x1ec53a=_0x26c9e7[_0x2d2dc5(0x20b)]===_0x2d2dc5(0x210)?_0x2d2dc5(0x148):_0x26c9e7[_0x2d2dc5(0x1b0)];await database_1[_0x2d2dc5(0x1ed)][_0x2d2dc5(0x1c7)]['update']({'where':{'id':_0x26c9e7['id']},'data':{'currentPayments':_0xc54d06,'status':_0x1ec53a,'updatedAt':new Date()}}),console['log']('‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20'+_0x26c9e7['id']+'\x20updated:\x20currentPayments='+_0x26c9e7[_0x2d2dc5(0x200)]+'\x20->\x20'+_0xc54d06+_0x2d2dc5(0x163)+_0x26c9e7[_0x2d2dc5(0x1b0)]+_0x2d2dc5(0x181)+_0x1ec53a);}catch(_0x54d834){console[_0x2d2dc5(0x19a)]('‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:',_0x54d834);}else console['log']('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x58e10c['id']+_0x2d2dc5(0x168));}await database_1['default'][_0x2d2dc5(0x1dd)][_0x2d2dc5(0x17c)]({'data':{'paymentId':_0x58e10c['id'],'shopId':_0x58e10c[_0x2d2dc5(0x224)],'event':_0x2d2dc5(0x139)+_0xc1d760[_0x2d2dc5(0x1b0)][_0x2d2dc5(0x160)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x58e10c[_0x2d2dc5(0x1b0)],'newStatus':_0xc1d760['status'],'paymentDetails':_0xc1d760[_0x2d2dc5(0x184)],'checkedAt':new Date()[_0x2d2dc5(0x158)]()})}}),await this['sendShopWebhook'](_0x58e10c,_0xc1d760[_0x2d2dc5(0x1b0)]),await this[_0x2d2dc5(0x1ce)](_0x58e10c,_0xc1d760['status']),_0xc1d760[_0x2d2dc5(0x1b0)]!==_0x2d2dc5(0x20d)&&(console[_0x2d2dc5(0x11f)](_0x2d2dc5(0x14b)+_0x58e10c['id']+_0x2d2dc5(0x137)+_0xc1d760[_0x2d2dc5(0x1b0)]+_0x2d2dc5(0x144)),this[_0x2d2dc5(0x212)](_0x58e10c['id'])),console[_0x2d2dc5(0x11f)](_0x2d2dc5(0x22b)+_0x58e10c['id']+_0x2d2dc5(0x166));}else console[_0x2d2dc5(0x11f)](_0x2d2dc5(0x149)+_0x58e10c['id']+_0x2d2dc5(0x1cc)+_0xc1d760[_0x2d2dc5(0x1b0)]+')'),this[_0x2d2dc5(0x15a)](_0x58e10c['id'],_0x58e10c[_0x2d2dc5(0x1b6)],_0x58e10c['status'],_0xc1d760['status'],_0x2d2dc5(0x20e),{'statusUnchanged':!![],'paymentDetails':_0xc1d760[_0x2d2dc5(0x184)],'amount':_0xc1d760['amount'],'currency':_0xc1d760[_0x2d2dc5(0x1d8)],'shopId':_0x58e10c[_0x2d2dc5(0x224)],'checkTimestamp':new Date()['toISOString']()});}catch(_0x561802){console[_0x2d2dc5(0x19a)]('‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x58e10c['id']+':',_0x561802),this[_0x2d2dc5(0x1d0)](_0x58e10c['id'],_0x58e10c['gatewayPaymentId'],_0x561802,_0x2d2dc5(0x20e),{'paymentAmount':_0x58e10c[_0x2d2dc5(0x1a9)],'paymentCurrency':_0x58e10c[_0x2d2dc5(0x1d8)],'shopId':_0x58e10c[_0x2d2dc5(0x224)],'createdAt':_0x58e10c[_0x2d2dc5(0x21f)]}),await database_1[_0x2d2dc5(0x1ed)]['webhookLog']['create']({'data':{'paymentId':_0x58e10c['id'],'shopId':_0x58e10c[_0x2d2dc5(0x224)],'event':_0x2d2dc5(0x13b),'statusCode':0x1f4,'responseBody':JSON[_0x2d2dc5(0x20c)]({'error':_0x561802 instanceof Error?_0x561802[_0x2d2dc5(0x150)]:_0x2d2dc5(0x21b),'gatewayPaymentId':_0x58e10c['gatewayPaymentId'],'checkedAt':new Date()[_0x2d2dc5(0x158)]()})}});}}async[a38_0x5087da(0x1a6)](_0x46466b,_0x24ea57){const _0x280ddf=a38_0x5087da,_0x2d2c72=Date[_0x280ddf(0x1eb)]();try{const _0x11c820=_0x46466b['shop'],_0x5bc932=_0x11c820['settings'];if(!_0x5bc932?.['webhookUrl']){console[_0x280ddf(0x11f)](_0x280ddf(0x141)+_0x11c820['id']);return;}const _0x1721ef=_0x24ea57==='PAID'?'payment.success':_0x24ea57===_0x280ddf(0x1ae)?_0x280ddf(0x13c):_0x24ea57===_0x280ddf(0x136)?'payment.failed':_0x280ddf(0x1bb);if(!_0x5bc932['webhookEvents']?.[_0x280ddf(0x12c)](_0x1721ef)){console[_0x280ddf(0x11f)]('Webhook\x20event\x20'+_0x1721ef+_0x280ddf(0x1f4)+_0x11c820['id']);return;}const _0x5b5e57=(0x0,gateway_1[_0x280ddf(0x164)])(_0x46466b[_0x280ddf(0x204)])||_0x46466b[_0x280ddf(0x204)],_0x2dc38f={'event':_0x1721ef,'payment':{'id':_0x46466b['id'],'order_id':_0x46466b[_0x280ddf(0x140)],'gateway_order_id':_0x46466b[_0x280ddf(0x134)],'gateway':_0x5b5e57,'amount':_0x46466b['amount'],'currency':_0x46466b[_0x280ddf(0x1d8)],'status':_0x24ea57[_0x280ddf(0x160)](),'customer_email':_0x46466b[_0x280ddf(0x1e0)],'customer_name':_0x46466b['customerName'],'created_at':_0x46466b[_0x280ddf(0x21f)],'updated_at':new Date()}},_0x7abde5=await fetch(_0x5bc932[_0x280ddf(0x21c)],{'method':'POST','headers':{'Content-Type':_0x280ddf(0x174),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x280ddf(0x20c)](_0x2dc38f)}),_0x505e38=Date[_0x280ddf(0x1eb)]()-_0x2d2c72,_0x580995=_0x7abde5['ok']?_0x280ddf(0x1bd):await _0x7abde5['text']();loggerService_1[_0x280ddf(0x176)][_0x280ddf(0x122)](_0x46466b[_0x280ddf(0x224)],_0x5bc932[_0x280ddf(0x21c)],_0x1721ef,_0x7abde5[_0x280ddf(0x1b0)],_0x505e38,_0x2dc38f),console[_0x280ddf(0x11f)](_0x280ddf(0x1a3)+_0x5bc932['webhookUrl']+_0x280ddf(0x1fc)+_0x7abde5['status']+'\x20('+_0x505e38+'ms)');}catch(_0x52d091){console['error'](_0x280ddf(0x170),_0x52d091),loggerService_1['loggerService'][_0x280ddf(0x1af)](_0x46466b[_0x280ddf(0x224)],_0x46466b[_0x280ddf(0x19d)]?.[_0x280ddf(0x1cf)]?.[_0x280ddf(0x21c)]||_0x280ddf(0x12e),_0x280ddf(0x132),_0x52d091,{});}}async['sendPaymentStatusNotification'](_0x39cf97,_0x31cc94){const _0x1c08a6=a38_0x5087da;try{const _0x343b3d={'PENDING':_0x1c08a6(0x1de),'PAID':_0x1c08a6(0x146),'FAILED':'failed','EXPIRED':_0x1c08a6(0x194)},_0x1bbb70=_0x343b3d[_0x31cc94];if(!_0x1bbb70||_0x1bbb70===_0x1c08a6(0x1de))return;await telegramBotService_1[_0x1c08a6(0x15e)]['sendPaymentNotification'](_0x39cf97[_0x1c08a6(0x224)],_0x39cf97,_0x1bbb70);}catch(_0x7c56b1){console[_0x1c08a6(0x19a)](_0x1c08a6(0x11d),_0x7c56b1);}}async[a38_0x5087da(0x1a5)](_0x462d46){const _0x6d5568=a38_0x5087da;console[_0x6d5568(0x11f)]('üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x462d46);const _0x527431=await database_1[_0x6d5568(0x1ed)][_0x6d5568(0x17a)][_0x6d5568(0x152)]({'where':{'id':_0x462d46},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x527431)throw new Error(_0x6d5568(0x20f));if(_0x527431[_0x6d5568(0x204)]!==_0x6d5568(0x1c6)&&_0x527431['gateway']!=='cointopay2')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x6d5568(0x11f)](_0x6d5568(0x11c)+_0x527431[_0x6d5568(0x204)]+'\x20payment\x20'+_0x462d46),await this['checkSinglePayment'](_0x527431),console[_0x6d5568(0x11f)](_0x6d5568(0x11b)+_0x462d46);}['getServiceStats'](){const _0x487b5d=a38_0x5087da,_0x54bb5c=this[_0x487b5d(0x229)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x164829=Array['from'](this[_0x487b5d(0x1fb)][_0x487b5d(0x185)]())[_0x487b5d(0x1e2)](_0x1a1588=>({'paymentId':_0x1a1588[_0x487b5d(0x187)],'gatewayPaymentId':_0x1a1588[_0x487b5d(0x1b6)],'createdAt':_0x1a1588[_0x487b5d(0x21f)],'timersCount':_0x1a1588[_0x487b5d(0x173)]['length']}));return{'isActive':!!this[_0x487b5d(0x229)],'globalCheckIntervalMinutes':this[_0x487b5d(0x192)]/(0x3e8*0x3c),'expiryDays':this[_0x487b5d(0x217)],'activeIndividualTimers':this[_0x487b5d(0x1fb)]['size'],'nextGlobalCheckIn':_0x54bb5c,'paymentTimersDetails':_0x164829};}[a38_0x5087da(0x189)](_0x121f5c){const _0x1663b9=a38_0x5087da,_0x5339db=this[_0x1663b9(0x1fb)][_0x1663b9(0x16b)](_0x121f5c);if(_0x5339db)return{'hasTimers':!![],'timersCount':_0x5339db[_0x1663b9(0x173)][_0x1663b9(0x15b)],'createdAt':_0x5339db['createdAt'],'gatewayPaymentId':_0x5339db[_0x1663b9(0x1b6)]};return{'hasTimers':![]};}async[a38_0x5087da(0x1c2)](_0x2d887d,_0x22fa10){const _0x7b0bc7=a38_0x5087da;try{const _0x23a6d5=await database_1[_0x7b0bc7(0x1ed)][_0x7b0bc7(0x19d)][_0x7b0bc7(0x152)]({'where':{'id':_0x2d887d},'select':{'gatewaySettings':!![]}});if(!_0x23a6d5?.[_0x7b0bc7(0x1f5)])return console[_0x7b0bc7(0x11f)](_0x7b0bc7(0x128)+_0x2d887d+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x8f5c45=JSON[_0x7b0bc7(0x1d3)](_0x23a6d5[_0x7b0bc7(0x1f5)]);for(const [_0x5722ee,_0x4753a1]of Object[_0x7b0bc7(0x1fa)](_0x8f5c45)){if(_0x5722ee[_0x7b0bc7(0x160)]()===_0x22fa10[_0x7b0bc7(0x160)]()){const _0x4515f6=_0x4753a1[_0x7b0bc7(0x1d9)]||0xa;return console[_0x7b0bc7(0x11f)](_0x7b0bc7(0x227)+_0x22fa10+_0x7b0bc7(0x126)+_0x2d887d+':\x20'+_0x4515f6+'%'),_0x4515f6;}}return console[_0x7b0bc7(0x11f)](_0x7b0bc7(0x197)+_0x22fa10+_0x7b0bc7(0x1b8)+_0x2d887d+_0x7b0bc7(0x22a)),0xa;}catch(_0x2bd79f){return console[_0x7b0bc7(0x19a)](_0x7b0bc7(0x175)+_0x2d887d+_0x7b0bc7(0x215)+_0x22fa10+':',_0x2bd79f),0xa;}}}exports[a38_0x5087da(0x153)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();