'use strict';const a37_0x21a983=a37_0x3568;function a37_0x2585(){const _0x157f74=['stringify','stopPeriodicStatusCheck','Payment\x20not\x20found','orderId','sendPaymentStatusNotification','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','7rtllIQ','870042eXnnGn','defineProperty','\x20has\x20no\x20gatewayPaymentId','\x20commission\x20for\x20shop\x20','\x20triggered\x20for\x20payment\x20','toFixed','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','checkExpiredPayments','110QvpAOP','payment.pending','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','POST','paymentTimers','message','shopId','setDate','unknown','\x20updated:\x20currentPayments=','includes','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','commission','\x20\x20\x20-\x20ShopId:\x20','üìä\x20[CHECK]\x20Payment\x20','payment.failed','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','logCoinToPayStatus','\x20skipped,\x20','__importDefault','\x20has\x20no\x20gatewayPaymentId,\x20skipping','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','\x20found:','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','checkSinglePaymentById','\x20in\x20','‚úÖ\x20[CHECK]\x20Payment\x20','get','payment','\x20timers\x20for\x20payment\x20','cointopay2','amount','paid','‚ùå\x20[HOURLY]\x20Payment\x20','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','402368xEfvWT','üîç\x20[CHECK]\x20Checking\x20','toISOString','EXPIRED','findUnique','\x20days,\x20marking\x20as\x20EXPIRED','‚úÖ\x20[EXPIRY]\x20Payment\x20','\x20details:','./gateways/coinToPay2Service','logCoinToPayError','ü™ô\x20[GLOBAL]\x20Found\x20','../config/database','\x20expired','currency','\x20days','payment.success','logWhiteDomainError','CoinToPayStatusService','floor','\x20payment\x20','\x20current\x20status:\x20','sendPaymentNotification','set','failed','./currencyService','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','remitterIban',':\x20type=','COINTOPAY_STATUS_CHANGE','\x20\x20\x20-\x20gatewayPaymentId:\x20','./loggerService','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','timers','\x20is\x20older\x20than\x20','type','\x20->\x20','\x20not\x20enabled\x20for\x20shop\x20','\x20\x20\x20‚ùå\x20Error:\x20','251799qRCGtr','iban','customerName','log','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','bankDetails','Failed\x20to\x20mark\x20payment\x20as\x20expired','checkSinglePayment','\x20commission:\x20','\x20\x20\x20-\x20Amount:\x20','gatewayPaymentId','Failed\x20to\x20send\x20shop\x20webhook:','getPaymentTimerInfo','checkAllPendingPayments','../types/gateway','üí∞\x20[CHECK]\x20Payment\x20','\x20not\x20found,\x20clearing\x20timers','createdAt','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20\x20\x20-\x20paymentId:\x20','\x20expired\x20CoinToPay\x20payments','5\x20minutes','auto_expire','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','now','\x20\x20\x20üìç\x20Source:\x20','description','\x20days\x20(created\x20before\x20','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','./gateways/coinToPayService','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20for\x20payment\x20','has','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','paymentId','\x20\x20\x20üìä\x20Status:\x20','paymentLink','COMPLETED',',\x20currentPayments=','\x20\x20\x20üìù\x20Details:','Success','95643qCXjXF','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','clearPaymentTimers','sendShopWebhook','./telegramBotService','183071SkruoW','confirmedOn','currencyService','COINTOPAY_ERROR','webhook_send','delete','üìà\x20[COINTOPAY]\x20Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','transactionId','findMany','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','error','forEach','text','paymentDetails','create','delay','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','cointopay_status_check_error','\x20\x20\x20-\x20Status:\x20','CoinToPayService','EXPIRY_DAYS','amountAfterGatewayCommissionUSDT','map','toLowerCase','\x20amounts\x20calculated:','\x20is\x20too\x20new\x20(','Automatically\x20expired\x20after\x20','\x20\x20\x20üìù\x20Context:','expired','\x20USDT','push','\x20\x20\x20Amount\x20after\x20commission:\x20','loggerService','cointopay_auto_expired','logShopWebhookError','coinToPayService','schedulePaymentChecks','gatewayOrderId','status','values','FAILED','length','PAID',',\x20stopping\x20individual\x20checks','paidAt','ü™ô\x20[DEBUG]\x20Creating\x20','Bank\x20Details:\x20','shop','getTime','Shop\x20webhook\x20sent\x20to\x20','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','h),\x20skipping\x20global\x20check','\x20status\x20is\x20','\x20\x20\x20Gateway\x20','üßπ\x20[CHECK]\x20Payment\x20','currentPayments','application/json','Payment\x20older\x20than\x20','PENDING','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','üßπ\x20[DEBUG]\x20Clearing\x20','8IlgKYQ','default','Gateway\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20days\x20without\x20payment\x20confirmation','gatewaySettings','globalCheckInterval','webhookUrl','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','\x20\x20\x20-\x20Gateway:\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','size','‚ùå\x20[CHECK]\x20Payment\x20','‚úÖ\x20[HOURLY]\x20Payment\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','timestamp','SINGLE','\x20\x20\x20-\x20GatewayPaymentId:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20with\x20status\x20','\x20seconds\x20(','parse','üõë\x20[SHUTDOWN]\x20Cleared\x20','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20\x20\x20Amount:\x20','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','status_check','update','/status/','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','GLOBAL_CHECK_INTERVAL_MS','ms)','cointopay_status_check_','‚è∞\x20[GLOBAL]\x20Payment\x20','220735GQIQfr','amountUSDT','‚è∞\x20[HOURLY]\x20Payment\x20','webhookLog','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20checked,\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20',',\x20status=','settings','\x20to\x20','adminNotes','getServiceStats','gateway','\x20marked\x20as\x20paid\x20at:\x20','created','74476ZQUiEe',',\x20clearing\x20individual\x20timers','.\x20Remaining\x20active\x20timers:\x20','cointopay','\x20\x20\x20üìÖ\x20Time:\x20','\x20status:\x20','\x20(age:\x20',',\x20gateway\x20','checkPaymentStatus','-day\x20timeout','‚è∞\x20[GLOBAL]\x20Found\x20','\x20status\x20from\x20','customerEmail','catch'];a37_0x2585=function(){return _0x157f74;};return a37_0x2585();}(function(_0x259b66,_0x241ccd){const _0x4f745c=a37_0x3568,_0x40ed5c=_0x259b66();while(!![]){try{const _0x49cf2e=parseInt(_0x4f745c(0x123))/0x1+parseInt(_0x4f745c(0x8e))/0x2+parseInt(_0x4f745c(0xf5))/0x3*(parseInt(_0x4f745c(0x166))/0x4)+-parseInt(_0x4f745c(0x7f))/0x5+parseInt(_0x4f745c(0xa3))/0x6*(-parseInt(_0x4f745c(0xa2))/0x7)+parseInt(_0x4f745c(0xcf))/0x8+-parseInt(_0x4f745c(0x11e))/0x9*(parseInt(_0x4f745c(0xab))/0xa);if(_0x49cf2e===_0x241ccd)break;else _0x40ed5c['push'](_0x40ed5c['shift']());}catch(_0x3e98d9){_0x40ed5c['push'](_0x40ed5c['shift']());}}}(a37_0x2585,0x20544));var __importDefault=this&&this[a37_0x21a983(0xbe)]||function(_0x296760){return _0x296760&&_0x296760['__esModule']?_0x296760:{'default':_0x296760};};Object[a37_0x21a983(0xa4)](exports,'__esModule',{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0x21a983(0xe0)]=void 0x0;const coinToPayService_1=require(a37_0x21a983(0x112)),coinToPay2Service_1=require(a37_0x21a983(0xd7)),gateway_1=require(a37_0x21a983(0x103)),database_1=__importDefault(require(a37_0x21a983(0xda))),telegramBotService_1=require(a37_0x21a983(0x122)),loggerService_1=require(a37_0x21a983(0xed)),currencyService_1=require(a37_0x21a983(0xe7));function a37_0x3568(_0x28872e,_0x1ff786){const _0x258556=a37_0x2585();return a37_0x3568=function(_0x356822,_0x372662){_0x356822=_0x356822-0x6e;let _0x469c7b=_0x258556[_0x356822];return _0x469c7b;},a37_0x3568(_0x28872e,_0x1ff786);}class CoinToPayStatusService{constructor(){const _0x579c7b=a37_0x21a983;this[_0x579c7b(0x16d)]=null,this[_0x579c7b(0x7b)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this['paymentTimers']=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x579c7b(0x139))](),this['coinToPay2Service']=new coinToPay2Service_1['CoinToPay2Service'](),console[_0x579c7b(0xf8)](_0x579c7b(0xad));}[a37_0x21a983(0x14a)](_0x30d8c8,_0x17f6c9){const _0x2e917e=a37_0x21a983;console[_0x2e917e(0xf8)](_0x2e917e(0x15a)),console[_0x2e917e(0xf8)](_0x2e917e(0x108)+_0x30d8c8),console[_0x2e917e(0xf8)](_0x2e917e(0xec)+_0x17f6c9),this[_0x2e917e(0x120)](_0x30d8c8);const _0xc50dfc=[],_0x51da3d=new Date(),_0x5dddab=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x2e917e(0x10a)},{'delay':0x5*0x3c*0x3e8,'description':_0x2e917e(0x10a)}];console[_0x2e917e(0xf8)](_0x2e917e(0x153)+_0x5dddab['length']+'\x20initial\x20timers\x20for\x20payment\x20'+_0x30d8c8);let _0x23c816=0x0;_0x5dddab[_0x2e917e(0x131)]((_0x28b060,_0x3a0980)=>{const _0x12b4fc=_0x2e917e;_0x23c816+=_0x28b060[_0x12b4fc(0x135)];const _0x357224=setTimeout(async()=>{const _0x8ef1e2=_0x12b4fc;console[_0x8ef1e2(0xf8)]('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x3a0980+0x1)+_0x8ef1e2(0xa7)+_0x30d8c8+'\x20(after\x20'+_0x28b060[_0x8ef1e2(0x10f)]+')');try{await this[_0x8ef1e2(0xc4)](_0x30d8c8),console[_0x8ef1e2(0xf8)](_0x8ef1e2(0x111)+(_0x3a0980+0x1)+'\x20completed\x20for\x20payment\x20'+_0x30d8c8);}catch(_0xeea77){console['error']('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x3a0980+0x1)+'\x20for\x20payment\x20'+_0x30d8c8+':',_0xeea77),this[_0x8ef1e2(0xd8)](_0x30d8c8,_0x17f6c9,_0xeea77,_0x8ef1e2(0x77),{'checkNumber':_0x3a0980+0x1,'scheduledAfter':_0x28b060[_0x8ef1e2(0x10f)],'isIndividualCheck':!![]});}},_0x23c816);_0xc50dfc['push'](_0x357224),console['log'](_0x12b4fc(0x76)+(_0x3a0980+0x1)+'\x20for\x20payment\x20'+_0x30d8c8+_0x12b4fc(0xc5)+_0x23c816/0x3e8+_0x12b4fc(0x70)+_0x28b060[_0x12b4fc(0x10f)]+')');});const _0x450246=setInterval(async()=>{const _0x1c785d=_0x2e917e;console[_0x1c785d(0xf8)](_0x1c785d(0xa9)+_0x30d8c8);try{const _0x11e7d6=await database_1[_0x1c785d(0x167)]['payment'][_0x1c785d(0xd3)]({'where':{'id':_0x30d8c8},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x11e7d6){console[_0x1c785d(0xf8)](_0x1c785d(0xcd)+_0x30d8c8+_0x1c785d(0x105)),this[_0x1c785d(0x120)](_0x30d8c8);return;}console[_0x1c785d(0xf8)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x30d8c8+_0x1c785d(0xe3)+_0x11e7d6[_0x1c785d(0x14c)]);if(_0x11e7d6[_0x1c785d(0x14c)]!==_0x1c785d(0x162)){console[_0x1c785d(0xf8)](_0x1c785d(0x174)+_0x30d8c8+_0x1c785d(0x15c)+_0x11e7d6['status']+_0x1c785d(0x151)),this[_0x1c785d(0x120)](_0x30d8c8);return;}const _0xfc3b0=Math['floor']((Date['now']()-_0x11e7d6['createdAt'][_0x1c785d(0x156)]())/(0x3e8*0x3c*0x3c*0x18));if(_0xfc3b0>=this['EXPIRY_DAYS']){console[_0x1c785d(0xf8)](_0x1c785d(0x81)+_0x30d8c8+_0x1c785d(0xf0)+this[_0x1c785d(0x13a)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x1c785d(0x120)](_0x30d8c8);return;}await this[_0x1c785d(0xc4)](_0x30d8c8),console['log'](_0x1c785d(0x113)+_0x30d8c8);}catch(_0x7e70a9){console[_0x1c785d(0x130)]('‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x30d8c8+':',_0x7e70a9),this[_0x1c785d(0xd8)](_0x30d8c8,_0x17f6c9,_0x7e70a9,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0xc50dfc[_0x2e917e(0x144)](_0x450246),this[_0x2e917e(0xaf)][_0x2e917e(0xe5)](_0x30d8c8,{'timers':_0xc50dfc,'paymentId':_0x30d8c8,'gatewayPaymentId':_0x17f6c9,'createdAt':_0x51da3d}),console[_0x2e917e(0xf8)](_0x2e917e(0xbb)+_0x5dddab[_0x2e917e(0x14f)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x30d8c8),console[_0x2e917e(0xf8)]('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x2e917e(0xaf)][_0x2e917e(0x172)]),this['logCoinToPayStatus'](_0x30d8c8,_0x17f6c9,_0x2e917e(0x162),'PENDING',_0x2e917e(0x77),{'action':'schedule_created','scheduledChecks':_0x5dddab[_0x2e917e(0x14f)],'firstCheckIn':_0x5dddab[0x0][_0x2e917e(0x135)]/0x3e8,'totalTimers':this[_0x2e917e(0xaf)]['size']});}['clearPaymentTimers'](_0x121b54){const _0x2667ec=a37_0x21a983,_0x5c89d1=this['paymentTimers'][_0x2667ec(0xc7)](_0x121b54);_0x5c89d1?(console[_0x2667ec(0xf8)](_0x2667ec(0x165)+_0x5c89d1[_0x2667ec(0xef)]['length']+_0x2667ec(0xc9)+_0x121b54),_0x5c89d1[_0x2667ec(0xef)]['forEach']((_0x169a03,_0x132873)=>{const _0x40e009=_0x2667ec;_0x169a03&&(clearTimeout(_0x169a03),clearInterval(_0x169a03),console[_0x40e009(0xf8)](_0x40e009(0xc0)+(_0x132873+0x1)+_0x40e009(0x114)+_0x121b54));}),this[_0x2667ec(0xaf)][_0x2667ec(0x128)](_0x121b54),console[_0x2667ec(0xf8)](_0x2667ec(0x74)+_0x121b54+_0x2667ec(0x90)+this[_0x2667ec(0xaf)][_0x2667ec(0x172)])):console[_0x2667ec(0xf8)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x121b54+'\x20to\x20clear');}async[a37_0x21a983(0xc4)](_0x41deb2){const _0x26c31f=a37_0x21a983;console[_0x26c31f(0xf8)](_0x26c31f(0x12e)+_0x41deb2);const _0x554fe7=await database_1['default'][_0x26c31f(0xc8)][_0x26c31f(0xd3)]({'where':{'id':_0x41deb2},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x554fe7){console[_0x26c31f(0xf8)](_0x26c31f(0x173)+_0x41deb2+'\x20not\x20found\x20in\x20database');return;}console[_0x26c31f(0xf8)]('üìä\x20[CHECK]\x20Payment\x20'+_0x41deb2+_0x26c31f(0xc2)),console['log'](_0x26c31f(0x170)+_0x554fe7[_0x26c31f(0x8b)]),console['log'](_0x26c31f(0x138)+_0x554fe7[_0x26c31f(0x14c)]),console[_0x26c31f(0xf8)](_0x26c31f(0x179)+_0x554fe7[_0x26c31f(0xff)]),console[_0x26c31f(0xf8)](_0x26c31f(0xfe)+_0x554fe7[_0x26c31f(0xcb)]+'\x20'+_0x554fe7[_0x26c31f(0xdc)]),console[_0x26c31f(0xf8)](_0x26c31f(0xb8)+_0x554fe7['shopId']);if(_0x554fe7[_0x26c31f(0x8b)]!==_0x26c31f(0x91)&&_0x554fe7[_0x26c31f(0x8b)]!==_0x26c31f(0xca)){console[_0x26c31f(0xf8)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x41deb2+_0x26c31f(0xc1)+_0x554fe7['gateway']+')');return;}if(_0x554fe7[_0x26c31f(0x14c)]!==_0x26c31f(0x162)){console[_0x26c31f(0xf8)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x41deb2+_0x26c31f(0x15c)+_0x554fe7[_0x26c31f(0x14c)]+_0x26c31f(0x151)),this[_0x26c31f(0x120)](_0x41deb2);return;}if(!_0x554fe7[_0x26c31f(0xff)]){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x41deb2+_0x26c31f(0xa5));return;}console['log'](_0x26c31f(0xc6)+_0x41deb2+_0x26c31f(0x16a)),await this[_0x26c31f(0xfc)](_0x554fe7);}['logCoinToPayStatus'](_0xc33fdf,_0x57b198,_0xe5e415,_0x3086fd,_0x26c86e,_0x4b034f){const _0x1f244b=a37_0x21a983,_0xe0b2b5={'type':_0x1f244b(0xeb),'paymentId':_0xc33fdf,'gatewayPaymentId':_0x57b198,'oldStatus':_0xe5e415,'newStatus':_0x3086fd,'source':_0x26c86e,'timestamp':new Date()[_0x1f244b(0xd1)](),'details':_0x4b034f||{}};loggerService_1[_0x1f244b(0x146)][_0x1f244b(0xbc)](_0xe0b2b5),console[_0x1f244b(0xf8)](_0x1f244b(0x85)+_0xc33fdf+'\x20('+_0x57b198+')'),console[_0x1f244b(0xf8)](_0x1f244b(0x118)+_0xe5e415+_0x1f244b(0xf2)+_0x3086fd),console[_0x1f244b(0xf8)](_0x1f244b(0x10e)+_0x26c86e),console['log']('\x20\x20\x20üìÖ\x20Time:\x20'+_0xe0b2b5[_0x1f244b(0x177)]),_0x4b034f&&console['log'](_0x1f244b(0x11c),_0x4b034f);}[a37_0x21a983(0xd8)](_0x53d826,_0x1361ea,_0x34ca31,_0x18ca1f,_0x520eb5){const _0x1391a7=a37_0x21a983,_0x13ca3c={'type':_0x1391a7(0x126),'paymentId':_0x53d826,'gatewayPaymentId':_0x1361ea,'error':_0x34ca31 instanceof Error?{'message':_0x34ca31['message'],'stack':_0x34ca31['stack']}:_0x34ca31,'source':_0x18ca1f,'timestamp':new Date()[_0x1391a7(0xd1)](),'context':_0x520eb5||{}};loggerService_1[_0x1391a7(0x146)]['logCoinToPayError'](_0x13ca3c),console[_0x1391a7(0x130)]('ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x53d826+'\x20('+_0x1361ea+')'),console[_0x1391a7(0x130)](_0x1391a7(0xf4)+(_0x34ca31 instanceof Error?_0x34ca31['message']:_0x34ca31)),console['error']('\x20\x20\x20üìç\x20Source:\x20'+_0x18ca1f),console[_0x1391a7(0x130)](_0x1391a7(0x92)+_0x13ca3c[_0x1391a7(0x177)]),_0x520eb5&&console[_0x1391a7(0x130)](_0x1391a7(0x141),_0x520eb5);}['startPeriodicStatusCheck'](){const _0x1e68c2=a37_0x21a983;console['log'](_0x1e68c2(0xb6)),this['checkAllPendingPayments']()[_0x1e68c2(0x9b)](_0x44f202=>{const _0x56db0e=_0x1e68c2;console['error'](_0x56db0e(0xa1),_0x44f202);}),this[_0x1e68c2(0x16d)]=setInterval(async()=>{const _0xa1be32=_0x1e68c2;try{console[_0xa1be32(0xf8)]('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this['checkAllPendingPayments'](),console[_0xa1be32(0xf8)](_0xa1be32(0x171));}catch(_0x321d51){console[_0xa1be32(0x130)](_0xa1be32(0x163),_0x321d51);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x1e68c2(0xf8)](_0x1e68c2(0xe8));}[a37_0x21a983(0x9d)](){const _0xe4bd7a=a37_0x21a983;console[_0xe4bd7a(0xf8)](_0xe4bd7a(0x6e));this[_0xe4bd7a(0x16d)]&&(clearInterval(this[_0xe4bd7a(0x16d)]),this['globalCheckInterval']=null,console[_0xe4bd7a(0xf8)]('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x15c4d7=this[_0xe4bd7a(0xaf)][_0xe4bd7a(0x172)];for(const [_0x1b0c93]of this[_0xe4bd7a(0xaf)]){this['clearPaymentTimers'](_0x1b0c93);}console[_0xe4bd7a(0xf8)](_0xe4bd7a(0x72)+_0x15c4d7+'\x20individual\x20payment\x20timers');}async[a37_0x21a983(0x102)](){const _0x547219=a37_0x21a983;try{console[_0x547219(0xf8)](_0x547219(0x10c));const _0x1617a6=await database_1['default']['payment'][_0x547219(0x12c)]({'where':{'gateway':{'in':['cointopay','cointopay2']},'status':_0x547219(0x162),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x547219(0xd9)+_0x1617a6[_0x547219(0x14f)]+'\x20pending\x20CoinToPay\x20payments');if(_0x1617a6[_0x547219(0x14f)]===0x0){console[_0x547219(0xf8)](_0x547219(0x83));return;}const _0x5873f3=await this[_0x547219(0xaa)](_0x1617a6);console[_0x547219(0xf8)](_0x547219(0x98)+_0x5873f3['length']+_0x547219(0x109));let _0xcdb80c=0x0,_0x833b5b=0x0;for(const _0x143a9c of _0x1617a6){try{if(_0x5873f3[_0x547219(0xb5)](_0x143a9c['id'])){console[_0x547219(0xf8)](_0x547219(0x7e)+_0x143a9c['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x833b5b++;continue;}if(this[_0x547219(0xaf)][_0x547219(0x115)](_0x143a9c['id'])){console[_0x547219(0xf8)](_0x547219(0x7e)+_0x143a9c['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x833b5b++;continue;}const _0x1739d6=(Date[_0x547219(0x10d)]()-_0x143a9c[_0x547219(0x106)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x1739d6<0x1){console['log'](_0x547219(0x7e)+_0x143a9c['id']+_0x547219(0x13f)+_0x1739d6[_0x547219(0xa8)](0x1)+_0x547219(0x15b)),_0x833b5b++;continue;}console[_0x547219(0xf8)](_0x547219(0x73)+_0x143a9c['id']+_0x547219(0x94)+_0x1739d6[_0x547219(0xa8)](0x1)+'h)'),await this['checkSinglePayment'](_0x143a9c),_0xcdb80c++,await new Promise(_0x4b0b6e=>setTimeout(_0x4b0b6e,0x7d0));}catch(_0x562ecc){console['error'](_0x547219(0x176)+_0x143a9c['id']+':',_0x562ecc),this[_0x547219(0xd8)](_0x143a9c['id'],_0x143a9c[_0x547219(0xff)]||_0x547219(0xb3),_0x562ecc,_0x547219(0x77),{'isGlobalCheck':!![],'paymentAmount':_0x143a9c[_0x547219(0xcb)],'paymentCurrency':_0x143a9c['currency'],'shopId':_0x143a9c[_0x547219(0xb1)],'createdAt':_0x143a9c[_0x547219(0x106)]}),loggerService_1[_0x547219(0x146)][_0x547219(0xdf)](_0x547219(0x91),_0x547219(0x79)+_0x143a9c[_0x547219(0xff)],_0x562ecc);}}console['log'](_0x547219(0x12f)+_0xcdb80c+_0x547219(0x84)+_0x833b5b+_0x547219(0xbd)+_0x5873f3[_0x547219(0x14f)]+_0x547219(0xdb));}catch(_0x21e119){console[_0x547219(0x130)](_0x547219(0x136),_0x21e119);}}async[a37_0x21a983(0xaa)](_0x37b0d7){const _0x2aeac=a37_0x21a983,_0x12ba41=[],_0x5bd53e=new Date();_0x5bd53e[_0x2aeac(0xb2)](_0x5bd53e['getDate']()-this[_0x2aeac(0x13a)]),console[_0x2aeac(0xf8)](_0x2aeac(0x116)+this[_0x2aeac(0x13a)]+_0x2aeac(0x110)+_0x5bd53e[_0x2aeac(0xd1)]()+')');for(const _0x4948fb of _0x37b0d7){if(_0x4948fb[_0x2aeac(0x106)]<_0x5bd53e){console['log'](_0x2aeac(0x175)+_0x4948fb['id']+_0x2aeac(0xf0)+this[_0x2aeac(0x13a)]+_0x2aeac(0xd4));try{this[_0x2aeac(0xbc)](_0x4948fb['id'],_0x4948fb['gatewayPaymentId']||_0x2aeac(0xb3),_0x2aeac(0x162),'EXPIRED',_0x2aeac(0x10b),{'reason':_0x2aeac(0x161)+this[_0x2aeac(0x13a)]+_0x2aeac(0xdd),'createdAt':_0x4948fb['createdAt'],'daysSinceCreation':Math[_0x2aeac(0xe1)]((Date[_0x2aeac(0x10d)]()-_0x4948fb['createdAt'][_0x2aeac(0x156)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x4948fb[_0x2aeac(0xcb)],'paymentCurrency':_0x4948fb['currency'],'shopId':_0x4948fb[_0x2aeac(0xb1)]}),await database_1[_0x2aeac(0x167)]['payment']['update']({'where':{'id':_0x4948fb['id']},'data':{'status':_0x2aeac(0xd2),'updatedAt':new Date(),'adminNotes':_0x2aeac(0x140)+this[_0x2aeac(0x13a)]+_0x2aeac(0x16b)}}),await database_1['default'][_0x2aeac(0x82)][_0x2aeac(0x134)]({'data':{'paymentId':_0x4948fb['id'],'shopId':_0x4948fb[_0x2aeac(0xb1)],'event':_0x2aeac(0x147),'statusCode':0xc8,'responseBody':JSON[_0x2aeac(0x9c)]({'reason':_0x2aeac(0x161)+this[_0x2aeac(0x13a)]+_0x2aeac(0xdd),'createdAt':_0x4948fb['createdAt'],'expiredAt':new Date()[_0x2aeac(0xd1)](),'daysSinceCreation':Math['floor']((Date[_0x2aeac(0x10d)]()-_0x4948fb[_0x2aeac(0x106)][_0x2aeac(0x156)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x2aeac(0x121)](_0x4948fb,'EXPIRED'),await this[_0x2aeac(0xa0)](_0x4948fb,'EXPIRED'),this[_0x2aeac(0x120)](_0x4948fb['id']),_0x12ba41[_0x2aeac(0x144)](_0x4948fb['id']),console['log'](_0x2aeac(0xd5)+_0x4948fb['id']+_0x2aeac(0x169)+this[_0x2aeac(0x13a)]+_0x2aeac(0x97));}catch(_0x305233){console[_0x2aeac(0x130)](_0x2aeac(0x159)+_0x4948fb['id']+':',_0x305233),this[_0x2aeac(0xd8)](_0x4948fb['id'],_0x4948fb[_0x2aeac(0xff)]||_0x2aeac(0xb3),_0x305233,'auto_expire',{'reason':_0x2aeac(0xfb),'createdAt':_0x4948fb[_0x2aeac(0x106)],'daysSinceCreation':Math[_0x2aeac(0xe1)]((Date[_0x2aeac(0x10d)]()-_0x4948fb[_0x2aeac(0x106)][_0x2aeac(0x156)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x12ba41;}async[a37_0x21a983(0xfc)](_0x942168){const _0x25c37c=a37_0x21a983;if(!_0x942168[_0x25c37c(0xff)]){console[_0x25c37c(0xf8)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x942168['id']+_0x25c37c(0xbf));return;}console[_0x25c37c(0xf8)](_0x25c37c(0xd0)+_0x942168[_0x25c37c(0x8b)]+_0x25c37c(0xe2)+_0x942168['id']+'\x20('+_0x942168[_0x25c37c(0xff)]+')');try{let _0x53fbbd;_0x942168[_0x25c37c(0x8b)]===_0x25c37c(0xca)?(_0x53fbbd=await this['coinToPay2Service'][_0x25c37c(0x96)](_0x942168[_0x25c37c(0xff)]),console['log']('üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x942168['id']+_0x25c37c(0x93)+_0x53fbbd[_0x25c37c(0x14c)])):(_0x53fbbd=await this[_0x25c37c(0x149)]['checkPaymentStatus'](_0x942168['gatewayPaymentId']),console['log'](_0x25c37c(0x164)+_0x942168['id']+'\x20status:\x20'+_0x53fbbd[_0x25c37c(0x14c)]));_0x53fbbd[_0x25c37c(0x133)]&&console[_0x25c37c(0xf8)]('üìä\x20[CHECK]\x20Payment\x20'+_0x942168['id']+_0x25c37c(0xd6),{'iban':_0x53fbbd[_0x25c37c(0x133)][_0x25c37c(0xf6)]||'not\x20found','transactionId':_0x53fbbd[_0x25c37c(0x133)][_0x25c37c(0x12b)],'createdOn':_0x53fbbd[_0x25c37c(0x133)]['createdOn'],'confirmedOn':_0x53fbbd[_0x25c37c(0x133)][_0x25c37c(0x124)]||'not\x20confirmed'});if(_0x53fbbd['status']!==_0x942168[_0x25c37c(0x14c)]){console[_0x25c37c(0xf8)](_0x25c37c(0x16f)+_0x942168['id']+_0x25c37c(0x99)+_0x942168['status']+_0x25c37c(0x88)+_0x53fbbd[_0x25c37c(0x14c)]),this[_0x25c37c(0xbc)](_0x942168['id'],_0x942168[_0x25c37c(0xff)],_0x942168[_0x25c37c(0x14c)],_0x53fbbd[_0x25c37c(0x14c)],_0x25c37c(0x77),{'paymentDetails':_0x53fbbd[_0x25c37c(0x133)],'amount':_0x53fbbd[_0x25c37c(0xcb)],'currency':_0x53fbbd[_0x25c37c(0xdc)],'shopId':_0x942168[_0x25c37c(0xb1)],'checkTimestamp':new Date()[_0x25c37c(0xd1)]()});const _0x449039={'status':_0x53fbbd[_0x25c37c(0x14c)],'updatedAt':new Date()};if(_0x53fbbd['status']===_0x25c37c(0x150)&&_0x942168[_0x25c37c(0x14c)]!==_0x25c37c(0x150)){_0x449039[_0x25c37c(0x152)]=new Date();if(!_0x942168['amountUSDT']){const _0x421d7d=await currencyService_1[_0x25c37c(0x125)]['convertToUSDT'](_0x942168[_0x25c37c(0xcb)],_0x942168['currency']);_0x449039[_0x25c37c(0x80)]=_0x421d7d;const _0x40f9c4=await this['getGatewayCommission'](_0x942168[_0x25c37c(0xb1)],_0x942168[_0x25c37c(0x8b)]),_0x1a2cd2=_0x421d7d*(0x1-_0x40f9c4/0x64);_0x449039[_0x25c37c(0x13b)]=_0x1a2cd2,console[_0x25c37c(0xf8)](_0x25c37c(0x104)+_0x942168['id']+_0x25c37c(0x13e)),console[_0x25c37c(0xf8)](_0x25c37c(0x75)+_0x942168['amount']+'\x20'+_0x942168['currency']+_0x25c37c(0xf2)+_0x421d7d[_0x25c37c(0xa8)](0x6)+_0x25c37c(0x143)),console[_0x25c37c(0xf8)](_0x25c37c(0x15d)+_0x942168[_0x25c37c(0x8b)]+_0x25c37c(0xfd)+_0x40f9c4+'%'),console[_0x25c37c(0xf8)](_0x25c37c(0x145)+_0x1a2cd2[_0x25c37c(0xa8)](0x6)+_0x25c37c(0x143));}console[_0x25c37c(0xf8)](_0x25c37c(0x104)+_0x942168['id']+_0x25c37c(0x8c)+_0x449039[_0x25c37c(0x152)][_0x25c37c(0xd1)]());}if(_0x53fbbd[_0x25c37c(0x133)]){const _0x2e04ed=_0x53fbbd[_0x25c37c(0x133)];_0x2e04ed[_0x25c37c(0xf6)]&&(_0x449039[_0x25c37c(0xe9)]=_0x2e04ed['iban'],console[_0x25c37c(0xf8)](_0x25c37c(0x107)+_0x2e04ed['iban']));if(_0x2e04ed[_0x25c37c(0xfa)]){const _0x15859e=_0x942168['adminNotes']||'',_0x3f16c8=_0x25c37c(0x154)+_0x2e04ed[_0x25c37c(0xfa)];_0x449039[_0x25c37c(0x89)]=_0x15859e?_0x15859e+'\x0a\x0a'+_0x3f16c8:_0x3f16c8,console[_0x25c37c(0xf8)]('üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x2e04ed[_0x25c37c(0x12b)]&&console[_0x25c37c(0xf8)]('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x2e04ed[_0x25c37c(0x12b)]),_0x2e04ed[_0x25c37c(0x124)]&&console[_0x25c37c(0xf8)](_0x25c37c(0x7a)+_0x2e04ed[_0x25c37c(0x124)]);}await database_1[_0x25c37c(0x167)][_0x25c37c(0xc8)][_0x25c37c(0x78)]({'where':{'id':_0x942168['id']},'data':_0x449039});if(_0x53fbbd[_0x25c37c(0x14c)]===_0x25c37c(0x150)&&_0x942168[_0x25c37c(0x14c)]!==_0x25c37c(0x150)){console[_0x25c37c(0xf8)](_0x25c37c(0x129)+_0x942168['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x4e8195=await database_1[_0x25c37c(0x167)][_0x25c37c(0xc8)][_0x25c37c(0xd3)]({'where':{'id':_0x942168['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x4e8195?.['paymentLinkId']&&_0x4e8195[_0x25c37c(0x119)])try{const _0x130abc=_0x4e8195[_0x25c37c(0x119)];console[_0x25c37c(0xf8)]('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x130abc['id']+_0x25c37c(0xea)+_0x130abc[_0x25c37c(0xf1)]+_0x25c37c(0x11b)+_0x130abc[_0x25c37c(0x15f)]+_0x25c37c(0x86)+_0x130abc['status']);const _0x5944f7=_0x130abc[_0x25c37c(0x15f)]+0x1,_0x577347=_0x130abc[_0x25c37c(0xf1)]===_0x25c37c(0x178)?_0x25c37c(0x11a):_0x130abc[_0x25c37c(0x14c)];await database_1[_0x25c37c(0x167)][_0x25c37c(0x119)][_0x25c37c(0x78)]({'where':{'id':_0x130abc['id']},'data':{'currentPayments':_0x5944f7,'status':_0x577347,'updatedAt':new Date()}}),console[_0x25c37c(0xf8)](_0x25c37c(0xee)+_0x130abc['id']+_0x25c37c(0xb4)+_0x130abc[_0x25c37c(0x15f)]+_0x25c37c(0xf2)+_0x5944f7+',\x20status='+_0x130abc[_0x25c37c(0x14c)]+_0x25c37c(0xf2)+_0x577347);}catch(_0x345e50){console[_0x25c37c(0x130)]('‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:',_0x345e50);}else console[_0x25c37c(0xf8)](_0x25c37c(0x129)+_0x942168['id']+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}await database_1[_0x25c37c(0x167)]['webhookLog'][_0x25c37c(0x134)]({'data':{'paymentId':_0x942168['id'],'shopId':_0x942168['shopId'],'event':_0x25c37c(0x7d)+_0x53fbbd[_0x25c37c(0x14c)][_0x25c37c(0x13d)](),'statusCode':0xc8,'responseBody':JSON[_0x25c37c(0x9c)]({'oldStatus':_0x942168['status'],'newStatus':_0x53fbbd[_0x25c37c(0x14c)],'paymentDetails':_0x53fbbd['paymentDetails'],'checkedAt':new Date()[_0x25c37c(0xd1)]()})}}),await this['sendShopWebhook'](_0x942168,_0x53fbbd[_0x25c37c(0x14c)]),await this['sendPaymentStatusNotification'](_0x942168,_0x53fbbd[_0x25c37c(0x14c)]),_0x53fbbd[_0x25c37c(0x14c)]!=='PENDING'&&(console['log'](_0x25c37c(0x15e)+_0x942168['id']+'\x20status\x20changed\x20to\x20'+_0x53fbbd[_0x25c37c(0x14c)]+_0x25c37c(0x8f)),this['clearPaymentTimers'](_0x942168['id'])),console[_0x25c37c(0xf8)](_0x25c37c(0xc6)+_0x942168['id']+'\x20updated\x20successfully');}else console[_0x25c37c(0xf8)](_0x25c37c(0xb9)+_0x942168['id']+'\x20status\x20unchanged\x20('+_0x53fbbd[_0x25c37c(0x14c)]+')'),this[_0x25c37c(0xbc)](_0x942168['id'],_0x942168['gatewayPaymentId'],_0x942168[_0x25c37c(0x14c)],_0x53fbbd[_0x25c37c(0x14c)],_0x25c37c(0x77),{'statusUnchanged':!![],'paymentDetails':_0x53fbbd[_0x25c37c(0x133)],'amount':_0x53fbbd['amount'],'currency':_0x53fbbd[_0x25c37c(0xdc)],'shopId':_0x942168[_0x25c37c(0xb1)],'checkTimestamp':new Date()[_0x25c37c(0xd1)]()});}catch(_0x5e13d9){console[_0x25c37c(0x130)](_0x25c37c(0x11f)+_0x942168['id']+':',_0x5e13d9),this[_0x25c37c(0xd8)](_0x942168['id'],_0x942168[_0x25c37c(0xff)],_0x5e13d9,_0x25c37c(0x77),{'paymentAmount':_0x942168[_0x25c37c(0xcb)],'paymentCurrency':_0x942168['currency'],'shopId':_0x942168[_0x25c37c(0xb1)],'createdAt':_0x942168[_0x25c37c(0x106)]}),await database_1[_0x25c37c(0x167)][_0x25c37c(0x82)][_0x25c37c(0x134)]({'data':{'paymentId':_0x942168['id'],'shopId':_0x942168[_0x25c37c(0xb1)],'event':_0x25c37c(0x137),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x5e13d9 instanceof Error?_0x5e13d9[_0x25c37c(0xb0)]:'Unknown\x20error','gatewayPaymentId':_0x942168[_0x25c37c(0xff)],'checkedAt':new Date()[_0x25c37c(0xd1)]()})}});}}async[a37_0x21a983(0x121)](_0x541694,_0x40038c){const _0x5e6b87=a37_0x21a983,_0x74dd28=Date[_0x5e6b87(0x10d)]();try{const _0x8595ac=_0x541694[_0x5e6b87(0x155)],_0x4aa8c6=_0x8595ac[_0x5e6b87(0x87)];if(!_0x4aa8c6?.['webhookUrl']){console[_0x5e6b87(0xf8)](_0x5e6b87(0x17a)+_0x8595ac['id']);return;}const _0x5c037e=_0x40038c===_0x5e6b87(0x150)?_0x5e6b87(0xde):_0x40038c===_0x5e6b87(0x14e)?'payment.failed':_0x40038c===_0x5e6b87(0xd2)?_0x5e6b87(0xba):_0x5e6b87(0xac);if(!_0x4aa8c6['webhookEvents']?.[_0x5e6b87(0xb5)](_0x5c037e)){console[_0x5e6b87(0xf8)]('Webhook\x20event\x20'+_0x5c037e+_0x5e6b87(0xf3)+_0x8595ac['id']);return;}const _0x34776f=(0x0,gateway_1['getGatewayIdByName'])(_0x541694[_0x5e6b87(0x8b)])||_0x541694['gateway'],_0x4fd0c7={'event':_0x5c037e,'payment':{'id':_0x541694['id'],'order_id':_0x541694[_0x5e6b87(0x9f)],'gateway_order_id':_0x541694[_0x5e6b87(0x14b)],'gateway':_0x34776f,'amount':_0x541694[_0x5e6b87(0xcb)],'currency':_0x541694[_0x5e6b87(0xdc)],'status':_0x40038c[_0x5e6b87(0x13d)](),'customer_email':_0x541694[_0x5e6b87(0x9a)],'customer_name':_0x541694[_0x5e6b87(0xf7)],'created_at':_0x541694[_0x5e6b87(0x106)],'updated_at':new Date()}},_0xab4bf9=await fetch(_0x4aa8c6[_0x5e6b87(0x16e)],{'method':_0x5e6b87(0xae),'headers':{'Content-Type':_0x5e6b87(0x160),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x5e6b87(0x9c)](_0x4fd0c7)}),_0x33828b=Date['now']()-_0x74dd28,_0x4bfadb=_0xab4bf9['ok']?_0x5e6b87(0x11d):await _0xab4bf9[_0x5e6b87(0x132)]();loggerService_1[_0x5e6b87(0x146)]['logShopWebhookSent'](_0x541694[_0x5e6b87(0xb1)],_0x4aa8c6[_0x5e6b87(0x16e)],_0x5c037e,_0xab4bf9[_0x5e6b87(0x14c)],_0x33828b,_0x4fd0c7),console[_0x5e6b87(0xf8)](_0x5e6b87(0x157)+_0x4aa8c6['webhookUrl']+_0x5e6b87(0x6f)+_0xab4bf9['status']+'\x20('+_0x33828b+_0x5e6b87(0x7c));}catch(_0x31b75f){console[_0x5e6b87(0x130)](_0x5e6b87(0x100),_0x31b75f),loggerService_1[_0x5e6b87(0x146)][_0x5e6b87(0x148)](_0x541694['shopId'],_0x541694[_0x5e6b87(0x155)]?.[_0x5e6b87(0x87)]?.[_0x5e6b87(0x16e)]||_0x5e6b87(0xb3),_0x5e6b87(0x127),_0x31b75f,{});}}async['sendPaymentStatusNotification'](_0x6b4120,_0x589089){const _0x30a53d=a37_0x21a983;try{const _0x2b77f2={'PENDING':_0x30a53d(0x8d),'PAID':_0x30a53d(0xcc),'FAILED':_0x30a53d(0xe6),'EXPIRED':_0x30a53d(0x142)},_0x4be671=_0x2b77f2[_0x589089];if(!_0x4be671||_0x4be671==='created')return;await telegramBotService_1['telegramBotService'][_0x30a53d(0xe4)](_0x6b4120[_0x30a53d(0xb1)],_0x6b4120,_0x4be671);}catch(_0x42ae14){console[_0x30a53d(0x130)](_0x30a53d(0x12a),_0x42ae14);}}async['checkPaymentById'](_0x50b749){const _0x4fb85a=a37_0x21a983;console[_0x4fb85a(0xf8)](_0x4fb85a(0xf9)+_0x50b749);const _0x1eb28d=await database_1[_0x4fb85a(0x167)][_0x4fb85a(0xc8)][_0x4fb85a(0xd3)]({'where':{'id':_0x50b749},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1eb28d)throw new Error(_0x4fb85a(0x9e));if(_0x1eb28d[_0x4fb85a(0x8b)]!==_0x4fb85a(0x91)&&_0x1eb28d['gateway']!=='cointopay2')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x4fb85a(0xf8)](_0x4fb85a(0xce)+_0x1eb28d['gateway']+_0x4fb85a(0xe2)+_0x50b749),await this[_0x4fb85a(0xfc)](_0x1eb28d),console[_0x4fb85a(0xf8)](_0x4fb85a(0x158)+_0x50b749);}[a37_0x21a983(0x8a)](){const _0x3b3261=a37_0x21a983,_0x32a2a7=this[_0x3b3261(0x16d)]?this[_0x3b3261(0x7b)]:undefined,_0x14da39=Array['from'](this[_0x3b3261(0xaf)][_0x3b3261(0x14d)]())[_0x3b3261(0x13c)](_0x5c0aee=>({'paymentId':_0x5c0aee[_0x3b3261(0x117)],'gatewayPaymentId':_0x5c0aee[_0x3b3261(0xff)],'createdAt':_0x5c0aee[_0x3b3261(0x106)],'timersCount':_0x5c0aee[_0x3b3261(0xef)]['length']}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x3b3261(0x7b)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this['paymentTimers']['size'],'nextGlobalCheckIn':_0x32a2a7,'paymentTimersDetails':_0x14da39};}[a37_0x21a983(0x101)](_0x3944a9){const _0x5be2ad=a37_0x21a983,_0x23284e=this['paymentTimers'][_0x5be2ad(0xc7)](_0x3944a9);if(_0x23284e)return{'hasTimers':!![],'timersCount':_0x23284e[_0x5be2ad(0xef)]['length'],'createdAt':_0x23284e[_0x5be2ad(0x106)],'gatewayPaymentId':_0x23284e['gatewayPaymentId']};return{'hasTimers':![]};}async['getGatewayCommission'](_0x89df9b,_0xb36ded){const _0x4b35da=a37_0x21a983;try{const _0x532396=await database_1['default']['shop'][_0x4b35da(0xd3)]({'where':{'id':_0x89df9b},'select':{'gatewaySettings':!![]}});if(!_0x532396?.[_0x4b35da(0x16c)])return console[_0x4b35da(0xf8)]('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x89df9b+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x38fad9=JSON[_0x4b35da(0x71)](_0x532396[_0x4b35da(0x16c)]);for(const [_0x28d70c,_0x169d7]of Object['entries'](_0x38fad9)){if(_0x28d70c['toLowerCase']()===_0xb36ded[_0x4b35da(0x13d)]()){const _0x4b545e=_0x169d7[_0x4b35da(0xb7)]||0xa;return console['log'](_0x4b35da(0x168)+_0xb36ded+_0x4b35da(0xa6)+_0x89df9b+':\x20'+_0x4b545e+'%'),_0x4b545e;}}return console[_0x4b35da(0xf8)](_0x4b35da(0x12d)+_0xb36ded+'\x20in\x20shop\x20'+_0x89df9b+',\x20using\x20default\x2010%'),0xa;}catch(_0x8e8ef7){return console['error'](_0x4b35da(0xc3)+_0x89df9b+_0x4b35da(0x95)+_0xb36ded+':',_0x8e8ef7),0xa;}}}exports[a37_0x21a983(0xe0)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();