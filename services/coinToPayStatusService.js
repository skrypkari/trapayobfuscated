'use strict';const a42_0x3ace4=a42_0x2832;function a42_0x2832(_0x3358b5,_0x578045){const _0x224c6d=a42_0x224c();return a42_0x2832=function(_0x283256,_0x153e58){_0x283256=_0x283256-0xc4;let _0x49a0de=_0x224c6d[_0x283256];return _0x49a0de;},a42_0x2832(_0x3358b5,_0x578045);}(function(_0x1f3d1f,_0x403514){const _0x2d8c27=a42_0x2832,_0xcd4070=_0x1f3d1f();while(!![]){try{const _0x1b014d=-parseInt(_0x2d8c27(0x16b))/0x1+parseInt(_0x2d8c27(0x192))/0x2+parseInt(_0x2d8c27(0x14c))/0x3*(-parseInt(_0x2d8c27(0x115))/0x4)+-parseInt(_0x2d8c27(0x1bf))/0x5+-parseInt(_0x2d8c27(0x11f))/0x6*(-parseInt(_0x2d8c27(0x1b4))/0x7)+parseInt(_0x2d8c27(0xc4))/0x8+parseInt(_0x2d8c27(0x11c))/0x9;if(_0x1b014d===_0x403514)break;else _0xcd4070['push'](_0xcd4070['shift']());}catch(_0x898dca){_0xcd4070['push'](_0xcd4070['shift']());}}}(a42_0x224c,0x70437));function a42_0x224c(){const _0x13c623=['setDate','6898356DirAIb','\x20status\x20is\x20',':\x20type=','474tPRWYt','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','EXPIRED','push','checkPaymentById','getTime','set','CoinToPayService','/status/','map','created','\x20\x20\x20üìù\x20Details:','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','toISOString','üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','has','findUnique','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20->\x20','gatewaySettings','\x20is\x20older\x20than\x20','now','settings','üìà\x20[COINTOPAY]\x20Payment\x20','amount','application/json','\x20with\x20status\x20','h),\x20skipping\x20global\x20check','getServiceStats','\x20pending\x20CoinToPay\x20payments','status_check','toLowerCase','parse','\x20current\x20status:\x20','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','entries','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','sendShopWebhook','coinToPay2Service','\x20\x20\x20üìù\x20Context:','webhook_send','Success','findMany','checkSinglePaymentById','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','3jZvYBM','.\x20Remaining\x20active\x20timers:\x20','values','gatewayOrderId','\x20to\x20clear','\x20\x20\x20-\x20ShopId:\x20','cointopay_status_check_error','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20\x20\x20-\x20Amount:\x20','customerEmail','forEach','./telegramBotService','üõë\x20[SHUTDOWN]\x20Cleared\x20','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','get','stopPeriodicStatusCheck','-day\x20timeout','\x20not\x20enabled\x20for\x20shop\x20','webhookLog','../types/gateway','\x20details:','bankDetails','‚è∞\x20[GLOBAL]\x20Found\x20','\x20USDT','‚úÖ\x20[HOURLY]\x20Payment\x20','\x20timers\x20for\x20payment\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','status',',\x20currentPayments=','COMPLETED','getPaymentTimerInfo','389769iukyQu','PAID','ü™ô\x20[DEBUG]\x20Creating\x20','paymentDetails','gatewayPaymentId','\x20for\x20payment\x20','\x20(after\x20','\x20\x20\x20-\x20Status:\x20','POST','\x20commission:\x20','text','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','shop','sendPaymentStatusNotification','‚è∞\x20[EXPIRY]\x20Payment\x20','Gateway\x20','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','cointopay_status_check_','startPeriodicStatusCheck','amountAfterGatewayCommissionUSDT','iban','loggerService','\x20initial\x20timers\x20for\x20payment\x20','GLOBAL_CHECK_INTERVAL_MS','CoinToPayStatusService','not\x20confirmed','\x20amounts\x20calculated:','remitterIban','‚è∞\x20[GLOBAL]\x20Payment\x20','COINTOPAY_STATUS_CHANGE','üßπ\x20[CHECK]\x20Payment\x20','paymentLink','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','paidAt','üîç\x20[CHECK]\x20Checking\x20','\x20status\x20from\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','1094848vwQIzW','cointopay2','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','FAILED','getDate','./loggerService','üí∞\x20[CHECK]\x20Payment\x20','checkSinglePayment','transactionId','gateway','not\x20found','type','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','\x20days\x20(created\x20before\x20','\x20is\x20too\x20new\x20(','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','createdAt','logShopWebhookSent','\x20updated\x20successfully','ü™ô\x20[GLOBAL]\x20Found\x20','logCoinToPayError','./gateways/coinToPayService','\x20\x20\x20-\x20paymentId:\x20','currency','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','Failed\x20to\x20mark\x20payment\x20as\x20expired','getGatewayIdByName','\x20days','description','from','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','orderId','\x20expired\x20CoinToPay\x20payments','42469DjKekL','paid',',\x20clearing\x20individual\x20timers','__esModule','paymentLinkId','auto_expire','globalCheckInterval','‚úÖ\x20[CHECK]\x20Payment\x20','\x20\x20\x20üìç\x20Source:\x20','payment.failed',',\x20status=','3027735qeNYff','size','payment','üìä\x20[CHECK]\x20Payment\x20','./currencyService','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','PENDING','webhookEvents','coinToPayService','\x20has\x20no\x20gatewayPaymentId','checkPaymentStatus','delay','shopId','stringify','\x20payment\x20','log','expired','\x20status\x20unchanged\x20(','3901504fwVyKB',',\x20using\x20default\x2010%','\x20updated:\x20currentPayments=','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20checked,\x20','paymentTimers','Payment\x20not\x20found','\x20seconds\x20(','checkExpiredPayments','\x20status:\x20','‚ùå\x20[HOURLY]\x20Payment\x20','__importDefault','cointopay','\x20individual\x20payment\x20timers','üè¶\x20[CHECK]\x20Bank\x20details\x20provided:\x20','checkAllPendingPayments','\x20to\x20','üßπ\x20[DEBUG]\x20Clearing\x20','EXPIRY_DAYS','default','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','üìä\x20[HOURLY]\x20Payment\x20','\x20found:','clearPaymentTimers','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','\x20not\x20found,\x20clearing\x20timers','\x20\x20\x20‚ùå\x20Error:\x20','convertToUSDT','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','Failed\x20to\x20send\x20shop\x20webhook:','amountUSDT',',\x20using\x20default\x20commission\x2010%','\x20status\x20changed\x20to\x20','message','\x20\x20\x20-\x20Gateway:\x20','commission','webhookUrl','\x20is\x20valid\x20for\x20checking,\x20proceeding...','currentPayments','update','getGatewayCommission','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','Unknown\x20error','coinToPayStatusService','COINTOPAY_ERROR','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','error','\x20days,\x20marking\x20as\x20EXPIRED','‚ùå\x20[CHECK]\x20Payment\x20','2\x20minutes','‚è∞\x20[HOURLY]\x20Payment\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','confirmedOn','length','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','catch','\x20commission\x20for\x20shop\x20','failed','unknown','\x20\x20\x20üìä\x20Status:\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','floor','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','\x20marked\x20as\x20paid\x20at:\x20','payment.success','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','logCoinToPayStatus','CoinToPay2Service','timers','5\x20minutes','telegramBotService','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','timestamp','\x20\x20\x20üìÖ\x20Time:\x20','./gateways/coinToPay2Service','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','\x20skipped,\x20','toFixed','3302968AalsDp','\x20\x20\x20-\x20gatewayPaymentId:\x20','create','includes','../config/database','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'];a42_0x224c=function(){return _0x13c623;};return a42_0x224c();}var __importDefault=this&&this[a42_0x3ace4(0xd0)]||function(_0x4894fc){const _0x1f6e51=a42_0x3ace4;return _0x4894fc&&_0x4894fc[_0x1f6e51(0x1b7)]?_0x4894fc:{'default':_0x4894fc};};Object['defineProperty'](exports,a42_0x3ace4(0x1b7),{'value':!![]}),exports[a42_0x3ace4(0xf1)]=exports[a42_0x3ace4(0x185)]=void 0x0;const coinToPayService_1=require(a42_0x3ace4(0x1a8)),coinToPay2Service_1=require(a42_0x3ace4(0x111)),gateway_1=require(a42_0x3ace4(0x15f)),database_1=__importDefault(require(a42_0x3ace4(0x119))),telegramBotService_1=require(a42_0x3ace4(0x157)),loggerService_1=require(a42_0x3ace4(0x197)),currencyService_1=require(a42_0x3ace4(0x1c3));class CoinToPayStatusService{constructor(){const _0x25aca9=a42_0x3ace4;this[_0x25aca9(0x1ba)]=null,this[_0x25aca9(0x184)]=0x3c*0x3c*0x3e8,this[_0x25aca9(0xd7)]=0x5,this['paymentTimers']=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x25aca9(0x126))](),this[_0x25aca9(0x145)]=new coinToPay2Service_1[(_0x25aca9(0x10a))](),console[_0x25aca9(0x1cf)](_0x25aca9(0x112));}['schedulePaymentChecks'](_0x5e4bfa,_0x37a8ca){const _0x1fb1dc=a42_0x3ace4;console[_0x1fb1dc(0x1cf)](_0x1fb1dc(0xe1)),console[_0x1fb1dc(0x1cf)](_0x1fb1dc(0x1a9)+_0x5e4bfa),console[_0x1fb1dc(0x1cf)](_0x1fb1dc(0x116)+_0x37a8ca),this['clearPaymentTimers'](_0x5e4bfa);const _0x46e00e=[],_0x9ad6ab=new Date(),_0x1d3bdc=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x1fb1dc(0xf7)},{'delay':0x5*0x3c*0x3e8,'description':_0x1fb1dc(0x10c)},{'delay':0x5*0x3c*0x3e8,'description':_0x1fb1dc(0x10c)}];console[_0x1fb1dc(0x1cf)](_0x1fb1dc(0x16d)+_0x1d3bdc[_0x1fb1dc(0xfb)]+_0x1fb1dc(0x183)+_0x5e4bfa);let _0x366938=0x0;_0x1d3bdc[_0x1fb1dc(0x156)]((_0x4b1f81,_0x48506d)=>{const _0x4f0171=_0x1fb1dc;_0x366938+=_0x4b1f81[_0x4f0171(0x1cb)];const _0x4482c5=setTimeout(async()=>{const _0x54962c=_0x4f0171;console[_0x54962c(0x1cf)](_0x54962c(0x17c)+(_0x48506d+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x5e4bfa+_0x54962c(0x171)+_0x4b1f81[_0x54962c(0x1af)]+')');try{await this['checkSinglePaymentById'](_0x5e4bfa),console[_0x54962c(0x1cf)]('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x48506d+0x1)+'\x20completed\x20for\x20payment\x20'+_0x5e4bfa);}catch(_0x170e3f){console['error'](_0x54962c(0x1c4)+(_0x48506d+0x1)+_0x54962c(0x170)+_0x5e4bfa+':',_0x170e3f),this['logCoinToPayError'](_0x5e4bfa,_0x37a8ca,_0x170e3f,_0x54962c(0x13d),{'checkNumber':_0x48506d+0x1,'scheduledAfter':_0x4b1f81[_0x54962c(0x1af)],'isIndividualCheck':!![]});}},_0x366938);_0x46e00e[_0x4f0171(0x122)](_0x4482c5),console[_0x4f0171(0x1cf)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x48506d+0x1)+_0x4f0171(0x170)+_0x5e4bfa+'\x20in\x20'+_0x366938/0x3e8+_0x4f0171(0xcc)+_0x4b1f81[_0x4f0171(0x1af)]+')');});const _0x22c2b1=setInterval(async()=>{const _0x1033b9=_0x1fb1dc;console[_0x1033b9(0x1cf)](_0x1033b9(0x130)+_0x5e4bfa);try{const _0x122413=await database_1['default'][_0x1033b9(0x1c1)][_0x1033b9(0x12f)]({'where':{'id':_0x5e4bfa},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x122413){console[_0x1033b9(0x1cf)](_0x1033b9(0xcf)+_0x5e4bfa+_0x1033b9(0xde)),this[_0x1033b9(0xdc)](_0x5e4bfa);return;}console[_0x1033b9(0x1cf)](_0x1033b9(0xda)+_0x5e4bfa+_0x1033b9(0x140)+_0x122413[_0x1033b9(0x167)]);if(_0x122413[_0x1033b9(0x167)]!==_0x1033b9(0x1c6)){console[_0x1033b9(0x1cf)](_0x1033b9(0x164)+_0x5e4bfa+_0x1033b9(0x11d)+_0x122413[_0x1033b9(0x167)]+',\x20stopping\x20individual\x20checks'),this[_0x1033b9(0xdc)](_0x5e4bfa);return;}const _0x10fee0=Math[_0x1033b9(0x103)]((Date[_0x1033b9(0x134)]()-_0x122413[_0x1033b9(0x1a3)][_0x1033b9(0x124)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x10fee0>=this[_0x1033b9(0xd7)]){console[_0x1033b9(0x1cf)](_0x1033b9(0xf8)+_0x5e4bfa+_0x1033b9(0x133)+this[_0x1033b9(0xd7)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x1033b9(0xdc)](_0x5e4bfa);return;}await this[_0x1033b9(0x14a)](_0x5e4bfa),console['log'](_0x1033b9(0x17b)+_0x5e4bfa);}catch(_0x391cab){console[_0x1033b9(0xf4)](_0x1033b9(0xc7)+_0x5e4bfa+':',_0x391cab),this[_0x1033b9(0x1a7)](_0x5e4bfa,_0x37a8ca,_0x391cab,_0x1033b9(0x13d),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x46e00e[_0x1fb1dc(0x122)](_0x22c2b1),this['paymentTimers'][_0x1fb1dc(0x125)](_0x5e4bfa,{'timers':_0x46e00e,'paymentId':_0x5e4bfa,'gatewayPaymentId':_0x37a8ca,'createdAt':_0x9ad6ab}),console[_0x1fb1dc(0x1cf)](_0x1fb1dc(0xfc)+_0x1d3bdc[_0x1fb1dc(0xfb)]+_0x1fb1dc(0xe2)+_0x5e4bfa),console[_0x1fb1dc(0x1cf)]('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this['paymentTimers']['size']),this[_0x1fb1dc(0x109)](_0x5e4bfa,_0x37a8ca,'PENDING',_0x1fb1dc(0x1c6),_0x1fb1dc(0x13d),{'action':'schedule_created','scheduledChecks':_0x1d3bdc[_0x1fb1dc(0xfb)],'firstCheckIn':_0x1d3bdc[0x0][_0x1fb1dc(0x1cb)]/0x3e8,'totalTimers':this[_0x1fb1dc(0xca)][_0x1fb1dc(0x1c0)]});}[a42_0x3ace4(0xdc)](_0x4305a1){const _0xffbeef=a42_0x3ace4,_0x3549e2=this[_0xffbeef(0xca)][_0xffbeef(0x15a)](_0x4305a1);_0x3549e2?(console[_0xffbeef(0x1cf)](_0xffbeef(0xd6)+_0x3549e2[_0xffbeef(0x10b)]['length']+_0xffbeef(0x165)+_0x4305a1),_0x3549e2['timers'][_0xffbeef(0x156)]((_0x550e82,_0x499198)=>{const _0x2b98b3=_0xffbeef;_0x550e82&&(clearTimeout(_0x550e82),clearInterval(_0x550e82),console[_0x2b98b3(0x1cf)]('üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x499198+0x1)+_0x2b98b3(0x170)+_0x4305a1));}),this[_0xffbeef(0xca)]['delete'](_0x4305a1),console[_0xffbeef(0x1cf)](_0xffbeef(0x18d)+_0x4305a1+_0xffbeef(0x14d)+this[_0xffbeef(0xca)][_0xffbeef(0x1c0)])):console[_0xffbeef(0x1cf)](_0xffbeef(0x11a)+_0x4305a1+_0xffbeef(0x150));}async[a42_0x3ace4(0x14a)](_0x2f2526){const _0xdb3e9=a42_0x3ace4;console[_0xdb3e9(0x1cf)](_0xdb3e9(0xf3)+_0x2f2526);const _0x3458f9=await database_1[_0xdb3e9(0xd8)]['payment'][_0xdb3e9(0x12f)]({'where':{'id':_0x2f2526},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3458f9){console['log'](_0xdb3e9(0xf6)+_0x2f2526+'\x20not\x20found\x20in\x20database');return;}console['log']('üìä\x20[CHECK]\x20Payment\x20'+_0x2f2526+_0xdb3e9(0xdb)),console[_0xdb3e9(0x1cf)](_0xdb3e9(0xe8)+_0x3458f9['gateway']),console[_0xdb3e9(0x1cf)](_0xdb3e9(0x172)+_0x3458f9[_0xdb3e9(0x167)]),console['log'](_0xdb3e9(0x191)+_0x3458f9[_0xdb3e9(0x16f)]),console[_0xdb3e9(0x1cf)](_0xdb3e9(0x154)+_0x3458f9[_0xdb3e9(0x137)]+'\x20'+_0x3458f9[_0xdb3e9(0x1aa)]),console[_0xdb3e9(0x1cf)](_0xdb3e9(0x151)+_0x3458f9['shopId']);if(_0x3458f9[_0xdb3e9(0x19b)]!=='cointopay'&&_0x3458f9[_0xdb3e9(0x19b)]!==_0xdb3e9(0x193)){console[_0xdb3e9(0x1cf)](_0xdb3e9(0x105)+_0x2f2526+_0xdb3e9(0x10e)+_0x3458f9[_0xdb3e9(0x19b)]+')');return;}if(_0x3458f9[_0xdb3e9(0x167)]!=='PENDING'){console[_0xdb3e9(0x1cf)](_0xdb3e9(0x105)+_0x2f2526+_0xdb3e9(0x11d)+_0x3458f9['status']+',\x20stopping\x20individual\x20checks'),this[_0xdb3e9(0xdc)](_0x2f2526);return;}if(!_0x3458f9[_0xdb3e9(0x16f)]){console[_0xdb3e9(0x1cf)](_0xdb3e9(0x105)+_0x2f2526+_0xdb3e9(0x1c9));return;}console['log']('‚úÖ\x20[CHECK]\x20Payment\x20'+_0x2f2526+_0xdb3e9(0xeb)),await this['checkSinglePayment'](_0x3458f9);}[a42_0x3ace4(0x109)](_0x53e886,_0x3a4ae2,_0xe31641,_0x28d2d0,_0x2cf443,_0x3e0a8b){const _0x2a1899=a42_0x3ace4,_0x2b1154={'type':_0x2a1899(0x18a),'paymentId':_0x53e886,'gatewayPaymentId':_0x3a4ae2,'oldStatus':_0xe31641,'newStatus':_0x28d2d0,'source':_0x2cf443,'timestamp':new Date()[_0x2a1899(0x12c)](),'details':_0x3e0a8b||{}};loggerService_1['loggerService'][_0x2a1899(0x109)](_0x2b1154),console['log']('ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x53e886+'\x20('+_0x3a4ae2+')'),console[_0x2a1899(0x1cf)](_0x2a1899(0x101)+_0xe31641+_0x2a1899(0x131)+_0x28d2d0),console[_0x2a1899(0x1cf)]('\x20\x20\x20üìç\x20Source:\x20'+_0x2cf443),console[_0x2a1899(0x1cf)](_0x2a1899(0x110)+_0x2b1154[_0x2a1899(0x10f)]),_0x3e0a8b&&console[_0x2a1899(0x1cf)](_0x2a1899(0x12a),_0x3e0a8b);}['logCoinToPayError'](_0x321086,_0x29b067,_0x5f1731,_0x1f8ea6,_0x4797b7){const _0x3e4a58=a42_0x3ace4,_0x19d255={'type':_0x3e4a58(0xf2),'paymentId':_0x321086,'gatewayPaymentId':_0x29b067,'error':_0x5f1731 instanceof Error?{'message':_0x5f1731['message'],'stack':_0x5f1731['stack']}:_0x5f1731,'source':_0x1f8ea6,'timestamp':new Date()[_0x3e4a58(0x12c)](),'context':_0x4797b7||{}};loggerService_1[_0x3e4a58(0x182)][_0x3e4a58(0x1a7)](_0x19d255),console[_0x3e4a58(0xf4)](_0x3e4a58(0xef)+_0x321086+'\x20('+_0x29b067+')'),console[_0x3e4a58(0xf4)](_0x3e4a58(0xdf)+(_0x5f1731 instanceof Error?_0x5f1731[_0x3e4a58(0xe7)]:_0x5f1731)),console['error'](_0x3e4a58(0x1bc)+_0x1f8ea6),console[_0x3e4a58(0xf4)](_0x3e4a58(0x110)+_0x19d255['timestamp']),_0x4797b7&&console['error'](_0x3e4a58(0x146),_0x4797b7);}[a42_0x3ace4(0x17f)](){const _0x2526d6=a42_0x3ace4;console[_0x2526d6(0x1cf)](_0x2526d6(0x108)),this[_0x2526d6(0xd4)]()[_0x2526d6(0xfd)](_0x1c21a5=>{const _0x281968=_0x2526d6;console[_0x281968(0xf4)](_0x281968(0x17d),_0x1c21a5);}),this['globalCheckInterval']=setInterval(async()=>{const _0x55a3fc=_0x2526d6;try{console[_0x55a3fc(0x1cf)]('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x55a3fc(0xd4)](),console[_0x55a3fc(0x1cf)](_0x55a3fc(0xd9));}catch(_0x4ce71c){console[_0x55a3fc(0xf4)]('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x4ce71c);}},this[_0x2526d6(0x184)]),console[_0x2526d6(0x1cf)](_0x2526d6(0x1a2));}[a42_0x3ace4(0x15b)](){const _0x3095a3=a42_0x3ace4;console[_0x3095a3(0x1cf)]('üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x3095a3(0x1ba)]&&(clearInterval(this[_0x3095a3(0x1ba)]),this[_0x3095a3(0x1ba)]=null,console['log'](_0x3095a3(0xf9)));const _0x8b1108=this[_0x3095a3(0xca)][_0x3095a3(0x1c0)];for(const [_0x27a962]of this['paymentTimers']){this[_0x3095a3(0xdc)](_0x27a962);}console[_0x3095a3(0x1cf)](_0x3095a3(0x158)+_0x8b1108+_0x3095a3(0xd2));}async[a42_0x3ace4(0xd4)](){const _0x474fcd=a42_0x3ace4;try{console[_0x474fcd(0x1cf)](_0x474fcd(0x1b1));const _0x17caf7=await database_1[_0x474fcd(0xd8)][_0x474fcd(0x1c1)][_0x474fcd(0x149)]({'where':{'gateway':{'in':[_0x474fcd(0xd1),'cointopay2']},'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x474fcd(0x1cf)](_0x474fcd(0x1a6)+_0x17caf7[_0x474fcd(0xfb)]+_0x474fcd(0x13c));if(_0x17caf7[_0x474fcd(0xfb)]===0x0){console[_0x474fcd(0x1cf)]('ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x5e0871=await this[_0x474fcd(0xcd)](_0x17caf7);console[_0x474fcd(0x1cf)](_0x474fcd(0x162)+_0x5e0871[_0x474fcd(0xfb)]+_0x474fcd(0x1b3));let _0x35c95d=0x0,_0x33f5a1=0x0;for(const _0x343bfa of _0x17caf7){try{if(_0x5e0871[_0x474fcd(0x118)](_0x343bfa['id'])){console[_0x474fcd(0x1cf)](_0x474fcd(0x189)+_0x343bfa['id']+_0x474fcd(0x1ab)),_0x33f5a1++;continue;}if(this['paymentTimers'][_0x474fcd(0x12e)](_0x343bfa['id'])){console[_0x474fcd(0x1cf)](_0x474fcd(0x189)+_0x343bfa['id']+_0x474fcd(0x143)),_0x33f5a1++;continue;}const _0x2c3a34=(Date['now']()-_0x343bfa['createdAt'][_0x474fcd(0x124)]())/(0x3e8*0x3c*0x3c);if(_0x2c3a34<0x1){console[_0x474fcd(0x1cf)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x343bfa['id']+_0x474fcd(0x1a1)+_0x2c3a34['toFixed'](0x1)+_0x474fcd(0x13a)),_0x33f5a1++;continue;}console['log']('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x343bfa['id']+'\x20(age:\x20'+_0x2c3a34['toFixed'](0x1)+'h)'),await this[_0x474fcd(0x199)](_0x343bfa),_0x35c95d++,await new Promise(_0x33bd20=>setTimeout(_0x33bd20,0x7d0));}catch(_0x36aee4){console[_0x474fcd(0xf4)](_0x474fcd(0xc8)+_0x343bfa['id']+':',_0x36aee4),this[_0x474fcd(0x1a7)](_0x343bfa['id'],_0x343bfa[_0x474fcd(0x16f)]||_0x474fcd(0x100),_0x36aee4,_0x474fcd(0x13d),{'isGlobalCheck':!![],'paymentAmount':_0x343bfa[_0x474fcd(0x137)],'paymentCurrency':_0x343bfa[_0x474fcd(0x1aa)],'shopId':_0x343bfa[_0x474fcd(0x1cc)],'createdAt':_0x343bfa[_0x474fcd(0x1a3)]}),loggerService_1[_0x474fcd(0x182)]['logWhiteDomainError']('cointopay',_0x474fcd(0x127)+_0x343bfa[_0x474fcd(0x16f)],_0x36aee4);}}console[_0x474fcd(0x1cf)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x35c95d+_0x474fcd(0xc9)+_0x33f5a1+_0x474fcd(0x113)+_0x5e0871['length']+'\x20expired');}catch(_0x25cc89){console[_0x474fcd(0xf4)](_0x474fcd(0x14b),_0x25cc89);}}async[a42_0x3ace4(0xcd)](_0x3696e5){const _0x386c49=a42_0x3ace4,_0x528280=[],_0x2e76a3=new Date();_0x2e76a3[_0x386c49(0x11b)](_0x2e76a3[_0x386c49(0x196)]()-this[_0x386c49(0xd7)]),console[_0x386c49(0x1cf)](_0x386c49(0x153)+this[_0x386c49(0xd7)]+_0x386c49(0x1a0)+_0x2e76a3[_0x386c49(0x12c)]()+')');for(const _0xd48139 of _0x3696e5){if(_0xd48139[_0x386c49(0x1a3)]<_0x2e76a3){console[_0x386c49(0x1cf)](_0x386c49(0x179)+_0xd48139['id']+_0x386c49(0x133)+this[_0x386c49(0xd7)]+_0x386c49(0xf5));try{this[_0x386c49(0x109)](_0xd48139['id'],_0xd48139['gatewayPaymentId']||_0x386c49(0x100),_0x386c49(0x1c6),_0x386c49(0x121),_0x386c49(0x1b9),{'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x386c49(0x1ae),'createdAt':_0xd48139[_0x386c49(0x1a3)],'daysSinceCreation':Math[_0x386c49(0x103)]((Date[_0x386c49(0x134)]()-_0xd48139['createdAt'][_0x386c49(0x124)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0xd48139[_0x386c49(0x137)],'paymentCurrency':_0xd48139['currency'],'shopId':_0xd48139['shopId']}),await database_1['default'][_0x386c49(0x1c1)][_0x386c49(0xed)]({'where':{'id':_0xd48139['id']},'data':{'status':'EXPIRED','updatedAt':new Date()}}),await database_1[_0x386c49(0xd8)]['webhookLog'][_0x386c49(0x117)]({'data':{'paymentId':_0xd48139['id'],'shopId':_0xd48139['shopId'],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x386c49(0x1cd)]({'reason':'Payment\x20older\x20than\x20'+this[_0x386c49(0xd7)]+_0x386c49(0x1ae),'createdAt':_0xd48139[_0x386c49(0x1a3)],'expiredAt':new Date()[_0x386c49(0x12c)](),'daysSinceCreation':Math[_0x386c49(0x103)]((Date[_0x386c49(0x134)]()-_0xd48139[_0x386c49(0x1a3)][_0x386c49(0x124)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x386c49(0x144)](_0xd48139,_0x386c49(0x121)),await this[_0x386c49(0x178)](_0xd48139,_0x386c49(0x121)),this[_0x386c49(0xdc)](_0xd48139['id']),_0x528280[_0x386c49(0x122)](_0xd48139['id']),console[_0x386c49(0x1cf)]('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0xd48139['id']+_0x386c49(0x176)+this[_0x386c49(0xd7)]+_0x386c49(0x15c));}catch(_0x5c5cd3){console[_0x386c49(0xf4)](_0x386c49(0x102)+_0xd48139['id']+':',_0x5c5cd3),this[_0x386c49(0x1a7)](_0xd48139['id'],_0xd48139[_0x386c49(0x16f)]||_0x386c49(0x100),_0x5c5cd3,_0x386c49(0x1b9),{'reason':_0x386c49(0x1ac),'createdAt':_0xd48139['createdAt'],'daysSinceCreation':Math[_0x386c49(0x103)]((Date[_0x386c49(0x134)]()-_0xd48139['createdAt'][_0x386c49(0x124)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x528280;}async['checkSinglePayment'](_0x3cadd){const _0x3e9803=a42_0x3ace4;if(!_0x3cadd[_0x3e9803(0x16f)]){console[_0x3e9803(0x1cf)](_0x3e9803(0x105)+_0x3cadd['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x3e9803(0x1cf)](_0x3e9803(0x18f)+_0x3cadd[_0x3e9803(0x19b)]+_0x3e9803(0x1ce)+_0x3cadd['id']+'\x20('+_0x3cadd[_0x3e9803(0x16f)]+')');try{let _0x470d9c;_0x3cadd[_0x3e9803(0x19b)]==='cointopay2'?(_0x470d9c=await this[_0x3e9803(0x145)][_0x3e9803(0x1ca)](_0x3cadd[_0x3e9803(0x16f)]),console[_0x3e9803(0x1cf)]('üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x3cadd['id']+'\x20status:\x20'+_0x470d9c[_0x3e9803(0x167)])):(_0x470d9c=await this[_0x3e9803(0x1c8)]['checkPaymentStatus'](_0x3cadd[_0x3e9803(0x16f)]),console[_0x3e9803(0x1cf)](_0x3e9803(0x159)+_0x3cadd['id']+_0x3e9803(0xce)+_0x470d9c[_0x3e9803(0x167)]));_0x470d9c[_0x3e9803(0x16e)]&&console['log'](_0x3e9803(0x1c2)+_0x3cadd['id']+_0x3e9803(0x160),{'iban':_0x470d9c['paymentDetails'][_0x3e9803(0x181)]||_0x3e9803(0x19c),'transactionId':_0x470d9c['paymentDetails'][_0x3e9803(0x19a)],'createdOn':_0x470d9c[_0x3e9803(0x16e)]['createdOn'],'confirmedOn':_0x470d9c[_0x3e9803(0x16e)][_0x3e9803(0xfa)]||_0x3e9803(0x186)});if(_0x470d9c[_0x3e9803(0x167)]!==_0x3cadd['status']){console[_0x3e9803(0x1cf)](_0x3e9803(0x120)+_0x3cadd['id']+_0x3e9803(0x190)+_0x3cadd[_0x3e9803(0x167)]+_0x3e9803(0xd5)+_0x470d9c['status']),this[_0x3e9803(0x109)](_0x3cadd['id'],_0x3cadd[_0x3e9803(0x16f)],_0x3cadd[_0x3e9803(0x167)],_0x470d9c['status'],_0x3e9803(0x13d),{'paymentDetails':_0x470d9c[_0x3e9803(0x16e)],'amount':_0x470d9c[_0x3e9803(0x137)],'currency':_0x470d9c[_0x3e9803(0x1aa)],'shopId':_0x3cadd['shopId'],'checkTimestamp':new Date()[_0x3e9803(0x12c)]()});const _0x3996c2={'status':_0x470d9c['status'],'updatedAt':new Date()};if(_0x470d9c['status']===_0x3e9803(0x16c)&&_0x3cadd[_0x3e9803(0x167)]!=='PAID'){_0x3996c2[_0x3e9803(0x18e)]=new Date();if(!_0x3cadd[_0x3e9803(0xe4)]){const _0x19f453=await currencyService_1['currencyService'][_0x3e9803(0xe0)](_0x3cadd[_0x3e9803(0x137)],_0x3cadd[_0x3e9803(0x1aa)]);_0x3996c2['amountUSDT']=_0x19f453;const _0x93bbec=await this[_0x3e9803(0xee)](_0x3cadd[_0x3e9803(0x1cc)],_0x3cadd[_0x3e9803(0x19b)]),_0x10407e=_0x19f453*(0x1-_0x93bbec/0x64);_0x3996c2[_0x3e9803(0x180)]=_0x10407e,_0x3996c2['gatewayCommissionRate']=_0x93bbec,console[_0x3e9803(0x1cf)](_0x3e9803(0x198)+_0x3cadd['id']+_0x3e9803(0x187)),console['log']('\x20\x20\x20Amount:\x20'+_0x3cadd[_0x3e9803(0x137)]+'\x20'+_0x3cadd[_0x3e9803(0x1aa)]+'\x20->\x20'+_0x19f453[_0x3e9803(0x114)](0x6)+_0x3e9803(0x163)),console['log']('\x20\x20\x20Gateway\x20'+_0x3cadd[_0x3e9803(0x19b)]+_0x3e9803(0x174)+_0x93bbec+'%'),console[_0x3e9803(0x1cf)]('\x20\x20\x20Amount\x20after\x20commission:\x20'+_0x10407e[_0x3e9803(0x114)](0x6)+'\x20USDT');}console[_0x3e9803(0x1cf)](_0x3e9803(0x198)+_0x3cadd['id']+_0x3e9803(0x106)+_0x3996c2['paidAt'][_0x3e9803(0x12c)]());}if(_0x470d9c[_0x3e9803(0x16e)]){const _0x24c5a7=_0x470d9c[_0x3e9803(0x16e)];_0x24c5a7[_0x3e9803(0x181)]&&(_0x3996c2[_0x3e9803(0x188)]=_0x24c5a7[_0x3e9803(0x181)],console[_0x3e9803(0x1cf)]('üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x24c5a7[_0x3e9803(0x181)])),_0x24c5a7[_0x3e9803(0x161)]&&console[_0x3e9803(0x1cf)](_0x3e9803(0xd3)+_0x24c5a7['bankDetails']),_0x24c5a7['transactionId']&&console[_0x3e9803(0x1cf)](_0x3e9803(0x19e)+_0x24c5a7[_0x3e9803(0x19a)]),_0x24c5a7['confirmedOn']&&console['log']('‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x24c5a7[_0x3e9803(0xfa)]);}await database_1[_0x3e9803(0xd8)][_0x3e9803(0x1c1)][_0x3e9803(0xed)]({'where':{'id':_0x3cadd['id']},'data':_0x3996c2});if(_0x470d9c[_0x3e9803(0x167)]==='PAID'&&_0x3cadd[_0x3e9803(0x167)]!==_0x3e9803(0x16c)){console[_0x3e9803(0x1cf)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x3cadd['id']+_0x3e9803(0x19f));const _0x57aceb=await database_1[_0x3e9803(0xd8)][_0x3e9803(0x1c1)][_0x3e9803(0x12f)]({'where':{'id':_0x3cadd['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x57aceb?.[_0x3e9803(0x1b8)]&&_0x57aceb[_0x3e9803(0x18c)])try{const _0xeffa72=_0x57aceb[_0x3e9803(0x18c)];console[_0x3e9803(0x1cf)](_0x3e9803(0x12d)+_0xeffa72['id']+_0x3e9803(0x11e)+_0xeffa72[_0x3e9803(0x19d)]+_0x3e9803(0x168)+_0xeffa72[_0x3e9803(0xec)]+_0x3e9803(0x1be)+_0xeffa72[_0x3e9803(0x167)]);const _0x591261=_0xeffa72[_0x3e9803(0xec)]+0x1,_0x1e985d=_0xeffa72[_0x3e9803(0x19d)]==='SINGLE'?_0x3e9803(0x169):_0xeffa72[_0x3e9803(0x167)];await database_1[_0x3e9803(0xd8)][_0x3e9803(0x18c)]['update']({'where':{'id':_0xeffa72['id']},'data':{'currentPayments':_0x591261,'status':_0x1e985d,'updatedAt':new Date()}}),console[_0x3e9803(0x1cf)](_0x3e9803(0x104)+_0xeffa72['id']+_0x3e9803(0xc6)+_0xeffa72[_0x3e9803(0xec)]+_0x3e9803(0x131)+_0x591261+_0x3e9803(0x1be)+_0xeffa72[_0x3e9803(0x167)]+_0x3e9803(0x131)+_0x1e985d);}catch(_0x2d3244){console['error']('‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:',_0x2d3244);}else console[_0x3e9803(0x1cf)](_0x3e9803(0x136)+_0x3cadd['id']+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}await database_1[_0x3e9803(0xd8)][_0x3e9803(0x15e)][_0x3e9803(0x117)]({'data':{'paymentId':_0x3cadd['id'],'shopId':_0x3cadd['shopId'],'event':_0x3e9803(0x17e)+_0x470d9c[_0x3e9803(0x167)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x3e9803(0x1cd)]({'oldStatus':_0x3cadd[_0x3e9803(0x167)],'newStatus':_0x470d9c['status'],'paymentDetails':_0x470d9c[_0x3e9803(0x16e)],'checkedAt':new Date()[_0x3e9803(0x12c)]()})}}),await this['sendShopWebhook'](_0x3cadd,_0x470d9c[_0x3e9803(0x167)]),await this[_0x3e9803(0x178)](_0x3cadd,_0x470d9c['status']),_0x470d9c[_0x3e9803(0x167)]!==_0x3e9803(0x1c6)&&(console[_0x3e9803(0x1cf)](_0x3e9803(0x18b)+_0x3cadd['id']+_0x3e9803(0xe6)+_0x470d9c[_0x3e9803(0x167)]+_0x3e9803(0x1b6)),this[_0x3e9803(0xdc)](_0x3cadd['id'])),console[_0x3e9803(0x1cf)](_0x3e9803(0x1bb)+_0x3cadd['id']+_0x3e9803(0x1a5));}else console[_0x3e9803(0x1cf)](_0x3e9803(0x1c2)+_0x3cadd['id']+_0x3e9803(0x1d1)+_0x470d9c[_0x3e9803(0x167)]+')'),this[_0x3e9803(0x109)](_0x3cadd['id'],_0x3cadd['gatewayPaymentId'],_0x3cadd['status'],_0x470d9c[_0x3e9803(0x167)],_0x3e9803(0x13d),{'statusUnchanged':!![],'paymentDetails':_0x470d9c['paymentDetails'],'amount':_0x470d9c['amount'],'currency':_0x470d9c['currency'],'shopId':_0x3cadd[_0x3e9803(0x1cc)],'checkTimestamp':new Date()[_0x3e9803(0x12c)]()});}catch(_0x5a2c64){console[_0x3e9803(0xf4)](_0x3e9803(0x141)+_0x3cadd['id']+':',_0x5a2c64),this[_0x3e9803(0x1a7)](_0x3cadd['id'],_0x3cadd[_0x3e9803(0x16f)],_0x5a2c64,_0x3e9803(0x13d),{'paymentAmount':_0x3cadd['amount'],'paymentCurrency':_0x3cadd[_0x3e9803(0x1aa)],'shopId':_0x3cadd[_0x3e9803(0x1cc)],'createdAt':_0x3cadd[_0x3e9803(0x1a3)]}),await database_1['default']['webhookLog'][_0x3e9803(0x117)]({'data':{'paymentId':_0x3cadd['id'],'shopId':_0x3cadd[_0x3e9803(0x1cc)],'event':_0x3e9803(0x152),'statusCode':0x1f4,'responseBody':JSON[_0x3e9803(0x1cd)]({'error':_0x5a2c64 instanceof Error?_0x5a2c64[_0x3e9803(0xe7)]:_0x3e9803(0xf0),'gatewayPaymentId':_0x3cadd[_0x3e9803(0x16f)],'checkedAt':new Date()[_0x3e9803(0x12c)]()})}});}}async['sendShopWebhook'](_0x11e847,_0x3d12f8){const _0x36006f=a42_0x3ace4,_0x373e89=Date[_0x36006f(0x134)]();try{const _0x5131fa=_0x11e847[_0x36006f(0x177)],_0x1b9ac6=_0x5131fa[_0x36006f(0x135)];if(!_0x1b9ac6?.[_0x36006f(0xea)]){console[_0x36006f(0x1cf)](_0x36006f(0x194)+_0x5131fa['id']);return;}const _0x43a317=_0x3d12f8===_0x36006f(0x16c)?_0x36006f(0x107):_0x3d12f8===_0x36006f(0x195)?'payment.failed':_0x3d12f8===_0x36006f(0x121)?_0x36006f(0x1bd):'payment.pending';if(!_0x1b9ac6[_0x36006f(0x1c7)]?.[_0x36006f(0x118)](_0x43a317)){console[_0x36006f(0x1cf)]('Webhook\x20event\x20'+_0x43a317+_0x36006f(0x15d)+_0x5131fa['id']);return;}const _0x51a2aa=(0x0,gateway_1[_0x36006f(0x1ad)])(_0x11e847[_0x36006f(0x19b)])||_0x11e847['gateway'],_0x5989bd={'event':_0x43a317,'payment':{'id':_0x11e847['id'],'order_id':_0x11e847[_0x36006f(0x1b2)],'gateway_order_id':_0x11e847[_0x36006f(0x14f)],'gateway':_0x51a2aa,'amount':_0x11e847[_0x36006f(0x137)],'currency':_0x11e847[_0x36006f(0x1aa)],'status':_0x3d12f8[_0x36006f(0x13e)](),'customer_email':_0x11e847[_0x36006f(0x155)],'customer_name':_0x11e847['customerName'],'created_at':_0x11e847[_0x36006f(0x1a3)],'updated_at':new Date()}},_0x1eb64b=await fetch(_0x1b9ac6[_0x36006f(0xea)],{'method':_0x36006f(0x173),'headers':{'Content-Type':_0x36006f(0x138),'User-Agent':'Payment\x20System/1.0'},'body':JSON[_0x36006f(0x1cd)](_0x5989bd)}),_0x459e67=Date[_0x36006f(0x134)]()-_0x373e89,_0x1a7623=_0x1eb64b['ok']?_0x36006f(0x148):await _0x1eb64b[_0x36006f(0x175)]();loggerService_1[_0x36006f(0x182)][_0x36006f(0x1a4)](_0x11e847[_0x36006f(0x1cc)],_0x1b9ac6[_0x36006f(0xea)],_0x43a317,_0x1eb64b[_0x36006f(0x167)],_0x459e67,_0x5989bd),console[_0x36006f(0x1cf)]('Shop\x20webhook\x20sent\x20to\x20'+_0x1b9ac6['webhookUrl']+_0x36006f(0x139)+_0x1eb64b['status']+'\x20('+_0x459e67+'ms)');}catch(_0xc897b){console[_0x36006f(0xf4)](_0x36006f(0xe3),_0xc897b),loggerService_1[_0x36006f(0x182)]['logShopWebhookError'](_0x11e847[_0x36006f(0x1cc)],_0x11e847['shop']?.[_0x36006f(0x135)]?.[_0x36006f(0xea)]||'unknown',_0x36006f(0x147),_0xc897b,{});}}async[a42_0x3ace4(0x178)](_0x7fce97,_0x5c882d){const _0x32b70d=a42_0x3ace4;try{const _0xf2302f={'PENDING':_0x32b70d(0x129),'PAID':_0x32b70d(0x1b5),'FAILED':_0x32b70d(0xff),'EXPIRED':_0x32b70d(0x1d0)},_0x54a61d=_0xf2302f[_0x5c882d];if(!_0x54a61d||_0x54a61d===_0x32b70d(0x129))return;await telegramBotService_1[_0x32b70d(0x10d)]['sendPaymentNotification'](_0x7fce97[_0x32b70d(0x1cc)],_0x7fce97,_0x54a61d);}catch(_0x179c9c){console[_0x32b70d(0xf4)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x179c9c);}}async[a42_0x3ace4(0x123)](_0x2d91cb){const _0x5ed358=a42_0x3ace4;console[_0x5ed358(0x1cf)](_0x5ed358(0x1c5)+_0x2d91cb);const _0x9496af=await database_1[_0x5ed358(0xd8)][_0x5ed358(0x1c1)]['findUnique']({'where':{'id':_0x2d91cb},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x9496af)throw new Error(_0x5ed358(0xcb));if(_0x9496af[_0x5ed358(0x19b)]!=='cointopay'&&_0x9496af[_0x5ed358(0x19b)]!==_0x5ed358(0x193))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x5ed358(0x1cf)](_0x5ed358(0x12b)+_0x9496af[_0x5ed358(0x19b)]+_0x5ed358(0x1ce)+_0x2d91cb),await this['checkSinglePayment'](_0x9496af),console[_0x5ed358(0x1cf)]('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x2d91cb);}[a42_0x3ace4(0x13b)](){const _0x5e81da=a42_0x3ace4,_0x30786e=this[_0x5e81da(0x1ba)]?this[_0x5e81da(0x184)]:undefined,_0x2c9236=Array[_0x5e81da(0x1b0)](this[_0x5e81da(0xca)][_0x5e81da(0x14e)]())[_0x5e81da(0x128)](_0x256bd9=>({'paymentId':_0x256bd9['paymentId'],'gatewayPaymentId':_0x256bd9[_0x5e81da(0x16f)],'createdAt':_0x256bd9[_0x5e81da(0x1a3)],'timersCount':_0x256bd9[_0x5e81da(0x10b)][_0x5e81da(0xfb)]}));return{'isActive':!!this[_0x5e81da(0x1ba)],'globalCheckIntervalMinutes':this[_0x5e81da(0x184)]/(0x3e8*0x3c),'expiryDays':this[_0x5e81da(0xd7)],'activeIndividualTimers':this[_0x5e81da(0xca)][_0x5e81da(0x1c0)],'nextGlobalCheckIn':_0x30786e,'paymentTimersDetails':_0x2c9236};}[a42_0x3ace4(0x16a)](_0x35a7b0){const _0x430597=a42_0x3ace4,_0xd6a28b=this[_0x430597(0xca)][_0x430597(0x15a)](_0x35a7b0);if(_0xd6a28b)return{'hasTimers':!![],'timersCount':_0xd6a28b[_0x430597(0x10b)][_0x430597(0xfb)],'createdAt':_0xd6a28b[_0x430597(0x1a3)],'gatewayPaymentId':_0xd6a28b[_0x430597(0x16f)]};return{'hasTimers':![]};}async['getGatewayCommission'](_0x531c39,_0x22878f){const _0x134a2d=a42_0x3ace4;try{const _0xf85b31=await database_1['default'][_0x134a2d(0x177)][_0x134a2d(0x12f)]({'where':{'id':_0x531c39},'select':{'gatewaySettings':!![]}});if(!_0xf85b31?.[_0x134a2d(0x132)])return console[_0x134a2d(0x1cf)]('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x531c39+_0x134a2d(0xe5)),0xa;const _0x285e66=JSON[_0x134a2d(0x13f)](_0xf85b31[_0x134a2d(0x132)]);for(const [_0x4736bf,_0x31afc0]of Object[_0x134a2d(0x142)](_0x285e66)){if(_0x4736bf['toLowerCase']()===_0x22878f['toLowerCase']()){const _0x3d71d5=_0x31afc0[_0x134a2d(0xe9)]||0xa;return console['log'](_0x134a2d(0x17a)+_0x22878f+_0x134a2d(0xfe)+_0x531c39+':\x20'+_0x3d71d5+'%'),_0x3d71d5;}}return console[_0x134a2d(0x1cf)](_0x134a2d(0xdd)+_0x22878f+'\x20in\x20shop\x20'+_0x531c39+_0x134a2d(0xc5)),0xa;}catch(_0x563e6c){return console[_0x134a2d(0xf4)](_0x134a2d(0x166)+_0x531c39+',\x20gateway\x20'+_0x22878f+':',_0x563e6c),0xa;}}}exports[a42_0x3ace4(0x185)]=CoinToPayStatusService,exports[a42_0x3ace4(0xf1)]=new CoinToPayStatusService();