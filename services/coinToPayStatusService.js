'use strict';const a38_0x549daf=a38_0x52ac;function a38_0xe9f5(){const _0x3f2487=['cointopay_status_check_error','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','create','\x20days\x20(created\x20before\x20','checkPaymentStatus','createdOn','\x20\x20\x20üìù\x20Context:','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','update','1105662bpwoqv','coinToPayService','üõë\x20[SHUTDOWN]\x20Cleared\x20',':\x20type=','amountUSDT','590CaafYN','‚è∞\x20[HOURLY]\x20Payment\x20','checkExpiredPayments','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20for\x20payment\x20','\x20\x20\x20üìä\x20Status:\x20','‚ùå\x20[CHECK]\x20Payment\x20','\x20expired\x20CoinToPay\x20payments','payment','clearPaymentTimers','currentPayments','üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','__esModule','478323TtsgAB','4758824BVReAI','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','sendShopWebhook','PENDING','gatewaySettings','\x20is\x20older\x20than\x20','\x20USDT','\x20(after\x20','description','commission','.\x20Remaining\x20active\x20timers:\x20','Automatically\x20expired\x20after\x20','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20->\x20','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','sendPaymentStatusNotification','\x20initial\x20timers\x20for\x20payment\x20','remitterIban','log','timestamp','2\x20minutes','adminNotes','logShopWebhookError','\x20\x20\x20Amount\x20after\x20commission:\x20','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','1\x20minute','values','schedule_created','bankDetails','transactionId',',\x20currentPayments=','ü™ô\x20[DEBUG]\x20Creating\x20','-day\x20timeout','\x20timers\x20for\x20payment\x20','‚è∞\x20[GLOBAL]\x20Found\x20','PAID','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','‚è∞\x20[EXPIRY]\x20Payment\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','109848MHKsQN','‚úÖ\x20[HOURLY]\x20Payment\x20',',\x20stopping\x20individual\x20checks','checkPaymentById','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','\x20days','entries','‚úÖ\x20[CHECK]\x20Payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','324388MRExLU','\x20\x20\x20üìù\x20Details:','webhookEvents','findUnique','./gateways/coinToPayService','\x20expired','globalCheckInterval','map','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...',',\x20clearing\x20individual\x20timers','unknown','\x20has\x20no\x20gatewayPaymentId,\x20skipping','length','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','webhookLog','setDate','currency','‚è∞\x20[GLOBAL]\x20Payment\x20','\x20\x20\x20üìÖ\x20Time:\x20','Shop\x20webhook\x20sent\x20to\x20','payment.pending',',\x20using\x20default\x2010%','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20has\x20no\x20gatewayPaymentId','Webhook\x20event\x20','\x20updated\x20successfully','paymentTimers','checkAllPendingPayments','FAILED','Failed\x20to\x20mark\x20payment\x20as\x20expired','settings','./telegramBotService','\x20\x20\x20-\x20Status:\x20','\x20individual\x20payment\x20timers','CoinToPayStatusService','\x20\x20\x20-\x20Gateway:\x20','\x20commission\x20for\x20shop\x20',',\x20using\x20default\x20commission\x2010%','logWhiteDomainError','Payment\x20older\x20than\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','../types/gateway','currencyService','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','convertToUSDT','COINTOPAY_ERROR','EXPIRED','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','getGatewayCommission','getPaymentTimerInfo','\x20with\x20status\x20','Payment\x20not\x20found','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20\x20\x20üìç\x20Source:\x20','webhookUrl','\x20not\x20found,\x20clearing\x20timers','\x20\x20\x20Amount:\x20','status','984330cQflVC','getServiceStats','5\x20minutes',',\x20gateway\x20','GLOBAL_CHECK_INTERVAL_MS','/status/','paymentLinkId','üìä\x20[HOURLY]\x20Payment\x20','paymentDetails','not\x20confirmed','\x20\x20\x20-\x20paymentId:\x20','\x20checked,\x20','\x20details:','7uBwaTT','h),\x20skipping\x20global\x20check','text','stringify','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','paymentLink','checkSinglePayment','stopPeriodicStatusCheck','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','Failed\x20to\x20send\x20shop\x20webhook:','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','confirmedOn','TesSoft\x20Payment\x20System/1.0','getTime','customerName','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','shopId','./currencyService','error','message','get','cointopay','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20pending\x20CoinToPay\x20payments','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','now','\x20found:','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20in\x20shop\x20','findMany','delay','logCoinToPayError','__importDefault','\x20\x20\x20‚ùå\x20Error:\x20','\x20status\x20changed\x20to\x20','toLowerCase','schedulePaymentChecks','push','\x20amounts\x20calculated:','iban','status_check','‚úÖ\x20[EXPIRY]\x20Payment\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20status\x20unchanged\x20(','gateway','logCoinToPayStatus','toFixed','COMPLETED','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','size','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','Success','logShopWebhookSent','failed','forEach','üìà\x20[COINTOPAY]\x20Payment\x20','payment.failed','default','\x20payment\x20',',\x20status=','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','floor','auto_expire','shop','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','includes','toISOString','\x20to\x20clear','330884NKPhiV','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20marked\x20as\x20paid\x20at:\x20','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','createdAt','loggerService','\x20status\x20is\x20','üßπ\x20[CHECK]\x20Payment\x20','\x20status\x20from\x20','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','\x20seconds\x20(','coinToPay2Service','gatewayPaymentId','paid','\x20skipped,\x20','\x20updated:\x20currentPayments=','expired','EXPIRY_DAYS','\x20status:\x20','üîç\x20[CHECK]\x20Checking\x20','catch','\x20(age:\x20','\x20in\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','paidAt','cointopay_status_check_','Unknown\x20error','üìä\x20[CHECK]\x20Payment\x20','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','amount','90ukzruB','checkSinglePaymentById','from','has','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','delete','./loggerService','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','\x20to\x20','set','sendPaymentNotification','cointopay2','\x20triggered\x20for\x20payment\x20','timers','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','coinToPayStatusService','\x20\x20\x20-\x20ShopId:\x20','\x20not\x20enabled\x20for\x20shop\x20','\x20days\x20without\x20payment\x20confirmation','\x20is\x20too\x20new\x20(','type'];a38_0xe9f5=function(){return _0x3f2487;};return a38_0xe9f5();}(function(_0x4e6ae5,_0x497884){const _0x36b50f=a38_0x52ac,_0x350557=_0x4e6ae5();while(!![]){try{const _0x2cb9cf=parseInt(_0x36b50f(0x1cd))/0x1+-parseInt(_0x36b50f(0x1c4))/0x2+-parseInt(_0x36b50f(0x186))/0x3+-parseInt(_0x36b50f(0x148))/0x4*(parseInt(_0x36b50f(0x167))/0x5)+-parseInt(_0x36b50f(0x209))/0x6+parseInt(_0x36b50f(0x216))/0x7*(-parseInt(_0x36b50f(0x199))/0x8)+parseInt(_0x36b50f(0x198))/0x9*(parseInt(_0x36b50f(0x18b))/0xa);if(_0x2cb9cf===_0x497884)break;else _0x350557['push'](_0x350557['shift']());}catch(_0x1b1aa5){_0x350557['push'](_0x350557['shift']());}}}(a38_0xe9f5,0xc08d9));var __importDefault=this&&this[a38_0x549daf(0x238)]||function(_0x6fb698){const _0xd45913=a38_0x549daf;return _0x6fb698&&_0x6fb698[_0xd45913(0x197)]?_0x6fb698:{'default':_0x6fb698};};function a38_0x52ac(_0x402559,_0x50f38e){const _0xe9f527=a38_0xe9f5();return a38_0x52ac=function(_0x52ace9,_0x29031a){_0x52ace9=_0x52ace9-0x147;let _0x29e78d=_0xe9f527[_0x52ace9];return _0x29e78d;},a38_0x52ac(_0x402559,_0x50f38e);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a38_0x549daf(0x176)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a38_0x549daf(0x1d1)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require(a38_0x549daf(0x1f6)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a38_0x549daf(0x1ec)),loggerService_1=require(a38_0x549daf(0x16d)),currencyService_1=require(a38_0x549daf(0x229));class CoinToPayStatusService{constructor(){const _0x5168f7=a38_0x549daf;this['globalCheckInterval']=null,this[_0x5168f7(0x20d)]=0x3c*0x3c*0x3e8,this[_0x5168f7(0x15a)]=0x5,this[_0x5168f7(0x1e7)]=new Map(),this[_0x5168f7(0x187)]=new coinToPayService_1['CoinToPayService'](),this[_0x5168f7(0x154)]=new coinToPay2Service_1['CoinToPay2Service'](),console[_0x5168f7(0x1ae)](_0x5168f7(0x17d));}[a38_0x549daf(0x23c)](_0x14b6ef,_0x1f6f98){const _0x32891a=a38_0x549daf;console['log'](_0x32891a(0x1e3)),console[_0x32891a(0x1ae)](_0x32891a(0x213)+_0x14b6ef),console[_0x32891a(0x1ae)](_0x32891a(0x160)+_0x1f6f98),this[_0x32891a(0x194)](_0x14b6ef);const _0x29c50d=[],_0x27db88=new Date(),_0x87eba5=[{'delay':0x1*0x3c*0x3e8,'description':_0x32891a(0x1b5)},{'delay':0x2*0x3c*0x3e8,'description':_0x32891a(0x1b0)},{'delay':0x5*0x3c*0x3e8,'description':_0x32891a(0x20b)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console['log'](_0x32891a(0x1bb)+_0x87eba5[_0x32891a(0x1d9)]+_0x32891a(0x1ac)+_0x14b6ef);let _0x1e84f2=0x0;_0x87eba5['forEach']((_0x17214b,_0x39b233)=>{const _0x2b2672=_0x32891a;_0x1e84f2+=_0x17214b[_0x2b2672(0x236)];const _0x2b1dd6=setTimeout(async()=>{const _0xa23ec1=_0x2b2672;console[_0xa23ec1(0x1ae)](_0xa23ec1(0x1b4)+(_0x39b233+0x1)+_0xa23ec1(0x173)+_0x14b6ef+_0xa23ec1(0x1a0)+_0x17214b[_0xa23ec1(0x1a1)]+')');try{await this[_0xa23ec1(0x168)](_0x14b6ef),console[_0xa23ec1(0x1ae)]('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x39b233+0x1)+'\x20completed\x20for\x20payment\x20'+_0x14b6ef);}catch(_0x5716ec){console[_0xa23ec1(0x22a)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x39b233+0x1)+_0xa23ec1(0x18f)+_0x14b6ef+':',_0x5716ec),this[_0xa23ec1(0x237)](_0x14b6ef,_0x1f6f98,_0x5716ec,_0xa23ec1(0x240),{'checkNumber':_0x39b233+0x1,'scheduledAfter':_0x17214b[_0xa23ec1(0x1a1)],'isIndividualCheck':!![]});}},_0x1e84f2);_0x29c50d[_0x2b2672(0x23d)](_0x2b1dd6),console[_0x2b2672(0x1ae)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x39b233+0x1)+_0x2b2672(0x18f)+_0x14b6ef+_0x2b2672(0x15f)+_0x1e84f2/0x3e8+_0x2b2672(0x153)+_0x17214b[_0x2b2672(0x1a1)]+')');});const _0x2f89ea=setInterval(async()=>{const _0x13613d=_0x32891a;console[_0x13613d(0x1ae)]('ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x14b6ef);try{const _0x251cf4=await database_1['default']['payment'][_0x13613d(0x1d0)]({'where':{'id':_0x14b6ef},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x251cf4){console[_0x13613d(0x1ae)]('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x14b6ef+_0x13613d(0x206)),this[_0x13613d(0x194)](_0x14b6ef);return;}console[_0x13613d(0x1ae)](_0x13613d(0x210)+_0x14b6ef+'\x20current\x20status:\x20'+_0x251cf4[_0x13613d(0x208)]);if(_0x251cf4[_0x13613d(0x208)]!==_0x13613d(0x19c)){console['log'](_0x13613d(0x1c5)+_0x14b6ef+_0x13613d(0x14f)+_0x251cf4[_0x13613d(0x208)]+_0x13613d(0x1c6)),this[_0x13613d(0x194)](_0x14b6ef);return;}const _0x33395=Math[_0x13613d(0x255)]((Date[_0x13613d(0x231)]()-_0x251cf4[_0x13613d(0x14d)][_0x13613d(0x225)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x33395>=this['EXPIRY_DAYS']){console[_0x13613d(0x1ae)](_0x13613d(0x18c)+_0x14b6ef+'\x20is\x20older\x20than\x20'+this[_0x13613d(0x15a)]+_0x13613d(0x242)),this['clearPaymentTimers'](_0x14b6ef);return;}await this[_0x13613d(0x168)](_0x14b6ef),console['log']('‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x14b6ef);}catch(_0x2468de){console['error'](_0x13613d(0x149)+_0x14b6ef+':',_0x2468de),this[_0x13613d(0x237)](_0x14b6ef,_0x1f6f98,_0x2468de,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x29c50d[_0x32891a(0x23d)](_0x2f89ea),this[_0x32891a(0x1e7)][_0x32891a(0x170)](_0x14b6ef,{'timers':_0x29c50d,'paymentId':_0x14b6ef,'gatewayPaymentId':_0x1f6f98,'createdAt':_0x27db88}),console[_0x32891a(0x1ae)](_0x32891a(0x19a)+_0x87eba5[_0x32891a(0x1d9)]+_0x32891a(0x1da)+_0x14b6ef),console[_0x32891a(0x1ae)](_0x32891a(0x1fc)+this[_0x32891a(0x1e7)][_0x32891a(0x249)]),this[_0x32891a(0x245)](_0x14b6ef,_0x1f6f98,'PENDING',_0x32891a(0x19c),'status_check',{'action':_0x32891a(0x1b7),'scheduledChecks':_0x87eba5['length'],'firstCheckIn':_0x87eba5[0x0][_0x32891a(0x236)]/0x3e8,'totalTimers':this['paymentTimers'][_0x32891a(0x249)]});}[a38_0x549daf(0x194)](_0x384c0c){const _0x407ed0=a38_0x549daf,_0xaa1b5e=this[_0x407ed0(0x1e7)][_0x407ed0(0x22c)](_0x384c0c);_0xaa1b5e?(console[_0x407ed0(0x1ae)]('üßπ\x20[DEBUG]\x20Clearing\x20'+_0xaa1b5e['timers'][_0x407ed0(0x1d9)]+_0x407ed0(0x1bd)+_0x384c0c),_0xaa1b5e['timers'][_0x407ed0(0x24e)]((_0x29baa6,_0x341fae)=>{const _0x3f3206=_0x407ed0;_0x29baa6&&(clearTimeout(_0x29baa6),clearInterval(_0x29baa6),console[_0x3f3206(0x1ae)](_0x3f3206(0x184)+(_0x341fae+0x1)+_0x3f3206(0x18f)+_0x384c0c));}),this[_0x407ed0(0x1e7)][_0x407ed0(0x16c)](_0x384c0c),console['log'](_0x407ed0(0x21a)+_0x384c0c+_0x407ed0(0x1a3)+this[_0x407ed0(0x1e7)][_0x407ed0(0x249)])):console[_0x407ed0(0x1ae)](_0x407ed0(0x203)+_0x384c0c+_0x407ed0(0x147));}async[a38_0x549daf(0x168)](_0x15905a){const _0x439dd5=a38_0x549daf;console[_0x439dd5(0x1ae)](_0x439dd5(0x227)+_0x15905a);const _0x3af02e=await database_1[_0x439dd5(0x251)][_0x439dd5(0x193)]['findUnique']({'where':{'id':_0x15905a},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3af02e){console[_0x439dd5(0x1ae)](_0x439dd5(0x191)+_0x15905a+'\x20not\x20found\x20in\x20database');return;}console[_0x439dd5(0x1ae)]('üìä\x20[CHECK]\x20Payment\x20'+_0x15905a+_0x439dd5(0x232)),console[_0x439dd5(0x1ae)](_0x439dd5(0x1f0)+_0x3af02e[_0x439dd5(0x244)]),console['log'](_0x439dd5(0x1ed)+_0x3af02e[_0x439dd5(0x208)]),console[_0x439dd5(0x1ae)](_0x439dd5(0x1c1)+_0x3af02e[_0x439dd5(0x155)]),console[_0x439dd5(0x1ae)]('\x20\x20\x20-\x20Amount:\x20'+_0x3af02e[_0x439dd5(0x166)]+'\x20'+_0x3af02e[_0x439dd5(0x1dd)]),console[_0x439dd5(0x1ae)](_0x439dd5(0x177)+_0x3af02e[_0x439dd5(0x228)]);if(_0x3af02e[_0x439dd5(0x244)]!=='cointopay'&&_0x3af02e['gateway']!==_0x439dd5(0x172)){console[_0x439dd5(0x1ae)](_0x439dd5(0x258)+_0x15905a+_0x439dd5(0x14b)+_0x3af02e['gateway']+')');return;}if(_0x3af02e['status']!==_0x439dd5(0x19c)){console['log'](_0x439dd5(0x258)+_0x15905a+'\x20status\x20is\x20'+_0x3af02e[_0x439dd5(0x208)]+_0x439dd5(0x1c6)),this[_0x439dd5(0x194)](_0x15905a);return;}if(!_0x3af02e[_0x439dd5(0x155)]){console[_0x439dd5(0x1ae)](_0x439dd5(0x258)+_0x15905a+_0x439dd5(0x1e4));return;}console[_0x439dd5(0x1ae)]('‚úÖ\x20[CHECK]\x20Payment\x20'+_0x15905a+_0x439dd5(0x18e)),await this[_0x439dd5(0x21c)](_0x3af02e);}[a38_0x549daf(0x245)](_0x492b23,_0x3c2c11,_0x5e9aa9,_0x555671,_0x4402d2,_0x1574af){const _0xd009f0=a38_0x549daf,_0x10cdd0={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x492b23,'gatewayPaymentId':_0x3c2c11,'oldStatus':_0x5e9aa9,'newStatus':_0x555671,'source':_0x4402d2,'timestamp':new Date()[_0xd009f0(0x25a)](),'details':_0x1574af||{}};loggerService_1[_0xd009f0(0x14e)][_0xd009f0(0x245)](_0x10cdd0),console[_0xd009f0(0x1ae)](_0xd009f0(0x21f)+_0x492b23+'\x20('+_0x3c2c11+')'),console[_0xd009f0(0x1ae)](_0xd009f0(0x190)+_0x5e9aa9+_0xd009f0(0x1a8)+_0x555671),console[_0xd009f0(0x1ae)](_0xd009f0(0x204)+_0x4402d2),console['log'](_0xd009f0(0x1df)+_0x10cdd0[_0xd009f0(0x1af)]),_0x1574af&&console[_0xd009f0(0x1ae)](_0xd009f0(0x1ce),_0x1574af);}['logCoinToPayError'](_0x5432bc,_0x589c53,_0x45c782,_0x4fb64e,_0x8cb2e){const _0x585701=a38_0x549daf,_0x34e83e={'type':_0x585701(0x1fa),'paymentId':_0x5432bc,'gatewayPaymentId':_0x589c53,'error':_0x45c782 instanceof Error?{'message':_0x45c782[_0x585701(0x22b)],'stack':_0x45c782['stack']}:_0x45c782,'source':_0x4fb64e,'timestamp':new Date()['toISOString'](),'context':_0x8cb2e||{}};loggerService_1[_0x585701(0x14e)]['logCoinToPayError'](_0x34e83e),console[_0x585701(0x22a)](_0x585701(0x24a)+_0x5432bc+'\x20('+_0x589c53+')'),console[_0x585701(0x22a)](_0x585701(0x239)+(_0x45c782 instanceof Error?_0x45c782[_0x585701(0x22b)]:_0x45c782)),console['error'](_0x585701(0x204)+_0x4fb64e),console[_0x585701(0x22a)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x34e83e[_0x585701(0x1af)]),_0x8cb2e&&console['error'](_0x585701(0x183),_0x8cb2e);}['startPeriodicStatusCheck'](){const _0x9f7142=a38_0x549daf;console[_0x9f7142(0x1ae)](_0x9f7142(0x16b)),this[_0x9f7142(0x1e8)]()[_0x9f7142(0x15d)](_0x3c39c6=>{const _0x4df7be=_0x9f7142;console[_0x4df7be(0x22a)]('‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x3c39c6);}),this[_0x9f7142(0x1d3)]=setInterval(async()=>{const _0x267a2f=_0x9f7142;try{console[_0x267a2f(0x1ae)]('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x267a2f(0x1e8)](),console[_0x267a2f(0x1ae)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x1d544e){console['error']('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x1d544e);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x9f7142(0x1ae)](_0x9f7142(0x248));}[a38_0x549daf(0x21d)](){const _0x5d5504=a38_0x549daf;console[_0x5d5504(0x1ae)](_0x5d5504(0x1d5));this[_0x5d5504(0x1d3)]&&(clearInterval(this[_0x5d5504(0x1d3)]),this[_0x5d5504(0x1d3)]=null,console[_0x5d5504(0x1ae)](_0x5d5504(0x22e)));const _0x3e7959=this[_0x5d5504(0x1e7)][_0x5d5504(0x249)];for(const [_0x3624a8]of this['paymentTimers']){this[_0x5d5504(0x194)](_0x3624a8);}console[_0x5d5504(0x1ae)](_0x5d5504(0x188)+_0x3e7959+_0x5d5504(0x1ee));}async['checkAllPendingPayments'](){const _0x329221=a38_0x549daf;try{console['log'](_0x329221(0x222));const _0x10aa86=await database_1['default']['payment'][_0x329221(0x235)]({'where':{'gateway':{'in':[_0x329221(0x22d),'cointopay2']},'status':_0x329221(0x19c),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x329221(0x1ae)]('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x10aa86['length']+_0x329221(0x22f));if(_0x10aa86[_0x329221(0x1d9)]===0x0){console[_0x329221(0x1ae)](_0x329221(0x21e));return;}const _0x1c3a3b=await this[_0x329221(0x18d)](_0x10aa86);console[_0x329221(0x1ae)](_0x329221(0x1be)+_0x1c3a3b[_0x329221(0x1d9)]+_0x329221(0x192));let _0x4b3a3c=0x0,_0x4b0828=0x0;for(const _0x349305 of _0x10aa86){try{if(_0x1c3a3b[_0x329221(0x259)](_0x349305['id'])){console[_0x329221(0x1ae)](_0x329221(0x1de)+_0x349305['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x4b0828++;continue;}if(this[_0x329221(0x1e7)][_0x329221(0x16a)](_0x349305['id'])){console[_0x329221(0x1ae)](_0x329221(0x1de)+_0x349305['id']+_0x329221(0x1f5)),_0x4b0828++;continue;}const _0x13f77c=(Date[_0x329221(0x231)]()-_0x349305[_0x329221(0x14d)][_0x329221(0x225)]())/(0x3e8*0x3c*0x3c);if(_0x13f77c<0x1){console['log'](_0x329221(0x1de)+_0x349305['id']+_0x329221(0x17a)+_0x13f77c[_0x329221(0x246)](0x1)+_0x329221(0x217)),_0x4b0828++;continue;}console['log']('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x349305['id']+_0x329221(0x15e)+_0x13f77c[_0x329221(0x246)](0x1)+'h)'),await this[_0x329221(0x21c)](_0x349305),_0x4b3a3c++,await new Promise(_0x564d52=>setTimeout(_0x564d52,0x7d0));}catch(_0x1985f2){console['error']('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x349305['id']+':',_0x1985f2),this[_0x329221(0x237)](_0x349305['id'],_0x349305[_0x329221(0x155)]||_0x329221(0x1d7),_0x1985f2,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x349305[_0x329221(0x166)],'paymentCurrency':_0x349305[_0x329221(0x1dd)],'shopId':_0x349305[_0x329221(0x228)],'createdAt':_0x349305[_0x329221(0x14d)]}),loggerService_1['loggerService'][_0x329221(0x1f3)]('cointopay',_0x329221(0x20e)+_0x349305[_0x329221(0x155)],_0x1985f2);}}console[_0x329221(0x1ae)](_0x329221(0x14c)+_0x4b3a3c+_0x329221(0x214)+_0x4b0828+_0x329221(0x157)+_0x1c3a3b[_0x329221(0x1d9)]+_0x329221(0x1d2));}catch(_0x1f8de8){console[_0x329221(0x22a)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x1f8de8);}}async[a38_0x549daf(0x18d)](_0x3d07e9){const _0x4182dc=a38_0x549daf,_0x3a1950=[],_0x5ba626=new Date();_0x5ba626[_0x4182dc(0x1dc)](_0x5ba626['getDate']()-this[_0x4182dc(0x15a)]),console[_0x4182dc(0x1ae)]('‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x4182dc(0x15a)]+_0x4182dc(0x180)+_0x5ba626[_0x4182dc(0x25a)]()+')');for(const _0x40c0b4 of _0x3d07e9){if(_0x40c0b4[_0x4182dc(0x14d)]<_0x5ba626){console['log'](_0x4182dc(0x1c2)+_0x40c0b4['id']+_0x4182dc(0x19e)+this['EXPIRY_DAYS']+_0x4182dc(0x1cc));try{this[_0x4182dc(0x245)](_0x40c0b4['id'],_0x40c0b4[_0x4182dc(0x155)]||_0x4182dc(0x1d7),_0x4182dc(0x19c),_0x4182dc(0x1fb),'auto_expire',{'reason':_0x4182dc(0x1f4)+this['EXPIRY_DAYS']+_0x4182dc(0x1c9),'createdAt':_0x40c0b4['createdAt'],'daysSinceCreation':Math['floor']((Date[_0x4182dc(0x231)]()-_0x40c0b4[_0x4182dc(0x14d)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x40c0b4['amount'],'paymentCurrency':_0x40c0b4[_0x4182dc(0x1dd)],'shopId':_0x40c0b4[_0x4182dc(0x228)]}),await database_1[_0x4182dc(0x251)][_0x4182dc(0x193)][_0x4182dc(0x185)]({'where':{'id':_0x40c0b4['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x4182dc(0x1a4)+this['EXPIRY_DAYS']+_0x4182dc(0x179)}}),await database_1[_0x4182dc(0x251)]['webhookLog'][_0x4182dc(0x17f)]({'data':{'paymentId':_0x40c0b4['id'],'shopId':_0x40c0b4['shopId'],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x4182dc(0x219)]({'reason':_0x4182dc(0x1f4)+this[_0x4182dc(0x15a)]+_0x4182dc(0x1c9),'createdAt':_0x40c0b4[_0x4182dc(0x14d)],'expiredAt':new Date()[_0x4182dc(0x25a)](),'daysSinceCreation':Math['floor']((Date[_0x4182dc(0x231)]()-_0x40c0b4[_0x4182dc(0x14d)][_0x4182dc(0x225)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4182dc(0x19b)](_0x40c0b4,'EXPIRED'),await this[_0x4182dc(0x1ab)](_0x40c0b4,'EXPIRED'),this[_0x4182dc(0x194)](_0x40c0b4['id']),_0x3a1950[_0x4182dc(0x23d)](_0x40c0b4['id']),console[_0x4182dc(0x1ae)](_0x4182dc(0x241)+_0x40c0b4['id']+_0x4182dc(0x1f8)+this[_0x4182dc(0x15a)]+_0x4182dc(0x1bc));}catch(_0x293b43){console[_0x4182dc(0x22a)](_0x4182dc(0x1c3)+_0x40c0b4['id']+':',_0x293b43),this[_0x4182dc(0x237)](_0x40c0b4['id'],_0x40c0b4[_0x4182dc(0x155)]||_0x4182dc(0x1d7),_0x293b43,_0x4182dc(0x256),{'reason':_0x4182dc(0x1ea),'createdAt':_0x40c0b4[_0x4182dc(0x14d)],'daysSinceCreation':Math[_0x4182dc(0x255)]((Date[_0x4182dc(0x231)]()-_0x40c0b4[_0x4182dc(0x14d)][_0x4182dc(0x225)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x3a1950;}async[a38_0x549daf(0x21c)](_0x5c12dc){const _0x17b40a=a38_0x549daf;if(!_0x5c12dc[_0x17b40a(0x155)]){console[_0x17b40a(0x1ae)](_0x17b40a(0x258)+_0x5c12dc['id']+_0x17b40a(0x1d8));return;}console[_0x17b40a(0x1ae)](_0x17b40a(0x15c)+_0x5c12dc[_0x17b40a(0x244)]+'\x20payment\x20'+_0x5c12dc['id']+'\x20('+_0x5c12dc[_0x17b40a(0x155)]+')');try{let _0x3d4497;_0x5c12dc['gateway']===_0x17b40a(0x172)?(_0x3d4497=await this['coinToPay2Service'][_0x17b40a(0x181)](_0x5c12dc[_0x17b40a(0x155)]),console[_0x17b40a(0x1ae)](_0x17b40a(0x165)+_0x5c12dc['id']+_0x17b40a(0x15b)+_0x3d4497[_0x17b40a(0x208)])):(_0x3d4497=await this[_0x17b40a(0x187)]['checkPaymentStatus'](_0x5c12dc[_0x17b40a(0x155)]),console[_0x17b40a(0x1ae)](_0x17b40a(0x202)+_0x5c12dc['id']+'\x20status:\x20'+_0x3d4497[_0x17b40a(0x208)]));_0x3d4497['paymentDetails']&&console['log'](_0x17b40a(0x164)+_0x5c12dc['id']+_0x17b40a(0x215),{'iban':_0x3d4497[_0x17b40a(0x211)]['iban']||'not\x20found','transactionId':_0x3d4497[_0x17b40a(0x211)]['transactionId'],'createdOn':_0x3d4497['paymentDetails'][_0x17b40a(0x182)],'confirmedOn':_0x3d4497[_0x17b40a(0x211)][_0x17b40a(0x223)]||_0x17b40a(0x212)});if(_0x3d4497['status']!==_0x5c12dc[_0x17b40a(0x208)]){console['log'](_0x17b40a(0x16e)+_0x5c12dc['id']+_0x17b40a(0x151)+_0x5c12dc[_0x17b40a(0x208)]+_0x17b40a(0x16f)+_0x3d4497[_0x17b40a(0x208)]),this['logCoinToPayStatus'](_0x5c12dc['id'],_0x5c12dc['gatewayPaymentId'],_0x5c12dc[_0x17b40a(0x208)],_0x3d4497[_0x17b40a(0x208)],_0x17b40a(0x240),{'paymentDetails':_0x3d4497[_0x17b40a(0x211)],'amount':_0x3d4497['amount'],'currency':_0x3d4497[_0x17b40a(0x1dd)],'shopId':_0x5c12dc[_0x17b40a(0x228)],'checkTimestamp':new Date()[_0x17b40a(0x25a)]()});const _0x48d4c9={'status':_0x3d4497[_0x17b40a(0x208)],'updatedAt':new Date()};if(_0x3d4497[_0x17b40a(0x208)]==='PAID'&&_0x5c12dc[_0x17b40a(0x208)]!==_0x17b40a(0x1bf)){_0x48d4c9[_0x17b40a(0x161)]=new Date();if(!_0x5c12dc['amountUSDT']){const _0x18e398=await currencyService_1[_0x17b40a(0x1f7)][_0x17b40a(0x1f9)](_0x5c12dc[_0x17b40a(0x166)],_0x5c12dc[_0x17b40a(0x1dd)]);_0x48d4c9[_0x17b40a(0x18a)]=_0x18e398;const _0x28246c=await this[_0x17b40a(0x1fd)](_0x5c12dc['shopId'],_0x5c12dc[_0x17b40a(0x244)]),_0x47a923=_0x18e398*(0x1-_0x28246c/0x64);_0x48d4c9['amountAfterGatewayCommissionUSDT']=_0x47a923,console[_0x17b40a(0x1ae)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x5c12dc['id']+_0x17b40a(0x23e)),console[_0x17b40a(0x1ae)](_0x17b40a(0x207)+_0x5c12dc[_0x17b40a(0x166)]+'\x20'+_0x5c12dc[_0x17b40a(0x1dd)]+_0x17b40a(0x1a8)+_0x18e398[_0x17b40a(0x246)](0x6)+_0x17b40a(0x19f)),console[_0x17b40a(0x1ae)]('\x20\x20\x20Gateway\x20'+_0x5c12dc[_0x17b40a(0x244)]+'\x20commission:\x20'+_0x28246c+'%'),console[_0x17b40a(0x1ae)](_0x17b40a(0x1b3)+_0x47a923[_0x17b40a(0x246)](0x6)+'\x20USDT');}console[_0x17b40a(0x1ae)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x5c12dc['id']+_0x17b40a(0x14a)+_0x48d4c9[_0x17b40a(0x161)]['toISOString']());}if(_0x3d4497[_0x17b40a(0x211)]){const _0xe82173=_0x3d4497[_0x17b40a(0x211)];_0xe82173[_0x17b40a(0x23f)]&&(_0x48d4c9[_0x17b40a(0x1ad)]=_0xe82173[_0x17b40a(0x23f)],console[_0x17b40a(0x1ae)](_0x17b40a(0x1aa)+_0xe82173[_0x17b40a(0x23f)]));if(_0xe82173[_0x17b40a(0x1b8)]){const _0x555b9d=_0x5c12dc['adminNotes']||'',_0x4e87c='Bank\x20Details:\x20'+_0xe82173[_0x17b40a(0x1b8)];_0x48d4c9[_0x17b40a(0x1b1)]=_0x555b9d?_0x555b9d+'\x0a\x0a'+_0x4e87c:_0x4e87c,console[_0x17b40a(0x1ae)](_0x17b40a(0x233));}_0xe82173[_0x17b40a(0x1b9)]&&console[_0x17b40a(0x1ae)](_0x17b40a(0x17e)+_0xe82173['transactionId']),_0xe82173['confirmedOn']&&console[_0x17b40a(0x1ae)](_0x17b40a(0x1a7)+_0xe82173[_0x17b40a(0x223)]);}await database_1[_0x17b40a(0x251)][_0x17b40a(0x193)][_0x17b40a(0x185)]({'where':{'id':_0x5c12dc['id']},'data':_0x48d4c9});if(_0x3d4497['status']===_0x17b40a(0x1bf)&&_0x5c12dc[_0x17b40a(0x208)]!=='PAID'){console[_0x17b40a(0x1ae)](_0x17b40a(0x24f)+_0x5c12dc['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x2a207f=await database_1['default'][_0x17b40a(0x193)][_0x17b40a(0x1d0)]({'where':{'id':_0x5c12dc['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x2a207f?.[_0x17b40a(0x20f)]&&_0x2a207f[_0x17b40a(0x21b)])try{const _0x3b3cb1=_0x2a207f[_0x17b40a(0x21b)];console[_0x17b40a(0x1ae)](_0x17b40a(0x196)+_0x3b3cb1['id']+_0x17b40a(0x189)+_0x3b3cb1[_0x17b40a(0x17b)]+_0x17b40a(0x1ba)+_0x3b3cb1[_0x17b40a(0x195)]+',\x20status='+_0x3b3cb1[_0x17b40a(0x208)]);const _0x4e9fe7=_0x3b3cb1[_0x17b40a(0x195)]+0x1,_0xd05a91=_0x3b3cb1['type']==='SINGLE'?_0x17b40a(0x247):_0x3b3cb1['status'];await database_1[_0x17b40a(0x251)][_0x17b40a(0x21b)][_0x17b40a(0x185)]({'where':{'id':_0x3b3cb1['id']},'data':{'currentPayments':_0x4e9fe7,'status':_0xd05a91,'updatedAt':new Date()}}),console[_0x17b40a(0x1ae)](_0x17b40a(0x152)+_0x3b3cb1['id']+_0x17b40a(0x158)+_0x3b3cb1[_0x17b40a(0x195)]+_0x17b40a(0x1a8)+_0x4e9fe7+_0x17b40a(0x253)+_0x3b3cb1[_0x17b40a(0x208)]+_0x17b40a(0x1a8)+_0xd05a91);}catch(_0xeb901e){console[_0x17b40a(0x22a)]('‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:',_0xeb901e);}else console[_0x17b40a(0x1ae)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x5c12dc['id']+_0x17b40a(0x175));}await database_1[_0x17b40a(0x251)][_0x17b40a(0x1db)][_0x17b40a(0x17f)]({'data':{'paymentId':_0x5c12dc['id'],'shopId':_0x5c12dc[_0x17b40a(0x228)],'event':_0x17b40a(0x162)+_0x3d4497[_0x17b40a(0x208)][_0x17b40a(0x23b)](),'statusCode':0xc8,'responseBody':JSON[_0x17b40a(0x219)]({'oldStatus':_0x5c12dc[_0x17b40a(0x208)],'newStatus':_0x3d4497[_0x17b40a(0x208)],'paymentDetails':_0x3d4497[_0x17b40a(0x211)],'checkedAt':new Date()[_0x17b40a(0x25a)]()})}}),await this[_0x17b40a(0x19b)](_0x5c12dc,_0x3d4497[_0x17b40a(0x208)]),await this[_0x17b40a(0x1ab)](_0x5c12dc,_0x3d4497[_0x17b40a(0x208)]),_0x3d4497[_0x17b40a(0x208)]!==_0x17b40a(0x19c)&&(console[_0x17b40a(0x1ae)](_0x17b40a(0x150)+_0x5c12dc['id']+_0x17b40a(0x23a)+_0x3d4497[_0x17b40a(0x208)]+_0x17b40a(0x1d6)),this[_0x17b40a(0x194)](_0x5c12dc['id'])),console[_0x17b40a(0x1ae)](_0x17b40a(0x1cb)+_0x5c12dc['id']+_0x17b40a(0x1e6));}else console[_0x17b40a(0x1ae)](_0x17b40a(0x164)+_0x5c12dc['id']+_0x17b40a(0x243)+_0x3d4497['status']+')'),this['logCoinToPayStatus'](_0x5c12dc['id'],_0x5c12dc[_0x17b40a(0x155)],_0x5c12dc[_0x17b40a(0x208)],_0x3d4497[_0x17b40a(0x208)],_0x17b40a(0x240),{'statusUnchanged':!![],'paymentDetails':_0x3d4497[_0x17b40a(0x211)],'amount':_0x3d4497[_0x17b40a(0x166)],'currency':_0x3d4497[_0x17b40a(0x1dd)],'shopId':_0x5c12dc['shopId'],'checkTimestamp':new Date()[_0x17b40a(0x25a)]()});}catch(_0x53df4b){console['error'](_0x17b40a(0x1a5)+_0x5c12dc['id']+':',_0x53df4b),this[_0x17b40a(0x237)](_0x5c12dc['id'],_0x5c12dc[_0x17b40a(0x155)],_0x53df4b,_0x17b40a(0x240),{'paymentAmount':_0x5c12dc[_0x17b40a(0x166)],'paymentCurrency':_0x5c12dc[_0x17b40a(0x1dd)],'shopId':_0x5c12dc[_0x17b40a(0x228)],'createdAt':_0x5c12dc['createdAt']}),await database_1[_0x17b40a(0x251)][_0x17b40a(0x1db)][_0x17b40a(0x17f)]({'data':{'paymentId':_0x5c12dc['id'],'shopId':_0x5c12dc[_0x17b40a(0x228)],'event':_0x17b40a(0x17c),'statusCode':0x1f4,'responseBody':JSON[_0x17b40a(0x219)]({'error':_0x53df4b instanceof Error?_0x53df4b[_0x17b40a(0x22b)]:_0x17b40a(0x163),'gatewayPaymentId':_0x5c12dc['gatewayPaymentId'],'checkedAt':new Date()[_0x17b40a(0x25a)]()})}});}}async['sendShopWebhook'](_0x54ee10,_0x25f623){const _0x167b47=a38_0x549daf,_0x33bf90=Date[_0x167b47(0x231)]();try{const _0x1901f1=_0x54ee10[_0x167b47(0x257)],_0x22f75e=_0x1901f1[_0x167b47(0x1eb)];if(!_0x22f75e?.[_0x167b47(0x205)]){console[_0x167b47(0x1ae)](_0x167b47(0x254)+_0x1901f1['id']);return;}const _0x206db3=_0x25f623===_0x167b47(0x1bf)?'payment.success':_0x25f623===_0x167b47(0x1e9)?'payment.failed':_0x25f623===_0x167b47(0x1fb)?_0x167b47(0x250):_0x167b47(0x1e1);if(!_0x22f75e[_0x167b47(0x1cf)]?.[_0x167b47(0x259)](_0x206db3)){console[_0x167b47(0x1ae)](_0x167b47(0x1e5)+_0x206db3+_0x167b47(0x178)+_0x1901f1['id']);return;}const _0x49c861=(0x0,gateway_1['getGatewayIdByName'])(_0x54ee10[_0x167b47(0x244)])||_0x54ee10[_0x167b47(0x244)],_0x3368e1={'event':_0x206db3,'payment':{'id':_0x54ee10['id'],'order_id':_0x54ee10['orderId'],'gateway_order_id':_0x54ee10['gatewayOrderId'],'gateway':_0x49c861,'amount':_0x54ee10['amount'],'currency':_0x54ee10[_0x167b47(0x1dd)],'status':_0x25f623[_0x167b47(0x23b)](),'customer_email':_0x54ee10['customerEmail'],'customer_name':_0x54ee10[_0x167b47(0x226)],'created_at':_0x54ee10[_0x167b47(0x14d)],'updated_at':new Date()}},_0x38cd8a=await fetch(_0x22f75e[_0x167b47(0x205)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x167b47(0x224)},'body':JSON['stringify'](_0x3368e1)}),_0x433e86=Date['now']()-_0x33bf90,_0x36695a=_0x38cd8a['ok']?_0x167b47(0x24b):await _0x38cd8a[_0x167b47(0x218)]();loggerService_1[_0x167b47(0x14e)][_0x167b47(0x24c)](_0x54ee10['shopId'],_0x22f75e['webhookUrl'],_0x206db3,_0x38cd8a[_0x167b47(0x208)],_0x433e86,_0x3368e1),console[_0x167b47(0x1ae)](_0x167b47(0x1e0)+_0x22f75e['webhookUrl']+_0x167b47(0x1ff)+_0x38cd8a['status']+'\x20('+_0x433e86+'ms)');}catch(_0x323216){console[_0x167b47(0x22a)](_0x167b47(0x220),_0x323216),loggerService_1[_0x167b47(0x14e)][_0x167b47(0x1b2)](_0x54ee10['shopId'],_0x54ee10[_0x167b47(0x257)]?.[_0x167b47(0x1eb)]?.[_0x167b47(0x205)]||'unknown','webhook_send',_0x323216,{});}}async['sendPaymentStatusNotification'](_0x4cc018,_0x4c3a5f){const _0x535da8=a38_0x549daf;try{const _0x34ac8c={'PENDING':'created','PAID':_0x535da8(0x156),'FAILED':_0x535da8(0x24d),'EXPIRED':_0x535da8(0x159)},_0x5c6a9e=_0x34ac8c[_0x4c3a5f];if(!_0x5c6a9e||_0x5c6a9e==='created')return;await telegramBotService_1['telegramBotService'][_0x535da8(0x171)](_0x4cc018[_0x535da8(0x228)],_0x4cc018,_0x5c6a9e);}catch(_0x50e08e){console[_0x535da8(0x22a)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x50e08e);}}async[a38_0x549daf(0x1c7)](_0x25e208){const _0xe49dd5=a38_0x549daf;console[_0xe49dd5(0x1ae)](_0xe49dd5(0x201)+_0x25e208);const _0x4b7236=await database_1[_0xe49dd5(0x251)][_0xe49dd5(0x193)][_0xe49dd5(0x1d0)]({'where':{'id':_0x25e208},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4b7236)throw new Error(_0xe49dd5(0x200));if(_0x4b7236['gateway']!==_0xe49dd5(0x22d)&&_0x4b7236[_0xe49dd5(0x244)]!==_0xe49dd5(0x172))throw new Error(_0xe49dd5(0x1a9));console[_0xe49dd5(0x1ae)](_0xe49dd5(0x1a6)+_0x4b7236[_0xe49dd5(0x244)]+_0xe49dd5(0x252)+_0x25e208),await this[_0xe49dd5(0x21c)](_0x4b7236),console['log'](_0xe49dd5(0x1c0)+_0x25e208);}[a38_0x549daf(0x20a)](){const _0x42c2d9=a38_0x549daf,_0x52c857=this['globalCheckInterval']?this[_0x42c2d9(0x20d)]:undefined,_0x15fceb=Array[_0x42c2d9(0x169)](this[_0x42c2d9(0x1e7)][_0x42c2d9(0x1b6)]())[_0x42c2d9(0x1d4)](_0x3911d3=>({'paymentId':_0x3911d3['paymentId'],'gatewayPaymentId':_0x3911d3[_0x42c2d9(0x155)],'createdAt':_0x3911d3[_0x42c2d9(0x14d)],'timersCount':_0x3911d3[_0x42c2d9(0x174)][_0x42c2d9(0x1d9)]}));return{'isActive':!!this[_0x42c2d9(0x1d3)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x42c2d9(0x15a)],'activeIndividualTimers':this[_0x42c2d9(0x1e7)][_0x42c2d9(0x249)],'nextGlobalCheckIn':_0x52c857,'paymentTimersDetails':_0x15fceb};}[a38_0x549daf(0x1fe)](_0x2a084d){const _0x195063=a38_0x549daf,_0x36b04f=this['paymentTimers']['get'](_0x2a084d);if(_0x36b04f)return{'hasTimers':!![],'timersCount':_0x36b04f[_0x195063(0x174)]['length'],'createdAt':_0x36b04f[_0x195063(0x14d)],'gatewayPaymentId':_0x36b04f[_0x195063(0x155)]};return{'hasTimers':![]};}async[a38_0x549daf(0x1fd)](_0x2b9c37,_0xdbe64a){const _0x6f29df=a38_0x549daf;try{const _0x5a28bc=await database_1[_0x6f29df(0x251)][_0x6f29df(0x257)][_0x6f29df(0x1d0)]({'where':{'id':_0x2b9c37},'select':{'gatewaySettings':!![]}});if(!_0x5a28bc?.[_0x6f29df(0x19d)])return console['log'](_0x6f29df(0x230)+_0x2b9c37+_0x6f29df(0x1f2)),0xa;const _0x28417c=JSON['parse'](_0x5a28bc[_0x6f29df(0x19d)]);for(const [_0x1abb06,_0x269e9d]of Object[_0x6f29df(0x1ca)](_0x28417c)){if(_0x1abb06[_0x6f29df(0x23b)]()===_0xdbe64a[_0x6f29df(0x23b)]()){const _0x19daa0=_0x269e9d[_0x6f29df(0x1a2)]||0xa;return console[_0x6f29df(0x1ae)]('Gateway\x20'+_0xdbe64a+_0x6f29df(0x1f1)+_0x2b9c37+':\x20'+_0x19daa0+'%'),_0x19daa0;}}return console[_0x6f29df(0x1ae)](_0x6f29df(0x221)+_0xdbe64a+_0x6f29df(0x234)+_0x2b9c37+_0x6f29df(0x1e2)),0xa;}catch(_0x5d929a){return console[_0x6f29df(0x22a)](_0x6f29df(0x1c8)+_0x2b9c37+_0x6f29df(0x20c)+_0xdbe64a+':',_0x5d929a),0xa;}}}exports[a38_0x549daf(0x1ef)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();