'use strict';const a38_0x4c308a=a38_0x843d;(function(_0x38cab6,_0x2900df){const _0x18487a=a38_0x843d,_0x258b48=_0x38cab6();while(!![]){try{const _0x3773b2=-parseInt(_0x18487a(0xc6))/0x1*(parseInt(_0x18487a(0x1a5))/0x2)+-parseInt(_0x18487a(0x172))/0x3*(-parseInt(_0x18487a(0x126))/0x4)+-parseInt(_0x18487a(0x178))/0x5*(parseInt(_0x18487a(0xf6))/0x6)+-parseInt(_0x18487a(0x13f))/0x7+parseInt(_0x18487a(0x1a6))/0x8*(-parseInt(_0x18487a(0xaf))/0x9)+parseInt(_0x18487a(0x175))/0xa+parseInt(_0x18487a(0xc1))/0xb;if(_0x3773b2===_0x2900df)break;else _0x258b48['push'](_0x258b48['shift']());}catch(_0x381070){_0x258b48['push'](_0x258b48['shift']());}}}(a38_0x5bee,0x3fa31));var __importDefault=this&&this[a38_0x4c308a(0xaa)]||function(_0x3d5907){const _0x332b92=a38_0x4c308a;return _0x3d5907&&_0x3d5907[_0x332b92(0x13d)]?_0x3d5907:{'default':_0x3d5907};};Object['defineProperty'](exports,a38_0x4c308a(0x13d),{'value':!![]}),exports['coinToPayStatusService']=exports[a38_0x4c308a(0x116)]=void 0x0;const coinToPayService_1=require(a38_0x4c308a(0x12e)),coinToPay2Service_1=require(a38_0x4c308a(0x114)),gateway_1=require('../types/gateway'),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a38_0x4c308a(0x159)),loggerService_1=require('./loggerService'),currencyService_1=require('./currencyService');function a38_0x843d(_0xe8941,_0x1b0200){const _0x5beec6=a38_0x5bee();return a38_0x843d=function(_0x843d4,_0x32033f){_0x843d4=_0x843d4-0x9e;let _0x28f249=_0x5beec6[_0x843d4];return _0x28f249;},a38_0x843d(_0xe8941,_0x1b0200);}function a38_0x5bee(){const _0x44a02e=['\x20(age:\x20','\x20->\x20','customerName','\x20\x20\x20-\x20gatewayPaymentId:\x20','5\x20minutes','5487IDOEhP','logCoinToPayError','2\x20minutes','1134230XDjlbL','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','adminNotes','5tOrGoU','\x20\x20\x20❌\x20Error:\x20','getGatewayCommission','webhookUrl','timers','\x20days','🔍\x20[CHECK]\x20Checking\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','Success','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','stopPeriodicStatusCheck','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','ms)','\x20pending\x20CoinToPay\x20payments','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...',',\x20status=','amountAfterGatewayCommissionUSDT','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20updated\x20successfully','paymentDetails','findUnique','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20is\x20valid\x20for\x20checking,\x20proceeding...','Failed\x20to\x20send\x20shop\x20webhook:','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20current\x20status:\x20','checkPaymentStatus','forEach','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20triggered\x20for\x20payment\x20','paymentId','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check',',\x20currentPayments=','toFixed','status_check','shop','iban','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20in\x20shop\x20','EXPIRED','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','Failed\x20to\x20mark\x20payment\x20as\x20expired',',\x20stopping\x20individual\x20checks','map','97396knbhnw','11328VVjVCQ','\x20\x20\x20📍\x20Source:\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20\x20\x20-\x20Amount:\x20','unknown','\x20in\x20','📊\x20[HOURLY]\x20Payment\x20','SINGLE','\x20\x20\x20-\x20Gateway:\x20','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','default','\x20\x20\x20-\x20ShopId:\x20','⏰\x20[GLOBAL]\x20Payment\x20','PENDING','paymentLink','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','globalCheckInterval','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','createdAt','__importDefault','\x20expired','\x20not\x20enabled\x20for\x20shop\x20','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','payment','234joJkJe','set','customerEmail','\x20completed\x20for\x20payment\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20seconds\x20(','paid','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','🪙\x20[GLOBAL]\x20Found\x20','\x20\x20\x20📝\x20Context:','transactionId','\x20marked\x20as\x20paid\x20at:\x20','/status/','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','📈\x20[COINTOPAY]\x20Payment\x20','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20amounts\x20calculated:','8088487nHsCrS','\x20\x20\x20📅\x20Time:\x20','⏰\x20[GLOBAL]\x20Found\x20','Bank\x20Details:\x20','\x20is\x20older\x20than\x20','1rSOhop','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20payment\x20','1\x20minute','\x20initial\x20timers\x20for\x20payment\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','❌\x20[CHECK]\x20Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20status\x20changed\x20to\x20','create','Payment\x20older\x20than\x20','has','✅\x20[HOURLY]\x20Payment\x20','\x20for\x20payment\x20','\x20USDT','getGatewayIdByName','✅\x20[TIMER]\x20Individual\x20check\x20#','amount','getTime','🔄\x20[CHECK]\x20Updating\x20payment\x20','CoinToPay2Service','checkAllPendingPayments','\x20\x20\x20📊\x20Status:\x20','\x20\x20\x20Gateway\x20','schedule_created','gatewayPaymentId','\x20with\x20status\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','telegramBotService','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','Unknown\x20error','PAID','push','sendPaymentStatusNotification','paidAt','\x20has\x20no\x20gatewayPaymentId,\x20skipping','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','getServiceStats','length','stringify','startPeriodicStatusCheck','sendShopWebhook','delete','failed','message','\x20\x20\x20-\x20GatewayPaymentId:\x20','currency','coinToPayService','2935356bwKuPr','🧹\x20[CHECK]\x20Payment\x20','✅\x20[EXPIRY]\x20Payment\x20','checkExpiredPayments','commission','\x20checked,\x20','Payment\x20not\x20found','coinToPay2Service','logShopWebhookSent','\x20days,\x20marking\x20as\x20EXPIRED','checkSinglePaymentById','\x20individual\x20payment\x20timers','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','sendPaymentNotification','\x20\x20\x20📝\x20Details:','application/json','\x20commission:\x20','shopId','clearPaymentTimers','parse','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20\x20\x20-\x20paymentId:\x20','cointopay_status_check_error','COMPLETED','-day\x20timeout','cointopay','webhookLog','created','currentPayments','payment.pending','./gateways/coinToPay2Service','description','CoinToPayStatusService','settings','checkSinglePayment','toLowerCase','GLOBAL_CHECK_INTERVAL_MS','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','remitterIban','⏰\x20[EXPIRY]\x20Payment\x20','payment.failed','get','Webhook\x20event\x20','\x20status\x20is\x20','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','cointopay_status_check_','\x20not\x20found,\x20clearing\x20timers','424LhKdxT','convertToUSDT','not\x20found','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','✅\x20[COINTOPAY]\x20Payment\x20link\x20','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','Shop\x20webhook\x20sent\x20to\x20','paymentTimers','./gateways/coinToPayService','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','logCoinToPayStatus','\x20updated:\x20currentPayments=','🪙\x20[TIMER]\x20Individual\x20check\x20#','expired','\x20timers\x20for\x20payment\x20','cointopay2','\x20(after\x20',':\x20type=',',\x20clearing\x20individual\x20timers','\x20\x20\x20Amount\x20after\x20commission:\x20','loggerService','EXPIRY_DAYS','delay','__esModule','\x20days\x20(created\x20before\x20','1450519wAToXI','FAILED','size','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','now','toISOString','📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','\x20commission\x20for\x20shop\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','type','update','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','💰\x20[CHECK]\x20Payment\x20','\x20not\x20found\x20in\x20database','Gateway\x20','\x20details:','includes','values','gatewaySettings','bankDetails',',\x20using\x20default\x2010%','timestamp','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','cointopay_auto_expired','entries','./telegramBotService','📊\x20[CHECK]\x20Payment\x20','gatewayOrderId','setDate','text','webhook_send','floor','logWhiteDomainError','status','POST','\x20skipped,\x20','gateway','error','createdOn','\x20expired\x20CoinToPay\x20payments','\x20days\x20without\x20payment\x20confirmation',',\x20using\x20default\x20commission\x2010%','log','logShopWebhookError','⚠️\x20[CHECK]\x20Payment\x20'];a38_0x5bee=function(){return _0x44a02e;};return a38_0x5bee();}class CoinToPayStatusService{constructor(){const _0x2e29e3=a38_0x4c308a;this[_0x2e29e3(0xa7)]=null,this[_0x2e29e3(0x11a)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x2e29e3(0x12d)]=new Map(),this[_0x2e29e3(0xf5)]=new coinToPayService_1['CoinToPayService'](),this[_0x2e29e3(0xfd)]=new coinToPay2Service_1[(_0x2e29e3(0xda))](),console[_0x2e29e3(0x16a)](_0x2e29e3(0x12b));}['schedulePaymentChecks'](_0x25666c,_0x5618b2){const _0x97640c=a38_0x4c308a;console['log'](_0x97640c(0xad)),console[_0x97640c(0x16a)](_0x97640c(0x10b)+_0x25666c),console['log'](_0x97640c(0x170)+_0x5618b2),this['clearPaymentTimers'](_0x25666c);const _0x39a5a3=[],_0x524f1b=new Date(),_0x3a0e4e=[{'delay':0x1*0x3c*0x3e8,'description':_0x97640c(0xc9)},{'delay':0x2*0x3c*0x3e8,'description':_0x97640c(0x174)},{'delay':0x5*0x3c*0x3e8,'description':_0x97640c(0x171)},{'delay':0x5*0x3c*0x3e8,'description':_0x97640c(0x171)}];console[_0x97640c(0x16a)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x3a0e4e[_0x97640c(0xec)]+_0x97640c(0xca)+_0x25666c);let _0x26a5aa=0x0;_0x3a0e4e['forEach']((_0x531b3b,_0x23b8ee)=>{const _0xa7de7c=_0x97640c;_0x26a5aa+=_0x531b3b[_0xa7de7c(0x13c)];const _0x5ddfb8=setTimeout(async()=>{const _0x44b4b2=_0xa7de7c;console[_0x44b4b2(0x16a)](_0x44b4b2(0x132)+(_0x23b8ee+0x1)+_0x44b4b2(0x196)+_0x25666c+_0x44b4b2(0x136)+_0x531b3b[_0x44b4b2(0x115)]+')');try{await this[_0x44b4b2(0x100)](_0x25666c),console[_0x44b4b2(0x16a)](_0x44b4b2(0xd6)+(_0x23b8ee+0x1)+_0x44b4b2(0xb2)+_0x25666c);}catch(_0x342e51){console[_0x44b4b2(0x165)](_0x44b4b2(0xbd)+(_0x23b8ee+0x1)+'\x20for\x20payment\x20'+_0x25666c+':',_0x342e51),this[_0x44b4b2(0x173)](_0x25666c,_0x5618b2,_0x342e51,'status_check',{'checkNumber':_0x23b8ee+0x1,'scheduledAfter':_0x531b3b[_0x44b4b2(0x115)],'isIndividualCheck':!![]});}},_0x26a5aa);_0x39a5a3[_0xa7de7c(0xe6)](_0x5ddfb8),console[_0xa7de7c(0x16a)](_0xa7de7c(0xbf)+(_0x23b8ee+0x1)+_0xa7de7c(0xd3)+_0x25666c+_0xa7de7c(0x1ab)+_0x26a5aa/0x3e8+_0xa7de7c(0xb4)+_0x531b3b[_0xa7de7c(0x115)]+')');});const _0x2543e8=setInterval(async()=>{const _0x40d506=_0x97640c;console[_0x40d506(0x16a)](_0x40d506(0x147)+_0x25666c);try{const _0xfd7239=await database_1[_0x40d506(0xa1)][_0x40d506(0xae)]['findUnique']({'where':{'id':_0x25666c},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0xfd7239){console[_0x40d506(0x16a)]('❌\x20[HOURLY]\x20Payment\x20'+_0x25666c+_0x40d506(0x125)),this[_0x40d506(0x108)](_0x25666c);return;}console[_0x40d506(0x16a)](_0x40d506(0x1ac)+_0x25666c+_0x40d506(0x192)+_0xfd7239['status']);if(_0xfd7239[_0x40d506(0x161)]!==_0x40d506(0xa4)){console[_0x40d506(0x16a)](_0x40d506(0xd2)+_0x25666c+'\x20status\x20is\x20'+_0xfd7239[_0x40d506(0x161)]+_0x40d506(0x1a3)),this[_0x40d506(0x108)](_0x25666c);return;}const _0x429fbb=Math[_0x40d506(0x15f)]((Date[_0x40d506(0x143)]()-_0xfd7239['createdAt'][_0x40d506(0xd8)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x429fbb>=this['EXPIRY_DAYS']){console[_0x40d506(0x16a)]('⏰\x20[HOURLY]\x20Payment\x20'+_0x25666c+_0x40d506(0xc5)+this['EXPIRY_DAYS']+_0x40d506(0x198)),this[_0x40d506(0x108)](_0x25666c);return;}await this[_0x40d506(0x100)](_0x25666c),console[_0x40d506(0x16a)](_0x40d506(0xb6)+_0x25666c);}catch(_0x46ca38){console[_0x40d506(0x165)](_0x40d506(0x19e)+_0x25666c+':',_0x46ca38),this[_0x40d506(0x173)](_0x25666c,_0x5618b2,_0x46ca38,_0x40d506(0x19b),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x39a5a3['push'](_0x2543e8),this['paymentTimers'][_0x97640c(0xb0)](_0x25666c,{'timers':_0x39a5a3,'paymentId':_0x25666c,'gatewayPaymentId':_0x5618b2,'createdAt':_0x524f1b}),console[_0x97640c(0x16a)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x3a0e4e[_0x97640c(0xec)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x25666c),console[_0x97640c(0x16a)](_0x97640c(0x11c)+this[_0x97640c(0x12d)][_0x97640c(0x141)]),this[_0x97640c(0x130)](_0x25666c,_0x5618b2,'PENDING',_0x97640c(0xa4),_0x97640c(0x19b),{'action':_0x97640c(0xde),'scheduledChecks':_0x3a0e4e[_0x97640c(0xec)],'firstCheckIn':_0x3a0e4e[0x0][_0x97640c(0x13c)]/0x3e8,'totalTimers':this['paymentTimers']['size']});}[a38_0x4c308a(0x108)](_0x2ee791){const _0x1a2f82=a38_0x4c308a,_0x1efc58=this['paymentTimers'][_0x1a2f82(0x120)](_0x2ee791);_0x1efc58?(console['log']('🧹\x20[DEBUG]\x20Clearing\x20'+_0x1efc58[_0x1a2f82(0x17c)][_0x1a2f82(0xec)]+_0x1a2f82(0x134)+_0x2ee791),_0x1efc58[_0x1a2f82(0x17c)][_0x1a2f82(0x194)]((_0x104acb,_0x2315cf)=>{const _0x11d187=_0x1a2f82;_0x104acb&&(clearTimeout(_0x104acb),clearInterval(_0x104acb),console[_0x11d187(0x16a)](_0x11d187(0x18a)+(_0x2315cf+0x1)+_0x11d187(0xd3)+_0x2ee791));}),this['paymentTimers'][_0x1a2f82(0xf0)](_0x2ee791),console[_0x1a2f82(0x16a)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x2ee791+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x1a2f82(0x12d)]['size'])):console[_0x1a2f82(0x16a)](_0x1a2f82(0x102)+_0x2ee791+'\x20to\x20clear');}async[a38_0x4c308a(0x100)](_0x3f212d){const _0x29071f=a38_0x4c308a;console[_0x29071f(0x16a)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x3f212d);const _0x1d4ce9=await database_1['default']['payment'][_0x29071f(0x18d)]({'where':{'id':_0x3f212d},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1d4ce9){console['log'](_0x29071f(0xcc)+_0x3f212d+_0x29071f(0x14d));return;}console[_0x29071f(0x16a)](_0x29071f(0x15a)+_0x3f212d+'\x20found:'),console[_0x29071f(0x16a)](_0x29071f(0x9f)+_0x1d4ce9[_0x29071f(0x164)]),console[_0x29071f(0x16a)]('\x20\x20\x20-\x20Status:\x20'+_0x1d4ce9['status']),console[_0x29071f(0x16a)](_0x29071f(0xf3)+_0x1d4ce9[_0x29071f(0xdf)]),console[_0x29071f(0x16a)](_0x29071f(0x1a9)+_0x1d4ce9[_0x29071f(0xd7)]+'\x20'+_0x1d4ce9['currency']),console['log'](_0x29071f(0xa2)+_0x1d4ce9[_0x29071f(0x107)]);if(_0x1d4ce9[_0x29071f(0x164)]!==_0x29071f(0x10f)&&_0x1d4ce9['gateway']!==_0x29071f(0x135)){console[_0x29071f(0x16a)](_0x29071f(0x16c)+_0x3f212d+'\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20'+_0x1d4ce9['gateway']+')');return;}if(_0x1d4ce9['status']!=='PENDING'){console[_0x29071f(0x16a)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x3f212d+_0x29071f(0x122)+_0x1d4ce9[_0x29071f(0x161)]+_0x29071f(0x1a3)),this[_0x29071f(0x108)](_0x3f212d);return;}if(!_0x1d4ce9['gatewayPaymentId']){console[_0x29071f(0x16a)](_0x29071f(0x16c)+_0x3f212d+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x29071f(0x16a)]('✅\x20[CHECK]\x20Payment\x20'+_0x3f212d+_0x29071f(0x18f)),await this[_0x29071f(0x118)](_0x1d4ce9);}[a38_0x4c308a(0x130)](_0x36f315,_0x40b808,_0x555740,_0x2bc212,_0x199d1c,_0x175c65){const _0xd9d6a8=a38_0x4c308a,_0xa671f9={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x36f315,'gatewayPaymentId':_0x40b808,'oldStatus':_0x555740,'newStatus':_0x2bc212,'source':_0x199d1c,'timestamp':new Date()[_0xd9d6a8(0x144)](),'details':_0x175c65||{}};loggerService_1[_0xd9d6a8(0x13a)][_0xd9d6a8(0x130)](_0xa671f9),console[_0xd9d6a8(0x16a)](_0xd9d6a8(0xb7)+_0x36f315+'\x20('+_0x40b808+')'),console[_0xd9d6a8(0x16a)](_0xd9d6a8(0xdc)+_0x555740+_0xd9d6a8(0x16e)+_0x2bc212),console[_0xd9d6a8(0x16a)](_0xd9d6a8(0x1a7)+_0x199d1c),console[_0xd9d6a8(0x16a)](_0xd9d6a8(0xc2)+_0xa671f9[_0xd9d6a8(0x155)]),_0x175c65&&console[_0xd9d6a8(0x16a)](_0xd9d6a8(0x104),_0x175c65);}[a38_0x4c308a(0x173)](_0x478bec,_0x545a1b,_0x241bc8,_0x3d52d4,_0x4fef48){const _0x383b78=a38_0x4c308a,_0x5370b9={'type':'COINTOPAY_ERROR','paymentId':_0x478bec,'gatewayPaymentId':_0x545a1b,'error':_0x241bc8 instanceof Error?{'message':_0x241bc8['message'],'stack':_0x241bc8['stack']}:_0x241bc8,'source':_0x3d52d4,'timestamp':new Date()['toISOString'](),'context':_0x4fef48||{}};loggerService_1[_0x383b78(0x13a)][_0x383b78(0x173)](_0x5370b9),console[_0x383b78(0x165)](_0x383b78(0xc7)+_0x478bec+'\x20('+_0x545a1b+')'),console['error'](_0x383b78(0x179)+(_0x241bc8 instanceof Error?_0x241bc8[_0x383b78(0xf2)]:_0x241bc8)),console[_0x383b78(0x165)]('\x20\x20\x20📍\x20Source:\x20'+_0x3d52d4),console[_0x383b78(0x165)](_0x383b78(0xc2)+_0x5370b9[_0x383b78(0x155)]),_0x4fef48&&console[_0x383b78(0x165)](_0x383b78(0xb9),_0x4fef48);}[a38_0x4c308a(0xee)](){const _0x41ec52=a38_0x4c308a;console[_0x41ec52(0x16a)](_0x41ec52(0x156)),this['checkAllPendingPayments']()['catch'](_0x33941d=>{const _0x13b054=_0x41ec52;console['error'](_0x13b054(0x1a1),_0x33941d);}),this['globalCheckInterval']=setInterval(async()=>{const _0x59897d=_0x41ec52;try{console[_0x59897d(0x16a)]('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x59897d(0xdb)](),console[_0x59897d(0x16a)](_0x59897d(0xa0));}catch(_0x4366cb){console[_0x59897d(0x165)]('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x4366cb);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x41ec52(0x16a)](_0x41ec52(0x195));}[a38_0x4c308a(0x182)](){const _0x209e98=a38_0x4c308a;console[_0x209e98(0x16a)](_0x209e98(0x186));this[_0x209e98(0xa7)]&&(clearInterval(this[_0x209e98(0xa7)]),this[_0x209e98(0xa7)]=null,console[_0x209e98(0x16a)](_0x209e98(0x18e)));const _0x556e18=this[_0x209e98(0x12d)][_0x209e98(0x141)];for(const [_0x476772]of this[_0x209e98(0x12d)]){this[_0x209e98(0x108)](_0x476772);}console[_0x209e98(0x16a)]('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x556e18+_0x209e98(0x101));}async[a38_0x4c308a(0xdb)](){const _0x619e63=a38_0x4c308a;try{console['log'](_0x619e63(0x10a));const _0x5560c7=await database_1[_0x619e63(0xa1)][_0x619e63(0xae)]['findMany']({'where':{'gateway':{'in':[_0x619e63(0x10f),_0x619e63(0x135)]},'status':_0x619e63(0xa4),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x619e63(0x16a)](_0x619e63(0xb8)+_0x5560c7[_0x619e63(0xec)]+_0x619e63(0x185));if(_0x5560c7[_0x619e63(0xec)]===0x0){console['log'](_0x619e63(0x1a8));return;}const _0x521064=await this[_0x619e63(0xf9)](_0x5560c7);console[_0x619e63(0x16a)](_0x619e63(0xc3)+_0x521064['length']+_0x619e63(0x167));let _0x2e355b=0x0,_0x4d68b6=0x0;for(const _0x34a560 of _0x5560c7){try{if(_0x521064[_0x619e63(0x150)](_0x34a560['id'])){console[_0x619e63(0x16a)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x34a560['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x4d68b6++;continue;}if(this[_0x619e63(0x12d)][_0x619e63(0xd1)](_0x34a560['id'])){console[_0x619e63(0x16a)](_0x619e63(0xa3)+_0x34a560['id']+_0x619e63(0x17f)),_0x4d68b6++;continue;}const _0x3d140b=(Date[_0x619e63(0x143)]()-_0x34a560['createdAt'][_0x619e63(0xd8)]())/(0x3e8*0x3c*0x3c);if(_0x3d140b<0x1){console[_0x619e63(0x16a)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x34a560['id']+'\x20is\x20too\x20new\x20('+_0x3d140b[_0x619e63(0x19a)](0x1)+'h),\x20skipping\x20global\x20check'),_0x4d68b6++;continue;}console[_0x619e63(0x16a)](_0x619e63(0xe3)+_0x34a560['id']+_0x619e63(0x16d)+_0x3d140b[_0x619e63(0x19a)](0x1)+'h)'),await this[_0x619e63(0x118)](_0x34a560),_0x2e355b++,await new Promise(_0x30b1bf=>setTimeout(_0x30b1bf,0x7d0));}catch(_0x201989){console[_0x619e63(0x165)](_0x619e63(0x191)+_0x34a560['id']+':',_0x201989),this[_0x619e63(0x173)](_0x34a560['id'],_0x34a560[_0x619e63(0xdf)]||'unknown',_0x201989,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x34a560[_0x619e63(0xd7)],'paymentCurrency':_0x34a560[_0x619e63(0xf4)],'shopId':_0x34a560[_0x619e63(0x107)],'createdAt':_0x34a560[_0x619e63(0xa9)]}),loggerService_1[_0x619e63(0x13a)][_0x619e63(0x160)](_0x619e63(0x10f),_0x619e63(0xbc)+_0x34a560['gatewayPaymentId'],_0x201989);}}console[_0x619e63(0x16a)](_0x619e63(0x12f)+_0x2e355b+_0x619e63(0xfb)+_0x4d68b6+_0x619e63(0x163)+_0x521064['length']+_0x619e63(0xab));}catch(_0x3310a5){console[_0x619e63(0x165)](_0x619e63(0x129),_0x3310a5);}}async[a38_0x4c308a(0xf9)](_0x42b584){const _0xd6a3b8=a38_0x4c308a,_0x5de1aa=[],_0x559a01=new Date();_0x559a01[_0xd6a3b8(0x15c)](_0x559a01['getDate']()-this['EXPIRY_DAYS']),console[_0xd6a3b8(0x16a)](_0xd6a3b8(0xcb)+this[_0xd6a3b8(0x13b)]+_0xd6a3b8(0x13e)+_0x559a01['toISOString']()+')');for(const _0x3d7560 of _0x42b584){if(_0x3d7560[_0xd6a3b8(0xa9)]<_0x559a01){console[_0xd6a3b8(0x16a)](_0xd6a3b8(0x11e)+_0x3d7560['id']+_0xd6a3b8(0xc5)+this[_0xd6a3b8(0x13b)]+_0xd6a3b8(0xff));try{this[_0xd6a3b8(0x130)](_0x3d7560['id'],_0x3d7560['gatewayPaymentId']||_0xd6a3b8(0x1aa),_0xd6a3b8(0xa4),_0xd6a3b8(0x1a0),'auto_expire',{'reason':_0xd6a3b8(0xd0)+this[_0xd6a3b8(0x13b)]+_0xd6a3b8(0x17d),'createdAt':_0x3d7560['createdAt'],'daysSinceCreation':Math[_0xd6a3b8(0x15f)]((Date[_0xd6a3b8(0x143)]()-_0x3d7560[_0xd6a3b8(0xa9)][_0xd6a3b8(0xd8)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x3d7560[_0xd6a3b8(0xd7)],'paymentCurrency':_0x3d7560['currency'],'shopId':_0x3d7560[_0xd6a3b8(0x107)]}),await database_1[_0xd6a3b8(0xa1)][_0xd6a3b8(0xae)][_0xd6a3b8(0x149)]({'where':{'id':_0x3d7560['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0xd6a3b8(0x13b)]+_0xd6a3b8(0x168)}}),await database_1[_0xd6a3b8(0xa1)][_0xd6a3b8(0x110)]['create']({'data':{'paymentId':_0x3d7560['id'],'shopId':_0x3d7560[_0xd6a3b8(0x107)],'event':_0xd6a3b8(0x157),'statusCode':0xc8,'responseBody':JSON[_0xd6a3b8(0xed)]({'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x3d7560['createdAt'],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0xd6a3b8(0x15f)]((Date['now']()-_0x3d7560[_0xd6a3b8(0xa9)][_0xd6a3b8(0xd8)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x3d7560,_0xd6a3b8(0x1a0)),await this[_0xd6a3b8(0xe7)](_0x3d7560,_0xd6a3b8(0x1a0)),this['clearPaymentTimers'](_0x3d7560['id']),_0x5de1aa[_0xd6a3b8(0xe6)](_0x3d7560['id']),console['log'](_0xd6a3b8(0xf8)+_0x3d7560['id']+_0xd6a3b8(0xb3)+this[_0xd6a3b8(0x13b)]+_0xd6a3b8(0x10e));}catch(_0x2727eb){console[_0xd6a3b8(0x165)](_0xd6a3b8(0x183)+_0x3d7560['id']+':',_0x2727eb),this[_0xd6a3b8(0x173)](_0x3d7560['id'],_0x3d7560[_0xd6a3b8(0xdf)]||_0xd6a3b8(0x1aa),_0x2727eb,'auto_expire',{'reason':_0xd6a3b8(0x1a2),'createdAt':_0x3d7560[_0xd6a3b8(0xa9)],'daysSinceCreation':Math[_0xd6a3b8(0x15f)]((Date[_0xd6a3b8(0x143)]()-_0x3d7560[_0xd6a3b8(0xa9)][_0xd6a3b8(0xd8)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5de1aa;}async[a38_0x4c308a(0x118)](_0x145c2e){const _0x48b7cb=a38_0x4c308a;if(!_0x145c2e[_0x48b7cb(0xdf)]){console[_0x48b7cb(0x16a)](_0x48b7cb(0x16c)+_0x145c2e['id']+_0x48b7cb(0xe9));return;}console[_0x48b7cb(0x16a)](_0x48b7cb(0x17e)+_0x145c2e['gateway']+_0x48b7cb(0xc8)+_0x145c2e['id']+'\x20('+_0x145c2e[_0x48b7cb(0xdf)]+')');try{let _0x4451c1;_0x145c2e['gateway']==='cointopay2'?(_0x4451c1=await this[_0x48b7cb(0xfd)][_0x48b7cb(0x193)](_0x145c2e[_0x48b7cb(0xdf)]),console['log'](_0x48b7cb(0xea)+_0x145c2e['id']+'\x20status:\x20'+_0x4451c1[_0x48b7cb(0x161)])):(_0x4451c1=await this['coinToPayService']['checkPaymentStatus'](_0x145c2e[_0x48b7cb(0xdf)]),console[_0x48b7cb(0x16a)](_0x48b7cb(0x11b)+_0x145c2e['id']+'\x20status:\x20'+_0x4451c1[_0x48b7cb(0x161)]));_0x4451c1[_0x48b7cb(0x18c)]&&console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x145c2e['id']+_0x48b7cb(0x14f),{'iban':_0x4451c1['paymentDetails'][_0x48b7cb(0x19d)]||_0x48b7cb(0x128),'transactionId':_0x4451c1[_0x48b7cb(0x18c)]['transactionId'],'createdOn':_0x4451c1[_0x48b7cb(0x18c)][_0x48b7cb(0x166)],'confirmedOn':_0x4451c1[_0x48b7cb(0x18c)]['confirmedOn']||'not\x20confirmed'});if(_0x4451c1[_0x48b7cb(0x161)]!==_0x145c2e['status']){console[_0x48b7cb(0x16a)](_0x48b7cb(0xd9)+_0x145c2e['id']+'\x20status\x20from\x20'+_0x145c2e[_0x48b7cb(0x161)]+'\x20to\x20'+_0x4451c1[_0x48b7cb(0x161)]),this[_0x48b7cb(0x130)](_0x145c2e['id'],_0x145c2e['gatewayPaymentId'],_0x145c2e[_0x48b7cb(0x161)],_0x4451c1['status'],'status_check',{'paymentDetails':_0x4451c1['paymentDetails'],'amount':_0x4451c1[_0x48b7cb(0xd7)],'currency':_0x4451c1[_0x48b7cb(0xf4)],'shopId':_0x145c2e[_0x48b7cb(0x107)],'checkTimestamp':new Date()[_0x48b7cb(0x144)]()});const _0x193a2c={'status':_0x4451c1['status'],'updatedAt':new Date()};if(_0x4451c1[_0x48b7cb(0x161)]===_0x48b7cb(0xe5)&&_0x145c2e[_0x48b7cb(0x161)]!==_0x48b7cb(0xe5)){_0x193a2c[_0x48b7cb(0xe8)]=new Date();if(!_0x145c2e['amountUSDT']){const _0x299242=await currencyService_1['currencyService'][_0x48b7cb(0x127)](_0x145c2e['amount'],_0x145c2e[_0x48b7cb(0xf4)]);_0x193a2c['amountUSDT']=_0x299242;const _0x4a1d31=await this[_0x48b7cb(0x17a)](_0x145c2e[_0x48b7cb(0x107)],_0x145c2e[_0x48b7cb(0x164)]),_0x11577b=_0x299242*(0x1-_0x4a1d31/0x64);_0x193a2c[_0x48b7cb(0x188)]=_0x11577b,console[_0x48b7cb(0x16a)]('💰\x20[CHECK]\x20Payment\x20'+_0x145c2e['id']+_0x48b7cb(0xc0)),console['log']('\x20\x20\x20Amount:\x20'+_0x145c2e['amount']+'\x20'+_0x145c2e[_0x48b7cb(0xf4)]+'\x20->\x20'+_0x299242[_0x48b7cb(0x19a)](0x6)+_0x48b7cb(0xd4)),console[_0x48b7cb(0x16a)](_0x48b7cb(0xdd)+_0x145c2e[_0x48b7cb(0x164)]+_0x48b7cb(0x106)+_0x4a1d31+'%'),console[_0x48b7cb(0x16a)](_0x48b7cb(0x139)+_0x11577b[_0x48b7cb(0x19a)](0x6)+'\x20USDT');}console[_0x48b7cb(0x16a)](_0x48b7cb(0x14c)+_0x145c2e['id']+_0x48b7cb(0xbb)+_0x193a2c[_0x48b7cb(0xe8)]['toISOString']());}if(_0x4451c1[_0x48b7cb(0x18c)]){const _0x46deb1=_0x4451c1[_0x48b7cb(0x18c)];_0x46deb1[_0x48b7cb(0x19d)]&&(_0x193a2c[_0x48b7cb(0x11d)]=_0x46deb1[_0x48b7cb(0x19d)],console[_0x48b7cb(0x16a)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x46deb1['iban']));if(_0x46deb1[_0x48b7cb(0x153)]){const _0x42c3eb=_0x145c2e[_0x48b7cb(0x177)]||'',_0xe8d299=_0x48b7cb(0xc4)+_0x46deb1[_0x48b7cb(0x153)];_0x193a2c['adminNotes']=_0x42c3eb?_0x42c3eb+'\x0a\x0a'+_0xe8d299:_0xe8d299,console[_0x48b7cb(0x16a)](_0x48b7cb(0x123));}_0x46deb1['transactionId']&&console[_0x48b7cb(0x16a)](_0x48b7cb(0xa6)+_0x46deb1[_0x48b7cb(0xba)]),_0x46deb1['confirmedOn']&&console[_0x48b7cb(0x16a)]('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x46deb1['confirmedOn']);}await database_1['default']['payment'][_0x48b7cb(0x149)]({'where':{'id':_0x145c2e['id']},'data':_0x193a2c});if(_0x4451c1[_0x48b7cb(0x161)]===_0x48b7cb(0xe5)&&_0x145c2e[_0x48b7cb(0x161)]!==_0x48b7cb(0xe5)){console['log']('📈\x20[COINTOPAY]\x20Payment\x20'+_0x145c2e['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x439682=await database_1[_0x48b7cb(0xa1)][_0x48b7cb(0xae)][_0x48b7cb(0x18d)]({'where':{'id':_0x145c2e['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x439682?.['paymentLinkId']&&_0x439682['paymentLink'])try{const _0x3a10d2=_0x439682[_0x48b7cb(0xa5)];console['log'](_0x48b7cb(0x145)+_0x3a10d2['id']+_0x48b7cb(0x137)+_0x3a10d2['type']+_0x48b7cb(0x199)+_0x3a10d2[_0x48b7cb(0x112)]+_0x48b7cb(0x187)+_0x3a10d2[_0x48b7cb(0x161)]);const _0x34aa5f=_0x3a10d2['currentPayments']+0x1,_0x40d968=_0x3a10d2[_0x48b7cb(0x148)]===_0x48b7cb(0x9e)?_0x48b7cb(0x10d):_0x3a10d2['status'];await database_1['default'][_0x48b7cb(0xa5)][_0x48b7cb(0x149)]({'where':{'id':_0x3a10d2['id']},'data':{'currentPayments':_0x34aa5f,'status':_0x40d968,'updatedAt':new Date()}}),console[_0x48b7cb(0x16a)](_0x48b7cb(0x12a)+_0x3a10d2['id']+_0x48b7cb(0x131)+_0x3a10d2[_0x48b7cb(0x112)]+'\x20->\x20'+_0x34aa5f+_0x48b7cb(0x187)+_0x3a10d2['status']+_0x48b7cb(0x16e)+_0x40d968);}catch(_0x3eb228){console[_0x48b7cb(0x165)](_0x48b7cb(0x14b),_0x3eb228);}else console[_0x48b7cb(0x16a)](_0x48b7cb(0xbe)+_0x145c2e['id']+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}await database_1[_0x48b7cb(0xa1)]['webhookLog'][_0x48b7cb(0xcf)]({'data':{'paymentId':_0x145c2e['id'],'shopId':_0x145c2e[_0x48b7cb(0x107)],'event':_0x48b7cb(0x124)+_0x4451c1['status'][_0x48b7cb(0x119)](),'statusCode':0xc8,'responseBody':JSON[_0x48b7cb(0xed)]({'oldStatus':_0x145c2e[_0x48b7cb(0x161)],'newStatus':_0x4451c1['status'],'paymentDetails':_0x4451c1[_0x48b7cb(0x18c)],'checkedAt':new Date()[_0x48b7cb(0x144)]()})}}),await this[_0x48b7cb(0xef)](_0x145c2e,_0x4451c1[_0x48b7cb(0x161)]),await this[_0x48b7cb(0xe7)](_0x145c2e,_0x4451c1[_0x48b7cb(0x161)]),_0x4451c1[_0x48b7cb(0x161)]!==_0x48b7cb(0xa4)&&(console[_0x48b7cb(0x16a)](_0x48b7cb(0xf7)+_0x145c2e['id']+_0x48b7cb(0xce)+_0x4451c1[_0x48b7cb(0x161)]+_0x48b7cb(0x138)),this[_0x48b7cb(0x108)](_0x145c2e['id'])),console[_0x48b7cb(0x16a)]('✅\x20[CHECK]\x20Payment\x20'+_0x145c2e['id']+_0x48b7cb(0x18b));}else console['log'](_0x48b7cb(0x15a)+_0x145c2e['id']+'\x20status\x20unchanged\x20('+_0x4451c1['status']+')'),this[_0x48b7cb(0x130)](_0x145c2e['id'],_0x145c2e[_0x48b7cb(0xdf)],_0x145c2e['status'],_0x4451c1[_0x48b7cb(0x161)],_0x48b7cb(0x19b),{'statusUnchanged':!![],'paymentDetails':_0x4451c1[_0x48b7cb(0x18c)],'amount':_0x4451c1[_0x48b7cb(0xd7)],'currency':_0x4451c1[_0x48b7cb(0xf4)],'shopId':_0x145c2e[_0x48b7cb(0x107)],'checkTimestamp':new Date()[_0x48b7cb(0x144)]()});}catch(_0x57f144){console[_0x48b7cb(0x165)](_0x48b7cb(0x14a)+_0x145c2e['id']+':',_0x57f144),this[_0x48b7cb(0x173)](_0x145c2e['id'],_0x145c2e[_0x48b7cb(0xdf)],_0x57f144,_0x48b7cb(0x19b),{'paymentAmount':_0x145c2e['amount'],'paymentCurrency':_0x145c2e['currency'],'shopId':_0x145c2e[_0x48b7cb(0x107)],'createdAt':_0x145c2e[_0x48b7cb(0xa9)]}),await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0x145c2e['id'],'shopId':_0x145c2e[_0x48b7cb(0x107)],'event':_0x48b7cb(0x10c),'statusCode':0x1f4,'responseBody':JSON[_0x48b7cb(0xed)]({'error':_0x57f144 instanceof Error?_0x57f144[_0x48b7cb(0xf2)]:_0x48b7cb(0xe4),'gatewayPaymentId':_0x145c2e[_0x48b7cb(0xdf)],'checkedAt':new Date()[_0x48b7cb(0x144)]()})}});}}async[a38_0x4c308a(0xef)](_0x35adc7,_0x11168){const _0x2053a6=a38_0x4c308a,_0x3ed496=Date[_0x2053a6(0x143)]();try{const _0x377c07=_0x35adc7[_0x2053a6(0x19c)],_0x54ee66=_0x377c07[_0x2053a6(0x117)];if(!_0x54ee66?.[_0x2053a6(0x17b)]){console[_0x2053a6(0x16a)](_0x2053a6(0x142)+_0x377c07['id']);return;}const _0x2fd443=_0x11168===_0x2053a6(0xe5)?'payment.success':_0x11168===_0x2053a6(0x140)?'payment.failed':_0x11168===_0x2053a6(0x1a0)?_0x2053a6(0x11f):_0x2053a6(0x113);if(!_0x54ee66['webhookEvents']?.[_0x2053a6(0x150)](_0x2fd443)){console['log'](_0x2053a6(0x121)+_0x2fd443+_0x2053a6(0xac)+_0x377c07['id']);return;}const _0x4325b7=(0x0,gateway_1[_0x2053a6(0xd5)])(_0x35adc7[_0x2053a6(0x164)])||_0x35adc7['gateway'],_0x39dc3e={'event':_0x2fd443,'payment':{'id':_0x35adc7['id'],'order_id':_0x35adc7['orderId'],'gateway_order_id':_0x35adc7[_0x2053a6(0x15b)],'gateway':_0x4325b7,'amount':_0x35adc7[_0x2053a6(0xd7)],'currency':_0x35adc7[_0x2053a6(0xf4)],'status':_0x11168[_0x2053a6(0x119)](),'customer_email':_0x35adc7[_0x2053a6(0xb1)],'customer_name':_0x35adc7[_0x2053a6(0x16f)],'created_at':_0x35adc7[_0x2053a6(0xa9)],'updated_at':new Date()}},_0x53a95e=await fetch(_0x54ee66['webhookUrl'],{'method':_0x2053a6(0x162),'headers':{'Content-Type':_0x2053a6(0x105),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON['stringify'](_0x39dc3e)}),_0x4b79c6=Date[_0x2053a6(0x143)]()-_0x3ed496,_0x4b1de3=_0x53a95e['ok']?_0x2053a6(0x180):await _0x53a95e[_0x2053a6(0x15d)]();loggerService_1[_0x2053a6(0x13a)][_0x2053a6(0xfe)](_0x35adc7[_0x2053a6(0x107)],_0x54ee66[_0x2053a6(0x17b)],_0x2fd443,_0x53a95e[_0x2053a6(0x161)],_0x4b79c6,_0x39dc3e),console[_0x2053a6(0x16a)](_0x2053a6(0x12c)+_0x54ee66[_0x2053a6(0x17b)]+_0x2053a6(0xe0)+_0x53a95e[_0x2053a6(0x161)]+'\x20('+_0x4b79c6+_0x2053a6(0x184));}catch(_0x4a1241){console[_0x2053a6(0x165)](_0x2053a6(0x190),_0x4a1241),loggerService_1[_0x2053a6(0x13a)][_0x2053a6(0x16b)](_0x35adc7[_0x2053a6(0x107)],_0x35adc7[_0x2053a6(0x19c)]?.[_0x2053a6(0x117)]?.['webhookUrl']||_0x2053a6(0x1aa),_0x2053a6(0x15e),_0x4a1241,{});}}async[a38_0x4c308a(0xe7)](_0x11e372,_0x260dfd){const _0x3bcd6f=a38_0x4c308a;try{const _0x2183c5={'PENDING':_0x3bcd6f(0x111),'PAID':_0x3bcd6f(0xb5),'FAILED':_0x3bcd6f(0xf1),'EXPIRED':_0x3bcd6f(0x133)},_0x31948d=_0x2183c5[_0x260dfd];if(!_0x31948d||_0x31948d==='created')return;await telegramBotService_1[_0x3bcd6f(0xe2)][_0x3bcd6f(0x103)](_0x11e372['shopId'],_0x11e372,_0x31948d);}catch(_0x51efae){console[_0x3bcd6f(0x165)](_0x3bcd6f(0xcd),_0x51efae);}}async['checkPaymentById'](_0x1dcf6b){const _0x40fc30=a38_0x4c308a;console[_0x40fc30(0x16a)](_0x40fc30(0xe1)+_0x1dcf6b);const _0x6821b4=await database_1['default'][_0x40fc30(0xae)][_0x40fc30(0x18d)]({'where':{'id':_0x1dcf6b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x6821b4)throw new Error(_0x40fc30(0xfc));if(_0x6821b4[_0x40fc30(0x164)]!=='cointopay'&&_0x6821b4[_0x40fc30(0x164)]!==_0x40fc30(0x135))throw new Error(_0x40fc30(0xa8));console[_0x40fc30(0x16a)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20'+_0x6821b4[_0x40fc30(0x164)]+_0x40fc30(0xc8)+_0x1dcf6b),await this[_0x40fc30(0x118)](_0x6821b4),console[_0x40fc30(0x16a)](_0x40fc30(0x181)+_0x1dcf6b);}[a38_0x4c308a(0xeb)](){const _0x54bbed=a38_0x4c308a,_0x2e5b35=this[_0x54bbed(0xa7)]?this[_0x54bbed(0x11a)]:undefined,_0xb25706=Array['from'](this['paymentTimers'][_0x54bbed(0x151)]())[_0x54bbed(0x1a4)](_0x575d25=>({'paymentId':_0x575d25[_0x54bbed(0x197)],'gatewayPaymentId':_0x575d25[_0x54bbed(0xdf)],'createdAt':_0x575d25['createdAt'],'timersCount':_0x575d25['timers'][_0x54bbed(0xec)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x54bbed(0x13b)],'activeIndividualTimers':this[_0x54bbed(0x12d)][_0x54bbed(0x141)],'nextGlobalCheckIn':_0x2e5b35,'paymentTimersDetails':_0xb25706};}['getPaymentTimerInfo'](_0x48838e){const _0x1c787f=a38_0x4c308a,_0x4dd41e=this['paymentTimers'][_0x1c787f(0x120)](_0x48838e);if(_0x4dd41e)return{'hasTimers':!![],'timersCount':_0x4dd41e[_0x1c787f(0x17c)]['length'],'createdAt':_0x4dd41e[_0x1c787f(0xa9)],'gatewayPaymentId':_0x4dd41e[_0x1c787f(0xdf)]};return{'hasTimers':![]};}async[a38_0x4c308a(0x17a)](_0x20e53b,_0x28416a){const _0x4b513f=a38_0x4c308a;try{const _0x41d664=await database_1[_0x4b513f(0xa1)][_0x4b513f(0x19c)]['findUnique']({'where':{'id':_0x20e53b},'select':{'gatewaySettings':!![]}});if(!_0x41d664?.[_0x4b513f(0x152)])return console[_0x4b513f(0x16a)](_0x4b513f(0x176)+_0x20e53b+_0x4b513f(0x169)),0xa;const _0x1da739=JSON[_0x4b513f(0x109)](_0x41d664[_0x4b513f(0x152)]);for(const [_0x31ec6a,_0x5b41cc]of Object[_0x4b513f(0x158)](_0x1da739)){if(_0x31ec6a[_0x4b513f(0x119)]()===_0x28416a['toLowerCase']()){const _0x4e5546=_0x5b41cc[_0x4b513f(0xfa)]||0xa;return console[_0x4b513f(0x16a)](_0x4b513f(0x14e)+_0x28416a+_0x4b513f(0x146)+_0x20e53b+':\x20'+_0x4e5546+'%'),_0x4e5546;}}return console[_0x4b513f(0x16a)](_0x4b513f(0x189)+_0x28416a+_0x4b513f(0x19f)+_0x20e53b+_0x4b513f(0x154)),0xa;}catch(_0x45e9ac){return console[_0x4b513f(0x165)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x20e53b+',\x20gateway\x20'+_0x28416a+':',_0x45e9ac),0xa;}}}exports[a38_0x4c308a(0x116)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();