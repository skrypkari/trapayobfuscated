'use strict';const a35_0x5f4101=a35_0x3e81;(function(_0x43e0c1,_0x406d11){const _0x419574=a35_0x3e81,_0x16cc10=_0x43e0c1();while(!![]){try{const _0x14e1f7=-parseInt(_0x419574(0x214))/0x1+parseInt(_0x419574(0x223))/0x2*(parseInt(_0x419574(0x211))/0x3)+-parseInt(_0x419574(0x229))/0x4*(-parseInt(_0x419574(0x215))/0x5)+-parseInt(_0x419574(0x22b))/0x6*(parseInt(_0x419574(0x21b))/0x7)+parseInt(_0x419574(0x244))/0x8+parseInt(_0x419574(0x1de))/0x9+-parseInt(_0x419574(0x226))/0xa*(parseInt(_0x419574(0x232))/0xb);if(_0x14e1f7===_0x406d11)break;else _0x16cc10['push'](_0x16cc10['shift']());}catch(_0x114047){_0x16cc10['push'](_0x16cc10['shift']());}}}(a35_0x2c69,0x354be));var __importDefault=this&&this[a35_0x5f4101(0x239)]||function(_0x55e3a7){return _0x55e3a7&&_0x55e3a7['__esModule']?_0x55e3a7:{'default':_0x55e3a7};};function a35_0x3e81(_0x18c303,_0x544c61){const _0x2c6982=a35_0x2c69();return a35_0x3e81=function(_0x3e81c8,_0x11aaeb){_0x3e81c8=_0x3e81c8-0x1d2;let _0xbb0489=_0x2c6982[_0x3e81c8];return _0xbb0489;},a35_0x3e81(_0x18c303,_0x544c61);}Object[a35_0x5f4101(0x24b)](exports,a35_0x5f4101(0x1fd),{'value':!![]}),exports[a35_0x5f4101(0x24e)]=exports['CoinToPayStatusService']=void 0x0;function a35_0x2c69(){const _0x3908e7=['findMany','toISOString','\x20pending\x20CoinToPay\x20payments','gatewayPaymentId','üîç\x20Checking\x20CoinToPay\x20payment\x20','\x20status\x20unchanged\x20(','0100','\x20with\x20status\x20','./gateways/coinToPayService','createdOn','checkInterval','ü™ô\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','‚úÖ\x20Completed\x20checking\x20','shopId','text','üìä\x20Payment\x20','paymentDetails','POST','ü™ô\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','\x20updated\x20successfully','payment','\x20days,\x20marking\x20as\x20EXPIRED','findUnique','../config/database','transactionId','__esModule','\x20days\x20without\x20payment\x20confirmation','Payment\x20older\x20than\x20','Webhook\x20event\x20','Periodic\x20CoinToPay\x20status\x20check\x20failed:','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','unknown','not\x20found','length','message','\x20days','\x20to\x20','error','\x20status\x20from\x20','PAID','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','remitterIban','\x20expired\x20CoinToPay\x20payments','logShopWebhookError','create','336921NVaFYH','‚úÖ\x20Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','340092QnJFHY','5kQylxS','Automatically\x20expired\x20after\x20','ms)','toLowerCase','\x20status:\x20','CoinToPayService','7lwxHba','log','Failed\x20to\x20check\x20payment\x20','‚úÖ\x20Transaction\x20confirmed\x20on:\x20','\x20CoinToPay\x20payments','bankDetails','EXPIRY_DAYS','adminNotes','4KmEkvD','webhookUrl','\x20days\x20(created\x20before\x20','20ouYepA','createdAt','‚è∞\x20Payment\x20','996932gejYkn','sendPaymentNotification','1587864PaPggz','default','shop','üí∞\x20Payment\x20','cointopay_auto_expired','checkPaymentById','Payment\x20not\x20found','1338854HzzbUg','‚è∞\x20Found\x20','confirmedOn','gatewayOrderId','TesSoft\x20Payment\x20System/1.0','PENDING','Failed\x20to\x20send\x20shop\x20webhook:','__importDefault','webhookEvents','floor','not\x20confirmed','loggerService','‚úÖ\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','sendShopWebhook','coinToPayService','update','checkAllPendingPayments','sendPaymentStatusNotification','2470896RzjZzh','paidAt','Unknown\x20error','CHECK_INTERVAL_MS','-day\x20timeout','Shop\x20webhook\x20sent\x20to\x20','getServiceStats','defineProperty','now','includes','coinToPayStatusService','EXPIRED','./telegramBotService','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','payment.failed','iban','status','\x20not\x20enabled\x20for\x20shop\x20','created','settings','ü™ô\x20Checking\x20','üè¶\x20Saved\x20IBAN:\x20','CoinToPayStatusService','application/json','getDate','cointopay_status_check_error','üîÑ\x20Updating\x20payment\x20','FAILED','cointopay','/status/','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20marked\x20as\x20paid\x20at:\x20','catch','webhookLog','\x20is\x20older\x20than\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','getTime','checkSinglePayment','startPeriodicStatusCheck','customerName','stringify','2553813fswDCj','Initial\x20CoinToPay\x20status\x20check\x20failed:','cointopay_status_check_','checkPaymentStatus','Failed\x20to\x20expire\x20payment\x20','Success'];a35_0x2c69=function(){return _0x3908e7;};return a35_0x2c69();}const coinToPayService_1=require(a35_0x5f4101(0x1ec)),database_1=__importDefault(require(a35_0x5f4101(0x1fb))),telegramBotService_1=require(a35_0x5f4101(0x250)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x28630d=a35_0x5f4101;this[_0x28630d(0x1ee)]=null,this[_0x28630d(0x247)]=0x3c*0x3c*0x3e8,this[_0x28630d(0x221)]=0x5,this[_0x28630d(0x240)]=new coinToPayService_1[(_0x28630d(0x21a))]();}[a35_0x5f4101(0x1db)](){const _0x3943f2=a35_0x5f4101;console[_0x3943f2(0x21c)](_0x3943f2(0x1f6)),this['checkAllPendingPayments']()[_0x3943f2(0x1d5)](_0x3c6ff6=>{const _0x1550b8=_0x3943f2;console['error'](_0x1550b8(0x1df),_0x3c6ff6);}),this[_0x3943f2(0x1ee)]=setInterval(async()=>{const _0x391bb1=_0x3943f2;try{await this[_0x391bb1(0x242)]();}catch(_0x633889){console['error'](_0x391bb1(0x201),_0x633889);}},this[_0x3943f2(0x247)]),console[_0x3943f2(0x21c)](_0x3943f2(0x23e));}['stopPeriodicStatusCheck'](){const _0x11b9d9=a35_0x5f4101;this[_0x11b9d9(0x1ee)]&&(clearInterval(this[_0x11b9d9(0x1ee)]),this[_0x11b9d9(0x1ee)]=null,console[_0x11b9d9(0x21c)]('üõë\x20CoinToPay\x20status\x20checking\x20stopped'));}async[a35_0x5f4101(0x242)](){const _0x340e95=a35_0x5f4101;try{const _0x90ed5f=await database_1['default'][_0x340e95(0x1f8)][_0x340e95(0x1e4)]({'where':{'gateway':_0x340e95(0x260),'status':_0x340e95(0x237),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x90ed5f[_0x340e95(0x205)]===0x0){console['log'](_0x340e95(0x1ef));return;}console[_0x340e95(0x21c)](_0x340e95(0x258)+_0x90ed5f[_0x340e95(0x205)]+_0x340e95(0x1e6));const _0x241b15=await this['checkExpiredPayments'](_0x90ed5f);console[_0x340e95(0x21c)](_0x340e95(0x233)+_0x241b15[_0x340e95(0x205)]+_0x340e95(0x20e));for(const _0x1ac52f of _0x90ed5f){try{if(_0x241b15[_0x340e95(0x24d)](_0x1ac52f['id'])){console[_0x340e95(0x21c)](_0x340e95(0x228)+_0x1ac52f['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check');continue;}await this['checkSinglePayment'](_0x1ac52f),await new Promise(_0x27699b=>setTimeout(_0x27699b,0x7d0));}catch(_0x2c8dbf){console[_0x340e95(0x209)](_0x340e95(0x1d3)+_0x1ac52f['id']+':',_0x2c8dbf),loggerService_1[_0x340e95(0x23d)]['logWhiteDomainError']('cointopay',_0x340e95(0x1d2)+_0x1ac52f[_0x340e95(0x1e7)],_0x2c8dbf);}}console[_0x340e95(0x21c)](_0x340e95(0x1f0)+_0x90ed5f[_0x340e95(0x205)]+_0x340e95(0x21f));}catch(_0x401ba7){console['error'](_0x340e95(0x251),_0x401ba7);}}async['checkExpiredPayments'](_0x1d7b50){const _0x9c7649=a35_0x5f4101,_0x439649=[],_0x2b4592=new Date();_0x2b4592['setDate'](_0x2b4592[_0x9c7649(0x25c)]()-this[_0x9c7649(0x221)]),console['log']('‚è∞\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x9c7649(0x225)+_0x2b4592[_0x9c7649(0x1e5)]()+')');for(const _0x47b93e of _0x1d7b50){if(_0x47b93e[_0x9c7649(0x227)]<_0x2b4592){console[_0x9c7649(0x21c)](_0x9c7649(0x228)+_0x47b93e['id']+_0x9c7649(0x1d7)+this['EXPIRY_DAYS']+_0x9c7649(0x1f9));try{await database_1[_0x9c7649(0x22c)][_0x9c7649(0x1f8)][_0x9c7649(0x241)]({'where':{'id':_0x47b93e['id']},'data':{'status':_0x9c7649(0x24f),'updatedAt':new Date(),'adminNotes':_0x9c7649(0x216)+this['EXPIRY_DAYS']+_0x9c7649(0x1fe)}}),await database_1[_0x9c7649(0x22c)][_0x9c7649(0x1d6)][_0x9c7649(0x210)]({'data':{'paymentId':_0x47b93e['id'],'shopId':_0x47b93e['shopId'],'event':_0x9c7649(0x22f),'statusCode':0xc8,'responseBody':JSON[_0x9c7649(0x1dd)]({'reason':_0x9c7649(0x1ff)+this[_0x9c7649(0x221)]+_0x9c7649(0x207),'createdAt':_0x47b93e[_0x9c7649(0x227)],'expiredAt':new Date()[_0x9c7649(0x1e5)](),'daysSinceCreation':Math[_0x9c7649(0x23b)]((Date[_0x9c7649(0x24c)]()-_0x47b93e[_0x9c7649(0x227)][_0x9c7649(0x1d9)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x9c7649(0x23f)](_0x47b93e,_0x9c7649(0x24f)),await this[_0x9c7649(0x243)](_0x47b93e,'EXPIRED'),_0x439649['push'](_0x47b93e['id']),console['log'](_0x9c7649(0x212)+_0x47b93e['id']+_0x9c7649(0x20c)+this['EXPIRY_DAYS']+_0x9c7649(0x248));}catch(_0x10e221){console['error'](_0x9c7649(0x1e2)+_0x47b93e['id']+':',_0x10e221);}}}return _0x439649;}async[a35_0x5f4101(0x1da)](_0x223199){const _0x4fd43b=a35_0x5f4101;if(!_0x223199['gatewayPaymentId']){console[_0x4fd43b(0x21c)]('‚ö†Ô∏è\x20Payment\x20'+_0x223199['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console['log'](_0x4fd43b(0x1e8)+_0x223199['id']+'\x20('+_0x223199[_0x4fd43b(0x1e7)]+')');try{const _0x35d692=await this[_0x4fd43b(0x240)][_0x4fd43b(0x1e1)](_0x223199[_0x4fd43b(0x1e7)]);console[_0x4fd43b(0x21c)](_0x4fd43b(0x1f3)+_0x223199['id']+_0x4fd43b(0x219)+_0x35d692[_0x4fd43b(0x254)]);_0x35d692[_0x4fd43b(0x1f4)]&&console[_0x4fd43b(0x21c)](_0x4fd43b(0x1f3)+_0x223199['id']+'\x20details:',{'iban':_0x35d692[_0x4fd43b(0x1f4)][_0x4fd43b(0x253)]||_0x4fd43b(0x204),'transactionId':_0x35d692[_0x4fd43b(0x1f4)][_0x4fd43b(0x1fc)],'createdOn':_0x35d692['paymentDetails'][_0x4fd43b(0x1ed)],'confirmedOn':_0x35d692[_0x4fd43b(0x1f4)][_0x4fd43b(0x234)]||_0x4fd43b(0x23c)});if(_0x35d692['status']!==_0x223199['status']){console[_0x4fd43b(0x21c)](_0x4fd43b(0x25e)+_0x223199['id']+_0x4fd43b(0x20a)+_0x223199[_0x4fd43b(0x254)]+_0x4fd43b(0x208)+_0x35d692[_0x4fd43b(0x254)]);const _0x201d36={'status':_0x35d692[_0x4fd43b(0x254)],'updatedAt':new Date()};_0x35d692[_0x4fd43b(0x254)]===_0x4fd43b(0x20b)&&_0x223199[_0x4fd43b(0x254)]!==_0x4fd43b(0x20b)&&(_0x201d36[_0x4fd43b(0x245)]=new Date(),console[_0x4fd43b(0x21c)](_0x4fd43b(0x22e)+_0x223199['id']+_0x4fd43b(0x1d4)+_0x201d36[_0x4fd43b(0x245)]['toISOString']()));if(_0x35d692[_0x4fd43b(0x1f4)]){const _0x1588fc=_0x35d692[_0x4fd43b(0x1f4)];_0x1588fc[_0x4fd43b(0x253)]&&(_0x201d36[_0x4fd43b(0x20d)]=_0x1588fc[_0x4fd43b(0x253)],console[_0x4fd43b(0x21c)](_0x4fd43b(0x259)+_0x1588fc[_0x4fd43b(0x253)]));if(_0x1588fc[_0x4fd43b(0x220)]){const _0x34f039=_0x223199[_0x4fd43b(0x222)]||'',_0x2ae0f8='Bank\x20Details:\x20'+_0x1588fc[_0x4fd43b(0x220)];_0x201d36[_0x4fd43b(0x222)]=_0x34f039?_0x34f039+'\x0a\x0a'+_0x2ae0f8:_0x2ae0f8,console['log']('üè¶\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x1588fc[_0x4fd43b(0x1fc)]&&console['log']('üÜî\x20Transaction\x20ID:\x20'+_0x1588fc[_0x4fd43b(0x1fc)]),_0x1588fc[_0x4fd43b(0x234)]&&console[_0x4fd43b(0x21c)](_0x4fd43b(0x21e)+_0x1588fc['confirmedOn']);}await database_1[_0x4fd43b(0x22c)]['payment'][_0x4fd43b(0x241)]({'where':{'id':_0x223199['id']},'data':_0x201d36}),await database_1[_0x4fd43b(0x22c)][_0x4fd43b(0x1d6)]['create']({'data':{'paymentId':_0x223199['id'],'shopId':_0x223199[_0x4fd43b(0x1f1)],'event':_0x4fd43b(0x1e0)+_0x35d692[_0x4fd43b(0x254)][_0x4fd43b(0x218)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x223199[_0x4fd43b(0x254)],'newStatus':_0x35d692['status'],'paymentDetails':_0x35d692[_0x4fd43b(0x1f4)],'checkedAt':new Date()[_0x4fd43b(0x1e5)]()})}}),await this[_0x4fd43b(0x23f)](_0x223199,_0x35d692[_0x4fd43b(0x254)]),await this[_0x4fd43b(0x243)](_0x223199,_0x35d692[_0x4fd43b(0x254)]),console['log']('‚úÖ\x20Payment\x20'+_0x223199['id']+_0x4fd43b(0x1f7));}else console['log'](_0x4fd43b(0x1f3)+_0x223199['id']+_0x4fd43b(0x1e9)+_0x35d692[_0x4fd43b(0x254)]+')');}catch(_0x172bc7){console[_0x4fd43b(0x209)](_0x4fd43b(0x21d)+_0x223199['id']+':',_0x172bc7),await database_1[_0x4fd43b(0x22c)][_0x4fd43b(0x1d6)][_0x4fd43b(0x210)]({'data':{'paymentId':_0x223199['id'],'shopId':_0x223199[_0x4fd43b(0x1f1)],'event':_0x4fd43b(0x25d),'statusCode':0x1f4,'responseBody':JSON[_0x4fd43b(0x1dd)]({'error':_0x172bc7 instanceof Error?_0x172bc7[_0x4fd43b(0x206)]:_0x4fd43b(0x246),'gatewayPaymentId':_0x223199[_0x4fd43b(0x1e7)],'checkedAt':new Date()[_0x4fd43b(0x1e5)]()})}});}}async[a35_0x5f4101(0x23f)](_0x5ab8a3,_0x2bda55){const _0x3078d7=a35_0x5f4101,_0x5d992a=Date[_0x3078d7(0x24c)]();try{const _0x34a5cc=_0x5ab8a3[_0x3078d7(0x22d)],_0x1eaad8=_0x34a5cc[_0x3078d7(0x257)];if(!_0x1eaad8?.[_0x3078d7(0x224)]){console[_0x3078d7(0x21c)](_0x3078d7(0x1d8)+_0x34a5cc['id']);return;}const _0x301637=_0x2bda55===_0x3078d7(0x20b)?'payment.success':_0x2bda55===_0x3078d7(0x25f)?_0x3078d7(0x252):_0x2bda55==='EXPIRED'?_0x3078d7(0x252):'payment.pending';if(!_0x1eaad8[_0x3078d7(0x23a)]?.['includes'](_0x301637)){console[_0x3078d7(0x21c)](_0x3078d7(0x200)+_0x301637+_0x3078d7(0x255)+_0x34a5cc['id']);return;}const _0x165aa3={'event':_0x301637,'payment':{'id':_0x5ab8a3['id'],'order_id':_0x5ab8a3['orderId'],'gateway_order_id':_0x5ab8a3[_0x3078d7(0x235)],'gateway':_0x3078d7(0x1ea),'amount':_0x5ab8a3['amount'],'currency':_0x5ab8a3['currency'],'status':_0x2bda55[_0x3078d7(0x218)](),'customer_email':_0x5ab8a3['customerEmail'],'customer_name':_0x5ab8a3[_0x3078d7(0x1dc)],'created_at':_0x5ab8a3[_0x3078d7(0x227)],'updated_at':new Date()}},_0x5a95e9=await fetch(_0x1eaad8[_0x3078d7(0x224)],{'method':_0x3078d7(0x1f5),'headers':{'Content-Type':_0x3078d7(0x25b),'User-Agent':_0x3078d7(0x236)},'body':JSON['stringify'](_0x165aa3)}),_0x489a9f=Date[_0x3078d7(0x24c)]()-_0x5d992a,_0x62d0fc=_0x5a95e9['ok']?_0x3078d7(0x1e3):await _0x5a95e9[_0x3078d7(0x1f2)]();loggerService_1['loggerService']['logShopWebhookSent'](_0x5ab8a3[_0x3078d7(0x1f1)],_0x1eaad8[_0x3078d7(0x224)],_0x301637,_0x5a95e9[_0x3078d7(0x254)],_0x489a9f,_0x165aa3),console[_0x3078d7(0x21c)](_0x3078d7(0x249)+_0x1eaad8[_0x3078d7(0x224)]+_0x3078d7(0x1eb)+_0x5a95e9[_0x3078d7(0x254)]+'\x20('+_0x489a9f+_0x3078d7(0x217));}catch(_0x560207){console[_0x3078d7(0x209)](_0x3078d7(0x238),_0x560207),loggerService_1[_0x3078d7(0x23d)][_0x3078d7(0x20f)](_0x5ab8a3['shopId'],_0x5ab8a3[_0x3078d7(0x22d)]?.[_0x3078d7(0x257)]?.[_0x3078d7(0x224)]||_0x3078d7(0x203),'webhook_send',_0x560207,{});}}async[a35_0x5f4101(0x243)](_0x241c2c,_0x34a76f){const _0x475efb=a35_0x5f4101;try{const _0x8c2834={'PENDING':_0x475efb(0x256),'PAID':'paid','FAILED':'failed','EXPIRED':'expired'},_0x1b2472=_0x8c2834[_0x34a76f];if(!_0x1b2472||_0x1b2472===_0x475efb(0x256))return;await telegramBotService_1['telegramBotService'][_0x475efb(0x22a)](_0x241c2c[_0x475efb(0x1f1)],_0x241c2c,_0x1b2472);}catch(_0x40486c){console[_0x475efb(0x209)](_0x475efb(0x213),_0x40486c);}}async[a35_0x5f4101(0x230)](_0x134cec){const _0x3b76e0=a35_0x5f4101,_0x52d3a4=await database_1[_0x3b76e0(0x22c)]['payment'][_0x3b76e0(0x1fa)]({'where':{'id':_0x134cec},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x52d3a4)throw new Error(_0x3b76e0(0x231));if(_0x52d3a4['gateway']!==_0x3b76e0(0x260))throw new Error(_0x3b76e0(0x202));await this[_0x3b76e0(0x1da)](_0x52d3a4);}[a35_0x5f4101(0x24a)](){const _0x4f54f2=a35_0x5f4101,_0x2bb253=this[_0x4f54f2(0x1ee)]?this['CHECK_INTERVAL_MS']:undefined;return{'isActive':!!this['checkInterval'],'checkIntervalMinutes':this[_0x4f54f2(0x247)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'nextCheckIn':_0x2bb253};}}exports[a35_0x5f4101(0x25a)]=CoinToPayStatusService,exports[a35_0x5f4101(0x24e)]=new CoinToPayStatusService();