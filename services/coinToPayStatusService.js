'use strict';const a37_0x492f2c=a37_0x1da3;(function(_0x2e5abc,_0x8649df){const _0x17dc72=a37_0x1da3,_0xa33427=_0x2e5abc();while(!![]){try{const _0x143907=parseInt(_0x17dc72(0x186))/0x1*(parseInt(_0x17dc72(0x17f))/0x2)+-parseInt(_0x17dc72(0x200))/0x3*(-parseInt(_0x17dc72(0x18a))/0x4)+-parseInt(_0x17dc72(0x23c))/0x5*(-parseInt(_0x17dc72(0x232))/0x6)+parseInt(_0x17dc72(0x165))/0x7+-parseInt(_0x17dc72(0x21e))/0x8*(parseInt(_0x17dc72(0x1d8))/0x9)+-parseInt(_0x17dc72(0x16e))/0xa+-parseInt(_0x17dc72(0x226))/0xb;if(_0x143907===_0x8649df)break;else _0xa33427['push'](_0xa33427['shift']());}catch(_0x2335f1){_0xa33427['push'](_0xa33427['shift']());}}}(a37_0x5aac,0x26004));function a37_0x1da3(_0x5b56cf,_0x4d3bae){const _0x5aacd5=a37_0x5aac();return a37_0x1da3=function(_0x1da31b,_0x552e13){_0x1da31b=_0x1da31b-0x15e;let _0x4f3c57=_0x5aacd5[_0x1da31b];return _0x4f3c57;},a37_0x1da3(_0x5b56cf,_0x4d3bae);}var __importDefault=this&&this[a37_0x492f2c(0x1f1)]||function(_0x5eae40){return _0x5eae40&&_0x5eae40['__esModule']?_0x5eae40:{'default':_0x5eae40};};function a37_0x5aac(){const _0x3450f7=['logWhiteDomainError','\x20->\x20','paymentDetails','settings','timers','\x20is\x20valid\x20for\x20checking,\x20proceeding...','gateway','loggerService','webhookLog','/status/','.\x20Remaining\x20active\x20timers:\x20','catch','\x20(age:\x20','push','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','log','\x20to\x20','🧹\x20[CHECK]\x20Payment\x20','webhook_send','221384dLTwva','\x20details:','\x20seconds\x20(','\x20triggered\x20for\x20payment\x20','logCoinToPayStatus','paidAt','./telegramBotService','defineProperty','3818848pSkgqj','\x20status\x20is\x20','\x20expired','stringify','\x20days\x20without\x20payment\x20confirmation','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','status','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','checkPaymentById','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','🛑\x20[SHUTDOWN]\x20Cleared\x20','9174JPAqzH','orderId','📊\x20[HOURLY]\x20Payment\x20','cointopay_status_check_','schedule_created','\x20days','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','toFixed','payment.failed','paymentTimers','525XepCRp','getDate','startPeriodicStatusCheck','\x20not\x20enabled\x20for\x20shop\x20','checkExpiredPayments','toLowerCase','\x20expired\x20CoinToPay\x20payments','get','checkAllPendingPayments','COINTOPAY_STATUS_CHANGE','\x20initial\x20timers\x20for\x20payment\x20','\x20days\x20(created\x20before\x20','status_check','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','paid','__esModule','sendPaymentStatusNotification','shop','2133740RtOwUd','cointopay_auto_expired','PENDING','\x20timers\x20for\x20payment\x20','iban','5\x20minutes','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','unknown','FAILED','1873450YHPuUr','\x20for\x20payment\x20','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20current\x20status:\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','../config/database',',\x20stopping\x20individual\x20checks','\x20is\x20too\x20new\x20(','\x20\x20\x20-\x20paymentId:\x20','includes','\x20skipped,\x20','createdOn','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','✅\x20[CHECK]\x20Payment\x20','checkSinglePaymentById','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','values','442DjXppI','PAID','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','payment.success','TesSoft\x20Payment\x20System/1.0','\x20individual\x20payment\x20timers','findMany','125hoynoG','\x20in\x20','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','adminNotes','20188UgUOWi','webhookEvents','created','create','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20\x20\x20📅\x20Time:\x20','\x20checked,\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','message','set','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','✅\x20[TIMER]\x20Individual\x20check\x20#','🪙\x20[GLOBAL]\x20Found\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','EXPIRED','error','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','payment','globalCheckInterval','⏰\x20[GLOBAL]\x20Payment\x20','floor',',\x20clearing\x20individual\x20timers','gatewayOrderId','paymentId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Failed\x20to\x20send\x20shop\x20webhook:','now','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','size','map','telegramBotService','remitterIban','\x20\x20\x20-\x20Amount:\x20','Success','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20\x20\x20-\x20ShopId:\x20','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','stopPeriodicStatusCheck','has','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','transactionId','length','GLOBAL_CHECK_INTERVAL_MS','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','clearPaymentTimers','\x20marked\x20as\x20paid\x20at:\x20','logShopWebhookSent','default','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','delete','getTime','currency','toISOString','logShopWebhookError','\x20\x20\x20-\x20Gateway:\x20','Bank\x20Details:\x20','getPaymentTimerInfo','📊\x20[CHECK]\x20Payment\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','sendShopWebhook','webhookUrl','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','amount','⚠️\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20Status:\x20','h),\x20skipping\x20global\x20check','💰\x20[CHECK]\x20Payment\x20','Automatically\x20expired\x20after\x20','description','expired','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','findUnique','\x20pending\x20CoinToPay\x20payments','0100','36ySrIml','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','shopId','forEach','not\x20found','\x20status\x20from\x20','update','checkSinglePayment','coinToPayStatusService','Webhook\x20event\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20\x20\x20📝\x20Details:','customerEmail','logCoinToPayError','cointopay','gatewayPaymentId','sendPaymentNotification','✅\x20[EXPIRY]\x20Payment\x20','confirmedOn','EXPIRY_DAYS','1\x20minute','createdAt','-day\x20timeout','\x20\x20\x20📍\x20Source:\x20','setDate','__importDefault','🪙\x20[DEBUG]\x20Creating\x20','stack','\x20status\x20unchanged\x20(','checkPaymentStatus','timestamp','Shop\x20webhook\x20sent\x20to\x20','Payment\x20older\x20than\x20','coinToPayService','\x20has\x20no\x20gatewayPaymentId,\x20skipping','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','from','\x20found:','POST','⏰\x20[HOURLY]\x20Payment\x20','183rEpASP','\x20is\x20older\x20than\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','2\x20minutes','\x20updated\x20successfully','🪙\x20CoinToPayStatusService\x20initialized','🧹\x20[DEBUG]\x20Clearing\x20','schedulePaymentChecks','CoinToPayStatusService'];a37_0x5aac=function(){return _0x3450f7;};return a37_0x5aac();}Object[a37_0x492f2c(0x225)](exports,a37_0x492f2c(0x162),{'value':!![]}),exports[a37_0x492f2c(0x1e0)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a37_0x492f2c(0x173))),telegramBotService_1=require(a37_0x492f2c(0x224)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x359136=a37_0x492f2c;this[_0x359136(0x19c)]=null,this[_0x359136(0x1b7)]=0x3c*0x3c*0x3e8,this[_0x359136(0x1eb)]=0x5,this['paymentTimers']=new Map(),this[_0x359136(0x1f9)]=new coinToPayService_1['CoinToPayService'](),console['log'](_0x359136(0x206));}[a37_0x492f2c(0x208)](_0xccf58e,_0xc52add){const _0x47cbfe=a37_0x492f2c;console['log'](_0x47cbfe(0x1ca)),console[_0x47cbfe(0x21a)](_0x47cbfe(0x176)+_0xccf58e),console['log'](_0x47cbfe(0x203)+_0xc52add),this[_0x47cbfe(0x1b9)](_0xccf58e);const _0x16378e=[],_0xf48192=new Date(),_0x57aca4=[{'delay':0x1*0x3c*0x3e8,'description':_0x47cbfe(0x1ec)},{'delay':0x2*0x3c*0x3e8,'description':_0x47cbfe(0x204)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x47cbfe(0x16a)}];console[_0x47cbfe(0x21a)](_0x47cbfe(0x1f2)+_0x57aca4['length']+_0x47cbfe(0x246)+_0xccf58e);let _0x1f049f=0x0;_0x57aca4[_0x47cbfe(0x1db)]((_0x3f36f0,_0x117359)=>{const _0xe2c075=_0x47cbfe;_0x1f049f+=_0x3f36f0['delay'];const _0x5bfe74=setTimeout(async()=>{const _0x59b165=a37_0x1da3;console[_0x59b165(0x21a)](_0x59b165(0x1b1)+(_0x117359+0x1)+_0x59b165(0x221)+_0xccf58e+'\x20(after\x20'+_0x3f36f0[_0x59b165(0x1d2)]+')');try{await this[_0x59b165(0x17c)](_0xccf58e),console['log'](_0x59b165(0x195)+(_0x117359+0x1)+'\x20completed\x20for\x20payment\x20'+_0xccf58e);}catch(_0x53ca6c){console[_0x59b165(0x199)](_0x59b165(0x22e)+(_0x117359+0x1)+_0x59b165(0x16f)+_0xccf58e+':',_0x53ca6c),this[_0x59b165(0x1e5)](_0xccf58e,_0xc52add,_0x53ca6c,'status_check',{'checkNumber':_0x117359+0x1,'scheduledAfter':_0x3f36f0[_0x59b165(0x1d2)],'isIndividualCheck':!![]});}},_0x1f049f);_0x16378e[_0xe2c075(0x217)](_0x5bfe74),console[_0xe2c075(0x21a)](_0xe2c075(0x16b)+(_0x117359+0x1)+_0xe2c075(0x16f)+_0xccf58e+_0xe2c075(0x187)+_0x1f049f/0x3e8+_0xe2c075(0x220)+_0x3f36f0[_0xe2c075(0x1d2)]+')');});const _0x4b29e3=setInterval(async()=>{const _0x243b73=_0x47cbfe;console[_0x243b73(0x21a)](_0x243b73(0x1b4)+_0xccf58e);try{const _0x1a750b=await database_1[_0x243b73(0x1bc)][_0x243b73(0x19b)]['findUnique']({'where':{'id':_0xccf58e},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x1a750b){console[_0x243b73(0x21a)]('❌\x20[HOURLY]\x20Payment\x20'+_0xccf58e+'\x20not\x20found,\x20clearing\x20timers'),this[_0x243b73(0x1b9)](_0xccf58e);return;}console[_0x243b73(0x21a)](_0x243b73(0x234)+_0xccf58e+_0x243b73(0x171)+_0x1a750b[_0x243b73(0x22d)]);if(_0x1a750b[_0x243b73(0x22d)]!==_0x243b73(0x167)){console[_0x243b73(0x21a)]('✅\x20[HOURLY]\x20Payment\x20'+_0xccf58e+_0x243b73(0x227)+_0x1a750b[_0x243b73(0x22d)]+_0x243b73(0x174)),this[_0x243b73(0x1b9)](_0xccf58e);return;}const _0x5d2ce4=Math[_0x243b73(0x19e)]((Date[_0x243b73(0x1a4)]()-_0x1a750b[_0x243b73(0x1ed)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x5d2ce4>=this['EXPIRY_DAYS']){console[_0x243b73(0x21a)](_0x243b73(0x1ff)+_0xccf58e+_0x243b73(0x201)+this[_0x243b73(0x1eb)]+_0x243b73(0x218)),this[_0x243b73(0x1b9)](_0xccf58e);return;}await this[_0x243b73(0x17c)](_0xccf58e),console[_0x243b73(0x21a)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0xccf58e);}catch(_0x47ac12){console[_0x243b73(0x199)]('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0xccf58e+':',_0x47ac12),this[_0x243b73(0x1e5)](_0xccf58e,_0xc52add,_0x47ac12,_0x243b73(0x15f),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x16378e['push'](_0x4b29e3),this[_0x47cbfe(0x23b)][_0x47cbfe(0x193)](_0xccf58e,{'timers':_0x16378e,'paymentId':_0xccf58e,'gatewayPaymentId':_0xc52add,'createdAt':_0xf48192}),console['log']('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x57aca4[_0x47cbfe(0x1b6)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0xccf58e),console['log'](_0x47cbfe(0x1ac)+this[_0x47cbfe(0x23b)][_0x47cbfe(0x1a6)]),this[_0x47cbfe(0x222)](_0xccf58e,_0xc52add,_0x47cbfe(0x167),_0x47cbfe(0x167),_0x47cbfe(0x15f),{'action':_0x47cbfe(0x236),'scheduledChecks':_0x57aca4[_0x47cbfe(0x1b6)],'firstCheckIn':_0x57aca4[0x0]['delay']/0x3e8,'totalTimers':this[_0x47cbfe(0x23b)][_0x47cbfe(0x1a6)]});}[a37_0x492f2c(0x1b9)](_0x33c9f8){const _0x153aff=a37_0x492f2c,_0x2de8f5=this[_0x153aff(0x23b)][_0x153aff(0x243)](_0x33c9f8);_0x2de8f5?(console[_0x153aff(0x21a)](_0x153aff(0x207)+_0x2de8f5[_0x153aff(0x20e)][_0x153aff(0x1b6)]+_0x153aff(0x168)+_0x33c9f8),_0x2de8f5[_0x153aff(0x20e)][_0x153aff(0x1db)]((_0x515612,_0x19b93b)=>{const _0xecefc9=_0x153aff;_0x515612&&(clearTimeout(_0x515612),clearInterval(_0x515612),console['log']('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x19b93b+0x1)+_0xecefc9(0x16f)+_0x33c9f8));}),this[_0x153aff(0x23b)][_0x153aff(0x1be)](_0x33c9f8),console['log'](_0x153aff(0x170)+_0x33c9f8+_0x153aff(0x214)+this[_0x153aff(0x23b)][_0x153aff(0x1a6)])):console[_0x153aff(0x21a)](_0x153aff(0x1d9)+_0x33c9f8+'\x20to\x20clear');}async[a37_0x492f2c(0x17c)](_0x102c97){const _0x49aec8=a37_0x492f2c;console[_0x49aec8(0x21a)](_0x49aec8(0x18e)+_0x102c97);const _0x2f7026=await database_1[_0x49aec8(0x1bc)]['payment'][_0x49aec8(0x1d5)]({'where':{'id':_0x102c97},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2f7026){console['log']('❌\x20[CHECK]\x20Payment\x20'+_0x102c97+'\x20not\x20found\x20in\x20database');return;}console[_0x49aec8(0x21a)](_0x49aec8(0x1c6)+_0x102c97+_0x49aec8(0x1fd)),console['log'](_0x49aec8(0x1c3)+_0x2f7026['gateway']),console[_0x49aec8(0x21a)](_0x49aec8(0x1ce)+_0x2f7026['status']),console[_0x49aec8(0x21a)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x2f7026[_0x49aec8(0x1e7)]),console[_0x49aec8(0x21a)](_0x49aec8(0x1aa)+_0x2f7026[_0x49aec8(0x1cc)]+'\x20'+_0x2f7026['currency']),console['log'](_0x49aec8(0x1ad)+_0x2f7026[_0x49aec8(0x1da)]);if(_0x2f7026[_0x49aec8(0x210)]!==_0x49aec8(0x1e6)){console[_0x49aec8(0x21a)](_0x49aec8(0x1cd)+_0x102c97+_0x49aec8(0x17d)+_0x2f7026['gateway']+')');return;}if(_0x2f7026[_0x49aec8(0x22d)]!==_0x49aec8(0x167)){console['log'](_0x49aec8(0x1cd)+_0x102c97+_0x49aec8(0x227)+_0x2f7026[_0x49aec8(0x22d)]+',\x20stopping\x20individual\x20checks'),this[_0x49aec8(0x1b9)](_0x102c97);return;}if(!_0x2f7026[_0x49aec8(0x1e7)]){console[_0x49aec8(0x21a)](_0x49aec8(0x1cd)+_0x102c97+'\x20has\x20no\x20gatewayPaymentId');return;}console['log'](_0x49aec8(0x17b)+_0x102c97+_0x49aec8(0x20f)),await this[_0x49aec8(0x1df)](_0x2f7026);}[a37_0x492f2c(0x222)](_0x2a216e,_0x250bdb,_0x404b78,_0x5c882e,_0x2ffcbd,_0x19f668){const _0x6d3112=a37_0x492f2c,_0x34f29e={'type':_0x6d3112(0x245),'paymentId':_0x2a216e,'gatewayPaymentId':_0x250bdb,'oldStatus':_0x404b78,'newStatus':_0x5c882e,'source':_0x2ffcbd,'timestamp':new Date()[_0x6d3112(0x1c1)](),'details':_0x19f668||{}};loggerService_1[_0x6d3112(0x211)]['logCoinToPayStatus'](_0x34f29e),console[_0x6d3112(0x21a)](_0x6d3112(0x1a5)+_0x2a216e+'\x20('+_0x250bdb+')'),console[_0x6d3112(0x21a)]('\x20\x20\x20📊\x20Status:\x20'+_0x404b78+_0x6d3112(0x20b)+_0x5c882e),console[_0x6d3112(0x21a)](_0x6d3112(0x1ef)+_0x2ffcbd),console[_0x6d3112(0x21a)](_0x6d3112(0x18f)+_0x34f29e[_0x6d3112(0x1f6)]),_0x19f668&&console[_0x6d3112(0x21a)](_0x6d3112(0x1e3),_0x19f668);}['logCoinToPayError'](_0x505086,_0xc8da03,_0x2476c7,_0x2d95f4,_0x379080){const _0xbf664=a37_0x492f2c,_0x17fbe2={'type':'COINTOPAY_ERROR','paymentId':_0x505086,'gatewayPaymentId':_0xc8da03,'error':_0x2476c7 instanceof Error?{'message':_0x2476c7['message'],'stack':_0x2476c7[_0xbf664(0x1f3)]}:_0x2476c7,'source':_0x2d95f4,'timestamp':new Date()['toISOString'](),'context':_0x379080||{}};loggerService_1[_0xbf664(0x211)][_0xbf664(0x1e5)](_0x17fbe2),console[_0xbf664(0x199)](_0xbf664(0x172)+_0x505086+'\x20('+_0xc8da03+')'),console[_0xbf664(0x199)]('\x20\x20\x20❌\x20Error:\x20'+(_0x2476c7 instanceof Error?_0x2476c7[_0xbf664(0x192)]:_0x2476c7)),console[_0xbf664(0x199)]('\x20\x20\x20📍\x20Source:\x20'+_0x2d95f4),console['error']('\x20\x20\x20📅\x20Time:\x20'+_0x17fbe2[_0xbf664(0x1f6)]),_0x379080&&console[_0xbf664(0x199)]('\x20\x20\x20📝\x20Context:',_0x379080);}[a37_0x492f2c(0x23e)](){const _0x21cd24=a37_0x492f2c;console['log'](_0x21cd24(0x22c)),this[_0x21cd24(0x244)]()[_0x21cd24(0x215)](_0x194e77=>{const _0x152ebe=_0x21cd24;console['error'](_0x152ebe(0x1c7),_0x194e77);}),this[_0x21cd24(0x19c)]=setInterval(async()=>{const _0x1f460d=_0x21cd24;try{console[_0x1f460d(0x21a)](_0x1f460d(0x160)),await this['checkAllPendingPayments'](),console[_0x1f460d(0x21a)](_0x1f460d(0x1bd));}catch(_0x4ed98d){console['error']('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x4ed98d);}},this[_0x21cd24(0x1b7)]),console['log'](_0x21cd24(0x230));}[a37_0x492f2c(0x1b2)](){const _0x4b741c=a37_0x492f2c;console['log'](_0x4b741c(0x1cb));this[_0x4b741c(0x19c)]&&(clearInterval(this[_0x4b741c(0x19c)]),this['globalCheckInterval']=null,console[_0x4b741c(0x21a)](_0x4b741c(0x194)));const _0x3f38c8=this[_0x4b741c(0x23b)][_0x4b741c(0x1a6)];for(const [_0xbd006e]of this[_0x4b741c(0x23b)]){this[_0x4b741c(0x1b9)](_0xbd006e);}console['log'](_0x4b741c(0x231)+_0x3f38c8+_0x4b741c(0x184));}async[a37_0x492f2c(0x244)](){const _0x40b146=a37_0x492f2c;try{console[_0x40b146(0x21a)](_0x40b146(0x1e2));const _0x418d4c=await database_1['default'][_0x40b146(0x19b)][_0x40b146(0x185)]({'where':{'gateway':_0x40b146(0x1e6),'status':_0x40b146(0x167),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x40b146(0x21a)](_0x40b146(0x196)+_0x418d4c['length']+_0x40b146(0x1d6));if(_0x418d4c[_0x40b146(0x1b6)]===0x0){console[_0x40b146(0x21a)](_0x40b146(0x1d4));return;}const _0x1a77bb=await this[_0x40b146(0x240)](_0x418d4c);console['log']('⏰\x20[GLOBAL]\x20Found\x20'+_0x1a77bb[_0x40b146(0x1b6)]+_0x40b146(0x242));let _0x252eb5=0x0,_0x4c1f03=0x0;for(const _0x52fe33 of _0x418d4c){try{if(_0x1a77bb[_0x40b146(0x177)](_0x52fe33['id'])){console[_0x40b146(0x21a)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x52fe33['id']+_0x40b146(0x219)),_0x4c1f03++;continue;}if(this[_0x40b146(0x23b)][_0x40b146(0x1b3)](_0x52fe33['id'])){console['log'](_0x40b146(0x19d)+_0x52fe33['id']+_0x40b146(0x238)),_0x4c1f03++;continue;}const _0x3bc739=(Date['now']()-_0x52fe33[_0x40b146(0x1ed)][_0x40b146(0x1bf)]())/(0x3e8*0x3c*0x3c);if(_0x3bc739<0x1){console[_0x40b146(0x21a)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x52fe33['id']+_0x40b146(0x175)+_0x3bc739[_0x40b146(0x239)](0x1)+_0x40b146(0x1cf)),_0x4c1f03++;continue;}console['log']('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x52fe33['id']+_0x40b146(0x216)+_0x3bc739[_0x40b146(0x239)](0x1)+'h)'),await this[_0x40b146(0x1df)](_0x52fe33),_0x252eb5++,await new Promise(_0x1368da=>setTimeout(_0x1368da,0x7d0));}catch(_0x13e130){console[_0x40b146(0x199)]('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x52fe33['id']+':',_0x13e130),this['logCoinToPayError'](_0x52fe33['id'],_0x52fe33[_0x40b146(0x1e7)]||_0x40b146(0x16c),_0x13e130,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x52fe33[_0x40b146(0x1cc)],'paymentCurrency':_0x52fe33['currency'],'shopId':_0x52fe33[_0x40b146(0x1da)],'createdAt':_0x52fe33[_0x40b146(0x1ed)]}),loggerService_1[_0x40b146(0x211)][_0x40b146(0x20a)](_0x40b146(0x1e6),_0x40b146(0x213)+_0x52fe33['gatewayPaymentId'],_0x13e130);}}console[_0x40b146(0x21a)]('✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x252eb5+_0x40b146(0x190)+_0x4c1f03+_0x40b146(0x178)+_0x1a77bb['length']+_0x40b146(0x228));}catch(_0x4ebc75){console['error'](_0x40b146(0x1b8),_0x4ebc75);}}async[a37_0x492f2c(0x240)](_0x527e2d){const _0x4ea898=a37_0x492f2c,_0x581695=[],_0x5ebdcf=new Date();_0x5ebdcf[_0x4ea898(0x1f0)](_0x5ebdcf[_0x4ea898(0x23d)]()-this[_0x4ea898(0x1eb)]),console[_0x4ea898(0x21a)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x4ea898(0x1eb)]+_0x4ea898(0x15e)+_0x5ebdcf['toISOString']()+')');for(const _0x4acd24 of _0x527e2d){if(_0x4acd24['createdAt']<_0x5ebdcf){console[_0x4ea898(0x21a)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x4acd24['id']+_0x4ea898(0x201)+this[_0x4ea898(0x1eb)]+_0x4ea898(0x1af));try{this[_0x4ea898(0x222)](_0x4acd24['id'],_0x4acd24['gatewayPaymentId']||'unknown',_0x4ea898(0x167),'EXPIRED','auto_expire',{'reason':_0x4ea898(0x1f8)+this[_0x4ea898(0x1eb)]+_0x4ea898(0x237),'createdAt':_0x4acd24['createdAt'],'daysSinceCreation':Math[_0x4ea898(0x19e)]((Date['now']()-_0x4acd24[_0x4ea898(0x1ed)][_0x4ea898(0x1bf)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x4acd24['amount'],'paymentCurrency':_0x4acd24[_0x4ea898(0x1c0)],'shopId':_0x4acd24[_0x4ea898(0x1da)]}),await database_1['default']['payment'][_0x4ea898(0x1de)]({'where':{'id':_0x4acd24['id']},'data':{'status':_0x4ea898(0x198),'updatedAt':new Date(),'adminNotes':_0x4ea898(0x1d1)+this[_0x4ea898(0x1eb)]+_0x4ea898(0x22a)}}),await database_1['default'][_0x4ea898(0x212)][_0x4ea898(0x18d)]({'data':{'paymentId':_0x4acd24['id'],'shopId':_0x4acd24[_0x4ea898(0x1da)],'event':_0x4ea898(0x166),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x4acd24[_0x4ea898(0x1ed)],'expiredAt':new Date()[_0x4ea898(0x1c1)](),'daysSinceCreation':Math[_0x4ea898(0x19e)]((Date[_0x4ea898(0x1a4)]()-_0x4acd24[_0x4ea898(0x1ed)][_0x4ea898(0x1bf)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x4acd24,_0x4ea898(0x198)),await this[_0x4ea898(0x163)](_0x4acd24,'EXPIRED'),this[_0x4ea898(0x1b9)](_0x4acd24['id']),_0x581695['push'](_0x4acd24['id']),console[_0x4ea898(0x21a)](_0x4ea898(0x1e9)+_0x4acd24['id']+_0x4ea898(0x1b0)+this[_0x4ea898(0x1eb)]+_0x4ea898(0x1ee));}catch(_0x4a9e85){console[_0x4ea898(0x199)](_0x4ea898(0x1ae)+_0x4acd24['id']+':',_0x4a9e85),this[_0x4ea898(0x1e5)](_0x4acd24['id'],_0x4acd24[_0x4ea898(0x1e7)]||'unknown',_0x4a9e85,'auto_expire',{'reason':_0x4ea898(0x191),'createdAt':_0x4acd24[_0x4ea898(0x1ed)],'daysSinceCreation':Math['floor']((Date[_0x4ea898(0x1a4)]()-_0x4acd24[_0x4ea898(0x1ed)][_0x4ea898(0x1bf)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x581695;}async[a37_0x492f2c(0x1df)](_0x1d9952){const _0x4b04a6=a37_0x492f2c;if(!_0x1d9952[_0x4b04a6(0x1e7)]){console[_0x4b04a6(0x21a)](_0x4b04a6(0x1cd)+_0x1d9952['id']+_0x4b04a6(0x1fa));return;}console['log'](_0x4b04a6(0x181)+_0x1d9952['id']+'\x20('+_0x1d9952[_0x4b04a6(0x1e7)]+')');try{const _0x1104a1=await this[_0x4b04a6(0x1f9)][_0x4b04a6(0x1f5)](_0x1d9952['gatewayPaymentId']);console[_0x4b04a6(0x21a)](_0x4b04a6(0x1c6)+_0x1d9952['id']+'\x20status:\x20'+_0x1104a1[_0x4b04a6(0x22d)]);_0x1104a1[_0x4b04a6(0x20c)]&&console[_0x4b04a6(0x21a)](_0x4b04a6(0x1c6)+_0x1d9952['id']+_0x4b04a6(0x21f),{'iban':_0x1104a1[_0x4b04a6(0x20c)]['iban']||_0x4b04a6(0x1dc),'transactionId':_0x1104a1[_0x4b04a6(0x20c)]['transactionId'],'createdOn':_0x1104a1[_0x4b04a6(0x20c)][_0x4b04a6(0x179)],'confirmedOn':_0x1104a1[_0x4b04a6(0x20c)][_0x4b04a6(0x1ea)]||'not\x20confirmed'});if(_0x1104a1['status']!==_0x1d9952['status']){console['log']('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x1d9952['id']+_0x4b04a6(0x1dd)+_0x1d9952['status']+_0x4b04a6(0x21b)+_0x1104a1[_0x4b04a6(0x22d)]),this[_0x4b04a6(0x222)](_0x1d9952['id'],_0x1d9952[_0x4b04a6(0x1e7)],_0x1d9952['status'],_0x1104a1[_0x4b04a6(0x22d)],_0x4b04a6(0x15f),{'paymentDetails':_0x1104a1['paymentDetails'],'amount':_0x1104a1[_0x4b04a6(0x1cc)],'currency':_0x1104a1['currency'],'shopId':_0x1d9952[_0x4b04a6(0x1da)],'checkTimestamp':new Date()['toISOString']()});const _0x4a833d={'status':_0x1104a1[_0x4b04a6(0x22d)],'updatedAt':new Date()};_0x1104a1[_0x4b04a6(0x22d)]===_0x4b04a6(0x180)&&_0x1d9952[_0x4b04a6(0x22d)]!==_0x4b04a6(0x180)&&(_0x4a833d[_0x4b04a6(0x223)]=new Date(),console[_0x4b04a6(0x21a)](_0x4b04a6(0x1d0)+_0x1d9952['id']+_0x4b04a6(0x1ba)+_0x4a833d[_0x4b04a6(0x223)][_0x4b04a6(0x1c1)]()));if(_0x1104a1[_0x4b04a6(0x20c)]){const _0x45d945=_0x1104a1[_0x4b04a6(0x20c)];_0x45d945[_0x4b04a6(0x169)]&&(_0x4a833d[_0x4b04a6(0x1a9)]=_0x45d945[_0x4b04a6(0x169)],console[_0x4b04a6(0x21a)](_0x4b04a6(0x17a)+_0x45d945[_0x4b04a6(0x169)]));if(_0x45d945['bankDetails']){const _0x5333bc=_0x1d9952[_0x4b04a6(0x189)]||'',_0xfd0e5e=_0x4b04a6(0x1c4)+_0x45d945['bankDetails'];_0x4a833d[_0x4b04a6(0x189)]=_0x5333bc?_0x5333bc+'\x0a\x0a'+_0xfd0e5e:_0xfd0e5e,console[_0x4b04a6(0x21a)](_0x4b04a6(0x188));}_0x45d945[_0x4b04a6(0x1b5)]&&console[_0x4b04a6(0x21a)](_0x4b04a6(0x1fb)+_0x45d945[_0x4b04a6(0x1b5)]),_0x45d945['confirmedOn']&&console[_0x4b04a6(0x21a)]('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x45d945['confirmedOn']);}await database_1[_0x4b04a6(0x1bc)][_0x4b04a6(0x19b)][_0x4b04a6(0x1de)]({'where':{'id':_0x1d9952['id']},'data':_0x4a833d}),await database_1['default'][_0x4b04a6(0x212)][_0x4b04a6(0x18d)]({'data':{'paymentId':_0x1d9952['id'],'shopId':_0x1d9952[_0x4b04a6(0x1da)],'event':_0x4b04a6(0x235)+_0x1104a1['status'][_0x4b04a6(0x241)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1d9952['status'],'newStatus':_0x1104a1[_0x4b04a6(0x22d)],'paymentDetails':_0x1104a1[_0x4b04a6(0x20c)],'checkedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x1d9952,_0x1104a1['status']),await this['sendPaymentStatusNotification'](_0x1d9952,_0x1104a1[_0x4b04a6(0x22d)]),_0x1104a1['status']!=='PENDING'&&(console['log'](_0x4b04a6(0x21c)+_0x1d9952['id']+'\x20status\x20changed\x20to\x20'+_0x1104a1['status']+_0x4b04a6(0x19f)),this[_0x4b04a6(0x1b9)](_0x1d9952['id'])),console[_0x4b04a6(0x21a)](_0x4b04a6(0x17b)+_0x1d9952['id']+_0x4b04a6(0x205));}else console['log'](_0x4b04a6(0x1c6)+_0x1d9952['id']+_0x4b04a6(0x1f4)+_0x1104a1[_0x4b04a6(0x22d)]+')'),this['logCoinToPayStatus'](_0x1d9952['id'],_0x1d9952[_0x4b04a6(0x1e7)],_0x1d9952[_0x4b04a6(0x22d)],_0x1104a1['status'],_0x4b04a6(0x15f),{'statusUnchanged':!![],'paymentDetails':_0x1104a1[_0x4b04a6(0x20c)],'amount':_0x1104a1[_0x4b04a6(0x1cc)],'currency':_0x1104a1['currency'],'shopId':_0x1d9952[_0x4b04a6(0x1da)],'checkTimestamp':new Date()[_0x4b04a6(0x1c1)]()});}catch(_0x2f591d){console[_0x4b04a6(0x199)]('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x1d9952['id']+':',_0x2f591d),this[_0x4b04a6(0x1e5)](_0x1d9952['id'],_0x1d9952[_0x4b04a6(0x1e7)],_0x2f591d,_0x4b04a6(0x15f),{'paymentAmount':_0x1d9952['amount'],'paymentCurrency':_0x1d9952[_0x4b04a6(0x1c0)],'shopId':_0x1d9952[_0x4b04a6(0x1da)],'createdAt':_0x1d9952[_0x4b04a6(0x1ed)]}),await database_1['default'][_0x4b04a6(0x212)][_0x4b04a6(0x18d)]({'data':{'paymentId':_0x1d9952['id'],'shopId':_0x1d9952[_0x4b04a6(0x1da)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x4b04a6(0x229)]({'error':_0x2f591d instanceof Error?_0x2f591d[_0x4b04a6(0x192)]:'Unknown\x20error','gatewayPaymentId':_0x1d9952[_0x4b04a6(0x1e7)],'checkedAt':new Date()['toISOString']()})}});}}async[a37_0x492f2c(0x1c8)](_0x34fc15,_0x34f1c6){const _0x54ef5b=a37_0x492f2c,_0x148f17=Date[_0x54ef5b(0x1a4)]();try{const _0xa29acf=_0x34fc15[_0x54ef5b(0x164)],_0x476d7=_0xa29acf[_0x54ef5b(0x20d)];if(!_0x476d7?.[_0x54ef5b(0x1c9)]){console[_0x54ef5b(0x21a)](_0x54ef5b(0x1a2)+_0xa29acf['id']);return;}const _0x54530d=_0x34f1c6==='PAID'?_0x54ef5b(0x182):_0x34f1c6===_0x54ef5b(0x16d)?'payment.failed':_0x34f1c6===_0x54ef5b(0x198)?_0x54ef5b(0x23a):'payment.pending';if(!_0x476d7[_0x54ef5b(0x18b)]?.[_0x54ef5b(0x177)](_0x54530d)){console['log'](_0x54ef5b(0x1e1)+_0x54530d+_0x54ef5b(0x23f)+_0xa29acf['id']);return;}const _0x1e8838={'event':_0x54530d,'payment':{'id':_0x34fc15['id'],'order_id':_0x34fc15[_0x54ef5b(0x233)],'gateway_order_id':_0x34fc15[_0x54ef5b(0x1a0)],'gateway':_0x54ef5b(0x1d7),'amount':_0x34fc15['amount'],'currency':_0x34fc15[_0x54ef5b(0x1c0)],'status':_0x34f1c6[_0x54ef5b(0x241)](),'customer_email':_0x34fc15[_0x54ef5b(0x1e4)],'customer_name':_0x34fc15['customerName'],'created_at':_0x34fc15[_0x54ef5b(0x1ed)],'updated_at':new Date()}},_0x214823=await fetch(_0x476d7[_0x54ef5b(0x1c9)],{'method':_0x54ef5b(0x1fe),'headers':{'Content-Type':'application/json','User-Agent':_0x54ef5b(0x183)},'body':JSON['stringify'](_0x1e8838)}),_0xe466bb=Date['now']()-_0x148f17,_0xdcbc91=_0x214823['ok']?_0x54ef5b(0x1ab):await _0x214823['text']();loggerService_1[_0x54ef5b(0x211)][_0x54ef5b(0x1bb)](_0x34fc15['shopId'],_0x476d7[_0x54ef5b(0x1c9)],_0x54530d,_0x214823[_0x54ef5b(0x22d)],_0xe466bb,_0x1e8838),console['log'](_0x54ef5b(0x1f7)+_0x476d7[_0x54ef5b(0x1c9)]+'\x20with\x20status\x20'+_0x214823['status']+'\x20('+_0xe466bb+'ms)');}catch(_0x48c9b9){console[_0x54ef5b(0x199)](_0x54ef5b(0x1a3),_0x48c9b9),loggerService_1[_0x54ef5b(0x211)][_0x54ef5b(0x1c2)](_0x34fc15[_0x54ef5b(0x1da)],_0x34fc15[_0x54ef5b(0x164)]?.['settings']?.['webhookUrl']||_0x54ef5b(0x16c),_0x54ef5b(0x21d),_0x48c9b9,{});}}async[a37_0x492f2c(0x163)](_0x4ea4ab,_0x315161){const _0xa14889=a37_0x492f2c;try{const _0x44a2bc={'PENDING':_0xa14889(0x18c),'PAID':_0xa14889(0x161),'FAILED':'failed','EXPIRED':_0xa14889(0x1d3)},_0x36708b=_0x44a2bc[_0x315161];if(!_0x36708b||_0x36708b===_0xa14889(0x18c))return;await telegramBotService_1[_0xa14889(0x1a8)][_0xa14889(0x1e8)](_0x4ea4ab[_0xa14889(0x1da)],_0x4ea4ab,_0x36708b);}catch(_0x1e0011){console[_0xa14889(0x199)](_0xa14889(0x22b),_0x1e0011);}}async[a37_0x492f2c(0x22f)](_0x25af79){const _0x5377e9=a37_0x492f2c;console[_0x5377e9(0x21a)](_0x5377e9(0x202)+_0x25af79);const _0x23d82c=await database_1[_0x5377e9(0x1bc)]['payment'][_0x5377e9(0x1d5)]({'where':{'id':_0x25af79},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x23d82c)throw new Error('Payment\x20not\x20found');if(_0x23d82c[_0x5377e9(0x210)]!=='cointopay')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x5377e9(0x21a)](_0x5377e9(0x197)+_0x25af79),await this[_0x5377e9(0x1df)](_0x23d82c),console['log'](_0x5377e9(0x19a)+_0x25af79);}['getServiceStats'](){const _0x135785=a37_0x492f2c,_0xf9c969=this[_0x135785(0x19c)]?this[_0x135785(0x1b7)]:undefined,_0xb0c637=Array[_0x135785(0x1fc)](this['paymentTimers'][_0x135785(0x17e)]())[_0x135785(0x1a7)](_0x5a5430=>({'paymentId':_0x5a5430[_0x135785(0x1a1)],'gatewayPaymentId':_0x5a5430[_0x135785(0x1e7)],'createdAt':_0x5a5430['createdAt'],'timersCount':_0x5a5430[_0x135785(0x20e)][_0x135785(0x1b6)]}));return{'isActive':!!this[_0x135785(0x19c)],'globalCheckIntervalMinutes':this[_0x135785(0x1b7)]/(0x3e8*0x3c),'expiryDays':this[_0x135785(0x1eb)],'activeIndividualTimers':this[_0x135785(0x23b)][_0x135785(0x1a6)],'nextGlobalCheckIn':_0xf9c969,'paymentTimersDetails':_0xb0c637};}[a37_0x492f2c(0x1c5)](_0x24a7fe){const _0x28fc1a=a37_0x492f2c,_0x1a35db=this[_0x28fc1a(0x23b)][_0x28fc1a(0x243)](_0x24a7fe);if(_0x1a35db)return{'hasTimers':!![],'timersCount':_0x1a35db[_0x28fc1a(0x20e)][_0x28fc1a(0x1b6)],'createdAt':_0x1a35db[_0x28fc1a(0x1ed)],'gatewayPaymentId':_0x1a35db[_0x28fc1a(0x1e7)]};return{'hasTimers':![]};}}exports[a37_0x492f2c(0x209)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();