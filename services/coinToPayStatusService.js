'use strict';const a38_0x5ce853=a38_0x5177;function a38_0x5177(_0x23f976,_0x1b22b1){const _0x4ce79d=a38_0x4ce7();return a38_0x5177=function(_0x5177c9,_0x2a7531){_0x5177c9=_0x5177c9-0xa5;let _0x5294da=_0x4ce79d[_0x5177c9];return _0x5294da;},a38_0x5177(_0x23f976,_0x1b22b1);}function a38_0x4ce7(){const _0x4b883e=['/status/','type','paymentLink','logCoinToPayStatus','checkPaymentById','create','COINTOPAY_ERROR','transactionId','\x20days,\x20marking\x20as\x20EXPIRED','üí∞\x20[CHECK]\x20Payment\x20','\x20not\x20found,\x20clearing\x20timers',',\x20stopping\x20individual\x20checks','orderId','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','\x20status\x20changed\x20to\x20','webhook_send','cointopay_status_check_','GLOBAL_CHECK_INTERVAL_MS','toISOString','not\x20found','coinToPay2Service','ü™ô\x20[DEBUG]\x20Creating\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','entries','\x20\x20\x20-\x20GatewayPaymentId:\x20','‚ùå\x20[HOURLY]\x20Payment\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','push','CoinToPayService','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','./telegramBotService','checkAllPendingPayments','\x20\x20\x20Amount:\x20','currentPayments','Webhook\x20event\x20','toLowerCase','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','./loggerService','6302256cYhJob','SINGLE','payment.pending','../types/gateway','webhookUrl','\x20days\x20without\x20payment\x20confirmation','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','POST','paymentDetails','./currencyService','sendPaymentNotification','‚è∞\x20[GLOBAL]\x20Payment\x20','\x20triggered\x20for\x20payment\x20','getPaymentTimerInfo','status','paid','Success','5QQsZNC','logShopWebhookError','\x20\x20\x20Gateway\x20','auto_expire','\x20\x20\x20-\x20ShopId:\x20','Shop\x20webhook\x20sent\x20to\x20','shopId',',\x20status=','checkPaymentStatus','clearPaymentTimers','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','findUnique','values','467696IWTUlx','\x20->\x20','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','paymentLinkId','h),\x20skipping\x20global\x20check','PAID','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','amountUSDT','default','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','amountAfterGatewayCommissionUSDT','\x20checked,\x20','globalCheckInterval','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','sendPaymentStatusNotification','939558EnJbcP','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','\x20status\x20from\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20\x20\x20-\x20Amount:\x20','checkExpiredPayments','Failed\x20to\x20mark\x20payment\x20as\x20expired','Payment\x20older\x20than\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','cointopay','catch','currency','__importDefault','14gEHXoy','\x20expired','getGatewayCommission','2\x20minutes','schedulePaymentChecks','\x20skipped,\x20','\x20for\x20payment\x20','cointopay2','\x20\x20\x20üìÖ\x20Time:\x20','length','__esModule','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','paymentId','PENDING','confirmedOn','size','startPeriodicStatusCheck','\x20in\x20','set','\x20seconds\x20(','getDate','‚è∞\x20[GLOBAL]\x20Found\x20','\x20\x20\x20‚ùå\x20Error:\x20','-day\x20timeout','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','ms)',',\x20using\x20default\x2010%','paidAt','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','status_check','\x20\x20\x20-\x20paymentId:\x20','\x20(after\x20','expired','2116712qnrjXQ','telegramBotService','payment.failed','update','createdAt','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','cointopay_status_check_error','loggerService','floor','customerName','\x20has\x20no\x20gatewayPaymentId','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','Payment\x20not\x20found','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','\x20days','Automatically\x20expired\x20after\x20','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','4145736WqTdDh','created','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20is\x20older\x20than\x20','includes','webhookLog','log','amount','\x20status:\x20','\x20timers\x20for\x20payment\x20','\x20days\x20(created\x20before\x20','error','unknown','toFixed','stopPeriodicStatusCheck','üîç\x20[CHECK]\x20Checking\x20','stringify','Gateway\x20','üßπ\x20[DEBUG]\x20Clearing\x20','commission','paymentTimers','5\x20minutes','gatewayPaymentId','from','sendShopWebhook','\x20USDT','getGatewayIdByName','üßπ\x20[CHECK]\x20Payment\x20','coinToPayService','EXPIRY_DAYS','\x20payment\x20','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','üìä\x20[CHECK]\x20Payment\x20','CoinToPay2Service','forEach','timers','coinToPayStatusService','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','payment','now',',\x20using\x20default\x20commission\x2010%','\x20status\x20is\x20','\x20individual\x20payment\x20timers','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','stack','‚ùå\x20[CHECK]\x20Payment\x20','Failed\x20to\x20send\x20shop\x20webhook:','get','defineProperty','üõë\x20[SHUTDOWN]\x20Cleared\x20','Bank\x20Details:\x20','message','\x20commission:\x20','\x20to\x20','failed','./gateways/coinToPayService','checkSinglePaymentById','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20with\x20status\x20','settings','COINTOPAY_STATUS_CHANGE','EXPIRED','1\x20minute','schedule_created','webhookEvents','\x20found:','getTime','\x20in\x20shop\x20','23762860JvskNP','\x20\x20\x20üìç\x20Source:\x20','\x20updated:\x20currentPayments=','\x20\x20\x20Amount\x20after\x20commission:\x20','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','gatewayOrderId','text','‚úÖ\x20[CHECK]\x20Payment\x20','TesSoft\x20Payment\x20System/1.0','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','logCoinToPayError','ü™ô\x20[GLOBAL]\x20Found\x20','‚úÖ\x20[HOURLY]\x20Payment\x20','remitterIban','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','delete','FAILED','üìà\x20[COINTOPAY]\x20Payment\x20','\x20(age:\x20','findMany','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','4261545STTyfk','\x20is\x20too\x20new\x20(','\x20updated\x20successfully','adminNotes','description','gateway','1EmRCIr','\x20\x20\x20üìä\x20Status:\x20','not\x20confirmed','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','logShopWebhookSent','application/json','gatewaySettings','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20details:','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','shop','\x20expired\x20CoinToPay\x20payments','map','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','bankDetails','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20',',\x20gateway\x20','iban','\x20initial\x20timers\x20for\x20payment\x20','payment.success','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','checkSinglePayment','\x20\x20\x20-\x20Gateway:\x20','CoinToPayStatusService'];a38_0x4ce7=function(){return _0x4b883e;};return a38_0x4ce7();}(function(_0x3f0c69,_0x31fe47){const _0x2e9b21=a38_0x5177,_0x505729=_0x3f0c69();while(!![]){try{const _0xec2697=-parseInt(_0x2e9b21(0x164))/0x1*(-parseInt(_0x2e9b21(0xf3))/0x2)+parseInt(_0x2e9b21(0x105))/0x3+-parseInt(_0x2e9b21(0xb1))/0x4*(parseInt(_0x2e9b21(0x1b5))/0x5)+-parseInt(_0x2e9b21(0xc1))/0x6*(parseInt(_0x2e9b21(0xd1))/0x7)+parseInt(_0x2e9b21(0x1a4))/0x8+parseInt(_0x2e9b21(0x15e))/0x9+-parseInt(_0x2e9b21(0x149))/0xa;if(_0xec2697===_0x31fe47)break;else _0x505729['push'](_0x505729['shift']());}catch(_0x110d5a){_0x505729['push'](_0x505729['shift']());}}}(a38_0x4ce7,0xda8b7));var __importDefault=this&&this[a38_0x5ce853(0xd0)]||function(_0x208dcb){const _0x572ce1=a38_0x5ce853;return _0x208dcb&&_0x208dcb[_0x572ce1(0xdb)]?_0x208dcb:{'default':_0x208dcb};};Object[a38_0x5ce853(0x135)](exports,a38_0x5ce853(0xdb),{'value':!![]}),exports[a38_0x5ce853(0x129)]=exports[a38_0x5ce853(0x17c)]=void 0x0;const coinToPayService_1=require(a38_0x5ce853(0x13c)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require(a38_0x5ce853(0x1a7)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a38_0x5ce853(0x19c)),loggerService_1=require(a38_0x5ce853(0x1a3)),currencyService_1=require(a38_0x5ce853(0x1ad));class CoinToPayStatusService{constructor(){const _0x5153b5=a38_0x5ce853;this[_0x5153b5(0xbe)]=null,this[_0x5153b5(0x18e)]=0x3c*0x3c*0x3e8,this[_0x5153b5(0x122)]=0x5,this[_0x5153b5(0x119)]=new Map(),this[_0x5153b5(0x121)]=new coinToPayService_1[(_0x5153b5(0x19a))](),this[_0x5153b5(0x191)]=new coinToPay2Service_1[(_0x5153b5(0x126))](),console['log'](_0x5153b5(0x12a));}[a38_0x5ce853(0xd5)](_0x2c84eb,_0x3ac263){const _0x2f956d=a38_0x5ce853;console[_0x2f956d(0x10b)](_0x2f956d(0x16b)),console[_0x2f956d(0x10b)](_0x2f956d(0xf0)+_0x2c84eb),console[_0x2f956d(0x10b)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x3ac263),this[_0x2f956d(0xad)](_0x2c84eb);const _0x3affdf=[],_0x271b58=new Date(),_0x5a93a0=[{'delay':0x1*0x3c*0x3e8,'description':_0x2f956d(0x143)},{'delay':0x2*0x3c*0x3e8,'description':_0x2f956d(0xd4)},{'delay':0x5*0x3c*0x3e8,'description':_0x2f956d(0x11a)},{'delay':0x5*0x3c*0x3e8,'description':_0x2f956d(0x11a)}];console['log'](_0x2f956d(0x192)+_0x5a93a0[_0x2f956d(0xda)]+_0x2f956d(0x177)+_0x2c84eb);let _0x44cb3f=0x0;_0x5a93a0[_0x2f956d(0x127)]((_0x2c5672,_0x53f8fb)=>{const _0x1bb3b7=_0x2f956d;_0x44cb3f+=_0x2c5672['delay'];const _0x474f5c=setTimeout(async()=>{const _0x31934b=a38_0x5177;console['log'](_0x31934b(0x1a2)+(_0x53f8fb+0x1)+_0x31934b(0x1b0)+_0x2c84eb+_0x31934b(0xf1)+_0x2c5672['description']+')');try{await this[_0x31934b(0x13d)](_0x2c84eb),console[_0x31934b(0x10b)](_0x31934b(0xdc)+(_0x53f8fb+0x1)+'\x20completed\x20for\x20payment\x20'+_0x2c84eb);}catch(_0x2f39d2){console[_0x31934b(0x110)](_0x31934b(0x172)+(_0x53f8fb+0x1)+'\x20for\x20payment\x20'+_0x2c84eb+':',_0x2f39d2),this['logCoinToPayError'](_0x2c84eb,_0x3ac263,_0x2f39d2,_0x31934b(0xef),{'checkNumber':_0x53f8fb+0x1,'scheduledAfter':_0x2c5672[_0x31934b(0x162)],'isIndividualCheck':!![]});}},_0x44cb3f);_0x3affdf['push'](_0x474f5c),console[_0x1bb3b7(0x10b)](_0x1bb3b7(0xb4)+(_0x53f8fb+0x1)+'\x20for\x20payment\x20'+_0x2c84eb+_0x1bb3b7(0xe3)+_0x44cb3f/0x3e8+_0x1bb3b7(0xe5)+_0x2c5672[_0x1bb3b7(0x162)]+')');});const _0x3e864c=setInterval(async()=>{const _0x12cecf=_0x2f956d;console[_0x12cecf(0x10b)](_0x12cecf(0x15d)+_0x2c84eb);try{const _0x26911b=await database_1[_0x12cecf(0xba)][_0x12cecf(0x12b)][_0x12cecf(0xaf)]({'where':{'id':_0x2c84eb},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x26911b){console['log'](_0x12cecf(0x197)+_0x2c84eb+_0x12cecf(0x187)),this[_0x12cecf(0xad)](_0x2c84eb);return;}console[_0x12cecf(0x10b)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x2c84eb+'\x20current\x20status:\x20'+_0x26911b[_0x12cecf(0x1b2)]);if(_0x26911b[_0x12cecf(0x1b2)]!==_0x12cecf(0xdf)){console[_0x12cecf(0x10b)](_0x12cecf(0x155)+_0x2c84eb+_0x12cecf(0x12e)+_0x26911b[_0x12cecf(0x1b2)]+',\x20stopping\x20individual\x20checks'),this[_0x12cecf(0xad)](_0x2c84eb);return;}const _0x2d3099=Math[_0x12cecf(0xfb)]((Date[_0x12cecf(0x12c)]()-_0x26911b[_0x12cecf(0xf7)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x2d3099>=this[_0x12cecf(0x122)]){console['log']('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x2c84eb+_0x12cecf(0x108)+this['EXPIRY_DAYS']+_0x12cecf(0x16c)),this[_0x12cecf(0xad)](_0x2c84eb);return;}await this['checkSinglePaymentById'](_0x2c84eb),console[_0x12cecf(0x10b)](_0x12cecf(0xbb)+_0x2c84eb);}catch(_0x4ac91b){console['error'](_0x12cecf(0xae)+_0x2c84eb+':',_0x4ac91b),this[_0x12cecf(0x153)](_0x2c84eb,_0x3ac263,_0x4ac91b,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3affdf[_0x2f956d(0x199)](_0x3e864c),this[_0x2f956d(0x119)][_0x2f956d(0xe4)](_0x2c84eb,{'timers':_0x3affdf,'paymentId':_0x2c84eb,'gatewayPaymentId':_0x3ac263,'createdAt':_0x271b58}),console[_0x2f956d(0x10b)]('‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x5a93a0[_0x2f956d(0xda)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x2c84eb),console[_0x2f956d(0x10b)]('üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this['paymentTimers']['size']),this['logCoinToPayStatus'](_0x2c84eb,_0x3ac263,_0x2f956d(0xdf),_0x2f956d(0xdf),_0x2f956d(0xef),{'action':_0x2f956d(0x144),'scheduledChecks':_0x5a93a0['length'],'firstCheckIn':_0x5a93a0[0x0]['delay']/0x3e8,'totalTimers':this['paymentTimers'][_0x2f956d(0xe1)]});}[a38_0x5ce853(0xad)](_0x1d692f){const _0x4758e7=a38_0x5ce853,_0x834f3c=this['paymentTimers'][_0x4758e7(0x134)](_0x1d692f);_0x834f3c?(console[_0x4758e7(0x10b)](_0x4758e7(0x117)+_0x834f3c['timers'][_0x4758e7(0xda)]+_0x4758e7(0x10e)+_0x1d692f),_0x834f3c[_0x4758e7(0x128)][_0x4758e7(0x127)]((_0x1db2ad,_0x2c0eba)=>{const _0x582449=_0x4758e7;_0x1db2ad&&(clearTimeout(_0x1db2ad),clearInterval(_0x1db2ad),console[_0x582449(0x10b)](_0x582449(0x19b)+(_0x2c0eba+0x1)+_0x582449(0xd7)+_0x1d692f));}),this[_0x4758e7(0x119)][_0x4758e7(0x158)](_0x1d692f),console['log'](_0x4758e7(0xdd)+_0x1d692f+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x4758e7(0x119)][_0x4758e7(0xe1)])):console[_0x4758e7(0x10b)]('‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x1d692f+'\x20to\x20clear');}async[a38_0x5ce853(0x13d)](_0x1972cd){const _0x23c150=a38_0x5ce853;console[_0x23c150(0x10b)](_0x23c150(0x174)+_0x1972cd);const _0x106f63=await database_1[_0x23c150(0xba)][_0x23c150(0x12b)][_0x23c150(0xaf)]({'where':{'id':_0x1972cd},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x106f63){console[_0x23c150(0x10b)](_0x23c150(0x132)+_0x1972cd+'\x20not\x20found\x20in\x20database');return;}console[_0x23c150(0x10b)]('üìä\x20[CHECK]\x20Payment\x20'+_0x1972cd+_0x23c150(0x146)),console['log'](_0x23c150(0x17b)+_0x106f63[_0x23c150(0x163)]),console[_0x23c150(0x10b)]('\x20\x20\x20-\x20Status:\x20'+_0x106f63['status']),console[_0x23c150(0x10b)](_0x23c150(0x196)+_0x106f63[_0x23c150(0x11b)]),console[_0x23c150(0x10b)](_0x23c150(0xc8)+_0x106f63['amount']+'\x20'+_0x106f63['currency']),console['log'](_0x23c150(0xa8)+_0x106f63[_0x23c150(0xaa)]);if(_0x106f63[_0x23c150(0x163)]!==_0x23c150(0xcd)&&_0x106f63[_0x23c150(0x163)]!==_0x23c150(0xd8)){console[_0x23c150(0x10b)](_0x23c150(0xea)+_0x1972cd+'\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20'+_0x106f63[_0x23c150(0x163)]+')');return;}if(_0x106f63[_0x23c150(0x1b2)]!==_0x23c150(0xdf)){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x1972cd+'\x20status\x20is\x20'+_0x106f63[_0x23c150(0x1b2)]+_0x23c150(0x188)),this['clearPaymentTimers'](_0x1972cd);return;}if(!_0x106f63[_0x23c150(0x11b)]){console['log'](_0x23c150(0xea)+_0x1972cd+_0x23c150(0xfd));return;}console['log'](_0x23c150(0x150)+_0x1972cd+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x23c150(0x17a)](_0x106f63);}[a38_0x5ce853(0x180)](_0x4b2ddd,_0x1b0bbf,_0x409136,_0x41f76b,_0x4333e3,_0x1f5146){const _0x256452=a38_0x5ce853,_0x410a14={'type':_0x256452(0x141),'paymentId':_0x4b2ddd,'gatewayPaymentId':_0x1b0bbf,'oldStatus':_0x409136,'newStatus':_0x41f76b,'source':_0x4333e3,'timestamp':new Date()['toISOString'](),'details':_0x1f5146||{}};loggerService_1[_0x256452(0xfa)][_0x256452(0x180)](_0x410a14),console[_0x256452(0x10b)](_0x256452(0xb8)+_0x4b2ddd+'\x20('+_0x1b0bbf+')'),console['log'](_0x256452(0x165)+_0x409136+'\x20->\x20'+_0x41f76b),console[_0x256452(0x10b)](_0x256452(0x14a)+_0x4333e3),console[_0x256452(0x10b)]('\x20\x20\x20üìÖ\x20Time:\x20'+_0x410a14['timestamp']),_0x1f5146&&console['log']('\x20\x20\x20üìù\x20Details:',_0x1f5146);}[a38_0x5ce853(0x153)](_0x476743,_0x2b821f,_0x41e92e,_0x373347,_0x408dc0){const _0xdde599=a38_0x5ce853,_0x5e1e70={'type':_0xdde599(0x183),'paymentId':_0x476743,'gatewayPaymentId':_0x2b821f,'error':_0x41e92e instanceof Error?{'message':_0x41e92e[_0xdde599(0x138)],'stack':_0x41e92e[_0xdde599(0x131)]}:_0x41e92e,'source':_0x373347,'timestamp':new Date()[_0xdde599(0x18f)](),'context':_0x408dc0||{}};loggerService_1[_0xdde599(0xfa)][_0xdde599(0x153)](_0x5e1e70),console['error']('ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x476743+'\x20('+_0x2b821f+')'),console['error'](_0xdde599(0xe8)+(_0x41e92e instanceof Error?_0x41e92e[_0xdde599(0x138)]:_0x41e92e)),console[_0xdde599(0x110)](_0xdde599(0x14a)+_0x373347),console[_0xdde599(0x110)](_0xdde599(0xd9)+_0x5e1e70['timestamp']),_0x408dc0&&console[_0xdde599(0x110)]('\x20\x20\x20üìù\x20Context:',_0x408dc0);}[a38_0x5ce853(0xe2)](){const _0x52629b=a38_0x5ce853;console[_0x52629b(0x10b)](_0x52629b(0x152)),this[_0x52629b(0x19d)]()[_0x52629b(0xce)](_0x540e05=>{const _0x1c1aae=_0x52629b;console[_0x1c1aae(0x110)]('‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x540e05);}),this[_0x52629b(0xbe)]=setInterval(async()=>{const _0x202869=_0x52629b;try{console['log'](_0x202869(0xf8)),await this['checkAllPendingPayments'](),console[_0x202869(0x10b)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x413ba1){console['error'](_0x202869(0xc7),_0x413ba1);}},this[_0x52629b(0x18e)]),console[_0x52629b(0x10b)](_0x52629b(0x14d));}[a38_0x5ce853(0x113)](){const _0x7c5cb2=a38_0x5ce853;console[_0x7c5cb2(0x10b)](_0x7c5cb2(0x124));this[_0x7c5cb2(0xbe)]&&(clearInterval(this[_0x7c5cb2(0xbe)]),this[_0x7c5cb2(0xbe)]=null,console[_0x7c5cb2(0x10b)]('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x896321=this['paymentTimers'][_0x7c5cb2(0xe1)];for(const [_0x5d88b2]of this[_0x7c5cb2(0x119)]){this[_0x7c5cb2(0xad)](_0x5d88b2);}console[_0x7c5cb2(0x10b)](_0x7c5cb2(0x136)+_0x896321+_0x7c5cb2(0x12f));}async[a38_0x5ce853(0x19d)](){const _0x2fa2ca=a38_0x5ce853;try{console['log'](_0x2fa2ca(0x179));const _0x44d8f0=await database_1[_0x2fa2ca(0xba)][_0x2fa2ca(0x12b)][_0x2fa2ca(0x15c)]({'where':{'gateway':{'in':[_0x2fa2ca(0xcd),_0x2fa2ca(0xd8)]},'status':_0x2fa2ca(0xdf),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x2fa2ca(0x154)+_0x44d8f0[_0x2fa2ca(0xda)]+'\x20pending\x20CoinToPay\x20payments');if(_0x44d8f0[_0x2fa2ca(0xda)]===0x0){console['log'](_0x2fa2ca(0x104));return;}const _0x4c97ce=await this[_0x2fa2ca(0xc9)](_0x44d8f0);console['log'](_0x2fa2ca(0xe7)+_0x4c97ce[_0x2fa2ca(0xda)]+_0x2fa2ca(0x170));let _0x3a709d=0x0,_0x5ed9ae=0x0;for(const _0x10e932 of _0x44d8f0){try{if(_0x4c97ce[_0x2fa2ca(0x109)](_0x10e932['id'])){console[_0x2fa2ca(0x10b)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x10e932['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x5ed9ae++;continue;}if(this[_0x2fa2ca(0x119)]['has'](_0x10e932['id'])){console[_0x2fa2ca(0x10b)](_0x2fa2ca(0x1af)+_0x10e932['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x5ed9ae++;continue;}const _0xb08f4b=(Date['now']()-_0x10e932[_0x2fa2ca(0xf7)][_0x2fa2ca(0x147)]())/(0x3e8*0x3c*0x3c);if(_0xb08f4b<0x1){console['log'](_0x2fa2ca(0x1af)+_0x10e932['id']+_0x2fa2ca(0x15f)+_0xb08f4b[_0x2fa2ca(0x112)](0x1)+_0x2fa2ca(0xb6)),_0x5ed9ae++;continue;}console['log'](_0x2fa2ca(0x18a)+_0x10e932['id']+_0x2fa2ca(0x15b)+_0xb08f4b[_0x2fa2ca(0x112)](0x1)+'h)'),await this['checkSinglePayment'](_0x10e932),_0x3a709d++,await new Promise(_0x648e12=>setTimeout(_0x648e12,0x7d0));}catch(_0x2c2439){console[_0x2fa2ca(0x110)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x10e932['id']+':',_0x2c2439),this[_0x2fa2ca(0x153)](_0x10e932['id'],_0x10e932[_0x2fa2ca(0x11b)]||_0x2fa2ca(0x111),_0x2c2439,_0x2fa2ca(0xef),{'isGlobalCheck':!![],'paymentAmount':_0x10e932['amount'],'paymentCurrency':_0x10e932[_0x2fa2ca(0xcf)],'shopId':_0x10e932['shopId'],'createdAt':_0x10e932[_0x2fa2ca(0xf7)]}),loggerService_1['loggerService']['logWhiteDomainError'](_0x2fa2ca(0xcd),_0x2fa2ca(0x17d)+_0x10e932[_0x2fa2ca(0x11b)],_0x2c2439);}}console[_0x2fa2ca(0x10b)](_0x2fa2ca(0xcc)+_0x3a709d+_0x2fa2ca(0xbd)+_0x5ed9ae+_0x2fa2ca(0xd6)+_0x4c97ce['length']+_0x2fa2ca(0xd2));}catch(_0x190bd3){console[_0x2fa2ca(0x110)](_0x2fa2ca(0x16e),_0x190bd3);}}async[a38_0x5ce853(0xc9)](_0x2b6553){const _0x48b6cb=a38_0x5ce853,_0x3860b2=[],_0x43192b=new Date();_0x43192b['setDate'](_0x43192b[_0x48b6cb(0xe6)]()-this[_0x48b6cb(0x122)]),console[_0x48b6cb(0x10b)]('‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x48b6cb(0x122)]+_0x48b6cb(0x10f)+_0x43192b[_0x48b6cb(0x18f)]()+')');for(const _0x19d4a0 of _0x2b6553){if(_0x19d4a0[_0x48b6cb(0xf7)]<_0x43192b){console[_0x48b6cb(0x10b)]('‚è∞\x20[EXPIRY]\x20Payment\x20'+_0x19d4a0['id']+_0x48b6cb(0x108)+this['EXPIRY_DAYS']+_0x48b6cb(0x185));try{this[_0x48b6cb(0x180)](_0x19d4a0['id'],_0x19d4a0[_0x48b6cb(0x11b)]||_0x48b6cb(0x111),_0x48b6cb(0xdf),_0x48b6cb(0x142),_0x48b6cb(0xa7),{'reason':'Payment\x20older\x20than\x20'+this[_0x48b6cb(0x122)]+_0x48b6cb(0x102),'createdAt':_0x19d4a0[_0x48b6cb(0xf7)],'daysSinceCreation':Math[_0x48b6cb(0xfb)]((Date[_0x48b6cb(0x12c)]()-_0x19d4a0['createdAt'][_0x48b6cb(0x147)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x19d4a0[_0x48b6cb(0x10c)],'paymentCurrency':_0x19d4a0[_0x48b6cb(0xcf)],'shopId':_0x19d4a0[_0x48b6cb(0xaa)]}),await database_1[_0x48b6cb(0xba)][_0x48b6cb(0x12b)][_0x48b6cb(0xf6)]({'where':{'id':_0x19d4a0['id']},'data':{'status':_0x48b6cb(0x142),'updatedAt':new Date(),'adminNotes':_0x48b6cb(0x103)+this[_0x48b6cb(0x122)]+_0x48b6cb(0x1a9)}}),await database_1[_0x48b6cb(0xba)][_0x48b6cb(0x10a)][_0x48b6cb(0x182)]({'data':{'paymentId':_0x19d4a0['id'],'shopId':_0x19d4a0[_0x48b6cb(0xaa)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x48b6cb(0x115)]({'reason':_0x48b6cb(0xcb)+this[_0x48b6cb(0x122)]+'\x20days','createdAt':_0x19d4a0['createdAt'],'expiredAt':new Date()[_0x48b6cb(0x18f)](),'daysSinceCreation':Math['floor']((Date[_0x48b6cb(0x12c)]()-_0x19d4a0['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x48b6cb(0x11d)](_0x19d4a0,'EXPIRED'),await this['sendPaymentStatusNotification'](_0x19d4a0,_0x48b6cb(0x142)),this[_0x48b6cb(0xad)](_0x19d4a0['id']),_0x3860b2[_0x48b6cb(0x199)](_0x19d4a0['id']),console[_0x48b6cb(0x10b)]('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x19d4a0['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x48b6cb(0x122)]+_0x48b6cb(0xe9));}catch(_0x3b800a){console[_0x48b6cb(0x110)](_0x48b6cb(0xc4)+_0x19d4a0['id']+':',_0x3b800a),this[_0x48b6cb(0x153)](_0x19d4a0['id'],_0x19d4a0['gatewayPaymentId']||_0x48b6cb(0x111),_0x3b800a,'auto_expire',{'reason':_0x48b6cb(0xca),'createdAt':_0x19d4a0[_0x48b6cb(0xf7)],'daysSinceCreation':Math[_0x48b6cb(0xfb)]((Date[_0x48b6cb(0x12c)]()-_0x19d4a0['createdAt'][_0x48b6cb(0x147)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x3860b2;}async[a38_0x5ce853(0x17a)](_0x3e6fa6){const _0x3e5f83=a38_0x5ce853;if(!_0x3e6fa6[_0x3e5f83(0x11b)]){console[_0x3e5f83(0x10b)](_0x3e5f83(0xea)+_0x3e6fa6['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console['log'](_0x3e5f83(0x114)+_0x3e6fa6[_0x3e5f83(0x163)]+_0x3e5f83(0x123)+_0x3e6fa6['id']+'\x20('+_0x3e6fa6[_0x3e5f83(0x11b)]+')');try{let _0x43c129;_0x3e6fa6[_0x3e5f83(0x163)]===_0x3e5f83(0xd8)?(_0x43c129=await this[_0x3e5f83(0x191)]['checkPaymentStatus'](_0x3e6fa6[_0x3e5f83(0x11b)]),console['log']('üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x3e6fa6['id']+'\x20status:\x20'+_0x43c129['status'])):(_0x43c129=await this[_0x3e5f83(0x121)][_0x3e5f83(0xac)](_0x3e6fa6[_0x3e5f83(0x11b)]),console[_0x3e5f83(0x10b)]('üìä\x20[CHECK]\x20CoinToPay\x20payment\x20'+_0x3e6fa6['id']+_0x3e5f83(0x10d)+_0x43c129['status']));_0x43c129[_0x3e5f83(0x1ac)]&&console[_0x3e5f83(0x10b)](_0x3e5f83(0x125)+_0x3e6fa6['id']+_0x3e5f83(0x16d),{'iban':_0x43c129['paymentDetails'][_0x3e5f83(0x176)]||_0x3e5f83(0x190),'transactionId':_0x43c129['paymentDetails'][_0x3e5f83(0x184)],'createdOn':_0x43c129[_0x3e5f83(0x1ac)]['createdOn'],'confirmedOn':_0x43c129[_0x3e5f83(0x1ac)][_0x3e5f83(0xe0)]||_0x3e5f83(0x166)});if(_0x43c129[_0x3e5f83(0x1b2)]!==_0x3e6fa6['status']){console[_0x3e5f83(0x10b)](_0x3e5f83(0x130)+_0x3e6fa6['id']+_0x3e5f83(0xc3)+_0x3e6fa6[_0x3e5f83(0x1b2)]+_0x3e5f83(0x13a)+_0x43c129[_0x3e5f83(0x1b2)]),this['logCoinToPayStatus'](_0x3e6fa6['id'],_0x3e6fa6[_0x3e5f83(0x11b)],_0x3e6fa6[_0x3e5f83(0x1b2)],_0x43c129[_0x3e5f83(0x1b2)],_0x3e5f83(0xef),{'paymentDetails':_0x43c129[_0x3e5f83(0x1ac)],'amount':_0x43c129[_0x3e5f83(0x10c)],'currency':_0x43c129[_0x3e5f83(0xcf)],'shopId':_0x3e6fa6[_0x3e5f83(0xaa)],'checkTimestamp':new Date()[_0x3e5f83(0x18f)]()});const _0x2eb5ec={'status':_0x43c129[_0x3e5f83(0x1b2)],'updatedAt':new Date()};if(_0x43c129[_0x3e5f83(0x1b2)]==='PAID'&&_0x3e6fa6[_0x3e5f83(0x1b2)]!==_0x3e5f83(0xb7)){_0x2eb5ec[_0x3e5f83(0xed)]=new Date();if(!_0x3e6fa6['amountUSDT']){const _0x2e41bc=await currencyService_1['currencyService']['convertToUSDT'](_0x3e6fa6['amount'],_0x3e6fa6[_0x3e5f83(0xcf)]);_0x2eb5ec[_0x3e5f83(0xb9)]=_0x2e41bc;const _0x15bc00=await this[_0x3e5f83(0xd3)](_0x3e6fa6[_0x3e5f83(0xaa)],_0x3e6fa6[_0x3e5f83(0x163)]),_0x4797df=_0x2e41bc*(0x1-_0x15bc00/0x64);_0x2eb5ec[_0x3e5f83(0xbc)]=_0x4797df,console[_0x3e5f83(0x10b)](_0x3e5f83(0x186)+_0x3e6fa6['id']+'\x20amounts\x20calculated:'),console[_0x3e5f83(0x10b)](_0x3e5f83(0x19e)+_0x3e6fa6[_0x3e5f83(0x10c)]+'\x20'+_0x3e6fa6[_0x3e5f83(0xcf)]+_0x3e5f83(0xb2)+_0x2e41bc[_0x3e5f83(0x112)](0x6)+_0x3e5f83(0x11e)),console[_0x3e5f83(0x10b)](_0x3e5f83(0xa6)+_0x3e6fa6[_0x3e5f83(0x163)]+_0x3e5f83(0x139)+_0x15bc00+'%'),console['log'](_0x3e5f83(0x14c)+_0x4797df['toFixed'](0x6)+_0x3e5f83(0x11e));}console[_0x3e5f83(0x10b)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x3e6fa6['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x2eb5ec[_0x3e5f83(0xed)][_0x3e5f83(0x18f)]());}if(_0x43c129[_0x3e5f83(0x1ac)]){const _0x2c4941=_0x43c129[_0x3e5f83(0x1ac)];_0x2c4941[_0x3e5f83(0x176)]&&(_0x2eb5ec[_0x3e5f83(0x156)]=_0x2c4941[_0x3e5f83(0x176)],console['log'](_0x3e5f83(0x107)+_0x2c4941['iban']));if(_0x2c4941[_0x3e5f83(0x173)]){const _0x12c278=_0x3e6fa6[_0x3e5f83(0x161)]||'',_0x358414=_0x3e5f83(0x137)+_0x2c4941[_0x3e5f83(0x173)];_0x2eb5ec[_0x3e5f83(0x161)]=_0x12c278?_0x12c278+'\x0a\x0a'+_0x358414:_0x358414,console[_0x3e5f83(0x10b)]('üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x2c4941[_0x3e5f83(0x184)]&&console[_0x3e5f83(0x10b)](_0x3e5f83(0xc5)+_0x2c4941['transactionId']),_0x2c4941[_0x3e5f83(0xe0)]&&console[_0x3e5f83(0x10b)](_0x3e5f83(0xc6)+_0x2c4941['confirmedOn']);}await database_1[_0x3e5f83(0xba)][_0x3e5f83(0x12b)][_0x3e5f83(0xf6)]({'where':{'id':_0x3e6fa6['id']},'data':_0x2eb5ec});if(_0x43c129[_0x3e5f83(0x1b2)]==='PAID'&&_0x3e6fa6[_0x3e5f83(0x1b2)]!==_0x3e5f83(0xb7)){console[_0x3e5f83(0x10b)](_0x3e5f83(0x15a)+_0x3e6fa6['id']+_0x3e5f83(0x100));const _0x5af744=await database_1[_0x3e5f83(0xba)][_0x3e5f83(0x12b)][_0x3e5f83(0xaf)]({'where':{'id':_0x3e6fa6['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x5af744?.[_0x3e5f83(0xb5)]&&_0x5af744['paymentLink'])try{const _0x53a00e=_0x5af744[_0x3e5f83(0x17f)];console[_0x3e5f83(0x10b)]('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x53a00e['id']+':\x20type='+_0x53a00e[_0x3e5f83(0x17e)]+',\x20currentPayments='+_0x53a00e['currentPayments']+_0x3e5f83(0xab)+_0x53a00e[_0x3e5f83(0x1b2)]);const _0x1085ee=_0x53a00e[_0x3e5f83(0x19f)]+0x1,_0x28f867=_0x53a00e['type']===_0x3e5f83(0x1a5)?'COMPLETED':_0x53a00e[_0x3e5f83(0x1b2)];await database_1[_0x3e5f83(0xba)][_0x3e5f83(0x17f)][_0x3e5f83(0xf6)]({'where':{'id':_0x53a00e['id']},'data':{'currentPayments':_0x1085ee,'status':_0x28f867,'updatedAt':new Date()}}),console[_0x3e5f83(0x10b)](_0x3e5f83(0xbf)+_0x53a00e['id']+_0x3e5f83(0x14b)+_0x53a00e[_0x3e5f83(0x19f)]+_0x3e5f83(0xb2)+_0x1085ee+_0x3e5f83(0xab)+_0x53a00e['status']+_0x3e5f83(0xb2)+_0x28f867);}catch(_0x1e7005){console[_0x3e5f83(0x110)](_0x3e5f83(0xc2),_0x1e7005);}else console[_0x3e5f83(0x10b)](_0x3e5f83(0x15a)+_0x3e6fa6['id']+_0x3e5f83(0x198));}await database_1[_0x3e5f83(0xba)][_0x3e5f83(0x10a)][_0x3e5f83(0x182)]({'data':{'paymentId':_0x3e6fa6['id'],'shopId':_0x3e6fa6['shopId'],'event':_0x3e5f83(0x18d)+_0x43c129[_0x3e5f83(0x1b2)][_0x3e5f83(0x1a1)](),'statusCode':0xc8,'responseBody':JSON[_0x3e5f83(0x115)]({'oldStatus':_0x3e6fa6['status'],'newStatus':_0x43c129[_0x3e5f83(0x1b2)],'paymentDetails':_0x43c129['paymentDetails'],'checkedAt':new Date()[_0x3e5f83(0x18f)]()})}}),await this['sendShopWebhook'](_0x3e6fa6,_0x43c129['status']),await this[_0x3e5f83(0xc0)](_0x3e6fa6,_0x43c129[_0x3e5f83(0x1b2)]),_0x43c129['status']!==_0x3e5f83(0xdf)&&(console[_0x3e5f83(0x10b)](_0x3e5f83(0x120)+_0x3e6fa6['id']+_0x3e5f83(0x18b)+_0x43c129[_0x3e5f83(0x1b2)]+',\x20clearing\x20individual\x20timers'),this[_0x3e5f83(0xad)](_0x3e6fa6['id'])),console[_0x3e5f83(0x10b)](_0x3e5f83(0x150)+_0x3e6fa6['id']+_0x3e5f83(0x160));}else console['log'](_0x3e5f83(0x125)+_0x3e6fa6['id']+'\x20status\x20unchanged\x20('+_0x43c129[_0x3e5f83(0x1b2)]+')'),this['logCoinToPayStatus'](_0x3e6fa6['id'],_0x3e6fa6[_0x3e5f83(0x11b)],_0x3e6fa6['status'],_0x43c129[_0x3e5f83(0x1b2)],_0x3e5f83(0xef),{'statusUnchanged':!![],'paymentDetails':_0x43c129[_0x3e5f83(0x1ac)],'amount':_0x43c129[_0x3e5f83(0x10c)],'currency':_0x43c129['currency'],'shopId':_0x3e6fa6[_0x3e5f83(0xaa)],'checkTimestamp':new Date()[_0x3e5f83(0x18f)]()});}catch(_0x280e46){console[_0x3e5f83(0x110)](_0x3e5f83(0xfe)+_0x3e6fa6['id']+':',_0x280e46),this[_0x3e5f83(0x153)](_0x3e6fa6['id'],_0x3e6fa6[_0x3e5f83(0x11b)],_0x280e46,_0x3e5f83(0xef),{'paymentAmount':_0x3e6fa6[_0x3e5f83(0x10c)],'paymentCurrency':_0x3e6fa6[_0x3e5f83(0xcf)],'shopId':_0x3e6fa6[_0x3e5f83(0xaa)],'createdAt':_0x3e6fa6[_0x3e5f83(0xf7)]}),await database_1[_0x3e5f83(0xba)][_0x3e5f83(0x10a)]['create']({'data':{'paymentId':_0x3e6fa6['id'],'shopId':_0x3e6fa6[_0x3e5f83(0xaa)],'event':_0x3e5f83(0xf9),'statusCode':0x1f4,'responseBody':JSON[_0x3e5f83(0x115)]({'error':_0x280e46 instanceof Error?_0x280e46['message']:'Unknown\x20error','gatewayPaymentId':_0x3e6fa6[_0x3e5f83(0x11b)],'checkedAt':new Date()['toISOString']()})}});}}async['sendShopWebhook'](_0x40d302,_0x3a67bc){const _0x23a093=a38_0x5ce853,_0x3daba2=Date[_0x23a093(0x12c)]();try{const _0x17f326=_0x40d302['shop'],_0x307822=_0x17f326[_0x23a093(0x140)];if(!_0x307822?.[_0x23a093(0x1a8)]){console['log'](_0x23a093(0x193)+_0x17f326['id']);return;}const _0x992fc2=_0x3a67bc===_0x23a093(0xb7)?_0x23a093(0x178):_0x3a67bc===_0x23a093(0x159)?_0x23a093(0xf5):_0x3a67bc===_0x23a093(0x142)?_0x23a093(0xf5):_0x23a093(0x1a6);if(!_0x307822[_0x23a093(0x145)]?.[_0x23a093(0x109)](_0x992fc2)){console[_0x23a093(0x10b)](_0x23a093(0x1a0)+_0x992fc2+'\x20not\x20enabled\x20for\x20shop\x20'+_0x17f326['id']);return;}const _0x1110ec=(0x0,gateway_1[_0x23a093(0x11f)])(_0x40d302['gateway'])||_0x40d302[_0x23a093(0x163)],_0x497086={'event':_0x992fc2,'payment':{'id':_0x40d302['id'],'order_id':_0x40d302[_0x23a093(0x189)],'gateway_order_id':_0x40d302[_0x23a093(0x14e)],'gateway':_0x1110ec,'amount':_0x40d302['amount'],'currency':_0x40d302[_0x23a093(0xcf)],'status':_0x3a67bc['toLowerCase'](),'customer_email':_0x40d302['customerEmail'],'customer_name':_0x40d302[_0x23a093(0xfc)],'created_at':_0x40d302[_0x23a093(0xf7)],'updated_at':new Date()}},_0x2073bf=await fetch(_0x307822[_0x23a093(0x1a8)],{'method':_0x23a093(0x1ab),'headers':{'Content-Type':_0x23a093(0x169),'User-Agent':_0x23a093(0x151)},'body':JSON[_0x23a093(0x115)](_0x497086)}),_0x2b1167=Date['now']()-_0x3daba2,_0x40f5ba=_0x2073bf['ok']?_0x23a093(0x1b4):await _0x2073bf[_0x23a093(0x14f)]();loggerService_1[_0x23a093(0xfa)][_0x23a093(0x168)](_0x40d302[_0x23a093(0xaa)],_0x307822['webhookUrl'],_0x992fc2,_0x2073bf['status'],_0x2b1167,_0x497086),console['log'](_0x23a093(0xa9)+_0x307822[_0x23a093(0x1a8)]+_0x23a093(0x13f)+_0x2073bf[_0x23a093(0x1b2)]+'\x20('+_0x2b1167+_0x23a093(0xeb));}catch(_0x23e85d){console[_0x23a093(0x110)](_0x23a093(0x133),_0x23e85d),loggerService_1[_0x23a093(0xfa)][_0x23a093(0xa5)](_0x40d302[_0x23a093(0xaa)],_0x40d302[_0x23a093(0x16f)]?.[_0x23a093(0x140)]?.[_0x23a093(0x1a8)]||'unknown',_0x23a093(0x18c),_0x23e85d,{});}}async['sendPaymentStatusNotification'](_0x13208c,_0x128372){const _0x4774ec=a38_0x5ce853;try{const _0x3da3b8={'PENDING':_0x4774ec(0x106),'PAID':_0x4774ec(0x1b3),'FAILED':_0x4774ec(0x13b),'EXPIRED':_0x4774ec(0xf2)},_0x280c99=_0x3da3b8[_0x128372];if(!_0x280c99||_0x280c99===_0x4774ec(0x106))return;await telegramBotService_1[_0x4774ec(0xf4)][_0x4774ec(0x1ae)](_0x13208c[_0x4774ec(0xaa)],_0x13208c,_0x280c99);}catch(_0x1d1dd2){console['error'](_0x4774ec(0x1aa),_0x1d1dd2);}}async[a38_0x5ce853(0x181)](_0x4fda17){const _0xa30d69=a38_0x5ce853;console[_0xa30d69(0x10b)](_0xa30d69(0xb3)+_0x4fda17);const _0x52503c=await database_1[_0xa30d69(0xba)][_0xa30d69(0x12b)][_0xa30d69(0xaf)]({'where':{'id':_0x4fda17},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x52503c)throw new Error(_0xa30d69(0xff));if(_0x52503c['gateway']!=='cointopay'&&_0x52503c[_0xa30d69(0x163)]!==_0xa30d69(0xd8))throw new Error(_0xa30d69(0x194));console[_0xa30d69(0x10b)](_0xa30d69(0x167)+_0x52503c[_0xa30d69(0x163)]+_0xa30d69(0x123)+_0x4fda17),await this[_0xa30d69(0x17a)](_0x52503c),console[_0xa30d69(0x10b)](_0xa30d69(0x13e)+_0x4fda17);}['getServiceStats'](){const _0x94c23a=a38_0x5ce853,_0xe8c73c=this['globalCheckInterval']?this[_0x94c23a(0x18e)]:undefined,_0x3d7f4b=Array[_0x94c23a(0x11c)](this[_0x94c23a(0x119)][_0x94c23a(0xb0)]())[_0x94c23a(0x171)](_0x2f8d1b=>({'paymentId':_0x2f8d1b[_0x94c23a(0xde)],'gatewayPaymentId':_0x2f8d1b[_0x94c23a(0x11b)],'createdAt':_0x2f8d1b[_0x94c23a(0xf7)],'timersCount':_0x2f8d1b[_0x94c23a(0x128)]['length']}));return{'isActive':!!this[_0x94c23a(0xbe)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x94c23a(0x122)],'activeIndividualTimers':this['paymentTimers'][_0x94c23a(0xe1)],'nextGlobalCheckIn':_0xe8c73c,'paymentTimersDetails':_0x3d7f4b};}[a38_0x5ce853(0x1b1)](_0x31f7d5){const _0x54dc9d=a38_0x5ce853,_0x216edd=this[_0x54dc9d(0x119)][_0x54dc9d(0x134)](_0x31f7d5);if(_0x216edd)return{'hasTimers':!![],'timersCount':_0x216edd[_0x54dc9d(0x128)][_0x54dc9d(0xda)],'createdAt':_0x216edd['createdAt'],'gatewayPaymentId':_0x216edd['gatewayPaymentId']};return{'hasTimers':![]};}async['getGatewayCommission'](_0x2c2f3b,_0x502b38){const _0x4104b9=a38_0x5ce853;try{const _0x3666b8=await database_1[_0x4104b9(0xba)][_0x4104b9(0x16f)][_0x4104b9(0xaf)]({'where':{'id':_0x2c2f3b},'select':{'gatewaySettings':!![]}});if(!_0x3666b8?.[_0x4104b9(0x16a)])return console[_0x4104b9(0x10b)](_0x4104b9(0xee)+_0x2c2f3b+_0x4104b9(0x12d)),0xa;const _0x18c8cb=JSON['parse'](_0x3666b8['gatewaySettings']);for(const [_0x2b7a65,_0x109b3c]of Object[_0x4104b9(0x195)](_0x18c8cb)){if(_0x2b7a65['toLowerCase']()===_0x502b38[_0x4104b9(0x1a1)]()){const _0x21ad9c=_0x109b3c[_0x4104b9(0x118)]||0xa;return console[_0x4104b9(0x10b)](_0x4104b9(0x116)+_0x502b38+'\x20commission\x20for\x20shop\x20'+_0x2c2f3b+':\x20'+_0x21ad9c+'%'),_0x21ad9c;}}return console[_0x4104b9(0x10b)](_0x4104b9(0x157)+_0x502b38+_0x4104b9(0x148)+_0x2c2f3b+_0x4104b9(0xec)),0xa;}catch(_0x4445ea){return console[_0x4104b9(0x110)](_0x4104b9(0x101)+_0x2c2f3b+_0x4104b9(0x175)+_0x502b38+':',_0x4445ea),0xa;}}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a38_0x5ce853(0x129)]=new CoinToPayStatusService();