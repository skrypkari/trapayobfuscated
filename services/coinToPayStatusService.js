'use strict';function a37_0x5737(){const _0x257655=['\x20status\x20unchanged\x20(','‚è∞\x20[GLOBAL]\x20Payment\x20','delay','‚è∞\x20[HOURLY]\x20Payment\x20','loggerService','checkExpiredPayments','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','/status/','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20\x20\x20-\x20GatewayPaymentId:\x20','schedule_created','toFixed','unknown','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','create','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20\x20\x20‚ùå\x20Error:\x20','\x20->\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','getPaymentTimerInfo','\x20(after\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','‚ùå\x20[CHECK]\x20Payment\x20','__esModule','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','adminNotes','\x20expired\x20CoinToPay\x20payments','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20pending\x20CoinToPay\x20payments','\x20\x20\x20üìä\x20Status:\x20','Unknown\x20error','timers','\x20to\x20clear','Payment\x20not\x20found','sendPaymentStatusNotification','./telegramBotService','6092910RfuXXN','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','paymentDetails','shopId','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','‚úÖ\x20[CHECK]\x20Payment\x20','floor','Bank\x20Details:\x20','confirmedOn','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','now','üìä\x20[CHECK]\x20Payment\x20','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','findUnique','toLowerCase','\x20\x20\x20üìù\x20Details:','webhookUrl','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','application/json','‚úÖ\x20[EXPIRY]\x20Payment\x20','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','‚úÖ\x20[HOURLY]\x20Payment\x20','\x20\x20\x20-\x20paymentId:\x20','catch','sendPaymentNotification','gatewayPaymentId','transactionId','FAILED','checkAllPendingPayments','__importDefault',',\x20stopping\x20individual\x20checks','globalCheckInterval','1\x20minute','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','coinToPayService','settings','\x20\x20\x20üìù\x20Context:','failed','toISOString','\x20initial\x20timers\x20for\x20payment\x20','h),\x20skipping\x20global\x20check','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20status:\x20','707640zVtkgF','\x20status\x20from\x20','\x20days','startPeriodicStatusCheck','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','üí∞\x20[CHECK]\x20Payment\x20','description','default','0100','stopPeriodicStatusCheck','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','created','\x20\x20\x20üìÖ\x20Time:\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','coinToPayStatusService','1818lnkPeU','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20days\x20without\x20payment\x20confirmation','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20completed\x20for\x20payment\x20','-day\x20timeout','\x20current\x20status:\x20','clearPaymentTimers',',\x20clearing\x20individual\x20timers','stringify','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','405007EMGPdI','PENDING','Webhook\x20event\x20','logCoinToPayError','\x20triggered\x20for\x20payment\x20','has','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','69044YzkdYJ','\x20seconds\x20(','payment.success','COINTOPAY_ERROR','cointopay_status_check_','map','delete','from','\x20is\x20older\x20than\x20','error','getTime','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','getDate','gatewayOrderId','payment.pending','12732680wRaqYk','update','Failed\x20to\x20mark\x20payment\x20as\x20expired','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','\x20details:','‚è∞\x20[EXPIRY]\x20Payment\x20','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','5\x20minutes','ü™ô\x20[DEBUG]\x20Creating\x20','orderId','.\x20Remaining\x20active\x20timers:\x20','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','../config/database','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','checkSinglePayment','length','ms)','paidAt','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','payment.failed','size','\x20skipped,\x20','checkPaymentStatus','checkSinglePaymentById','payment','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','createdAt','EXPIRED','2PuyDPw','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','Shop\x20webhook\x20sent\x20to\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','./gateways/coinToPayService','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','paymentTimers','currency','push','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','PAID','findMany','shop','amount','getServiceStats','2983288QYXXJv','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20not\x20found\x20in\x20database','\x20\x20\x20-\x20Gateway:\x20','defineProperty','cointopay_status_check_error','bankDetails','webhookLog','paymentId','ü™ô\x20[GLOBAL]\x20Found\x20','3199fJXqRY','55SGcvbn','\x20expired','status','iban','\x20\x20\x20üìç\x20Source:\x20','CoinToPayStatusService','includes','\x20updated\x20successfully','\x20in\x20','üìä\x20[HOURLY]\x20Payment\x20','message','\x20with\x20status\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20found:','not\x20confirmed','log','üõë\x20[SHUTDOWN]\x20Cleared\x20','set','get','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','\x20individual\x20payment\x20timers','\x20is\x20valid\x20for\x20checking,\x20proceeding...','forEach','auto_expire','logShopWebhookSent','timestamp','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20is\x20too\x20new\x20(','gateway','logShopWebhookError','logCoinToPayStatus','‚ùå\x20[HOURLY]\x20Payment\x20','\x20for\x20payment\x20','sendShopWebhook','Payment\x20older\x20than\x20','customerName','GLOBAL_CHECK_INTERVAL_MS','cointopay','EXPIRY_DAYS','Automatically\x20expired\x20after\x20','customerEmail','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','‚è∞\x20[GLOBAL]\x20Found\x20','status_check'];a37_0x5737=function(){return _0x257655;};return a37_0x5737();}const a37_0x2fd69a=a37_0x1295;(function(_0x3ccb0c,_0x1ebe7d){const _0xce43fb=a37_0x1295,_0x4abc97=_0x3ccb0c();while(!![]){try{const _0x2188fb=parseInt(_0xce43fb(0x28f))/0x1+-parseInt(_0xce43fb(0x1dc))/0x2*(-parseInt(_0xce43fb(0x274))/0x3)+-parseInt(_0xce43fb(0x1b0))/0x4*(parseInt(_0xce43fb(0x1f6))/0x5)+-parseInt(_0xce43fb(0x283))/0x6*(-parseInt(_0xce43fb(0x1f5))/0x7)+parseInt(_0xce43fb(0x1eb))/0x8+parseInt(_0xce43fb(0x248))/0x9+-parseInt(_0xce43fb(0x1bf))/0xa;if(_0x2188fb===_0x1ebe7d)break;else _0x4abc97['push'](_0x4abc97['shift']());}catch(_0x3f2a06){_0x4abc97['push'](_0x4abc97['shift']());}}}(a37_0x5737,0x59628));var __importDefault=this&&this[a37_0x2fd69a(0x266)]||function(_0x179112){const _0x11c457=a37_0x2fd69a;return _0x179112&&_0x179112[_0x11c457(0x23b)]?_0x179112:{'default':_0x179112};};Object[a37_0x2fd69a(0x1ef)](exports,'__esModule',{'value':!![]}),exports[a37_0x2fd69a(0x282)]=exports[a37_0x2fd69a(0x1fb)]=void 0x0;const coinToPayService_1=require(a37_0x2fd69a(0x1e0)),database_1=__importDefault(require(a37_0x2fd69a(0x1cb))),telegramBotService_1=require(a37_0x2fd69a(0x247)),loggerService_1=require('./loggerService');function a37_0x1295(_0x2d9996,_0x33fa46){const _0x573735=a37_0x5737();return a37_0x1295=function(_0x12954d,_0x24ef51){_0x12954d=_0x12954d-0x1ae;let _0x369df4=_0x573735[_0x12954d];return _0x369df4;},a37_0x1295(_0x2d9996,_0x33fa46);}class CoinToPayStatusService{constructor(){const _0x11e201=a37_0x2fd69a;this[_0x11e201(0x268)]=null,this[_0x11e201(0x21b)]=0x3c*0x3c*0x3e8,this[_0x11e201(0x21d)]=0x5,this[_0x11e201(0x1e2)]=new Map(),this[_0x11e201(0x26b)]=new coinToPayService_1['CoinToPayService'](),console['log']('ü™ô\x20CoinToPayStatusService\x20initialized');}['schedulePaymentChecks'](_0x1447c6,_0x5395a6){const _0x484333=a37_0x2fd69a;console[_0x484333(0x205)](_0x484333(0x211)),console[_0x484333(0x205)](_0x484333(0x25f)+_0x1447c6),console[_0x484333(0x205)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x5395a6),this[_0x484333(0x28b)](_0x1447c6);const _0x48f256=[],_0x29beaa=new Date(),_0x2c2ce7=[{'delay':0x1*0x3c*0x3e8,'description':_0x484333(0x269)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x484333(0x1c6)}];console['log'](_0x484333(0x1c7)+_0x2c2ce7['length']+_0x484333(0x270)+_0x1447c6);let _0x345483=0x0;_0x2c2ce7[_0x484333(0x20d)]((_0x253975,_0x1d28ea)=>{const _0x14efa3=_0x484333;_0x345483+=_0x253975[_0x14efa3(0x225)];const _0x1cca6b=setTimeout(async()=>{const _0x2a054a=_0x14efa3;console[_0x2a054a(0x205)](_0x2a054a(0x25a)+(_0x1d28ea+0x1)+_0x2a054a(0x293)+_0x1447c6+_0x2a054a(0x238)+_0x253975['description']+')');try{await this[_0x2a054a(0x1d7)](_0x1447c6),console['log'](_0x2a054a(0x231)+(_0x1d28ea+0x1)+_0x2a054a(0x288)+_0x1447c6);}catch(_0x4c7dbd){console['error']('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x1d28ea+0x1)+_0x2a054a(0x217)+_0x1447c6+':',_0x4c7dbd),this[_0x2a054a(0x292)](_0x1447c6,_0x5395a6,_0x4c7dbd,_0x2a054a(0x222),{'checkNumber':_0x1d28ea+0x1,'scheduledAfter':_0x253975[_0x2a054a(0x27a)],'isIndividualCheck':!![]});}},_0x345483);_0x48f256[_0x14efa3(0x1e4)](_0x1cca6b),console[_0x14efa3(0x205)](_0x14efa3(0x24d)+(_0x1d28ea+0x1)+'\x20for\x20payment\x20'+_0x1447c6+_0x14efa3(0x1fe)+_0x345483/0x3e8+_0x14efa3(0x1b1)+_0x253975[_0x14efa3(0x27a)]+')');});const _0x1e3f07=setInterval(async()=>{const _0x449c54=_0x484333;console[_0x449c54(0x205)](_0x449c54(0x1d2)+_0x1447c6);try{const _0x197a06=await database_1['default']['payment']['findUnique']({'where':{'id':_0x1447c6},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x197a06){console[_0x449c54(0x205)](_0x449c54(0x216)+_0x1447c6+'\x20not\x20found,\x20clearing\x20timers'),this[_0x449c54(0x28b)](_0x1447c6);return;}console[_0x449c54(0x205)](_0x449c54(0x1ff)+_0x1447c6+_0x449c54(0x28a)+_0x197a06[_0x449c54(0x1f8)]);if(_0x197a06['status']!==_0x449c54(0x290)){console[_0x449c54(0x205)](_0x449c54(0x25e)+_0x1447c6+'\x20status\x20is\x20'+_0x197a06[_0x449c54(0x1f8)]+',\x20stopping\x20individual\x20checks'),this[_0x449c54(0x28b)](_0x1447c6);return;}const _0x3618fd=Math[_0x449c54(0x24f)]((Date['now']()-_0x197a06['createdAt'][_0x449c54(0x1ba)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x3618fd>=this[_0x449c54(0x21d)]){console['log'](_0x449c54(0x226)+_0x1447c6+_0x449c54(0x1b8)+this[_0x449c54(0x21d)]+_0x449c54(0x1bb)),this[_0x449c54(0x28b)](_0x1447c6);return;}await this[_0x449c54(0x1d7)](_0x1447c6),console[_0x449c54(0x205)](_0x449c54(0x26a)+_0x1447c6);}catch(_0x22e548){console[_0x449c54(0x1b9)](_0x449c54(0x209)+_0x1447c6+':',_0x22e548),this['logCoinToPayError'](_0x1447c6,_0x5395a6,_0x22e548,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x48f256[_0x484333(0x1e4)](_0x1e3f07),this['paymentTimers'][_0x484333(0x207)](_0x1447c6,{'timers':_0x48f256,'paymentId':_0x1447c6,'gatewayPaymentId':_0x5395a6,'createdAt':_0x29beaa}),console[_0x484333(0x205)]('‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x2c2ce7[_0x484333(0x1ce)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x1447c6),console[_0x484333(0x205)](_0x484333(0x249)+this[_0x484333(0x1e2)]['size']),this[_0x484333(0x215)](_0x1447c6,_0x5395a6,_0x484333(0x290),_0x484333(0x290),_0x484333(0x222),{'action':_0x484333(0x22d),'scheduledChecks':_0x2c2ce7[_0x484333(0x1ce)],'firstCheckIn':_0x2c2ce7[0x0]['delay']/0x3e8,'totalTimers':this[_0x484333(0x1e2)][_0x484333(0x1d4)]});}[a37_0x2fd69a(0x28b)](_0x43e94b){const _0x53795c=a37_0x2fd69a,_0x4ef3d4=this[_0x53795c(0x1e2)][_0x53795c(0x208)](_0x43e94b);_0x4ef3d4?(console['log']('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x4ef3d4['timers'][_0x53795c(0x1ce)]+'\x20timers\x20for\x20payment\x20'+_0x43e94b),_0x4ef3d4[_0x53795c(0x243)][_0x53795c(0x20d)]((_0x4b7a53,_0x12661d)=>{const _0x16d721=_0x53795c;_0x4b7a53&&(clearTimeout(_0x4b7a53),clearInterval(_0x4b7a53),console[_0x16d721(0x205)](_0x16d721(0x24a)+(_0x12661d+0x1)+_0x16d721(0x217)+_0x43e94b));}),this[_0x53795c(0x1e2)][_0x53795c(0x1b6)](_0x43e94b),console[_0x53795c(0x205)](_0x53795c(0x272)+_0x43e94b+_0x53795c(0x1c9)+this[_0x53795c(0x1e2)][_0x53795c(0x1d4)])):console['log'](_0x53795c(0x1d9)+_0x43e94b+_0x53795c(0x244));}async[a37_0x2fd69a(0x1d7)](_0x1f90af){const _0x1b2ba3=a37_0x2fd69a;console[_0x1b2ba3(0x205)](_0x1b2ba3(0x220)+_0x1f90af);const _0x453445=await database_1['default'][_0x1b2ba3(0x1d8)][_0x1b2ba3(0x256)]({'where':{'id':_0x1f90af},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x453445){console[_0x1b2ba3(0x205)](_0x1b2ba3(0x23a)+_0x1f90af+_0x1b2ba3(0x1ed));return;}console['log'](_0x1b2ba3(0x254)+_0x1f90af+_0x1b2ba3(0x203)),console[_0x1b2ba3(0x205)](_0x1b2ba3(0x1ee)+_0x453445[_0x1b2ba3(0x213)]),console[_0x1b2ba3(0x205)]('\x20\x20\x20-\x20Status:\x20'+_0x453445[_0x1b2ba3(0x1f8)]),console[_0x1b2ba3(0x205)](_0x1b2ba3(0x22c)+_0x453445['gatewayPaymentId']),console[_0x1b2ba3(0x205)]('\x20\x20\x20-\x20Amount:\x20'+_0x453445[_0x1b2ba3(0x1e9)]+'\x20'+_0x453445[_0x1b2ba3(0x1e3)]),console['log']('\x20\x20\x20-\x20ShopId:\x20'+_0x453445[_0x1b2ba3(0x24c)]);if(_0x453445[_0x1b2ba3(0x213)]!=='cointopay'){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x1f90af+_0x1b2ba3(0x1e5)+_0x453445[_0x1b2ba3(0x213)]+')');return;}if(_0x453445[_0x1b2ba3(0x1f8)]!==_0x1b2ba3(0x290)){console[_0x1b2ba3(0x205)](_0x1b2ba3(0x20a)+_0x1f90af+'\x20status\x20is\x20'+_0x453445['status']+_0x1b2ba3(0x267)),this['clearPaymentTimers'](_0x1f90af);return;}if(!_0x453445[_0x1b2ba3(0x262)]){console[_0x1b2ba3(0x205)](_0x1b2ba3(0x20a)+_0x1f90af+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x1b2ba3(0x205)](_0x1b2ba3(0x24e)+_0x1f90af+_0x1b2ba3(0x20c)),await this['checkSinglePayment'](_0x453445);}[a37_0x2fd69a(0x215)](_0x4edf56,_0x1e6ee8,_0x2abead,_0x5c4e28,_0x22dfb3,_0x341ef0){const _0x387f15=a37_0x2fd69a,_0x1eb9b7={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x4edf56,'gatewayPaymentId':_0x1e6ee8,'oldStatus':_0x2abead,'newStatus':_0x5c4e28,'source':_0x22dfb3,'timestamp':new Date()['toISOString'](),'details':_0x341ef0||{}};loggerService_1['loggerService'][_0x387f15(0x215)](_0x1eb9b7),console['log']('ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x4edf56+'\x20('+_0x1e6ee8+')'),console[_0x387f15(0x205)](_0x387f15(0x241)+_0x2abead+_0x387f15(0x235)+_0x5c4e28),console[_0x387f15(0x205)](_0x387f15(0x1fa)+_0x22dfb3),console[_0x387f15(0x205)](_0x387f15(0x280)+_0x1eb9b7[_0x387f15(0x210)]),_0x341ef0&&console['log'](_0x387f15(0x258),_0x341ef0);}[a37_0x2fd69a(0x292)](_0x150c46,_0x15eaca,_0x1ca3bf,_0x2e7a39,_0x31a374){const _0x1c2bbf=a37_0x2fd69a,_0x5f0140={'type':_0x1c2bbf(0x1b3),'paymentId':_0x150c46,'gatewayPaymentId':_0x15eaca,'error':_0x1ca3bf instanceof Error?{'message':_0x1ca3bf[_0x1c2bbf(0x200)],'stack':_0x1ca3bf['stack']}:_0x1ca3bf,'source':_0x2e7a39,'timestamp':new Date()[_0x1c2bbf(0x26f)](),'context':_0x31a374||{}};loggerService_1[_0x1c2bbf(0x227)][_0x1c2bbf(0x292)](_0x5f0140),console[_0x1c2bbf(0x1b9)](_0x1c2bbf(0x1ec)+_0x150c46+'\x20('+_0x15eaca+')'),console[_0x1c2bbf(0x1b9)](_0x1c2bbf(0x234)+(_0x1ca3bf instanceof Error?_0x1ca3bf[_0x1c2bbf(0x200)]:_0x1ca3bf)),console[_0x1c2bbf(0x1b9)](_0x1c2bbf(0x1fa)+_0x2e7a39),console[_0x1c2bbf(0x1b9)](_0x1c2bbf(0x280)+_0x5f0140['timestamp']),_0x31a374&&console[_0x1c2bbf(0x1b9)](_0x1c2bbf(0x26d),_0x31a374);}[a37_0x2fd69a(0x277)](){const _0x2427ca=a37_0x2fd69a;console['log'](_0x2427ca(0x233)),this[_0x2427ca(0x265)]()[_0x2427ca(0x260)](_0x367127=>{const _0x5047b8=_0x2427ca;console[_0x5047b8(0x1b9)](_0x5047b8(0x284),_0x367127);}),this['globalCheckInterval']=setInterval(async()=>{const _0x1d33c1=_0x2427ca;try{console[_0x1d33c1(0x205)](_0x1d33c1(0x22b)),await this[_0x1d33c1(0x265)](),console[_0x1d33c1(0x205)](_0x1d33c1(0x281));}catch(_0x2565e){console[_0x1d33c1(0x1b9)](_0x1d33c1(0x1c2),_0x2565e);}},this[_0x2427ca(0x21b)]),console[_0x2427ca(0x205)]('‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x2fd69a(0x27d)](){const _0x82a81e=a37_0x2fd69a;console[_0x82a81e(0x205)]('üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x82a81e(0x268)]&&(clearInterval(this[_0x82a81e(0x268)]),this[_0x82a81e(0x268)]=null,console[_0x82a81e(0x205)]('üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x194c15=this[_0x82a81e(0x1e2)][_0x82a81e(0x1d4)];for(const [_0x7dc210]of this[_0x82a81e(0x1e2)]){this[_0x82a81e(0x28b)](_0x7dc210);}console['log'](_0x82a81e(0x206)+_0x194c15+_0x82a81e(0x20b));}async[a37_0x2fd69a(0x265)](){const _0x4f1ef9=a37_0x2fd69a;try{console[_0x4f1ef9(0x205)](_0x4f1ef9(0x230));const _0xd3fb2d=await database_1['default'][_0x4f1ef9(0x1d8)][_0x4f1ef9(0x1e7)]({'where':{'gateway':_0x4f1ef9(0x21c),'status':_0x4f1ef9(0x290),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x4f1ef9(0x205)](_0x4f1ef9(0x1f4)+_0xd3fb2d[_0x4f1ef9(0x1ce)]+_0x4f1ef9(0x240));if(_0xd3fb2d['length']===0x0){console['log'](_0x4f1ef9(0x27e));return;}const _0x58a128=await this['checkExpiredPayments'](_0xd3fb2d);console[_0x4f1ef9(0x205)](_0x4f1ef9(0x221)+_0x58a128[_0x4f1ef9(0x1ce)]+_0x4f1ef9(0x23e));let _0x16c461=0x0,_0x5f50ce=0x0;for(const _0x4fc962 of _0xd3fb2d){try{if(_0x58a128[_0x4f1ef9(0x1fc)](_0x4fc962['id'])){console[_0x4f1ef9(0x205)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x4fc962['id']+_0x4f1ef9(0x1dd)),_0x5f50ce++;continue;}if(this[_0x4f1ef9(0x1e2)][_0x4f1ef9(0x1ae)](_0x4fc962['id'])){console['log'](_0x4f1ef9(0x224)+_0x4fc962['id']+_0x4f1ef9(0x1af)),_0x5f50ce++;continue;}const _0x592a38=(Date[_0x4f1ef9(0x253)]()-_0x4fc962[_0x4f1ef9(0x1da)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x592a38<0x1){console[_0x4f1ef9(0x205)](_0x4f1ef9(0x224)+_0x4fc962['id']+_0x4f1ef9(0x212)+_0x592a38[_0x4f1ef9(0x22e)](0x1)+_0x4f1ef9(0x271)),_0x5f50ce++;continue;}console['log'](_0x4f1ef9(0x255)+_0x4fc962['id']+'\x20(age:\x20'+_0x592a38[_0x4f1ef9(0x22e)](0x1)+'h)'),await this[_0x4f1ef9(0x1cd)](_0x4fc962),_0x16c461++,await new Promise(_0x1c0a1b=>setTimeout(_0x1c0a1b,0x7d0));}catch(_0x4e0553){console[_0x4f1ef9(0x1b9)](_0x4f1ef9(0x1e1)+_0x4fc962['id']+':',_0x4e0553),this['logCoinToPayError'](_0x4fc962['id'],_0x4fc962[_0x4f1ef9(0x262)]||_0x4f1ef9(0x22f),_0x4e0553,_0x4f1ef9(0x222),{'isGlobalCheck':!![],'paymentAmount':_0x4fc962[_0x4f1ef9(0x1e9)],'paymentCurrency':_0x4fc962[_0x4f1ef9(0x1e3)],'shopId':_0x4fc962[_0x4f1ef9(0x24c)],'createdAt':_0x4fc962[_0x4f1ef9(0x1da)]}),loggerService_1[_0x4f1ef9(0x227)]['logWhiteDomainError'](_0x4f1ef9(0x21c),_0x4f1ef9(0x22a)+_0x4fc962[_0x4f1ef9(0x262)],_0x4e0553);}}console[_0x4f1ef9(0x205)](_0x4f1ef9(0x239)+_0x16c461+'\x20checked,\x20'+_0x5f50ce+_0x4f1ef9(0x1d5)+_0x58a128['length']+_0x4f1ef9(0x1f7));}catch(_0x1cc124){console['error'](_0x4f1ef9(0x23f),_0x1cc124);}}async[a37_0x2fd69a(0x228)](_0x44b035){const _0x4d2dcc=a37_0x2fd69a,_0x5338be=[],_0x271166=new Date();_0x271166['setDate'](_0x271166[_0x4d2dcc(0x1bc)]()-this[_0x4d2dcc(0x21d)]),console[_0x4d2dcc(0x205)](_0x4d2dcc(0x1c5)+this['EXPIRY_DAYS']+'\x20days\x20(created\x20before\x20'+_0x271166[_0x4d2dcc(0x26f)]()+')');for(const _0x596650 of _0x44b035){if(_0x596650[_0x4d2dcc(0x1da)]<_0x271166){console[_0x4d2dcc(0x205)](_0x4d2dcc(0x1c4)+_0x596650['id']+_0x4d2dcc(0x1b8)+this[_0x4d2dcc(0x21d)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x4d2dcc(0x215)](_0x596650['id'],_0x596650[_0x4d2dcc(0x262)]||_0x4d2dcc(0x22f),_0x4d2dcc(0x290),_0x4d2dcc(0x1db),_0x4d2dcc(0x20e),{'reason':_0x4d2dcc(0x219)+this['EXPIRY_DAYS']+_0x4d2dcc(0x276),'createdAt':_0x596650[_0x4d2dcc(0x1da)],'daysSinceCreation':Math[_0x4d2dcc(0x24f)]((Date[_0x4d2dcc(0x253)]()-_0x596650['createdAt'][_0x4d2dcc(0x1ba)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x596650[_0x4d2dcc(0x1e9)],'paymentCurrency':_0x596650['currency'],'shopId':_0x596650[_0x4d2dcc(0x24c)]}),await database_1[_0x4d2dcc(0x27b)][_0x4d2dcc(0x1d8)][_0x4d2dcc(0x1c0)]({'where':{'id':_0x596650['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x4d2dcc(0x21e)+this[_0x4d2dcc(0x21d)]+_0x4d2dcc(0x285)}}),await database_1[_0x4d2dcc(0x27b)]['webhookLog'][_0x4d2dcc(0x232)]({'data':{'paymentId':_0x596650['id'],'shopId':_0x596650['shopId'],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x4d2dcc(0x28d)]({'reason':_0x4d2dcc(0x219)+this[_0x4d2dcc(0x21d)]+'\x20days','createdAt':_0x596650[_0x4d2dcc(0x1da)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x4d2dcc(0x24f)]((Date['now']()-_0x596650[_0x4d2dcc(0x1da)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4d2dcc(0x218)](_0x596650,_0x4d2dcc(0x1db)),await this['sendPaymentStatusNotification'](_0x596650,_0x4d2dcc(0x1db)),this[_0x4d2dcc(0x28b)](_0x596650['id']),_0x5338be[_0x4d2dcc(0x1e4)](_0x596650['id']),console['log'](_0x4d2dcc(0x25c)+_0x596650['id']+_0x4d2dcc(0x236)+this[_0x4d2dcc(0x21d)]+_0x4d2dcc(0x289));}catch(_0x33a690){console[_0x4d2dcc(0x1b9)](_0x4d2dcc(0x28e)+_0x596650['id']+':',_0x33a690),this[_0x4d2dcc(0x292)](_0x596650['id'],_0x596650[_0x4d2dcc(0x262)]||'unknown',_0x33a690,_0x4d2dcc(0x20e),{'reason':_0x4d2dcc(0x1c1),'createdAt':_0x596650['createdAt'],'daysSinceCreation':Math['floor']((Date[_0x4d2dcc(0x253)]()-_0x596650['createdAt'][_0x4d2dcc(0x1ba)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5338be;}async['checkSinglePayment'](_0x2c0a1c){const _0x1d3bb9=a37_0x2fd69a;if(!_0x2c0a1c['gatewayPaymentId']){console['log'](_0x1d3bb9(0x20a)+_0x2c0a1c['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x1d3bb9(0x205)](_0x1d3bb9(0x25d)+_0x2c0a1c['id']+'\x20('+_0x2c0a1c[_0x1d3bb9(0x262)]+')');try{const _0x1e31b2=await this[_0x1d3bb9(0x26b)][_0x1d3bb9(0x1d6)](_0x2c0a1c[_0x1d3bb9(0x262)]);console['log']('üìä\x20[CHECK]\x20Payment\x20'+_0x2c0a1c['id']+_0x1d3bb9(0x273)+_0x1e31b2['status']);_0x1e31b2[_0x1d3bb9(0x24b)]&&console['log']('üìä\x20[CHECK]\x20Payment\x20'+_0x2c0a1c['id']+_0x1d3bb9(0x1c3),{'iban':_0x1e31b2['paymentDetails'][_0x1d3bb9(0x1f9)]||'not\x20found','transactionId':_0x1e31b2[_0x1d3bb9(0x24b)][_0x1d3bb9(0x263)],'createdOn':_0x1e31b2[_0x1d3bb9(0x24b)]['createdOn'],'confirmedOn':_0x1e31b2[_0x1d3bb9(0x24b)][_0x1d3bb9(0x251)]||_0x1d3bb9(0x204)});if(_0x1e31b2[_0x1d3bb9(0x1f8)]!==_0x2c0a1c['status']){console[_0x1d3bb9(0x205)](_0x1d3bb9(0x1ca)+_0x2c0a1c['id']+_0x1d3bb9(0x275)+_0x2c0a1c[_0x1d3bb9(0x1f8)]+'\x20to\x20'+_0x1e31b2['status']),this[_0x1d3bb9(0x215)](_0x2c0a1c['id'],_0x2c0a1c[_0x1d3bb9(0x262)],_0x2c0a1c['status'],_0x1e31b2[_0x1d3bb9(0x1f8)],_0x1d3bb9(0x222),{'paymentDetails':_0x1e31b2[_0x1d3bb9(0x24b)],'amount':_0x1e31b2[_0x1d3bb9(0x1e9)],'currency':_0x1e31b2['currency'],'shopId':_0x2c0a1c[_0x1d3bb9(0x24c)],'checkTimestamp':new Date()[_0x1d3bb9(0x26f)]()});const _0x16a7f4={'status':_0x1e31b2['status'],'updatedAt':new Date()};_0x1e31b2[_0x1d3bb9(0x1f8)]==='PAID'&&_0x2c0a1c['status']!==_0x1d3bb9(0x1e6)&&(_0x16a7f4[_0x1d3bb9(0x1d0)]=new Date(),console[_0x1d3bb9(0x205)](_0x1d3bb9(0x279)+_0x2c0a1c['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x16a7f4[_0x1d3bb9(0x1d0)][_0x1d3bb9(0x26f)]()));if(_0x1e31b2[_0x1d3bb9(0x24b)]){const _0x223e0a=_0x1e31b2['paymentDetails'];_0x223e0a[_0x1d3bb9(0x1f9)]&&(_0x16a7f4['remitterIban']=_0x223e0a[_0x1d3bb9(0x1f9)],console['log'](_0x1d3bb9(0x202)+_0x223e0a['iban']));if(_0x223e0a[_0x1d3bb9(0x1f1)]){const _0x1e18f2=_0x2c0a1c[_0x1d3bb9(0x23d)]||'',_0x332f76=_0x1d3bb9(0x250)+_0x223e0a['bankDetails'];_0x16a7f4[_0x1d3bb9(0x23d)]=_0x1e18f2?_0x1e18f2+'\x0a\x0a'+_0x332f76:_0x332f76,console[_0x1d3bb9(0x205)](_0x1d3bb9(0x229));}_0x223e0a[_0x1d3bb9(0x263)]&&console[_0x1d3bb9(0x205)]('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x223e0a[_0x1d3bb9(0x263)]),_0x223e0a[_0x1d3bb9(0x251)]&&console[_0x1d3bb9(0x205)](_0x1d3bb9(0x287)+_0x223e0a['confirmedOn']);}await database_1['default'][_0x1d3bb9(0x1d8)]['update']({'where':{'id':_0x2c0a1c['id']},'data':_0x16a7f4}),await database_1[_0x1d3bb9(0x27b)][_0x1d3bb9(0x1f2)]['create']({'data':{'paymentId':_0x2c0a1c['id'],'shopId':_0x2c0a1c[_0x1d3bb9(0x24c)],'event':_0x1d3bb9(0x1b4)+_0x1e31b2[_0x1d3bb9(0x1f8)][_0x1d3bb9(0x257)](),'statusCode':0xc8,'responseBody':JSON[_0x1d3bb9(0x28d)]({'oldStatus':_0x2c0a1c[_0x1d3bb9(0x1f8)],'newStatus':_0x1e31b2[_0x1d3bb9(0x1f8)],'paymentDetails':_0x1e31b2[_0x1d3bb9(0x24b)],'checkedAt':new Date()[_0x1d3bb9(0x26f)]()})}}),await this[_0x1d3bb9(0x218)](_0x2c0a1c,_0x1e31b2[_0x1d3bb9(0x1f8)]),await this[_0x1d3bb9(0x246)](_0x2c0a1c,_0x1e31b2[_0x1d3bb9(0x1f8)]),_0x1e31b2['status']!==_0x1d3bb9(0x290)&&(console[_0x1d3bb9(0x205)]('üßπ\x20[CHECK]\x20Payment\x20'+_0x2c0a1c['id']+'\x20status\x20changed\x20to\x20'+_0x1e31b2['status']+_0x1d3bb9(0x28c)),this[_0x1d3bb9(0x28b)](_0x2c0a1c['id'])),console[_0x1d3bb9(0x205)]('‚úÖ\x20[CHECK]\x20Payment\x20'+_0x2c0a1c['id']+_0x1d3bb9(0x1fd));}else console[_0x1d3bb9(0x205)](_0x1d3bb9(0x254)+_0x2c0a1c['id']+_0x1d3bb9(0x223)+_0x1e31b2[_0x1d3bb9(0x1f8)]+')'),this[_0x1d3bb9(0x215)](_0x2c0a1c['id'],_0x2c0a1c[_0x1d3bb9(0x262)],_0x2c0a1c['status'],_0x1e31b2[_0x1d3bb9(0x1f8)],_0x1d3bb9(0x222),{'statusUnchanged':!![],'paymentDetails':_0x1e31b2['paymentDetails'],'amount':_0x1e31b2['amount'],'currency':_0x1e31b2['currency'],'shopId':_0x2c0a1c[_0x1d3bb9(0x24c)],'checkTimestamp':new Date()[_0x1d3bb9(0x26f)]()});}catch(_0x4e0676){console['error'](_0x1d3bb9(0x286)+_0x2c0a1c['id']+':',_0x4e0676),this['logCoinToPayError'](_0x2c0a1c['id'],_0x2c0a1c['gatewayPaymentId'],_0x4e0676,_0x1d3bb9(0x222),{'paymentAmount':_0x2c0a1c[_0x1d3bb9(0x1e9)],'paymentCurrency':_0x2c0a1c[_0x1d3bb9(0x1e3)],'shopId':_0x2c0a1c[_0x1d3bb9(0x24c)],'createdAt':_0x2c0a1c[_0x1d3bb9(0x1da)]}),await database_1[_0x1d3bb9(0x27b)][_0x1d3bb9(0x1f2)]['create']({'data':{'paymentId':_0x2c0a1c['id'],'shopId':_0x2c0a1c[_0x1d3bb9(0x24c)],'event':_0x1d3bb9(0x1f0),'statusCode':0x1f4,'responseBody':JSON[_0x1d3bb9(0x28d)]({'error':_0x4e0676 instanceof Error?_0x4e0676[_0x1d3bb9(0x200)]:_0x1d3bb9(0x242),'gatewayPaymentId':_0x2c0a1c[_0x1d3bb9(0x262)],'checkedAt':new Date()[_0x1d3bb9(0x26f)]()})}});}}async[a37_0x2fd69a(0x218)](_0x3d23b9,_0x105ab8){const _0x3950df=a37_0x2fd69a,_0x1ebdea=Date[_0x3950df(0x253)]();try{const _0x2ed3ef=_0x3d23b9[_0x3950df(0x1e8)],_0x541fe9=_0x2ed3ef[_0x3950df(0x26c)];if(!_0x541fe9?.['webhookUrl']){console['log'](_0x3950df(0x1df)+_0x2ed3ef['id']);return;}const _0x1cece2=_0x105ab8===_0x3950df(0x1e6)?_0x3950df(0x1b2):_0x105ab8===_0x3950df(0x264)?_0x3950df(0x1d3):_0x105ab8==='EXPIRED'?_0x3950df(0x1d3):_0x3950df(0x1be);if(!_0x541fe9['webhookEvents']?.[_0x3950df(0x1fc)](_0x1cece2)){console[_0x3950df(0x205)](_0x3950df(0x291)+_0x1cece2+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2ed3ef['id']);return;}const _0x2f4d68={'event':_0x1cece2,'payment':{'id':_0x3d23b9['id'],'order_id':_0x3d23b9[_0x3950df(0x1c8)],'gateway_order_id':_0x3d23b9[_0x3950df(0x1bd)],'gateway':_0x3950df(0x27c),'amount':_0x3d23b9[_0x3950df(0x1e9)],'currency':_0x3d23b9[_0x3950df(0x1e3)],'status':_0x105ab8[_0x3950df(0x257)](),'customer_email':_0x3d23b9[_0x3950df(0x21f)],'customer_name':_0x3d23b9[_0x3950df(0x21a)],'created_at':_0x3d23b9[_0x3950df(0x1da)],'updated_at':new Date()}},_0x163320=await fetch(_0x541fe9['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x3950df(0x25b),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x3950df(0x28d)](_0x2f4d68)}),_0x474470=Date['now']()-_0x1ebdea,_0x451bee=_0x163320['ok']?'Success':await _0x163320['text']();loggerService_1[_0x3950df(0x227)][_0x3950df(0x20f)](_0x3d23b9[_0x3950df(0x24c)],_0x541fe9[_0x3950df(0x259)],_0x1cece2,_0x163320['status'],_0x474470,_0x2f4d68),console[_0x3950df(0x205)](_0x3950df(0x1de)+_0x541fe9[_0x3950df(0x259)]+_0x3950df(0x201)+_0x163320[_0x3950df(0x1f8)]+'\x20('+_0x474470+_0x3950df(0x1cf));}catch(_0x423b7b){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x423b7b),loggerService_1[_0x3950df(0x227)][_0x3950df(0x214)](_0x3d23b9['shopId'],_0x3d23b9[_0x3950df(0x1e8)]?.['settings']?.[_0x3950df(0x259)]||'unknown','webhook_send',_0x423b7b,{});}}async[a37_0x2fd69a(0x246)](_0x5017c3,_0x53e915){const _0x571b57=a37_0x2fd69a;try{const _0x26c042={'PENDING':_0x571b57(0x27f),'PAID':'paid','FAILED':_0x571b57(0x26e),'EXPIRED':'expired'},_0x556c24=_0x26c042[_0x53e915];if(!_0x556c24||_0x556c24===_0x571b57(0x27f))return;await telegramBotService_1['telegramBotService'][_0x571b57(0x261)](_0x5017c3[_0x571b57(0x24c)],_0x5017c3,_0x556c24);}catch(_0x4f9da7){console[_0x571b57(0x1b9)](_0x571b57(0x23c),_0x4f9da7);}}async['checkPaymentById'](_0x32794d){const _0x2ca096=a37_0x2fd69a;console[_0x2ca096(0x205)](_0x2ca096(0x252)+_0x32794d);const _0x4aea68=await database_1['default'][_0x2ca096(0x1d8)][_0x2ca096(0x256)]({'where':{'id':_0x32794d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4aea68)throw new Error(_0x2ca096(0x245));if(_0x4aea68['gateway']!==_0x2ca096(0x21c))throw new Error(_0x2ca096(0x1d1));console[_0x2ca096(0x205)](_0x2ca096(0x1cc)+_0x32794d),await this[_0x2ca096(0x1cd)](_0x4aea68),console['log'](_0x2ca096(0x278)+_0x32794d);}[a37_0x2fd69a(0x1ea)](){const _0x51025f=a37_0x2fd69a,_0x508b20=this[_0x51025f(0x268)]?this[_0x51025f(0x21b)]:undefined,_0x4d146f=Array[_0x51025f(0x1b7)](this[_0x51025f(0x1e2)]['values']())[_0x51025f(0x1b5)](_0xf92c29=>({'paymentId':_0xf92c29[_0x51025f(0x1f3)],'gatewayPaymentId':_0xf92c29[_0x51025f(0x262)],'createdAt':_0xf92c29[_0x51025f(0x1da)],'timersCount':_0xf92c29[_0x51025f(0x243)][_0x51025f(0x1ce)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x51025f(0x21d)],'activeIndividualTimers':this[_0x51025f(0x1e2)][_0x51025f(0x1d4)],'nextGlobalCheckIn':_0x508b20,'paymentTimersDetails':_0x4d146f};}[a37_0x2fd69a(0x237)](_0x366b17){const _0x346e05=a37_0x2fd69a,_0x32f870=this[_0x346e05(0x1e2)]['get'](_0x366b17);if(_0x32f870)return{'hasTimers':!![],'timersCount':_0x32f870[_0x346e05(0x243)][_0x346e05(0x1ce)],'createdAt':_0x32f870['createdAt'],'gatewayPaymentId':_0x32f870[_0x346e05(0x262)]};return{'hasTimers':![]};}}exports[a37_0x2fd69a(0x1fb)]=CoinToPayStatusService,exports[a37_0x2fd69a(0x282)]=new CoinToPayStatusService();