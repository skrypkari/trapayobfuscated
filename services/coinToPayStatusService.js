'use strict';function a35_0x2bbe(){const _0x2c8115=['loggerService','logShopWebhookError','logWhiteDomainError','webhookLog','Failed\x20to\x20expire\x20payment\x20','orderId','create','status','payment.success','./gateways/coinToPayService','shop','CoinToPayService','\x20not\x20enabled\x20for\x20shop\x20','sendShopWebhook','__importDefault','sendPaymentStatusNotification','ms)','checkAllPendingPayments','./loggerService','setDate','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','getServiceStats','\x20marked\x20as\x20paid\x20at:\x20','ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','now','Webhook\x20event\x20','ðŸ†”\x20Transaction\x20ID:\x20','coinToPayStatusService','Initial\x20CoinToPay\x20status\x20check\x20failed:','shopId','FAILED','cointopay_auto_expired','amount','toLowerCase','cointopay_status_check_error','gateway','POST','/status/','checkExpiredPayments','../config/database','error','ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','webhook_send','\x20to\x20','\x20expired\x20CoinToPay\x20payments','Failed\x20to\x20send\x20shop\x20webhook:','Failed\x20to\x20check\x20payment\x20','startPeriodicStatusCheck','ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped','webhookEvents','ðŸ”„\x20Updating\x20payment\x20','ðŸ’°\x20Payment\x20','21499KMOfhB','Periodic\x20CoinToPay\x20status\x20check\x20failed:','stringify','checkPaymentStatus','Bank\x20Details:\x20','ðŸ¦\x20Saved\x20IBAN:\x20','CoinToPayStatusService','webhookUrl','gatewayPaymentId','__esModule','adminNotes','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','includes','â°\x20Payment\x20','\x20CoinToPay\x20payments','2355928uiiSlU','9766729XVLHKF','checkSinglePayment','paymentDetails','unknown','createdAt','Shop\x20webhook\x20sent\x20to\x20','getTime','customerEmail','\x20days,\x20marking\x20as\x20EXPIRED','expired','length','-day\x20timeout','push','application/json','Success','EXPIRED','transactionId','âš ï¸\x20Payment\x20','bankDetails','âœ…\x20Payment\x20','iban','created','TesSoft\x20Payment\x20System/1.0','6788485NNOhpR','âœ…\x20Transaction\x20confirmed\x20on:\x20','\x20days\x20(created\x20before\x20','8059026ewbeTT','âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','â°\x20Found\x20','checkPaymentById','162918PeZOjl','cointopay','not\x20found','cointopay_status_check_','PAID','gatewayOrderId','\x20updated\x20successfully','catch','CHECK_INTERVAL_MS','\x20is\x20older\x20than\x20','EXPIRY_DAYS','toISOString','defineProperty','coinToPayService','default','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','\x20days','confirmedOn','payment.failed','checkInterval','findMany','update','findUnique','\x20days\x20without\x20payment\x20confirmation','log','âœ…\x20Completed\x20checking\x20','ðŸ“Š\x20Payment\x20','ðŸ”\x20Checking\x20CoinToPay\x20payment\x20','payment','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20status:\x20','settings','Unknown\x20error','220548AJczuB','not\x20confirmed','failed','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20details:'];a35_0x2bbe=function(){return _0x2c8115;};return a35_0x2bbe();}const a35_0x218e45=a35_0x5eb4;(function(_0x3e2c7f,_0x6eaa70){const _0xa7c20c=a35_0x5eb4,_0x333753=_0x3e2c7f();while(!![]){try{const _0x130dc9=-parseInt(_0xa7c20c(0x1fc))/0x1+-parseInt(_0xa7c20c(0x24d))/0x2+parseInt(_0xa7c20c(0x22a))/0x3+-parseInt(_0xa7c20c(0x20b))/0x4+-parseInt(_0xa7c20c(0x223))/0x5+parseInt(_0xa7c20c(0x226))/0x6+parseInt(_0xa7c20c(0x20c))/0x7;if(_0x130dc9===_0x6eaa70)break;else _0x333753['push'](_0x333753['shift']());}catch(_0x5aba40){_0x333753['push'](_0x333753['shift']());}}}(a35_0x2bbe,0xae620));var __importDefault=this&&this[a35_0x218e45(0x1d6)]||function(_0x218572){const _0x5ef6a9=a35_0x218e45;return _0x218572&&_0x218572[_0x5ef6a9(0x205)]?_0x218572:{'default':_0x218572};};Object[a35_0x218e45(0x236)](exports,a35_0x218e45(0x205),{'value':!![]}),exports[a35_0x218e45(0x1e3)]=exports[a35_0x218e45(0x202)]=void 0x0;const coinToPayService_1=require(a35_0x218e45(0x1d1)),database_1=__importDefault(require(a35_0x218e45(0x1ef))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a35_0x218e45(0x1da));class CoinToPayStatusService{constructor(){const _0x155b18=a35_0x218e45;this['checkInterval']=null,this[_0x155b18(0x232)]=0x3c*0x3c*0x3e8,this[_0x155b18(0x234)]=0x5,this[_0x155b18(0x237)]=new coinToPayService_1[(_0x155b18(0x1d3))]();}[a35_0x218e45(0x1f7)](){const _0x3484c9=a35_0x218e45;console[_0x3484c9(0x244)](_0x3484c9(0x239)),this['checkAllPendingPayments']()[_0x3484c9(0x231)](_0x3f1ac5=>{const _0x3bc44c=_0x3484c9;console[_0x3bc44c(0x1f0)](_0x3bc44c(0x1e4),_0x3f1ac5);}),this['checkInterval']=setInterval(async()=>{const _0x568551=_0x3484c9;try{await this[_0x568551(0x1d9)]();}catch(_0x350c27){console[_0x568551(0x1f0)](_0x568551(0x1fd),_0x350c27);}},this[_0x3484c9(0x232)]),console[_0x3484c9(0x244)](_0x3484c9(0x227));}['stopPeriodicStatusCheck'](){const _0x124ebc=a35_0x218e45;this[_0x124ebc(0x23f)]&&(clearInterval(this[_0x124ebc(0x23f)]),this['checkInterval']=null,console[_0x124ebc(0x244)](_0x124ebc(0x1f8)));}async['checkAllPendingPayments'](){const _0x3abb3a=a35_0x218e45;try{const _0x56ceb1=await database_1[_0x3abb3a(0x238)]['payment'][_0x3abb3a(0x240)]({'where':{'gateway':'cointopay','status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x56ceb1['length']===0x0){console[_0x3abb3a(0x244)](_0x3abb3a(0x1f1));return;}console[_0x3abb3a(0x244)]('ðŸª™\x20Checking\x20'+_0x56ceb1[_0x3abb3a(0x216)]+'\x20pending\x20CoinToPay\x20payments');const _0x214f3b=await this[_0x3abb3a(0x1ee)](_0x56ceb1);console[_0x3abb3a(0x244)](_0x3abb3a(0x228)+_0x214f3b['length']+_0x3abb3a(0x1f4));for(const _0x4b1c55 of _0x56ceb1){try{if(_0x214f3b[_0x3abb3a(0x208)](_0x4b1c55['id'])){console[_0x3abb3a(0x244)](_0x3abb3a(0x209)+_0x4b1c55['id']+_0x3abb3a(0x23b));continue;}await this[_0x3abb3a(0x20d)](_0x4b1c55),await new Promise(_0x1db727=>setTimeout(_0x1db727,0x7d0));}catch(_0x1f352e){console[_0x3abb3a(0x1f0)](_0x3abb3a(0x249)+_0x4b1c55['id']+':',_0x1f352e),loggerService_1[_0x3abb3a(0x252)][_0x3abb3a(0x254)]('cointopay',_0x3abb3a(0x1ed)+_0x4b1c55[_0x3abb3a(0x204)],_0x1f352e);}}console[_0x3abb3a(0x244)](_0x3abb3a(0x245)+_0x56ceb1[_0x3abb3a(0x216)]+_0x3abb3a(0x20a));}catch(_0x24bf0d){console['error']('Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x24bf0d);}}async[a35_0x218e45(0x1ee)](_0xd7bb01){const _0x822643=a35_0x218e45,_0x1172b0=[],_0x2a9a24=new Date();_0x2a9a24[_0x822643(0x1db)](_0x2a9a24['getDate']()-this[_0x822643(0x234)]),console[_0x822643(0x244)](_0x822643(0x1dc)+this[_0x822643(0x234)]+_0x822643(0x225)+_0x2a9a24['toISOString']()+')');for(const _0x2b2e1b of _0xd7bb01){if(_0x2b2e1b[_0x822643(0x210)]<_0x2a9a24){console['log'](_0x822643(0x209)+_0x2b2e1b['id']+_0x822643(0x233)+this[_0x822643(0x234)]+_0x822643(0x214));try{await database_1[_0x822643(0x238)][_0x822643(0x248)][_0x822643(0x241)]({'where':{'id':_0x2b2e1b['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x822643(0x234)]+_0x822643(0x243)}}),await database_1['default'][_0x822643(0x255)][_0x822643(0x1ce)]({'data':{'paymentId':_0x2b2e1b['id'],'shopId':_0x2b2e1b[_0x822643(0x1e5)],'event':_0x822643(0x1e7),'statusCode':0xc8,'responseBody':JSON[_0x822643(0x1fe)]({'reason':'Payment\x20older\x20than\x20'+this[_0x822643(0x234)]+_0x822643(0x23c),'createdAt':_0x2b2e1b[_0x822643(0x210)],'expiredAt':new Date()[_0x822643(0x235)](),'daysSinceCreation':Math['floor']((Date[_0x822643(0x1e0)]()-_0x2b2e1b['createdAt'][_0x822643(0x212)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x822643(0x1d5)](_0x2b2e1b,_0x822643(0x21b)),await this[_0x822643(0x1d7)](_0x2b2e1b,_0x822643(0x21b)),_0x1172b0[_0x822643(0x218)](_0x2b2e1b['id']),console[_0x822643(0x244)]('âœ…\x20Payment\x20'+_0x2b2e1b['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x822643(0x234)]+_0x822643(0x217));}catch(_0x5ab468){console[_0x822643(0x1f0)](_0x822643(0x256)+_0x2b2e1b['id']+':',_0x5ab468);}}}return _0x1172b0;}async['checkSinglePayment'](_0x3a80e0){const _0x3009eb=a35_0x218e45;if(!_0x3a80e0[_0x3009eb(0x204)]){console['log'](_0x3009eb(0x21d)+_0x3a80e0['id']+_0x3009eb(0x250));return;}console[_0x3009eb(0x244)](_0x3009eb(0x247)+_0x3a80e0['id']+'\x20('+_0x3a80e0['gatewayPaymentId']+')');try{const _0x40c029=await this['coinToPayService'][_0x3009eb(0x1ff)](_0x3a80e0['gatewayPaymentId']);console[_0x3009eb(0x244)](_0x3009eb(0x246)+_0x3a80e0['id']+_0x3009eb(0x24a)+_0x40c029[_0x3009eb(0x1cf)]);_0x40c029[_0x3009eb(0x20e)]&&console[_0x3009eb(0x244)](_0x3009eb(0x246)+_0x3a80e0['id']+_0x3009eb(0x251),{'iban':_0x40c029['paymentDetails'][_0x3009eb(0x220)]||_0x3009eb(0x22c),'transactionId':_0x40c029['paymentDetails'][_0x3009eb(0x21c)],'createdOn':_0x40c029[_0x3009eb(0x20e)]['createdOn'],'confirmedOn':_0x40c029[_0x3009eb(0x20e)]['confirmedOn']||_0x3009eb(0x24e)});if(_0x40c029['status']!==_0x3a80e0[_0x3009eb(0x1cf)]){console[_0x3009eb(0x244)](_0x3009eb(0x1fa)+_0x3a80e0['id']+'\x20status\x20from\x20'+_0x3a80e0[_0x3009eb(0x1cf)]+_0x3009eb(0x1f3)+_0x40c029['status']);const _0x283dda={'status':_0x40c029['status'],'updatedAt':new Date()};_0x40c029['status']===_0x3009eb(0x22e)&&_0x3a80e0[_0x3009eb(0x1cf)]!=='PAID'&&(_0x283dda['paidAt']=new Date(),console[_0x3009eb(0x244)](_0x3009eb(0x1fb)+_0x3a80e0['id']+_0x3009eb(0x1de)+_0x283dda['paidAt']['toISOString']()));if(_0x40c029[_0x3009eb(0x20e)]){const _0x5bb24b=_0x40c029[_0x3009eb(0x20e)];_0x5bb24b[_0x3009eb(0x220)]&&(_0x283dda['remitterIban']=_0x5bb24b[_0x3009eb(0x220)],console['log'](_0x3009eb(0x201)+_0x5bb24b[_0x3009eb(0x220)]));if(_0x5bb24b[_0x3009eb(0x21e)]){const _0x42fd0e=_0x3a80e0[_0x3009eb(0x206)]||'',_0x5073f7=_0x3009eb(0x200)+_0x5bb24b['bankDetails'];_0x283dda['adminNotes']=_0x42fd0e?_0x42fd0e+'\x0a\x0a'+_0x5073f7:_0x5073f7,console[_0x3009eb(0x244)](_0x3009eb(0x1df));}_0x5bb24b[_0x3009eb(0x21c)]&&console[_0x3009eb(0x244)](_0x3009eb(0x1e2)+_0x5bb24b[_0x3009eb(0x21c)]),_0x5bb24b[_0x3009eb(0x23d)]&&console['log'](_0x3009eb(0x224)+_0x5bb24b[_0x3009eb(0x23d)]);}await database_1[_0x3009eb(0x238)][_0x3009eb(0x248)][_0x3009eb(0x241)]({'where':{'id':_0x3a80e0['id']},'data':_0x283dda}),await database_1[_0x3009eb(0x238)][_0x3009eb(0x255)][_0x3009eb(0x1ce)]({'data':{'paymentId':_0x3a80e0['id'],'shopId':_0x3a80e0[_0x3009eb(0x1e5)],'event':_0x3009eb(0x22d)+_0x40c029[_0x3009eb(0x1cf)][_0x3009eb(0x1e9)](),'statusCode':0xc8,'responseBody':JSON[_0x3009eb(0x1fe)]({'oldStatus':_0x3a80e0[_0x3009eb(0x1cf)],'newStatus':_0x40c029[_0x3009eb(0x1cf)],'paymentDetails':_0x40c029[_0x3009eb(0x20e)],'checkedAt':new Date()[_0x3009eb(0x235)]()})}}),await this['sendShopWebhook'](_0x3a80e0,_0x40c029[_0x3009eb(0x1cf)]),await this['sendPaymentStatusNotification'](_0x3a80e0,_0x40c029[_0x3009eb(0x1cf)]),console[_0x3009eb(0x244)](_0x3009eb(0x21f)+_0x3a80e0['id']+_0x3009eb(0x230));}else console['log'](_0x3009eb(0x246)+_0x3a80e0['id']+'\x20status\x20unchanged\x20('+_0x40c029[_0x3009eb(0x1cf)]+')');}catch(_0x223b84){console[_0x3009eb(0x1f0)](_0x3009eb(0x1f6)+_0x3a80e0['id']+':',_0x223b84),await database_1['default'][_0x3009eb(0x255)][_0x3009eb(0x1ce)]({'data':{'paymentId':_0x3a80e0['id'],'shopId':_0x3a80e0['shopId'],'event':_0x3009eb(0x1ea),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x223b84 instanceof Error?_0x223b84['message']:_0x3009eb(0x24c),'gatewayPaymentId':_0x3a80e0[_0x3009eb(0x204)],'checkedAt':new Date()[_0x3009eb(0x235)]()})}});}}async[a35_0x218e45(0x1d5)](_0x5f2e77,_0x5c6d2b){const _0x2de79b=a35_0x218e45,_0x1477ca=Date[_0x2de79b(0x1e0)]();try{const _0x27d0fc=_0x5f2e77[_0x2de79b(0x1d2)],_0x28459c=_0x27d0fc[_0x2de79b(0x24b)];if(!_0x28459c?.['webhookUrl']){console[_0x2de79b(0x244)](_0x2de79b(0x207)+_0x27d0fc['id']);return;}const _0x5ab55b=_0x5c6d2b===_0x2de79b(0x22e)?_0x2de79b(0x1d0):_0x5c6d2b===_0x2de79b(0x1e6)?_0x2de79b(0x23e):_0x5c6d2b===_0x2de79b(0x21b)?_0x2de79b(0x23e):'payment.pending';if(!_0x28459c[_0x2de79b(0x1f9)]?.[_0x2de79b(0x208)](_0x5ab55b)){console[_0x2de79b(0x244)](_0x2de79b(0x1e1)+_0x5ab55b+_0x2de79b(0x1d4)+_0x27d0fc['id']);return;}const _0x524136={'event':_0x5ab55b,'payment':{'id':_0x5f2e77['id'],'order_id':_0x5f2e77[_0x2de79b(0x257)],'gateway_order_id':_0x5f2e77[_0x2de79b(0x22f)],'gateway':'0100','amount':_0x5f2e77[_0x2de79b(0x1e8)],'currency':_0x5f2e77['currency'],'status':_0x5c6d2b[_0x2de79b(0x1e9)](),'customer_email':_0x5f2e77[_0x2de79b(0x213)],'customer_name':_0x5f2e77['customerName'],'created_at':_0x5f2e77['createdAt'],'updated_at':new Date()}},_0x37a23b=await fetch(_0x28459c[_0x2de79b(0x203)],{'method':_0x2de79b(0x1ec),'headers':{'Content-Type':_0x2de79b(0x219),'User-Agent':_0x2de79b(0x222)},'body':JSON[_0x2de79b(0x1fe)](_0x524136)}),_0x2dda53=Date[_0x2de79b(0x1e0)]()-_0x1477ca,_0x1166f3=_0x37a23b['ok']?_0x2de79b(0x21a):await _0x37a23b['text']();loggerService_1[_0x2de79b(0x252)]['logShopWebhookSent'](_0x5f2e77['shopId'],_0x28459c[_0x2de79b(0x203)],_0x5ab55b,_0x37a23b[_0x2de79b(0x1cf)],_0x2dda53,_0x524136),console[_0x2de79b(0x244)](_0x2de79b(0x211)+_0x28459c[_0x2de79b(0x203)]+'\x20with\x20status\x20'+_0x37a23b[_0x2de79b(0x1cf)]+'\x20('+_0x2dda53+_0x2de79b(0x1d8));}catch(_0x2dae58){console[_0x2de79b(0x1f0)](_0x2de79b(0x1f5),_0x2dae58),loggerService_1[_0x2de79b(0x252)][_0x2de79b(0x253)](_0x5f2e77['shopId'],_0x5f2e77[_0x2de79b(0x1d2)]?.[_0x2de79b(0x24b)]?.[_0x2de79b(0x203)]||_0x2de79b(0x20f),_0x2de79b(0x1f2),_0x2dae58,{});}}async['sendPaymentStatusNotification'](_0x23d816,_0x53963f){const _0x265b59=a35_0x218e45;try{const _0x46363a={'PENDING':_0x265b59(0x221),'PAID':'paid','FAILED':_0x265b59(0x24f),'EXPIRED':_0x265b59(0x215)},_0xf2f502=_0x46363a[_0x53963f];if(!_0xf2f502||_0xf2f502===_0x265b59(0x221))return;await telegramBotService_1['telegramBotService']['sendPaymentNotification'](_0x23d816[_0x265b59(0x1e5)],_0x23d816,_0xf2f502);}catch(_0x15295b){console[_0x265b59(0x1f0)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x15295b);}}async[a35_0x218e45(0x229)](_0x1d06ff){const _0x39830d=a35_0x218e45,_0x1c39de=await database_1[_0x39830d(0x238)][_0x39830d(0x248)][_0x39830d(0x242)]({'where':{'id':_0x1d06ff},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1c39de)throw new Error('Payment\x20not\x20found');if(_0x1c39de[_0x39830d(0x1eb)]!==_0x39830d(0x22b))throw new Error(_0x39830d(0x23a));await this['checkSinglePayment'](_0x1c39de);}[a35_0x218e45(0x1dd)](){const _0x48e203=a35_0x218e45,_0x215291=this[_0x48e203(0x23f)]?this[_0x48e203(0x232)]:undefined;return{'isActive':!!this[_0x48e203(0x23f)],'checkIntervalMinutes':this[_0x48e203(0x232)]/(0x3e8*0x3c),'expiryDays':this[_0x48e203(0x234)],'nextCheckIn':_0x215291};}}function a35_0x5eb4(_0x87bf66,_0x6ccba4){const _0x2bbe34=a35_0x2bbe();return a35_0x5eb4=function(_0x5eb48a,_0x15d2a1){_0x5eb48a=_0x5eb48a-0x1ce;let _0x388af7=_0x2bbe34[_0x5eb48a];return _0x388af7;},a35_0x5eb4(_0x87bf66,_0x6ccba4);}exports['CoinToPayStatusService']=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();