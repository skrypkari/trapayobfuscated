'use strict';const a37_0x595bd9=a37_0x1aaf;(function(_0x4d4218,_0x26ceed){const _0x28cd20=a37_0x1aaf,_0x793c1d=_0x4d4218();while(!![]){try{const _0x140034=parseInt(_0x28cd20(0x1b7))/0x1*(-parseInt(_0x28cd20(0x128))/0x2)+parseInt(_0x28cd20(0x153))/0x3*(-parseInt(_0x28cd20(0x1be))/0x4)+parseInt(_0x28cd20(0x1c8))/0x5*(parseInt(_0x28cd20(0x1ca))/0x6)+-parseInt(_0x28cd20(0x180))/0x7*(parseInt(_0x28cd20(0x1bf))/0x8)+-parseInt(_0x28cd20(0x113))/0x9*(-parseInt(_0x28cd20(0x19e))/0xa)+-parseInt(_0x28cd20(0x1c4))/0xb*(parseInt(_0x28cd20(0x131))/0xc)+parseInt(_0x28cd20(0x164))/0xd;if(_0x140034===_0x26ceed)break;else _0x793c1d['push'](_0x793c1d['shift']());}catch(_0x2b76ae){_0x793c1d['push'](_0x793c1d['shift']());}}}(a37_0x5abf,0x92bc8));function a37_0x5abf(){const _0x4fff6e=['shopId','payment.success','clearPaymentTimers','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','coinToPayStatusService','\x20for\x20payment\x20','toISOString','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','create','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20',',\x20stopping\x20individual\x20checks','PENDING','payment','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','application/json','settings','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','CoinToPayStatusService','\x20->\x20','auto_expire','27GYJUzX','not\x20found','Automatically\x20expired\x20after\x20','\x20days,\x20marking\x20as\x20EXPIRED','⏰\x20[HOURLY]\x20Payment\x20','delay','COINTOPAY_STATUS_CHANGE','./telegramBotService','gatewayPaymentId','TesSoft\x20Payment\x20System/1.0','📊\x20[CHECK]\x20Payment\x20','⏰\x20[EXPIRY]\x20Payment\x20','✅\x20[EXPIRY]\x20Payment\x20','schedulePaymentChecks','\x20days\x20(created\x20before\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','15462551bNafKl','stringify','h),\x20skipping\x20global\x20check','paid','2\x20minutes','paymentDetails','\x20is\x20older\x20than\x20','amount','from','\x20seconds\x20(','\x20days\x20without\x20payment\x20confirmation','\x20status:\x20','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','createdOn','findUnique','✅\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20ShopId:\x20','🪙\x20CoinToPayStatusService\x20initialized','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','failed','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','Payment\x20older\x20than\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20\x20\x20📅\x20Time:\x20','coinToPayService','customerName','\x20\x20\x20-\x20paymentId:\x20','245ZSjEhT','transactionId','\x20status\x20unchanged\x20(','\x20\x20\x20-\x20Amount:\x20','CoinToPayService','\x20not\x20enabled\x20for\x20shop\x20','\x20timers\x20for\x20payment\x20','📊\x20[HOURLY]\x20Payment\x20','paidAt','\x20to\x20clear','cointopay','\x20skipped,\x20','gatewayOrderId','⏰\x20[GLOBAL]\x20Payment\x20','error','PAID','\x20in\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','setDate','createdAt','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','forEach','defineProperty','cointopay_auto_expired','log','length','✅\x20[HOURLY]\x20Payment\x20','checkAllPendingPayments','ms)','2050erhiQC','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','checkSinglePaymentById','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','toFixed','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','expired','sendPaymentStatusNotification','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','text','\x20not\x20found\x20in\x20database','checkSinglePayment','\x20found:','\x20details:','🧹\x20[CHECK]\x20Payment\x20','⏰\x20[GLOBAL]\x20Found\x20','getPaymentTimerInfo','\x20pending\x20CoinToPay\x20payments','\x20checked,\x20','size','stopPeriodicStatusCheck','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','message','description','143214TZwBPB','now','\x20individual\x20payment\x20timers','timestamp','values','push','globalCheckInterval','94792wNEpES','148632gFFOpO','floor','\x20\x20\x20📊\x20Status:\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','logCoinToPayError','432190Xjtjby','timers','Unknown\x20error','default','5VEWmir','Payment\x20not\x20found','1608294JZSosF','⚠️\x20[CHECK]\x20Payment\x20','sendShopWebhook','confirmedOn','COINTOPAY_ERROR','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','../config/database','sendPaymentNotification','Failed\x20to\x20mark\x20payment\x20as\x20expired','EXPIRY_DAYS','Webhook\x20event\x20','\x20days','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20triggered\x20for\x20payment\x20','\x20to\x20','EXPIRED','✅\x20[TIMER]\x20Individual\x20check\x20#','gateway','💰\x20[CHECK]\x20Payment\x20','findMany','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20\x20\x20❌\x20Error:\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20current\x20status:\x20','update','payment.pending','created','POST','status_check','customerEmail','getTime','5\x20minutes','adminNotes','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','🧹\x20[DEBUG]\x20Clearing\x20','logWhiteDomainError','\x20status\x20is\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','checkExpiredPayments','get','-day\x20timeout','🔄\x20[CHECK]\x20Updating\x20payment\x20','.\x20Remaining\x20active\x20timers:\x20','remitterIban','Success','🪙\x20[GLOBAL]\x20Found\x20','webhookUrl','catch','shop','\x20initial\x20timers\x20for\x20payment\x20','GLOBAL_CHECK_INTERVAL_MS','46773iWDfBt','\x20\x20\x20📝\x20Details:','logShopWebhookSent','\x20expired\x20CoinToPay\x20payments','checkPaymentStatus','unknown','\x20expired','includes','❌\x20[CHECK]\x20Payment\x20','bankDetails','\x20status\x20changed\x20to\x20','\x20with\x20status\x20','logCoinToPayStatus','\x20\x20\x20📝\x20Context:','currency','Failed\x20to\x20send\x20shop\x20webhook:','./gateways/coinToPayService','🪙\x20[TIMER]\x20Individual\x20check\x20#','FAILED','cointopay_status_check_','has','6zKNvaM','status','__importDefault','toLowerCase','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20completed\x20for\x20payment\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20\x20\x20📍\x20Source:\x20','192xFUXRo','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','checkPaymentById','0100','startPeriodicStatusCheck','webhookLog','paymentTimers','loggerService','\x20marked\x20as\x20paid\x20at:\x20','iban','\x20status\x20from\x20'];a37_0x5abf=function(){return _0x4fff6e;};return a37_0x5abf();}var __importDefault=this&&this[a37_0x595bd9(0x12a)]||function(_0x4758d1){return _0x4758d1&&_0x4758d1['__esModule']?_0x4758d1:{'default':_0x4758d1};};Object[a37_0x595bd9(0x197)](exports,'__esModule',{'value':!![]}),exports[a37_0x595bd9(0x141)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a37_0x595bd9(0x123)),database_1=__importDefault(require(a37_0x595bd9(0x1d0))),telegramBotService_1=require(a37_0x595bd9(0x15a)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x156364=a37_0x595bd9;this[_0x156364(0x1bd)]=null,this[_0x156364(0x112)]=0x3c*0x3c*0x3e8,this[_0x156364(0x1d3)]=0x5,this['paymentTimers']=new Map(),this[_0x156364(0x17d)]=new coinToPayService_1[(_0x156364(0x184))](),console['log'](_0x156364(0x176));}[a37_0x595bd9(0x160)](_0x9fe7f7,_0xb72d77){const _0x4c7b82=a37_0x595bd9;console[_0x4c7b82(0x199)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x4c7b82(0x199)](_0x4c7b82(0x17f)+_0x9fe7f7),console[_0x4c7b82(0x199)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0xb72d77),this[_0x4c7b82(0x13f)](_0x9fe7f7);const _0x2752c5=[],_0x40dda0=new Date(),_0x1a3121=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x4c7b82(0x168)},{'delay':0x5*0x3c*0x3e8,'description':_0x4c7b82(0xfe)},{'delay':0x5*0x3c*0x3e8,'description':_0x4c7b82(0xfe)}];console[_0x4c7b82(0x199)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x1a3121[_0x4c7b82(0x19a)]+_0x4c7b82(0x111)+_0x9fe7f7);let _0xacc93a=0x0;_0x1a3121[_0x4c7b82(0x196)]((_0x5167f7,_0x86a5df)=>{const _0x4eb7dd=_0x4c7b82;_0xacc93a+=_0x5167f7[_0x4eb7dd(0x158)];const _0x187924=setTimeout(async()=>{const _0x1c7a6f=_0x4eb7dd;console[_0x1c7a6f(0x199)](_0x1c7a6f(0x124)+(_0x86a5df+0x1)+_0x1c7a6f(0x1d7)+_0x9fe7f7+'\x20(after\x20'+_0x5167f7[_0x1c7a6f(0x1b6)]+')');try{await this[_0x1c7a6f(0x1a1)](_0x9fe7f7),console[_0x1c7a6f(0x199)](_0x1c7a6f(0x1da)+(_0x86a5df+0x1)+_0x1c7a6f(0x12e)+_0x9fe7f7);}catch(_0x1ff255){console['error'](_0x1c7a6f(0x1cf)+(_0x86a5df+0x1)+_0x1c7a6f(0x142)+_0x9fe7f7+':',_0x1ff255),this[_0x1c7a6f(0x1c3)](_0x9fe7f7,_0xb72d77,_0x1ff255,'status_check',{'checkNumber':_0x86a5df+0x1,'scheduledAfter':_0x5167f7[_0x1c7a6f(0x1b6)],'isIndividualCheck':!![]});}},_0xacc93a);_0x2752c5[_0x4eb7dd(0x1bc)](_0x187924),console[_0x4eb7dd(0x199)](_0x4eb7dd(0x1d6)+(_0x86a5df+0x1)+'\x20for\x20payment\x20'+_0x9fe7f7+_0x4eb7dd(0x190)+_0xacc93a/0x3e8+_0x4eb7dd(0x16d)+_0x5167f7[_0x4eb7dd(0x1b6)]+')');});const _0x71307a=setInterval(async()=>{const _0x528edd=_0x4c7b82;console['log'](_0x528edd(0x14f)+_0x9fe7f7);try{const _0x1be384=await database_1[_0x528edd(0x1c7)]['payment'][_0x528edd(0x173)]({'where':{'id':_0x9fe7f7},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x1be384){console[_0x528edd(0x199)]('❌\x20[HOURLY]\x20Payment\x20'+_0x9fe7f7+'\x20not\x20found,\x20clearing\x20timers'),this[_0x528edd(0x13f)](_0x9fe7f7);return;}console['log'](_0x528edd(0x187)+_0x9fe7f7+_0x528edd(0x1e1)+_0x1be384['status']);if(_0x1be384[_0x528edd(0x129)]!=='PENDING'){console[_0x528edd(0x199)](_0x528edd(0x19b)+_0x9fe7f7+_0x528edd(0x104)+_0x1be384[_0x528edd(0x129)]+_0x528edd(0x148)),this[_0x528edd(0x13f)](_0x9fe7f7);return;}const _0x1f41a3=Math[_0x528edd(0x1c0)]((Date['now']()-_0x1be384[_0x528edd(0x194)][_0x528edd(0x1e8)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1f41a3>=this[_0x528edd(0x1d3)]){console[_0x528edd(0x199)](_0x528edd(0x157)+_0x9fe7f7+_0x528edd(0x16a)+this[_0x528edd(0x1d3)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x528edd(0x13f)](_0x9fe7f7);return;}await this['checkSinglePaymentById'](_0x9fe7f7),console['log']('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x9fe7f7);}catch(_0x23d19b){console[_0x528edd(0x18e)](_0x528edd(0x1a0)+_0x9fe7f7+':',_0x23d19b),this[_0x528edd(0x1c3)](_0x9fe7f7,_0xb72d77,_0x23d19b,_0x528edd(0x1e6),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x2752c5[_0x4c7b82(0x1bc)](_0x71307a),this[_0x4c7b82(0x138)]['set'](_0x9fe7f7,{'timers':_0x2752c5,'paymentId':_0x9fe7f7,'gatewayPaymentId':_0xb72d77,'createdAt':_0x40dda0}),console[_0x4c7b82(0x199)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x1a3121[_0x4c7b82(0x19a)]+_0x4c7b82(0x105)+_0x9fe7f7),console[_0x4c7b82(0x199)](_0x4c7b82(0x132)+this[_0x4c7b82(0x138)][_0x4c7b82(0x1b2)]),this['logCoinToPayStatus'](_0x9fe7f7,_0xb72d77,_0x4c7b82(0x149),_0x4c7b82(0x149),'status_check',{'action':'schedule_created','scheduledChecks':_0x1a3121[_0x4c7b82(0x19a)],'firstCheckIn':_0x1a3121[0x0][_0x4c7b82(0x158)]/0x3e8,'totalTimers':this['paymentTimers'][_0x4c7b82(0x1b2)]});}[a37_0x595bd9(0x13f)](_0x46f9b4){const _0x393ccb=a37_0x595bd9,_0x239c7d=this['paymentTimers'][_0x393ccb(0x107)](_0x46f9b4);_0x239c7d?(console[_0x393ccb(0x199)](_0x393ccb(0x102)+_0x239c7d[_0x393ccb(0x1c5)][_0x393ccb(0x19a)]+_0x393ccb(0x186)+_0x46f9b4),_0x239c7d[_0x393ccb(0x1c5)][_0x393ccb(0x196)]((_0x3b1bc6,_0x64e8db)=>{const _0x5d6fff=_0x393ccb;_0x3b1bc6&&(clearTimeout(_0x3b1bc6),clearInterval(_0x3b1bc6),console[_0x5d6fff(0x199)](_0x5d6fff(0x162)+(_0x64e8db+0x1)+_0x5d6fff(0x142)+_0x46f9b4));}),this[_0x393ccb(0x138)]['delete'](_0x46f9b4),console[_0x393ccb(0x199)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x46f9b4+_0x393ccb(0x10a)+this[_0x393ccb(0x138)][_0x393ccb(0x1b2)])):console[_0x393ccb(0x199)](_0x393ccb(0x1c2)+_0x46f9b4+_0x393ccb(0x189));}async[a37_0x595bd9(0x1a1)](_0x4eea6f){const _0xfd0d91=a37_0x595bd9;console[_0xfd0d91(0x199)](_0xfd0d91(0x191)+_0x4eea6f);const _0x1dc28e=await database_1[_0xfd0d91(0x1c7)][_0xfd0d91(0x14a)][_0xfd0d91(0x173)]({'where':{'id':_0x4eea6f},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1dc28e){console[_0xfd0d91(0x199)](_0xfd0d91(0x11b)+_0x4eea6f+_0xfd0d91(0x1a9));return;}console[_0xfd0d91(0x199)](_0xfd0d91(0x15d)+_0x4eea6f+_0xfd0d91(0x1ab)),console[_0xfd0d91(0x199)]('\x20\x20\x20-\x20Gateway:\x20'+_0x1dc28e[_0xfd0d91(0x1db)]),console['log']('\x20\x20\x20-\x20Status:\x20'+_0x1dc28e[_0xfd0d91(0x129)]),console[_0xfd0d91(0x199)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x1dc28e['gatewayPaymentId']),console[_0xfd0d91(0x199)](_0xfd0d91(0x183)+_0x1dc28e[_0xfd0d91(0x16b)]+'\x20'+_0x1dc28e[_0xfd0d91(0x121)]),console[_0xfd0d91(0x199)](_0xfd0d91(0x175)+_0x1dc28e[_0xfd0d91(0x13d)]);if(_0x1dc28e[_0xfd0d91(0x1db)]!==_0xfd0d91(0x18a)){console[_0xfd0d91(0x199)](_0xfd0d91(0x1cb)+_0x4eea6f+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x1dc28e['gateway']+')');return;}if(_0x1dc28e[_0xfd0d91(0x129)]!==_0xfd0d91(0x149)){console[_0xfd0d91(0x199)](_0xfd0d91(0x1cb)+_0x4eea6f+'\x20status\x20is\x20'+_0x1dc28e[_0xfd0d91(0x129)]+_0xfd0d91(0x148)),this[_0xfd0d91(0x13f)](_0x4eea6f);return;}if(!_0x1dc28e[_0xfd0d91(0x15b)]){console['log'](_0xfd0d91(0x1cb)+_0x4eea6f+'\x20has\x20no\x20gatewayPaymentId');return;}console['log']('✅\x20[CHECK]\x20Payment\x20'+_0x4eea6f+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0xfd0d91(0x1aa)](_0x1dc28e);}[a37_0x595bd9(0x11f)](_0x33a471,_0x4f4866,_0x28cd2d,_0x24b1ab,_0x96c8f9,_0x1fffa2){const _0x12d991=a37_0x595bd9,_0x1caf0d={'type':_0x12d991(0x159),'paymentId':_0x33a471,'gatewayPaymentId':_0x4f4866,'oldStatus':_0x28cd2d,'newStatus':_0x24b1ab,'source':_0x96c8f9,'timestamp':new Date()[_0x12d991(0x143)](),'details':_0x1fffa2||{}};loggerService_1[_0x12d991(0x139)][_0x12d991(0x11f)](_0x1caf0d),console[_0x12d991(0x199)](_0x12d991(0x133)+_0x33a471+'\x20('+_0x4f4866+')'),console['log'](_0x12d991(0x1c1)+_0x28cd2d+_0x12d991(0x151)+_0x24b1ab),console['log'](_0x12d991(0x130)+_0x96c8f9),console[_0x12d991(0x199)](_0x12d991(0x17c)+_0x1caf0d['timestamp']),_0x1fffa2&&console[_0x12d991(0x199)](_0x12d991(0x114),_0x1fffa2);}['logCoinToPayError'](_0x305cc2,_0x47a799,_0x5073a5,_0x38cd24,_0x35e5ab){const _0x56441d=a37_0x595bd9,_0x3a04c9={'type':_0x56441d(0x1ce),'paymentId':_0x305cc2,'gatewayPaymentId':_0x47a799,'error':_0x5073a5 instanceof Error?{'message':_0x5073a5[_0x56441d(0x1b5)],'stack':_0x5073a5['stack']}:_0x5073a5,'source':_0x38cd24,'timestamp':new Date()[_0x56441d(0x143)](),'context':_0x35e5ab||{}};loggerService_1[_0x56441d(0x139)]['logCoinToPayError'](_0x3a04c9),console['error'](_0x56441d(0x1b4)+_0x305cc2+'\x20('+_0x47a799+')'),console[_0x56441d(0x18e)](_0x56441d(0x1df)+(_0x5073a5 instanceof Error?_0x5073a5[_0x56441d(0x1b5)]:_0x5073a5)),console['error']('\x20\x20\x20📍\x20Source:\x20'+_0x38cd24),console[_0x56441d(0x18e)](_0x56441d(0x17c)+_0x3a04c9[_0x56441d(0x1ba)]),_0x35e5ab&&console['error'](_0x56441d(0x120),_0x35e5ab);}[a37_0x595bd9(0x136)](){const _0x45a40e=a37_0x595bd9;console[_0x45a40e(0x199)](_0x45a40e(0x1a2)),this[_0x45a40e(0x19c)]()[_0x45a40e(0x10f)](_0x53005e=>{const _0x5c7faa=_0x45a40e;console[_0x5c7faa(0x18e)](_0x5c7faa(0x17b),_0x53005e);}),this[_0x45a40e(0x1bd)]=setInterval(async()=>{const _0x3e41e6=_0x45a40e;try{console[_0x3e41e6(0x199)](_0x3e41e6(0x145)),await this[_0x3e41e6(0x19c)](),console[_0x3e41e6(0x199)](_0x3e41e6(0x163));}catch(_0x5aa4cd){console[_0x3e41e6(0x18e)]('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x5aa4cd);}},this[_0x45a40e(0x112)]),console[_0x45a40e(0x199)](_0x45a40e(0x179));}[a37_0x595bd9(0x1b3)](){const _0x15fc3f=a37_0x595bd9;console['log'](_0x15fc3f(0x195));this[_0x15fc3f(0x1bd)]&&(clearInterval(this[_0x15fc3f(0x1bd)]),this[_0x15fc3f(0x1bd)]=null,console[_0x15fc3f(0x199)](_0x15fc3f(0x12d)));const _0x4f5c4f=this[_0x15fc3f(0x138)][_0x15fc3f(0x1b2)];for(const [_0x3c4224]of this[_0x15fc3f(0x138)]){this[_0x15fc3f(0x13f)](_0x3c4224);}console[_0x15fc3f(0x199)]('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x4f5c4f+_0x15fc3f(0x1b9));}async[a37_0x595bd9(0x19c)](){const _0x2025f4=a37_0x595bd9;try{console['log'](_0x2025f4(0x14b));const _0x59e27f=await database_1[_0x2025f4(0x1c7)][_0x2025f4(0x14a)][_0x2025f4(0x1dd)]({'where':{'gateway':_0x2025f4(0x18a),'status':_0x2025f4(0x149),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x2025f4(0x10d)+_0x59e27f['length']+_0x2025f4(0x1b0));if(_0x59e27f['length']===0x0){console['log'](_0x2025f4(0x100));return;}const _0x3834dd=await this[_0x2025f4(0x106)](_0x59e27f);console[_0x2025f4(0x199)](_0x2025f4(0x1ae)+_0x3834dd['length']+_0x2025f4(0x116));let _0x3e0af1=0x0,_0x417865=0x0;for(const _0x129748 of _0x59e27f){try{if(_0x3834dd[_0x2025f4(0x11a)](_0x129748['id'])){console['log'](_0x2025f4(0x18d)+_0x129748['id']+_0x2025f4(0x1a4)),_0x417865++;continue;}if(this[_0x2025f4(0x138)][_0x2025f4(0x127)](_0x129748['id'])){console[_0x2025f4(0x199)](_0x2025f4(0x18d)+_0x129748['id']+_0x2025f4(0x1de)),_0x417865++;continue;}const _0x44e7c4=(Date[_0x2025f4(0x1b8)]()-_0x129748['createdAt'][_0x2025f4(0x1e8)]())/(0x3e8*0x3c*0x3c);if(_0x44e7c4<0x1){console[_0x2025f4(0x199)](_0x2025f4(0x18d)+_0x129748['id']+'\x20is\x20too\x20new\x20('+_0x44e7c4[_0x2025f4(0x1a3)](0x1)+_0x2025f4(0x166)),_0x417865++;continue;}console[_0x2025f4(0x199)]('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x129748['id']+'\x20(age:\x20'+_0x44e7c4[_0x2025f4(0x1a3)](0x1)+'h)'),await this[_0x2025f4(0x1aa)](_0x129748),_0x3e0af1++,await new Promise(_0x2d9238=>setTimeout(_0x2d9238,0x7d0));}catch(_0xb93c7b){console[_0x2025f4(0x18e)](_0x2025f4(0x12f)+_0x129748['id']+':',_0xb93c7b),this[_0x2025f4(0x1c3)](_0x129748['id'],_0x129748['gatewayPaymentId']||'unknown',_0xb93c7b,_0x2025f4(0x1e6),{'isGlobalCheck':!![],'paymentAmount':_0x129748[_0x2025f4(0x16b)],'paymentCurrency':_0x129748[_0x2025f4(0x121)],'shopId':_0x129748[_0x2025f4(0x13d)],'createdAt':_0x129748[_0x2025f4(0x194)]}),loggerService_1[_0x2025f4(0x139)][_0x2025f4(0x103)](_0x2025f4(0x18a),'/status/'+_0x129748[_0x2025f4(0x15b)],_0xb93c7b);}}console['log'](_0x2025f4(0x12c)+_0x3e0af1+_0x2025f4(0x1b1)+_0x417865+_0x2025f4(0x18b)+_0x3834dd[_0x2025f4(0x19a)]+_0x2025f4(0x119));}catch(_0x557176){console[_0x2025f4(0x18e)](_0x2025f4(0x144),_0x557176);}}async[a37_0x595bd9(0x106)](_0x49c78c){const _0x5509b5=a37_0x595bd9,_0x194bb1=[],_0x2d1d55=new Date();_0x2d1d55[_0x5509b5(0x193)](_0x2d1d55['getDate']()-this['EXPIRY_DAYS']),console[_0x5509b5(0x199)](_0x5509b5(0x101)+this[_0x5509b5(0x1d3)]+_0x5509b5(0x161)+_0x2d1d55[_0x5509b5(0x143)]()+')');for(const _0x3b756b of _0x49c78c){if(_0x3b756b[_0x5509b5(0x194)]<_0x2d1d55){console[_0x5509b5(0x199)](_0x5509b5(0x15e)+_0x3b756b['id']+'\x20is\x20older\x20than\x20'+this[_0x5509b5(0x1d3)]+_0x5509b5(0x156));try{this['logCoinToPayStatus'](_0x3b756b['id'],_0x3b756b['gatewayPaymentId']||_0x5509b5(0x118),_0x5509b5(0x149),_0x5509b5(0x1d9),_0x5509b5(0x152),{'reason':_0x5509b5(0x17a)+this[_0x5509b5(0x1d3)]+'\x20days','createdAt':_0x3b756b['createdAt'],'daysSinceCreation':Math[_0x5509b5(0x1c0)]((Date['now']()-_0x3b756b['createdAt'][_0x5509b5(0x1e8)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x3b756b[_0x5509b5(0x16b)],'paymentCurrency':_0x3b756b['currency'],'shopId':_0x3b756b[_0x5509b5(0x13d)]}),await database_1[_0x5509b5(0x1c7)][_0x5509b5(0x14a)][_0x5509b5(0x1e2)]({'where':{'id':_0x3b756b['id']},'data':{'status':_0x5509b5(0x1d9),'updatedAt':new Date(),'adminNotes':_0x5509b5(0x155)+this[_0x5509b5(0x1d3)]+_0x5509b5(0x16e)}}),await database_1[_0x5509b5(0x1c7)][_0x5509b5(0x137)]['create']({'data':{'paymentId':_0x3b756b['id'],'shopId':_0x3b756b[_0x5509b5(0x13d)],'event':_0x5509b5(0x198),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':'Payment\x20older\x20than\x20'+this[_0x5509b5(0x1d3)]+_0x5509b5(0x1d5),'createdAt':_0x3b756b[_0x5509b5(0x194)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math['floor']((Date[_0x5509b5(0x1b8)]()-_0x3b756b[_0x5509b5(0x194)][_0x5509b5(0x1e8)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x5509b5(0x1cc)](_0x3b756b,_0x5509b5(0x1d9)),await this[_0x5509b5(0x1a6)](_0x3b756b,_0x5509b5(0x1d9)),this[_0x5509b5(0x13f)](_0x3b756b['id']),_0x194bb1[_0x5509b5(0x1bc)](_0x3b756b['id']),console[_0x5509b5(0x199)](_0x5509b5(0x15f)+_0x3b756b['id']+_0x5509b5(0x140)+this['EXPIRY_DAYS']+_0x5509b5(0x108));}catch(_0x569b63){console[_0x5509b5(0x18e)](_0x5509b5(0x192)+_0x3b756b['id']+':',_0x569b63),this[_0x5509b5(0x1c3)](_0x3b756b['id'],_0x3b756b[_0x5509b5(0x15b)]||_0x5509b5(0x118),_0x569b63,_0x5509b5(0x152),{'reason':_0x5509b5(0x1d2),'createdAt':_0x3b756b[_0x5509b5(0x194)],'daysSinceCreation':Math[_0x5509b5(0x1c0)]((Date['now']()-_0x3b756b['createdAt'][_0x5509b5(0x1e8)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x194bb1;}async[a37_0x595bd9(0x1aa)](_0x33e26e){const _0x1bbc88=a37_0x595bd9;if(!_0x33e26e['gatewayPaymentId']){console[_0x1bbc88(0x199)](_0x1bbc88(0x1cb)+_0x33e26e['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console['log']('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x33e26e['id']+'\x20('+_0x33e26e['gatewayPaymentId']+')');try{const _0x9c1cc9=await this[_0x1bbc88(0x17d)][_0x1bbc88(0x117)](_0x33e26e['gatewayPaymentId']);console[_0x1bbc88(0x199)](_0x1bbc88(0x15d)+_0x33e26e['id']+_0x1bbc88(0x16f)+_0x9c1cc9[_0x1bbc88(0x129)]);_0x9c1cc9[_0x1bbc88(0x169)]&&console[_0x1bbc88(0x199)](_0x1bbc88(0x15d)+_0x33e26e['id']+_0x1bbc88(0x1ac),{'iban':_0x9c1cc9[_0x1bbc88(0x169)]['iban']||_0x1bbc88(0x154),'transactionId':_0x9c1cc9[_0x1bbc88(0x169)][_0x1bbc88(0x181)],'createdOn':_0x9c1cc9['paymentDetails'][_0x1bbc88(0x172)],'confirmedOn':_0x9c1cc9['paymentDetails'][_0x1bbc88(0x1cd)]||'not\x20confirmed'});if(_0x9c1cc9[_0x1bbc88(0x129)]!==_0x33e26e['status']){console['log'](_0x1bbc88(0x109)+_0x33e26e['id']+_0x1bbc88(0x13c)+_0x33e26e[_0x1bbc88(0x129)]+_0x1bbc88(0x1d8)+_0x9c1cc9[_0x1bbc88(0x129)]),this[_0x1bbc88(0x11f)](_0x33e26e['id'],_0x33e26e[_0x1bbc88(0x15b)],_0x33e26e[_0x1bbc88(0x129)],_0x9c1cc9['status'],_0x1bbc88(0x1e6),{'paymentDetails':_0x9c1cc9['paymentDetails'],'amount':_0x9c1cc9[_0x1bbc88(0x16b)],'currency':_0x9c1cc9[_0x1bbc88(0x121)],'shopId':_0x33e26e['shopId'],'checkTimestamp':new Date()[_0x1bbc88(0x143)]()});const _0x4bab4b={'status':_0x9c1cc9['status'],'updatedAt':new Date()};_0x9c1cc9[_0x1bbc88(0x129)]===_0x1bbc88(0x18f)&&_0x33e26e[_0x1bbc88(0x129)]!==_0x1bbc88(0x18f)&&(_0x4bab4b[_0x1bbc88(0x188)]=new Date(),console['log'](_0x1bbc88(0x1dc)+_0x33e26e['id']+_0x1bbc88(0x13a)+_0x4bab4b['paidAt'][_0x1bbc88(0x143)]()));if(_0x9c1cc9['paymentDetails']){const _0x3b31c1=_0x9c1cc9[_0x1bbc88(0x169)];_0x3b31c1[_0x1bbc88(0x13b)]&&(_0x4bab4b[_0x1bbc88(0x10b)]=_0x3b31c1['iban'],console[_0x1bbc88(0x199)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x3b31c1[_0x1bbc88(0x13b)]));if(_0x3b31c1[_0x1bbc88(0x11c)]){const _0x4b910a=_0x33e26e[_0x1bbc88(0xff)]||'',_0x1472c3='Bank\x20Details:\x20'+_0x3b31c1['bankDetails'];_0x4bab4b['adminNotes']=_0x4b910a?_0x4b910a+'\x0a\x0a'+_0x1472c3:_0x1472c3,console[_0x1bbc88(0x199)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x3b31c1[_0x1bbc88(0x181)]&&console['log'](_0x1bbc88(0x171)+_0x3b31c1['transactionId']),_0x3b31c1['confirmedOn']&&console[_0x1bbc88(0x199)](_0x1bbc88(0x170)+_0x3b31c1['confirmedOn']);}await database_1[_0x1bbc88(0x1c7)][_0x1bbc88(0x14a)][_0x1bbc88(0x1e2)]({'where':{'id':_0x33e26e['id']},'data':_0x4bab4b}),await database_1[_0x1bbc88(0x1c7)]['webhookLog'][_0x1bbc88(0x146)]({'data':{'paymentId':_0x33e26e['id'],'shopId':_0x33e26e['shopId'],'event':_0x1bbc88(0x126)+_0x9c1cc9['status'][_0x1bbc88(0x12b)](),'statusCode':0xc8,'responseBody':JSON[_0x1bbc88(0x165)]({'oldStatus':_0x33e26e[_0x1bbc88(0x129)],'newStatus':_0x9c1cc9[_0x1bbc88(0x129)],'paymentDetails':_0x9c1cc9['paymentDetails'],'checkedAt':new Date()[_0x1bbc88(0x143)]()})}}),await this['sendShopWebhook'](_0x33e26e,_0x9c1cc9['status']),await this[_0x1bbc88(0x1a6)](_0x33e26e,_0x9c1cc9[_0x1bbc88(0x129)]),_0x9c1cc9[_0x1bbc88(0x129)]!==_0x1bbc88(0x149)&&(console['log'](_0x1bbc88(0x1ad)+_0x33e26e['id']+_0x1bbc88(0x11d)+_0x9c1cc9[_0x1bbc88(0x129)]+',\x20clearing\x20individual\x20timers'),this['clearPaymentTimers'](_0x33e26e['id'])),console[_0x1bbc88(0x199)](_0x1bbc88(0x174)+_0x33e26e['id']+'\x20updated\x20successfully');}else console[_0x1bbc88(0x199)](_0x1bbc88(0x15d)+_0x33e26e['id']+_0x1bbc88(0x182)+_0x9c1cc9[_0x1bbc88(0x129)]+')'),this[_0x1bbc88(0x11f)](_0x33e26e['id'],_0x33e26e['gatewayPaymentId'],_0x33e26e[_0x1bbc88(0x129)],_0x9c1cc9[_0x1bbc88(0x129)],_0x1bbc88(0x1e6),{'statusUnchanged':!![],'paymentDetails':_0x9c1cc9[_0x1bbc88(0x169)],'amount':_0x9c1cc9[_0x1bbc88(0x16b)],'currency':_0x9c1cc9['currency'],'shopId':_0x33e26e['shopId'],'checkTimestamp':new Date()['toISOString']()});}catch(_0x200aba){console[_0x1bbc88(0x18e)](_0x1bbc88(0x1a7)+_0x33e26e['id']+':',_0x200aba),this[_0x1bbc88(0x1c3)](_0x33e26e['id'],_0x33e26e[_0x1bbc88(0x15b)],_0x200aba,'status_check',{'paymentAmount':_0x33e26e['amount'],'paymentCurrency':_0x33e26e[_0x1bbc88(0x121)],'shopId':_0x33e26e[_0x1bbc88(0x13d)],'createdAt':_0x33e26e[_0x1bbc88(0x194)]}),await database_1[_0x1bbc88(0x1c7)][_0x1bbc88(0x137)][_0x1bbc88(0x146)]({'data':{'paymentId':_0x33e26e['id'],'shopId':_0x33e26e[_0x1bbc88(0x13d)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x1bbc88(0x165)]({'error':_0x200aba instanceof Error?_0x200aba[_0x1bbc88(0x1b5)]:_0x1bbc88(0x1c6),'gatewayPaymentId':_0x33e26e[_0x1bbc88(0x15b)],'checkedAt':new Date()[_0x1bbc88(0x143)]()})}});}}async[a37_0x595bd9(0x1cc)](_0x44546f,_0x4bdf82){const _0x2e05b4=a37_0x595bd9,_0x56e9f5=Date[_0x2e05b4(0x1b8)]();try{const _0x4860e1=_0x44546f[_0x2e05b4(0x110)],_0x5edfff=_0x4860e1['settings'];if(!_0x5edfff?.['webhookUrl']){console[_0x2e05b4(0x199)](_0x2e05b4(0x177)+_0x4860e1['id']);return;}const _0x19d1e2=_0x4bdf82===_0x2e05b4(0x18f)?_0x2e05b4(0x13e):_0x4bdf82===_0x2e05b4(0x125)?'payment.failed':_0x4bdf82===_0x2e05b4(0x1d9)?'payment.failed':_0x2e05b4(0x1e3);if(!_0x5edfff['webhookEvents']?.[_0x2e05b4(0x11a)](_0x19d1e2)){console[_0x2e05b4(0x199)](_0x2e05b4(0x1d4)+_0x19d1e2+_0x2e05b4(0x185)+_0x4860e1['id']);return;}const _0x4948bf={'event':_0x19d1e2,'payment':{'id':_0x44546f['id'],'order_id':_0x44546f['orderId'],'gateway_order_id':_0x44546f[_0x2e05b4(0x18c)],'gateway':_0x2e05b4(0x135),'amount':_0x44546f['amount'],'currency':_0x44546f[_0x2e05b4(0x121)],'status':_0x4bdf82['toLowerCase'](),'customer_email':_0x44546f[_0x2e05b4(0x1e7)],'customer_name':_0x44546f[_0x2e05b4(0x17e)],'created_at':_0x44546f['createdAt'],'updated_at':new Date()}},_0x219323=await fetch(_0x5edfff[_0x2e05b4(0x10e)],{'method':_0x2e05b4(0x1e5),'headers':{'Content-Type':_0x2e05b4(0x14c),'User-Agent':_0x2e05b4(0x15c)},'body':JSON['stringify'](_0x4948bf)}),_0x30b1b6=Date['now']()-_0x56e9f5,_0x18aa0a=_0x219323['ok']?_0x2e05b4(0x10c):await _0x219323[_0x2e05b4(0x1a8)]();loggerService_1[_0x2e05b4(0x139)][_0x2e05b4(0x115)](_0x44546f[_0x2e05b4(0x13d)],_0x5edfff['webhookUrl'],_0x19d1e2,_0x219323['status'],_0x30b1b6,_0x4948bf),console[_0x2e05b4(0x199)]('Shop\x20webhook\x20sent\x20to\x20'+_0x5edfff[_0x2e05b4(0x10e)]+_0x2e05b4(0x11e)+_0x219323['status']+'\x20('+_0x30b1b6+_0x2e05b4(0x19d));}catch(_0x341768){console[_0x2e05b4(0x18e)](_0x2e05b4(0x122),_0x341768),loggerService_1[_0x2e05b4(0x139)]['logShopWebhookError'](_0x44546f['shopId'],_0x44546f[_0x2e05b4(0x110)]?.[_0x2e05b4(0x14d)]?.['webhookUrl']||_0x2e05b4(0x118),'webhook_send',_0x341768,{});}}async[a37_0x595bd9(0x1a6)](_0x9134a9,_0xfa5fdf){const _0x271c74=a37_0x595bd9;try{const _0x4d8ec4={'PENDING':_0x271c74(0x1e4),'PAID':_0x271c74(0x167),'FAILED':_0x271c74(0x178),'EXPIRED':_0x271c74(0x1a5)},_0x4681b7=_0x4d8ec4[_0xfa5fdf];if(!_0x4681b7||_0x4681b7===_0x271c74(0x1e4))return;await telegramBotService_1['telegramBotService'][_0x271c74(0x1d1)](_0x9134a9['shopId'],_0x9134a9,_0x4681b7);}catch(_0x356e60){console[_0x271c74(0x18e)](_0x271c74(0x19f),_0x356e60);}}async[a37_0x595bd9(0x134)](_0x34246c){const _0x29fd8f=a37_0x595bd9;console['log']('🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x34246c);const _0x175de4=await database_1[_0x29fd8f(0x1c7)][_0x29fd8f(0x14a)][_0x29fd8f(0x173)]({'where':{'id':_0x34246c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x175de4)throw new Error(_0x29fd8f(0x1c9));if(_0x175de4[_0x29fd8f(0x1db)]!==_0x29fd8f(0x18a))throw new Error(_0x29fd8f(0x14e));console[_0x29fd8f(0x199)](_0x29fd8f(0x1e0)+_0x34246c),await this[_0x29fd8f(0x1aa)](_0x175de4),console['log'](_0x29fd8f(0x147)+_0x34246c);}['getServiceStats'](){const _0x3a7688=a37_0x595bd9,_0x32e526=this[_0x3a7688(0x1bd)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x109a26=Array[_0x3a7688(0x16c)](this[_0x3a7688(0x138)][_0x3a7688(0x1bb)]())['map'](_0x12629a=>({'paymentId':_0x12629a['paymentId'],'gatewayPaymentId':_0x12629a[_0x3a7688(0x15b)],'createdAt':_0x12629a[_0x3a7688(0x194)],'timersCount':_0x12629a['timers'][_0x3a7688(0x19a)]}));return{'isActive':!!this[_0x3a7688(0x1bd)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x3a7688(0x1d3)],'activeIndividualTimers':this['paymentTimers'][_0x3a7688(0x1b2)],'nextGlobalCheckIn':_0x32e526,'paymentTimersDetails':_0x109a26};}[a37_0x595bd9(0x1af)](_0x4f79f5){const _0x1a09b4=a37_0x595bd9,_0x480ccd=this[_0x1a09b4(0x138)][_0x1a09b4(0x107)](_0x4f79f5);if(_0x480ccd)return{'hasTimers':!![],'timersCount':_0x480ccd[_0x1a09b4(0x1c5)][_0x1a09b4(0x19a)],'createdAt':_0x480ccd['createdAt'],'gatewayPaymentId':_0x480ccd['gatewayPaymentId']};return{'hasTimers':![]};}}function a37_0x1aaf(_0x32d842,_0x18cdd6){const _0x5abf0e=a37_0x5abf();return a37_0x1aaf=function(_0x1aaf19,_0x440996){_0x1aaf19=_0x1aaf19-0xfe;let _0x3575ef=_0x5abf0e[_0x1aaf19];return _0x3575ef;},a37_0x1aaf(_0x32d842,_0x18cdd6);}exports[a37_0x595bd9(0x150)]=CoinToPayStatusService,exports[a37_0x595bd9(0x141)]=new CoinToPayStatusService();