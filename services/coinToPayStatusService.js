'use strict';function a57_0x2ffb(){const _0x8a3a7c=[',\x20currentPayments=','gatewayOrderId','\x20\x20\x20üìç\x20Source:\x20','2110464dKWdGa','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','parse','logShopWebhookSent','gatewayPaymentId','üßπ\x20[DEBUG]\x20Clearing\x20','startPeriodicStatusCheck','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','text','timestamp','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','üìä\x20[HOURLY]\x20Payment\x20','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','delay','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20in\x20shop\x20','gatewayCommissionRate','../types/gateway','GLOBAL_CHECK_INTERVAL_MS','‚è∞\x20[GLOBAL]\x20Found\x20','loggerService','\x20not\x20found,\x20clearing\x20timers','catch','checkAllPendingPayments','\x20is\x20too\x20new\x20(','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','Success','createdAt','length','üìà\x20[COINTOPAY]\x20Payment\x20','shopId','-day\x20timeout','currentPayments','\x20\x20\x20-\x20Gateway:\x20','status','forEach','paymentTimers','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','globalCheckInterval','__esModule','./telegramBotService','cointopay_status_check_error','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','stringify','customerEmail','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','cointopay_status_check_','12gFyzlW','./loggerService','paymentLinkId','checkPaymentStatus','getPaymentTimerInfo','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20(after\x20','6337370lExlCe','\x20not\x20enabled\x20for\x20shop\x20',',\x20stopping\x20individual\x20checks','\x20to\x20','floor','createdOn','\x20\x20\x20üìù\x20Context:','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','__importDefault','\x20commission\x20for\x20shop\x20','getTime','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','payment.pending','create','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','telegramBotService','hex','\x20to\x20clear','\x20is\x20valid\x20for\x20checking,\x20proceeding...','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','CoinToPayService','sha256','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20\x20\x20-\x20Amount:\x20','‚úÖ\x20[CHECK]\x20Payment\x20','\x20->\x20','confirmedOn','COINTOPAY_STATUS_CHANGE','type','logShopWebhookError','\x20payment\x20','bankDetails','commission','findUnique','checkPaymentById','gateway','message','‚è∞\x20[GLOBAL]\x20Payment\x20','\x20\x20\x20-\x20Status:\x20','push','failed','webhookUrl','\x20not\x20found\x20in\x20database','\x20found:','entries','\x20checked,\x20','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','toFixed','\x20amounts\x20calculated:','\x20updated\x20successfully','findMany','EXPIRED','coinToPay2Service','Unknown\x20error','sendPaymentStatusNotification','size','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','4455648kjfsCQ','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','2\x20minutes','schedule_created','includes','clearPaymentTimers','\x20details:','3226594nIhjxj','webhookLog','toLowerCase','üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20marked\x20as\x20paid\x20at:\x20','default','/status/','../config/database','.\x20Remaining\x20active\x20timers:\x20','4180tHVBpv','\x20for\x20payment\x20','checkSinglePaymentById','\x20individual\x20payment\x20timers','getServiceStats','üè¶\x20[CHECK]\x20Bank\x20details\x20provided:\x20','‚úÖ\x20[EXPIRY]\x20Payment\x20','payment','logWhiteDomainError','\x20status\x20unchanged\x20(','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','coinToPayService',',\x20using\x20default\x2010%','\x20\x20\x20‚ùå\x20Error:\x20','Payment\x20not\x20found','gatewaySettings','cointopay','\x20\x20\x20Amount:\x20','delete','timers','8ZbCOXL','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','update','\x20initial\x20timers\x20for\x20payment\x20','PENDING','\x20\x20\x20Amount\x20after\x20commission:\x20','getGatewayCommission','logCoinToPayError','error','./gateways/coinToPayService','\x20days,\x20marking\x20as\x20EXPIRED','from','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','./currencyService','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','digest','PAID','remitterIban','description','paymentDetails','\x20commission:\x20','\x20\x20\x20üìÖ\x20Time:\x20','\x20status\x20changed\x20to\x20','\x20is\x20older\x20than\x20','\x20days\x20(created\x20before\x20','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','setDate','cointopay_auto_expired','EXPIRY_DAYS','Webhook\x20event\x20',',\x20gateway\x20','unknown','logCoinToPayStatus','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','COINTOPAY_ERROR','coinToPayStatusService','ms)','COMPLETED','\x20\x20\x20üìä\x20Status:\x20','values','\x20updated:\x20currentPayments=','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20\x20\x20üìù\x20Details:','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','map','paymentId','üìä\x20[CHECK]\x20Payment\x20','settings','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','shop','\x20USDT','iban','‚è∞\x20[HOURLY]\x20Payment\x20','Gateway\x20','\x20triggered\x20for\x20payment\x20','schedulePaymentChecks','currencyService','5\x20minutes','currency','\x20status:\x20','getDate','‚è∞\x20[EXPIRY]\x20Payment\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20current\x20status:\x20','‚úÖ\x20[HOURLY]\x20Payment\x20','expired','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','Shop\x20webhook\x20sent\x20to\x20','webhook_send','payment.failed','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','CoinToPayStatusService','cointopay2','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','sendShopWebhook','Payment\x20older\x20than\x20','3066224gYElbp','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','created','get','paymentLink','\x20days','amount','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','set','üõë\x20[SHUTDOWN]\x20Cleared\x20','Failed\x20to\x20send\x20shop\x20webhook:','webhookEvents','customerName','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','\x20pending\x20CoinToPay\x20payments','checkSinglePayment','\x20status\x20is\x20','amountAfterGatewayCommissionUSDT','paidAt','now','createHmac','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','\x20expired\x20CoinToPay\x20payments','checkExpiredPayments','crypto','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','32TKUPId','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','transactionId','\x20timers\x20for\x20payment\x20','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','log','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check',',\x20status=','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','paid','1\x20minute','\x20\x20\x20-\x20paymentId:\x20','POST','status_check','secretKey','auto_expire','toISOString','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','171595mclInd','amountUSDT','\x20skipped,\x20','\x20\x20\x20-\x20ShopId:\x20'];a57_0x2ffb=function(){return _0x8a3a7c;};return a57_0x2ffb();}const a57_0x2712b5=a57_0x5e33;(function(_0x8c9fd2,_0x3d71d4){const _0x2ea453=a57_0x5e33,_0x2322b5=_0x8c9fd2();while(!![]){try{const _0x4628e0=-parseInt(_0x2ea453(0x1ae))/0x1*(-parseInt(_0x2ea453(0x12f))/0x2)+-parseInt(_0x2ea453(0x1c7))/0x3+parseInt(_0x2ea453(0x192))/0x4+parseInt(_0x2ea453(0x1c0))/0x5*(-parseInt(_0x2ea453(0x1f7))/0x6)+parseInt(_0x2ea453(0x124))/0x7*(parseInt(_0x2ea453(0x143))/0x8)+parseInt(_0x2ea453(0x238))/0x9+-parseInt(_0x2ea453(0x1fe))/0xa;if(_0x4628e0===_0x3d71d4)break;else _0x2322b5['push'](_0x2322b5['shift']());}catch(_0x555b53){_0x2322b5['push'](_0x2322b5['shift']());}}}(a57_0x2ffb,0x5da63));function a57_0x5e33(_0x2653b1,_0x4eeca3){_0x2653b1=_0x2653b1-0x120;const _0x2ffbc4=a57_0x2ffb();let _0x5e3341=_0x2ffbc4[_0x2653b1];return _0x5e3341;}var __importDefault=this&&this[a57_0x2712b5(0x206)]||function(_0x515056){const _0x534cec=a57_0x2712b5;return _0x515056&&_0x515056[_0x534cec(0x1ef)]?_0x515056:{'default':_0x515056};};Object['defineProperty'](exports,a57_0x2712b5(0x1ef),{'value':!![]}),exports[a57_0x2712b5(0x166)]=exports[a57_0x2712b5(0x18d)]=void 0x0;const crypto_1=__importDefault(require(a57_0x2712b5(0x1ac))),coinToPayService_1=require(a57_0x2712b5(0x14c)),coinToPay2Service_1=require('./gateways/coinToPay2Service'),gateway_1=require(a57_0x2712b5(0x1d9)),database_1=__importDefault(require(a57_0x2712b5(0x12d))),telegramBotService_1=require(a57_0x2712b5(0x1f0)),loggerService_1=require(a57_0x2712b5(0x1f8)),currencyService_1=require(a57_0x2712b5(0x150));class CoinToPayStatusService{constructor(){const _0x15cf0a=a57_0x2712b5;this[_0x15cf0a(0x1ee)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x15cf0a(0x15f)]=0x5,this[_0x15cf0a(0x1ec)]=new Map(),this[_0x15cf0a(0x13a)]=new coinToPayService_1[(_0x15cf0a(0x213))](),this[_0x15cf0a(0x233)]=new coinToPay2Service_1['CoinToPay2Service'](),console['log'](_0x15cf0a(0x1bf));}[a57_0x2712b5(0x17c)](_0x524188,_0x867619){const _0xaf5841=a57_0x2712b5;console['log'](_0xaf5841(0x1fc)),console[_0xaf5841(0x1b3)](_0xaf5841(0x1b9)+_0x524188),console[_0xaf5841(0x1b3)](_0xaf5841(0x20a)+_0x867619),this[_0xaf5841(0x122)](_0x524188);const _0x5591a2=[],_0x1d1d13=new Date(),_0x2b45ab=[{'delay':0x1*0x3c*0x3e8,'description':_0xaf5841(0x1b8)},{'delay':0x2*0x3c*0x3e8,'description':_0xaf5841(0x23a)},{'delay':0x5*0x3c*0x3e8,'description':_0xaf5841(0x17e)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console['log']('ü™ô\x20[DEBUG]\x20Creating\x20'+_0x2b45ab['length']+_0xaf5841(0x146)+_0x524188);let _0x2583e7=0x0;_0x2b45ab[_0xaf5841(0x1eb)]((_0x29cff3,_0x38928d)=>{const _0x182ec1=_0xaf5841;_0x2583e7+=_0x29cff3['delay'];const _0x10fd81=setTimeout(async()=>{const _0xd575ea=a57_0x5e33;console[_0xd575ea(0x1b3)]('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x38928d+0x1)+_0xd575ea(0x17b)+_0x524188+_0xd575ea(0x1fd)+_0x29cff3[_0xd575ea(0x155)]+')');try{await this['checkSinglePaymentById'](_0x524188),console[_0xd575ea(0x1b3)](_0xd575ea(0x187)+(_0x38928d+0x1)+'\x20completed\x20for\x20payment\x20'+_0x524188);}catch(_0x224566){console[_0xd575ea(0x14b)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x38928d+0x1)+'\x20for\x20payment\x20'+_0x524188+':',_0x224566),this['logCoinToPayError'](_0x524188,_0x867619,_0x224566,_0xd575ea(0x1bb),{'checkNumber':_0x38928d+0x1,'scheduledAfter':_0x29cff3[_0xd575ea(0x155)],'isIndividualCheck':!![]});}},_0x2583e7);_0x5591a2[_0x182ec1(0x226)](_0x10fd81),console['log'](_0x182ec1(0x18f)+(_0x38928d+0x1)+_0x182ec1(0x130)+_0x524188+'\x20in\x20'+_0x2583e7/0x3e8+'\x20seconds\x20('+_0x29cff3[_0x182ec1(0x155)]+')');});const _0x5d804d=setInterval(async()=>{const _0x29031a=_0xaf5841;console['log'](_0x29031a(0x194)+_0x524188);try{const _0x389811=await database_1['default'][_0x29031a(0x136)][_0x29031a(0x220)]({'where':{'id':_0x524188},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x389811){console[_0x29031a(0x1b3)]('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x524188+_0x29031a(0x1dd)),this[_0x29031a(0x122)](_0x524188);return;}console[_0x29031a(0x1b3)](_0x29031a(0x1d3)+_0x524188+_0x29031a(0x184)+_0x389811[_0x29031a(0x1ea)]);if(_0x389811['status']!==_0x29031a(0x147)){console['log'](_0x29031a(0x185)+_0x524188+'\x20status\x20is\x20'+_0x389811[_0x29031a(0x1ea)]+_0x29031a(0x200)),this[_0x29031a(0x122)](_0x524188);return;}const _0x423db4=Math['floor']((Date['now']()-_0x389811[_0x29031a(0x1e3)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x423db4>=this[_0x29031a(0x15f)]){console[_0x29031a(0x1b3)](_0x29031a(0x179)+_0x524188+_0x29031a(0x15a)+this['EXPIRY_DAYS']+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x29031a(0x122)](_0x524188);return;}await this[_0x29031a(0x131)](_0x524188),console[_0x29031a(0x1b3)](_0x29031a(0x1d2)+_0x524188);}catch(_0x936b6c){console[_0x29031a(0x14b)](_0x29031a(0x175)+_0x524188+':',_0x936b6c),this[_0x29031a(0x14a)](_0x524188,_0x867619,_0x936b6c,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x5591a2[_0xaf5841(0x226)](_0x5d804d),this[_0xaf5841(0x1ec)][_0xaf5841(0x19c)](_0x524188,{'timers':_0x5591a2,'paymentId':_0x524188,'gatewayPaymentId':_0x867619,'createdAt':_0x1d1d13}),console['log'](_0xaf5841(0x1ce)+_0x2b45ab['length']+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x524188),console['log'](_0xaf5841(0x188)+this[_0xaf5841(0x1ec)][_0xaf5841(0x236)]),this[_0xaf5841(0x163)](_0x524188,_0x867619,_0xaf5841(0x147),'PENDING',_0xaf5841(0x1bb),{'action':_0xaf5841(0x120),'scheduledChecks':_0x2b45ab[_0xaf5841(0x1e4)],'firstCheckIn':_0x2b45ab[0x0][_0xaf5841(0x1d5)]/0x3e8,'totalTimers':this['paymentTimers'][_0xaf5841(0x236)]});}['clearPaymentTimers'](_0x21fd8f){const _0x45f401=a57_0x2712b5,_0x57a85c=this['paymentTimers'][_0x45f401(0x197)](_0x21fd8f);_0x57a85c?(console[_0x45f401(0x1b3)](_0x45f401(0x1cc)+_0x57a85c[_0x45f401(0x142)][_0x45f401(0x1e4)]+_0x45f401(0x1b1)+_0x21fd8f),_0x57a85c[_0x45f401(0x142)][_0x45f401(0x1eb)]((_0x49fad0,_0x5c8d60)=>{const _0x326104=_0x45f401;_0x49fad0&&(clearTimeout(_0x49fad0),clearInterval(_0x49fad0),console[_0x326104(0x1b3)]('üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x5c8d60+0x1)+'\x20for\x20payment\x20'+_0x21fd8f));}),this['paymentTimers'][_0x45f401(0x141)](_0x21fd8f),console[_0x45f401(0x1b3)](_0x45f401(0x129)+_0x21fd8f+_0x45f401(0x12e)+this[_0x45f401(0x1ec)][_0x45f401(0x236)])):console[_0x45f401(0x1b3)](_0x45f401(0x215)+_0x21fd8f+_0x45f401(0x210));}async[a57_0x2712b5(0x131)](_0x313f77){const _0x485b32=a57_0x2712b5;console[_0x485b32(0x1b3)](_0x485b32(0x1d4)+_0x313f77);const _0x41bad3=await database_1['default']['payment'][_0x485b32(0x220)]({'where':{'id':_0x313f77},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x41bad3){console['log']('‚ùå\x20[CHECK]\x20Payment\x20'+_0x313f77+_0x485b32(0x229));return;}console['log']('üìä\x20[CHECK]\x20Payment\x20'+_0x313f77+_0x485b32(0x22a)),console[_0x485b32(0x1b3)](_0x485b32(0x1e9)+_0x41bad3[_0x485b32(0x222)]),console[_0x485b32(0x1b3)](_0x485b32(0x225)+_0x41bad3[_0x485b32(0x1ea)]),console[_0x485b32(0x1b3)]('\x20\x20\x20-\x20GatewayPaymentId:\x20'+_0x41bad3[_0x485b32(0x1cb)]),console['log'](_0x485b32(0x216)+_0x41bad3['amount']+'\x20'+_0x41bad3['currency']),console[_0x485b32(0x1b3)](_0x485b32(0x1c3)+_0x41bad3[_0x485b32(0x1e6)]);if(_0x41bad3[_0x485b32(0x222)]!=='cointopay'&&_0x41bad3['gateway']!=='cointopay2'){console[_0x485b32(0x1b3)](_0x485b32(0x18c)+_0x313f77+_0x485b32(0x209)+_0x41bad3[_0x485b32(0x222)]+')');return;}if(_0x41bad3[_0x485b32(0x1ea)]!==_0x485b32(0x147)){console['log'](_0x485b32(0x18c)+_0x313f77+_0x485b32(0x1a4)+_0x41bad3['status']+_0x485b32(0x200)),this[_0x485b32(0x122)](_0x313f77);return;}if(!_0x41bad3[_0x485b32(0x1cb)]){console['log'](_0x485b32(0x18c)+_0x313f77+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x485b32(0x1b3)](_0x485b32(0x217)+_0x313f77+_0x485b32(0x211)),await this[_0x485b32(0x1a3)](_0x41bad3);}[a57_0x2712b5(0x163)](_0x32fe5c,_0x2eb0a3,_0x146123,_0x3f0923,_0x59d893,_0x4da94a){const _0x2eb3f8=a57_0x2712b5,_0x27ffce={'type':_0x2eb3f8(0x21a),'paymentId':_0x32fe5c,'gatewayPaymentId':_0x2eb0a3,'oldStatus':_0x146123,'newStatus':_0x3f0923,'source':_0x59d893,'timestamp':new Date()['toISOString'](),'details':_0x4da94a||{}};loggerService_1[_0x2eb3f8(0x1dc)]['logCoinToPayStatus'](_0x27ffce),console[_0x2eb3f8(0x1b3)](_0x2eb3f8(0x1ad)+_0x32fe5c+'\x20('+_0x2eb0a3+')'),console[_0x2eb3f8(0x1b3)](_0x2eb3f8(0x169)+_0x146123+_0x2eb3f8(0x218)+_0x3f0923),console['log']('\x20\x20\x20üìç\x20Source:\x20'+_0x59d893),console[_0x2eb3f8(0x1b3)](_0x2eb3f8(0x158)+_0x27ffce[_0x2eb3f8(0x1d0)]),_0x4da94a&&console[_0x2eb3f8(0x1b3)](_0x2eb3f8(0x16f),_0x4da94a);}['logCoinToPayError'](_0x33c953,_0x304149,_0x4e24d7,_0x38efc0,_0x54ad1b){const _0x322006=a57_0x2712b5,_0x5df06c={'type':_0x322006(0x165),'paymentId':_0x33c953,'gatewayPaymentId':_0x304149,'error':_0x4e24d7 instanceof Error?{'message':_0x4e24d7[_0x322006(0x223)],'stack':_0x4e24d7['stack']}:_0x4e24d7,'source':_0x38efc0,'timestamp':new Date()[_0x322006(0x1be)](),'context':_0x54ad1b||{}};loggerService_1[_0x322006(0x1dc)][_0x322006(0x14a)](_0x5df06c),console['error'](_0x322006(0x16e)+_0x33c953+'\x20('+_0x304149+')'),console[_0x322006(0x14b)](_0x322006(0x13c)+(_0x4e24d7 instanceof Error?_0x4e24d7[_0x322006(0x223)]:_0x4e24d7)),console[_0x322006(0x14b)](_0x322006(0x1c6)+_0x38efc0),console[_0x322006(0x14b)](_0x322006(0x158)+_0x5df06c[_0x322006(0x1d0)]),_0x54ad1b&&console[_0x322006(0x14b)](_0x322006(0x204),_0x54ad1b);}[a57_0x2712b5(0x1cd)](){const _0x39df60=a57_0x2712b5;console['log'](_0x39df60(0x1d1)),this[_0x39df60(0x1df)]()[_0x39df60(0x1de)](_0x421630=>{const _0x2571a2=_0x39df60;console['error'](_0x2571a2(0x1b6),_0x421630);}),this[_0x39df60(0x1ee)]=setInterval(async()=>{const _0x45205a=_0x39df60;try{console[_0x45205a(0x1b3)](_0x45205a(0x1b2)),await this[_0x45205a(0x1df)](),console[_0x45205a(0x1b3)](_0x45205a(0x239));}catch(_0x3b5d4a){console[_0x45205a(0x14b)](_0x45205a(0x1f5),_0x3b5d4a);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x39df60(0x1b3)](_0x39df60(0x212));}['stopPeriodicStatusCheck'](){const _0xc93ae=a57_0x2712b5;console[_0xc93ae(0x1b3)](_0xc93ae(0x22d));this['globalCheckInterval']&&(clearInterval(this[_0xc93ae(0x1ee)]),this[_0xc93ae(0x1ee)]=null,console[_0xc93ae(0x1b3)](_0xc93ae(0x1d6)));const _0x1f6d75=this[_0xc93ae(0x1ec)][_0xc93ae(0x236)];for(const [_0x5da88f]of this[_0xc93ae(0x1ec)]){this[_0xc93ae(0x122)](_0x5da88f);}console[_0xc93ae(0x1b3)](_0xc93ae(0x19d)+_0x1f6d75+_0xc93ae(0x132));}async['checkAllPendingPayments'](){const _0x8e15b9=a57_0x2712b5;try{console[_0x8e15b9(0x1b3)](_0x8e15b9(0x170));const _0x20a808=await database_1[_0x8e15b9(0x12b)][_0x8e15b9(0x136)][_0x8e15b9(0x231)]({'where':{'gateway':{'in':[_0x8e15b9(0x13f),'cointopay2']},'status':_0x8e15b9(0x147),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log']('ü™ô\x20[GLOBAL]\x20Found\x20'+_0x20a808['length']+_0x8e15b9(0x1a2));if(_0x20a808[_0x8e15b9(0x1e4)]===0x0){console[_0x8e15b9(0x1b3)](_0x8e15b9(0x1b4));return;}const _0x5f05cd=await this[_0x8e15b9(0x1ab)](_0x20a808);console['log'](_0x8e15b9(0x1db)+_0x5f05cd[_0x8e15b9(0x1e4)]+_0x8e15b9(0x1aa));let _0x1d8dcf=0x0,_0x2a63ba=0x0;for(const _0x158951 of _0x20a808){try{if(_0x5f05cd[_0x8e15b9(0x121)](_0x158951['id'])){console[_0x8e15b9(0x1b3)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x158951['id']+_0x8e15b9(0x164)),_0x2a63ba++;continue;}if(this[_0x8e15b9(0x1ec)]['has'](_0x158951['id'])){console['log'](_0x8e15b9(0x224)+_0x158951['id']+_0x8e15b9(0x1af)),_0x2a63ba++;continue;}const _0x4b0620=(Date[_0x8e15b9(0x1a7)]()-_0x158951['createdAt']['getTime']())/(0x3e8*0x3c*0x3c);if(_0x4b0620<0x1){console['log'](_0x8e15b9(0x224)+_0x158951['id']+_0x8e15b9(0x1e0)+_0x4b0620[_0x8e15b9(0x22e)](0x1)+'h),\x20skipping\x20global\x20check'),_0x2a63ba++;continue;}console['log']('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x158951['id']+'\x20(age:\x20'+_0x4b0620['toFixed'](0x1)+'h)'),await this['checkSinglePayment'](_0x158951),_0x1d8dcf++,await new Promise(_0x512522=>setTimeout(_0x512522,0x7d0));}catch(_0x4eb17f){console[_0x8e15b9(0x14b)](_0x8e15b9(0x1ed)+_0x158951['id']+':',_0x4eb17f),this[_0x8e15b9(0x14a)](_0x158951['id'],_0x158951['gatewayPaymentId']||_0x8e15b9(0x162),_0x4eb17f,_0x8e15b9(0x1bb),{'isGlobalCheck':!![],'paymentAmount':_0x158951[_0x8e15b9(0x19a)],'paymentCurrency':_0x158951[_0x8e15b9(0x17f)],'shopId':_0x158951[_0x8e15b9(0x1e6)],'createdAt':_0x158951[_0x8e15b9(0x1e3)]}),loggerService_1['loggerService'][_0x8e15b9(0x137)](_0x8e15b9(0x13f),_0x8e15b9(0x12c)+_0x158951['gatewayPaymentId'],_0x4eb17f);}}console[_0x8e15b9(0x1b3)](_0x8e15b9(0x128)+_0x1d8dcf+_0x8e15b9(0x22c)+_0x2a63ba+_0x8e15b9(0x1c2)+_0x5f05cd[_0x8e15b9(0x1e4)]+'\x20expired');}catch(_0x5273b7){console[_0x8e15b9(0x14b)](_0x8e15b9(0x144),_0x5273b7);}}async['checkExpiredPayments'](_0x1f136d){const _0x4b56b8=a57_0x2712b5,_0x35a550=[],_0x315dc9=new Date();_0x315dc9[_0x4b56b8(0x15d)](_0x315dc9[_0x4b56b8(0x181)]()-this['EXPIRY_DAYS']),console[_0x4b56b8(0x1b3)](_0x4b56b8(0x151)+this['EXPIRY_DAYS']+_0x4b56b8(0x15b)+_0x315dc9[_0x4b56b8(0x1be)]()+')');for(const _0x48a041 of _0x1f136d){if(_0x48a041[_0x4b56b8(0x1e3)]<_0x315dc9){console[_0x4b56b8(0x1b3)](_0x4b56b8(0x182)+_0x48a041['id']+_0x4b56b8(0x15a)+this[_0x4b56b8(0x15f)]+_0x4b56b8(0x14d));try{this[_0x4b56b8(0x163)](_0x48a041['id'],_0x48a041['gatewayPaymentId']||'unknown',_0x4b56b8(0x147),_0x4b56b8(0x232),_0x4b56b8(0x1bd),{'reason':_0x4b56b8(0x191)+this[_0x4b56b8(0x15f)]+_0x4b56b8(0x199),'createdAt':_0x48a041[_0x4b56b8(0x1e3)],'daysSinceCreation':Math[_0x4b56b8(0x202)]((Date[_0x4b56b8(0x1a7)]()-_0x48a041['createdAt'][_0x4b56b8(0x208)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x48a041[_0x4b56b8(0x19a)],'paymentCurrency':_0x48a041[_0x4b56b8(0x17f)],'shopId':_0x48a041[_0x4b56b8(0x1e6)]}),await database_1[_0x4b56b8(0x12b)][_0x4b56b8(0x136)][_0x4b56b8(0x145)]({'where':{'id':_0x48a041['id']},'data':{'status':_0x4b56b8(0x232),'updatedAt':new Date()}}),await database_1[_0x4b56b8(0x12b)][_0x4b56b8(0x125)]['create']({'data':{'paymentId':_0x48a041['id'],'shopId':_0x48a041[_0x4b56b8(0x1e6)],'event':_0x4b56b8(0x15e),'statusCode':0xc8,'responseBody':JSON[_0x4b56b8(0x1f3)]({'reason':'Payment\x20older\x20than\x20'+this[_0x4b56b8(0x15f)]+_0x4b56b8(0x199),'createdAt':_0x48a041[_0x4b56b8(0x1e3)],'expiredAt':new Date()[_0x4b56b8(0x1be)](),'daysSinceCreation':Math['floor']((Date[_0x4b56b8(0x1a7)]()-_0x48a041[_0x4b56b8(0x1e3)][_0x4b56b8(0x208)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4b56b8(0x190)](_0x48a041,_0x4b56b8(0x232)),await this[_0x4b56b8(0x235)](_0x48a041,_0x4b56b8(0x232)),this[_0x4b56b8(0x122)](_0x48a041['id']),_0x35a550[_0x4b56b8(0x226)](_0x48a041['id']),console[_0x4b56b8(0x1b3)](_0x4b56b8(0x135)+_0x48a041['id']+_0x4b56b8(0x183)+this['EXPIRY_DAYS']+_0x4b56b8(0x1e7));}catch(_0x6ed00d){console['error']('‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x48a041['id']+':',_0x6ed00d),this[_0x4b56b8(0x14a)](_0x48a041['id'],_0x48a041['gatewayPaymentId']||_0x4b56b8(0x162),_0x6ed00d,_0x4b56b8(0x1bd),{'reason':_0x4b56b8(0x16d),'createdAt':_0x48a041[_0x4b56b8(0x1e3)],'daysSinceCreation':Math[_0x4b56b8(0x202)]((Date[_0x4b56b8(0x1a7)]()-_0x48a041[_0x4b56b8(0x1e3)][_0x4b56b8(0x208)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x35a550;}async[a57_0x2712b5(0x1a3)](_0x1a5e68){const _0x411e36=a57_0x2712b5;if(!_0x1a5e68[_0x411e36(0x1cb)]){console[_0x411e36(0x1b3)](_0x411e36(0x18c)+_0x1a5e68['id']+_0x411e36(0x195));return;}console[_0x411e36(0x1b3)]('üîç\x20[CHECK]\x20Checking\x20'+_0x1a5e68[_0x411e36(0x222)]+_0x411e36(0x21d)+_0x1a5e68['id']+'\x20('+_0x1a5e68['gatewayPaymentId']+')');try{let _0x136049;_0x1a5e68[_0x411e36(0x222)]===_0x411e36(0x18e)?(_0x136049=await this[_0x411e36(0x233)][_0x411e36(0x1fa)](_0x1a5e68['gatewayPaymentId']),console[_0x411e36(0x1b3)](_0x411e36(0x19b)+_0x1a5e68['id']+'\x20status:\x20'+_0x136049['status'])):(_0x136049=await this['coinToPayService'][_0x411e36(0x1fa)](_0x1a5e68[_0x411e36(0x1cb)]),console['log'](_0x411e36(0x1f2)+_0x1a5e68['id']+_0x411e36(0x180)+_0x136049[_0x411e36(0x1ea)]));_0x136049[_0x411e36(0x156)]&&console[_0x411e36(0x1b3)](_0x411e36(0x173)+_0x1a5e68['id']+_0x411e36(0x123),{'iban':_0x136049['paymentDetails'][_0x411e36(0x178)]||'not\x20found','transactionId':_0x136049[_0x411e36(0x156)][_0x411e36(0x1b0)],'createdOn':_0x136049[_0x411e36(0x156)][_0x411e36(0x203)],'confirmedOn':_0x136049[_0x411e36(0x156)][_0x411e36(0x219)]||'not\x20confirmed'});if(_0x136049[_0x411e36(0x1ea)]!==_0x1a5e68['status']){console[_0x411e36(0x1b3)](_0x411e36(0x1a9)+_0x1a5e68['id']+'\x20status\x20from\x20'+_0x1a5e68[_0x411e36(0x1ea)]+_0x411e36(0x201)+_0x136049['status']),this[_0x411e36(0x163)](_0x1a5e68['id'],_0x1a5e68[_0x411e36(0x1cb)],_0x1a5e68[_0x411e36(0x1ea)],_0x136049[_0x411e36(0x1ea)],_0x411e36(0x1bb),{'paymentDetails':_0x136049[_0x411e36(0x156)],'amount':_0x136049[_0x411e36(0x19a)],'currency':_0x136049['currency'],'shopId':_0x1a5e68['shopId'],'checkTimestamp':new Date()['toISOString']()});const _0x40d1b8={'status':_0x136049[_0x411e36(0x1ea)],'updatedAt':new Date()};if(_0x136049[_0x411e36(0x1ea)]===_0x411e36(0x153)&&_0x1a5e68[_0x411e36(0x1ea)]!==_0x411e36(0x153)){_0x40d1b8['paidAt']=new Date();if(!_0x1a5e68[_0x411e36(0x1c1)]){const _0x4e15b1=await currencyService_1[_0x411e36(0x17d)]['convertToUSDT'](_0x1a5e68[_0x411e36(0x19a)],_0x1a5e68[_0x411e36(0x17f)]);_0x40d1b8[_0x411e36(0x1c1)]=_0x4e15b1;const _0x59f2d5=await this[_0x411e36(0x149)](_0x1a5e68[_0x411e36(0x1e6)],_0x1a5e68[_0x411e36(0x222)]),_0x3441db=_0x4e15b1*(0x1-_0x59f2d5/0x64);_0x40d1b8[_0x411e36(0x1a5)]=_0x3441db,_0x40d1b8[_0x411e36(0x1d8)]=_0x59f2d5,console[_0x411e36(0x1b3)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x1a5e68['id']+_0x411e36(0x22f)),console[_0x411e36(0x1b3)](_0x411e36(0x140)+_0x1a5e68[_0x411e36(0x19a)]+'\x20'+_0x1a5e68[_0x411e36(0x17f)]+'\x20->\x20'+_0x4e15b1['toFixed'](0x6)+_0x411e36(0x177)),console[_0x411e36(0x1b3)]('\x20\x20\x20Gateway\x20'+_0x1a5e68[_0x411e36(0x222)]+_0x411e36(0x157)+_0x59f2d5+'%'),console[_0x411e36(0x1b3)](_0x411e36(0x148)+_0x3441db['toFixed'](0x6)+_0x411e36(0x177));}console[_0x411e36(0x1b3)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x1a5e68['id']+_0x411e36(0x12a)+_0x40d1b8[_0x411e36(0x1a6)][_0x411e36(0x1be)]());}if(_0x136049['paymentDetails']){const _0x1dd00b=_0x136049['paymentDetails'];_0x1dd00b[_0x411e36(0x178)]&&(_0x40d1b8[_0x411e36(0x154)]=_0x1dd00b['iban'],console[_0x411e36(0x1b3)](_0x411e36(0x16c)+_0x1dd00b[_0x411e36(0x178)])),_0x1dd00b['bankDetails']&&console[_0x411e36(0x1b3)](_0x411e36(0x134)+_0x1dd00b[_0x411e36(0x21e)]),_0x1dd00b['transactionId']&&console['log'](_0x411e36(0x1c8)+_0x1dd00b[_0x411e36(0x1b0)]),_0x1dd00b[_0x411e36(0x219)]&&console[_0x411e36(0x1b3)](_0x411e36(0x1e1)+_0x1dd00b['confirmedOn']);}await database_1[_0x411e36(0x12b)][_0x411e36(0x136)][_0x411e36(0x145)]({'where':{'id':_0x1a5e68['id']},'data':_0x40d1b8});if(_0x136049[_0x411e36(0x1ea)]===_0x411e36(0x153)&&_0x1a5e68[_0x411e36(0x1ea)]!==_0x411e36(0x153)){console[_0x411e36(0x1b3)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x1a5e68['id']+'\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link');const _0x20a6d1=await database_1[_0x411e36(0x12b)][_0x411e36(0x136)]['findUnique']({'where':{'id':_0x1a5e68['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x20a6d1?.[_0x411e36(0x1f9)]&&_0x20a6d1[_0x411e36(0x198)])try{const _0x22cc7a=_0x20a6d1[_0x411e36(0x198)];console[_0x411e36(0x1b3)](_0x411e36(0x127)+_0x22cc7a['id']+':\x20type='+_0x22cc7a[_0x411e36(0x21b)]+_0x411e36(0x1c4)+_0x22cc7a[_0x411e36(0x1e8)]+_0x411e36(0x1b5)+_0x22cc7a[_0x411e36(0x1ea)]);const _0x2c2ec4=_0x22cc7a[_0x411e36(0x1e8)]+0x1,_0x3a54ab=_0x22cc7a[_0x411e36(0x21b)]==='SINGLE'?_0x411e36(0x168):_0x22cc7a['status'];await database_1[_0x411e36(0x12b)][_0x411e36(0x198)]['update']({'where':{'id':_0x22cc7a['id']},'data':{'currentPayments':_0x2c2ec4,'status':_0x3a54ab,'updatedAt':new Date()}}),console[_0x411e36(0x1b3)]('‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20'+_0x22cc7a['id']+_0x411e36(0x16b)+_0x22cc7a[_0x411e36(0x1e8)]+_0x411e36(0x218)+_0x2c2ec4+',\x20status='+_0x22cc7a[_0x411e36(0x1ea)]+_0x411e36(0x218)+_0x3a54ab);}catch(_0x1656e9){console[_0x411e36(0x14b)](_0x411e36(0x14f),_0x1656e9);}else console[_0x411e36(0x1b3)](_0x411e36(0x1e5)+_0x1a5e68['id']+_0x411e36(0x20d));}await database_1[_0x411e36(0x12b)]['webhookLog'][_0x411e36(0x20c)]({'data':{'paymentId':_0x1a5e68['id'],'shopId':_0x1a5e68[_0x411e36(0x1e6)],'event':_0x411e36(0x1f6)+_0x136049[_0x411e36(0x1ea)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x411e36(0x1f3)]({'oldStatus':_0x1a5e68[_0x411e36(0x1ea)],'newStatus':_0x136049[_0x411e36(0x1ea)],'paymentDetails':_0x136049[_0x411e36(0x156)],'checkedAt':new Date()[_0x411e36(0x1be)]()})}}),await this['sendShopWebhook'](_0x1a5e68,_0x136049[_0x411e36(0x1ea)]),await this[_0x411e36(0x235)](_0x1a5e68,_0x136049[_0x411e36(0x1ea)]),_0x136049[_0x411e36(0x1ea)]!=='PENDING'&&(console[_0x411e36(0x1b3)]('üßπ\x20[CHECK]\x20Payment\x20'+_0x1a5e68['id']+_0x411e36(0x159)+_0x136049['status']+',\x20clearing\x20individual\x20timers'),this[_0x411e36(0x122)](_0x1a5e68['id'])),console[_0x411e36(0x1b3)](_0x411e36(0x217)+_0x1a5e68['id']+_0x411e36(0x230));}else console[_0x411e36(0x1b3)](_0x411e36(0x173)+_0x1a5e68['id']+_0x411e36(0x138)+_0x136049['status']+')'),this[_0x411e36(0x163)](_0x1a5e68['id'],_0x1a5e68['gatewayPaymentId'],_0x1a5e68['status'],_0x136049[_0x411e36(0x1ea)],_0x411e36(0x1bb),{'statusUnchanged':!![],'paymentDetails':_0x136049['paymentDetails'],'amount':_0x136049[_0x411e36(0x19a)],'currency':_0x136049['currency'],'shopId':_0x1a5e68[_0x411e36(0x1e6)],'checkTimestamp':new Date()['toISOString']()});}catch(_0xee36e9){console['error'](_0x411e36(0x1a1)+_0x1a5e68['id']+':',_0xee36e9),this[_0x411e36(0x14a)](_0x1a5e68['id'],_0x1a5e68['gatewayPaymentId'],_0xee36e9,'status_check',{'paymentAmount':_0x1a5e68[_0x411e36(0x19a)],'paymentCurrency':_0x1a5e68[_0x411e36(0x17f)],'shopId':_0x1a5e68[_0x411e36(0x1e6)],'createdAt':_0x1a5e68[_0x411e36(0x1e3)]}),await database_1[_0x411e36(0x12b)][_0x411e36(0x125)][_0x411e36(0x20c)]({'data':{'paymentId':_0x1a5e68['id'],'shopId':_0x1a5e68[_0x411e36(0x1e6)],'event':_0x411e36(0x1f1),'statusCode':0x1f4,'responseBody':JSON[_0x411e36(0x1f3)]({'error':_0xee36e9 instanceof Error?_0xee36e9[_0x411e36(0x223)]:_0x411e36(0x234),'gatewayPaymentId':_0x1a5e68[_0x411e36(0x1cb)],'checkedAt':new Date()[_0x411e36(0x1be)]()})}});}}async[a57_0x2712b5(0x190)](_0x3336d5,_0x1911b8){const _0x119b09=a57_0x2712b5,_0x9ff374=Date['now']();try{const _0x1b974d=_0x3336d5[_0x119b09(0x176)],_0x141c15=_0x1b974d[_0x119b09(0x174)];if(!_0x141c15?.[_0x119b09(0x228)]){console[_0x119b09(0x1b3)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1b974d['id']);return;}const _0x2cd22e=_0x1911b8===_0x119b09(0x153)?'payment.success':_0x1911b8==='FAILED'?_0x119b09(0x18b):_0x1911b8==='EXPIRED'?_0x119b09(0x18b):_0x119b09(0x20b);if(!_0x141c15[_0x119b09(0x19f)]?.[_0x119b09(0x121)](_0x2cd22e)){console[_0x119b09(0x1b3)](_0x119b09(0x160)+_0x2cd22e+_0x119b09(0x1ff)+_0x1b974d['id']);return;}const _0x45948e=(0x0,gateway_1['getGatewayIdByName'])(_0x3336d5[_0x119b09(0x222)])||_0x3336d5['gateway'],_0x29ad03={'event':_0x2cd22e,'payment':{'id':_0x3336d5['id'],'order_id':_0x3336d5['orderId'],'gateway_order_id':_0x3336d5[_0x119b09(0x1c5)],'gateway':_0x45948e,'amount':_0x3336d5[_0x119b09(0x19a)],'currency':_0x3336d5[_0x119b09(0x17f)],'status':_0x1911b8[_0x119b09(0x126)](),'customer_email':_0x3336d5[_0x119b09(0x1f4)],'customer_name':_0x3336d5[_0x119b09(0x1a0)],'created_at':_0x3336d5['createdAt'],'updated_at':new Date()}},_0x5947e2=JSON[_0x119b09(0x1f3)](_0x29ad03),_0x482a31=crypto_1['default'][_0x119b09(0x1a8)](_0x119b09(0x214),_0x3336d5[_0x119b09(0x176)][_0x119b09(0x1bc)])[_0x119b09(0x145)](_0x5947e2)[_0x119b09(0x152)](_0x119b09(0x20f)),_0x5db584=await fetch(_0x141c15['webhookUrl'],{'method':_0x119b09(0x1ba),'headers':{'Content-Type':'application/json','User-Agent':'Payment\x20System/1.0','X-Webhook-Signature':_0x482a31},'body':_0x5947e2}),_0x44578f=Date[_0x119b09(0x1a7)]()-_0x9ff374,_0x3ead18=_0x5db584['ok']?_0x119b09(0x1e2):await _0x5db584[_0x119b09(0x1cf)]();loggerService_1[_0x119b09(0x1dc)][_0x119b09(0x1ca)](_0x3336d5[_0x119b09(0x1e6)],_0x141c15[_0x119b09(0x228)],_0x2cd22e,_0x5db584['status'],_0x44578f,_0x29ad03),console[_0x119b09(0x1b3)](_0x119b09(0x189)+_0x141c15[_0x119b09(0x228)]+'\x20with\x20status\x20'+_0x5db584[_0x119b09(0x1ea)]+'\x20('+_0x44578f+_0x119b09(0x167));}catch(_0x1cf794){console[_0x119b09(0x14b)](_0x119b09(0x19e),_0x1cf794),loggerService_1[_0x119b09(0x1dc)][_0x119b09(0x21c)](_0x3336d5[_0x119b09(0x1e6)],_0x3336d5[_0x119b09(0x176)]?.['settings']?.[_0x119b09(0x228)]||_0x119b09(0x162),_0x119b09(0x18a),_0x1cf794,{});}}async['sendPaymentStatusNotification'](_0x503c5e,_0x415cd8){const _0x5594b0=a57_0x2712b5;try{const _0x585d67={'PENDING':_0x5594b0(0x196),'PAID':_0x5594b0(0x1b7),'FAILED':_0x5594b0(0x227),'EXPIRED':_0x5594b0(0x186)},_0x4efcee=_0x585d67[_0x415cd8];if(!_0x4efcee||_0x4efcee===_0x5594b0(0x196))return;await telegramBotService_1[_0x5594b0(0x20e)]['sendPaymentNotification'](_0x503c5e['shopId'],_0x503c5e,_0x4efcee);}catch(_0x19f4e8){console[_0x5594b0(0x14b)](_0x5594b0(0x237),_0x19f4e8);}}async[a57_0x2712b5(0x221)](_0x2174ac){const _0x184560=a57_0x2712b5;console[_0x184560(0x1b3)](_0x184560(0x193)+_0x2174ac);const _0x351850=await database_1['default'][_0x184560(0x136)]['findUnique']({'where':{'id':_0x2174ac},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x351850)throw new Error(_0x184560(0x13d));if(_0x351850[_0x184560(0x222)]!=='cointopay'&&_0x351850['gateway']!==_0x184560(0x18e))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x184560(0x1b3)](_0x184560(0x15c)+_0x351850[_0x184560(0x222)]+_0x184560(0x21d)+_0x2174ac),await this[_0x184560(0x1a3)](_0x351850),console[_0x184560(0x1b3)]('‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x2174ac);}[a57_0x2712b5(0x133)](){const _0x1dfc43=a57_0x2712b5,_0x23c17=this['globalCheckInterval']?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x4c7c15=Array[_0x1dfc43(0x14e)](this[_0x1dfc43(0x1ec)][_0x1dfc43(0x16a)]())[_0x1dfc43(0x171)](_0x4cc947=>({'paymentId':_0x4cc947[_0x1dfc43(0x172)],'gatewayPaymentId':_0x4cc947[_0x1dfc43(0x1cb)],'createdAt':_0x4cc947[_0x1dfc43(0x1e3)],'timersCount':_0x4cc947[_0x1dfc43(0x142)][_0x1dfc43(0x1e4)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x1dfc43(0x1da)]/(0x3e8*0x3c),'expiryDays':this[_0x1dfc43(0x15f)],'activeIndividualTimers':this['paymentTimers'][_0x1dfc43(0x236)],'nextGlobalCheckIn':_0x23c17,'paymentTimersDetails':_0x4c7c15};}[a57_0x2712b5(0x1fb)](_0x11d6e4){const _0x979cfb=a57_0x2712b5,_0x1da7ab=this['paymentTimers'][_0x979cfb(0x197)](_0x11d6e4);if(_0x1da7ab)return{'hasTimers':!![],'timersCount':_0x1da7ab[_0x979cfb(0x142)]['length'],'createdAt':_0x1da7ab['createdAt'],'gatewayPaymentId':_0x1da7ab[_0x979cfb(0x1cb)]};return{'hasTimers':![]};}async[a57_0x2712b5(0x149)](_0x38033e,_0x2a7613){const _0xb7c834=a57_0x2712b5;try{const _0x2341a6=await database_1[_0xb7c834(0x12b)]['shop'][_0xb7c834(0x220)]({'where':{'id':_0x38033e},'select':{'gatewaySettings':!![]}});if(!_0x2341a6?.[_0xb7c834(0x13e)])return console[_0xb7c834(0x1b3)]('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x38033e+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x306086=JSON[_0xb7c834(0x1c9)](_0x2341a6['gatewaySettings']);for(const [_0x3fd707,_0x52fe57]of Object[_0xb7c834(0x22b)](_0x306086)){if(_0x3fd707['toLowerCase']()===_0x2a7613[_0xb7c834(0x126)]()){const _0x26f97b=_0x52fe57[_0xb7c834(0x21f)]||0xa;return console[_0xb7c834(0x1b3)](_0xb7c834(0x17a)+_0x2a7613+_0xb7c834(0x207)+_0x38033e+':\x20'+_0x26f97b+'%'),_0x26f97b;}}return console[_0xb7c834(0x1b3)](_0xb7c834(0x205)+_0x2a7613+_0xb7c834(0x1d7)+_0x38033e+_0xb7c834(0x13b)),0xa;}catch(_0xa740ba){return console[_0xb7c834(0x14b)](_0xb7c834(0x139)+_0x38033e+_0xb7c834(0x161)+_0x2a7613+':',_0xa740ba),0xa;}}}exports[a57_0x2712b5(0x18d)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();