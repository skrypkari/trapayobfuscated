'use strict';function a37_0x1833(_0x15a0a3,_0x575044){const _0x38eb2a=a37_0x38eb();return a37_0x1833=function(_0x1833dd,_0x8eb8f4){_0x1833dd=_0x1833dd-0xcb;let _0x4c73af=_0x38eb2a[_0x1833dd];return _0x4c73af;},a37_0x1833(_0x15a0a3,_0x575044);}const a37_0x563012=a37_0x1833;(function(_0x29ce62,_0x562afd){const _0x20fd61=a37_0x1833,_0xf8693d=_0x29ce62();while(!![]){try{const _0x51d786=parseInt(_0x20fd61(0x19b))/0x1*(parseInt(_0x20fd61(0x190))/0x2)+parseInt(_0x20fd61(0x179))/0x3*(-parseInt(_0x20fd61(0x1aa))/0x4)+-parseInt(_0x20fd61(0xfb))/0x5*(-parseInt(_0x20fd61(0xcf))/0x6)+-parseInt(_0x20fd61(0xee))/0x7*(-parseInt(_0x20fd61(0x165))/0x8)+parseInt(_0x20fd61(0xfa))/0x9+-parseInt(_0x20fd61(0x1ae))/0xa*(-parseInt(_0x20fd61(0x16e))/0xb)+-parseInt(_0x20fd61(0x1af))/0xc*(parseInt(_0x20fd61(0x10d))/0xd);if(_0x51d786===_0x562afd)break;else _0xf8693d['push'](_0xf8693d['shift']());}catch(_0x2e4cba){_0xf8693d['push'](_0xf8693d['shift']());}}}(a37_0x38eb,0x505bc));function a37_0x38eb(){const _0x22f35e=['❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','settings','error','delay','now','.\x20Remaining\x20active\x20timers:\x20','includes','transactionId','/status/','PAID','setDate','\x20seconds\x20(','./loggerService','getPaymentTimerInfo','status','✅\x20[CHECK]\x20Payment\x20','paid','cointopay','\x20\x20\x20📝\x20Context:','Payment\x20not\x20found','\x20\x20\x20-\x20gatewayPaymentId:\x20','logShopWebhookSent','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','floor','\x20found:','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20current\x20status:\x20','COINTOPAY_ERROR','\x20pending\x20CoinToPay\x20payments','\x20\x20\x20-\x20paymentId:\x20','stringify','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','checkPaymentStatus','48VBWsIw','paymentDetails','Shop\x20webhook\x20sent\x20to\x20','\x20status\x20changed\x20to\x20','📊\x20[HOURLY]\x20Payment\x20','\x20is\x20older\x20than\x20','TesSoft\x20Payment\x20System/1.0','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','GLOBAL_CHECK_INTERVAL_MS','1793IOOYXN','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','CoinToPayService','defineProperty','cointopay_auto_expired','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','clearPaymentTimers','default','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','31509UAhVLs','auto_expire','⏰\x20[EXPIRY]\x20Payment\x20','cointopay_status_check_','createdOn','\x20(age:\x20','\x20not\x20enabled\x20for\x20shop\x20','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','💰\x20[CHECK]\x20Payment\x20','log','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20\x20\x20-\x20GatewayPaymentId:\x20','Success','\x20\x20\x20-\x20Gateway:\x20','Webhook\x20event\x20','getServiceStats','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','logWhiteDomainError','\x20\x20\x20📊\x20Status:\x20','set','\x20\x20\x20-\x20Amount:\x20','68NAaUXU','webhookLog','failed','\x20updated\x20successfully','application/json','amount','payment.pending','COINTOPAY_STATUS_CHANGE','adminNotes','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','2819NIzGtq','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','logShopWebhookError',',\x20clearing\x20individual\x20timers','\x20days\x20without\x20payment\x20confirmation','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','0100','\x20status:\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','checkAllPendingPayments','ms)','\x20in\x20','⏰\x20[GLOBAL]\x20Payment\x20','\x20\x20\x20📍\x20Source:\x20','36oXwhEe','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','createdAt','gateway','21870YohwMm','1320rZoxCn','\x20individual\x20payment\x20timers','size','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','webhookUrl','Automatically\x20expired\x20after\x20','\x20days,\x20marking\x20as\x20EXPIRED','forEach','shop','remitterIban','update','webhook_send','POST','EXPIRY_DAYS','toISOString','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','values','🛑\x20[SHUTDOWN]\x20Cleared\x20','600426ZPTUKF','EXPIRED','\x20to\x20clear','customerEmail',',\x20stopping\x20individual\x20checks','findMany','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','🪙\x20[DEBUG]\x20Creating\x20','get','\x20skipped,\x20','coinToPayStatusService','loggerService','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','Payment\x20older\x20than\x20','getTime','\x20not\x20found\x20in\x20database','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','created','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','payment.success','sendPaymentNotification','__esModule','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','logCoinToPayStatus','\x20days','\x20status\x20from\x20','gatewayOrderId','not\x20found','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','565789uptMmE','FAILED','\x20initial\x20timers\x20for\x20payment\x20','currency','catch','expired','paymentTimers','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','🧹\x20[CHECK]\x20Payment\x20','sendShopWebhook','\x20is\x20valid\x20for\x20checking,\x20proceeding...','coinToPayService','1421685PLbPEE','5DkLavh','timestamp','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','h),\x20skipping\x20global\x20check','from','\x20completed\x20for\x20payment\x20','\x20status\x20is\x20','\x20not\x20found,\x20clearing\x20timers','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','customerName','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20details:','toLowerCase','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','gatewayPaymentId','confirmedOn','Failed\x20to\x20send\x20shop\x20webhook:','91195WNyfMX','checkSinglePayment','paymentId','payment.failed','payment','\x20\x20\x20📅\x20Time:\x20','startPeriodicStatusCheck','globalCheckInterval','📊\x20[CHECK]\x20Payment\x20','iban','CoinToPayStatusService','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','🧹\x20[DEBUG]\x20Clearing\x20','\x20\x20\x20-\x20ShopId:\x20','\x20expired\x20CoinToPay\x20payments','\x20marked\x20as\x20paid\x20at:\x20','length','timers','status_check','🪙\x20[TIMER]\x20Individual\x20check\x20#','unknown','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','findUnique','⚠️\x20[CHECK]\x20Payment\x20','orderId','../config/database','⏰\x20[HOURLY]\x20Payment\x20','\x20timers\x20for\x20payment\x20','✅\x20[EXPIRY]\x20Payment\x20','\x20\x20\x20❌\x20Error:\x20','create','🔄\x20[CHECK]\x20Updating\x20payment\x20','bankDetails','message','❌\x20[CHECK]\x20Payment\x20','\x20for\x20payment\x20','PENDING','checkSinglePaymentById','checkPaymentById','sendPaymentStatusNotification','toFixed','❌\x20[HOURLY]\x20Payment\x20','5\x20minutes','\x20->\x20','\x20checked,\x20','\x20triggered\x20for\x20payment\x20','logCoinToPayError','\x20is\x20too\x20new\x20(','shopId','🪙\x20[GLOBAL]\x20Found\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','paidAt','Bank\x20Details:\x20'];a37_0x38eb=function(){return _0x22f35e;};return a37_0x38eb();}var __importDefault=this&&this['__importDefault']||function(_0x1cf6b8){const _0x390b06=a37_0x1833;return _0x1cf6b8&&_0x1cf6b8[_0x390b06(0xe6)]?_0x1cf6b8:{'default':_0x1cf6b8};};Object[a37_0x563012(0x172)](exports,a37_0x563012(0xe6),{'value':!![]}),exports[a37_0x563012(0xdb)]=exports[a37_0x563012(0x117)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a37_0x563012(0x126))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a37_0x563012(0x14f));class CoinToPayStatusService{constructor(){const _0x31e510=a37_0x563012;this[_0x31e510(0x114)]=null,this[_0x31e510(0x16d)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x31e510(0xf4)]=new Map(),this[_0x31e510(0xf9)]=new coinToPayService_1[(_0x31e510(0x171))](),console[_0x31e510(0x182)]('🪙\x20CoinToPayStatusService\x20initialized');}['schedulePaymentChecks'](_0x57ecb9,_0xfdd45){const _0x59a54b=a37_0x563012;console[_0x59a54b(0x182)](_0x59a54b(0x118)),console[_0x59a54b(0x182)](_0x59a54b(0x161)+_0x57ecb9),console['log'](_0x59a54b(0x157)+_0xfdd45),this[_0x59a54b(0x175)](_0x57ecb9);const _0x19b66f=[],_0xd5c6f0=new Date(),_0x5215e1=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x59a54b(0x137)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x59a54b(0x182)](_0x59a54b(0xd8)+_0x5215e1[_0x59a54b(0x11d)]+_0x59a54b(0xf0)+_0x57ecb9);let _0x28e157=0x0;_0x5215e1['forEach']((_0x428b89,_0x390917)=>{const _0x2f6829=_0x59a54b;_0x28e157+=_0x428b89[_0x2f6829(0x146)];const _0x70a5e8=setTimeout(async()=>{const _0x4bdf36=_0x2f6829;console[_0x4bdf36(0x182)](_0x4bdf36(0x120)+(_0x390917+0x1)+_0x4bdf36(0x13a)+_0x57ecb9+'\x20(after\x20'+_0x428b89['description']+')');try{await this[_0x4bdf36(0x132)](_0x57ecb9),console['log'](_0x4bdf36(0x1a4)+(_0x390917+0x1)+_0x4bdf36(0x101)+_0x57ecb9);}catch(_0x25631e){console[_0x4bdf36(0x145)](_0x4bdf36(0x199)+(_0x390917+0x1)+_0x4bdf36(0x130)+_0x57ecb9+':',_0x25631e),this[_0x4bdf36(0x13b)](_0x57ecb9,_0xfdd45,_0x25631e,_0x4bdf36(0x11f),{'checkNumber':_0x390917+0x1,'scheduledAfter':_0x428b89['description'],'isIndividualCheck':!![]});}},_0x28e157);_0x19b66f['push'](_0x70a5e8),console[_0x2f6829(0x182)](_0x2f6829(0xe7)+(_0x390917+0x1)+_0x2f6829(0x130)+_0x57ecb9+_0x2f6829(0x1a7)+_0x28e157/0x3e8+_0x2f6829(0x14e)+_0x428b89['description']+')');});const _0x2d4150=setInterval(async()=>{const _0x25ea16=_0x59a54b;console[_0x25ea16(0x182)](_0x25ea16(0x143)+_0x57ecb9);try{const _0x344969=await database_1[_0x25ea16(0x176)]['payment'][_0x25ea16(0x123)]({'where':{'id':_0x57ecb9},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x344969){console['log'](_0x25ea16(0x136)+_0x57ecb9+_0x25ea16(0x103)),this['clearPaymentTimers'](_0x57ecb9);return;}console[_0x25ea16(0x182)](_0x25ea16(0x169)+_0x57ecb9+_0x25ea16(0x15e)+_0x344969[_0x25ea16(0x151)]);if(_0x344969[_0x25ea16(0x151)]!==_0x25ea16(0x131)){console[_0x25ea16(0x182)]('✅\x20[HOURLY]\x20Payment\x20'+_0x57ecb9+_0x25ea16(0x102)+_0x344969[_0x25ea16(0x151)]+_0x25ea16(0xd3)),this['clearPaymentTimers'](_0x57ecb9);return;}const _0x29346f=Math[_0x25ea16(0x15b)]((Date['now']()-_0x344969[_0x25ea16(0x1ac)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x29346f>=this[_0x25ea16(0x1bd)]){console[_0x25ea16(0x182)](_0x25ea16(0x127)+_0x57ecb9+'\x20is\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x25ea16(0xdd)),this['clearPaymentTimers'](_0x57ecb9);return;}await this[_0x25ea16(0x132)](_0x57ecb9),console[_0x25ea16(0x182)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x57ecb9);}catch(_0x41a59a){console['error'](_0x25ea16(0x170)+_0x57ecb9+':',_0x41a59a),this[_0x25ea16(0x13b)](_0x57ecb9,_0xfdd45,_0x41a59a,_0x25ea16(0x11f),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x19b66f['push'](_0x2d4150),this['paymentTimers'][_0x59a54b(0x18e)](_0x57ecb9,{'timers':_0x19b66f,'paymentId':_0x57ecb9,'gatewayPaymentId':_0xfdd45,'createdAt':_0xd5c6f0}),console['log'](_0x59a54b(0x1a1)+_0x5215e1[_0x59a54b(0x11d)]+_0x59a54b(0x177)+_0x57ecb9),console[_0x59a54b(0x182)](_0x59a54b(0xd5)+this[_0x59a54b(0xf4)][_0x59a54b(0x1b1)]),this['logCoinToPayStatus'](_0x57ecb9,_0xfdd45,'PENDING',_0x59a54b(0x131),_0x59a54b(0x11f),{'action':'schedule_created','scheduledChecks':_0x5215e1[_0x59a54b(0x11d)],'firstCheckIn':_0x5215e1[0x0][_0x59a54b(0x146)]/0x3e8,'totalTimers':this[_0x59a54b(0xf4)]['size']});}[a37_0x563012(0x175)](_0x49ba46){const _0x53cf78=a37_0x563012,_0x3fde6f=this['paymentTimers'][_0x53cf78(0xd9)](_0x49ba46);_0x3fde6f?(console['log'](_0x53cf78(0x119)+_0x3fde6f[_0x53cf78(0x11e)]['length']+_0x53cf78(0x128)+_0x49ba46),_0x3fde6f[_0x53cf78(0x11e)][_0x53cf78(0x1b7)]((_0x300877,_0x1bf2d1)=>{_0x300877&&(clearTimeout(_0x300877),clearInterval(_0x300877),console['log']('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x1bf2d1+0x1)+'\x20for\x20payment\x20'+_0x49ba46));}),this[_0x53cf78(0xf4)]['delete'](_0x49ba46),console[_0x53cf78(0x182)](_0x53cf78(0xd6)+_0x49ba46+_0x53cf78(0x148)+this[_0x53cf78(0xf4)][_0x53cf78(0x1b1)])):console[_0x53cf78(0x182)](_0x53cf78(0x18a)+_0x49ba46+_0x53cf78(0xd1));}async[a37_0x563012(0x132)](_0x2695a1){const _0x167384=a37_0x563012;console[_0x167384(0x182)](_0x167384(0x16f)+_0x2695a1);const _0x37ccc2=await database_1['default'][_0x167384(0x111)]['findUnique']({'where':{'id':_0x2695a1},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x37ccc2){console['log'](_0x167384(0x12f)+_0x2695a1+_0x167384(0xe0));return;}console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x2695a1+_0x167384(0x15c)),console['log'](_0x167384(0x186)+_0x37ccc2[_0x167384(0x1ad)]),console[_0x167384(0x182)]('\x20\x20\x20-\x20Status:\x20'+_0x37ccc2[_0x167384(0x151)]),console['log'](_0x167384(0x184)+_0x37ccc2['gatewayPaymentId']),console[_0x167384(0x182)](_0x167384(0x18f)+_0x37ccc2[_0x167384(0x195)]+'\x20'+_0x37ccc2['currency']),console['log'](_0x167384(0x11a)+_0x37ccc2[_0x167384(0x13d)]);if(_0x37ccc2[_0x167384(0x1ad)]!==_0x167384(0x154)){console['log'](_0x167384(0x124)+_0x2695a1+_0x167384(0x16c)+_0x37ccc2['gateway']+')');return;}if(_0x37ccc2[_0x167384(0x151)]!==_0x167384(0x131)){console['log'](_0x167384(0x124)+_0x2695a1+_0x167384(0x102)+_0x37ccc2[_0x167384(0x151)]+_0x167384(0xd3)),this[_0x167384(0x175)](_0x2695a1);return;}if(!_0x37ccc2[_0x167384(0x10a)]){console[_0x167384(0x182)](_0x167384(0x124)+_0x2695a1+'\x20has\x20no\x20gatewayPaymentId');return;}console['log'](_0x167384(0x152)+_0x2695a1+_0x167384(0xf8)),await this[_0x167384(0x10e)](_0x37ccc2);}['logCoinToPayStatus'](_0x1d519b,_0x3428a9,_0x5bd385,_0xed41b0,_0x52198f,_0x1b9728){const _0xbe9bd7=a37_0x563012,_0x2a59b4={'type':_0xbe9bd7(0x197),'paymentId':_0x1d519b,'gatewayPaymentId':_0x3428a9,'oldStatus':_0x5bd385,'newStatus':_0xed41b0,'source':_0x52198f,'timestamp':new Date()[_0xbe9bd7(0xcb)](),'details':_0x1b9728||{}};loggerService_1['loggerService'][_0xbe9bd7(0xe8)](_0x2a59b4),console['log'](_0xbe9bd7(0xfd)+_0x1d519b+'\x20('+_0x3428a9+')'),console[_0xbe9bd7(0x182)](_0xbe9bd7(0x18d)+_0x5bd385+_0xbe9bd7(0x138)+_0xed41b0),console[_0xbe9bd7(0x182)](_0xbe9bd7(0x1a9)+_0x52198f),console[_0xbe9bd7(0x182)](_0xbe9bd7(0x112)+_0x2a59b4[_0xbe9bd7(0xfc)]),_0x1b9728&&console[_0xbe9bd7(0x182)]('\x20\x20\x20📝\x20Details:',_0x1b9728);}[a37_0x563012(0x13b)](_0x19c957,_0x5152ae,_0x4b559d,_0x1ffe57,_0x3fa9c6){const _0x59b9a7=a37_0x563012,_0x5a0a4a={'type':_0x59b9a7(0x15f),'paymentId':_0x19c957,'gatewayPaymentId':_0x5152ae,'error':_0x4b559d instanceof Error?{'message':_0x4b559d[_0x59b9a7(0x12e)],'stack':_0x4b559d['stack']}:_0x4b559d,'source':_0x1ffe57,'timestamp':new Date()[_0x59b9a7(0xcb)](),'context':_0x3fa9c6||{}};loggerService_1[_0x59b9a7(0xdc)]['logCoinToPayError'](_0x5a0a4a),console[_0x59b9a7(0x145)](_0x59b9a7(0x19c)+_0x19c957+'\x20('+_0x5152ae+')'),console['error'](_0x59b9a7(0x12a)+(_0x4b559d instanceof Error?_0x4b559d[_0x59b9a7(0x12e)]:_0x4b559d)),console[_0x59b9a7(0x145)]('\x20\x20\x20📍\x20Source:\x20'+_0x1ffe57),console['error'](_0x59b9a7(0x112)+_0x5a0a4a[_0x59b9a7(0xfc)]),_0x3fa9c6&&console['error'](_0x59b9a7(0x155),_0x3fa9c6);}[a37_0x563012(0x113)](){const _0x5db64f=a37_0x563012;console[_0x5db64f(0x182)](_0x5db64f(0x18b)),this['checkAllPendingPayments']()[_0x5db64f(0xf2)](_0x4aa4d9=>{const _0x441d11=_0x5db64f;console[_0x441d11(0x145)](_0x441d11(0x1a0),_0x4aa4d9);}),this[_0x5db64f(0x114)]=setInterval(async()=>{const _0x3c4d6a=_0x5db64f;try{console['log'](_0x3c4d6a(0x1ab)),await this['checkAllPendingPayments'](),console[_0x3c4d6a(0x182)](_0x3c4d6a(0x1b2));}catch(_0x21e0c1){console[_0x3c4d6a(0x145)](_0x3c4d6a(0xe3),_0x21e0c1);}},this[_0x5db64f(0x16d)]),console[_0x5db64f(0x182)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}['stopPeriodicStatusCheck'](){const _0x25d5e=a37_0x563012;console[_0x25d5e(0x182)](_0x25d5e(0x122));this['globalCheckInterval']&&(clearInterval(this[_0x25d5e(0x114)]),this[_0x25d5e(0x114)]=null,console[_0x25d5e(0x182)](_0x25d5e(0x183)));const _0x390e64=this[_0x25d5e(0xf4)][_0x25d5e(0x1b1)];for(const [_0x1924f7]of this[_0x25d5e(0xf4)]){this[_0x25d5e(0x175)](_0x1924f7);}console[_0x25d5e(0x182)](_0x25d5e(0xce)+_0x390e64+_0x25d5e(0x1b0));}async[a37_0x563012(0x1a5)](){const _0x54ac2b=a37_0x563012;try{console[_0x54ac2b(0x182)](_0x54ac2b(0x15d));const _0x56008d=await database_1[_0x54ac2b(0x176)][_0x54ac2b(0x111)][_0x54ac2b(0xd4)]({'where':{'gateway':_0x54ac2b(0x154),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x54ac2b(0x13e)+_0x56008d[_0x54ac2b(0x11d)]+_0x54ac2b(0x160));if(_0x56008d[_0x54ac2b(0x11d)]===0x0){console[_0x54ac2b(0x182)](_0x54ac2b(0x13f));return;}const _0x18f925=await this['checkExpiredPayments'](_0x56008d);console[_0x54ac2b(0x182)]('⏰\x20[GLOBAL]\x20Found\x20'+_0x18f925['length']+_0x54ac2b(0x11b));let _0x69d7f2=0x0,_0x457a8f=0x0;for(const _0x23c2fb of _0x56008d){try{if(_0x18f925['includes'](_0x23c2fb['id'])){console[_0x54ac2b(0x182)](_0x54ac2b(0x1a8)+_0x23c2fb['id']+_0x54ac2b(0x174)),_0x457a8f++;continue;}if(this[_0x54ac2b(0xf4)]['has'](_0x23c2fb['id'])){console[_0x54ac2b(0x182)](_0x54ac2b(0x1a8)+_0x23c2fb['id']+_0x54ac2b(0xfe)),_0x457a8f++;continue;}const _0x4af2f3=(Date[_0x54ac2b(0x147)]()-_0x23c2fb[_0x54ac2b(0x1ac)][_0x54ac2b(0xdf)]())/(0x3e8*0x3c*0x3c);if(_0x4af2f3<0x1){console[_0x54ac2b(0x182)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x23c2fb['id']+_0x54ac2b(0x13c)+_0x4af2f3[_0x54ac2b(0x135)](0x1)+_0x54ac2b(0xff)),_0x457a8f++;continue;}console['log'](_0x54ac2b(0xe1)+_0x23c2fb['id']+_0x54ac2b(0x17e)+_0x4af2f3[_0x54ac2b(0x135)](0x1)+'h)'),await this['checkSinglePayment'](_0x23c2fb),_0x69d7f2++,await new Promise(_0x12161e=>setTimeout(_0x12161e,0x7d0));}catch(_0x566f1a){console[_0x54ac2b(0x145)](_0x54ac2b(0x106)+_0x23c2fb['id']+':',_0x566f1a),this[_0x54ac2b(0x13b)](_0x23c2fb['id'],_0x23c2fb[_0x54ac2b(0x10a)]||_0x54ac2b(0x121),_0x566f1a,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x23c2fb['amount'],'paymentCurrency':_0x23c2fb[_0x54ac2b(0xf1)],'shopId':_0x23c2fb[_0x54ac2b(0x13d)],'createdAt':_0x23c2fb[_0x54ac2b(0x1ac)]}),loggerService_1[_0x54ac2b(0xdc)][_0x54ac2b(0x18c)](_0x54ac2b(0x154),_0x54ac2b(0x14b)+_0x23c2fb[_0x54ac2b(0x10a)],_0x566f1a);}}console[_0x54ac2b(0x182)](_0x54ac2b(0x159)+_0x69d7f2+_0x54ac2b(0x139)+_0x457a8f+_0x54ac2b(0xda)+_0x18f925[_0x54ac2b(0x11d)]+'\x20expired');}catch(_0x2f3c43){console[_0x54ac2b(0x145)](_0x54ac2b(0x19a),_0x2f3c43);}}async['checkExpiredPayments'](_0x411d3d){const _0x6bfe5e=a37_0x563012,_0x4ac52e=[],_0xb13446=new Date();_0xb13446[_0x6bfe5e(0x14d)](_0xb13446['getDate']()-this['EXPIRY_DAYS']),console[_0x6bfe5e(0x182)](_0x6bfe5e(0x15a)+this[_0x6bfe5e(0x1bd)]+'\x20days\x20(created\x20before\x20'+_0xb13446['toISOString']()+')');for(const _0x8c9eb4 of _0x411d3d){if(_0x8c9eb4[_0x6bfe5e(0x1ac)]<_0xb13446){console[_0x6bfe5e(0x182)](_0x6bfe5e(0x17b)+_0x8c9eb4['id']+_0x6bfe5e(0x16a)+this[_0x6bfe5e(0x1bd)]+_0x6bfe5e(0x1b6));try{this[_0x6bfe5e(0xe8)](_0x8c9eb4['id'],_0x8c9eb4[_0x6bfe5e(0x10a)]||'unknown',_0x6bfe5e(0x131),'EXPIRED',_0x6bfe5e(0x17a),{'reason':_0x6bfe5e(0xde)+this['EXPIRY_DAYS']+_0x6bfe5e(0xe9),'createdAt':_0x8c9eb4[_0x6bfe5e(0x1ac)],'daysSinceCreation':Math[_0x6bfe5e(0x15b)]((Date['now']()-_0x8c9eb4[_0x6bfe5e(0x1ac)][_0x6bfe5e(0xdf)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x8c9eb4[_0x6bfe5e(0x195)],'paymentCurrency':_0x8c9eb4[_0x6bfe5e(0xf1)],'shopId':_0x8c9eb4[_0x6bfe5e(0x13d)]}),await database_1['default'][_0x6bfe5e(0x111)][_0x6bfe5e(0x1ba)]({'where':{'id':_0x8c9eb4['id']},'data':{'status':_0x6bfe5e(0xd0),'updatedAt':new Date(),'adminNotes':_0x6bfe5e(0x1b5)+this[_0x6bfe5e(0x1bd)]+_0x6bfe5e(0x19f)}}),await database_1[_0x6bfe5e(0x176)]['webhookLog']['create']({'data':{'paymentId':_0x8c9eb4['id'],'shopId':_0x8c9eb4[_0x6bfe5e(0x13d)],'event':_0x6bfe5e(0x173),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':'Payment\x20older\x20than\x20'+this[_0x6bfe5e(0x1bd)]+'\x20days','createdAt':_0x8c9eb4[_0x6bfe5e(0x1ac)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x6bfe5e(0x15b)]((Date[_0x6bfe5e(0x147)]()-_0x8c9eb4[_0x6bfe5e(0x1ac)][_0x6bfe5e(0xdf)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x6bfe5e(0xf7)](_0x8c9eb4,_0x6bfe5e(0xd0)),await this[_0x6bfe5e(0x134)](_0x8c9eb4,'EXPIRED'),this[_0x6bfe5e(0x175)](_0x8c9eb4['id']),_0x4ac52e['push'](_0x8c9eb4['id']),console[_0x6bfe5e(0x182)](_0x6bfe5e(0x129)+_0x8c9eb4['id']+_0x6bfe5e(0x1b3)+this['EXPIRY_DAYS']+'-day\x20timeout');}catch(_0x36a421){console[_0x6bfe5e(0x145)](_0x6bfe5e(0xed)+_0x8c9eb4['id']+':',_0x36a421),this[_0x6bfe5e(0x13b)](_0x8c9eb4['id'],_0x8c9eb4['gatewayPaymentId']||'unknown',_0x36a421,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x8c9eb4[_0x6bfe5e(0x1ac)],'daysSinceCreation':Math['floor']((Date[_0x6bfe5e(0x147)]()-_0x8c9eb4[_0x6bfe5e(0x1ac)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x4ac52e;}async[a37_0x563012(0x10e)](_0xe9ab2b){const _0xdd42e0=a37_0x563012;if(!_0xe9ab2b['gatewayPaymentId']){console[_0xdd42e0(0x182)](_0xdd42e0(0x124)+_0xe9ab2b['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0xdd42e0(0x182)](_0xdd42e0(0x189)+_0xe9ab2b['id']+'\x20('+_0xe9ab2b['gatewayPaymentId']+')');try{const _0x342490=await this[_0xdd42e0(0xf9)][_0xdd42e0(0x164)](_0xe9ab2b[_0xdd42e0(0x10a)]);console[_0xdd42e0(0x182)]('📊\x20[CHECK]\x20Payment\x20'+_0xe9ab2b['id']+_0xdd42e0(0x1a3)+_0x342490[_0xdd42e0(0x151)]);_0x342490[_0xdd42e0(0x166)]&&console['log']('📊\x20[CHECK]\x20Payment\x20'+_0xe9ab2b['id']+_0xdd42e0(0x107),{'iban':_0x342490[_0xdd42e0(0x166)][_0xdd42e0(0x116)]||_0xdd42e0(0xec),'transactionId':_0x342490['paymentDetails']['transactionId'],'createdOn':_0x342490['paymentDetails'][_0xdd42e0(0x17d)],'confirmedOn':_0x342490[_0xdd42e0(0x166)]['confirmedOn']||'not\x20confirmed'});if(_0x342490[_0xdd42e0(0x151)]!==_0xe9ab2b['status']){console[_0xdd42e0(0x182)](_0xdd42e0(0x12c)+_0xe9ab2b['id']+_0xdd42e0(0xea)+_0xe9ab2b[_0xdd42e0(0x151)]+'\x20to\x20'+_0x342490[_0xdd42e0(0x151)]),this[_0xdd42e0(0xe8)](_0xe9ab2b['id'],_0xe9ab2b[_0xdd42e0(0x10a)],_0xe9ab2b['status'],_0x342490[_0xdd42e0(0x151)],_0xdd42e0(0x11f),{'paymentDetails':_0x342490[_0xdd42e0(0x166)],'amount':_0x342490[_0xdd42e0(0x195)],'currency':_0x342490[_0xdd42e0(0xf1)],'shopId':_0xe9ab2b[_0xdd42e0(0x13d)],'checkTimestamp':new Date()['toISOString']()});const _0x4d584d={'status':_0x342490[_0xdd42e0(0x151)],'updatedAt':new Date()};_0x342490[_0xdd42e0(0x151)]===_0xdd42e0(0x14c)&&_0xe9ab2b[_0xdd42e0(0x151)]!==_0xdd42e0(0x14c)&&(_0x4d584d[_0xdd42e0(0x140)]=new Date(),console[_0xdd42e0(0x182)](_0xdd42e0(0x181)+_0xe9ab2b['id']+_0xdd42e0(0x11c)+_0x4d584d[_0xdd42e0(0x140)][_0xdd42e0(0xcb)]()));if(_0x342490['paymentDetails']){const _0x183871=_0x342490[_0xdd42e0(0x166)];_0x183871[_0xdd42e0(0x116)]&&(_0x4d584d[_0xdd42e0(0x1b9)]=_0x183871[_0xdd42e0(0x116)],console['log'](_0xdd42e0(0xf5)+_0x183871[_0xdd42e0(0x116)]));if(_0x183871[_0xdd42e0(0x12d)]){const _0x9fd7de=_0xe9ab2b[_0xdd42e0(0x198)]||'',_0x4044eb=_0xdd42e0(0x141)+_0x183871[_0xdd42e0(0x12d)];_0x4d584d[_0xdd42e0(0x198)]=_0x9fd7de?_0x9fd7de+'\x0a\x0a'+_0x4044eb:_0x4044eb,console['log'](_0xdd42e0(0xcc));}_0x183871[_0xdd42e0(0x14a)]&&console['log'](_0xdd42e0(0x163)+_0x183871[_0xdd42e0(0x14a)]),_0x183871[_0xdd42e0(0x10b)]&&console[_0xdd42e0(0x182)](_0xdd42e0(0x180)+_0x183871[_0xdd42e0(0x10b)]);}await database_1[_0xdd42e0(0x176)]['payment'][_0xdd42e0(0x1ba)]({'where':{'id':_0xe9ab2b['id']},'data':_0x4d584d}),await database_1[_0xdd42e0(0x176)][_0xdd42e0(0x191)]['create']({'data':{'paymentId':_0xe9ab2b['id'],'shopId':_0xe9ab2b[_0xdd42e0(0x13d)],'event':_0xdd42e0(0x17c)+_0x342490[_0xdd42e0(0x151)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0xdd42e0(0x162)]({'oldStatus':_0xe9ab2b[_0xdd42e0(0x151)],'newStatus':_0x342490[_0xdd42e0(0x151)],'paymentDetails':_0x342490[_0xdd42e0(0x166)],'checkedAt':new Date()[_0xdd42e0(0xcb)]()})}}),await this['sendShopWebhook'](_0xe9ab2b,_0x342490[_0xdd42e0(0x151)]),await this['sendPaymentStatusNotification'](_0xe9ab2b,_0x342490['status']),_0x342490[_0xdd42e0(0x151)]!=='PENDING'&&(console[_0xdd42e0(0x182)](_0xdd42e0(0xf6)+_0xe9ab2b['id']+_0xdd42e0(0x168)+_0x342490[_0xdd42e0(0x151)]+_0xdd42e0(0x19e)),this[_0xdd42e0(0x175)](_0xe9ab2b['id'])),console[_0xdd42e0(0x182)](_0xdd42e0(0x152)+_0xe9ab2b['id']+_0xdd42e0(0x193));}else console['log'](_0xdd42e0(0x115)+_0xe9ab2b['id']+'\x20status\x20unchanged\x20('+_0x342490[_0xdd42e0(0x151)]+')'),this[_0xdd42e0(0xe8)](_0xe9ab2b['id'],_0xe9ab2b[_0xdd42e0(0x10a)],_0xe9ab2b[_0xdd42e0(0x151)],_0x342490[_0xdd42e0(0x151)],_0xdd42e0(0x11f),{'statusUnchanged':!![],'paymentDetails':_0x342490[_0xdd42e0(0x166)],'amount':_0x342490[_0xdd42e0(0x195)],'currency':_0x342490[_0xdd42e0(0xf1)],'shopId':_0xe9ab2b[_0xdd42e0(0x13d)],'checkTimestamp':new Date()[_0xdd42e0(0xcb)]()});}catch(_0x39c678){console['error'](_0xdd42e0(0x142)+_0xe9ab2b['id']+':',_0x39c678),this[_0xdd42e0(0x13b)](_0xe9ab2b['id'],_0xe9ab2b[_0xdd42e0(0x10a)],_0x39c678,_0xdd42e0(0x11f),{'paymentAmount':_0xe9ab2b[_0xdd42e0(0x195)],'paymentCurrency':_0xe9ab2b[_0xdd42e0(0xf1)],'shopId':_0xe9ab2b[_0xdd42e0(0x13d)],'createdAt':_0xe9ab2b[_0xdd42e0(0x1ac)]}),await database_1[_0xdd42e0(0x176)][_0xdd42e0(0x191)][_0xdd42e0(0x12b)]({'data':{'paymentId':_0xe9ab2b['id'],'shopId':_0xe9ab2b[_0xdd42e0(0x13d)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x39c678 instanceof Error?_0x39c678[_0xdd42e0(0x12e)]:'Unknown\x20error','gatewayPaymentId':_0xe9ab2b[_0xdd42e0(0x10a)],'checkedAt':new Date()[_0xdd42e0(0xcb)]()})}});}}async[a37_0x563012(0xf7)](_0x9c8a66,_0x1765e2){const _0x3f882b=a37_0x563012,_0x5111e8=Date['now']();try{const _0x1c8dc6=_0x9c8a66[_0x3f882b(0x1b8)],_0x39cfa9=_0x1c8dc6['settings'];if(!_0x39cfa9?.[_0x3f882b(0x1b4)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1c8dc6['id']);return;}const _0x5138d0=_0x1765e2===_0x3f882b(0x14c)?_0x3f882b(0xe4):_0x1765e2===_0x3f882b(0xef)?_0x3f882b(0x110):_0x1765e2===_0x3f882b(0xd0)?_0x3f882b(0x110):_0x3f882b(0x196);if(!_0x39cfa9['webhookEvents']?.[_0x3f882b(0x149)](_0x5138d0)){console[_0x3f882b(0x182)](_0x3f882b(0x187)+_0x5138d0+_0x3f882b(0x17f)+_0x1c8dc6['id']);return;}const _0x2b2d49={'event':_0x5138d0,'payment':{'id':_0x9c8a66['id'],'order_id':_0x9c8a66[_0x3f882b(0x125)],'gateway_order_id':_0x9c8a66[_0x3f882b(0xeb)],'gateway':_0x3f882b(0x1a2),'amount':_0x9c8a66[_0x3f882b(0x195)],'currency':_0x9c8a66['currency'],'status':_0x1765e2[_0x3f882b(0x108)](),'customer_email':_0x9c8a66[_0x3f882b(0xd2)],'customer_name':_0x9c8a66[_0x3f882b(0x105)],'created_at':_0x9c8a66[_0x3f882b(0x1ac)],'updated_at':new Date()}},_0x3967f0=await fetch(_0x39cfa9['webhookUrl'],{'method':_0x3f882b(0x1bc),'headers':{'Content-Type':_0x3f882b(0x194),'User-Agent':_0x3f882b(0x16b)},'body':JSON[_0x3f882b(0x162)](_0x2b2d49)}),_0x1fbca4=Date[_0x3f882b(0x147)]()-_0x5111e8,_0xeae25f=_0x3967f0['ok']?_0x3f882b(0x185):await _0x3967f0['text']();loggerService_1['loggerService'][_0x3f882b(0x158)](_0x9c8a66[_0x3f882b(0x13d)],_0x39cfa9[_0x3f882b(0x1b4)],_0x5138d0,_0x3967f0[_0x3f882b(0x151)],_0x1fbca4,_0x2b2d49),console[_0x3f882b(0x182)](_0x3f882b(0x167)+_0x39cfa9[_0x3f882b(0x1b4)]+'\x20with\x20status\x20'+_0x3967f0[_0x3f882b(0x151)]+'\x20('+_0x1fbca4+_0x3f882b(0x1a6));}catch(_0x4af30a){console['error'](_0x3f882b(0x10c),_0x4af30a),loggerService_1[_0x3f882b(0xdc)][_0x3f882b(0x19d)](_0x9c8a66[_0x3f882b(0x13d)],_0x9c8a66[_0x3f882b(0x1b8)]?.[_0x3f882b(0x144)]?.[_0x3f882b(0x1b4)]||'unknown',_0x3f882b(0x1bb),_0x4af30a,{});}}async[a37_0x563012(0x134)](_0x452441,_0x1f4ea2){const _0x5b11e9=a37_0x563012;try{const _0x193771={'PENDING':_0x5b11e9(0xe2),'PAID':_0x5b11e9(0x153),'FAILED':_0x5b11e9(0x192),'EXPIRED':_0x5b11e9(0xf3)},_0xc5768f=_0x193771[_0x1f4ea2];if(!_0xc5768f||_0xc5768f===_0x5b11e9(0xe2))return;await telegramBotService_1['telegramBotService'][_0x5b11e9(0xe5)](_0x452441[_0x5b11e9(0x13d)],_0x452441,_0xc5768f);}catch(_0x2c8a7e){console['error'](_0x5b11e9(0x109),_0x2c8a7e);}}async[a37_0x563012(0x133)](_0x5df2a7){const _0x42ae01=a37_0x563012;console['log'](_0x42ae01(0x104)+_0x5df2a7);const _0x948513=await database_1[_0x42ae01(0x176)]['payment']['findUnique']({'where':{'id':_0x5df2a7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x948513)throw new Error(_0x42ae01(0x156));if(_0x948513[_0x42ae01(0x1ad)]!==_0x42ae01(0x154))throw new Error(_0x42ae01(0xd7));console[_0x42ae01(0x182)](_0x42ae01(0x178)+_0x5df2a7),await this[_0x42ae01(0x10e)](_0x948513),console['log']('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x5df2a7);}[a37_0x563012(0x188)](){const _0x473f7d=a37_0x563012,_0x31420b=this['globalCheckInterval']?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x1d30d3=Array[_0x473f7d(0x100)](this[_0x473f7d(0xf4)][_0x473f7d(0xcd)]())['map'](_0x332d22=>({'paymentId':_0x332d22[_0x473f7d(0x10f)],'gatewayPaymentId':_0x332d22[_0x473f7d(0x10a)],'createdAt':_0x332d22[_0x473f7d(0x1ac)],'timersCount':_0x332d22[_0x473f7d(0x11e)][_0x473f7d(0x11d)]}));return{'isActive':!!this[_0x473f7d(0x114)],'globalCheckIntervalMinutes':this[_0x473f7d(0x16d)]/(0x3e8*0x3c),'expiryDays':this[_0x473f7d(0x1bd)],'activeIndividualTimers':this[_0x473f7d(0xf4)][_0x473f7d(0x1b1)],'nextGlobalCheckIn':_0x31420b,'paymentTimersDetails':_0x1d30d3};}[a37_0x563012(0x150)](_0x1e28b8){const _0x2887ef=a37_0x563012,_0x450ce1=this[_0x2887ef(0xf4)][_0x2887ef(0xd9)](_0x1e28b8);if(_0x450ce1)return{'hasTimers':!![],'timersCount':_0x450ce1[_0x2887ef(0x11e)][_0x2887ef(0x11d)],'createdAt':_0x450ce1['createdAt'],'gatewayPaymentId':_0x450ce1[_0x2887ef(0x10a)]};return{'hasTimers':![]};}}exports[a37_0x563012(0x117)]=CoinToPayStatusService,exports[a37_0x563012(0xdb)]=new CoinToPayStatusService();