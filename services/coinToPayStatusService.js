'use strict';function a35_0x2bcd(_0x3fe7e2,_0x2d15cc){const _0xb60c3c=a35_0xb60c();return a35_0x2bcd=function(_0x2bcd00,_0x1b2b2f){_0x2bcd00=_0x2bcd00-0x1ef;let _0xd3f20e=_0xb60c3c[_0x2bcd00];return _0xd3f20e;},a35_0x2bcd(_0x3fe7e2,_0x2d15cc);}const a35_0x3447af=a35_0x2bcd;(function(_0x4ce816,_0x2e881a){const _0x46f4de=a35_0x2bcd,_0x324b7b=_0x4ce816();while(!![]){try{const _0x48be90=-parseInt(_0x46f4de(0x293))/0x1*(-parseInt(_0x46f4de(0x230))/0x2)+parseInt(_0x46f4de(0x2bb))/0x3*(parseInt(_0x46f4de(0x239))/0x4)+parseInt(_0x46f4de(0x23c))/0x5*(parseInt(_0x46f4de(0x243))/0x6)+parseInt(_0x46f4de(0x2a9))/0x7+-parseInt(_0x46f4de(0x211))/0x8+parseInt(_0x46f4de(0x24e))/0x9+-parseInt(_0x46f4de(0x2b8))/0xa;if(_0x48be90===_0x2e881a)break;else _0x324b7b['push'](_0x324b7b['shift']());}catch(_0x539ebc){_0x324b7b['push'](_0x324b7b['shift']());}}}(a35_0xb60c,0x9cddd));function a35_0xb60c(){const _0x392aa8=['Failed\x20to\x20mark\x20payment\x20as\x20expired','🪙\x20[GLOBAL]\x20Found\x20','shopId','\x20seconds\x20(','__esModule','\x20expired\x20CoinToPay\x20payments','__importDefault','⚠️\x20[CHECK]\x20Payment\x20','create','size','currency','CoinToPayStatusService','application/json','\x20not\x20enabled\x20for\x20shop\x20','💰\x20[CHECK]\x20Payment\x20','✅\x20[CHECK]\x20Payment\x20','\x20status\x20is\x20','PENDING','🪙\x20[DEBUG]\x20Creating\x20','not\x20found','values','payment.success','⏰\x20[GLOBAL]\x20Payment\x20','created','14dHYlFj','setDate','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','globalCheckInterval','POST','delay','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20(age:\x20','\x20pending\x20CoinToPay\x20payments','4JhJAko','\x20to\x20clear','\x20not\x20found,\x20clearing\x20timers','5znftBf','\x20\x20\x20-\x20gatewayPaymentId:\x20','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','not\x20confirmed','\x20has\x20no\x20gatewayPaymentId,\x20skipping','logShopWebhookError','cointopay','6701118zdXYsA','\x20found:','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','Payment\x20not\x20found','getTime','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','2\x20minutes','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','timers','cointopay_status_check_error','5\x20minutes','9536553btavJG','schedulePaymentChecks','coinToPayStatusService','sendShopWebhook','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','error','🛑\x20[SHUTDOWN]\x20Cleared\x20','checkPaymentStatus','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20is\x20older\x20than\x20','TesSoft\x20Payment\x20System/1.0','❌\x20[HOURLY]\x20Payment\x20','h),\x20skipping\x20global\x20check','🧹\x20[CHECK]\x20Payment\x20','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','customerEmail','amount','includes','checkSinglePayment','\x20\x20\x20📅\x20Time:\x20','toISOString','checkSinglePaymentById','failed','paid','/status/','length','\x20timers\x20for\x20payment\x20','.\x20Remaining\x20active\x20timers:\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','getServiceStats','./telegramBotService','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','findUnique','startPeriodicStatusCheck','getPaymentTimerInfo','\x20\x20\x20-\x20Amount:\x20','\x20\x20\x20-\x20paymentId:\x20','\x20completed\x20for\x20payment\x20','text','telegramBotService','paidAt','COINTOPAY_ERROR','paymentId','payment.pending','clearPaymentTimers','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','map','iban','✅\x20[TIMER]\x20Individual\x20check\x20#','stopPeriodicStatusCheck','⏰\x20[GLOBAL]\x20Found\x20','ms)','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','\x20has\x20no\x20gatewayPaymentId','\x20\x20\x20📝\x20Context:','stack','confirmedOn','🪙\x20[TIMER]\x20Individual\x20check\x20#','loggerService','catch','✅\x20[EXPIRY]\x20Payment\x20',',\x20stopping\x20individual\x20checks','webhook_send','EXPIRED','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','auto_expire','\x20to\x20','⏰\x20[EXPIRY]\x20Payment\x20','push','133321sJwVwH','settings','🧹\x20[DEBUG]\x20Clearing\x20','logCoinToPayError','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','description','✅\x20[HOURLY]\x20Payment\x20','bankDetails','logShopWebhookSent','\x20status\x20changed\x20to\x20','0100','\x20\x20\x20-\x20Status:\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20status:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','cointopay_status_check_','\x20days,\x20marking\x20as\x20EXPIRED','forEach','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','gatewayPaymentId','1581188JxseBJ','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20status\x20unchanged\x20(','\x20days\x20without\x20payment\x20confirmation','\x20\x20\x20📍\x20Source:\x20','\x20\x20\x20❌\x20Error:\x20','log','stringify','customerName','floor','checkExpiredPayments','📊\x20[CHECK]\x20Payment\x20','PAID','\x20\x20\x20-\x20ShopId:\x20','\x20days','21861710MwRkzk','Webhook\x20event\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','604353waOcRi','checkAllPendingPayments','toLowerCase','createdAt','\x20\x20\x20📝\x20Details:','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','status','../config/database','schedule_created','sendPaymentStatusNotification','paymentDetails','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','❌\x20[CHECK]\x20Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','delete','./gateways/coinToPayService','GLOBAL_CHECK_INTERVAL_MS','\x20initial\x20timers\x20for\x20payment\x20','webhookEvents','\x20\x20\x20-\x20Gateway:\x20','\x20->\x20','Bank\x20Details:\x20','shop','transactionId','EXPIRY_DAYS',',\x20clearing\x20individual\x20timers','unknown','findMany','logCoinToPayStatus','now','webhookUrl','\x20triggered\x20for\x20payment\x20','createdOn','webhookLog','remitterIban','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','timestamp','FAILED','🔄\x20[CHECK]\x20Updating\x20payment\x20','Payment\x20older\x20than\x20','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','⏰\x20[HOURLY]\x20Payment\x20','Failed\x20to\x20send\x20shop\x20webhook:','\x20for\x20payment\x20','coinToPayService','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20is\x20valid\x20for\x20checking,\x20proceeding...','gateway','getDate','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','message','update','payment.failed','CoinToPayService','default','expired','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','5666848yqhowl','\x20in\x20','paymentTimers','status_check','payment','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','checkPaymentById'];a35_0xb60c=function(){return _0x392aa8;};return a35_0xb60c();}var __importDefault=this&&this[a35_0x3447af(0x21e)]||function(_0x40a7ab){return _0x40a7ab&&_0x40a7ab['__esModule']?_0x40a7ab:{'default':_0x40a7ab};};Object['defineProperty'](exports,a35_0x3447af(0x21c),{'value':!![]}),exports[a35_0x3447af(0x250)]=exports[a35_0x3447af(0x223)]=void 0x0;const coinToPayService_1=require(a35_0x3447af(0x2ca)),database_1=__importDefault(require(a35_0x3447af(0x2c2))),telegramBotService_1=require(a35_0x3447af(0x26c)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x422820=a35_0x3447af;this['globalCheckInterval']=null,this[_0x422820(0x2cb)]=0x3c*0x3c*0x3e8,this[_0x422820(0x1ef)]=0x5,this[_0x422820(0x213)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x422820(0x20d))](),console[_0x422820(0x2af)]('🪙\x20CoinToPayStatusService\x20initialized');}[a35_0x3447af(0x24f)](_0x5a6bd5,_0x247e71){const _0x28749c=a35_0x3447af;console[_0x28749c(0x2af)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x28749c(0x2af)](_0x28749c(0x272)+_0x5a6bd5),console[_0x28749c(0x2af)](_0x28749c(0x23d)+_0x247e71),this['clearPaymentTimers'](_0x5a6bd5);const _0x457ab5=[],_0x1d3f79=new Date(),_0x328dbf=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x28749c(0x249)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x28749c(0x24d)}];console[_0x28749c(0x2af)](_0x28749c(0x22a)+_0x328dbf[_0x28749c(0x267)]+_0x28749c(0x2cc)+_0x5a6bd5);let _0x404909=0x0;_0x328dbf[_0x28749c(0x2a6)]((_0x39ff36,_0x4bf63c)=>{const _0x188c46=_0x28749c;_0x404909+=_0x39ff36[_0x188c46(0x235)];const _0x40eb17=setTimeout(async()=>{const _0x517a68=_0x188c46;console[_0x517a68(0x2af)](_0x517a68(0x287)+(_0x4bf63c+0x1)+_0x517a68(0x1f6)+_0x5a6bd5+'\x20(after\x20'+_0x39ff36[_0x517a68(0x298)]+')');try{await this['checkSinglePaymentById'](_0x5a6bd5),console[_0x517a68(0x2af)](_0x517a68(0x27e)+(_0x4bf63c+0x1)+_0x517a68(0x273)+_0x5a6bd5);}catch(_0x1c15c3){console[_0x517a68(0x253)](_0x517a68(0x245)+(_0x4bf63c+0x1)+_0x517a68(0x203)+_0x5a6bd5+':',_0x1c15c3),this[_0x517a68(0x296)](_0x5a6bd5,_0x247e71,_0x1c15c3,_0x517a68(0x214),{'checkNumber':_0x4bf63c+0x1,'scheduledAfter':_0x39ff36['description'],'isIndividualCheck':!![]});}},_0x404909);_0x457ab5[_0x188c46(0x292)](_0x40eb17),console[_0x188c46(0x2af)](_0x188c46(0x205)+(_0x4bf63c+0x1)+_0x188c46(0x203)+_0x5a6bd5+_0x188c46(0x212)+_0x404909/0x3e8+_0x188c46(0x21b)+_0x39ff36[_0x188c46(0x298)]+')');});const _0x39a53a=setInterval(async()=>{const _0x31b5b6=_0x28749c;console['log'](_0x31b5b6(0x1fa)+_0x5a6bd5);try{const _0x201890=await database_1['default'][_0x31b5b6(0x215)][_0x31b5b6(0x26e)]({'where':{'id':_0x5a6bd5},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x201890){console[_0x31b5b6(0x2af)](_0x31b5b6(0x259)+_0x5a6bd5+_0x31b5b6(0x23b)),this[_0x31b5b6(0x27a)](_0x5a6bd5);return;}console[_0x31b5b6(0x2af)]('📊\x20[HOURLY]\x20Payment\x20'+_0x5a6bd5+'\x20current\x20status:\x20'+_0x201890[_0x31b5b6(0x2c1)]);if(_0x201890[_0x31b5b6(0x2c1)]!==_0x31b5b6(0x229)){console[_0x31b5b6(0x2af)](_0x31b5b6(0x299)+_0x5a6bd5+'\x20status\x20is\x20'+_0x201890[_0x31b5b6(0x2c1)]+_0x31b5b6(0x28b)),this[_0x31b5b6(0x27a)](_0x5a6bd5);return;}const _0x2389be=Math[_0x31b5b6(0x2b2)]((Date[_0x31b5b6(0x1f4)]()-_0x201890[_0x31b5b6(0x2be)][_0x31b5b6(0x247)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x2389be>=this['EXPIRY_DAYS']){console[_0x31b5b6(0x2af)](_0x31b5b6(0x201)+_0x5a6bd5+_0x31b5b6(0x257)+this[_0x31b5b6(0x1ef)]+_0x31b5b6(0x26d)),this[_0x31b5b6(0x27a)](_0x5a6bd5);return;}await this[_0x31b5b6(0x263)](_0x5a6bd5),console[_0x31b5b6(0x2af)](_0x31b5b6(0x2c6)+_0x5a6bd5);}catch(_0x1edb29){console[_0x31b5b6(0x253)](_0x31b5b6(0x24a)+_0x5a6bd5+':',_0x1edb29),this[_0x31b5b6(0x296)](_0x5a6bd5,_0x247e71,_0x1edb29,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x457ab5[_0x28749c(0x292)](_0x39a53a),this[_0x28749c(0x213)]['set'](_0x5a6bd5,{'timers':_0x457ab5,'paymentId':_0x5a6bd5,'gatewayPaymentId':_0x247e71,'createdAt':_0x1d3f79}),console[_0x28749c(0x2af)](_0x28749c(0x297)+_0x328dbf[_0x28749c(0x267)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x5a6bd5),console[_0x28749c(0x2af)](_0x28749c(0x29f)+this[_0x28749c(0x213)]['size']),this[_0x28749c(0x1f3)](_0x5a6bd5,_0x247e71,'PENDING','PENDING',_0x28749c(0x214),{'action':_0x28749c(0x2c3),'scheduledChecks':_0x328dbf[_0x28749c(0x267)],'firstCheckIn':_0x328dbf[0x0][_0x28749c(0x235)]/0x3e8,'totalTimers':this[_0x28749c(0x213)][_0x28749c(0x221)]});}['clearPaymentTimers'](_0x688b83){const _0x151856=a35_0x3447af,_0x435e45=this[_0x151856(0x213)]['get'](_0x688b83);_0x435e45?(console['log'](_0x151856(0x295)+_0x435e45[_0x151856(0x24b)][_0x151856(0x267)]+_0x151856(0x268)+_0x688b83),_0x435e45['timers'][_0x151856(0x2a6)]((_0x44a234,_0x5e1896)=>{const _0x502bd3=_0x151856;_0x44a234&&(clearTimeout(_0x44a234),clearInterval(_0x44a234),console[_0x502bd3(0x2af)](_0x502bd3(0x26a)+(_0x5e1896+0x1)+_0x502bd3(0x203)+_0x688b83));}),this[_0x151856(0x213)][_0x151856(0x2c9)](_0x688b83),console[_0x151856(0x2af)](_0x151856(0x236)+_0x688b83+_0x151856(0x269)+this[_0x151856(0x213)][_0x151856(0x221)])):console['log'](_0x151856(0x210)+_0x688b83+_0x151856(0x23a));}async['checkSinglePaymentById'](_0x814c3e){const _0x1c276d=a35_0x3447af;console[_0x1c276d(0x2af)](_0x1c276d(0x282)+_0x814c3e);const _0x149d23=await database_1[_0x1c276d(0x20e)][_0x1c276d(0x215)][_0x1c276d(0x26e)]({'where':{'id':_0x814c3e},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x149d23){console['log'](_0x1c276d(0x2c7)+_0x814c3e+'\x20not\x20found\x20in\x20database');return;}console[_0x1c276d(0x2af)](_0x1c276d(0x2b4)+_0x814c3e+_0x1c276d(0x244)),console['log'](_0x1c276d(0x2ce)+_0x149d23[_0x1c276d(0x207)]),console[_0x1c276d(0x2af)](_0x1c276d(0x29e)+_0x149d23[_0x1c276d(0x2c1)]),console[_0x1c276d(0x2af)](_0x1c276d(0x2a0)+_0x149d23[_0x1c276d(0x2a8)]),console[_0x1c276d(0x2af)](_0x1c276d(0x271)+_0x149d23['amount']+'\x20'+_0x149d23[_0x1c276d(0x222)]),console[_0x1c276d(0x2af)](_0x1c276d(0x2b6)+_0x149d23[_0x1c276d(0x21a)]);if(_0x149d23['gateway']!==_0x1c276d(0x242)){console['log'](_0x1c276d(0x21f)+_0x814c3e+_0x1c276d(0x2ba)+_0x149d23[_0x1c276d(0x207)]+')');return;}if(_0x149d23[_0x1c276d(0x2c1)]!==_0x1c276d(0x229)){console[_0x1c276d(0x2af)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x814c3e+_0x1c276d(0x228)+_0x149d23[_0x1c276d(0x2c1)]+',\x20stopping\x20individual\x20checks'),this[_0x1c276d(0x27a)](_0x814c3e);return;}if(!_0x149d23[_0x1c276d(0x2a8)]){console[_0x1c276d(0x2af)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x814c3e+_0x1c276d(0x283));return;}console[_0x1c276d(0x2af)](_0x1c276d(0x227)+_0x814c3e+_0x1c276d(0x206)),await this['checkSinglePayment'](_0x149d23);}[a35_0x3447af(0x1f3)](_0x184c1f,_0x33b919,_0x116024,_0xc070f0,_0x2f2978,_0x110138){const _0x296f3e=a35_0x3447af,_0x105867={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x184c1f,'gatewayPaymentId':_0x33b919,'oldStatus':_0x116024,'newStatus':_0xc070f0,'source':_0x2f2978,'timestamp':new Date()[_0x296f3e(0x262)](),'details':_0x110138||{}};loggerService_1[_0x296f3e(0x288)][_0x296f3e(0x1f3)](_0x105867),console[_0x296f3e(0x2af)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x184c1f+'\x20('+_0x33b919+')'),console[_0x296f3e(0x2af)]('\x20\x20\x20📊\x20Status:\x20'+_0x116024+_0x296f3e(0x2cf)+_0xc070f0),console[_0x296f3e(0x2af)](_0x296f3e(0x2ad)+_0x2f2978),console['log'](_0x296f3e(0x261)+_0x105867[_0x296f3e(0x1fc)]),_0x110138&&console[_0x296f3e(0x2af)](_0x296f3e(0x2bf),_0x110138);}[a35_0x3447af(0x296)](_0xd11237,_0x42c6d3,_0x19b840,_0x3c4765,_0x41dbe3){const _0x370eb3=a35_0x3447af,_0x209173={'type':_0x370eb3(0x277),'paymentId':_0xd11237,'gatewayPaymentId':_0x42c6d3,'error':_0x19b840 instanceof Error?{'message':_0x19b840[_0x370eb3(0x20a)],'stack':_0x19b840[_0x370eb3(0x285)]}:_0x19b840,'source':_0x3c4765,'timestamp':new Date()[_0x370eb3(0x262)](),'context':_0x41dbe3||{}};loggerService_1[_0x370eb3(0x288)][_0x370eb3(0x296)](_0x209173),console['error'](_0x370eb3(0x2c0)+_0xd11237+'\x20('+_0x42c6d3+')'),console[_0x370eb3(0x253)](_0x370eb3(0x2ae)+(_0x19b840 instanceof Error?_0x19b840[_0x370eb3(0x20a)]:_0x19b840)),console[_0x370eb3(0x253)](_0x370eb3(0x2ad)+_0x3c4765),console[_0x370eb3(0x253)]('\x20\x20\x20📅\x20Time:\x20'+_0x209173[_0x370eb3(0x1fc)]),_0x41dbe3&&console['error'](_0x370eb3(0x284),_0x41dbe3);}[a35_0x3447af(0x26f)](){const _0x45842a=a35_0x3447af;console[_0x45842a(0x2af)](_0x45842a(0x216)),this['checkAllPendingPayments']()[_0x45842a(0x289)](_0xa772a8=>{const _0x19d629=_0x45842a;console[_0x19d629(0x253)]('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0xa772a8);}),this[_0x45842a(0x233)]=setInterval(async()=>{const _0xc60614=_0x45842a;try{console[_0xc60614(0x2af)](_0xc60614(0x2aa)),await this[_0xc60614(0x2bc)](),console[_0xc60614(0x2af)]('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x1bfe88){console[_0xc60614(0x253)]('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x1bfe88);}},this[_0x45842a(0x2cb)]),console['log'](_0x45842a(0x248));}[a35_0x3447af(0x27f)](){const _0x3a3367=a35_0x3447af;console['log'](_0x3a3367(0x209));this[_0x3a3367(0x233)]&&(clearInterval(this[_0x3a3367(0x233)]),this[_0x3a3367(0x233)]=null,console[_0x3a3367(0x2af)]('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0xc579a5=this[_0x3a3367(0x213)][_0x3a3367(0x221)];for(const [_0x3794f2]of this[_0x3a3367(0x213)]){this[_0x3a3367(0x27a)](_0x3794f2);}console[_0x3a3367(0x2af)](_0x3a3367(0x254)+_0xc579a5+'\x20individual\x20payment\x20timers');}async['checkAllPendingPayments'](){const _0x5189ea=a35_0x3447af;try{console[_0x5189ea(0x2af)](_0x5189ea(0x2a7));const _0x10e08a=await database_1[_0x5189ea(0x20e)][_0x5189ea(0x215)][_0x5189ea(0x1f2)]({'where':{'gateway':_0x5189ea(0x242),'status':_0x5189ea(0x229),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x5189ea(0x2af)](_0x5189ea(0x219)+_0x10e08a['length']+_0x5189ea(0x238));if(_0x10e08a[_0x5189ea(0x267)]===0x0){console[_0x5189ea(0x2af)](_0x5189ea(0x25c));return;}const _0xcf62b4=await this[_0x5189ea(0x2b3)](_0x10e08a);console['log'](_0x5189ea(0x280)+_0xcf62b4[_0x5189ea(0x267)]+_0x5189ea(0x21d));let _0x397f8d=0x0,_0x4803f5=0x0;for(const _0x11ea7e of _0x10e08a){try{if(_0xcf62b4['includes'](_0x11ea7e['id'])){console[_0x5189ea(0x2af)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x11ea7e['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x4803f5++;continue;}if(this[_0x5189ea(0x213)]['has'](_0x11ea7e['id'])){console[_0x5189ea(0x2af)](_0x5189ea(0x22e)+_0x11ea7e['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x4803f5++;continue;}const _0x408e3c=(Date[_0x5189ea(0x1f4)]()-_0x11ea7e[_0x5189ea(0x2be)][_0x5189ea(0x247)]())/(0x3e8*0x3c*0x3c);if(_0x408e3c<0x1){console[_0x5189ea(0x2af)](_0x5189ea(0x22e)+_0x11ea7e['id']+'\x20is\x20too\x20new\x20('+_0x408e3c['toFixed'](0x1)+_0x5189ea(0x25a)),_0x4803f5++;continue;}console[_0x5189ea(0x2af)](_0x5189ea(0x1fb)+_0x11ea7e['id']+_0x5189ea(0x237)+_0x408e3c['toFixed'](0x1)+'h)'),await this[_0x5189ea(0x260)](_0x11ea7e),_0x397f8d++,await new Promise(_0x416f99=>setTimeout(_0x416f99,0x7d0));}catch(_0x5f48ff){console['error']('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x11ea7e['id']+':',_0x5f48ff),this[_0x5189ea(0x296)](_0x11ea7e['id'],_0x11ea7e[_0x5189ea(0x2a8)]||_0x5189ea(0x1f1),_0x5f48ff,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x11ea7e[_0x5189ea(0x25e)],'paymentCurrency':_0x11ea7e[_0x5189ea(0x222)],'shopId':_0x11ea7e[_0x5189ea(0x21a)],'createdAt':_0x11ea7e[_0x5189ea(0x2be)]}),loggerService_1[_0x5189ea(0x288)]['logWhiteDomainError'](_0x5189ea(0x242),_0x5189ea(0x266)+_0x11ea7e['gatewayPaymentId'],_0x5f48ff);}}console[_0x5189ea(0x2af)](_0x5189ea(0x232)+_0x397f8d+'\x20checked,\x20'+_0x4803f5+'\x20skipped,\x20'+_0xcf62b4[_0x5189ea(0x267)]+'\x20expired');}catch(_0x3aa9d7){console[_0x5189ea(0x253)]('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x3aa9d7);}}async[a35_0x3447af(0x2b3)](_0x1de944){const _0x7b5e8b=a35_0x3447af,_0x346629=[],_0x41b47=new Date();_0x41b47[_0x7b5e8b(0x231)](_0x41b47[_0x7b5e8b(0x208)]()-this[_0x7b5e8b(0x1ef)]),console['log'](_0x7b5e8b(0x2a3)+this['EXPIRY_DAYS']+'\x20days\x20(created\x20before\x20'+_0x41b47[_0x7b5e8b(0x262)]()+')');for(const _0x59b665 of _0x1de944){if(_0x59b665[_0x7b5e8b(0x2be)]<_0x41b47){console['log'](_0x7b5e8b(0x291)+_0x59b665['id']+_0x7b5e8b(0x257)+this['EXPIRY_DAYS']+_0x7b5e8b(0x2a5));try{this[_0x7b5e8b(0x1f3)](_0x59b665['id'],_0x59b665[_0x7b5e8b(0x2a8)]||_0x7b5e8b(0x1f1),_0x7b5e8b(0x229),_0x7b5e8b(0x28d),_0x7b5e8b(0x28f),{'reason':_0x7b5e8b(0x1ff)+this[_0x7b5e8b(0x1ef)]+_0x7b5e8b(0x2b7),'createdAt':_0x59b665[_0x7b5e8b(0x2be)],'daysSinceCreation':Math[_0x7b5e8b(0x2b2)]((Date[_0x7b5e8b(0x1f4)]()-_0x59b665['createdAt'][_0x7b5e8b(0x247)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x59b665['amount'],'paymentCurrency':_0x59b665[_0x7b5e8b(0x222)],'shopId':_0x59b665[_0x7b5e8b(0x21a)]}),await database_1[_0x7b5e8b(0x20e)][_0x7b5e8b(0x215)][_0x7b5e8b(0x20b)]({'where':{'id':_0x59b665['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x7b5e8b(0x1ef)]+_0x7b5e8b(0x2ac)}}),await database_1[_0x7b5e8b(0x20e)][_0x7b5e8b(0x1f8)][_0x7b5e8b(0x220)]({'data':{'paymentId':_0x59b665['id'],'shopId':_0x59b665[_0x7b5e8b(0x21a)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x7b5e8b(0x2b0)]({'reason':'Payment\x20older\x20than\x20'+this[_0x7b5e8b(0x1ef)]+_0x7b5e8b(0x2b7),'createdAt':_0x59b665['createdAt'],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x7b5e8b(0x2b2)]((Date[_0x7b5e8b(0x1f4)]()-_0x59b665['createdAt'][_0x7b5e8b(0x247)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x7b5e8b(0x251)](_0x59b665,'EXPIRED'),await this[_0x7b5e8b(0x2c4)](_0x59b665,_0x7b5e8b(0x28d)),this['clearPaymentTimers'](_0x59b665['id']),_0x346629[_0x7b5e8b(0x292)](_0x59b665['id']),console[_0x7b5e8b(0x2af)](_0x7b5e8b(0x28a)+_0x59b665['id']+_0x7b5e8b(0x256)+this['EXPIRY_DAYS']+'-day\x20timeout');}catch(_0x56a28f){console[_0x7b5e8b(0x253)]('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x59b665['id']+':',_0x56a28f),this[_0x7b5e8b(0x296)](_0x59b665['id'],_0x59b665['gatewayPaymentId']||_0x7b5e8b(0x1f1),_0x56a28f,_0x7b5e8b(0x28f),{'reason':_0x7b5e8b(0x218),'createdAt':_0x59b665[_0x7b5e8b(0x2be)],'daysSinceCreation':Math[_0x7b5e8b(0x2b2)]((Date[_0x7b5e8b(0x1f4)]()-_0x59b665['createdAt'][_0x7b5e8b(0x247)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x346629;}async['checkSinglePayment'](_0x1f2c41){const _0x1ecbba=a35_0x3447af;if(!_0x1f2c41[_0x1ecbba(0x2a8)]){console['log'](_0x1ecbba(0x21f)+_0x1f2c41['id']+_0x1ecbba(0x240));return;}console[_0x1ecbba(0x2af)]('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x1f2c41['id']+'\x20('+_0x1f2c41[_0x1ecbba(0x2a8)]+')');try{const _0xcc8d11=await this[_0x1ecbba(0x204)][_0x1ecbba(0x255)](_0x1f2c41[_0x1ecbba(0x2a8)]);console[_0x1ecbba(0x2af)](_0x1ecbba(0x2b4)+_0x1f2c41['id']+_0x1ecbba(0x2a1)+_0xcc8d11[_0x1ecbba(0x2c1)]);_0xcc8d11[_0x1ecbba(0x2c5)]&&console[_0x1ecbba(0x2af)](_0x1ecbba(0x2b4)+_0x1f2c41['id']+'\x20details:',{'iban':_0xcc8d11[_0x1ecbba(0x2c5)]['iban']||_0x1ecbba(0x22b),'transactionId':_0xcc8d11[_0x1ecbba(0x2c5)][_0x1ecbba(0x2d2)],'createdOn':_0xcc8d11[_0x1ecbba(0x2c5)][_0x1ecbba(0x1f7)],'confirmedOn':_0xcc8d11[_0x1ecbba(0x2c5)][_0x1ecbba(0x286)]||_0x1ecbba(0x23f)});if(_0xcc8d11['status']!==_0x1f2c41[_0x1ecbba(0x2c1)]){console[_0x1ecbba(0x2af)](_0x1ecbba(0x1fe)+_0x1f2c41['id']+'\x20status\x20from\x20'+_0x1f2c41['status']+_0x1ecbba(0x290)+_0xcc8d11[_0x1ecbba(0x2c1)]),this[_0x1ecbba(0x1f3)](_0x1f2c41['id'],_0x1f2c41['gatewayPaymentId'],_0x1f2c41[_0x1ecbba(0x2c1)],_0xcc8d11[_0x1ecbba(0x2c1)],_0x1ecbba(0x214),{'paymentDetails':_0xcc8d11['paymentDetails'],'amount':_0xcc8d11[_0x1ecbba(0x25e)],'currency':_0xcc8d11[_0x1ecbba(0x222)],'shopId':_0x1f2c41[_0x1ecbba(0x21a)],'checkTimestamp':new Date()[_0x1ecbba(0x262)]()});const _0x33476c={'status':_0xcc8d11[_0x1ecbba(0x2c1)],'updatedAt':new Date()};_0xcc8d11[_0x1ecbba(0x2c1)]===_0x1ecbba(0x2b5)&&_0x1f2c41[_0x1ecbba(0x2c1)]!==_0x1ecbba(0x2b5)&&(_0x33476c['paidAt']=new Date(),console[_0x1ecbba(0x2af)](_0x1ecbba(0x226)+_0x1f2c41['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x33476c[_0x1ecbba(0x276)][_0x1ecbba(0x262)]()));if(_0xcc8d11[_0x1ecbba(0x2c5)]){const _0x23d0f9=_0xcc8d11[_0x1ecbba(0x2c5)];_0x23d0f9['iban']&&(_0x33476c[_0x1ecbba(0x1f9)]=_0x23d0f9[_0x1ecbba(0x27d)],console['log']('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x23d0f9['iban']));if(_0x23d0f9[_0x1ecbba(0x29a)]){const _0x7ab306=_0x1f2c41['adminNotes']||'',_0x57e0c3=_0x1ecbba(0x2d0)+_0x23d0f9[_0x1ecbba(0x29a)];_0x33476c['adminNotes']=_0x7ab306?_0x7ab306+'\x0a\x0a'+_0x57e0c3:_0x57e0c3,console[_0x1ecbba(0x2af)](_0x1ecbba(0x200));}_0x23d0f9[_0x1ecbba(0x2d2)]&&console['log']('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x23d0f9[_0x1ecbba(0x2d2)]),_0x23d0f9[_0x1ecbba(0x286)]&&console[_0x1ecbba(0x2af)](_0x1ecbba(0x23e)+_0x23d0f9[_0x1ecbba(0x286)]);}await database_1[_0x1ecbba(0x20e)]['payment'][_0x1ecbba(0x20b)]({'where':{'id':_0x1f2c41['id']},'data':_0x33476c}),await database_1['default'][_0x1ecbba(0x1f8)]['create']({'data':{'paymentId':_0x1f2c41['id'],'shopId':_0x1f2c41['shopId'],'event':_0x1ecbba(0x2a4)+_0xcc8d11[_0x1ecbba(0x2c1)][_0x1ecbba(0x2bd)](),'statusCode':0xc8,'responseBody':JSON[_0x1ecbba(0x2b0)]({'oldStatus':_0x1f2c41[_0x1ecbba(0x2c1)],'newStatus':_0xcc8d11[_0x1ecbba(0x2c1)],'paymentDetails':_0xcc8d11[_0x1ecbba(0x2c5)],'checkedAt':new Date()[_0x1ecbba(0x262)]()})}}),await this[_0x1ecbba(0x251)](_0x1f2c41,_0xcc8d11[_0x1ecbba(0x2c1)]),await this[_0x1ecbba(0x2c4)](_0x1f2c41,_0xcc8d11[_0x1ecbba(0x2c1)]),_0xcc8d11[_0x1ecbba(0x2c1)]!==_0x1ecbba(0x229)&&(console[_0x1ecbba(0x2af)](_0x1ecbba(0x25b)+_0x1f2c41['id']+_0x1ecbba(0x29c)+_0xcc8d11[_0x1ecbba(0x2c1)]+_0x1ecbba(0x1f0)),this['clearPaymentTimers'](_0x1f2c41['id'])),console['log'](_0x1ecbba(0x227)+_0x1f2c41['id']+'\x20updated\x20successfully');}else console['log'](_0x1ecbba(0x2b4)+_0x1f2c41['id']+_0x1ecbba(0x2ab)+_0xcc8d11[_0x1ecbba(0x2c1)]+')'),this[_0x1ecbba(0x1f3)](_0x1f2c41['id'],_0x1f2c41[_0x1ecbba(0x2a8)],_0x1f2c41[_0x1ecbba(0x2c1)],_0xcc8d11[_0x1ecbba(0x2c1)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0xcc8d11[_0x1ecbba(0x2c5)],'amount':_0xcc8d11['amount'],'currency':_0xcc8d11['currency'],'shopId':_0x1f2c41['shopId'],'checkTimestamp':new Date()[_0x1ecbba(0x262)]()});}catch(_0x72f10){console['error']('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x1f2c41['id']+':',_0x72f10),this[_0x1ecbba(0x296)](_0x1f2c41['id'],_0x1f2c41['gatewayPaymentId'],_0x72f10,_0x1ecbba(0x214),{'paymentAmount':_0x1f2c41[_0x1ecbba(0x25e)],'paymentCurrency':_0x1f2c41[_0x1ecbba(0x222)],'shopId':_0x1f2c41[_0x1ecbba(0x21a)],'createdAt':_0x1f2c41[_0x1ecbba(0x2be)]}),await database_1[_0x1ecbba(0x20e)][_0x1ecbba(0x1f8)]['create']({'data':{'paymentId':_0x1f2c41['id'],'shopId':_0x1f2c41[_0x1ecbba(0x21a)],'event':_0x1ecbba(0x24c),'statusCode':0x1f4,'responseBody':JSON[_0x1ecbba(0x2b0)]({'error':_0x72f10 instanceof Error?_0x72f10[_0x1ecbba(0x20a)]:'Unknown\x20error','gatewayPaymentId':_0x1f2c41['gatewayPaymentId'],'checkedAt':new Date()[_0x1ecbba(0x262)]()})}});}}async[a35_0x3447af(0x251)](_0x520124,_0x4d46ac){const _0x414ba1=a35_0x3447af,_0x3be143=Date[_0x414ba1(0x1f4)]();try{const _0x297a4c=_0x520124[_0x414ba1(0x2d1)],_0x4c85bd=_0x297a4c[_0x414ba1(0x294)];if(!_0x4c85bd?.[_0x414ba1(0x1f5)]){console[_0x414ba1(0x2af)](_0x414ba1(0x2a2)+_0x297a4c['id']);return;}const _0x3327c1=_0x4d46ac===_0x414ba1(0x2b5)?_0x414ba1(0x22d):_0x4d46ac===_0x414ba1(0x1fd)?_0x414ba1(0x20c):_0x4d46ac===_0x414ba1(0x28d)?'payment.failed':_0x414ba1(0x279);if(!_0x4c85bd[_0x414ba1(0x2cd)]?.[_0x414ba1(0x25f)](_0x3327c1)){console[_0x414ba1(0x2af)](_0x414ba1(0x2b9)+_0x3327c1+_0x414ba1(0x225)+_0x297a4c['id']);return;}const _0x22e981={'event':_0x3327c1,'payment':{'id':_0x520124['id'],'order_id':_0x520124['orderId'],'gateway_order_id':_0x520124['gatewayOrderId'],'gateway':_0x414ba1(0x29d),'amount':_0x520124[_0x414ba1(0x25e)],'currency':_0x520124[_0x414ba1(0x222)],'status':_0x4d46ac[_0x414ba1(0x2bd)](),'customer_email':_0x520124[_0x414ba1(0x25d)],'customer_name':_0x520124[_0x414ba1(0x2b1)],'created_at':_0x520124[_0x414ba1(0x2be)],'updated_at':new Date()}},_0x2f96bb=await fetch(_0x4c85bd[_0x414ba1(0x1f5)],{'method':_0x414ba1(0x234),'headers':{'Content-Type':_0x414ba1(0x224),'User-Agent':_0x414ba1(0x258)},'body':JSON[_0x414ba1(0x2b0)](_0x22e981)}),_0x189811=Date[_0x414ba1(0x1f4)]()-_0x3be143,_0x593f0a=_0x2f96bb['ok']?'Success':await _0x2f96bb[_0x414ba1(0x274)]();loggerService_1[_0x414ba1(0x288)][_0x414ba1(0x29b)](_0x520124[_0x414ba1(0x21a)],_0x4c85bd[_0x414ba1(0x1f5)],_0x3327c1,_0x2f96bb[_0x414ba1(0x2c1)],_0x189811,_0x22e981),console['log']('Shop\x20webhook\x20sent\x20to\x20'+_0x4c85bd[_0x414ba1(0x1f5)]+'\x20with\x20status\x20'+_0x2f96bb[_0x414ba1(0x2c1)]+'\x20('+_0x189811+_0x414ba1(0x281));}catch(_0x14dd19){console[_0x414ba1(0x253)](_0x414ba1(0x202),_0x14dd19),loggerService_1['loggerService'][_0x414ba1(0x241)](_0x520124[_0x414ba1(0x21a)],_0x520124[_0x414ba1(0x2d1)]?.[_0x414ba1(0x294)]?.[_0x414ba1(0x1f5)]||_0x414ba1(0x1f1),_0x414ba1(0x28c),_0x14dd19,{});}}async['sendPaymentStatusNotification'](_0x5ab1a0,_0x3b7289){const _0x29ff63=a35_0x3447af;try{const _0x5433f3={'PENDING':'created','PAID':_0x29ff63(0x265),'FAILED':_0x29ff63(0x264),'EXPIRED':_0x29ff63(0x20f)},_0x1f5137=_0x5433f3[_0x3b7289];if(!_0x1f5137||_0x1f5137===_0x29ff63(0x22f))return;await telegramBotService_1[_0x29ff63(0x275)]['sendPaymentNotification'](_0x5ab1a0['shopId'],_0x5ab1a0,_0x1f5137);}catch(_0x17a3d8){console[_0x29ff63(0x253)](_0x29ff63(0x2c8),_0x17a3d8);}}async[a35_0x3447af(0x217)](_0x1a3a9e){const _0x196326=a35_0x3447af;console[_0x196326(0x2af)]('🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20'+_0x1a3a9e);const _0x2c84b7=await database_1[_0x196326(0x20e)][_0x196326(0x215)]['findUnique']({'where':{'id':_0x1a3a9e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2c84b7)throw new Error(_0x196326(0x246));if(_0x2c84b7[_0x196326(0x207)]!=='cointopay')throw new Error(_0x196326(0x252));console[_0x196326(0x2af)](_0x196326(0x27b)+_0x1a3a9e),await this[_0x196326(0x260)](_0x2c84b7),console[_0x196326(0x2af)](_0x196326(0x28e)+_0x1a3a9e);}[a35_0x3447af(0x26b)](){const _0x388082=a35_0x3447af,_0x469c60=this[_0x388082(0x233)]?this[_0x388082(0x2cb)]:undefined,_0x534517=Array['from'](this[_0x388082(0x213)][_0x388082(0x22c)]())[_0x388082(0x27c)](_0x563243=>({'paymentId':_0x563243[_0x388082(0x278)],'gatewayPaymentId':_0x563243[_0x388082(0x2a8)],'createdAt':_0x563243[_0x388082(0x2be)],'timersCount':_0x563243[_0x388082(0x24b)]['length']}));return{'isActive':!!this[_0x388082(0x233)],'globalCheckIntervalMinutes':this[_0x388082(0x2cb)]/(0x3e8*0x3c),'expiryDays':this[_0x388082(0x1ef)],'activeIndividualTimers':this[_0x388082(0x213)]['size'],'nextGlobalCheckIn':_0x469c60,'paymentTimersDetails':_0x534517};}[a35_0x3447af(0x270)](_0x18e43c){const _0x4ef591=a35_0x3447af,_0x36075c=this['paymentTimers']['get'](_0x18e43c);if(_0x36075c)return{'hasTimers':!![],'timersCount':_0x36075c[_0x4ef591(0x24b)][_0x4ef591(0x267)],'createdAt':_0x36075c['createdAt'],'gatewayPaymentId':_0x36075c[_0x4ef591(0x2a8)]};return{'hasTimers':![]};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();